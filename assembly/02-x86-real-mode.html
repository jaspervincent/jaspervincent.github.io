<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Assembly: x86实模式</title>
<meta name="description" content="Assembly: x86实模式" />
<meta name="keywords" content="虚拟机,汇编语言,8086,条件转移" />
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Assembly: x86实模式</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:cde66aa6-eb40-4c71-9b1a-bacf24931b73">虚拟机的安装和使用</a>
<ul>
<li><a href="#h:7acd745c-9a41-4499-adae-1e49b683e65b">安装VirtualBox虚拟机管理器</a></li>
<li><a href="#h:d1ef1291-fb38-4800-a948-2885ae0573cb">创建VirtualBox虚拟机</a></li>
<li><a href="#h:a801a3f1-634f-4e58-a6f9-fd5be3d519c5">虚拟硬盘简介</a></li>
<li><a href="#h:6941fd69-bc2b-4d40-8a97-6d66e8c75371">在Windows下创建虚拟硬盘并安装操作系统</a></li>
<li><a href="#h:575d6206-5c9e-4f95-a55e-6c499f4139b3">在Linux下创建虚拟硬盘并安装操作系统</a></li>
</ul>
</li>
<li><a href="#h:66b72697-8b0f-4624-9979-0dc76771c967">汇编语言程序的调试</a>
<ul>
<li><a href="#h:ec6cbc7a-cf8c-42fd-9d7d-c8676930d263">带调试功能的虚拟机</a></li>
<li><a href="#h:56e2e5e3-c5b0-4b6d-8783-7abd223ba666">安装Bochs虚拟机</a></li>
<li><a href="#h:2a1d281b-bc23-47a9-a0d3-49fb7174b704">为Bochs虚拟机安装虚拟硬盘</a></li>
<li><a href="#h:bce7c485-20cc-4010-bc8c-3c669afd8c2e">创建主引导扇区程序</a></li>
<li><a href="#h:c2578057-deb7-40f0-bd86-b53044fdf1a4">将程序写入硬盘主引导扇区</a>
<ul>
<li><a href="#h:9d28ad31-4f92-46f8-a562-cc40cfba58ae">LBA</a></li>
</ul>
</li>
<li><a href="#h:0ddf27df-95a6-4216-a291-94e5fe54b30d">用调试器观察程序的执行</a>
<ul>
<li><a href="#h:8e5a73d8-6101-43c1-99b3-447c8f3edd5b">8086处理器之后的32位64位寄存器</a></li>
<li><a href="#h:bdcb3401-d356-4c29-b19b-a1cf2f4a55d2">boch开机</a></li>
<li><a href="#h:4be4e56f-addd-4a3e-bce7-761c9b2f95ac">bochs调试命令</a></li>
<li><a href="#h:f5092b99-3173-4142-9c11-198be60315e0">bochs开始调试</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:d22d6388-723c-4c18-8e85-394adf30318b">在屏幕上显示文本</a>
<ul>
<li><a href="#h:a12f57da-ad94-4128-bee0-cfd8a82e9d65">显卡和显存</a></li>
<li><a href="#h:c44f1803-2b5b-451c-b92a-4dfdb79a383e">准备访问文本模式下的显存</a></li>
<li><a href="#h:4e39ca44-3162-4848-961e-f8f93bf9d786">字符的编码和显示属性</a></li>
<li><a href="#h:d5b4358c-4e53-448f-b135-cd972320249e">文本模式下的显存操作</a></li>
<li><a href="#h:932777fe-62ef-4e0a-bcba-47b96ad548df">MOV指令的形式和机器码</a></li>
<li><a href="#h:0be557ee-4917-40c1-b34b-870ca94f3bec">列表文件的创建和使用</a></li>
<li><a href="#h:7606f861-8e27-42cc-840c-c81d55aaeaf0">在汇编程序中使用标号</a></li>
<li><a href="#h:d61b96ea-efc8-4120-98d5-d5634d9e6009">段间直接绝对跳转指令</a></li>
<li><a href="#h:ff05f145-2e38-4610-9f96-c56bd06f60cc">在Bochs中运行和调试写屏程序</a>
<ul>
<li><a href="#h:a056d66e-cb9c-4eeb-94af-b27be576da42">bochs调试命令</a></li>
<li><a href="#h:2baf1d59-b2a8-4828-b70f-7594e0adf1c6">bochs开机后调试界面</a></li>
<li><a href="#h:581f9d62-4d4a-4be0-b7e8-877b6a9c1508">bochs开始调试</a></li>
</ul>
</li>
<li><a href="#h:2a1d1f65-ba56-4092-8994-c087a6e6db55">在VirtualBox中运行写屏程序</a></li>
<li><a href="#h:79ceb719-b984-4e5d-81cc-a27ca3bd7a3a">主引导扇区执行时的内存布局</a></li>
<li><a href="#h:c561f1fa-1bf5-4539-ae05-52f26c2705d6">使用标号计算跳转的偏移地址</a></li>
<li><a href="#h:a4ad32df-1fd8-4b9d-baa6-84d0c744bf32">使用寄存器的绝对间接近跳转</a></li>
<li><a href="#h:8304cbb7-a767-454d-96cf-039cdaf81a98">使用相对偏移量的短跳转和近跳转</a></li>
</ul>
</li>
<li><a href="#h:aeb115e5-ec9a-4e6c-88f8-eb78f8eefbef">在屏幕上显示数字</a>
<ul>
<li><a href="#h:3396ce4c-6df8-410c-97ff-1e50a6c4f2f4">显示数字的基本原理</a></li>
<li><a href="#h:37295f74-5e34-49c0-97b4-543e513ac652">无符号数除法指令div</a></li>
<li><a href="#h:0c97f6c7-9d7e-4d7f-b075-b5c1cf4e2fb9">在调试器里验证除法操作</a></li>
<li><a href="#h:16c01e5a-1d0a-4191-a4dc-d30f29a722e6">异或指令xor的用法</a></li>
<li><a href="#h:a53dc47a-369d-404f-8b54-30d67ec4336b">加法指令add的用法</a></li>
<li><a href="#h:3b16cade-909a-4ee5-af60-ba24f422a27f">使用标号访问内存数据</a></li>
<li><a href="#h:adb941c1-9a70-4979-85ee-6760793cd4ff">段超越前缀的使用</a></li>
<li><a href="#h:3cc6d271-9b4f-423d-b1ea-ddcf866bef26">显示标号的汇编地址</a></li>
</ul>
</li>
<li><a href="#h:23336122-a35c-4396-a634-00fff782a953">阶段性重点内容总结</a></li>
<li><a href="#h:544cb817-8d52-4ba4-a57a-ff5d08aeb209">循环批量传送和条件转移</a>
<ul>
<li><a href="#h:afd95d3f-62c2-4627-8fce-413d430ab250">跳过非指令的数据区</a></li>
<li><a href="#h:9ac8bf23-a407-43f2-b5ed-6af20a66a137">逻辑段地址的重新设定</a></li>
<li><a href="#h:e1bb56ce-2467-40c4-87c8-f709e9627a04">串传送指令和标志寄存器</a></li>
<li><a href="#h:97e3f0da-a361-415c-b243-70cbbe9a2340">NASM的$和$$记号</a></li>
<li><a href="#h:382a2dfb-e4b0-45c7-877e-9f02e500aada">使用循环指令LOOP分解数位</a></li>
<li><a href="#h:0087a7ff-6c1c-480b-87cc-31cc04ca23bf">基址寻址和INC指令</a></li>
<li><a href="#h:baf3910a-b9de-4216-ad91-4ef8bd23adb7">数字的显示和DEC指令</a></li>
<li><a href="#h:0b420685-78a9-4f3f-9616-579113057024">基址变址寻址和条件转移指令</a></li>
</ul>
</li>
<li><a href="#h:bd1e9480-f923-4c72-803c-70c48cfc735a">计算机中的负数</a>
<ul>
<li><a href="#h:7ca783da-c1f2-4a69-bbb1-fd779bb50eca">无符号数和有符号数</a></li>
<li><a href="#h:2a63843f-933c-46b2-a5b7-346f1cec15d2">减法指令SUB和求补指令NEG</a></li>
<li><a href="#h:f3ffb306-781a-4a94-8aa6-96823fde2f04">计算机如何区分对待无符号数和有符号数</a></li>
<li><a href="#h:2c5737b7-9880-4a07-898f-d59b5a56c166">有符号数除法指令IDIV</a></li>
<li><a href="#h:6bd9f6fe-343d-4465-b864-58b6abf7e94a">有符号数的符号扩展指令</a></li>
</ul>
</li>
<li><a href="#h:6ba8fc17-c77a-4a5f-a508-264c6056fa84">阶段性知识总结和拓展</a>
<ul>
<li><a href="#h:c30f1b6d-c7c8-46f1-8318-d71958783e9d">8086的标志寄存器</a></li>
<li><a href="#h:98dfc75f-3d42-4982-80de-e3eabfd09a80">条件转移指令和CMP指令</a></li>
</ul>
</li>
<li><a href="#h:3487204d-7ca4-40ec-995d-9fa54f50d211">从 1 加到 100 并显示结果</a>
<ul>
<li><a href="#h:291ca33b-14b1-4e2f-b991-bc842615b19a">字符串的定义和累加过程</a></li>
<li><a href="#h:a5ca4c58-3a27-4e87-b85b-19863ee3ffb8">栈的原理和使用</a></li>
<li><a href="#h:a181afc9-0c9d-4144-a338-3206cc427d9b">栈在数位分解和显示中的应用</a></li>
<li><a href="#h:437b6690-50b5-4a73-a870-d3d986264c61">在调试器里观察栈操作的状态</a></li>
<li><a href="#h:79116b03-71e9-4dc8-835e-b9e590393d40">进一步认识栈和栈操作的特点</a></li>
<li><a href="#h:736a5550-ab34-4a30-9d7f-d5929af11042">逻辑或指令OR和逻辑与指令AND</a></li>
</ul>
</li>
<li><a href="#h:c1771758-bb4c-42cb-8879-e974198a66a9">INTEL 8086 处理器的寻址方式</a>
<ul>
<li><a href="#h:e1c6329c-256a-4bbb-855b-b15839dfe9c3">寄存器、立即数和直接寻址</a></li>
<li><a href="#h:d282dfb3-6ec4-4a80-b7c1-4db4a8d0b792">基址寻址</a></li>
<li><a href="#h:d671e6ef-11e7-4ca0-a550-768bc01b3728">变址寻址</a></li>
<li><a href="#h:86898f73-79ec-4bc9-86f2-879c0d7cf3a7">基址变址寻址</a></li>
</ul>
</li>
<li><a href="#h:1e600d07-cfd8-4e68-b3e5-8819cbfbb58e">硬盘和显卡的访问与控制</a>
<ul>
<li><a href="#h:c9b3893c-4382-4669-a773-1aa2c0721470">离开主引导扇区</a></li>
<li><a href="#h:a0f70f9a-8108-45bf-af73-0080367a0c18">给汇编语言程序分段</a></li>
<li><a href="#h:7b05f349-7e71-48c8-91d8-7c67f2e2fcfc">控制段内元素的汇编地址</a></li>
<li><a href="#h:929f4bba-4a3c-4bf2-8312-77a92a6be4ad">加载器和用户程序头部段</a></li>
<li><a href="#h:75324a06-3d93-47ee-9dbf-52326f7343f6">加载器的工作流程和常数声明</a></li>
<li><a href="#h:9c3ceb94-911b-4fac-94f4-8ad8046f88bd">确定用户程序的加载位置</a></li>
<li><a href="#h:66a5bcd3-6572-43af-a604-b5e14d27b9a1">外围设备及其接口</a></li>
<li><a href="#h:f8ae1ef2-da33-4d96-b5e9-e16aefcfb2b6">输入输出端口的访问</a></li>
<li><a href="#h:e61d214f-77e1-44fb-af82-ab6cc8a04af9">通过硬盘控制器端口读扇区数据</a></li>
<li><a href="#h:50f5914f-4868-4d61-a8d8-beeb3a524d90">过程和过程调用</a></li>
<li><a href="#h:ce02b790-72dd-45df-a7f0-2619dcbcc6a1">过程调用和返回的原理</a></li>
<li><a href="#h:714820dc-6be3-417c-ab89-c1dbde87bc51">加载整个用户程序</a></li>
<li><a href="#h:e1356242-ba85-4965-b1d5-0e49a3f47b53">用户程序的重定位</a></li>
<li><a href="#h:6fc2b5d4-897f-495c-94fe-17e54d85540d">比特位的移动指令</a></li>
<li><a href="#h:62293c16-73e0-476f-82e4-5e6723e7a3f8">转到用户程序内部执行</a></li>
<li><a href="#h:41d98d2a-64f6-46f6-ad57-76836c8c59e3">8086的无条件转移指令</a></li>
<li><a href="#h:03e1f608-483d-496e-917f-a7585a35420d">用户程序的执行过程</a></li>
<li><a href="#h:0873922b-9fd8-4912-b42b-12a680690e87">验证加载器加载和执行用户程序的过程</a></li>
<li><a href="#h:ea04a109-689d-4623-9183-1ef95bf38e6b">用户程序概述</a></li>
<li><a href="#h:f62a918b-e85c-4910-af53-e0e78bb2163b">与文本显示有关的回车、换行与光标控制</a></li>
<li><a href="#h:ed51def0-6807-4895-ab28-59389494d0b2">回车的光标处理和乘法指令MUL</a></li>
<li><a href="#h:4aabfb57-04c0-4c92-9bd9-db375741993d">换行和普通字符的处理过程与滚屏操作</a></li>
<li><a href="#h:e2e635de-45d6-4bf8-9426-0c6aa226b7fc">8086的过程调用方式</a></li>
<li><a href="#h:39a84fa8-2332-4c95-83d2-ecbf3d087aff">通过RETF指令转到另一个代码段内执行</a></li>
<li><a href="#h:22670a8c-a1f2-4761-9509-e36a83575205">在程序中访问不同的数据段</a></li>
<li><a href="#h:602a147f-eccb-4971-82da-bd5d9520eab8">使用新版FixVhdWr写虚拟硬盘并运行程序</a></li>
<li><a href="#h:6fb5c9db-dbd5-46ca-a829-f11b5acece6f">练习</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="./index.html">Assembly</a></li>
</ul>


<p>
实模式
</p>

<p>
主要内容
</p>

<ul class="org-ul">
<li>虚拟机的安装和使用</li>
<li>汇编语言程序的调试</li>
<li>在屏幕上显示文本</li>
<li>在屏幕上显示数字</li>
<li>循环批量传送和条件转移</li>
<li>计算机中的负数</li>
<li>从 1 加到 100 并显示结果</li>
<li>INTEL 8086 处理器的寻址方式</li>
<li>硬盘和显卡的访问与控制</li>
</ul>
<section id="outline-container-h:cde66aa6-eb40-4c71-9b1a-bacf24931b73" class="outline-2">
<h2 id="h:cde66aa6-eb40-4c71-9b1a-bacf24931b73">虚拟机的安装和使用</h2>
<div class="outline-text-2" id="text-h:cde66aa6-eb40-4c71-9b1a-bacf24931b73">
<p>
主要内容
</p>

<ul class="org-ul">
<li>安装VirtualBox虚拟机管理器</li>
<li>创建VirtualBox虚拟机</li>
<li>虚拟硬盘简介</li>
<li>在Windows下创建虚拟硬盘并安装操作系统</li>
<li>在Linux下创建虚拟硬盘并安装操作系统</li>
</ul>
</div>
<div id="outline-container-h:7acd745c-9a41-4499-adae-1e49b683e65b" class="outline-3">
<h3 id="h:7acd745c-9a41-4499-adae-1e49b683e65b">安装VirtualBox虚拟机管理器</h3>
<div class="outline-text-3" id="text-h:7acd745c-9a41-4499-adae-1e49b683e65b">
<p>
虚拟机软件：
</p>
<ul class="org-ul">
<li>VMWare</li>
<li>Windows Virtual PC</li>
<li>VirtuaBox</li>
<li>Bochs</li>
<li>&#x2026; &#x2026;</li>
</ul>

<p>
官网：<a href="https://www.virtualbox.org/">https://www.virtualbox.org/</a>
</p>

<p>
windows安装virtualbox，可自定义安装目录，其他默认。
</p>

<p>
Ubuntu安装virtuabox，系统界面找到Ubuntu软件搜索virtuabox并安装
</p>
</div>
</div>
<div id="outline-container-h:d1ef1291-fb38-4800-a948-2885ae0573cb" class="outline-3">
<h3 id="h:d1ef1291-fb38-4800-a948-2885ae0573cb">创建VirtualBox虚拟机</h3>
<div class="outline-text-3" id="text-h:d1ef1291-fb38-4800-a948-2885ae0573cb">
<p>
打开VirtuaBox，点击新建
</p>

<p>
<b>新建一台没有虚拟硬盘的虚拟机</b>
</p>
<ul class="org-ul">
<li>虚拟电脑名称和系统类型
<ul class="org-ul">
<li>名称：任意，learn</li>
<li>文件夹：默认或自定义，如D:\VirtuaBox VMs</li>
<li>虚拟光盘：无</li>
<li>类型：按需求。Linux</li>
<li>Subtype: 按需求。Ubuntu</li>
<li>版本：按需求。Ubuntu(64-bit)</li>
</ul></li>
<li>自动安装，无</li>
<li>硬件
<ul class="org-ul">
<li>内存：自定义，2G</li>
<li>处理器：自定义，2核心，尽量不超过宿主机核心
<ul class="org-ul">
<li>宿主机核心，我的电脑右键&#x2013;&gt;属性&#x2013;&gt;设备管理器&#x2013;&gt;处理器</li>
</ul></li>
</ul></li>
<li>虚拟硬盘
<ul class="org-ul">
<li>勾选，不添加虚拟硬盘</li>
</ul></li>
</ul>

<p>
<b>虚拟机设置</b>
</p>
<ul class="org-ul">
<li>系统-主板：
<ul class="org-ul">
<li>启动顺序：去掉软驱</li>
</ul></li>
<li>显示-屏幕
<ul class="org-ul">
<li>显存大小：32M</li>
</ul></li>
<li>存储
<ul class="org-ul">
<li>IDE光盘控制器，SATA机械硬盘控制器，稍后添加</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:a801a3f1-634f-4e58-a6f9-fd5be3d519c5" class="outline-3">
<h3 id="h:a801a3f1-634f-4e58-a6f9-fd5be3d519c5">虚拟硬盘简介</h3>
<div class="outline-text-3" id="text-h:a801a3f1-634f-4e58-a6f9-fd5be3d519c5">
<blockquote>
<p>
认识虚拟硬盘并介绍VHD格式的虚拟硬盘
</p>
</blockquote>

<p>
和真实的计算机一样虚拟机也需要一块硬盘，但这个硬盘并不是真实的硬盘，而是用文件模拟的硬盘(虚拟硬盘)。
</p>

<p>
不同公司开发的虚拟机软件对于虚拟硬盘格式的标准各不相同
</p>
<ul class="org-ul">
<li>VMDK(VMWare虚拟机)</li>
<li>VDI(VirtuaBox虚拟机)</li>
<li>VHD(Virtual-PC/Hyper-V虚拟机)</li>
<li>&#x2026; &#x2026;</li>
</ul>

<p>
<b>VHD格式虚拟机硬盘</b>
</p>

<p>
VHD相对简单
</p>
<ul class="org-ul">
<li><a href="https://learn.microsoft.com/zh-cn/windows/win32/vstor/about-vhd">Virtual Hard Disk Image Format Specification</a></li>
<li>文件前面数据区0面0柱1扇区、0面0柱2扇区等，最后512字节结尾，以conectix开头表示这是一个合法的VHD文件，包含创建时间大小等信息。</li>
</ul>



<figure id="orgdb9e630">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241114_070855.png" alt="img_20241114_070855.png" width="90%">

</figure>

<p>
创建 VHD(了解，不操作)
</p>
<ul class="org-ul">
<li>打开磁盘管理。 在任务栏的搜索框中，输入“计算机管理”，然后选择“存储”&gt;“磁盘管理”。</li>
<li>在“操作”菜单上，选择“创建 VHD”</li>
</ul>
</div>
</div>
<div id="outline-container-h:6941fd69-bc2b-4d40-8a97-6d66e8c75371" class="outline-3">
<h3 id="h:6941fd69-bc2b-4d40-8a97-6d66e8c75371">在Windows下创建虚拟硬盘并安装操作系统</h3>
<div class="outline-text-3" id="text-h:6941fd69-bc2b-4d40-8a97-6d66e8c75371">
<p>
创建虚拟硬盘
</p>
<ul class="org-ul">
<li>管理&#x2013;&gt;工具&#x2013;&gt;虚拟介质管理&#x2013;&gt;创建
<ul class="org-ul">
<li>虚拟硬盘文件类型：VHD</li>
<li>虚拟硬盘文件位置：自定义，D:\VirtuaBox VMs\unbutu.vhd</li>
<li>虚拟硬盘文件大小：自定义，10G</li>
</ul></li>
</ul>

<p>
虚拟机关联虚拟硬盘
</p>
<ul class="org-ul">
<li>选择已经创建的虚拟硬盘。虚拟机设置&#x2013;&gt;存储&#x2013;&gt;SATA控制器</li>
</ul>

<p>
光盘安装操作系统
</p>
<ul class="org-ul">
<li>选择已经下载的ISO文件。虚拟机设置&#x2013;&gt;存储&#x2013;&gt;IDE控制器</li>
<li>启动虚拟机</li>
<li>安装操作系统
<ul class="org-ul">
<li>安装过程略</li>
</ul></li>
</ul>

<p>
操作系统IOS
</p>
<ul class="org-ul">
<li>Ubuntu <a href="https://ubuntu.com/">https://ubuntu.com/</a></li>
</ul>
</div>
</div>
<div id="outline-container-h:575d6206-5c9e-4f95-a55e-6c499f4139b3" class="outline-3">
<h3 id="h:575d6206-5c9e-4f95-a55e-6c499f4139b3">在Linux下创建虚拟硬盘并安装操作系统</h3>
<div class="outline-text-3" id="text-h:575d6206-5c9e-4f95-a55e-6c499f4139b3">
<p>
同上，虚拟硬盘创建过程直接在virtuabox的对应虚拟机设置中操作，过程略
</p>
</div>
</div>
</section>
<section id="outline-container-h:66b72697-8b0f-4624-9979-0dc76771c967" class="outline-2">
<h2 id="h:66b72697-8b0f-4624-9979-0dc76771c967">汇编语言程序的调试</h2>
<div class="outline-text-2" id="text-h:66b72697-8b0f-4624-9979-0dc76771c967">
<p>
主要内容
</p>

<ul class="org-ul">
<li>带调试功能的虚拟机</li>
<li>安装Bochs虚拟机</li>
<li>为Bochs虚拟机安装虚拟硬盘</li>
<li>创建主引导扇区程序</li>
<li>将程序写入硬盘主引导扇区</li>
<li>用调试器观察程序的执行</li>
</ul>
</div>
<div id="outline-container-h:ec6cbc7a-cf8c-42fd-9d7d-c8676930d263" class="outline-3">
<h3 id="h:ec6cbc7a-cf8c-42fd-9d7d-c8676930d263">带调试功能的虚拟机</h3>
<div class="outline-text-3" id="text-h:ec6cbc7a-cf8c-42fd-9d7d-c8676930d263">
<p>
回顾一下：
</p>

<p>
二进制指令文件编译.
</p>
<div class="org-src-container">
<pre class="src src-sh">nasm exam.asm -f bin -o exam.bin
</pre>
</div>

<p>
编译的文件不能在任何操作系统中运行。因为他里面只包含了处理器指令。而操作系统要求可
执行程序里必须包含一些额外的内容来知道系统如何加载这个程序。
</p>

<p>
计算机启动过程：
程序内容写入主引导扇区，因为在计算机加电或者复位后，将首先从ROM BIOS中执行，然后硬盘主引导扇区的内容读到内存，并执行读取后的指令
</p>

<p>
由于它破坏了真实的计算机，所以可用虚拟机来做这样的事。
</p>

<p>
如果想看到指令执行过程，可以使用另一种带调试过程的虚拟机Bochs
</p>

<ul class="org-ul">
<li>显示指令执行过程</li>
<li>显示机器的状态</li>
<li>显示寄存器的内容</li>
</ul>
</div>
</div>
<div id="outline-container-h:56e2e5e3-c5b0-4b6d-8783-7abd223ba666" class="outline-3">
<h3 id="h:56e2e5e3-c5b0-4b6d-8783-7abd223ba666">安装Bochs虚拟机</h3>
<div class="outline-text-3" id="text-h:56e2e5e3-c5b0-4b6d-8783-7abd223ba666">
<p>
Bochs官网：<a href="https://bochs.sourceforge.io/">https://bochs.sourceforge.io/</a>
</p>

<p>
Windows下载，这里下载的2.8版本，安装时自定义安装路径其他默认就好。
</p>

<p>
Ubuntu安装Bochs虚拟机
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo apt install bochs

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;bochs</span>
bochs <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36873;&#25321;3&#26469;&#32534;&#36753;&#30828;&#20214;</span>
</pre>
</div>

<p>
Bochs是一台完整的虚拟计算机，第一次启动时需要配置一套自己的硬件配置。
</p>

<ul class="org-ul">
<li>bochsdbg.exe 具有调试功能的虚拟机</li>
<li>bochs.exe 虚拟机</li>
</ul>
</div>
</div>
<div id="outline-container-h:2a1d281b-bc23-47a9-a0d3-49fb7174b704" class="outline-3">
<h3 id="h:2a1d281b-bc23-47a9-a0d3-49fb7174b704">为Bochs虚拟机安装虚拟硬盘</h3>
<div class="outline-text-3" id="text-h:2a1d281b-bc23-47a9-a0d3-49fb7174b704">
<p>
创建VDH格式的硬盘，大小20MB
</p>
<ul class="org-ul">
<li>打开VirtuaBox虚拟机软件
<ul class="org-ul">
<li>菜单管理&#x2013;&gt;工具&#x2013;&gt;虚拟介质管理&#x2013;&gt;创建。硬盘类型VDH，大小20MB，预先分配空间。方便写入数据</li>
<li>D:\VirtualBox VMs\learn.vhd</li>
</ul></li>
</ul>

<p>
查看VDH硬盘信息。最后512字节为硬盘信息
</p>
<ul class="org-ul">
<li>fixvhdwr.exe 自己编写的查看VDH硬盘信息工具</li>
</ul>

<pre class="example" id="org476bec8">
虚拟硬盘： D:\VirtualBox VMs\learn.vhd
VHD规范的原始创建者标识： conectix
创建此文件的程序：vbox
创建此文件的程序版本：07.01
该虚拟磁盘创建于 2024-11-16 3:05:01。
602个柱面；4个磁头；每磁道有17个扇区。
总容量为 20 MB（兆字节）。
该磁盘为固定磁盘（容量固定，文件大小不变）
</pre>

<p>
配置Bochs配置硬盘
</p>
<ul class="org-ul">
<li>打开Bochs，编辑Disk&amp;Boot</li>
<li>Floppy Options 软盘选项，关闭
<ul class="org-ul">
<li>Type of floppy drive: none</li>
</ul></li>
<li>ATA channel 0 硬盘控制器通道0
<ul class="org-ul">
<li>ATA channel 0: 启动，勾选Enable</li>
<li>First HD/CD on channel 0:
<ul class="org-ul">
<li>Type of ATA device: disk 设备类型硬盘</li>
<li>Path or physical device name: 物理设备名的路径，选择刚创建的固定大小20MB的HDV格式硬盘</li>
<li>Type of disk image: flat 硬盘镜像类型选择flat或者vpc</li>
<li>Cylinders: 602  柱面数，填写刚创建虚拟硬盘对应的信息</li>
<li>Heads: 4 磁头数，填写刚创建虚拟硬盘对应的信息</li>
<li>Sector per track: 17 每道扇区数，填写刚创建虚拟硬盘对应的信息</li>
<li>Sector size: 512 扇区大小，填写刚创建虚拟硬盘对应的信息</li>
</ul></li>
</ul></li>
<li>Boot Options 计算机启动顺序
<ul class="org-ul">
<li>依次为disk, cdrom,noe</li>
</ul></li>
</ul>

<p>
quit 退出
</p>

<p>
退出后启动需要重新设置，可 <code>Save</code> 保存配置到bochs工作目录下, 保存名称为bochsrc.bxrc，这是bochs默认启动的配置。
</p>
</div>
</div>
<div id="outline-container-h:bce7c485-20cc-4010-bc8c-3c669afd8c2e" class="outline-3">
<h3 id="h:bce7c485-20cc-4010-bc8c-3c669afd8c2e">创建主引导扇区程序</h3>
<div class="outline-text-3" id="text-h:bce7c485-20cc-4010-bc8c-3c669afd8c2e">
<p>
16进制工具：
</p>
<ul class="org-ul">
<li>Mac版 hexfiend 下载地址：<a href="https://github.com/HexFiend/HexFiend/releases">https://github.com/HexFiend/HexFiend/releases</a></li>
<li>Windows 版 010 editor， 下载地址：<a href="https://www.sweetscape.com/010editor/">https://www.sweetscape.com/010editor/</a></li>
<li>命令行查看 hexdump -C ctfhub.png</li>
</ul>

<p>
创建主引导扇区程序exam.asm
</p>
<div class="org-src-container">
<pre class="src src-sh">mov ax, 0x30      ;&#23558;&#31435;&#21363;&#25968;&#20256;&#36865;&#21040;AX&#23492;&#23384;&#22120;
mov dx, 0xC0
add ax, dx  ;&#23558;&#23492;&#23384;&#22120;ax&#21644;dx&#30340;&#20540;&#30456;&#21152;&#65292;&#32467;&#26524;&#22312;ax
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm  exam.asm -f bin -o exam.bin  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24471;&#21040;8&#20010;&#23383;&#33410;&#30340;&#25968;&#25454;&#12290;</span>
$ hexdump -C exam.bin
00000000  b8 30 00 ba c0 00 01 d0                           |.0......|
00000008

<span style="color: #b22222;">#</span><span style="color: #b22222;">8086&#26159;&#20302;&#31471;&#23383;&#33410;&#24207;&#30340;&#12290;</span>
b8 30 00 &#23601;&#26159; b8 0030
ba 00c0
0d0a
</pre>
</div>

<p>
主引导扇区512个字节。一个有效的主引导扇区其最后2个字节的数据必须是55AA。exam.bin程序总长8个字节。缺少的502个字节用0填充。
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ax</span>, 0x30      <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#31435;&#21363;&#25968;&#20256;&#36865;&#21040;AX&#23492;&#23384;&#22120;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">dx</span>, 0xC0
<span style="color: #0000ff;">add</span> <span style="color: #a020f0;">ax</span>, dx  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#23492;&#23384;&#22120;ax&#21644;dx&#30340;&#20540;&#30456;&#21152;&#65292;&#32467;&#26524;&#22312;ax</span>

<span style="color: #0000ff;">times</span> <span style="color: #a020f0;">502</span> db 0 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#37325;&#22797;&#25191;&#34892;502&#27425;&#21518;&#38754;&#30340;&#25351;&#20196;&#65292;db 0 &#21521;&#31243;&#24207;&#28155;&#21152;1&#23383;&#33410;&#25968;&#25454;</span>

<span style="color: #0000ff;">db</span> <span style="color: #a020f0;">0x55</span>
<span style="color: #0000ff;">db</span> <span style="color: #a020f0;">0xAA</span> <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20027;&#24341;&#23548;&#25159;&#21306;&#26377;&#25928;&#26631;&#35782;55AA</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">db <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20266;&#25351;&#20196;&#65292;&#26469;&#21521;&#31243;&#24207;&#20013;&#28155;&#21152;1&#20010;&#23383;&#33410;&#30340;&#25968;&#25454;&#12290;&#25968;&#25454;&#21487;&#20197;&#26159;0&#65292;55&#31561;&#19968;&#20010;&#23383;&#33410;&#30340;&#25968;&#25454;&#12290;&#20266;&#25351;&#20196;&#19981;&#26159;&#30495;&#27491;&#22788;&#29702;&#22120;&#25351;&#20196;&#32780;&#26159;&#21482;&#23545;&#32534;&#35793;&#22120;&#26377;&#25928;&#30340;&#25351;&#20196;&#12290;</span>
<span style="color: #483d8b;">times</span> n <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20266;&#25351;&#20196;&#65292;&#37325;&#22797;&#21518;&#25351;&#20196;&#27425;&#25968;&#65292;n&#20026;&#27425;&#25968;</span>
</pre>
</div>

<p>
重新编译
</p>
<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm  exam.asm -f bin -o exam.bin
jasper@jasper MINGW64 /d/project/assemblyprojs
$ hexdump -C exam.bin
00000000  b8 30 00 ba c0 00 01 d0  00 00 00 00 00 00 00 00  |.0..............|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
000001f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 55 aa  |..............U.|
00000200
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c2578057-deb7-40f0-bd86-b53044fdf1a4" class="outline-3">
<h3 id="h:c2578057-deb7-40f0-bd86-b53044fdf1a4">将程序写入硬盘主引导扇区</h3>
<div class="outline-text-3" id="text-h:c2578057-deb7-40f0-bd86-b53044fdf1a4">
<p>
将2进制程序写入虚拟硬盘文件learn.vhd
</p>
<ul class="org-ul">
<li>方法1 fixvhdwr.exe 用自定义的程序导入。
<ul class="org-ul">
<li>LBA连续直写模式，起始LBA区号为0</li>
</ul></li>
<li>方法2 其他有效方法</li>
</ul>
</div>
<div id="outline-container-h:9d28ad31-4f92-46f8-a562-cc40cfba58ae" class="outline-4">
<h4 id="h:9d28ad31-4f92-46f8-a562-cc40cfba58ae">LBA</h4>
<div class="outline-text-4" id="text-h:9d28ad31-4f92-46f8-a562-cc40cfba58ae">
<p>
传统上，为了读写硬盘必须指定磁头号、柱面号、扇区号。但这样非常麻烦，可以指定逻辑扇区号。
</p>

<p>
1个扇区的大小512字节，可以看成一个数据块Block。所以可以认为硬盘是典型的块设备。
</p>

<p>
采用柱面(Cylinder)、磁盘(Header)和扇区(Sector)来访问硬盘的方法叫做CHS模式。每次访问读写
磁盘都要考虑这些不是很方便，传统的CHS采用24bit寻址，这样硬盘容量太小
</p>
<ul class="org-ul">
<li>传统的CHS采用 24 bit位寻址</li>
<li>其中前10位表示cylinder，中间8位表示head，后面6位表示sector</li>
<li>最大寻址空间 8 GB.   echo 2^24*512/1024/1024|bc</li>
</ul>

<p>
如果将磁盘的所有扇区统一编号，在读写时只用指定的统一编号将方便很多。
</p>

<p>
逻辑块地址(LBA):  logical block addressing
</p>
<ul class="org-ul">
<li>LBA是一个整数，通过转换成 CHS 格式完成磁盘具体寻址</li>
<li>ATA-1规范中定义了28位寻址模式，以每扇区512位组来计算，ATA-1所定义的 28位LBA上限达到128 GiB。2002年ATA-6规范采用48位LBA，同样以每扇区512 位组计算容量上限可达128Petabytes</li>
</ul>

<p>
范例：逻辑扇区编号
</p>

<pre class="example" id="org6f5cfd7">
假定某硬盘有2个磁头，100个柱面，每磁盘有17个扇区。那么：
逻辑0扇区对应着0面0道1扇区；
逻辑1扇区对应着0面0道2扇区；
......
逻辑16扇区对应着0面0道16扇区；
逻辑17扇区对应着1面0道1扇区；
逻辑18扇区对应着1面0道2扇区；
......
逻辑33扇区对应着1面0道17扇区；
逻辑34扇区对应着0面1道1扇区；
逻辑35扇区对应着0面1道2扇区；
......
要注意，扇区在编号时，是以柱面为单位的。即，先是0面0道，接着是1面0道，直到把所有
盘面上的0磁道处理完，再接着处理下一个柱面。之所以这样，是因为要加速硬盘的访问速度，
最好是尽可能不移动磁头。
因为这里总共有3400(2*100*17)个扇区，故最后一个逻辑扇区的编号是3399，它对应着1面99道17扇区，
这也是整个硬盘上最后一个物理扇区。
</pre>

<p>
若已知物理扇区的位置是对于H面(头)、C道的第S个扇区，则它的逻辑扇区号是：
</p>
\begin{equation*}
C \times 磁头总数 \times 每道扇区数 + H \times 每道扇区数 + (S - 1)
\end{equation*}
</div>
</div>
</div>
<div id="outline-container-h:0ddf27df-95a6-4216-a291-94e5fe54b30d" class="outline-3">
<h3 id="h:0ddf27df-95a6-4216-a291-94e5fe54b30d">用调试器观察程序的执行</h3>
<div class="outline-text-3" id="text-h:0ddf27df-95a6-4216-a291-94e5fe54b30d">
<blockquote>
<p>
通过调试主引导扇区程序，来了解Bochs虚拟机的软件调试环境，以及软件调试的一般过程
</p>
</blockquote>
</div>
<div id="outline-container-h:8e5a73d8-6101-43c1-99b3-447c8f3edd5b" class="outline-4">
<h4 id="h:8e5a73d8-6101-43c1-99b3-447c8f3edd5b">8086处理器之后的32位64位寄存器</h4>
<div class="outline-text-4" id="text-h:8e5a73d8-6101-43c1-99b3-447c8f3edd5b">
<table class="infobox" style="font-size:88%;width:38em;float: right;">

<caption style="font-weight: bold;">Intel 8086 registers
</caption>
<tbody><tr>
<td>
<table style="font-size:88%;">

<tbody><tr>
<td style="width:10px; text-align:center;"><sup>1</sup><sub>9</sub>
</td>
<td style="width:10px; text-align:center;"><sup>1</sup><sub>8</sub>
</td>
<td style="width:10px; text-align:center;"><sup>1</sup><sub>7</sub>
</td>
<td style="width:10px; text-align:center;"><sup>1</sup><sub>6</sub>
</td>
<td style="width:10px; text-align:center;"><sup>1</sup><sub>5</sub>
</td>
<td style="width:10px; text-align:center;"><sup>1</sup><sub>4</sub>
</td>
<td style="width:10px; text-align:center;"><sup>1</sup><sub>3</sub>
</td>
<td style="width:10px; text-align:center;"><sup>1</sup><sub>2</sub>
</td>
<td style="width:10px; text-align:center;"><sup>1</sup><sub>1</sub>
</td>
<td style="width:10px; text-align:center;"><sup>1</sup><sub>0</sub>
</td>
<td style="width:10px; text-align:center;"><sup>0</sup><sub>9</sub>
</td>
<td style="width:10px; text-align:center;"><sup>0</sup><sub>8</sub>
</td>
<td style="width:10px; text-align:center;"><sup>0</sup><sub>7</sub>
</td>
<td style="width:10px; text-align:center;"><sup>0</sup><sub>6</sub>
</td>
<td style="width:10px; text-align:center;"><sup>0</sup><sub>5</sub>
</td>
<td style="width:10px; text-align:center;"><sup>0</sup><sub>4</sub>
</td>
<td style="width:10px; text-align:center;"><sup>0</sup><sub>3</sub>
</td>
<td style="width:10px; text-align:center;"><sup>0</sup><sub>2</sub>
</td>
<td style="width:10px; text-align:center;"><sup>0</sup><sub>1</sub>
</td>
<td style="width:10px; text-align:center;"><sup>0</sup><sub>0</sub>
</td>
<td style="width:auto; background:white; color:black"><i>(bit position)</i>
</td></tr>
<tr>
<td colspan="21"><b>Main registers</b> <br>
</td></tr>
<tr style="background:silver;color:black">
<td style="text-align:center; background:white" colspan="4">&nbsp;
</td>
<td style="text-align:center;" colspan="8">AH
</td>
<td style="text-align:center;" colspan="8">AL
</td>
<td style="background:white; color:black;"><b><a href="https://en.wikipedia.org/wiki/Accumulator_(computing)" title="Accumulator (computing)">AX</a></b> (primary accumulator)
</td></tr>
<tr style="background:silver;color:black">
<td style="text-align:center;background:#DDD" colspan="4">0&nbsp;0&nbsp;0&nbsp;0
</td>
<td style="text-align:center;" colspan="8">BH
</td>
<td style="text-align:center;" colspan="8">BL
</td>
<td style="background:white; color:black;"><b>BX</b> (base, accumulator)
</td></tr>
<tr style="background:silver;color:black">
<td style="text-align:center; background:white" colspan="4">&nbsp;
</td>
<td style="text-align:center;" colspan="8">CH
</td>
<td style="text-align:center;" colspan="8">CL
</td>
<td style="background:white; color:black;"><b>CX</b> (counter, accumulator)
</td></tr>
<tr style="background:silver;color:black">
<td style="text-align:center; background:white" colspan="4">&nbsp;
</td>
<td style="text-align:center;" colspan="8">DH
</td>
<td style="text-align:center;" colspan="8">DL
</td>
<td style="background:white; color:black;"><b>DX</b> (accumulator, extended acc)
</td></tr>
<tr>
<td colspan="21"><b>Index registers</b> <br>
</td></tr>
<tr style="background:silver;color:black">
<td style="text-align:center;background:#DDD" colspan="4">0&nbsp;0&nbsp;0&nbsp;0
</td>
<td style="text-align:center;" colspan="16"><a href="https://en.wikipedia.org/wiki/Index_register" title="Index register">SI</a>
</td>
<td style="background:white; color:black;"><b>S</b>ource <b>I</b>ndex
</td></tr>
<tr style="background:silver;color:black">
<td style="text-align:center;background:#DDD" colspan="4">0&nbsp;0&nbsp;0&nbsp;0
</td>
<td style="text-align:center;" colspan="16">DI
</td>
<td style="background:white; color:black;"><b>D</b>estination <b>I</b>ndex
</td></tr>
<tr style="background:silver;color:black">
<td style="text-align:center;background:#DDD" colspan="4">0&nbsp;0&nbsp;0&nbsp;0
</td>
<td style="text-align:center;" colspan="16">BP
</td>
<td style="background:white; color:black;"><b>B</b>ase <b>P</b>ointer
</td></tr>
<tr style="background:silver;color:black">
<td style="text-align:center;background:#DDD" colspan="4">0&nbsp;0&nbsp;0&nbsp;0
</td>
<td style="text-align:center;" colspan="16"><a href="https://en.wikipedia.org/wiki/Stack_register" title="Stack register">SP</a>
</td>
<td style="background:white; color:black;"><b>S</b>tack <b>P</b>ointer
</td></tr>
<tr>
<td colspan="21"><b>Program counter</b> <br>
</td></tr>
<tr style="background:silver;color:black">
<td style="text-align:center;background:#DDD" colspan="4">0&nbsp;0&nbsp;0&nbsp;0
</td>
<td style="text-align:center;" colspan="16"><a href="https://en.wikipedia.org/wiki/Program_counter" title="Program counter">IP</a>
</td>
<td style="background:white; color:black;"><b>I</b>nstruction <b>P</b>ointer
</td></tr>
<tr>
<td colspan="21"><b>Segment registers</b> <br>
</td></tr>
<tr style="background:silver;color:black">
<td style="text-align:center;" colspan="16">CS
</td>
<td style="text-align:center;background:#DDD" colspan="4">0&nbsp;0&nbsp;0&nbsp;0
</td>
<td style="background:white; color:black;"><b>C</b>ode <b>S</b>egment
</td></tr>
<tr style="background:silver;color:black">
<td style="text-align:center;" colspan="16">DS
</td>
<td style="text-align:center;background:#DDD" colspan="4">0&nbsp;0&nbsp;0&nbsp;0
</td>
<td style="background:white; color:black;"><b>D</b>ata <b>S</b>egment
</td></tr>
<tr style="background:silver;color:black">
<td style="text-align:center;" colspan="16">ES
</td>
<td style="text-align:center;background:#DDD" colspan="4">0&nbsp;0&nbsp;0&nbsp;0
</td>
<td style="background:white; color:black;"><b>E</b>xtra <b>S</b>egment
</td></tr>
<tr style="background:silver;color:black">
<td style="text-align:center;" colspan="16">SS
</td>
<td style="text-align:center;background:#DDD" colspan="4">0&nbsp;0&nbsp;0&nbsp;0
</td>
<td style="background:white; color:black;"><b>S</b>tack <b>S</b>egment
</td></tr>
<tr>
<td colspan="21"><b>Status register</b>
</td></tr>
<tr style="background:silver;color:black">
<td style="text-align:center; background:white" colspan="4">&nbsp;
</td>
<td style="text-align:center;">-
</td>
<td style="text-align:center;">-
</td>
<td style="text-align:center;">-
</td>
<td style="text-align:center;">-
</td>
<td style="text-align:center;"><a href="https://en.wikipedia.org/wiki/Overflow_flag" title="Overflow flag">O</a>
</td>
<td style="text-align:center;"><a href="https://en.wikipedia.org/wiki/Direction_flag" title="Direction flag">D</a>
</td>
<td style="text-align:center;"><a href="https://en.wikipedia.org/wiki/IF_(x86_flag)" class="mw-redirect" title="IF (x86 flag)">I</a>
</td>
<td style="text-align:center;"><a href="https://en.wikipedia.org/wiki/Trap_flag" title="Trap flag">T</a>
</td>
<td style="text-align:center;"><a href="https://en.wikipedia.org/wiki/Sign_flag" class="mw-redirect" title="Sign flag">S</a>
</td>
<td style="text-align:center;"><a href="https://en.wikipedia.org/wiki/Zero_flag" title="Zero flag">Z</a>
</td>
<td style="text-align:center;">-
</td>
<td style="text-align:center;"><a href="https://en.wikipedia.org/wiki/Adjust_flag" class="mw-redirect" title="Adjust flag">A</a>
</td>
<td style="text-align:center;">-
</td>
<td style="text-align:center;"><a href="https://en.wikipedia.org/wiki/Parity_flag" title="Parity flag">P</a>
</td>
<td style="text-align:center;">-
</td>
<td style="text-align:center;"><a href="https://en.wikipedia.org/wiki/Carry_flag" title="Carry flag">C</a>
</td>
<td style="background:white; color:black">Flags
</td></tr></tbody></table>
</td></tr></tbody></table>


<table>
<caption class="t-above"><span class="table-number">Table 1:</span> 通过寄存器</caption>

<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">64位寄存器</th>
<th scope="col" class="org-left">低32位</th>
<th scope="col" class="org-left">低16位</th>
<th scope="col" class="org-left">低8位</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">rax</td>
<td class="org-left">eax</td>
<td class="org-left">ax</td>
<td class="org-left">al</td>
</tr>

<tr>
<td class="org-left">rbx</td>
<td class="org-left">ebx</td>
<td class="org-left">bx</td>
<td class="org-left">bl</td>
</tr>

<tr>
<td class="org-left">rcx</td>
<td class="org-left">ecx</td>
<td class="org-left">cx</td>
<td class="org-left">cl</td>
</tr>

<tr>
<td class="org-left">rdx</td>
<td class="org-left">edx</td>
<td class="org-left">dx</td>
<td class="org-left">dl</td>
</tr>

<tr>
<td class="org-left">rsi</td>
<td class="org-left">esi</td>
<td class="org-left">si</td>
<td class="org-left">sil</td>
</tr>

<tr>
<td class="org-left">rdi</td>
<td class="org-left">edi</td>
<td class="org-left">di</td>
<td class="org-left">dil</td>
</tr>

<tr>
<td class="org-left">rbp</td>
<td class="org-left">ebp</td>
<td class="org-left">bp</td>
<td class="org-left">bpl</td>
</tr>

<tr>
<td class="org-left">rsp</td>
<td class="org-left">esp</td>
<td class="org-left">sp</td>
<td class="org-left">spl</td>
</tr>
</tbody>
</table>

<p>
ax、bx、cx 和 dx 的高 8 位仍可寻址为 ah、bh、ch、dh，但不能与所有类型的操作数一起使用。
</p>

<table>
<caption class="t-above"><span class="table-number">Table 2:</span> 指令指针寄存</caption>

<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">64位寄存器</th>
<th scope="col" class="org-left">低32位</th>
<th scope="col" class="org-left">低16位</th>
<th scope="col" class="org-left">低8位</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">rip</td>
<td class="org-left">eip</td>
<td class="org-left">ip</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>


<p>
<b>x86体系结构（32位）</b>
</p>

<p>
x86体系结构源自1980年代，它是一种CISC（复杂指令集计算）架构，广泛应用于个人电脑中。在32位的x86体系结构中，主要包括以下几类寄存器：
</p>

<ul class="org-ul">
<li>通用寄存器（EAX, EBX, ECX, EDX）：用于多种算术和逻辑运算。</li>
<li>索引寄存器（ESI, EDI）：主要用于指针操作和字符串处理。</li>
<li>指针寄存器（ESP, EBP）：用于管理堆栈操作。</li>
<li>段寄存器（CS, DS, SS, ES, FS, GS）：用于存储内存段的地址。</li>
<li>指令指针（EIP）：存储即将执行的下一条指令的地址。</li>
<li>标志寄存器（EFLAGS）：存储当前状态标志，如零标志、符号标志等。</li>
</ul>

<p>
<b>x86-64体系结构（64位）</b>
</p>

<p>
随着技术的发展，64位计算成为必要，因此x86架构被扩展到了x86-64，也称为AMD64或Intel 64。这个架构不仅增加了寄存器的数量，而且扩展了寄存器的大小。在64位架构中，主要的变化包括：
</p>

<ul class="org-ul">
<li>扩展的通用寄存器：每个32位寄存器（如EAX）都有对应的64位版本（如RAX）。</li>
<li>新增的通用寄存器：R8 到 R15。</li>
<li>扩展的索引寄存器：ESI、EDI、EBP、ESP都有对应的64位版本（如RSI、RDI、RBP、RSP）。</li>
<li>扩展的指令指针和标志寄存器：RIP 和 RFLAGS。</li>
</ul>

<p>
这些改进提供了更大的地址空间和更高的数据处理能力，使得64位处理器可以高效地处理更大的数据集和更复杂的程序。
</p>


<p>
参考：<a href="https://learn.microsoft.com/en-au/windows-hardware/drivers/debugger/x64-architecture">x64 Architecture</a>
</p>
</div>
</div>
<div id="outline-container-h:bdcb3401-d356-4c29-b19b-a1cf2f4a55d2" class="outline-4">
<h4 id="h:bdcb3401-d356-4c29-b19b-a1cf2f4a55d2">boch开机</h4>
<div class="outline-text-4" id="text-h:bdcb3401-d356-4c29-b19b-a1cf2f4a55d2">
<p>
已经准备
</p>
<ul class="org-ul">
<li>虚拟硬盘文件</li>
<li>主引导扇区程序</li>
</ul>

<p>
之后就可在Bochs虚拟中调试了。打开具有调试功能的虚拟机 bochsdbg.exe
</p>

<p>
与真正的处理器不同，bochs在取第1条指令之前会停下来，等待你的调试命令。
</p>

<div class="org-src-container">
<pre class="src src-sh">Next at <span style="color: #a0522d;">t</span>=0  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26102;&#38047;&#28404;&#31572;&#30340;&#31532;1&#27425;&#65292;&#21363;&#19979;&#19968;&#26465;&#25351;&#20196;&#22312;t=0&#30340;&#22522;&#30784;&#19978;&#25191;&#34892;&#12290;&#27599;&#27169;&#25311;1&#27425;&#65292;&#26102;&#38047;&#20250;&#28404;&#31572;1&#27425;</span>
(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#34892;&#34920;&#31034;&#21363;&#23558;&#25191;&#34892;&#30340;&#25351;&#20196;</span>
&lt;bochs:1&gt;

[0x0000fffffff0] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#26465;&#25351;&#20196;&#25152;&#22312;&#29289;&#29702;&#20869;&#23384;&#22320;&#22336;&#12290;&#20180;&#32454;&#35266;&#23519;&#21487;&#21457;&#29616;&#65292;&#19982;&#19979;&#38754;&#30340;&#36923;&#36753;&#22320;&#22336;&#19981;&#19968;&#33268;&#65292; &#36923;&#36753;&#22320;&#22336;&#23545;&#24212;ffff0&#30340;&#29289;&#29702;&#22320;&#22336;&#12290;&#36825;&#26159;&#26377;&#21407;&#22240;&#30340;&#65292;&#21482;&#22312;&#22788;&#29702;&#22120;&#21018;&#21551;&#21160;&#26102;&#21457;&#29983;&#65292;&#26242;&#19981;&#35752;&#35770;</span>
f000:fff0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36923;&#36753;&#22320;&#22336;&#65292;&#21487;&#20197;&#29702;&#35299;&#20026;&#27573;&#23492;&#23384;&#22120;CS&#20869;&#23481;F000, &#25351;&#20196;&#25351;&#38024;&#23492;&#23384;&#22120;IP&#20869;&#23481;FFF0&#12290;&#19981;&#20687;8086&#22788;&#29702;&#22120;&#27573;&#23492;&#23384;&#22120;FFFF&#65292;&#25351;&#20196;&#25351;&#38024;&#23492;&#23384;&#22120;0&#12290;</span>
jmpf 0xf000:e05b <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#26465;&#25351;&#20196;&#30340;&#27719;&#32534;&#35821;&#35328;&#24418;&#24335;&#12290;&#36339;&#36716;&#25351;&#20196;&#65292;&#30446;&#26631;&#20301;&#32622;0xf000:e05b</span>
;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#21495;&#20026;&#27880;&#37322;</span>
ea5be000f0  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#26465;&#25351;&#20196;&#30340;&#26426;&#22120;&#30721;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4be4e56f-addd-4a3e-bce7-761c9b2f95ac" class="outline-4">
<h4 id="h:4be4e56f-addd-4a3e-bce7-761c9b2f95ac">bochs调试命令</h4>
<div class="outline-text-4" id="text-h:4be4e56f-addd-4a3e-bce7-761c9b2f95ac">
<div class="org-src-container">
<pre class="src src-sh">sreg   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#27573;&#23492;&#23384;&#22120;&#20869;&#23481;</span>
r    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#36890;&#36807;&#23492;&#23384;&#22120;</span>
s  <span style="color: #b22222;">#</span><span style="color: #b22222;">step &#21333;&#27493;&#25191;&#34892;</span>
b <span style="color: #b22222;">#</span><span style="color: #b22222;">break&#26029;&#28857;&#25351;&#20196;&#65292;&#35774;&#32622;&#19968;&#20010;&#20869;&#23384;&#22320;&#22336;&#65292;&#24403;&#21069;&#22788;&#29702;&#22120;&#25191;&#34892;&#21040;&#27492;&#20301;&#32622;&#23558;&#20572;&#19968;&#19979;&#26469;</span>
c <span style="color: #b22222;">#</span><span style="color: #b22222;">countine&#25345;&#32493;&#25191;&#34892;&#65292;&#22914;&#26524;&#36935;&#21040;&#26029;&#28857;&#20250;&#20572;&#19979;&#26469;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f5092b99-3173-4142-9c11-198be60315e0" class="outline-4">
<h4 id="h:f5092b99-3173-4142-9c11-198be60315e0">bochs开始调试</h4>
<div class="outline-text-4" id="text-h:f5092b99-3173-4142-9c11-198be60315e0">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#27573;&#23492;&#23384;&#22120;</span>
&lt;bochs:1&gt; sreg
es:0x0000, <span style="color: #a0522d;">dh</span>=0x00009300, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=7
        Data segment, <span style="color: #a0522d;">base</span>=0x00000000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
cs:0xf000, <span style="color: #a0522d;">dh</span>=0xff0093ff, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=7
        Data segment, <span style="color: #a0522d;">base</span>=0xffff0000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
ss:0x0000, <span style="color: #a0522d;">dh</span>=0x00009300, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=7
        Data segment, <span style="color: #a0522d;">base</span>=0x00000000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
ds:0x0000, <span style="color: #a0522d;">dh</span>=0x00009300, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=7
        Data segment, <span style="color: #a0522d;">base</span>=0x00000000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
fs:0x0000, <span style="color: #a0522d;">dh</span>=0x00009300, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=7
        Data segment, <span style="color: #a0522d;">base</span>=0x00000000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
gs:0x0000, <span style="color: #a0522d;">dh</span>=0x00009300, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=7
        Data segment, <span style="color: #a0522d;">base</span>=0x00000000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
ldtr:0x0000, <span style="color: #a0522d;">dh</span>=0x00008200, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=1
tr:0x0000, <span style="color: #a0522d;">dh</span>=0x00008b00, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=1
gdtr:<span style="color: #a0522d;">base</span>=0x0000000000000000, <span style="color: #a0522d;">limit</span>=0xffff
idtr:<span style="color: #a0522d;">base</span>=0x0000000000000000, <span style="color: #a0522d;">limit</span>=0xffff

<span style="color: #b22222;">#</span><span style="color: #b22222;">cs, ds &#26089;&#22312;8086&#22788;&#29702;&#22120;&#26377;&#26377;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">es, ss, fs, gs, tr, gdtr, idtr &#26159;8086&#20043;&#21518;&#22788;&#29702;&#22120;&#26032;&#22686;&#30340;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#36890;&#29992;&#23492;&#23384;&#22120;</span>
&lt;bochs:2&gt; r
rax: 00000000_00000000
rbx: 00000000_00000000
rcx: 00000000_00000000
rdx: 00000000_00000000
rsp: 00000000_00000000
rbp: 00000000_00000000
rsi: 00000000_00000000
rdi: 00000000_00000000
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_0000fff0  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#20196;&#25351;&#38024;&#23492;&#23384;&#22120;&#20869;&#23481;fff0</span>
eflags: 0x00000002: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf sf zf af pf cf

<span style="color: #b22222;">#</span><span style="color: #b22222;">bochs&#24320;&#26426;&#21518;&#65292;&#25152;&#26377;&#30340;&#36890;&#36807;&#23492;&#23384;&#22120;&#20869;&#23481;&#37117;&#26159;0</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21333;&#27493;&#25191;&#34892;&#25351;&#20196;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#37324;&#25191;&#34892;&#20102; jmpf 0xf000:e05b &#25351;&#20196;&#65292;&#21487;&#20197;&#30475;&#21040;&#19979;&#19968;&#26465;&#23558;&#25191;&#34892;&#25351;&#20196;&#26159; xor ax, ax</span>
&lt;bochs:3&gt; s
Next at <span style="color: #a0522d;">t</span>=1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26102;&#38047;&#28404;&#31572;&#30340;&#31532;2&#27425;&#65292;&#21363;&#19979;&#19968;&#26465;&#25351;&#20196;&#22312;t=1&#30340;&#22522;&#30784;&#19978;&#25191;&#34892;&#12290;</span>
(0) [0x0000000fe05b] f000:e05b (unk. ctxt): xor ax, ax                ; 31c0
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#21040;&#65292;f000:e05b &#21644; &#29289;&#29702;&#22320;&#22336;fe05b&#19968;&#33268;&#20102;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#22320;&#22336;&#21487;&#20197;&#30475;&#20986;&#65292;&#30446;&#21069;&#36824;&#26159;&#22312; ROM BIOS&#20013;&#25191;&#34892;</span>

Next at <span style="color: #a0522d;">t</span>=2
(0) [0x0000000fe05d] f000:e05d (unk. ctxt): out 0x0d, al              ; e60d
&lt;bochs:5&gt; s
Next at <span style="color: #a0522d;">t</span>=3
(0) [0x0000000fe05f] f000:e05f (unk. ctxt): out 0xda, al              ; e6da
&lt;bochs:6&gt; s
Next at <span style="color: #a0522d;">t</span>=4
(0) [0x0000000fe061] f000:e061 (unk. ctxt): mov al, 0xc0              ; b0c0
</pre>
</div>

<p>
<b>定位到离开ROM BIOS最后一条指令</b>
</p>

<p>
因为计算机启动后，总是把主引导扇区内容读取物理内存地址7c00处，然后从主引导扇区开始取指令并执行指令。
可以将这个地址设置为断点。
</p>

<div class="org-src-container">
<pre class="src src-sh">b <span style="color: #b22222;">#</span><span style="color: #b22222;">break&#26029;&#28857;&#25351;&#20196;&#65292;&#35774;&#32622;&#19968;&#20010;&#20869;&#23384;&#22320;&#22336;&#65292;&#24403;&#21069;&#22788;&#29702;&#22120;&#25191;&#34892;&#21040;&#27492;&#20301;&#32622;&#23558;&#20572;&#19968;&#19979;&#26469;</span>
c <span style="color: #b22222;">#</span><span style="color: #b22222;">countine&#25345;&#32493;&#25191;&#34892;&#65292;&#22914;&#26524;&#36935;&#21040;&#26029;&#28857;&#20250;&#20572;&#19979;&#26469;</span>

&lt;bochs:1&gt; b 0x7c00
&lt;bochs:2&gt; c
... ...
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24050;&#32463;&#20572;&#22312;&#26029;&#28857;&#22788;</span>
Next at <span style="color: #a0522d;">t</span>=17175563
(0) [0x000000007c00] 0000:7c00 (unk. ctxt): mov ax, 0x0030            ; b83000
</pre>
</div>

<p>
可以看到下一次指令就是主引导扇区第1条指令 mov ax, 0x30, 也就是我们前面编写的主引导扇区程序。
</p>

<p>
<b>执行程序</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;bochs:3&gt; r
rax: 00000000_0000aa55  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#23481;&#26159;&#22312;&#25191;&#34892;ROM BIOS&#26102;&#36951;&#30041;&#30340;&#65292;&#19981;&#29992;&#31649;</span>
rbx: 00000000_00000000
rcx: 00000000_00090000
rdx: 00000000_00000080
rsp: 00000000_0000ffd6
rbp: 00000000_00000000
rsi: 00000000_000e0000
rdi: 00000000_0000ffac
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c00
eflags: 0x00000082: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf SF zf af pf cf

&lt;bochs:4&gt; s  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;mov ax, 0x30</span>
Next at <span style="color: #a0522d;">t</span>=17175564
(0) [0x000000007c03] 0000:7c03 (unk. ctxt): mov dx, 0x00c0            ; bac000
&lt;bochs:5&gt; r
rax: 00000000_00000030  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#21040;rax&#30340;&#26368;&#20302;16&#20301;&#20869;&#23481; 0030&#65292;&#35828;&#26126;&#21018;&#25165;mov ax, 0x30&#24050;&#32463;&#25104;&#21151;&#25191;&#34892;</span>
rbx: 00000000_00000000
rcx: 00000000_00090000
rdx: 00000000_00000080
rsp: 00000000_0000ffd6
rbp: 00000000_00000000
rsi: 00000000_000e0000
rdi: 00000000_0000ffac
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c03
eflags: 0x00000082: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf SF zf af pf cf

&lt;bochs:6&gt; s <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892; mov dx, 0xc0</span>
Next at <span style="color: #a0522d;">t</span>=17175565
(0) [0x000000007c06] 0000:7c06 (unk. ctxt): add ax, dx                ; 01d0
&lt;bochs:7&gt; r
rax: 00000000_00000030
rbx: 00000000_00000000
rcx: 00000000_00090000
rdx: 00000000_000000c0  <span style="color: #b22222;">#</span><span style="color: #b22222;">rdx&#23492;&#23384;&#22120;&#20869;&#23481;&#20302;16&#20301; 00c0</span>
rsp: 00000000_0000ffd6
rbp: 00000000_00000000
rsi: 00000000_000e0000
rdi: 00000000_0000ffac
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c06
eflags: 0x00000082: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf SF zf af pf cf

&lt;bochs:8&gt; s <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;add ax, dx</span>
Next at <span style="color: #a0522d;">t</span>=17175566
(0) [0x000000007c08] 0000:7c08 (unk. ctxt): add byte ptr ds:[bx+si], al ; 0000  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#19968;&#26465;&#23558;&#25191;&#34892;&#25351;&#20196;&#65292;&#37117;&#26159;0&#19981;&#26159;&#26377;&#25928;&#25351;&#20196;</span>
&lt;bochs:9&gt; r
rax: 00000000_000000f0  <span style="color: #b22222;">#</span><span style="color: #b22222;">rax&#20869;&#23481;  ax + dx = 0x30 + 0xc0 = 0xf0</span>
rbx: 00000000_00000000
rcx: 00000000_00090000
rdx: 00000000_000000c0
rsp: 00000000_0000ffd6
rbp: 00000000_00000000
rsi: 00000000_000e0000
rdi: 00000000_0000ffac
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c08
eflags: 0x00000006: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf sf zf af PF cf

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36864;&#20986;&#65292;&#25353;&#22238;&#36710;&#38190;&#32467;&#26463;&#26412;&#27425;&#35843;&#35797;</span>
&lt;bochs:10&gt; q

Bochs is exiting. Press ENTER when you<span style="color: #8b2252;">'re ready to close this window.</span>
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:d22d6388-723c-4c18-8e85-394adf30318b" class="outline-2">
<h2 id="h:d22d6388-723c-4c18-8e85-394adf30318b">在屏幕上显示文本</h2>
<div class="outline-text-2" id="text-h:d22d6388-723c-4c18-8e85-394adf30318b">
<p>
主要内容
</p>

<ul class="org-ul">
<li>显卡和显存</li>
<li>准备访问文本模式下的显存</li>
<li>字符的编码和显示属性</li>
<li>文本模式下的显存操作</li>
<li>MOV指令的形式和机器码</li>
<li>列表文件的创建和使用</li>
<li>在汇编程序中使用标号</li>
<li>段间直接绝对跳转指令</li>
<li>在Bochs中运行和调试写屏程序</li>
<li>在VirtualBox中运行写屏程序</li>
<li>主引导扇区执行时的内存布局</li>
<li>使用标号计算跳转的偏移地址</li>
<li>使用寄存器的绝对间接近跳转</li>
<li>使用相对偏移量的短跳转和近跳转</li>
</ul>
</div>
<div id="outline-container-h:a12f57da-ad94-4128-bee0-cfd8a82e9d65" class="outline-3">
<h3 id="h:a12f57da-ad94-4128-bee0-cfd8a82e9d65">显卡和显存</h3>
<div class="outline-text-3" id="text-h:a12f57da-ad94-4128-bee0-cfd8a82e9d65">
<p>
<b>显卡</b>
</p>

<p>
为了显示文字，通常需要两种硬件，一种是显示器，一种是显卡。
</p>
<ul class="org-ul">
<li>显卡:的职责是为显示器提供内容并控制显示器的显示模式和状态。
<ul class="org-ul">
<li>独立显卡，独立生产销售的部件，需要插在主板上才能工作。</li>
<li>集成显卡，焊在主板上，是主板的一部分</li>
</ul></li>
<li>显示器的职责是将那些内容以视觉可见的方式呈现在屏幕上。</li>
</ul>


<p>
<b>显存</b>
</p>


<figure id="orgaf92c5a">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241118_234410.png" alt="img_20241118_234410.png" width="90%">

</figure>


<p>
显卡控制显示器的最小单位是像素，这每一个原点都是一个像素，假定这是一个显示器。一个像素对应着屏幕上的一个点，屏幕上通常有数十万乃至更多的像素。通过控制每个像素的明暗和颜色，我们就能让这大量的像素形成美丽的图案和文字。
</p>

<p>
不过一个很容易想到的问题是如何来控制这些像素呢？答案是显卡都有自己的存储器，因为它位于显卡上，所以称之为显示存储器，简称显存。
</p>

<p>
计算机显示文本和图像的基本原理:
</p>
<ul class="org-ul">
<li>要显示的内容都预先写入显存。</li>
<li>和其他半导体存储器一样，显存并没有什么特殊的地方，也是一个按字节组织的存储期间。因此我们可以用显存里的数据来控制每一个像素，使它呈现不同的亮度和颜色</li>
</ul>

<p>
如果显示器只能显示黑白两种颜色，那么只需要控制每个像素是亮还是不亮。我们可以用显存里的每一个比特控制一个像素，如果比特是0，则像素是不亮的。如果是1，则像素是亮的。
</p>

<p>
例如
</p>


<figure id="org2acfc9f">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241118_234822.png" alt="img_20241118_234822.png" width="80%">

</figure>

<div class="org-src-container">
<pre class="src src-sh">10001011 <span style="color: #b22222;">#</span><span style="color: #b22222;">1&#20026;&#20142;&#65292;0&#26263;</span>
</pre>
</div>
<p>
在这里这一串二进制比特用来控制各自的像素，比如比特为1时，对应的像素是亮的。比特是0时对应像素是暗的，看不见，后面的也一样。
</p>



<figure id="org3b33d94">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241118_234917.png" alt="img_20241118_234917.png" width="90%">

</figure>

<p>
有些显示器需要显示灰度，也就是纯黑和纯白之间的中间色。计算机的显示系统可以提供 256级灰度，这需要为一个像素提供8比特的数据，显存里的一个字节对应着显示器上的一个像素.
</p>

<p>
如上图。这个二进制数的大小决定了像素的灰度级别，数比较大的对应的像素比较亮。数字稍微小一点，像素就稍微暗一点。后面的也是一样。
</p>


<figure id="org669af6b">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241118_235105.png" alt="img_20241118_235105.png" width="90%">

</figure>


<p>
现在的显示器可以显示彩色，这些显示器的每个像素是由红、绿、蓝三原色组成。每个颜色还有 256 级的深度，也就是颜色的深浅，或者专业的说是饱和度。
</p>

<p>
因为每个颜色特别小，那么三种不同深浅的颜色就会合成一个具有特定颜色的像素，这就是色彩混合的原理。
</p>

<p>
上图中
</p>
<ul class="org-ul">
<li>左侧是早期的阴极射线管显示器的像素组成，它由三个原色组成，共同组成一个像素，每个像素是由三个原色，由红、绿、蓝三个原色组成。每个原色的成分都是圆的，这个圆点是由电子数来控制的，所以打成一个圆点。</li>
<li>右侧是现代的液晶显示器的像素。每个原色是长方形的，因为每个液晶分子是长方形的。这样的话这三个长方形的原色就组成了一个液晶显示器的像素。</li>
</ul>

<p>
因为每个像素是由三种原色组成，而且每一种原色有 256 级的饱和度，所以在显存里每个像素需要三个字节，分别对应于红、绿、蓝三种颜色。每一个字节所表示的数字的大小就是各自原色的饱和度。
</p>

<div class="org-src-container">
<pre class="src src-sh">11111111 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;1&#20010;&#23383;&#33410;&#23545;&#24212;&#32418;&#20687;&#32032;&#65292;&#27599;&#20010;&#23383;&#33410;&#30340;&#22823;&#23567;&#23601;&#20182;&#20204;&#21508;&#33258;&#21407;&#33394;&#30340;&#39281;&#21644;&#24230;</span>
11111111 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;2&#20010;&#23383;&#33410;&#23545;&#24212;&#34013;&#20687;&#32032;</span>
11111111 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;3&#20010;&#23383;&#33410;&#23545;&#24212;&#32511;&#20687;&#32032;</span>
</pre>
</div>

<p>
比如在这里这三个字节共同表示一个像素。那么每个字节的大小就是红、绿、蓝三原色的饱和度。第一个字节它对应于红像素。第二个字节对应有绿像素。第三个字节它对应于蓝像素。那么每个字节的大小就是它们各自原色的饱和度。这样的话因为三种颜色的饱和度不一样，它们共同组成了一个具有特定颜色的像素。
</p>


<figure id="org3033af1">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241118_235754.png" alt="img_20241118_235754.png" width="90%">

</figure>

<p>
显然，不管你想显示什么东西，是文字还是图片，都必须小心细致的组织显存的内容，安排每个像素。不管是显示图片还是显示文字，对于显示器来说没有什么不同，因为所有的内容都是由像素组成，区别仅仅在于这些像素组成的是什么。有时候人们会说显示的是一棵树，有时候人们会说显示的是一个字母h。如果是要显示图片，这是必须要做的工作，必须要安排每一个像素。但是如果只是显示文字，这样做就太过于麻烦了，因为文字的数量是有限的，不像图片那样千变万化。
</p>

<p>
那么有没有一种方法可以简化文本的显示呢？这答案是可以的。答案是有的，工程师们将显卡的工作模式分成两种, 一种是文本模式，一种是图像模式，而且它们的显存也是分开的，有文本模式下的显存和图像模式下的显存。
</p>
<ul class="org-ul">
<li>在文本模式下显存的内容是字符的代码。</li>
<li>在图像模式下显存的内容是像素的颜色，就像一个二进制数，既可以是一个普通的数，也可以代表一条处理器指令一样，每个字符也可以表示成一个数字。</li>
</ul>

<p>
比如十六进制数字 4C 就代表字符l，那么这个数就是字符 l 的代码，或者说字符编码。如图所示，我们可以将字符的编码放到显存里。比如在这里我们依次存放了字符h、字符 e 和 字符l的代码，或者说编码。
</p>

<p>
在显卡上有字符发声器，它可以根据字符的编码来控制屏幕上的像素，使它们共同组成字符的轮廓。比如说当字符发声器接到字符 h 的编码的时候，那么就将它就控制一部分像素，将它显示成字符 h 的轮廓，当它接到字符 e 的编码的时候，就控制一部分像素将它显示成字符 e 的轮廓。
</p>


<p>
为了给出要显示的字符，处理器需要访问显存，把字符的编码写进去。然而显存是位于显卡上的，访问显存需要和显卡这个外围设备打交道，同时多一道手续自然是不好的，这当中最重要的考量是速度和效率。
</p>

<p>
为了实现一些快速的游戏动画效果，或者是播放高码率的电影，不直接访问显存是办不到的。为此，计算机系统的设计者们决定把显存映射到处理器可以直接访问的地址空间里，也就是内存空间里。
</p>


<p>
<b>B8000 一直到BFFFF是留给显卡的</b>
</p>


<figure id="orgfe2623d">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241119_000336.png" alt="img_20241119_000336.png" width="90%">

</figure>

<p>
如图所示，我们知道 8086 可以访问一兆字节的内存这一部分，其中从地址 00000 开始到 A0000 结束的这一部分是常规的内存，是由内存条来提供的。从 F0000 到 FFFFF 之间的这一部分属于 ROM BIOS，它是由主板上的一个芯片来提供，也就是ROM BIOS 芯片。那么这样一来，中间还有一个 320 千字节的空洞，它的地址范围是 A0000一直到F0000，传统上这一段地址空间是由特定的外围设备来提供，其中就包括显卡，因为显示功能对于现代计算机来说实在是太重要了。
</p>

<p>
由于历史的原因，所有在个人计算机上使用的显卡在家电自检之后都会把自己初始化到 80 乘以 25 的文本模式。在这一种模式下，屏幕上可以显示 25 行，每行 80 个字符，所以叫做 80 乘以 25 的文本模式。那么这样的话，每屏总共可以显示 2, 000 个字符。所以一直以来，从地址 B8000一直到BFFFF的这一部分空间是留给显卡的，是由显卡来提供的，是将显卡上的显存文本模式的显存映射过来的，用来显示文本。这一段空间足以用来保存 2, 000 个字符以及它们的属性。
</p>
</div>
</div>
<div id="outline-container-h:c44f1803-2b5b-451c-b92a-4dfdb79a383e" class="outline-3">
<h3 id="h:c44f1803-2b5b-451c-b92a-4dfdb79a383e">准备访问文本模式下的显存</h3>
<div class="outline-text-3" id="text-h:c44f1803-2b5b-451c-b92a-4dfdb79a383e">
<p>
文本模式下的显卡被映射到处理器的内存空间B8000到BFFFF，共320kB。为了访问显存也要使用逻辑地址。
</p>

<div class="org-src-container">
<pre class="src src-sh">BFFFF   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36923;&#36753;&#22320;&#22336; B800:7FFF</span>
.....
B8000 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36923;&#36753;&#22320;&#22336; B800:0000</span>
</pre>
</div>

<p>
这一段内存可以看成为段地址为B800，偏移地址从0延伸到7FFF的区域，320千字节。
</p>

<p>
确定目标就可以编写程序了。
</p>

<p>
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #b22222;">; </span><span style="color: #b22222;">&#20026;&#35775;&#38382;&#25991;&#26412;&#27169;&#24335;&#19979;&#30340;&#26174;&#23384;&#20570;&#20934;&#22791;&#24037;&#20316;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ax</span>, 0xb800  <span style="color: #b22222;">; </span><span style="color: #b22222;">&#25226;&#27573;&#22320;&#22336;0xb800&#20256;&#36865;&#32473;&#23492;&#23384;&#22120;AX</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ds</span>, ax   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#23492;&#23384;&#22120;AX&#20013;&#30340;&#20869;&#23481;&#20256;&#36865;&#32473;&#25968;&#25454;&#27573;&#23492;&#23384;&#22120;DS</span>
</pre>
</div>

<p>
访问数据要使用数据段寄存器DS，在intel中不允许让立即数传送到数据段寄存器。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">mov ds, 0xb800 #intel&#22788;&#29702;&#22120;&#65292;&#19981;&#23384;&#22312;&#36825;&#26679;&#30340;&#25351;&#20196;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#20801;&#35768;&#22914;&#19979;&#25351;&#20196;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">mov &#27573;&#23492;&#23384;&#22120;, &#36890;&#29992;&#23492;&#23384;&#22120;</span>
mov ds, ax
mov ds, bx
mov ds, cx

<span style="color: #b22222;">#</span><span style="color: #b22222;">mov &#27573;&#23492;&#23384;&#22120;, [&#20869;&#23384;&#22320;&#22336;]</span>
mov es, [0x6C]
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4e39ca44-3162-4848-961e-f8f93bf9d786" class="outline-3">
<h3 id="h:4e39ca44-3162-4848-961e-f8f93bf9d786">字符的编码和显示属性</h3>
<div class="outline-text-3" id="text-h:4e39ca44-3162-4848-961e-f8f93bf9d786">
<p>
通信的俩端都使用相同的字符编码方案才能正确的显示内容。
</p>

<pre class="example" id="orgf810ca8">
我们知道文字的信息是以数字的形式存储在计算机里。那么用哪个数字代表哪个字符呢？

必须要制定一个全球都认可的编码方案和编码标准，否则设备之间的文字交流将无法实现。

必须完成字符的收集和整理工作，使之形成一个字符的清单或者成为字符集。计算机
发展的早期字符是的制定是小范围的事，那时大型机是主流。为了使用大型机，需要
使用终端通过电缆和电话线与主机相连。

那个时候的终端都是电传打字机，少数带有显示器，电传打字机带有键盘可以向主机
发送命令，主机将处理结果送回终端。为了在主机和终端之间通信，有个双方都能理解
的码表，这就是早期的字符集和编码方式。

这个字符集用于在主机和终端之间传送控制命令和文字信息。最著名的是IBM公司的码表，
1967年 ASCII码.
</pre>

<p>
ASCII字符集，共128个字符。 控制字符用来控制电传打字机的动作，如确认、响铃、查询、同步、回车、换行等。
</p>

<p>
ASCII字符集用代码点得到字符编码的实例
</p>

<p>
现今绝大数字符集都兼容ASCII字符集。
</p>

<p>
<b>字符的编码</b>
</p>

<p>
ASCII码对照表: <a href="https://toolhelper.cn/Encoding/ASCII">https://toolhelper.cn/Encoding/ASCII</a>
</p>
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/ASCII">https://en.wikipedia.org/wiki/ASCII</a></li>
</ul>


<!-- This HTML table template is generated by emacs 31.0.50 -->
<table border="1">
  <tr>
    <td colspan="17" align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ASCII&nbsp;(1977/1986)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;9&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;1&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;2&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;4&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;5&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;6&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;7&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;8&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;9&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;A&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;B&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;C&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;D&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;E&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;F&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;0x&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;NUL&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;SOH&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;STX&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;ETX&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;EOT&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;ENQ&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;ACK&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;BEL&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;BS&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;HT&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;LF&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;VT&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;FF&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;CR&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;SO&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;SI&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;1x&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;DLE&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;DC1&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;DC2&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;DC3&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;DC4&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;NAK&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;SYN&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;ETB&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;CAN&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;EM&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;SUB&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;ESC&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;FS&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;GS&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;RS&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;US&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;2x&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;SP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;!&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;"&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;#&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;$&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;%&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;'&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;(&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;)&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;*&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;+&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;,&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;-&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;.&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;/&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;3x&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;1&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;2&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;4&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;5&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;6&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;7&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;8&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;9&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;:&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;<&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;=&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;>&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;?&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;4x&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;A&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;B&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;C&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;D&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;E&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;F&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;G&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;H&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;I&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;J&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;K&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;L&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;M&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;N&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;O&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;5x&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;P&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;Q&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;R&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;S&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;T&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;U&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;V&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;W&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;X&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;Y&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;Z&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;[&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;\&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;]&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;^&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;_&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;6x&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;a&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;b&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;c&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;d&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;e&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;f&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;g&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;h&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;i&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;j&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;k&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;l&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;m&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;n&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;o&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;&nbsp;7x&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;q&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;r&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;s&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;t&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;u&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;v&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;w&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;x&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;y&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;z&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;{&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;|&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;}&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;~&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;DEL&nbsp;
    </td>
  </tr>
  <tr>
    <td colspan="17" align="left" valign="top">
      Changed&nbsp;or&nbsp;added&nbsp;in&nbsp;1963&nbsp;version&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
  <tr>
    <td colspan="17" align="left" valign="top">
      Changed&nbsp;in&nbsp;both&nbsp;1963&nbsp;version&nbsp;and&nbsp;1965&nbsp;draft&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
  </tr>
</table>


<div class="org-src-container">
<pre class="src src-sh">vim &#20013;&#25353;ga

man ascii <span style="color: #b22222;">#</span><span style="color: #b22222;">man-pages&#21253;</span>
   &#34920;&#26684;
       &#20026;&#26041;&#20415;&#36215;&#35265;&#65292;&#25105;&#20204;&#32473;&#20986;&#20102;&#26356;&#32039;&#20945;&#30340;&#21313;&#20845;&#36827;&#21046;&#21644;&#21313;&#36827;&#21046;&#34920;&#26684;&#12290;

          2 3 4 5 6 7       30 40 50 60 70 80 90 100 110 120
        -------------      ---------------------------------
       0:   0 @ P <span style="color: #ff00ff;">` p     0:    (  2  &lt;  F  P  Z  d   n   x</span>
<span style="color: #ff00ff;">       1: ! 1 A Q a q     1:    )  3  =  G  Q  [  e   o   y</span>
<span style="color: #ff00ff;">       2: " 2 B R b r     2:    *  4  &gt;  H  R  \  f   p   z</span>
<span style="color: #ff00ff;">       3: # 3 C S c s     3: !  +  5  ?  I  S  ]  g   q   {</span>
<span style="color: #ff00ff;">       4: $ 4 D T d t     4: "  ,  6  @  J  T  ^  h   r   |</span>
<span style="color: #ff00ff;">       5: % 5 E U e u     5: #  -  7  A  K  U  _  i   s   }</span>
<span style="color: #ff00ff;">       6: &amp; 6 F V f v     6: $  .  8  B  L  V  `</span>  j   t   ~
       7: &#180; 7 G W g w     7: %  /  9  C  M  W  a  k   u  DEL
       8: ( 8 H X h x     8: &amp;  0  :  D  N  X  b  l   v
       9: ) 9 I Y i y     9: &#180;  1  ;  E  O  Y  c  m   w
       A: * : J Z j z
       B: + ; K [ k {
       C: , &lt; L <span style="color: #8b2252;">\ </span>l |
       D: - = M ] m }
       E: . &gt; N ^ n ~
       F: / ? O _ o DEL
</pre>
</div>

<p>
如果给每个字符按顺序编号，从16进制00到7F，每个字符的编码就是它在字符集中的位置编号
</p>
<pre class="example" id="org5451b22">
20 空格
21 字符!
30 数字字符0
3F 问号
</pre>


<p>
<b>字符编码、显存和显示器之间的关系</b>
</p>

<p>
屏幕上的每个字符对应着显存中的2个连续字节。
</p>
<ul class="org-ul">
<li>第1个字节为屏幕的ascii编码</li>
<li>第2个字节为字符的属性，包括字符的颜色、前景色和底色(也就是背景色)。</li>
</ul>

<p>
范例1：
</p>


<figure id="org1a442fb">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241121_090154.png" alt="img_20241121_090154.png" width="90%">

</figure>

<p>
例如上图中，前2个字节对应屏幕左上角第1个字符位置。后俩个字节对应着屏幕第2个显示字符的位置。后面以此类推。
在显存中最后2个字节对应着屏幕右下角最后一个字符的位置。
</p>

<p>
范例2：
</p>


<figure id="orgc35194e">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241121_090856.png" alt="img_20241121_090856.png" width="90%">

</figure>

<p>
例如上图中，从显存的起始处理存放了一些字符的编码和属性。显存的开始位置逻辑地址是B800:0000，即段地址是
B800，偏移地址是0。
</p>
<ul class="org-ul">
<li>第1个字节存放的是字符h的编码，16进制的48</li>
<li>第2个字节存放的是字符的显示属性，16进制的07</li>
</ul>

<p>
这俩个字节就对应于屏幕上的第1个字符。从偏移地址为2的地方存放的是字符e的编码，16进制的65，它的第2个字节
存放的是它的显示属性，16进制的07。这俩个字节共同组成了屏幕上第2个字符e。以此类推。
</p>

<p>
<b>字符的显示属性</b>
</p>

<p>
字符编码前面已经了解过，现在我们重点讲一下字符的显示属性。
</p>

<p>
所有的属性都是1个字节长，分成2部分，低4位定义的是前景色，高4位定义的是背景色。
</p>

<p>
色彩主要是以由背景色的RGB和前景色的RGB来决定。我们知道所有颜色可以由红、绿、蓝
来调配，所以背景色有RGB这3原色，前景色也有RGB这3原色。除了RGB这3原色外，背景色
中有K位，K位是闪烁位，当K不等于0时背景不闪烁；K为1是背景闪烁。在前景色中有I位，
I位是亮度位，当I为0时是正常亮度，当I为1时高亮。
</p>

<p>
对于前景色来说亮度不同会影响颜色的效果。
</p>

<p>
<b>属性字节的组合</b>
</p>


<figure id="org233c828">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241121_092740.png" alt="img_20241121_092740.png" width="90%">

</figure>

<table>
<caption class="t-above"><span class="table-number">Table 3:</span> 80X25 文本模式下的颜色表</caption>

<colgroup>
<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">R</th>
<th scope="col" class="org-right">G</th>
<th scope="col" class="org-right">B</th>
<th scope="col" class="org-left">背景色</th>
<th scope="col" class="org-left">前景色</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>

<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-left">K=0不闪烁，K=1闪烁</th>
<th scope="col" class="org-left">I=0</th>
<th scope="col" class="org-left">I=1</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-left">黑</td>
<td class="org-left">黑</td>
<td class="org-left">灰</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-left">蓝</td>
<td class="org-left">蓝</td>
<td class="org-left">浅蓝</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-left">绿</td>
<td class="org-left">绿</td>
<td class="org-left">浅绿</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-left">青</td>
<td class="org-left">青</td>
<td class="org-left">浅青</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-left">红</td>
<td class="org-left">红</td>
<td class="org-left">浅红</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-left">品(洋)红</td>
<td class="org-left">品(洋)红</td>
<td class="org-left">浅品(洋)红</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-left">棕</td>
<td class="org-left">棕</td>
<td class="org-left">黄</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-left">白</td>
<td class="org-left">白</td>
<td class="org-left">亮白</td>
</tr>
</tbody>
</table>

<p>
上图是属性字节的搭配。
</p>

<div class="org-src-container">
<pre class="src src-sh">0x07 0000 0111  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#39640;4&#20301;0000&#26159;&#32972;&#26223;&#33394;&#19981;&#38378;&#28865;&#40657;&#33394;&#65292;&#20302;4&#20301;0111&#26159;&#21069;&#26223;&#33394;&#30333;&#33394;</span>

&#40657;&#24213;&#30333;&#23383;&#19981;&#38378;&#28865;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d5b4358c-4e53-448f-b135-cd972320249e" class="outline-3">
<h3 id="h:d5b4358c-4e53-448f-b135-cd972320249e">文本模式下的显存操作</h3>
<div class="outline-text-3" id="text-h:d5b4358c-4e53-448f-b135-cd972320249e">
<p>
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ax</span>, 0xb800
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ds</span>, ax

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x00], 0x41  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23383;&#31526;A&#30340;ASCII&#32534;&#30721;&#12290;&#25351;&#20196;&#30340;&#24847;&#24605;&#26159;&#25226;A&#30340;&#32534;&#30721;&#20256;&#36865;&#21040;B8000&#22788;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x01], 0x04  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#40657;&#24213;&#32418;&#23383;&#65292;&#26080;&#38378;&#28865;</span>

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x02], 's'   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#21516;&#20110; mov [0x02], 0x73  , &#27719;&#32534;&#35821;&#35328;&#32534;&#35793;&#22120;&#20250;&#25226; s &#36716;&#25442;&#25104;&#23383;&#31526;&#30340;&#32534;&#30721;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x03], 0x04

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x04], 's'
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x05], 0x04

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x06], 'e'
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x07], 0x04

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x08], 'm'
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x09], 0x04

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x0a], 'b'
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x0b], 0x04

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x0c], 'l'
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x0d], 0x04

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x0e], 'y'
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x0f], 0x04

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x10], '.'
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x11], 0x04
</pre>
</div>

<p>
为了访问内存单元，需要给出段地址和偏移地址。这条指令 <code>mov byte [0x00], 0x41</code> 偏移地址是0x00，
段地址一般情况下，如果没有附加任何指示，那么段地址默认是在段寄存DS中。这里DS是0xb800
</p>

<p>
当这条指令执行时，将段寄存器DS中的内容做为段地址。具体操作是处理器把段寄存器DS中的内容
B800左移4位形成B8000，然后加指令中的偏移地址0，形成物理地址B8000，从这个位置开始的2个字节
单元对应屏幕左上角第1个字节。
</p>

<p>
在这条指令中 <code>0x41</code> 的长度不明确，可以认为它是一个字节长，也可以认为是2个字节长。
</p>

<p>
内存操作数部分 <code>[0x00]</code> 只是用来指定起始的偏移地址没有更多的信息，这个起始地址可以是1个字节
的起始地址，也可以是一个字的起始地址。
</p>

<p>
为此必须使用关键字byte来修饰目的操作数。
</p>

<div class="org-src-container">
<pre class="src src-sh">mov byte [0x00], 0x41 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20559;&#31227;&#22320;&#22336;0x00&#26159;&#19968;&#20010;&#23383;&#33410;&#21333;&#20803;&#30340;&#20559;&#31227;&#22320;&#22336;&#65292;&#26412;&#27425;&#20256;&#36865;&#26159;&#20197;&#23383;&#33410;&#26041;&#24335;&#36827;&#34892;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#20294;&#30446;&#30340;&#25805;&#20316;&#25968;0x00&#34987;&#25351;&#23450;&#26159;byte&#65292;&#37027;&#20040;0x41&#20063;&#26159;&#19968;&#20010;&#23383;&#33410;&#38271;</span>

mov ax, 0xb800 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#30340;&#25805;&#20316;&#25968;ax&#26159;16&#20301;&#38271;&#24230;&#65292;&#22240;&#27492;&#28304;&#25805;&#25968;0xb800&#26159;&#24517;&#39035;&#26159;16&#20301;&#30340;&#38271;&#24230;&#65292;&#24182;&#19981;&#38656;&#35201;&#25351;&#26126;&#23485;&#24230;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#38754;2&#26465;&#25351;&#20196;&#21516;&#26679;&#19981;&#29992;&#25351;&#26126;&#23485;&#24230;</span>
mov [0x00], al    ;&#25353;&#23383;&#33410;&#25805;&#20316;
mov ax, [0x02]   ;&#25353;&#23383;&#25805;&#20316;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:932777fe-62ef-4e0a-bcba-47b96ad548df" class="outline-3">
<h3 id="h:932777fe-62ef-4e0a-bcba-47b96ad548df">MOV指令的形式和机器码</h3>
<div class="outline-text-3" id="text-h:932777fe-62ef-4e0a-bcba-47b96ad548df">
<blockquote>
<p>
针对mov指令做个总结
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-sh">MOV  &#30446;&#30340;&#25805;&#20316;&#25968;,  &#28304;&#25805;&#20316;&#25968;

&#30446;&#30340;&#25805;&#20316;&#25968;&#30456;&#24403;&#20110;&#23481;&#22120;&#65292;&#21487;&#20197;&#26159;&#65306;&#23492;&#23384;&#22120;&#12289;&#20869;&#23384;&#22320;&#22336;
&#28304;&#25805;&#20316;&#25968;&#21487;&#20197;&#26159;&#65306;&#23492;&#23384;&#22120;&#12289;&#20869;&#23384;&#22320;&#22336;&#12289;&#31435;&#21363;&#25968;

&#20256;&#36865;&#25351;&#20196;&#21482;&#20250;&#25913;&#21464;&#30446;&#30340;&#25805;&#20316;&#25968;&#30340;&#20869;&#23481;&#65292;&#19981;&#20250;&#25913;&#21464;&#28304;&#25805;&#20316;&#25968;&#20869;&#23481;
</pre>
</div>

<p>
范例： mov指令在寄存器之间传送数据，但是寄存器的宽度必须相同
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ah</span>, bh
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ax</span>, dx

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ax</span>, bl <span style="color: #b22222;">;</span><span style="color: #b22222;">&#25253;&#38169;&#65292;&#23492;&#23384;&#22120;&#30340;&#23485;&#24230;&#24517;&#39035;&#30456;&#21516;</span>
</pre>
</div>

<p>
范例：mov指令可以将内存中数据传送到寄存器
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">al</span>, [0xf000] <span style="color: #b22222;">;</span><span style="color: #b22222;">&#25226;&#20869;&#23384;&#37324;&#20559;&#31227;&#22320;&#22336;&#20026;f000&#30340;&#25968;&#25454;&#20256;&#36865;&#21040;&#23492;&#23384;&#22120;al&#20013;&#65292;&#22312;&#20256;&#36865;&#26102;&#27573;&#22320;&#22336;&#22312;&#27573;&#23492;&#23384;&#22120;DS&#20013;&#12290;</span>
        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#30446;&#30340;&#25805;&#20316;&#25968;&#26159;8&#20301;&#30340;&#23492;&#23384;&#22120;al&#65292;&#25152;&#20197;&#20256;&#36865;&#26159;&#20197;&#23383;&#33410;&#20026;&#21333;&#20301;&#36827;&#34892;&#30340;&#65292;&#26159;&#20174;&#20559;&#31227;&#22320;&#22336;f000&#22788;&#21462;&#19968;&#20010;&#23383;&#33410;&#20256;&#36865;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">bx</span>, [0x08]
</pre>
</div>

<p>
范例：mov指令可以将一个立即数传送到寄存器
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">al</span>, 0x07  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#31435;&#21363;&#25968;0x07&#20256;&#36865;&#21040;&#23492;&#23384;&#22120;al&#12290;&#22240;&#20026;al&#26159;8&#20301;&#23492;&#23384;&#22120;&#65292;&#22240;&#27492;0x07&#30340;&#38271;&#24230;&#34987;&#35270;&#20026;&#19968;&#20010;&#23383;&#33410;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">bx</span>, 0x08
</pre>
</div>

<p>
范例：mov指令可以将指定的寄存器内容传送到指定的内存地址处，传送时数据宽度取决于寄存器的宽度
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mov</span> [0x0c], dx  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#23492;&#23384;&#22120;dx&#20013;&#30340;&#20869;&#23481;&#20256;&#36865;&#21040;&#20869;&#23384;&#20013;&#65292;&#20559;&#31227;&#22320;&#22336;&#20026;0x0c&#22788;&#12290;&#22240;&#20026;dx&#26159;16&#20301;&#30340;&#65292;</span>
        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#22240;&#27492;&#20256;&#36865;&#30340;&#25968;&#25454;&#38271;&#24230;&#20063;&#26159;16&#20301;&#30340;&#65292;&#23558;&#21344;&#29992;&#20559;&#31227;&#22320;&#22336;0x0c&#22788;2&#20010;&#36830;&#32493;&#30340;&#26368;&#23567;&#30340;&#21333;&#20803;&#12290;</span>
<span style="color: #0000ff;">mov</span> [0x2000], ah
</pre>
</div>



<figure id="org4b62563">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241121_233211.png" alt="img_20241121_233211.png" width="90%">

</figure>

<p>
范例：mov指令可以把立即数传送到指定的内存地址处，使用关键字来修饰地址操作数
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x02], 0xe9 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#23383;&#33410;&#38271;&#24230;&#30340;&#31435;&#21363;&#25968;0xe9&#20256;&#36865;&#21040;&#36215;&#22987;&#22320;&#22336;&#20026;0x02&#23383;&#33410;&#21333;&#20803;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x06], 0x3c <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#19968;&#20010;&#23383;&#38271;&#24230;&#30340;&#31435;&#21363;&#25968;0x3c&#20256;&#36865;&#21040;&#20869;&#23384;&#20013;&#20559;&#31227;&#22320;&#22336;&#20026;0x06&#22788;&#36830;&#32493;&#30340;2&#20010;&#26368;&#23567;&#21333;&#20803;</span>
</pre>
</div>

<p>
范例：mov指令的目的操作数不允许是立即数，并且目的操作数和源操作数不能同时为内存单元
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #b22222;">; </span><span style="color: #b22222;">mov 0x07, al  ; &#30446;&#30340;&#25805;&#20316;&#25968;&#19981;&#20801;&#35768;&#26159;&#31435;&#21363;&#25968;</span>
<span style="color: #b22222;">; </span><span style="color: #b22222;">mov [0x01], [0x02] ;&#30446;&#30340;&#25805;&#20316;&#25968;&#21644;&#28304;&#25805;&#20316;&#25968;&#19981;&#33021;&#21516;&#26102;&#20026;&#20869;&#23384;&#21333;&#20803;</span>

<span style="color: #0000ff;">&#21487;&#20197;&#29992;2&#20010;&#25351;&#20196;&#20998;&#38454;&#27573;&#23454;&#29616;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ax</span>, [0x02]
<span style="color: #0000ff;">mov</span> [0x01], ax
</pre>
</div>

<p>
指令指针寄存器IP是在指令中不可直接访问的，不能出现在任何指令中，而只能间接地修改
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #b22222;">;</span><span style="color: #b22222;">mov ip, 0xf000 ; &#38750;&#27861;&#30340;&#65292;&#25351;&#20196;&#25351;&#38024;&#23492;&#23384;&#22120;IP&#19981;&#33021;&#22312;&#25351;&#20196;&#20013;&#30452;&#25509;&#35775;&#38382;</span>

<span style="color: #b22222;">;</span><span style="color: #b22222;">&#22914;&#26524;&#30446;&#30340;&#25805;&#20316;&#26159;&#27573;&#23492;&#23384;&#22120;&#65292;&#28304;&#25805;&#20316;&#25968;&#24517;&#39035;&#26159;&#36890;&#29992;&#23492;&#23384;&#22120;&#25110;&#32773;&#20869;&#23384;&#22320;&#22336;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ds</span>, ax
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">es</span>, [0x3002]
</pre>
</div>

<p>
axam.asm的机器码、操作码是不一样的，观察编译后的mov指令
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#35793;&#65292;&#26426;&#22120;&#30721;&#30475;&#26469;&#19981;&#22815;&#30452;&#35266;</span>
D:\project\assemblyprojs\assembly&gt;nasm  exam.asm -f bin -o exam.bin

<span style="color: #b22222;">#</span><span style="color: #b22222;">-l &#36873;&#39033;&#29983;&#25104;&#21015;&#34920;&#25991;&#20214;&#65292;&#21253;&#21547;&#20102;&#27719;&#32534;&#25351;&#20196;&#21644;&#26426;&#22120;&#30721;</span>

D:\project\assemblyprojs&gt;nasm exam.asm -l exam.lst

D:\project\assemblyprojs&gt;type exam.lst
   &#31532;1&#21015;&#20026;&#34892;&#21495;&#65307; &#31532;2&#21015;&#20026;&#27599;&#26465;&#25351;&#20196;&#30456;&#23545;&#25991;&#20214;&#36215;&#22987;&#22788;&#30340;&#20559;&#31227;&#37327;(&#27719;&#32534;&#22320;&#22336;&#65292;&#31243;&#24207;&#27719;&#32534;&#38454;&#27573;&#25152;&#30830;&#35748;&#30340;&#22320;&#22336;)&#65307;
   &#31532;3&#21015;&#20026;&#27599;&#26465;&#25351;&#20196;&#30340;&#26426;&#22120;&#30721;&#65307;&#31532;4&#21015;&#20026;&#27599;&#26465;&#25351;&#20196;&#30340;&#27719;&#32534;&#35821;&#35328;&#26684;&#24335;&#65307;&#31532;5&#21015;&#20026;&#27880;&#37322;
     1 00000000 B800B8                  mov ax, 0xb800
     2 00000003 8ED8                    mov ds, ax
     3
     4 00000005 C606000041              mov byte [0x00], 0x41  ;&#23383;&#31526;A&#30340;ASCII&#32534;&#30721;. &#25351;&#20196;&#30340;&#24847;&#24605;&#26159;&#25226;A&#30340;&#32534;&#30721;&#20256;&#36865;&#21040;B8000&#22788;
     5 0000000A C606010004              mov byte [0x01], 0x04  ;&#40657;&#24213;&#32418;&#23383;&#65292;&#26080;&#38378;&#28865;
     6
     7 0000000F C606020073              mov byte [0x02], <span style="color: #8b2252;">'s'</span>   ;&#31561;&#21516;&#20110; mov [0x02], 0x73
     8 00000014 C606030004              mov byte [0x03], 0x04
     9
    10 00000019 C606040073              mov byte [0x04], <span style="color: #8b2252;">'s'</span>
    11 0000001E C606050004              mov byte [0x05], 0x04
    12
    13 00000023 C606060065              mov byte [0x06], <span style="color: #8b2252;">'e'</span>
    14 00000028 C606070004              mov byte [0x07], 0x04
    15
    16 0000002D C60608006D              mov byte [0x08], <span style="color: #8b2252;">'m'</span>
    17 00000032 C606090004              mov byte [0x09], 0x04
    18
    19 00000037 C6060A0062              mov byte [0x0a], <span style="color: #8b2252;">'b'</span>
    20 0000003C C6060B0004              mov byte [0x0b], 0x04
    21
    22 00000041 C6060C006C              mov byte [0x0c], <span style="color: #8b2252;">'l'</span>
    23 00000046 C6060D0004              mov byte [0x0d], 0x04
    24
    25 0000004B C6060E0079              mov byte [0x0e], <span style="color: #8b2252;">'y'</span>
    26 00000050 C6060F0004              mov byte [0x0f], 0x04
    27
    28 00000055 C60610002E              mov byte [0x10], <span style="color: #8b2252;">'.'</span>
    29 0000005A C606110004              mov byte [0x11], 0x04
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0be557ee-4917-40c1-b34b-870ca94f3bec" class="outline-3">
<h3 id="h:0be557ee-4917-40c1-b34b-870ca94f3bec">列表文件的创建和使用</h3>
<div class="outline-text-3" id="text-h:0be557ee-4917-40c1-b34b-870ca94f3bec">
<blockquote>
<p>
完善主引导扇区程序
</p>
</blockquote>

<p>
我们知道主引导扇区是512个字节，其中最后2个字节是主引导扇区的有效标志55和AA。
</p>

<p>
要填充的字节数为512字节减去55AA的2个字节，再减去程序的字节数。
</p>

<p>
在用nasm生成的列表文件里，有每一条指令的汇编地址，它是这一条汇编指令相对于程序开头处的偏移量，
通过偏移量就可以算出程序代码有多少字节。
</p>

<div class="org-src-container">
<pre class="src src-sh">nasm exam.asm -f bin -o exam.bin -l exam.lst

cat exam.lst
     1 00000000 B800B8                  mov ax, 0xb800
     2 00000003 8ED8                    mov ds, ax
     3
     4 00000005 C606000041              mov byte [0x00], 0x41  ;&#23383;&#31526;A&#30340;ASCII&#32534;&#30721;. &#25351;&#20196;&#30340;&#24847;&#24605;&#26159;&#25226;A&#30340;&#32534;&#30721;&#20256;&#36865;&#21040;B8000&#22788;
     5 0000000A C606010004              mov byte [0x01], 0x04  ;&#40657;&#24213;&#32418;&#23383;&#65292;&#26080;&#38378;&#28865;
     6
     7 0000000F C606020073              mov byte [0x02], <span style="color: #8b2252;">'s'</span>   ;&#31561;&#21516;&#20110; mov [0x02], 0x73
     8 00000014 C606030004              mov byte [0x03], 0x04
     9
    10 00000019 C606040073              mov byte [0x04], <span style="color: #8b2252;">'s'</span>
    11 0000001E C606050004              mov byte [0x05], 0x04
    12
    13 00000023 C606060065              mov byte [0x06], <span style="color: #8b2252;">'e'</span>
    14 00000028 C606070004              mov byte [0x07], 0x04
    15
    16 0000002D C60608006D              mov byte [0x08], <span style="color: #8b2252;">'m'</span>
    17 00000032 C606090004              mov byte [0x09], 0x04
    18
    19 00000037 C6060A0062              mov byte [0x0a], <span style="color: #8b2252;">'b'</span>
    20 0000003C C6060B0004              mov byte [0x0b], 0x04
    21
    22 00000041 C6060C006C              mov byte [0x0c], <span style="color: #8b2252;">'l'</span>
    23 00000046 C6060D0004              mov byte [0x0d], 0x04
    24
    25 0000004B C6060E0079              mov byte [0x0e], <span style="color: #8b2252;">'y'</span>
    26 00000050 C6060F0004              mov byte [0x0f], 0x04
    27
    28 00000055 C60610002E              mov byte [0x10], <span style="color: #8b2252;">'.'</span>
    29 0000005A C606110004              mov byte [0x11], 0x04
    30
    31                                  ;<span style="color: #483d8b;">times</span> 510-? db 0   ; &#35201;&#22635;&#20805;&#30340;&#23383;&#33410;&#25968;&#20026;512&#23383;&#33410;&#20943;&#21435;55AA&#30340;2&#20010;&#23383;&#33410;&#65292; &#20877;&#20943;&#31243;&#24207;&#30340;&#38271;&#24230;&#12290;
    32 0000005F 00&lt;rep 1FEh&gt;            times 510 db 0
    33
    34
    35 0000025D 55AA                    db 0x55, 0xaa ;&#29992;&#19968;&#20010;db&#21487;&#20197;&#23450;&#20041;&#22810;&#20010;&#23383;&#33410;&#65292;&#29992;&#36887;&#21495;&#20998;&#38548;
</pre>
</div>

<p>
我们说过，每一条指令的汇编地址是这条指令相对于文件开始处的偏移量。可以看到程序的长度为5F
</p>

<p>
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ax</span>, 0xb800
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ds</span>, ax

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x00], 0x41  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23383;&#31526;A&#30340;ASCII&#32534;&#30721;. &#25351;&#20196;&#30340;&#24847;&#24605;&#26159;&#25226;A&#30340;&#32534;&#30721;&#20256;&#36865;&#21040;B8000&#22788;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x01], 0x04  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#40657;&#24213;&#32418;&#23383;&#65292;&#26080;&#38378;&#28865;</span>

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x02], 's'   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#21516;&#20110; mov [0x02], 0x73</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x03], 0x04

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x04], 's'
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x05], 0x04

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x06], 'e'
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x07], 0x04

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x08], 'm'
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x09], 0x04

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x0a], 'b'
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x0b], 0x04

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x0c], 'l'
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x0d], 0x04

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x0e], 'y'
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x0f], 0x04

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x10], '.'
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x11], 0x04

<span style="color: #0000ff;">times</span> <span style="color: #a020f0;">510</span>-0x5f db 0   <span style="color: #b22222;">; </span><span style="color: #b22222;">&#35201;&#22635;&#20805;&#30340;&#23383;&#33410;&#25968;&#20026;512&#23383;&#33410;&#20943;&#21435;55AA&#30340;2&#20010;&#23383;&#33410;, &#20877;&#20943;&#31243;&#24207;&#30340;&#38271;&#24230;&#12290;</span>

<span style="color: #0000ff;">db</span> <span style="color: #a020f0;">0x55</span>, 0xaa <span style="color: #b22222;">;</span><span style="color: #b22222;">&#29992;&#19968;&#20010;db&#21487;&#20197;&#23450;&#20041;&#22810;&#20010;&#23383;&#33410;&#65292;&#29992;&#36887;&#21495;&#20998;&#38548;</span>
</pre>
</div>

<p>
编译
</p>
<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm exam.asm -f bin -o exam.bin -l exam.lst

jasper@jasper MINGW64 /d/project/assemblyprojs
$ hexdump.exe  -C exam.bin
00000000  b8 00 b8 8e d8 c6 06 00  00 41 c6 06 01 00 04 c6  |.........A......|
00000010  06 02 00 73 c6 06 03 00  04 c6 06 04 00 73 c6 06  |...s.........s..|
00000020  05 00 04 c6 06 06 00 65  c6 06 07 00 04 c6 06 08  |.......e........|
00000030  00 6d c6 06 09 00 04 c6  06 0a 00 62 c6 06 0b 00  |.m.........b....|
00000040  04 c6 06 0c 00 6c c6 06  0d 00 04 c6 06 0e 00 79  |.....l.........y|
00000050  c6 06 0f 00 04 c6 06 10  00 2e c6 06 11 00 04 00  |................|
00000060  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
000001f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 55 aa  |..............U.|
00000200
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#21040;&#31243;&#24207;&#22823;&#23567;&#27491;&#22909;&#26159;512&#20010;&#23383;&#33410;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7606f861-8e27-42cc-840c-c81d55aaeaf0" class="outline-3">
<h3 id="h:7606f861-8e27-42cc-840c-c81d55aaeaf0">在汇编程序中使用标号</h3>
<div class="outline-text-3" id="text-h:7606f861-8e27-42cc-840c-c81d55aaeaf0">
<blockquote>
<p>
完善主引导扇区程序，了解什么是标号，并使用标号来计算数据和代码的长度
</p>
</blockquote>

<p>
程序的指令长度是可变化的，自己算程序的长度是很麻烦的。
</p>

<p>
在文本编辑器里，汇编语言程序是分行的，每一行包括3个部分
</p>
<ul class="org-ul">
<li>标号：一串文本。通常是以冒号结尾。可选</li>
<li>指令：可选</li>
<li>注释：以分号开始，后面是说明性文字。可选</li>
</ul>

<p>
标号代表离它最近指令的汇编地址。使用标号可以做到真正的一劳永逸。
</p>

<p>
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax, 0xb800
        <span style="color: #a020f0;">mov</span> ds, ax

        <span style="color: #a020f0;">mov</span> byte [0x00], 0x41  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23383;&#31526;A&#30340;ASCII&#32534;&#30721;.&#25351;&#20196;&#30340;&#24847;&#24605;&#26159;&#25226;A&#30340;&#32534;&#30721;&#20256;&#36865;&#21040;B8000&#22788;</span>
        <span style="color: #a020f0;">mov</span> byte [0x01], 0x04  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#40657;&#24213;&#32418;&#23383;&#65292;&#26080;&#38378;&#28865;</span>

        <span style="color: #a020f0;">mov</span> byte [0x02], 's'   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#21516;&#20110; mov [0x02], 0x73</span>
        <span style="color: #a020f0;">mov</span> byte [0x03], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x04], 's'
        <span style="color: #a020f0;">mov</span> byte [0x05], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x06], 'e'
        <span style="color: #a020f0;">mov</span> byte [0x07], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x08], 'm'
        <span style="color: #a020f0;">mov</span> byte [0x09], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0a], 'b'
        <span style="color: #a020f0;">mov</span> byte [0x0b], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0c], 'l'
        <span style="color: #a020f0;">mov</span> byte [0x0d], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0e], 'y'
        <span style="color: #a020f0;">mov</span> byte [0x0f], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x10], '.'
        <span style="color: #a020f0;">mov</span> byte [0x11], 0x04
<span style="color: #0000ff;">current</span>:
        <span style="color: #a020f0;">times</span> 510-(current-start) db 0   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35201;&#22635;&#20805;&#30340;&#23383;&#33410;&#25968;&#20026;512&#23383;&#33410;&#20943;&#21435;55AA&#30340;2&#20010;&#23383;&#33410;, &#20877;&#20943;&#31243;&#24207;&#38271;&#24230;&#12290;</span>

        <span style="color: #a020f0;">db</span> 0x55, 0xaa <span style="color: #b22222;">;</span><span style="color: #b22222;">&#29992;&#19968;&#20010;db&#21487;&#20197;&#23450;&#20041;&#22810;&#20010;&#23383;&#33410;&#65292;&#29992;&#36887;&#21495;&#20998;&#38548;</span>
</pre>
</div>

<p>
编译
</p>
<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm exam.asm -f bin -o exam.bin -l exam.lst

cat exam.lst

     1                                  start:
     2 00000000 B800B8                          mov ax, 0xb800
     3 00000003 8ED8                            mov ds, ax
     4
     5 00000005 C606000041                      mov byte [0x00], 0x41  ;&#23383;&#31526;A&#30340;ASCII&#32534;&#30721;.&#25351;&#20196;&#30340;&#24847;&#24605;&#26159;&#25226;A&#30340;&#32534;&#30721;&#20256;&#36865;&#21040;B8000&#22788;
     6 0000000A C606010004                      mov byte [0x01], 0x04  ;&#40657;&#24213;&#32418;&#23383;&#65292;&#26080;&#38378;&#28865;
     7
     8 0000000F C606020073                      mov byte [0x02], <span style="color: #8b2252;">'s'</span>   ;&#31561;&#21516;&#20110; mov [0x02], 0x73
     9 00000014 C606030004                      mov byte [0x03], 0x04
    10
    11 00000019 C606040073                      mov byte [0x04], <span style="color: #8b2252;">'s'</span>
    12 0000001E C606050004                      mov byte [0x05], 0x04
    13
    14 00000023 C606060065                      mov byte [0x06], <span style="color: #8b2252;">'e'</span>
    15 00000028 C606070004                      mov byte [0x07], 0x04
    16
    17 0000002D C60608006D                      mov byte [0x08], <span style="color: #8b2252;">'m'</span>
    18 00000032 C606090004                      mov byte [0x09], 0x04
    19
    20 00000037 C6060A0062                      mov byte [0x0a], <span style="color: #8b2252;">'b'</span>
    21 0000003C C6060B0004                      mov byte [0x0b], 0x04
    22
    23 00000041 C6060C006C                      mov byte [0x0c], <span style="color: #8b2252;">'l'</span>
    24 00000046 C6060D0004                      mov byte [0x0d], 0x04
    25
    26 0000004B C6060E0079                      mov byte [0x0e], <span style="color: #8b2252;">'y'</span>
    27 00000050 C6060F0004                      mov byte [0x0f], 0x04
    28
    29 00000055 C60610002E                      mov byte [0x10], <span style="color: #8b2252;">'.'</span>
    30 0000005A C606110004                      mov byte [0x11], 0x04
    31                                  current:
    32 0000005F 00&lt;rep 19Fh&gt;                    times 510-(current-start) db 0   ;&#35201;&#22635;&#20805;&#30340;&#23383;&#33410;&#25968;&#20026;512&#23383;&#33410;&#20943;&#21435;55AA&#30340;2&#20010;&#23383;&#33410;, &#20877;&#20943;&#31243;&#24207;&#38271;&#24230;&#12290;
    33
    34 000001FE 55AA                            db 0x55, 0xaa ;&#29992;&#19968;&#20010;db&#21487;&#20197;&#23450;&#20041;&#22810;&#20010;&#23383;&#33410;&#65292;&#29992;&#36887;&#21495;&#20998;&#38548;

jasper@jasper MINGW64 /d/project/assemblyprojs
$ hexdump.exe  -C exam.bin
00000000  b8 00 b8 8e d8 c6 06 00  00 41 c6 06 01 00 04 c6  |.........A......|
00000010  06 02 00 73 c6 06 03 00  04 c6 06 04 00 73 c6 06  |...s.........s..|
00000020  05 00 04 c6 06 06 00 65  c6 06 07 00 04 c6 06 08  |.......e........|
00000030  00 6d c6 06 09 00 04 c6  06 0a 00 62 c6 06 0b 00  |.m.........b....|
00000040  04 c6 06 0c 00 6c c6 06  0d 00 04 c6 06 0e 00 79  |.....l.........y|
00000050  c6 06 0f 00 04 c6 06 10  00 2e c6 06 11 00 04 00  |................|
00000060  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
000001f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 55 aa  |..............U.|
00000200
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d61b96ea-efc8-4120-98d5-d5634d9e6009" class="outline-3">
<h3 id="h:d61b96ea-efc8-4120-98d5-d5634d9e6009">段间直接绝对跳转指令</h3>
<div class="outline-text-3" id="text-h:d61b96ea-efc8-4120-98d5-d5634d9e6009">
<blockquote>
<p>
断续完善主引导扇区程序，并认识段间直接绝对跳转指令
</p>
</blockquote>

<p>
汇编程序是按顺序执行的，当执行到我们写的填充位置就会出现不可预见的问题。写完这些指令后我们的工作就做完了，
我们的任务很简单只要在屏幕上显示完文本Assebly就可以了。
</p>


<p>
想象一下我们的程序是完整的主引导扇区内容。在计算机处理器加电或者复位后，将首先从ROM BIOS中执行，然后把硬盘主引导扇区的内容读到读取物理内存地址7c00处，然后从主引导扇区开始取指令并执行指令。
</p>

<p>
物理地址7c00的逻辑地址可以表示成 0x0000:0x7c00，我们可以执行一段跳转指令重新从7c00处理读取程序代码 <code>jmp 0x0000:0x7c00</code> 。
</p>

<p>
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax, 0xb800
        <span style="color: #a020f0;">mov</span> ds, ax

        <span style="color: #a020f0;">mov</span> byte [0x00], 0x41  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23383;&#31526;A&#30340;ASCII&#32534;&#30721;.&#25351;&#20196;&#30340;&#24847;&#24605;&#26159;&#25226;A&#30340;&#32534;&#30721;&#20256;&#36865;&#21040;B8000&#22788;</span>
        <span style="color: #a020f0;">mov</span> byte [0x01], 0x04  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#40657;&#24213;&#32418;&#23383;&#65292;&#26080;&#38378;&#28865;</span>

        <span style="color: #a020f0;">mov</span> byte [0x02], 's'   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#21516;&#20110; mov [0x02], 0x73</span>
        <span style="color: #a020f0;">mov</span> byte [0x03], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x04], 's'
        <span style="color: #a020f0;">mov</span> byte [0x05], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x06], 'e'
        <span style="color: #a020f0;">mov</span> byte [0x07], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x08], 'm'
        <span style="color: #a020f0;">mov</span> byte [0x09], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0a], 'b'
        <span style="color: #a020f0;">mov</span> byte [0x0b], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0c], 'l'
        <span style="color: #a020f0;">mov</span> byte [0x0d], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0e], 'y'
        <span style="color: #a020f0;">mov</span> byte [0x0f], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x10], '.'
        <span style="color: #a020f0;">mov</span> byte [0x11], 0x04

        <span style="color: #a020f0;">jmp</span> 0x0000:0x7c00 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24490;&#29615;&#20174;&#20027;&#24341;&#23548;&#25159;&#21306;&#36215;&#22987;&#22788;&#35835;&#21462;&#25351;&#20196;&#12290;&#27573;&#38388;&#30452;&#25509;&#32477;&#23545;&#36339;&#36716;&#25351;&#20196;</span>

<span style="color: #0000ff;">current</span>:
        <span style="color: #a020f0;">times</span> 510-(current-start) db 0   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35201;&#22635;&#20805;&#30340;&#23383;&#33410;&#25968;&#20026;512&#23383;&#33410;&#20943;&#21435;55AA&#30340;2&#20010;&#23383;&#33410;, &#20877;&#20943;&#31243;&#24207;&#38271;&#24230;&#12290;</span>

        <span style="color: #a020f0;">db</span> 0x55, 0xaa <span style="color: #b22222;">;</span><span style="color: #b22222;">&#29992;&#19968;&#20010;db&#21487;&#20197;&#23450;&#20041;&#22810;&#20010;&#23383;&#33410;&#65292;&#29992;&#36887;&#21495;&#20998;&#38548;</span>
</pre>
</div>

<p>
这样就组成了段间直接绝对跳转指令。
</p>
<ul class="org-ul">
<li>段间指的是这条指令将跳到另外一个段里执行。段地址0x0000和偏移地址0x7c00。当处理器执行这条
跳转指令时，用指令中给出的段地址修改代码段寄存器CS，用指令中的偏移地址修改指令指针寄存器IP</li>
<li>直接绝对是指跳转的目标位置，也就是段地址0x0000和偏移地址0x7c00是直接在指令中给出的不需要计算的绝对地址。</li>
</ul>

<p>
编译观察
</p>
<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm exam.asm -f bin -o exam.bin -l exam.lst

jasper@jasper MINGW64 /d/project/assemblyprojs
$ hexdump.exe -C exam.bin
00000000  b8 00 b8 8e d8 c6 06 00  00 41 c6 06 01 00 04 c6  |.........A......|
00000010  06 02 00 73 c6 06 03 00  04 c6 06 04 00 73 c6 06  |...s.........s..|
00000020  05 00 04 c6 06 06 00 65  c6 06 07 00 04 c6 06 08  |.......e........|
00000030  00 6d c6 06 09 00 04 c6  06 0a 00 62 c6 06 0b 00  |.m.........b....|
00000040  04 c6 06 0c 00 6c c6 06  0d 00 04 c6 06 0e 00 79  |.....l.........y|
00000050  c6 06 0f 00 04 c6 06 10  00 2e c6 06 11 00 04 ea  |................|   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36339;&#36716;&#25351;&#20196;&#65292;EA&#26159;&#25805;&#20316;&#30721;</span>
00000060  00 7c 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |<span style="color: #483d8b;">.</span>|..............| <span style="color: #b22222;">#</span><span style="color: #b22222;">00 7c&#26159;&#20559;&#31227;&#22320;&#22336;&#65292; 00 00 &#26159;&#27573;&#22320;&#22336;&#12290;&#22240;&#20026;&#26159;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">intel&#22788;&#29702;&#22120;&#26159;&#20302;&#31471;&#23383;&#33410;&#24207;&#30340;&#65292;&#22788;&#29702;&#22120;&#30340;&#20302;&#23383;&#33410;&#22312;&#20869;&#23384;&#30340;&#20302;&#22320;&#22336;&#22788;&#65292;&#22788;&#29702;&#22120;&#30340;&#39640;&#23383;&#33410;&#22312;&#20869;&#23384;&#30340;&#39640;&#22320;&#22336;&#22788;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#20197; 00 7c 00 00 &#65292; &#35835;&#30340;&#26102;&#20505;&#26159;&#20174;&#21518;&#24448;&#21069;&#35835;&#65292;&#35835;&#25104; 0000  7c00</span>
00000070  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
000001f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 55 aa  |..............U.|
00000200

</pre>
</div>
</div>
</div>
<div id="outline-container-h:ff05f145-2e38-4610-9f96-c56bd06f60cc" class="outline-3">
<h3 id="h:ff05f145-2e38-4610-9f96-c56bd06f60cc">在Bochs中运行和调试写屏程序</h3>
<div class="outline-text-3" id="text-h:ff05f145-2e38-4610-9f96-c56bd06f60cc">
<blockquote>
<p>
调试程序，观察写屏过程，进一步了解程序调试的基本技巧
</p>
</blockquote>


<p>
将2进制程序写入虚拟硬盘文件learn.vhd
</p>
<ul class="org-ul">
<li>方法1 fixvhdwr.exe 用自定义的程序导入。
<ul class="org-ul">
<li>LBA连续直写模式，起始LBA区号为0</li>
</ul></li>
<li>方法2 其他有效方法</li>
</ul>

<p>
打开bochs调试器bochsdbg.exe进行调试。
</p>
</div>
<div id="outline-container-h:a056d66e-cb9c-4eeb-94af-b27be576da42" class="outline-4">
<h4 id="h:a056d66e-cb9c-4eeb-94af-b27be576da42">bochs调试命令</h4>
<div class="outline-text-4" id="text-h:a056d66e-cb9c-4eeb-94af-b27be576da42">
<div class="org-src-container">
<pre class="src src-sh">sreg   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#27573;&#23492;&#23384;&#22120;&#20869;&#23481;</span>
r    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#36890;&#36807;&#23492;&#23384;&#22120;</span>
s  <span style="color: #b22222;">#</span><span style="color: #b22222;">step &#21333;&#27493;&#25191;&#34892;</span>
b <span style="color: #b22222;">#</span><span style="color: #b22222;">break&#26029;&#28857;&#25351;&#20196;&#65292;&#35774;&#32622;&#19968;&#20010;&#20869;&#23384;&#22320;&#22336;&#65292;&#24403;&#21069;&#22788;&#29702;&#22120;&#25191;&#34892;&#21040;&#27492;&#20301;&#32622;&#23558;&#20572;&#19968;&#19979;&#26469;</span>
c <span style="color: #b22222;">#</span><span style="color: #b22222;">countine&#25345;&#32493;&#25191;&#34892;&#65292;&#22914;&#26524;&#36935;&#21040;&#26029;&#28857;&#20250;&#20572;&#19979;&#26469;</span>

&#24110;&#21161; help, help &#21629;&#20196;
n <span style="color: #b22222;">#</span><span style="color: #b22222;">next&#65292;&#20889;step&#21629;&#20196;&#21151;&#33021;&#31867;&#20284;</span>
xp /&#23383;&#33410;&#25968;&#21644;&#26174;&#31034;&#26041;&#24335; &#29289;&#29702;&#20869;&#23384;&#22320;&#22336; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20869;&#23384;&#20013;&#20869;&#23481;&#65292;&#22914;xp /512xb 0x7c00  &#65292;&#20854;&#20013;x&#20197;16&#36827;&#21046;&#26174;&#31034;, b&#20197;&#23383;&#33410;&#20026;&#21333;&#20301;&#26174;&#31034;</span>
u <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#32493;&#30340;&#26426;&#25351;&#20196;&#21453;&#27719;&#32534;&#25104;&#27719;&#32534;&#20195;&#30721;&#12290;&#19968;&#20010;u&#21453;&#27719;&#32534;&#19968;&#26465;&#25351;&#20196;&#12290;&#36830;&#32493;&#21453;&#27719;&#32534;32&#26465;&#25351;&#20196;&#65292; u/32</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2baf1d59-b2a8-4828-b70f-7594e0adf1c6" class="outline-4">
<h4 id="h:2baf1d59-b2a8-4828-b70f-7594e0adf1c6">bochs开机后调试界面</h4>
<div class="outline-text-4" id="text-h:2baf1d59-b2a8-4828-b70f-7594e0adf1c6">
<p>
与真正的处理器不同，bochs在取第1条指令之前会停下来，等待你的调试命令。
</p>

<div class="org-src-container">
<pre class="src src-sh">Next at <span style="color: #a0522d;">t</span>=0  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26102;&#38047;&#28404;&#31572;&#30340;&#31532;1&#27425;&#65292;&#21363;&#19979;&#19968;&#26465;&#25351;&#20196;&#22312;t=0&#30340;&#22522;&#30784;&#19978;&#25191;&#34892;&#12290;&#27599;&#27169;&#25311;1&#27425;&#65292;&#26102;&#38047;&#20250;&#28404;&#31572;1&#27425;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22788;&#29702;&#22120;&#20934;&#22791;&#25191;&#34892;&#31532;1&#26465;&#25351;&#20196;&#12290;CS&#20869;&#23481;&#20026;f000, IP&#20869;&#23481;&#20026;fff0</span>
(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#34892;&#34920;&#31034;&#21363;&#23558;&#25191;&#34892;&#30340;&#25351;&#20196;</span>
&lt;bochs:1&gt;

[0x0000fffffff0] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#26465;&#25351;&#20196;&#25152;&#22312;&#29289;&#29702;&#20869;&#23384;&#22320;&#22336;&#12290;&#20180;&#32454;&#35266;&#23519;&#21487;&#21457;&#29616;&#65292;&#19982;&#19979;&#38754;&#30340;&#36923;&#36753;&#22320;&#22336;&#19981;&#19968;&#33268;&#65292; &#36923;&#36753;&#22320;&#22336;&#23545;&#24212;ffff0&#30340;&#29289;&#29702;&#22320;&#22336;&#12290;&#36825;&#26159;&#26377;&#21407;&#22240;&#30340;&#65292;&#21482;&#22312;&#22788;&#29702;&#22120;&#21018;&#21551;&#21160;&#26102;&#21457;&#29983;&#65292;&#26242;&#19981;&#35752;&#35770;</span>
f000:fff0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36923;&#36753;&#22320;&#22336;&#65292;&#21487;&#20197;&#29702;&#35299;&#20026;&#27573;&#23492;&#23384;&#22120;CS&#20869;&#23481;F000, &#25351;&#20196;&#25351;&#38024;&#23492;&#23384;&#22120;IP&#20869;&#23481;FFF0&#12290;&#19981;&#20687;8086&#22788;&#29702;&#22120;&#27573;&#23492;&#23384;&#22120;FFFF&#65292;&#25351;&#20196;&#25351;&#38024;&#23492;&#23384;&#22120;0&#12290;</span>
jmpf 0xf000:e05b <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#26465;&#25351;&#20196;&#30340;&#27719;&#32534;&#35821;&#35328;&#24418;&#24335;&#12290;&#36339;&#36716;&#25351;&#20196;&#65292;&#30446;&#26631;&#20301;&#32622;0xf000:e05b</span>
;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#21495;&#20026;&#27880;&#37322;</span>
ea5be000f0  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#26465;&#25351;&#20196;&#30340;&#26426;&#22120;&#30721;</span>
</pre>
</div>

<p>
bochs开机后，准备跳到ROM BIOS中执行，ROM BIOS要做很多工作 ，其中最后一项工作是从虚拟硬件的主引导
扇区读取一个扇区数据，把主引导扇区读入到内存的物理地址0x7c00。
</p>

<p>
这时ROM BIOS还没有执行，查看7c00是什么，使用调试命令xp /512xb 0x7c00, 以16进制显示512个字节
</p>

<p>
xp /字节数和显示方式 物理内存地址 #查看内存中内容，如xp /512xb 0x7c00  ，其中x以16进制显示, b以字节为单位显示
</p>

<p>
帮助 help, help 命令
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;7c00&#22788;&#29702;&#20869;&#23481;&#65292;&#20197;16&#36827;&#21046;&#26174;&#31034;512&#20010;&#23383;&#33410;</span>
&lt;bochs:3&gt; xp /512xb 0x7c00
[bochs]:
0x0000000000007c00 &lt;bogus+       0&gt;:    0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x0000000000007c08 &lt;bogus+       8&gt;:    0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
... ...
0x0000000000007df0 &lt;bogus+     496&gt;:    0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x0000000000007df8 &lt;bogus+     504&gt;:    0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
&lt;bochs:4&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:581f9d62-4d4a-4be0-b7e8-877b6a9c1508" class="outline-4">
<h4 id="h:581f9d62-4d4a-4be0-b7e8-877b6a9c1508">bochs开始调试</h4>
<div class="outline-text-4" id="text-h:581f9d62-4d4a-4be0-b7e8-877b6a9c1508">
<p>
因为计算机启动后，总是把主引导扇区内容读取物理内存地址7c00处，然后从主引导扇区开始取指令并执行指令。
可以将这个地址设置为断点。
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26029;&#28857;7c00&#65292;&#22240;&#20026;ROM BIOS&#25191;&#34892;&#21518;&#26368;&#21518;&#30340;&#24037;&#20316;&#26159;&#25226;&#20027;&#24341;&#23548;&#25159;&#21306;&#25968;&#25454;&#35835;&#20837;&#21040;&#20869;&#23384;&#30340;&#29289;&#29702;&#22320;&#22336;7c00&#22788;</span>
&lt;bochs:4&gt; b 0x7c00
&lt;bochs:5&gt; c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22788;&#29702;&#22120;&#36830;&#32493;&#22320;&#25191;&#34892;&#65292;&#36935;&#21040;&#26029;&#28857;&#20572;&#19979;</span>
Next at <span style="color: #a0522d;">t</span>=17175563
(0) [0x000000007c00] 0000:7c00 (unk. ctxt): mov ax, 0xb800            ; b800b8

u &#21518;&#32493;&#30340;&#26426;&#25351;&#20196;&#21453;&#27719;&#32534;&#25104;&#27719;&#32534;&#20195;&#30721;&#12290;&#19968;&#20010;u&#21453;&#27719;&#32534;&#19968;&#26465;&#25351;&#20196;&#12290;&#36830;&#32493;&#21453;&#27719;&#32534;32&#26465;&#25351;&#20196;&#65292; u/32

&lt;bochs:30&gt; u/32 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21453;&#27719;&#32534;&#21518;&#32493;&#26426;&#22120;&#25351;&#20196;, &#25214;&#21040;&#31243;&#24207;&#26368;&#21518;&#19968;&#26465;&#25351;&#20196;&#25152;&#22312;&#20869;&#23384;&#29289;&#29702;&#22320;&#22336;</span>
0000000000007c00: (                    ): mov ax, 0xb800            ; b800b8
0000000000007c03: (                    ): mov ds, ax                ; 8ed8
...
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#21518;&#19968;&#26465;&#25351;&#20196;&#30340;&#29289;&#29702;&#22320;&#22336;&#26159; 7c5f&#65292;&#26041;&#20415;&#35774;&#32622;&#26029;&#28857;</span>
0000000000007c5f: (                    ): jmpf 0x0000:7c00          ; ea007c0000


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;7c00&#22788;&#29702;&#20869;&#23481;&#65292;&#20197;16&#36827;&#21046;&#26174;&#31034;512&#20010;&#23383;&#33410;. &#21487;&#20197;&#30475;&#21040;&#25105;&#20204;&#20889;&#30340;&#20027;&#24341;&#23548;&#25159;&#21306;&#31243;&#24207;&#25351;&#20196;</span>
&lt;bochs:6&gt; xp /512xb 0x7c00
[bochs]:
0x0000000000007c00 &lt;bogus+       0&gt;:    0xb8    0x00    0xb8    0x8e    0xd8    0xc6    0x06    0x00
0x0000000000007c08 &lt;bogus+       8&gt;:    0x00    0x41    0xc6    0x06    0x01    0x00    0x04    0xc6
0x0000000000007c10 &lt;bogus+      16&gt;:    0x06    0x02    0x00    0x73    0xc6    0x06    0x03    0x00
......
0x0000000000007df0 &lt;bogus+     496&gt;:    0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x0000000000007df8 &lt;bogus+     504&gt;:    0x00    0x00    0x00    0x00    0x00    0x00    0x55    0xaa
</pre>
</div>

<p>
单步运行程序指令,  数据段寄存内容为b800
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21333;&#27493;&#25191;&#34892;&#25351;&#20196;</span>
&lt;bochs:7&gt; s
Next at <span style="color: #a0522d;">t</span>=17175564
(0) [0x000000007c03] 0000:7c03 (unk. ctxt): mov ds, ax                ; 8ed8
&lt;bochs:8&gt; s
Next at <span style="color: #a0522d;">t</span>=17175565 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36319;&#25105;&#20204;&#20889;&#30340;&#25351;&#20196;&#26377;&#21306;&#21035;&#65292;&#20294;&#24635;&#20307;&#19968;&#26679;&#30340;&#65292;&#26159;&#25226;&#23383;&#27597;A&#30340;&#32534;&#30721;0x41&#20256;&#36865;&#21040;&#20559;&#31227;&#22320;&#22336;0&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20294;&#36825;&#37324;&#32473;&#20986;&#20102;&#40664;&#35748;&#30340;&#25968;&#25454;&#27573;&#23492;&#23384;&#22120;ds&#65292;&#24847;&#24605;&#26159;&#20256;&#36865;&#21040;ds&#25152;&#25351;&#21521;&#30340;&#20869;&#23384;&#27573;&#65292;&#27573;&#20013;&#20559;&#31227;&#22320;&#22336;0&#22788;</span>
(0) [0x000000007c05] 0000:7c05 (unk. ctxt): mov byte ptr ds:0x0000, 0x41 ; c606000041

&#34394;&#25311;&#26426;&#30340;&#26174;&#31034;&#22120;&#24050;&#32463;&#26174;&#31034;&#20102;&#24456;&#22810;&#20869;&#23481;&#65292;&#36825;&#26159;&#21551;&#21160;&#20449;&#24687;&#12290;&#36825;&#20123;&#21551;&#21160;&#20449;&#24687;&#20301;&#20110;&#20869;&#23384;&#29289;&#29702;&#22320;&#22336;&#20063;&#23601;&#26159;&#26174;&#23384;0xb8000&#22788;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26174;&#31034;&#22120;&#19978;&#24050;&#26377;&#20869;&#23481;&#65292;b800&#22788;&#30340;&#32534;&#30721;&#21644;&#39068;&#33394;&#23646;&#24615;</span>
&lt;bochs:10&gt; xp /16xb 0xb8000
[bochs]:
0x00000000000b8000 &lt;bogus+       0&gt;:    0x42    0x0b    0x6f    0x0b    0x63    0x0b    0x68    0x0b
0x00000000000b8008 &lt;bogus+       8&gt;:    0x73    0x0b    0x20    0x0b    0x56    0x0b    0x47    0x0b
<span style="color: #b22222;">#</span><span style="color: #b22222;">0x42&#26159;&#26174;&#31034;&#22120;&#19978;&#23383;&#27597;B&#30340;&#32534;&#30721;&#65292;0x0b(0000 1011)&#26159;&#23383;&#27597;B&#30340;&#39068;&#33394;&#23646;&#24615;(&#40657;&#24213;&#38738;&#33394;)</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">0x6f&#26159;&#26174;&#31034;&#22120;&#19978;&#23383;&#27597;o&#30340;&#32534;&#30721;&#65292;0x0b(0000 1011)&#26159;&#23383;&#27597;o&#30340;&#39068;&#33394;&#23646;&#24615;(&#40657;&#24213;&#38738;&#33394;)</span>
&lt;bochs:10&gt;
</pre>
</div>

<p>
继续运行程序，在屏幕左上角显示新的文本
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#21333;&#27493;&#35843;&#35797;&#21629;&#20196;s&#65292;&#20889;&#20837;&#26174;&#23384;&#30340;&#25351;&#20196;&#26102;&#65292;&#20889;&#20837;&#30340;&#20869;&#23481;&#19981;&#33021;&#22312;&#23631;&#24149;&#19978;&#30475;&#20986;&#26469;&#12290;&#36825;&#37324;&#25442;&#25104;&#30456;&#20284;&#21151;&#33021;&#30340;n&#21629;&#20196;</span>
&lt;bochs:11&gt; n <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23383;&#27597;A&#30340;&#32534;&#30721;0x41&#20889;&#20837;&#21040;&#26174;&#23384;, ds:0x0000&#22788;&#65292;ds&#20026;0xb800</span>
Next at <span style="color: #a0522d;">t</span>=17175566
(0) [0x000000007c0a] 0000:7c0a (unk. ctxt): mov byte ptr ds:0x0001, 0x04 ; c606010004
&lt;bochs:12&gt; n <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23383;&#27597;A&#30340;&#39068;&#33394;&#23646;&#24615;0x04&#20889;&#20837;&#21040;&#26174;&#23384;&#65292;0000 0100&#40657;&#24213;&#32418;&#23383;</span>
Next at <span style="color: #a0522d;">t</span>=17175567
(0) [0x000000007c0f] 0000:7c0f (unk. ctxt): mov byte ptr ds:0x0002, 0x73 ; c606020073
</pre>
</div>

<p>
将程序最后一条指令设为断点，快速运行完程序
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#31243;&#24207;&#26368;&#21518;&#19968;&#26465;&#25351;&#20196;&#35774;&#20026;&#26029;&#28857;&#65292;&#24555;&#36895;&#36816;&#34892;&#23436;&#31243;&#24207;</span>
&lt;bochs:32&gt; b 0x7c5f
&lt;bochs:33&gt; c
Next at <span style="color: #a0522d;">t</span>=17175604
(0) [0x000000007c5f] 0000:7c5f (unk. ctxt): jmpf 0x0000:7c00          ; ea007c0000

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32487;&#32493;&#36816;&#34892;&#65292;&#21448;&#36339;&#21040;7c00&#22788;&#65292;&#24320;&#22987;&#24490;&#29615;&#25191;&#34892;&#31243;&#24207;&#25351;&#20196;</span>
&lt;bochs:34&gt; s
(0) Breakpoint 1, 0x0000000000007c00<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17175605
(0) [0x000000007c00] 0000:7c00 (unk. ctxt): mov ax, 0xb800            ; b800b8
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:2a1d1f65-ba56-4092-8994-c087a6e6db55" class="outline-3">
<h3 id="h:2a1d1f65-ba56-4092-8994-c087a6e6db55">在VirtualBox中运行写屏程序</h3>
<div class="outline-text-3" id="text-h:2a1d1f65-ba56-4092-8994-c087a6e6db55">
<p>
打开Virtualbox， 创建硬件的虚拟机或者移除我们之前创建的虚拟机硬盘，添加已经写入主导扇区程序的虚拟硬盘文件learn.vhd
</p>



<figure id="org191f5c5">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241123_112350.png" alt="img_20241123_112350.png" width="90%">

</figure>

<p>
启动虚拟机，观察屏幕是否显示文本信息Assembly.
</p>



<figure id="org307363f">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241123_112705.png" alt="img_20241123_112705.png" width="90%">

</figure>

<p>
显示正常，强制退出虚拟机。
</p>
</div>
</div>
<div id="outline-container-h:79ceb719-b984-4e5d-81cc-a27ca3bd7a3a" class="outline-3">
<h3 id="h:79ceb719-b984-4e5d-81cc-a27ca3bd7a3a">主引导扇区执行时的内存布局</h3>
<div class="outline-text-3" id="text-h:79ceb719-b984-4e5d-81cc-a27ca3bd7a3a">
<blockquote>
<p>
根据主引导扇区加载后的内存布局来修改最后一条JMP指令，使它重复执行自己
</p>
</blockquote>

<p>
将主引导扇区程序编译生成列表文件，观察一下内存布局，找到最后一条指令物理地址。
</p>

<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm exam.asm -f bin -o exam.bin -l exam.lst

     1                                  start:
     2 00000000 B800B8                          mov ax, 0xb800 ;&#27573;&#22320;&#22336;B800
     3 00000003 8ED8                            mov ds, ax
     4
     5 00000005 C606000041                      mov byte [0x00], 0x41  ;&#23383;&#31526;A&#30340;ASCII&#32534;&#30721;.&#24847;&#24605;&#26159;&#25226;A&#30340;&#32534;&#30721;&#20256;&#36865;&#21040;&#20869;&#23384;&#29289;&#29702;&#22320;&#22336;B8000&#22788;
     6 0000000A C606010004                      mov byte [0x01], 0x04  ;&#40657;&#24213;&#32418;&#23383;&#65292;&#26080;&#38378;&#28865;
     7
     8 0000000F C606020073                      mov byte [0x02], <span style="color: #8b2252;">'s'</span>   ;&#31561;&#21516;&#20110; mov [0x02], 0x73
     9 00000014 C606030004                      mov byte [0x03], 0x04
     ......
    32 0000005F EA007C0000                      jmp 0x0000:0x7c00 ;&#24490;&#29615;&#20174;&#20027;&#24341;&#23548;&#25159;&#21306;&#36215;&#22987;&#22788;&#35835;&#21462;&#25351;&#20196;&#12290;&#27573;&#38388;&#30452;&#25509;&#32477;&#23545;&#36339;&#36716;&#25351;&#20196;
    33
    34                                  current:
    35 00000064 00&lt;rep 19Ah&gt;                    times 510-(current-start) db 0   ;&#35201;&#22635;&#20805;&#30340;&#23383;&#33410;&#25968;&#20026;512&#23383;&#33410;&#20943;&#21435;55AA&#30340;2&#20010;&#23383;&#33410;, &#20877;&#20943;&#31243;&#24207;&#38271;&#24230;&#12290;
    36
    37 000001FE 55AA                            db 0x55, 0xaa ;&#29992;&#19968;&#20010;db&#21487;&#20197;&#23450;&#20041;&#22810;&#20010;&#23383;&#33410;&#65292;&#29992;&#36887;&#21495;&#20998;&#38548;
</pre>
</div>

<p>
实际上我们没有跳那么远程让程序重新执行，可以反复跳到他自己。将跳转的目标地址改为这条指令自身的地址。
</p>

<p>
列表文件中第1条指令，汇编地址是0，jmp指令的汇编地址是5f。
</p>


<figure id="orgfb5c270">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241123_123925.png" alt="img_20241123_123925.png" width="90%">

</figure>

<p>
这是内存最低端的视图，因为物理地址是从0开始。主引导扇区加载的位置是从内存物理地址7c00处开始一直到7e00结束。主引导扇区
第1条指令是从7c00处开始，在源文件中的汇编地址是0。指令 <code>jmp 0x0000:0x7c00</code> 在源文件的汇编地址是5f，这条指令在内存中物理
地址是 7c00 + 5f = 7c5f 。得到地址，我们将程序修改如下。
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax, 0xb800 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27573;&#22320;&#22336;B800</span>
        <span style="color: #a020f0;">mov</span> ds, ax

        <span style="color: #a020f0;">mov</span> byte [0x00], 0x41  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23383;&#31526;A&#30340;ASCII&#32534;&#30721;.&#24847;&#24605;&#26159;&#25226;A&#30340;&#32534;&#30721;&#20256;&#36865;&#21040;&#20869;&#23384;&#29289;&#29702;&#22320;&#22336;B8000&#22788;</span>
        <span style="color: #a020f0;">mov</span> byte [0x01], 0x0c  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#40657;&#24213;&#32418;&#23383;&#65292;&#26080;&#38378;&#28865;</span>

        <span style="color: #a020f0;">mov</span> byte [0x02], 's'   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#21516;&#20110; mov [0x02], 0x73</span>
        <span style="color: #a020f0;">mov</span> byte [0x03], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x04], 's'
        <span style="color: #a020f0;">mov</span> byte [0x05], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x06], 'e'
        <span style="color: #a020f0;">mov</span> byte [0x07], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x08], 'm'
        <span style="color: #a020f0;">mov</span> byte [0x09], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0a], 'b'
        <span style="color: #a020f0;">mov</span> byte [0x0b], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0c], 'l'
        <span style="color: #a020f0;">mov</span> byte [0x0d], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0e], 'y'
        <span style="color: #a020f0;">mov</span> byte [0x0f], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x10], '.'
        <span style="color: #a020f0;">mov</span> byte [0x11], 0x04

        <span style="color: #a020f0;">jmp</span> 0x0000:0x7c5f <span style="color: #b22222;">;</span><span style="color: #b22222;">&#36339;&#36716;&#21040;&#33258;&#24049;&#12290;&#27573;&#38388;&#30452;&#25509;&#32477;&#23545;&#36339;&#36716;&#25351;&#20196;</span>

<span style="color: #0000ff;">current</span>:
        <span style="color: #a020f0;">times</span> 510-(current-start) db 0   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35201;&#22635;&#20805;&#30340;&#23383;&#33410;&#25968;&#20026;512&#23383;&#33410;&#20943;&#21435;55AA&#30340;2&#20010;&#23383;&#33410;, &#20877;&#20943;&#31243;&#24207;&#38271;&#24230;&#12290;</span>

        <span style="color: #a020f0;">db</span> 0x55, 0xaa <span style="color: #b22222;">;</span><span style="color: #b22222;">&#29992;&#19968;&#20010;db&#21487;&#20197;&#23450;&#20041;&#22810;&#20010;&#23383;&#33410;&#65292;&#29992;&#36887;&#21495;&#20998;&#38548;</span>
</pre>
</div>

<p>
编译
</p>
<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm exam.asm -f bin -o exam.bin -l exam.lst
</pre>
</div>


<p>
将2进制程序写入虚拟硬盘文件learn.vhd
</p>
<ul class="org-ul">
<li>方法1 fixvhdwr.exe 用自定义的程序导入。
<ul class="org-ul">
<li>LBA连续直写模式，起始LBA区号为0</li>
</ul></li>
<li>方法2 其他有效方法</li>
</ul>

<p>
打开bochs调试器bochsdbg.exe进行调试。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26029;&#28857;&#21040;&#29289;&#29702;&#22320;&#22336;7c00&#65292;&#22240;&#20026;ROM BIOS&#25191;&#34892;&#21518;&#26368;&#21518;&#30340;&#24037;&#20316;&#26159;&#25226;&#20027;&#24341;&#23548;&#25159;&#21306;&#25968;&#25454;&#35835;&#20837;&#21040;&#20869;&#23384;&#30340;&#29289;&#29702;&#22320;&#22336;7c00&#22788;</span>
Next at <span style="color: #a0522d;">t</span>=0
(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0
&lt;bochs:1&gt; b 0x7c00
&lt;bochs:2&gt; c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22788;&#29702;&#22120;&#36830;&#32493;&#22320;&#25191;&#34892;&#65292;&#36935;&#21040;&#26029;&#28857;&#20572;&#19979;</span>
......
Next at <span style="color: #a0522d;">t</span>=17175563
(0) [0x000000007c00] 0000:7c00 (unk. ctxt): mov ax, 0xb800            ; b800b8

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21453;&#27719;&#32534;32&#26465;&#25351;&#20196;</span>
&lt;bochs:3&gt; u /32
0000000000007c00: (                    ): mov ax, 0xb800            ; b800b8
0000000000007c03: (                    ): mov ds, ax                ; 8ed8
0000000000007c05: (                    ): mov byte ptr ds:0x0000, 0x41 ; c606000041
0000000000007c0a: (                    ): mov byte ptr ds:0x0001, 0x0c; c60601000c
0000000000007c0f: (                    ): mov byte ptr ds:0x0002, 0x73 ; c606020073
0000000000007c14: (                    ): mov byte ptr ds:0x0003, 0x04 ; c606030004
0000000000007c19: (                    ): mov byte ptr ds:0x0004, 0x73 ; c606040073
0000000000007c1e: (                    ): mov byte ptr ds:0x0005, 0x04 ; c606050004
0000000000007c23: (                    ): mov byte ptr ds:0x0006, 0x65 ; c606060065
0000000000007c28: (                    ): mov byte ptr ds:0x0007, 0x04 ; c606070004
0000000000007c2d: (                    ): mov byte ptr ds:0x0008, 0x6d ; c60608006d
0000000000007c32: (                    ): mov byte ptr ds:0x0009, 0x04 ; c606090004
0000000000007c37: (                    ): mov byte ptr ds:0x000a, 0x62 ; c6060a0062
0000000000007c3c: (                    ): mov byte ptr ds:0x000b, 0x04 ; c6060b0004
0000000000007c41: (                    ): mov byte ptr ds:0x000c, 0x6c ; c6060c006c
0000000000007c46: (                    ): mov byte ptr ds:0x000d, 0x04 ; c6060d0004
0000000000007c4b: (                    ): mov byte ptr ds:0x000e, 0x79 ; c6060e0079
0000000000007c50: (                    ): mov byte ptr ds:0x000f, 0x04 ; c6060f0004
0000000000007c55: (                    ): mov byte ptr ds:0x0010, 0x2e ; c60610002e
0000000000007c5a: (                    ): mov byte ptr ds:0x0011, 0x04 ; c606110004
0000000000007c5f: (                    ): jmpf 0x0000:7c5f          ; ea5f7c0000
......

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26029;&#28857;7c5f, &#20877;&#25191;&#34892;&#21040;&#26029;&#28857;&#22788;</span>
&lt;bochs:4&gt; b 0x7c5f
&lt;bochs:5&gt; c
(0) Breakpoint 2, 0x0000000000007c5f<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17175583
(0) [0x000000007c5f] 0000:7c5f (unk. ctxt): jmpf 0x0000:7c5f          ; ea5f7c0000

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#21040;&#23631;&#24149;&#19978;&#24050;&#32463;&#26174;&#31034;&#33258;&#23450;&#20041;&#25991;&#26412;&#20449;&#24687;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#19968;&#26465;&#23558;&#25191;&#34892;&#30340;&#25351;&#20196;&#19968;&#30452;&#26159;&#36339;&#21040;&#29289;&#29702;&#22320;&#22336;7c5f</span>
&lt;bochs:6&gt; s
(0) Breakpoint 2, 0x0000000000007c5f<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17175584
(0) [0x000000007c5f] 0000:7c5f (unk. ctxt): jmpf 0x0000:7c5f          ; ea5f7c0000
&lt;bochs:7&gt; s
(0) Breakpoint 2, 0x0000000000007c5f<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17175585
(0) [0x000000007c5f] 0000:7c5f (unk. ctxt): jmpf 0x0000:7c5f          ; ea5f7c0000
&lt;bochs:8&gt; s
(0) Breakpoint 2, 0x0000000000007c5f<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17175586
(0) [0x000000007c5f] 0000:7c5f (unk. ctxt): jmpf 0x0000:7c5f          ; ea5f7c0000

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36864;&#20986;</span>
&lt;bochs:9&gt; q
</pre>
</div>


<p>
打开Virtusbox虚拟机观察。
</p>


<figure id="org9abdce5">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241123_130511.png" alt="img_20241123_130511.png" width="90%">

</figure>
</div>
</div>
<div id="outline-container-h:c561f1fa-1bf5-4539-ae05-52f26c2705d6" class="outline-3">
<h3 id="h:c561f1fa-1bf5-4539-ae05-52f26c2705d6">使用标号计算跳转的偏移地址</h3>
<div class="outline-text-3" id="text-h:c561f1fa-1bf5-4539-ae05-52f26c2705d6">
<blockquote>
<p>
使用标号来计算JMP指令跳转的偏移地址
</p>
</blockquote>

<p>
开始之前，先看一下，主引导扇区开始执行时，段寄存器CS和指令指针寄存器IP的内容是什么。
</p>

<p>
打开bochs调试器bochsdbg.exe进行调试。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26029;&#28857;&#21040;&#29289;&#29702;&#22320;&#22336;7c00&#65292;&#22240;&#20026;ROM BIOS&#25191;&#34892;&#21518;&#26368;&#21518;&#30340;&#24037;&#20316;&#26159;&#25226;&#20027;&#24341;&#23548;&#25159;&#21306;&#25968;&#25454;&#35835;&#20837;&#21040;&#20869;&#23384;&#30340;&#29289;&#29702;&#22320;&#22336;7c00&#22788;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26029;&#28857;7c00 &#20877;&#25191;&#34892;&#21040;&#26029;&#28857;&#22788;</span>
Next at <span style="color: #a0522d;">t</span>=0
(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0
&lt;bochs:1&gt; b 0x7c00
&lt;bochs:2&gt; c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22788;&#29702;&#22120;&#36830;&#32493;&#22320;&#25191;&#34892;&#65292;&#36935;&#21040;&#26029;&#28857;&#20572;&#19979;</span>
......
Next at <span style="color: #a0522d;">t</span>=17175563
(0) [0x000000007c00] 0000:7c00 (unk. ctxt): mov ax, 0xb800            ; b800b8

<span style="color: #b22222;"># </span><span style="color: #b22222;">mov ax, 0xb800~ &#36825;&#26159;&#20027;&#24341;&#23548;&#25159;&#21306;&#30340;&#31532;1&#26465;&#25351;&#20196;&#65292;&#23427;&#30340;&#36923;&#36753;&#22320;&#22336;&#26159; ~0000:7c00~ , &#25442;&#21477;&#35805;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35828;&#27573;&#23492;&#23384;&#22120;CS&#30340;&#20869;&#23481;&#26159;0&#65292;&#25351;&#20196;&#25351;&#38024;&#23492;&#23384;&#22120;IP&#30340;&#20869;&#23481;&#26159;7c00</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#27573;&#23492;&#23384;&#22120;, CS&#30340;&#20869;&#23481;&#26159;0000</span>
&lt;bochs:3&gt; sreg
es:0x0000, <span style="color: #a0522d;">dh</span>=0x00009300, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=1
        Data segment, <span style="color: #a0522d;">base</span>=0x00000000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
cs:0x0000, <span style="color: #a0522d;">dh</span>=0x00009300, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=1
        Data segment, <span style="color: #a0522d;">base</span>=0x00000000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
ss:0x0000, <span style="color: #a0522d;">dh</span>=0x00009300, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=7
        Data segment, <span style="color: #a0522d;">base</span>=0x00000000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
ds:0x0000, <span style="color: #a0522d;">dh</span>=0x00009300, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=1
        Data segment, <span style="color: #a0522d;">base</span>=0x00000000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
fs:0x0000, <span style="color: #a0522d;">dh</span>=0x00009300, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=1
        Data segment, <span style="color: #a0522d;">base</span>=0x00000000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
gs:0x0000, <span style="color: #a0522d;">dh</span>=0x00009300, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=1
        Data segment, <span style="color: #a0522d;">base</span>=0x00000000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
ldtr:0x0000, <span style="color: #a0522d;">dh</span>=0x00008200, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=1
tr:0x0000, <span style="color: #a0522d;">dh</span>=0x00008b00, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=1
gdtr:<span style="color: #a0522d;">base</span>=0x00000000000f9e67, <span style="color: #a0522d;">limit</span>=0x30
idtr:<span style="color: #a0522d;">base</span>=0x0000000000000000, <span style="color: #a0522d;">limit</span>=0x3ff

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#36890;&#29992;&#23492;&#23384;&#22120;&#65292;rip&#30340;&#20302;16&#20301;&#23545;&#24212;&#30528;8086&#30340;IP&#30340;&#20869;&#23481;&#20026;7c00</span>
&lt;bochs:4&gt; r
rax: 00000000_0000aa55
rbx: 00000000_00000000
rcx: 00000000_00090000
rdx: 00000000_00000080
rsp: 00000000_0000ffd6
rbp: 00000000_00000000
rsi: 00000000_000e0000
rdi: 00000000_0000ffac
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c00
eflags: 0x00000082: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf SF zf af pf cf
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36864;&#20986;</span>
&lt;bochs:5&gt; q
</pre>
</div>



<figure id="orgda46767">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241123_132228.png" alt="img_20241123_132228.png" width="90%">

</figure>

<p>
上图，是位于内存最低端的段。段地址是0000，偏移地址从0000到FFFF，64千字节的段。
在计算机处理器加电或者复位后，将首先从ROM BIOS中执行，然后把硬盘主引导扇区的内容加载到内存里，而且是从段内偏移地址7c00处开始加载的。
当主引导扇区执行时，处理器CS是指向这个段的(0000)，同时指令指针寄存器指向这个加载的位置，ip的内容是7c00。 <code>jmp 0x0000:0x7c5f</code> 跳转
之后还是在这个段里，段内偏移地址7c5f = 源文件指令的汇编地址5f +第1条指令段内偏移地址7c00
</p>

<p>
标号代表着它所在那条指令的汇编地址，使用了标号再也不用手工计算偏移地址了，还可以向任何地方跳转。
</p>

<p>
5f可以变成一个标号。程序修改如下
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax, 0xb800 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27573;&#22320;&#22336;B800</span>
        <span style="color: #a020f0;">mov</span> ds, ax

        <span style="color: #a020f0;">mov</span> byte [0x00], 0x41  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23383;&#31526;A&#30340;ASCII&#32534;&#30721;.&#24847;&#24605;&#26159;&#25226;A&#30340;&#32534;&#30721;&#20256;&#36865;&#21040;&#20869;&#23384;&#29289;&#29702;&#22320;&#22336;B8000&#22788;</span>
        <span style="color: #a020f0;">mov</span> byte [0x01], 0x0c  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#40657;&#24213;&#32418;&#23383;&#65292;&#26080;&#38378;&#28865;</span>

        <span style="color: #a020f0;">mov</span> byte [0x02], 's'   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#21516;&#20110; mov [0x02], 0x73</span>
        <span style="color: #a020f0;">mov</span> byte [0x03], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x04], 's'
        <span style="color: #a020f0;">mov</span> byte [0x05], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x06], 'e'
        <span style="color: #a020f0;">mov</span> byte [0x07], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x08], 'm'
        <span style="color: #a020f0;">mov</span> byte [0x09], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0a], 'b'
        <span style="color: #a020f0;">mov</span> byte [0x0b], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0c], 'l'
        <span style="color: #a020f0;">mov</span> byte [0x0d], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0e], 'y'
        <span style="color: #a020f0;">mov</span> byte [0x0f], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x10], '.'
        <span style="color: #a020f0;">mov</span> byte [0x11], 0x04

<span style="color: #0000ff;">again</span>:
        <span style="color: #a020f0;">jmp</span> 0x0000:0x7c00+again <span style="color: #b22222;">;</span><span style="color: #b22222;">&#36339;&#36716;&#21040;&#33258;&#24049;&#12290;&#27573;&#38388;&#30452;&#25509;&#32477;&#23545;&#36339;&#36716;&#25351;&#20196;</span>

<span style="color: #0000ff;">current</span>:
        <span style="color: #a020f0;">times</span> 510-(current-start) db 0   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35201;&#22635;&#20805;&#30340;&#23383;&#33410;&#25968;&#20026;512&#23383;&#33410;&#20943;&#21435;55AA&#30340;2&#20010;&#23383;&#33410;, &#20877;&#20943;&#31243;&#24207;&#38271;&#24230;&#12290;</span>

        <span style="color: #a020f0;">db</span> 0x55, 0xaa <span style="color: #b22222;">;</span><span style="color: #b22222;">&#29992;&#19968;&#20010;db&#21487;&#20197;&#23450;&#20041;&#22810;&#20010;&#23383;&#33410;&#65292;&#29992;&#36887;&#21495;&#20998;&#38548;</span>
</pre>
</div>

<p>
使用bochs虚拟机进行调试。过程略
</p>
</div>
</div>
<div id="outline-container-h:a4ad32df-1fd8-4b9d-baa6-84d0c744bf32" class="outline-3">
<h3 id="h:a4ad32df-1fd8-4b9d-baa6-84d0c744bf32">使用寄存器的绝对间接近跳转</h3>
<div class="outline-text-3" id="text-h:a4ad32df-1fd8-4b9d-baa6-84d0c744bf32">
<blockquote>
<p>
认识和使用另一种段内的跳转指令：绝对间跳转
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">jmp</span> <span style="color: #a020f0;">0x0000</span>:0x7c00+again <span style="color: #b22222;">;</span><span style="color: #b22222;">&#36339;&#36716;&#21040;&#33258;&#24049;&#12290;&#27573;&#38388;&#30452;&#25509;&#32477;&#23545;&#36339;&#36716;&#25351;&#20196;</span>
</pre>
</div>

<p>
段间直接绝对跳转指令是从一个代码段跳转到另一个代码段地址处执行，直接给出了目标位置的绝对地址。
</p>

<p>
就我们这个程序而言是很费事的，因为这些指令都在一个段内，可以在不改变段寄存器CS的情况，从一个地方跳到另一个地址就行了。
相对于段之间的跳转，在段内的跳转更常见，只是在一个代码段内跳转。
</p>

<p>
8086处理器提供了一种新的跳转形式，绝对间接近跳转，可以根据通用寄存器的内容来跳转。如可以根据bx的内容进行跳转。
</p>
<ul class="org-ul">
<li>绝对，给出的地址是目标地址的实际偏移地址，绝对地址</li>
<li>间接，跳转的目标位置不是在指令中直接给出的，而是根据寄存器中内容间接给出</li>
<li>近，跳转到不太远的地方，段的内容</li>
</ul>

<p>
程序修改如下
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax, 0xb800 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27573;&#22320;&#22336;B800</span>
        <span style="color: #a020f0;">mov</span> ds, ax

        <span style="color: #a020f0;">mov</span> byte [0x00], 0x41  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23383;&#31526;A&#30340;ASCII&#32534;&#30721;.&#24847;&#24605;&#26159;&#25226;A&#30340;&#32534;&#30721;&#20256;&#36865;&#21040;&#20869;&#23384;&#29289;&#29702;&#22320;&#22336;B8000&#22788;</span>
        <span style="color: #a020f0;">mov</span> byte [0x01], 0x0c  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#40657;&#24213;&#32418;&#23383;&#65292;&#26080;&#38378;&#28865;</span>

        <span style="color: #a020f0;">mov</span> byte [0x02], 's'   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#21516;&#20110; mov [0x02], 0x73</span>
        <span style="color: #a020f0;">mov</span> byte [0x03], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x04], 's'
        <span style="color: #a020f0;">mov</span> byte [0x05], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x06], 'e'
        <span style="color: #a020f0;">mov</span> byte [0x07], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x08], 'm'
        <span style="color: #a020f0;">mov</span> byte [0x09], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0a], 'b'
        <span style="color: #a020f0;">mov</span> byte [0x0b], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0c], 'l'
        <span style="color: #a020f0;">mov</span> byte [0x0d], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0e], 'y'
        <span style="color: #a020f0;">mov</span> byte [0x0f], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x10], '.'
        <span style="color: #a020f0;">mov</span> byte [0x11], 0x04

        <span style="color: #a020f0;">mov</span> bx, 0x7c00+again

<span style="color: #0000ff;">again</span>:
        <span style="color: #a020f0;">jmp</span> bx <span style="color: #b22222;">;</span><span style="color: #b22222;">&#36339;&#36716;&#21040;&#33258;&#24049;&#12290;&#32477;&#23545;&#38388;&#25509;&#36817;&#36339;&#36716;&#25351;&#20196;</span>

<span style="color: #0000ff;">current</span>:
        <span style="color: #a020f0;">times</span> 510-(current-start) db 0   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35201;&#22635;&#20805;&#30340;&#23383;&#33410;&#25968;&#20026;512&#23383;&#33410;&#20943;&#21435;55AA&#30340;2&#20010;&#23383;&#33410;, &#20877;&#20943;&#31243;&#24207;&#38271;&#24230;&#12290;</span>

        <span style="color: #a020f0;">db</span> 0x55, 0xaa <span style="color: #b22222;">;</span><span style="color: #b22222;">&#29992;&#19968;&#20010;db&#21487;&#20197;&#23450;&#20041;&#22810;&#20010;&#23383;&#33410;&#65292;&#29992;&#36887;&#21495;&#20998;&#38548;</span>
</pre>
</div>

<p>
编译
</p>
<div class="org-src-container">
<pre class="src src-sh">nasm exam.asm -f bin -o exam.bin -l exam.lst
</pre>
</div>

<p>
将程序写入主引导扇区，打开bochs调试
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26029;&#28857;7c00 &#20877;&#25191;&#34892;&#21040;&#26029;&#28857;&#22788;</span>
Next at <span style="color: #a0522d;">t</span>=0
(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0
&lt;bochs:1&gt; b 0x7c00
&lt;bochs:2&gt; c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22788;&#29702;&#22120;&#36830;&#32493;&#22320;&#25191;&#34892;&#65292;&#36935;&#21040;&#26029;&#28857;&#20572;&#19979;</span>
......
Next at <span style="color: #a0522d;">t</span>=17175563
(0) [0x000000007c00] 0000:7c00 (unk. ctxt): mov ax, 0xb800            ; b800b8

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21453;&#27719;&#32534;32&#26465;&#25351;&#20196;&#65292;&#35266;&#23519;&#25351;&#20196;&#21644;&#23545;&#24212;&#30340;&#29289;&#29702;&#22320;&#22336;&#65292;jmp&#25351;&#20196;&#30340;&#29289;&#29702;&#22320;&#22336;&#26159;7c62&#65292;&#36339;&#36716;&#33258;&#24049;</span>
&lt;bochs:3&gt; u /32
0000000000007c00: (                    ): mov ax, 0xb800            ; b800b8
0000000000007c03: (                    ): mov ds, ax                ; 8ed8
0000000000007c05: (                    ): mov byte ptr ds:0x0000, 0x41 ; c606000041
0000000000007c0a: (                    ): mov byte ptr ds:0x0001, 0x0c ; c60601000c
0000000000007c0f: (                    ): mov byte ptr ds:0x0002, 0x73 ; c606020073
0000000000007c14: (                    ): mov byte ptr ds:0x0003, 0x04 ; c606030004
0000000000007c19: (                    ): mov byte ptr ds:0x0004, 0x73 ; c606040073
0000000000007c1e: (                    ): mov byte ptr ds:0x0005, 0x04 ; c606050004
0000000000007c23: (                    ): mov byte ptr ds:0x0006, 0x65 ; c606060065
0000000000007c28: (                    ): mov byte ptr ds:0x0007, 0x04 ; c606070004
0000000000007c2d: (                    ): mov byte ptr ds:0x0008, 0x6d ; c60608006d
0000000000007c32: (                    ): mov byte ptr ds:0x0009, 0x04 ; c606090004
0000000000007c37: (                    ): mov byte ptr ds:0x000a, 0x62 ; c6060a0062
0000000000007c3c: (                    ): mov byte ptr ds:0x000b, 0x04 ; c6060b0004
0000000000007c41: (                    ): mov byte ptr ds:0x000c, 0x6c ; c6060c006c
0000000000007c46: (                    ): mov byte ptr ds:0x000d, 0x04 ; c6060d0004
0000000000007c4b: (                    ): mov byte ptr ds:0x000e, 0x79 ; c6060e0079
0000000000007c50: (                    ): mov byte ptr ds:0x000f, 0x04 ; c6060f0004
0000000000007c55: (                    ): mov byte ptr ds:0x0010, 0x2e ; c60610002e
0000000000007c5a: (                    ): mov byte ptr ds:0x0011, 0x04 ; c606110004
0000000000007c5f: (                    ): mov bx, 0x7c62            ; bb627c
0000000000007c62: (                    ): jmp bx                    ; ffe3
0000000000007c64: (                    ): add byte ptr ds:[bx+si], al ; 0000


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26029;&#28857;&#65292;&#25191;&#34892;&#21040;mov bx, 0x7c62&#20572;&#19979;&#26469;</span>
&lt;bochs:4&gt; b 0x7c5f
&lt;bochs:5&gt; c
(0) Breakpoint 2, 0x0000000000007c5f<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17175583
(0) [0x000000007c5f] 0000:7c5f (unk. ctxt): mov bx, 0x7c62            ; bb627c

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#21516;&#30340;&#36339;&#36716;&#25351;&#20196;&#65292;&#20182;&#20204;&#30340;&#25805;&#20316;&#30721;&#26159;&#19981;&#19968;&#26679;&#30340;&#12290;&#36339;&#36716;&#21040;bx&#30340;&#25805;&#20316;&#30721;&#26159;ffe3</span>
&lt;bochs:6&gt; s
Next at <span style="color: #a0522d;">t</span>=17175584
(0) [0x000000007c62] 0000:7c62 (unk. ctxt): jmp bx                    ; ffe3
&lt;bochs:7&gt; s
Next at <span style="color: #a0522d;">t</span>=17175585
(0) [0x000000007c62] 0000:7c62 (unk. ctxt): jmp bx                    ; ffe3
&lt;bochs:8&gt; s
Next at <span style="color: #a0522d;">t</span>=17175586
(0) [0x000000007c62] 0000:7c62 (unk. ctxt): jmp bx                    ; ffe3
&lt;bochs:9&gt; s
Next at <span style="color: #a0522d;">t</span>=17175587
(0) [0x000000007c62] 0000:7c62 (unk. ctxt): jmp bx                    ; ffe3
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#26102;&#35201;&#35828;&#26126;&#30340;&#26159;&#65292;&#36825;&#26465;&#25351;&#20196;&#25191;&#34892;&#26102;&#19981;&#25913;&#21464;&#27573;&#23492;&#23384;&#22120;CS&#30340;&#20869;&#23481;&#65292;&#21482;&#26159;&#25913;&#21464;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#20196;&#25351;&#38024;&#23492;&#23384;&#22120;IP&#30340;&#20869;&#23481;&#65292;&#25152;&#20197;&#23427;&#26159;&#27573;&#20869;&#32477;&#23545;&#38388;&#25509;&#36817;&#36339;&#36716;&#25351;&#20196;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#35201;&#34394;&#25311;&#26426;&#19981;&#20851;&#26426;&#23601;&#20250;&#27704;&#36828;&#25191;&#34892;&#36825;&#26465;&#25351;&#20196;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36864;&#20986;</span>
&lt;bochs:11&gt; q
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8304cbb7-a767-454d-96cf-039cdaf81a98" class="outline-3">
<h3 id="h:8304cbb7-a767-454d-96cf-039cdaf81a98">使用相对偏移量的短跳转和近跳转</h3>
<div class="outline-text-3" id="text-h:8304cbb7-a767-454d-96cf-039cdaf81a98">
<blockquote>
<p>
引入另一种更方便的跳转形式，这种跳转形式不使用绝对地址，而是使用
到目标位置的相对偏移量。
</p>
</blockquote>

<p>
段间直接绝对跳转和绝对间接近跳转都要使用绝对段内地址很不方便。主引导扇区程序有点特殊，我们知道加载的位置是
7c00，可以用7c00加上汇编地址加得出段的偏移地址。但是，在多时候程序从什么地址加载是不知道的，
它的偏移地址很难计算。
</p>

<p>
使用标号是最方便的。
</p>

<p>
目标位置相对于这条跳转指令，它们之间的距离是不变的。也就是相对偏移量是不会改变的。
</p>

<div class="org-src-container">
<pre class="src src-sh">jmp &#26631;&#21495;
</pre>
</div>

<p>
像这种指令，在编译时采用的不是绝对偏移地址，也不是标号的汇编地址，而是相对偏移量。
</p>

<p>
相对偏移量计算：标号所在指令的汇编地址减去jmp指令后面的汇编地址。相减的结果可能是正数也可能是负数。
</p>

<p>
如果跳不太远，相减后小128小于-127，对应的机器指令是2个字节，第1个字节是EB，第2个字节是8位的相对偏移量。这样的跳转称为
相对短跳转。指令的汇编格式是 <code>jmp short start</code> ，其中short可不写，编译器可以自己选择。
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">jmp</span> <span style="color: #a020f0;">short</span> &#26631;&#21495; <span style="color: #b22222;">;</span><span style="color: #b22222;">&#30701;&#36339;&#36716;&#12290;&#26426;&#22120;&#25351;&#20196;2&#20010;&#23383;&#33410;&#65292;EB &#21644; 8&#20301;&#30340;&#30456;&#23545;&#20559;&#31227;&#37327;</span>
<span style="color: #0000ff;">jmp</span> <span style="color: #a020f0;">near</span> &#26631;&#21495;  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#36817;&#36339;&#36716;&#12290;&#25805;&#20316;&#30721;E9&#65292;&#21644;16&#20301;&#30340;&#30456;&#23545;&#20559;&#31227;&#37327;</span>
</pre>
</div>

<p>
程序修改如下
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax, 0xb800 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27573;&#22320;&#22336;B800</span>
        <span style="color: #a020f0;">mov</span> ds, ax

        <span style="color: #a020f0;">mov</span> byte [0x00], 0x41  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23383;&#31526;A&#30340;ASCII&#32534;&#30721;.&#24847;&#24605;&#26159;&#25226;A&#30340;&#32534;&#30721;&#20256;&#36865;&#21040;&#20869;&#23384;&#29289;&#29702;&#22320;&#22336;B8000&#22788;</span>
        <span style="color: #a020f0;">mov</span> byte [0x01], 0x0c  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#40657;&#24213;&#32418;&#23383;&#65292;&#26080;&#38378;&#28865;</span>

        <span style="color: #a020f0;">mov</span> byte [0x02], 's'   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#21516;&#20110; mov [0x02], 0x73</span>
        <span style="color: #a020f0;">mov</span> byte [0x03], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x04], 's'
        <span style="color: #a020f0;">mov</span> byte [0x05], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x06], 'e'
        <span style="color: #a020f0;">mov</span> byte [0x07], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x08], 'm'
        <span style="color: #a020f0;">mov</span> byte [0x09], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0a], 'b'
        <span style="color: #a020f0;">mov</span> byte [0x0b], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0c], 'l'
        <span style="color: #a020f0;">mov</span> byte [0x0d], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0e], 'y'
        <span style="color: #a020f0;">mov</span> byte [0x0f], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x10], '.'
        <span style="color: #a020f0;">mov</span> byte [0x11], 0x04

<span style="color: #0000ff;">again</span>:
        <span style="color: #a020f0;">jmp</span> near start <span style="color: #b22222;">;</span><span style="color: #b22222;">&#36339;&#36716;&#21040;&#33258;&#24049;&#12290;&#30456;&#23545;&#20559;&#31227;&#37327;&#36339;&#36716;&#12290;E9 16&#20301;&#30340;&#30456;&#23545;&#20559;&#31227;&#37327;</span>

<span style="color: #0000ff;">current</span>:
        <span style="color: #a020f0;">times</span> 510-(current-start) db 0   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35201;&#22635;&#20805;&#30340;&#23383;&#33410;&#25968;&#20026;512&#23383;&#33410;&#20943;&#21435;55AA&#30340;2&#20010;&#23383;&#33410;, &#20877;&#20943;&#31243;&#24207;&#38271;&#24230;&#12290;</span>

        <span style="color: #a020f0;">db</span> 0x55, 0xaa <span style="color: #b22222;">;</span><span style="color: #b22222;">&#29992;&#19968;&#20010;db&#21487;&#20197;&#23450;&#20041;&#22810;&#20010;&#23383;&#33410;&#65292;&#29992;&#36887;&#21495;&#20998;&#38548;</span>
</pre>
</div>


<p>
编译
</p>
<div class="org-src-container">
<pre class="src src-sh">nasm exam.asm -f bin -o exam.bin -l exam.lst
</pre>
</div>

<p>
将程序写入主引导扇区，打开bochs调试
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26029;&#28857;7c00 &#20877;&#25191;&#34892;&#21040;&#26029;&#28857;&#22788;</span>
Next at <span style="color: #a0522d;">t</span>=0
(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0
&lt;bochs:1&gt; b 0x7c00
&lt;bochs:2&gt; c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22788;&#29702;&#22120;&#36830;&#32493;&#22320;&#25191;&#34892;&#65292;&#36935;&#21040;&#26029;&#28857;&#20572;&#19979;</span>
......
Next at <span style="color: #a0522d;">t</span>=17175563
(0) [0x000000007c00] 0000:7c00 (unk. ctxt): mov ax, 0xb800            ; b800b8

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21453;&#27719;&#32534;32&#26465;&#25351;&#20196;&#65292;&#35266;&#23519;&#25351;&#20196;&#21644;&#23545;&#24212;&#30340;&#29289;&#29702;&#22320;&#22336;</span>
&lt;bochs:3&gt; u /32
0000000000007c00: (                    ): mov ax, 0xb800            ; b800b8
0000000000007c03: (                    ): mov ds, ax                ; 8ed8
0000000000007c05: (                    ): mov byte ptr ds:0x0000, 0x41 ; c606000041
0000000000007c0a: (                    ): mov byte ptr ds:0x0001, 0x0c ; c60601000c
0000000000007c0f: (                    ): mov byte ptr ds:0x0002, 0x73 ; c606020073
0000000000007c14: (                    ): mov byte ptr ds:0x0003, 0x04 ; c606030004
0000000000007c19: (                    ): mov byte ptr ds:0x0004, 0x73 ; c606040073
0000000000007c1e: (                    ): mov byte ptr ds:0x0005, 0x04 ; c606050004
0000000000007c23: (                    ): mov byte ptr ds:0x0006, 0x65 ; c606060065
0000000000007c28: (                    ): mov byte ptr ds:0x0007, 0x04 ; c606070004
0000000000007c2d: (                    ): mov byte ptr ds:0x0008, 0x6d ; c60608006d
0000000000007c32: (                    ): mov byte ptr ds:0x0009, 0x04 ; c606090004
0000000000007c37: (                    ): mov byte ptr ds:0x000a, 0x62 ; c6060a0062
0000000000007c3c: (                    ): mov byte ptr ds:0x000b, 0x04 ; c6060b0004
0000000000007c41: (                    ): mov byte ptr ds:0x000c, 0x6c ; c6060c006c
0000000000007c46: (                    ): mov byte ptr ds:0x000d, 0x04 ; c6060d0004
0000000000007c4b: (                    ): mov byte ptr ds:0x000e, 0x79 ; c6060e0079
0000000000007c50: (                    ): mov byte ptr ds:0x000f, 0x04 ; c6060f0004
0000000000007c55: (                    ): mov byte ptr ds:0x0010, 0x2e ; c60610002e
0000000000007c5a: (                    ): mov byte ptr ds:0x0011, 0x04 ; c606110004
0000000000007c5f: (                    ): jmp .-98  (0x00007c00)    ; e99eff
0000000000007c62: (                    ): add byte ptr ds:[bx+si], al ; 0000
<span style="color: #b22222;">#</span><span style="color: #b22222;">e99eff&#19968;&#20849;3&#20010;&#23383;&#33410;&#12290;&#20854;&#20013;e9&#26159;&#25805;&#20316;&#30721;&#65292;9eff&#26159;&#30456;&#23545;&#20559;&#31227;&#37327;&#12290;</span>
</pre>
</div>

<p>
偏移量计算, 查看编译后的列表文件
</p>
<div class="org-src-container">
<pre class="src src-sh"> 1                                  start:
 2 00000000 B800B8                          mov ax, 0xb800 ;&#27573;&#22320;&#22336;B800
 ......
32                                  again:
33 0000005F E99EFF                          jmp near start ;&#36339;&#36716;&#21040;&#33258;&#24049;&#12290;&#30456;&#23545;&#20559;&#31227;&#37327;&#36339;&#36716;&#12290;E9 16&#20301;&#30340;&#30456;&#23545;&#20559;&#31227;&#37327;
36 00000062 00&lt;rep 19Ch&gt;                    times 510-(current-start) db 0   ;&#35201;&#22635;&#20805;&#30340;&#23383;&#33410;&#25968;&#20026;512&#23383;&#33410;&#20943;&#21435;55AA&#30340;2&#20010;&#23383;&#33410;, &#20877;&#20943;&#31243;&#24207;&#38271;&#24230;&#12290;
</pre>
</div>

<p>
相对偏移量 = 目标汇编地址(0) -  jmp指令之后的汇编地址(62) = FFFF FFFF FFFF FF9E = 指令中只能取16位ff9e = -98
</p>

<p>
8086是低端字节序的，读的时候从向前读。 9eff 。 16进制的ff9e等于10进制-98
</p>

<p>
这条jmp指令之后的汇编地址相对于第1条指令，它们的相对偏移量是98个字节。因为方向原因所以是个负数。
</p>

<p>
设置新断点
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;bochs:4&gt; b 0x7c5f
&lt;bochs:5&gt; c
(0) Breakpoint 2, 0x0000000000007c5f<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17175583
(0) [0x000000007c5f] 0000:7c5f (unk. ctxt): jmp .-98  (0x00007c00)    ; e99eff

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069; jmp -98&#25191;&#34892;&#26102;&#65292;&#26159;&#29992;&#25351;&#20196;&#25351;&#38024;&#23492;&#23384;&#22120;IP&#30340;&#20869;&#23481;+&#25351;&#20196;&#20013;&#25351;&#20196;&#30340;&#20559;&#31227;&#37327;&#24471;&#21040;&#30446;&#26631;&#20301;&#32622;&#22788;&#30340;&#20869;&#23384;&#20559;&#31227;&#22320;&#22336;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#20196;&#25351;&#38024;&#23492;&#23384;&#22120;IP&#30340;&#20869;&#23481;&#19981;&#26159;7c5f&#65292;&#32780;&#26159;IP&#30340;&#20869;&#23481;&#31561;&#20110;IP&#30340;&#20869;&#23481;+&#24403;&#21069;&#25351;&#20196;&#30340;&#38271;&#24230;&#65292;&#21363;IP&#20869;&#23481;&#33258;&#21160;&#21464;&#20026;7c5f+16=7c62</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#20197;&#30446;&#26631;&#20301;&#32622;&#20869;&#23384;&#20559;&#31227;&#22320;&#22336;&#20026;=7c62+ff9e=17c00&#65292;&#25351;&#20196;&#25351;&#38024;&#30340;&#20869;&#23481;&#21482;&#26377;16&#20301;&#65292;&#21462;7c00</span>
&lt;bochs:6&gt; s
(0) Breakpoint 1, 0x0000000000007c00<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17175584
(0) [0x000000007c00] 0000:7c00 (unk. ctxt): mov ax, 0xb800            ; b800b8
&lt;bochs:7&gt; s
Next at <span style="color: #a0522d;">t</span>=17175585
(0) [0x000000007c03] 0000:7c03 (unk. ctxt): mov ds, ax                ; 8ed8
&lt;bochs:8&gt; s
Next at <span style="color: #a0522d;">t</span>=17175586
(0) [0x000000007c05] 0000:7c05 (unk. ctxt): mov byte ptr ds:0x0000, 0x41 ; c606000041
</pre>
</div>

<p>
所以跳转到自己话，程序修改如下
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax, 0xb800 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27573;&#22320;&#22336;B800</span>
        <span style="color: #a020f0;">mov</span> ds, ax

        <span style="color: #a020f0;">mov</span> byte [0x00], 0x41  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23383;&#31526;A&#30340;ASCII&#32534;&#30721;.&#24847;&#24605;&#26159;&#25226;A&#30340;&#32534;&#30721;&#20256;&#36865;&#21040;&#20869;&#23384;&#29289;&#29702;&#22320;&#22336;B8000&#22788;</span>
        <span style="color: #a020f0;">mov</span> byte [0x01], 0x0c  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#40657;&#24213;&#32418;&#23383;&#65292;&#26080;&#38378;&#28865;</span>

        <span style="color: #a020f0;">mov</span> byte [0x02], 's'   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#21516;&#20110; mov [0x02], 0x73</span>
        <span style="color: #a020f0;">mov</span> byte [0x03], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x04], 's'
        <span style="color: #a020f0;">mov</span> byte [0x05], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x06], 'e'
        <span style="color: #a020f0;">mov</span> byte [0x07], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x08], 'm'
        <span style="color: #a020f0;">mov</span> byte [0x09], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0a], 'b'
        <span style="color: #a020f0;">mov</span> byte [0x0b], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0c], 'l'
        <span style="color: #a020f0;">mov</span> byte [0x0d], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x0e], 'y'
        <span style="color: #a020f0;">mov</span> byte [0x0f], 0x04

        <span style="color: #a020f0;">mov</span> byte [0x10], '.'
        <span style="color: #a020f0;">mov</span> byte [0x11], 0x04

<span style="color: #0000ff;">again</span>:
        <span style="color: #a020f0;">jmp</span> near again <span style="color: #b22222;">;</span><span style="color: #b22222;">&#36339;&#36716;&#21040;&#33258;&#24049;&#12290;&#30456;&#23545;&#20559;&#31227;&#37327;&#36339;&#36716;&#12290;E9 16&#20301;&#30340;&#30456;&#23545;&#20559;&#31227;&#37327;</span>

<span style="color: #0000ff;">current</span>:
        <span style="color: #a020f0;">times</span> 510-(current-start) db 0   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35201;&#22635;&#20805;&#30340;&#23383;&#33410;&#25968;&#20026;512&#23383;&#33410;&#20943;&#21435;55AA&#30340;2&#20010;&#23383;&#33410;, &#20877;&#20943;&#31243;&#24207;&#38271;&#24230;&#12290;</span>

        <span style="color: #a020f0;">db</span> 0x55, 0xaa <span style="color: #b22222;">;</span><span style="color: #b22222;">&#29992;&#19968;&#20010;db&#21487;&#20197;&#23450;&#20041;&#22810;&#20010;&#23383;&#33410;&#65292;&#29992;&#36887;&#21495;&#20998;&#38548;</span>
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:aeb115e5-ec9a-4e6c-88f8-eb78f8eefbef" class="outline-2">
<h2 id="h:aeb115e5-ec9a-4e6c-88f8-eb78f8eefbef">在屏幕上显示数字</h2>
<div class="outline-text-2" id="text-h:aeb115e5-ec9a-4e6c-88f8-eb78f8eefbef">
<p>
主要内容
</p>

<ul class="org-ul">
<li>显示数字的基本原理</li>
<li>无符号数除法指令div</li>
<li>在调试器里验证除法操作</li>
<li>异或指令xor的用法</li>
<li>加法指令add的用法</li>
<li>使用标号访问内存数据</li>
<li>段超越前缀的使用</li>
<li>显示标号的汇编地址</li>
</ul>
</div>
<div id="outline-container-h:3396ce4c-6df8-410c-97ff-1e50a6c4f2f4" class="outline-3">
<h3 id="h:3396ce4c-6df8-410c-97ff-1e50a6c4f2f4">显示数字的基本原理</h3>
<div class="outline-text-3" id="text-h:3396ce4c-6df8-410c-97ff-1e50a6c4f2f4">
<blockquote>
<p>
认识数字和数字字符的区别，以及如何将数字拆分为独立的数位，为显示数字做准备
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-sh">&#25968;&#23383;1 -&gt; 0000 0001 (0x01)
&#23383;&#31526;1 -&gt; 0011 0001 (0x31)
</pre>
</div>

<p>
在ASCII字符集中只有0到9这10个数字字符。这意味着如果想在屏幕上显示数字125，需要在屏幕分别显示3个数字字符1，2，5。
也就是分别向显存写入这3个字符的编码和颜色属性。
</p>

<p>
125如何变成3个独立的字符？分2步进行
</p>

<ul class="org-ul">
<li>第一步：将数字125分解为3个数字1,2,5</li>
</ul>

<pre class="example" id="org8e40783">
125 -&gt; 0111 1101
  1 -&gt; 0000 0001
  2 -&gt; 0000 0010
  5 -&gt; 0000 0101
</pre>

<ul class="org-ul">
<li>第二步：将数字1、2和5分别转换为对应的数字字符
<ul class="org-ul">
<li>数字0到9对应的数字字符编码为0x30到0x39。因此，只需要将数字加上0x30得到了
它对应的数字字符编码。</li>
<li>比如数字5的二进制是0000 0101，加上0x30后的结果为0011 0101，这就是数字字符5的编码。</li>
</ul></li>
</ul>


<p>
第一步：将数字125分解为3个数字1,2,5
</p>

<p>
传统上，要分解数字的每一个数位，要除以10，取余。
</p>

<p>
范例：125分解
</p>
<pre class="example" id="org5fc0686">
125 / 10 = 商12  余 5
12 / 10  = 商1 余2
1 / 10 = 商0 余1
</pre>
</div>
</div>
<div id="outline-container-h:37295f74-5e34-49c0-97b4-543e513ac652" class="outline-3">
<h3 id="h:37295f74-5e34-49c0-97b4-543e513ac652">无符号数除法指令div</h3>
<div class="outline-text-3" id="text-h:37295f74-5e34-49c0-97b4-543e513ac652">
<blockquote>
<p>
了解无符号整数除法指令div
</p>
</blockquote>

<p>
div指令只能用于无符号整数的操作。div指令只需要一个操作数，即除数所在寄存器或者内存地址。
被除数在哪里要由除数的长度决定。
</p>

<p>
格式
</p>
<pre class="example" id="orgf802b15">
div 除数所在的寄存器或者内存地址
</pre>

<p>
<b>除数长度是8位</b>
</p>

<ul class="org-ul">
<li>如果在指令中指定的是8位寄存器或者8位操作数的内存地址，则意味着被除数在寄存器AX里。</li>
<li>相除后，商在寄存器AL里，余数在寄存器AH里。</li>
</ul>

<p>
范例：div 除数长度为8位
</p>
<div class="org-src-container">
<pre class="src src-sh">div bh
<span style="color: #b22222;">#</span><span style="color: #b22222;">bh&#26159;8&#20301;&#30340;&#23492;&#23384;&#22120;&#65292;&#23384;&#25918;&#30340;&#26159;&#38500;&#25968;&#65292;&#37027;&#20040;&#34987;&#38500;&#25968;&#23384;&#25918;&#22312;AX&#37324;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">AX&#20013;&#20869;&#23481;&#38500;&#20197;BH&#20013;&#20869;&#23481;&#65292;&#30456;&#38500;&#21518;&#65292;&#21830;&#22312;AL&#20013;&#65292;&#20313;&#25968;&#22312;AH&#20013;</span>

div byte [0x2002]
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38500;&#25968;&#22312;&#20869;&#23384;&#20013;&#65292;&#20174;&#20869;&#23384;&#22320;&#22336;0x2002&#22788;&#21462;1&#20010;&#23383;&#33410;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">AX&#20013;&#20869;&#23481;&#38500;&#20197;0x2002&#22320;&#22336;&#30340;8&#20301;&#38500;&#25968;&#65292;&#30456;&#38500;&#21518;&#65292;&#21830;&#22312;AL&#20013;&#65292;&#20313;&#25968;&#22312;AH&#20013;</span>
</pre>
</div>

<p>
<b>除数长度是16位</b>
</p>

<ul class="org-ul">
<li>如果在指令中指定的是16位寄存器或者16位操作数的内存地址，则意味着被除数是32位的，低
16位在寄存器AX里；高16位在寄存器DX里</li>
<li>相除后，商在寄存器AX里，余数在寄存器DX里。</li>
</ul>



<figure id="org433b579">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241124_131246.png" alt="img_20241124_131246.png" width="90%">

</figure>

<p>
范例：div 除数长度为16位
</p>
<div class="org-src-container">
<pre class="src src-sh">div bx
<span style="color: #b22222;">#</span><span style="color: #b22222;">bx&#26159;16&#20301;&#30340;&#23492;&#23384;&#22120;&#65292;&#23384;&#25918;&#30340;&#26159;&#38500;&#25968;&#65292;&#37027;&#20040;&#34987;&#38500;&#25968;&#26159;32&#20301;&#30340;&#65292;&#20302;16&#20301;&#22312;&#23492;&#23384;&#22120;AX&#37324;&#65307;&#39640;16&#20301;&#22312;&#23492;&#23384;&#22120;DX&#37324;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;DX&#21644;AX&#32452;&#21512;&#25104;32&#20301;&#30340;&#34987;&#38500;&#25968;&#38500;&#20197;BX&#20013;&#20869;&#23481;&#65292;&#30456;&#38500;&#21518;&#65292;&#21830;&#22312;AX&#20013;&#65292;&#20313;&#25968;&#22312;DX&#20013;</span>

div word [0x2002]
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38500;&#25968;&#22312;&#20869;&#23384;&#20013;&#65292;&#20174;&#20869;&#23384;&#22320;&#22336;0x2002&#22788;&#21462;1&#20010;&#23383;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;DX&#21644;AX&#32452;&#21512;&#25104;32&#20301;&#30340;&#34987;&#38500;&#25968;&#38500;&#20197;0x2002&#22320;&#22336;&#30340;16&#20301;&#38500;&#25968;&#65292;&#30456;&#38500;&#21518;&#65292;&#21830;&#22312;AX&#20013;&#65292;&#20313;&#25968;&#22312;DX&#20013;</span>
</pre>
</div>

<p>
<b>除数长度是32位</b>
</p>

<p>
8086不支持的，它是16位处理器，从80386开始支持
</p>

<ul class="org-ul">
<li>如果在指令中指定的是32位寄存器或者32位操作数的内存地址，则意味着被除数是64位的，低
32位在寄存器EAX里；高32位在寄存器EDX里</li>
<li>相除后，商在寄存器EAX里，余数在寄存器EDX里。</li>
</ul>


<p>
范例：div 除数长度为32位
</p>
<div class="org-src-container">
<pre class="src src-sh">div ebx
<span style="color: #b22222;">#</span><span style="color: #b22222;">ebx&#26159;32&#20301;&#30340;&#23492;&#23384;&#22120;&#65292;&#23384;&#25918;&#30340;&#26159;&#38500;&#25968;&#65292;&#37027;&#20040;&#34987;&#38500;&#25968;&#26159;64&#20301;&#30340;&#65292;&#20302;32&#20301;&#22312;&#23492;&#23384;&#22120;EAX&#37324;&#65307;&#39640;32&#20301;&#22312;&#23492;&#23384;&#22120;EDX&#37324;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;EDX&#21644;EAX&#32452;&#21512;&#25104;64&#20301;&#30340;&#34987;&#38500;&#25968;&#38500;&#20197;&#26377;EBX&#20013;&#20869;&#23481;&#65292;&#30456;&#38500;&#21518;&#65292;&#21830;&#22312;EAX&#20013;&#65292;&#20313;&#25968;&#22312;EDX&#20013;</span>

div dword [0x2002]
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38500;&#25968;&#22312;&#20869;&#23384;&#20013;&#65292;&#20174;&#20869;&#23384;&#22320;&#22336;0x2002&#22788;&#21462;4&#20010;&#23383;&#33410;&#32452;&#21512;&#20986;32&#20301;&#25805;&#20316;&#25968;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;EDX&#21644;EAX&#32452;&#21512;&#25104;64&#20301;&#30340;&#34987;&#38500;&#25968;&#38500;&#20197;0x2002&#22320;&#22336;&#30340;32&#20301;&#38500;&#25968;&#65292;&#30456;&#38500;&#21518;&#65292;&#21830;&#22312;EAX&#20013;&#65292;&#20313;&#25968;&#22312;EDX&#20013;</span>
</pre>
</div>

<p>
<b>除数长度是64位</b>
</p>

<p>
8086和32位处理器不支持，只有64位处理器支持
</p>

<ul class="org-ul">
<li>如果在指令中指定的是64位寄存器或者64位操作数的内存地址，则意味着被除数是128位的，低
64位在寄存器RAX里；高64位在寄存器RDX里</li>
<li>相除后，商在寄存器RAX里，余数在寄存器RDX里。</li>
</ul>


<p>
范例：div 除数长度为64位
</p>
<div class="org-src-container">
<pre class="src src-sh">div rbx
<span style="color: #b22222;">#</span><span style="color: #b22222;">rbx&#26159;64&#20301;&#30340;&#23492;&#23384;&#22120;&#65292;&#23384;&#25918;&#30340;&#26159;&#38500;&#25968;&#65292;&#37027;&#20040;&#34987;&#38500;&#25968;&#26159;128&#20301;&#30340;&#65292;&#20302;64&#20301;&#22312;&#23492;&#23384;&#22120;RAX&#37324;&#65307;&#39640;64&#20301;&#22312;&#23492;&#23384;&#22120;RDX&#37324;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;RDX&#21644;RAX&#32452;&#21512;&#25104;128&#20301;&#30340;&#34987;&#38500;&#25968;&#38500;&#20197;&#26377;RBX&#20013;&#20869;&#23481;&#65292;&#30456;&#38500;&#21518;&#65292;&#21830;&#22312;RAX&#20013;&#65292;&#20313;&#25968;&#22312;RDX&#20013;</span>

div qword [0x2002]
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38500;&#25968;&#22312;&#20869;&#23384;&#20013;&#65292;&#20174;&#20869;&#23384;&#22320;&#22336;0x2002&#22788;&#21462;8&#20010;&#23383;&#33410;&#32452;&#21512;&#20986;64&#20301;&#25805;&#20316;&#25968;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;RDX&#21644;RAX&#32452;&#21512;&#25104;128&#20301;&#30340;&#34987;&#38500;&#25968;&#38500;&#20197;0x2002&#22320;&#22336;&#30340;64&#20301;&#38500;&#25968;&#65292;&#30456;&#38500;&#21518;&#65292;&#21830;&#22312;RAX&#20013;&#65292;&#20313;&#25968;&#22312;RDX&#20013;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0c97f6c7-9d7e-4d7f-b075-b5c1cf4e2fb9" class="outline-3">
<h3 id="h:0c97f6c7-9d7e-4d7f-b075-b5c1cf4e2fb9">在调试器里验证除法操作</h3>
<div class="outline-text-3" id="text-h:0c97f6c7-9d7e-4d7f-b075-b5c1cf4e2fb9">
<blockquote>
<p>
通过在调试器里跟踪除法指令的执行，来加深对这条指令的认识
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #b22222;">;</span><span style="color: #b22222;">&#35745;&#31639;378&#38500;&#20197;37&#30340;&#32467;&#26524;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ax</span>, 378  <span style="color: #b22222;">;</span><span style="color: #b22222;">378&#20256;&#36865;&#21040;ax&#65292;&#34987;&#38500;&#25968;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">bl</span>, 37  <span style="color: #b22222;">;</span><span style="color: #b22222;">37&#20256;&#36865;&#21040;bl&#65292;&#38500;&#25968;</span>
<span style="color: #0000ff;">div</span> <span style="color: #a020f0;">bl</span>     <span style="color: #b22222;">;</span><span style="color: #b22222;">AL=&#21830;(10), AH=&#20313;&#25968;(8)</span>
</pre>
</div>

<p>
将这个3行代码放在调试器中运行。为此把代码放到主引导扇区里，做成主引导扇区程序，再写入到虚拟硬盘文件中，通过bochs来调试。
</p>

<p>
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">start</span>:
        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35745;&#31639;378&#38500;&#20197;37&#30340;&#32467;&#26524;</span>
        <span style="color: #a020f0;">mov</span> ax, 378
        <span style="color: #a020f0;">mov</span> bl, 37
        <span style="color: #a020f0;">div</span> bl     <span style="color: #b22222;">;</span><span style="color: #b22222;">AL=&#21830;(10), AH=&#20313;&#25968;(8)</span>

<span style="color: #0000ff;">current</span>:
        <span style="color: #a020f0;">times</span> 510-(current-start) db 0

        <span style="color: #a020f0;">db</span> 0x55, 0xaa
</pre>
</div>

<p>
编译
</p>
<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm exam.asm -f bin -o exam.bin -l exam.lst
</pre>
</div>


<p>
将2进制程序写入虚拟硬盘文件learn.vhd
</p>
<ul class="org-ul">
<li>方法1 fixvhdwr.exe 用自定义的程序导入。
<ul class="org-ul">
<li>LBA连续直写模式，起始LBA区号为0</li>
</ul></li>
<li>方法2 其他有效方法</li>
</ul>

<p>
打开bochs调试器bochsdbg.exe进行调试。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26029;&#28857;&#21040;&#29289;&#29702;&#22320;&#22336;7c00&#65292;&#22240;&#20026;ROM BIOS&#25191;&#34892;&#21518;&#26368;&#21518;&#30340;&#24037;&#20316;&#26159;&#25226;&#20027;&#24341;&#23548;&#25159;&#21306;&#25968;&#25454;&#35835;&#20837;&#21040;&#20869;&#23384;&#30340;&#29289;&#29702;&#22320;&#22336;7c00&#22788;</span>
Next at <span style="color: #a0522d;">t</span>=0
(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0
&lt;bochs:1&gt; b 0x7c00
&lt;bochs:2&gt; c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22788;&#29702;&#22120;&#36830;&#32493;&#22320;&#25191;&#34892;&#65292;&#36935;&#21040;&#26029;&#28857;&#20572;&#19979;</span>
......
Next at <span style="color: #a0522d;">t</span>=17175563  <span style="color: #b22222;">#</span><span style="color: #b22222;">16&#36827;&#21046;&#30340;17a&#31561;&#20110;10&#36827;&#21046;&#30340;378</span>
(0) [0x000000007c00] 0000:7c00 (unk. ctxt): mov ax, 0x017a            ; b87a01

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21333;&#27493;&#25191;&#34892;</span>
&lt;bochs:3&gt; s
Next at <span style="color: #a0522d;">t</span>=17175564
(0) [0x000000007c03] 0000:7c03 (unk. ctxt): mov bl, 0x25              ; b325
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;mov ax, 0x017a&#25191;&#34892;&#21518;&#65292;&#23492;&#23384;&#22120;&#20869;&#23481;</span>
&lt;bochs:4&gt; r
rax: 00000000_0000017a <span style="color: #b22222;">#</span><span style="color: #b22222;">rax&#30340;&#20302;16&#20301;ax&#20869;&#23481;&#20026;017a&#65292;10&#36827;&#21046;&#30340;378</span>
rbx: 00000000_00000000
.....
rip: 00000000_00007c03

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;mov bl, 0x25&#25191;&#34892;&#21518;&#65292;&#23492;&#23384;&#22120;&#20869;&#23481;</span>
&lt;bochs:5&gt; s
Next at <span style="color: #a0522d;">t</span>=17175565
(0) [0x000000007c05] 0000:7c05 (unk. ctxt): div al, bl                ; f6f3
&lt;bochs:6&gt; r
rax: 00000000_0000017a
rbx: 00000000_00000025 ;rbx&#30340;&#20302;8&#20301;bl&#20869;&#23481;&#20026;25&#65292;&#21363;10&#36827;&#21046;37
......
rip: 00000000_00007c05

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;div al, bl&#25191;&#34892;&#21518;&#65292;&#23492;&#23384;&#22120;&#20869;&#23481;&#12290;&#36825;&#26159;bochs&#34394;&#25311;&#26426;&#33258;&#24049;&#23450;&#20041;&#30340;&#26684;&#24335;&#65292;&#23454;&#38469;&#19978;&#26159;div bl</span>
&lt;bochs:7&gt; s
Next at <span style="color: #a0522d;">t</span>=17175566
(0) [0x000000007c07] 0000:7c07 (unk. ctxt): add byte ptr ds:[bx+si], al ; 0000
&lt;bochs:8&gt; r
rax: 00000000_0000080a  <span style="color: #b22222;">#</span><span style="color: #b22222;">378&#38500;&#20197;37&#65292;&#21830;&#22312;al&#20013;&#65292;rax&#30340;&#20302;8&#20301;0a&#65292;10&#36827;&#21046;&#30340;10; &#20313;&#25968;&#22312;ah&#20013;&#65292;rax&#30340;&#39640;8&#20301;08&#65292;10&#36827;&#21046;&#30340;8</span>
rbx: 00000000_00000025
......
rip: 00000000_00007c07
</pre>
</div>
</div>
</div>
<div id="outline-container-h:16c01e5a-1d0a-4191-a4dc-d30f29a722e6" class="outline-3">
<h3 id="h:16c01e5a-1d0a-4191-a4dc-d30f29a722e6">异或指令xor的用法</h3>
<div class="outline-text-3" id="text-h:16c01e5a-1d0a-4191-a4dc-d30f29a722e6">
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #b22222;">;</span><span style="color: #b22222;">&#35745;&#31639;65535&#38500;&#20197;10&#30340;&#32467;&#26524;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ax</span>, 65535
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">bl</span>, 10
<span style="color: #0000ff;">div</span> <span style="color: #a020f0;">bl</span>     <span style="color: #b22222;">;</span><span style="color: #b22222;">AL=&#21830;(6553), AH=&#20313;&#25968;(5)</span>
</pre>
</div>

<p>
AL是8位的不能存6553这么大的数字。改用16位除数。
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">start</span>:
        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35745;&#31639;65535&#38500;&#20197;10&#30340;&#32467;&#26524;</span>
        <span style="color: #a020f0;">mov</span> ax, 65535
        <span style="color: #a020f0;">mov</span> dx, 0
        <span style="color: #a020f0;">mov</span> bx, 10
        <span style="color: #a020f0;">div</span> bx     <span style="color: #b22222;">;</span><span style="color: #b22222;">AX=&#21830;(6553), DX=&#20313;&#25968;(5)</span>

<span style="color: #0000ff;">current</span>:
        <span style="color: #a020f0;">times</span> 510-(current-start) db 0

        <span style="color: #a020f0;">db</span> 0x55, 0xaa
</pre>
</div>

<p>
上面 <code>mov dx, 0</code> 也可以改成 <code>xor dx, dx</code>, 执行速度比 mov dx, 0要快
</p>


<p>
异或=XOR=eXclusive OR
</p>


<figure id="org0ed5908">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241124_154319.png" alt="img_20241124_154319.png" width="90%">

<figcaption><span class="figure-number">Figure 18: </span>异或电路</figcaption>
</figure>

<div class="org-src-container">
<pre class="src src-sh">&#24322;&#25110;&#30005;&#36335;&#26377;2&#20010;&#36755;&#20837;1&#20010;&#36755;&#20986;&#12290;&#24403;&#36755;&#20837;&#30456;&#21516;&#26102;&#65292;&#36755;&#20986;&#20026;0&#65307;&#24403;&#36755;&#20837;&#19981;&#21516;&#26102;&#65292;&#36755;&#20986;&#20026;1

0 ^ 0 = 0
1 ^ 1 = 0
0 ^ 1 = 1
1 ^ 0 = 1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24322;&#25110;&#25805;&#20316;&#21487;&#22312;2&#20010;&#25968;&#20043;&#38388;&#36827;&#34892;</span>
129 ^ 127 = ?
1000 0001
0111 1111 ^
---------
1111 1110  254
</pre>
</div>

<p>
异或指令格式
</p>
<div class="org-src-container">
<pre class="src src-sh">xor r/m, r/m/imm

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35828;&#26126;</span>
r &#23492;&#23384;&#22120;
m &#20869;&#23384;&#22320;&#22336;
imm &#31435;&#21363;&#25968;

&#24322;&#25110;&#30340;&#32467;&#26524;&#20445;&#23384;&#22312;&#24038;&#25805;&#20316;&#25968;&#20013;&#12290;

&#27880;&#24847;&#65306;2&#20010;&#25805;&#20316;&#25968;&#25152;&#25351;&#23450;&#30340;&#25968;&#25454;&#38271;&#24230;&#24517;&#39035;&#30456;&#21516;
</pre>
</div>

<p>
范例：xor异或
</p>
<div class="org-src-container">
<pre class="src src-shell">xor bh, al  <span style="color: #b22222;">#</span><span style="color: #b22222;">bh&#30340;&#20540;&#21644;al&#30340;&#20540;&#20570;&#24322;&#25110;&#25805;&#20316;&#65292;&#32467;&#26524;&#22312;bh&#20013;</span>

xor cx, dx <span style="color: #b22222;">#</span><span style="color: #b22222;">cx&#30340;&#20540;&#21644;dx&#30340;&#20540;&#20570;&#24322;&#25110;&#25805;&#20316;&#65292;&#32467;&#26524;&#22312;cx&#20013;</span>

xor ax, 3 <span style="color: #b22222;">#</span><span style="color: #b22222;">ax&#30340;&#20540;&#21644;&#31435;&#21363;&#25968;3&#20570;&#24322;&#25110;&#25805;&#20316;&#65292;&#32467;&#26524;&#22312;ax&#20013;. &#22240;&#20026;ax&#26159;16&#20301;&#23492;&#23384;&#22120;&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#20197;&#20026;&#20102;&#20445;&#25345;&#19968;&#33268;&#65292;&#31435;&#21363;&#25968;3&#34987;&#24403;&#25104;16&#20301;&#30340;&#25968;&#23383;&#21442;&#19982;&#36816;&#31639;</span>

xor word [0x2002], 67 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25226;&#20174;&#20869;&#23384;&#22320;&#22336;2002&#24320;&#22987;&#30340;&#19968;&#20010;&#23383;&#21644;&#31435;&#21363;&#25968;67&#20570;&#24322;&#25110;&#25805;&#20316;&#65292;&#32467;&#26524;&#36820;&#22238;&#21040;&#21407;&#26469;&#30340;&#20869;&#23384;&#22320;&#22336;&#20445;&#23384;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22240;&#20026;&#20869;&#23384;&#25805;&#20316;&#25968;&#26159;&#29992;word&#26469;&#20462;&#39280;&#30340;&#65292;&#22240;&#27492;&#25805;&#20316;&#25968;&#30340;&#38271;&#24230;&#26159;16&#20301;&#30340;&#23383;&#65292;&#20026;&#20102;&#20445;&#25345;&#19968;&#33268;&#65292;&#31435;&#21363;&#25968;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#34987;&#24403;&#25104;16&#20301;&#30340;&#25968;&#23383;&#21442;&#19982;&#36816;&#31639;</span>

xor si, [0x2002] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25226;si&#21644;&#20869;&#23384;&#37324;&#30340;&#25968;&#23383;&#20570;&#24322;&#25110;&#36816;&#31639;&#65292;&#32467;&#26524;&#22312;si&#20013;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22240;&#20026;si&#30340;&#38271;&#24230;&#26159;16&#20301;&#30340;&#65292;&#25152;&#20197;&#24517;&#39035;&#20174;&#20869;&#23384;&#22320;&#22336;2002&#22788;&#35835;&#21462;&#19968;&#20010;16&#20301;&#30340;&#23383;&#21442;&#19982;&#36816;&#31639;&#12290;</span>
</pre>
</div>

<p>
<code>xor dx, dx</code> 两个操作数都一样做异或，生成一个所有比特为0的结果，覆盖寄存器dx中原有的内容。2个操作数都是寄存器，执行起来比较快。
</p>

<p>
exam.asm 可修改为
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">start</span>:
        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35745;&#31639;65535&#38500;&#20197;10&#30340;&#32467;&#26524;</span>
        <span style="color: #a020f0;">mov</span> ax, 65535
        <span style="color: #a020f0;">xor</span> dx, dx   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#20215;&#20110;mov dx, 0, &#25191;&#34892;&#36895;&#24230;&#26356;&#24555;</span>
        <span style="color: #a020f0;">mov</span> bx, 10
        <span style="color: #a020f0;">div</span> bx     <span style="color: #b22222;">;</span><span style="color: #b22222;">AX=&#21830;(6553), DX=&#20313;&#25968;(5)</span>

<span style="color: #0000ff;">current</span>:
        <span style="color: #a020f0;">times</span> 510-(current-start) db 0

        <span style="color: #a020f0;">db</span> 0x55, 0xaa
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a53dc47a-369d-404f-8b54-30d67ec4336b" class="outline-3">
<h3 id="h:a53dc47a-369d-404f-8b54-30d67ec4336b">加法指令add的用法</h3>
<div class="outline-text-3" id="text-h:a53dc47a-369d-404f-8b54-30d67ec4336b">
<blockquote>
<p>
因为工作需要引入加法指令add并介绍它的功能和用法
</p>
</blockquote>

<p>
在屏幕上显示数字65535，就必须把它的每一个数位分解出来。上节已经用div分解出第一个
数位5。 这个数位保存在寄存器DX中，只需要取DX的低8位DL。要在屏幕上显示这个数位，就要加上0x30就可以转换为数字字符编码。
</p>

<pre class="example" id="org8c584ee">
DX
00000000 00000101
高8位DH   低8位DL
</pre>

<p>
exam.asm可修改为
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">start</span>:
        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#22312;&#23631;&#24149;&#19978;&#26174;&#31034;&#25968;&#23383;65535</span>
        <span style="color: #a020f0;">mov</span> ax, 65535
        <span style="color: #a020f0;">xor</span> dx, dx          <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#20215;&#20110;mov dx, 0</span>
        <span style="color: #a020f0;">mov</span> bx, 10
        <span style="color: #a020f0;">div</span> bx              <span style="color: #b22222;">;</span><span style="color: #b22222;">AX=&#21830;(6553), DX=&#20313;&#25968;(5)</span>

        <span style="color: #a020f0;">add</span> dl, 0x30        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25968;&#23383;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#25968;&#23383;&#23383;&#31526;</span>

<span style="color: #0000ff;">current</span>:
        <span style="color: #a020f0;">times</span> 510-(current-start) db 0

        <span style="color: #a020f0;">db</span> 0x55, 0xaa
</pre>
</div>

<p>
<b>add指令介绍</b>
</p>

<p>
add格式
</p>
<div class="org-src-container">
<pre class="src src-sh">add r/m, r/m/imm

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35828;&#26126;</span>
r &#23492;&#23384;&#22120;
m &#20869;&#23384;&#22320;&#22336;
imm &#31435;&#21363;&#25968;

&#32467;&#26524;&#20445;&#23384;&#22312;&#24038;&#25805;&#20316;&#25968;&#20013;

&#35828;&#26126;&#65306;2&#20010;&#25805;&#20316;&#25968;&#25152;&#25351;&#30340;&#25968;&#25454;&#38271;&#24230;&#24517;&#39035;&#30456;&#21516;&#65292;&#25805;&#20316;&#25968;&#19981;&#33021;&#21516;&#26102;&#20026;&#20869;&#23384;&#22320;&#22336;
</pre>
</div>

<p>
范例：add指令
</p>
<div class="org-src-container">
<pre class="src src-sh">add bh, al  <span style="color: #b22222;">#</span><span style="color: #b22222;">bh&#30340;&#20540;&#21644;al&#30340;&#20540;&#30456;&#21152;&#65292;&#32467;&#26524;&#22312;bh&#20013;</span>

add cx, dx <span style="color: #b22222;">#</span><span style="color: #b22222;">cx&#30340;&#20540;&#21644;dx&#30340;&#20540;&#30456;&#21152;&#65292;&#32467;&#26524;&#22312;cx&#20013;</span>

add ax, 3 <span style="color: #b22222;">#</span><span style="color: #b22222;">ax&#30340;&#20540;&#21644;&#31435;&#21363;&#25968;3&#30456;&#21152;&#65292;&#32467;&#26524;&#22312;ax&#20013;. &#22240;&#20026;ax&#26159;16&#20301;&#23492;&#23384;&#22120;&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#20197;&#20026;&#20102;&#20445;&#25345;&#19968;&#33268;&#65292;&#31435;&#21363;&#25968;3&#34987;&#24403;&#25104;16&#20301;&#30340;&#25968;&#23383;&#21442;&#19982;&#36816;&#31639;</span>

add word [0x2002], 67 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25226;&#20174;&#20869;&#23384;&#22320;&#22336;2002&#24320;&#22987;&#30340;&#19968;&#20010;&#23383;&#21644;&#31435;&#21363;&#25968;67&#30456;&#21152;&#65292;&#32467;&#26524;&#36820;&#22238;&#21040;&#21407;&#26469;&#30340;&#20869;&#23384;&#22320;&#22336;&#20445;&#23384;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22240;&#20026;&#20869;&#23384;&#25805;&#20316;&#25968;&#26159;&#29992;word&#26469;&#20462;&#39280;&#30340;&#65292;&#22240;&#27492;&#25805;&#20316;&#25968;&#30340;&#38271;&#24230;&#26159;16&#20301;&#30340;&#23383;&#65292;&#20026;&#20102;&#20445;&#25345;&#19968;&#33268;&#65292;&#31435;&#21363;&#25968;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#34987;&#24403;&#25104;16&#20301;&#30340;&#25968;&#23383;&#21442;&#19982;&#36816;&#31639;</span>

add si, [0x2002] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25226;si&#21644;&#20869;&#23384;&#37324;&#30340;&#25968;&#23383;&#30456;&#21152;&#65292;&#32467;&#26524;&#22312;si&#20013;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22240;&#20026;si&#30340;&#38271;&#24230;&#26159;16&#20301;&#30340;&#65292;&#25152;&#20197;&#24517;&#39035;&#20174;&#20869;&#23384;&#22320;&#22336;2002&#22788;&#35835;&#21462;&#19968;&#20010;16&#20301;&#30340;&#23383;&#21442;&#19982;&#36816;&#31639;&#12290;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3b16cade-909a-4ee5-af60-ba24f422a27f" class="outline-3">
<h3 id="h:3b16cade-909a-4ee5-af60-ba24f422a27f">使用标号访问内存数据</h3>
<div class="outline-text-3" id="text-h:3b16cade-909a-4ee5-af60-ba24f422a27f">
<blockquote>
<p>
如何在程序中保留内存空间，并使用标号访问这些内存空间
</p>
</blockquote>

<p>
每分解一位就显示的话，在屏幕上显示是反的。可以把每次分解的数位转换成字符编码后，临时存在在别的地方。
全部转换完成后，再按正解的顺序加以显示。
</p>

<p>
保存到哪？8086的寄存器肯定不是够用的，我们已经占用了bx, dx,ax,剩下的是si,di,dp,sp，但剩下的都是16位的而且只能做为16位来用，不用做为8位。
所以用来保存8位的字符编码并不是很方便。
</p>



<figure id="org813df98">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241124_180758.png" alt="img_20241124_180758.png" width="90%">

</figure>

<p>
考虑到内存空间很大，可以将这些数位保存到内存里。可以伪指令db来开辟内存空间 <code>buffer   db 0, 0, 0, 0, 0</code> 。使用标号来找到它们。
我们知道标号代表汇编地址，这标号buffer仅仅代表第一个字节的汇编地址，即第1个0的汇编地址。
</p>

<p>
在访问内存时，标号可以用来计算程序运算时的偏移地址。db 0,0, 0,0,0 中第1个0，它的段地址是0，段偏移地址是 0x7c00+buffer。
</p>

<p>
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">start</span>:
        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#22312;&#23631;&#24149;&#19978;&#26174;&#31034;&#25968;&#23383;65535</span>
        <span style="color: #a020f0;">mov</span> ax, 65535
        <span style="color: #a020f0;">xor</span> dx, dx          <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#20215;&#20110;mov dx, 0</span>
        <span style="color: #a020f0;">mov</span> bx, 10
        <span style="color: #a020f0;">div</span> bx              <span style="color: #b22222;">;</span><span style="color: #b22222;">AX=&#21830;(6553), DX=&#20313;&#25968;(5)</span>

        <span style="color: #a020f0;">add</span> dl, 0x30        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25968;&#23383;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#25968;&#23383;&#23383;&#31526;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#27573;&#23492;&#23384;ds&#20869;&#23481;&#65292; 0</span>
        <span style="color: #a020f0;">mov</span> cx, 0
        <span style="color: #a020f0;">mov</span> ds, cx

        <span style="color: #a020f0;">mov</span> [0x7c00+buffer], dl <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;dl&#20013;&#30340;&#23383;&#31526;&#32534;&#30721;0x35&#20256;&#36865;&#21040;&#27573;&#20869;&#36825;&#20010;&#20559;&#31227;&#22320;&#22336;&#22788;&#12290;&#21363;&#31532;1&#20010;0&#22788;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#35299;&#31532;2&#20010;&#25968;&#20301;&#65292;&#23558;&#25968;&#20301;&#23545;&#24212;&#23383;&#31526;&#23384;&#25918;&#22312; db 0,0,0,0,0 &#30340;&#31532;2&#20010;&#23383;&#33410;&#37324;</span>
        <span style="color: #a020f0;">xor</span> dx, dx          <span style="color: #b22222;">;</span><span style="color: #b22222;">dx&#28165;&#38646;&#65292;&#22240;&#20026;&#23427;&#26159;&#34987;&#38500;&#25968;&#30340;&#39640;16&#20301;</span>
        <span style="color: #a020f0;">div</span> bx
        <span style="color: #a020f0;">add</span> dl, 0x30        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25968;&#23383;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#25968;&#23383;&#23383;&#31526;</span>
        <span style="color: #a020f0;">mov</span> [0x7c00+buffer+1], dl <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;dl&#20013;&#30340;&#23383;&#31526;&#32534;&#30721;0x33&#20256;&#36865;&#21040;&#27573;&#20869;&#36825;&#20010;&#20559;&#31227;&#22320;&#22336;&#22788;&#12290;&#21363;&#31532;2&#20010;0&#22788;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#35299;&#31532;3&#20010;&#25968;&#20301;&#65292;&#23558;&#25968;&#20301;&#23545;&#24212;&#23383;&#31526;&#23384;&#25918;&#22312; db 0,0,0,0,0 &#30340;&#31532;3&#20010;&#23383;&#33410;&#37324;</span>
        <span style="color: #a020f0;">xor</span> dx, dx          <span style="color: #b22222;">;</span><span style="color: #b22222;">dx&#28165;&#38646;&#65292;&#22240;&#20026;&#23427;&#26159;&#34987;&#38500;&#25968;&#30340;&#39640;16&#20301;</span>
        <span style="color: #a020f0;">div</span> bx
        <span style="color: #a020f0;">add</span> dl, 0x30        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25968;&#23383;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#25968;&#23383;&#23383;&#31526;</span>
        <span style="color: #a020f0;">mov</span> [0x7c00+buffer+2], dl <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;dl&#20013;&#30340;&#23383;&#31526;&#32534;&#30721;0x35&#20256;&#36865;&#21040;&#27573;&#20869;&#36825;&#20010;&#20559;&#31227;&#22320;&#22336;&#22788;&#12290;&#21363;&#31532;3&#20010;0&#22788;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#35299;&#31532;4&#20010;&#25968;&#20301;&#65292;&#23558;&#25968;&#20301;&#23545;&#24212;&#23383;&#31526;&#23384;&#25918;&#22312; db 0,0,0,0,0 &#30340;&#31532;4&#20010;&#23383;&#33410;&#37324;</span>
        <span style="color: #a020f0;">xor</span> dx, dx          <span style="color: #b22222;">;</span><span style="color: #b22222;">dx&#28165;&#38646;&#65292;&#22240;&#20026;&#23427;&#26159;&#34987;&#38500;&#25968;&#30340;&#39640;16&#20301;</span>
        <span style="color: #a020f0;">div</span> bx
        <span style="color: #a020f0;">add</span> dl, 0x30        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25968;&#23383;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#25968;&#23383;&#23383;&#31526;</span>
        <span style="color: #a020f0;">mov</span> [0x7c00+buffer+3], dl <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;dl&#20013;&#30340;&#23383;&#31526;&#32534;&#30721;0x35&#20256;&#36865;&#21040;&#27573;&#20869;&#36825;&#20010;&#20559;&#31227;&#22320;&#22336;&#22788;&#12290;&#21363;&#31532;4&#20010;0&#22788;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#35299;&#26368;&#21518;&#19968;&#20010;&#25968;&#20301;&#65292;&#23558;&#25968;&#20301;&#23545;&#24212;&#23383;&#31526;&#23384;&#25918;&#22312; db 0,0,0,0,0 &#30340;&#31532;5&#20010;&#23383;&#33410;&#37324;</span>
        <span style="color: #a020f0;">xor</span> dx, dx          <span style="color: #b22222;">;</span><span style="color: #b22222;">dx&#28165;&#38646;&#65292;&#22240;&#20026;&#23427;&#26159;&#34987;&#38500;&#25968;&#30340;&#39640;16&#20301;</span>
        <span style="color: #a020f0;">div</span> bx
        <span style="color: #a020f0;">add</span> dl, 0x30        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25968;&#23383;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#25968;&#23383;&#23383;&#31526;</span>
        <span style="color: #a020f0;">mov</span> [0x7c00+buffer+4], dl <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;dl&#20013;&#30340;&#23383;&#31526;&#32534;&#30721;0x36&#20256;&#36865;&#21040;&#27573;&#20869;&#36825;&#20010;&#20559;&#31227;&#22320;&#22336;&#22788;&#12290;&#21363;&#31532;5&#20010;0&#22788;</span>

<span style="color: #0000ff;">buffer</span>  <span style="color: #a020f0;">db</span> 0, 0, 0, 0,0     <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24320;&#36767;5&#20010;&#23383;&#33410;&#31354;&#38388;</span>

<span style="color: #0000ff;">current</span>:
        <span style="color: #a020f0;">times</span> 510-(current-start) db 0

        <span style="color: #a020f0;">db</span> 0x55, 0xaa
</pre>
</div>
</div>
</div>
<div id="outline-container-h:adb941c1-9a70-4979-85ee-6760793cd4ff" class="outline-3">
<h3 id="h:adb941c1-9a70-4979-85ee-6760793cd4ff">段超越前缀的使用</h3>
<div class="outline-text-3" id="text-h:adb941c1-9a70-4979-85ee-6760793cd4ff">
<blockquote>
<p>
如何使用段超越前缀在两个数据段之间协作工作
</p>
</blockquote>

<p>
上一节中，我们已经完成了数位的分解并将数字字符存放在内存中。这一节我们将数字字符写入显存，然后就能在显示器上看到了。
</p>

<p>
因为intel处理器不允许指定的2个操作数都是内存地址，所以要使用寄存器中转。
</p>

<p>
取字符，传送第1个字符
</p>
<ul class="org-ul">
<li>首先把最后一次分解出来的字符，临时保存到寄存器al中。 <code>mov al, [0x7c00+buffer+4]</code></li>
<li>将寄存器的字符编码传送到显存内偏移地址为0的地方。显存的访问也是按照段地址加偏移地址进行
<ul class="org-ul">
<li>显存的段地址是B800。在访问显存前，必须把B800传送到数据段寄存器DS中，传送段地址也必须要用通用寄存器中转，不能直接传送。 <code>mov cx, 0xb800</code> , <code>mov ds, cx</code></li>
</ul></li>
<li>最后，将寄存器AL中的字符编码写入显存内偏移地址为0的地方。 <code>mov [0x00], al</code>
<ul class="org-ul">
<li>同时再写入一个颜色属性， <code>mov byte [0x01], 0x2f</code> 绿底白字</li>
</ul></li>
</ul>

<p>
取下一个字符时
</p>
<ul class="org-ul">
<li>将数据段寄存器变回来 <code>mov cx, 0</code> , <code>mov ds, cx</code> ，才能取到第2个字符</li>
<li>取第2个字符 <code>mov al, [0x7c00+buffer+3]</code></li>
<li>指向显存的段地址 <code>mov cx, 0xb800</code> , <code>mov ds, cx</code></li>
<li>存放 <code>mov [0x02], al</code> ,  <code>mov byte [0x03], 0x2f</code></li>
</ul>

<p>
以此类推，exam.asm修改如下
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">start</span>:
        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#22312;&#23631;&#24149;&#19978;&#26174;&#31034;&#25968;&#23383;65535</span>
        <span style="color: #a020f0;">mov</span> ax, 65535
        <span style="color: #a020f0;">xor</span> dx, dx          <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#20215;&#20110;mov dx, 0</span>
        <span style="color: #a020f0;">mov</span> bx, 10
        <span style="color: #a020f0;">div</span> bx              <span style="color: #b22222;">;</span><span style="color: #b22222;">AX=&#21830;(6553), DX=&#20313;&#25968;(5)</span>

        <span style="color: #a020f0;">add</span> dl, 0x30        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25968;&#23383;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#25968;&#23383;&#23383;&#31526;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#27573;&#23492;&#23384;ds&#20869;&#23481;&#65292; 0</span>
        <span style="color: #a020f0;">mov</span> cx, 0
        <span style="color: #a020f0;">mov</span> ds, cx

        <span style="color: #a020f0;">mov</span> [0x7c00+buffer], dl <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;dl&#20013;&#30340;&#23383;&#31526;&#32534;&#30721;0x35&#20256;&#36865;&#21040;&#27573;&#20869;&#36825;&#20010;&#20559;&#31227;&#22320;&#22336;&#22788;&#12290;&#21363;&#31532;1&#20010;0&#22788;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#35299;&#31532;2&#20010;&#25968;&#20301;&#65292;&#23558;&#25968;&#20301;&#23545;&#24212;&#23383;&#31526;&#23384;&#25918;&#22312; db 0,0,0,0,0 &#30340;&#31532;2&#20010;&#23383;&#33410;&#37324;</span>
        <span style="color: #a020f0;">xor</span> dx, dx          <span style="color: #b22222;">;</span><span style="color: #b22222;">dx&#28165;&#38646;&#65292;&#22240;&#20026;&#23427;&#26159;&#34987;&#38500;&#25968;&#30340;&#39640;16&#20301;</span>
        <span style="color: #a020f0;">div</span> bx
        <span style="color: #a020f0;">add</span> dl, 0x30        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25968;&#23383;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#25968;&#23383;&#23383;&#31526;</span>
        <span style="color: #a020f0;">mov</span> [0x7c00+buffer+1], dl <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;dl&#20013;&#30340;&#23383;&#31526;&#32534;&#30721;0x33&#20256;&#36865;&#21040;&#27573;&#20869;&#36825;&#20010;&#20559;&#31227;&#22320;&#22336;&#22788;&#12290;&#21363;&#31532;2&#20010;0&#22788;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#35299;&#31532;3&#20010;&#25968;&#20301;&#65292;&#23558;&#25968;&#20301;&#23545;&#24212;&#23383;&#31526;&#23384;&#25918;&#22312; db 0,0,0,0,0 &#30340;&#31532;3&#20010;&#23383;&#33410;&#37324;</span>
        <span style="color: #a020f0;">xor</span> dx, dx          <span style="color: #b22222;">;</span><span style="color: #b22222;">dx&#28165;&#38646;&#65292;&#22240;&#20026;&#23427;&#26159;&#34987;&#38500;&#25968;&#30340;&#39640;16&#20301;</span>
        <span style="color: #a020f0;">div</span> bx
        <span style="color: #a020f0;">add</span> dl, 0x30        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25968;&#23383;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#25968;&#23383;&#23383;&#31526;</span>
        <span style="color: #a020f0;">mov</span> [0x7c00+buffer+2], dl <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;dl&#20013;&#30340;&#23383;&#31526;&#32534;&#30721;0x35&#20256;&#36865;&#21040;&#27573;&#20869;&#36825;&#20010;&#20559;&#31227;&#22320;&#22336;&#22788;&#12290;&#21363;&#31532;3&#20010;0&#22788;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#35299;&#31532;4&#20010;&#25968;&#20301;&#65292;&#23558;&#25968;&#20301;&#23545;&#24212;&#23383;&#31526;&#23384;&#25918;&#22312; db 0,0,0,0,0 &#30340;&#31532;4&#20010;&#23383;&#33410;&#37324;</span>
        <span style="color: #a020f0;">xor</span> dx, dx          <span style="color: #b22222;">;</span><span style="color: #b22222;">dx&#28165;&#38646;&#65292;&#22240;&#20026;&#23427;&#26159;&#34987;&#38500;&#25968;&#30340;&#39640;16&#20301;</span>
        <span style="color: #a020f0;">div</span> bx
        <span style="color: #a020f0;">add</span> dl, 0x30        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25968;&#23383;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#25968;&#23383;&#23383;&#31526;</span>
        <span style="color: #a020f0;">mov</span> [0x7c00+buffer+3], dl <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;dl&#20013;&#30340;&#23383;&#31526;&#32534;&#30721;0x35&#20256;&#36865;&#21040;&#27573;&#20869;&#36825;&#20010;&#20559;&#31227;&#22320;&#22336;&#22788;&#12290;&#21363;&#31532;4&#20010;0&#22788;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#35299;&#26368;&#21518;&#19968;&#20010;&#25968;&#20301;&#65292;&#23558;&#25968;&#20301;&#23545;&#24212;&#23383;&#31526;&#23384;&#25918;&#22312; db 0,0,0,0,0 &#30340;&#31532;5&#20010;&#23383;&#33410;&#37324;</span>
        <span style="color: #a020f0;">xor</span> dx, dx          <span style="color: #b22222;">;</span><span style="color: #b22222;">dx&#28165;&#38646;&#65292;&#22240;&#20026;&#23427;&#26159;&#34987;&#38500;&#25968;&#30340;&#39640;16&#20301;</span>
        <span style="color: #a020f0;">div</span> bx
        <span style="color: #a020f0;">add</span> dl, 0x30        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25968;&#23383;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#25968;&#23383;&#23383;&#31526;</span>
        <span style="color: #a020f0;">mov</span> [0x7c00+buffer+4], dl <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;dl&#20013;&#30340;&#23383;&#31526;&#32534;&#30721;0x36&#20256;&#36865;&#21040;&#27573;&#20869;&#36825;&#20010;&#20559;&#31227;&#22320;&#22336;&#22788;&#12290;&#21363;&#31532;5&#20010;0&#22788;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#21035;&#23558;&#23383;&#31526;&#20256;&#36865;&#21040;&#26174;&#23384;&#20013;</span>
        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31532;1&#20010;&#23383;&#31526;</span>
        <span style="color: #a020f0;">mov</span> al, [0x7c00+buffer+4]

        <span style="color: #a020f0;">mov</span> cx, 0xb800
        <span style="color: #a020f0;">mov</span> ds, cx

        <span style="color: #a020f0;">mov</span> [0x00], al
        <span style="color: #a020f0;">mov</span> byte [0x01], 0x2f

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31532;2&#20010;&#23383;&#31526;</span>
        <span style="color: #a020f0;">mov</span> cx, 0
        <span style="color: #a020f0;">mov</span> ds, cx

        <span style="color: #a020f0;">mov</span> al, [0x7c00+buffer+3]

        <span style="color: #a020f0;">mov</span> cx, 0xb800
        <span style="color: #a020f0;">mov</span> ds, cx

        <span style="color: #a020f0;">mov</span> [0x02], al
        <span style="color: #a020f0;">mov</span> byte [0x03], 0x2f

        <span style="color: #b22222;">; </span><span style="color: #b22222;">&#19968;&#30452;&#21040;&#31532;5&#20010;&#23383;&#31526;....</span>

<span style="color: #0000ff;">buffer</span>  <span style="color: #a020f0;">db</span> 0, 0, 0, 0,0     <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24320;&#36767;5&#20010;&#23383;&#33410;&#31354;&#38388;</span>

<span style="color: #0000ff;">current</span>:
        <span style="color: #a020f0;">times</span> 510-(current-start) db 0

        <span style="color: #a020f0;">db</span> 0x55, 0xaa
</pre>
</div>

<p>
将数据段寄存器DS的值变来变去，很麻烦。为了在2个段之间进行操作，8086处理还多准备了一个数据段寄存器ES，附加段寄存器。
</p>
<ul class="org-ul">
<li>为了取数字字符可以使用段寄存器DS</li>
<li>为了操作显存可以使用附加段寄存器ES</li>
</ul>

<p>
exam.asm修改如下
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">start</span>:
        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#22312;&#23631;&#24149;&#19978;&#26174;&#31034;&#25968;&#23383;65535</span>
        <span style="color: #a020f0;">mov</span> ax, 65535
        <span style="color: #a020f0;">xor</span> dx, dx          <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#20215;&#20110;mov dx, 0</span>
        <span style="color: #a020f0;">mov</span> bx, 10
        <span style="color: #a020f0;">div</span> bx              <span style="color: #b22222;">;</span><span style="color: #b22222;">AX=&#21830;(6553), DX=&#20313;&#25968;(5)</span>

        <span style="color: #a020f0;">add</span> dl, 0x30        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25968;&#23383;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#25968;&#23383;&#23383;&#31526;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#27573;&#23492;&#23384;ds&#20869;&#23481;&#65292; 0</span>
        <span style="color: #a020f0;">mov</span> cx, 0
        <span style="color: #a020f0;">mov</span> ds, cx

        <span style="color: #a020f0;">mov</span> [0x7c00+buffer], dl <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;dl&#20013;&#30340;&#23383;&#31526;&#32534;&#30721;0x35&#20256;&#36865;&#21040;&#27573;&#20869;&#36825;&#20010;&#20559;&#31227;&#22320;&#22336;&#22788;&#12290;&#21363;&#31532;1&#20010;0&#22788;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#35299;&#31532;2&#20010;&#25968;&#20301;&#65292;&#23558;&#25968;&#20301;&#23545;&#24212;&#23383;&#31526;&#23384;&#25918;&#22312; db 0,0,0,0,0 &#30340;&#31532;2&#20010;&#23383;&#33410;&#37324;</span>
        <span style="color: #a020f0;">xor</span> dx, dx          <span style="color: #b22222;">;</span><span style="color: #b22222;">dx&#28165;&#38646;&#65292;&#22240;&#20026;&#23427;&#26159;&#34987;&#38500;&#25968;&#30340;&#39640;16&#20301;</span>
        <span style="color: #a020f0;">div</span> bx
        <span style="color: #a020f0;">add</span> dl, 0x30        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25968;&#23383;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#25968;&#23383;&#23383;&#31526;</span>
        <span style="color: #a020f0;">mov</span> [0x7c00+buffer+1], dl <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;dl&#20013;&#30340;&#23383;&#31526;&#32534;&#30721;0x33&#20256;&#36865;&#21040;&#27573;&#20869;&#36825;&#20010;&#20559;&#31227;&#22320;&#22336;&#22788;&#12290;&#21363;&#31532;2&#20010;0&#22788;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#35299;&#31532;3&#20010;&#25968;&#20301;&#65292;&#23558;&#25968;&#20301;&#23545;&#24212;&#23383;&#31526;&#23384;&#25918;&#22312; db 0,0,0,0,0 &#30340;&#31532;3&#20010;&#23383;&#33410;&#37324;</span>
        <span style="color: #a020f0;">xor</span> dx, dx          <span style="color: #b22222;">;</span><span style="color: #b22222;">dx&#28165;&#38646;&#65292;&#22240;&#20026;&#23427;&#26159;&#34987;&#38500;&#25968;&#30340;&#39640;16&#20301;</span>
        <span style="color: #a020f0;">div</span> bx
        <span style="color: #a020f0;">add</span> dl, 0x30        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25968;&#23383;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#25968;&#23383;&#23383;&#31526;</span>
        <span style="color: #a020f0;">mov</span> [0x7c00+buffer+2], dl <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;dl&#20013;&#30340;&#23383;&#31526;&#32534;&#30721;0x35&#20256;&#36865;&#21040;&#27573;&#20869;&#36825;&#20010;&#20559;&#31227;&#22320;&#22336;&#22788;&#12290;&#21363;&#31532;3&#20010;0&#22788;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#35299;&#31532;4&#20010;&#25968;&#20301;&#65292;&#23558;&#25968;&#20301;&#23545;&#24212;&#23383;&#31526;&#23384;&#25918;&#22312; db 0,0,0,0,0 &#30340;&#31532;4&#20010;&#23383;&#33410;&#37324;</span>
        <span style="color: #a020f0;">xor</span> dx, dx          <span style="color: #b22222;">;</span><span style="color: #b22222;">dx&#28165;&#38646;&#65292;&#22240;&#20026;&#23427;&#26159;&#34987;&#38500;&#25968;&#30340;&#39640;16&#20301;</span>
        <span style="color: #a020f0;">div</span> bx
        <span style="color: #a020f0;">add</span> dl, 0x30        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25968;&#23383;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#25968;&#23383;&#23383;&#31526;</span>
        <span style="color: #a020f0;">mov</span> [0x7c00+buffer+3], dl <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;dl&#20013;&#30340;&#23383;&#31526;&#32534;&#30721;0x35&#20256;&#36865;&#21040;&#27573;&#20869;&#36825;&#20010;&#20559;&#31227;&#22320;&#22336;&#22788;&#12290;&#21363;&#31532;4&#20010;0&#22788;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#35299;&#26368;&#21518;&#19968;&#20010;&#25968;&#20301;&#65292;&#23558;&#25968;&#20301;&#23545;&#24212;&#23383;&#31526;&#23384;&#25918;&#22312; db 0,0,0,0,0 &#30340;&#31532;5&#20010;&#23383;&#33410;&#37324;</span>
        <span style="color: #a020f0;">xor</span> dx, dx          <span style="color: #b22222;">;</span><span style="color: #b22222;">dx&#28165;&#38646;&#65292;&#22240;&#20026;&#23427;&#26159;&#34987;&#38500;&#25968;&#30340;&#39640;16&#20301;</span>
        <span style="color: #a020f0;">div</span> bx
        <span style="color: #a020f0;">add</span> dl, 0x30        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25968;&#23383;&#36716;&#25442;&#20026;&#23545;&#24212;&#30340;&#25968;&#23383;&#23383;&#31526;</span>
        <span style="color: #a020f0;">mov</span> [0x7c00+buffer+4], dl <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;dl&#20013;&#30340;&#23383;&#31526;&#32534;&#30721;0x36&#20256;&#36865;&#21040;&#27573;&#20869;&#36825;&#20010;&#20559;&#31227;&#22320;&#22336;&#22788;&#12290;&#21363;&#31532;5&#20010;0&#22788;</span>


        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#21035;&#23558;&#23383;&#31526;&#20256;&#36865;&#21040;&#26174;&#23384;&#20013;</span>
        <span style="color: #a020f0;">mov</span> cx, 0xb800
        <span style="color: #a020f0;">mov</span> es, cx <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#26174;&#23384;&#27573;&#22320;&#22336;b800&#20256;&#36865;&#21040;&#38468;&#21152;&#27573;&#23492;&#23384;&#22120;ES&#20013;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31532;1&#20010;&#23383;&#31526;</span>
        <span style="color: #a020f0;">mov</span> al, [0x7c00+buffer+4]   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#22914;&#26524;&#27809;&#26377;&#29305;&#21035;&#25351;&#21517;&#65292;&#40664;&#35748;&#20351;&#29992;&#27573;&#23492;&#23384;&#22120;DS</span>
        <span style="color: #a020f0;">mov</span> [es:0x00], al           <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20351;&#29992;&#27573;&#23492;&#23384;&#22120;es&#26469;&#22635;&#20805;&#26174;&#23384;</span>
        <span style="color: #a020f0;">mov</span> byte [es:0x01], 0x2f    <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20889;&#20837;&#39068;&#33394;&#23646;&#24615;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31532;2~5&#20010;&#23383;&#31526;</span>
        <span style="color: #a020f0;">mov</span> al, [0x7c00+buffer+3]
        <span style="color: #a020f0;">mov</span> [es:0x02], al
        <span style="color: #a020f0;">mov</span> byte [es:0x03], 0x2f

        <span style="color: #a020f0;">mov</span> al, [0x7c00+buffer+2]
        <span style="color: #a020f0;">mov</span> [es:0x04], al
        <span style="color: #a020f0;">mov</span> byte [es:0x05], 0x2f

        <span style="color: #a020f0;">mov</span> al, [0x7c00+buffer+1]
        <span style="color: #a020f0;">mov</span> [es:0x06], al
        <span style="color: #a020f0;">mov</span> byte [es:0x07], 0x2f

        <span style="color: #a020f0;">mov</span> al, [0x7c00+buffer]
        <span style="color: #a020f0;">mov</span> [es:0x08], al
        <span style="color: #a020f0;">mov</span> byte [es:0x09], 0x2f

<span style="color: #0000ff;">again</span>:
        <span style="color: #a020f0;">jmp</span> again

<span style="color: #0000ff;">buffer</span>  <span style="color: #a020f0;">db</span> 0, 0, 0, 0,0     <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24320;&#36767;5&#20010;&#23383;&#33410;&#31354;&#38388;</span>

<span style="color: #0000ff;">current</span>:
        <span style="color: #a020f0;">times</span> 510-(current-start) db 0

        <span style="color: #a020f0;">db</span> 0x55, 0xaa
</pre>
</div>

<p>
<code>[段寄存器:偏移地址]</code> 叫做段超越前缀。如果没有使用段超越前缀，默认是在ds中。
</p>


<p>
编译
</p>
<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm exam.asm -f bin -o exam.bin -l exam.lst
</pre>
</div>


<p>
将2进制程序写入虚拟硬盘文件learn.vhd
</p>
<ul class="org-ul">
<li>方法1 fixvhdwr.exe 用自定义的程序导入。
<ul class="org-ul">
<li>LBA连续直写模式，起始LBA区号为0</li>
</ul></li>
<li>方法2 其他有效方法</li>
</ul>

<p>
打开bochs调试器bochsdbg.exe进行调试。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26029;&#28857;&#21040;&#29289;&#29702;&#22320;&#22336;7c00&#65292;&#22240;&#20026;ROM BIOS&#25191;&#34892;&#21518;&#26368;&#21518;&#30340;&#24037;&#20316;&#26159;&#25226;&#20027;&#24341;&#23548;&#25159;&#21306;&#25968;&#25454;&#35835;&#20837;&#21040;&#20869;&#23384;&#30340;&#29289;&#29702;&#22320;&#22336;7c00&#22788;</span>
Next at <span style="color: #a0522d;">t</span>=0
(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0
&lt;bochs:1&gt; b 0x7c00
&lt;bochs:2&gt; c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22788;&#29702;&#22120;&#36830;&#32493;&#22320;&#25191;&#34892;&#65292;&#36935;&#21040;&#26029;&#28857;&#20572;&#19979;</span>
......
Next at <span style="color: #a0522d;">t</span>=17175563  <span style="color: #b22222;">#</span><span style="color: #b22222;">16&#36827;&#21046;&#30340;17a&#31561;&#20110;10&#36827;&#21046;&#30340;378</span>
(0) [0x000000007c00] 0000:7c00 (unk. ctxt): mov ax, 0xffff            ; b8ffff

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21453;&#27719;&#32534;&#26597;&#30475;&#19968;&#19979;</span>
&lt;bochs:3&gt; u /32
0000000000007c00: (                    ): mov ax, 0xffff            ; b8ffff
0000000000007c03: (                    ): xor dx, dx                ; 31d2
0000000000007c05: (                    ): mov bx, 0x000a            ; bb0a00
0000000000007c08: (                    ): div ax, bx                ; f7f3
......

<span style="color: #b22222;">#</span>
&lt;bochs:4&gt; s
Next at <span style="color: #a0522d;">t</span>=17175564
(0) [0x000000007c03] 0000:7c03 (unk. ctxt): xor dx, dx                ; 31d2
&lt;bochs:5&gt; s
Next at <span style="color: #a0522d;">t</span>=17175565
(0) [0x000000007c05] 0000:7c05 (unk. ctxt): mov bx, 0x000a            ; bb0a00
&lt;bochs:6&gt; s
Next at <span style="color: #a0522d;">t</span>=17175566
(0) [0x000000007c08] 0000:7c08 (unk. ctxt): div ax, bx                ; f7f3
&lt;bochs:6&gt; c
</pre>
</div>



<figure id="orgadbff04">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241124_202546.png" alt="img_20241124_202546.png" width="90%">

</figure>
</div>
</div>
<div id="outline-container-h:3cc6d271-9b4f-423d-b1ea-ddcf866bef26" class="outline-3">
<h3 id="h:3cc6d271-9b4f-423d-b1ea-ddcf866bef26">显示标号的汇编地址</h3>
<div class="outline-text-3" id="text-h:3cc6d271-9b4f-423d-b1ea-ddcf866bef26">
<p>
其他例子
</p>

<div class="org-src-container">
<pre class="src src-asm">       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20195;&#30721;&#28165;&#21333;5-1</span>
       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#25991;&#20214;&#21517;&#65306;c05_mbr.asm</span>
       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#25991;&#20214;&#35828;&#26126;&#65306;&#30828;&#30424;&#20027;&#24341;&#23548;&#25159;&#21306;&#20195;&#30721;</span>

       <span style="color: #a020f0;">mov</span> ax,0xb800                 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#25351;&#21521;&#25991;&#26412;&#27169;&#24335;&#30340;&#26174;&#31034;&#32531;&#20914;&#21306;</span>
       <span style="color: #a020f0;">mov</span> es,ax

       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20197;&#19979;&#26174;&#31034;&#23383;&#31526;&#20018;"Label offset:"</span>
       <span style="color: #a020f0;">mov</span> byte [es:0x00],'L'
       <span style="color: #a020f0;">mov</span> byte [es:0x01],0x07
       <span style="color: #a020f0;">mov</span> byte [es:0x02],'a'
       <span style="color: #a020f0;">mov</span> byte [es:0x03],0x07
       <span style="color: #a020f0;">mov</span> byte [es:0x04],'b'
       <span style="color: #a020f0;">mov</span> byte [es:0x05],0x07
       <span style="color: #a020f0;">mov</span> byte [es:0x06],'e'
       <span style="color: #a020f0;">mov</span> byte [es:0x07],0x07
       <span style="color: #a020f0;">mov</span> byte [es:0x08],'l'
       <span style="color: #a020f0;">mov</span> byte [es:0x09],0x07
       <span style="color: #a020f0;">mov</span> byte [es:0x0a],' '
       <span style="color: #a020f0;">mov</span> byte [es:0x0b],0x07
       <span style="color: #a020f0;">mov</span> byte [es:0x0c],<span style="color: #8b2252;">"o"</span>
       <span style="color: #a020f0;">mov</span> byte [es:0x0d],0x07
       <span style="color: #a020f0;">mov</span> byte [es:0x0e],'f'
       <span style="color: #a020f0;">mov</span> byte [es:0x0f],0x07
       <span style="color: #a020f0;">mov</span> byte [es:0x10],'f'
       <span style="color: #a020f0;">mov</span> byte [es:0x11],0x07
       <span style="color: #a020f0;">mov</span> byte [es:0x12],'s'
       <span style="color: #a020f0;">mov</span> byte [es:0x13],0x07
       <span style="color: #a020f0;">mov</span> byte [es:0x14],'e'
       <span style="color: #a020f0;">mov</span> byte [es:0x15],0x07
       <span style="color: #a020f0;">mov</span> byte [es:0x16],'t'
       <span style="color: #a020f0;">mov</span> byte [es:0x17],0x07
       <span style="color: #a020f0;">mov</span> byte [es:0x18],':'
       <span style="color: #a020f0;">mov</span> byte [es:0x19],0x07

       <span style="color: #a020f0;">mov</span> ax,number                 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#21462;&#24471;&#26631;&#21495;number&#30340;&#27719;&#32534;&#22320;&#22336;</span>
       <span style="color: #a020f0;">mov</span> bx,10

       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#25968;&#25454;&#27573;&#30340;&#22522;&#22320;&#22336;</span>
       <span style="color: #a020f0;">mov</span> cx,cs
       <span style="color: #a020f0;">mov</span> ds,cx

       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27714;&#20010;&#20301;&#19978;&#30340;&#25968;&#23383;</span>
       <span style="color: #a020f0;">mov</span> dx,0
       <span style="color: #a020f0;">div</span> bx
       <span style="color: #a020f0;">mov</span> [0x7c00+number+0x00],dl   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20445;&#23384;&#20010;&#20301;&#19978;&#30340;&#25968;&#23383;</span>

       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27714;&#21313;&#20301;&#19978;&#30340;&#25968;&#23383;</span>
       <span style="color: #a020f0;">xor</span> dx,dx
       <span style="color: #a020f0;">div</span> bx
       <span style="color: #a020f0;">mov</span> [0x7c00+number+0x01],dl   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20445;&#23384;&#21313;&#20301;&#19978;&#30340;&#25968;&#23383;</span>

       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27714;&#30334;&#20301;&#19978;&#30340;&#25968;&#23383;</span>
       <span style="color: #a020f0;">xor</span> dx,dx
       <span style="color: #a020f0;">div</span> bx
       <span style="color: #a020f0;">mov</span> [0x7c00+number+0x02],dl   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20445;&#23384;&#30334;&#20301;&#19978;&#30340;&#25968;&#23383;</span>

       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27714;&#21315;&#20301;&#19978;&#30340;&#25968;&#23383;</span>
       <span style="color: #a020f0;">xor</span> dx,dx
       <span style="color: #a020f0;">div</span> bx
       <span style="color: #a020f0;">mov</span> [0x7c00+number+0x03],dl   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20445;&#23384;&#21315;&#20301;&#19978;&#30340;&#25968;&#23383;</span>

       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27714;&#19975;&#20301;&#19978;&#30340;&#25968;&#23383;</span>
       <span style="color: #a020f0;">xor</span> dx,dx
       <span style="color: #a020f0;">div</span> bx
       <span style="color: #a020f0;">mov</span> [0x7c00+number+0x04],dl   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20445;&#23384;&#19975;&#20301;&#19978;&#30340;&#25968;&#23383;</span>

       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20197;&#19979;&#29992;&#21313;&#36827;&#21046;&#26174;&#31034;&#26631;&#21495;&#30340;&#20559;&#31227;&#22320;&#22336;</span>
       <span style="color: #a020f0;">mov</span> al,[0x7c00+number+0x04]
       <span style="color: #a020f0;">add</span> al,0x30
       <span style="color: #a020f0;">mov</span> [es:0x1a],al
       <span style="color: #a020f0;">mov</span> byte [es:0x1b],0x04

       <span style="color: #a020f0;">mov</span> al,[0x7c00+number+0x03]
       <span style="color: #a020f0;">add</span> al,0x30
       <span style="color: #a020f0;">mov</span> [es:0x1c],al
       <span style="color: #a020f0;">mov</span> byte [es:0x1d],0x04

       <span style="color: #a020f0;">mov</span> al,[0x7c00+number+0x02]
       <span style="color: #a020f0;">add</span> al,0x30
       <span style="color: #a020f0;">mov</span> [es:0x1e],al
       <span style="color: #a020f0;">mov</span> byte [es:0x1f],0x04

       <span style="color: #a020f0;">mov</span> al,[0x7c00+number+0x01]
       <span style="color: #a020f0;">add</span> al,0x30
       <span style="color: #a020f0;">mov</span> [es:0x20],al
       <span style="color: #a020f0;">mov</span> byte [es:0x21],0x04

       <span style="color: #a020f0;">mov</span> al,[0x7c00+number+0x00]
       <span style="color: #a020f0;">add</span> al,0x30
       <span style="color: #a020f0;">mov</span> [es:0x22],al
       <span style="color: #a020f0;">mov</span> byte [es:0x23],0x04

       <span style="color: #a020f0;">mov</span> byte [es:0x24],'D'
       <span style="color: #a020f0;">mov</span> byte [es:0x25],0x07

 <span style="color: #a020f0;">infi</span>: jmp near infi                 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#26080;&#38480;&#24490;&#29615;</span>

<span style="color: #0000ff;">number</span> <span style="color: #a020f0;">db</span> 0,0,0,0,0

<span style="color: #0000ff;">times</span> <span style="color: #a020f0;">203</span> db 0
          <span style="color: #a020f0;">db</span> 0x55,0xaa
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:23336122-a35c-4396-a634-00fff782a953" class="outline-2">
<h2 id="h:23336122-a35c-4396-a634-00fff782a953">阶段性重点内容总结</h2>
<div class="outline-text-2" id="text-h:23336122-a35c-4396-a634-00fff782a953">
<p>
<b>标号</b>
</p>

<pre class="example" id="orgbed1f8e">
标号可以由以下字符组成
字母  数字  _ $ # @ ~ . ?

其中，可以做打头字符的是
字母 . _ ?

标号后面可以后一个冒号，但是它不是标号的一部分
</pre>

<p>
标号的作用是定伪指令或数据。在编写程序时，标号代表指令或者数据的汇编地址。
</p>

<p>
在程序运行时，处理器使用段地址和段内偏移地址。程序在运行前要先加载到某个内存段，如果是从段的起始处加载，
那么汇编地址等于偏移地址。
</p>


<p>
<b>数据长度</b>
</p>

<ul class="org-ul">
<li>在需要两个操作数的指令中，如果至少有一个是寄存器，则不需要长度修饰符。如</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">mov ah, al
mov [buffer], ax
xor byte [buffer], 0x55
</pre>
</div>

<ul class="org-ul">
<li>如果只有一个操作数且不是寄存器，必须使用长度修饰符。如</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">div word [divisor]
</pre>
</div>

<p>
<b>伪指令定义数据</b>
</p>

<ul class="org-ul">
<li>伪指令db用来定义字节(8位)长度的数据。如db 0x55</li>
<li>伪指令dw用来定义字(16位)长度的数据。如db 0x55aa</li>
<li>伪指令dd用来定义双字(32位)长度的数据。如db 0xabcd1234</li>
<li>伪指令dq用来定义四字(64位)长度的数据。如db 0x12345678aabbccdd</li>

<li>伪指令times用来重复后面的指令若干次。如</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">times</span> 5 mov ax, bx

&#31561;&#20215;&#20110;
mov ax, bx
mov ax, bx
mov ax, bx
mov ax, bx
mov ax, bx
</pre>
</div>
</div>
</section>
<section id="outline-container-h:544cb817-8d52-4ba4-a57a-ff5d08aeb209" class="outline-2">
<h2 id="h:544cb817-8d52-4ba4-a57a-ff5d08aeb209">循环批量传送和条件转移</h2>
<div class="outline-text-2" id="text-h:544cb817-8d52-4ba4-a57a-ff5d08aeb209">
<p>
主要内容
</p>

<ul class="org-ul">
<li>跳过非指令的数据区</li>
<li>逻辑段地址的重新设定</li>
<li>串传送指令和标志寄存器</li>
<li>NASM的$和$$记号</li>
<li>使用循环指令LOOP分解数位</li>
<li>基址寻址和INC指令</li>
<li>数字的显示和DEC指令</li>
<li>基址变址寻址和条件转移指令</li>
</ul>
</div>
<div id="outline-container-h:afd95d3f-62c2-4627-8fce-413d430ab250" class="outline-3">
<h3 id="h:afd95d3f-62c2-4627-8fce-413d430ab250">跳过非指令的数据区</h3>
<div class="outline-text-3" id="text-h:afd95d3f-62c2-4627-8fce-413d430ab250">
<blockquote>
<p>
当数据和指令混合时，如何避免执行到这些指令的数据。
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x00], 'L'
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">byte</span> [0x01], 0x2f
</pre>
</div>

<p>
字符和指令绑定在一起很原始也很笨拙，如果要显示的内容很多，不但需要大量的指令而且修改也很麻烦。
</p>

<p>
这里将文本内容和显示他们的指令分开。需要专门定义一个存放字符串的数据区，当我们要显示它们时再用指令取出。
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mytext</span> <span style="color: #a020f0;">db</span> 'L',0x07,'a',0x07,'b',0x07,'l',0x07,'e',0x07,' ',0x07,'o',0x07,\
          'f',0x07,'f',0x07,'s',0x07,'e',0x07,'t',0x07,':',0x07
</pre>
</div>

<p>
字符的字面形式和显示的颜色属性。其中 \ 为续行符，表明下一行与当前行是一行。也可以这样写
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mytext</span> <span style="color: #a020f0;">db</span> 'L',0x07,'a',0x07,'b',0x07,'e',0x07,'l',0x07,' ',0x07,'o',0x07
       <span style="color: #a020f0;">db</span> 'f',0x07,'f',0x07,'s',0x07,'e',0x07,'t',0x07,':',0x07
</pre>
</div>


<div class="org-src-container">
<pre class="src src-asm">      <span style="color: #a020f0;">jmp</span> start
<span style="color: #0000ff;">mytext</span> <span style="color: #a020f0;">db</span> 'L',0x07,'a',0x07,'b',0x07,'e',0x07,'l',0x07,' ',0x07,'o',0x07
       <span style="color: #a020f0;">db</span> 'f',0x07,'f',0x07,'s',0x07,'e',0x07,'t',0x07,':',0x07

<span style="color: #0000ff;">start</span>:
      <span style="color: #a020f0;">xx&#25351;&#20196;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9ac8bf23-a407-43f2-b5ed-6af20a66a137" class="outline-3">
<h3 id="h:9ac8bf23-a407-43f2-b5ed-6af20a66a137">逻辑段地址的重新设定</h3>
<div class="outline-text-3" id="text-h:9ac8bf23-a407-43f2-b5ed-6af20a66a137">
<blockquote>
<p>
重新设定数据段寄存器的逻辑地址以方便通过标号访问数据
</p>
</blockquote>

<p>
为了简化后面程序的设计，
</p>

<p>
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm">        <span style="color: #a020f0;">jmp</span> start

<span style="color: #0000ff;">mytext</span> <span style="color: #a020f0;">db</span> 'L',0x07,'a',0x07,'b',0x07,'e',0x07,'l',0x07,' ',0x07,'o',0x07
       <span style="color: #a020f0;">db</span> 'f',0x07,'f',0x07,'s',0x07,'e',0x07,'t',0x07,':',0x07

<span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax, 0x7c0    <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#25968;&#25454;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> ds, ax

        <span style="color: #a020f0;">mov</span> ax, 0xb800   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#38468;&#21152;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> es, ax
</pre>
</div>

<p>
为什么将7c0传送到数据段寄存器ds？段地址不是0吗，怎么是7c0呢？
</p>

<p>
因为是主引导扇区程序，加载的逻辑段地址是0，没有从段内偏移地址为0的位置加载，而是从段内偏移地址7c00开始加载，mytext的偏移地址是7c00+mytext
</p>


<figure id="orgbccf88a">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241126_211156.png" alt="img_20241126_211156.png" width="90%">

</figure>

<p>
0000:7c00的物理地址是7c00，我们也可以看成另外一个段07c0:0000，在访问标号mytext时就不用加上7c00了。标号的汇编地址就是段内偏移地址。
</p>
</div>
</div>
<div id="outline-container-h:e1bb56ce-2467-40c4-87c8-f709e9627a04" class="outline-3">
<h3 id="h:e1bb56ce-2467-40c4-87c8-f709e9627a04">串传送指令和标志寄存器</h3>
<div class="outline-text-3" id="text-h:e1bb56ce-2467-40c4-87c8-f709e9627a04">
<blockquote>
<p>
学习串传送指令MOVSB和MOVSW的用法，并了解8086的标志寄存器FLAGS
</p>
</blockquote>

<p>
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm">        <span style="color: #a020f0;">jmp</span> start

<span style="color: #0000ff;">mytext</span> <span style="color: #a020f0;">db</span> 'L',0x07,'a',0x07,'b',0x07,'e',0x07,'l',0x07,' ',0x07,'o',0x07
       <span style="color: #a020f0;">db</span> 'f',0x07,'f',0x07,'s',0x07,'e',0x07,'t',0x07,':',0x07

<span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax, 0x7c0               <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#25968;&#25454;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> ds, ax

        <span style="color: #a020f0;">mov</span> ax, 0xb800              <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#38468;&#21152;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> es, ax

        <span style="color: #a020f0;">cld</span>
        <span style="color: #a020f0;">mov</span> si,mytext
        <span style="color: #a020f0;">mov</span> di,0
        <span style="color: #a020f0;">mov</span> cx,(start-mytext)/2     <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23454;&#38469;&#19978;&#31561;&#20110; 13</span>
        <span style="color: #a020f0;">rep</span> movsw
</pre>
</div>

<p>
数据串的传送指令，用于把一串或者一批数据从内存中一个地址批量地复制到内存中另一个地方。在处理器看来被传送的内容就是数据串。如mytext标志的这一行指令
</p>

<p>
8086处理器支持的两种串传送指令
</p>
<ul class="org-ul">
<li>movsb  按字节传送 s表示string, b表示byte</li>
<li>movsw 按字传送. s表示string, w表示word</li>
</ul>

<p>
<b>传送前准备工作</b>
</p>

<p>
串指令传送前的准备工作(8086处理器)
</p>
<pre class="example" id="orgce5e3c0">
DS:SI  原始数据串的段地址: 偏移地址

ES:DI 目标位置的段地址: 偏移地址
</pre>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">si</span>,mytext       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25991;&#26412;&#30340;&#36215;&#22987;&#20559;&#31227;&#22320;&#22336;&#25918;&#21040;SI</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">di</span>,0               <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;0&#20256;&#36865;&#32473;DI. &#36825;&#24847;&#21619;&#30528;&#25991;&#26412;&#30340;&#20256;&#36865;&#26159;&#20174;&#26174;&#23384;&#30340;&#36215;&#22987;&#20301;&#32622;&#24320;&#22987;&#30340;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">cx</span>,(start-mytext)/2     <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23454;&#38469;&#19978;&#31561;&#20110; 13</span>
<span style="color: #0000ff;">rep</span> <span style="color: #a020f0;">movsw</span>
</pre>
</div>

<p>
设置传送的方向
</p>

<p>
正向传送是原始位置和目标位置同时从内存低地址向高地址推进。反向传送正好相反。这个方向还影响SI和DI的内容，这样做是为了自动指向下一个要传送的位置方便传送。
</p>
<ul class="org-ul">
<li>正向传送时，movsb, movsw每执行一次SI和DI的值自动加上传送的字节数</li>
<li>反向传送时，movsb, movsw每执行一次SI和DI的值自动减去传送的字节数</li>
</ul>

<p>
8086的标志寄存器FLAGS
</p>

<p>
这是一个16位的寄存器，每位用做一个有特定含意的标志
</p>
<pre class="example" id="org6247ec3">
15 14 ..  10 ... 6 ... 0
          DF     ZF

位6：零标志(zero flag) 当处理器执行一条算数或逻辑运算执行后，如果计算结果为0，位6设置为1
位10：方向标志(direction flag) 控制内存操作的方向，0为正方向
</pre>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">cld</span>  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#26041;&#21521;&#26631;&#24535;&#28165;&#38646;&#25351;&#20196;&#65292;&#23558;FLAGE&#23492;&#23384;&#22120;&#30340;DF&#26631;&#24535;&#28165;&#38646;&#65292;0&#20026;&#27491;&#26041;&#21521;&#12290;&#19982;&#20854;&#30456;&#21453;&#30340;&#26159;STD&#32622;&#26041;&#21521;&#25351;&#20196;&#65292;&#23558;FLAGE&#23492;&#23384;&#22120;DF&#26631;&#24535;&#32622;&#20026;1&#65292;&#21453;&#26041;&#21521;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">cx</span>,(start-mytext)/2     <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23454;&#38469;&#19978;&#31561;&#20110; 13</span>
<span style="color: #0000ff;">rep</span> <span style="color: #a020f0;">movsw</span>
</pre>
</div>

<p>
movsw, movsb指令只能执行一次，重复执行需要使用rep指令。rep指令重复的次数由寄存器cx指定，为0时结束。
</p>
</div>
</div>
<div id="outline-container-h:97e3f0da-a361-415c-b243-70cbbe9a2340" class="outline-3">
<h3 id="h:97e3f0da-a361-415c-b243-70cbbe9a2340">NASM的$和$$记号</h3>
<div class="outline-text-3" id="text-h:97e3f0da-a361-415c-b243-70cbbe9a2340">
<blockquote>
<p>
通过阶段性的运行和调试来深入观察批量传送指令的执行特点，并引入NASM编译器提供的$和$$记号
</p>
</blockquote>

<p>
完美程序，作为主引导扇区程序。
</p>

<p>
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm">        <span style="color: #a020f0;">jmp</span> start

<span style="color: #0000ff;">mytext</span> <span style="color: #a020f0;">db</span> 'L',0x07,'a',0x07,'b',0x07,'e',0x07,'l',0x07,' ',0x07,'o',0x07
       <span style="color: #a020f0;">db</span> 'f',0x07,'f',0x07,'s',0x07,'e',0x07,'t',0x07,':',0x07

<span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax, 0x7c0               <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#25968;&#25454;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> ds, ax

        <span style="color: #a020f0;">mov</span> ax, 0xb800              <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#38468;&#21152;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> es, ax

        <span style="color: #a020f0;">cld</span>
        <span style="color: #a020f0;">mov</span> si,mytext               <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25991;&#26412;&#30340;&#36215;&#22987;&#20559;&#31227;&#22320;&#22336;&#25918;&#21040;SI</span>
        <span style="color: #a020f0;">mov</span> di,0                    <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;0&#20256;&#36865;&#32473;DI. &#36825;&#24847;&#21619;&#30528;&#25991;&#26412;&#30340;&#20256;&#36865;&#26159;&#20174;&#26174;&#23384;&#30340;&#36215;&#22987;&#20301;&#32622;&#24320;&#22987;&#30340;</span>
        <span style="color: #a020f0;">mov</span> cx,(start-mytext)/2     <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23454;&#38469;&#19978;&#31561;&#20110; 13</span>
        <span style="color: #a020f0;">rep</span> movsw                   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#37325;&#26032;&#25191;&#34892;movsw, &#23492;&#23384;&#22120;cx&#20026;&#25191;&#34892;&#27425;&#25968;</span>

        <span style="color: #a020f0;">jmp</span> $

        <span style="color: #a020f0;">times</span> 510-($-$$) db 0
        <span style="color: #a020f0;">db</span> 0x55, 0xaa
</pre>
</div>


<pre class="example" id="orgaa589de">
$ 代表当前行的汇编地址

$$ 表示当前程序段的汇编地址
</pre>

<p>
这里整个程序是一个自然的段，$$代表这个程序的起始汇编地址，这程序的段的起始汇编地址是0
</p>


<p>
编译
</p>
<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm exam.asm -f bin -o exam.bin -l exam.lst
</pre>
</div>


<p>
将2进制程序写入虚拟硬盘文件learn.vhd
</p>
<ul class="org-ul">
<li>方法1 fixvhdwr.exe 用自定义的程序导入。
<ul class="org-ul">
<li>LBA连续直写模式，起始LBA区号为0</li>
</ul></li>
<li>方法2 其他有效方法</li>
</ul>

<p>
打开bochs调试器bochsdbg.exe进行调试。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26029;&#28857;&#21040;&#29289;&#29702;&#22320;&#22336;7c00&#65292;&#22240;&#20026;ROM BIOS&#25191;&#34892;&#21518;&#26368;&#21518;&#30340;&#24037;&#20316;&#26159;&#25226;&#20027;&#24341;&#23548;&#25159;&#21306;&#25968;&#25454;&#35835;&#20837;&#21040;&#20869;&#23384;&#30340;&#29289;&#29702;&#22320;&#22336;7c00&#22788;</span>
Next at <span style="color: #a0522d;">t</span>=0
(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0
&lt;bochs:1&gt; b 0x7c00
&lt;bochs:2&gt; c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22788;&#29702;&#22120;&#36830;&#32493;&#22320;&#25191;&#34892;&#65292;&#36935;&#21040;&#26029;&#28857;&#20572;&#19979;</span>
......
Next at <span style="color: #a0522d;">t</span>=17175563
(0) [0x000000007c00] 0000:7c00 (unk. ctxt): jmp .+29  (0x00007c1f)    ; eb1d

&lt;bochs:3&gt; s
Next at <span style="color: #a0522d;">t</span>=17175564
(0) [0x000000007c1f] 0000:7c1f (unk. ctxt): mov ax, 0x07c0            ; b8c007
&lt;bochs:4&gt; s
Next at <span style="color: #a0522d;">t</span>=17175565
(0) [0x000000007c22] 0000:7c22 (unk. ctxt): mov ds, ax                ; 8ed8
&lt;bochs:5&gt; s
Next at <span style="color: #a0522d;">t</span>=17175566
(0) [0x000000007c24] 0000:7c24 (unk. ctxt): mov ax, 0xb800            ; b800b8
&lt;bochs:6&gt; s
Next at <span style="color: #a0522d;">t</span>=17175567
(0) [0x000000007c27] 0000:7c27 (unk. ctxt): mov es, ax                ; 8ec0
&lt;bochs:7&gt;
Next at <span style="color: #a0522d;">t</span>=17175568
(0) [0x000000007c29] 0000:7c29 (unk. ctxt): cld                       ; <span style="color: #483d8b;">fc</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;cld&#25191;&#34892;&#21069;&#26631;&#24535;&#23492;&#23384;&#22120;&#30340;&#29366;&#24577;</span>
&lt;bochs:8&gt; info eflags
id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf SF zf af pf cf
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21508;&#20010;&#26631;&#24535;&#29992;&#21517;&#23383;&#20570;&#26174;&#31034;&#30340;&#65292;&#23567;&#20889;&#30340;&#35828;&#26126;&#35813;&#26631;&#24535;&#26159;0&#65292;&#22823;&#20889;&#26159;1</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;cld&#25191;&#34892;&#21518;&#26631;&#24535;&#23492;&#23384;&#22120;&#30340;&#29366;&#24577;&#65292;zf&#26159;0&#27809;&#38169;</span>
&lt;bochs:9&gt; s
Next at <span style="color: #a0522d;">t</span>=17175569
(0) [0x000000007c2a] 0000:7c2a (unk. ctxt): mov si, 0x0002            ; be0200
&lt;bochs:10&gt; info eflags
id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf SF zf af pf cf


&lt;bochs:11&gt; r
rax: 00000000_0000b800
rbx: 00000000_00000000
rcx: 00000000_00090000
rdx: 00000000_00000080
rsp: 00000000_0000ffd6
rbp: 00000000_00000000
rsi: 00000000_000e0000
rdi: 00000000_0000ffac
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c2a
eflags: 0x00000082: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf SF zf af pf cf
&lt;bochs:12&gt; s
Next at <span style="color: #a0522d;">t</span>=17175570
(0) [0x000000007c2d] 0000:7c2d (unk. ctxt): mov di, 0x0000            ; bf0000
&lt;bochs:13&gt; r
rax: 00000000_0000b800
rbx: 00000000_00000000
rcx: 00000000_00090000
rdx: 00000000_00000080
rsp: 00000000_0000ffd6
rbp: 00000000_00000000
rsi: 00000000_000e0002
rdi: 00000000_0000ffac
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c2d
eflags: 0x00000082: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf SF zf af pf cf

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35266;&#23519;si di&#20869;&#23481;</span>
&lt;bochs:14&gt; s
Next at <span style="color: #a0522d;">t</span>=17175571
(0) [0x000000007c30] 0000:7c30 (unk. ctxt): mov cx, 0x000e            ; b90e00
&lt;bochs:15&gt; s
Next at <span style="color: #a0522d;">t</span>=17175572
(0) [0x000000007c33] 0000:7c33 (unk. ctxt): rep movsw word ptr es:[di], word ptr ds:[si] ; f3a5
&lt;bochs:16&gt; s
Next at <span style="color: #a0522d;">t</span>=17175573
(0) [0x000000007c33] 0000:7c33 (unk. ctxt): rep movsw word ptr es:[di], word ptr ds:[si] ; f3a5
&lt;bochs:17&gt; r
rax: 00000000_0000b800
rbx: 00000000_00000000
rcx: 00000000_0009000c <span style="color: #b22222;">#</span><span style="color: #b22222;">cx&#20869;&#23481;&#22312;&#21464;</span>
rdx: 00000000_00000080
rsp: 00000000_0000ffd6
rbp: 00000000_00000000
rsi: 00000000_000e0004  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#21160;&#21464;&#20026;0004</span>
rdi: 00000000_00000002  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#21160;&#21464;&#20026;0002</span>
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c33
eflags: 0x00010082: id vip vif ac vm RF nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf SF zf af pf cf
</pre>
</div>
</div>
</div>
<div id="outline-container-h:382a2dfb-e4b0-45c7-877e-9f02e500aada" class="outline-3">
<h3 id="h:382a2dfb-e4b0-45c7-877e-9f02e500aada">使用循环指令LOOP分解数位</h3>
<div class="outline-text-3" id="text-h:382a2dfb-e4b0-45c7-877e-9f02e500aada">
<p>
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm">        <span style="color: #a020f0;">jmp</span> start

<span style="color: #0000ff;">mytext</span> <span style="color: #a020f0;">db</span> 'L',0x07,'a',0x07,'b',0x07,'e',0x07,'l',0x07,' ',0x07,'o',0x07
       <span style="color: #a020f0;">db</span> 'f',0x07,'f',0x07,'s',0x07,'e',0x07,'t',0x07,':',0x07

<span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax, 0x7c0               <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#25968;&#25454;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> ds, ax

        <span style="color: #a020f0;">mov</span> ax, 0xb800              <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#38468;&#21152;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> es, ax

        <span style="color: #a020f0;">cld</span>
        <span style="color: #a020f0;">mov</span> si,mytext               <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25991;&#26412;&#30340;&#36215;&#22987;&#20559;&#31227;&#22320;&#22336;&#25918;&#21040;SI</span>
        <span style="color: #a020f0;">mov</span> di,0                    <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;0&#20256;&#36865;&#32473;DI. &#36825;&#24847;&#21619;&#30528;&#25991;&#26412;&#30340;&#20256;&#36865;&#26159;&#20174;&#26174;&#23384;&#30340;&#36215;&#22987;&#20301;&#32622;&#24320;&#22987;&#30340;</span>
        <span style="color: #a020f0;">mov</span> cx,(start-mytext)/2     <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23454;&#38469;&#19978;&#31561;&#20110; 13</span>
        <span style="color: #a020f0;">rep</span> movsw                   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#37325;&#26032;&#25191;&#34892;movsw, &#23492;&#23384;&#22120;cx&#20026;&#25191;&#34892;&#27425;&#25968;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24471;&#21040;&#26631;&#21495;&#25152;&#20195;&#34920;&#30340;&#27719;&#32534;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> ax, number              <span style="color: #b22222;">;</span><span style="color: #b22222;">&#26631;&#21495;&#21644;&#25968;&#23383;&#26159;&#31561;&#25928;&#30340;&#65292;&#31243;&#24207;&#32534;&#35793;&#21518;&#26631;&#21495;&#20250;&#36716;&#25442;&#20026;&#25968;&#23383;&#12290;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#35299;&#21508;&#20010;&#25968;&#20301;</span>
        <span style="color: #a020f0;">mov</span> bx,ax
        <span style="color: #a020f0;">mov</span> cx,5                    <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24490;&#29615;&#27425;&#25968;</span>
        <span style="color: #a020f0;">mov</span> si,10                   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#38500;&#25968;</span>
<span style="color: #0000ff;">digit</span>:
        <span style="color: #a020f0;">xor</span> dx,dx                   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27492;&#26102;dx&#21644;ax&#19968;&#36215;&#24418;&#25104;32&#20301;&#34987;&#38500;&#25968;</span>
        <span style="color: #a020f0;">div</span> si                      <span style="color: #b22222;">;</span><span style="color: #b22222;">&#21830;&#22312;ax&#65292;&#20313;&#25968;&#22312;dx</span>
        <span style="color: #a020f0;">mov</span> [bx],dl                 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20445;&#23384;&#25968;&#20301;</span>
        <span style="color: #a020f0;">inc</span> bx
        <span style="color: #a020f0;">loop</span> digit

        <span style="color: #a020f0;">jmp</span> $

<span style="color: #0000ff;">number</span>  <span style="color: #a020f0;">db</span> 0, 0, 0, 0, 0

        <span style="color: #a020f0;">times</span> 510-($-$$) db 0
        <span style="color: #a020f0;">db</span> 0x55, 0xaa
</pre>
</div>

<p>
循环是由循环指令loop来完成的。
</p>

<pre class="example" id="org2cecdcb">
loop 标号

标号为跳转目标位置

loop指令的机器码：  E2 8位相对偏移量
</pre>

<p>
8080上，LOOP指令的执行过程
</p>
<ul class="org-ul">
<li>将寄存器CX的内容减1</li>
<li>如果CX内容不为零，转移到指定位置处执行，否则顺序执行后面的指令。</li>
</ul>
</div>
</div>
<div id="outline-container-h:0087a7ff-6c1c-480b-87cc-31cc04ca23bf" class="outline-3">
<h3 id="h:0087a7ff-6c1c-480b-87cc-31cc04ca23bf">基址寻址和INC指令</h3>
<div class="outline-text-3" id="text-h:0087a7ff-6c1c-480b-87cc-31cc04ca23bf">
<blockquote>
<p>
使用基址寄存器BX访问内存的方法，以及INC指令的用法
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-asm">        <span style="color: #a020f0;">mov</span> [bx],dl                 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20445;&#23384;&#25968;&#20301;</span>
<span style="color: #b22222;">; </span><span style="color: #b22222;">&#23558;bx&#20869;&#23481;&#21462;&#20986;&#65292;&#24403;&#20316;&#20559;&#31227;&#22320;&#22336;&#12290; &#36825;&#20010;&#20559;&#31227;&#22320;&#22336;&#26159;number&#26631;&#21495;&#30340;&#27719;&#32534;&#22320;&#22336;</span>
</pre>
</div>

<ul class="org-ul">
<li>在8086处理器上，如果要用寄存器来提供偏移地址，只能使用BX, SI, DI, BP，不能使用其它寄存器。</li>

<li>寄存器BX在设计之初的作用之一就是用来提供数据访问的基地址，所以又叫基址寄存器(Base Address Register)</li>

<li>在设计8086处理器时，每个寄存器都有自己的特殊用途，比如
<ul class="org-ul">
<li>AX是累加器(Accumulator)，与它有关的指令还会做指令长度的优化(较短)；</li>
<li>CX是计数器(Counter)；</li>
<li>DX是数据(Data)寄存器，除了作为通用寄存器使用外，还专门用于和外设之间进行数据传送；</li>
<li>SI是源索引寄存器(Source Index)；</li>
<li>DI是目标索引寄存器(Destination Index)，用于数据传送操作</li>
</ul></li>
</ul>


<p>
inc 指令将指定内容加1
</p>
<pre class="example" id="orgd48fccf">
inc  r/m

inc al
inc di
inc byte [0x2002]
</pre>
</div>
</div>
<div id="outline-container-h:baf3910a-b9de-4216-ad91-4ef8bd23adb7" class="outline-3">
<h3 id="h:baf3910a-b9de-4216-ad91-4ef8bd23adb7">数字的显示和DEC指令</h3>
<div class="outline-text-3" id="text-h:baf3910a-b9de-4216-ad91-4ef8bd23adb7">
<blockquote>
<p>
显示分解出来的数位，在这个过程中认识DEC指令
</p>
</blockquote>

<p>
在完成了数位分解工作后，接下来的工作是将它们传送给显示器。
</p>

<p>
传送可以用LOOP指令构造一个循环执行
</p>

<p>
exam.asm修改如下
</p>
<div class="org-src-container">
<pre class="src src-asm">                <span style="color: #a020f0;">jmp</span> start

<span style="color: #0000ff;">mytext</span> <span style="color: #a020f0;">db</span> 'L',0x07,'a',0x07,'b',0x07,'e',0x07,'l',0x07,' ',0x07,'o',0x07
       <span style="color: #a020f0;">db</span> 'f',0x07,'f',0x07,'s',0x07,'e',0x07,'t',0x07,':',0x07

<span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax, 0x7c0               <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#25968;&#25454;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> ds, ax

        <span style="color: #a020f0;">mov</span> ax, 0xb800              <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#38468;&#21152;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> es, ax

        <span style="color: #a020f0;">cld</span>
        <span style="color: #a020f0;">mov</span> si,mytext               <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25991;&#26412;&#30340;&#36215;&#22987;&#20559;&#31227;&#22320;&#22336;&#25918;&#21040;SI</span>
        <span style="color: #a020f0;">mov</span> di,0                    <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;0&#20256;&#36865;&#32473;DI. &#36825;&#24847;&#21619;&#30528;&#25991;&#26412;&#30340;&#20256;&#36865;&#26159;&#20174;&#26174;&#23384;&#30340;&#36215;&#22987;&#20301;&#32622;&#24320;&#22987;&#30340;</span>
        <span style="color: #a020f0;">mov</span> cx,(start-mytext)/2     <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23454;&#38469;&#19978;&#31561;&#20110; 13</span>
        <span style="color: #a020f0;">rep</span> movsw                   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#37325;&#26032;&#25191;&#34892;movsw, &#23492;&#23384;&#22120;cx&#20026;&#25191;&#34892;&#27425;&#25968;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24471;&#21040;&#26631;&#21495;&#25152;&#20195;&#34920;&#30340;&#27719;&#32534;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> ax, number              <span style="color: #b22222;">;</span><span style="color: #b22222;">&#26631;&#21495;&#21644;&#25968;&#23383;&#26159;&#31561;&#25928;&#30340;&#65292;&#31243;&#24207;&#32534;&#35793;&#21518;&#26631;&#21495;&#20250;&#36716;&#25442;&#20026;&#25968;&#23383;&#12290;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#35299;&#21508;&#20010;&#25968;&#20301;</span>
        <span style="color: #a020f0;">mov</span> bx,ax
        <span style="color: #a020f0;">mov</span> cx,5                    <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24490;&#29615;&#27425;&#25968;</span>
        <span style="color: #a020f0;">mov</span> si,10                   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#38500;&#25968;</span>
<span style="color: #0000ff;">digit</span>:
        <span style="color: #a020f0;">xor</span> dx,dx                   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27492;&#26102;dx&#21644;ax&#19968;&#36215;&#24418;&#25104;32&#20301;&#34987;&#38500;&#25968;</span>
        <span style="color: #a020f0;">div</span> si                      <span style="color: #b22222;">;</span><span style="color: #b22222;">&#21830;&#22312;ax&#65292;&#20313;&#25968;&#22312;dx</span>
        <span style="color: #a020f0;">mov</span> [bx],dl                 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20445;&#23384;&#25968;&#20301;</span>
        <span style="color: #a020f0;">inc</span> bx
        <span style="color: #a020f0;">loop</span> digit

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24320;&#22987;&#26174;&#31034;&#21508;&#20010;&#25968;&#20301;</span>
        <span style="color: #a020f0;">mov</span> cx,5
<span style="color: #0000ff;">show</span>:
        <span style="color: #a020f0;">dec</span> bx                      <span style="color: #b22222;">;</span><span style="color: #b22222;">bx&#20869;&#23481;&#20943;1&#65292;bx&#20445;&#23384;&#20102;&#25351;&#21521;number&#26631;&#21495;&#30340;&#20301;&#32622;&#65292;&#19978;&#27425;&#25968;&#20301;&#20998;&#35299;&#32467;&#26463;&#21518;&#25351;&#21521;number&#26368;&#21518;&#19968;&#20010;&#20301;&#32622;</span>
        <span style="color: #a020f0;">mov</span> al,[bx]
        <span style="color: #a020f0;">add</span> al,0x30
        <span style="color: #a020f0;">mov</span> ah,04
        <span style="color: #a020f0;">mov</span> [es:di],ax
        <span style="color: #a020f0;">add</span> di,2                    <span style="color: #b22222;">;</span><span style="color: #b22222;">&#25351;&#21521;&#26174;&#23384;&#19979;&#19968;&#20010;&#20301;&#32622;</span>
        <span style="color: #a020f0;">loop</span> show

        <span style="color: #a020f0;">jmp</span> $

<span style="color: #0000ff;">number</span>  <span style="color: #a020f0;">db</span> 0, 0, 0, 0, 0

        <span style="color: #a020f0;">times</span> 510-($-$$) db 0
        <span style="color: #a020f0;">db</span> 0x55, 0xaa
</pre>
</div>


<p>
DEC指令格式
</p>
<pre class="example" id="org6bc6f28">
减1指令
dec r/m

dec al
dec di
dec byte [0x2002]
</pre>




<figure id="orgc410d67">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241127_225519.png" alt="img_20241127_225519.png" width="90%">

</figure>
</div>
</div>
<div id="outline-container-h:0b420685-78a9-4f3f-9616-579113057024" class="outline-3">
<h3 id="h:0b420685-78a9-4f3f-9616-579113057024">基址变址寻址和条件转移指令</h3>
<div class="outline-text-3" id="text-h:0b420685-78a9-4f3f-9616-579113057024">
<blockquote>
<p>
换种方法显示分解出来的数位，在这个过程中认识基址变址寻址和条件转移指令
</p>
</blockquote>

<p>
bx的值并没有沿用前面代码所遗留的值，而是重新设置的。一共有5个数字要显示，
它们在当前数据段内起始偏移地址就是标号number的汇编地址
</p>

<p>
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm">        <span style="color: #a020f0;">jmp</span> start

<span style="color: #0000ff;">mytext</span> <span style="color: #a020f0;">db</span> 'L',0x07,'a',0x07,'b',0x07,'e',0x07,'l',0x07,' ',0x07,'o',0x07
       <span style="color: #a020f0;">db</span> 'f',0x07,'f',0x07,'s',0x07,'e',0x07,'t',0x07,':',0x07

<span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax, 0x7c0               <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#25968;&#25454;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> ds, ax

        <span style="color: #a020f0;">mov</span> ax, 0xb800              <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#38468;&#21152;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> es, ax

        <span style="color: #a020f0;">cld</span>
        <span style="color: #a020f0;">mov</span> si,mytext               <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;&#25991;&#26412;&#30340;&#36215;&#22987;&#20559;&#31227;&#22320;&#22336;&#25918;&#21040;SI</span>
        <span style="color: #a020f0;">mov</span> di,0                    <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;0&#20256;&#36865;&#32473;DI. &#36825;&#24847;&#21619;&#30528;&#25991;&#26412;&#30340;&#20256;&#36865;&#26159;&#20174;&#26174;&#23384;&#30340;&#36215;&#22987;&#20301;&#32622;&#24320;&#22987;&#30340;</span>
        <span style="color: #a020f0;">mov</span> cx,(start-mytext)/2     <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23454;&#38469;&#19978;&#31561;&#20110; 13</span>
        <span style="color: #a020f0;">rep</span> movsw                   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#37325;&#26032;&#25191;&#34892;movsw, &#23492;&#23384;&#22120;cx&#20026;&#25191;&#34892;&#27425;&#25968;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24471;&#21040;&#26631;&#21495;&#25152;&#20195;&#34920;&#30340;&#27719;&#32534;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> ax, number              <span style="color: #b22222;">;</span><span style="color: #b22222;">&#26631;&#21495;&#21644;&#25968;&#23383;&#26159;&#31561;&#25928;&#30340;&#65292;&#31243;&#24207;&#32534;&#35793;&#21518;&#26631;&#21495;&#20250;&#36716;&#25442;&#20026;&#25968;&#23383;&#12290;</span>

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20998;&#35299;&#21508;&#20010;&#25968;&#20301;</span>
        <span style="color: #a020f0;">mov</span> bx,ax
        <span style="color: #a020f0;">mov</span> cx,5                    <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24490;&#29615;&#27425;&#25968;</span>
        <span style="color: #a020f0;">mov</span> si,10                   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#38500;&#25968;</span>
<span style="color: #0000ff;">digit</span>:
        <span style="color: #a020f0;">xor</span> dx,dx                   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27492;&#26102;dx&#21644;ax&#19968;&#36215;&#24418;&#25104;32&#20301;&#34987;&#38500;&#25968;</span>
        <span style="color: #a020f0;">div</span> si                      <span style="color: #b22222;">;</span><span style="color: #b22222;">&#21830;&#22312;ax&#65292;&#20313;&#25968;&#22312;dx</span>
        <span style="color: #a020f0;">mov</span> [bx],dl                 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20445;&#23384;&#25968;&#20301;</span>
        <span style="color: #a020f0;">inc</span> bx
        <span style="color: #a020f0;">loop</span> digit

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24320;&#22987;&#26174;&#31034;&#21508;&#20010;&#25968;&#20301;</span>
        <span style="color: #a020f0;">mov</span> bx,number
        <span style="color: #a020f0;">mov</span> si,4
<span style="color: #0000ff;">show</span>:
        <span style="color: #a020f0;">mov</span> al,[bx+si]              <span style="color: #b22222;">;</span><span style="color: #b22222;">si&#30340;&#20540;&#30456;&#24403;&#20110;&#32034;&#24341;</span>
        <span style="color: #a020f0;">add</span> al,0x30
        <span style="color: #a020f0;">mov</span> ah,04
        <span style="color: #a020f0;">mov</span> [es:di],ax              <span style="color: #b22222;">;</span><span style="color: #b22222;">ax&#20869;&#23481;&#20026;&#23383;&#31526;&#32534;&#30721;&#21644;&#39068;&#33394;&#23646;&#24615;</span>
        <span style="color: #a020f0;">add</span> di,2                    <span style="color: #b22222;">;</span><span style="color: #b22222;">&#25351;&#21521;&#26174;&#23384;&#19979;&#19968;&#20010;&#20301;&#32622;</span>
        <span style="color: #a020f0;">dec</span> si
        <span style="color: #a020f0;">jns</span> show                    <span style="color: #b22222;">;</span><span style="color: #b22222;">&#36339;&#36716;&#25351;&#20196;&#65292;&#22914;&#26524;&#26631;&#24535;&#23492;&#23384;&#22120;&#30340;&#20301;7&#30340;SF&#19981;&#20026;1&#23601;&#19968;&#30452;&#36339;&#36716;&#12290;si&#26174;&#31034;&#23436;&#26368;&#21518;&#19968;&#20010;&#25968;&#20301;&#21518;&#65292;&#26368;&#39640;&#20301;&#20026;1</span>

        <span style="color: #a020f0;">jmp</span> $

<span style="color: #0000ff;">number</span>  <span style="color: #a020f0;">db</span> 0, 0, 0, 0, 0

        <span style="color: #a020f0;">times</span> 510-($-$$) db 0
        <span style="color: #a020f0;">db</span> 0x55, 0xaa
</pre>
</div>


<p>
在8086处理器上，只允许以下几种基址变址的组合
</p>
<pre class="example" id="org3f2251a">
bx + si
bx + di
bx + si
bx +di

非法的例子
bx + ax
ax + cx
</pre>


<p>
8086的标志寄存器FLAGS
</p>

<p>
这是一个16位的寄存器，每位用做一个有特定含意的标志
</p>
<pre class="example" id="org4c1c101">
15 14 ..  10 ... 6 ... 0
          DF     ZF

位6：零标志(zero flag) 0 时ZF，1时zf。当处理器执行一条算数或逻辑运算执行后，如果计算结果为0，位6设置为1
位7：符号标志Sign Flag  SF。在执行算数逻辑运算后，如果结果的最高位是0，位7置为0
位10：方向标志(direction flag) DF控制内存操作的方向，0为正方向
</pre>



<p>
编译
</p>
<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm exam.asm -f bin -o exam.bin -l exam.lst
</pre>
</div>


<p>
将2进制程序写入虚拟硬盘文件learn.vhd
</p>
<ul class="org-ul">
<li>方法1 fixvhdwr.exe 用自定义的程序导入。
<ul class="org-ul">
<li>LBA连续直写模式，起始LBA区号为0</li>
</ul></li>
<li>方法2 其他有效方法</li>
</ul>

<p>
打开bochs调试器bochsdbg.exe进行调试。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26029;&#28857;&#21040;&#29289;&#29702;&#22320;&#22336;7c00&#65292;&#22240;&#20026;ROM BIOS&#25191;&#34892;&#21518;&#26368;&#21518;&#30340;&#24037;&#20316;&#26159;&#25226;&#20027;&#24341;&#23548;&#25159;&#21306;&#25968;&#25454;&#35835;&#20837;&#21040;&#20869;&#23384;&#30340;&#29289;&#29702;&#22320;&#22336;7c00&#22788;</span>
Next at <span style="color: #a0522d;">t</span>=0
(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0
&lt;bochs:1&gt; b 0x7c00
&lt;bochs:2&gt; c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22788;&#29702;&#22120;&#36830;&#32493;&#22320;&#25191;&#34892;&#65292;&#36935;&#21040;&#26029;&#28857;&#20572;&#19979;</span>
......
(0) [0x000000007c00] 0000:7c00 (unk. ctxt): jmp .+26  (0x00007c1c)    ; eb1a

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35266;&#23519;&#65292;&#36339;&#36716;&#22312;&#25345;&#32493;&#36827;&#34892;</span>
&lt;bochs:4&gt; u /52
0000000000007c00: (                    ): jmp .+26  (0x00007c1c)    ; eb1a
......
0000000000007c58: (                    ): dec si                    ; 4e
0000000000007c59: (                    ): jns .-15  (0x00007c4c)    ; 79f1
0000000000007c5b: (                    ): jmp .-2  (0x00007c5b)     ; ebfe
0000000000007c5d: (                    ): add byte ptr ds:[bx+si], al ; 0000
0000000000007c5f: (                    ): add byte ptr ds:[bx+si], al ; 0000
0000000000007c61: (                    ): add byte ptr ds:[bx+si], al ; 0000
0000000000007c63: (                    ): add byte ptr ds:[bx+si], al ; 0000
0000000000007c65: (                    ): add byte ptr ds:[bx+si], al ; 0000
0000000000007c67: (                    ): add byte ptr ds:[bx+si], al ; 0000
&lt;bochs:5&gt; b 0x7c58

&lt;bochs:6&gt; c
(0) Breakpoint 2, 0x0000000000007c58<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17175621
(0) [0x000000007c58] 0000:7c58 (unk. ctxt): dec si                    ; 4e
&lt;bochs:7&gt; c
(0) Breakpoint 2, 0x0000000000007c58<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17175628
(0) [0x000000007c58] 0000:7c58 (unk. ctxt): dec si                    ; 4e
&lt;bochs:8&gt; c
(0) Breakpoint 2, 0x0000000000007c58<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17175635
(0) [0x000000007c58] 0000:7c58 (unk. ctxt): dec si                    ; 4e
&lt;bochs:9&gt; c
(0) Breakpoint 2, 0x0000000000007c58<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17175642
(0) [0x000000007c58] 0000:7c58 (unk. ctxt): dec si                    ; 4e
&lt;bochs:10&gt; c
(0) Breakpoint 2, 0x0000000000007c58<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17175649
(0) [0x000000007c58] 0000:7c58 (unk. ctxt): dec si                    ; 4e

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35266;&#23519;&#31526;&#21495;&#26631;&#24535;SF</span>
&lt;bochs:11&gt; info eflags
id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf sf zf af PF cf
&lt;bochs:12&gt; s
Next at <span style="color: #a0522d;">t</span>=17175650
(0) [0x000000007c59] 0000:7c59 (unk. ctxt): jns .-15  (0x00007c4c)    ; 79f1
&lt;bochs:13&gt; info eflags
id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf SF zf AF PF cf

&lt;bochs:14&gt; r
rax: 00000000_00000433
rbx: 00000000_0000005d
rcx: 00000000_00090000
rdx: 00000000_00000000
rsp: 00000000_0000ffd6
rbp: 00000000_00000000
rsi: 00000000_000effff  <span style="color: #b22222;">#</span><span style="color: #b22222;">si &#26368;&#39640;&#20301;&#26159;1</span>
rdi: 00000000_00000024
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c59
eflags: 0x00000096: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf SF zf AF PF cf

&lt;bochs:15&gt; s
Next at <span style="color: #a0522d;">t</span>=17175651
(0) [0x000000007c5b] 0000:7c5b (unk. ctxt): jmp .-2  (0x00007c5b)     ; ebfe
&lt;bochs:16&gt; s
Next at <span style="color: #a0522d;">t</span>=17175652
(0) [0x000000007c5b] 0000:7c5b (unk. ctxt): jmp .-2  (0x00007c5b)     ; ebfe
&lt;bochs:17&gt; s
Next at <span style="color: #a0522d;">t</span>=17175653
(0) [0x000000007c5b] 0000:7c5b (unk. ctxt): jmp .-2  (0x00007c5b)     ; ebfe
&lt;bochs:18&gt;
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:bd1e9480-f923-4c72-803c-70c48cfc735a" class="outline-2">
<h2 id="h:bd1e9480-f923-4c72-803c-70c48cfc735a">计算机中的负数</h2>
<div class="outline-text-2" id="text-h:bd1e9480-f923-4c72-803c-70c48cfc735a">
<p>
主要内容
</p>

<ul class="org-ul">
<li>无符号数和有符号数</li>
<li>减法指令SUB和求补指令NEG</li>
<li>计算机如何区分对待无符号数和有符号数</li>
<li>有符号数除法指令IDIV</li>
<li>有符号数的符号扩展指令</li>
</ul>
</div>
<div id="outline-container-h:7ca783da-c1f2-4a69-bbb1-fd779bb50eca" class="outline-3">
<h3 id="h:7ca783da-c1f2-4a69-bbb1-fd779bb50eca">无符号数和有符号数</h3>
<div class="outline-text-3" id="text-h:7ca783da-c1f2-4a69-bbb1-fd779bb50eca">
<p>
用汇编语言表示负数
</p>
<div class="org-src-container">
<pre class="src src-asm">        <span style="color: #a020f0;">jmp</span> start
<span style="color: #0000ff;">data1</span>   <span style="color: #a020f0;">db</span> -1
<span style="color: #0000ff;">data2</span>   <span style="color: #a020f0;">dw</span> -25 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#29992;&#20266;&#25351;&#20196;dw&#22312;&#31243;&#24207;&#20013;&#24320;&#36767;&#19968;&#20010;&#23383;&#30340;&#31354;&#38388;&#65292;&#24182;&#20445;&#23384;-25</span>
<span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax,-78 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23558;-78&#20256;&#36865;&#21040;&#23492;&#23384;&#22120;ax</span>
</pre>
</div>

<p>
在程序编译时，负数会被自动转换成2进制形式。
</p>

<p>
在计算机里，整数分成2种，无符号数和有符号数。
</p>

<p>
<b>无符号数</b>
</p>

<p>
在无符号的2进制形式中没有符号位，所有比特都用来表示数字的大小。
</p>

<p>
范例：一个字节所能表示的无符号数
</p>
<pre class="example" id="org3ce6e47">
1111 1111 255 (0xFF)
1111 1110 254 (0xFE)
1111 1101 253 (0xFD)
......
0000 0010 2 (0x02)
0000 0001 1 (0x01)
0000 0000 0 (0x00)
</pre>

<p>
无符号2进制数转10进制
</p>

<p>
从右向左，每个2进制数位都有一个序号，序号从右往左依次增大。每个数位都有一个加权值。
</p>

<p>
范例： 1111 1101
</p>

<p>
最左面最高位的加权值为数位本身1乘以以2为底以它的序号为指数的幂。
</p>

<p>
\(1 \times 2^7 + 1 \times 2^6 + 1 \times 2^5 + 1 \times 2^4 + 1 \times 2^3 + 1 \times 2^2 + 0 \times 2^1 + 1 \times 2^0 = 253\)
</p>

<p>
<b>有符号数</b>
</p>

<p>
和无符号数不同，有符号数是分正负的。它最左边的那一位即最高位，不但要表示数的大小，还要
表示数的正负。最高位是0，这个数是正数；如果最高位是1，这个数是负数。
</p>

<p>
范例：一个字节所能表示的有符号数
</p>
<pre class="example" id="orgbdc690d">
0111 1111  +127  (0x7F)
......
0000 0010  +2  (0x02)
0000 0001  +1  (0x01)
0000 0000  0  (0x00)
1111 1111  -1  (0xFF)
1111 1110  -2  (0xFE)
......
1000 0000  -128  (0x80)
</pre>

<p>
范例：一个字所能表示的有符号数
</p>
<pre class="example" id="org2bee124">
0111 1111 1111 1111  +32767  (0x7FFF)
......
0000 0000 0000 0010  +2  (0x0002)
0000 0000 0000 0001  +1  (0x0001)
0000 0000 0000 0000  0  (0x0000)
1111 1111 1111 1111  -1  (0xFFFF)
1111 1111 1111 1110  -2  (0xFFFE)
......
1000 0000 0000 0000  -32767  (0x8000)
</pre>

<p>
有符号2进制数转10进制
</p>

<p>
从右向左，每个2进制数位都有一个序号，序号从右往左依次增大。每个数位都有一个加权值。但是，符号位加权值比较特殊，必须添加一个负号
</p>

<p>
范例： 1111 1101
</p>

<p>
最左面符号位的加权值为数位本身1乘以以2为底以它的序号为指数的幂，前面加一个负号
</p>

<p>
\(-(1 \times 2^7) + 1 \times 2^6 + 1 \times 2^5 + 1 \times 2^4 + 1 \times 2^3 + 1 \times 2^2 + 0 \times 2^1 + 1 \times 2^0 = -3\)
</p>

<p>
范例：1111 1111 1111 1110
</p>

<p>
\(-(1 \times 2^{15}) + 1 \times 2^{14} + 1 \times 2^{13} + ......  + 1 \times 2^2 + 0 \times 2^1 + 1 \times 2^0 = -2\)
</p>
</div>
</div>
<div id="outline-container-h:2a63843f-933c-46b2-a5b7-346f1cec15d2" class="outline-3">
<h3 id="h:2a63843f-933c-46b2-a5b7-346f1cec15d2">减法指令SUB和求补指令NEG</h3>
<div class="outline-text-3" id="text-h:2a63843f-933c-46b2-a5b7-346f1cec15d2">
<blockquote>
<p>
了解计算机内部如何得到一个正数的负值，在这个过程中认识SUB和NEG指令
</p>
</blockquote>

<p>
对于计算机来说生成和表示一个负数很简单
</p>

<p>
做2进制减法
</p>

<pre class="example" id="org448af89">
-1 等于 0 - 1

           0
        -  1
------------借位
....11111111


-2 等于 0 - 2
           0
        - 10
------------借位
....11111110
</pre>

<p>
二进制0减去二进制1 。需要不停的借位。因为寄存器和内存空间是8位、16位、32位、64位，相减的结果取8位就是1111 1111， FF，取16位是1111 1111 1111 1111 ，FFFF。
</p>


<p>
<b>减法指令SUB</b>
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ax</span>, 0
<span style="color: #0000ff;">sub</span> <span style="color: #a020f0;">ax</span>,dx
</pre>
</div>

<p>
格式
</p>
<pre class="example" id="orgc52137e">
sub   r/m,  r/m/imm

sub al,35
sub dx,ax
sub dx, [0x2002]
sub byte [0x2002],37
sub byte [0x2002],al

将左操作数和右操作数相减，结果在左操作数

注意：2个操作数宽度要一致，而且不能同时是内存地址
</pre>

<p>
<b>NEG指令</b>
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ax</span>, 0
<span style="color: #0000ff;">sub</span> <span style="color: #a020f0;">ax</span>,dx
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">dx</span>,ax  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#30456;&#20943;&#30340;&#32467;&#26524;&#20877;&#36820;&#22238;&#21040;dx&#20013;</span>
</pre>
</div>

<p>
上面3条指令可以用一条完成
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">neg</span> <span style="color: #a020f0;">dx</span> <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27714;&#36127;&#25968;&#25351;&#20196;&#25110;&#23545;&#38754;&#30340;&#34917;&#30721;&#25351;&#20196;</span>
</pre>
</div>

<p>
格式
</p>
<pre class="example" id="org86a5eb0">
net r/m

neg al
neg di
neg byte [0x2002]

用0减去指令中的操作数，然后用相减的结果替换操作数中的内容

neg al
如al 内容为 0000 1000 (8), 指令执行后al内容为1111 1000(-8)
如al内容为 1100 0100 (-60), 指令执行后al内容为 0011 1100 (60)

</pre>
</div>
</div>
<div id="outline-container-h:f3ffb306-781a-4a94-8aa6-96823fde2f04" class="outline-3">
<h3 id="h:f3ffb306-781a-4a94-8aa6-96823fde2f04">计算机如何区分对待无符号数和有符号数</h3>
<div class="outline-text-3" id="text-h:f3ffb306-781a-4a94-8aa6-96823fde2f04">
<p>
范例：
</p>
<pre class="example" id="org2c4c406">
mov ax, -1
1111 1111 1111 1111

mov bx,65535
1111 1111 1111 1111
</pre>

<p>
-1和65535在计算机内部有相同的表示，那么计算机如何区分它们呢？
</p>

<p>
计算机不关心这个问题，最终这个事件取决于你自己。你编写的程序，一个数有没有符号你清楚。指令在执行的时候有自己的法则，
你的任务是根据你的情况选择不同的指令来完成不同的目的。
</p>

<p>
对于处理器的多数指令来说，执行的结果和操作数的类型没有关系，也就是无论是从符号的角度看还是从有符号角度看，指令执行的
结果都是正解无误的。如mov ax,bx
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ah</span>,0xf0  <span style="color: #b22222;">;</span><span style="color: #b22222;">1111 0000 &#21487;&#20197;&#35299;&#37322;&#25104;-16 &#25110;240</span>
<span style="color: #0000ff;">inc</span> <span style="color: #a020f0;">ah</span> <span style="color: #b22222;">; </span><span style="color: #b22222;">ah&#21152;1&#21040;&#20869;&#23481;&#20026; 1111 0001 &#21487;&#35748;&#20026;&#26159;-15&#25110;241</span>

<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ah</span>,0xf0 <span style="color: #b22222;">; </span><span style="color: #b22222;">1111 0000</span>
<span style="color: #0000ff;">add</span> <span style="color: #a020f0;">ah</span>,0x03 <span style="color: #b22222;">; </span><span style="color: #b22222;">1111 0011 &#21487;&#35748;&#20026;&#26159;-13&#25110;243</span>
</pre>
</div>

<ul class="org-ul">
<li>可以说，大多数指令既适用于无符号整数，也适用于有符号整数。指令执行的结果不管是用无符号来解释，还是用有符号来
解释，都是正确的。</li>
<li>但是，也有一些指令不能同时应付无符号和有符号数，需要根据你的实际情况，选择它们的无符号版本和有符号版本。比如
无符号乘法指令mul和有符号乘法指令imul，以及无符号除法指令div和有符号除法指令idiv</li>
</ul>

<p>
范例：div只适用于无符号除法
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ax</span>,0x0400
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">bl</span>,0xf0
<span style="color: #0000ff;">div</span> <span style="color: #a020f0;">bl</span>

<span style="color: #0000ff;">times</span> <span style="color: #a020f0;">510</span>-($-$$) db 0
<span style="color: #0000ff;">db</span> <span style="color: #a020f0;">0x55</span>,0xaa
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2c5737b7-9880-4a07-898f-d59b5a56c166" class="outline-3">
<h3 id="h:2c5737b7-9880-4a07-898f-d59b5a56c166">有符号数除法指令IDIV</h3>
<div class="outline-text-3" id="text-h:2c5737b7-9880-4a07-898f-d59b5a56c166">
<p>
格式
</p>
<div class="org-src-container">
<pre class="src src-nil">idiv  r/m
</pre>
</div>

<p>
<b>除数长度是8位</b>
</p>

<ul class="org-ul">
<li>如果在指令中指定的是8位寄存器或者8位操作数的内存地址，则意味着被除数在寄存器AX里</li>
<li>相除后，商在寄存器AL里，余数在寄存器AH里</li>
</ul>

<pre class="example" id="org0edd5f0">

</pre>

<p>
范例：div 除数长度为8位
</p>
<div class="org-src-container">
<pre class="src src-sh">idiv bh
<span style="color: #b22222;">#</span><span style="color: #b22222;">bh&#26159;8&#20301;&#30340;&#23492;&#23384;&#22120;&#65292;&#23384;&#25918;&#30340;&#26159;&#38500;&#25968;&#65292;&#37027;&#20040;&#34987;&#38500;&#25968;&#23384;&#25918;&#22312;AX&#37324;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">AX&#20013;&#20869;&#23481;&#38500;&#20197;BH&#20013;&#20869;&#23481;&#65292;&#30456;&#38500;&#21518;&#65292;&#21830;&#22312;AL&#20013;&#65292;&#20313;&#25968;&#22312;AH&#20013;</span>

idiv byte [0x2002]
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38500;&#25968;&#22312;&#20869;&#23384;&#20013;&#65292;&#20174;&#20869;&#23384;&#22320;&#22336;0x2002&#22788;&#21462;1&#20010;&#23383;&#33410;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">AX&#20013;&#20869;&#23481;&#38500;&#20197;0x2002&#22320;&#22336;&#30340;8&#20301;&#38500;&#25968;&#65292;&#30456;&#38500;&#21518;&#65292;&#21830;&#22312;AL&#20013;&#65292;&#20313;&#25968;&#22312;AH&#20013;</span>
</pre>
</div>

<p>
<b>除数长度是16位</b>
</p>

<ul class="org-ul">
<li>如果在指令中指定的是16位寄存器或者16位操作数的内存地址，则意味着被除数是32位的，低
16位在寄存器AX里；高16位在寄存器DX里</li>
<li>相除后，商在寄存器AX里，余数在寄存器DX里。</li>
</ul>

<p>
范例：div 除数长度为16位
</p>
<div class="org-src-container">
<pre class="src src-sh">div bx
<span style="color: #b22222;">#</span><span style="color: #b22222;">bx&#26159;16&#20301;&#30340;&#23492;&#23384;&#22120;&#65292;&#23384;&#25918;&#30340;&#26159;&#38500;&#25968;&#65292;&#37027;&#20040;&#34987;&#38500;&#25968;&#26159;32&#20301;&#30340;&#65292;&#20302;16&#20301;&#22312;&#23492;&#23384;&#22120;AX&#37324;&#65307;&#39640;16&#20301;&#22312;&#23492;&#23384;&#22120;DX&#37324;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;DX&#21644;AX&#32452;&#21512;&#25104;32&#20301;&#30340;&#34987;&#38500;&#25968;&#38500;&#20197;BX&#20013;&#20869;&#23481;&#65292;&#30456;&#38500;&#21518;&#65292;&#21830;&#22312;AX&#20013;&#65292;&#20313;&#25968;&#22312;DX&#20013;</span>

div word [0x2002]
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38500;&#25968;&#22312;&#20869;&#23384;&#20013;&#65292;&#20174;&#20869;&#23384;&#22320;&#22336;0x2002&#22788;&#21462;1&#20010;&#23383;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;DX&#21644;AX&#32452;&#21512;&#25104;32&#20301;&#30340;&#34987;&#38500;&#25968;&#38500;&#20197;0x2002&#22320;&#22336;&#30340;16&#20301;&#38500;&#25968;&#65292;&#30456;&#38500;&#21518;&#65292;&#21830;&#22312;AX&#20013;&#65292;&#20313;&#25968;&#22312;DX&#20013;</span>
</pre>
</div>

<p>
<b>除数长度是32位</b>
</p>

<p>
8086不支持的，它是16位处理器，从80386开始支持
</p>

<ul class="org-ul">
<li>如果在指令中指定的是32位寄存器或者32位操作数的内存地址，则意味着被除数是64位的，低
32位在寄存器EAX里；高32位在寄存器EDX里</li>
<li>相除后，商在寄存器EAX里，余数在寄存器EDX里。</li>
</ul>


<p>
范例：div 除数长度为32位
</p>
<div class="org-src-container">
<pre class="src src-sh">div ebx
<span style="color: #b22222;">#</span><span style="color: #b22222;">ebx&#26159;32&#20301;&#30340;&#23492;&#23384;&#22120;&#65292;&#23384;&#25918;&#30340;&#26159;&#38500;&#25968;&#65292;&#37027;&#20040;&#34987;&#38500;&#25968;&#26159;64&#20301;&#30340;&#65292;&#20302;32&#20301;&#22312;&#23492;&#23384;&#22120;EAX&#37324;&#65307;&#39640;32&#20301;&#22312;&#23492;&#23384;&#22120;EDX&#37324;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;EDX&#21644;EAX&#32452;&#21512;&#25104;64&#20301;&#30340;&#34987;&#38500;&#25968;&#38500;&#20197;&#26377;EBX&#20013;&#20869;&#23481;&#65292;&#30456;&#38500;&#21518;&#65292;&#21830;&#22312;EAX&#20013;&#65292;&#20313;&#25968;&#22312;EDX&#20013;</span>

div dword [0x2002]
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38500;&#25968;&#22312;&#20869;&#23384;&#20013;&#65292;&#20174;&#20869;&#23384;&#22320;&#22336;0x2002&#22788;&#21462;4&#20010;&#23383;&#33410;&#32452;&#21512;&#20986;32&#20301;&#25805;&#20316;&#25968;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;EDX&#21644;EAX&#32452;&#21512;&#25104;64&#20301;&#30340;&#34987;&#38500;&#25968;&#38500;&#20197;0x2002&#22320;&#22336;&#30340;32&#20301;&#38500;&#25968;&#65292;&#30456;&#38500;&#21518;&#65292;&#21830;&#22312;EAX&#20013;&#65292;&#20313;&#25968;&#22312;EDX&#20013;</span>
</pre>
</div>

<p>
<b>除数长度是64位</b>
</p>

<p>
8086和32位处理器不支持，只有64位处理器支持
</p>

<ul class="org-ul">
<li>如果在指令中指定的是64位寄存器或者64位操作数的内存地址，则意味着被除数是128位的，低
64位在寄存器RAX里；高64位在寄存器RDX里</li>
<li>相除后，商在寄存器RAX里，余数在寄存器RDX里。</li>
</ul>


<p>
范例：div 除数长度为64位
</p>
<div class="org-src-container">
<pre class="src src-sh">div rbx
<span style="color: #b22222;">#</span><span style="color: #b22222;">rbx&#26159;64&#20301;&#30340;&#23492;&#23384;&#22120;&#65292;&#23384;&#25918;&#30340;&#26159;&#38500;&#25968;&#65292;&#37027;&#20040;&#34987;&#38500;&#25968;&#26159;128&#20301;&#30340;&#65292;&#20302;64&#20301;&#22312;&#23492;&#23384;&#22120;RAX&#37324;&#65307;&#39640;64&#20301;&#22312;&#23492;&#23384;&#22120;RDX&#37324;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;RDX&#21644;RAX&#32452;&#21512;&#25104;128&#20301;&#30340;&#34987;&#38500;&#25968;&#38500;&#20197;&#26377;RBX&#20013;&#20869;&#23481;&#65292;&#30456;&#38500;&#21518;&#65292;&#21830;&#22312;RAX&#20013;&#65292;&#20313;&#25968;&#22312;RDX&#20013;</span>

div qword [0x2002]
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38500;&#25968;&#22312;&#20869;&#23384;&#20013;&#65292;&#20174;&#20869;&#23384;&#22320;&#22336;0x2002&#22788;&#21462;8&#20010;&#23383;&#33410;&#32452;&#21512;&#20986;64&#20301;&#25805;&#20316;&#25968;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;RDX&#21644;RAX&#32452;&#21512;&#25104;128&#20301;&#30340;&#34987;&#38500;&#25968;&#38500;&#20197;0x2002&#22320;&#22336;&#30340;64&#20301;&#38500;&#25968;&#65292;&#30456;&#38500;&#21518;&#65292;&#21830;&#22312;RAX&#20013;&#65292;&#20313;&#25968;&#22312;RDX&#20013;</span>
</pre>
</div>

<p>
商和余数的符号性
</p>
<ul class="org-ul">
<li>如果被除数和余数的符号相同，商为正数，否则商为负数</li>
<li>余数的符号始终和被除数相同</li>
</ul>

<p>
范例：有符号指令idiv执行特点
</p>

<p>
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #b22222;">;</span><span style="color: #b22222;">&#20197;&#19979;&#20026;&#26377;&#31526;&#21495;&#38500;&#27861;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ax</span>,0x0400       <span style="color: #b22222;">;</span><span style="color: #b22222;">AX&#20869;&#23481;&#20026;&#26377;&#31526;&#21495;&#25968;1024</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">bl</span>,0xf0         <span style="color: #b22222;">;</span><span style="color: #b22222;">BL&#20869;&#23481;&#20026;&#26377;&#31526;&#21495;-16</span>
<span style="color: #0000ff;">idiv</span> <span style="color: #a020f0;">bl</span>             <span style="color: #b22222;">;</span><span style="color: #b22222;">1024/-16 AL = 0xC0</span>

<span style="color: #b22222;">;</span><span style="color: #b22222;">&#20063;&#21487;&#20197;&#20889;&#20026;&#19979;&#38754;3&#34892;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ax</span>,1024
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">bl</span>,-16
<span style="color: #0000ff;">idiv</span> <span style="color: #a020f0;">bl</span>

<span style="color: #0000ff;">times</span> <span style="color: #a020f0;">510</span>-($-$$) db 0
<span style="color: #0000ff;">db</span> <span style="color: #a020f0;">0x55</span>,0xaa
</pre>
</div>


<p>
编译
</p>
<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm exam.asm -f bin -o exam.bin -l exam.lst
</pre>
</div>

<p>
列表文件exam.lst, 可以看到机器码是一样的
</p>
<pre class="example" id="org33aab4c">
 1                                          ;以下为有符号除法
 2 00000000 B80004                          mov ax,0x0400       ;AX内容为有符号数1024
 3 00000003 B3F0                            mov bl,0xf0         ;BL内容为有符号-16
 4 00000005 F6FB                            idiv bl             ;1024/-16 AL = 0xC0
 5
 6                                          ;也可以写为下面3行
 7 00000007 B80004                          mov ax,1024
 8 0000000A B3F0                            mov bl,-16
 9 0000000C F6FB                            idiv bl
10
11 0000000E 00&lt;rep 1F0h&gt;                    times 510-($-$$) db 0
12 000001FE 55AA                            db 0x55,0xaa
</pre>

<p>
将2进制程序写入虚拟硬盘文件learn.vhd
</p>
<ul class="org-ul">
<li>方法1 fixvhdwr.exe 用自定义的程序导入。
<ul class="org-ul">
<li>LBA连续直写模式，起始LBA区号为0</li>
</ul></li>
<li>方法2 其他有效方法</li>
</ul>

<p>
打开bochs调试器bochsdbg.exe进行调试。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26029;&#28857;&#21040;&#29289;&#29702;&#22320;&#22336;7c00&#65292;&#22240;&#20026;ROM BIOS&#25191;&#34892;&#21518;&#26368;&#21518;&#30340;&#24037;&#20316;&#26159;&#25226;&#20027;&#24341;&#23548;&#25159;&#21306;&#25968;&#25454;&#35835;&#20837;&#21040;&#20869;&#23384;&#30340;&#29289;&#29702;&#22320;&#22336;7c00&#22788;</span>
Next at <span style="color: #a0522d;">t</span>=0
(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0
&lt;bochs:1&gt; b 0x7c00
&lt;bochs:2&gt; c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22788;&#29702;&#22120;&#36830;&#32493;&#22320;&#25191;&#34892;&#65292;&#36935;&#21040;&#26029;&#28857;&#20572;&#19979;</span>
......
Next at <span style="color: #a0522d;">t</span>=17175563
(0) [0x000000007c00] 0000:7c00 (unk. ctxt): mov ax, 0x0400            ; b80004
&lt;bochs:3&gt; s
Next at <span style="color: #a0522d;">t</span>=17175564
(0) [0x000000007c03] 0000:7c03 (unk. ctxt): mov bl, 0xf0              ; b3f0
&lt;bochs:4&gt; s
Next at <span style="color: #a0522d;">t</span>=17175565
(0) [0x000000007c05] 0000:7c05 (unk. ctxt): idiv al, bl               ; f6fb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#30456;&#38500;&#20043;&#21069;&#26597;&#30475;&#36890;&#29992;&#23492;&#23384;&#22120;&#20013;&#30340;&#20869;&#23481;</span>
&lt;bochs:5&gt; r
rax: 00000000_00000400 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#34987;&#38500;&#25968;&#22312;AX&#20013;0400</span>
rbx: 00000000_000000f0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38500;&#25968;&#22312;BL&#23492;&#23384;&#20018;f0</span>
rcx: 00000000_00090000
rdx: 00000000_00000080
rsp: 00000000_0000ffd6
rbp: 00000000_00000000
rsi: 00000000_000e0000
rdi: 00000000_0000ffac
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c05
eflags: 0x00000082: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf SF zf af pf cf

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;&#25351;&#20196; idiv al,bl&#21518;&#65292;&#26597;&#30475;&#36890;&#29992;&#23492;&#23384;&#22120;&#20013;&#30340;&#20869;&#23481;</span>
&lt;bochs:6&gt; s
Next at <span style="color: #a0522d;">t</span>=17175566
(0) [0x000000007c07] 0000:7c07 (unk. ctxt): mov ax, 0x0400            ; b80004
&lt;bochs:7&gt; r
rax: 00000000_000000c0  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21830;&#22312;AL&#20013;c0&#65292;&#20313;&#25968;&#22312;AH&#20013;0</span>
rbx: 00000000_000000f0
rcx: 00000000_00090000
rdx: 00000000_00000080
rsp: 00000000_0000ffd6
rbp: 00000000_00000000
rsi: 00000000_000e0000
rdi: 00000000_0000ffac
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c07
eflags: 0x00000082: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf SF zf af pf cf
&lt;bochs:8&gt; q
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6bd9f6fe-343d-4465-b864-58b6abf7e94a" class="outline-3">
<h3 id="h:6bd9f6fe-343d-4465-b864-58b6abf7e94a">有符号数的符号扩展指令</h3>
<div class="outline-text-3" id="text-h:6bd9f6fe-343d-4465-b864-58b6abf7e94a">
<ul class="org-ul">
<li>8位有符号数的范围：-128&#x2026;..0&#x2026;..+127</li>
<li>16位有符号数的范围：-32768&#x2026;&#x2026;0&#x2026;&#x2026;+32768</li>
<li>32位有符号数的范围：-2147483648&#x2026;&#x2026;0&#x2026;&#x2026;+2147483647</li>
</ul>


<pre class="example" id="orgd9285ea">
+7
0000 0111                                 0x07
0000 0000 0000 0111                       0x0007
0000 0000 0000 0000 0000 0000 0000 0111   0x00000007

-3
1111 1101                                 0xFD
1111 1111 1111 1101                       0xFFFD
1111 1111 1111 1111 1111 1111 1111 1101   0xFFFFFFFD
</pre>

<p>
我们发现将8位的有符号数加长之后，等于是符号位做为扩展，是将符号位复制并扩展到左边高位部分。
</p>

<p>
<b>符号扩展指令</b>
</p>

<pre class="example" id="org62088ad">
cbw          ;将AL中的有符号数扩展到AX
              若AL=FD(-3)，则扩展后，AX=FFFD(-3)

cwde         ;将AX中的有符号数扩展到EAX
              若AX=FFFD(-3)，则扩展后，EAX=FFFFFFFD(-3)

cdqe         ;将EAX中有符号数扩展到RAX
              若EAX=FFFFFFFD(-3)，则扩展后，RAX=FFFFFFFFFFFFFFFD(-3)

cwd          ;将AX中的有符号数扩展到DX:AX
              若AX=FFFD(-3)，则扩展后，DX=FFFF, AX=FFFD

cdq         ;将EAX中的有符号数扩展到EDX:EAX
              若EAX=FFFFFFFD(-3)，则扩展后，EDX=FFFFFFFF,EAX=FFFFFFFD

cdo         ;将RAX中有符号数扩展到RDX:RAX
              若RAX=FFFFFFFFFFFFFFFD(-3)，则扩展后，RDX=FFFFFFFFFFFFFFFF, RAX=FFFFFFFFFFFFFFFD(-3)
</pre>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #b22222;">;</span><span style="color: #b22222;">&#20197;&#19979;&#20026;&#26377;&#31526;&#21495;&#25968;&#38500;&#27861;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ax</span>,-6002
<span style="color: #0000ff;">cwd</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">bx</span>,-10
<span style="color: #0000ff;">idiv</span> <span style="color: #a020f0;">bx</span>

<span style="color: #0000ff;">times</span> <span style="color: #a020f0;">510</span>-($-$$) db 0
<span style="color: #0000ff;">db</span> <span style="color: #a020f0;">0x55</span>,0xaa
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:6ba8fc17-c77a-4a5f-a508-264c6056fa84" class="outline-2">
<h2 id="h:6ba8fc17-c77a-4a5f-a508-264c6056fa84">阶段性知识总结和拓展</h2>
<div class="outline-text-2" id="text-h:6ba8fc17-c77a-4a5f-a508-264c6056fa84">
<p>
主要内容
</p>

<ul class="org-ul">
<li>8086的标志寄存器</li>
<li>条件转移指令和CMP指令</li>
</ul>
</div>
<div id="outline-container-h:c30f1b6d-c7c8-46f1-8318-d71958783e9d" class="outline-3">
<h3 id="h:c30f1b6d-c7c8-46f1-8318-d71958783e9d">8086的标志寄存器</h3>
<div class="outline-text-3" id="text-h:c30f1b6d-c7c8-46f1-8318-d71958783e9d">
<p>
8086的标志寄存器FLAGS
</p>

<p>
这是一个16位的寄存器，每位用做一个有特定含意的标志
</p>
<pre class="example" id="org32fd375">
15 14 13 12 11 10 09 08 07 06 05 04 03 02 01 00
            OF DF IF TF SF ZF    AF    PF    CF
</pre>

<ul class="org-ul">
<li>CF: 位0，进位标志(Carry Flag)。当一个算术操作在结果的最高位产生进位或者借位时，此标志是1；否则是0</li>
</ul>

<p>
范例：
</p>
<pre class="example" id="orgb87e72c">
若AL中的内容是二进制数1000 0000
则指令的 add al,al 执行后，CF=1

1000 0000
1000 0000
----------add
0000 0000
</pre>

<ul class="org-ul">
<li>PF: 位2，奇偶标志(Parity Flag)。当一个算术操作的结果在低8位中有偶数个“1”，此标志是1；否则为0</li>
</ul>

<p>
范例：
</p>
<pre class="example" id="org9ee1266">
若AL中的内容是二进制数0010 0110
则指令的 xor al,3 执行后，PF=0

0010 0110
0000 0011
----------xor
0010 0101
</pre>

<ul class="org-ul">
<li>OF: 位11，溢出标志(Overflow Flag)。对任何一个算术操作，假定它进行的是有符号运算。那么，当结果超出目标位置所能
容纳的最大正数或者最小负数时，此标志为1，表示有符号整数运算的结果已经溢出；否则为0.</li>
</ul>

<p>
范例：
</p>
<pre class="example" id="org275aed2">
若AH中的内容是二进制数1111 1101
则指令的 add ah,5 执行后，OF=0

-3
+5
---------add
+2

mov ah,115
add ah,ah  ;此指令执行后，OF=1

mov ax,-56
add ax,axx  ;此指令执行后，OF=0
</pre>


<ul class="org-ul">
<li>ZF: 位6，零标志(zero flag)。 当运算的结果为0，此标志为1；否则为0</li>
</ul>

<p>
范例：
</p>
<pre class="example" id="orge35dfff">
mov ax,25
sub ax,25  ;此指令执行后，ZF=1
</pre>

<ul class="org-ul">
<li>SF: 位7，符号标志(Sign Flag)。用运算结果的最高位来设置此标志(一般来说，这一位是有符号数的符号位。0表示正数，1表示负数)</li>
</ul>

<p>
范例：
</p>
<pre class="example" id="orgb9a634a">
mov ah,127
add ah,1  ;此指令执行后，SF=1

0111 1111
0000 0001
----------add
1000 0000
</pre>

<ul class="org-ul">
<li>AF: 位4，调整标志(Adjust Flag)。当一个算术操作在结果的位3产生进位或者借位，此标志为1；否则是0。此标志用于
二进制编码的十进制数算法里。</li>
</ul>

<p>
范例：
</p>
<pre class="example" id="orgb04b759">
mov ah,247
sub ah,8  ;此指令执行后，AF=1


1111 0111
0000 1000
----------sub
1110 1111
</pre>

<ul class="org-ul">
<li>DF: 位10，方向标志(direction flag) 。控制内存操作的方向，0为正方向</li>
</ul>

<p>
<b>现有指令对标志位的影响</b>
</p>
<ul class="org-ul">
<li>cbw/cwde/cdqe/cwd/cdq/cqo 不影响任何标志位</li>
<li>cld  DF=0，对CF、OF、ZF、AF和PF的影响未定义</li>
<li>std  DF=1，不影响其他标志位</li>
<li>inc/dec  CF标志不受影响；对OF、SF、ZF、AF和PF的影响依计算结果而定</li>
<li>add/sub  OF、SF、ZF、AF、CF和PF的状态依计算结果而定</li>
<li>div/idiv  对CF、OF、SF、ZF、AF和PF的影响未定义</li>
<li>mov/movs  这类指令不影响任何标志位</li>
<li>neg  如果操作数为0，则CF=0，否则CF=1；对OF、SF、ZF、AF和PF的影响依计算结果而定</li>
<li>xor  OF=0, CF=0;对SF、ZF和PF依计算结果而定；对AF的影响未定义。</li>
</ul>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">al</span>,11111000b
<span style="color: #0000ff;">add</span> <span style="color: #a020f0;">al</span>,00001000b

<span style="color: #0000ff;">times</span> <span style="color: #a020f0;">510</span>-($-$$) db 0
<span style="color: #0000ff;">db</span> <span style="color: #a020f0;">0x55</span>,0xaa
</pre>
</div>

<p>
编译
</p>
<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm exam.asm -f bin -o exam.bin -l exam.lst
</pre>
</div>

<p>
将2进制程序写入虚拟硬盘文件learn.vhd
</p>
<ul class="org-ul">
<li>方法1 fixvhdwr.exe 用自定义的程序导入。
<ul class="org-ul">
<li>LBA连续直写模式，起始LBA区号为0</li>
</ul></li>
<li>方法2 其他有效方法</li>
</ul>

<p>
打开bochs调试器bochsdbg.exe进行调试。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26029;&#28857;&#21040;&#29289;&#29702;&#22320;&#22336;7c00&#65292;&#22240;&#20026;ROM BIOS&#25191;&#34892;&#21518;&#26368;&#21518;&#30340;&#24037;&#20316;&#26159;&#25226;&#20027;&#24341;&#23548;&#25159;&#21306;&#25968;&#25454;&#35835;&#20837;&#21040;&#20869;&#23384;&#30340;&#29289;&#29702;&#22320;&#22336;7c00&#22788;</span>
Next at <span style="color: #a0522d;">t</span>=0
(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0
&lt;bochs:1&gt; b 0x7c00
&lt;bochs:2&gt; c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22788;&#29702;&#22120;&#36830;&#32493;&#22320;&#25191;&#34892;&#65292;&#36935;&#21040;&#26029;&#28857;&#20572;&#19979;</span>
......
Next at <span style="color: #a0522d;">t</span>=17175563
(0) [0x000000007c00] 0000:7c00 (unk. ctxt): mov al, 0xf8              ; b0f8

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21453;&#27719;&#32534;3&#26465;&#25351;&#20196;</span>
&lt;bochs:3&gt; u /3
0000000000007c00: (                    ): mov al, 0xf8              ; b0f8
0000000000007c02: (                    ): add al, 0x08              ; 0408
0000000000007c04: (                    ): add byte ptr ds:[bx+si], al ; 0000

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35266;&#23519;&#26631;&#24535;&#23492;&#23384;&#37324;&#26631;&#24535;&#20301;&#21464;&#21270;</span>
&lt;bochs:4&gt; s
Next at <span style="color: #a0522d;">t</span>=17175564
(0) [0x000000007c02] 0000:7c02 (unk. ctxt): add al, 0x08              ; 0408
&lt;bochs:5&gt; info eflags
id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf SF zf af pf cf
&lt;bochs:6&gt; s
Next at <span style="color: #a0522d;">t</span>=17175565
(0) [0x000000007c04] 0000:7c04 (unk. ctxt): add byte ptr ds:[bx+si], al ; 0000
&lt;bochs:7&gt; info eflags
id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf sf ZF AF PF CF
</pre>
</div>
</div>
</div>
<div id="outline-container-h:98dfc75f-3d42-4982-80de-e3eabfd09a80" class="outline-3">
<h3 id="h:98dfc75f-3d42-4982-80de-e3eabfd09a80">条件转移指令和CMP指令</h3>
<div class="outline-text-3" id="text-h:98dfc75f-3d42-4982-80de-e3eabfd09a80">
<p>
<b>条件转移指令</b>
</p>

<pre class="example" id="orgc81d5a3">
js 符号标志SF为1则转移 ;  jns 符号标志SF不为1(为0)则转移

jz 零标志ZF为1则转移;     jnz 零标志ZF不为1(为0)则转移

jo 溢出标志OF为1则转移;   jno 溢出标志OF不为1(为0)则转移

jc 进位标志CF为1则转移;   jnc 进位标志CF不为1(为0)则转移

jp 奇偶标志PF为1则转移;   jnp 奇偶标志PF不为1(为0)则转移
</pre>

<p>
转移指令本身不影响任何标志位，但是它们必须依赖标志位才能工作。因此，它们必须出现在影响标志位的指令之后。
</p>

<p>
范例：
</p>
<pre class="example" id="org6a1f6a5">
dec si
jns show
</pre>

<p>
<b>CMP指令</b>
</p>

<p>
为方便起见，我们更喜欢将俩个数加以比较，判断它们的关系。根据比较结果判断是否转移。那么就可以使用CMP指令。
</p>

<p>
cmp指令格式
</p>
<pre class="example" id="org49cbd24">
cmp  r/m, r/m/imm

影响到CF、OF、SF、ZF、AF和PF标志位

cmp al,35
cmp dx,ax
cmp dx,[0x2002]
cmp byte [0x2002],37
cmp [0x2002],ax
</pre>

<p>
CMP指令在功能上和减法指令SUB是相同的。CMP指令在指令执行时是做减法操作，唯一不同是cmp仅仅根据计算结果来
设定标志位，而不保存计算结果，因此也就不会改变2个操作数的原有内容。会把操作数看成有符号数和无符号数比较。
</p>

<p>
范例
</p>
<pre class="example" id="org34f8027">
cmp dh,0
jl negb ;如果小于0，则转移到negb标号处执行

cmp dh,0x80
jae negb  ;按无符号比较，高于等于转移
</pre>

<p>
<b>受CMP指令执行结果影响的条件转移指令及其依赖的标志位状态</b>
</p>

<p>
记住指令和比较结果就好。
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">指令</th>
<th scope="col" class="org-left">英文描述</th>
<th scope="col" class="org-left">比较结果</th>
<th scope="col" class="org-left">相关标志位的状态</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">je</td>
<td class="org-left">Jump if Equal</td>
<td class="org-left">等于</td>
<td class="org-left">相减结果为零才成立，故要求ZF＝1</td>
</tr>

<tr>
<td class="org-left">jne</td>
<td class="org-left">Jump if Not Equal</td>
<td class="org-left">不等于</td>
<td class="org-left">相减结果不为零才成立，故要求ZF＝0</td>
</tr>

<tr>
<td class="org-left">jg</td>
<td class="org-left">Jump if Greater</td>
<td class="org-left">大于</td>
<td class="org-left">适用于有符号数比较。要求：ZF＝0（两个数不同，相减的结果不为零），并且SF＝OF（如果相减后溢出，则结果必须是负数，说明目的操作数大；如果相减后未溢出，则结果必须是正数，也表明目的操作数大些）</td>
</tr>

<tr>
<td class="org-left">jge</td>
<td class="org-left">Jump if Greater or Equal</td>
<td class="org-left">大于等于</td>
<td class="org-left">适用于有符号数的比较。要求: SF＝OF</td>
</tr>

<tr>
<td class="org-left">jng</td>
<td class="org-left">Jump if Not Greater</td>
<td class="org-left">不大于</td>
<td class="org-left">适用于有符号数的比较。要求：ZF＝1（两个数相同，相减的结果为零），或者SF≠OF（如果相减后溢出，则结果必须是正数，说明源操作数大；如果相减后未溢出，则结果必须是负数，同样表明源操作数大些）</td>
</tr>

<tr>
<td class="org-left">jnge</td>
<td class="org-left">Jump if Not Greater or Equal</td>
<td class="org-left">不大于等于</td>
<td class="org-left">适用于有符号数的比较。要求：SF≠OF</td>
</tr>

<tr>
<td class="org-left">jl</td>
<td class="org-left">Jump if Less</td>
<td class="org-left">小于</td>
<td class="org-left">适用于有符号数的比较，等同于“不大于等于”。要求：SF≠OF</td>
</tr>

<tr>
<td class="org-left">jle</td>
<td class="org-left">Jump if Less or Equal</td>
<td class="org-left">小于等于</td>
<td class="org-left">适用于有符号数的比较，等同于“不大于”。要求：ZF＝1（两个数相同，相减的结果为零），或者SF≠OF（如果相减后溢出，则结果必须是正数，说明源操作数大；如果相减后未溢出，则结果必须是负数，同样表明源操作数大些）</td>
</tr>

<tr>
<td class="org-left">jnl</td>
<td class="org-left">Jump if Not Less</td>
<td class="org-left">不小于</td>
<td class="org-left">适用于有符号数的比较，等同于“大于等于”。要求：SF＝OF</td>
</tr>

<tr>
<td class="org-left">jnle</td>
<td class="org-left">Jump if Not Less or Equal</td>
<td class="org-left">不小于等于</td>
<td class="org-left">适用于有符号数的比较，等同于“大于”。要求：ZF＝0（两个数不同，相减的结果不为零），并且SF＝OF（如果相减后溢出，则结果必须是负数，说明目的操作数大；如果相减后未溢出，则结果必须是正数，也表明目的操作数大些）</td>
</tr>

<tr>
<td class="org-left">ja</td>
<td class="org-left">Jump if Above</td>
<td class="org-left">高于</td>
<td class="org-left">适用于无符号数的比较。要求：CF＝0（没有进位或借位）而且ZF＝0（两个数不相同）</td>
</tr>

<tr>
<td class="org-left">jae</td>
<td class="org-left">Jump if Above or Equal</td>
<td class="org-left">高于等于</td>
<td class="org-left">适用于无符号数的比较。要求：CF＝0（目的操作数大些，不需要借位）</td>
</tr>

<tr>
<td class="org-left">jna</td>
<td class="org-left">Jump if Not Above</td>
<td class="org-left">不高于</td>
<td class="org-left">适用于无符号数的比较，等同于“低于等于”（见后）。要求：CF＝1或者ZF＝1</td>
</tr>

<tr>
<td class="org-left">jnae</td>
<td class="org-left">Jump if Not Above or Equal</td>
<td class="org-left">不高于等于</td>
<td class="org-left">适用于无符号数的比较，等同于“低于”（见后）。要求：CF＝1</td>
</tr>

<tr>
<td class="org-left">jb</td>
<td class="org-left">Jump if Below</td>
<td class="org-left">低于</td>
<td class="org-left">适用于无符号数的比较。要求：CF＝1</td>
</tr>

<tr>
<td class="org-left">jbe</td>
<td class="org-left">Jump if Below or Equal</td>
<td class="org-left">低于等于</td>
<td class="org-left">适用于无符号数的比较。要求：CF＝1或者ZF＝1</td>
</tr>

<tr>
<td class="org-left">jnb</td>
<td class="org-left">Jump if Not Below</td>
<td class="org-left">不低于</td>
<td class="org-left">适用于无符号数的比较，等同于“高于等于”。要求：CF＝0</td>
</tr>

<tr>
<td class="org-left">jnbe</td>
<td class="org-left">Jump if Not Below or Equal</td>
<td class="org-left">不低于等于</td>
<td class="org-left">适用于无符号数的比较，等同于“高于”。要求：CF＝0而且ZF＝0</td>
</tr>

<tr>
<td class="org-left">jpe</td>
<td class="org-left">Jump if Parity Even</td>
<td class="org-left">校验为偶</td>
<td class="org-left">要求：PF＝1</td>
</tr>

<tr>
<td class="org-left">jpo</td>
<td class="org-left">Jump if Parity Odd</td>
<td class="org-left">检验为奇</td>
<td class="org-left">要求：PF＝0</td>
</tr>
</tbody>
</table>


<p>
<b>条件转移指令</b>
</p>

<p>
jcxz (jump if CX is zero)，意思是当CX寄存器的内容为0时则转移。执行这条指令时，处理器先测试寄存器是否为0.
</p>

<p>
范例
</p>
<pre class="example" id="org346f8f4">
jcxz show
</pre>
</div>
</div>
</section>
<section id="outline-container-h:3487204d-7ca4-40ec-995d-9fa54f50d211" class="outline-2">
<h2 id="h:3487204d-7ca4-40ec-995d-9fa54f50d211">从 1 加到 100 并显示结果</h2>
<div class="outline-text-2" id="text-h:3487204d-7ca4-40ec-995d-9fa54f50d211">
<p>
主要内容
</p>

<ul class="org-ul">
<li>字符串的定义和累加过程</li>
<li>栈的原理和使用</li>
<li>栈在数位分解和显示中的应用</li>
<li>在调试器里观察栈操作的状态</li>
<li>进一步认识栈和栈操作的特点</li>
<li>逻辑或指令OR和逻辑与指令AND</li>
</ul>
</div>
<div id="outline-container-h:291ca33b-14b1-4e2f-b991-bc842615b19a" class="outline-3">
<h3 id="h:291ca33b-14b1-4e2f-b991-bc842615b19a">字符串的定义和累加过程</h3>
<div class="outline-text-3" id="text-h:291ca33b-14b1-4e2f-b991-bc842615b19a">
<pre class="example" id="org2b38c63">
1+2+3+......+98+99+100=?
</pre>

<p>
数学家高斯 50 * 101 = 5050。 但是计算机不懂规则，只能从1一直加到100. 它的强项就是速度不怕麻烦。
</p>

<p>
通过1加到100学习很重要的数据结构，栈。而且了解处理器为访问栈提供怎样的支持。
</p>

<p>
范例：主引导扇区程序
</p>

<p>
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm">        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20174;1&#21152;&#21040;100&#24182;&#26174;&#31034;&#32047;&#21152;&#32467;&#26524;</span>
        <span style="color: #a020f0;">jmp</span> start

<span style="color: #0000ff;">message</span> <span style="color: #a020f0;">db</span> '1+2+3+...+100='         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#21516;&#20110; db '1','+','2','+','3','+','.','.','.','+','1','0','0','='</span>

<span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax,0x7c0        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#25968;&#25454;&#27573;&#30340;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> ds,ax

        <span style="color: #a020f0;">mov</span> ax,0xb800       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#38468;&#21152;&#27573;&#22522;&#22336;&#21040;&#26174;&#31034;&#32531;&#20914;&#21306;</span>
        <span style="color: #a020f0;">mov</span> es,ax

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20197;&#19979;&#26174;&#31034;&#23383;&#31526;&#20018;</span>
        <span style="color: #a020f0;">mov</span> si,message
        <span style="color: #a020f0;">mov</span> di,0
        <span style="color: #a020f0;">mov</span> cx,start-message
<span style="color: #0000ff;">showmsg</span>:
        <span style="color: #a020f0;">mov</span> al,[si]
        <span style="color: #a020f0;">mov</span> [es:di],al
        <span style="color: #a020f0;">inc</span> di
        <span style="color: #a020f0;">mov</span> byte [es:di],0x07
        <span style="color: #a020f0;">inc</span> si
        <span style="color: #a020f0;">inc</span> di
        <span style="color: #a020f0;">loop</span> showmsg

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20197;&#19979;&#35745;&#31639;1&#21040;100&#30340;&#21644;</span>
        <span style="color: #a020f0;">xor</span> ax,ax           <span style="color: #b22222;">;</span><span style="color: #b22222;">AX&#29992;&#20110;&#23384;&#25918;&#32047;&#21152;&#32467;&#26524;</span>
        <span style="color: #a020f0;">mov</span> cx,1
<span style="color: #0000ff;">summate</span>:
        <span style="color: #a020f0;">add</span> ax,cx
        <span style="color: #a020f0;">inc</span> cx
        <span style="color: #a020f0;">cmp</span> cx,100
        <span style="color: #a020f0;">jle</span>  summate

        <span style="color: #a020f0;">jmp</span> $

        <span style="color: #a020f0;">times</span> 510-($-$$) db 0
        <span style="color: #a020f0;">db</span> 0x55,0xaa
</pre>
</div>


<p>
在设计8086处理器时，每个寄存器都有自己的特殊用途，比如
</p>
<ul class="org-ul">
<li>AX是累加器(Accumulator)，与它有关的指令还会做指令长度的优化(较短)；</li>
<li>CX是计数器(Counter)；</li>
<li>DX是数据(Data)寄存器，除了作为通用寄存器使用外，还专门用于和外设之间进行数据传送；</li>
<li>SI是源索引寄存器(Source Index)；</li>
<li>DI是目标索引寄存器(Destination Index)，用于数据传送操作</li>
</ul>
</div>
</div>
<div id="outline-container-h:a5ca4c58-3a27-4e87-b85b-19863ee3ffb8" class="outline-3">
<h3 id="h:a5ca4c58-3a27-4e87-b85b-19863ee3ffb8">栈的原理和使用</h3>
<div class="outline-text-3" id="text-h:a5ca4c58-3a27-4e87-b85b-19863ee3ffb8">
<p>
上一节里我们已经完成了字符串的显示和从1加到100的累加过程，累加完后，接下来就要分解数位，为显示结果做准备。
</p>

<p>
我们知道，最先分解出来的数位是最右边的数位，最后分解出来的数位是最左边的数位，为此我们需要先将数位临时保存
起来，然后再按相反的顺序显示在屏幕上。之前是在程序中开辟一个空间来保存数位，这里我们用特殊的方法，将数位
保存在一个特殊的内存区域，栈。
</p>

<p>
栈的概念来自于生活，比如说草堆或者柴火堆。在柴火堆上，下面的草被上面的草压着是拔不出来的，只有将上面的草先移走，先扒走，下面的草才能露出来。
在计算机中，栈是一种特殊的数据存储结构，数据的存取只能从一端进行，这样最先进去的数据只能最后出了，最后进去的数据倒是先出了，这叫做后进先出 last in first out (LIFO)。
</p>



<figure id="org499cbcd">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241201_123802.png" alt="img_20241201_123802.png" width="90%">

</figure>

<p>
如这一幅图所示，我们可以把栈看成是一个只有一端开口的瓶子，比如这个瓶子，这是一个瓶子，只有一端开口，下面是密封的。在这个瓶子里， 1 号球最先放进来， 3 号球最后放进来。显然只有在 2 号球和 3 号球都取出来之后，才能够把 1 号球取出来，按顺序必须先把 3 号球取出才能取 2 号球， 3 号球和 2 号球都取出之后，才能够取 1 号球。显然最后进去的必须先出来，先进去的只能最后出来，这就是栈的特点。听起来像是在讲如何往盒子里放东西，或者从盒子里面取东西，实际上我们还是在讲内存，只不过是另外一种特殊的读写方式而已。
</p>



<figure id="org170f32d">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241201_125432.png" alt="img_20241201_125432.png" width="90%">

</figure>

<p>
计算机的内存是可以自由读写的，在使用内存时，我们根据需要用内存中的不同区域来存储不同的内容，从而形成了代码段、数据段。为了模仿栈的先进后出，后进先出，我们也要在内存里画一部分区域，这个区域叫做栈段。我们知道在处理器里段寄存器 CS 保存着当前正在使用的代码段在内存里的起始位置。段寄存器 DS 或者 ES 保存着当前正在使用的数据段在内存里的起始位置。同样的，在处理器内部有一个段寄存器SS。段寄存器 SS 保存着当前正在使用的栈段，在内存里的起始位置。
</p>


<p>
听起来似乎有些复杂，但是栈的使用是极其简单的，它只有两个动作
</p>
<ul class="org-ul">
<li>第一个动作是把数据推入栈中，这叫做推栈，或者叫压栈。</li>
<li>另一个动作是把数据从栈中取出了，这叫做弹栈，或者叫出栈。</li>
</ul>

<pre class="example" id="org7358dcd">
压栈的指令push
push r/m

压栈指令的操作是将寄存器的内容或者内存中的内容存入栈中。

push dx
push word [0x2002] 将偏移地址 2002 处的一个字取出了，然后压入栈中。

出栈指令pop
pop r/m

从栈中取出一个字，把它存入寄存器或者存入内存地址处。

pop ax
pop word [0x08] 从栈中取出一个字，保存到偏移地址 08 处
</pre>

<p>
压栈和出栈的细节通常是不需要关心的，这个过程是由处理器来自动完成，但是它的原理非常重要，是必须要掌握的。当压栈时，数据是压入栈段的，出栈也是如此，但是处理器如何跟踪这些数据呢？处理器如何知道下一个数据应该压入哪里？下一个要出站的数据位于什么地方呢？答案是在 8086 处理器内部有一个特殊的寄存器，叫做栈指针寄存器SP(stack pointer)。
</p>

<ul class="org-ul">
<li>SP: 栈指针寄存器 SP 用来提供访问栈段的偏移地址。就像指令指针寄存器 IP 一样， SP 是用来提供偏移地址，是访问栈段的偏移地址</li>
<li>SS: 栈段的段地址用 SS 来提供</li>
</ul>

<p>
用段地址SS左移4位加上栈指针寄存器 SP 的内容就形成了访问内存所需要的 20 位物理地址。
</p>

<p>
<b>push 和 pop 指令的执行过程</b>
</p>

<p>
那么压栈和出栈时， 8086 处理器是如何用段寄存器 SS 和栈指针寄存器 SP 来访问栈段的呢？
</p>

<pre class="example" id="org1c2767f">
push的执行过程：
(a) SP &lt;- SP - 操作数的大小(字节数)；
(b) 段寄存器SS左移4位，加上SP里的偏移地址，生成物理地址；
(c) 将操作数写入上述地址处。

pop 的执行过程：
(a) 段寄存器SS左移4位，加上SP里的偏移地址，生成物理地址；
(b) 从上述地址处取得数据，存入由操作数提供的目标位置处
(c) SP &lt;- SP + 2
</pre>

<p>
下面我们通过一段代码来加深对压栈和出栈操作的认识
</p>


<figure id="org3bb154c">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241201_131918.png" alt="img_20241201_131918.png" width="90%">

</figure>

<p>
这是内存的示意图，假定在执行这一段代码的时候，栈段寄存器SS的值是256A，这是逻辑段地址256A。栈指针寄存器 SP 的内容是0200。这意味着栈段在内存中的起始物理地址时 256 A0。因为我们知道断地址是去掉了最后一个 0 的物理地址，因为断地址是256A，所以物理地址是 256A0。后面这些都是物理地址。
</p>

<ul class="org-ul">
<li>第1条指令 push ax 在执行这条指令的时候是将 SP 的内容减 2， 得到01FE，将SS的值256A左移四位生成256A0，再加上01FE是指向物理地址2589E。这个位置叫做站顶。所以我们把寄存器 SP 的值叫做栈顶，而且寄存器 SP 叫做栈顶寄存器，它指示了栈顶部。从这里压入，那么写入之后这两个单元它的内容合成一个字，内容是25。</li>

<li>第2条指令push bx。这一条指令执行的时候，再将SP的值减2，减了之后是 01FC，将SS的值256A左移四位生成256A0，再加上01FC是指向物理地址2589C。然后将寄存器bx的值 30 压入从这个位置处开始的一个字，用来保存30。</li>

<li>第3条指令 push cx。这一条指令执行的时候，再将SP的值减2，减了之后是 01FA，将SS的值256A左移四位生成256A0，再加上01FA是指向物理地址2589A。然后将寄存器cx的值 35 压入从这个位置处开始的一个字，用来保存30。</li>

<li>第1条指令pop DX。 这一条指令执行的时候，首先用 SS 的内容左移4位生成256A0，再加上寄存器SP的当前值01FA生成20位的物理地址2589A。然后从2589A外取出一个字35，传送到寄存器d x。等于是从栈中把数据弹到了DX中。弹完了之后，这条指令的最后一步是将SP的内容加2再存回。 SP 的内容是01FA，加2之后是01FC。</li>

<li>第2条指令pop SI。这一条指令执行的时候，使用SS的值左移4位生成256A0，加上SP的当前值01FC生成物理地址2589C。然后从物理地址2589C处取出一个字30传送到SI中。传送之后SI的值1030，紧接着将 SP 的值加2，再返回SP，那么01FC加2之后是01FE</li>

<li>第3条指令pop di。这一条指令执行的时候，首先用 SS 的内容左移4位生成256A0，再加上寄存器SP的当前值01FE生成20位的物理地址2589E。然后从物理地址2589E处取出一个字25传送到DI中。紧接着将 SP 的值01FE加2，得到0200，然后存回SP中。</li>
</ul>


<p>
通过这个例子可以看出与代码段和数据段不同，栈段的扩展和推进方向是向下的，从高地址向低地址方向推进。而代码段和数据段则不一样，他们是从低地址向高地址方向推进
</p>
</div>
</div>
<div id="outline-container-h:a181afc9-0c9d-4144-a338-3206cc427d9b" class="outline-3">
<h3 id="h:a181afc9-0c9d-4144-a338-3206cc427d9b">栈在数位分解和显示中的应用</h3>
<div class="outline-text-3" id="text-h:a181afc9-0c9d-4144-a338-3206cc427d9b">
<p>
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm">        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20174;1&#21152;&#21040;100&#24182;&#26174;&#31034;&#32047;&#21152;&#32467;&#26524;</span>
        <span style="color: #a020f0;">jmp</span> start

<span style="color: #0000ff;">message</span> <span style="color: #a020f0;">db</span> '1+2+3+...+100='         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#21516;&#20110; db '1','+','2','+','3','+','.','.','.','+','1','0','0','='</span>

<span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax,0x7c0        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#25968;&#25454;&#27573;&#30340;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> ds,ax

        <span style="color: #a020f0;">mov</span> ax,0xb800       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#38468;&#21152;&#27573;&#22522;&#22336;&#21040;&#26174;&#31034;&#32531;&#20914;&#21306;</span>
        <span style="color: #a020f0;">mov</span> es,ax

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20197;&#19979;&#26174;&#31034;&#23383;&#31526;&#20018;</span>
        <span style="color: #a020f0;">mov</span> si,message
        <span style="color: #a020f0;">mov</span> di,0
        <span style="color: #a020f0;">mov</span> cx,start-message
<span style="color: #0000ff;">showmsg</span>:
        <span style="color: #a020f0;">mov</span> al,[si]
        <span style="color: #a020f0;">mov</span> [es:di],al
        <span style="color: #a020f0;">inc</span> di
        <span style="color: #a020f0;">mov</span> byte [es:di],0x07
        <span style="color: #a020f0;">inc</span> si
        <span style="color: #a020f0;">inc</span> di
        <span style="color: #a020f0;">loop</span> showmsg

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20197;&#19979;&#35745;&#31639;1&#21040;100&#30340;&#21644;</span>
        <span style="color: #a020f0;">xor</span> ax,ax           <span style="color: #b22222;">;</span><span style="color: #b22222;">AX&#29992;&#20110;&#23384;&#25918;&#32047;&#21152;&#32467;&#26524;</span>
        <span style="color: #a020f0;">mov</span> cx,1
<span style="color: #0000ff;">summate</span>:
        <span style="color: #a020f0;">add</span> ax,cx
        <span style="color: #a020f0;">inc</span> cx
        <span style="color: #a020f0;">cmp</span> cx,100
        <span style="color: #a020f0;">jle</span>  summate

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20197;&#19979;&#20998;&#35299;&#32047;&#21152;&#21644;&#30340;&#27599;&#20010;&#25968;&#20301;</span>
        <span style="color: #a020f0;">xor</span> cx,cx           <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#26632;&#27573;&#30340;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> ss,cx
        <span style="color: #a020f0;">mov</span> sp,cx

        <span style="color: #a020f0;">mov</span> bx,10
        <span style="color: #a020f0;">xor</span> cx,cx
<span style="color: #0000ff;">decompo</span>:
        <span style="color: #a020f0;">inc</span> cx
        <span style="color: #a020f0;">xor</span> dx,dx
        <span style="color: #a020f0;">div</span> bx
        <span style="color: #a020f0;">add</span> dl,0x30
        <span style="color: #a020f0;">push</span> dx
        <span style="color: #a020f0;">cmp</span> ax,0
        <span style="color: #a020f0;">jne</span> decompo

        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20197;&#19979;&#26174;&#31034;&#21508;&#20010;&#25968;&#20301;</span>
<span style="color: #0000ff;">shownum</span>:
        <span style="color: #a020f0;">pop</span> dx
        <span style="color: #a020f0;">mov</span> [es:di],dl
        <span style="color: #a020f0;">inc</span> di
        <span style="color: #a020f0;">mov</span> byte [es:di], 0x07
        <span style="color: #a020f0;">inc</span> di
        <span style="color: #a020f0;">loop</span> shownum

        <span style="color: #a020f0;">jmp</span> $

        <span style="color: #a020f0;">times</span> 510-($-$$) db 0
        <span style="color: #a020f0;">db</span> 0x55,0xaa
</pre>
</div>



<figure id="orgabc5482">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241201_142845.png" alt="img_20241201_142845.png" width="90%">

</figure>


<figure id="orgab868d7">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241201_142642.png" alt="img_20241201_142642.png" width="90%">

</figure>
</div>
</div>
<div id="outline-container-h:437b6690-50b5-4a73-a870-d3d986264c61" class="outline-3">
<h3 id="h:437b6690-50b5-4a73-a870-d3d986264c61">在调试器里观察栈操作的状态</h3>
<div class="outline-text-3" id="text-h:437b6690-50b5-4a73-a870-d3d986264c61">
<p>
编译
</p>
<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm exam.asm -f bin -o exam.bin -l exam.lst
</pre>
</div>

<p>
将2进制程序写入虚拟硬盘文件learn.vhd
</p>
<ul class="org-ul">
<li>方法1 fixvhdwr.exe 用自定义的程序导入。
<ul class="org-ul">
<li>LBA连续直写模式，起始LBA区号为0</li>
</ul></li>
<li>方法2 其他有效方法</li>
</ul>

<p>
打开bochs调试器bochsdbg.exe进行调试。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26029;&#28857;&#21040;&#29289;&#29702;&#22320;&#22336;7c00&#65292;&#22240;&#20026;ROM BIOS&#25191;&#34892;&#21518;&#26368;&#21518;&#30340;&#24037;&#20316;&#26159;&#25226;&#20027;&#24341;&#23548;&#25159;&#21306;&#25968;&#25454;&#35835;&#20837;&#21040;&#20869;&#23384;&#30340;&#29289;&#29702;&#22320;&#22336;7c00&#22788;</span>
Next at <span style="color: #a0522d;">t</span>=0
(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0
&lt;bochs:1&gt; b 0x7c00
&lt;bochs:2&gt; c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22788;&#29702;&#22120;&#36830;&#32493;&#22320;&#25191;&#34892;&#65292;&#36935;&#21040;&#26029;&#28857;&#20572;&#19979;</span>
......
(0) [0x000000007c00] 0000:7c00 (unk. ctxt): jmp .+14  (0x00007c10)    ; eb0e

&lt;bochs:3&gt; u /50
0000000000007c00: (                    ): jmp .+14  (0x00007c10)    ; eb0e
0000000000007c02: (                    ): xor word ptr ss:[bp+di], bp ; 312b
0000000000007c04: (                    ): xor ch, byte ptr ss:[bp+di] ; 322b
0000000000007c06: (                    ): xor bp, word ptr ss:[bp+di] ; 332b
0000000000007c08: (                    ): sub si, word ptr cs:[bx+di] ; 2e2e2e2b31
0000000000007c0d: (                    ): xor byte ptr ds:[bx+si], dh ; 3030
0000000000007c0f: (                    ): cmp ax, 0xc0b8            ; 3db8c0
0000000000007c12: (                    ): pop es                    ; 07
0000000000007c13: (                    ): mov ds, ax                ; 8ed8
0000000000007c15: (                    ): mov ax, 0xb800            ; b800b8
0000000000007c18: (                    ): mov es, ax                ; 8ec0
0000000000007c1a: (                    ): mov si, 0x0002            ; be0200
0000000000007c1d: (                    ): mov di, 0x0000            ; bf0000
0000000000007c20: (                    ): mov cx, 0x000e            ; b90e00
0000000000007c23: (                    ): mov al, byte ptr ds:[si]  ; 8a04
0000000000007c25: (                    ): mov byte ptr es:[di], al  ; 268805
0000000000007c28: (                    ): inc di                    ; 47
0000000000007c29: (                    ): mov byte ptr es:[di], 0x07 ; 26c60507
0000000000007c2d: (                    ): inc si                    ; 46
0000000000007c2e: (                    ): inc di                    ; 47
0000000000007c2f: (                    ): loop .-14  (0x00007c23)   ; e2f2
0000000000007c31: (                    ): xor ax, ax                ; 31c0
0000000000007c33: (                    ): mov cx, 0x0001            ; b90100
0000000000007c36: (                    ): add ax, cx                ; 01c8
0000000000007c38: (                    ): inc cx                    ; 41
0000000000007c39: (                    ): cmp cx, 0x0064            ; 83f964
0000000000007c3c: (                    ): jle .-8  (0x00007c36)     ; 7ef8
0000000000007c3e: (                    ): xor cx, cx                ; 31c9
0000000000007c40: (                    ): mov ss, cx                ; 8ed1
0000000000007c42: (                    ): mov sp, cx                ; 89cc
0000000000007c44: (                    ): mov bx, 0x000a            ; bb0a00
0000000000007c47: (                    ): xor cx, cx                ; 31c9
0000000000007c49: (                    ): inc cx                    ; 41
0000000000007c4a: (                    ): xor dx, dx                ; 31d2
0000000000007c4c: (                    ): div ax, bx                ; f7f3
0000000000007c4e: (                    ): add dl, 0x30              ; 80c230
0000000000007c51: (                    ): push dx                   ; 52
0000000000007c52: (                    ): cmp ax, 0x0000            ; 83f800
0000000000007c55: (                    ): jnz .-14  (0x00007c49)    ; 75f2
0000000000007c57: (                    ): pop dx                    ; 5a
0000000000007c58: (                    ): mov byte ptr es:[di], dl  ; 268815
0000000000007c5b: (                    ): inc di                    ; 47
0000000000007c5c: (                    ): mov byte ptr es:[di], 0x07 ; 26c60507
0000000000007c60: (                    ): inc di                    ; 47
0000000000007c61: (                    ): loop .-12  (0x00007c57)   ; e2f4
0000000000007c63: (                    ): jmp .-2  (0x00007c63)     ; ebfe
0000000000007c65: (                    ): add byte ptr ds:[bx+si], al ; 0000
0000000000007c67: (                    ): add byte ptr ds:[bx+si], al ; 0000
0000000000007c69: (                    ): add byte ptr ds:[bx+si], al ; 0000
0000000000007c6b: (                    ): add byte ptr ds:[bx+si], al ; 0000

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#20998;&#35299;&#25968;&#20301;&#22788;&#20026;&#26029;&#28857; xor cx,cx</span>
&lt;bochs:4&gt; b 0x7c47
&lt;bochs:5&gt; c
(0) Breakpoint 2, 0x0000000000007c47<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17176075
(0) [0x000000007c47] 0000:7c47 (unk. ctxt): xor cx, cx                ; 31c9
&lt;bochs:6&gt; n
Next at <span style="color: #a0522d;">t</span>=17176076
(0) [0x000000007c49] 0000:7c49 (unk. ctxt): inc cx                    ; 41
&lt;bochs:7&gt; n
Next at <span style="color: #a0522d;">t</span>=17176077
(0) [0x000000007c4a] 0000:7c4a (unk. ctxt): xor dx, dx                ; 31d2
&lt;bochs:8&gt; n
Next at <span style="color: #a0522d;">t</span>=17176078
(0) [0x000000007c4c] 0000:7c4c (unk. ctxt): div ax, bx                ; f7f3
&lt;bochs:9&gt; n
Next at <span style="color: #a0522d;">t</span>=17176079
(0) [0x000000007c4e] 0000:7c4e (unk. ctxt): add dl, 0x30              ; 80c230
&lt;bochs:10&gt; n
Next at <span style="color: #a0522d;">t</span>=17176080
(0) [0x000000007c51] 0000:7c51 (unk. ctxt): push dx                   ; 52

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35266;&#23519;&#21387;&#26632;&#21069;&#65292;&#26632;&#27573;&#23492;&#23384;&#22120;SS&#21644;&#26632;&#25351;&#38024;&#23492;&#23384;&#22120;SP&#30340;&#20540;</span>
&lt;bochs:11&gt; sreg
es:0xb800, <span style="color: #a0522d;">dh</span>=0x0000930b, <span style="color: #a0522d;">dl</span>=0x8000ffff, <span style="color: #a0522d;">valid</span>=7
        Data segment, <span style="color: #a0522d;">base</span>=0x000b8000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
cs:0x0000, <span style="color: #a0522d;">dh</span>=0x00009300, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=1
        Data segment, <span style="color: #a0522d;">base</span>=0x00000000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
ss:0x0000, <span style="color: #a0522d;">dh</span>=0x00009300, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=1  <span style="color: #b22222;">#</span><span style="color: #b22222;">SS&#20540;&#20026;0000</span>
        Data segment, <span style="color: #a0522d;">base</span>=0x00000000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
ds:0x07c0, <span style="color: #a0522d;">dh</span>=0x00009300, <span style="color: #a0522d;">dl</span>=0x7c00ffff, <span style="color: #a0522d;">valid</span>=3
        Data segment, <span style="color: #a0522d;">base</span>=0x00007c00, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
fs:0x0000, <span style="color: #a0522d;">dh</span>=0x00009300, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=1
        Data segment, <span style="color: #a0522d;">base</span>=0x00000000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
gs:0x0000, <span style="color: #a0522d;">dh</span>=0x00009300, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=1
        Data segment, <span style="color: #a0522d;">base</span>=0x00000000, <span style="color: #a0522d;">limit</span>=0x0000ffff, Read/Write, Accessed
ldtr:0x0000, <span style="color: #a0522d;">dh</span>=0x00008200, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=1
tr:0x0000, <span style="color: #a0522d;">dh</span>=0x00008b00, <span style="color: #a0522d;">dl</span>=0x0000ffff, <span style="color: #a0522d;">valid</span>=1
gdtr:<span style="color: #a0522d;">base</span>=0x00000000000f9e67, <span style="color: #a0522d;">limit</span>=0x30
idtr:<span style="color: #a0522d;">base</span>=0x0000000000000000, <span style="color: #a0522d;">limit</span>=0x3ff
&lt;bochs:12&gt; r
rax: 00000000_000001f9
rbx: 00000000_0000000a
rcx: 00000000_00090001
rdx: 00000000_00000030
rsp: 00000000_00000000 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26632;&#25351;&#38024;&#23492;&#23384;&#22120;SP&#20026;0000</span>
rbp: 00000000_00000000
rsi: 00000000_000e0010
rdi: 00000000_0000001c
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c51
eflags: 0x00000006: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf sf zf af PF cf

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35266;&#23519;&#21387;&#26632;&#21518;&#65292;&#26632;&#27573;&#23492;&#23384;&#22120;SS&#21644;&#26632;&#25351;&#38024;&#23492;&#23384;&#22120;SP&#30340;&#20540;</span>
&lt;bochs:13&gt; n
Next at <span style="color: #a0522d;">t</span>=17176081
(0) [0x000000007c52] 0000:7c52 (unk. ctxt): cmp ax, 0x0000            ; 83f800
&lt;bochs:14&gt; r
rax: 00000000_000001f9
rbx: 00000000_0000000a
rcx: 00000000_00090001
rdx: 00000000_00000030
rsp: 00000000_0000fffe  <span style="color: #b22222;">#</span><span style="color: #b22222;">SP = SP-2</span>
rbp: 00000000_00000000
rsi: 00000000_000e0010
rdi: 00000000_0000001c
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c52
eflags: 0x00000006: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf sf zf af PF cf
&lt;bochs:15&gt; print-stack  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35266;&#23519;&#26632;&#20869;&#23481;, print-stack&#27599;&#27425;&#26174;&#31034;&#26632;&#39030;10&#20010;&#25968;&#25454;</span>
Stack address size 2
 | STACK 0xfffe [0x0030] (&lt;unknown&gt;)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26632;&#39030;&#12290;fffe&#22788;&#21387;&#20837;&#20102;&#19968;&#20010;&#23383;&#65292;0x0030</span>
 | STACK 0x10000 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10002 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10004 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10006 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10008 [0x0000] (&lt;unknown&gt;)
 | STACK 0x1000a [0x0000] (&lt;unknown&gt;)
 | STACK 0x1000c [0x0000] (&lt;unknown&gt;)
 | STACK 0x1000e [0x0000] (&lt;unknown&gt;)
 | STACK 0x10010 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10012 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10014 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10016 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10018 [0x0000] (&lt;unknown&gt;)
 | STACK 0x1001a [0x0000] (&lt;unknown&gt;)
 | STACK 0x1001c [0x0000] (&lt;unknown&gt;)


 &lt;bochs:16&gt; n
Next at <span style="color: #a0522d;">t</span>=17176082
(0) [0x000000007c55] 0000:7c55 (unk. ctxt): jnz .-14  (0x00007c49)    ; 75f2
&lt;bochs:17&gt; n
Next at <span style="color: #a0522d;">t</span>=17176083
(0) [0x000000007c49] 0000:7c49 (unk. ctxt): inc cx                    ; 41
&lt;bochs:18&gt; n
Next at <span style="color: #a0522d;">t</span>=17176084
(0) [0x000000007c4a] 0000:7c4a (unk. ctxt): xor dx, dx                ; 31d2
&lt;bochs:19&gt; n
Next at <span style="color: #a0522d;">t</span>=17176085
(0) [0x000000007c4c] 0000:7c4c (unk. ctxt): div ax, bx                ; f7f3
&lt;bochs:20&gt; n
Next at <span style="color: #a0522d;">t</span>=17176086
(0) [0x000000007c4e] 0000:7c4e (unk. ctxt): add dl, 0x30              ; 80c230
&lt;bochs:21&gt; n
Next at <span style="color: #a0522d;">t</span>=17176087
(0) [0x000000007c51] 0000:7c51 (unk. ctxt): push dx                   ; 52
&lt;bochs:22&gt; n
Next at <span style="color: #a0522d;">t</span>=17176088
(0) [0x000000007c52] 0000:7c52 (unk. ctxt): cmp ax, 0x0000            ; 83f800
&lt;bochs:23&gt; r
rax: 00000000_00000032
rbx: 00000000_0000000a
rcx: 00000000_00090002
rdx: 00000000_00000035
rsp: 00000000_0000fffc
rbp: 00000000_00000000
rsi: 00000000_000e0010
rdi: 00000000_0000001c
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c52
eflags: 0x00000006: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf sf zf af PF cf
&lt;bochs:24&gt; print-stack
Stack address size 2
 | STACK 0xfffc [0x0035] (&lt;unknown&gt;)
 | STACK 0xfffe [0x0030] (&lt;unknown&gt;)
 | STACK 0x10000 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10002 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10004 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10006 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10008 [0x0000] (&lt;unknown&gt;)
 | STACK 0x1000a [0x0000] (&lt;unknown&gt;)
 | STACK 0x1000c [0x0000] (&lt;unknown&gt;)
 | STACK 0x1000e [0x0000] (&lt;unknown&gt;)
 | STACK 0x10010 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10012 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10014 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10016 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10018 [0x0000] (&lt;unknown&gt;)
 | STACK 0x1001a [0x0000] (&lt;unknown&gt;)


 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35266;&#23519;POP&#20986;&#26632;</span>
 &lt;bochs:25&gt; u/10
0000000000007c52: (                    ): cmp ax, 0x0000            ; 83f800
0000000000007c55: (                    ): jnz .-14  (0x00007c49)    ; 75f2
0000000000007c57: (                    ): pop dx                    ; 5a
0000000000007c58: (                    ): mov byte ptr es:[di], dl  ; 268815
0000000000007c5b: (                    ): inc di                    ; 47
0000000000007c5c: (                    ): mov byte ptr es:[di], 0x07 ; 26c60507
0000000000007c60: (                    ): inc di                    ; 47
0000000000007c61: (                    ): loop .-12  (0x00007c57)   ; e2f4
0000000000007c63: (                    ): jmp .-2  (0x00007c63)     ; ebfe
0000000000007c65: (                    ): add byte ptr ds:[bx+si], al ; 0000
&lt;bochs:26&gt; b 0x7c57
&lt;bochs:27&gt; c
(0) Breakpoint 3, 0x0000000000007c57<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17176104
(0) [0x000000007c57] 0000:7c57 (unk. ctxt): pop dx                    ; 5a
&lt;bochs:28&gt; r
rax: 00000000_00000000
rbx: 00000000_0000000a
rcx: 00000000_00090004
rdx: 00000000_00000035
rsp: 00000000_0000fff8  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26632;&#39030;fff8</span>
rbp: 00000000_00000000
rsi: 00000000_000e0010
rdi: 00000000_0000001c
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c57
eflags: 0x00000046: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf sf ZF af PF cf
&lt;bochs:29&gt; print-stack
Stack address size 2
 | STACK 0xfff8 [0x0035] (&lt;unknown&gt;)
 | STACK 0xfffa [0x0030] (&lt;unknown&gt;)
 | STACK 0xfffc [0x0035] (&lt;unknown&gt;)
 | STACK 0xfffe [0x0030] (&lt;unknown&gt;)
 | STACK 0x10000 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10002 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10004 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10006 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10008 [0x0000] (&lt;unknown&gt;)
 | STACK 0x1000a [0x0000] (&lt;unknown&gt;)
 | STACK 0x1000c [0x0000] (&lt;unknown&gt;)
 | STACK 0x1000e [0x0000] (&lt;unknown&gt;)
 | STACK 0x10010 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10012 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10014 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10016 [0x0000] (&lt;unknown&gt;)

 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20986;&#26632;&#21518;&#65292;&#35266;&#23519;</span>
 &lt;bochs:30&gt; n
Next at <span style="color: #a0522d;">t</span>=17176105
(0) [0x000000007c58] 0000:7c58 (unk. ctxt): mov byte ptr es:[di], dl  ; 268815
&lt;bochs:31&gt; r
rax: 00000000_00000000
rbx: 00000000_0000000a
rcx: 00000000_00090004
rdx: 00000000_00000035
rsp: 00000000_0000fffa  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26632;&#39030;fffa</span>
rbp: 00000000_00000000
rsi: 00000000_000e0010
rdi: 00000000_0000001c
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c58
eflags: 0x00000046: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf sf ZF af PF cf
&lt;bochs:32&gt; print-stack
Stack address size 2
 | STACK 0xfffa [0x0030] (&lt;unknown&gt;)
 | STACK 0xfffc [0x0035] (&lt;unknown&gt;)
 | STACK 0xfffe [0x0030] (&lt;unknown&gt;)
 | STACK 0x10000 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10002 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10004 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10006 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10008 [0x0000] (&lt;unknown&gt;)
 | STACK 0x1000a [0x0000] (&lt;unknown&gt;)
 | STACK 0x1000c [0x0000] (&lt;unknown&gt;)
 | STACK 0x1000e [0x0000] (&lt;unknown&gt;)
 | STACK 0x10010 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10012 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10014 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10016 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10018 [0x0000] (&lt;unknown&gt;)


&lt;bochs:33&gt; n
Next at <span style="color: #a0522d;">t</span>=17176106
(0) [0x000000007c5b] 0000:7c5b (unk. ctxt): inc di                    ; 47
&lt;bochs:34&gt; n
Next at <span style="color: #a0522d;">t</span>=17176107
(0) [0x000000007c5c] 0000:7c5c (unk. ctxt): mov byte ptr es:[di], 0x07 ; 26c60507
&lt;bochs:35&gt; n
Next at <span style="color: #a0522d;">t</span>=17176108
(0) [0x000000007c60] 0000:7c60 (unk. ctxt): inc di                    ; 47
&lt;bochs:36&gt; n
Next at <span style="color: #a0522d;">t</span>=17176109
(0) [0x000000007c61] 0000:7c61 (unk. ctxt): loop .-12  (0x00007c57)   ; e2f4
&lt;bochs:37&gt; n
(0) Breakpoint 3, 0x0000000000007c57<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17176110
(0) [0x000000007c57] 0000:7c57 (unk. ctxt): pop dx                    ; 5a
&lt;bochs:38&gt; n
Next at <span style="color: #a0522d;">t</span>=17176111
(0) [0x000000007c58] 0000:7c58 (unk. ctxt): mov byte ptr es:[di], dl  ; 268815
&lt;bochs:39&gt; r
rax: 00000000_00000000
rbx: 00000000_0000000a
rcx: 00000000_00090003
rdx: 00000000_00000030
rsp: 00000000_0000fffc
rbp: 00000000_00000000
rsi: 00000000_000e0010
rdi: 00000000_0000001e
r8 : 00000000_00000000
r9 : 00000000_00000000
r10: 00000000_00000000
r11: 00000000_00000000
r12: 00000000_00000000
r13: 00000000_00000000
r14: 00000000_00000000
r15: 00000000_00000000
rip: 00000000_00007c58
eflags: 0x00000006: id vip vif ac vm rf nt <span style="color: #a0522d;">IOPL</span>=0 of df if tf sf zf af PF cf
&lt;bochs:40&gt; print-stack
Stack address size 2
 | STACK 0xfffc [0x0035] (&lt;unknown&gt;)
 | STACK 0xfffe [0x0030] (&lt;unknown&gt;)
 | STACK 0x10000 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10002 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10004 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10006 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10008 [0x0000] (&lt;unknown&gt;)
 | STACK 0x1000a [0x0000] (&lt;unknown&gt;)
 | STACK 0x1000c [0x0000] (&lt;unknown&gt;)
 | STACK 0x1000e [0x0000] (&lt;unknown&gt;)
 | STACK 0x10010 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10012 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10014 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10016 [0x0000] (&lt;unknown&gt;)
 | STACK 0x10018 [0x0000] (&lt;unknown&gt;)
 | STACK 0x1001a [0x0000] (&lt;unknown&gt;)

 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32467;&#26463;&#35843;&#35797;</span>
 &lt;bochs:41&gt; c
(0) Breakpoint 3, 0x0000000000007c57<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17176116
(0) [0x000000007c57] 0000:7c57 (unk. ctxt): pop dx                    ; 5a
&lt;bochs:42&gt; c
(0) Breakpoint 3, 0x0000000000007c57<span style="color: #a020f0;"> in</span> ?? ()
Next at <span style="color: #a0522d;">t</span>=17176122
(0) [0x000000007c57] 0000:7c57 (unk. ctxt): pop dx                    ; 5a
&lt;bochs:43&gt; c
</pre>
</div>
</div>
</div>
<div id="outline-container-h:79116b03-71e9-4dc8-835e-b9e590393d40" class="outline-3">
<h3 id="h:79116b03-71e9-4dc8-835e-b9e590393d40">进一步认识栈和栈操作的特点</h3>
<div class="outline-text-3" id="text-h:79116b03-71e9-4dc8-835e-b9e590393d40">
<p>
在8086上，push和po指令的操作数只能是16位的。
</p>

<pre class="example" id="orgca5b34e">
push cs
pop ds

结果与以下2条指令执行的结果相同
mov ax,cs
mov ds,ax
</pre>

<p>
栈在本质上也只是普通的内存区域。之所以用push和pop访问是因为你把它看成栈而已。把栈看成普通的数据忘掉它是一个栈，它将不再神秘。这样做只是为了方便程序开发。
</p>

<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">push</span> <span style="color: #a020f0;">ax</span>

<span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#20215;</span>
<span style="color: #0000ff;">sub</span> <span style="color: #a020f0;">sp</span>,2
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">bx</span>,sp
<span style="color: #0000ff;">mov</span> [ss:bx],ax

<span style="color: #0000ff;">pop</span> <span style="color: #a020f0;">ax</span>

<span style="color: #b22222;">;</span><span style="color: #b22222;">&#31561;&#20215;</span>
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">bx</span>,sp
<span style="color: #0000ff;">mov</span> <span style="color: #a020f0;">ax</span>,[ss:bx]
<span style="color: #0000ff;">add</span> <span style="color: #a020f0;">sp</span>,2
</pre>
</div>

<p>
<b>必须保持栈平衡</b>
</p>

<p>
压栈和出栈必须是配对的。有一个压栈操作必须有一个出栈操作。
</p>

<p>
<b>充分估计需要的栈空间</b>
</p>

<p>
在编写程序之前，必须充分估计所需要的栈空间。避免有重叠部分的时候数据造成混乱。
</p>


<figure id="orgb9190c1">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241201_150726.png" alt="img_20241201_150726.png" width="90%">

</figure>
</div>
</div>
<div id="outline-container-h:736a5550-ab34-4a30-9d7f-d5929af11042" class="outline-3">
<h3 id="h:736a5550-ab34-4a30-9d7f-d5929af11042">逻辑或指令OR和逻辑与指令AND</h3>
<div class="outline-text-3" id="text-h:736a5550-ab34-4a30-9d7f-d5929af11042">
<p>
<b>逻辑或指令OR</b>
</p>

<p>
或门(OR-GATE)
</p>

<p>
只要有一个输入是1，输出是1；输入都为0，输出为0
</p>


<figure id="orgf63a791">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241201_150937.png" alt="img_20241201_150937.png" width="90%">

</figure>

<pre class="example" id="org00aec24">
0 or 0 = 0
0 or 1 = 1
1 or 0 = 1
1 or 1 = 1
</pre>

<p>
或操作可以在2个数之间进行
</p>

<pre class="example" id="org5897b22">
129 or 127 = ?

1000 0001
0111 1111
----------or
1111 1111  255
</pre>

<p>
or指令格式
</p>
<pre class="example" id="org6fd9856">
or  r/m, r/m/imm

或运算的结果在左操作数。

注意：俩个操作数长度一致

or bh,al
or cx,dx
or ax,3
or word [0x2002],67
or si,[0x2002]
</pre>

<p>
逻辑或指令or执行之后
</p>
<pre class="example" id="org44b789f">
OF=0, CF=0;
SF、ZF和PF依计算结果而定
AF的状态未定义
</pre>

<p>
<b>逻辑与指令AND</b>
</p>

<p>
与门(AND-GATE)
</p>

<p>
除非俩个输入是1，输出才是1.
</p>


<figure id="orgcfea81d">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241201_152005.png" alt="img_20241201_152005.png" width="90%">

</figure>

<pre class="example" id="org24fbbf6">
0 and 0 = 0
0 and 1 = 0
1 and 0 = 0
1 and 1 = 1
</pre>

<p>
逻辑与操作可以在俩个数之间进行
</p>
<pre class="example" id="org65eee70">
129 and 127 = ?

1000 0001
0111 1111
----------and
0000 0001  1
</pre>

<p>
在处理器中，引入一个指令做逻辑与操作，and
</p>

<p>
and指令格式
</p>
<pre class="example" id="orgaaee4d9">
and  r/m,  r/m/imm

与运算的结果在左操作数。

注意：俩个操作数长度一致

and bh,al
and cx,dx
and ax,3
and word [0x2002],67
and si,[0x2002]
</pre>
</div>
</div>
</section>
<section id="outline-container-h:c1771758-bb4c-42cb-8879-e974198a66a9" class="outline-2">
<h2 id="h:c1771758-bb4c-42cb-8879-e974198a66a9">INTEL 8086 处理器的寻址方式</h2>
<div class="outline-text-2" id="text-h:c1771758-bb4c-42cb-8879-e974198a66a9">
<p>
主要内容
</p>

<ul class="org-ul">
<li>寄存器、立即数和直接寻址</li>
<li>基址寻址</li>
<li>变址寻址</li>
<li>基址变址寻址</li>
<li>练习</li>
</ul>
</div>
<div id="outline-container-h:e1c6329c-256a-4bbb-855b-b15839dfe9c3" class="outline-3">
<h3 id="h:e1c6329c-256a-4bbb-855b-b15839dfe9c3">寄存器、立即数和直接寻址</h3>
<div class="outline-text-3" id="text-h:e1c6329c-256a-4bbb-855b-b15839dfe9c3">
<p>
<b>什么是寻址方式？</b>
</p>

<p>
处理器的任务是取指令并执行指令，指定了处理器的操作。很多操作和数字有关，所以必须在指令中指定被操作
的数字从哪里来，操作完后把结果送到哪里去。这叫做寻址方式，Addressing Mode.
</p>

<p>
简单的说寻址方式就是如何找到要操作的数据，如何找到要存放结果的地址。
</p>

<p>
<b>寄存器寻址</b>
</p>

<p>
寄存器寻址：操作的数位于寄存器中
</p>

<p>
范例：
</p>
<pre class="example" id="org91a1de8">
mov ax,cx  ;左右操作数都是寄存器寻址
add bx,0xf000 ;左操作或者说目的操作数是寄存器
inc dx
</pre>


<p>
<b>立即数寻址</b>
</p>

<p>
立即数寻址：操作数是由立即数指定的
</p>

<p>
范例：
</p>
<pre class="example" id="org666ae38">
add bx,0xf000 ;右操作数或者说源操作数是立即数
mov dx, mydata ;右操作数是标号，标号是汇编地址，在本质上是数字。在程序编译阶段标号会被转换为立即数
</pre>

<p>
<b>直接(内存)寻址</b>
</p>

<p>
内存寻址：操作数在内存里
</p>

<p>
8086处理器在访问内存时，采用的是段地址左移4位，然后再加上偏移地址来形成20位的物理地址。段地址是由
CS,DS,ES,SS之一来提供，偏移地址必须由指令来提供。因此所谓的内存寻址实际上是寻找偏移地址，通过偏移地址
来寻找操作数。
</p>

<p>
如果在指令中直接给出来偏移地址，这叫直接寻址。
</p>

<p>
范例
</p>
<pre class="example" id="orgadcfb68">
mov ax,[0x5c0f] ;源操作数采用直接寻址。指令执行时，数据段寄存器的内容左移4位，再加上偏移地址50c0f，得到物理地址。从这个地址处取得一个字传到ax中。
add word [0x0230],0x5000
xor byte [es:mydata],0x05 ;直接寻址. 指令编译时，标号mydata被转换成数值，这个数值就是偏移地址。这里采用了段超越前缀es。当指令执行时，将段寄存器
                                              ES的内容左移4位，再加上偏移地址形成20位的物理地址。将源操作数0x05传送到这个内存地址处。
</pre>
</div>
</div>
<div id="outline-container-h:d282dfb3-6ec4-4a80-b7c1-4db4a8d0b792" class="outline-3">
<h3 id="h:d282dfb3-6ec4-4a80-b7c1-4db4a8d0b792">基址寻址</h3>
<div class="outline-text-3" id="text-h:d282dfb3-6ec4-4a80-b7c1-4db4a8d0b792">
<p>
在8086处理器中，基址寻址是用基址寄存器BX或者BP来提供操作数的偏移地址。偏移地址通常也叫做有效地址(Effective Address)。
</p>

<pre class="example" id="org0a5287f">
    buffer dw 0x20,0x100,0x0f,0x300,0xff00

    ;以下使用直接寻址方式将所有数据加1
    inc  word [buffer]
    inc  word [buffer+2]
    inc  word [buffer+4]
    inc  word [buffer+6]
    inc  word [buffer+8]

    ;以下使用基址寻址方式将所有数据加1
    mov bx,buffer
    mov cx,5
lpinc:
    inc word [bx]
    add bx,2
    loop lpinc

    ;基址寄存器bx提供有效地址，默认段寄存器是DS
    mov ax,0x5000
    mov bx,0x7000
    mov cx,0x8000

    push ax
    push bx
    push cx

    mov bx,sp
    mov dx,[ss:bx+2]

    pop ax
    pop bx
    pop cx

    ;基址寄存器bp提供有效地址，默认段寄存器是SS,可省略段超越前缀SS
    mov ax,0x5000
    mov bx,0x7000
    mov cx,0x8000

    push ax
    push bx
    push cx

    mov bp,sp
    mov dx,[bp+2]

    pop ax
    pop bx
    pop cx
</pre>
</div>
</div>
<div id="outline-container-h:d671e6ef-11e7-4ca0-a550-768bc01b3728" class="outline-3">
<h3 id="h:d671e6ef-11e7-4ca0-a550-768bc01b3728">变址寻址</h3>
<div class="outline-text-3" id="text-h:d671e6ef-11e7-4ca0-a550-768bc01b3728">
<p>
变址寻址类似于基址寻址，唯一不同之处在于这种方式使用的是SI和DI，或者叫索引寄存器。
</p>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #b22222;">;</span><span style="color: #b22222;">&#20351;&#29992;&#21464;&#22336;&#23547;&#22336;</span>
<span style="color: #0000ff;">mov</span> [si],dx <span style="color: #b22222;">;</span><span style="color: #b22222;">&#30446;&#30340;&#25805;&#20316;&#25968;&#26159;&#19968;&#20010;&#22320;&#22336;&#65292;&#26469;&#33258;&#20110;&#32034;&#24341;&#23492;&#23384;&#22120;SI</span>
<span style="color: #0000ff;">add</span> <span style="color: #a020f0;">ax</span>,[di] <span style="color: #b22222;">;</span><span style="color: #b22222;">&#28304;&#25805;&#20316;&#25968;&#26469;&#33258;&#20110;&#23547;&#22336;&#23492;&#23384;&#22120;DI&#65292;</span>
<span style="color: #0000ff;">xor</span> <span style="color: #a020f0;">word</span> [si],0x8000 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#30446;&#30340;&#25805;&#20316;&#25968;&#26159;&#19968;&#20010;&#22320;&#22336;&#65292;&#26469;&#33258;&#20110;&#32034;&#24341;&#23492;&#23384;&#22120;SI</span>

<span style="color: #b22222;">;</span><span style="color: #b22222;">&#22914;&#26524;&#22312;&#25351;&#20196;&#20013;&#20351;&#29992;&#20102;SI&#21644;DI&#26469;&#25552;&#20379;&#20559;&#31227;&#22320;&#22336;&#65292;&#32780;&#19988;&#27809;&#26377;&#20351;&#29992;&#27573;&#36229;&#36234;&#21069;&#32512;&#65292;&#21017;&#40664;&#35748;&#20351;&#29992;&#27573;&#23492;&#23384;&#22120;DS&#26469;&#25552;&#20379;&#27573;&#22320;&#22336;&#12290;</span>

<span style="color: #b22222;">;</span><span style="color: #b22222;">&#20351;&#29992;&#21464;&#22336;&#23547;&#22336;</span>
<span style="color: #0000ff;">mov</span> [si+0x100],al <span style="color: #b22222;">;</span><span style="color: #b22222;">&#30446;&#30340;&#25805;&#20316;&#25968;&#26159;&#19968;&#20010;&#20869;&#23384;&#22320;&#22336;&#65292;&#20559;&#31227;&#22320;&#22336;&#26159;&#30001;&#21464;&#22336;&#23492;&#23384;&#22120;SI&#21152;&#19978;&#20559;&#31227;&#37327;0x100&#30340;&#32467;&#26524;&#12290;</span>
<span style="color: #0000ff;">and</span> <span style="color: #a020f0;">byte</span> [di+mydata],0x80 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#26631;&#21495;&#20195;&#34920;&#27719;&#32534;&#22320;&#22336;&#65292;&#26412;&#36136;&#19978;&#26159;&#19968;&#20010;&#25968;&#23383;&#12290;</span>
</pre>
</div>

<p>
让处理器支持多种寻址方式会增加硬件的复杂性，但是可以增强处理器的处理能力。
</p>

<p>
范例：主引导扇区程序
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm">        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23601;&#22320;&#21453;&#36716;&#23383;&#31526;&#20018;&#30340;&#20869;&#23481;</span>
        <span style="color: #a020f0;">jmp</span> start

<span style="color: #0000ff;">string</span>  <span style="color: #a020f0;">db</span> 'abcdefghijklmnopqrstuvwxyz'

<span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax,0x7c0        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#25968;&#25454;&#27573;&#30340;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> ds,ax

        <span style="color: #a020f0;">mov</span> ax,cs           <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#26632;&#27573;&#30340;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> ss,ax           <span style="color: #b22222;">;</span><span style="color: #b22222;">&#36825;&#26679;&#65292;&#26632;&#27573;SS&#30340;&#20869;&#23481;&#23601;&#21644;&#20195;&#30721;&#27573;CS&#20869;&#23481;&#19968;&#33268;&#20102;</span>
        <span style="color: #a020f0;">mov</span> sp,0            <span style="color: #b22222;">;</span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#26632;&#39030;&#25351;&#38024;</span>

        <span style="color: #a020f0;">mov</span> cx,start-string  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24490;&#29615;&#27425;&#25968;&#65292;&#20174;26&#21040;1&#65292;&#20849;26&#27425;</span>
        <span style="color: #a020f0;">mov</span> bx,string       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#25968;&#25454;&#21306;&#39318;&#22320;&#22336;(&#22522;&#22320;&#22336;)</span>
<span style="color: #0000ff;">lppush</span>:
        <span style="color: #a020f0;">mov</span> al,[bx]
        <span style="color: #a020f0;">push</span> ax
        <span style="color: #a020f0;">inc</span> bx
        <span style="color: #a020f0;">loop</span> lppush         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24490;&#29615;&#21387;&#26632;</span>

        <span style="color: #a020f0;">mov</span> cx,start-string
        <span style="color: #a020f0;">mov</span> bx,string
<span style="color: #0000ff;">lppop</span>:
        <span style="color: #a020f0;">pop</span> ax
        <span style="color: #a020f0;">mov</span> [bx],al
        <span style="color: #a020f0;">inc</span> bx
        <span style="color: #a020f0;">loop</span> lppop          <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24490;&#29615;&#20986;&#26632;</span>

        <span style="color: #a020f0;">jmp</span> $

        <span style="color: #a020f0;">times</span> 510-($-$$) db 0
        <span style="color: #a020f0;">db</span> 0x55,0xaa
</pre>
</div>

<p>
这里的bx使用了基址寻址，可以换成si或者di，就是变址寻址方式了。
</p>


<p>
编译
</p>
<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm exam.asm -f bin -o exam.bin -l exam.lst
</pre>
</div>

<p>
将2进制程序写入虚拟硬盘文件learn.vhd
</p>
<ul class="org-ul">
<li>方法1 fixvhdwr.exe 用自定义的程序导入。
<ul class="org-ul">
<li>LBA连续直写模式，起始LBA区号为0</li>
</ul></li>
<li>方法2 其他有效方法</li>
</ul>

<p>
打开bochs调试器bochsdbg.exe进行调试。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26029;&#28857;&#21040;&#29289;&#29702;&#22320;&#22336;7c00&#65292;&#22240;&#20026;ROM BIOS&#25191;&#34892;&#21518;&#26368;&#21518;&#30340;&#24037;&#20316;&#26159;&#25226;&#20027;&#24341;&#23548;&#25159;&#21306;&#25968;&#25454;&#35835;&#20837;&#21040;&#20869;&#23384;&#30340;&#29289;&#29702;&#22320;&#22336;7c00&#22788;</span>
Next at <span style="color: #a0522d;">t</span>=0
(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0
&lt;bochs:1&gt; b 0x7c00
&lt;bochs:2&gt; c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22788;&#29702;&#22120;&#36830;&#32493;&#22320;&#25191;&#34892;&#65292;&#36935;&#21040;&#26029;&#28857;&#20572;&#19979;</span>
......
(0) [0x000000007c00] 0000:7c00 (unk. ctxt): jmp .+26  (0x00007c1c)    ; eb1a
...
</pre>
</div>
</div>
</div>
<div id="outline-container-h:86898f73-79ec-4bc9-86f2-879c0d7cf3a7" class="outline-3">
<h3 id="h:86898f73-79ec-4bc9-86f2-879c0d7cf3a7">基址变址寻址</h3>
<div class="outline-text-3" id="text-h:86898f73-79ec-4bc9-86f2-879c0d7cf3a7">
<p>
有时候为了更灵活地访问数据需要将基址寄存器和变址寄存器结合起来，这样就成了基址变址寻址方式。
</p>

<p>
在使用基址变址寻址方式时，操作数的有效地址可以使用BX和SI相加等到、BX+DI、BX+SI+偏移量、BX+DI+偏移量
</p>

<pre class="example" id="org91ce540">
[bx+si]
[bx+di]
[bx+si+偏移量]
[bx+di+偏移量]

如：
mov ax, [bx+si+0x03]
</pre>

<p>
基址寄存器也可以是BP，默认使用栈段寄存器SS
</p>

<pre class="example" id="org2d738fa">
[bp+si]
[bp+di]
[bp+si+偏移量]
[bp+di+偏移量]

如：
mov ax, [bp+si+0x03]
</pre>


<p>
范例：主引导扇区程序
exam.asm
</p>
<div class="org-src-container">
<pre class="src src-asm">        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23601;&#22320;&#21453;&#36716;&#23383;&#31526;&#20018;&#30340;&#20869;&#23481;--&#37319;&#29992;&#22522;&#22336;&#21464;&#22336;&#23547;&#22336;&#26041;&#24335;</span>
        <span style="color: #a020f0;">jmp</span> start

<span style="color: #0000ff;">string</span>  <span style="color: #a020f0;">db</span> 'abcdefghijklmnopqrstuvwxyz'

<span style="color: #0000ff;">start</span>:
        <span style="color: #a020f0;">mov</span> ax,0x7c0        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#25968;&#25454;&#27573;&#30340;&#27573;&#22522;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> ds,ax

        <span style="color: #a020f0;">mov</span> bx,string       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#25968;&#25454;&#21306;&#39318;&#22320;&#22336;</span>
        <span style="color: #a020f0;">mov</span> si,0            <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27491;&#21521;&#32034;&#24341;</span>
        <span style="color: #a020f0;">mov</span> di,start-string <span style="color: #b22222;">;</span><span style="color: #b22222;">&#21453;&#21521;&#32034;&#24341;</span>

<span style="color: #0000ff;">rever</span>:
        <span style="color: #a020f0;">mov</span> ah,[bx+si]
        <span style="color: #a020f0;">mov</span> al,[bx+di]
        <span style="color: #a020f0;">mov</span> [bx+si],al
        <span style="color: #a020f0;">mov</span> [bx+di],ah
        <span style="color: #a020f0;">inc</span> si              <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20197;&#19978;4&#34892;&#29992;&#20110;&#20132;&#25442;&#39318;&#23614;&#25968;&#25454;</span>
        <span style="color: #a020f0;">dec</span> di
        <span style="color: #a020f0;">cmp</span> si,di
        <span style="color: #a020f0;">jl</span> rever            <span style="color: #b22222;">;</span><span style="color: #b22222;">&#39318;&#23614;&#27809;&#26377;&#30456;&#36935;&#65292;&#25110;&#32773;&#27809;&#26377;&#36229;&#36234;&#65292;&#32487;&#32493;&#20132;&#25442;</span>

        <span style="color: #a020f0;">jmp</span> $

        <span style="color: #a020f0;">times</span> 510-($-$$) db 0
        <span style="color: #a020f0;">db</span> 0x55,0xaa
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:1e600d07-cfd8-4e68-b3e5-8819cbfbb58e" class="outline-2">
<h2 id="h:1e600d07-cfd8-4e68-b3e5-8819cbfbb58e">硬盘和显卡的访问与控制</h2>
<div class="outline-text-2" id="text-h:1e600d07-cfd8-4e68-b3e5-8819cbfbb58e">
<p>
主要内容
</p>

<ul class="org-ul">
<li>离开主引导扇区</li>
<li>给汇编语言程序分段</li>
<li>控制段内元素的汇编地址</li>
<li>加载器和用户程序头部段</li>
<li>加载器的工作流程和常数声明</li>
<li>确定用户程序的加载位置</li>
<li>外围设备及其接口</li>
<li>输入输出端口的访问</li>
<li>通过硬盘控制器端口读扇区数据</li>
<li>过程和过程调用</li>
<li>过程调用和返回的原理</li>
<li>加载整个用户程序</li>
<li>用户程序的重定位</li>
<li>比特位的移动指令</li>
<li>转到用户程序内部执行</li>
<li>8086的无条件转移指令</li>
<li>用户程序的执行过程</li>
<li>验证加载器加载和执行用户程序的过程</li>
<li>用户程序概述</li>
<li>与文本显示有关的回车、换行与光标控制</li>
<li>回车的光标处理和乘法指令MUL</li>
<li>换行和普通字符的处理过程与滚屏操作</li>
<li>8086的过程调用方式</li>
<li>通过RETF指令转到另一个代码段内执行</li>
<li>在程序中访问不同的数据段</li>
<li>使用新版FixVhdWr写虚拟硬盘并运行程序</li>
<li>练习</li>
</ul>
</div>
<div id="outline-container-h:c9b3893c-4382-4669-a773-1aa2c0721470" class="outline-3">
<h3 id="h:c9b3893c-4382-4669-a773-1aa2c0721470">离开主引导扇区</h3>
<div class="outline-text-3" id="text-h:c9b3893c-4382-4669-a773-1aa2c0721470">
<p>
在硬盘上，0面0道1扇区是主引导扇区，主引导扇区是处理器迈向广阔天地的第一块跳板。离开主引导扇区后，
前方就是操作系统的森林，即windows,unix, linux。操作系统可以看成是一个程序，只是非常复杂庞大，包含了
更多的指令。
</p>

<p>
和主引导扇区程序一样，操作系统也是位置于硬盘上。操作系统需要安装到硬盘上的，这个安装过程不但要把
操作系统的指令和数据写入硬盘，通常还要更新主引导扇区的内容，好让这个跳板把操作系统运行起来。
</p>

<p>
操作系统通常肩负着处理器、内存和显卡声卡等外围设备的控制管理任务，也负责各种应用程序的加载和调度
工作。应用程序千千万万，像办公软件、游戏娱乐软件他们也需要安装在硬盘上。应用程序需要操作系统负责
管理，它们的加载和运行都是由操作系统负责的。
</p>

<p>
凭个人之力写一个非常完善的操作系统，这几乎是不可能的事。但是写一个小程序模拟一下它的哪个功能，这
是可以的。编译好的程序通常存放在像硬盘这样的载体上，需要加载到内存之后才能执行。这个过程并不简单。
</p>
<ul class="org-ul">
<li>首先需要读取硬盘，决定把它加载到内存的什么位置。最重要的是，程序通常是分段的，载入内存之后还要
重新计算段地址。这个过程叫做段的重定位。</li>
</ul>


<p>
下一步的目标
</p>
<ul class="org-ul">
<li>模拟操作系统加载应用程序的过程，演示段的重定位方法，最终彻底理解8086处理器的分段管理机制；</li>
<li>学习x86处理器过程调用的程序执行机制；</li>
<li>以读硬盘扇区和控制屏幕光标为实例，了解x86处理器访问外围硬件的方法；</li>
<li>总结JMP和CALL指令的全部格式；</li>
<li>认识更多的x86处理器指令</li>
</ul>
</div>
</div>
<div id="outline-container-h:a0f70f9a-8108-45bf-af73-0080367a0c18" class="outline-3">
<h3 id="h:a0f70f9a-8108-45bf-af73-0080367a0c18">给汇编语言程序分段</h3>
<div class="outline-text-3" id="text-h:a0f70f9a-8108-45bf-af73-0080367a0c18">
<blockquote>
<p>
如何编写具有多个段的汇编语言程序
</p>
</blockquote>

<p>
8086处理器已经是我们很熟悉的朋友了，我们了解它的秉性，它可以访问1MB字节的内存，地址范围从
00000一直到FFFFF。但是它没有能力将这1MB字节看成一个连续的空间，而只能最多将它划分为16个片段来
访问。因为他们必须采用段地址加偏移地址的方式来访问内存。段地址用段寄存器来提供，但是这些段寄存
器都是16位的。
</p>

<p>
段与段之间也是不同的
</p>
<ul class="org-ul">
<li>CS代码段寄存地址：保存代码段的段地址。</li>
<li>DS数据段寄存器：用来保存数据段的段地址</li>
<li>ES附加段寄存器：用来保存数据段的段地址</li>
<li>SS：用来保存栈段的段地址</li>
</ul>



<figure id="org84946a1">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241217_205442.png" alt="img_20241217_205442.png" width="90%">

</figure>

<p>
因为处理器的工作模式是将内存分成段，代码段、数据段和栈段，相对应的一个规范的汇编语言程序也应该包括
代码段、数据段、附加段和栈段。这样一来，段的划分和段与段之间的界线在程序加载到内存之前就已经准备好了。
</p>


<p>
在实际编程时，代码可能很长超过了64KB，数据也可能很多超过64KB。因为一个段最多64千字节，在这种情况下，
必须分成多个段来容纳。
</p>

<p>
范例： nasm编译器，划分段
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">SECTION</span> <span style="color: #a020f0;">data1</span>
<span style="color: #0000ff;">mydata</span>  <span style="color: #a020f0;">dw</span> 0xFACE

<span style="color: #0000ff;">SECTION</span> <span style="color: #a020f0;">data2</span>
<span style="color: #0000ff;">string</span>  <span style="color: #a020f0;">db</span> 'hello'

<span style="color: #0000ff;">section</span> <span style="color: #a020f0;">code</span>
        <span style="color: #a020f0;">mov</span> bx,string
        <span style="color: #a020f0;">mov</span> si,string
</pre>
</div>

<p>
Nasm编译器使用SECTION或者SEGMENT来定义段，段名只要不重复就可以了。一旦定义了段，后面的内容则都属于这个段。
如果程序中没有段定义语句，那么整个程序自成一个段。Nasm编译器对段的数量没有限制。
</p>

<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm  exam.asm -f bin -o exam.bin -l exam.lst

$ hexdump.exe -C exam.bin
00000000  ce fa 00 00 68 65 6c 6c  6f 00 00 00 bb 04 00 be  |....hello.......|
00000010  04 00                                             |..|
00000012

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#25105;&#30340;&#26426;&#22120;&#19978;&#65292;&#27573;&#30340;&#38271;&#24230;&#24517;&#39035;&#26159;4&#30340;&#20493;&#25968;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ce fa 00 00 #data1&#27573;&#20869;&#23481;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">68 65 6c 6c  6f 00 00 00#data2&#27573;&#20869;&#23481;, hello&#26159;5&#23383;&#33410;&#19981;&#33021;&#34987;4&#25972;&#38500;&#65292;&#38656;&#35201;&#34987;3&#20010;&#23383;&#33410;&#29992;0&#22635;&#20805;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">bb 04 00 be 04 00 #bb 04 00 &#26159;mov bx,string &#25351;&#20196;&#65307;be 04 00 &#26159;mov si,string&#25351;&#20196;</span>
</pre>
</div>


<p>
对于8086处理器来说，要求段的物理地址必须是16的倍数。按16字节对齐。可以在段定义中使用
ALINE=n子句
</p>

<p>
范例： nasm编译器，划分段
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">SECTION</span> <span style="color: #a020f0;">data1</span>    ALIGN=16
<span style="color: #0000ff;">mydata</span>  <span style="color: #a020f0;">dw</span> 0xFACE

<span style="color: #0000ff;">SECTION</span> <span style="color: #a020f0;">data2</span>    ALIGN=16
<span style="color: #0000ff;">string</span>  <span style="color: #a020f0;">db</span> 'hello'

<span style="color: #0000ff;">section</span> <span style="color: #a020f0;">code</span>     ALIGN=16
        <span style="color: #a020f0;">mov</span> bx,string
        <span style="color: #a020f0;">mov</span> si,string
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm  exam.asm -f bin -o exam.bin -l exam.lst

$ hexdump.exe -C exam.bin
00000000  ce fa 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  68 65 6c 6c 6f 00 00 00  00 00 00 00 00 00 00 00  |hello...........|
00000020  bb 10 00 be 10 00                                 |......|
00000026

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#20102;16&#23383;&#33410;&#23545;&#40784;&#65292;&#20013;&#38388;&#24517;&#39035;&#29992;0&#26469;&#22635;&#20805;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7b05f349-7e71-48c8-91d8-7c67f2e2fcfc" class="outline-3">
<h3 id="h:7b05f349-7e71-48c8-91d8-7c67f2e2fcfc">控制段内元素的汇编地址</h3>
<div class="outline-text-3" id="text-h:7b05f349-7e71-48c8-91d8-7c67f2e2fcfc">
<p>
如果没有特别的指令程序中所有指令他们的汇编地址都是相对于程序开头的。
</p>

<p>
按道理来说，段内元素的汇编地址都是相对于当前段的，再不应该是相对于程序开头处。
</p>

<p>
在定义段时，还可以包含一个VSTART子句
</p>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">SECTION</span> <span style="color: #a020f0;">data1</span>    ALIGN=16   VSTART=0
<span style="color: #0000ff;">mydata</span>  <span style="color: #a020f0;">dw</span> 0xFACE

<span style="color: #0000ff;">SECTION</span> <span style="color: #a020f0;">data2</span>    ALIGN=16   VSTART=0
<span style="color: #0000ff;">string</span>  <span style="color: #a020f0;">db</span> 'hello'

<span style="color: #0000ff;">section</span> <span style="color: #a020f0;">code</span>     ALIGN=16   VSTART=0
        <span style="color: #a020f0;">mov</span> bx,string
        <span style="color: #a020f0;">mov</span> si,string
</pre>
</div>

<p>
VSTART=0是虚拟的汇编地址，在这个段内所有元素的汇编地址都从这个指定的数值开始计算。
</p>

<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm exam.asm -f bin -o exam.bin -l exam.lst

$ hexdump.exe -C exam.bin
00000000  ce fa 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  68 65 6c 6c 6f 00 00 00  00 00 00 00 00 00 00 00  |hello...........|
00000020  bb 00 00 be 00 00                                 |......|
</pre>
</div>
<p>
可以看到 mov si,string 的机器码为be 00 00，string是从0开始计算的。
</p>

<p>
练习：
</p>
<div class="org-src-container">
<pre class="src src-asm"><span style="color: #0000ff;">section</span> <span style="color: #a020f0;">s1</span>
<span style="color: #0000ff;">offset</span>  <span style="color: #a020f0;">dw</span> str1,str2,num

<span style="color: #0000ff;">section</span> <span style="color: #a020f0;">s2</span>    align=16   vstart=0x100
<span style="color: #0000ff;">str1</span>    <span style="color: #a020f0;">db</span> 'hello'
<span style="color: #0000ff;">str2</span>    <span style="color: #a020f0;">db</span> 'world'

<span style="color: #0000ff;">section</span> <span style="color: #a020f0;">s3</span>    align=16
<span style="color: #0000ff;">num</span>     <span style="color: #a020f0;">dw</span>  0xbad
</pre>
</div>

<p>
在标号offset处定义了3个字，请定出他们具体数值
</p>
<pre class="example" id="org1d3b4ca">
str1 0x100
str2 0x105
num  20
</pre>
</div>
</div>
<div id="outline-container-h:929f4bba-4a3c-4bf2-8312-77a92a6be4ad" class="outline-3">
<h3 id="h:929f4bba-4a3c-4bf2-8312-77a92a6be4ad">加载器和用户程序头部段</h3>
<div class="outline-text-3" id="text-h:929f4bba-4a3c-4bf2-8312-77a92a6be4ad">
<p>
如果计算机配备了硬盘，那么主引导扇区是必须要执行的，但是主引导扇区太小了只有512个字节，容纳不了多少指令。
因此，主引导扇区通常只用来做为一个跳板，加载和引导操作系统。操作系统就不说了就是我们自己。
</p>

<p>
如果我们的程序很大主引导扇区放不下，该怎么办呢？很简单，硬盘很大，我们可以把程序放到硬盘的其他扇区里，我们
称之为用户程序。然后把主引导扇区改造为一个程序加载器或者说是一个加载程序，它的作用是加载用户程序并执行。
</p>


<figure id="org4cc26a2">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/assembly/images/img_20241219_200402.png" alt="img_20241219_200402.png" width="90%">

</figure>


<p>
一般来说加载器和用户程序是在不同的地方由不同的人或者公司来开发的。加载器和用户程序彼此之间都是墨盒的，并不
知道对方是做什么的。加载器需要一些必要的信息来知道如何加载用户程序。所以在用户程序头部。这是双方都知道的
协议部分。
</p>

<p>
范例：用户程序  userapp.asm
</p>
<div class="org-src-container">
<pre class="src src-asm">            <span style="color: #b22222;">;</span><span style="color: #b22222;">&#21253;&#21547;&#20195;&#30721;&#27573;&#12289;&#25968;&#25454;&#27573;&#21644;&#26632;&#27573;&#30340;&#29992;&#25143;&#31243;&#24207;</span>
<span style="color: #b22222;">;</span><span style="color: #b22222;">===============================================================================</span>
<span style="color: #0000ff;">SECTION</span> <span style="color: #a020f0;">header</span> vstart=0                                         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#29992;&#25143;&#31243;&#24207;&#22836;&#37096;&#27573;</span>
    <span style="color: #a020f0;">program_length</span>  dd  program_end                             <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31243;&#24207;&#24635;&#38271;&#24230;[0x00]</span>

    <span style="color: #b22222;">;</span><span style="color: #b22222;">&#29992;&#25143;&#31243;&#24207;&#20837;&#21475;&#28857;</span>
    <span style="color: #a020f0;">code_entry</span>      dw  start                                   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20559;&#31227;&#22320;&#22336;[0x04]</span>
                    <span style="color: #a020f0;">dd</span>  section.code.start                      <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27573;&#22320;&#22336;[0x06]</span>

    <span style="color: #a020f0;">realloc_tbl_len</span> dw  (segtbl_end-segtbl_begin)/4             <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27573;&#37325;&#23450;&#20301;&#34920;&#39033;&#20010;&#25968;[0x0A]</span>

    <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27573;&#37325;&#23450;&#20301;&#34920;</span>
    <span style="color: #a020f0;">segtbl_begin</span>:
    <span style="color: #a020f0;">code_segment</span>    dd  section.code.start                      <span style="color: #b22222;">;</span><span style="color: #b22222;">[0x0C]</span>
    <span style="color: #a020f0;">data_segment</span>    dd  section.data.start                      <span style="color: #b22222;">;</span><span style="color: #b22222;">[0x10]</span>
    <span style="color: #a020f0;">stack_segment</span>   dd  section.stack.start                     <span style="color: #b22222;">;</span><span style="color: #b22222;">[0x14]</span>
    <span style="color: #a020f0;">segtbl_end</span>:

<span style="color: #b22222;">;</span><span style="color: #b22222;">===============================================================================</span>
<span style="color: #0000ff;">SECTION</span> <span style="color: #a020f0;">code</span> align=16 vstart=0                                  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20195;&#30721;&#27573;</span>
    <span style="color: #a020f0;">start</span>:
        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#21021;&#22987;&#25191;&#34892;&#26102;&#65292;DS&#21644;ES&#25351;&#21521;&#29992;&#25143;&#31243;&#24207;&#22836;&#37096;&#27573;</span>
        <span style="color: #a020f0;">mov</span> ax,[stack_segment]                                  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#21040;&#29992;&#25143;&#31243;&#24207;&#33258;&#24049;&#30340;&#22534;&#26632;</span>
        <span style="color: #a020f0;">mov</span> ss,ax
        <span style="color: #a020f0;">mov</span> sp,stack_pointer                                    <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#21021;&#22987;&#30340;&#26632;&#39030;&#25351;&#38024;</span>

        <span style="color: #a020f0;">mov</span> ax,[data_segment]                                   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#21040;&#29992;&#25143;&#31243;&#24207;&#33258;&#24049;&#30340;&#25968;&#25454;&#27573;</span>
        <span style="color: #a020f0;">mov</span> ds,ax

        <span style="color: #a020f0;">mov</span> ax,0xb800
        <span style="color: #a020f0;">mov</span> es,ax

        <span style="color: #a020f0;">mov</span> si,message
        <span style="color: #a020f0;">mov</span> di,0

    <span style="color: #a020f0;">next</span>:
        <span style="color: #a020f0;">mov</span> al,[si]
        <span style="color: #a020f0;">cmp</span> al,0
        <span style="color: #a020f0;">je</span> exit
        <span style="color: #a020f0;">mov</span> byte [es:di],al
        <span style="color: #a020f0;">mov</span> byte [es:di+1],0x07
        <span style="color: #a020f0;">inc</span> si
        <span style="color: #a020f0;">add</span> di,2
        <span style="color: #a020f0;">jmp</span> next

    <span style="color: #a020f0;">exit</span>:
        <span style="color: #a020f0;">jmp</span> $

<span style="color: #b22222;">;</span><span style="color: #b22222;">===============================================================================</span>
<span style="color: #0000ff;">SECTION</span> <span style="color: #a020f0;">data</span> align=16 vstart=0                                  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#25968;&#25454;&#27573;</span>
    <span style="color: #a020f0;">message</span>         db  'hello world.',0

<span style="color: #b22222;">;</span><span style="color: #b22222;">===============================================================================</span>
<span style="color: #0000ff;">SECTION</span> <span style="color: #a020f0;">stack</span> align=16 vstart=0                                 <span style="color: #b22222;">;</span><span style="color: #b22222;">&#26632;&#27573;</span>
                    <span style="color: #a020f0;">resb</span> 256
    <span style="color: #a020f0;">stack_pointer</span>:

<span style="color: #b22222;">;</span><span style="color: #b22222;">===============================================================================</span>
<span style="color: #0000ff;">SECTION</span> <span style="color: #a020f0;">trail</span> align=16                                          <span style="color: #b22222;">;</span><span style="color: #b22222;">&#23614;&#37096;</span>
<span style="color: #0000ff;">program_end</span>:
</pre>
</div>

<p>
这个程序有5个段header, code, data,stack,trail
</p>

<p>
用户程序头部起码要包含以下信息
</p>
<ul class="org-ul">
<li>程序的总长度</li>
<li>入口点</li>
<li>段重定位表项数</li>
<li>段重定位表</li>
</ul>


<pre class="example" id="org71281b8">
    program_length  dd  program_end                             ;程序总长度[0x00]

    ;用户程序入口点
    code_entry      dw  start                                   ;偏移地址[0x04]
                    dd  section.code.start                      ;段地址[0x06]

    realloc_tbl_len dw  (segtbl_end-segtbl_begin)/4             ;段重定位表项个数[0x0A]

    ;段重定位表
    segtbl_begin:
    code_segment    dd  section.code.start                      ;[0x0C]
    data_segment    dd  section.data.start                      ;[0x10]
    stack_segment   dd  section.stack.start                     ;[0x14]
    segtbl_end:

- 程序的总长度
    program_length  dd  program_end                             ;程序总长度[0x00]

    程序的总长度用标号来定位就是可以的。标号program_end在数值上等于整个程序的长度

- 入口点
入口点包含段地址和段内偏移地址。
    code_entry      dw  start                                   ;偏移地址[0x04]
                    dd  section.code.start                      ;段地址[0x06]
   偏移地址是用标号start所代表的汇编地址来填写
   段地址是用表达式section.code.start得到的。


- 段重定位表
    segtbl_begin:
    code_segment    dd  section.code.start                      ;[0x0C]
    data_segment    dd  section.data.start                      ;[0x10]
    stack_segment   dd  section.stack.start                     ;[0x14]
    segtbl_end:

段重定位表以标号segtb1_begin开始以标号segtb1_end结束，标号之间是表项，
每个表项用来记录一个段的汇编地址。

- 段重定位表项数
    realloc_tbl_len dw  (segtbl_end-segtbl_begin)/4             ;段重定位表项个数[0x0A]

用户定义的段在数量上是不确定的。因此必须在用户程序头部定义段重定位表项数。
segtbl_end-segtbl_begin是那块区域的总长度，区域内每个段重定位表项用dd 4个字节来记录，所以除以4就是表项数
</pre>

<p>
nasm计算段的汇编地址的表达式
</p>
<pre class="example" id="org02824d1">
section.段名字.start
两边是固定写法，用来计算这个段相对于整个程序开头的汇编地址，实际上是相对程序开头处的偏移量。
也可以理解成这个段距离整个程序开头的字节数。
</pre>


<p>
编译
</p>
<div class="org-src-container">
<pre class="src src-sh">D:\project\assemblyprojs&gt;nasm userapp.asm -f bin -o userapp.bin -l userapp.lst
userapp.asm:55: warning: uninitialized space declared<span style="color: #a020f0;"> in</span> stack section: zeroing [-w+zeroing]

&#24573;&#30053;&#35686;&#21578;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:75324a06-3d93-47ee-9dbf-52326f7343f6" class="outline-3">
<h3 id="h:75324a06-3d93-47ee-9dbf-52326f7343f6">加载器的工作流程和常数声明</h3>
<div class="outline-text-3" id="text-h:75324a06-3d93-47ee-9dbf-52326f7343f6">
<ul class="org-ul">
<li>读取用户程序的起始扇区</li>
<li>把整个用户程序都读入内存</li>
<li>计算段的物理地址和逻辑地址（段的重定位）</li>
<li>转移到用户程序执行（将处理器的控制权交给用户程序）</li>
</ul>


<pre class="example" id="org6b5fef0">
- 读取用户程序的起始扇区
这个扇区包含了用户的头部段内容。

- 把整个用户程序都读入内存
读取完后需要取出并检查用户程序的大小，并知道还需要读取多少扇区。
把整个用户程序都读到内存中，具体内存位置可以自由选择。

- 计算段的物理地址和逻辑段地址（段的重定位）
加载器还要根据段的汇编地址来计算段的实际物理内存地址，并将物理地址转换成
段的逻辑段地址。这样，用户程序就可以将逻辑段地址加载到DS，ES，SS并访问这些段

- 转移到用户程序执行（将处理器的控制权交给用户程序）
</pre>

<p>
规定用户程序从硬盘逻辑扇区号100开始
</p>

<p>
常数声明，用equ来声明，不占空间。方便来统一修改程序，防止漏掉。
</p>

<p>
范例：用户加载器 mbr.asm
</p>
<div class="org-src-container">
<pre class="src src-asm">         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20195;&#30721;&#28165;&#21333;8-1</span>
         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#25991;&#20214;&#21517;&#65306;c08_mbr.asm</span>
         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#25991;&#20214;&#35828;&#26126;&#65306;&#30828;&#30424;&#20027;&#24341;&#23548;&#25159;&#21306;&#20195;&#30721;&#65288;&#21152;&#36733;&#31243;&#24207;&#65289;</span>

         <span style="color: #a020f0;">app_lba_start</span> equ 100           <span style="color: #b22222;">;</span><span style="color: #b22222;">&#22768;&#26126;&#24120;&#25968;&#65288;&#29992;&#25143;&#31243;&#24207;&#36215;&#22987;&#36923;&#36753;&#25159;&#21306;&#21495;&#65289;</span>
                                         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24120;&#25968;&#30340;&#22768;&#26126;&#19981;&#20250;&#21344;&#29992;&#27719;&#32534;&#22320;&#22336;</span>

<span style="color: #0000ff;">SECTION</span> <span style="color: #a020f0;">mbr</span> align=16 vstart=0x7c00

         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35774;&#32622;&#22534;&#26632;&#27573;&#21644;&#26632;&#25351;&#38024;</span>
         <span style="color: #a020f0;">mov</span> ax,0
         <span style="color: #a020f0;">mov</span> ss,ax
         <span style="color: #a020f0;">mov</span> sp,ax

         <span style="color: #a020f0;">mov</span> ax,[cs:phy_base]            <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35745;&#31639;&#29992;&#20110;&#21152;&#36733;&#29992;&#25143;&#31243;&#24207;&#30340;&#36923;&#36753;&#27573;&#22320;&#22336;</span>
         <span style="color: #a020f0;">mov</span> dx,[cs:phy_base+0x02]
         <span style="color: #a020f0;">mov</span> bx,16
         <span style="color: #a020f0;">div</span> bx
         <span style="color: #a020f0;">mov</span> ds,ax                       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20196;DS&#21644;ES&#25351;&#21521;&#35813;&#27573;&#20197;&#36827;&#34892;&#25805;&#20316;</span>
         <span style="color: #a020f0;">mov</span> es,ax

         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20197;&#19979;&#35835;&#21462;&#31243;&#24207;&#30340;&#36215;&#22987;&#37096;&#20998;</span>
         <span style="color: #a020f0;">xor</span> di,di
         <span style="color: #a020f0;">mov</span> si,app_lba_start            <span style="color: #b22222;">;</span><span style="color: #b22222;">&#31243;&#24207;&#22312;&#30828;&#30424;&#19978;&#30340;&#36215;&#22987;&#36923;&#36753;&#25159;&#21306;&#21495;</span>
         <span style="color: #a020f0;">xor</span> bx,bx                       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#21152;&#36733;&#21040;DS:0x0000&#22788;</span>
         <span style="color: #a020f0;">call</span> read_hard_disk_0

         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20197;&#19979;&#21028;&#26029;&#25972;&#20010;&#31243;&#24207;&#26377;&#22810;&#22823;</span>
         <span style="color: #a020f0;">mov</span> dx,[2]                      <span style="color: #b22222;">;</span><span style="color: #b22222;">&#26366;&#32463;&#25226;dx&#20889;&#25104;&#20102;ds&#65292;&#33457;&#20102;&#20108;&#21313;&#20998;&#38047;&#25490;&#38169;</span>
         <span style="color: #a020f0;">mov</span> ax,[0]
         <span style="color: #a020f0;">mov</span> bx,512                      <span style="color: #b22222;">;</span><span style="color: #b22222;">512&#23383;&#33410;&#27599;&#25159;&#21306;</span>
         <span style="color: #a020f0;">div</span> bx
         <span style="color: #a020f0;">cmp</span> dx,0
         <span style="color: #a020f0;">jnz</span> @1                          <span style="color: #b22222;">;</span><span style="color: #b22222;">&#26410;&#38500;&#23613;&#65292;&#22240;&#27492;&#32467;&#26524;&#27604;&#23454;&#38469;&#25159;&#21306;&#25968;&#23569;1</span>
         <span style="color: #a020f0;">dec</span> ax                          <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24050;&#32463;&#35835;&#20102;&#19968;&#20010;&#25159;&#21306;&#65292;&#25159;&#21306;&#24635;&#25968;&#20943;1</span>
   @1:
         <span style="color: #a020f0;">cmp</span> ax,0                        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#32771;&#34385;&#23454;&#38469;&#38271;&#24230;&#23567;&#20110;&#31561;&#20110;512&#20010;&#23383;&#33410;&#30340;&#24773;&#20917;</span>
         <span style="color: #a020f0;">jz</span> direct

         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35835;&#21462;&#21097;&#20313;&#30340;&#25159;&#21306;</span>
         <span style="color: #a020f0;">push</span> ds                         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20197;&#19979;&#35201;&#29992;&#21040;&#24182;&#25913;&#21464;DS&#23492;&#23384;&#22120;</span>

         <span style="color: #a020f0;">mov</span> cx,ax                       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24490;&#29615;&#27425;&#25968;&#65288;&#21097;&#20313;&#25159;&#21306;&#25968;&#65289;</span>
   @2:
         <span style="color: #a020f0;">mov</span> ax,ds
         <span style="color: #a020f0;">add</span> ax,0x20                     <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24471;&#21040;&#19979;&#19968;&#20010;&#20197;512&#23383;&#33410;&#20026;&#36793;&#30028;&#30340;&#27573;&#22320;&#22336;</span>
         <span style="color: #a020f0;">mov</span> ds,ax

         <span style="color: #a020f0;">xor</span> bx,bx                       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#27599;&#27425;&#35835;&#26102;&#65292;&#20559;&#31227;&#22320;&#22336;&#22987;&#32456;&#20026;0x0000</span>
         <span style="color: #a020f0;">inc</span> si                          <span style="color: #b22222;">;</span><span style="color: #b22222;">&#19979;&#19968;&#20010;&#36923;&#36753;&#25159;&#21306;</span>
         <span style="color: #a020f0;">call</span> read_hard_disk_0
         <span style="color: #a020f0;">loop</span> @2                         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24490;&#29615;&#35835;&#65292;&#30452;&#21040;&#35835;&#23436;&#25972;&#20010;&#21151;&#33021;&#31243;&#24207;</span>

         <span style="color: #a020f0;">pop</span> ds                          <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24674;&#22797;&#25968;&#25454;&#27573;&#22522;&#22336;&#21040;&#29992;&#25143;&#31243;&#24207;&#22836;&#37096;&#27573;</span>

         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35745;&#31639;&#20837;&#21475;&#28857;&#20195;&#30721;&#27573;&#22522;&#22336;</span>
   <span style="color: #a020f0;">direct</span>:
         <span style="color: #a020f0;">mov</span> dx,[0x08]
         <span style="color: #a020f0;">mov</span> ax,[0x06]
         <span style="color: #a020f0;">call</span> calc_segment_base
         <span style="color: #a020f0;">mov</span> [0x06],ax                   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#22238;&#22635;&#20462;&#27491;&#21518;&#30340;&#20837;&#21475;&#28857;&#20195;&#30721;&#27573;&#22522;&#22336;</span>

         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24320;&#22987;&#22788;&#29702;&#27573;&#37325;&#23450;&#20301;&#34920;</span>
         <span style="color: #a020f0;">mov</span> cx,[0x0a]                   <span style="color: #b22222;">;</span><span style="color: #b22222;">&#38656;&#35201;&#37325;&#23450;&#20301;&#30340;&#39033;&#30446;&#25968;&#37327;</span>
         <span style="color: #a020f0;">mov</span> bx,0x0c                     <span style="color: #b22222;">;</span><span style="color: #b22222;">&#37325;&#23450;&#20301;&#34920;&#39318;&#22320;&#22336;</span>

 <span style="color: #a020f0;">realloc</span>:
         <span style="color: #a020f0;">mov</span> dx,[bx+0x02]                <span style="color: #b22222;">;</span><span style="color: #b22222;">32&#20301;&#22320;&#22336;&#30340;&#39640;16&#20301;</span>
         <span style="color: #a020f0;">mov</span> ax,[bx]
         <span style="color: #a020f0;">call</span> calc_segment_base
         <span style="color: #a020f0;">mov</span> [bx],ax                     <span style="color: #b22222;">;</span><span style="color: #b22222;">&#22238;&#22635;&#27573;&#30340;&#22522;&#22336;</span>
         <span style="color: #a020f0;">add</span> bx,4                        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#19979;&#19968;&#20010;&#37325;&#23450;&#20301;&#39033;&#65288;&#27599;&#39033;&#21344;4&#20010;&#23383;&#33410;&#65289;</span>
         <span style="color: #a020f0;">loop</span> realloc

         <span style="color: #a020f0;">jmp</span> far [0x04]                  <span style="color: #b22222;">;</span><span style="color: #b22222;">&#36716;&#31227;&#21040;&#29992;&#25143;&#31243;&#24207;</span>

<span style="color: #b22222;">;</span><span style="color: #b22222;">-------------------------------------------------------------------------------</span>
<span style="color: #0000ff;">read_hard_disk_0</span>:                        <span style="color: #b22222;">;</span><span style="color: #b22222;">&#20174;&#30828;&#30424;&#35835;&#21462;&#19968;&#20010;&#36923;&#36753;&#25159;&#21306;</span>
                                         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#36755;&#20837;&#65306;DI:SI=&#36215;&#22987;&#36923;&#36753;&#25159;&#21306;&#21495;</span>
                                         <span style="color: #b22222;">;      </span><span style="color: #b22222;">DS:BX=&#30446;&#26631;&#32531;&#20914;&#21306;&#22320;&#22336;</span>
         <span style="color: #a020f0;">push</span> ax
         <span style="color: #a020f0;">push</span> bx
         <span style="color: #a020f0;">push</span> cx
         <span style="color: #a020f0;">push</span> dx

         <span style="color: #a020f0;">mov</span> dx,0x1f2
         <span style="color: #a020f0;">mov</span> al,1
         <span style="color: #a020f0;">out</span> dx,al                       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35835;&#21462;&#30340;&#25159;&#21306;&#25968;</span>

         <span style="color: #a020f0;">inc</span> dx                          <span style="color: #b22222;">;</span><span style="color: #b22222;">0x1f3</span>
         <span style="color: #a020f0;">mov</span> ax,si
         <span style="color: #a020f0;">out</span> dx,al                       <span style="color: #b22222;">;</span><span style="color: #b22222;">LBA&#22320;&#22336;7~0</span>

         <span style="color: #a020f0;">inc</span> dx                          <span style="color: #b22222;">;</span><span style="color: #b22222;">0x1f4</span>
         <span style="color: #a020f0;">mov</span> al,ah
         <span style="color: #a020f0;">out</span> dx,al                       <span style="color: #b22222;">;</span><span style="color: #b22222;">LBA&#22320;&#22336;15~8</span>

         <span style="color: #a020f0;">inc</span> dx                          <span style="color: #b22222;">;</span><span style="color: #b22222;">0x1f5</span>
         <span style="color: #a020f0;">mov</span> ax,di
         <span style="color: #a020f0;">out</span> dx,al                       <span style="color: #b22222;">;</span><span style="color: #b22222;">LBA&#22320;&#22336;23~16</span>

         <span style="color: #a020f0;">inc</span> dx                          <span style="color: #b22222;">;</span><span style="color: #b22222;">0x1f6</span>
         <span style="color: #a020f0;">mov</span> al,0xe0                     <span style="color: #b22222;">;</span><span style="color: #b22222;">LBA28&#27169;&#24335;&#65292;&#20027;&#30424;</span>
         <span style="color: #a020f0;">or</span> al,ah                        <span style="color: #b22222;">;</span><span style="color: #b22222;">LBA&#22320;&#22336;27~24</span>
         <span style="color: #a020f0;">out</span> dx,al

         <span style="color: #a020f0;">inc</span> dx                          <span style="color: #b22222;">;</span><span style="color: #b22222;">0x1f7</span>
         <span style="color: #a020f0;">mov</span> al,0x20                     <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35835;&#21629;&#20196;</span>
         <span style="color: #a020f0;">out</span> dx,al

  <span style="color: #a020f0;">.waits</span>:
         <span style="color: #a020f0;">in</span> al,dx
         <span style="color: #a020f0;">and</span> al,0x88
         <span style="color: #a020f0;">cmp</span> al,0x08
         <span style="color: #a020f0;">jnz</span> .waits                      <span style="color: #b22222;">;</span><span style="color: #b22222;">&#19981;&#24537;&#65292;&#19988;&#30828;&#30424;&#24050;&#20934;&#22791;&#22909;&#25968;&#25454;&#20256;&#36755;</span>

         <span style="color: #a020f0;">mov</span> cx,256                      <span style="color: #b22222;">;</span><span style="color: #b22222;">&#24635;&#20849;&#35201;&#35835;&#21462;&#30340;&#23383;&#25968;</span>
         <span style="color: #a020f0;">mov</span> dx,0x1f0
  <span style="color: #a020f0;">.readw</span>:
         <span style="color: #a020f0;">in</span> ax,dx
         <span style="color: #a020f0;">mov</span> [bx],ax
         <span style="color: #a020f0;">add</span> bx,2
         <span style="color: #a020f0;">loop</span> .readw

         <span style="color: #a020f0;">pop</span> dx
         <span style="color: #a020f0;">pop</span> cx
         <span style="color: #a020f0;">pop</span> bx
         <span style="color: #a020f0;">pop</span> ax

         <span style="color: #a020f0;">ret</span>

<span style="color: #b22222;">;</span><span style="color: #b22222;">-------------------------------------------------------------------------------</span>
<span style="color: #0000ff;">calc_segment_base</span>:                       <span style="color: #b22222;">;</span><span style="color: #b22222;">&#35745;&#31639;16&#20301;&#27573;&#22320;&#22336;</span>
                                         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#36755;&#20837;&#65306;DX:AX=32&#20301;&#29289;&#29702;&#22320;&#22336;</span>
                                         <span style="color: #b22222;">;</span><span style="color: #b22222;">&#36820;&#22238;&#65306;AX=16&#20301;&#27573;&#22522;&#22320;&#22336;</span>
         <span style="color: #a020f0;">push</span> dx

         <span style="color: #a020f0;">add</span> ax,[cs:phy_base]
         <span style="color: #a020f0;">adc</span> dx,[cs:phy_base+0x02]
         <span style="color: #a020f0;">shr</span> ax,4
         <span style="color: #a020f0;">ror</span> dx,4
         <span style="color: #a020f0;">and</span> dx,0xf000
         <span style="color: #a020f0;">or</span> ax,dx

         <span style="color: #a020f0;">pop</span> dx

         <span style="color: #a020f0;">ret</span>

<span style="color: #b22222;">;</span><span style="color: #b22222;">-------------------------------------------------------------------------------</span>
         <span style="color: #a020f0;">phy_base</span> dd 0x10000             <span style="color: #b22222;">;</span><span style="color: #b22222;">&#29992;&#25143;&#31243;&#24207;&#34987;&#21152;&#36733;&#30340;&#29289;&#29702;&#36215;&#22987;&#22320;&#22336;</span>

 <span style="color: #a020f0;">times</span> 510-($-$$) db 0
                  <span style="color: #a020f0;">db</span> 0x55,0xaa
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9c3ceb94-911b-4fac-94f4-8ad8046f88bd" class="outline-3">
<h3 id="h:9c3ceb94-911b-4fac-94f4-8ad8046f88bd">确定用户程序的加载位置</h3>
<div class="outline-text-3" id="text-h:9c3ceb94-911b-4fac-94f4-8ad8046f88bd">
</div>
</div>
<div id="outline-container-h:66a5bcd3-6572-43af-a604-b5e14d27b9a1" class="outline-3">
<h3 id="h:66a5bcd3-6572-43af-a604-b5e14d27b9a1">外围设备及其接口</h3>
<div class="outline-text-3" id="text-h:66a5bcd3-6572-43af-a604-b5e14d27b9a1">
</div>
</div>
<div id="outline-container-h:f8ae1ef2-da33-4d96-b5e9-e16aefcfb2b6" class="outline-3">
<h3 id="h:f8ae1ef2-da33-4d96-b5e9-e16aefcfb2b6">输入输出端口的访问</h3>
<div class="outline-text-3" id="text-h:f8ae1ef2-da33-4d96-b5e9-e16aefcfb2b6">
</div>
</div>
<div id="outline-container-h:e61d214f-77e1-44fb-af82-ab6cc8a04af9" class="outline-3">
<h3 id="h:e61d214f-77e1-44fb-af82-ab6cc8a04af9">通过硬盘控制器端口读扇区数据</h3>
<div class="outline-text-3" id="text-h:e61d214f-77e1-44fb-af82-ab6cc8a04af9">
</div>
</div>
<div id="outline-container-h:50f5914f-4868-4d61-a8d8-beeb3a524d90" class="outline-3">
<h3 id="h:50f5914f-4868-4d61-a8d8-beeb3a524d90">过程和过程调用</h3>
<div class="outline-text-3" id="text-h:50f5914f-4868-4d61-a8d8-beeb3a524d90">
</div>
</div>
<div id="outline-container-h:ce02b790-72dd-45df-a7f0-2619dcbcc6a1" class="outline-3">
<h3 id="h:ce02b790-72dd-45df-a7f0-2619dcbcc6a1">过程调用和返回的原理</h3>
<div class="outline-text-3" id="text-h:ce02b790-72dd-45df-a7f0-2619dcbcc6a1">
</div>
</div>
<div id="outline-container-h:714820dc-6be3-417c-ab89-c1dbde87bc51" class="outline-3">
<h3 id="h:714820dc-6be3-417c-ab89-c1dbde87bc51">加载整个用户程序</h3>
<div class="outline-text-3" id="text-h:714820dc-6be3-417c-ab89-c1dbde87bc51">
</div>
</div>
<div id="outline-container-h:e1356242-ba85-4965-b1d5-0e49a3f47b53" class="outline-3">
<h3 id="h:e1356242-ba85-4965-b1d5-0e49a3f47b53">用户程序的重定位</h3>
<div class="outline-text-3" id="text-h:e1356242-ba85-4965-b1d5-0e49a3f47b53">
</div>
</div>
<div id="outline-container-h:6fc2b5d4-897f-495c-94fe-17e54d85540d" class="outline-3">
<h3 id="h:6fc2b5d4-897f-495c-94fe-17e54d85540d">比特位的移动指令</h3>
<div class="outline-text-3" id="text-h:6fc2b5d4-897f-495c-94fe-17e54d85540d">
</div>
</div>
<div id="outline-container-h:62293c16-73e0-476f-82e4-5e6723e7a3f8" class="outline-3">
<h3 id="h:62293c16-73e0-476f-82e4-5e6723e7a3f8">转到用户程序内部执行</h3>
<div class="outline-text-3" id="text-h:62293c16-73e0-476f-82e4-5e6723e7a3f8">
</div>
</div>
<div id="outline-container-h:41d98d2a-64f6-46f6-ad57-76836c8c59e3" class="outline-3">
<h3 id="h:41d98d2a-64f6-46f6-ad57-76836c8c59e3">8086的无条件转移指令</h3>
<div class="outline-text-3" id="text-h:41d98d2a-64f6-46f6-ad57-76836c8c59e3">
</div>
</div>
<div id="outline-container-h:03e1f608-483d-496e-917f-a7585a35420d" class="outline-3">
<h3 id="h:03e1f608-483d-496e-917f-a7585a35420d">用户程序的执行过程</h3>
<div class="outline-text-3" id="text-h:03e1f608-483d-496e-917f-a7585a35420d">
</div>
</div>
<div id="outline-container-h:0873922b-9fd8-4912-b42b-12a680690e87" class="outline-3">
<h3 id="h:0873922b-9fd8-4912-b42b-12a680690e87">验证加载器加载和执行用户程序的过程</h3>
<div class="outline-text-3" id="text-h:0873922b-9fd8-4912-b42b-12a680690e87">
</div>
</div>
<div id="outline-container-h:ea04a109-689d-4623-9183-1ef95bf38e6b" class="outline-3">
<h3 id="h:ea04a109-689d-4623-9183-1ef95bf38e6b">用户程序概述</h3>
<div class="outline-text-3" id="text-h:ea04a109-689d-4623-9183-1ef95bf38e6b">
</div>
</div>
<div id="outline-container-h:f62a918b-e85c-4910-af53-e0e78bb2163b" class="outline-3">
<h3 id="h:f62a918b-e85c-4910-af53-e0e78bb2163b">与文本显示有关的回车、换行与光标控制</h3>
<div class="outline-text-3" id="text-h:f62a918b-e85c-4910-af53-e0e78bb2163b">
</div>
</div>
<div id="outline-container-h:ed51def0-6807-4895-ab28-59389494d0b2" class="outline-3">
<h3 id="h:ed51def0-6807-4895-ab28-59389494d0b2">回车的光标处理和乘法指令MUL</h3>
<div class="outline-text-3" id="text-h:ed51def0-6807-4895-ab28-59389494d0b2">
</div>
</div>
<div id="outline-container-h:4aabfb57-04c0-4c92-9bd9-db375741993d" class="outline-3">
<h3 id="h:4aabfb57-04c0-4c92-9bd9-db375741993d">换行和普通字符的处理过程与滚屏操作</h3>
<div class="outline-text-3" id="text-h:4aabfb57-04c0-4c92-9bd9-db375741993d">
</div>
</div>
<div id="outline-container-h:e2e635de-45d6-4bf8-9426-0c6aa226b7fc" class="outline-3">
<h3 id="h:e2e635de-45d6-4bf8-9426-0c6aa226b7fc">8086的过程调用方式</h3>
<div class="outline-text-3" id="text-h:e2e635de-45d6-4bf8-9426-0c6aa226b7fc">
</div>
</div>
<div id="outline-container-h:39a84fa8-2332-4c95-83d2-ecbf3d087aff" class="outline-3">
<h3 id="h:39a84fa8-2332-4c95-83d2-ecbf3d087aff">通过RETF指令转到另一个代码段内执行</h3>
<div class="outline-text-3" id="text-h:39a84fa8-2332-4c95-83d2-ecbf3d087aff">
</div>
</div>
<div id="outline-container-h:22670a8c-a1f2-4761-9509-e36a83575205" class="outline-3">
<h3 id="h:22670a8c-a1f2-4761-9509-e36a83575205">在程序中访问不同的数据段</h3>
<div class="outline-text-3" id="text-h:22670a8c-a1f2-4761-9509-e36a83575205">
</div>
</div>
<div id="outline-container-h:602a147f-eccb-4971-82da-bd5d9520eab8" class="outline-3">
<h3 id="h:602a147f-eccb-4971-82da-bd5d9520eab8">使用新版FixVhdWr写虚拟硬盘并运行程序</h3>
<div class="outline-text-3" id="text-h:602a147f-eccb-4971-82da-bd5d9520eab8">
</div>
</div>
<div id="outline-container-h:6fb5c9db-dbd5-46ca-a829-f11b5acece6f" class="outline-3">
<h3 id="h:6fb5c9db-dbd5-46ca-a829-f11b5acece6f">练习</h3>
<div class="outline-text-3" id="text-h:6fb5c9db-dbd5-46ca-a829-f11b5acece6f">
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
