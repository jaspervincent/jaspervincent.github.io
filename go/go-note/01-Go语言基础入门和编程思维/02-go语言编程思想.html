<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Go: Go语言编程思想</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Go: Go语言编程思想</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org28cdbf0">接口，接口的值类型</a>
<ul>
<li><a href="#orgc26dc11">接口的概念</a></li>
<li><a href="#orgc663292">duck typing的概念</a>
<ul>
<li><a href="#org3401d80">python中的duck typing</a></li>
<li><a href="#orgd3016da">c++中的duck typing</a></li>
<li><a href="#orgf31df0d">java中的类似duck typing的代码</a></li>
<li><a href="#org89e0233">go语言的duck typing</a></li>
</ul>
</li>
<li><a href="#org889c7c8">接口的定义</a>
<ul>
<li><a href="#org7937e51">使用者(download)和实现者(retriever)</a></li>
<li><a href="#orge99aeff">接口的定义</a></li>
<li><a href="#org0e03ec0">接口的实现</a></li>
</ul>
</li>
<li><a href="#org300e9d3">接口的值类型</a>
<ul>
<li>
<ul>
<li><a href="#org2470564">接口类型的判断</a></li>
</ul>
</li>
<li><a href="#org18954b2">接口变量里有什么？</a></li>
<li><a href="#orge953632">查看接口变量</a></li>
</ul>
</li>
<li><a href="#orga0113db">接口的组合</a></li>
<li><a href="#orgdb4e60f">常用系统的接口</a>
<ul>
<li><a href="#org5516557">fmt库Stringer接口</a></li>
<li><a href="#orgfc9b792">io库的Reader接口和Writer接口</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org0770c2e">函数式编程</a>
<ul>
<li><a href="#orgc977f1c">函数式编程</a>
<ul>
<li><a href="#orgf097b3d">函数式编程 vs 函数指针</a></li>
<li><a href="#org8a319a1">“正统”函数式编程</a></li>
<li><a href="#org8c01f41">闭包</a>
<ul>
<li><a href="#orgdfbe322">python中的闭包</a></li>
<li><a href="#org7cec3d8">c++ 中的闭包</a></li>
<li><a href="#org7bd414a">java 中的闭包</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgfcfc34b">go语言闭包的应用</a>
<ul>
<li><a href="#org0f60ab0">函数式编程范例1 斐波那契数列</a></li>
<li><a href="#org43d84c8">函数式编程范例2 为函数实现接口</a></li>
<li><a href="#orgf190947">函数式编程范例3 使用函数来遍历二叉树</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orge03ab6c">出错处理与defer/panic/recover</a>
<ul>
<li><a href="#org85d588a">defer调用</a>
<ul>
<li><a href="#orgcf6c972">何时使用defer调用</a></li>
</ul>
</li>
<li><a href="#org1fa1dc8">错误处理概念</a></li>
<li><a href="#orga8148e5">服务器统一出错处理1</a></li>
<li><a href="#org838e56d">服务器统一出错处理2</a></li>
<li><a href="#org5dff55a">error vs panic</a></li>
<li><a href="#org7508f0b">范例小结</a></li>
</ul>
</li>
<li><a href="#org059555c">测试与性能调优</a>
<ul>
<li><a href="#org4e4f23e">测试</a>
<ul>
<li><a href="#org8dc7d6a">传统测试 vs 表格驱动测试</a>
<ul>
<li><a href="#org02c6072">传统测试</a></li>
<li><a href="#orgd1d9c04">表格驱动测试</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org0ac4a87">表格驱动测试</a></li>
<li><a href="#org9178cf5">代码覆盖率和性能测试</a>
<ul>
<li><a href="#orgf17ce6c">代码覆盖率</a></li>
<li><a href="#org800433c">性能测试</a></li>
</ul>
</li>
<li><a href="#org1e1a004">使用pprof进行性能调优</a>
<ul>
<li><a href="#org69d0fee">性能调优模式</a></li>
</ul>
</li>
<li><a href="#org3b9dd21">测试http服务器</a>
<ul>
<li><a href="#org9e06e94">http测试小结</a></li>
</ul>
</li>
<li><a href="#org7816674">生成文档和示例代码</a>
<ul>
<li><a href="#org67ea382">`go doc` 和 `godoc` 命令</a></li>
<li><a href="#org37792f9">用注释写文档</a></li>
<li><a href="#orgc8776c5">生成示例代码</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgf1861f0">goroutine</a>
<ul>
<li><a href="#orgf2522dd">goroutine</a></li>
<li><a href="#org300e7cb">协程Coroutine</a></li>
<li><a href="#orgff575f1">go语言调度器</a>
<ul>
<li><a href="#org41435fb">普通函数 vs 协程</a></li>
<li><a href="#org9ec0e1e">其他语言对协程的支持</a></li>
<li><a href="#org8fc64d2">go语言中的协程是怎样的？</a></li>
<li><a href="#orgd4f2090">goroutine的定义</a></li>
<li><a href="#orgf5fc168">goroutine可能切换的点</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org591d34c">channel</a>
<ul>
<li><a href="#orga85b152">channel语法</a>
<ul>
<li>
<ul>
<li><a href="#org06d8f29">channel也是一等公民，也能作为参数、作为返回值</a></li>
<li><a href="#org7076acd">buffer channel</a></li>
<li><a href="#org5356e68">channel close and range</a></li>
<li><a href="#orgc9d339a">小结channel语法</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org9de6af9">使用Channel等待任务结束</a>
<ul>
<li><a href="#org4750d8a">使用WaitGroup等待多人完成任务</a></li>
</ul>
</li>
<li><a href="#org2f3871f">使用Channel进行树的遍历</a></li>
<li><a href="#org89d421f">使用Select来进行调度</a>
<ul>
<li><a href="#org4adf405">select小结</a></li>
</ul>
</li>
<li><a href="#org2d67654">传统同步机制</a>
<ul>
<li><a href="#orgb689b65">Mutex互斥量的使用</a></li>
</ul>
</li>
<li><a href="#orgddba14a">并发模式</a>
<ul>
<li><a href="#org0a55a0a">channel可以做一个生成器</a></li>
<li><a href="#orgf6c86a6">服务/任务</a></li>
<li><a href="#orgc6c4375">同时等待多个服务：两种方法</a>
<ul>
<li><a href="#org6ae488f">方法1 不确定有几个服务</a></li>
<li><a href="#org0313d8a">方法2：select 确定有几个服务</a></li>
</ul>
</li>
<li><a href="#org076019f">并发模式小结</a></li>
</ul>
</li>
<li><a href="#org644a43e">并发任务的控制</a>
<ul>
<li><a href="#orgb6ca5cc">非阻塞等待</a></li>
<li><a href="#org4229ccf">超时机制</a></li>
<li><a href="#org28d57ed">任务中断/退出</a></li>
<li><a href="#org5ad0394">优雅退出</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org8c2899d">迷宫实现</a>
<ul>
<li><a href="#org928efe9">迷宫算法-广度优先算法</a></li>
<li><a href="#orgf5b211f">迷宫代码实现</a>
<ul>
<li><a href="#org556bced">读进迷宫文件</a></li>
<li><a href="#orgbdf9193">走迷宫</a></li>
<li><a href="#org2f65725">广度优先探索走迷宫小结</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org35b68ae">标准库</a>
<ul>
<li><a href="#org636305a">http库</a>
<ul>
<li><a href="#org604e1e8">使用http客户端发送请求</a></li>
<li><a href="#orga486358">使用http.Client控制请求头部等</a></li>
<li><a href="#orgc35e80c">使用httputil简化工作</a></li>
<li><a href="#org9f310a6">http 服务器性能分析</a></li>
</ul>
</li>
<li><a href="#orga543b54">json库</a>
<ul>
<li><a href="#orgea14d33">JSON的解析</a>
<ul>
<li><a href="#orgdaf2f4e">范例：转JSON数据格式`json.Marshal(o)`</a></li>
<li><a href="#org1af8ce2">json解析</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgbea531e">第三方API数据格式的解析技巧</a></li>
<li><a href="#org9c2f937">gin框架</a>
<ul>
<li><a href="#org5cdc964">`gin-gonic/gin`</a></li>
<li><a href="#org6384f10">middleware的使用</a></li>
<li><a href="#org4c9ac5f">context的使用</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../../index.html">Golang</a></li>
</ul>

<p>
进入工程化阶段，我们接下来要面对的不仅仅是代码片段，
我们要学习在做工程时，利用go语言做到模块化，如何让系统可配置，
如何测试，如何用go语言进行并发。
</p>

<p>
讲述函数式编程，接口，goroutine/channel及其模式
</p>
<section id="outline-container-org28cdbf0" class="outline-2">
<h2 id="org28cdbf0">接口，接口的值类型</h2>
<div class="outline-text-2" id="text-org28cdbf0">
<p>
本节理解的内容
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">type</span> Traversal interface {
    Traverse()
}

func main() {
    traversal := getTraversal()
    traversal.Traverse()
}
</pre>
</div>
<p>
`getTraversal()`定义了接口的使用方法，返回一个接口类型
</p>
</div>
<div id="outline-container-orgc26dc11" class="outline-3">
<h3 id="orgc26dc11">接口的概念</h3>
<div class="outline-text-3" id="text-orgc26dc11">
<p>
大家背景
</p>
<ul class="org-ul">
<li>强类型语言：熟悉接口的概念
学过强类型语言的人一般对接口概念比较熟悉。java, c++中接口是非常重要的概念</li>
<li>弱类型语言：没（少）有接口概念。
php, python, js使用者可能没有实际用到</li>
</ul>

<p>
接口的概念如果只有文字描述，没有实例讲解是非常难理解的。
</p>

<p>
一个段子：
</p>
<ul class="org-ul">
<li>小孩才分对错
前面几章基础部分属于小学生的概念</li>
<li>大人只看利弊</li>
</ul>

<p>
范例：下载网页（函数）
downloader.go文件
</p>
<div class="org-src-container">
<pre class="src src-sh">package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"fmt"</span>
    <span style="color: #8b2252;">"io/ioutil"</span>
    <span style="color: #8b2252;">"net/http"</span>
)

func main() {
    resp, err := http.Get(<span style="color: #8b2252;">"http://www.imooc.com"</span>)
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }

    defer resp.Body.Close()

    bytes, _ := ioutil.ReadAll(resp.Body)
    fmt.Printf(<span style="color: #8b2252;">"%s\n"</span>, bytes)
}
</pre>
</div>

<p>
提取功能：retrieve函数负责功能实现，main函数调用retrieve函数负责输出结果
</p>
<div class="org-src-container">
<pre class="src src-sh">package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"fmt"</span>
    <span style="color: #8b2252;">"io/ioutil"</span>
    <span style="color: #8b2252;">"net/http"</span>
)

func retrieve(url string) string {
    resp, err := http.Get(url)
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }

    defer resp.Body.Close()

    bytes, _ := ioutil.ReadAll(resp.Body)
    <span style="color: #a020f0;">return</span> string(bytes)
}

func main() {
    fmt.Println(retrieve(<span style="color: #8b2252;">"http://www.imooc.com"</span>))
}
</pre>
</div>

<p>
范例：团队协作，下载网页（接口引入）
目录结构，低偶合
</p>
<div class="org-src-container">
<pre class="src src-sh">D:.
&#9474;  downloader.go   // main&#20989;&#25968;&#65292;&#20351;&#29992;&#25509;&#21475;
&#9474;  go.mod
&#9474;
&#9500;&#9472;infra      //infra&#21253;&#65292;&#22522;&#30784;&#26550;&#26500;&#22242;&#38431;&#65292;&#36127;&#36131;&#32593;&#32476;&#35831;&#27714;&#12289;&#30913;&#30424;&#35835;&#20889;&#12289;&#25968;&#25454;&#24211;&#31561;
&#9474;       urlretriever.go  // &#25509;&#21475;&#26041;&#27861;&#30340;&#23454;&#29616;
&#9492;&#9472;testing    //testing&#21253;&#65292;&#27979;&#35797;&#22242;&#38431;
        retriever.go     // &#25509;&#21475;&#26041;&#27861;&#30340;&#23454;&#29616;

<span style="color: #b22222;">#</span><span style="color: #b22222;">infra/urlretriever.go &#25991;&#20214;&#20195;&#30721;</span>
package infra

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"io/ioutil"</span>
    <span style="color: #8b2252;">"net/http"</span>
)

<span style="color: #483d8b;">type</span> Retriever struct{}

// &#23450;&#20041;&#26041;&#27861;
<span style="color: #0000ff;">func</span> (Retriever) Get(url string) string { // &#25509;&#25910;&#32773;(Retriever)&#37324;&#20160;&#20040;&#20063;&#27809;&#26377;&#65292;&#36825;&#37324;&#19981;&#38656;&#35201;&#23450;&#20041;&#21517;&#23383;&#65292;&#20063;&#29992;&#19981;&#21040;
    resp, err := http.Get(url)
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }

    defer resp.Body.Close()

    bytes, _ := ioutil.ReadAll(resp.Body)
    <span style="color: #a020f0;">return</span> string(bytes)
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">testing/retriever.go &#25991;&#20214;&#20195;&#30721;</span>
package testing

<span style="color: #483d8b;">type</span> Retriever struct {}

<span style="color: #0000ff;">func</span> (Retriever) Get(url string) string {
    <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"fake content"</span> // &#36820;&#22238;&#20551;&#25968;&#25454;
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">downloader.go &#25991;&#20214;&#20195;&#30721;</span>
package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"fmt"</span>
    <span style="color: #8b2252;">"learngo/testing"</span>
)

// &#28436;&#21464;1
// &#25226;retriever&#32465;&#23450;&#21040; infra.Retriever&#19978;&#65292;&#30475;&#19978;&#21435;&#26356;&#20687;&#26159;&#37197;&#32622;&#36824;&#19981;&#20687;&#36923;&#36753;&#65292;&#36825;&#37324;&#25226;&#23427;&#25552;&#20986;&#26469;&#20889;&#19968;&#20010;&#20989;&#25968;
// func main() {
//  retriever := infra.Retriever{}
//  fmt.Println(retriever.Get(<span style="color: #8b2252;">"http://www.imooc.com"</span>))
// }

// &#28436;&#21464;2
// retriever&#36923;&#36753;&#21270; var retriever infra.Retriever = getRetriever()
// &#32570;&#28857; retriever &#19968;&#23450;&#26159; infra.Retriever &#31867;&#22411;
// func getRetriever() infra.Retriever {
//  return infra.Retriever{}
// }

// func main() {
//  var retriever infra.Retriever = getRetriever()
//  fmt.Println(retriever.Get(<span style="color: #8b2252;">"http://www.imooc.com"</span>))
// }

// &#28436;&#21464;3
// &#25442;&#19968;&#20010;retriever&#65292;&#20351;&#29992;&#27979;&#35797;&#22242;&#38431;&#30340;&#26041;&#27861;
// &#35201;&#22312;&#21407;&#26469;&#22522;&#30784;&#19978;&#25913;&#24456;&#22810;&#22320;&#26041;
// func getRetriever() testing.Retriever {
//  return testing.Retriever{}
// }

// func main() {
//  var retriever testing.Retriever = getRetriever()
//  fmt.Println(retriever.Get(<span style="color: #8b2252;">"http://www.imooc.com"</span>))
// }

// &#28436;&#21464;4 &#25509;&#21475;&#24341;&#20837;
// go&#35821;&#35328;&#26159;&#24378;&#31867;&#22411;&#30340;
// &#38656;&#35201;&#20195;&#30721;&#21644;&#36923;&#36753;&#19968;&#33268;
// var retriever &#65311; = getRetriever() &#20854;&#20013;&#65311;&#26159;&#19968;&#20010;&#19996;&#35199;&#65292;&#21487;&#20197;Get(string)&#30340;&#19996;&#35199;
// &#36825;&#20010;&#65311;&#38382;&#21495;&#24590;&#20040;&#25551;&#36848;&#65292;&#36825;&#23601;&#26159;&#25105;&#20204;&#30340;&#25509;&#21475;
func getRetriever() retriever {
    <span style="color: #a020f0;">return</span> testing.Retriever{} // &#27979;&#35797;&#22242;&#38431;&#20195;&#30721;&#36890;&#36807;&#65292;&#21487;&#25442;&#25104;&#27491;&#24335;&#20195;&#30721; return infra.Retriever{}
}

// ?Something that can <span style="color: #8b2252;">"Get"</span>
<span style="color: #483d8b;">type</span> retriever interface { // &#36825;&#20010;&#25509;&#21475;&#21487;&#20197;Get
    Get(string) string
}
func main() {
    var r retriever = getRetriever() // &#36825;&#20010;&#19996;&#35199;&#26159;&#20160;&#20040;&#65311;&#26159;getRetriever()
    fmt.Println(r.Get(<span style="color: #8b2252;">"http://www.imooc.com"</span>))
}
</pre>
</div>

<p>
接口是一个抽象的概念，没有具体干什么，只要里面有调用的方法就可以
</p>
</div>
</div>
<div id="outline-container-orgc663292" class="outline-3">
<h3 id="orgc663292">duck typing的概念</h3>
<div class="outline-text-3" id="text-orgc663292">
<p>
大黄鸭是鸭子吗？
</p>
<ul class="org-ul">
<li>传统类型系统：脊索动物门，脊椎动物亚门，鸟纲雁形目</li>
<li>duck typing：是鸭子
<ul class="org-ul">
<li>“像鸭子走路，像鸭子叫（长得像鸭子），那么就是鸭子” &#x2013;原话</li>
<li>描述事物的外部行为而非内部结构</li>
<li>严格说go语言属于结构化类型系统，类似duck typing
<ul class="org-ul">
<li>duck typing中说一定要动态绑定，但go语言是编译就绑定的</li>
</ul></li>
</ul></li>
</ul>

<p>
其它语言中的duck typing
</p>
</div>
<div id="outline-container-org3401d80" class="outline-4">
<h4 id="org3401d80">python中的duck typing</h4>
<div class="outline-text-4" id="text-org3401d80">
<div class="org-src-container">
<pre class="src src-sh">def download(retriever):
   <span style="color: #a020f0;">return</span> retriver.get(<span style="color: #8b2252;">"xx.com"</span>)
</pre>
</div>
<p>
retriver是用来获取资源的，retriver就是duck typing中的对象，download是使用者使用了
duck typing
</p>

<ul class="org-ul">
<li>运行时才知道传入的retriever有没有get</li>
<li>需要注释来说明接口</li>
</ul>
</div>
</div>
<div id="outline-container-orgd3016da" class="outline-4">
<h4 id="orgd3016da">c++中的duck typing</h4>
<div class="outline-text-4" id="text-orgd3016da">
<div class="org-src-container">
<pre class="src src-sh">template &lt;class R&gt;
string dowload(const R&amp; retriever) {
    <span style="color: #a020f0;">return</span> retriever.get(<span style="color: #8b2252;">"xx.com"</span>);
}
</pre>
</div>
<p>
通过template来支持duck typing
</p>
<ul class="org-ul">
<li>编译时才知道传入的retriever有没有get
<ul class="org-ul">
<li>打代码时不知道</li>
</ul></li>
<li>需要注释来说明接口</li>
</ul>
</div>
</div>
<div id="outline-container-orgf31df0d" class="outline-4">
<h4 id="orgf31df0d">java中的类似duck typing的代码</h4>
<div class="outline-text-4" id="text-orgf31df0d">
<div class="org-src-container">
<pre class="src src-sh">&lt;R extends Retriever&gt;
String dowload(R r) {
    <span style="color: #a020f0;">return</span> r.get(<span style="color: #8b2252;">"xx.com"</span>);
}
</pre>
</div>
<ul class="org-ul">
<li>传入的参数必须实现Retriever接口
<ul class="org-ul">
<li>没有运行时、编译时错误</li>
</ul></li>
<li>不是duck typing
<ul class="org-ul">
<li>因为必须实现Retriever接口</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org89e0233" class="outline-4">
<h4 id="org89e0233">go语言的duck typing</h4>
<div class="outline-text-4" id="text-org89e0233">
<ul class="org-ul">
<li>java同时需要Readable, Appendable怎么办？(appche polygence)</li>
<li>同时具有python, c++的duck typing的灵活性
<ul class="org-ul">
<li>什么类型都可以传，只要实现了get的方法就行</li>
</ul></li>
<li>又具有java的类型检查
<ul class="org-ul">
<li>不想通过注释来说明需要什么类型</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org889c7c8" class="outline-3">
<h3 id="org889c7c8">接口的定义</h3>
<div class="outline-text-3" id="text-org889c7c8">
<p>
讲述接口定义前先理解上面代码范例中download和retriever角色是什么
</p>
</div>
<div id="outline-container-org7937e51" class="outline-4">
<h4 id="org7937e51">使用者(download)和实现者(retriever)</h4>
<div class="outline-text-4" id="text-org7937e51">
<ul class="org-ul">
<li>go语言的接口是*使用者*来定义的</li>
</ul>

<p>
范例：使用者定义接口和实现者实现
定义接口
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;retriever/main.go &#25991;&#20214;</span>
package main

import <span style="color: #8b2252;">"fmt"</span>

<span style="color: #483d8b;">type</span> Retriever interface { // &#23450;&#20041;&#25509;&#21475;Retriever&#65292;&#37324;&#38754;&#26377;&#20010;Get&#26041;&#27861;
    Get(url string) string
}

func download(r Retriever) string { // &#20351;&#29992;&#32773;&#65292;&#23450;&#20041;&#20989;&#25968;download&#65292;&#20351;&#29992;&#25509;&#21475;r&#30340;Get&#26041;&#27861;
    <span style="color: #a020f0;">return</span> r.Get(<span style="color: #8b2252;">"http://www.imooc.com"</span>)
}

func main() {
    var r Retriever // r&#36824;&#19981;&#30693;&#36947;&#26159;&#20160;&#20040;&#65292;&#36816;&#34892;&#20250;&#20986;&#38169;&#30340;
    fmt.Println(download(r))
}
</pre>
</div>
<p>
接下来我们就实现`Retriever interface`
实现接口：mockretriever，实现了接口中的方法就证明实现了接口
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314; retriever/mock/mockretriever.go&#25991;&#20214;</span>
package mock

<span style="color: #483d8b;">type</span> Retriever struct {
    Contents string  // &#20869;&#23481;
}

<span style="color: #0000ff;">func</span> (r Retriever) Get(url string) string { // &#23454;&#29616;&#25509;&#21475;&#30340;&#26041;&#27861;
    <span style="color: #a020f0;">return</span> r.Contents
                                          }

<span style="color: #b22222;"># </span><span style="color: #b22222;">retriever/main.go&#25991;&#20214;&#20013;</span>
func main() {
        var r Retriever
        r = mock.Retriever{<span style="color: #8b2252;">"this is a fake imooc.com"</span>} // &#24341;&#29992;&#23454;&#29616;&#25509;&#21475;&#30340;&#23454;&#20363;
        fmt.Println(download(r))
}
&#25110;&#32773;
func main() {
    fmt.Println(download(
        mock.Retriever{
            <span style="color: #8b2252;">"this is a fake imooc.com"</span>}))
}
</pre>
</div>

<p>
实现接口：真实的retriver
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23454;&#29616;&#30340;retriever</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314; retriever/real/retriever.go&#25991;&#20214;</span>
package real

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"net/http"</span>
    <span style="color: #8b2252;">"net/http/httputil"</span>
    <span style="color: #8b2252;">"time"</span>
)

<span style="color: #483d8b;">type</span> Retriever struct {
    UserAgent string
    TimeOut   time.Duration
}

<span style="color: #0000ff;">func</span> (r Retriever) Get(url string) string {
    resp, err := http.Get(url)
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }

    result, err := httputil.DumpResponse(resp, true)

    resp.Body.Close() // &#35835;&#23436;body&#20449;&#24687;&#35201;&#20851;&#38381;body&#12290;http.Get&#65306; Caller should close resp.Body when done reading from it.

    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }

    <span style="color: #a020f0;">return</span> string(result)
}

<span style="color: #b22222;">#  </span><span style="color: #b22222;">retriever/main.go&#25991;&#20214;&#20869;&#23481;</span>
package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"fmt"</span>
    <span style="color: #8b2252;">"learngo/retriever/mock"</span>
    <span style="color: #8b2252;">"learngo/retriever/real"</span>
)

<span style="color: #483d8b;">type</span> Retriever interface { // &#23450;&#20041;&#25509;&#21475;Retriever&#65292;&#37324;&#38754;&#26377;&#20010;Get&#26041;&#27861;
    Get(url string) string
}

func download(r Retriever) string { // &#20351;&#29992;&#32773;&#65292;&#23450;&#20041;&#20989;&#25968;download&#65292;&#20351;&#29992;&#25509;&#21475;r&#30340;Get&#26041;&#27861;
    <span style="color: #a020f0;">return</span> r.Get(<span style="color: #8b2252;">"http://www.imooc.com"</span>)
}

func main() {
    var r Retriever
    r = mock.Retriever{<span style="color: #8b2252;">"this is a fake imooc.com"</span>}
    r = real.Retriever{}
    fmt.Println(download(r))
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orge99aeff" class="outline-4">
<h4 id="orge99aeff">接口的定义</h4>
<div class="outline-text-4" id="text-orge99aeff">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">type</span> Retriever interface {
    Get(<span style="color: #483d8b;">source</span> string) string
}

func download(retriever Retriever) string {
    retrun retriever.Get(<span style="color: #8b2252;">"http://www.imooc.com"</span>)
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org0e03ec0" class="outline-4">
<h4 id="org0e03ec0">接口的实现</h4>
<div class="outline-text-4" id="text-org0e03ec0">
<ul class="org-ul">
<li>接口的实现是隐式的
<ul class="org-ul">
<li>不需要说明它实现了哪个接口</li>
</ul></li>
<li>只要实现接口里的方法</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org300e9d3" class="outline-3">
<h3 id="org300e9d3">接口的值类型</h3>
<div class="outline-text-3" id="text-org300e9d3">
<p>
接口里有什么东西呢？
</p>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#  </span><span style="color: #b22222;">retriever/main.go&#25991;&#20214;</span>
func main() {
    var r Retriever
    r = mock.Retriever{<span style="color: #8b2252;">"this is a fake imooc.com"</span>}
    fmt.Printf(<span style="color: #8b2252;">"%T %v\n"</span>, r, r) // &#26597;&#30475;r&#30340;&#31867;&#22411; mock.Retriever {this is a fake imooc.com}

    r = real.Retriever{
        UserAgent: <span style="color: #8b2252;">"Mozilla/5.0"</span>,
        TimeOut: time.Minute,
    }
    fmt.Printf(<span style="color: #8b2252;">"%T %v\n"</span>, r, r) // real.Retriever {Mozilla/5.0 1m0s}

    //fmt.Println(download(r))
}


<span style="color: #b22222;"># </span><span style="color: #b22222;">real&#20013;Retriever&#23450;&#20041;&#25104;&#25351;&#38024;&#31867;&#22411;&#65292;&#36890;&#36807;&#25351;&#38024;&#35775;&#38382;Get</span>
<span style="color: #b22222;">#  </span><span style="color: #b22222;">retriever/real/retriever.go&#25991;&#20214;</span>
<span style="color: #483d8b;">type</span> Retriever struct {
    UserAgent string
    TimeOut   time.Duration
}

<span style="color: #0000ff;">func</span> (r *Retriever) Get(url string) string {

<span style="color: #b22222;">#  </span><span style="color: #b22222;">retriever/main.go&#25991;&#20214;</span>
func main() {
    var r Retriever
    r = mock.Retriever{<span style="color: #8b2252;">"this is a fake imooc.com"</span>}
    fmt.Printf(<span style="color: #8b2252;">"%T %v\n"</span>, r, r) // &#26597;&#30475;r&#30340;&#31867;&#22411; mock.Retriever {this is a fake imooc.com}

    r = &amp;real.Retriever{             //Retriever&#20013;Get&#26159;&#25351;&#38024;&#25509;&#25910;&#32773;
        UserAgent: <span style="color: #8b2252;">"Mozilla/5.0"</span>,
        TimeOut: time.Minute,

    }
    fmt.Printf(<span style="color: #8b2252;">"%T %v\n"</span>, r, r) // &#31867;&#22411;&#25351;&#38024;*real.Retriever &#20540;&#20063;&#26159;&#25351;&#38024;&amp;{Mozilla/5.0 1m0s}

    //fmt.Println(download(r))
}
</pre>
</div>
<p>
说明 interface 里有2个东西：类型和值
</p>
<ul class="org-ul">
<li>值可以是真实值也可以是指针。</li>
</ul>
<p>
如果是真实的值它是拷贝的，拷贝到r的肚子里。
接口几乎不会用到接口的指针，因为接口肚子里通常会含有一个指针。
</p>
</div>
<div id="outline-container-org2470564" class="outline-5">
<h5 id="org2470564">接口类型的判断</h5>
<div class="outline-text-5" id="text-org2470564">
<p>
取接口类型2种方法
通过switch判断，或者通过type assertion判断
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">retriever/main.go&#25991;&#20214;</span>

func main() {
    var r Retriever
    r = mock.Retriever{<span style="color: #8b2252;">"this is a fake imooc.com"</span>}
    inspect(r) // &#26597;&#30475;r&#30340;&#31867;&#22411; mock.Retriever {this is a fake imooc.com}
               // Contents: this is a fake imooc.com

    r = &amp;real.Retriever{
        UserAgent: <span style="color: #8b2252;">"Mozilla/5.0"</span>,
        TimeOut: time.Minute,
    }
    // &#21462;&#25509;&#21475;&#31867;&#22411;&#65292;&#26041;&#27861;1&#65306;switch
    inspect(r)  // *real.Retriever &amp;{Mozilla/5.0 1m0s}
               // UserAgent: Mozilla/5.0
    // &#21462;&#25509;&#21475;&#31867;&#22411;&#65292;&#26041;&#27861;2&#65306;Type assertition
    realRetriever := r.(*real.Retriever)
    fmt.Println(realRetriever.TimeOut)

    <span style="color: #a020f0;">if</span> mockRetriever, ok := r.(mock.Retriever); ok { // &#26356;&#20005;&#35880;&#30340;&#20889;&#27861;
        fmt.Println(mockRetriever.Contents)
    } <span style="color: #a020f0;">else</span> {
        fmt.Println(<span style="color: #8b2252;">"not a mock retriever"</span>)
    }

    //fmt.Println(download(r))
}

func inspect(r Retriever) {
    fmt.Printf(<span style="color: #8b2252;">"%T %v\n"</span>, r, r)
    switch v := r.(<span style="color: #483d8b;">type</span>) {  // &#24324;&#28165;&#26970;r&#30340;&#31867;&#22411;&#26159;&#20160;&#20040;
    <span style="color: #a020f0;">case</span> mock.Retriever:
        fmt.Println(<span style="color: #8b2252;">"Contents:"</span>, v.Contents)
    <span style="color: #a020f0;">case</span> *real.Retriever:
        fmt.Println(<span style="color: #8b2252;">"UserAgent:"</span>, v.UserAgent)
    }
}

</pre>
</div>
</div>
</div>
<div id="outline-container-org18954b2" class="outline-4">
<h4 id="org18954b2">接口变量里有什么？</h4>
<div class="outline-text-4" id="text-org18954b2">
<p>
接口变量里有
</p>
<ul class="org-ul">
<li>实现者的类型</li>
<li>实现者的值</li>
</ul>

<p>
或者
接口变量里有
</p>
<ul class="org-ul">
<li>实现者的类型</li>
<li>实现者的指针
<ul class="org-ul">
<li>指向实现者</li>
</ul></li>
</ul>

<p>
总结：
</p>
<ul class="org-ul">
<li>接口变量自带指针
有时候带指针，当然也可以带值，通常来说自己带指针的。</li>
<li>接口变量同样采用值传递，几乎不需要使用接口的指针。
<ul class="org-ul">
<li>因为接口变量肚子里有一个指针</li>
</ul></li>
<li>指针接收者实现只能用指针方式使用；值接收者都可</li>
</ul>
</div>
</div>
<div id="outline-container-orge953632" class="outline-4">
<h4 id="orge953632">查看接口变量</h4>
<div class="outline-text-4" id="text-orge953632">
<ul class="org-ul">
<li>表示任何类型：`interface{}`</li>
<li>Type Assertion</li>
<li>Type switch</li>
</ul>

<p>
范例：`interface{}`代表任何类型
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">type</span> Queue []interface{}

<span style="color: #0000ff;">func</span> (q *Queue) Push(v int) {
    *q = append(*q, v)
}

<span style="color: #0000ff;">func</span> (q *Queue) Pop() int {
    head := (*q)[0]
    *q = (*q)[1:]
    <span style="color: #a020f0;">return</span> head.(int) // &#24378;&#21046;&#36716;&#25442;&#25104;int&#31867;&#22411;
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga0113db" class="outline-3">
<h3 id="orga0113db">接口的组合</h3>
<div class="outline-text-3" id="text-orga0113db">
<p>
相对使用者来说的
</p>

<p>
比如：
标准库：io库
</p>
<div class="org-src-container">
<pre class="src src-sh">// ReadCloser is the interface that groups the basic Read and Close methods.
<span style="color: #483d8b;">type</span> ReadCloser interface {
    Reader
    Closer
}

// WriteCloser is the interface that groups the basic Write and Close methods.
<span style="color: #483d8b;">type</span> WriteCloser interface {
    Writer
    Closer
}

// ReadWriteCloser is the interface that groups the basic Read, Write and Close methods.
<span style="color: #483d8b;">type</span> ReadWriteCloser interface {
    Reader
    Writer
    Closer
}
</pre>
</div>

<p>
范例：接口组合
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">retriever/main.go</span>
package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"fmt"</span>
    <span style="color: #8b2252;">"learngo/retriever/mock"</span>
)

<span style="color: #483d8b;">type</span> Retriever interface { // &#23450;&#20041;&#25509;&#21475;Retriever&#65292;&#37324;&#38754;&#26377;&#20010;Get&#26041;&#27861;
    Get(url string) string
}

<span style="color: #483d8b;">type</span> Poster interface {
    Post(url string,
        form map[string]string) string
}

const url = <span style="color: #8b2252;">"http://www.imooc.com"</span>
func download(r Retriever) string { // &#20351;&#29992;&#32773;&#65292;&#23450;&#20041;&#20989;&#25968;download&#65292;&#20351;&#29992;&#25509;&#21475;r&#30340;Get&#26041;&#27861;
    <span style="color: #a020f0;">return</span> r.Get(url)
}

func post(poster Poster) {
    poster.Post(url,
     map[string]string {
        <span style="color: #8b2252;">"name"</span>: <span style="color: #8b2252;">"xxx"</span>,
        <span style="color: #8b2252;">"course"</span>: <span style="color: #8b2252;">"golang"</span>,
     })
}

// &#25509;&#21475;&#32452;&#21512;   &#32452;&#21512; Retriever&#21644;Poster&#25509;&#21475;
<span style="color: #483d8b;">type</span> RetrieverPoster interface {
    Retriever
    Poster
}
func session(s RetrieverPoster) string {
    s.Post(url, map[string]string {
        <span style="color: #8b2252;">"contents"</span>: <span style="color: #8b2252;">"another faked imooc.com"</span>,
    })
    <span style="color: #a020f0;">return</span>  s.Get(url)
}

func main() {
    retriever := mock.Retriever{<span style="color: #8b2252;">"this is a fake imooc.com"</span>}

    fmt.Println(<span style="color: #8b2252;">"Try a session"</span>)
    fmt.Println(session(&amp;retriever))
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23454;&#29616;&#32773;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">retriever/mock/mockretriever.go</span>
package mock

<span style="color: #483d8b;">type</span> Retriever struct {
    Contents string  // &#20869;&#23481;
}

<span style="color: #0000ff;">func</span> (r *Retriever) Get(url string) string { // &#23454;&#29616;&#25509;&#21475;&#30340;&#26041;&#27861;
    <span style="color: #a020f0;">return</span> r.Contents
}

<span style="color: #0000ff;">func</span> (r *Retriever) Post(url string,
    form map[string]string) string {
        r.Contents = form[<span style="color: #8b2252;">"contents"</span>]
    <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"ok"</span>
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdb4e60f" class="outline-3">
<h3 id="orgdb4e60f">常用系统的接口</h3>
<div class="outline-text-3" id="text-orgdb4e60f">
</div>
<div id="outline-container-org5516557" class="outline-4">
<h4 id="org5516557">fmt库Stringer接口</h4>
<div class="outline-text-4" id="text-org5516557">
<p>
可以格式化输出
<a href="https://pkg.go.dev/fmt#Stringer">https://pkg.go.dev/fmt#Stringer</a>
只要实现了String方法就可以
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">type</span> Stringer interface {
    String() string
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfc9b792" class="outline-4">
<h4 id="orgfc9b792">io库的Reader接口和Writer接口</h4>
<div class="outline-text-4" id="text-orgfc9b792">
<p>
<a href="https://pkg.go.dev/io#Reader">https://pkg.go.dev/io#Reader</a>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">type</span> Reader interface {
        Read(p []byte) (n int, err error) // &#30456;&#24403;&#19968;&#20010;&#25991;&#20214;&#65292;&#23454;&#29616;reader&#30340;&#20154;&#26159;&#19968;&#20010;&#25991;&#20214;&#65292;&#23427;&#21487;&#20197;Read&#12290;&#20174;&#25991;&#20214;&#37324;&#35835;&#36827;&#19996;&#35199;&#32473;byte
}

<span style="color: #483d8b;">type</span> Writer interface {
        Write(p []byte) (n int, err error) // &#30456;&#24403;&#19968;&#20010;&#25991;&#20214;&#65292;&#25552;&#20379;&#32473;&#20320;&#36825;&#20123;byte&#30340;&#25968;&#25454;&#25226;&#25991;&#20214;&#20889;&#36827;&#21435;
}
//&#19981;&#21482;&#26159;&#25991;&#20214;&#65292;&#32593;&#32476;&#12289;string&#65292;&#20854;&#23427;&#30340;&#19968;&#20123;&#37117;&#21487;&#20197;&#29992;
</pre>
</div>
<p>
`os.Open`函数返回File结构，File结构就有对Read接口的实现
`fmt.Fprintf`函数中参数`io.Writer`
`fmt.Fscanf`函数中第一个参数是`io.Reader`
</p>

<p>
所以把底层读写相关的东西做成Reader或者Writer就可以写许多系统函数共用，尤其是printf, scanf。
</p>

<p>
范例：函数参数多用接口，如io.Reader接口利用
</p>
<div class="org-src-container">
<pre class="src src-sh">package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"bufio"</span>
    <span style="color: #8b2252;">"bytes"</span>
    <span style="color: #8b2252;">"fmt"</span>
    <span style="color: #8b2252;">"io"</span>
    <span style="color: #8b2252;">"os"</span>
    <span style="color: #8b2252;">"strings"</span>
)

func printFile(filename string) {
    file, err := os.Open(filename)
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }

    PrintFileContents(file) // &#25226;&#23454;&#29616;&#37117;&#23454;&#20363;&#32465;&#23450;&#21040;io.Reader&#25509;&#21475;
}

func PrintFileContents(<span style="color: #483d8b;">read</span> io.Reader) { // &#21033;&#29992;io.Reader&#65292;&#21487;&#35835;&#25991;&#20214;&#65292;&#23383;&#31526;&#20018;&#31561;
    scanner := bufio.NewScanner(<span style="color: #483d8b;">read</span>)

    <span style="color: #a020f0;">for</span> scanner.Scan() {
        fmt.Println(scanner.Text())
    }
}

func main() {
    printFile(<span style="color: #8b2252;">"loop/abc.txt"</span>)
    s := <span style="color: #ff00ff;">`abc"d"</span>
<span style="color: #ff00ff;">    kkk</span>
<span style="color: #ff00ff;">    123</span>

<span style="color: #ff00ff;">    p`</span>
    PrintFileContents(strings.NewReader(s))
    PrintFileContents(bytes.NewReader([]byte(s)))
}
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-org0770c2e" class="outline-2">
<h2 id="org0770c2e">函数式编程</h2>
<div class="outline-text-2" id="text-org0770c2e">
</div>
<div id="outline-container-orgc977f1c" class="outline-3">
<h3 id="orgc977f1c">函数式编程</h3>
<div class="outline-text-3" id="text-orgc977f1c">
<p>
函数式编程不是go语言特有的
go语言对函数式编程的支持主要体现在闭包上面
</p>

<div class="org-src-container">
<pre class="src src-sh">func adder() func (value int) int {
    sum := 0
    <span style="color: #a020f0;">return</span> func(value int) int {
        sum += value
        <span style="color: #a020f0;">return</span> sum
    }
}

func main() {
    adder := adder()
    <span style="color: #a020f0;">for</span> i := 0; i &lt; 100; i++ {
            fmt.Println(adder(i))
    }
}
</pre>
</div>
<p>
adder返回一个累加值
</p>

<p>
来看看函数式编程的概念
</p>
</div>
<div id="outline-container-orgf097b3d" class="outline-4">
<h4 id="orgf097b3d">函数式编程 vs 函数指针</h4>
<div class="outline-text-4" id="text-orgf097b3d">
<p>
最大的区别
</p>
<ul class="org-ul">
<li>函数是一等公民：参数，变量，返回值都可以是函数
<ul class="org-ul">
<li>c++中只有函数指针，java中没有办法把函数传给别人</li>
</ul></li>
<li>高阶函数
<ul class="org-ul">
<li>函数的参数可以是函数</li>
</ul></li>
<li>函数 &#x2013;&gt; 闭包
<ul class="org-ul">
<li>重点</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org8a319a1" class="outline-4">
<h4 id="org8a319a1">“正统”函数式编程</h4>
<div class="outline-text-4" id="text-org8a319a1">
<ul class="org-ul">
<li>不可变性：不能有状态，只有常量和函数</li>
<li>函数只能有一个参数</li>
</ul>
<p>
写出的程序不一定更好。
</p>

<p>
范例：用go语言写“正统”函数式编程
创建目录functional/adder，在adder目录下创建文件adder.go文件
</p>
<div class="org-src-container">
<pre class="src src-sh">package main

import <span style="color: #8b2252;">"fmt"</span>

func adder() func(int) int { // &#32047;&#21152;&#22120;
    sum := 0                     // sum&#20026;&#33258;&#30001;&#21464;&#37327;&#65292; &#19981;&#26159;&#20989;&#25968;&#20307;func(value init) int&#37324;&#38754;&#23450;&#20041;&#30340;&#65292;&#26159;&#22806;&#38754;&#30340;
    <span style="color: #a020f0;">return</span> func(value int) int { // value&#20026;&#23616;&#37096;&#21464;&#37327; &#12290;&#36825;&#20010;&#20989;&#25968;&#36820;&#22238;&#20102;&#19968;&#20010;&#38381;&#21253;func(value int) int&#20869;&#25972;&#20307;
        sum += value
        <span style="color: #a020f0;">return</span> sum
    }
}

// &#8220;&#27491;&#32479;&#8221;&#20989;&#25968;&#24335;&#32534;&#31243;
// &#21482;&#26377;&#24120;&#37327;&#21644;&#20989;&#25968;
// &#19981;&#33021;&#26377;&#29366;&#24577;sum&#12290;&#36825;&#37324;&#25226;&#29366;&#24577;&#25918;&#22312;&#19968;&#20010;&#26032;&#30340;&#20989;&#25968;&#20013;
<span style="color: #483d8b;">type</span> iAdder func(int) (int, iAdder) // &#36820;&#22238;&#24403;&#21069;&#21152;&#23436;&#30340;&#20540;&#21644;&#19979;&#19968;&#20010;&#20540;&#12290;&#36825;&#26159;&#19968;&#20010;&#36882;&#24402;&#30340;&#23450;&#20041;

func adder2(base int) iAdder {
    <span style="color: #a020f0;">return</span> func(v int) (int, iAdder) {
        <span style="color: #a020f0;">return</span> base + v, adder2(base + v)
    }
}

func main() {
    a := adder()
    <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ {
        fmt.Printf(<span style="color: #8b2252;">"0 + 1 ... %d = %d\n"</span>,
            i, a(i)) // a()&#20989;&#25968;&#37324;&#23384;&#20102;&#21464;&#37327;sum&#65292;&#25152;&#20197;&#20250;&#19981;&#26029;&#32047;&#21152;
    }

    a1 := adder2(0)
    <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ {
        var s int
        s, a1 = a1(i)
        fmt.Printf(<span style="color: #8b2252;">"0 + 1 ... %d = %d\n"</span>,
            i, s) // a()&#20989;&#25968;&#37324;&#23384;&#20102;&#21464;&#37327;sum&#65292;&#25152;&#20197;&#20250;&#19981;&#26029;&#32047;&#21152;
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org8c01f41" class="outline-4">
<h4 id="org8c01f41">闭包</h4>
<div class="outline-text-4" id="text-org8c01f41">
<ul class="org-ul">
<li><p>
函数体内有局部变量和自由变量
</p>
<ul class="org-ul">
<li>自由变量：编译器追踪，不断找连接关系，直到所有连接的变量都连接到</li>
<li>连到所有变量后，我们把这个整体叫闭包。这个函数返回了一个闭包</li>
</ul>

<p>
其它语言对闭包的支持
</p></li>
</ul>
</div>
<div id="outline-container-orgdfbe322" class="outline-5">
<h5 id="orgdfbe322">python中的闭包</h5>
<div class="outline-text-5" id="text-orgdfbe322">
<div class="org-src-container">
<pre class="src src-sh">def adder()
    sum = 0

    def f(value):
        nonlocal sum
        sum += value
        <span style="color: #a020f0;">return</span> sum

    <span style="color: #a020f0;">return</span> f
</pre>
</div>
<ul class="org-ul">
<li>python原生支持闭包</li>
<li>使用`__closure__`来查看闭包内容</li>
</ul>
</div>
</div>
<div id="outline-container-org7cec3d8" class="outline-5">
<h5 id="org7cec3d8">c++ 中的闭包</h5>
<div class="outline-text-5" id="text-org7cec3d8">
<p>
新c++14的语法
</p>
<div class="org-src-container">
<pre class="src src-sh">auto adder() {
    auto sum = 0;
    <span style="color: #a020f0;">return</span> [=] (int value) mutable {
        sum += value;
        <span style="color: #a020f0;">return</span> sum;
    };
}
</pre>
</div>
<ul class="org-ul">
<li>过去：stl或者boost带有类似库</li>
<li>c++11及以后：支持闭包</li>
</ul>
</div>
</div>
<div id="outline-container-org7bd414a" class="outline-5">
<h5 id="org7bd414a">java 中的闭包</h5>
<div class="outline-text-5" id="text-org7bd414a">
<div class="org-src-container">
<pre class="src src-sh">Function &lt;Integer, Intege&gt; adder() {
    final Holder&lt;Integer&gt; sum = new Holder&lt;&gt;(0);
    <span style="color: #a020f0;">return</span> (Integer value) -&gt; {
        sum.value += value;
        <span style="color: #a020f0;">return</span> sum.value;
    };
}
</pre>
</div>
<ul class="org-ul">
<li>1.8以后：使用Function接口和Lambda表达式来创建函数对象</li>
<li>匿名类或Lambda表达式均支持闭包</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-orgfcfc34b" class="outline-3">
<h3 id="orgfcfc34b">go语言闭包的应用</h3>
<div class="outline-text-3" id="text-orgfcfc34b">
</div>
<div id="outline-container-org0f60ab0" class="outline-4">
<h4 id="org0f60ab0">函数式编程范例1 斐波那契数列</h4>
<div class="outline-text-4" id="text-org0f60ab0">
<div class="org-src-container">
<pre class="src src-sh">package main

import <span style="color: #8b2252;">"fmt"</span>

// 1, 1, 2, 3, 5, 8, 13 ...
// &#29983;&#25104;&#22120;&#29983;&#25104;&#26000;&#27874;&#37027;&#22865;&#25968;&#21015;&#65292;&#36820;&#22238;&#19968;&#20010;&#26080;&#21442;&#25968;&#30340;&#20989;&#25968;
func fibonacci() func() int {
    a, b := 0, 1  // &#35760;&#24405;&#21069;2&#20010;&#25968;
    <span style="color: #a020f0;">return</span> func() int {
        a, b = b, a + b
        <span style="color: #a020f0;">return</span> a
    }
}

func main() {
    f := fibonacci()  //&#27599;&#20010;&#25968;&#37117;&#26159;&#21069;2&#20010;&#25968;&#30340;&#21644;
    fmt.Println(f()) // 1
    fmt.Println(f()) // 1
    fmt.Println(f()) // 2
    fmt.Println(f()) // 3
    fmt.Println(f())
    fmt.Println(f())
    fmt.Println(f())
    fmt.Println(f())
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org43d84c8" class="outline-4">
<h4 id="org43d84c8">函数式编程范例2 为函数实现接口</h4>
<div class="outline-text-4" id="text-org43d84c8">
<p>
我们发现斐波那契生成的f像一个生成器一样，每次自动调用f就会生成下一个斐波数，这个东西跟文件有点像
我们使用`io.Reader`接口包装一下，把它当成文件一样读
</p>
<div class="org-src-container">
<pre class="src src-sh">package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"bufio"</span>
    <span style="color: #8b2252;">"fmt"</span>
    <span style="color: #8b2252;">"io"</span>
    <span style="color: #8b2252;">"strings"</span>
)


func fibonacci() intGen {
    a, b := 0, 1
    <span style="color: #a020f0;">return</span> func() int {
        a, b = b, a + b
        <span style="color: #a020f0;">return</span> a
    }
}

<span style="color: #483d8b;">type</span> intGen func() int

// &#23454;&#29616;io.Reader&#25509;&#21475;
<span style="color: #0000ff;">func</span> (g intGen) Read(p []byte) (n int, err error) { // intGen&#20989;&#25968;&#20063;&#33021;&#23454;&#29616;&#25509;&#21475;&#65292;&#22240;&#20026;&#20989;&#25968;&#26159;&#19968;&#31561;&#20844;&#27665;&#65292;&#21487;&#24403;&#20989;&#25968;&#21442;&#25968;&#65292;&#25509;&#25910;&#32773;&#23601;&#26159;&#20989;&#25968;&#29305;&#27530;&#30340;&#21442;&#25968;&#32780;&#24050;
    next := g() // &#21462;&#24471;&#19979;&#19968;&#20010;&#20803;&#32032;

    // &#38480;&#21046;&#36755;&#20986;&#20010;&#25968;
    <span style="color: #a020f0;">if</span> next &gt; 10000 {
        <span style="color: #a020f0;">return</span> 0, io.EOF
    }

    // &#23558;&#19979;&#19968;&#20010;&#20803;&#32032;&#20889;&#36827; p []byte&#20013;&#65292;&#36820;&#22238;&#23450;&#20889;&#20102;&#20960;&#20010;&#23383;&#33410;&#21644;&#20986;&#20102;&#20160;&#20040;&#38169;&#35823;
    // &#23454;&#29616;&#27604;&#36739;&#24213;&#23618;&#65292;&#29992;&#20854;&#23427;&#24211;&#20195;&#29702;&#19968;&#19979;&#12290;
    s := fmt.Sprintf(<span style="color: #8b2252;">"%d "</span>, next) // &#25968;&#23383;&#25442;&#25104;&#23383;&#31526;&#20018;&#65292;&#23558; s &#20889;&#36827; p []byte&#20013;
    <span style="color: #a020f0;">return</span> strings.NewReader(s).Read(p)
    // TODO&#65306;incorrect if p is too small!
}


func printFileContents(reader io.Reader) { // &#21407;&#26412;&#29992;&#22788;&#26159;&#25171;&#21360;&#25991;&#20214;&#65292;fibonacci&#23454;&#29616;reader&#25509;&#21475;&#20063;&#33021;&#25171;&#21360;
    scanner := bufio.NewScanner(reader)

    <span style="color: #a020f0;">for</span> scanner.Scan() {
        fmt.Println(scanner.Text())
    }
}

func main() {
    f := fibonacci()  //&#27599;&#20010;&#25968;&#37117;&#26159;&#21069;2&#20010;&#25968;&#30340;&#21644;
    printFileContents(f)
}
</pre>
</div>
<p>
程序优化：`p []byte`如果给的比较小一个整数装不下，只能缓存状态了。
</p>
</div>
</div>
<div id="outline-container-orgf190947" class="outline-4">
<h4 id="orgf190947">函数式编程范例3 使用函数来遍历二叉树</h4>
<div class="outline-text-4" id="text-orgf190947">
<div class="org-src-container">
<pre class="src src-sh">&#9492;&#9472;tree  // tree&#21253;
    &#9474;  node.go     // &#32467;&#26500;&#26041;&#27861;
    &#9474;  traversal.go // &#36941;&#21382;&#26641;&#26041;&#27861;
    &#9474;
    &#9492;&#9472;treentry // main&#21253;
            entry.go
</pre>
</div>
<p>
node.go代码
</p>
<div class="org-src-container">
<pre class="src src-sh">package tree

import <span style="color: #8b2252;">"fmt"</span>

<span style="color: #483d8b;">type</span> Node struct {
    Value       int
    Left, Right *Node
}

// &#23450;&#20041;&#32467;&#26500;&#30340;&#26041;&#27861;
<span style="color: #0000ff;">func</span> (node Node) Print() { //&#20540;&#20256;&#36882; &#22312;&#20989;&#25968;&#21069;&#38754;&#28155;&#21152;&#20102;(node Node)&#25509;&#25910;&#32773;&#65292;&#21644;print(node Node)&#30456;&#24403;
    fmt.Print(node.Value, <span style="color: #8b2252;">" "</span>)
}

<span style="color: #0000ff;">func</span> (node *Node) SetValue(Value int) { // &#24341;&#29992;&#20256;&#36882;
    <span style="color: #a020f0;">if</span> node == nil {
        fmt.Println(<span style="color: #8b2252;">"Setting Value to nil node. Ignored."</span>)
        <span style="color: #a020f0;">return</span> // &#22914;&#26524;node&#26159;nil&#25351;&#38024;&#65292;&#25343;&#20869;&#37096;&#20540;&#26159;&#25343;&#19981;&#21040;&#30340;&#65292;&#20250;&#25253;&#38169;&#65292;&#25152;&#20197;&#35201;return&#36820;&#22238;
    }
    node.Value = Value
}

func CreatNode(Value int) *Node {
    <span style="color: #a020f0;">return</span> &amp;Node{Value: Value}
}
</pre>
</div>
<p>
traversal.go代码，增加遍历功能
</p>
<div class="org-src-container">
<pre class="src src-sh">package tree

import <span style="color: #8b2252;">"fmt"</span>

<span style="color: #0000ff;">func</span> (node *Node) Traverse() {
        node.TraverseFunc(func(n *Node) {
                n.Print()
        })
        fmt.Println()
}

// &#36941;&#21382;&#26102;&#19981;&#19968;&#23450;&#26159;&#35201;&#25171;&#21360;&#65292;&#21487;&#33021;&#26159;&#20854;&#23427;&#20107;
<span style="color: #0000ff;">func</span> (node *Node) TraverseFunc(f func(*Node)) {
        <span style="color: #a020f0;">if</span> node == nil {
                <span style="color: #a020f0;">return</span>
        }

        node.Left.TraverseFunc(f)
        f(node)
        node.Right.TraverseFunc(f)
}
</pre>
</div>
<p>
entry.go代码
</p>
<div class="org-src-container">
<pre class="src src-sh">package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"fmt"</span>
    <span style="color: #8b2252;">"learngo/tree"</span>
)

<span style="color: #483d8b;">type</span> myTreeNode struct {
    node *tree.Node
}

// &#23450;&#20041;&#19968;&#20010;&#21518;&#32493;&#36941;&#21382;&#30340;&#20989;&#25968;
<span style="color: #0000ff;">func</span> (myNode *myTreeNode) postOrder() {
    <span style="color: #a020f0;">if</span> myNode == nil || myNode.node == nil {
        <span style="color: #a020f0;">return</span>
    }

    left := myTreeNode{myNode.node.Left}
    right := myTreeNode{myNode.node.Right}

    left.postOrder()
    right.postOrder()
    myNode.node.Print()
}

func main() {
    // &#32467;&#26500;&#20307;&#30340;&#21019;&#24314;
    var root tree.Node //{0 &lt;nil&gt; &lt;nil&gt;}

    root = tree.Node{Value: 3}
    root.Left = &amp;tree.Node{}
    root.Right = &amp;tree.Node{5, nil, nil}
    root.Right.Left = new(tree.Node)    // root.right&#21518;&#20063;&#21487;&#20197;&#29992;<span style="color: #8b2252;">"."</span>&#28857;&#21495;&#65292;
    root.Left.Right = tree.CreatNode(2) // &#21033;&#29992;&#33258;&#23450;&#20041;&#24037;&#21378;&#20989;&#25968;&#26500;&#36896;&#32467;&#26500;
    // &#32467;&#26500;&#26041;&#27861;&#30340;&#20351;&#29992;
    root.Print()                // 3 &#20854;&#20013;print&#26159;&#20010;&#20989;&#25968;&#65292;&#23427;&#19981;&#26159;&#26080;&#21442;&#30340;&#65292;&#23427;&#26377;&#20010;&#25509;&#25910;&#32773;root
    fmt.Println()
    root.Right.Left.SetValue(4) // setValue&#20989;&#25968;&#20250;&#25226;&#25509;&#25910;&#32773;root.right.left&#30340;&#22320;&#22336;&#20570;&#21442;&#25968;&#20256;&#36882;&#36807;&#21435;

    root.Traverse()
    fmt.Println()
    myRoot := myTreeNode{&amp;root}
    myRoot.postOrder()

    // &#25968;&#19968;&#25968;&#26377;&#20960;&#20010;&#33410;&#28857;
    nodeCount := 0
    root.TraverseFunc(func(n *tree.Node) {
        nodeCount++
    })
    fmt.Println(<span style="color: #8b2252;">"Node count:"</span>, nodeCount)
}
</pre>
</div>

<ul class="org-ul">
<li>范例1 斐波那契数列
展示go语言的闭包</li>
<li>范例2 为函数实现接口
展示函数是一等公民，不仅可以做为参数、变量、返回值，还可以做为实现接口，
因为go语言中的结构方法是一种特殊的函数而已
为 斐波那契数列 实现了一个Reader接口</li>
<li>范例3 使用函数来遍历二叉树
把中间的打印换成了函数，实现多种用途的遍历</li>
</ul>

<p>
总结：go语言闭包的应用
</p>
<ul class="org-ul">
<li>更为自然，不需要修饰如何访问自由变量</li>
<li>没有Lambda表达式，但是有匿名函数
从语法层面上Lambda表达式和匿名函数做的事一样，没必要再有Lambda语法</li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-orge03ab6c" class="outline-2">
<h2 id="orge03ab6c">出错处理与defer/panic/recover</h2>
<div class="outline-text-2" id="text-orge03ab6c">
<p>
资源管理：
</p>
<ul class="org-ul">
<li>打开文件要关闭</li>
<li>连接数据库要释放</li>
<li><p>
这些是要成对出现的
</p>

<p>
加入出错处理后程序有可能中间跳出来，怎么保证打开的连接关闭掉，这时就需要资源管理
与出错处理。
通过defer调用来实现资源管理的。
</p></li>
</ul>
</div>
<div id="outline-container-org85d588a" class="outline-3">
<h3 id="org85d588a">defer调用</h3>
<div class="outline-text-3" id="text-org85d588a">
<ul class="org-ul">
<li>确保调用在函数结束时发生</li>
<li>参数在defer语句时计算</li>
<li>defer列表为先进后出</li>
</ul>


<p>
范例：defer调用及将斐波那契数列写入到文件
创建errhanding/defer/defer.go文件
</p>
<div class="org-src-container">
<pre class="src src-sh">package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"bufio"</span>
    <span style="color: #8b2252;">"fmt"</span>
    <span style="color: #8b2252;">"learngo/functional/fib"</span>
    <span style="color: #8b2252;">"os"</span>
)

func tryDefer() {
    defer fmt.Println(1) // defer&#37324;&#38754;&#30456;&#24403;&#20110;&#26377;&#19968;&#20010;&#26632;&#65292;&#20808;&#36827;&#21518;&#20986;&#30340;
    defer fmt.Println(2)
    fmt.Println(3)
    // defer&#30340;&#22909;&#22788;&#26159;&#19981;&#24597;&#20013;&#38388;&#26377;return, &#29978;&#33267;panic
    panic(<span style="color: #8b2252;">"error occurred"</span>)
    fmt.Println(4)
}

func writeFile(filename string) { // &#23558;&#26000;&#27874;&#37027;&#22865;&#25968;&#21015;&#20889;&#20837;&#21040;&#25991;&#20214;
    file, err := os.Create(filename)  // &#25171;&#24320;&#19968;&#20010;&#25991;&#20214;
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }
    defer file.Close() // &#20351;&#29992;defer&#65292;&#20989;&#25968;&#32467;&#26463;&#21518;&#20851;&#38381;&#25991;&#20214;

    // file&#30452;&#25509;&#20889;&#25991;&#20214;&#27604;&#36739;&#24930;&#65292;&#36825;&#37324;&#29992; bufio &#21152;&#36733;&#21040;&#20869;&#23384;&#26041;&#24335;
    writer := bufio.NewWriter(file)
    defer writer.Flush() // &#20445;&#23384;&#21040;&#25991;&#20214;

    f := fib.Fibonacci()
    <span style="color: #a020f0;">for</span> i := 0; i &lt; 20; i++ { //&#20889;&#20837;&#21069;20&#20010;
        fmt.Fprintln(writer, f())
    }
}

func main() {
    writeFile(<span style="color: #8b2252;">"fib.txt"</span>)
}
</pre>
</div>
<p>
创建functional/fib/fib.go文件
</p>
<div class="org-src-container">
<pre class="src src-sh">package fib

func Fibonacci() func() int {
    a, b := 0, 1
    <span style="color: #a020f0;">return</span> func() int {
        a, b = b, a + b
        <span style="color: #a020f0;">return</span> a
    }
}
</pre>
</div>
</div>
<div id="outline-container-orgcf6c972" class="outline-4">
<h4 id="orgcf6c972">何时使用defer调用</h4>
<div class="outline-text-4" id="text-orgcf6c972">
<ul class="org-ul">
<li>Open/Close</li>
<li>Lock/Unlock</li>
<li>PrintHeader/PrintFooter 打印网页头尾</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org1fa1dc8" class="outline-3">
<h3 id="org1fa1dc8">错误处理概念</h3>
<div class="outline-text-3" id="text-org1fa1dc8">
<div class="org-src-container">
<pre class="src src-sh">file, err := os.Open(<span style="color: #8b2252;">"abc.txt"</span>)
<span style="color: #a020f0;">if</span> err != nil {
        <span style="color: #a020f0;">if</span> pathError, ok := err.(*os.PathError); ok {
               fmt.Println(pathError.Err)
           } <span style="color: #a020f0;">else</span> {
               fmt.Println(<span style="color: #8b2252;">"unknwon error"</span>, err)
           }
    }
</pre>
</div>

<p>
范例：error的处理
创建errhanding/defer/defer.go文件
</p>
<div class="org-src-container">
<pre class="src src-sh">package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"bufio"</span>
    <span style="color: #8b2252;">"errors"</span>
    <span style="color: #8b2252;">"fmt"</span>
    <span style="color: #8b2252;">"learngo/functional/fib"</span>
    <span style="color: #8b2252;">"os"</span>
)

func tryDefer() {
    defer fmt.Println(1) // defer&#37324;&#38754;&#30456;&#24403;&#20110;&#26377;&#19968;&#20010;&#26632;&#65292;&#20808;&#36827;&#21518;&#20986;&#30340;
    defer fmt.Println(2)
    fmt.Println(3)
    // defer&#30340;&#22909;&#22788;&#26159;&#19981;&#24597;&#20013;&#38388;&#26377;return, &#29978;&#33267;panic
    panic(<span style="color: #8b2252;">"error occurred"</span>)
    fmt.Println(4)
}

func writeFile(filename string) { // &#23558;&#26000;&#27874;&#37027;&#22865;&#25968;&#21015;&#20889;&#20837;&#21040;&#25991;&#20214;
    file, err := os.OpenFile(filename, os.O_EXCL|os.O_CREATE, 0666)  // &#25171;&#24320;&#19968;&#20010;&#25991;&#20214;

    // &#33258;&#24049;&#35774;&#32622;&#30340;error
    err = errors.New(<span style="color: #8b2252;">"this is a custom error"</span>)
    // error&#30340;&#22788;&#29702;
    <span style="color: #a020f0;">if</span> err != nil {
        // panic(err) // panic&#27604;&#36739;&#38590;&#30475;
        // fmt.Println(<span style="color: #8b2252;">"file already exists"</span>)
        // fmt.Println(<span style="color: #8b2252;">"Error:"</span>, err.Error()) // &#19981;&#21152;err.Error() &#20063;&#21487;&#20197; &#65292;Println&#20250;err&#20013;&#30340;string&#25214;&#21040;
        // os.OpenFile&#20013;&#36820;&#22238;&#30340;error&#26159;*PathError&#12290;If there is an error, it will be of type *PathError
        <span style="color: #a020f0;">if</span> pathError, ok := err.(*os.PathError); !ok {
            panic(err)
        } <span style="color: #a020f0;">else</span> {
            fmt.Printf(<span style="color: #8b2252;">"%s, %s, %s\n"</span>, pathError.Op,
            pathError.Path,
            pathError.Err) // open, fib.txt, The file exists.
        }
        <span style="color: #a020f0;">return</span>
    }
    defer file.Close() // &#20351;&#29992;defer&#65292;&#20989;&#25968;&#32467;&#26463;&#21518;&#20851;&#38381;&#25991;&#20214;

    // file&#30452;&#25509;&#20889;&#25991;&#20214;&#27604;&#36739;&#24930;&#65292;&#36825;&#37324;&#29992; bufio &#21152;&#36733;&#21040;&#20869;&#23384;&#26041;&#24335;
    writer := bufio.NewWriter(file)
    defer writer.Flush() // &#20445;&#23384;&#21040;&#25991;&#20214;

    f := fib.Fibonacci()
    <span style="color: #a020f0;">for</span> i := 0; i &lt; 20; i++ { //&#20889;&#20837;&#21069;20&#20010;
        fmt.Fprintln(writer, f())
    }
}

func main() {
    writeFile(<span style="color: #8b2252;">"fib.txt"</span>)
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orga8148e5" class="outline-3">
<h3 id="orga8148e5">服务器统一出错处理1</h3>
<div class="outline-text-3" id="text-orga8148e5">
<p>
这里没有新的逻辑，只是定代码的方式
</p>

<p>
范例：
操作1
创建errhandling/filelistingserver/web.go 文件
</p>
<div class="org-src-container">
<pre class="src src-sh">// url&#20013;&#26174;&#31034;&#25991;&#20214;&#20869;&#23481;
package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"io/ioutil"</span>
    <span style="color: #8b2252;">"net/http"</span>
    <span style="color: #8b2252;">"os"</span>
)

func main() {
    http.HandleFunc(<span style="color: #8b2252;">"/list/"</span>,
        func(writer http.ResponseWriter, request *http.Request) {
            path := request.URL.Path[len(<span style="color: #8b2252;">"/list/"</span>):] // /list/fib.txt &#24471;&#21040;&#30495;&#23454;&#25991;&#20214;&#30340;&#36335;&#24452;
            file, err := os.Open(path)
            <span style="color: #a020f0;">if</span> err != nil {
                panic(err)
            }
            defer file.Close()

            all, err := ioutil.ReadAll(file)
            <span style="color: #a020f0;">if</span> err != nil {
                panic(err)
            }

            writer.Write(all)
        })

    err := http.ListenAndServe(<span style="color: #8b2252;">":8888"</span>, nil)
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }
}
</pre>
</div>
<p>
访问 `localhost:8888/list/fib.txts`可以看到内容，访问一个不存在的文件可以看到程序返回错误。
</p>

<p>
做一下错误处理
</p>
<div class="org-src-container">
<pre class="src src-sh">file, err := os.Open(path)
<span style="color: #a020f0;">if</span> err != nil {  // &#38169;&#35823;&#22788;&#29702;&#65292;&#36820;&#22238;&#38169;&#35823;&#21450;http&#29366;&#24577;
    http.Error(writer,
        err.Error(),
        http.StatusInternalServerError)
    <span style="color: #a020f0;">return</span>
}
</pre>
</div>
<p>
访问错误页面<a href="http://localhost:8888/list/fib.txta">http://localhost:8888/list/fib.txta</a>,
页面返回了`open fib.txta: The system cannot find the file specified.`
缺点：把程序内部的信息暴露出来了，用户看到不安全
</p>

<p>
操作2：
把error包装成外部的error
把函数本身的业务逻辑提出来
创建errhandling/filelisting/handler.go 文件
</p>
<div class="org-src-container">
<pre class="src src-sh">package filelisting

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"io/ioutil"</span>
    <span style="color: #8b2252;">"net/http"</span>
    <span style="color: #8b2252;">"os"</span>
)

func HandleFileList(writer http.ResponseWriter,
    request *http.Request) error {
    path := request.URL.Path[len(<span style="color: #8b2252;">"/list/"</span>):] // /list/fib.txt &#24471;&#21040;&#30495;&#23454;&#25991;&#20214;&#30340;&#36335;&#24452;
    file, err := os.Open(path)
    <span style="color: #a020f0;">if</span> err != nil { // &#38169;&#35823;&#22788;&#29702;&#65292;&#19981;&#38656;&#35201;&#22788;&#29702;err
        <span style="color: #a020f0;">return</span> err
    }
    defer file.Close()

    all, err := ioutil.ReadAll(file)
    <span style="color: #a020f0;">if</span> err != nil {
        <span style="color: #a020f0;">return</span> err
    }

    writer.Write(all)
    <span style="color: #a020f0;">return</span> err
}
</pre>
</div>
<p>
errhandling/filelistingserver/web.go 文件
</p>
<div class="org-src-container">
<pre class="src src-sh">// url&#20013;&#26174;&#31034;&#25991;&#20214;&#20869;&#23481;
package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"learngo/errhandling/filelistingserver/filelisting"</span>
    <span style="color: #8b2252;">"log"</span>
    <span style="color: #8b2252;">"net/http"</span>
    <span style="color: #8b2252;">"os"</span>
)

// &#32479;&#19968;&#38169;&#35823;&#22788;&#29702;
<span style="color: #483d8b;">type</span> appHandler func(writer http.ResponseWriter, request *http.Request) error

func errWrapper(handler appHandler) func(http.ResponseWriter, *http.Request) { // &#25226;&#36755;&#20837;&#30340;&#20989;&#25968;&#21253;&#35013;&#25104;&#19968;&#20010;&#36755;&#20986;&#30340;&#20989;&#25968;&#12290; &#20989;&#25968;&#24335;&#32534;&#31243;&#65292;&#20989;&#25968;&#21363;&#21487;&#20570;&#21442;&#25968;&#65292;&#20063;&#21487;&#20570;&#36820;&#22238;&#20540;
    <span style="color: #a020f0;">return</span> func(writer http.ResponseWriter,
        request *http.Request) {
        err := handler(writer, request)
        <span style="color: #a020f0;">if</span> err != nil { // &#38169;&#35823;&#22788;&#29702;
            log.Printf(<span style="color: #8b2252;">"error handing request: %s"</span>,
                err.Error()) // &#31243;&#24207;&#35760;&#24405;&#38169;&#35823;
            code := http.StatusOK
            switch {
            <span style="color: #a020f0;">case</span> os.IsNotExist(err): // &#25991;&#20214;&#19981;&#23384;&#22312;&#30340;&#38169;&#35823;
                code = http.StatusNotFound
            <span style="color: #a020f0;">case</span> os.IsPermission(err): // &#27809;&#26377;&#26435;&#38480; 403
                code = http.StatusForbidden
            default: // &#20160;&#20040;&#37117;&#19981;&#30693;&#36947;&#36820;&#22238; 500
                code = http.StatusInternalServerError
            }
            // &#21442;&#25968;&#30340;&#24847;&#20041;&#65292;1th: &#21521;&#35841;&#27719;&#25253;err&#65292;&#36825;&#37324;&#20026;writer, 2th: &#39029;&#38754;&#26174;&#31034;&#30340;&#38169;&#35823;&#20449;&#24687;&#65292; 3th: &#29366;&#24577;&#30721;
            http.Error(writer,
                http.StatusText(code),
                code)
        }
    }
}

func main() {
    http.HandleFunc(<span style="color: #8b2252;">"/list/"</span>, errWrapper(filelisting.HandleFileList)) // &#23558;&#20989;&#25968;&#20013;&#19994;&#21153;&#36923;&#36753;&#25552;&#20986;&#21435;

    err := http.ListenAndServe(<span style="color: #8b2252;">":8888"</span>, nil)
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }
}
</pre>
</div>
<p>
访问错误页面<a href="http://localhost:8888/list/fib.txta">http://localhost:8888/list/fib.txta</a>,
页面返回了`Not Found`
</p>
</div>
</div>
<div id="outline-container-org838e56d" class="outline-3">
<h3 id="org838e56d">服务器统一出错处理2</h3>
<div class="outline-text-3" id="text-org838e56d">
<p>
范例：
不以`/list/`为入口
修改errhandling/filelistingserver/web.go
</p>
<div class="org-src-container">
<pre class="src src-sh">// url&#20013;&#26174;&#31034;&#25991;&#20214;&#20869;&#23481;
package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"learngo/errhandling/filelistingserver/filelisting"</span>
    <span style="color: #8b2252;">"log"</span>
    <span style="color: #8b2252;">"net/http"</span>
    <span style="color: #8b2252;">"os"</span>
)

// &#32479;&#19968;&#38169;&#35823;&#22788;&#29702;
<span style="color: #483d8b;">type</span> appHandler func(writer http.ResponseWriter, request *http.Request) error

func errWrapper(handler appHandler) func(http.ResponseWriter, *http.Request) { // &#25226;&#36755;&#20837;&#30340;&#20989;&#25968;&#21253;&#35013;&#25104;&#19968;&#20010;&#36755;&#20986;&#30340;&#20989;&#25968;&#12290; &#20989;&#25968;&#24335;&#32534;&#31243;&#65292;&#20989;&#25968;&#21363;&#21487;&#20570;&#21442;&#25968;&#65292;&#20063;&#21487;&#20570;&#36820;&#22238;&#20540;
    <span style="color: #a020f0;">return</span> func(writer http.ResponseWriter,
        request *http.Request) {
        defer func() { // &#24403;&#26381;&#21153;&#21457;&#29616;panic&#26102;&#65292;&#25318;&#25130;&#20445;&#25345;&#19968;&#19979;
            <span style="color: #a020f0;">if</span> r := recover(); r != nil { // &#25318;&#25130;pannic&#65292;&#19981;&#20013;&#26029;&#31243;&#24207;
                log.Printf(<span style="color: #8b2252;">"Panic: %v"</span>, r)
                http.Error(writer,
                    http.StatusText(http.StatusInternalServerError),
                    http.StatusInternalServerError)
            }
        }()

        err := handler(writer, request)

        <span style="color: #a020f0;">if</span> err != nil { // &#38169;&#35823;&#22788;&#29702;
            log.Printf(<span style="color: #8b2252;">"Error handing request: %s"</span>,
                err.Error())
            code := http.StatusOK
            switch {
            <span style="color: #a020f0;">case</span> os.IsNotExist(err): // &#25991;&#20214;&#19981;&#23384;&#22312;&#30340;&#38169;&#35823;
                code = http.StatusNotFound
            <span style="color: #a020f0;">case</span> os.IsPermission(err): // &#27809;&#26377;&#26435;&#38480; 403
                code = http.StatusForbidden
            default: // &#20160;&#20040;&#37117;&#19981;&#30693;&#36947;&#36820;&#22238; 500
                code = http.StatusInternalServerError
            }
            // &#21442;&#25968;&#30340;&#24847;&#20041;&#65292;1th: &#21521;&#35841;&#27719;&#25253;err&#65292;&#36825;&#37324;&#20026;writer, 2th: &#39029;&#38754;&#26174;&#31034;&#30340;&#38169;&#35823;&#20449;&#24687;&#65292; 3th: &#29366;&#24577;&#30721;
            http.Error(writer,
                http.StatusText(code),
                code)
        }
    }
}

func main() {
    http.HandleFunc(<span style="color: #8b2252;">"/"</span>, errWrapper(filelisting.HandleFileList)) // &#21709;&#24212;/&#36335;&#24452;

    err := http.ListenAndServe(<span style="color: #8b2252;">":8888"</span>, nil)
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }
}
</pre>
</div>
<p>
访问错误页面<a href="http://localhost:8888/abc">http://localhost:8888/abc</a>,触发panic
页面返回了`Internal Server Error`，同时程序打印友好的 `Panic: Internal Server Error`
</p>

<p>
业务逻辑判断url路径不匹配时，返回error
修改rrhandling/filelisting/handler.go 文件
</p>
<div class="org-src-container">
<pre class="src src-sh">package filelisting

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"errors"</span>
    <span style="color: #8b2252;">"io/ioutil"</span>
    <span style="color: #8b2252;">"net/http"</span>
    <span style="color: #8b2252;">"os"</span>
    <span style="color: #8b2252;">"strings"</span>
)

const prefix = <span style="color: #8b2252;">"/list/"</span>

func HandleFileList(writer http.ResponseWriter,
    request *http.Request) error {
    <span style="color: #a020f0;">if</span> strings.Index(
        request.URL.Path, prefix) != 0 { // &#21028;&#26029;&#36335;&#24452;&#26159;&#21542;&#21305;&#37197;
        <span style="color: #a020f0;">return</span> errors.New(<span style="color: #8b2252;">"path must start with "</span> + prefix)
    }
    path := request.URL.Path[len(prefix):] // /list/fib.txt &#24471;&#21040;&#30495;&#23454;&#25991;&#20214;&#30340;&#36335;&#24452;
    file, err := os.Open(path)
    <span style="color: #a020f0;">if</span> err != nil { // &#38169;&#35823;&#22788;&#29702;&#65292;&#19981;&#38656;&#35201;&#22788;&#29702;err
        <span style="color: #a020f0;">return</span> err
    }
    defer file.Close()

    all, err := ioutil.ReadAll(file)
    <span style="color: #a020f0;">if</span> err != nil {
        <span style="color: #a020f0;">return</span> err
    }

    writer.Write(all)
    <span style="color: #a020f0;">return</span> err
}
</pre>
</div>
<p>
访问错误页面<a href="http://localhost:8888/abc">http://localhost:8888/abc</a>,触发panic
页面返回了`Internal Server Error`，同时程序打印error日志 `Error handing request: path must start with /list/`
缺点：返回信息哪些能给用户看到哪些不让看没有做区分
</p>

<p>
区分给用户显示的错误信息
修改errhandling/filelistingserver/web.go
</p>
<div class="org-src-container">
<pre class="src src-sh">// url&#20013;&#26174;&#31034;&#25991;&#20214;&#20869;&#23481;
package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"learngo/errhandling/filelistingserver/filelisting"</span>
    <span style="color: #8b2252;">"log"</span>
    <span style="color: #8b2252;">"net/http"</span>
    <span style="color: #8b2252;">"os"</span>
)

// &#32479;&#19968;&#38169;&#35823;&#22788;&#29702;&#65306;
<span style="color: #483d8b;">type</span> appHandler func(writer http.ResponseWriter, request *http.Request) error

func errWrapper(handler appHandler) func(http.ResponseWriter, *http.Request) { // &#25226;&#36755;&#20837;&#30340;&#20989;&#25968;&#21253;&#35013;&#25104;&#19968;&#20010;&#36755;&#20986;&#30340;&#20989;&#25968;&#12290; &#20989;&#25968;&#24335;&#32534;&#31243;&#65292;&#20989;&#25968;&#21363;&#21487;&#20570;&#21442;&#25968;&#65292;&#20063;&#21487;&#20570;&#36820;&#22238;&#20540;
    <span style="color: #a020f0;">return</span> func(writer http.ResponseWriter,
        request *http.Request) {
        defer func() { // &#25351;&#23450;&#36335;&#24452;&#65306;&#24403;&#26381;&#21153;&#21457;&#29616;panic&#26102;&#65292;&#25318;&#25130;&#20445;&#25345;&#19968;&#19979;
            <span style="color: #a020f0;">if</span> r := recover(); r != nil { // &#25351;&#23450;&#36335;&#24452;&#65306;&#25318;&#25130;pannic&#65292;&#19981;&#20013;&#26029;&#31243;&#24207;
                log.Printf(<span style="color: #8b2252;">"Panic: %v"</span>, r)
                http.Error(writer,
                    http.StatusText(http.StatusInternalServerError),
                    http.StatusInternalServerError)
            }
        }()

        err := handler(writer, request)

        <span style="color: #a020f0;">if</span> err != nil { // &#32479;&#19968;&#38169;&#35823;&#22788;&#29702;&#65306;&#38169;&#35823;&#22788;&#29702;
            log.Printf(<span style="color: #8b2252;">"Error handing request: %s"</span>,
                err.Error())

            // &#21306;&#20998;&#29992;&#25143;&#20449;&#24687;&#65306;&#21306;&#20998;&#32473;&#29992;&#25143;&#30475;&#30340;&#38169;&#35823;&#20449;&#24687;
            <span style="color: #a020f0;">if</span> userErr, ok := err.(userError); ok {
                http.Error(writer,
                    userErr.Message(),
                    http.StatusBadRequest)
                <span style="color: #a020f0;">return</span>
            }
            code := http.StatusOK
            switch {
            <span style="color: #a020f0;">case</span> os.IsNotExist(err): // &#25991;&#20214;&#19981;&#23384;&#22312;&#30340;&#38169;&#35823;
                code = http.StatusNotFound
            <span style="color: #a020f0;">case</span> os.IsPermission(err): // &#27809;&#26377;&#26435;&#38480; 403
                code = http.StatusForbidden
            default: // &#20160;&#20040;&#37117;&#19981;&#30693;&#36947;&#36820;&#22238; 500
                code = http.StatusInternalServerError
            }
            // &#21442;&#25968;&#30340;&#24847;&#20041;&#65292;1th: &#21521;&#35841;&#27719;&#25253;err&#65292;&#36825;&#37324;&#20026;writer, 2th: &#39029;&#38754;&#26174;&#31034;&#30340;&#38169;&#35823;&#20449;&#24687;&#65292; 3th: &#29366;&#24577;&#30721;
            http.Error(writer,
                http.StatusText(code),
                code)
        }
    }
}

// &#21306;&#20998;&#29992;&#25143;&#20449;&#24687;&#65306;&#23450;&#20041;&#29992;&#25143;&#38169;&#35823;&#25509;&#21475;
<span style="color: #483d8b;">type</span> userError interface {
    error            // &#31995;&#32479;&#30475;&#30340;&#20449;&#24687;
    Message() string // &#29992;&#25143;&#30475;&#30340;&#20449;&#24687;
}

func main() {
    http.HandleFunc(<span style="color: #8b2252;">"/"</span>, errWrapper(filelisting.HandleFileList)) // &#32479;&#19968;&#38169;&#35823;&#22788;&#29702;|&#25351;&#23450;&#36335;&#24452;&#65306;&#23558;&#20989;&#25968;&#20013;&#19994;&#21153;&#36923;&#36753;&#25552;&#20986;&#21435;

    err := http.ListenAndServe(<span style="color: #8b2252;">":8888"</span>, nil)
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }
}
</pre>
</div>
<p>
修改rrhandling/filelisting/handler.go 文件
</p>
<div class="org-src-container">
<pre class="src src-sh">package filelisting

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"io/ioutil"</span>
    <span style="color: #8b2252;">"net/http"</span>
    <span style="color: #8b2252;">"os"</span>
    <span style="color: #8b2252;">"strings"</span>
)

const prefix = <span style="color: #8b2252;">"/list/"</span>

// &#21306;&#20998;&#29992;&#25143;&#20449;&#24687;&#65306;&#23450;&#20041;userError&#31867;&#22411;
<span style="color: #483d8b;">type</span> userError string

<span style="color: #0000ff;">func</span> (e userError) Error() string {
    <span style="color: #a020f0;">return</span> e.Message()
}

<span style="color: #0000ff;">func</span> (e userError) Message() string {
    <span style="color: #a020f0;">return</span> string(e)
}

func HandleFileList(writer http.ResponseWriter,
    request *http.Request) error { // &#32479;&#19968;&#38169;&#35823;&#22788;&#29702;: &#19994;&#21153;&#36923;&#36753;
    <span style="color: #a020f0;">if</span> strings.Index(
        request.URL.Path, prefix) != 0 { // &#21305;&#37197;&#36335;&#24452;&#65306;&#21028;&#26029;&#36335;&#24452;&#26159;&#21542;&#21305;&#37197;
        <span style="color: #a020f0;">return</span> userError(<span style="color: #8b2252;">"path must start with "</span> + prefix) // &#21306;&#20998;&#29992;&#25143;&#20449;&#24687;&#65306;&#36820;&#22238;&#29992;&#25143;&#38169;&#35823;&#20449;&#24687;&#31867;&#22411;&#20540;
    }
    path := request.URL.Path[len(prefix):] // &#21305;&#37197;&#36335;&#24452;&#65306; /list/fib.txt &#24471;&#21040;&#30495;&#23454;&#25991;&#20214;&#30340;&#36335;&#24452;
    file, err := os.Open(path)
    <span style="color: #a020f0;">if</span> err != nil { // &#38169;&#35823;&#22788;&#29702;&#65292;&#19981;&#38656;&#35201;&#22788;&#29702;err
        <span style="color: #a020f0;">return</span> err
    }
    defer file.Close()

    all, err := ioutil.ReadAll(file)
    <span style="color: #a020f0;">if</span> err != nil {
        <span style="color: #a020f0;">return</span> err
    }

    writer.Write(all)
    <span style="color: #a020f0;">return</span> err
}
</pre>
</div>
<p>
访问错误页面<a href="http://localhost:8888/list/fib.txta">http://localhost:8888/list/fib.txta</a>,
页面返回了`Not Found`，同时程序打印error日志`Error handing request: open fib.txta: The system cannot find the file specified.`
给用户隐藏了系统错误信息
访问错误页面<a href="http://localhost:8888/abc">http://localhost:8888/abc</a>,触发panic
页面返回了`path must start with /list/`，同时程序打印error日志 `Error handing request: path must start with /list/`
给用户显示了用户错误信息
</p>
</div>
</div>
<div id="outline-container-org5dff55a" class="outline-3">
<h3 id="org5dff55a">error vs panic</h3>
<div class="outline-text-3" id="text-org5dff55a">
<p>
尽量不用panic
</p>
<ul class="org-ul">
<li>意料之中的：用error。如：文件打不开</li>
<li>意料之外的：用panic。如：数组越界</li>
</ul>
</div>
</div>
<div id="outline-container-org7508f0b" class="outline-3">
<h3 id="org7508f0b">范例小结</h3>
<div class="outline-text-3" id="text-org7508f0b">
<ul class="org-ul">
<li>defer + panic + recover
做错误处理</li>
<li>Type Assertion
判断错误类型</li>
<li><p>
函数式编程的应用
包装函数
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">type</span> appHandler func(writer http.ResponseWriter, request *http.Request) error
<span style="color: #0000ff;">errWrapper</span>(handler appHandler) func(
    http.ResponseWriter,
    *http.Request) { // &#25226;&#36755;&#20837;&#30340;&#20989;&#25968;&#21253;&#35013;&#25104;&#19968;&#20010;&#36755;&#20986;&#30340;&#20989;&#25968;&#12290; &#20989;&#25968;&#24335;&#32534;&#31243;&#65292;&#20989;&#25968;&#21363;&#21487;&#20570;&#21442;&#25968;&#65292;&#20063;&#21487;&#20570;&#36820;&#22238;&#20540;
</pre>
</div></li>
</ul>
</div>
</div>
</section>
<section id="outline-container-org059555c" class="outline-2">
<h2 id="org059555c">测试与性能调优</h2>
<div class="outline-text-2" id="text-org059555c">
</div>
<div id="outline-container-org4e4f23e" class="outline-3">
<h3 id="org4e4f23e">测试</h3>
<div class="outline-text-3" id="text-org4e4f23e">
<p>
希望程序员多做测试而不是多做调试，能否写出一个好的测试对一名成功的软件工程非常重要。
</p>

<p>
范例：调试
</p>
</div>
<div id="outline-container-org8dc7d6a" class="outline-4">
<h4 id="org8dc7d6a">传统测试 vs 表格驱动测试</h4>
<div class="outline-text-4" id="text-org8dc7d6a">
<p>
go语言是使用表格驱动的测试方法
</p>
</div>
<div id="outline-container-org02c6072" class="outline-5">
<h5 id="org02c6072">传统测试</h5>
<div class="outline-text-5" id="text-org02c6072">
<div class="org-src-container">
<pre class="src src-sh">@Test public void testAdd() {
    assertEquals(3, add(1, 2)); // 1th: 3 &#26399;&#24453;&#20540;&#65292;2th&#65306;add(1, 2)&#31639;&#20986;&#30340;&#20540;
    assertEquals(2, add(0, 2));
    assertEquals(0, add(0, 0));
    assertEquals(0, add(-1, 1));
    assertEquals(Integer.MIN_VALUE, add(1, Integer.MAX_VALUE));
}
</pre>
</div>
<p>
缺点：
</p>
<ul class="org-ul">
<li>测试数据和测试逻辑混在一起</li>
<li>出错信息不明确</li>
<li>一旦一个数据出错测试全部结束</li>
</ul>
</div>
</div>
<div id="outline-container-orgd1d9c04" class="outline-5">
<h5 id="orgd1d9c04">表格驱动测试</h5>
<div class="outline-text-5" id="text-orgd1d9c04">
<p>
go代码示例：
</p>
<div class="org-src-container">
<pre class="src src-sh">tests := []struct { // &#25968;&#25454;
    a, b, c int32
}{
    {1, 2, 3},
    {0, 2, 2},
    {0, 0, 0},
    {-1, 1, 0},
    {math.MaxInt32, 1, math.MinInt32},
}

<span style="color: #a020f0;">for</span> _, test := range tests { // &#36923;&#36753;
        <span style="color: #a020f0;">if</span> actual := add(test.a, test.b); actual != test.c {}
    }
</pre>
</div>
<p>
优点：
</p>
<ul class="org-ul">
<li>分离的测试数据和测试逻辑</li>
<li>明确的出错信息</li>
<li>可以部分失败</li>
<li>go语言的语法使用我们更易实践表格驱动测试
<ul class="org-ul">
<li>java, c++写表格驱动测试比较麻烦</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org0ac4a87" class="outline-3">
<h3 id="org0ac4a87">表格驱动测试</h3>
<div class="outline-text-3" id="text-org0ac4a87">
<ul class="org-ul">
<li>`testing.T`的使用
<ul class="org-ul">
<li>测试文件：
<ul class="org-ul">
<li>文件名`*_test.go`,和被测试代码放在一起</li>
<li>函数名`Test*`开头</li>
</ul></li>
</ul></li>

<li>运行测试
<ul class="org-ul">
<li>命令行：`go test .`</li>
</ul></li>
</ul>



<p>
范例：triangle三角形
</p>
<div class="org-src-container">
<pre class="src src-sh">// learngo/basic/basic/basic.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"math"</span>
)

func triangle() {
  var a, b int = 3, 4
  fmt.Println(calcTriangle(a, b))
}

func calcTriangle(a, b int) int {
  var c int
  c = int(math.Sqrt(float64(a*a + b*b)))
  <span style="color: #a020f0;">return</span> c
}
func main() {
  triangle()
}


// learngo/basic/basic/triangle_test.go

package main

import <span style="color: #8b2252;">"testing"</span>

func TestTriangle(t *testing.T) {
  tests := []struct{ a, b, c int }{
    {3, 4, 5},
    {5, 12, 13},
    {8, 15, 17},
    {12, 35, 37},
    {30000, 40000, 0},
  }

  <span style="color: #a020f0;">for</span> _, tt := range tests {
    <span style="color: #a020f0;">if</span> actual := calcTriangle(tt.a, tt.b); actual != tt.c {
      t.Errorf(<span style="color: #8b2252;">"calcTriangle(%d, %d); got %d; expected %d"</span>,
        tt.a, tt.b, actual, tt.c)
    }
  }
}
</pre>
</div>
<p>
运行测试
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36827;&#20837;&#21040;&#34987;&#27979;&#30446;&#24405;&#65292; &#25191;&#34892;go test .</span>
<span style="color: #483d8b;">cd</span> basic/basic
PS D:\project\learngo\basic\basic&gt; go test .
--- FAIL: TestTriangle (0.00s)
    triangle_test.go:16: calcTriangle(30000, 40000); got 50000; expected 0
FAIL
FAIL    xxx.com/jasper/learngo/basic/basic      0.311s
</pre>
</div>

<p>
范例2：求无重复字符的最长子串
</p>
<div class="org-src-container">
<pre class="src src-sh">// leedcode/nonrepeatingsubstr/nonrepeating.go

package main

import <span style="color: #8b2252;">"fmt"</span>

func lengthOfNonRepeatingSubStr(s string) int {
  lastOccurred := make(map[rune]int) // &#27599;&#20010;&#23383;&#27597;&#26368;&#21518;&#20986;&#29616;&#30340;&#20301;&#32622;
  start := 0                         // &#24403;&#21069;&#25214;&#21040;&#30340;&#26368;&#38271;&#19981;&#21547;&#26377;&#23383;&#31526;&#30340;&#23376;&#20018;&#24320;&#22987;
  maxLength := 0                     // &#37325;&#22797;&#23376;&#20018;&#30340;&#26368;&#22823;&#38271;&#24230;
  // &#36941;&#21382;&#23383;&#31526;&#20018;
  <span style="color: #a020f0;">for</span> i, ch := range []rune(s) {

    <span style="color: #a020f0;">if</span> lastI, ok := lastOccurred[ch]; ok &amp;&amp; lastI &gt;= start { // lastOccurred[ch]&#21487;&#33021;&#26159;&#19981;&#23384;&#22312;&#30340;&#23427;&#30340;&#20540;&#26159;0&#65292;0&#21442;&#19982;&#19979;&#38754;&#30340;&#36816;&#31639;&#26159;&#19981;&#23545;&#30340;
      start = lastOccurred[ch] + 1
    }

    <span style="color: #a020f0;">if</span> i-start+1 &gt; maxLength { // &#26356;&#26032;maxLength
      maxLength = i - start + 1
    }

    lastOccurred[ch] = i
  }

  <span style="color: #a020f0;">return</span> maxLength
}

func main() {
  fmt.Println(
    lengthOfNonRepeatingSubStr(<span style="color: #8b2252;">"abccabcbb"</span>))
  fmt.Println(
    lengthOfNonRepeatingSubStr(<span style="color: #8b2252;">"pwwkewwe"</span>))
  fmt.Println(
    lengthOfNonRepeatingSubStr(<span style="color: #8b2252;">""</span>))
  fmt.Println(
    lengthOfNonRepeatingSubStr(<span style="color: #8b2252;">"b"</span>))
  fmt.Println(
    lengthOfNonRepeatingSubStr(<span style="color: #8b2252;">"&#19968;&#20108;&#19977;&#20108;&#19968;"</span>))
}


// leedcode/nonrepeatingsubstr/nonrepeating_test.go

package main

import <span style="color: #8b2252;">"testing"</span>

func TestSubstr(t *testing.T) {
  tests := []struct {
    s   string
    ans int
  }{
    // Normal cases &#19968;&#33324;&#20363;&#23376;
    {<span style="color: #8b2252;">"abccabcbb"</span>, 3},
    {<span style="color: #8b2252;">"pwwkewwe"</span>, 3},

    // Edg cases &#29305;&#27530;&#20363;&#23376;
    {<span style="color: #8b2252;">""</span>, 0},
    {<span style="color: #8b2252;">"b"</span>, 1},
    {<span style="color: #8b2252;">"bbbb"</span>, 1},
    {<span style="color: #8b2252;">"abcabcabcd"</span>, 4},

    // Chinese support
    {<span style="color: #8b2252;">"&#36825;&#37324;&#26159;"</span>, 3},
    {<span style="color: #8b2252;">"&#19968;&#20108;&#19977;&#20108;&#19968;"</span>, 3},
    {<span style="color: #8b2252;">"&#40657;&#21270;&#40657;&#28784;&#21270;&#32933;&#40657;&#28784;&#20250;&#25381;&#21457;&#21457;&#28784;&#40657;&#21270;&#32933;&#40657;&#28784;&#21270;&#32933;&#25381;&#21457;"</span>, 0},
  }

  <span style="color: #a020f0;">for</span> _, tt := range tests {
    actual := lengthOfNonRepeatingSubStr(tt.s)
    <span style="color: #a020f0;">if</span> actual != tt.ans {
      t.Errorf(<span style="color: #8b2252;">"got %d for input %s; "</span>+
        <span style="color: #8b2252;">"expect %d"</span>,
        actual, tt.s, tt.ans)
    }
  }
}
</pre>
</div>
<p>
运行测试
</p>
<div class="org-src-container">
<pre class="src src-sh">PS D:\project\learngo\basic\basic&gt; cd ..<span style="color: #8b2252;">\.</span>.\leedcode\nonrepeatingsubstr<span style="color: #8b2252;">\</span>

PS D:\project\learngo\leedcode\nonrepeatingsubstr&gt; go test .
--- FAIL: TestSubstr (0.00s)
    nonrepeating_test.go:29: got 7 for input &#40657;&#21270;&#40657;&#28784;&#21270;&#32933;&#40657;&#28784;&#20250;&#25381;&#21457;&#21457;&#28784;&#40657;&#21270;&#32933;&#40657;&#28784;&#21270;&#32933;&#25381;&#21457;; expect 0
FAIL
FAIL    xxx.com/jasper/learngo/leedcode/nonrepeatingsubstr      0.245s
FAIL
</pre>
</div>
</div>
</div>
<div id="outline-container-org9178cf5" class="outline-3">
<h3 id="org9178cf5">代码覆盖率和性能测试</h3>
<div class="outline-text-3" id="text-org9178cf5">
</div>
<div id="outline-container-orgf17ce6c" class="outline-4">
<h4 id="orgf17ce6c">代码覆盖率</h4>
<div class="outline-text-4" id="text-orgf17ce6c">
<p>
命令行
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1.&#29983;&#25104;&#20195;&#30721;&#35206;&#30422;&#29575;&#25991;&#20214;&#65306;</span>
go test -coverprofile=<span style="color: #8b2252;">"c.out"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25110;&#32773; go test -cover</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">2. &#20351;&#29992;go tool &#26597;&#30475;&#65292;&#19979;&#38754;&#20197;&#39029;&#38754;&#26041;&#24335;&#26597;&#30475;&#20026;&#20363;</span>
go tool cover -html=<span style="color: #8b2252;">"c.out"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32511;&#33394;&#26159;cover&#21040;&#30340;&#65292;&#32418;&#33394;&#26159;&#27809;&#26377;cover&#21040;&#30340;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org800433c" class="outline-4">
<h4 id="org800433c">性能测试</h4>
<div class="outline-text-4" id="text-org800433c">
<ul class="org-ul">
<li>函数名：`Benchmark*`开头</li>
<li><p>
命令行：
</p>
<div class="org-src-container">
<pre class="src src-sh">go test -bench .
</pre>
</div></li>
</ul>

<p>
范例：求无重复字符的最长子串
</p>
<div class="org-src-container">
<pre class="src src-sh">// leedcode/nonrepeatingsubstr/nonrepeating_test.go

package main

import <span style="color: #8b2252;">"testing"</span>

func TestSubstr(t *testing.T) {
  tests := []struct {
    s   string
    ans int
  }{
    // Normal cases &#19968;&#33324;&#20363;&#23376;
    {<span style="color: #8b2252;">"abccabcbb"</span>, 3},
    {<span style="color: #8b2252;">"pwwkewwe"</span>, 3},

    // Edg cases &#29305;&#27530;&#20363;&#23376;
    {<span style="color: #8b2252;">""</span>, 0},
    {<span style="color: #8b2252;">"b"</span>, 1},
    {<span style="color: #8b2252;">"bbbb"</span>, 1},
    {<span style="color: #8b2252;">"abcabcabcd"</span>, 4},

    // Chinese support
    {<span style="color: #8b2252;">"&#36825;&#37324;&#26159;"</span>, 3},
    {<span style="color: #8b2252;">"&#19968;&#20108;&#19977;&#20108;&#19968;"</span>, 3},
    {<span style="color: #8b2252;">"&#40657;&#21270;&#40657;&#28784;&#21270;&#32933;&#40657;&#28784;&#20250;&#25381;&#21457;&#21457;&#28784;&#40657;&#21270;&#32933;&#40657;&#28784;&#21270;&#32933;&#25381;&#21457;"</span>, 7},
  }

  <span style="color: #a020f0;">for</span> _, tt := range tests {
    actual := lengthOfNonRepeatingSubStr(tt.s)
    <span style="color: #a020f0;">if</span> actual != tt.ans {
      t.Errorf(<span style="color: #8b2252;">"got %d for input %s; "</span>+
        <span style="color: #8b2252;">"expect %d"</span>,
        actual, tt.s, tt.ans)
    }
  }
}

func BenchmarkSubstr(b *testing.B) {
  // &#36825;&#37324;&#36873;&#19968;&#20010;&#27604;&#36739;&#38590;&#30340;&#26469;&#31034;&#20363;
  s, ans := <span style="color: #8b2252;">"&#40657;&#21270;&#40657;&#28784;&#21270;&#32933;&#40657;&#28784;&#20250;&#25381;&#21457;&#21457;&#28784;&#40657;&#21270;&#32933;&#40657;&#28784;&#21270;&#32933;&#25381;&#21457;"</span>, 7

  <span style="color: #a020f0;">for</span> i := 0; i &lt; b.N; i++ { // b.N &#31995;&#32479;&#20915;&#23450;&#20570;&#22810;&#23569;&#36941;
    actual := lengthOfNonRepeatingSubStr(s)
    <span style="color: #a020f0;">if</span> actual != ans {
      b.Errorf(<span style="color: #8b2252;">"got %d for input %s; "</span>+
        <span style="color: #8b2252;">"expect %d"</span>,
        actual, s, ans)
    }
  }
}
</pre>
</div>
<p>
运行性能测试
</p>
<div class="org-src-container">
<pre class="src src-sh">PS D:\project\learngo\leedcode\nonrepeatingsubstr&gt; go test -bench .
goos: windows
goarch: amd64
pkg: xxx.com/jasper/learngo/leedcode/nonrepeatingsubstr
cpu: Intel(R) Core(TM) i7-6700HQ CPU @ 2.60GHz
BenchmarkSubstr-8        1488318               815.3 ns/op
PASS
ok      xxx.com/jasper/learngo/leedcode/nonrepeatingsubstr      2.290s

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36305;&#20102;1488318&#27425;, &#27599;&#27425;&#29992;&#26102; 815.3&#32435;&#31186;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org1e1a004" class="outline-3">
<h3 id="org1e1a004">使用pprof进行性能调优</h3>
<div class="outline-text-3" id="text-org1e1a004">
<p>
范例：增加求无重复字符的最长子串难度
</p>
<div class="org-src-container">
<pre class="src src-sh"> // leedcode/nonrepeatingsubstr/nonrepeating_test.go
func BenchmarkSubstr(b *testing.B) {
  // &#36825;&#37324;&#36873;&#19968;&#20010;&#27604;&#36739;&#38590;&#30340;&#26469;&#31034;&#20363;
  s, ans := <span style="color: #8b2252;">"&#40657;&#21270;&#40657;&#28784;&#21270;&#32933;&#40657;&#28784;&#20250;&#25381;&#21457;&#21457;&#28784;&#40657;&#21270;&#32933;&#40657;&#28784;&#21270;&#32933;&#25381;&#21457;"</span>, 7
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 13; i++ { // &#22686;&#21152;s&#38271;&#24230;
    s = s + s
  }

  b.Logf(<span style="color: #8b2252;">"len(s) = %d"</span>, len(s)) //&#26597;&#30475;s&#30340;&#38271;&#24230; b.Logf()&#36755;&#20986;&#26085;&#24535;
  b.ResetTimer() // &#37325;&#32622;&#26102;&#38388;&#65292;&#25490;&#38500;&#19978;&#38754;&#20934;&#22791;&#25968;&#25454;&#30340;&#26102;&#38388;

  <span style="color: #a020f0;">for</span> i := 0; i &lt; b.N; i++ { // b.N &#31995;&#32479;&#20915;&#23450;&#20570;&#22810;&#23569;&#36941;
    actual := lengthOfNonRepeatingSubStr(s)
    <span style="color: #a020f0;">if</span> actual != ans {
      b.Errorf(<span style="color: #8b2252;">"got %d for input %s; "</span>+
        <span style="color: #8b2252;">"expect %d"</span>,
        actual, s, ans)
    }
  }
}
</pre>
</div>
<p>
增加字符串长度后，用时
</p>
<div class="org-src-container">
<pre class="src src-sh">PS D:\project\learngo\leedcode\nonrepeatingsubstr&gt; go test -bench .
goos: windows
goarch: amd64
pkg: xxx.com/jasper/learngo/leedcode/nonrepeatingsubstr
cpu: Intel(R) Core(TM) i7-6700HQ CPU @ 2.60GHz
BenchmarkSubstr-8            187           6298157 ns/op
--- BENCH: BenchmarkSubstr-8
    nonrepeating_test.go:43: len(s) = 540672
    nonrepeating_test.go:43: len(s) = 540672
    nonrepeating_test.go:43: len(s) = 540672
PASS
ok      xxx.com/jasper/learngo/leedcode/nonrepeatingsubstr      2.121s

<span style="color: #b22222;"># </span><span style="color: #b22222;">187&#27425;&#65292;&#27599;&#27425;6ms&#24038;&#21491;</span>
</pre>
</div>

<p>
找到运行慢的地方
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#36305;&#24615;&#33021;&#27979;&#35797;&#30340;&#21516;&#26102;&#65292;&#29983;&#25104;cpu&#32791;&#26102;&#20108;&#36827;&#21046;&#25991;&#20214;</span>
go test -bench . -cpuprofile=<span style="color: #8b2252;">"cpu.out"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992;go tool pprof &#26597;&#30475;&#65292; &#22312;&#20132;&#20114;&#24335;&#37324;&#29983;&#25104;&#22270;&#29255;&#26597;&#30475;</span>
go tool pprof cpu.out
(pprof) <span style="color: #483d8b;">help</span>
(pprof) web
</pre>
</div>
<p>
使用web生成图片前，提前安装<a href="https://graphviz.org/download/">graphviz</a>工具
图片中展示信息：
</p>
<ul class="org-ul">
<li>方框越大越花时间</li>
<li>箭头越粗越花时间</li>
</ul>

<p>
优化花时间多的地方
以上面代码“求不重复的最长子串”为例，需要优化3块地方
</p>
<ul class="org-ul">
<li>runtime &#x2013; stringoslicerune &#x2013; decoderune
string在转成`[]rune`时，中间有decode过程，不可避免，无法优化</li>
<li>runtime &#x2013; mapassign_fast32  `lastOccurred[ch] = i` 可优化</li>
<li>runtime &#x2013; mapaccess2_fast32 `lastoccurred[ch]` 可优化</li>
</ul>
<p>
优化map，用其它的数据结构存
</p>
<div class="org-src-container">
<pre class="src src-sh">// leedcode/nonrepeatingsubstr/nonrepeating.go

func lengthOfNonRepeatingSubStr(s string) int {
  // lastOccurred := make(map[rune]int) // &#27599;&#20010;&#23383;&#27597;&#26368;&#21518;&#20986;&#29616;&#30340;&#20301;&#32622;
  lastOccurred := make([]int, 0xffff) // &#23545;&#20110;&#23383;&#31526;&#22411;map&#20248;&#21270;&#30340;&#26041;&#27861;&#65292;&#29992;&#31354;&#38388;&#25442;&#26102;&#38388;&#65292;c++
  // lastOccurred[<span style="color: #8b2252;">'e'</span>] = 1 // lastOccurred[0x65] = 1
  // lastOccurred[<span style="color: #8b2252;">'&#35838;'</span>] = 6 // lastOccurred[0x8BFE] = 6
  <span style="color: #a020f0;">for</span> i := range lastOccurred { // &#21021;&#22987;&#20540;&#35774;&#32622;&#20026; -1
    lastOccurred[i] = -1
  }

  start := 0
  maxLength := 0

  <span style="color: #a020f0;">for</span> i, ch := range []rune(s) {

    <span style="color: #a020f0;">if</span> lastI := lastOccurred[ch]; lastI != -1 &amp;&amp; lastI &gt;= start {  // &#21028;&#26029;
      start = lastOccurred[ch] + 1
    }

    <span style="color: #a020f0;">if</span> i-start+1 &gt; maxLength {
      maxLength = i - start + 1
    }

    lastOccurred[ch] = i
  }

  <span style="color: #a020f0;">return</span> maxLength
}
</pre>
</div>
<p>
运行性能测试
</p>
<div class="org-src-container">
<pre class="src src-sh">PS D:\project\learngo\leedcode\nonrepeatingsubstr&gt; go test -bench . -cpuprofile=<span style="color: #8b2252;">"cpu.out"</span>
goos: windows
goarch: amd64
pkg: xxx.com/jasper/learngo/leedcode/nonrepeatingsubstr
cpu: Intel(R) Core(TM) i7-6700HQ CPU @ 2.60GHz
BenchmarkSubstr-8            435           3457264 ns/op
--- BENCH: BenchmarkSubstr-8
    nonrepeating_test.go:43: len(s) = 540672
    nonrepeating_test.go:43: len(s) = 540672
    nonrepeating_test.go:43: len(s) = 540672
PASS
ok      xxx.com/jasper/learngo/leedcode/nonrepeatingsubstr      2.190s

<span style="color: #b22222;"># </span><span style="color: #b22222;">435&#27425;&#65292;&#27599;&#27425;3ms&#24038;&#21491;&#65292;&#24555;&#20102;2&#20493;&#24038;&#21491;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20877;&#30475;&#19968;&#19979;&#24615;&#33021;&#22270;</span>
go test -bench . -cpuprofile=<span style="color: #8b2252;">"cpu.out"</span>
go tool pprof cpu.out
(pprof) web
</pre>
</div>
<p>
还可以再优化：runtime &#x2013; makeslice
</p>
<div class="org-src-container">
<pre class="src src-sh">// &#20462;&#25913; leedcode/nonrepeatingsubstr/nonrepeating.go
var lastOccurred = make([]int, 0xffff) // &#25552;&#21040;&#20989;&#25968;&#22806;&#38754;

func lengthOfNonRepeatingSubStr(s string) int {

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36816;&#34892;&#24615;&#33021;&#27979;&#35797;</span>
go test -bench . -cpuprofile=<span style="color: #8b2252;">"cpu.out"</span>
go tool pprof cpu.out
(pprof) web
</pre>
</div>
<p>
现在时间都花在 runtime &#x2013; stringoslicerune &#x2013; decoderune上了，没有优化空间了
</p>
</div>
<div id="outline-container-org69d0fee" class="outline-4">
<h4 id="org69d0fee">性能调优模式</h4>
<div class="outline-text-4" id="text-org69d0fee">
<ul class="org-ul">
<li>`-cpuprofile`获取性能数据</li>
<li>`go tool pprof`查看性能数据
<ul class="org-ul">
<li>web命令可看可视化图形</li>
</ul></li>
<li>分析慢在哪里
<ul class="org-ul">
<li>框最大的慢</li>
</ul></li>
<li>优化代码</li>
<li>重复动作</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org3b9dd21" class="outline-3">
<h3 id="org3b9dd21">测试http服务器</h3>
<div class="outline-text-3" id="text-org3b9dd21">
<p>
范例：测试跟业务没有逻辑的出错处理
将出错的返回值接下来
</p>
<div class="org-src-container">
<pre class="src src-sh">// learngo\errhandling\filelistingserver/errwrapper_test.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"errors"</span>
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"io/ioutil"</span>
  <span style="color: #8b2252;">"net/http"</span>
  <span style="color: #8b2252;">"net/http/httptest"</span>
  <span style="color: #8b2252;">"os"</span>
  <span style="color: #8b2252;">"strings"</span>
  <span style="color: #8b2252;">"testing"</span>
)

func errPanic(writer http.ResponseWriter, request *http.Request) error { // &#36755;&#20837;&#20989;&#25968;&#65306;&#20250;panicw&#20449;&#24687;&#30340;&#20989;&#25968;
  panic(123)
}

// &#21306;&#20998;&#29992;&#25143;&#20449;&#24687;&#65306;&#23450;&#20041;userError&#31867;&#22411;
<span style="color: #483d8b;">type</span> testingUserError string

<span style="color: #0000ff;">func</span> (e testingUserError) Error() string {
  <span style="color: #a020f0;">return</span> e.Message()
}

<span style="color: #0000ff;">func</span> (e testingUserError) Message() string {
  <span style="color: #a020f0;">return</span> string(e)
}
func errUserError(writer http.ResponseWriter, request *http.Request) error { // &#36755;&#20837;&#20989;&#25968;&#65306;&#29992;&#25143;&#38169;&#35823;&#20449;&#24687;&#30340;&#20989;&#25968;
  <span style="color: #a020f0;">return</span> testingUserError(<span style="color: #8b2252;">"user error"</span>)
}

func errNotFound(writer http.ResponseWriter, request *http.Request) error { // &#36755;&#20837;&#20989;&#25968;&#65306;&#25991;&#20214;&#19981;&#23384;&#22312;&#38169;&#35823;&#20449;&#24687;&#30340;&#20989;&#25968;
  <span style="color: #a020f0;">return</span> os.ErrNotExist
}

func errPermission(writer http.ResponseWriter, request *http.Request) error { // &#36755;&#20837;&#20989;&#25968;&#65306;&#26435;&#38480;&#38169;&#35823;&#20449;&#24687;&#30340;&#20989;&#25968;
  <span style="color: #a020f0;">return</span> os.ErrPermission
}

func errUnkown(writer http.ResponseWriter, request *http.Request) error { // &#36755;&#20837;&#20989;&#25968;&#65306;500&#38169;&#35823;&#20449;&#24687;&#30340;&#20989;&#25968;
  <span style="color: #a020f0;">return</span> errors.New(<span style="color: #8b2252;">"unknown err"</span>)
}

func noError(writer http.ResponseWriter, request *http.Request) error { // &#36755;&#20837;&#20989;&#25968;&#65306;&#27809;&#26377;&#38169;&#35823;&#20449;&#24687;&#30340;&#20989;&#25968;
  fmt.Fprintln(writer, <span style="color: #8b2252;">"no error"</span>)
  <span style="color: #a020f0;">return</span> nil
}

func TestErrWrapper(t *testing.T) {
  tests := []struct {
    h       appHandler // &#36755;&#20837;&#30340;&#26159;&#20989;&#25968;
    code    int        // &#26399;&#26395;&#30340;&#36755;&#20986;&#65306;&#29366;&#24577;&#30721;
    message string     // &#26399;&#26395;&#30340;&#36755;&#20986;&#65306;&#20449;&#24687;
  }{
    {errPanic, 500, <span style="color: #8b2252;">"Internal Server Error"</span>},
    {errUserError, 400, <span style="color: #8b2252;">"user error"</span>},
    {errNotFound, 404, <span style="color: #8b2252;">"Not Found"</span>},
    {errPermission, 403, <span style="color: #8b2252;">"Forbidden"</span>},
    {errUnkown, 500, <span style="color: #8b2252;">"Internal Server Error"</span>},
    {noError, 200, <span style="color: #8b2252;">"no error"</span>},
  }

  <span style="color: #a020f0;">for</span> _, tt := range tests {
    f := errWrapper(tt.h)
    response := httptest.NewRecorder()
    request := httptest.NewRequest(
      http.MethodGet,
      <span style="color: #8b2252;">"http://www.immoc.com"</span>,
      nil)
    f(response, request) // &#35843;&#29992;&#20986;&#38169;&#20989;&#25968;
    b, _ := ioutil.ReadAll(response.Body)
    body := strings.Trim(string(b), <span style="color: #8b2252;">"\n"</span>) // &#25226;string&#20013;&#30340;&#25442;&#34892;&#21435;&#25481;
    <span style="color: #a020f0;">if</span> response.Code != tt.code ||
      body != tt.message {
      t.Errorf(<span style="color: #8b2252;">"expect (%d, %s); "</span>+
        <span style="color: #8b2252;">"got (%d, %s)"</span>,
        tt.code, tt.message,
        response.Code, body)
    }
  }
}


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#19968;&#19979;&#21738;&#20123;&#20195;&#30721;&#27809;&#26377;&#35206;&#30422;&#21040;</span>
go test -coverprofile=<span style="color: #8b2252;">"c.out"</span>
go tool cover -html=<span style="color: #8b2252;">"c.out"</span>

</pre>
</div>

<p>
真实请求
</p>
<div class="org-src-container">
<pre class="src src-sh">// &#20462;&#25913; learngo\errhandling\filelistingserver/errwrapper_test.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"errors"</span>
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"io/ioutil"</span>
  <span style="color: #8b2252;">"net/http"</span>
  <span style="color: #8b2252;">"net/http/httptest"</span>
  <span style="color: #8b2252;">"os"</span>
  <span style="color: #8b2252;">"strings"</span>
  <span style="color: #8b2252;">"testing"</span>
)

func errPanic(writer http.ResponseWriter, request *http.Request) error { // &#36755;&#20837;&#20989;&#25968;&#65306;&#20250;panicw&#20449;&#24687;&#30340;&#20989;&#25968;
  panic(123)
}

// &#21306;&#20998;&#29992;&#25143;&#20449;&#24687;&#65306;&#23450;&#20041;userError&#31867;&#22411;
<span style="color: #483d8b;">type</span> testingUserError string

<span style="color: #0000ff;">func</span> (e testingUserError) Error() string {
  <span style="color: #a020f0;">return</span> e.Message()
}

<span style="color: #0000ff;">func</span> (e testingUserError) Message() string {
  <span style="color: #a020f0;">return</span> string(e)
}
func errUserError(writer http.ResponseWriter, request *http.Request) error { // &#36755;&#20837;&#20989;&#25968;&#65306;&#29992;&#25143;&#38169;&#35823;&#20449;&#24687;&#30340;&#20989;&#25968;
  <span style="color: #a020f0;">return</span> testingUserError(<span style="color: #8b2252;">"user error"</span>)
}

func errNotFound(writer http.ResponseWriter, request *http.Request) error { // &#36755;&#20837;&#20989;&#25968;&#65306;&#25991;&#20214;&#19981;&#23384;&#22312;&#38169;&#35823;&#20449;&#24687;&#30340;&#20989;&#25968;
  <span style="color: #a020f0;">return</span> os.ErrNotExist
}

func errPermission(writer http.ResponseWriter, request *http.Request) error { // &#36755;&#20837;&#20989;&#25968;&#65306;&#26435;&#38480;&#38169;&#35823;&#20449;&#24687;&#30340;&#20989;&#25968;
  <span style="color: #a020f0;">return</span> os.ErrPermission
}

func errUnkown(writer http.ResponseWriter, request *http.Request) error { // &#36755;&#20837;&#20989;&#25968;&#65306;500&#38169;&#35823;&#20449;&#24687;&#30340;&#20989;&#25968;
  <span style="color: #a020f0;">return</span> errors.New(<span style="color: #8b2252;">"unknown err"</span>)
}

func noError(writer http.ResponseWriter, request *http.Request) error { // &#36755;&#20837;&#20989;&#25968;&#65306;&#27809;&#26377;&#38169;&#35823;&#20449;&#24687;&#30340;&#20989;&#25968;
  fmt.Fprintln(writer, <span style="color: #8b2252;">"no error"</span>)
  <span style="color: #a020f0;">return</span> nil
}

var tests = []struct { // &#27979;&#35797;&#25968;&#25454;&#20849;&#29992;
  h       appHandler // &#36755;&#20837;&#30340;&#26159;&#20989;&#25968;
  code    int        // &#26399;&#26395;&#30340;&#36755;&#20986;&#65306;&#29366;&#24577;&#30721;
  message string     // &#26399;&#26395;&#30340;&#36755;&#20986;&#65306;&#20449;&#24687;
}{
  {errPanic, 500, <span style="color: #8b2252;">"Internal Server Error"</span>},
  {errUserError, 400, <span style="color: #8b2252;">"user error"</span>},
  {errNotFound, 404, <span style="color: #8b2252;">"Not Found"</span>},
  {errPermission, 403, <span style="color: #8b2252;">"Forbidden"</span>},
  {errUnkown, 500, <span style="color: #8b2252;">"Internal Server Error"</span>},
  {noError, 200, <span style="color: #8b2252;">"no error"</span>},
}

func TestErrWrapper(t *testing.T) { // &#20551;&#25968;&#25454;

  <span style="color: #a020f0;">for</span> _, tt := range tests {
    f := errWrapper(tt.h)
    response := httptest.NewRecorder() // &#25552;&#20379;&#20551;&#25968;&#25454;
    request := httptest.NewRequest(
      http.MethodGet,
      <span style="color: #8b2252;">"http://www.immoc.com"</span>,
      nil)
    f(response, request) // &#35843;&#29992;&#20986;&#38169;&#20989;&#25968;
    verifyResponse(
      response.Result(), tt.code, tt.message, t)
  }
}

func TestErrWrapperInServer(t *testing.T) {  // &#21551;&#19968;&#20010;server&#65292;&#30495;&#23454;url&#35775;&#38382;&#35831;&#27714;
  <span style="color: #a020f0;">for</span> _, tt := range tests {
    f := errWrapper(tt.h)
    server := httptest.NewServer(
      http.HandlerFunc(f))
    resp, _ := http.Get(server.URL)

    verifyResponse(
      resp, tt.code, tt.message, t)
  }
}

func verifyResponse(resp *http.Response,
  expectCode int, expectMsssage string,
  t *testing.T) {
  b, _ := ioutil.ReadAll(resp.Body)
  body := strings.Trim(string(b), <span style="color: #8b2252;">"\n"</span>) // &#25226;string&#20013;&#30340;&#25442;&#34892;&#21435;&#25481;
  <span style="color: #a020f0;">if</span> resp.StatusCode != expectCode ||
    body != expectMsssage {
    t.Errorf(<span style="color: #8b2252;">"expect (%d, %s); "</span>+
      <span style="color: #8b2252;">"got (%d, %s)"</span>,
      expectCode, expectMsssage,
      resp.StatusCode, body)
  }
}


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36816;&#34892;&#27979;&#35797;</span>
PS D:\project\learngo\errhandling\filelistingserver&gt; go test -run=<span style="color: #8b2252;">"TestErrWrapperInServer$"</span>
2021/11/12 22:26:45 Panic: 123
2021/11/12 22:26:45 Error handing request: user error
2021/11/12 22:26:45 Error handing request: file does not exist
2021/11/12 22:26:45 Error handing request: permission denied
2021/11/12 22:26:45 Error handing request: unknown err
PASS
ok      xxx.com/jasper/learngo/errhandling/filelistingserver    0.302s
</pre>
</div>
<p>
测试代码就是堆起来的，维护起来比较方便
</p>
</div>
<div id="outline-container-org9e06e94" class="outline-4">
<h4 id="org9e06e94">http测试小结</h4>
<div class="outline-text-4" id="text-org9e06e94">
<ul class="org-ul">
<li>通过使用假的Request/Response
优点：速度快，测试粒度细，更像单元测试只是测试某个函数</li>
<li>通过起服务器
优点：代码覆盖量大。 缺点：慢</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org7816674" class="outline-3">
<h3 id="org7816674">生成文档和示例代码</h3>
<div class="outline-text-3" id="text-org7816674">
</div>
<div id="outline-container-org67ea382" class="outline-4">
<h4 id="org67ea382">`go doc` 和 `godoc` 命令</h4>
<div class="outline-text-4" id="text-org67ea382">
<p>
`go doc`查看文档
</p>
<div class="org-src-container">
<pre class="src src-sh">PS D:\project\learngo\queue&gt; go doc    // &#24403;&#21069;&#30446;&#24405;&#19979;&#30340;&#25991;&#26723;
package queue // import <span style="color: #8b2252;">"xxx.com/jasper/learngo/queue"</span>

<span style="color: #483d8b;">type</span> Queue []int

PS D:\project\learngo\queue&gt; go doc Queue

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26174;&#31034;&#33258;&#24102;&#21253;&#20013;&#30340;&#25991;&#26723;</span>
go doc json.Decoder.Decode
PS D:\project\learngo\queue&gt; go doc fmt.Println
package fmt // import <span style="color: #8b2252;">"fmt"</span>

func Println(a ...interface{}) (n int, err error)
    Println formats using the default formats for its operands and writes to
    standard output. Spaces are always added between operands and a newline is
    appended. It returns the number of bytes written and any write error
    encountered.
</pre>
</div>

<p>
`godoc` 生成文档
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1. godoc&#23433;&#35013;</span>
go get golang.org/x/tools/cmd/godoc
go install golang.org/x/tools/cmd/godoc
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;&#20108;&#36827;&#21046;&#25991;&#20214;&#25918;&#21040;$GOROOT/bin&#19979;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">2. &#39029;&#38754;&#35775;&#38382; http://localhost:6060</span>
godoc -http :6060
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#25214;&#21040;&#25105;&#20204;&#33258;&#24049;&#20889;&#30340;&#25991;&#26723;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org37792f9" class="outline-4">
<h4 id="org37792f9">用注释写文档</h4>
<div class="outline-text-4" id="text-org37792f9">
<p>
注释可以自动转成文档
</p>
<div class="org-src-container">
<pre class="src src-sh">// learngo/queue/queue.go

package queue

// An FIFO queue.
<span style="color: #483d8b;">type</span> Queue []int

// Pushes the element into the queue.
//   e.g. q.Push(123) &#31354;&#26684;&#32473;&#25991;&#23383;&#65292;&#26174;&#31034;&#26102;&#20250;&#26694;&#36215;&#26469;
<span style="color: #0000ff;">func</span> (q *Queue) Push(v int) {
  *q = append(*q, v)
}

// Pops element from head.
<span style="color: #0000ff;">func</span> (q *Queue) Pop() int {
  head := (*q)[0]
  *q = (*q)[1:]
  <span style="color: #a020f0;">return</span> head
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc8776c5" class="outline-4">
<h4 id="orgc8776c5">生成示例代码</h4>
<div class="outline-text-4" id="text-orgc8776c5">
<p>
在测试中加入Example
</p>
<div class="org-src-container">
<pre class="src src-sh">// learngo/queue/queue_test.go

package queue

import <span style="color: #8b2252;">"fmt"</span>

func ExampleQueue_Pop() {
  q := Queue{1}
  q.Push(2)
  q.Push(3)
  fmt.Println(q.Pop())
  fmt.Println(q.Pop())

  // Output:
  // 1
  // 2
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#39029;&#38754;&#20013;&#26597;&#30475;&#31034;&#20363;</span>
godoc -http :6060
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-orgf1861f0" class="outline-2">
<h2 id="orgf1861f0">goroutine</h2>
<div class="outline-text-2" id="text-orgf1861f0">
</div>
<div id="outline-container-orgf2522dd" class="outline-3">
<h3 id="orgf2522dd">goroutine</h3>
<div class="outline-text-3" id="text-orgf2522dd">
<div class="org-src-container">
<pre class="src src-sh">func main() {
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 1000; i++ {
    go func(i int) {
      <span style="color: #a020f0;">for</span> {
        fmt.Println(<span style="color: #8b2252;">"Hello %d\n"</span>, i)
      }
    }(i)
  }
  time.Sleep(time.Microsecond)
}
</pre>
</div>
<p>
加了关键字 go ，其后函数会并发执行。
</p>

<p>
范例：goroutine
</p>
<div class="org-src-container">
<pre class="src src-sh">// goroutine/goroutine.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"time"</span>
)

func main() {
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 1000; i++ {
    go func(i int) { // i &#24341;&#29992;&#22806;&#38754;&#30340; i &#19981;&#23433;&#20840;&#65292;&#36825;&#37324;&#23558; i &#20256;&#36827;&#26469;
      <span style="color: #a020f0;">for</span> { // &#21453;&#22797;&#25171;&#21360;
        fmt.Printf(<span style="color: #8b2252;">"Hello from goroutine %d\n"</span>, i) // &#35777;&#26126;&#24456;&#22810;&#20154;&#25171;&#65292;&#32473;&#23427;&#35774;&#32622;&#19968;&#20010;&#32534;&#21495;
      }
    }(i)
  }
  // &#36825;&#37324;&#30340; main &#21644; for {} &#26159;&#24182;&#21457;&#25191;&#34892;&#30340;&#65292;&#36824;&#26469;&#19981;&#21450;&#25171;&#21360;&#23601;&#25191;&#34892;&#23436;&#20102;
  // main &#32467;&#26463;&#20102;&#65292;&#25152;&#26377;&#30340; goroutine&#23601;&#34987;&#26432;&#25481;&#20102;
  // &#32473;&#19968;&#23450;&#26102;&#38388;&#35753; for{} &#33021;&#25171;&#20986;&#19996;&#35199;
  time.Sleep(time.Millisecond)
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org300e7cb" class="outline-3">
<h3 id="org300e7cb">协程Coroutine</h3>
<div class="outline-text-3" id="text-org300e7cb">
<p>
goroutine是一种协程。
</p>
<ul class="org-ul">
<li>轻量级“线程”
都是并发执行东西的</li>
<li>是*非抢占式*多任务处理，由协程主动交出控制权
只要处理其中切换的几个点就可以了，这个对资源的消耗就会少一些</li>
<li>是编译器/解释器/虚拟机层面的多任务
<ul class="org-ul">
<li>不是操作系统层面的多任务，操作系统层面只有线程没有协程</li>
<li>编译器级别的多任务：编译器会把go 一个function解释成一个协程</li>
<li>在执行上go语言会有一个调度器调度协程</li>
</ul></li>
<li>多协程可能在一个或多个线程上运行
这个是由调度器来决定的</li>
</ul>

<p>
什么是“非抢占式多任务”
抢占式：`fmt.Printf`是io的操作，io的操作里会进行切换，因为io操作总会有等待的过程。
范例：`runtime.Gosched()`交出控制权
</p>
<div class="org-src-container">
<pre class="src src-sh">// goroutine/goroutine.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"runtime"</span>
  <span style="color: #8b2252;">"time"</span>
)

func main() {
  var a [10]int
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ {
    go func(i int) {
      <span style="color: #a020f0;">for</span> {
        a[i]++ // &#27809;&#26377;&#26426;&#20250;&#21327;&#31243;&#38388;&#20999;&#25442;&#65292;&#23601;&#20250;&#34987;&#19968;&#20010;&#21327;&#31243;&#25250;&#25481;&#12290;&#19981;&#20027;&#21160;&#20132;&#20986;&#25511;&#21046;&#26435;&#65292;&#23601;&#20250;&#22987;&#32456;&#22312;&#36825;&#20010;&#21327;&#31243;&#20013;
        runtime.Gosched()
      }
    }(i)
  }
  time.Sleep(time.Millisecond)
  fmt.Println(a)
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32467;&#26524;</span>
PS D:\project\learngo&gt; go run .\goroutine\goroutine.go
[854 442 626 625 578 564 640 620 537 589]
</pre>
</div>

<p>
`go run -race` 检测数据访问的冲突
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">func main() {
  var a [10]int
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ {
    go func() {
      <span style="color: #a020f0;">for</span> {
        a[i]++
        runtime.Gosched()
      }
    }() // &#35299;&#20915;&#25253;&#38169;&#38656;&#35201;&#22266;&#23450;i&#20540;&#65292;&#21363;&#25226;i&#20256;&#36827;&#20989;&#25968;&#20013;
  }
  time.Sleep(time.Millisecond) // &#21322;&#21253;&#20013; i &#22312;&#36825;&#26159; <span style="color: #a0522d;">i</span>= 10&#65292;a[10]&#26159;&#19981;&#23384;&#22312;&#30340;&#65292;&#26080;&#27861;&#22312;&#38381;&#21253;&#20013;&#36816;&#34892;
  fmt.Println(a)
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#25968;&#25454;&#20914;&#31361;</span>
PS D:\project\learngo&gt; go run  -race .\goroutine\goroutine.go
==================
WARNING: DATA RACE
Read at 0x00c00012c078 by goroutine 7:
</pre>
</div>
</div>
</div>
<div id="outline-container-orgff575f1" class="outline-3">
<h3 id="orgff575f1">go语言调度器</h3>
<div class="outline-text-3" id="text-orgff575f1">
<ul class="org-ul">
<li>子程序是协程的一个特例</li>
</ul>
</div>
<div id="outline-container-org41435fb" class="outline-4">
<h4 id="org41435fb">普通函数 vs 协程</h4>
<div class="outline-text-4" id="text-org41435fb">
<p>
普通函数在一个线程内&#x2013; 线程中有main函数&#x2013; main函数调用doWork函数，等doWork结束才把
控制权交给main函数
</p>

<p>
协程也是有main和doWork函数，但他们之间不是单向的箭头，他们中间有个双向的通道。
main和doWork之间数据可以进行双向的流通、控制权也可以双向的流通。就相当于并发执行
的两个线程。
main和doWork可能运行在一个线程中也可能在多个线程中，这个事情不需要管，由调度器负责。
</p>
</div>
</div>
<div id="outline-container-org9ec0e1e" class="outline-4">
<h4 id="org9ec0e1e">其他语言对协程的支持</h4>
<div class="outline-text-4" id="text-org9ec0e1e">
<p>
其他语言不是原生支持
</p>
<ul class="org-ul">
<li>c++ ：Boost.Coroutine库</li>
<li>java: 不支持；第三方的有</li>
<li>python中的协程
<ul class="org-ul">
<li>使用yield关键字实现协程</li>
<li>python 3.5加入async def对协程原生支持</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org8fc64d2" class="outline-4">
<h4 id="org8fc64d2">go语言中的协程是怎样的？</h4>
<div class="outline-text-4" id="text-org8fc64d2">
<p>
go语言的一个进程，程序开启后他下面有一个调度器，调度器负责调度协程。
有些协程是1个协程放在线程中、有些协程是2个协程放一个线程中等，这些是调度器来
控制的。
</p>
</div>
</div>
<div id="outline-container-orgd4f2090" class="outline-4">
<h4 id="orgd4f2090">goroutine的定义</h4>
<div class="outline-text-4" id="text-orgd4f2090">
<ul class="org-ul">
<li>任何函数只需加上go关键字就能送给调度器运行。</li>
<li>好处：不需要在定义时区分是否是异步函数
这是相对于python来讲的</li>
<li>调度器会在合适的点进行切换
虽然是非抢占式的，但还是有个调度器进行切换，这些切换的点我们并不进行完全的
控制。这个也是goroutine和传统意义上协程有一定区别的地方。
传统意义上的协程是非抢占式的，所有切换的点都需要显示地写出来，但goroutine
不一样，就像写普通函数一样，调度器会进行切换。
但它又和线程的切换不一样，它是固定的点切换</li>
<li>使用`-race`来检测数据访问冲突</li>
</ul>
</div>
</div>
<div id="outline-container-orgf5fc168" class="outline-4">
<h4 id="orgf5fc168">goroutine可能切换的点</h4>
<div class="outline-text-4" id="text-orgf5fc168">
<ul class="org-ul">
<li>I/O或者select
i/o：如，向屏幕上打印字</li>
<li>channel</li>
<li>等待锁</li>
<li>函数调用(有时)
是一个切换的机会，这个由调度器决定</li>
<li>runtime.Gosched()
手动提供一个切换的点，交出控制权</li>
<li>上面的只是参考，不能保证切换，不能保证在其他地方不切换
goroutine协程是非抢占式的，从代码来看可能跟抢占式的有点像，但实际运行的机制
还是非抢占式的</li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-org591d34c" class="outline-2">
<h2 id="org591d34c">channel</h2>
<div class="outline-text-2" id="text-org591d34c">
<p>
协程之间的双向通道，即channel
</p>
</div>
<div id="outline-container-orga85b152" class="outline-3">
<h3 id="orga85b152">channel语法</h3>
<div class="outline-text-3" id="text-orga85b152">
<p>
范例：创建channel
</p>
<div class="org-src-container">
<pre class="src src-sh">package main

import <span style="color: #8b2252;">"fmt"</span>

func chanDemo() {
  // &#21019;&#24314;channel
  // var c chan int // c == nil &#65292;&#21482;&#26159;&#23450;&#20041;&#20102;chan&#65292;&#23427;&#30340;&#20540;&#26159;nil&#65292;nil&#30340;channel&#26080;&#27861;&#20351;&#29992;&#65292;&#20294;&#22312;select&#20013;&#20250;&#29992;&#21040;
  c := make(chan int)
  // &#21457;&#25968;&#25454;
  c &lt;- 1  // &#27515;&#38145;&#22312;&#21521;chan&#21457;&#36865;1
  c &lt;- 2
  // &#20174;chan&#20013;&#25910;&#25968;&#25454;
  n := &lt;-c
  fmt.Println(n)
}

func main() {
  chanDemo()
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25191;&#34892;&#25253;&#38169;&#65292;&#27515;&#38145;</span>
PS D:\project\learngo&gt; go run .\channel\channel.go
fatal error: all goroutines are asleep - deadlock!

goroutine 1 [chan send]:
<span style="color: #0000ff;">main.chanDemo</span>()
        D:/project/learngo/channel/channel.go:10 +0x37
</pre>
</div>
<p>
channel是goroutine和goroutine之间的交互，发了数据没人收就会deadlock！
修改之后代码
</p>
<div class="org-src-container">
<pre class="src src-sh">func chanDemo() {
  // &#21019;&#24314;channel
  // var c chan int // c == nil &#65292;&#21482;&#26159;&#23450;&#20041;&#20102;chan&#65292;&#23427;&#30340;&#20540;&#26159;nil&#65292;nil&#30340;channel&#26080;&#27861;&#20351;&#29992;&#65292;&#20294;&#22312;select&#20013;&#20250;&#29992;&#21040;
  c := make(chan int)
  go func() {
    <span style="color: #a020f0;">for</span> {
      n := &lt;-c
      fmt.Println(n)
    }
  }()
  // &#21457;&#25968;&#25454;
  c &lt;- 1
  c &lt;- 2
  // &#36991;&#20813;&#26469;&#19981;&#21450;&#25171;&#21360;&#65292;main&#20989;&#25968;&#20808;&#32467;&#26463;&#20102;
  time.Sleep(time.Millisecond)
}

func main() {
  chanDemo()
}
</pre>
</div>
</div>
<div id="outline-container-org06d8f29" class="outline-5">
<h5 id="org06d8f29">channel也是一等公民，也能作为参数、作为返回值</h5>
<div class="outline-text-5" id="text-org06d8f29">
<p>
范例：channel当函数参数
</p>
<div class="org-src-container">
<pre class="src src-sh">package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"time"</span>
)

func worker(id int, c chan int) {
  <span style="color: #a020f0;">for</span> {
    fmt.Printf(<span style="color: #8b2252;">"worker %d received %d\n"</span>,
      id, &lt;-c)
  }
}

func chanDemo() {
  // &#21019;&#24314;channel
  // var c chan int // c == nil &#65292;&#21482;&#26159;&#23450;&#20041;&#20102;chan&#65292;&#23427;&#30340;&#20540;&#26159;nil&#65292;nil&#30340;channel&#26080;&#27861;&#20351;&#29992;&#65292;&#20294;&#22312;select&#20013;&#20250;&#29992;&#21040;
  c := make(chan int)
  //go worker(c)
  go worker(0, c)
  // &#21457;&#25968;&#25454;
  c &lt;- 1
  c &lt;- 2
  // &#36991;&#20813;&#26469;&#19981;&#21450;&#25171;&#21360;&#65292;main&#20989;&#25968;&#20808;&#32467;&#26463;&#20102;
  time.Sleep(time.Millisecond)
}

func main() {
  chanDemo()
}
</pre>
</div>

<p>
范例：channel作为数组的类型
</p>
<div class="org-src-container">
<pre class="src src-sh">package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"time"</span>
)

func worker(id int, c chan int) {
  <span style="color: #a020f0;">for</span> {
    fmt.Printf(<span style="color: #8b2252;">"worker %d received %c\n"</span>,
      id, &lt;-c)
  }
}

func chanDemo() {

  var channels [10]chan int // channel&#20316;&#20026;&#25968;&#32452;&#30340;&#31867;&#22411;
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ { // &#24320;10&#20010;work&#25509;&#25910;channel&#25968;&#25454;
    channels[i] = make(chan int)
    go worker(i, channels[i])
  }

  // &#21521;10&#20010;channels[i]&#21457;&#25968;&#25454;
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ {
    channels[i] &lt;- <span style="color: #8b2252;">'a'</span> + i
  }
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ {
    channels[i] &lt;- <span style="color: #8b2252;">'A'</span> + i
  }

  // &#36991;&#20813;&#26469;&#19981;&#21450;&#25171;&#21360;&#65292;main&#20989;&#25968;&#20808;&#32467;&#26463;&#20102;
  time.Sleep(time.Millisecond)
}

func main() {
  chanDemo()
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;</span>
PS D:\project\learngo&gt; go run .\channel\channel.go
worker 3 received d
worker 0 received a
worker 0 received A
worker 5 received f
worker 4 received e
worker 8 received i
worker 9 received j
worker 2 received c
worker 1 received b
worker 1 received B
worker 7 received h
worker 6 received g
worker 6 received G
worker 2 received C
worker 3 received D
</pre>
</div>

<p>
范例：channel作为返回值
</p>
<div class="org-src-container">
<pre class="src src-sh">package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"time"</span>
)

func createWorker(id int) chan int {
  c := make(chan int)
  go func(){ // &#30495;&#27491;&#20570;&#20107;&#30340;work
    <span style="color: #a020f0;">for</span> {
      fmt.Printf(<span style="color: #8b2252;">"worker %d received %c\n"</span>,
        id, &lt;-c)
    }
  }()

  <span style="color: #a020f0;">return</span> c
}

func chanDemo() {

  var channels [10]chan int // channel&#20316;&#20026;&#25968;&#32452;&#30340;&#31867;&#22411;
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ { // &#24320;10&#20010;work&#25509;&#25910;channel&#25968;&#25454;
    channels[i] = createWorker(i)
  }

  // &#21521;10&#20010;channels[i]&#21457;&#25968;&#25454;
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ {
    channels[i] &lt;- <span style="color: #8b2252;">'a'</span> + i
  }
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ {
    channels[i] &lt;- <span style="color: #8b2252;">'A'</span> + i
  }

  // &#36991;&#20813;&#26469;&#19981;&#21450;&#25171;&#21360;&#65292;main&#20989;&#25968;&#20808;&#32467;&#26463;&#20102;
  time.Sleep(time.Millisecond)
}

func main() {
  chanDemo()
}

</pre>
</div>

<p>
范例：channel的定义上进一步修饰，告知channel的使用方式
</p>
<div class="org-src-container">
<pre class="src src-sh">func createWorker(id int) chan&lt;- int { // &#21578;&#30693;channel&#26159;&#21521;channel&#21457;&#25968;&#25454;&#30340;
  c := make(chan int)
  go func(){ // &#30495;&#27491;&#20570;&#20107;&#30340;work
    <span style="color: #a020f0;">for</span> {
      fmt.Printf(<span style="color: #8b2252;">"worker %d received %c\n"</span>,
        id, &lt;-c)  // &#37324;&#38754;&#21482;&#33021;&#20174;channel&#20013;&#25910;&#25968;&#25454;
    }
  }()

  <span style="color: #a020f0;">return</span> c
}

func chanDemo() {

  var channels [10]chan&lt;- int //
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ { // &#24320;10&#20010;work&#25509;&#25910;channel&#25968;&#25454;
    channels[i] = createWorker(i)
  }

  // &#21521;10&#20010;channels[i]&#21457;&#25968;&#25454;
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ {
    channels[i] &lt;- <span style="color: #8b2252;">'a'</span> + i
  }
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ {
    channels[i] &lt;- <span style="color: #8b2252;">'A'</span> + i
  }

  // &#36991;&#20813;&#26469;&#19981;&#21450;&#25171;&#21360;&#65292;main&#20989;&#25968;&#20808;&#32467;&#26463;&#20102;
  time.Sleep(time.Millisecond)
}

func main() {
  chanDemo()
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org7076acd" class="outline-5">
<h5 id="org7076acd">buffer channel</h5>
<div class="outline-text-5" id="text-org7076acd">
<p>
范例：channel有缓冲区
</p>
<div class="org-src-container">
<pre class="src src-sh">package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"time"</span>
)

func worker(id int, c chan int) {
  <span style="color: #a020f0;">for</span> {
    fmt.Printf(<span style="color: #8b2252;">"worker %d received %c\n"</span>,
      id, &lt;-c)  // &#37324;&#38754;&#21482;&#33021;&#20174;channel&#20013;&#25910;&#25968;&#25454;
  }
}

func bufferChannel() {
  c := make(chan int, 3) // &#26377;3&#20010;&#32531;&#20914;
  go worker(0, c)
  c &lt;- <span style="color: #8b2252;">'a'</span>
  c &lt;- <span style="color: #8b2252;">'b'</span>
  c &lt;- <span style="color: #8b2252;">'c'</span>
  c &lt;- <span style="color: #8b2252;">'d'</span>
  time.Sleep(time.Millisecond)
}

func main() {
  bufferChannel()
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org5356e68" class="outline-5">
<h5 id="org5356e68">channel close and range</h5>
<div class="outline-text-5" id="text-org5356e68">
<p>
范例：channel可以close，永远是发送方close
</p>
<div class="org-src-container">
<pre class="src src-sh">package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"time"</span>
)

func worker(id int, c chan int) {
  // for {
  //  n, ok := &lt;-c // &#21028;&#26029;channel&#26159;&#21542;&#26377;&#25968;&#25454;&#26041;&#27861;1
  //  if !ok {
  //    break
  //  }
  //  fmt.Printf(<span style="color: #8b2252;">"worker %d received %c\n"</span>,
  //    id, n)
  // }

  <span style="color: #a020f0;">for</span> n := range c {  // &#21028;&#26029;channel&#26159;&#21542;&#26377;&#25968;&#25454;&#26041;&#27861;2
    fmt.Printf(<span style="color: #8b2252;">"worker %d received %c\n"</span>,
    id, n)
  }
}

func channelClose() {
  c := make(chan int, 3) // &#26377;3&#20010;&#32531;&#20914;
  go worker(0, c)
  c &lt;- <span style="color: #8b2252;">'a'</span>
  c &lt;- <span style="color: #8b2252;">'b'</span>
  c &lt;- <span style="color: #8b2252;">'c'</span>
  c &lt;- <span style="color: #8b2252;">'d'</span>
  close(c) // &#21578;&#35785;&#25509;&#25910;&#26041;&#25968;&#25454;&#21457;&#23436;&#20102;
  time.Sleep(time.Millisecond)
}

func main() {
  channelClose()
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc9d339a" class="outline-5">
<h5 id="orgc9d339a">小结channel语法</h5>
<div class="outline-text-5" id="text-orgc9d339a">
<ul class="org-ul">
<li>channel</li>
<li>buffered channel</li>
<li>range
channel可以close，注意一定是发送方close。接收方有2种判断方法</li>
<li>理论基础：Communication Sequential Process(CSP)模式</li>
</ul>

<p>
channel的实际应用
</p>
<ul class="org-ul">
<li>Don't communicate by sharing memory; share memory by communicating.</li>
<li>不要通过共享内存来通信；通过通信来共享内存</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org9de6af9" class="outline-3">
<h3 id="org9de6af9">使用Channel等待任务结束</h3>
<div class="outline-text-3" id="text-org9de6af9">
<p>
基于CSP，通过通信来共享内
</p>

<p>
范例：channel等待任务结束
</p>
<div class="org-src-container">
<pre class="src src-sh">// &#21019;&#24314;channel/done/done.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
)

func doWorker(id int, c chan int, done chan bool) {
  <span style="color: #a020f0;">for</span> n := range c {
    fmt.Printf(<span style="color: #8b2252;">"worker %d received %c\n"</span>,
      id, n)
    // &#36890;&#30693;&#22806;&#37096;&#25171;&#21360;&#23436;&#27605;&#65292;&#36890;&#36807;&#36890;&#20449;&#20849;&#20139;&#20869;&#23384;
    <span style="color: #a020f0;">done</span> &lt;- true
  }
}

<span style="color: #483d8b;">type</span> worker struct { // &#21253;&#35013;&#19968;&#19979;2&#20010;channel
  <span style="color: #a020f0;">in</span>   chan int
  <span style="color: #a020f0;">done</span> chan bool
}

func createWorker(id int) worker {
  w := worker{
    <span style="color: #a020f0;">in</span>:   make(chan int),
    <span style="color: #a020f0;">done</span>: make(chan bool),
  }
  go doWorker(id, w.in, w.done)
  <span style="color: #a020f0;">return</span> w
}

func chanDemo() {
  var workers [10]worker    //
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ { // &#24320;10&#20010;work&#25509;&#25910;channel&#25968;&#25454;
    workers[i] = createWorker(i)
  }

  // &#21521;10&#20010;channel&#21457;&#25968;&#25454;
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ {
    workers[i].in &lt;- <span style="color: #8b2252;">'a'</span> + i
    &lt;-workers[i].done
  }
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ {
    workers[i].in &lt;- <span style="color: #8b2252;">'A'</span> + i
    &lt;-workers[i].done
  }

}

func main() {
  chanDemo()
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#65292;&#20026;&#26377;&#39034;&#24207;&#25171;&#21360;</span>
PS D:\project\learngo&gt; go run .\channel\done\done.go
worker 0 received a
worker 1 received b
worker 2 received c
worker 3 received d
worker 4 received e
worker 5 received f
worker 6 received g
worker 7 received h
worker 8 received i
worker 9 received j
worker 0 received A
worker 1 received B
worker 2 received C
worker 3 received D
worker 4 received E
worker 5 received F
worker 6 received G
worker 7 received H
worker 8 received I
worker 9 received J
</pre>
</div>
<p>
上面代码示例是顺序打印的，不是我们要的，这不是并发执行，一个个打不就行了？
不希望发一个就等待channel结束，要等待全部结束再main函数中退出来
</p>

<p>
修改，去掉sleep
</p>
<div class="org-src-container">
<pre class="src src-sh">// channel/done/done.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
)

func doWorker(id int, c chan int, done chan bool) {
  <span style="color: #a020f0;">for</span> n := range c {
    fmt.Printf(<span style="color: #8b2252;">"worker %d received %c\n"</span>,
      id, n)
    // &#36890;&#30693;&#22806;&#37096;&#25171;&#21360;&#23436;&#27605;&#65292;&#36890;&#36807;&#36890;&#20449;&#20849;&#20139;&#20869;&#23384;
    go func() { <span style="color: #a020f0;">done</span> &lt;- true }() // &#24182;&#34892;&#30340;done
  }
}

<span style="color: #483d8b;">type</span> worker struct { // &#21253;&#35013;&#19968;&#19979;2&#20010;channel
  <span style="color: #a020f0;">in</span>   chan int
  <span style="color: #a020f0;">done</span> chan bool
}

func createWorker(id int) worker {
  w := worker{
    <span style="color: #a020f0;">in</span>:   make(chan int),
    <span style="color: #a020f0;">done</span>: make(chan bool),
  }
  go doWorker(id, w.in, w.done)
  <span style="color: #a020f0;">return</span> w
}

func chanDemo() {
  var workers [10]worker    //
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ { // &#24320;10&#20010;work&#25509;&#25910;channel&#25968;&#25454;
    workers[i] = createWorker(i)
  }

  // &#21521;10&#20010;channels[i]&#21457;&#25968;&#25454;
  <span style="color: #a020f0;">for</span> i, worker := range workers {
    worker.in &lt;- <span style="color: #8b2252;">'a'</span> + i
  }
  <span style="color: #a020f0;">for</span> i, worker := range workers {
    worker.in &lt;- <span style="color: #8b2252;">'A'</span> + i
  }

  // &#31561;&#24453;&#25152;&#26377;
  <span style="color: #a020f0;">for</span> _, worker := range workers {
    &lt;-worker.done
    &lt;-worker.done
  }
}

func main() {
  chanDemo()
}
</pre>
</div>


<ul class="org-ul">
<li>以及WaitGroup的使用</li>
</ul>
</div>
<div id="outline-container-org4750d8a" class="outline-4">
<h4 id="org4750d8a">使用WaitGroup等待多人完成任务</h4>
<div class="outline-text-4" id="text-org4750d8a">
<p>
范例：使用WaitGroup等待多人完成任务
</p>
<div class="org-src-container">
<pre class="src src-sh">// channel/done/done.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"sync"</span>
)

func doWorker(
  id int, c chan int, wg *sync.WaitGroup) {
  <span style="color: #a020f0;">for</span> n := range c {
    fmt.Printf(<span style="color: #8b2252;">"worker %d received %c\n"</span>,
      id, n)
    // &#36890;&#30693;&#22806;&#37096;&#25171;&#21360;&#23436;&#27605;&#65292;&#36890;&#36807;&#36890;&#20449;&#20849;&#20139;&#20869;&#23384;
    wg.Done()
  }
}

<span style="color: #483d8b;">type</span> worker struct { // &#21253;&#35013;&#19968;&#19979;2&#20010;channel
  <span style="color: #a020f0;">in</span> chan int
  wg *sync.WaitGroup // &#20351;&#29992;wg
}

func createWorker(
  id int, wg *sync.WaitGroup) worker {
  w := worker{
    <span style="color: #a020f0;">in</span>: make(chan int),
    wg: wg,
  }
  go doWorker(id, w.in, wg)
  <span style="color: #a020f0;">return</span> w
}

func chanDemo() {
  var wg sync.WaitGroup
  var workers [10]worker    //
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ { // &#24320;10&#20010;work&#25509;&#25910;channel&#25968;&#25454;
    workers[i] = createWorker(i, &amp;wg)
  }

  // &#21521;10&#20010;channels[i]&#21457;&#25968;&#25454;
  <span style="color: #a020f0;">for</span> i, worker := range workers {
    worker.in &lt;- <span style="color: #8b2252;">'a'</span> + i
    wg.Add(1)
  }
  <span style="color: #a020f0;">for</span> i, worker := range workers {
    worker.in &lt;- <span style="color: #8b2252;">'A'</span> + i
    wg.Add(1)
  }

  // &#31561;&#24453;&#25152;&#26377;
  wg.Wait()
}

func main() {
  chanDemo()
}
</pre>
</div>

<p>
包装一下waitgroup，抽象程度更高了一点
</p>
<div class="org-src-container">
<pre class="src src-sh">// channel/done/done.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"sync"</span>
)

func doWorker(
  id int, w worker) {
  <span style="color: #a020f0;">for</span> n := range w.in {
    fmt.Printf(<span style="color: #8b2252;">"worker %d received %c\n"</span>,
      id, n)
    // &#36890;&#30693;&#22806;&#37096;&#25171;&#21360;&#23436;&#27605;&#65292;&#36890;&#36807;&#36890;&#20449;&#20849;&#20139;&#20869;&#23384;
    w.done()
  }
}

<span style="color: #483d8b;">type</span> worker struct { // &#21253;&#35013;&#19968;&#19979;2&#20010;channel
  <span style="color: #a020f0;">in</span>   chan int
  <span style="color: #a020f0;">done</span> func() // waitgroup&#21253;&#35013;&#25104;&#20989;&#25968;
}

func createWorker(
  id int, wg *sync.WaitGroup) worker {
  w := worker{
    <span style="color: #a020f0;">in</span>:   make(chan int),
    <span style="color: #a020f0;">done</span>: func() { wg.Done() },
  }
  go doWorker(id, w)
  <span style="color: #a020f0;">return</span> w
}

func chanDemo() {
  var wg sync.WaitGroup
  var workers [10]worker    //
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 10; i++ { // &#24320;10&#20010;work&#25509;&#25910;channel&#25968;&#25454;
    workers[i] = createWorker(i, &amp;wg)
  }

  // &#21521;10&#20010;channels[i]&#21457;&#25968;&#25454;
  wg.Add(20)
  <span style="color: #a020f0;">for</span> i, worker := range workers {
    worker.in &lt;- <span style="color: #8b2252;">'a'</span> + i
  }
  <span style="color: #a020f0;">for</span> i, worker := range workers {
    worker.in &lt;- <span style="color: #8b2252;">'A'</span> + i
  }

  // &#31561;&#24453;&#25152;&#26377;
  wg.Wait()
}

func main() {
  chanDemo()
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org2f3871f" class="outline-3">
<h3 id="org2f3871f">使用Channel进行树的遍历</h3>
<div class="outline-text-3" id="text-org2f3871f">
<p>
使用channel显示更序列化一些
范例：使用Channel进行树的遍历
使用
</p>
<div class="org-src-container">
<pre class="src src-sh">// &#20462;&#25913; tree/treentry/entry.go
func main() {
...

  // channel&#65292;&#32479;&#35745;&#26368;&#22823;&#30340;&#33410;&#28857;&#26641;
  c := root.TraversWithChannel()
  maxNode := 0
  <span style="color: #a020f0;">for</span> node := range c {
    <span style="color: #a020f0;">if</span> node.Value &gt; maxNode {
      maxNode = node.Value
    }
  }
  fmt.Println(<span style="color: #8b2252;">"Max node value:"</span>, maxNode)
}
</pre>
</div>

<p>
实现
</p>
<div class="org-src-container">
<pre class="src src-sh">// &#20462;&#25913;&#28155;&#21152; tree/traversal.go

<span style="color: #0000ff;">func</span> (node *Node) TraversWithChannel() chan *Node {
  out := make(chan *Node)
  go func() {
    node.TraverseFunc(func(n *Node) {
      out &lt;- n
    })
    close(out)
  }()
  <span style="color: #a020f0;">return</span> out
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org89d421f" class="outline-3">
<h3 id="org89d421f">使用Select来进行调度</h3>
<div class="outline-text-3" id="text-org89d421f">
<p>
范例：非阻塞式channel 选择select defautl
</p>
<div class="org-src-container">
<pre class="src src-sh">// &#21019;&#24314;select/select.go

package main

import <span style="color: #8b2252;">"fmt"</span>

func main() {
  var c1, c2 chan int // c1 and c2 == nil
  // &#21516;&#26102;&#25910;&#65292;&#35841;&#25910;&#30340;&#24555;&#35201;&#35841;
  <span style="color: #a020f0;">select</span> {  // channel&#20540;&#20026;nil&#65292; &#22312;select&#20013;&#26159;&#25343;&#19981;&#21040;&#25968;&#25454;&#30340;&#65292;&#20250;&#36208;default&#65292; &#36825;&#26159;&#19968;&#20010;&#38750;&#38459;&#22622;&#24335;&#30340;channel
  <span style="color: #a020f0;">case</span> n := &lt;-c1:
    fmt.Println(<span style="color: #8b2252;">"Received from c1:"</span>, n)
  <span style="color: #a020f0;">case</span> n := &lt;-c2:
    fmt.Println(<span style="color: #8b2252;">"Received from c2:"</span>, n)
  default:
    fmt.Println(<span style="color: #8b2252;">"No value received"</span>) // No value received
  }
}
</pre>
</div>

<p>
将从channel接收来的数据送给channel
</p>
<div class="org-src-container">
<pre class="src src-sh">// channel/select/select.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"math/rand"</span>
  <span style="color: #8b2252;">"time"</span>
)

func generator() chan int { // &#29983;&#25104;channel&#25968;&#25454;
  out := make(chan int)
  go func() {
    i := 0
    <span style="color: #a020f0;">for</span> {
      time.Sleep(time.Duration(rand.Intn(1500)) * time.Millisecond)
      out &lt;- i
      i++
    }
  }()
  <span style="color: #a020f0;">return</span> out
}

func worker(id int, c chan int) {
  <span style="color: #a020f0;">for</span> n := range c { // &#21028;&#26029;channel&#26159;&#21542;&#26377;&#25968;&#25454;&#26041;&#27861;2
    fmt.Printf(<span style="color: #8b2252;">"worker %d received %d\n"</span>,
      id, n)
  }
}

func createWorker(id int) chan&lt;- int { // &#21578;&#30693;channel&#26159;&#21521;channel&#21457;&#25968;&#25454;&#30340;
  c := make(chan int)
  go worker(id, c)
  <span style="color: #a020f0;">return</span> c
}

func main() {
  var c1, c2 = generator(), generator()
  // &#21516;&#26102;&#25910;&#65292;&#35841;&#25910;&#30340;&#24555;&#35201;&#35841;
  // &#23558;&#25910;&#36807;&#26469;&#30340; c &#36865;&#32473; worker
  var worker = createWorker(0)
  n := 0
  haseValue := false // &#21578;&#35785;&#26159;&#21542;&#26377;&#20540;
  <span style="color: #a020f0;">for</span> {
    var activeWorker chan&lt;- int
    <span style="color: #a020f0;">if</span> haseValue {  // &#26377;&#20540;&#26102;&#65292;&#23558;activeWorker&#28608;&#27963;
      activeWorker = worker
    }

    <span style="color: #a020f0;">select</span> {
    <span style="color: #a020f0;">case</span> n = &lt;-c1: // &#25910;&#25968;&#65292; &#20294;&#19981;&#24076;&#26395;&#25910;&#19968;&#20010;&#25968;&#25454;&#20877;&#36865;&#32473;channel&#34987;&#38459;&#22622;&#20303; w &lt;- n
      haseValue = true //&#25910;&#21040;&#20540;&#65292;haseValue&#20026;true
    <span style="color: #a020f0;">case</span> n = &lt;-c2:
      haseValue = true
    <span style="color: #a020f0;">case</span> activeWorker &lt;- n: // &#21457;&#25968;&#25454;, nil&#30340;chanel&#20250;&#34987;&#38459;&#22622;&#21040;
      haseValue = false  // &#21457;&#36865;&#23436; haseValue&#21464;&#20026;fasle
    }
  }
  // time.Sleep()
}
</pre>
</div>
<p>
上面代码有一个问题：生成数据的channel和消耗数据的channel的速度是不一样的
如果生成的数据太快了，中间有些数据会冲掉
</p>

<p>
将收到数据排队，之后再让别人消耗它
</p>
<div class="org-src-container">
<pre class="src src-sh">// channel/select/select.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"math/rand"</span>
  <span style="color: #8b2252;">"time"</span>
)

func generator() chan int { // &#29983;&#25104;channel&#25968;&#25454;
  out := make(chan int)
  go func() {
    i := 0
    <span style="color: #a020f0;">for</span> {
      time.Sleep(time.Duration(rand.Intn(1500)) * time.Millisecond)
      out &lt;- i
      i++
    }
  }()
  <span style="color: #a020f0;">return</span> out
}

func worker(id int, c chan int) {
  <span style="color: #a020f0;">for</span> n := range c { // &#21028;&#26029;channel&#26159;&#21542;&#26377;&#25968;&#25454;&#26041;&#27861;2
    time.Sleep(1 * time.Second) // &#31561;&#24453;5&#31186;
    fmt.Printf(<span style="color: #8b2252;">"worker %d received %d\n"</span>,
      id, n)
  }
}

func createWorker(id int) chan&lt;- int { // &#21578;&#30693;channel&#26159;&#21521;channel&#21457;&#25968;&#25454;&#30340;
  c := make(chan int)
  go worker(id, c)
  <span style="color: #a020f0;">return</span> c
}

func main() {
  var c1, c2 = generator(), generator()
  // &#21516;&#26102;&#25910;&#65292;&#35841;&#25910;&#30340;&#24555;&#35201;&#35841;
  // &#23558;&#25910;&#36807;&#26469;&#30340; c &#36865;&#32473; worker
  var worker = createWorker(0)

  // &#23558;&#25910;&#21040;&#25968;&#25454;&#25490;&#38431;&#65292;&#20043;&#21518;&#20877;&#35753;&#21035;&#20154;&#28040;&#32791;&#23427;
  var values  []int

  <span style="color: #a020f0;">for</span> {
    var activeWorker chan&lt;- int
    var activeValue int
    <span style="color: #a020f0;">if</span> len(values)  &gt;0 {  // &#26377;&#20540;&#26102;&#65292;&#23558;activeWorker&#28608;&#27963;
      activeWorker = worker
      activeValue = values[0]
    }

    <span style="color: #a020f0;">select</span> {
    <span style="color: #a020f0;">case</span> n := &lt;-c1: // &#25910;&#25968;&#65292; &#20294;&#19981;&#24076;&#26395;&#25910;&#19968;&#20010;&#25968;&#25454;&#20877;&#36865;&#32473;channel&#34987;&#38459;&#22622;&#20303; w &lt;- n
      values = append(values, n)
    <span style="color: #a020f0;">case</span> n := &lt;-c2:
      values = append(values, n)
    <span style="color: #a020f0;">case</span> activeWorker &lt;- activeValue: // &#21457;&#25968;&#25454;, nil&#30340;chanel&#20250;&#34987;&#38459;&#22622;&#21040;
      values = values[1:]
    }
  }
  // time.Sleep()

}
</pre>
</div>

<p>
计时器的使用
</p>
<div class="org-src-container">
<pre class="src src-sh">// channel/select/select.go
package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"math/rand"</span>
  <span style="color: #8b2252;">"time"</span>
)

func generator() chan int { // &#29983;&#25104;channel&#25968;&#25454;
  out := make(chan int)
  go func() {
    i := 0
    <span style="color: #a020f0;">for</span> {
      time.Sleep(time.Duration(rand.Intn(1500)) * time.Millisecond)
      out &lt;- i
      i++
    }
  }()
  <span style="color: #a020f0;">return</span> out
}

func worker(id int, c chan int) {
  <span style="color: #a020f0;">for</span> n := range c { // &#21028;&#26029;channel&#26159;&#21542;&#26377;&#25968;&#25454;&#26041;&#27861;2
    time.Sleep(1 * time.Second) // &#31561;&#24453;5&#31186;
    fmt.Printf(<span style="color: #8b2252;">"worker %d received %d\n"</span>,
      id, n)
  }
}

func createWorker(id int) chan&lt;- int { // &#21578;&#30693;channel&#26159;&#21521;channel&#21457;&#25968;&#25454;&#30340;
  c := make(chan int)
  go worker(id, c)
  <span style="color: #a020f0;">return</span> c
}

func main() {
  var c1, c2 = generator(), generator()
  // &#21516;&#26102;&#25910;&#65292;&#35841;&#25910;&#30340;&#24555;&#35201;&#35841;
  // &#23558;&#25910;&#36807;&#26469;&#30340; c &#36865;&#32473; worker
  var worker = createWorker(0)

  // &#23558;&#25910;&#21040;&#25968;&#25454;&#25490;&#38431;&#65292;&#20043;&#21518;&#20877;&#35753;&#21035;&#20154;&#28040;&#32791;&#23427;
  var values  []int
  tm := time.After(10 * time.Second)
  tick := time.Tick(time.Second) // &#23450;&#26102;&#21151;&#33021;&#12290;&#36825;&#37324;&#26159;&#27599;&#31186;&#31181;&#36865;&#19968;&#20010;&#20540;
  <span style="color: #a020f0;">for</span> {
    var activeWorker chan&lt;- int
    var activeValue int
    <span style="color: #a020f0;">if</span> len(values)  &gt;0 {  // &#26377;&#20540;&#26102;&#65292;&#23558;activeWorker&#28608;&#27963;
      activeWorker = worker
      activeValue = values[0]
    }

    <span style="color: #a020f0;">select</span> {
    <span style="color: #a020f0;">case</span> n := &lt;-c1: // &#25910;&#25968;&#65292; &#20294;&#19981;&#24076;&#26395;&#25910;&#19968;&#20010;&#25968;&#25454;&#20877;&#36865;&#32473;channel&#34987;&#38459;&#22622;&#20303; w &lt;- n
      values = append(values, n)
    <span style="color: #a020f0;">case</span> n := &lt;-c2:
      values = append(values, n)
    <span style="color: #a020f0;">case</span> activeWorker &lt;- activeValue: // &#21457;&#25968;&#25454;, nil&#30340;chanel&#20250;&#34987;&#38459;&#22622;&#21040;
      values = values[1:]
    <span style="color: #a020f0;">case</span> &lt;- time.After(800 * time.Millisecond): // 800&#27627;&#31186;&#38388;&#27809;&#26377;&#25968;&#25454;&#25171;&#21360;timeout
      fmt.Println(<span style="color: #8b2252;">"timeout"</span>)
    <span style="color: #a020f0;">case</span> &lt;- tick: // &#23450;&#26102;&#22120;&#65292;&#27599;&#38548;1&#31186;&#25171;&#21360;value&#30340;&#38271;&#24230;
      fmt.Println(<span style="color: #8b2252;">"queue len="</span>, len(values))
    <span style="color: #a020f0;">case</span> &lt;-tm:    // 10 &#31186;&#21518;&#32467;&#26463;
      fmt.Println(<span style="color: #8b2252;">"bye"</span>)
      <span style="color: #a020f0;">return</span>
    }
  }
  // time.Sleep()

}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;</span>
PS D:\project\learngo&gt; go run .\channel\select\select.go
queue <span style="color: #a0522d;">len</span>= 3
worker 0 received 0
queue <span style="color: #a0522d;">len</span>= 5
worker 0 received 0
queue <span style="color: #a0522d;">len</span>= 5
worker 0 received 1
queue <span style="color: #a0522d;">len</span>= 10
worker 0 received 1
queue <span style="color: #a0522d;">len</span>= 10
worker 0 received 2
queue <span style="color: #a0522d;">len</span>= 11
worker 0 received 2
queue <span style="color: #a0522d;">len</span>= 12
worker 0 received 3
queue <span style="color: #a0522d;">len</span>= 13
worker 0 received 3
queue <span style="color: #a0522d;">len</span>= 14
worker 0 received 4
<span style="color: #a020f0;">bye</span>
</pre>
</div>
</div>
<div id="outline-container-org4adf405" class="outline-4">
<h4 id="org4adf405">select小结</h4>
<div class="outline-text-4" id="text-org4adf405">
<ul class="org-ul">
<li>select的使用</li>
<li>定时器的使用
3种定时器的使用方法</li>
<li>在select中使用Nil Channel
channel数据还没有准备好时，select就不会执行。</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org2d67654" class="outline-3">
<h3 id="org2d67654">传统同步机制</h3>
<div class="outline-text-3" id="text-org2d67654">
<ul class="org-ul">
<li>WaitGroup
虽然里面是channel实现的，但看起来像传统的同步机制</li>
<li>Mutex
互斥量</li>
<li><p>
Cond
用法类似
</p>

<p>
一般使用channel通信
</p></li>
</ul>
</div>
<div id="outline-container-orgb689b65" class="outline-4">
<h4 id="orgb689b65">Mutex互斥量的使用</h4>
<div class="outline-text-4" id="text-orgb689b65">
<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">// basic/atomic/atomic.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"time"</span>
)

// &#23454;&#29616;atomic int
<span style="color: #483d8b;">type</span> atomicInt int

<span style="color: #0000ff;">func</span> (a *atomicInt) increment() { // &#33258;&#22686;&#38271;&#21151;&#33021;
  *a++
}

<span style="color: #0000ff;">func</span> (a *atomicInt) get() int {
  <span style="color: #a020f0;">return</span> int(*a)
}

func main() {
  // atomic.AddInt32() &#31995;&#32479;&#20013;&#33258;&#24102;&#21407;&#23376;&#21270;&#30340;int&#65292;&#32447;&#31243;&#23433;&#20840;&#30340;
  var a atomicInt
  a.increment()
  go func() {
    a.increment()
  }()
  time.Sleep(time.Millisecond)
  fmt.Println(a)
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986; -race &#25171;&#21040;&#25968;&#25454;&#20914;&#31361;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">27&#34892;&#35835;fmt.Println(a) &#21644; 12&#34892;&#20889;*a++&#26377;&#20914;&#31361;&#65292;</span>
PS D:\project\learngo&gt; go  run -race .\basic\atomic\atomic.go
==================
WARNING: DATA RACE
Read at 0x00c0000ac078 by main goroutine:
  main.main()
      D:/project/learngo/basic/atomic/atomic.go:27 +0xee

Previous write at 0x00c0000ac078 by goroutine 7:
  main.(*atomicInt).increment()
      D:/project/learngo/basic/atomic/atomic.go:12 +0x45
  main.main.func1()
      D:/project/learngo/basic/atomic/atomic.go:24 +0x2e
</pre>
</div>

<p>
加锁
</p>
<div class="org-src-container">
<pre class="src src-sh">// basic/atomic/atomic.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"sync"</span>
  <span style="color: #8b2252;">"time"</span>
)

// &#23454;&#29616;atomic int
<span style="color: #483d8b;">type</span> atomicInt struct {
  value int
  lock sync.Mutex  // &#38145;
}

<span style="color: #0000ff;">func</span> (a *atomicInt) increment() { // &#33258;&#22686;&#38271;&#21151;&#33021;
  // &#38145;&#26469;&#20445;&#25252;
  a.lock.Lock()
  defer a.lock.Unlock()
  a.value++
}

<span style="color: #0000ff;">func</span> (a *atomicInt) get() int {
  a.lock.Lock()
  defer a.lock.Unlock()
  <span style="color: #a020f0;">return</span> int(a.value)
}

func main() {
  // atomic.AddInt32() &#31995;&#32479;&#20013;&#33258;&#24102;&#21407;&#23376;&#21270;&#30340;int&#65292;&#32447;&#31243;&#23433;&#20840;&#30340;
  var a atomicInt
  a.increment()
  go func() {
    a.increment()
  }()
  time.Sleep(time.Millisecond)
  fmt.Println(a.get())
}


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986; -race &#27809;&#26377;&#25968;&#25454;&#20914;&#31361;&#20102;</span>
PS D:\project\learngo&gt; go  run -race .\basic\atomic\atomic.go
2
</pre>
</div>
<p>
真正用时还得用系统自带的原子化操作。
</p>

<p>
代码区中锁保护：使用匿名函数
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">func</span> (a *atomicInt) increment() { // &#33258;&#22686;&#38271;&#21151;&#33021;
  // &#22312;&#19968;&#27573;&#20195;&#30721;&#21306;&#65292;&#38145;&#26469;&#20445;&#25252;.
  func() { // &#20351;&#29992;&#21311;&#21517;&#20989;&#25968;
    a.lock.Lock()
    defer a.lock.Unlock()
    a.value++
  }()
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgddba14a" class="outline-3">
<h3 id="orgddba14a">并发模式</h3>
<div class="outline-text-3" id="text-orgddba14a">
<p>
从应用的角度解决类型的问题
</p>
</div>
<div id="outline-container-org0a55a0a" class="outline-4">
<h4 id="org0a55a0a">channel可以做一个生成器</h4>
<div class="outline-text-4" id="text-org0a55a0a">
<p>
范例：channel做一个生成器
框架
</p>
<div class="org-src-container">
<pre class="src src-sh">// channel/pattern/main.go

package main

import <span style="color: #8b2252;">"fmt"</span>

func msgGen() chan string {
  c := make(chan string)
  go func() { // &#22312;goroutine&#20013;&#36865;&#25968;&#25454;

  }()
  <span style="color: #a020f0;">return</span> c
}

func main() {
  m := msgGen() // &#29983;&#25104;&#28040;&#24687;
  <span style="color: #a020f0;">for</span> {  // &#19981;&#26029;&#33719;&#21462;&#28040;&#24687;
    fmt.Println(&lt;-m)
  }
}
</pre>
</div>
<p>
代码内容
</p>
<div class="org-src-container">
<pre class="src src-sh">// channel/pattern/main.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"math/rand"</span>
  <span style="color: #8b2252;">"time"</span>
)

func msgGen() chan string {
  c := make(chan string)
  go func() { // &#22312;goroutine&#20013;&#36865;&#25968;&#25454;
    i := 0
    <span style="color: #a020f0;">for</span> {
      time.Sleep(time.Duration(rand.Intn(2000)) * time.Millisecond)
      c &lt;- fmt.Sprintf(<span style="color: #8b2252;">"message %d"</span>, i)
      i++
    }

  }()
  <span style="color: #a020f0;">return</span> c
}

func main() {
  m1 := msgGen() // &#29983;&#25104;&#28040;&#24687;
  m2 := msgGen()
  <span style="color: #a020f0;">for</span> {         // &#19981;&#26029;&#33719;&#21462;&#28040;&#24687;
    fmt.Println(&lt;-m1)
    fmt.Println(&lt;-m2)
  }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf6c86a6" class="outline-4">
<h4 id="orgf6c86a6">服务/任务</h4>
<div class="outline-text-4" id="text-orgf6c86a6">
<p>
channel也可以看作是一个服务的句柄handle，我们拿着它就可以跟服务去交互。
</p>
<div class="org-src-container">
<pre class="src src-sh">// channel/pattern/main.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"math/rand"</span>
  <span style="color: #8b2252;">"time"</span>
)

func msgGen(name string) chan string {
  c := make(chan string)
  go func() { // &#22312;goroutine&#20013;&#36865;&#25968;&#25454;
    i := 0
    <span style="color: #a020f0;">for</span> {
      time.Sleep(time.Duration(rand.Intn(2000)) * time.Millisecond)
      c &lt;- fmt.Sprintf(<span style="color: #8b2252;">"service %s: message %d"</span>, name, i)
      i++
    }

  }()
  <span style="color: #a020f0;">return</span> c
}

func main() {
  m1 := msgGen(<span style="color: #8b2252;">"service1"</span>) // &#29983;&#25104;&#28040;&#24687;
  m2 := msgGen(<span style="color: #8b2252;">"service2"</span>)
  <span style="color: #a020f0;">for</span> { // &#19981;&#26029;&#33719;&#21462;&#28040;&#24687;
    fmt.Println(&lt;-m1)
    fmt.Println(&lt;-m2)
  }
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;</span>
PS D:\project\learngo&gt; go run -race .\channel\pattern\main.go
service service1: message 0
service service2: message 0
service service1: message 1
service service2: message 1
service service1: message 2
</pre>
</div>
<p>
缺点：需要等待第一个m1服务生成后再等第二m2，这样交替进行。实际上我们希望同时去等待他们。
</p>
</div>
</div>
<div id="outline-container-orgc6c4375" class="outline-4">
<h4 id="orgc6c4375">同时等待多个服务：两种方法</h4>
<div class="outline-text-4" id="text-orgc6c4375">
<p>
同时收到2个服务发的消息：统一收下消息发到第三channel上，再从第三个channel收消息
</p>
</div>
<div id="outline-container-org6ae488f" class="outline-5">
<h5 id="org6ae488f">方法1 不确定有几个服务</h5>
<div class="outline-text-5" id="text-org6ae488f">
<div class="org-src-container">
<pre class="src src-sh">// channel/pattern/main.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"math/rand"</span>
  <span style="color: #8b2252;">"time"</span>
)

func msgGen(name string) chan string {
  c := make(chan string)
  go func() { // &#22312;goroutine&#20013;&#36865;&#25968;&#25454;
    i := 0
    <span style="color: #a020f0;">for</span> {
      time.Sleep(time.Duration(rand.Intn(2000)) * time.Millisecond)
      c &lt;- fmt.Sprintf(<span style="color: #8b2252;">"service %s: message %d"</span>, name, i)
      i++
    }

  }()
  <span style="color: #a020f0;">return</span> c
}

func fanIn(c1, c2 chan string) chan string {
  c := make(chan string)
  // &#20998;&#21035;&#23558;c1 c2 &#25968;&#25454;&#21462;&#20986;&#36865;&#32473;c
  go func() {
    <span style="color: #a020f0;">for</span> {
      c &lt;- &lt;-c1
    }
  }()
  go func() {
    <span style="color: #a020f0;">for</span> {
      c &lt;- &lt;-c2
    }
  }()
  <span style="color: #a020f0;">return</span> c
}

func main() {
  m1 := msgGen(<span style="color: #8b2252;">"service1"</span>) // &#29983;&#25104;&#28040;&#24687;
  m2 := msgGen(<span style="color: #8b2252;">"service2"</span>)
  m := fanIn(m1, m2) // &#21516;&#26102;&#31561;&#24453;&#22810;&#26381;&#21153;&#28040;&#24687;
  <span style="color: #a020f0;">for</span> {              // &#19981;&#26029;&#33719;&#21462;&#28040;&#24687;
    fmt.Println(&lt;-m)
  }
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986; &#35841;&#20808;&#26377;&#25968;&#25454;&#25171;&#21360;&#35841;</span>
PS D:\project\learngo&gt; go run -race .\channel\pattern\main.go
service service1: message 0
service service2: message 0
service service1: message 1
service service2: message 1
service service1: message 2
service service1: message 3
</pre>
</div>

<p>
不确定有几个服务
</p>
<div class="org-src-container">
<pre class="src src-sh">// channel/pattern/main.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"math/rand"</span>
  <span style="color: #8b2252;">"time"</span>
)

func msgGen(name string) chan string {
  c := make(chan string)
  go func() { // &#22312;goroutine&#20013;&#36865;&#25968;&#25454;
    i := 0
    <span style="color: #a020f0;">for</span> {
      time.Sleep(time.Duration(rand.Intn(2000)) * time.Millisecond)
      c &lt;- fmt.Sprintf(<span style="color: #8b2252;">"service %s: message %d"</span>, name, i)
      i++
    }

  }()
  <span style="color: #a020f0;">return</span> c
}

func fanIn(chs ...chan string) chan string {
  c := make(chan string)
  // channel &#24490;&#29615;&#21464;&#37327;&#30340;&#22353;
  // for _, ch := range chs {
  //  go func() {
  //    for {
  //      c &lt;- &lt;-ch // &#38381;&#21253;&#20013; ch &#21464;&#37327; &#24341;&#29992;&#22806;&#32622;&#21464;&#26356;&#26377;&#22353;, ch&#21482;&#26377;range chs&#26368;&#21518;&#19968;&#20010;&#30340;&#20540;
  //    }
  //  }()
  // }

  // &#35299;&#20915;1&#65292; &#25335;&#36125;
  // for _, ch := range chs {
  //  chCopy := ch
  //  go func() {
  //    for {
  //      c &lt;- &lt;-chCopy
  //    }
  //  }()
  // }

  //  &#35299;&#20915;2&#65292;&#20540;&#20256;&#36882;
  <span style="color: #a020f0;">for</span> _, ch := range chs {
    go func(ch chan string) {
      <span style="color: #a020f0;">for</span> {
        c &lt;- &lt;-ch
      }
    }(ch)
  }

  <span style="color: #a020f0;">return</span> c
}

func main() {
  m1 := msgGen(<span style="color: #8b2252;">"service1"</span>) // &#29983;&#25104;&#28040;&#24687;
  m2 := msgGen(<span style="color: #8b2252;">"service2"</span>)
  m := fanIn(m1, m2) // &#21516;&#26102;&#31561;&#24453;&#22810;&#26381;&#21153;&#28040;&#24687;
  <span style="color: #a020f0;">for</span> {              // &#19981;&#26029;&#33719;&#21462;&#28040;&#24687;
    fmt.Println(&lt;-m)
  }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org0313d8a" class="outline-5">
<h5 id="org0313d8a">方法2：select 确定有几个服务</h5>
<div class="outline-text-5" id="text-org0313d8a">
<div class="org-src-container">
<pre class="src src-sh">// channel/pattern/main.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"math/rand"</span>
  <span style="color: #8b2252;">"time"</span>
)

func msgGen(name string) chan string {
  c := make(chan string)
  go func() { // &#22312;goroutine&#20013;&#36865;&#25968;&#25454;
    i := 0
    <span style="color: #a020f0;">for</span> {
      time.Sleep(time.Duration(rand.Intn(2000)) * time.Millisecond)
      c &lt;- fmt.Sprintf(<span style="color: #8b2252;">"service %s: message %d"</span>, name, i)
      i++
    }

  }()
  <span style="color: #a020f0;">return</span> c
}

func fanInBySelect(c1, c2 chan string) chan string {
  c := make(chan string)
  go func() {
    <span style="color: #a020f0;">for</span> {
      <span style="color: #a020f0;">select</span> {
      <span style="color: #a020f0;">case</span> m := &lt;-c1:
        c &lt;- m
      <span style="color: #a020f0;">case</span> m := &lt;-c2:
        c &lt;- m
      }
    }
  }()
  <span style="color: #a020f0;">return</span> c
}

func main() {
  m1 := msgGen(<span style="color: #8b2252;">"service1"</span>) // &#29983;&#25104;&#28040;&#24687;
  m2 := msgGen(<span style="color: #8b2252;">"service2"</span>)
  m := fanInBySelect(m1, m2) // &#21516;&#26102;&#31561;&#24453;&#22810;&#26381;&#21153;&#28040;&#24687;
  <span style="color: #a020f0;">for</span> {              // &#19981;&#26029;&#33719;&#21462;&#28040;&#24687;
    fmt.Println(&lt;-m)
  }
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org076019f" class="outline-4">
<h4 id="org076019f">并发模式小结</h4>
<div class="outline-text-4" id="text-org076019f">
<ul class="org-ul">
<li>channel可以做一个生成器
实践案例：<a href="https://www.imooc.com/learn/927">搭建并行处理管道，感受GO语言魅力</a></li>
<li>服务/任务</li>
<li>同时等待多个服务：两种方法
<ul class="org-ul">
<li>方法1：不确认有几个服务，range 循环变量坑</li>
<li>方法2：知道有几个服务，select</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org644a43e" class="outline-3">
<h3 id="org644a43e">并发任务的控制</h3>
<div class="outline-text-3" id="text-org644a43e">
<ul class="org-ul">
<li>非阻塞等待</li>
<li>超时机制</li>
<li>任务中断/退出</li>
<li>优雅退出</li>
</ul>
</div>
<div id="outline-container-orgb6ca5cc" class="outline-4">
<h4 id="orgb6ca5cc">非阻塞等待</h4>
<div class="outline-text-4" id="text-orgb6ca5cc">
<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">// channel/pattern/main.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"math/rand"</span>
  <span style="color: #8b2252;">"time"</span>
)

func msgGen(name string) chan string {
  c := make(chan string)
  go func() { // &#22312;goroutine&#20013;&#36865;&#25968;&#25454;
    i := 0
    <span style="color: #a020f0;">for</span> {
      time.Sleep(time.Duration(rand.Intn(2000)) * time.Millisecond)
      c &lt;- fmt.Sprintf(<span style="color: #8b2252;">"service %s: message %d"</span>, name, i)
      i++
    }

  }()
  <span style="color: #a020f0;">return</span> c
}

func nonBlockingWait(c chan string) (string, bool) {
  <span style="color: #a020f0;">select</span> {
  <span style="color: #a020f0;">case</span> m := &lt;-c:
    <span style="color: #a020f0;">return</span> m, true
  default:
    <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">""</span>, false
  }
}

func main() {
  m1 := msgGen(<span style="color: #8b2252;">"service1"</span>) // &#29983;&#25104;&#28040;&#24687;
  m2 := msgGen(<span style="color: #8b2252;">"service2"</span>)
  <span style="color: #a020f0;">for</span> {
    fmt.Println(&lt;-m1)
    <span style="color: #a020f0;">if</span> m, ok := nonBlockingWait(m2); ok {
      fmt.Println(m)
    } <span style="color: #a020f0;">else</span> {
      fmt.Println(<span style="color: #8b2252;">"no message from service2"</span>)
    }
  }
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;</span>
PS D:\project\learngo&gt; go run -race .\channel\pattern\main.go
service service1: message 0
no message from service2
service service1: message 1
service service2: message 0
</pre>
</div>
</div>
</div>
<div id="outline-container-org4229ccf" class="outline-4">
<h4 id="org4229ccf">超时机制</h4>
<div class="outline-text-4" id="text-org4229ccf">
<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">// channel/pattern/main.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"math/rand"</span>
  <span style="color: #8b2252;">"time"</span>
)

func msgGen(name string) chan string {
  c := make(chan string)
  go func() { // &#22312;goroutine&#20013;&#36865;&#25968;&#25454;
    i := 0
    <span style="color: #a020f0;">for</span> {
      time.Sleep(time.Duration(rand.Intn(5000)) * time.Millisecond)
      c &lt;- fmt.Sprintf(<span style="color: #8b2252;">"service %s: message %d"</span>, name, i)
      i++
    }

  }()
  <span style="color: #a020f0;">return</span> c
}

func timeoutWait(c chan string, timeout time.Duration) (string, bool) {
  <span style="color: #a020f0;">select</span> {
  <span style="color: #a020f0;">case</span> m := &lt;-c:
    <span style="color: #a020f0;">return</span> m, true
  <span style="color: #a020f0;">case</span> &lt;-time.After(timeout):
    <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">""</span>, false
  }
}

func main() {
  m1 := msgGen(<span style="color: #8b2252;">"service1"</span>) // &#29983;&#25104;&#28040;&#24687;
  <span style="color: #a020f0;">for</span> {
    <span style="color: #a020f0;">if</span> m, ok := timeoutWait(m1, 2 * time.Second); ok {
      fmt.Println(m)
    } <span style="color: #a020f0;">else</span> {
      fmt.Println(<span style="color: #8b2252;">"no message from service2"</span>)
    }
  }
}


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;</span>
PS D:\project\learngo&gt; go run -race .\channel\pattern\main.go
no message from service2
service service1: message 0
no message from service2
service service1: message 1
</pre>
</div>
</div>
</div>
<div id="outline-container-org28d57ed" class="outline-4">
<h4 id="org28d57ed">任务中断/退出</h4>
<div class="outline-text-4" id="text-org28d57ed">
<p>
知道退出了
`done chan bool` 和`done chan struct{}` 都可以，struct{}比bool更省空间
</p>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">// channel/pattern/main.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"math/rand"</span>
  <span style="color: #8b2252;">"time"</span>
)

func msgGen(name string, done chan struct{}) chan string { //  done chan bool &#21644; done chan struct{} &#37117;&#21487;&#20197;&#65292;struct{}&#27604;bool&#26356;&#30465;&#31354;&#38388;
  c := make(chan string)
  go func() { // &#22312;goroutine&#20013;&#36865;&#25968;&#25454;
    i := 0
    <span style="color: #a020f0;">for</span> {
      <span style="color: #a020f0;">select</span> {
      <span style="color: #a020f0;">case</span> &lt;- time.After(time.Duration(rand.Intn(5000)) * time.Millisecond):  // 5&#31186;&#21518;&#27809;&#26377;&#25910;&#21040;done&#30340;&#25968;&#25454;&#23601;&#20135;&#29983;&#19968;&#26465;&#25968;&#25454;
        c &lt;- fmt.Sprintf(<span style="color: #8b2252;">"service %s: message %d"</span>, name, i)
      <span style="color: #a020f0;">case</span> &lt;-done:
        fmt.Println(<span style="color: #8b2252;">"cleaning up"</span>)
        <span style="color: #a020f0;">return</span>
      }
      i++
    }
  }()
  <span style="color: #a020f0;">return</span> c
}

func timeoutWait(c chan string, timeout time.Duration) (string, bool) {
  <span style="color: #a020f0;">select</span> {
  <span style="color: #a020f0;">case</span> m := &lt;-c:
    <span style="color: #a020f0;">return</span> m, true
  <span style="color: #a020f0;">case</span> &lt;-time.After(timeout):
    <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">""</span>, false
  }
}

func main() {
  <span style="color: #a020f0;">done</span> := make(chan struct{})
  m1 := msgGen(<span style="color: #8b2252;">"service1"</span>, done) // &#29983;&#25104;&#28040;&#24687;
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 5; i++ {
    <span style="color: #a020f0;">if</span> m, ok := timeoutWait(m1, time.Second); ok {
      fmt.Println(m)
    } <span style="color: #a020f0;">else</span> {
      fmt.Println(<span style="color: #8b2252;">"timeout"</span>)
    }
  }
  <span style="color: #a020f0;">done</span> &lt;- struct{}{} // &#36864;&#20986;&#65307;struct{}{}&#34920;&#31034;&#31354;&#30340;struct{}&#32467;&#26500;
  time.Sleep(time.Second)
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;</span>
PS D:\project\learngo&gt; go run -race .\channel\pattern\main.go
timeout
timeout
timeout
service service1: message 0
timeout
cleaning up
</pre>
</div>
</div>
</div>
<div id="outline-container-org5ad0394" class="outline-4">
<h4 id="org5ad0394">优雅退出</h4>
<div class="outline-text-4" id="text-org5ad0394">
<p>
怎么知道清理做完了？有一个channel能告诉我们做完了
</p>
<div class="org-src-container">
<pre class="src src-sh">// channel/pattern/main.go

package main

<span style="color: #0000ff;">import</span> (
  <span style="color: #8b2252;">"fmt"</span>
  <span style="color: #8b2252;">"math/rand"</span>
  <span style="color: #8b2252;">"time"</span>
)

func msgGen(name string, done chan struct{}) chan string { //  done chan bool &#21644; done chan struct{} &#37117;&#21487;&#20197;&#65292;struct{}&#27604;bool&#26356;&#30465;&#31354;&#38388;
  c := make(chan string)
  go func() { // &#22312;goroutine&#20013;&#36865;&#25968;&#25454;
    i := 0
    <span style="color: #a020f0;">for</span> {
      <span style="color: #a020f0;">select</span> {
      <span style="color: #a020f0;">case</span> &lt;- time.After(time.Duration(rand.Intn(5000)) * time.Millisecond):  // 5&#31186;&#21518;&#27809;&#26377;&#25910;&#21040;done&#30340;&#25968;&#25454;&#23601;&#20135;&#29983;&#19968;&#26465;&#25968;&#25454;
        c &lt;- fmt.Sprintf(<span style="color: #8b2252;">"service %s: message %d"</span>, name, i)
      <span style="color: #a020f0;">case</span> &lt;-done:
        fmt.Println(<span style="color: #8b2252;">"cleaning up"</span>)
        time.Sleep(2 * time.Second)
        fmt.Println(<span style="color: #8b2252;">"cleaning done"</span>)
        <span style="color: #a020f0;">done</span> &lt;- struct{}{} // &#21578;&#35785;&#20570;&#23436;&#20102;&#65292;&#22823;&#37096;&#20998;&#19981;&#20250;&#20570;&#25104;&#21452;&#21521;&#30340;
        <span style="color: #a020f0;">return</span>
      }
      i++
    }

  }()
  <span style="color: #a020f0;">return</span> c
}


func timeoutWait(c chan string, timeout time.Duration) (string, bool) {
  <span style="color: #a020f0;">select</span> {
  <span style="color: #a020f0;">case</span> m := &lt;-c:
    <span style="color: #a020f0;">return</span> m, true
  <span style="color: #a020f0;">case</span> &lt;-time.After(timeout):
    <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">""</span>, false
  }
}

func main() {
  <span style="color: #a020f0;">done</span> := make(chan struct{})
  m1 := msgGen(<span style="color: #8b2252;">"service1"</span>, done) // &#29983;&#25104;&#28040;&#24687;
  <span style="color: #a020f0;">for</span> i := 0; i &lt; 5; i++ {
    <span style="color: #a020f0;">if</span> m, ok := timeoutWait(m1, time.Second); ok {
      fmt.Println(m)
    } <span style="color: #a020f0;">else</span> {
      fmt.Println(<span style="color: #8b2252;">"timeout"</span>)
    }
  }
  <span style="color: #a020f0;">done</span> &lt;- struct{}{} // &#36864;&#20986;&#65307;struct{}{}&#34920;&#31034;&#31354;&#30340;struct{}&#32467;&#26500;
  &lt;-done // &#25910;&#20570;&#23436;&#20102;&#30340;&#28040;&#24687;
}


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;</span>
PS D:\project\learngo&gt; go run -race .\channel\pattern\main.go
timeout
timeout
timeout
service service1: message 0
timeout
cleaning up
cleaning done
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-org8c2899d" class="outline-2">
<h2 id="org8c2899d">迷宫实现</h2>
<div class="outline-text-2" id="text-org8c2899d">
</div>
<div id="outline-container-org928efe9" class="outline-3">
<h3 id="org928efe9">迷宫算法-广度优先算法</h3>
<div class="outline-text-3" id="text-org928efe9">
<p>
深度优先算法有可能会绕远路
</p>

<ul class="org-ul">
<li>为爬虫实战项目做好准备</li>
<li>应用广泛，综合性强
涉及语言方面广度比较多，一门语言能够顺利的徒手写出广度优先算法走迷宫，说明已经对这门语言掌握比较熟练了。</li>
<li><p>
面试常见
</p>

<p>
迷宫描述：
</p>
<ul class="org-ul">
<li>6行5列，1代表墙，0代表路，左上角进，右下角出。</li>
<li>规则：上下左右走，不能对角走</li>
<li>算出最短路线</li>
</ul>

<p>
思路：
起点为0，探索上下左右四个方向，发现通过一步能走的格子一共4个。
从起点走2步所能走的格子，不能往回走，从上方逆时针（上左下右90度90度转）探索能走的格子。
</p>
<div class="org-src-container">
<pre class="src src-sh">
   3
  323
 32123
3210123
 32123
  323
   3
</pre>
</div></li>
</ul>
<p>
每个点都有2种状态：
首先是0，发现有这个0但没有探索过的点，探索了那么周围就会有4个1
这个1是已经发现但没有探索过的点，中间的0是我们已经探索过的点
探索上方的1，发现周围有3个2，再探索左面的1，发现有2个2，等1探索完了才轮到2.
因此，每个节点都有：已经发现还未探索、已经发现且探索完成、没发现过，其中
“已经发现还未探索”的点需要排队，等什么时候办到你了再探索，不能直接探索，这
就是广度优先算法，一层一层往外递进，这样能到的点就是最短路径。
</p>

<p>
应用：
</p>
<div class="org-src-container">
<pre class="src src-sh">6 5
0 1 0 0 0
0 0 0 1 0
0 1 0 1 0
1 1 1 0 0
0 1 0 0 1
0 1 0 0 0
</pre>
</div>
<p>
下面是0到5是下标，起点是0步能走到，其它都是未知的。
</p>
<table>


<colgroup>
<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<tbody>
<tr>
<td class="org-right">&#xa0;</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-right">起点0</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">4</td>
<td class="org-right">5</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">7</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">4</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">10</td>
<td class="org-right">9</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">12</td>
<td class="org-right">11</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">13</td>
<td class="org-right">12</td>
<td class="org-right">终点13</td>
</tr>
</tbody>
</table>

<p>
已经发现还没探索过的`(0,0)`放到队列中
</p>
<ul class="org-ul">
<li>探索`(0,0)`，往下是能走的出现一个1，发现点`(1,0)`放进队列中；</li>
<li>探索`(1,0)`，从列队中拿出来，2个2，这俩个节点通过2步能走到，将`(2,0),(1,1)`加入队列</li>
<li>探索`(2,0)`，从列队中拿出来，左右都是墙且不能往回走，因此是条死路</li>
<li>探索`(1,1)`，从列队中拿出来队列空掉了，可以往右走发现1个3，将点`(1,2)`加入队列</li>
<li>探索`(1,2)`，从列队中拿出来队列空掉了，可以往上往下走发现2个4，将`(0,2),(2,2)`加入队列</li>
<li>以此类似推，这条路就被画出来了，从终点倒过来就能画出最短路，13周围只有一个12等等等</li>
</ul>

<p>
广度优先算法结束条件：
</p>
<ul class="org-ul">
<li>到终点结束</li>
<li>走到死路，队列为空结束。</li>
</ul>
</div>
</div>
<div id="outline-container-orgf5b211f" class="outline-3">
<h3 id="orgf5b211f">迷宫代码实现</h3>
<div class="outline-text-3" id="text-orgf5b211f">
<p>
创建迷宫图文件 maze/maze.in
6行5列
</p>
<div class="org-src-container">
<pre class="src src-sh">6 5
0 1 0 0 0
0 0 0 1 0
0 1 0 1 0
1 1 1 0 0
0 1 0 0 1
0 1 0 0 0
</pre>
</div>
<p>
在vscode中，可以修改状态栏右下角的CRLF，改为LF。
</p>
</div>
<div id="outline-container-org556bced" class="outline-4">
<h4 id="org556bced">读进迷宫文件</h4>
<div class="outline-text-4" id="text-org556bced">
<div class="org-src-container">
<pre class="src src-sh">// maze/maze.go

package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"fmt"</span>
    <span style="color: #8b2252;">"os"</span>
)

func readMaze(filename string) [][]int { // &#36820;&#22238;2&#32500;slice
    file, err := os.Open(filename)
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }

    var row, col int
    fmt.Fscanf(file, <span style="color: #8b2252;">"%d %d"</span>, &amp;row, &amp;col) // &#35835;&#36827;&#36855;&#23467;&#34892;&#21644;&#21015;

    maze := make([][]int, row) // &#21019;&#24314;&#36855;&#23467;
    <span style="color: #a020f0;">for</span> i := range maze {
        maze[i] = make([]int, col)
        <span style="color: #a020f0;">for</span> j := range maze[i] {
            fmt.Fscanf(file, <span style="color: #8b2252;">"%d"</span>, &amp;maze[i][j]) // &#27599;&#20010;&#28857;&#22352;&#26631;&#20301;&#32622;
        }
    }
    <span style="color: #a020f0;">return</span> maze
}

func main() {
    m := readMaze(<span style="color: #8b2252;">"maze/maze.in"</span>)
    <span style="color: #a020f0;">for</span> _, row := range m {
        <span style="color: #a020f0;">for</span> _, col := range row {
            fmt.Printf(<span style="color: #8b2252;">"%d "</span>, col)
        }
        fmt.Println()
    }
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;</span>
PS D:\project\learngo&gt; go run -race .\maze\maze.go
0 1 0 0 0
0 0 0 1 0
0 1 0 1 0
1 1 1 0 0
0 1 0 0 1
0 1 0 0 0
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbdf9193" class="outline-4">
<h4 id="orgbdf9193">走迷宫</h4>
<div class="outline-text-4" id="text-orgbdf9193">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">type</span> point struct { // &#36208;&#30340;&#28857;
    i, j int
}

func walk(maze [][]int, start, end point) {

}

<span style="color: #0000ff;">walk</span>(maze, point{0, 0}, point{len(maze) - 1, len(maze[0]) - 1})
</pre>
</div>

<p>
代码：
</p>
<div class="org-src-container">
<pre class="src src-sh">// maze/maze.go

package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"fmt"</span>
    <span style="color: #8b2252;">"os"</span>
)

func readMaze(filename string) [][]int { // &#36820;&#22238;2&#32500;slice
    file, err := os.Open(filename)
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }

    var row, col int
    fmt.Fscanf(file, <span style="color: #8b2252;">"%d %d"</span>, &amp;row, &amp;col) // &#35835;&#36827;&#36855;&#23467;&#34892;&#21644;&#21015;

    maze := make([][]int, row) // &#21019;&#24314;&#36855;&#23467;
    <span style="color: #a020f0;">for</span> i := range maze {
        maze[i] = make([]int, col)
        <span style="color: #a020f0;">for</span> j := range maze[i] {
            fmt.Fscanf(file, <span style="color: #8b2252;">"%d"</span>, &amp;maze[i][j]) // &#27599;&#20010;&#28857;&#22352;&#26631;&#20301;&#32622;
        }
    }
    <span style="color: #a020f0;">return</span> maze
}

<span style="color: #483d8b;">type</span> point struct { // &#36208;&#30340;&#28857;
    i, j int // i &#32437;&#22352;&#26631;&#65292; j &#27178;&#22352;&#26631;
}

var dirs = []point{ // &#23450;&#20041; &#19978;&#24038;&#19979;&#21491;&#26041;&#21521;
    {-1, 0}, {0, -1}, {1, 0}, {0, 1}}

<span style="color: #0000ff;">func</span> (p point) add(r point) point {
    <span style="color: #a020f0;">return</span> point{p.i + r.i, p.j + r.j}
}

<span style="color: #0000ff;">func</span> (p point) at(grid [][]int) (int, bool) { // &#21516;&#26102;&#30475;point&#26377;&#27809;&#26377;&#36234;&#30028;
    <span style="color: #a020f0;">if</span> p.i &lt; 0 || p.i &gt;= len(grid) { // i &#34892;&#26465;&#20214;
        <span style="color: #a020f0;">return</span> 0, false
    }

    <span style="color: #a020f0;">if</span> p.j &lt; 0 || p.j &gt;= len(grid[p.i]) { // j &#21015;&#26465;&#20214;
        <span style="color: #a020f0;">return</span> 0, false
    }

    <span style="color: #a020f0;">return</span> grid[p.i][p.j], true
}

func walk(maze [][]int,
    start, end point) [][]int {
    steps := make([][]int, len(maze))
    <span style="color: #a020f0;">for</span> i := range steps {
        steps[i] = make([]int, len(maze[i]))
    }

    Q := []point{start} // &#36215;&#28857;&#21152;&#36827;&#38431;&#21015;&#20013;

    <span style="color: #a020f0;">for</span> len(Q) &gt; 0 { // &#36864;&#20986;&#26465;&#20214;&#65292;&#38431;&#21015;&#19981;&#31354;&#26102;
        // &#25506;&#32034;&#28857;
        cur := Q[0]
        Q = Q[1:]

        <span style="color: #a020f0;">if</span> cur == end { // &#26159;&#32456;&#28857;&#23601;&#36864;&#20986;
            <span style="color: #a020f0;">break</span>
        }

        <span style="color: #a020f0;">for</span> _, dir := range dirs { // &#19978;&#24038;&#19979;&#21491;&#26041;&#21521;
            next := cur.add(dir) // &#19979;&#19968;&#20010;&#33410;&#28857;&#22352;&#26631;

            // &#25506;&#32034;&#19979;&#19968;&#20010;&#33410;&#28857;&#65292;&#35201;&#20445;&#35777;&#19979;&#19968;&#20010;&#33410;&#28857;&#33021;&#36208;&#36807;&#25165;&#33021;&#25506;&#32034; maze at next is 0
            // &#24182;&#19988;&#20445;&#35777;&#19979;&#19968;&#20010;&#33410;&#28857;step&#20540;&#24471;&#26377; and steps at next is 0
            // &#19981;&#33021;&#22238;&#21040;&#36215;&#28857; and next != start
            val, ok := next.at(maze)
            <span style="color: #a020f0;">if</span> !ok || val == 1 { // &#20540;&#36234;&#30028;&#20102;&#25110;&#32773;&#25758;&#22681;&#20102;&#65292;&#26029;&#32493;&#30475;&#19979;&#19968;&#20010;&#28857;
                <span style="color: #a020f0;">continue</span>
            }

            val, ok = next.at(steps)
            <span style="color: #a020f0;">if</span> !ok || val != 0 {
                <span style="color: #a020f0;">continue</span>
            }

            <span style="color: #a020f0;">if</span> next == start {
                <span style="color: #a020f0;">continue</span>
            }

            curSteps, _ := cur.at(steps)
            steps[next.i][next.j] = curSteps + 1

            Q = append(Q, next)
        }
    }

    <span style="color: #a020f0;">return</span> steps
}

func main() {
    maze := readMaze(<span style="color: #8b2252;">"maze/maze.in"</span>)

    steps := walk(maze, point{0, 0}, point{len(maze) - 1, len(maze[0]) - 1})
    <span style="color: #a020f0;">for</span> _, row := range steps {
        <span style="color: #a020f0;">for</span> _, val := range row {
            fmt.Printf(<span style="color: #8b2252;">"%3d "</span>, val)
        }
        fmt.Println()
    }
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;</span>
PS D:\project\learngo&gt; go run -race .\maze\maze.go
  0   0   4   5   6
  1   2   3   0   7
  2   0   4   0   8
  0   0   0  10   9
  0   0  12  11   0
  0   0  13  12  13
</pre>
</div>
</div>
</div>
<div id="outline-container-org2f65725" class="outline-4">
<h4 id="org2f65725">广度优先探索走迷宫小结</h4>
<div class="outline-text-4" id="text-org2f65725">
<ul class="org-ul">
<li>用循环创建二维slice</li>
<li>使用slice来实现队列</li>
<li>用Fscanf读取文件</li>
<li>对Point的抽象</li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-org35b68ae" class="outline-2">
<h2 id="org35b68ae">标准库</h2>
<div class="outline-text-2" id="text-org35b68ae">
</div>
<div id="outline-container-org636305a" class="outline-3">
<h3 id="org636305a">http库</h3>
<div class="outline-text-3" id="text-org636305a">
<p>
除了做服务器还可以做client
</p>
<ul class="org-ul">
<li>使用http客户端发送请求</li>
<li>使用http.Client控制请求头部等</li>
<li>使用httputil简化工作</li>
</ul>
</div>
<div id="outline-container-org604e1e8" class="outline-4">
<h4 id="org604e1e8">使用http客户端发送请求</h4>
<div class="outline-text-4" id="text-org604e1e8">
<div class="org-src-container">
<pre class="src src-sh">// http/client.go

package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"fmt"</span>
    <span style="color: #8b2252;">"net/http"</span>
    <span style="color: #8b2252;">"net/http/httputil"</span>
)

func main() {
    resp, err := http.Get(<span style="color: #8b2252;">"http://www.imooc.com"</span>)
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }
    defer resp.Body.Close()

    s, err := httputil.DumpResponse(resp, true)
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }

    fmt.Printf(<span style="color: #8b2252;">"%s\n"</span>, s)
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orga486358" class="outline-4">
<h4 id="orga486358">使用http.Client控制请求头部等</h4>
<div class="outline-text-4" id="text-orga486358">
<p>
访问手机版本
</p>
<div class="org-src-container">
<pre class="src src-sh">// http/client.go

package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"fmt"</span>
    <span style="color: #8b2252;">"net/http"</span>
    <span style="color: #8b2252;">"net/http/httputil"</span>
)

func main() {
    request, err := http.NewRequest(http.MethodGet, <span style="color: #8b2252;">"http://www.imooc.com"</span>, nil)
    request.Header.Add(<span style="color: #8b2252;">"User-Agent"</span>,
        <span style="color: #8b2252;">"Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1"</span>)

    client := http.Client{
        CheckRedirect: func(
            req *http.Request,
            via []*http.Request) error {
            fmt.Println(<span style="color: #8b2252;">"Redirect:"</span>, req)
            <span style="color: #a020f0;">return</span> nil
        },
    }
    // resp, err := http.DefaultClient.Do(request)
    resp, err := client.Do(request)
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }
    defer resp.Body.Close()

    s, err := httputil.DumpResponse(resp, true)
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }

    fmt.Printf(<span style="color: #8b2252;">"%s\n"</span>, s)
}


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986; &#21487;&#20197;&#30475;&#21040;&#37325;&#23450;&#21521;&#21040;https://m.imooc.com</span>
PS D:\project\learngo&gt; go run -race .\http\client.go
Redirect: &amp;{GET https://www.imooc.com  0 0 map[Referer:[http://www.imooc.com] User-Agent:[Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1]] &lt;nil&gt; &lt;nil&gt; 0 [] false  map[] map[] &lt;nil&gt; map[]   &lt;nil&gt; &lt;nil&gt; 0xc000206000 0xc0000140c8}
Redirect: &amp;{GET https://m.imooc.com  0 0 map[Referer:[https://www.imooc.com] User-Agent:[Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1]] &lt;nil&gt; &lt;nil&gt; 0 [] false  map[] map[] &lt;nil&gt; map[]   &lt;nil&gt; &lt;nil&gt; 0xc00012a000 0xc0000140c8}
HTTP/1.1 200 OK
Transfer-Encoding: chunked
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc35e80c" class="outline-4">
<h4 id="orgc35e80c">使用httputil简化工作</h4>
<div class="outline-text-4" id="text-orgc35e80c">
<p>
使用`httputil.DumpResponse(resp, true)` 来简化工作，打印所有内容
</p>
</div>
</div>
<div id="outline-container-org9f310a6" class="outline-4">
<h4 id="org9f310a6">http 服务器性能分析</h4>
<div class="outline-text-4" id="text-org9f310a6">
<ul class="org-ul">
<li>`import _ "net/http/ppro"`</li>
<li>访问 /debug/pprof</li>
<li>使用`go tool pprof`分析性能</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">//&#20462;&#25913; errhanding/filelistinserver/web.go
package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"log"</span>
    <span style="color: #8b2252;">"net/http"</span>
    _ <span style="color: #8b2252;">"net/http/pprof"</span> // &#21152;&#36733;&#19968;&#20123;&#24110;&#21161;&#31243;&#24207;
    <span style="color: #8b2252;">"os"</span>

    <span style="color: #8b2252;">"xxx.com/jasper/learngo/errhandling/filelistingserver/filelisting"</span>
)

func main() {
    http.HandleFunc(<span style="color: #8b2252;">"/"</span>, errWrapper(filelisting.HandleFileList)) // &#32479;&#19968;&#38169;&#35823;&#22788;&#29702;|&#25351;&#23450;&#36335;&#24452;&#65306;&#23558;&#20989;&#25968;&#20013;&#19994;&#21153;&#36923;&#36753;&#25552;&#20986;&#21435;
</pre>
</div>
<p>
访问url查看性能：<a href="http://localhost:8888/debug/pprof/">http://localhost:8888/debug/pprof/</a>
30秒cpu性能输入命令：`go tool pprof <a href="http://localhost:8888/debug/pprof/profile">http://localhost:8888/debug/pprof/profile</a>` 再输入`web`从浏览器上用时
30秒内存使用：`go tool ppro <a href="http://localhost:6060/debug/pprof/heap">http://localhost:6060/debug/pprof/heap</a>`， 再输入`web`从浏览器上用时
可对服务进行相应优化
</p>
</div>
</div>
</div>
<div id="outline-container-orga543b54" class="outline-3">
<h3 id="orga543b54">json库</h3>
<div class="outline-text-3" id="text-orga543b54">
</div>
<div id="outline-container-orgea14d33" class="outline-4">
<h4 id="orgea14d33">JSON的解析</h4>
<div class="outline-text-4" id="text-orgea14d33">
<ul class="org-ul">
<li>JSON数据格式</li>
<li>结构体的tag
处理字段名问题</li>
<li>JSON Marshal与Unmarshal，数据类型</li>
</ul>
</div>
<div id="outline-container-orgdaf2f4e" class="outline-5">
<h5 id="orgdaf2f4e">范例：转JSON数据格式`json.Marshal(o)`</h5>
<div class="outline-text-5" id="text-orgdaf2f4e">
<div class="org-src-container">
<pre class="src src-sh">// lang/json/main.go

package main

import <span style="color: #8b2252;">"fmt"</span>

<span style="color: #483d8b;">type</span> Order struct { // &#35746;&#21333;
    ID         string
    Name       string
    Quantity   int
    TotalPrice float64
}

func main() {
    o := Order{
        ID:         <span style="color: #8b2252;">"1234"</span>,
        Name:       <span style="color: #8b2252;">"learn go"</span>,
        Quantity:   3,
        TotalPrice: 30,
    }

    fmt.Printf(<span style="color: #8b2252;">"%+v\n"</span>, o) // {ID:1234 Name:learn go Quantity:3 TotalPrice:30} &#32570;&#23569;&#24341;&#21495;
}
</pre>
</div>

<p>
使用json打印
</p>
<div class="org-src-container">
<pre class="src src-sh">// lang/json/main.go

package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"encoding/json"</span>
    <span style="color: #8b2252;">"fmt"</span>
)

<span style="color: #483d8b;">type</span> Order struct { // &#35746;&#21333;
    ID         string
    Name       string
    Quantity   int
    TotalPrice float64
}

func main() {
    o := Order{
        ID:         <span style="color: #8b2252;">"1234"</span>,
        Name:       <span style="color: #8b2252;">"learn go"</span>,
        Quantity:   3,
        TotalPrice: 30,
    }

    b, err := json.Marshal(o) // Marsha &#23558;&#20869;&#23384;&#32467;&#26500;&#24207;&#21015;&#21270;&#25104;&#22312;&#32593;&#32476;&#19978;&#20256;&#36755;&#30340;&#23383;&#33410;
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }

    fmt.Printf(<span style="color: #8b2252;">"%s\n"</span>, b) // &#34429;&#28982; b &#26159;&#23383;&#31526;byte&#30340;&#20999;&#29255;[]byte&#65292;&#20294;&#25105;&#20204;&#30693;&#36947;&#23427;&#37324;&#38754;&#26159;&#19968;&#20010;&#23383;&#31526;&#20018;&#65292;&#21487;&#20197;&#29992;%s&#26469;&#25171;&#21360;
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;</span>
PS D:\project\learngo&gt; go run  .\lang\json\main.go
{<span style="color: #8b2252;">"ID"</span>:<span style="color: #8b2252;">"1234"</span>,<span style="color: #8b2252;">"Name"</span>:<span style="color: #8b2252;">"learn go"</span>,<span style="color: #8b2252;">"Quantity"</span>:3,<span style="color: #8b2252;">"TotalPrice"</span>:30}
</pre>
</div>

<p>
json在网络上传输是跨语言的，应用有自定义字段
给每个字段打上json的tag
</p>
<div class="org-src-container">
<pre class="src src-sh">// lang/json/main.go

<span style="color: #483d8b;">type</span> Order struct { // &#35746;&#21333;
    ID         string  <span style="color: #ff00ff;">`json:"id"`</span>
    Name       string  <span style="color: #ff00ff;">`json:"name,omitempty"`</span> // &#31354;&#30340;&#19981;&#30465;&#30053;&#65292;&#19981;&#25171;&#21360;
    Quantity   int     <span style="color: #ff00ff;">`json:"quantity"`</span>
    TotalPrice float64 <span style="color: #ff00ff;">`json:"totalprice"`</span>
}

func main() {
    o := Order{
        ID:         <span style="color: #8b2252;">"1234"</span>,
        Quantity:   3,
        TotalPrice: 30,
    }

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;</span>
PS D:\project\learngo&gt; go run  .\lang\json\main.go
{<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"1234"</span>,<span style="color: #8b2252;">"quantity"</span>:3,<span style="color: #8b2252;">"totalprice"</span>:30}
</pre>
</div>

<p>
更复杂的结构
</p>
<div class="org-src-container">
<pre class="src src-sh">// lang/json/main.go

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#26159;&#19968;&#20010;&#22823;&#30340;&#23545;&#35937;</span>
<span style="color: #483d8b;">type</span> OrderItem struct {
    ID    string  <span style="color: #ff00ff;">`json:"id"`</span>
    Name  string  <span style="color: #ff00ff;">`json:"name,omitempty"`</span> // &#31354;&#30340;&#19981;&#30465;&#30053;&#65292;&#19981;&#25171;&#21360;
    Price float64 <span style="color: #ff00ff;">`json:"price"`</span>
}

<span style="color: #483d8b;">type</span> Order struct { // &#35746;&#21333;
    ID         string    <span style="color: #ff00ff;">`json:"id"`</span>
    Item       OrderItem <span style="color: #ff00ff;">`json:"Item"`</span>
    Quantity   int       <span style="color: #ff00ff;">`json:"quantity"`</span>
    TotalPrice float64   <span style="color: #ff00ff;">`json:"totalprice"`</span>
}

func main() {
    o := Order{
        ID:         <span style="color: #8b2252;">"1234"</span>,
        Quantity: 3,
        TotalPrice: 30,
        Item: OrderItem{
            ID: <span style="color: #8b2252;">"item_1"</span>,
            Name: <span style="color: #8b2252;">"learn go"</span>,
            Price: 15,
        },
    }

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;</span>
PS D:\project\learngo&gt; go run  .\lang\json\main.go
{<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"1234"</span>,<span style="color: #8b2252;">"Item"</span>:{<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"item_1"</span>,<span style="color: #8b2252;">"name"</span>:<span style="color: #8b2252;">"learn go"</span>,<span style="color: #8b2252;">"price"</span>:15},<span style="color: #8b2252;">"quantity"</span>:3,<span style="color: #8b2252;">"totalprice"</span>:30}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#26159;&#23884;&#20837;&#25351;&#38024;</span>
<span style="color: #483d8b;">type</span> OrderItem struct {
    ID    string  <span style="color: #ff00ff;">`json:"id"`</span>
    Name  string  <span style="color: #ff00ff;">`json:"name,omitempty"`</span> // &#31354;&#30340;&#19981;&#30465;&#30053;&#65292;&#19981;&#25171;&#21360;
    Price float64 <span style="color: #ff00ff;">`json:"price"`</span>
}

<span style="color: #483d8b;">type</span> Order struct { // &#35746;&#21333;
    ID         string    <span style="color: #ff00ff;">`json:"id"`</span>
    Item       *OrderItem <span style="color: #ff00ff;">`json:"Item"`</span> // &#25351;&#21521;&#32531;&#23384;&#30340;OrderItem
    Quantity   int       <span style="color: #ff00ff;">`json:"quantity"`</span>
    TotalPrice float64   <span style="color: #ff00ff;">`json:"totalprice"`</span>
}

func main() {
    o := Order{
        ID:         <span style="color: #8b2252;">"1234"</span>,
        Quantity: 3,
        TotalPrice: 30,
        Item: &amp;OrderItem{
            ID: <span style="color: #8b2252;">"item_1"</span>,
            Name: <span style="color: #8b2252;">"learn go"</span>,
            Price: 15,
        },
    }

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;</span>
PS D:\project\learngo&gt; go run  .\lang\json\main.go
{<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"1234"</span>,<span style="color: #8b2252;">"Item"</span>:{<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"item_1"</span>,<span style="color: #8b2252;">"name"</span>:<span style="color: #8b2252;">"learn go"</span>,<span style="color: #8b2252;">"price"</span>:15},<span style="color: #8b2252;">"quantity"</span>:3,<span style="color: #8b2252;">"totalprice"</span>:30}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#26159;&#25968;&#32452;</span>
<span style="color: #483d8b;">type</span> Order struct { // &#35746;&#21333;
    ID         string      <span style="color: #ff00ff;">`json:"id"`</span>
    Items      []OrderItem <span style="color: #ff00ff;">`json:"Item"`</span> // &#25351;&#21521;&#32531;&#23384;&#30340;OrderItem
    TotalPrice float64     <span style="color: #ff00ff;">`json:"totalprice"`</span>
}

func main() {
    o := Order{
        ID:         <span style="color: #8b2252;">"1234"</span>,
        TotalPrice: 20,
        Items: []OrderItem{
            {
                ID: <span style="color: #8b2252;">"item_1"</span>,
                Name:  <span style="color: #8b2252;">"learn go"</span>,
                Price: 15,
            },
            {
                ID: <span style="color: #8b2252;">"item_2"</span>,
                Name:  <span style="color: #8b2252;">"interview"</span>,
                Price: 10,
            },
        },
    }

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;</span>
PS D:\project\learngo&gt; go run  .\lang\json\main.go
{<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"1234"</span>,<span style="color: #8b2252;">"Item"</span>:[{<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"item_1"</span>,<span style="color: #8b2252;">"name"</span>:<span style="color: #8b2252;">"learn go"</span>,<span style="color: #8b2252;">"price"</span>:15},{<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"item_2"</span>,<span style="color: #8b2252;">"name"</span>:<span style="color: #8b2252;">"interview"</span>,<span style="color: #8b2252;">"price"</span>:10}],<span style="color: #8b2252;">"totalprice"</span>:20}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#26159;&#25351;&#38024;&#25968;&#32452;</span>
<span style="color: #483d8b;">type</span> Order struct { // &#35746;&#21333;
    ID         string      <span style="color: #ff00ff;">`json:"id"`</span>
    Items      []*OrderItem <span style="color: #ff00ff;">`json:"Item"`</span> // &#25351;&#21521;&#32531;&#23384;&#30340;OrderItem
    TotalPrice float64     <span style="color: #ff00ff;">`json:"totalprice"`</span>
}

func main() {
    o := Order{
        ID:         <span style="color: #8b2252;">"1234"</span>,
        TotalPrice: 20,
        Items: []*OrderItem{
            {
                ID: <span style="color: #8b2252;">"item_1"</span>,
                Name:  <span style="color: #8b2252;">"learn go"</span>,
                Price: 15,
            },
            {
                ID: <span style="color: #8b2252;">"item_2"</span>,
                Name:  <span style="color: #8b2252;">"interview"</span>,
                Price: 10,
            },
        },
    }
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;&#32467;&#26524;&#26159;&#19968;&#26679;&#30340;</span>
PS D:\project\learngo&gt; go run  .\lang\json\main.go
{<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"1234"</span>,<span style="color: #8b2252;">"Item"</span>:[{<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"item_1"</span>,<span style="color: #8b2252;">"name"</span>:<span style="color: #8b2252;">"learn go"</span>,<span style="color: #8b2252;">"price"</span>:15},{<span style="color: #8b2252;">"id"</span>:<span style="color: #8b2252;">"item_2"</span>,<span style="color: #8b2252;">"name"</span>:<span style="color: #8b2252;">"interview"</span>,<span style="color: #8b2252;">"price"</span>:10}],<span style="color: #8b2252;">"totalprice"</span>:20}
</pre>
</div>
</div>
</div>
<div id="outline-container-org1af8ce2" class="outline-5">
<h5 id="org1af8ce2">json解析</h5>
<div class="outline-text-5" id="text-org1af8ce2">
<p>
范例：生成JSON数据格式`json.Marshal(o)`
</p>
<div class="org-src-container">
<pre class="src src-sh">// lang/json/main.go

package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"encoding/json"</span>
    <span style="color: #8b2252;">"fmt"</span>
)

<span style="color: #483d8b;">type</span> OrderItem struct {
    ID    string  <span style="color: #ff00ff;">`json:"id"`</span>
    Name  string  <span style="color: #ff00ff;">`json:"name,omitempty"`</span> // &#31354;&#30340;&#19981;&#30465;&#30053;&#65292;&#19981;&#25171;&#21360;
    Price float64 <span style="color: #ff00ff;">`json:"price"`</span>
}

<span style="color: #483d8b;">type</span> Order struct { // &#35746;&#21333;
    ID         string       <span style="color: #ff00ff;">`json:"id"`</span>
    Items      []OrderItem <span style="color: #ff00ff;">`json:"Item"`</span> // &#25351;&#21521;&#32531;&#23384;&#30340;OrderItem
    TotalPrice float64      <span style="color: #ff00ff;">`json:"totalprice"`</span>
}

func main() {
    unmarshal()
}

func unmarshal() {
    s := <span style="color: #ff00ff;">`{"id":"1234","Item":[{"id":"item_1","name":"learn go","price":15},{"id":"item_2","name":"interview","price":10}],"totalprice":20}`</span>
    var o Order // &#23450;&#20041;&#19968;&#20010;order&#26469;&#25509;&#25910;
    err := json.Unmarshal([]byte(s), &amp;o)
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }
    fmt.Printf(<span style="color: #8b2252;">"%+v\n"</span>, o)
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20986;&#32467;&#26524;&#26159;&#19968;&#26679;&#30340;</span>
PS D:\project\learngo&gt; go run  .\lang\json\main.go
{ID:1234 Items:[{ID:item_1 Name:learn go Price:15} {ID:item_2 Name:interview Price:10}] TotalPrice:20}
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orgbea531e" class="outline-3">
<h3 id="orgbea531e">第三方API数据格式的解析技巧</h3>
<div class="outline-text-3" id="text-orgbea531e">
<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-sh">res := <span style="color: #ff00ff;">`{</span>
<span style="color: #ff00ff;">"data": [</span>
<span style="color: #ff00ff;">    {</span>
<span style="color: #ff00ff;">        "synonym":"",</span>
<span style="color: #ff00ff;">        "weight":"0.6",</span>
<span style="color: #ff00ff;">        "word": "&#30495;&#19997;",</span>
<span style="color: #ff00ff;">        "tag":"&#26448;&#36136;"</span>
<span style="color: #ff00ff;">    },</span>
<span style="color: #ff00ff;">    {</span>
<span style="color: #ff00ff;">        "synonym":"",</span>
<span style="color: #ff00ff;">        "weight":"0.8",</span>
<span style="color: #ff00ff;">        "word": "&#38889;&#37117;&#34915;&#33293;",</span>
<span style="color: #ff00ff;">        "tag":"&#21697;&#29260;"</span>
<span style="color: #ff00ff;">    },</span>
<span style="color: #ff00ff;">    {</span>
<span style="color: #ff00ff;">        "synonym":"&#36830;&#36523;&#35033;;&#32852;&#34915;&#35033;",</span>
<span style="color: #ff00ff;">        "weight":"1.0",</span>
<span style="color: #ff00ff;">        "word": "&#36830;&#34915;&#35033;",</span>
<span style="color: #ff00ff;">        "tag":"&#21697;&#31867;"</span>
<span style="color: #ff00ff;">    }</span>
<span style="color: #ff00ff;">]</span>
<span style="color: #ff00ff;">}`</span>
</pre>
</div>

<p>
使用map接收
</p>
<div class="org-src-container">
<pre class="src src-sh">// json&#35299;&#26512;
m := make(map[string]interface{})
err := json.Unmarshal([]byte(res), &amp;m)
<span style="color: #a020f0;">if</span> err != nil {
        panic(err)
}

<span style="color: #0000ff;">fmt.Printf</span>(<span style="color: #8b2252;">"%+v\n"</span>, m) // map[data:[map[synonym: tag:&#26448;&#36136; weight:0.6 word:&#30495;&#19997;] map[synonym: tag:&#21697;&#29260; weight:0.8 word:&#38889;&#37117;&#34915;&#33293;] map[synonym:&#36830;&#36523;&#35033;;&#32852;&#34915;&#35033; tag:&#21697;&#31867; weight:1.0 word:&#36830;&#34915;&#35033;]]]

// &#21462;&#20986; <span style="color: #8b2252;">"&#36830;&#36523;&#35033;;&#32852;&#34915;&#35033;"</span>
<span style="color: #0000ff;">fmt.Printf</span>(<span style="color: #8b2252;">"%+v\n"</span>,m[<span style="color: #8b2252;">"data"</span>].([]interface{})[2].(map[string]interface{})[<span style="color: #8b2252;">"synonym"</span>]   ) // &#20351;&#29992;type assertion &#21578;&#35785;&#27599;&#20010;&#20803;&#32032;&#30340;&#31867;&#22411;
</pre>
</div>
<p>
缺点：处理map时代码难懂
</p>

<p>
定义结构
</p>
<div class="org-src-container">
<pre class="src src-sh">// json&#35299;&#26512;
m := struct{
        Data []struct{
                Synonym string <span style="color: #ff00ff;">`json:"synonym"`</span>
        } <span style="color: #ff00ff;">`json:"data"`</span>
}{}
err := json.Unmarshal([]byte(res), &amp;m)
<span style="color: #a020f0;">if</span> err != nil {
        panic(err)
}

<span style="color: #0000ff;">fmt.Printf</span>(<span style="color: #8b2252;">"%+v\n"</span>, m.Data[2].Synonym)
</pre>
</div>
</div>
</div>
<div id="outline-container-org9c2f937" class="outline-3">
<h3 id="org9c2f937">gin框架</h3>
<div class="outline-text-3" id="text-org9c2f937">
<p>
go语言框架的设计思路基本都是一样的
</p>

<ul class="org-ul">
<li>`gin-gonic/gin`</li>
<li>middleware的使用
注册一些函数，让所有的请求都从middleware走过</li>
<li>context的使用
包括用户请求、反馈是什么样的、设置自己的key value</li>
</ul>
</div>
<div id="outline-container-org5cdc964" class="outline-4">
<h4 id="org5cdc964">`gin-gonic/gin`</h4>
<div class="outline-text-4" id="text-org5cdc964">
<div class="org-src-container">
<pre class="src src-sh">go get -u github.com/gin-gonic/gin
</pre>
</div>

<p>
范例：简单演示
</p>
<div class="org-src-container">
<pre class="src src-sh">// lang/http/gindemo/ginserver.go

package main

import <span style="color: #8b2252;">"github.com/gin-gonic/gin"</span>

func main() {
        r := gin.Default()  // &#36820;&#22238;&#19968;&#20010;gin&#30340;Engine
        r.GET(<span style="color: #8b2252;">"/ping"</span>, func(c *gin.Context) { // Engine&#26377;&#20010;Get&#26041;&#27861;&#65292;&#23427;&#27880;&#20876;&#21040;ping&#19978;&#38754;&#65292; &#36820;&#22238;&#20102;&#20010;json
                c.JSON(200, gin.H{
                        <span style="color: #8b2252;">"message"</span>: <span style="color: #8b2252;">"pong"</span>,
                })
        })
        r.Run() // listen and serve on 0.0.0.0:8080 (<span style="color: #a020f0;">for</span> windows <span style="color: #8b2252;">"localhost:8080"</span>)
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35831;&#27714; http://localhost:8080/ping</span>
[GIN-debug] Environment variable PORT is undefined. Using port :8080 by default
[GIN-debug] Listening and serving HTTP on :8080
[GIN] 2021/11/24 - 00:34:44 |?[97;42m 200 ?[0m|            0s |             ::1 |?[97;44m GET     ?[0m <span style="color: #8b2252;">"/ping"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org6384f10" class="outline-4">
<h4 id="org6384f10">middleware的使用</h4>
<div class="outline-text-4" id="text-org6384f10">
<p>
不论访问哪个路径，一律进入到r.use中
</p>



<p>
范例：使用middleware统一的写日志
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;&#20889;&#26085;&#24535;&#30340;&#24211;zap</span>
go get -u go.uber.org/zap
</pre>
</div>

<p>
输出path
</p>
<div class="org-src-container">
<pre class="src src-sh">// lang/http/gindemo/ginserver.go

package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"github.com/gin-gonic/gin"</span>
    <span style="color: #8b2252;">"go.uber.org/zap"</span>
)

func main() {
    r := gin.Default()
    logger, err := zap.NewProduction()
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }

    r.Use(func(c *gin.Context) {
        // path, log latency, response code
        logger.Info(<span style="color: #8b2252;">"incoming request"</span>,
            zap.String(<span style="color: #8b2252;">"path"</span>, c.Request.URL.Path))

        c.Next()
    })

    r.GET(<span style="color: #8b2252;">"/ping"</span>, func(c *gin.Context) {
        c.JSON(200, gin.H{
            <span style="color: #8b2252;">"message"</span>: <span style="color: #8b2252;">"pong"</span>,
        })
    })

    r.GET(<span style="color: #8b2252;">"/hello"</span>, func(c *gin.Context) {
        c.String(200, <span style="color: #8b2252;">"hello"</span>)
    })

    r.Run()
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35775;&#27714;&#36755;&#20986;&#12290;&#35831;&#38382;http://localhost:8080/ping, http://localhost:8080/hello, http://localhost:8080/</span>
{<span style="color: #8b2252;">"level"</span>:<span style="color: #8b2252;">"info"</span>,<span style="color: #8b2252;">"ts"</span>:1637686464.1075187,<span style="color: #8b2252;">"caller"</span>:<span style="color: #8b2252;">"gindemo/ginserver.go:17"</span>,<span style="color: #8b2252;">"msg"</span>:<span style="color: #8b2252;">"incoming request"</span>,<span style="color: #8b2252;">"path"</span>:<span style="color: #8b2252;">"/ping"</span>}
[GIN] 2021/11/24 - 00:54:24 |?[97;42m 200 ?[0m|       994.2&#181;s |             ::1 |?[97;44m GET     ?[0m <span style="color: #8b2252;">"/ping"</span>
{<span style="color: #8b2252;">"level"</span>:<span style="color: #8b2252;">"info"</span>,<span style="color: #8b2252;">"ts"</span>:1637686478.7833898,<span style="color: #8b2252;">"caller"</span>:<span style="color: #8b2252;">"gindemo/ginserver.go:17"</span>,<span style="color: #8b2252;">"msg"</span>:<span style="color: #8b2252;">"incoming request"</span>,<span style="color: #8b2252;">"path"</span>:<span style="color: #8b2252;">"/hello"</span>}
[GIN] 2021/11/24 - 00:54:38 |?[97;42m 200 ?[0m|       290.7&#181;s |             ::1 |?[97;44m GET     ?[0m <span style="color: #8b2252;">"/hello"</span>
{<span style="color: #8b2252;">"level"</span>:<span style="color: #8b2252;">"info"</span>,<span style="color: #8b2252;">"ts"</span>:1637686482.1059425,<span style="color: #8b2252;">"caller"</span>:<span style="color: #8b2252;">"gindemo/ginserver.go:17"</span>,<span style="color: #8b2252;">"msg"</span>:<span style="color: #8b2252;">"incoming request"</span>,<span style="color: #8b2252;">"path"</span>:<span style="color: #8b2252;">"/"</span>}
[GIN] 2021/11/24 - 00:54:42 |?[90;43m 404 ?[0m|         788&#181;s |             ::1 |?[97;44m GET     ?[0m <span style="color: #8b2252;">"/"</span>
</pre>
</div>

<p>
耗时，状态
</p>
<div class="org-src-container">
<pre class="src src-sh">
// lang/http/gindemo/ginserver.go

package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"time"</span>

    <span style="color: #8b2252;">"github.com/gin-gonic/gin"</span>
    <span style="color: #8b2252;">"go.uber.org/zap"</span>
)

func main() {
    r := gin.Default()
    logger, err := zap.NewProduction()
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }

    r.Use(func(c *gin.Context) {
        s := time.Now() // &#35760;&#24405;&#24320;&#22987;&#26102;&#38388;

        c.Next() // &#23427;&#20043;&#21518;&#23601;&#21487;&#20197; response code

        // path, response code, log latency
        logger.Info(<span style="color: #8b2252;">"incoming request"</span>,
            zap.String(<span style="color: #8b2252;">"path"</span>, c.Request.URL.Path),
            zap.Int(<span style="color: #8b2252;">"status"</span>, c.Writer.Status()),
            zap.Duration(<span style="color: #8b2252;">"elapsed"</span>, time.Now().Sub(s))) // &#23558;&#32467;&#26463;&#26102;&#38388;&#35760;&#24405;&#36827;&#21435;
    })

    r.GET(<span style="color: #8b2252;">"/ping"</span>, func(c *gin.Context) {
        c.JSON(200, gin.H{
            <span style="color: #8b2252;">"message"</span>: <span style="color: #8b2252;">"pong"</span>,
        })
    })

    r.GET(<span style="color: #8b2252;">"/hello"</span>, func(c *gin.Context) {
        c.String(200, <span style="color: #8b2252;">"hello"</span>)
    })

    r.Run()
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35775;&#27714;&#36755;&#20986;&#12290;&#35831;&#38382;http://localhost:8080/ping, http://localhost:8080/hello, http://localhost:8080/</span>
{<span style="color: #8b2252;">"level"</span>:<span style="color: #8b2252;">"info"</span>,<span style="color: #8b2252;">"ts"</span>:1637687286.6143937,<span style="color: #8b2252;">"caller"</span>:<span style="color: #8b2252;">"gindemo/ginserver.go:23"</span>,<span style="color: #8b2252;">"msg"</span>:<span style="color: #8b2252;">"incoming request"</span>,<span style="color: #8b2252;">"path"</span>:<span style="color: #8b2252;">"/"</span>,<span style="color: #8b2252;">"status"</span>:404,<span style="color: #8b2252;">"elapsed"</span>:0}
[GIN] 2021/11/24 - 01:08:06 |?[90;43m 404 ?[0m|       998.5&#181;s |             ::1 |?[97;44m GET     ?[0m <span style="color: #8b2252;">"/"</span>
{<span style="color: #8b2252;">"level"</span>:<span style="color: #8b2252;">"info"</span>,<span style="color: #8b2252;">"ts"</span>:1637687290.1554174,<span style="color: #8b2252;">"caller"</span>:<span style="color: #8b2252;">"gindemo/ginserver.go:23"</span>,<span style="color: #8b2252;">"msg"</span>:<span style="color: #8b2252;">"incoming request"</span>,<span style="color: #8b2252;">"path"</span>:<span style="color: #8b2252;">"/hello"</span>,<span style="color: #8b2252;">"status"</span>:200,<span style="color: #8b2252;">"elapsed"</span>:0.0005609}
[GIN] 2021/11/24 - 01:08:10 |?[97;42m 200 ?[0m|       560.9&#181;s |             ::1 |?[97;44m GET     ?[0m <span style="color: #8b2252;">"/hello"</span>
{<span style="color: #8b2252;">"level"</span>:<span style="color: #8b2252;">"info"</span>,<span style="color: #8b2252;">"ts"</span>:1637687294.1163,<span style="color: #8b2252;">"caller"</span>:<span style="color: #8b2252;">"gindemo/ginserver.go:23"</span>,<span style="color: #8b2252;">"msg"</span>:<span style="color: #8b2252;">"incoming request"</span>,<span style="color: #8b2252;">"path"</span>:<span style="color: #8b2252;">"/ping"</span>,<span style="color: #8b2252;">"status"</span>:200,<span style="color: #8b2252;">"elapsed"</span>:0.000952}
[GIN] 2021/11/24 - 01:08:14 |?[97;42m 200 ?[0m|         952&#181;s |             ::1 |?[97;44m GET     ?[0m <span style="color: #8b2252;">"/ping"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org4c9ac5f" class="outline-4">
<h4 id="org4c9ac5f">context的使用</h4>
<div class="outline-text-4" id="text-org4c9ac5f">
<p>
gin.Context实现了context 库Context接口
</p>

<p>
范例：将数字插入到每一个request中生成requestId
</p>
<div class="org-src-container">
<pre class="src src-sh">// lang/http/gindemo/ginserver.go

package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"math/rand"</span>
    <span style="color: #8b2252;">"time"</span>

    <span style="color: #8b2252;">"github.com/gin-gonic/gin"</span>
    <span style="color: #8b2252;">"go.uber.org/zap"</span>
)

func main() {
    r := gin.Default()
    logger, err := zap.NewProduction()
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }

    r.Use(func(c *gin.Context) {
        s := time.Now() // &#35760;&#24405;&#24320;&#22987;&#26102;&#38388;

        c.Next() // &#23427;&#20043;&#21518;&#23601;&#21487;&#20197; response code

        // path, response code, log latency
        logger.Info(<span style="color: #8b2252;">"incoming request"</span>,
            zap.String(<span style="color: #8b2252;">"path"</span>, c.Request.URL.Path),
            zap.Int(<span style="color: #8b2252;">"status"</span>, c.Writer.Status()),
            zap.Duration(<span style="color: #8b2252;">"elapsed"</span>, time.Now().Sub(s))) // &#23558;&#32467;&#26463;&#26102;&#38388;&#35760;&#24405;&#36827;&#21435;
    }, func(c *gin.Context) {
        c.Set(<span style="color: #8b2252;">"requestId"</span>, rand.Int())
        c.Next()
    })

    r.GET(<span style="color: #8b2252;">"/ping"</span>, func(c *gin.Context) {

        h := gin.H{
            <span style="color: #8b2252;">"message"</span>: <span style="color: #8b2252;">"pong"</span>,
        }
        <span style="color: #a020f0;">if</span> rid, exists := c.Get(<span style="color: #8b2252;">"requestId"</span>); exists { // &#21028;&#26029;requestId&#22312;&#19981;&#22312;
            h[<span style="color: #8b2252;">"requestId"</span>] = rid
        }
        c.JSON(200, h)
    })

    r.GET(<span style="color: #8b2252;">"/hello"</span>, func(c *gin.Context) {
        c.String(200, <span style="color: #8b2252;">"hello"</span>)
    })

    r.Run()
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35775;&#27714;&#36755;&#20986;&#12290;&#27983;&#35272;&#22120;&#35831;&#38382;http://localhost:8080/ping</span>
{<span style="color: #8b2252;">"message"</span>:<span style="color: #8b2252;">"pong"</span>,<span style="color: #8b2252;">"requestId"</span>:3916589616287113937}
</pre>
</div>

<p>
requestId常量
</p>
<div class="org-src-container">
<pre class="src src-sh">// lang/http/gindemo/ginserver.go

package main

<span style="color: #0000ff;">import</span> (
    <span style="color: #8b2252;">"math/rand"</span>
    <span style="color: #8b2252;">"time"</span>

    <span style="color: #8b2252;">"github.com/gin-gonic/gin"</span>
    <span style="color: #8b2252;">"go.uber.org/zap"</span>
)

const keyRequestId = <span style="color: #8b2252;">"requestId"</span>

func main() {
    r := gin.Default()
    logger, err := zap.NewProduction()
    <span style="color: #a020f0;">if</span> err != nil {
        panic(err)
    }

    r.Use(func(c *gin.Context) {
        s := time.Now() // &#35760;&#24405;&#24320;&#22987;&#26102;&#38388;

        c.Next() // &#23427;&#20043;&#21518;&#23601;&#21487;&#20197; response code

        // path, response code, log latency
        logger.Info(<span style="color: #8b2252;">"incoming request"</span>,
            zap.String(<span style="color: #8b2252;">"path"</span>, c.Request.URL.Path),
            zap.Int(<span style="color: #8b2252;">"status"</span>, c.Writer.Status()),
            zap.Duration(<span style="color: #8b2252;">"elapsed"</span>, time.Now().Sub(s))) // &#23558;&#32467;&#26463;&#26102;&#38388;&#35760;&#24405;&#36827;&#21435;
    }, func(c *gin.Context) {
        c.Set(keyRequestId, rand.Int())
        c.Next()
    })

    r.GET(<span style="color: #8b2252;">"/ping"</span>, func(c *gin.Context) {

        h := gin.H{
            <span style="color: #8b2252;">"message"</span>: <span style="color: #8b2252;">"pong"</span>,
        }
        <span style="color: #a020f0;">if</span> rid, exists := c.Get(keyRequestId); exists { // &#21028;&#26029;requestId&#22312;&#19981;&#22312;
            h[keyRequestId] = rid
        }
        c.JSON(200, h)
    })

    r.GET(<span style="color: #8b2252;">"/hello"</span>, func(c *gin.Context) {
        c.String(200, <span style="color: #8b2252;">"hello"</span>)
    })

    r.Run()
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35775;&#27714;&#36755;&#20986;&#12290;&#27983;&#35272;&#22120;&#35831;&#38382;http://localhost:8080/ping</span>
{<span style="color: #8b2252;">"message"</span>:<span style="color: #8b2252;">"pong"</span>,<span style="color: #8b2252;">"requestId"</span>:3916589616287113937}
</pre>
</div>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
