<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: è¿ç»´è‡ªè¿åŒ–ä¹‹ANSIBLE</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/font.css"/>
<link rel="stylesheet" type="text/css" href="/static/drollery.e825b870.css"/>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
</head>
<body>
<header id="preamble" class="status">
<header class="{className}" data-astro-cid-3ef6ksr2>
  <div class=header-branding data-astro-cid-g2lrb5xm>
      <span class=header-text data-astro-cid-g2lrb5xm>
          <span class=dropcap data-astro-cid-g2lrb5xm aria-hidden=true>
              <span class=actual data-astro-cid-g2lrb5xm>J</span>
              <span class=rest data-astro-cid-g2lrb5xm>asper Hsu</span>
              <span class=period data-astro-cid-g2lrb5xm>.</span>
          </span>
          <span class=sr-only data-astro-cid-g2lrb5xm>Drollery</span>
      </span>
      <img alt="Medieval drollery of a knight on a horse" class=spring decoding=async height=250 loading=lazy src=/images/knight-horse.a96eee7d_Z1WCOYs.webp width=68 data-astro-cid-g2lrb5xm>
  </div>

  <nav data-astro-cid-pux6a34n>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/jcodelog.html class=nobracket data-astro-cid-pux6a34n>æŠ€æœ¯</a>
      <span class=flower2 data-astro-cid-pux6a34n>K</span>
      <a href=/reading/index.html class=nobracket data-astro-cid-pux6a34n>é˜…è¯»</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
      <a href=/archives.html class=nobracket data-astro-cid-pux6a34n>å½’æ¡£</a>
      <span class=flower2 data-astro-cid-pux6a34n>L</span>
      <a href=/link/index.html class=nobracket data-astro-cid-pux6a34n>å‹é“¾</a>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/about.html class=nobracket data-astro-cid-pux6a34n>å…³äº</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
  </nav>


  <div class="container" data-astro-cid-3ef6ksr2>
    <p class="info" data-astro-cid-3ef6ksr2>
              ğŸ† æ¬¢è¿æ¥åˆ°æœ¬ç«™ï¼š
              <a href="https://xuchangwei.com/">https://xuchangwei.com/</a>ã€‚
              <strong>å¸Œæœ›è¿™é‡Œæœ‰ä½ æ„Ÿå…´è¶£çš„å†…å®¹</strong>ã€‚
            </p>
  </div>
  <div id=borderArtWrapper class="tt1" data-astro-cid-5hce7sga data-turbo-permanent>
      <script>
          var man, shakeCount = 0, noSound = new Audio("/audio/effects/no.m4a"), screamSound = new Audio("/audio/effects/scream.m4a");
          function animateManShakeHandler() {
              man.removeEventListener("animationend", animateManShakeHandler, !1),
              shakeCount += 1,
              man.classList.remove("shakeMan")
          }
          function animateManFallHandler() {
              man.removeEventListener("animationend", animateManFallHandler, !1),
              man.classList.add("hide")
          }
          function animateMan() {
              man = man ?? document.getElementById("borderMan"),
              3 === shakeCount ? (man.classList.add("fallMan"),
              screamSound.play(),
              man.addEventListener("animationend", animateManFallHandler, !1)) : (man.classList.add("shakeMan"),
              noSound.play(),
              man.addEventListener("animationend", animateManShakeHandler, !1))
          }
      </script>
      <div class=borderArt data-astro-cid-5dda5nwp id=articleBorder>
          <img alt="flowery border with man falling" decoding=async height=620 loading=lazy src=/images/border-vines-no-man.b7d246cc_DRxSe.webp width=909 class=border data-astro-cid-5dda5nwp>
          <div class=fallWrapper data-astro-cid-5dda5nwp>
              <img alt="flowery border with man falling" decoding=async height=292 loading=lazy src=/images/man-no-vines.247a3187_Z2ioXNM.webp width=98 class=man data-astro-cid-5dda5nwp id=borderMan onclick=animateMan()>
          </div>
      </div>
  </div>
</header>
</header>
<main class="container" id="content" class="content">
<header>
<h1 class="title">Linux: è¿ç»´è‡ªè¿åŒ–ä¹‹ANSIBLE</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:84ddf4e0-a20f-44b6-a137-093f7e4395f2">è‡ªåŠ¨åŒ–è¿ç»´åº”ç”¨åœºæ™¯</a>
<ul>
<li><a href="#h:e00bf36d-f4aa-4a87-a172-275b1a8a47ea">äº‘è®¡ç®—è¿ç»´å·¥ç¨‹å¸ˆæ ¸å¿ƒèŒèƒ½</a></li>
<li><a href="#h:878ac49e-6690-43d7-a0d2-209179a708a5">è¿ç»´èŒä¸šå‘å±•è·¯çº¿</a></li>
<li><a href="#h:2fb2cb41-c298-4a9b-a44d-98c67e3930cd">ä¼ä¸šå®é™…åº”ç”¨åœºæ™¯åˆ†æ</a>
<ul>
<li><a href="#h:53c855fe-83fc-4725-a2ae-c6c2f25b08a6">Devå¼€å‘ç¯å¢ƒ</a></li>
<li><a href="#h:c7ea20f6-4bc6-4618-ba60-152425106899">æµ‹è¯•ç¯å¢ƒ</a></li>
<li><a href="#h:88157b54-f096-487d-84a5-4dc2aa10b182">é¢„å‘å¸ƒç¯å¢ƒ</a></li>
<li><a href="#h:37339f10-a627-42f8-89a9-dcfcc70385c4">å‘å¸ƒç¯å¢ƒ</a></li>
<li><a href="#h:624d4231-0bab-4af5-8d39-1a9f9c9829a3">ç”Ÿäº§ç¯å¢ƒ</a></li>
<li><a href="#h:c7c55a39-f72f-49e2-b1d4-b961e447f9a4">ç°åº¦ç¯å¢ƒ å±äºç”Ÿäº§ç¯å¢ƒçš„ä¸€éƒ¨åˆ†</a></li>
</ul>
</li>
<li><a href="#h:b00cf7e0-b5cc-4bfe-b124-e525e9e9a5cf">ç¨‹åºå‘å¸ƒ</a></li>
<li><a href="#h:7540fba6-cda0-49cc-b84f-c3a7e6bd286a">è‡ªåŠ¨åŒ–è¿ç»´åº”ç”¨åœºæ™¯</a></li>
<li><a href="#h:a8e4ed7b-1df1-4fd3-98cc-8ad4ae635c33">å¸¸ç”¨è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·</a></li>
</ul>
</li>
<li><a href="#h:35249014-b3c0-458d-a069-333d648cea5d">Ansible ä»‹ç»å’Œæ¶æ„</a>
<ul>
<li><a href="#h:4bce6968-88de-4ec0-ac27-f93039636b84">Ansibleå‘å±•å²</a></li>
<li><a href="#h:92bd14bf-7d89-429e-92cb-ebddc0951e01">Ansible ç‰¹æ€§</a></li>
<li><a href="#h:070857b8-2694-472b-aa9a-f849de0453e6">Ansible æ¶æ„</a>
<ul>
<li><a href="#h:2e6a17ca-c051-4dc2-8b33-9f44d2ecd4d2">Ansible ç»„æˆ</a></li>
<li><a href="#h:c839818d-7871-40f7-92e9-465c6e65b3b2">Ansible å‘½ä»¤æ‰§è¡Œæ¥æº</a></li>
<li><a href="#h:6cea1437-469b-4962-8326-24b59a218c34">æ³¨æ„äº‹é¡¹</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:a6322f5b-fbe6-434d-99cc-3ba6b3c1de9a">Ansible å®‰è£…å’Œå…¥é—¨</a>
<ul>
<li><a href="#h:e418aeb6-ad79-40b1-9eb3-daa673656b6e">Ansibleå®‰è£…</a>
<ul>
<li><a href="#h:8cdbc965-e214-4d61-a76b-489bf6f08c0c">EPELæºçš„rpmåŒ…å®‰è£…:</a></li>
<li><a href="#h:ce27d17e-96c4-4767-9898-b0b5aaa23630">ç¼–è¯‘å®‰è£…</a></li>
<li><a href="#h:2759777f-d498-40f8-9865-11652fc765ea">Gitæ–¹å¼</a></li>
<li><a href="#h:e4102489-974c-4709-9c4c-d979a2a3e5ae">pip å®‰è£…</a></li>
<li><a href="#h:7d6ab60f-1897-4ff9-9e1f-c4fac0f70269">ç¡®è®¤å®‰è£…</a></li>
</ul>
</li>
<li><a href="#h:86a88466-07b0-401a-b428-787307c160e0">Ansible ç›¸å…³æ–‡ä»¶</a>
<ul>
<li><a href="#h:cbe39e12-926d-431e-9cdb-6e5a34b5f3dc">é…ç½®æ–‡ä»¶</a></li>
<li><a href="#h:63523d2b-9f1d-4d0f-b83c-f115973989c6">ansibleä¸»é…ç½®æ–‡ä»¶</a></li>
<li><a href="#h:79d691b8-68d5-4af2-b503-a3874d5d8ab7">inventory ä¸»æœºæ¸…å•</a></li>
</ul>
</li>
<li><a href="#h:f638a674-924e-48d3-a6c9-a6586dfdd727">Ansibleç›¸å…³å·¥å…·</a>
<ul>
<li><a href="#h:3b262897-d4e8-4dae-b624-4ad45d43de4c">ansible-doc</a></li>
<li><a href="#h:e41406a9-31fe-4c50-9007-e7781477b9ae">ansible</a></li>
<li><a href="#h:69c9ffb5-50ba-428e-bc25-4076e48e725b">ansible-playbook</a></li>
<li><a href="#h:2b06dcdf-28d2-4881-b5c0-4aaf1246e6f6">ansible-vault</a></li>
<li><a href="#h:a11de16a-c359-4239-8ee3-e5a99ef6980d">ansible-console</a></li>
<li><a href="#h:a32d361b-9c20-4688-afc6-5525c58f5bc4">ansible-galaxy</a></li>
</ul>
</li>
<li><a href="#h:25bf4dd4-f731-4bd9-9896-7d59251394a2">Ansibleå¸¸ç”¨æ¨¡å—</a>
<ul>
<li><a href="#h:284c9372-03a0-4ec2-aaf5-a46b25066651">Command æ¨¡å—</a></li>
<li><a href="#h:39a49c4f-c84c-47a0-870b-84f52bc9d0f4">Shellæ¨¡å—</a></li>
<li><a href="#h:7ccc1a8e-47f6-4b5f-9c2b-3f349b6283da">Scriptæ¨¡å—</a></li>
<li><a href="#h:804c9693-8571-40ad-88b8-81beeba167cc">Copyæ¨¡å—</a></li>
<li><a href="#h:706df931-2107-45c4-9f23-ca2ce81fa5c1">Fetchæ¨¡å—</a></li>
<li><a href="#h:600e3996-6c4d-49be-9adc-6d14233afb0d">Fileæ¨¡å—</a></li>
<li><a href="#h:6aa66dbb-472e-47b6-9a66-6b4e845bd4fe">unarchiveæ¨¡å—</a></li>
<li><a href="#h:cf6723a1-88cb-42c8-b7ab-6098c76d2cb3">Archiveæ¨¡å—</a></li>
<li><a href="#h:ac5aaa58-ca5b-4f82-8a46-105a35e0e580">Hostnameæ¨¡å—</a></li>
<li><a href="#h:b5d8fcf8-e8da-4bf0-8174-f9beb3b1f052">Cronæ¨¡å—</a></li>
<li><a href="#h:9d2752cf-dcdc-48b2-9386-ce7f4b079e14">Yum æ¨¡å— Apt æ¨¡å—</a></li>
<li><a href="#h:a5947938-fdf5-4aac-b0c6-d0d1e1b6427a">Packageæ¨¡å—</a></li>
<li><a href="#h:e624bb8f-5da4-4997-8b22-f18f4d7f1d0f">Serviceæ¨¡å—</a></li>
<li><a href="#h:64477c11-2ec5-404e-b9cb-b954b44cdc51">Useræ¨¡å—</a></li>
<li><a href="#h:78a08001-e7e2-4e38-9f29-c939e7545cdc">Groupæ¨¡å—</a></li>
<li><a href="#h:34495623-4c73-4d50-a762-4b70beaebac3">Lineinfileæ¨¡å—</a></li>
<li><a href="#h:c5687051-26a7-4773-979d-9e7ebd63f2bc">Replaceæ¨¡å—</a></li>
<li><a href="#h:5f76e222-0523-4bfa-9320-c8bc766f486d">Setupæ¨¡å—</a></li>
<li><a href="#h:40d14931-5787-4c91-9c34-ab669223c49f">set_factæ¨¡å—</a></li>
<li><a href="#h:d5483b20-4a08-4c56-9649-e0b44c956110">selinuxæ¨¡å—</a></li>
<li><a href="#h:0d44d365-59a3-45a0-bbec-ee235715e04c">debugæ¨¡å—</a></li>
<li><a href="#h:70380e05-19df-4a86-ba91-e2f8c5aec6ef">filesystemæ¨¡å—</a></li>
<li><a href="#h:2201d13a-1aec-49aa-8e31-9f3bcbe3aefc">mountæ¨¡å—</a></li>
<li><a href="#h:24e119bc-a6d8-4cab-b2a8-cae8ef05e8a3">authorized_keyæ¨¡å—</a></li>
<li><a href="#h:1d7220f3-a61c-4ae4-b2a0-52304622ec42">systemdæ¨¡å—</a></li>
<li><a href="#h:82131cdc-b8cb-4223-a7d0-1ec555c7214e">lineinfileæ¨¡å—</a></li>
<li><a href="#h:ba12198f-b8bf-4a96-9682-539c97c33fd5">synchronizeæ¨¡å—</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:82957dba-6f58-4cdf-ae1a-12db3ee0ccca">Playbook</a>
<ul>
<li><a href="#h:12279fce-9cf9-4abf-9def-1b804ca5a2c0">playbookä»‹ç»</a></li>
<li><a href="#h:6e33e4b5-fad2-4b45-863c-b7c76bfca760">YAML è¯­è¨€</a>
<ul>
<li><a href="#h:8274922d-ed3b-469a-a601-f3e4d23d7de5">YAMl è¯­è¨€ä»‹ç»</a></li>
<li><a href="#h:665fd638-df24-49d6-b680-9b02125db467">YAML è¯­è¨€ç‰¹æ€§</a></li>
<li><a href="#h:bbf71988-e55d-4e8d-a371-223045f7b39c">YAMLè¯­æ³•ç®€ä»‹</a></li>
<li><a href="#h:ba76bc61-0292-4c5b-a0f9-f45a3fdc0a0e">æ”¯æŒçš„æ•°æ®ç±»å‹</a>
<ul>
<li><a href="#h:5bb9f758-9760-4222-8cfc-12b44283542b">scalar æ ‡é‡</a></li>
<li><a href="#h:f9cfd730-a4bf-4caf-af26-999c9138e099">Dictionaryå­—å…¸</a></li>
<li><a href="#h:6a315d07-eae9-4ab7-89fe-5acbd12b6ca5">Liståˆ—è¡¨</a></li>
</ul>
</li>
<li><a href="#h:2de59182-2b01-4c4a-a518-816df9550dd2">ä¸‰ç§å¸¸è§çš„æ•°æ®æ ¼å¼</a></li>
</ul>
</li>
<li><a href="#h:1ef2a223-efdb-4182-9c42-5ae32bac6e9d">Playbook æ ¸å¿ƒç»„ä»¶</a>
<ul>
<li><a href="#h:a47c2523-e7f0-4aff-9af9-16adafba5398">hosts ç»„ä»¶</a></li>
<li><a href="#h:bbc2ad3c-a0b1-446c-a56a-d64472538a1d">remote_user ç»„ä»¶</a></li>
<li><a href="#h:d9248277-dadd-496d-9bd6-a0c203e2f6ad">taskåˆ—è¡¨å’Œactionç»„ä»¶</a></li>
<li><a href="#h:2fbe5631-b9c5-4f43-af46-3f50b4a7ee4b">å…¶å®ƒç»„ä»¶</a></li>
<li><a href="#h:1f8b94d9-f2bb-4821-9d8a-35e5a61034c8">ShellScripts VS Playbook æ¡ˆä¾‹</a></li>
</ul>
</li>
<li><a href="#h:90f0a6a6-bd2c-4a6e-bdaf-fddd8ea1c3d3">playbook å‘½ä»¤</a></li>
<li><a href="#h:cc8a752f-f1c5-4d3c-94ff-e476c563ec18">Playbook åˆæ­¥</a>
<ul>
<li><a href="#h:c421ffdf-e86b-4b2d-915d-5be92b78f934">åˆ©ç”¨ playbook åˆ›å»º mysql ç”¨æˆ·</a></li>
<li><a href="#h:71df824e-7fc3-4e56-bf22-bc2dbb7ab3c9">åˆ©ç”¨ playbook å®‰è£… nginx</a></li>
<li><a href="#h:399a9bc8-f1f3-4e26-876f-b2b9279f2bd9">åˆ©ç”¨ playbook å®‰è£…å’Œå¸è½½ httpd</a></li>
<li><a href="#h:8edf4e09-1c22-4cc5-82a7-c17043cdba1d">åˆ©ç”¨ playbook å®‰è£… mysql</a></li>
</ul>
</li>
<li><a href="#h:48b1755b-669a-4d64-84c7-31ad695adc4b">Playbookä¸­ä½¿ç”¨handlerså’Œnotify</a></li>
<li><a href="#h:0a3aec5f-206c-42ec-83cc-6da69fa06720">Playbookä¸­ä½¿ç”¨tagsç»„ä»¶</a></li>
<li><a href="#h:e06de863-5a87-498b-83c6-3ee055a9206e">Playbookä¸­ä½¿ç”¨å˜é‡</a>
<ul>
<li><a href="#h:f0ba9bee-6110-4a70-9be2-40067a2ce7c1">ä½¿ç”¨ setup æ¨¡å—ä¸­å˜é‡</a></li>
<li><a href="#h:e090a3ba-479e-45f7-a157-e6cd7a18dd95">åœ¨playbook å‘½ä»¤è¡Œä¸­å®šä¹‰å˜é‡</a></li>
<li><a href="#h:0a31f3d4-29d0-4a1c-8f5d-311d8d705a47">åœ¨playbookæ–‡ä»¶ä¸­å®šä¹‰å˜é‡</a></li>
<li><a href="#h:e59a6767-d5f6-421b-987f-666121c1e7d3">ä½¿ç”¨å˜é‡æ–‡ä»¶</a></li>
<li><a href="#h:fd507cde-3910-48c8-b136-a9facc62f707">ä¸»æœºæ¸…å•æ–‡ä»¶ä¸­å®šä¹‰å˜é‡</a>
<ul>
<li><a href="#h:5fbc0907-d431-44ae-af3f-b1a1be551f2a">ä¸»æœºå˜é‡</a></li>
<li><a href="#h:daf87a79-1124-4aeb-b186-50bbef4e4b34">ç»„ï¼ˆå…¬å…±ï¼‰å˜é‡</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:5578fa90-9c01-456a-9bd4-e660f888a8d5">template æ¨¡æ¿</a>
<ul>
<li><a href="#h:24650b76-fac2-4002-aa7d-a0e80b33dd08">jinja2è¯­è¨€</a></li>
<li><a href="#h:4196f992-ed9f-486f-aadc-bb8b9e8fb7df">template</a></li>
<li><a href="#h:c117f799-8788-4b89-aeee-31c20ad9be93">templateä¸­ä½¿ç”¨æµç¨‹æ§åˆ¶ for å’Œ if</a></li>
</ul>
</li>
<li><a href="#h:a285cd08-19dd-4858-bf83-6c8ff2d72fd0">playbookä½¿ç”¨ when</a></li>
<li><a href="#h:bd942071-2cea-48f6-a0cc-045587b70281">playbook ä½¿ç”¨è¿­ä»£ with_items</a></li>
<li><a href="#h:b3da52c8-a8c8-44d5-88af-a63654cb9ddc">ç®¡ç†èŠ‚ç‚¹è¿‡å¤šå¯¼è‡´çš„è¶…æ—¶é—®é¢˜è§£å†³æ–¹æ³•</a></li>
</ul>
</li>
<li><a href="#h:954e685a-1aef-4f59-a35b-8c16371ed21a">rolesè§’è‰²</a>
<ul>
<li><a href="#h:ad6a8b23-f7a6-43d9-8bc1-ad71d94ebfdc">Ansible Rolesç›®å½•ç¼–æ’</a></li>
<li><a href="#h:5d533a95-d2ab-402d-883b-4a41fd54628c">åˆ›å»º role</a></li>
<li><a href="#h:b64d06e1-b9b6-4996-b702-7159938bda55">playbookè°ƒç”¨è§’è‰²</a></li>
<li><a href="#h:62cd23ee-27ee-4a02-885b-0a0fdf45502c">roles ä¸­ tags ä½¿ç”¨</a></li>
<li><a href="#h:63ae80ce-faf4-4826-a393-f616f80e000c">å®æˆ˜æ¡ˆä¾‹</a>
<ul>
<li><a href="#h:6df15f85-1668-4a13-adb7-422464c2fc84">æ¡ˆä¾‹1ï¼šå®ç° httpd è§’è‰²</a></li>
<li><a href="#h:18580821-55a3-41e7-a91a-4b500d8689aa">æ¡ˆä¾‹2ï¼šå®ç° nginx è§’è‰²</a></li>
<li><a href="#h:256f9ea7-7b71-4850-9120-a309c8cee771">æ¡ˆä¾‹3ï¼šå®ç° memcached è§’è‰²</a></li>
<li><a href="#h:b9909bd1-8062-46ae-9fe0-728611cc27f6">æ¡ˆä¾‹4ï¼šå®ç° mysql 5.6 çš„è§’è‰²</a></li>
<li><a href="#h:be894266-6075-47bb-a04e-8ee321be6bb8">æ¡ˆä¾‹5 ï¼šå®ç°å¤šè§’è‰²çš„é€‰æ‹©</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:2a8aebef-4cee-4445-bd56-e180c06604f2">ansible-tower</a>
<ul>
<li><a href="#h:f014f262-ac61-406d-84a0-19bfa0fbc552">ansible-towerå®‰è£…åŠé…ç½®</a></li>
<li><a href="#h:b61ae83f-b84c-4bee-9064-993448316b23">èµ„æºç®¡ç†</a>
<ul>
<li><a href="#h:2e56641a-4ae6-4e27-a821-54173e307d3c">é¡¹ç›®</a></li>
<li><a href="#h:e80a1802-daa9-4874-b0ac-86415e8674bd">æ¸…å•</a></li>
<li><a href="#h:44eec651-7df4-4808-a2ca-6306fc2ede84">å‡­è¯</a></li>
<li><a href="#h:2ebeb837-b1a6-414c-b7b2-bd1d93020f31">æ¨¡æ¿</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:315887f9-3861-4b87-9e22-8c76dbd56ef7">ansible æ¨èå­¦ä¹ èµ„æ–™</a></li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../../index.html">Linux</a></li>
</ul>

<p>
ä¸»è¦å†…å®¹ï¼š
</p>
<ul class="org-ul">
<li><b>è¿ç»´è‡ªåŠ¨åŒ–å‘å±•å†ç¨‹åŠæŠ€æœ¯åº”ç”¨</b></li>
<li><b>Ansibleå‘½ä»¤ä½¿ç”¨</b></li>
<li><b>Ansibleå¸¸ç”¨æ¨¡å—è¯¦è§£</b></li>
<li><b>YAMLè¯­æ³•ç®€ä»‹</b></li>
<li><b>Ansible playbookåŸºç¡€</b></li>
<li><b>Playbookå˜é‡ã€tagsã€handlersä½¿ç”¨</b></li>
<li><b>Playbookæ¨¡æ¿ templates</b></li>
<li><b>Playbookæ¡ä»¶åˆ¤æ–­ when</b></li>
<li><b>Playbookå­—å…¸ with_items</b></li>
<li><b>Ansible Roles</b></li>
</ul>
<section id="outline-container-h:84ddf4e0-a20f-44b6-a137-093f7e4395f2" class="outline-2">
<h2 id="h:84ddf4e0-a20f-44b6-a137-093f7e4395f2">è‡ªåŠ¨åŒ–è¿ç»´åº”ç”¨åœºæ™¯</h2>
<div class="outline-text-2" id="text-h:84ddf4e0-a20f-44b6-a137-093f7e4395f2">
</div>
<div id="outline-container-h:e00bf36d-f4aa-4a87-a172-275b1a8a47ea" class="outline-3">
<h3 id="h:e00bf36d-f4aa-4a87-a172-275b1a8a47ea">äº‘è®¡ç®—è¿ç»´å·¥ç¨‹å¸ˆæ ¸å¿ƒèŒèƒ½</h3>
<div class="outline-text-3" id="text-h:e00bf36d-f4aa-4a87-a172-275b1a8a47ea">
<p>
<b>ç›¸å…³å·¥å…·</b>
</p>

<ul class="org-ul">
<li>ä»£ç ç®¡ç†ï¼ˆSCMï¼‰ï¼šGitHubã€GitLabã€BitBucketã€SubVersion</li>
<li>æ„å»ºå·¥å…·ï¼šmavenã€Antã€Gradle</li>
<li>è‡ªåŠ¨éƒ¨ç½²ï¼šCapistranoã€CodeDeploy</li>
<li>æŒç»­é›†æˆï¼ˆCIï¼‰ï¼šJenkinsã€Travis</li>
<li>é…ç½®ç®¡ç†ï¼šAnsibleã€SaltStackã€Chefã€Puppet</li>
<li>å®¹å™¨ï¼šDockerã€Podmanã€LXCã€ç¬¬ä¸‰æ–¹å‚å•†å¦‚AWS</li>
<li>ç¼–æ’ï¼šKubernetesã€Coreã€Apache Mesos</li>
<li>æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼šZookeeperã€etcdã€Consul</li>
<li>è„šæœ¬è¯­è¨€ï¼špythonã€rubyã€shell</li>
<li>æ—¥å¿—ç®¡ç†ï¼šELKã€Logentries</li>
<li>ç³»ç»Ÿç›‘æ§ï¼šPrometheusã€Zabbixã€Datadogã€Graphiteã€Gangliaã€Nagios</li>
<li>æ€§èƒ½ç›‘æ§ï¼šAppDynamicsã€New Relicã€Splunk</li>
<li>å‹åŠ›æµ‹è¯•ï¼šJMeterã€Blaze Meterã€loader.io</li>
<li>åº”ç”¨æœåŠ¡å™¨ï¼šTomcatã€JBossã€IIS</li>
<li>WebæœåŠ¡å™¨ï¼šApacheã€Nginx</li>
<li>æ•°æ®åº“ï¼šMySQLã€Oracleã€PostgreSQLç­‰å…³ç³»å‹æ•°æ®åº“ï¼›mongoDBã€redisç­‰NoSQLæ•°æ®åº“</li>
<li>é¡¹ç›®ç®¡ç†ï¼ˆPMï¼‰ï¼šJiraã€Asanaã€Taigaã€Trelloã€Basecampã€Pivotal Tracker</li>
</ul>
</div>
</div>
<div id="outline-container-h:878ac49e-6690-43d7-a0d2-209179a708a5" class="outline-3">
<h3 id="h:878ac49e-6690-43d7-a0d2-209179a708a5">è¿ç»´èŒä¸šå‘å±•è·¯çº¿</h3>
<div class="outline-text-3" id="text-h:878ac49e-6690-43d7-a0d2-209179a708a5">
<p>
äº’è”ç½‘è¿ç»´èŒä¸šå‘å±•
</p>
<ul class="org-ul">
<li>åŸºç¡€è¿ç»´</li>
<li>ç›‘æ§è¿ç»´</li>
<li>ç³»ç»Ÿè¿ç»´</li>
<li>åº”ç”¨è¿ç»´</li>
<li>è‡ªåŠ¨åŒ–è¿ç»´</li>
<li>æ¶æ„å¸ˆ</li>
<li>æ€»ç›‘æˆ– CTO</li>
</ul>

<p>
<b>è¿ç»´çš„æœªæ¥æ˜¯ä»€ä¹ˆï¼Ÿ</b>
</p>

<p>
<b>ä¸€åˆ‡çš†è‡ªåŠ¨åŒ–</b>
</p>

<p>
"è¿ç»´çš„æœªæ¥æ˜¯ï¼Œè®©ç ”å‘äººå‘˜èƒ½å¤Ÿå€ŸåŠ©å·¥å…·ã€è‡ªåŠ¨åŒ–å’Œæµç¨‹ï¼Œå¹¶ä¸”è®©ä»–ä»¬èƒ½å¤Ÿåœ¨è¿ç»´å¹²é¢„æå°‘çš„æƒ…å†µä¸‹éƒ¨ç½²å’Œè¿è¥æœåŠ¡ï¼Œä»è€Œå®ç°è‡ªåŠ©æœåŠ¡ã€‚æ¯ä¸ªè§’è‰²éƒ½åº”è¯¥åŠªåŠ›ä½¿å·¥ä½œå®ç°è‡ªåŠ¨åŒ–ã€‚"-&#x2013;&#x2014;ã€Šè¿ç»´çš„æœªæ¥ã€‹
</p>
</div>
</div>
<div id="outline-container-h:2fb2cb41-c298-4a9b-a44d-98c67e3930cd" class="outline-3">
<h3 id="h:2fb2cb41-c298-4a9b-a44d-98c67e3930cd">ä¼ä¸šå®é™…åº”ç”¨åœºæ™¯åˆ†æ</h3>
<div class="outline-text-3" id="text-h:2fb2cb41-c298-4a9b-a44d-98c67e3930cd">

<figure id="org22a7ae5">
<img src="./images/img_20240228_153050.png" alt="img_20240228_153050.png" width="80%">

</figure>
</div>
<div id="outline-container-h:53c855fe-83fc-4725-a2ae-c6c2f25b08a6" class="outline-4">
<h4 id="h:53c855fe-83fc-4725-a2ae-c6c2f25b08a6">Devå¼€å‘ç¯å¢ƒ</h4>
<div class="outline-text-4" id="text-h:53c855fe-83fc-4725-a2ae-c6c2f25b08a6">
<p>
ä½¿ç”¨è€…ï¼šç¨‹åºå‘˜
</p>

<p>
åŠŸèƒ½ï¼šç¨‹åºå‘˜ä¸ªäººçš„åŠå…¬ç”µè„‘æˆ–é¡¹ç›®çš„å¼€å‘æµ‹è¯•ç¯å¢ƒï¼Œéƒ¨ç½²å¼€å‘è½¯ä»¶ï¼Œæµ‹è¯•ä¸ªäººæˆ–é¡¹ç›®æ•´ä½“çš„BUGçš„ç¯å¢ƒ
</p>

<p>
ç®¡ç†è€…ï¼šç¨‹åºå‘˜
</p>
</div>
</div>
<div id="outline-container-h:c7ea20f6-4bc6-4618-ba60-152425106899" class="outline-4">
<h4 id="h:c7ea20f6-4bc6-4618-ba60-152425106899">æµ‹è¯•ç¯å¢ƒ</h4>
<div class="outline-text-4" id="text-h:c7ea20f6-4bc6-4618-ba60-152425106899">
<p>
ä½¿ç”¨è€…ï¼šQAæµ‹è¯•å·¥ç¨‹å¸ˆ
</p>

<p>
åŠŸèƒ½ï¼šæµ‹è¯•ç»è¿‡Devç¯å¢ƒæµ‹è¯•é€šè¿‡çš„è½¯ä»¶çš„åŠŸèƒ½å’Œæ€§èƒ½ï¼Œåˆ¤æ–­æ˜¯å¦è¾¾åˆ°é¡¹ç›®çš„é¢„æœŸç›®æ ‡ï¼Œç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
</p>

<p>
ç®¡ç†è€…ï¼šè¿ç»´
</p>

<p>
è¯´æ˜ï¼šæµ‹è¯•ç¯å¢ƒå¾€å¾€æœ‰å¤šå¥—,æµ‹è¯•ç¯å¢ƒæ»¡è¶³æµ‹è¯•åŠŸèƒ½å³å¯ï¼Œä¸å®œè¿‡å¤š
</p>
<ol class="org-ol">
<li>æµ‹è¯•äººå‘˜å¸Œæœ›æµ‹è¯•ç¯å¢ƒæœ‰å¤šå¥—,å…¬å¸çš„äº§å“å¤šäº§å“çº¿å¹¶å‘ï¼Œå³å¤šä¸ªç‰ˆæœ¬ï¼Œæ„å‘³ç€å¤šä¸ªç‰ˆæœ¬åŒæ­¥æµ‹è¯•</li>
<li>é€šå¸¸æµ‹è¯•ç¯å¢ƒæœ‰å¤šå°‘å¥—å’Œäº§å“çº¿æ•°é‡ä¿æŒä¸€æ ·</li>
</ol>
</div>
</div>
<div id="outline-container-h:88157b54-f096-487d-84a5-4dc2aa10b182" class="outline-4">
<h4 id="h:88157b54-f096-487d-84a5-4dc2aa10b182">é¢„å‘å¸ƒç¯å¢ƒ</h4>
<div class="outline-text-4" id="text-h:88157b54-f096-487d-84a5-4dc2aa10b182">
<p>
ä½¿ç”¨è€…ï¼šè¿ç»´
</p>

<p>
åŠŸèƒ½ï¼šä½¿ç”¨å’Œç”Ÿäº§ç¯å¢ƒä¸€æ ·çš„æ•°æ®åº“ï¼Œç¼“å­˜æœåŠ¡ç­‰é…ç½®ï¼Œæµ‹è¯•æ˜¯å¦æ­£å¸¸
</p>
</div>
</div>
<div id="outline-container-h:37339f10-a627-42f8-89a9-dcfcc70385c4" class="outline-4">
<h4 id="h:37339f10-a627-42f8-89a9-dcfcc70385c4">å‘å¸ƒç¯å¢ƒ</h4>
<div class="outline-text-4" id="text-h:37339f10-a627-42f8-89a9-dcfcc70385c4">
<p>
åŒ…æ‹¬ä»£ç å‘å¸ƒæœºï¼Œæœ‰äº›å…¬å¸ä¸ºå ¡å’æœºï¼ˆå®‰å…¨å±éšœï¼‰
</p>

<p>
ä½¿ç”¨è€…ï¼šè¿ç»´
</p>

<p>
åŠŸèƒ½ï¼šå‘å¸ƒä»£ç è‡³ç”Ÿäº§ç¯å¢ƒ
</p>

<p>
ç®¡ç†è€…ï¼šè¿ç»´ï¼ˆæœ‰ç»éªŒï¼‰
</p>

<p>
å‘å¸ƒæœºï¼šå¾€å¾€éœ€è¦æœ‰2å°ï¼ˆä¸»å¤‡ï¼‰
</p>
</div>
</div>
<div id="outline-container-h:624d4231-0bab-4af5-8d39-1a9f9c9829a3" class="outline-4">
<h4 id="h:624d4231-0bab-4af5-8d39-1a9f9c9829a3">ç”Ÿäº§ç¯å¢ƒ</h4>
<div class="outline-text-4" id="text-h:624d4231-0bab-4af5-8d39-1a9f9c9829a3">
<p>
ä½¿ç”¨è€…ï¼šè¿ç»´ï¼Œå°‘æ•°æƒ…å†µå¼€æ”¾æƒé™ç»™æ ¸å¿ƒå¼€å‘äººå‘˜ï¼Œæå°‘æ•°å…¬å¸å°†æƒé™å®Œå…¨å¼€æ”¾ç»™å¼€å‘äººå‘˜å¹¶å…¶ç»´æŠ¤
</p>

<p>
åŠŸèƒ½ï¼šå¯¹ç”¨æˆ·æä¾›å…¬å¸äº§å“çš„æœåŠ¡
</p>

<p>
ç®¡ç†è€…ï¼šåªèƒ½æ˜¯è¿ç»´
</p>

<p>
ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨æ•°é‡ï¼šä¸€èˆ¬æ¯”è¾ƒå¤šï¼Œä¸”åº”ç”¨éå¸¸é‡è¦ã€‚å¾€å¾€éœ€è¦è‡ªåŠ¨å·¥å…·ååŠ©éƒ¨ç½²é…ç½®åº”ç”¨
</p>
</div>
</div>
<div id="outline-container-h:c7c55a39-f72f-49e2-b1d4-b961e447f9a4" class="outline-4">
<h4 id="h:c7c55a39-f72f-49e2-b1d4-b961e447f9a4">ç°åº¦ç¯å¢ƒ å±äºç”Ÿäº§ç¯å¢ƒçš„ä¸€éƒ¨åˆ†</h4>
<div class="outline-text-4" id="text-h:c7c55a39-f72f-49e2-b1d4-b961e447f9a4">
<p>
ä½¿ç”¨è€…ï¼šè¿ç»´
</p>

<p>
åŠŸèƒ½ï¼šåœ¨å…¨é‡å‘å¸ƒä»£ç å‰å°†ä»£ç çš„åŠŸèƒ½é¢å‘å°‘é‡ç²¾å‡†ç”¨æˆ·å‘å¸ƒçš„ç¯å¢ƒ,å¯åŸºäºä¸»æœºæˆ–ç”¨æˆ·æ‰§è¡Œç°åº¦å‘å¸ƒ
</p>

<p>
æ¡ˆä¾‹ï¼šå…±100å°ç”Ÿäº§æœåŠ¡å™¨ï¼Œå…ˆå‘å¸ƒå…¶ä¸­çš„10å°æœåŠ¡å™¨ï¼Œè¿™10å°æœåŠ¡å™¨å°±æ˜¯ç°åº¦æœåŠ¡å™¨
</p>

<p>
ç®¡ç†è€…ï¼šè¿ç»´
</p>

<p>
ç°åº¦ç¯å¢ƒï¼šå¾€å¾€è¯¥ç‰ˆæœ¬åŠŸèƒ½å˜æ›´è¾ƒå¤§ï¼Œä¸ºä¿é™©èµ·è§ç‰¹æ„å…ˆè®©ä¸€éƒ¨åˆ†ç”¨æˆ·ä¼˜åŒ–ä½“éªŒè¯¥åŠŸèƒ½ï¼Œå¾…è¿™éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨æ²¡æœ‰é‡å¤§é—®é¢˜çš„æ—¶å€™ï¼Œå†å…¨é‡å‘å¸ƒè‡³æ‰€æœ‰æœåŠ¡å™¨
</p>
</div>
</div>
</div>
<div id="outline-container-h:b00cf7e0-b5cc-4bfe-b124-e525e9e9a5cf" class="outline-3">
<h3 id="h:b00cf7e0-b5cc-4bfe-b124-e525e9e9a5cf">ç¨‹åºå‘å¸ƒ</h3>
<div class="outline-text-3" id="text-h:b00cf7e0-b5cc-4bfe-b124-e525e9e9a5cf">
<p>
ç¨‹åºå‘å¸ƒè¦æ±‚ï¼š
</p>

<ul class="org-ul">
<li>ä¸èƒ½å¯¼è‡´ç³»ç»Ÿæ•…éšœæˆ–é€ æˆç³»ç»Ÿå®Œå…¨ä¸å¯ç”¨</li>
<li>ä¸èƒ½å½±å“ç”¨æˆ·ä½“éªŒ</li>
</ul>

<p>
é¢„å‘å¸ƒéªŒè¯ï¼š
</p>
<ul class="org-ul">
<li>æ–°ç‰ˆæœ¬çš„ä»£ç å…ˆå‘å¸ƒåˆ°æœåŠ¡å™¨ï¼ˆè·Ÿçº¿ä¸Šç¯å¢ƒé…ç½®å®Œå…¨ç›¸åŒï¼Œåªæ˜¯æœªæ¥å…¥åˆ°è°ƒåº¦å™¨ï¼‰</li>
</ul>

<p>
ç°åº¦å‘å¸ƒï¼š
</p>
<ul class="org-ul">
<li>åŸºäºä¸»æœºï¼Œç”¨æˆ·ï¼Œä¸šåŠ¡</li>
</ul>

<p>
å‘å¸ƒè·¯å¾„ï¼š
</p>
<ul class="org-ul">
<li>/webapp/tuangou</li>
<li>/webapp/tuangou-1.1</li>
<li>/webapp/tuangou-1.2</li>
</ul>

<p>
<b>å‘å¸ƒè¿‡ç¨‹</b> ï¼š
</p>

<ol class="org-ol">
<li>åœ¨è°ƒåº¦å™¨ä¸Šä¸‹çº¿ä¸€æ‰¹ä¸»æœº(æ ‡è®°ä¸ºmaintenance çŠ¶æ€)</li>
<li>å…³é—­æœåŠ¡</li>
<li>éƒ¨ç½²æ–°ç‰ˆæœ¬çš„åº”ç”¨ç¨‹åº</li>
<li>å¯åŠ¨æœåŠ¡</li>
<li>åœ¨è°ƒåº¦å™¨ä¸Šå¯ç”¨è¿™ä¸€æ‰¹æœåŠ¡å™¨</li>
</ol>

<p>
è‡ªåŠ¨åŒ–ç°åº¦å‘å¸ƒï¼š
</p>

<ul class="org-ul">
<li>è„šæœ¬</li>
<li>å‘å¸ƒå¹³å°</li>
</ul>
</div>
</div>
<div id="outline-container-h:7540fba6-cda0-49cc-b84f-c3a7e6bd286a" class="outline-3">
<h3 id="h:7540fba6-cda0-49cc-b84f-c3a7e6bd286a">è‡ªåŠ¨åŒ–è¿ç»´åº”ç”¨åœºæ™¯</h3>
<div class="outline-text-3" id="text-h:7540fba6-cda0-49cc-b84f-c3a7e6bd286a">
<ul class="org-ul">
<li>æ–‡ä»¶ä¼ è¾“</li>
<li>åº”ç”¨éƒ¨ç½²</li>
<li>é…ç½®ç®¡ç†</li>
<li>ä»»åŠ¡æµç¼–æ’</li>
</ul>
</div>
</div>
<div id="outline-container-h:a8e4ed7b-1df1-4fd3-98cc-8ad4ae635c33" class="outline-3">
<h3 id="h:a8e4ed7b-1df1-4fd3-98cc-8ad4ae635c33">å¸¸ç”¨è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·</h3>
<div class="outline-text-3" id="text-h:a8e4ed7b-1df1-4fd3-98cc-8ad4ae635c33">
<ul class="org-ul">
<li>Ansibleï¼špythonï¼ŒAgentlessï¼Œä¸­å°å‹åº”ç”¨ç¯å¢ƒ</li>
<li>Saltstackï¼špythonï¼Œä¸€èˆ¬éœ€éƒ¨ç½²agentï¼Œæ‰§è¡Œæ•ˆç‡æ›´é«˜</li>
<li>Puppetï¼šruby, åŠŸèƒ½å¼ºå¤§ï¼Œé…ç½®å¤æ‚ï¼Œé‡å‹ï¼Œé€‚åˆå¤§å‹ç¯å¢ƒ</li>
<li>Fabricï¼špythonï¼Œagentless</li>
<li>Chefï¼šrubyï¼Œå›½å†…åº”ç”¨å°‘</li>
<li>Cfengine</li>
<li>func</li>
</ul>

<p>
åŒç±»è‡ªåŠ¨åŒ–å·¥å…·GitHubå…³æ³¨ç¨‹åº¦ï¼ˆ2016-07-10ï¼‰
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">è‡ªåŠ¨åŒ–è¿ç»´å·¥ å…·</th>
<th scope="col" class="org-right">Watchï¼ˆå…³ æ³¨ï¼‰</th>
<th scope="col" class="org-right">Starï¼ˆç‚¹ èµï¼‰</th>
<th scope="col" class="org-right">Forkï¼ˆå¤ åˆ¶ï¼‰</th>
<th scope="col" class="org-right">Contributors(è´¡çŒ® è€…)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Ansible</td>
<td class="org-right">1387</td>
<td class="org-right">17716</td>
<td class="org-right">5356</td>
<td class="org-right">1428</td>
</tr>

<tr>
<td class="org-left">Saltstack</td>
<td class="org-right">530</td>
<td class="org-right">6678</td>
<td class="org-right">3002</td>
<td class="org-right">1520</td>
</tr>

<tr>
<td class="org-left">Puppet</td>
<td class="org-right">463</td>
<td class="org-right">4044</td>
<td class="org-right">1678</td>
<td class="org-right">425</td>
</tr>

<tr>
<td class="org-left">Chef</td>
<td class="org-right">383</td>
<td class="org-right">4333</td>
<td class="org-right">1806</td>
<td class="org-right">464</td>
</tr>

<tr>
<td class="org-left">Fabric</td>
<td class="org-right">379</td>
<td class="org-right">7334</td>
<td class="org-right">1235</td>
<td class="org-right">116</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="outline-container-h:35249014-b3c0-458d-a069-333d648cea5d" class="outline-2">
<h2 id="h:35249014-b3c0-458d-a069-333d648cea5d">Ansible ä»‹ç»å’Œæ¶æ„</h2>
<div class="outline-text-2" id="text-h:35249014-b3c0-458d-a069-333d648cea5d">
<p>
å…¬å¸è®¡åˆ’åœ¨å¹´åº•åšä¸€æ¬¡å¤§å‹å¸‚åœºä¿ƒé”€æ´»åŠ¨ï¼Œå…¨é¢å†²åˆºä¸‹äº¤æ˜“é¢ï¼Œä¸ºæ˜å¹´çš„ä¸Šå¸‚åšå‡†å¤‡ã€‚å…¬å¸è¦æ±‚å„ä¸šåŠ¡ç»„å¯¹å¹´åº•å¤§ä¿ƒåšå‡†å¤‡ï¼Œè¿ç»´éƒ¨è¦æ±‚æ‰€æœ‰ä¸šåŠ¡å®¹é‡è¿›è¡Œä¸‰å€çš„æ‰©å®¹ï¼Œå¹¶æ­å»ºå‡ºå¤šå¥—ç¯å¢ƒå¯ä»¥å…±å¼€å‘å’Œæµ‹è¯•äººå‘˜åšæµ‹è¯•ï¼Œè¿ç»´è€å¤§ä¸ºäº†åœ¨å¹´åº•æœ‰æ‰€è¡¨ç°ï¼Œè¦æ±‚è¿ç»´éƒ¨é—¨åŒå­¦å°½å¿«å®ç°ï¼Œå½“ä½ æ¥åˆ°è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œæœ‰æ²¡æœ‰æ›´å¿«çš„è§£å†³æ–¹æ¡ˆï¼Ÿ
</p>
</div>
<div id="outline-container-h:4bce6968-88de-4ec0-ac27-f93039636b84" class="outline-3">
<h3 id="h:4bce6968-88de-4ec0-ac27-f93039636b84">Ansibleå‘å±•å²</h3>
<div class="outline-text-3" id="text-h:4bce6968-88de-4ec0-ac27-f93039636b84">
<p>
ä½œè€…ï¼šMichael DeHaanï¼ˆ Cobbler ä¸ Func ä½œè€…ï¼‰
</p>

<p>
ansible
çš„åç§°æ¥è‡ªç§‘å¹»å°è¯´ã€Šå®‰å¾·çš„æ¸¸æˆã€‹ä¸­è·¨è¶Šæ—¶ç©ºçš„å³æ—¶é€šä¿¡å·¥å…·ï¼Œä½¿ç”¨å®ƒå¯ä»¥åœ¨ç›¸è·æ•°å…‰å¹´çš„è·ç¦»ï¼Œè¿œç¨‹å®æ—¶æ§åˆ¶å‰çº¿çš„èˆ°é˜Ÿæˆ˜æ–—ã€‚
</p>

<p>
2012-03-09ï¼Œå‘å¸ƒ0.0.1ç‰ˆï¼Œ2015-10-17ï¼ŒRed Hatå®£å¸ƒ1.5äº¿ç¾å…ƒæ”¶è´­
</p>

<p>
å®˜ç½‘ï¼š<a href="https://www.ansible.com/">https://www.ansible.com/</a>
</p>

<p>
å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://docs.ansible.com/">https://docs.ansible.com/</a>
</p>
</div>
</div>
<div id="outline-container-h:92bd14bf-7d89-429e-92cb-ebddc0951e01" class="outline-3">
<h3 id="h:92bd14bf-7d89-429e-92cb-ebddc0951e01">Ansible ç‰¹æ€§</h3>
<div class="outline-text-3" id="text-h:92bd14bf-7d89-429e-92cb-ebddc0951e01">
<ul class="org-ul">
<li><b>æ¨¡å—åŒ–</b> ï¼šè°ƒç”¨ç‰¹å®šçš„æ¨¡å—å®Œæˆç‰¹å®šä»»åŠ¡ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¨¡å—ï¼Œå¯ä½¿ç”¨ä»»ä½•ç¼–ç¨‹è¯­è¨€å†™æ¨¡å—</li>
<li>Paramikoï¼ˆpythonå¯¹sshçš„å®ç°ï¼‰ï¼ŒPyYAMLï¼ŒJinja2ï¼ˆæ¨¡æ¿è¯­è¨€ï¼‰ä¸‰ä¸ªå…³é”®æ¨¡å—</li>
<li>åŸºäºPythonè¯­è¨€å®ç°</li>
<li><b>éƒ¨ç½²ç®€å•ï¼ŒåŸºäºpythonå’ŒSSH(é»˜è®¤å·²å®‰è£…)ï¼Œagentlessï¼Œæ— éœ€ä»£ç†ä¸ä¾èµ–PKIï¼ˆæ— éœ€sslï¼‰</b></li>
<li>å®‰å…¨ï¼ŒåŸºäºOpenSSH</li>
<li>å¹‚ç­‰æ€§ï¼š <b>ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ1éå’Œæ‰§è¡Œnéæ•ˆæœä¸€æ ·ï¼Œä¸å› é‡å¤æ‰§è¡Œå¸¦æ¥æ„å¤–æƒ…å†µ</b></li>
<li>æ”¯æŒplaybookç¼–æ’ä»»åŠ¡ï¼ŒYAMLæ ¼å¼ï¼Œç¼–æ’ä»»åŠ¡ï¼Œæ”¯æŒä¸°å¯Œçš„æ•°æ®ç»“æ„</li>
<li>è¾ƒå¼ºå¤§çš„å¤šå±‚è§£å†³æ–¹æ¡ˆ role</li>
</ul>
</div>
</div>
<div id="outline-container-h:070857b8-2694-472b-aa9a-f849de0453e6" class="outline-3">
<h3 id="h:070857b8-2694-472b-aa9a-f849de0453e6">Ansible æ¶æ„</h3>
<div class="outline-text-3" id="text-h:070857b8-2694-472b-aa9a-f849de0453e6">
</div>
<div id="outline-container-h:2e6a17ca-c051-4dc2-8b33-9f44d2ecd4d2" class="outline-4">
<h4 id="h:2e6a17ca-c051-4dc2-8b33-9f44d2ecd4d2">Ansible ç»„æˆ</h4>
<div class="outline-text-4" id="text-h:2e6a17ca-c051-4dc2-8b33-9f44d2ecd4d2">
<p>
ç»„åˆINVENTORYã€APIã€MODULESã€PLUGINSçš„ç»¿æ¡†ï¼Œä¸ºansibleå‘½ä»¤å·¥å…·ï¼Œå…¶ä¸ºæ ¸å¿ƒæ‰§è¡Œå·¥å…·
</p>

<ul class="org-ul">
<li>INVENTORYï¼šAnsibleç®¡ç†ä¸»æœºçš„æ¸…å•/etc/anaible/hosts</li>
<li>MODULESï¼šAnsibleæ‰§è¡Œå‘½ä»¤çš„åŠŸèƒ½æ¨¡å—ï¼Œå¤šæ•°ä¸ºå†…ç½®æ ¸å¿ƒæ¨¡å—ï¼Œä¹Ÿå¯è‡ªå®šä¹‰</li>
<li>PLUGINSï¼šæ¨¡å—åŠŸèƒ½çš„è¡¥å……ï¼Œå¦‚è¿æ¥ç±»å‹æ’ä»¶ã€å¾ªç¯æ’ä»¶ã€å˜é‡æ’ä»¶ã€è¿‡æ»¤æ’ä»¶ç­‰ï¼Œè¯¥åŠŸèƒ½ä¸å¸¸ç”¨</li>
<li>APIï¼šä¾›ç¬¬ä¸‰æ–¹ç¨‹åºè°ƒç”¨çš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£</li>
</ul>
</div>
</div>
<div id="outline-container-h:c839818d-7871-40f7-92e9-465c6e65b3b2" class="outline-4">
<h4 id="h:c839818d-7871-40f7-92e9-465c6e65b3b2">Ansible å‘½ä»¤æ‰§è¡Œæ¥æº</h4>
<div class="outline-text-4" id="text-h:c839818d-7871-40f7-92e9-465c6e65b3b2">
<ul class="org-ul">
<li>USER æ™®é€šç”¨æˆ·ï¼Œå³SYSTEM ADMINISTRATOR</li>
<li>PLAYBOOKSï¼šä»»åŠ¡å‰§æœ¬ï¼ˆä»»åŠ¡é›†ï¼‰ï¼Œç¼–æ’å®šä¹‰Ansibleä»»åŠ¡é›†çš„é…ç½®æ–‡ä»¶ï¼Œç”±
Ansibleé¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œé€šå¸¸æ˜¯JSONæ ¼å¼çš„YMLæ–‡ä»¶</li>
<li>CMDBï¼ˆé…ç½®ç®¡ç†æ•°æ®åº“ï¼‰ API è°ƒç”¨</li>
<li>PUBLIC/PRIVATE CLOUD APIè°ƒç”¨</li>
<li>USER-&gt; Ansible Playbook -&gt; Ansibile</li>
</ul>
</div>
</div>
<div id="outline-container-h:6cea1437-469b-4962-8326-24b59a218c34" class="outline-4">
<h4 id="h:6cea1437-469b-4962-8326-24b59a218c34">æ³¨æ„äº‹é¡¹</h4>
<div class="outline-text-4" id="text-h:6cea1437-469b-4962-8326-24b59a218c34">
<ul class="org-ul">
<li>æ‰§è¡Œansibleçš„ä¸»æœºä¸€èˆ¬ç§°ä¸ºä¸»æ§ç«¯ï¼Œä¸­æ§ï¼Œmasteræˆ–å ¡å’æœº</li>
<li>ä¸»æ§ç«¯Pythonç‰ˆæœ¬éœ€è¦2.6æˆ–ä»¥ä¸Š</li>
<li>è¢«æ§ç«¯Pythonç‰ˆæœ¬å°äº2.4ï¼Œéœ€è¦å®‰è£…python-simplejson</li>
<li>è¢«æ§ç«¯å¦‚å¼€å¯SELinuxéœ€è¦å®‰è£…libselinux-python</li>
<li>windows ä¸èƒ½åšä¸ºä¸»æ§ç«¯</li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-h:a6322f5b-fbe6-434d-99cc-3ba6b3c1de9a" class="outline-2">
<h2 id="h:a6322f5b-fbe6-434d-99cc-3ba6b3c1de9a">Ansible å®‰è£…å’Œå…¥é—¨</h2>
<div class="outline-text-2" id="text-h:a6322f5b-fbe6-434d-99cc-3ba6b3c1de9a">
</div>
<div id="outline-container-h:e418aeb6-ad79-40b1-9eb3-daa673656b6e" class="outline-3">
<h3 id="h:e418aeb6-ad79-40b1-9eb3-daa673656b6e">Ansibleå®‰è£…</h3>
<div class="outline-text-3" id="text-h:e418aeb6-ad79-40b1-9eb3-daa673656b6e">
<p>
ansibleçš„å®‰è£…æ–¹æ³•æœ‰å¤šç§
</p>

<p>
å®˜æ–¹æ–¹æ¡£: <a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html">https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html</a>
</p>

<p>
ä¸‹è½½ï¼š <a href="https://releases.ansible.com/ansible/">https://releases.ansible.com/ansible/</a>
</p>

<p>
pip ä¸‹è½½ï¼š <a href="https://pypi.org/project/ansible/">https://pypi.org/project/ansible/</a>
</p>
</div>
<div id="outline-container-h:8cdbc965-e214-4d61-a76b-489bf6f08c0c" class="outline-4">
<h4 id="h:8cdbc965-e214-4d61-a76b-489bf6f08c0c">EPELæºçš„rpmåŒ…å®‰è£…:</h4>
<div class="outline-text-4" id="text-h:8cdbc965-e214-4d61-a76b-489bf6f08c0c">
<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#yum install ansible
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ce27d17e-96c4-4767-9898-b0b5aaa23630" class="outline-4">
<h4 id="h:ce27d17e-96c4-4767-9898-b0b5aaa23630">ç¼–è¯‘å®‰è£…</h4>
<div class="outline-text-4" id="text-h:ce27d17e-96c4-4767-9898-b0b5aaa23630">
<div class="org-src-container">
<pre class="src src-sh">yum -y install python-jinja2 PyYAML python-paramiko python-babel python-crypto
wget https://releases.ansible.com/ansible/ansible-1.5.4.tar.gz
tar xf ansible-1.5.4.tar.gz
<span style="color: #483d8b;">cd</span> ansible-1.5.4
python setup.py build
python setup.py install
mkdir /etc/ansible
cp -r examples/* /etc/ansible
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2759777f-d498-40f8-9865-11652fc765ea" class="outline-4">
<h4 id="h:2759777f-d498-40f8-9865-11652fc765ea">Gitæ–¹å¼</h4>
<div class="outline-text-4" id="text-h:2759777f-d498-40f8-9865-11652fc765ea">
<div class="org-src-container">
<pre class="src src-sh">git clone git://github.com/ansible/ansible.git --recursive
<span style="color: #483d8b;">cd</span> ./ansible
<span style="color: #483d8b;">source</span> ./hacking/env-setup
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e4102489-974c-4709-9c4c-d979a2a3e5ae" class="outline-4">
<h4 id="h:e4102489-974c-4709-9c4c-d979a2a3e5ae">pip å®‰è£…</h4>
<div class="outline-text-4" id="text-h:e4102489-974c-4709-9c4c-d979a2a3e5ae">
<p>
pip æ˜¯å®‰è£…PythonåŒ…çš„ç®¡ç†å™¨ï¼Œç±»ä¼¼ yum
</p>

<div class="org-src-container">
<pre class="src src-sh">yum install python-pip python-devel
yum install gcc glibc-devel zibl-devel rpm-bulid openssl-devel
pip install --upgrade pip
pip install ansible --upgrade
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7d6ab60f-1897-4ff9-9e1f-c4fac0f70269" class="outline-4">
<h4 id="h:7d6ab60f-1897-4ff9-9e1f-c4fac0f70269">ç¡®è®¤å®‰è£…</h4>
<div class="outline-text-4" id="text-h:7d6ab60f-1897-4ff9-9e1f-c4fac0f70269">
<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#ansible --version
ansible 2.9.5
  config <span style="color: #a0522d;">file</span> = /etc/ansible/ansible.cfg
  configured module search <span style="color: #a0522d;">path</span> = [<span style="color: #8b2252;">'/root/.ansible/plugins/modules'</span>, <span style="color: #8b2252;">'/usr/share/ansible/plugins/modules'</span>]
  ansible python module <span style="color: #a0522d;">location</span> = /usr/lib/python3.6/site-packages/ansible
  executable <span style="color: #a0522d;">location</span> = /usr/bin/ansible
  python <span style="color: #a0522d;">version</span> = 3.6.8 (default, Nov 21 2019, 19:31:34) [GCC 8.3.1 20190507 (Red Hat 8.3.1-4)]
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:86a88466-07b0-401a-b428-787307c160e0" class="outline-3">
<h3 id="h:86a88466-07b0-401a-b428-787307c160e0">Ansible ç›¸å…³æ–‡ä»¶</h3>
<div class="outline-text-3" id="text-h:86a88466-07b0-401a-b428-787307c160e0">
</div>
<div id="outline-container-h:cbe39e12-926d-431e-9cdb-6e5a34b5f3dc" class="outline-4">
<h4 id="h:cbe39e12-926d-431e-9cdb-6e5a34b5f3dc">é…ç½®æ–‡ä»¶</h4>
<div class="outline-text-4" id="text-h:cbe39e12-926d-431e-9cdb-6e5a34b5f3dc">
<ul class="org-ul">
<li>/etc/ansible/ansible.cfg ä¸»é…ç½®æ–‡ä»¶ï¼Œé…ç½®ansibleå·¥ä½œç‰¹æ€§</li>
<li>/etc/ansible/hosts ä¸»æœºæ¸…å•</li>
<li><i>etc/ansible/roles</i> å­˜æ”¾è§’è‰²çš„ç›®å½•</li>
</ul>
</div>
</div>
<div id="outline-container-h:63523d2b-9f1d-4d0f-b83c-f115973989c6" class="outline-4">
<h4 id="h:63523d2b-9f1d-4d0f-b83c-f115973989c6">ansibleä¸»é…ç½®æ–‡ä»¶</h4>
<div class="outline-text-4" id="text-h:63523d2b-9f1d-4d0f-b83c-f115973989c6">
<p>
Ansible çš„é…ç½®æ–‡ä»¶ /etc/ansible/ansible.cfg ,å…¶ä¸­å¤§éƒ¨åˆ†çš„é…ç½®å†…å®¹æ— éœ€
è¿›è¡Œä¿®æ”¹
</p>

<div class="org-src-container">
<pre class="src src-sh">[defaults]
<span style="color: #b22222;">#</span><span style="color: #b22222;">inventory = /etc/ansible/hosts # &#20027;&#26426;&#21015;&#34920;&#37197;&#32622;&#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">library = /usr/share/my_modules/ # &#24211;&#25991;&#20214;&#23384;&#25918;&#30446;&#24405;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">remote_tmp = $HOME/.ansible/tmp #&#20020;&#26102;py&#21629;&#20196;&#25991;&#20214;&#23384;&#25918;&#22312;&#36828;&#31243;&#20027;&#26426;&#30446;&#24405;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">local_tmp = $HOME/.ansible/tmp # &#26412;&#26426;&#30340;&#20020;&#26102;&#21629;&#20196;&#25191;&#34892;&#30446;&#24405;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">forks = 5 # &#40664;&#35748;&#24182;&#21457;&#25968;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">sudo_user = root # &#40664;&#35748;sudo &#29992;&#25143;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ask_sudo_pass = True #&#27599;&#27425;&#25191;&#34892;ansible&#21629;&#20196;&#26159;&#21542;&#35810;&#38382;ssh&#23494;&#30721;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ask_pass = True</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">remote_port = 22</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">host_key_checking = False # &#26816;&#26597;&#23545;&#24212;&#26381;&#21153;&#22120;&#30340;host_key&#65292;&#24314;&#35758;&#21462;&#28040;&#27880;&#37322;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">log_path=/var/log/ansible.log #&#26085;&#24535;&#25991;&#20214;&#65292;&#24314;&#35758;&#21551;&#29992;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">module_name = command #&#40664;&#35748;&#27169;&#22359;&#65292;&#21487;&#20197;&#20462;&#25913;&#20026;shell&#27169;&#22359;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:79d691b8-68d5-4af2-b503-a3874d5d8ab7" class="outline-4">
<h4 id="h:79d691b8-68d5-4af2-b503-a3874d5d8ab7">inventory ä¸»æœºæ¸…å•</h4>
<div class="outline-text-4" id="text-h:79d691b8-68d5-4af2-b503-a3874d5d8ab7">
<p>
ansibleçš„ä¸»è¦åŠŸç”¨åœ¨äºæ‰¹é‡ä¸»æœºæ“ä½œï¼Œä¸ºäº†ä¾¿æ·åœ°ä½¿ç”¨å…¶ä¸­çš„éƒ¨åˆ†ä¸»æœºï¼Œå¯ä»¥
åœ¨inventory fileä¸­å°†å…¶åˆ†ç»„å‘½å
</p>

<p>
é»˜è®¤çš„inventory fileä¸º <code>/etc/ansible/hosts</code>
</p>

<p>
inventory fileå¯ä»¥æœ‰å¤šä¸ªï¼Œä¸”ä¹Ÿå¯ä»¥é€šè¿‡Dynamic Inventoryæ¥åŠ¨æ€ç”Ÿæˆ
</p>

<p>
å®˜æ–¹æ–‡æ¡£ï¼š <a href="https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html">https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html</a>
</p>

<p>
<b>ä¸»æœºæ¸…å•æ–‡ä»¶æ ¼å¼</b>
</p>

<p>
inventoryæ–‡ä»¶éµå¾ªINIæ–‡ä»¶é£æ ¼ï¼Œä¸­æ‹¬å·ä¸­çš„å­—ç¬¦ä¸ºç»„åã€‚å¯ä»¥å°†åŒä¸€ä¸ªä¸»æœºåŒæ—¶å½’å¹¶åˆ°å¤šä¸ªä¸åŒçš„ç»„ä¸­
</p>

<p>
æ­¤å¤–ï¼Œå½“å¦‚è‹¥ç›®æ ‡ä¸»æœºä½¿ç”¨äº†éé»˜è®¤çš„SSHç«¯å£ï¼Œè¿˜å¯ä»¥åœ¨ä¸»æœºåç§°ä¹‹åä½¿ç”¨å†’å·åŠ ç«¯å£å·æ¥æ ‡æ˜
</p>

<p>
å¦‚æœä¸»æœºåç§°éµå¾ªç›¸ä¼¼çš„å‘½åæ¨¡å¼ï¼Œè¿˜å¯ä»¥ä½¿ç”¨åˆ—è¡¨çš„æ–¹å¼æ ‡è¯†å„ä¸»æœº
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">ntp.cici.com
[webservers]
www1.cici.com:2222
www2.cici.com

[dbservers]
db1.cici.com
db2.cici.com
db3.cici.com

[websrvs]
www[1:100].example.com

[dbsrvs]
db-[a:f].example.com

[appsrvs]
10.0.0.[1:100]
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>
<div class="org-src-container">
<pre class="src src-sh">[test]
10.0.0.8  <span style="color: #a0522d;">ansible_connection</span>=local  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#26412;&#22320;&#36830;&#25509;,&#26080;&#38656;ssh&#37197;&#32622;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">ansible_connection=ssh &#38656;&#35201;StrictHostKeyChecking no</span>
10.0.0.7  <span style="color: #a0522d;">ansible_connection</span>=ssh  <span style="color: #a0522d;">ansible_port</span>=2222  <span style="color: #a0522d;">ansible_user</span>=wang <span style="color: #a0522d;">ansible_password</span>=magedu 
10.0.0.6  <span style="color: #a0522d;">ansible_connection</span>=ssh  <span style="color: #a0522d;">ansible_user</span>=root  <span style="color: #a0522d;">ansible_password</span>=123456 
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:f638a674-924e-48d3-a6c9-a6586dfdd727" class="outline-3">
<h3 id="h:f638a674-924e-48d3-a6c9-a6586dfdd727">Ansibleç›¸å…³å·¥å…·</h3>
<div class="outline-text-3" id="text-h:f638a674-924e-48d3-a6c9-a6586dfdd727">
<ul class="org-ul">
<li>/usr/bin/ansible ä¸»ç¨‹åºï¼Œä¸´æ—¶å‘½ä»¤æ‰§è¡Œå·¥å…·</li>
<li>/usr/bin/ansible-doc æŸ¥çœ‹é…ç½®æ–‡æ¡£ï¼Œæ¨¡å—åŠŸèƒ½æŸ¥çœ‹å·¥å…·,ç›¸å½“äºman</li>
<li>/usr/bin/ansible-playbook å®šåˆ¶è‡ªåŠ¨åŒ–ä»»åŠ¡ï¼Œç¼–æ’å‰§æœ¬å·¥å…·,ç›¸å½“äºè„šæœ¬</li>
<li>/usr/bin/ansible-pull è¿œç¨‹æ‰§è¡Œå‘½ä»¤çš„å·¥å…·</li>
<li>/usr/bin/ansible-vault æ–‡ä»¶åŠ å¯†å·¥å…·</li>
<li>/usr/bin/ansible-console åŸºäºConsoleç•Œé¢ä¸ç”¨æˆ·äº¤äº’çš„æ‰§è¡Œå·¥å…·</li>
<li>/usr/bin/ansible-galaxy ä¸‹è½½/ä¸Šä¼ ä¼˜ç§€ä»£ç æˆ–Rolesæ¨¡å—çš„å®˜ç½‘å¹³å°</li>
</ul>

<p>
<b>åˆ©ç”¨ansibleå®ç°ç®¡ç†çš„ä¸»è¦æ–¹å¼</b> ï¼š
</p>

<ul class="org-ul">
<li>Ad-Hoc å³åˆ©ç”¨ansibleå‘½ä»¤ï¼Œä¸»è¦ç”¨äºä¸´æ—¶å‘½ä»¤ä½¿ç”¨åœºæ™¯</li>
<li>Ansible-playbookä¸»è¦ç”¨äºé•¿æœŸè§„åˆ’å¥½çš„ï¼Œå¤§å‹é¡¹ç›®çš„åœºæ™¯ï¼Œéœ€è¦æœ‰å‰æœŸçš„è§„
åˆ’è¿‡ç¨‹</li>
</ul>
</div>
<div id="outline-container-h:3b262897-d4e8-4dae-b624-4ad45d43de4c" class="outline-4">
<h4 id="h:3b262897-d4e8-4dae-b624-4ad45d43de4c">ansible-doc</h4>
<div class="outline-text-4" id="text-h:3b262897-d4e8-4dae-b624-4ad45d43de4c">
<p>
æ­¤å·¥å…·ç”¨æ¥æ˜¾ç¤ºæ¨¡å—å¸®åŠ©
</p>

<p>
æ ¼å¼
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible-doc [options] [module...]
-l, --list <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#21487;&#29992;&#27169;&#22359;</span>
-s, --snippet <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#25351;&#23450;&#27169;&#22359;&#30340;playbook&#29255;&#27573;</span>
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;&#27169;&#22359;</span>
ansible-doc -l
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#27169;&#22359;&#24110;&#21161;&#29992;&#27861;</span>
ansible-doc ping
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#27169;&#22359;&#24110;&#21161;&#29992;&#27861;</span>
ansible-doc -s ping
</pre>
</div>

<p>
èŒƒä¾‹:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#date
Wed Jun 17 16:08:09 CST 2020
[root@ansible ~]#ansible --version
ansible 2.9.9
  config <span style="color: #a0522d;">file</span> = /etc/ansible/ansible.cfg
  configured module search <span style="color: #a0522d;">path</span> = [<span style="color: #8b2252;">'/root/.ansible/plugins/modules'</span>, <span style="color: #8b2252;">'/usr/share/ansible/plugins/modules'</span>]
  ansible python module <span style="color: #a0522d;">location</span> = /usr/lib/python3.6/site-packages/ansible
  executable <span style="color: #a0522d;">location</span> = /usr/bin/ansible
  python <span style="color: #a0522d;">version</span> = 3.6.8 (default, May 21 2019, 23:51:36) [GCC 8.2.1 20180905 (Red Hat 8.2.1-3)]

[root@ansible ~]#ansible-doc -l|wc -l
3387

[root@ansible ~]#ansible-doc -s ping
- name: Try to connect to host, verify a usable python and return <span style="color: #ff00ff;">`pong' on success</span>
<span style="color: #ff00ff;">  ping:</span>
<span style="color: #ff00ff;">      data:     # Data to return for the `</span>ping<span style="color: #8b2252;">' return value. If this                     parameter is set to `crash'</span>, the module will cause an                     exception.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e41406a9-31fe-4c50-9007-e7781477b9ae" class="outline-4">
<h4 id="h:e41406a9-31fe-4c50-9007-e7781477b9ae">ansible</h4>
<div class="outline-text-4" id="text-h:e41406a9-31fe-4c50-9007-e7781477b9ae">
<p>
æ­¤å·¥å…·é€šè¿‡sshåè®®ï¼Œå®ç°å¯¹è¿œç¨‹ä¸»æœºçš„é…ç½®ç®¡ç†ã€åº”ç”¨éƒ¨ç½²ã€ä»»åŠ¡æ‰§è¡Œç­‰åŠŸèƒ½
</p>

<p>
å»ºè®®ï¼šä½¿ç”¨æ­¤å·¥å…·å‰ï¼Œå…ˆé…ç½®ansibleä¸»æ§ç«¯èƒ½åŸºäºå¯†é’¥è®¤è¯çš„æ–¹å¼è”ç³»å„ä¸ªè¢«ç®¡ç†èŠ‚ç‚¹
</p>

<p>
èŒƒä¾‹ï¼šåˆ©ç”¨sshpassæ‰¹é‡å®ç°åŸºäºkeyéªŒè¯è„šæœ¬1
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /etc/ssh/ssh_config
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#19979;&#38754;&#19968;&#34892;</span>
StrictHostKeyChecking no

[root@centos8 ~]#cat hosts.list
10.0.0.18
10.0.0.28
[root@centos8 ~]#vim push_ssh_key.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass
[ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P <span style="color: #8b2252;">''</span>
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">SSHPASS</span>=cici
<span style="color: #a020f0;">while </span><span style="color: #483d8b;">read</span> IP;<span style="color: #a020f0;">do</span>
    sshpass -e ssh-copy-id -o <span style="color: #a0522d;">StrictHostKeyChecking</span>=no $<span style="color: #a0522d;">IP</span>
<span style="color: #a020f0;">done</span> &lt; hosts.list
</pre>
</div>

<p>
èŒƒä¾‹: å®ç°åŸºäºkeyéªŒè¯çš„è„šæœ¬2
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">IPLIST</span>=<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">10.0.0.8</span>
<span style="color: #8b2252;">10.0.0.18</span>
<span style="color: #8b2252;">10.0.0.7</span>
<span style="color: #8b2252;">10.0.0.6</span>
<span style="color: #8b2252;">10.0.0.200"</span>

rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass
[ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P <span style="color: #8b2252;">''</span>
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">SSHPASS</span>=centos
<span style="color: #a020f0;">for</span> IP<span style="color: #a020f0;"> in</span> $<span style="color: #a0522d;">IPLIST</span>;<span style="color: #a020f0;">do</span>
    sshpass -e ssh-copy-id -o <span style="color: #a0522d;">StrictHostKeyChecking</span>=no $<span style="color: #a0522d;">IP</span>
<span style="color: #a020f0;">done</span>
</pre>
</div>

<p>
æ ¼å¼ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible &lt;host-pattern&gt; [-m module_name] [-a args]
        &#20027;&#26426;&#28165;&#21333;&#21015;&#34920;         &#27169;&#22359;            &#21442;&#25968;
</pre>
</div>

<p>
é€‰é¡¹è¯´æ˜ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">--version                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#29256;&#26412;</span>
-m module                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#27169;&#22359;&#65292;&#40664;&#35748;&#20026;command</span>
-v                         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35814;&#32454;&#36807;&#31243; &#8211;vv -vvv&#26356;&#35814;&#32454;</span>
--list-hosts             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#20027;&#26426;&#21015;&#34920;&#65292;&#21487;&#31616;&#20889; --list</span>
-k, --ask-pass             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#31034;&#36755;&#20837;ssh&#36830;&#25509;&#23494;&#30721;&#65292;&#40664;&#35748;Key&#39564;&#35777;</span>
-C, --check             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#65292;&#24182;&#19981;&#25191;&#34892;</span>
-T, --timeout=TIMEOUT      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;&#21629;&#20196;&#30340;&#36229;&#26102;&#26102;&#38388;&#65292;&#40664;&#35748;10s</span>
-u, --user=REMOTE_USER     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;&#36828;&#31243;&#25191;&#34892;&#30340;&#29992;&#25143;</span>
-b, --become             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20195;&#26367;&#26087;&#29256;&#30340;sudo &#20999;&#25442;</span>
--become-user=USERNAME  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;sudo&#30340;runas&#29992;&#25143;&#65292;&#40664;&#35748;&#20026;root</span>
-K, --ask-become-pass     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#31034;&#36755;&#20837;sudo&#26102;&#30340;&#21475;&#20196;</span>
</pre>
</div>

<p>
<b>ansibleçš„Host-pattern</b>
</p>

<p>
ç”¨äºåŒ¹é…è¢«æ§åˆ¶çš„ä¸»æœºçš„åˆ—è¡¨
</p>

<p>
All ï¼šè¡¨ç¤ºæ‰€æœ‰Inventoryä¸­çš„æ‰€æœ‰ä¸»æœº
</p>

<p>
èŒƒä¾‹
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible all &#8211;m ping

[root@ansible ~]#ansible all --list
  hosts (5):
    10.0.0.8
    10.0.0.7
    10.0.0.6
    10.0.0.100
    10.0.0.18
[root@ansible ~]#ansible websrvs --list
  hosts (2):
    10.0.0.8
    10.0.0.7
</pre>
</div>

<p>
â€‹<code>*</code> :é€šé…ç¬¦
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible <span style="color: #8b2252;">"*&#8221; -m ping</span>
<span style="color: #8b2252;">ansible 192.168.1.* -m ping</span>
<span style="color: #8b2252;">ansible "</span>srvs&#8221; -m ping
</pre>
</div>

<p>
æˆ–å…³ç³»
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible <span style="color: #8b2252;">"websrvs:appsrvs"</span> -m ping
ansible <span style="color: #8b2252;">"192.168.1.10:192.168.1.20"</span> -m ping
</pre>
</div>

<p>
é€»è¾‘ä¸
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;websrvs&#32452;&#24182;&#19988;&#22312;dbsrvs&#32452;&#20013;&#30340;&#20027;&#26426;</span>
ansible <span style="color: #8b2252;">"websrvs:&amp;dbsrvs"</span> &#8211;m ping
</pre>
</div>

<p>
é€»è¾‘é
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;websrvs&#32452;&#65292;&#20294;&#19981;&#22312;dbsrvs&#32452;&#20013;&#30340;&#20027;&#26426;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#65306;&#27492;&#22788;&#20026;&#21333;&#24341;&#21495;</span>
ansible <span style="color: #8b2252;">'websrvs:!dbsrvs'</span> &#8211;m ping
</pre>
</div>

<p>
ç»¼åˆé€»è¾‘
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible <span style="color: #8b2252;">'websrvs:dbsrvs:&amp;appsrvs:!ftpsrvs'</span> &#8211;m ping
</pre>
</div>

<p>
æ­£åˆ™è¡¨è¾¾å¼
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible <span style="color: #8b2252;">"websrvs:dbsrvs"</span> &#8211;m ping
ansible <span style="color: #8b2252;">"~(web|db).*\.cici\.com"</span> &#8211;m ping
</pre>
</div>

<p>
èŒƒä¾‹:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@kube-master1 ~]#ansible <span style="color: #8b2252;">'kube*:etcd:!10.0.0.101'</span> -a reboot
</pre>
</div>

<p>
èŒƒä¾‹:
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ansible appsrvs --list-hosts 
<span style="color: #0000ff;">hosts</span> (2):
  10.0.0.7
  10.0.0.8
[root@centos8 ~]#ansible <span style="color: #8b2252;">"appsrvs:dbsrvs"</span> --list-hosts 
<span style="color: #0000ff;">hosts</span> (3):
  10.0.0.7
  10.0.0.8
  10.0.0.6
[root@centos8 ~]#ansible <span style="color: #8b2252;">"appsrvs:&amp;dbsrvs"</span> --list-hosts 
<span style="color: #0000ff;">hosts</span> (1):
  10.0.0.7
[root@centos8 ~]#ansible <span style="color: #8b2252;">"appsrvs:!dbsrvs"</span> --list-hosts 
-bash: !dbsrvs: event not found
[root@centos8 ~]#ansible <span style="color: #8b2252;">'appsrvs:!dbsrvs'</span> --list-hosts 
<span style="color: #0000ff;">hosts</span> (1):
  10.0.0.8
</pre>
</div>

<p>
<b>ansibleå‘½ä»¤æ‰§è¡Œè¿‡ç¨‹</b>
</p>

<ol class="org-ol">
<li>åŠ è½½è‡ªå·±çš„é…ç½®æ–‡ä»¶ é»˜è®¤/etc/ansible/ansible.cfg</li>
<li>åŠ è½½è‡ªå·±å¯¹åº”çš„æ¨¡å—æ–‡ä»¶ï¼Œå¦‚ï¼šcommand</li>
<li><p>
é€šè¿‡ansibleå°†æ¨¡å—æˆ–å‘½ä»¤ç”Ÿæˆå¯¹åº”çš„ä¸´æ—¶pyæ–‡ä»¶ï¼Œå¹¶å°†è¯¥æ–‡ä»¶ä¼ è¾“è‡³è¿œç¨‹æœåŠ¡å™¨çš„å¯¹åº”æ‰§è¡Œç”¨æˆ·
</p>

<p>
$HOME/.ansible/tmp/ansible-tmp-æ•°å­—/XXX.PYæ–‡ä»¶
</p></li>

<li>ç»™æ–‡ä»¶ <code>+x</code> æ‰§è¡Œ</li>
<li>æ‰§è¡Œå¹¶è¿”å›ç»“æœ</li>
<li>åˆ é™¤ä¸´æ—¶pyæ–‡ä»¶ï¼Œé€€å‡º</li>
</ol>

<p>
<b>ansible çš„æ‰§è¡ŒçŠ¶æ€</b> ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#grep -A 14 <span style="color: #8b2252;">'\[colors\]'</span> /etc/ansible/ansible.cfg
[colors]
<span style="color: #b22222;">#</span><span style="color: #b22222;">highlight = white</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">verbose = blue</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">warn = bright purple</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">error = red</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">debug = dark gray</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">deprecate = purple</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">skip = cyan</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">unreachable = red</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ok = green</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">changed = yellow</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">diff_add = green</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">diff_remove = red</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">diff_lines = cyan</span>
</pre>
</div>

<ul class="org-ul">
<li>ç»¿è‰²ï¼šæ‰§è¡ŒæˆåŠŸå¹¶ä¸”ä¸éœ€è¦åšæ”¹å˜çš„æ“ä½œ</li>
<li>é»„è‰²ï¼šæ‰§è¡ŒæˆåŠŸå¹¶ä¸”å¯¹ç›®æ ‡ä¸»æœºåšå˜æ›´</li>
<li>çº¢è‰²ï¼šæ‰§è¡Œå¤±è´¥</li>
</ul>

<p>
<b>ansibleä½¿ç”¨èŒƒä¾‹</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;wang&#29992;&#25143;&#25191;&#34892;ping&#23384;&#27963;&#26816;&#27979;</span>
ansible all -m ping -u wang -k
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;wang sudo&#33267;root&#25191;&#34892;ping&#23384;&#27963;&#26816;&#27979;</span>
ansible all -m ping -u wang -k -b
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;wang sudo&#33267;cici&#29992;&#25143;&#25191;&#34892;ping&#23384;&#27963;&#26816;&#27979;</span>
ansible all -m ping -u wang -k -b --become-user=cici
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;wang sudo&#33267;root&#29992;&#25143;&#25191;&#34892;ls</span>
ansible all -m command -u wang -a <span style="color: #8b2252;">'ls /root'</span> -b --become-user=root -k -K
</pre>
</div>
</div>
</div>
<div id="outline-container-h:69c9ffb5-50ba-428e-bc25-4076e48e725b" class="outline-4">
<h4 id="h:69c9ffb5-50ba-428e-bc25-4076e48e725b">ansible-playbook</h4>
<div class="outline-text-4" id="text-h:69c9ffb5-50ba-428e-bc25-4076e48e725b">
<p>
æ­¤å·¥å…·ç”¨äºæ‰§è¡Œç¼–å†™å¥½çš„ playbook ä»»åŠ¡
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible-playbook hello.yml
cat hello.yml
---
<span style="color: #b22222;">#</span><span style="color: #b22222;">hello world yml file</span>
- hosts: websrvs
  remote_user: root
  tasks:
    - name: hello world
      command: /usr/bin/wall hello world
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2b06dcdf-28d2-4881-b5c0-4aaf1246e6f6" class="outline-4">
<h4 id="h:2b06dcdf-28d2-4881-b5c0-4aaf1246e6f6">ansible-vault</h4>
<div class="outline-text-4" id="text-h:2b06dcdf-28d2-4881-b5c0-4aaf1246e6f6">
<p>
æ­¤å·¥å…·å¯ä»¥ç”¨äºåŠ å¯†è§£å¯†ymlæ–‡ä»¶
</p>

<p>
æ ¼å¼ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible-vault [create|decrypt|edit|encrypt|rekey|view]
</pre>
</div>

<p>
èŒƒä¾‹
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible-vault encrypt hello.yml <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#23494;</span>
ansible-vault decrypt hello.yml <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35299;&#23494;</span>
ansible-vault view hello.yml     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;</span>
ansible-vault edit hello.yml     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#36753;&#21152;&#23494;&#25991;&#20214;</span>
ansible-vault rekey hello.yml     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#21475;&#20196;</span>
ansible-vault create new.yml     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#26032;&#25991;&#20214;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a11de16a-c359-4239-8ee3-e5a99ef6980d" class="outline-4">
<h4 id="h:a11de16a-c359-4239-8ee3-e5a99ef6980d">ansible-console</h4>
<div class="outline-text-4" id="text-h:a11de16a-c359-4239-8ee3-e5a99ef6980d">
<p>
æ­¤å·¥å…·å¯äº¤äº’æ‰§è¡Œå‘½ä»¤ï¼Œæ”¯æŒtabï¼Œansible 2.0+æ–°å¢
</p>

<p>
æç¤ºç¬¦æ ¼å¼ï¼š
</p>

<pre class="example" id="orgde63e6c">
æ‰§è¡Œç”¨æˆ·@å½“å‰æ“ä½œçš„ä¸»æœºç»„ (å½“å‰ç»„çš„ä¸»æœºæ•°é‡)[f:å¹¶å‘æ•°]$
</pre>

<p>
å¸¸ç”¨å­å‘½ä»¤ï¼š
</p>

<ul class="org-ul">
<li>è®¾ç½®å¹¶å‘æ•°ï¼š forks n ä¾‹å¦‚ï¼š forks 10</li>
<li>åˆ‡æ¢ç»„ï¼š cd ä¸»æœºç»„ ä¾‹å¦‚ï¼š cd web</li>
<li>åˆ—å‡ºå½“å‰ç»„ä¸»æœºåˆ—è¡¨ï¼š list</li>
<li>åˆ—å‡ºæ‰€æœ‰çš„å†…ç½®å‘½ä»¤ï¼š ?æˆ–help</li>
</ul>

<p>
èŒƒä¾‹
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#ansible-console
Welcome to the ansible console.
Type help or ? to list commands.

root@all (3)[f:5]$ list
10.0.0.8
10.0.0.7
10.0.0.6
root@all (3)[f:5]$ cd websrvs
root@websrvs (2)[f:5]$ list
10.0.0.7
10.0.0.8
root@websrvs (2)[f:5]$ forks 10
root@websrvs (2)[f:10]$ cd appsrvs
root@appsrvs (2)[f:5]$ yum <span style="color: #a0522d;">name</span>=httpd <span style="color: #a0522d;">state</span>=present
root@appsrvs (2)[f:5]$ service <span style="color: #a0522d;">name</span>=httpd <span style="color: #a0522d;">state</span>=started
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a32d361b-9c20-4688-afc6-5525c58f5bc4" class="outline-4">
<h4 id="h:a32d361b-9c20-4688-afc6-5525c58f5bc4">ansible-galaxy</h4>
<div class="outline-text-4" id="text-h:a32d361b-9c20-4688-afc6-5525c58f5bc4">
<p>
æ­¤å·¥å…·ä¼šè¿æ¥ <a href="https://galaxy.ansible.com">https://galaxy.ansible.com</a> ä¸‹è½½ç›¸åº”çš„roles
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;&#24050;&#23433;&#35013;&#30340;galaxy</span>
ansible-galaxy list
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;galaxy</span>
ansible-galaxy install geerlingguy.mysql
ansible-galaxy install geerlingguy.redis
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;galaxy</span>
ansible-galaxy remove geerlingguy.redis
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:25bf4dd4-f731-4bd9-9896-7d59251394a2" class="outline-3">
<h3 id="h:25bf4dd4-f731-4bd9-9896-7d59251394a2">Ansibleå¸¸ç”¨æ¨¡å—</h3>
<div class="outline-text-3" id="text-h:25bf4dd4-f731-4bd9-9896-7d59251394a2">
<p>
2015å¹´åº•270å¤šä¸ªæ¨¡å—ï¼Œ2016å¹´è¾¾åˆ°540ä¸ªï¼Œ2018å¹´01æœˆ12æ—¥æœ‰1378ä¸ªæ¨¡å—ï¼Œ2018
å¹´07æœˆ15æ—¥1852ä¸ªæ¨¡å—,2019å¹´05æœˆ25æ—¥ï¼ˆansible 2.7.10ï¼‰æ—¶2080ä¸ªæ¨¡å—ï¼Œ
2020å¹´03æœˆ02æ—¥æœ‰3387ä¸ªæ¨¡å—
</p>

<p>
è™½ç„¶æ¨¡å—ä¼—å¤šï¼Œä½†æœ€å¸¸ç”¨çš„æ¨¡å—ä¹Ÿå°±2ï¼Œ30ä¸ªè€Œå·²ï¼Œé’ˆå¯¹ç‰¹å®šä¸šåŠ¡åªç”¨10å‡ ä¸ªæ¨¡å—
</p>

<p>
å¸¸ç”¨æ¨¡å—å¸®åŠ©æ–‡æ¡£å‚è€ƒï¼š
</p>

<p>
<a href="https://docs.ansible.com/ansible/latest/modules/modules_by_category.html">https://docs.ansible.com/ansible/latest/modules/modules_by_category.html</a>
</p>

<p>
æ¨¡å—ï¼ˆä¹Ÿç§°ä¸ºâ€œä»»åŠ¡æ’ä»¶â€æˆ–â€œåº“æ’ä»¶â€ï¼‰æ˜¯ç¦»æ•£çš„ä»£ç å•å…ƒï¼Œå¯ä»å‘½ä»¤è¡Œæˆ–åœ¨ playbook ä»»åŠ¡ä¸­ä½¿ç”¨ã€‚Ansible é€šå¸¸åœ¨è¿œç¨‹æ‰˜ç®¡èŠ‚ç‚¹ä¸Šæ‰§è¡Œæ¯ä¸ªæ¨¡å—ï¼Œå¹¶æ”¶é›†è¿”å›å€¼ã€‚åœ¨ Ansible 2.10 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œå¤§å¤šæ•°æ¨¡å—éƒ½æ‰˜ç®¡åœ¨é›†åˆä¸­ã€‚
</p>

<p>
REFERENCE &amp; APPENDICES å‚è€ƒæ–‡çŒ®å’Œé™„å½•ï¼Œæ”¶é›†æ‰€æœ‰é›†åˆç´¢å¼•: 
<a href="https://docs.ansible.com/ansible/latest/collections/index.html#list-of-collections">https://docs.ansible.com/ansible/latest/collections/index.html#list-of-collections</a>
</p>
</div>
<div id="outline-container-h:284c9372-03a0-4ec2-aaf5-a46b25066651" class="outline-4">
<h4 id="h:284c9372-03a0-4ec2-aaf5-a46b25066651">Command æ¨¡å—</h4>
<div class="outline-text-4" id="text-h:284c9372-03a0-4ec2-aaf5-a46b25066651">
<p>
åŠŸèƒ½ï¼šåœ¨è¿œç¨‹ä¸»æœºæ‰§è¡Œå‘½ä»¤ï¼Œæ­¤ä¸ºé»˜è®¤æ¨¡å—ï¼Œå¯å¿½ç•¥-mé€‰é¡¹
</p>

<p>
æ³¨æ„ï¼šæ­¤å‘½ä»¤ä¸æ”¯æŒ <code>$VARNAME &lt; &gt; | ; &amp;</code> ç­‰ï¼Œç”¨shellæ¨¡å—å®ç°
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#ansible websrvs -m command -a <span style="color: #8b2252;">'chdir=/etc cat centos-release'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
CentOS Linux release 7.7.1908 (Core)
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
CentOS Linux release 8.1.1911 (Core)
[root@ansible ~]#ansible websrvs -m command -a <span style="color: #8b2252;">'chdir=/etc creates=/data/f1.txt</span>
<span style="color: #8b2252;">cat centos-release'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
CentOS Linux release 7.7.1908 (Core)
10.0.0.8 | SUCCESS | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
skipped, since /data/f1.txt exists
[root@ansible ~]#ansible websrvs -m command -a <span style="color: #8b2252;">'chdir=/etc removes=/data/f1.txt</span>
<span style="color: #8b2252;">cat centos-release'</span>
10.0.0.7 | SUCCESS | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
skipped, since /data/f1.txt does not exist
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
CentOS Linux release 8.1.1911 (Core)

ansible websrvs -m command -a &#8216;service vsftpd start&#8217;
ansible websrvs -m command -a &#8216;echo cici |passwd --stdin wang&#8217;
ansible websrvs -m command -a <span style="color: #8b2252;">'rm -rf /data/'</span>
ansible websrvs -m command -a <span style="color: #8b2252;">'echo hello &gt; /data/hello.log'</span>
ansible websrvs -m command -a <span style="color: #8b2252;">"echo $HOSTNAME"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:39a49c4f-c84c-47a0-870b-84f52bc9d0f4" class="outline-4">
<h4 id="h:39a49c4f-c84c-47a0-870b-84f52bc9d0f4">Shellæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:39a49c4f-c84c-47a0-870b-84f52bc9d0f4">
<p>
åŠŸèƒ½ï¼šå’Œcommandç›¸ä¼¼ï¼Œç”¨shellæ‰§è¡Œå‘½ä»¤ï¼Œæ”¯æŒå„ç§ç¬¦å·ã€‚æ¯”å¦‚: <code>*,$, &gt;</code>
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ansible websrvs -m shell -a <span style="color: #8b2252;">"echo $HOSTNAME"</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
centos8
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
centos8
[root@centos8 ~]#ansible websrvs -m shell -a <span style="color: #8b2252;">'echo $HOSTNAME'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
Centos7.8
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
centos8.1.cuiqinghe.com

[root@centos8 ~]#ansible websrvs -m shell -a <span style="color: #8b2252;">'echo centos | passwd --stdin cui'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
Changing password for user cui.
passwd: all authentication tokens updated successfully.
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
Changing password for user cui.
passwd: all authentication tokens updated successfully.

[root@centos8 ~]#ansible websrvs -m shell -a <span style="color: #8b2252;">'ls -l /etc/shadow'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
---------- 1 root root 806 Jun 18 16:17 /etc/shadow
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
---------- 1 root root 868 Jun 19 16:17 /etc/shadow

[root@centos8 ~]#ansible websrvs -m shell -a <span style="color: #8b2252;">'echo hello &gt; /data/hello.log'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;

10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;

[root@centos8 ~]#ansible websrvs -m shell -a <span style="color: #8b2252;">'cat /data/hello.log'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
hello
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
hello
</pre>
</div>

<p>
æ³¨æ„ï¼šè°ƒç”¨bashæ‰§è¡Œå‘½ä»¤ ç±»ä¼¼ <code>cat /tmp/test.md | awk -Fâ€˜|' '{print
$1,$2}' &amp;&gt; /tmp/example.txt</code> è¿™äº›å¤æ‚å‘½ä»¤ï¼Œå³ä½¿ä½¿ç”¨shellä¹Ÿå¯èƒ½ä¼šå¤±è´¥ï¼Œ
è§£å†³åŠæ³•ï¼šå†™åˆ°è„šæœ¬æ—¶ï¼Œcopyåˆ°è¿œç¨‹ï¼Œæ‰§è¡Œï¼Œå†æŠŠéœ€è¦çš„ç»“æœæ‹‰å›æ‰§è¡Œå‘½ä»¤çš„æœº
å™¨
</p>

<p>
èŒƒä¾‹ï¼šå°†shellæ¨¡å—ä»£æ›¿commandï¼Œè®¾ä¸ºæ¨¡å—
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#vim /etc/ansible/ansible.cfg
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#19979;&#38754;&#19968;&#34892;</span>
<span style="color: #a0522d;">module_name</span> = shell
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7ccc1a8e-47f6-4b5f-9c2b-3f349b6283da" class="outline-4">
<h4 id="h:7ccc1a8e-47f6-4b5f-9c2b-3f349b6283da">Scriptæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:7ccc1a8e-47f6-4b5f-9c2b-3f349b6283da">
<p>
åŠŸèƒ½ï¼šåœ¨è¿œç¨‹ä¸»æœºä¸Šè¿è¡ŒansibleæœåŠ¡å™¨ä¸Šçš„è„šæœ¬(æ— éœ€æ‰§è¡Œæƒé™)
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible websrvs -m script -a /data/test.sh
</pre>
</div>
</div>
</div>
<div id="outline-container-h:804c9693-8571-40ad-88b8-81beeba167cc" class="outline-4">
<h4 id="h:804c9693-8571-40ad-88b8-81beeba167cc">Copyæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:804c9693-8571-40ad-88b8-81beeba167cc">
<p>
åŠŸèƒ½ï¼šä»ansibleæœåŠ¡å™¨ä¸»æ§ç«¯å¤åˆ¶æ–‡ä»¶åˆ°è¿œç¨‹ä¸»æœº
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#30446;&#26631;&#23384;&#22312;&#65292;&#40664;&#35748;&#35206;&#30422;&#65292;&#27492;&#22788;&#25351;&#23450;&#20808;&#22791;&#20221;</span>
ansible websrvs -m copy -a <span style="color: #8b2252;">"src=/root/test1.sh dest=/tmp/test2.sh owner=wang mode=600 backup=yes"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#20869;&#23481;&#65292;&#30452;&#25509;&#29983;&#25104;&#30446;&#26631;&#25991;&#20214;</span>
ansible websrvs -m copy -a <span style="color: #8b2252;">"content='test line1\ntest line2' dest=/tmp/test.txt"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;/etc&#30446;&#24405;&#33258;&#36523;,&#27880;&#24847;/etc/&#21518;&#38754;&#27809;&#26377;/   &#31867;&#20284;&#20110;rsync</span>
ansible websrvs -m copy -a <span style="color: #8b2252;">"src=/etc dest=/backup"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;/etc/&#19979;&#30340;&#25991;&#20214;&#65292;&#19981;&#21253;&#25324;/etc/&#30446;&#24405;&#33258;&#36523;,&#27880;&#24847;/etc/&#21518;&#38754;&#26377;/</span>
ansible websrvs -m copy -a <span style="color: #8b2252;">"src=/etc/ dest=/backup"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:706df931-2107-45c4-9f23-ca2ce81fa5c1" class="outline-4">
<h4 id="h:706df931-2107-45c4-9f23-ca2ce81fa5c1">Fetchæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:706df931-2107-45c4-9f23-ca2ce81fa5c1">
<p>
åŠŸèƒ½ï¼šä»è¿œç¨‹ä¸»æœºæå–æ–‡ä»¶è‡³ansibleçš„ä¸»æ§ç«¯ï¼Œcopyç›¸åï¼Œç›®å‰ä¸æ”¯æŒç›®å½•
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible websrvs -m fetch -a <span style="color: #8b2252;">'src=/root/test.sh dest=/data/scripts'</span>
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#ansible all -m fetch -a <span style="color: #8b2252;">'src=/etc/os-release</span>
<span style="color: #8b2252;">dest=/data/os'</span>
[root@ansible ~]#tree /data/os/
/data/
&#9500;&#9472;&#9472; 10.0.0.7
&#9474;   &#9492;&#9472;&#9472; etc
&#9474;       &#9492;&#9472;&#9472; os-release
&#9492;&#9472;&#9472; 10.0.0.8
    &#9492;&#9472;&#9472; etc
        &#9492;&#9472;&#9472; os-release

4 directories, 2 files
</pre>
</div>
</div>
</div>
<div id="outline-container-h:600e3996-6c4d-49be-9adc-6d14233afb0d" class="outline-4">
<h4 id="h:600e3996-6c4d-49be-9adc-6d14233afb0d">Fileæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:600e3996-6c4d-49be-9adc-6d14233afb0d">
<p>
åŠŸèƒ½ï¼šè®¾ç½®æ–‡ä»¶å±æ€§
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#31354;&#25991;&#20214;</span>
ansible all -m file -a <span style="color: #8b2252;">'path=/data/test.txt state=touch'</span>
ansible all -m file -a <span style="color: #8b2252;">'path=/data/test.txt state=absent'</span>
ansible all -m file -a <span style="color: #8b2252;">"path=/root/test.sh owner=wang mode=755"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#30446;&#24405;</span>
ansible all -m file -a <span style="color: #8b2252;">"path=/data/mysql state=directory owner=mysql</span>
<span style="color: #8b2252;">group=mysql"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#36719;&#38142;&#25509;</span>
ansible all -m file -a <span style="color: #8b2252;">'src=/data/testfile dest=/data/testfile-link state=link&#8217;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6aa66dbb-472e-47b6-9a66-6b4e845bd4fe" class="outline-4">
<h4 id="h:6aa66dbb-472e-47b6-9a66-6b4e845bd4fe">unarchiveæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:6aa66dbb-472e-47b6-9a66-6b4e845bd4fe">
<p>
åŠŸèƒ½ï¼šè§£åŒ…è§£å‹ç¼©
</p>

<p>
å®ç°æœ‰ä¸¤ç§ç”¨æ³•ï¼š
</p>
<ol class="org-ol">
<li>å°†ansibleä¸»æœºä¸Šçš„å‹ç¼©åŒ…ä¼ åˆ°è¿œç¨‹ä¸»æœºåè§£å‹ç¼©è‡³ç‰¹å®šç›®å½•ï¼Œè®¾ç½®copy=yes</li>
<li>å°†è¿œç¨‹ä¸»æœºä¸Šçš„æŸä¸ªå‹ç¼©åŒ…è§£å‹ç¼©åˆ°æŒ‡å®šè·¯å¾„ä¸‹ï¼Œè®¾ç½®copy=no</li>
</ol>

<p>
å¸¸è§å‚æ•°ï¼š
</p>

<ul class="org-ul">
<li>copyï¼šé»˜è®¤ä¸ºyesï¼Œå½“copy=yesï¼Œæ‹·è´çš„æ–‡ä»¶æ˜¯ä»ansibleä¸»æœºå¤åˆ¶åˆ°è¿œç¨‹ä¸»æœº
ä¸Šï¼Œå¦‚æœè®¾ç½®ä¸ºcopy=noï¼Œä¼šåœ¨è¿œç¨‹ä¸»æœºä¸Šå¯»æ‰¾srcæºæ–‡ä»¶</li>
<li>remote_srcï¼šå’ŒcopyåŠŸèƒ½ä¸€æ ·ä¸”äº’æ–¥ï¼Œyesè¡¨ç¤ºåœ¨è¿œç¨‹ä¸»æœºï¼Œä¸åœ¨ansibleä¸»æœºï¼Œ
noè¡¨ç¤ºæ–‡ä»¶åœ¨ansibleä¸»æœºä¸Š</li>
<li>srcï¼šæºè·¯å¾„ï¼Œå¯ä»¥æ˜¯ansibleä¸»æœºä¸Šçš„è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯è¿œç¨‹ä¸»æœº(è¢«ç®¡ç†ç«¯æˆ–
è€…ç¬¬ä¸‰æ–¹ä¸»æœº)ä¸Šçš„è·¯å¾„ï¼Œå¦‚æœæ˜¯è¿œç¨‹ä¸»æœºä¸Šçš„è·¯å¾„ï¼Œåˆ™éœ€è¦è®¾ç½®copy=no</li>
<li>destï¼šè¿œç¨‹ä¸»æœºä¸Šçš„ç›®æ ‡è·¯å¾„</li>
<li>modeï¼šè®¾ç½®è§£å‹ç¼©åçš„æ–‡ä»¶æƒé™</li>
</ul>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;copy&#26102;yes,&#25925;&#30465;&#30053;</span>
ansible all -m unarchive -a <span style="color: #8b2252;">'src=/data/foo.tgz dest=/var/lib/foo owner=wang group=bin'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28304;&#21253;&#19981;&#22312;absible&#20027;&#26426;&#19978;,&#23601;&#35201;&#25226;copy&#35774;&#25104;no</span>
ansible all -m unarchive -a <span style="color: #8b2252;">'src=/tmp/foo.zip dest=/data copy=no mode=0777'</span>
ansible all -m unarchive -a <span style="color: #8b2252;">'src=https://example.com/example.zip dest=/data copy=no'</span>
</pre>
</div>

<p>
èŒƒä¾‹:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#tar Jcvf etc.tar.xz /etc/
[root@ansible ~]#ll -h
-rw-------. 1 root root 1.6K Mar 11 22:26 anaconda-ks.cfg
-rw-r--r--  1 root root 3.8M Jun 20 09:27 etc.tar.xz
[root@ansible ~]#ansible all --list
  hosts (4):
    10.0.0.8
    10.0.0.7
    10.0.0.6
    10.0.0.100
[root@ansible ~]#ansible websrvs --list
  hosts (2):
    10.0.0.8
    10.0.0.7

[root@ansible ~]#ansible websrvs -m unarchive -a <span style="color: #8b2252;">'src=/root/etc.tar.xz dest=/data owner=cui group=bin'</span>
10.0.0.8 | <span style="color: #a0522d;">CHANGED</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/libexec/platform-python"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: true,
    <span style="color: #8b2252;">"dest"</span>: <span style="color: #8b2252;">"/data"</span>,
    <span style="color: #8b2252;">"extract_results"</span>: {
        <span style="color: #8b2252;">"cmd"</span>: [
            <span style="color: #8b2252;">"/usr/bin/gtar"</span>,
            <span style="color: #8b2252;">"--extract"</span>,
            <span style="color: #8b2252;">"-C"</span>,
            <span style="color: #8b2252;">"/data"</span>,
            <span style="color: #8b2252;">"--owner=cui"</span>,
            <span style="color: #8b2252;">"--group=bin"</span>,
            <span style="color: #8b2252;">"-f"</span>,
            <span style="color: #8b2252;">"/root/.ansible/tmp/ansible-tmp-1592616801.5587249-8032-36480135360957/source"</span>
        ],
        <span style="color: #8b2252;">"err"</span>: <span style="color: #8b2252;">""</span>,
        <span style="color: #8b2252;">"out"</span>: <span style="color: #8b2252;">""</span>,
        <span style="color: #8b2252;">"rc"</span>: 0
    },
    <span style="color: #8b2252;">"gid"</span>: 0,
    <span style="color: #8b2252;">"group"</span>: <span style="color: #8b2252;">"root"</span>,
    <span style="color: #8b2252;">"handler"</span>: <span style="color: #8b2252;">"TarArchive"</span>,
    <span style="color: #8b2252;">"mode"</span>: <span style="color: #8b2252;">"0755"</span>,
    <span style="color: #8b2252;">"owner"</span>: <span style="color: #8b2252;">"root"</span>,
    <span style="color: #8b2252;">"size"</span>: 17,
    <span style="color: #8b2252;">"src"</span>: <span style="color: #8b2252;">"/root/.ansible/tmp/ansible-tmp-1592616801.5587249-8032-36480135360957/source"</span>,
    <span style="color: #8b2252;">"state"</span>: <span style="color: #8b2252;">"directory"</span>,
    <span style="color: #8b2252;">"uid"</span>: 0
}
10.0.0.7 | <span style="color: #a0522d;">CHANGED</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/bin/python"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: true,
    <span style="color: #8b2252;">"dest"</span>: <span style="color: #8b2252;">"/data"</span>,
    <span style="color: #8b2252;">"extract_results"</span>: {
        <span style="color: #8b2252;">"cmd"</span>: [
            <span style="color: #8b2252;">"/usr/bin/gtar"</span>,
            <span style="color: #8b2252;">"--extract"</span>,
            <span style="color: #8b2252;">"-C"</span>,
            <span style="color: #8b2252;">"/data"</span>,
            <span style="color: #8b2252;">"--owner=cui"</span>,
            <span style="color: #8b2252;">"--group=bin"</span>,
            <span style="color: #8b2252;">"-f"</span>,
            <span style="color: #8b2252;">"/root/.ansible/tmp/ansible-tmp-1592616801.5619113-8034-100361774048645/source"</span>
        ],
        <span style="color: #8b2252;">"err"</span>: <span style="color: #8b2252;">""</span>,
        <span style="color: #8b2252;">"out"</span>: <span style="color: #8b2252;">""</span>,
        <span style="color: #8b2252;">"rc"</span>: 0
    },
    <span style="color: #8b2252;">"gid"</span>: 0,
    <span style="color: #8b2252;">"group"</span>: <span style="color: #8b2252;">"root"</span>,
    <span style="color: #8b2252;">"handler"</span>: <span style="color: #8b2252;">"TarArchive"</span>,
    <span style="color: #8b2252;">"mode"</span>: <span style="color: #8b2252;">"0755"</span>,
    <span style="color: #8b2252;">"owner"</span>: <span style="color: #8b2252;">"root"</span>,
    <span style="color: #8b2252;">"size"</span>: 17,
    <span style="color: #8b2252;">"src"</span>: <span style="color: #8b2252;">"/root/.ansible/tmp/ansible-tmp-1592616801.5619113-8034-100361774048645/source"</span>,
    <span style="color: #8b2252;">"state"</span>: <span style="color: #8b2252;">"directory"</span>,
    <span style="color: #8b2252;">"uid"</span>: 0
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#26631;&#20027;&#26426;</span>
[root@centos8 ~]#ll /data/
total 12
drwxr-xr-x 134 cui bin 8192 Jun 20 08:48 etc

[root@Centos7 ~]#ll /data/
total 12
drwxr-xr-x 134 cui bin 8192 Jun 20 08:48 etc

[root@ansible ~]#ansible websrvs -a <span style="color: #8b2252;">'rm -rf /data/*'</span>
[WARNING]: Consider using the file module with <span style="color: #a0522d;">state</span>=absent rather than running
<span style="color: #8b2252;">'rm'</span>.  If you need to use command because file is insufficient you can add <span style="color: #8b2252;">'warn:</span>
<span style="color: #8b2252;">false'</span> to this command task or set <span style="color: #8b2252;">'command_warnings=False'</span><span style="color: #a020f0;"> in</span> ansible.cfg to get
rid of this message.
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;

10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;

[root@ansible ~]#ansible websrvs -a <span style="color: #8b2252;">'ls /data/*'</span>
10.0.0.7 | FAILED | <span style="color: #a0522d;">rc</span>=2 &gt;&gt;
ls: cannot access /data/*: No such file or directorynon-zero return code
10.0.0.8 | FAILED | <span style="color: #a0522d;">rc</span>=2 &gt;&gt;
ls: cannot access <span style="color: #8b2252;">'/data/*'</span>: No such file or directorynon-zero return code

[root@ansible ~]#ansible websrvs -m copy -a <span style="color: #8b2252;">'src=etc.tar.xz dest=/root/'</span>
[root@ansible ~]#mv etc.tar.xz /opt/
[root@ansible ~]#ansible websrvs -m unarchive -a <span style="color: #8b2252;">'src=/root/etc.tar.xz dest=/data copy=no'</span>

[root@centos8 ~]#ll /data/
total 12
drwxr-xr-x 134 root root 8192 Jun 20 08:48 etc
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cf6723a1-88cb-42c8-b7ab-6098c76d2cb3" class="outline-4">
<h4 id="h:cf6723a1-88cb-42c8-b7ab-6098c76d2cb3">Archiveæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:cf6723a1-88cb-42c8-b7ab-6098c76d2cb3">
<p>
åŠŸèƒ½ï¼šæ‰“åŒ…å‹ç¼©ä¿å­˜åœ¨è¢«ç®¡ç†èŠ‚ç‚¹
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible websrvs -m archive -a <span style="color: #8b2252;">'path=/var/log/ dest=/data/log.tar.bz2 format=bz2 owner=wang mode=0600'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ac5aaa58-ca5b-4f82-8a46-105a35e0e580" class="outline-4">
<h4 id="h:ac5aaa58-ca5b-4f82-8a46-105a35e0e580">Hostnameæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:ac5aaa58-ca5b-4f82-8a46-105a35e0e580">
<p>
åŠŸèƒ½ï¼šç®¡ç†ä¸»æœºå,ä¸€èˆ¬æ˜¯é’ˆå¯¹ä¸€å°ä¸»æœºè®¾,å¯¹å¤šä¸ªä¸»æœºè®¾ä¸åˆç†
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible node1 -m hostname -a &#8220;<span style="color: #a0522d;">name</span>=websrv&#8221;
ansible 192.168.100.18 -m hostname -a <span style="color: #8b2252;">'name=node18.cici.com'</span>

[root@ansible ~]#ansible 10.0.0.6 -m hostname -a <span style="color: #8b2252;">'name=centos66.cuiqinghe.com'</span>
[root@centos6 ~]#hostname
centos66.cuiqinghe.com
[root@centos6 ~]#cat /etc/sysconfig/network   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#20889;&#21040;&#37197;&#32622;&#25991;&#20214;&#20013;&#20102;</span>
<span style="color: #a0522d;">NETWORKING</span>=yes
<span style="color: #a0522d;">HOSTNAME</span>=centos66.cuiqinghe.com

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25193;&#23637;:centos7,centos8,ubuntu&#30340;&#20027;&#26426;&#21517;&#37117;&#25918;&#22312;/etc/hostname&#20013;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b5d8fcf8-e8da-4bf0-8174-f9beb3b1f052" class="outline-4">
<h4 id="h:b5d8fcf8-e8da-4bf0-8174-f9beb3b1f052">Cronæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:b5d8fcf8-e8da-4bf0-8174-f9beb3b1f052">
<p>
åŠŸèƒ½ï¼šè®¡åˆ’ä»»åŠ¡ (åˆ†æ—¶æ—¥æœˆå‘¨)
</p>

<p>
æ”¯æŒæ—¶é—´ï¼šminuteï¼Œhourï¼Œdayï¼Œmonthï¼Œweekday
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#25968;&#25454;&#24211;&#33050;&#26412;</span>
[root@centos8 ~]#cat /root/mysql_backup.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
mysqldump -A -F --single-transaction --master-data=2 -q -uroot |gzip &gt; /data/mysql_<span style="color: #ff00ff;">`date +%F_%T`</span>.sql.gz
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A&#20840;&#37096;&#25968;&#25454;&#24211;&#22791;&#20221;  -F&#21047;&#26032;&#26085;&#24535;  --single-transaction&#21551;&#29992;&#20107;&#21153;  --master-data=2 &#35760;&#24405;&#22791;&#20221;&#28857;   -q&#24555;&#36895;&#22791;&#20221;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#20219;&#21153;</span>
ansible 10.0.0.8 -m cron -a <span style="color: #8b2252;">'hour=2 minute=30 weekday=1-5 name="backup mysql" job=/root/mysql_backup.sh'</span>
ansible websrvs -m cron -a <span style="color: #8b2252;">"minute=*/5 job='/usr/sbin/ntpdate ntp.aliyun.com</span>
<span style="color: #8b2252;">&amp;&gt;/dev/null' name=Synctime"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36991;&#20813;&#20135;&#29983;&#22823;&#37327;&#22403;&#22334;&#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ntpdate ntp.aliyun.com &#21629;&#20196;&#21482;&#26377;centos7&#21644;&#20043;&#21069;&#30340;&#29256;&#26412;&#26377;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#29992;&#35745;&#21010;&#20219;&#21153;</span>
ansible websrvs -m cron -a <span style="color: #8b2252;">"minute=*/5 job='/usr/sbin/ntpdate ntp.aliyun.com</span>
<span style="color: #8b2252;">&amp;&gt;/dev/null' name=Synctime disabled=yes"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#35745;&#21010;&#20219;&#21153;</span>
ansible websrvs -m cron -a <span style="color: #8b2252;">"minute=*/5 job='/usr/sbin/ntpdate ntp.aliyun.com</span>
<span style="color: #8b2252;">&amp;&gt;/dev/null' name=Synctime disabled=no"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#20219;&#21153;</span>
ansible websrvs -m cron -a <span style="color: #8b2252;">"name='backup mysql' state=absent"</span>
ansible websrvs -m cron -a <span style="color: #8b2252;">'state=absent name=Synctime'</span>
</pre>
</div>

<p>
èŒƒä¾‹:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#cat mysql_backup.sh 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
mysqldump -A -F --single-transaction --master-data=2 -q -uroot |gzip &gt; /data/mysql_<span style="color: #ff00ff;">`date +%F_%T`</span>.sql.gz
[root@ansible ~]#chmod +x mysql_backup.sh
[root@ansible ~]#ansible websrvs -m copy -a <span style="color: #8b2252;">'src=/root/mysql_backup.sh dest=/opt/'</span>

[root@ansible ~]#ansible websrvs -a <span style="color: #8b2252;">'ls -l /opt/'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
total 4
-rw-r--r-- 1 root root 541 Jun 20 10:12 mysql_backup.sh
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
total 4
-rw-r--r-- 1 root root 541 Jun 20 10:12 mysql_backup.sh

[root@ansible ~]#ansible websrvs -m cron -a <span style="color: #8b2252;">'hour=2 minute=30 weekday=1-5 name="backup mysql" job=/opt/mysql_backup.sh'</span>
[root@ansible ~]#ansible websrvs -a <span style="color: #8b2252;">'crontab -l'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
<span style="color: #b22222;">#</span><span style="color: #b22222;">Ansible: backup mysql</span>
30 2 * * 1-5 /opt/mysql_backup.sh
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
<span style="color: #b22222;">#</span><span style="color: #b22222;">Ansible: backup mysql</span>
30 2 * * 1-5 /opt/mysql_backup.sh

[root@Centos7 ~]#cat /var/spool/cron/root 
<span style="color: #b22222;">#</span><span style="color: #b22222;">Ansible: backup mysql</span>
30 2 * * 1-5 /opt/mysql_backup.sh
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9d2752cf-dcdc-48b2-9386-ce7f4b079e14" class="outline-4">
<h4 id="h:9d2752cf-dcdc-48b2-9386-ce7f4b079e14">Yum æ¨¡å— Apt æ¨¡å—</h4>
<div class="outline-text-4" id="text-h:9d2752cf-dcdc-48b2-9386-ce7f4b079e14">
<p>
yum ç®¡ç†è½¯ä»¶åŒ…ï¼Œåªæ”¯æŒRHELï¼ŒCentOSï¼Œfedoraï¼Œä¸æ”¯æŒUbuntuå…¶å®ƒç‰ˆæœ¬
</p>

<p>
apt æ¨¡å—ç®¡ç† Debian ç›¸å…³ç‰ˆæœ¬çš„è½¯ä»¶åŒ…
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible websrvs -m yum -a <span style="color: #8b2252;">'name=httpd state=present'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;</span>
ansible websrvs -m yum -a <span style="color: #8b2252;">'name=httpd state=absent'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;</span>

[root@ansible ~]#ansible websrvs -m yum -a <span style="color: #8b2252;">'name=iotop,cowsay'</span>
[root@ansible ~]#ansible websrvs -a <span style="color: #8b2252;">'rpm -q iotop cowsay'</span>
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ansible 10.0.0.100 -m apt -a <span style="color: #8b2252;">'name=bb,sl,cowsay,cmatrix,oneko,hollywood,boxes,libaa-bin,x11-apps'</span>
[root@centos8 ~]#ansible websrvs -m apt -a <span style="color: #8b2252;">'name=rsync,psmisc state=absent'</span>
</pre>
</div>

<p>
èŒƒä¾‹
</p>

<div class="org-src-container">
<pre class="src src-sh">- name: Install basic software
  yum:
    state: installed
    update_cache: yes
    name:
      - <span style="color: #8b2252;">"vim"</span>
      - <span style="color: #8b2252;">"man"</span>
      - <span style="color: #8b2252;">"wget"</span>
      - <span style="color: #8b2252;">"tree"</span>
      - <span style="color: #8b2252;">"sysstat"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a5947938-fdf5-4aac-b0c6-d0d1e1b6427a" class="outline-4">
<h4 id="h:a5947938-fdf5-4aac-b0c6-d0d1e1b6427a">Packageæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:a5947938-fdf5-4aac-b0c6-d0d1e1b6427a">
<div class="org-src-container">
<pre class="src src-yaml">- name: install chronyd 
  package:
    name: chrony
    state: latest
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e624bb8f-5da4-4997-8b22-f18f4d7f1d0f" class="outline-4">
<h4 id="h:e624bb8f-5da4-4997-8b22-f18f4d7f1d0f">Serviceæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:e624bb8f-5da4-4997-8b22-f18f4d7f1d0f">
<p>
åŠŸèƒ½ï¼šç®¡ç†æœåŠ¡
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#20026;&#24320;&#26426;&#21551;&#21160;</span>
ansible all -m service -a <span style="color: #8b2252;">'name=httpd state=started enabled=yes'</span> 
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#29366;&#24577;</span>
ansible websrvs  -a <span style="color: #8b2252;">'systemctl is-enabled httpd'</span>

ansible all -m service -a <span style="color: #8b2252;">'name=httpd state=stopped'</span>
ansible all -m service -a <span style="color: #8b2252;">'name=httpd state=reloaded'</span>
ansible all -m service -a <span style="color: #8b2252;">'name=httpd state=restarted'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#31471;&#21475;</span>
ansible all -m shell -a <span style="color: #8b2252;">"sed -i 's/^Listen 80/Listen 8080/' /etc/httpd/conf/httpd.conf"</span>
[root@ansible ~]#ansible websrvs -a <span style="color: #8b2252;">"grep Listen /etc/httpd/conf/httpd.conf"</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
<span style="color: #b22222;"># </span><span style="color: #b22222;">Listen: Allows you to bind Apache to specific IP addresses and/or</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Change this to Listen on specific IP addresses as shown below to </span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">Listen 12.34.56.78:80</span>
Listen 8080
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
<span style="color: #b22222;"># </span><span style="color: #b22222;">Listen: Allows you to bind Apache to specific IP addresses and/or</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Change this to Listen on specific IP addresses as shown below to </span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">Listen 12.34.56.78:80</span>
Listen 8080
</pre>
</div>
</div>
</div>
<div id="outline-container-h:64477c11-2ec5-404e-b9cb-b954b44cdc51" class="outline-4">
<h4 id="h:64477c11-2ec5-404e-b9cb-b954b44cdc51">Useræ¨¡å—</h4>
<div class="outline-text-4" id="text-h:64477c11-2ec5-404e-b9cb-b954b44cdc51">
<p>
åŠŸèƒ½ï¼šç®¡ç†ç”¨æˆ·
</p>

<p>
èŒƒä¾‹
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#29992;&#25143;</span>
ansible all -m user -a <span style="color: #8b2252;">'name=user1 comment="test user" uid=2048 home=/app/user1 group=root'</span>

ansible all -m user -a <span style="color: #8b2252;">'name=nginx comment=nginx uid=88 group=nginx</span>
<span style="color: #8b2252;">groups="root,daemon" shell=/sbin/nologin system=yes create_home=no</span>
<span style="color: #8b2252;">home=/data/nginx non_unique=yes'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">remove=yes&#34920;&#31034;&#21024;&#38500;&#29992;&#25143;&#21450;&#23478;&#30446;&#24405;&#31561;&#25968;&#25454;,&#40664;&#35748;remove=no</span>
ansible all -m user -a <span style="color: #8b2252;">'name=nginx state=absent remove=yes'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:78a08001-e7e2-4e38-9f29-c939e7545cdc" class="outline-4">
<h4 id="h:78a08001-e7e2-4e38-9f29-c939e7545cdc">Groupæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:78a08001-e7e2-4e38-9f29-c939e7545cdc">
<p>
åŠŸèƒ½ï¼šç®¡ç†ç»„
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#32452;</span>
ansible websrvs -m group -a <span style="color: #8b2252;">'name=nginx gid=88 system=yes'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#32452;</span>
ansible websrvs -m group -a <span style="color: #8b2252;">'name=nginx state=absent'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:34495623-4c73-4d50-a762-4b70beaebac3" class="outline-4">
<h4 id="h:34495623-4c73-4d50-a762-4b70beaebac3">Lineinfileæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:34495623-4c73-4d50-a762-4b70beaebac3">
<p>
ansibleåœ¨ä½¿ç”¨sedè¿›è¡Œæ›¿æ¢æ—¶ï¼Œç»å¸¸ä¼šé‡åˆ°éœ€è¦è½¬ä¹‰çš„é—®é¢˜ï¼Œè€Œä¸”ansibleåœ¨é‡
åˆ°ç‰¹æ®Šç¬¦å·è¿›è¡Œæ›¿æ¢æ—¶ï¼Œå­˜åœ¨é—®é¢˜ï¼Œæ— æ³•æ­£å¸¸è¿›è¡Œæ›¿æ¢ã€‚å…¶å®åœ¨ansibleè‡ªèº«æ
ä¾›äº†ä¸¤ä¸ªæ¨¡å—ï¼šlineinfileæ¨¡å—å’Œreplaceæ¨¡å—ï¼Œå¯ä»¥æ–¹ä¾¿çš„è¿›è¡Œæ›¿æ¢
</p>

<p>
ä¸€èˆ¬åœ¨ansibleå½“ä¸­å»ä¿®æ”¹æŸä¸ªæ–‡ä»¶çš„å•è¡Œè¿›è¡Œæ›¿æ¢çš„æ—¶å€™éœ€è¦ä½¿ç”¨lineinfileæ¨¡å—
</p>

<p>
regexpå‚æ•° ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å¯¹åº”çš„è¡Œï¼Œå½“æ›¿æ¢æ–‡æœ¬æ—¶ï¼Œå¦‚æœæœ‰å¤šè¡Œæ–‡æœ¬
éƒ½èƒ½è¢«åŒ¹é…ï¼Œåˆ™åªæœ‰æœ€åé¢è¢«åŒ¹é…åˆ°çš„é‚£è¡Œæ–‡æœ¬æ‰ä¼šè¢«æ›¿æ¢ï¼Œå½“åˆ é™¤æ–‡æœ¬æ—¶ï¼Œå¦‚
æœæœ‰å¤šè¡Œæ–‡æœ¬éƒ½èƒ½è¢«åŒ¹é…ï¼Œè¿™ä¹ˆè¿™äº›è¡Œéƒ½ä¼šè¢«åˆ é™¤ã€‚
</p>

<p>
å¦‚æœæƒ³è¿›è¡Œå¤šè¡ŒåŒ¹é…è¿›è¡Œæ›¿æ¢éœ€è¦ä½¿ç”¨replaceæ¨¡å—
</p>

<p>
åŠŸèƒ½ï¼šç›¸å½“äºsedï¼Œå¯ä»¥ä¿®æ”¹æ–‡ä»¶å†…å®¹,è‹¥éœ€è¦ä¿®æ”¹çš„è¡Œæ•°è¾ƒå¤š,å°±ç”¨copyæ¨¡å—
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible websrvs -m lineinfile -a <span style="color: #8b2252;">"path=/etc/httpd/conf/httpd.conf</span>
<span style="color: #8b2252;">regexp='^Listen' line='Listen 80'"</span>

ansible all -m lineinfile -a <span style="color: #8b2252;">"path=/etc/selinux/config regexp='^SELINUX=' line='SELINUX=disabled'"</span>

ansible all -m lineinfile -a <span style="color: #8b2252;">'dest=/etc/fstab state=absent regexp="^#"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c5687051-26a7-4773-979d-9e7ebd63f2bc" class="outline-4">
<h4 id="h:c5687051-26a7-4773-979d-9e7ebd63f2bc">Replaceæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:c5687051-26a7-4773-979d-9e7ebd63f2bc">
<p>
è¯¥æ¨¡å—æœ‰ç‚¹ç±»ä¼¼äºsedå‘½ä»¤ï¼Œä¸»è¦ä¹Ÿæ˜¯åŸºäºæ­£åˆ™è¿›è¡ŒåŒ¹é…å’Œæ›¿æ¢ï¼Œå»ºè®®ä½¿ç”¨
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible all -m replace -a <span style="color: #8b2252;">"path=/etc/fstab regexp='^(UUID.*)' replace='#\1'"</span>
ansible all -m replace -a <span style="color: #8b2252;">"path=/etc/fstab regexp='^#(.*)' replace='\1'"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5f76e222-0523-4bfa-9320-c8bc766f486d" class="outline-4">
<h4 id="h:5f76e222-0523-4bfa-9320-c8bc766f486d">Setupæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:5f76e222-0523-4bfa-9320-c8bc766f486d">
<p>
åŠŸèƒ½ï¼š setup æ¨¡å—æ¥æ”¶é›†ä¸»æœºçš„ç³»ç»Ÿä¿¡æ¯ï¼Œè¿™äº› facts
ä¿¡æ¯å¯ä»¥ç›´æ¥ä»¥å˜é‡çš„å½¢å¼ä½¿ç”¨ï¼Œä½†æ˜¯å¦‚æœä¸»æœºè¾ƒå¤šï¼Œä¼šå½±å“æ‰§è¡Œé€Ÿåº¦ï¼Œå¯ä»¥ä½¿ç”¨
gather_facts: no æ¥ç¦æ­¢ Ansible æ”¶é›† facts ä¿¡æ¯
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible all -m setup
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_nodename"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_hostname"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_domain"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_memtotal_mb"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_memory_mb"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_memfree_mb"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_os_family"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_distribution_major_version"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_distribution_version"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_processor_vcpus"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_all_ipv4_addresses"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_architecture"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_processor*"</span>
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#ansible all -m setup -a <span style="color: #8b2252;">'filter=ansible_python_version'</span> 
10.0.0.7 | <span style="color: #a0522d;">SUCCESS</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"ansible_python_version"</span>: <span style="color: #8b2252;">"2.7.5"</span>,
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/bin/python"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: false
}
10.0.0.6 | <span style="color: #a0522d;">SUCCESS</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"ansible_python_version"</span>: <span style="color: #8b2252;">"2.6.6"</span>,
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/bin/python"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: false
}
10.0.0.8 | <span style="color: #a0522d;">SUCCESS</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"ansible_python_version"</span>: <span style="color: #8b2252;">"3.6.8"</span>,
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/libexec/platform-python"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: false
}
10.0.0.100 | <span style="color: #a0522d;">SUCCESS</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"ansible_python_version"</span>: <span style="color: #8b2252;">"3.6.9"</span>,
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/bin/python3"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: false
}
</pre>
</div>

<p>
èŒƒä¾‹ï¼šå–IPåœ°å€
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#25152;&#26377;IP</span>
ansible 10.0.0.100 -m setup -a <span style="color: #8b2252;">'filter=ansible_all_ipv4_addresses'</span>
10.0.0.100 | <span style="color: #a0522d;">SUCCESS</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"ansible_all_ipv4_addresses"</span>: [
            <span style="color: #8b2252;">"10.0.0.100"</span>
        ],
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/bin/python3"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: false
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#40664;&#35748;IP</span>
[root@ansible ~]#ansible 10.0.0.8 -m setup -a <span style="color: #8b2252;">'filter="ansible_default_ipv4"'</span>
10.0.0.8 | <span style="color: #a0522d;">SUCCESS</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"ansible_default_ipv4"</span>: {
            <span style="color: #8b2252;">"address"</span>: <span style="color: #8b2252;">"10.0.0.8"</span>,
            <span style="color: #8b2252;">"alias"</span>: <span style="color: #8b2252;">"eth0"</span>,
            <span style="color: #8b2252;">"broadcast"</span>: <span style="color: #8b2252;">"10.0.0.255"</span>,
            <span style="color: #8b2252;">"gateway"</span>: <span style="color: #8b2252;">"10.0.0.2"</span>,
            <span style="color: #8b2252;">"interface"</span>: <span style="color: #8b2252;">"eth0"</span>,
            <span style="color: #8b2252;">"macaddress"</span>: <span style="color: #8b2252;">"00:0c:29:30:80:0a"</span>,
            <span style="color: #8b2252;">"mtu"</span>: 1500,
            <span style="color: #8b2252;">"netmask"</span>: <span style="color: #8b2252;">"255.255.255.0"</span>,
            <span style="color: #8b2252;">"network"</span>: <span style="color: #8b2252;">"10.0.0.0"</span>,
            <span style="color: #8b2252;">"type"</span>: <span style="color: #8b2252;">"ether"</span>
        },
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/libexec/platform-python"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: false
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:40d14931-5787-4c91-9c34-ab669223c49f" class="outline-4">
<h4 id="h:40d14931-5787-4c91-9c34-ab669223c49f">set_factæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:40d14931-5787-4c91-9c34-ab669223c49f">
<p>
è®¾ç½®å˜é‡
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- name: map hostname var
  set_fact:
    hostname: "{{ inventory_hostname }}"
  when: hostname is not defined
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d5483b20-4a08-4c56-9649-e0b44c956110" class="outline-4">
<h4 id="h:d5483b20-4a08-4c56-9649-e0b44c956110">selinuxæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:d5483b20-4a08-4c56-9649-e0b44c956110">
<div class="org-src-container">
<pre class="src src-yaml">- name: disable_selinux
  selinux: state=disabled
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0d44d365-59a3-45a0-bbec-ee235715e04c" class="outline-4">
<h4 id="h:0d44d365-59a3-45a0-bbec-ee235715e04c">debugæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:0d44d365-59a3-45a0-bbec-ee235715e04c">
<div class="org-src-container">
<pre class="src src-yaml">- name: print data_disk_exist
  debug:
    msg: "{{data_disk_exist}}"
</pre>
</div>
</div>
</div>
<div id="outline-container-h:70380e05-19df-4a86-ba91-e2f8c5aec6ef" class="outline-4">
<h4 id="h:70380e05-19df-4a86-ba91-e2f8c5aec6ef">filesystemæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:70380e05-19df-4a86-ba91-e2f8c5aec6ef">
<p>
æ ¼å¼åŒ–ç£ç›˜
</p>

<pre class="example" id="org67dfc21">
- name: format disk
  filesystem:
    fstype: ext4
    dev: '{{ data_disk }}'
  when: data_disk_exist.stdout is match ("{{ data_disk }}:\ data")
</pre>
</div>
</div>
<div id="outline-container-h:2201d13a-1aec-49aa-8e31-9f3bcbe3aefc" class="outline-4">
<h4 id="h:2201d13a-1aec-49aa-8e31-9f3bcbe3aefc">mountæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:2201d13a-1aec-49aa-8e31-9f3bcbe3aefc">
<div class="org-src-container">
<pre class="src src-yaml">- name: mount data disk
  mount:
    name: '/data'
    src: '{{ data_disk }}'
    fstype: ext4
    state: mounted
  when: data_disk_exist.stdout is  match ("{{ data_disk }}:\ data")
</pre>
</div>
</div>
</div>
<div id="outline-container-h:24e119bc-a6d8-4cab-b2a8-cae8ef05e8a3" class="outline-4">
<h4 id="h:24e119bc-a6d8-4cab-b2a8-cae8ef05e8a3">authorized_keyæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:24e119bc-a6d8-4cab-b2a8-cae8ef05e8a3">
<div class="org-src-container">
<pre class="src src-yaml">- name: add tower key to root
  authorized_key:
    key: 'ssh-rsa AAAAB3NzaC1yc2ES1xX root@tower-1.ops.bj.tx.lan'
    user: root
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1d7220f3-a61c-4ae4-b2a0-52304622ec42" class="outline-4">
<h4 id="h:1d7220f3-a61c-4ae4-b2a0-52304622ec42">systemdæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:1d7220f3-a61c-4ae4-b2a0-52304622ec42">
<div class="org-src-container">
<pre class="src src-yaml">- name: restart rsyslog
  systemd:
    name: rsyslog
    state: restarted
    enabled: true
</pre>
</div>
</div>
</div>
<div id="outline-container-h:82131cdc-b8cb-4223-a7d0-1ec555c7214e" class="outline-4">
<h4 id="h:82131cdc-b8cb-4223-a7d0-1ec555c7214e">lineinfileæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:82131cdc-b8cb-4223-a7d0-1ec555c7214e">
<div class="org-src-container">
<pre class="src src-yaml">- name: change PASS_MAX_DAYS for login.defs
  lineinfile:
     dest: /etc/login.defs
     regexp: '^PASS_MAX_DAYS   99999' 
     line: 'PASS_MAX_DAYS   90'

- name: change login 
  lineinfile:
     dest: /etc/pam.d/login
     state: present
     insertafter: '^auth       include'
     line: '{{ item }}'
  with_items:
  - "auth       required     pam_tally.so onerr=fail no_magic_root"
  - "account    required     pam_tally.so deny=3 no_magic_root reset"
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ba12198f-b8bf-4a96-9682-539c97c33fd5" class="outline-4">
<h4 id="h:ba12198f-b8bf-4a96-9682-539c97c33fd5">synchronizeæ¨¡å—</h4>
<div class="outline-text-4" id="text-h:ba12198f-b8bf-4a96-9682-539c97c33fd5">
<p>
åŒæ­¥æ–‡ä»¶
</p>

<pre class="example" id="orgfe92851">
- name: apply securetty
  synchronize:
    src: securetty  # filesç›®å½•å–æ–‡ä»¶
    dest: /etc/securetty
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:82957dba-6f58-4cdf-ae1a-12db3ee0ccca" class="outline-2">
<h2 id="h:82957dba-6f58-4cdf-ae1a-12db3ee0ccca">Playbook</h2>
<div class="outline-text-2" id="text-h:82957dba-6f58-4cdf-ae1a-12db3ee0ccca">
</div>
<div id="outline-container-h:12279fce-9cf9-4abf-9def-1b804ca5a2c0" class="outline-3">
<h3 id="h:12279fce-9cf9-4abf-9def-1b804ca5a2c0">playbookä»‹ç»</h3>
<div class="outline-text-3" id="text-h:12279fce-9cf9-4abf-9def-1b804ca5a2c0">

<figure id="orgac955f6">
<img src="https://img-blog.csdnimg.cn/20200705204200540.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjIzODc1NQ==,size_16,color_FFFFFF,t_70" alt="watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjIzODc1NQ==,size_16,color_FFFFFF,t_70">

</figure>

<ul class="org-ul">
<li>playbook å‰§æœ¬æ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªâ€playâ€ç»„æˆçš„åˆ—è¡¨</li>
<li>playçš„ä¸»è¦åŠŸèƒ½åœ¨äºå°†é¢„å®šä¹‰çš„ä¸€ç»„ä¸»æœºï¼Œè£…æ‰®æˆäº‹å…ˆé€šè¿‡ansibleä¸­çš„task
å®šä¹‰å¥½çš„è§’è‰²ã€‚Taskå®é™…æ˜¯è°ƒç”¨ansibleçš„ä¸€ä¸ªmoduleï¼Œå°†å¤šä¸ªplayç»„ç»‡åœ¨ä¸€
ä¸ªplaybookä¸­ï¼Œå³å¯ä»¥è®©å®ƒä»¬è”åˆèµ·æ¥ï¼ŒæŒ‰äº‹å…ˆç¼–æ’çš„æœºåˆ¶æ‰§è¡Œé¢„å®šä¹‰çš„åŠ¨ä½œ</li>

<li>Playbook æ–‡ä»¶æ˜¯é‡‡ç”¨YAMLè¯­è¨€ç¼–å†™çš„</li>
</ul>
</div>
</div>
<div id="outline-container-h:6e33e4b5-fad2-4b45-863c-b7c76bfca760" class="outline-3">
<h3 id="h:6e33e4b5-fad2-4b45-863c-b7c76bfca760">YAML è¯­è¨€</h3>
<div class="outline-text-3" id="text-h:6e33e4b5-fad2-4b45-863c-b7c76bfca760">
</div>
<div id="outline-container-h:8274922d-ed3b-469a-a601-f3e4d23d7de5" class="outline-4">
<h4 id="h:8274922d-ed3b-469a-a601-f3e4d23d7de5">YAMl è¯­è¨€ä»‹ç»</h4>
<div class="outline-text-4" id="text-h:8274922d-ed3b-469a-a601-f3e4d23d7de5">
<p>
YAMLï¼šYAML Ain't Markup Languageï¼Œå³YAMLä¸æ˜¯XMLã€‚ä¸è¿‡ï¼Œåœ¨å¼€å‘çš„è¿™ç§è¯­
è¨€æ—¶ï¼ŒYAMLçš„æ„æ€å…¶å®æ˜¯ï¼š"Yet Another Markup Language"ï¼ˆä»æ˜¯ä¸€ç§æ ‡è®°è¯­
è¨€ï¼‰
</p>

<p>
YAMLæ˜¯ä¸€ä¸ªå¯è¯»æ€§é«˜çš„ç”¨æ¥è¡¨è¾¾èµ„æ–™åºåˆ—çš„æ ¼å¼ã€‚YAMLå‚è€ƒäº†å…¶ä»–å¤šç§è¯­è¨€ï¼ŒåŒ…
æ‹¬ï¼šXMLã€Cè¯­è¨€ã€Pythonã€Perlä»¥åŠç”µå­é‚®ä»¶æ ¼å¼RFC2822ç­‰ã€‚Clark Evansåœ¨
2001å¹´åœ¨é¦–æ¬¡å‘è¡¨äº†è¿™ç§è¯­è¨€ï¼Œå¦å¤–Ingy dÃ¶t Netä¸Oren Ben-Kikiä¹Ÿæ˜¯è¿™è¯­è¨€
çš„å…±åŒè®¾è®¡è€…,ç›®å‰å¾ˆå¤šè½¯ä»¶ä¸­é‡‡æœ‰æ­¤æ ¼å¼çš„æ–‡ä»¶ï¼Œå¦‚:ubuntuï¼Œanisbleï¼Œ
dockerï¼Œk8sç­‰
</p>

<p>
YAML å®˜æ–¹ç½‘ç«™ï¼š<a href="http://www.yaml.org">http://www.yaml.org</a>
</p>
</div>
</div>
<div id="outline-container-h:665fd638-df24-49d6-b680-9b02125db467" class="outline-4">
<h4 id="h:665fd638-df24-49d6-b680-9b02125db467">YAML è¯­è¨€ç‰¹æ€§</h4>
<div class="outline-text-4" id="text-h:665fd638-df24-49d6-b680-9b02125db467">
<ul class="org-ul">
<li>YAMLçš„å¯è¯»æ€§å¥½</li>
<li>YAMLå’Œè„šæœ¬è¯­è¨€çš„äº¤äº’æ€§å¥½</li>
<li>YAMLä½¿ç”¨å®ç°è¯­è¨€çš„æ•°æ®ç±»å‹</li>
<li>YAMLæœ‰ä¸€ä¸ªä¸€è‡´çš„ä¿¡æ¯æ¨¡å‹</li>
<li>YAMLæ˜“äºå®ç°</li>
<li>YAMLå¯ä»¥åŸºäºæµæ¥å¤„ç†</li>
<li>YAMLè¡¨è¾¾èƒ½åŠ›å¼ºï¼Œæ‰©å±•æ€§å¥½</li>
</ul>
</div>
</div>
<div id="outline-container-h:bbf71988-e55d-4e8d-a371-223045f7b39c" class="outline-4">
<h4 id="h:bbf71988-e55d-4e8d-a371-223045f7b39c">YAMLè¯­æ³•ç®€ä»‹</h4>
<div class="outline-text-4" id="text-h:bbf71988-e55d-4e8d-a371-223045f7b39c">
<ul class="org-ul">
<li>åœ¨å•ä¸€æ–‡ä»¶ç¬¬ä¸€è¡Œï¼Œç”¨è¿ç»­ä¸‰ä¸ªè¿å­—å·â€-â€ å¼€å§‹ï¼Œè¿˜æœ‰é€‰æ‹©æ€§çš„è¿ç»­ä¸‰ä¸ªç‚¹
å·( &#x2026; )ç”¨æ¥è¡¨ç¤ºæ–‡ä»¶çš„ç»“å°¾</li>
<li>æ¬¡è¡Œå¼€å§‹æ­£å¸¸å†™Playbookçš„å†…å®¹ï¼Œä¸€èˆ¬å»ºè®®å†™æ˜è¯¥Playbookçš„åŠŸèƒ½</li>
<li>ä½¿ç”¨#å·æ³¨é‡Šä»£ç </li>
<li>ç¼©è¿›å¿…é¡»æ˜¯ç»Ÿä¸€çš„ï¼Œä¸èƒ½ç©ºæ ¼å’Œtabæ··ç”¨</li>
<li>ç¼©è¿›çš„çº§åˆ«ä¹Ÿå¿…é¡»æ˜¯ä¸€è‡´çš„ï¼ŒåŒæ ·çš„ç¼©è¿›ä»£è¡¨åŒæ ·çš„çº§åˆ«ï¼Œç¨‹åºåˆ¤åˆ«é…ç½®çš„çº§åˆ«æ˜¯é€šè¿‡ç¼©è¿›ç»“åˆæ¢è¡Œæ¥å®ç°çš„</li>
<li>YAMLæ–‡ä»¶å†…å®¹æ˜¯åŒºåˆ«å¤§å°å†™çš„ï¼Œkey/valueçš„å€¼å‡éœ€å¤§å°å†™æ•æ„Ÿ</li>
<li>å¤šä¸ªkey/valueå¯åŒè¡Œå†™ä¹Ÿå¯æ¢è¡Œå†™ï¼ŒåŒè¡Œä½¿ç”¨ï¼Œåˆ†éš”</li>
<li>vå¯æ˜¯ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯æ˜¯å¦ä¸€ä¸ªåˆ—è¡¨</li>
<li>YAMLæ–‡ä»¶æ‰©å±•åé€šå¸¸ä¸ºymlæˆ–yaml</li>
</ul>

<p>
YAMLçš„è¯­æ³•å’Œå…¶ä»–é«˜é˜¶è¯­è¨€ç±»ä¼¼ï¼Œå¹¶ä¸”å¯ä»¥ç®€å•è¡¨è¾¾æ¸…å•ã€æ•£åˆ—è¡¨ã€æ ‡é‡ç­‰æ•°æ®
ç»“æ„ã€‚å…¶ç»“æ„ï¼ˆStructureï¼‰é€šè¿‡ç©ºæ ¼æ¥å±•ç¤ºï¼Œåºåˆ—ï¼ˆSequenceï¼‰é‡Œçš„é¡¹ç”¨â€-"
æ¥ä»£è¡¨ï¼ŒMapé‡Œçš„é”®å€¼å¯¹ç”¨":â€œåˆ†éš”ï¼Œä¸‹é¢ä»‹ç»å¸¸è§çš„æ•°æ®ç»“æ„ã€‚
</p>
</div>
</div>
<div id="outline-container-h:ba76bc61-0292-4c5b-a0f9-f45a3fdc0a0e" class="outline-4">
<h4 id="h:ba76bc61-0292-4c5b-a0f9-f45a3fdc0a0e">æ”¯æŒçš„æ•°æ®ç±»å‹</h4>
<div class="outline-text-4" id="text-h:ba76bc61-0292-4c5b-a0f9-f45a3fdc0a0e">
<p>
YAML æ”¯æŒä»¥ä¸‹å¸¸ç”¨å‡ ç§æ•°æ®ç±»å‹ï¼š
</p>
<ul class="org-ul">
<li>æ ‡é‡ï¼šå•ä¸ªçš„ã€ä¸å¯å†åˆ†çš„å€¼</li>
<li>å¯¹è±¡ï¼šé”®å€¼å¯¹çš„é›†åˆï¼Œåˆç§°ä¸ºæ˜ å°„ï¼ˆmappingï¼‰/ å“ˆå¸Œï¼ˆhashesï¼‰ / å­—å…¸ï¼ˆdictionaryï¼‰</li>
<li>æ•°ç»„ï¼šä¸€ç»„æŒ‰æ¬¡åºæ’åˆ—çš„å€¼ï¼Œåˆç§°ä¸ºåºåˆ—ï¼ˆsequenceï¼‰ / åˆ—è¡¨ï¼ˆlistï¼‰</li>
</ul>
</div>
<div id="outline-container-h:5bb9f758-9760-4222-8cfc-12b44283542b" class="outline-5">
<h5 id="h:5bb9f758-9760-4222-8cfc-12b44283542b">scalar æ ‡é‡</h5>
<div class="outline-text-5" id="text-h:5bb9f758-9760-4222-8cfc-12b44283542b">
<p>
keyå¯¹åº”value
</p>
<pre class="example" id="org1159d68">
name: jasper
</pre>

<p>
ä½¿ç”¨ç¼©è¿›çš„æ–¹å¼
</p>
<pre class="example" id="org4239539">
name:
  jasper
</pre>

<p>
æ ‡é‡æ˜¯æœ€åŸºæœ¬çš„ï¼Œä¸å¯å†åˆ†çš„å€¼ï¼ŒåŒ…æ‹¬ï¼š
</p>
<ul class="org-ul">
<li>å­—ç¬¦ä¸²</li>
<li>å¸ƒå°”å€¼</li>
<li>æ•´æ•°</li>
<li>æµ®ç‚¹æ•°</li>
<li>Null</li>
<li>æ—¶é—´</li>
<li>æ—¥æœŸ</li>
</ul>
</div>
</div>
<div id="outline-container-h:f9cfd730-a4bf-4caf-af26-999c9138e099" class="outline-5">
<h5 id="h:f9cfd730-a4bf-4caf-af26-999c9138e099">Dictionaryå­—å…¸</h5>
<div class="outline-text-5" id="text-h:f9cfd730-a4bf-4caf-af26-999c9138e099">
<p>
å­—å…¸ç”±å¤šä¸ªkeyä¸valueæ„æˆï¼Œkeyå’Œvalueä¹‹é—´ç”¨ ï¼šåˆ†éš”, å¹¶ä¸” :åé¢æœ‰ä¸€ä¸ªç©º
æ ¼ï¼Œæ‰€æœ‰k/vå¯ä»¥æ”¾åœ¨ä¸€è¡Œï¼Œæˆ–è€…æ¯ä¸ª k/v åˆ†åˆ«æ”¾åœ¨ä¸åŒè¡Œ
</p>

<p>
æ ¼å¼
</p>
<pre class="example" id="org1d2f0d7">
account: { name: wang, age: 30 }
</pre>

<p>
ä½¿ç”¨ç¼©è¿›æ–¹å¼
</p>
<pre class="example" id="orgda48199">
account:
  name: wang
  age: 30
</pre>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#21516;&#34892;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">An employee record</span>
name: Example Developer
job: Developer
skill: Elite

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#19968;&#34892;,&#20063;&#21487;&#20197;&#23558;key:value&#25918;&#32622;&#20110;{}&#20013;&#36827;&#34892;&#34920;&#31034;&#65292;&#29992;,&#20998;&#38548;&#22810;&#20010;key:value</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">An employee record</span>
{name: <span style="color: #8b2252;">"Example Developer"</span>, job: <span style="color: #8b2252;">"Developer"</span>, skill: <span style="color: #8b2252;">"Elite"</span>}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6a315d07-eae9-4ab7-89fe-5acbd12b6ca5" class="outline-5">
<h5 id="h:6a315d07-eae9-4ab7-89fe-5acbd12b6ca5">Liståˆ—è¡¨</h5>
<div class="outline-text-5" id="text-h:6a315d07-eae9-4ab7-89fe-5acbd12b6ca5">
<pre class="example" id="orgcfcffb8">
åˆ—è¡¨ç”±å¤šä¸ªå…ƒç´ ç»„æˆï¼Œæ¯ä¸ªå…ƒç´ æ”¾åœ¨ä¸åŒè¡Œï¼Œä¸”å…ƒç´ å‰å‡ä½¿ç”¨â€-â€œæ‰“å¤´ï¼Œå¹¶ä¸”
-åæœ‰ä¸€ä¸ªç©ºæ ¼, æˆ–è€…å°†æ‰€æœ‰å…ƒç´ ç”¨ [ ] æ‹¬èµ·æ¥æ”¾åœ¨åŒä¸€è¡Œ
</pre>

<p>
æ ¼å¼ï¼š
</p>
<pre class="example" id="org13c50bd">
course:
  - linux
  - golang
  - python
</pre>

<p>
ä¹Ÿå¯ä»¥ä½¿ç”¨
</p>
<pre class="example" id="org1407b2b">
course: [ linux , golang , python ]
</pre>

<p>
æ•°æ®é‡Œé¢ä¹Ÿå¯ä»¥åŒ…å«å¯¹è±¡
</p>
<pre class="example" id="org36c78bd">
course:
  - linux: manjaro
  - golang: gin
  - python: django
</pre>


<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#21516;&#34892;,&#34892;&#20197;-&#24320;&#22836;,&#21518;&#38754;&#26377;&#19968;&#20010;&#31354;&#26684;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">A list of tasty fruits</span>
- Apple
- Orange
- Strawberry
- Mango

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#19968;&#34892;</span>
[Apple,Orange,Strawberry,Mango]
</pre>
</div>

<p>
èŒƒä¾‹ï¼šYAML è¡¨ç¤ºä¸€ä¸ªå®¶åº­
</p>
<pre class="example" id="orgd7cea35">
name: John Smith
age: 41
gender: Male
spouse:
  name: Jane Smith
  age: 37
  gender: Female
children:
  - name: Jimmy Smith
    age: 17
    gender: Male
  - {name: Jenny Smith, age: 13, gender: Female}
  - {name: hao Smith, age: 20, gender: Male }
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2de59182-2b01-4c4a-a518-816df9550dd2" class="outline-4">
<h4 id="h:2de59182-2b01-4c4a-a518-816df9550dd2">ä¸‰ç§å¸¸è§çš„æ•°æ®æ ¼å¼</h4>
<div class="outline-text-4" id="text-h:2de59182-2b01-4c4a-a518-816df9550dd2">
<ul class="org-ul">
<li>XMLï¼šExtensible Markup Languageï¼Œå¯æ‰©å±•æ ‡è®°è¯­è¨€ï¼Œå¯ç”¨äºæ•°æ®äº¤æ¢å’Œé…ç½®</li>
<li>JSONï¼šJavaScript Object Notation, JavaScript
å¯¹è±¡è¡¨è®°æ³•ï¼Œ <b>ä¸»è¦ç”¨æ¥æ•°æ®äº¤æ¢ä¼ è¾“æˆ–é…ç½®</b> ï¼Œä¸æ”¯æŒæ³¨é‡Š</li>
<li>YAMLï¼šYAML Ain't Markup Language YAML ä¸æ˜¯ä¸€ç§æ ‡è®°è¯­è¨€ï¼Œ
ä¸»è¦ç”¨æ¥é…ç½®ï¼Œå¤§å°å†™æ•æ„Ÿï¼Œä¸æ”¯æŒtab</li>
</ul>


<figure id="org3cc0d71">
<img src="./images/img_20240228_153213.png" alt="img_20240228_153213.png" width="80%">

</figure>


<p>
<b>å¯ä»¥ç”¨å·¥å…·äº’ç›¸è½¬æ¢ï¼Œå‚è€ƒç½‘ç«™</b> ï¼š
</p>

<p>
<a href="https://www.json2yaml.com/">https://www.json2yaml.com/</a>
</p>

<p>
<a href="http://www.bejson.com/json/json2yaml/">http://www.bejson.com/json/json2yaml/</a>
</p>
</div>
</div>
</div>
<div id="outline-container-h:1ef2a223-efdb-4182-9c42-5ae32bac6e9d" class="outline-3">
<h3 id="h:1ef2a223-efdb-4182-9c42-5ae32bac6e9d">Playbook æ ¸å¿ƒç»„ä»¶</h3>
<div class="outline-text-3" id="text-h:1ef2a223-efdb-4182-9c42-5ae32bac6e9d">
<p>
ä¸€ä¸ªplaybook ä¸­ç”±åˆ—è¡¨ç»„æˆ,å…¶ä¸­æ‰€ç”¨åˆ°çš„å¸¸è§ç»„ä»¶ç±»å‹å¦‚ä¸‹:
</p>

<ul class="org-ul">
<li>Hosts æ‰§è¡Œçš„è¿œç¨‹ä¸»æœºåˆ—è¡¨</li>
<li>Tasks ä»»åŠ¡é›†,ç”±å¤šä¸ªtaskçš„å…ƒç´ ç»„æˆçš„åˆ—è¡¨å®ç°,æ¯ä¸ªtaskæ˜¯ä¸€ä¸ªå­—å…¸</li>
<li>Variables å†…ç½®å˜é‡æˆ–è‡ªå®šä¹‰å˜é‡åœ¨playbookä¸­è°ƒç”¨</li>
<li>Templates æ¨¡æ¿ï¼Œå¯æ›¿æ¢æ¨¡æ¿æ–‡ä»¶ä¸­çš„å˜é‡å¹¶å®ç°ä¸€äº›ç®€å•é€»è¾‘çš„æ–‡ä»¶</li>
<li>Handlers å’Œ notifyç»“åˆä½¿ç”¨ï¼Œç”±ç‰¹å®šæ¡ä»¶è§¦å‘çš„æ“ä½œï¼Œ <b>æ»¡è¶³æ¡ä»¶æ–¹æ‰æ‰§
è¡Œ</b> ï¼Œå¦åˆ™ä¸æ‰§è¡Œ</li>
<li>tags æ ‡ç­¾: æŒ‡å®šæŸæ¡ä»»åŠ¡æ‰§è¡Œï¼Œç”¨äºé€‰æ‹©è¿è¡Œplaybookä¸­çš„éƒ¨åˆ†ä»£ç ã€‚ansible
å…·æœ‰å¹‚ç­‰æ€§ï¼Œå› æ­¤ä¼šè‡ªåŠ¨è·³è¿‡æ²¡æœ‰å˜åŒ–çš„éƒ¨åˆ†ï¼Œå³ä¾¿å¦‚æ­¤ï¼Œæœ‰äº›ä»£ç ä¸ºæµ‹è¯•å…¶
ç¡®å®æ²¡æœ‰å‘ç”Ÿå˜åŒ–çš„æ—¶é—´ä¾ç„¶ä¼šéå¸¸åœ°é•¿ã€‚æ­¤æ—¶ï¼Œå¦‚æœç¡®ä¿¡å…¶æ²¡æœ‰å˜åŒ–ï¼Œå°±å¯
ä»¥é€šè¿‡tagsè·³è¿‡æ­¤äº›ä»£ç ç‰‡æ–­</li>
<li>ä¸€ä¸ªå®Œæ•´çš„ä»£ç å—åŠŸèƒ½éœ€æœ€å°‘å…ƒç´ éœ€åŒ…æ‹¬ name å’Œ
task,ä¸€ä¸ªnameåªèƒ½åŒ…æ‹¬ä¸€ä¸ªtask</li>
</ul>
</div>
<div id="outline-container-h:a47c2523-e7f0-4aff-9af9-16adafba5398" class="outline-4">
<h4 id="h:a47c2523-e7f0-4aff-9af9-16adafba5398">hosts ç»„ä»¶</h4>
<div class="outline-text-4" id="text-h:a47c2523-e7f0-4aff-9af9-16adafba5398">
<p>
Hostsï¼šplaybookä¸­çš„æ¯ä¸€ä¸ªplayçš„ç›®çš„éƒ½æ˜¯ä¸ºäº†è®©ç‰¹å®šä¸»æœºä»¥æŸä¸ªæŒ‡å®šçš„ç”¨æˆ·èº«ä»½æ‰§è¡Œä»»åŠ¡ã€‚hostsç”¨äºæŒ‡å®šè¦æ‰§è¡ŒæŒ‡å®šä»»åŠ¡çš„ä¸»æœºï¼Œé¡»äº‹å…ˆå®šä¹‰åœ¨ä¸»æœºæ¸…å•ä¸­
</p>

<div class="org-src-container">
<pre class="src src-sh">one.example.com
one.example.com:two.example.com
192.168.1.50
192.168.1.*
Websrvs:dbsrvs         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#65292;&#20004;&#20010;&#32452;&#30340;&#24182;&#38598;</span>
Websrvs:&amp;dbsrvs     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19982;&#65292;&#20004;&#20010;&#32452;&#30340;&#20132;&#38598;</span>
webservers:!phoenix <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;websrvs&#32452;&#65292;&#20294;&#19981;&#22312;dbsrvs&#32452;</span>
</pre>
</div>

<p>
æ¡ˆä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">- hosts: websrvs:appsrvs      hosts&#20803;&#32032;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bbc2ad3c-a0b1-446c-a56a-d64472538a1d" class="outline-4">
<h4 id="h:bbc2ad3c-a0b1-446c-a56a-d64472538a1d">remote_user ç»„ä»¶</h4>
<div class="outline-text-4" id="text-h:bbc2ad3c-a0b1-446c-a56a-d64472538a1d">
<p>
remote_user:
å¯ç”¨äºHostå’Œtaskä¸­ã€‚ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®šå…¶é€šè¿‡sudoçš„æ–¹å¼åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œä»»åŠ¡ï¼Œå…¶å¯ç”¨äºplayå…¨å±€æˆ–æŸä»»åŠ¡ï¼›æ­¤å¤–ï¼Œç”šè‡³å¯ä»¥åœ¨sudoæ—¶ä½¿ç”¨sudo_useræŒ‡å®šsudoæ—¶åˆ‡æ¢çš„ç”¨æˆ·
</p>

<div class="org-src-container">
<pre class="src src-sh">- hosts: websrvs
  remote_user: root     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38190;&#20540;&#23545;</span>

  tasks:
    - name: test connection
      ping:
      remote_user: cici
      sudo: yes             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;sudo&#20026;root</span>
      sudo_user:wang         <span style="color: #b22222;">#</span><span style="color: #b22222;">sudo&#20026;wang</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d9248277-dadd-496d-9bd6-a0c203e2f6ad" class="outline-4">
<h4 id="h:d9248277-dadd-496d-9bd6-a0c203e2f6ad">taskåˆ—è¡¨å’Œactionç»„ä»¶</h4>
<div class="outline-text-4" id="text-h:d9248277-dadd-496d-9bd6-a0c203e2f6ad">
<p>
playçš„ä¸»ä½“éƒ¨åˆ†æ˜¯task listï¼Œtask listä¸­æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªtask,å„ä¸ªtaskæŒ‰æ¬¡åº
é€ä¸ªåœ¨hostsä¸­æŒ‡å®šçš„æ‰€æœ‰ä¸»æœºä¸Šæ‰§è¡Œï¼Œå³åœ¨æ‰€æœ‰ä¸»æœºä¸Šå®Œæˆç¬¬ä¸€ä¸ªtaskåï¼Œå†
å¼€å§‹ç¬¬äºŒä¸ªtask
</p>

<p>
taskçš„ç›®çš„æ˜¯ä½¿ç”¨æŒ‡å®šçš„å‚æ•°æ‰§è¡Œæ¨¡å—ï¼Œè€Œåœ¨æ¨¡å—å‚æ•°ä¸­å¯ä»¥ä½¿ç”¨å˜é‡ã€‚æ¨¡å—æ‰§
è¡Œæ˜¯å¹‚ç­‰çš„ï¼Œè¿™æ„å‘³ç€å¤šæ¬¡æ‰§è¡Œæ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºå…¶ç»“æœå‡ä¸€è‡´
</p>

<p>
æ¯ä¸ªtaskéƒ½åº”è¯¥æœ‰å…¶nameï¼Œç”¨äºplaybookçš„æ‰§è¡Œç»“æœè¾“å‡ºï¼Œå»ºè®®å…¶å†…å®¹èƒ½æ¸…æ™°åœ°
æè¿°ä»»åŠ¡æ‰§è¡Œæ­¥éª¤ã€‚å¦‚æœæœªæä¾›nameï¼Œåˆ™actionçš„ç»“æœå°†ç”¨äºè¾“å‡º
</p>

<p>
<b>taskä¸¤ç§æ ¼å¼</b> ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">action: module arguments
module: arguments &#24314;&#35758;&#20351;&#29992;
</pre>
</div>

<p>
æ³¨æ„ï¼šshellå’Œcommandæ¨¡å—åé¢è·Ÿå‘½ä»¤ï¼Œè€Œékey=value
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: install httpd
      yum: <span style="color: #a0522d;">name</span>=httpd
    - name: start httpd
      service: <span style="color: #a0522d;">name</span>=httpd <span style="color: #a0522d;">state</span>=started <span style="color: #a0522d;">enabled</span>=yes
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2fbe5631-b9c5-4f43-af46-3f50b4a7ee4b" class="outline-4">
<h4 id="h:2fbe5631-b9c5-4f43-af46-3f50b4a7ee4b">å…¶å®ƒç»„ä»¶</h4>
<div class="outline-text-4" id="text-h:2fbe5631-b9c5-4f43-af46-3f50b4a7ee4b">
<p>
æŸä»»åŠ¡çš„çŠ¶æ€åœ¨è¿è¡Œåä¸ºchangedæ—¶ï¼Œå¯é€šè¿‡â€notifyâ€é€šçŸ¥ç»™ç›¸åº”çš„handlers
</p>

<p>
ä»»åŠ¡å¯ä»¥é€šè¿‡â€tagsâ€æ‰“æ ‡ç­¾ï¼Œå¯åœ¨ansible-playbookå‘½ä»¤ä¸Šä½¿ç”¨-tæŒ‡å®šè¿›è¡Œè°ƒç”¨
</p>
</div>
</div>
<div id="outline-container-h:1f8b94d9-f2bb-4821-9d8a-35e5a61034c8" class="outline-4">
<h4 id="h:1f8b94d9-f2bb-4821-9d8a-35e5a61034c8">ShellScripts VS Playbook æ¡ˆä¾‹</h4>
<div class="outline-text-4" id="text-h:1f8b94d9-f2bb-4821-9d8a-35e5a61034c8">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">SHELL&#33050;&#26412;&#23454;&#29616;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;Apache</span>
yum install --quiet -y httpd
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22797;&#21046;&#37197;&#32622;&#25991;&#20214;</span>
cp /tmp/httpd.conf /etc/httpd/conf/httpd.conf
cp/tmp/vhosts.conf /etc/httpd/conf.d/
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160;Apache&#65292;&#24182;&#35774;&#32622;&#24320;&#26426;&#21551;&#21160;</span>
systemctl enable --now httpd

<span style="color: #b22222;">#</span><span style="color: #b22222;">Playbook&#23454;&#29616;</span>
---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: <span style="color: #8b2252;">"&#23433;&#35013;Apache"</span>
      yum: <span style="color: #a0522d;">name</span>=httpd
    - name: <span style="color: #8b2252;">"&#22797;&#21046;&#37197;&#32622;&#25991;&#20214;"</span>
      copy: <span style="color: #a0522d;">src</span>=/tmp/httpd.conf <span style="color: #a0522d;">dest</span>=/etc/httpd/conf/
    - name: <span style="color: #8b2252;">"&#22797;&#21046;&#37197;&#32622;&#25991;&#20214;"</span>
      copy: <span style="color: #a0522d;">src</span>=/tmp/vhosts.conf <span style="color: #a0522d;">dest</span>=/etc/httpd/conf.d/
    - name: <span style="color: #8b2252;">"&#21551;&#21160;Apache&#65292;&#24182;&#35774;&#32622;&#24320;&#26426;&#21551;&#21160;"</span>
      service: <span style="color: #a0522d;">name</span>=httpd <span style="color: #a0522d;">state</span>=started <span style="color: #a0522d;">enabled</span>=yes
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:90f0a6a6-bd2c-4a6e-bdaf-fddd8ea1c3d3" class="outline-3">
<h3 id="h:90f0a6a6-bd2c-4a6e-bdaf-fddd8ea1c3d3">playbook å‘½ä»¤</h3>
<div class="outline-text-3" id="text-h:90f0a6a6-bd2c-4a6e-bdaf-fddd8ea1c3d3">
<p>
æ ¼å¼
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible-playbook &lt;filename.yml&gt; ... [options]
</pre>
</div>

<p>
å¸¸è§é€‰é¡¹
</p>

<div class="org-src-container">
<pre class="src src-sh">-C --check      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#26816;&#27979;&#21487;&#33021;&#20250;&#21457;&#29983;&#30340;&#25913;&#21464;&#65292;&#20294;&#19981;&#30495;&#27491;&#25191;&#34892;&#25805;&#20316;</span>
--list-hosts    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#36816;&#34892;&#20219;&#21153;&#30340;&#20027;&#26426;</span>
--list-tags     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;tag</span>
--list-tasks    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;task</span>
--limit &#20027;&#26426;&#21015;&#34920; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#38024;&#23545;&#20027;&#26426;&#21015;&#34920;&#20013;&#30340;&#29305;&#23450;&#20027;&#26426;&#25191;&#34892;</span>
-v -vv -vvv     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#36807;&#31243;</span>
</pre>
</div>

<p>
èŒƒä¾‹:
</p>

<div class="org-src-container">
<pre class="src src-yaml">[root@ansible ansible]#cat hello.yml
---
- hosts: websrvs
  tasks:
    - name: hello
      command: echo "hello ansible"
[root@ansible ansible]#ansible-playbook hello.yml
[root@ansible ansible]#ansible-playbook -v hello.yml

[root@ansible ansible]#ansible-playbook --list-tasks hello.yml 
playbook: hello.yml
  play #1 (websrvs): websrvs    TAGS: []
    tasks:
      æ˜¯å¦å­˜æ´»    TAGS: []
      æ¸…ç†/data/    TAGS: []
[root@ansible ansible]#ansible-playbook --list-hosts hello.yml 
playbook: hello.yml
  play #1 (websrvs): websrvs    TAGS: []
    pattern: ['websrvs']
    hosts (2):
      10.0.0.8
      10.0.0.7
</pre>
</div>

<p>
èŒƒä¾‹
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible-playbook file.yml --check <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#26816;&#27979;</span>
ansible-playbook file.yml
ansible-playbook file.yml --limit websrvs
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cc8a752f-f1c5-4d3c-94ff-e476c563ec18" class="outline-3">
<h3 id="h:cc8a752f-f1c5-4d3c-94ff-e476c563ec18">Playbook åˆæ­¥</h3>
<div class="outline-text-3" id="text-h:cc8a752f-f1c5-4d3c-94ff-e476c563ec18">
</div>
<div id="outline-container-h:c421ffdf-e86b-4b2d-915d-5be92b78f934" class="outline-4">
<h4 id="h:c421ffdf-e86b-4b2d-915d-5be92b78f934">åˆ©ç”¨ playbook åˆ›å»º mysql ç”¨æˆ·</h4>
<div class="outline-text-4" id="text-h:c421ffdf-e86b-4b2d-915d-5be92b78f934">
<p>
èŒƒä¾‹ï¼šmysql_user.yml
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: dbsrvs
  remote_user: root

  tasks:
    - {name: create group, group: name=mysql system=yes gid=306}
    - name: create user
    user: name=mysql shell=/sbin/nologin system=yes group=mysql uid=306 home=/data/mysql create_home=no
</pre>
</div>
</div>
</div>
<div id="outline-container-h:71df824e-7fc3-4e56-bf22-bc2dbb7ab3c9" class="outline-4">
<h4 id="h:71df824e-7fc3-4e56-bf22-bc2dbb7ab3c9">åˆ©ç”¨ playbook å®‰è£… nginx</h4>
<div class="outline-text-4" id="text-h:71df824e-7fc3-4e56-bf22-bc2dbb7ab3c9">
<p>
èŒƒä¾‹ï¼šinstall_nginx.yml
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
# install nginx
- hosts: websrvs
  remote_user: root
  tasks:
    - name: add group nginx
      user: name=nginx state=present
    - name: add user nginx
      user: name=nginx state=present group=nginx
    - name: Install Nginx
      yum: name=nginx state=present
    - name: web page
      copy: src=files/index.html dest=/usr/share/nginx/html/index.html
    - name: Start Nginx
      service: name=nginx state=started enabled=yes
</pre>
</div>
</div>
</div>
<div id="outline-container-h:399a9bc8-f1f3-4e26-876f-b2b9279f2bd9" class="outline-4">
<h4 id="h:399a9bc8-f1f3-4e26-876f-b2b9279f2bd9">åˆ©ç”¨ playbook å®‰è£…å’Œå¸è½½ httpd</h4>
<div class="outline-text-4" id="text-h:399a9bc8-f1f3-4e26-876f-b2b9279f2bd9">
<p>
èŒƒä¾‹ï¼šinstall_httpd.yml
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
#install httpd
- hosts: websrvs
  remote_user: root
  gather_facts: no
  tasks:
    - name: Install httpd
      yum: name=httpd state=present
    - name: Install configure file
      copy: src=files/httpd.conf dest=/etc/httpd/conf/
    - name: modify config
      lineinfile: path=/etc/httpd/conf/httpd.conf regexp='^Listen' line='Listen 8080'    
    - name: mkdir website dir
      file: path=/data/html state=directory
    - name: web html
      copy: src=files/index.html  dest=/data/html/
    - name: start service
      service: name=httpd state=started enabled=yes


ansible-playbook   install_httpd.yml --limit 10.0.0.8   #
</pre>
</div>

<p>
èŒƒä¾‹ï¼šremove_httpd.yml
</p>

<div class="org-src-container">
<pre class="src src-yaml">#remove_httpd.yml
---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: remove httpd package
      yum: name=httpd state=absent
    - name: remove apache user
      user: name=apache state=absent
    - name: remove config file
      file: name=/etc/httpd state=absent
    - name: remove web html
      file: name=/data/html/ state=absent
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8edf4e09-1c22-4cc5-82a7-c17043cdba1d" class="outline-4">
<h4 id="h:8edf4e09-1c22-4cc5-82a7-c17043cdba1d">åˆ©ç”¨ playbook å®‰è£… mysql</h4>
<div class="outline-text-4" id="text-h:8edf4e09-1c22-4cc5-82a7-c17043cdba1d">
<p>
<b>èŒƒä¾‹ï¼šå®‰è£…mysql-5.6.46-linux-glibc2.12</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#ls -l /data/ansible/files/mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz
-rw-r--r-- 1 root root 403177622 Dec 4 13:05 /data/ansible/files/mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz

[root@ansible ~]#cat /data/ansible/files/my.cnf
[mysqld]
<span style="color: #a0522d;">socket</span>=/tmp/mysql.sock
<span style="color: #a0522d;">user</span>=mysql
symbolic-links=0
<span style="color: #a0522d;">datadir</span>=/data/mysql
<span style="color: #a0522d;">innodb_file_per_table</span>=1
log-bin
pid-file=/data/mysql/mysqld.pid

[client]
<span style="color: #a0522d;">port</span>=3306
<span style="color: #a0522d;">socket</span>=/tmp/mysql.sock

[mysqld_safe]
log-error=/var/log/mysqld.log

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#20840;&#21152;&#22266;&#33050;&#26412;,&#35774;&#23494;&#30721;</span>
[root@ansible ~]#cat /data/ansible/files/secure_mysql.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
/usr/local/mysql/bin/mysql_secure_installation &lt;&lt;EOF

<span style="color: #ffa54f;">y</span>
<span style="color: #ffa54f;">cici</span>
<span style="color: #ffa54f;">cici</span>
<span style="color: #ffa54f;">y</span>
<span style="color: #ffa54f;">y </span>
<span style="color: #ffa54f;">y </span>
<span style="color: #ffa54f;">y</span>
<span style="color: #ffa54f;">EOF</span>

[root@ansible ~]#tree /data/ansible/files/
/data/ansible/files/
&#9500;&#9472;&#9472; my.cnf
&#9500;&#9472;&#9472; mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz
&#9492;&#9472;&#9472; secure_mysql.sh

0 directories, 3 files

[root@ansible ~]#cat /data/ansible/install_mysql.yml
---
<span style="color: #b22222;"># </span><span style="color: #b22222;">install mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz</span>
- hosts: dbsrvs
  remote_user: root
  gather_facts: no
  tasks:
    - name: install packages
      yum: <span style="color: #a0522d;">name</span>=libaio,perl-Data-Dumper,perl-Getopt-Long
    - name: create mysql group
      group: <span style="color: #a0522d;">name</span>=mysql <span style="color: #a0522d;">gid</span>=306
    - name: create mysql user
      user: <span style="color: #a0522d;">name</span>=mysql <span style="color: #a0522d;">uid</span>=306 <span style="color: #a0522d;">group</span>=mysql <span style="color: #a0522d;">shell</span>=/sbin/nologin <span style="color: #a0522d;">system</span>=yes
<span style="color: #a0522d;">create_home</span>=no <span style="color: #a0522d;">home</span>=/data/mysql
    - name: copy tar to remote host and file mode
      unarchive: <span style="color: #a0522d;">src</span>=/data/ansible/files/mysql-5.6.46-linux-glibc2.12-
x86_64.tar.gz <span style="color: #a0522d;">dest</span>=/usr/local/ <span style="color: #a0522d;">owner</span>=root <span style="color: #a0522d;">group</span>=root
    - name: create linkfile /usr/local/mysql
      file: <span style="color: #a0522d;">src</span>=/usr/local/mysql-5.6.46-linux-glibc2.12-x86_64
<span style="color: #a0522d;">dest</span>=/usr/local/mysql <span style="color: #a0522d;">state</span>=link
    - name: data dir
      shell: <span style="color: #a0522d;">chdir</span>=/usr/local/mysql/ ./scripts/mysql_install_db --
<span style="color: #a0522d;">datadir</span>=/data/mysql --user=mysql
      tags: data
    - name: config my.cnf
      copy: <span style="color: #a0522d;">src</span>=/data/ansible/files/my.cnf  <span style="color: #a0522d;">dest</span>=/etc/my.cnf
    - name: service script
      shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
    - name: enable service
      shell: /etc/init.d/mysqld start;chkconfig --add mysqld;chkconfig mysqld on
      tags: service
    - name: PATH variable
      copy: <span style="color: #a0522d;">content</span>=<span style="color: #8b2252;">'PATH=/usr/local/mysql/bin:$PATH'</span> <span style="color: #a0522d;">dest</span>=/etc/profile.d/mysql.sh
    - name: secure script
      script: /data/ansible/files/secure_mysql.sh
      tags: script
---
<span style="color: #b22222;">#</span><span style="color: #b22222;">Installing MariaDB Binary </span>
</pre>
</div>

<p>
<b>å®‰è£…MySQLé”™è¯¯é—®é¢˜æ•´ç†</b>:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ansible]#ansible-playbook  install_mysql5.6.yml --limit 10.0.0.8
TASK [secure script] **************************************************************
fatal: [10.0.0.8]: FAILED! =&gt; {<span style="color: #8b2252;">"changed"</span>: true, <span style="color: #8b2252;">"msg"</span>: <span style="color: #8b2252;">"non-zero return code"</span>, <span style="color: #8b2252;">"rc"</span>: 29, <span style="color: #8b2252;">"stderr"</span>: <span style="color: #8b2252;">"Shared connection to 10.0.0.8 closed.\r\n"</span>, <span style="color: #8b2252;">"stderr_lines"</span>: [<span style="color: #8b2252;">"Shared connection to 10.0.0.8 closed."</span>], <span style="color: #8b2252;">"stdout"</span>: <span style="color: #8b2252;">"Can't find a 'mysql' client in PATH or ./bin\r\nCleaning up...\r\nWarning: Could not unlink .my.cnf.3304: No such file or directory\r\nWarning: Could not unlink .mysql.3304: No such file or directory\r\n"</span>, <span style="color: #8b2252;">"stdout_lines"</span>: [<span style="color: #8b2252;">"Can't find a 'mysql' client in PATH or ./bin"</span>, <span style="color: #8b2252;">"Cleaning up..."</span>, <span style="color: #8b2252;">"Warning: Could not unlink .my.cnf.3304: No such file or directory"</span>, <span style="color: #8b2252;">"Warning: Could not unlink .mysql.3304: No such file or directory"</span>]}
PLAY RECAP ************************************************************************
10.0.0.8                   : <span style="color: #a0522d;">ok</span>=10   <span style="color: #a0522d;">changed</span>=10   <span style="color: #a0522d;">unreachable</span>=0    <span style="color: #a0522d;">failed</span>=1    <span style="color: #a0522d;">skipped</span>=0    <span style="color: #a0522d;">rescued</span>=0    <span style="color: #a0522d;">ignored</span>=0  

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25171;&#24320;&#30446;&#26631;&#20027;&#26426;,mysql&#31471;&#21475;&#24050;&#25171;&#24320;,&#20294;&#26159;&#21629;&#20196;&#25214;&#19981;&#21040;,&#21035;&#30528;&#24613;,&#36864;&#20986;&#37325;&#36827;</span>
[root@centos8 ~]#ss -ntl
State    Recv-Q    Send-Q          Local Address:Port         Peer Address:Port    
LISTEN   0         128                   0.0.0.0:111               0.0.0.0:*       
LISTEN   0         128                   0.0.0.0:22                0.0.0.0:*       
LISTEN   0         128                   0.0.0.0:5355              0.0.0.0:*       
LISTEN   0         128                      [::]:111                  [::]:*       
LISTEN   0         128                      [::]:22                   [::]:*       
LISTEN   0         80                          *:3306                    *:*       
LISTEN   0         128                      [::]:5355                 [::]:*       
[root@centos8 ~]#mysql
-bash: mysql: command not found
[root@centos8 ~]#exit

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20877;&#27425;&#25191;&#34892;&#21629;&#20196;&#26174;&#31034;&#32570;&#21253;</span>
[root@centos8 ~]#mysql
mysql: error while loading shared libraries: libncurses.so.5: cannot open shared object file: No such file or directory
[root@centos8 ~]#yum -y  install libaio numactl-libs ncurses-compat-libs libncurses.so.5

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30331;&#38470;&#25104;&#21151;</span>
[root@centos8 ~]#mysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 1
Server version: 5.6.47-log MySQL Community Server (GPL)

<span style="color: #0000ff;">Copyright</span> (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type <span style="color: #8b2252;">'help;'</span> or <span style="color: #8b2252;">'\h'</span> for help. Type <span style="color: #8b2252;">'\c'</span> to clear the current input statement.

mysql&gt; 
</pre>
</div>

<p>
<b>èŒƒä¾‹ï¼šinstall_mariadb.yml</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">---
<span style="color: #b22222;">#</span><span style="color: #b22222;">Installing MariaDB Binary Tarballs</span>
- hosts: dbsrvs
  remote_user: root
  gather_facts: no
  tasks:
    - name: create group
      group: <span style="color: #a0522d;">name</span>=mysql <span style="color: #a0522d;">gid</span>=27 <span style="color: #a0522d;">system</span>=yes
    - name: create user
      user: <span style="color: #a0522d;">name</span>=mysql <span style="color: #a0522d;">uid</span>=27 <span style="color: #a0522d;">system</span>=yes <span style="color: #a0522d;">group</span>=mysql <span style="color: #a0522d;">shell</span>=/sbin/nologin <span style="color: #a0522d;">home</span>=/data/mysql <span style="color: #a0522d;">create_home</span>=no
    - name: mkdir datadir
      file: <span style="color: #a0522d;">path</span>=/data/mysql <span style="color: #a0522d;">owner</span>=mysql <span style="color: #a0522d;">group</span>=mysql <span style="color: #a0522d;">state</span>=directory
    - name: unarchive package
      unarchive: <span style="color: #a0522d;">src</span>=/data/ansible/files/mariadb-10.2.27-linux-x86_64.tar.gz <span style="color: #a0522d;">dest</span>=/usr/local/ <span style="color: #a0522d;">owner</span>=root <span style="color: #a0522d;">group</span>=root
    - name: link
      file: <span style="color: #a0522d;">src</span>=/usr/local/mariadb-10.2.27-linux-x86_64 <span style="color: #a0522d;">path</span>=/usr/local/mysql <span style="color: #a0522d;">state</span>=link
    - name: install database
      shell: <span style="color: #a0522d;">chdir</span>=/usr/local/mysql   ./scripts/mysql_install_db -- <span style="color: #a0522d;">datadir</span>=/data/mysql --user=mysql
    - name: config file
      copy: <span style="color: #a0522d;">src</span>=/data/ansible/files/my.cnf  <span style="color: #a0522d;">dest</span>=/etc/ <span style="color: #a0522d;">backup</span>=yes
    - name: service script
      shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
    - name: start service
      service: <span style="color: #a0522d;">name</span>=mysqld <span style="color: #a0522d;">state</span>=started <span style="color: #a0522d;">enabled</span>=yes
    - name: PATH variable
      copy: <span style="color: #a0522d;">content</span>=<span style="color: #8b2252;">'PATH=/usr/local/mysql/bin:$PATH'</span> <span style="color: #a0522d;">dest</span>=/etc/profile.d/mysql.sh
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:48b1755b-669a-4d64-84c7-31ad695adc4b" class="outline-3">
<h3 id="h:48b1755b-669a-4d64-84c7-31ad695adc4b">Playbookä¸­ä½¿ç”¨handlerså’Œnotify</h3>
<div class="outline-text-3" id="text-h:48b1755b-669a-4d64-84c7-31ad695adc4b">
<p>
Handlersæœ¬è´¨æ˜¯task list
ï¼Œç±»ä¼¼äºMySQLä¸­çš„è§¦å‘å™¨è§¦å‘çš„è¡Œä¸ºï¼Œå…¶ä¸­çš„taskä¸å‰è¿°çš„taskå¹¶æ²¡æœ‰æœ¬è´¨ä¸Šçš„ä¸åŒï¼Œä¸»è¦ç”¨äºå½“å…³æ³¨çš„èµ„æºå‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡‡å–ä¸€å®šçš„æ“ä½œã€‚è€ŒNotifyå¯¹åº”çš„actionå¯ç”¨äºåœ¨æ¯ä¸ªplayçš„æœ€åè¢«è§¦å‘ï¼Œè¿™æ ·å¯é¿å…å¤šæ¬¡æœ‰æ”¹å˜å‘ç”Ÿæ—¶æ¯æ¬¡éƒ½æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œï¼Œä»…åœ¨æ‰€æœ‰çš„å˜åŒ–å‘ç”Ÿå®Œæˆåä¸€æ¬¡æ€§åœ°æ‰§è¡ŒæŒ‡å®šæ“ä½œã€‚åœ¨notifyä¸­åˆ—å‡ºçš„æ“ä½œç§°ä¸ºhandlerï¼Œä¹Ÿå³notifyä¸­è°ƒç”¨handlerä¸­å®šä¹‰çš„æ“ä½œ
</p>

<p>
æ¡ˆä¾‹:
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root
  gather_facts: no
  tasks:
    - name: Install httpd
      yum: name=httpd state=present
    - name: Install configure file
      copy: src=files/httpd.conf dest=/etc/httpd/conf/
      notify: restart httpd
    - name: ensure apache is running
      service: name=httpd state=started enabled=yes

  handlers:
    - name: restart httpd
      service: name=httpd state=restarted
</pre>
</div>

<p>
æ¡ˆä¾‹:
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root
  gather_facts: no
  tasks:
    - name: add group nginx
      user: name=nginx state=present
    - name: add user nginx
      user: name=nginx state=present group=nginx
    - name: Install Nginx
      yum: name=nginx state=present
    - name: config
      copy: src=/root/config.txt dest=/etc/nginx/nginx.conf
      notify:
        - Restart Nginx
        - Check Nginx Process

  handlers:
    - name: Restart Nginx
      service: name=nginx state=restarted enabled=yes
    - name: Check Nginx process
      shell: killall -0 nginx &amp;&gt; /tmp/nginx.log
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0a3aec5f-206c-42ec-83cc-6da69fa06720" class="outline-3">
<h3 id="h:0a3aec5f-206c-42ec-83cc-6da69fa06720">Playbookä¸­ä½¿ç”¨tagsç»„ä»¶</h3>
<div class="outline-text-3" id="text-h:0a3aec5f-206c-42ec-83cc-6da69fa06720">
<p>
åœ¨playbookæ–‡ä»¶ä¸­ï¼Œå¯ä»¥åˆ©ç”¨tagsç»„ä»¶ï¼Œä¸ºç‰¹å®š task
æŒ‡å®šæ ‡ç­¾ï¼Œå½“åœ¨æ‰§è¡Œplaybookæ—¶ï¼Œå¯ä»¥åªæ‰§è¡Œç‰¹å®štagsçš„task,è€Œéæ•´ä¸ªplaybookæ–‡ä»¶
</p>

<p>
æ¡ˆä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">vim httpd.yml
---
# tags example
- hosts: websrvs
  remote_user: root
  gather_facts: no

  tasks:
    - name: Install httpd
      yum: name=httpd state=present
    - name: Install configure file
      copy: src=files/httpd.conf dest=/etc/httpd/conf/
      tags: conf
    - name: start httpd service
      tags: service
      service: name=httpd state=started enabled=yes

ansible-playbook â€“t conf,service httpd.yml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e06de863-5a87-498b-83c6-3ee055a9206e" class="outline-3">
<h3 id="h:e06de863-5a87-498b-83c6-3ee055a9206e">Playbookä¸­ä½¿ç”¨å˜é‡</h3>
<div class="outline-text-3" id="text-h:e06de863-5a87-498b-83c6-3ee055a9206e">
<p>
å˜é‡åï¼šä»…èƒ½ç”±å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ç»„æˆï¼Œä¸”åªèƒ½ä»¥å­—æ¯å¼€å¤´
</p>

<p>
<b>å˜é‡å®šä¹‰</b> ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">variable</span>=value
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">http_port</span>=80
</pre>
</div>

<p>
<b>å˜é‡è°ƒç”¨æ–¹å¼</b> ï¼š
</p>

<p>
é€šè¿‡{{ variable_name }} è°ƒç”¨å˜é‡ï¼Œä¸”å˜é‡åå‰åå»ºè®®åŠ ç©ºæ ¼ï¼Œæœ‰æ—¶ç”¨â€{{
variable_name }}â€œæ‰ç”Ÿæ•ˆ
</p>

<p>
<b>å˜é‡æ¥æº</b> ï¼š
</p>

<ol class="org-ol">
<li>ansible çš„ setup facts è¿œç¨‹ä¸»æœºçš„æ‰€æœ‰å˜é‡éƒ½å¯ç›´æ¥è°ƒç”¨</li>

<li><p>
é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ï¼Œä¼˜å…ˆçº§æœ€é«˜
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible-playbook -e <span style="color: #a0522d;">varname</span>=value test.yml
</pre>
</div></li>

<li><p>
åœ¨playbookæ–‡ä»¶ä¸­å®šä¹‰
</p>

<pre class="example" id="orgdcfbda9">
vars:
- var1: value1
- var2: value2
</pre></li>

<li><p>
åœ¨ç‹¬ç«‹çš„å˜é‡YAMLæ–‡ä»¶ä¸­å®šä¹‰
</p>

<div class="org-src-container">
<pre class="src src-yaml">- hosts: all
  vars_files:
    - vars.yml
</pre>
</div></li>

<li><p>
åœ¨ /etc/ansible/hosts
</p>

<p>
ä¸­å®šä¹‰ä¸»æœºï¼ˆæ™®é€šï¼‰å˜é‡ï¼šä¸»æœºç»„ä¸­ä¸»æœºå•ç‹¬å®šä¹‰ï¼Œä¼˜å…ˆçº§é«˜äºå…¬å…±å˜é‡ç»„
ï¼ˆå…¬å…±ï¼‰å˜é‡ï¼šé’ˆå¯¹ä¸»æœºç»„ä¸­æ‰€æœ‰ä¸»æœºå®šä¹‰ç»Ÿä¸€å˜é‡
</p></li>

<li>åœ¨roleä¸­å®šä¹‰</li>
</ol>
</div>
<div id="outline-container-h:f0ba9bee-6110-4a70-9be2-40067a2ce7c1" class="outline-4">
<h4 id="h:f0ba9bee-6110-4a70-9be2-40067a2ce7c1">ä½¿ç”¨ setup æ¨¡å—ä¸­å˜é‡</h4>
<div class="outline-text-4" id="text-h:f0ba9bee-6110-4a70-9be2-40067a2ce7c1">
<p>
æœ¬æ¨¡å—è‡ªåŠ¨åœ¨playbookè°ƒç”¨ï¼Œä¸è¦ç”¨ansibleå‘½ä»¤è°ƒç”¨
</p>

<p>
æ¡ˆä¾‹ï¼šä½¿ç”¨setupå˜é‡
</p>

<div class="org-src-container">
<pre class="src src-yaml">ansible 10.0.0.101 -m setup -a 'filter="ansible_default_ipv4"'
10.0.0.101 | SUCCESS =&gt; {
    "ansible_facts": {
        "ansible_default_ipv4": {
            "address": "10.0.0.101",
            "alias": "eth0",
            "broadcast": "10.0.0.255",
            "gateway": "10.0.0.2",
            "interface": "eth0",
            "macaddress": "00:0c:29:e8:c7:9b",
            "mtu": 1500,
            "netmask": "255.255.255.0",
            "network": "10.0.0.0",
            "type": "ether"
        }
    },
    "changed": false
}
</pre>
</div>

<p>
èŒƒä¾‹:
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
#var1.yml
- hosts: all
  remote_user: root
  gather_facts: yes
  tasks:
    - name: create log file
      file: name=/data/{{ ansible_nodename }}.log state=touch owner=cui mode=600

ansible-playbook var.yml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e090a3ba-479e-45f7-a157-e6cd7a18dd95" class="outline-4">
<h4 id="h:e090a3ba-479e-45f7-a157-e6cd7a18dd95">åœ¨playbook å‘½ä»¤è¡Œä¸­å®šä¹‰å˜é‡</h4>
<div class="outline-text-4" id="text-h:e090a3ba-479e-45f7-a157-e6cd7a18dd95">
<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">vim var2.yml
---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: install package
      yum: name={{ pkname }} state=present

ansible-playbook â€“e pkname=httpd var2.yml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0a31f3d4-29d0-4a1c-8f5d-311d8d705a47" class="outline-4">
<h4 id="h:0a31f3d4-29d0-4a1c-8f5d-311d8d705a47">åœ¨playbookæ–‡ä»¶ä¸­å®šä¹‰å˜é‡</h4>
<div class="outline-text-4" id="text-h:0a31f3d4-29d0-4a1c-8f5d-311d8d705a47">
<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">vim var3.yml
---
- hosts: websrvs
  remote_user: root
  vars:
    - username: user1
    - groupname: group1

  tasks:
    - name: create group
      group: name={{ groupname }} state=present
    - name: create user
      user: name={{ username }} group={{ groupname }} state=present

ansible-playbook -e "username=user2 groupname=group2" var3.yml
#-eçš„ä¼˜å…ˆçº§æ¯”playbookä¸­é«˜
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">cat var4.yaml
---
  - hosts: websrvs
    remote_user: root
    vars:       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21464;&#37327;&#30340;&#23450;&#20041;&#26041;&#24335;,&#20540;&#20174;setup&#27169;&#22359;&#20013;&#26469;,&#29983;&#25104;&#19968;&#20010;&#21644;IP&#22320;&#22336;&#21516;&#21517;&#30340;&#25991;&#20214;&#22841;</span>
      collect_info: <span style="color: #8b2252;">"/data/test/{{ansible_default_ipv4['address']}}/"</span>

    tasks:
      - name: create IP directory
        file: <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"{{collect_info}}"</span> <span style="color: #a0522d;">state</span>=directory 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;&#32467;&#26524;</span>
tree /data/test/
/data/test/
&#9492;&#9472;&#9472; 10.0.0.102

1 directory, 0 files
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e59a6767-d5f6-421b-987f-666121c1e7d3" class="outline-4">
<h4 id="h:e59a6767-d5f6-421b-987f-666121c1e7d3">ä½¿ç”¨å˜é‡æ–‡ä»¶</h4>
<div class="outline-text-4" id="text-h:e59a6767-d5f6-421b-987f-666121c1e7d3">
<p>
å¯ä»¥åœ¨ä¸€ä¸ªç‹¬ç«‹çš„playbookæ–‡ä»¶ä¸­å®šä¹‰å˜é‡ï¼Œåœ¨å¦ä¸€ä¸ªplaybookæ–‡ä»¶ä¸­å¼•ç”¨å˜é‡æ–‡ä»¶ä¸­çš„å˜é‡ï¼Œæ¯”playbookä¸­å®šä¹‰çš„å˜é‡ä¼˜åŒ–çº§é«˜
</p>

<div class="org-src-container">
<pre class="src src-yaml">vim vars.yml   #åªè´Ÿè´£å®šä¹‰å˜é‡
---
# variables file
package_name: mariadb-server
service_name: mariadb

vim var5.yml
---
#install package and start service
- hosts: dbsrvs
  remote_user: root
  vars_files:
    - vars.yml

  tasks:
    - name: install package
      yum: name={{ package_name }}
      tags: install
    - name: start service
      service: name={{ service_name }} state=started enabled=yes
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">cat vars2.yml
---
var1: httpd
var2: nginx

cat var6.yml
---        
- hosts: web
  remote_user: root
  vars_files:
    - vars2.yml

  tasks:
    - name: create httpd log
      file: name=/app/{{ var1 }}.log state=touch
    - name: create nginx log
      file: name=/app/{{ var2 }}.log state=touch
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fd507cde-3910-48c8-b136-a9facc62f707" class="outline-4">
<h4 id="h:fd507cde-3910-48c8-b136-a9facc62f707">ä¸»æœºæ¸…å•æ–‡ä»¶ä¸­å®šä¹‰å˜é‡</h4>
<div class="outline-text-4" id="text-h:fd507cde-3910-48c8-b136-a9facc62f707">
</div>
<div id="outline-container-h:5fbc0907-d431-44ae-af3f-b1a1be551f2a" class="outline-5">
<h5 id="h:5fbc0907-d431-44ae-af3f-b1a1be551f2a">ä¸»æœºå˜é‡</h5>
<div class="outline-text-5" id="text-h:5fbc0907-d431-44ae-af3f-b1a1be551f2a">
<p>
åœ¨inventory ä¸»æœºæ¸…å•æ–‡ä»¶ä¸­ä¸ºæŒ‡å®šçš„ä¸»æœºå®šä¹‰å˜é‡ä»¥ä¾¿äºåœ¨playbookä¸­ä½¿ç”¨
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">[websrvs]
www1.cici.com http_port=80 maxRequestsPerChild=808
www2.cici.com http_port=8080 maxRequestsPerChild=909
</pre>
</div>
</div>
</div>
<div id="outline-container-h:daf87a79-1124-4aeb-b186-50bbef4e4b34" class="outline-5">
<h5 id="h:daf87a79-1124-4aeb-b186-50bbef4e4b34">ç»„ï¼ˆå…¬å…±ï¼‰å˜é‡</h5>
<div class="outline-text-5" id="text-h:daf87a79-1124-4aeb-b186-50bbef4e4b34">
<p>
åœ¨inventory
ä¸»æœºæ¸…å•æ–‡ä»¶ä¸­èµ‹äºˆç»™æŒ‡å®šç»„å†…æ‰€æœ‰ä¸»æœºä¸Šçš„åœ¨playbookä¸­å¯ç”¨çš„å˜é‡ï¼Œå¦‚æœå’Œä¸»æœºå˜æ˜¯åŒåï¼Œä¼˜å…ˆçº§ä½äºä¸»æœºå˜é‡
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">[websrvs]
www1.cici.com <span style="color: #a0522d;">http_port</span>=8080
www2.cici.com
[websrvs:vars]
<span style="color: #a0522d;">http_port</span>=80
<span style="color: #a0522d;">ntp_server</span>=ntp.cici.com
<span style="color: #a0522d;">nfs_server</span>=nfs.cici.com
</pre>
</div>

<p>
èŒƒä¾‹ï¼š é€šè¿‡å˜é‡ç”Ÿæˆä¸»æœºå
</p>

<div class="org-src-container">
<pre class="src src-sh">vim /etc/ansible/hosts

[websrvs]
10.0.0.8 <span style="color: #a0522d;">hname</span>=www1 <span style="color: #a0522d;">domain</span>=cici.io
10.0.0.7 <span style="color: #a0522d;">hname</span>=www2

[websvrs:vars]
<span style="color: #a0522d;">mark</span>=<span style="color: #8b2252;">"-"</span>
<span style="color: #a0522d;">domain</span>=cici.org


[root@ansible ansible]#ansible websrvs -m hostname -a <span style="color: #8b2252;">'name={{ hname }}{{ mark }}{{ domain }}'</span>
10.0.0.7 | <span style="color: #a0522d;">CHANGED</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"ansible_domain"</span>: <span style="color: #8b2252;">"org"</span>,
        <span style="color: #8b2252;">"ansible_fqdn"</span>: <span style="color: #8b2252;">"www2-cici.org"</span>,
        <span style="color: #8b2252;">"ansible_hostname"</span>: <span style="color: #8b2252;">"www2-cici"</span>,
        <span style="color: #8b2252;">"ansible_nodename"</span>: <span style="color: #8b2252;">"www2-cici.org"</span>,
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/bin/python"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: true,
    <span style="color: #8b2252;">"name"</span>: <span style="color: #8b2252;">"www2-cici.org"</span>
}
10.0.0.8 | <span style="color: #a0522d;">CHANGED</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"ansible_domain"</span>: <span style="color: #8b2252;">"io"</span>,
        <span style="color: #8b2252;">"ansible_fqdn"</span>: <span style="color: #8b2252;">"www1-cici.io"</span>,
        <span style="color: #8b2252;">"ansible_hostname"</span>: <span style="color: #8b2252;">"www1-cici"</span>,
        <span style="color: #8b2252;">"ansible_nodename"</span>: <span style="color: #8b2252;">"www1-cici.io"</span>,
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/libexec/platform-python"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: true,
    <span style="color: #8b2252;">"name"</span>: <span style="color: #8b2252;">"www1-cici.io"</span>
}


bash
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21629;&#20196;&#34892;&#25351;&#23450;&#21464;&#37327;&#65306;</span>
ansible websvrs &#8211;e <span style="color: #a0522d;">domain</span>=cici.cn &#8211;m hostname &#8211;a    <span style="color: #8b2252;">'name={{ hname }}{{ mark</span>
<span style="color: #8b2252;">}}{{ domain }}'</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:5578fa90-9c01-456a-9bd4-e660f888a8d5" class="outline-3">
<h3 id="h:5578fa90-9c01-456a-9bd4-e660f888a8d5">template æ¨¡æ¿</h3>
<div class="outline-text-3" id="text-h:5578fa90-9c01-456a-9bd4-e660f888a8d5">
<p>
æ¨¡æ¿æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå¯ä»¥åšä¸ºç”Ÿæˆæ–‡ä»¶çš„æ¨¡ç‰ˆï¼Œå¹¶ä¸”æ¨¡æ¿æ–‡ä»¶ä¸­è¿˜å¯åµŒå¥—jinjaè¯­æ³•
</p>
</div>
<div id="outline-container-h:24650b76-fac2-4002-aa7d-a0e80b33dd08" class="outline-4">
<h4 id="h:24650b76-fac2-4002-aa7d-a0e80b33dd08">jinja2è¯­è¨€</h4>
<div class="outline-text-4" id="text-h:24650b76-fac2-4002-aa7d-a0e80b33dd08">
<p>
å®˜æ–¹ç½‘ç«™ï¼š
</p>

<p>
<a href="http://jinja.pocoo.org/">http://jinja.pocoo.org/</a>
</p>

<p>
<a href="https://jinja.palletsprojects.com/en/2.11.x/">https://jinja.palletsprojects.com/en/2.11.x/</a>
</p>

<p>
jinja2 è¯­è¨€ä½¿ç”¨å­—é¢é‡ï¼Œæœ‰ä¸‹é¢å½¢å¼ï¼š
</p>
<pre class="example" id="org5399e7a">
- å­—ç¬¦ä¸²ï¼šä½¿ç”¨å•å¼•å·æˆ–åŒå¼•å·
- æ•°å­—ï¼šæ•´æ•°ï¼Œæµ®ç‚¹æ•°
- åˆ—è¡¨ï¼š[item1, item2, ...]
- å…ƒç»„ï¼š(item1, item2, ...)
- å­—å…¸ï¼š{key1:value1, key2:value2, ...}
- å¸ƒå°”å‹ï¼štrue/false
- ç®—æœ¯è¿ç®—ï¼š+, -, *, /, //, %, **
- æ¯”è¾ƒæ“ä½œï¼š==, !=, &gt;, &gt;=, &lt;, &lt;=
- é€»è¾‘è¿ç®—ï¼šandï¼Œorï¼Œnot
- æµè¡¨è¾¾å¼ï¼šForï¼ŒIfï¼ŒWhen
</pre>

<p>
<b>å­—é¢é‡</b> ï¼š
</p>

<p>
è¡¨è¾¾å¼æœ€ç®€å•çš„å½¢å¼å°±æ˜¯å­—é¢é‡ã€‚å­—é¢é‡è¡¨ç¤ºè¯¸å¦‚å­—ç¬¦ä¸²å’Œæ•°å€¼çš„ Pythonå¯¹è±¡ã€‚
å¦‚â€Hello Worldâ€åŒå¼•å·æˆ–å•å¼•å·ä¸­é—´çš„ä¸€åˆ‡éƒ½æ˜¯å­—ç¬¦ä¸²ã€‚æ— è®ºä½•æ—¶ä½ éœ€è¦åœ¨
æ¨¡æ¿ä¸­ä½¿ç”¨ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆæ¯”å¦‚å‡½æ•°è°ƒç”¨ã€è¿‡æ»¤å™¨æˆ–åªæ˜¯åŒ…å«æˆ–ç»§æ‰¿ä¸€ä¸ªæ¨¡æ¿çš„å‚
æ•°ï¼‰ï¼Œå¦‚42ï¼Œ42.23æ•°å€¼å¯ä»¥ä¸ºæ•´æ•°å’Œæµ®ç‚¹æ•°ã€‚å¦‚æœæœ‰å°æ•°ç‚¹ï¼Œåˆ™ä¸ºæµ®ç‚¹æ•°ï¼Œå¦
åˆ™ä¸ºæ•´æ•°ã€‚åœ¨ Pythoné‡Œï¼Œ 42 å’Œ 42.0 æ˜¯ä¸ä¸€æ ·çš„
</p>

<p>
<b>ç®—æœ¯è¿ç®—</b> ï¼š
</p>

<pre class="example" id="org3a551e4">
+ï¼šæŠŠä¸¤ä¸ªå¯¹è±¡åŠ åˆ°ä¸€èµ·ã€‚é€šå¸¸å¯¹è±¡æ˜¯ç´ è´¨ï¼Œä½†æ˜¯å¦‚æœä¸¤è€…æ˜¯å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ï¼Œä½ å¯ä»¥ç”¨è¿™ ç§æ–¹å¼æ¥è¡”æ¥å®ƒä»¬ã€‚æ— è®ºå¦‚ä½•è¿™ä¸æ˜¯é¦–é€‰çš„è¿æ¥å­—ç¬¦ä¸²çš„æ–¹å¼ï¼è¿æ¥å­—ç¬¦ä¸²è§ ~ è¿ç®—ç¬¦ã€‚ {{ 1 + 1 }} ç­‰äº 2
-ï¼šç”¨ç¬¬ä¸€ä¸ªæ•°å‡å»ç¬¬äºŒä¸ªæ•°ã€‚ {{ 3 - 2 }} ç­‰äº 1
/ï¼šå¯¹ä¸¤ä¸ªæ•°åšé™¤æ³•ã€‚è¿”å›å€¼ä¼šæ˜¯ä¸€ä¸ªæµ®ç‚¹æ•°ã€‚ {{ 1 / 2 }} ç­‰äº 0.5
//ï¼šå¯¹ä¸¤ä¸ªæ•°åšé™¤æ³•ï¼Œè¿”å›æ•´æ•°å•†ã€‚ {{ 20 // 7 }} ç­‰äº 2
%ï¼šè®¡ç®—æ•´æ•°é™¤æ³•çš„ä½™æ•°ã€‚ {{ 11 % 7 }} ç­‰äº 4
*ï¼šç”¨å³è¾¹çš„æ•°ä¹˜å·¦è¾¹çš„æ“ä½œæ•°ã€‚ {{ 2 * 2 }} ä¼šè¿”å› 4 ã€‚ä¹Ÿå¯ä»¥ç”¨äºé‡ å¤ä¸€ä¸ªå­—ç¬¦ä¸²å¤šæ¬¡ã€‚ {{ '=' * 80 }}ä¼šæ‰“å° 80 ä¸ªç­‰å·çš„æ¨ªæ¡\
**ï¼šå–å·¦æ“ä½œæ•°çš„å³æ“ä½œæ•°æ¬¡å¹‚ã€‚ {{ 2**3 }} ä¼šè¿”å› 8
</pre>


<p>
<b>æ¯”è¾ƒæ“ä½œç¬¦</b>
</p>
<pre class="example" id="org142e101">
== æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰
!= æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ä¸ç­‰
&gt; å¦‚æœå·¦è¾¹å¤§äºå³è¾¹ï¼Œè¿”å› true
&gt;= å¦‚æœå·¦è¾¹å¤§äºç­‰äºå³è¾¹ï¼Œè¿”å› true
&lt; å¦‚æœå·¦è¾¹å°äºå³è¾¹ï¼Œè¿”å› true
&lt;= å¦‚æœå·¦è¾¹å°äºç­‰äºå³è¾¹ï¼Œè¿”å› true
</pre>

<p>
<b>é€»è¾‘è¿ç®—ç¬¦</b>
</p>
<pre class="example" id="orgff885ed">
å¯¹äº if è¯­å¥ï¼Œåœ¨ for è¿‡æ»¤æˆ– if è¡¨è¾¾å¼ä¸­ï¼Œå®ƒå¯ä»¥ç”¨äºè”åˆå¤šä¸ªè¡¨è¾¾å¼
and å¦‚æœå·¦æ“ä½œæ•°å’Œå³æ“ä½œæ•°åŒä¸ºçœŸï¼Œè¿”å› true
or å¦‚æœå·¦æ“ä½œæ•°å’Œå³æ“ä½œæ•°æœ‰ä¸€ä¸ªä¸ºçœŸï¼Œè¿”å› true
not å¯¹ä¸€ä¸ªè¡¨è¾¾å¼å–å
(expr)è¡¨è¾¾å¼ç»„
true / false true æ°¸è¿œæ˜¯ true ï¼Œè€Œ false å§‹ç»ˆæ˜¯ false
</pre>
</div>
</div>
<div id="outline-container-h:4196f992-ed9f-486f-aadc-bb8b9e8fb7df" class="outline-4">
<h4 id="h:4196f992-ed9f-486f-aadc-bb8b9e8fb7df">template</h4>
<div class="outline-text-4" id="text-h:4196f992-ed9f-486f-aadc-bb8b9e8fb7df">
<p>
templateåŠŸèƒ½ï¼šå¯ä»¥æ ¹æ®å’Œå‚è€ƒæ¨¡å—æ–‡ä»¶ï¼ŒåŠ¨æ€ç”Ÿæˆç›¸ç±»ä¼¼çš„é…ç½®æ–‡ä»¶
</p>

<p>
templateæ–‡ä»¶å¿…é¡»å­˜æ”¾äºtemplatesç›®å½•ä¸‹ï¼Œä¸”å‘½åä¸º .j2 ç»“å°¾
</p>

<p>
yaml/yml æ–‡ä»¶éœ€å’Œtemplatesç›®å½•å¹³çº§ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ç¤ºä¾‹ï¼š
</p>
<pre class="example" id="org4aa65e2">
./\\
â”œâ”€â”€ temnginx.yml\\
â””â”€â”€ templates\\
â””â”€â”€ nginx.conf.j2
</pre>

<p>
èŒƒä¾‹ï¼šåˆ©ç”¨template åŒæ­¥nginxé…ç½®æ–‡ä»¶
</p>

<div class="org-src-container">
<pre class="src src-yaml">#å‡†å¤‡templates/nginx.conf.j2æ–‡ä»¶
vim temnginx.yml
---
- hosts: websrvs
  remote_user: root

  tasks:
    - name: template config to remote hosts
      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf

ansible-playbook temnginx.yml
</pre>
</div>

<p>
<b>templateå˜æ›´æ›¿æ¢</b>
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">#ä¿®æ”¹æ–‡ä»¶nginx.conf.j2
mkdir templates
vim templates/nginx.conf.j2
worker_processes {{ ansible_processor_vcpus }};   #cpué¢—æ•°

vim temnginx2.yml
---
- hosts: websrvs
  remote_user: root

  tasks:
    - name: install nginx
      yum: name=nginx
    - name: template config to remote hosts
      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf  #è¿™ä¸€æ­¥å¹¶ä¸ä¼šåŸè£…å¤åˆ¶,è€Œæ˜¯æŠŠç›®æ ‡æ–‡ä»¶è°ƒæ•´ä¿®æ”¹ä¹‹åç”Ÿæˆæ–°çš„confæ–‡ä»¶
    - name: start service
      service: name=nginx state=started enabled=yes

ansible-playbook temnginx2.yml

#æ‰©å±•:cpué¢—æ•°æŸ¥çœ‹
[root@ansible ansible]#ansible websrvs -m setup -a 'filter=ansible_processor_vcpus'
10.0.0.7 | SUCCESS =&gt; {
    "ansible_facts": {
        "ansible_processor_vcpus": 2,
        "discovered_interpreter_python": "/usr/bin/python"
    },
    "changed": false
}
10.0.0.8 | SUCCESS =&gt; {
    "ansible_facts": {
        "ansible_processor_vcpus": 1,
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": false
}
</pre>
</div>

<p>
<b>templateç®—æœ¯è¿ç®—</b>
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">vim nginx.conf.j2
worker_processes {{ ansible_processor_vcpus**2 }};    <span style="color: #b22222;">#</span><span style="color: #b22222;">2&#27425;&#26041;</span>
worker_processes {{ ansible_processor_vcpus+2 }}; 
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">[root@ansible ansible]#vim templates/nginx.conf.j2
worker_processes {{ ansible_processor_vcpus**3 }};

[root@ansible ansible]#cat templnginx.yml
---
- hosts: websrvs
  remote_user: root

  tasks:
    - name: install nginx
      yum: name=nginx
    - name: template config to remote hosts
      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf
      notify: restart nginx
    - name: start service
      service: name=nginx state=started enabled=yes

  handlers:
    - name: restart nginx
      service: name=nginx state=restarted


ansible-playbook templnginx.yml --limit 10.0.0.8
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c117f799-8788-4b89-aeee-31c20ad9be93" class="outline-4">
<h4 id="h:c117f799-8788-4b89-aeee-31c20ad9be93">templateä¸­ä½¿ç”¨æµç¨‹æ§åˆ¶ for å’Œ if</h4>
<div class="outline-text-4" id="text-h:c117f799-8788-4b89-aeee-31c20ad9be93">
<p>
templateä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨æµç¨‹æ§åˆ¶ for å¾ªç¯å’Œ if
æ¡ä»¶åˆ¤æ–­ï¼Œå®ç°åŠ¨æ€ç”Ÿæˆæ–‡ä»¶åŠŸèƒ½
</p>

<p>
èŒƒä¾‹
</p>

<div class="org-src-container">
<pre class="src src-yaml">#temlnginx2.yml
---
- hosts: websrvs
  remote_user: root
  vars:
    nginx_vhosts:       #å®šä¹‰ä¸€ä¸ªå˜é‡:ç”±ä¸‰ä¸ªå…ƒç´ ç»„æˆçš„ä¸€ä¸ªåˆ—è¡¨
      - 81
      - 82
      - 83
  tasks:
    - name: template config
      template: src=nginx.conf.j2 dest=/data/nginx.conf

#templates/nginx2.conf.j2
{% for vhost in nginx_vhosts %}     #vhostä¼šè‡ªåŠ¨å–81,82,83
server {
   listen {{ vhost }}
}
{% endfor %}

ansible-playbook -C templnginx2.yml --limit 10.0.0.8

#ç”Ÿæˆçš„ç»“æœï¼š
server {
   listen 81  
}
server {
   listen 82  
}
server {
   listen 83  
}
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">#temlnginx3.yml
---
- hosts: websrvs
  remote_user: root
  vars:
    nginx_vhosts:
      - listen: 8080
  tasks:
    - name: config file
      template: src=nginx3.conf.j2 dest=/data/nginx3.conf

#templates/nginx3.conf.j2
{% for vhost in nginx_vhosts %}  
server {
  listen {{ vhost.listen }}
}
{% endfor %}

ansible-playbook   templnginx3.yml  --limit 10.0.0.8

#ç”Ÿæˆçš„ç»“æœ
server {
  listen 8080
}
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">#templnginx4.yml
- hosts: websrvs
  remote_user: root
  vars:
    nginx_vhosts:
      - listen: 8080
        server_name: "web1.cici.com"
        root: "/var/www/nginx/web1/"
      - listen: 8081
        server_name: "web2.cici.com"
        root: "/var/www/nginx/web2/"
      - {listen: 8082, server_name: "web3.cici.com", root: "/var/www/nginx/web3/"}
  tasks:
    - name: template config
      template: src=nginx4.conf.j2 dest=/data/nginx4.conf


# templates/nginx.conf4.j2
{% for vhost in nginx_vhosts %}
server {
   listen {{ vhost.listen }}
   server_name {{ vhost.server_name }}
   root {{ vhost.root }}  
}
{% endfor %}

ansible-playbook templnginx4.yml --limit 10.0.0.8

#ç”Ÿæˆç»“æœï¼š
server {
    listen 8080
    server_name web1.cici.com
    root /var/www/nginx/web1/  
}
server {
    listen 8081
    server_name web2.cici.com
    root /var/www/nginx/web2/  
}
server {
    listen 8082
    server_name web3.cici.com
    root /var/www/nginx/web3/  
}
</pre>
</div>

<p>
åœ¨æ¨¡ç‰ˆæ–‡ä»¶ä¸­è¿˜å¯ä»¥ä½¿ç”¨ ifæ¡ä»¶åˆ¤æ–­ï¼Œå†³å®šæ˜¯å¦ç”Ÿæˆç›¸å…³çš„é…ç½®ä¿¡æ¯
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">templnginx5.yml</span>
- hosts: websrvs
  remote_user: root
  vars:
    nginx_vhosts:
      - web1:
        listen: 8080
        root: <span style="color: #8b2252;">"/var/www/nginx/web1/"</span>
      - web2:
        listen: 8080
        server_name: <span style="color: #8b2252;">"web2.cici.com"</span>
        root: <span style="color: #8b2252;">"/var/www/nginx/web2/"</span>
      - web3:
        listen: 8080
        server_name: <span style="color: #8b2252;">"web3.cici.com"</span>
        root: <span style="color: #8b2252;">"/var/www/nginx/web3/"</span>
  tasks:
    - name: template config to
      template: <span style="color: #a0522d;">src</span>=nginx.conf5.j2 <span style="color: #a0522d;">dest</span>=/data/nginx5.conf
---
</pre>
</div>

<div class="org-src-container">
<pre class="src src-jinja2">#templates/nginx.conf5.j2
#å¦‚æœvhost.server_nameå®šä¹‰è¿‡äº†,å°±ç”Ÿæˆserver_nameçš„å€¼,æ²¡å®šä¹‰å°±ä¸ç”Ÿæˆ;å³æ ¹æ®å˜é‡å­˜åœ¨ä¸å¦,æ¥å†³å®šæ˜¯å¦ç”Ÿæˆserver_name

{% for vhost in nginx_vhosts %}
    server {
        listen {{ vhost.listen }}
            server_name {{ vhost.server_name }} #å¦‚æœå®šä¹‰äº†vhost.server_name
        root  {{ vhost.root }}
    }
{% endfor %}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#30340;&#32467;&#26524;</span>
server {
   listen 8080
   root /var/www/nginx/web1/
}
server {
   listen 8080
   server_name web2.cici.com
   root /var/www/nginx/web2/
}
server {
   listen 8080
   server_name web3.cici.com
   root /var/www/nginx/web3/
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:a285cd08-19dd-4858-bf83-6c8ff2d72fd0" class="outline-3">
<h3 id="h:a285cd08-19dd-4858-bf83-6c8ff2d72fd0">playbookä½¿ç”¨ when</h3>
<div class="outline-text-3" id="text-h:a285cd08-19dd-4858-bf83-6c8ff2d72fd0">
<p>
whenè¯­å¥ï¼Œå¯ä»¥å®ç°æ¡ä»¶æµ‹è¯•ã€‚å¦‚æœéœ€è¦æ ¹æ®å˜é‡ã€factsæˆ–æ­¤å‰ä»»åŠ¡çš„æ‰§è¡Œç»“æœæ¥åšä¸ºæŸtaskæ‰§è¡Œä¸å¦çš„å‰ææ—¶è¦ç”¨åˆ°æ¡ä»¶æµ‹è¯•,é€šè¿‡åœ¨taskåæ·»åŠ whenå­å¥å³å¯ä½¿ç”¨æ¡ä»¶æµ‹è¯•ï¼Œjinja2çš„è¯­æ³•æ ¼å¼
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: "shutdown RedHat flavored systems"
      command: /sbin/shutdown -h now
      when: ansible_os_family == "RedHat"
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: add group nginx
      tags: user
      user: name=nginx state=present
    - name: add user nginx
      user: name=nginx state=present group=nginx
    - name: Install Nginx
      yum: name=nginx state=present
    - name: restart Nginx
      service: name=nginx state=restarted
      when: ansible_distribution_major_version == "6"
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: install conf file to centos7
      template: src=nginx.conf.c7.j2 dest=/etc/nginx/nginx.conf
      when: ansible_distribution_major_version == "7"
    - name: install conf file to centos6
      template: src=nginx.conf.c6.j2 dest=/etc/nginx/nginx.conf
      when: ansible_distribution_major_version == "6"
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bd942071-2cea-48f6-a0cc-045587b70281" class="outline-3">
<h3 id="h:bd942071-2cea-48f6-a0cc-045587b70281">playbook ä½¿ç”¨è¿­ä»£ with_items</h3>
<div class="outline-text-3" id="text-h:bd942071-2cea-48f6-a0cc-045587b70281">
<p>
è¿­ä»£ï¼šå½“æœ‰éœ€è¦é‡å¤æ€§æ‰§è¡Œçš„ä»»åŠ¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿­ä»£æœºåˆ¶
</p>

<p>
å¯¹è¿­ä»£é¡¹çš„å¼•ç”¨ï¼Œå›ºå®šå˜é‡åä¸ºâ€itemâ€
</p>

<p>
è¦åœ¨taskä¸­ä½¿ç”¨with_itemsç»™å®šè¦è¿­ä»£çš„å…ƒç´ åˆ—è¡¨
</p>

<p>
æ³¨æ„: ansible2.5ç‰ˆæœ¬å,å¯ä»¥ç”¨loopä»£æ›¿with_items
</p>

<p>
<b>åˆ—è¡¨å…ƒç´ æ ¼å¼</b> ï¼š
</p>

<ul class="org-ul">
<li>å­—ç¬¦ä¸²</li>
<li>å­—å…¸</li>
</ul>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: add several users
      user: name={{ item }} state=present groups=wheel
      with_items:   #ä¸‹é¢çš„åˆ—è¡¨ä¼šè‡ªåŠ¨åµŒå…¥åˆ°ä¸Šé¢çš„item
        - testuser1
        - testuser2
        - testuser3

#ä¸Šé¢è¯­å¥çš„åŠŸèƒ½ç­‰åŒäºä¸‹é¢çš„è¯­å¥
    - name: add several users
      user: name=testuser1 state=present groups=wheel
    - name: add several users
      user: name=testuser2 state=present groups=wheel
    - name: add several users
      user: name=testuser3 state=present groups=wheel

#æ‰§è¡Œç»“æœ
[root@centos8 ~]#getent passwd
testuser1:x:1001:1001::/home/testuser1:/bin/bash
testuser2:x:1002:1002::/home/testuser2:/bin/bash
testuser3:x:1003:1003::/home/testuser3:/bin/bash
</pre>
</div>

<p>
èŒƒä¾‹ï¼šå¸è½½ mariadb
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
#remove mariadb server
- hosts: appsrvs:!10.0.0.8
  remote_user: root
  tasks:
    - name: stop service
      shell: /etc/init.d/mysqld stop
    - name: delete files and dir
      file: path={{item}} state=absent
      with_items:
        - /usr/local/mysql
        - /usr/local/mariadb-10.2.27-linux-x86_64
        - /etc/init.d/mysqld
        - /etc/profile.d/mysql.sh
        - /etc/my.cnf
        - /data/mysql
    - name: delete user
      user: name=mysql state=absent remove=yes
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hostsï¼šwebsrvs
  remote_user: root

  tasks
    - name: install some packages
      yum: name={{ item }} state=present
      with_items:
        - nginx
        - memcached
        - php-fpm 
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: copy file
      copy: src={{ item }} dest=/tmp/{{ item }}
      with_items:
        - file1
        - file2
        - file3
    - name: yum install httpd
      yum: name={{ item }}  state=present
      with_items:
        - apr
        - apr-util
        - httpd
</pre>
</div>

<p>
<b>è¿­ä»£åµŒå¥—å­å˜é‡</b> ï¼šåœ¨è¿­ä»£ä¸­ï¼Œè¿˜å¯ä»¥åµŒå¥—å­å˜é‡ï¼Œå…³è”å¤šä¸ªå˜é‡åœ¨ä¸€èµ·ä½¿ç”¨
</p>

<p>
ç¤ºä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root

  tasks:
    - name: add some groups
      group: name={{ item }} state=present
      with_items:
        - nginx
        - mysql
        - apache
    - name: add some users
      user: name={{ item.name }} group={{ item.group }} state=present
      with_items:
        - { name: 'nginx', group: 'nginx' }
        - { name: 'mysql', group: 'mysql' }
        - { name: 'apache', group: 'apache' }
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">cat with_item2.yml
---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: add some groups
      group: name={{ item }} state=present
      with_items:
        - g1
        - g2
        - g3
    - name: add some users
      user: name={{ item.name }} group={{ item.group }} home={{ item.home }}
create_home=yes state=present
      with_items:
        - { name: 'user1', group: 'g1', home: '/data/user1' }
        - { name: 'user2', group: 'g2', home: '/data/user2' }
        - { name: 'user3', group: 'g3', home: '/data/user3' }

#æœ€ç»ˆç»“æœå¦‚ä¸‹:
[root@centos8 ~]#getent passwd user1
user1:x:1001:1001::/data/user1:/bin/bash
[root@centos8 ~]#id user1
uid=1001(user1) gid=1001(g1) groups=1001(g1)
[root@centos8 ~]#ll /data/
total 12
-rw-r--r-- 1 root  root 264 Jun 21 10:49 nginx4.conf
-rw-r--r-- 1 root  root 238 Jun 21 11:25 nginx5.conf
-rw-r--r-- 1 root  root  72 Jun 21 10:44 nginx.conf
drwx------ 2 user1 g1    62 Jun 21 11:53 user1
drwx------ 2 user2 g2    62 Jun 21 11:53 user2
drwx------ 2 user3 g3    62 Jun 21 11:54 user3
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b3da52c8-a8c8-44d5-88af-a63654cb9ddc" class="outline-3">
<h3 id="h:b3da52c8-a8c8-44d5-88af-a63654cb9ddc">ç®¡ç†èŠ‚ç‚¹è¿‡å¤šå¯¼è‡´çš„è¶…æ—¶é—®é¢˜è§£å†³æ–¹æ³•</h3>
<div class="outline-text-3" id="text-h:b3da52c8-a8c8-44d5-88af-a63654cb9ddc">
<p>
é»˜è®¤æƒ…å†µä¸‹ï¼ŒAnsibleå°†å°è¯•å¹¶è¡Œç®¡ç†playbookä¸­æ‰€æœ‰çš„æœºå™¨ã€‚å¯¹äºæ»šåŠ¨æ›´æ–°ç”¨ä¾‹ï¼Œå¯ä»¥ä½¿ç”¨serialå…³é”®å­—å®šä¹‰Ansibleä¸€æ¬¡åº”ç®¡ç†å¤šå°‘ä¸»æœºï¼Œè¿˜å¯ä»¥å°†serialå…³é”®å­—æŒ‡å®šä¸ºç™¾åˆ†æ¯”ï¼Œè¡¨ç¤ºæ¯æ¬¡å¹¶è¡Œæ‰§è¡Œçš„ä¸»æœºæ•°å æ€»æ•°çš„æ¯”ä¾‹
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">#vim test_serial.yml
---
- hosts: all
  serial: 2 #æ¯æ¬¡åªåŒæ—¶å¤„ç†2ä¸ªä¸»æœº
  gather_facts: False

  tasks:
    - name: task one
      comand: hostname
    - name: task two
      command: hostname
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">- name: test serail
  hosts: all
  serial: "20%"   #æ¯æ¬¡åªåŒæ—¶å¤„ç†20%çš„ä¸»æœº
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:954e685a-1aef-4f59-a35b-8c16371ed21a" class="outline-2">
<h2 id="h:954e685a-1aef-4f59-a35b-8c16371ed21a">rolesè§’è‰²</h2>
<div class="outline-text-2" id="text-h:954e685a-1aef-4f59-a35b-8c16371ed21a">
<p>
è§’è‰²æ˜¯ansibleè‡ª1.2ç‰ˆæœ¬å¼•å…¥çš„æ–°ç‰¹æ€§ï¼Œç”¨äºå±‚æ¬¡æ€§ã€ç»“æ„åŒ–åœ°ç»„ç»‡playbookã€‚rolesèƒ½å¤Ÿæ ¹æ®å±‚æ¬¡å‹ç»“æ„è‡ªåŠ¨è£…è½½å˜é‡æ–‡ä»¶ã€tasksä»¥åŠhandlersç­‰ã€‚è¦ä½¿ç”¨rolesåªéœ€è¦åœ¨playbookä¸­ä½¿ç”¨includeæŒ‡ä»¤å³å¯ã€‚ç®€å•æ¥è®²ï¼Œroleså°±æ˜¯é€šè¿‡åˆ†åˆ«å°†å˜é‡ã€æ–‡ä»¶ã€ä»»åŠ¡ã€æ¨¡æ¿åŠå¤„ç†å™¨æ”¾ç½®äºå•ç‹¬çš„ç›®å½•ä¸­ï¼Œå¹¶å¯ä»¥ä¾¿æ·åœ°includeå®ƒä»¬çš„ä¸€ç§æœºåˆ¶ã€‚è§’è‰²ä¸€èˆ¬ç”¨äºåŸºäºä¸»æœºæ„å»ºæœåŠ¡çš„åœºæ™¯ä¸­ï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯ç”¨äºæ„å»ºå®ˆæŠ¤è¿›ç¨‹ç­‰åœºæ™¯ä¸­
</p>

<p>
è¿ç»´å¤æ‚çš„åœºæ™¯ï¼šå»ºè®®ä½¿ç”¨ rolesï¼Œä»£ç å¤ç”¨åº¦é«˜
</p>

<p>
rolesï¼šå¤šä¸ªè§’è‰²çš„é›†åˆï¼Œ
å¯ä»¥å°†å¤šä¸ªçš„roleï¼Œåˆ†åˆ«æ”¾è‡³rolesç›®å½•ä¸‹çš„ç‹¬ç«‹å­ç›®å½•ä¸­
</p>

<div class="org-src-container">
<pre class="src src-yaml">roles/
  mysql/
  nginx/
  tomcat/
  redis/
</pre>
</div>
</div>
<div id="outline-container-h:ad6a8b23-f7a6-43d9-8bc1-ad71d94ebfdc" class="outline-3">
<h3 id="h:ad6a8b23-f7a6-43d9-8bc1-ad71d94ebfdc">Ansible Rolesç›®å½•ç¼–æ’</h3>
<div class="outline-text-3" id="text-h:ad6a8b23-f7a6-43d9-8bc1-ad71d94ebfdc">
<p>
æ¯ä¸ªè§’è‰²ï¼Œä»¥ç‰¹å®šçš„å±‚çº§ç›®å½•ç»“æ„è¿›è¡Œç»„ç»‡
</p>

<p>
è§’è‰²å†™å¥½ä¹‹åå°±å›ºå®šäº†,æƒ³è¦è°ƒç”¨å“ªäº›è§’è‰²å°±å¦å¤–å†™yamlæ–‡ä»¶,å…¶å®ä¹Ÿå°±æ˜¯åŸæ¥å†™çš„yamlæ–‡ä»¶æ‹†å¼€æ”¾åˆ°ä¸åŒæ–‡ä»¶å¤¹é‡Œ,å®ç°æ¨¡å—åŒ–
</p>

<p>
<b>rolesç›®å½•ç»“æ„</b> ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">playbook.yml
roles/
 project/
   tasks/
   files/
   vars/      
   templates/
   handlers/
   default/    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#21464;&#37327;</span>
   meta/       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20803;&#25968;&#25454;</span>
</pre>
</div>

<p>
<b>Roleså„ç›®å½•ä½œç”¨</b>
</p>

<p>
roles/project/ :é¡¹ç›®åç§°,æœ‰ä»¥ä¸‹å­ç›®å½•
</p>

<ul class="org-ul">
<li>files/ ï¼šå­˜æ”¾ç”±copyæˆ–scriptæ¨¡å—ç­‰è°ƒç”¨çš„æ–‡ä»¶</li>
<li>templates/ï¼štemplateæ¨¡å—æŸ¥æ‰¾æ‰€éœ€è¦æ¨¡æ¿æ–‡ä»¶çš„ç›®å½•</li>
<li>tasks/ï¼šå®šä¹‰task,roleçš„åŸºæœ¬å…ƒç´ ï¼Œè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼›
å…¶å®ƒçš„æ–‡ä»¶éœ€è¦åœ¨æ­¤æ–‡ä»¶ä¸­é€šè¿‡includeè¿›è¡ŒåŒ…å«</li>
<li>handlers/ï¼šè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼›å…¶å®ƒçš„æ–‡ä»¶éœ€è¦åœ¨æ­¤æ–‡ä»¶ä¸­é€šè¿‡includeè¿›è¡ŒåŒ…å«</li>
<li>vars/ï¼šå®šä¹‰å˜é‡ï¼Œè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼›å…¶å®ƒçš„æ–‡ä»¶éœ€è¦åœ¨æ­¤æ–‡ä»¶ä¸­é€šè¿‡includeè¿›è¡ŒåŒ…å«</li>
<li>meta/ï¼šå®šä¹‰å½“å‰è§’è‰²çš„ç‰¹æ®Šè®¾å®šåŠå…¶ä¾èµ–å…³ç³»,è‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸º
main.ymlçš„æ–‡ä»¶ï¼Œå…¶å®ƒæ–‡ä»¶éœ€åœ¨æ­¤æ–‡ä»¶ä¸­é€šè¿‡includeè¿›è¡ŒåŒ…å«</li>
<li>default/ï¼šè®¾å®šé»˜è®¤å˜é‡æ—¶ä½¿ç”¨æ­¤ç›®å½•ä¸­çš„main.ymlæ–‡ä»¶ï¼Œæ¯”varsçš„ä¼˜å…ˆçº§ä½</li>
</ul>
</div>
</div>
<div id="outline-container-h:5d533a95-d2ab-402d-883b-4a41fd54628c" class="outline-3">
<h3 id="h:5d533a95-d2ab-402d-883b-4a41fd54628c">åˆ›å»º role</h3>
<div class="outline-text-3" id="text-h:5d533a95-d2ab-402d-883b-4a41fd54628c">
<p>
åˆ›å»ºroleçš„æ­¥éª¤
</p>

<div class="org-src-container">
<pre class="src src-sh">1 &#21019;&#24314;&#20197;roles&#21629;&#21517;&#30340;&#30446;&#24405;
2 &#22312;roles&#30446;&#24405;&#20013;&#20998;&#21035;&#21019;&#24314;&#20197;&#21508;&#35282;&#33394;&#21517;&#31216;&#21629;&#21517;&#30340;&#30446;&#24405;&#65292;&#22914;webservers&#31561;
3 &#22312;&#27599;&#20010;&#35282;&#33394;&#21629;&#21517;&#30340;&#30446;&#24405;&#20013;&#20998;&#21035;&#21019;&#24314;files&#12289;handlers&#12289;meta&#12289;tasks&#12289;templates&#21644;vars&#30446;&#24405;&#65307;&#29992;&#19981;&#21040;
&#30340;&#30446;&#24405;&#21487;&#20197;&#21019;&#24314;&#20026;&#31354;&#30446;&#24405;&#65292;&#20063;&#21487;&#20197;&#19981;&#21019;&#24314;
4 &#22312;playbook&#25991;&#20214;&#20013;&#65292;&#35843;&#29992;&#21508;&#35282;&#33394;
</pre>
</div>

<p>
é’ˆå¯¹å¤§å‹é¡¹ç›®ä½¿ç”¨Rolesè¿›è¡Œç¼–æ’
</p>

<p>
èŒƒä¾‹ï¼šrolesçš„ç›®å½•ç»“æ„
</p>

<div class="org-src-container">
<pre class="src src-sh">nginx-role.yml
roles/
&#9492;&#9472;&#9472; nginx
     &#9500;&#9472;&#9472; files
     &#9474;   &#9492;&#9472;&#9472; main.yml
     &#9500;&#9472;&#9472; tasks
     &#9474;   &#9500;&#9472;&#9472; groupadd.yml
     &#9474;   &#9500;&#9472;&#9472; install.yml
     &#9474;   &#9500;&#9472;&#9472; main.yml
     &#9474;   &#9500;&#9472;&#9472; restart.yml
     &#9474;   &#9492;&#9472;&#9472; useradd.yml
     &#9492;&#9472;&#9472; vars
         &#9492;&#9472;&#9472; main.yml 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b64d06e1-b9b6-4996-b702-7159938bda55" class="outline-3">
<h3 id="h:b64d06e1-b9b6-4996-b702-7159938bda55">playbookè°ƒç”¨è§’è‰²</h3>
<div class="outline-text-3" id="text-h:b64d06e1-b9b6-4996-b702-7159938bda55">
<p>
*è°ƒç”¨è§’è‰²æ–¹æ³•1*ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root
  roles:
    - mysql
    - memcached
    - nginx  
</pre>
</div>

<p>
<b>è°ƒç”¨è§’è‰²æ–¹æ³•2</b> ï¼š
</p>

<p>
é”®roleç”¨äºæŒ‡å®šè§’è‰²åç§°ï¼Œåç»­çš„k/vç”¨äºä¼ é€’å˜é‡ç»™è§’è‰²
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: all
  remote_user: root
  roles:
    - mysql
    - { role: nginx, username: nginx }
</pre>
</div>

<p>
<b>è°ƒç”¨è§’è‰²æ–¹æ³•3</b> ï¼š
</p>

<p>
è¿˜å¯åŸºäºæ¡ä»¶æµ‹è¯•å®ç°è§’è‰²è°ƒç”¨
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: all
  remote_user: root
  roles:
    - { role: nginx, username: nginx, when: ansible_distribution_major_version
== '7' }

#åªæœ‰7ç‰ˆæœ¬æ—¶æ‰è°ƒç”¨
</pre>
</div>
</div>
</div>
<div id="outline-container-h:62cd23ee-27ee-4a02-885b-0a0fdf45502c" class="outline-3">
<h3 id="h:62cd23ee-27ee-4a02-885b-0a0fdf45502c">roles ä¸­ tags ä½¿ç”¨</h3>
<div class="outline-text-3" id="text-h:62cd23ee-27ee-4a02-885b-0a0fdf45502c">
<div class="org-src-container">
<pre class="src src-yaml">#nginx-role.yml, è´´æ ‡ç­¾åæŒ‘æ ‡ç­¾æ¥æ‰§è¡Œ
---
- hosts: websrvs
  remote_user: root
  roles:
    - { role: nginx ,tags: [ 'nginx', 'web' ] ,when: ansible_distribution_major_version == "6" }
    - { role: httpd ,tags: [ 'httpd', 'web' ] }
    - { role: mysql ,tags: [ 'mysql', 'db' ] }
    - { role: mariadb ,tags: [ 'mariadb', 'db' ] } ansible-playbook --tags="nginx,httpd,mysql" nginx-role.yml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:63ae80ce-faf4-4826-a393-f616f80e000c" class="outline-3">
<h3 id="h:63ae80ce-faf4-4826-a393-f616f80e000c">å®æˆ˜æ¡ˆä¾‹</h3>
<div class="outline-text-3" id="text-h:63ae80ce-faf4-4826-a393-f616f80e000c">
</div>
<div id="outline-container-h:6df15f85-1668-4a13-adb7-422464c2fc84" class="outline-4">
<h4 id="h:6df15f85-1668-4a13-adb7-422464c2fc84">æ¡ˆä¾‹1ï¼šå®ç° httpd è§’è‰²</h4>
<div class="outline-text-4" id="text-h:6df15f85-1668-4a13-adb7-422464c2fc84">
<div class="org-src-container">
<pre class="src src-yaml">#åˆ›å»ºè§’è‰²ç›¸å…³çš„ç›®å½•,é»˜è®¤åœ¨/etc/ansible/roles
mkdir -pv /data/ansible/roles/httpd/{tasks,handlers,files}

#åˆ›å»ºè§’è‰²ç›¸å…³çš„æ–‡ä»¶
cd /data/ansible/roles/httpd/

#main.yml æ˜¯taskçš„å…¥å£æ–‡ä»¶
vim tasks/main.yml
- include: group.yml
- include: user.yml
- include: install.yml
- include: config.yml
- include: index.yml
- include: service.yml

vim tasks/group.yml
- name: create apache group
  group: name=apache system=yes gid=80

vim tasks/user.yml
- name: create apache user
  user: name=apache system=yes shell=/sbin/nologin home=/var/www/ uid=80 group=apache

vim tasks/install.yml
- name: install httpd package
  yum: name=httpd

vim tasks/config.yml
- name: config file
  copy: src=httpd.conf dest=/etc/httpd/conf/ backup=yes
  notify: restart

vim tasks/index.yml
- name: index.html
  copy: src=index.html dest=/var/www/html/

vim tasks/service.yml
- name: start service
  service: name=httpd state=started enabled=yes

vim handlers/main.yml
- name: restart
  service: name=httpd state=restarted

#åœ¨filesç›®å½•ä¸‹å‡†å¤‡ä¸¤ä¸ªæ–‡ä»¶
ls files/
httpd.conf index.html

tree /data/ansible/roles/httpd/
/data/ansible/roles/httpd/
â”œâ”€â”€ files
â”‚   â”œâ”€â”€ httpd.conf
â”‚   â””â”€â”€ index.html
â”œâ”€â”€ handlers
â”‚   â””â”€â”€ main.yml
â””â”€â”€ tasks
   â”œâ”€â”€ config.yml
   â”œâ”€â”€ group.yml
   â”œâ”€â”€ index.yml
   â”œâ”€â”€ install.yml
   â”œâ”€â”€ main.yml
   â”œâ”€â”€ service.yml
   â””â”€â”€ user.yml
3 directories, 10 files

#åœ¨playbookä¸­è°ƒç”¨è§’è‰²
vim /data/ansible/role_httpd.yml
---
# httpd role
- hosts: websrvs
  remote_user: root

  roles:
    - httpd

#è¿è¡Œplaybook
ansible-playbook /data/ansible/role_httpd.yml
mkdir -pv /data/ansible
</pre>
</div>
</div>
</div>
<div id="outline-container-h:18580821-55a3-41e7-a91a-4b500d8689aa" class="outline-4">
<h4 id="h:18580821-55a3-41e7-a91a-4b500d8689aa">æ¡ˆä¾‹2ï¼šå®ç° nginx è§’è‰²</h4>
<div class="outline-text-4" id="text-h:18580821-55a3-41e7-a91a-4b500d8689aa">
<div class="org-src-container">
<pre class="src src-sh">mkdir -pv /data/ansible/roles/nginx/{tasks,handlers,templates,vars}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;task&#25991;&#20214;</span>
<span style="color: #483d8b;">cd</span> /data/ansible/roles/nginx/

vim tasks/main.yml
- include: install.yml
- include: config.yml
- include: index.yml
- include: service.yml

vim tasks/install.yml
- name: install
  yum: <span style="color: #a0522d;">name</span>=nginx

vim tasks/config.yml
- name: config file for centos7
  template: <span style="color: #a0522d;">src</span>=nginx7.conf.j2 <span style="color: #a0522d;">dest</span>=/etc/nginx/nginx.conf
  when: <span style="color: #a0522d;">ansible_distribution_major_version</span>==<span style="color: #8b2252;">"7"</span>
  notify: restart

- name: config file for centos8
  template: <span style="color: #a0522d;">src</span>=nginx8.conf.j2 <span style="color: #a0522d;">dest</span>=/etc/nginx/nginx.conf
  when: <span style="color: #a0522d;">ansible_distribution_major_version</span>==<span style="color: #8b2252;">"8"</span>
  notify: restart

vim tasks/index.yml
- name: index.html
  copy: <span style="color: #a0522d;">src</span>=roles/httpd/files/index.html <span style="color: #a0522d;">dest</span>=/usr/share/nginx/html/

vim tasks/service.yml
- name: start service
  service: <span style="color: #a0522d;">name</span>=nginx <span style="color: #a0522d;">state</span>=started <span style="color: #a0522d;">enabled</span>=yes

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;handler&#25991;&#20214;</span>
cat handlers/main.yml
- name: restart
  service: <span style="color: #a0522d;">name</span>=nginx <span style="color: #a0522d;">state</span>=restarted

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#20004;&#20010;template&#25991;&#20214;</span>
cat templates/nginx7.conf.j2
...&#30465;&#30053;...
user {{user}};
worker_processes {{ansible_processor_vcpus+3}};   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#27492;&#34892;</span>
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;
...&#30465;&#30053;...

cat templates/nginx8.conf.j2
...&#30465;&#30053;...
user nginx;
worker_processes {{ansible_processor_vcpus**3}};  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#27492;&#34892;</span>
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;
...&#30465;&#30053;...

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#21464;&#37327;&#25991;&#20214;</span>
vim vars/main.yml
user: daemon

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#24405;&#32467;&#26500;&#22914;&#19979;</span>
tree /data/ansible/roles/nginx/
/data/ansible/roles/nginx/
&#9500;&#9472;&#9472; handlers
&#9474;   &#9492;&#9472;&#9472; main.yml
&#9500;&#9472;&#9472; tasks
&#9474;   &#9500;&#9472;&#9472; config.yml
&#9474;   &#9500;&#9472;&#9472; file.yml
&#9474;   &#9500;&#9472;&#9472; install.yml
&#9474;   &#9500;&#9472;&#9472; main.yml
&#9474;   &#9492;&#9472;&#9472; service.yml
&#9500;&#9472;&#9472; templates
&#9474;   &#9500;&#9472;&#9472; nginx7.conf.j2
&#9474;   &#9492;&#9472;&#9472; nginx8.conf.j2
&#9492;&#9472;&#9472; vars
   &#9492;&#9472;&#9472; main.yml
4 directories, 9 files

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;playbook&#20013;&#35843;&#29992;&#35282;&#33394;</span>
vim /data/ansible/role_nginx.yml
---
<span style="color: #b22222;">#</span><span style="color: #b22222;">nginx role</span>
- hosts: websrvs

  roles:
    - role: nginx

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36816;&#34892;playbook</span>
ansible-playbook /data/ansible/role_nginx.yml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:256f9ea7-7b71-4850-9120-a309c8cee771" class="outline-4">
<h4 id="h:256f9ea7-7b71-4850-9120-a309c8cee771">æ¡ˆä¾‹3ï¼šå®ç° memcached è§’è‰²</h4>
<div class="outline-text-4" id="text-h:256f9ea7-7b71-4850-9120-a309c8cee771">
<div class="org-src-container">
<pre class="src src-sh">mkdir -pv /data/ansible/roles/memcached/{tasks,templates}

<span style="color: #483d8b;">cd</span> /data/ansible/roles/memcached
vim tasks/main.yml
- include: install.yml
- include: config.yml
- include: service.yml

vim tasks/install.yml
- name: install
  yum: <span style="color: #a0522d;">name</span>=memcached

vim tasks/config.yml
- name: config file
  template: <span style="color: #a0522d;">src</span>=memcached.j2  <span style="color: #a0522d;">dest</span>=/etc/sysconfig/memcached
  vim tasks/service.yml
- name: service
  service: <span style="color: #a0522d;">name</span>=memcached <span style="color: #a0522d;">state</span>=started <span style="color: #a0522d;">enabled</span>=yes

<span style="color: #b22222;">#</span><span style="color: #b22222;">//&#25972;&#38500;</span>
vim templates/memcached.j2
<span style="color: #a0522d;">PORT</span>=<span style="color: #8b2252;">"11211"</span>
<span style="color: #a0522d;">USER</span>=<span style="color: #8b2252;">"memcached"</span>
<span style="color: #a0522d;">MAXCONN</span>=<span style="color: #8b2252;">"1024"</span>
<span style="color: #a0522d;">CACHESIZE</span>=<span style="color: #8b2252;">"{{ansible_memtotal_mb//4}}"</span>   
<span style="color: #a0522d;">OPTIONS</span>=<span style="color: #8b2252;">""</span>

tree /data/ansible/roles/memcached/
/data/ansible/roles/memcached/
&#9500;&#9472;&#9472; tasks
&#9474;   &#9500;&#9472;&#9472; config.yml
&#9474;   &#9500;&#9472;&#9472; install.yml
&#9474;   &#9500;&#9472;&#9472; main.yml
&#9474;   &#9492;&#9472;&#9472; service.yml
&#9492;&#9472;&#9472; templates
   &#9492;&#9472;&#9472; memcached.j2

2 directories, 5 files

vim /data/ansible/role_memcached.yml
---
- hosts: appsrvs

  roles:
    - role: memcached

ansible-play /data/ansible/role_memcached.yml 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b9909bd1-8062-46ae-9fe0-728611cc27f6" class="outline-4">
<h4 id="h:b9909bd1-8062-46ae-9fe0-728611cc27f6">æ¡ˆä¾‹4ï¼šå®ç° mysql 5.6 çš„è§’è‰²</h4>
<div class="outline-text-4" id="text-h:b9909bd1-8062-46ae-9fe0-728611cc27f6">
<div class="org-src-container">
<pre class="src src-yaml">[root@ansible ~]#cat /data/ansible/roles/mysql/files/my.cnf
[mysqld]
socket=/tmp/mysql.sock
user=mysql
symbolic-links=0
datadir=/data/mysql
innodb_file_per_table=1
log-bin
pid-file=/data/mysql/mysqld.pid

[client]
port=3306
socket=/tmp/mysql.sock

[mysqld_safe]
log-error=/var/log/mysqld.log

[root@ansible ~]#cat /data/ansible/roles/mysql/files/secure_mysql.sh
#!/bin/bash
/usr/local/mysql/bin/mysql_secure_installation &lt;&lt;EOF

y
cici
cici
y
y
y
y
EOF

[root@ansible ~]#chmod +x /data/ansible/roles/mysql/files/secure_mysql.sh

[root@ansible ~]#ls /data/ansible/roles/mysql/files/
my.cnf mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz secure_mysql.sh

[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/main.yml
- include: install.yml
- include: group.yml
- include: user.yml
- include: unarchive.yml
- include: link.yml
- include: data.yml
- include: config.yml
- include: service.yml
- include: path.yml
- include: secure.yml

[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/install.yml
- name: install packages                                            
  yum: name=libaio,perl-Data-Dumper,perl-Getopt-Long
[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/group.yml
- name: create mysql group
  group: name=mysql gid=306
[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/user.yml
- name: create mysql user
  user: name=mysql uid=306 group=mysql shell=/sbin/nologin system=yes
create_home=no home=/data/mysql
[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/unarchive.yml
- name: copy tar to remote host and file mode
  unarchive: src=mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz dest=/usr/local/
owner=root group=root
[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/link.yml
- name: mkdir /usr/local/mysql
  file: src=/usr/local/mysql-5.6.46-linux-glibc2.12-x86_64 dest=/usr/local/mysql state=link
[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/data.yml
- name: data dir
  shell: chdir=/usr/local/mysql/ ./scripts/mysql_install_db --
datadir=/data/mysql --user=mysql
[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/config.yml
- name: config my.cnf
  copy: src=my.cnf  dest=/etc/my.cnf
[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/service.yml
- name: service script
  shell: /bin/cp /usr/local/mysql/support-files/mysql.server
/etc/init.d/mysqld;chkconfig --add mysqld;chkconfig mysqld on;/etc/init.d/mysqld start
[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/path.yml
- name: PATH variable
  copy: content='PATH=/usr/local/mysql/bin:$PATH' dest=/etc/profile.d/mysql.sh  

[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/secure.yml
- name: secure script
  script: secure_mysql.sh

[root@ansible ~]#tree /data/ansible/roles/mysql/
/data/ansible/roles/mysql/
â”œâ”€â”€ files
â”‚   â”œâ”€â”€ my.cnf
â”‚   â”œâ”€â”€ mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz
â”‚   â””â”€â”€ secure_mysql.sh
â””â”€â”€ tasks
   â”œâ”€â”€ config.yml
   â”œâ”€â”€ data.yml
   â”œâ”€â”€ group.yml
   â”œâ”€â”€ install.yml
   â”œâ”€â”€ link.yml
   â”œâ”€â”€ main.yml
   â”œâ”€â”€ path.yml
   â”œâ”€â”€ secure.yml
   â”œâ”€â”€ service.yml
   â”œâ”€â”€ unarchive.yml
   â””â”€â”€ user.yml

2 directories, 14 files

[root@ansible ~]#cat /data/ansible/mysql_roles.yml
- hosts: dbsrvs
  remote_user: root
  roles:
    - {role: mysql,tags: ["mysql","db"]}
    - {role: nginx,tage: ["nginx","web"]}

[root@ansible ~]#ansible-playbook -t mysql /data/ansible/mysql_roles.yml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:be894266-6075-47bb-a04e-8ee321be6bb8" class="outline-4">
<h4 id="h:be894266-6075-47bb-a04e-8ee321be6bb8">æ¡ˆä¾‹5 ï¼šå®ç°å¤šè§’è‰²çš„é€‰æ‹©</h4>
<div class="outline-text-4" id="text-h:be894266-6075-47bb-a04e-8ee321be6bb8">
<div class="org-src-container">
<pre class="src src-yaml">vim /data/ansible/role_httpd_nginx.yml
---
- hosts: websrvs

  roles:
    - {role: httpd,tags: [httpd,web], when:
ansible_distribution_major_version=="7" }
    - {role: nginx,tags: [nginx,web], when:
ansible_distribution_major_version=="8" }

ansible-playbook -t nginx /data/ansible/role_httpd_nginx.yml 
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:2a8aebef-4cee-4445-bd56-e180c06604f2" class="outline-2">
<h2 id="h:2a8aebef-4cee-4445-bd56-e180c06604f2">ansible-tower</h2>
<div class="outline-text-2" id="text-h:2a8aebef-4cee-4445-bd56-e180c06604f2">
<p>
1ï¼‰å…¬å¸ä¸­å®ç°è¿ç»´è‡ªåŠ¨åŒ–çš„æ¶æ„ä¸­ä¸»è¦ç”¨åˆ°ansibleï¼Œansibleè„šæœ¬åœ¨éƒ¨ç½²æœåŠ¡å™¨æŒ‡ä»¤
</p>

<p>
è¡Œä¸­æ˜¾å¾—ä¸å¤ªç›´è§‚ã€‚Ansible-Towerï¼ˆä¹‹å‰å«åšawxï¼‰æ˜¯å°†ansibleçš„æŒ‡ä»¤ç•Œé¢åŒ–ï¼Œç®€
</p>

<p>
æ˜ç›´è§‚ï¼Œç®€å•æ˜“ç”¨ã€‚
</p>

<p>
2ï¼‰Ansibke-towerå…¶å®å°±æ˜¯ä¸€ä¸ªå›¾å½¢åŒ–çš„ä»»åŠ¡è°ƒåº¦ï¼Œå¤æ‚æœåŠ¡éƒ¨ç½²ï¼ŒITè‡ªåŠ¨åŒ–çš„ä¸€ä¸ª
</p>

<p>
ç®¡ç†å¹³å°ï¼Œå±äºå‘å¸ƒé…ç½®ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒApiåŠç•Œé¢æ“ä½œï¼ŒDjangoç¼–å†™ã€‚
</p>

<p>
3ï¼‰Ansible-towerå¯ä»¥é€šè¿‡ç•Œé¢ä»githubæ‹‰å–æœ€æ–°playbookå®æ–½æœåŠ¡éƒ¨ç½²ï¼Œæé«˜ç”Ÿäº§
</p>

<p>
æ•ˆç‡ã€‚å½“ç„¶å®ƒä¹Ÿæä¾›ä¸€ä¸ªRESET APIå’Œå‘½ä»¤è¡Œçš„CLIä»¥ä¾›pythonè„šæœ¬è°ƒç”¨
</p>

<ul class="org-ul">
<li>å®‰è£…
<a href="https://docs.ansible.com/ansible-tower/latest/html/installandreference/tower_installer.html#obtain-the-aap-installation-program">https://docs.ansible.com/ansible-tower/latest/html/installandreference/tower_installer.html#obtain-the-aap-installation-program</a></li>

<li>ç”¨æˆ·æ–‡æ¡£
<a href="https://docs.ansible.com/ansible-tower/latest/html_zh//userguide/index.html">https://docs.ansible.com/ansible-tower/latest/html_zh//userguide/index.html</a></li>
<li>è®¢é˜…é—®é¢˜ <a href="https://www.milkfish.site/2021/05/13/1038.loli">https://www.milkfish.site/2021/05/13/1038.loli</a></li>
<li>å®˜æ–¹æºåœ°å€ï¼š<a href="http://releases.ansible.com/ansible-tower/setup-bundle/">http://releases.ansible.com/ansible-tower/setup-bundle/</a></li>
<li>å®˜ç½‘ä¸‹è½½åœ°å€: <a href="https://releases.ansible.com/ansible-tower/setup/">https://releases.ansible.com/ansible-tower/setup/</a></li>
</ul>
</div>
<div id="outline-container-h:f014f262-ac61-406d-84a0-19bfa0fbc552" class="outline-3">
<h3 id="h:f014f262-ac61-406d-84a0-19bfa0fbc552">ansible-towerå®‰è£…åŠé…ç½®</h3>
<div class="outline-text-3" id="text-h:f014f262-ac61-406d-84a0-19bfa0fbc552">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1. &#23433;&#35013;Ansible 2 </span>
yum install ansible -y
ansible &#8208;&#8208;version <span style="color: #b22222;">#</span><span style="color: #b22222;">ansible 2.9.25</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">2.&#23433;&#35013;tower</span>
<span style="color: #483d8b;">cd</span> /usr/local/src/
wget https://releases.ansible.com/ansible-tower/setup-bundle/ansible-tower-setup-bundle-3.8.4-1.tar.gz
tar zxf ansible&#8208;tower&#8208;setup&#8208;bundl
mv ansible&#8208;tower&#8208;setup&#8208;bundle&#8208;3.8.3&#8208;1 /usr/local/ans ible&#8208;tower
<span style="color: #483d8b;">cd</span> /usr/local/ansible&#8208;tower

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;&#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;inventory&#25991;&#20214; (&#27880;&#24847;&#65306;admin_password&#22788;&#22635;&#20889;&#30340;&#23601;&#26159;ansible&#8208;tower&#30331;&#38470;&#23494;&#30721;&#65292;&#23494; &#30721;&#21487;&#20197;&#33258;&#34892;&#35774;&#23450;)</span>
sed &#8208;i <span style="color: #8b2252;">"s#password=''#password='tower@12 3'#g"</span> inventory
sed &#8208;i <span style="color: #8b2252;">"s#host=''#host='127.0.0.1'#g"</span> inventory
sed &#8208;i <span style="color: #8b2252;">"s#port=''#port='5432'#g"</span> inventory
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#21069;&#20808;&#21019;&#24314;/var/log/tower&#30340;&#26085;&#24535;&#30446;&#24405;&#65292;&#19981;&#28982;&#20250;&#25253;&#38169;</span>
mkdir &#8208;p /var/log/tower
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25509;&#30528;&#25191;&#34892;ansible&#8208;tower&#30340;&#23433;&#35013;&#33050;&#26412;&#65292;&#22914;&#26524;&#32593;&#32476;&#27809;&#26377;&#38382;&#39064;&#30340;&#35805;&#32784;&#24515;&#31561;&#24453;&#23433;&#35013;&#23436;&#25104;&#21363;&#21487;.</span>
./setup.sh
</pre>
</div>

<p>
å®‰è£…å®Œæˆæ²¡æŠ¥é”™çš„è¯å³å¯è®¿é—®webé¡µé¢,è¿™é‡Œæµ‹è¯•æœºåœ°å€ä¸º172.16.60.244ï¼Œåˆ™è®¿
é—®ansible- toweråœ°å€å°±æ˜¯<a href="https://172.16.60.244">https://172.16.60.244</a>, é»˜è®¤åˆå§‹é¡µé¢å¦‚ä¸‹:é»˜è®¤ç”¨
æˆ·ä¸ºadminï¼Œå¯†ç ä¸ºinventoryæ–‡ä»¶admin_passwordå­—æ®µé…ç½®çš„å¯†ç ï¼ˆå¦‚ä¸Šè®¾ç½®çš„
å¯†ç ä¸ºâ€tower@123â€œ)ã€‚
</p>

<p>
ansible towerç ´è§£
</p>

<p>
æ­¥éª¤ç®€è¿°ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">1. &#20462;&#25913;licensing.py&#25991;&#20214; 
2. &#36816;&#34892;&#8221;ansible-tower-service restart&#8221;&#37325;&#21551;&#26381;&#21153; 

btw&#65306;&#19981;&#38656;&#35201;&#21435;&#23448;&#32593;&#30003;&#35831;Trial License 
</pre>
</div>

<p>
1.ä¿®æ”¹licensing.pyæ–‡ä»¶ è¯¥æ–‡ä»¶ä½äºï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">/var/lib/awx/venv/awx/lib/python3.6/site&#8208;packages/awx/main/utils/licensing.py 
</pre>
</div>

<p>
è¯¥æ–‡ä»¶å†…çš„æ–¹æ³•æ˜¯è´Ÿè´£LicenseéªŒè¯çš„æ ¸å¿ƒï¼Œå°†å…¶ç”¨ä½ ç†Ÿæ‚‰çš„ç¼–è¾‘å™¨æ‰“å¼€æ‰¾åˆ°
validateæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°±è´Ÿè´£Licenseçš„éªŒè¯ï¼Œåœ¨æˆ‘è¿™å…¶ä½äºè¯¥æ–‡ä»¶çš„409è¡Œã€‚è¡Œ
æ•°å¯èƒ½éšç€ç‰ˆæœ¬çš„å‡çº§æˆ–ä¿®æ”¹ä¸ä¸€å®šå‡†ç¡®ï¼Œä»¥æ–¹æ³•åä¸ºä¸»ã€‚
</p>

<p>
è¯¥æ–¹æ³•åŸæ–‡å¦‚ä¸‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">def validate(self):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">Return license attributes with additional validation info.</span>
    <span style="color: #a0522d;">attrs</span> = copy.deepcopy(self._attrs)
    <span style="color: #a0522d;">type</span> = attrs.get(<span style="color: #8b2252;">'license_type'</span>, <span style="color: #8b2252;">'none'</span>)

    <span style="color: #a020f0;">if</span> (<span style="color: #a0522d;">type</span> == <span style="color: #8b2252;">'UNLICENSED'</span> or False):
        attrs.update(dict(<span style="color: #a0522d;">valid_key</span>=False, <span style="color: #a0522d;">compliant</span>=False))
        <span style="color: #a020f0;">return</span> attrs
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'valid_key'</span>] = True
    <span style="color: #a020f0;">if</span> Host:
        <span style="color: #a0522d;">current_instances</span> = Host.objects.active_count()
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a0522d;">current_instances</span> = 0
    <span style="color: #a0522d;">available_instances</span> = int(attrs.get(<span style="color: #8b2252;">'instance_count'</span>, None) or 0)
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'current_instances'</span>] = current_instances
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'available_instances'</span>] = available_instances
    <span style="color: #a0522d;">free_instances</span> = (available_instances - current_instances)
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'free_instances'</span>] = max(0, free_instances)

    <span style="color: #a0522d;">license_date</span> = int(attrs.get(<span style="color: #8b2252;">'license_date'</span>, 0) or 0)
    <span style="color: #a0522d;">current_date</span> = int(time.time())
    <span style="color: #a0522d;">time_remaining</span> = license_date - current_date
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'time_remaining'</span>] = time_remaining
    <span style="color: #a020f0;">if</span> attrs.setdefault(<span style="color: #8b2252;">'trial'</span>, False):
        <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'grace_period_remaining'</span>] = time_remaining
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'grace_period_remaining'</span>] = (license_date + 2592000) - current_date
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'compliant'</span>] = bool(time_remaining &gt; 0 and free_instances &gt;= 0)
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'date_warning'</span>] = bool(time_remaining &lt; self.SUBSCRIPTION_TIMEOUT)
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'date_expired'</span>] = bool(time_remaining &lt;= 0)
    <span style="color: #a020f0;">return</span> attrs
</pre>
</div>

<p>
å°†å…¶æ”¹æˆè¿™ä¸ªæ ·å­å³å¯
</p>

<div class="org-src-container">
<pre class="src src-sh">def validate(self):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">Return license attributes with additional validation info.</span>
    <span style="color: #a0522d;">attrs</span> = copy.deepcopy(self._attrs)

    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'license_type'</span>] = <span style="color: #8b2252;">'enterprise'</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;License&#31867;&#22411;&#20026;&#20225;&#19994;&#29256;</span>
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'instance_count'</span>] = MAX_INSTANCES <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;Host&#25968;&#37327;&#20026;MAX_INSTANCES&#65292;&#21363;9999999&#12290;&#25179;&#19981;&#20303;&#23601;&#25913;&#25104;&#33258;&#24049;&#38656;&#35201;&#30340;&#25968;&#12290;</span>
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'license_date'</span>] = <span style="color: #8b2252;">'2567433600'</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;License&#36807;&#26399;&#26085;&#26399;&#20026;&#8221;2051-05-12 00:00:00&#8220;&#65292;Unix&#26102;&#38388;&#25139;&#65292;&#26377;&#38656;&#35201;&#33258;&#24049;&#25913;</span>
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'subscription_name'</span>] = <span style="color: #8b2252;">'mxd'</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20320;&#29468;</span>

    <span style="color: #a0522d;">type</span> = attrs.get(<span style="color: #8b2252;">'license_type'</span>, <span style="color: #8b2252;">'none'</span>)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#37322;&#25481;&#19979;&#38754;&#30340;&#21028;&#26029;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">if (type == 'UNLICENSED' or False):</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">attrs.update(dict(valid_key=False, compliant=False))</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">return attrs</span>
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'valid_key'</span>] = True <span style="color: #b22222;"># </span><span style="color: #b22222;">&#30452;&#25509;&#23558; valid_key &#35774;&#20026; true</span>
    <span style="color: #a020f0;">if</span> Host:
        <span style="color: #a0522d;">current_instances</span> = Host.objects.active_count()
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a0522d;">current_instances</span> = 0
    <span style="color: #a0522d;">available_instances</span> = int(attrs.get(<span style="color: #8b2252;">'instance_count'</span>, None) or 0)
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'current_instances'</span>] = current_instances
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'available_instances'</span>] = available_instances
    <span style="color: #a0522d;">free_instances</span> = (available_instances - current_instances)
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'free_instances'</span>] = max(0, free_instances)

    <span style="color: #a0522d;">license_date</span> = int(attrs.get(<span style="color: #8b2252;">'license_date'</span>, 0) or 0)
    <span style="color: #a0522d;">current_date</span> = int(time.time())
    <span style="color: #a0522d;">time_remaining</span> = license_date - current_date
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'time_remaining'</span>] = time_remaining
    <span style="color: #a020f0;">if</span> attrs.setdefault(<span style="color: #8b2252;">'trial'</span>, False):
        <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'grace_period_remaining'</span>] = time_remaining
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'grace_period_remaining'</span>] = (license_date + 2592000) - current_date
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'compliant'</span>] = bool(time_remaining &gt; 0 and free_instances &gt;= 0)
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'date_warning'</span>] = bool(time_remaining &lt; self.SUBSCRIPTION_TIMEOUT)
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'date_expired'</span>] = bool(time_remaining &lt;= 0)
    <span style="color: #a020f0;">return</span> attrs
</pre>
</div>

<p>
è¿è¡Œâ€ansible-tower-service restartâ€é‡å¯æœåŠ¡
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible-tower-service restart
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b61ae83f-b84c-4bee-9064-993448316b23" class="outline-3">
<h3 id="h:b61ae83f-b84c-4bee-9064-993448316b23">èµ„æºç®¡ç†</h3>
<div class="outline-text-3" id="text-h:b61ae83f-b84c-4bee-9064-993448316b23">
<p>
æ¨¡æ¿æ˜¯ä»»åŠ¡æ‰§è¡Œçš„å…¥å£ï¼Œå®ƒä¾èµ–é¡¹ç›®ã€æ¸…å•ã€ä½œè¯å…±åŒå®Œæˆä½œä¸šã€‚
</p>
</div>
<div id="outline-container-h:2e56641a-4ae6-4e27-a821-54173e307d3c" class="outline-4">
<h4 id="h:2e56641a-4ae6-4e27-a821-54173e307d3c">é¡¹ç›®</h4>
<div class="outline-text-4" id="text-h:2e56641a-4ae6-4e27-a821-54173e307d3c">
<p>
ansibleçš„ä»£ç åº“ä½ç½®ï¼Œå¯ä»¥æ ¹æ®åˆ†æ”¯ä¸åŒåˆ›å»ºä¸åŒçš„é¡¹ç›®ã€‚
</p>


<figure id="orgb811898">
<img src="images/image-20210722143628686.png" alt="image-20210722143628686.png">

<figcaption><span class="figure-number">Figure 3: </span>image-20210722143628686</figcaption>
</figure>

<pre class="example" id="org0cb1366">
åç§°ï¼šé¡¹ç›®åç§°
æœºæ„ï¼šé»˜è®¤Default
scmç±»å‹ï¼šä»£ç æº
scm url: æ”¯æŒssh \httpåè®®ï¼Œå¦‚git@github.com:ansible/ansible.git
scmå‡­è¯ï¼šè®¿é—®è®¤è¯
scmåˆ†æ”¯ï¼š
scmæ›´æ–°é€‰é¡¹ï¼šæœ‰4ä¸ªï¼Œè¿™é‡Œé€‰å¯åŠ¨æ—¶æ›´æ–°ä¿®è®¢
ç¼“å­˜æ—¶é—´ï¼šï¼›å¯åŠ¨æ›´æ–°æ—¶çš„ç¼“å­˜æ—¶é—´ã€‚0æ²¡æœ‰é™åˆ¶
</pre>
</div>
</div>
<div id="outline-container-h:e80a1802-daa9-4874-b0ac-86415e8674bd" class="outline-4">
<h4 id="h:e80a1802-daa9-4874-b0ac-86415e8674bd">æ¸…å•</h4>
<div class="outline-text-4" id="text-h:e80a1802-daa9-4874-b0ac-86415e8674bd">
<p>
ä¸»æœºåˆ—è¡¨ã€‚
</p>

<p>
å¯ä»¥è®¾ç½®ä¸»æœºç»„ã€è‡ªå®šä¹‰æº(å¦‚awsçš„EC2)ã€å¤–ç½®å˜é‡
</p>

<p>
èŒƒä¾‹ï¼šå¤–ç½®å˜é‡
</p>

<div class="org-src-container">
<pre class="src src-sh">domain_cloud: tx
domain_group: ops
domain_region: bj
</pre>
</div>
</div>
</div>
<div id="outline-container-h:44eec651-7df4-4808-a2ca-6306fc2ede84" class="outline-4">
<h4 id="h:44eec651-7df4-4808-a2ca-6306fc2ede84">å‡­è¯</h4>
<div class="outline-text-4" id="text-h:44eec651-7df4-4808-a2ca-6306fc2ede84">
<p>
æ‰§è¡Œansibleå‘½ä»¤æ—¶çš„å…è´¹å¯†é’¥å‡­è¯
</p>
</div>
</div>
<div id="outline-container-h:2ebeb837-b1a6-414c-b7b2-bd1d93020f31" class="outline-4">
<h4 id="h:2ebeb837-b1a6-414c-b7b2-bd1d93020f31">æ¨¡æ¿</h4>
<div class="outline-text-4" id="text-h:2ebeb837-b1a6-414c-b7b2-bd1d93020f31">
<p>
å¯ä¸´æ—¶å¤åˆ¶å·²æœ‰æ¨¡æ¿ä½¿ç”¨
</p>
</div>
</div>
</div>
</section>
<section id="outline-container-h:315887f9-3861-4b87-9e22-8c76dbd56ef7" class="outline-2">
<h2 id="h:315887f9-3861-4b87-9e22-8c76dbd56ef7">ansible æ¨èå­¦ä¹ èµ„æ–™</h2>
<div class="outline-text-2" id="text-h:315887f9-3861-4b87-9e22-8c76dbd56ef7">
<p>
<a href="http://galaxy.ansible.com">http://galaxy.ansible.com</a>
</p>

<p>
<a href="https://galaxy.ansible.com/explore#/">https://galaxy.ansible.com/explore#/</a>
</p>

<p>
<a href="http://github.com/">http://github.com/</a>
</p>

<p>
<a href="http://ansible.com.cn/">http://ansible.com.cn/</a>
</p>

<p>
<a href="https://github.com/ansible/ansible">https://github.com/ansible/ansible</a>
</p>

<p>
<a href="https://github.com/ansible/ansible-examples">https://github.com/ansible/ansible-examples</a>
</p>
</div>
</section>
</main class="container">
<footer id="postamble" class="status">
<footer data-astro-cid-sz7xmlte data-turbo-permanent id=rootFooter>
    <script>
        const shuffle = e => e.map((e => ({
            v: e,
            sort: Math.random()
        }))).sort(( (e, o) => e.sort - o.sort)).map(( ({v: e}) => e));
        var songList = ["barbie-girl--stantough", "blue-da-ba-dee--cornelius-link", "hips-dont-lie--stantough", "i-want-it-that-way--stantough", "seven-nation-army--stantough", "smooth-criminal--stantough"]
          , songOrder = songOrder ?? shuffle(songList).map((e => `/audio/music/${e}.opus`))
          , song = new Audio(songOrder[0])
          , nextSong = new Audio(songOrder[1])
          , songIndex = 2
          , musicWrapper = void 0
          , arrow = void 0
          , notes = void 0;
        song.addEventListener("ended", next);
        const toggle = () => song.paused ? play() : pause();
        function play() {
            song.play(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.add("shakeManHorse"),
            notes.classList.remove("hideNotes")
        }
        function pause() {
            song.pause(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.remove("shakeManHorse"),
            notes.classList.add("hideNotes")
        }
        function next() {
            song = nextSong,
            play(),
            songIndex === songOrder.length && (songIndex = 0),
            nextSong = new Audio(songOrder[songIndex]),
            songIndex += 1
        }
        function skip() {
            pause(),
            (arrow = arrow || document.getElementById("musicArrow")).classList.add("shootArrow");
            new Audio("/audio/effects/ohno.m4a").play(),
            arrow.addEventListener("animationend", arrowShootHandler, !1)
        }
        function arrowShootHandler() {
            arrow.removeEventListener("animationend", arrowShootHandler, !1),
            arrow.classList.remove("shootArrow");
            new Audio("/audio/effects/heythathurt.m4a").play(),
            next()
        }
    </script>
    <div id=musicPlayer data-astro-cid-q7a5pyro>
        <button class=skip data-astro-cid-q7a5pyro onclick=skip() title="Skip song">
            <div id=skipWrapper data-astro-cid-q7a5pyro>
                <img alt="Medieval drollery of a man/snail/bat/monkey shooting an arrow" class=archer decoding=async height=334 loading=lazy src=/images/archer-no-arrow.448ccd8b_Z1KfRYq.webp width=226 data-astro-cid-q7a5pyro>
                <img alt="Arrow for archer" class="arrow complete" decoding=async height=23 loading=lazy src=/images/no-archer-full-arrow.87aa9971_Z2qL2KO.webp width=141 data-astro-cid-q7a5pyro id=musicArrow>
            </div>
        </button>
        <button class=playPause data-astro-cid-q7a5pyro onclick=toggle() title="Play/pause song">
            <div id=musicWrapper data-astro-cid-q7a5pyro>
                <div class=hideNotes id=notesWrapper data-astro-cid-q7a5pyro>
                    <div class=lyreNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                    <div class=fluteNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                </div>
                <img alt="Medieval drollery of a man/horse playing a lyre and a horn" class=manHorse decoding=async height=665 loading=lazy src=/images/man-horse-band.e3a2efcf_q8FCa.webp width=531 data-astro-cid-q7a5pyro>
            </div>
        </button>
    </div>
    <hr data-astro-cid-sz7xmlte>
    <div class=salutation data-astro-cid-gdmrbrho>
        <p data-astro-cid-gdmrbrho>
            <span class=flower2 data-astro-cid-gdmrbrho>A</span>
            <span class=smallcap data-astro-cid-gdmrbrho>pax vobiscum</span>
            <span class="flower2 wiggle" data-astro-cid-gdmrbrho id=leaf>a</span>
        </p>
    </div>
    <script>
        function animateLeafBlownHandler() {
            leaf.removeEventListener("animationend", animateLeafBlownHandler, !1),
            leaf.classList.remove("blownAway"),
            leaf.classList.add("wiggle")
        }
        function animateLeaf() {
            leaf = leaf ?? document.getElementById("leaf"),
            leaf.classList.remove("wiggle"),
            leaf.classList.add("blownAway"),
            leaf.addEventListener("animationend", animateLeafBlownHandler, !1)
        }
        document.getElementById("leaf").onclick = animateLeaf
    </script>


    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>æ‰“èµ</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Â© 2024 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
</footer>
</footer>
</body>
</html>
