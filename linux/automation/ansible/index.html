<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: 运维自运化之ANSIBLE</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux: 运维自运化之ANSIBLE</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:84ddf4e0-a20f-44b6-a137-093f7e4395f2">自动化运维应用场景</a>
<ul>
<li><a href="#h:e00bf36d-f4aa-4a87-a172-275b1a8a47ea">云计算运维工程师核心职能</a></li>
<li><a href="#h:878ac49e-6690-43d7-a0d2-209179a708a5">运维职业发展路线</a></li>
<li><a href="#h:2fb2cb41-c298-4a9b-a44d-98c67e3930cd">企业实际应用场景分析</a>
<ul>
<li><a href="#h:53c855fe-83fc-4725-a2ae-c6c2f25b08a6">Dev开发环境</a></li>
<li><a href="#h:c7ea20f6-4bc6-4618-ba60-152425106899">测试环境</a></li>
<li><a href="#h:88157b54-f096-487d-84a5-4dc2aa10b182">预发布环境</a></li>
<li><a href="#h:37339f10-a627-42f8-89a9-dcfcc70385c4">发布环境</a></li>
<li><a href="#h:624d4231-0bab-4af5-8d39-1a9f9c9829a3">生产环境</a></li>
<li><a href="#h:c7c55a39-f72f-49e2-b1d4-b961e447f9a4">灰度环境 属于生产环境的一部分</a></li>
</ul>
</li>
<li><a href="#h:b00cf7e0-b5cc-4bfe-b124-e525e9e9a5cf">程序发布</a></li>
<li><a href="#h:7540fba6-cda0-49cc-b84f-c3a7e6bd286a">自动化运维应用场景</a></li>
<li><a href="#h:a8e4ed7b-1df1-4fd3-98cc-8ad4ae635c33">常用自动化运维工具</a></li>
</ul>
</li>
<li><a href="#h:35249014-b3c0-458d-a069-333d648cea5d">Ansible 介绍和架构</a>
<ul>
<li><a href="#h:4bce6968-88de-4ec0-ac27-f93039636b84">Ansible发展史</a></li>
<li><a href="#h:92bd14bf-7d89-429e-92cb-ebddc0951e01">Ansible 特性</a></li>
<li><a href="#h:070857b8-2694-472b-aa9a-f849de0453e6">Ansible 架构</a>
<ul>
<li><a href="#h:2e6a17ca-c051-4dc2-8b33-9f44d2ecd4d2">Ansible 组成</a></li>
<li><a href="#h:c839818d-7871-40f7-92e9-465c6e65b3b2">Ansible 命令执行来源</a></li>
<li><a href="#h:6cea1437-469b-4962-8326-24b59a218c34">注意事项</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:a6322f5b-fbe6-434d-99cc-3ba6b3c1de9a">Ansible 安装和入门</a>
<ul>
<li><a href="#h:e418aeb6-ad79-40b1-9eb3-daa673656b6e">Ansible安装</a>
<ul>
<li><a href="#h:8cdbc965-e214-4d61-a76b-489bf6f08c0c">EPEL源的rpm包安装:</a></li>
<li><a href="#h:ce27d17e-96c4-4767-9898-b0b5aaa23630">编译安装</a></li>
<li><a href="#h:2759777f-d498-40f8-9865-11652fc765ea">Git方式</a></li>
<li><a href="#h:e4102489-974c-4709-9c4c-d979a2a3e5ae">pip 安装</a></li>
<li><a href="#h:7d6ab60f-1897-4ff9-9e1f-c4fac0f70269">确认安装</a></li>
</ul>
</li>
<li><a href="#h:86a88466-07b0-401a-b428-787307c160e0">Ansible 相关文件</a>
<ul>
<li><a href="#h:cbe39e12-926d-431e-9cdb-6e5a34b5f3dc">配置文件</a></li>
<li><a href="#h:63523d2b-9f1d-4d0f-b83c-f115973989c6">ansible主配置文件</a></li>
<li><a href="#h:79d691b8-68d5-4af2-b503-a3874d5d8ab7">inventory 主机清单</a></li>
</ul>
</li>
<li><a href="#h:f638a674-924e-48d3-a6c9-a6586dfdd727">Ansible相关工具</a>
<ul>
<li><a href="#h:3b262897-d4e8-4dae-b624-4ad45d43de4c">ansible-doc</a></li>
<li><a href="#h:e41406a9-31fe-4c50-9007-e7781477b9ae">ansible</a></li>
<li><a href="#h:69c9ffb5-50ba-428e-bc25-4076e48e725b">ansible-playbook</a></li>
<li><a href="#h:2b06dcdf-28d2-4881-b5c0-4aaf1246e6f6">ansible-vault</a></li>
<li><a href="#h:a11de16a-c359-4239-8ee3-e5a99ef6980d">ansible-console</a></li>
<li><a href="#h:a32d361b-9c20-4688-afc6-5525c58f5bc4">ansible-galaxy</a></li>
</ul>
</li>
<li><a href="#h:25bf4dd4-f731-4bd9-9896-7d59251394a2">Ansible常用模块</a>
<ul>
<li><a href="#h:284c9372-03a0-4ec2-aaf5-a46b25066651">Command 模块</a></li>
<li><a href="#h:39a49c4f-c84c-47a0-870b-84f52bc9d0f4">Shell模块</a></li>
<li><a href="#h:7ccc1a8e-47f6-4b5f-9c2b-3f349b6283da">Script模块</a></li>
<li><a href="#h:804c9693-8571-40ad-88b8-81beeba167cc">Copy模块</a></li>
<li><a href="#h:706df931-2107-45c4-9f23-ca2ce81fa5c1">Fetch模块</a></li>
<li><a href="#h:600e3996-6c4d-49be-9adc-6d14233afb0d">File模块</a></li>
<li><a href="#h:6aa66dbb-472e-47b6-9a66-6b4e845bd4fe">unarchive模块</a></li>
<li><a href="#h:cf6723a1-88cb-42c8-b7ab-6098c76d2cb3">Archive模块</a></li>
<li><a href="#h:ac5aaa58-ca5b-4f82-8a46-105a35e0e580">Hostname模块</a></li>
<li><a href="#h:b5d8fcf8-e8da-4bf0-8174-f9beb3b1f052">Cron模块</a></li>
<li><a href="#h:9d2752cf-dcdc-48b2-9386-ce7f4b079e14">Yum 模块 Apt 模块</a></li>
<li><a href="#h:a5947938-fdf5-4aac-b0c6-d0d1e1b6427a">Package模块</a></li>
<li><a href="#h:e624bb8f-5da4-4997-8b22-f18f4d7f1d0f">Service模块</a></li>
<li><a href="#h:64477c11-2ec5-404e-b9cb-b954b44cdc51">User模块</a></li>
<li><a href="#h:78a08001-e7e2-4e38-9f29-c939e7545cdc">Group模块</a></li>
<li><a href="#h:34495623-4c73-4d50-a762-4b70beaebac3">Lineinfile模块</a></li>
<li><a href="#h:c5687051-26a7-4773-979d-9e7ebd63f2bc">Replace模块</a></li>
<li><a href="#h:5f76e222-0523-4bfa-9320-c8bc766f486d">Setup模块</a></li>
<li><a href="#h:40d14931-5787-4c91-9c34-ab669223c49f">set_fact模块</a></li>
<li><a href="#h:d5483b20-4a08-4c56-9649-e0b44c956110">selinux模块</a></li>
<li><a href="#h:0d44d365-59a3-45a0-bbec-ee235715e04c">debug模块</a></li>
<li><a href="#h:70380e05-19df-4a86-ba91-e2f8c5aec6ef">filesystem模块</a></li>
<li><a href="#h:2201d13a-1aec-49aa-8e31-9f3bcbe3aefc">mount模块</a></li>
<li><a href="#h:24e119bc-a6d8-4cab-b2a8-cae8ef05e8a3">authorized_key模块</a></li>
<li><a href="#h:1d7220f3-a61c-4ae4-b2a0-52304622ec42">systemd模块</a></li>
<li><a href="#h:82131cdc-b8cb-4223-a7d0-1ec555c7214e">lineinfile模块</a></li>
<li><a href="#h:ba12198f-b8bf-4a96-9682-539c97c33fd5">synchronize模块</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:82957dba-6f58-4cdf-ae1a-12db3ee0ccca">Playbook</a>
<ul>
<li><a href="#h:12279fce-9cf9-4abf-9def-1b804ca5a2c0">playbook介绍</a></li>
<li><a href="#h:6e33e4b5-fad2-4b45-863c-b7c76bfca760">YAML 语言</a>
<ul>
<li><a href="#h:8274922d-ed3b-469a-a601-f3e4d23d7de5">YAMl 语言介绍</a></li>
<li><a href="#h:665fd638-df24-49d6-b680-9b02125db467">YAML 语言特性</a></li>
<li><a href="#h:bbf71988-e55d-4e8d-a371-223045f7b39c">YAML语法简介</a></li>
<li><a href="#h:ba76bc61-0292-4c5b-a0f9-f45a3fdc0a0e">支持的数据类型</a>
<ul>
<li><a href="#h:5bb9f758-9760-4222-8cfc-12b44283542b">scalar 标量</a></li>
<li><a href="#h:f9cfd730-a4bf-4caf-af26-999c9138e099">Dictionary字典</a></li>
<li><a href="#h:6a315d07-eae9-4ab7-89fe-5acbd12b6ca5">List列表</a></li>
</ul>
</li>
<li><a href="#h:2de59182-2b01-4c4a-a518-816df9550dd2">三种常见的数据格式</a></li>
</ul>
</li>
<li><a href="#h:1ef2a223-efdb-4182-9c42-5ae32bac6e9d">Playbook 核心组件</a>
<ul>
<li><a href="#h:a47c2523-e7f0-4aff-9af9-16adafba5398">hosts 组件</a></li>
<li><a href="#h:bbc2ad3c-a0b1-446c-a56a-d64472538a1d">remote_user 组件</a></li>
<li><a href="#h:d9248277-dadd-496d-9bd6-a0c203e2f6ad">task列表和action组件</a></li>
<li><a href="#h:2fbe5631-b9c5-4f43-af46-3f50b4a7ee4b">其它组件</a></li>
<li><a href="#h:1f8b94d9-f2bb-4821-9d8a-35e5a61034c8">ShellScripts VS Playbook 案例</a></li>
</ul>
</li>
<li><a href="#h:90f0a6a6-bd2c-4a6e-bdaf-fddd8ea1c3d3">playbook 命令</a></li>
<li><a href="#h:cc8a752f-f1c5-4d3c-94ff-e476c563ec18">Playbook 初步</a>
<ul>
<li><a href="#h:c421ffdf-e86b-4b2d-915d-5be92b78f934">利用 playbook 创建 mysql 用户</a></li>
<li><a href="#h:71df824e-7fc3-4e56-bf22-bc2dbb7ab3c9">利用 playbook 安装 nginx</a></li>
<li><a href="#h:399a9bc8-f1f3-4e26-876f-b2b9279f2bd9">利用 playbook 安装和卸载 httpd</a></li>
<li><a href="#h:8edf4e09-1c22-4cc5-82a7-c17043cdba1d">利用 playbook 安装 mysql</a></li>
</ul>
</li>
<li><a href="#h:48b1755b-669a-4d64-84c7-31ad695adc4b">Playbook中使用handlers和notify</a></li>
<li><a href="#h:0a3aec5f-206c-42ec-83cc-6da69fa06720">Playbook中使用tags组件</a></li>
<li><a href="#h:e06de863-5a87-498b-83c6-3ee055a9206e">Playbook中使用变量</a>
<ul>
<li><a href="#h:f0ba9bee-6110-4a70-9be2-40067a2ce7c1">使用 setup 模块中变量</a></li>
<li><a href="#h:e090a3ba-479e-45f7-a157-e6cd7a18dd95">在playbook 命令行中定义变量</a></li>
<li><a href="#h:0a31f3d4-29d0-4a1c-8f5d-311d8d705a47">在playbook文件中定义变量</a></li>
<li><a href="#h:e59a6767-d5f6-421b-987f-666121c1e7d3">使用变量文件</a></li>
<li><a href="#h:fd507cde-3910-48c8-b136-a9facc62f707">主机清单文件中定义变量</a>
<ul>
<li><a href="#h:5fbc0907-d431-44ae-af3f-b1a1be551f2a">主机变量</a></li>
<li><a href="#h:daf87a79-1124-4aeb-b186-50bbef4e4b34">组（公共）变量</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:5578fa90-9c01-456a-9bd4-e660f888a8d5">template 模板</a>
<ul>
<li><a href="#h:24650b76-fac2-4002-aa7d-a0e80b33dd08">jinja2语言</a></li>
<li><a href="#h:4196f992-ed9f-486f-aadc-bb8b9e8fb7df">template</a></li>
<li><a href="#h:c117f799-8788-4b89-aeee-31c20ad9be93">template中使用流程控制 for 和 if</a></li>
</ul>
</li>
<li><a href="#h:a285cd08-19dd-4858-bf83-6c8ff2d72fd0">playbook使用 when</a></li>
<li><a href="#h:bd942071-2cea-48f6-a0cc-045587b70281">playbook 使用迭代 with_items</a></li>
<li><a href="#h:b3da52c8-a8c8-44d5-88af-a63654cb9ddc">管理节点过多导致的超时问题解决方法</a></li>
</ul>
</li>
<li><a href="#h:954e685a-1aef-4f59-a35b-8c16371ed21a">roles角色</a>
<ul>
<li><a href="#h:ad6a8b23-f7a6-43d9-8bc1-ad71d94ebfdc">Ansible Roles目录编排</a></li>
<li><a href="#h:5d533a95-d2ab-402d-883b-4a41fd54628c">创建 role</a></li>
<li><a href="#h:b64d06e1-b9b6-4996-b702-7159938bda55">playbook调用角色</a></li>
<li><a href="#h:62cd23ee-27ee-4a02-885b-0a0fdf45502c">roles 中 tags 使用</a></li>
<li><a href="#h:63ae80ce-faf4-4826-a393-f616f80e000c">实战案例</a>
<ul>
<li><a href="#h:6df15f85-1668-4a13-adb7-422464c2fc84">案例1：实现 httpd 角色</a></li>
<li><a href="#h:18580821-55a3-41e7-a91a-4b500d8689aa">案例2：实现 nginx 角色</a></li>
<li><a href="#h:256f9ea7-7b71-4850-9120-a309c8cee771">案例3：实现 memcached 角色</a></li>
<li><a href="#h:b9909bd1-8062-46ae-9fe0-728611cc27f6">案例4：实现 mysql 5.6 的角色</a></li>
<li><a href="#h:be894266-6075-47bb-a04e-8ee321be6bb8">案例5 ：实现多角色的选择</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:2a8aebef-4cee-4445-bd56-e180c06604f2">ansible-tower</a>
<ul>
<li><a href="#h:f014f262-ac61-406d-84a0-19bfa0fbc552">ansible-tower安装及配置</a></li>
<li><a href="#h:b61ae83f-b84c-4bee-9064-993448316b23">资源管理</a>
<ul>
<li><a href="#h:2e56641a-4ae6-4e27-a821-54173e307d3c">项目</a></li>
<li><a href="#h:e80a1802-daa9-4874-b0ac-86415e8674bd">清单</a></li>
<li><a href="#h:44eec651-7df4-4808-a2ca-6306fc2ede84">凭证</a></li>
<li><a href="#h:2ebeb837-b1a6-414c-b7b2-bd1d93020f31">模板</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:315887f9-3861-4b87-9e22-8c76dbd56ef7">ansible 推荐学习资料</a></li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../../index.html">Linux</a></li>
</ul>

<p>
主要内容：
</p>
<ul class="org-ul">
<li><b>运维自动化发展历程及技术应用</b></li>
<li><b>Ansible命令使用</b></li>
<li><b>Ansible常用模块详解</b></li>
<li><b>YAML语法简介</b></li>
<li><b>Ansible playbook基础</b></li>
<li><b>Playbook变量、tags、handlers使用</b></li>
<li><b>Playbook模板 templates</b></li>
<li><b>Playbook条件判断 when</b></li>
<li><b>Playbook字典 with_items</b></li>
<li><b>Ansible Roles</b></li>
</ul>
<section id="outline-container-h:84ddf4e0-a20f-44b6-a137-093f7e4395f2" class="outline-2">
<h2 id="h:84ddf4e0-a20f-44b6-a137-093f7e4395f2">自动化运维应用场景</h2>
<div class="outline-text-2" id="text-h:84ddf4e0-a20f-44b6-a137-093f7e4395f2">
</div>
<div id="outline-container-h:e00bf36d-f4aa-4a87-a172-275b1a8a47ea" class="outline-3">
<h3 id="h:e00bf36d-f4aa-4a87-a172-275b1a8a47ea">云计算运维工程师核心职能</h3>
<div class="outline-text-3" id="text-h:e00bf36d-f4aa-4a87-a172-275b1a8a47ea">
<p>
<b>相关工具</b>
</p>

<ul class="org-ul">
<li>代码管理（SCM）：GitHub、GitLab、BitBucket、SubVersion</li>
<li>构建工具：maven、Ant、Gradle</li>
<li>自动部署：Capistrano、CodeDeploy</li>
<li>持续集成（CI）：Jenkins、Travis</li>
<li>配置管理：Ansible、SaltStack、Chef、Puppet</li>
<li>容器：Docker、Podman、LXC、第三方厂商如AWS</li>
<li>编排：Kubernetes、Core、Apache Mesos</li>
<li>服务注册与发现：Zookeeper、etcd、Consul</li>
<li>脚本语言：python、ruby、shell</li>
<li>日志管理：ELK、Logentries</li>
<li>系统监控：Prometheus、Zabbix、Datadog、Graphite、Ganglia、Nagios</li>
<li>性能监控：AppDynamics、New Relic、Splunk</li>
<li>压力测试：JMeter、Blaze Meter、loader.io</li>
<li>应用服务器：Tomcat、JBoss、IIS</li>
<li>Web服务器：Apache、Nginx</li>
<li>数据库：MySQL、Oracle、PostgreSQL等关系型数据库；mongoDB、redis等NoSQL数据库</li>
<li>项目管理（PM）：Jira、Asana、Taiga、Trello、Basecamp、Pivotal Tracker</li>
</ul>
</div>
</div>
<div id="outline-container-h:878ac49e-6690-43d7-a0d2-209179a708a5" class="outline-3">
<h3 id="h:878ac49e-6690-43d7-a0d2-209179a708a5">运维职业发展路线</h3>
<div class="outline-text-3" id="text-h:878ac49e-6690-43d7-a0d2-209179a708a5">
<p>
互联网运维职业发展
</p>
<ul class="org-ul">
<li>基础运维</li>
<li>监控运维</li>
<li>系统运维</li>
<li>应用运维</li>
<li>自动化运维</li>
<li>架构师</li>
<li>总监或 CTO</li>
</ul>

<p>
<b>运维的未来是什么？</b>
</p>

<p>
<b>一切皆自动化</b>
</p>

<p>
"运维的未来是，让研发人员能够借助工具、自动化和流程，并且让他们能够在运维干预极少的情况下部署和运营服务，从而实现自助服务。每个角色都应该努力使工作实现自动化。"-&#x2013;&#x2014;《运维的未来》
</p>
</div>
</div>
<div id="outline-container-h:2fb2cb41-c298-4a9b-a44d-98c67e3930cd" class="outline-3">
<h3 id="h:2fb2cb41-c298-4a9b-a44d-98c67e3930cd">企业实际应用场景分析</h3>
<div class="outline-text-3" id="text-h:2fb2cb41-c298-4a9b-a44d-98c67e3930cd">

<figure id="org487448e">
<img src="./images/img_20240228_153050.png" alt="img_20240228_153050.png" width="80%">

</figure>
</div>
<div id="outline-container-h:53c855fe-83fc-4725-a2ae-c6c2f25b08a6" class="outline-4">
<h4 id="h:53c855fe-83fc-4725-a2ae-c6c2f25b08a6">Dev开发环境</h4>
<div class="outline-text-4" id="text-h:53c855fe-83fc-4725-a2ae-c6c2f25b08a6">
<p>
使用者：程序员
</p>

<p>
功能：程序员个人的办公电脑或项目的开发测试环境，部署开发软件，测试个人或项目整体的BUG的环境
</p>

<p>
管理者：程序员
</p>
</div>
</div>
<div id="outline-container-h:c7ea20f6-4bc6-4618-ba60-152425106899" class="outline-4">
<h4 id="h:c7ea20f6-4bc6-4618-ba60-152425106899">测试环境</h4>
<div class="outline-text-4" id="text-h:c7ea20f6-4bc6-4618-ba60-152425106899">
<p>
使用者：QA测试工程师
</p>

<p>
功能：测试经过Dev环境测试通过的软件的功能和性能，判断是否达到项目的预期目标，生成测试报告
</p>

<p>
管理者：运维
</p>

<p>
说明：测试环境往往有多套,测试环境满足测试功能即可，不宜过多
</p>
<ol class="org-ol">
<li>测试人员希望测试环境有多套,公司的产品多产品线并发，即多个版本，意味着多个版本同步测试</li>
<li>通常测试环境有多少套和产品线数量保持一样</li>
</ol>
</div>
</div>
<div id="outline-container-h:88157b54-f096-487d-84a5-4dc2aa10b182" class="outline-4">
<h4 id="h:88157b54-f096-487d-84a5-4dc2aa10b182">预发布环境</h4>
<div class="outline-text-4" id="text-h:88157b54-f096-487d-84a5-4dc2aa10b182">
<p>
使用者：运维
</p>

<p>
功能：使用和生产环境一样的数据库，缓存服务等配置，测试是否正常
</p>
</div>
</div>
<div id="outline-container-h:37339f10-a627-42f8-89a9-dcfcc70385c4" class="outline-4">
<h4 id="h:37339f10-a627-42f8-89a9-dcfcc70385c4">发布环境</h4>
<div class="outline-text-4" id="text-h:37339f10-a627-42f8-89a9-dcfcc70385c4">
<p>
包括代码发布机，有些公司为堡垒机（安全屏障）
</p>

<p>
使用者：运维
</p>

<p>
功能：发布代码至生产环境
</p>

<p>
管理者：运维（有经验）
</p>

<p>
发布机：往往需要有2台（主备）
</p>
</div>
</div>
<div id="outline-container-h:624d4231-0bab-4af5-8d39-1a9f9c9829a3" class="outline-4">
<h4 id="h:624d4231-0bab-4af5-8d39-1a9f9c9829a3">生产环境</h4>
<div class="outline-text-4" id="text-h:624d4231-0bab-4af5-8d39-1a9f9c9829a3">
<p>
使用者：运维，少数情况开放权限给核心开发人员，极少数公司将权限完全开放给开发人员并其维护
</p>

<p>
功能：对用户提供公司产品的服务
</p>

<p>
管理者：只能是运维
</p>

<p>
生产环境服务器数量：一般比较多，且应用非常重要。往往需要自动工具协助部署配置应用
</p>
</div>
</div>
<div id="outline-container-h:c7c55a39-f72f-49e2-b1d4-b961e447f9a4" class="outline-4">
<h4 id="h:c7c55a39-f72f-49e2-b1d4-b961e447f9a4">灰度环境 属于生产环境的一部分</h4>
<div class="outline-text-4" id="text-h:c7c55a39-f72f-49e2-b1d4-b961e447f9a4">
<p>
使用者：运维
</p>

<p>
功能：在全量发布代码前将代码的功能面向少量精准用户发布的环境,可基于主机或用户执行灰度发布
</p>

<p>
案例：共100台生产服务器，先发布其中的10台服务器，这10台服务器就是灰度服务器
</p>

<p>
管理者：运维
</p>

<p>
灰度环境：往往该版本功能变更较大，为保险起见特意先让一部分用户优化体验该功能，待这部分用户使用没有重大问题的时候，再全量发布至所有服务器
</p>
</div>
</div>
</div>
<div id="outline-container-h:b00cf7e0-b5cc-4bfe-b124-e525e9e9a5cf" class="outline-3">
<h3 id="h:b00cf7e0-b5cc-4bfe-b124-e525e9e9a5cf">程序发布</h3>
<div class="outline-text-3" id="text-h:b00cf7e0-b5cc-4bfe-b124-e525e9e9a5cf">
<p>
程序发布要求：
</p>

<ul class="org-ul">
<li>不能导致系统故障或造成系统完全不可用</li>
<li>不能影响用户体验</li>
</ul>

<p>
预发布验证：
</p>
<ul class="org-ul">
<li>新版本的代码先发布到服务器（跟线上环境配置完全相同，只是未接入到调度器）</li>
</ul>

<p>
灰度发布：
</p>
<ul class="org-ul">
<li>基于主机，用户，业务</li>
</ul>

<p>
发布路径：
</p>
<ul class="org-ul">
<li>/webapp/tuangou</li>
<li>/webapp/tuangou-1.1</li>
<li>/webapp/tuangou-1.2</li>
</ul>

<p>
<b>发布过程</b> ：
</p>

<ol class="org-ol">
<li>在调度器上下线一批主机(标记为maintenance 状态)</li>
<li>关闭服务</li>
<li>部署新版本的应用程序</li>
<li>启动服务</li>
<li>在调度器上启用这一批服务器</li>
</ol>

<p>
自动化灰度发布：
</p>

<ul class="org-ul">
<li>脚本</li>
<li>发布平台</li>
</ul>
</div>
</div>
<div id="outline-container-h:7540fba6-cda0-49cc-b84f-c3a7e6bd286a" class="outline-3">
<h3 id="h:7540fba6-cda0-49cc-b84f-c3a7e6bd286a">自动化运维应用场景</h3>
<div class="outline-text-3" id="text-h:7540fba6-cda0-49cc-b84f-c3a7e6bd286a">
<ul class="org-ul">
<li>文件传输</li>
<li>应用部署</li>
<li>配置管理</li>
<li>任务流编排</li>
</ul>
</div>
</div>
<div id="outline-container-h:a8e4ed7b-1df1-4fd3-98cc-8ad4ae635c33" class="outline-3">
<h3 id="h:a8e4ed7b-1df1-4fd3-98cc-8ad4ae635c33">常用自动化运维工具</h3>
<div class="outline-text-3" id="text-h:a8e4ed7b-1df1-4fd3-98cc-8ad4ae635c33">
<ul class="org-ul">
<li>Ansible：python，Agentless，中小型应用环境</li>
<li>Saltstack：python，一般需部署agent，执行效率更高</li>
<li>Puppet：ruby, 功能强大，配置复杂，重型，适合大型环境</li>
<li>Fabric：python，agentless</li>
<li>Chef：ruby，国内应用少</li>
<li>Cfengine</li>
<li>func</li>
</ul>

<p>
同类自动化工具GitHub关注程度（2016-07-10）
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">自动化运维工 具</th>
<th scope="col" class="org-right">Watch（关 注）</th>
<th scope="col" class="org-right">Star（点 赞）</th>
<th scope="col" class="org-right">Fork（复 制）</th>
<th scope="col" class="org-right">Contributors(贡献 者)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Ansible</td>
<td class="org-right">1387</td>
<td class="org-right">17716</td>
<td class="org-right">5356</td>
<td class="org-right">1428</td>
</tr>

<tr>
<td class="org-left">Saltstack</td>
<td class="org-right">530</td>
<td class="org-right">6678</td>
<td class="org-right">3002</td>
<td class="org-right">1520</td>
</tr>

<tr>
<td class="org-left">Puppet</td>
<td class="org-right">463</td>
<td class="org-right">4044</td>
<td class="org-right">1678</td>
<td class="org-right">425</td>
</tr>

<tr>
<td class="org-left">Chef</td>
<td class="org-right">383</td>
<td class="org-right">4333</td>
<td class="org-right">1806</td>
<td class="org-right">464</td>
</tr>

<tr>
<td class="org-left">Fabric</td>
<td class="org-right">379</td>
<td class="org-right">7334</td>
<td class="org-right">1235</td>
<td class="org-right">116</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="outline-container-h:35249014-b3c0-458d-a069-333d648cea5d" class="outline-2">
<h2 id="h:35249014-b3c0-458d-a069-333d648cea5d">Ansible 介绍和架构</h2>
<div class="outline-text-2" id="text-h:35249014-b3c0-458d-a069-333d648cea5d">
<p>
公司计划在年底做一次大型市场促销活动，全面冲刺下交易额，为明年的上市做准备。公司要求各业务组对年底大促做准备，运维部要求所有业务容量进行三倍的扩容，并搭建出多套环境可以共开发和测试人员做测试，运维老大为了在年底有所表现，要求运维部门同学尽快实现，当你接到这个任务时，有没有更快的解决方案？
</p>
</div>
<div id="outline-container-h:4bce6968-88de-4ec0-ac27-f93039636b84" class="outline-3">
<h3 id="h:4bce6968-88de-4ec0-ac27-f93039636b84">Ansible发展史</h3>
<div class="outline-text-3" id="text-h:4bce6968-88de-4ec0-ac27-f93039636b84">
<p>
作者：Michael DeHaan（ Cobbler 与 Func 作者）
</p>

<p>
ansible
的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离，远程实时控制前线的舰队战斗。
</p>

<p>
2012-03-09，发布0.0.1版，2015-10-17，Red Hat宣布1.5亿美元收购
</p>

<p>
官网：<a href="https://www.ansible.com/">https://www.ansible.com/</a>
</p>

<p>
官方文档：<a href="https://docs.ansible.com/">https://docs.ansible.com/</a>
</p>
</div>
</div>
<div id="outline-container-h:92bd14bf-7d89-429e-92cb-ebddc0951e01" class="outline-3">
<h3 id="h:92bd14bf-7d89-429e-92cb-ebddc0951e01">Ansible 特性</h3>
<div class="outline-text-3" id="text-h:92bd14bf-7d89-429e-92cb-ebddc0951e01">
<ul class="org-ul">
<li><b>模块化</b> ：调用特定的模块完成特定任务，支持自定义模块，可使用任何编程语言写模块</li>
<li>Paramiko（python对ssh的实现），PyYAML，Jinja2（模板语言）三个关键模块</li>
<li>基于Python语言实现</li>
<li><b>部署简单，基于python和SSH(默认已安装)，agentless，无需代理不依赖PKI（无需ssl）</b></li>
<li>安全，基于OpenSSH</li>
<li>幂等性： <b>一个任务执行1遍和执行n遍效果一样，不因重复执行带来意外情况</b></li>
<li>支持playbook编排任务，YAML格式，编排任务，支持丰富的数据结构</li>
<li>较强大的多层解决方案 role</li>
</ul>
</div>
</div>
<div id="outline-container-h:070857b8-2694-472b-aa9a-f849de0453e6" class="outline-3">
<h3 id="h:070857b8-2694-472b-aa9a-f849de0453e6">Ansible 架构</h3>
<div class="outline-text-3" id="text-h:070857b8-2694-472b-aa9a-f849de0453e6">
</div>
<div id="outline-container-h:2e6a17ca-c051-4dc2-8b33-9f44d2ecd4d2" class="outline-4">
<h4 id="h:2e6a17ca-c051-4dc2-8b33-9f44d2ecd4d2">Ansible 组成</h4>
<div class="outline-text-4" id="text-h:2e6a17ca-c051-4dc2-8b33-9f44d2ecd4d2">
<p>
组合INVENTORY、API、MODULES、PLUGINS的绿框，为ansible命令工具，其为核心执行工具
</p>

<ul class="org-ul">
<li>INVENTORY：Ansible管理主机的清单/etc/anaible/hosts</li>
<li>MODULES：Ansible执行命令的功能模块，多数为内置核心模块，也可自定义</li>
<li>PLUGINS：模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插件等，该功能不常用</li>
<li>API：供第三方程序调用的应用程序编程接口</li>
</ul>
</div>
</div>
<div id="outline-container-h:c839818d-7871-40f7-92e9-465c6e65b3b2" class="outline-4">
<h4 id="h:c839818d-7871-40f7-92e9-465c6e65b3b2">Ansible 命令执行来源</h4>
<div class="outline-text-4" id="text-h:c839818d-7871-40f7-92e9-465c6e65b3b2">
<ul class="org-ul">
<li>USER 普通用户，即SYSTEM ADMINISTRATOR</li>
<li>PLAYBOOKS：任务剧本（任务集），编排定义Ansible任务集的配置文件，由
Ansible顺序依次执行，通常是JSON格式的YML文件</li>
<li>CMDB（配置管理数据库） API 调用</li>
<li>PUBLIC/PRIVATE CLOUD API调用</li>
<li>USER-&gt; Ansible Playbook -&gt; Ansibile</li>
</ul>
</div>
</div>
<div id="outline-container-h:6cea1437-469b-4962-8326-24b59a218c34" class="outline-4">
<h4 id="h:6cea1437-469b-4962-8326-24b59a218c34">注意事项</h4>
<div class="outline-text-4" id="text-h:6cea1437-469b-4962-8326-24b59a218c34">
<ul class="org-ul">
<li>执行ansible的主机一般称为主控端，中控，master或堡垒机</li>
<li>主控端Python版本需要2.6或以上</li>
<li>被控端Python版本小于2.4，需要安装python-simplejson</li>
<li>被控端如开启SELinux需要安装libselinux-python</li>
<li>windows 不能做为主控端</li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-h:a6322f5b-fbe6-434d-99cc-3ba6b3c1de9a" class="outline-2">
<h2 id="h:a6322f5b-fbe6-434d-99cc-3ba6b3c1de9a">Ansible 安装和入门</h2>
<div class="outline-text-2" id="text-h:a6322f5b-fbe6-434d-99cc-3ba6b3c1de9a">
</div>
<div id="outline-container-h:e418aeb6-ad79-40b1-9eb3-daa673656b6e" class="outline-3">
<h3 id="h:e418aeb6-ad79-40b1-9eb3-daa673656b6e">Ansible安装</h3>
<div class="outline-text-3" id="text-h:e418aeb6-ad79-40b1-9eb3-daa673656b6e">
<p>
ansible的安装方法有多种
</p>

<p>
官方方档: <a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html">https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html</a>
</p>

<p>
下载： <a href="https://releases.ansible.com/ansible/">https://releases.ansible.com/ansible/</a>
</p>

<p>
pip 下载： <a href="https://pypi.org/project/ansible/">https://pypi.org/project/ansible/</a>
</p>
</div>
<div id="outline-container-h:8cdbc965-e214-4d61-a76b-489bf6f08c0c" class="outline-4">
<h4 id="h:8cdbc965-e214-4d61-a76b-489bf6f08c0c">EPEL源的rpm包安装:</h4>
<div class="outline-text-4" id="text-h:8cdbc965-e214-4d61-a76b-489bf6f08c0c">
<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#yum install ansible
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ce27d17e-96c4-4767-9898-b0b5aaa23630" class="outline-4">
<h4 id="h:ce27d17e-96c4-4767-9898-b0b5aaa23630">编译安装</h4>
<div class="outline-text-4" id="text-h:ce27d17e-96c4-4767-9898-b0b5aaa23630">
<div class="org-src-container">
<pre class="src src-sh">yum -y install python-jinja2 PyYAML python-paramiko python-babel python-crypto
wget https://releases.ansible.com/ansible/ansible-1.5.4.tar.gz
tar xf ansible-1.5.4.tar.gz
<span style="color: #483d8b;">cd</span> ansible-1.5.4
python setup.py build
python setup.py install
mkdir /etc/ansible
cp -r examples/* /etc/ansible
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2759777f-d498-40f8-9865-11652fc765ea" class="outline-4">
<h4 id="h:2759777f-d498-40f8-9865-11652fc765ea">Git方式</h4>
<div class="outline-text-4" id="text-h:2759777f-d498-40f8-9865-11652fc765ea">
<div class="org-src-container">
<pre class="src src-sh">git clone git://github.com/ansible/ansible.git --recursive
<span style="color: #483d8b;">cd</span> ./ansible
<span style="color: #483d8b;">source</span> ./hacking/env-setup
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e4102489-974c-4709-9c4c-d979a2a3e5ae" class="outline-4">
<h4 id="h:e4102489-974c-4709-9c4c-d979a2a3e5ae">pip 安装</h4>
<div class="outline-text-4" id="text-h:e4102489-974c-4709-9c4c-d979a2a3e5ae">
<p>
pip 是安装Python包的管理器，类似 yum
</p>

<div class="org-src-container">
<pre class="src src-sh">yum install python-pip python-devel
yum install gcc glibc-devel zibl-devel rpm-bulid openssl-devel
pip install --upgrade pip
pip install ansible --upgrade
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7d6ab60f-1897-4ff9-9e1f-c4fac0f70269" class="outline-4">
<h4 id="h:7d6ab60f-1897-4ff9-9e1f-c4fac0f70269">确认安装</h4>
<div class="outline-text-4" id="text-h:7d6ab60f-1897-4ff9-9e1f-c4fac0f70269">
<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#ansible --version
ansible 2.9.5
  config <span style="color: #a0522d;">file</span> = /etc/ansible/ansible.cfg
  configured module search <span style="color: #a0522d;">path</span> = [<span style="color: #8b2252;">'/root/.ansible/plugins/modules'</span>, <span style="color: #8b2252;">'/usr/share/ansible/plugins/modules'</span>]
  ansible python module <span style="color: #a0522d;">location</span> = /usr/lib/python3.6/site-packages/ansible
  executable <span style="color: #a0522d;">location</span> = /usr/bin/ansible
  python <span style="color: #a0522d;">version</span> = 3.6.8 (default, Nov 21 2019, 19:31:34) [GCC 8.3.1 20190507 (Red Hat 8.3.1-4)]
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:86a88466-07b0-401a-b428-787307c160e0" class="outline-3">
<h3 id="h:86a88466-07b0-401a-b428-787307c160e0">Ansible 相关文件</h3>
<div class="outline-text-3" id="text-h:86a88466-07b0-401a-b428-787307c160e0">
</div>
<div id="outline-container-h:cbe39e12-926d-431e-9cdb-6e5a34b5f3dc" class="outline-4">
<h4 id="h:cbe39e12-926d-431e-9cdb-6e5a34b5f3dc">配置文件</h4>
<div class="outline-text-4" id="text-h:cbe39e12-926d-431e-9cdb-6e5a34b5f3dc">
<ul class="org-ul">
<li>/etc/ansible/ansible.cfg 主配置文件，配置ansible工作特性</li>
<li>/etc/ansible/hosts 主机清单</li>
<li><i>etc/ansible/roles</i> 存放角色的目录</li>
</ul>
</div>
</div>
<div id="outline-container-h:63523d2b-9f1d-4d0f-b83c-f115973989c6" class="outline-4">
<h4 id="h:63523d2b-9f1d-4d0f-b83c-f115973989c6">ansible主配置文件</h4>
<div class="outline-text-4" id="text-h:63523d2b-9f1d-4d0f-b83c-f115973989c6">
<p>
Ansible 的配置文件 /etc/ansible/ansible.cfg ,其中大部分的配置内容无需
进行修改
</p>

<div class="org-src-container">
<pre class="src src-sh">[defaults]
<span style="color: #b22222;">#</span><span style="color: #b22222;">inventory = /etc/ansible/hosts # &#20027;&#26426;&#21015;&#34920;&#37197;&#32622;&#25991;&#20214;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">library = /usr/share/my_modules/ # &#24211;&#25991;&#20214;&#23384;&#25918;&#30446;&#24405;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">remote_tmp = $HOME/.ansible/tmp #&#20020;&#26102;py&#21629;&#20196;&#25991;&#20214;&#23384;&#25918;&#22312;&#36828;&#31243;&#20027;&#26426;&#30446;&#24405;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">local_tmp = $HOME/.ansible/tmp # &#26412;&#26426;&#30340;&#20020;&#26102;&#21629;&#20196;&#25191;&#34892;&#30446;&#24405;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">forks = 5 # &#40664;&#35748;&#24182;&#21457;&#25968;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">sudo_user = root # &#40664;&#35748;sudo &#29992;&#25143;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">ask_sudo_pass = True #&#27599;&#27425;&#25191;&#34892;ansible&#21629;&#20196;&#26159;&#21542;&#35810;&#38382;ssh&#23494;&#30721;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">ask_pass = True
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">remote_port = 22
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">host_key_checking = False # &#26816;&#26597;&#23545;&#24212;&#26381;&#21153;&#22120;&#30340;host_key&#65292;&#24314;&#35758;&#21462;&#28040;&#27880;&#37322;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">log_path=/var/log/ansible.log #&#26085;&#24535;&#25991;&#20214;&#65292;&#24314;&#35758;&#21551;&#29992;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">module_name = command #&#40664;&#35748;&#27169;&#22359;&#65292;&#21487;&#20197;&#20462;&#25913;&#20026;shell&#27169;&#22359;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:79d691b8-68d5-4af2-b503-a3874d5d8ab7" class="outline-4">
<h4 id="h:79d691b8-68d5-4af2-b503-a3874d5d8ab7">inventory 主机清单</h4>
<div class="outline-text-4" id="text-h:79d691b8-68d5-4af2-b503-a3874d5d8ab7">
<p>
ansible的主要功用在于批量主机操作，为了便捷地使用其中的部分主机，可以
在inventory file中将其分组命名
</p>

<p>
默认的inventory file为 <code>/etc/ansible/hosts</code>
</p>

<p>
inventory file可以有多个，且也可以通过Dynamic Inventory来动态生成
</p>

<p>
官方文档： <a href="https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html">https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html</a>
</p>

<p>
<b>主机清单文件格式</b>
</p>

<p>
inventory文件遵循INI文件风格，中括号中的字符为组名。可以将同一个主机同时归并到多个不同的组中
</p>

<p>
此外，当如若目标主机使用了非默认的SSH端口，还可以在主机名称之后使用冒号加端口号来标明
</p>

<p>
如果主机名称遵循相似的命名模式，还可以使用列表的方式标识各主机
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">ntp.cici.com
[webservers]
www1.cici.com:2222
www2.cici.com

[dbservers]
db1.cici.com
db2.cici.com
db3.cici.com

[websrvs]
www[1:100].example.com

[dbsrvs]
db-[a:f].example.com

[appsrvs]
10.0.0.[1:100]
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">[test]
10.0.0.8  <span style="color: #a0522d;">ansible_connection</span>=local  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#26412;&#22320;&#36830;&#25509;,&#26080;&#38656;ssh&#37197;&#32622;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ansible_connection=ssh &#38656;&#35201;StrictHostKeyChecking no
</span>10.0.0.7  <span style="color: #a0522d;">ansible_connection</span>=ssh  <span style="color: #a0522d;">ansible_port</span>=2222  <span style="color: #a0522d;">ansible_user</span>=wang <span style="color: #a0522d;">ansible_password</span>=magedu 
10.0.0.6  <span style="color: #a0522d;">ansible_connection</span>=ssh  <span style="color: #a0522d;">ansible_user</span>=root  <span style="color: #a0522d;">ansible_password</span>=123456 
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:f638a674-924e-48d3-a6c9-a6586dfdd727" class="outline-3">
<h3 id="h:f638a674-924e-48d3-a6c9-a6586dfdd727">Ansible相关工具</h3>
<div class="outline-text-3" id="text-h:f638a674-924e-48d3-a6c9-a6586dfdd727">
<ul class="org-ul">
<li>/usr/bin/ansible 主程序，临时命令执行工具</li>
<li>/usr/bin/ansible-doc 查看配置文档，模块功能查看工具,相当于man</li>
<li>/usr/bin/ansible-playbook 定制自动化任务，编排剧本工具,相当于脚本</li>
<li>/usr/bin/ansible-pull 远程执行命令的工具</li>
<li>/usr/bin/ansible-vault 文件加密工具</li>
<li>/usr/bin/ansible-console 基于Console界面与用户交互的执行工具</li>
<li>/usr/bin/ansible-galaxy 下载/上传优秀代码或Roles模块的官网平台</li>
</ul>

<p>
<b>利用ansible实现管理的主要方式</b> ：
</p>

<ul class="org-ul">
<li>Ad-Hoc 即利用ansible命令，主要用于临时命令使用场景</li>
<li>Ansible-playbook主要用于长期规划好的，大型项目的场景，需要有前期的规
划过程</li>
</ul>
</div>
<div id="outline-container-h:3b262897-d4e8-4dae-b624-4ad45d43de4c" class="outline-4">
<h4 id="h:3b262897-d4e8-4dae-b624-4ad45d43de4c">ansible-doc</h4>
<div class="outline-text-4" id="text-h:3b262897-d4e8-4dae-b624-4ad45d43de4c">
<p>
此工具用来显示模块帮助
</p>

<p>
格式
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible-doc [options] [module...]
-l, --list <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#21487;&#29992;&#27169;&#22359;
</span>-s, --snippet <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#25351;&#23450;&#27169;&#22359;&#30340;playbook&#29255;&#27573;</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;&#27169;&#22359;
</span>ansible-doc -l
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#27169;&#22359;&#24110;&#21161;&#29992;&#27861;
</span>ansible-doc ping
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#27169;&#22359;&#24110;&#21161;&#29992;&#27861;
</span>ansible-doc -s ping
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#date
Wed Jun 17 16:08:09 CST 2020
[root@ansible ~]#ansible --version
ansible 2.9.9
  config <span style="color: #a0522d;">file</span> = /etc/ansible/ansible.cfg
  configured module search <span style="color: #a0522d;">path</span> = [<span style="color: #8b2252;">'/root/.ansible/plugins/modules'</span>, <span style="color: #8b2252;">'/usr/share/ansible/plugins/modules'</span>]
  ansible python module <span style="color: #a0522d;">location</span> = /usr/lib/python3.6/site-packages/ansible
  executable <span style="color: #a0522d;">location</span> = /usr/bin/ansible
  python <span style="color: #a0522d;">version</span> = 3.6.8 (default, May 21 2019, 23:51:36) [GCC 8.2.1 20180905 (Red Hat 8.2.1-3)]

[root@ansible ~]#ansible-doc -l|wc -l
3387

[root@ansible ~]#ansible-doc -s ping
- name: Try to connect to host, verify a usable python and return <span style="color: #ff00ff;">`pong' on success
  ping:
      data:     # Data to return for the `</span>ping<span style="color: #8b2252;">' return value. If this                     parameter is set to `crash'</span>, the module will cause an                     exception.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e41406a9-31fe-4c50-9007-e7781477b9ae" class="outline-4">
<h4 id="h:e41406a9-31fe-4c50-9007-e7781477b9ae">ansible</h4>
<div class="outline-text-4" id="text-h:e41406a9-31fe-4c50-9007-e7781477b9ae">
<p>
此工具通过ssh协议，实现对远程主机的配置管理、应用部署、任务执行等功能
</p>

<p>
建议：使用此工具前，先配置ansible主控端能基于密钥认证的方式联系各个被管理节点
</p>

<p>
范例：利用sshpass批量实现基于key验证脚本1
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /etc/ssh/ssh_config
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#19979;&#38754;&#19968;&#34892;
</span>StrictHostKeyChecking no

[root@centos8 ~]#cat hosts.list
10.0.0.18
10.0.0.28
[root@centos8 ~]#vim push_ssh_key.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash
</span>rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass
[ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P <span style="color: #8b2252;">''</span>
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">SSHPASS</span>=cici
<span style="color: #a020f0;">while </span><span style="color: #483d8b;">read</span> IP;<span style="color: #a020f0;">do</span>
    sshpass -e ssh-copy-id -o <span style="color: #a0522d;">StrictHostKeyChecking</span>=no $<span style="color: #a0522d;">IP</span>
<span style="color: #a020f0;">done</span> &lt; hosts.list
</pre>
</div>

<p>
范例: 实现基于key验证的脚本2
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">IPLIST</span>=<span style="color: #8b2252;">"
10.0.0.8
10.0.0.18
10.0.0.7
10.0.0.6
10.0.0.200"</span>

rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass
[ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P <span style="color: #8b2252;">''</span>
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">SSHPASS</span>=centos
<span style="color: #a020f0;">for</span> IP<span style="color: #a020f0;"> in</span> $<span style="color: #a0522d;">IPLIST</span>;<span style="color: #a020f0;">do</span>
    sshpass -e ssh-copy-id -o <span style="color: #a0522d;">StrictHostKeyChecking</span>=no $<span style="color: #a0522d;">IP</span>
<span style="color: #a020f0;">done</span>
</pre>
</div>

<p>
格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible &lt;host-pattern&gt; [-m module_name] [-a args]
        &#20027;&#26426;&#28165;&#21333;&#21015;&#34920;         &#27169;&#22359;            &#21442;&#25968;
</pre>
</div>

<p>
选项说明：
</p>

<div class="org-src-container">
<pre class="src src-sh">--version                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#29256;&#26412;
</span>-m module                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#27169;&#22359;&#65292;&#40664;&#35748;&#20026;command
</span>-v                         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35814;&#32454;&#36807;&#31243; &#8211;vv -vvv&#26356;&#35814;&#32454;
</span>--list-hosts             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#20027;&#26426;&#21015;&#34920;&#65292;&#21487;&#31616;&#20889; --list
</span>-k, --ask-pass             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#31034;&#36755;&#20837;ssh&#36830;&#25509;&#23494;&#30721;&#65292;&#40664;&#35748;Key&#39564;&#35777;
</span>-C, --check             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#65292;&#24182;&#19981;&#25191;&#34892;
</span>-T, --timeout=TIMEOUT      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;&#21629;&#20196;&#30340;&#36229;&#26102;&#26102;&#38388;&#65292;&#40664;&#35748;10s
</span>-u, --user=REMOTE_USER     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;&#36828;&#31243;&#25191;&#34892;&#30340;&#29992;&#25143;
</span>-b, --become             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20195;&#26367;&#26087;&#29256;&#30340;sudo &#20999;&#25442;
</span>--become-user=USERNAME  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;sudo&#30340;runas&#29992;&#25143;&#65292;&#40664;&#35748;&#20026;root
</span>-K, --ask-become-pass     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#31034;&#36755;&#20837;sudo&#26102;&#30340;&#21475;&#20196;</span>
</pre>
</div>

<p>
<b>ansible的Host-pattern</b>
</p>

<p>
用于匹配被控制的主机的列表
</p>

<p>
All ：表示所有Inventory中的所有主机
</p>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible all &#8211;m ping

[root@ansible ~]#ansible all --list
  hosts (5):
    10.0.0.8
    10.0.0.7
    10.0.0.6
    10.0.0.100
    10.0.0.18
[root@ansible ~]#ansible websrvs --list
  hosts (2):
    10.0.0.8
    10.0.0.7
</pre>
</div>

<p>
​<code>*</code> :通配符
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible <span style="color: #8b2252;">"*&#8221; -m ping
ansible 192.168.1.* -m ping
ansible "</span>srvs&#8221; -m ping
</pre>
</div>

<p>
或关系
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible <span style="color: #8b2252;">"websrvs:appsrvs"</span> -m ping
ansible <span style="color: #8b2252;">"192.168.1.10:192.168.1.20"</span> -m ping
</pre>
</div>

<p>
逻辑与
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;websrvs&#32452;&#24182;&#19988;&#22312;dbsrvs&#32452;&#20013;&#30340;&#20027;&#26426;
</span>ansible <span style="color: #8b2252;">"websrvs:&amp;dbsrvs"</span> &#8211;m ping
</pre>
</div>

<p>
逻辑非
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;websrvs&#32452;&#65292;&#20294;&#19981;&#22312;dbsrvs&#32452;&#20013;&#30340;&#20027;&#26426;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#65306;&#27492;&#22788;&#20026;&#21333;&#24341;&#21495;
</span>ansible <span style="color: #8b2252;">'websrvs:!dbsrvs'</span> &#8211;m ping
</pre>
</div>

<p>
综合逻辑
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible <span style="color: #8b2252;">'websrvs:dbsrvs:&amp;appsrvs:!ftpsrvs'</span> &#8211;m ping
</pre>
</div>

<p>
正则表达式
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible <span style="color: #8b2252;">"websrvs:dbsrvs"</span> &#8211;m ping
ansible <span style="color: #8b2252;">"~(web|db).*\.cici\.com"</span> &#8211;m ping
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@kube-master1 ~]#ansible <span style="color: #8b2252;">'kube*:etcd:!10.0.0.101'</span> -a reboot
</pre>
</div>

<p>
范例:
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ansible appsrvs --list-hosts 
<span style="color: #0000ff;">hosts</span> (2):
  10.0.0.7
  10.0.0.8
[root@centos8 ~]#ansible <span style="color: #8b2252;">"appsrvs:dbsrvs"</span> --list-hosts 
<span style="color: #0000ff;">hosts</span> (3):
  10.0.0.7
  10.0.0.8
  10.0.0.6
[root@centos8 ~]#ansible <span style="color: #8b2252;">"appsrvs:&amp;dbsrvs"</span> --list-hosts 
<span style="color: #0000ff;">hosts</span> (1):
  10.0.0.7
[root@centos8 ~]#ansible <span style="color: #8b2252;">"appsrvs:!dbsrvs"</span> --list-hosts 
-bash: !dbsrvs: event not found
[root@centos8 ~]#ansible <span style="color: #8b2252;">'appsrvs:!dbsrvs'</span> --list-hosts 
<span style="color: #0000ff;">hosts</span> (1):
  10.0.0.8
</pre>
</div>

<p>
<b>ansible命令执行过程</b>
</p>

<ol class="org-ol">
<li>加载自己的配置文件 默认/etc/ansible/ansible.cfg</li>
<li>加载自己对应的模块文件，如：command</li>
<li><p>
通过ansible将模块或命令生成对应的临时py文件，并将该文件传输至远程服务器的对应执行用户
</p>

<p>
$HOME/.ansible/tmp/ansible-tmp-数字/XXX.PY文件
</p></li>

<li>给文件 <code>+x</code> 执行</li>
<li>执行并返回结果</li>
<li>删除临时py文件，退出</li>
</ol>

<p>
<b>ansible 的执行状态</b> ：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#grep -A 14 <span style="color: #8b2252;">'\[colors\]'</span> /etc/ansible/ansible.cfg
[colors]
<span style="color: #b22222;">#</span><span style="color: #b22222;">highlight = white
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">verbose = blue
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">warn = bright purple
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">error = red
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">debug = dark gray
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">deprecate = purple
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">skip = cyan
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">unreachable = red
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">ok = green
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">changed = yellow
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">diff_add = green
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">diff_remove = red
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">diff_lines = cyan</span>
</pre>
</div>

<ul class="org-ul">
<li>绿色：执行成功并且不需要做改变的操作</li>
<li>黄色：执行成功并且对目标主机做变更</li>
<li>红色：执行失败</li>
</ul>

<p>
<b>ansible使用范例</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;wang&#29992;&#25143;&#25191;&#34892;ping&#23384;&#27963;&#26816;&#27979;
</span>ansible all -m ping -u wang -k
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;wang sudo&#33267;root&#25191;&#34892;ping&#23384;&#27963;&#26816;&#27979;
</span>ansible all -m ping -u wang -k -b
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;wang sudo&#33267;cici&#29992;&#25143;&#25191;&#34892;ping&#23384;&#27963;&#26816;&#27979;
</span>ansible all -m ping -u wang -k -b --become-user=cici
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;wang sudo&#33267;root&#29992;&#25143;&#25191;&#34892;ls
</span>ansible all -m command -u wang -a <span style="color: #8b2252;">'ls /root'</span> -b --become-user=root -k -K
</pre>
</div>
</div>
</div>
<div id="outline-container-h:69c9ffb5-50ba-428e-bc25-4076e48e725b" class="outline-4">
<h4 id="h:69c9ffb5-50ba-428e-bc25-4076e48e725b">ansible-playbook</h4>
<div class="outline-text-4" id="text-h:69c9ffb5-50ba-428e-bc25-4076e48e725b">
<p>
此工具用于执行编写好的 playbook 任务
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible-playbook hello.yml
cat hello.yml
---
<span style="color: #b22222;">#</span><span style="color: #b22222;">hello world yml file
</span>- hosts: websrvs
  remote_user: root
  tasks:
    - name: hello world
      command: /usr/bin/wall hello world
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2b06dcdf-28d2-4881-b5c0-4aaf1246e6f6" class="outline-4">
<h4 id="h:2b06dcdf-28d2-4881-b5c0-4aaf1246e6f6">ansible-vault</h4>
<div class="outline-text-4" id="text-h:2b06dcdf-28d2-4881-b5c0-4aaf1246e6f6">
<p>
此工具可以用于加密解密yml文件
</p>

<p>
格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible-vault [create|decrypt|edit|encrypt|rekey|view]
</pre>
</div>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible-vault encrypt hello.yml <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#23494;
</span>ansible-vault decrypt hello.yml <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35299;&#23494;
</span>ansible-vault view hello.yml     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;
</span>ansible-vault edit hello.yml     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#36753;&#21152;&#23494;&#25991;&#20214;
</span>ansible-vault rekey hello.yml     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#21475;&#20196;
</span>ansible-vault create new.yml     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#26032;&#25991;&#20214;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a11de16a-c359-4239-8ee3-e5a99ef6980d" class="outline-4">
<h4 id="h:a11de16a-c359-4239-8ee3-e5a99ef6980d">ansible-console</h4>
<div class="outline-text-4" id="text-h:a11de16a-c359-4239-8ee3-e5a99ef6980d">
<p>
此工具可交互执行命令，支持tab，ansible 2.0+新增
</p>

<p>
提示符格式：
</p>

<pre class="example" id="org8ca5041">
执行用户@当前操作的主机组 (当前组的主机数量)[f:并发数]$
</pre>

<p>
常用子命令：
</p>

<ul class="org-ul">
<li>设置并发数： forks n 例如： forks 10</li>
<li>切换组： cd 主机组 例如： cd web</li>
<li>列出当前组主机列表： list</li>
<li>列出所有的内置命令： ?或help</li>
</ul>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#ansible-console
Welcome to the ansible console.
Type help or ? to list commands.

root@all (3)[f:5]$ list
10.0.0.8
10.0.0.7
10.0.0.6
root@all (3)[f:5]$ cd websrvs
root@websrvs (2)[f:5]$ list
10.0.0.7
10.0.0.8
root@websrvs (2)[f:5]$ forks 10
root@websrvs (2)[f:10]$ cd appsrvs
root@appsrvs (2)[f:5]$ yum <span style="color: #a0522d;">name</span>=httpd <span style="color: #a0522d;">state</span>=present
root@appsrvs (2)[f:5]$ service <span style="color: #a0522d;">name</span>=httpd <span style="color: #a0522d;">state</span>=started
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a32d361b-9c20-4688-afc6-5525c58f5bc4" class="outline-4">
<h4 id="h:a32d361b-9c20-4688-afc6-5525c58f5bc4">ansible-galaxy</h4>
<div class="outline-text-4" id="text-h:a32d361b-9c20-4688-afc6-5525c58f5bc4">
<p>
此工具会连接 <a href="https://galaxy.ansible.com">https://galaxy.ansible.com</a> 下载相应的roles
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;&#24050;&#23433;&#35013;&#30340;galaxy
</span>ansible-galaxy list
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;galaxy
</span>ansible-galaxy install geerlingguy.mysql
ansible-galaxy install geerlingguy.redis
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;galaxy
</span>ansible-galaxy remove geerlingguy.redis
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:25bf4dd4-f731-4bd9-9896-7d59251394a2" class="outline-3">
<h3 id="h:25bf4dd4-f731-4bd9-9896-7d59251394a2">Ansible常用模块</h3>
<div class="outline-text-3" id="text-h:25bf4dd4-f731-4bd9-9896-7d59251394a2">
<p>
2015年底270多个模块，2016年达到540个，2018年01月12日有1378个模块，2018
年07月15日1852个模块,2019年05月25日（ansible 2.7.10）时2080个模块，
2020年03月02日有3387个模块
</p>

<p>
虽然模块众多，但最常用的模块也就2，30个而已，针对特定业务只用10几个模块
</p>

<p>
常用模块帮助文档参考：
</p>

<p>
<a href="https://docs.ansible.com/ansible/latest/modules/modules_by_category.html">https://docs.ansible.com/ansible/latest/modules/modules_by_category.html</a>
</p>

<p>
模块（也称为“任务插件”或“库插件”）是离散的代码单元，可从命令行或在 playbook 任务中使用。Ansible 通常在远程托管节点上执行每个模块，并收集返回值。在 Ansible 2.10 及更高版本中，大多数模块都托管在集合中。
</p>

<p>
REFERENCE &amp; APPENDICES 参考文献和附录，收集所有集合索引: 
<a href="https://docs.ansible.com/ansible/latest/collections/index.html#list-of-collections">https://docs.ansible.com/ansible/latest/collections/index.html#list-of-collections</a>
</p>
</div>
<div id="outline-container-h:284c9372-03a0-4ec2-aaf5-a46b25066651" class="outline-4">
<h4 id="h:284c9372-03a0-4ec2-aaf5-a46b25066651">Command 模块</h4>
<div class="outline-text-4" id="text-h:284c9372-03a0-4ec2-aaf5-a46b25066651">
<p>
功能：在远程主机执行命令，此为默认模块，可忽略-m选项
</p>

<p>
注意：此命令不支持 <code>$VARNAME &lt; &gt; | ; &amp;</code> 等，用shell模块实现
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#ansible websrvs -m command -a <span style="color: #8b2252;">'chdir=/etc cat centos-release'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
CentOS Linux release 7.7.1908 (Core)
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
CentOS Linux release 8.1.1911 (Core)
[root@ansible ~]#ansible websrvs -m command -a <span style="color: #8b2252;">'chdir=/etc creates=/data/f1.txt
cat centos-release'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
CentOS Linux release 7.7.1908 (Core)
10.0.0.8 | SUCCESS | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
skipped, since /data/f1.txt exists
[root@ansible ~]#ansible websrvs -m command -a <span style="color: #8b2252;">'chdir=/etc removes=/data/f1.txt
cat centos-release'</span>
10.0.0.7 | SUCCESS | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
skipped, since /data/f1.txt does not exist
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
CentOS Linux release 8.1.1911 (Core)

ansible websrvs -m command -a &#8216;service vsftpd start&#8217;
ansible websrvs -m command -a &#8216;echo cici |passwd --stdin wang&#8217;
ansible websrvs -m command -a <span style="color: #8b2252;">'rm -rf /data/'</span>
ansible websrvs -m command -a <span style="color: #8b2252;">'echo hello &gt; /data/hello.log'</span>
ansible websrvs -m command -a <span style="color: #8b2252;">"echo $HOSTNAME"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:39a49c4f-c84c-47a0-870b-84f52bc9d0f4" class="outline-4">
<h4 id="h:39a49c4f-c84c-47a0-870b-84f52bc9d0f4">Shell模块</h4>
<div class="outline-text-4" id="text-h:39a49c4f-c84c-47a0-870b-84f52bc9d0f4">
<p>
功能：和command相似，用shell执行命令，支持各种符号。比如: <code>*,$, &gt;</code>
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ansible websrvs -m shell -a <span style="color: #8b2252;">"echo $HOSTNAME"</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
centos8
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
centos8
[root@centos8 ~]#ansible websrvs -m shell -a <span style="color: #8b2252;">'echo $HOSTNAME'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
Centos7.8
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
centos8.1.cuiqinghe.com

[root@centos8 ~]#ansible websrvs -m shell -a <span style="color: #8b2252;">'echo centos | passwd --stdin cui'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
Changing password for user cui.
passwd: all authentication tokens updated successfully.
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
Changing password for user cui.
passwd: all authentication tokens updated successfully.

[root@centos8 ~]#ansible websrvs -m shell -a <span style="color: #8b2252;">'ls -l /etc/shadow'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
---------- 1 root root 806 Jun 18 16:17 /etc/shadow
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
---------- 1 root root 868 Jun 19 16:17 /etc/shadow

[root@centos8 ~]#ansible websrvs -m shell -a <span style="color: #8b2252;">'echo hello &gt; /data/hello.log'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;

10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;

[root@centos8 ~]#ansible websrvs -m shell -a <span style="color: #8b2252;">'cat /data/hello.log'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
hello
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
hello
</pre>
</div>

<p>
注意：调用bash执行命令 类似 <code>cat /tmp/test.md | awk -F‘|' '{print
$1,$2}' &amp;&gt; /tmp/example.txt</code> 这些复杂命令，即使使用shell也可能会失败，
解决办法：写到脚本时，copy到远程，执行，再把需要的结果拉回执行命令的机
器
</p>

<p>
范例：将shell模块代替command，设为模块
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#vim /etc/ansible/ansible.cfg
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#19979;&#38754;&#19968;&#34892;
</span><span style="color: #a0522d;">module_name</span> = shell
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7ccc1a8e-47f6-4b5f-9c2b-3f349b6283da" class="outline-4">
<h4 id="h:7ccc1a8e-47f6-4b5f-9c2b-3f349b6283da">Script模块</h4>
<div class="outline-text-4" id="text-h:7ccc1a8e-47f6-4b5f-9c2b-3f349b6283da">
<p>
功能：在远程主机上运行ansible服务器上的脚本(无需执行权限)
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible websrvs -m script -a /data/test.sh
</pre>
</div>
</div>
</div>
<div id="outline-container-h:804c9693-8571-40ad-88b8-81beeba167cc" class="outline-4">
<h4 id="h:804c9693-8571-40ad-88b8-81beeba167cc">Copy模块</h4>
<div class="outline-text-4" id="text-h:804c9693-8571-40ad-88b8-81beeba167cc">
<p>
功能：从ansible服务器主控端复制文件到远程主机
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#30446;&#26631;&#23384;&#22312;&#65292;&#40664;&#35748;&#35206;&#30422;&#65292;&#27492;&#22788;&#25351;&#23450;&#20808;&#22791;&#20221;
</span>ansible websrvs -m copy -a <span style="color: #8b2252;">"src=/root/test1.sh dest=/tmp/test2.sh owner=wang mode=600 backup=yes"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#20869;&#23481;&#65292;&#30452;&#25509;&#29983;&#25104;&#30446;&#26631;&#25991;&#20214;
</span>ansible websrvs -m copy -a <span style="color: #8b2252;">"content='test line1\ntest line2' dest=/tmp/test.txt"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;/etc&#30446;&#24405;&#33258;&#36523;,&#27880;&#24847;/etc/&#21518;&#38754;&#27809;&#26377;/   &#31867;&#20284;&#20110;rsync
</span>ansible websrvs -m copy -a <span style="color: #8b2252;">"src=/etc dest=/backup"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;/etc/&#19979;&#30340;&#25991;&#20214;&#65292;&#19981;&#21253;&#25324;/etc/&#30446;&#24405;&#33258;&#36523;,&#27880;&#24847;/etc/&#21518;&#38754;&#26377;/
</span>ansible websrvs -m copy -a <span style="color: #8b2252;">"src=/etc/ dest=/backup"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:706df931-2107-45c4-9f23-ca2ce81fa5c1" class="outline-4">
<h4 id="h:706df931-2107-45c4-9f23-ca2ce81fa5c1">Fetch模块</h4>
<div class="outline-text-4" id="text-h:706df931-2107-45c4-9f23-ca2ce81fa5c1">
<p>
功能：从远程主机提取文件至ansible的主控端，copy相反，目前不支持目录
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible websrvs -m fetch -a <span style="color: #8b2252;">'src=/root/test.sh dest=/data/scripts'</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#ansible all -m fetch -a <span style="color: #8b2252;">'src=/etc/os-release
dest=/data/os'</span>
[root@ansible ~]#tree /data/os/
/data/
&#9500;&#9472;&#9472; 10.0.0.7
&#9474;   &#9492;&#9472;&#9472; etc
&#9474;       &#9492;&#9472;&#9472; os-release
&#9492;&#9472;&#9472; 10.0.0.8
    &#9492;&#9472;&#9472; etc
        &#9492;&#9472;&#9472; os-release

4 directories, 2 files
</pre>
</div>
</div>
</div>
<div id="outline-container-h:600e3996-6c4d-49be-9adc-6d14233afb0d" class="outline-4">
<h4 id="h:600e3996-6c4d-49be-9adc-6d14233afb0d">File模块</h4>
<div class="outline-text-4" id="text-h:600e3996-6c4d-49be-9adc-6d14233afb0d">
<p>
功能：设置文件属性
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#31354;&#25991;&#20214;
</span>ansible all -m file -a <span style="color: #8b2252;">'path=/data/test.txt state=touch'</span>
ansible all -m file -a <span style="color: #8b2252;">'path=/data/test.txt state=absent'</span>
ansible all -m file -a <span style="color: #8b2252;">"path=/root/test.sh owner=wang mode=755"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#30446;&#24405;
</span>ansible all -m file -a <span style="color: #8b2252;">"path=/data/mysql state=directory owner=mysql
group=mysql"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#36719;&#38142;&#25509;
</span>ansible all -m file -a <span style="color: #8b2252;">'src=/data/testfile dest=/data/testfile-link state=link&#8217;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6aa66dbb-472e-47b6-9a66-6b4e845bd4fe" class="outline-4">
<h4 id="h:6aa66dbb-472e-47b6-9a66-6b4e845bd4fe">unarchive模块</h4>
<div class="outline-text-4" id="text-h:6aa66dbb-472e-47b6-9a66-6b4e845bd4fe">
<p>
功能：解包解压缩
</p>

<p>
实现有两种用法：
</p>
<ol class="org-ol">
<li>将ansible主机上的压缩包传到远程主机后解压缩至特定目录，设置copy=yes</li>
<li>将远程主机上的某个压缩包解压缩到指定路径下，设置copy=no</li>
</ol>

<p>
常见参数：
</p>

<ul class="org-ul">
<li>copy：默认为yes，当copy=yes，拷贝的文件是从ansible主机复制到远程主机
上，如果设置为copy=no，会在远程主机上寻找src源文件</li>
<li>remote_src：和copy功能一样且互斥，yes表示在远程主机，不在ansible主机，
no表示文件在ansible主机上</li>
<li>src：源路径，可以是ansible主机上的路径，也可以是远程主机(被管理端或
者第三方主机)上的路径，如果是远程主机上的路径，则需要设置copy=no</li>
<li>dest：远程主机上的目标路径</li>
<li>mode：设置解压缩后的文件权限</li>
</ul>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;copy&#26102;yes,&#25925;&#30465;&#30053;
</span>ansible all -m unarchive -a <span style="color: #8b2252;">'src=/data/foo.tgz dest=/var/lib/foo owner=wang group=bin'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28304;&#21253;&#19981;&#22312;absible&#20027;&#26426;&#19978;,&#23601;&#35201;&#25226;copy&#35774;&#25104;no
</span>ansible all -m unarchive -a <span style="color: #8b2252;">'src=/tmp/foo.zip dest=/data copy=no mode=0777'</span>
ansible all -m unarchive -a <span style="color: #8b2252;">'src=https://example.com/example.zip dest=/data copy=no'</span>
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#tar Jcvf etc.tar.xz /etc/
[root@ansible ~]#ll -h
-rw-------. 1 root root 1.6K Mar 11 22:26 anaconda-ks.cfg
-rw-r--r--  1 root root 3.8M Jun 20 09:27 etc.tar.xz
[root@ansible ~]#ansible all --list
  hosts (4):
    10.0.0.8
    10.0.0.7
    10.0.0.6
    10.0.0.100
[root@ansible ~]#ansible websrvs --list
  hosts (2):
    10.0.0.8
    10.0.0.7

[root@ansible ~]#ansible websrvs -m unarchive -a <span style="color: #8b2252;">'src=/root/etc.tar.xz dest=/data owner=cui group=bin'</span>
10.0.0.8 | <span style="color: #a0522d;">CHANGED</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/libexec/platform-python"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: true,
    <span style="color: #8b2252;">"dest"</span>: <span style="color: #8b2252;">"/data"</span>,
    <span style="color: #8b2252;">"extract_results"</span>: {
        <span style="color: #8b2252;">"cmd"</span>: [
            <span style="color: #8b2252;">"/usr/bin/gtar"</span>,
            <span style="color: #8b2252;">"--extract"</span>,
            <span style="color: #8b2252;">"-C"</span>,
            <span style="color: #8b2252;">"/data"</span>,
            <span style="color: #8b2252;">"--owner=cui"</span>,
            <span style="color: #8b2252;">"--group=bin"</span>,
            <span style="color: #8b2252;">"-f"</span>,
            <span style="color: #8b2252;">"/root/.ansible/tmp/ansible-tmp-1592616801.5587249-8032-36480135360957/source"</span>
        ],
        <span style="color: #8b2252;">"err"</span>: <span style="color: #8b2252;">""</span>,
        <span style="color: #8b2252;">"out"</span>: <span style="color: #8b2252;">""</span>,
        <span style="color: #8b2252;">"rc"</span>: 0
    },
    <span style="color: #8b2252;">"gid"</span>: 0,
    <span style="color: #8b2252;">"group"</span>: <span style="color: #8b2252;">"root"</span>,
    <span style="color: #8b2252;">"handler"</span>: <span style="color: #8b2252;">"TarArchive"</span>,
    <span style="color: #8b2252;">"mode"</span>: <span style="color: #8b2252;">"0755"</span>,
    <span style="color: #8b2252;">"owner"</span>: <span style="color: #8b2252;">"root"</span>,
    <span style="color: #8b2252;">"size"</span>: 17,
    <span style="color: #8b2252;">"src"</span>: <span style="color: #8b2252;">"/root/.ansible/tmp/ansible-tmp-1592616801.5587249-8032-36480135360957/source"</span>,
    <span style="color: #8b2252;">"state"</span>: <span style="color: #8b2252;">"directory"</span>,
    <span style="color: #8b2252;">"uid"</span>: 0
}
10.0.0.7 | <span style="color: #a0522d;">CHANGED</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/bin/python"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: true,
    <span style="color: #8b2252;">"dest"</span>: <span style="color: #8b2252;">"/data"</span>,
    <span style="color: #8b2252;">"extract_results"</span>: {
        <span style="color: #8b2252;">"cmd"</span>: [
            <span style="color: #8b2252;">"/usr/bin/gtar"</span>,
            <span style="color: #8b2252;">"--extract"</span>,
            <span style="color: #8b2252;">"-C"</span>,
            <span style="color: #8b2252;">"/data"</span>,
            <span style="color: #8b2252;">"--owner=cui"</span>,
            <span style="color: #8b2252;">"--group=bin"</span>,
            <span style="color: #8b2252;">"-f"</span>,
            <span style="color: #8b2252;">"/root/.ansible/tmp/ansible-tmp-1592616801.5619113-8034-100361774048645/source"</span>
        ],
        <span style="color: #8b2252;">"err"</span>: <span style="color: #8b2252;">""</span>,
        <span style="color: #8b2252;">"out"</span>: <span style="color: #8b2252;">""</span>,
        <span style="color: #8b2252;">"rc"</span>: 0
    },
    <span style="color: #8b2252;">"gid"</span>: 0,
    <span style="color: #8b2252;">"group"</span>: <span style="color: #8b2252;">"root"</span>,
    <span style="color: #8b2252;">"handler"</span>: <span style="color: #8b2252;">"TarArchive"</span>,
    <span style="color: #8b2252;">"mode"</span>: <span style="color: #8b2252;">"0755"</span>,
    <span style="color: #8b2252;">"owner"</span>: <span style="color: #8b2252;">"root"</span>,
    <span style="color: #8b2252;">"size"</span>: 17,
    <span style="color: #8b2252;">"src"</span>: <span style="color: #8b2252;">"/root/.ansible/tmp/ansible-tmp-1592616801.5619113-8034-100361774048645/source"</span>,
    <span style="color: #8b2252;">"state"</span>: <span style="color: #8b2252;">"directory"</span>,
    <span style="color: #8b2252;">"uid"</span>: 0
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#26631;&#20027;&#26426;
</span>[root@centos8 ~]#ll /data/
total 12
drwxr-xr-x 134 cui bin 8192 Jun 20 08:48 etc

[root@Centos7 ~]#ll /data/
total 12
drwxr-xr-x 134 cui bin 8192 Jun 20 08:48 etc

[root@ansible ~]#ansible websrvs -a <span style="color: #8b2252;">'rm -rf /data/*'</span>
[WARNING]: Consider using the file module with <span style="color: #a0522d;">state</span>=absent rather than running
<span style="color: #8b2252;">'rm'</span>.  If you need to use command because file is insufficient you can add <span style="color: #8b2252;">'warn:
false'</span> to this command task or set <span style="color: #8b2252;">'command_warnings=False'</span><span style="color: #a020f0;"> in</span> ansible.cfg to get
rid of this message.
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;

10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;

[root@ansible ~]#ansible websrvs -a <span style="color: #8b2252;">'ls /data/*'</span>
10.0.0.7 | FAILED | <span style="color: #a0522d;">rc</span>=2 &gt;&gt;
ls: cannot access /data/*: No such file or directorynon-zero return code
10.0.0.8 | FAILED | <span style="color: #a0522d;">rc</span>=2 &gt;&gt;
ls: cannot access <span style="color: #8b2252;">'/data/*'</span>: No such file or directorynon-zero return code

[root@ansible ~]#ansible websrvs -m copy -a <span style="color: #8b2252;">'src=etc.tar.xz dest=/root/'</span>
[root@ansible ~]#mv etc.tar.xz /opt/
[root@ansible ~]#ansible websrvs -m unarchive -a <span style="color: #8b2252;">'src=/root/etc.tar.xz dest=/data copy=no'</span>

[root@centos8 ~]#ll /data/
total 12
drwxr-xr-x 134 root root 8192 Jun 20 08:48 etc
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cf6723a1-88cb-42c8-b7ab-6098c76d2cb3" class="outline-4">
<h4 id="h:cf6723a1-88cb-42c8-b7ab-6098c76d2cb3">Archive模块</h4>
<div class="outline-text-4" id="text-h:cf6723a1-88cb-42c8-b7ab-6098c76d2cb3">
<p>
功能：打包压缩保存在被管理节点
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible websrvs -m archive -a <span style="color: #8b2252;">'path=/var/log/ dest=/data/log.tar.bz2 format=bz2 owner=wang mode=0600'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ac5aaa58-ca5b-4f82-8a46-105a35e0e580" class="outline-4">
<h4 id="h:ac5aaa58-ca5b-4f82-8a46-105a35e0e580">Hostname模块</h4>
<div class="outline-text-4" id="text-h:ac5aaa58-ca5b-4f82-8a46-105a35e0e580">
<p>
功能：管理主机名,一般是针对一台主机设,对多个主机设不合理
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible node1 -m hostname -a &#8220;<span style="color: #a0522d;">name</span>=websrv&#8221;
ansible 192.168.100.18 -m hostname -a <span style="color: #8b2252;">'name=node18.cici.com'</span>

[root@ansible ~]#ansible 10.0.0.6 -m hostname -a <span style="color: #8b2252;">'name=centos66.cuiqinghe.com'</span>
[root@centos6 ~]#hostname
centos66.cuiqinghe.com
[root@centos6 ~]#cat /etc/sysconfig/network   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#20889;&#21040;&#37197;&#32622;&#25991;&#20214;&#20013;&#20102;
</span><span style="color: #a0522d;">NETWORKING</span>=yes
<span style="color: #a0522d;">HOSTNAME</span>=centos66.cuiqinghe.com

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25193;&#23637;:centos7,centos8,ubuntu&#30340;&#20027;&#26426;&#21517;&#37117;&#25918;&#22312;/etc/hostname&#20013;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b5d8fcf8-e8da-4bf0-8174-f9beb3b1f052" class="outline-4">
<h4 id="h:b5d8fcf8-e8da-4bf0-8174-f9beb3b1f052">Cron模块</h4>
<div class="outline-text-4" id="text-h:b5d8fcf8-e8da-4bf0-8174-f9beb3b1f052">
<p>
功能：计划任务 (分时日月周)
</p>

<p>
支持时间：minute，hour，day，month，weekday
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#25968;&#25454;&#24211;&#33050;&#26412;
</span>[root@centos8 ~]#cat /root/mysql_backup.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash
</span>mysqldump -A -F --single-transaction --master-data=2 -q -uroot |gzip &gt; /data/mysql_<span style="color: #ff00ff;">`date +%F_%T`</span>.sql.gz
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A&#20840;&#37096;&#25968;&#25454;&#24211;&#22791;&#20221;  -F&#21047;&#26032;&#26085;&#24535;  --single-transaction&#21551;&#29992;&#20107;&#21153;  --master-data=2 &#35760;&#24405;&#22791;&#20221;&#28857;   -q&#24555;&#36895;&#22791;&#20221;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#20219;&#21153;
</span>ansible 10.0.0.8 -m cron -a <span style="color: #8b2252;">'hour=2 minute=30 weekday=1-5 name="backup mysql" job=/root/mysql_backup.sh'</span>
ansible websrvs -m cron -a <span style="color: #8b2252;">"minute=*/5 job='/usr/sbin/ntpdate ntp.aliyun.com
&amp;&gt;/dev/null' name=Synctime"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36991;&#20813;&#20135;&#29983;&#22823;&#37327;&#22403;&#22334;&#25991;&#20214;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">ntpdate ntp.aliyun.com &#21629;&#20196;&#21482;&#26377;centos7&#21644;&#20043;&#21069;&#30340;&#29256;&#26412;&#26377;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#29992;&#35745;&#21010;&#20219;&#21153;
</span>ansible websrvs -m cron -a <span style="color: #8b2252;">"minute=*/5 job='/usr/sbin/ntpdate ntp.aliyun.com
&amp;&gt;/dev/null' name=Synctime disabled=yes"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#35745;&#21010;&#20219;&#21153;
</span>ansible websrvs -m cron -a <span style="color: #8b2252;">"minute=*/5 job='/usr/sbin/ntpdate ntp.aliyun.com
&amp;&gt;/dev/null' name=Synctime disabled=no"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#20219;&#21153;
</span>ansible websrvs -m cron -a <span style="color: #8b2252;">"name='backup mysql' state=absent"</span>
ansible websrvs -m cron -a <span style="color: #8b2252;">'state=absent name=Synctime'</span>
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#cat mysql_backup.sh 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash
</span>mysqldump -A -F --single-transaction --master-data=2 -q -uroot |gzip &gt; /data/mysql_<span style="color: #ff00ff;">`date +%F_%T`</span>.sql.gz
[root@ansible ~]#chmod +x mysql_backup.sh
[root@ansible ~]#ansible websrvs -m copy -a <span style="color: #8b2252;">'src=/root/mysql_backup.sh dest=/opt/'</span>

[root@ansible ~]#ansible websrvs -a <span style="color: #8b2252;">'ls -l /opt/'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
total 4
-rw-r--r-- 1 root root 541 Jun 20 10:12 mysql_backup.sh
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
total 4
-rw-r--r-- 1 root root 541 Jun 20 10:12 mysql_backup.sh

[root@ansible ~]#ansible websrvs -m cron -a <span style="color: #8b2252;">'hour=2 minute=30 weekday=1-5 name="backup mysql" job=/opt/mysql_backup.sh'</span>
[root@ansible ~]#ansible websrvs -a <span style="color: #8b2252;">'crontab -l'</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
<span style="color: #b22222;">#</span><span style="color: #b22222;">Ansible: backup mysql
</span>30 2 * * 1-5 /opt/mysql_backup.sh
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
<span style="color: #b22222;">#</span><span style="color: #b22222;">Ansible: backup mysql
</span>30 2 * * 1-5 /opt/mysql_backup.sh

[root@Centos7 ~]#cat /var/spool/cron/root 
<span style="color: #b22222;">#</span><span style="color: #b22222;">Ansible: backup mysql
</span>30 2 * * 1-5 /opt/mysql_backup.sh
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9d2752cf-dcdc-48b2-9386-ce7f4b079e14" class="outline-4">
<h4 id="h:9d2752cf-dcdc-48b2-9386-ce7f4b079e14">Yum 模块 Apt 模块</h4>
<div class="outline-text-4" id="text-h:9d2752cf-dcdc-48b2-9386-ce7f4b079e14">
<p>
yum 管理软件包，只支持RHEL，CentOS，fedora，不支持Ubuntu其它版本
</p>

<p>
apt 模块管理 Debian 相关版本的软件包
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible websrvs -m yum -a <span style="color: #8b2252;">'name=httpd state=present'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;
</span>ansible websrvs -m yum -a <span style="color: #8b2252;">'name=httpd state=absent'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;
</span>
[root@ansible ~]#ansible websrvs -m yum -a <span style="color: #8b2252;">'name=iotop,cowsay'</span>
[root@ansible ~]#ansible websrvs -a <span style="color: #8b2252;">'rpm -q iotop cowsay'</span>
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ansible 10.0.0.100 -m apt -a <span style="color: #8b2252;">'name=bb,sl,cowsay,cmatrix,oneko,hollywood,boxes,libaa-bin,x11-apps'</span>
[root@centos8 ~]#ansible websrvs -m apt -a <span style="color: #8b2252;">'name=rsync,psmisc state=absent'</span>
</pre>
</div>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh">- name: Install basic software
  yum:
    state: installed
    update_cache: yes
    name:
      - <span style="color: #8b2252;">"vim"</span>
      - <span style="color: #8b2252;">"man"</span>
      - <span style="color: #8b2252;">"wget"</span>
      - <span style="color: #8b2252;">"tree"</span>
      - <span style="color: #8b2252;">"sysstat"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a5947938-fdf5-4aac-b0c6-d0d1e1b6427a" class="outline-4">
<h4 id="h:a5947938-fdf5-4aac-b0c6-d0d1e1b6427a">Package模块</h4>
<div class="outline-text-4" id="text-h:a5947938-fdf5-4aac-b0c6-d0d1e1b6427a">
<div class="org-src-container">
<pre class="src src-yaml">- name: install chronyd 
  package:
    name: chrony
    state: latest
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e624bb8f-5da4-4997-8b22-f18f4d7f1d0f" class="outline-4">
<h4 id="h:e624bb8f-5da4-4997-8b22-f18f4d7f1d0f">Service模块</h4>
<div class="outline-text-4" id="text-h:e624bb8f-5da4-4997-8b22-f18f4d7f1d0f">
<p>
功能：管理服务
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#20026;&#24320;&#26426;&#21551;&#21160;
</span>ansible all -m service -a <span style="color: #8b2252;">'name=httpd state=started enabled=yes'</span> 
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#29366;&#24577;
</span>ansible websrvs  -a <span style="color: #8b2252;">'systemctl is-enabled httpd'</span>

ansible all -m service -a <span style="color: #8b2252;">'name=httpd state=stopped'</span>
ansible all -m service -a <span style="color: #8b2252;">'name=httpd state=reloaded'</span>
ansible all -m service -a <span style="color: #8b2252;">'name=httpd state=restarted'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#31471;&#21475;
</span>ansible all -m shell -a <span style="color: #8b2252;">"sed -i 's/^Listen 80/Listen 8080/' /etc/httpd/conf/httpd.conf"</span>
[root@ansible ~]#ansible websrvs -a <span style="color: #8b2252;">"grep Listen /etc/httpd/conf/httpd.conf"</span>
10.0.0.7 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
<span style="color: #b22222;"># </span><span style="color: #b22222;">Listen: Allows you to bind Apache to specific IP addresses and/or
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">Change this to Listen on specific IP addresses as shown below to 
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">Listen 12.34.56.78:80
</span>Listen 8080
10.0.0.8 | CHANGED | <span style="color: #a0522d;">rc</span>=0 &gt;&gt;
<span style="color: #b22222;"># </span><span style="color: #b22222;">Listen: Allows you to bind Apache to specific IP addresses and/or
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">Change this to Listen on specific IP addresses as shown below to 
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">Listen 12.34.56.78:80
</span>Listen 8080
</pre>
</div>
</div>
</div>
<div id="outline-container-h:64477c11-2ec5-404e-b9cb-b954b44cdc51" class="outline-4">
<h4 id="h:64477c11-2ec5-404e-b9cb-b954b44cdc51">User模块</h4>
<div class="outline-text-4" id="text-h:64477c11-2ec5-404e-b9cb-b954b44cdc51">
<p>
功能：管理用户
</p>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#29992;&#25143;
</span>ansible all -m user -a <span style="color: #8b2252;">'name=user1 comment="test user" uid=2048 home=/app/user1 group=root'</span>

ansible all -m user -a <span style="color: #8b2252;">'name=nginx comment=nginx uid=88 group=nginx
groups="root,daemon" shell=/sbin/nologin system=yes create_home=no
home=/data/nginx non_unique=yes'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">remove=yes&#34920;&#31034;&#21024;&#38500;&#29992;&#25143;&#21450;&#23478;&#30446;&#24405;&#31561;&#25968;&#25454;,&#40664;&#35748;remove=no
</span>ansible all -m user -a <span style="color: #8b2252;">'name=nginx state=absent remove=yes'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:78a08001-e7e2-4e38-9f29-c939e7545cdc" class="outline-4">
<h4 id="h:78a08001-e7e2-4e38-9f29-c939e7545cdc">Group模块</h4>
<div class="outline-text-4" id="text-h:78a08001-e7e2-4e38-9f29-c939e7545cdc">
<p>
功能：管理组
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#32452;
</span>ansible websrvs -m group -a <span style="color: #8b2252;">'name=nginx gid=88 system=yes'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#32452;
</span>ansible websrvs -m group -a <span style="color: #8b2252;">'name=nginx state=absent'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:34495623-4c73-4d50-a762-4b70beaebac3" class="outline-4">
<h4 id="h:34495623-4c73-4d50-a762-4b70beaebac3">Lineinfile模块</h4>
<div class="outline-text-4" id="text-h:34495623-4c73-4d50-a762-4b70beaebac3">
<p>
ansible在使用sed进行替换时，经常会遇到需要转义的问题，而且ansible在遇
到特殊符号进行替换时，存在问题，无法正常进行替换。其实在ansible自身提
供了两个模块：lineinfile模块和replace模块，可以方便的进行替换
</p>

<p>
一般在ansible当中去修改某个文件的单行进行替换的时候需要使用lineinfile模块
</p>

<p>
regexp参数 ：使用正则表达式匹配对应的行，当替换文本时，如果有多行文本
都能被匹配，则只有最后面被匹配到的那行文本才会被替换，当删除文本时，如
果有多行文本都能被匹配，这么这些行都会被删除。
</p>

<p>
如果想进行多行匹配进行替换需要使用replace模块
</p>

<p>
功能：相当于sed，可以修改文件内容,若需要修改的行数较多,就用copy模块
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible websrvs -m lineinfile -a <span style="color: #8b2252;">"path=/etc/httpd/conf/httpd.conf
regexp='^Listen' line='Listen 80'"</span>

ansible all -m lineinfile -a <span style="color: #8b2252;">"path=/etc/selinux/config regexp='^SELINUX=' line='SELINUX=disabled'"</span>

ansible all -m lineinfile -a <span style="color: #8b2252;">'dest=/etc/fstab state=absent regexp="^#"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c5687051-26a7-4773-979d-9e7ebd63f2bc" class="outline-4">
<h4 id="h:c5687051-26a7-4773-979d-9e7ebd63f2bc">Replace模块</h4>
<div class="outline-text-4" id="text-h:c5687051-26a7-4773-979d-9e7ebd63f2bc">
<p>
该模块有点类似于sed命令，主要也是基于正则进行匹配和替换，建议使用
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible all -m replace -a <span style="color: #8b2252;">"path=/etc/fstab regexp='^(UUID.*)' replace='#\1'"</span>
ansible all -m replace -a <span style="color: #8b2252;">"path=/etc/fstab regexp='^#(.*)' replace='\1'"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5f76e222-0523-4bfa-9320-c8bc766f486d" class="outline-4">
<h4 id="h:5f76e222-0523-4bfa-9320-c8bc766f486d">Setup模块</h4>
<div class="outline-text-4" id="text-h:5f76e222-0523-4bfa-9320-c8bc766f486d">
<p>
功能： setup 模块来收集主机的系统信息，这些 facts
信息可以直接以变量的形式使用，但是如果主机较多，会影响执行速度，可以使用
gather_facts: no 来禁止 Ansible 收集 facts 信息
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible all -m setup
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_nodename"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_hostname"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_domain"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_memtotal_mb"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_memory_mb"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_memfree_mb"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_os_family"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_distribution_major_version"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_distribution_version"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_processor_vcpus"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_all_ipv4_addresses"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_architecture"</span>
ansible all -m setup -a <span style="color: #8b2252;">"filter=ansible_processor*"</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#ansible all -m setup -a <span style="color: #8b2252;">'filter=ansible_python_version'</span> 
10.0.0.7 | <span style="color: #a0522d;">SUCCESS</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"ansible_python_version"</span>: <span style="color: #8b2252;">"2.7.5"</span>,
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/bin/python"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: false
}
10.0.0.6 | <span style="color: #a0522d;">SUCCESS</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"ansible_python_version"</span>: <span style="color: #8b2252;">"2.6.6"</span>,
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/bin/python"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: false
}
10.0.0.8 | <span style="color: #a0522d;">SUCCESS</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"ansible_python_version"</span>: <span style="color: #8b2252;">"3.6.8"</span>,
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/libexec/platform-python"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: false
}
10.0.0.100 | <span style="color: #a0522d;">SUCCESS</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"ansible_python_version"</span>: <span style="color: #8b2252;">"3.6.9"</span>,
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/bin/python3"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: false
}
</pre>
</div>

<p>
范例：取IP地址
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#25152;&#26377;IP
</span>ansible 10.0.0.100 -m setup -a <span style="color: #8b2252;">'filter=ansible_all_ipv4_addresses'</span>
10.0.0.100 | <span style="color: #a0522d;">SUCCESS</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"ansible_all_ipv4_addresses"</span>: [
            <span style="color: #8b2252;">"10.0.0.100"</span>
        ],
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/bin/python3"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: false
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#40664;&#35748;IP
</span>[root@ansible ~]#ansible 10.0.0.8 -m setup -a <span style="color: #8b2252;">'filter="ansible_default_ipv4"'</span>
10.0.0.8 | <span style="color: #a0522d;">SUCCESS</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"ansible_default_ipv4"</span>: {
            <span style="color: #8b2252;">"address"</span>: <span style="color: #8b2252;">"10.0.0.8"</span>,
            <span style="color: #8b2252;">"alias"</span>: <span style="color: #8b2252;">"eth0"</span>,
            <span style="color: #8b2252;">"broadcast"</span>: <span style="color: #8b2252;">"10.0.0.255"</span>,
            <span style="color: #8b2252;">"gateway"</span>: <span style="color: #8b2252;">"10.0.0.2"</span>,
            <span style="color: #8b2252;">"interface"</span>: <span style="color: #8b2252;">"eth0"</span>,
            <span style="color: #8b2252;">"macaddress"</span>: <span style="color: #8b2252;">"00:0c:29:30:80:0a"</span>,
            <span style="color: #8b2252;">"mtu"</span>: 1500,
            <span style="color: #8b2252;">"netmask"</span>: <span style="color: #8b2252;">"255.255.255.0"</span>,
            <span style="color: #8b2252;">"network"</span>: <span style="color: #8b2252;">"10.0.0.0"</span>,
            <span style="color: #8b2252;">"type"</span>: <span style="color: #8b2252;">"ether"</span>
        },
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/libexec/platform-python"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: false
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:40d14931-5787-4c91-9c34-ab669223c49f" class="outline-4">
<h4 id="h:40d14931-5787-4c91-9c34-ab669223c49f">set_fact模块</h4>
<div class="outline-text-4" id="text-h:40d14931-5787-4c91-9c34-ab669223c49f">
<p>
设置变量
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- name: map hostname var
  set_fact:
    hostname: "{{ inventory_hostname }}"
  when: hostname is not defined
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d5483b20-4a08-4c56-9649-e0b44c956110" class="outline-4">
<h4 id="h:d5483b20-4a08-4c56-9649-e0b44c956110">selinux模块</h4>
<div class="outline-text-4" id="text-h:d5483b20-4a08-4c56-9649-e0b44c956110">
<div class="org-src-container">
<pre class="src src-yaml">- name: disable_selinux
  selinux: state=disabled
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0d44d365-59a3-45a0-bbec-ee235715e04c" class="outline-4">
<h4 id="h:0d44d365-59a3-45a0-bbec-ee235715e04c">debug模块</h4>
<div class="outline-text-4" id="text-h:0d44d365-59a3-45a0-bbec-ee235715e04c">
<div class="org-src-container">
<pre class="src src-yaml">- name: print data_disk_exist
  debug:
    msg: "{{data_disk_exist}}"
</pre>
</div>
</div>
</div>
<div id="outline-container-h:70380e05-19df-4a86-ba91-e2f8c5aec6ef" class="outline-4">
<h4 id="h:70380e05-19df-4a86-ba91-e2f8c5aec6ef">filesystem模块</h4>
<div class="outline-text-4" id="text-h:70380e05-19df-4a86-ba91-e2f8c5aec6ef">
<p>
格式化磁盘
</p>

<pre class="example" id="org2f39eb9">
- name: format disk
  filesystem:
    fstype: ext4
    dev: '{{ data_disk }}'
  when: data_disk_exist.stdout is match ("{{ data_disk }}:\ data")
</pre>
</div>
</div>
<div id="outline-container-h:2201d13a-1aec-49aa-8e31-9f3bcbe3aefc" class="outline-4">
<h4 id="h:2201d13a-1aec-49aa-8e31-9f3bcbe3aefc">mount模块</h4>
<div class="outline-text-4" id="text-h:2201d13a-1aec-49aa-8e31-9f3bcbe3aefc">
<div class="org-src-container">
<pre class="src src-yaml">- name: mount data disk
  mount:
    name: '/data'
    src: '{{ data_disk }}'
    fstype: ext4
    state: mounted
  when: data_disk_exist.stdout is  match ("{{ data_disk }}:\ data")
</pre>
</div>
</div>
</div>
<div id="outline-container-h:24e119bc-a6d8-4cab-b2a8-cae8ef05e8a3" class="outline-4">
<h4 id="h:24e119bc-a6d8-4cab-b2a8-cae8ef05e8a3">authorized_key模块</h4>
<div class="outline-text-4" id="text-h:24e119bc-a6d8-4cab-b2a8-cae8ef05e8a3">
<div class="org-src-container">
<pre class="src src-yaml">- name: add tower key to root
  authorized_key:
    key: 'ssh-rsa AAAAB3NzaC1yc2ES1xX root@tower-1.ops.bj.tx.lan'
    user: root
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1d7220f3-a61c-4ae4-b2a0-52304622ec42" class="outline-4">
<h4 id="h:1d7220f3-a61c-4ae4-b2a0-52304622ec42">systemd模块</h4>
<div class="outline-text-4" id="text-h:1d7220f3-a61c-4ae4-b2a0-52304622ec42">
<div class="org-src-container">
<pre class="src src-yaml">- name: restart rsyslog
  systemd:
    name: rsyslog
    state: restarted
    enabled: true
</pre>
</div>
</div>
</div>
<div id="outline-container-h:82131cdc-b8cb-4223-a7d0-1ec555c7214e" class="outline-4">
<h4 id="h:82131cdc-b8cb-4223-a7d0-1ec555c7214e">lineinfile模块</h4>
<div class="outline-text-4" id="text-h:82131cdc-b8cb-4223-a7d0-1ec555c7214e">
<div class="org-src-container">
<pre class="src src-yaml">- name: change PASS_MAX_DAYS for login.defs
  lineinfile:
     dest: /etc/login.defs
     regexp: '^PASS_MAX_DAYS   99999' 
     line: 'PASS_MAX_DAYS   90'

- name: change login 
  lineinfile:
     dest: /etc/pam.d/login
     state: present
     insertafter: '^auth       include'
     line: '{{ item }}'
  with_items:
  - "auth       required     pam_tally.so onerr=fail no_magic_root"
  - "account    required     pam_tally.so deny=3 no_magic_root reset"
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ba12198f-b8bf-4a96-9682-539c97c33fd5" class="outline-4">
<h4 id="h:ba12198f-b8bf-4a96-9682-539c97c33fd5">synchronize模块</h4>
<div class="outline-text-4" id="text-h:ba12198f-b8bf-4a96-9682-539c97c33fd5">
<p>
同步文件
</p>

<pre class="example" id="org519ff2a">
- name: apply securetty
  synchronize:
    src: securetty  # files目录取文件
    dest: /etc/securetty
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:82957dba-6f58-4cdf-ae1a-12db3ee0ccca" class="outline-2">
<h2 id="h:82957dba-6f58-4cdf-ae1a-12db3ee0ccca">Playbook</h2>
<div class="outline-text-2" id="text-h:82957dba-6f58-4cdf-ae1a-12db3ee0ccca">
</div>
<div id="outline-container-h:12279fce-9cf9-4abf-9def-1b804ca5a2c0" class="outline-3">
<h3 id="h:12279fce-9cf9-4abf-9def-1b804ca5a2c0">playbook介绍</h3>
<div class="outline-text-3" id="text-h:12279fce-9cf9-4abf-9def-1b804ca5a2c0">

<figure id="orge658c5b">
<img src="https://img-blog.csdnimg.cn/20200705204200540.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjIzODc1NQ==,size_16,color_FFFFFF,t_70" alt="watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NjIzODc1NQ==,size_16,color_FFFFFF,t_70">

</figure>

<ul class="org-ul">
<li>playbook 剧本是由一个或多个”play”组成的列表</li>
<li>play的主要功能在于将预定义的一组主机，装扮成事先通过ansible中的task
定义好的角色。Task实际是调用ansible的一个module，将多个play组织在一
个playbook中，即可以让它们联合起来，按事先编排的机制执行预定义的动作</li>

<li>Playbook 文件是采用YAML语言编写的</li>
</ul>
</div>
</div>
<div id="outline-container-h:6e33e4b5-fad2-4b45-863c-b7c76bfca760" class="outline-3">
<h3 id="h:6e33e4b5-fad2-4b45-863c-b7c76bfca760">YAML 语言</h3>
<div class="outline-text-3" id="text-h:6e33e4b5-fad2-4b45-863c-b7c76bfca760">
</div>
<div id="outline-container-h:8274922d-ed3b-469a-a601-f3e4d23d7de5" class="outline-4">
<h4 id="h:8274922d-ed3b-469a-a601-f3e4d23d7de5">YAMl 语言介绍</h4>
<div class="outline-text-4" id="text-h:8274922d-ed3b-469a-a601-f3e4d23d7de5">
<p>
YAML：YAML Ain't Markup Language，即YAML不是XML。不过，在开发的这种语
言时，YAML的意思其实是："Yet Another Markup Language"（仍是一种标记语
言）
</p>

<p>
YAML是一个可读性高的用来表达资料序列的格式。YAML参考了其他多种语言，包
括：XML、C语言、Python、Perl以及电子邮件格式RFC2822等。Clark Evans在
2001年在首次发表了这种语言，另外Ingy döt Net与Oren Ben-Kiki也是这语言
的共同设计者,目前很多软件中采有此格式的文件，如:ubuntu，anisble，
docker，k8s等
</p>

<p>
YAML 官方网站：<a href="http://www.yaml.org">http://www.yaml.org</a>
</p>
</div>
</div>
<div id="outline-container-h:665fd638-df24-49d6-b680-9b02125db467" class="outline-4">
<h4 id="h:665fd638-df24-49d6-b680-9b02125db467">YAML 语言特性</h4>
<div class="outline-text-4" id="text-h:665fd638-df24-49d6-b680-9b02125db467">
<ul class="org-ul">
<li>YAML的可读性好</li>
<li>YAML和脚本语言的交互性好</li>
<li>YAML使用实现语言的数据类型</li>
<li>YAML有一个一致的信息模型</li>
<li>YAML易于实现</li>
<li>YAML可以基于流来处理</li>
<li>YAML表达能力强，扩展性好</li>
</ul>
</div>
</div>
<div id="outline-container-h:bbf71988-e55d-4e8d-a371-223045f7b39c" class="outline-4">
<h4 id="h:bbf71988-e55d-4e8d-a371-223045f7b39c">YAML语法简介</h4>
<div class="outline-text-4" id="text-h:bbf71988-e55d-4e8d-a371-223045f7b39c">
<ul class="org-ul">
<li>在单一文件第一行，用连续三个连字号”-” 开始，还有选择性的连续三个点
号( &#x2026; )用来表示文件的结尾</li>
<li>次行开始正常写Playbook的内容，一般建议写明该Playbook的功能</li>
<li>使用#号注释代码</li>
<li>缩进必须是统一的，不能空格和tab混用</li>
<li>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行来实现的</li>
<li>YAML文件内容是区别大小写的，key/value的值均需大小写敏感</li>
<li>多个key/value可同行写也可换行写，同行使用，分隔</li>
<li>v可是个字符串，也可是另一个列表</li>
<li>YAML文件扩展名通常为yml或yaml</li>
</ul>

<p>
YAML的语法和其他高阶语言类似，并且可以简单表达清单、散列表、标量等数据
结构。其结构（Structure）通过空格来展示，序列（Sequence）里的项用”-"
来代表，Map里的键值对用":“分隔，下面介绍常见的数据结构。
</p>
</div>
</div>
<div id="outline-container-h:ba76bc61-0292-4c5b-a0f9-f45a3fdc0a0e" class="outline-4">
<h4 id="h:ba76bc61-0292-4c5b-a0f9-f45a3fdc0a0e">支持的数据类型</h4>
<div class="outline-text-4" id="text-h:ba76bc61-0292-4c5b-a0f9-f45a3fdc0a0e">
<p>
YAML 支持以下常用几种数据类型：
</p>
<ul class="org-ul">
<li>标量：单个的、不可再分的值</li>
<li>对象：键值对的集合，又称为映射（mapping）/ 哈希（hashes） / 字典（dictionary）</li>
<li>数组：一组按次序排列的值，又称为序列（sequence） / 列表（list）</li>
</ul>
</div>
<div id="outline-container-h:5bb9f758-9760-4222-8cfc-12b44283542b" class="outline-5">
<h5 id="h:5bb9f758-9760-4222-8cfc-12b44283542b">scalar 标量</h5>
<div class="outline-text-5" id="text-h:5bb9f758-9760-4222-8cfc-12b44283542b">
<p>
key对应value
</p>
<pre class="example" id="org1894369">
name: jasper
</pre>

<p>
使用缩进的方式
</p>
<pre class="example" id="orgd714658">
name:
  jasper
</pre>

<p>
标量是最基本的，不可再分的值，包括：
</p>
<ul class="org-ul">
<li>字符串</li>
<li>布尔值</li>
<li>整数</li>
<li>浮点数</li>
<li>Null</li>
<li>时间</li>
<li>日期</li>
</ul>
</div>
</div>
<div id="outline-container-h:f9cfd730-a4bf-4caf-af26-999c9138e099" class="outline-5">
<h5 id="h:f9cfd730-a4bf-4caf-af26-999c9138e099">Dictionary字典</h5>
<div class="outline-text-5" id="text-h:f9cfd730-a4bf-4caf-af26-999c9138e099">
<p>
字典由多个key与value构成，key和value之间用 ：分隔, 并且 :后面有一个空
格，所有k/v可以放在一行，或者每个 k/v 分别放在不同行
</p>

<p>
格式
</p>
<pre class="example" id="org104d455">
account: { name: wang, age: 30 }
</pre>

<p>
使用缩进方式
</p>
<pre class="example" id="org28f14e5">
account:
  name: wang
  age: 30
</pre>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#21516;&#34892;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">An employee record
</span>name: Example Developer
job: Developer
skill: Elite

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#19968;&#34892;,&#20063;&#21487;&#20197;&#23558;key:value&#25918;&#32622;&#20110;{}&#20013;&#36827;&#34892;&#34920;&#31034;&#65292;&#29992;,&#20998;&#38548;&#22810;&#20010;key:value
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">An employee record
</span>{name: <span style="color: #8b2252;">"Example Developer"</span>, job: <span style="color: #8b2252;">"Developer"</span>, skill: <span style="color: #8b2252;">"Elite"</span>}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6a315d07-eae9-4ab7-89fe-5acbd12b6ca5" class="outline-5">
<h5 id="h:6a315d07-eae9-4ab7-89fe-5acbd12b6ca5">List列表</h5>
<div class="outline-text-5" id="text-h:6a315d07-eae9-4ab7-89fe-5acbd12b6ca5">
<pre class="example" id="orgc47dd75">
列表由多个元素组成，每个元素放在不同行，且元素前均使用”-“打头，并且
-后有一个空格, 或者将所有元素用 [ ] 括起来放在同一行
</pre>

<p>
格式：
</p>
<pre class="example" id="orgcbea8c9">
course:
  - linux
  - golang
  - python
</pre>

<p>
也可以使用
</p>
<pre class="example" id="orge8eda66">
course: [ linux , golang , python ]
</pre>

<p>
数据里面也可以包含对象
</p>
<pre class="example" id="org19ae614">
course:
  - linux: manjaro
  - golang: gin
  - python: django
</pre>


<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#21516;&#34892;,&#34892;&#20197;-&#24320;&#22836;,&#21518;&#38754;&#26377;&#19968;&#20010;&#31354;&#26684;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">A list of tasty fruits
</span>- Apple
- Orange
- Strawberry
- Mango

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#19968;&#34892;
</span>[Apple,Orange,Strawberry,Mango]
</pre>
</div>

<p>
范例：YAML 表示一个家庭
</p>
<pre class="example" id="orge75ad34">
name: John Smith
age: 41
gender: Male
spouse:
  name: Jane Smith
  age: 37
  gender: Female
children:
  - name: Jimmy Smith
    age: 17
    gender: Male
  - {name: Jenny Smith, age: 13, gender: Female}
  - {name: hao Smith, age: 20, gender: Male }
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2de59182-2b01-4c4a-a518-816df9550dd2" class="outline-4">
<h4 id="h:2de59182-2b01-4c4a-a518-816df9550dd2">三种常见的数据格式</h4>
<div class="outline-text-4" id="text-h:2de59182-2b01-4c4a-a518-816df9550dd2">
<ul class="org-ul">
<li>XML：Extensible Markup Language，可扩展标记语言，可用于数据交换和配置</li>
<li>JSON：JavaScript Object Notation, JavaScript
对象表记法， <b>主要用来数据交换传输或配置</b> ，不支持注释</li>
<li>YAML：YAML Ain't Markup Language YAML 不是一种标记语言，
主要用来配置，大小写敏感，不支持tab</li>
</ul>


<figure id="org832ccd0">
<img src="./images/img_20240228_153213.png" alt="img_20240228_153213.png" width="80%">

</figure>


<p>
<b>可以用工具互相转换，参考网站</b> ：
</p>

<p>
<a href="https://www.json2yaml.com/">https://www.json2yaml.com/</a>
</p>

<p>
<a href="http://www.bejson.com/json/json2yaml/">http://www.bejson.com/json/json2yaml/</a>
</p>
</div>
</div>
</div>
<div id="outline-container-h:1ef2a223-efdb-4182-9c42-5ae32bac6e9d" class="outline-3">
<h3 id="h:1ef2a223-efdb-4182-9c42-5ae32bac6e9d">Playbook 核心组件</h3>
<div class="outline-text-3" id="text-h:1ef2a223-efdb-4182-9c42-5ae32bac6e9d">
<p>
一个playbook 中由列表组成,其中所用到的常见组件类型如下:
</p>

<ul class="org-ul">
<li>Hosts 执行的远程主机列表</li>
<li>Tasks 任务集,由多个task的元素组成的列表实现,每个task是一个字典</li>
<li>Variables 内置变量或自定义变量在playbook中调用</li>
<li>Templates 模板，可替换模板文件中的变量并实现一些简单逻辑的文件</li>
<li>Handlers 和 notify结合使用，由特定条件触发的操作， <b>满足条件方才执
行</b> ，否则不执行</li>
<li>tags 标签: 指定某条任务执行，用于选择运行playbook中的部分代码。ansible
具有幂等性，因此会自动跳过没有变化的部分，即便如此，有些代码为测试其
确实没有发生变化的时间依然会非常地长。此时，如果确信其没有变化，就可
以通过tags跳过此些代码片断</li>
<li>一个完整的代码块功能需最少元素需包括 name 和
task,一个name只能包括一个task</li>
</ul>
</div>
<div id="outline-container-h:a47c2523-e7f0-4aff-9af9-16adafba5398" class="outline-4">
<h4 id="h:a47c2523-e7f0-4aff-9af9-16adafba5398">hosts 组件</h4>
<div class="outline-text-4" id="text-h:a47c2523-e7f0-4aff-9af9-16adafba5398">
<p>
Hosts：playbook中的每一个play的目的都是为了让特定主机以某个指定的用户身份执行任务。hosts用于指定要执行指定任务的主机，须事先定义在主机清单中
</p>

<div class="org-src-container">
<pre class="src src-sh">one.example.com
one.example.com:two.example.com
192.168.1.50
192.168.1.*
Websrvs:dbsrvs         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#65292;&#20004;&#20010;&#32452;&#30340;&#24182;&#38598;
</span>Websrvs:&amp;dbsrvs     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19982;&#65292;&#20004;&#20010;&#32452;&#30340;&#20132;&#38598;
</span>webservers:!phoenix <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;websrvs&#32452;&#65292;&#20294;&#19981;&#22312;dbsrvs&#32452;</span>
</pre>
</div>

<p>
案例：
</p>

<div class="org-src-container">
<pre class="src src-sh">- hosts: websrvs:appsrvs      hosts&#20803;&#32032;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bbc2ad3c-a0b1-446c-a56a-d64472538a1d" class="outline-4">
<h4 id="h:bbc2ad3c-a0b1-446c-a56a-d64472538a1d">remote_user 组件</h4>
<div class="outline-text-4" id="text-h:bbc2ad3c-a0b1-446c-a56a-d64472538a1d">
<p>
remote_user:
可用于Host和task中。也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务；此外，甚至可以在sudo时使用sudo_user指定sudo时切换的用户
</p>

<div class="org-src-container">
<pre class="src src-sh">- hosts: websrvs
  remote_user: root     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38190;&#20540;&#23545;
</span>
  tasks:
    - name: test connection
      ping:
      remote_user: cici
      sudo: yes             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;sudo&#20026;root
</span>      sudo_user:wang         <span style="color: #b22222;">#</span><span style="color: #b22222;">sudo&#20026;wang</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d9248277-dadd-496d-9bd6-a0c203e2f6ad" class="outline-4">
<h4 id="h:d9248277-dadd-496d-9bd6-a0c203e2f6ad">task列表和action组件</h4>
<div class="outline-text-4" id="text-h:d9248277-dadd-496d-9bd6-a0c203e2f6ad">
<p>
play的主体部分是task list，task list中有一个或多个task,各个task按次序
逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个task后，再
开始第二个task
</p>

<p>
task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。模块执
行是幂等的，这意味着多次执行是安全的，因为其结果均一致
</p>

<p>
每个task都应该有其name，用于playbook的执行结果输出，建议其内容能清晰地
描述任务执行步骤。如果未提供name，则action的结果将用于输出
</p>

<p>
<b>task两种格式</b> ：
</p>

<div class="org-src-container">
<pre class="src src-sh">action: module arguments
module: arguments &#24314;&#35758;&#20351;&#29992;
</pre>
</div>

<p>
注意：shell和command模块后面跟命令，而非key=value
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: install httpd
      yum: <span style="color: #a0522d;">name</span>=httpd
    - name: start httpd
      service: <span style="color: #a0522d;">name</span>=httpd <span style="color: #a0522d;">state</span>=started <span style="color: #a0522d;">enabled</span>=yes
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2fbe5631-b9c5-4f43-af46-3f50b4a7ee4b" class="outline-4">
<h4 id="h:2fbe5631-b9c5-4f43-af46-3f50b4a7ee4b">其它组件</h4>
<div class="outline-text-4" id="text-h:2fbe5631-b9c5-4f43-af46-3f50b4a7ee4b">
<p>
某任务的状态在运行后为changed时，可通过”notify”通知给相应的handlers
</p>

<p>
任务可以通过”tags”打标签，可在ansible-playbook命令上使用-t指定进行调用
</p>
</div>
</div>
<div id="outline-container-h:1f8b94d9-f2bb-4821-9d8a-35e5a61034c8" class="outline-4">
<h4 id="h:1f8b94d9-f2bb-4821-9d8a-35e5a61034c8">ShellScripts VS Playbook 案例</h4>
<div class="outline-text-4" id="text-h:1f8b94d9-f2bb-4821-9d8a-35e5a61034c8">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">SHELL&#33050;&#26412;&#23454;&#29616;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;Apache
</span>yum install --quiet -y httpd
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22797;&#21046;&#37197;&#32622;&#25991;&#20214;
</span>cp /tmp/httpd.conf /etc/httpd/conf/httpd.conf
cp/tmp/vhosts.conf /etc/httpd/conf.d/
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160;Apache&#65292;&#24182;&#35774;&#32622;&#24320;&#26426;&#21551;&#21160;
</span>systemctl enable --now httpd

<span style="color: #b22222;">#</span><span style="color: #b22222;">Playbook&#23454;&#29616;
</span>---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: <span style="color: #8b2252;">"&#23433;&#35013;Apache"</span>
      yum: <span style="color: #a0522d;">name</span>=httpd
    - name: <span style="color: #8b2252;">"&#22797;&#21046;&#37197;&#32622;&#25991;&#20214;"</span>
      copy: <span style="color: #a0522d;">src</span>=/tmp/httpd.conf <span style="color: #a0522d;">dest</span>=/etc/httpd/conf/
    - name: <span style="color: #8b2252;">"&#22797;&#21046;&#37197;&#32622;&#25991;&#20214;"</span>
      copy: <span style="color: #a0522d;">src</span>=/tmp/vhosts.conf <span style="color: #a0522d;">dest</span>=/etc/httpd/conf.d/
    - name: <span style="color: #8b2252;">"&#21551;&#21160;Apache&#65292;&#24182;&#35774;&#32622;&#24320;&#26426;&#21551;&#21160;"</span>
      service: <span style="color: #a0522d;">name</span>=httpd <span style="color: #a0522d;">state</span>=started <span style="color: #a0522d;">enabled</span>=yes
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:90f0a6a6-bd2c-4a6e-bdaf-fddd8ea1c3d3" class="outline-3">
<h3 id="h:90f0a6a6-bd2c-4a6e-bdaf-fddd8ea1c3d3">playbook 命令</h3>
<div class="outline-text-3" id="text-h:90f0a6a6-bd2c-4a6e-bdaf-fddd8ea1c3d3">
<p>
格式
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible-playbook &lt;filename.yml&gt; ... [options]
</pre>
</div>

<p>
常见选项
</p>

<div class="org-src-container">
<pre class="src src-sh">-C --check      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#26816;&#27979;&#21487;&#33021;&#20250;&#21457;&#29983;&#30340;&#25913;&#21464;&#65292;&#20294;&#19981;&#30495;&#27491;&#25191;&#34892;&#25805;&#20316;
</span>--list-hosts    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#36816;&#34892;&#20219;&#21153;&#30340;&#20027;&#26426;
</span>--list-tags     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;tag
</span>--list-tasks    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;task
</span>--limit &#20027;&#26426;&#21015;&#34920; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#38024;&#23545;&#20027;&#26426;&#21015;&#34920;&#20013;&#30340;&#29305;&#23450;&#20027;&#26426;&#25191;&#34892;
</span>-v -vv -vvv     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#36807;&#31243;</span>
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-yaml">[root@ansible ansible]#cat hello.yml
---
- hosts: websrvs
  tasks:
    - name: hello
      command: echo "hello ansible"
[root@ansible ansible]#ansible-playbook hello.yml
[root@ansible ansible]#ansible-playbook -v hello.yml

[root@ansible ansible]#ansible-playbook --list-tasks hello.yml 
playbook: hello.yml
  play #1 (websrvs): websrvs    TAGS: []
    tasks:
      是否存活    TAGS: []
      清理/data/    TAGS: []
[root@ansible ansible]#ansible-playbook --list-hosts hello.yml 
playbook: hello.yml
  play #1 (websrvs): websrvs    TAGS: []
    pattern: ['websrvs']
    hosts (2):
      10.0.0.8
      10.0.0.7
</pre>
</div>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible-playbook file.yml --check <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#26816;&#27979;
</span>ansible-playbook file.yml
ansible-playbook file.yml --limit websrvs
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cc8a752f-f1c5-4d3c-94ff-e476c563ec18" class="outline-3">
<h3 id="h:cc8a752f-f1c5-4d3c-94ff-e476c563ec18">Playbook 初步</h3>
<div class="outline-text-3" id="text-h:cc8a752f-f1c5-4d3c-94ff-e476c563ec18">
</div>
<div id="outline-container-h:c421ffdf-e86b-4b2d-915d-5be92b78f934" class="outline-4">
<h4 id="h:c421ffdf-e86b-4b2d-915d-5be92b78f934">利用 playbook 创建 mysql 用户</h4>
<div class="outline-text-4" id="text-h:c421ffdf-e86b-4b2d-915d-5be92b78f934">
<p>
范例：mysql_user.yml
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: dbsrvs
  remote_user: root

  tasks:
    - {name: create group, group: name=mysql system=yes gid=306}
    - name: create user
    user: name=mysql shell=/sbin/nologin system=yes group=mysql uid=306 home=/data/mysql create_home=no
</pre>
</div>
</div>
</div>
<div id="outline-container-h:71df824e-7fc3-4e56-bf22-bc2dbb7ab3c9" class="outline-4">
<h4 id="h:71df824e-7fc3-4e56-bf22-bc2dbb7ab3c9">利用 playbook 安装 nginx</h4>
<div class="outline-text-4" id="text-h:71df824e-7fc3-4e56-bf22-bc2dbb7ab3c9">
<p>
范例：install_nginx.yml
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
# install nginx
- hosts: websrvs
  remote_user: root
  tasks:
    - name: add group nginx
      user: name=nginx state=present
    - name: add user nginx
      user: name=nginx state=present group=nginx
    - name: Install Nginx
      yum: name=nginx state=present
    - name: web page
      copy: src=files/index.html dest=/usr/share/nginx/html/index.html
    - name: Start Nginx
      service: name=nginx state=started enabled=yes
</pre>
</div>
</div>
</div>
<div id="outline-container-h:399a9bc8-f1f3-4e26-876f-b2b9279f2bd9" class="outline-4">
<h4 id="h:399a9bc8-f1f3-4e26-876f-b2b9279f2bd9">利用 playbook 安装和卸载 httpd</h4>
<div class="outline-text-4" id="text-h:399a9bc8-f1f3-4e26-876f-b2b9279f2bd9">
<p>
范例：install_httpd.yml
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
#install httpd
- hosts: websrvs
  remote_user: root
  gather_facts: no
  tasks:
    - name: Install httpd
      yum: name=httpd state=present
    - name: Install configure file
      copy: src=files/httpd.conf dest=/etc/httpd/conf/
    - name: modify config
      lineinfile: path=/etc/httpd/conf/httpd.conf regexp='^Listen' line='Listen 8080'    
    - name: mkdir website dir
      file: path=/data/html state=directory
    - name: web html
      copy: src=files/index.html  dest=/data/html/
    - name: start service
      service: name=httpd state=started enabled=yes


ansible-playbook   install_httpd.yml --limit 10.0.0.8   #
</pre>
</div>

<p>
范例：remove_httpd.yml
</p>

<div class="org-src-container">
<pre class="src src-yaml">#remove_httpd.yml
---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: remove httpd package
      yum: name=httpd state=absent
    - name: remove apache user
      user: name=apache state=absent
    - name: remove config file
      file: name=/etc/httpd state=absent
    - name: remove web html
      file: name=/data/html/ state=absent
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8edf4e09-1c22-4cc5-82a7-c17043cdba1d" class="outline-4">
<h4 id="h:8edf4e09-1c22-4cc5-82a7-c17043cdba1d">利用 playbook 安装 mysql</h4>
<div class="outline-text-4" id="text-h:8edf4e09-1c22-4cc5-82a7-c17043cdba1d">
<p>
<b>范例：安装mysql-5.6.46-linux-glibc2.12</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ~]#ls -l /data/ansible/files/mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz
-rw-r--r-- 1 root root 403177622 Dec 4 13:05 /data/ansible/files/mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz

[root@ansible ~]#cat /data/ansible/files/my.cnf
[mysqld]
<span style="color: #a0522d;">socket</span>=/tmp/mysql.sock
<span style="color: #a0522d;">user</span>=mysql
symbolic-links=0
<span style="color: #a0522d;">datadir</span>=/data/mysql
<span style="color: #a0522d;">innodb_file_per_table</span>=1
log-bin
pid-file=/data/mysql/mysqld.pid

[client]
<span style="color: #a0522d;">port</span>=3306
<span style="color: #a0522d;">socket</span>=/tmp/mysql.sock

[mysqld_safe]
log-error=/var/log/mysqld.log

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#20840;&#21152;&#22266;&#33050;&#26412;,&#35774;&#23494;&#30721;
</span>[root@ansible ~]#cat /data/ansible/files/secure_mysql.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash
</span>/usr/local/mysql/bin/mysql_secure_installation &lt;&lt;EOF<span style="color: #ffa54f;">

y
cici
cici
y
y 
y 
y
EOF
</span>
[root@ansible ~]#tree /data/ansible/files/
/data/ansible/files/
&#9500;&#9472;&#9472; my.cnf
&#9500;&#9472;&#9472; mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz
&#9492;&#9472;&#9472; secure_mysql.sh

0 directories, 3 files

[root@ansible ~]#cat /data/ansible/install_mysql.yml
---
<span style="color: #b22222;"># </span><span style="color: #b22222;">install mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz
</span>- hosts: dbsrvs
  remote_user: root
  gather_facts: no
  tasks:
    - name: install packages
      yum: <span style="color: #a0522d;">name</span>=libaio,perl-Data-Dumper,perl-Getopt-Long
    - name: create mysql group
      group: <span style="color: #a0522d;">name</span>=mysql <span style="color: #a0522d;">gid</span>=306
    - name: create mysql user
      user: <span style="color: #a0522d;">name</span>=mysql <span style="color: #a0522d;">uid</span>=306 <span style="color: #a0522d;">group</span>=mysql <span style="color: #a0522d;">shell</span>=/sbin/nologin <span style="color: #a0522d;">system</span>=yes
<span style="color: #a0522d;">create_home</span>=no <span style="color: #a0522d;">home</span>=/data/mysql
    - name: copy tar to remote host and file mode
      unarchive: <span style="color: #a0522d;">src</span>=/data/ansible/files/mysql-5.6.46-linux-glibc2.12-
x86_64.tar.gz <span style="color: #a0522d;">dest</span>=/usr/local/ <span style="color: #a0522d;">owner</span>=root <span style="color: #a0522d;">group</span>=root
    - name: create linkfile /usr/local/mysql
      file: <span style="color: #a0522d;">src</span>=/usr/local/mysql-5.6.46-linux-glibc2.12-x86_64
<span style="color: #a0522d;">dest</span>=/usr/local/mysql <span style="color: #a0522d;">state</span>=link
    - name: data dir
      shell: <span style="color: #a0522d;">chdir</span>=/usr/local/mysql/ ./scripts/mysql_install_db --
<span style="color: #a0522d;">datadir</span>=/data/mysql --user=mysql
      tags: data
    - name: config my.cnf
      copy: <span style="color: #a0522d;">src</span>=/data/ansible/files/my.cnf  <span style="color: #a0522d;">dest</span>=/etc/my.cnf
    - name: service script
      shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
    - name: enable service
      shell: /etc/init.d/mysqld start;chkconfig --add mysqld;chkconfig mysqld on
      tags: service
    - name: PATH variable
      copy: <span style="color: #a0522d;">content</span>=<span style="color: #8b2252;">'PATH=/usr/local/mysql/bin:$PATH'</span> <span style="color: #a0522d;">dest</span>=/etc/profile.d/mysql.sh
    - name: secure script
      script: /data/ansible/files/secure_mysql.sh
      tags: script
---
<span style="color: #b22222;">#</span><span style="color: #b22222;">Installing MariaDB Binary </span>
</pre>
</div>

<p>
<b>安装MySQL错误问题整理</b>:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ansible ansible]#ansible-playbook  install_mysql5.6.yml --limit 10.0.0.8
TASK [secure script] **************************************************************
fatal: [10.0.0.8]: FAILED! =&gt; {<span style="color: #8b2252;">"changed"</span>: true, <span style="color: #8b2252;">"msg"</span>: <span style="color: #8b2252;">"non-zero return code"</span>, <span style="color: #8b2252;">"rc"</span>: 29, <span style="color: #8b2252;">"stderr"</span>: <span style="color: #8b2252;">"Shared connection to 10.0.0.8 closed.\r\n"</span>, <span style="color: #8b2252;">"stderr_lines"</span>: [<span style="color: #8b2252;">"Shared connection to 10.0.0.8 closed."</span>], <span style="color: #8b2252;">"stdout"</span>: <span style="color: #8b2252;">"Can't find a 'mysql' client in PATH or ./bin\r\nCleaning up...\r\nWarning: Could not unlink .my.cnf.3304: No such file or directory\r\nWarning: Could not unlink .mysql.3304: No such file or directory\r\n"</span>, <span style="color: #8b2252;">"stdout_lines"</span>: [<span style="color: #8b2252;">"Can't find a 'mysql' client in PATH or ./bin"</span>, <span style="color: #8b2252;">"Cleaning up..."</span>, <span style="color: #8b2252;">"Warning: Could not unlink .my.cnf.3304: No such file or directory"</span>, <span style="color: #8b2252;">"Warning: Could not unlink .mysql.3304: No such file or directory"</span>]}
PLAY RECAP ************************************************************************
10.0.0.8                   : <span style="color: #a0522d;">ok</span>=10   <span style="color: #a0522d;">changed</span>=10   <span style="color: #a0522d;">unreachable</span>=0    <span style="color: #a0522d;">failed</span>=1    <span style="color: #a0522d;">skipped</span>=0    <span style="color: #a0522d;">rescued</span>=0    <span style="color: #a0522d;">ignored</span>=0  

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25171;&#24320;&#30446;&#26631;&#20027;&#26426;,mysql&#31471;&#21475;&#24050;&#25171;&#24320;,&#20294;&#26159;&#21629;&#20196;&#25214;&#19981;&#21040;,&#21035;&#30528;&#24613;,&#36864;&#20986;&#37325;&#36827;
</span>[root@centos8 ~]#ss -ntl
State    Recv-Q    Send-Q          Local Address:Port         Peer Address:Port    
LISTEN   0         128                   0.0.0.0:111               0.0.0.0:*       
LISTEN   0         128                   0.0.0.0:22                0.0.0.0:*       
LISTEN   0         128                   0.0.0.0:5355              0.0.0.0:*       
LISTEN   0         128                      [::]:111                  [::]:*       
LISTEN   0         128                      [::]:22                   [::]:*       
LISTEN   0         80                          *:3306                    *:*       
LISTEN   0         128                      [::]:5355                 [::]:*       
[root@centos8 ~]#mysql
-bash: mysql: command not found
[root@centos8 ~]#exit

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20877;&#27425;&#25191;&#34892;&#21629;&#20196;&#26174;&#31034;&#32570;&#21253;
</span>[root@centos8 ~]#mysql
mysql: error while loading shared libraries: libncurses.so.5: cannot open shared object file: No such file or directory
[root@centos8 ~]#yum -y  install libaio numactl-libs ncurses-compat-libs libncurses.so.5

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30331;&#38470;&#25104;&#21151;
</span>[root@centos8 ~]#mysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 1
Server version: 5.6.47-log MySQL Community Server (GPL)

<span style="color: #0000ff;">Copyright</span> (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type <span style="color: #8b2252;">'help;'</span> or <span style="color: #8b2252;">'\h'</span> for help. Type <span style="color: #8b2252;">'\c'</span> to clear the current input statement.

mysql&gt; 
</pre>
</div>

<p>
<b>范例：install_mariadb.yml</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">---
<span style="color: #b22222;">#</span><span style="color: #b22222;">Installing MariaDB Binary Tarballs
</span>- hosts: dbsrvs
  remote_user: root
  gather_facts: no
  tasks:
    - name: create group
      group: <span style="color: #a0522d;">name</span>=mysql <span style="color: #a0522d;">gid</span>=27 <span style="color: #a0522d;">system</span>=yes
    - name: create user
      user: <span style="color: #a0522d;">name</span>=mysql <span style="color: #a0522d;">uid</span>=27 <span style="color: #a0522d;">system</span>=yes <span style="color: #a0522d;">group</span>=mysql <span style="color: #a0522d;">shell</span>=/sbin/nologin <span style="color: #a0522d;">home</span>=/data/mysql <span style="color: #a0522d;">create_home</span>=no
    - name: mkdir datadir
      file: <span style="color: #a0522d;">path</span>=/data/mysql <span style="color: #a0522d;">owner</span>=mysql <span style="color: #a0522d;">group</span>=mysql <span style="color: #a0522d;">state</span>=directory
    - name: unarchive package
      unarchive: <span style="color: #a0522d;">src</span>=/data/ansible/files/mariadb-10.2.27-linux-x86_64.tar.gz <span style="color: #a0522d;">dest</span>=/usr/local/ <span style="color: #a0522d;">owner</span>=root <span style="color: #a0522d;">group</span>=root
    - name: link
      file: <span style="color: #a0522d;">src</span>=/usr/local/mariadb-10.2.27-linux-x86_64 <span style="color: #a0522d;">path</span>=/usr/local/mysql <span style="color: #a0522d;">state</span>=link
    - name: install database
      shell: <span style="color: #a0522d;">chdir</span>=/usr/local/mysql   ./scripts/mysql_install_db -- <span style="color: #a0522d;">datadir</span>=/data/mysql --user=mysql
    - name: config file
      copy: <span style="color: #a0522d;">src</span>=/data/ansible/files/my.cnf  <span style="color: #a0522d;">dest</span>=/etc/ <span style="color: #a0522d;">backup</span>=yes
    - name: service script
      shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
    - name: start service
      service: <span style="color: #a0522d;">name</span>=mysqld <span style="color: #a0522d;">state</span>=started <span style="color: #a0522d;">enabled</span>=yes
    - name: PATH variable
      copy: <span style="color: #a0522d;">content</span>=<span style="color: #8b2252;">'PATH=/usr/local/mysql/bin:$PATH'</span> <span style="color: #a0522d;">dest</span>=/etc/profile.d/mysql.sh
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:48b1755b-669a-4d64-84c7-31ad695adc4b" class="outline-3">
<h3 id="h:48b1755b-669a-4d64-84c7-31ad695adc4b">Playbook中使用handlers和notify</h3>
<div class="outline-text-3" id="text-h:48b1755b-669a-4d64-84c7-31ad695adc4b">
<p>
Handlers本质是task list
，类似于MySQL中的触发器触发的行为，其中的task与前述的task并没有本质上的不同，主要用于当关注的资源发生变化时，才会采取一定的操作。而Notify对应的action可用于在每个play的最后被触发，这样可避免多次有改变发生时每次都执行指定的操作，仅在所有的变化发生完成后一次性地执行指定操作。在notify中列出的操作称为handler，也即notify中调用handler中定义的操作
</p>

<p>
案例:
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root
  gather_facts: no
  tasks:
    - name: Install httpd
      yum: name=httpd state=present
    - name: Install configure file
      copy: src=files/httpd.conf dest=/etc/httpd/conf/
      notify: restart httpd
    - name: ensure apache is running
      service: name=httpd state=started enabled=yes

  handlers:
    - name: restart httpd
      service: name=httpd state=restarted
</pre>
</div>

<p>
案例:
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root
  gather_facts: no
  tasks:
    - name: add group nginx
      user: name=nginx state=present
    - name: add user nginx
      user: name=nginx state=present group=nginx
    - name: Install Nginx
      yum: name=nginx state=present
    - name: config
      copy: src=/root/config.txt dest=/etc/nginx/nginx.conf
      notify:
        - Restart Nginx
        - Check Nginx Process

  handlers:
    - name: Restart Nginx
      service: name=nginx state=restarted enabled=yes
    - name: Check Nginx process
      shell: killall -0 nginx &amp;&gt; /tmp/nginx.log
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0a3aec5f-206c-42ec-83cc-6da69fa06720" class="outline-3">
<h3 id="h:0a3aec5f-206c-42ec-83cc-6da69fa06720">Playbook中使用tags组件</h3>
<div class="outline-text-3" id="text-h:0a3aec5f-206c-42ec-83cc-6da69fa06720">
<p>
在playbook文件中，可以利用tags组件，为特定 task
指定标签，当在执行playbook时，可以只执行特定tags的task,而非整个playbook文件
</p>

<p>
案例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">vim httpd.yml
---
# tags example
- hosts: websrvs
  remote_user: root
  gather_facts: no

  tasks:
    - name: Install httpd
      yum: name=httpd state=present
    - name: Install configure file
      copy: src=files/httpd.conf dest=/etc/httpd/conf/
      tags: conf
    - name: start httpd service
      tags: service
      service: name=httpd state=started enabled=yes

ansible-playbook –t conf,service httpd.yml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e06de863-5a87-498b-83c6-3ee055a9206e" class="outline-3">
<h3 id="h:e06de863-5a87-498b-83c6-3ee055a9206e">Playbook中使用变量</h3>
<div class="outline-text-3" id="text-h:e06de863-5a87-498b-83c6-3ee055a9206e">
<p>
变量名：仅能由字母、数字和下划线组成，且只能以字母开头
</p>

<p>
<b>变量定义</b> ：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">variable</span>=value
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">http_port</span>=80
</pre>
</div>

<p>
<b>变量调用方式</b> ：
</p>

<p>
通过{{ variable_name }} 调用变量，且变量名前后建议加空格，有时用”{{
variable_name }}“才生效
</p>

<p>
<b>变量来源</b> ：
</p>

<ol class="org-ol">
<li>ansible 的 setup facts 远程主机的所有变量都可直接调用</li>

<li><p>
通过命令行指定变量，优先级最高
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible-playbook -e <span style="color: #a0522d;">varname</span>=value test.yml
</pre>
</div></li>

<li><p>
在playbook文件中定义
</p>

<pre class="example" id="org5518d4b">
vars:
- var1: value1
- var2: value2
</pre></li>

<li><p>
在独立的变量YAML文件中定义
</p>

<div class="org-src-container">
<pre class="src src-yaml">- hosts: all
  vars_files:
    - vars.yml
</pre>
</div></li>

<li><p>
在 /etc/ansible/hosts
</p>

<p>
中定义主机（普通）变量：主机组中主机单独定义，优先级高于公共变量组
（公共）变量：针对主机组中所有主机定义统一变量
</p></li>

<li>在role中定义</li>
</ol>
</div>
<div id="outline-container-h:f0ba9bee-6110-4a70-9be2-40067a2ce7c1" class="outline-4">
<h4 id="h:f0ba9bee-6110-4a70-9be2-40067a2ce7c1">使用 setup 模块中变量</h4>
<div class="outline-text-4" id="text-h:f0ba9bee-6110-4a70-9be2-40067a2ce7c1">
<p>
本模块自动在playbook调用，不要用ansible命令调用
</p>

<p>
案例：使用setup变量
</p>

<div class="org-src-container">
<pre class="src src-yaml">ansible 10.0.0.101 -m setup -a 'filter="ansible_default_ipv4"'
10.0.0.101 | SUCCESS =&gt; {
    "ansible_facts": {
        "ansible_default_ipv4": {
            "address": "10.0.0.101",
            "alias": "eth0",
            "broadcast": "10.0.0.255",
            "gateway": "10.0.0.2",
            "interface": "eth0",
            "macaddress": "00:0c:29:e8:c7:9b",
            "mtu": 1500,
            "netmask": "255.255.255.0",
            "network": "10.0.0.0",
            "type": "ether"
        }
    },
    "changed": false
}
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
#var1.yml
- hosts: all
  remote_user: root
  gather_facts: yes
  tasks:
    - name: create log file
      file: name=/data/{{ ansible_nodename }}.log state=touch owner=cui mode=600

ansible-playbook var.yml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e090a3ba-479e-45f7-a157-e6cd7a18dd95" class="outline-4">
<h4 id="h:e090a3ba-479e-45f7-a157-e6cd7a18dd95">在playbook 命令行中定义变量</h4>
<div class="outline-text-4" id="text-h:e090a3ba-479e-45f7-a157-e6cd7a18dd95">
<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">vim var2.yml
---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: install package
      yum: name={{ pkname }} state=present

ansible-playbook –e pkname=httpd var2.yml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0a31f3d4-29d0-4a1c-8f5d-311d8d705a47" class="outline-4">
<h4 id="h:0a31f3d4-29d0-4a1c-8f5d-311d8d705a47">在playbook文件中定义变量</h4>
<div class="outline-text-4" id="text-h:0a31f3d4-29d0-4a1c-8f5d-311d8d705a47">
<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">vim var3.yml
---
- hosts: websrvs
  remote_user: root
  vars:
    - username: user1
    - groupname: group1

  tasks:
    - name: create group
      group: name={{ groupname }} state=present
    - name: create user
      user: name={{ username }} group={{ groupname }} state=present

ansible-playbook -e "username=user2 groupname=group2" var3.yml
#-e的优先级比playbook中高
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">cat var4.yaml
---
  - hosts: websrvs
    remote_user: root
    vars:       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21464;&#37327;&#30340;&#23450;&#20041;&#26041;&#24335;,&#20540;&#20174;setup&#27169;&#22359;&#20013;&#26469;,&#29983;&#25104;&#19968;&#20010;&#21644;IP&#22320;&#22336;&#21516;&#21517;&#30340;&#25991;&#20214;&#22841;
</span>      collect_info: <span style="color: #8b2252;">"/data/test/{{ansible_default_ipv4['address']}}/"</span>

    tasks:
      - name: create IP directory
        file: <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"{{collect_info}}"</span> <span style="color: #a0522d;">state</span>=directory 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;&#32467;&#26524;
</span>tree /data/test/
/data/test/
&#9492;&#9472;&#9472; 10.0.0.102

1 directory, 0 files
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e59a6767-d5f6-421b-987f-666121c1e7d3" class="outline-4">
<h4 id="h:e59a6767-d5f6-421b-987f-666121c1e7d3">使用变量文件</h4>
<div class="outline-text-4" id="text-h:e59a6767-d5f6-421b-987f-666121c1e7d3">
<p>
可以在一个独立的playbook文件中定义变量，在另一个playbook文件中引用变量文件中的变量，比playbook中定义的变量优化级高
</p>

<div class="org-src-container">
<pre class="src src-yaml">vim vars.yml   #只负责定义变量
---
# variables file
package_name: mariadb-server
service_name: mariadb

vim var5.yml
---
#install package and start service
- hosts: dbsrvs
  remote_user: root
  vars_files:
    - vars.yml

  tasks:
    - name: install package
      yum: name={{ package_name }}
      tags: install
    - name: start service
      service: name={{ service_name }} state=started enabled=yes
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">cat vars2.yml
---
var1: httpd
var2: nginx

cat var6.yml
---        
- hosts: web
  remote_user: root
  vars_files:
    - vars2.yml

  tasks:
    - name: create httpd log
      file: name=/app/{{ var1 }}.log state=touch
    - name: create nginx log
      file: name=/app/{{ var2 }}.log state=touch
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fd507cde-3910-48c8-b136-a9facc62f707" class="outline-4">
<h4 id="h:fd507cde-3910-48c8-b136-a9facc62f707">主机清单文件中定义变量</h4>
<div class="outline-text-4" id="text-h:fd507cde-3910-48c8-b136-a9facc62f707">
</div>
<div id="outline-container-h:5fbc0907-d431-44ae-af3f-b1a1be551f2a" class="outline-5">
<h5 id="h:5fbc0907-d431-44ae-af3f-b1a1be551f2a">主机变量</h5>
<div class="outline-text-5" id="text-h:5fbc0907-d431-44ae-af3f-b1a1be551f2a">
<p>
在inventory 主机清单文件中为指定的主机定义变量以便于在playbook中使用
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">[websrvs]
www1.cici.com http_port=80 maxRequestsPerChild=808
www2.cici.com http_port=8080 maxRequestsPerChild=909
</pre>
</div>
</div>
</div>
<div id="outline-container-h:daf87a79-1124-4aeb-b186-50bbef4e4b34" class="outline-5">
<h5 id="h:daf87a79-1124-4aeb-b186-50bbef4e4b34">组（公共）变量</h5>
<div class="outline-text-5" id="text-h:daf87a79-1124-4aeb-b186-50bbef4e4b34">
<p>
在inventory
主机清单文件中赋予给指定组内所有主机上的在playbook中可用的变量，如果和主机变是同名，优先级低于主机变量
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[websrvs]
www1.cici.com <span style="color: #a0522d;">http_port</span>=8080
www2.cici.com
[websrvs:vars]
<span style="color: #a0522d;">http_port</span>=80
<span style="color: #a0522d;">ntp_server</span>=ntp.cici.com
<span style="color: #a0522d;">nfs_server</span>=nfs.cici.com
</pre>
</div>

<p>
范例： 通过变量生成主机名
</p>

<div class="org-src-container">
<pre class="src src-sh">vim /etc/ansible/hosts

[websrvs]
10.0.0.8 <span style="color: #a0522d;">hname</span>=www1 <span style="color: #a0522d;">domain</span>=cici.io
10.0.0.7 <span style="color: #a0522d;">hname</span>=www2

[websvrs:vars]
<span style="color: #a0522d;">mark</span>=<span style="color: #8b2252;">"-"</span>
<span style="color: #a0522d;">domain</span>=cici.org


[root@ansible ansible]#ansible websrvs -m hostname -a <span style="color: #8b2252;">'name={{ hname }}{{ mark }}{{ domain }}'</span>
10.0.0.7 | <span style="color: #a0522d;">CHANGED</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"ansible_domain"</span>: <span style="color: #8b2252;">"org"</span>,
        <span style="color: #8b2252;">"ansible_fqdn"</span>: <span style="color: #8b2252;">"www2-cici.org"</span>,
        <span style="color: #8b2252;">"ansible_hostname"</span>: <span style="color: #8b2252;">"www2-cici"</span>,
        <span style="color: #8b2252;">"ansible_nodename"</span>: <span style="color: #8b2252;">"www2-cici.org"</span>,
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/bin/python"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: true,
    <span style="color: #8b2252;">"name"</span>: <span style="color: #8b2252;">"www2-cici.org"</span>
}
10.0.0.8 | <span style="color: #a0522d;">CHANGED</span> =&gt; {
    <span style="color: #8b2252;">"ansible_facts"</span>: {
        <span style="color: #8b2252;">"ansible_domain"</span>: <span style="color: #8b2252;">"io"</span>,
        <span style="color: #8b2252;">"ansible_fqdn"</span>: <span style="color: #8b2252;">"www1-cici.io"</span>,
        <span style="color: #8b2252;">"ansible_hostname"</span>: <span style="color: #8b2252;">"www1-cici"</span>,
        <span style="color: #8b2252;">"ansible_nodename"</span>: <span style="color: #8b2252;">"www1-cici.io"</span>,
        <span style="color: #8b2252;">"discovered_interpreter_python"</span>: <span style="color: #8b2252;">"/usr/libexec/platform-python"</span>
    },
    <span style="color: #8b2252;">"changed"</span>: true,
    <span style="color: #8b2252;">"name"</span>: <span style="color: #8b2252;">"www1-cici.io"</span>
}


bash
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21629;&#20196;&#34892;&#25351;&#23450;&#21464;&#37327;&#65306;
</span>ansible websvrs &#8211;e <span style="color: #a0522d;">domain</span>=cici.cn &#8211;m hostname &#8211;a    <span style="color: #8b2252;">'name={{ hname }}{{ mark
}}{{ domain }}'</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:5578fa90-9c01-456a-9bd4-e660f888a8d5" class="outline-3">
<h3 id="h:5578fa90-9c01-456a-9bd4-e660f888a8d5">template 模板</h3>
<div class="outline-text-3" id="text-h:5578fa90-9c01-456a-9bd4-e660f888a8d5">
<p>
模板是一个文本文件，可以做为生成文件的模版，并且模板文件中还可嵌套jinja语法
</p>
</div>
<div id="outline-container-h:24650b76-fac2-4002-aa7d-a0e80b33dd08" class="outline-4">
<h4 id="h:24650b76-fac2-4002-aa7d-a0e80b33dd08">jinja2语言</h4>
<div class="outline-text-4" id="text-h:24650b76-fac2-4002-aa7d-a0e80b33dd08">
<p>
官方网站：
</p>

<p>
<a href="http://jinja.pocoo.org/">http://jinja.pocoo.org/</a>
</p>

<p>
<a href="https://jinja.palletsprojects.com/en/2.11.x/">https://jinja.palletsprojects.com/en/2.11.x/</a>
</p>

<p>
jinja2 语言使用字面量，有下面形式：
</p>
<pre class="example" id="orgc617804">
- 字符串：使用单引号或双引号
- 数字：整数，浮点数
- 列表：[item1, item2, ...]
- 元组：(item1, item2, ...)
- 字典：{key1:value1, key2:value2, ...}
- 布尔型：true/false
- 算术运算：+, -, *, /, //, %, **
- 比较操作：==, !=, &gt;, &gt;=, &lt;, &lt;=
- 逻辑运算：and，or，not
- 流表达式：For，If，When
</pre>

<p>
<b>字面量</b> ：
</p>

<p>
表达式最简单的形式就是字面量。字面量表示诸如字符串和数值的 Python对象。
如”Hello World”双引号或单引号中间的一切都是字符串。无论何时你需要在
模板中使用一个字符串（比如函数调用、过滤器或只是包含或继承一个模板的参
数），如42，42.23数值可以为整数和浮点数。如果有小数点，则为浮点数，否
则为整数。在 Python里， 42 和 42.0 是不一样的
</p>

<p>
<b>算术运算</b> ：
</p>

<pre class="example" id="org2735c9b">
+：把两个对象加到一起。通常对象是素质，但是如果两者是字符串或列表，你可以用这 种方式来衔接它们。无论如何这不是首选的连接字符串的方式！连接字符串见 ~ 运算符。 {{ 1 + 1 }} 等于 2
-：用第一个数减去第二个数。 {{ 3 - 2 }} 等于 1
/：对两个数做除法。返回值会是一个浮点数。 {{ 1 / 2 }} 等于 0.5
//：对两个数做除法，返回整数商。 {{ 20 // 7 }} 等于 2
%：计算整数除法的余数。 {{ 11 % 7 }} 等于 4
*：用右边的数乘左边的操作数。 {{ 2 * 2 }} 会返回 4 。也可以用于重 复一个字符串多次。 {{ '=' * 80 }}会打印 80 个等号的横条\
**：取左操作数的右操作数次幂。 {{ 2**3 }} 会返回 8
</pre>


<p>
<b>比较操作符</b>
</p>
<pre class="example" id="orga7cc8ae">
== 比较两个对象是否相等
!= 比较两个对象是否不等
&gt; 如果左边大于右边，返回 true
&gt;= 如果左边大于等于右边，返回 true
&lt; 如果左边小于右边，返回 true
&lt;= 如果左边小于等于右边，返回 true
</pre>

<p>
<b>逻辑运算符</b>
</p>
<pre class="example" id="org3353a5a">
对于 if 语句，在 for 过滤或 if 表达式中，它可以用于联合多个表达式
and 如果左操作数和右操作数同为真，返回 true
or 如果左操作数和右操作数有一个为真，返回 true
not 对一个表达式取反
(expr)表达式组
true / false true 永远是 true ，而 false 始终是 false
</pre>
</div>
</div>
<div id="outline-container-h:4196f992-ed9f-486f-aadc-bb8b9e8fb7df" class="outline-4">
<h4 id="h:4196f992-ed9f-486f-aadc-bb8b9e8fb7df">template</h4>
<div class="outline-text-4" id="text-h:4196f992-ed9f-486f-aadc-bb8b9e8fb7df">
<p>
template功能：可以根据和参考模块文件，动态生成相类似的配置文件
</p>

<p>
template文件必须存放于templates目录下，且命名为 .j2 结尾
</p>

<p>
yaml/yml 文件需和templates目录平级，目录结构如下示例：
</p>
<pre class="example" id="orge14feab">
./\\
├── temnginx.yml\\
└── templates\\
└── nginx.conf.j2
</pre>

<p>
范例：利用template 同步nginx配置文件
</p>

<div class="org-src-container">
<pre class="src src-yaml">#准备templates/nginx.conf.j2文件
vim temnginx.yml
---
- hosts: websrvs
  remote_user: root

  tasks:
    - name: template config to remote hosts
      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf

ansible-playbook temnginx.yml
</pre>
</div>

<p>
<b>template变更替换</b>
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">#修改文件nginx.conf.j2
mkdir templates
vim templates/nginx.conf.j2
worker_processes {{ ansible_processor_vcpus }};   #cpu颗数

vim temnginx2.yml
---
- hosts: websrvs
  remote_user: root

  tasks:
    - name: install nginx
      yum: name=nginx
    - name: template config to remote hosts
      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf  #这一步并不会原装复制,而是把目标文件调整修改之后生成新的conf文件
    - name: start service
      service: name=nginx state=started enabled=yes

ansible-playbook temnginx2.yml

#扩展:cpu颗数查看
[root@ansible ansible]#ansible websrvs -m setup -a 'filter=ansible_processor_vcpus'
10.0.0.7 | SUCCESS =&gt; {
    "ansible_facts": {
        "ansible_processor_vcpus": 2,
        "discovered_interpreter_python": "/usr/bin/python"
    },
    "changed": false
}
10.0.0.8 | SUCCESS =&gt; {
    "ansible_facts": {
        "ansible_processor_vcpus": 1,
        "discovered_interpreter_python": "/usr/libexec/platform-python"
    },
    "changed": false
}
</pre>
</div>

<p>
<b>template算术运算</b>
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">vim nginx.conf.j2
worker_processes {{ ansible_processor_vcpus**2 }};    <span style="color: #b22222;">#</span><span style="color: #b22222;">2&#27425;&#26041;
</span>worker_processes {{ ansible_processor_vcpus+2 }}; 
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">[root@ansible ansible]#vim templates/nginx.conf.j2
worker_processes {{ ansible_processor_vcpus**3 }};

[root@ansible ansible]#cat templnginx.yml
---
- hosts: websrvs
  remote_user: root

  tasks:
    - name: install nginx
      yum: name=nginx
    - name: template config to remote hosts
      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf
      notify: restart nginx
    - name: start service
      service: name=nginx state=started enabled=yes

  handlers:
    - name: restart nginx
      service: name=nginx state=restarted


ansible-playbook templnginx.yml --limit 10.0.0.8
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c117f799-8788-4b89-aeee-31c20ad9be93" class="outline-4">
<h4 id="h:c117f799-8788-4b89-aeee-31c20ad9be93">template中使用流程控制 for 和 if</h4>
<div class="outline-text-4" id="text-h:c117f799-8788-4b89-aeee-31c20ad9be93">
<p>
template中也可以使用流程控制 for 循环和 if
条件判断，实现动态生成文件功能
</p>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-yaml">#temlnginx2.yml
---
- hosts: websrvs
  remote_user: root
  vars:
    nginx_vhosts:       #定义一个变量:由三个元素组成的一个列表
      - 81
      - 82
      - 83
  tasks:
    - name: template config
      template: src=nginx.conf.j2 dest=/data/nginx.conf

#templates/nginx2.conf.j2
{% for vhost in nginx_vhosts %}     #vhost会自动取81,82,83
server {
   listen {{ vhost }}
}
{% endfor %}

ansible-playbook -C templnginx2.yml --limit 10.0.0.8

#生成的结果：
server {
   listen 81  
}
server {
   listen 82  
}
server {
   listen 83  
}
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">#temlnginx3.yml
---
- hosts: websrvs
  remote_user: root
  vars:
    nginx_vhosts:
      - listen: 8080
  tasks:
    - name: config file
      template: src=nginx3.conf.j2 dest=/data/nginx3.conf

#templates/nginx3.conf.j2
{% for vhost in nginx_vhosts %}  
server {
  listen {{ vhost.listen }}
}
{% endfor %}

ansible-playbook   templnginx3.yml  --limit 10.0.0.8

#生成的结果
server {
  listen 8080
}
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">#templnginx4.yml
- hosts: websrvs
  remote_user: root
  vars:
    nginx_vhosts:
      - listen: 8080
        server_name: "web1.cici.com"
        root: "/var/www/nginx/web1/"
      - listen: 8081
        server_name: "web2.cici.com"
        root: "/var/www/nginx/web2/"
      - {listen: 8082, server_name: "web3.cici.com", root: "/var/www/nginx/web3/"}
  tasks:
    - name: template config
      template: src=nginx4.conf.j2 dest=/data/nginx4.conf


# templates/nginx.conf4.j2
{% for vhost in nginx_vhosts %}
server {
   listen {{ vhost.listen }}
   server_name {{ vhost.server_name }}
   root {{ vhost.root }}  
}
{% endfor %}

ansible-playbook templnginx4.yml --limit 10.0.0.8

#生成结果：
server {
    listen 8080
    server_name web1.cici.com
    root /var/www/nginx/web1/  
}
server {
    listen 8081
    server_name web2.cici.com
    root /var/www/nginx/web2/  
}
server {
    listen 8082
    server_name web3.cici.com
    root /var/www/nginx/web3/  
}
</pre>
</div>

<p>
在模版文件中还可以使用 if条件判断，决定是否生成相关的配置信息
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">templnginx5.yml
</span>- hosts: websrvs
  remote_user: root
  vars:
    nginx_vhosts:
      - web1:
        listen: 8080
        root: <span style="color: #8b2252;">"/var/www/nginx/web1/"</span>
      - web2:
        listen: 8080
        server_name: <span style="color: #8b2252;">"web2.cici.com"</span>
        root: <span style="color: #8b2252;">"/var/www/nginx/web2/"</span>
      - web3:
        listen: 8080
        server_name: <span style="color: #8b2252;">"web3.cici.com"</span>
        root: <span style="color: #8b2252;">"/var/www/nginx/web3/"</span>
  tasks:
    - name: template config to
      template: <span style="color: #a0522d;">src</span>=nginx.conf5.j2 <span style="color: #a0522d;">dest</span>=/data/nginx5.conf
---
</pre>
</div>

<div class="org-src-container">
<pre class="src src-jinja2">#templates/nginx.conf5.j2
#如果vhost.server_name定义过了,就生成server_name的值,没定义就不生成;即根据变量存在与否,来决定是否生成server_name

{% for vhost in nginx_vhosts %}
    server {
        listen {{ vhost.listen }}
            server_name {{ vhost.server_name }} #如果定义了vhost.server_name
        root  {{ vhost.root }}
    }
{% endfor %}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#30340;&#32467;&#26524;
</span>server {
   listen 8080
   root /var/www/nginx/web1/
}
server {
   listen 8080
   server_name web2.cici.com
   root /var/www/nginx/web2/
}
server {
   listen 8080
   server_name web3.cici.com
   root /var/www/nginx/web3/
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:a285cd08-19dd-4858-bf83-6c8ff2d72fd0" class="outline-3">
<h3 id="h:a285cd08-19dd-4858-bf83-6c8ff2d72fd0">playbook使用 when</h3>
<div class="outline-text-3" id="text-h:a285cd08-19dd-4858-bf83-6c8ff2d72fd0">
<p>
when语句，可以实现条件测试。如果需要根据变量、facts或此前任务的执行结果来做为某task执行与否的前提时要用到条件测试,通过在task后添加when子句即可使用条件测试，jinja2的语法格式
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: "shutdown RedHat flavored systems"
      command: /sbin/shutdown -h now
      when: ansible_os_family == "RedHat"
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: add group nginx
      tags: user
      user: name=nginx state=present
    - name: add user nginx
      user: name=nginx state=present group=nginx
    - name: Install Nginx
      yum: name=nginx state=present
    - name: restart Nginx
      service: name=nginx state=restarted
      when: ansible_distribution_major_version == "6"
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: install conf file to centos7
      template: src=nginx.conf.c7.j2 dest=/etc/nginx/nginx.conf
      when: ansible_distribution_major_version == "7"
    - name: install conf file to centos6
      template: src=nginx.conf.c6.j2 dest=/etc/nginx/nginx.conf
      when: ansible_distribution_major_version == "6"
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bd942071-2cea-48f6-a0cc-045587b70281" class="outline-3">
<h3 id="h:bd942071-2cea-48f6-a0cc-045587b70281">playbook 使用迭代 with_items</h3>
<div class="outline-text-3" id="text-h:bd942071-2cea-48f6-a0cc-045587b70281">
<p>
迭代：当有需要重复性执行的任务时，可以使用迭代机制
</p>

<p>
对迭代项的引用，固定变量名为”item”
</p>

<p>
要在task中使用with_items给定要迭代的元素列表
</p>

<p>
注意: ansible2.5版本后,可以用loop代替with_items
</p>

<p>
<b>列表元素格式</b> ：
</p>

<ul class="org-ul">
<li>字符串</li>
<li>字典</li>
</ul>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: add several users
      user: name={{ item }} state=present groups=wheel
      with_items:   #下面的列表会自动嵌入到上面的item
        - testuser1
        - testuser2
        - testuser3

#上面语句的功能等同于下面的语句
    - name: add several users
      user: name=testuser1 state=present groups=wheel
    - name: add several users
      user: name=testuser2 state=present groups=wheel
    - name: add several users
      user: name=testuser3 state=present groups=wheel

#执行结果
[root@centos8 ~]#getent passwd
testuser1:x:1001:1001::/home/testuser1:/bin/bash
testuser2:x:1002:1002::/home/testuser2:/bin/bash
testuser3:x:1003:1003::/home/testuser3:/bin/bash
</pre>
</div>

<p>
范例：卸载 mariadb
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
#remove mariadb server
- hosts: appsrvs:!10.0.0.8
  remote_user: root
  tasks:
    - name: stop service
      shell: /etc/init.d/mysqld stop
    - name: delete files and dir
      file: path={{item}} state=absent
      with_items:
        - /usr/local/mysql
        - /usr/local/mariadb-10.2.27-linux-x86_64
        - /etc/init.d/mysqld
        - /etc/profile.d/mysql.sh
        - /etc/my.cnf
        - /data/mysql
    - name: delete user
      user: name=mysql state=absent remove=yes
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts：websrvs
  remote_user: root

  tasks
    - name: install some packages
      yum: name={{ item }} state=present
      with_items:
        - nginx
        - memcached
        - php-fpm 
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: copy file
      copy: src={{ item }} dest=/tmp/{{ item }}
      with_items:
        - file1
        - file2
        - file3
    - name: yum install httpd
      yum: name={{ item }}  state=present
      with_items:
        - apr
        - apr-util
        - httpd
</pre>
</div>

<p>
<b>迭代嵌套子变量</b> ：在迭代中，还可以嵌套子变量，关联多个变量在一起使用
</p>

<p>
示例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root

  tasks:
    - name: add some groups
      group: name={{ item }} state=present
      with_items:
        - nginx
        - mysql
        - apache
    - name: add some users
      user: name={{ item.name }} group={{ item.group }} state=present
      with_items:
        - { name: 'nginx', group: 'nginx' }
        - { name: 'mysql', group: 'mysql' }
        - { name: 'apache', group: 'apache' }
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">cat with_item2.yml
---
- hosts: websrvs
  remote_user: root
  tasks:
    - name: add some groups
      group: name={{ item }} state=present
      with_items:
        - g1
        - g2
        - g3
    - name: add some users
      user: name={{ item.name }} group={{ item.group }} home={{ item.home }}
create_home=yes state=present
      with_items:
        - { name: 'user1', group: 'g1', home: '/data/user1' }
        - { name: 'user2', group: 'g2', home: '/data/user2' }
        - { name: 'user3', group: 'g3', home: '/data/user3' }

#最终结果如下:
[root@centos8 ~]#getent passwd user1
user1:x:1001:1001::/data/user1:/bin/bash
[root@centos8 ~]#id user1
uid=1001(user1) gid=1001(g1) groups=1001(g1)
[root@centos8 ~]#ll /data/
total 12
-rw-r--r-- 1 root  root 264 Jun 21 10:49 nginx4.conf
-rw-r--r-- 1 root  root 238 Jun 21 11:25 nginx5.conf
-rw-r--r-- 1 root  root  72 Jun 21 10:44 nginx.conf
drwx------ 2 user1 g1    62 Jun 21 11:53 user1
drwx------ 2 user2 g2    62 Jun 21 11:53 user2
drwx------ 2 user3 g3    62 Jun 21 11:54 user3
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b3da52c8-a8c8-44d5-88af-a63654cb9ddc" class="outline-3">
<h3 id="h:b3da52c8-a8c8-44d5-88af-a63654cb9ddc">管理节点过多导致的超时问题解决方法</h3>
<div class="outline-text-3" id="text-h:b3da52c8-a8c8-44d5-88af-a63654cb9ddc">
<p>
默认情况下，Ansible将尝试并行管理playbook中所有的机器。对于滚动更新用例，可以使用serial关键字定义Ansible一次应管理多少主机，还可以将serial关键字指定为百分比，表示每次并行执行的主机数占总数的比例
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">#vim test_serial.yml
---
- hosts: all
  serial: 2 #每次只同时处理2个主机
  gather_facts: False

  tasks:
    - name: task one
      comand: hostname
    - name: task two
      command: hostname
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-yaml">- name: test serail
  hosts: all
  serial: "20%"   #每次只同时处理20%的主机
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:954e685a-1aef-4f59-a35b-8c16371ed21a" class="outline-2">
<h2 id="h:954e685a-1aef-4f59-a35b-8c16371ed21a">roles角色</h2>
<div class="outline-text-2" id="text-h:954e685a-1aef-4f59-a35b-8c16371ed21a">
<p>
角色是ansible自1.2版本引入的新特性，用于层次性、结构化地组织playbook。roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可。简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中
</p>

<p>
运维复杂的场景：建议使用 roles，代码复用度高
</p>

<p>
roles：多个角色的集合，
可以将多个的role，分别放至roles目录下的独立子目录中
</p>

<div class="org-src-container">
<pre class="src src-yaml">roles/
  mysql/
  nginx/
  tomcat/
  redis/
</pre>
</div>
</div>
<div id="outline-container-h:ad6a8b23-f7a6-43d9-8bc1-ad71d94ebfdc" class="outline-3">
<h3 id="h:ad6a8b23-f7a6-43d9-8bc1-ad71d94ebfdc">Ansible Roles目录编排</h3>
<div class="outline-text-3" id="text-h:ad6a8b23-f7a6-43d9-8bc1-ad71d94ebfdc">
<p>
每个角色，以特定的层级目录结构进行组织
</p>

<p>
角色写好之后就固定了,想要调用哪些角色就另外写yaml文件,其实也就是原来写的yaml文件拆开放到不同文件夹里,实现模块化
</p>

<p>
<b>roles目录结构</b> ：
</p>

<div class="org-src-container">
<pre class="src src-sh">playbook.yml
roles/
 project/
   tasks/
   files/
   vars/      
   templates/
   handlers/
   default/    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#21464;&#37327;
</span>   meta/       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20803;&#25968;&#25454;</span>
</pre>
</div>

<p>
<b>Roles各目录作用</b>
</p>

<p>
roles/project/ :项目名称,有以下子目录
</p>

<ul class="org-ul">
<li>files/ ：存放由copy或script模块等调用的文件</li>
<li>templates/：template模块查找所需要模板文件的目录</li>
<li>tasks/：定义task,role的基本元素，至少应该包含一个名为main.yml的文件；
其它的文件需要在此文件中通过include进行包含</li>
<li>handlers/：至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</li>
<li>vars/：定义变量，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</li>
<li>meta/：定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为
main.yml的文件，其它文件需在此文件中通过include进行包含</li>
<li>default/：设定默认变量时使用此目录中的main.yml文件，比vars的优先级低</li>
</ul>
</div>
</div>
<div id="outline-container-h:5d533a95-d2ab-402d-883b-4a41fd54628c" class="outline-3">
<h3 id="h:5d533a95-d2ab-402d-883b-4a41fd54628c">创建 role</h3>
<div class="outline-text-3" id="text-h:5d533a95-d2ab-402d-883b-4a41fd54628c">
<p>
创建role的步骤
</p>

<div class="org-src-container">
<pre class="src src-sh">1 &#21019;&#24314;&#20197;roles&#21629;&#21517;&#30340;&#30446;&#24405;
2 &#22312;roles&#30446;&#24405;&#20013;&#20998;&#21035;&#21019;&#24314;&#20197;&#21508;&#35282;&#33394;&#21517;&#31216;&#21629;&#21517;&#30340;&#30446;&#24405;&#65292;&#22914;webservers&#31561;
3 &#22312;&#27599;&#20010;&#35282;&#33394;&#21629;&#21517;&#30340;&#30446;&#24405;&#20013;&#20998;&#21035;&#21019;&#24314;files&#12289;handlers&#12289;meta&#12289;tasks&#12289;templates&#21644;vars&#30446;&#24405;&#65307;&#29992;&#19981;&#21040;
&#30340;&#30446;&#24405;&#21487;&#20197;&#21019;&#24314;&#20026;&#31354;&#30446;&#24405;&#65292;&#20063;&#21487;&#20197;&#19981;&#21019;&#24314;
4 &#22312;playbook&#25991;&#20214;&#20013;&#65292;&#35843;&#29992;&#21508;&#35282;&#33394;
</pre>
</div>

<p>
针对大型项目使用Roles进行编排
</p>

<p>
范例：roles的目录结构
</p>

<div class="org-src-container">
<pre class="src src-sh">nginx-role.yml
roles/
&#9492;&#9472;&#9472; nginx
     &#9500;&#9472;&#9472; files
     &#9474;   &#9492;&#9472;&#9472; main.yml
     &#9500;&#9472;&#9472; tasks
     &#9474;   &#9500;&#9472;&#9472; groupadd.yml
     &#9474;   &#9500;&#9472;&#9472; install.yml
     &#9474;   &#9500;&#9472;&#9472; main.yml
     &#9474;   &#9500;&#9472;&#9472; restart.yml
     &#9474;   &#9492;&#9472;&#9472; useradd.yml
     &#9492;&#9472;&#9472; vars
         &#9492;&#9472;&#9472; main.yml 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b64d06e1-b9b6-4996-b702-7159938bda55" class="outline-3">
<h3 id="h:b64d06e1-b9b6-4996-b702-7159938bda55">playbook调用角色</h3>
<div class="outline-text-3" id="text-h:b64d06e1-b9b6-4996-b702-7159938bda55">
<p>
*调用角色方法1*：
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: websrvs
  remote_user: root
  roles:
    - mysql
    - memcached
    - nginx  
</pre>
</div>

<p>
<b>调用角色方法2</b> ：
</p>

<p>
键role用于指定角色名称，后续的k/v用于传递变量给角色
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: all
  remote_user: root
  roles:
    - mysql
    - { role: nginx, username: nginx }
</pre>
</div>

<p>
<b>调用角色方法3</b> ：
</p>

<p>
还可基于条件测试实现角色调用
</p>

<div class="org-src-container">
<pre class="src src-yaml">---
- hosts: all
  remote_user: root
  roles:
    - { role: nginx, username: nginx, when: ansible_distribution_major_version
== '7' }

#只有7版本时才调用
</pre>
</div>
</div>
</div>
<div id="outline-container-h:62cd23ee-27ee-4a02-885b-0a0fdf45502c" class="outline-3">
<h3 id="h:62cd23ee-27ee-4a02-885b-0a0fdf45502c">roles 中 tags 使用</h3>
<div class="outline-text-3" id="text-h:62cd23ee-27ee-4a02-885b-0a0fdf45502c">
<div class="org-src-container">
<pre class="src src-yaml">#nginx-role.yml, 贴标签后挑标签来执行
---
- hosts: websrvs
  remote_user: root
  roles:
    - { role: nginx ,tags: [ 'nginx', 'web' ] ,when: ansible_distribution_major_version == "6" }
    - { role: httpd ,tags: [ 'httpd', 'web' ] }
    - { role: mysql ,tags: [ 'mysql', 'db' ] }
    - { role: mariadb ,tags: [ 'mariadb', 'db' ] } ansible-playbook --tags="nginx,httpd,mysql" nginx-role.yml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:63ae80ce-faf4-4826-a393-f616f80e000c" class="outline-3">
<h3 id="h:63ae80ce-faf4-4826-a393-f616f80e000c">实战案例</h3>
<div class="outline-text-3" id="text-h:63ae80ce-faf4-4826-a393-f616f80e000c">
</div>
<div id="outline-container-h:6df15f85-1668-4a13-adb7-422464c2fc84" class="outline-4">
<h4 id="h:6df15f85-1668-4a13-adb7-422464c2fc84">案例1：实现 httpd 角色</h4>
<div class="outline-text-4" id="text-h:6df15f85-1668-4a13-adb7-422464c2fc84">
<div class="org-src-container">
<pre class="src src-yaml">#创建角色相关的目录,默认在/etc/ansible/roles
mkdir -pv /data/ansible/roles/httpd/{tasks,handlers,files}

#创建角色相关的文件
cd /data/ansible/roles/httpd/

#main.yml 是task的入口文件
vim tasks/main.yml
- include: group.yml
- include: user.yml
- include: install.yml
- include: config.yml
- include: index.yml
- include: service.yml

vim tasks/group.yml
- name: create apache group
  group: name=apache system=yes gid=80

vim tasks/user.yml
- name: create apache user
  user: name=apache system=yes shell=/sbin/nologin home=/var/www/ uid=80 group=apache

vim tasks/install.yml
- name: install httpd package
  yum: name=httpd

vim tasks/config.yml
- name: config file
  copy: src=httpd.conf dest=/etc/httpd/conf/ backup=yes
  notify: restart

vim tasks/index.yml
- name: index.html
  copy: src=index.html dest=/var/www/html/

vim tasks/service.yml
- name: start service
  service: name=httpd state=started enabled=yes

vim handlers/main.yml
- name: restart
  service: name=httpd state=restarted

#在files目录下准备两个文件
ls files/
httpd.conf index.html

tree /data/ansible/roles/httpd/
/data/ansible/roles/httpd/
├── files
│   ├── httpd.conf
│   └── index.html
├── handlers
│   └── main.yml
└── tasks
   ├── config.yml
   ├── group.yml
   ├── index.yml
   ├── install.yml
   ├── main.yml
   ├── service.yml
   └── user.yml
3 directories, 10 files

#在playbook中调用角色
vim /data/ansible/role_httpd.yml
---
# httpd role
- hosts: websrvs
  remote_user: root

  roles:
    - httpd

#运行playbook
ansible-playbook /data/ansible/role_httpd.yml
mkdir -pv /data/ansible
</pre>
</div>
</div>
</div>
<div id="outline-container-h:18580821-55a3-41e7-a91a-4b500d8689aa" class="outline-4">
<h4 id="h:18580821-55a3-41e7-a91a-4b500d8689aa">案例2：实现 nginx 角色</h4>
<div class="outline-text-4" id="text-h:18580821-55a3-41e7-a91a-4b500d8689aa">
<div class="org-src-container">
<pre class="src src-sh">mkdir -pv /data/ansible/roles/nginx/{tasks,handlers,templates,vars}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;task&#25991;&#20214;
</span><span style="color: #483d8b;">cd</span> /data/ansible/roles/nginx/

vim tasks/main.yml
- include: install.yml
- include: config.yml
- include: index.yml
- include: service.yml

vim tasks/install.yml
- name: install
  yum: <span style="color: #a0522d;">name</span>=nginx

vim tasks/config.yml
- name: config file for centos7
  template: <span style="color: #a0522d;">src</span>=nginx7.conf.j2 <span style="color: #a0522d;">dest</span>=/etc/nginx/nginx.conf
  when: <span style="color: #a0522d;">ansible_distribution_major_version</span>==<span style="color: #8b2252;">"7"</span>
  notify: restart

- name: config file for centos8
  template: <span style="color: #a0522d;">src</span>=nginx8.conf.j2 <span style="color: #a0522d;">dest</span>=/etc/nginx/nginx.conf
  when: <span style="color: #a0522d;">ansible_distribution_major_version</span>==<span style="color: #8b2252;">"8"</span>
  notify: restart

vim tasks/index.yml
- name: index.html
  copy: <span style="color: #a0522d;">src</span>=roles/httpd/files/index.html <span style="color: #a0522d;">dest</span>=/usr/share/nginx/html/

vim tasks/service.yml
- name: start service
  service: <span style="color: #a0522d;">name</span>=nginx <span style="color: #a0522d;">state</span>=started <span style="color: #a0522d;">enabled</span>=yes

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;handler&#25991;&#20214;
</span>cat handlers/main.yml
- name: restart
  service: <span style="color: #a0522d;">name</span>=nginx <span style="color: #a0522d;">state</span>=restarted

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#20004;&#20010;template&#25991;&#20214;
</span>cat templates/nginx7.conf.j2
...&#30465;&#30053;...
user {{user}};
worker_processes {{ansible_processor_vcpus+3}};   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#27492;&#34892;
</span>error_log /var/log/nginx/error.log;
pid /run/nginx.pid;
...&#30465;&#30053;...

cat templates/nginx8.conf.j2
...&#30465;&#30053;...
user nginx;
worker_processes {{ansible_processor_vcpus**3}};  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#27492;&#34892;
</span>error_log /var/log/nginx/error.log;
pid /run/nginx.pid;
...&#30465;&#30053;...

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#21464;&#37327;&#25991;&#20214;
</span>vim vars/main.yml
user: daemon

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#24405;&#32467;&#26500;&#22914;&#19979;
</span>tree /data/ansible/roles/nginx/
/data/ansible/roles/nginx/
&#9500;&#9472;&#9472; handlers
&#9474;   &#9492;&#9472;&#9472; main.yml
&#9500;&#9472;&#9472; tasks
&#9474;   &#9500;&#9472;&#9472; config.yml
&#9474;   &#9500;&#9472;&#9472; file.yml
&#9474;   &#9500;&#9472;&#9472; install.yml
&#9474;   &#9500;&#9472;&#9472; main.yml
&#9474;   &#9492;&#9472;&#9472; service.yml
&#9500;&#9472;&#9472; templates
&#9474;   &#9500;&#9472;&#9472; nginx7.conf.j2
&#9474;   &#9492;&#9472;&#9472; nginx8.conf.j2
&#9492;&#9472;&#9472; vars
   &#9492;&#9472;&#9472; main.yml
4 directories, 9 files

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;playbook&#20013;&#35843;&#29992;&#35282;&#33394;
</span>vim /data/ansible/role_nginx.yml
---
<span style="color: #b22222;">#</span><span style="color: #b22222;">nginx role
</span>- hosts: websrvs

  roles:
    - role: nginx

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36816;&#34892;playbook
</span>ansible-playbook /data/ansible/role_nginx.yml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:256f9ea7-7b71-4850-9120-a309c8cee771" class="outline-4">
<h4 id="h:256f9ea7-7b71-4850-9120-a309c8cee771">案例3：实现 memcached 角色</h4>
<div class="outline-text-4" id="text-h:256f9ea7-7b71-4850-9120-a309c8cee771">
<div class="org-src-container">
<pre class="src src-sh">mkdir -pv /data/ansible/roles/memcached/{tasks,templates}

<span style="color: #483d8b;">cd</span> /data/ansible/roles/memcached
vim tasks/main.yml
- include: install.yml
- include: config.yml
- include: service.yml

vim tasks/install.yml
- name: install
  yum: <span style="color: #a0522d;">name</span>=memcached

vim tasks/config.yml
- name: config file
  template: <span style="color: #a0522d;">src</span>=memcached.j2  <span style="color: #a0522d;">dest</span>=/etc/sysconfig/memcached
  vim tasks/service.yml
- name: service
  service: <span style="color: #a0522d;">name</span>=memcached <span style="color: #a0522d;">state</span>=started <span style="color: #a0522d;">enabled</span>=yes

<span style="color: #b22222;">#</span><span style="color: #b22222;">//&#25972;&#38500;
</span>vim templates/memcached.j2
<span style="color: #a0522d;">PORT</span>=<span style="color: #8b2252;">"11211"</span>
<span style="color: #a0522d;">USER</span>=<span style="color: #8b2252;">"memcached"</span>
<span style="color: #a0522d;">MAXCONN</span>=<span style="color: #8b2252;">"1024"</span>
<span style="color: #a0522d;">CACHESIZE</span>=<span style="color: #8b2252;">"{{ansible_memtotal_mb//4}}"</span>   
<span style="color: #a0522d;">OPTIONS</span>=<span style="color: #8b2252;">""</span>

tree /data/ansible/roles/memcached/
/data/ansible/roles/memcached/
&#9500;&#9472;&#9472; tasks
&#9474;   &#9500;&#9472;&#9472; config.yml
&#9474;   &#9500;&#9472;&#9472; install.yml
&#9474;   &#9500;&#9472;&#9472; main.yml
&#9474;   &#9492;&#9472;&#9472; service.yml
&#9492;&#9472;&#9472; templates
   &#9492;&#9472;&#9472; memcached.j2

2 directories, 5 files

vim /data/ansible/role_memcached.yml
---
- hosts: appsrvs

  roles:
    - role: memcached

ansible-play /data/ansible/role_memcached.yml 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b9909bd1-8062-46ae-9fe0-728611cc27f6" class="outline-4">
<h4 id="h:b9909bd1-8062-46ae-9fe0-728611cc27f6">案例4：实现 mysql 5.6 的角色</h4>
<div class="outline-text-4" id="text-h:b9909bd1-8062-46ae-9fe0-728611cc27f6">
<div class="org-src-container">
<pre class="src src-yaml">[root@ansible ~]#cat /data/ansible/roles/mysql/files/my.cnf
[mysqld]
socket=/tmp/mysql.sock
user=mysql
symbolic-links=0
datadir=/data/mysql
innodb_file_per_table=1
log-bin
pid-file=/data/mysql/mysqld.pid

[client]
port=3306
socket=/tmp/mysql.sock

[mysqld_safe]
log-error=/var/log/mysqld.log

[root@ansible ~]#cat /data/ansible/roles/mysql/files/secure_mysql.sh
#!/bin/bash
/usr/local/mysql/bin/mysql_secure_installation &lt;&lt;EOF

y
cici
cici
y
y
y
y
EOF

[root@ansible ~]#chmod +x /data/ansible/roles/mysql/files/secure_mysql.sh

[root@ansible ~]#ls /data/ansible/roles/mysql/files/
my.cnf mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz secure_mysql.sh

[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/main.yml
- include: install.yml
- include: group.yml
- include: user.yml
- include: unarchive.yml
- include: link.yml
- include: data.yml
- include: config.yml
- include: service.yml
- include: path.yml
- include: secure.yml

[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/install.yml
- name: install packages                                            
  yum: name=libaio,perl-Data-Dumper,perl-Getopt-Long
[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/group.yml
- name: create mysql group
  group: name=mysql gid=306
[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/user.yml
- name: create mysql user
  user: name=mysql uid=306 group=mysql shell=/sbin/nologin system=yes
create_home=no home=/data/mysql
[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/unarchive.yml
- name: copy tar to remote host and file mode
  unarchive: src=mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz dest=/usr/local/
owner=root group=root
[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/link.yml
- name: mkdir /usr/local/mysql
  file: src=/usr/local/mysql-5.6.46-linux-glibc2.12-x86_64 dest=/usr/local/mysql state=link
[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/data.yml
- name: data dir
  shell: chdir=/usr/local/mysql/ ./scripts/mysql_install_db --
datadir=/data/mysql --user=mysql
[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/config.yml
- name: config my.cnf
  copy: src=my.cnf  dest=/etc/my.cnf
[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/service.yml
- name: service script
  shell: /bin/cp /usr/local/mysql/support-files/mysql.server
/etc/init.d/mysqld;chkconfig --add mysqld;chkconfig mysqld on;/etc/init.d/mysqld start
[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/path.yml
- name: PATH variable
  copy: content='PATH=/usr/local/mysql/bin:$PATH' dest=/etc/profile.d/mysql.sh  

[root@ansible ~]#cat /data/ansible/roles/mysql/tasks/secure.yml
- name: secure script
  script: secure_mysql.sh

[root@ansible ~]#tree /data/ansible/roles/mysql/
/data/ansible/roles/mysql/
├── files
│   ├── my.cnf
│   ├── mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz
│   └── secure_mysql.sh
└── tasks
   ├── config.yml
   ├── data.yml
   ├── group.yml
   ├── install.yml
   ├── link.yml
   ├── main.yml
   ├── path.yml
   ├── secure.yml
   ├── service.yml
   ├── unarchive.yml
   └── user.yml

2 directories, 14 files

[root@ansible ~]#cat /data/ansible/mysql_roles.yml
- hosts: dbsrvs
  remote_user: root
  roles:
    - {role: mysql,tags: ["mysql","db"]}
    - {role: nginx,tage: ["nginx","web"]}

[root@ansible ~]#ansible-playbook -t mysql /data/ansible/mysql_roles.yml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:be894266-6075-47bb-a04e-8ee321be6bb8" class="outline-4">
<h4 id="h:be894266-6075-47bb-a04e-8ee321be6bb8">案例5 ：实现多角色的选择</h4>
<div class="outline-text-4" id="text-h:be894266-6075-47bb-a04e-8ee321be6bb8">
<div class="org-src-container">
<pre class="src src-yaml">vim /data/ansible/role_httpd_nginx.yml
---
- hosts: websrvs

  roles:
    - {role: httpd,tags: [httpd,web], when:
ansible_distribution_major_version=="7" }
    - {role: nginx,tags: [nginx,web], when:
ansible_distribution_major_version=="8" }

ansible-playbook -t nginx /data/ansible/role_httpd_nginx.yml 
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:2a8aebef-4cee-4445-bd56-e180c06604f2" class="outline-2">
<h2 id="h:2a8aebef-4cee-4445-bd56-e180c06604f2">ansible-tower</h2>
<div class="outline-text-2" id="text-h:2a8aebef-4cee-4445-bd56-e180c06604f2">
<p>
1）公司中实现运维自动化的架构中主要用到ansible，ansible脚本在部署服务器指令
</p>

<p>
行中显得不太直观。Ansible-Tower（之前叫做awx）是将ansible的指令界面化，简
</p>

<p>
明直观，简单易用。
</p>

<p>
2）Ansibke-tower其实就是一个图形化的任务调度，复杂服务部署，IT自动化的一个
</p>

<p>
管理平台，属于发布配置管理系统，支持Api及界面操作，Django编写。
</p>

<p>
3）Ansible-tower可以通过界面从github拉取最新playbook实施服务部署，提高生产
</p>

<p>
效率。当然它也提供一个RESET API和命令行的CLI以供python脚本调用
</p>

<ul class="org-ul">
<li>安装
<a href="https://docs.ansible.com/ansible-tower/latest/html/installandreference/tower_installer.html#obtain-the-aap-installation-program">https://docs.ansible.com/ansible-tower/latest/html/installandreference/tower_installer.html#obtain-the-aap-installation-program</a></li>

<li>用户文档
<a href="https://docs.ansible.com/ansible-tower/latest/html_zh//userguide/index.html">https://docs.ansible.com/ansible-tower/latest/html_zh//userguide/index.html</a></li>
<li>订阅问题 <a href="https://www.milkfish.site/2021/05/13/1038.loli">https://www.milkfish.site/2021/05/13/1038.loli</a></li>
<li>官方源地址：<a href="http://releases.ansible.com/ansible-tower/setup-bundle/">http://releases.ansible.com/ansible-tower/setup-bundle/</a></li>
<li>官网下载地址: <a href="https://releases.ansible.com/ansible-tower/setup/">https://releases.ansible.com/ansible-tower/setup/</a></li>
</ul>
</div>
<div id="outline-container-h:f014f262-ac61-406d-84a0-19bfa0fbc552" class="outline-3">
<h3 id="h:f014f262-ac61-406d-84a0-19bfa0fbc552">ansible-tower安装及配置</h3>
<div class="outline-text-3" id="text-h:f014f262-ac61-406d-84a0-19bfa0fbc552">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1. &#23433;&#35013;Ansible 2 
</span>yum install ansible -y
ansible &#8208;&#8208;version <span style="color: #b22222;">#</span><span style="color: #b22222;">ansible 2.9.25
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">2.&#23433;&#35013;tower
</span><span style="color: #483d8b;">cd</span> /usr/local/src/
wget https://releases.ansible.com/ansible-tower/setup-bundle/ansible-tower-setup-bundle-3.8.4-1.tar.gz
tar zxf ansible&#8208;tower&#8208;setup&#8208;bundl
mv ansible&#8208;tower&#8208;setup&#8208;bundle&#8208;3.8.3&#8208;1 /usr/local/ans ible&#8208;tower
<span style="color: #483d8b;">cd</span> /usr/local/ansible&#8208;tower

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;&#25991;&#20214;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;inventory&#25991;&#20214; (&#27880;&#24847;&#65306;admin_password&#22788;&#22635;&#20889;&#30340;&#23601;&#26159;ansible&#8208;tower&#30331;&#38470;&#23494;&#30721;&#65292;&#23494; &#30721;&#21487;&#20197;&#33258;&#34892;&#35774;&#23450;)
</span>sed &#8208;i <span style="color: #8b2252;">"s#password=''#password='tower@12 3'#g"</span> inventory
sed &#8208;i <span style="color: #8b2252;">"s#host=''#host='127.0.0.1'#g"</span> inventory
sed &#8208;i <span style="color: #8b2252;">"s#port=''#port='5432'#g"</span> inventory
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#21069;&#20808;&#21019;&#24314;/var/log/tower&#30340;&#26085;&#24535;&#30446;&#24405;&#65292;&#19981;&#28982;&#20250;&#25253;&#38169;
</span>mkdir &#8208;p /var/log/tower
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25509;&#30528;&#25191;&#34892;ansible&#8208;tower&#30340;&#23433;&#35013;&#33050;&#26412;&#65292;&#22914;&#26524;&#32593;&#32476;&#27809;&#26377;&#38382;&#39064;&#30340;&#35805;&#32784;&#24515;&#31561;&#24453;&#23433;&#35013;&#23436;&#25104;&#21363;&#21487;.
</span>./setup.sh
</pre>
</div>

<p>
安装完成没报错的话即可访问web页面,这里测试机地址为172.16.60.244，则访
问ansible- tower地址就是<a href="https://172.16.60.244">https://172.16.60.244</a>, 默认初始页面如下:默认用
户为admin，密码为inventory文件admin_password字段配置的密码（如上设置的
密码为”tower@123“)。
</p>

<p>
ansible tower破解
</p>

<p>
步骤简述：
</p>

<div class="org-src-container">
<pre class="src src-sh">1. &#20462;&#25913;licensing.py&#25991;&#20214; 
2. &#36816;&#34892;&#8221;ansible-tower-service restart&#8221;&#37325;&#21551;&#26381;&#21153; 

btw&#65306;&#19981;&#38656;&#35201;&#21435;&#23448;&#32593;&#30003;&#35831;Trial License 
</pre>
</div>

<p>
1.修改licensing.py文件 该文件位于：
</p>

<div class="org-src-container">
<pre class="src src-sh">/var/lib/awx/venv/awx/lib/python3.6/site&#8208;packages/awx/main/utils/licensing.py 
</pre>
</div>

<p>
该文件内的方法是负责License验证的核心，将其用你熟悉的编辑器打开找到
validate方法，该方法就负责License的验证，在我这其位于该文件的409行。行
数可能随着版本的升级或修改不一定准确，以方法名为主。
</p>

<p>
该方法原文如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">def validate(self):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">Return license attributes with additional validation info.
</span>    <span style="color: #a0522d;">attrs</span> = copy.deepcopy(self._attrs)
    <span style="color: #a0522d;">type</span> = attrs.get(<span style="color: #8b2252;">'license_type'</span>, <span style="color: #8b2252;">'none'</span>)

    <span style="color: #a020f0;">if</span> (<span style="color: #a0522d;">type</span> == <span style="color: #8b2252;">'UNLICENSED'</span> or False):
        attrs.update(dict(<span style="color: #a0522d;">valid_key</span>=False, <span style="color: #a0522d;">compliant</span>=False))
        <span style="color: #a020f0;">return</span> attrs
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'valid_key'</span>] = True
    <span style="color: #a020f0;">if</span> Host:
        <span style="color: #a0522d;">current_instances</span> = Host.objects.active_count()
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a0522d;">current_instances</span> = 0
    <span style="color: #a0522d;">available_instances</span> = int(attrs.get(<span style="color: #8b2252;">'instance_count'</span>, None) or 0)
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'current_instances'</span>] = current_instances
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'available_instances'</span>] = available_instances
    <span style="color: #a0522d;">free_instances</span> = (available_instances - current_instances)
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'free_instances'</span>] = max(0, free_instances)

    <span style="color: #a0522d;">license_date</span> = int(attrs.get(<span style="color: #8b2252;">'license_date'</span>, 0) or 0)
    <span style="color: #a0522d;">current_date</span> = int(time.time())
    <span style="color: #a0522d;">time_remaining</span> = license_date - current_date
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'time_remaining'</span>] = time_remaining
    <span style="color: #a020f0;">if</span> attrs.setdefault(<span style="color: #8b2252;">'trial'</span>, False):
        <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'grace_period_remaining'</span>] = time_remaining
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'grace_period_remaining'</span>] = (license_date + 2592000) - current_date
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'compliant'</span>] = bool(time_remaining &gt; 0 and free_instances &gt;= 0)
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'date_warning'</span>] = bool(time_remaining &lt; self.SUBSCRIPTION_TIMEOUT)
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'date_expired'</span>] = bool(time_remaining &lt;= 0)
    <span style="color: #a020f0;">return</span> attrs
</pre>
</div>

<p>
将其改成这个样子即可
</p>

<div class="org-src-container">
<pre class="src src-sh">def validate(self):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">Return license attributes with additional validation info.
</span>    <span style="color: #a0522d;">attrs</span> = copy.deepcopy(self._attrs)

    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'license_type'</span>] = <span style="color: #8b2252;">'enterprise'</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;License&#31867;&#22411;&#20026;&#20225;&#19994;&#29256;
</span>    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'instance_count'</span>] = MAX_INSTANCES <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;Host&#25968;&#37327;&#20026;MAX_INSTANCES&#65292;&#21363;9999999&#12290;&#25179;&#19981;&#20303;&#23601;&#25913;&#25104;&#33258;&#24049;&#38656;&#35201;&#30340;&#25968;&#12290;
</span>    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'license_date'</span>] = <span style="color: #8b2252;">'2567433600'</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;License&#36807;&#26399;&#26085;&#26399;&#20026;&#8221;2051-05-12 00:00:00&#8220;&#65292;Unix&#26102;&#38388;&#25139;&#65292;&#26377;&#38656;&#35201;&#33258;&#24049;&#25913;
</span>    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'subscription_name'</span>] = <span style="color: #8b2252;">'mxd'</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20320;&#29468;
</span>
    <span style="color: #a0522d;">type</span> = attrs.get(<span style="color: #8b2252;">'license_type'</span>, <span style="color: #8b2252;">'none'</span>)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#37322;&#25481;&#19979;&#38754;&#30340;&#21028;&#26029;
</span>    <span style="color: #b22222;">#</span><span style="color: #b22222;">if (type == 'UNLICENSED' or False):
</span>        <span style="color: #b22222;">#</span><span style="color: #b22222;">attrs.update(dict(valid_key=False, compliant=False))
</span>        <span style="color: #b22222;">#</span><span style="color: #b22222;">return attrs
</span>    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'valid_key'</span>] = True <span style="color: #b22222;"># </span><span style="color: #b22222;">&#30452;&#25509;&#23558; valid_key &#35774;&#20026; true
</span>    <span style="color: #a020f0;">if</span> Host:
        <span style="color: #a0522d;">current_instances</span> = Host.objects.active_count()
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a0522d;">current_instances</span> = 0
    <span style="color: #a0522d;">available_instances</span> = int(attrs.get(<span style="color: #8b2252;">'instance_count'</span>, None) or 0)
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'current_instances'</span>] = current_instances
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'available_instances'</span>] = available_instances
    <span style="color: #a0522d;">free_instances</span> = (available_instances - current_instances)
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'free_instances'</span>] = max(0, free_instances)

    <span style="color: #a0522d;">license_date</span> = int(attrs.get(<span style="color: #8b2252;">'license_date'</span>, 0) or 0)
    <span style="color: #a0522d;">current_date</span> = int(time.time())
    <span style="color: #a0522d;">time_remaining</span> = license_date - current_date
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'time_remaining'</span>] = time_remaining
    <span style="color: #a020f0;">if</span> attrs.setdefault(<span style="color: #8b2252;">'trial'</span>, False):
        <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'grace_period_remaining'</span>] = time_remaining
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'grace_period_remaining'</span>] = (license_date + 2592000) - current_date
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'compliant'</span>] = bool(time_remaining &gt; 0 and free_instances &gt;= 0)
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'date_warning'</span>] = bool(time_remaining &lt; self.SUBSCRIPTION_TIMEOUT)
    <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'date_expired'</span>] = bool(time_remaining &lt;= 0)
    <span style="color: #a020f0;">return</span> attrs
</pre>
</div>

<p>
运行”ansible-tower-service restart”重启服务
</p>

<div class="org-src-container">
<pre class="src src-sh">ansible-tower-service restart
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b61ae83f-b84c-4bee-9064-993448316b23" class="outline-3">
<h3 id="h:b61ae83f-b84c-4bee-9064-993448316b23">资源管理</h3>
<div class="outline-text-3" id="text-h:b61ae83f-b84c-4bee-9064-993448316b23">
<p>
模板是任务执行的入口，它依赖项目、清单、作证共同完成作业。
</p>
</div>
<div id="outline-container-h:2e56641a-4ae6-4e27-a821-54173e307d3c" class="outline-4">
<h4 id="h:2e56641a-4ae6-4e27-a821-54173e307d3c">项目</h4>
<div class="outline-text-4" id="text-h:2e56641a-4ae6-4e27-a821-54173e307d3c">
<p>
ansible的代码库位置，可以根据分支不同创建不同的项目。
</p>


<figure id="org2a25d4c">
<img src="./images/image-20210722143628686.png" alt="image-20210722143628686.png">

<figcaption><span class="figure-number">Figure 3: </span>image-20210722143628686</figcaption>
</figure>

<pre class="example" id="org0d423e6">
名称：项目名称
机构：默认Default
scm类型：代码源
scm url: 支持ssh \http协议，如git@github.com:ansible/ansible.git
scm凭证：访问认证
scm分支：
scm更新选项：有4个，这里选启动时更新修订
缓存时间：；启动更新时的缓存时间。0没有限制
</pre>
</div>
</div>
<div id="outline-container-h:e80a1802-daa9-4874-b0ac-86415e8674bd" class="outline-4">
<h4 id="h:e80a1802-daa9-4874-b0ac-86415e8674bd">清单</h4>
<div class="outline-text-4" id="text-h:e80a1802-daa9-4874-b0ac-86415e8674bd">
<p>
主机列表。
</p>

<p>
可以设置主机组、自定义源(如aws的EC2)、外置变量
</p>

<p>
范例：外置变量
</p>

<div class="org-src-container">
<pre class="src src-sh">domain_cloud: tx
domain_group: ops
domain_region: bj
</pre>
</div>
</div>
</div>
<div id="outline-container-h:44eec651-7df4-4808-a2ca-6306fc2ede84" class="outline-4">
<h4 id="h:44eec651-7df4-4808-a2ca-6306fc2ede84">凭证</h4>
<div class="outline-text-4" id="text-h:44eec651-7df4-4808-a2ca-6306fc2ede84">
<p>
执行ansible命令时的免费密钥凭证
</p>
</div>
</div>
<div id="outline-container-h:2ebeb837-b1a6-414c-b7b2-bd1d93020f31" class="outline-4">
<h4 id="h:2ebeb837-b1a6-414c-b7b2-bd1d93020f31">模板</h4>
<div class="outline-text-4" id="text-h:2ebeb837-b1a6-414c-b7b2-bd1d93020f31">
<p>
可临时复制已有模板使用
</p>
</div>
</div>
</div>
</section>
<section id="outline-container-h:315887f9-3861-4b87-9e22-8c76dbd56ef7" class="outline-2">
<h2 id="h:315887f9-3861-4b87-9e22-8c76dbd56ef7">ansible 推荐学习资料</h2>
<div class="outline-text-2" id="text-h:315887f9-3861-4b87-9e22-8c76dbd56ef7">
<p>
<a href="http://galaxy.ansible.com">http://galaxy.ansible.com</a>
</p>

<p>
<a href="https://galaxy.ansible.com/explore#/">https://galaxy.ansible.com/explore#/</a>
</p>

<p>
<a href="http://github.com/">http://github.com/</a>
</p>

<p>
<a href="http://ansible.com.cn/">http://ansible.com.cn/</a>
</p>

<p>
<a href="https://github.com/ansible/ansible">https://github.com/ansible/ansible</a>
</p>

<p>
<a href="https://github.com/ansible/ansible-examples">https://github.com/ansible/ansible-examples</a>
</p>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
