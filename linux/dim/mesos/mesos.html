<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: 容器编排Mesos</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux: 容器编排Mesos</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:2fb36f9f-9c72-4216-882f-b6062f6d8942">架构简介</a>
<ul>
<li><a href="#h:3ae3dd3c-bf24-4136-bde1-b2086b877ca0">mesos架构</a></li>
<li><a href="#h:2cabb245-87bf-461e-abdd-4dbaa0b0c6a3">marathon 简介</a></li>
</ul>
</li>
<li><a href="#h:f1e495e6-11a6-43d6-87fb-326933a30906">集群部署</a>
<ul>
<li><a href="#h:9af31aba-297e-405f-928e-eb0d6e5dcd91">系统要求：</a></li>
<li><a href="#h:370ca6b3-a33a-4da2-adee-f16843a0b563">编译mesos (略)</a></li>
<li><a href="#h:68d6a8b5-584a-46ba-a700-7b9bc7f059c6">所有节点yum源</a></li>
<li><a href="#h:7ab367ed-884e-4ff6-abe0-3f913b44ea84">zookeeper节点</a></li>
<li><a href="#h:22497e5e-82e5-4d0b-ba7d-f9a6af4f5747">mesos-master服务</a></li>
<li><a href="#h:9b1ee027-5ae5-4fa7-92b0-cd8dcebaecf9">marathon节点</a></li>
<li><a href="#h:2af555c0-5252-4769-8914-cc8d33cfbe99">mesos-slave服务</a>
<ul>
<li><a href="#h:1ab254a8-41b8-4e1a-a3d8-0c9aef57f12e">docker安装</a></li>
</ul>
</li>
<li><a href="#h:b1dd4850-11c8-46f3-9c4f-61c883447b68">mesos-slave安装</a></li>
</ul>
</li>
<li><a href="#h:8f42db72-15ac-4e71-a119-d6462828970e">Docker仓库</a></li>
<li><a href="#h:3ba1b3e2-364b-43df-8ebc-c40aa1e6c0e2">添加节点脚本-add-mesos.sh</a></li>
<li><a href="#h:eb707312-ba2e-45cb-ba73-cc872db0d68b">nginx with consul-template</a></li>
</ul>
</div>
</nav>
<p>
TAGS: <a href="../index.html">Dim</a>
</p>

<p>
<code>弃用</code>
</p>
<section id="outline-container-h:2fb36f9f-9c72-4216-882f-b6062f6d8942" class="outline-2">
<h2 id="h:2fb36f9f-9c72-4216-882f-b6062f6d8942">架构简介</h2>
<div class="outline-text-2" id="text-h:2fb36f9f-9c72-4216-882f-b6062f6d8942">
<p>
官网地址：<a href="http://mesos.apache.org/">http://mesos.apache.org/</a>
</p>
</div>
<div id="outline-container-h:3ae3dd3c-bf24-4136-bde1-b2086b877ca0" class="outline-3">
<h3 id="h:3ae3dd3c-bf24-4136-bde1-b2086b877ca0">mesos架构</h3>
<div class="outline-text-3" id="text-h:3ae3dd3c-bf24-4136-bde1-b2086b877ca0">

<figure id="orga9433f6">
<img src="./images/img_20241023_011947.png" alt="img_20241023_011947.png" width="80%">

<figcaption><span class="figure-number">Figure 1: </span>CDF of job and task durations in Facebook's Haddop data warehouse(data from[38])</figcaption>
</figure>


<p>
<b>Mesos框架图</b>
</p>



<figure id="org4fc913d">
<img src="./images/img_20241023_012114.png" alt="img_20241023_012114.png" width="80%">

<figcaption><span class="figure-number">Figure 2: </span>Mesos architecture diagram, showing tow running frameworks(Hadoop and MPI)</figcaption>
</figure>



<p>
从上图可知，Mesos由一个管理在每个集群节点上运行的slave进程的master守护进程和在这些slave上运行任务的Mesos框架(framworks)组成。
</p>

<p>
通过提供资源，master可以通过frameworks实现细粒度的资源共享（CPU，RAM，&#x2026;）。
</p>

<p>
在Mesos的框架中存在如下基本概念：
</p>

<ol class="org-ol">
<li>Mesos-matser: 协调全部的slave，并确定每个节点的可用资源，聚合计算跨节点的所有可用资源的报告，然后向注册到Master的Framework发出资源邀约。</li>
<li>Mesos-slave：向Master汇报自己的空闲资源和任务的状态，负责管理本节点上的各个mesos-task，在framework成功向Master申请资源后，收到消息的slave会启动相应framework的executor。</li>
<li>Framework：Hadoop，Spark等，通过MesosSchedulerDriver接入Mesos。Framework由两部分组成，调度器（Scheduler）和执行器（Executor）。Scheduler在master上注册，获取提供的资源，Executor进程在slave节点上启动，运行framework的任务。</li>
</ol>

<p>
Executor：执行器，用于启动计算框架中的task。
</p>

<p>
在框架图中framework有两种，一种是Hadoop；一种是MPI。从框架图中可以看出，
Mesos是一个master/slave结构，其中master根据调度策略(比如公平调度和优先
级方式)，来决定将slave节点上的空闲资源(比如：CPU、内存或磁盘等)的提供
给framwork使用。另外Mater会保存framework和mesos slave的一些状态，这些
状态可用通过framework和slave重新注册来进行重构，因此可用使用zookeeper
来解决mesos matser单点故障的问题。slave主要功能是向Mater汇报任务状态和
启动framwork的executor。
</p>

<p>
<b>Mesos业务逻辑流程</b>
</p>



<figure id="org5efcaef">
<img src="./images/img_20241023_012314.png" alt="img_20241023_012314.png" width="80%">

<figcaption><span class="figure-number">Figure 3: </span>Resource offer example</figcaption>
</figure>



<p>
Mesos的框架图的逻辑流程分为如下四步：
</p>
<ul class="org-ul">
<li>第一步，Slave1节点向master报告它有空闲资源4个CPU和4GB内存。</li>
<li>第二步，Master发送一个Resource Offer给Framework1来描述Slave1有多少可用资源。</li>
<li>第三步，FrameWork1中的FW Sheduler会答复Master，有两个task需要运行在Slave1，一个Task需要&lt; 2个cpu，1gb内存&gt;，另一个Task需要&lt; 1个cpu，2gb内存&gt;</li>
<li>第四步，Master将任务需求资源发送给Slave1，Slave1分配适当的资源给Framework1的Executor，然后executor开始执行这两个任务，因为Slave1还剩&lt; 1CPU，1gb内存&gt;的资源未分配，分配模块还可用将这些资源提供给Framwork2来使用。</li>
</ul>
</div>
</div>
<div id="outline-container-h:2cabb245-87bf-461e-abdd-4dbaa0b0c6a3" class="outline-3">
<h3 id="h:2cabb245-87bf-461e-abdd-4dbaa0b0c6a3">marathon 简介</h3>
<div class="outline-text-3" id="text-h:2cabb245-87bf-461e-abdd-4dbaa0b0c6a3">
<p>
Marathon是基于MesosFramework的开源框架，框架图可参考如下。Marathon可以指定每个应用程序需要的资源以及要运行此程序需要多少实例。它可以使用的集群资源对失败的任务自动做出响应。
</p>

<p>
如果某个Mesos Slave宕机或应用的某个实例退出、失败，Marathon将会自动启动一个新的实例，来替换掉失败的实例。Marathon也允许用户在部署时指定应用程序彼此间的依赖关系，这样就可以保证某个应用程序实例不会在它依赖的数据库实例启动前启动。
</p>


<figure id="orgc3d73b3">
<img src="./images/img_20241023_012448.png" alt="img_20241023_012448.png" width="80%">

</figure>


<p>
Marathon提供对外的API接口函数，比如：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1.&#38656;&#35201;&#36890;&#36807;Marathon&#21551;&#21160;&#23481;&#22120;</span>
curl -X POST -H <span style="color: #8b2252;">"Accept: application/json"</span> -H <span style="color: #8b2252;">"Content-Type: application/json"</span> <span style="color: #8b2252;">\</span>
localhost:8080/v2/apps -d <span style="color: #8b2252;">'{</span>
<span style="color: #8b2252;">"container": {"image": "docker:///libmesos/ubuntu", "options": ["--privileged"]},</span>
<span style="color: #8b2252;">"cpus": 0.5,</span>
<span style="color: #8b2252;">"cmd": "sleep 500",</span>
<span style="color: #8b2252;">"id": "docker-tester",</span>
<span style="color: #8b2252;">"instances": 1,</span>
<span style="color: #8b2252;">"mem": 300</span>
<span style="color: #8b2252;">}'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">2.&#36890;&#36807;Marathon Rest API&#26816;&#26597;&#21551;&#21160;&#20219;&#21153;&#30340;&#29366;&#24577;</span>
curl -X GET -H <span style="color: #8b2252;">"Content-Type: application/json"</span> localhost:8080/v2/apps
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:f1e495e6-11a6-43d6-87fb-326933a30906" class="outline-2">
<h2 id="h:f1e495e6-11a6-43d6-87fb-326933a30906">集群部署</h2>
<div class="outline-text-2" id="text-h:f1e495e6-11a6-43d6-87fb-326933a30906">
<p>
参考：
</p>
<ul class="org-ul">
<li>部署：<a href="https://www.jianshu.com/p/6fd7941b86ae">https://www.jianshu.com/p/6fd7941b86ae</a></li>
<li>mesos: <a href="http://mesos.apache.org/">http://mesos.apache.org/</a></li>
<li>marathon: <a href="https://mesosphere.github.io/marathon/docs/">https://mesosphere.github.io/marathon/docs/</a></li>
</ul>
</div>
<div id="outline-container-h:9af31aba-297e-405f-928e-eb0d6e5dcd91" class="outline-3">
<h3 id="h:9af31aba-297e-405f-928e-eb0d6e5dcd91">系统要求：</h3>
<div class="outline-text-3" id="text-h:9af31aba-297e-405f-928e-eb0d6e5dcd91">
<pre class="example" id="org1411b80">
64位Linux操作系统
kernel&gt;=3.10
jdk必须是1.8+版本
</pre>

<p>
关闭虚拟机防火墙
</p>
<div class="org-src-container">
<pre class="src src-sh">setenforce 0
systemctl stop firewalld.service
</pre>
</div>

<p>
虚拟机的hostname及hosts文件都需做修改
</p>
<div class="org-src-container">
<pre class="src src-sh">hostnamectl set-hostname master01     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#21035;&#20462;&#25913;&#34394;&#25311;&#26426;&#30340;&#20027;&#26426;&#21517;&#65292;&#19968;&#19968;&#23545;&#24212;&#65292;&#37325;&#21551;&#29983;&#25928;</span>

cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
10.200.46.198 master01 zookeeper01 slave01 xu-1 my.registry.cici.me
10.200.46.199 master02 zookeeper02 slave02 xu-2
10.200.46.200 master03 zookeeper03 xu-3
</pre>
</div>

<p>
注意：主机名一定要在hosts文件中
</p>

<p>
marathon在这里部署在所有mesos master节点上
</p>
</div>
</div>
<div id="outline-container-h:370ca6b3-a33a-4da2-adee-f16843a0b563" class="outline-3">
<h3 id="h:370ca6b3-a33a-4da2-adee-f16843a0b563">编译mesos (略)</h3>
<div class="outline-text-3" id="text-h:370ca6b3-a33a-4da2-adee-f16843a0b563">
<p>
看官网，需要注意的是如果网络不通，编译的时候需要设置maven的代理
</p>

<p>
下面以yum 方式安装
</p>
</div>
</div>
<div id="outline-container-h:68d6a8b5-584a-46ba-a700-7b9bc7f059c6" class="outline-3">
<h3 id="h:68d6a8b5-584a-46ba-a700-7b9bc7f059c6">所有节点yum源</h3>
<div class="outline-text-3" id="text-h:68d6a8b5-584a-46ba-a700-7b9bc7f059c6">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#38463;&#37324;&#20113;yum</span>
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
sed -i <span style="color: #8b2252;">'/mirrors.aliyuncs.com/d'</span> /etc/yum.repos.d/CentOS-Base.repo

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;mesos&#30340;yum&#28304;</span>
rpm -Uvh http://repos.mesosphere.io/el/7/noarch/RPMS/mesosphere-el-repo-7-1.noarch.rpm
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-mesosphere
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7ab367ed-884e-4ff6-abe0-3f913b44ea84" class="outline-3">
<h3 id="h:7ab367ed-884e-4ff6-abe0-3f913b44ea84">zookeeper节点</h3>
<div class="outline-text-3" id="text-h:7ab367ed-884e-4ff6-abe0-3f913b44ea84">
<p>
安装ZooKeeper
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">$yum -y install mesosphere-zookeeper</span>

yum install java-1.8.0-openjdk -y
wget https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper/zookeeper-3.4.11/zookeeper-3.4.11.tar.gz
tar xf zookeeper-3.4.11.tar.gz -C /usr/local/
ln -sv /usr/local/zookeeper-3.4.11 /usr/local/zookeeper
<span style="color: #483d8b;">cd</span> /usr/local/zookeeper

mkdir -p /var/lib/zookeeper

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#36753;zookeeper&#37197;&#32622;&#25991;&#20214;</span>
cat &gt; /usr/local/zookeeper/conf/zoo.cfg &lt;&lt; EOF
<span style="color: #ffa54f;">maxClientCnxns=100</span>
<span style="color: #ffa54f;">tickTime=2000</span>
<span style="color: #ffa54f;">dataDir=/var/lib/zookeeper</span>
<span style="color: #ffa54f;">clientPort=2181</span>
<span style="color: #ffa54f;">initLimit=10</span>
<span style="color: #ffa54f;">syncLimit=5</span>
<span style="color: #ffa54f;">#&#31532;&#19968;&#20010;&#31471;&#21475;2888 &#29992;&#26469;&#38598;&#32676;&#25104;&#21592;&#30340;&#20449;&#24687;&#20132;&#25442;&#65292;&#21482;&#26377;&#19968;&#20010;master&#20250;&#30417;&#21548;&#36825;&#20010;&#31471;&#21475;</span>
<span style="color: #ffa54f;">#&#31532;&#20108;&#20010;&#31471;&#21475;3888 &#26159;&#22312;leader&#25346;&#25481;&#26102;&#19987;&#38376;&#29992;&#26469;&#36827;&#34892;&#36873;&#20030;leader&#25152;&#29992;</span>
<span style="color: #ffa54f;">server.1=zookeeper01:2888:3888</span>
<span style="color: #ffa54f;">server.2=zookeeper02:2888:3888</span>
<span style="color: #ffa54f;">server.3=zookeeper03:2888:3888</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;zookeeper&#30340;id,&#20889;&#20837;&#19968;&#20010;1-255&#30340;&#20540;&#65292;&#27599;&#20010;zookeeper&#33410;&#28857;&#30340;id&#19981;&#35201;&#37325;&#22797;</span>
master01
<span style="color: #483d8b;">echo</span> 1 &gt;/var/lib/zookeeper/myid
master02
<span style="color: #483d8b;">echo</span> 2 &gt;/var/lib/zookeeper/myid
master03
<span style="color: #483d8b;">echo</span> 3 &gt;/var/lib/zookeeper/myid

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29615;&#22659;&#21464;&#37327;</span>
cat &gt;/etc/profile.d/zookeeper.sh &lt;&lt;\EOF
<span style="color: #ffa54f;">ZOOKEEPER=/usr/local/zookeeper</span>
<span style="color: #ffa54f;">PATH=$PATH:$ZOOKEEPER/bin</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160;&#33050;&#26412;</span>
cat &gt;/usr/lib/systemd/system/zookeeper.service&lt;&lt;\EOF
<span style="color: #ffa54f;">[Unit]</span>
<span style="color: #ffa54f;">Description=Apache ZooKeeper</span>
<span style="color: #ffa54f;">After=network.target</span>

<span style="color: #ffa54f;">[Service]</span>
<span style="color: #ffa54f;">Environment="ZOOCFGDIR=/usr/local/zookeeper/conf"</span>
<span style="color: #ffa54f;">SyslogIdentifier=zookeeper</span>
<span style="color: #ffa54f;">WorkingDirectory=/usr/local/zookeeper</span>
<span style="color: #ffa54f;">ExecStart=/usr/local/zookeeper/bin/zkServer.sh start-foreground</span>
<span style="color: #ffa54f;">Restart=on-failure</span>
<span style="color: #ffa54f;">RestartSec=20</span>
<span style="color: #ffa54f;">User=root</span>
<span style="color: #ffa54f;">Group=root</span>

<span style="color: #ffa54f;">[Install]</span>
<span style="color: #ffa54f;">WantedBy=multi-user.target</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160;zk</span>
systemctl start zookeeper
</pre>
</div>
</div>
</div>
<div id="outline-container-h:22497e5e-82e5-4d0b-ba7d-f9a6af4f5747" class="outline-3">
<h3 id="h:22497e5e-82e5-4d0b-ba7d-f9a6af4f5747">mesos-master服务</h3>
<div class="outline-text-3" id="text-h:22497e5e-82e5-4d0b-ba7d-f9a6af4f5747">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;mesos marathon</span>
yum install mesos -y

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37197;&#32622;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;mesos-master&#30340;--zk&#21442;&#25968;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"zk://10.200.46.198:2181,10.200.46.199:2181,10.200.46.200:2181/mesos"</span> &gt;/etc/mesos/zk  

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;mesos-master&#30340;--hostname&#21442;&#25968;</span>
<span style="color: #a0522d;">host_ip</span>=$(<span style="color: #ff00ff;">/usr/sbin/ifconfig eth0 | sed -n '/inet /p'| awk '{print $2}'</span>)
<span style="color: #a0522d;">host_name</span>=$(<span style="color: #ff00ff;">sed -rn "/$(/usr/sbin/ifconfig eth0 | sed -n '/inet /p'| awk '{print $2}'</span><span style="color: #8b2252;">)/s@[[:digit:]\.]+[[:space:]]+([[:alnum:]_-]+).*@\1@gp"</span> /etc/hosts)
<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">host_ip</span> &gt;/etc/mesos-master/hostname
<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">host_ip</span> &gt;/etc/mesos-master/ip

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;mesos-master&#30340;--quorum&#20540;&#65292;&#36825;&#20010;&#20540;&#35201;&#22823;&#20110;master&#25968;&#37327;/2&#65292;&#36825;&#37324;&#26159;3&#20010;master&#25152;&#20197;&#35813;&#20540;&#35774;&#32622;&#20026;2</span>
<span style="color: #a0522d;">mesos_num</span>=$(<span style="color: #ff00ff;">($(grep -c $(echo  $host_name |sed  -r 's@([[:alpha:]]+</span><span style="color: #8b2252;">).*@\1@g'</span>) /etc/hosts)/2+1))
<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">mesos_num</span> &gt; /etc/mesos-master/quorum
<span style="color: #b22222;">#</span><span style="color: #b22222;">=========mesos ACL</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'/etc/mesospasswd'</span> &gt; /etc/mesos-master/credentials
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'/etc/acls.json'</span> &gt; /etc/mesos-master/acls
cat &lt;&lt; EOF &gt; /etc/mesospasswd
<span style="color: #ffa54f;">marathon marathon</span>
<span style="color: #ffa54f;">EOF</span>

cat &lt;&lt; EOF &gt; /etc/acls.json
<span style="color: #ffa54f;">{</span>
<span style="color: #ffa54f;">  "register_frameworks": [</span>
<span style="color: #ffa54f;">    {</span>
<span style="color: #ffa54f;">      "principals": { "values": ["marathon"] },</span>
<span style="color: #ffa54f;">      "roles": { "values": ["marathon"] }</span>
<span style="color: #ffa54f;">            }</span>
<span style="color: #ffa54f;">         ]</span>
<span style="color: #ffa54f;">     }</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">=========</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31105;&#29992;&#25481; mesos-slave, &#22240;&#20026;master&#21644;slave&#19981;&#33021;&#36816;&#34892;&#22312;&#21516;&#19968;&#21488;&#26381;&#21153;&#22120;</span>
systemctl stop mesos-slave.service
systemctl disable mesos-slave.service
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;mesos-master</span>
systemctl start mesos-master
</pre>
</div>

<p>
因为master和slave不能同时运行于同一台物理主机上，所以为了节省主机资源，可以考虑在docker中运行mesos-master
</p>
<div class="org-src-container">
<pre class="src src-sh">docker run -itd -v /etc/mesos:/etc/mesos -v /etc/mesos-master:/etc/mesos-master <span style="color: #8b2252;">\</span>
--name mesosmaster --network host  --restart=always <span style="color: #8b2252;">\</span>
10.0.209.130:5000/mymesos-master:1.4.1 /root/run.sh
</pre>
</div>

<p>
/root/run.sh 的内容是
</p>
<div class="org-src-container">
<pre class="src src-sh">/usr/bin/mesos-init-wrapper master
</pre>
</div>


<p>
如果mesos-master的日志中一直出现  Replica in VOTING status received &#x2026;  
</p>
<pre class="example" id="org3f4182f">
这表示出了一些问题，
这表示你之前使用过相同的 work_dir 运行过这个 master，这个文件夹内有一些持久化状态,
然后master会因为 quorum 达不到要求( 因为没有足够 quorum数量 的 master 有相同的持久化状态) 而拒绝启动以避免风险。
清空所有的work_dir即可。 echo "rm -rf $(cat /etc/mesos-master/work_dir)/*"
</pre>
</div>
</div>
<div id="outline-container-h:9b1ee027-5ae5-4fa7-92b0-cd8dcebaecf9" class="outline-3">
<h3 id="h:9b1ee027-5ae5-4fa7-92b0-cd8dcebaecf9">marathon节点</h3>
<div class="outline-text-3" id="text-h:9b1ee027-5ae5-4fa7-92b0-cd8dcebaecf9">
<p>
1)安装marathon
</p>
<div class="org-src-container">
<pre class="src src-sh">yum install  marathon -y
</pre>
</div>

<p>
2)配置marathon
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">======1.7&#29256;&#26412;=============</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24744;&#19981;&#33021;&#21516;&#26102;&#25351;&#23450;&#29615;&#22659;&#21464;&#37327;&#21644;&#23454;&#38469;&#21629;&#20196;&#34892;&#21442;&#25968;&#30456;&#21516;&#30340;&#21629;&#20196;&#34892;&#21442;&#25968;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29615;&#22659;&#21464;&#37327;&#26684;&#24335;&#65306;MARATHON_+&#22823;&#20889;&#30340;&#21629;&#20196;&#34892;&#21442;&#25968;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">The core functionality flags can be also set by environment variable MARATHON_ + the option name in all caps. For example, MARATHON_MASTER for the --master option.</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">For boolean values, set the environment variable with empty value. For example, use MARATHON_HA= to enable --ha or MARATHON_DISABLE_HA= for --disable_ha.</span>
mkdir -p /etc/default
mkdir -p /etc/marathon/
<span style="color: #a0522d;">host_ip</span>=$(<span style="color: #ff00ff;">/usr/sbin/ifconfig eth0 | sed -n '/inet /p'| awk '{print $2}'</span>)
cat &gt;&gt; /etc/default/marathon &lt;&lt; EOF
<span style="color: #ffa54f;">#------------------------------------</span>
<span style="color: #ffa54f;"># &#37197;&#32622;marathon&#30340;--master&#21442;&#25968;</span>
<span style="color: #ffa54f;">MARATHON_MASTER="zk://10.200.46.198:2181,10.200.46.199:2181,10.200.46.200:2181/mesos"</span>
<span style="color: #ffa54f;"># &#37197;&#32622;marathon&#30340;--hostname&#21442;&#25968;</span>
<span style="color: #ffa54f;">MARATHON_HOSTNAME="$host_ip"</span>
<span style="color: #ffa54f;"># &#37197;&#32622;marathon&#30340;&#21551;&#21160;&#21442;&#25968;&#65292;&#36825;&#20010;&#20540;&#34920;&#31034;&#31561;&#24453;10&#20998;&#38047;&#21518;&#65292;task&#22914;&#26524;&#36824;&#27809;&#26377;&#36827;&#20837;&#21040;TASK_RUNNING&#29366;&#24577;&#23601;&#34987;KILL&#25481;&#65292;&#21333;&#20301;&#27627;&#31186;&#65292;&#40664;&#35748;&#20540;300000(5&#20998;&#38047;)&#12290;</span>
<span style="color: #ffa54f;">MARATHON_TASK_LAUNCH_TIMEOUT="600000"</span>
<span style="color: #ffa54f;"># &#37197;&#32622;marathon&#30340;--http_port&#21442;&#25968;(&#21487;&#36873;)&#65292;&#40664;&#35748;8080</span>
<span style="color: #ffa54f;">MARATHON_HTTP_PORT="8080"</span>
<span style="color: #ffa54f;"># &#39640;&#21487;&#29992;</span>
<span style="color: #ffa54f;">MARATHON_ZK="zk://10.200.46.198:2181,10.200.46.199:2181,10.200.46.200:2181/mesos"</span>
<span style="color: #ffa54f;"># HTTP &#30331;&#38470;&#39564;&#35777;</span>
<span style="color: #ffa54f;">MARATHON_HTTP_CREDENTIALS="wowotuan:wowotuan"</span>
<span style="color: #ffa54f;"># SSL &#30331;&#38470;</span>
<span style="color: #ffa54f;">MARATHON_HTTPS_PORT="8443"</span>
<span style="color: #ffa54f;">MARATHON_SSL_KEYSTORE_PASSWORD="marathonwowopass" </span>
<span style="color: #ffa54f;">MARATHON_SSL_KEYSTORE_PATH="/etc/marathon/marathon.jks"</span>
<span style="color: #ffa54f;">#=================marathon Framework &#35748;&#35777;</span>
<span style="color: #ffa54f;">MARATHON_MESOS_AUTHENTICATION_PRINCIPAL="marathon"</span>
<span style="color: #ffa54f;">MARATHON_MESOS_AUTHENTICATION_SECRET_FILE="/etc/marathonpasswd"</span>
<span style="color: #ffa54f;">MARATHON_MESOS_ROLE="marathon"</span>

<span style="color: #ffa54f;">#=================&#20854;&#23427;&#21442;&#25968;</span>
<span style="color: #ffa54f;"># --task_lost_expunge_initial_delay &#40664;&#35748;5&#20998;&#38047;&#65292;&#21333;&#20301;&#27627;&#31186;&#12290;&#22312;Marathon&#24320;&#22987;&#23450;&#26399;&#25191;&#34892;&#20219;&#21153;&#28165;&#38500;gc&#25805;&#20316;&#20043;&#21069;</span>
<span style="color: #ffa54f;">MARATHON_TASK_LOST_EXPUNGE_INITIAL_DELAY="120000"</span>
<span style="color: #ffa54f;"># --task_lost_expunge_interval &#40664;&#35748;30&#31186;&#65292;&#21333;&#20301;&#27627;&#31186;&#12290;&#23545;&#20110;&#20002;&#22833;&#30340;&#20219;&#21153;gc&#25805;&#20316;</span>
<span style="color: #ffa54f;">MARATHON_TASK_LOST_EXPUNGE_INTERVAL="300000"</span>

<span style="color: #ffa54f;">#=================</span>
<span style="color: #ffa54f;">EOF</span>

cat &lt;&lt; EOF &gt; /etc/mesospasswd
<span style="color: #ffa54f;">marathon marathon</span>
<span style="color: #ffa54f;">EOF</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">=======1.7&#29256;&#26412;==============</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">=======&#37197;&#32622;&#25991;&#20214;&#26041;&#24335;1.4&#29256;&#26412;==============</span>
mkdir -p /etc/marathon/conf
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#29992;marathon&#35746;&#38405;&#21151;&#33021;&#65292;1.4&#29256;&#26412;&#29305;&#24615;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"http_callback"</span> &gt; /etc/marathon/conf/event_subscriber
<span style="color: #a0522d;">host_ip</span>=$(<span style="color: #ff00ff;">/usr/sbin/ifconfig eth0 | sed -n '/inet /p'| awk '{print $2}'</span>)
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$host_ip"</span> &gt; /etc/marathon/conf/hostname
<span style="color: #b22222;">#</span><span style="color: #b22222;">echo "http://172.16.49.21:8000/api/services" &gt; /etc/marathon/conf/http_endpoints # &#24320;&#21457;&#27979;&#35797;&#29992;1.4&#29256;&#26412;&#29305;&#24615;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"zk://10.200.46.198:2181,10.200.46.199:2181,10.200.46.200:2181/mesos"</span> &gt; /etc/marathon/conf/master

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#39640;&#21487;&#29992;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"zk://10.200.46.198:2181,10.200.46.199:2181,10.200.46.200:2181/mesos"</span> &gt; /etc/marathon/conf/zk
<span style="color: #b22222;"># </span><span style="color: #b22222;">HTTP &#30331;&#38470;&#39564;&#35777;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"wowotuan:wowotuan"</span> &gt;/etc/marathon/conf/http_credentials
<span style="color: #b22222;"># </span><span style="color: #b22222;">SSL &#30331;&#38470;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"8443"</span> &gt;/etc/marathon/conf/https_port
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"marathonwowopass"</span> &gt; /etc/marathon/conf/ssl_keystore_password
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"/etc/marathon/marathon.jks"</span> &gt;/etc/marathon/conf/ssl_keystore_path
<span style="color: #b22222;">#</span><span style="color: #b22222;">=================marathon Framework &#35748;&#35777;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'marathon'</span> &gt; /etc/marathon/conf/mesos_authentication_principal
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'/etc/marathonpasswd'</span> &gt; /etc/marathon/conf/mesos_authentication_secret_file
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'marathon'</span> &gt; /etc/marathon/conf/mesos_role

cat &lt;&lt; EOF &gt; /etc/mesospasswd
<span style="color: #ffa54f;">marathon marathon</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">=================&#20854;&#23427;&#21442;&#25968;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">--task_lost_expunge_gc &#40664;&#35748;75&#31186;&#65292;&#21333;&#20301;&#27627;&#31186;&#12290;&#30452;&#21040;&#20002;&#22833;&#30340;&#20219;&#21153;&#34987;&#22403;&#22334;&#25910;&#38598;&#24182;&#20174;&#20219;&#21153;&#36319;&#36394;&#22120;&#21644;&#20219;&#21153;&#23384;&#20648;&#24211;&#20013;&#28165;&#38500;&#12290;1.4&#29256;&#26412;&#21518;&#24323;&#29992;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'180000'</span> &gt; /etc/marathon/conf/task_lost_expunge_gc
<span style="color: #b22222;"># </span><span style="color: #b22222;">--task_lost_expunge_initial_delay &#40664;&#35748;5&#20998;&#38047;&#65292;&#21333;&#20301;&#27627;&#31186;&#12290;&#22312;Marathon&#24320;&#22987;&#23450;&#26399;&#25191;&#34892;&#20219;&#21153;&#28165;&#38500;gc&#25805;&#20316;&#20043;&#21069;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'120000'</span> &gt; /etc/marathon/conf/task_lost_expunge_initial_delay
<span style="color: #b22222;"># </span><span style="color: #b22222;">--task_lost_expunge_interval &#40664;&#35748;30&#31186;&#65292;&#21333;&#20301;&#27627;&#31186;&#12290;&#23545;&#20110;&#20002;&#22833;&#30340;&#20219;&#21153;gc&#25805;&#20316;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'300000'</span> &gt; /etc/marathon/conf/task_lost_expunge_interval
<span style="color: #b22222;">#</span><span style="color: #b22222;">=======&#37197;&#32622;&#25991;&#20214;&#26041;&#24335;1.4&#29256;&#26412;==============</span>
</pre>
</div>


<p>
3)marathon 证书配置
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">export</span> <span style="color: #a0522d;">MARATHON_KEY_PASSWORD</span>=marathonwowopass
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">MARATHON_PKCS_PASSWORD</span>=marathonwowopass
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">MARATHON_JKS_PASSWORD</span>=marathonwowopass

<span style="color: #a0522d;">COUNTRY</span>=CN
<span style="color: #a0522d;">PROVINCE</span>=BEIJING
<span style="color: #a0522d;">CITY</span>=BEIJING
<span style="color: #a0522d;">ORGANIZATION</span>=55tuan
<span style="color: #a0522d;">GROUP</span>=55tuan
<span style="color: #a0522d;">HOST</span>=MARATHON-CA
<span style="color: #a0522d;">SUBJ</span>=<span style="color: #8b2252;">"/C=$COUNTRY/ST=$PROVINCE/L=$CITY/O=$ORGANIZATION/OU=$GROUP/CN=$HOST"</span>

mkdir -p /etc/marathon/conf
<span style="color: #483d8b;">cd</span> /etc/marathon/
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;ca&#31169;&#38053;&#21644;ca&#33258;&#31614;&#35777;&#20070;</span>
touch  /etc/pki/CA/{serial,index.txt}  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#35777;&#20070;&#24207;&#21015;&#21495;&#25991;&#20214;&#12289;&#35777;&#20070;&#32034;&#24341;&#25991;&#20214;</span>
<span style="color: #483d8b;">echo</span>  01 &gt; /etc/pki/CA/serial <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#19968;&#27425;&#21019;&#24314;&#30340;&#26102;&#20505;&#38656;&#35201;&#32473;&#20104;&#35777;&#20070;&#24207;&#21015;&#21495;</span>
openssl genrsa -out /tmp/ca.key 2048
openssl req -new -x509 -key /tmp/ca.key -out /tmp/ca.pem -days 36500 -subj $<span style="color: #a0522d;">SUBJ</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#23458;&#25143;&#31471;&#31169;&#38053;&#21644;&#35777;&#20070;&#35831;&#27714;&#65292;&#24403;&#21069;key&#30340;&#21475;&#20197;&#38450;&#27490;&#26412;&#23494;&#38053;&#27844;&#28431;&#21518;&#34987;&#20154;&#30423;&#29992;</span>
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">MARATHON_KEY_PASSWORD</span>=marathonwowopass
openssl genrsa -des3 -out marathon.key -passout <span style="color: #8b2252;">"env:MARATHON_KEY_PASSWORD"</span>

openssl req <span style="color: #8b2252;">\</span>
  -reqexts SAN <span style="color: #8b2252;">\</span>
  -config &lt;(cat /etc/pki/tls/openssl.cnf <span style="color: #8b2252;">\</span>
  &lt;(<span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">"[SAN]\nsubjectAltName=DNS:marathon,DNS:*.cicinet.com"</span>)) <span style="color: #8b2252;">\</span>
  -new  -sha256  <span style="color: #8b2252;">\</span>
  -key marathon.key -passin <span style="color: #8b2252;">"env:MARATHON_KEY_PASSWORD"</span>  -out marathon.csr  <span style="color: #8b2252;">\</span>
  -subj <span style="color: #8b2252;">"/C=CN/ST=BEIJING/L=BEIJING/O=55tuan/OU=55tuan/CN=marathon"</span> <span style="color: #8b2252;">\</span>
  -days 36500

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23458;&#25143;&#31471;key&#31614;&#21517;</span>
openssl ca -batch <span style="color: #8b2252;">\</span>
    -extensions SAN <span style="color: #8b2252;">\</span>
    -config &lt;(cat /etc/pki/tls/openssl.cnf <span style="color: #8b2252;">\</span>
    &lt;(<span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">"[SAN]\nsubjectAltName=DNS:marathon,DNS:*.cicinet.com"</span>)) <span style="color: #8b2252;">\</span>
    -days 36500     -notext <span style="color: #8b2252;">\</span>
    -md sha256     -in marathon.csr  -out marathon.crt <span style="color: #8b2252;">\</span>
    -cert /tmp/ca.pem -key file /tmp/ca.key

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;&#35777;&#20070;&#36716;&#25442;&#20026;&#22823;&#22810;&#25968;&#27983;&#35272;&#22120;&#37117;&#33021;&#35782;&#21035;&#30340;PKCS12&#25991;&#20214;</span>
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">MARATHON_PKCS_PASSWORD</span>=marathonwowopass
openssl pkcs12 -name marathon  -inkey marathon.key -passin <span style="color: #8b2252;">"env:MARATHON_KEY_PASSWORD"</span> -in marathon.crt  -password <span style="color: #8b2252;">"env:MARATHON_PKCS_PASSWORD"</span> -export -out marathon.pkcs12

<span style="color: #b22222;"># </span><span style="color: #b22222;">PKCS12&#25991;&#20214;&#36716;JKS</span>
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">MARATHON_JKS_PASSWORD</span>=marathonwowopass
keytool -importkeystore -srckeystore marathon.pkcs12 -srcalias marathon -srcstorepass $<span style="color: #a0522d;">MARATHON_PKCS_PASSWORD</span> -srcstoretype PKCS12 -destkeystore marathon.jks -deststorepass $<span style="color: #a0522d;">MARATHON_JKS_PASSWORD</span>
</pre>
</div>

<ol class="org-ol">
<li>启动marathon</li>
</ol>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#25163;&#21160;&#21551;&#21160;&#27979;&#35797;</span>
/usr/share/marathon/bin/marathon  --master <span style="color: #8b2252;">"zk://10.200.46.198:2181,10.200.46.199:2181,10.200.46.200:2181/mesos"</span> --zk <span style="color: #8b2252;">"zk://10.200.46.198:2181,10.200.46.199:2181,10.200.46.200:2181/marathon"</span> --hostname <span style="color: #8b2252;">"10.200.46.198"</span> --http_credentials <span style="color: #8b2252;">"wowotuan:wowotuan"</span> --https_port <span style="color: #8b2252;">"8443"</span> --ssl_keystore_password <span style="color: #8b2252;">"marathonwowopass"</span> --ssl_keystore_path <span style="color: #8b2252;">"/etc/marathon/marathon.jks"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">unit service&#21551;&#21160;</span>
systemctl start marathon
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2af555c0-5252-4769-8914-cc8d33cfbe99" class="outline-3">
<h3 id="h:2af555c0-5252-4769-8914-cc8d33cfbe99">mesos-slave服务</h3>
<div class="outline-text-3" id="text-h:2af555c0-5252-4769-8914-cc8d33cfbe99">
</div>
<div id="outline-container-h:1ab254a8-41b8-4e1a-a3d8-0c9aef57f12e" class="outline-4">
<h4 id="h:1ab254a8-41b8-4e1a-a3d8-0c9aef57f12e">docker安装</h4>
<div class="outline-text-4" id="text-h:1ab254a8-41b8-4e1a-a3d8-0c9aef57f12e">
<p>
<b>1挂载磁盘</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">parted -s /dev/vdb mklabel gpt
parted -s /dev/vdb mkpart primary 0 100%
mkfs.xfs /dev/vdb1

parted -s /dev/vdc mklabel gpt
parted -s /dev/vdc mkpart primary 0 100%
mkfs.xfs /dev/vdc1

mkdir /data
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"/dev/vdc1                /data                   xfs     defaults        0 0"</span> &gt;&gt;/etc/fstab
mount -a
</pre>
</div>

<p>
安装docker
</p>
<div class="org-src-container">
<pre class="src src-sh">yum remove docker <span style="color: #8b2252;">\</span>
                  docker-client <span style="color: #8b2252;">\</span>
                  docker-client-latest <span style="color: #8b2252;">\</span>
                  docker-common <span style="color: #8b2252;">\</span>
                  docker-latest <span style="color: #8b2252;">\</span>
                  docker-latest-logrotate <span style="color: #8b2252;">\</span>
                  docker-logrotate <span style="color: #8b2252;">\</span>
                  docker-engine
yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum makecache fast
yum -y install docker-ce
</pre>
</div>

<p>
<b>2 准备docker devicemapper存储模式</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">2. &#23433;&#35013;&#20381;&#36182;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">centos device-mapper-persistent-data, lvm2</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">yum install -y yum-utils device-mapper-persistent-data  xfsprogs  lvm2 gcc*  install zlib-devel curl-devel openssl-devel httpd-devel apr-devel apr-util-devel mysql-devel libffi-devel</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">4. &#21019;&#24314;pv</span>
pvcreate /dev/vdb1&lt;&lt;EOF
<span style="color: #ffa54f;">y</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">5. &#21019;&#24314;vg</span>
vgcreate docker /dev/vdb1

<span style="color: #b22222;">#</span><span style="color: #b22222;">6. &#25351;&#23450;2&#20010;&#36923;&#36753;&#21367;&#21517;&#31216;thinpool and thinpoolmeta&#12290;&#26368;&#21518;&#19968;&#20010;&#21442;&#25968;&#25351;&#23450;&#20801;&#35768;&#22312;&#31354;&#38388;&#19981;&#36275;&#26102;&#33258;&#21160;&#25193;&#23637;&#25968;&#25454;&#25110;&#20803;&#25968;&#25454;&#30340;&#21487;&#29992;&#31354;&#38388;&#37327;&#65292;&#20316;&#20026;&#20020;&#26102;&#38388;&#38553;</span>
lvcreate --wipesignatures y -n thinpool docker -l 95%VG&lt;&lt;EOF
<span style="color: #ffa54f;">y</span>
<span style="color: #ffa54f;">EOF</span>
lvcreate --wipesignatures y -n thinpoolmeta docker -l 1%VG&lt;&lt;EOF
<span style="color: #ffa54f;">y</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">7. &#20351;&#29992;lvconvert&#21629;&#20196;&#23558;&#21367;&#36716;&#25442;&#20026;&#31934;&#31616;&#27744;&#21644;&#31934;&#31616;&#27744;&#30340;&#20803;&#25968;&#25454;&#23384;&#20648;&#20301;&#32622;</span>
lvconvert -y --zero n -c 512K --thinpool docker/thinpool --poolmetadata docker/thinpoolmeta
<span style="color: #b22222;">#</span><span style="color: #b22222;">8. &#36890;&#36807;&#37197;&#32622;&#25991;&#20214;&#33258;&#21160;&#25193;&#23481;</span>
cat &gt;&gt; /etc/lvm/profile/docker-thinpool.profile &lt;&lt; EOF
<span style="color: #ffa54f;">activation {</span>
<span style="color: #ffa54f;">    thin_pool_autoextend_threshold=80</span>
<span style="color: #ffa54f;">    thin_pool_autoextend_percent=20</span>
<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">EOF</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37197;&#32622;&#35828;&#26126;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">thin_pool_autoextend_threshold &#35813;&#20540;&#26159;lvm&#23581;&#35797;&#25193;&#23481;&#21040;&#21487;&#29992;&#31354;&#38388;&#26102;&#65292;&#24403;&#21069;&#24050;&#31354;&#38388;&#20351;&#29992;&#37327;&#30340;&#30334;&#20998;&#27604;&#65288;100=&#31105;&#27490;&#65289;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">thin_pool_autoextend_percent &#35813;&#20540;&#26159;thin&#27744;&#35201;&#25193;&#23481;&#30340;&#30334;&#20998;&#27604;&#65288;100=&#31105;&#27490;&#65289;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">9. &#24212;&#29992;&#26032;lvm profile &#25991;&#20214;</span>
lvchange --metadataprofile docker-thinpool docker/thinpool
systemctl daemon-reload

<span style="color: #b22222;">#</span><span style="color: #b22222;">10. &#37197;&#32622;docker unit</span>
vim /usr/lib/systemd/system/docker.service
[Unit]
<span style="color: #a0522d;">Description</span>=Docker Application Container Engine
<span style="color: #a0522d;">Documentation</span>=https://docs.docker.com
<span style="color: #a0522d;">After</span>=network.target docker.socket
<span style="color: #a0522d;">Requires</span>=docker.socket

[Service]
<span style="color: #a0522d;">Type</span>=notify
<span style="color: #a0522d;">ExecStart</span>=/usr/bin/docker daemon <span style="color: #8b2252;">\</span>
          --exec-opt native.cgroupdriver=systemd <span style="color: #8b2252;">\</span>
        --tlsverify -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock <span style="color: #8b2252;">\</span>
        --tlscacert=/etc/docker/ca.pem --tlscert=/etc/docker/cert.pem <span style="color: #8b2252;">\</span>
        --tlskey=/etc/docker/key.pem --storage-driver=devicemapper <span style="color: #8b2252;">\</span>
        --storage-opt=dm.thinpooldev=/dev/mapper/docker-thinpool --storage-opt dm.use_deferred_removal=true
<span style="color: #a0522d;">MountFlags</span>=slave
<span style="color: #a0522d;">LimitNOFILE</span>=1048576
<span style="color: #a0522d;">LimitNPROC</span>=1048576
<span style="color: #a0522d;">LimitCORE</span>=infinity
<span style="color: #a0522d;">TimeoutStartSec</span>=0

[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target
systemctl start docke

<span style="color: #b22222;">#</span><span style="color: #b22222;">11. &#21551;&#21160;docker</span>
systemctl start docker &amp;&amp; systemctl enable docker
docker  login -u wowotuanops -p registrywowotuan -e baijunhua@cicinet.com  tc-yz-hd1.registry.me:443
</pre>
</div>

<p>
<b>3 18.06的包已经用了overlay2存储模式</b>
</p>

<p>
<b>4 docker daemon ssl 认证安装</b>
</p>

<ol class="org-ol">
<li>方式1</li>
</ol>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;gem</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">yum install -y gem</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;taobao ruby gem&#38236;&#20687;</span>
$ gem sources --remove https://rubygems.org/
$ gem sources -a https://ruby.taobao.org/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;certificate_authority</span>
$ gem install certificate_authority
&#23548;&#20837;&#33050;&#26412;&#65288;&#25214;&#25105;&#35201;&#65292;&#25110;&#32773;&#22312;gitlab&#19978;&#38754;&#25214;&#25105;&#20889;&#24471;ansible&#33050;&#26412;&#65289;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#35777;&#20070;&#65288;&#27880;&#24847;example.com&#26159;&#38024;&#23545;&#35775;&#38382;&#30340;&#24212;&#29992;&#30340;&#22495;&#21517;&#65292;&#22914;&#26524;&#26159;IP&#35775;&#38382;&#65292;&#36825;&#37324;&#23601;&#22635;&#20889;ip eg:ruby certgen.rb 10.9.120.20&#65289;</span>
$ ruby certgen.rb example.com
CA certificates are<span style="color: #a020f0;"> in</span> /root/.docker/ca
Client certificates are<span style="color: #a020f0;"> in</span> /root/.docker
Server certificates are<span style="color: #a020f0;"> in</span> /root/.docker/example.com

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#31471;&#65306;</span>
&#25335;&#36125; /root/.docker/example.com&#19979;&#30340;&#19977;&#20010;&#25991;&#20214; ca.pem cert.pem key.pem&#21040; /etc/docker/&#30446;&#24405;&#19979;
&#37197;&#32622;docker&#21551;&#21160;&#20351;&#29992;ssl
<span style="color: #b22222;"># </span><span style="color: #b22222;">cat /etc/sysconfig/docker</span>
<span style="color: #a0522d;">OPTIONS</span>=<span style="color: #8b2252;">'--tlsverify -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock --tlscacert=/etc/docker/ca.pem --tlscert=/etc/docker/cert.pem --tlskey=/etc/docker/key.pem'</span>
&#37325;&#21551;docker daemon&#36827;&#31243;
systemctl restart docker

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#65306;</span>
&#25335;&#36125;/root/.docker &#19979;&#30340;&#19977;&#20010;&#25991;&#20214; ca.pem cert.pem key.pem&#65292;&#21040;&#23458;&#25143;&#31471;&#30340;&#35748;&#35777;&#65292;&#22914;&#65306;java&#35775;&#38382;&#30340;&#35748;&#35777;&#12290;
</pre>
</div>


<ol class="org-ol">
<li>方式2</li>
</ol>

<p>
创建TLS证书(根证书、服务端证书、客户端证书)
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /usr/anyesu/docker
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20869;&#23481;&#27604;&#36739;&#22810;, &#23601;&#20889;&#25104;&#19968;&#20010;shell&#33050;&#26412;, &#23558;&#38656;&#35201;&#32465;&#23450;&#30340;&#26381;&#21153;&#31471;ip&#25110;&#22495;&#21517;&#20570;&#21442;&#25968;&#20256;&#20837;&#21363;&#21487;</span>
vi tlscert.sh
</pre>
</div>

<p>
脚本内容如下：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">/bin/bash</span>
<span style="color: #b22222;">#</span>
<span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">#</span> != 1 ] ; <span style="color: #a020f0;">then</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"USAGE: $0 [HOST_IP]"</span>
<span style="color: #a020f0;">exit</span> 1;
<span style="color: #a020f0;">fi</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">============================================#</span>
<span style="color: #b22222;">#   </span><span style="color: #b22222;">&#19979;&#38754;&#20026;&#35777;&#20070;&#23494;&#38053;&#21450;&#30456;&#20851;&#20449;&#24687;&#37197;&#32622;&#65292;&#27880;&#24847;&#20462;&#25913;   #</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">============================================#</span>
<span style="color: #a0522d;">PASSWORD</span>=<span style="color: #8b2252;">"8#QBD2$!EmED&amp;QxK"</span>
<span style="color: #a0522d;">COUNTRY</span>=CN
<span style="color: #a0522d;">PROVINCE</span>=yourprovince
<span style="color: #a0522d;">CITY</span>=yourcity
<span style="color: #a0522d;">ORGANIZATION</span>=yourorganization
<span style="color: #a0522d;">GROUP</span>=yourgroup
<span style="color: #a0522d;">NAME</span>=yourname
<span style="color: #a0522d;">HOST</span>=$<span style="color: #a0522d;">1</span>
<span style="color: #a0522d;">SUBJ</span>=<span style="color: #8b2252;">"/C=$COUNTRY/ST=$PROVINCE/L=$CITY/O=$ORGANIZATION/OU=$GROUP/CN=$HOST"</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"your host is: $1"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">1.&#29983;&#25104;&#26681;&#35777;&#20070;RSA&#31169;&#38053;&#65292;PASSWORD&#20316;&#20026;&#31169;&#38053;&#25991;&#20214;&#30340;&#23494;&#30721;</span>
openssl genrsa -passout pass:$<span style="color: #a0522d;">PASSWORD</span> -aes256 -out ca-key.pem 4096
<span style="color: #b22222;"># </span><span style="color: #b22222;">2.&#29992;&#26681;&#35777;&#20070;RSA&#31169;&#38053;&#29983;&#25104;&#33258;&#31614;&#21517;&#30340;&#26681;&#35777;&#20070;</span>
openssl req -passin pass:$<span style="color: #a0522d;">PASSWORD</span> -new -x509 -days 365 -key ca-key.pem -sha256 -out ca.pem -subj $<span style="color: #a0522d;">SUBJ</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">============================================#</span>
<span style="color: #b22222;">#          </span><span style="color: #b22222;">&#29992;&#26681;&#35777;&#20070;&#31614;&#21457;server&#31471;&#35777;&#20070;          #</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">============================================#</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">3.&#29983;&#25104;&#26381;&#21153;&#31471;&#31169;&#38053;</span>
openssl genrsa -out server-key.pem 4096
<span style="color: #b22222;"># </span><span style="color: #b22222;">4.&#29983;&#25104;&#26381;&#21153;&#31471;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;</span>
openssl req -new -sha256 -key server-key.pem -out server.csr -subj <span style="color: #8b2252;">"/CN=$HOST"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">5.&#20351;tls&#36830;&#25509;&#33021;&#36890;&#36807;ip&#22320;&#22336;&#26041;&#24335;&#65292;&#32465;&#23450;IP</span>
<span style="color: #483d8b;">echo</span> subjectAltName = IP:127.0.0.1,IP:$<span style="color: #a0522d;">HOST</span> &gt; extfile.cnf
<span style="color: #b22222;"># </span><span style="color: #b22222;">6.&#20351;&#29992;&#26681;&#35777;&#20070;&#31614;&#21457;&#26381;&#21153;&#31471;&#35777;&#20070;</span>
openssl x509 -passin pass:$<span style="color: #a0522d;">PASSWORD</span> -req -days 365 -sha256 -in server.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out server-cert.pem -extfile extfile.cnf


<span style="color: #b22222;">#</span><span style="color: #b22222;">============================================#</span>
<span style="color: #b22222;">#          </span><span style="color: #b22222;">&#29992;&#26681;&#35777;&#20070;&#31614;&#21457;client&#31471;&#35777;&#20070;          #</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">============================================#</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">7.&#29983;&#25104;&#23458;&#25143;&#31471;&#31169;&#38053;</span>
openssl genrsa -out key.pem 4096
<span style="color: #b22222;"># </span><span style="color: #b22222;">8.&#29983;&#25104;&#23458;&#25143;&#31471;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;</span>
openssl req -subj <span style="color: #8b2252;">'/CN=client'</span> -new -key key.pem -out client.csr
<span style="color: #b22222;"># </span><span style="color: #b22222;">9.&#23458;&#25143;&#31471;&#35777;&#20070;&#37197;&#32622;&#25991;&#20214;</span>
<span style="color: #483d8b;">echo</span> extendedKeyUsage = clientAuth &gt; extfile.cnf
<span style="color: #b22222;"># </span><span style="color: #b22222;">10.&#20351;&#29992;&#26681;&#35777;&#20070;&#31614;&#21457;&#23458;&#25143;&#31471;&#35777;&#20070;</span>
openssl x509 -passin pass:$<span style="color: #a0522d;">PASSWORD</span> -req -days 365 -sha256 -in client.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out cert.pem -extfile extfile.cnf
<span style="color: #b22222;">#</span><span style="color: #b22222;">============================================#</span>
<span style="color: #b22222;">#                    </span><span style="color: #b22222;">&#28165;&#29702;                    #</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">============================================#</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#20013;&#38388;&#25991;&#20214;</span>
rm -f client.csr server.csr ca.srl extfile.cnf
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36716;&#31227;&#30446;&#24405;</span>
mkdir client server
cp {ca,cert,key}.pem client
cp {ca,server-cert,server-key}.pem server
rm {cert,key,server-cert,server-key}.pem
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#31169;&#38053;&#26435;&#38480;&#20026;&#21482;&#35835;</span>
chmod -f 0400 ca-key.pem server/server-key.pem client/key.pem
</pre>
</div>


<p>
执行服务端配置
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#32473;&#33050;&#26412;&#28155;&#21152;&#36816;&#34892;&#26435;&#38480;</span>
chmod +x tlscert.sh
<span style="color: #a0522d;">HOST_IP</span>=127.0.0.1
./tlscert.sh $<span style="color: #a0522d;">HOST_IP</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#38656;&#35201;&#30340;&#35777;&#20070;&#20445;&#23384;&#22312;client&#30446;&#24405;&#19979;, &#26381;&#21153;&#31471;&#38656;&#35201;&#30340;&#35777;&#20070;&#20445;&#23384;&#22312;server&#30446;&#24405;&#19979;</span>
sudo cp server/* /etc/docker
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;</span>
sudo vi /etc/default/docker
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25913;&#20026; DOCKER_OPTS="--selinux-enabled --tlsverify --tlscacert=/etc/docker/ca.pem --tlscert=/etc/docker/server-cert.pem --tlskey=/etc/docker/server-key.pem -H=unix:///var/run/docker.sock -H=0.0.0.0:2375"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37325;&#21551;docker</span>
sudo service docker restart
</pre>
</div>

<p>
正确的访问方式：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#21152;tls&#21442;&#25968;&#35775;&#38382;</span>
docker --tlsverify --tlscacert=client/ca.pem --tlscert=client/cert.pem --tlskey=client/key.pem -H tcp://127.0.0.1:2375 version
<span style="color: #b22222;"># </span><span style="color: #b22222;">Docker API&#26041;&#24335;&#35775;&#38382;</span>
curl https://127.0.0.1:2375/images/json --cert client/cert.pem --key client/key.pem --cacert client/ca.pem
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31616;&#21270;&#23458;&#25143;&#31471;&#35843;&#29992;&#21442;&#25968;&#37197;&#32622;</span>
sudo cp client/* ~/.docker
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36861;&#21152;&#29615;&#22659;&#21464;&#37327;</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"export DOCKER_HOST=tcp://$HOST_IP:2375 DOCKER_TLS_VERIFY=1"</span> &gt;&gt; ~/.bashrc
sudo docker version
</pre>
</div>
<p>
切记, 要保护好客户端证书, 这是连接服务端的凭证。另外根证书私钥也要保存好, 泄漏之后就能签发客户端证书了。
</p>

<p>
认证模式
</p>
<pre class="example" id="org7df9d66">
1. 服务端认证模式
选项  说明
tlsverify, tlscacert, tlscert, tlskey
向客户端发送服务端证书, 校验客户端证书是否由指定的CA(自签名根证书)签发

tls, tlscert, tlskey
向客户端发送服务端证书, 不校验客户端证书是否由指定的CA(自签名根证书)签发

2. 客户端认证模式
选项  说明
tls
校验服务端证书是否由 公共的CA机构签发

tlsverify, tlscacert
校验服务端证书是否由指定的CA(自签名根证书)签发

tls, tlscert, tlskey
使用客户端证书进行身份验证,  但不校验服务端证书是否由指定的CA(自签名根证书)签发

tlsverify, tlscacert, tlscert, tlskey
使用客户端证书进行身份验证且校验服务端证书是否由指定的CA(自签名根证书)签发
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b1dd4850-11c8-46f3-9c4f-61c883447b68" class="outline-3">
<h3 id="h:b1dd4850-11c8-46f3-9c4f-61c883447b68">mesos-slave安装</h3>
<div class="outline-text-3" id="text-h:b1dd4850-11c8-46f3-9c4f-61c883447b68">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">host_ip</span>=$(<span style="color: #ff00ff;">/usr/sbin/ifconfig eth0 | sed -n '/inet /p'| awk '{print $2}'</span>)
<span style="color: #a0522d;">host_name</span>=$(<span style="color: #ff00ff;">sed -rn "/$(/usr/sbin/ifconfig eth0 | sed -n '/inet /p'| awk '{print $2}'</span><span style="color: #8b2252;">)/s@[[:digit:]\.]+[[:space:]]+([[:alnum:]_-]+).*@\1@gp"</span> /etc/hosts)

sudo rpm -Uvh http://repos.mesosphere.com/el/7/noarch/RPMS/mesosphere-el-repo-7-1.noarch.rpm
sudo yum -y install mesos
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37197;&#32622;mesos-slave&#30340;--master&#21442;&#25968;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"zk://10.200.46.198:2181,10.200.46.199:2181,10.200.46.200:2181/mesos"</span> &gt;/etc/mesos/zk  
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37197;&#32622;mesos-slave&#30340;--hostname&#21442;&#25968;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$host_ip"</span> &gt; /etc/mesos-slave/ip
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$host_ip"</span> &gt; /etc/mesos-slave/hostname
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#24819;&#22312;marathon&#19978;&#36816;&#34892;docker&#65292;&#38656;&#35201;&#22312;slave&#19978;&#39069;&#22806;&#30340;&#37197;&#32622;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#20351;&#29992;docker&#23481;&#22120;&#21270;&#65292;&#37197;&#32622;slave&#30340; --containerizers&#21442;&#25968;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'docker,mesos'</span> &gt; /etc/mesos-slave/containerizers
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#26426;&#22120;&#23646;&#24615;</span>
mkdir /etc/mesos-slave/attributes
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$host_ip"</span> &gt;/etc/mesos-slave/attributes/host
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'main'</span> &gt; /etc/mesos-slave/attributes/hostgroup
systemctl enable mesos-slave &amp;&amp; systemctl stop  mesos-master &amp;&amp; systemctl disable mesos-master
systemctl start mesos-slave


[root@nginx001 ~]# curl -s -u wowotuan:wowotuan 172.16.0.22:8080/v2/apps?<span style="color: #a0522d;">embed</span>=apps.count|jq  <span style="color: #8b2252;">'.apps[]|.id ,.instances'</span> |sed -n <span style="color: #8b2252;">'{N;s/\n/  /p}'</span> |sort -nr -k2
<span style="color: #8b2252;">"/yuncapital-yzprod"</span>  2
... ...
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:8f42db72-15ac-4e71-a119-d6462828970e" class="outline-2">
<h2 id="h:8f42db72-15ac-4e71-a119-d6462828970e">Docker仓库</h2>
<div class="outline-text-2" id="text-h:8f42db72-15ac-4e71-a119-d6462828970e">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1. &#25289;&#21462;docker registry</span>
docker pull registry:2.5.0
<span style="color: #b22222;">#</span><span style="color: #b22222;">2. &#23433;&#35013;docker-compose</span>
curl -L <span style="color: #8b2252;">"https://github.com/docker/compose/releases/download/1.23.2/docker-compose-$(</span><span style="color: #ff00ff;">uname -s</span><span style="color: #8b2252;">)-$(</span><span style="color: #ff00ff;">uname -m</span><span style="color: #8b2252;">)"</span> -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
<span style="color: #b22222;">#</span><span style="color: #b22222;">3. &#36890;&#36807;distribution &#26469;&#23433;&#35013;registry</span>
git clone https://github.com/docker/distribution.git
<span style="color: #483d8b;">cd</span> distribution/
git checkout release/2.0
<span style="color: #483d8b;">cd</span> contrib/compose/nginx/

<span style="color: #a0522d;">NAME</span>=my.registry.cici.me
<span style="color: #a0522d;">COUNTRY</span>=CN
<span style="color: #a0522d;">PROVINCE</span>=BEIJING
<span style="color: #a0522d;">CITY</span>=BEIJING
<span style="color: #a0522d;">ORGANIZATION</span>=$<span style="color: #a0522d;">NAME</span>
<span style="color: #a0522d;">GROUP</span>=$<span style="color: #a0522d;">NAME</span>
<span style="color: #a0522d;">HOST</span>=$<span style="color: #a0522d;">NAME</span>
<span style="color: #a0522d;">EMAIL</span>=baijunhua@cicinet.com
<span style="color: #a0522d;">SUBJ</span>=<span style="color: #8b2252;">"/C=$COUNTRY/ST=$PROVINCE/L=$CITY/O=$ORGANIZATION/OU=$GROUP/CN=$HOST/emailAddress=$EMAIL"</span>

openssl genrsa -out $<span style="color: #a0522d;">NAME</span>.pem 2048
openssl req -new -sha256 -key $<span style="color: #a0522d;">NAME</span>.pem -out $<span style="color: #a0522d;">NAME</span>.csr -subj <span style="color: #8b2252;">"$SUBJ"</span>
openssl x509 -req -days 3650 -in $<span style="color: #a0522d;">NAME</span>.csr -signkey $<span style="color: #a0522d;">NAME</span>.pem -out $<span style="color: #a0522d;">NAME</span>.crt

<span style="color: #b22222;">#</span><span style="color: #b22222;">4. &#23433;&#35013;httpd-tools &#29983;&#25104;&#23494;&#30721;</span>
yum install httpd-tools -y
htpasswd -c .htpasswd wowotuanops
registrywowotuan
<span style="color: #b22222;">#</span><span style="color: #b22222;">5. &#20462;&#25913;dockerfile</span>
&#21024;&#38500;COPY docker-registry.conf /etc/nginx/docker-registry.conf
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"COPY .htpasswd /etc/nginx/.htpasswd"</span> &gt;&gt;Dockerfile
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"COPY $NAME.pem /etc/nginx/$NAME.pem"</span> &gt;&gt;Dockerfile
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"COPY $NAME.crt /etc/nginx/$NAME.crt"</span> &gt;&gt;Dockerfile
<span style="color: #b22222;">#</span><span style="color: #b22222;">6. &#32534;&#36753;registry.conf&#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#65306;mesos&#38598;&#32676;&#21152;hosts&#35299;&#26512;</span>
cat &gt;registry.conf&lt;&lt;EOF
<span style="color: #ffa54f;"># Docker registry proxy for api versions 1 and 2</span>

<span style="color: #ffa54f;">upstream docker-registry-v2 {</span>
<span style="color: #ffa54f;">  ip_hash;</span>
<span style="color: #ffa54f;">  server registryv2:5000;</span>
<span style="color: #ffa54f;">}</span>

<span style="color: #ffa54f;">upstream docker-registry-api {</span>
<span style="color: #ffa54f;">  ip_hash;</span>
<span style="color: #ffa54f;">  server registryapi:5000;</span>
<span style="color: #ffa54f;">}</span>

<span style="color: #ffa54f;"># No client auth or TLS</span>
<span style="color: #ffa54f;">server {</span>
<span style="color: #ffa54f;">  listen 5000;</span>
<span style="color: #ffa54f;">  server_name $NAME.me;</span>

<span style="color: #ffa54f;">  # disable any limits to avoid HTTP 413 for large image uploads</span>
<span style="color: #ffa54f;">  client_max_body_size 0;</span>

<span style="color: #ffa54f;">  # required to avoid HTTP 411: see Issue #1486 (https://github.com/docker/docker/issues/1486)</span>
<span style="color: #ffa54f;">  chunked_transfer_encoding on;</span>

<span style="color: #ffa54f;">  # for ssl</span>
<span style="color: #ffa54f;">  ssl on;</span>
<span style="color: #ffa54f;">  ssl_certificate /etc/nginx/$NAME.crt;</span>
<span style="color: #ffa54f;">  ssl_certificate_key /etc/nginx/$NAME.pem;</span>

<span style="color: #ffa54f;">  location /v2/ {</span>
<span style="color: #ffa54f;">    # Do not allow connections from docker 1.5 and earlier</span>
<span style="color: #ffa54f;">    # docker pre-1.6.0 did not properly set the user agent on ping, catch "Go *" user agents</span>
<span style="color: #ffa54f;">    auth_basic "registry v2 realm";</span>
<span style="color: #ffa54f;">    auth_basic_user_file /etc/nginx/.htpasswd;</span>
<span style="color: #ffa54f;">    add_header 'Docker-Distribution-Api-Version' 'registry/2.0' always;</span>

<span style="color: #ffa54f;">    include               docker-registry-v2.conf;</span>
<span style="color: #ffa54f;">    }</span>
<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">server {</span>
<span style="color: #ffa54f;">  listen 5001;</span>
<span style="color: #ffa54f;">  server_name $NAME.me;</span>

<span style="color: #ffa54f;">  # disable any limits to avoid HTTP 413 for large image uploads</span>
<span style="color: #ffa54f;">  client_max_body_size 0;</span>

<span style="color: #ffa54f;">  # required to avoid HTTP 411: see Issue #1486 (https://github.com/docker/docker/issues/1486)</span>
<span style="color: #ffa54f;">  chunked_transfer_encoding on;</span>

<span style="color: #ffa54f;">  location /search/imagesinfo {</span>
<span style="color: #ffa54f;">proxy_set_header  Host              $http_host;   # required for docker client's sake</span>
<span style="color: #ffa54f;">proxy_set_header  X-Real-IP         $remote_addr; # pass on real client's IP</span>
<span style="color: #ffa54f;">proxy_set_header  X-Forwarded-For   $proxy_add_x_forwarded_for;</span>
<span style="color: #ffa54f;">proxy_set_header  X-Forwarded-Proto $scheme;</span>
<span style="color: #ffa54f;">proxy_read_timeout                  900;</span>
<span style="color: #ffa54f;">    proxy_pass  http://docker-registry-api;</span>
<span style="color: #ffa54f;">  }</span>

<span style="color: #ffa54f;">  location /repositories {</span>
<span style="color: #ffa54f;">proxy_set_header  Host              $http_host;   # required for docker client's sake</span>
<span style="color: #ffa54f;">proxy_set_header  X-Real-IP         $remote_addr; # pass on real client's IP</span>
<span style="color: #ffa54f;">proxy_set_header  X-Forwarded-For   $proxy_add_x_forwarded_for;</span>
<span style="color: #ffa54f;">proxy_set_header  X-Forwarded-Proto $scheme;</span>
<span style="color: #ffa54f;">proxy_read_timeout                  900;</span>
<span style="color: #ffa54f;">    proxy_pass http://docker-registry-api;</span>
<span style="color: #ffa54f;">  }</span>
<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">EOF</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">7. &#20462;&#25913;docker-compose.yml</span>
<span style="color: #483d8b;">cd</span> ..
cat &gt;docker-compose.yml &lt;&lt;\EOF
<span style="color: #ffa54f;">nginx:</span>
<span style="color: #ffa54f;">  build: "nginx"</span>
<span style="color: #ffa54f;">  ports:</span>
<span style="color: #ffa54f;">    - "5000:5000"</span>
<span style="color: #ffa54f;">    - "443:5000"</span>
<span style="color: #ffa54f;">    - "80:5001"</span>
<span style="color: #ffa54f;">  links:</span>
<span style="color: #ffa54f;">    - registryv2:registryv2</span>
<span style="color: #ffa54f;">    - registryapi:registryapi</span>
<span style="color: #ffa54f;">registryv2:</span>
<span style="color: #ffa54f;">  image: myegistry.55tuan.me:443/registry:2.5.0</span>
<span style="color: #ffa54f;">  ports:</span>
<span style="color: #ffa54f;">    - "5000"</span>
<span style="color: #ffa54f;">  volumes:</span>
<span style="color: #ffa54f;">    - /data/registryv2/registry:/etc/docker/registry</span>
<span style="color: #ffa54f;">    - /data/registryv2/data:/var/lib/registry</span>
<span style="color: #ffa54f;">registryapi:</span>
<span style="color: #ffa54f;">  image: myregistry.55tuan.me:443/regisitryweb:v1</span>
<span style="color: #ffa54f;">  ports:</span>
<span style="color: #ffa54f;">    - "5001:5000"</span>
<span style="color: #ffa54f;">  volumes:</span>
<span style="color: #ffa54f;">    - /data/registryv2/data:/data/registryv2/data</span>
<span style="color: #ffa54f;">EOF</span>

mkdir /data/registryv2/{registry,data} -pv
cat &gt;/data/registryv2/registry/config.yml&lt;&lt;\EOF
<span style="color: #ffa54f;">version: 0.1</span>
<span style="color: #ffa54f;">log:</span>
<span style="color: #ffa54f;">  level: info</span>
<span style="color: #ffa54f;">  fields:</span>
<span style="color: #ffa54f;">    service: registry</span>
<span style="color: #ffa54f;">#notifications:</span>
<span style="color: #ffa54f;">##  endpoints:</span>
<span style="color: #ffa54f;">##    - name: local-python-8000</span>
<span style="color: #ffa54f;">##      url: http://10.9.120.24:8000/</span>
<span style="color: #ffa54f;">##      timeout: 1s</span>
<span style="color: #ffa54f;">##      threshold: 10</span>
<span style="color: #ffa54f;">##      backoff: 1s</span>
<span style="color: #ffa54f;">##      disabled: false</span>
<span style="color: #ffa54f;">storage:</span>
<span style="color: #ffa54f;">  cache:</span>
<span style="color: #ffa54f;">    blobdescriptor: inmemory</span>
<span style="color: #ffa54f;">  filesystem:</span>
<span style="color: #ffa54f;">    rootdirectory: /var/lib/registry</span>
<span style="color: #ffa54f;">  delete:</span>
<span style="color: #ffa54f;">    enabled: true</span>
<span style="color: #ffa54f;">http:</span>
<span style="color: #ffa54f;">  addr: :5000</span>
<span style="color: #ffa54f;">EOF</span>

</pre>
</div>
</div>
</section>
<section id="outline-container-h:3ba1b3e2-364b-43df-8ebc-c40aa1e6c0e2" class="outline-2">
<h2 id="h:3ba1b3e2-364b-43df-8ebc-c40aa1e6c0e2">添加节点脚本-add-mesos.sh</h2>
<div class="outline-text-2" id="text-h:3ba1b3e2-364b-43df-8ebc-c40aa1e6c0e2">
<div class="org-src-container">
<pre class="src src-sh">cat add-mesos.sh 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #b22222;">###</span><span style="color: #b22222;">time:2018-9-19</span>

<span style="color: #a0522d;">ip</span>=<span style="color: #ff00ff;">`ifconfig  eth0|grep 'inet '|awk '{print $2}'`</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">192.168.100.247  mesos-master1</span>
<span style="color: #8b2252;">192.168.101.150 mesos-master2</span>
<span style="color: #8b2252;">192.168.101.151 mesos-master3</span>
<span style="color: #8b2252;">192.168.100.249 mesos-slave1</span>
<span style="color: #8b2252;">192.168.100.251 mesos-slave2</span>
<span style="color: #8b2252;">192.168.100.250 mesos-slave3</span>
<span style="color: #8b2252;">192.168.101.152 mesos-slave4</span>
<span style="color: #8b2252;">192.168.101.153 mesos-slave5</span>
<span style="color: #8b2252;">192.168.101.166 mesos-slave6</span>
<span style="color: #8b2252;">192.168.101.167 mesos-slave7</span>
<span style="color: #8b2252;">192.168.101.181 mesos-slave8</span>
<span style="color: #8b2252;">192.168.101.182 mesos-slave9</span>
<span style="color: #8b2252;">192.168.101.183 mesos-slave10</span>
<span style="color: #8b2252;">192.168.101.184 mesos-slave11</span>
<span style="color: #8b2252;">192.168.101.192 mesos-slave12</span>
<span style="color: #8b2252;">192.168.101.193 mesos-slave13</span>
<span style="color: #8b2252;">192.168.101.194 mesos-slave14</span>
<span style="color: #8b2252;">192.168.101.195 mesos-slave15</span>

<span style="color: #8b2252;">116.213.103.33 msg.cici</span>
<span style="color: #8b2252;">192.168.100.44 ldapserver-44.zke.cici</span>
<span style="color: #8b2252;">192.168.101.106 ldapserver-106.zke.cici</span>
<span style="color: #8b2252;">192.168.101.184 mesos-slave-11</span>
<span style="color: #8b2252;">"""</span> &gt;&gt; /etc/hosts
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">nameserver 192.168.100.44</span>
<span style="color: #8b2252;">nameserver 192.168.101.106</span>
<span style="color: #8b2252;">"""</span> &gt;  /etc/resolv.conf 

rpm -Uhv http://repos.mesosphere.com/el/7/noarch/RPMS/mesosphere-el-repo-7-2.noarch.rpm
rpm -ivh https://mirrors.aliyun.com/epel/epel-release-latest-7.noarch.rpm
yum install -y yum-utils device-mapper-persistent-data  xfsprogs  lvm2 gcc*  install zlib-devel curl-devel openssl-devel httpd-devel apr-devel apr-util-devel mysql-devel libffi-devel 

<span style="color: #a020f0;">if</span> [ ! -b <span style="color: #8b2252;">"/dev/vdb1"</span> ];<span style="color: #a020f0;">then</span>
parted -s /dev/vdb mklabel gpt
parted -s /dev/vdb mkpart primary 0 100%
mkfs.xfs /dev/vdb1
<span style="color: #a020f0;">else</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"/dev/vdb1 exist"</span>
<span style="color: #a020f0;">fi</span>

<span style="color: #a020f0;">if</span> [ ! -b <span style="color: #8b2252;">"/dev/vdc1"</span> ];<span style="color: #a020f0;">then</span>
parted -s /dev/vdc mklabel gpt
parted -s /dev/vdc mkpart primary 0 100%
mkfs.xfs /dev/vdc1
<span style="color: #a020f0;">else</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"/dev/vdc1 exist"</span>
<span style="color: #a020f0;">fi</span>

<span style="color: #a020f0;">if</span> [ ! -d <span style="color: #8b2252;">"/data"</span> ];<span style="color: #a020f0;">then</span>
    mkdir /data
<span style="color: #a020f0;">fi</span>
cat /etc/fstab |grep -E <span style="color: #8b2252;">"/data|/dev/vdc1"</span>
<span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">?</span> ];<span style="color: #a020f0;">then</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"/dev/vdc1                /data                   xfs     defaults        0 0"</span> &gt;&gt;/etc/fstab
mount -a
<span style="color: #a020f0;">fi</span>



<span style="color: #b22222;">###</span><span style="color: #b22222;">devicemapper</span>
pvcreate /dev/vdb1&lt;&lt;EOF
<span style="color: #ffa54f;">y</span>

<span style="color: #ffa54f;">EOF</span>
vgcreate docker /dev/vdb1
lvcreate --wipesignatures y -n thinpool docker -l 95%VG&lt;&lt;EOF
<span style="color: #ffa54f;">y</span>

<span style="color: #ffa54f;">EOF</span>
lvcreate --wipesignatures y -n thinpoolmeta docker -l 1%VG&lt;&lt;EOF
<span style="color: #ffa54f;">y</span>

<span style="color: #ffa54f;">EOF</span>
lvconvert -y --zero n -c 512K --thinpool docker/thinpool --poolmetadata docker/thinpoolmeta
cat &gt;&gt; /etc/lvm/profile/docker-thinpool.profile &lt;&lt; EOF
<span style="color: #ffa54f;">activation {</span>
<span style="color: #ffa54f;">    thin_pool_autoextend_threshold=80</span>
<span style="color: #ffa54f;">    thin_pool_autoextend_percent=20</span>
<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">EOF</span>
lvchange --metadataprofile docker-thinpool docker/thinpool

<span style="color: #483d8b;">cd</span>
wget http://192.168.101.104/mesos/ruby-2.2.7.tar.gz
tar -zxf ruby-2.2.7.tar.gz
<span style="color: #483d8b;">cd</span> ruby-2.2.7
./configure 
make -j 3
make install
<span style="color: #483d8b;">cd</span> /root/ruby-2.2.7/ext/zlib
ruby ./extconf.rb
make
make install
<span style="color: #483d8b;">cd</span> /root/ruby-2.2.7/ext/openssl
ln -s /root/ruby-2.2.7/include/ /
ruby extconf.rb
make  -j 3
make install
<span style="color: #483d8b;">cd</span> /usr/local/bin/ 
./gem sources --remove https://rubygems.org/
gem sources -a https://gems.ruby-china.com/
./gem install certificate_authority
<span style="color: #483d8b;">cd</span> 
wget http://192.168.101.104/mesos/certgen1.rb
ruby certgen1.rb  $<span style="color: #a0522d;">ip</span>
<span style="color: #a020f0;">if</span> [ ! -d <span style="color: #8b2252;">"/root/.docker/$ip/"</span> ];<span style="color: #a020f0;">then</span>
<span style="color: #483d8b;">cd</span>
ruby certgen1.rb  $<span style="color: #a0522d;">ip</span>
<span style="color: #a020f0;">fi</span>
mkdir  /etc/docker
cp /root/.docker/$<span style="color: #a0522d;">ip</span>/* /etc/docker
<span style="color: #483d8b;">cd</span>
wget http://192.168.101.104/mesos/docker-engine-1.10.3-1.el7.centos.x86_64.rpm
wget http://192.168.101.104/mesos/docker-engine-selinux-1.10.3-1.el7.centos.noarch.rpm
wget -O /etc/pki/ca-trust/source/anchors/hb2.registry.cici.crt http://192.168.101.104/mesos/hb2.registry.cici.crt
update-ca-trust extract 

yum localinstall -y docker-engine*
wget -O /usr/lib/systemd/system/docker.service  http://192.168.101.104/mesos/docker.service
systemctl daemon-reload
systemctl start docker &amp;&amp; systemctl enable docker

docker login -u wowotuanops -p registrywowotuan -e baijunhua@cicinet.com hb2.registry.cici:443
<span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">?</span> -eq 0 ];<span style="color: #a020f0;">then</span>
<span style="color: #483d8b;">cd</span> /root &amp;&amp; tar -czvf /etc/docker.tar.gz .docker/
<span style="color: #483d8b;">cd</span>
<span style="color: #a020f0;">else</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"docker login err"</span>
<span style="color: #a020f0;">fi</span>

yum install mesos -y
mkdir -p /etc/mesos-slave/attributes
<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">ip</span> &gt; /etc/mesos-slave/attributes/host
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'main'</span> &gt; /etc/mesos-slave/attributes/hostgroup
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'zk://192.168.100.247:2181,192.168.101.150:2181,192.168.101.151:2181/mesos'</span> &gt; /etc/mesos/zk
<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">ip</span> &gt; /etc/mesos-slave/hostname
<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">ip</span> &gt; /etc/mesos-slave/ip
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'docker,mesos'</span> &gt; /etc/mesos-slave/containerizers

<span style="color: #b22222;">#</span><span style="color: #b22222;">systemctl enable mesos-slave &amp;&amp; systemctl start  mesos-slave &amp;&amp; systemctl disable mesos-master</span>

wget -O /usr/bin/consul  http://192.168.101.104/mesos/consul
wget -O /etc/systemd/system/consul.service http://192.168.101.104/mesos/consul.service
chmod +x /usr/bin/consul 
sed -i <span style="color: #8b2252;">"s/IP/$ip/g"</span> /etc/systemd/system/consul.service
systemctl daemon-reload
<span style="color: #b22222;">#</span><span style="color: #b22222;">systemctl start consul  &amp;&amp; systemctl enable consul </span>

 docker run --restart=<span style="color: #8b2252;">'always'</span> -d --name=registrator --hostname=${<span style="color: #a0522d;">ip</span>} --volume=/var/run/docker.sock:/tmp/docker.sock   hb2.registry.cici:443/registrator:v7 -ip ${<span style="color: #a0522d;">ip</span>} consul://${<span style="color: #a0522d;">ip</span>}:8500

pip install prometheus_client

<span style="color: #483d8b;">cd</span> /home 
wget http://192.168.101.104/mesos/sh.tar.gz
tar zxf sh.tar.gz
<span style="color: #483d8b;">cd</span> /data
wget http://192.168.101.104/mesos/check_jvm.tar.gz
tar -zxf check_jvm.tar.gz
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">*/1 * * * *  /usr/bin/python /home/sh/altersms.py</span>
<span style="color: #8b2252;">0 */6 * * *  cd /data/check_jvm/ &amp;&amp; /bin/sh /data/check_jvm/check_jvm_Running.sh</span>
<span style="color: #8b2252;">"""</span>&gt;&gt;/var/spool/cron/root
</pre>
</div>
</div>
</section>
<section id="outline-container-h:eb707312-ba2e-45cb-ba73-cc872db0d68b" class="outline-2">
<h2 id="h:eb707312-ba2e-45cb-ba73-cc872db0d68b">nginx with consul-template</h2>
<div class="outline-text-2" id="text-h:eb707312-ba2e-45cb-ba73-cc872db0d68b">
<p>
<a href="https://book-consul-guide.vnzmi.com/11_consul_template.html">https://book-consul-guide.vnzmi.com/11_consul_template.html</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">
<span style="color: #b22222;"># </span><span style="color: #b22222;">nginx with consul-template</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">1. &#26597;&#30475;marathon&#65292;&#24182;&#25214;&#20986;&#23545;&#24212;&#30340;&#24212;&#29992;</span>
&#35775;&#38382;http://IP:8080/ &#25214;&#21040;&#23545;&#24212;&#24212;&#29992;&#30340;configuration&#65292;<span style="color: #a0522d;">&#22914;container_uuid</span>=cross-bmserver-yzprod-10580
<span style="color: #b22222;"># </span><span style="color: #b22222;">2. &#32534;&#20889;consul-template&#27169;&#26495;</span>
&#22914;
[root@tc-xy-nginx001 vhosts]# head xr-cicinet.ctmpl
upstream yzbizcenter-api-yzprod-11045 {
    {{range service <span style="color: #8b2252;">"yzbizcenter-api-yzprod-11045"</span>}}server {{.Address}}:{{.Port}};{{<span style="color: #a020f0;">else</span>}}server 1.1.1.1:8000;{{end}}
}

<span style="color: #b22222;"># </span><span style="color: #b22222;">3. &#21033;&#29992;&#33050;&#26412;&#29983;&#25104;consul-template&#26381;&#21153;</span>
[root@tc-xy-nginx001 ~]# cd /home/sh/add-template/
[root@tc-xy-nginx001 add-template]# ll
total 112
-rwxr-xr-x 1 root root  579 Dec 14 14:07 add-nginx-consul-template.sh
-rw-r--r-- 1 root root  213 Jan 14 17:30 consul.cfg
-rw-r--r-- 1 root root  453 Dec 14 14:00 consul-template.service
[root@tc-xy-nginx001 add-template]# cat add-nginx-consul-template.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #a0522d;">path</span>=../add-template
<span style="color: #a020f0;">if</span> [ ! -n <span style="color: #8b2252;">"$1"</span> ] ;<span style="color: #a020f0;">then</span>
  <span style="color: #483d8b;">echo</span> $<span style="color: #8b2252;">"usage: $0 nginx-templates-name"</span>
<span style="color: #a020f0;">else</span>
  <span style="color: #a020f0;">if</span> [ -f /etc/$<span style="color: #a0522d;">1</span>.cfg -a -f /etc/systemd/system/consul-template-$<span style="color: #a0522d;">1</span>.service ];<span style="color: #a020f0;">then</span>
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$1 already exists!!!"</span>
    <span style="color: #a020f0;">exit</span> 1
  <span style="color: #a020f0;">else</span>
    cp -f consul.cfg $<span style="color: #a0522d;">1</span>.cfg
    sed -i s/TEMPLATE/$<span style="color: #a0522d;">1</span>/g $<span style="color: #a0522d;">1</span>.cfg
    cp -f $<span style="color: #a0522d;">1</span>.cfg /etc/
    cp -f consul-template.service consul-template-$<span style="color: #a0522d;">1</span>.service
    sed -i s/TEMPLATE/$<span style="color: #a0522d;">1</span>/g consul-template-$<span style="color: #a0522d;">1</span>.service
    cp -f consul-template-$<span style="color: #a0522d;">1</span>.service  /etc/systemd/system/
    <span style="color: #b22222;">#</span><span style="color: #b22222;">systemctl daemon-reload</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">systemctl enable consul-template-$1.service</span>
  <span style="color: #a020f0;">fi</span>
<span style="color: #a020f0;">fi</span>

[root@tc-xy-nginx001 add-template]# cat consul.cfg
consul = <span style="color: #8b2252;">"192.168.100.9:8500"</span>
template {
  <span style="color: #483d8b;">source</span> = <span style="color: #8b2252;">"/usr/local/nginx/conf/vhosts/TEMPLATE.ctmpl"</span>
  destination = <span style="color: #8b2252;">"/usr/local/nginx/conf/vhosts/TEMPLATE.conf"</span>
  <span style="color: #483d8b;">command</span> = <span style="color: #8b2252;">"/usr/local/nginx/sbin/nginx -s reload"</span>
}

</pre>
</div>

<p>
注意：template会实时发现consul集群中容器变化，如果有变化，则重载nginx。
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@tc-xy-nginx001 add-template]# cat consul-template.service
<span style="color: #b22222;"># </span><span style="color: #b22222;">this is consul-template systemd script</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Version: 1.0</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Descripthin: consul</span>
[Unit]
<span style="color: #a0522d;">Description</span>=Consul-template
<span style="color: #a0522d;">After</span>=network.target
[Service]
<span style="color: #a0522d;">ExecStart</span>=/usr/bin/consul-template --config /etc/TEMPLATE.cfg
<span style="color: #b22222;">#</span><span style="color: #b22222;">ExecStop=/usr/bin/killall -9 /usr/bin/consul-template</span>
<span style="color: #a0522d;">ExecStop</span>=/usr/bin/ps aux | /usr/bin/grep <span style="color: #8b2252;">"consul-template"</span>| /usr/bin/grep TEMPLATE | /usr/bin/grep -v grep | /usr/bin/awk <span style="color: #8b2252;">'{print $2}'</span> | /usr/bin/xargs kill

[Install]
<span style="color: #a0522d;">WantedBy</span>=default.target
</pre>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
