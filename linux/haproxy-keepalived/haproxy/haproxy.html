<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: 企业级反向代理HAProxy</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux: 企业级反向代理HAProxy</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:7d973690-8b6e-43a4-9841-ada7b685dd34">1 web架构介绍</a>
<ul>
<li><a href="#h:472c5949-e96c-4acb-8b57-85434bdbe57f">1.1 单机房架构</a></li>
<li><a href="#h:c58a8a84-1fc7-49e3-9319-c389e8d29077">1.2 多机房架构</a></li>
<li><a href="#h:cb9f1b15-5b1a-4068-86d2-8b7adb50c1c3">1.3 公有云架构</a></li>
<li><a href="#h:c502bcd8-0ea7-49da-b08e-ababad438844">1.4 私有云架构</a></li>
</ul>
</li>
<li><a href="#h:9f030405-1037-4e73-9913-2075a4740b27">2 负载均衡简介</a>
<ul>
<li><a href="#h:3ae33ce2-8a58-4d24-b950-7a8e861deaca">2.1 为什么使用负载均衡</a></li>
<li><a href="#h:64f7fdcf-8478-40f7-ba92-55e022ec804e">2.2 负载均衡类型</a></li>
<li><a href="#h:4098eb12-94e2-4d5d-8e7e-28f0478ec435">2.3 应用场景</a></li>
<li><a href="#h:b187f551-f34d-4935-a716-9756d23664cb">2.4 HAProxy介绍</a>
<ul>
<li><a href="#h:9cd64e4a-0c7d-461c-b83f-7d43f9cdf4bd">2.4.1 企业版</a></li>
<li><a href="#h:56ddf139-0f40-4145-aab3-a09afad41e6e">2.4.2 社区版</a></li>
<li><a href="#h:d330ffad-548f-49aa-b688-906836028b30">2.4.3 版本对比</a></li>
<li><a href="#h:b3b65c2b-f1b5-4db1-81b8-b1f67f9e1627">2.4.4 HAProxy功能</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:db45b6a2-2ba6-4636-a1af-bd68d1d68198">3 HAProxy安装及基础配置</a>
<ul>
<li><a href="#h:9b132497-dc44-426b-a048-64e8667070f5">3.1 Ubuntu 安装</a></li>
<li><a href="#h:e63991d4-8aa6-4f88-82f3-8c319073a126">3.2 CentOS 安装</a>
<ul>
<li><a href="#h:28565d3e-7c32-40cf-afa1-af49a3c17f6e">3.2.1 系统默认yum源</a></li>
<li><a href="#h:f22db7de-e600-4347-9d01-d4939e1edfa6">3.2.2 第三方安装包</a></li>
</ul>
</li>
<li><a href="#h:e687c0f2-c113-41c0-bcad-8a3b072ee210">3.3 编译安装 HAProxy</a>
<ul>
<li><a href="#h:c1a41f80-f444-463e-8066-fc25d2a70ef3">3.3.1 解决 lua 环境</a>
<ul>
<li><a href="#h:960a2fd6-69e5-4c52-a103-8f2d12ea2189">3.3.1.1 CentOS 基础环境</a></li>
<li><a href="#h:c8492985-7897-4d1b-97fe-619ca7498ae1">3.3.1.2 Ubuntu 基础环境</a></li>
</ul>
</li>
<li><a href="#h:12eab8fc-9935-4c1a-806b-cf67c4e3c2b9">3.3.2 编译安装HAProxy</a></li>
<li><a href="#h:8731dcf8-c131-4262-bf4f-d49cbeb7dcb3">3.3.3 验证HAProxy版本</a></li>
<li><a href="#h:47c70578-9b65-4d9d-a5a0-fb18e2495eac">3.3.4 HAProxy启动文件</a></li>
<li><a href="#h:793ca369-4500-4bce-a26e-dac0ae03929a">3.3.5 配置文件</a></li>
<li><a href="#h:dac37d38-55b8-4ee9-8c3e-0aaaa0836bdd">3.3.6 启动 haproxy</a></li>
<li><a href="#h:b41caa40-0b75-4e7e-9482-45a4a7baef4d">3.3.7 验证 haproxy 状态</a></li>
<li><a href="#h:1607ff62-d07b-4986-ac69-aa1a6a183ed1">3.3.8 查看haproxy的状态页面</a></li>
</ul>
</li>
<li><a href="#h:f24718b5-a256-4665-abda-ea5862ca86d3">3.4 基础配置详解</a>
<ul>
<li><a href="#h:2be53b22-25fc-4a80-ad7e-5e5665207627">3.4.1 global配置</a>
<ul>
<li><a href="#h:554416e2-079f-4d97-9112-9092797b9b89">3.4.1.1 global 配置参数说明</a></li>
<li><a href="#h:f1eb11ce-6ef2-4f1a-9b54-b9dc3f1cfd19">3.4.1.2 多进程和线程</a></li>
<li><a href="#h:d3469130-e2d0-4ec8-aad3-262f64f8f852">3.4.1.3 HAProxy日志配置</a></li>
<li><a href="#h:fa3a00ab-d48d-4a09-ba58-84284df41d00">3.4.1.3.3 验证HAProxy日志</a></li>
</ul>
</li>
<li><a href="#h:187099ee-dfe4-4627-a53e-91c8254cf2c5">3.4.2 Proxies配置</a>
<ul>
<li><a href="#h:39278c57-4e79-4cf7-96a0-a2ee9c576283">3.4.2.1 Proxies配置-defaults</a></li>
<li><a href="#h:46e47a12-f057-498a-a3cc-0ac9b8d73489">3.4.2.2 Proxies配置-listen 简化配置</a></li>
<li><a href="#h:87701129-e96f-47a0-abbd-d3e83b4cbf93">3.4.2.3 Proxies配置-frontend</a></li>
<li><a href="#h:e6e6478d-eee5-4887-bbe0-aeba35df1096">3.4.2.4 Proxies配置-backend</a></li>
<li><a href="#h:a3c932d7-b9ad-4b6f-b7df-b64a62231f7d">3.4.2.5 frontend+backend 配置实例</a></li>
</ul>
</li>
<li><a href="#h:7747d976-ffa3-4ab7-8791-97538101f63c">3.4.3 使用子配置文件保存配置</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:9de26cb4-f854-43f1-acb1-a0199b1c0026">4 HAProxy调度算法</a>
<ul>
<li><a href="#h:742d7129-92fb-449f-be33-e5741c7523ce">4.1 静态算法</a>
<ul>
<li><a href="#h:cd26a676-528d-4772-9cff-7308d839e5cd">4.1.1 socat 工具</a></li>
</ul>
</li>
<li><a href="#h:20c87e47-49ba-48dc-b013-db82bded6109">4.1.2 static-rr</a></li>
<li><a href="#h:756a9443-61df-415a-b1a8-d455206a43a0">4.1.3 first</a></li>
<li><a href="#h:ff65344c-4b61-4c57-8838-b291f43a20b0">4.2 动态算法</a>
<ul>
<li><a href="#h:49e3c5a8-93a2-407c-9c60-63b3cd64b52c">4.2.1 roundrobin</a></li>
<li><a href="#h:762b8361-bf6e-493d-947a-834141d254d6">4.2.2 leastconn</a></li>
<li><a href="#h:5273a6f8-a876-4bb5-84ec-f6be43fac379">4.2.3 random</a></li>
</ul>
</li>
<li><a href="#h:1d4d6dd3-abbf-442e-b8bc-be43aa395cff">4.3 其他算法</a>
<ul>
<li><a href="#h:95edb29f-0536-4650-b147-168a9c6c83e7">4.3.1 source</a>
<ul>
<li><a href="#h:8855e0c7-63a1-4c89-b778-35c43d352e0d">4.3.1.1 map-base 取模法</a></li>
<li><a href="#h:a4740d2a-609f-4221-a1a1-831c3ba20c9c">4.3.1.2 一致性hash</a></li>
<li><a href="#h:9eea5d5b-b29b-42a4-b05f-12c95e4072f2">4.3.1.2.1 hash对象</a></li>
<li><a href="#h:e856ea54-d9a9-4971-b372-1d9d7d068ed6">4.3.1.2.2 一致性hash示意图</a></li>
<li><a href="#h:ef29cf34-d26c-40ec-83da-ea4d0d179a94">4.3.1.2.3 一致性hash配置示例</a></li>
</ul>
</li>
<li><a href="#h:3d6bbc2d-230e-4b9e-8530-f7484aab5dbb">4.3.2 uri</a>
<ul>
<li><a href="#h:8f8affe5-19c4-4cd8-a56a-d8b169b8a94c">4.3.2.1 uri 取模法配置示例</a></li>
<li><a href="#h:0d7289a7-2e61-45a4-aba4-0968e4d84fec">4.3.2.2 uri 一致性hash配置示例</a></li>
<li><a href="#h:6629850b-b88f-40d3-aed9-c769d15856f0">4.3.2.3 访问测试</a></li>
</ul>
</li>
<li><a href="#h:ef50b45b-66b6-40b2-b923-b73d62a0a5f7">4.3.3 url_param</a>
<ul>
<li><a href="#h:4d439ef4-d734-4706-bccf-1030f78d9820">4.3.3.1 url_param取模法配置示例</a></li>
<li><a href="#h:86b2e653-52b1-4391-8d58-1de20c6fc292">4.3.3.2 url_param一致性hash配置示例</a></li>
<li><a href="#h:0bdefb2d-c6c8-4c8a-9860-be77966a0e53">4.3.3.3 测试访问</a></li>
</ul>
</li>
<li><a href="#h:c51f886d-050c-48b1-bf4f-2ccfb075a2bf">4.3.4 hdr</a>
<ul>
<li><a href="#h:6954e430-fb0b-47cc-8226-885a12430c8e">4.3.4.1 hdr取模法配置示例</a></li>
<li><a href="#h:0ae01129-8d47-4222-87d9-9519b652c4d4">4.3.4.2 一致性hash配置示例</a></li>
<li><a href="#h:ebca1d83-44be-4eb4-afb8-967050e10063">4.3.4.3 测试访问</a></li>
</ul>
</li>
<li><a href="#h:624e5fa0-94c3-44b1-a55f-0382b78ce077">4.3.5 rdp-cookie</a>
<ul>
<li><a href="#h:5f9cd6b4-b8c9-402e-bb75-80f174725006">4.3.5.1 rdp-cookie 取模法配置示例</a></li>
<li><a href="#h:e3dced8b-d2be-4965-8c94-7276bdced304">4.3.5.2 rdp-cookie 一致性hash配置示例</a></li>
<li><a href="#h:d6c2bdfe-582f-4754-a7e2-ff356e406882">4.3.5.3 基于iptables实现RDP协议转发</a></li>
</ul>
</li>
<li><a href="#h:40d31e4c-76b4-4003-8c44-8ed0492f175d">4.3.6 算法总结</a></li>
<li><a href="#h:40f5f8c5-e452-49ae-8e50-ab1a8cb95f78">4.3.7 各算法使用场景</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:e3ff1566-a9d9-4a82-8e2d-0ad2ce838ffb">5 高级功能及配置</a>
<ul>
<li><a href="#h:7b5af18b-d6f6-4e54-aaf2-07592bd7c17b">5.1 基于cookie的会话保持</a>
<ul>
<li><a href="#h:2ed6f23b-0202-40ff-85d7-039cd2900bc4">5.1.1 配置选项</a></li>
<li><a href="#h:ae19bb52-4eb5-440e-b5f4-2cca8c89a992">5.1.2 配置示例</a></li>
<li><a href="#h:7384d00b-c92f-4ec5-999f-b3181778001c">5.1.3 验证cookie信息</a></li>
</ul>
</li>
<li><a href="#h:694bb628-d365-4bac-a3a9-16c44c882c42">5.2 HAProxy状态页</a>
<ul>
<li><a href="#h:d7017738-0729-47b7-96d8-0fa0336b301f">5.2.1 状态页配置项</a></li>
<li><a href="#h:5e52a828-d10b-4856-b803-c3589675175e">5.2.2 启用状态页</a></li>
<li><a href="#h:551476e1-e88a-4c72-ad76-07ce43d7f9d3">5.2.3 登录状态页</a></li>
<li><a href="#h:bd6c4ff8-1496-4ade-b388-c53e76af4474">5.2.4 backend server信息</a></li>
<li><a href="#h:13770745-fafd-44a1-8df9-9aa4e8a009c3">5.2.5 利用状态页实现haproxy服务器的健康性检查</a></li>
</ul>
</li>
<li><a href="#h:95f84899-75bb-48df-98bd-f475ea506fc8">5.3 IP透传</a>
<ul>
<li><a href="#h:1dbcdf8a-67c6-4b8b-8935-69fa8717e4ca">5.3.1 layer 4 与 layer 7</a>
<ul>
<li><a href="#h:c6fd38af-1752-4aec-98db-f603557bc915">5.3.1.1 四层负载</a></li>
<li><a href="#h:73a1e7b4-68c1-4abb-8456-65aa5e294027">5.3.1.2 七层代理</a></li>
</ul>
</li>
<li><a href="#h:446aad10-340b-4b0f-b79f-59e2fc186500">5.3.2 四层IP透传</a></li>
<li><a href="#h:b5dbdacd-4968-485e-8a9b-746a43469eaf">5.3.3 七层IP透传</a>
<ul>
<li><a href="#h:07000983-4eda-4f9a-8dce-9a03dc052746">5.3.3.1 HAProxy配置</a></li>
<li><a href="#h:57075690-d525-4b09-b598-41464bf09649">5.3.3.2 web服务器日志格式配置</a></li>
<li><a href="#h:f6b667b8-d754-435f-a95d-91994e03e61d">5.3.3.3 验证客户端IP地址</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:c1391523-855d-46af-9d68-df284e3c9f9c">5.4 报文修改</a></li>
<li><a href="#h:99aa2530-d6f2-4d8b-bbaf-9508c4d258f5">5.5 自定义日志格式</a>
<ul>
<li><a href="#h:7e2cc162-10a6-40fd-8ca7-384de7ef653f">5.5.1 配置选项</a></li>
<li><a href="#h:68642fcd-b48b-4821-bbb6-bce8b7d9541a">5.5.2 配置示例</a></li>
<li><a href="#h:f542c028-6737-4fcd-b16d-e7f8f146c1f8">5.5.3 验证日志格式</a></li>
</ul>
</li>
<li><a href="#h:16c6a3fa-7621-4a4d-9d66-5f4bf25fbb37">5.6 压缩功能</a>
<ul>
<li><a href="#h:f76e6c9e-87b4-4aac-852a-db2428e98d52">5.6.1 配置选项</a></li>
<li><a href="#h:a179f794-e5b3-4548-965c-cd3838ccc7b3">5.6.2 配置示例</a></li>
<li><a href="#h:9d37d964-ab2b-4651-a4c7-5676e6d6b9aa">5.6.3 验证压缩功能</a></li>
</ul>
</li>
<li><a href="#h:c3ca62e4-c675-4334-bfb4-d79fc31ef6c3">5.7 web服务器状态监测</a>
<ul>
<li><a href="#h:8d96c4a4-3468-4d43-90ce-a64cb46680aa">5.7.1 三种状态监测方式</a></li>
<li><a href="#h:d7c170b6-a0fb-40cc-94ad-b0bab8e31cd6">5.7.2 基于应用层http协议进行健康性检测</a></li>
<li><a href="#h:0cff25c9-f2d8-4b52-a8d5-73431800ebce">5.7.3 配置示例</a></li>
<li><a href="#h:f95a28d5-cbab-43fa-b421-2877802397ae">5.7.4 验证http监测</a></li>
</ul>
</li>
<li><a href="#h:a889d025-f8d0-4b06-984f-4b1055510bc6">5.8 ACL</a>
<ul>
<li><a href="#h:af0a4584-0628-435e-a33e-9cb9f315e120">5.8.1 ACL配置选项</a>
<ul>
<li><a href="#h:821c3012-3e35-436e-b37c-d627e8869c91">5.8.1.1 ACL-Name</a></li>
<li><a href="#h:d2df69a6-dac0-41e0-be12-fc4ecc2b1c02">5.8.1.2 ACL-criterion</a></li>
<li><a href="#h:98d66c19-a6fe-4d8e-bf07-17668645e14e">5.8.1.3 ACL-flags</a></li>
<li><a href="#h:1f7fb87b-a32d-47fd-a509-539e729a301d">5.8.1.4 ACL-operator</a></li>
<li><a href="#h:963db83c-be03-49d3-a56b-2858037f9762">5.8.1.5 ACL-value</a></li>
</ul>
</li>
<li><a href="#h:cd90236b-7b8d-42b1-970e-0dbff68e9431">5.8.2 多个ACL的组合调用方式</a></li>
<li><a href="#h:163bcbd4-167b-4fa9-b185-ce0bdb6fc841">5.8.3 ACL示例-域名匹配</a></li>
<li><a href="#h:5693be9c-ca92-4fc6-b4a5-e07eef069cae">5.8.4 ACL示例-基于源IP或子网调度访问</a></li>
<li><a href="#h:988942cf-9cf8-42bc-929a-f018d300680d">5.8.5 ACL示例-基于源地址的访问控制</a></li>
<li><a href="#h:ca5e9216-478f-4dad-9636-ad14bc18be3b">5.8.6 ACL示例-匹配浏览器类型</a></li>
<li><a href="#h:239e5338-ef07-474d-b12e-067b40874dfc">5.8.7 ACL示例-基于文件后缀名实现动静分离</a></li>
<li><a href="#h:56b95b39-a38b-4bf8-b869-e75feb02c71f">5.8.8 ACL-匹配访问路径实现动静分离</a></li>
<li><a href="#h:3b950ada-b5d9-4a76-8784-516f92e49b94">5.8.9 ACL示例-预定义ACL使用</a>
<ul>
<li><a href="#h:ac649876-0efb-4f5e-9d2f-1d127725de39">5.8.9.1 预定义ACL</a></li>
<li><a href="#h:e0f9003e-ba69-42d9-8aec-dc61f61a616f">5.8.9.2 预定义ACL使用</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:b7952a00-9159-41d8-bc68-ec58322bb5f1">5.9 自定义HAProxy 错误界面</a>
<ul>
<li>
<ul>
<li><a href="#h:e290df72-d19b-4eee-a31e-e61c1238b6bf">5.9.1 基于自定义的错误页面文件</a></li>
</ul>
</li>
<li><a href="#h:f52bd87e-7b0d-4bc4-8e06-f498d03861dc">5.9.2 基于http重定向错误页面</a></li>
</ul>
</li>
<li><a href="#h:7751fe05-33ba-4463-a2e6-248f9a34c2bb">5.10 HAProxy 四层负载</a>
<ul>
<li><a href="#h:23a97e87-29a9-4079-831e-4ef39cea1f03">5.10.1 四层负载示例</a></li>
<li><a href="#h:381feae0-b9f0-42e2-847f-51ed9bf66fce">5.10.2 ACL示例-四层访问控制</a></li>
</ul>
</li>
<li><a href="#h:558e5944-e36f-44ee-bfea-f01553131c02">5.11 HAProxy https 实现</a>
<ul>
<li><a href="#h:a269de3c-45eb-47a2-941b-6a89a2df6df1">5.11.1 证书制作</a></li>
<li><a href="#h:ed334707-95b3-4204-b28d-ee037490d7e2">5.11.2 https配置示例</a></li>
<li><a href="#h:3eeab3d8-fd86-40a3-99f5-7396690d914e">5.11.3 修改后端服务器的日志格式</a></li>
<li><a href="#h:61de4a2e-04e9-4cbb-beee-a5e7db8026d1">5.11.4 验证https</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:aee3f035-7a3e-413a-bf73-5541f9243c0c">6 本章重点总结</a></li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../../index.html">Linux</a></li>
</ul>


<p>
企业级反向代理HAProxy
</p>

<p>
本章内容
</p>
<ul class="org-ul">
<li>Web 架构介绍</li>
<li>负载均衡集群</li>
<li>HAProxy安装和基础配置</li>
<li>HAProxy调度算法</li>
<li>HAProxy高级功能</li>
</ul>
<section id="outline-container-h:7d973690-8b6e-43a4-9841-ada7b685dd34" class="outline-2">
<h2 id="h:7d973690-8b6e-43a4-9841-ada7b685dd34">1 web架构介绍</h2>
<div class="outline-text-2" id="text-h:7d973690-8b6e-43a4-9841-ada7b685dd34">
</div>
<div id="outline-container-h:472c5949-e96c-4acb-8b57-85434bdbe57f" class="outline-3">
<h3 id="h:472c5949-e96c-4acb-8b57-85434bdbe57f">1.1 单机房架构</h3>
<div class="outline-text-3" id="text-h:472c5949-e96c-4acb-8b57-85434bdbe57f">

<figure id="org9be43c6">
<img src="images/image-20210225155352597.png" alt="image-20210225155352597.png">

</figure>
</div>
</div>
<div id="outline-container-h:c58a8a84-1fc7-49e3-9319-c389e8d29077" class="outline-3">
<h3 id="h:c58a8a84-1fc7-49e3-9319-c389e8d29077">1.2 多机房架构</h3>
<div class="outline-text-3" id="text-h:c58a8a84-1fc7-49e3-9319-c389e8d29077">

<figure id="orgfbe7be1">
<img src="images/image-20210225155404831.png" alt="image-20210225155404831.png">

</figure>
</div>
</div>
<div id="outline-container-h:cb9f1b15-5b1a-4068-86d2-8b7adb50c1c3" class="outline-3">
<h3 id="h:cb9f1b15-5b1a-4068-86d2-8b7adb50c1c3">1.3 公有云架构</h3>
<div class="outline-text-3" id="text-h:cb9f1b15-5b1a-4068-86d2-8b7adb50c1c3">

<figure id="org7f607f7">
<img src="images/image-20210225155433917.png" alt="image-20210225155433917.png">

</figure>
</div>
</div>
<div id="outline-container-h:c502bcd8-0ea7-49da-b08e-ababad438844" class="outline-3">
<h3 id="h:c502bcd8-0ea7-49da-b08e-ababad438844">1.4 私有云架构</h3>
<div class="outline-text-3" id="text-h:c502bcd8-0ea7-49da-b08e-ababad438844">

<figure id="org7ff4fbb">
<img src="images/image-20210225161311790.png" alt="image-20210225161311790.png">

</figure>
</div>
</div>
</section>
<section id="outline-container-h:9f030405-1037-4e73-9913-2075a4740b27" class="outline-2">
<h2 id="h:9f030405-1037-4e73-9913-2075a4740b27">2 负载均衡简介</h2>
<div class="outline-text-2" id="text-h:9f030405-1037-4e73-9913-2075a4740b27">
<p>
负载均衡：Load Balance，简称LB，是一种服务或基于硬件设备等实现的高可用
反向代理技术，负载均衡将特定的业务(web服务、网络流量等)分担给指定的一
个或多个后端特定的服务器或设备，从而提高了公司业务的并发处理能力、保证
了业务的高可用性、方便了业务后期的水平动态扩展
</p>

<p>
阿里云SLB介绍 ：<a href="https://yq.aliyun.com/articles/1803">https://yq.aliyun.com/articles/1803</a>
</p>


<figure id="org26f613a">
<img src="images/image-20210225161324755.png" alt="image-20210225161324755.png">

</figure>
</div>
<div id="outline-container-h:3ae33ce2-8a58-4d24-b950-7a8e861deaca" class="outline-3">
<h3 id="h:3ae33ce2-8a58-4d24-b950-7a8e861deaca">2.1 为什么使用负载均衡</h3>
<div class="outline-text-3" id="text-h:3ae33ce2-8a58-4d24-b950-7a8e861deaca">
<ul class="org-ul">
<li>Web服务器的动态水平扩展&#x2013;&gt;对用户无感知</li>
<li>增加业务并发访问及处理能力&#x2013;&gt;解决单服务器瓶颈问题</li>
<li>节约公网IP地址&#x2013;&gt;降低IT支出成本</li>
<li>隐藏内部服务器IP&#x2013;&gt;提高内部服务器安全性</li>
<li>配置简单&#x2013;&gt;固定格式的配置文件</li>
<li>功能丰富&#x2013;&gt;支持四层和七层，支持动态下线主机</li>
<li>性能较强&#x2013;&gt;并发数万甚至数十万</li>
</ul>
</div>
</div>
<div id="outline-container-h:64f7fdcf-8478-40f7-ba92-55e022ec804e" class="outline-3">
<h3 id="h:64f7fdcf-8478-40f7-ba92-55e022ec804e">2.2 负载均衡类型</h3>
<div class="outline-text-3" id="text-h:64f7fdcf-8478-40f7-ba92-55e022ec804e">
<p>
四层：
</p>

<div class="org-src-container">
<pre class="src src-sh">LVS&#65306;Linux Virtual Server
Nginx&#65306;1.9&#29256;&#20043;&#21518;
HAProxy&#65306;High Availability Proxy
</pre>
</div>

<p>
七层：
</p>

<div class="org-src-container">
<pre class="src src-sh">HAProxy
Nginx
</pre>
</div>

<p>
硬件：
</p>

<div class="org-src-container">
<pre class="src src-sh">F5             https://f5.com/zh
Netscaler      https://www.citrix.com.cn/products/citrix-adc/
Array          https://www.arraynetworks.com.cn/
&#28145;&#20449;&#26381;         http://www.sangfor.com.cn/
&#21271;&#20140;&#28789;&#24030;       http://www.lingzhou.com.cn/cpzx/llfzjh/
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4098eb12-94e2-4d5d-8e7e-28f0478ec435" class="outline-3">
<h3 id="h:4098eb12-94e2-4d5d-8e7e-28f0478ec435">2.3 应用场景</h3>
<div class="outline-text-3" id="text-h:4098eb12-94e2-4d5d-8e7e-28f0478ec435">
<div class="org-src-container">
<pre class="src src-sh">&#22235;&#23618;&#65306;Redis&#12289;Mysql&#12289;RabbitMQ&#12289;Memcache&#31561;
&#19971;&#23618;&#65306;Nginx&#12289;Tomcat&#12289;Apache&#12289;PHP&#12289;&#22270;&#29255;&#12289;&#21160;&#38745;&#20998;&#31163;&#12289;API&#31561;
</pre>
</div>

<p>
随着公司业务的发展，公司负载均衡服务既有四层的，又有七层的，通过LVS实
现四层和Nginx实现七层的负载均衡对机器资源消耗比较大，并且管理复杂度提
升，运维总监要求，目前需要对前端负载均衡服务进行一定的优化和复用，能否
用一种服务同既能实现七层负载均衡，又能实现四层负载均衡，并且性能高效，
配置管理容易，而且还是开源。
</p>

<p>
在企业生产环境中，每天会有很多的需求变更，比如增加服务器、新业务上线、
url路由修改、域名配置等等，对于前端负载均衡设备来说，容易维护，复杂度
低，是首选指标。在企业中，稳定压倒一切，与其搞得很复杂，经常出问题，不
如做的简单和稳定。在企业中，90%以上的故障，来源于需求变更。可能是程序
bug，也可能是人为故障，也可能是架构设计问题等。前端负载均衡设备为重中
之重，在软件选型上一定充分考虑，能满足业务的前提下，尽可能降低复杂度，
提高易维护性
</p>
</div>
</div>
<div id="outline-container-h:b187f551-f34d-4935-a716-9756d23664cb" class="outline-3">
<h3 id="h:b187f551-f34d-4935-a716-9756d23664cb">2.4 HAProxy介绍</h3>
<div class="outline-text-3" id="text-h:b187f551-f34d-4935-a716-9756d23664cb">
<p>
HAProxy是法国开发者 威利塔罗(Willy Tarreau)在2000年使用C语言开发的一个
开源软件，是一款具备高并发(一万以上)、高性能的TCP和HTTP负载均衡器，支
持基于cookie的持久性，自动故障切换，支持正则表达式及web状态统计，目前
最新TLS版本为2.2
</p>


<figure id="org754333c">
<img src="images/image-20210225161339384.png" alt="image-20210225161339384.png">

</figure>

<p>
历史版本：
</p>


<figure id="org6bbc133">
<img src="images/image-20210225161350419.png" alt="image-20210225161350419.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">&#21382;&#21490;&#29256;&#26412;&#26356;&#26032;&#21151;&#33021;&#65306;1.4 1.5 1.6 1.7 1.8 1.9 2.0 2.1 2.2 2.3 2.4-dev
1.8&#65306;&#22810;&#32447;&#31243;&#65292;HTTP/2&#32531;&#23384;&#8230;&#8230;
1.7&#65306;&#26381;&#21153;&#22120;&#21160;&#24577;&#37197;&#32622;&#65292;&#22810;&#31867;&#22411;&#35777;&#20070;&#8230;&#8230;
1.6&#65306;DNS&#35299;&#26512;&#25903;&#25345;&#65292;HTTP&#36830;&#25509;&#22810;&#36335;&#22797;&#29992;&#8230;&#8230;
1.5&#65306;&#24320;&#22987;&#25903;&#25345;SSL&#65292;IPV6&#65292;&#20250;&#35805;&#20445;&#25345;&#8230;&#8230;
</pre>
</div>

<p>
从2013年HAProxy分为社区版和企业版，企业版将提供更多的特性和功能以及全
天24小时的技术支持等服务。
</p>
</div>
<div id="outline-container-h:9cd64e4a-0c7d-461c-b83f-7d43f9cdf4bd" class="outline-4">
<h4 id="h:9cd64e4a-0c7d-461c-b83f-7d43f9cdf4bd">2.4.1 企业版</h4>
<div class="outline-text-4" id="text-h:9cd64e4a-0c7d-461c-b83f-7d43f9cdf4bd">
<p>
企业版网站：<a href="https://www.haproxy.com/">https://www.haproxy.com/</a>
</p>


<figure id="orga544b95">
<img src="images/image-20210225161415283.png" alt="image-20210225161415283.png">

</figure>
</div>
</div>
<div id="outline-container-h:56ddf139-0f40-4145-aab3-a09afad41e6e" class="outline-4">
<h4 id="h:56ddf139-0f40-4145-aab3-a09afad41e6e">2.4.2 社区版</h4>
<div class="outline-text-4" id="text-h:56ddf139-0f40-4145-aab3-a09afad41e6e">

<figure id="orga16e860">
<img src="images/image-20210225161711847.png" alt="image-20210225161711847.png">

</figure>

<p>
社区版网站：<a href="http://www.haproxy.org/">http://www.haproxy.org/</a> github：<a href="https://github.com/haproxy">https://github.com/haproxy</a>
</p>


<figure id="org80d5519">
<img src="images/image-20210225161735506.png" alt="image-20210225161735506.png">

</figure>
</div>
</div>
<div id="outline-container-h:d330ffad-548f-49aa-b688-906836028b30" class="outline-4">
<h4 id="h:d330ffad-548f-49aa-b688-906836028b30">2.4.3 版本对比</h4>
<div class="outline-text-4" id="text-h:d330ffad-548f-49aa-b688-906836028b30">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">功能</th>
<th scope="col" class="org-left">社区版</th>
<th scope="col" class="org-left">企业版</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">高级HTTP / TCP负载平衡和持久性</td>
<td class="org-left">支持</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">高级健康检查</td>
<td class="org-left">支持</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">应用程序加速</td>
<td class="org-left">支持</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">高级安全特性</td>
<td class="org-left">支持</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">高级管理</td>
<td class="org-left">支持</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">HAProxy Dev Branch新功能</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">24*7 支持服务</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">实时仪表盘</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">VRRP和Route Health Injection HA工具</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">ACL，映射和TLS票证密钥同步</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">基于应用程序的高级DDoS和Bot保护(自动保护)</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">Bot(机器人)监测</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">Web应用防火墙</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">HTTP协议验证</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">实时集群追踪</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">支持</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:b3b65c2b-f1b5-4db1-81b8-b1f67f9e1627" class="outline-4">
<h4 id="h:b3b65c2b-f1b5-4db1-81b8-b1f67f9e1627">2.4.4 HAProxy功能</h4>
<div class="outline-text-4" id="text-h:b3b65c2b-f1b5-4db1-81b8-b1f67f9e1627">

<figure id="org567bec6">
<img src="images/image-20210225161748339.png" alt="image-20210225161748339.png">

</figure>


<figure id="org67587b5">
<img src="images/image-20210225161916203.png" alt="image-20210225161916203.png">

</figure>

<p>
<b>支持功能：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">TCP &#21644; HTTP&#21453;&#21521;&#20195;&#29702;
SSL/TSL&#26381;&#21153;&#22120;
&#21487;&#20197;&#38024;&#23545;HTTP&#35831;&#27714;&#28155;&#21152;cookie&#65292;&#36827;&#34892;&#36335;&#30001;&#21518;&#31471;&#26381;&#21153;&#22120;
&#21487;&#24179;&#34913;&#36127;&#36733;&#33267;&#21518;&#31471;&#26381;&#21153;&#22120;&#65292;&#24182;&#25903;&#25345;&#25345;&#20037;&#36830;&#25509;
&#25903;&#25345;&#25152;&#26377;&#20027;&#26381;&#21153;&#22120;&#25925;&#38556;&#20999;&#25442;&#33267;&#22791;&#29992;&#26381;&#21153;&#22120;
&#25903;&#25345;&#19987;&#29992;&#31471;&#21475;&#23454;&#29616;&#30417;&#25511;&#26381;&#21153;
&#25903;&#25345;&#20572;&#27490;&#25509;&#21463;&#26032;&#36830;&#25509;&#35831;&#27714;&#65292;&#32780;&#19981;&#24433;&#21709;&#29616;&#26377;&#36830;&#25509;
&#21487;&#20197;&#22312;&#21452;&#21521;&#28155;&#21152;&#65292;&#20462;&#25913;&#25110;&#21024;&#38500;HTTP&#25253;&#25991;&#39318;&#37096;
&#21709;&#24212;&#25253;&#25991;&#21387;&#32553;
&#25903;&#25345;&#22522;&#20110;pattern&#23454;&#29616;&#36830;&#25509;&#35831;&#27714;&#30340;&#35775;&#38382;&#25511;&#21046;
&#36890;&#36807;&#29305;&#23450;&#30340;URI&#20026;&#25480;&#26435;&#29992;&#25143;&#25552;&#20379;&#35814;&#32454;&#30340;&#29366;&#24577;&#20449;&#24687;
</pre>
</div>


<figure id="orga022c55">
<img src="images/image-20210225162005337.png" alt="image-20210225162005337.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">&#25903;&#25345;http&#21453;&#21521;&#20195;&#29702;
&#25903;&#25345;&#21160;&#24577;&#31243;&#24207;&#30340;&#21453;&#21521;&#20195;&#29702;
&#25903;&#25345;&#22522;&#20110;&#25968;&#25454;&#24211;&#30340;&#21453;&#21521;&#20195;&#29702;
</pre>
</div>

<p>
<b>不具备的功能：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">&#27491;&#21521;&#20195;&#29702;--squid&#65292;nginx
&#32531;&#23384;&#20195;&#29702;--varnish
web&#26381;&#21153;--nginx&#12289;tengine&#12289;apache&#12289;php&#12289;tomcat
UDP--&#30446;&#21069;&#19981;&#25903;&#25345;UDP&#21327;&#35758;
&#21333;&#26426;&#24615;&#33021;--&#30456;&#27604;LVS&#24615;&#33021;&#36739;&#24046;
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:db45b6a2-2ba6-4636-a1af-bd68d1d68198" class="outline-2">
<h2 id="h:db45b6a2-2ba6-4636-a1af-bd68d1d68198">3 HAProxy安装及基础配置</h2>
<div class="outline-text-2" id="text-h:db45b6a2-2ba6-4636-a1af-bd68d1d68198">
<p>
介绍HAProxy的基础安装及基础配置
</p>


<figure id="org2eb6fab">
<img src="images/image-20210225162019045.png" alt="image-20210225162019045.png">

</figure>

<p>
内网IP地址划分：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22806;&#37096;&#32593;&#27573;&#65306;</span>
172.16.0.0/16
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#37096;&#32593;&#27573;&#65306;</span>
10.0.0.0/24
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#29992;&#22320;&#22336;&#33539;&#22260;&#65306;</span>
10.0.0.1--10.0.0.254
</pre>
</div>
</div>
<div id="outline-container-h:9b132497-dc44-426b-a048-64e8667070f5" class="outline-3">
<h3 id="h:9b132497-dc44-426b-a048-64e8667070f5">3.1 Ubuntu 安装</h3>
<div class="outline-text-3" id="text-h:9b132497-dc44-426b-a048-64e8667070f5">

<figure id="org3bda54b">
<img src="images/image-20210225162032836.png" alt="image-20210225162032836.png">

</figure>

<p>
打开链接： <a href="https://haproxy.debian.net/">https://haproxy.debian.net/</a>，选择合适的版本，会自动出现下面
安装提示
</p>


<figure id="orgf3562ad">
<img src="images/image-20210225162045565.png" alt="image-20210225162045565.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu1804 ~]#apt-get install software-properties-common
[root@ubuntu1804 ~]#add-apt-repository ppa:vbernat/haproxy-2.0
[root@ubuntu1804 ~]#apt update
[root@ubuntu1804 ~]#apt-cache madison haproxy
[root@ubuntu1804 ~]#apt install <span style="color: #a0522d;">haproxy</span>=2.0.4-1ppa1~bionic
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#23433;&#35013;&#26368;&#26032;&#29256;</span>
[root@ubuntu1804 ~]#apt-get install <span style="color: #a0522d;">haproxy</span>=2.0.<span style="color: #8b2252;">\*</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;haproxy&#29256;&#26412;</span>
[root@ubuntu1804 ~]#haproxy -v
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu1804 ~]#apt-get install software-properties-common
Reading package lists... Done
Building dependency tree         
Reading state information... Done
The following additional packages will be installed:
python3-software-properties
The following packages will be upgraded:
python3-software-properties software-properties-common
2 upgraded, 0 newly installed, 0 to remove and 252 not upgraded.
Need to get 33.6 kB of archives.
After this operation, 13.3 kB of additional disk space will be used.
Do you want to continue? [Y/n] y
Get:1 http://mirrors.aliyun.com/ubuntu bionic-updates/main amd64 software-
properties-common all 0.96.24.32.12 [10.0 kB]
Get:2 http://mirrors.aliyun.com/ubuntu bionic-updates/main amd64 python3-
software-properties all 0.96.24.32.12 [23.6 kB]
Fetched 33.6 kB<span style="color: #a020f0;"> in</span> 5s (6,528 B/s)                             
(Reading database ... 71030 files and directories currently installed.)
Preparing to unpack .../software-properties-common_0.96.24.32.12_all.deb ...
Unpacking software-properties-common (0.96.24.32.12) over (0.96.24.32.4) ...
Preparing to unpack .../python3-software-properties_0.96.24.32.12_all.deb ...
Unpacking python3-software-properties (0.96.24.32.12) over (0.96.24.32.4) ...
Processing triggers for man-db (2.8.3-2) ...
Setting up python3-software-properties (0.96.24.32.12) ...
Processing triggers for dbus (1.12.2-1ubuntu1) ...
Setting up software-properties-common (0.96.24.32.12) ...
[root@ubuntu1804 ~]#add-apt-repository ppa:vbernat/haproxy-2.0
HAProxy is a free, very fast and reliable solution offering high availability,
load balancing, and proxying for TCP and HTTP-based applications. It is
particularly suited for web sites crawling under very high loads while needing
persistence or Layer7 processing. Supporting tens of thousands of connections is
clearly realistic with todays hardware. Its mode of operation makes its
integration into existing architectures very easy and riskless, while still
offering the possibility not to expose fragile web servers to the Net.
This PPA contains packages for HAProxy 2.0.
More info: https://launchpad.net/~vbernat/+archive/ubuntu/haproxy-2.0
Press [ENTER] to continue or Ctrl-c to cancel adding it.
Hit:1 http://mirrors.aliyun.com/ubuntu bionic InRelease
Hit:2 http://mirrors.aliyun.com/ubuntu bionic-security InRelease
Hit:3 http://mirrors.aliyun.com/ubuntu bionic-updates InRelease                             

Hit:4 http://mirrors.aliyun.com/ubuntu bionic-proposed InRelease                             

Hit:5 http://mirrors.aliyun.com/ubuntu bionic-backports InRelease                         

Get:6 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic InRelease [20.7
kB]     
Get:7 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic/main i386
Packages [984 B]
Get:8 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic/main amd64
Packages [988 B]
Get:9 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic/main
Translation-en [704 B]
Fetched 23.4 kB<span style="color: #a020f0;"> in</span> 6s (3,971 B/s)         
Reading package lists... Done
[root@ubuntu1804 ~]# apt-get update
Hit:1 http://mirrors.aliyun.com/ubuntu bionic InRelease
Hit:2 http://mirrors.aliyun.com/ubuntu bionic-security InRelease                             

Hit:3 http://mirrors.aliyun.com/ubuntu bionic-updates InRelease                             

Hit:4 http://mirrors.aliyun.com/ubuntu bionic-proposed InRelease                             

Hit:5 http://mirrors.aliyun.com/ubuntu bionic-backports InRelease                         

Hit:6 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic InRelease         

Reading package lists... Done
[root@ubuntu1804 ~]#apt-get install <span style="color: #a0522d;">haproxy</span>=2.0.<span style="color: #8b2252;">\*</span>
Reading package lists... Done
Building dependency tree         
Reading state information... Done
Selected version <span style="color: #8b2252;">'2.0.13-1ppa1~bionic'</span> (HAProxy 2.0:18.04/bionic [amd64]) <span style="color: #a020f0;">for</span>
<span style="color: #8b2252;">'haproxy'</span>
The following additional packages will be installed:
liblua5.3-0 libpcre2-8-0
Suggested packages:
vim-haproxy haproxy-doc
The following NEW packages will be installed:
haproxy liblua5.3-0 libpcre2-8-0
0 upgraded, 3 newly installed, 0 to remove and 252 not upgraded.
Need to get 1,526 kB/1,819 kB of archives.
After this operation, 4,246 kB of additional disk space will be used.
Do you want to continue? [Y/n] y
Get:1 http://ppa.launchpad.net/vbernat/haproxy-2.0/ubuntu bionic/main amd64
haproxy amd64 2.0.13-1ppa1~bionic [1,526 kB]
Fetched 572 kB<span style="color: #a020f0;"> in</span> 26s (22.1 kB/s)                                                                                         

Selecting previously unselected package liblua5.3-0:amd64.
(Reading database ... 71032 files and directories currently installed.)
Preparing to unpack .../liblua5.3-0_5.3.3-1ubuntu0.18.04.1_amd64.deb ...
Unpacking liblua5.3-0:amd64 (5.3.3-1ubuntu0.18.04.1) ...
Selecting previously unselected package libpcre2-8-0:amd64.
Preparing to unpack .../libpcre2-8-0_10.31-2_amd64.deb ...
Unpacking libpcre2-8-0:amd64 (10.31-2) ...
Selecting previously unselected package haproxy.
Preparing to unpack .../haproxy_2.0.13-1ppa1~bionic_amd64.deb ...
Unpacking haproxy (2.0.13-1ppa1~bionic) ...
Processing triggers for ureadahead (0.100.0-20) ...
Processing triggers for libc-bin (2.27-3ubuntu1) ...
Processing triggers for systemd (237-3ubuntu10.3) ...
Processing triggers for man-db (2.8.3-2) ...
Setting up libpcre2-8-0:amd64 (10.31-2) ...
Setting up liblua5.3-0:amd64 (5.3.3-1ubuntu0.18.04.1) ...
Processing triggers for rsyslog (8.32.0-1ubuntu4) ...
Setting up haproxy (2.0.13-1ppa1~bionic) ...
Created symlink /etc/systemd/system/multi-user.target.wants/haproxy.service &#8594;
/lib/systemd/system/haproxy.service.
Processing triggers for libc-bin (2.27-3ubuntu1) ...
Processing triggers for ureadahead (0.100.0-20) ...
Processing triggers for systemd (237-3ubuntu10.3) ...
Processing triggers for rsyslog (8.32.0-1ubuntu4) ...
[root@ubuntu1804 ~]#apt-cache madison haproxy
    haproxy | 2.0.13-1ppa1~bionic | http://ppa.launchpad.net/vbernat/haproxy-
2.0/ubuntu bionic/main amd64 Packages
    haproxy | 1.8.8-1ubuntu0.9 | http://mirrors.aliyun.com/ubuntu bionic-
security/main amd64 Packages
    haproxy | 1.8.8-1ubuntu0.9 | http://mirrors.aliyun.com/ubuntu bionic-
updates/main amd64 Packages
    haproxy |         1.8.8-1 | http://mirrors.aliyun.com/ubuntu bionic/main amd64
Packages
    haproxy |         1.8.8-1 | http://mirrors.aliyun.com/ubuntu bionic/main Sources
    haproxy | 1.8.8-1ubuntu0.9 | http://mirrors.aliyun.com/ubuntu bionic-
security/main Sources
    haproxy | 1.8.8-1ubuntu0.9 | http://mirrors.aliyun.com/ubuntu bionic-
updates/main Sources
[root@ubuntu1804 ~]#haproxy -v
HA-Proxy version 2.0.13-1ppa1~bionic 2020/02/15 - https://haproxy.org/
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e63991d4-8aa6-4f88-82f3-8c319073a126" class="outline-3">
<h3 id="h:e63991d4-8aa6-4f88-82f3-8c319073a126">3.2 CentOS 安装</h3>
<div class="outline-text-3" id="text-h:e63991d4-8aa6-4f88-82f3-8c319073a126">
<p>
在centos 系统上通过 yum、编译等多种安装方式
</p>
</div>
<div id="outline-container-h:28565d3e-7c32-40cf-afa1-af49a3c17f6e" class="outline-4">
<h4 id="h:28565d3e-7c32-40cf-afa1-af49a3c17f6e">3.2.1 系统默认yum源</h4>
<div class="outline-text-4" id="text-h:28565d3e-7c32-40cf-afa1-af49a3c17f6e">
<p>
CentOS 7的默认的base仓库中包含haproxy的安装包文件，但是版本比较旧，是
1.5.18的版本，距离当前版本已经有较长时间没有更新，由于版本比较旧所以有
很多功能不支持，如果对功能和性能没有要求可以使用此版本，否则推荐使用新
版本。
</p>

<p>
范例：CentOS 7 安装haproxy
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]# yum install haproxy -y
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;haproxy&#29256;&#26412;</span>
[root@centos7 ~]# haproxy -v
HA-Proxy version 1.5.18 2016/05/10
Copyright 2000-2016 Willy Tarreau <a href="mailto:willy%40haproxy.org">&lt;willy@haproxy.org&gt;</a>
</pre>
</div>

<p>
范例：CentOS 8 安装haproxy
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dnf -y install haproxy
[root@centos8 ~]#haproxy -v
HA-Proxy version 1.8.15 2018/12/13
Copyright 2000-2018 Willy Tarreau <a href="mailto:willy%40haproxy.org">&lt;willy@haproxy.org&gt;</a>
[root@centos8 ~]#haproxy -vv
HA-Proxy version 1.8.15 2018/12/13
Copyright 2000-2018 Willy Tarreau <a href="mailto:willy%40haproxy.org">&lt;willy@haproxy.org&gt;</a>
Build options :
TARGET     = linux2628
CPU         = generic
CC             = gcc
CFLAGS     = -O2 -g -fno-strict-aliasing -Wdeclaration-after-statement -fwrapv -
Wno-format-truncation -Wno-null-dereference -Wno-unused-label
OPTIONS = <span style="color: #a0522d;">USE_LINUX_TPROXY</span>=1 <span style="color: #a0522d;">USE_CRYPT_H</span>=1 <span style="color: #a0522d;">USE_GETADDRINFO</span>=1 <span style="color: #a0522d;">USE_ZLIB</span>=1
<span style="color: #a0522d;">USE_REGPARM</span>=1 <span style="color: #a0522d;">USE_OPENSSL</span>=1 <span style="color: #a0522d;">USE_LUA</span>=1 <span style="color: #a0522d;">USE_SYSTEMD</span>=1 <span style="color: #a0522d;">USE_PCRE</span>=1
Default settings :
maxconn = 2000, bufsize = 16384, maxrewrite = 1024, maxpollevents = 200
Built with OpenSSL version : OpenSSL 1.1.1 FIPS     11 Sep 2018
Running on OpenSSL version : OpenSSL 1.1.1c FIPS     28 May 2019
OpenSSL library supports TLS extensions : yes
OpenSSL library supports SNI : yes
OpenSSL library supports : TLSv1.0 TLSv1.1 TLSv1.2 TLSv1.3
Built with Lua version : Lua 5.3.4
Built with transparent proxy support using: IP_TRANSPARENT IPV6_TRANSPARENT
IP_FREEBIND
Encrypted password support via crypt(3): yes
Built with multi-threading support.
Built with PCRE version : 8.42 2018-03-20
Running on PCRE version : 8.42 2018-03-20
PCRE library supports JIT : no (USE_PCRE_JIT not set)
Built with zlib version : 1.2.11
Running on zlib version : 1.2.11
Compression algorithms supported : identity(<span style="color: #8b2252;">"identity"</span>), deflate(<span style="color: #8b2252;">"deflate"</span>),
<span style="color: #0000ff;">raw-deflate</span>(<span style="color: #8b2252;">"deflate"</span>), gzip(<span style="color: #8b2252;">"gzip"</span>)
Built with network namespace support.
Available polling systems :
        epoll : <span style="color: #a0522d;">pref</span>=300, test result OK
            poll : <span style="color: #a0522d;">pref</span>=200, test result OK
        <span style="color: #a020f0;">select</span> : <span style="color: #a0522d;">pref</span>=150, test result OK
Total: 3 (3 usable), will use epoll.
Available filters :
[SPOE] spoe
[COMP] compression
[TRACE] trace
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f22db7de-e600-4347-9d01-d4939e1edfa6" class="outline-4">
<h4 id="h:f22db7de-e600-4347-9d01-d4939e1edfa6">3.2.2 第三方安装包</h4>
<div class="outline-text-4" id="text-h:f22db7de-e600-4347-9d01-d4939e1edfa6">
<p>
官方没有提供rpm相关的包,可以通过第三方仓库的rpm包
从第三方网站下载rpm包：<a href="https://pkgs.org/download/haproxy">https://pkgs.org/download/haproxy</a>
</p>


<figure id="orgf5a2fb3">
<img src="images/image-20210225162104685.png" alt="image-20210225162104685.png">

</figure>


<figure id="org3614a44">
<img src="images/image-20210225162113644.png" alt="image-20210225162113644.png">

</figure>

<p>
范例：基于互联网第三方仓库在线安装
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">wget http://www.nosuchhost.net/~cheese/fedora/packages/epel-7/x86_64/cheese-</span>
release-7-1.noarch.rpm
<span style="color: #b22222;">#</span><span style="color: #b22222;">rpm -ivh cheese-release-7-1.noarch.rpm</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">yum install haproxy</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;haproxy&#29256;&#26412;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">haproxy -v</span>
HA-Proxy version 1.8.14-52e4d43 2018/09/20
Copyright 2000-2018 Willy Tarreau <a href="mailto:willy%40haproxy.org">&lt;willy@haproxy.org&gt;</a>
</pre>
</div>


<figure id="orgbe734b3">
<img src="images/image-20210225162124195.png" alt="image-20210225162124195.png">

</figure>

<p>
范例：利用第三方 yum 仓库安装
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#wget https://centos7.iuscommunity.org/ius-release.rpm
[root@centos7 ~]#rpm -Uvh ius-release*rpm
[root@centos7 ~]#yum -y install epel-release
[root@centos7 ~]#rpm -Uvh ius-release*rpm
[root@centos7 ~]#yum install haproxy18u
[root@centos7 ~]#haproxy -v
HA-Proxy version 1.8.23 2019/11/25
Copyright 2000-2019 Willy Tarreau <a href="mailto:willy%40haproxy.org">&lt;willy@haproxy.org&gt;</a>
</pre>
</div>

<p>
范例：下载rpm包离线安装
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#36733;&#23433;&#35013;lua&#24211;&#23545;&#24212;&#30340;&#29256;&#26412;</span>
[root@centos7 ~]#wget https://dl.iuscommunity.org/pub/ius/stable/CentOS/7/x86_64/lua53u-libs-5.3.4-1.ius.centos7.x86_64.rpm
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;lua&#24211;</span>
[root@centos7 ~]#yum -y install lua53u-libs-5.3.4-1.ius.centos7.x86_64.rpm
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#36733;haproxy</span>
[root@centos7 ~]#wget https://dl.iuscommunity.org/pub/ius/stable/CentOS/7/x86_64/haproxy18u-1.8.20-1.el7.ius.x86_64.rpm
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;haproxy</span>
[root@centos7 ~]#yum -y install haproxy18u-1.8.20-1.el7.ius.x86_64.rpm
[root@centos7 ~]#haproxy -v
HA-Proxy version 1.8.20 2019/04/25
Copyright 2000-2019 Willy Tarreau <a href="mailto:willy%40haproxy.org">&lt;willy@haproxy.org&gt;</a>
[root@centos7 ~]#systemctl start haproxy
[root@centos7 ~]#systemctl status haproxy.service
&#9679; haproxy.service - HAProxy Load Balancer
    Loaded: loaded (/usr/lib/systemd/system/haproxy.service; disabled; vendor
preset: disabled)
    Active: active (running) since Mon 2020-03-30 21:17:23 CST; 56s ago
Process: 1257 <span style="color: #a0522d;">ExecStartPre</span>=/usr/sbin/haproxy -f $<span style="color: #a0522d;">CONFIG</span> -c -q (<span style="color: #a0522d;">code</span>=exited,
<span style="color: #a0522d;">status</span>=0/SUCCESS)
Main PID: 1258 (haproxy)
    CGroup: /system.slice/haproxy.service
                    &#9500;&#9472;1258 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p
/run/haproxy.pid
                    &#9492;&#9472;1260 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p
/run/haproxy.pid
Mar 30 21:17:23 centos7.cici.com systemd[1]: Starting HAProxy Load
Balancer...
Mar 30 21:17:23 centos7.cici.com systemd[1]: Started HAProxy Load
Balancer.
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:e687c0f2-c113-41c0-bcad-8a3b072ee210" class="outline-3">
<h3 id="h:e687c0f2-c113-41c0-bcad-8a3b072ee210">3.3 编译安装 HAProxy</h3>
<div class="outline-text-3" id="text-h:e687c0f2-c113-41c0-bcad-8a3b072ee210">
<p>
编译安装HAProxy 2.0 LTS版本，更多源码包下载地址：<a href="http://www.haproxy.org/download/">http://www.haproxy.org/download/</a>
</p>
</div>
<div id="outline-container-h:c1a41f80-f444-463e-8066-fc25d2a70ef3" class="outline-4">
<h4 id="h:c1a41f80-f444-463e-8066-fc25d2a70ef3">3.3.1 解决 lua 环境</h4>
<div class="outline-text-4" id="text-h:c1a41f80-f444-463e-8066-fc25d2a70ef3">
<p>
HAProxy支持基于lua实现功能扩展，lua是一种小巧的脚本语言，于1993年由巴
西里约热内卢天主教大学（Pontifical Catholic University of Rio de
Janeiro）里的一个研究小组开发，其设计目的是为了嵌入应用程序中，从而为
应用程序提供灵活的扩展和定制功能。
</p>

<p>
Lua 官网：www.lua.org
</p>

<p>
Lua 应用场景
</p>
<ul class="org-ul">
<li>游戏开发</li>
<li>独立应用脚本</li>
<li>Web 应用脚本</li>
<li>扩展和数据库插件，如MySQL Proxy</li>
<li>安全系统，如入侵检测系统</li>
</ul>
</div>
<div id="outline-container-h:960a2fd6-69e5-4c52-a103-8f2d12ea2189" class="outline-5">
<h5 id="h:960a2fd6-69e5-4c52-a103-8f2d12ea2189">3.3.1.1 CentOS 基础环境</h5>
<div class="outline-text-5" id="text-h:960a2fd6-69e5-4c52-a103-8f2d12ea2189">
<p>
参考链接：<a href="http://www.lua.org/start.html">http://www.lua.org/start.html</a>
</p>

<p>
由于CentOS7之前版本自带的lua版本比较低并不符合HAProxy要求的lua最低版本
(5.3)的要求，因此需要编译安装较新版本的lua环境，然后才能编译安装
HAProxy，过程如下：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#31995;&#32479;&#29256;&#26412;</span>
[root@centos7 ~]#lua -v
Lua 5.1.4 Copyright (C) 1994-2008 Lua.org, PUC-Rio
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#22522;&#30784;&#21629;&#20196;&#21450;&#32534;&#35793;&#20381;&#36182;&#29615;&#22659;</span>
[root@centos7 ~]# yum install gcc readline-devel
[root@centos7 ~]# wget http://www.lua.org/ftp/lua-5.3.5.tar.gz
[root@centos7 ~]# tar xvf lua-5.3.5.tar.gz -C /usr/local/src
[root@centos7 ~]# cd /usr/local/src/lua-5.3.5
[root@centos7 lua-5.3.5]# make linux test
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#32534;&#35793;&#23433;&#35013;&#30340;&#29256;&#26412;</span>
[root@centos7 lua-5.3.5]#src/lua -v
Lua 5.3.5 Copyright (C) 1994-2018 Lua.org, PUC-Rio
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c8492985-7897-4d1b-97fe-619ca7498ae1" class="outline-5">
<h5 id="h:c8492985-7897-4d1b-97fe-619ca7498ae1">3.3.1.2 Ubuntu 基础环境</h5>
<div class="outline-text-5" id="text-h:c8492985-7897-4d1b-97fe-619ca7498ae1">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#22522;&#30784;&#21629;&#20196;&#21450;&#32534;&#35793;&#20381;&#36182;&#29615;&#22659;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">apt install gcc iproute2 ntpdate tcpdump telnet traceroute nfs-kernel-</span>
server nfs-common lrzsz tree openssl libssl-dev libpcre3 libpcre3-dev zlib1g-
dev openssh-server libreadline-dev libsystemd-dev
<span style="color: #b22222;"># </span><span style="color: #b22222;">cd /usr/local/src</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">wget http://www.lua.org/ftp/lua-5.3.5.tar.gz</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">tar xvf lua-5.3.5.tar.gz</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">cd lua-5.3.5</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">make linux test</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">pwd</span>
/usr/local/src/lua-5.3.5
<span style="color: #b22222;"># </span><span style="color: #b22222;">./src/lua -v</span>
Lua 5.3.5 Copyright (C) 1994-2018 Lua.org, PUC-Rio
&#25110;&#23433;&#35013;&#31995;&#32479;&#33258;&#24102;&#30340;lua
<span style="color: #b22222;"># </span><span style="color: #b22222;">apt install lua5.3=5.3.3-1ubuntu0.18.04.1</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">lua5.3 -v</span>
Lua 5.3.3 Copyright (C) 1994-2016 Lua.org, PUC-Rio
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:12eab8fc-9935-4c1a-806b-cf67c4e3c2b9" class="outline-4">
<h4 id="h:12eab8fc-9935-4c1a-806b-cf67c4e3c2b9">3.3.2 编译安装HAProxy</h4>
<div class="outline-text-4" id="text-h:12eab8fc-9935-4c1a-806b-cf67c4e3c2b9">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">HAProxy 1.8&#21450;1.9&#29256;&#26412;&#32534;&#35793;&#21442;&#25968;&#65306;</span>
make     <span style="color: #a0522d;">ARCH</span>=x86_64 <span style="color: #a0522d;">TARGET</span>=linux2628 <span style="color: #a0522d;">USE_PCRE</span>=1 <span style="color: #a0522d;">USE_OPENSSL</span>=1 <span style="color: #a0522d;">USE_ZLIB</span>=1 <span style="color: #a0522d;">USE_SYSTEMD</span>=1     <span style="color: #a0522d;">USE_CPU_AFFINITY</span>=1     <span style="color: #a0522d;">PREFIX</span>=/usr/local/haproxy
<span style="color: #b22222;">#</span><span style="color: #b22222;">HAProxy 2.0&#20197;&#19978;&#29256;&#26412;&#32534;&#35793;&#21442;&#25968;&#65306;</span>
[root@centos7 ~]#yum -y install gcc openssl-devel pcre-devel systemd-devel
[root@centos7 ~]#tar xvf haproxy-2.1.3.tar.gz -C /usr/local/src
[root@centos7 ~]#cd /usr/local/src/haproxy-2.1.3/
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#23433;&#35013;&#26041;&#27861;</span>
[root@centos7 haproxy-2.1.3]#ll Makefile
-rw-rw-r-- 1 root root 40812 Feb 12 23:18 Makefile
[root@centos7 haproxy-2.1.3]#cat README
[root@centos7 haproxy-2.1.3]#cat INSTALL
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#32771;INSTALL&#25991;&#20214;&#36827;&#34892;&#32534;&#35793;&#23433;&#35013;</span>
[root@centos7 haproxy-2.1.3]#make <span style="color: #a0522d;">ARCH</span>=x86_64 <span style="color: #a0522d;">TARGET</span>=linux-glibc <span style="color: #a0522d;">USE_PCRE</span>=1 <span style="color: #a0522d;">USE_OPENSSL</span>=1 <span style="color: #a0522d;">USE_ZLIB</span>=1 <span style="color: #a0522d;">USE_SYSTEMD</span>=1 <span style="color: #a0522d;">USE_LUA</span>=1 <span style="color: #a0522d;">LUA_INC</span>=/usr/local/src/lua-5.3.5/src/ <span style="color: #a0522d;">LUA_LIB</span>=/usr/local/src/lua-5.3.5/src/
[root@centos7 haproxy-2.1.3]# make install <span style="color: #a0522d;">PREFIX</span>=/apps/haproxy
[root@centos7 haproxy-2.1.3]#ln -s /apps/haproxy/sbin/haproxy /usr/sbin/
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#29983;&#25104;&#30340;&#25991;&#20214;</span>
[root@centos7 haproxy-2.1.3]#tree /apps/haproxy/
/apps/haproxy/
&#9500;&#9472;&#9472; doc
&#9474;        &#9492;&#9472;&#9472; haproxy
&#9474;                &#9500;&#9472;&#9472; 51Degrees-device-detection.txt
&#9474;                &#9500;&#9472;&#9472; architecture.txt
&#9474;                &#9500;&#9472;&#9472; close-options.txt
&#9474;                &#9500;&#9472;&#9472; configuration.txt
&#9474;                &#9500;&#9472;&#9472; cookie-options.txt
&#9474;                &#9500;&#9472;&#9472; DeviceAtlas-device-detection.txt
&#9474;                &#9500;&#9472;&#9472; intro.txt
&#9474;                &#9500;&#9472;&#9472; linux-syn-cookies.txt
&#9474;                &#9500;&#9472;&#9472; lua.txt
&#9474;                &#9500;&#9472;&#9472; management.txt
&#9474;                &#9500;&#9472;&#9472; netscaler-client-ip-insertion-protocol.txt
&#9474;                &#9500;&#9472;&#9472; network-namespaces.txt
&#9474;                &#9500;&#9472;&#9472; peers.txt
&#9474;                &#9500;&#9472;&#9472; peers-v2.0.txt
&#9474;                &#9500;&#9472;&#9472; proxy-protocol.txt
&#9474;                &#9500;&#9472;&#9472; regression-testing.txt
&#9474;                &#9500;&#9472;&#9472; seamless_reload.txt
&#9474;                &#9500;&#9472;&#9472; SOCKS4.protocol.txt
&#9474;                &#9500;&#9472;&#9472; SPOE.txt
&#9474;                &#9492;&#9472;&#9472; WURFL-device-detection.txt
&#9500;&#9472;&#9472; sbin
&#9474;        &#9492;&#9472;&#9472; haproxy
&#9492;&#9472;&#9472; share
    &#9492;&#9472;&#9472; man
            &#9492;&#9472;&#9472; man1
                    &#9492;&#9472;&#9472; haproxy.1
6 directories, 22 files
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8731dcf8-c131-4262-bf4f-d49cbeb7dcb3" class="outline-4">
<h4 id="h:8731dcf8-c131-4262-bf4f-d49cbeb7dcb3">3.3.3 验证HAProxy版本</h4>
<div class="outline-text-4" id="text-h:8731dcf8-c131-4262-bf4f-d49cbeb7dcb3">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;HAProxy&#29256;&#26412;&#65306;</span>
[root@centos7 ~]#which haproxy
/usr/sbin/haproxy
[root@centos7 ~]#haproxy -v
HA-Proxy version 2.1.3 2020/02/12 - https://haproxy.org/
Status: stable branch - will stop receiving fixes around Q1 2021.
Known bugs: http://www.haproxy.org/bugs/bugs-2.1.3.html
[root@centos7 ~]#haproxy -v
HA-Proxy version 2.0.14 2020/04/02 - https://haproxy.org/
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22823;&#20889;-V&#36873;&#39033;&#26174;&#31034;&#29256;&#26412;&#21644;&#24110;&#21161;&#29992;&#27861;</span>
[root@centos7 ~]#haproxy -V
HA-Proxy version 2.0.14 2020/04/02 - https://haproxy.org/
Usage : haproxy [-f &lt;cfgfile|cfgdir&gt;]* [ -vdVD ] [ -n &lt;maxconn&gt; ] [ -N
&lt;maxpconn&gt; ]
            [ -p &lt;pidfile&gt; ] [ -m &lt;max megs&gt; ] [ -C &lt;dir&gt; ] [-- &lt;cfgfile&gt;*]
                -v displays version ; -vv shows known build options.
                -d enters debug mode ; -db only disables background mode.
                -dM[&lt;byte&gt;] poisons memory with &lt;byte&gt; (defaults to 0x50)
                -V enters verbose mode (disables quiet mode)
                -D goes daemon ; -C changes to &lt;dir&gt; before loading files.
                -W master-worker mode.
                -Ws master-worker mode with systemd notify support.
                -q quiet mode : don<span style="color: #8b2252;">'t display messages</span>
<span style="color: #8b2252;">                -c check mode : only check config files and exit</span>
<span style="color: #8b2252;">                -n sets the maximum total # of connections (uses ulimit -n)</span>
<span style="color: #8b2252;">                -m limits the usable amount of memory (in MB)</span>
<span style="color: #8b2252;">                -N sets the default, per-proxy maximum # of connections (0)</span>
<span style="color: #8b2252;">                -L set local peer name (default to hostname)</span>
<span style="color: #8b2252;">                -p writes pids of all children to this file</span>
<span style="color: #8b2252;">                -de disables epoll() usage even when available</span>
<span style="color: #8b2252;">                -dp disables poll() usage even when available</span>
<span style="color: #8b2252;">                -dS disables splice usage (broken on old kernels)</span>
<span style="color: #8b2252;">                -dG disables getaddrinfo() usage</span>
<span style="color: #8b2252;">                -dR disables SO_REUSEPORT usage</span>
<span style="color: #8b2252;">                -dr ignores server address resolution failures</span>
<span style="color: #8b2252;">                -dV disables SSL verify on servers side</span>
<span style="color: #8b2252;">                -sf/-st [pid ]* finishes/terminates old pids.</span>
<span style="color: #8b2252;">                -x &lt;unix_socket&gt; get listening sockets from a unix socket</span>
<span style="color: #8b2252;">                -S &lt;bind&gt;[,&lt;bind options&gt;...] new master CLI</span>

<span style="color: #8b2252;">[root@centos7 ~]#haproxy -vv</span>
<span style="color: #8b2252;">HA-Proxy version 2.1.3 2020/02/12 - https://haproxy.org/</span>
<span style="color: #8b2252;">Status: stable branch - will stop receiving fixes around Q1 2021.</span>
<span style="color: #8b2252;">Known bugs: http://www.haproxy.org/bugs/bugs-2.1.3.html</span>
<span style="color: #8b2252;">Build options :</span>
<span style="color: #8b2252;">TARGET     = linux-glibc</span>
<span style="color: #8b2252;">CPU         = generic</span>
<span style="color: #8b2252;">CC             = gcc</span>
<span style="color: #8b2252;">CFLAGS     = -m64 -march=x86-64 -O2 -g -fno-strict-aliasing -Wdeclaration-after-</span>
<span style="color: #8b2252;">statement -fwrapv -Wno-unused-label -Wno-sign-compare -Wno-unused-parameter -</span>
<span style="color: #8b2252;">Wno-old-style-declaration -Wno-ignored-qualifiers -Wno-clobbered -Wno-missing-</span>
<span style="color: #8b2252;">field-initializers -Wtype-limits</span>
<span style="color: #8b2252;">OPTIONS = USE_PCRE=1 USE_OPENSSL=1 USE_LUA=1 USE_ZLIB=1 USE_SYSTEMD=1</span>
<span style="color: #8b2252;">Feature list : +EPOLL -KQUEUE -MY_EPOLL -MY_SPLICE +NETFILTER +PCRE -PCRE_JIT -</span>
<span style="color: #8b2252;">PCRE2 -PCRE2_JIT +POLL -PRIVATE_CACHE +THREAD -PTHREAD_PSHARED -REGPARM -</span>
<span style="color: #8b2252;">STATIC_PCRE -STATIC_PCRE2 +TPROXY +LINUX_TPROXY +LINUX_SPLICE +LIBCRYPT +CRYPT_H</span>
<span style="color: #8b2252;">-VSYSCALL +GETADDRINFO +OPENSSL +LUA +FUTEX +ACCEPT4 -MY_ACCEPT4 +ZLIB -SLZ</span>
<span style="color: #8b2252;">+CPU_AFFINITY +TFO +NS +DL +RT -DEVICEATLAS -51DEGREES -WURFL +SYSTEMD -</span>
<span style="color: #8b2252;">OBSOLETE_LINKER +PRCTL +THREAD_DUMP -EVPORTS</span>
<span style="color: #8b2252;">Default settings :</span>
<span style="color: #8b2252;">bufsize = 16384, maxrewrite = 1024, maxpollevents = 200</span>
<span style="color: #8b2252;">Built with multi-threading support (MAX_THREADS=64, default=4).</span>
<span style="color: #8b2252;">Built with OpenSSL version : OpenSSL 1.0.2k-fips     26 Jan 2017</span>
<span style="color: #8b2252;">Running on OpenSSL version : OpenSSL 1.0.2k-fips     26 Jan 2017</span>
<span style="color: #8b2252;">OpenSSL library supports TLS extensions : yes</span>
<span style="color: #8b2252;">OpenSSL library supports SNI : yes</span>
<span style="color: #8b2252;">OpenSSL library supports : SSLv3 TLSv1.0 TLSv1.1 TLSv1.2</span>
<span style="color: #8b2252;">Built with Lua version : Lua 5.3.5</span>
<span style="color: #8b2252;">Built with network namespace support.</span>
<span style="color: #8b2252;">Built with transparent proxy support using: IP_TRANSPARENT IPV6_TRANSPARENT</span>
<span style="color: #8b2252;">IP_FREEBIND</span>
<span style="color: #8b2252;">Built with PCRE version : 8.32 2012-11-30</span>
<span style="color: #8b2252;">Running on PCRE version : 8.32 2012-11-30</span>
<span style="color: #8b2252;">PCRE library supports JIT : no (USE_PCRE_JIT not set)</span>
<span style="color: #8b2252;">Encrypted password support via crypt(3): yes</span>
<span style="color: #8b2252;">Built with zlib version : 1.2.7</span>
<span style="color: #8b2252;">Running on zlib version : 1.2.7</span>
<span style="color: #8b2252;">Compression algorithms supported : identity("identity"), deflate("deflate"),</span>
<span style="color: #8b2252;">raw-deflate("deflate"), gzip("gzip")</span>
<span style="color: #8b2252;">Available polling systems :</span>
<span style="color: #8b2252;">        epoll : pref=300, test result OK</span>
<span style="color: #8b2252;">            poll : pref=200, test result OK</span>
<span style="color: #8b2252;">        select : pref=150, test result OK</span>
<span style="color: #8b2252;">Total: 3 (3 usable), will use epoll.</span>
<span style="color: #8b2252;">Available multiplexer protocols :</span>
<span style="color: #8b2252;">(protocols marked as &lt;default&gt; cannot be specified using '</span>proto<span style="color: #8b2252;">' keyword)</span>
<span style="color: #8b2252;">                        h2 : mode=HTTP             side=FE|BE         mux=H2</span>
<span style="color: #8b2252;">                    fcgi : mode=HTTP             side=BE                 mux=FCGI</span>
<span style="color: #8b2252;">            &lt;default&gt; : mode=HTTP             side=FE|BE         mux=H1</span>
<span style="color: #8b2252;">            &lt;default&gt; : mode=TCP                 side=FE|BE         mux=PASS</span>
<span style="color: #8b2252;">Available services : none</span>
<span style="color: #8b2252;">Available filters :</span>
<span style="color: #8b2252;">[SPOE] spoe</span>
<span style="color: #8b2252;">[CACHE] cache</span>
<span style="color: #8b2252;">[FCGI] fcgi-app</span>
<span style="color: #8b2252;">[TRACE] trace</span>
<span style="color: #8b2252;">[COMP] compression</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:47c70578-9b65-4d9d-a5a0-fb18e2495eac" class="outline-4">
<h4 id="h:47c70578-9b65-4d9d-a5a0-fb18e2495eac">3.3.4 HAProxy启动文件</h4>
<div class="outline-text-4" id="text-h:47c70578-9b65-4d9d-a5a0-fb18e2495eac">
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#cat /usr/lib/systemd/system/haproxy.service
[Unit]
<span style="color: #a0522d;">Description</span>=HAProxy Load Balancer
<span style="color: #a0522d;">After</span>=syslog.target network.target
[Service]
<span style="color: #a0522d;">ExecStartPre</span>=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg     -c -q
<span style="color: #a0522d;">ExecStart</span>=/usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p
/var/lib/haproxy/haproxy.pid
<span style="color: #a0522d;">ExecReload</span>=/bin/kill -USR2 $<span style="color: #a0522d;">MAINPID</span>
[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#32570;&#23569;&#37197;&#32622;&#25991;&#20214;&#65292;&#26080;&#27861;&#21551;&#21160;</span>
[root@centos7 ~]#systemctl daemon-reload
[root@centos7 ~]#systemctl start haproxy
Job for haproxy.service failed because the control process exited with error
code. See <span style="color: #8b2252;">"systemctl status haproxy.service"</span> and <span style="color: #8b2252;">"journalctl -xe"</span> for details.
[root@centos7 ~]#tail /var/log/messages
Mar 30 22:28:50 centos7 systemd: haproxy.service: control process exited,
<span style="color: #a0522d;">code</span>=exited <span style="color: #a0522d;">status</span>=1
Mar 30 22:28:50 centos7 systemd: Failed to start HAProxy Load Balancer.
Mar 30 22:28:50 centos7 systemd: Unit haproxy.service entered failed state.
Mar 30 22:28:50 centos7 systemd: haproxy.service failed.
Mar 30 22:28:54 centos7 systemd: Starting HAProxy Load Balancer...
Mar 30 22:28:54 centos7 haproxy: [ALERT] 089/222854 (28223) : Cannot open
configuration file/directory /etc/haproxy/haproxy.cfg : No such file or
directory
Mar 30 22:28:54 centos7 systemd: haproxy.service: control process exited,
<span style="color: #a0522d;">code</span>=exited <span style="color: #a0522d;">status</span>=1
Mar 30 22:28:54 centos7 systemd: Failed to start HAProxy Load Balancer.
Mar 30 22:28:54 centos7 systemd: Unit haproxy.service entered failed state.
Mar 30 22:28:54 centos7 systemd: haproxy.service failed.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:793ca369-4500-4bce-a26e-dac0ae03929a" class="outline-4">
<h4 id="h:793ca369-4500-4bce-a26e-dac0ae03929a">3.3.5 配置文件</h4>
<div class="outline-text-4" id="text-h:793ca369-4500-4bce-a26e-dac0ae03929a">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#37197;&#32622;&#25991;&#20214;&#33539;&#20363;</span>
[root@centos7 ~]#tree /usr/local/src/haproxy-2.1.3/examples/
/usr/local/src/haproxy-2.1.3/examples/
&#9500;&#9472;&#9472; acl-content-sw.cfg
&#9500;&#9472;&#9472; content-sw-sample.cfg
&#9500;&#9472;&#9472; errorfiles
&#9474;        &#9500;&#9472;&#9472; 400.http
&#9474;        &#9500;&#9472;&#9472; 403.http
&#9474;        &#9500;&#9472;&#9472; 408.http
&#9474;        &#9500;&#9472;&#9472; 500.http
&#9474;        &#9500;&#9472;&#9472; 502.http
&#9474;        &#9500;&#9472;&#9472; 503.http
&#9474;        &#9500;&#9472;&#9472; 504.http
&#9474;        &#9492;&#9472;&#9472; README
&#9500;&#9472;&#9472; haproxy.init
&#9500;&#9472;&#9472; option-http_proxy.cfg
&#9500;&#9472;&#9472; socks4.cfg
&#9500;&#9472;&#9472; transparent_proxy.cfg
&#9492;&#9472;&#9472; wurfl-example.cfg
1 directory, 15 files
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#33258;&#23450;&#20041;&#30340;&#37197;&#32622;&#25991;&#20214;</span>
[root@centos7 ~]# mkdir /etc/haproxy
[root@centos7 ~]# vim /etc/haproxy/haproxy.cfg
global
    maxconn 100000
        chroot /apps/haproxy
    stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin
        <span style="color: #b22222;">#</span><span style="color: #b22222;">uid 99</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">gid 99</span>
    user haproxy
    group haproxy
    daemon
        <span style="color: #b22222;">#</span><span style="color: #b22222;">nbproc 4</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">cpu-map 1 0</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">cpu-map 2 1</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">cpu-map 3 2</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">cpu-map 4 3</span>
    pidfile /var/lib/haproxy/haproxy.pid
    log 127.0.0.1 local2 info
defaults
    option http-keep-alive
    option forwardfor
    maxconn 100000
    mode http
    timeout connect 300000ms
    timeout client 300000ms
    timeout server 300000ms
listen stats
    mode http
    <span style="color: #483d8b;">bind</span> 0.0.0.0:9999
    stats enable
    log global
    stats uri         /haproxy-status
    stats auth     haadmin:123456
listen web_port
    <span style="color: #483d8b;">bind</span> 10.0.0.7:80
    mode http
    log global
    server web1     127.0.0.1:8080 check inter 3000 fall 2 rise 5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:dac37d38-55b8-4ee9-8c3e-0aaaa0836bdd" class="outline-4">
<h4 id="h:dac37d38-55b8-4ee9-8c3e-0aaaa0836bdd">3.3.6 启动 haproxy</h4>
<div class="outline-text-4" id="text-h:dac37d38-55b8-4ee9-8c3e-0aaaa0836bdd">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20934;&#22791;socket&#25991;&#20214;&#30446;&#24405;</span>
[root@centos7 ~]# mkdir /var/lib/haproxy
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#29992;&#25143;&#21644;&#30446;&#24405;&#26435;&#38480;</span>
[root@centos7 ~]# useradd -r -s /sbin/nologin -d /var/lib/haproxy haproxy
[root@centos7 ~]# systemctl enable --now haproxy
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b41caa40-0b75-4e7e-9482-45a4a7baef4d" class="outline-4">
<h4 id="h:b41caa40-0b75-4e7e-9482-45a4a7baef4d">3.3.7 验证 haproxy 状态</h4>
<div class="outline-text-4" id="text-h:b41caa40-0b75-4e7e-9482-45a4a7baef4d">
<p>
haproxy.cfg文件中定义了chroot、pidfile、user、group等参数，如果系统没
有相应的资源会导致haproxy无法启动，具体参考日志文件/var/log/messages
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#systemctl status haproxy
&#9679; haproxy.service - HAProxy Load Balancer
    Loaded: loaded (/usr/lib/systemd/system/haproxy.service; disabled; vendor
preset: disabled)
    Active: active (running) since Mon 2020-03-30 20:45:20 CST; 4min 45s ago
Process: 1362 <span style="color: #a0522d;">ExecStartPre</span>=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -c -q
(<span style="color: #a0522d;">code</span>=exited, <span style="color: #a0522d;">status</span>=0/SUCCESS)
Main PID: 1363 (haproxy)
    CGroup: /system.slice/haproxy.service
                    &#9500;&#9472;1363 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p
/var/lib/haproxy/haproxy.pid
                    &#9492;&#9472;1366 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p
/var/lib/haproxy/haproxy.pid
Mar 30 20:45:20 centos7.cici.com systemd[1]: Starting HAProxy Load
Balancer...
Mar 30 20:45:20 centos7.cici.com systemd[1]: Started HAProxy Load
Balancer.
Mar 30 20:45:20 centos7.cici.com haproxy[1363]: [NOTICE] 089/204520
(1363) : New worker <span style="color: #b22222;">#</span><span style="color: #b22222;">1 (1366...ked</span>
Mar 30 20:45:20 centos7.cici.com haproxy[1363]: [WARNING] 089/204520
(1366) : Server web_port/we...ue.
Mar 30 20:45:20 centos7.cici.com haproxy[1363]: [ALERT] 089/204520
(1366) : proxy <span style="color: #8b2252;">'web_port'</span> has...le!
Hint: Some lines were ellipsized, use -l to show<span style="color: #a020f0;"> in</span> full.
[root@centos7 ~]# pstree -p |grep haproxy
                    |-haproxy(28101)---haproxy(28105)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1607ff62-d07b-4986-ac69-aa1a6a183ed1" class="outline-4">
<h4 id="h:1607ff62-d07b-4986-ac69-aa1a6a183ed1">3.3.8 查看haproxy的状态页面</h4>
<div class="outline-text-4" id="text-h:1607ff62-d07b-4986-ac69-aa1a6a183ed1">
<p>
浏览器访问： <a href="http://haproxy-server:9999/haproxy-status">http://haproxy-server:9999/haproxy-status</a>
</p>


<figure id="orga8bd9e8">
<img src="images/image-20210225162226639.png" alt="image-20210225162226639.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:f24718b5-a256-4665-abda-ea5862ca86d3" class="outline-3">
<h3 id="h:f24718b5-a256-4665-abda-ea5862ca86d3">3.4 基础配置详解</h3>
<div class="outline-text-3" id="text-h:f24718b5-a256-4665-abda-ea5862ca86d3">
<p>
配置文件官方帮助文档 官方文档：
</p>

<div class="org-src-container">
<pre class="src src-sh">http://cbonte.github.io/haproxy-dconv/
http://cbonte.github.io/haproxy-dconv/2.1/configuration.html
</pre>
</div>

<p>
HAProxy 的配置文件haproxy.cfg由两大部分组成，分别是global和proxies部分 *
global：全局配置段
</p>

<div class="org-src-container">
<pre class="src src-sh">&#36827;&#31243;&#21450;&#23433;&#20840;&#37197;&#32622;&#30456;&#20851;&#30340;&#21442;&#25968;
&#24615;&#33021;&#35843;&#25972;&#30456;&#20851;&#21442;&#25968;
Debug&#21442;&#25968;
</pre>
</div>

<ul class="org-ul">
<li>proxies：代理配置段</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">defaults&#65306;&#20026;frontend, backend, listen&#25552;&#20379;&#40664;&#35748;&#37197;&#32622;
frontend&#65306;&#21069;&#31471;&#65292;&#30456;&#24403;&#20110;nginx&#20013;&#30340;server {}
backend&#65306;&#21518;&#31471;&#65292;&#30456;&#24403;&#20110;nginx&#20013;&#30340;upstream {}
listen&#65306;&#21516;&#26102;&#25317;&#26377;&#21069;&#31471;&#21644;&#21518;&#31471;&#37197;&#32622;,&#37197;&#32622;&#31616;&#21333;,&#29983;&#20135;&#25512;&#33616;&#20351;&#29992;
</pre>
</div>
</div>
<div id="outline-container-h:2be53b22-25fc-4a80-ad7e-5e5665207627" class="outline-4">
<h4 id="h:2be53b22-25fc-4a80-ad7e-5e5665207627">3.4.1 global配置</h4>
<div class="outline-text-4" id="text-h:2be53b22-25fc-4a80-ad7e-5e5665207627">
</div>
<div id="outline-container-h:554416e2-079f-4d97-9112-9092797b9b89" class="outline-5">
<h5 id="h:554416e2-079f-4d97-9112-9092797b9b89">3.4.1.1 global 配置参数说明</h5>
<div class="outline-text-5" id="text-h:554416e2-079f-4d97-9112-9092797b9b89">
<p>
官方文档：<a href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#3">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#3</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">chroot       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38145;&#23450;&#36816;&#34892;&#30446;&#24405;</span>
deamon       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#23432;&#25252;&#36827;&#31243;&#36816;&#34892;</span>
stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin process 1 <span style="color: #b22222;">#</span><span style="color: #b22222;">socket&#25991;&#20214;</span>
user, group, uid, gid     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36816;&#34892;haproxy&#30340;&#29992;&#25143;&#36523;&#20221;</span>
nbproc     n <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#30340;haproxy work &#36827;&#31243;&#25968;&#65292;&#40664;&#35748;&#36827;&#31243;&#25968;&#26159;&#19968;&#20010;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">nbthread 1  #&#21644;&#22810;&#36827;&#31243; nbproc&#37197;&#32622;&#20114;&#26021;&#65288;&#29256;&#26412;&#26377;&#20851;,CentOS8&#30340;haproxy1.8&#26080;&#27492;&#38382;&#39064;&#65289;,&#25351;&#23450;&#27599;&#20010;haproxy&#36827;&#31243;&#24320;&#21551;&#30340;&#32447;&#31243;&#25968;&#65292;&#40664;&#35748;&#20026;&#27599;&#20010;&#36827;&#31243;&#19968;&#20010;&#32447;&#31243;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#21516;&#26102;&#21551;&#29992;nbproc&#21644;nbthread &#20250;&#20986;&#29616;&#20197;&#19979;&#26085;&#24535;&#30340;&#38169;&#35823;&#65292;&#26080;&#27861;&#21551;&#21160;&#26381;&#21153;</span>
Apr     7 14:46:23 haproxy haproxy: [ALERT] 097/144623 (1454) : config : cannot
<span style="color: #483d8b;">enable</span> multiple processes if multiple threads are configured. Please use either
nbproc or nbthread but not both.
cpu-map 1 0     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32465;&#23450;haproxy worker &#36827;&#31243;&#33267;&#25351;&#23450;CPU&#65292;&#23558;&#31532;1&#20010;work&#36827;&#31243;&#32465;&#23450;&#33267;0&#21495;CPU</span>
cpu-map 2 1     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32465;&#23450;haproxy worker &#36827;&#31243;&#33267;&#25351;&#23450;CPU&#65292;&#23558;&#31532;2&#20010;work&#36827;&#31243;&#32465;&#23450;&#33267;1 &#21495;CPU</span>
maxconn n       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#20010;haproxy&#36827;&#31243;&#30340;&#26368;&#22823;&#24182;&#21457;&#36830;&#25509;&#25968;</span>
maxsslconn n    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#20010;haproxy&#36827;&#31243;ssl&#26368;&#22823;&#36830;&#25509;&#25968;,&#29992;&#20110;haproxy&#37197;&#32622;&#20102;&#35777;&#20070;&#30340;&#22330;&#26223;&#19979;</span>
maxconnrate n   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#20010;&#36827;&#31243;&#27599;&#31186;&#21019;&#24314;&#30340;&#26368;&#22823;&#36830;&#25509;&#25968;&#37327;</span>
spread-checks n <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#31471;server&#29366;&#24577;check&#38543;&#26426;&#25552;&#21069;&#25110;&#24310;&#36831;&#30334;&#20998;&#27604;&#26102;&#38388;&#65292;&#24314;&#35758;2-5(20%-50%)&#20043;&#38388;&#65292;&#40664;&#35748;&#20540;0</span>
pidfile         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;pid&#25991;&#20214;&#36335;&#24452;</span>
log 127.0.0.1 local2 info <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#20840;&#23616;&#30340;syslog&#26381;&#21153;&#22120;&#65307;&#26085;&#24535;&#26381;&#21153;&#22120;&#38656;&#35201;&#24320;&#21551;UDP&#21327;&#35758;&#65292;&#26368;&#22810;&#21487;&#20197;&#23450;&#20041;&#20004;&#20010;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f1eb11ce-6ef2-4f1a-9b54-b9dc3f1cfd19" class="outline-5">
<h5 id="h:f1eb11ce-6ef2-4f1a-9b54-b9dc3f1cfd19">3.4.1.2 多进程和线程</h5>
<div class="outline-text-5" id="text-h:f1eb11ce-6ef2-4f1a-9b54-b9dc3f1cfd19">
<p>
范例：多进程和socket文件
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#vim /etc/haproxy/haproxy.cfg
global
maxconn 100000
chroot /apps/haproxy
stats socket /var/lib/haproxy/haproxy.sock1 mode 600 level admin process 1         

stats socket /var/lib/haproxy/haproxy.sock2 mode 600 level admin process 2
uid 99
gid 99
daemon
nbproc 2
[root@centos7 ~]#systemctl restart haproxy
[root@centos7 ~]#pstree -p |grep haproxy
                    |-haproxy(2634)-+-haproxy(2637)
                    |                             <span style="color: #ff00ff;">`-haproxy(2638)</span>
<span style="color: #ff00ff;">[root@centos7 ~]#ll /var/lib/haproxy/</span>
<span style="color: #ff00ff;">total 4</span>
<span style="color: #ff00ff;">-rw-r--r-- 1 root root 5 Mar 31 18:49 haproxy.pid</span>
<span style="color: #ff00ff;">srw------- 1 root root 0 Mar 31 18:49 haproxy.sock1</span>
<span style="color: #ff00ff;">srw------- 1 root root 0 Mar 31 18:49 haproxy.sock2</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d3469130-e2d0-4ec8-aad3-262f64f8f852" class="outline-5">
<h5 id="h:d3469130-e2d0-4ec8-aad3-262f64f8f852">3.4.1.3 HAProxy日志配置</h5>
<div class="outline-text-5" id="text-h:d3469130-e2d0-4ec8-aad3-262f64f8f852">
<p>
HAproxy本身不记录客户端的访问日志.此外为减少服务器负载,一般生产中HAProxy不记录日志.
也可以配置HAProxy利用rsyslog服务记录日志到指定日志文件中
</p>
</div>
<ul class="org-ul">
<li><a id="h:440eee5e-08ba-42b1-8b95-7ca8ffcc7e54"></a>3.4.1.3.1 HAProxy配置<br>
<div class="outline-text-6" id="text-h:440eee5e-08ba-42b1-8b95-7ca8ffcc7e54">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;global&#37197;&#32622;&#39033;&#23450;&#20041;&#65306;</span>
log 127.0.0.1 local{1-7} info <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110;syslog&#35760;&#24405;&#26085;&#24535;&#21040;&#25351;&#23450;&#35774;&#22791;&#65292;&#32423;&#21035;&#26377;(err&#12289;warning&#12289;</span>
info&#12289;debug)
listen web_port
<span style="color: #483d8b;">bind</span> 127.0.0.1:80
mode http
log global <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#24403;&#21069;web_port&#30340;&#26085;&#24535;&#21151;&#33021;&#65292;&#40664;&#35748;&#19981;&#35760;&#24405;&#26085;&#24535;</span>
server web1     127.0.0.1:8080 check inter 3000 fall 2 rise 5
<span style="color: #b22222;"># </span><span style="color: #b22222;">systemctl restart haproxy</span>
</pre>
</div>
</div>
</li>
<li><a id="h:9afbfb07-3eaf-4791-ae4a-dc2a6bc5e49c"></a>3.4.1.3.2 Rsyslog配置<br>
<div class="outline-text-6" id="text-h:9afbfb07-3eaf-4791-ae4a-dc2a6bc5e49c">
<div class="org-src-container">
<pre class="src src-sh">vim /etc/rsyslog.conf
$<span style="color: #a0522d;">ModLoad</span> imudp
$<span style="color: #a0522d;">UDPServerRun</span> 514
......
local3.*     /var/log/haproxy.log
......
<span style="color: #b22222;"># </span><span style="color: #b22222;">systemctl restart rsyslog</span>
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:fa3a00ab-d48d-4a09-ba58-84284df41d00" class="outline-5">
<h5 id="h:fa3a00ab-d48d-4a09-ba58-84284df41d00">3.4.1.3.3 验证HAProxy日志</h5>
<div class="outline-text-5" id="text-h:fa3a00ab-d48d-4a09-ba58-84284df41d00">
<p>
重启syslog服务并访问app页面，然后验证是否生成日志
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">tail -f /var/log/haproxy.log</span>
Aug 14 20:21:06 localhost haproxy[18253]: Connect from 192.168.0.1:3050 to
10.0.0.7:80 (web_host/HTTP)
Aug 14 20:21:06 localhost haproxy[18253]: Connect from 192.168.0.1:3051 to
10.0.0.7:80 (web_host/HTTP)
Aug 14 20:21:06 localhost haproxy[18253]: Connect from 192.168.0.1:3050 to
10.0.0.7:80 (web_host/HTTP)
</pre>
</div>
</div>
<ul class="org-ul">
<li><a id="h:9e550ac9-5431-49b7-ab96-6e23ca438731"></a>3.4.1.3.4 实战案例：启动本地和远程日志<br>
<div class="outline-text-6" id="text-h:9e550ac9-5431-49b7-ab96-6e23ca438731">
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#vim /etc/haproxy/haproxy.cfg
log 127.0.0.1 local2 info
log 10.0.0.8 local2 info
[root@centos7 ~]#systemctl restart haproxy
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#26412;&#22320;&#26085;&#24535;</span>
[root@centos7 ~]#vim /etc/rsyslog.conf
$<span style="color: #a0522d;">ModLoad</span> imudp
$<span style="color: #a0522d;">UDPServerRun</span> 514
......
local2.*                                                                             /var/log/haproxy.log
[root@centos7 ~]#systemctl restart rsyslog
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#36828;&#31243;&#20027;&#26426;&#26085;&#24535;</span>
[root@centos8 ~]#vim /etc/rsyslog.conf
<span style="color: #0000ff;">module</span>(<span style="color: #a0522d;">load</span>=<span style="color: #8b2252;">"imudp"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">needs to be done just once </span>
<span style="color: #0000ff;">input</span>(<span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"imudp"</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">"514"</span>)
local3.*                                     /var/log/haproxy.log
[root@centos8 ~]#systemctl restart rsyslog
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27983;&#35272;&#22120;&#35775;&#38382;&#65306;http://haproxy-server:9999/haproxy-status,&#35266;&#23519;&#26412;&#26426;&#21644;&#36828;&#31243;&#20027;&#26426;&#29983;&#25104;&#30340;&#26085;&#24535;</span>
[root@centos7 ~]#tail /var/log/haproxy.log
[root@centos7 ~]#cat /var/log/haproxy.log
Mar 30 23:42:52 localhost haproxy[28643]: Connect from 10.0.0.1:7820 to
10.0.0.7:9999 (stats/HTTP)
Mar 30 23:42:52 localhost haproxy[28643]: Connect from 10.0.0.1:7821 to
10.0.0.7:9999 (stats/HTTP)
Mar 30 23:42:53 localhost haproxy[28643]: Connect from 10.0.0.1:7822 to
10.0.0.7:9999 (stats/HTTP)
[root@centos8 ~]#tail /var/log/haproxy.log
Mar 30 23:42:53 10.0.0.7 haproxy[28643]: Connect from 10.0.0.1:7824 to
10.0.0.7:9999 (stats/HTTP)
Mar 30 23:42:53 10.0.0.7 haproxy[28643]: Connect from 10.0.0.1:7825 to
10.0.0.7:9999 (stats/HTTP)
Mar 30 23:42:53 10.0.0.7 haproxy[28643]: Connect from 10.0.0.1:7826 to
10.0.0.7:9999 (stats/HTTP)
Mar 30 23:42:53 10.0.0.7 haproxy[28643]: Connect from 10.0.0.1:7827 to
10.0.0.7:9999 (stats/HTTP)
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:187099ee-dfe4-4627-a53e-91c8254cf2c5" class="outline-4">
<h4 id="h:187099ee-dfe4-4627-a53e-91c8254cf2c5">3.4.2 Proxies配置</h4>
<div class="outline-text-4" id="text-h:187099ee-dfe4-4627-a53e-91c8254cf2c5">
<p>
官方文档：<a href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">defaults [&lt;name&gt;]   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#37197;&#32622;&#39033;&#65292;&#38024;&#23545;&#20197;&#19979;&#30340;frontend&#12289;backend&#21644;listen&#29983;&#25928;&#65292;&#21487;&#20197;&#22810;&#20010;name&#20063;&#21487;&#20197;&#27809;&#26377;name</span>
frontend &lt;name&gt;     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21069;&#31471;servername&#65292;&#31867;&#20284;&#20110;Nginx&#30340;&#19968;&#20010;&#34394;&#25311;&#20027;&#26426; server&#21644;LVS&#26381;&#21153;&#38598;&#32676;&#12290;</span>
backend &lt;name&gt;      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#31471;&#26381;&#21153;&#22120;&#32452;&#65292;&#31561;&#20110;nginx&#30340;upstream&#21644;LVS&#20013;&#30340;RS&#26381;&#21153;&#22120;</span>
listen     &lt;name&gt;   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;frontend&#21644;backend&#21512;&#24182;&#22312;&#19968;&#36215;&#37197;&#32622;&#65292;&#30456;&#23545;&#20110;frontend&#21644;backend&#37197;&#32622;&#26356;&#31616;&#27905;&#65292;&#29983;&#20135;&#24120;&#29992;</span>
</pre>
</div>

<p>
注意：
</p>

<div class="org-src-container">
<pre class="src src-sh">name&#23383;&#27573;&#21482;&#33021;&#20351;&#29992;&#22823;&#23567;&#20889;&#23383;&#27597;&#65292;&#25968;&#23383;&#65292;<span style="color: #8b2252;">'-'</span>(dash)&#65292;<span style="color: #8b2252;">'_'</span>(underscore)&#65292;<span style="color: #8b2252;">'.'</span> (dot)&#21644; <span style="color: #8b2252;">':'</span>(colon)&#65292;&#24182;&#19988;&#20005;&#26684;&#21306;&#20998;&#22823;&#23567;&#20889;
</pre>
</div>


<figure id="org8b42f3d">
<img src="images/image-20210225162315804.png" alt="image-20210225162315804.png">

</figure>
</div>
<div id="outline-container-h:39278c57-4e79-4cf7-96a0-a2ee9c576283" class="outline-5">
<h5 id="h:39278c57-4e79-4cf7-96a0-a2ee9c576283">3.4.2.1 Proxies配置-defaults</h5>
<div class="outline-text-5" id="text-h:39278c57-4e79-4cf7-96a0-a2ee9c576283">
<p>
defaults 配置参数：
</p>

<div class="org-src-container">
<pre class="src src-sh">option redispatch            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;server Id&#23545;&#24212;&#30340;&#26381;&#21153;&#22120;&#25346;&#25481;&#21518;&#65292;&#24378;&#21046;&#23450;&#21521;&#21040;&#20854;&#20182;&#20581;&#24247;&#30340;&#26381;&#21153;&#22120;&#65292;&#37325;&#26032;&#27966;&#21457;</span>
option abortonclose          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#26381;&#21153;&#22120;&#36127;&#36733;&#24456;&#39640;&#26102;&#65292;&#33258;&#21160;&#32467;&#26463;&#25481;&#24403;&#21069;&#38431;&#21015;&#22788;&#29702;&#27604;&#36739;&#20037;&#30340;&#36830;&#25509;&#65292;&#38024;&#23545;&#19994;&#21153;&#24773;&#20917;&#36873;&#25321;&#24320;&#21551;</span>
option http-keep-alive       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#19982;&#23458;&#25143;&#31471;&#30340;&#20250;&#35805;&#20445;&#25345;</span>
option forwardfor            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36879;&#20256;&#23458;&#25143;&#31471;&#30495;&#23454;IP&#33267;&#21518;&#31471;web&#26381;&#21153;&#22120;</span>
mode http|tcp                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#40664;&#35748;&#24037;&#20316;&#31867;&#22411;,&#20351;&#29992;TCP&#26381;&#21153;&#22120;&#24615;&#33021;&#26356;&#22909;&#65292;&#20943;&#23569;&#21387;&#21147;</span>
timeout http-keep-alive 120s <span style="color: #b22222;">#</span><span style="color: #b22222;">session &#20250;&#35805;&#20445;&#25345;&#36229;&#26102;&#26102;&#38388;&#65292;&#27492;&#26102;&#38388;&#27573;&#20869;&#20250;&#36716;&#21457;&#21040;&#30456;&#21516;&#30340;&#21518;&#31471;&#26381;&#21153;&#22120;</span>
timeout connect 120s         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#35831;&#27714;&#20174;haproxy&#21040;&#21518;&#31471;server&#26368;&#38271;&#36830;&#25509;&#31561;&#24453;&#26102;&#38388;(TCP&#36830;&#25509;&#20043;&#21069;)&#65292;&#40664;&#35748;&#21333;&#20301;ms</span>
timeout server 600s          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#35831;&#27714;&#20174;haproxy&#21040;&#21518;&#31471;&#26381;&#21153;&#31471;&#30340;&#35831;&#27714;&#22788;&#29702;&#36229;&#26102;&#26102;&#38271;(TCP&#36830;&#25509;&#20043;&#21518;)&#65292;&#40664;&#35748;&#21333;&#20301;ms&#65292;&#22914;&#26524;&#36229;&#26102;&#65292;&#20250;&#20986;&#29616;502&#38169;&#35823;&#65292;&#27492;&#20540;&#24314;&#35758;&#35774;&#32622;&#36739;&#22823;&#20123;&#65292;&#35775;&#27490;502&#38169;&#35823;</span>
timeout client 600s          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;haproxy&#19982;&#23458;&#25143;&#31471;&#30340;&#26368;&#38271;&#38750;&#27963;&#21160;&#26102;&#38388;&#65292;&#40664;&#35748;&#21333;&#20301;ms&#65292;&#24314;&#35758;&#21644;timeout server&#30456;&#21516;</span>
timeout check     5s         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#21518;&#31471;&#26381;&#21153;&#22120;&#30340;&#40664;&#35748;&#26816;&#27979;&#36229;&#26102;&#26102;&#38388;</span>
default-server inter 1000 weight 3     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#21518;&#31471;&#26381;&#21153;&#22120;&#30340;&#40664;&#35748;&#35774;&#32622;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:46e47a12-f057-498a-a3cc-0ac9b8d73489" class="outline-5">
<h5 id="h:46e47a12-f057-498a-a3cc-0ac9b8d73489">3.4.2.2 Proxies配置-listen 简化配置</h5>
<div class="outline-text-5" id="text-h:46e47a12-f057-498a-a3cc-0ac9b8d73489">
<p>
使用listen替换
frontend和backend的配置方式，可以简化设置，通常只用于TCP协议的应用
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23448;&#32593;&#19994;&#21153;&#35775;&#38382;&#20837;&#21475;</span>
listen WEB_PORT_80
    <span style="color: #483d8b;">bind</span> 10.0.0.7:80 
    mode http
    option forwardfor
    server web1     10.0.0.17:8080     check inter 3000 fall 3 rise 5
    server web2     10.0.0.27:8080     check inter 3000 fall 3 rise 5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:87701129-e96f-47a0-abbd-d3e83b4cbf93" class="outline-5">
<h5 id="h:87701129-e96f-47a0-abbd-d3e83b4cbf93">3.4.2.3 Proxies配置-frontend</h5>
<div class="outline-text-5" id="text-h:87701129-e96f-47a0-abbd-d3e83b4cbf93">
<p>
<b>frontend 配置参数：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">bind</span>&#65306; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;HAProxy&#30340;&#30417;&#21548;&#22320;&#22336;&#65292;&#21487;&#20197;&#26159;IPV4&#25110;IPV6&#65292;&#21487;&#20197;&#21516;&#26102;&#30417;&#21548;&#22810;&#20010;IP&#25110;&#31471;&#21475;&#65292;&#21487;&#21516;&#26102;&#29992;&#20110;listen&#23383;&#27573;&#20013;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26684;&#24335;&#65306;</span>
<span style="color: #483d8b;">bind</span> [&lt;address&gt;]:&lt;port_range&gt; [, ...] [param*]
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#65306;&#22914;&#26524;&#38656;&#35201;&#32465;&#23450;&#22312;&#38750;&#26412;&#26426;&#30340;IP&#65292;&#38656;&#35201;&#24320;&#21551;&#20869;&#26680;&#21442;&#25968;&#65306;net.ipv4.ip_nonlocal_bind=1</span>
backlog &lt;backlog&gt; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38024;&#23545;&#25152;&#26377;server&#37197;&#32622;,&#24403;&#21069;&#31471;&#26381;&#21153;&#22120;&#30340;&#36830;&#25509;&#25968;&#36798;&#21040;&#19978;&#38480;&#21518;&#30340;&#21518;&#25588;&#38431;&#21015;&#38271;&#24230;&#65292;&#27880;&#24847;&#65306;&#19981;&#25903;&#25345;backend</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">listen http_proxy                           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30417;&#21548;http&#30340;&#22810;&#20010;IP&#30340;&#22810;&#20010;&#31471;&#21475;&#21644;sock&#25991;&#20214;</span>
    <span style="color: #483d8b;">bind</span> :80,:443,:8801-8810
    <span style="color: #483d8b;">bind</span> 10.0.0.1:10080,10.0.0.1:10443
    <span style="color: #483d8b;">bind</span> /var/run/ssl-frontend.sock user root mode 600 accept-proxy
listen http_https_proxy                     <span style="color: #b22222;">#</span><span style="color: #b22222;">https&#30417;&#21548;</span>
    <span style="color: #483d8b;">bind</span> :80
    <span style="color: #483d8b;">bind</span> :443 ssl crt /etc/haproxy/site.pem <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20844;&#38053;&#21644;&#31169;&#38053;&#20844;&#20849;&#25991;&#20214;</span>
listen http_https_proxy_explicit            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30417;&#21548;ipv6&#12289;ipv4&#21644;unix sock&#25991;&#20214;</span>
    <span style="color: #483d8b;">bind</span> ipv6@:80
    <span style="color: #483d8b;">bind</span> ipv4@public_ssl:443 ssl crt /etc/haproxy/site.pem
    <span style="color: #483d8b;">bind</span> unix@ssl-frontend.sock user root mode 600 accept-proxy
listen external_bind_app1                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30417;&#21548;file descriptor</span>
    <span style="color: #483d8b;">bind</span> <span style="color: #8b2252;">"fd@${FD_APP1}"</span>
</pre>
</div>

<p>
<b>生产示例：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">frontend me_web_port               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#37319;&#29992;&#21518;&#38754;&#24418;&#24335;&#21629;&#21517;&#65306;&#19994;&#21153;-&#26381;&#21153;-&#31471;&#21475;&#21495;</span>
    <span style="color: #483d8b;">bind</span> :80,:8080
    <span style="color: #483d8b;">bind</span> 10.0.0.7:10080,:8801-8810,10.0.0.17:9001-9010
    mode http|tcp                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#36127;&#36733;&#21327;&#35758;&#31867;&#22411;</span>
    use_backend &lt;backend_name&gt;     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35843;&#29992;&#30340;&#21518;&#31471;&#26381;&#21153;&#22120;&#32452;&#21517;&#31216;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e6e6478d-eee5-4887-bbe0-aeba35df1096" class="outline-5">
<h5 id="h:e6e6478d-eee5-4887-bbe0-aeba35df1096">3.4.2.4 Proxies配置-backend</h5>
<div class="outline-text-5" id="text-h:e6e6478d-eee5-4887-bbe0-aeba35df1096">
<p>
定义一组后端服务器，backend服务器将被frontend进行调用。
</p>

<p>
注意: backend的名称必须唯一,并且必须在listen或frontend中事先定义才可以使用,否则服务无法启动
</p>

<div class="org-src-container">
<pre class="src src-sh">mode http|tcp  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#36127;&#36733;&#21327;&#35758;&#31867;&#22411;,&#21644;&#23545;&#24212;&#30340;frontend&#24517;&#39035;&#19968;&#33268;</span>
option         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#36873;&#39033;</span>
server         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#21518;&#31471;real server,&#24517;&#39035;&#25351;&#23450;IP&#21644;&#31471;&#21475;</span>
</pre>
</div>

<p>
注意：option后面加httpchk，smtpchk,mysql-check,pgsql-check，
ssl-hello-chk方法，可用于实现更多应用层检测功能。
</p>

<p>
<b>server 配置</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#38024;&#23545;&#19968;&#20010;server&#37197;&#32622;</span>
check              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#25351;&#23450;real&#36827;&#34892;&#20581;&#24247;&#29366;&#24577;&#26816;&#26597;&#65292;&#22914;&#26524;&#19981;&#21152;&#27492;&#35774;&#32622;&#65292;&#40664;&#35748;&#19981;&#24320;&#21551;&#26816;&#26597;,&#21482;&#26377;check&#21518;&#38754;&#27809;&#26377;&#20854;&#23427;&#37197;&#32622;&#20063;&#21487;&#20197;&#21551;&#29992;&#26816;&#26597;&#21151;&#33021;</span>
                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#23545;&#30456;&#24212;&#30340;&#21518;&#31471;&#26381;&#21153;&#22120;IP&#21644;&#31471;&#21475;,&#21033;&#29992;TCP&#36830;&#25509;&#36827;&#34892;&#21608;&#26399;&#24615;&#20581;&#24247;&#24615;&#26816;&#26597;,&#27880;&#24847;&#24517;&#39035;&#25351;&#23450;&#31471;&#21475;&#25165;&#33021;&#23454;&#29616;&#20581;&#24247;&#24615;&#26816;&#26597;</span>
addr &lt;IP&gt;          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#25351;&#23450;&#30340;&#20581;&#24247;&#29366;&#24577;&#30417;&#27979;IP&#65292;&#21487;&#20197;&#26159;&#19987;&#38376;&#30340;&#25968;&#25454;&#32593;&#27573;&#65292;&#20943;&#23569;&#19994;&#21153;&#32593;&#32476;&#30340;&#27969;&#37327;</span>
port &lt;num&gt;         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#30340;&#20581;&#24247;&#29366;&#24577;&#30417;&#27979;&#31471;&#21475;</span>
inter &lt;num&gt;        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20581;&#24247;&#29366;&#24577;&#26816;&#26597;&#38388;&#38548;&#26102;&#38388;&#65292;&#40664;&#35748;2000 ms</span>
fall &lt;num&gt;         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#31471;&#26381;&#21153;&#22120;&#20174;&#32447;&#19978;&#36716;&#20026;&#32447;&#19979;&#30340;&#26816;&#26597;&#30340;&#36830;&#32493;&#22833;&#25928;&#27425;&#25968;&#65292;&#40664;&#35748;&#20026;3</span>
rise &lt;num&gt;         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#31471;&#26381;&#21153;&#22120;&#20174;&#19979;&#32447;&#24674;&#22797;&#19978;&#32447;&#30340;&#26816;&#26597;&#30340;&#36830;&#32493;&#26377;&#25928;&#27425;&#25968;&#65292;&#40664;&#35748;&#20026;2</span>
weight &lt;weight&gt;    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#20026;1&#65292;&#26368;&#22823;&#20540;&#20026;256&#65292;0(&#29366;&#24577;&#20026;&#34013;&#33394;)&#34920;&#31034;&#19981;&#21442;&#19982;&#36127;&#36733;&#22343;&#34913;&#65292;&#20294;&#20173;&#25509;&#21463;&#25345;&#20037;&#36830;&#25509;</span>
backup             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#21518;&#31471;&#26381;&#21153;&#22120;&#26631;&#35760;&#20026;&#22791;&#20221;&#29366;&#24577;,&#21482;&#22312;&#25152;&#26377;&#38750;&#22791;&#20221;&#20027;&#26426;down&#26426;&#26102;&#25552;&#20379;&#26381;&#21153;&#65292;&#31867;&#20284;</span>
Sorry Server
disabled           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#21518;&#31471;&#26381;&#21153;&#22120;&#26631;&#35760;&#20026;&#19981;&#21487;&#29992;&#29366;&#24577;&#65292;&#21363;&#32500;&#25252;&#29366;&#24577;&#65292;&#38500;&#20102;&#25345;&#20037;&#27169;&#24335;&#65292;&#23558;&#19981;&#20877;&#25509;&#21463;&#36830;&#25509;,&#29366;&#24577;&#20026;&#28145;&#40644;&#33394;</span>
redirect prefix http://www.baidu.com/ <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#35831;&#27714;&#20020;&#26102;(302)&#37325;&#23450;&#21521;&#33267;&#20854;&#23427;URL&#65292;&#21482;&#36866;&#29992;&#20110;http&#27169;&#24335;</span>
redir http://www.baidu.com            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#35831;&#27714;&#20020;&#26102;(302)&#37325;&#23450;&#21521;&#33267;&#20854;&#23427;URL&#65292;&#21482;&#36866;&#29992;&#20110;http&#27169;&#24335;</span>
maxconn &lt;maxconn&gt;                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#21518;&#31471;server&#30340;&#26368;&#22823;&#24182;&#21457;&#36830;&#25509;&#25968;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a3c932d7-b9ad-4b6f-b7df-b64a62231f7d" class="outline-5">
<h5 id="h:a3c932d7-b9ad-4b6f-b7df-b64a62231f7d">3.4.2.5 frontend+backend 配置实例</h5>
<div class="outline-text-5" id="text-h:a3c932d7-b9ad-4b6f-b7df-b64a62231f7d">
<p>
范例1：
</p>

<div class="org-src-container">
<pre class="src src-sh">frontend me-test-http
<span style="color: #483d8b;">bind</span> :80,:8080
mode tcp
use_backend me-test-http-nodes
backend me-test-http-nodes
mode tcp
default-server inter 1000 weight 6 
server web1 10.0.0.17:80 weight 2 check addr 10.0.0.117 port 8080
server web1 10.0.0.27:80 check
</pre>
</div>

<p>
范例2：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23448;&#32593;&#19994;&#21153;&#35775;&#38382;&#20837;&#21475;</span>
frontend WEB_PORT_80
    <span style="color: #483d8b;">bind</span> 10.0.0.7:80
    mode http
    use_backend web_prot_http_nodes
backend web_prot_http_nodes
    mode http
    option forwardfor
    server 10.0.0.17 10.0.0.17:8080     check inter 3000 fall 3 rise 5 
    server 10.0.0.27 10.0.0.27:8080     check inter 3000 fall 3 rise 5
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:7747d976-ffa3-4ab7-8791-97538101f63c" class="outline-4">
<h4 id="h:7747d976-ffa3-4ab7-8791-97538101f63c">3.4.3 使用子配置文件保存配置</h4>
<div class="outline-text-4" id="text-h:7747d976-ffa3-4ab7-8791-97538101f63c">
<p>
当业务众多时，将所有配置都放在一个配置文件中，会造成维护困难。可以考虑按业务分类，将配置信息拆分，放在不同的子配置文件中，从而达到方便维护的目的。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#23376;&#37197;&#32622;&#30446;&#24405;</span>
[root@centos7 ~]#mkdir /etc/haproxy/conf.d/
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#23376;&#37197;&#32622;&#25991;&#20214;&#65292;&#27880;&#24847;&#65306;&#24517;&#39035;&#20026;cfg&#21518;&#32512;&#38750;.&#24320;&#22836;&#30340;&#37197;&#32622;&#25991;&#20214;</span>
[root@centos7 ~]#vim     /etc/haproxy/conf.d/test.cfg
listen WEB_PORT_80
<span style="color: #483d8b;">bind</span> 10.0.0.7:80
mode http
balance roundrobin
server web1     10.0.0.17:80 check inter 3000 fall 2 rise 5
server web2     10.0.0.27:80 check inter 3000 fall 2 rise 5
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#23376;&#37197;&#32622;&#30446;&#24405;&#21040;unit&#25991;&#20214;&#20013;</span>
[root@centos7 ~]#vim /lib/systemd/system/haproxy.service
[Unit]
<span style="color: #a0522d;">Description</span>=HAProxy Load Balancer
<span style="color: #a0522d;">After</span>=syslog.target network.target
[Service]
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#19979;&#38754;&#20004;&#34892;</span>
<span style="color: #a0522d;">ExecStartPre</span>=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -f
/etc/haproxy/conf.d/ -c -q
<span style="color: #a0522d;">ExecStart</span>=/usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -f
/etc/haproxy/conf.d/     -p /var/lib/haproxy/haproxy.pid
<span style="color: #a0522d;">ExecReload</span>=/bin/kill -USR2 $<span style="color: #a0522d;">MAINPID</span>
[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target
[root@centos7 ~]#systemctl daemon-reload
[root@centos7 ~]#systemctl restart haproxy
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:9de26cb4-f854-43f1-acb1-a0199b1c0026" class="outline-2">
<h2 id="h:9de26cb4-f854-43f1-acb1-a0199b1c0026">4 HAProxy调度算法</h2>
<div class="outline-text-2" id="text-h:9de26cb4-f854-43f1-acb1-a0199b1c0026">
<p>
HAProxy通过固定参数 balance指明对后端服务器的调度算法，该参数可以配置在listen或backend选项中。
</p>

<p>
HAProxy的调度算法分为静态和动态调度算法，但是有些算法可以根据参数在静态和动态算法中相互转换。
</p>

<p>
官方文档：<a href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-balance">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-balance</a>
</p>
</div>
<div id="outline-container-h:742d7129-92fb-449f-be33-e5741c7523ce" class="outline-3">
<h3 id="h:742d7129-92fb-449f-be33-e5741c7523ce">4.1 静态算法</h3>
<div class="outline-text-3" id="text-h:742d7129-92fb-449f-be33-e5741c7523ce">
<p>
静态算法：按照事先定义好的规则轮询公平调度，不关心后端服务器的当前负载、连接数和响应速度等，且无法实时修改权重(只能为0和1,不支持其它值)，只能靠重启HAProxy生效。
</p>
</div>
<div id="outline-container-h:cd26a676-528d-4772-9cff-7308d839e5cd" class="outline-4">
<h4 id="h:cd26a676-528d-4772-9cff-7308d839e5cd">4.1.1 socat 工具</h4>
<div class="outline-text-4" id="text-h:cd26a676-528d-4772-9cff-7308d839e5cd">
<p>
对服务器动态权重和其它状态可以利用 socat工具进行调整，Socat 是 Linux下
的一个多功能的网络工具，名字来由是Socket CAT，相当于netCAT的增强
版.Socat的主要特点就是在两个数据流之间建立双向通道，且支持众多协议和链
接方式。如IP、TCP、 UDP、IPv6、Socket文件等
</p>

<p>
范例：利用工具socat 对服务器动态权重调整
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#yum -y install socat
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24110;&#21161;</span>
[root@centos7 ~]#socat -h
[root@centos7 ~]#echo <span style="color: #8b2252;">"help"</span> | socat stdio /var/lib/haproxy/haproxy.sock
Unknown command. Please enter one of the following commands only :
<span style="color: #483d8b;">help</span>                     : this message
prompt                 : toggle interactive mode with prompt
quit                     : disconnect
show tls-keys [id|*]: show tls keys references or dump tls ticket keys when id
specified
    <span style="color: #483d8b;">set</span> ssl tls-key [id|keyfile] &lt;tlskey&gt;: set the next TLS key for the &lt;id&gt; or
&lt;keyfile&gt; listener to &lt;tlskey&gt;
    <span style="color: #483d8b;">set</span> ssl cert &lt;certfile&gt; &lt;payload&gt; : replace a certificate file
commit ssl cert &lt;certfile&gt; : commit a certificate file
abort ssl cert &lt;certfile&gt; : abort a transaction for a certificate file
show sess [id] : report the list of current sessions or dump this session
shutdown session : kill a specific session
shutdown sessions server : kill sessions on a server
    clear counters : clear max statistics counters (add <span style="color: #8b2252;">'all'</span> for all counters)
show info         : report information about the running process
[desc|json|typed]*
show stat         : report counters for each proxy and server [desc|json|typed]*
show schema json : report schema used for stats
disable agent : disable agent checks (use <span style="color: #8b2252;">'set server'</span> instead)
disable health : disable health checks (use <span style="color: #8b2252;">'set server'</span> instead)
disable server : disable a server for maintenance (use <span style="color: #8b2252;">'set server'</span> instead) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#29992;&#26381;&#21153;&#22120;</span>
<span style="color: #483d8b;">enable</span> agent     : enable agent checks (use <span style="color: #8b2252;">'set server'</span> instead)
<span style="color: #483d8b;">enable</span> health : enable health checks (use <span style="color: #8b2252;">'set server'</span> instead)
<span style="color: #483d8b;">enable</span> server : enable a disabled server (use <span style="color: #8b2252;">'set server'</span> instead)     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#26381;&#21153;&#22120;</span>
    <span style="color: #483d8b;">set</span> maxconn server : change a server<span style="color: #8b2252;">'s maxconn setting</span>
<span style="color: #8b2252;">    set server         : change a server'</span>s state, weight or address                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26381;&#21153;&#22120;</span>
    get weight         : report a server<span style="color: #8b2252;">'s current weight</span>
<span style="color: #8b2252;">    set weight         : change a server'</span>s weight (deprecated)
show startup-logs : report logs emitted during HAProxy startup
show peers [peers section]: dump some information about all the peers or this
peers section
    <span style="color: #483d8b;">set</span> maxconn global : change the per-process maxconn setting
    <span style="color: #483d8b;">set</span> rate-limit : change a rate limiting value
    <span style="color: #483d8b;">set</span> severity-output [none|number|string] : set presence of severity level<span style="color: #a020f0;"> in</span>
feedback information
    <span style="color: #483d8b;">set</span> timeout     : change a timeout setting
show env [var] : dump environment variables known to the process
show cli sockets : dump list of cli sockets
show cli level     : display the level of the current CLI session
show fd [num] : dump list of file descriptors<span style="color: #a020f0;"> in</span> use
show activity : show per-thread activity stats (<span style="color: #a020f0;">for</span> support/developers)
operator             : lower the level of the current CLI session to operator
user                     : lower the level of the current CLI session to user
    clear table     : remove an entry from a table
    <span style="color: #483d8b;">set</span> table [id] : update or create a table entry<span style="color: #8b2252;">'s data</span>
<span style="color: #8b2252;">show table [id]: report table usage stats or dump this table'</span>s contents
disable frontend : temporarily disable specific frontend
<span style="color: #483d8b;">enable</span> frontend : re-enable specific frontend
    <span style="color: #483d8b;">set</span> maxconn frontend : change a frontend<span style="color: #8b2252;">'s maxconn setting</span>
<span style="color: #8b2252;"> show servers state [id]: dump volatile server information (for backend &lt;id&gt;)</span>
<span style="color: #8b2252;">show backend     : list backends in the current running config</span>
<span style="color: #8b2252;">shutdown frontend : stop a specific frontend</span>
<span style="color: #8b2252;">    set dynamic-cookie-key backend : change a backend secret key for dynamic</span>
<span style="color: #8b2252;">cookies</span>
<span style="color: #8b2252;">enable dynamic-cookie backend : enable dynamic cookies on a specific backend</span>
<span style="color: #8b2252;">disable dynamic-cookie backend : disable dynamic cookies on a specific backend</span>
<span style="color: #8b2252;">show errors     : report last request and response errors for each proxy</span>
<span style="color: #8b2252;">show resolvers [id]: dumps counters from all resolvers section and</span>
<span style="color: #8b2252;">                                        associated name servers</span>
<span style="color: #8b2252;">show cache         : show cache status</span>
<span style="color: #8b2252;">add acl             : add acl entry</span>
<span style="color: #8b2252;">    clear acl &lt;id&gt; : clear the content of this acl</span>
<span style="color: #8b2252;">del acl             : delete acl entry</span>
<span style="color: #8b2252;">    get acl             : report the patterns matching a sample for an ACL</span>
<span style="color: #8b2252;">show acl [id] : report available acls or dump an acl'</span>s contents
add map             : add map entry
    clear map &lt;id&gt; : clear the content of this map
del map             : delete map entry
    get map             : report the keys and values matching a sample for a map
    <span style="color: #483d8b;">set</span> map             : modify map entry
show map [id] : report available maps or dump a map<span style="color: #8b2252;">'s contents</span>
<span style="color: #8b2252;">trace &lt;module&gt; [cmd [args...]] : manage live tracing</span>
<span style="color: #8b2252;">show trace [&lt;module&gt;] : show live tracing state</span>
<span style="color: #8b2252;">show threads     : show some threads debugging information</span>
<span style="color: #8b2252;">show pools         : report information about the memory pools usage</span>
<span style="color: #8b2252;">show events [&lt;sink&gt;] : show event sink state</span>
<span style="color: #8b2252;">show profiling : show CPU profiling options</span>
<span style="color: #8b2252;">    set profiling : enable/disable CPU profiling</span>
<span style="color: #8b2252;">[root@centos7 ~]#echo "show info" | socat stdio /var/lib/haproxy/haproxy.sock</span>
<span style="color: #8b2252;">Name: HAProxy</span>
<span style="color: #8b2252;">Version: 2.1.3</span>
<span style="color: #8b2252;">Release_date: 2020/02/12</span>
<span style="color: #8b2252;">Nbthread: 4</span>
<span style="color: #8b2252;">Nbproc: 1</span>
<span style="color: #8b2252;">Process_num: 1</span>
<span style="color: #8b2252;">Pid: 2279</span>
<span style="color: #8b2252;">Uptime: 0d 0h46m07s</span>
<span style="color: #8b2252;">Uptime_sec: 2767</span>
<span style="color: #8b2252;">Memmax_MB: 0</span>
<span style="color: #8b2252;">PoolAlloc_MB: 0</span>
<span style="color: #8b2252;">PoolUsed_MB: 0</span>
<span style="color: #8b2252;">PoolFailed: 0</span>
<span style="color: #8b2252;">Ulimit-n: 200041</span>
<span style="color: #8b2252;">Maxsock: 200041</span>
<span style="color: #8b2252;">Maxconn: 100000</span>
<span style="color: #8b2252;">Hard_maxconn: 100000</span>
<span style="color: #8b2252;">CurrConns: 0</span>
<span style="color: #8b2252;">CumConns: 1</span>
<span style="color: #8b2252;">CumReq: 1</span>
<span style="color: #8b2252;">MaxSslConns: 0</span>
<span style="color: #8b2252;">CurrSslConns: 0</span>
<span style="color: #8b2252;">CumSslConns: 0</span>
<span style="color: #8b2252;">Maxpipes: 0</span>
<span style="color: #8b2252;">PipesUsed: 0</span>
<span style="color: #8b2252;">PipesFree: 0</span>
<span style="color: #8b2252;">ConnRate: 0</span>
<span style="color: #8b2252;">ConnRateLimit: 0</span>
<span style="color: #8b2252;">MaxConnRate: 0</span>
<span style="color: #8b2252;">SessRate: 0</span>
<span style="color: #8b2252;">SessRateLimit: 0</span>
<span style="color: #8b2252;">MaxSessRate: 0</span>
<span style="color: #8b2252;">SslRate: 0</span>
<span style="color: #8b2252;">SslRateLimit: 0</span>
<span style="color: #8b2252;">MaxSslRate: 0</span>
<span style="color: #8b2252;">SslFrontendKeyRate: 0</span>
<span style="color: #8b2252;">SslFrontendMaxKeyRate: 0</span>
<span style="color: #8b2252;">SslFrontendSessionReuse_pct: 0</span>
<span style="color: #8b2252;">SslBackendKeyRate: 0</span>
<span style="color: #8b2252;">SslBackendMaxKeyRate: 0</span>
<span style="color: #8b2252;">SslCacheLookups: 0</span>
<span style="color: #8b2252;">SslCacheMisses: 0</span>
<span style="color: #8b2252;">CompressBpsIn: 0</span>
<span style="color: #8b2252;">CompressBpsOut: 0</span>
<span style="color: #8b2252;">CompressBpsRateLim: 0</span>
<span style="color: #8b2252;">ZlibMemUsage: 0</span>
<span style="color: #8b2252;">MaxZlibMemUsage: 0</span>
<span style="color: #8b2252;">Tasks: 19</span>
<span style="color: #8b2252;">Run_queue: 1</span>
<span style="color: #8b2252;">Idle_pct: 100</span>
<span style="color: #8b2252;">node: centos7.cici.com</span>
<span style="color: #8b2252;">Stopping: 0</span>
<span style="color: #8b2252;">Jobs: 7</span>
<span style="color: #8b2252;">Unstoppable Jobs: 0</span>
<span style="color: #8b2252;">Listeners: 6</span>
<span style="color: #8b2252;">ActivePeers: 0</span>
<span style="color: #8b2252;">ConnectedPeers: 0</span>
<span style="color: #8b2252;">DroppedLogs: 0</span>
<span style="color: #8b2252;">BusyPolling: 0</span>
<span style="color: #8b2252;">FailedResolutions: 0</span>
<span style="color: #8b2252;">TotalBytesOut: 0</span>
<span style="color: #8b2252;">BytesOutRate: 0</span>
<span style="color: #8b2252;">DebugCommandsIssued: 0</span>
<span style="color: #8b2252;">[root@centos7 ~]#cat /etc/haproxy/haproxy.cfg</span>
<span style="color: #8b2252;">......</span>
<span style="color: #8b2252;">listen me-test-80</span>
<span style="color: #8b2252;">bind :81,:82</span>
<span style="color: #8b2252;">mode http</span>
<span style="color: #8b2252;">server web1 10.0.0.17:80 check inter 3000 fall 3 rise 5</span>
<span style="color: #8b2252;">server web2 10.0.0.27:80 check weight 3 </span>
<span style="color: #8b2252;">......</span>

<span style="color: #8b2252;">[root@centos7 ~]#echo "show servers state" | socat stdio /var/lib/haproxy/haproxy.sock</span>
<span style="color: #8b2252;">1</span>
<span style="color: #8b2252;"># be_id be_name srv_id srv_name srv_addr srv_op_state srv_admin_state</span>
<span style="color: #8b2252;">srv_uweight srv_iweight srv_time_since_last_change srv_check_status</span>
<span style="color: #8b2252;">srv_check_result srv_check_health srv_check_state srv_agent_state bk_f_forced_id</span>
<span style="color: #8b2252;">srv_f_forced_id srv_fqdn srv_port srvrecord</span>
<span style="color: #8b2252;">2 me-test-80 1 web1 10.0.0.17 2 0 2 1 812 6 3 7 6 0 0 0 - 80 -</span>
<span style="color: #8b2252;">2 me-test-80 2 web2 10.0.0.27 2 0 2 3 812 6 3 4 6 0 0 0 - 80 -</span>
<span style="color: #8b2252;">4 web_port 1 web1 127.0.0.1 0 0 1 1 810 8 2 0 6 0 0 0 - 8080 -</span>
<span style="color: #8b2252;">[root@centos7 ~]#echo "get weight me-test-80/web2" | socat stdio</span>
<span style="color: #8b2252;">/var/lib/haproxy/haproxy.sock</span>
<span style="color: #8b2252;">3 (initial 3)</span>

<span style="color: #8b2252;">#&#20462;&#25913;weight&#65292;&#27880;&#24847;&#21482;&#38024;&#23545;&#21333;&#36827;&#31243;&#26377;&#25928;</span>
<span style="color: #8b2252;">[root@centos7 ~]#echo "set weight me-test-80/web2 2" | socat stdio /var/lib/haproxy/haproxy.sock</span>
<span style="color: #8b2252;">[root@centos7 ~]#echo "get weight me-test-80/web2" | socat stdio /var/lib/haproxy/haproxy.sock</span>
<span style="color: #8b2252;">2 (initial 3)</span>

<span style="color: #8b2252;">#&#23558;&#21518;&#31471;&#26381;&#21153;&#22120;&#31105;&#29992;&#65292;&#27880;&#24847;&#21482;&#38024;&#23545;&#21333;&#36827;&#31243;&#26377;&#25928;</span>
<span style="color: #8b2252;">[root@centos7 ~]#echo "disable server me-test-80/web2" | socat stdio /var/lib/haproxy/haproxy.sock</span>
<span style="color: #8b2252;">#&#21551;&#29992;&#21518;&#31471;&#26381;&#21153;&#22120;</span>
<span style="color: #8b2252;">[root@centos7 ~]#echo "enable server me-test-80/web2" | socat stdio /var/lib/haproxy/haproxy.sock</span>
<span style="color: #8b2252;">#&#23558;&#21518;&#31471;&#26381;&#21153;&#22120;&#36719;&#19979;&#32447;&#65292;&#21363;weight&#35774;&#20026;0</span>
<span style="color: #8b2252;">[root@centos7 ~]#echo "set weight me-test-80/web1 0" | socat stdio /var/lib/haproxy/haproxy.sock</span>
<span style="color: #8b2252;">#&#38024;&#23545;haproxy&#30340;&#22810;&#36827;&#31243;,&#23558;&#21518;&#31471;&#26381;&#21153;&#22120;&#31105;&#29992;</span>
<span style="color: #8b2252;">[root@centos7 ~]#vim /etc/haproxy/haproxy.cfg</span>
<span style="color: #8b2252;">......</span>
<span style="color: #8b2252;">stats socket /var/lib/haproxy/haproxy1.sock mode 600 level admin process 1 #&#32465;&#23450;&#31532;1&#20010;&#36827;&#31243;&#21644;socket&#25991;&#20214;</span>
<span style="color: #8b2252;">stats socket /var/lib/haproxy/haproxy2.sock mode 600 level admin process 2 #&#32465;&#23450;&#31532;2&#20010;&#36827;&#31243;&#21644;socket&#25991;&#20214;</span>
<span style="color: #8b2252;">nbproc 2</span>
<span style="color: #8b2252;">.....</span>
<span style="color: #8b2252;">[root@centos7 ~]#echo "disable server me-test-80/web2" | socat stdio /var/lib/haproxy/haproxy1.sock</span>
<span style="color: #8b2252;">[root@centos7 ~]#echo "disable server me-test-80/web2" | socat stdio /var/lib/haproxy/haproxy2.sock</span>
<span style="color: #8b2252;">[root@haproxy ~]#for i in {1..2};do echo "set weight me-test-80/web$i 10" | socat stdio /var/lib/haproxy/haproxy$i.sock;done</span>
<span style="color: #8b2252;">#&#22914;&#26524;&#38745;&#24577;&#31639;&#27861;&#65292;&#22914;:static-rr&#65292;&#21487;&#20197;&#26356;&#25913;weight&#20026;0&#25110;1&#65292;&#20294;&#19981;&#25903;&#25345;&#21160;&#24577;&#26356;&#25913;weight&#20026;&#20854;&#23427;&#20540;&#65292;&#21542;&#21017;&#20250;&#25552;&#31034;&#19979;&#38754;&#20449;&#24687;</span>
<span style="color: #8b2252;">[root@centos7 ~]#echo "set weight me-test-80/web1 0" | socat stdio /var/lib/haproxy/haproxy.sock</span>
<span style="color: #8b2252;">[root@centos7 ~]#echo "set weight me-test-80/web1 1" | socat stdio /var/lib/haproxy/haproxy.sock</span>
<span style="color: #8b2252;">[root@centos7 ~]#echo "set weight me-test-80/web1 2" | socat stdio /var/lib/haproxy/haproxy.sock</span>
<span style="color: #8b2252;">Backend is using a static LB algorithm and only accepts weights '</span>0%<span style="color: #8b2252;">' and '</span>100%<span style="color: #8b2252;">'.</span>
</pre>
</div>

<p>
范例: 上线和下线后端服务器脚本
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#cat haproyx_host_up_down.sh
<span style="color: #483d8b;">.</span> /etc/init.d/functions
<span style="color: #a020f0;">case</span> $<span style="color: #a0522d;">1</span><span style="color: #a020f0;"> in</span>
up)
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"set weight me-m42-web-80/$2 1"</span> | socat stdio /var/lib/haproxy/haproxy.sock
    [ $<span style="color: #a0522d;">?</span> -eq 0 ] &amp;&amp; action <span style="color: #8b2252;">"$2 is up"</span>
    ;;
down)
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"set weight me-m42-web-80/$2 0"</span> | socat stdio /var/lib/haproxy/haproxy.sock
    [ $<span style="color: #a0522d;">?</span> -eq 0 ] &amp;&amp; action <span style="color: #8b2252;">"$2 is down"</span>
    ;;
*)
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"Usage: `basename $0` up|down IP"</span>
    ;;
<span style="color: #a020f0;">esac</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:20c87e47-49ba-48dc-b013-db82bded6109" class="outline-3">
<h3 id="h:20c87e47-49ba-48dc-b013-db82bded6109">4.1.2 static-rr</h3>
<div class="outline-text-3" id="text-h:20c87e47-49ba-48dc-b013-db82bded6109">
<p>
static-rr：基于权重的轮询调度，不支持运行时利用socat进行权重的动态调整
(只支持0和1,不支持其它值)及后端服务器慢启动，其后端主机数量没有限制，
相当于LVS中的wrr
</p>

<div class="org-src-container">
<pre class="src src-sh">listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010
mode http
log global
balance static-rr
server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5
server web2 10.0.0.27:80 weight 2 check inter 3000 fall 2 rise 5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:756a9443-61df-415a-b1a8-d455206a43a0" class="outline-3">
<h3 id="h:756a9443-61df-415a-b1a8-d455206a43a0">4.1.3 first</h3>
<div class="outline-text-3" id="text-h:756a9443-61df-415a-b1a8-d455206a43a0">
<p>
first：根据服务器在列表中的位置，自上而下进行调度，但是其只会当第一台
服务器的连接数达到上限，新请求才会分配给下一台服务，因此会忽略服务器的
权重设置，此方式使用较少
</p>

<p>
不支持用socat进行动态修改权重,可以设置0和1,可以设置其它值但无效
</p>

<div class="org-src-container">
<pre class="src src-sh">listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010
mode http
log global
balance first
server web1 10.0.0.17:80 maxconn 2 weight 1 check inter 3000 fall 2 rise 5
server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5
</pre>
</div>

<p>
测试访问效果
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#26102;&#36816;&#34892;&#19979;&#38754;&#21629;&#20196;&#65292;&#35266;&#23519;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">while true;do curl http://10.0.0.7/index.html ; sleep 0.1;done</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ff65344c-4b61-4c57-8838-b291f43a20b0" class="outline-3">
<h3 id="h:ff65344c-4b61-4c57-8838-b291f43a20b0">4.2 动态算法</h3>
<div class="outline-text-3" id="text-h:ff65344c-4b61-4c57-8838-b291f43a20b0">
<p>
动态算法：基于后端服务器状态进行调度适当调整，优先调度至当前负载较低的服务器，且权重可以在haproxy运行时动态调整无需重启。
</p>
</div>
<div id="outline-container-h:49e3c5a8-93a2-407c-9c60-63b3cd64b52c" class="outline-4">
<h4 id="h:49e3c5a8-93a2-407c-9c60-63b3cd64b52c">4.2.1 roundrobin</h4>
<div class="outline-text-4" id="text-h:49e3c5a8-93a2-407c-9c60-63b3cd64b52c">
<p>
roundrobin：基于权重的轮询动态调度算法，支持权重的运行时调整，不同于lvs中的rr轮训模式，
HAProxy中的roundrobin支持慢启动(新加的服务器会逐渐增加转发数)，其每个后端backend中最多支持4095个real
server，支持对real server权重动态调整，roundrobin为默认调度算法,此算法使用广泛
</p>

<div class="org-src-container">
<pre class="src src-sh">listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010
mode http
log global
balance roundrobin
server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5
server web2 10.0.0.27:80 weight 2 check inter 3000 fall 2 rise 5
</pre>
</div>

<p>
<b>支持动态调整权重：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">echo "get weight web_host/web1" | socat stdio /var/lib/haproxy/haproxy.sock</span>
<span style="color: #0000ff;">1</span> (initial 1)
<span style="color: #b22222;"># </span><span style="color: #b22222;">echo "set weight web_host/web1 3" | socat stdio /var/lib/haproxy/haproxy.sock</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">echo "get weight web_host/web1" | socat stdio /var/lib/haproxy/haproxy.sock</span>
<span style="color: #0000ff;">3</span> (initial 1)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:762b8361-bf6e-493d-947a-834141d254d6" class="outline-4">
<h4 id="h:762b8361-bf6e-493d-947a-834141d254d6">4.2.2 leastconn</h4>
<div class="outline-text-4" id="text-h:762b8361-bf6e-493d-947a-834141d254d6">
<p>
leastconn加权的最少连接的动态，支持权重的运行时调整和慢启动，即:根据当
前连接最少的后端服务器而非权重进行优先调度(新客户端连接)，比较适合长连
接的场景使用，比如：MySQL等场景。
</p>

<div class="org-src-container">
<pre class="src src-sh">listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010
mode http
log global
balance leastconn
server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5
server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5273a6f8-a876-4bb5-84ec-f6be43fac379" class="outline-4">
<h4 id="h:5273a6f8-a876-4bb5-84ec-f6be43fac379">4.2.3 random</h4>
<div class="outline-text-4" id="text-h:5273a6f8-a876-4bb5-84ec-f6be43fac379">
<p>
在1.9版本开始增加random的负载平衡算法，其基于随机数作为一致性hash的key，
随机负载平衡对于大型服务器场或经常添加或删除服务器非常有用，支持weight
的动态调整，weight较大的主机有更大概率获取新请求
</p>

<p>
random配置实例
</p>

<div class="org-src-container">
<pre class="src src-sh">listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010
mode http
log global
balance random
server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5
server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:1d4d6dd3-abbf-442e-b8bc-be43aa395cff" class="outline-3">
<h3 id="h:1d4d6dd3-abbf-442e-b8bc-be43aa395cff">4.3 其他算法</h3>
<div class="outline-text-3" id="text-h:1d4d6dd3-abbf-442e-b8bc-be43aa395cff">
<p>
其它算法即可作为静态算法，又可以通过选项成为动态算法
</p>
</div>
<div id="outline-container-h:95edb29f-0536-4650-b147-168a9c6c83e7" class="outline-4">
<h4 id="h:95edb29f-0536-4650-b147-168a9c6c83e7">4.3.1 source</h4>
<div class="outline-text-4" id="text-h:95edb29f-0536-4650-b147-168a9c6c83e7">
<p>
源地址hash，基于用户源地址hash并将请求转发到后端服务器，后续同一个源地
址请求将被转发至同一个后端web服务器。此方式当后端服务器数据量发生变化
时，会导致很多用户的请求转发至新的后端服务器，默认为静态方式，但是可以
通过hash-type支持的选项更改
</p>

<p>
这个算法一般是在不插入Cookie的TCP模式下使用，也可给拒绝会话cookie的客
户提供最好的会话粘性，适用于session会话保持但不支持cookie和缓存的场景
</p>

<p>
源地址有两种转发客户端请求到后端服务器的服务器选取计算方式，分别是取模法和一致性hash
</p>
</div>
<div id="outline-container-h:8855e0c7-63a1-4c89-b778-35c43d352e0d" class="outline-5">
<h5 id="h:8855e0c7-63a1-4c89-b778-35c43d352e0d">4.3.1.1 map-base 取模法</h5>
<div class="outline-text-5" id="text-h:8855e0c7-63a1-4c89-b778-35c43d352e0d">
<p>
map-based：取模法，对source地址进行hash计算，再基于服务器总权重的取模，
最终结果决定将此请求转发至对应的后端服务器。此方法是静态的，即不支持在
线调整权重，不支持慢启动，可实现对后端服务器均衡调度。缺点是当服务器的
总权重发生变化时，即有服务器上线或下线，都会因总权重发生变化而导致调度
结果整体改变，hash-type指定的默认值为此算法
</p>

<div class="org-src-container">
<pre class="src src-sh">&#25152;&#35859;&#21462;&#27169;&#36816;&#31639;&#65292;&#23601;&#26159;&#35745;&#31639;&#20004;&#20010;&#25968;&#30456;&#38500;&#20043;&#21518;&#30340;&#20313;&#25968;&#65292;10%<span style="color: #a0522d;">7</span>=3, 7%<span style="color: #a0522d;">4</span>=3
map-based&#31639;&#27861;&#65306;&#22522;&#20110;&#26435;&#37325;&#21462;&#27169;&#65292;hash(source_ip)%&#25152;&#26377;&#21518;&#31471;&#26381;&#21153;&#22120;&#30456;&#21152;&#30340;&#24635;&#26435;&#37325;
</pre>
</div>

<p>
取模法配置示例：
</p>

<div class="org-src-container">
<pre class="src src-sh">listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010
mode tcp
log global
balance source
hash-type map-based
server web1     10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 3
server web2     10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 3

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#25903;&#25345;&#21160;&#24577;&#35843;&#25972;&#26435;&#37325;&#20540;</span>
[root@haproxy ~]#echo <span style="color: #8b2252;">"set weight web_host/10.0.0.27 10"</span> | socat stdio /var/lib/haproxy/haproxy.sock
Backend is using a static LB algorithm and only accepts weights <span style="color: #8b2252;">'0%'</span> and <span style="color: #8b2252;">'100%'</span>.
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#33021;&#21160;&#24577;&#19978;&#32447;&#21644;&#19979;&#32447;</span>
[root@haproxy ~]#echo <span style="color: #8b2252;">"set weight web_host/10.0.0.27 0"</span> | socat stdio /var/lib/haproxy/haproxy.sock
[root@haproxy conf.d]#echo <span style="color: #8b2252;">"get weight web_host/10.0.0.27"</span> | socat stdio /var/lib/haproxy/haproxy.sock
<span style="color: #0000ff;">0</span> (initial 1)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a4740d2a-609f-4221-a1a1-831c3ba20c9c" class="outline-5">
<h5 id="h:a4740d2a-609f-4221-a1a1-831c3ba20c9c">4.3.1.2 一致性hash</h5>
<div class="outline-text-5" id="text-h:a4740d2a-609f-4221-a1a1-831c3ba20c9c">
<p>
一致性哈希，当服务器的总权重发生变化时，对调度结果影响是局部的，不会引
起大的变动，hash（o）mod n ，该hash算法是动态的，支持使用socat等工具进
行在线权重调整，支持慢启动
</p>

<p>
算法：
</p>

<div class="org-src-container">
<pre class="src src-sh">1&#12289;<span style="color: #a0522d;">key1</span>=hash(source_ip)%(2^32) [0---4294967295]
2&#12289;<span style="color: #a0522d;">keyA</span>=hash(&#21518;&#31471;&#26381;&#21153;&#22120;&#34394;&#25311;ip)%(2^32)
3&#12289;&#23558;key1&#21644;keyA&#37117;&#25918;&#22312;hash&#29615;&#19978;&#65292;&#23558;&#29992;&#25143;&#35831;&#27714;&#35843;&#24230;&#21040;&#31163;key1&#26368;&#36817;&#30340;keyA&#23545;&#24212;&#30340;&#21518;&#31471;&#26381;&#21153;&#22120;
</pre>
</div>

<p>
hash环偏斜问题
</p>

<div class="org-src-container">
<pre class="src src-sh">&#22686;&#21152;&#34394;&#25311;&#26381;&#21153;&#22120;IP&#25968;&#37327;&#65292;&#27604;&#22914;&#65306;&#19968;&#20010;&#21518;&#31471;&#26381;&#21153;&#22120;&#26681;&#25454;&#26435;&#37325;&#20026;1&#29983;&#25104;1000&#20010;&#34394;&#25311;IP&#65292;&#20877;hash&#12290;&#32780;&#21518;&#31471;&#26381;&#21153;&#22120;&#26435;
&#37325;&#20026;2&#21017;&#29983;&#25104;2000&#30340;&#34394;&#25311;IP&#65292;&#20877;bash,&#26368;&#32456;&#22312;hash&#29615;&#19978;&#29983;&#25104;3000&#20010;&#33410;&#28857;&#65292;&#20174;&#32780;&#35299;&#20915;hash&#29615;&#20559;&#26012;&#38382;&#39064;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9eea5d5b-b29b-42a4-b05f-12c95e4072f2" class="outline-5">
<h5 id="h:9eea5d5b-b29b-42a4-b05f-12c95e4072f2">4.3.1.2.1 hash对象</h5>
<div class="outline-text-5" id="text-h:9eea5d5b-b29b-42a4-b05f-12c95e4072f2">
<p>
Hash对象到后端服务器的映射关系：
</p>


<figure id="orge31be91">
<img src="images/image-20210225162400266.png" alt="image-20210225162400266.png">

</figure>
</div>
</div>
<div id="outline-container-h:e856ea54-d9a9-4971-b372-1d9d7d068ed6" class="outline-5">
<h5 id="h:e856ea54-d9a9-4971-b372-1d9d7d068ed6">4.3.1.2.2 一致性hash示意图</h5>
<div class="outline-text-5" id="text-h:e856ea54-d9a9-4971-b372-1d9d7d068ed6">
<p>
后端服务器在线与离线的调度方式
</p>


<figure id="org7ed89e2">
<img src="images/image-20210225162417276.png" alt="image-20210225162417276.png">

</figure>
</div>
</div>
<div id="outline-container-h:ef29cf34-d26c-40ec-83da-ea4d0d179a94" class="outline-5">
<h5 id="h:ef29cf34-d26c-40ec-83da-ea4d0d179a94">4.3.1.2.3 一致性hash配置示例</h5>
<div class="outline-text-5" id="text-h:ef29cf34-d26c-40ec-83da-ea4d0d179a94">
<div class="org-src-container">
<pre class="src src-sh">listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010
mode tcp
log global
balance source
hash-type consistent
server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5
server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:3d6bbc2d-230e-4b9e-8530-f7484aab5dbb" class="outline-4">
<h4 id="h:3d6bbc2d-230e-4b9e-8530-f7484aab5dbb">4.3.2 uri</h4>
<div class="outline-text-4" id="text-h:3d6bbc2d-230e-4b9e-8530-f7484aab5dbb">
<p>
基于对用户请求的URI的左半部分或整个uri做hash，再将hash结果对总权重进行
取模后，根据最终结果将请求转发到后端指定服务器，适用于后端是缓存服务器
场景，默认是静态算法，也可以通过hash-type指定map-based和consistent，来
定义使用取模法还是一致性hash。
</p>

<p>
<b>注意：此算法基于应用层，所以只支持 mode http ，不支持 mode tcp</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;<span style="color: #b22222;">#</span><span style="color: #b22222;">&lt;frag&gt;</span>
&#24038;&#21322;&#37096;&#20998;&#65306;/&lt;path&gt;;&lt;params&gt;
&#25972;&#20010;uri&#65306;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;<span style="color: #b22222;">#</span><span style="color: #b22222;">&lt;frag&gt;</span>
</pre>
</div>


<figure id="org1ae306a">
<img src="images/image-20210225162440506.png" alt="image-20210225162440506.png">

</figure>
</div>
<div id="outline-container-h:8f8affe5-19c4-4cd8-a56a-d8b169b8a94c" class="outline-5">
<h5 id="h:8f8affe5-19c4-4cd8-a56a-d8b169b8a94c">4.3.2.1 uri 取模法配置示例</h5>
<div class="outline-text-5" id="text-h:8f8affe5-19c4-4cd8-a56a-d8b169b8a94c">
<div class="org-src-container">
<pre class="src src-sh">listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010
mode http
log global
balance uri
server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5
server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0d7289a7-2e61-45a4-aba4-0968e4d84fec" class="outline-5">
<h5 id="h:0d7289a7-2e61-45a4-aba4-0968e4d84fec">4.3.2.2 uri 一致性hash配置示例</h5>
<div class="outline-text-5" id="text-h:0d7289a7-2e61-45a4-aba4-0968e4d84fec">
<div class="org-src-container">
<pre class="src src-sh">listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010
mode http
log global
balance uri
hash-type consistent
server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5
server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6629850b-b88f-40d3-aed9-c769d15856f0" class="outline-5">
<h5 id="h:6629850b-b88f-40d3-aed9-c769d15856f0">4.3.2.3 访问测试</h5>
<div class="outline-text-5" id="text-h:6629850b-b88f-40d3-aed9-c769d15856f0">
<p>
访问不同的uri，确认可以将用户同样的请求转发至相同的服务器
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">curl http://10.0.0.7/test1.html</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">curl http://10.0.0.7/test2..html</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ef50b45b-66b6-40b2-b923-b73d62a0a5f7" class="outline-4">
<h4 id="h:ef50b45b-66b6-40b2-b923-b73d62a0a5f7">4.3.3 url_param</h4>
<div class="outline-text-4" id="text-h:ef50b45b-66b6-40b2-b923-b73d62a0a5f7">
<p>
url_param对用户请求的url中的 params部分中的一个参数key对应的value值作
hash计算，并由服务器总权重相除以后派发至某挑出的服务器；通常用于追踪用
户，以确保来自同一个用户的请求始终发往同一个real server，如果无没key，
将按roundrobin算法
</p>

<div class="org-src-container">
<pre class="src src-sh">&#20551;&#35774;&#65306;
url = http://www.me.com/foo/bar/index.php?<span style="color: #a0522d;">key</span>=value

&#21017;&#65306;
host = <span style="color: #8b2252;">"www.me.com"</span>
url_param = <span style="color: #8b2252;">"key=value"</span>
</pre>
</div>
</div>
<div id="outline-container-h:4d439ef4-d734-4706-bccf-1030f78d9820" class="outline-5">
<h5 id="h:4d439ef4-d734-4706-bccf-1030f78d9820">4.3.3.1 url_param取模法配置示例</h5>
<div class="outline-text-5" id="text-h:4d439ef4-d734-4706-bccf-1030f78d9820">
<div class="org-src-container">
<pre class="src src-sh">listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010
mode http
log global
balance url_param userid <span style="color: #b22222;">#</span><span style="color: #b22222;">url_param hash</span>
server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5
server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:86b2e653-52b1-4391-8d58-1de20c6fc292" class="outline-5">
<h5 id="h:86b2e653-52b1-4391-8d58-1de20c6fc292">4.3.3.2 url_param一致性hash配置示例</h5>
<div class="outline-text-5" id="text-h:86b2e653-52b1-4391-8d58-1de20c6fc292">
<div class="org-src-container">
<pre class="src src-sh">listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010
mode http
log global
balance url_param userid keyword <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;url_param&#30340;&#20540;&#21462;hash</span>
hash-type consistent
server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5
server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0bdefb2d-c6c8-4c8a-9860-be77966a0e53" class="outline-5">
<h5 id="h:0bdefb2d-c6c8-4c8a-9860-be77966a0e53">4.3.3.3 测试访问</h5>
<div class="outline-text-5" id="text-h:0bdefb2d-c6c8-4c8a-9860-be77966a0e53">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">curl http://10.0.0.7/index.html?userid=&lt;NAME_ID&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">curl "http://10.0.0.7/index.html?userid=&lt;NAME_ID&gt;&amp;typeid=&lt;TYPE_ID&gt;"</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:c51f886d-050c-48b1-bf4f-2ccfb075a2bf" class="outline-4">
<h4 id="h:c51f886d-050c-48b1-bf4f-2ccfb075a2bf">4.3.4 hdr</h4>
<div class="outline-text-4" id="text-h:c51f886d-050c-48b1-bf4f-2ccfb075a2bf">
<p>
针对用户每个http头部(header)请求中的指定信息做hash，此处由 name指定的
http首部将会被取出并做hash计算，然后由服务器总权重取模以后派发至某挑出
的服务器，如果无有效值，则会使用默认的轮询调度。
</p>
</div>
<div id="outline-container-h:6954e430-fb0b-47cc-8226-885a12430c8e" class="outline-5">
<h5 id="h:6954e430-fb0b-47cc-8226-885a12430c8e">4.3.4.1 hdr取模法配置示例</h5>
<div class="outline-text-5" id="text-h:6954e430-fb0b-47cc-8226-885a12430c8e">
<div class="org-src-container">
<pre class="src src-sh">listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010
mode http
log global
balance hdr(User-Agent)
<span style="color: #b22222;">#</span><span style="color: #b22222;">balance hdr(host)</span>
server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5
server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0ae01129-8d47-4222-87d9-9519b652c4d4" class="outline-5">
<h5 id="h:0ae01129-8d47-4222-87d9-9519b652c4d4">4.3.4.2 一致性hash配置示例</h5>
<div class="outline-text-5" id="text-h:0ae01129-8d47-4222-87d9-9519b652c4d4">
<div class="org-src-container">
<pre class="src src-sh">listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80,:8801-8810,10.0.0.7:9001-9010
mode http
log global
balance hdr(User-Agent)
hash-type consistent
server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5
server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ebca1d83-44be-4eb4-afb8-967050e10063" class="outline-5">
<h5 id="h:ebca1d83-44be-4eb4-afb8-967050e10063">4.3.4.3 测试访问</h5>
<div class="outline-text-5" id="text-h:ebca1d83-44be-4eb4-afb8-967050e10063">
<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#curl -v http://10.0.0.7/index.html
[root@centos6 ~]#curl -vA <span style="color: #8b2252;">'firefox'</span> http://10.0.0.7/index.html
[root@centos6 ~]#curl -vA <span style="color: #8b2252;">'chrome'</span> http://10.0.0.7/index.html
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:624e5fa0-94c3-44b1-a55f-0382b78ce077" class="outline-4">
<h4 id="h:624e5fa0-94c3-44b1-a55f-0382b78ce077">4.3.5 rdp-cookie</h4>
<div class="outline-text-4" id="text-h:624e5fa0-94c3-44b1-a55f-0382b78ce077">
<p>
rdp-cookie对远windows远程桌面的负载，使用cookie保持会话，默认是静态，也可以通过hash-type指定map-based和consistent，来定义使用取模法还是一致性hash。
</p>
</div>
<div id="outline-container-h:5f9cd6b4-b8c9-402e-bb75-80f174725006" class="outline-5">
<h5 id="h:5f9cd6b4-b8c9-402e-bb75-80f174725006">4.3.5.1 rdp-cookie 取模法配置示例</h5>
<div class="outline-text-5" id="text-h:5f9cd6b4-b8c9-402e-bb75-80f174725006">
<div class="org-src-container">
<pre class="src src-sh">listen RDP
<span style="color: #483d8b;">bind</span> 10.0.0.7:3389
balance rdp-cookie
mode tcp
server rdp0 10.0.0.17:3389 check fall 3 rise 5 inter 2000 weight 1
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e3dced8b-d2be-4965-8c94-7276bdced304" class="outline-5">
<h5 id="h:e3dced8b-d2be-4965-8c94-7276bdced304">4.3.5.2 rdp-cookie 一致性hash配置示例</h5>
<div class="outline-text-5" id="text-h:e3dced8b-d2be-4965-8c94-7276bdced304">
<div class="org-src-container">
<pre class="src src-sh">[root@haproxy ~]#cat /etc/haproxy/conf.d/windows_rdp.cfg
listen me_RDP_3389
<span style="color: #483d8b;">bind</span>     172.16.0.100:3389
balance rdp-cookie
hash-type consistent
mode tcp
server rdp0 10.0.0.200:3389 check fall 3 rise 5 inter 2000 weight 1
[root@haproxy ~]#hostname -I
10.0.0.7 172.16.0.100
</pre>
</div>


<figure id="org2d99a96">
<img src="images/image-20210225162534650.png" alt="image-20210225162534650.png">

</figure>


<figure id="orgcc96eaf">
<img src="images/image-20210225162552723.png" alt="image-20210225162552723.png">

</figure>
</div>
</div>
<div id="outline-container-h:d6c2bdfe-582f-4754-a7e2-ff356e406882" class="outline-5">
<h5 id="h:d6c2bdfe-582f-4754-a7e2-ff356e406882">4.3.5.3 基于iptables实现RDP协议转发</h5>
<div class="outline-text-5" id="text-h:d6c2bdfe-582f-4754-a7e2-ff356e406882">
<p>
必须开启ip转发功能： net.ipv4.ip_forward = 1
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#sysctl -w net.ipv4.ip_forward=1
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#21644;Windows&#22312;&#19981;&#21516;&#32593;&#27573;&#38656;&#35201;&#19979;&#38754;&#21629;&#20196;,&#27880;&#24847;&#21518;&#31471;&#26381;&#21153;&#22120;&#38656;&#35201;&#23558;iptables&#20027;&#26426;&#37197;&#32622;&#20026;&#32593;&#20851;</span>
[root@centos8 ~]#iptables -t nat -A PREROUTING -d 172.16.0.100 -p tcp --dport 3389 -j DNAT --to-destination 10.0.0.200:3389

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#21644;Windows&#22312;&#21516;&#19968;&#32593;&#27573;&#38656;&#35201;&#20877;&#25191;&#34892;&#19979;&#38754;&#21629;&#20196;</span>
[root@centos8 ~]#iptables -t nat -A PREROUTING -d 10.0.0.8 -p tcp --dport 3389 -j DNAT --to-destination 10.0.0.1:3389
[root@centos8 ~]#iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -j SNAT --to-
<span style="color: #483d8b;">source</span> 10.0.0.8
</pre>
</div>

<p>
在windows 可以看到以下信息
</p>


<figure id="org7fa9281">
<img src="images/image-20210225162610444.png" alt="image-20210225162610444.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:40d31e4c-76b4-4003-8c44-8ed0492f175d" class="outline-4">
<h4 id="h:40d31e4c-76b4-4003-8c44-8ed0492f175d">4.3.6 算法总结</h4>
<div class="outline-text-4" id="text-h:40d31e4c-76b4-4003-8c44-8ed0492f175d">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#38745;&#24577;</span>
static-rr---------&gt;tcp/http 
first-------------&gt;tcp/http 
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21160;&#24577;</span>
roundrobin--------&gt;tcp/http
leastconn---------&gt;tcp/http
random------------&gt;tcp/http
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#19979;&#38745;&#24577;&#21644;&#21160;&#24577;&#21462;&#20915;&#20110;hash_type&#26159;&#21542;consistent</span>
source------------&gt;tcp/http
Uri---------------&gt;http
url_param---------&gt;http     
hdr---------------&gt;http
rdp-cookie--------&gt;tcp
</pre>
</div>
</div>
</div>
<div id="outline-container-h:40f5f8c5-e452-49ae-8e50-ab1a8cb95f78" class="outline-4">
<h4 id="h:40f5f8c5-e452-49ae-8e50-ab1a8cb95f78">4.3.7 各算法使用场景</h4>
<div class="outline-text-4" id="text-h:40f5f8c5-e452-49ae-8e50-ab1a8cb95f78">
<div class="org-src-container">
<pre class="src src-sh">first <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#36739;&#23569;</span>
static-rr <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20570;&#20102;session&#20849;&#20139;&#30340;web&#38598;&#32676;</span>
roundrobin
random
leastconn <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;</span>
<span style="color: #483d8b;">source</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110;&#23458;&#25143;&#31471;&#20844;&#32593;IP&#30340;&#20250;&#35805;&#20445;&#25345;</span>
Uri---------------&gt;http     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32531;&#23384;&#26381;&#21153;&#22120;&#65292;CDN&#26381;&#21153;&#21830;&#65292;&#34013;&#27739;&#12289;&#30334;&#24230;&#12289;&#38463;&#37324;&#20113;&#12289;&#33150;&#35759;</span>
url_param---------&gt;http     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#23454;&#29616;session&#20445;&#25345;</span>
hdr <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110;&#23458;&#25143;&#31471;&#35831;&#27714;&#25253;&#25991;&#22836;&#37096;&#20570;&#19979;&#19968;&#27493;&#22788;&#29702;</span>
rdp-cookie <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110;Windows&#20027;&#26426;,&#24456;&#23569;&#20351;&#29992;</span>
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:e3ff1566-a9d9-4a82-8e2d-0ad2ce838ffb" class="outline-2">
<h2 id="h:e3ff1566-a9d9-4a82-8e2d-0ad2ce838ffb">5 高级功能及配置</h2>
<div class="outline-text-2" id="text-h:e3ff1566-a9d9-4a82-8e2d-0ad2ce838ffb">
<p>
介绍HAProxy高级配置及实用案例
</p>
</div>
<div id="outline-container-h:7b5af18b-d6f6-4e54-aaf2-07592bd7c17b" class="outline-3">
<h3 id="h:7b5af18b-d6f6-4e54-aaf2-07592bd7c17b">5.1 基于cookie的会话保持</h3>
<div class="outline-text-3" id="text-h:7b5af18b-d6f6-4e54-aaf2-07592bd7c17b">
<p>
cookie value：为当前server指定cookie值，实现基于cookie的会话黏性，相对
于基于source 地址hash调度算法对客户端的粒度更精准，但同时也加大了
haproxy负载，目前此模式使用较少，已经被session共享服务器代替
</p>

<p>
注意：不支持 tcp mode，使用 http mode
</p>
</div>
<div id="outline-container-h:2ed6f23b-0202-40ff-85d7-039cd2900bc4" class="outline-4">
<h4 id="h:2ed6f23b-0202-40ff-85d7-039cd2900bc4">5.1.1 配置选项</h4>
<div class="outline-text-4" id="text-h:2ed6f23b-0202-40ff-85d7-039cd2900bc4">
<div class="org-src-container">
<pre class="src src-sh">cookie name [ rewrite | insert | prefix ][ indirect ] [ nocache ][ postonly ] [
preserve ][ httponly ] [ secure ][ domain ]* [ maxidle &lt;idle&gt; ][ maxlife ]
name&#65306; <span style="color: #b22222;">#</span><span style="color: #b22222;">cookie &#30340; key&#21517;&#31216;&#65292;&#29992;&#20110;&#23454;&#29616;&#25345;&#20037;&#36830;&#25509;</span>
insert&#65306; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25554;&#20837;&#26032;&#30340;cookie,&#40664;&#35748;&#19981;&#25554;&#20837;cookie</span>
indirect&#65306; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#23458;&#25143;&#31471;&#24050;&#32463;&#26377;cookie,&#21017;&#19981;&#20250;&#20877;&#21457;&#36865;cookie&#20449;&#24687;</span>
nocache&#65306; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;client&#21644;hapoxy&#20043;&#38388;&#26377;&#32531;&#23384;&#26381;&#21153;&#22120;&#65288;&#22914;&#65306;CDN&#65289;&#26102;&#65292;&#19981;&#20801;&#35768;&#20013;&#38388;&#32531;&#23384;&#22120;&#32531;&#23384;cookie&#65292;&#22240;&#20026;&#36825;&#20250;&#23548;&#33268;&#24456;&#22810;&#32463;&#36807;&#21516;&#19968;&#20010;CDN&#30340;&#35831;&#27714;&#37117;&#21457;&#36865;&#21040;&#21516;&#19968;&#21488;&#21518;&#31471;&#26381;&#21153;&#22120;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ae19bb52-4eb5-440e-b5f4-2cca8c89a992" class="outline-4">
<h4 id="h:ae19bb52-4eb5-440e-b5f4-2cca8c89a992">5.1.2 配置示例</h4>
<div class="outline-text-4" id="text-h:ae19bb52-4eb5-440e-b5f4-2cca8c89a992">
<div class="org-src-container">
<pre class="src src-sh">listen web_port
<span style="color: #483d8b;">bind</span> 10.0.0.7:80
balance roundrobin
mode http <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#25903;&#25345; tcp mode</span>
log global
cookie WEBSRV insert nocache indirect
server web1     10.0.0.17:80 check inter 3000 fall 2 rise 5 cookie web1
server web2     10.0.0.27:80 check inter 3000 fall 2 rise 5 cookie web2
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7384d00b-c92f-4ec5-999f-b3181778001c" class="outline-4">
<h4 id="h:7384d00b-c92f-4ec5-999f-b3181778001c">5.1.3 验证cookie信息</h4>
<div class="outline-text-4" id="text-h:7384d00b-c92f-4ec5-999f-b3181778001c">
<p>
浏览器验证：
</p>


<figure id="org77ca43e">
<img src="images/image-20210225162651491.png" alt="image-20210225162651491.png">

</figure>


<figure id="orga2ad849">
<img src="images/image-20210225162702359.png" alt="image-20210225162702359.png">

</figure>

<p>
通过命令行验证：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#curl -i 10.0.0.7
HTTP/1.1 200 OK
date: Thu, 02 Apr 2020 02:26:08 GMT
server: Apache/2.4.6 (CentOS)
last-modified: Thu, 02 Apr 2020 01:44:28 GMT
etag: <span style="color: #8b2252;">"a-5a244f0fd5175"</span>
accept-ranges: bytes
content-length: 10
content-type: text/html; <span style="color: #a0522d;">charset</span>=UTF-8
set-cookie: <span style="color: #a0522d;">WEBSRV</span>=web2; <span style="color: #a0522d;">path</span>=/
cache-control: private
10.0.0.27

[root@centos6 ~]#curl -i 10.0.0.7
HTTP/1.1 200 OK
date: Thu, 02 Apr 2020 02:26:15 GMT
server: Apache/2.4.6 (CentOS)
last-modified: Thu, 02 Apr 2020 01:44:13 GMT
etag: <span style="color: #8b2252;">"a-5a244f01f8adc"</span>
accept-ranges: bytes
content-length: 10
content-type: text/html; <span style="color: #a0522d;">charset</span>=UTF-8
set-cookie: <span style="color: #a0522d;">WEBSRV</span>=web1; <span style="color: #a0522d;">path</span>=/
cache-control: private
10.0.0.17
[root@centos6 ~]#curl -b <span style="color: #a0522d;">WEBSRV</span>=web1 10.0.0.7
10.0.0.17
[root@centos6 ~]#curl -b <span style="color: #a0522d;">WEBSRV</span>=web2 10.0.0.7
10.0.0.27
[root@centos6 ~]#curl -vb <span style="color: #a0522d;">WEBSRV</span>=web1 10.0.0.7
* About to connect() to 10.0.0.7 port 80 (<span style="color: #b22222;">#</span><span style="color: #b22222;">0)</span>
*     Trying 10.0.0.7... connected
* Connected to 10.0.0.7 (10.0.0.7) port 80 (<span style="color: #b22222;">#</span><span style="color: #b22222;">0)</span>
&gt; GET / HTTP/1.1
&gt; User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1
zlib/1.2.3 libidn/1.18 libssh2/1.4.2
&gt; Host: 10.0.0.7
&gt; Accept: */*
&gt; Cookie: <span style="color: #a0522d;">WEBSRV</span>=web1
&gt;
&lt; HTTP/1.1 200 OK
&lt; date: Thu, 02 Apr 2020 02:27:54 GMT
&lt; server: Apache/2.4.6 (CentOS)
&lt; last-modified: Thu, 02 Apr 2020 01:44:13 GMT
&lt; etag: <span style="color: #8b2252;">"a-5a244f01f8adc"</span>
&lt; accept-ranges: bytes
&lt; content-length: 10
&lt; content-type: text/html; <span style="color: #a0522d;">charset</span>=UTF-8
&lt;
10.0.0.17
* Connection <span style="color: #b22222;">#</span><span style="color: #b22222;">0 to host 10.0.0.7 left intact</span>
* Closing connection <span style="color: #b22222;">#</span><span style="color: #b22222;">0</span>
[root@centos6 ~]#curl -vb <span style="color: #a0522d;">WEBSRV</span>=web2 10.0.0.7
* About to connect() to 10.0.0.7 port 80 (<span style="color: #b22222;">#</span><span style="color: #b22222;">0)</span>
*     Trying 10.0.0.7... connected
* Connected to 10.0.0.7 (10.0.0.7) port 80 (<span style="color: #b22222;">#</span><span style="color: #b22222;">0)</span>
&gt; GET / HTTP/1.1
&gt; User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1
zlib/1.2.3 libidn/1.18 libssh2/1.4.2
&gt; Host: 10.0.0.7
&gt; Accept: */*
&gt; Cookie: <span style="color: #a0522d;">WEBSRV</span>=web2
&gt;
&lt; HTTP/1.1 200 OK
&lt; date: Thu, 02 Apr 2020 02:27:57 GMT
&lt; server: Apache/2.4.6 (CentOS)
&lt; last-modified: Thu, 02 Apr 2020 01:44:28 GMT
&lt; etag: <span style="color: #8b2252;">"a-5a244f0fd5175"</span>
&lt; accept-ranges: bytes
&lt; content-length: 10
&lt; content-type: text/html; <span style="color: #a0522d;">charset</span>=UTF-8
&lt;
10.0.0.27
* Connection <span style="color: #b22222;">#</span><span style="color: #b22222;">0 to host 10.0.0.7 left intact</span>
* Closing connection <span style="color: #b22222;">#</span><span style="color: #b22222;">0</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:694bb628-d365-4bac-a3a9-16c44c882c42" class="outline-3">
<h3 id="h:694bb628-d365-4bac-a3a9-16c44c882c42">5.2 HAProxy状态页</h3>
<div class="outline-text-3" id="text-h:694bb628-d365-4bac-a3a9-16c44c882c42">
<p>
通过web界面，显示当前HAProxy的运行状态
</p>

<p>
官方帮助：
</p>
<ul class="org-ul">
<li><a href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-stats%20admin">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-stats%20admin</a></li>
<li><a href="http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#4-stats%20admin">http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#4-stats%20admin</a></li>
</ul>
</div>
<div id="outline-container-h:d7017738-0729-47b7-96d8-0fa0336b301f" class="outline-4">
<h4 id="h:d7017738-0729-47b7-96d8-0fa0336b301f">5.2.1 状态页配置项</h4>
<div class="outline-text-4" id="text-h:d7017738-0729-47b7-96d8-0fa0336b301f">
<div class="org-src-container">
<pre class="src src-sh">stats enable                       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110;&#40664;&#35748;&#30340;&#21442;&#25968;&#21551;&#29992;stats page</span>
stats hide-version                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#29366;&#24577;&#39029;&#20013;haproxy&#29256;&#26412;&#38544;&#34255;</span>
stats refresh &lt;delay&gt;              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#23450;&#33258;&#21160;&#21047;&#26032;&#26102;&#38388;&#38388;&#38548;&#65292;&#40664;&#35748;&#19981;&#33258;&#21160;&#21047;&#26032;</span>
stats uri &lt;prefix&gt;                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#23450;&#20041;stats page uri&#65292;&#40664;&#35748;&#20540;&#65306;/haproxy?stats</span>
stats realm &lt;realm&gt;                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36134;&#25143;&#35748;&#35777;&#26102;&#30340;&#25552;&#31034;&#20449;&#24687;&#65292;&#31034;&#20363;&#65306;stats realm     HAProxy\ Statistics</span>
stats auth &lt;user&gt;:&lt;passwd&gt;         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35748;&#35777;&#26102;&#30340;&#36134;&#21495;&#21644;&#23494;&#30721;&#65292;&#21487;&#23450;&#20041;&#22810;&#20010;&#29992;&#25143;,&#27599;&#34892;&#25351;&#23450;&#19968;&#20010;&#29992;&#25143;.&#40664;&#35748;&#65306;no authentication</span>
stats admin { <span style="color: #a020f0;">if</span> | unless } &lt;cond&gt; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;stats page&#20013;&#30340;&#31649;&#29702;&#21151;&#33021;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5e52a828-d10b-4856-b803-c3589675175e" class="outline-4">
<h4 id="h:5e52a828-d10b-4856-b803-c3589675175e">5.2.2 启用状态页</h4>
<div class="outline-text-4" id="text-h:5e52a828-d10b-4856-b803-c3589675175e">
<div class="org-src-container">
<pre class="src src-sh">listen stats
<span style="color: #483d8b;">bind</span> :9999
stats enable
<span style="color: #b22222;">#</span><span style="color: #b22222;">stats hide-version</span>
stats uri /haproxy-status         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#23450;&#20041;stats page uri</span>
stats realm HAProxy<span style="color: #8b2252;">\ </span>Stats<span style="color: #8b2252;">\ </span>Page  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36134;&#25143;&#35748;&#35777;&#26102;&#30340;&#25552;&#31034;&#20449;&#24687;</span>
stats auth haadmin:123456         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20004;&#20010;&#29992;&#25143;</span>
stats auth admin:123456
<span style="color: #b22222;">#</span><span style="color: #b22222;">stats refresh 30s</span>
stats admin if TRUE               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#20840;&#21407;&#22240;&#65292;&#19981;&#24314;&#35758;&#25171;&#24320;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:551476e1-e88a-4c72-ad76-07ce43d7f9d3" class="outline-4">
<h4 id="h:551476e1-e88a-4c72-ad76-07ce43d7f9d3">5.2.3 登录状态页</h4>
<div class="outline-text-4" id="text-h:551476e1-e88a-4c72-ad76-07ce43d7f9d3">
<div class="org-src-container">
<pre class="src src-sh">pid = 27134 (process <span style="color: #b22222;">#</span><span style="color: #b22222;">1, nbproc = 1, nbthread = 1)       #pid&#20026;&#24403;&#21069;pid&#21495;&#65292;process&#20026;&#24403;&#21069;&#36827;&#31243;&#21495;&#65292;nbproc&#21644;nbthread&#20026;&#19968;&#20849;&#22810;&#23569;&#36827;&#31243;&#21644;&#27599;&#20010;&#36827;&#31243;&#22810;&#23569;&#20010;&#32447;&#31243;</span>
uptime = 0d 0h00m04s                                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#20102;&#22810;&#38271;&#26102;&#38388;</span>
system limits: memmax = unlimited; ulimit-n = 200029     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31995;&#32479;&#36164;&#28304;&#38480;&#21046;&#65306;&#20869;&#23384;/&#26368;&#22823;&#25171;&#24320;&#25991;&#20214;&#25968;/</span>
maxsock = 200029; maxconn = 100000; maxpipes = 0         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#22823;socket&#36830;&#25509;&#25968;/&#21333;&#36827;&#31243;&#26368;&#22823;&#36830;&#25509;&#25968;/&#26368;&#22823;&#31649;&#36947;&#25968;maxpipes</span>
current conns = 2; current pipes = 0/0; conn rate = 2/sec; bit rate = 0.000 kbps  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#36830;&#25509;&#25968;/&#24403;&#21069;&#31649;&#36947;&#25968;/&#24403;&#21069;&#36830;&#25509;&#36895;&#29575;</span>
Running tasks: 1/14; idle = 100 %                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36816;&#34892;&#30340;&#20219;&#21153;/&#24403;&#21069;&#31354;&#38386;&#29575;</span>
active UP&#65306;                                              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#32447;&#26381;&#21153;&#22120;</span>
backup UP&#65306;                                              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26631;&#35760;&#20026;backup&#30340;&#26381;&#21153;&#22120;</span>
active UP, going down&#65306;                                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30417;&#27979;&#26410;&#36890;&#36807;&#27491;&#22312;&#36827;&#20837;down&#36807;&#31243;</span>
backup UP, going down&#65306;                                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#26381;&#21153;&#22120;&#27491;&#22312;&#36827;&#20837;down&#36807;&#31243;</span>
active DOWN, going up&#65306;                                  <span style="color: #b22222;">#</span><span style="color: #b22222;">down&#30340;&#26381;&#21153;&#22120;&#27491;&#22312;&#36827;&#20837;up&#36807;&#31243;</span>
backup DOWN, going up&#65306;                                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#26381;&#21153;&#22120;&#27491;&#22312;&#36827;&#20837;up&#36807;&#31243;</span>
active or backup DOWN&#65306;                                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#32447;&#30340;&#26381;&#21153;&#22120;&#25110;&#32773;&#26159;backup&#30340;&#26381;&#21153;&#22120;&#24050;&#32463;&#36716;&#25442;&#25104;&#20102;down&#29366;&#24577;</span>
not checked&#65306;                                            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26631;&#35760;&#20026;&#19981;&#30417;&#27979;&#30340;&#26381;&#21153;&#22120;</span>
active or backup DOWN for maintenance (MAINT)            <span style="color: #b22222;">#</span><span style="color: #b22222;">active&#25110;&#32773;backup&#26381;&#21153;&#22120;&#20154;&#20026;&#19979;&#32447;&#30340;</span>
active or backup SOFT STOPPED for maintenance            <span style="color: #b22222;">#</span><span style="color: #b22222;">active&#25110;&#32773;backup&#34987;&#20154;&#20026;&#36719;&#19979;&#32447;(&#20154;&#20026;&#23558;weight&#25913;&#25104;0)</span>
</pre>
</div>


<figure id="orgf18d250">
<img src="images/image-20210225162728316.png" alt="image-20210225162728316.png">

</figure>
</div>
</div>
<div id="outline-container-h:bd6c4ff8-1496-4ade-b388-c53e76af4474" class="outline-4">
<h4 id="h:bd6c4ff8-1496-4ade-b388-c53e76af4474">5.2.4 backend server信息</h4>
<div class="outline-text-4" id="text-h:bd6c4ff8-1496-4ade-b388-c53e76af4474">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">session rate(每秒的连接会话信息)：</th>
<th scope="col" class="org-left">Errors(错误统计信息)：</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">cur:每秒的当前会话数量</td>
<td class="org-left">Req:错误请求量</td>
</tr>

<tr>
<td class="org-left">max:每秒新的最大会话数量</td>
<td class="org-left">conn:错误链接量</td>
</tr>

<tr>
<td class="org-left">limit:每秒新的会话限制量</td>
<td class="org-left">Resp:错误响应量</td>
</tr>

<tr>
<td class="org-left">sessions(会话信息)：</td>
<td class="org-left">Warnings(警告统计信息)：</td>
</tr>

<tr>
<td class="org-left">cur:当前会话量</td>
<td class="org-left">Retr:重新尝试次数</td>
</tr>

<tr>
<td class="org-left">max:最大会话量</td>
<td class="org-left">Redis:再次发送次数</td>
</tr>

<tr>
<td class="org-left">limit: 限制会话量</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Total:总共会话量</td>
<td class="org-left">Server(real server信息)：</td>
</tr>

<tr>
<td class="org-left">LBTot:选中一台服务器所用的总时间</td>
<td class="org-left">Status:后端机的状态，包括UP和DOWN</td>
</tr>

<tr>
<td class="org-left">Last：和服务器的持续连接时间</td>
<td class="org-left">LastChk:持续检查后端服务器的时间</td>
</tr>

<tr>
<td class="org-left">Wght:权重</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Bytes(流量统计)：</td>
<td class="org-left">Act:活动链接数量</td>
</tr>

<tr>
<td class="org-left">In:网络的字节输入总量</td>
<td class="org-left">Bck:备份的服务器数量</td>
</tr>

<tr>
<td class="org-left">Out:网络的字节输出总量</td>
<td class="org-left">Chk:心跳检测时间</td>
</tr>

<tr>
<td class="org-left">Dwn:后端服务器连接后都是DOWN的数量</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Denied(拒绝统计信息)：</td>
<td class="org-left">Dwntme:总的downtime时间</td>
</tr>

<tr>
<td class="org-left">Req:拒绝请求量</td>
<td class="org-left">Thrtle:server 状态</td>
</tr>

<tr>
<td class="org-left">Resp:拒绝回复量</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:13770745-fafd-44a1-8df9-9aa4e8a009c3" class="outline-4">
<h4 id="h:13770745-fafd-44a1-8df9-9aa4e8a009c3">5.2.5 利用状态页实现haproxy服务器的健康性检查</h4>
<div class="outline-text-4" id="text-h:13770745-fafd-44a1-8df9-9aa4e8a009c3">
<p>
范例：通过curl 命令对haproxy的状态页的访问实现健康检查
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#curl -I http://haadmin:123456@10.0.0.7:9999/haproxy-status
HTTP/1.1 200 OK
cache-control: no-cache
content-type: text/html
[root@centos8 ~]#curl -I -u haadmin:123456 http://10.0.0.7:9999/haproxy-status
HTTP/1.1 200 OK
cache-control: no-cache
content-type: text/html
[root@centos8 ~]#echo $<span style="color: #a0522d;">?</span>
0
[root@haproxy ~]#systemctl stop haproxy
[root@centos8 ~]#curl -I http://haadmin:123456@10.0.0.7:9999/haproxy-status
curl: (7) Failed to connect to 10.0.0.7 port 9999: Connection refused
[root@centos8 ~]#echo $<span style="color: #a0522d;">?</span>
7
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:95f84899-75bb-48df-98bd-f475ea506fc8" class="outline-3">
<h3 id="h:95f84899-75bb-48df-98bd-f475ea506fc8">5.3 IP透传</h3>
<div class="outline-text-3" id="text-h:95f84899-75bb-48df-98bd-f475ea506fc8">
<p>
web服务器中需要记录客户端的真实IP地址，用于做访问统计、安全防护、行为分析、区域排行等场景。
</p>
</div>
<div id="outline-container-h:1dbcdf8a-67c6-4b8b-8935-69fa8717e4ca" class="outline-4">
<h4 id="h:1dbcdf8a-67c6-4b8b-8935-69fa8717e4ca">5.3.1 layer 4 与 layer 7</h4>
<div class="outline-text-4" id="text-h:1dbcdf8a-67c6-4b8b-8935-69fa8717e4ca">
<ul class="org-ul">
<li>四层：IP+PORT转发</li>
<li>七层：协议+内容交换</li>
</ul>


<figure id="orgbd507e8">
<img src="images/image-20210225162755632.png" alt="image-20210225162755632.png">

</figure>
</div>
<div id="outline-container-h:c6fd38af-1752-4aec-98db-f603557bc915" class="outline-5">
<h5 id="h:c6fd38af-1752-4aec-98db-f603557bc915">5.3.1.1 四层负载</h5>
<div class="outline-text-5" id="text-h:c6fd38af-1752-4aec-98db-f603557bc915">
<p>
在四层负载设备中，把client发送的报文目标地址(原来是负载均衡设备的IP地
址)，根据均衡设备设置的选择web服务器的规则选择对应的web服务器IP地址，
这样client就可以直接跟此服务器建立TCP连接并发送数据，而四层负载自身不
参与建立连接，而和LVS不同，haproxy是伪四层负载均衡，因为haproxy需要分
别和前端客户端及后端服务器建立连接
</p>
</div>
</div>
<div id="outline-container-h:73a1e7b4-68c1-4abb-8456-65aa5e294027" class="outline-5">
<h5 id="h:73a1e7b4-68c1-4abb-8456-65aa5e294027">5.3.1.2 七层代理</h5>
<div class="outline-text-5" id="text-h:73a1e7b4-68c1-4abb-8456-65aa5e294027">
<p>
七层负载均衡服务器起了一个反向代理服务器的作用，服务器建立一次TCP连接
要三次握手，而client要访问Web Server要先与七层负载设备进行三次握手后建
立TCP连接，把要访问的报文信息发送给七层负载均衡；然后七层负载均衡再根
据设置的均衡规则选择特定的Web Server，然后通过三次握手与此台Web Server
建立TCP连接，然后Web Server把需要的数据发送给七层负载均衡设备，负载均
衡设备再把数据发送给client；所以，七层负载均衡设备起到了代理服务器的作
用，七层代理需要和Client和后端服务器分别建立连接
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@haproxy ~]#tcpdump tcp -i eth0     -nn port ! 22 -w dump-tcp.pcap -v
[root@haproxy ~]#tcpdump tcp -i eth1     -nn port ! 22 -w dump-tcp2.pcap -v
</pre>
</div>


<figure id="org0e29a63">
<img src="images/image-20210225162825868.png" alt="image-20210225162825868.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:446aad10-340b-4b0f-b79f-59e2fc186500" class="outline-4">
<h4 id="h:446aad10-340b-4b0f-b79f-59e2fc186500">5.3.2 四层IP透传</h4>
<div class="outline-text-4" id="text-h:446aad10-340b-4b0f-b79f-59e2fc186500">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">haproxy &#37197;&#32622;&#65306;</span>
listen web_http_nodes
    <span style="color: #483d8b;">bind</span>     172.16.0.100:80
    mode tcp                         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#25903;&#25345;http&#21327;&#35758;</span>
    balance roundrobin
    server web1 www.cici.com:80 send-proxy check inter 3000 fall 3 rise 5 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;send-proxy</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">nginx &#37197;&#32622;&#65306;&#22312;&#35775;&#38382;&#26085;&#24535;&#20013;&#36890;&#36807;&#21464;&#37327;$proxy_protocol_addr &#35760;&#24405;&#36879;&#20256;&#36807;&#26469;&#30340;&#23458;&#25143;&#31471;IP</span>
http {
log_format main     <span style="color: #8b2252;">'$remote_addr - $remote_user [$time_local] "$request" "$proxy_protocol_addr"'</span>
    server {
            listen             80 proxy_protocol; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#27492;&#39033;&#65292;&#23558;&#26080;&#27861;&#30452;&#25509;&#35775;&#38382;&#27492;&#32593;&#31449;&#65292;&#21482;&#33021;&#36890;&#36807;&#22235;&#23618;&#20195;&#29702;&#35775;&#38382;</span>
            server_name www.cici.com;
......
</pre>
</div>

<p>
抓包可以看到 continuation 信息中带有客户端的源IP
</p>


<figure id="orgcdad24d">
<img src="images/image-20210225162902859.png" alt="image-20210225162902859.png">

</figure>

<p>
范例: nginx 开启四层日志功能
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">nginx&#22312;&#24320;&#21551;proxy_protocol&#21069;</span>
[root@internet ~]#curl 172.16.0.100
&lt;html&gt;
&lt;head&gt;&lt;title&gt;400 Bad Request&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
[root@VM_0_10_centos ~]# tail -f /apps/nginx/logs/nginx.access.log
111.199.187.69 - - [09/Apr/2020:20:48:51 +0800] <span style="color: #8b2252;">"PROXY TCP4 10.0.0.7 58.87.87.99</span>
<span style="color: #8b2252;">35948 80"</span> sendfileon
111.199.187.69 - - [09/Apr/2020:20:48:54 +0800] <span style="color: #8b2252;">"PROXY TCP4 10.0.0.7 58.87.87.99</span>
<span style="color: #8b2252;">35952 80"</span> sendfileon
111.199.187.69 - - [09/Apr/2020:20:48:57 +0800] <span style="color: #8b2252;">"PROXY TCP4 10.0.0.7 58.87.87.99</span>
<span style="color: #8b2252;">35954 80"</span> sendfileon

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;nginx&#26381;&#21153;&#22120;&#19978;&#24320;&#21551;&#26085;&#24535;&#26684;&#24335;&#21644;proxy_protocal</span>
[root@VM_0_10_centos ~]# vim /apps/nginx/conf/nginx.conf
http {
.......
log_format main     <span style="color: #8b2252;">'$remote_addr - $remote_user [$time_local] "$request" "$proxy_protocol_addr"'</span>
    sendfile             on;
    keepalive_timeout     65;
    client_max_body_size 100m;
    server {
            listen             80 default_server proxy_protocol ;
......
<span style="color: #b22222;">#</span><span style="color: #b22222;">nginx&#22312;&#24320;&#21551;proxy_protocol&#21518;&#65292;&#21487;&#20197;&#30475;&#23458;&#25143;&#31471;&#30495;&#23454;&#28304;IP</span>

[root@VM_0_10_centos ~]# tail -f /apps/nginx/logs/nginx.access.log
111.199.187.69 - - [09/Apr/2020:20:52:52 +0800] <span style="color: #8b2252;">"GET / HTTP/1.1"</span>
<span style="color: #8b2252;">"172.16.0.200"</span>sendfileon
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b5dbdacd-4968-485e-8a9b-746a43469eaf" class="outline-4">
<h4 id="h:b5dbdacd-4968-485e-8a9b-746a43469eaf">5.3.3 七层IP透传</h4>
<div class="outline-text-4" id="text-h:b5dbdacd-4968-485e-8a9b-746a43469eaf">
<p>
当haproxy工作在七层的时候，也可以透传客户端真实IP至后端服务器
</p>
</div>
<div id="outline-container-h:07000983-4eda-4f9a-8dce-9a03dc052746" class="outline-5">
<h5 id="h:07000983-4eda-4f9a-8dce-9a03dc052746">5.3.3.1 HAProxy配置</h5>
<div class="outline-text-5" id="text-h:07000983-4eda-4f9a-8dce-9a03dc052746">
<p>
在由haproxy发往后端主机的请求报文中添加”X-Forwarded-For”首部，其值为前端客户端的地址；用于向后端主发送真实的客户端IP
</p>

<div class="org-src-container">
<pre class="src src-sh">option forwardfor [ except &lt;network&gt; ] [ header &lt;name&gt; ] [ if-none ]
[ except &lt;network&gt; ]&#65306;&#35831;&#27714;&#25253;&#35831;&#26469;&#33258;&#27492;&#22788;&#25351;&#23450;&#30340;&#32593;&#32476;&#26102;&#19981;&#20104;&#28155;&#21152;&#27492;&#39318;&#37096;&#65292;&#22914;haproxy&#33258;&#36523;&#25152;&#22312;&#32593;&#32476;
[ header &lt;name&gt; ]&#65306;&#20351;&#29992;&#33258;&#23450;&#20041;&#30340;&#39318;&#37096;&#21517;&#31216;&#65292;&#32780;&#38750;<span style="color: #8b2252;">"X-Forwarded-For"</span>&#65292;&#31034;&#20363;&#65306;X-client
[ if-none ] &#22914;&#26524;&#27809;&#26377;&#39318;&#37096;&#25165;&#28155;&#21152;&#39318;&#37096;&#65292;&#22914;&#26524;&#26377;&#20351;&#29992;&#40664;&#35748;&#20540;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">haproxy &#37197;&#32622;</span>
defaults
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27492;&#20026;&#40664;&#35748;&#20540;,&#39318;&#37096;&#23383;&#27573;&#40664;&#35748;&#20026;&#65306;X-Forwarded-For</span>
option forwardfor 
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#33258;&#23450;&#20041;&#39318;&#37096;,&#22914;:X-client</span>
option forwardfor except 127.0.0.0/8 header X-client
<span style="color: #b22222;">#</span><span style="color: #b22222;">listen&#37197;&#32622;</span>
listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80
mode http
log global
balance random
server web1 10.0.0.17:80 weight 1 check inter 3000 fall 2 rise 5
server web2 10.0.0.27:80 weight 1 check inter 3000 fall 2 rise 5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:57075690-d525-4b09-b598-41464bf09649" class="outline-5">
<h5 id="h:57075690-d525-4b09-b598-41464bf09649">5.3.3.2 web服务器日志格式配置</h5>
<div class="outline-text-5" id="text-h:57075690-d525-4b09-b598-41464bf09649">
<p>
配置web服务器，记录负载均衡透传的客户端IP地址
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">apache &#37197;&#32622;&#65306;</span>
LogFormat <span style="color: #8b2252;">"%{X-Forwarded-For}i %a %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\""</span> combined

<span style="color: #b22222;">#</span><span style="color: #b22222;">nginx &#26085;&#24535;&#26684;&#24335;&#65306;</span>
$<span style="color: #a0522d;">proxy_add_x_forwarded_for</span>&#65306;&#21253;&#25324;&#23458;&#25143;&#31471;IP&#21644;&#20013;&#38388;&#32463;&#36807;&#30340;&#25152;&#26377;&#20195;&#29702;&#30340;IP
$<span style="color: #a0522d;">http_x_forwarded_For</span>&#65306;&#21482;&#26377;&#23458;&#25143;&#31471;IP
log_format main <span style="color: #8b2252;">'"$proxy_add_x_forwarded_for" - $remote_user [$time_local] "$request" '</span>
                <span style="color: #8b2252;">'$status $body_bytes_sent "$http_referer" '</span>
                <span style="color: #8b2252;">'"$http_user_agent" $http_x_forwarded_For'</span>;

[root@centos8 ~]#tail /var/log/nginx/access.log
<span style="color: #8b2252;">"172.16.0.200, 10.0.0.7"</span> 10.0.0.7 - - [09/Apr/2020:19:10:16 +0800] <span style="color: #8b2252;">"GET /</span>
<span style="color: #8b2252;">HTTP/1.1"</span> 200 4057 <span style="color: #8b2252;">"-"</span> <span style="color: #8b2252;">"curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7</span>
<span style="color: #8b2252;">NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2"</span> <span style="color: #8b2252;">"172.16.0.200"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">tomcat &#37197;&#32622;&#65306;conf&#30446;&#24405;&#19979;&#30340;server.xml</span>
&lt;Valve <span style="color: #a0522d;">className</span>=<span style="color: #8b2252;">"org.apache.catalina.valves.AccessLogValve"</span> <span style="color: #a0522d;">directory</span>=<span style="color: #8b2252;">"logs"</span>
    <span style="color: #a0522d;">prefix</span>=<span style="color: #8b2252;">"localhost_access_log"</span> <span style="color: #a0522d;">suffix</span>=<span style="color: #8b2252;">".txt"</span>
    <span style="color: #a0522d;">pattern</span>=<span style="color: #8b2252;">"%{X-Forwarded-For}i %h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /&gt;   
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f6b667b8-d754-435f-a95d-91994e03e61d" class="outline-5">
<h5 id="h:f6b667b8-d754-435f-a95d-91994e03e61d">5.3.3.3 验证客户端IP地址</h5>
<div class="outline-text-5" id="text-h:f6b667b8-d754-435f-a95d-91994e03e61d">
<p>
apache日志：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#vim /etc/httpd/conf/httpd.conf
LogFormat <span style="color: #8b2252;">"%{X-Forwarded-For}i %h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\""</span> combined
[root@centos7 ~]#systemctl restart httpd
[root@centos6 ~]#hostname -I
10.0.0.6
[root@centos6 ~]#curl     http://10.0.0.7
10.0.0.17
[root@centos7 ~]#tail -f /var/log/httpd/access_log
10.0.0.6 10.0.0.7 - - [01/Apr/2020:01:08:31 +0800] <span style="color: #8b2252;">"GET / HTTP/1.1"</span> 200 10 <span style="color: #8b2252;">"-"</span>
<span style="color: #8b2252;">"curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3</span>
<span style="color: #8b2252;">libidn/1.18 libssh2/1.4.2"</span>
10.0.0.6 10.0.0.7 - - [01/Apr/2020:01:08:33 +0800] <span style="color: #8b2252;">"GET / HTTP/1.1"</span> 200 10 <span style="color: #8b2252;">"-"</span>
<span style="color: #8b2252;">"curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3</span>
<span style="color: #8b2252;">libidn/1.18 libssh2/1.4.2"</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:c1391523-855d-46af-9d68-df284e3c9f9c" class="outline-3">
<h3 id="h:c1391523-855d-46af-9d68-df284e3c9f9c">5.4 报文修改</h3>
<div class="outline-text-3" id="text-h:c1391523-855d-46af-9d68-df284e3c9f9c">
<p>
在http模式下，基于实际需求修改客户端的请求报文与响应报文，通过reqadd和reqdel在请求报文添加删除字段，通过rspadd与rspidel在响应报文中添加与删除字段。
</p>

<p>
注意：此功能的以下相关指令在2.1版本中已经取消
</p>

<p>
官方文档：参看2.0的帮助文档
<a href="http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#4-rspadd">http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#4-rspadd</a>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#21521;&#21518;&#31471;&#26381;&#21153;&#22120;&#36716;&#21457;&#30340;&#35831;&#27714;&#25253;&#25991;&#23614;&#37096;&#28155;&#21152;&#25351;&#23450;&#39318;&#37096;</span>
reqadd &lt;string&gt; [{<span style="color: #a020f0;">if</span> | unless} &lt;cond&gt;]
&#31034;&#20363;&#65306;reqadd X-Via:<span style="color: #8b2252;">\ </span>HAproxy     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#21482;&#33021;&#26377;&#19968;&#20010;&#31354;&#26684;&#65292;&#24182;&#38656;&#35201;&#36716;&#20041;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#21521;&#21518;&#31471;&#26381;&#21153;&#22120;&#36716;&#21457;&#30340;&#35831;&#27714;&#25253;&#25991;&#20013;&#21024;&#38500;&#21305;&#37197;&#27491;&#21017;&#34920;&#36798;&#24335;&#30340;&#39318;&#37096;</span>
reqdel &lt;search&gt; [{<span style="color: #a020f0;">if</span> | unless} &lt;cond&gt;]
reqidel &lt;search&gt; [{<span style="color: #a020f0;">if</span> | unless} &lt;cond&gt;]     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24573;&#30053;&#22823;&#23567;&#20889;</span>
&#31034;&#20363;&#65306;
reqidel user-agent
reqidel X-Forwarded-For <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26080;&#27861;&#21024;&#38500;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#21521;&#21069;&#31471;&#23458;&#25143;&#31471;&#36716;&#21457;&#30340;&#21709;&#24212;&#25253;&#25991;&#23614;&#37096;&#28155;&#21152;&#25351;&#23450;&#39318;&#37096;</span>
rspadd &lt;string&gt; [{<span style="color: #a020f0;">if</span> | unless} &lt;cond&gt;]
&#31034;&#20363;&#65306;
rspadd X-Via:<span style="color: #8b2252;">\ </span>HAproxy
rspadd Server:<span style="color: #8b2252;">\ </span>wanginx

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#21521;&#21069;&#31471;&#23458;&#25143;&#31471;&#36716;&#21457;&#30340;&#21709;&#24212;&#25253;&#25991;&#20013;&#21024;&#38500;&#21305;&#37197;&#27491;&#21017;&#34920;&#36798;&#24335;&#30340;&#39318;&#37096;</span>
rspdel &lt;search&gt; [{<span style="color: #a020f0;">if</span> | unless} &lt;cond&gt;]
rspidel &lt;search&gt; [{<span style="color: #a020f0;">if</span> | unless} &lt;cond&gt;]     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24573;&#30053;&#22823;&#23567;&#20889;</span>
&#31034;&#20363;&#65306;
rspidel ^server:.* <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#21709;&#24212;&#25253;&#25991;&#21024;&#38500;server&#20449;&#24687;</span>
rspidel X-Powered-By:.* <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#21709;&#24212;&#25253;&#25991;&#21024;&#38500;X-Powered-By&#20449;&#24687;,&#19968;&#33324;&#27492;&#39318;&#37096;&#23383;&#27573;&#20445;&#23384;php&#29256;&#26412;&#20449;&#24687; #</span>
</pre>
</div>

<p>
2.1版本以上用下面指令http-request和http-response代替
</p>

<p>
官方文档：
</p>
<ul class="org-ul">
<li><a href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-http-request">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-http-request</a></li>
<li><a href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-http-response">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#4-http-response</a></li>
</ul>

<p>
配置说明：
</p>

<div class="org-src-container">
<pre class="src src-sh">http-request add-header &lt;name&gt; &lt;fmt&gt; [ { <span style="color: #a020f0;">if</span> | unless } &lt;condition&gt; ]
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;http-request add-header X-Haproxy-Current-Date %T</span>
http-request del-header &lt;name&gt; [ { <span style="color: #a020f0;">if</span> | unless } &lt;condition&gt; ]
http-response add-header &lt;name&gt; &lt;fmt&gt; [ { <span style="color: #a020f0;">if</span> | unless } &lt;condition&gt; ]
http-response del-header &lt;name&gt;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;http-response del-header Server</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#21521;&#21518;&#31471;&#25253;&#21153;&#22120;&#21457;&#36215;&#30340;&#35831;&#27714;&#25253;&#25991;&#39318;&#37096;</span>
vim haproxy.cfg
frontend main *:80
<span style="color: #b22222;">#             </span><span style="color: #b22222;">bind *:80</span>
            default_backend websrvs
            reqadd testheader:<span style="color: #8b2252;">\ </span>haproxyserver     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#27492;&#34892;,&#27880;&#24847;&#21482;&#33021;&#26377;&#19968;&#20010;&#31354;&#26684;&#65292;&#24182;&#38656;&#35201;&#36716;&#20041;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#21518;&#31471;httpd&#26381;&#21153;&#22120;</span>
vim /etc/httpd/conf/httpd.conf
LogFormat <span style="color: #8b2252;">"%{testheader}i %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\""</span> combined
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26085;&#24535;</span>
tail &#8211;f /var/log/httpd/acesss_log
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#21709;&#24212;&#25253;&#25991;&#39318;&#37096;</span>
vim haproxy.cfg
frontend main *:80
<span style="color: #b22222;">#             </span><span style="color: #b22222;">bind *:80</span>
            default_backend websrvs
            rspadd X-Via:<span style="color: #8b2252;">\ </span>HAproxy-1     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#27492;&#34892;</span>
            maxconn                 5000
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#35775;&#38382;&#35843;&#35797;&#27169;&#24335;,&#26597;&#30475;reponse headers&#65292;&#30475;&#21040;</span>
Server: Apache/2.4.37 (centos)     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31995;&#32479;&#33258;&#24102;&#26174;&#31034;</span>
X-Via: HAproxy-1
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#21709;&#24212;&#25253;&#25991;&#20013;&#30340;server&#39318;&#37096;</span>
vim haproxy.cfg
frontend main *:80
<span style="color: #b22222;">#             </span><span style="color: #b22222;">bind *:80</span>
            default_backend websrvs
            rspadd X-Via:<span style="color: #8b2252;">\ </span>HAproxy-1
            rspdel Server &#25110;&#32773; rspidel server         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#27492;&#34892; ,&#24573;&#30053;&#22823;&#23567;&#20889;</span>
            rspidel X-Powered-By:.* <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;Php&#29256;&#26412;</span>
            maxconn                 5000
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#35775;&#38382;&#35843;&#35797;&#27169;&#24335;,&#26597;&#30475;reponse headers&#65292;&#30475;&#21040;</span>
Server: Apache/2.4.37 (centos)     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27492;&#34892;&#28040;&#22833;</span>
X-Via: HAproxy-1
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22686;&#21152;&#21709;&#24212;&#25253;&#25991;&#30340;&#39318;&#37096;&#65292;&#23454;&#29616;&#20266;&#35013;Server&#39318;&#37096;</span>
vim haproxy.cfg
frontend main *:80
<span style="color: #b22222;">#             </span><span style="color: #b22222;">bind *:80</span>
            default_backend websrvs
            rspadd X-Via:<span style="color: #8b2252;">\ </span>HAproxy-1
            rspdel Server     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#29992; rspidel server</span>
rspadd Server:<span style="color: #8b2252;">\ </span>    wanginx     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22686;&#21152;&#27492;&#34892;</span>
[root@internet ~]#curl -i     172.16.0.100
HTTP/1.1 200 OK
date: Thu, 09 Apr 2020 08:32:10 GMT
last-modified: Thu, 09 Apr 2020 01:23:18 GMT
etag: <span style="color: #8b2252;">"f-5a2d17630635b"</span>
accept-ranges: bytes
content-length: 15
content-type: text/html; <span style="color: #a0522d;">charset</span>=UTF-8
server: wanginx
RS1 10.0.0.17
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#vim /etc/haproxy/haproxy.cfg
listen web_port
<span style="color: #483d8b;">bind</span> 10.0.0.7:80
http-request add-header X-Haproxy-Current-Date %T <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#39318;&#37096;</span>
http-response del-header server <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#39318;&#37096;</span>
mode http
log global
option httpchk
http-check expect status 200
server web1     10.0.0.17:80 check inter 3000 fall 2 rise 5
server web2     10.0.0.27:80 check inter 3000 fall 2 rise 5
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#21518;&#31471;&#26381;&#21153;&#22120;&#26085;&#24535;</span>
tail &#8211;f /var/log/httpd/acesss_log
10.0.0.7 - - [05/Apr/2020:20:13:48 +0800] <span style="color: #8b2252;">"GET / HTTP/1.1"</span> 200 10 <span style="color: #8b2252;">"-"</span>
<span style="color: #8b2252;">"curl/7.19.7 (x86_64-redhat-linux-gnu) l</span>
<span style="color: #8b2252;">ibcurl/7.19.7 NSS/3.27.1 zlib/1.2.3 libidn/1.18 libssh2/1.4.2"</span>
<span style="color: #8b2252;">"05/Apr/2020:12:13:48 +0000"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:99aa2530-d6f2-4d8b-bbaf-9508c4d258f5" class="outline-3">
<h3 id="h:99aa2530-d6f2-4d8b-bbaf-9508c4d258f5">5.5 自定义日志格式</h3>
<div class="outline-text-3" id="text-h:99aa2530-d6f2-4d8b-bbaf-9508c4d258f5">
<p>
log global 开启日志功能，默认只会在记录下面格式的日志
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@haproxy ~]#tail /var/log/haproxy.log
Apr 9 19:38:46 localhost haproxy[60049]: Connect from 172.16.0.200:54628 to
172.16.0.100:80 (web_prot_http_nodes/HTTP)
</pre>
</div>

<p>
option httplog 可以用 http
格式记录下来，并且可以使用相关指令将特定信息记录在haproxy的日志中
但一般不建议开启，这会加重 HAProxy 负载
</p>
</div>
<div id="outline-container-h:7e2cc162-10a6-40fd-8ca7-384de7ef653f" class="outline-4">
<h4 id="h:7e2cc162-10a6-40fd-8ca7-384de7ef653f">5.5.1 配置选项</h4>
<div class="outline-text-4" id="text-h:7e2cc162-10a6-40fd-8ca7-384de7ef653f">
<div class="org-src-container">
<pre class="src src-sh">log global                                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#35760;&#24405;&#26085;&#24535;,&#40664;&#35748;&#19981;&#24320;&#21551;</span>
option httplog                                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#35760;&#24405;httplog&#26085;&#24535;&#26684;&#24335;&#36873;&#39033;</span>
capture cookie &lt;name&gt; len &lt;length&gt;             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25429;&#33719;&#35831;&#27714;&#21644;&#21709;&#24212;&#25253;&#25991;&#20013;&#30340; cookie&#21450;&#20540;&#30340;&#38271;&#24230;,&#23558;&#20043;&#35760;&#24405;&#21040;&#26085;&#24535;</span>
capture request header &lt;name&gt; len &lt;length&gt;     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25429;&#33719;&#35831;&#27714;&#25253;&#25991;&#20013;&#25351;&#23450;&#30340;&#39318;&#37096;&#20869;&#23481;&#21644;&#38271;&#24230;&#24182;&#35760;&#24405;&#26085;&#24535;</span>
capture response header &lt;name&gt; len &lt;length&gt;    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25429;&#33719;&#21709;&#24212;&#25253;&#25991;&#20013;&#25351;&#23450;&#30340;&#20869;&#23481;&#21644;&#38271;&#24230;&#39318;&#37096;&#24182;&#35760;&#24405;&#26085;&#24535;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;</span>
log global
option httplog
capture request header Host len     256
capture request header User-Agent len 512
capture request header Referer len 15
capture request header X-Forwarded-For len 15
</pre>
</div>

<p>
同时开启日志功能log global和option httplog，记录日志格式如下
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@haproxy ~]#tail /var/log/haproxy.log
Apr     9 19:42:02 localhost haproxy[60236]: 172.16.0.200:54630
[09/Apr/2020:19:42:02.623] web_prot_http_nodes web_prot_http_nodes/web1
0/0/1/1/2 200 4264 - - ---- 1/1/0/0/0 0/0 <span style="color: #8b2252;">"GET / HTTP/1.1"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:68642fcd-b48b-4821-bbb6-bce8b7d9541a" class="outline-4">
<h4 id="h:68642fcd-b48b-4821-bbb6-bce8b7d9541a">5.5.2 配置示例</h4>
<div class="outline-text-4" id="text-h:68642fcd-b48b-4821-bbb6-bce8b7d9541a">
<div class="org-src-container">
<pre class="src src-sh">listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80
mode http
balance roundrobin
log global                                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#26085;&#24535;&#21151;&#33021;</span>
option httplog                             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;httplog&#26085;&#24535;&#26684;&#24335;&#36873;&#39033;</span>
capture request header User-Agent len 512  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35760;&#24405;&#26085;&#24535;&#20449;&#24687;,&#35760;&#24405;User-Agent&#39318;&#37096;&#20540;&#30340;&#21069;512&#20010;&#23383;&#31526;</span>
capture request header Host len     256    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35760;&#24405;&#26085;&#24535;&#20449;&#24687;,&#35760;&#24405;Host&#39318;&#37096;&#20540;</span>
cookie SERVER-COOKIE insert indirect nocache
server web1 10.0.0.17:80 cookie web1 check inter 3000 fall 3 rise 5
server web2 10.0.0.27:80 cookie web2 check inter 3000 fall 3 rise 5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f542c028-6737-4fcd-b16d-e7f8f146c1f8" class="outline-4">
<h4 id="h:f542c028-6737-4fcd-b16d-e7f8f146c1f8">5.5.3 验证日志格式</h4>
<div class="outline-text-4" id="text-h:f542c028-6737-4fcd-b16d-e7f8f146c1f8">
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#tail -n3 /var/log/haproxy.log
Apr     2 12:44:26 localhost haproxy[27637]: 10.0.0.6:50004
[02/Apr/2020:12:44:26.817] web_port web_port/web1 0/0/0/2/3 200 42484 - - --NI
1/1/0/0/0 0/0 {curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1
zlib/1.2.3 libidn/1.18 libssh2/1.4.2|10.0.0.7} <span style="color: #8b2252;">"GET /test.php HTTP/1.1"</span>
Apr     2 12:44:27 localhost haproxy[27637]: 10.0.0.6:50006
[02/Apr/2020:12:44:27.294] web_port web_port/web2 0/0/0/1/1 404 370 - - --NI
1/1/0/0/0 0/0 {curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1
zlib/1.2.3 libidn/1.18 libssh2/1.4.2|10.0.0.7} <span style="color: #8b2252;">"GET /test.php HTTP/1.1"</span>
Apr     2 12:44:27 localhost haproxy[27637]: 10.0.0.6:50008
[02/Apr/2020:12:44:27.840] web_port web_port/web1 0/0/0/3/4 200 42484 - - --NI
1/1/0/0/0 0/0 {curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1
zlib/1.2.3 libidn/1.18 libssh2/1.4.2|10.0.0.7} <span style="color: #8b2252;">"GET /test.php HTTP/1.1"</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:16c6a3fa-7621-4a4d-9d66-5f4bf25fbb37" class="outline-3">
<h3 id="h:16c6a3fa-7621-4a4d-9d66-5f4bf25fbb37">5.6 压缩功能</h3>
<div class="outline-text-3" id="text-h:16c6a3fa-7621-4a4d-9d66-5f4bf25fbb37">
<p>
对响应给客户端的报文进行压缩，以节省网络带宽，但是会占用部分CPU性能
建议在后端服务器开启压缩功能，而非在HAProxy上开启压缩
</p>
</div>
<div id="outline-container-h:f76e6c9e-87b4-4aac-852a-db2428e98d52" class="outline-4">
<h4 id="h:f76e6c9e-87b4-4aac-852a-db2428e98d52">5.6.1 配置选项</h4>
<div class="outline-text-4" id="text-h:f76e6c9e-87b4-4aac-852a-db2428e98d52">
<div class="org-src-container">
<pre class="src src-sh">compression algo &lt;algorithm&gt; ...       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;http&#21327;&#35758;&#20013;&#30340;&#21387;&#32553;&#26426;&#21046;&#65292;&#24120;&#29992;&#31639;&#27861;&#26377;gzip&#65292;deflate</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21387;&#32553;&#31639;&#27861;&lt;algorithm&gt;&#25903;&#25345;&#19979;&#38754;&#31867;&#22411;&#65306;</span>
identity                               <span style="color: #b22222;">#</span><span style="color: #b22222;">debug&#35843;&#35797;&#20351;&#29992;&#30340;&#21387;&#32553;&#26041;&#24335;</span>
gzip                                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24120;&#29992;&#30340;&#21387;&#32553;&#26041;&#24335;&#65292;&#19982;&#21508;&#27983;&#35272;&#22120;&#20860;&#23481;&#36739;&#22909;</span>
deflate                                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26377;&#20123;&#27983;&#35272;&#22120;&#19981;&#25903;&#25345;</span>
raw-deflate                            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26032;&#24335;&#30340;&#21387;&#32553;&#26041;&#24335;</span>
compression type &lt;mime type&gt; ...       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35201;&#21387;&#32553;&#30340;&#25991;&#20214;&#31867;&#22411;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;</span>
compression algo gzip deflate
compression type text/html text/css text/plain
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a179f794-e5b3-4548-965c-cd3838ccc7b3" class="outline-4">
<h4 id="h:a179f794-e5b3-4548-965c-cd3838ccc7b3">5.6.2 配置示例</h4>
<div class="outline-text-4" id="text-h:a179f794-e5b3-4548-965c-cd3838ccc7b3">
<div class="org-src-container">
<pre class="src src-sh">listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80
mode http
balance roundrobin
log global
option httplog
compression algo gzip deflate     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#21387;&#32553;&#21644;&#25351;&#23450;&#31639;&#27861;</span>
compression type compression type text/plain text/html text/css text/xml
text/javascript application/javascript                         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#21387;&#32553;&#25991;&#20214;&#31867;&#22411;</span>
server web1 10.0.0.17:80 cookie web1 check inter 3000 fall 3 rise 5
server web2 10.0.0.27:80 cookie web2 check inter 3000 fall 3 rise 5

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#31471;&#26381;&#21153;&#22120;&#20934;&#22791;&#19968;&#20010;&#25991;&#26412;&#25991;&#20214;</span>
[root@centos7 ~]#ll /var/www/html/m.txt -h
-rwxr-xr-x 1 root root 772K Apr     2 12:56 /var/www/html/m.txt
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9d37d964-ab2b-4651-a4c7-5676e6d6b9aa" class="outline-4">
<h4 id="h:9d37d964-ab2b-4651-a4c7-5676e6d6b9aa">5.6.3 验证压缩功能</h4>
<div class="outline-text-4" id="text-h:9d37d964-ab2b-4651-a4c7-5676e6d6b9aa">
<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#curl -is --compressed     10.0.0.7/m.txt|less
HTTP/1.1 200 OK
date: Thu, 02 Apr 2020 05:00:26 GMT
server: Apache/2.4.6 (CentOS) PHP/5.4.16
last-modified: Thu, 02 Apr 2020 04:56:25 GMT
etag: W/<span style="color: #8b2252;">"c0ef6-5a2479f7aee68"</span>
accept-ranges: bytes
content-type: text/plain; <span style="color: #a0522d;">charset</span>=UTF-8
set-cookie: <span style="color: #a0522d;">WEBSRV</span>=web1; <span style="color: #a0522d;">path</span>=/
cache-control: private
content-encoding: deflate
transfer-encoding: chunked
vary: Accept-Encoding
Feb     2 18:49:27 centos7 journal: Runtime journal is using 6.0M (max allowed
48.6M, trying to leave 72.9M free of 480.1M available &#8594; current limit 48.6M)<span style="color: #483d8b;">.</span>
Feb     2 18:49:27 centos7 kernel: Initializing cgroup subsys cpuset
Feb     2 18:49:27 centos7 kernel: Initializing cgroup subsys cpu
Feb     2 18:49:27 centos7 kernel: Initializing cgroup subsys cpuacct
......
</pre>
</div>


<figure id="org291fd7e">
<img src="images/image-20210225162945453.png" alt="image-20210225162945453.png">

</figure>


<figure id="org01e7a05">
<img src="images/image-20210225163005234.png" alt="image-20210225163005234.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:c3ca62e4-c675-4334-bfb4-d79fc31ef6c3" class="outline-3">
<h3 id="h:c3ca62e4-c675-4334-bfb4-d79fc31ef6c3">5.7 web服务器状态监测</h3>
<div class="outline-text-3" id="text-h:c3ca62e4-c675-4334-bfb4-d79fc31ef6c3">
</div>
<div id="outline-container-h:8d96c4a4-3468-4d43-90ce-a64cb46680aa" class="outline-4">
<h4 id="h:8d96c4a4-3468-4d43-90ce-a64cb46680aa">5.7.1 三种状态监测方式</h4>
<div class="outline-text-4" id="text-h:8d96c4a4-3468-4d43-90ce-a64cb46680aa">
<div class="org-src-container">
<pre class="src src-sh">&#22522;&#20110;&#22235;&#23618;&#30340;&#20256;&#36755;&#31471;&#21475;&#20570;&#29366;&#24577;&#30417;&#27979;&#65292;&#27492;&#20026;&#40664;&#35748;&#26041;&#24335;
&#22522;&#20110;&#25351;&#23450; URI &#20570;&#29366;&#24577;&#30417;&#27979;,&#38656;&#35201;&#35775;&#38382;&#25972;&#20010;&#39029;&#38754;&#36164;&#28304;,&#21344;&#29992;&#26356;&#22810;&#24102;&#23485;
&#22522;&#20110;&#25351;&#23450; URI &#30340;request&#35831;&#27714;&#22836;&#37096;&#20869;&#23481;&#20570;&#29366;&#24577;&#30417;&#27979;&#65292;&#21344;&#29992;&#36739;&#23569;&#24102;&#23485;,&#24314;&#35758;&#20351;&#29992;&#27492;&#26041;&#24335;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d7c170b6-a0fb-40cc-94ad-b0bab8e31cd6" class="outline-4">
<h4 id="h:d7c170b6-a0fb-40cc-94ad-b0bab8e31cd6">5.7.2 基于应用层http协议进行健康性检测</h4>
<div class="outline-text-4" id="text-h:d7c170b6-a0fb-40cc-94ad-b0bab8e31cd6">
<p>
基于应用层http协议，采有不同的监测方式，对后端real server进行状态监测
注意: 此方式会导致在后端服务器生成很多的HAProxy发起的访问日志
</p>

<div class="org-src-container">
<pre class="src src-sh">option httpchk     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#19971;&#23618;&#20581;&#24247;&#24615;&#26816;&#27979;&#65292;&#23545;tcp &#21644; http &#27169;&#24335;&#37117;&#25903;&#25345;&#65292;&#40664;&#35748;&#20026;&#65306;OPTIONS</span>
/ HTTP/1.0
option httpchk &lt;uri&gt;
option httpchk &lt;method&gt; &lt;uri&gt;
option httpchk &lt;method&gt; &lt;uri&gt; &lt;version&gt;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26399;&#26395;&#20197;&#19978;&#26816;&#26597;&#24471;&#21040;&#30340;&#21709;&#24212;&#30721;</span>
http-check expect [!] &lt;match&gt; &lt;pattern&gt;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;</span>
http-check expect status 200
http-check expect ! rstatus ^5 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25903;&#25345;&#27491;&#21017;&#34920;&#36798;&#24335;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#20110;HTTP/1.1&#30340;&#35828;&#26126;</span>
&lt;version&gt; is the optional HTTP version string. It defaults to <span style="color: #8b2252;">"HTTP/1.0"</span> but
some servers might behave incorrectly<span style="color: #a020f0;"> in</span> HTTP 1.0, so turning it to HTTP/1.1 may
sometimes help. Note that the Host field is                 mandatory<span style="color: #a020f0;"> in</span> HTTP/1.1, and
as a trick, it is possible to pass it after <span style="color: #8b2252;">"\r\n"</span> following the version string.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0cff25c9-f2d8-4b52-a8d5-73431800ebce" class="outline-4">
<h4 id="h:0cff25c9-f2d8-4b52-a8d5-73431800ebce">5.7.3 配置示例</h4>
<div class="outline-text-4" id="text-h:0cff25c9-f2d8-4b52-a8d5-73431800ebce">
<div class="org-src-container">
<pre class="src src-sh">listen web_host
<span style="color: #483d8b;">bind</span> 10.0.0.7:80
mode http
balance roundrobin
    <span style="color: #b22222;">#</span><span style="color: #b22222;">option httpchk GET /monitor/check.html #&#40664;&#35748;HTTP/1.0</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">option httpchk GET /monitor/check.html HTTP/1.0</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">option httpchk GET /monitor/check.html HTTP/1.1 #&#27880;&#24847;&#65306;HTTP/1.1&#24378;&#21046;&#35201;&#27714;&#24517;&#39035;</span>
&#26377;Host&#23383;&#27573;
option httpchk HEAD /monitor/check.html HTTP/1.1\r\nHost:<span style="color: #8b2252;">\ </span>10.0.0.7 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;HEAD</span>
&#20943;&#23569;&#32593;&#32476;&#27969;&#37327;
cookie SERVER-COOKIE insert indirect nocache
server web1 10.0.0.17:80 cookie web1 check inter 3000 fall 3 rise 5
server web2 10.0.0.27:80 cookie web2 check inter 3000 fall 3 rise 5

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#25152;&#26377;&#21518;&#31471;&#26381;&#21153;&#24314;&#31435;&#26816;&#27979;&#39029;&#38754;</span>
[root@backend ~]#mkdir /var/www/html/monitor/
[root@backend ~]#echo monitor &gt; /var/www/html/monitor/check.html
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#38381;&#19968;&#21488;Backend&#26381;&#21153;&#22120;</span>
[root@backend1 ~]#systemctl stop httpd
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f95a28d5-cbab-43fa-b421-2877802397ae" class="outline-4">
<h4 id="h:f95a28d5-cbab-43fa-b421-2877802397ae">5.7.4 验证http监测</h4>
<div class="outline-text-4" id="text-h:f95a28d5-cbab-43fa-b421-2877802397ae">
<p>
查看到状态页，可以看到启了七层检测功能：LastChk字段：L7
</p>


<figure id="org65a73f0">
<img src="images/image-20210225163121821.png" alt="image-20210225163121821.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#31471;&#26381;&#21153;&#22120;&#26597;&#30475;&#35775;&#38382;&#26085;&#24535;</span>
[root@backend ~]#tail /var/log/httpd/access_log
10.0.0.7 - - [02/Apr/2020:14:25:22 +0800] <span style="color: #8b2252;">"HEAD /monitor/check.html HTTP/1.1"</span>
200 - <span style="color: #8b2252;">"-"</span> <span style="color: #8b2252;">"-"</span>
10.0.0.7 - - [02/Apr/2020:14:25:25 +0800] <span style="color: #8b2252;">"HEAD /monitor/check.html HTTP/1.1"</span>
200 - <span style="color: #8b2252;">"-"</span> <span style="color: #8b2252;">"-"</span>
10.0.0.7 - - [02/Apr/2020:14:25:28 +0800] <span style="color: #8b2252;">"HEAD /monitor/check.html HTTP/1.1"</span>
200 - <span style="color: #8b2252;">"-"</span> <span style="color: #8b2252;">"-"</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:a889d025-f8d0-4b06-984f-4b1055510bc6" class="outline-3">
<h3 id="h:a889d025-f8d0-4b06-984f-4b1055510bc6">5.8 ACL</h3>
<div class="outline-text-3" id="text-h:a889d025-f8d0-4b06-984f-4b1055510bc6">
<p>
访问控制列表（ACL，Access Control Lists）是一种基于包过滤的访问控制技
术，它可以根据设定的条件对经过服务器传输的数据包进行过滤(条件匹配)，即
对接收到的报文进行匹配和过滤，基于请求报文头部中的源地址、源端口、目标
地址、目标端口、请求方法、URL、文件后缀等信息内容进行匹配并执行进一步
操作，比如允许其通过或丢弃。
</p>

<p>
官方帮助：
</p>
<ul class="org-ul">
<li><a href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#7">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#7</a></li>
<li><a href="http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#7">http://cbonte.github.io/haproxy-dconv/2.0/configuration.html#7</a></li>
</ul>
</div>
<div id="outline-container-h:af0a4584-0628-435e-a33e-9cb9f315e120" class="outline-4">
<h4 id="h:af0a4584-0628-435e-a33e-9cb9f315e120">5.8.1 ACL配置选项</h4>
<div class="outline-text-4" id="text-h:af0a4584-0628-435e-a33e-9cb9f315e120">
<div class="org-src-container">
<pre class="src src-sh">acl     &lt;aclname&gt; &lt;criterion&gt;     [flags]         [operator]     [&lt;value&gt;]
acl         &#21517;&#31216;         &#21305;&#37197;&#35268;&#33539;         &#21305;&#37197;&#27169;&#24335;         &#20855;&#20307;&#25805;&#20316;&#31526;         &#25805;&#20316;&#23545;&#35937;&#31867;&#22411;
</pre>
</div>
</div>
<div id="outline-container-h:821c3012-3e35-436e-b37c-d627e8869c91" class="outline-5">
<h5 id="h:821c3012-3e35-436e-b37c-d627e8869c91">5.8.1.1 ACL-Name</h5>
<div class="outline-text-5" id="text-h:821c3012-3e35-436e-b37c-d627e8869c91">
<div class="org-src-container">
<pre class="src src-sh">acl     image_service hdr_dom(host)     -i     img.me.com
<span style="color: #b22222;">#</span><span style="color: #b22222;">ACL&#21517;&#31216;&#65292;&#21487;&#20197;&#20351;&#29992;&#22823;&#23383;&#27597;A-Z&#12289;&#23567;&#20889;&#23383;&#27597;a-z&#12289;&#25968;&#23383;0-9&#12289;&#20882;&#21495;&#65306;&#12289;&#28857;.&#12289;&#20013;&#27178;&#32447;&#21644;&#19979;&#21010;&#32447;&#65292;&#24182;&#19988;&#20005;&#26684;&#21306;&#20998;&#22823;&#23567;&#20889;&#65292;&#27604;&#22914;:my_acl&#21644;My_Acl&#23601;&#26159;&#20004;&#20010;&#23436;&#20840;&#19981;&#21516;&#30340;acl</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d2df69a6-dac0-41e0-be12-fc4ecc2b1c02" class="outline-5">
<h5 id="h:d2df69a6-dac0-41e0-be12-fc4ecc2b1c02">5.8.1.2 ACL-criterion</h5>
<div class="outline-text-5" id="text-h:d2df69a6-dac0-41e0-be12-fc4ecc2b1c02">
<p>
定义ACL匹配规范，即：判断条件
</p>

<div class="org-src-container">
<pre class="src src-sh">hdr string&#65292;&#25552;&#21462;&#22312;&#19968;&#20010;HTTP&#35831;&#27714;&#25253;&#25991;&#30340;&#39318;&#37096;
hdr&#65288;[&lt;name&gt; [&#65292;&lt;occ&gt;]]&#65289;&#65306;&#23436;&#20840;&#21305;&#37197;&#23383;&#31526;&#20018;,header&#30340;&#25351;&#23450;&#20449;&#24687;&#65292;&lt;occ&gt; &#34920;&#31034;&#22312;&#22810;&#20540;&#20013;&#20351;&#29992;&#30340;&#20540;&#30340;&#20986;&#29616;&#27425;&#25968;
hdr_beg&#65288;[&lt;name&gt; [&#65292;&lt;occ&gt;]]&#65289;&#65306;&#21069;&#32512;&#21305;&#37197;&#65292;header&#20013;&#25351;&#23450;&#21305;&#37197;&#20869;&#23481;&#30340;begin
hdr_end&#65288;[&lt;name&gt; [&#65292;&lt;occ&gt;]]&#65289;&#65306;&#21518;&#32512;&#21305;&#37197;&#65292;header&#20013;&#25351;&#23450;&#21305;&#37197;&#20869;&#23481;end
hdr_dom&#65288;[&lt;name&gt; [&#65292;&lt;occ&gt;]]&#65289;&#65306;&#22495;&#21305;&#37197;&#65292;header&#20013;&#30340;domain name
hdr_dir&#65288;[&lt;name&gt; [&#65292;&lt;occ&gt;]]&#65289;&#65306;&#36335;&#24452;&#21305;&#37197;&#65292;header&#30340;uri&#36335;&#24452;
hdr_len&#65288;[&lt;name&gt; [&#65292;&lt;occ&gt;]]&#65289;&#65306;&#38271;&#24230;&#21305;&#37197;&#65292;header&#30340;&#38271;&#24230;&#21305;&#37197;
hdr_reg&#65288;[&lt;name&gt; [&#65292;&lt;occ&gt;]]&#65289;&#65306;&#27491;&#21017;&#34920;&#36798;&#24335;&#21305;&#37197;&#65292;&#33258;&#23450;&#20041;&#34920;&#36798;&#24335;(regex)&#27169;&#31946;&#21305;&#37197;
hdr_sub&#65288;[&lt;name&gt; [&#65292;&lt;occ&gt;]]&#65289;&#65306;&#23376;&#20018;&#21305;&#37197;&#65292;header&#20013;&#30340;uri&#27169;&#31946;&#21305;&#37197;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;</span>
<span style="color: #0000ff;">hdr</span>(&lt;string&gt;) &#29992;&#20110;&#27979;&#35797;&#35831;&#27714;&#22836;&#37096;&#39318;&#37096;&#25351;&#23450;&#20869;&#23481;
<span style="color: #0000ff;">hdr_dom</span>(host) &#35831;&#27714;&#30340;host&#21517;&#31216;&#65292;&#22914; www.me.com
<span style="color: #0000ff;">hdr_beg</span>(host) &#35831;&#27714;&#30340;host&#24320;&#22836;&#65292;&#22914; www.     img.     video.     download.     ftp.
<span style="color: #0000ff;">hdr_end</span>(host) &#35831;&#27714;&#30340;host&#32467;&#23614;&#65292;&#22914; .com     .net     .cn
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;</span>
acl bad_agent hdr_sub(User-Agent) -i curl wget
block if bad_agent

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26377;&#20123;&#21151;&#33021;&#26159;&#31867;&#20284;&#30340;&#65292;&#27604;&#22914;&#20197;&#19979;&#20960;&#20010;&#37117;&#26159;&#21305;&#37197;&#29992;&#25143;&#35831;&#27714;&#25253;&#25991;&#20013;host&#30340;&#24320;&#22836;&#26159;&#19981;&#26159;www</span>
acl short_form hdr_beg(host)             www.
acl alternate1 hdr_beg(host) -m beg www.
acl alternate2 hdr_dom(host) -m beg www.
acl alternate3 hdr(host)         -m beg www.
base : string

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#31532;&#19968;&#20010;&#20027;&#26426;&#22836;&#21644;&#35831;&#27714;&#30340;&#36335;&#24452;&#37096;&#20998;&#30340;&#36830;&#25509;&#65292;&#35813;&#35831;&#27714;&#20174;&#20027;&#26426;&#21517;&#24320;&#22987;&#65292;&#24182;&#22312;&#38382;&#21495;&#20043;&#21069;&#32467;&#26463;,&#23545;&#34394;&#25311;&#20027;&#26426;&#26377;&#29992;</span>
&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@#&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;<span style="color: #b22222;">#</span><span style="color: #b22222;">?&lt;query&gt;#&lt;frag&gt;</span>
    base         : exact string match
    base_beg : prefix match
    base_dir : subdir match
    base_dom : domain match
    base_end : suffix match
    base_len : length match
    base_reg : regex match
    base_sub : substring match
    path : string

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#21462;&#35831;&#27714;&#30340;URL&#36335;&#24452;&#65292;&#35813;&#36335;&#24452;&#20174;&#31532;&#19968;&#20010;&#26012;&#26464;&#24320;&#22987;&#65292;&#24182;&#22312;&#38382;&#21495;&#20043;&#21069;&#32467;&#26463;&#65288;&#26080;&#20027;&#26426;&#37096;&#20998;&#65289;</span>
&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;<span style="color: #b22222;">#</span><span style="color: #b22222;">/&lt;path&gt;;&lt;params&gt;#?&lt;query&gt;#&lt;frag&gt;</span>
    path         : exact string match
    path_beg : prefix match     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35831;&#27714;&#30340;URL&#24320;&#22836;&#65292;&#22914;/static&#12289;/images&#12289;/img&#12289;/css</span>
    path_end : suffix match     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35831;&#27714;&#30340;URL&#20013;&#36164;&#28304;&#30340;&#32467;&#23614;&#65292;&#22914; .gif .png .css .js .jpg .jpeg</span>
    path_dom : domain match
    path_dir : subdir match
    path_len : length match
    path_reg : regex match
    path_sub : substring match
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;</span>
    path_beg -i /haproxy-status/
    path_end .jpg .jpeg .png .gif
    path_reg ^/images.*<span style="color: #8b2252;">\.</span>jpeg$
    path_sub image 
    path_dir jpegs
    path_dom me

url : string
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#21462;&#35831;&#27714;&#20013;&#30340;&#25972;&#20010;URL&#12290;&#19968;&#20010;&#20856;&#22411;&#30340;&#24212;&#29992;&#26159;&#20855;&#26377;&#39044;&#21462;&#33021;&#21147;&#30340;&#32531;&#23384;&#65292;&#20197;&#21450;&#38656;&#35201;&#20174;&#25968;&#25454;&#24211;&#32858;&#21512;&#22810;&#20010;&#20449;&#24687;&#24182;&#23558;&#23427;&#20204;&#20445;&#23384;&#22312;&#32531;&#23384;&#20013;&#30340;&#32593;&#39029;&#38376;&#25143;&#20837;&#21475;&#65292;&#25512;&#33616;&#20351;&#29992;path</span>
    url &#65306;exact string match
    url_beg : prefix match
    url_dir : subdir match
    url_dom : domain match
    url_end : suffix match
    url_len : length match
    url_reg : regex match
    url_sub : substring match

dst <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#26631;IP</span>
dst_port <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#26631;PORT</span>
src     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28304;IP</span>
src_port <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28304;PORT</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;</span>
acl invalid_src src 10.0.0.7 192.168.1.0/24
acl invalid_src src 172.16.0.0/24
acl invalid_port src_port 0:1023
status : integer     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#22312;&#21709;&#24212;&#25253;&#25991;&#20013;&#30340;&#29366;&#24577;&#30721;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19971;&#23618;&#21327;&#35758;</span>
acl valid_method method GET HEAD
http-request deny if ! valid_method
</pre>
</div>
</div>
</div>
<div id="outline-container-h:98d66c19-a6fe-4d8e-bf07-17668645e14e" class="outline-5">
<h5 id="h:98d66c19-a6fe-4d8e-bf07-17668645e14e">5.8.1.3 ACL-flags</h5>
<div class="outline-text-5" id="text-h:98d66c19-a6fe-4d8e-bf07-17668645e14e">
<p>
ACL匹配模式
</p>

<div class="org-src-container">
<pre class="src src-sh">-i &#19981;&#21306;&#20998;&#22823;&#23567;&#20889;
-m &#20351;&#29992;&#25351;&#23450;&#30340;pattern&#21305;&#37197;&#26041;&#27861;
-n &#19981;&#20570;DNS&#35299;&#26512;
-u &#31105;&#27490;acl&#37325;&#21517;&#65292;&#21542;&#21017;&#22810;&#20010;&#21516;&#21517;ACL&#21305;&#37197;&#25110;&#20851;&#31995;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1f7fb87b-a32d-47fd-a509-539e729a301d" class="outline-5">
<h5 id="h:1f7fb87b-a32d-47fd-a509-539e729a301d">5.8.1.4 ACL-operator</h5>
<div class="outline-text-5" id="text-h:1f7fb87b-a32d-47fd-a509-539e729a301d">
<p>
ACL 操作符
</p>

<div class="org-src-container">
<pre class="src src-sh">&#25972;&#25968;&#27604;&#36739;&#65306;eq&#12289;ge&#12289;gt&#12289;le&#12289;lt
&#23383;&#31526;&#27604;&#36739;&#65306;
- exact match         (-m str) :&#23383;&#31526;&#20018;&#24517;&#39035;&#23436;&#20840;&#21305;&#37197;&#27169;&#24335;
- substring match (-m sub) :&#22312;&#25552;&#21462;&#30340;&#23383;&#31526;&#20018;&#20013;&#26597;&#25214;&#27169;&#24335;&#65292;&#22914;&#26524;&#20854;&#20013;&#20219;&#20309;&#19968;&#20010;&#34987;&#21457;&#29616;&#65292;ACL&#23558;&#21305;&#37197;
- prefix match     (-m beg) :&#22312;&#25552;&#21462;&#30340;&#23383;&#31526;&#20018;&#39318;&#37096;&#20013;&#26597;&#25214;&#27169;&#24335;&#65292;&#22914;&#26524;&#20854;&#20013;&#20219;&#20309;&#19968;&#20010;&#34987;&#21457;&#29616;&#65292;ACL&#23558;&#21305;&#37197;
- suffix match     (-m end) :&#23558;&#27169;&#24335;&#19982;&#25552;&#21462;&#23383;&#31526;&#20018;&#30340;&#23614;&#37096;&#36827;&#34892;&#27604;&#36739;&#65292;&#22914;&#26524;&#20854;&#20013;&#20219;&#20309;&#19968;&#20010;&#21305;&#37197;&#65292;&#21017;ACL&#36827;&#34892;&#21305;&#37197;
- subdir match     (-m dir) :&#26597;&#30475;&#25552;&#21462;&#20986;&#26469;&#30340;&#29992;&#26012;&#32447;&#20998;&#38548;&#65288;<span style="color: #8b2252;">"/"</span>&#65289;&#30340;&#23383;&#31526;&#20018;&#65292;&#22914;&#20854;&#20013;&#20219;&#19968;&#20010;&#21305;&#37197;&#65292;&#21017;ACL&#36827;&#34892;&#21305;&#37197;
- domain match     (-m dom) :&#26597;&#25214;&#25552;&#21462;&#30340;&#29992;&#28857;&#65288;<span style="color: #8b2252;">"."</span>&#65289;&#20998;&#38548;&#23383;&#31526;&#20018;&#65292;&#22914;&#26524;&#20854;&#20013;&#20219;&#20309;&#19968;&#20010;&#21305;&#37197;&#65292;&#21017;ACL&#36827;&#34892;&#21305;&#37197;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:963db83c-be03-49d3-a56b-2858037f9762" class="outline-5">
<h5 id="h:963db83c-be03-49d3-a56b-2858037f9762">5.8.1.5 ACL-value</h5>
<div class="outline-text-5" id="text-h:963db83c-be03-49d3-a56b-2858037f9762">
<p>
value的类型
</p>

<div class="org-src-container">
<pre class="src src-sh">The ACL engine can match these types against patterns of the following types :
- Boolean <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24067;&#23572;&#20540;</span>
- integer or integer range <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25972;&#25968;&#25110;&#25972;&#25968;&#33539;&#22260;&#65292;&#27604;&#22914;&#29992;&#20110;&#21305;&#37197;&#31471;&#21475;&#33539;&#22260;</span>
- IP address / network <span style="color: #b22222;">#</span><span style="color: #b22222;">IP&#22320;&#22336;&#25110;IP&#33539;&#22260;, 192.168.0.1 ,192.168.0.1/24</span>
- string--&gt; www.me.com
exact &#8211;&#31934;&#30830;&#27604;&#36739;
substring&#8212;&#23376;&#20018;
suffix-&#21518;&#32512;&#27604;&#36739;
prefix-&#21069;&#32512;&#27604;&#36739;
subdir-&#36335;&#24452;&#65292; /wp-includes/js/jquery/jquery.js
domain-&#22495;&#21517;&#65292;www.me.com
- regular expression <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27491;&#21017;&#34920;&#36798;&#24335;</span>
- hex block          <span style="color: #b22222;">#</span><span style="color: #b22222;">16&#36827;&#21046;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:cd90236b-7b8d-42b1-970e-0dbff68e9431" class="outline-4">
<h4 id="h:cd90236b-7b8d-42b1-970e-0dbff68e9431">5.8.2 多个ACL的组合调用方式</h4>
<div class="outline-text-4" id="text-h:cd90236b-7b8d-42b1-970e-0dbff68e9431">
<p>
<b>多个ACL的逻辑处理</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">&#19982;&#65306;&#38544;&#24335;&#65288;&#40664;&#35748;&#65289;&#20351;&#29992;
&#25110;&#65306;&#20351;&#29992;<span style="color: #8b2252;">"or"</span> &#25110; <span style="color: #8b2252;">"||"</span>&#34920;&#31034;
&#21542;&#23450;&#65306;&#20351;&#29992; <span style="color: #8b2252;">"!"</span> &#34920;&#31034;
</pre>
</div>

<p>
<b>多个ACL调用方式：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;</span>
<span style="color: #a020f0;">if</span> valid_src valid_port <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19982;&#20851;&#31995;&#65292;ACL&#20013;A&#21644;B&#37117;&#35201;&#28385;&#36275;&#20026;true&#65292;&#40664;&#35748;&#20026;&#19982;</span>
<span style="color: #a020f0;">if</span> invalid_src || invalid_port     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#65292;ACL&#20013;A&#25110;&#32773;B&#28385;&#36275;&#19968;&#20010;&#20026;true</span>
<span style="color: #a020f0;">if</span> ! invalid_src <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38750;&#65292;&#21462;&#21453;&#65292;&#19981;&#28385;&#36275;ACL&#25165;&#20026;true</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:163bcbd4-167b-4fa9-b185-ce0bdb6fc841" class="outline-4">
<h4 id="h:163bcbd4-167b-4fa9-b185-ce0bdb6fc841">5.8.3 ACL示例-域名匹配</h4>
<div class="outline-text-4" id="text-h:163bcbd4-167b-4fa9-b185-ce0bdb6fc841">
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#cat /etc/haproxy/conf.d/test.cfg
frontend me_http_port
    <span style="color: #483d8b;">bind</span> 10.0.0.7:80
    mode http
    balance roundrobin
    log global
    option httplog
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl setting ###############################</span>
    acl pc_domain hdr_dom(host)             -i www.me.org
    acl mobile_domain hdr_dom(host)     -i mobile.me.org
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl hosts #################################</span>
    use_backend pc_hosts     if     pc_domain
    use_backend mobile_hosts         if     mobile_domain
    default_backend pc_hosts     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;ACL&#37117;&#19981;&#21305;&#37197;,&#21017;&#20351;&#29992;&#30340;&#40664;&#35748;backend</span>
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">backend hosts #############################</span>
backend mobile_hosts
    mode http
    server web1 10.0.0.17 check inter 2000 fall 3 rise 5
backend pc_hosts
    mode http
    server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5
</pre>
</div>

<p>
测试结果：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#cat /etc/hosts
127.0.0.1     localhost localhost.localdomain localhost4 localhost4.localdomain4
centos6.localdomain
::1                 localhost localhost.localdomain localhost6 localhost6.localdomain6
10.0.0.7 mobile.me.org www.me.org me.org
[root@centos6 ~]#curl www.me.org
10.0.0.27
[root@centos6 ~]#curl mobile.me.org
10.0.0.17
[root@centos6 ~]#curl me.org
10.0.0.27
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5693be9c-ca92-4fc6-b4a5-e07eef069cae" class="outline-4">
<h4 id="h:5693be9c-ca92-4fc6-b4a5-e07eef069cae">5.8.4 ACL示例-基于源IP或子网调度访问</h4>
<div class="outline-text-4" id="text-h:5693be9c-ca92-4fc6-b4a5-e07eef069cae">
<p>
将指定的源地址调度至指定的web服务器组。
</p>

<div class="org-src-container">
<pre class="src src-sh">root@centos7 ~]#cat /etc/haproxy/conf.d/test.cfg
frontend me_http_port
    <span style="color: #483d8b;">bind</span> 10.0.0.7:80
    mode http
    balance roundrobin
    log global
    option httplog
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl setting ###############################</span>
    acl pc_domain hdr_dom(host)             -i www.me.org
    acl mobile_domain hdr_dom(host)     -i mobile.me.org
    acl ip_range_test src 172.18.0.0/16 10.0.0.6         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110;&#28304;&#22320;&#22336;&#30340;ACL,&#23450;&#20041;&#22810;&#20010;ACL&#30340;&#39034;&#24207;&#26080;&#20851;</span>
    acl ip_range_test2 src 172.18.0.200
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl hosts #################################</span>
    use_backend pc_hosts                 if     ip_range_test     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25918;&#22312;&#21069;&#38754;&#30340;ACL&#35268;&#21017;&#20248;&#20808;&#29983;&#25928;,&#24341;&#29992;</span>
    ACL&#26102;,&#20005;&#26684;&#30340;ACL&#24212;&#25918;&#22312;&#21069;&#38754;
    use_backend pc_hosts                 if     pc_domain
    use_backend mobile_hosts         if     mobile_domain
    default_backend pc_hosts
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">backend hosts #############################</span>
backend mobile_hosts
    mode http
    server web1 10.0.0.17 check inter 2000 fall 3 rise 5
backend pc_hosts
    mode http
    server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5
</pre>
</div>

<p>
测试结果
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#hostname -I
10.0.0.6
[root@centos6 ~]#curl www.me.org
10.0.0.27
[root@internet ~]#curl -H <span style="color: #8b2252;">"HOST: www.me.org"</span> 10.0.0.7
10.0.0.27
[root@centos6 ~]#curl mobile.me.org
10.0.0.27
[root@centos6 ~]#curl me.org
10.0.0.27
[root@centos8 ~]#curl mobile.me.org
10.0.0.17
[root@centos8 ~]#curl www.me.org
10.0.0.27
[root@centos8 ~]#curl me.org
10.0.0.27
</pre>
</div>
</div>
</div>
<div id="outline-container-h:988942cf-9cf8-42bc-929a-f018d300680d" class="outline-4">
<h4 id="h:988942cf-9cf8-42bc-929a-f018d300680d">5.8.5 ACL示例-基于源地址的访问控制</h4>
<div class="outline-text-4" id="text-h:988942cf-9cf8-42bc-929a-f018d300680d">

<figure id="org12faf9d">
<img src="images/image-20210225163149336.png" alt="image-20210225163149336.png">

</figure>

<p>
拒绝指定IP或者IP范围访问
</p>

<div class="org-src-container">
<pre class="src src-sh">listen web_host
    <span style="color: #483d8b;">bind</span> 10.0.0.7:80
    mode http
    balance roundrobin
    log global
    option httplog
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl setting ###############################</span>
    acl acl_deny_src src 10.0.0.6 192.168.0.0/24
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl hosts #################################</span>
    http-request deny     if acl_deny_src     <span style="color: #b22222;">#</span><span style="color: #b22222;">2.1&#29256;&#26412;&#21518;&#65292;&#19981;&#20877;&#25903;&#25345;block</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">block if acl_deny_src</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">http-request allow</span>
    default_backend default_web
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">backend hosts #############################</span>
backend me_host
    mode http
    server web1 10.0.0.17 check inter 2000 fall 3 rise 5
backend default_web
    mode http
    server web1 10.0.0.27:80 check inter 2000 fall 3 rise 5
</pre>
</div>

<p>
测试：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#curl www.me.org
&lt;html&gt;&lt;body&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;
Request forbidden by administrative rules.
&lt;/body&gt;&lt;/html&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ca5e9216-478f-4dad-9636-ad14bc18be3b" class="outline-4">
<h4 id="h:ca5e9216-478f-4dad-9636-ad14bc18be3b">5.8.6 ACL示例-匹配浏览器类型</h4>
<div class="outline-text-4" id="text-h:ca5e9216-478f-4dad-9636-ad14bc18be3b">
<p>
匹配客户端浏览器，将不同类型的浏览器调动至不同的服务器组 范例: 163
网易拒绝curl和wget的访问
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 ~]#curl -I www.163.com
HTTP/1.1 403 Forbidden
Date: Fri, 01 Jan 2021 06:57:22 GMT
Content-Type: text/html
Content-Length: 237
Connection: keep-alive
Server: web cache
Expires: Fri, 01 Jan 2021 06:57:22 GMT
X-Ser: BC17_lt-shandong-zaozhuang-6-cache-1
Cache-Control: no-cache,no-store,private
cdn-user-ip: 111.199.184.218
cdn-ip: 124.132.138.17
X-Cache-Remote: HIT
cdn-source: baishan
[root@ubuntu2004 ~]#curl -I -A <span style="color: #8b2252;">"wget"</span> www.163.com
HTTP/1.1 403 Forbidden
Date: Fri, 01 Jan 2021 06:58:13 GMT
Content-Type: text/html
Content-Length: 237
Connection: keep-alive
Server: web cache
Expires: Fri, 01 Jan 2021 06:58:13 GMT
X-Ser: BC17_lt-shandong-zaozhuang-6-cache-1
Cache-Control: no-cache,no-store,private
cdn-user-ip: 111.199.184.218
cdn-ip: 124.132.138.17
X-Cache-Remote: HIT
cdn-source: baishan

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#25298;&#32477;&#20854;&#23427;&#27983;&#35272;&#22120;&#30340;&#35775;&#38382;</span>
[root@ubuntu2004 ~]#curl -I -A <span style="color: #8b2252;">"ApacheBench"</span> www.163.com
HTTP/1.1 301 Moved Permanently
Date: Fri, 01 Jan 2021 06:58:41 GMT
Content-Length: 0
Connection: keep-alive
Server: web cache
Location: https://www.163.com/
Cache-Control: no-cache,no-store,private
cdn-user-ip: 111.199.184.218
cdn-ip: 124.132.138.11
X-Cache-Remote: MISS
cdn-source: baishan
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#cat /etc/haproxy/conf.d/test.cfg
frontend me_http_port
    <span style="color: #483d8b;">bind</span> 10.0.0.7:80
    mode http
    balance roundrobin
    log global
    option httplog
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl setting ###############################</span>
    acl acl_user_agent hdr_sub(User-Agent)     -i curl wget             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110;&#27983;&#35272;&#22120;&#30340;ACL</span>
    acl acl_user_agent_ab hdr_sub(User-Agent)     -i ApacheBench
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl hosts #################################</span>
    redirect prefix     http://www.baidu.com if acl_user_agent <span style="color: #b22222;">#</span><span style="color: #b22222;">302 &#20020;&#26102;&#37325;&#23450;&#21521;&#33267;&#26032;URL</span>
    http-request deny         if acl_user_agent_ab <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25298;&#32477;ab</span>
    default_backend pc_hosts
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">backend hosts #############################</span>
backend mobile_hosts
    mode http
    server web1 10.0.0.17 check inter 2000 fall 3 rise 5
backend pc_hosts
    mode http
    server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#curl -I 10.0.0.7
HTTP/1.1 302 Found
content-length: 0
location: http://10.0.0.8/
cache-control: no-cache
[root@centos6 ~]#curl -L 10.0.0.7
10.0.0.8
[root@centos6 ~]#wget -O - -q http://10.0.0.7
10.0.0.8
[root@centos6 ~]#curl -A chrome http://10.0.0.7
10.0.0.27
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27169;&#25311;ab</span>
[root@centos6 ~]#curl -A ApacheBench 10.0.0.7
&lt;html&gt;&lt;body&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;
Request forbidden by administrative rules.
&lt;/body&gt;&lt;/html&gt;
[root@centos6 ~]#ab -n1 -c 1 http://10.0.0.7/
This is ApacheBench, Version 2.3 &lt;$<span style="color: #a0522d;">Revision</span>: 655654 $&gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/
Benchmarking 10.0.0.7 (be patient).....done
Server Software:             
Server Hostname:                 10.0.0.7
Server Port:                         80
Document Path:                 /
Document Length:                 93 bytes
Concurrency Level:             1
Time taken for tests:     0.001 seconds
Complete requests:             1
Failed requests:                 0
Write errors:                     0
Non-2xx responses:             1         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#31034;&#20986;&#29616;&#38750;200&#30340;&#21709;&#24212;</span>
Total transferred:             208 bytes
HTML transferred:             93 bytes
Requests per second:         939.85 [#/sec] (mean)
Time per request:             1.064 [ms] (mean)
Time per request:             1.064 [ms] (mean, across all concurrent requests)
Transfer rate:                     190.91 [Kbytes/sec] received
Connection Times (ms)
                        min mean[+/-sd] median     max
Connect:                 1         1     0.0             1             1
Processing:         1         1     0.0             1             1
Waiting:                 0         0     0.0             0             0
Total:                     1         1     0.0             1             1
<span style="color: #b22222;">#</span><span style="color: #b22222;">haproxy&#26085;&#24535;&#25552;&#31034;403</span>
[root@centos7 ~]#tail /var/log/haproxy.log
Apr     4 08:16:29 localhost haproxy[1483]: 10.0.0.6:56470
[04/Apr/2020:08:16:29.977] me_http_port me_http_port/&lt;NOSRV&gt;
0/-1/-1/-1/0 403 212 - - PR-- 1/1/0/0/0 0/0 <span style="color: #8b2252;">"GET / HTTP/1.1"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:239e5338-ef07-474d-b12e-067b40874dfc" class="outline-4">
<h4 id="h:239e5338-ef07-474d-b12e-067b40874dfc">5.8.7 ACL示例-基于文件后缀名实现动静分离</h4>
<div class="outline-text-4" id="text-h:239e5338-ef07-474d-b12e-067b40874dfc">
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#cat /etc/haproxy/conf.d/test.cfg
frontend me_http_port
    <span style="color: #483d8b;">bind</span> 10.0.0.7:80
    mode http
    balance roundrobin
    log global
    option httplog
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl setting ###############################</span>
    acl acl_static path_end -i .jpg .jpeg .png .gif .css .js .html     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110;&#25991;&#20214;&#21518;&#32512;&#21517;&#30340;ACL</span>
    acl acl_php     path_end -i .php
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl hosts #################################</span>
    use_backend mobile_hosts if acl_static
    use_backend app_hosts if acl_php
    default_backend pc_hosts
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">backend hosts #############################</span>
backend mobile_hosts
    mode http
    server web1 10.0.0.17 check inter 2000 fall 3 rise 5
backend pc_hosts
    mode http
    server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5
backend app_hosts
    mode http
    server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#21035;&#22312;&#21518;&#31471;&#20004;&#21488;&#20027;&#26426;&#20934;&#22791;&#30456;&#20851;&#25991;&#20214;</span>
[root@centos17 ~]#ls /var/www/html
index.html wang.jpg
[root@centos27 ~]#cat /var/www/html/test.php
&lt;?php
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&lt;h1&gt;http://10.0.0.27/test.php&lt;/h1&gt;\n"</span>;
?&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:56b95b39-a38b-4bf8-b869-e75feb02c71f" class="outline-4">
<h4 id="h:56b95b39-a38b-4bf8-b869-e75feb02c71f">5.8.8 ACL-匹配访问路径实现动静分离</h4>
<div class="outline-text-4" id="text-h:56b95b39-a38b-4bf8-b869-e75feb02c71f">
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#cat /etc/haproxy/conf.d/test.cfg
frontend me_http_port
    <span style="color: #483d8b;">bind</span> 10.0.0.7:80
    mode http
    balance roundrobin
    log global
    option httplog
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl setting ###############################</span>
    acl acl_static path_beg     -i /static /images /javascript                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110;&#36335;&#24452;&#30340;ACL</span>
    acl acl_static path_end     -i .jpg .jpeg .png .gif .css .js .html .htm     <span style="color: #b22222;">#</span><span style="color: #b22222;">ACL&#21516;&#21517;&#20026;&#25110;&#20851;&#31995;</span>
    acl acl_app path_beg     -i /api
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl hosts #################################</span>
    use_backend static_hosts if acl_static
    use_backend app_hosts     if acl_app
    default_backend app_hosts
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">backend hosts #############################</span>
backend static_hosts
    mode http
    server web1 10.0.0.17 check inter 2000 fall 3 rise 5
backend app_hosts
    mode http
    server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#30456;&#20851;&#25991;&#20214;</span>
[root@centos17 ~]#mkdir /var/www/html/static
[root@centos17 ~]#echo 10.0.0.17 &gt; /var/www/html/static/test.html
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;&#35775;&#38382;</span>
[root@centos6 ~]#curl 10.0.0.7/static/test.html
10.0.0.17
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3b950ada-b5d9-4a76-8784-516f92e49b94" class="outline-4">
<h4 id="h:3b950ada-b5d9-4a76-8784-516f92e49b94">5.8.9 ACL示例-预定义ACL使用</h4>
<div class="outline-text-4" id="text-h:3b950ada-b5d9-4a76-8784-516f92e49b94">
<p>
官方帮助文档：<a href="http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#7.4">http://cbonte.github.io/haproxy-dconv/2.1/configuration.html#7.4</a>
</p>
</div>
<div id="outline-container-h:ac649876-0efb-4f5e-9d2f-1d127725de39" class="outline-5">
<h5 id="h:ac649876-0efb-4f5e-9d2f-1d127725de39">5.8.9.1 预定义ACL</h5>
<div class="outline-text-5" id="text-h:ac649876-0efb-4f5e-9d2f-1d127725de39">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">ACL</th>
<th scope="col" class="org-left">name</th>
<th scope="col" class="org-left">Equivalent to Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">FALSE</td>
<td class="org-left">always_false</td>
<td class="org-left">never match</td>
</tr>

<tr>
<td class="org-left">HTTP</td>
<td class="org-left">req_proto_http</td>
<td class="org-left">match if protocol is valid HTTP</td>
</tr>

<tr>
<td class="org-left">HTTP_1.0</td>
<td class="org-left">req_ver 1.0</td>
<td class="org-left">match HTTP version 1.0</td>
</tr>

<tr>
<td class="org-left">HTTP_1.1</td>
<td class="org-left">req_ver 1.1</td>
<td class="org-left">match HTTP version 1.1</td>
</tr>

<tr>
<td class="org-left">HTTP_CONTENT</td>
<td class="org-left">hdr_val(content-length) gt 0</td>
<td class="org-left">match an existing content-length</td>
</tr>

<tr>
<td class="org-left">HTTP_URL_ABS</td>
<td class="org-left">url_reg://</td>
<td class="org-left">match absolute URL with scheme</td>
</tr>

<tr>
<td class="org-left">HTTP_URL_SLASH</td>
<td class="org-left">url_beg /</td>
<td class="org-left">match URL beginning with "/"</td>
</tr>

<tr>
<td class="org-left">HTTP_URL_STAR</td>
<td class="org-left">url *</td>
<td class="org-left">match URL equal to “*”</td>
</tr>

<tr>
<td class="org-left">LOCALHOST</td>
<td class="org-left">src 127.0.0.1/8</td>
<td class="org-left">match connection from local host</td>
</tr>

<tr>
<td class="org-left">METH_CONNECT</td>
<td class="org-left">method CONNECT</td>
<td class="org-left">match HTTP CONNECT method</td>
</tr>

<tr>
<td class="org-left">METH_DELETE</td>
<td class="org-left">method DELETE</td>
<td class="org-left">match HTTP DELETE method</td>
</tr>

<tr>
<td class="org-left">METH_GET</td>
<td class="org-left">method GET HEAD</td>
<td class="org-left">match HTTP GET or HEAD method</td>
</tr>

<tr>
<td class="org-left">METH_HEAD</td>
<td class="org-left">method HEAD</td>
<td class="org-left">match HTTP HEAD method</td>
</tr>

<tr>
<td class="org-left">METH_OPTIONS</td>
<td class="org-left">method OPTIONS</td>
<td class="org-left">match HTTP OPTIONS method</td>
</tr>

<tr>
<td class="org-left">METH_POST</td>
<td class="org-left">method POST</td>
<td class="org-left">match HTTP POST method</td>
</tr>

<tr>
<td class="org-left">METH_PUT</td>
<td class="org-left">method PUT</td>
<td class="org-left">match HTTP PUT method</td>
</tr>

<tr>
<td class="org-left">METH_TRACE</td>
<td class="org-left">method TRACE</td>
<td class="org-left">match HTTP TRACE method</td>
</tr>

<tr>
<td class="org-left">RDP_COOKIE</td>
<td class="org-left">req_rdp_cookie_cnt gt 0</td>
<td class="org-left">match presence of an RDP cookie</td>
</tr>

<tr>
<td class="org-left">REQ_CONTENT</td>
<td class="org-left">req_len gt 0</td>
<td class="org-left">match data in the request buffer</td>
</tr>

<tr>
<td class="org-left">TRUE</td>
<td class="org-left">always_true</td>
<td class="org-left">always match</td>
</tr>

<tr>
<td class="org-left">WAIT_END</td>
<td class="org-left">wait_end</td>
<td class="org-left">wait for end of content analysis</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:e0f9003e-ba69-42d9-8aec-dc61f61a616f" class="outline-5">
<h5 id="h:e0f9003e-ba69-42d9-8aec-dc61f61a616f">5.8.9.2 预定义ACL使用</h5>
<div class="outline-text-5" id="text-h:e0f9003e-ba69-42d9-8aec-dc61f61a616f">
<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#curl -I -XTRACE 10.0.0.7/static/test.html
HTTP/1.1 200 OK
date: Sat, 04 Apr 2020 02:04:01 GMT
server: Apache/2.4.6 (CentOS) PHP/5.4.16
transfer-encoding: chunked
content-type: message/http

[root@centos7 ~]#cat /etc/haproxy/conf.d/test.cfg
frontend me_http_port
    <span style="color: #483d8b;">bind</span> 10.0.0.7:80
    mode http
    balance roundrobin
    log global
    option httplog
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl setting ###############################</span>
    acl acl_static_path path_beg     -i /static /images /javascript
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl hosts #################################</span>
    use_backend static_path_hosts if acl_static_path
    http-request deny if METH_TRACE HTTP_1.1     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24341;&#29992;&#39044;&#23450;&#20041;&#30340;ACL&#65292;&#22810;&#20010;ACL&#40664;&#35748;&#20026;&#19982;&#20851;&#31995;</span>
    default_backend pc_hosts
<span style="color: #b22222;">################### </span><span style="color: #b22222;">backend hosts ################################</span>
backend static_path_hosts
    mode http
    server web1 10.0.0.17 check inter 2000 fall 3 rise 5
backend mobile_hosts
    mode http
    server web1 10.0.0.17 check inter 2000 fall 3 rise 5
backend pc_hosts
    mode http
    server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5

[root@centos6 ~]#curl -I -XTRACE 10.0.0.7/static/test.html
HTTP/1.1 403 Forbidden
content-length: 93
cache-control: no-cache
content-type: text/html
connection: close
[root@centos6 ~]#curl -I -0 -XTRACE 10.0.0.7/static/test.html
HTTP/1.1 200 OK
date: Sat, 04 Apr 2020 02:10:13 GMT
server: Apache/2.4.6 (CentOS) PHP/5.4.16
content-type: message/http
connection: close

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26085;&#24535;&#65292;&#35266;&#23519;&#21327;&#35758;&#29256;&#26412;</span>
[root@centos17 ~]#tail /var/log/httpd/access_log
10.0.0.7 - - [04/Apr/2020:10:11:41 +0800] <span style="color: #8b2252;">"TRACE /static/test.html HTTP/1.0"</span> 200
230 <span style="color: #8b2252;">"-"</span> <span style="color: #8b2252;">"curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1</span>
<span style="color: #8b2252;">zlib/1.2.3 libidn/1.18 libssh2/1.4.2"</span>
[root@centos6 ~]#curl -i 10.0.0.7/static/test.html
HTTP/1.1 200 OK
date: Sat, 04 Apr 2020 02:07:58 GMT
server: Apache/2.4.6 (CentOS) PHP/5.4.16
last-modified: Sat, 04 Apr 2020 01:27:45 GMT
etag: <span style="color: #8b2252;">"a-5a26cf0ed4913"</span>
accept-ranges: bytes
content-length: 10
content-type: text/html; <span style="color: #a0522d;">charset</span>=UTF-8
10.0.0.17
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:b7952a00-9159-41d8-bc68-ec58322bb5f1" class="outline-3">
<h3 id="h:b7952a00-9159-41d8-bc68-ec58322bb5f1">5.9 自定义HAProxy 错误界面</h3>
<div class="outline-text-3" id="text-h:b7952a00-9159-41d8-bc68-ec58322bb5f1">
<p>
对指定的报错进行重定向，进行优雅的显示错误页面
使用errorfile和errorloc指令的两种方法，可以实现自定义各种错误页面
默认情况下，所有后端服务器都down机后，会显示下面页面
</p>
</div>
<div id="outline-container-h:e290df72-d19b-4eee-a31e-e61c1238b6bf" class="outline-5">
<h5 id="h:e290df72-d19b-4eee-a31e-e61c1238b6bf">5.9.1 基于自定义的错误页面文件</h5>
<div class="outline-text-5" id="text-h:e290df72-d19b-4eee-a31e-e61c1238b6bf">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#23450;&#20041;&#38169;&#35823;&#39029;</span>
errorfile &lt;code&gt; &lt;file&gt;
&lt;code&gt; <span style="color: #b22222;">#</span><span style="color: #b22222;">HTTP status code.&#25903;&#25345;200, 400, 403, 405, 408, 425, 429, 500, 502&#65292;503,504</span>
&lt;file&gt; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21253;&#21547;&#23436;&#25972;HTTP&#21709;&#24212;&#22836;&#30340;&#38169;&#35823;&#39029;&#25991;&#20214;&#30340;&#32477;&#23545;&#36335;&#24452;&#12290; &#24314;&#35758;&#21518;&#32512;".http"&#65292;&#20197;&#21644;&#19968;&#33324;&#30340;html&#25991;&#20214;&#30456;&#21306;&#20998;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;</span>
errorfile 400 /etc/haproxy/errorfiles/400badreq.http
errorfile 403 /etc/haproxy/errorfiles/403forbid.http
errorfile 503 /etc/haproxy/errorfiles/503sorry.http
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">defaults
<span style="color: #b22222;">#</span><span style="color: #b22222;">option forwardfor</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">no option http-use-htx &#25903;&#25345;html&#25991;&#20214;,&#27492;&#35774;&#32622;&#21644;&#29256;&#26412;&#26377;&#20851;&#65292;2.1&#19981;&#25903;&#25345;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">......</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#19979;&#38754;&#34892;</span>
errorfile 500 /usr/local/haproxy/html/500.http
errorfile 502 /usr/local/haproxy/html/502.http
errorfile 503 /usr/local/haproxy/html/503.http
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#vim /etc/haproxy/haproxy.cfg
defaults
option http-keep-alive
option forwardfor
maxconn 100000
mode http
timeout connect 300000ms
timeout client 300000ms
timeout server 300000ms
errorfile 503 /apps/haproxy/html/503.http 
listen
.......
[root@centos7 ~]#vim /apps/haproxy/html/503.http
HTTP/1.1 503 Service Unavailable
Content-Type:text/html;<span style="color: #a0522d;">charset</span>=utf-8
&lt;!DOCTYPE html&gt;
&lt;html <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
&lt;head&gt;
&lt;meta <span style="color: #a0522d;">charset</span>=<span style="color: #8b2252;">"UTF-8"</span>&gt;
&lt;title&gt;&#25253;&#38169;&#39029;&#38754;&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;&#32593;&#31449;&#32500;&#25252;&#20013;......&#35831;&#31245;&#20505;&#20877;&#35797;&lt;/h1&gt;&lt;/center&gt;
&lt;center&gt;&lt;h2&gt;&#32852;&#31995;&#30005;&#35805;&#65306;400-123-4567&lt;/h2&gt;&lt;/center&gt;
&lt;center&gt;&lt;h3&gt;503 Service Unavailable&lt;/h3&gt;&lt;/center&gt;
&lt;/body&gt;
[root@centos7 ~]#systemctl restart haproxy
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#21518;&#31471;&#26381;&#21153;&#22120;down&#65292;&#21487;&#20197;&#35266;&#23519;&#21040;&#20197;&#19979;&#39029;&#38754;</span>
</pre>
</div>

<p>
范例：启用no option http-use-htx
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@haproxy ~]#vi /etc/haproxy/haproxy.cfg
defaults
    option http-keep-alive
    no option http-use-htx     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;defaults &#22359;&#20013;&#28155;&#21152;</span>
    errorfile 503 /apps/haproxy/errorfiles/503.html 
[root@haproxy ~]#cat /apps/haproxy/errorfiles/503.html
&lt;!DOCTYPE html&gt;
&lt;html <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
&lt;head&gt;
&lt;meta <span style="color: #a0522d;">charset</span>=<span style="color: #8b2252;">"UTF-8"</span>&gt;
&lt;title&gt;&#25253;&#38169;&#39029;&#38754;&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;&#32593;&#31449;&#32500;&#25252;&#20013;......&#35831;&#31245;&#20399;&#20877;&#35797;&lt;/h1&gt;&lt;/center&gt;
&lt;center&gt;&lt;h2&gt;&#32852;&#31995;&#30005;&#35805;&#65306;400-123-8888&lt;/h2&gt;&lt;/center&gt;
&lt;center&gt;&lt;h3&gt;503 Service Unavailable&lt;/h3&gt;&lt;/center&gt;
&lt;/body&gt;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#27809;&#26377;&#21709;&#24212;&#22836;&#20449;&#24687;</span>
[root@internet ~]#curl -I 172.16.0.100
&lt;!DOCTYPE html&gt;
&lt;html <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
&lt;head&gt;
&lt;meta <span style="color: #a0522d;">charset</span>=<span style="color: #8b2252;">"UTF-8"</span>&gt;
&lt;title&gt;&#25253;&#38169;&#39029;&#38754;&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;&#32593;&#31449;&#32500;&#25252;&#20013;......&#35831;&#31245;&#20399;&#20877;&#35797;&lt;/h1&gt;&lt;/center&gt;
&lt;center&gt;&lt;h2&gt;&#32852;&#31995;&#30005;&#35805;&#65306;400-123-8888&lt;/h2&gt;&lt;/center&gt;
&lt;center&gt;&lt;h3&gt;503 Service Unavailable&lt;/h3&gt;&lt;/center&gt;
&lt;/body&gt;
<span style="color: #b22222;">#</span><span style="color: #b22222;">ubuntu&#30340;&#23458;&#25143;&#31471;&#25552;&#31034;&#38169;&#35823;</span>
root@ubuntu2004:~# curl     172.16.0.100
curl: (1) Received HTTP/0.9 when not allowed
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f52bd87e-7b0d-4bc4-8e06-f498d03861dc" class="outline-4">
<h4 id="h:f52bd87e-7b0d-4bc4-8e06-f498d03861dc">5.9.2 基于http重定向错误页面</h4>
<div class="outline-text-4" id="text-h:f52bd87e-7b0d-4bc4-8e06-f498d03861dc">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#38169;&#35823;&#39029;&#38754;&#37325;&#23450;&#21521;</span>
errorloc &lt;code&gt; &lt;url&gt;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#24403;&#20110;errorloc302 &lt;code&gt; &lt;url&gt;&#65292;&#21033;&#29992;302&#37325;&#23450;&#21521;&#33267;&#25351;URL</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;</span>
errorloc 503 http://www.me.com/error_pages/503.html
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#vim /etc/haproxy/haproxy.cfg
defaults
<span style="color: #b22222;">#</span><span style="color: #b22222;">option http-keep-alive</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">option forwardfor</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">no option http-use-htx</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">...... &#21152;&#20197;&#19979;&#19968;&#34892;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">errorfile 503 /apps/haproxy/html/503.http</span>
errorloc 503 http://10.0.0.8/error_page/503.html
[root@centos8 ~]#cat /var/www/html/error_page/503.html
&lt;!DOCTYPE html&gt;
&lt;html <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
&lt;head&gt;
&lt;title&gt;&#25253;&#38169;&#39029;&#38754;&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;&#32593;&#31449;&#32500;&#25252;&#20013;......&#35831;&#31245;&#20399;&#20877;&#35797;&lt;/h1&gt;&lt;/center&gt;
&lt;center&gt;&lt;h2&gt;&#32852;&#31995;&#30005;&#35805;&#65306;400-123-4567&lt;/h2&gt;&lt;/center&gt;
&lt;center&gt;&lt;h3&gt;503 Service Unavailable&lt;/h3&gt;&lt;/center&gt;
&lt;/body&gt;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27983;&#35272;&#22120;&#35775;&#38382;http://haproxy/ 302&#33258;&#21160;&#36339;&#36716;&#33267;&#19979;&#38754;&#39029;&#38754;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:7751fe05-33ba-4463-a2e6-248f9a34c2bb" class="outline-3">
<h3 id="h:7751fe05-33ba-4463-a2e6-248f9a34c2bb">5.10 HAProxy 四层负载</h3>
<div class="outline-text-3" id="text-h:7751fe05-33ba-4463-a2e6-248f9a34c2bb">
<p>
针对除HTTP以外的TCP协议应用服务访问的应用场景
</p>

<div class="org-src-container">
<pre class="src src-sh">MySQL
Redis
Memcache
RabbitMQ
</pre>
</div>

<p>
问题: 后端服务器和haproxy还是和客户端建立三次握手?
</p>
</div>
<div id="outline-container-h:23a97e87-29a9-4079-831e-4ef39cea1f03" class="outline-4">
<h4 id="h:23a97e87-29a9-4079-831e-4ef39cea1f03">5.10.1 四层负载示例</h4>
<div class="outline-text-4" id="text-h:23a97e87-29a9-4079-831e-4ef39cea1f03">
<p>
注意：如果使用frontend和backend，一定在 frontend 和 backend
段中都指定mode tcp
</p>

<div class="org-src-container">
<pre class="src src-sh">listen redis-port
    <span style="color: #483d8b;">bind</span> 10.0.0.7:6379
    mode tcp
    balance leastconn
    server server1 10.0.0.17:6379 check
    server server2 10.0.0.27:6379 check backup
</pre>
</div>

<p>
范例：对 MySQL 服务实现四层负载
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#vim /etc/haproxy/haproxy.cfg
listen me_mysql
    <span style="color: #483d8b;">bind</span> 10.0.0.7:3306
    mode tcp
    balance leastconn
    server mysql1 10.0.0.17:3306 check 
    server mysql2 10.0.0.27:3306 check                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#19981;&#20889;&#31471;&#21475;&#21495;&#65292;&#21487;&#20197;&#36716;&#21457;&#65292;&#20294;&#26080;&#27861;check&#29366;&#24577;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#20351;&#29992;frontend&#21644;backend&#23454;&#29616;</span>
frontend mysql
    <span style="color: #483d8b;">bind</span> :3306
    mode tcp     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24517;&#39035;&#25351;&#23450;tcp&#27169;&#24335;</span>
    default_backend mysqlsrvs
backend mysqlsrvs
    mode tcp <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24517;&#39035;&#25351;&#23450;tcp&#27169;&#24335;</span>
    balance leastconn
    server mysql1 10.0.0.17:3306
    server mysql2 10.0.0.27:3306
[root@centos7 ~]#systemctl restart haproxy
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#21518;&#31471;&#26381;&#21153;&#22120;&#23433;&#35013;&#21644;&#37197;&#32622;mariadb&#26381;&#21153;</span>
[root@centos7 ~]#yum -y install mariadb-server
[root@centos7 ~]#mysql -e <span style="color: #8b2252;">"grant all on *.* to test@'10.0.0.%' identified by'123456'"</span>
[root@centos7 ~]#vim /etc/my.cnf
[mysqld]
server-id=17 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#21478;&#19968;&#21488;&#20027;&#26426;&#20026;27</span>
[root@centos7 ~]#systemctl start mariadb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;</span>
[root@centos6 ~]#mysql -utest -p123456 -e <span style="color: #8b2252;">"show variables like 'hostname'"</span>
+---------------+--------------------------+
| Variable_name | Value                                     |
+---------------+--------------------------+
| hostname         | centos17.cici.com |
+---------------+--------------------------+
[root@centos6 ~]#mysql -utest -p123456 -e <span style="color: #8b2252;">"show variables like 'hostname'"</span>
+---------------+--------------------------+
| Variable_name | Value                                     |
+---------------+--------------------------+
| hostname         | centos27.cici.com |
+---------------+--------------------------+
[root@centos6 ~]#mysql -utest -p123456 -h10.0.0.7 -e <span style="color: #8b2252;">'select @@server_id'</span>
+-------------+
| @@server_id |
+-------------+
|                     17 |
+-------------+
[root@centos6 ~]#mysql -utest -p123456 -h10.0.0.7 -e <span style="color: #8b2252;">'select @@server_id'</span>
+-------------+
| @@server_id |
+-------------+
|                     27 |
+-------------+
</pre>
</div>


<figure id="orgd8bf750">
<img src="images/image-20210225163245575.png" alt="image-20210225163245575.png">

</figure>
</div>
</div>
<div id="outline-container-h:381feae0-b9f0-42e2-847f-51ed9bf66fce" class="outline-4">
<h4 id="h:381feae0-b9f0-42e2-847f-51ed9bf66fce">5.10.2 ACL示例-四层访问控制</h4>
<div class="outline-text-4" id="text-h:381feae0-b9f0-42e2-847f-51ed9bf66fce">
<div class="org-src-container">
<pre class="src src-sh">frontend web_host
    <span style="color: #483d8b;">bind</span> 10.0.0.7:80
    mode http
    balance roundrobin
    log global
    option httplog
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl setting ############################### </span>
    acl static_path path_beg     -i /static /images /javascript
    acl invalid_src src 192.168.1.0/24 10.0.0.8
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl hosts #################################</span>
    use_backend static_path_host if HTTP_1.1 TRUE static_path
    tcp-request connection reject if invalid_src         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22235;&#23618;ACL&#25511;&#21046; </span>
    default_backend default_web
<span style="color: #b22222;">################### </span><span style="color: #b22222;">backend hosts ################################</span>
backend php_server_host
    mode http
    server web1 10.0.0.17 check inter 2000 fall 3 rise 5
backend static_path_host
    mode http
    server web1 10.0.0.27 check inter 2000 fall 3 rise 5
backend default_web
    mode http
    server web1 10.0.0.37:80 check inter 2000 fall 3 rise 5
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:558e5944-e36f-44ee-bfea-f01553131c02" class="outline-3">
<h3 id="h:558e5944-e36f-44ee-bfea-f01553131c02">5.11 HAProxy https 实现</h3>
<div class="outline-text-3" id="text-h:558e5944-e36f-44ee-bfea-f01553131c02">
<p>
haproxy可以实现https的证书安全,但基于性能考虑,生产中证书都是在后端服务器比如nginx上实现
从用户到haproxy为https,从happroxy到后端服务器用http通信
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;HAProxy&#25903;&#25345;https&#21327;&#35758;&#65292;&#25903;&#25345;ssl&#20250;&#35805;&#65307;</span>
<span style="color: #483d8b;">bind</span> *:443 ssl crt /PATH/TO/SOME_PEM_FILE

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#20196; crt &#21518;&#35777;&#20070;&#25991;&#20214;&#20026;PEM&#26684;&#24335;&#65292;&#38656;&#35201;&#21516;&#26102;&#21253;&#21547;&#35777;&#20070;&#21644;&#25152;&#26377;&#31169;&#38053;</span>
cat demo.key demo.crt &gt; demo.pem

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25226;80&#31471;&#21475;&#30340;&#35831;&#27714;&#37325;&#21521;&#23450;443</span>
<span style="color: #483d8b;">bind</span> *:80
redirect scheme https if !{ ssl_fc }

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21521;&#21518;&#31471;&#20256;&#36882;&#29992;&#25143;&#35831;&#27714;&#30340;&#21327;&#35758;&#21644;&#31471;&#21475;&#65288;frontend&#25110;backend&#65289;</span>
http_request set-header X-Forwarded-Port %[dst_port]
http_request add-header X-Forwared-Proto https if { ssl_fc }
</pre>
</div>
</div>
<div id="outline-container-h:a269de3c-45eb-47a2-941b-6a89a2df6df1" class="outline-4">
<h4 id="h:a269de3c-45eb-47a2-941b-6a89a2df6df1">5.11.1 证书制作</h4>
<div class="outline-text-4" id="text-h:a269de3c-45eb-47a2-941b-6a89a2df6df1">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1</span>
[root@centos7 ~]mkdir /etc/haproxy/certs/
[root@centos7 ~]cd /etc/haproxy/certs/
[root@centos7 certs]#openssl genrsa -out haproxy.key 2048
[root@centos7 certs]#openssl req -new -x509 -key haproxy.key -out haproxy.crt -subj <span style="color: #8b2252;">"/CN=www.me.org"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#29992;&#19979;&#19968;&#26465;&#21629;&#20196;&#23454;&#29616;</span>
[root@centos7 certs]#openssl req -x509 -newkey rsa:2048 -subj
<span style="color: #8b2252;">"/CN=www.me.org"</span> -keyout haproxy.key -nodes -days 365 -out haproxy.crt
[root@centos7 certs]#cat haproxy.key haproxy.crt &gt; haproxy.pem
[root@centos7 certs]#openssl x509 -in haproxy.pem -noout -text <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#35777;&#20070;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2</span>
[root@centos7 ~]#mkdir /etc/haproxy/certs/
[root@centos7 ~]#cd /etc/pki/tls/certs
[root@centos7 certs]#make /etc/haproxy/certs/haproxy.pem 
<span style="color: #483d8b;">umask</span> 77 ; <span style="color: #8b2252;">\</span>
<span style="color: #a0522d;">PEM1</span>=<span style="color: #ff00ff;">`/bin/mktemp /tmp/openssl.XXXXXX`</span> ; <span style="color: #8b2252;">\</span>
<span style="color: #a0522d;">PEM2</span>=<span style="color: #ff00ff;">`/bin/mktemp /tmp/openssl.XXXXXX`</span> ; <span style="color: #8b2252;">\</span>
/usr/bin/openssl req -utf8 -newkey rsa:2048 -keyout $<span style="color: #a0522d;">PEM1</span> -nodes -x509 -days 365 -out $<span style="color: #a0522d;">PEM2</span> ; <span style="color: #8b2252;">\</span>
cat $<span style="color: #a0522d;">PEM1</span> &gt; /etc/haproxy/certs/haproxy.pem ; <span style="color: #8b2252;">\</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">""</span>     &gt;&gt; /etc/haproxy/certs/haproxy.pem ; <span style="color: #8b2252;">\</span>
cat $<span style="color: #a0522d;">PEM2</span> &gt;&gt; /etc/haproxy/certs/haproxy.pem ; <span style="color: #8b2252;">\</span>
rm -f $<span style="color: #a0522d;">PEM1</span> $<span style="color: #a0522d;">PEM2</span>
Generating a 2048 bit RSA private key
<span style="color: #483d8b;">.</span>+++
..............................................+++
writing new private key to <span style="color: #8b2252;">'/tmp/openssl.x8hOA8'</span>
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span style="color: #8b2252;">'.'</span>, the field will be left blank.
-----
Country Name (2 letter code) [XX]:CN
State or Province Name (full name) []:beijing
Locality Name (eg, city) [Default City]:beijing
Organization Name (eg, company) [Default Company Ltd]:me
Organizational Unit Name (eg, section) []:it
Common Name (eg, your name or your server<span style="color: #8b2252;">'s hostname) []:www.me.org</span>
<span style="color: #8b2252;">Email Address []:</span>
<span style="color: #8b2252;">[root@centos7 certs]#ll /etc/haproxy/certs/</span>
<span style="color: #8b2252;">total 4</span>
<span style="color: #8b2252;">-rw------- 1 root root 3027 Apr     4 10:35 haproxy.pem</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ed334707-95b3-4204-b28d-ee037490d7e2" class="outline-4">
<h4 id="h:ed334707-95b3-4204-b28d-ee037490d7e2">5.11.2 https配置示例</h4>
<div class="outline-text-4" id="text-h:ed334707-95b3-4204-b28d-ee037490d7e2">
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#cat /etc/haproxy/conf.d/test.cfg
frontend me_http_port
    <span style="color: #483d8b;">bind</span> 10.0.0.7:80
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">https setting ############################## </span>
    <span style="color: #483d8b;">bind</span> 10.0.0.7:443 ssl crt /etc/haproxy/certs/haproxy.pem
    redirect scheme https if !{ ssl_fc }                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#24847;{ }&#20869;&#30340;&#31354;&#26684;</span>
    http-request set-header X-forwarded-Port     %[dst_port]
    http-request add-header X-forwarded-Proto https if { ssl_fc }
    mode http
    balance roundrobin
    log global
    option httplog
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl setting ###############################</span>
    acl mobile_domain hdr_dom(host)     -i mobile.me.org
<span style="color: #b22222;">###################### </span><span style="color: #b22222;">acl hosts #################################</span>
    default_backend pc_hosts
<span style="color: #b22222;">################### </span><span style="color: #b22222;">backend hosts #################################</span>
backend mobile_hosts
    mode http
    server web1 10.0.0.17:80 check inter 2000 fall 3 rise 5
backend pc_hosts
mode http
    <span style="color: #b22222;">#</span><span style="color: #b22222;">http-request set-header X-forwarded-Port     %[dst_port] &#20063;&#21487;&#21152;&#22312;&#27492;&#22788;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">http-request add-header X-forwarded-Proto https if { ssl_fc }</span>
    server web2 10.0.0.27:80 check inter 2000 fall 3 rise 5

[root@centos7 ~]#ss -ntl
State         Recv-Q Send-Q                 Local Address:Port     Peer Address:Port             

LISTEN         0             100                                 127.0.0.1:25                                 *:*                 

LISTEN         0             128                                     10.0.0.7:443                             *:*                 

LISTEN         0             128                                                 *:9999                             *:*                 

LISTEN         0             128                                     10.0.0.7:80                                 *:*                 

LISTEN         0             128                                                 *:22                                 *:*                 

LISTEN         0             128                                         [::]:22                                 [::]:* 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3eeab3d8-fd86-40a3-99f5-7396690d914e" class="outline-4">
<h4 id="h:3eeab3d8-fd86-40a3-99f5-7396690d914e">5.11.3 修改后端服务器的日志格式</h4>
<div class="outline-text-4" id="text-h:3eeab3d8-fd86-40a3-99f5-7396690d914e">
<div class="org-src-container">
<pre class="src src-sh">[root@centos27 ~]#vim /etc/httpd/conf/httpd.conf
LogFormat <span style="color: #8b2252;">"%h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\" \"%{X-</span>
<span style="color: #8b2252;">Forwarded-Port}i\" \"%{X-Forwarded-Proto}i\""</span> combined 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:61de4a2e-04e9-4cbb-beee-a5e7db8026d1" class="outline-4">
<h4 id="h:61de4a2e-04e9-4cbb-beee-a5e7db8026d1">5.11.4 验证https</h4>
<div class="outline-text-4" id="text-h:61de4a2e-04e9-4cbb-beee-a5e7db8026d1">
<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#curl -IkL http://www.me.org
HTTP/1.1 302 Found
content-length: 0
location: https://www.me.org/
cache-control: no-cache
HTTP/1.1 200 OK
date: Sat, 04 Apr 2020 02:31:31 GMT
server: Apache/2.4.6 (CentOS) PHP/5.4.16
last-modified: Thu, 02 Apr 2020 01:44:13 GMT
etag: <span style="color: #8b2252;">"a-5a244f01f8adc"</span>
accept-ranges: bytes
content-length: 10
content-type: text/html; <span style="color: #a0522d;">charset</span>=UTF-8
[root@centos6 ~]#curl -Ik https://www.me.org
HTTP/1.1 200 OK
date: Sat, 04 Apr 2020 02:31:50 GMT
server: Apache/2.4.6 (CentOS) PHP/5.4.16
last-modified: Thu, 02 Apr 2020 01:44:28 GMT
etag: <span style="color: #8b2252;">"a-5a244f0fd5175"</span>
accept-ranges: bytes
content-length: 10
content-type: text/html; <span style="color: #a0522d;">charset</span>=UTF-8

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#21518;&#31471;&#26381;&#21153;&#22120;&#30340;&#35775;&#38382;&#26085;&#24535;</span>
[root@centos27 ~]#tail /var/log/httpd/access_log
10.0.0.7 - - [04/Apr/2020:10:40:17 +0800] <span style="color: #8b2252;">"HEAD / HTTP/1.1"</span> 200 - <span style="color: #8b2252;">"-"</span>
<span style="color: #8b2252;">"curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3</span>
<span style="color: #8b2252;">libidn/1.18 libssh2/1.4.2"</span> <span style="color: #8b2252;">"443"</span> <span style="color: #8b2252;">"https"</span>
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:aee3f035-7a3e-413a-bf73-5541f9243c0c" class="outline-2">
<h2 id="h:aee3f035-7a3e-413a-bf73-5541f9243c0c">6 本章重点总结</h2>
<div class="outline-text-2" id="text-h:aee3f035-7a3e-413a-bf73-5541f9243c0c">
<ul class="org-ul">
<li>HAProxy调度算法</li>
<li>动静分离与客户端源IP透传</li>
<li>ACL使用与报文修改</li>
<li>服务器动态下线</li>
<li>编写shell脚本，实现能够基于参数传递 Real Server
服务器IP，并实现将其从多个HAProxy进程下线与上线</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">stats socket /var/lib/haproxy/haproxy1.sock mode 600 level admin process 1
stats socket /var/lib/haproxy/haproxy2.sock mode 600 level admin process 2
</pre>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
