<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kubernetes: k8s 运维篇-Prometheus监控</title>
<meta name="description" content="kubernetes, linux" />
<meta name="keywords" content="kubernetes, linux" />
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Kubernetes: k8s 运维篇-Prometheus监控</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:ae0dbd74-0a28-436d-9165-228606ba3e1e">k8s- Prometheus</a>
<ul>
<li><a href="#h:c52a7a86-84cd-4ebf-9e9d-add2bd8d188b">Prometheus 监控入门</a>
<ul>
<li><a href="#h:d4a79c7c-c1f4-4fa5-a871-a100c5339317">什么是 Prometheus</a>
<ul>
<li><a href="#h:cfdcbaa9-b656-4a60-8f0d-8024cf881bbb">Prometheus 特性</a></li>
</ul>
</li>
<li><a href="#h:5788f988-ff14-47f8-8300-d3475a3a22dc">Prometheus 架构剖析</a></li>
<li><a href="#h:f0db2779-57a4-445d-9390-737436c9874c">Prometheus 安装</a>
<ul>
<li><a href="#h:667bf30b-ad0a-4085-92e2-3eff5a3f2528">Prometheus 安装方式选择</a></li>
<li><a href="#h:b6d70874-f374-4eb9-ab6a-e41e75e63fac">Prometheus 高可用安装</a></li>
</ul>
</li>
<li><a href="#h:20c8cba3-456b-440b-942e-e60593915f47">云原生和非云原生应用的监控流程</a>
<ul>
<li><a href="#h:947f06ff-52ce-4209-a574-e0a05c87ca36">Promethues 的数据来源</a></li>
<li><a href="#h:41f35e02-869f-49a8-b5d7-b279d72f02f3">Prometheus 怎么知道数据的来源</a></li>
</ul>
</li>
<li><a href="#h:bd160072-b7fd-4ab2-a5b8-a8a4caf21ec3">非云原生应用监控 Exporter</a>
<ul>
<li><a href="#h:f67acfcc-b6f0-4346-8dfe-df95b53ad713">mysql exporter</a></li>
</ul>
</li>
<li><a href="#h:fc8ffc1c-6be6-42c8-a913-7d90faa39159">云原生应用监控</a>
<ul>
<li><a href="#h:1845e9ab-2afc-427f-ada3-0bab058a0f67">etcd 集群监控</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:46de4e55-a657-43e2-b70e-e3005efaccb8">Prometheus监控实战</a>
<ul>
<li><a href="#h:9c2b7226-f947-4758-8182-31c0711d912b">Promethues 黑盒监控</a>
<ul>
<li><a href="#h:42274e08-bb3d-49a5-909d-d4a3d097f3e9">部署exporter</a></li>
<li><a href="#h:1c167782-245a-4c94-9803-5a8d33a4ee23">additional 传统监控</a></li>
</ul>
</li>
<li><a href="#h:f2e8f400-5040-4d62-86c0-6a8098e2fc8b">Prometheus 静态配置</a>
<ul>
<li><a href="#h:b67eb122-6ed3-4729-9042-153666b80a3b">additionalScrapeConfigs</a></li>
</ul>
</li>
<li><a href="#h:f17f34a7-46d9-412c-a5c0-f7cc5c9e0fd4">Prometheus 监控 Windows（外部）主机</a></li>
<li><a href="#h:95aac4c8-4613-45cf-a8b7-768cff7c71a0">自动发现注册服务</a>
<ul>
<li><a href="#h:84d0c7ae-89d5-415a-be0f-72d719939821">正则表达式</a></li>
<li><a href="#h:41ac00f3-8053-403d-b270-e8eb19bb6e9b">参数说明</a></li>
<li><a href="#h:f937880c-b862-4afe-92a1-74b926a9ddae">自动发现 node-export 和 kubelet</a></li>
<li><a href="#h:cd1b702f-c009-48f5-9e12-0eb041f8a746">必要的步骤</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:507e3211-f74e-4ea6-b827-0ac08b91e0d2">Prometheus 语法 PromQL</a>
<ul>
<li><a href="#h:ebe9dbb3-a7b8-4d78-be1f-e2a7786ee7c1">PromQL 语法体验</a>
<ul>
<li><a href="#h:0a32ef10-305d-476f-a729-605db7808c75">Prometheus Metrics类型</a></li>
<li><a href="#h:d4eb1955-8361-4bd7-a250-105aae0cefee">Metrics指标类型</a></li>
<li><a href="#h:31a4e901-b8a7-4b6b-aa08-0f13f466ed8b">数据模型</a></li>
<li><a href="#h:1a8584e2-e996-41cb-80f9-865e07992975">PromQL</a></li>
</ul>
</li>
<li><a href="#h:d637d076-49d1-4746-b7e9-b834c507612a">PromQL 操作符</a></li>
<li><a href="#h:44ca4052-0c29-403e-a90a-a28070bcf348">PromQL 常用函数</a>
<ul>
<li><a href="#h:e42c4339-59ba-4875-a9ee-8c59171ed853">一个指标的增长率</a></li>
<li><a href="#h:73136684-06a7-4cf2-b624-bb9e09aa0b92">预测统计：</a></li>
<li><a href="#h:1752ba3d-ef89-45cd-9ee7-3fcc835e70e6">去除小数点：</a></li>
<li><a href="#h:3eabcc4b-aa43-4d81-9212-c1accaab7af3">排序：</a></li>
<li><a href="#h:e21789fc-4541-48df-a696-674dbd5d694a">新 label</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:ebf11448-544f-4033-818f-50dc637f98a4">Alertmanager告警实战</a>
<ul>
<li><a href="#h:14985a1c-644e-465f-b1b5-106d3fd47468">Alertmanager 监控报警</a></li>
<li><a href="#h:0d71079c-d30e-487e-a7ef-b71182734df0">alertmanager 配置文件解析</a></li>
<li><a href="#h:cd3fbfce-e27c-436e-94b5-37e632d3c1d4">route-路由规则</a></li>
<li><a href="#h:4ba6913b-be71-47f2-b96e-73b96515d6ab">receivers-告警通知</a>
<ul>
<li><a href="#h:a1f265e1-ca0b-408c-bb66-9375d1541438">告警邮件通知</a></li>
<li><a href="#h:72fc7d8a-fed8-4df9-84af-9851fb5ff61d">告警微信通知</a></li>
<li><a href="#h:a8dbe787-4083-4edc-8390-597ec9299469">slack</a></li>
<li><a href="#h:948a621c-c649-40b5-9c4c-b69285ef84d6">自定义接收者-自建接口</a></li>
</ul>
</li>
<li><a href="#h:aab88a77-78c3-42ad-a601-9fd5b9f6aaa9">templates-自定义告警模板</a>
<ul>
<li><a href="#h:4602864c-6f7c-45e7-a9ea-28afe14ae1ca">微信告警模板</a></li>
</ul>
</li>
<li><a href="#h:339556f0-dcec-41fe-9ad7-d76a406b75dc">inhibit_rules-限制</a></li>
<li><a href="#h:9828702b-5c89-4409-a844-5fe89975b698">计划内维护暂停告警 Silence</a></li>
<li><a href="#h:655ad2ea-0d20-4c45-acad-836caeddb9f9">手动触发告警</a></li>
</ul>
</li>
<li><a href="#h:f8ebcb30-d2e3-4174-aecb-6ef83a44fedd">Prometheus 告警实战</a>
<ul>
<li><a href="#h:c7ceac4e-4c8d-42bb-bfc2-1b80f730b663">PrometheusRule</a>
<ul>
<li><a href="#h:99be0d9e-5c39-4aee-a842-e3ca9bbbffb2">规则语法</a></li>
</ul>
</li>
<li><a href="#h:07378308-4f48-4203-8726-92eab0e1c63d">域名访问延迟告警</a>
<ul>
<li><a href="#h:eb9295da-8ce4-4c8f-b50f-8987c6d2bfca">告警规则</a></li>
<li><a href="#h:f556fcb8-f5f8-45fe-bf72-bac812dd960f">ingress 自动监控域名</a></li>
</ul>
</li>
<li><a href="#h:e67b48f6-8020-4b06-b6b8-4ec5013127ca">prometheus 监控 Java JVM</a>
<ul>
<li><a href="#h:c23fe1d4-2a58-48cd-92ec-72eebc9d1919">Java JVM监控</a></li>
<li><a href="#h:eb39c790-aa0b-4c70-8e80-81aedcd32869">基于 euraka 服务自动发现监控 JVM</a></li>
</ul>
</li>
<li><a href="#h:26da6d52-da21-4ae6-9dc8-081b3f20894d">监控告警通用步骤</a></li>
<li><a href="#h:59979eba-dadd-47ff-863b-ae6f98c6a98c">解决监控问题</a>
<ul>
<li><a href="#h:70da9f17-6132-4c4f-bd39-49e4155d4b27">解决schedule和controller监控问题</a></li>
<li><a href="#h:55302452-c660-44f6-a17e-a634706ad7ef">CPUThrottlingHigh</a></li>
</ul>
</li>
<li><a href="#h:3eeaa294-05a7-4cff-872b-b622e2f82688">记录规则优化 PromQL 语句</a></li>
</ul>
</li>
<li><a href="#h:aa168970-406c-44c0-8cd0-8f3cb0bb80e4">参考</a>
<ul>
<li><a href="#h:1c09d771-38f0-4dd3-a989-e025d209d4ba">grafana</a>
<ul>
<li><a href="#h:d284591d-854c-4e5a-853e-2ee6a38aeb26">图表变量取值</a></li>
</ul>
</li>
<li><a href="#h:c5d5ba75-c5b0-44e8-8b96-2846bf43adce">alertmanager webhook json</a></li>
<li><a href="#h:efe9f42f-ac0d-4231-a8ee-71b44e1420ad">PromSQL</a></li>
<li><a href="#h:59dc55b1-82c4-4536-b5f1-32a8ba53c03c">prometheus 数据清理</a></li>
<li><a href="#h:711178d5-9434-45b4-8e2b-247afdb0f7f7">pushgateway</a>
<ul>
<li><a href="#h:d6ccbdf3-13d3-49e7-9fa8-2ccde0f527c8">安装</a></li>
<li><a href="#h:77378b9a-c99d-4ef0-9edc-0c9a6f8f5c14">清理数据</a></li>
<li><a href="#h:a7b9e28b-349f-468f-9383-85c616c2889a">脚本</a></li>
<li><a href="#h:ff228fea-7a85-47ec-b622-7c0a340fb9aa">pushway 脚本</a></li>
</ul>
</li>
<li><a href="#h:8b99ae58-538e-4c00-a31b-018b034f9d37">告警钉钉通知</a>
<ul>
<li><a href="#h:c5a0a9ac-76dc-4f21-9b6d-4412ca9b6711">钉钉报警模板</a></li>
<li><a href="#h:d5917aef-b520-4eec-bb3b-fdd28f1560b0">k8s 部署</a></li>
</ul>
</li>
<li><a href="#h:ca8d2783-1186-437b-b31e-d14f79500d18">非云原生应用监控 Exporter</a>
<ul>
<li><a href="#h:a242b9a0-99de-4973-83d9-e2747cacb0ec">Kafka exporter</a></li>
<li><a href="#h:f44b11f1-dbf2-41f2-8c2d-252ece19a380">node-exporter</a></li>
<li><a href="#h:225c17b3-0ed3-499b-be9b-8495517fe76b">redis-exporter</a></li>
<li><a href="#h:973f36df-5980-4ac8-8f63-7c32474a8afc">rocketmq-exporter</a></li>
<li><a href="#h:c3cb474a-e85d-4620-a5a9-0eb259b285b0">awk-cloudwatch-exporter</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:d59ef2b6-2157-40e1-bfda-656fb7eb2429">其他</a></li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="./index.html">Kubernetes</a></li>
</ul>
<section id="outline-container-h:ae0dbd74-0a28-436d-9165-228606ba3e1e" class="outline-2">
<h2 id="h:ae0dbd74-0a28-436d-9165-228606ba3e1e">k8s- Prometheus</h2>
<div class="outline-text-2" id="text-h:ae0dbd74-0a28-436d-9165-228606ba3e1e">
</div>
<div id="outline-container-h:c52a7a86-84cd-4ebf-9e9d-add2bd8d188b" class="outline-3">
<h3 id="h:c52a7a86-84cd-4ebf-9e9d-add2bd8d188b">Prometheus 监控入门</h3>
<div class="outline-text-3" id="text-h:c52a7a86-84cd-4ebf-9e9d-add2bd8d188b">
</div>
<div id="outline-container-h:d4a79c7c-c1f4-4fa5-a871-a100c5339317" class="outline-4">
<h4 id="h:d4a79c7c-c1f4-4fa5-a871-a100c5339317">什么是 Prometheus</h4>
<div class="outline-text-4" id="text-h:d4a79c7c-c1f4-4fa5-a871-a100c5339317">
<p>
<a href="https://github.com/prometheus)">Prometheus</a>是一个开源监控系统和报警框架，其本身也是一个时序数据库（TSDB），它的设计灵感来源于 Google 的 Borgmon，就像 Kubernetes 是基于 Borg 系统开源的。
</p>

<p>
它是由 SoundCloud 的 Google 前员工设计并开源的。2016年加了云原生基金会（CNCF）。
</p>
</div>
<div id="outline-container-h:cfdcbaa9-b656-4a60-8f0d-8024cf881bbb" class="outline-5">
<h5 id="h:cfdcbaa9-b656-4a60-8f0d-8024cf881bbb">Prometheus 特性</h5>
<div class="outline-text-5" id="text-h:cfdcbaa9-b656-4a60-8f0d-8024cf881bbb">
<p>
Prometheus的主要特征有：
</p>

<ul class="org-ul">
<li>一个多维度数据模型，具有由指标名称和键/值对标识的时间序列数据；</li>
<li>使用 PromQL 查询和聚合数据，可以灵活的对数据进行检索；</li>
<li>不依赖额外的数据存储，Prometheus 本身就是一个时序数据库，提供本地存储和分布存储，并且每个 Prometheus 都是自治的；</li>
<li>应用程序暴露 Metrics 接口，Prometheus 通过基于 HTTP 的 Pull 模型采集数据，同时可以使用 PushGateway 进行 Push 数据；</li>
<li>Prometheus 同时支持动态服务发现和静态配置（墨盒）发现目标机器；</li>
<li>支持多种多样的图表和界面展示，和 grafana 堪称『绝配』。</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:5788f988-ff14-47f8-8300-d3475a3a22dc" class="outline-4">
<h4 id="h:5788f988-ff14-47f8-8300-d3475a3a22dc">Prometheus 架构剖析</h4>
<div class="outline-text-4" id="text-h:5788f988-ff14-47f8-8300-d3475a3a22dc">
<p>
<a href="https://prometheus.io/docs/introduction/overview/#architecture">https://prometheus.io/docs/introduction/overview/#architecture</a>
</p>


<figure id="org90edfcb">
<img src="https://prometheus.io/assets/docs/architecture.svg" alt="architecture.svg" class="org-svg">

</figure>

<p>
Prometheus生态包括了很多组件，它们中的一些是可选的：
</p>
<ul class="org-ul">
<li>Prometheus server：主服务负责抓取和存储时间序列数据，存储推荐使用 HDD 或者 SSD 磁盘</li>
<li>Alertmanager：警告管理器</li>
<li>Grafana：展示 Prometheus 数据</li>
<li>Pushgateway：支持短生命周期的PUSH网关</li>
<li>Exporters: 采集应用数据， 针对非云原生应用，没有 metrics 接口的服务，如 mysql,node,kafka</li>
<li>Service discovery：可以用 k8s 、cousule、文件 的自动发现</li>
</ul>
</div>
</div>
<div id="outline-container-h:f0db2779-57a4-445d-9390-737436c9874c" class="outline-4">
<h4 id="h:f0db2779-57a4-445d-9390-737436c9874c">Prometheus 安装</h4>
<div class="outline-text-4" id="text-h:f0db2779-57a4-445d-9390-737436c9874c">
</div>
<div id="outline-container-h:667bf30b-ad0a-4085-92e2-3eff5a3f2528" class="outline-5">
<h5 id="h:667bf30b-ad0a-4085-92e2-3eff5a3f2528">Prometheus 安装方式选择</h5>
<div class="outline-text-5" id="text-h:667bf30b-ad0a-4085-92e2-3eff5a3f2528">
<ul class="org-ul">
<li>二进制安装</li>
<li>容器安装</li>
<li>helm 安装：针对无状态应用设计</li>
<li><p>
Prometheus Operator：推荐，倾向比较复杂的集群而设计的
</p>

<p>
github: <a href="https://github.com/prometheus-operator/prometheus-operator">https://github.com/prometheus-operator/prometheus-operator</a>
</p>

<p>
文档： <a href="https://prometheus-operator.dev/">https://prometheus-operator.dev/</a>
</p>

<ul class="org-ul">
<li>Kube-Prometheus Stack：推荐，是个技术栈
<ul class="org-ul">
<li>Prometheus Operator</li>
<li>高可用的 Prometheus</li>
<li>高可用的 Alertmanager</li>
<li>主机监控 Node Exporter</li>
<li>Prometheus Adapter</li>
<li>容器监控 Kube-state-metrics</li>
<li>图形化展示 Grafana</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:b6d70874-f374-4eb9-ab6a-e41e75e63fac" class="outline-5">
<h5 id="h:b6d70874-f374-4eb9-ab6a-e41e75e63fac">Prometheus 高可用安装</h5>
<div class="outline-text-5" id="text-h:b6d70874-f374-4eb9-ab6a-e41e75e63fac">
<p>
使用 Kube-Prometheus Stack 安装方式：
</p>

<ul class="org-ul">
<li>手动版: <a href="https://github.com/prometheus-operator/kube-prometheus">https://github.com/prometheus-operator/kube-prometheus</a></li>
<li>helm版：<a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack">https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack</a>
<ul class="org-ul">
<li>和手动区别在于手动板是多个静态文件比较直观，helm 靠变量灵活转化成文件部署，自定义修改values.yaml文件就行。另外helm版没有墨盒监控(blackbox)。</li>
<li>安装 <code>helm install -n monitoring prometheus prometheus-community/kube-prometheus-stack</code> 注意自定义资源Prometheus配置文件加了标签识别限制 <code>release: prometheus</code> ，创建serviceMonitor、podMointor、Probe等都需要增加这个标签</li>
</ul></li>
</ul>

<p>
首先需要通过该项目地址，找到和自己 k8s 版本对应的 Kube Prometheus Stack 的版本
</p>


<figure id="orgc9932a3">
<img src="./images/Snipaste_2022-09-07_16-50-39.png" alt="Snipaste_2022-09-07_16-50-39.png" width="50%">

</figure>

<p>
每台机器的配置最好在 4C4G 以上。
</p>

<p>
下载：
</p>

<div class="org-src-container">
<pre class="src src-shell">git clone -b release-0.8 --single-branch https://github.com/prometheus-operator/kube-prometheus
</pre>
</div>

<p>
安装 operator：
</p>

<p>
因为所有的组件都是通过 operator 控制的。
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">cd kube-prometheus/manifests</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">kubectl create -f setup/</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#26159;&#21542;Running</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">kubectl get pod -n monitoring</span>
NAME                                   READY   STATUS        RESTARTS   AGE
prometheus-operator-848d669f6d-bz2tc   2/2     Running       0          4m16s
</pre>
</div>

<p>
Operator 容器启动后，安装 Prometheus Stack
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">cd</span> kube-prometheus/manifests
kubectl create -f .

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#29366;&#24577;</span>
kubectl get pod -n monitoring
</pre>
</div>

<p>
注意：非生产可不做高可用，副本数做调整
</p>
<ul class="org-ul">
<li>修改 alertmanager-alertmanager.yaml 副本数改为 1 个</li>
<li>修改 prometheus-prometheus.yaml  副本数改为 1 个</li>
<li>kube-state-metrics-deployment.yaml 镜像改为快速的镜像，docker hub 搜索 bitnami/kube-stat-metrics</li>
</ul>

<p>
常见参数
</p>
<div class="org-src-container">
<pre class="src src-shell">containers:
- args:
  - --config.file=/etc/prometheus/prometheus.yml  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#37197;&#32622;&#25991;&#20214;</span>
  - --query.timeout=1m
  - --storage.tsdb.wal-compression  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25968;&#25454;&#21387;&#32553;&#65292;&#40664;&#35748;&#24320;&#21551;</span>
  - --query.max-samples=20000000
  - --storage.tsdb.path=/prometheus  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25968;&#25454;&#23384;&#20648;&#36335;</span>
  - --storage.tsdb.retention.time=90d  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25968;&#25454;&#20445;&#30041;&#26102;&#38388;</span>
  - --storage.tsdb.min-block-duration=1h
  - --storage.tsdb.max-block-duration=2h
  - --web.console.libraries=/etc/prometheus/console_libraries
  - --web.console.templates=/etc/prometheus/consoles
  - --web.enable-lifecycle  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25903;&#25345;&#28909;&#26356;&#26032;&#65292;&#30452;&#25509;&#25191;&#34892;localhost:9090/-/reload&#31435;&#21363;&#29983;&#25928;</span>
  <span style="color: #b22222;">#</span><span style="color: #b22222;">- --web.external-url=/eks</span>
  - --web.external-url=https://prometheus.gxxx.com/eks  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23545;&#22806;&#37096;&#22320;&#22336;&#65292;alertmanager &#21457;&#36865;&#25253;&#35686;&#26102;&#20256;&#36882;&#35813;&#22320;&#22336;</span>
  - --web.enable-admin-api  <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#25968;&#25454;&#31649;&#29702;&#65292;&#21024;&#38500;&#25968;&#25454;&#31561;&#12290;&#21442;&#32771; https://prometheus.io/docs/prometheus/latest/querying/api/#tsdb-admin-apis</span>
  image: prom/prometheus:v2.34.0
</pre>
</div>

<p>
pv,pvc 存储 : <a href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/storage.md">https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/storage.md</a>
</p>

<p>
创建 ingress
</p>

<ul class="org-ul">
<li>Grafana：数据展示</li>
<li>Prometheus ui：PromQL 查询、配置查看</li>
<li>Alertmanager：告警管理，发生报警可设置静默</li>
</ul>

<div class="org-src-container">
<pre class="src src-yaml"># 创建一下Ingress代理三个service
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  generation: 1
  name: prom-ingresses
  namespace: monitoring
spec:
  rules:
  - host: alert.test.com
    http:
      paths:
      - backend:
          serviceName: alertmanager-main
          servicePort: 9093
        path: /
  - host: grafana.test.com
    http:
      paths:
      - backend:
          serviceName: grafana
          servicePort: 3000
        path: /
  - host: prome.test.com
    http:
      paths:
      - backend:
          serviceName: prometheus-k8s
          servicePort: 9090
        path: /
</pre>
</div>

<p>
页面访问
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;&#20320;Windows&#30340;hosts&#25991;&#20214;&#28155;&#21152;&#20027;&#26426;&#26144;&#23556;&#65292;&#27983;&#35272;&#22120;&#35775;&#38382;&#21363;&#21487;</span>
10.4.7.107 alert.test.com grafana.test.com prome.test.com
</pre>
</div>

<p>
grafana 账号密码默认 admin:admin ，默认有一些 k8s 相关的模板。
</p>

<p>
其它页面是没有账号登录的，可以从 ingress 配置。
</p>
</div>
</div>
</div>
<div id="outline-container-h:20c8cba3-456b-440b-942e-e60593915f47" class="outline-4">
<h4 id="h:20c8cba3-456b-440b-942e-e60593915f47">云原生和非云原生应用的监控流程</h4>
<div class="outline-text-4" id="text-h:20c8cba3-456b-440b-942e-e60593915f47">
</div>
<div id="outline-container-h:947f06ff-52ce-4209-a574-e0a05c87ca36" class="outline-5">
<h5 id="h:947f06ff-52ce-4209-a574-e0a05c87ca36">Promethues 的数据来源</h5>
<div class="outline-text-5" id="text-h:947f06ff-52ce-4209-a574-e0a05c87ca36">
<ul class="org-ul">
<li>云原生应用：/metrics</li>
<li>非原生应用：Exporter 采集</li>
</ul>

<p>
目前比较常用的 Exporter 工具如下：
</p>
<ul class="org-ul">
<li>数据库：MySQL Exporter, Redis Exporter, MongoDB Exporter, MSSQL Exporter</li>
<li>配置中心：Nacos Exporter</li>
<li>硬件: Apcupsd Exporter, IoT Edison Exporter, IPMI Exporter, Node Exporter</li>
<li>消息队列：RocketMQ Exporter, Kafka Exporter, Beanstalkd Exporter, NSQ Exporter, RabbitMQ Exporter</li>
<li>存储：Ceph Exporter, Gluster Exporter, HDFS Exporter, ScalelO Exporter</li>
<li>HTTP 服务：Apache Exporter, HAProxy Exporter, Nginx Exporter</li>
<li>API 服务：AWS ECS Exporter, Docker Cloud Exporter, Docker Hub Exporter, Github Exporter</li>
<li>日志：Fluentd Exporter, Grok Exporter</li>
<li>监控系统：Collectd Exporter, Graphite Exporter, InfluxDB Exporter, Nagios Exporter, SNMP Exporter</li>
<li>AWS：CloudWatch Exporter</li>
<li>其它：Blockbox Exporter, JIRA Exporter, Jenkins Exporter, Confluence Exporter</li>
</ul>
</div>
</div>
<div id="outline-container-h:41f35e02-869f-49a8-b5d7-b279d72f02f3" class="outline-5">
<h5 id="h:41f35e02-869f-49a8-b5d7-b279d72f02f3">Prometheus 怎么知道数据的来源</h5>
<div class="outline-text-5" id="text-h:41f35e02-869f-49a8-b5d7-b279d72f02f3">
</div>
<ul class="org-ul">
<li><a id="h:3d785849-0b6a-45ee-86aa-1edf29c0d758"></a>什么是 ServiceMonitor<br>
<div class="outline-text-6" id="text-h:3d785849-0b6a-45ee-86aa-1edf29c0d758">

<figure id="orgf63a07f">
<img src="./images/Snipaste_2022-09-07_18-58-18.png" alt="Snipaste_2022-09-07_18-58-18.png" width="50%">

</figure>

<ul class="org-ul">
<li>通过 prometheus.yml 加载配置
<ul class="org-ul">
<li>二进制安装</li>
<li>容器安装</li>
<li>Helm</li>
</ul></li>
<li>通过 ServiceMonitor 加载配置
<ul class="org-ul">
<li>Helm</li>
<li>Prometheus Operator</li>
<li>Kube-Prometheus Stack</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">kubectl  get servicemonitor -n monitoring
</pre>
</div>
</div>
</li>
<li><a id="h:b20f1899-321d-4d5b-9940-b5c6157e00c6"></a>ServiceMonitor 配置解析<br>
<div class="outline-text-6" id="text-h:b20f1899-321d-4d5b-9940-b5c6157e00c6">
<p>
使用 Operator 安装推荐使用 ServiceMonitor 配置监控目标
</p>

<p>
ServiceMonitor 是用来匹配 Service 标签的服务，再自动生产 prometheus 配置文件
</p>

<p>
如注册 blackbox-exporter 配置
</p>
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: blackbox-exporter
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 0.18.0
  name: blackbox-exporter
  namespace: monitoring
spec:
  endpoints:
  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    interval: 30s
    path: /metrics
    port: https
    scheme: https
    tlsConfig:
      insecureSkipVerify: true
  selector:
    matchLabels:
      app.kubernetes.io/component: exporter
      app.kubernetes.io/name: blackbox-exporter
      app.kubernetes.io/part-of: kube-prometheus
</pre>
</div>

<p>
注册 node exporter 配置
</p>
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: node-exporter
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 1.1.2
  name: node-exporter
  namespace: monitoring
spec:
  endpoints:
  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    interval: 15s
    port: https
    relabelings:
    - action: replace
      regex: (.*)
      replacement: $1
      sourceLabels:
      - __meta_kubernetes_pod_node_name
      targetLabel: instance
    scheme: https
    tlsConfig:
      insecureSkipVerify: true
  jobLabel: app.kubernetes.io/name
  selector:
    matchLabels:
      app.kubernetes.io/component: exporter
      app.kubernetes.io/name: node-exporter
      app.kubernetes.io/part-of: kube-prometheus
</pre>
</div>

<p>
说明：
</p>
<ul class="org-ul">
<li>selector：监控目标的 Service 的标签</li>
<li>namespaceSelector：监控目标 Service 所在的名称空间</li>
<li>scheme：Metrics 接口协议</li>
<li>port：Metrics 端口</li>
<li>path：Metrics 接口路径</li>
<li>interval：监控数据抓取的时间间隔</li>
<li>honorLabels：如果目标标签和服务标签冲突，是否保留目标标签</li>
</ul>


<p>
注意：
如果prometheus-prometheus.yaml 指定了名称空间或者指标，那么需要 ServiceMonitor 与之一致。默认是空。
</p>
<div class="org-src-container">
<pre class="src src-yaml">serviceMonitorNamespaceSelector: {}
serviceMonitorSelector: {}
</pre>
</div>
</div>
</li>
<li><a id="h:6ae5214d-24aa-4607-92ea-2b6b04511a76"></a>正常的配置解析<br>
<div class="outline-text-6" id="text-h:6ae5214d-24aa-4607-92ea-2b6b04511a76">
<p>
官方文档：<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a>
</p>
</div>
</li>
<li><a id="h:13c15752-926a-4b67-b1a6-76b74db9d93f"></a>ServiceMonitor 监控失败排查步骤<br>
<div class="outline-text-6" id="text-h:13c15752-926a-4b67-b1a6-76b74db9d93f">
<ul class="org-ul">
<li>确认 ServiceMonitor 是否成功创建</li>
<li>确认 ServiceMonitor 标签是否配置正确</li>
<li>确认 Prometheus 是否生成了相关配置</li>
<li>确认存在 ServiceMonitor 匹配的 Service</li>
<li>确认通过 Service 能够访问程序的 Metrics 接口</li>
<li>确认 Service 的端口和 Scheme 和 ServiceMonitor  一致</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:bd160072-b7fd-4ab2-a5b8-a8a4caf21ec3" class="outline-4">
<h4 id="h:bd160072-b7fd-4ab2-a5b8-a8a4caf21ec3">非云原生应用监控 Exporter</h4>
<div class="outline-text-4" id="text-h:bd160072-b7fd-4ab2-a5b8-a8a4caf21ec3">
<p>
官方文档：<a href="https://prometheus.io/docs/instrumenting/exporters/">https://prometheus.io/docs/instrumenting/exporters/</a>
</p>
</div>
<div id="outline-container-h:f67acfcc-b6f0-4346-8dfe-df95b53ad713" class="outline-5">
<h5 id="h:f67acfcc-b6f0-4346-8dfe-df95b53ad713">mysql exporter</h5>
<div class="outline-text-5" id="text-h:f67acfcc-b6f0-4346-8dfe-df95b53ad713">
<p>
创建 mysql 服务并设置 root 密码
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl create deploy mysql-tmp --image=mysql:5.7.23

kubectl set env deploy/mysql-tmp <span style="color: #a0522d;">MYSQL_ROOT_PASSWORD</span>=mysql
</pre>
</div>

<p>
创建 Service 暴露 MySQL
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl expose deploy mysql-tmp --port 3306

kubectl get svc -l <span style="color: #a0522d;">app</span>=mysql-tmp
NAME        TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
mysql-tmp   ClusterIP   172.20.138.2   &lt;none&gt;        3306/TCP   19s

telnet 172.20.138.2 3306
</pre>
</div>

<p>
登录 MySQL，创建 Exporter 所需的用户权限
</p>
<div class="org-src-container">
<pre class="src src-shell">$ kubectl  exec -it mysql-tmp-79d4dd8d8-jnbrg -- bash
root@mysql-tmp-79d4dd8d8-jnbrg:/# mysql -uroot -pmysql
mysql&gt; create user <span style="color: #8b2252;">'exporter'</span>@<span style="color: #8b2252;">'%'</span>  identified by <span style="color: #8b2252;">'exporter'</span> with MAX_USER_CONNECTIONS 3;
mysql&gt; grant process, replication client, select on *.* to <span style="color: #8b2252;">'exporter'</span>@<span style="color: #8b2252;">'%'</span>;

</pre>
</div>

<p>
配置 MySQL Exporter 采集 MySQL 监控数据
</p>
<div class="org-src-container">
<pre class="src src-shell">vim mysql-exporter.yaml

kind: Secret
metadata:
  name: prometheus-mysql-exporter
  namespace: monitoring
<span style="color: #483d8b;">type</span>: Opaque
data:
  password: <span style="color: #8b2252;">"bXlzcWw="</span>
---
apiVersion: v1
kind: Service
metadata:
  name: prometheus-mysql-exporter
  namespace: monitoring
  labels:
    k8s-app: prometheus-mysql-exporter
spec:
  <span style="color: #483d8b;">type</span>: ClusterIP
  ports:
  - port: 9104
    targetPort: 9104
    protocol: TCP
    name: mysql-exporter
  selector:
    k8s-app: prometheus-mysql-exporter
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus-mysql-exporter
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: prometheus-mysql-exporter
  template:
    metadata:
      labels:
        k8s-app: prometheus-mysql-exporter
      <span style="color: #b22222;">#</span><span style="color: #b22222;">annotations: # &#21160;&#24577;&#21457;&#29616;</span>
      <span style="color: #b22222;">#  </span><span style="color: #b22222;">prometheus.io/path: /metrics</span>
      <span style="color: #b22222;">#  </span><span style="color: #b22222;">prometheus.io/port: "9104"</span>
      <span style="color: #b22222;">#  </span><span style="color: #b22222;">prometheus.io/scrape: "true"</span>
    spec:
      containers:
      - name: prometheus-mysql-exporter
        image: <span style="color: #8b2252;">"prom/mysqld-exporter:v0.14.0"</span>
        imagePullPolicy: IfNotPresent
        env:
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: prometheus-mysql-exporter
              key: password
        - name: DATA_SOURCE_NAME
          value: <span style="color: #8b2252;">"exporter:$(</span><span style="color: #ff00ff;">DB_PASSWORD</span><span style="color: #8b2252;">)@(mysql-tmp.default:3306)/"</span>
        ports:
        - containerPort: 9104
        livenessProbe:
          httpGet:
            path: /
            port: 9104
        readinessProbe:
          httpGet:
            path: /
            port: 9104
        resources:
          limits:
            cpu: <span style="color: #8b2252;">"100m"</span>
            memory: 100Mi
          requests:
            cpu: <span style="color: #8b2252;">"10m"</span>
            memory: 10Mi
</pre>
</div>

<p>
检查是否有数据
</p>
<div class="org-src-container">
<pre class="src src-shell">$ kubectl  get svc -l k8s-app=prometheus-mysql-exporter -n monitoring
NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
prometheus-mysql-exporter   ClusterIP   172.20.227.60   &lt;none&gt;        9104/TCP   4m53s

$ curl 172.20.227.60:9104/metrics
</pre>
</div>

<p>
创建 ServiceMonitor
</p>

<p>
如果加了自动发现可忽略此步
</p>
<div class="org-src-container">
<pre class="src src-shell">$ cat mysql-sm.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    k8s-app: prometheus-mysql-exporter
  name: prometheus-mysql-exporter
  namespace: monitoring
spec:
  endpoints:
  - interval: 30s
    path: /metrics
    port: api
    scheme: http
  selector:
    matchLabels:
      k8s-app: prometheus-mysql-exporter
    namepsaceSelector:
      matchNames:
      - monitoring
</pre>
</div>

<p>
需要 matchLabels 和 endpoints 的配置要和 MySQL 的 Service 一致。之后创建該 ServiceMonitor
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl apply -f mysql-sm.yaml
</pre>
</div>

<p>
再检查 prometheus ui 中的 target 是否生效。
</p>

<p>
或者用基于prometheus.yaml 配置文件配置发现服务，动态可以搭建 consule 服务 mysql 应用注册进 consule 完成 prometheus动态发现
</p>

<p>
如静态文件加载
</p>
<div class="org-src-container">
<pre class="src src-yaml">- job_name: 'mysql_master'
  scrape_interval: 20s
  honor_labels: true
  static_configs:
  - targets:
    - "172.21.89.124:9104"
    - "172.21.89.243:9104"
    labels:
      business: App
      dbtype: db-mysql-db
      team: platform
</pre>
</div>
</div>
<ul class="org-ul">
<li><a id="h:ff304ed3-d2ee-499d-a077-eb40dda190c2"></a>步骤一<br>
<div class="outline-text-7" id="text-h:ff304ed3-d2ee-499d-a077-eb40dda190c2">
<p>
在创建Prometheus的deployment中加上
</p>

<div class="org-src-container">
<pre class="src src-yaml"># 位置：Deployment.spec.template.spec下面
serviceAccountName: prometheus  # 指定自己创建的sa


template:
    metadata:
      labels:
        app: prometheus # 这个labels要跟selector的一致，才能匹配上
    spec:
      serviceAccountName: prometheus  # 指定自己创建的sa
      volumes:          # 真正挂载，这里需要用到底下声明挂载的name
      - name: config    # 这里需要跟底下声明挂载的name(config)保持一致
        configMap:
          name: prometheus-config # configmap name

</pre>
</div>
</div>
</li>
<li><a id="h:a08260db-dbb1-4a4b-98c9-98753a5c8aee"></a>步骤二<br>
<div class="outline-text-7" id="text-h:a08260db-dbb1-4a4b-98c9-98753a5c8aee">
<p>
创建SA,创建文件prometheus-sa.yaml
</p>

<div class="org-src-container">
<pre class="src src-yaml">apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus   # 名字要跟deployment中的那个serviceAccountName保持一直
  namespace: kube-mon
</pre>
</div>
</div>
</li>
<li><a id="h:9250c571-b86e-4dc2-9d60-995651e4e1b3"></a>步骤三<br>
<div class="outline-text-7" id="text-h:9250c571-b86e-4dc2-9d60-995651e4e1b3">
<p>
创建集群角色，且做好绑定。文件prometheus-rbac.yaml
</p>

<div class="org-src-container">
<pre class="src src-yaml"># 先创建一个集群角色，给定以下一堆权限
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus
rules:
- apiGroups:
  - ""
  resources:
  - nodes
  - services
  - endpoints
  - pods
  - nodes/proxy
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - "extensions"
  resources:
    - ingresses
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - configmaps
  - nodes/metrics
  verbs:
  - get
- nonResourceURLs:
  - /metrics
  verbs:
  - get
---
# 然后做集群角色绑定，把集群角色跟SA绑定在一起即可
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: prometheus
roleRef:
  apiGroup: rbac.authorization.k8s.io  # 使用这个API
  kind: ClusterRole   # 指定绑定的ClusterRole名字是prometheus
  name: prometheus
subjects:  # 指定绑定的kind为ServiceAccount，name is prometheus，namespace is kube-mon
- kind: ServiceAccount
  name: prometheus
  namespace: kube-mon
# 所以现在这个namespace下的Pod就有以上权限了
</pre>
</div>
</div>
</li>
<li><a id="h:011eebc5-5bfe-48b2-80ae-9de08017ba95"></a>步骤四<br>
<div class="outline-text-7" id="text-h:011eebc5-5bfe-48b2-80ae-9de08017ba95">
<p>
然后重新apply这几个文件
</p>

<div class="org-src-container">
<pre class="src src-shell">[root@master1 prometheus]# ll
total 24
-rw-r--r-- 1 root root 1926 Feb 12 21:54 prome-node-exporter.yaml
-rw-r--r-- 1 root root  968 Feb 12 20:37 prome-redis.yaml
-rw-r--r-- 1 root root  574 Feb 12 22:11 prometheus-cm.yaml
-rw-r--r-- 1 root root 2247 Feb 12 22:52 prometheus-deploy.yaml
-rw-r--r-- 1 root root  861 Feb 12 17:30 prometheus-rbac.yaml
-rw-r--r-- 1 root root  451 Feb 12 16:28 prometheus-svc.yaml
[root@master1 prometheus]# kubectl apply -f .
</pre>
</div>
</div>
</li>
<li><a id="h:39cb3abe-3105-4bd2-bfbd-9bd3514a80e7"></a>步骤五、<br>
<div class="outline-text-7" id="text-h:39cb3abe-3105-4bd2-bfbd-9bd3514a80e7">
<p>
现在页面查看还是有问题的
</p>



<figure id="org8fa121b">
<img src="./images/img_20240604_211831.png" alt="img_20240604_211831.png" width="50%">

</figure>


<p>
我们可以看到上面的 kubernetes-nodes 这个 job 任务已经自动发现了我们5个 node 节点，但是在获取数据的时候失败了，出现了类似于下面的错误信息：
</p>

<div class="org-src-container">
<pre class="src src-shell">server returned HTTP status 400 Bad Request
</pre>
</div>

<p>
这个是因为 prometheus 去发现 Node 模式的服务的时候，访问的端口默认是10250，而默认是需要认证的 https 协议才有权访问的，但实际上我们并不是希望让去访问10250端口的 /metrics 接口，而是 node-exporter 绑定到节点的 9100 端口，所以我们应该将这里的 10250 替换成 9100，但是应该怎样替换呢？
</p>

<p>
这里我们就需要使用到 Prometheus 提供的 relabel_configs 中的 replace 能力了，relabel 可以在 Prometheus 采集数据之前，通过 Target 实例的 Metadata 信息，动态重新写入 Label 的值。除此之外，我们还能根据 Target 实例的 Metadata 信息选择是否采集或者忽略该 Target 实例。比如我们这里就可以去匹配 <code>__address__</code>  这个 Label 标签，然后替换掉其中的端口，如果你不知道有哪些 Label 标签可以操作的话，可以将鼠标🎒移动到 Targets 的标签区域，其中显示的 Before relabeling 区域都是我们可以操作的标签：
</p>


<figure id="org7d248ba">
<img src="./images/img_20240604_211948.png" alt="img_20240604_211948.png" width="50%">

</figure>


<p>
现在我们来替换掉端口，修改 ConfigMap：（此处忽略，用下面的最终版本）
</p>

<div class="org-src-container">
<pre class="src src-yaml">- job_name: 'kubernetes-nodes'
  kubernetes_sd_configs:
  - role: node
  relabel_configs:
  - source_labels: [__address__]
    regex: '(.*):10250'
    replacement: '${1}:9100'
    target_label: __address__
    action: replace
</pre>
</div>

<p>
这里就是一个正则表达式，去匹配 <code>__address__</code> 这个标签，然后将 host 部分保留下来，port 替换成了 9100，现在我们重新更新配置文件，执行 reload 操作，然后再去看 Prometheus 的 Dashboard 的 Targets 路径下面 kubernetes-nodes 这个 job 任务是否正常了：
</p>


<figure id="org6139e11">
<img src="./images/img_20240604_212022.png" alt="img_20240604_212022.png" width="50%">

</figure>


<p>
我们可以看到现在已经正常了，但是还有一个问题就是我们采集的指标数据 Label 标签就只有一个节点的 hostname，这对于我们在进行监控分组分类查询的时候带来了很多不方便的地方，要是我们能够将集群中 Node 节点的 Label 标签也能获取到就很好了。这里我们可以通过 labelmap 这个属性来将 Kubernetes 的 Label 标签添加为 Prometheus 的指标数据的标签：
</p>

<div class="org-src-container">
<pre class="src src-yaml">- job_name: 'kubernetes-nodes'
  kubernetes_sd_configs:
  - role: node
  relabel_configs:
  - source_labels: [__address__]
    regex: '(.*):10250'
    replacement: '${1}:9100'
    target_label: __address__
    action: replace
  - action: labelmap # 这个
    regex: __meta_kubernetes_node_label_(.+)
# 热更新，ip是prometheusPod的Ip
[root@master1 ~]# curl -X POST "http://10.244.1.139:9090/-/reload"
</pre>
</div>

<p>
另外由于 kubelet 也自带了一些监控指标数据，就上面我们提到的 10250 端口，所以我们这里也把 kubelet 的监控任务也一并配置上：
</p>

<div class="org-src-container">
<pre class="src src-yaml">- job_name: 'kubernetes-kubelet'
  kubernetes_sd_configs:
  - role: node
  scheme: https
  tls_config:
    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    insecure_skip_verify: true
  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
  relabel_configs:
  - action: labelmap
    regex: __meta_kubernetes_node_label_(.+)
</pre>
</div>

<p>
但是这里需要特别注意的是这里必须使用 https 协议访问，这样就必然需要提供证书，我们这里是通过配置 <code>insecure_skip_verify: true</code> 来跳过了证书校验，但是除此之外，要访问集群的资源，还必须要有对应的权限才可以，也就是对应的 ServiceAccount 棒的 权限允许才可以，我们这里部署的 prometheus 关联的 ServiceAccount 对象前面我们已经提到过了，这里我们只需要将 Pod 中自动注入的 /var/run/secrets/kubernetes.io/serviceaccount/ca.crt 和 /var/run/secrets/kubernetes.io/serviceaccount/token 文件配置上，就可以获取到对应的权限了。
</p>

<p>
现在我们再去更新下配置文件，执行 reload 操作，让配置生效，然后访问 Prometheus 的 Dashboard 查看 Targets 路径：
</p>

<div class="org-src-container">
<pre class="src src-shell">&#21040;&#36825;&#37324;&#25105;&#20204;&#23601;&#25226; Kubernetes &#38598;&#32676;&#33410;&#28857;&#20351;&#29992; Prometheus &#30417;&#25511;&#36215;&#26469;&#20102;&#65292;&#25509;&#19979;&#26469;&#25105;&#20204;&#20877;&#26469;&#21644;&#22823;&#23478;&#23398;&#20064;&#19979;&#24590;&#26679;&#30417;&#25511; Pod &#25110;&#32773; Service &#20043;&#31867;&#30340;&#36164;&#28304;&#23545;&#35937;&#12290;
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/port: <span style="color: #8b2252;">"9153"</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">metrics &#25509;&#21475;&#30340;&#31471;&#21475;</span>
    prometheus.io/scrape: <span style="color: #8b2252;">"true"</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#20010;&#27880;&#35299;&#21487;&#20197;&#35753;prometheus&#33258;&#21160;&#21457;&#29616;</span>
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:fc8ffc1c-6be6-42c8-a913-7d90faa39159" class="outline-4">
<h4 id="h:fc8ffc1c-6be6-42c8-a913-7d90faa39159">云原生应用监控</h4>
<div class="outline-text-4" id="text-h:fc8ffc1c-6be6-42c8-a913-7d90faa39159">
</div>
<div id="outline-container-h:1845e9ab-2afc-427f-ada3-0bab058a0f67" class="outline-5">
<h5 id="h:1845e9ab-2afc-427f-ada3-0bab058a0f67">etcd 集群监控</h5>
<div class="outline-text-5" id="text-h:1845e9ab-2afc-427f-ada3-0bab058a0f67">
</div>
<ul class="org-ul">
<li><a id="h:c0c08f71-192f-4fa7-8525-4f811bfa25c3"></a>查看接口信息<br>
<div class="outline-text-6" id="text-h:c0c08f71-192f-4fa7-8525-4f811bfa25c3">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">curl --cert /etc/etcd/ssl/etcd.pem --key /etc/etcd/ssl/etcd-key.pem  https://192.168.1.201:2379/metrics -k </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#26679;&#20063;&#34892;</span>
curl -L http://localhost:2379/metrics
</pre>
</div>

<p>
kubeadmin 安装的 etcd 配置可能在 /etc/kubernetes/manifests/etcd.yml 中
</p>
</div>
</li>
<li><a id="h:5f9b62ab-2d47-429b-a7b0-b6c27d528a85"></a>创建 etcd service和Endpoints<br>
<div class="outline-text-6" id="text-h:5f9b62ab-2d47-429b-a7b0-b6c27d528a85">
<p>
svc 和 endpoint 名称一样就会自动创建联接
</p>
<div class="org-src-container">
<pre class="src src-yaml"># 创建ep和svc代理外部的etcd服务，其他自带metrics接口的服务也是如此！
apiVersion: v1
kind: Endpoints
metadata:
  labels:
    app: etcd-k8s
  name: etcd-k8s
  namespace: kube-system
subsets:
- addresses:     # etcd节点对应的主机ip，有几台就写几台
  - ip: 192.168.1.201
  - ip: 192.168.1.202
  - ip: 192.168.1.203
  ports:
  - name: etcd-port
    port: 2379   # etcd端口
    protocol: TCP
---
apiVersion: v1
kind: Service 
metadata:
  labels:
    app: etcd-k8s
  name: etcd-k8s
  namespace: kube-system
spec:
  ports:
  - name: etcd-port
    port: 2379
    protocol: TCP
    targetPort: 2379
  type: ClusterIP
</pre>
</div>
</div>
</li>
<li><a id="h:14c3ac8c-aa13-4549-a062-119915c60a3e"></a>测试是否代理成功<br>
<div class="outline-text-6" id="text-h:14c3ac8c-aa13-4549-a062-119915c60a3e">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20877;&#27425;curl&#65292;&#25226;IP&#25442;&#25104;svc&#30340;IP&#27979;&#35797;&#65292;&#36755;&#20986;&#30456;&#21516;&#20869;&#23481;&#21363;&#21019;&#24314;&#25104;&#21151;</span>
[root@k8s-master01 ~]# kubectl get svc -n kube-system etcd-k8s
NAME      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
etcd-ep   ClusterIP   10.103.53.103   &lt;none&gt;        2379/TCP   8m54s

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20877;&#27425;&#35831;&#27714;&#25509;&#21475;</span>
[root@k8s-master01 ~]# curl --cert /etc/etcd/ssl/etcd.pem --key /etc/etcd/ssl/etcd-key.pem  https://10.111.200.116:2379/metrics -k
</pre>
</div>
</div>
</li>
<li><a id="h:84da2901-dd99-404d-9d44-f7c859d55e47"></a>创建 secret<br>
<div class="outline-text-6" id="text-h:84da2901-dd99-404d-9d44-f7c859d55e47">
<p>
etcd 的证书要挂载到 prometheus pod 中
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">1&#12289;&#36825;&#37324;&#25105;&#20204;k8s-master01&#33410;&#28857;&#36827;&#34892;&#21019;&#24314;,ca&#20026;k8sca&#35777;&#20070;&#65292;&#21097;&#19979;2&#20010;&#20026;etcd&#35777;&#20070;&#65292;&#36825;&#26159;&#25105;&#35777;&#20070;&#25152;&#22312;&#20301;&#32622;</span>
  cert-file: <span style="color: #8b2252;">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  key-file: <span style="color: #8b2252;">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  trusted-ca-file: <span style="color: #8b2252;">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">2&#12289;&#25509;&#19979;&#26469;&#25105;&#20204;&#38656;&#35201;&#21019;&#24314;&#19968;&#20010;secret&#65292;&#35753;prometheus pod&#33410;&#28857;&#25346;&#36733;</span>
kubectl create secret generic etcd-ssl --from-file=/etc/kubernetes/pki/etcd/etcd-ca.pem --from-file=/etc/kubernetes/pki/etcd/etcd.pem --from-file=/etc/kubernetes/pki/etcd/etcd-key.pem -n monitoring

<span style="color: #b22222;"># </span><span style="color: #b22222;">3&#12289;&#21019;&#24314;&#23436;&#25104;&#21518;&#21487;&#20197;&#26816;&#26597;&#19968;&#19979;</span>
[root@k8s-master01 prometheus-down]# kubectl describe secrets -n monitoring etcd-ssl
Name:         etcd-ssl
Namespace:    monitoring
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Type:  Opaque

Data
====
etcd-ca.pem:   1367 bytes
etcd-key.pem:  1679 bytes
etcd.pem:      1509 bytes
</pre>
</div>
</div>
</li>
<li><a id="h:4788ce90-2fea-4c2a-b404-0c27734a6240"></a>编辑prometheus，把证书挂载进去<br>
<div class="outline-text-6" id="text-h:4788ce90-2fea-4c2a-b404-0c27734a6240">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">1&#12289;&#36890;&#36807;edit&#30452;&#25509;&#32534;&#36753;prometheus</span>
[root@k8s-master01 ~]# kubectl edit prometheus k8s -n monitoring
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;replicas&#24213;&#19979;&#21152;&#19978;secret&#21517;&#31216;</span>
replicas:2
secrets:
- etcd-ssl <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;secret&#21517;&#31216;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36827;&#20837;&#23481;&#22120;&#26597;&#30475;&#65292;&#23601;&#21487;&#20197;&#30475;&#21040;&#35777;&#20070;&#25346;&#36733;&#36827;&#21435;&#20102;</span>
[root@k8s-master01 prometheus-down]# kubectl exec -it -n monitoring prometheus-k8s-0 /bin/sh

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#25991;&#20214;&#26159;&#21542;&#23384;&#22312;</span>
/prometheus $ ls /etc/prometheus/secrets/etcd-ssl/
etcd-ca.pem   etcd-key.pem  etcd.pem
</pre>
</div>
</div>
</li>
<li><a id="h:15abf503-dbfa-4094-9057-35e9385a5e7a"></a>创建ServiceMonitor<br>
<div class="outline-text-6" id="text-h:15abf503-dbfa-4094-9057-35e9385a5e7a">
<div class="org-src-container">
<pre class="src src-yaml">[root@k8s-master01 ~]# cat etcd-servicemonitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: etcd-k8s
  namespace: monitoring
  labels:
    app: etcd-k8s
spec:
  jobLabel: app
  endpoints:
    - interval: 30s
      port: etcd-port  # 这个port对应 Service.spec.ports.name
      scheme: https
      tlsConfig:
        caFile: /etc/prometheus/secrets/etcd-ssl/etcd-ca.pem #证书路径 (在prometheus pod里路径)
        certFile: /etc/prometheus/secrets/etcd-ssl/etcd.pem
        keyFile: /etc/prometheus/secrets/etcd-ssl/etcd-key.pem
        insecureSkipVerify: true  # 关闭证书校验
  selector:
    matchLabels:
      app: etcd-k8s  # 跟scv的lables保持一致
  namespaceSelector:
    matchNames:
    - kube-system    # 跟svc所在namespace保持一致
# 匹配Kube-system这个命名空间下面具有app=etcd-k8s这个label标签的Serve，job label用于检索job任务名称的标签。由于证书serverName和etcd中签发的证书可能不匹配，所以添加了insecureSkipVerify=true将不再对服务端的证书进行校验
</pre>
</div>
</div>
</li>
<li><a id="h:15fa1748-a7c3-4e48-a1e2-c46d6a4e57a6"></a>prometheus ui 页面查看三个etcd节点都获取到数据<br>
<div class="outline-text-6" id="text-h:15fa1748-a7c3-4e48-a1e2-c46d6a4e57a6">
<p>
查看 targets  状态，此处数据获取有点慢，需要等待一下
</p>
</div>
</li>
<li><a id="h:fc1d3ce1-8f7a-4d7c-bc1a-70e02c579cee"></a>grafana模板导入<br>
<div class="outline-text-6" id="text-h:fc1d3ce1-8f7a-4d7c-bc1a-70e02c579cee">
<p>
数据采集完成后，接下来可以在grafana中导入dashboard
</p>

<ul class="org-ul">
<li>打开官网来的如下图所示，点击下载JSON文件</li>
<li>grafana官网：<a href="https://grafana.com/grafana/dashboards/3070">https://grafana.com/grafana/dashboards/3070</a></li>
<li>中文版ETCD集群插件：<a href="https://grafana.com/grafana/dashboards/9733">https://grafana.com/grafana/dashboards/9733</a></li>
</ul>


<p>
点击HOME–&gt;导入模板
</p>


<figure id="orgc9acbfb">
<img src="./images/img_20240604_212133.png" alt="img_20240604_212133.png" width="50%">

</figure>


<p>
导入后页面展示
</p>


<figure id="orgb90ca89">
<img src="./images/img_20240604_212203.png" alt="img_20240604_212203.png" width="50%">

</figure>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:46de4e55-a657-43e2-b70e-e3005efaccb8" class="outline-3">
<h3 id="h:46de4e55-a657-43e2-b70e-e3005efaccb8">Prometheus监控实战</h3>
<div class="outline-text-3" id="text-h:46de4e55-a657-43e2-b70e-e3005efaccb8">
</div>
<div id="outline-container-h:9c2b7226-f947-4758-8182-31c0711d912b" class="outline-4">
<h4 id="h:9c2b7226-f947-4758-8182-31c0711d912b">Promethues 黑盒监控</h4>
<div class="outline-text-4" id="text-h:9c2b7226-f947-4758-8182-31c0711d912b">
<ul class="org-ul">
<li><b>白盒监控</b> ：监控一些内部的数据，如topic的监控数据、Redis key的大小。内部暴露的指标被称为白盒监控。比较关注的是原因。</li>

<li><b>黑盒监控</b> ：监控关注的是现象，也就是正在发生告警，是站在用户的角度看到的东西。如网站不能打开，网站打开的比较慢。比较关注现象，表示正在发生的问题，正在发生的告警。</li>
</ul>
</div>
<div id="outline-container-h:42274e08-bb3d-49a5-909d-d4a3d097f3e9" class="outline-5">
<h5 id="h:42274e08-bb3d-49a5-909d-d4a3d097f3e9">部署exporter</h5>
<div class="outline-text-5" id="text-h:42274e08-bb3d-49a5-909d-d4a3d097f3e9">
<p>
黑盒监控官网：
  <a href="https://github.com/prometheus/blackbox_exporter">https://github.com/prometheus/blackbox_exporter</a>
</p>


<ul class="org-ul">
<li>grafana  面板：<a href="https://grafana.com/grafana/dashboards/5345">https://grafana.com/grafana/dashboards/5345</a></li>
<li>配置文档：<a href="https://github.com/prometheus/blackbox_exporter/blob/master/CONFIGURATION.md">https://github.com/prometheus/blackbox_exporter/blob/master/CONFIGURATION.md</a></li>
<li>配置示例：<a href="https://github.com/prometheus/blackbox_exporter/blob/master/example.yml">https://github.com/prometheus/blackbox_exporter/blob/master/example.yml</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-blackbox-exporter-config
  namespace: monitoring
  labels:
    app: prom-blackbox-exporter
data:
  blackbox-exporter.yaml: |-
    modules:
      http_2xx:
        prober: http
        timeout: 10s
        http:
          valid_http_versions: [<span style="color: #8b2252;">"HTTP/1.1"</span>, <span style="color: #8b2252;">"HTTP/2"</span>]
          <span style="color: #b22222;"># </span><span style="color: #b22222;">[], Defaults to 2xx, 200,301,302,401,404</span>
          valid_status_codes: [200]
          method: GET
          preferred_ip_protocol: <span style="color: #8b2252;">"ip4"</span>
      http_post_2xx:
        prober: http
        http:
          method: POST
      tcp_connect:
        prober: tcp
      pop3s_banner:
        prober: tcp
        tcp:
          query_response:
          - expect: <span style="color: #8b2252;">"^+OK"</span>
          tls: true
          tls_config:
            insecure_skip_verify: false
      ssh_banner:
        prober: tcp
        tcp:
          query_response:
          - expect: <span style="color: #8b2252;">"^SSH-2.0-"</span>
      irc_banner:
        prober: tcp
        tcp:
          query_response:
          - send: <span style="color: #8b2252;">"NICK prober"</span>
          - send: <span style="color: #8b2252;">"USER prober prober prober :prober"</span>
          - expect: <span style="color: #8b2252;">"PING :([^ ]+)"</span>
            send: <span style="color: #8b2252;">"PONG ${1}"</span>
          - expect: <span style="color: #8b2252;">"^:[^ ]+ 001"</span>
      icmp:
        prober: icmp
        timeout: 3s
        icmp:
          preferred_ip_protocol: <span style="color: #8b2252;">"ip4"</span>
---
apiVersion: v1
kind: Service
metadata:
  name: prom-blackbox-exporter
  namespace: monitoring
  annotations:
    prometheus.io/scrape: <span style="color: #8b2252;">"true"</span>
  labels:
    app: prom-blackbox-exporter
spec:
  selector:
    app: prom-blackbox-exporter
  ports:
    - name: tcp-9115
      protocol: TCP
      port: 9115
      targetPort: 9115
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prom-blackbox-exporter
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prom-blackbox-exporter
  template:
    metadata:
      labels:
        app: prom-blackbox-exporter
    spec:
      nodeSelector:
        <span style="color: #483d8b;">type</span>: ops-prod-prometheus
      containers:
      - name: blackbox-exporter
        image: prom/blackbox-exporter:v0.22.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9115
        args:
        - --config.file=/etc/blackbox_exporter/config.yaml
        - --log.level=info
        - --web.listen-address=:9115
        readinessProbe:
          tcpSocket:
            port: 9115
          initialDelaySeconds: 5
          timeoutSeconds: 5
        resources:
          limits:
            cpu: 200m
            memory: 128Mi
          requests:
            cpu: 10m
            memory: 20Mi
        volumeMounts:
        - mountPath: /etc/blackbox_exporter
          name: config
          readOnly: true
      - args:
        - --webhook-url=http://localhost:9115/-/reload
        - --volume-dir=/etc/blackbox_exporter/
        image: jimmidyson/configmap-reload:v0.5.0
        name: module-configmap-reloader
        resources:
          limits:
            cpu: 20m
            memory: 40Mi
          requests:
            cpu: 10m
            memory: 20Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 65534
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /etc/blackbox_exporter/
          name: config
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: prom-blackbox-exporter-config
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1c167782-245a-4c94-9803-5a8d33a4ee23" class="outline-5">
<h5 id="h:1c167782-245a-4c94-9803-5a8d33a4ee23">additional 传统监控</h5>
<div class="outline-text-5" id="text-h:1c167782-245a-4c94-9803-5a8d33a4ee23">
<div class="org-src-container">
<pre class="src src-yaml"># 测试exporter是否正常
# 查看svc的IP
[root@k8s-master01 ~]# kubectl get svc -n monitoring  blackbox-exporter
NAME                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE
blackbox-exporter   ClusterIP   10.100.9.18   &lt;none&gt;        9115/TCP   30m

# curl一下exporter的svc
[root@k8s-master01 ~]# curl "http://10.100.9.18:9115/probe?target=baidu.com&amp;module=http_2xx"
</pre>
</div>
</div>
<ul class="org-ul">
<li><a id="h:c04d2233-59ea-4a34-b376-55242d22620a"></a>2.1、添加个监控测试<br>
<div class="outline-text-6" id="text-h:c04d2233-59ea-4a34-b376-55242d22620a">
<div class="org-src-container">
<pre class="src src-yaml">[root@k8s-master01 prometheus-down]# vim prometheus-additional.yaml
- job_name: 'blackbox-http'
  scrape_interval: 10s
  scrape_timeout: 5s
  metrics_path: /probe
  params:
    modelue: [http_2xx]
  static_configs:
  - targets:
      - https://ateway-prod.xxx.com/api/getConfig
      - https://front.xxx.com/prod/220512133528/V0.0.1_PRO/hotfix/res/import/00/008c78d7-bb49-46eb-bab5-a6a885ecfe0c.json
    labels:
      product_line: ludo
      severity: info
  relabel_configs:  # label 重写，将src label 的值赋值给 target label
  - source_labels: [__address__]
    target_label: __param_target
  - source_labels: [__param_target]
    target_label: instance
  - target_label: __address__
    replacement: prom-blackbox-exporter:9115  #blackbox-exporter 所在的机器和端口
  - source_labels:
    - instance
    regex: https://(gateway-prod.xxx.com|front.xxx.com)([\.\_\-/a-zA-Z0-9]*)?(.*)
    replacement: "${2}"
    target_label: path

# Then you will need to make a secret out of this configuration.
# kubectl create secret generic additional-scrape-configs --from-file=prometheus-additional.yaml --dry-run -oyaml &gt; additional-scrape-configs.yaml

# 创建Secret
# kubectl apply -f  additional-scrape-configs.yaml  -n monitoring 
secret/additional-scrape-configs created

# 进到manifests目录，编辑
[root@k8s-master01 manifests]# vim prometheus-prometheus.yaml 
apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: prometheus
  labels:
    prometheus: prometheus
spec:
  replicas: 2
... 加上下面3行
  additionalScrapeConfigs:
    name: additional-scrape-configs
    key: prometheus-additional.yaml
...

# replace 刚刚修改的文件
[root@k8s-master01 manifests]# kubectl replace -f  prometheus-prometheus.yaml  -n monitoring

# 手动删除 pod、使之重新构建
[root@k8s-master01 manifests]# kubectl delete po  prometheus-k8s-0  prometheus-k8s-1  -n monitoring 
</pre>
</div>

<p>
查看是否成功加载配置：
</p>


<p>
数据查看：
</p>

<p>
probe 开头
</p>


<figure id="org4e9aadb">
<img src="./images/img_20240604_212256.png" alt="img_20240604_212256.png" width="50%">

</figure>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:f2e8f400-5040-4d62-86c0-6a8098e2fc8b" class="outline-4">
<h4 id="h:f2e8f400-5040-4d62-86c0-6a8098e2fc8b">Prometheus 静态配置</h4>
<div class="outline-text-4" id="text-h:f2e8f400-5040-4d62-86c0-6a8098e2fc8b">
</div>
<div id="outline-container-h:b67eb122-6ed3-4729-9042-153666b80a3b" class="outline-5">
<h5 id="h:b67eb122-6ed3-4729-9042-153666b80a3b">additionalScrapeConfigs</h5>
<div class="outline-text-5" id="text-h:b67eb122-6ed3-4729-9042-153666b80a3b">
<p>
首先创建一个空文件，然后通过该文件创建一个 Secret， 那么这个 Secret 即可作为 Prometheus 的静态配置：
</p>

<div class="org-src-container">
<pre class="src src-shell">touch prometheus-additional.yaml
kubectl create secret generic additional-configs --from-file=prometheus-additional.yaml
</pre>
</div>

<p>
创建完 Secret 后，需要编辑下 Promeheus 配置：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#  </span><span style="color: #b22222;">kubectl edit prometheus -n monitoring k8s</span>
apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: k8s
spec:
  replicas: 2
... &#21152;&#19978;&#19979;&#38754;3&#34892;
  additionalScrapeConfigs:
    name: additional-configs
    key: prometheus-additional.yaml
    optional: true
...
</pre>
</div>

<p>
添加上述配置后保存退出，无需重启 Prometheus 的 Pod 即可生效。 之后在 prometheus-additional.yaml 文件内编辑 一些静态配置。如上文的黑盒配置。
</p>
</div>
</div>
</div>
<div id="outline-container-h:f17f34a7-46d9-412c-a5c0-f7cc5c9e0fd4" class="outline-4">
<h4 id="h:f17f34a7-46d9-412c-a5c0-f7cc5c9e0fd4">Prometheus 监控 Windows（外部）主机</h4>
<div class="outline-text-4" id="text-h:f17f34a7-46d9-412c-a5c0-f7cc5c9e0fd4">
<p>
官方文档：<a href="https://github.com/prometheus-community/windows_exporter">https://github.com/prometheus-community/windows_exporter</a>
</p>

<p>
windows exporter 会暴露一个9182端口来提供监控数据。
</p>
</div>
</div>
<div id="outline-container-h:95aac4c8-4613-45cf-a8b7-768cff7c71a0" class="outline-4">
<h4 id="h:95aac4c8-4613-45cf-a8b7-768cff7c71a0">自动发现注册服务</h4>
<div class="outline-text-4" id="text-h:95aac4c8-4613-45cf-a8b7-768cff7c71a0">
</div>
<div id="outline-container-h:84d0c7ae-89d5-415a-be0f-72d719939821" class="outline-5">
<h5 id="h:84d0c7ae-89d5-415a-be0f-72d719939821">正则表达式</h5>
<div class="outline-text-5" id="text-h:84d0c7ae-89d5-415a-be0f-72d719939821">
<p>
正则表达式-元字符：<a href="https://www.runoob.com/regexp/regexp-metachar.html">https://www.runoob.com/regexp/regexp-metachar.html</a>
</p>

<div class="org-src-container">
<pre class="src src-yaml">- source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]  # 172.16.202.106:53;9153
  separator: ;
  regex: ([^:]+)(?::\d+)?;(\d+)
  target_label: __address__
  replacement: $1:$2
  action: replace
</pre>
</div>

<p>
其中 (?::\d+) 表示匹配 :[0-9]+ 但不获取匹配结果，所以 <code>$1:$2</code> 就等于 172.16.202.106:9153
</p>

<p>
如果 <code>regex: ([^:]+)(:\d+)?;(\d+)</code> ，替换的值$1:$2就等于 172.16.202.106:53
</p>
</div>
</div>
<div id="outline-container-h:41ac00f3-8053-403d-b270-e8eb19bb6e9b" class="outline-5">
<h5 id="h:41ac00f3-8053-403d-b270-e8eb19bb6e9b">参数说明</h5>
<div class="outline-text-5" id="text-h:41ac00f3-8053-403d-b270-e8eb19bb6e9b">
<div class="org-src-container">
<pre class="src src-yaml">- job_name: 'node-exporter-discovery'
  kubernetes_sd_configs:
  - role: node
  relabel_configs:
  - separator: ;
    regex: __meta_kubernetes_node_label_(.+)
    replacement: $1
    action: labelmap
  - source_labels: [__address__]
    regex: '(.*):10250'
    replacement: '${1}:9100'
    target_label: __address__
    action: replace
  metric_relabel_configs:
  - source_labels: [ __name__ ]
    regex: (node_namespace_pod_container:container_memory_rss|node_namespace_pod_container:container_memory_working_set_bytes|node_namespace_pod_container:container_memory_cache|node_scrape_collector_duration_seconds|node_scrape_collector_success|node_cpu_core_throttles_total|node_cpu_guest_seconds_total|node_ipvs_backend_connections_active|node_ipvs_backend_weight|node_ipvs_backend_connections_inactive|node_filesystem_device_error|node_cpu_core_throttles_total|node_nfs_requests_total|node_scrape_collector_success|node_scrape_collector_duration_seconds|node_cpu_scaling_frequency_min_hrts|node_cpu_scaling_frequency_hertz|node_cpu_frequency_max_hertz|node_cpu_scaling_frequency_max_hrts|node_cpu_frequency_min_hertz)
    action: drop

- job_name: 'prometheus-k8s'
  scrape_interval: 60s
  scrape_timeout: 10s
  honor_labels: true
  metrics_path: '/k8s/federate'
  params:
    'match[]':
      - '{job="node-exporter"}'
      - '{job=~"kube-.*"}'
  static_configs:
    - targets:
      - 'prometheus.xxx.com'


- consul_sd_configs:
  - server: consul-server.consul:8500
  job_name: consul-exporter
  relabel_configs:
  - action: replace
    source_labels:
    - __meta_consul_service_metadata_Application
    target_label: application
  - action: replace
    source_labels:
    - __meta_consul_service_metadata_Environment
    target_label: environment
  - action: replace
    source_labels:
    - __meta_consul_service_metadata_SubModule
    target_label: subModule
  - action: replace
    source_labels:
    - __meta_consul_service_metadata_Usage
    target_label: usage
  - action: replace
    source_labels:
    - __meta_consul_service_metadata_instanceID
    target_label: instanceID
</pre>
</div>

<p>
官方文档：<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config</a>
</p>

<p>
<a href="https://cloud.tencent.com/document/product/1416/55995">https://cloud.tencent.com/document/product/1416/55995</a>
</p>

<ul class="org-ul">
<li>honor_timestamps：是否以 target 上报时间为准，默认为 true。</li>
</ul>
</div>
</div>
<div id="outline-container-h:f937880c-b862-4afe-92a1-74b926a9ddae" class="outline-5">
<h5 id="h:f937880c-b862-4afe-92a1-74b926a9ddae">自动发现 node-export 和 kubelet</h5>
<div class="outline-text-5" id="text-h:f937880c-b862-4afe-92a1-74b926a9ddae">
<div class="org-src-container">
<pre class="src src-yaml">- job_name: node-exporter
  honor_timestamps: true
  scrape_interval: 15s
  scrape_timeout: 10s
  metrics_path: /metrics
  scheme: http
  follow_redirects: true
  kubernetes_sd_configs:
  - role: node
    kubeconfig_file: ""
    follow_redirects: true
  relabel_configs:
  - source_labels: [__address__] # node 的 __address__  是节点ip:10250
    separator: ;
    regex: (.*):10250
    target_label: __address__
    replacement: $1:9100
    action: replace

- job_name: kubernetes-kubelet
  kubernetes_sd_configs:
  - role: node
  relabel_configs:
  - separator: ;
    regex: __meta_kubernetes_node_label_(.+)
    replacement: $1
    action: labelmap
  - separator: ;
    regex: '(.*):10250'
    target_label: __address__
    replacement: '${1}:10250'
    action: replace
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cd1b702f-c009-48f5-9e12-0eb041f8a746" class="outline-5">
<h5 id="h:cd1b702f-c009-48f5-9e12-0eb041f8a746">必要的步骤</h5>
<div class="outline-text-5" id="text-h:cd1b702f-c009-48f5-9e12-0eb041f8a746">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">deploymnet &#20013; pod &#26631;&#31614;</span>
spec:
  template:
    metadata:
      annotations:
        prometheus.io/pathjvm: /actuator/prometheus
        prometheus.io/portjvm: <span style="color: #8b2252;">"8099"</span>
        prometheus.io/scrapejvm: <span style="color: #8b2252;">"true"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">prometheus &#37197;&#32622;</span>
      - source_labels: [__meta_kubernetes_pod_container_name]
        regex: <span style="color: #8b2252;">"filebeat.*"</span>
        action: drop   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21435;&#25481;&#19981;&#38656;&#35201;&#23481;&#22120;</span>
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrapejvm]
        action: keep
        regex: true  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25214;&#21040; prometheus.io/scrapejvm: "true" &#30340; pod</span>
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_pathjvm]
        action: replace
        target_label: __metrics_path__
        regex: (<span style="color: #483d8b;">.</span>+)    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25214;&#21040; prometheus.io/pathjvm: /actuator/prometheus &#30340;&#36335;&#24452;&#20316;&#20026; metrics</span>
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_portjvm]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $<span style="color: #a0522d;">1</span>:$<span style="color: #a0522d;">2</span>
        target_label: __address__  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25214;&#21040; prometheus.io/portjvm: "8099" &#25152;&#35774;&#32622;&#30340;&#31471;&#21475;&#65292;&#25340;&#25509;&#21040; __address__</span>
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(<span style="color: #483d8b;">.</span>+) <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#23558; pod &#30340;&#26631;&#31614;&#26144;&#23556;&#21040; metrcis &#20013;</span>
</pre>
</div>

<ul class="org-ul">
<li>对应资源（Service, Pod, Ingress 等）添加注释信息，指定暴露的参数</li>
<li>prometheus 配置文件添加自动发现配置，匹配资源暴露的参数，必要的参数有
<ul class="org-ul">
<li>服务发现类型：如 kubernetes_sd_config、consul_sd_config 等</li>
<li>可选，匹配资源标签并保留下来，如 pod 标签为  prometheus.io/scrapejvm: "true"</li>
<li><code>__address__</code> 请求地址</li>
<li><code>__metrics_path__</code>  请求的 metrics 路径</li>
</ul></li>
</ul>

<p>
可以从 prometheus ui 中 service-discovery 查看自带的标签
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-h:507e3211-f74e-4ea6-b827-0ac08b91e0d2" class="outline-3">
<h3 id="h:507e3211-f74e-4ea6-b827-0ac08b91e0d2">Prometheus 语法 PromQL</h3>
<div class="outline-text-3" id="text-h:507e3211-f74e-4ea6-b827-0ac08b91e0d2">
</div>
<div id="outline-container-h:ebe9dbb3-a7b8-4d78-be1f-e2a7786ee7c1" class="outline-4">
<h4 id="h:ebe9dbb3-a7b8-4d78-be1f-e2a7786ee7c1">PromQL 语法体验</h4>
<div class="outline-text-4" id="text-h:ebe9dbb3-a7b8-4d78-be1f-e2a7786ee7c1">
<p>
PromQL Web UI 的 Graph 选项卡提供了简单的用于查询数据的入口，对于 PromQL 的编写和校验都可以在此位置。
</p>
</div>
<div id="outline-container-h:0a32ef10-305d-476f-a729-605db7808c75" class="outline-5">
<h5 id="h:0a32ef10-305d-476f-a729-605db7808c75">Prometheus Metrics类型</h5>
<div class="outline-text-5" id="text-h:0a32ef10-305d-476f-a729-605db7808c75">
<p>
Prometheus 的客户端库中提供了四种核心的指标类型。但这些类型只是在客户端库（客户端可以根据不同的数据类型调用不同的 API 接口）和在线协议中，实际在 Prometheus server 中并不对指标类型进行区分，而是简单地把这些指标统一视为无类型的时间序列
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">summary&#31867;&#22411;</span>
[root@ip-172-21-39-120 prometheus]# curl -s 172.21.39.111:9090/111/metrics |grep go_gc_duration_seconds -C5
<span style="color: #b22222;"># </span><span style="color: #b22222;">HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">TYPE go_gc_duration_seconds summary</span>
go_gc_duration_seconds{<span style="color: #a0522d;">quantile</span>=<span style="color: #8b2252;">"0"</span>} 1.421e-05
go_gc_duration_seconds{<span style="color: #a0522d;">quantile</span>=<span style="color: #8b2252;">"0.25"</span>} 5.5171e-05
go_gc_duration_seconds{<span style="color: #a0522d;">quantile</span>=<span style="color: #8b2252;">"0.5"</span>} 6.2903e-05
go_gc_duration_seconds{<span style="color: #a0522d;">quantile</span>=<span style="color: #8b2252;">"0.75"</span>} 8.665e-05
go_gc_duration_seconds{<span style="color: #a0522d;">quantile</span>=<span style="color: #8b2252;">"1"</span>} 0.004545852
go_gc_duration_seconds_sum 88.949090905
go_gc_duration_seconds_count 1.062595e+06
</pre>
</div>
<p>
HELP：说明
TYPE：metrics类型
如果存储到数据中，格式如下：
alertmanager_alerts_invalid_total{version="v1"}@139383232  0
</p>
</div>
</div>
<div id="outline-container-h:d4eb1955-8361-4bd7-a250-105aae0cefee" class="outline-5">
<h5 id="h:d4eb1955-8361-4bd7-a250-105aae0cefee">Metrics指标类型</h5>
<div class="outline-text-5" id="text-h:d4eb1955-8361-4bd7-a250-105aae0cefee">
</div>
<ul class="org-ul">
<li><a id="h:3157d636-3133-47e3-9745-e5c844aa2c8d"></a>2.1、Counter （计数器）<br>
<div class="outline-text-6" id="text-h:3157d636-3133-47e3-9745-e5c844aa2c8d">
<p>
<b>Counter 类型代表一种样本数据单调递增的指标，即只增不减，除非监控系统发生了重置</b>
</p>

<p>
例如，你可以使用 counter 类型的指标来表示**服务的请求数、已完成的任务数、错误发生的次数等。counter 主要有两个方法：
</p>

<div class="org-src-container">
<pre class="src src-shell">//&#23558;counter&#20540;&#21152;1.
<span style="color: #0000ff;">Inc</span>()

// &#23558;&#25351;&#23450;&#20540;&#21152;&#21040;counter&#20540;&#19978;&#65292;&#22914;&#26524;&#25351;&#23450;&#20540;&lt;0 &#20250;panic.
<span style="color: #0000ff;">Add</span>(float64)
</pre>
</div>

<p>
Counter 类型数据可以让用户方便的了解事件产生的速率的变化，在 PromQL 内置的相关操作函数可以提供相应的分析，比如以 HTTP 应用请求量来进行说明：
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">//&#36890;&#36807;rate</span>()&#20989;&#25968;&#33719;&#21462;HTTP&#35831;&#27714;&#37327;&#30340;&#22686;&#38271;&#29575;
<span style="color: #0000ff;">rate</span>(http_requests_total[5m])

//&#26597;&#35810;&#24403;&#21069;&#31995;&#32479;&#20013;&#65292;&#35775;&#38382;&#37327;&#21069;10&#30340;HTTP&#22320;&#22336;
<span style="color: #0000ff;">topk</span>(10, http_requests_total)
</pre>
</div>

<p>
不要将 counter 类型应用于样本数据非单调递增的指标，**例如：当前运行的进程数量（应该用 Guage 类型）。
</p>
</div>
</li>
<li><a id="h:fde38788-6699-43be-b0ae-f2a3a2a9ba93"></a>2.2、Guage（ 仪表盘）<br>
<div class="outline-text-6" id="text-h:fde38788-6699-43be-b0ae-f2a3a2a9ba93">
<p>
Guage 类型代表一种样本数据可以任意变化的指标，即可增可减。guage 通常用于像温度或者内存使用率这种指标数据，也可以表示能随时增加或减少的“总数”，例如：当前并发请求的数量。
</p>

<p>
对于 Gauge 类型的监控指标，通过 PromQL 内置函数 [delta()]可以获取样本在一段时间内的变化情况，**例如，计算 CPU 温度在两小时内的差异：
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">dalta</span>(cpu_temp_celsius{<span style="color: #a0522d;">host</span>=<span style="color: #8b2252;">"zeus"</span>}[2h])
</pre>
</div>

<p>
你还可以通过PromQL 内置函数 [predict_linear()]基于简单线性回归的方式，对样本数据的变化趋势做出预测。例如，基于 2 小时的样本数据，来预测主机可用磁盘空间在 4 个小时之后的剩余情况：
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">predict_linear</span>(node_filesystem_free{<span style="color: #a0522d;">job</span>=<span style="color: #8b2252;">"node"</span>}[2h], 4 * 3600) &lt; 0
</pre>
</div>
</div>
</li>
<li><a id="h:5fe14672-67d4-4327-aaf8-f8665f59e8bd"></a>2.3、 Histogram（直方图）<br>
<div class="outline-text-6" id="text-h:5fe14672-67d4-4327-aaf8-f8665f59e8bd">
<p>
参考：一文搞懂 Prometheus 的直方图 <a href="https://www.cnblogs.com/ryanyangcs/p/11309373.html">https://www.cnblogs.com/ryanyangcs/p/11309373.html</a>
</p>

<p>
在大多数情况下人们都倾向于使用某些量化指标的平均值，例如 CPU 的平均使用率、页面的平均响应时间。这种方式的问题很明显，以系统 API 调用的平均响应时间为例：如果大多数 API 请求都维持在 100ms 的响应时间范围内，而个别请求的响应时间需要 5s，那么就会导致某些 WEB 页面的响应时间落到中位数的情况，而这种现象被称为**长尾问题**。
</p>

<p>
为了区分是平均的慢还是长尾的慢，最简单的方式就是按照请求延迟的范围进行分组。例如，统计延迟在 0~10ms 之间的请求数有多少而 10~20ms 之间的请求数又有多少。通过这种方式可以快速分析系统慢的原因。Histogram 和 Summary 都是为了能够解决这样问题的存在，通过 Histogram 和 Summary 类型的监控指标，我们可以快速了解监控样本的分布情况。
</p>

<p>
Histogram 在一段时间范围内对数据进行采样（通常是请求持续时间或响应大小等），并将其计入可配置的存储桶（bucket）中，后续可通过指定区间筛选样本，也可以统计样本总数，最后一般将数据展示为直方图。
</p>

<p>
Histogram 类型的样本会提供三种指标（假设指标名称为 =&lt;basename&gt;=）：
</p>

<ul class="org-ul">
<li>样本的值分布在 bucket 中的数量，命名为 <code>&lt;basename&gt;_bucket{le="&lt;上边界&gt;"}</code> 。解释的更通俗易懂一点，这个值表示指标值小于等于上边界的所有样本数量。</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">// &#22312;&#24635;&#20849;2&#27425;&#35831;&#27714;&#24403;&#20013;&#12290;http &#35831;&#27714;&#21709;&#24212;&#26102;&#38388; &lt;=0.005 &#31186; &#30340;&#35831;&#27714;&#27425;&#25968;&#20026;0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.005"</span>,} 0.0
// &#22312;&#24635;&#20849;2&#27425;&#35831;&#27714;&#24403;&#20013;&#12290;http &#35831;&#27714;&#21709;&#24212;&#26102;&#38388; &lt;=0.01 &#31186; &#30340;&#35831;&#27714;&#27425;&#25968;&#20026;0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.01"</span>,} 0.0
// &#22312;&#24635;&#20849;2&#27425;&#35831;&#27714;&#24403;&#20013;&#12290;http &#35831;&#27714;&#21709;&#24212;&#26102;&#38388; &lt;=0.025 &#31186; &#30340;&#35831;&#27714;&#27425;&#25968;&#20026;0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.025"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.05"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.075"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.1"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.25"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.5"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.75"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"1.0"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"2.5"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"5.0"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"7.5"</span>,} 2.0
// &#22312;&#24635;&#20849;2&#27425;&#35831;&#27714;&#24403;&#20013;&#12290;http &#35831;&#27714;&#21709;&#24212;&#26102;&#38388; &lt;=10 &#31186; &#30340;&#35831;&#27714;&#27425;&#25968;&#20026; 2
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"10.0"</span>,} 2.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"+Inf"</span>,} 2.0
</pre>
</div>

<ul class="org-ul">
<li>所有样本值的大小总和，命名为 <code>&lt;basename&gt;_sum</code> 。</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">// &#23454;&#38469;&#21547;&#20041;&#65306; &#21457;&#29983;&#30340;2&#27425; http &#35831;&#27714;&#24635;&#30340;&#21709;&#24212;&#26102;&#38388;&#20026; 13.107670803000001 &#31186;
io_namespace_http_requests_latency_seconds_histogram_sum{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,} 13.107670803000001
</pre>
</div>

<ul class="org-ul">
<li>样本总数，命名为 <code>&lt;basename&gt;_count</code> 。值和 <code>&lt;basename&gt;_bucket{le="+Inf"}</code> 相同。</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">// &#23454;&#38469;&#21547;&#20041;&#65306; &#24403;&#21069;&#19968;&#20849;&#21457;&#29983;&#20102; 2 &#27425; http &#35831;&#27714;
io_namespace_http_requests_latency_seconds_histogram_count{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,} 2.0
</pre>
</div>

<p>
<b><b>注意</b></b>
</p>
<ul class="org-ul">
<li>bucket 可以理解为是对数据指标值域的一个划分，划分的依据应该基于数据值的分布。注意后面的采样点是包含前面的采样点的，假设 <code>xxx_bucket{...,le="0.01"}</code> 的值为 10，而 <code>xxx_bucket{...,le="0.05"}</code> 的值为 30，那么意味着这 30 个采样点中，有 10 个是小于 10 ms 的，其余 20 个采样点的响应时间是介于 10 ms 和 50 ms 之间的。</li>
</ul>

<p>
可以通过 <a href="https://www.yangcs.net/prometheus/3-prometheus/functions.html#histogramquantile">histogram_quantile() 函数</a>来计算 Histogram 类型样本的<a href="https://www.wikiwand.com/zh-hans/%E5%88%86%E4%BD%8D%E6%95%B0">分位数</a>。分位数可能不太好理解，你可以理解为分割数据的点。我举个例子，假设样本的 9 分位数（quantile=0.9）的值为 x，即表示小于 x 的采样值的数量占总体采样值的 90%。Histogram 还可以用来计算应用性能指标值<a href="https://www.wikiwand.com/en/Apdex">Apdex score</a>。
</p>
</div>
</li>
<li><a id="h:3f09f685-9b6e-46d4-93f4-80dca66bdd3c"></a>2.4、Summary（摘要）<br>
<div class="outline-text-6" id="text-h:3f09f685-9b6e-46d4-93f4-80dca66bdd3c">
<p>
与 Histogram 类型类似，用于表示一段时间内的数据采样结果（通常是请求持续时间或响应大小等），但它直接存储了分位数（通过客户端计算，然后展示出来），而不是通过区间来计算。
</p>

<p>
Summary 类型的样本也会提供三种指标（假设指标名称为 ）：
</p>

<ul class="org-ul">
<li>样本值的分位数分布情况，命名为 <code>&lt;basename&gt;{quantile="&lt;φ&gt;"}</code> 。</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">// &#21547;&#20041;&#65306;&#36825; 12 &#27425; http &#35831;&#27714;&#20013;&#26377; 50% &#30340;&#35831;&#27714;&#21709;&#24212;&#26102;&#38388;&#26159; 3.052404983s
io_namespace_http_requests_latency_seconds_summary{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">quantile</span>=<span style="color: #8b2252;">"0.5"</span>,} 3.052404983
// &#21547;&#20041;&#65306;&#36825; 12 &#27425; http &#35831;&#27714;&#20013;&#26377; 90% &#30340;&#35831;&#27714;&#21709;&#24212;&#26102;&#38388;&#26159; 8.003261666s
io_namespace_http_requests_latency_seconds_summary{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">quantile</span>=<span style="color: #8b2252;">"0.9"</span>,} 8.003261666
</pre>
</div>

<ul class="org-ul">
<li>所有样本值的大小总和，命名为 <code>&lt;basename&gt;_sum</code> 。</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">// &#21547;&#20041;&#65306;&#36825;12&#27425; http &#35831;&#27714;&#30340;&#24635;&#21709;&#24212;&#26102;&#38388;&#20026; 51.029495508s
io_namespace_http_requests_latency_seconds_summary_sum{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,} 51.029495508
</pre>
</div>

<ul class="org-ul">
<li>样本总数，命名为 <code>&lt;basename&gt;_count</code> 。</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">// &#21547;&#20041;&#65306;&#24403;&#21069;&#19968;&#20849;&#21457;&#29983;&#20102; 12 &#27425; http &#35831;&#27714;
io_namespace_http_requests_latency_seconds_summary_count{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,} 12.0
</pre>
</div>

<p>
现在可以总结一下 Histogram 与 Summary 的异同：
</p>

<ul class="org-ul">
<li>它们都包含了 <code>&lt;basename&gt;_sum</code> 和 <code>&lt;basename&gt;_count</code> 指标</li>
<li>Histogram 需要通过 <code>&lt;basename&gt;_bucket</code> 来计算分位数，而 Summary 则直接存储了分位数的值。</li>
</ul>

<p>
关于 Summary 与 Histogram 的详细用法，请参考 <a href="https://prometheus.io/docs/practices/histograms">histograms and summaries</a>。
</p>

<p>
不同语言关于 Summary 的客户端库使用文档：
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:31a4e901-b8a7-4b6b-aa08-0f13f466ed8b" class="outline-5">
<h5 id="h:31a4e901-b8a7-4b6b-aa08-0f13f466ed8b">数据模型</h5>
<div class="outline-text-5" id="text-h:31a4e901-b8a7-4b6b-aa08-0f13f466ed8b">
<p>
Prometheus 所有采集的监控数据均以指标（metric）的形式**保存在内置的时间序列数据库当中（TSDB）**：属于同一指标名称，同一标签集合的、有时间戳标记的数据流。除了存储的时间序列，Prometheus 还可以根据查询请求产生临时的、衍生的时间序列作为返回结果。
</p>
</div>
<ul class="org-ul">
<li><a id="h:60d2a1c7-6132-4095-8e0c-c636a082ffe8"></a>3.1、指标名称和标签<br>
<div class="outline-text-6" id="text-h:60d2a1c7-6132-4095-8e0c-c636a082ffe8">
<p>
每一条时间序列由指标名称（Metrics Name）以及一组标签（键值对）唯一标识。其中指标的名称（metric name）可以反映被监控样本的含义（例如， <code>http_requests_total</code> — 表示当前系统接收到的 HTTP 请求总量），指标名称只能由 ASCII 字符、数字、下划线以及冒号组成，同时必须匹配正则表达式 <code>[a-zA-Z_:][a-zA-Z0-9_:]*</code> 。
</p>


<p>
（时间序列[唯一标识]）=指标名称+标签）
</p>

<p>
注意：
  冒号用来表示用户自定义的记录规则，不能在 exporter 中或监控对象直接暴露的指标中使用冒号来定义指标名称。
</p>


<p>
通过使用标签，Prometheus 开启了强大的多维数据模型：对于相同的指标名称，通过不同标签列表的集合，会形成特定的度量维度实例（例如：所有包含度量名称为 /api/tracks 的 http 请求，打上 method=POST 的标签，就会形成具体的 http 请求）。该查询语言在这些指标和标签列表的基础上进行过滤和聚合。改变任何度量指标上的任何标签值（包括添加或删除指标），都会创建新的时间序列。
</p>

<p>
标签的名称只能由 ASCII 字符、数字以及下划线组成并满足正则表达式 <code>[a-zA-Z_][a-zA-Z0-9_]*</code> 。其中以 <code>__</code> 作为前缀的标签，是系统保留的关键字，只能在系统内部使用。标签的值则可以包含任何 Unicode 编码的字符。
</p>
</div>
</li>
<li><a id="h:15b1a041-41df-4fa1-8c54-ec8bfdcd7626"></a>3.2、样本（sample）<br>
<div class="outline-text-6" id="text-h:15b1a041-41df-4fa1-8c54-ec8bfdcd7626">
<p>
在时间序列中的每一个点称为一个样本（sample），样本由以下三部分组成：
</p>

<ul class="org-ul">
<li>指标（metric）：指标名称和描述当前样本特征的 labelsets；</li>
<li>时间戳（timestamp）：一个精确到毫秒的时间戳；</li>
<li>样本值（value）： 一个 folat64 的浮点型数据表示当前样本的值。</li>
</ul>
</div>
</li>
<li><a id="h:7ca8cae1-393c-401a-9047-c5ddf6000a39"></a>3.3、表示方式<br>
<div class="outline-text-6" id="text-h:7ca8cae1-393c-401a-9047-c5ddf6000a39">
<p>
通过如下表达方式表示指定指标名称和指定标签集合的时间序列：
</p>

<div class="org-src-container">
<pre class="src src-shell">&lt;metric name&gt;{&lt;label name&gt;=&lt;label value&gt;, ...}
</pre>
</div>

<p>
例如，指标名称为 ~api_http_requests_total~，标签为 method="POST" 和 handler="/messages" 的时间序列可以表示为：
</p>

<div class="org-src-container">
<pre class="src src-shell">api_http_requests_total{<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"POST"</span>, <span style="color: #a0522d;">handler</span>=<span style="color: #8b2252;">"/messages"</span>}
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:1a8584e2-e996-41cb-80f9-865e07992975" class="outline-5">
<h5 id="h:1a8584e2-e996-41cb-80f9-865e07992975">PromQL</h5>
<div class="outline-text-5" id="text-h:1a8584e2-e996-41cb-80f9-865e07992975">
<p>
参考：<a href="https://fuckcloudnative.io/prometheus/3-prometheus/basics.html">https://fuckcloudnative.io/prometheus/3-prometheus/basics.html</a>
</p>
</div>
<ul class="org-ul">
<li><a id="h:2431a6cf-443c-479f-9089-149637a06443"></a>表达式语言数据类型<br>
<div class="outline-text-6" id="text-h:2431a6cf-443c-479f-9089-149637a06443">
<ul class="org-ul">
<li>瞬时向量：包含该时间序列中最新的一个样本值。</li>
<li>区间向量：一段时间范围内的数据。</li>
<li>标量（Scalar） - 一个浮点型的数据值。</li>
<li>字符串（String） - 一个简单的字符串值。</li>
</ul>

<p>
瞬时向量
</p>
<div class="org-src-container">
<pre class="src src-shell">&#30446;&#21069;&#20027;&#35201;&#25903;&#25345;&#20004;&#31181;&#21305;&#37197;&#27169;&#24335;&#65306;&#23436;&#20840;&#21305;&#37197;&#21644;&#27491;&#21017;&#21305;&#37197;&#12290;&#26377;&#20197;&#19979;&#20960;&#31181;&#26631;&#31614;&#21305;&#37197;&#36816;&#31639;&#31526;:
= : &#36873;&#25321;&#19982;&#25552;&#20379;&#30340;&#23383;&#31526;&#20018;&#23436;&#20840;&#30456;&#21516;&#30340;&#26631;&#31614;&#12290;
!= : &#36873;&#25321;&#19982;&#25552;&#20379;&#30340;&#23383;&#31526;&#20018;&#19981;&#30456;&#21516;&#30340;&#26631;&#31614;&#12290;
=~ : &#36873;&#25321;&#27491;&#21017;&#34920;&#36798;&#24335;&#19982;&#25552;&#20379;&#30340;&#23383;&#31526;&#20018;&#65288;&#25110;&#23376;&#23383;&#31526;&#20018;&#65289;&#30456;&#21305;&#37197;&#30340;&#26631;&#31614;&#12290;
!~ : &#36873;&#25321;&#27491;&#21017;&#34920;&#36798;&#24335;&#19982;&#25552;&#20379;&#30340;&#23383;&#31526;&#20018;&#65288;&#25110;&#23376;&#23383;&#31526;&#20018;&#65289;&#19981;&#21305;&#37197;&#30340;&#26631;&#31614;

{<span style="color: #a0522d;">job</span>=~<span style="color: #8b2252;">".*"</span>} <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38750;&#27861;&#65281;&#22240;&#20026;&#20250;&#21305;&#37197;&#21040;&#31354;&#23383;&#31526;&#20018;</span>
{<span style="color: #a0522d;">job</span>=~<span style="color: #8b2252;">".+"</span>}              <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21512;&#27861;&#65281;</span>
{<span style="color: #a0522d;">job</span>=~<span style="color: #8b2252;">".*"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"get"</span>} <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21512;&#27861;&#65281;</span>
</pre>
</div>


<p>
区间向量
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21306;&#38388;&#21521;&#37327;</span>
http_requests_total{<span style="color: #a0522d;">job</span>=<span style="color: #8b2252;">"prometheus"</span>}[5m] <span style="color: #b22222;"># </span><span style="color: #b22222;">5 &#20998;&#38047;&#20869;&#30340;&#25968;&#25454;</span>
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:d637d076-49d1-4746-b7e9-b834c507612a" class="outline-4">
<h4 id="h:d637d076-49d1-4746-b7e9-b834c507612a">PromQL 操作符</h4>
<div class="outline-text-4" id="text-h:d637d076-49d1-4746-b7e9-b834c507612a">
<p>
时间位移 offset
</p>
<ul class="org-ul">
<li>http_request_total{}[5m] offset 1d # 过去一天 5 分钟内的数据</li>
</ul>

<p>
数学运算：+ - * / % ^
</p>

<p>
范例：查看主机内存总大小（Mi）
</p>
<div class="org-src-container">
<pre class="src src-shell">&#38500;&#27861;&#65306;node_memory_MemTotal_bytes / 1024 /1024
node_memory_MemTotal_bytes / 1024 /1024 &lt; 3000
</pre>
</div>

<p>
集合运算：
</p>
<ul class="org-ul">
<li>and 且关系</li>
<li>or 并列关系</li>
<li>unless：排除</li>
</ul>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-shell">node_memory_MemTotal_bytes / 1024 /1024 &lt;= 8000 or node_memory_MemTotal_bytes / 1024 /1024 == 15421.25  
node_memory_MemTotal_bytes / 1024 /1024 &gt;= 8000  unless node_memory_MemTotal_bytes / 1024 /1024 ==  3758.59765625
</pre>
</div>

<p>
范例： 指定 UTC 时间段
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">UTC 18 &#33267; 1  &#28857;&#38388;&#65292;TPS == 0 &#25253;&#35686;</span>
<span style="color: #0000ff;">floor</span>(sum(api:mark:gateway_request_total:rate:sum)) == 0  and on() ( hour() &gt;18 or hour() &lt;1)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#38750; UTC 18 &#33267; 1  &#28857;&#38388;&#65292;TPS == 0 &#25253;&#35686;</span>
<span style="color: #0000ff;">floor</span>(sum(api:mark:gateway_request_total:rate:sum)) == 0  unless on() ( hour() &gt;18 or hour() &lt;1)
</pre>
</div>

<p>
优先级
</p>

<div class="org-src-container">
<pre class="src src-shell">^ 
* / %
+ -
==, !=, &lt;=, &lt; &gt;= &gt;
And unless
Or
</pre>
</div>


<p>
聚合操作：
</p>
<ul class="org-ul">
<li>sum (求和)</li>
<li>min (最小值)</li>
<li>max (最大值)</li>
<li>avg (平均值)</li>
<li>stddev (标准差)</li>
<li>stdvar (标准差异)</li>
<li>count (计数)</li>
<li>count_values (对 value 进行计数)</li>
<li>bottomk (样本值最小的 k 个元素)</li>
<li>topk (样本值最大的k个元素)</li>
<li>quantile (分布统计)</li>
</ul>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">sum</span>(node_memory_MemTotal_bytes) / 1024^2  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27714;&#21644;</span>
<span style="color: #0000ff;">&#26681;&#25454;&#26576;&#20010;&#23383;&#27573;&#36827;&#34892;&#32479;&#35745;sum</span>(http_request_total)  by (statuscode, handler)

<span style="color: #0000ff;">min</span>(node_memory_MemTotal_bytes)   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26368;&#23567;&#20540;  max  </span>
<span style="color: #0000ff;">avg</span>(node_memory_MemTotal_bytes)    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24179;&#22343;&#20540;avg</span>
&#26631;&#20934;&#24046;&#65306;stddev    &#26631;&#20934;&#24046;&#24322;&#65306;stdvar 
<span style="color: #0000ff;">count</span>(http_request_total) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35745;&#25968;</span>
<span style="color: #0000ff;">count_values</span>(<span style="color: #8b2252;">"count"</span>, node_memory_MemTotal_bytes)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;value&#36827;&#34892;&#32479;&#35745;&#35745;&#25968;</span>

<span style="color: #0000ff;">topk</span>(5, sum(http_request_total)  by (statuscode, handler)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21462;&#21069;N&#26465;&#26102;&#24207;</span>
<span style="color: #0000ff;">bottomk</span>(3, sum(http_request_total)  by (statuscode, handler)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21462;&#21518;N&#26465;&#26102;&#24207;</span>

&#21462;&#24403;&#21069;&#25968;&#25454;&#30340;&#20013;&#20301;&#25968;&#65292;0 -1
<span style="color: #0000ff;">quantile</span>(0.5, http_request_total)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:44ca4052-0c29-403e-a90a-a28070bcf348" class="outline-4">
<h4 id="h:44ca4052-0c29-403e-a90a-a28070bcf348">PromQL 常用函数</h4>
<div class="outline-text-4" id="text-h:44ca4052-0c29-403e-a90a-a28070bcf348">
<p>
转译用双反斜线<br>
</p>
</div>
<div id="outline-container-h:e42c4339-59ba-4875-a9ee-8c59171ed853" class="outline-5">
<h5 id="h:e42c4339-59ba-4875-a9ee-8c59171ed853">一个指标的增长率</h5>
<div class="outline-text-5" id="text-h:e42c4339-59ba-4875-a9ee-8c59171ed853">
<p>
increase：
函数获取区间向量中的第一个和最后一个样本并返回其增长量。
只能计算 counter  数据。
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#31186;&#22686;&#38271;&#29575; = 1 &#23567;&#26102;&#22686;&#38271;&#29575;&#65292;&#39318;&#23614;&#20540; / 3600</span>
<span style="color: #0000ff;">increase</span>(http_request_total{<span style="color: #a0522d;">endpoint</span>=<span style="color: #8b2252;">"http"</span>,<span style="color: #a0522d;">handler</span>=<span style="color: #8b2252;">"/datasources/proxy/:id/*"</span>,<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.244.58.200:3000"</span>,<span style="color: #a0522d;">job</span>=<span style="color: #8b2252;">"grafana"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"get"</span>,<span style="color: #a0522d;">namespace</span>=<span style="color: #8b2252;">"monitoring"</span>,<span style="color: #a0522d;">pod</span>=<span style="color: #8b2252;">"grafana-86b55cb79f-fn4ss"</span>,<span style="color: #a0522d;">service</span>=<span style="color: #8b2252;">"grafana"</span>,<span style="color: #a0522d;">statuscode</span>=<span style="color: #8b2252;">"200"</span>}[1h]) / 3600
</pre>
</div>

<p>
rate：
相对于 increase，rate 可以直接计算出某个指标在给你写时间范围的增长率，一般使用 rate 函数不会使用 increase 函数。
</p>

<p>
比如还是计算 1h 的增长率，可以用 rate 函数计算：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#29992; rate &#21516;&#26679;&#25928;&#26524;</span>
<span style="color: #0000ff;">rate</span>(http_request_total{<span style="color: #a0522d;">endpoint</span>=<span style="color: #8b2252;">"http"</span>,<span style="color: #a0522d;">handler</span>=<span style="color: #8b2252;">"/datasources/proxy/:id/*"</span>,<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.244.58.200:3000"</span>,<span style="color: #a0522d;">job</span>=<span style="color: #8b2252;">"grafana"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"get"</span>,<span style="color: #a0522d;">namespace</span>=<span style="color: #8b2252;">"monitoring"</span>,<span style="color: #a0522d;">pod</span>=<span style="color: #8b2252;">"grafana-86b55cb79f-fn4ss"</span>,<span style="color: #a0522d;">service</span>=<span style="color: #8b2252;">"grafana"</span>,<span style="color: #a0522d;">statuscode</span>=<span style="color: #8b2252;">"200"</span>}[1h])
</pre>
</div>


<p>
长尾效应，increase，rate 有同样的问题，对于有激增的会影响结果。会用下面 irate 解决。
</p>

<p>
irate： 瞬时增长率，取最后两个数据进行计算，不适合做需要分期长期趋势或者在告警规则中使用，因为比如 prometheus 15s 收集一次数据，检查最近 60s 内的数据会有 4 个结果，用 irate 只能用最后两个数据。长期的使用用 rate 可以使用 60s 内所有采集点数据。
</p>
</div>
</div>
<div id="outline-container-h:73136684-06a7-4cf2-b624-bb9e09aa0b92" class="outline-5">
<h5 id="h:73136684-06a7-4cf2-b624-bb9e09aa0b92">预测统计：</h5>
<div class="outline-text-5" id="text-h:73136684-06a7-4cf2-b624-bb9e09aa0b92">
<p>
predict_linear
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#25454;&#19968;&#22825;&#30340;&#25968;&#25454;&#65292;&#39044;&#27979;4&#20010;&#23567;&#26102;&#20043;&#21518;&#65292;&#30913;&#30424;&#20998;&#21306;&#30340;&#31354;&#38388;&#20250;&#19981;&#20250;&#23567;&#20110;0</span>
<span style="color: #0000ff;">predict_linear</span>(node_filesystem_files_free{<span style="color: #a0522d;">mountpoint</span>=<span style="color: #8b2252;">"/"</span>}[1d], 4*3600) &lt; 0
</pre>
</div>

<p>
absent()：如果样本数据不为空则返回no data，如果为空则返回1。判断数据是否在正常采集。
</p>
</div>
</div>
<div id="outline-container-h:1752ba3d-ef89-45cd-9ee7-3fcc835e70e6" class="outline-5">
<h5 id="h:1752ba3d-ef89-45cd-9ee7-3fcc835e70e6">去除小数点：</h5>
<div class="outline-text-5" id="text-h:1752ba3d-ef89-45cd-9ee7-3fcc835e70e6">
<ul class="org-ul">
<li>ceil()：四舍五入，向上取最接近的整数，2.79 为 3</li>
<li>floor：向下取， 2.79 为 2</li>
</ul>

<p>
delta()：差值 和 increase 相似
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">1 &#23567;&#26102;&#30340;&#30913;&#30424;&#24046;</span>
<span style="color: #0000ff;">delta</span>(node_filesystem_files_free[1h])
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3eabcc4b-aa43-4d81-9212-c1accaab7af3" class="outline-5">
<h5 id="h:3eabcc4b-aa43-4d81-9212-c1accaab7af3">排序：</h5>
<div class="outline-text-5" id="text-h:3eabcc4b-aa43-4d81-9212-c1accaab7af3">
<ul class="org-ul">
<li>sort：正序</li>
<li>sort_desc：倒叙</li>
</ul>
<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">sort</span>(node_filesystem_files_free)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e21789fc-4541-48df-a696-674dbd5d694a" class="outline-5">
<h5 id="h:e21789fc-4541-48df-a696-674dbd5d694a">新 label</h5>
<div class="outline-text-5" id="text-h:e21789fc-4541-48df-a696-674dbd5d694a">
<p>
label_join：将数据中的一个或多个label的值赋值给一个新 label，以后可针对新 label 做查询
</p>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558; instance, mountpoint &#36171;&#32473;&#26032; label new_label&#65292;&#29992; , &#36887;&#21495;&#26469;&#20570;&#20998;&#38548;&#31526;</span>
<span style="color: #0000ff;">label_join</span>(node_filesystem_files_free, <span style="color: #8b2252;">"new_label"</span>, <span style="color: #8b2252;">","</span>,  <span style="color: #8b2252;">"instance"</span>, <span style="color: #8b2252;">"mountpoint"</span>)
</pre>
</div>

<p>
label_replace：根据数据中的某个label值，进行正则匹配，然后赋值给新label并添加到数据中
</p>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558; instance &#20013;&#31532; 2 &#20010;&#20540;&#32473; host &#26631;&#31614;</span>
<span style="color: #0000ff;">label_replace</span>(node_filesystem_files_free, <span style="color: #8b2252;">"host"</span>,<span style="color: #8b2252;">"$2"</span>, <span style="color: #8b2252;">"instance"</span>, <span style="color: #8b2252;">"(.*)-(.*)"</span>)
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-shell">groups:
- name: cardgames
  rules:
  - alert: rummy_user_thread_pending_task
    expr: thread_pending_task{<span style="color: #a0522d;">service</span>=<span style="color: #8b2252;">"rummy-user"</span>} &gt; 100
    <span style="color: #b22222;">#</span><span style="color: #b22222;">expr: 1 - avg by (instance, job, mode) (irate(node_cpu_seconds_total{mode="idle", instance="172.21.89.124:9100"}[5m])) &gt; 0</span>
    <span style="color: #a020f0;">for</span>: 1m
    labels:
      severity: warning
      team: cardgames-rummy
    annotations:
      runbook_url: https://paytmfirstgames.atlassian.net/l/c/xxxx
      summary: <span style="color: #8b2252;">"Rummy-user thread_pending_task is too high."</span>
      description: <span style="color: #8b2252;">"warning | The thread_pending_task value of {{ $labels.service }} {{ $labels.instance }} thread \"{{ $labels.thread }}\" is {{ $value }} &gt; 100  [Time: 1m]."</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ebf11448-544f-4033-818f-50dc637f98a4" class="outline-3">
<h3 id="h:ebf11448-544f-4033-818f-50dc637f98a4">Alertmanager告警实战</h3>
<div class="outline-text-3" id="text-h:ebf11448-544f-4033-818f-50dc637f98a4">
</div>
<div id="outline-container-h:14985a1c-644e-465f-b1b5-106d3fd47468" class="outline-4">
<h4 id="h:14985a1c-644e-465f-b1b5-106d3fd47468">Alertmanager 监控报警</h4>
<div class="outline-text-4" id="text-h:14985a1c-644e-465f-b1b5-106d3fd47468">
<p>
alertmanager 是告警组件，接收 prometheus 监控的配置触发的告警
</p>

<p>
范例：prometheus.yml 告警配置
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">Alertmanager configuration</span>
alerting:
  alertmanagers:
  - static_configs:
    - targets:
       - <span style="color: #8b2252;">"127.0.0.1:9093"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span>
rule_files:
  <span style="color: #b22222;"># </span><span style="color: #b22222;">- "first_rules.yml"</span>
    - <span style="color: #8b2252;">"alerts.yaml"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0d71079c-d30e-487e-a7ef-b71182734df0" class="outline-4">
<h4 id="h:0d71079c-d30e-487e-a7ef-b71182734df0">alertmanager 配置文件解析</h4>
<div class="outline-text-4" id="text-h:0d71079c-d30e-487e-a7ef-b71182734df0">
<p>
alert 模板：<a href="https://github.com/dotbalo/k8s/blob/master/prometheus-operator/alertmanager.yaml">https://github.com/dotbalo/k8s/blob/master/prometheus-operator/alertmanager.yaml</a>
</p>

<p>
prometheus Stack 中直接改 manifests/alertmanager-secret.yaml 文件
</p>

<p>
除了修改 secrets 文件还可以使用 crd AlertmanagerConfig（0.22 版本支持）： <a href="https://github.com/prometheus-operator/prometheus-operator/blob/main/example/user-guides/alerting/alertmanager-config-example.yaml">https://github.com/prometheus-operator/prometheus-operator/blob/main/example/user-guides/alerting/alertmanager-config-example.yaml</a>
</p>

<p>
alertmanager.yaml文件说明
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">global&#22359;&#37197;&#32622;&#19979;&#30340;&#37197;&#32622;&#36873;&#39033;&#22312;&#26412;&#37197;&#32622;&#25991;&#20214;&#20869;&#30340;&#25152;&#26377;&#37197;&#32622;&#39033;&#19979;&#21487;&#35265;</span>
global:
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;Alertmanager&#20869;&#31649;&#29702;&#30340;&#27599;&#19968;&#26465;&#21578;&#35686;&#22343;&#26377;&#20004;&#31181;&#29366;&#24577;: "resolved"&#25110;&#32773;"firing". &#22312;altermanager&#39318;&#27425;&#21457;&#36865;&#21578;&#35686;&#36890;&#30693;&#21518;, &#35813;&#21578;&#35686;&#20250;&#19968;&#30452;&#22788;&#20110;firing&#29366;&#24577;,&#35774;&#32622;resolve_timeout&#21487;&#20197;&#25351;&#23450;&#22788;&#20110;firing&#29366;&#24577;&#30340;&#21578;&#35686;&#38388;&#38548;&#22810;&#38271;&#26102;&#38388;&#20250;&#34987;&#35774;&#32622;&#20026;resolved&#29366;&#24577;, &#22312;&#35774;&#32622;&#20026;resolved&#29366;&#24577;&#30340;&#21578;&#35686;&#21518;,altermanager&#19981;&#20250;&#20877;&#21457;&#36865;firing&#30340;&#21578;&#35686;&#36890;&#30693;.</span>
  resolve_timeout: 1h

  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#37038;&#20214;&#21578;&#35686;&#37197;&#32622;</span>
  smtp_smarthost: <span style="color: #8b2252;">'smtp.qq.com:465'</span>
  smtp_from: <span style="color: #8b2252;">'alert@xxx.com'</span>
  smtp_auth_username: <span style="color: #8b2252;">'aff@xxx.com'</span>
  smtp_auth_password: <span style="color: #8b2252;">'xxx'</span>
  smtp_require_tls: false  
  <span style="color: #b22222;"># </span><span style="color: #b22222;">HipChat&#21578;&#35686;&#37197;&#32622;</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">hipchat_auth_token: '123456789'</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">hipchat_auth_url: 'https://hipchat.foobar.org/'</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">wechat</span>
  wechat_api_url: <span style="color: #8b2252;">'https://qyapi.weixin.qq.com/cgi-bin/'</span>
  wechat_api_secret: <span style="color: #8b2252;">'JJ'</span>
  wechat_api_corp_id: <span style="color: #8b2252;">'ww'</span>

  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21578;&#35686;&#36890;&#30693;&#27169;&#26495;&#65292;&#23448;&#26041;&#33258;&#24102;&#27604;&#36739;&#20840;&#65292;&#27809;&#24517;&#35201;&#33258;&#24049;&#23450;</span>
templates:
- <span style="color: #8b2252;">'/etc/alertmanager/config/*.tmpl'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">route: &#26681;&#36335;&#30001;,&#35813;&#27169;&#22359;&#29992;&#20110;&#35813;&#26681;&#36335;&#30001;&#19979;&#30340;&#33410;&#28857;&#21450;&#23376;&#36335;&#30001;routes&#30340;&#23450;&#20041;. &#23376;&#26641;&#33410;&#28857;&#22914;&#26524;&#19981;&#23545;&#30456;&#20851;&#37197;&#32622;&#36827;&#34892;&#37197;&#32622;&#65292;&#21017;&#40664;&#35748;&#20250;&#20174;&#29238;&#36335;&#30001;&#26641;&#32487;&#25215;&#35813;&#37197;&#32622;&#36873;&#39033;&#12290;&#27599;&#19968;&#26465;&#21578;&#35686;&#37117;&#35201;&#36827;&#20837;route&#65292;&#21363;&#35201;&#27714;&#37197;&#32622;&#36873;&#39033;group_by&#30340;&#20540;&#33021;&#22815;&#21305;&#37197;&#21040;&#27599;&#19968;&#26465;&#21578;&#35686;&#30340;&#33267;&#23569;&#19968;&#20010;labelkey(&#21363;&#36890;&#36807;POST&#35831;&#27714;&#21521;altermanager&#26381;&#21153;&#25509;&#21475;&#25152;&#21457;&#36865;&#21578;&#35686;&#30340;labels&#39033;&#25152;&#25658;&#24102;&#30340;&lt;labelname&gt;)&#65292;&#21578;&#35686;&#36827;&#20837;&#21040;route&#21518;&#65292;&#23558;&#20250;&#26681;&#25454;&#23376;&#36335;&#30001;routes&#33410;&#28857;&#20013;&#30340;&#37197;&#32622;&#39033;match_re&#25110;&#32773;match&#26469;&#30830;&#23450;&#33021;&#36827;&#20837;&#35813;&#23376;&#36335;&#30001;&#33410;&#28857;&#30340;&#21578;&#35686;(&#30001;&#22312;match_re&#25110;&#32773;match&#19979;&#37197;&#32622;&#30340;labelkey: labelvalue&#26159;&#21542;&#20026;&#21578;&#35686;labels&#30340;&#23376;&#38598;&#20915;&#23450;&#65292;&#26159;&#30340;&#35805;&#21017;&#20250;&#36827;&#20837;&#35813;&#23376;&#36335;&#30001;&#33410;&#28857;&#65292;&#21542;&#21017;&#19981;&#33021;&#25509;&#25910;&#36827;&#20837;&#35813;&#23376;&#36335;&#30001;&#33410;&#28857;).</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#36335;&#30001;&#24212;&#35813;&#21305;&#37197;&#25152;&#26377;&#21578;&#35686;</span>
route:
  <span style="color: #b22222;"># </span><span style="color: #b22222;">1&#26465;&#25110;&#32773;&#22810;&#26465;&#21578;&#35686;&#20449;&#24687;&#20013;&#21253;&#21547; group_by &#30340;&#20998;&#32452;&#26631;&#31614;&#24402;&#19968;&#32452;&#12290; &#20363;&#22914;&#25152;&#26377;labelkey:labelvalue&#21547;cluster=A&#21450;altertname=LatencyHigh labelkey&#30340;&#21578;&#35686;&#37117;&#20250;&#34987;&#24402;&#20837;&#21333;&#19968;&#32452;&#20013;</span>
  group_by: [<span style="color: #8b2252;">'job'</span>, <span style="color: #8b2252;">'altername'</span>, <span style="color: #8b2252;">'cluster'</span>, <span style="color: #8b2252;">'service'</span>,<span style="color: #8b2252;">'severity'</span>]
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21578;&#35686;&#29366;&#24577;&#20174; pending &#21040; firing &#30495;&#27491;&#21457;&#36865;&#30340;&#31561;&#24453;&#26102;&#38388;&#12290; &#21363; &#33509;&#19968;&#32452;&#26032;&#30340;&#21578;&#35686;&#20135;&#29983;&#65292;&#21017;&#20250;&#31561;group_wait&#21518;&#20877;&#21457;&#36865;&#36890;&#30693;&#65292;&#35813;&#21151;&#33021;&#20027;&#35201;&#29992;&#20110;&#24403;&#21578;&#35686;&#22312;&#24456;&#30701;&#26102;&#38388;&#20869;&#25509;&#36830;&#20135;&#29983;&#26102;&#65292;&#22312;group_wait&#20869;&#21512;&#24182;&#20026;&#21333;&#19968;&#30340;&#21578;&#35686;&#21518;&#20877;&#21457;&#36865;</span>
  group_wait: 30s
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20877;&#27425;&#21578;&#35686;&#26102;&#38388;&#38388;&#38548;</span>
  group_interval: 5m
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#19968;&#26465;&#21578;&#35686;&#36890;&#30693;&#24050;&#25104;&#21151;&#21457;&#36865;&#65292;&#19988;&#22312;&#38388;&#38548;repeat_interval&#21518;&#65292;&#35813;&#21578;&#35686;&#20173;&#28982;&#26410;&#34987;&#35774;&#32622;&#20026;resolved&#65292;&#21017;&#20250;&#20877;&#27425;&#21457;&#36865;&#35813;&#21578;&#35686;&#36890;&#30693;</span>
  repeat_interval: 12h
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;&#21578;&#35686;&#36890;&#30693;&#25509;&#25910;&#32773;&#65292;&#20961;&#26410;&#34987;&#21305;&#37197;&#36827;&#20837;&#21508;&#23376;&#36335;&#30001;&#33410;&#28857;&#30340;&#21578;&#35686;&#22343;&#34987;&#21457;&#36865;&#21040;&#27492;&#25509;&#25910;&#32773;</span>
  receiver: <span style="color: #8b2252;">'wechat'</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19978;&#36848;route&#30340;&#37197;&#32622;&#20250;&#34987;&#20256;&#36882;&#32473;&#23376;&#36335;&#30001;&#33410;&#28857;&#65292;&#23376;&#36335;&#30001;&#33410;&#28857;&#36827;&#34892;&#37325;&#26032;&#37197;&#32622;&#25165;&#20250;&#34987;&#35206;&#30422;</span>

  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23376;&#36335;&#30001;&#26641;</span>
  routes:
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35813;&#37197;&#32622;&#36873;&#39033;&#20351;&#29992;&#27491;&#21017;&#34920;&#36798;&#24335;&#26469;&#21305;&#37197;&#21578;&#35686;&#30340;labels&#65292;&#20197;&#30830;&#23450;&#33021;&#21542;&#36827;&#20837;&#35813;&#23376;&#36335;&#30001;&#26641;</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">match_re&#21644;match&#22343;&#29992;&#20110;&#21305;&#37197;labelkey&#20026;service,labelvalue&#20998;&#21035;&#20026;&#25351;&#23450;&#20540;&#30340;&#21578;&#35686;&#65292;&#34987;&#21305;&#37197;&#21040;&#30340;&#21578;&#35686;&#20250;&#23558;&#36890;&#30693;&#21457;&#36865;&#21040;&#23545;&#24212;&#30340;receiver</span>
  - match_re:
      service: ^(foo1|foo2|baz)$
    receiver: <span style="color: #8b2252;">'wechat'</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;&#24102;&#26377;service&#26631;&#31614;&#30340;&#21578;&#35686;&#21516;&#26102;&#26377;severity&#26631;&#31614;&#26102;&#65292;&#20182;&#21487;&#20197;&#26377;&#33258;&#24049;&#30340;&#23376;&#36335;&#30001;&#65292;&#21516;&#26102;&#20855;&#26377;severity != critical&#30340;&#21578;&#35686;&#21017;&#34987;&#21457;&#36865;&#32473;&#25509;&#25910;&#32773;team-ops-mails,&#23545;severity == critical&#30340;&#21578;&#35686;&#21017;&#34987;&#21457;&#36865;&#21040;&#23545;&#24212;&#30340;&#25509;&#25910;&#32773;&#21363;team-ops-pager</span>
    <span style="color: #a020f0;">continue</span>: true <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21305;&#37197;&#21040;&#19978;&#38754;&#26465;&#20214;&#21518;&#26159;&#21542;&#32487;&#32493;&#21305;&#37197;</span>
    routes: <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23884;&#22871; routes</span>
    - match:
        severity: critical
      receiver: <span style="color: #8b2252;">'wechat'</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27604;&#22914;&#20851;&#20110;&#25968;&#25454;&#24211;&#26381;&#21153;&#30340;&#21578;&#35686;&#65292;&#22914;&#26524;&#23376;&#36335;&#30001;&#27809;&#26377;&#21305;&#37197;&#21040;&#30456;&#24212;&#30340;owner&#26631;&#31614;&#65292;&#21017;&#37117;&#40664;&#35748;&#30001;team-DB-pager&#25509;&#25910;</span>
  - match:
      service: database
    group_by: [<span style="color: #8b2252;">'job'</span>]
    <span style="color: #a020f0;">continue</span>: true
    receiver: <span style="color: #8b2252;">'wechat'</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25105;&#20204;&#20063;&#21487;&#20197;&#20808;&#26681;&#25454;&#26631;&#31614;service:database&#23558;&#25968;&#25454;&#24211;&#26381;&#21153;&#21578;&#35686;&#36807;&#28388;&#20986;&#26469;&#65292;&#28982;&#21518;&#36827;&#19968;&#27493;&#23558;&#25152;&#26377;&#21516;&#26102;&#24102;labelkey&#20026;database</span>
  - match:
      severity: critical
    receiver: <span style="color: #8b2252;">'wechat'</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25233;&#21046;&#35268;&#21017;&#65292;&#24403;&#20986;&#29616;critical&#21578;&#35686;&#26102; &#24573;&#30053;warning</span>
inhibit_rules:
- source_match:
    severity: <span style="color: #8b2252;">'critical'</span>
  target_match:
    severity: <span style="color: #8b2252;">'warning'</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">Apply inhibition if the alertname is the same.</span>
  <span style="color: #b22222;">#   </span><span style="color: #b22222;">equal: ['alertname', 'cluster', 'service']</span>
  <span style="color: #b22222;">#</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25910;&#20214;&#20154;&#37197;&#32622;</span>
receivers:
- name: <span style="color: #8b2252;">'team-ops-mails'</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#37038;&#20214;&#21578;&#35686;</span>
  email_configs:
  - to: <span style="color: #8b2252;">'dukuan@xxx.com'</span>
- name: <span style="color: #8b2252;">'wechat'</span>          <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24494;&#20449;&#21578;&#35686;</span>
  wechat_configs:
  - send_resolved: true   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25253;&#35686;&#35299;&#20915;&#30340;&#36890;&#36807;&#26159;&#21542;&#21457;&#36865;</span>
    corp_id: <span style="color: #8b2252;">'ww'</span>
    api_secret: <span style="color: #8b2252;">'JJ'</span>
    to_tag: <span style="color: #8b2252;">'1'</span>
    agent_id: <span style="color: #8b2252;">'1000002'</span>
    api_url: <span style="color: #8b2252;">'https://qyapi.weixin.qq.com/cgi-bin/'</span>
    message: <span style="color: #8b2252;">'{{ template "wechat.default.message" . }}'</span>
- name: <span style="color: #8b2252;">'xxx-slack'</span>     <span style="color: #b22222;"># </span><span style="color: #b22222;">slack &#21578;&#35686;</span>
  slack_configs:
    - api_url: <span style="color: #8b2252;">"https://hooks.slack.com/services/T02/c"</span>
      channel: <span style="color: #8b2252;">"#xxx-base-alert"</span>
      text: <span style="color: #8b2252;">"{{ range .Alerts }}{{ .Annotations.summary }}\n Value: {{ .Annotations.description }}\n{{ end }}"</span>
- name: <span style="color: #8b2252;">"default-receiver"</span>
  webhook_configs:
  - url: <span style="color: #8b2252;">'http://127.0.0.1:5000/'</span>
    send_resolved: true
<span style="color: #b22222;">#</span><span style="color: #b22222;">- name: 'team-X-pager'</span>
<span style="color: #b22222;">#  </span><span style="color: #b22222;">email_configs:</span>
<span style="color: #b22222;">#  </span><span style="color: #b22222;">- to: 'team-X+alerts-critical@example.org'</span>
<span style="color: #b22222;">#  </span><span style="color: #b22222;">pagerduty_configs:</span>
<span style="color: #b22222;">#  </span><span style="color: #b22222;">- service_key: &lt;team-X-key&gt;</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">- name: 'team-Y-mails'</span>
<span style="color: #b22222;">#  </span><span style="color: #b22222;">email_configs:</span>
<span style="color: #b22222;">#  </span><span style="color: #b22222;">- to: 'team-Y+alerts@example.org'</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">- name: 'team-Y-pager'</span>
<span style="color: #b22222;">#  </span><span style="color: #b22222;">pagerduty_configs:</span>
<span style="color: #b22222;">#  </span><span style="color: #b22222;">- service_key: &lt;team-Y-key&gt;</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">- name: 'team-DB-pager'</span>
<span style="color: #b22222;">#  </span><span style="color: #b22222;">pagerduty_configs:</span>
<span style="color: #b22222;">#  </span><span style="color: #b22222;">- service_key: &lt;team-DB-key&gt;</span>
<span style="color: #b22222;">#  </span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">- name: 'team-X-hipchat'</span>
<span style="color: #b22222;">#  </span><span style="color: #b22222;">hipchat_configs:</span>
<span style="color: #b22222;">#  </span><span style="color: #b22222;">- auth_token: &lt;auth_token&gt;</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">room_id: 85</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">message_format: html</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">notify: true</span>

time_intervals: <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38745;&#38899;/&#28608;&#27963;&#36335;&#32447;&#30340;&#26102;&#38388;&#38388;&#38548;&#21015;&#34920;</span>
</pre>
</div>



<p>
slack，webhook等其它报警配置参考
<a href="https://prometheus.io/docs/alerting/latest/configuration/#email_config">https://prometheus.io/docs/alerting/latest/configuration/#email_config</a>
</p>


<p>
温馨提示：如果没有使用ratel(自研工具)，可以使用secret热更新的方式更改配置文件，具体操作步骤如下：
</p>
<div class="org-src-container">
<pre class="src src-shell">vim alertmanager.yaml
<span style="color: #8b2252;">"global"</span>:
  <span style="color: #8b2252;">"resolve_timeout"</span>: <span style="color: #8b2252;">"2h"</span>
  smtp_from: <span style="color: #8b2252;">"kubernetes_guide@163.com"</span>
  smtp_smarthost: <span style="color: #8b2252;">"smtp.163.com:465"</span>
  smtp_hello: <span style="color: #8b2252;">"163.com"</span>
  smtp_auth_username: <span style="color: #8b2252;">"kubernetes_guide@163.com"</span>
  smtp_auth_password: <span style="color: #8b2252;">"DYKEBOEGTFSEUGVY"</span>
  smtp_require_tls: false
  <span style="color: #b22222;"># </span><span style="color: #b22222;">wechat</span>
  wechat_api_url: <span style="color: #8b2252;">'https://qyapi.weixin.qq.com/cgi-bin/'</span>
  wechat_api_secret: <span style="color: #8b2252;">'ZZQt0Ue9mtplH9u1g8PhxR_RxEnRu512CQtmBn6R2x0'</span>
  wechat_api_corp_id: <span style="color: #8b2252;">'wwef86a30130f04f2b'</span>
<span style="color: #8b2252;">"inhibit_rules"</span>:
- <span style="color: #8b2252;">"equal"</span>:
  - <span style="color: #8b2252;">"namespace"</span>
  - <span style="color: #8b2252;">"alertname"</span>
  <span style="color: #8b2252;">"source_match"</span>:
    <span style="color: #8b2252;">"severity"</span>: <span style="color: #8b2252;">"critical"</span>
  <span style="color: #8b2252;">"target_match_re"</span>:
    <span style="color: #8b2252;">"severity"</span>: <span style="color: #8b2252;">"warning|info"</span>
- <span style="color: #8b2252;">"equal"</span>:
  - <span style="color: #8b2252;">"namespace"</span>
  - <span style="color: #8b2252;">"alertname"</span>
  <span style="color: #8b2252;">"source_match"</span>:
    <span style="color: #8b2252;">"severity"</span>: <span style="color: #8b2252;">"warning"</span>
  <span style="color: #8b2252;">"target_match_re"</span>:
    <span style="color: #8b2252;">"severity"</span>: <span style="color: #8b2252;">"info"</span>
<span style="color: #8b2252;">"receivers"</span>:
- <span style="color: #8b2252;">"name"</span>: <span style="color: #8b2252;">"Default"</span>
  <span style="color: #8b2252;">"email_configs"</span>: 
  - to: <span style="color: #8b2252;">"kubernetes_guide@163.com"</span>
    send_resolved: true
- <span style="color: #8b2252;">"name"</span>: <span style="color: #8b2252;">"Watchdog"</span>
  <span style="color: #8b2252;">"email_configs"</span>: 
  - to: <span style="color: #8b2252;">"kubernetes_guide@163.com"</span>
    send_resolved: true
- <span style="color: #8b2252;">"name"</span>: <span style="color: #8b2252;">"Critical"</span>
  <span style="color: #8b2252;">"email_configs"</span>: 
  - to: <span style="color: #8b2252;">"kubernetes_guide@163.com"</span>
    send_resolved: true
- name: <span style="color: #8b2252;">'wechat'</span>
  wechat_configs:
  - send_resolved: true
    to_tag: <span style="color: #8b2252;">'1'</span>
    agent_id: <span style="color: #8b2252;">'1000003'</span>
<span style="color: #8b2252;">"route"</span>:
  <span style="color: #8b2252;">"group_by"</span>:
  - <span style="color: #8b2252;">"namespace"</span>
  <span style="color: #8b2252;">"group_interval"</span>: <span style="color: #8b2252;">"1m"</span>
  <span style="color: #8b2252;">"group_wait"</span>: <span style="color: #8b2252;">"30s"</span>
  <span style="color: #8b2252;">"receiver"</span>: <span style="color: #8b2252;">"Default"</span>
  <span style="color: #8b2252;">"repeat_interval"</span>: <span style="color: #8b2252;">"1m"</span>
  <span style="color: #8b2252;">"routes"</span>:
  - <span style="color: #8b2252;">"match"</span>:
      <span style="color: #8b2252;">"alertname"</span>: <span style="color: #8b2252;">"Watchdog"</span>
    <span style="color: #8b2252;">"receiver"</span>: <span style="color: #8b2252;">"wechat"</span>
  - <span style="color: #8b2252;">"match"</span>:
      <span style="color: #8b2252;">"severity"</span>: <span style="color: #8b2252;">"critical"</span>
    <span style="color: #8b2252;">"receiver"</span>: <span style="color: #8b2252;">"Critical"</span>
</pre>
</div>

<p>
查看配置是否加载成功
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl logs -f alertmanager-main-0 -n monitoring alertmanager
</pre>
</div>

<p>
alertmanager 抑制告警
</p>
<ul class="org-ul">
<li>在页面告警条目旁边点 silences，取消点击 expire</li>
</ul>

<p>
Alertmanager 的配置主要分为五大块：
</p>
<ul class="org-ul">
<li>global：全局配置，主要用来配置一些通用的配置。如邮件通知的账号、密码、SMTP 服务器、微信告警等。文件内其它位置的子配置可以覆盖 global 配置；</li>
<li>templates：用于放置自定义模板的位置；</li>
<li>route：告警路由配置，用于告警信息的分组路由，可以将不同分组的告警发送给不同的接收人；如数据库告警发给 DBA，服务器告警发给 OPS； inhibit_rules：告警抑制，主要用于减少告警的次数，防止"告警轰炸"。比如某个宿主机宕机，可能会引起容器重建、漂移、服务不可用等一系列问题，如果每个异常均有告警，会一次性发送很多告警，造成告警轰炸，并且也会干扰定位问题的思路，所以可用使用告警抑制，屏蔽由宿主机宕机引来的其他问题，只发送宿主机宕机的消息即可；</li>
<li>receivers：告警 接收人配置，每个 receiver 都有一个名字，经过 route 分组并且路由后需要指定一个 receiver，就是在此位置配置的。</li>
</ul>
</div>
</div>
<div id="outline-container-h:cd3fbfce-e27c-436e-94b5-37e632d3c1d4" class="outline-4">
<h4 id="h:cd3fbfce-e27c-436e-94b5-37e632d3c1d4">route-路由规则</h4>
<div class="outline-text-4" id="text-h:cd3fbfce-e27c-436e-94b5-37e632d3c1d4">
<p>
官方文档：<a href="https://prometheus.io/docs/alerting/latest/configuration/#route">https://prometheus.io/docs/alerting/latest/configuration/#route</a>
</p>

<div class="org-src-container">
<pre class="src src-yaml">route:
  group_by: 
  - namespace
  - job
  - alertname
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'Default'
  # 上述route的配置会被传递给子路由节点，子路由节点进行重新配置才会被覆盖

  # 子路由树
  routes:
  - receiver: 'db-webhook-p1'
    group_wait: 10s
    group_interval: 30s
    repeat_interval: 30m
    group_by: [dbtype] # 按 dbtype 重新分组
    matchers:
    - DB_Priority = P1
    - dbtype =~ "db.*"
  - receiver: 'wechat'
    match_re:
      service: ^(foo1|foo2|baz)$
    continue: true # 匹配到上面条件后是否继续匹配
    routes: # 嵌套 routes
    - match:
        severity: critical
      receiver: 'wechat'
  - receiver: 'dev-pager'
    matchers:
      - service="inhouse-service"
    mute_time_intervals:  # 路线将在非工作时间和节假日时间间隔内静音。
      - offhours
      - holidays
    continue: true  # 即使它匹配，它将继续到下一个子路由

  - receiver: 'on-call-pager'
    matchers:
      - service="inhouse-service"
    active_time_intervals:  # 仅在非工作时间和节假日时间间隔内有效。
      - offhours
      - holidays
  - receiver: 'default-receiver'
    group_wait: 10s
    group_interval: 30s
    repeat_interval: 30m
    group_by: ['job']
    match_re:
      job: ".*"

time_intervals:
- name: offhours
  time_intervals:
  - times:
    - start_time: 20:00
      end_time: 23:00
    weekdays: ['monday:wednesday','saturday', 'sunday']
    days_of_month: ['1:5', '-3:-1']
    months: ['may:august']
    years: ['2020:2022']
    location: Asia/Kolkata
- name: holidays
  time_intervals:
  - times:
    - start_time: 20:00
      end_time: 23:00
    weekdays: ['monday:wednesday','saturday', 'sunday']
    days_of_month: ['1:7']
    months: ['december']
    years: ['2020:2022']
</pre>
</div>

<p>
route 说明：
</p>
<ul class="org-ul">
<li>routes：可嵌套子路由</li>
<li>receiver：告警的通知目标，需要和 receivers 配置中的 name 进行匹配。需要注意的是 route.routes 下也可以有 receiver 配置，优先级高于 route.receiver 配置的默认接收人。当告警没有匹配到子路由时，会使用 route.receiver 进行通知，比如上述配置中的 Default;</li>
<li>group_by：分组配置，值类型为列表。比如配置成['job','serverity']，代表告警信息包含 job 和 severity 标签的会进行分组，且标签的 key 和 value 都相同才会被分到一组；</li>
<li>countinue: 决定匹配到第一个路由后，是否继续后续匹配。默认为 false，即匹配到第一个子节点后停止继续匹配；</li>
<li>match：精确匹配；一对一匹配规则，比如 match 配置为 job: mysql，那具有 job=mysql 的告警会进入该路由；
<ul class="org-ul">
<li>标签可在注册目标服务时设置，也可以在报警规则里配置</li>
</ul></li>
<li>match_re：和 match 类似，只不过是正则匹配；</li>
<li>matchers：是替代 match 和 match_re 的新写法，0.22 版本后</li>
<li>group_wait：告警通知等待，值类型为字符串。若一组新的告警产生，则会等 group_wait 后再发送通知（peing 到 firing 状态），该功能主要用于当告警在很短时间内接连产生时，在 group_wait 内合并为单一的告警后再发送，防止告警过多，默认值为 30s；</li>
<li>group_interval：同一组告警通知后，如果有新的告警添加到该组中，再次发送告警通知的时间，默认值为 5m；</li>
<li>repeat_interval：如果一条告警通知已经成功发送，且在间隔 repeat_interval 后，该告警仍然未被设置为 resoved，则会再次发送告警通知，默认值 4h。</li>
<li>mute_time_intervals: 静音。指定名称与 time_intervals 匹配</li>
<li>active_time_intervals: 激活。指定名称与 time_intervals 匹配</li>
</ul>

<p>
time_intervals 说明：
</p>

<p>
如果未指定字段，则任何值都将匹配该字段。
</p>
<ul class="org-ul">
<li>time_range：范围包括开始时间但不包括结束时间，以便于表示在小时边界上开始/结束的时间。例如，开始时间"20:00"和结束时间"23:00"将从 20:00 开始，并在 23:00 之前结束。</li>
<li>weekday_range：一周中的几天列表，一周从星期日开始，到星期六结束. 应按名称指定日期（例如"星期日"）. 为方便起见，范围也接受形式 ： 并且在两端都包含. 例如： ['monday:wednesday','saturday', 'sunday']</li>
<li>days_of_month_range：月份中数字天数的列表. 天数从 1 开始.也接受从月底开始的负值，例如，1 月期间的 -1 表示 1 月 31 日.例如： ['1:5', '-3:-1']  延长超过月初或月底将导致它被钳制. 例如，在二月指定['1:31']将根据闰年将实际结束日期限制为 28 或 29. 两端包容.</li>
<li>month_range：由不区分大小写的名称（例如"January"）或数字标识的日历月列表，其中 January = 1.也接受范围. 例如， ['1:3', 'may:august', 'december'] . 两端包容.</li>
<li>year_range：年份的数字列表. 接受范围. 例如， ['2020:2022', '2030'] . 两端包容.</li>
<li>location: 与 IANA 时区数据库中的位置匹配的字符串。不设置为 UTC 时间</li>
</ul>
</div>
</div>
<div id="outline-container-h:4ba6913b-be71-47f2-b96e-73b96515d6ab" class="outline-4">
<h4 id="h:4ba6913b-be71-47f2-b96e-73b96515d6ab">receivers-告警通知</h4>
<div class="outline-text-4" id="text-h:4ba6913b-be71-47f2-b96e-73b96515d6ab">
<p>
官方文档：<a href="https://s0prometheus0io.icopy.site/docs/alerting/latest/configuration/#receiver">https://s0prometheus0io.icopy.site/docs/alerting/latest/configuration/#receiver</a>
</p>

<p>
一个接收人可以有多种发送方式：
</p>
<ul class="org-ul">
<li>email_configs: 邮件通知</li>
<li>wechat_configs:  微信通知</li>
<li>webhook_configs: 自定义接口。如钉钉、短信、自定义运维平台</li>
<li>slack_configs: slack 通知</li>
<li>opsgenie_configs:</li>
<li>pagerduty_configs:</li>
<li>pushover_configs:</li>
<li>sns_configs:</li>
<li>victorops_configs:</li>
<li>telegram_configs:</li>
</ul>
</div>
<div id="outline-container-h:a1f265e1-ca0b-408c-bb66-9375d1541438" class="outline-5">
<h5 id="h:a1f265e1-ca0b-408c-bb66-9375d1541438">告警邮件通知</h5>
<div class="outline-text-5" id="text-h:a1f265e1-ca0b-408c-bb66-9375d1541438">
<div class="org-src-container">
<pre class="src src-yaml">global:
...
  smtp_smarthost: 'smtp.qq.com:465'
  smtp_from: 'alert@xxx.com'
  smtp_auth_username: 'aff@xxx.com'
  smtp_auth_password: 'xxx'
  smtp_require_tls: false  

receivers:
- name: 'team-Y-mails'
  email_configs:
  - to: 'team-Y+alerts@example.org'
    send_resolved: true  # 是否发恢复的通知
</pre>
</div>
</div>
</div>
<div id="outline-container-h:72fc7d8a-fed8-4df9-84af-9851fb5ff61d" class="outline-5">
<h5 id="h:72fc7d8a-fed8-4df9-84af-9851fb5ff61d">告警微信通知</h5>
<div class="outline-text-5" id="text-h:72fc7d8a-fed8-4df9-84af-9851fb5ff61d">
<p>
个人也可以注册
</p>

<ul class="org-ul">
<li>注册企业微信，记录企业 ID (corp_id)</li>
<li>创建一个部门，用于接收告警</li>
<li>添加子部门人员，记录部门 ID (to_party)</li>
<li>创建机器人应用， 记录 agentid、secret</li>
</ul>

<p>
配置
</p>
<div class="org-src-container">
<pre class="src src-yaml">global:
...
  # wechat
  wechat_api_url: 'https://qyapi.weixin.qq.com/cgi-bin/'
  wechat_api_corp_id: 'wwef86a30130f04f2b'

receivers:
- name: 'wechat'
  wechat_configs:
  - send_resolved: true
    to_party: 3
    to_user: '@all'
    agent_id: '1000003'
    api_secret: 'ZZQt0Ue9mtplH9u1g8PhxR_RxEnRu512CQtmBn6R2x0'
</pre>
</div>

<p>
只发送某个人用USER_ID
</p>
</div>
</div>
<div id="outline-container-h:a8dbe787-4083-4edc-8390-597ec9299469" class="outline-5">
<h5 id="h:a8dbe787-4083-4edc-8390-597ec9299469">slack</h5>
<div class="outline-text-5" id="text-h:a8dbe787-4083-4edc-8390-597ec9299469">
<div class="org-src-container">
<pre class="src src-shell">receivers:
    slack_configs:
      - api_url: <span style="color: #8b2252;">"&#27492;&#22788;&#37197;&#32622;&#26426;&#22120;&#20154;&#22320;&#22336;"</span>
        channel: <span style="color: #8b2252;">"#fchannel_name"</span>
        send_resolved: false
        title: <span style="color: #8b2252;">'[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}'</span>
        text: |-
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }} - <span style="color: #ff00ff;">`{{ .Labels.severity }}`</span>
          *Description:* {{ .Annotations.description }}
          *Details:*
            {{ range .Labels.SortedPairs }} *{{ .Name }}:* <span style="color: #ff00ff;">`{{ .Value }}`</span>
            {{ end }}
          {{ end }}
        short_fields: true
</pre>
</div>

<p>
其它
</p>
<div class="org-src-container">
<pre class="src src-shell">receivers:
- name: <span style="color: #8b2252;">"app-webhook-critical"</span>
  webhook_configs:
  - url: <span style="color: #8b2252;">'http://localhost:8060/dingtalk/app-webhook-critical/send'</span>
    send_resolved: true
- name: <span style="color: #8b2252;">"wallet-webhook-critical"</span>
  webhook_configs:
  - url: <span style="color: #8b2252;">'http://localhost:8060/dingtalk/wallet-webhook-critical/send'</span>
    send_resolved: true
  slack_configs:
  - api_url: <span style="color: #8b2252;">"https://hooks.slack.com/services/T026NT2D4/B0jxxxxxxxxxxx"</span>
    channel: <span style="color: #8b2252;">"#cc-alert-wallet"</span>
    text: <span style="color: #8b2252;">"{{ range .Alerts }}{{ .Annotations.summary }}\n Value: {{ .Annotations.description }}\n{{ end }}"</span>
    send_resolved: true
</pre>
</div>

<p>
测试
</p>
<div class="org-src-container">
<pre class="src src-shell">curl --location --request POST <span style="color: #8b2252;">'https://hooks.slack.com/services/T5gZxxx'</span> <span style="color: #8b2252;">\</span>
--header <span style="color: #8b2252;">'Content-Type: application/json'</span> <span style="color: #8b2252;">\</span>
--data-raw <span style="color: #8b2252;">'{</span>
<span style="color: #8b2252;">    &#8220;text&#8221;: &#8220;Hello, world.&#8221;</span>
<span style="color: #8b2252;">}'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:948a621c-c649-40b5-9c4c-b69285ef84d6" class="outline-5">
<h5 id="h:948a621c-c649-40b5-9c4c-b69285ef84d6">自定义接收者-自建接口</h5>
<div class="outline-text-5" id="text-h:948a621c-c649-40b5-9c4c-b69285ef84d6">
<p>
定义接口识别的标签，如在报警规则上添加 <code>duty: cardgames_po|infra_op</code> ，然后在告警发送时在 alertmanager 上配置上对应接口。
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">prometheus &#25253;&#35686;&#35268;&#21017;&#25991;&#20214;</span>
      - alert: poker_new_games_dropped_critical
        expr: *
        <span style="color: #a020f0;">for</span>: 10m
        labels:
          severity: critical
          team: cardgames-poker
          duty: cardgames_po|infra_op
        annotations:
          runbook_url: https://xxx
          summary:  <span style="color: #8b2252;">'x'</span>
          description: <span style="color: #8b2252;">'x'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">alertmanager &#37197;&#32622;&#25991;&#20214;</span>
    receivers:
    - name: <span style="color: #8b2252;">"cardgames-business-webhook-critical"</span>
      webhook_configs:
      - url: <span style="color: #8b2252;">'http://prometheus-webhook-dingtalk:8060/dingtalk/cardgames-business-webhook-critical/send'</span>
        send_resolved: true
      - send_resolved: false
        url: <span style="color: #8b2252;">"http://ops.xxx.com/api/v1/monitoringWebhook"</span>
      slack_configs:
      - api_url: <span style="color: #8b2252;">"https://hooks.slack.com/services/T026NT2D4/B033SJ1DFT6/xx"</span>
        channel: <span style="color: #8b2252;">"#cc-alert-cardgames"</span>
        text: <span style="color: #8b2252;">"{{ range .Alerts }}{{ .Annotations.summary }}\n Value: {{ .Annotations.description }}\n{{ end }}"</span>
        send_resolved: true
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:aab88a77-78c3-42ad-a601-9fd5b9f6aaa9" class="outline-4">
<h4 id="h:aab88a77-78c3-42ad-a601-9fd5b9f6aaa9">templates-自定义告警模板</h4>
<div class="outline-text-4" id="text-h:aab88a77-78c3-42ad-a601-9fd5b9f6aaa9">
</div>
<div id="outline-container-h:4602864c-6f7c-45e7-a9ea-28afe14ae1ca" class="outline-5">
<h5 id="h:4602864c-6f7c-45e7-a9ea-28afe14ae1ca">微信告警模板</h5>
<div class="outline-text-5" id="text-h:4602864c-6f7c-45e7-a9ea-28afe14ae1ca">
<p>
默认微信告警模板格式不比较乱。
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;alertmanager.yaml&#30340;secret</span>
kubectl create secret generic  alertmanager-main --from-file=alertmanager.yaml --from-file=wechat.tmpl   -n monitoring
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20043;&#21518;&#26356;&#25913;alertmanager.yaml&#21487;&#20197;&#20351;&#29992;&#28909;&#21152;&#36733;&#21435;&#26356;&#26032;k8s&#30340;secret</span>
kubectl create secret generic  alertmanager-main --from-file=alertmanager.yaml -n monitoring --dry-run -o yaml | kubectl replace -f -
</pre>
</div>

<p>
wechat.tmpl
</p>
<div class="org-src-container">
<pre class="src src-shell">{{ define <span style="color: #8b2252;">"wechat.default.message"</span> }}
{{ <span style="color: #a020f0;">if</span> gt (len .Alerts.Firing) 0 -}}
Alerts Firing:
{{ range .Alerts }}
&#21578;&#35686;&#32423;&#21035;&#65306;{{ .Labels.severity }}
&#21578;&#35686;&#31867;&#22411;&#65306;{{ .Labels.alertname }}
&#25925;&#38556;&#20027;&#26426;: {{ .Labels.instance }}
Job&#21517;&#31216;: {{.Labels.job}}
&#21578;&#35686;&#35814;&#24773;: {{ .Annotations.message }}
&#35302;&#21457;&#26102;&#38388;: {{ .StartsAt.Format <span style="color: #8b2252;">"2006-01-02 15:04:05"</span> }}
{{- end }}
{{- end }}
{{ <span style="color: #a020f0;">if</span> gt (len .Alerts.Resolved) 0 -}}
Alerts Resolved:
{{ range .Alerts }}
&#21578;&#35686;&#32423;&#21035;&#65306;{{ .Labels.severity }}
&#21578;&#35686;&#31867;&#22411;&#65306;{{ .Labels.alertname }}
&#25925;&#38556;&#20027;&#26426;: {{ .Labels.instance }}
Job&#21517;&#31216;: {{.Labels.job}}
&#21578;&#35686;&#20027;&#39064;: {{ .Annotations.message }}
&#35302;&#21457;&#26102;&#38388;: {{ .StartsAt.Format <span style="color: #8b2252;">"2006-01-02 15:04:05"</span> }}
&#24674;&#22797;&#26102;&#38388;: {{ .EndsAt.Format <span style="color: #8b2252;">"2006-01-02 15:04:05"</span> }}
{{- end }}
{{- end }}
&#21578;&#35686;&#38142;&#25509;:
{{ template <span style="color: #8b2252;">"__alertmanagerURL"</span> . }}  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26367;&#25442;&#25104;&#22495;&#21517;</span>
{{- end }}
</pre>
</div>

<p>
修改alertmanager.yaml
</p>
<div class="org-src-container">
<pre class="src src-shell">templates:
- <span style="color: #8b2252;">'/etc/alertmanager/config/*.tmpl'</span>

- name: <span style="color: #8b2252;">'wechat'</span>          <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24494;&#20449;&#21578;&#35686;</span>
  wechat_configs:
  - send_resolved: true   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25253;&#35686;&#35299;&#20915;&#30340;&#36890;&#36807;&#26159;&#21542;&#21457;&#36865;</span>
    corp_id: <span style="color: #8b2252;">'ww'</span>
    api_secret: <span style="color: #8b2252;">'JJ'</span>
    to_tag: <span style="color: #8b2252;">'1'</span>
    agent_id: <span style="color: #8b2252;">'1000002'</span>
    api_url: <span style="color: #8b2252;">'https://qyapi.weixin.qq.com/cgi-bin/'</span>
    message: <span style="color: #8b2252;">'{{ template "wechat.default.message" . }}'</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21644;&#27169;&#26495;&#20013; define &#21517;&#31216;&#19968;&#33268;</span>
</pre>
</div>



<p>
告警模板配置：<a href="https://prometheus.io/docs/alerting/notification_examples/">https://prometheus.io/docs/alerting/notification_examples/</a>
</p>
</div>
</div>
</div>
<div id="outline-container-h:339556f0-dcec-41fe-9ad7-d76a406b75dc" class="outline-4">
<h4 id="h:339556f0-dcec-41fe-9ad7-d76a406b75dc">inhibit_rules-限制</h4>
<div class="outline-text-4" id="text-h:339556f0-dcec-41fe-9ad7-d76a406b75dc">
</div>
</div>
<div id="outline-container-h:9828702b-5c89-4409-a844-5fe89975b698" class="outline-4">
<h4 id="h:9828702b-5c89-4409-a844-5fe89975b698">计划内维护暂停告警 Silence</h4>
<div class="outline-text-4" id="text-h:9828702b-5c89-4409-a844-5fe89975b698">
<p>
打开 alertmanager ui 界面，可以对已知告警做暂停，也可以对未告警暂停做新建。
</p>
</div>
</div>
<div id="outline-container-h:655ad2ea-0d20-4c45-acad-836caeddb9f9" class="outline-4">
<h4 id="h:655ad2ea-0d20-4c45-acad-836caeddb9f9">手动触发告警</h4>
<div class="outline-text-4" id="text-h:655ad2ea-0d20-4c45-acad-836caeddb9f9">
<div class="org-src-container">
<pre class="src src-shell">curl --location --request POST <span style="color: #8b2252;">'https://alertmanager-akamai.xxx.com/api/v1/alerts'</span> <span style="color: #8b2252;">\</span>
--header <span style="color: #8b2252;">'Content-Type: application/json'</span> <span style="color: #8b2252;">\</span>
--data-raw <span style="color: #8b2252;">'[</span>
<span style="color: #8b2252;">    {</span>
<span style="color: #8b2252;">        "labels": {</span>
<span style="color: #8b2252;">            "severity": "critical",</span>
<span style="color: #8b2252;">            "duty": "infra_op|fsy_rd"</span>
<span style="color: #8b2252;">        },</span>
<span style="color: #8b2252;">        "annotations": {</span>
<span style="color: #8b2252;">            "info": "The disk sda1 is running full2",</span>
<span style="color: #8b2252;">            "summary": "please check the instance example1"</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">]'</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:f8ebcb30-d2e3-4174-aecb-6ef83a44fedd" class="outline-3">
<h3 id="h:f8ebcb30-d2e3-4174-aecb-6ef83a44fedd">Prometheus 告警实战</h3>
<div class="outline-text-3" id="text-h:f8ebcb30-d2e3-4174-aecb-6ef83a44fedd">
</div>
<div id="outline-container-h:c7ceac4e-4c8d-42bb-bfc2-1b80f730b663" class="outline-4">
<h4 id="h:c7ceac4e-4c8d-42bb-bfc2-1b80f730b663">PrometheusRule</h4>
<div class="outline-text-4" id="text-h:c7ceac4e-4c8d-42bb-bfc2-1b80f730b663">
<p>
Prometheus Stack 自定义了 PrometheusRule 类型。
</p>

<p>
可以通过如下命令查看默认配置的告警策略：
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl get prometheusrule -n monitoring

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#65306;nodeExporter-prometheusRule.yaml</span>
</pre>
</div>

<p>
注意匹配标签的规则才能被识别:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">prometheus-prometheus.yaml</span>
  ruleSelector:
    matchLabels:
      prometheus: k8s
      role: alert-rules
</pre>
</div>

<p>
api 文档：<a href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#prometheusrule">https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#prometheusrule</a>
</p>
</div>
<div id="outline-container-h:99be0d9e-5c39-4aee-a842-e3ca9bbbffb2" class="outline-5">
<h5 id="h:99be0d9e-5c39-4aee-a842-e3ca9bbbffb2">规则语法</h5>
<div class="outline-text-5" id="text-h:99be0d9e-5c39-4aee-a842-e3ca9bbbffb2">
<p>
如 nodeExporter-prometheusRule.yaml
</p>
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: k8s
    role: alert-rules
  name: node-exporter-rules
  namespace: monitoring
spec:
  groups:
  - name: node-exporter
    rules:
    - alert: NodeFilesystemSpaceFillingUp
      annotations:
        description: Filesystem on {{ $labels.device }} at {{ $labels.instance }}
          has only {{ printf "%.2f" $value }}% available space left and is filling
          up.
        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodefilesystemspacefillingup
        summary: Filesystem is predicted to run out of space within the next 24 hours.
      expr: |
        (
          node_filesystem_avail_bytes{job="node-exporter",fstype!=""} / node_filesystem_size_bytes{job="node-exporter",fstype!=""} * 100 &lt; 15
        and
          predict_linear(node_filesystem_avail_bytes{job="node-exporter",fstype!=""}[6h], 24*60*60) &lt; 0
        and
          node_filesystem_readonly{job="node-exporter",fstype!=""} == 0
        )
      for: 1h
      Labels:
        severity: warning
</pre>
</div>

<p>
说明：和普通安装后的配置文件的语法是一样的
</p>
<ul class="org-ul">
<li>alert：告警策略名称</li>
<li>annotations：告警注释信息
<ul class="org-ul">
<li>description：详情</li>
<li>summary：概述</li>
<li>runbook_url：参考地址。可用来返回解决方案 wiki 或自动化 webhook</li>
</ul></li>
<li>expr：告警表达式</li>
<li>Labels：告警的标签，用于告警的路由</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:07378308-4f48-4203-8726-92eab0e1c63d" class="outline-4">
<h4 id="h:07378308-4f48-4203-8726-92eab0e1c63d">域名访问延迟告警</h4>
<div class="outline-text-4" id="text-h:07378308-4f48-4203-8726-92eab0e1c63d">
<p>
提前安装好 blackbox
</p>
</div>
<div id="outline-container-h:eb9295da-8ce4-4c8f-b50f-8987c6d2bfca" class="outline-5">
<h5 id="h:eb9295da-8ce4-4c8f-b50f-8987c6d2bfca">告警规则</h5>
<div class="outline-text-5" id="text-h:eb9295da-8ce4-4c8f-b50f-8987c6d2bfca">
<p>
blackbox-prometheusRule.yaml
</p>
<div class="org-src-container">
<pre class="src src-yaml">node.rules.yml: |
  groups:
  - name: ssl_cert_expiry # 证书到期告警
    interval: 1d  # 检查间隔
    rules:
    - alert: taskcenter_ssl_cert_expiry_less_than_30days
      expr: (probe_ssl_earliest_cert_expiry{job="blackbox-http"} - time()) /60/60/24  &lt; 30
      labels:
        severity: warning
        type: blackbox
      annotations:
        summary: "ssl cert expiry less than 30 days"
        description: "warning | Current value = {{ $value }}%. | [Duration Time: 1d]"

  - name: url_not_available # 网站不可用告警
    interval: 1m
    rules:
    - alert: url_not_available
      expr: probe_http_status_code{job="blackbox-http"} != 200
      labels:
        severity: warning
        type: blackbox
      annotations:
        summary: "url not available"

  - name: url_delay # 网站延迟
    rules:
    - alert: DomainAccessDelayExceedsls
      expr: sum by (instance) (probe_http_duration_seconds{job="blackbox-http"}) &gt; 1
      for: 1m
      labels:
        severity: warning
        type: blackbox
      annotations:
        summary: "Domain is delayed by more than 1 second"
        description: "The domain {{$labels.instance}} is delayed by more than 1 second, current value is {{ $value | printf "%.2f" }} second"
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f556fcb8-f5f8-45fe-bf72-bac812dd960f" class="outline-5">
<h5 id="h:f556fcb8-f5f8-45fe-bf72-bac812dd960f">ingress 自动监控域名</h5>
<div class="outline-text-5" id="text-h:f556fcb8-f5f8-45fe-bf72-bac812dd960f">
<div class="org-src-container">
<pre class="src src-yaml">#----- 自动发现 添加以下内容
- job_name: 'auto_discovery'
  metrics_path: /probe
  params:
    module: [http_2xx]  
  kubernetes_sd_configs:  # 使用 k8s 的服务发现
  - role: ingress  # 服务发现可以基于 ingress, pod, svc, ... ...
  relabel_configs:
  - source_labels: [__meta_kubernetes_ingress_annotation_prometheus_io_http_probe]
    action: keep
    regex: true  # ingress 配置了上面的标签值为true的会加入自动发现
  - source_labels: [__meta_kubernetes_ingress_scheme,__address__,__meta_kubernetes_ingress_path]
    regex: (.+);(.+);(.+)
    replacement: ${1}://${2}${3} # 用上面匹配到的标签拼成 url
    target_label: __param_target
  - source_labels: [__meta_kubernetes_ingress_scheme,__address__,__meta_kubernetes_ingress_path]
    regex: (.+);(.+);(.+)
    replacement: ${1}://${2}${3}
    target_label: target
  - target_label: __address__
    replacement: blackbox-exporter:9115
  - source_labels: [__param_target]
    target_label: instance
  - action: labelmap   # ingress 的标签赋值给 metric 的lable
    regex: __meta_kubernetes_ingress_label_(.+)
  - source_labels: [__meta_kubernetes_namespace]
    target_label: kubernetes_namespace
  - source_labels: [__meta_kubernetes_ingress_name]
    target_label: kubernetes_name
</pre>
</div>

<p>
serviceaccount monitoring:prometheus-k8s 配置读取 ingress 的权限
ingress-view.yaml
</p>
<div class="org-src-container">
<pre class="src src-shell">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus-discovery 
  namespace: monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ratel-resource-readonly
subjects:
- namespace: monitoring 
  kind: ServiceAccount
  name: prometheus-k8s
</pre>
</div>
<p>
在 prometheus 页面中可以看到 auto_discovery 的 job。
</p>

<p>
ingress 启动墨盒域名监控
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#30417;&#25511;&#22495;&#21517;&#65292;ingress &#20013;&#28155;&#21152;&#22914;&#19979;&#27880;&#37322;</span>
  annotations:
    prometheus.io/http_probe: true
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:e67b48f6-8020-4b06-b6b8-4ec5013127ca" class="outline-4">
<h4 id="h:e67b48f6-8020-4b06-b6b8-4ec5013127ca">prometheus 监控 Java JVM</h4>
<div class="outline-text-4" id="text-h:e67b48f6-8020-4b06-b6b8-4ec5013127ca">
<ul class="org-ul">
<li>使 micrometer 来监控 JVM <a href="https://micrometer.io/">https://micrometer.io/</a></li>
<li>grafana 模板： <a href="https://grafana.com/grafana/dashboards/4701">https://grafana.com/grafana/dashboards/4701</a></li>
<li>测试 Demo 项目：<a href="https://github.com/gongchangwangpi/spring-cloud-demo2">https://github.com/gongchangwangpi/spring-cloud-demo2</a></li>
</ul>
</div>
<div id="outline-container-h:c23fe1d4-2a58-48cd-92ec-72eebc9d1919" class="outline-5">
<h5 id="h:c23fe1d4-2a58-48cd-92ec-72eebc9d1919">Java JVM监控</h5>
<div class="outline-text-5" id="text-h:c23fe1d4-2a58-48cd-92ec-72eebc9d1919">
<p>
项目pom文件如下内容，经过编译的 jar 包就有了 micrometer 的接口
</p>
<div class="org-src-container">
<pre class="src src-shell">&lt;dependecies&gt; <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#22914;&#19979;&#20869;&#23481;</span>
     &lt;!-- Micrometer Prometheus registry  --&gt;
     &lt;dependency&gt;
     &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
     &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
       &lt;/dependency&gt;
      &lt;dependency&gt;
             &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
              &lt;artifactId&gt;micrometer-core&lt;/artifactId&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
             &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
             &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;
      &lt;/dependency&gt;
     &lt;!-- finished --&gt;
</pre>
</div>

<p>
Maven缓存目录：~/.m2
</p>

<p>
<a href="https://hub.docker.com/_/maven?tab=tags">https://hub.docker.com/_/maven?tab=tags</a>
</p>

<p>
eureka默认端口: 8761
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">cd</span> /opt
git clone https://github.com/gongchangwangpi/spring-cloud-demo2
<span style="color: #483d8b;">cd</span> spring-cloud-demo2

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32534;&#35793;</span>
docker run -it --rm -v /opt/m2:/root/.m2 -v <span style="color: #ff00ff;">`pwd`</span>:/opt -p 18761:8761 maven:3.5.3 bash
&gt; cd /opt
&gt; cd spring-cloud-eureka
&gt; vim pom.xml  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#20197;&#19979;&#20869;&#23481;</span>
   &lt;dependecies&gt; <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#22914;&#19979;&#20869;&#23481;</span>
        &lt;!-- Micrometer Prometheus registry  --&gt;
        &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
          &lt;/dependency&gt;
         &lt;dependency&gt;
                &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
                 &lt;artifactId&gt;micrometer-core&lt;/artifactId&gt;
         &lt;/dependency&gt;
         &lt;dependency&gt;
                &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
                &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;
         &lt;/dependency&gt;
        &lt;!-- finished --&gt;
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558; micrometer &#30340;&#25509;&#21475;&#26292;&#38706;&#20986;&#26469;</span>
&gt; vim src/main/resources/application.yml <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26032;&#22686;&#20197;&#19979;&#20869;&#23481;</span>
spring:
  application:
    name: cloud-eureka
management:
  endpoints:
    web:
      exposure:
        include: <span style="color: #8b2252;">'*'</span>
    shutdown:
      <span style="color: #483d8b;">enable</span>: false
  metrics:
    tags:
      application: <span style="color: #8b2252;">"${spring.application.name}"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">maven&#32534;&#35793;&#21629;&#20196;&#65306;</span>
&gt; mvn clean package -DskipTests      
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160; euraka &#26381;&#21153;</span>
&gt; java -jar target/spring-cloud-eureka-0.0.1-SNAPSHOT.jar
</pre>
</div>

<p>
浏览器访问 euraka： <a href="http://ip:18761">http://ip:18761</a>
</p>

<p>
查看监控数据：<a href="http://ip:18761/actutor/prometheus">http://ip:18761/actutor/prometheus</a>
</p>

<p>
添加监控
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26032;&#22686;&#22914;&#19979;&#20869;&#23481;</span>
[root@k8s-master01 prometheus-down]# vim prometheus-additional.yaml 
- job_name: <span style="color: #8b2252;">'jvm-prometheus'</span>
  scheme: http
  metrics_path: <span style="color: #8b2252;">'/actuator/prometheus'</span>
  static_configs:
  - targets: [<span style="color: #8b2252;">'xxx:8080'</span>]
</pre>
</div>
</div>
</div>
<div id="outline-container-h:eb39c790-aa0b-4c70-8e80-81aedcd32869" class="outline-5">
<h5 id="h:eb39c790-aa0b-4c70-8e80-81aedcd32869">基于 euraka 服务自动发现监控 JVM</h5>
<div class="outline-text-5" id="text-h:eb39c790-aa0b-4c70-8e80-81aedcd32869">
<p>
查看对应版本：<a href="https://mavenjars.com/search?q=eureka-consul-adapter">https://mavenjars.com/search?q=eureka-consul-adapter</a>
</p>

<p>
euraka
</p>
<div class="org-src-container">
<pre class="src src-shell">vim pom.xml 
&lt;dependency&gt;
    &lt;groupId&gt;at.twinformatics&lt;/groupId&gt;
    &lt;artifactId&gt;eureka-consul-adapter&lt;/artifactId&gt;
    &lt;version&gt;1.1.0&lt;/version&gt;
&lt;/dependency&gt;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:26da6d52-da21-4ae6-9dc8-081b3f20894d" class="outline-4">
<h4 id="h:26da6d52-da21-4ae6-9dc8-081b3f20894d">监控告警通用步骤</h4>
<div class="outline-text-4" id="text-h:26da6d52-da21-4ae6-9dc8-081b3f20894d">
<p>
非云原生应用：
</p>
<ul class="org-ul">
<li>找到对应服务的 Exporter（如果是自有业务，可能需要自行暴露数据）；</li>
<li>如果 k8s 集群外部服务，可能需要创建单独的 Service 指向服务，直接使用服务 IP 也可；</li>
<li>创建 Exporter 并配置被监控端的 IP 或者 Service；</li>
<li>创建 Exporter 的 Service 用于 被 Prometheus 发现并注册；</li>
<li>创建 ServiceMonitor 将被监控资源注册至 Prometheus（也可以使用静态配置）；</li>
<li>配置服务的告警策略；</li>
<li>配置服务的告警路由，将告警发送给指定的人。</li>
</ul>


<p>
云原生应用：
</p>
<ul class="org-ul">
<li>如果是 k8s 集群外部服务，可能需要创建单独的 Service 指向服务；</li>
<li>创建 ServiceMonitor 将被监控资源注册至 prometheus；</li>
<li>配置服务的告警策略；</li>
<li>配置服务的告警路由，将告警发送给指定的人。</li>
</ul>
</div>
</div>
<div id="outline-container-h:59979eba-dadd-47ff-863b-ae6f98c6a98c" class="outline-4">
<h4 id="h:59979eba-dadd-47ff-863b-ae6f98c6a98c">解决监控问题</h4>
<div class="outline-text-4" id="text-h:59979eba-dadd-47ff-863b-ae6f98c6a98c">
</div>
<div id="outline-container-h:70da9f17-6132-4c4f-bd39-49e4155d4b27" class="outline-5">
<h5 id="h:70da9f17-6132-4c4f-bd39-49e4155d4b27">解决schedule和controller监控问题</h5>
<div class="outline-text-5" id="text-h:70da9f17-6132-4c4f-bd39-49e4155d4b27">
<ol class="org-ol">
<li>服务启动0.0.0.0</li>
<li>创建对应标签的svc， svc 和 endpoint 名称一样就会自动创建联接</li>
</ol>
<div class="org-src-container">
<pre class="src src-shell">apiVersion: v1
items:
- apiVersion: v1
  kind: Service
  metadata:
    creationTimestamp: <span style="color: #8b2252;">"2020-04-25T14:42:04Z"</span>
    labels:
      k8s-app: kube-controller-manager
    name: kube-controller-manage-monitor
    namespace: kube-system
    resourceVersion: <span style="color: #8b2252;">"10081547"</span>
    selfLink: /api/v1/namespaces/kube-system/services/kube-controller-manage-monitor
    uid: d82d9170-9335-49b8-9aae-48630eb6efd4
  spec:
    clusterIP: 10.96.23.157
    ports:
    - name: http-metrics
      port: 10252
      protocol: TCP
      targetPort: 10252
    sessionAffinity: None
    <span style="color: #483d8b;">type</span>: ClusterIP
  status:
    loadBalancer: {}
- apiVersion: v1
  kind: Endpoints
  metadata:
    creationTimestamp: <span style="color: #8b2252;">"2020-04-25T14:41:16Z"</span>
    labels:
      k8s-app: kube-controller-manager
    name: kube-controller-manage-monitor
    namespace: kube-system
    resourceVersion: <span style="color: #8b2252;">"10081388"</span>
    selfLink: /api/v1/namespaces/kube-system/endpoints/kube-controller-manage-monitor
    uid: c7d0214b-58a2-4d05-8cfe-673e914e06b4
  subsets:
  - addresses:
    - ip: 192.168.1.19
    ports:
    - name: http-metrics
      port: 10252
      protocol: TCP
kind: List
metadata:
  resourceVersion: <span style="color: #8b2252;">""</span>
  selfLink: <span style="color: #8b2252;">""</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:55302452-c660-44f6-a17e-a634706ad7ef" class="outline-5">
<h5 id="h:55302452-c660-44f6-a17e-a634706ad7ef">CPUThrottlingHigh</h5>
<div class="outline-text-5" id="text-h:55302452-c660-44f6-a17e-a634706ad7ef">
<p>
CPUThrottlingHigh反应的是最近5分钟超过25%的CPU执行周期受到限制的container，一般是limit设置的低引起的。
</p>

<p>
通过两个指标进行监控的：
</p>
<div class="org-src-container">
<pre class="src src-shell">container_cpu_cfs_periods_total&#65306;container&#29983;&#21629;&#21608;&#26399;&#20013;&#24230;&#36807;&#30340;cpu&#21608;&#26399;&#24635;&#25968;
container_cpu_cfs_throttled_periods_total&#65306;container&#29983;&#21629;&#21608;&#26399;&#20013;&#24230;&#36807;&#30340;&#21463;&#38480;&#30340;cpu&#21608;&#26399;&#24635;&#25968;
</pre>
</div>

<p>
计算表达式：
</p>
<div class="org-src-container">
<pre class="src src-shell">sum by(container, pod, namespace) (increase(container_cpu_cfs_throttled_periods_total{container!=<span style="color: #8b2252;">""</span>}[5m])) / sum by(container, pod, namespace) (increase(container_cpu_cfs_periods_total[5m])) &gt; (25 / 100)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:3eeaa294-05a7-4cff-872b-b622e2f82688" class="outline-4">
<h4 id="h:3eeaa294-05a7-4cff-872b-b622e2f82688">记录规则优化 PromQL 语句</h4>
<div class="outline-text-4" id="text-h:3eeaa294-05a7-4cff-872b-b622e2f82688">
<p>
Prometheus 提供一种记录规则（Recording Rule） 来支持这种后台计算的方式，可以实现对复杂查询的 PromQL 语句的性能优化，提高查询效率。
</p>

<p>
<a href="https://cloud.tencent.com/developer/article/1557482">https://cloud.tencent.com/developer/article/1557482</a>
</p>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-shell">   - name: wallet-record
     interval: 1m
     rules:
     - record: app:uri:le:http_client_requests_seconds_bucket:rate:sum
       expr: sum by(app, uri, le) (rate(http_client_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))
     - record: app:uri:le:http_server_requests_seconds_bucket:rate:sum
       expr: sum by(app, uri, le) (rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>, uri!=<span style="color: #8b2252;">"UNKNOWN"</span>}[1m]))
     - record: wallet_rpc_rt90_total_5m
       expr: histogram_quantile(0.9, sum by(app,uri,le) (rate(http_client_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[5m])))
     - record: wallet_rpc_tps_total_5m
       expr: sum by (app,uri)(rate(http_client_requests_seconds_count{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[5m]))
     - record: wallet_rt_histogram_quantile_05_1m
       expr: histogram_quantile(0.5, sum by(app,uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.5"</span>
           name: <span style="color: #8b2252;">"wallet_rt"</span>
     - record: wallet_rt_histogram_quantile_09_1m
       expr: histogram_quantile(0.9, sum by(app,uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.9"</span>
           name: <span style="color: #8b2252;">"wallet_rt"</span>
     - record: wallet_rt_histogram_quantile_099_1m
       expr: histogram_quantile(0.99, sum by(app,uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.99"</span>
           name: <span style="color: #8b2252;">"wallet_rt"</span>
     - record: wallet_rt_total_05_1m
       expr: histogram_quantile(0.5, sum by(uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.5"</span>
           name: <span style="color: #8b2252;">"wallet_rt"</span>
     - record: wallet_rt_total_09_1m
       expr: histogram_quantile(0.9, sum by(uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.9"</span>
           name: <span style="color: #8b2252;">"wallet_rt"</span>
     - record: wallet_rt_total_099_1m
       expr: histogram_quantile(0.99, sum by(uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.99"</span>
           name: <span style="color: #8b2252;">"wallet_rt"</span>
     - record: wallet_app_api_tps_endpoints
       expr: sum by (app,uri) (rate(http_server_requests_seconds_count{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>,<span style="color: #a0522d;">job</span>=~<span style="color: #8b2252;">".*endpoints"</span>}[1m]))&gt;0
     - record: wallet_rt_rate
       expr: sum by (app, instance, kubernetes_pod_name, uri, le) (rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>,<span style="color: #a0522d;">job</span>=~<span style="color: #8b2252;">".*pods"</span>,<span style="color: #a0522d;">app</span>=~<span style="color: #8b2252;">"gateway.*"</span>}[1m]))
     - record: wallet_app_api_tps_pods
       expr: sum by (app,uri) (rate(http_server_requests_seconds_count{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>,<span style="color: #a0522d;">job</span>=~<span style="color: #8b2252;">".*pods"</span>}[1m]))&gt;0
     - record: wallet_tps_compare_yesterday_1m
       expr: ((sum by(uri)(irate(http_server_requests_seconds_count{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>,<span style="color: #a0522d;">app</span>=~<span style="color: #8b2252;">"gateway.*"</span>,<span style="color: #a0522d;">job</span>=<span style="color: #8b2252;">"eks-prod-kubernetes-pods"</span>,<span style="color: #a0522d;">uri</span>=~<span style="color: #8b2252;">".*s2s/debit|.*credit|.*initTrans|.*debitNotice"</span>}[1m])) *100)/(sum by(uri) (irate(http_server_requests_seconds_count{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>,<span style="color: #a0522d;">app</span>=~<span style="color: #8b2252;">"gateway.*"</span>,<span style="color: #a0522d;">job</span>=<span style="color: #8b2252;">"eks-prod-kubernetes-pods"</span>,<span style="color: #a0522d;">uri</span>=~<span style="color: #8b2252;">".*s2s/debit|.*credit|.*initTrans|.*debitNotice"</span>}[1m] offset 1d)) &gt;= 0))
     - record: wallet_error_rate
       expr: (sum by (uri,exception) (irate(http_server_requests_seconds_count{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>,exception!~<span style="color: #8b2252;">"None|CasException|CustomException|BizException"</span>,status!=<span style="color: #8b2252;">"200"</span>,uri!~<span style="color: #8b2252;">".*UNKNOWN"</span>}[1m])))/(sum by (uri,exception) (irate(http_server_requests_seconds_count{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>,uri!~<span style="color: #8b2252;">".*UNKNOWN"</span>}[1m])))
     - record: wallet_app_api_exception
       expr: sum by (app,uri,exception) (rate(http_server_requests_seconds_count{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>,<span style="color: #a0522d;">job</span>=~<span style="color: #8b2252;">".*pods"</span>,status!=<span style="color: #8b2252;">"200"</span>}[1m]))
     - record: wallet_rt_histogram_quantile_0999_1m
       expr: histogram_quantile(0.999, sum by(app,uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))&gt;0)
       labels:
         quantile: <span style="color: #8b2252;">"0.999"</span>
         name: <span style="color: #8b2252;">"wallet_rt"</span>
     - record: wallet_rt_total_0999_1m
       expr: histogram_quantile(0.999, sum by(uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))&gt;0)

app.rules.yml: |
 groups:
   - name: app-record
     interval: 1m
     rules:
     - record: app_rt_histogram_quantile_05_1m
       expr: histogram_quantile(0.5, sum by(app,uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>,app!=<span style="color: #8b2252;">"gateway"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.5"</span>
           name: <span style="color: #8b2252;">"app_rt"</span>
     - record: app_rt_histogram_quantile_09_1m
       expr: histogram_quantile(0.9, sum by(app,uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>,app!=<span style="color: #8b2252;">"gateway"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.9"</span>
           name: <span style="color: #8b2252;">"app_rt"</span>
     - record: app_rt_histogram_quantile_099_1m
       expr: histogram_quantile(0.99, sum by(app,uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>,app!=<span style="color: #8b2252;">"gateway"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.99"</span>
           name: <span style="color: #8b2252;">"app_rt"</span>
     - record: app_rt_total_05_1m
       expr: histogram_quantile(0.5, sum by(uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>,app!=<span style="color: #8b2252;">"gateway"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.5"</span>
           name: <span style="color: #8b2252;">"app_rt"</span>
     - record: app_rt_total_09_1m
       expr: histogram_quantile(0.9, sum by(uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>,app!=<span style="color: #8b2252;">"gateway"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.9"</span>
           name: <span style="color: #8b2252;">"app_rt"</span>
     - record: app_rt_total_099_1m
       expr: histogram_quantile(0.99, sum by(uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>,app!=<span style="color: #8b2252;">"gateway"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.99"</span>
           name: <span style="color: #8b2252;">"app_rt"</span>

     - record: app_api_error_requests_total_1m:increase:sum
       expr: sum(increase(api_fail_count_total{<span style="color: #a0522d;">application</span>=<span style="color: #8b2252;">"govern-gateway"</span>,<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>}[1m]))
     - record: app_api_requests_total_1m:increase:sum
       expr: sum(increase(gateway_requests_seconds_count{<span style="color: #a0522d;">application</span>=<span style="color: #8b2252;">"govern-gateway"</span>,<span style="color: #a0522d;">department</span>=<span style="color: #8b2252;">"app"</span>}[1m]))
     - record: app_api_core_error_requests_total_1m:increase:sum
       expr: sum(increase(api_fail_count_total{<span style="color: #a0522d;">application</span>=<span style="color: #8b2252;">"govern-gateway"</span>,<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>,<span style="color: #a0522d;">path</span>=~<span style="color: #8b2252;">"/api/usercenter/getLaunchConfigV3|/usercenter/getLaunchConfigV2 |/api/usercenter/getLaunchConfig|/api/usercenter/hotfix/getHotFixFlag|/usercenter/message/countUnread|/usercenter/postUserFCMToken|/usercenter/getLatestVersion|/api/usercenter/getUserInfo|/api/usercenter/getLaunchConfigV3|/usercenter/getUserIp|/game/getHamburgerMenus"</span>}[1m]))
     - record: core_api_requests_total_1m:increase:sum
      expr: sum(increase(http_server_requests_seconds_count{application!=<span style="color: #8b2252;">"govern-gateway"</span>,<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>,<span style="color: #a0522d;">uri</span>=~<span style="color: #8b2252;">"/usercenter/getLaunchConfigV3|/usercenter/getLaunchConfigV2 |/usercenter/getLaunchConfig|/usercenter/hotfix/getHotFixFlag|/usercenter/message/countUnread|/usercenter/postUserFCMToken|/usercenter/getLatestVersion|/usercenter/getUserInfo|/usercenter/getLaunchConfigV3|/usercenter/getUserIp|/game/getHamburgerMenus"</span>}[1m]))         
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:aa168970-406c-44c0-8cd0-8f3cb0bb80e4" class="outline-3">
<h3 id="h:aa168970-406c-44c0-8cd0-8f3cb0bb80e4">参考</h3>
<div class="outline-text-3" id="text-h:aa168970-406c-44c0-8cd0-8f3cb0bb80e4">
<ul class="org-ul">
<li>监控项参考：<a href="https://monitoring.mixins.dev/kubernetes/">https://monitoring.mixins.dev/kubernetes/</a></li>
<li>PromQL参考：<a href="https://fuckcloudnative.io/prometheus/3-prometheus/basics.html">https://fuckcloudnative.io/prometheus/3-prometheus/basics.html</a></li>
</ul>
</div>
<div id="outline-container-h:1c09d771-38f0-4dd3-a989-e025d209d4ba" class="outline-4">
<h4 id="h:1c09d771-38f0-4dd3-a989-e025d209d4ba">grafana</h4>
<div class="outline-text-4" id="text-h:1c09d771-38f0-4dd3-a989-e025d209d4ba">
</div>
<div id="outline-container-h:d284591d-854c-4e5a-853e-2ee6a38aeb26" class="outline-5">
<h5 id="h:d284591d-854c-4e5a-853e-2ee6a38aeb26">图表变量取值</h5>
<div class="outline-text-5" id="text-h:d284591d-854c-4e5a-853e-2ee6a38aeb26">
<p>
参考：<a href="https://grafana.com/docs/grafana/latest/dashboards/variables/variable-syntax/#advanced-variable-format-options/">https://grafana.com/docs/grafana/latest/dashboards/variables/variable-syntax/#advanced-variable-format-options/</a>
</p>

<p>
如 编辑 Variables，
</p>
<ul class="org-ul">
<li>Name 为 My，Type 为 Custom</li>
<li>Custom options 为 "A : aaa|AAA,B : bbb|BBB,C : ccc|CCCC"</li>
<li>勾选可多选 Multi-value</li>
</ul>


<figure id="org8f46142">
<img src="./images/Snipaste_2023-01-02_07-43-32.png" alt="Snipaste_2023-01-02_07-43-32.png" width="50%">

</figure>


<figure id="org56a1848">
<img src="./images/Snipaste_2023-01-02_07-49-14.png" alt="Snipaste_2023-01-02_07-49-14.png" width="50%">

</figure>

<p>
value
</p>
<div class="org-src-container">
<pre class="src src-shell">String to interpolate: <span style="color: #8b2252;">'${My:value}'</span>
Interpolation result: <span style="color: #8b2252;">'{aaa|AAA,bbb|BBB,ccc|CCC}'</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#36866;&#21512;&#22810;&#36873;</span>
&#34920;&#36798;&#24335;&#65306;
<span style="color: #0000ff;">sum</span>(sum by(url, game, code) (rate(Fb_Net_Code_count{<span style="color: #a0522d;">game</span>=~<span style="color: #8b2252;">".*"</span>,<span style="color: #a0522d;">url</span>=~<span style="color: #8b2252;">".*(${My:value})"</span>,url!~<span style="color: #8b2252;">".*\\.(png|jpg|jpeg|json)"</span>,<span style="color: #a0522d;">prom_cluster</span>=<span style="color: #8b2252;">"prod-eks-client"</span>}[30s])))by (url)
&#35299;&#26512;&#21518;&#65306; &#21487;&#20197;&#30475;&#21040;|&#20998;&#38548;&#25104; {aaa&#12289;AAA,bbb&#12289;ccc|CCCC}
<span style="color: #0000ff;">sum</span>(sum by(url, game, code) (rate(Fb_Net_Code_count{<span style="color: #a0522d;">game</span>=~<span style="color: #8b2252;">".*"</span>,<span style="color: #a0522d;">url</span>=~<span style="color: #8b2252;">".*({aaa|AAA,bbb|BBB,ccc|CCCC})"</span>,url!~<span style="color: #8b2252;">".*\\.(png|jpg|jpeg|json)"</span>,<span style="color: #a0522d;">prom_cluster</span>=<span style="color: #8b2252;">"prod-eks-client"</span>}[30s])))by (url)
</pre>
</div>



<p>
pip
</p>
<div class="org-src-container">
<pre class="src src-shell">String to interpolate: <span style="color: #8b2252;">'${My:pipe}'</span>
Interpolation result: <span style="color: #8b2252;">'aaa|AAA|bbb|BBB|ccc|CCC'</span>

&#34920;&#36798;&#24335;&#65306;
<span style="color: #0000ff;">sum</span>(sum by(url, game, code) (rate(Fb_Net_Code_count{<span style="color: #a0522d;">game</span>=~<span style="color: #8b2252;">".*"</span>,<span style="color: #a0522d;">url</span>=~<span style="color: #8b2252;">".*(${My:pipe})"</span>,url!~<span style="color: #8b2252;">".*\\.(png|jpg|jpeg|json)"</span>,<span style="color: #a0522d;">prom_cluster</span>=<span style="color: #8b2252;">"prod-eks-client"</span>}[30s])))by (url)
&#35299;&#26512;&#21518;&#65306;
<span style="color: #0000ff;">sum</span>(sum by(url, game, code) (rate(Fb_Net_Code_count{<span style="color: #a0522d;">game</span>=~<span style="color: #8b2252;">".*"</span>,<span style="color: #a0522d;">url</span>=~<span style="color: #8b2252;">".*(aaa|AAA|bbb|BBB|ccc|CCCC)"</span>,url!~<span style="color: #8b2252;">".*\\.(png|jpg|jpeg|json)"</span>,<span style="color: #a0522d;">prom_cluster</span>=<span style="color: #8b2252;">"prod-eks-client"</span>}[30s])))by (url)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:c5d5ba75-c5b0-44e8-8b96-2846bf43adce" class="outline-4">
<h4 id="h:c5d5ba75-c5b0-44e8-8b96-2846bf43adce">alertmanager webhook json</h4>
<div class="outline-text-4" id="text-h:c5d5ba75-c5b0-44e8-8b96-2846bf43adce">
<p>
开发参考：<a href="https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/alert-manager-use-receiver/alert-manager-extension-with-webhook">https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/alert-manager-use-receiver/alert-manager-extension-with-webhook</a>
</p>


<p>
使用webhook方式，alertmanager会给配置的webhook地址发送一个http类型的post请求，参数为json字符串（字符串类型），如下（此处格式化为json了）：
</p>

<p>
<a href="https://prometheus.io/docs/alerting/latest/configuration/#webhook_config">https://prometheus.io/docs/alerting/latest/configuration/#webhook_config</a>
</p>

<div class="org-src-container">
<pre class="src src-shell">{
    <span style="color: #8b2252;">"receiver"</span>:<span style="color: #8b2252;">"webhook"</span>,
    <span style="color: #8b2252;">"status"</span>:<span style="color: #8b2252;">"resolved"</span>,
    <span style="color: #8b2252;">"alerts"</span>:[
        {
            <span style="color: #8b2252;">"status"</span>:<span style="color: #8b2252;">"resolved"</span>,
            <span style="color: #8b2252;">"labels"</span>:{
                <span style="color: #8b2252;">"alertname"</span>:<span style="color: #8b2252;">"hostCpuUsageAlert"</span>,
                <span style="color: #8b2252;">"instance"</span>:<span style="color: #8b2252;">"192.168.199.24:9100"</span>,
                <span style="color: #8b2252;">"severity"</span>:<span style="color: #8b2252;">"page"</span>
            },
            <span style="color: #8b2252;">"annotations"</span>:{
                <span style="color: #8b2252;">"description"</span>:<span style="color: #8b2252;">"192.168.199.24:9100 CPU &#20351;&#29992;&#29575;&#36229;&#36807; 85% (&#24403;&#21069;&#20540;&#20026;: 0.9973333333333395)"</span>,
                <span style="color: #8b2252;">"summary"</span>:<span style="color: #8b2252;">"&#26426;&#22120; 192.168.199.24:9100 CPU &#20351;&#29992;&#29575;&#36807;&#39640;"</span>
            },
            <span style="color: #8b2252;">"startsAt"</span>:<span style="color: #8b2252;">"2020-02-29T19:45:21.799548092+08:00"</span>,
            <span style="color: #8b2252;">"endsAt"</span>:<span style="color: #8b2252;">"2020-02-29T19:49:21.799548092+08:00"</span>,
            <span style="color: #8b2252;">"generatorURL"</span>:<span style="color: #8b2252;">"http://localhost.localdomain:9090/graph?g0.expr=sum+by%28instance%29+%28avg+without%28cpu%29+%28irate%28node_cpu_seconds_total%7Bmode%21%3D%22idle%22%7D%5B5m%5D%29%29%29+%3E+0.85&amp;g0.tab=1"</span>,
            <span style="color: #8b2252;">"fingerprint"</span>:<span style="color: #8b2252;">"368e9616d542ab48"</span>
        }
    ],
    <span style="color: #8b2252;">"groupLabels"</span>:{
        <span style="color: #8b2252;">"alertname"</span>:<span style="color: #8b2252;">"hostCpuUsageAlert"</span>
    },
    <span style="color: #8b2252;">"commonLabels"</span>:{
        <span style="color: #8b2252;">"alertname"</span>:<span style="color: #8b2252;">"hostCpuUsageAlert"</span>,
        <span style="color: #8b2252;">"instance"</span>:<span style="color: #8b2252;">"192.168.199.24:9100"</span>,
        <span style="color: #8b2252;">"severity"</span>:<span style="color: #8b2252;">"page"</span>
    },
    <span style="color: #8b2252;">"commonAnnotations"</span>:{
        <span style="color: #8b2252;">"description"</span>:<span style="color: #8b2252;">"192.168.199.24:9100 CPU &#20351;&#29992;&#29575;&#36229;&#36807; 85% (&#24403;&#21069;&#20540;&#20026;: 0.9973333333333395)"</span>,
        <span style="color: #8b2252;">"summary"</span>:<span style="color: #8b2252;">"&#26426;&#22120; 192.168.199.24:9100 CPU &#20351;&#29992;&#29575;&#36807;&#39640;"</span>
    },
    <span style="color: #8b2252;">"externalURL"</span>:<span style="color: #8b2252;">"http://localhost.localdomain:9093"</span>,
    <span style="color: #8b2252;">"version"</span>:<span style="color: #8b2252;">"4"</span>,
    <span style="color: #8b2252;">"groupKey"</span>:<span style="color: #8b2252;">"{}:{alertname="</span>hostCpuUsageAlert<span style="color: #8b2252;">"}"</span>
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:efe9f42f-ac0d-4231-a8ee-71b44e1420ad" class="outline-4">
<h4 id="h:efe9f42f-ac0d-4231-a8ee-71b44e1420ad">PromSQL</h4>
<div class="outline-text-4" id="text-h:efe9f42f-ac0d-4231-a8ee-71b44e1420ad">
<p>
<a href="https://valyala.medium.com/promql-tutorial-for-beginners-9ab455142085">https://valyala.medium.com/promql-tutorial-for-beginners-9ab455142085</a>
</p>

<p>
Metric 名称只是一个带有特殊名称的普通标签——  <code>__name__</code>. 因此，可以通过对指标名称应用正则表达式来执行多个指标名称的过滤。
</p>
<div class="org-src-container">
<pre class="src src-shell">{<span style="color: #a0522d;">__name__</span>=~<span style="color: #8b2252;">"node_network_(receive|transmit)_bytes_total"</span>}

{<span style="color: #a0522d;">__name__</span>=~<span style="color: #8b2252;">".*"</span>,<span style="color: #a0522d;">job</span>=~<span style="color: #8b2252;">"pushgateway"</span>}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:59dc55b1-82c4-4536-b5f1-32a8ba53c03c" class="outline-4">
<h4 id="h:59dc55b1-82c4-4536-b5f1-32a8ba53c03c">prometheus 数据清理</h4>
<div class="outline-text-4" id="text-h:59dc55b1-82c4-4536-b5f1-32a8ba53c03c">
<p>
<b>数据删除</b>
</p>

<p>
使用 API 需要先添加启动参数 –web.enable-admin-api 打开.
</p>

<p>
/api/v1/admin/tsdb/delete_series
如果成功，则返回204状态码。
该接口有以下三个参数
</p>
<ul class="org-ul">
<li>match[]=：选择要删除的系列的重复标签匹配器参数。match[]必须至少提供一个参数。</li>
<li>start=: 开始时间戳。可选，默认为最短时间。</li>
<li>end=: 结束时间戳。可选，默认为最大可能时间。</li>
</ul>

<p>
如果没有指定开始和结束时间将删除数据库中匹配的所有数据。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#21305;&#37197;&#25968;&#25454;</span>
curl -X POST -g <span style="color: #8b2252;">'http://xxx.com/api/v1/admin/tsdb/delete_series?match[]={wanip="10.244.2.158:9090"}'</span> 

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#25152;&#26377;&#25968;&#25454;</span>
curl -X POST -g <span style="color: #8b2252;">'http://xxx.com/api/v1/admin/tsdb/delete_series?match[]={__name__=~".+"}'</span> 

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#25351;&#23450;&#30340;Metric</span>
curl -X POST -g <span style="color: #8b2252;">'http://127.0.0.1:9090/api/v1/admin/tsdb/delete_series?match[]=node_cpu_seconds_total'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#25351;&#23450; Metric &#21517;&#31216;&#21644;&#29305;&#23450; label &#21517;&#31216;&#30340;&#20840;&#37096;&#25968;&#25454;</span>
curl -X POST -g <span style="color: #8b2252;">'http://127.0.0.1:9090/api/v1/admin/tsdb/delete_series?match[]=node_cpu_seconds_total{mode="idle"}'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#25351;&#23450;&#26102;&#38388;&#33539;&#22260;&#20869;&#30340; Metric &#25968;&#25454;</span>
curl -X POST -g <span style="color: #8b2252;">'http://127.0.0.1:9090/api/v1/admin/tsdb/delete_series?start=1578301194&amp;end=1578301694&amp;match[]=node_cpu_seconds_total{mode="idle"}'</span>


 curl -X POST   -g <span style="color: #8b2252;">'http://127.0.0.1:9090/api/v1/admin/tsdb/delete_series?match[]=redis_seconds_bucket{app="geo"}&amp;start=2023-04-26T04:00:00.000Z'</span>

linux &#21487;&#20197;&#20351;&#29992; 
date +%s <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#24471;&#24403;&#21069;&#30340;&#26102;&#38388;&#25139;&#65292;&#21487;&#20197;&#20351;&#29992; </span>
date -d <span style="color: #8b2252;">"2019-12-22 00:00:00"</span> +%s <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#25351;&#23450;&#30340;&#26085;&#26399;&#36716;&#25104;&#26102;&#38388;&#25139;&#12290;</span>
</pre>
</div>

<p>
此接口会将样本标记为已删除，标记内容存储在block文件夹中的tombstones，Prometheus发生Block压缩时或者调用 <code>clean_tombstones</code> 接口时才会真正删除数据。
</p>

<p>
<b>删除数据的清理</b>
</p>

<p>
上面我们说过使用delete_series接口仅会将数据标识为”删除”， 并没有从磁盘中真正删除，clean_tombstones接口就是触发清理删除的。
</p>

<p>
/api/v1/admin/tsdb/clean_tombstones
</p>

<p>
如果删除成功，会返回 204 。
</p>

<div class="org-src-container">
<pre class="src src-sh">curl -X POST http://127.0.0.1:9090/api/v1/admin/tsdb/clean_tombstones
</pre>
</div>
</div>
</div>
<div id="outline-container-h:711178d5-9434-45b4-8e2b-247afdb0f7f7" class="outline-4">
<h4 id="h:711178d5-9434-45b4-8e2b-247afdb0f7f7">pushgateway</h4>
<div class="outline-text-4" id="text-h:711178d5-9434-45b4-8e2b-247afdb0f7f7">
</div>
<div id="outline-container-h:d6ccbdf3-13d3-49e7-9fa8-2ccde0f527c8" class="outline-5">
<h5 id="h:d6ccbdf3-13d3-49e7-9fa8-2ccde0f527c8">安装</h5>
<div class="outline-text-5" id="text-h:d6ccbdf3-13d3-49e7-9fa8-2ccde0f527c8">
<p>
参数
</p>
<div class="org-src-container">
<pre class="src src-shell">--web.listen-address=<span style="color: #8b2252;">":9091"</span>      &#30417;&#21548;Web&#30028;&#38754;&#65292;API&#21644;&#36965;&#27979;&#30340;&#22320;&#22336;&#12290;
--web.telemetry-path=<span style="color: #8b2252;">"/metrics"</span>     &#20844;&#24320;metrics&#30340;&#36335;&#24452;&#12290;
--web.external-url=             &#21487;&#20174;&#22806;&#37096;&#35775;&#38382;Pushgateway&#30340;URL.
--web.route-prefix=<span style="color: #8b2252;">""</span>           Web&#31471;&#28857;&#20869;&#37096;&#36335;&#30001;&#30340;&#21069;&#32512;&#12290; &#40664;&#35748;&#20026;--web.external-url&#30340;&#36335;&#24452;.
--persistence.file=<span style="color: #8b2252;">""</span>           &#24402;&#26723;&#20197;&#20445;&#30041;metrics&#12290; &#22914;&#26524;&#20026;&#31354;&#65292;&#21017;metrics&#20165;&#20445;&#30041;&#22312;&#20869;&#23384;&#20013;.
--persistence.interval=5m       &#20889;&#20837;&#25345;&#20037;&#24615;&#25991;&#20214;&#30340;&#26368;&#23567;&#38388;&#38548;&#12290;
--log.level=<span style="color: #8b2252;">"info"</span>              &#20165;&#35760;&#24405;&#20855;&#26377;&#32473;&#23450;&#20005;&#37325;&#24615;&#25110;&#26356;&#39640;&#20005;&#37325;&#24615;&#30340;&#28040;&#24687;&#12290; &#26377;&#25928;&#32423;&#21035;&#65306;[debug, info, warn, error, fatal]
--log.format=<span style="color: #8b2252;">"logger:stderr"</span>      &#35774;&#32622;&#26085;&#24535;&#30446;&#26631;&#21644;&#26684;&#24335;&#12290; &#31034;&#20363;&#65306;&#8220; logger&#65306;syslog&#65311;appname = bob&#65286;local = 7&#8221;&#25110;&#8220; logger&#65306;stdout&#65311;json = true&#8221;
--version                       &#26174;&#31034;&#24212;&#29992;&#31243;&#24207;&#29256;&#26412;&#12290;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:77378b9a-c99d-4ef0-9edc-0c9a6f8f5c14" class="outline-5">
<h5 id="h:77378b9a-c99d-4ef0-9edc-0c9a6f8f5c14">清理数据</h5>
<div class="outline-text-5" id="text-h:77378b9a-c99d-4ef0-9edc-0c9a6f8f5c14">
<p>
<a href="https://p8s.io/docs/pushgateway/">https://p8s.io/docs/pushgateway/</a>
</p>


<p>
比如删除由 {job="some_job",instance="some_instance"} 标识的分组中的所有指标，可以通过下面的命令来实现：
</p>
<div class="org-src-container">
<pre class="src src-shell">curl -X DELETE http://pushgateway_ip:9091/metrics/job/some_job/instance/some_instance
</pre>
</div>

<p>
如果你想删除所有组中的所有指标，可以使用下面的命令来实现：
</p>

<p>
需要启用 -web.enable-admin-api 来启用管理 API
</p>
<div class="org-src-container">
<pre class="src src-sh">curl -X PUT http://192.168.0.106:30893/api/v1/admin/wipe
</pre>
</div>

<p>
删除 job
</p>
<div class="org-src-container">
<pre class="src src-shell">
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a7b9e28b-349f-468f-9383-85c616c2889a" class="outline-5">
<h5 id="h:a7b9e28b-349f-468f-9383-85c616c2889a">脚本</h5>
<div class="outline-text-5" id="text-h:a7b9e28b-349f-468f-9383-85c616c2889a">
<div class="org-src-container">
<pre class="src src-shell">cat service_status.conf
[program:service_monitor]
<span style="color: #483d8b;">command</span> =  /bin/bash /devops/alivecheck/service_monitor.sh
user = root
autostart = true
autorestart = true
<span style="color: #a0522d;">redirect_stderr</span>=true
stdout_logfile_backups = 5
stdout_logfile = /devops/alivecheck/service_monitor.log


[root@ip-172-21-89-103 conf.d]# cat /devops/alivecheck/service_monitor.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #b22222;">#</span>

<span style="color: #483d8b;">source</span> /etc/profile

<span style="color: #a0522d;">SpringBoot</span>=$<span style="color: #a0522d;">1</span>
<span style="color: #a0522d;">hostname1</span>=$(<span style="color: #ff00ff;">hostname</span>)
<span style="color: #a0522d;">hostname</span>=${<span style="color: #a0522d;">hostname1</span>%%.*}
<span style="color: #a0522d;">service_list</span>=(<span style="color: #8b2252;">"rummy-center"</span> <span style="color: #8b2252;">"rummy-game"</span> <span style="color: #8b2252;">"rummy-gateway"</span> <span style="color: #8b2252;">"rummy-room"</span> <span style="color: #8b2252;">"rummy-user"</span>)

<span style="color: #a020f0;">while</span> true; <span style="color: #a020f0;">do</span>
  <span style="color: #a0522d;">sv1</span>=<span style="color: #8b2252;">""</span>
  <span style="color: #483d8b;">let</span> <span style="color: #a0522d;">n</span>=0
  <span style="color: #483d8b;">let</span> <span style="color: #a0522d;">m</span>=${#<span style="color: #a0522d;">service_list</span>[*]}
  <span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> ${<span style="color: #a0522d;">service_list</span>[*]}; <span style="color: #a020f0;">do</span>
        <span style="color: #a0522d;">va</span>=$(<span style="color: #ff00ff;">jps -l |grep  " $i.jar"|awk '{print $1}'</span>)
        <span style="color: #a020f0;">if</span> [ ! -z <span style="color: #8b2252;">"$va"</span> ]; <span style="color: #a020f0;">then</span>
                <span style="color: #a0522d;">port</span>=$(<span style="color: #ff00ff;">sudo netstat -tnlp|grep $va|awk '{print $4}'|awk -F: '{print $NF}'</span>)
                <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"podrt"</span>$<span style="color: #a0522d;">port</span>
                <span style="color: #a020f0;">if</span> [ -z $<span style="color: #a0522d;">port</span> ]; <span style="color: #a020f0;">then</span>
                        <span style="color: #a0522d;">cr</span>=0
                <span style="color: #a020f0;">else</span>
                        <span style="color: #a0522d;">cr</span>=$(<span style="color: #ff00ff;">curl -G -m 10 --connect-timeout 60 -o /dev/null -s -w %{http_code} http://127.0.0.1:$port/api/health/check</span>)
                <span style="color: #a020f0;">fi</span>
      <span style="color: #a020f0;">else</span>
          <span style="color: #a0522d;">cr</span>=0
      <span style="color: #a020f0;">fi</span>
      <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$i-cr"</span>$<span style="color: #a0522d;">cr</span>
        <span style="color: #a0522d;">sv1</span>=$<span style="color: #a0522d;">sv1</span><span style="color: #8b2252;">"service_status{service_name=\"$i\"} $cr"</span>
        <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">n</span> -lt $<span style="color: #a0522d;">m</span> ]; <span style="color: #a020f0;">then</span>
          <span style="color: #a0522d;">sv1</span>=$<span style="color: #a0522d;">sv1</span><span style="color: #8b2252;">"\n"</span>
        <span style="color: #a020f0;">fi</span>
  <span style="color: #a020f0;">done</span>
<span style="color: #483d8b;">echo</span> -e $<span style="color: #a0522d;">sv1</span> | curl -s --data-binary @- http://172.21.39.120:9091/metrics/job/rummy/hostname/$<span style="color: #a0522d;">hostname</span>/business/Rummy
      <span style="color: #b22222;">#</span><span style="color: #b22222;">echo -e $sv1</span>
  sleep 10
<span style="color: #a020f0;">done</span>
</pre>
</div>

<p>
db
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/</span><span style="color: #a020f0;">bash</span>
<span style="color: #a0522d;">instance_name</span>=<span style="color: #ff00ff;">`ifconfig |grep 172.21|awk '{print $2}'`</span>
<span style="color: #a020f0;">while</span> (( 0 &lt; 1))
<span style="color: #a020f0;">do</span>
    <span style="color: #a0522d;">count_mysql_long_tran_list</span>=<span style="color: #ff00ff;">`/usr/local/mysql/bin/mysql -u'username' -p'******' -h172.21.89.151 -N -e"</span>
<span style="color: #ff00ff;">select count(*) from information_schema.innodb_trx where TIMESTAMPDIFF( SECOND, trx_started, now() ) &gt;= 0.5 and TIMESTAMPDIFF( SECOND, trx_started, now() ) &lt; 10 and trx_query not like 'alter%'</span>
<span style="color: #ff00ff;">UNION ALL</span>
<span style="color: #ff00ff;">select count(*) from information_schema.innodb_trx where TIMESTAMPDIFF( SECOND, trx_started, now() ) &gt;= 10 and TIMESTAMPDIFF( SECOND, trx_started, now() ) &lt; 30 and trx_query not like 'alter%'</span>
<span style="color: #ff00ff;">UNION ALL</span>
<span style="color: #ff00ff;">select count(*) from information_schema.innodb_trx where TIMESTAMPDIFF( SECOND, trx_started, now() ) &gt;= 30 and TIMESTAMPDIFF( SECOND, trx_started, now() ) &lt; 60 and trx_query not like 'alter%'</span>
<span style="color: #ff00ff;">UNION ALL</span>
<span style="color: #ff00ff;">select count(*) from information_schema.innodb_trx where TIMESTAMPDIFF( SECOND, trx_started, now() ) &gt;= 60 and trx_query not like 'alter%';"`</span>
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">count_mysql_long_tran_list</span>|awk -F <span style="color: #8b2252;">" "</span> <span style="color: #8b2252;">'{print}'</span>|<span style="color: #a020f0;">while </span><span style="color: #483d8b;">read</span> count_mysql_long_tran_05 count_mysql_long_tran_10 count_mysql_long_tran_30 count_mysql_long_tran_60
    <span style="color: #a020f0;">do</span>
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"count_mysql_long_tran_05 $count_mysql_long_tran_05"</span>|curl --data-binary @- http://172.21.39.120:9091/metrics/job/pushgatway/instance/$<span style="color: #a0522d;">instance_name</span>/business/Wallet
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"count_mysql_long_tran_10 $count_mysql_long_tran_10"</span>|curl --data-binary @- http://172.21.39.120:9091/metrics/job/pushgatway/instance/$<span style="color: #a0522d;">instance_name</span>/business/Wallet
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"count_mysql_long_tran_30 $count_mysql_long_tran_30"</span>|curl --data-binary @- http://172.21.39.120:9091/metrics/job/pushgatway/instance/$<span style="color: #a0522d;">instance_name</span>/business/Wallet
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"count_mysql_long_tran_60 $count_mysql_long_tran_60"</span>|curl --data-binary @- http://172.21.39.120:9091/metrics/job/pushgatway/instance/$<span style="color: #a0522d;">instance_name</span>/business/Wallet
    <span style="color: #a020f0;">done</span>
sleep 1
<span style="color: #a020f0;">done</span>
</pre>
</div>

<p>
python
</p>
<div class="org-src-container">
<pre class="src src-shell">[root@ip-172-21-39-120 conf.d]# cat  /data/devops/wallet_sql_exception_check/check_index.py
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">-*- encoding: utf-8 -*-</span>
<span style="color: #8b2252;">'''</span>
<span style="color: #8b2252;">@File    :   1.py</span>
<span style="color: #8b2252;">@Time    :   2021/01/19 16:18:46</span>
<span style="color: #8b2252;">@Author  :   jack fu</span>
<span style="color: #8b2252;">@Version :   1.0</span>
<span style="color: #8b2252;">@Contact :   jack.fu@paytm.com</span>
<span style="color: #8b2252;">'''</span>
import datetime
import time
import requests
base_url = <span style="color: #8b2252;">"http://172.21.38.147:9200"</span>


def send_dingtalk(data):

    token = <span style="color: #8b2252;">"ac3e20cca5147c"</span>
    <span style="color: #a020f0;">if</span> not token:
        print(<span style="color: #8b2252;">'you must set ROBOT_TOKEN env'</span>)
        <span style="color: #a020f0;">return</span>
    url = <span style="color: #8b2252;">'http://maven.xxx.com/robot/send?access_token=%s'</span> % token
    send_data = {<span style="color: #8b2252;">"msgtype"</span>: <span style="color: #8b2252;">"text"</span>, <span style="color: #8b2252;">"text"</span>: {<span style="color: #8b2252;">"content"</span>: data}}
    req = requests.post(url, <span style="color: #a0522d;">json</span>=send_data)
    result = req.json()
    print(<span style="color: #8b2252;">"error"</span>, result)
    <span style="color: #a020f0;">if</span> result[<span style="color: #8b2252;">'errcode'</span>] != 0:
        print(<span style="color: #8b2252;">'notify dingtalk error: %s'</span> % result[<span style="color: #8b2252;">'errcode'</span>])


<span style="color: #b22222;">#</span><span style="color: #b22222;">def get_mysql_gone_away_err(time_start, time_end,error_type='php-mis-err'):</span>
def get_mysql_gone_away_err():
    response = requests.get(
        f<span style="color: #8b2252;">'{base_url}/wallet-*/_search?filter_path=aggregations.group.buckets'</span>,
        <span style="color: #a0522d;">headers</span>={<span style="color: #8b2252;">'content-type'</span>: <span style="color: #8b2252;">'application/json'</span>},
        <span style="color: #a0522d;">json</span>={
            <span style="color: #8b2252;">"sort"</span>: [{
                <span style="color: #8b2252;">"@timestamp"</span>: {
                    <span style="color: #8b2252;">"order"</span>: <span style="color: #8b2252;">"desc"</span>,
                    <span style="color: #8b2252;">"unmapped_type"</span>: <span style="color: #8b2252;">"boolean"</span>
                }
            }],
            <span style="color: #8b2252;">"aggs"</span>: {
                <span style="color: #8b2252;">"group"</span>: {
                    <span style="color: #8b2252;">"date_histogram"</span>: {
                        <span style="color: #8b2252;">"field"</span>: <span style="color: #8b2252;">"@timestamp"</span>,
                        <span style="color: #8b2252;">"interval"</span>: <span style="color: #8b2252;">"1d"</span>,
                        <span style="color: #8b2252;">"time_zone"</span>: <span style="color: #8b2252;">"Asia/Shanghai"</span>,
                        <span style="color: #8b2252;">"min_doc_count"</span>: 1
                    }
                }
            },
            <span style="color: #8b2252;">"query"</span>: {
                <span style="color: #8b2252;">"bool"</span>: {
                    <span style="color: #8b2252;">"must"</span>: [{
                        <span style="color: #8b2252;">"query_string"</span>: {
                            <span style="color: #8b2252;">"query"</span>: <span style="color: #8b2252;">"\"Connection is not available\""</span>,
                            <span style="color: #8b2252;">"analyze_wildcard"</span>: True,
                            <span style="color: #8b2252;">"default_field"</span>: <span style="color: #8b2252;">"*"</span>
                        }
                    }, {
                        <span style="color: #8b2252;">"range"</span>: {
                            <span style="color: #8b2252;">"@timestamp"</span>: {
                                <span style="color: #8b2252;">"gt"</span>: <span style="color: #8b2252;">"now-2m"</span>,
                                <span style="color: #8b2252;">"lt"</span>: <span style="color: #8b2252;">"now"</span>
                            }
                        }
                    }]
                }
            }
        })
    print(response.text)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">get_mysql_gone_away_err()</span>
    buckets = response.json().get(<span style="color: #8b2252;">'aggregations'</span>).get(<span style="color: #8b2252;">'group'</span>).get(<span style="color: #8b2252;">'buckets'</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">print(buckets)</span>
    date_cnt_arr = []
    <span style="color: #a020f0;">for</span> _sub_bucket<span style="color: #a020f0;"> in</span> buckets:
        date_cnt_arr.append( f<span style="color: #8b2252;">'''Alert: wallet sql exception Connection is not avaliable {_sub_bucket.get('</span>key_as_string<span style="color: #8b2252;">')[:10]} count: {_sub_bucket.get('</span>doc_count<span style="color: #8b2252;">')}'''</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">return int(time.time()) - utc_to_local(end_source['@timestamp'])</span>
    alert_msg = <span style="color: #8b2252;">"\n"</span>.join(date_cnt_arr)
    print(alert_msg)

    <span style="color: #a020f0;">if</span> len(alert_msg) &gt; 5:
        send_dingtalk(alert_msg)
        time.sleep(30)
    <span style="color: #a020f0;">else</span>:
        pass


<span style="color: #a020f0;">if</span> __name__ == <span style="color: #8b2252;">"__main__"</span>:
    <span style="color: #a020f0;">while</span> True:
      get_mysql_gone_away_err()
      time.sleep(30)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ff228fea-7a85-47ec-b622-7c0a340fb9aa" class="outline-5">
<h5 id="h:ff228fea-7a85-47ec-b622-7c0a340fb9aa">pushway 脚本</h5>
<div class="outline-text-5" id="text-h:ff228fea-7a85-47ec-b622-7c0a340fb9aa">
<p>
service_monitor.sh
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/</span><span style="color: #a020f0;">bash</span>
<span style="color: #b22222;">#</span>

<span style="color: #483d8b;">source</span> /etc/profile

<span style="color: #a0522d;">SpringBoot</span>=$<span style="color: #a0522d;">1</span>
<span style="color: #a0522d;">hostname1</span>=$(<span style="color: #ff00ff;">hostname</span>)
<span style="color: #a0522d;">hostname</span>=${<span style="color: #a0522d;">hostname1</span>%%.*}
<span style="color: #a0522d;">service_list</span>=(<span style="color: #8b2252;">"rummy-center"</span> <span style="color: #8b2252;">"rummy-game"</span> <span style="color: #8b2252;">"rummy-gateway"</span> <span style="color: #8b2252;">"rummy-room"</span> <span style="color: #8b2252;">"rummy-user"</span>)

<span style="color: #a020f0;">while</span> true; <span style="color: #a020f0;">do</span>
  <span style="color: #a0522d;">sv1</span>=<span style="color: #8b2252;">""</span>
  <span style="color: #483d8b;">let</span> <span style="color: #a0522d;">n</span>=0
  <span style="color: #483d8b;">let</span> <span style="color: #a0522d;">m</span>=${#<span style="color: #a0522d;">service_list</span>[*]}
  <span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> ${<span style="color: #a0522d;">service_list</span>[*]}; <span style="color: #a020f0;">do</span>
        <span style="color: #a0522d;">va</span>=$(<span style="color: #ff00ff;">jps -l |grep  " $i.jar"|awk '{print $1}'</span>)
        <span style="color: #a020f0;">if</span> [ ! -z <span style="color: #8b2252;">"$va"</span> ]; <span style="color: #a020f0;">then</span>
                <span style="color: #a0522d;">port</span>=$(<span style="color: #ff00ff;">sudo netstat -tnlp|grep $va|awk '{print $4}'|awk -F: '{print $NF}'</span>)
                <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"podrt"</span>$<span style="color: #a0522d;">port</span>
                <span style="color: #a020f0;">if</span> [ -z $<span style="color: #a0522d;">port</span> ]; <span style="color: #a020f0;">then</span>
                        <span style="color: #a0522d;">cr</span>=0
                <span style="color: #a020f0;">else</span>
                        <span style="color: #a0522d;">cr</span>=$(<span style="color: #ff00ff;">curl -G -m 10 --connect-timeout 60 -o /dev/null -s -w %{http_code} http://127.0.0.1:$port/api/health/check</span>)
                <span style="color: #a020f0;">fi</span>
      <span style="color: #a020f0;">else</span>
          <span style="color: #a0522d;">cr</span>=0
      <span style="color: #a020f0;">fi</span>
      <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$i-cr"</span>$<span style="color: #a0522d;">cr</span>
        <span style="color: #a0522d;">sv1</span>=$<span style="color: #a0522d;">sv1</span><span style="color: #8b2252;">"service_status{service_name=\"$i\"} $cr"</span>
        <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">n</span> -lt $<span style="color: #a0522d;">m</span> ]; <span style="color: #a020f0;">then</span>
          <span style="color: #a0522d;">sv1</span>=$<span style="color: #a0522d;">sv1</span><span style="color: #8b2252;">"\n"</span>
        <span style="color: #a020f0;">fi</span>
  <span style="color: #a020f0;">done</span>
<span style="color: #483d8b;">echo</span> -e $<span style="color: #a0522d;">sv1</span> | curl -s --data-binary @- http://172.21.39.120:9091/metrics/job/rummy/hostname/$<span style="color: #a0522d;">hostname</span>/business/Rummy
      <span style="color: #b22222;">#</span><span style="color: #b22222;">echo -e $sv1</span>
  sleep 10
<span style="color: #a020f0;">done</span>
</pre>
</div>

<p>
process_monitor.sh
</p>

<div class="org-src-container">
<pre class="src src-shell">cat  /devops/alivecheck/process_monitor.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #b22222;">#</span>
<span style="color: #a0522d;">SpringBoot</span>=$<span style="color: #a0522d;">1</span>
<span style="color: #a0522d;">hostname1</span>=$(<span style="color: #ff00ff;">hostname</span>)
<span style="color: #a0522d;">hostname</span>=${<span style="color: #a0522d;">hostname1</span>%%.*}
<span style="color: #a0522d;">service_list</span>=(<span style="color: #8b2252;">"rummy-center"</span> <span style="color: #8b2252;">"rummy-game"</span> <span style="color: #8b2252;">"rummy-gateway"</span> <span style="color: #8b2252;">"rummy-room"</span> <span style="color: #8b2252;">"rummy-user"</span>)

<span style="color: #a020f0;">while</span> true; <span style="color: #a020f0;">do</span>
  <span style="color: #a0522d;">sv1</span>=<span style="color: #8b2252;">""</span>
  <span style="color: #483d8b;">let</span> <span style="color: #a0522d;">n</span>=0
  <span style="color: #483d8b;">let</span> <span style="color: #a0522d;">m</span>=${#<span style="color: #a0522d;">service_list</span>[*]}
  <span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> ${<span style="color: #a0522d;">service_list</span>[*]}; <span style="color: #a020f0;">do</span>
      <span style="color: #a0522d;">n</span>=$(<span style="color: #ff00ff;">(n+1</span>))
      <span style="color: #b22222;">#</span><span style="color: #b22222;">z=$(</span><span style="color: #ff00ff;">ps -ef |grep java|grep $i.jar|grep -v grep|wc -l</span><span style="color: #b22222;">)</span>
      <span style="color: #b22222;"># </span><span style="color: #b22222;">last modtify by song 20200205 add merchantpush svc monitor</span>
      <span style="color: #a0522d;">z</span>=$(<span style="color: #ff00ff;">ps -ef |grep java|grep " $i.jar"|grep -v grep|wc -l</span>)
      <span style="color: #a0522d;">sv1</span>=$<span style="color: #a0522d;">sv1</span><span style="color: #8b2252;">"alive_check{service_name=\"$i\"} $z"</span>
      <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">n</span> -lt $<span style="color: #a0522d;">m</span> ]; <span style="color: #a020f0;">then</span>
        <span style="color: #a0522d;">sv1</span>=$<span style="color: #a0522d;">sv1</span><span style="color: #8b2252;">"\n"</span>
      <span style="color: #a020f0;">fi</span>
  <span style="color: #a020f0;">done</span>
<span style="color: #483d8b;">echo</span> -e $<span style="color: #a0522d;">sv1</span> | curl -s --data-binary @- http://172.21.39.120:9091/metrics/job/rummy/hostname/$<span style="color: #a0522d;">hostname</span>/business/Rummy
      <span style="color: #483d8b;">echo</span> -e $<span style="color: #a0522d;">sv1</span>
  sleep 10
<span style="color: #a020f0;">done</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">curl -XPOST -H "Content-Type: text/plain" --data "$var</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">" http://172.21.39.69:9091/metrics/job/top/instance/machine</span>
</pre>
</div>

<p>
redisClusterAliveCheck.sh
</p>
<div class="org-src-container">
<pre class="src src-shell">cat /devops/alivecheck/redisClusterAliveCheck.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #b22222;">#</span>
<span style="color: #a0522d;">SpringBoot</span>=$<span style="color: #a0522d;">1</span>
<span style="color: #a0522d;">hostname1</span>=$(<span style="color: #ff00ff;">hostname</span>)
<span style="color: #a0522d;">hostname</span>=${<span style="color: #a0522d;">hostname1</span>%%.*}
<span style="color: #b22222;">#</span><span style="color: #b22222;">service_list=("mainserver" "eurekaserver")</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">service_list=('["push.jar", "usercenter.jar", "scheduler.jar", "mylibrary.jar", "game.jar", "filesystem.jar"]')</span>
<span style="color: #a0522d;">server_list</span>=(<span style="color: #8b2252;">"agt-newrummy-prod.8r1pyf.ng.0001.aps1.cache.amazonaws.com"</span> <span style="color: #8b2252;">"agt-newrummy-prod-001.8r1pyf.0001.aps1.cache.amazonaws.com"</span> <span style="color: #8b2252;">"agt-newrummy-prod-002.8r1pyf.0001.aps1.cache.amazonaws.com</span>
<span style="color: #8b2252;">"</span>)
<span style="color: #b22222;">#</span><span style="color: #b22222;">/usr/bin/redis-cli -h  agt-gpl-game-cache.8r1pyf.0001.aps1.cache.amazonaws.com EXISTS "MMO_SERVER_ADDRESS"</span>
<span style="color: #a020f0;">while</span> true; <span style="color: #a020f0;">do</span>
  <span style="color: #a0522d;">sv2</span>=<span style="color: #8b2252;">""</span>
  <span style="color: #483d8b;">let</span> <span style="color: #a0522d;">n</span>=0
  <span style="color: #483d8b;">let</span> <span style="color: #a0522d;">m</span>=${#<span style="color: #a0522d;">server_list</span>[*]}
  <span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> ${<span style="color: #a0522d;">server_list</span>[*]}; <span style="color: #a020f0;">do</span>
      <span style="color: #a0522d;">n</span>=$(<span style="color: #ff00ff;">(n+1</span>))
      <span style="color: #b22222;">#</span><span style="color: #b22222;">z=$(</span><span style="color: #ff00ff;">/usr/bin/redis-cli -h  agt-gpl-game-cache.8r1pyf.0001.aps1.cache.amazonaws.com EXISTS $i</span><span style="color: #b22222;">)</span>
      <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"***************************"</span>$(<span style="color: #ff00ff;">date</span>)<span style="color: #8b2252;">"*********************************"</span> &gt;&gt; /devops/alivecheck/redisali.log
      $(<span style="color: #ff00ff;">timeout 5 /bin/redis-cli -h $i INFO &gt;&gt; /devops/alivecheck/redisali.log</span>)
      <span style="color: #b22222;">#</span><span style="color: #b22222;">echo "ZZZZ" $z</span>
      <span style="color: #a0522d;">sv1</span>=$<span style="color: #a0522d;">?</span>
      <span style="color: #a0522d;">sv2</span>=$<span style="color: #a0522d;">sv2</span><span style="color: #8b2252;">"redisAliveCheck{key_name=\"$i\"} $sv1"</span>

      <span style="color: #a020f0;">if</span> [ <span style="color: #8b2252;">"$sv1"</span> -ne 0 ]; <span style="color: #a020f0;">then</span>
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"***************************"</span>${<span style="color: #a0522d;">hostname</span>}${<span style="color: #a0522d;">i</span>} connected out <span style="color: #8b2252;">"*********************************"</span> &gt;&gt; /devops/alivecheck/redisali.log
      <span style="color: #a020f0;">fi</span>

      <span style="color: #b22222;">#</span><span style="color: #b22222;">echo "iiiiiiqqq" $?</span>
      <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">n</span> -lt $<span style="color: #a0522d;">m</span> ]; <span style="color: #a020f0;">then</span>
        <span style="color: #a0522d;">sv2</span>=$<span style="color: #a0522d;">sv2</span><span style="color: #8b2252;">"\n"</span>
      <span style="color: #a020f0;">fi</span>
   <span style="color: #a020f0;">done</span>
      <span style="color: #483d8b;">echo</span> -e $<span style="color: #a0522d;">sv2</span> | curl --data-binary @- http://172.21.39.120:9091/metrics/job/redisAliveCheck/hostname/$<span style="color: #a0522d;">hostname</span>
      <span style="color: #483d8b;">echo</span> -e $<span style="color: #a0522d;">sv2</span>
  sleep 5
<span style="color: #a020f0;">done</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">curl -XPOST -H "Content-Type: text/plain" --data "$var</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">" http://172.21.39.69:9091/metrics/job/top/instance/machine</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:8b99ae58-538e-4c00-a31b-018b034f9d37" class="outline-4">
<h4 id="h:8b99ae58-538e-4c00-a31b-018b034f9d37">告警钉钉通知</h4>
<div class="outline-text-4" id="text-h:8b99ae58-538e-4c00-a31b-018b034f9d37">
<p>
github 地址：<a href="https://github.com/timonwong/prometheus-webhook-dingtalk">https://github.com/timonwong/prometheus-webhook-dingtalk</a>
</p>

<p>
配置
</p>
<div class="org-src-container">
<pre class="src src-shell">[root@ip-172-21-39-120 prometheus-webhook-dingtalk]# cat config.yml
templates:
  - /data/devops/prometheus-webhook-dingtalk/contrib/templates/legacy/template.tmpl

targets:
  wallet-webhook-critical:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">Wallet PRD &#21578;&#35686;&#32676;</span>
    url: https://oapi.dingtalk.com/robot/send?<span style="color: #a0522d;">access_token</span>=xxx
    <span style="color: #b22222;"># </span><span style="color: #b22222;">secret for signature</span>
    secret: SEC268ff4d02ac
  wallet-webhook-warning:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">Wallet PRD INFO &#21578;&#35686;&#32676;</span>
    url: https://oapi.dingtalk.com/robot/send?<span style="color: #a0522d;">access_token</span>=xxx
    <span style="color: #b22222;"># </span><span style="color: #b22222;">secret for signature</span>
    secret: SECeb2b2    
</pre>
</div>

<p>
模板语法使用 go template。<a href="https://github.com/timonwong/prometheus-webhook-dingtalk/blob/main/docs/FAQ_zh.md">https://github.com/timonwong/prometheus-webhook-dingtalk/blob/main/docs/FAQ_zh.md</a>
</p>
</div>
<div id="outline-container-h:c5a0a9ac-76dc-4f21-9b6d-4412ca9b6711" class="outline-5">
<h5 id="h:c5a0a9ac-76dc-4f21-9b6d-4412ca9b6711">钉钉报警模板</h5>
<div class="outline-text-5" id="text-h:c5a0a9ac-76dc-4f21-9b6d-4412ca9b6711">
<div class="org-src-container">
<pre class="src src-shell"> cat /data/devops/prometheus-webhook-dingtalk/contrib/templates/legacy/template.tmpl
// {{ define <span style="color: #8b2252;">"ding.link.title"</span> }}{{ template <span style="color: #8b2252;">"legacy.title"</span> . }}{{ end }}
//  {{ define <span style="color: #8b2252;">"ding.link.content"</span> }}{{ template <span style="color: #8b2252;">"legacy.content"</span> . }}{{ end }}
{{ define <span style="color: #8b2252;">"__text_alert_list"</span> }}{{ range . }}
&#21578;&#35686;&#20027;&#39064;: {{ .Annotations.summary }}

&#21578;&#35686;&#35814;&#24773;: {{ .Annotations.description }}

&#21578;&#35686;&#23454;&#20363;: {{ .Labels.instance }}

Pod &#21517;&#31216;: {{ .Labels.pod }}

&#21578;&#35686;&#32423;&#21035;: {{ .Labels.severity }}

&#21578;&#35686;&#29366;&#24577;: {{ .Status }}

&#21578;&#35686;&#26102;&#38388;: {{ (.StartsAt.Add 28800e9).Format <span style="color: #8b2252;">"2006-01-02 15:04:05"</span> }}

------------------------
{{ end }}{{ end }}

{{ define <span style="color: #8b2252;">"__text_resolve_list"</span> }}{{ range .  }}
&#21578;&#35686;&#20027;&#39064;: {{ .Annotations.summary }}

&#21578;&#35686;&#35814;&#24773;: {{ .Annotations.description }}

&#21578;&#35686;&#23454;&#20363;: {{ .Labels.instance }}

Pod &#21517;&#31216;: {{ .Labels.pod }}

&#21578;&#35686;&#32423;&#21035;: {{ .Labels.severity }}

&#21578;&#35686;&#29366;&#24577;: {{ .Status }}

&#21578;&#35686;&#26102;&#38388;: {{ (.StartsAti.Add 28800e9).Format <span style="color: #8b2252;">"2006-01-02 15:04:05"</span> }}

&#24674;&#22797;&#26102;&#38388;: {{ (.EndsAti.Add 28800e9).Format <span style="color: #8b2252;">"2006-01-02 15:04:05"</span> }}

------------------------
{{ end }}{{ end }}
</pre>
</div>



<div class="org-src-container">
<pre class="src src-shell">{{ .GeneratorURL }} &#65306;  &#33719;&#21462; prometheus external-url&#65292;&#22686;&#21152; prometheus &#21551;&#21160;&#21442;&#25968;&#22914; --web.external-url=https://prometheus.xxx.com/eks
{{ define <span style="color: #8b2252;">"__alertmanagerURL"</span> }}: &#20989;&#25968;&#33719;&#21462; alertmanager external-url&#65292;&#22686;&#21152; alertmanager &#21551;&#21160;&#21442;&#25968;&#22914; --web.external-url=https://alertmanager.xxx.com
</pre>
</div>

<p>
启动脚本
</p>
<div class="org-src-container">
<pre class="src src-shell">cat /etc/systemd/system/prometheus-webhook-dingtalk.service
[Unit]
<span style="color: #a0522d;">Description</span>=prometheus-webhook-dingtalk
<span style="color: #a0522d;">After</span>=network-online.target

[Service]
<span style="color: #a0522d;">Restart</span>=on-failure
<span style="color: #a0522d;">ExecStart</span>=/data/devops/prometheus-webhook-dingtalk/prometheus-webhook-dingtalk --config.file=/data/devops/prometheus-webhook-dingtalk/config.yml

[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target

</pre>
</div>
</div>
</div>
<div id="outline-container-h:d5917aef-b520-4eec-bb3b-fdd28f1560b0" class="outline-5">
<h5 id="h:d5917aef-b520-4eec-bb3b-fdd28f1560b0">k8s 部署</h5>
<div class="outline-text-5" id="text-h:d5917aef-b520-4eec-bb3b-fdd28f1560b0">
<p>
configmap.yaml
</p>
<div class="org-src-container">
<pre class="src src-yaml">---
kind: ConfigMap
apiVersion: v1
metadata:
  name: prometheus-webhook-dingtalk-config
  namespace: monitoring
data:
  config.yml: |-
    templates:
      - /config/template.tmpl
    targets:
      default-webhook-warning:
        # 默认告警群
        url: https://oapi.dingtalk.com/robot/send?access_token=xx
        # secret for signature
        secret: SEC4bfd28a4ea2d14836a3db5b2e8101a81d7c72c842b8c05a5b82cb48c5de3c096
  template.tmpl: |-
    {{ define "__subject" }}[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join " " }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}({{ with .CommonLabels.Remove .GroupLabels.Names }}{{ .Values | join " " }}{{ end }}){{ end }}{{ end }}
    {{ define "__alertmanagerURL" }}{{ .ExternalURL }}/#/alerts?receiver={{ .Receiver }}{{ end }}

    {{ define "default.__text_alert_list" }}{{ range . }}
    #### \[{{ .Labels.severity | upper }}\] {{ .Annotations.summary }}

    **Description:** {{ .Annotations.description }}

    **Graph:** [📈]({{ .GeneratorURL }})

    **Details:**
    {{ range .Labels.SortedPairs }}{{ if and (ne (.Name) "severity") (ne (.Name) "summary") }}&gt; - {{ .Name }}: {{ .Value | markdown | html }}
    {{ end }}{{ end }}
    {{ end }}{{ end }}

    {{/* Default */}}
    {{ define "default.title" }}{{ template "__subject" . }}{{ end }}
    {{ define "default.content" }}#### \[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}\] **[{{ index .GroupLabels "alertname" }}]({{ template "__alertmanagerURL" . }})**
    {{ if gt (len .Alerts.Firing) 0 -}}
    **Alerts Firing**
    {{ template "default.__text_alert_list" .Alerts.Firing }}
    {{- end }}
    {{ if gt (len .Alerts.Resolved) 0 -}}
    **Alerts Resolved**
    {{ template "default.__text_alert_list" .Alerts.Resolved }}
    {{- end }}
    {{- end }}

    {{/* Customizable templates by jasper */}}
    {{ define "__prometheusURL" }}https://prometheus-prod.xxx.com/eks/alerts{{ end }}
    {{ define "__text_alert_list" }}{{ range . }}
    Summary: {{ .Annotations.summary }}

    Description: {{ .Annotations.description }}

    Graph: [📈]({{ .GeneratorURL }})

    Details:
    {{ range .Labels.SortedPairs }}{{ if and (ne (.Name) "severity") (ne (.Name) "summary") }}&gt; - {{ .Name }}: {{ .Value | markdown | html }}
    {{ end }}{{ end }}

    Severity: {{ .Labels.severity }}

    Status: {{ .Status }}

    StartAt: {{ (.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}

    Solution: {{ .Annotations.runbook_url }}

    ------------------------
    {{ end }}{{ end }}

    {{ define "__text_alertresovle_list" }}{{ range .  }}
    Summary: {{ .Annotations.summary }}

    Description: {{ .Annotations.description }}

    Graph: [📈]({{ .GeneratorURL }})

    StartsAt: {{ (.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}

    EndsAt: {{ (.EndsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}

    Solution: {{ .Annotations.runbook_url }}

    ------------------------
    {{ end }}{{ end }}

    {{/* Legacy */}}
    {{ define "legacy.title" }}{{ template "__subject" . }}{{ end }}
    {{ define "legacy.content" }}#### \[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}\] **[{{ index .CommonLabels "alertname" }}]({{ template "__alertmanagerURL" . }})**
    {{ if gt (len .Alerts.Firing) 0 -}}
    {{ template "__text_alert_list" .Alerts.Firing }}
    {{- end }}
    {{ if gt (len .Alerts.Resolved) 0 -}}
    {{ template "__text_alertresovle_list" .Alerts.Resolved }}
    {{- end }}
    {{- end }}

    {{/* Following names for compatibility */}}
    {{ define "ding.link.title" }}{{ template "legacy.title" . }}{{ end }}
    {{ define "ding.link.content" }}{{ template "legacy.content" . }}{{ end }}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dingtalk-nginx-ldap
  namespace: monitoring
data:
  app.conf: |-
    upstream dingtalk {
        server prometheus-webhook-dingtalk:8060 weight=1;
    }
    server {
        listen       80;
        server_name  localhost;

        location ~ \.(gif|jpg|png|css|js|svg|woff2|html|json|query)$ {
            proxy_pass http://dingtalk;
        }

        location / {
            proxy_pass http://dingtalk/;
            auth_ldap    "Forbidden";
            auth_ldap_servers   localdir;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }
  nginx.conf: |-
    user  nginx;
    worker_processes  auto;

    error_log  /var/log/nginx/error.log warn;
    pid        /var/run/nginx.pid;

    events {
        worker_connections  1024;
    }

    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;

        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';

        access_log  /var/log/nginx/access.log  main;

        sendfile        on;

        keepalive_timeout  65;

        proxy_ignore_client_abort on;


        ldap_server localdir {
          url ldap://ops-freeipa.xxx.com:389/cn=users,cn=accounts,dc=xxx,dc=com?uid?sub?(&amp;(objectClass=*));
          binddn "uid=admin,cn=users,cn=accounts,dc=xxx,dc=com";
          binddn_passwd "rdIfXD6ZoZ7aBNvY";
          #group_attribute memberuid;
          #group_attribute_is_dn on;
          #require valid_user;
          #max_down_retries 3;
        }

        include /etc/nginx/conf.d/*.conf;
    }
    #include /etc/nginx/tcp.conf;
</pre>
</div>

<p>
service.yaml
</p>
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: v1
kind: Service
metadata:
  name: prometheus-webhook-dingtalk
  namespace: monitoring
  labels:
    app: prometheus-webhook-dingtalk
spec:
  ports:
  - name: http
    protocol: TCP
    port: 8060
    targetPort: 8060
  - name: http-80
    protocol: TCP
    port: 80
    targetPort: 80
  selector:
    app: prometheus-webhook-dingtalk
</pre>
</div>

<p>
deployment.yaml
</p>
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: prometheus-webhook-dingtalk
  name: prometheus-webhook-dingtalk
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus-webhook-dingtalk
  template:
    metadata:
      labels:
        app: prometheus-webhook-dingtalk
    spec:
      nodeSelector:
        type: ops-prod-prometheus
      containers:
      - args:
        - --web.listen-address=:8060
        - --config.file=/config/config.yml
        - --web.enable-ui
        - --web.enable-lifecycle
        image: timonwong/prometheus-webhook-dingtalk:v2.1.0
        imagePullPolicy: IfNotPresent
        name: prometheus-webhook-dingtalk
        ports:
        - containerPort: 8060
          name: http
          protocol: TCP
        resources:
          limits:
            cpu: 1
            memory: 512Mi
          requests:
            cpu: 10m
            memory: 50Mi
        volumeMounts:
        - mountPath: /config
          name: conf
      - args:
        - --webhook-url=http://localhost:8060/-/reload
        - --volume-dir=/config/
        image: jimmidyson/configmap-reload:v0.5.0
        name: module-configmap-reloader
        resources:
          limits:
            cpu: 20m
            memory: 40Mi
          requests:
            cpu: 10m
            memory: 20Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 65534
        volumeMounts:
        - mountPath: /config/
          name: conf
          readOnly: true
      - image: ops-harbor.xxx.com/ops/nginx-ldap
        imagePullPolicy: Always
        name: nginx-ldap
        resources:
          limits:
            cpu: 200m
            memory: 200Mi
          requests:
            cpu: 10m
            memory: 10Mi
        stdin: true
        tty: true
        volumeMounts:
        - mountPath: /etc/nginx/nginx.conf
          name: nginx-conf
          subPath: nginx.conf
        - mountPath: /etc/nginx/conf.d/
          name: nginx-app-conf
      imagePullSecrets:
      - name: docker-secret
      volumes:
      - configMap:
          defaultMode: 420
          name: prometheus-webhook-dingtalk-config
        name: conf
      - configMap:
          defaultMode: 420
          items:
          - key: nginx.conf
            path: nginx.conf
          name: dingtalk-nginx-ldap
        name: nginx-conf
      - configMap:
          defaultMode: 420
          items:
          - key: app.conf
            path: app.conf
          name: dingtalk-nginx-ldap
        name: nginx-app-conf
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ca8d2783-1186-437b-b31e-d14f79500d18" class="outline-4">
<h4 id="h:ca8d2783-1186-437b-b31e-d14f79500d18">非云原生应用监控 Exporter</h4>
<div class="outline-text-4" id="text-h:ca8d2783-1186-437b-b31e-d14f79500d18">
<p>
官方文档：<a href="https://prometheus.io/docs/instrumenting/exporters/">https://prometheus.io/docs/instrumenting/exporters/</a>
</p>
</div>
<div id="outline-container-h:a242b9a0-99de-4973-83d9-e2747cacb0ec" class="outline-5">
<h5 id="h:a242b9a0-99de-4973-83d9-e2747cacb0ec">Kafka exporter</h5>
<div class="outline-text-5" id="text-h:a242b9a0-99de-4973-83d9-e2747cacb0ec">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">------------</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: kafka-exporter
  name: kafka-exporter
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kafka-exporter
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    <span style="color: #483d8b;">type</span>: RollingUpdate
  template:
    metadata:
      labels:
        app: kafka-exporter
    spec:
      containers:
      - args:
        - --kafka.server=kafka-0.kafka-headless.public-service:9092
        env:
        - name: TZ
          value: Asia/Shanghai
        - name: LANG
          value: C.UTF-8
        image: danielqsj/kafka-exporter:latest
        imagePullPolicy: IfNotPresent
        name: kafka-exporter
        ports:
        - containerPort: 9308
          name: web
          protocol: TCP
        resources:
          limits:
            cpu: 249m
            memory: 318Mi
          requests:
            cpu: 10m
            memory: 10Mi
        securityContext:
          allowPrivilegeEscalation: false
          privileged: false
          readOnlyRootFilesystem: false
          runAsNonRoot: false
        volumeMounts:
        - mountPath: /usr/share/zoneinfo/Asia/Shanghai
          name: tz-config
        - mountPath: /etc/localtime
          name: tz-config
        - mountPath: /etc/timezone
          name: timezone
      volumes:
      - hostPath:
          path: /usr/share/zoneinfo/Asia/Shanghai
          <span style="color: #483d8b;">type</span>: <span style="color: #8b2252;">""</span>
        name: tz-config
      - hostPath:
          path: /etc/timezone
          <span style="color: #483d8b;">type</span>: <span style="color: #8b2252;">""</span>
        name: timezone


---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: kafka-exporter
  name: kafka-exporter
  namespace: monitoring
spec:
  ports:
  - name: container-1-web-1
    port: 9308
    protocol: TCP
    targetPort: 9308
  selector:
    app: kafka-exporter
  <span style="color: #483d8b;">type</span>: ClusterIP


---

apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    k8s-app: kafka-exporter
  name: kafka-exporter
  namespace: monitoring
spec:
  endpoints:
  - interval: 30s
    port: container-1-web-1
  namespaceSelector:
    matchNames:
    - monitoring
  selector:
    matchLabels:
      app: kafka-exporter
</pre>
</div>

<p>
动态发现
</p>
<div class="org-src-container">
<pre class="src src-shell">cat cas-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kafka-exporter-cas
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kafka-exporter-cas
  template:
    metadata:
      annotations:
        prometheus.io/path: /metrics
        prometheus.io/port: <span style="color: #8b2252;">"9308"</span>
        prometheus.io/scrape: <span style="color: #8b2252;">"true"</span>
      labels:
        app: kafka-exporter-cas
        instance: CAS
    spec:
      containers:
      - command:
        - /bin/sh
        - -c
        - kafka_exporter --kafka.server=172.21.38.219:9092 --kafka.server=172.21.38.233:9092
        image: danielqsj/kafka-exporter:latest
        imagePullPolicy: IfNotPresent
        name: kafka-exporter-cas
        env:
        - name: TZ
          value: Asia/Shanghai
        - name: LANG
          value: C.UTF-8
        ports:
        - containerPort: 9308
          protocol: TCP
        readinessProbe:
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          tcpSocket:
            port: 9308
          timeoutSeconds: 5
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 200m
            memory: 10Mi
      imagePullSecrets:
      - name: docker-pull
      nodeSelector:
        eks.amazonaws.com/nodegroup: EKS-DEVOPS-Prometheus
      restartPolicy: Always
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f44b11f1-dbf2-41f2-8c2d-252ece19a380" class="outline-5">
<h5 id="h:f44b11f1-dbf2-41f2-8c2d-252ece19a380">node-exporter</h5>
<div class="outline-text-5" id="text-h:f44b11f1-dbf2-41f2-8c2d-252ece19a380">
<div class="org-src-container">
<pre class="src src-shell">$ ll
node-exporter-clusterRoleBinding.yaml
node-exporter-clusterRole.yaml
node-exporter-daemonset.yaml
node-exporter-serviceAccount.yaml
</pre>
</div>
</div>
<ul class="org-ul">
<li><a id="h:7c56f1ed-565e-4f25-bcf8-402deaca3cf6"></a>node-exporter-serviceAccount.yaml<br>
<div class="outline-text-6" id="text-h:7c56f1ed-565e-4f25-bcf8-402deaca3cf6">
<div class="org-src-container">
<pre class="src src-shell">cat node-exporter-serviceAccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: node-exporter
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 1.3.1
  name: node-exporter
  namespace: monitoring
</pre>
</div>
</div>
</li>
<li><a id="h:d27f8e4c-89f6-482d-9396-85422aefe8e7"></a>node-exporter-clusterRoleBinding.yaml<br>
<div class="outline-text-6" id="text-h:d27f8e4c-89f6-482d-9396-85422aefe8e7">
<div class="org-src-container">
<pre class="src src-shell">cat node-exporter-clusterRoleBinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: node-exporter
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 1.3.1
  name: node-exporter
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: node-exporter
subjects:
- kind: ServiceAccount
  name: node-exporter
  namespace: monitoring
</pre>
</div>
</div>
</li>
<li><a id="h:3846203e-fd76-4142-9fc5-1a40bd2e7cab"></a>node-exporter-clusterRoleBinding.yaml<br>
<div class="outline-text-6" id="text-h:3846203e-fd76-4142-9fc5-1a40bd2e7cab">
<div class="org-src-container">
<pre class="src src-shell">cat node-exporter-clusterRoleBinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: node-exporter
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 1.3.1
  name: node-exporter
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: node-exporter
subjects:
- kind: ServiceAccount
  name: node-exporter
  namespace: monitoring
[jasper.xu@ip-10-204-43-253 node-exporter]$ cat node-exporter-clusterRole.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: node-exporter
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 1.3.1
  name: node-exporter
rules:
- apiGroups:
  - authentication.k8s.io
  resources:
  - tokenreviews
  verbs:
  - create
- apiGroups:
  - authorization.k8s.io
  resources:
  - subjectaccessreviews
  verbs:
  - create
</pre>
</div>
</div>
</li>
<li><a id="h:bd27efd8-c688-4271-9c06-9120946d58ab"></a>node-exporter-daemonset.yaml<br>
<div class="outline-text-6" id="text-h:bd27efd8-c688-4271-9c06-9120946d58ab">
<div class="org-src-container">
<pre class="src src-shell">cat node-exporter-daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: node-exporter
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 1.3.1
  name: node-exporter
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: exporter
      app.kubernetes.io/name: node-exporter
      app.kubernetes.io/part-of: kube-prometheus
  template:
    metadata:
      labels:
        app.kubernetes.io/component: exporter
        app.kubernetes.io/name: node-exporter
        app.kubernetes.io/part-of: kube-prometheus
        app.kubernetes.io/version: 1.3.1
    spec:
      automountServiceAccountToken: true
      containers:
      <span style="color: #b22222;">#</span><span style="color: #b22222;">- --web.listen-address=127.0.0.1:9100</span>
      - args:
        - --path.sysfs=/host/sys
        - --path.rootfs=/host/root
        - --no-collector.wifi
        - --no-collector.hwmon
        - --collector.filesystem.mount-points-exclude=^/(dev|proc|sys|run/k3s/containerd/.+|var/lib/docker/.+|var/lib/kubelet/pods/.+)($|/)
        - --collector.netclass.ignored-devices=^(veth.*|[a-f0-9]{15})$
        - --collector.netdev.device-exclude=^(veth.*|[a-f0-9]{15})$
        image: quay.io/prometheus/node-exporter:v1.3.1
        name: node-exporter
        resources:
          limits:
            cpu: 250m
            memory: 180Mi
          requests:
            cpu: 102m
            memory: 180Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            add:
            - SYS_TIME
            drop:
            - ALL
          readOnlyRootFilesystem: true
        ports:
        - containerPort: 9100
          hostPort: 9100
          name: http
        volumeMounts:
        - mountPath: /host/sys
          mountPropagation: HostToContainer
          name: sys
          readOnly: true
        - mountPath: /host/root
          mountPropagation: HostToContainer
          name: root
          readOnly: true
      - args:
        - --logtostderr
        - --secure-listen-address=[$(<span style="color: #ff00ff;">IP</span>)]:9101
        - --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305
        - --upstream=http://127.0.0.1:9100/
        env:
        - name: IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        image: quay.io/brancz/kube-rbac-proxy:v0.12.0
        name: kube-rbac-proxy
        ports:
        - containerPort: 9101
          hostPort: 9101
          name: https
        resources:
          limits:
            cpu: 20m
            memory: 40Mi
          requests:
            cpu: 10m
            memory: 20Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsGroup: 65532
          runAsNonRoot: true
          runAsUser: 65532
      hostNetwork: true
      hostPID: true
      nodeSelector:
        kubernetes.io/os: linux
      priorityClassName: system-cluster-critical
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
      serviceAccountName: node-exporter
      tolerations:
      - operator: Exists
      volumes:
      - hostPath:
          path: /sys
        name: sys
      - hostPath:
          path: /
        name: root
  updateStrategy:
    rollingUpdate:
      maxUnavailable: 10%
    <span style="color: #483d8b;">type</span>: RollingUpdate
</pre>
</div>
</div>
</li>
<li><a id="h:31d83fec-56e9-404d-be02-7a29bbf99216"></a>静态注册配置<br>
<div class="outline-text-6" id="text-h:31d83fec-56e9-404d-be02-7a29bbf99216">
<div class="org-src-container">
<pre class="src src-yaml">- job_name: node-exporter
  honor_timestamps: true
  scrape_interval: 15s
  scrape_timeout: 10s
  metrics_path: /metrics
  scheme: https
  authorization:
    type: Bearer
    credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token
  tls_config:
    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    insecure_skip_verify: true
  follow_redirects: true
  kubernetes_sd_configs:
  - role: node
    kubeconfig_file: ""
    follow_redirects: true
  relabel_configs:
  - source_labels: [__address__]
    separator: ;
    regex: (.*):10250
    target_label: __address__
    replacement: $1:9101
    action: replace
  - source_labels: [__meta_kubernetes_node_label_eks_amazonaws_com_nodegroup]
    separator: ;
    regex: (.*)
    target_label: business
    replacement: $1
    action: replace
  - source_labels: [__meta_kubernetes_node_label_eks_amazonaws_com_nodegroup]
    separator: ;
    regex: (.*)
    target_label: nodegroup
    replacement: $1
    action: replace
  - source_labels: [__meta_kubernetes_node_label_beta_kubernetes_io_instance_type]
    separator: ;
    regex: (.*)
    target_label: instance_type
    replacement: $1
    action: replace
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:225c17b3-0ed3-499b-be9b-8495517fe76b" class="outline-5">
<h5 id="h:225c17b3-0ed3-499b-be9b-8495517fe76b">redis-exporter</h5>
<div class="outline-text-5" id="text-h:225c17b3-0ed3-499b-be9b-8495517fe76b">
<div class="org-src-container">
<pre class="src src-shell">cat redis-exporter.yaml
apiVersion: v1
kind: Service
metadata:
  name: redis-exporter
  namespace: monitoring
  <span style="color: #b22222;">#</span><span style="color: #b22222;">annotations:</span>
  <span style="color: #b22222;">#  </span><span style="color: #b22222;">prometheus.io/scrape: "true"</span>
  labels:
    app: svc-redis-exporter
spec:
  <span style="color: #483d8b;">type</span>: NodePort
  selector:
    app: redis-exporter
  ports:
    - name: tcp-9121
      protocol: TCP
      port: 9121
      targetPort: 9121
---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: monitoring
  name: redis-exporter
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis-exporter
  template:
    metadata:
      <span style="color: #b22222;">#</span><span style="color: #b22222;">annotations:</span>
      <span style="color: #b22222;">#  </span><span style="color: #b22222;">prometheus.io/scrape: "true"</span>
      <span style="color: #b22222;">#  </span><span style="color: #b22222;">prometheus.io/port: "9121"</span>
      labels:
        app: redis-exporter
    spec:
      nodeSelector:
        eks.amazonaws.com/nodegroup: EKS-DEVOPS-Prometheus
      containers:
      - name: redis-exporter
        image: oliver006/redis_exporter:latest
        resources:
          limits:
            cpu: 300m
            memory: 300Mi
          requests:
            cpu: 10m
            memory: 10Mi
        ports:
        - containerPort: 9121
</pre>
</div>

<p>
静态配置
</p>

<div class="org-src-container">
<pre class="src src-shell">- job_name: <span style="color: #8b2252;">'redis_exporter_targets'</span>
  static_configs:
  - targets:
    - agt-.amazonaws.com:6379
    - redis://agt-necache.amazonaws.com:6379
    - redis://172.21.89.135:6391
    - redis://172.21.89.135:6392
    labels:
      dbtype: db-mysql-db
  metrics_path: /scrape
  relabel_configs:
  - source_labels: [__address__]
    target_label: __param_target
  - source_labels: [__param_target]
    target_label: instance
  - target_label: __address__
    replacement: redis-exporter:9121
</pre>
</div>
</div>
</div>
<div id="outline-container-h:973f36df-5980-4ac8-8f63-7c32474a8afc" class="outline-5">
<h5 id="h:973f36df-5980-4ac8-8f63-7c32474a8afc">rocketmq-exporter</h5>
<div class="outline-text-5" id="text-h:973f36df-5980-4ac8-8f63-7c32474a8afc">
<div class="org-src-container">
<pre class="src src-shell">cat gpl-rocketmq-exporter-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gpl-rocketmq-exporter
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gpl-rocketmq-exporter
  template:
    metadata:
      annotations:
        prometheus.io/path: <span style="color: #8b2252;">"/metrics"</span>
        prometheus.io/port: <span style="color: #8b2252;">"5557"</span>
        prometheus.io/scrape: <span style="color: #8b2252;">"true"</span>
      labels:
        app: gpl-rocketmq-exporter
    spec:
      nodeSelector:
        <span style="color: #483d8b;">type</span>: ops-prod-prometheus
      imagePullSecrets:
      - name: docker-secret
      containers:
      - name: rocketmq-exporter
        image: harbor.xxx.com/devops/rocketmq-exporter:v0.0.2
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5557
        <span style="color: #483d8b;">command</span>:
        - /bin/sh
        - -c
        - <span style="color: #8b2252;">'java -jar -Xms2g -Xmx2g -Xmn1024m -Xss256k /opt/rocketmq-exporter/rocketmq-exporter-0.0.2-SNAPSHOT.jar</span>
<span style="color: #8b2252;">            --server.port=5557</span>
<span style="color: #8b2252;">            --rocketmq.config.namesrvAddr=172.21.89.192:9876'</span>
        readinessProbe:
          tcpSocket:
            port: 5557
          initialDelaySeconds: 5
          timeoutSeconds: 5
        resources:
          limits:
            cpu: 1
            memory: 1Gi
          requests:
            cpu: 10m
            memory: 10Mi
</pre>
</div>

<p>
rocketmq 加密
</p>
<div class="org-src-container">
<pre class="src src-shell">cat wallet-rocketmq-exporter-deployment.yaml
apiVersion: apps/v1
kind: Deployment
        <span style="color: #483d8b;">command</span>:
        - /bin/sh
        - -c
        - <span style="color: #8b2252;">'java -jar -Xms2g -Xmx2g -Xmn1024m -Xss256k /opt/rocketmq-exporter/rocketmq-exporter-0.0.2-SNAPSHOT.jar</span>
<span style="color: #8b2252;">            --server.port=5557</span>
<span style="color: #8b2252;">            --rocketmq.config.namesrvAddr=172.21.89.85:9876</span>
<span style="color: #8b2252;">            --rocketmq.config.enableACL=true</span>
<span style="color: #8b2252;">            --rocketmq.config.accessKey=RocketMQ</span>
<span style="color: #8b2252;">            --rocketmq.config.secretKey=12345678'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c3cb474a-e85d-4620-a5a9-0eb259b285b0" class="outline-5">
<h5 id="h:c3cb474a-e85d-4620-a5a9-0eb259b285b0">awk-cloudwatch-exporter</h5>
<div class="outline-text-5" id="text-h:c3cb474a-e85d-4620-a5a9-0eb259b285b0">
<div class="org-src-container">
<pre class="src src-shell">cat cloudwatch-exporter.yaml
---
<span style="color: #b22222;"># </span><span style="color: #b22222;">Source: prometheus-cloudwatch-exporter/templates/serviceaccount.yaml</span>
apiVersion: v1
kind: ServiceAccount
automountServiceAccountToken: true
metadata:
  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
  namespace: monitoring
  labels:
    app: prometheus-cloudwatch-exporter
    chart: prometheus-cloudwatch-exporter-0.19.2
    release: <span style="color: #8b2252;">"cloudwatch-exporter"</span>
    heritage: <span style="color: #8b2252;">"Helm"</span>
---
<span style="color: #b22222;"># </span><span style="color: #b22222;">Source: prometheus-cloudwatch-exporter/templates/secrets.yaml</span>
apiVersion: v1
kind: Secret
metadata:
  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
  namespace: monitoring
  labels:
    app: prometheus-cloudwatch-exporter
    chart: prometheus-cloudwatch-exporter-0.19.2
    heritage: Helm
    release: cloudwatch-exporter
<span style="color: #483d8b;">type</span>: Opaque
data:

  aws_access_key_id: <span style="color: #8b2252;">"QsUtJQs="</span>


  aws_secret_access_key: <span style="color: #8b2252;">"dlJS9Beg=="</span>
---
<span style="color: #b22222;"># </span><span style="color: #b22222;">Source: prometheus-cloudwatch-exporter/templates/configmap.yaml</span>
apiVersion: v1
kind: ConfigMap
metadata:
  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
  namespace: monitoring
  labels:
    app: prometheus-cloudwatch-exporter
    chart: prometheus-cloudwatch-exporter-0.19.2
    release: cloudwatch-exporter
    heritage: Helm
data:
  config.yml: |-

    <span style="color: #b22222;"># </span><span style="color: #b22222;">This is the default configuration for prometheus-cloudwatch-exporter</span>
    region: ap-south-1
    period_seconds: 30
    delay_seconds: 60
    metrics:
    <span style="color: #b22222;">#</span><span style="color: #b22222;">- aws_namespace: AWS/ELB</span>
    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_metric_name: HealthyHostCount</span>
    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_dimensions: [AvailabilityZone, LoadBalancerName]</span>
    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_statistics: [Average]</span>
    <span style="color: #b22222;">#</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">- aws_namespace: AWS/ELB</span>
    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_metric_name: UnHealthyHostCount</span>
    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_dimensions: [AvailabilityZone, LoadBalancerName]</span>
    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_statistics: [Average]</span>
    <span style="color: #b22222;">#</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">- aws_namespace: AWS/ELB</span>
    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_metric_name: RequestCount</span>
    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_dimensions: [AvailabilityZone, LoadBalancerName]</span>
    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_statistics: [Sum]</span>
    <span style="color: #b22222;">#</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">- aws_namespace: AWS/ELB</span>
    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_metric_name: Latency</span>
    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_dimensions: [AvailabilityZone, LoadBalancerName]</span>
    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_statistics: [Average]</span>
    <span style="color: #b22222;">#</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">- aws_namespace: AWS/ELB</span>
    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_metric_name: SurgeQueueLength</span>
    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_dimensions: [AvailabilityZone, LoadBalancerName]</span>
    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_statistics: [Maximum, Sum]</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;</span>
    - aws_namespace: AWS/ElastiCache
      aws_metric_name: CPUUtilization
      aws_dimensions: [CacheClusterId]
      aws_tag_select:
        tag_selections:
          Owner: [<span style="color: #8b2252;">"Klaus.ma"</span>]
        resource_type_selection: elasticache
        resource_id_dimension: Tags
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: EngineCPUUtilization
      aws_dimensions: [CacheClusterId]
      aws_dimension_select_regex:
         <span style="color: #b22222;">#</span><span style="color: #b22222;">LoadBalancerName: ["app/AGT-APP-Prod-Game-ALB02/b6eb4661b489a15c", "app/AGT-APP-Prod-Game-ALB/9f62266ea9b31940"]</span>
        cache_cluster_id: [<span style="color: #8b2252;">"cc.*"</span>]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: BytesUsedForCache
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: CurrConnections
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: NewConnections
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: DatabaseMemoryUsagePercentage
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: NetworkBytesIn
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: NetworkBytesOut
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: FreeableMemory
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: CacheHits
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: CacheMisses
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: ReplicationLag
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: MemoryFragmentationRatio
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: IsMaster
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: CacheHitRate
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]
    <span style="color: #b22222;">##</span><span style="color: #b22222;">&#26032;&#22686;</span>
    - aws_namespace: AWS/ElastiCache
      aws_metric_name: StringBasedCmdsLatency
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: SortedSetBasedCmdsLatency
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: HashBasedCmdsLatency
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: SetBasedCmdsLatency
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: GetTypeCmdsLatency
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: KeyBasedCmdsLatency
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: ListBasedCmdsLatency
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: SetTypeCmdsLatency
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: StringBasedCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: SetBasedCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: SetTypeCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: GetTypeCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: ListBasedCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: SortedSetBasedCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: EvalBasedCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: HashBasedCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: KeyBasedCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]


    - aws_namespace: AWS/ElastiCache
      aws_metric_name: CurrItems
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]


    - aws_namespace: AWS/ApplicationELB
      aws_metric_name: RequestCount
      aws_dimensions: [AvailabilityZone, LoadBalancer, TargetGroup]
      <span style="color: #b22222;">#</span><span style="color: #b22222;">aws_dimension_select:</span>
      aws_dimension_select_regex:
         <span style="color: #b22222;">#</span><span style="color: #b22222;">LoadBalancerName: ["app/AGT-APP-Prod-Game-ALB02/b6eb4661b489a15c", "app/AGT-APP-Prod-Game-ALB/9f62266ea9b31940"]</span>
         LoadBalancerName: [<span style="color: #8b2252;">"agt*|pg*"</span>]
      aws_statistics: [Sum]
---
<span style="color: #b22222;"># </span><span style="color: #b22222;">Source: prometheus-cloudwatch-exporter/templates/clusterrole.yaml</span>
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
  labels:
    app: prometheus-cloudwatch-exporter
    chart: prometheus-cloudwatch-exporter-0.19.2
    release: cloudwatch-exporter
    heritage: Helm
rules:
  - apiGroups: [<span style="color: #8b2252;">""</span>]
    resources: [<span style="color: #8b2252;">"secrets"</span>,<span style="color: #8b2252;">"configmap"</span>]
    resourceNames: [<span style="color: #8b2252;">"cloudwatch-exporter-prometheus-cloudwatch-exporter"</span>]
    verbs: [<span style="color: #8b2252;">"get"</span>]
---
<span style="color: #b22222;"># </span><span style="color: #b22222;">Source: prometheus-cloudwatch-exporter/templates/clusterrolebinding.yaml</span>
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
  labels:
    app: prometheus-cloudwatch-exporter
    chart: prometheus-cloudwatch-exporter-0.19.2
    release: cloudwatch-exporter
    heritage: Helm
subjects:
  - kind: ServiceAccount
    name: cloudwatch-exporter-prometheus-cloudwatch-exporter
    namespace: monitoring
roleRef:
  kind: ClusterRole
  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
  apiGroup: rbac.authorization.k8s.io
---
<span style="color: #b22222;"># </span><span style="color: #b22222;">Source: prometheus-cloudwatch-exporter/templates/service.yaml</span>
apiVersion: v1
kind: Service
metadata:
  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
  namespace: monitoring
  annotations:
    {}
  labels:
    app: prometheus-cloudwatch-exporter
    chart: prometheus-cloudwatch-exporter-0.19.2
    release: cloudwatch-exporter
    heritage: Helm
spec:
  <span style="color: #483d8b;">type</span>: ClusterIP
  ports:
    - port: 9106
      targetPort: container-port
      protocol: TCP
      name: http
  selector:
    app: prometheus-cloudwatch-exporter
    release: cloudwatch-exporter
---
<span style="color: #b22222;"># </span><span style="color: #b22222;">Source: prometheus-cloudwatch-exporter/templates/deployment.yaml</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
  namespace: monitoring
  labels:
    app: prometheus-cloudwatch-exporter
    chart: prometheus-cloudwatch-exporter-0.19.2
    release: cloudwatch-exporter
    heritage: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus-cloudwatch-exporter
      release: cloudwatch-exporter
  template:
    metadata:
      labels:
        app: prometheus-cloudwatch-exporter
        release: cloudwatch-exporter
      annotations:

        checksum/config: 98ede3b768cd837965b
        checksum/secrets: 0b63247b8101683bb6
    spec:
      containers:
        - name: prometheus-cloudwatch-exporter
          env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  key: aws_access_key_id
                  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  key: aws_secret_access_key
                  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
          image: <span style="color: #8b2252;">"prom/cloudwatch-exporter:v0.14.3"</span>
          imagePullPolicy: IfNotPresent
          ports:
            - name: container-port
              containerPort: 9106
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /-/healthy
              port: container-port
            initialDelaySeconds: 30
            periodSeconds: 5
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /-/ready
              port: container-port
            initialDelaySeconds: 30
            periodSeconds: 5
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3
          resources:
            {}
          volumeMounts:
            - name: vol-prometheus-cloudwatch-exporter
              mountPath: /config
      nodeSelector:
        eks.amazonaws.com/nodegroup: EKS-DEVOPS-Prometheus
      securityContext:
        fsGroup: 65534
        runAsUser: 65534
      serviceAccount: cloudwatch-exporter-prometheus-cloudwatch-exporter
      serviceAccountName: cloudwatch-exporter-prometheus-cloudwatch-exporter
      volumes:
      - configMap:
          defaultMode: 420
          name: cloudwatch-exporter-prometheus-cloudwatch-exporter
        name: vol-prometheus-cloudwatch-exporter
</pre>
</div>

<p>
静态配置
</p>
<div class="org-src-container">
<pre class="src src-yaml">- job_name: 'aws_cloudwatch'
 metrics_path: /metrics
 scrape_interval: 50s
 scrape_timeout: 45s
 static_configs:
 - targets:
   - "cloudwatch-exporter-prometheus-cloudwatch-exporter:9106"
</pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:d59ef2b6-2157-40e1-bfda-656fb7eb2429" class="outline-2">
<h2 id="h:d59ef2b6-2157-40e1-bfda-656fb7eb2429">其他</h2>
<div class="outline-text-2" id="text-h:d59ef2b6-2157-40e1-bfda-656fb7eb2429">
<ul class="org-ul">
<li><a href="05-k8s-运维篇-02-Prometheus常用监控规则.html">prometheus常用监控规则</a></li>
</ul>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
