<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kubernetes: k8s è¿ç»´ç¯‡-Prometheusç›‘æ§</title>
<meta name="description" content="kubernetes, linux" />
<meta name="keywords" content="kubernetes, linux" />
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Kubernetes: k8s è¿ç»´ç¯‡-Prometheusç›‘æ§</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:c52a7a86-84cd-4ebf-9e9d-add2bd8d188b">Prometheus ç›‘æ§å…¥é—¨</a>
<ul>
<li><a href="#h:d4a79c7c-c1f4-4fa5-a871-a100c5339317">ä»€ä¹ˆæ˜¯ Prometheus</a>
<ul>
<li><a href="#h:cfdcbaa9-b656-4a60-8f0d-8024cf881bbb">Prometheus ç‰¹æ€§</a></li>
</ul>
</li>
<li><a href="#h:5788f988-ff14-47f8-8300-d3475a3a22dc">Prometheus æ¶æ„å‰–æ</a></li>
<li><a href="#h:f0db2779-57a4-445d-9390-737436c9874c">Prometheus å®‰è£…</a>
<ul>
<li><a href="#h:667bf30b-ad0a-4085-92e2-3eff5a3f2528">Prometheus å®‰è£…æ–¹å¼é€‰æ‹©</a></li>
<li><a href="#h:b6d70874-f374-4eb9-ab6a-e41e75e63fac">Prometheus é«˜å¯ç”¨å®‰è£…</a></li>
</ul>
</li>
<li><a href="#h:20c8cba3-456b-440b-942e-e60593915f47">äº‘åŸç”Ÿå’Œéäº‘åŸç”Ÿåº”ç”¨çš„ç›‘æ§æµç¨‹</a>
<ul>
<li><a href="#h:947f06ff-52ce-4209-a574-e0a05c87ca36">Promethues çš„æ•°æ®æ¥æº</a></li>
<li><a href="#h:41f35e02-869f-49a8-b5d7-b279d72f02f3">Prometheus æ€ä¹ˆçŸ¥é“æ•°æ®çš„æ¥æº</a>
<ul>
<li><a href="#h:3d785849-0b6a-45ee-86aa-1edf29c0d758">ä»€ä¹ˆæ˜¯ ServiceMonitor</a></li>
<li><a href="#h:b20f1899-321d-4d5b-9940-b5c6157e00c6">ServiceMonitor é…ç½®è§£æ</a></li>
<li><a href="#h:6ae5214d-24aa-4607-92ea-2b6b04511a76">æ­£å¸¸çš„é…ç½®è§£æ</a></li>
<li><a href="#h:13c15752-926a-4b67-b1a6-76b74db9d93f">ServiceMonitor ç›‘æ§å¤±è´¥æ’æŸ¥æ­¥éª¤</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:bd160072-b7fd-4ab2-a5b8-a8a4caf21ec3">éäº‘åŸç”Ÿåº”ç”¨ç›‘æ§ Exporter</a>
<ul>
<li><a href="#h:f67acfcc-b6f0-4346-8dfe-df95b53ad713">mysql exporter</a></li>
</ul>
</li>
<li><a href="#h:fc8ffc1c-6be6-42c8-a913-7d90faa39159">äº‘åŸç”Ÿåº”ç”¨ç›‘æ§</a>
<ul>
<li><a href="#h:1845e9ab-2afc-427f-ada3-0bab058a0f67">etcd é›†ç¾¤ç›‘æ§</a>
<ul>
<li><a href="#h:c0c08f71-192f-4fa7-8525-4f811bfa25c3">æŸ¥çœ‹æ¥å£ä¿¡æ¯</a></li>
<li><a href="#h:5f9b62ab-2d47-429b-a7b0-b6c27d528a85">åˆ›å»º etcd serviceå’ŒEndpoints</a></li>
<li><a href="#h:14c3ac8c-aa13-4549-a062-119915c60a3e">æµ‹è¯•æ˜¯å¦ä»£ç†æˆåŠŸ</a></li>
<li><a href="#h:84da2901-dd99-404d-9d44-f7c859d55e47">åˆ›å»º secret</a></li>
<li><a href="#h:4788ce90-2fea-4c2a-b404-0c27734a6240">ç¼–è¾‘prometheusï¼ŒæŠŠè¯ä¹¦æŒ‚è½½è¿›å»</a></li>
<li><a href="#h:15abf503-dbfa-4094-9057-35e9385a5e7a">åˆ›å»ºServiceMonitor</a></li>
<li><a href="#h:15fa1748-a7c3-4e48-a1e2-c46d6a4e57a6">prometheus ui é¡µé¢æŸ¥çœ‹ä¸‰ä¸ªetcdèŠ‚ç‚¹éƒ½è·å–åˆ°æ•°æ®</a></li>
<li><a href="#h:fc1d3ce1-8f7a-4d7c-bc1a-70e02c579cee">grafanaæ¨¡æ¿å¯¼å…¥</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:46de4e55-a657-43e2-b70e-e3005efaccb8">Prometheusç›‘æ§å®æˆ˜</a>
<ul>
<li><a href="#h:9c2b7226-f947-4758-8182-31c0711d912b">Promethues é»‘ç›’ç›‘æ§</a>
<ul>
<li><a href="#h:42274e08-bb3d-49a5-909d-d4a3d097f3e9">éƒ¨ç½²exporter</a></li>
<li><a href="#h:1c167782-245a-4c94-9803-5a8d33a4ee23">additional ä¼ ç»Ÿç›‘æ§</a>
<ul>
<li><a href="#h:c04d2233-59ea-4a34-b376-55242d22620a">2.1ã€æ·»åŠ ä¸ªç›‘æ§æµ‹è¯•</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:f2e8f400-5040-4d62-86c0-6a8098e2fc8b">Prometheus é™æ€é…ç½®</a>
<ul>
<li><a href="#h:b67eb122-6ed3-4729-9042-153666b80a3b">additionalScrapeConfigs</a></li>
</ul>
</li>
<li><a href="#h:f17f34a7-46d9-412c-a5c0-f7cc5c9e0fd4">Prometheus ç›‘æ§ Windowsï¼ˆå¤–éƒ¨ï¼‰ä¸»æœº</a></li>
<li><a href="#h:95aac4c8-4613-45cf-a8b7-768cff7c71a0">è‡ªåŠ¨å‘ç°æ³¨å†ŒæœåŠ¡</a>
<ul>
<li><a href="#h:84d0c7ae-89d5-415a-be0f-72d719939821">æ­£åˆ™è¡¨è¾¾å¼</a></li>
<li><a href="#h:41ac00f3-8053-403d-b270-e8eb19bb6e9b">å‚æ•°è¯´æ˜</a></li>
<li><a href="#h:f937880c-b862-4afe-92a1-74b926a9ddae">è‡ªåŠ¨å‘ç° node-export å’Œ kubelet</a></li>
<li><a href="#h:cd1b702f-c009-48f5-9e12-0eb041f8a746">å¿…è¦çš„æ­¥éª¤</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:507e3211-f74e-4ea6-b827-0ac08b91e0d2">Prometheus è¯­æ³• PromQL</a>
<ul>
<li><a href="#h:ebe9dbb3-a7b8-4d78-be1f-e2a7786ee7c1">PromQL è¯­æ³•ä½“éªŒ</a>
<ul>
<li><a href="#h:0a32ef10-305d-476f-a729-605db7808c75">Prometheus Metricsç±»å‹</a></li>
<li><a href="#h:d4eb1955-8361-4bd7-a250-105aae0cefee">MetricsæŒ‡æ ‡ç±»å‹</a>
<ul>
<li><a href="#h:3157d636-3133-47e3-9745-e5c844aa2c8d">Counter ï¼ˆè®¡æ•°å™¨ï¼‰</a></li>
<li><a href="#h:fde38788-6699-43be-b0ae-f2a3a2a9ba93">Guageï¼ˆ ä»ªè¡¨ç›˜ï¼‰</a></li>
<li><a href="#h:5fe14672-67d4-4327-aaf8-f8665f59e8bd">Histogramï¼ˆç›´æ–¹å›¾ï¼‰</a></li>
<li><a href="#h:3f09f685-9b6e-46d4-93f4-80dca66bdd3c">Summaryï¼ˆæ‘˜è¦ï¼‰</a></li>
</ul>
</li>
<li><a href="#h:31a4e901-b8a7-4b6b-aa08-0f13f466ed8b">æ•°æ®æ¨¡å‹</a>
<ul>
<li><a href="#h:60d2a1c7-6132-4095-8e0c-c636a082ffe8">æŒ‡æ ‡åç§°å’Œæ ‡ç­¾</a></li>
<li><a href="#h:15b1a041-41df-4fa1-8c54-ec8bfdcd7626">æ ·æœ¬ï¼ˆsampleï¼‰</a></li>
<li><a href="#h:7ca8cae1-393c-401a-9047-c5ddf6000a39">è¡¨ç¤ºæ–¹å¼</a></li>
</ul>
</li>
<li><a href="#h:1a8584e2-e996-41cb-80f9-865e07992975">PromQL</a>
<ul>
<li><a href="#h:2431a6cf-443c-479f-9089-149637a06443">è¡¨è¾¾å¼è¯­è¨€æ•°æ®ç±»å‹</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:d637d076-49d1-4746-b7e9-b834c507612a">PromQL æ“ä½œç¬¦</a>
<ul>
<li><a href="#h:34ea3356-7dab-4825-9ece-ae7c85dd272f"><code>group_left</code></a></li>
</ul>
</li>
<li><a href="#h:44ca4052-0c29-403e-a90a-a28070bcf348">PromQL å¸¸ç”¨å‡½æ•°</a>
<ul>
<li><a href="#h:e42c4339-59ba-4875-a9ee-8c59171ed853">ä¸€ä¸ªæŒ‡æ ‡çš„å¢é•¿ç‡</a></li>
<li><a href="#h:73136684-06a7-4cf2-b624-bb9e09aa0b92">é¢„æµ‹ç»Ÿè®¡ï¼š</a></li>
<li><a href="#h:1752ba3d-ef89-45cd-9ee7-3fcc835e70e6">å»é™¤å°æ•°ç‚¹ï¼š</a></li>
<li><a href="#h:3eabcc4b-aa43-4d81-9212-c1accaab7af3">æ’åºï¼š</a></li>
<li><a href="#h:e21789fc-4541-48df-a696-674dbd5d694a">æ–° label</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:ebf11448-544f-4033-818f-50dc637f98a4">Alertmanagerå‘Šè­¦å®æˆ˜</a>
<ul>
<li><a href="#h:14985a1c-644e-465f-b1b5-106d3fd47468">Alertmanager ç›‘æ§æŠ¥è­¦</a></li>
<li><a href="#h:0d71079c-d30e-487e-a7ef-b71182734df0">alertmanager é…ç½®æ–‡ä»¶è§£æ</a></li>
<li><a href="#h:cd3fbfce-e27c-436e-94b5-37e632d3c1d4">route-è·¯ç”±è§„åˆ™</a></li>
<li><a href="#h:4ba6913b-be71-47f2-b96e-73b96515d6ab">receivers-å‘Šè­¦é€šçŸ¥</a>
<ul>
<li><a href="#h:a1f265e1-ca0b-408c-bb66-9375d1541438">å‘Šè­¦é‚®ä»¶é€šçŸ¥</a></li>
<li><a href="#h:72fc7d8a-fed8-4df9-84af-9851fb5ff61d">å‘Šè­¦å¾®ä¿¡é€šçŸ¥</a></li>
<li><a href="#h:a8dbe787-4083-4edc-8390-597ec9299469">slack</a></li>
<li><a href="#h:948a621c-c649-40b5-9c4c-b69285ef84d6">è‡ªå®šä¹‰æ¥æ”¶è€…-è‡ªå»ºæ¥å£</a></li>
</ul>
</li>
<li><a href="#h:aab88a77-78c3-42ad-a601-9fd5b9f6aaa9">templates-è‡ªå®šä¹‰å‘Šè­¦æ¨¡æ¿</a>
<ul>
<li><a href="#h:4602864c-6f7c-45e7-a9ea-28afe14ae1ca">å¾®ä¿¡å‘Šè­¦æ¨¡æ¿</a></li>
</ul>
</li>
<li><a href="#h:339556f0-dcec-41fe-9ad7-d76a406b75dc">inhibit_rules-é™åˆ¶</a></li>
<li><a href="#h:9828702b-5c89-4409-a844-5fe89975b698">è®¡åˆ’å†…ç»´æŠ¤æš‚åœå‘Šè­¦ Silence</a></li>
<li><a href="#h:655ad2ea-0d20-4c45-acad-836caeddb9f9">æ‰‹åŠ¨è§¦å‘å‘Šè­¦</a></li>
</ul>
</li>
<li><a href="#h:f8ebcb30-d2e3-4174-aecb-6ef83a44fedd">Prometheus å‘Šè­¦å®æˆ˜</a>
<ul>
<li><a href="#h:c7ceac4e-4c8d-42bb-bfc2-1b80f730b663">PrometheusRule</a>
<ul>
<li><a href="#h:99be0d9e-5c39-4aee-a842-e3ca9bbbffb2">è§„åˆ™è¯­æ³•</a></li>
</ul>
</li>
<li><a href="#h:07378308-4f48-4203-8726-92eab0e1c63d">åŸŸåè®¿é—®å»¶è¿Ÿå‘Šè­¦</a>
<ul>
<li><a href="#h:eb9295da-8ce4-4c8f-b50f-8987c6d2bfca">å‘Šè­¦è§„åˆ™</a></li>
<li><a href="#h:f556fcb8-f5f8-45fe-bf72-bac812dd960f">ingress è‡ªåŠ¨ç›‘æ§åŸŸå</a></li>
</ul>
</li>
<li><a href="#h:e67b48f6-8020-4b06-b6b8-4ec5013127ca">prometheus ç›‘æ§ Java JVM</a>
<ul>
<li><a href="#h:c23fe1d4-2a58-48cd-92ec-72eebc9d1919">Java JVMç›‘æ§</a></li>
<li><a href="#h:eb39c790-aa0b-4c70-8e80-81aedcd32869">åŸºäº euraka æœåŠ¡è‡ªåŠ¨å‘ç°ç›‘æ§ JVM</a></li>
</ul>
</li>
<li><a href="#h:26da6d52-da21-4ae6-9dc8-081b3f20894d">ç›‘æ§å‘Šè­¦é€šç”¨æ­¥éª¤</a></li>
<li><a href="#h:59979eba-dadd-47ff-863b-ae6f98c6a98c">è§£å†³ç›‘æ§é—®é¢˜</a>
<ul>
<li><a href="#h:70da9f17-6132-4c4f-bd39-49e4155d4b27">è§£å†³scheduleå’Œcontrollerç›‘æ§é—®é¢˜</a></li>
<li><a href="#h:55302452-c660-44f6-a17e-a634706ad7ef">CPUThrottlingHigh</a></li>
</ul>
</li>
<li><a href="#h:3eeaa294-05a7-4cff-872b-b622e2f82688">è®°å½•è§„åˆ™ä¼˜åŒ– PromQL è¯­å¥</a></li>
</ul>
</li>
<li><a href="#h:aa168970-406c-44c0-8cd0-8f3cb0bb80e4">å…¶å®ƒ</a>
<ul>
<li><a href="#h:1c09d771-38f0-4dd3-a989-e025d209d4ba">grafana</a>
<ul>
<li><a href="#h:d284591d-854c-4e5a-853e-2ee6a38aeb26">å›¾è¡¨å˜é‡å–å€¼</a></li>
</ul>
</li>
<li><a href="#h:c5d5ba75-c5b0-44e8-8b96-2846bf43adce">alertmanager webhook json</a></li>
<li><a href="#h:efe9f42f-ac0d-4231-a8ee-71b44e1420ad">PromSQL</a></li>
<li><a href="#h:59dc55b1-82c4-4536-b5f1-32a8ba53c03c">prometheus æ•°æ®æ¸…ç†</a></li>
<li><a href="#h:711178d5-9434-45b4-8e2b-247afdb0f7f7">pushgateway</a>
<ul>
<li><a href="#h:d6ccbdf3-13d3-49e7-9fa8-2ccde0f527c8">å®‰è£…</a></li>
<li><a href="#h:77378b9a-c99d-4ef0-9edc-0c9a6f8f5c14">æ¸…ç†æ•°æ®</a></li>
<li><a href="#h:a7b9e28b-349f-468f-9383-85c616c2889a">è„šæœ¬</a></li>
<li><a href="#h:ff228fea-7a85-47ec-b622-7c0a340fb9aa">pushway è„šæœ¬</a></li>
</ul>
</li>
<li><a href="#h:8b99ae58-538e-4c00-a31b-018b034f9d37">å‘Šè­¦é’‰é’‰é€šçŸ¥</a>
<ul>
<li><a href="#h:c5a0a9ac-76dc-4f21-9b6d-4412ca9b6711">é’‰é’‰æŠ¥è­¦æ¨¡æ¿</a></li>
<li><a href="#h:d5917aef-b520-4eec-bb3b-fdd28f1560b0">k8s éƒ¨ç½²</a></li>
</ul>
</li>
<li><a href="#h:ca8d2783-1186-437b-b31e-d14f79500d18">éäº‘åŸç”Ÿåº”ç”¨ç›‘æ§ Exporter</a>
<ul>
<li><a href="#h:a242b9a0-99de-4973-83d9-e2747cacb0ec">Kafka exporter</a></li>
<li><a href="#h:f44b11f1-dbf2-41f2-8c2d-252ece19a380">node-exporter</a>
<ul>
<li><a href="#h:7c56f1ed-565e-4f25-bcf8-402deaca3cf6">node-exporter-serviceAccount.yaml</a></li>
<li><a href="#h:d27f8e4c-89f6-482d-9396-85422aefe8e7">node-exporter-clusterRoleBinding.yaml</a></li>
<li><a href="#h:3846203e-fd76-4142-9fc5-1a40bd2e7cab">node-exporter-clusterRoleBinding.yaml</a></li>
<li><a href="#h:bd27efd8-c688-4271-9c06-9120946d58ab">node-exporter-daemonset.yaml</a></li>
<li><a href="#h:31d83fec-56e9-404d-be02-7a29bbf99216">é™æ€æ³¨å†Œé…ç½®</a></li>
</ul>
</li>
<li><a href="#h:225c17b3-0ed3-499b-be9b-8495517fe76b">redis-exporter</a></li>
<li><a href="#h:973f36df-5980-4ac8-8f63-7c32474a8afc">rocketmq-exporter</a></li>
<li><a href="#h:c3cb474a-e85d-4620-a5a9-0eb259b285b0">awk-cloudwatch-exporter</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:d59ef2b6-2157-40e1-bfda-656fb7eb2429">å‚è€ƒ</a></li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="./index.html">Kubernetes</a></li>
</ul>
<section id="outline-container-h:c52a7a86-84cd-4ebf-9e9d-add2bd8d188b" class="outline-2">
<h2 id="h:c52a7a86-84cd-4ebf-9e9d-add2bd8d188b">Prometheus ç›‘æ§å…¥é—¨</h2>
<div class="outline-text-2" id="text-h:c52a7a86-84cd-4ebf-9e9d-add2bd8d188b">
</div>
<div id="outline-container-h:d4a79c7c-c1f4-4fa5-a871-a100c5339317" class="outline-3">
<h3 id="h:d4a79c7c-c1f4-4fa5-a871-a100c5339317">ä»€ä¹ˆæ˜¯ Prometheus</h3>
<div class="outline-text-3" id="text-h:d4a79c7c-c1f4-4fa5-a871-a100c5339317">
<p>
<a href="https://github.com/prometheus)">Prometheus</a>æ˜¯ä¸€ä¸ªå¼€æºç›‘æ§ç³»ç»Ÿå’ŒæŠ¥è­¦æ¡†æ¶ï¼Œå…¶æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªæ—¶åºæ•°æ®åº“ï¼ˆTSDBï¼‰ï¼Œå®ƒçš„è®¾è®¡çµæ„Ÿæ¥æºäº Google çš„ Borgmonï¼Œå°±åƒ Kubernetes æ˜¯åŸºäº Borg ç³»ç»Ÿå¼€æºçš„ã€‚
</p>

<p>
å®ƒæ˜¯ç”± SoundCloud çš„ Google å‰å‘˜å·¥è®¾è®¡å¹¶å¼€æºçš„ã€‚2016å¹´åŠ äº†äº‘åŸç”ŸåŸºé‡‘ä¼šï¼ˆCNCFï¼‰ã€‚
</p>
</div>
<div id="outline-container-h:cfdcbaa9-b656-4a60-8f0d-8024cf881bbb" class="outline-4">
<h4 id="h:cfdcbaa9-b656-4a60-8f0d-8024cf881bbb">Prometheus ç‰¹æ€§</h4>
<div class="outline-text-4" id="text-h:cfdcbaa9-b656-4a60-8f0d-8024cf881bbb">
<p>
Prometheusçš„ä¸»è¦ç‰¹å¾æœ‰ï¼š
</p>

<ul class="org-ul">
<li>ä¸€ä¸ªå¤šç»´åº¦æ•°æ®æ¨¡å‹ï¼Œå…·æœ‰ç”±æŒ‡æ ‡åç§°å’Œé”®/å€¼å¯¹æ ‡è¯†çš„æ—¶é—´åºåˆ—æ•°æ®ï¼›</li>
<li>ä½¿ç”¨ PromQL æŸ¥è¯¢å’Œèšåˆæ•°æ®ï¼Œå¯ä»¥çµæ´»çš„å¯¹æ•°æ®è¿›è¡Œæ£€ç´¢ï¼›</li>
<li>ä¸ä¾èµ–é¢å¤–çš„æ•°æ®å­˜å‚¨ï¼ŒPrometheus æœ¬èº«å°±æ˜¯ä¸€ä¸ªæ—¶åºæ•°æ®åº“ï¼Œæä¾›æœ¬åœ°å­˜å‚¨å’Œåˆ†å¸ƒå­˜å‚¨ï¼Œå¹¶ä¸”æ¯ä¸ª Prometheus éƒ½æ˜¯è‡ªæ²»çš„ï¼›</li>
<li>åº”ç”¨ç¨‹åºæš´éœ² Metrics æ¥å£ï¼ŒPrometheus é€šè¿‡åŸºäº HTTP çš„ Pull æ¨¡å‹é‡‡é›†æ•°æ®ï¼ŒåŒæ—¶å¯ä»¥ä½¿ç”¨ PushGateway è¿›è¡Œ Push æ•°æ®ï¼›</li>
<li>Prometheus åŒæ—¶æ”¯æŒåŠ¨æ€æœåŠ¡å‘ç°å’Œé™æ€é…ç½®ï¼ˆå¢¨ç›’ï¼‰å‘ç°ç›®æ ‡æœºå™¨ï¼›</li>
<li>æ”¯æŒå¤šç§å¤šæ ·çš„å›¾è¡¨å’Œç•Œé¢å±•ç¤ºï¼Œå’Œ grafana å ªç§°ã€ç»é…ã€ã€‚</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:5788f988-ff14-47f8-8300-d3475a3a22dc" class="outline-3">
<h3 id="h:5788f988-ff14-47f8-8300-d3475a3a22dc">Prometheus æ¶æ„å‰–æ</h3>
<div class="outline-text-3" id="text-h:5788f988-ff14-47f8-8300-d3475a3a22dc">
<p>
<a href="https://prometheus.io/docs/introduction/overview/#architecture">https://prometheus.io/docs/introduction/overview/#architecture</a>
</p>


<figure id="orgaeae0eb">
<img src="https://prometheus.io/assets/docs/architecture.svg" alt="architecture.svg" class="org-svg">

</figure>

<p>
Prometheusç”Ÿæ€åŒ…æ‹¬äº†å¾ˆå¤šç»„ä»¶ï¼Œå®ƒä»¬ä¸­çš„ä¸€äº›æ˜¯å¯é€‰çš„ï¼š
</p>
<ul class="org-ul">
<li>Prometheus serverï¼šä¸»æœåŠ¡è´Ÿè´£æŠ“å–å’Œå­˜å‚¨æ—¶é—´åºåˆ—æ•°æ®ï¼Œå­˜å‚¨æ¨èä½¿ç”¨ HDD æˆ–è€… SSD ç£ç›˜</li>
<li>Alertmanagerï¼šè­¦å‘Šç®¡ç†å™¨</li>
<li>Grafanaï¼šå±•ç¤º Prometheus æ•°æ®</li>
<li>Pushgatewayï¼šæ”¯æŒçŸ­ç”Ÿå‘½å‘¨æœŸçš„PUSHç½‘å…³</li>
<li>Exporters: é‡‡é›†åº”ç”¨æ•°æ®ï¼Œ é’ˆå¯¹éäº‘åŸç”Ÿåº”ç”¨ï¼Œæ²¡æœ‰ metrics æ¥å£çš„æœåŠ¡ï¼Œå¦‚ mysql,node,kafka</li>
<li>Service discoveryï¼šå¯ä»¥ç”¨ k8s ã€cousuleã€æ–‡ä»¶ çš„è‡ªåŠ¨å‘ç°</li>
</ul>
</div>
</div>
<div id="outline-container-h:f0db2779-57a4-445d-9390-737436c9874c" class="outline-3">
<h3 id="h:f0db2779-57a4-445d-9390-737436c9874c">Prometheus å®‰è£…</h3>
<div class="outline-text-3" id="text-h:f0db2779-57a4-445d-9390-737436c9874c">
</div>
<div id="outline-container-h:667bf30b-ad0a-4085-92e2-3eff5a3f2528" class="outline-4">
<h4 id="h:667bf30b-ad0a-4085-92e2-3eff5a3f2528">Prometheus å®‰è£…æ–¹å¼é€‰æ‹©</h4>
<div class="outline-text-4" id="text-h:667bf30b-ad0a-4085-92e2-3eff5a3f2528">
<ul class="org-ul">
<li>äºŒè¿›åˆ¶å®‰è£…</li>
<li>å®¹å™¨å®‰è£…</li>
<li>helm å®‰è£…ï¼šé’ˆå¯¹æ— çŠ¶æ€åº”ç”¨è®¾è®¡</li>
<li><p>
Prometheus Operatorï¼šæ¨èï¼Œå€¾å‘æ¯”è¾ƒå¤æ‚çš„é›†ç¾¤è€Œè®¾è®¡çš„
</p>

<p>
github: <a href="https://github.com/prometheus-operator/prometheus-operator">https://github.com/prometheus-operator/prometheus-operator</a>
</p>

<p>
æ–‡æ¡£ï¼š <a href="https://prometheus-operator.dev/">https://prometheus-operator.dev/</a>
</p>

<ul class="org-ul">
<li>Kube-Prometheus Stackï¼šæ¨èï¼Œæ˜¯ä¸ªæŠ€æœ¯æ ˆ
<ul class="org-ul">
<li>Prometheus Operator</li>
<li>é«˜å¯ç”¨çš„ Prometheus</li>
<li>é«˜å¯ç”¨çš„ Alertmanager</li>
<li>ä¸»æœºç›‘æ§ Node Exporter</li>
<li>Prometheus Adapter</li>
<li>å®¹å™¨ç›‘æ§ Kube-state-metrics</li>
<li>å›¾å½¢åŒ–å±•ç¤º Grafana</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:b6d70874-f374-4eb9-ab6a-e41e75e63fac" class="outline-4">
<h4 id="h:b6d70874-f374-4eb9-ab6a-e41e75e63fac">Prometheus é«˜å¯ç”¨å®‰è£…</h4>
<div class="outline-text-4" id="text-h:b6d70874-f374-4eb9-ab6a-e41e75e63fac">
<p>
ä½¿ç”¨ Kube-Prometheus Stack å®‰è£…æ–¹å¼ï¼š
</p>

<ul class="org-ul">
<li>æ‰‹åŠ¨ç‰ˆ: <a href="https://github.com/prometheus-operator/kube-prometheus">https://github.com/prometheus-operator/kube-prometheus</a></li>
<li>helmç‰ˆï¼š<a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack">https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack</a>
<ul class="org-ul">
<li>å’Œæ‰‹åŠ¨åŒºåˆ«åœ¨äºæ‰‹åŠ¨æ¿æ˜¯å¤šä¸ªé™æ€æ–‡ä»¶æ¯”è¾ƒç›´è§‚ï¼Œhelm é å˜é‡çµæ´»è½¬åŒ–æˆæ–‡ä»¶éƒ¨ç½²ï¼Œè‡ªå®šä¹‰ä¿®æ”¹values.yamlæ–‡ä»¶å°±è¡Œã€‚å¦å¤–helmç‰ˆæ²¡æœ‰å¢¨ç›’ç›‘æ§(blackbox)ã€‚</li>
<li>å®‰è£… <code>helm install -n monitoring prometheus prometheus-community/kube-prometheus-stack</code> æ³¨æ„è‡ªå®šä¹‰èµ„æºPrometheusé…ç½®æ–‡ä»¶åŠ äº†æ ‡ç­¾è¯†åˆ«é™åˆ¶ <code>release: prometheus</code> ï¼Œåˆ›å»ºserviceMonitorã€podMointorã€Probeç­‰éƒ½éœ€è¦å¢åŠ è¿™ä¸ªæ ‡ç­¾</li>
</ul></li>
</ul>

<p>
é¦–å…ˆéœ€è¦é€šè¿‡è¯¥é¡¹ç›®åœ°å€ï¼Œæ‰¾åˆ°å’Œè‡ªå·± k8s ç‰ˆæœ¬å¯¹åº”çš„ Kube Prometheus Stack çš„ç‰ˆæœ¬
</p>


<figure id="org74b3049">
<img src="./images/Snipaste_2022-09-07_16-50-39.png" alt="Snipaste_2022-09-07_16-50-39.png" width="50%">

</figure>

<p>
æ¯å°æœºå™¨çš„é…ç½®æœ€å¥½åœ¨ 4C4G ä»¥ä¸Šã€‚
</p>

<p>
ä¸‹è½½ï¼š
</p>

<div class="org-src-container">
<pre class="src src-shell">git clone -b release-0.8 --single-branch https://github.com/prometheus-operator/kube-prometheus
</pre>
</div>

<p>
å®‰è£… operatorï¼š
</p>

<p>
å› ä¸ºæ‰€æœ‰çš„ç»„ä»¶éƒ½æ˜¯é€šè¿‡ operator æ§åˆ¶çš„ã€‚
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">cd kube-prometheus/manifests
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">kubectl create -f setup/
</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#26159;&#21542;Running
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">kubectl get pod -n monitoring
</span>NAME                                   READY   STATUS        RESTARTS   AGE
prometheus-operator-848d669f6d-bz2tc   2/2     Running       0          4m16s
</pre>
</div>

<p>
Operator å®¹å™¨å¯åŠ¨åï¼Œå®‰è£… Prometheus Stack
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">cd</span> kube-prometheus/manifests
kubectl create -f .

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#29366;&#24577;
</span>kubectl get pod -n monitoring
</pre>
</div>

<p>
æ³¨æ„ï¼šéç”Ÿäº§å¯ä¸åšé«˜å¯ç”¨ï¼Œå‰¯æœ¬æ•°åšè°ƒæ•´
</p>
<ul class="org-ul">
<li>ä¿®æ”¹ alertmanager-alertmanager.yaml å‰¯æœ¬æ•°æ”¹ä¸º 1 ä¸ª</li>
<li>ä¿®æ”¹ prometheus-prometheus.yaml  å‰¯æœ¬æ•°æ”¹ä¸º 1 ä¸ª</li>
<li>kube-state-metrics-deployment.yaml é•œåƒæ”¹ä¸ºå¿«é€Ÿçš„é•œåƒï¼Œdocker hub æœç´¢ bitnami/kube-stat-metrics</li>
</ul>

<p>
å¸¸è§å‚æ•°
</p>
<div class="org-src-container">
<pre class="src src-shell">containers:
- args:
  - --config.file=/etc/prometheus/prometheus.yml  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#37197;&#32622;&#25991;&#20214;
</span>  - --query.timeout=1m
  - --storage.tsdb.wal-compression  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25968;&#25454;&#21387;&#32553;&#65292;&#40664;&#35748;&#24320;&#21551;
</span>  - --query.max-samples=20000000
  - --storage.tsdb.path=/prometheus  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25968;&#25454;&#23384;&#20648;&#36335;
</span>  - --storage.tsdb.retention.time=90d  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25968;&#25454;&#20445;&#30041;&#26102;&#38388;
</span>  - --storage.tsdb.min-block-duration=1h
  - --storage.tsdb.max-block-duration=2h
  - --web.console.libraries=/etc/prometheus/console_libraries
  - --web.console.templates=/etc/prometheus/consoles
  - --web.enable-lifecycle  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25903;&#25345;&#28909;&#26356;&#26032;&#65292;&#30452;&#25509;&#25191;&#34892;localhost:9090/-/reload&#31435;&#21363;&#29983;&#25928;
</span>  <span style="color: #b22222;">#</span><span style="color: #b22222;">- --web.external-url=/eks
</span>  - --web.external-url=https://prometheus.gxxx.com/eks  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23545;&#22806;&#37096;&#22320;&#22336;&#65292;alertmanager &#21457;&#36865;&#25253;&#35686;&#26102;&#20256;&#36882;&#35813;&#22320;&#22336;
</span>  - --web.enable-admin-api  <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#25968;&#25454;&#31649;&#29702;&#65292;&#21024;&#38500;&#25968;&#25454;&#31561;&#12290;&#21442;&#32771; https://prometheus.io/docs/prometheus/latest/querying/api/#tsdb-admin-apis
</span>  image: prom/prometheus:v2.34.0
</pre>
</div>

<p>
pv,pvc å­˜å‚¨ : <a href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/storage.md">https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/storage.md</a>
</p>

<p>
åˆ›å»º ingress
</p>

<ul class="org-ul">
<li>Grafanaï¼šæ•°æ®å±•ç¤º</li>
<li>Prometheus uiï¼šPromQL æŸ¥è¯¢ã€é…ç½®æŸ¥çœ‹</li>
<li>Alertmanagerï¼šå‘Šè­¦ç®¡ç†ï¼Œå‘ç”ŸæŠ¥è­¦å¯è®¾ç½®é™é»˜</li>
</ul>

<div class="org-src-container">
<pre class="src src-yaml"># åˆ›å»ºä¸€ä¸‹Ingressä»£ç†ä¸‰ä¸ªservice
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  generation: 1
  name: prom-ingresses
  namespace: monitoring
spec:
  rules:
  - host: alert.test.com
    http:
      paths:
      - backend:
          serviceName: alertmanager-main
          servicePort: 9093
        path: /
  - host: grafana.test.com
    http:
      paths:
      - backend:
          serviceName: grafana
          servicePort: 3000
        path: /
  - host: prome.test.com
    http:
      paths:
      - backend:
          serviceName: prometheus-k8s
          servicePort: 9090
        path: /
</pre>
</div>

<p>
é¡µé¢è®¿é—®
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;&#20320;Windows&#30340;hosts&#25991;&#20214;&#28155;&#21152;&#20027;&#26426;&#26144;&#23556;&#65292;&#27983;&#35272;&#22120;&#35775;&#38382;&#21363;&#21487;
</span>10.4.7.107 alert.test.com grafana.test.com prome.test.com
</pre>
</div>

<p>
grafana è´¦å·å¯†ç é»˜è®¤ admin:admin ï¼Œé»˜è®¤æœ‰ä¸€äº› k8s ç›¸å…³çš„æ¨¡æ¿ã€‚
</p>

<p>
å…¶å®ƒé¡µé¢æ˜¯æ²¡æœ‰è´¦å·ç™»å½•çš„ï¼Œå¯ä»¥ä» ingress é…ç½®ã€‚
</p>
</div>
</div>
</div>
<div id="outline-container-h:20c8cba3-456b-440b-942e-e60593915f47" class="outline-3">
<h3 id="h:20c8cba3-456b-440b-942e-e60593915f47">äº‘åŸç”Ÿå’Œéäº‘åŸç”Ÿåº”ç”¨çš„ç›‘æ§æµç¨‹</h3>
<div class="outline-text-3" id="text-h:20c8cba3-456b-440b-942e-e60593915f47">
</div>
<div id="outline-container-h:947f06ff-52ce-4209-a574-e0a05c87ca36" class="outline-4">
<h4 id="h:947f06ff-52ce-4209-a574-e0a05c87ca36">Promethues çš„æ•°æ®æ¥æº</h4>
<div class="outline-text-4" id="text-h:947f06ff-52ce-4209-a574-e0a05c87ca36">
<ul class="org-ul">
<li>äº‘åŸç”Ÿåº”ç”¨ï¼š/metrics</li>
<li>éåŸç”Ÿåº”ç”¨ï¼šExporter é‡‡é›†</li>
</ul>

<p>
ç›®å‰æ¯”è¾ƒå¸¸ç”¨çš„ Exporter å·¥å…·å¦‚ä¸‹ï¼š
</p>
<ul class="org-ul">
<li>æ•°æ®åº“ï¼šMySQL Exporter, Redis Exporter, MongoDB Exporter, MSSQL Exporter</li>
<li>é…ç½®ä¸­å¿ƒï¼šNacos Exporter</li>
<li>ç¡¬ä»¶: Apcupsd Exporter, IoT Edison Exporter, IPMI Exporter, Node Exporter</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šRocketMQ Exporter, Kafka Exporter, Beanstalkd Exporter, NSQ Exporter, RabbitMQ Exporter</li>
<li>å­˜å‚¨ï¼šCeph Exporter, Gluster Exporter, HDFS Exporter, ScalelO Exporter</li>
<li>HTTP æœåŠ¡ï¼šApache Exporter, HAProxy Exporter, Nginx Exporter</li>
<li>API æœåŠ¡ï¼šAWS ECS Exporter, Docker Cloud Exporter, Docker Hub Exporter, Github Exporter</li>
<li>æ—¥å¿—ï¼šFluentd Exporter, Grok Exporter</li>
<li>ç›‘æ§ç³»ç»Ÿï¼šCollectd Exporter, Graphite Exporter, InfluxDB Exporter, Nagios Exporter, SNMP Exporter</li>
<li>AWSï¼šCloudWatch Exporter</li>
<li>å…¶å®ƒï¼šBlockbox Exporter, JIRA Exporter, Jenkins Exporter, Confluence Exporter</li>
</ul>
</div>
</div>
<div id="outline-container-h:41f35e02-869f-49a8-b5d7-b279d72f02f3" class="outline-4">
<h4 id="h:41f35e02-869f-49a8-b5d7-b279d72f02f3">Prometheus æ€ä¹ˆçŸ¥é“æ•°æ®çš„æ¥æº</h4>
<div class="outline-text-4" id="text-h:41f35e02-869f-49a8-b5d7-b279d72f02f3">
</div>
<div id="outline-container-h:3d785849-0b6a-45ee-86aa-1edf29c0d758" class="outline-5">
<h5 id="h:3d785849-0b6a-45ee-86aa-1edf29c0d758">ä»€ä¹ˆæ˜¯ ServiceMonitor</h5>
<div class="outline-text-5" id="text-h:3d785849-0b6a-45ee-86aa-1edf29c0d758">

<figure id="org9d2710b">
<img src="./images/Snipaste_2022-09-07_18-58-18.png" alt="Snipaste_2022-09-07_18-58-18.png" width="50%">

</figure>

<ul class="org-ul">
<li>é€šè¿‡ prometheus.yml åŠ è½½é…ç½®
<ul class="org-ul">
<li>äºŒè¿›åˆ¶å®‰è£…</li>
<li>å®¹å™¨å®‰è£…</li>
<li>Helm</li>
</ul></li>
<li>é€šè¿‡ ServiceMonitor åŠ è½½é…ç½®
<ul class="org-ul">
<li>Helm</li>
<li>Prometheus Operator</li>
<li>Kube-Prometheus Stack</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">kubectl  get servicemonitor -n monitoring
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b20f1899-321d-4d5b-9940-b5c6157e00c6" class="outline-5">
<h5 id="h:b20f1899-321d-4d5b-9940-b5c6157e00c6">ServiceMonitor é…ç½®è§£æ</h5>
<div class="outline-text-5" id="text-h:b20f1899-321d-4d5b-9940-b5c6157e00c6">
<p>
ä½¿ç”¨ Operator å®‰è£…æ¨èä½¿ç”¨ ServiceMonitor é…ç½®ç›‘æ§ç›®æ ‡
</p>

<p>
ServiceMonitor æ˜¯ç”¨æ¥åŒ¹é… Service æ ‡ç­¾çš„æœåŠ¡ï¼Œå†è‡ªåŠ¨ç”Ÿäº§ prometheus é…ç½®æ–‡ä»¶
</p>

<p>
å¦‚æ³¨å†Œ blackbox-exporter é…ç½®
</p>
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: blackbox-exporter
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 0.18.0
  name: blackbox-exporter
  namespace: monitoring
spec:
  endpoints:
  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    interval: 30s
    path: /metrics
    port: https
    scheme: https
    tlsConfig:
      insecureSkipVerify: true
  selector:
    matchLabels:
      app.kubernetes.io/component: exporter
      app.kubernetes.io/name: blackbox-exporter
      app.kubernetes.io/part-of: kube-prometheus
</pre>
</div>

<p>
æ³¨å†Œ node exporter é…ç½®
</p>
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: node-exporter
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 1.1.2
  name: node-exporter
  namespace: monitoring
spec:
  endpoints:
  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    interval: 15s
    port: https
    relabelings:
    - action: replace
      regex: (.*)
      replacement: $1
      sourceLabels:
      - __meta_kubernetes_pod_node_name
      targetLabel: instance
    scheme: https
    tlsConfig:
      insecureSkipVerify: true
  jobLabel: app.kubernetes.io/name
  selector:
    matchLabels:
      app.kubernetes.io/component: exporter
      app.kubernetes.io/name: node-exporter
      app.kubernetes.io/part-of: kube-prometheus
</pre>
</div>

<p>
è¯´æ˜ï¼š
</p>
<ul class="org-ul">
<li>selectorï¼šç›‘æ§ç›®æ ‡çš„ Service çš„æ ‡ç­¾</li>
<li>namespaceSelectorï¼šç›‘æ§ç›®æ ‡ Service æ‰€åœ¨çš„åç§°ç©ºé—´</li>
<li>schemeï¼šMetrics æ¥å£åè®®</li>
<li>portï¼šMetrics ç«¯å£</li>
<li>pathï¼šMetrics æ¥å£è·¯å¾„</li>
<li>intervalï¼šç›‘æ§æ•°æ®æŠ“å–çš„æ—¶é—´é—´éš”</li>
<li>honorLabelsï¼šå¦‚æœç›®æ ‡æ ‡ç­¾å’ŒæœåŠ¡æ ‡ç­¾å†²çªï¼Œæ˜¯å¦ä¿ç•™ç›®æ ‡æ ‡ç­¾</li>
</ul>


<p>
æ³¨æ„ï¼š
å¦‚æœprometheus-prometheus.yaml æŒ‡å®šäº†åç§°ç©ºé—´æˆ–è€…æŒ‡æ ‡ï¼Œé‚£ä¹ˆéœ€è¦ ServiceMonitor ä¸ä¹‹ä¸€è‡´ã€‚é»˜è®¤æ˜¯ç©ºã€‚
</p>
<div class="org-src-container">
<pre class="src src-yaml">serviceMonitorNamespaceSelector: {}
serviceMonitorSelector: {}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6ae5214d-24aa-4607-92ea-2b6b04511a76" class="outline-5">
<h5 id="h:6ae5214d-24aa-4607-92ea-2b6b04511a76">æ­£å¸¸çš„é…ç½®è§£æ</h5>
<div class="outline-text-5" id="text-h:6ae5214d-24aa-4607-92ea-2b6b04511a76">
<p>
å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a>
</p>
</div>
</div>
<div id="outline-container-h:13c15752-926a-4b67-b1a6-76b74db9d93f" class="outline-5">
<h5 id="h:13c15752-926a-4b67-b1a6-76b74db9d93f">ServiceMonitor ç›‘æ§å¤±è´¥æ’æŸ¥æ­¥éª¤</h5>
<div class="outline-text-5" id="text-h:13c15752-926a-4b67-b1a6-76b74db9d93f">
<ul class="org-ul">
<li>ç¡®è®¤ ServiceMonitor æ˜¯å¦æˆåŠŸåˆ›å»º</li>
<li>ç¡®è®¤ ServiceMonitor æ ‡ç­¾æ˜¯å¦é…ç½®æ­£ç¡®</li>
<li>ç¡®è®¤ Prometheus æ˜¯å¦ç”Ÿæˆäº†ç›¸å…³é…ç½®</li>
<li>ç¡®è®¤å­˜åœ¨ ServiceMonitor åŒ¹é…çš„ Service</li>
<li>ç¡®è®¤é€šè¿‡ Service èƒ½å¤Ÿè®¿é—®ç¨‹åºçš„ Metrics æ¥å£</li>
<li>ç¡®è®¤ Service çš„ç«¯å£å’Œ Scheme å’Œ ServiceMonitor  ä¸€è‡´</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-h:bd160072-b7fd-4ab2-a5b8-a8a4caf21ec3" class="outline-3">
<h3 id="h:bd160072-b7fd-4ab2-a5b8-a8a4caf21ec3">éäº‘åŸç”Ÿåº”ç”¨ç›‘æ§ Exporter</h3>
<div class="outline-text-3" id="text-h:bd160072-b7fd-4ab2-a5b8-a8a4caf21ec3">
<p>
å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://prometheus.io/docs/instrumenting/exporters/">https://prometheus.io/docs/instrumenting/exporters/</a>
</p>
</div>
<div id="outline-container-h:f67acfcc-b6f0-4346-8dfe-df95b53ad713" class="outline-4">
<h4 id="h:f67acfcc-b6f0-4346-8dfe-df95b53ad713">mysql exporter</h4>
<div class="outline-text-4" id="text-h:f67acfcc-b6f0-4346-8dfe-df95b53ad713">
<p>
åˆ›å»º mysql æœåŠ¡å¹¶è®¾ç½® root å¯†ç 
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl create deploy mysql-tmp --image=mysql:5.7.23

kubectl set env deploy/mysql-tmp <span style="color: #a0522d;">MYSQL_ROOT_PASSWORD</span>=mysql
</pre>
</div>

<p>
åˆ›å»º Service æš´éœ² MySQL
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl expose deploy mysql-tmp --port 3306

kubectl get svc -l <span style="color: #a0522d;">app</span>=mysql-tmp
NAME        TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
mysql-tmp   ClusterIP   172.20.138.2   &lt;none&gt;        3306/TCP   19s

telnet 172.20.138.2 3306
</pre>
</div>

<p>
ç™»å½• MySQLï¼Œåˆ›å»º Exporter æ‰€éœ€çš„ç”¨æˆ·æƒé™
</p>
<div class="org-src-container">
<pre class="src src-shell">$ kubectl  exec -it mysql-tmp-79d4dd8d8-jnbrg -- bash
root@mysql-tmp-79d4dd8d8-jnbrg:/# mysql -uroot -pmysql
mysql&gt; create user <span style="color: #8b2252;">'exporter'</span>@<span style="color: #8b2252;">'%'</span>  identified by <span style="color: #8b2252;">'exporter'</span> with MAX_USER_CONNECTIONS 3;
mysql&gt; grant process, replication client, select on *.* to <span style="color: #8b2252;">'exporter'</span>@<span style="color: #8b2252;">'%'</span>;

</pre>
</div>

<p>
é…ç½® MySQL Exporter é‡‡é›† MySQL ç›‘æ§æ•°æ®
</p>
<div class="org-src-container">
<pre class="src src-shell">vim mysql-exporter.yaml

kind: Secret
metadata:
  name: prometheus-mysql-exporter
  namespace: monitoring
<span style="color: #483d8b;">type</span>: Opaque
data:
  password: <span style="color: #8b2252;">"bXlzcWw="</span>
---
apiVersion: v1
kind: Service
metadata:
  name: prometheus-mysql-exporter
  namespace: monitoring
  labels:
    k8s-app: prometheus-mysql-exporter
spec:
  <span style="color: #483d8b;">type</span>: ClusterIP
  ports:
  - port: 9104
    targetPort: 9104
    protocol: TCP
    name: mysql-exporter
  selector:
    k8s-app: prometheus-mysql-exporter
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus-mysql-exporter
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: prometheus-mysql-exporter
  template:
    metadata:
      labels:
        k8s-app: prometheus-mysql-exporter
      <span style="color: #b22222;">#</span><span style="color: #b22222;">annotations: # &#21160;&#24577;&#21457;&#29616;
</span>      <span style="color: #b22222;">#  </span><span style="color: #b22222;">prometheus.io/path: /metrics
</span>      <span style="color: #b22222;">#  </span><span style="color: #b22222;">prometheus.io/port: "9104"
</span>      <span style="color: #b22222;">#  </span><span style="color: #b22222;">prometheus.io/scrape: "true"
</span>    spec:
      containers:
      - name: prometheus-mysql-exporter
        image: <span style="color: #8b2252;">"prom/mysqld-exporter:v0.14.0"</span>
        imagePullPolicy: IfNotPresent
        env:
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: prometheus-mysql-exporter
              key: password
        - name: DATA_SOURCE_NAME
          value: <span style="color: #8b2252;">"exporter:$(DB_PASSWORD)@(mysql-tmp.default:3306)/"</span>
        ports:
        - containerPort: 9104
        livenessProbe:
          httpGet:
            path: /
            port: 9104
        readinessProbe:
          httpGet:
            path: /
            port: 9104
        resources:
          limits:
            cpu: <span style="color: #8b2252;">"100m"</span>
            memory: 100Mi
          requests:
            cpu: <span style="color: #8b2252;">"10m"</span>
            memory: 10Mi
</pre>
</div>

<p>
æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
</p>
<div class="org-src-container">
<pre class="src src-shell">$ kubectl  get svc -l k8s-app=prometheus-mysql-exporter -n monitoring
NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
prometheus-mysql-exporter   ClusterIP   172.20.227.60   &lt;none&gt;        9104/TCP   4m53s

$ curl 172.20.227.60:9104/metrics
</pre>
</div>

<p>
åˆ›å»º ServiceMonitor
</p>

<p>
å¦‚æœåŠ äº†è‡ªåŠ¨å‘ç°å¯å¿½ç•¥æ­¤æ­¥
</p>
<div class="org-src-container">
<pre class="src src-shell">$ cat mysql-sm.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    k8s-app: prometheus-mysql-exporter
  name: prometheus-mysql-exporter
  namespace: monitoring
spec:
  endpoints:
  - interval: 30s
    path: /metrics
    port: api
    scheme: http
  selector:
    matchLabels:
      k8s-app: prometheus-mysql-exporter
    namepsaceSelector:
      matchNames:
      - monitoring
</pre>
</div>

<p>
éœ€è¦ matchLabels å’Œ endpoints çš„é…ç½®è¦å’Œ MySQL çš„ Service ä¸€è‡´ã€‚ä¹‹ååˆ›å»ºè©² ServiceMonitor
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl apply -f mysql-sm.yaml
</pre>
</div>

<p>
å†æ£€æŸ¥ prometheus ui ä¸­çš„ target æ˜¯å¦ç”Ÿæ•ˆã€‚
</p>

<p>
æˆ–è€…ç”¨åŸºäºprometheus.yaml é…ç½®æ–‡ä»¶é…ç½®å‘ç°æœåŠ¡ï¼ŒåŠ¨æ€å¯ä»¥æ­å»º consule æœåŠ¡ mysql åº”ç”¨æ³¨å†Œè¿› consule å®Œæˆ prometheusåŠ¨æ€å‘ç°
</p>

<p>
å¦‚é™æ€æ–‡ä»¶åŠ è½½
</p>
<div class="org-src-container">
<pre class="src src-yaml">- job_name: 'mysql_master'
  scrape_interval: 20s
  honor_labels: true
  static_configs:
  - targets:
    - "172.21.89.124:9104"
    - "172.21.89.243:9104"
    labels:
      business: App
      dbtype: db-mysql-db
      team: platform
</pre>
</div>
</div>
<ul class="org-ul">
<li><a id="h:ff304ed3-d2ee-499d-a077-eb40dda190c2"></a>æ­¥éª¤ä¸€<br>
<div class="outline-text-6" id="text-h:ff304ed3-d2ee-499d-a077-eb40dda190c2">
<p>
åœ¨åˆ›å»ºPrometheusçš„deploymentä¸­åŠ ä¸Š
</p>

<div class="org-src-container">
<pre class="src src-yaml"># ä½ç½®ï¼šDeployment.spec.template.specä¸‹é¢
serviceAccountName: prometheus  # æŒ‡å®šè‡ªå·±åˆ›å»ºçš„sa


template:
    metadata:
      labels:
        app: prometheus # è¿™ä¸ªlabelsè¦è·Ÿselectorçš„ä¸€è‡´ï¼Œæ‰èƒ½åŒ¹é…ä¸Š
    spec:
      serviceAccountName: prometheus  # æŒ‡å®šè‡ªå·±åˆ›å»ºçš„sa
      volumes:          # çœŸæ­£æŒ‚è½½ï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°åº•ä¸‹å£°æ˜æŒ‚è½½çš„name
      - name: config    # è¿™é‡Œéœ€è¦è·Ÿåº•ä¸‹å£°æ˜æŒ‚è½½çš„name(config)ä¿æŒä¸€è‡´
        configMap:
          name: prometheus-config # configmap name

</pre>
</div>
</div>
</li>
<li><a id="h:a08260db-dbb1-4a4b-98c9-98753a5c8aee"></a>æ­¥éª¤äºŒ<br>
<div class="outline-text-6" id="text-h:a08260db-dbb1-4a4b-98c9-98753a5c8aee">
<p>
åˆ›å»ºSA,åˆ›å»ºæ–‡ä»¶prometheus-sa.yaml
</p>

<div class="org-src-container">
<pre class="src src-yaml">apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus   # åå­—è¦è·Ÿdeploymentä¸­çš„é‚£ä¸ªserviceAccountNameä¿æŒä¸€ç›´
  namespace: kube-mon
</pre>
</div>
</div>
</li>
<li><a id="h:9250c571-b86e-4dc2-9d60-995651e4e1b3"></a>æ­¥éª¤ä¸‰<br>
<div class="outline-text-6" id="text-h:9250c571-b86e-4dc2-9d60-995651e4e1b3">
<p>
åˆ›å»ºé›†ç¾¤è§’è‰²ï¼Œä¸”åšå¥½ç»‘å®šã€‚æ–‡ä»¶prometheus-rbac.yaml
</p>

<div class="org-src-container">
<pre class="src src-yaml"># å…ˆåˆ›å»ºä¸€ä¸ªé›†ç¾¤è§’è‰²ï¼Œç»™å®šä»¥ä¸‹ä¸€å †æƒé™
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus
rules:
- apiGroups:
  - ""
  resources:
  - nodes
  - services
  - endpoints
  - pods
  - nodes/proxy
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - "extensions"
  resources:
    - ingresses
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - configmaps
  - nodes/metrics
  verbs:
  - get
- nonResourceURLs:
  - /metrics
  verbs:
  - get
---
# ç„¶ååšé›†ç¾¤è§’è‰²ç»‘å®šï¼ŒæŠŠé›†ç¾¤è§’è‰²è·ŸSAç»‘å®šåœ¨ä¸€èµ·å³å¯
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: prometheus
roleRef:
  apiGroup: rbac.authorization.k8s.io  # ä½¿ç”¨è¿™ä¸ªAPI
  kind: ClusterRole   # æŒ‡å®šç»‘å®šçš„ClusterRoleåå­—æ˜¯prometheus
  name: prometheus
subjects:  # æŒ‡å®šç»‘å®šçš„kindä¸ºServiceAccountï¼Œname is prometheusï¼Œnamespace is kube-mon
- kind: ServiceAccount
  name: prometheus
  namespace: kube-mon
# æ‰€ä»¥ç°åœ¨è¿™ä¸ªnamespaceä¸‹çš„Podå°±æœ‰ä»¥ä¸Šæƒé™äº†
</pre>
</div>
</div>
</li>
<li><a id="h:011eebc5-5bfe-48b2-80ae-9de08017ba95"></a>æ­¥éª¤å››<br>
<div class="outline-text-6" id="text-h:011eebc5-5bfe-48b2-80ae-9de08017ba95">
<p>
ç„¶åé‡æ–°applyè¿™å‡ ä¸ªæ–‡ä»¶
</p>

<div class="org-src-container">
<pre class="src src-shell">[root@master1 prometheus]# ll
total 24
-rw-r--r-- 1 root root 1926 Feb 12 21:54 prome-node-exporter.yaml
-rw-r--r-- 1 root root  968 Feb 12 20:37 prome-redis.yaml
-rw-r--r-- 1 root root  574 Feb 12 22:11 prometheus-cm.yaml
-rw-r--r-- 1 root root 2247 Feb 12 22:52 prometheus-deploy.yaml
-rw-r--r-- 1 root root  861 Feb 12 17:30 prometheus-rbac.yaml
-rw-r--r-- 1 root root  451 Feb 12 16:28 prometheus-svc.yaml
[root@master1 prometheus]# kubectl apply -f .
</pre>
</div>
</div>
</li>
<li><a id="h:39cb3abe-3105-4bd2-bfbd-9bd3514a80e7"></a>æ­¥éª¤äº”ã€<br>
<div class="outline-text-6" id="text-h:39cb3abe-3105-4bd2-bfbd-9bd3514a80e7">
<p>
ç°åœ¨é¡µé¢æŸ¥çœ‹è¿˜æ˜¯æœ‰é—®é¢˜çš„
</p>



<figure id="orge180834">
<img src="./images/img_20240604_211831.png" alt="img_20240604_211831.png" width="50%">

</figure>


<p>
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ kubernetes-nodes è¿™ä¸ª job ä»»åŠ¡å·²ç»è‡ªåŠ¨å‘ç°äº†æˆ‘ä»¬5ä¸ª node èŠ‚ç‚¹ï¼Œä½†æ˜¯åœ¨è·å–æ•°æ®çš„æ—¶å€™å¤±è´¥äº†ï¼Œå‡ºç°äº†ç±»ä¼¼äºä¸‹é¢çš„é”™è¯¯ä¿¡æ¯ï¼š
</p>

<div class="org-src-container">
<pre class="src src-shell">server returned HTTP status 400 Bad Request
</pre>
</div>

<p>
è¿™ä¸ªæ˜¯å› ä¸º prometheus å»å‘ç° Node æ¨¡å¼çš„æœåŠ¡çš„æ—¶å€™ï¼Œè®¿é—®çš„ç«¯å£é»˜è®¤æ˜¯10250ï¼Œè€Œé»˜è®¤æ˜¯éœ€è¦è®¤è¯çš„ https åè®®æ‰æœ‰æƒè®¿é—®çš„ï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬å¹¶ä¸æ˜¯å¸Œæœ›è®©å»è®¿é—®10250ç«¯å£çš„ /metrics æ¥å£ï¼Œè€Œæ˜¯ node-exporter ç»‘å®šåˆ°èŠ‚ç‚¹çš„ 9100 ç«¯å£ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥å°†è¿™é‡Œçš„ 10250 æ›¿æ¢æˆ 9100ï¼Œä½†æ˜¯åº”è¯¥æ€æ ·æ›¿æ¢å‘¢ï¼Ÿ
</p>

<p>
è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨åˆ° Prometheus æä¾›çš„ relabel_configs ä¸­çš„ replace èƒ½åŠ›äº†ï¼Œrelabel å¯ä»¥åœ¨ Prometheus é‡‡é›†æ•°æ®ä¹‹å‰ï¼Œé€šè¿‡ Target å®ä¾‹çš„ Metadata ä¿¡æ¯ï¼ŒåŠ¨æ€é‡æ–°å†™å…¥ Label çš„å€¼ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜èƒ½æ ¹æ® Target å®ä¾‹çš„ Metadata ä¿¡æ¯é€‰æ‹©æ˜¯å¦é‡‡é›†æˆ–è€…å¿½ç•¥è¯¥ Target å®ä¾‹ã€‚æ¯”å¦‚æˆ‘ä»¬è¿™é‡Œå°±å¯ä»¥å»åŒ¹é… <code>__address__</code>  è¿™ä¸ª Label æ ‡ç­¾ï¼Œç„¶åæ›¿æ¢æ‰å…¶ä¸­çš„ç«¯å£ï¼Œå¦‚æœä½ ä¸çŸ¥é“æœ‰å“ªäº› Label æ ‡ç­¾å¯ä»¥æ“ä½œçš„è¯ï¼Œå¯ä»¥å°†é¼ æ ‡ğŸ’ç§»åŠ¨åˆ° Targets çš„æ ‡ç­¾åŒºåŸŸï¼Œå…¶ä¸­æ˜¾ç¤ºçš„ Before relabeling åŒºåŸŸéƒ½æ˜¯æˆ‘ä»¬å¯ä»¥æ“ä½œçš„æ ‡ç­¾ï¼š
</p>


<figure id="org54d5f94">
<img src="./images/img_20240604_211948.png" alt="img_20240604_211948.png" width="50%">

</figure>


<p>
ç°åœ¨æˆ‘ä»¬æ¥æ›¿æ¢æ‰ç«¯å£ï¼Œä¿®æ”¹ ConfigMapï¼šï¼ˆæ­¤å¤„å¿½ç•¥ï¼Œç”¨ä¸‹é¢çš„æœ€ç»ˆç‰ˆæœ¬ï¼‰
</p>

<div class="org-src-container">
<pre class="src src-yaml">- job_name: 'kubernetes-nodes'
  kubernetes_sd_configs:
  - role: node
  relabel_configs:
  - source_labels: [__address__]
    regex: '(.*):10250'
    replacement: '${1}:9100'
    target_label: __address__
    action: replace
</pre>
</div>

<p>
è¿™é‡Œå°±æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œå»åŒ¹é… <code>__address__</code> è¿™ä¸ªæ ‡ç­¾ï¼Œç„¶åå°† host éƒ¨åˆ†ä¿ç•™ä¸‹æ¥ï¼Œport æ›¿æ¢æˆäº† 9100ï¼Œç°åœ¨æˆ‘ä»¬é‡æ–°æ›´æ–°é…ç½®æ–‡ä»¶ï¼Œæ‰§è¡Œ reload æ“ä½œï¼Œç„¶åå†å»çœ‹ Prometheus çš„ Dashboard çš„ Targets è·¯å¾„ä¸‹é¢ kubernetes-nodes è¿™ä¸ª job ä»»åŠ¡æ˜¯å¦æ­£å¸¸äº†ï¼š
</p>


<figure id="orgaf7fc6b">
<img src="./images/img_20240604_212022.png" alt="img_20240604_212022.png" width="50%">

</figure>


<p>
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç°åœ¨å·²ç»æ­£å¸¸äº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯æˆ‘ä»¬é‡‡é›†çš„æŒ‡æ ‡æ•°æ® Label æ ‡ç­¾å°±åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„ hostnameï¼Œè¿™å¯¹äºæˆ‘ä»¬åœ¨è¿›è¡Œç›‘æ§åˆ†ç»„åˆ†ç±»æŸ¥è¯¢çš„æ—¶å€™å¸¦æ¥äº†å¾ˆå¤šä¸æ–¹ä¾¿çš„åœ°æ–¹ï¼Œè¦æ˜¯æˆ‘ä»¬èƒ½å¤Ÿå°†é›†ç¾¤ä¸­ Node èŠ‚ç‚¹çš„ Label æ ‡ç­¾ä¹Ÿèƒ½è·å–åˆ°å°±å¾ˆå¥½äº†ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ labelmap è¿™ä¸ªå±æ€§æ¥å°† Kubernetes çš„ Label æ ‡ç­¾æ·»åŠ ä¸º Prometheus çš„æŒ‡æ ‡æ•°æ®çš„æ ‡ç­¾ï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">- job_name: 'kubernetes-nodes'
  kubernetes_sd_configs:
  - role: node
  relabel_configs:
  - source_labels: [__address__]
    regex: '(.*):10250'
    replacement: '${1}:9100'
    target_label: __address__
    action: replace
  - action: labelmap # è¿™ä¸ª
    regex: __meta_kubernetes_node_label_(.+)
# çƒ­æ›´æ–°ï¼Œipæ˜¯prometheusPodçš„Ip
[root@master1 ~]# curl -X POST "http://10.244.1.139:9090/-/reload"
</pre>
</div>

<p>
å¦å¤–ç”±äº kubelet ä¹Ÿè‡ªå¸¦äº†ä¸€äº›ç›‘æ§æŒ‡æ ‡æ•°æ®ï¼Œå°±ä¸Šé¢æˆ‘ä»¬æåˆ°çš„ 10250 ç«¯å£ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä¹ŸæŠŠ kubelet çš„ç›‘æ§ä»»åŠ¡ä¹Ÿä¸€å¹¶é…ç½®ä¸Šï¼š
</p>

<div class="org-src-container">
<pre class="src src-yaml">- job_name: 'kubernetes-kubelet'
  kubernetes_sd_configs:
  - role: node
  scheme: https
  tls_config:
    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    insecure_skip_verify: true
  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
  relabel_configs:
  - action: labelmap
    regex: __meta_kubernetes_node_label_(.+)
</pre>
</div>

<p>
ä½†æ˜¯è¿™é‡Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯è¿™é‡Œå¿…é¡»ä½¿ç”¨ https åè®®è®¿é—®ï¼Œè¿™æ ·å°±å¿…ç„¶éœ€è¦æä¾›è¯ä¹¦ï¼Œæˆ‘ä»¬è¿™é‡Œæ˜¯é€šè¿‡é…ç½® <code>insecure_skip_verify: true</code> æ¥è·³è¿‡äº†è¯ä¹¦æ ¡éªŒï¼Œä½†æ˜¯é™¤æ­¤ä¹‹å¤–ï¼Œè¦è®¿é—®é›†ç¾¤çš„èµ„æºï¼Œè¿˜å¿…é¡»è¦æœ‰å¯¹åº”çš„æƒé™æ‰å¯ä»¥ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”çš„ ServiceAccount æ£’çš„ æƒé™å…è®¸æ‰å¯ä»¥ï¼Œæˆ‘ä»¬è¿™é‡Œéƒ¨ç½²çš„ prometheus å…³è”çš„ ServiceAccount å¯¹è±¡å‰é¢æˆ‘ä»¬å·²ç»æåˆ°è¿‡äº†ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦å°† Pod ä¸­è‡ªåŠ¨æ³¨å…¥çš„ /var/run/secrets/kubernetes.io/serviceaccount/ca.crt å’Œ /var/run/secrets/kubernetes.io/serviceaccount/token æ–‡ä»¶é…ç½®ä¸Šï¼Œå°±å¯ä»¥è·å–åˆ°å¯¹åº”çš„æƒé™äº†ã€‚
</p>

<p>
ç°åœ¨æˆ‘ä»¬å†å»æ›´æ–°ä¸‹é…ç½®æ–‡ä»¶ï¼Œæ‰§è¡Œ reload æ“ä½œï¼Œè®©é…ç½®ç”Ÿæ•ˆï¼Œç„¶åè®¿é—® Prometheus çš„ Dashboard æŸ¥çœ‹ Targets è·¯å¾„ï¼š
</p>

<div class="org-src-container">
<pre class="src src-shell">&#21040;&#36825;&#37324;&#25105;&#20204;&#23601;&#25226; Kubernetes &#38598;&#32676;&#33410;&#28857;&#20351;&#29992; Prometheus &#30417;&#25511;&#36215;&#26469;&#20102;&#65292;&#25509;&#19979;&#26469;&#25105;&#20204;&#20877;&#26469;&#21644;&#22823;&#23478;&#23398;&#20064;&#19979;&#24590;&#26679;&#30417;&#25511; Pod &#25110;&#32773; Service &#20043;&#31867;&#30340;&#36164;&#28304;&#23545;&#35937;&#12290;
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/port: <span style="color: #8b2252;">"9153"</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">metrics &#25509;&#21475;&#30340;&#31471;&#21475;
</span>    prometheus.io/scrape: <span style="color: #8b2252;">"true"</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#20010;&#27880;&#35299;&#21487;&#20197;&#35753;prometheus&#33258;&#21160;&#21457;&#29616;</span>
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:fc8ffc1c-6be6-42c8-a913-7d90faa39159" class="outline-3">
<h3 id="h:fc8ffc1c-6be6-42c8-a913-7d90faa39159">äº‘åŸç”Ÿåº”ç”¨ç›‘æ§</h3>
<div class="outline-text-3" id="text-h:fc8ffc1c-6be6-42c8-a913-7d90faa39159">
</div>
<div id="outline-container-h:1845e9ab-2afc-427f-ada3-0bab058a0f67" class="outline-4">
<h4 id="h:1845e9ab-2afc-427f-ada3-0bab058a0f67">etcd é›†ç¾¤ç›‘æ§</h4>
<div class="outline-text-4" id="text-h:1845e9ab-2afc-427f-ada3-0bab058a0f67">
</div>
<div id="outline-container-h:c0c08f71-192f-4fa7-8525-4f811bfa25c3" class="outline-5">
<h5 id="h:c0c08f71-192f-4fa7-8525-4f811bfa25c3">æŸ¥çœ‹æ¥å£ä¿¡æ¯</h5>
<div class="outline-text-5" id="text-h:c0c08f71-192f-4fa7-8525-4f811bfa25c3">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">curl --cert /etc/etcd/ssl/etcd.pem --key /etc/etcd/ssl/etcd-key.pem  https://192.168.1.201:2379/metrics -k 
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#26679;&#20063;&#34892;
</span>curl -L http://localhost:2379/metrics
</pre>
</div>

<p>
kubeadmin å®‰è£…çš„ etcd é…ç½®å¯èƒ½åœ¨ /etc/kubernetes/manifests/etcd.yml ä¸­
</p>
</div>
</div>
<div id="outline-container-h:5f9b62ab-2d47-429b-a7b0-b6c27d528a85" class="outline-5">
<h5 id="h:5f9b62ab-2d47-429b-a7b0-b6c27d528a85">åˆ›å»º etcd serviceå’ŒEndpoints</h5>
<div class="outline-text-5" id="text-h:5f9b62ab-2d47-429b-a7b0-b6c27d528a85">
<p>
svc å’Œ endpoint åç§°ä¸€æ ·å°±ä¼šè‡ªåŠ¨åˆ›å»ºè”æ¥
</p>
<div class="org-src-container">
<pre class="src src-yaml"># åˆ›å»ºepå’Œsvcä»£ç†å¤–éƒ¨çš„etcdæœåŠ¡ï¼Œå…¶ä»–è‡ªå¸¦metricsæ¥å£çš„æœåŠ¡ä¹Ÿæ˜¯å¦‚æ­¤ï¼
apiVersion: v1
kind: Endpoints
metadata:
  labels:
    app: etcd-k8s
  name: etcd-k8s
  namespace: kube-system
subsets:
- addresses:     # etcdèŠ‚ç‚¹å¯¹åº”çš„ä¸»æœºipï¼Œæœ‰å‡ å°å°±å†™å‡ å°
  - ip: 192.168.1.201
  - ip: 192.168.1.202
  - ip: 192.168.1.203
  ports:
  - name: etcd-port
    port: 2379   # etcdç«¯å£
    protocol: TCP
---
apiVersion: v1
kind: Service 
metadata:
  labels:
    app: etcd-k8s
  name: etcd-k8s
  namespace: kube-system
spec:
  ports:
  - name: etcd-port
    port: 2379
    protocol: TCP
    targetPort: 2379
  type: ClusterIP
</pre>
</div>
</div>
</div>
<div id="outline-container-h:14c3ac8c-aa13-4549-a062-119915c60a3e" class="outline-5">
<h5 id="h:14c3ac8c-aa13-4549-a062-119915c60a3e">æµ‹è¯•æ˜¯å¦ä»£ç†æˆåŠŸ</h5>
<div class="outline-text-5" id="text-h:14c3ac8c-aa13-4549-a062-119915c60a3e">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20877;&#27425;curl&#65292;&#25226;IP&#25442;&#25104;svc&#30340;IP&#27979;&#35797;&#65292;&#36755;&#20986;&#30456;&#21516;&#20869;&#23481;&#21363;&#21019;&#24314;&#25104;&#21151;
</span>[root@k8s-master01 ~]# kubectl get svc -n kube-system etcd-k8s
NAME      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
etcd-ep   ClusterIP   10.103.53.103   &lt;none&gt;        2379/TCP   8m54s

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20877;&#27425;&#35831;&#27714;&#25509;&#21475;
</span>[root@k8s-master01 ~]# curl --cert /etc/etcd/ssl/etcd.pem --key /etc/etcd/ssl/etcd-key.pem  https://10.111.200.116:2379/metrics -k
</pre>
</div>
</div>
</div>
<div id="outline-container-h:84da2901-dd99-404d-9d44-f7c859d55e47" class="outline-5">
<h5 id="h:84da2901-dd99-404d-9d44-f7c859d55e47">åˆ›å»º secret</h5>
<div class="outline-text-5" id="text-h:84da2901-dd99-404d-9d44-f7c859d55e47">
<p>
etcd çš„è¯ä¹¦è¦æŒ‚è½½åˆ° prometheus pod ä¸­
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">1&#12289;&#36825;&#37324;&#25105;&#20204;k8s-master01&#33410;&#28857;&#36827;&#34892;&#21019;&#24314;,ca&#20026;k8sca&#35777;&#20070;&#65292;&#21097;&#19979;2&#20010;&#20026;etcd&#35777;&#20070;&#65292;&#36825;&#26159;&#25105;&#35777;&#20070;&#25152;&#22312;&#20301;&#32622;
</span>  cert-file: <span style="color: #8b2252;">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  key-file: <span style="color: #8b2252;">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  trusted-ca-file: <span style="color: #8b2252;">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">2&#12289;&#25509;&#19979;&#26469;&#25105;&#20204;&#38656;&#35201;&#21019;&#24314;&#19968;&#20010;secret&#65292;&#35753;prometheus pod&#33410;&#28857;&#25346;&#36733;
</span>kubectl create secret generic etcd-ssl --from-file=/etc/kubernetes/pki/etcd/etcd-ca.pem --from-file=/etc/kubernetes/pki/etcd/etcd.pem --from-file=/etc/kubernetes/pki/etcd/etcd-key.pem -n monitoring

<span style="color: #b22222;"># </span><span style="color: #b22222;">3&#12289;&#21019;&#24314;&#23436;&#25104;&#21518;&#21487;&#20197;&#26816;&#26597;&#19968;&#19979;
</span>[root@k8s-master01 prometheus-down]# kubectl describe secrets -n monitoring etcd-ssl
Name:         etcd-ssl
Namespace:    monitoring
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Type:  Opaque

Data
====
etcd-ca.pem:   1367 bytes
etcd-key.pem:  1679 bytes
etcd.pem:      1509 bytes
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4788ce90-2fea-4c2a-b404-0c27734a6240" class="outline-5">
<h5 id="h:4788ce90-2fea-4c2a-b404-0c27734a6240">ç¼–è¾‘prometheusï¼ŒæŠŠè¯ä¹¦æŒ‚è½½è¿›å»</h5>
<div class="outline-text-5" id="text-h:4788ce90-2fea-4c2a-b404-0c27734a6240">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">1&#12289;&#36890;&#36807;edit&#30452;&#25509;&#32534;&#36753;prometheus
</span>[root@k8s-master01 ~]# kubectl edit prometheus k8s -n monitoring
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;replicas&#24213;&#19979;&#21152;&#19978;secret&#21517;&#31216;
</span>replicas:2
secrets:
- etcd-ssl <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;secret&#21517;&#31216;
</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36827;&#20837;&#23481;&#22120;&#26597;&#30475;&#65292;&#23601;&#21487;&#20197;&#30475;&#21040;&#35777;&#20070;&#25346;&#36733;&#36827;&#21435;&#20102;
</span>[root@k8s-master01 prometheus-down]# kubectl exec -it -n monitoring prometheus-k8s-0 /bin/sh

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#25991;&#20214;&#26159;&#21542;&#23384;&#22312;
</span>/prometheus $ ls /etc/prometheus/secrets/etcd-ssl/
etcd-ca.pem   etcd-key.pem  etcd.pem
</pre>
</div>
</div>
</div>
<div id="outline-container-h:15abf503-dbfa-4094-9057-35e9385a5e7a" class="outline-5">
<h5 id="h:15abf503-dbfa-4094-9057-35e9385a5e7a">åˆ›å»ºServiceMonitor</h5>
<div class="outline-text-5" id="text-h:15abf503-dbfa-4094-9057-35e9385a5e7a">
<div class="org-src-container">
<pre class="src src-yaml">[root@k8s-master01 ~]# cat etcd-servicemonitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: etcd-k8s
  namespace: monitoring
  labels:
    app: etcd-k8s
spec:
  jobLabel: app
  endpoints:
    - interval: 30s
      port: etcd-port  # è¿™ä¸ªportå¯¹åº” Service.spec.ports.name
      scheme: https
      tlsConfig:
        caFile: /etc/prometheus/secrets/etcd-ssl/etcd-ca.pem #è¯ä¹¦è·¯å¾„ (åœ¨prometheus podé‡Œè·¯å¾„)
        certFile: /etc/prometheus/secrets/etcd-ssl/etcd.pem
        keyFile: /etc/prometheus/secrets/etcd-ssl/etcd-key.pem
        insecureSkipVerify: true  # å…³é—­è¯ä¹¦æ ¡éªŒ
  selector:
    matchLabels:
      app: etcd-k8s  # è·Ÿscvçš„lablesä¿æŒä¸€è‡´
  namespaceSelector:
    matchNames:
    - kube-system    # è·Ÿsvcæ‰€åœ¨namespaceä¿æŒä¸€è‡´
# åŒ¹é…Kube-systemè¿™ä¸ªå‘½åç©ºé—´ä¸‹é¢å…·æœ‰app=etcd-k8sè¿™ä¸ªlabelæ ‡ç­¾çš„Serveï¼Œjob labelç”¨äºæ£€ç´¢jobä»»åŠ¡åç§°çš„æ ‡ç­¾ã€‚ç”±äºè¯ä¹¦serverNameå’Œetcdä¸­ç­¾å‘çš„è¯ä¹¦å¯èƒ½ä¸åŒ¹é…ï¼Œæ‰€ä»¥æ·»åŠ äº†insecureSkipVerify=trueå°†ä¸å†å¯¹æœåŠ¡ç«¯çš„è¯ä¹¦è¿›è¡Œæ ¡éªŒ
</pre>
</div>
</div>
</div>
<div id="outline-container-h:15fa1748-a7c3-4e48-a1e2-c46d6a4e57a6" class="outline-5">
<h5 id="h:15fa1748-a7c3-4e48-a1e2-c46d6a4e57a6">prometheus ui é¡µé¢æŸ¥çœ‹ä¸‰ä¸ªetcdèŠ‚ç‚¹éƒ½è·å–åˆ°æ•°æ®</h5>
<div class="outline-text-5" id="text-h:15fa1748-a7c3-4e48-a1e2-c46d6a4e57a6">
<p>
æŸ¥çœ‹ targets  çŠ¶æ€ï¼Œæ­¤å¤„æ•°æ®è·å–æœ‰ç‚¹æ…¢ï¼Œéœ€è¦ç­‰å¾…ä¸€ä¸‹
</p>
</div>
</div>
<div id="outline-container-h:fc1d3ce1-8f7a-4d7c-bc1a-70e02c579cee" class="outline-5">
<h5 id="h:fc1d3ce1-8f7a-4d7c-bc1a-70e02c579cee">grafanaæ¨¡æ¿å¯¼å…¥</h5>
<div class="outline-text-5" id="text-h:fc1d3ce1-8f7a-4d7c-bc1a-70e02c579cee">
<p>
æ•°æ®é‡‡é›†å®Œæˆåï¼Œæ¥ä¸‹æ¥å¯ä»¥åœ¨grafanaä¸­å¯¼å…¥dashboard
</p>

<ul class="org-ul">
<li>æ‰“å¼€å®˜ç½‘æ¥çš„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç‚¹å‡»ä¸‹è½½JSONæ–‡ä»¶</li>
<li>grafanaå®˜ç½‘ï¼š<a href="https://grafana.com/grafana/dashboards/3070">https://grafana.com/grafana/dashboards/3070</a></li>
<li>ä¸­æ–‡ç‰ˆETCDé›†ç¾¤æ’ä»¶ï¼š<a href="https://grafana.com/grafana/dashboards/9733">https://grafana.com/grafana/dashboards/9733</a></li>
</ul>


<p>
ç‚¹å‡»HOMEâ€“&gt;å¯¼å…¥æ¨¡æ¿
</p>


<figure id="org40c052e">
<img src="./images/img_20240604_212133.png" alt="img_20240604_212133.png" width="50%">

</figure>


<p>
å¯¼å…¥åé¡µé¢å±•ç¤º
</p>


<figure id="orgbf53af7">
<img src="./images/img_20240604_212203.png" alt="img_20240604_212203.png" width="50%">

</figure>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:46de4e55-a657-43e2-b70e-e3005efaccb8" class="outline-2">
<h2 id="h:46de4e55-a657-43e2-b70e-e3005efaccb8">Prometheusç›‘æ§å®æˆ˜</h2>
<div class="outline-text-2" id="text-h:46de4e55-a657-43e2-b70e-e3005efaccb8">
</div>
<div id="outline-container-h:9c2b7226-f947-4758-8182-31c0711d912b" class="outline-3">
<h3 id="h:9c2b7226-f947-4758-8182-31c0711d912b">Promethues é»‘ç›’ç›‘æ§</h3>
<div class="outline-text-3" id="text-h:9c2b7226-f947-4758-8182-31c0711d912b">
<ul class="org-ul">
<li><b>ç™½ç›’ç›‘æ§</b> ï¼šç›‘æ§ä¸€äº›å†…éƒ¨çš„æ•°æ®ï¼Œå¦‚topicçš„ç›‘æ§æ•°æ®ã€Redis keyçš„å¤§å°ã€‚å†…éƒ¨æš´éœ²çš„æŒ‡æ ‡è¢«ç§°ä¸ºç™½ç›’ç›‘æ§ã€‚æ¯”è¾ƒå…³æ³¨çš„æ˜¯åŸå› ã€‚</li>

<li><b>é»‘ç›’ç›‘æ§</b> ï¼šç›‘æ§å…³æ³¨çš„æ˜¯ç°è±¡ï¼Œä¹Ÿå°±æ˜¯æ­£åœ¨å‘ç”Ÿå‘Šè­¦ï¼Œæ˜¯ç«™åœ¨ç”¨æˆ·çš„è§’åº¦çœ‹åˆ°çš„ä¸œè¥¿ã€‚å¦‚ç½‘ç«™ä¸èƒ½æ‰“å¼€ï¼Œç½‘ç«™æ‰“å¼€çš„æ¯”è¾ƒæ…¢ã€‚æ¯”è¾ƒå…³æ³¨ç°è±¡ï¼Œè¡¨ç¤ºæ­£åœ¨å‘ç”Ÿçš„é—®é¢˜ï¼Œæ­£åœ¨å‘ç”Ÿçš„å‘Šè­¦ã€‚</li>
</ul>
</div>
<div id="outline-container-h:42274e08-bb3d-49a5-909d-d4a3d097f3e9" class="outline-4">
<h4 id="h:42274e08-bb3d-49a5-909d-d4a3d097f3e9">éƒ¨ç½²exporter</h4>
<div class="outline-text-4" id="text-h:42274e08-bb3d-49a5-909d-d4a3d097f3e9">
<p>
é»‘ç›’ç›‘æ§å®˜ç½‘ï¼š
  <a href="https://github.com/prometheus/blackbox_exporter">https://github.com/prometheus/blackbox_exporter</a>
</p>


<ul class="org-ul">
<li>grafana  é¢æ¿ï¼š<a href="https://grafana.com/grafana/dashboards/5345">https://grafana.com/grafana/dashboards/5345</a></li>
<li>é…ç½®æ–‡æ¡£ï¼š<a href="https://github.com/prometheus/blackbox_exporter/blob/master/CONFIGURATION.md">https://github.com/prometheus/blackbox_exporter/blob/master/CONFIGURATION.md</a></li>
<li>é…ç½®ç¤ºä¾‹ï¼š<a href="https://github.com/prometheus/blackbox_exporter/blob/master/example.yml">https://github.com/prometheus/blackbox_exporter/blob/master/example.yml</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prom-blackbox-exporter-config
  namespace: monitoring
  labels:
    app: prom-blackbox-exporter
data:
  blackbox-exporter.yaml: |-
    modules:
      http_2xx:
        prober: http
        timeout: 10s
        http:
          valid_http_versions: [<span style="color: #8b2252;">"HTTP/1.1"</span>, <span style="color: #8b2252;">"HTTP/2"</span>]
          <span style="color: #b22222;"># </span><span style="color: #b22222;">[], Defaults to 2xx, 200,301,302,401,404
</span>          valid_status_codes: [200]
          method: GET
          preferred_ip_protocol: <span style="color: #8b2252;">"ip4"</span>
      http_post_2xx:
        prober: http
        http:
          method: POST
      tcp_connect:
        prober: tcp
      pop3s_banner:
        prober: tcp
        tcp:
          query_response:
          - expect: <span style="color: #8b2252;">"^+OK"</span>
          tls: true
          tls_config:
            insecure_skip_verify: false
      ssh_banner:
        prober: tcp
        tcp:
          query_response:
          - expect: <span style="color: #8b2252;">"^SSH-2.0-"</span>
      irc_banner:
        prober: tcp
        tcp:
          query_response:
          - send: <span style="color: #8b2252;">"NICK prober"</span>
          - send: <span style="color: #8b2252;">"USER prober prober prober :prober"</span>
          - expect: <span style="color: #8b2252;">"PING :([^ ]+)"</span>
            send: <span style="color: #8b2252;">"PONG ${1}"</span>
          - expect: <span style="color: #8b2252;">"^:[^ ]+ 001"</span>
      icmp:
        prober: icmp
        timeout: 3s
        icmp:
          preferred_ip_protocol: <span style="color: #8b2252;">"ip4"</span>
---
apiVersion: v1
kind: Service
metadata:
  name: prom-blackbox-exporter
  namespace: monitoring
  annotations:
    prometheus.io/scrape: <span style="color: #8b2252;">"true"</span>
  labels:
    app: prom-blackbox-exporter
spec:
  selector:
    app: prom-blackbox-exporter
  ports:
    - name: tcp-9115
      protocol: TCP
      port: 9115
      targetPort: 9115
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prom-blackbox-exporter
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prom-blackbox-exporter
  template:
    metadata:
      labels:
        app: prom-blackbox-exporter
    spec:
      nodeSelector:
        <span style="color: #483d8b;">type</span>: ops-prod-prometheus
      containers:
      - name: blackbox-exporter
        image: prom/blackbox-exporter:v0.22.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9115
        args:
        - --config.file=/etc/blackbox_exporter/config.yaml
        - --log.level=info
        - --web.listen-address=:9115
        readinessProbe:
          tcpSocket:
            port: 9115
          initialDelaySeconds: 5
          timeoutSeconds: 5
        resources:
          limits:
            cpu: 200m
            memory: 128Mi
          requests:
            cpu: 10m
            memory: 20Mi
        volumeMounts:
        - mountPath: /etc/blackbox_exporter
          name: config
          readOnly: true
      - args:
        - --webhook-url=http://localhost:9115/-/reload
        - --volume-dir=/etc/blackbox_exporter/
        image: jimmidyson/configmap-reload:v0.5.0
        name: module-configmap-reloader
        resources:
          limits:
            cpu: 20m
            memory: 40Mi
          requests:
            cpu: 10m
            memory: 20Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 65534
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /etc/blackbox_exporter/
          name: config
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: prom-blackbox-exporter-config
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1c167782-245a-4c94-9803-5a8d33a4ee23" class="outline-4">
<h4 id="h:1c167782-245a-4c94-9803-5a8d33a4ee23">additional ä¼ ç»Ÿç›‘æ§</h4>
<div class="outline-text-4" id="text-h:1c167782-245a-4c94-9803-5a8d33a4ee23">
<div class="org-src-container">
<pre class="src src-yaml"># æµ‹è¯•exporteræ˜¯å¦æ­£å¸¸
# æŸ¥çœ‹svcçš„IP
[root@k8s-master01 ~]# kubectl get svc -n monitoring  blackbox-exporter
NAME                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE
blackbox-exporter   ClusterIP   10.100.9.18   &lt;none&gt;        9115/TCP   30m

# curlä¸€ä¸‹exporterçš„svc
[root@k8s-master01 ~]# curl "http://10.100.9.18:9115/probe?target=baidu.com&amp;module=http_2xx"
</pre>
</div>
</div>
<div id="outline-container-h:c04d2233-59ea-4a34-b376-55242d22620a" class="outline-5">
<h5 id="h:c04d2233-59ea-4a34-b376-55242d22620a">2.1ã€æ·»åŠ ä¸ªç›‘æ§æµ‹è¯•</h5>
<div class="outline-text-5" id="text-h:c04d2233-59ea-4a34-b376-55242d22620a">
<div class="org-src-container">
<pre class="src src-yaml">[root@k8s-master01 prometheus-down]# vim prometheus-additional.yaml
- job_name: 'blackbox-http'
  scrape_interval: 10s
  scrape_timeout: 5s
  metrics_path: /probe
  params:
    modelue: [http_2xx]
  static_configs:
  - targets:
      - https://ateway-prod.xxx.com/api/getConfig
      - https://front.xxx.com/prod/220512133528/V0.0.1_PRO/hotfix/res/import/00/008c78d7-bb49-46eb-bab5-a6a885ecfe0c.json
    labels:
      product_line: ludo
      severity: info
  relabel_configs:  # label é‡å†™ï¼Œå°†src label çš„å€¼èµ‹å€¼ç»™ target label
  - source_labels: [__address__]
    target_label: __param_target
  - source_labels: [__param_target]
    target_label: instance
  - target_label: __address__
    replacement: prom-blackbox-exporter:9115  #blackbox-exporter æ‰€åœ¨çš„æœºå™¨å’Œç«¯å£
  - source_labels:
    - instance
    regex: https://(gateway-prod.xxx.com|front.xxx.com)([\.\_\-/a-zA-Z0-9]*)?(.*)
    replacement: "${2}"
    target_label: path

# Then you will need to make a secret out of this configuration.
# kubectl create secret generic additional-scrape-configs --from-file=prometheus-additional.yaml --dry-run -oyaml &gt; additional-scrape-configs.yaml

# åˆ›å»ºSecret
# kubectl apply -f  additional-scrape-configs.yaml  -n monitoring 
secret/additional-scrape-configs created

# è¿›åˆ°manifestsç›®å½•ï¼Œç¼–è¾‘
[root@k8s-master01 manifests]# vim prometheus-prometheus.yaml 
apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: prometheus
  labels:
    prometheus: prometheus
spec:
  replicas: 2
... åŠ ä¸Šä¸‹é¢3è¡Œ
  additionalScrapeConfigs:
    name: additional-scrape-configs
    key: prometheus-additional.yaml
...

# replace åˆšåˆšä¿®æ”¹çš„æ–‡ä»¶
[root@k8s-master01 manifests]# kubectl replace -f  prometheus-prometheus.yaml  -n monitoring

# æ‰‹åŠ¨åˆ é™¤ podã€ä½¿ä¹‹é‡æ–°æ„å»º
[root@k8s-master01 manifests]# kubectl delete po  prometheus-k8s-0  prometheus-k8s-1  -n monitoring 
</pre>
</div>

<p>
æŸ¥çœ‹æ˜¯å¦æˆåŠŸåŠ è½½é…ç½®ï¼š
</p>


<p>
æ•°æ®æŸ¥çœ‹ï¼š
</p>

<p>
probe å¼€å¤´
</p>


<figure id="org17d41b5">
<img src="./images/img_20240604_212256.png" alt="img_20240604_212256.png" width="50%">

</figure>
</div>
</div>
</div>
</div>
<div id="outline-container-h:f2e8f400-5040-4d62-86c0-6a8098e2fc8b" class="outline-3">
<h3 id="h:f2e8f400-5040-4d62-86c0-6a8098e2fc8b">Prometheus é™æ€é…ç½®</h3>
<div class="outline-text-3" id="text-h:f2e8f400-5040-4d62-86c0-6a8098e2fc8b">
</div>
<div id="outline-container-h:b67eb122-6ed3-4729-9042-153666b80a3b" class="outline-4">
<h4 id="h:b67eb122-6ed3-4729-9042-153666b80a3b">additionalScrapeConfigs</h4>
<div class="outline-text-4" id="text-h:b67eb122-6ed3-4729-9042-153666b80a3b">
<p>
é¦–å…ˆåˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶ï¼Œç„¶åé€šè¿‡è¯¥æ–‡ä»¶åˆ›å»ºä¸€ä¸ª Secretï¼Œ é‚£ä¹ˆè¿™ä¸ª Secret å³å¯ä½œä¸º Prometheus çš„é™æ€é…ç½®ï¼š
</p>

<div class="org-src-container">
<pre class="src src-shell">touch prometheus-additional.yaml
kubectl create secret generic additional-configs --from-file=prometheus-additional.yaml
</pre>
</div>

<p>
åˆ›å»ºå®Œ Secret åï¼Œéœ€è¦ç¼–è¾‘ä¸‹ Promeheus é…ç½®ï¼š
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#  </span><span style="color: #b22222;">kubectl edit prometheus -n monitoring k8s
</span>apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: k8s
spec:
  replicas: 2
... &#21152;&#19978;&#19979;&#38754;3&#34892;
  additionalScrapeConfigs:
    name: additional-configs
    key: prometheus-additional.yaml
    optional: true
...
</pre>
</div>

<p>
æ·»åŠ ä¸Šè¿°é…ç½®åä¿å­˜é€€å‡ºï¼Œæ— éœ€é‡å¯ Prometheus çš„ Pod å³å¯ç”Ÿæ•ˆã€‚ ä¹‹ååœ¨ prometheus-additional.yaml æ–‡ä»¶å†…ç¼–è¾‘ ä¸€äº›é™æ€é…ç½®ã€‚å¦‚ä¸Šæ–‡çš„é»‘ç›’é…ç½®ã€‚
</p>
</div>
</div>
</div>
<div id="outline-container-h:f17f34a7-46d9-412c-a5c0-f7cc5c9e0fd4" class="outline-3">
<h3 id="h:f17f34a7-46d9-412c-a5c0-f7cc5c9e0fd4">Prometheus ç›‘æ§ Windowsï¼ˆå¤–éƒ¨ï¼‰ä¸»æœº</h3>
<div class="outline-text-3" id="text-h:f17f34a7-46d9-412c-a5c0-f7cc5c9e0fd4">
<p>
å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://github.com/prometheus-community/windows_exporter">https://github.com/prometheus-community/windows_exporter</a>
</p>

<p>
windows exporter ä¼šæš´éœ²ä¸€ä¸ª9182ç«¯å£æ¥æä¾›ç›‘æ§æ•°æ®ã€‚
</p>
</div>
</div>
<div id="outline-container-h:95aac4c8-4613-45cf-a8b7-768cff7c71a0" class="outline-3">
<h3 id="h:95aac4c8-4613-45cf-a8b7-768cff7c71a0">è‡ªåŠ¨å‘ç°æ³¨å†ŒæœåŠ¡</h3>
<div class="outline-text-3" id="text-h:95aac4c8-4613-45cf-a8b7-768cff7c71a0">
</div>
<div id="outline-container-h:84d0c7ae-89d5-415a-be0f-72d719939821" class="outline-4">
<h4 id="h:84d0c7ae-89d5-415a-be0f-72d719939821">æ­£åˆ™è¡¨è¾¾å¼</h4>
<div class="outline-text-4" id="text-h:84d0c7ae-89d5-415a-be0f-72d719939821">
<p>
æ­£åˆ™è¡¨è¾¾å¼-å…ƒå­—ç¬¦ï¼š<a href="https://www.runoob.com/regexp/regexp-metachar.html">https://www.runoob.com/regexp/regexp-metachar.html</a>
</p>

<div class="org-src-container">
<pre class="src src-yaml">- source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]  # 172.16.202.106:53;9153
  separator: ;
  regex: ([^:]+)(?::\d+)?;(\d+)
  target_label: __address__
  replacement: $1:$2
  action: replace
</pre>
</div>

<p>
å…¶ä¸­ (?::\d+) è¡¨ç¤ºåŒ¹é… :[0-9]+ ä½†ä¸è·å–åŒ¹é…ç»“æœï¼Œæ‰€ä»¥ <code>$1:$2</code> å°±ç­‰äº 172.16.202.106:9153
</p>

<p>
å¦‚æœ <code>regex: ([^:]+)(:\d+)?;(\d+)</code> ï¼Œæ›¿æ¢çš„å€¼$1:$2å°±ç­‰äº 172.16.202.106:53
</p>
</div>
</div>
<div id="outline-container-h:41ac00f3-8053-403d-b270-e8eb19bb6e9b" class="outline-4">
<h4 id="h:41ac00f3-8053-403d-b270-e8eb19bb6e9b">å‚æ•°è¯´æ˜</h4>
<div class="outline-text-4" id="text-h:41ac00f3-8053-403d-b270-e8eb19bb6e9b">
<div class="org-src-container">
<pre class="src src-yaml">- job_name: 'node-exporter-discovery'
  kubernetes_sd_configs:
  - role: node
  relabel_configs:
  - separator: ;
    regex: __meta_kubernetes_node_label_(.+)
    replacement: $1
    action: labelmap
  - source_labels: [__address__]
    regex: '(.*):10250'
    replacement: '${1}:9100'
    target_label: __address__
    action: replace
  metric_relabel_configs:
  - source_labels: [ __name__ ]
    regex: (node_namespace_pod_container:container_memory_rss|node_namespace_pod_container:container_memory_working_set_bytes|node_namespace_pod_container:container_memory_cache|node_scrape_collector_duration_seconds|node_scrape_collector_success|node_cpu_core_throttles_total|node_cpu_guest_seconds_total|node_ipvs_backend_connections_active|node_ipvs_backend_weight|node_ipvs_backend_connections_inactive|node_filesystem_device_error|node_cpu_core_throttles_total|node_nfs_requests_total|node_scrape_collector_success|node_scrape_collector_duration_seconds|node_cpu_scaling_frequency_min_hrts|node_cpu_scaling_frequency_hertz|node_cpu_frequency_max_hertz|node_cpu_scaling_frequency_max_hrts|node_cpu_frequency_min_hertz)
    action: drop

- job_name: 'prometheus-k8s'
  scrape_interval: 60s
  scrape_timeout: 10s
  honor_labels: true
  metrics_path: '/k8s/federate'
  params:
    'match[]':
      - '{job="node-exporter"}'
      - '{job=~"kube-.*"}'
  static_configs:
    - targets:
      - 'prometheus.xxx.com'


- consul_sd_configs:
  - server: consul-server.consul:8500
  job_name: consul-exporter
  relabel_configs:
  - action: replace
    source_labels:
    - __meta_consul_service_metadata_Application
    target_label: application
  - action: replace
    source_labels:
    - __meta_consul_service_metadata_Environment
    target_label: environment
  - action: replace
    source_labels:
    - __meta_consul_service_metadata_SubModule
    target_label: subModule
  - action: replace
    source_labels:
    - __meta_consul_service_metadata_Usage
    target_label: usage
  - action: replace
    source_labels:
    - __meta_consul_service_metadata_instanceID
    target_label: instanceID
</pre>
</div>

<p>
å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config</a>
</p>

<p>
<a href="https://cloud.tencent.com/document/product/1416/55995">https://cloud.tencent.com/document/product/1416/55995</a>
</p>

<ul class="org-ul">
<li>honor_timestampsï¼šæ˜¯å¦ä»¥ target ä¸ŠæŠ¥æ—¶é—´ä¸ºå‡†ï¼Œé»˜è®¤ä¸º trueã€‚</li>
</ul>
</div>
</div>
<div id="outline-container-h:f937880c-b862-4afe-92a1-74b926a9ddae" class="outline-4">
<h4 id="h:f937880c-b862-4afe-92a1-74b926a9ddae">è‡ªåŠ¨å‘ç° node-export å’Œ kubelet</h4>
<div class="outline-text-4" id="text-h:f937880c-b862-4afe-92a1-74b926a9ddae">
<div class="org-src-container">
<pre class="src src-yaml">- job_name: node-exporter
  honor_timestamps: true
  scrape_interval: 15s
  scrape_timeout: 10s
  metrics_path: /metrics
  scheme: http
  follow_redirects: true
  kubernetes_sd_configs:
  - role: node
    kubeconfig_file: ""
    follow_redirects: true
  relabel_configs:
  - source_labels: [__address__] # node çš„ __address__  æ˜¯èŠ‚ç‚¹ip:10250
    separator: ;
    regex: (.*):10250
    target_label: __address__
    replacement: $1:9100
    action: replace

- job_name: kubernetes-kubelet
  kubernetes_sd_configs:
  - role: node
  relabel_configs:
  - separator: ;
    regex: __meta_kubernetes_node_label_(.+)
    replacement: $1
    action: labelmap
  - separator: ;
    regex: '(.*):10250'
    target_label: __address__
    replacement: '${1}:10250'
    action: replace
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cd1b702f-c009-48f5-9e12-0eb041f8a746" class="outline-4">
<h4 id="h:cd1b702f-c009-48f5-9e12-0eb041f8a746">å¿…è¦çš„æ­¥éª¤</h4>
<div class="outline-text-4" id="text-h:cd1b702f-c009-48f5-9e12-0eb041f8a746">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">deploymnet &#20013; pod &#26631;&#31614;
</span>spec:
  template:
    metadata:
      annotations:
        prometheus.io/pathjvm: /actuator/prometheus
        prometheus.io/portjvm: <span style="color: #8b2252;">"8099"</span>
        prometheus.io/scrapejvm: <span style="color: #8b2252;">"true"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">prometheus &#37197;&#32622;
</span>      - source_labels: [__meta_kubernetes_pod_container_name]
        regex: <span style="color: #8b2252;">"filebeat.*"</span>
        action: drop   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21435;&#25481;&#19981;&#38656;&#35201;&#23481;&#22120;
</span>      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrapejvm]
        action: keep
        regex: true  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25214;&#21040; prometheus.io/scrapejvm: "true" &#30340; pod
</span>      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_pathjvm]
        action: replace
        target_label: __metrics_path__
        regex: (.+)    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25214;&#21040; prometheus.io/pathjvm: /actuator/prometheus &#30340;&#36335;&#24452;&#20316;&#20026; metrics
</span>      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_portjvm]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $<span style="color: #a0522d;">1</span>:$<span style="color: #a0522d;">2</span>
        target_label: __address__  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25214;&#21040; prometheus.io/portjvm: "8099" &#25152;&#35774;&#32622;&#30340;&#31471;&#21475;&#65292;&#25340;&#25509;&#21040; __address__
</span>      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+) <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#23558; pod &#30340;&#26631;&#31614;&#26144;&#23556;&#21040; metrcis &#20013;</span>
</pre>
</div>

<ul class="org-ul">
<li>å¯¹åº”èµ„æºï¼ˆService, Pod, Ingress ç­‰ï¼‰æ·»åŠ æ³¨é‡Šä¿¡æ¯ï¼ŒæŒ‡å®šæš´éœ²çš„å‚æ•°</li>
<li>prometheus é…ç½®æ–‡ä»¶æ·»åŠ è‡ªåŠ¨å‘ç°é…ç½®ï¼ŒåŒ¹é…èµ„æºæš´éœ²çš„å‚æ•°ï¼Œå¿…è¦çš„å‚æ•°æœ‰
<ul class="org-ul">
<li>æœåŠ¡å‘ç°ç±»å‹ï¼šå¦‚ kubernetes_sd_configã€consul_sd_config ç­‰</li>
<li>å¯é€‰ï¼ŒåŒ¹é…èµ„æºæ ‡ç­¾å¹¶ä¿ç•™ä¸‹æ¥ï¼Œå¦‚ pod æ ‡ç­¾ä¸º  prometheus.io/scrapejvm: "true"</li>
<li><code>__address__</code> è¯·æ±‚åœ°å€</li>
<li><code>__metrics_path__</code>  è¯·æ±‚çš„ metrics è·¯å¾„</li>
</ul></li>
</ul>

<p>
å¯ä»¥ä» prometheus ui ä¸­ service-discovery æŸ¥çœ‹è‡ªå¸¦çš„æ ‡ç­¾
</p>
</div>
</div>
</div>
</section>
<section id="outline-container-h:507e3211-f74e-4ea6-b827-0ac08b91e0d2" class="outline-2">
<h2 id="h:507e3211-f74e-4ea6-b827-0ac08b91e0d2">Prometheus è¯­æ³• PromQL</h2>
<div class="outline-text-2" id="text-h:507e3211-f74e-4ea6-b827-0ac08b91e0d2">
</div>
<div id="outline-container-h:ebe9dbb3-a7b8-4d78-be1f-e2a7786ee7c1" class="outline-3">
<h3 id="h:ebe9dbb3-a7b8-4d78-be1f-e2a7786ee7c1">PromQL è¯­æ³•ä½“éªŒ</h3>
<div class="outline-text-3" id="text-h:ebe9dbb3-a7b8-4d78-be1f-e2a7786ee7c1">
<p>
PromQL Web UI çš„ Graph é€‰é¡¹å¡æä¾›äº†ç®€å•çš„ç”¨äºæŸ¥è¯¢æ•°æ®çš„å…¥å£ï¼Œå¯¹äº PromQL çš„ç¼–å†™å’Œæ ¡éªŒéƒ½å¯ä»¥åœ¨æ­¤ä½ç½®ã€‚
</p>
</div>
<div id="outline-container-h:0a32ef10-305d-476f-a729-605db7808c75" class="outline-4">
<h4 id="h:0a32ef10-305d-476f-a729-605db7808c75">Prometheus Metricsç±»å‹</h4>
<div class="outline-text-4" id="text-h:0a32ef10-305d-476f-a729-605db7808c75">
<p>
Prometheus çš„å®¢æˆ·ç«¯åº“ä¸­æä¾›äº†å››ç§æ ¸å¿ƒçš„æŒ‡æ ‡ç±»å‹ã€‚ä½†è¿™äº›ç±»å‹åªæ˜¯åœ¨å®¢æˆ·ç«¯åº“ï¼ˆå®¢æˆ·ç«¯å¯ä»¥æ ¹æ®ä¸åŒçš„æ•°æ®ç±»å‹è°ƒç”¨ä¸åŒçš„ API æ¥å£ï¼‰å’Œåœ¨çº¿åè®®ä¸­ï¼Œå®é™…åœ¨ Prometheus server ä¸­å¹¶ä¸å¯¹æŒ‡æ ‡ç±»å‹è¿›è¡ŒåŒºåˆ†ï¼Œè€Œæ˜¯ç®€å•åœ°æŠŠè¿™äº›æŒ‡æ ‡ç»Ÿä¸€è§†ä¸ºæ— ç±»å‹çš„æ—¶é—´åºåˆ—
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">summary&#31867;&#22411;
</span>[root@ip-172-21-39-120 prometheus]# curl -s 172.21.39.111:9090/111/metrics |grep go_gc_duration_seconds -C5
<span style="color: #b22222;"># </span><span style="color: #b22222;">HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">TYPE go_gc_duration_seconds summary
</span>go_gc_duration_seconds{<span style="color: #a0522d;">quantile</span>=<span style="color: #8b2252;">"0"</span>} 1.421e-05
go_gc_duration_seconds{<span style="color: #a0522d;">quantile</span>=<span style="color: #8b2252;">"0.25"</span>} 5.5171e-05
go_gc_duration_seconds{<span style="color: #a0522d;">quantile</span>=<span style="color: #8b2252;">"0.5"</span>} 6.2903e-05
go_gc_duration_seconds{<span style="color: #a0522d;">quantile</span>=<span style="color: #8b2252;">"0.75"</span>} 8.665e-05
go_gc_duration_seconds{<span style="color: #a0522d;">quantile</span>=<span style="color: #8b2252;">"1"</span>} 0.004545852
go_gc_duration_seconds_sum 88.949090905
go_gc_duration_seconds_count 1.062595e+06
</pre>
</div>
<p>
HELPï¼šè¯´æ˜
TYPEï¼šmetricsç±»å‹
å¦‚æœå­˜å‚¨åˆ°æ•°æ®ä¸­ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
alertmanager_alerts_invalid_total{version="v1"}@139383232  0
</p>
</div>
</div>
<div id="outline-container-h:d4eb1955-8361-4bd7-a250-105aae0cefee" class="outline-4">
<h4 id="h:d4eb1955-8361-4bd7-a250-105aae0cefee">MetricsæŒ‡æ ‡ç±»å‹</h4>
<div class="outline-text-4" id="text-h:d4eb1955-8361-4bd7-a250-105aae0cefee">
</div>
<div id="outline-container-h:3157d636-3133-47e3-9745-e5c844aa2c8d" class="outline-5">
<h5 id="h:3157d636-3133-47e3-9745-e5c844aa2c8d">Counter ï¼ˆè®¡æ•°å™¨ï¼‰</h5>
<div class="outline-text-5" id="text-h:3157d636-3133-47e3-9745-e5c844aa2c8d">
<p>
<b>Counter ç±»å‹ä»£è¡¨ä¸€ç§æ ·æœ¬æ•°æ®å•è°ƒé€’å¢çš„æŒ‡æ ‡ï¼Œå³åªå¢ä¸å‡ï¼Œé™¤éç›‘æ§ç³»ç»Ÿå‘ç”Ÿäº†é‡ç½®</b>
</p>

<p>
ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ counter ç±»å‹çš„æŒ‡æ ‡æ¥è¡¨ç¤º**æœåŠ¡çš„è¯·æ±‚æ•°ã€å·²å®Œæˆçš„ä»»åŠ¡æ•°ã€é”™è¯¯å‘ç”Ÿçš„æ¬¡æ•°ç­‰ã€‚counter ä¸»è¦æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š
</p>

<div class="org-src-container">
<pre class="src src-shell">//&#23558;counter&#20540;&#21152;1.
<span style="color: #0000ff;">Inc</span>()

// &#23558;&#25351;&#23450;&#20540;&#21152;&#21040;counter&#20540;&#19978;&#65292;&#22914;&#26524;&#25351;&#23450;&#20540;&lt;0 &#20250;panic.
<span style="color: #0000ff;">Add</span>(float64)
</pre>
</div>

<p>
Counter ç±»å‹æ•°æ®å¯ä»¥è®©ç”¨æˆ·æ–¹ä¾¿çš„äº†è§£äº‹ä»¶äº§ç”Ÿçš„é€Ÿç‡çš„å˜åŒ–ï¼Œåœ¨ PromQL å†…ç½®çš„ç›¸å…³æ“ä½œå‡½æ•°å¯ä»¥æä¾›ç›¸åº”çš„åˆ†æï¼Œæ¯”å¦‚ä»¥ HTTP åº”ç”¨è¯·æ±‚é‡æ¥è¿›è¡Œè¯´æ˜ï¼š
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">//&#36890;&#36807;rate</span>()&#20989;&#25968;&#33719;&#21462;HTTP&#35831;&#27714;&#37327;&#30340;&#22686;&#38271;&#29575;
<span style="color: #0000ff;">rate</span>(http_requests_total[5m])

//&#26597;&#35810;&#24403;&#21069;&#31995;&#32479;&#20013;&#65292;&#35775;&#38382;&#37327;&#21069;10&#30340;HTTP&#22320;&#22336;
<span style="color: #0000ff;">topk</span>(10, http_requests_total)
</pre>
</div>

<p>
ä¸è¦å°† counter ç±»å‹åº”ç”¨äºæ ·æœ¬æ•°æ®éå•è°ƒé€’å¢çš„æŒ‡æ ‡ï¼Œ**ä¾‹å¦‚ï¼šå½“å‰è¿è¡Œçš„è¿›ç¨‹æ•°é‡ï¼ˆåº”è¯¥ç”¨ Guage ç±»å‹ï¼‰ã€‚
</p>
</div>
</div>
<div id="outline-container-h:fde38788-6699-43be-b0ae-f2a3a2a9ba93" class="outline-5">
<h5 id="h:fde38788-6699-43be-b0ae-f2a3a2a9ba93">Guageï¼ˆ ä»ªè¡¨ç›˜ï¼‰</h5>
<div class="outline-text-5" id="text-h:fde38788-6699-43be-b0ae-f2a3a2a9ba93">
<p>
Guage ç±»å‹ä»£è¡¨ä¸€ç§æ ·æœ¬æ•°æ®å¯ä»¥ä»»æ„å˜åŒ–çš„æŒ‡æ ‡ï¼Œå³å¯å¢å¯å‡ã€‚guage é€šå¸¸ç”¨äºåƒæ¸©åº¦æˆ–è€…å†…å­˜ä½¿ç”¨ç‡è¿™ç§æŒ‡æ ‡æ•°æ®ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºèƒ½éšæ—¶å¢åŠ æˆ–å‡å°‘çš„â€œæ€»æ•°â€ï¼Œä¾‹å¦‚ï¼šå½“å‰å¹¶å‘è¯·æ±‚çš„æ•°é‡ã€‚
</p>

<p>
å¯¹äº Gauge ç±»å‹çš„ç›‘æ§æŒ‡æ ‡ï¼Œé€šè¿‡ PromQL å†…ç½®å‡½æ•° [delta()]å¯ä»¥è·å–æ ·æœ¬åœ¨ä¸€æ®µæ—¶é—´å†…çš„å˜åŒ–æƒ…å†µï¼Œ**ä¾‹å¦‚ï¼Œè®¡ç®— CPU æ¸©åº¦åœ¨ä¸¤å°æ—¶å†…çš„å·®å¼‚ï¼š
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">dalta</span>(cpu_temp_celsius{<span style="color: #a0522d;">host</span>=<span style="color: #8b2252;">"zeus"</span>}[2h])
</pre>
</div>

<p>
ä½ è¿˜å¯ä»¥é€šè¿‡PromQL å†…ç½®å‡½æ•° [predict_linear()]åŸºäºç®€å•çº¿æ€§å›å½’çš„æ–¹å¼ï¼Œå¯¹æ ·æœ¬æ•°æ®çš„å˜åŒ–è¶‹åŠ¿åšå‡ºé¢„æµ‹ã€‚ä¾‹å¦‚ï¼ŒåŸºäº 2 å°æ—¶çš„æ ·æœ¬æ•°æ®ï¼Œæ¥é¢„æµ‹ä¸»æœºå¯ç”¨ç£ç›˜ç©ºé—´åœ¨ 4 ä¸ªå°æ—¶ä¹‹åçš„å‰©ä½™æƒ…å†µï¼š
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">predict_linear</span>(node_filesystem_free{<span style="color: #a0522d;">job</span>=<span style="color: #8b2252;">"node"</span>}[2h], 4 * 3600) &lt; 0
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5fe14672-67d4-4327-aaf8-f8665f59e8bd" class="outline-5">
<h5 id="h:5fe14672-67d4-4327-aaf8-f8665f59e8bd">Histogramï¼ˆç›´æ–¹å›¾ï¼‰</h5>
<div class="outline-text-5" id="text-h:5fe14672-67d4-4327-aaf8-f8665f59e8bd">
<p>
å‚è€ƒï¼šä¸€æ–‡ææ‡‚ Prometheus çš„ç›´æ–¹å›¾ <a href="https://www.cnblogs.com/ryanyangcs/p/11309373.html">https://www.cnblogs.com/ryanyangcs/p/11309373.html</a>
</p>

<p>
åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹äººä»¬éƒ½å€¾å‘äºä½¿ç”¨æŸäº›é‡åŒ–æŒ‡æ ‡çš„å¹³å‡å€¼ï¼Œä¾‹å¦‚ CPU çš„å¹³å‡ä½¿ç”¨ç‡ã€é¡µé¢çš„å¹³å‡å“åº”æ—¶é—´ã€‚è¿™ç§æ–¹å¼çš„é—®é¢˜å¾ˆæ˜æ˜¾ï¼Œä»¥ç³»ç»Ÿ API è°ƒç”¨çš„å¹³å‡å“åº”æ—¶é—´ä¸ºä¾‹ï¼šå¦‚æœå¤§å¤šæ•° API è¯·æ±‚éƒ½ç»´æŒåœ¨ 100ms çš„å“åº”æ—¶é—´èŒƒå›´å†…ï¼Œè€Œä¸ªåˆ«è¯·æ±‚çš„å“åº”æ—¶é—´éœ€è¦ 5sï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´æŸäº› WEB é¡µé¢çš„å“åº”æ—¶é—´è½åˆ°ä¸­ä½æ•°çš„æƒ…å†µï¼Œè€Œè¿™ç§ç°è±¡è¢«ç§°ä¸º**é•¿å°¾é—®é¢˜**ã€‚
</p>

<p>
ä¸ºäº†åŒºåˆ†æ˜¯å¹³å‡çš„æ…¢è¿˜æ˜¯é•¿å°¾çš„æ…¢ï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯æŒ‰ç…§è¯·æ±‚å»¶è¿Ÿçš„èŒƒå›´è¿›è¡Œåˆ†ç»„ã€‚ä¾‹å¦‚ï¼Œç»Ÿè®¡å»¶è¿Ÿåœ¨ 0~10ms ä¹‹é—´çš„è¯·æ±‚æ•°æœ‰å¤šå°‘è€Œ 10~20ms ä¹‹é—´çš„è¯·æ±‚æ•°åˆæœ‰å¤šå°‘ã€‚é€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥å¿«é€Ÿåˆ†æç³»ç»Ÿæ…¢çš„åŸå› ã€‚Histogram å’Œ Summary éƒ½æ˜¯ä¸ºäº†èƒ½å¤Ÿè§£å†³è¿™æ ·é—®é¢˜çš„å­˜åœ¨ï¼Œé€šè¿‡ Histogram å’Œ Summary ç±»å‹çš„ç›‘æ§æŒ‡æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿäº†è§£ç›‘æ§æ ·æœ¬çš„åˆ†å¸ƒæƒ…å†µã€‚
</p>

<p>
Histogram åœ¨ä¸€æ®µæ—¶é—´èŒƒå›´å†…å¯¹æ•°æ®è¿›è¡Œé‡‡æ ·ï¼ˆé€šå¸¸æ˜¯è¯·æ±‚æŒç»­æ—¶é—´æˆ–å“åº”å¤§å°ç­‰ï¼‰ï¼Œå¹¶å°†å…¶è®¡å…¥å¯é…ç½®çš„å­˜å‚¨æ¡¶ï¼ˆbucketï¼‰ä¸­ï¼Œåç»­å¯é€šè¿‡æŒ‡å®šåŒºé—´ç­›é€‰æ ·æœ¬ï¼Œä¹Ÿå¯ä»¥ç»Ÿè®¡æ ·æœ¬æ€»æ•°ï¼Œæœ€åä¸€èˆ¬å°†æ•°æ®å±•ç¤ºä¸ºç›´æ–¹å›¾ã€‚
</p>

<p>
Histogram ç±»å‹çš„æ ·æœ¬ä¼šæä¾›ä¸‰ç§æŒ‡æ ‡ï¼ˆå‡è®¾æŒ‡æ ‡åç§°ä¸º =&lt;basename&gt;=ï¼‰ï¼š
</p>

<ul class="org-ul">
<li>æ ·æœ¬çš„å€¼åˆ†å¸ƒåœ¨ bucket ä¸­çš„æ•°é‡ï¼Œå‘½åä¸º <code>&lt;basename&gt;_bucket{le="&lt;ä¸Šè¾¹ç•Œ&gt;"}</code> ã€‚è§£é‡Šçš„æ›´é€šä¿—æ˜“æ‡‚ä¸€ç‚¹ï¼Œè¿™ä¸ªå€¼è¡¨ç¤ºæŒ‡æ ‡å€¼å°äºç­‰äºä¸Šè¾¹ç•Œçš„æ‰€æœ‰æ ·æœ¬æ•°é‡ã€‚</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">// &#22312;&#24635;&#20849;2&#27425;&#35831;&#27714;&#24403;&#20013;&#12290;http &#35831;&#27714;&#21709;&#24212;&#26102;&#38388; &lt;=0.005 &#31186; &#30340;&#35831;&#27714;&#27425;&#25968;&#20026;0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.005"</span>,} 0.0
// &#22312;&#24635;&#20849;2&#27425;&#35831;&#27714;&#24403;&#20013;&#12290;http &#35831;&#27714;&#21709;&#24212;&#26102;&#38388; &lt;=0.01 &#31186; &#30340;&#35831;&#27714;&#27425;&#25968;&#20026;0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.01"</span>,} 0.0
// &#22312;&#24635;&#20849;2&#27425;&#35831;&#27714;&#24403;&#20013;&#12290;http &#35831;&#27714;&#21709;&#24212;&#26102;&#38388; &lt;=0.025 &#31186; &#30340;&#35831;&#27714;&#27425;&#25968;&#20026;0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.025"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.05"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.075"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.1"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.25"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.5"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"0.75"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"1.0"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"2.5"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"5.0"</span>,} 0.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"7.5"</span>,} 2.0
// &#22312;&#24635;&#20849;2&#27425;&#35831;&#27714;&#24403;&#20013;&#12290;http &#35831;&#27714;&#21709;&#24212;&#26102;&#38388; &lt;=10 &#31186; &#30340;&#35831;&#27714;&#27425;&#25968;&#20026; 2
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"10.0"</span>,} 2.0
io_namespace_http_requests_latency_seconds_histogram_bucket{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">le</span>=<span style="color: #8b2252;">"+Inf"</span>,} 2.0
</pre>
</div>

<ul class="org-ul">
<li>æ‰€æœ‰æ ·æœ¬å€¼çš„å¤§å°æ€»å’Œï¼Œå‘½åä¸º <code>&lt;basename&gt;_sum</code> ã€‚</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">// &#23454;&#38469;&#21547;&#20041;&#65306; &#21457;&#29983;&#30340;2&#27425; http &#35831;&#27714;&#24635;&#30340;&#21709;&#24212;&#26102;&#38388;&#20026; 13.107670803000001 &#31186;
io_namespace_http_requests_latency_seconds_histogram_sum{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,} 13.107670803000001
</pre>
</div>

<ul class="org-ul">
<li>æ ·æœ¬æ€»æ•°ï¼Œå‘½åä¸º <code>&lt;basename&gt;_count</code> ã€‚å€¼å’Œ <code>&lt;basename&gt;_bucket{le="+Inf"}</code> ç›¸åŒã€‚</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">// &#23454;&#38469;&#21547;&#20041;&#65306; &#24403;&#21069;&#19968;&#20849;&#21457;&#29983;&#20102; 2 &#27425; http &#35831;&#27714;
io_namespace_http_requests_latency_seconds_histogram_count{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,} 2.0
</pre>
</div>

<p>
<b><b>æ³¨æ„</b></b>
</p>
<ul class="org-ul">
<li>bucket å¯ä»¥ç†è§£ä¸ºæ˜¯å¯¹æ•°æ®æŒ‡æ ‡å€¼åŸŸçš„ä¸€ä¸ªåˆ’åˆ†ï¼Œåˆ’åˆ†çš„ä¾æ®åº”è¯¥åŸºäºæ•°æ®å€¼çš„åˆ†å¸ƒã€‚æ³¨æ„åé¢çš„é‡‡æ ·ç‚¹æ˜¯åŒ…å«å‰é¢çš„é‡‡æ ·ç‚¹çš„ï¼Œå‡è®¾ <code>xxx_bucket{...,le="0.01"}</code> çš„å€¼ä¸º 10ï¼Œè€Œ <code>xxx_bucket{...,le="0.05"}</code> çš„å€¼ä¸º 30ï¼Œé‚£ä¹ˆæ„å‘³ç€è¿™ 30 ä¸ªé‡‡æ ·ç‚¹ä¸­ï¼Œæœ‰ 10 ä¸ªæ˜¯å°äº 10 ms çš„ï¼Œå…¶ä½™ 20 ä¸ªé‡‡æ ·ç‚¹çš„å“åº”æ—¶é—´æ˜¯ä»‹äº 10 ms å’Œ 50 ms ä¹‹é—´çš„ã€‚</li>
</ul>

<p>
å¯ä»¥é€šè¿‡ <a href="https://www.yangcs.net/prometheus/3-prometheus/functions.html#histogramquantile">histogram_quantile() å‡½æ•°</a>æ¥è®¡ç®— Histogram ç±»å‹æ ·æœ¬çš„<a href="https://www.wikiwand.com/zh-hans/%E5%88%86%E4%BD%8D%E6%95%B0">åˆ†ä½æ•°</a>ã€‚åˆ†ä½æ•°å¯èƒ½ä¸å¤ªå¥½ç†è§£ï¼Œä½ å¯ä»¥ç†è§£ä¸ºåˆ†å‰²æ•°æ®çš„ç‚¹ã€‚æˆ‘ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æ ·æœ¬çš„ 9 åˆ†ä½æ•°ï¼ˆquantile=0.9ï¼‰çš„å€¼ä¸º xï¼Œå³è¡¨ç¤ºå°äº x çš„é‡‡æ ·å€¼çš„æ•°é‡å æ€»ä½“é‡‡æ ·å€¼çš„ 90%ã€‚Histogram è¿˜å¯ä»¥ç”¨æ¥è®¡ç®—åº”ç”¨æ€§èƒ½æŒ‡æ ‡å€¼<a href="https://www.wikiwand.com/en/Apdex">Apdex score</a>ã€‚
</p>
</div>
</div>
<div id="outline-container-h:3f09f685-9b6e-46d4-93f4-80dca66bdd3c" class="outline-5">
<h5 id="h:3f09f685-9b6e-46d4-93f4-80dca66bdd3c">Summaryï¼ˆæ‘˜è¦ï¼‰</h5>
<div class="outline-text-5" id="text-h:3f09f685-9b6e-46d4-93f4-80dca66bdd3c">
<p>
ä¸ Histogram ç±»å‹ç±»ä¼¼ï¼Œç”¨äºè¡¨ç¤ºä¸€æ®µæ—¶é—´å†…çš„æ•°æ®é‡‡æ ·ç»“æœï¼ˆé€šå¸¸æ˜¯è¯·æ±‚æŒç»­æ—¶é—´æˆ–å“åº”å¤§å°ç­‰ï¼‰ï¼Œä½†å®ƒç›´æ¥å­˜å‚¨äº†åˆ†ä½æ•°ï¼ˆé€šè¿‡å®¢æˆ·ç«¯è®¡ç®—ï¼Œç„¶åå±•ç¤ºå‡ºæ¥ï¼‰ï¼Œè€Œä¸æ˜¯é€šè¿‡åŒºé—´æ¥è®¡ç®—ã€‚
</p>

<p>
Summary ç±»å‹çš„æ ·æœ¬ä¹Ÿä¼šæä¾›ä¸‰ç§æŒ‡æ ‡ï¼ˆå‡è®¾æŒ‡æ ‡åç§°ä¸º ï¼‰ï¼š
</p>

<ul class="org-ul">
<li>æ ·æœ¬å€¼çš„åˆ†ä½æ•°åˆ†å¸ƒæƒ…å†µï¼Œå‘½åä¸º <code>&lt;basename&gt;{quantile="&lt;Ï†&gt;"}</code> ã€‚</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">// &#21547;&#20041;&#65306;&#36825; 12 &#27425; http &#35831;&#27714;&#20013;&#26377; 50% &#30340;&#35831;&#27714;&#21709;&#24212;&#26102;&#38388;&#26159; 3.052404983s
io_namespace_http_requests_latency_seconds_summary{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">quantile</span>=<span style="color: #8b2252;">"0.5"</span>,} 3.052404983
// &#21547;&#20041;&#65306;&#36825; 12 &#27425; http &#35831;&#27714;&#20013;&#26377; 90% &#30340;&#35831;&#27714;&#21709;&#24212;&#26102;&#38388;&#26159; 8.003261666s
io_namespace_http_requests_latency_seconds_summary{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,<span style="color: #a0522d;">quantile</span>=<span style="color: #8b2252;">"0.9"</span>,} 8.003261666
</pre>
</div>

<ul class="org-ul">
<li>æ‰€æœ‰æ ·æœ¬å€¼çš„å¤§å°æ€»å’Œï¼Œå‘½åä¸º <code>&lt;basename&gt;_sum</code> ã€‚</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">// &#21547;&#20041;&#65306;&#36825;12&#27425; http &#35831;&#27714;&#30340;&#24635;&#21709;&#24212;&#26102;&#38388;&#20026; 51.029495508s
io_namespace_http_requests_latency_seconds_summary_sum{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,} 51.029495508
</pre>
</div>

<ul class="org-ul">
<li>æ ·æœ¬æ€»æ•°ï¼Œå‘½åä¸º <code>&lt;basename&gt;_count</code> ã€‚</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">// &#21547;&#20041;&#65306;&#24403;&#21069;&#19968;&#20849;&#21457;&#29983;&#20102; 12 &#27425; http &#35831;&#27714;
io_namespace_http_requests_latency_seconds_summary_count{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"GET"</span>,<span style="color: #a0522d;">code</span>=<span style="color: #8b2252;">"200"</span>,} 12.0
</pre>
</div>

<p>
ç°åœ¨å¯ä»¥æ€»ç»“ä¸€ä¸‹ Histogram ä¸ Summary çš„å¼‚åŒï¼š
</p>

<ul class="org-ul">
<li>å®ƒä»¬éƒ½åŒ…å«äº† <code>&lt;basename&gt;_sum</code> å’Œ <code>&lt;basename&gt;_count</code> æŒ‡æ ‡</li>
<li>Histogram éœ€è¦é€šè¿‡ <code>&lt;basename&gt;_bucket</code> æ¥è®¡ç®—åˆ†ä½æ•°ï¼Œè€Œ Summary åˆ™ç›´æ¥å­˜å‚¨äº†åˆ†ä½æ•°çš„å€¼ã€‚</li>
</ul>

<p>
å…³äº Summary ä¸ Histogram çš„è¯¦ç»†ç”¨æ³•ï¼Œè¯·å‚è€ƒ <a href="https://prometheus.io/docs/practices/histograms">histograms and summaries</a>ã€‚
</p>

<p>
ä¸åŒè¯­è¨€å…³äº Summary çš„å®¢æˆ·ç«¯åº“ä½¿ç”¨æ–‡æ¡£ï¼š
</p>
</div>
</div>
</div>
<div id="outline-container-h:31a4e901-b8a7-4b6b-aa08-0f13f466ed8b" class="outline-4">
<h4 id="h:31a4e901-b8a7-4b6b-aa08-0f13f466ed8b">æ•°æ®æ¨¡å‹</h4>
<div class="outline-text-4" id="text-h:31a4e901-b8a7-4b6b-aa08-0f13f466ed8b">
<p>
Prometheus æ‰€æœ‰é‡‡é›†çš„ç›‘æ§æ•°æ®å‡ä»¥æŒ‡æ ‡ï¼ˆmetricï¼‰çš„å½¢å¼**ä¿å­˜åœ¨å†…ç½®çš„æ—¶é—´åºåˆ—æ•°æ®åº“å½“ä¸­ï¼ˆTSDBï¼‰**ï¼šå±äºåŒä¸€æŒ‡æ ‡åç§°ï¼ŒåŒä¸€æ ‡ç­¾é›†åˆçš„ã€æœ‰æ—¶é—´æˆ³æ ‡è®°çš„æ•°æ®æµã€‚é™¤äº†å­˜å‚¨çš„æ—¶é—´åºåˆ—ï¼ŒPrometheus è¿˜å¯ä»¥æ ¹æ®æŸ¥è¯¢è¯·æ±‚äº§ç”Ÿä¸´æ—¶çš„ã€è¡ç”Ÿçš„æ—¶é—´åºåˆ—ä½œä¸ºè¿”å›ç»“æœã€‚
</p>
</div>
<div id="outline-container-h:60d2a1c7-6132-4095-8e0c-c636a082ffe8" class="outline-5">
<h5 id="h:60d2a1c7-6132-4095-8e0c-c636a082ffe8">æŒ‡æ ‡åç§°å’Œæ ‡ç­¾</h5>
<div class="outline-text-5" id="text-h:60d2a1c7-6132-4095-8e0c-c636a082ffe8">
<p>
æ¯ä¸€æ¡æ—¶é—´åºåˆ—ç”±æŒ‡æ ‡åç§°ï¼ˆMetrics Nameï¼‰ä»¥åŠä¸€ç»„æ ‡ç­¾ï¼ˆé”®å€¼å¯¹ï¼‰å”¯ä¸€æ ‡è¯†ã€‚å…¶ä¸­æŒ‡æ ‡çš„åç§°ï¼ˆmetric nameï¼‰å¯ä»¥åæ˜ è¢«ç›‘æ§æ ·æœ¬çš„å«ä¹‰ï¼ˆä¾‹å¦‚ï¼Œ <code>http_requests_total</code> â€” è¡¨ç¤ºå½“å‰ç³»ç»Ÿæ¥æ”¶åˆ°çš„ HTTP è¯·æ±‚æ€»é‡ï¼‰ï¼ŒæŒ‡æ ‡åç§°åªèƒ½ç”± ASCII å­—ç¬¦ã€æ•°å­—ã€ä¸‹åˆ’çº¿ä»¥åŠå†’å·ç»„æˆï¼ŒåŒæ—¶å¿…é¡»åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ <code>[a-zA-Z_:][a-zA-Z0-9_:]*</code> ã€‚
</p>


<p>
ï¼ˆæ—¶é—´åºåˆ—[å”¯ä¸€æ ‡è¯†]ï¼‰=æŒ‡æ ‡åç§°+æ ‡ç­¾ï¼‰
</p>

<p>
æ³¨æ„ï¼š
  å†’å·ç”¨æ¥è¡¨ç¤ºç”¨æˆ·è‡ªå®šä¹‰çš„è®°å½•è§„åˆ™ï¼Œä¸èƒ½åœ¨ exporter ä¸­æˆ–ç›‘æ§å¯¹è±¡ç›´æ¥æš´éœ²çš„æŒ‡æ ‡ä¸­ä½¿ç”¨å†’å·æ¥å®šä¹‰æŒ‡æ ‡åç§°ã€‚
</p>


<p>
é€šè¿‡ä½¿ç”¨æ ‡ç­¾ï¼ŒPrometheus å¼€å¯äº†å¼ºå¤§çš„å¤šç»´æ•°æ®æ¨¡å‹ï¼šå¯¹äºç›¸åŒçš„æŒ‡æ ‡åç§°ï¼Œé€šè¿‡ä¸åŒæ ‡ç­¾åˆ—è¡¨çš„é›†åˆï¼Œä¼šå½¢æˆç‰¹å®šçš„åº¦é‡ç»´åº¦å®ä¾‹ï¼ˆä¾‹å¦‚ï¼šæ‰€æœ‰åŒ…å«åº¦é‡åç§°ä¸º /api/tracks çš„ http è¯·æ±‚ï¼Œæ‰“ä¸Š method=POST çš„æ ‡ç­¾ï¼Œå°±ä¼šå½¢æˆå…·ä½“çš„ http è¯·æ±‚ï¼‰ã€‚è¯¥æŸ¥è¯¢è¯­è¨€åœ¨è¿™äº›æŒ‡æ ‡å’Œæ ‡ç­¾åˆ—è¡¨çš„åŸºç¡€ä¸Šè¿›è¡Œè¿‡æ»¤å’Œèšåˆã€‚æ”¹å˜ä»»ä½•åº¦é‡æŒ‡æ ‡ä¸Šçš„ä»»ä½•æ ‡ç­¾å€¼ï¼ˆåŒ…æ‹¬æ·»åŠ æˆ–åˆ é™¤æŒ‡æ ‡ï¼‰ï¼Œéƒ½ä¼šåˆ›å»ºæ–°çš„æ—¶é—´åºåˆ—ã€‚
</p>

<p>
æ ‡ç­¾çš„åç§°åªèƒ½ç”± ASCII å­—ç¬¦ã€æ•°å­—ä»¥åŠä¸‹åˆ’çº¿ç»„æˆå¹¶æ»¡è¶³æ­£åˆ™è¡¨è¾¾å¼ <code>[a-zA-Z_][a-zA-Z0-9_]*</code> ã€‚å…¶ä¸­ä»¥ <code>__</code> ä½œä¸ºå‰ç¼€çš„æ ‡ç­¾ï¼Œæ˜¯ç³»ç»Ÿä¿ç•™çš„å…³é”®å­—ï¼Œåªèƒ½åœ¨ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨ã€‚æ ‡ç­¾çš„å€¼åˆ™å¯ä»¥åŒ…å«ä»»ä½• Unicode ç¼–ç çš„å­—ç¬¦ã€‚
</p>
</div>
</div>
<div id="outline-container-h:15b1a041-41df-4fa1-8c54-ec8bfdcd7626" class="outline-5">
<h5 id="h:15b1a041-41df-4fa1-8c54-ec8bfdcd7626">æ ·æœ¬ï¼ˆsampleï¼‰</h5>
<div class="outline-text-5" id="text-h:15b1a041-41df-4fa1-8c54-ec8bfdcd7626">
<p>
åœ¨æ—¶é—´åºåˆ—ä¸­çš„æ¯ä¸€ä¸ªç‚¹ç§°ä¸ºä¸€ä¸ªæ ·æœ¬ï¼ˆsampleï¼‰ï¼Œæ ·æœ¬ç”±ä»¥ä¸‹ä¸‰éƒ¨åˆ†ç»„æˆï¼š
</p>

<ul class="org-ul">
<li>æŒ‡æ ‡ï¼ˆmetricï¼‰ï¼šæŒ‡æ ‡åç§°å’Œæè¿°å½“å‰æ ·æœ¬ç‰¹å¾çš„ labelsetsï¼›</li>
<li>æ—¶é—´æˆ³ï¼ˆtimestampï¼‰ï¼šä¸€ä¸ªç²¾ç¡®åˆ°æ¯«ç§’çš„æ—¶é—´æˆ³ï¼›</li>
<li>æ ·æœ¬å€¼ï¼ˆvalueï¼‰ï¼š ä¸€ä¸ª folat64 çš„æµ®ç‚¹å‹æ•°æ®è¡¨ç¤ºå½“å‰æ ·æœ¬çš„å€¼ã€‚</li>
</ul>
</div>
</div>
<div id="outline-container-h:7ca8cae1-393c-401a-9047-c5ddf6000a39" class="outline-5">
<h5 id="h:7ca8cae1-393c-401a-9047-c5ddf6000a39">è¡¨ç¤ºæ–¹å¼</h5>
<div class="outline-text-5" id="text-h:7ca8cae1-393c-401a-9047-c5ddf6000a39">
<p>
é€šè¿‡å¦‚ä¸‹è¡¨è¾¾æ–¹å¼è¡¨ç¤ºæŒ‡å®šæŒ‡æ ‡åç§°å’ŒæŒ‡å®šæ ‡ç­¾é›†åˆçš„æ—¶é—´åºåˆ—ï¼š
</p>

<div class="org-src-container">
<pre class="src src-shell">&lt;metric name&gt;{&lt;label name&gt;=&lt;label value&gt;, ...}
</pre>
</div>

<p>
ä¾‹å¦‚ï¼ŒæŒ‡æ ‡åç§°ä¸º ~api_http_requests_total~ï¼Œæ ‡ç­¾ä¸º method="POST" å’Œ handler="/messages" çš„æ—¶é—´åºåˆ—å¯ä»¥è¡¨ç¤ºä¸ºï¼š
</p>

<div class="org-src-container">
<pre class="src src-shell">api_http_requests_total{<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"POST"</span>, <span style="color: #a0522d;">handler</span>=<span style="color: #8b2252;">"/messages"</span>}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:1a8584e2-e996-41cb-80f9-865e07992975" class="outline-4">
<h4 id="h:1a8584e2-e996-41cb-80f9-865e07992975">PromQL</h4>
<div class="outline-text-4" id="text-h:1a8584e2-e996-41cb-80f9-865e07992975">
<p>
å‚è€ƒï¼š<a href="https://fuckcloudnative.io/prometheus/3-prometheus/basics.html">https://fuckcloudnative.io/prometheus/3-prometheus/basics.html</a>
</p>
</div>
<div id="outline-container-h:2431a6cf-443c-479f-9089-149637a06443" class="outline-5">
<h5 id="h:2431a6cf-443c-479f-9089-149637a06443">è¡¨è¾¾å¼è¯­è¨€æ•°æ®ç±»å‹</h5>
<div class="outline-text-5" id="text-h:2431a6cf-443c-479f-9089-149637a06443">
<ul class="org-ul">
<li>ç¬æ—¶å‘é‡ï¼šåŒ…å«è¯¥æ—¶é—´åºåˆ—ä¸­æœ€æ–°çš„ä¸€ä¸ªæ ·æœ¬å€¼ã€‚</li>
<li>åŒºé—´å‘é‡ï¼šä¸€æ®µæ—¶é—´èŒƒå›´å†…çš„æ•°æ®ã€‚</li>
<li>æ ‡é‡ï¼ˆScalarï¼‰ - ä¸€ä¸ªæµ®ç‚¹å‹çš„æ•°æ®å€¼ã€‚</li>
<li>å­—ç¬¦ä¸²ï¼ˆStringï¼‰ - ä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²å€¼ã€‚</li>
</ul>

<p>
ç¬æ—¶å‘é‡
</p>
<div class="org-src-container">
<pre class="src src-shell">&#30446;&#21069;&#20027;&#35201;&#25903;&#25345;&#20004;&#31181;&#21305;&#37197;&#27169;&#24335;&#65306;&#23436;&#20840;&#21305;&#37197;&#21644;&#27491;&#21017;&#21305;&#37197;&#12290;&#26377;&#20197;&#19979;&#20960;&#31181;&#26631;&#31614;&#21305;&#37197;&#36816;&#31639;&#31526;:
= : &#36873;&#25321;&#19982;&#25552;&#20379;&#30340;&#23383;&#31526;&#20018;&#23436;&#20840;&#30456;&#21516;&#30340;&#26631;&#31614;&#12290;
!= : &#36873;&#25321;&#19982;&#25552;&#20379;&#30340;&#23383;&#31526;&#20018;&#19981;&#30456;&#21516;&#30340;&#26631;&#31614;&#12290;
=~ : &#36873;&#25321;&#27491;&#21017;&#34920;&#36798;&#24335;&#19982;&#25552;&#20379;&#30340;&#23383;&#31526;&#20018;&#65288;&#25110;&#23376;&#23383;&#31526;&#20018;&#65289;&#30456;&#21305;&#37197;&#30340;&#26631;&#31614;&#12290;
!~ : &#36873;&#25321;&#27491;&#21017;&#34920;&#36798;&#24335;&#19982;&#25552;&#20379;&#30340;&#23383;&#31526;&#20018;&#65288;&#25110;&#23376;&#23383;&#31526;&#20018;&#65289;&#19981;&#21305;&#37197;&#30340;&#26631;&#31614;

{<span style="color: #a0522d;">job</span>=~<span style="color: #8b2252;">".*"</span>} <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38750;&#27861;&#65281;&#22240;&#20026;&#20250;&#21305;&#37197;&#21040;&#31354;&#23383;&#31526;&#20018;
</span>{<span style="color: #a0522d;">job</span>=~<span style="color: #8b2252;">".+"</span>}              <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21512;&#27861;&#65281;
</span>{<span style="color: #a0522d;">job</span>=~<span style="color: #8b2252;">".*"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"get"</span>} <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21512;&#27861;&#65281;</span>
</pre>
</div>


<p>
åŒºé—´å‘é‡
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21306;&#38388;&#21521;&#37327;
</span>http_requests_total{<span style="color: #a0522d;">job</span>=<span style="color: #8b2252;">"prometheus"</span>}[5m] <span style="color: #b22222;"># </span><span style="color: #b22222;">5 &#20998;&#38047;&#20869;&#30340;&#25968;&#25454;</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:d637d076-49d1-4746-b7e9-b834c507612a" class="outline-3">
<h3 id="h:d637d076-49d1-4746-b7e9-b834c507612a">PromQL æ“ä½œç¬¦</h3>
<div class="outline-text-3" id="text-h:d637d076-49d1-4746-b7e9-b834c507612a">
<p>
æ—¶é—´ä½ç§» offset
</p>
<ul class="org-ul">
<li>http_request_total{}[5m] offset 1d # è¿‡å»ä¸€å¤© 5 åˆ†é’Ÿå†…çš„æ•°æ®</li>
</ul>

<p>
æ•°å­¦è¿ç®—ï¼š+ - * / % ^
</p>

<p>
èŒƒä¾‹ï¼šæŸ¥çœ‹ä¸»æœºå†…å­˜æ€»å¤§å°ï¼ˆMiï¼‰
</p>
<div class="org-src-container">
<pre class="src src-shell">&#38500;&#27861;&#65306;node_memory_MemTotal_bytes / 1024 /1024
node_memory_MemTotal_bytes / 1024 /1024 &lt; 3000
</pre>
</div>

<p>
é›†åˆè¿ç®—ï¼š
</p>
<ul class="org-ul">
<li>and ä¸”å…³ç³»</li>
<li>or å¹¶åˆ—å…³ç³»</li>
<li>unlessï¼šæ’é™¤</li>
</ul>

<p>
èŒƒä¾‹ï¼š
</p>
<div class="org-src-container">
<pre class="src src-shell">node_memory_MemTotal_bytes / 1024 /1024 &lt;= 8000 or node_memory_MemTotal_bytes / 1024 /1024 == 15421.25  
node_memory_MemTotal_bytes / 1024 /1024 &gt;= 8000  unless node_memory_MemTotal_bytes / 1024 /1024 ==  3758.59765625
</pre>
</div>

<p>
èŒƒä¾‹ï¼š æŒ‡å®š UTC æ—¶é—´æ®µ
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">UTC 18 &#33267; 1  &#28857;&#38388;&#65292;TPS == 0 &#25253;&#35686;
</span><span style="color: #0000ff;">floor</span>(sum(api:mark:gateway_request_total:rate:sum)) == 0  and on() ( hour() &gt;18 or hour() &lt;1)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#38750; UTC 18 &#33267; 1  &#28857;&#38388;&#65292;TPS == 0 &#25253;&#35686;
</span><span style="color: #0000ff;">floor</span>(sum(api:mark:gateway_request_total:rate:sum)) == 0  unless on() ( hour() &gt;18 or hour() &lt;1)
</pre>
</div>

<p>
ä¼˜å…ˆçº§
</p>

<div class="org-src-container">
<pre class="src src-shell">^ 
* / %
+ -
==, !=, &lt;=, &lt; &gt;= &gt;
And unless
Or
</pre>
</div>


<p>
èšåˆæ“ä½œï¼š
</p>
<ul class="org-ul">
<li>sum (æ±‚å’Œ)</li>
<li>min (æœ€å°å€¼)</li>
<li>max (æœ€å¤§å€¼)</li>
<li>avg (å¹³å‡å€¼)</li>
<li>stddev (æ ‡å‡†å·®)</li>
<li>stdvar (æ ‡å‡†å·®å¼‚)</li>
<li>count (è®¡æ•°)</li>
<li>count_values (å¯¹ value è¿›è¡Œè®¡æ•°)</li>
<li>bottomk (æ ·æœ¬å€¼æœ€å°çš„ k ä¸ªå…ƒç´ )</li>
<li>topk (æ ·æœ¬å€¼æœ€å¤§çš„kä¸ªå…ƒç´ )</li>
<li>quantile (åˆ†å¸ƒç»Ÿè®¡)</li>
</ul>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">sum</span>(node_memory_MemTotal_bytes) / 1024^2  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27714;&#21644;
</span><span style="color: #0000ff;">&#26681;&#25454;&#26576;&#20010;&#23383;&#27573;&#36827;&#34892;&#32479;&#35745;sum</span>(http_request_total)  by (statuscode, handler)

<span style="color: #0000ff;">min</span>(node_memory_MemTotal_bytes)   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26368;&#23567;&#20540;  max  
</span><span style="color: #0000ff;">avg</span>(node_memory_MemTotal_bytes)    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24179;&#22343;&#20540;avg
</span>&#26631;&#20934;&#24046;&#65306;stddev    &#26631;&#20934;&#24046;&#24322;&#65306;stdvar 
<span style="color: #0000ff;">count</span>(http_request_total) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35745;&#25968;
</span><span style="color: #0000ff;">count_values</span>(<span style="color: #8b2252;">"count"</span>, node_memory_MemTotal_bytes)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;value&#36827;&#34892;&#32479;&#35745;&#35745;&#25968;
</span>
<span style="color: #0000ff;">topk</span>(5, sum(http_request_total)  by (statuscode, handler)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21462;&#21069;N&#26465;&#26102;&#24207;
</span><span style="color: #0000ff;">bottomk</span>(3, sum(http_request_total)  by (statuscode, handler)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21462;&#21518;N&#26465;&#26102;&#24207;
</span>
&#21462;&#24403;&#21069;&#25968;&#25454;&#30340;&#20013;&#20301;&#25968;&#65292;0 -1
<span style="color: #0000ff;">quantile</span>(0.5, http_request_total)
</pre>
</div>

<p>
å‘é‡åŒ¹é…ç±»å‹
</p>
<ul class="org-ul">
<li>ä¸€å¯¹ä¸€åŒ¹é…ï¼ˆé»˜è®¤ï¼‰ï¼š <code>on()</code> æˆ– <code>ignoring()</code></li>
<li>å¤šå¯¹ä¸€/ä¸€å¯¹å¤šåŒ¹é…ï¼šéœ€è¦ä½¿ç”¨ <code>group_left</code> æˆ– <code>group_right</code></li>
</ul>
</div>
<div id="outline-container-h:34ea3356-7dab-4825-9ece-ae7c85dd272f" class="outline-4">
<h4 id="h:34ea3356-7dab-4825-9ece-ae7c85dd272f"><code>group_left</code></h4>
<div class="outline-text-4" id="text-h:34ea3356-7dab-4825-9ece-ae7c85dd272f">
<p>
ä¸»è¦ç”¨äºå½“å·¦ä¾§æœ‰å¤šä¸ªæ—¶é—´åºåˆ—éœ€è¦ä¸å³ä¾§çš„å•ä¸ªæ—¶é—´åºåˆ—è¿›è¡ŒåŒ¹é…æ—¶ï¼Œä¿ç•™å·¦ä¾§çš„é¢å¤–ç»´åº¦ä¿¡æ¯ã€‚
</p>

<p>
<code>group_left</code> çš„ä½œç”¨
</p>
<ul class="org-ul">
<li>å¤šå¯¹ä¸€åŒ¹é…ï¼šå·¦ä¾§å‘é‡æœ‰å¤šä¸ªæ—¶é—´åºåˆ—ä¸å³ä¾§å‘é‡çš„å•ä¸ªæ—¶é—´åºåˆ—åŒ¹é…</li>
<li>ä¿ç•™å·¦ä¾§çš„æ‰€æœ‰æ ‡ç­¾</li>
</ul>

<p>
è¯­æ³•ç»“æ„
</p>

<div class="org-src-container">
<pre class="src src-shell">&lt;vector expr&gt; &lt;bin-op&gt; &lt;vector expr&gt;
<span style="color: #0000ff;">on</span>(&lt;label list&gt;) group_left(&lt;target label list&gt;)

&lt;vector expr&gt; &lt;bin-op&gt; &lt;vector expr&gt;
<span style="color: #0000ff;">ignoring</span>(&lt;label list&gt;) group_left(&lt;target label list&gt;)
</pre>
</div>

<p>
æœ€ä½³å®è·µ
</p>
<ul class="org-ul">
<li>æ˜ç¡®åŒ¹é…æ ‡ç­¾ï¼šå§‹ç»ˆä½¿ç”¨ on() æ˜ç¡®æŒ‡å®šåŒ¹é…æ ‡ç­¾</li>
<li>æ ‡ç­¾ç®¡ç†ï¼šä½¿ç”¨ group_left(&lt;labels&gt;) æŒ‡å®šè¦ä¿ç•™çš„é¢å¤–æ ‡ç­¾</li>
<li>é¿å…æ­§ä¹‰ï¼šç¡®ä¿å³ä¾§å‘é‡åœ¨æ¯ä¸ªåŒ¹é…ç»„ä¸­åªæœ‰ä¸€ä¸ªå€¼</li>
</ul>

<p>
ç¤ºä¾‹ï¼šå…³è”æŒ‡æ ‡è®¡ç®—
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20551;&#35774;&#26377;&#20004;&#20010;&#25351;&#26631;&#65306;
</span>http_requests_total{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"a"</span>, <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/api"</span>} = 100
http_requests_total{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"b"</span>, <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/api"</span>} = 200
http_failures_total{<span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/api"</span>} = 15 &#65288;&#26080;instance&#26631;&#31614;&#65289;

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35745;&#31639;&#27599;&#20010;&#23454;&#20363;&#30340;&#22833;&#36133;&#29575;
</span>http_requests_total / on(path) group_left(instance) http_failures_total
</pre>
</div>

<p>
ç»“æœï¼š
</p>
<div class="org-src-container">
<pre class="src src-shell">{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"a"</span>, <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/api"</span>} = 100 / <span style="color: #a0522d;">15</span> = 6.67
{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"b"</span>, <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">"/api"</span>} = 200 / <span style="color: #a0522d;">15</span> = 13.33
</pre>
</div>

<p>
èŒƒä¾‹-è®¡ç®—æ¯ä¸ªå®ä¾‹çš„CPUä½¿ç”¨ç‡å æ¯”
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21407;&#22987;&#25968;&#25454;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#20010;CPU&#26680;&#24515;&#30340;&#20351;&#29992;&#26102;&#38388;&#65288;&#22810;&#26631;&#31614;&#65289;
</span>node_cpu_seconds_total{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.1:9100"</span>, <span style="color: #a0522d;">cpu</span>=<span style="color: #8b2252;">"0"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"idle"</span>}    10000
node_cpu_seconds_total{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.1:9100"</span>, <span style="color: #a0522d;">cpu</span>=<span style="color: #8b2252;">"0"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"system"</span>}  500
node_cpu_seconds_total{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.1:9100"</span>, <span style="color: #a0522d;">cpu</span>=<span style="color: #8b2252;">"1"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"idle"</span>}    12000
node_cpu_seconds_total{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.1:9100"</span>, <span style="color: #a0522d;">cpu</span>=<span style="color: #8b2252;">"1"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"system"</span>}  300

node_cpu_seconds_total{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.2:9100"</span>, <span style="color: #a0522d;">cpu</span>=<span style="color: #8b2252;">"0"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"idle"</span>}    8000
node_cpu_seconds_total{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.2:9100"</span>, <span style="color: #a0522d;">cpu</span>=<span style="color: #8b2252;">"0"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"system"</span>}  200

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35745;&#31639;&#27599;&#20010;&#23454;&#20363;&#30340;&#24635;CPU&#26102;&#38388;&#65288;&#32858;&#21512;&#65289;
</span>sum without(cpu)(node_cpu_seconds_total)
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32467;&#26524;&#65288;&#27809;&#26377;cpu&#26631;&#31614;&#65289;
</span>{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.1:9100"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"idle"</span>}    22000  <span style="color: #b22222;"># </span><span style="color: #b22222;">10000+12000
</span>{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.1:9100"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"system"</span>}  800    <span style="color: #b22222;"># </span><span style="color: #b22222;">500+300
</span>{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.2:9100"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"idle"</span>}    8000
{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.2:9100"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"system"</span>}  200
</pre>
</div>

<p>
ä½¿ç”¨ group_left
</p>
<div class="org-src-container">
<pre class="src src-shell">node_cpu_seconds_total{<span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"idle"</span>} / on(instance, mode) group_left(cpu)
sum without(cpu)(node_cpu_seconds_total{<span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"idle"</span>})

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#32456;&#32467;&#26524;
</span>{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.1:9100"</span>, <span style="color: #a0522d;">cpu</span>=<span style="color: #8b2252;">"0"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"idle"</span>}    0.4545
{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.1:9100"</span>, <span style="color: #a0522d;">cpu</span>=<span style="color: #8b2252;">"1"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"idle"</span>}    0.5455
{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.2:9100"</span>, <span style="color: #a0522d;">cpu</span>=<span style="color: #8b2252;">"0"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"idle"</span>}    1.0000  <span style="color: #b22222;"># </span><span style="color: #b22222;">8000/8000</span>
</pre>
</div>

<p>
åŒ¹é…è¿‡ç¨‹ï¼š
</p>
<div class="org-src-container">
<pre class="src src-shell">&#24038;&#20391;&#24207;&#21015;1&#65306;{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.1:9100"</span>, <span style="color: #a0522d;">cpu</span>=<span style="color: #8b2252;">"0"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"idle"</span>}
- &#21305;&#37197;&#26631;&#31614;&#65306;<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.1:9100"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"idle"</span>
- &#25214;&#21040;&#21491;&#20391;&#65306;{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.1:9100"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"idle"</span>}
- &#35745;&#31639;&#65306;10000 / <span style="color: #a0522d;">22000</span> = 0.4545
- &#20445;&#30041;&#24038;&#20391;&#30340;&#39069;&#22806;&#26631;&#31614; <span style="color: #a0522d;">cpu</span>=<span style="color: #8b2252;">"0"</span>

&#24038;&#20391;&#24207;&#21015;2&#65306;{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.1:9100"</span>, <span style="color: #a0522d;">cpu</span>=<span style="color: #8b2252;">"1"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"idle"</span>}
- &#21305;&#37197;&#26631;&#31614;&#65306;<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.1:9100"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"idle"</span>
- &#25214;&#21040;&#21491;&#20391;&#65306;{<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.0.0.1:9100"</span>, <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">"idle"</span>}&#65288;&#21516;&#19968;&#20010;&#65281;&#65289;
- &#35745;&#31639;&#65306;12000 / <span style="color: #a0522d;">22000</span> = 0.5455
- &#20445;&#30041;&#24038;&#20391;&#30340;&#39069;&#22806;&#26631;&#31614; <span style="color: #a0522d;">cpu</span>=<span style="color: #8b2252;">"1"</span>
</pre>
</div>




<p>
ç¤ºä¾‹ï¼šä¸èšåˆå‡½æ•°ç»“åˆ
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#20010;&#26381;&#21153;&#30340;&#38169;&#35823;&#29575;&#35745;&#31639;
</span><span style="color: #0000ff;">rate</span>(http_requests_total{<span style="color: #a0522d;">status</span>=~<span style="color: #8b2252;">"5.."</span>}[5m]) / 
  on(service) group_left 
  rate(http_requests_total[5m])
</pre>
</div>

<p>
group_right ç¤ºä¾‹
</p>
<div class="org-src-container">
<pre class="src src-shell">sum by(job)(rate(http_requests_total[5m])) / 
  on(job) group_right 
  rate(http_requests_total[5m])
</pre>
</div>

<p>
é”™è¯¯1ï¼šæ ‡ç­¾å†²çª
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#38169;&#35823;&#65306;&#32467;&#26524;&#20250;&#26377;&#37325;&#22797;&#30340;job&#26631;&#31614;
</span>metric_a / on(instance) group_left(job) metric_b

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27491;&#30830;&#65306;&#20351;&#29992;ignoring
</span>metric_a / ignoring(job) group_left metric_b
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:44ca4052-0c29-403e-a90a-a28070bcf348" class="outline-3">
<h3 id="h:44ca4052-0c29-403e-a90a-a28070bcf348">PromQL å¸¸ç”¨å‡½æ•°</h3>
<div class="outline-text-3" id="text-h:44ca4052-0c29-403e-a90a-a28070bcf348">
<p>
è½¬è¯‘ç”¨åŒåæ–œçº¿<br>
</p>
</div>
<div id="outline-container-h:e42c4339-59ba-4875-a9ee-8c59171ed853" class="outline-4">
<h4 id="h:e42c4339-59ba-4875-a9ee-8c59171ed853">ä¸€ä¸ªæŒ‡æ ‡çš„å¢é•¿ç‡</h4>
<div class="outline-text-4" id="text-h:e42c4339-59ba-4875-a9ee-8c59171ed853">
<p>
increaseï¼š
å‡½æ•°è·å–åŒºé—´å‘é‡ä¸­çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªæ ·æœ¬å¹¶è¿”å›å…¶å¢é•¿é‡ã€‚
åªèƒ½è®¡ç®— counter  æ•°æ®ã€‚
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#31186;&#22686;&#38271;&#29575; = 1 &#23567;&#26102;&#22686;&#38271;&#29575;&#65292;&#39318;&#23614;&#20540; / 3600
</span><span style="color: #0000ff;">increase</span>(http_request_total{<span style="color: #a0522d;">endpoint</span>=<span style="color: #8b2252;">"http"</span>,<span style="color: #a0522d;">handler</span>=<span style="color: #8b2252;">"/datasources/proxy/:id/*"</span>,<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.244.58.200:3000"</span>,<span style="color: #a0522d;">job</span>=<span style="color: #8b2252;">"grafana"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"get"</span>,<span style="color: #a0522d;">namespace</span>=<span style="color: #8b2252;">"monitoring"</span>,<span style="color: #a0522d;">pod</span>=<span style="color: #8b2252;">"grafana-86b55cb79f-fn4ss"</span>,<span style="color: #a0522d;">service</span>=<span style="color: #8b2252;">"grafana"</span>,<span style="color: #a0522d;">statuscode</span>=<span style="color: #8b2252;">"200"</span>}[1h]) / 3600
</pre>
</div>

<p>
rateï¼š
ç›¸å¯¹äº increaseï¼Œrate å¯ä»¥ç›´æ¥è®¡ç®—å‡ºæŸä¸ªæŒ‡æ ‡åœ¨ç»™ä½ å†™æ—¶é—´èŒƒå›´çš„å¢é•¿ç‡ï¼Œä¸€èˆ¬ä½¿ç”¨ rate å‡½æ•°ä¸ä¼šä½¿ç”¨ increase å‡½æ•°ã€‚
</p>

<p>
æ¯”å¦‚è¿˜æ˜¯è®¡ç®— 1h çš„å¢é•¿ç‡ï¼Œå¯ä»¥ç”¨ rate å‡½æ•°è®¡ç®—ï¼š
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#29992; rate &#21516;&#26679;&#25928;&#26524;
</span><span style="color: #0000ff;">rate</span>(http_request_total{<span style="color: #a0522d;">endpoint</span>=<span style="color: #8b2252;">"http"</span>,<span style="color: #a0522d;">handler</span>=<span style="color: #8b2252;">"/datasources/proxy/:id/*"</span>,<span style="color: #a0522d;">instance</span>=<span style="color: #8b2252;">"10.244.58.200:3000"</span>,<span style="color: #a0522d;">job</span>=<span style="color: #8b2252;">"grafana"</span>,<span style="color: #a0522d;">method</span>=<span style="color: #8b2252;">"get"</span>,<span style="color: #a0522d;">namespace</span>=<span style="color: #8b2252;">"monitoring"</span>,<span style="color: #a0522d;">pod</span>=<span style="color: #8b2252;">"grafana-86b55cb79f-fn4ss"</span>,<span style="color: #a0522d;">service</span>=<span style="color: #8b2252;">"grafana"</span>,<span style="color: #a0522d;">statuscode</span>=<span style="color: #8b2252;">"200"</span>}[1h])
</pre>
</div>


<p>
é•¿å°¾æ•ˆåº”ï¼Œincreaseï¼Œrate æœ‰åŒæ ·çš„é—®é¢˜ï¼Œå¯¹äºæœ‰æ¿€å¢çš„ä¼šå½±å“ç»“æœã€‚ä¼šç”¨ä¸‹é¢ irate è§£å†³ã€‚
</p>

<p>
irateï¼š ç¬æ—¶å¢é•¿ç‡ï¼Œå–æœ€åä¸¤ä¸ªæ•°æ®è¿›è¡Œè®¡ç®—ï¼Œä¸é€‚åˆåšéœ€è¦åˆ†æœŸé•¿æœŸè¶‹åŠ¿æˆ–è€…åœ¨å‘Šè­¦è§„åˆ™ä¸­ä½¿ç”¨ï¼Œå› ä¸ºæ¯”å¦‚ prometheus 15s æ”¶é›†ä¸€æ¬¡æ•°æ®ï¼Œæ£€æŸ¥æœ€è¿‘ 60s å†…çš„æ•°æ®ä¼šæœ‰ 4 ä¸ªç»“æœï¼Œç”¨ irate åªèƒ½ç”¨æœ€åä¸¤ä¸ªæ•°æ®ã€‚é•¿æœŸçš„ä½¿ç”¨ç”¨ rate å¯ä»¥ä½¿ç”¨ 60s å†…æ‰€æœ‰é‡‡é›†ç‚¹æ•°æ®ã€‚
</p>
</div>
</div>
<div id="outline-container-h:73136684-06a7-4cf2-b624-bb9e09aa0b92" class="outline-4">
<h4 id="h:73136684-06a7-4cf2-b624-bb9e09aa0b92">é¢„æµ‹ç»Ÿè®¡ï¼š</h4>
<div class="outline-text-4" id="text-h:73136684-06a7-4cf2-b624-bb9e09aa0b92">
<p>
predict_linear
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#25454;&#19968;&#22825;&#30340;&#25968;&#25454;&#65292;&#39044;&#27979;4&#20010;&#23567;&#26102;&#20043;&#21518;&#65292;&#30913;&#30424;&#20998;&#21306;&#30340;&#31354;&#38388;&#20250;&#19981;&#20250;&#23567;&#20110;0
</span><span style="color: #0000ff;">predict_linear</span>(node_filesystem_files_free{<span style="color: #a0522d;">mountpoint</span>=<span style="color: #8b2252;">"/"</span>}[1d], 4*3600) &lt; 0
</pre>
</div>

<p>
absent()ï¼šå¦‚æœæ ·æœ¬æ•°æ®ä¸ä¸ºç©ºåˆ™è¿”å›no dataï¼Œå¦‚æœä¸ºç©ºåˆ™è¿”å›1ã€‚åˆ¤æ–­æ•°æ®æ˜¯å¦åœ¨æ­£å¸¸é‡‡é›†ã€‚
</p>
</div>
</div>
<div id="outline-container-h:1752ba3d-ef89-45cd-9ee7-3fcc835e70e6" class="outline-4">
<h4 id="h:1752ba3d-ef89-45cd-9ee7-3fcc835e70e6">å»é™¤å°æ•°ç‚¹ï¼š</h4>
<div class="outline-text-4" id="text-h:1752ba3d-ef89-45cd-9ee7-3fcc835e70e6">
<ul class="org-ul">
<li>ceil()ï¼šå››èˆäº”å…¥ï¼Œå‘ä¸Šå–æœ€æ¥è¿‘çš„æ•´æ•°ï¼Œ2.79 ä¸º 3</li>
<li>floorï¼šå‘ä¸‹å–ï¼Œ 2.79 ä¸º 2</li>
</ul>

<p>
delta()ï¼šå·®å€¼ å’Œ increase ç›¸ä¼¼
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">1 &#23567;&#26102;&#30340;&#30913;&#30424;&#24046;
</span><span style="color: #0000ff;">delta</span>(node_filesystem_files_free[1h])
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3eabcc4b-aa43-4d81-9212-c1accaab7af3" class="outline-4">
<h4 id="h:3eabcc4b-aa43-4d81-9212-c1accaab7af3">æ’åºï¼š</h4>
<div class="outline-text-4" id="text-h:3eabcc4b-aa43-4d81-9212-c1accaab7af3">
<ul class="org-ul">
<li>sortï¼šæ­£åº</li>
<li>sort_descï¼šå€’å™</li>
</ul>
<p>
èŒƒä¾‹ï¼š
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">sort</span>(node_filesystem_files_free)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e21789fc-4541-48df-a696-674dbd5d694a" class="outline-4">
<h4 id="h:e21789fc-4541-48df-a696-674dbd5d694a">æ–° label</h4>
<div class="outline-text-4" id="text-h:e21789fc-4541-48df-a696-674dbd5d694a">
<p>
label_joinï¼šå°†æ•°æ®ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªlabelçš„å€¼èµ‹å€¼ç»™ä¸€ä¸ªæ–° labelï¼Œä»¥åå¯é’ˆå¯¹æ–° label åšæŸ¥è¯¢
</p>

<p>
èŒƒä¾‹ï¼š
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558; instance, mountpoint &#36171;&#32473;&#26032; label new_label&#65292;&#29992; , &#36887;&#21495;&#26469;&#20570;&#20998;&#38548;&#31526;
</span><span style="color: #0000ff;">label_join</span>(node_filesystem_files_free, <span style="color: #8b2252;">"new_label"</span>, <span style="color: #8b2252;">","</span>,  <span style="color: #8b2252;">"instance"</span>, <span style="color: #8b2252;">"mountpoint"</span>)
</pre>
</div>

<p>
label_replaceï¼šæ ¹æ®æ•°æ®ä¸­çš„æŸä¸ªlabelå€¼ï¼Œè¿›è¡Œæ­£åˆ™åŒ¹é…ï¼Œç„¶åèµ‹å€¼ç»™æ–°labelå¹¶æ·»åŠ åˆ°æ•°æ®ä¸­
</p>

<p>
èŒƒä¾‹ï¼š
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558; instance &#20013;&#31532; 2 &#20010;&#20540;&#32473; host &#26631;&#31614;
</span><span style="color: #0000ff;">label_replace</span>(node_filesystem_files_free, <span style="color: #8b2252;">"host"</span>,<span style="color: #8b2252;">"$2"</span>, <span style="color: #8b2252;">"instance"</span>, <span style="color: #8b2252;">"(.*)-(.*)"</span>)
</pre>
</div>

<p>
èŒƒä¾‹
</p>
<div class="org-src-container">
<pre class="src src-shell">groups:
- name: cardgames
  rules:
  - alert: rummy_user_thread_pending_task
    expr: thread_pending_task{<span style="color: #a0522d;">service</span>=<span style="color: #8b2252;">"rummy-user"</span>} &gt; 100
    <span style="color: #b22222;">#</span><span style="color: #b22222;">expr: 1 - avg by (instance, job, mode) (irate(node_cpu_seconds_total{mode="idle", instance="172.21.89.124:9100"}[5m])) &gt; 0
</span>    <span style="color: #a020f0;">for</span>: 1m
    labels:
      severity: warning
      team: cardgames-rummy
    annotations:
      runbook_url: https://paytmfirstgames.atlassian.net/l/c/xxxx
      summary: <span style="color: #8b2252;">"Rummy-user thread_pending_task is too high."</span>
      description: <span style="color: #8b2252;">"warning | The thread_pending_task value of {{ $labels.service }} {{ $labels.instance }} thread \"{{ $labels.thread }}\" is {{ $value }} &gt; 100  [Time: 1m]."</span>
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:ebf11448-544f-4033-818f-50dc637f98a4" class="outline-2">
<h2 id="h:ebf11448-544f-4033-818f-50dc637f98a4">Alertmanagerå‘Šè­¦å®æˆ˜</h2>
<div class="outline-text-2" id="text-h:ebf11448-544f-4033-818f-50dc637f98a4">
</div>
<div id="outline-container-h:14985a1c-644e-465f-b1b5-106d3fd47468" class="outline-3">
<h3 id="h:14985a1c-644e-465f-b1b5-106d3fd47468">Alertmanager ç›‘æ§æŠ¥è­¦</h3>
<div class="outline-text-3" id="text-h:14985a1c-644e-465f-b1b5-106d3fd47468">
<p>
alertmanager æ˜¯å‘Šè­¦ç»„ä»¶ï¼Œæ¥æ”¶ prometheus ç›‘æ§çš„é…ç½®è§¦å‘çš„å‘Šè­¦
</p>

<p>
èŒƒä¾‹ï¼šprometheus.yml å‘Šè­¦é…ç½®
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">Alertmanager configuration
</span>alerting:
  alertmanagers:
  - static_configs:
    - targets:
       - <span style="color: #8b2252;">"127.0.0.1:9093"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
</span>rule_files:
  <span style="color: #b22222;"># </span><span style="color: #b22222;">- "first_rules.yml"
</span>    - <span style="color: #8b2252;">"alerts.yaml"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0d71079c-d30e-487e-a7ef-b71182734df0" class="outline-3">
<h3 id="h:0d71079c-d30e-487e-a7ef-b71182734df0">alertmanager é…ç½®æ–‡ä»¶è§£æ</h3>
<div class="outline-text-3" id="text-h:0d71079c-d30e-487e-a7ef-b71182734df0">
<p>
alert æ¨¡æ¿ï¼š<a href="https://github.com/dotbalo/k8s/blob/master/prometheus-operator/alertmanager.yaml">https://github.com/dotbalo/k8s/blob/master/prometheus-operator/alertmanager.yaml</a>
</p>

<p>
prometheus Stack ä¸­ç›´æ¥æ”¹ manifests/alertmanager-secret.yaml æ–‡ä»¶
</p>

<p>
é™¤äº†ä¿®æ”¹ secrets æ–‡ä»¶è¿˜å¯ä»¥ä½¿ç”¨ crd AlertmanagerConfigï¼ˆ0.22 ç‰ˆæœ¬æ”¯æŒï¼‰ï¼š <a href="https://github.com/prometheus-operator/prometheus-operator/blob/main/example/user-guides/alerting/alertmanager-config-example.yaml">https://github.com/prometheus-operator/prometheus-operator/blob/main/example/user-guides/alerting/alertmanager-config-example.yaml</a>
</p>

<p>
alertmanager.yamlæ–‡ä»¶è¯´æ˜
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">global&#22359;&#37197;&#32622;&#19979;&#30340;&#37197;&#32622;&#36873;&#39033;&#22312;&#26412;&#37197;&#32622;&#25991;&#20214;&#20869;&#30340;&#25152;&#26377;&#37197;&#32622;&#39033;&#19979;&#21487;&#35265;
</span>global:
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;Alertmanager&#20869;&#31649;&#29702;&#30340;&#27599;&#19968;&#26465;&#21578;&#35686;&#22343;&#26377;&#20004;&#31181;&#29366;&#24577;: "resolved"&#25110;&#32773;"firing". &#22312;altermanager&#39318;&#27425;&#21457;&#36865;&#21578;&#35686;&#36890;&#30693;&#21518;, &#35813;&#21578;&#35686;&#20250;&#19968;&#30452;&#22788;&#20110;firing&#29366;&#24577;,&#35774;&#32622;resolve_timeout&#21487;&#20197;&#25351;&#23450;&#22788;&#20110;firing&#29366;&#24577;&#30340;&#21578;&#35686;&#38388;&#38548;&#22810;&#38271;&#26102;&#38388;&#20250;&#34987;&#35774;&#32622;&#20026;resolved&#29366;&#24577;, &#22312;&#35774;&#32622;&#20026;resolved&#29366;&#24577;&#30340;&#21578;&#35686;&#21518;,altermanager&#19981;&#20250;&#20877;&#21457;&#36865;firing&#30340;&#21578;&#35686;&#36890;&#30693;.
</span>  resolve_timeout: 1h

  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#37038;&#20214;&#21578;&#35686;&#37197;&#32622;
</span>  smtp_smarthost: <span style="color: #8b2252;">'smtp.qq.com:465'</span>
  smtp_from: <span style="color: #8b2252;">'alert@xxx.com'</span>
  smtp_auth_username: <span style="color: #8b2252;">'aff@xxx.com'</span>
  smtp_auth_password: <span style="color: #8b2252;">'xxx'</span>
  smtp_require_tls: false  
  <span style="color: #b22222;"># </span><span style="color: #b22222;">HipChat&#21578;&#35686;&#37197;&#32622;
</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">hipchat_auth_token: '123456789'
</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">hipchat_auth_url: 'https://hipchat.foobar.org/'
</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">wechat
</span>  wechat_api_url: <span style="color: #8b2252;">'https://qyapi.weixin.qq.com/cgi-bin/'</span>
  wechat_api_secret: <span style="color: #8b2252;">'JJ'</span>
  wechat_api_corp_id: <span style="color: #8b2252;">'ww'</span>

  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21578;&#35686;&#36890;&#30693;&#27169;&#26495;&#65292;&#23448;&#26041;&#33258;&#24102;&#27604;&#36739;&#20840;&#65292;&#27809;&#24517;&#35201;&#33258;&#24049;&#23450;
</span>templates:
- <span style="color: #8b2252;">'/etc/alertmanager/config/*.tmpl'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">route: &#26681;&#36335;&#30001;,&#35813;&#27169;&#22359;&#29992;&#20110;&#35813;&#26681;&#36335;&#30001;&#19979;&#30340;&#33410;&#28857;&#21450;&#23376;&#36335;&#30001;routes&#30340;&#23450;&#20041;. &#23376;&#26641;&#33410;&#28857;&#22914;&#26524;&#19981;&#23545;&#30456;&#20851;&#37197;&#32622;&#36827;&#34892;&#37197;&#32622;&#65292;&#21017;&#40664;&#35748;&#20250;&#20174;&#29238;&#36335;&#30001;&#26641;&#32487;&#25215;&#35813;&#37197;&#32622;&#36873;&#39033;&#12290;&#27599;&#19968;&#26465;&#21578;&#35686;&#37117;&#35201;&#36827;&#20837;route&#65292;&#21363;&#35201;&#27714;&#37197;&#32622;&#36873;&#39033;group_by&#30340;&#20540;&#33021;&#22815;&#21305;&#37197;&#21040;&#27599;&#19968;&#26465;&#21578;&#35686;&#30340;&#33267;&#23569;&#19968;&#20010;labelkey(&#21363;&#36890;&#36807;POST&#35831;&#27714;&#21521;altermanager&#26381;&#21153;&#25509;&#21475;&#25152;&#21457;&#36865;&#21578;&#35686;&#30340;labels&#39033;&#25152;&#25658;&#24102;&#30340;&lt;labelname&gt;)&#65292;&#21578;&#35686;&#36827;&#20837;&#21040;route&#21518;&#65292;&#23558;&#20250;&#26681;&#25454;&#23376;&#36335;&#30001;routes&#33410;&#28857;&#20013;&#30340;&#37197;&#32622;&#39033;match_re&#25110;&#32773;match&#26469;&#30830;&#23450;&#33021;&#36827;&#20837;&#35813;&#23376;&#36335;&#30001;&#33410;&#28857;&#30340;&#21578;&#35686;(&#30001;&#22312;match_re&#25110;&#32773;match&#19979;&#37197;&#32622;&#30340;labelkey: labelvalue&#26159;&#21542;&#20026;&#21578;&#35686;labels&#30340;&#23376;&#38598;&#20915;&#23450;&#65292;&#26159;&#30340;&#35805;&#21017;&#20250;&#36827;&#20837;&#35813;&#23376;&#36335;&#30001;&#33410;&#28857;&#65292;&#21542;&#21017;&#19981;&#33021;&#25509;&#25910;&#36827;&#20837;&#35813;&#23376;&#36335;&#30001;&#33410;&#28857;).
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#36335;&#30001;&#24212;&#35813;&#21305;&#37197;&#25152;&#26377;&#21578;&#35686;
</span>route:
  <span style="color: #b22222;"># </span><span style="color: #b22222;">1&#26465;&#25110;&#32773;&#22810;&#26465;&#21578;&#35686;&#20449;&#24687;&#20013;&#21253;&#21547; group_by &#30340;&#20998;&#32452;&#26631;&#31614;&#24402;&#19968;&#32452;&#12290; &#20363;&#22914;&#25152;&#26377;labelkey:labelvalue&#21547;cluster=A&#21450;altertname=LatencyHigh labelkey&#30340;&#21578;&#35686;&#37117;&#20250;&#34987;&#24402;&#20837;&#21333;&#19968;&#32452;&#20013;
</span>  group_by: [<span style="color: #8b2252;">'job'</span>, <span style="color: #8b2252;">'altername'</span>, <span style="color: #8b2252;">'cluster'</span>, <span style="color: #8b2252;">'service'</span>,<span style="color: #8b2252;">'severity'</span>]
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21578;&#35686;&#29366;&#24577;&#20174; pending &#21040; firing &#30495;&#27491;&#21457;&#36865;&#30340;&#31561;&#24453;&#26102;&#38388;&#12290; &#21363; &#33509;&#19968;&#32452;&#26032;&#30340;&#21578;&#35686;&#20135;&#29983;&#65292;&#21017;&#20250;&#31561;group_wait&#21518;&#20877;&#21457;&#36865;&#36890;&#30693;&#65292;&#35813;&#21151;&#33021;&#20027;&#35201;&#29992;&#20110;&#24403;&#21578;&#35686;&#22312;&#24456;&#30701;&#26102;&#38388;&#20869;&#25509;&#36830;&#20135;&#29983;&#26102;&#65292;&#22312;group_wait&#20869;&#21512;&#24182;&#20026;&#21333;&#19968;&#30340;&#21578;&#35686;&#21518;&#20877;&#21457;&#36865;
</span>  group_wait: 30s
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20877;&#27425;&#21578;&#35686;&#26102;&#38388;&#38388;&#38548;
</span>  group_interval: 5m
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#19968;&#26465;&#21578;&#35686;&#36890;&#30693;&#24050;&#25104;&#21151;&#21457;&#36865;&#65292;&#19988;&#22312;&#38388;&#38548;repeat_interval&#21518;&#65292;&#35813;&#21578;&#35686;&#20173;&#28982;&#26410;&#34987;&#35774;&#32622;&#20026;resolved&#65292;&#21017;&#20250;&#20877;&#27425;&#21457;&#36865;&#35813;&#21578;&#35686;&#36890;&#30693;
</span>  repeat_interval: 12h
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;&#21578;&#35686;&#36890;&#30693;&#25509;&#25910;&#32773;&#65292;&#20961;&#26410;&#34987;&#21305;&#37197;&#36827;&#20837;&#21508;&#23376;&#36335;&#30001;&#33410;&#28857;&#30340;&#21578;&#35686;&#22343;&#34987;&#21457;&#36865;&#21040;&#27492;&#25509;&#25910;&#32773;
</span>  receiver: <span style="color: #8b2252;">'wechat'</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19978;&#36848;route&#30340;&#37197;&#32622;&#20250;&#34987;&#20256;&#36882;&#32473;&#23376;&#36335;&#30001;&#33410;&#28857;&#65292;&#23376;&#36335;&#30001;&#33410;&#28857;&#36827;&#34892;&#37325;&#26032;&#37197;&#32622;&#25165;&#20250;&#34987;&#35206;&#30422;
</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23376;&#36335;&#30001;&#26641;
</span>  routes:
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35813;&#37197;&#32622;&#36873;&#39033;&#20351;&#29992;&#27491;&#21017;&#34920;&#36798;&#24335;&#26469;&#21305;&#37197;&#21578;&#35686;&#30340;labels&#65292;&#20197;&#30830;&#23450;&#33021;&#21542;&#36827;&#20837;&#35813;&#23376;&#36335;&#30001;&#26641;
</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">match_re&#21644;match&#22343;&#29992;&#20110;&#21305;&#37197;labelkey&#20026;service,labelvalue&#20998;&#21035;&#20026;&#25351;&#23450;&#20540;&#30340;&#21578;&#35686;&#65292;&#34987;&#21305;&#37197;&#21040;&#30340;&#21578;&#35686;&#20250;&#23558;&#36890;&#30693;&#21457;&#36865;&#21040;&#23545;&#24212;&#30340;receiver
</span>  - match_re:
      service: ^(foo1|foo2|baz)$
    receiver: <span style="color: #8b2252;">'wechat'</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;&#24102;&#26377;service&#26631;&#31614;&#30340;&#21578;&#35686;&#21516;&#26102;&#26377;severity&#26631;&#31614;&#26102;&#65292;&#20182;&#21487;&#20197;&#26377;&#33258;&#24049;&#30340;&#23376;&#36335;&#30001;&#65292;&#21516;&#26102;&#20855;&#26377;severity != critical&#30340;&#21578;&#35686;&#21017;&#34987;&#21457;&#36865;&#32473;&#25509;&#25910;&#32773;team-ops-mails,&#23545;severity == critical&#30340;&#21578;&#35686;&#21017;&#34987;&#21457;&#36865;&#21040;&#23545;&#24212;&#30340;&#25509;&#25910;&#32773;&#21363;team-ops-pager
</span>    <span style="color: #a020f0;">continue</span>: true <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21305;&#37197;&#21040;&#19978;&#38754;&#26465;&#20214;&#21518;&#26159;&#21542;&#32487;&#32493;&#21305;&#37197;
</span>    routes: <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23884;&#22871; routes
</span>    - match:
        severity: critical
      receiver: <span style="color: #8b2252;">'wechat'</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27604;&#22914;&#20851;&#20110;&#25968;&#25454;&#24211;&#26381;&#21153;&#30340;&#21578;&#35686;&#65292;&#22914;&#26524;&#23376;&#36335;&#30001;&#27809;&#26377;&#21305;&#37197;&#21040;&#30456;&#24212;&#30340;owner&#26631;&#31614;&#65292;&#21017;&#37117;&#40664;&#35748;&#30001;team-DB-pager&#25509;&#25910;
</span>  - match:
      service: database
    group_by: [<span style="color: #8b2252;">'job'</span>]
    <span style="color: #a020f0;">continue</span>: true
    receiver: <span style="color: #8b2252;">'wechat'</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25105;&#20204;&#20063;&#21487;&#20197;&#20808;&#26681;&#25454;&#26631;&#31614;service:database&#23558;&#25968;&#25454;&#24211;&#26381;&#21153;&#21578;&#35686;&#36807;&#28388;&#20986;&#26469;&#65292;&#28982;&#21518;&#36827;&#19968;&#27493;&#23558;&#25152;&#26377;&#21516;&#26102;&#24102;labelkey&#20026;database
</span>  - match:
      severity: critical
    receiver: <span style="color: #8b2252;">'wechat'</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25233;&#21046;&#35268;&#21017;&#65292;&#24403;&#20986;&#29616;critical&#21578;&#35686;&#26102; &#24573;&#30053;warning
</span>inhibit_rules:
- source_match:
    severity: <span style="color: #8b2252;">'critical'</span>
  target_match:
    severity: <span style="color: #8b2252;">'warning'</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">Apply inhibition if the alertname is the same.
</span>  <span style="color: #b22222;">#   </span><span style="color: #b22222;">equal: ['alertname', 'cluster', 'service']
</span>  <span style="color: #b22222;">#</span><span style="color: #b22222;">
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#25910;&#20214;&#20154;&#37197;&#32622;
</span>receivers:
- name: <span style="color: #8b2252;">'team-ops-mails'</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#37038;&#20214;&#21578;&#35686;
</span>  email_configs:
  - to: <span style="color: #8b2252;">'dukuan@xxx.com'</span>
- name: <span style="color: #8b2252;">'wechat'</span>          <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24494;&#20449;&#21578;&#35686;
</span>  wechat_configs:
  - send_resolved: true   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25253;&#35686;&#35299;&#20915;&#30340;&#36890;&#36807;&#26159;&#21542;&#21457;&#36865;
</span>    corp_id: <span style="color: #8b2252;">'ww'</span>
    api_secret: <span style="color: #8b2252;">'JJ'</span>
    to_tag: <span style="color: #8b2252;">'1'</span>
    agent_id: <span style="color: #8b2252;">'1000002'</span>
    api_url: <span style="color: #8b2252;">'https://qyapi.weixin.qq.com/cgi-bin/'</span>
    message: <span style="color: #8b2252;">'{{ template "wechat.default.message" . }}'</span>
- name: <span style="color: #8b2252;">'xxx-slack'</span>     <span style="color: #b22222;"># </span><span style="color: #b22222;">slack &#21578;&#35686;
</span>  slack_configs:
    - api_url: <span style="color: #8b2252;">"https://hooks.slack.com/services/T02/c"</span>
      channel: <span style="color: #8b2252;">"#xxx-base-alert"</span>
      text: <span style="color: #8b2252;">"{{ range .Alerts }}{{ .Annotations.summary }}\n Value: {{ .Annotations.description }}\n{{ end }}"</span>
- name: <span style="color: #8b2252;">"default-receiver"</span>
  webhook_configs:
  - url: <span style="color: #8b2252;">'http://127.0.0.1:5000/'</span>
    send_resolved: true
<span style="color: #b22222;">#</span><span style="color: #b22222;">- name: 'team-X-pager'
</span><span style="color: #b22222;">#  </span><span style="color: #b22222;">email_configs:
</span><span style="color: #b22222;">#  </span><span style="color: #b22222;">- to: 'team-X+alerts-critical@example.org'
</span><span style="color: #b22222;">#  </span><span style="color: #b22222;">pagerduty_configs:
</span><span style="color: #b22222;">#  </span><span style="color: #b22222;">- service_key: &lt;team-X-key&gt;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">- name: 'team-Y-mails'
</span><span style="color: #b22222;">#  </span><span style="color: #b22222;">email_configs:
</span><span style="color: #b22222;">#  </span><span style="color: #b22222;">- to: 'team-Y+alerts@example.org'
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">- name: 'team-Y-pager'
</span><span style="color: #b22222;">#  </span><span style="color: #b22222;">pagerduty_configs:
</span><span style="color: #b22222;">#  </span><span style="color: #b22222;">- service_key: &lt;team-Y-key&gt;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">- name: 'team-DB-pager'
</span><span style="color: #b22222;">#  </span><span style="color: #b22222;">pagerduty_configs:
</span><span style="color: #b22222;">#  </span><span style="color: #b22222;">- service_key: &lt;team-DB-key&gt;
</span><span style="color: #b22222;">#  </span><span style="color: #b22222;">
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">- name: 'team-X-hipchat'
</span><span style="color: #b22222;">#  </span><span style="color: #b22222;">hipchat_configs:
</span><span style="color: #b22222;">#  </span><span style="color: #b22222;">- auth_token: &lt;auth_token&gt;
</span><span style="color: #b22222;">#    </span><span style="color: #b22222;">room_id: 85
</span><span style="color: #b22222;">#    </span><span style="color: #b22222;">message_format: html
</span><span style="color: #b22222;">#    </span><span style="color: #b22222;">notify: true
</span>
time_intervals: <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38745;&#38899;/&#28608;&#27963;&#36335;&#32447;&#30340;&#26102;&#38388;&#38388;&#38548;&#21015;&#34920;</span>
</pre>
</div>



<p>
slackï¼Œwebhookç­‰å…¶å®ƒæŠ¥è­¦é…ç½®å‚è€ƒ
<a href="https://prometheus.io/docs/alerting/latest/configuration/#email_config">https://prometheus.io/docs/alerting/latest/configuration/#email_config</a>
</p>


<p>
æ¸©é¦¨æç¤ºï¼šå¦‚æœæ²¡æœ‰ä½¿ç”¨ratel(è‡ªç ”å·¥å…·)ï¼Œå¯ä»¥ä½¿ç”¨secretçƒ­æ›´æ–°çš„æ–¹å¼æ›´æ”¹é…ç½®æ–‡ä»¶ï¼Œå…·ä½“æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š
</p>
<div class="org-src-container">
<pre class="src src-shell">vim alertmanager.yaml
<span style="color: #8b2252;">"global"</span>:
  <span style="color: #8b2252;">"resolve_timeout"</span>: <span style="color: #8b2252;">"2h"</span>
  smtp_from: <span style="color: #8b2252;">"kubernetes_guide@163.com"</span>
  smtp_smarthost: <span style="color: #8b2252;">"smtp.163.com:465"</span>
  smtp_hello: <span style="color: #8b2252;">"163.com"</span>
  smtp_auth_username: <span style="color: #8b2252;">"kubernetes_guide@163.com"</span>
  smtp_auth_password: <span style="color: #8b2252;">"DYKEBOEGTFSEUGVY"</span>
  smtp_require_tls: false
  <span style="color: #b22222;"># </span><span style="color: #b22222;">wechat
</span>  wechat_api_url: <span style="color: #8b2252;">'https://qyapi.weixin.qq.com/cgi-bin/'</span>
  wechat_api_secret: <span style="color: #8b2252;">'ZZQt0Ue9mtplH9u1g8PhxR_RxEnRu512CQtmBn6R2x0'</span>
  wechat_api_corp_id: <span style="color: #8b2252;">'wwef86a30130f04f2b'</span>
<span style="color: #8b2252;">"inhibit_rules"</span>:
- <span style="color: #8b2252;">"equal"</span>:
  - <span style="color: #8b2252;">"namespace"</span>
  - <span style="color: #8b2252;">"alertname"</span>
  <span style="color: #8b2252;">"source_match"</span>:
    <span style="color: #8b2252;">"severity"</span>: <span style="color: #8b2252;">"critical"</span>
  <span style="color: #8b2252;">"target_match_re"</span>:
    <span style="color: #8b2252;">"severity"</span>: <span style="color: #8b2252;">"warning|info"</span>
- <span style="color: #8b2252;">"equal"</span>:
  - <span style="color: #8b2252;">"namespace"</span>
  - <span style="color: #8b2252;">"alertname"</span>
  <span style="color: #8b2252;">"source_match"</span>:
    <span style="color: #8b2252;">"severity"</span>: <span style="color: #8b2252;">"warning"</span>
  <span style="color: #8b2252;">"target_match_re"</span>:
    <span style="color: #8b2252;">"severity"</span>: <span style="color: #8b2252;">"info"</span>
<span style="color: #8b2252;">"receivers"</span>:
- <span style="color: #8b2252;">"name"</span>: <span style="color: #8b2252;">"Default"</span>
  <span style="color: #8b2252;">"email_configs"</span>: 
  - to: <span style="color: #8b2252;">"kubernetes_guide@163.com"</span>
    send_resolved: true
- <span style="color: #8b2252;">"name"</span>: <span style="color: #8b2252;">"Watchdog"</span>
  <span style="color: #8b2252;">"email_configs"</span>: 
  - to: <span style="color: #8b2252;">"kubernetes_guide@163.com"</span>
    send_resolved: true
- <span style="color: #8b2252;">"name"</span>: <span style="color: #8b2252;">"Critical"</span>
  <span style="color: #8b2252;">"email_configs"</span>: 
  - to: <span style="color: #8b2252;">"kubernetes_guide@163.com"</span>
    send_resolved: true
- name: <span style="color: #8b2252;">'wechat'</span>
  wechat_configs:
  - send_resolved: true
    to_tag: <span style="color: #8b2252;">'1'</span>
    agent_id: <span style="color: #8b2252;">'1000003'</span>
<span style="color: #8b2252;">"route"</span>:
  <span style="color: #8b2252;">"group_by"</span>:
  - <span style="color: #8b2252;">"namespace"</span>
  <span style="color: #8b2252;">"group_interval"</span>: <span style="color: #8b2252;">"1m"</span>
  <span style="color: #8b2252;">"group_wait"</span>: <span style="color: #8b2252;">"30s"</span>
  <span style="color: #8b2252;">"receiver"</span>: <span style="color: #8b2252;">"Default"</span>
  <span style="color: #8b2252;">"repeat_interval"</span>: <span style="color: #8b2252;">"1m"</span>
  <span style="color: #8b2252;">"routes"</span>:
  - <span style="color: #8b2252;">"match"</span>:
      <span style="color: #8b2252;">"alertname"</span>: <span style="color: #8b2252;">"Watchdog"</span>
    <span style="color: #8b2252;">"receiver"</span>: <span style="color: #8b2252;">"wechat"</span>
  - <span style="color: #8b2252;">"match"</span>:
      <span style="color: #8b2252;">"severity"</span>: <span style="color: #8b2252;">"critical"</span>
    <span style="color: #8b2252;">"receiver"</span>: <span style="color: #8b2252;">"Critical"</span>
</pre>
</div>

<p>
æŸ¥çœ‹é…ç½®æ˜¯å¦åŠ è½½æˆåŠŸ
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl logs -f alertmanager-main-0 -n monitoring alertmanager
</pre>
</div>

<p>
alertmanager æŠ‘åˆ¶å‘Šè­¦
</p>
<ul class="org-ul">
<li>åœ¨é¡µé¢å‘Šè­¦æ¡ç›®æ—è¾¹ç‚¹ silencesï¼Œå–æ¶ˆç‚¹å‡» expire</li>
</ul>

<p>
Alertmanager çš„é…ç½®ä¸»è¦åˆ†ä¸ºäº”å¤§å—ï¼š
</p>
<ul class="org-ul">
<li>globalï¼šå…¨å±€é…ç½®ï¼Œä¸»è¦ç”¨æ¥é…ç½®ä¸€äº›é€šç”¨çš„é…ç½®ã€‚å¦‚é‚®ä»¶é€šçŸ¥çš„è´¦å·ã€å¯†ç ã€SMTP æœåŠ¡å™¨ã€å¾®ä¿¡å‘Šè­¦ç­‰ã€‚æ–‡ä»¶å†…å…¶å®ƒä½ç½®çš„å­é…ç½®å¯ä»¥è¦†ç›– global é…ç½®ï¼›</li>
<li>templatesï¼šç”¨äºæ”¾ç½®è‡ªå®šä¹‰æ¨¡æ¿çš„ä½ç½®ï¼›</li>
<li>routeï¼šå‘Šè­¦è·¯ç”±é…ç½®ï¼Œç”¨äºå‘Šè­¦ä¿¡æ¯çš„åˆ†ç»„è·¯ç”±ï¼Œå¯ä»¥å°†ä¸åŒåˆ†ç»„çš„å‘Šè­¦å‘é€ç»™ä¸åŒçš„æ¥æ”¶äººï¼›å¦‚æ•°æ®åº“å‘Šè­¦å‘ç»™ DBAï¼ŒæœåŠ¡å™¨å‘Šè­¦å‘ç»™ OPSï¼› inhibit_rulesï¼šå‘Šè­¦æŠ‘åˆ¶ï¼Œä¸»è¦ç”¨äºå‡å°‘å‘Šè­¦çš„æ¬¡æ•°ï¼Œé˜²æ­¢"å‘Šè­¦è½°ç‚¸"ã€‚æ¯”å¦‚æŸä¸ªå®¿ä¸»æœºå®•æœºï¼Œå¯èƒ½ä¼šå¼•èµ·å®¹å™¨é‡å»ºã€æ¼‚ç§»ã€æœåŠ¡ä¸å¯ç”¨ç­‰ä¸€ç³»åˆ—é—®é¢˜ï¼Œå¦‚æœæ¯ä¸ªå¼‚å¸¸å‡æœ‰å‘Šè­¦ï¼Œä¼šä¸€æ¬¡æ€§å‘é€å¾ˆå¤šå‘Šè­¦ï¼Œé€ æˆå‘Šè­¦è½°ç‚¸ï¼Œå¹¶ä¸”ä¹Ÿä¼šå¹²æ‰°å®šä½é—®é¢˜çš„æ€è·¯ï¼Œæ‰€ä»¥å¯ç”¨ä½¿ç”¨å‘Šè­¦æŠ‘åˆ¶ï¼Œå±è”½ç”±å®¿ä¸»æœºå®•æœºå¼•æ¥çš„å…¶ä»–é—®é¢˜ï¼Œåªå‘é€å®¿ä¸»æœºå®•æœºçš„æ¶ˆæ¯å³å¯ï¼›</li>
<li>receiversï¼šå‘Šè­¦ æ¥æ”¶äººé…ç½®ï¼Œæ¯ä¸ª receiver éƒ½æœ‰ä¸€ä¸ªåå­—ï¼Œç»è¿‡ route åˆ†ç»„å¹¶ä¸”è·¯ç”±åéœ€è¦æŒ‡å®šä¸€ä¸ª receiverï¼Œå°±æ˜¯åœ¨æ­¤ä½ç½®é…ç½®çš„ã€‚</li>
</ul>
</div>
</div>
<div id="outline-container-h:cd3fbfce-e27c-436e-94b5-37e632d3c1d4" class="outline-3">
<h3 id="h:cd3fbfce-e27c-436e-94b5-37e632d3c1d4">route-è·¯ç”±è§„åˆ™</h3>
<div class="outline-text-3" id="text-h:cd3fbfce-e27c-436e-94b5-37e632d3c1d4">
<p>
å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://prometheus.io/docs/alerting/latest/configuration/#route">https://prometheus.io/docs/alerting/latest/configuration/#route</a>
</p>

<div class="org-src-container">
<pre class="src src-yaml">route:
  group_by: 
  - namespace
  - job
  - alertname
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'Default'
  # ä¸Šè¿°routeçš„é…ç½®ä¼šè¢«ä¼ é€’ç»™å­è·¯ç”±èŠ‚ç‚¹ï¼Œå­è·¯ç”±èŠ‚ç‚¹è¿›è¡Œé‡æ–°é…ç½®æ‰ä¼šè¢«è¦†ç›–

  # å­è·¯ç”±æ ‘
  routes:
  - receiver: 'db-webhook-p1'
    group_wait: 10s
    group_interval: 30s
    repeat_interval: 30m
    group_by: [dbtype] # æŒ‰ dbtype é‡æ–°åˆ†ç»„
    matchers:
    - DB_Priority = P1
    - dbtype =~ "db.*"
  - receiver: 'wechat'
    match_re:
      service: ^(foo1|foo2|baz)$
    continue: true # åŒ¹é…åˆ°ä¸Šé¢æ¡ä»¶åæ˜¯å¦ç»§ç»­åŒ¹é…
    routes: # åµŒå¥— routes
    - match:
        severity: critical
      receiver: 'wechat'
  - receiver: 'dev-pager'
    matchers:
      - service="inhouse-service"
    mute_time_intervals:  # è·¯çº¿å°†åœ¨éå·¥ä½œæ—¶é—´å’ŒèŠ‚å‡æ—¥æ—¶é—´é—´éš”å†…é™éŸ³ã€‚
      - offhours
      - holidays
    continue: true  # å³ä½¿å®ƒåŒ¹é…ï¼Œå®ƒå°†ç»§ç»­åˆ°ä¸‹ä¸€ä¸ªå­è·¯ç”±

  - receiver: 'on-call-pager'
    matchers:
      - service="inhouse-service"
    active_time_intervals:  # ä»…åœ¨éå·¥ä½œæ—¶é—´å’ŒèŠ‚å‡æ—¥æ—¶é—´é—´éš”å†…æœ‰æ•ˆã€‚
      - offhours
      - holidays
  - receiver: 'default-receiver'
    group_wait: 10s
    group_interval: 30s
    repeat_interval: 30m
    group_by: ['job']
    match_re:
      job: ".*"

time_intervals:
- name: offhours
  time_intervals:
  - times:
    - start_time: 20:00
      end_time: 23:00
    weekdays: ['monday:wednesday','saturday', 'sunday']
    days_of_month: ['1:5', '-3:-1']
    months: ['may:august']
    years: ['2020:2022']
    location: Asia/Kolkata
- name: holidays
  time_intervals:
  - times:
    - start_time: 20:00
      end_time: 23:00
    weekdays: ['monday:wednesday','saturday', 'sunday']
    days_of_month: ['1:7']
    months: ['december']
    years: ['2020:2022']
</pre>
</div>

<p>
route è¯´æ˜ï¼š
</p>
<ul class="org-ul">
<li>routesï¼šå¯åµŒå¥—å­è·¯ç”±</li>
<li>receiverï¼šå‘Šè­¦çš„é€šçŸ¥ç›®æ ‡ï¼Œéœ€è¦å’Œ receivers é…ç½®ä¸­çš„ name è¿›è¡ŒåŒ¹é…ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ route.routes ä¸‹ä¹Ÿå¯ä»¥æœ‰ receiver é…ç½®ï¼Œä¼˜å…ˆçº§é«˜äº route.receiver é…ç½®çš„é»˜è®¤æ¥æ”¶äººã€‚å½“å‘Šè­¦æ²¡æœ‰åŒ¹é…åˆ°å­è·¯ç”±æ—¶ï¼Œä¼šä½¿ç”¨ route.receiver è¿›è¡Œé€šçŸ¥ï¼Œæ¯”å¦‚ä¸Šè¿°é…ç½®ä¸­çš„ Default;</li>
<li>group_byï¼šåˆ†ç»„é…ç½®ï¼Œå€¼ç±»å‹ä¸ºåˆ—è¡¨ã€‚æ¯”å¦‚é…ç½®æˆ['job','serverity']ï¼Œä»£è¡¨å‘Šè­¦ä¿¡æ¯åŒ…å« job å’Œ severity æ ‡ç­¾çš„ä¼šè¿›è¡Œåˆ†ç»„ï¼Œä¸”æ ‡ç­¾çš„ key å’Œ value éƒ½ç›¸åŒæ‰ä¼šè¢«åˆ†åˆ°ä¸€ç»„ï¼›</li>
<li>countinue: å†³å®šåŒ¹é…åˆ°ç¬¬ä¸€ä¸ªè·¯ç”±åï¼Œæ˜¯å¦ç»§ç»­åç»­åŒ¹é…ã€‚é»˜è®¤ä¸º falseï¼Œå³åŒ¹é…åˆ°ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ååœæ­¢ç»§ç»­åŒ¹é…ï¼›</li>
<li>matchï¼šç²¾ç¡®åŒ¹é…ï¼›ä¸€å¯¹ä¸€åŒ¹é…è§„åˆ™ï¼Œæ¯”å¦‚ match é…ç½®ä¸º job: mysqlï¼Œé‚£å…·æœ‰ job=mysql çš„å‘Šè­¦ä¼šè¿›å…¥è¯¥è·¯ç”±ï¼›
<ul class="org-ul">
<li>æ ‡ç­¾å¯åœ¨æ³¨å†Œç›®æ ‡æœåŠ¡æ—¶è®¾ç½®ï¼Œä¹Ÿå¯ä»¥åœ¨æŠ¥è­¦è§„åˆ™é‡Œé…ç½®</li>
</ul></li>
<li>match_reï¼šå’Œ match ç±»ä¼¼ï¼Œåªä¸è¿‡æ˜¯æ­£åˆ™åŒ¹é…ï¼›</li>
<li>matchersï¼šæ˜¯æ›¿ä»£ match å’Œ match_re çš„æ–°å†™æ³•ï¼Œ0.22 ç‰ˆæœ¬å</li>
<li>group_waitï¼šå‘Šè­¦é€šçŸ¥ç­‰å¾…ï¼Œå€¼ç±»å‹ä¸ºå­—ç¬¦ä¸²ã€‚è‹¥ä¸€ç»„æ–°çš„å‘Šè­¦äº§ç”Ÿï¼Œåˆ™ä¼šç­‰ group_wait åå†å‘é€é€šçŸ¥ï¼ˆpeing åˆ° firing çŠ¶æ€ï¼‰ï¼Œè¯¥åŠŸèƒ½ä¸»è¦ç”¨äºå½“å‘Šè­¦åœ¨å¾ˆçŸ­æ—¶é—´å†…æ¥è¿äº§ç”Ÿæ—¶ï¼Œåœ¨ group_wait å†…åˆå¹¶ä¸ºå•ä¸€çš„å‘Šè­¦åå†å‘é€ï¼Œé˜²æ­¢å‘Šè­¦è¿‡å¤šï¼Œé»˜è®¤å€¼ä¸º 30sï¼›</li>
<li>group_intervalï¼šåŒä¸€ç»„å‘Šè­¦é€šçŸ¥åï¼Œå¦‚æœæœ‰æ–°çš„å‘Šè­¦æ·»åŠ åˆ°è¯¥ç»„ä¸­ï¼Œå†æ¬¡å‘é€å‘Šè­¦é€šçŸ¥çš„æ—¶é—´ï¼Œé»˜è®¤å€¼ä¸º 5mï¼›</li>
<li>repeat_intervalï¼šå¦‚æœä¸€æ¡å‘Šè­¦é€šçŸ¥å·²ç»æˆåŠŸå‘é€ï¼Œä¸”åœ¨é—´éš” repeat_interval åï¼Œè¯¥å‘Šè­¦ä»ç„¶æœªè¢«è®¾ç½®ä¸º resovedï¼Œåˆ™ä¼šå†æ¬¡å‘é€å‘Šè­¦é€šçŸ¥ï¼Œé»˜è®¤å€¼ 4hã€‚</li>
<li>mute_time_intervals: é™éŸ³ã€‚æŒ‡å®šåç§°ä¸ time_intervals åŒ¹é…</li>
<li>active_time_intervals: æ¿€æ´»ã€‚æŒ‡å®šåç§°ä¸ time_intervals åŒ¹é…</li>
</ul>

<p>
time_intervals è¯´æ˜ï¼š
</p>

<p>
å¦‚æœæœªæŒ‡å®šå­—æ®µï¼Œåˆ™ä»»ä½•å€¼éƒ½å°†åŒ¹é…è¯¥å­—æ®µã€‚
</p>
<ul class="org-ul">
<li>time_rangeï¼šèŒƒå›´åŒ…æ‹¬å¼€å§‹æ—¶é—´ä½†ä¸åŒ…æ‹¬ç»“æŸæ—¶é—´ï¼Œä»¥ä¾¿äºè¡¨ç¤ºåœ¨å°æ—¶è¾¹ç•Œä¸Šå¼€å§‹/ç»“æŸçš„æ—¶é—´ã€‚ä¾‹å¦‚ï¼Œå¼€å§‹æ—¶é—´"20:00"å’Œç»“æŸæ—¶é—´"23:00"å°†ä» 20:00 å¼€å§‹ï¼Œå¹¶åœ¨ 23:00 ä¹‹å‰ç»“æŸã€‚</li>
<li>weekday_rangeï¼šä¸€å‘¨ä¸­çš„å‡ å¤©åˆ—è¡¨ï¼Œä¸€å‘¨ä»æ˜ŸæœŸæ—¥å¼€å§‹ï¼Œåˆ°æ˜ŸæœŸå…­ç»“æŸ. åº”æŒ‰åç§°æŒ‡å®šæ—¥æœŸï¼ˆä¾‹å¦‚"æ˜ŸæœŸæ—¥"ï¼‰. ä¸ºæ–¹ä¾¿èµ·è§ï¼ŒèŒƒå›´ä¹Ÿæ¥å—å½¢å¼ ï¼š å¹¶ä¸”åœ¨ä¸¤ç«¯éƒ½åŒ…å«. ä¾‹å¦‚ï¼š ['monday:wednesday','saturday', 'sunday']</li>
<li>days_of_month_rangeï¼šæœˆä»½ä¸­æ•°å­—å¤©æ•°çš„åˆ—è¡¨. å¤©æ•°ä» 1 å¼€å§‹.ä¹Ÿæ¥å—ä»æœˆåº•å¼€å§‹çš„è´Ÿå€¼ï¼Œä¾‹å¦‚ï¼Œ1 æœˆæœŸé—´çš„ -1 è¡¨ç¤º 1 æœˆ 31 æ—¥.ä¾‹å¦‚ï¼š ['1:5', '-3:-1']  å»¶é•¿è¶…è¿‡æœˆåˆæˆ–æœˆåº•å°†å¯¼è‡´å®ƒè¢«é’³åˆ¶. ä¾‹å¦‚ï¼Œåœ¨äºŒæœˆæŒ‡å®š['1:31']å°†æ ¹æ®é—°å¹´å°†å®é™…ç»“æŸæ—¥æœŸé™åˆ¶ä¸º 28 æˆ– 29. ä¸¤ç«¯åŒ…å®¹.</li>
<li>month_rangeï¼šç”±ä¸åŒºåˆ†å¤§å°å†™çš„åç§°ï¼ˆä¾‹å¦‚"January"ï¼‰æˆ–æ•°å­—æ ‡è¯†çš„æ—¥å†æœˆåˆ—è¡¨ï¼Œå…¶ä¸­ January = 1.ä¹Ÿæ¥å—èŒƒå›´. ä¾‹å¦‚ï¼Œ ['1:3', 'may:august', 'december'] . ä¸¤ç«¯åŒ…å®¹.</li>
<li>year_rangeï¼šå¹´ä»½çš„æ•°å­—åˆ—è¡¨. æ¥å—èŒƒå›´. ä¾‹å¦‚ï¼Œ ['2020:2022', '2030'] . ä¸¤ç«¯åŒ…å®¹.</li>
<li>location: ä¸ IANA æ—¶åŒºæ•°æ®åº“ä¸­çš„ä½ç½®åŒ¹é…çš„å­—ç¬¦ä¸²ã€‚ä¸è®¾ç½®ä¸º UTC æ—¶é—´</li>
</ul>
</div>
</div>
<div id="outline-container-h:4ba6913b-be71-47f2-b96e-73b96515d6ab" class="outline-3">
<h3 id="h:4ba6913b-be71-47f2-b96e-73b96515d6ab">receivers-å‘Šè­¦é€šçŸ¥</h3>
<div class="outline-text-3" id="text-h:4ba6913b-be71-47f2-b96e-73b96515d6ab">
<p>
å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://s0prometheus0io.icopy.site/docs/alerting/latest/configuration/#receiver">https://s0prometheus0io.icopy.site/docs/alerting/latest/configuration/#receiver</a>
</p>

<p>
ä¸€ä¸ªæ¥æ”¶äººå¯ä»¥æœ‰å¤šç§å‘é€æ–¹å¼ï¼š
</p>
<ul class="org-ul">
<li>email_configs: é‚®ä»¶é€šçŸ¥</li>
<li>wechat_configs:  å¾®ä¿¡é€šçŸ¥</li>
<li>webhook_configs: è‡ªå®šä¹‰æ¥å£ã€‚å¦‚é’‰é’‰ã€çŸ­ä¿¡ã€è‡ªå®šä¹‰è¿ç»´å¹³å°</li>
<li>slack_configs: slack é€šçŸ¥</li>
<li>opsgenie_configs:</li>
<li>pagerduty_configs:</li>
<li>pushover_configs:</li>
<li>sns_configs:</li>
<li>victorops_configs:</li>
<li>telegram_configs:</li>
</ul>
</div>
<div id="outline-container-h:a1f265e1-ca0b-408c-bb66-9375d1541438" class="outline-4">
<h4 id="h:a1f265e1-ca0b-408c-bb66-9375d1541438">å‘Šè­¦é‚®ä»¶é€šçŸ¥</h4>
<div class="outline-text-4" id="text-h:a1f265e1-ca0b-408c-bb66-9375d1541438">
<div class="org-src-container">
<pre class="src src-yaml">global:
...
  smtp_smarthost: 'smtp.qq.com:465'
  smtp_from: 'alert@xxx.com'
  smtp_auth_username: 'aff@xxx.com'
  smtp_auth_password: 'xxx'
  smtp_require_tls: false  

receivers:
- name: 'team-Y-mails'
  email_configs:
  - to: 'team-Y+alerts@example.org'
    send_resolved: true  # æ˜¯å¦å‘æ¢å¤çš„é€šçŸ¥
</pre>
</div>
</div>
</div>
<div id="outline-container-h:72fc7d8a-fed8-4df9-84af-9851fb5ff61d" class="outline-4">
<h4 id="h:72fc7d8a-fed8-4df9-84af-9851fb5ff61d">å‘Šè­¦å¾®ä¿¡é€šçŸ¥</h4>
<div class="outline-text-4" id="text-h:72fc7d8a-fed8-4df9-84af-9851fb5ff61d">
<p>
ä¸ªäººä¹Ÿå¯ä»¥æ³¨å†Œ
</p>

<ul class="org-ul">
<li>æ³¨å†Œä¼ä¸šå¾®ä¿¡ï¼Œè®°å½•ä¼ä¸š ID (corp_id)</li>
<li>åˆ›å»ºä¸€ä¸ªéƒ¨é—¨ï¼Œç”¨äºæ¥æ”¶å‘Šè­¦</li>
<li>æ·»åŠ å­éƒ¨é—¨äººå‘˜ï¼Œè®°å½•éƒ¨é—¨ ID (to_party)</li>
<li>åˆ›å»ºæœºå™¨äººåº”ç”¨ï¼Œ è®°å½• agentidã€secret</li>
</ul>

<p>
é…ç½®
</p>
<div class="org-src-container">
<pre class="src src-yaml">global:
...
  # wechat
  wechat_api_url: 'https://qyapi.weixin.qq.com/cgi-bin/'
  wechat_api_corp_id: 'wwef86a30130f04f2b'

receivers:
- name: 'wechat'
  wechat_configs:
  - send_resolved: true
    to_party: 3
    to_user: '@all'
    agent_id: '1000003'
    api_secret: 'ZZQt0Ue9mtplH9u1g8PhxR_RxEnRu512CQtmBn6R2x0'
</pre>
</div>

<p>
åªå‘é€æŸä¸ªäººç”¨USER_ID
</p>
</div>
</div>
<div id="outline-container-h:a8dbe787-4083-4edc-8390-597ec9299469" class="outline-4">
<h4 id="h:a8dbe787-4083-4edc-8390-597ec9299469">slack</h4>
<div class="outline-text-4" id="text-h:a8dbe787-4083-4edc-8390-597ec9299469">
<div class="org-src-container">
<pre class="src src-shell">receivers:
    slack_configs:
      - api_url: <span style="color: #8b2252;">"&#27492;&#22788;&#37197;&#32622;&#26426;&#22120;&#20154;&#22320;&#22336;"</span>
        channel: <span style="color: #8b2252;">"#fchannel_name"</span>
        send_resolved: false
        title: <span style="color: #8b2252;">'[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}'</span>
        text: |-
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }} - <span style="color: #ff00ff;">`{{ .Labels.severity }}`</span>
          *Description:* {{ .Annotations.description }}
          *Details:*
            {{ range .Labels.SortedPairs }} *{{ .Name }}:* <span style="color: #ff00ff;">`{{ .Value }}`</span>
            {{ end }}
          {{ end }}
        short_fields: true
</pre>
</div>

<p>
å…¶å®ƒ
</p>
<div class="org-src-container">
<pre class="src src-shell">receivers:
- name: <span style="color: #8b2252;">"app-webhook-critical"</span>
  webhook_configs:
  - url: <span style="color: #8b2252;">'http://localhost:8060/dingtalk/app-webhook-critical/send'</span>
    send_resolved: true
- name: <span style="color: #8b2252;">"wallet-webhook-critical"</span>
  webhook_configs:
  - url: <span style="color: #8b2252;">'http://localhost:8060/dingtalk/wallet-webhook-critical/send'</span>
    send_resolved: true
  slack_configs:
  - api_url: <span style="color: #8b2252;">"https://hooks.slack.com/services/T026NT2D4/B0jxxxxxxxxxxx"</span>
    channel: <span style="color: #8b2252;">"#cc-alert-wallet"</span>
    text: <span style="color: #8b2252;">"{{ range .Alerts }}{{ .Annotations.summary }}\n Value: {{ .Annotations.description }}\n{{ end }}"</span>
    send_resolved: true
</pre>
</div>

<p>
æµ‹è¯•
</p>
<div class="org-src-container">
<pre class="src src-shell">curl --location --request POST <span style="color: #8b2252;">'https://hooks.slack.com/services/T5gZxxx'</span> <span style="color: #8b2252;">\</span>
--header <span style="color: #8b2252;">'Content-Type: application/json'</span> <span style="color: #8b2252;">\</span>
--data-raw <span style="color: #8b2252;">'{
    &#8220;text&#8221;: &#8220;Hello, world.&#8221;
}'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:948a621c-c649-40b5-9c4c-b69285ef84d6" class="outline-4">
<h4 id="h:948a621c-c649-40b5-9c4c-b69285ef84d6">è‡ªå®šä¹‰æ¥æ”¶è€…-è‡ªå»ºæ¥å£</h4>
<div class="outline-text-4" id="text-h:948a621c-c649-40b5-9c4c-b69285ef84d6">
<p>
å®šä¹‰æ¥å£è¯†åˆ«çš„æ ‡ç­¾ï¼Œå¦‚åœ¨æŠ¥è­¦è§„åˆ™ä¸Šæ·»åŠ  <code>duty: cardgames_po|infra_op</code> ï¼Œç„¶ååœ¨å‘Šè­¦å‘é€æ—¶åœ¨ alertmanager ä¸Šé…ç½®ä¸Šå¯¹åº”æ¥å£ã€‚
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">prometheus &#25253;&#35686;&#35268;&#21017;&#25991;&#20214;
</span>      - alert: poker_new_games_dropped_critical
        expr: *
        <span style="color: #a020f0;">for</span>: 10m
        labels:
          severity: critical
          team: cardgames-poker
          duty: cardgames_po|infra_op
        annotations:
          runbook_url: https://xxx
          summary:  <span style="color: #8b2252;">'x'</span>
          description: <span style="color: #8b2252;">'x'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">alertmanager &#37197;&#32622;&#25991;&#20214;
</span>    receivers:
    - name: <span style="color: #8b2252;">"cardgames-business-webhook-critical"</span>
      webhook_configs:
      - url: <span style="color: #8b2252;">'http://prometheus-webhook-dingtalk:8060/dingtalk/cardgames-business-webhook-critical/send'</span>
        send_resolved: true
      - send_resolved: false
        url: <span style="color: #8b2252;">"http://ops.xxx.com/api/v1/monitoringWebhook"</span>
      slack_configs:
      - api_url: <span style="color: #8b2252;">"https://hooks.slack.com/services/T026NT2D4/B033SJ1DFT6/xx"</span>
        channel: <span style="color: #8b2252;">"#cc-alert-cardgames"</span>
        text: <span style="color: #8b2252;">"{{ range .Alerts }}{{ .Annotations.summary }}\n Value: {{ .Annotations.description }}\n{{ end }}"</span>
        send_resolved: true
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:aab88a77-78c3-42ad-a601-9fd5b9f6aaa9" class="outline-3">
<h3 id="h:aab88a77-78c3-42ad-a601-9fd5b9f6aaa9">templates-è‡ªå®šä¹‰å‘Šè­¦æ¨¡æ¿</h3>
<div class="outline-text-3" id="text-h:aab88a77-78c3-42ad-a601-9fd5b9f6aaa9">
</div>
<div id="outline-container-h:4602864c-6f7c-45e7-a9ea-28afe14ae1ca" class="outline-4">
<h4 id="h:4602864c-6f7c-45e7-a9ea-28afe14ae1ca">å¾®ä¿¡å‘Šè­¦æ¨¡æ¿</h4>
<div class="outline-text-4" id="text-h:4602864c-6f7c-45e7-a9ea-28afe14ae1ca">
<p>
é»˜è®¤å¾®ä¿¡å‘Šè­¦æ¨¡æ¿æ ¼å¼ä¸æ¯”è¾ƒä¹±ã€‚
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;alertmanager.yaml&#30340;secret
</span>kubectl create secret generic  alertmanager-main --from-file=alertmanager.yaml --from-file=wechat.tmpl   -n monitoring
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20043;&#21518;&#26356;&#25913;alertmanager.yaml&#21487;&#20197;&#20351;&#29992;&#28909;&#21152;&#36733;&#21435;&#26356;&#26032;k8s&#30340;secret
</span>kubectl create secret generic  alertmanager-main --from-file=alertmanager.yaml -n monitoring --dry-run -o yaml | kubectl replace -f -
</pre>
</div>

<p>
wechat.tmpl
</p>
<div class="org-src-container">
<pre class="src src-shell">{{ define <span style="color: #8b2252;">"wechat.default.message"</span> }}
{{ <span style="color: #a020f0;">if</span> gt (len .Alerts.Firing) 0 -}}
Alerts Firing:
{{ range .Alerts }}
&#21578;&#35686;&#32423;&#21035;&#65306;{{ .Labels.severity }}
&#21578;&#35686;&#31867;&#22411;&#65306;{{ .Labels.alertname }}
&#25925;&#38556;&#20027;&#26426;: {{ .Labels.instance }}
Job&#21517;&#31216;: {{.Labels.job}}
&#21578;&#35686;&#35814;&#24773;: {{ .Annotations.message }}
&#35302;&#21457;&#26102;&#38388;: {{ .StartsAt.Format <span style="color: #8b2252;">"2006-01-02 15:04:05"</span> }}
{{- end }}
{{- end }}
{{ <span style="color: #a020f0;">if</span> gt (len .Alerts.Resolved) 0 -}}
Alerts Resolved:
{{ range .Alerts }}
&#21578;&#35686;&#32423;&#21035;&#65306;{{ .Labels.severity }}
&#21578;&#35686;&#31867;&#22411;&#65306;{{ .Labels.alertname }}
&#25925;&#38556;&#20027;&#26426;: {{ .Labels.instance }}
Job&#21517;&#31216;: {{.Labels.job}}
&#21578;&#35686;&#20027;&#39064;: {{ .Annotations.message }}
&#35302;&#21457;&#26102;&#38388;: {{ .StartsAt.Format <span style="color: #8b2252;">"2006-01-02 15:04:05"</span> }}
&#24674;&#22797;&#26102;&#38388;: {{ .EndsAt.Format <span style="color: #8b2252;">"2006-01-02 15:04:05"</span> }}
{{- end }}
{{- end }}
&#21578;&#35686;&#38142;&#25509;:
{{ template <span style="color: #8b2252;">"__alertmanagerURL"</span> . }}  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26367;&#25442;&#25104;&#22495;&#21517;
</span>{{- end }}
</pre>
</div>

<p>
ä¿®æ”¹alertmanager.yaml
</p>
<div class="org-src-container">
<pre class="src src-shell">templates:
- <span style="color: #8b2252;">'/etc/alertmanager/config/*.tmpl'</span>

- name: <span style="color: #8b2252;">'wechat'</span>          <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24494;&#20449;&#21578;&#35686;
</span>  wechat_configs:
  - send_resolved: true   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25253;&#35686;&#35299;&#20915;&#30340;&#36890;&#36807;&#26159;&#21542;&#21457;&#36865;
</span>    corp_id: <span style="color: #8b2252;">'ww'</span>
    api_secret: <span style="color: #8b2252;">'JJ'</span>
    to_tag: <span style="color: #8b2252;">'1'</span>
    agent_id: <span style="color: #8b2252;">'1000002'</span>
    api_url: <span style="color: #8b2252;">'https://qyapi.weixin.qq.com/cgi-bin/'</span>
    message: <span style="color: #8b2252;">'{{ template "wechat.default.message" . }}'</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21644;&#27169;&#26495;&#20013; define &#21517;&#31216;&#19968;&#33268;</span>
</pre>
</div>



<p>
å‘Šè­¦æ¨¡æ¿é…ç½®ï¼š<a href="https://prometheus.io/docs/alerting/notification_examples/">https://prometheus.io/docs/alerting/notification_examples/</a>
</p>
</div>
</div>
</div>
<div id="outline-container-h:339556f0-dcec-41fe-9ad7-d76a406b75dc" class="outline-3">
<h3 id="h:339556f0-dcec-41fe-9ad7-d76a406b75dc">inhibit_rules-é™åˆ¶</h3>
<div class="outline-text-3" id="text-h:339556f0-dcec-41fe-9ad7-d76a406b75dc">
<p>
Alertmanager å‘Šè­¦å¤„ç†æµç¨‹ï¼š
</p>
<ul class="org-ul">
<li>æ¥æ”¶å‘Šè­¦ â†’ åˆ†ç»„ï¼ˆgroup_byï¼‰ â†’ æŠ‘åˆ¶ï¼ˆinhibit_rulesï¼‰ â†’ é™é»˜ï¼ˆsilencesï¼‰ â†’ è·¯ç”±ï¼ˆrouteï¼‰ â†’ å»é‡ â†’ å‘é€é€šçŸ¥</li>
</ul>

<p>
inhibit_rulesï¼šæŠ‘åˆ¶è§„åˆ™ï¼Œsource å‘Šè­¦è§¦å‘æ—¶ä¼šæŠ‘åˆ¶ target å‘Šè­¦ï¼ˆé˜²æ­¢é‡å¤é€šçŸ¥ï¼‰
</p>

<div class="org-src-container">
<pre class="src src-text"># &#33410;&#28857;&#23445;&#26426;&#26102;&#25233;&#21046;&#35813;&#33410;&#28857;&#30340;&#25152;&#26377;&#20854;&#20182;&#21578;&#35686;
inhibit_rules:
- source_match:
    alertname:'NodeDown'
  target_match_re:
    alertname:'.*'
  equal: ['instance']

# &#30913;&#30424;&#21482;&#35835;&#26102;&#25233;&#21046;&#30913;&#30424;&#31354;&#38388;&#21578;&#35686;
- source_match:
    alertname:'DiskReadOnly'
  target_match:
    alertname:'DiskSpaceLow'
  equal: ['instance', 'device']

# &#21578;&#35686;&#25233;&#21046;&#35268;&#21017;&#65288;&#33410;&#28857;&#25925;&#38556;&#26102;&#25233;&#21046;&#35813;&#33410;&#28857;&#19978;&#30340;&#23481;&#22120;&#21578;&#35686;)
inhibit_rules:
- source_match:
    severity:'critical'
    alertname:'NodeDown'
  target_match_re:
    severity:'warning|info'
  equal: ['instance']

- source_match:
    alertname:'NodeMemoryLow'
  target_match:
    alertname:'PodMemoryHigh'
  equal: ['instance']


inhibit_rules:
# &#35268;&#21017; 1&#65306;&#33410;&#28857;&#23445;&#26426;&#26102;&#65292;&#25233;&#21046;&#35813;&#33410;&#28857;&#30340;&#25152;&#26377; Pod &#21578;&#35686;
- source_match:
    alertname:'NodeDown'
  target_match_re:
    alertname:'Pod.*'
  equal: ['instance']

# &#35268;&#21017; 2&#65306;&#25968;&#25454;&#24211;&#20027;&#24211;&#25925;&#38556;&#26102;&#65292;&#25233;&#21046;&#20174;&#24211;&#24310;&#36831;&#21578;&#35686;
- source_match:
    alertname:'MySQLMasterDown'
    service:'mysql-cluster'
  target_match:
    alertname:'MySQLReplicationLag'
  equal: ['cluster']

# &#35268;&#21017; 3&#65306;&#32593;&#32476;&#19981;&#21487;&#36798;&#26102;&#65292;&#25233;&#21046;&#24212;&#29992;&#23618;&#36229;&#26102;&#21578;&#35686;
- source_match:
    alertname:'NetworkUnreachable'
  target_match_re:
    alertname:'.*Timeout'
  equal: ['instance']
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9828702b-5c89-4409-a844-5fe89975b698" class="outline-3">
<h3 id="h:9828702b-5c89-4409-a844-5fe89975b698">è®¡åˆ’å†…ç»´æŠ¤æš‚åœå‘Šè­¦ Silence</h3>
<div class="outline-text-3" id="text-h:9828702b-5c89-4409-a844-5fe89975b698">
<p>
æ‰“å¼€ alertmanager ui ç•Œé¢ï¼Œå¯ä»¥å¯¹å·²çŸ¥å‘Šè­¦åšæš‚åœï¼Œä¹Ÿå¯ä»¥å¯¹æœªå‘Šè­¦æš‚åœåšæ–°å»ºã€‚
</p>
</div>
</div>
<div id="outline-container-h:655ad2ea-0d20-4c45-acad-836caeddb9f9" class="outline-3">
<h3 id="h:655ad2ea-0d20-4c45-acad-836caeddb9f9">æ‰‹åŠ¨è§¦å‘å‘Šè­¦</h3>
<div class="outline-text-3" id="text-h:655ad2ea-0d20-4c45-acad-836caeddb9f9">
<div class="org-src-container">
<pre class="src src-shell">curl --location --request POST <span style="color: #8b2252;">'https://alertmanager-akamai.xxx.com/api/v1/alerts'</span> <span style="color: #8b2252;">\</span>
--header <span style="color: #8b2252;">'Content-Type: application/json'</span> <span style="color: #8b2252;">\</span>
--data-raw <span style="color: #8b2252;">'[
    {
        "labels": {
            "severity": "critical",
            "duty": "infra_op|fsy_rd"
        },
        "annotations": {
            "info": "The disk sda1 is running full2",
            "summary": "please check the instance example1"
        }
    }
]'</span>
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:f8ebcb30-d2e3-4174-aecb-6ef83a44fedd" class="outline-2">
<h2 id="h:f8ebcb30-d2e3-4174-aecb-6ef83a44fedd">Prometheus å‘Šè­¦å®æˆ˜</h2>
<div class="outline-text-2" id="text-h:f8ebcb30-d2e3-4174-aecb-6ef83a44fedd">
</div>
<div id="outline-container-h:c7ceac4e-4c8d-42bb-bfc2-1b80f730b663" class="outline-3">
<h3 id="h:c7ceac4e-4c8d-42bb-bfc2-1b80f730b663">PrometheusRule</h3>
<div class="outline-text-3" id="text-h:c7ceac4e-4c8d-42bb-bfc2-1b80f730b663">
<p>
Prometheus Stack è‡ªå®šä¹‰äº† PrometheusRule ç±»å‹ã€‚
</p>

<p>
å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹é»˜è®¤é…ç½®çš„å‘Šè­¦ç­–ç•¥ï¼š
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl get prometheusrule -n monitoring

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#65306;nodeExporter-prometheusRule.yaml</span>
</pre>
</div>

<p>
æ³¨æ„åŒ¹é…æ ‡ç­¾çš„è§„åˆ™æ‰èƒ½è¢«è¯†åˆ«:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">prometheus-prometheus.yaml
</span>  ruleSelector:
    matchLabels:
      prometheus: k8s
      role: alert-rules
</pre>
</div>

<p>
api æ–‡æ¡£ï¼š<a href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#prometheusrule">https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#prometheusrule</a>
</p>
</div>
<div id="outline-container-h:99be0d9e-5c39-4aee-a842-e3ca9bbbffb2" class="outline-4">
<h4 id="h:99be0d9e-5c39-4aee-a842-e3ca9bbbffb2">è§„åˆ™è¯­æ³•</h4>
<div class="outline-text-4" id="text-h:99be0d9e-5c39-4aee-a842-e3ca9bbbffb2">
<p>
å¦‚ nodeExporter-prometheusRule.yaml
</p>
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: k8s
    role: alert-rules
  name: node-exporter-rules
  namespace: monitoring
spec:
  groups:
  - name: node-exporter
    rules:
    - alert: NodeFilesystemSpaceFillingUp
      annotations:
        description: Filesystem on {{ $labels.device }} at {{ $labels.instance }}
          has only {{ printf "%.2f" $value }}% available space left and is filling
          up.
        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodefilesystemspacefillingup
        summary: Filesystem is predicted to run out of space within the next 24 hours.
      expr: |
        (
          node_filesystem_avail_bytes{job="node-exporter",fstype!=""} / node_filesystem_size_bytes{job="node-exporter",fstype!=""} * 100 &lt; 15
        and
          predict_linear(node_filesystem_avail_bytes{job="node-exporter",fstype!=""}[6h], 24*60*60) &lt; 0
        and
          node_filesystem_readonly{job="node-exporter",fstype!=""} == 0
        )
      for: 1h
      Labels:
        severity: warning
</pre>
</div>

<p>
è¯´æ˜ï¼šå’Œæ™®é€šå®‰è£…åçš„é…ç½®æ–‡ä»¶çš„è¯­æ³•æ˜¯ä¸€æ ·çš„
</p>
<ul class="org-ul">
<li>alertï¼šå‘Šè­¦ç­–ç•¥åç§°</li>
<li>annotationsï¼šå‘Šè­¦æ³¨é‡Šä¿¡æ¯
<ul class="org-ul">
<li>descriptionï¼šè¯¦æƒ…</li>
<li>summaryï¼šæ¦‚è¿°</li>
<li>runbook_urlï¼šå‚è€ƒåœ°å€ã€‚å¯ç”¨æ¥è¿”å›è§£å†³æ–¹æ¡ˆ wiki æˆ–è‡ªåŠ¨åŒ– webhook</li>
</ul></li>
<li>exprï¼šå‘Šè­¦è¡¨è¾¾å¼</li>
<li>Labelsï¼šå‘Šè­¦çš„æ ‡ç­¾ï¼Œç”¨äºå‘Šè­¦çš„è·¯ç”±</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:07378308-4f48-4203-8726-92eab0e1c63d" class="outline-3">
<h3 id="h:07378308-4f48-4203-8726-92eab0e1c63d">åŸŸåè®¿é—®å»¶è¿Ÿå‘Šè­¦</h3>
<div class="outline-text-3" id="text-h:07378308-4f48-4203-8726-92eab0e1c63d">
<p>
æå‰å®‰è£…å¥½ blackbox
</p>
</div>
<div id="outline-container-h:eb9295da-8ce4-4c8f-b50f-8987c6d2bfca" class="outline-4">
<h4 id="h:eb9295da-8ce4-4c8f-b50f-8987c6d2bfca">å‘Šè­¦è§„åˆ™</h4>
<div class="outline-text-4" id="text-h:eb9295da-8ce4-4c8f-b50f-8987c6d2bfca">
<p>
blackbox-prometheusRule.yaml
</p>
<div class="org-src-container">
<pre class="src src-yaml">node.rules.yml: |
  groups:
  - name: ssl_cert_expiry # è¯ä¹¦åˆ°æœŸå‘Šè­¦
    interval: 1d  # æ£€æŸ¥é—´éš”
    rules:
    - alert: taskcenter_ssl_cert_expiry_less_than_30days
      expr: (probe_ssl_earliest_cert_expiry{job="blackbox-http"} - time()) /60/60/24  &lt; 30
      labels:
        severity: warning
        type: blackbox
      annotations:
        summary: "ssl cert expiry less than 30 days"
        description: "warning | Current value = {{ $value }}%. | [Duration Time: 1d]"

  - name: url_not_available # ç½‘ç«™ä¸å¯ç”¨å‘Šè­¦
    interval: 1m
    rules:
    - alert: url_not_available
      expr: probe_http_status_code{job="blackbox-http"} != 200
      labels:
        severity: warning
        type: blackbox
      annotations:
        summary: "url not available"

  - name: url_delay # ç½‘ç«™å»¶è¿Ÿ
    rules:
    - alert: DomainAccessDelayExceedsls
      expr: sum by (instance) (probe_http_duration_seconds{job="blackbox-http"}) &gt; 1
      for: 1m
      labels:
        severity: warning
        type: blackbox
      annotations:
        summary: "Domain is delayed by more than 1 second"
        description: "The domain {{$labels.instance}} is delayed by more than 1 second, current value is {{ $value | printf "%.2f" }} second"
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f556fcb8-f5f8-45fe-bf72-bac812dd960f" class="outline-4">
<h4 id="h:f556fcb8-f5f8-45fe-bf72-bac812dd960f">ingress è‡ªåŠ¨ç›‘æ§åŸŸå</h4>
<div class="outline-text-4" id="text-h:f556fcb8-f5f8-45fe-bf72-bac812dd960f">
<div class="org-src-container">
<pre class="src src-yaml">#----- è‡ªåŠ¨å‘ç° æ·»åŠ ä»¥ä¸‹å†…å®¹
- job_name: 'auto_discovery'
  metrics_path: /probe
  params:
    module: [http_2xx]  
  kubernetes_sd_configs:  # ä½¿ç”¨ k8s çš„æœåŠ¡å‘ç°
  - role: ingress  # æœåŠ¡å‘ç°å¯ä»¥åŸºäº ingress, pod, svc, ... ...
  relabel_configs:
  - source_labels: [__meta_kubernetes_ingress_annotation_prometheus_io_http_probe]
    action: keep
    regex: true  # ingress é…ç½®äº†ä¸Šé¢çš„æ ‡ç­¾å€¼ä¸ºtrueçš„ä¼šåŠ å…¥è‡ªåŠ¨å‘ç°
  - source_labels: [__meta_kubernetes_ingress_scheme,__address__,__meta_kubernetes_ingress_path]
    regex: (.+);(.+);(.+)
    replacement: ${1}://${2}${3} # ç”¨ä¸Šé¢åŒ¹é…åˆ°çš„æ ‡ç­¾æ‹¼æˆ url
    target_label: __param_target
  - source_labels: [__meta_kubernetes_ingress_scheme,__address__,__meta_kubernetes_ingress_path]
    regex: (.+);(.+);(.+)
    replacement: ${1}://${2}${3}
    target_label: target
  - target_label: __address__
    replacement: blackbox-exporter:9115
  - source_labels: [__param_target]
    target_label: instance
  - action: labelmap   # ingress çš„æ ‡ç­¾èµ‹å€¼ç»™ metric çš„lable
    regex: __meta_kubernetes_ingress_label_(.+)
  - source_labels: [__meta_kubernetes_namespace]
    target_label: kubernetes_namespace
  - source_labels: [__meta_kubernetes_ingress_name]
    target_label: kubernetes_name
</pre>
</div>

<p>
serviceaccount monitoring:prometheus-k8s é…ç½®è¯»å– ingress çš„æƒé™
ingress-view.yaml
</p>
<div class="org-src-container">
<pre class="src src-shell">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus-discovery 
  namespace: monitoring
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ratel-resource-readonly
subjects:
- namespace: monitoring 
  kind: ServiceAccount
  name: prometheus-k8s
</pre>
</div>
<p>
åœ¨ prometheus é¡µé¢ä¸­å¯ä»¥çœ‹åˆ° auto_discovery çš„ jobã€‚
</p>

<p>
ingress å¯åŠ¨å¢¨ç›’åŸŸåç›‘æ§
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#30417;&#25511;&#22495;&#21517;&#65292;ingress &#20013;&#28155;&#21152;&#22914;&#19979;&#27880;&#37322;
</span>  annotations:
    prometheus.io/http_probe: true
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:e67b48f6-8020-4b06-b6b8-4ec5013127ca" class="outline-3">
<h3 id="h:e67b48f6-8020-4b06-b6b8-4ec5013127ca">prometheus ç›‘æ§ Java JVM</h3>
<div class="outline-text-3" id="text-h:e67b48f6-8020-4b06-b6b8-4ec5013127ca">
<ul class="org-ul">
<li>ä½¿ micrometer æ¥ç›‘æ§ JVM <a href="https://micrometer.io/">https://micrometer.io/</a></li>
<li>grafana æ¨¡æ¿ï¼š <a href="https://grafana.com/grafana/dashboards/4701">https://grafana.com/grafana/dashboards/4701</a></li>
<li>æµ‹è¯• Demo é¡¹ç›®ï¼š<a href="https://github.com/gongchangwangpi/spring-cloud-demo2">https://github.com/gongchangwangpi/spring-cloud-demo2</a></li>
</ul>
</div>
<div id="outline-container-h:c23fe1d4-2a58-48cd-92ec-72eebc9d1919" class="outline-4">
<h4 id="h:c23fe1d4-2a58-48cd-92ec-72eebc9d1919">Java JVMç›‘æ§</h4>
<div class="outline-text-4" id="text-h:c23fe1d4-2a58-48cd-92ec-72eebc9d1919">
<p>
é¡¹ç›®pomæ–‡ä»¶å¦‚ä¸‹å†…å®¹ï¼Œç»è¿‡ç¼–è¯‘çš„ jar åŒ…å°±æœ‰äº† micrometer çš„æ¥å£
</p>
<div class="org-src-container">
<pre class="src src-shell">&lt;dependecies&gt; <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#22914;&#19979;&#20869;&#23481;
</span>     &lt;!-- Micrometer Prometheus registry  --&gt;
     &lt;dependency&gt;
     &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
     &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
       &lt;/dependency&gt;
      &lt;dependency&gt;
             &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
              &lt;artifactId&gt;micrometer-core&lt;/artifactId&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
             &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
             &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;
      &lt;/dependency&gt;
     &lt;!-- finished --&gt;
</pre>
</div>

<p>
Mavenç¼“å­˜ç›®å½•ï¼š~/.m2
</p>

<p>
<a href="https://hub.docker.com/_/maven?tab=tags">https://hub.docker.com/_/maven?tab=tags</a>
</p>

<p>
eurekaé»˜è®¤ç«¯å£: 8761
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">cd</span> /opt
git clone https://github.com/gongchangwangpi/spring-cloud-demo2
<span style="color: #483d8b;">cd</span> spring-cloud-demo2

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32534;&#35793;
</span>docker run -it --rm -v /opt/m2:/root/.m2 -v <span style="color: #ff00ff;">`pwd`</span>:/opt -p 18761:8761 maven:3.5.3 bash
&gt; cd /opt
&gt; cd spring-cloud-eureka
&gt; vim pom.xml  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#20197;&#19979;&#20869;&#23481;
</span>   &lt;dependecies&gt; <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#22914;&#19979;&#20869;&#23481;
</span>        &lt;!-- Micrometer Prometheus registry  --&gt;
        &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
          &lt;/dependency&gt;
         &lt;dependency&gt;
                &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
                 &lt;artifactId&gt;micrometer-core&lt;/artifactId&gt;
         &lt;/dependency&gt;
         &lt;dependency&gt;
                &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
                &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;
         &lt;/dependency&gt;
        &lt;!-- finished --&gt;
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558; micrometer &#30340;&#25509;&#21475;&#26292;&#38706;&#20986;&#26469;
</span>&gt; vim src/main/resources/application.yml <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26032;&#22686;&#20197;&#19979;&#20869;&#23481;
</span>spring:
  application:
    name: cloud-eureka
management:
  endpoints:
    web:
      exposure:
        include: <span style="color: #8b2252;">'*'</span>
    shutdown:
      <span style="color: #483d8b;">enable</span>: false
  metrics:
    tags:
      application: <span style="color: #8b2252;">"${spring.application.name}"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">maven&#32534;&#35793;&#21629;&#20196;&#65306;
</span>&gt; mvn clean package -DskipTests      
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160; euraka &#26381;&#21153;
</span>&gt; java -jar target/spring-cloud-eureka-0.0.1-SNAPSHOT.jar
</pre>
</div>

<p>
æµè§ˆå™¨è®¿é—® eurakaï¼š <a href="http://ip:18761">http://ip:18761</a>
</p>

<p>
æŸ¥çœ‹ç›‘æ§æ•°æ®ï¼š<a href="http://ip:18761/actutor/prometheus">http://ip:18761/actutor/prometheus</a>
</p>

<p>
æ·»åŠ ç›‘æ§
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26032;&#22686;&#22914;&#19979;&#20869;&#23481;
</span>[root@k8s-master01 prometheus-down]# vim prometheus-additional.yaml 
- job_name: <span style="color: #8b2252;">'jvm-prometheus'</span>
  scheme: http
  metrics_path: <span style="color: #8b2252;">'/actuator/prometheus'</span>
  static_configs:
  - targets: [<span style="color: #8b2252;">'xxx:8080'</span>]
</pre>
</div>
</div>
</div>
<div id="outline-container-h:eb39c790-aa0b-4c70-8e80-81aedcd32869" class="outline-4">
<h4 id="h:eb39c790-aa0b-4c70-8e80-81aedcd32869">åŸºäº euraka æœåŠ¡è‡ªåŠ¨å‘ç°ç›‘æ§ JVM</h4>
<div class="outline-text-4" id="text-h:eb39c790-aa0b-4c70-8e80-81aedcd32869">
<p>
æŸ¥çœ‹å¯¹åº”ç‰ˆæœ¬ï¼š<a href="https://mavenjars.com/search?q=eureka-consul-adapter">https://mavenjars.com/search?q=eureka-consul-adapter</a>
</p>

<p>
euraka
</p>
<div class="org-src-container">
<pre class="src src-shell">vim pom.xml 
&lt;dependency&gt;
    &lt;groupId&gt;at.twinformatics&lt;/groupId&gt;
    &lt;artifactId&gt;eureka-consul-adapter&lt;/artifactId&gt;
    &lt;version&gt;1.1.0&lt;/version&gt;
&lt;/dependency&gt;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:26da6d52-da21-4ae6-9dc8-081b3f20894d" class="outline-3">
<h3 id="h:26da6d52-da21-4ae6-9dc8-081b3f20894d">ç›‘æ§å‘Šè­¦é€šç”¨æ­¥éª¤</h3>
<div class="outline-text-3" id="text-h:26da6d52-da21-4ae6-9dc8-081b3f20894d">
<p>
éäº‘åŸç”Ÿåº”ç”¨ï¼š
</p>
<ul class="org-ul">
<li>æ‰¾åˆ°å¯¹åº”æœåŠ¡çš„ Exporterï¼ˆå¦‚æœæ˜¯è‡ªæœ‰ä¸šåŠ¡ï¼Œå¯èƒ½éœ€è¦è‡ªè¡Œæš´éœ²æ•°æ®ï¼‰ï¼›</li>
<li>å¦‚æœ k8s é›†ç¾¤å¤–éƒ¨æœåŠ¡ï¼Œå¯èƒ½éœ€è¦åˆ›å»ºå•ç‹¬çš„ Service æŒ‡å‘æœåŠ¡ï¼Œç›´æ¥ä½¿ç”¨æœåŠ¡ IP ä¹Ÿå¯ï¼›</li>
<li>åˆ›å»º Exporter å¹¶é…ç½®è¢«ç›‘æ§ç«¯çš„ IP æˆ–è€… Serviceï¼›</li>
<li>åˆ›å»º Exporter çš„ Service ç”¨äº è¢« Prometheus å‘ç°å¹¶æ³¨å†Œï¼›</li>
<li>åˆ›å»º ServiceMonitor å°†è¢«ç›‘æ§èµ„æºæ³¨å†Œè‡³ Prometheusï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨é™æ€é…ç½®ï¼‰ï¼›</li>
<li>é…ç½®æœåŠ¡çš„å‘Šè­¦ç­–ç•¥ï¼›</li>
<li>é…ç½®æœåŠ¡çš„å‘Šè­¦è·¯ç”±ï¼Œå°†å‘Šè­¦å‘é€ç»™æŒ‡å®šçš„äººã€‚</li>
</ul>


<p>
äº‘åŸç”Ÿåº”ç”¨ï¼š
</p>
<ul class="org-ul">
<li>å¦‚æœæ˜¯ k8s é›†ç¾¤å¤–éƒ¨æœåŠ¡ï¼Œå¯èƒ½éœ€è¦åˆ›å»ºå•ç‹¬çš„ Service æŒ‡å‘æœåŠ¡ï¼›</li>
<li>åˆ›å»º ServiceMonitor å°†è¢«ç›‘æ§èµ„æºæ³¨å†Œè‡³ prometheusï¼›</li>
<li>é…ç½®æœåŠ¡çš„å‘Šè­¦ç­–ç•¥ï¼›</li>
<li>é…ç½®æœåŠ¡çš„å‘Šè­¦è·¯ç”±ï¼Œå°†å‘Šè­¦å‘é€ç»™æŒ‡å®šçš„äººã€‚</li>
</ul>
</div>
</div>
<div id="outline-container-h:59979eba-dadd-47ff-863b-ae6f98c6a98c" class="outline-3">
<h3 id="h:59979eba-dadd-47ff-863b-ae6f98c6a98c">è§£å†³ç›‘æ§é—®é¢˜</h3>
<div class="outline-text-3" id="text-h:59979eba-dadd-47ff-863b-ae6f98c6a98c">
</div>
<div id="outline-container-h:70da9f17-6132-4c4f-bd39-49e4155d4b27" class="outline-4">
<h4 id="h:70da9f17-6132-4c4f-bd39-49e4155d4b27">è§£å†³scheduleå’Œcontrollerç›‘æ§é—®é¢˜</h4>
<div class="outline-text-4" id="text-h:70da9f17-6132-4c4f-bd39-49e4155d4b27">
<ol class="org-ol">
<li>æœåŠ¡å¯åŠ¨0.0.0.0</li>
<li>åˆ›å»ºå¯¹åº”æ ‡ç­¾çš„svcï¼Œ svc å’Œ endpoint åç§°ä¸€æ ·å°±ä¼šè‡ªåŠ¨åˆ›å»ºè”æ¥</li>
</ol>
<div class="org-src-container">
<pre class="src src-shell">apiVersion: v1
items:
- apiVersion: v1
  kind: Service
  metadata:
    creationTimestamp: <span style="color: #8b2252;">"2020-04-25T14:42:04Z"</span>
    labels:
      k8s-app: kube-controller-manager
    name: kube-controller-manage-monitor
    namespace: kube-system
    resourceVersion: <span style="color: #8b2252;">"10081547"</span>
    selfLink: /api/v1/namespaces/kube-system/services/kube-controller-manage-monitor
    uid: d82d9170-9335-49b8-9aae-48630eb6efd4
  spec:
    clusterIP: 10.96.23.157
    ports:
    - name: http-metrics
      port: 10252
      protocol: TCP
      targetPort: 10252
    sessionAffinity: None
    <span style="color: #483d8b;">type</span>: ClusterIP
  status:
    loadBalancer: {}
- apiVersion: v1
  kind: Endpoints
  metadata:
    creationTimestamp: <span style="color: #8b2252;">"2020-04-25T14:41:16Z"</span>
    labels:
      k8s-app: kube-controller-manager
    name: kube-controller-manage-monitor
    namespace: kube-system
    resourceVersion: <span style="color: #8b2252;">"10081388"</span>
    selfLink: /api/v1/namespaces/kube-system/endpoints/kube-controller-manage-monitor
    uid: c7d0214b-58a2-4d05-8cfe-673e914e06b4
  subsets:
  - addresses:
    - ip: 192.168.1.19
    ports:
    - name: http-metrics
      port: 10252
      protocol: TCP
kind: List
metadata:
  resourceVersion: <span style="color: #8b2252;">""</span>
  selfLink: <span style="color: #8b2252;">""</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:55302452-c660-44f6-a17e-a634706ad7ef" class="outline-4">
<h4 id="h:55302452-c660-44f6-a17e-a634706ad7ef">CPUThrottlingHigh</h4>
<div class="outline-text-4" id="text-h:55302452-c660-44f6-a17e-a634706ad7ef">
<p>
CPUThrottlingHighååº”çš„æ˜¯æœ€è¿‘5åˆ†é’Ÿè¶…è¿‡25%çš„CPUæ‰§è¡Œå‘¨æœŸå—åˆ°é™åˆ¶çš„containerï¼Œä¸€èˆ¬æ˜¯limitè®¾ç½®çš„ä½å¼•èµ·çš„ã€‚
</p>

<p>
é€šè¿‡ä¸¤ä¸ªæŒ‡æ ‡è¿›è¡Œç›‘æ§çš„ï¼š
</p>
<div class="org-src-container">
<pre class="src src-shell">container_cpu_cfs_periods_total&#65306;container&#29983;&#21629;&#21608;&#26399;&#20013;&#24230;&#36807;&#30340;cpu&#21608;&#26399;&#24635;&#25968;
container_cpu_cfs_throttled_periods_total&#65306;container&#29983;&#21629;&#21608;&#26399;&#20013;&#24230;&#36807;&#30340;&#21463;&#38480;&#30340;cpu&#21608;&#26399;&#24635;&#25968;
</pre>
</div>

<p>
è®¡ç®—è¡¨è¾¾å¼ï¼š
</p>
<div class="org-src-container">
<pre class="src src-shell">sum by(container, pod, namespace) (increase(container_cpu_cfs_throttled_periods_total{container!=<span style="color: #8b2252;">""</span>}[5m])) / sum by(container, pod, namespace) (increase(container_cpu_cfs_periods_total[5m])) &gt; (25 / 100)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:3eeaa294-05a7-4cff-872b-b622e2f82688" class="outline-3">
<h3 id="h:3eeaa294-05a7-4cff-872b-b622e2f82688">è®°å½•è§„åˆ™ä¼˜åŒ– PromQL è¯­å¥</h3>
<div class="outline-text-3" id="text-h:3eeaa294-05a7-4cff-872b-b622e2f82688">
<p>
Prometheus æä¾›ä¸€ç§è®°å½•è§„åˆ™ï¼ˆRecording Ruleï¼‰ æ¥æ”¯æŒè¿™ç§åå°è®¡ç®—çš„æ–¹å¼ï¼Œå¯ä»¥å®ç°å¯¹å¤æ‚æŸ¥è¯¢çš„ PromQL è¯­å¥çš„æ€§èƒ½ä¼˜åŒ–ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚
</p>

<p>
<a href="https://cloud.tencent.com/developer/article/1557482">https://cloud.tencent.com/developer/article/1557482</a>
</p>

<p>
èŒƒä¾‹ï¼š
</p>
<div class="org-src-container">
<pre class="src src-shell">   - name: wallet-record
     interval: 1m
     rules:
     - record: app:uri:le:http_client_requests_seconds_bucket:rate:sum
       expr: sum by(app, uri, le) (rate(http_client_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))
     - record: app:uri:le:http_server_requests_seconds_bucket:rate:sum
       expr: sum by(app, uri, le) (rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>, uri!=<span style="color: #8b2252;">"UNKNOWN"</span>}[1m]))
     - record: wallet_rpc_rt90_total_5m
       expr: histogram_quantile(0.9, sum by(app,uri,le) (rate(http_client_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[5m])))
     - record: wallet_rpc_tps_total_5m
       expr: sum by (app,uri)(rate(http_client_requests_seconds_count{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[5m]))
     - record: wallet_rt_histogram_quantile_05_1m
       expr: histogram_quantile(0.5, sum by(app,uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.5"</span>
           name: <span style="color: #8b2252;">"wallet_rt"</span>
     - record: wallet_rt_histogram_quantile_09_1m
       expr: histogram_quantile(0.9, sum by(app,uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.9"</span>
           name: <span style="color: #8b2252;">"wallet_rt"</span>
     - record: wallet_rt_histogram_quantile_099_1m
       expr: histogram_quantile(0.99, sum by(app,uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.99"</span>
           name: <span style="color: #8b2252;">"wallet_rt"</span>
     - record: wallet_rt_total_05_1m
       expr: histogram_quantile(0.5, sum by(uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.5"</span>
           name: <span style="color: #8b2252;">"wallet_rt"</span>
     - record: wallet_rt_total_09_1m
       expr: histogram_quantile(0.9, sum by(uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.9"</span>
           name: <span style="color: #8b2252;">"wallet_rt"</span>
     - record: wallet_rt_total_099_1m
       expr: histogram_quantile(0.99, sum by(uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.99"</span>
           name: <span style="color: #8b2252;">"wallet_rt"</span>
     - record: wallet_app_api_tps_endpoints
       expr: sum by (app,uri) (rate(http_server_requests_seconds_count{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>,<span style="color: #a0522d;">job</span>=~<span style="color: #8b2252;">".*endpoints"</span>}[1m]))&gt;0
     - record: wallet_rt_rate
       expr: sum by (app, instance, kubernetes_pod_name, uri, le) (rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>,<span style="color: #a0522d;">job</span>=~<span style="color: #8b2252;">".*pods"</span>,<span style="color: #a0522d;">app</span>=~<span style="color: #8b2252;">"gateway.*"</span>}[1m]))
     - record: wallet_app_api_tps_pods
       expr: sum by (app,uri) (rate(http_server_requests_seconds_count{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>,<span style="color: #a0522d;">job</span>=~<span style="color: #8b2252;">".*pods"</span>}[1m]))&gt;0
     - record: wallet_tps_compare_yesterday_1m
       expr: ((sum by(uri)(irate(http_server_requests_seconds_count{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>,<span style="color: #a0522d;">app</span>=~<span style="color: #8b2252;">"gateway.*"</span>,<span style="color: #a0522d;">job</span>=<span style="color: #8b2252;">"eks-prod-kubernetes-pods"</span>,<span style="color: #a0522d;">uri</span>=~<span style="color: #8b2252;">".*s2s/debit|.*credit|.*initTrans|.*debitNotice"</span>}[1m])) *100)/(sum by(uri) (irate(http_server_requests_seconds_count{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>,<span style="color: #a0522d;">app</span>=~<span style="color: #8b2252;">"gateway.*"</span>,<span style="color: #a0522d;">job</span>=<span style="color: #8b2252;">"eks-prod-kubernetes-pods"</span>,<span style="color: #a0522d;">uri</span>=~<span style="color: #8b2252;">".*s2s/debit|.*credit|.*initTrans|.*debitNotice"</span>}[1m] offset 1d)) &gt;= 0))
     - record: wallet_error_rate
       expr: (sum by (uri,exception) (irate(http_server_requests_seconds_count{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>,exception!~<span style="color: #8b2252;">"None|CasException|CustomException|BizException"</span>,status!=<span style="color: #8b2252;">"200"</span>,uri!~<span style="color: #8b2252;">".*UNKNOWN"</span>}[1m])))/(sum by (uri,exception) (irate(http_server_requests_seconds_count{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>,uri!~<span style="color: #8b2252;">".*UNKNOWN"</span>}[1m])))
     - record: wallet_app_api_exception
       expr: sum by (app,uri,exception) (rate(http_server_requests_seconds_count{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>,<span style="color: #a0522d;">job</span>=~<span style="color: #8b2252;">".*pods"</span>,status!=<span style="color: #8b2252;">"200"</span>}[1m]))
     - record: wallet_rt_histogram_quantile_0999_1m
       expr: histogram_quantile(0.999, sum by(app,uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))&gt;0)
       labels:
         quantile: <span style="color: #8b2252;">"0.999"</span>
         name: <span style="color: #8b2252;">"wallet_rt"</span>
     - record: wallet_rt_total_0999_1m
       expr: histogram_quantile(0.999, sum by(uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"wallet"</span>}[1m]))&gt;0)

app.rules.yml: |
 groups:
   - name: app-record
     interval: 1m
     rules:
     - record: app_rt_histogram_quantile_05_1m
       expr: histogram_quantile(0.5, sum by(app,uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>,app!=<span style="color: #8b2252;">"gateway"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.5"</span>
           name: <span style="color: #8b2252;">"app_rt"</span>
     - record: app_rt_histogram_quantile_09_1m
       expr: histogram_quantile(0.9, sum by(app,uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>,app!=<span style="color: #8b2252;">"gateway"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.9"</span>
           name: <span style="color: #8b2252;">"app_rt"</span>
     - record: app_rt_histogram_quantile_099_1m
       expr: histogram_quantile(0.99, sum by(app,uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>,app!=<span style="color: #8b2252;">"gateway"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.99"</span>
           name: <span style="color: #8b2252;">"app_rt"</span>
     - record: app_rt_total_05_1m
       expr: histogram_quantile(0.5, sum by(uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>,app!=<span style="color: #8b2252;">"gateway"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.5"</span>
           name: <span style="color: #8b2252;">"app_rt"</span>
     - record: app_rt_total_09_1m
       expr: histogram_quantile(0.9, sum by(uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>,app!=<span style="color: #8b2252;">"gateway"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.9"</span>
           name: <span style="color: #8b2252;">"app_rt"</span>
     - record: app_rt_total_099_1m
       expr: histogram_quantile(0.99, sum by(uri,le)(rate(http_server_requests_seconds_bucket{<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>,app!=<span style="color: #8b2252;">"gateway"</span>}[1m]))&gt;0)
       labels:
           quantile: <span style="color: #8b2252;">"0.99"</span>
           name: <span style="color: #8b2252;">"app_rt"</span>

     - record: app_api_error_requests_total_1m:increase:sum
       expr: sum(increase(api_fail_count_total{<span style="color: #a0522d;">application</span>=<span style="color: #8b2252;">"govern-gateway"</span>,<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>}[1m]))
     - record: app_api_requests_total_1m:increase:sum
       expr: sum(increase(gateway_requests_seconds_count{<span style="color: #a0522d;">application</span>=<span style="color: #8b2252;">"govern-gateway"</span>,<span style="color: #a0522d;">department</span>=<span style="color: #8b2252;">"app"</span>}[1m]))
     - record: app_api_core_error_requests_total_1m:increase:sum
       expr: sum(increase(api_fail_count_total{<span style="color: #a0522d;">application</span>=<span style="color: #8b2252;">"govern-gateway"</span>,<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>,<span style="color: #a0522d;">path</span>=~<span style="color: #8b2252;">"/api/usercenter/getLaunchConfigV3|/usercenter/getLaunchConfigV2 |/api/usercenter/getLaunchConfig|/api/usercenter/hotfix/getHotFixFlag|/usercenter/message/countUnread|/usercenter/postUserFCMToken|/usercenter/getLatestVersion|/api/usercenter/getUserInfo|/api/usercenter/getLaunchConfigV3|/usercenter/getUserIp|/game/getHamburgerMenus"</span>}[1m]))
     - record: core_api_requests_total_1m:increase:sum
      expr: sum(increase(http_server_requests_seconds_count{application!=<span style="color: #8b2252;">"govern-gateway"</span>,<span style="color: #a0522d;">kubernetes_namespace</span>=<span style="color: #8b2252;">"app"</span>,<span style="color: #a0522d;">uri</span>=~<span style="color: #8b2252;">"/usercenter/getLaunchConfigV3|/usercenter/getLaunchConfigV2 |/usercenter/getLaunchConfig|/usercenter/hotfix/getHotFixFlag|/usercenter/message/countUnread|/usercenter/postUserFCMToken|/usercenter/getLatestVersion|/usercenter/getUserInfo|/usercenter/getLaunchConfigV3|/usercenter/getUserIp|/game/getHamburgerMenus"</span>}[1m]))         
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:aa168970-406c-44c0-8cd0-8f3cb0bb80e4" class="outline-2">
<h2 id="h:aa168970-406c-44c0-8cd0-8f3cb0bb80e4">å…¶å®ƒ</h2>
<div class="outline-text-2" id="text-h:aa168970-406c-44c0-8cd0-8f3cb0bb80e4">
<ul class="org-ul">
<li>ç›‘æ§é¡¹å‚è€ƒï¼š<a href="https://monitoring.mixins.dev/kubernetes/">https://monitoring.mixins.dev/kubernetes/</a></li>
<li>PromQLå‚è€ƒï¼š<a href="https://fuckcloudnative.io/prometheus/3-prometheus/basics.html">https://fuckcloudnative.io/prometheus/3-prometheus/basics.html</a></li>
</ul>
</div>
<div id="outline-container-h:1c09d771-38f0-4dd3-a989-e025d209d4ba" class="outline-3">
<h3 id="h:1c09d771-38f0-4dd3-a989-e025d209d4ba">grafana</h3>
<div class="outline-text-3" id="text-h:1c09d771-38f0-4dd3-a989-e025d209d4ba">
</div>
<div id="outline-container-h:d284591d-854c-4e5a-853e-2ee6a38aeb26" class="outline-4">
<h4 id="h:d284591d-854c-4e5a-853e-2ee6a38aeb26">å›¾è¡¨å˜é‡å–å€¼</h4>
<div class="outline-text-4" id="text-h:d284591d-854c-4e5a-853e-2ee6a38aeb26">
<p>
å‚è€ƒï¼š<a href="https://grafana.com/docs/grafana/latest/dashboards/variables/variable-syntax/#advanced-variable-format-options/">https://grafana.com/docs/grafana/latest/dashboards/variables/variable-syntax/#advanced-variable-format-options/</a>
</p>

<p>
å¦‚ ç¼–è¾‘ Variablesï¼Œ
</p>
<ul class="org-ul">
<li>Name ä¸º Myï¼ŒType ä¸º Custom</li>
<li>Custom options ä¸º "A : aaa|AAA,B : bbb|BBB,C : ccc|CCCC"</li>
<li>å‹¾é€‰å¯å¤šé€‰ Multi-value</li>
</ul>


<figure id="org7ba890c">
<img src="./images/Snipaste_2023-01-02_07-43-32.png" alt="Snipaste_2023-01-02_07-43-32.png" width="50%">

</figure>


<figure id="orgb8438b6">
<img src="./images/Snipaste_2023-01-02_07-49-14.png" alt="Snipaste_2023-01-02_07-49-14.png" width="50%">

</figure>

<p>
value
</p>
<div class="org-src-container">
<pre class="src src-shell">String to interpolate: <span style="color: #8b2252;">'${My:value}'</span>
Interpolation result: <span style="color: #8b2252;">'{aaa|AAA,bbb|BBB,ccc|CCC}'</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#36866;&#21512;&#22810;&#36873;
</span>&#34920;&#36798;&#24335;&#65306;
<span style="color: #0000ff;">sum</span>(sum by(url, game, code) (rate(Fb_Net_Code_count{<span style="color: #a0522d;">game</span>=~<span style="color: #8b2252;">".*"</span>,<span style="color: #a0522d;">url</span>=~<span style="color: #8b2252;">".*(${My:value})"</span>,url!~<span style="color: #8b2252;">".*\\.(png|jpg|jpeg|json)"</span>,<span style="color: #a0522d;">prom_cluster</span>=<span style="color: #8b2252;">"prod-eks-client"</span>}[30s])))by (url)
&#35299;&#26512;&#21518;&#65306; &#21487;&#20197;&#30475;&#21040;|&#20998;&#38548;&#25104; {aaa&#12289;AAA,bbb&#12289;ccc|CCCC}
<span style="color: #0000ff;">sum</span>(sum by(url, game, code) (rate(Fb_Net_Code_count{<span style="color: #a0522d;">game</span>=~<span style="color: #8b2252;">".*"</span>,<span style="color: #a0522d;">url</span>=~<span style="color: #8b2252;">".*({aaa|AAA,bbb|BBB,ccc|CCCC})"</span>,url!~<span style="color: #8b2252;">".*\\.(png|jpg|jpeg|json)"</span>,<span style="color: #a0522d;">prom_cluster</span>=<span style="color: #8b2252;">"prod-eks-client"</span>}[30s])))by (url)
</pre>
</div>



<p>
pip
</p>
<div class="org-src-container">
<pre class="src src-shell">String to interpolate: <span style="color: #8b2252;">'${My:pipe}'</span>
Interpolation result: <span style="color: #8b2252;">'aaa|AAA|bbb|BBB|ccc|CCC'</span>

&#34920;&#36798;&#24335;&#65306;
<span style="color: #0000ff;">sum</span>(sum by(url, game, code) (rate(Fb_Net_Code_count{<span style="color: #a0522d;">game</span>=~<span style="color: #8b2252;">".*"</span>,<span style="color: #a0522d;">url</span>=~<span style="color: #8b2252;">".*(${My:pipe})"</span>,url!~<span style="color: #8b2252;">".*\\.(png|jpg|jpeg|json)"</span>,<span style="color: #a0522d;">prom_cluster</span>=<span style="color: #8b2252;">"prod-eks-client"</span>}[30s])))by (url)
&#35299;&#26512;&#21518;&#65306;
<span style="color: #0000ff;">sum</span>(sum by(url, game, code) (rate(Fb_Net_Code_count{<span style="color: #a0522d;">game</span>=~<span style="color: #8b2252;">".*"</span>,<span style="color: #a0522d;">url</span>=~<span style="color: #8b2252;">".*(aaa|AAA|bbb|BBB|ccc|CCCC)"</span>,url!~<span style="color: #8b2252;">".*\\.(png|jpg|jpeg|json)"</span>,<span style="color: #a0522d;">prom_cluster</span>=<span style="color: #8b2252;">"prod-eks-client"</span>}[30s])))by (url)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:c5d5ba75-c5b0-44e8-8b96-2846bf43adce" class="outline-3">
<h3 id="h:c5d5ba75-c5b0-44e8-8b96-2846bf43adce">alertmanager webhook json</h3>
<div class="outline-text-3" id="text-h:c5d5ba75-c5b0-44e8-8b96-2846bf43adce">
<p>
å¼€å‘å‚è€ƒï¼š<a href="https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/alert-manager-use-receiver/alert-manager-extension-with-webhook">https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/alert-manager-use-receiver/alert-manager-extension-with-webhook</a>
</p>


<p>
ä½¿ç”¨webhookæ–¹å¼ï¼Œalertmanagerä¼šç»™é…ç½®çš„webhookåœ°å€å‘é€ä¸€ä¸ªhttpç±»å‹çš„postè¯·æ±‚ï¼Œå‚æ•°ä¸ºjsonå­—ç¬¦ä¸²ï¼ˆå­—ç¬¦ä¸²ç±»å‹ï¼‰ï¼Œå¦‚ä¸‹ï¼ˆæ­¤å¤„æ ¼å¼åŒ–ä¸ºjsonäº†ï¼‰ï¼š
</p>

<p>
<a href="https://prometheus.io/docs/alerting/latest/configuration/#webhook_config">https://prometheus.io/docs/alerting/latest/configuration/#webhook_config</a>
</p>

<div class="org-src-container">
<pre class="src src-shell">{
    <span style="color: #8b2252;">"receiver"</span>:<span style="color: #8b2252;">"webhook"</span>,
    <span style="color: #8b2252;">"status"</span>:<span style="color: #8b2252;">"resolved"</span>,
    <span style="color: #8b2252;">"alerts"</span>:[
        {
            <span style="color: #8b2252;">"status"</span>:<span style="color: #8b2252;">"resolved"</span>,
            <span style="color: #8b2252;">"labels"</span>:{
                <span style="color: #8b2252;">"alertname"</span>:<span style="color: #8b2252;">"hostCpuUsageAlert"</span>,
                <span style="color: #8b2252;">"instance"</span>:<span style="color: #8b2252;">"192.168.199.24:9100"</span>,
                <span style="color: #8b2252;">"severity"</span>:<span style="color: #8b2252;">"page"</span>
            },
            <span style="color: #8b2252;">"annotations"</span>:{
                <span style="color: #8b2252;">"description"</span>:<span style="color: #8b2252;">"192.168.199.24:9100 CPU &#20351;&#29992;&#29575;&#36229;&#36807; 85% (&#24403;&#21069;&#20540;&#20026;: 0.9973333333333395)"</span>,
                <span style="color: #8b2252;">"summary"</span>:<span style="color: #8b2252;">"&#26426;&#22120; 192.168.199.24:9100 CPU &#20351;&#29992;&#29575;&#36807;&#39640;"</span>
            },
            <span style="color: #8b2252;">"startsAt"</span>:<span style="color: #8b2252;">"2020-02-29T19:45:21.799548092+08:00"</span>,
            <span style="color: #8b2252;">"endsAt"</span>:<span style="color: #8b2252;">"2020-02-29T19:49:21.799548092+08:00"</span>,
            <span style="color: #8b2252;">"generatorURL"</span>:<span style="color: #8b2252;">"http://localhost.localdomain:9090/graph?g0.expr=sum+by%28instance%29+%28avg+without%28cpu%29+%28irate%28node_cpu_seconds_total%7Bmode%21%3D%22idle%22%7D%5B5m%5D%29%29%29+%3E+0.85&amp;g0.tab=1"</span>,
            <span style="color: #8b2252;">"fingerprint"</span>:<span style="color: #8b2252;">"368e9616d542ab48"</span>
        }
    ],
    <span style="color: #8b2252;">"groupLabels"</span>:{
        <span style="color: #8b2252;">"alertname"</span>:<span style="color: #8b2252;">"hostCpuUsageAlert"</span>
    },
    <span style="color: #8b2252;">"commonLabels"</span>:{
        <span style="color: #8b2252;">"alertname"</span>:<span style="color: #8b2252;">"hostCpuUsageAlert"</span>,
        <span style="color: #8b2252;">"instance"</span>:<span style="color: #8b2252;">"192.168.199.24:9100"</span>,
        <span style="color: #8b2252;">"severity"</span>:<span style="color: #8b2252;">"page"</span>
    },
    <span style="color: #8b2252;">"commonAnnotations"</span>:{
        <span style="color: #8b2252;">"description"</span>:<span style="color: #8b2252;">"192.168.199.24:9100 CPU &#20351;&#29992;&#29575;&#36229;&#36807; 85% (&#24403;&#21069;&#20540;&#20026;: 0.9973333333333395)"</span>,
        <span style="color: #8b2252;">"summary"</span>:<span style="color: #8b2252;">"&#26426;&#22120; 192.168.199.24:9100 CPU &#20351;&#29992;&#29575;&#36807;&#39640;"</span>
    },
    <span style="color: #8b2252;">"externalURL"</span>:<span style="color: #8b2252;">"http://localhost.localdomain:9093"</span>,
    <span style="color: #8b2252;">"version"</span>:<span style="color: #8b2252;">"4"</span>,
    <span style="color: #8b2252;">"groupKey"</span>:<span style="color: #8b2252;">"{}:{alertname="</span>hostCpuUsageAlert<span style="color: #8b2252;">"}"</span>
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:efe9f42f-ac0d-4231-a8ee-71b44e1420ad" class="outline-3">
<h3 id="h:efe9f42f-ac0d-4231-a8ee-71b44e1420ad">PromSQL</h3>
<div class="outline-text-3" id="text-h:efe9f42f-ac0d-4231-a8ee-71b44e1420ad">
<p>
<a href="https://valyala.medium.com/promql-tutorial-for-beginners-9ab455142085">https://valyala.medium.com/promql-tutorial-for-beginners-9ab455142085</a>
</p>

<p>
Metric åç§°åªæ˜¯ä¸€ä¸ªå¸¦æœ‰ç‰¹æ®Šåç§°çš„æ™®é€šæ ‡ç­¾â€”â€”  <code>__name__</code>. å› æ­¤ï¼Œå¯ä»¥é€šè¿‡å¯¹æŒ‡æ ‡åç§°åº”ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æ‰§è¡Œå¤šä¸ªæŒ‡æ ‡åç§°çš„è¿‡æ»¤ã€‚
</p>
<div class="org-src-container">
<pre class="src src-shell">{<span style="color: #a0522d;">__name__</span>=~<span style="color: #8b2252;">"node_network_(receive|transmit)_bytes_total"</span>}

{<span style="color: #a0522d;">__name__</span>=~<span style="color: #8b2252;">".*"</span>,<span style="color: #a0522d;">job</span>=~<span style="color: #8b2252;">"pushgateway"</span>}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:59dc55b1-82c4-4536-b5f1-32a8ba53c03c" class="outline-3">
<h3 id="h:59dc55b1-82c4-4536-b5f1-32a8ba53c03c">prometheus æ•°æ®æ¸…ç†</h3>
<div class="outline-text-3" id="text-h:59dc55b1-82c4-4536-b5f1-32a8ba53c03c">
<p>
<b>æ•°æ®åˆ é™¤</b>
</p>

<p>
ä½¿ç”¨ API éœ€è¦å…ˆæ·»åŠ å¯åŠ¨å‚æ•° â€“web.enable-admin-api æ‰“å¼€.
</p>

<p>
/api/v1/admin/tsdb/delete_series
å¦‚æœæˆåŠŸï¼Œåˆ™è¿”å›204çŠ¶æ€ç ã€‚
è¯¥æ¥å£æœ‰ä»¥ä¸‹ä¸‰ä¸ªå‚æ•°
</p>
<ul class="org-ul">
<li>match[]=ï¼šé€‰æ‹©è¦åˆ é™¤çš„ç³»åˆ—çš„é‡å¤æ ‡ç­¾åŒ¹é…å™¨å‚æ•°ã€‚match[]å¿…é¡»è‡³å°‘æä¾›ä¸€ä¸ªå‚æ•°ã€‚</li>
<li>start=: å¼€å§‹æ—¶é—´æˆ³ã€‚å¯é€‰ï¼Œé»˜è®¤ä¸ºæœ€çŸ­æ—¶é—´ã€‚</li>
<li>end=: ç»“æŸæ—¶é—´æˆ³ã€‚å¯é€‰ï¼Œé»˜è®¤ä¸ºæœ€å¤§å¯èƒ½æ—¶é—´ã€‚</li>
</ul>

<p>
å¦‚æœæ²¡æœ‰æŒ‡å®šå¼€å§‹å’Œç»“æŸæ—¶é—´å°†åˆ é™¤æ•°æ®åº“ä¸­åŒ¹é…çš„æ‰€æœ‰æ•°æ®ã€‚
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#21305;&#37197;&#25968;&#25454;
</span>curl -X POST -g <span style="color: #8b2252;">'http://xxx.com/api/v1/admin/tsdb/delete_series?match[]={wanip="10.244.2.158:9090"}'</span> 

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#25152;&#26377;&#25968;&#25454;
</span>curl -X POST -g <span style="color: #8b2252;">'http://xxx.com/api/v1/admin/tsdb/delete_series?match[]={__name__=~".+"}'</span> 

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#25351;&#23450;&#30340;Metric
</span>curl -X POST -g <span style="color: #8b2252;">'http://127.0.0.1:9090/api/v1/admin/tsdb/delete_series?match[]=node_cpu_seconds_total'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#25351;&#23450; Metric &#21517;&#31216;&#21644;&#29305;&#23450; label &#21517;&#31216;&#30340;&#20840;&#37096;&#25968;&#25454;
</span>curl -X POST -g <span style="color: #8b2252;">'http://127.0.0.1:9090/api/v1/admin/tsdb/delete_series?match[]=node_cpu_seconds_total{mode="idle"}'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#25351;&#23450;&#26102;&#38388;&#33539;&#22260;&#20869;&#30340; Metric &#25968;&#25454;
</span>curl -X POST -g <span style="color: #8b2252;">'http://127.0.0.1:9090/api/v1/admin/tsdb/delete_series?start=1578301194&amp;end=1578301694&amp;match[]=node_cpu_seconds_total{mode="idle"}'</span>


 curl -X POST   -g <span style="color: #8b2252;">'http://127.0.0.1:9090/api/v1/admin/tsdb/delete_series?match[]=redis_seconds_bucket{app="geo"}&amp;start=2023-04-26T04:00:00.000Z'</span>

linux &#21487;&#20197;&#20351;&#29992; 
date +%s <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#24471;&#24403;&#21069;&#30340;&#26102;&#38388;&#25139;&#65292;&#21487;&#20197;&#20351;&#29992; 
</span>date -d <span style="color: #8b2252;">"2019-12-22 00:00:00"</span> +%s <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#25351;&#23450;&#30340;&#26085;&#26399;&#36716;&#25104;&#26102;&#38388;&#25139;&#12290;</span>
</pre>
</div>

<p>
æ­¤æ¥å£ä¼šå°†æ ·æœ¬æ ‡è®°ä¸ºå·²åˆ é™¤ï¼Œæ ‡è®°å†…å®¹å­˜å‚¨åœ¨blockæ–‡ä»¶å¤¹ä¸­çš„tombstonesï¼ŒPrometheuså‘ç”ŸBlockå‹ç¼©æ—¶æˆ–è€…è°ƒç”¨ <code>clean_tombstones</code> æ¥å£æ—¶æ‰ä¼šçœŸæ­£åˆ é™¤æ•°æ®ã€‚
</p>

<p>
<b>åˆ é™¤æ•°æ®çš„æ¸…ç†</b>
</p>

<p>
ä¸Šé¢æˆ‘ä»¬è¯´è¿‡ä½¿ç”¨delete_seriesæ¥å£ä»…ä¼šå°†æ•°æ®æ ‡è¯†ä¸ºâ€åˆ é™¤â€ï¼Œ å¹¶æ²¡æœ‰ä»ç£ç›˜ä¸­çœŸæ­£åˆ é™¤ï¼Œclean_tombstonesæ¥å£å°±æ˜¯è§¦å‘æ¸…ç†åˆ é™¤çš„ã€‚
</p>

<p>
/api/v1/admin/tsdb/clean_tombstones
</p>

<p>
å¦‚æœåˆ é™¤æˆåŠŸï¼Œä¼šè¿”å› 204 ã€‚
</p>

<div class="org-src-container">
<pre class="src src-sh">curl -X POST http://127.0.0.1:9090/api/v1/admin/tsdb/clean_tombstones
</pre>
</div>
</div>
</div>
<div id="outline-container-h:711178d5-9434-45b4-8e2b-247afdb0f7f7" class="outline-3">
<h3 id="h:711178d5-9434-45b4-8e2b-247afdb0f7f7">pushgateway</h3>
<div class="outline-text-3" id="text-h:711178d5-9434-45b4-8e2b-247afdb0f7f7">
</div>
<div id="outline-container-h:d6ccbdf3-13d3-49e7-9fa8-2ccde0f527c8" class="outline-4">
<h4 id="h:d6ccbdf3-13d3-49e7-9fa8-2ccde0f527c8">å®‰è£…</h4>
<div class="outline-text-4" id="text-h:d6ccbdf3-13d3-49e7-9fa8-2ccde0f527c8">
<p>
å‚æ•°
</p>
<div class="org-src-container">
<pre class="src src-shell">--web.listen-address=<span style="color: #8b2252;">":9091"</span>      &#30417;&#21548;Web&#30028;&#38754;&#65292;API&#21644;&#36965;&#27979;&#30340;&#22320;&#22336;&#12290;
--web.telemetry-path=<span style="color: #8b2252;">"/metrics"</span>     &#20844;&#24320;metrics&#30340;&#36335;&#24452;&#12290;
--web.external-url=             &#21487;&#20174;&#22806;&#37096;&#35775;&#38382;Pushgateway&#30340;URL.
--web.route-prefix=<span style="color: #8b2252;">""</span>           Web&#31471;&#28857;&#20869;&#37096;&#36335;&#30001;&#30340;&#21069;&#32512;&#12290; &#40664;&#35748;&#20026;--web.external-url&#30340;&#36335;&#24452;.
--persistence.file=<span style="color: #8b2252;">""</span>           &#24402;&#26723;&#20197;&#20445;&#30041;metrics&#12290; &#22914;&#26524;&#20026;&#31354;&#65292;&#21017;metrics&#20165;&#20445;&#30041;&#22312;&#20869;&#23384;&#20013;.
--persistence.interval=5m       &#20889;&#20837;&#25345;&#20037;&#24615;&#25991;&#20214;&#30340;&#26368;&#23567;&#38388;&#38548;&#12290;
--log.level=<span style="color: #8b2252;">"info"</span>              &#20165;&#35760;&#24405;&#20855;&#26377;&#32473;&#23450;&#20005;&#37325;&#24615;&#25110;&#26356;&#39640;&#20005;&#37325;&#24615;&#30340;&#28040;&#24687;&#12290; &#26377;&#25928;&#32423;&#21035;&#65306;[debug, info, warn, error, fatal]
--log.format=<span style="color: #8b2252;">"logger:stderr"</span>      &#35774;&#32622;&#26085;&#24535;&#30446;&#26631;&#21644;&#26684;&#24335;&#12290; &#31034;&#20363;&#65306;&#8220; logger&#65306;syslog&#65311;<span style="color: #a0522d;">appname</span> = bob&#65286;<span style="color: #a0522d;">local</span> = 7&#8221;&#25110;&#8220; logger&#65306;stdout&#65311;<span style="color: #a0522d;">json</span> = true&#8221;
--version                       &#26174;&#31034;&#24212;&#29992;&#31243;&#24207;&#29256;&#26412;&#12290;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:77378b9a-c99d-4ef0-9edc-0c9a6f8f5c14" class="outline-4">
<h4 id="h:77378b9a-c99d-4ef0-9edc-0c9a6f8f5c14">æ¸…ç†æ•°æ®</h4>
<div class="outline-text-4" id="text-h:77378b9a-c99d-4ef0-9edc-0c9a6f8f5c14">
<p>
<a href="https://p8s.io/docs/pushgateway/">https://p8s.io/docs/pushgateway/</a>
</p>


<p>
æ¯”å¦‚åˆ é™¤ç”± {job="some_job",instance="some_instance"} æ ‡è¯†çš„åˆ†ç»„ä¸­çš„æ‰€æœ‰æŒ‡æ ‡ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥å®ç°ï¼š
</p>
<div class="org-src-container">
<pre class="src src-shell">curl -X DELETE http://pushgateway_ip:9091/metrics/job/some_job/instance/some_instance
</pre>
</div>

<p>
å¦‚æœä½ æƒ³åˆ é™¤æ‰€æœ‰ç»„ä¸­çš„æ‰€æœ‰æŒ‡æ ‡ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥å®ç°ï¼š
</p>

<p>
éœ€è¦å¯ç”¨ -web.enable-admin-api æ¥å¯ç”¨ç®¡ç† API
</p>
<div class="org-src-container">
<pre class="src src-sh">curl -X PUT http://192.168.0.106:30893/api/v1/admin/wipe
</pre>
</div>

<p>
åˆ é™¤ job
</p>
<div class="org-src-container">
<pre class="src src-shell">
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a7b9e28b-349f-468f-9383-85c616c2889a" class="outline-4">
<h4 id="h:a7b9e28b-349f-468f-9383-85c616c2889a">è„šæœ¬</h4>
<div class="outline-text-4" id="text-h:a7b9e28b-349f-468f-9383-85c616c2889a">
<div class="org-src-container">
<pre class="src src-shell">cat service_status.conf
[program:service_monitor]
<span style="color: #a0522d;">command</span> =  /bin/bash /devops/alivecheck/service_monitor.sh
<span style="color: #a0522d;">user</span> = root
<span style="color: #a0522d;">autostart</span> = true
<span style="color: #a0522d;">autorestart</span> = true
<span style="color: #a0522d;">redirect_stderr</span>=true
<span style="color: #a0522d;">stdout_logfile_backups</span> = 5
<span style="color: #a0522d;">stdout_logfile</span> = /devops/alivecheck/service_monitor.log


[root@ip-172-21-89-103 conf.d]# cat /devops/alivecheck/service_monitor.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">
</span>
<span style="color: #483d8b;">source</span> /etc/profile

<span style="color: #a0522d;">SpringBoot</span>=$<span style="color: #a0522d;">1</span>
<span style="color: #a0522d;">hostname1</span>=$(hostname)
<span style="color: #a0522d;">hostname</span>=${<span style="color: #a0522d;">hostname1</span>%%.*}
<span style="color: #a0522d;">service_list</span>=(<span style="color: #8b2252;">"rummy-center"</span> <span style="color: #8b2252;">"rummy-game"</span> <span style="color: #8b2252;">"rummy-gateway"</span> <span style="color: #8b2252;">"rummy-room"</span> <span style="color: #8b2252;">"rummy-user"</span>)

<span style="color: #a020f0;">while </span><span style="color: #483d8b;">true</span>; <span style="color: #a020f0;">do</span>
  <span style="color: #a0522d;">sv1</span>=<span style="color: #8b2252;">""</span>
  <span style="color: #483d8b;">let</span> <span style="color: #a0522d;">n</span>=0
  <span style="color: #483d8b;">let</span> <span style="color: #a0522d;">m</span>=${#<span style="color: #a0522d;">service_list</span>[*]}
  <span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> ${<span style="color: #a0522d;">service_list</span>[*]}; <span style="color: #a020f0;">do</span>
        <span style="color: #a0522d;">va</span>=$(jps -l |grep  <span style="color: #8b2252;">" $i.jar"</span>|awk <span style="color: #8b2252;">'{print $1}'</span>)
        <span style="color: #a020f0;">if</span> [ ! -z <span style="color: #8b2252;">"$va"</span> ]; <span style="color: #a020f0;">then</span>
                <span style="color: #a0522d;">port</span>=$(sudo netstat -tnlp|grep $<span style="color: #a0522d;">va</span>|awk <span style="color: #8b2252;">'{print $4}'</span>|awk -F: <span style="color: #8b2252;">'{print $NF}'</span>)
                <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"podrt"</span>$<span style="color: #a0522d;">port</span>
                <span style="color: #a020f0;">if</span> [ -z $<span style="color: #a0522d;">port</span> ]; <span style="color: #a020f0;">then</span>
                        <span style="color: #a0522d;">cr</span>=0
                <span style="color: #a020f0;">else</span>
                        <span style="color: #a0522d;">cr</span>=$(curl -G -m 10 --connect-timeout 60 -o /dev/null -s -w %{http_code} http://127.0.0.1:$<span style="color: #a0522d;">port</span>/api/health/check)
                <span style="color: #a020f0;">fi</span>
      <span style="color: #a020f0;">else</span>
          <span style="color: #a0522d;">cr</span>=0
      <span style="color: #a020f0;">fi</span>
      <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$i-cr"</span>$<span style="color: #a0522d;">cr</span>
        <span style="color: #a0522d;">sv1</span>=$<span style="color: #a0522d;">sv1</span><span style="color: #8b2252;">"service_status{service_name=\"$i\"} $cr"</span>
        <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">n</span> -lt $<span style="color: #a0522d;">m</span> ]; <span style="color: #a020f0;">then</span>
          <span style="color: #a0522d;">sv1</span>=$<span style="color: #a0522d;">sv1</span><span style="color: #8b2252;">"\n"</span>
        <span style="color: #a020f0;">fi</span>
  <span style="color: #a020f0;">done</span>
<span style="color: #483d8b;">echo</span> -e $<span style="color: #a0522d;">sv1</span> | curl -s --data-binary @- http://172.21.39.120:9091/metrics/job/rummy/hostname/$<span style="color: #a0522d;">hostname</span>/business/Rummy
      <span style="color: #b22222;">#</span><span style="color: #b22222;">echo -e $sv1
</span>  sleep 10
<span style="color: #a020f0;">done</span>
</pre>
</div>

<p>
db
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/</span><span style="color: #a020f0;">bash</span><span style="color: #b22222;">
</span><span style="color: #a0522d;">instance_name</span>=<span style="color: #ff00ff;">`ifconfig |grep 172.21|awk '{print $2}'`</span>
<span style="color: #a020f0;">while</span> (( 0 &lt; 1))
<span style="color: #a020f0;">do</span>
    <span style="color: #a0522d;">count_mysql_long_tran_list</span>=<span style="color: #ff00ff;">`/usr/local/mysql/bin/mysql -u'username' -p'******' -h172.21.89.151 -N -e"
select count(*) from information_schema.innodb_trx where TIMESTAMPDIFF( SECOND, trx_started, now() ) &gt;= 0.5 and TIMESTAMPDIFF( SECOND, trx_started, now() ) &lt; 10 and trx_query not like 'alter%'
UNION ALL
select count(*) from information_schema.innodb_trx where TIMESTAMPDIFF( SECOND, trx_started, now() ) &gt;= 10 and TIMESTAMPDIFF( SECOND, trx_started, now() ) &lt; 30 and trx_query not like 'alter%'
UNION ALL
select count(*) from information_schema.innodb_trx where TIMESTAMPDIFF( SECOND, trx_started, now() ) &gt;= 30 and TIMESTAMPDIFF( SECOND, trx_started, now() ) &lt; 60 and trx_query not like 'alter%'
UNION ALL
select count(*) from information_schema.innodb_trx where TIMESTAMPDIFF( SECOND, trx_started, now() ) &gt;= 60 and trx_query not like 'alter%';"`</span>
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">count_mysql_long_tran_list</span>|awk -F <span style="color: #8b2252;">" "</span> <span style="color: #8b2252;">'{print}'</span>|<span style="color: #a020f0;">while </span><span style="color: #483d8b;">read</span> count_mysql_long_tran_05 count_mysql_long_tran_10 count_mysql_long_tran_30 count_mysql_long_tran_60
    <span style="color: #a020f0;">do</span>
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"count_mysql_long_tran_05 $count_mysql_long_tran_05"</span>|curl --data-binary @- http://172.21.39.120:9091/metrics/job/pushgatway/instance/$<span style="color: #a0522d;">instance_name</span>/business/Wallet
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"count_mysql_long_tran_10 $count_mysql_long_tran_10"</span>|curl --data-binary @- http://172.21.39.120:9091/metrics/job/pushgatway/instance/$<span style="color: #a0522d;">instance_name</span>/business/Wallet
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"count_mysql_long_tran_30 $count_mysql_long_tran_30"</span>|curl --data-binary @- http://172.21.39.120:9091/metrics/job/pushgatway/instance/$<span style="color: #a0522d;">instance_name</span>/business/Wallet
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"count_mysql_long_tran_60 $count_mysql_long_tran_60"</span>|curl --data-binary @- http://172.21.39.120:9091/metrics/job/pushgatway/instance/$<span style="color: #a0522d;">instance_name</span>/business/Wallet
    <span style="color: #a020f0;">done</span>
sleep 1
<span style="color: #a020f0;">done</span>
</pre>
</div>

<p>
python
</p>
<div class="org-src-container">
<pre class="src src-shell">[root@ip-172-21-39-120 conf.d]# cat  /data/devops/wallet_sql_exception_check/check_index.py
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">-*- encoding: utf-8 -*-
</span><span style="color: #8b2252;">'''
@File    :   1.py
@Time    :   2021/01/19 16:18:46
@Author  :   jack fu
@Version :   1.0
@Contact :   jack.fu@paytm.com
'''</span>
import datetime
import time
import requests
<span style="color: #a0522d;">base_url</span> = <span style="color: #8b2252;">"http://172.21.38.147:9200"</span>


def send_dingtalk(data):

    <span style="color: #a0522d;">token</span> = <span style="color: #8b2252;">"ac3e20cca5147c"</span>
    <span style="color: #a020f0;">if</span> not token:
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'you must set ROBOT_TOKEN env'</span>)
        <span style="color: #a020f0;">return</span>
    <span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'http://maven.xxx.com/robot/send?access_token=%s'</span> % token
    <span style="color: #a0522d;">send_data</span> = {<span style="color: #8b2252;">"msgtype"</span>: <span style="color: #8b2252;">"text"</span>, <span style="color: #8b2252;">"text"</span>: {<span style="color: #8b2252;">"content"</span>: data}}
    <span style="color: #a0522d;">req</span> = requests.post(url, <span style="color: #a0522d;">json</span>=send_data)
    <span style="color: #a0522d;">result</span> = req.json()
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"error"</span>, result)
    <span style="color: #a020f0;">if</span> result[<span style="color: #8b2252;">'errcode'</span>] != 0:
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'notify dingtalk error: %s'</span> % result[<span style="color: #8b2252;">'errcode'</span>])


<span style="color: #b22222;">#</span><span style="color: #b22222;">def get_mysql_gone_away_err(time_start, time_end,error_type='php-mis-err'):
</span>def get_mysql_gone_away_err():
    <span style="color: #a0522d;">response</span> = requests.get(
        f<span style="color: #8b2252;">'{base_url}/wallet-*/_search?filter_path=aggregations.group.buckets'</span>,
        <span style="color: #a0522d;">headers</span>={<span style="color: #8b2252;">'content-type'</span>: <span style="color: #8b2252;">'application/json'</span>},
        <span style="color: #a0522d;">json</span>={
            <span style="color: #8b2252;">"sort"</span>: [{
                <span style="color: #8b2252;">"@timestamp"</span>: {
                    <span style="color: #8b2252;">"order"</span>: <span style="color: #8b2252;">"desc"</span>,
                    <span style="color: #8b2252;">"unmapped_type"</span>: <span style="color: #8b2252;">"boolean"</span>
                }
            }],
            <span style="color: #8b2252;">"aggs"</span>: {
                <span style="color: #8b2252;">"group"</span>: {
                    <span style="color: #8b2252;">"date_histogram"</span>: {
                        <span style="color: #8b2252;">"field"</span>: <span style="color: #8b2252;">"@timestamp"</span>,
                        <span style="color: #8b2252;">"interval"</span>: <span style="color: #8b2252;">"1d"</span>,
                        <span style="color: #8b2252;">"time_zone"</span>: <span style="color: #8b2252;">"Asia/Shanghai"</span>,
                        <span style="color: #8b2252;">"min_doc_count"</span>: 1
                    }
                }
            },
            <span style="color: #8b2252;">"query"</span>: {
                <span style="color: #8b2252;">"bool"</span>: {
                    <span style="color: #8b2252;">"must"</span>: [{
                        <span style="color: #8b2252;">"query_string"</span>: {
                            <span style="color: #8b2252;">"query"</span>: <span style="color: #8b2252;">"\"Connection is not available\""</span>,
                            <span style="color: #8b2252;">"analyze_wildcard"</span>: True,
                            <span style="color: #8b2252;">"default_field"</span>: <span style="color: #8b2252;">"*"</span>
                        }
                    }, {
                        <span style="color: #8b2252;">"range"</span>: {
                            <span style="color: #8b2252;">"@timestamp"</span>: {
                                <span style="color: #8b2252;">"gt"</span>: <span style="color: #8b2252;">"now-2m"</span>,
                                <span style="color: #8b2252;">"lt"</span>: <span style="color: #8b2252;">"now"</span>
                            }
                        }
                    }]
                }
            }
        })
    <span style="color: #483d8b;">print</span>(response.text)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">get_mysql_gone_away_err()
</span>    <span style="color: #a0522d;">buckets</span> = response.json().get(<span style="color: #8b2252;">'aggregations'</span>).get(<span style="color: #8b2252;">'group'</span>).get(<span style="color: #8b2252;">'buckets'</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">print(buckets)
</span>    <span style="color: #a0522d;">date_cnt_arr</span> = []
    <span style="color: #a020f0;">for</span> _sub_bucket<span style="color: #a020f0;"> in</span> buckets:
        date_cnt_arr.append( f<span style="color: #8b2252;">'''Alert: wallet sql exception Connection is not avaliable {_sub_bucket.get('</span>key_as_string<span style="color: #8b2252;">')[:10]} count: {_sub_bucket.get('</span>doc_count<span style="color: #8b2252;">')}'''</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">return int(time.time()) - utc_to_local(end_source['@timestamp'])
</span>    <span style="color: #a0522d;">alert_msg</span> = <span style="color: #8b2252;">"\n"</span>.join(date_cnt_arr)
    <span style="color: #483d8b;">print</span>(alert_msg)

    <span style="color: #a020f0;">if</span> len(alert_msg) &gt; 5:
        send_dingtalk(alert_msg)
        time.sleep(30)
    <span style="color: #a020f0;">else</span>:
        pass


<span style="color: #a020f0;">if</span> <span style="color: #a0522d;">__name__</span> == <span style="color: #8b2252;">"__main__"</span>:
    <span style="color: #a020f0;">while</span> True:
      get_mysql_gone_away_err()
      time.sleep(30)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ff228fea-7a85-47ec-b622-7c0a340fb9aa" class="outline-4">
<h4 id="h:ff228fea-7a85-47ec-b622-7c0a340fb9aa">pushway è„šæœ¬</h4>
<div class="outline-text-4" id="text-h:ff228fea-7a85-47ec-b622-7c0a340fb9aa">
<p>
service_monitor.sh
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/</span><span style="color: #a020f0;">bash</span><span style="color: #b22222;">
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">
</span>
<span style="color: #483d8b;">source</span> /etc/profile

<span style="color: #a0522d;">SpringBoot</span>=$<span style="color: #a0522d;">1</span>
<span style="color: #a0522d;">hostname1</span>=$(hostname)
<span style="color: #a0522d;">hostname</span>=${<span style="color: #a0522d;">hostname1</span>%%.*}
<span style="color: #a0522d;">service_list</span>=(<span style="color: #8b2252;">"rummy-center"</span> <span style="color: #8b2252;">"rummy-game"</span> <span style="color: #8b2252;">"rummy-gateway"</span> <span style="color: #8b2252;">"rummy-room"</span> <span style="color: #8b2252;">"rummy-user"</span>)

<span style="color: #a020f0;">while </span><span style="color: #483d8b;">true</span>; <span style="color: #a020f0;">do</span>
  <span style="color: #a0522d;">sv1</span>=<span style="color: #8b2252;">""</span>
  <span style="color: #483d8b;">let</span> <span style="color: #a0522d;">n</span>=0
  <span style="color: #483d8b;">let</span> <span style="color: #a0522d;">m</span>=${#<span style="color: #a0522d;">service_list</span>[*]}
  <span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> ${<span style="color: #a0522d;">service_list</span>[*]}; <span style="color: #a020f0;">do</span>
        <span style="color: #a0522d;">va</span>=$(jps -l |grep  <span style="color: #8b2252;">" $i.jar"</span>|awk <span style="color: #8b2252;">'{print $1}'</span>)
        <span style="color: #a020f0;">if</span> [ ! -z <span style="color: #8b2252;">"$va"</span> ]; <span style="color: #a020f0;">then</span>
                <span style="color: #a0522d;">port</span>=$(sudo netstat -tnlp|grep $<span style="color: #a0522d;">va</span>|awk <span style="color: #8b2252;">'{print $4}'</span>|awk -F: <span style="color: #8b2252;">'{print $NF}'</span>)
                <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"podrt"</span>$<span style="color: #a0522d;">port</span>
                <span style="color: #a020f0;">if</span> [ -z $<span style="color: #a0522d;">port</span> ]; <span style="color: #a020f0;">then</span>
                        <span style="color: #a0522d;">cr</span>=0
                <span style="color: #a020f0;">else</span>
                        <span style="color: #a0522d;">cr</span>=$(curl -G -m 10 --connect-timeout 60 -o /dev/null -s -w %{http_code} http://127.0.0.1:$<span style="color: #a0522d;">port</span>/api/health/check)
                <span style="color: #a020f0;">fi</span>
      <span style="color: #a020f0;">else</span>
          <span style="color: #a0522d;">cr</span>=0
      <span style="color: #a020f0;">fi</span>
      <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$i-cr"</span>$<span style="color: #a0522d;">cr</span>
        <span style="color: #a0522d;">sv1</span>=$<span style="color: #a0522d;">sv1</span><span style="color: #8b2252;">"service_status{service_name=\"$i\"} $cr"</span>
        <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">n</span> -lt $<span style="color: #a0522d;">m</span> ]; <span style="color: #a020f0;">then</span>
          <span style="color: #a0522d;">sv1</span>=$<span style="color: #a0522d;">sv1</span><span style="color: #8b2252;">"\n"</span>
        <span style="color: #a020f0;">fi</span>
  <span style="color: #a020f0;">done</span>
<span style="color: #483d8b;">echo</span> -e $<span style="color: #a0522d;">sv1</span> | curl -s --data-binary @- http://172.21.39.120:9091/metrics/job/rummy/hostname/$<span style="color: #a0522d;">hostname</span>/business/Rummy
      <span style="color: #b22222;">#</span><span style="color: #b22222;">echo -e $sv1
</span>  sleep 10
<span style="color: #a020f0;">done</span>
</pre>
</div>

<p>
process_monitor.sh
</p>

<div class="org-src-container">
<pre class="src src-shell">cat  /devops/alivecheck/process_monitor.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">
</span><span style="color: #a0522d;">SpringBoot</span>=$<span style="color: #a0522d;">1</span>
<span style="color: #a0522d;">hostname1</span>=$(hostname)
<span style="color: #a0522d;">hostname</span>=${<span style="color: #a0522d;">hostname1</span>%%.*}
<span style="color: #a0522d;">service_list</span>=(<span style="color: #8b2252;">"rummy-center"</span> <span style="color: #8b2252;">"rummy-game"</span> <span style="color: #8b2252;">"rummy-gateway"</span> <span style="color: #8b2252;">"rummy-room"</span> <span style="color: #8b2252;">"rummy-user"</span>)

<span style="color: #a020f0;">while </span><span style="color: #483d8b;">true</span>; <span style="color: #a020f0;">do</span>
  <span style="color: #a0522d;">sv1</span>=<span style="color: #8b2252;">""</span>
  <span style="color: #483d8b;">let</span> <span style="color: #a0522d;">n</span>=0
  <span style="color: #483d8b;">let</span> <span style="color: #a0522d;">m</span>=${#<span style="color: #a0522d;">service_list</span>[*]}
  <span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> ${<span style="color: #a0522d;">service_list</span>[*]}; <span style="color: #a020f0;">do</span>
      <span style="color: #a0522d;">n</span>=$((n+1))
      <span style="color: #b22222;">#</span><span style="color: #b22222;">z=$(ps -ef |grep java|grep $i.jar|grep -v grep|wc -l)
</span>      <span style="color: #b22222;"># </span><span style="color: #b22222;">last modtify by song 20200205 add merchantpush svc monitor
</span>      <span style="color: #a0522d;">z</span>=$(ps -ef |grep java|grep <span style="color: #8b2252;">" $i.jar"</span>|grep -v grep|wc -l)
      <span style="color: #a0522d;">sv1</span>=$<span style="color: #a0522d;">sv1</span><span style="color: #8b2252;">"alive_check{service_name=\"$i\"} $z"</span>
      <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">n</span> -lt $<span style="color: #a0522d;">m</span> ]; <span style="color: #a020f0;">then</span>
        <span style="color: #a0522d;">sv1</span>=$<span style="color: #a0522d;">sv1</span><span style="color: #8b2252;">"\n"</span>
      <span style="color: #a020f0;">fi</span>
  <span style="color: #a020f0;">done</span>
<span style="color: #483d8b;">echo</span> -e $<span style="color: #a0522d;">sv1</span> | curl -s --data-binary @- http://172.21.39.120:9091/metrics/job/rummy/hostname/$<span style="color: #a0522d;">hostname</span>/business/Rummy
      <span style="color: #483d8b;">echo</span> -e $<span style="color: #a0522d;">sv1</span>
  sleep 10
<span style="color: #a020f0;">done</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">curl -XPOST -H "Content-Type: text/plain" --data "$var
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">" http://172.21.39.69:9091/metrics/job/top/instance/machine</span>
</pre>
</div>

<p>
redisClusterAliveCheck.sh
</p>
<div class="org-src-container">
<pre class="src src-shell">cat /devops/alivecheck/redisClusterAliveCheck.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">
</span><span style="color: #a0522d;">SpringBoot</span>=$<span style="color: #a0522d;">1</span>
<span style="color: #a0522d;">hostname1</span>=$(hostname)
<span style="color: #a0522d;">hostname</span>=${<span style="color: #a0522d;">hostname1</span>%%.*}
<span style="color: #b22222;">#</span><span style="color: #b22222;">service_list=("mainserver" "eurekaserver")
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">service_list=('["push.jar", "usercenter.jar", "scheduler.jar", "mylibrary.jar", "game.jar", "filesystem.jar"]')
</span><span style="color: #a0522d;">server_list</span>=(<span style="color: #8b2252;">"agt-newrummy-prod.8r1pyf.ng.0001.aps1.cache.amazonaws.com"</span> <span style="color: #8b2252;">"agt-newrummy-prod-001.8r1pyf.0001.aps1.cache.amazonaws.com"</span> <span style="color: #8b2252;">"agt-newrummy-prod-002.8r1pyf.0001.aps1.cache.amazonaws.com
"</span>)
<span style="color: #b22222;">#</span><span style="color: #b22222;">/usr/bin/redis-cli -h  agt-gpl-game-cache.8r1pyf.0001.aps1.cache.amazonaws.com EXISTS "MMO_SERVER_ADDRESS"
</span><span style="color: #a020f0;">while </span><span style="color: #483d8b;">true</span>; <span style="color: #a020f0;">do</span>
  <span style="color: #a0522d;">sv2</span>=<span style="color: #8b2252;">""</span>
  <span style="color: #483d8b;">let</span> <span style="color: #a0522d;">n</span>=0
  <span style="color: #483d8b;">let</span> <span style="color: #a0522d;">m</span>=${#<span style="color: #a0522d;">server_list</span>[*]}
  <span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> ${<span style="color: #a0522d;">server_list</span>[*]}; <span style="color: #a020f0;">do</span>
      <span style="color: #a0522d;">n</span>=$((n+1))
      <span style="color: #b22222;">#</span><span style="color: #b22222;">z=$(/usr/bin/redis-cli -h  agt-gpl-game-cache.8r1pyf.0001.aps1.cache.amazonaws.com EXISTS $i)
</span>      <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"***************************"</span>$(date)<span style="color: #8b2252;">"*********************************"</span> &gt;&gt; /devops/alivecheck/redisali.log
      $(timeout 5 /bin/redis-cli -h $<span style="color: #a0522d;">i</span> INFO &gt;&gt; /devops/alivecheck/redisali.log)
      <span style="color: #b22222;">#</span><span style="color: #b22222;">echo "ZZZZ" $z
</span>      <span style="color: #a0522d;">sv1</span>=$<span style="color: #a0522d;">?</span>
      <span style="color: #a0522d;">sv2</span>=$<span style="color: #a0522d;">sv2</span><span style="color: #8b2252;">"redisAliveCheck{key_name=\"$i\"} $sv1"</span>

      <span style="color: #a020f0;">if</span> [ <span style="color: #8b2252;">"$sv1"</span> -ne 0 ]; <span style="color: #a020f0;">then</span>
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"***************************"</span>${<span style="color: #a0522d;">hostname</span>}${<span style="color: #a0522d;">i</span>} connected out <span style="color: #8b2252;">"*********************************"</span> &gt;&gt; /devops/alivecheck/redisali.log
      <span style="color: #a020f0;">fi</span>

      <span style="color: #b22222;">#</span><span style="color: #b22222;">echo "iiiiiiqqq" $?
</span>      <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">n</span> -lt $<span style="color: #a0522d;">m</span> ]; <span style="color: #a020f0;">then</span>
        <span style="color: #a0522d;">sv2</span>=$<span style="color: #a0522d;">sv2</span><span style="color: #8b2252;">"\n"</span>
      <span style="color: #a020f0;">fi</span>
   <span style="color: #a020f0;">done</span>
      <span style="color: #483d8b;">echo</span> -e $<span style="color: #a0522d;">sv2</span> | curl --data-binary @- http://172.21.39.120:9091/metrics/job/redisAliveCheck/hostname/$<span style="color: #a0522d;">hostname</span>
      <span style="color: #483d8b;">echo</span> -e $<span style="color: #a0522d;">sv2</span>
  sleep 5
<span style="color: #a020f0;">done</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">curl -XPOST -H "Content-Type: text/plain" --data "$var
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">" http://172.21.39.69:9091/metrics/job/top/instance/machine</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:8b99ae58-538e-4c00-a31b-018b034f9d37" class="outline-3">
<h3 id="h:8b99ae58-538e-4c00-a31b-018b034f9d37">å‘Šè­¦é’‰é’‰é€šçŸ¥</h3>
<div class="outline-text-3" id="text-h:8b99ae58-538e-4c00-a31b-018b034f9d37">
<p>
github åœ°å€ï¼š<a href="https://github.com/timonwong/prometheus-webhook-dingtalk">https://github.com/timonwong/prometheus-webhook-dingtalk</a>
</p>

<p>
é…ç½®
</p>
<div class="org-src-container">
<pre class="src src-shell">[root@ip-172-21-39-120 prometheus-webhook-dingtalk]# cat config.yml
templates:
  - /data/devops/prometheus-webhook-dingtalk/contrib/templates/legacy/template.tmpl

targets:
  wallet-webhook-critical:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">Wallet PRD &#21578;&#35686;&#32676;
</span>    url: https://oapi.dingtalk.com/robot/send?<span style="color: #a0522d;">access_token</span>=xxx
    <span style="color: #b22222;"># </span><span style="color: #b22222;">secret for signature
</span>    secret: SEC268ff4d02ac
  wallet-webhook-warning:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">Wallet PRD INFO &#21578;&#35686;&#32676;
</span>    url: https://oapi.dingtalk.com/robot/send?<span style="color: #a0522d;">access_token</span>=xxx
    <span style="color: #b22222;"># </span><span style="color: #b22222;">secret for signature
</span>    secret: SECeb2b2    
</pre>
</div>

<p>
æ¨¡æ¿è¯­æ³•ä½¿ç”¨ go templateã€‚<a href="https://github.com/timonwong/prometheus-webhook-dingtalk/blob/main/docs/FAQ_zh.md">https://github.com/timonwong/prometheus-webhook-dingtalk/blob/main/docs/FAQ_zh.md</a>
</p>
</div>
<div id="outline-container-h:c5a0a9ac-76dc-4f21-9b6d-4412ca9b6711" class="outline-4">
<h4 id="h:c5a0a9ac-76dc-4f21-9b6d-4412ca9b6711">é’‰é’‰æŠ¥è­¦æ¨¡æ¿</h4>
<div class="outline-text-4" id="text-h:c5a0a9ac-76dc-4f21-9b6d-4412ca9b6711">
<div class="org-src-container">
<pre class="src src-shell"> cat /data/devops/prometheus-webhook-dingtalk/contrib/templates/legacy/template.tmpl
// {{ define <span style="color: #8b2252;">"ding.link.title"</span> }}{{ template <span style="color: #8b2252;">"legacy.title"</span> . }}{{ end }}
//  {{ define <span style="color: #8b2252;">"ding.link.content"</span> }}{{ template <span style="color: #8b2252;">"legacy.content"</span> . }}{{ end }}
{{ define <span style="color: #8b2252;">"__text_alert_list"</span> }}{{ range . }}
&#21578;&#35686;&#20027;&#39064;: {{ .Annotations.summary }}

&#21578;&#35686;&#35814;&#24773;: {{ .Annotations.description }}

&#21578;&#35686;&#23454;&#20363;: {{ .Labels.instance }}

Pod &#21517;&#31216;: {{ .Labels.pod }}

&#21578;&#35686;&#32423;&#21035;: {{ .Labels.severity }}

&#21578;&#35686;&#29366;&#24577;: {{ .Status }}

&#21578;&#35686;&#26102;&#38388;: {{ (.StartsAt.Add 28800e9).Format <span style="color: #8b2252;">"2006-01-02 15:04:05"</span> }}

------------------------
{{ end }}{{ end }}

{{ define <span style="color: #8b2252;">"__text_resolve_list"</span> }}{{ range .  }}
&#21578;&#35686;&#20027;&#39064;: {{ .Annotations.summary }}

&#21578;&#35686;&#35814;&#24773;: {{ .Annotations.description }}

&#21578;&#35686;&#23454;&#20363;: {{ .Labels.instance }}

Pod &#21517;&#31216;: {{ .Labels.pod }}

&#21578;&#35686;&#32423;&#21035;: {{ .Labels.severity }}

&#21578;&#35686;&#29366;&#24577;: {{ .Status }}

&#21578;&#35686;&#26102;&#38388;: {{ (.StartsAti.Add 28800e9).Format <span style="color: #8b2252;">"2006-01-02 15:04:05"</span> }}

&#24674;&#22797;&#26102;&#38388;: {{ (.EndsAti.Add 28800e9).Format <span style="color: #8b2252;">"2006-01-02 15:04:05"</span> }}

------------------------
{{ end }}{{ end }}
</pre>
</div>



<div class="org-src-container">
<pre class="src src-shell">{{ .GeneratorURL }} &#65306;  &#33719;&#21462; prometheus external-url&#65292;&#22686;&#21152; prometheus &#21551;&#21160;&#21442;&#25968;&#22914; --web.external-url=https://prometheus.xxx.com/eks
{{ define <span style="color: #8b2252;">"__alertmanagerURL"</span> }}: &#20989;&#25968;&#33719;&#21462; alertmanager external-url&#65292;&#22686;&#21152; alertmanager &#21551;&#21160;&#21442;&#25968;&#22914; --web.external-url=https://alertmanager.xxx.com
</pre>
</div>

<p>
å¯åŠ¨è„šæœ¬
</p>
<div class="org-src-container">
<pre class="src src-shell">cat /etc/systemd/system/prometheus-webhook-dingtalk.service
[Unit]
<span style="color: #a0522d;">Description</span>=prometheus-webhook-dingtalk
<span style="color: #a0522d;">After</span>=network-online.target

[Service]
<span style="color: #a0522d;">Restart</span>=on-failure
<span style="color: #a0522d;">ExecStart</span>=/data/devops/prometheus-webhook-dingtalk/prometheus-webhook-dingtalk --config.file=/data/devops/prometheus-webhook-dingtalk/config.yml

[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target

</pre>
</div>
</div>
</div>
<div id="outline-container-h:d5917aef-b520-4eec-bb3b-fdd28f1560b0" class="outline-4">
<h4 id="h:d5917aef-b520-4eec-bb3b-fdd28f1560b0">k8s éƒ¨ç½²</h4>
<div class="outline-text-4" id="text-h:d5917aef-b520-4eec-bb3b-fdd28f1560b0">
<p>
configmap.yaml
</p>
<div class="org-src-container">
<pre class="src src-yaml">---
kind: ConfigMap
apiVersion: v1
metadata:
  name: prometheus-webhook-dingtalk-config
  namespace: monitoring
data:
  config.yml: |-
    templates:
      - /config/template.tmpl
    targets:
      default-webhook-warning:
        # é»˜è®¤å‘Šè­¦ç¾¤
        url: https://oapi.dingtalk.com/robot/send?access_token=xx
        # secret for signature
        secret: SEC4bfd28a4ea2d14836a3db5b2e8101a81d7c72c842b8c05a5b82cb48c5de3c096
  template.tmpl: |-
    {{ define "__subject" }}[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join " " }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}({{ with .CommonLabels.Remove .GroupLabels.Names }}{{ .Values | join " " }}{{ end }}){{ end }}{{ end }}
    {{ define "__alertmanagerURL" }}{{ .ExternalURL }}/#/alerts?receiver={{ .Receiver }}{{ end }}

    {{ define "default.__text_alert_list" }}{{ range . }}
    #### \[{{ .Labels.severity | upper }}\] {{ .Annotations.summary }}

    **Description:** {{ .Annotations.description }}

    **Graph:** [ğŸ“ˆ]({{ .GeneratorURL }})

    **Details:**
    {{ range .Labels.SortedPairs }}{{ if and (ne (.Name) "severity") (ne (.Name) "summary") }}&gt; - {{ .Name }}: {{ .Value | markdown | html }}
    {{ end }}{{ end }}
    {{ end }}{{ end }}

    {{/* Default */}}
    {{ define "default.title" }}{{ template "__subject" . }}{{ end }}
    {{ define "default.content" }}#### \[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}\] **[{{ index .GroupLabels "alertname" }}]({{ template "__alertmanagerURL" . }})**
    {{ if gt (len .Alerts.Firing) 0 -}}
    **Alerts Firing**
    {{ template "default.__text_alert_list" .Alerts.Firing }}
    {{- end }}
    {{ if gt (len .Alerts.Resolved) 0 -}}
    **Alerts Resolved**
    {{ template "default.__text_alert_list" .Alerts.Resolved }}
    {{- end }}
    {{- end }}

    {{/* Customizable templates by jasper */}}
    {{ define "__prometheusURL" }}https://prometheus-prod.xxx.com/eks/alerts{{ end }}
    {{ define "__text_alert_list" }}{{ range . }}
    Summary: {{ .Annotations.summary }}

    Description: {{ .Annotations.description }}

    Graph: [ğŸ“ˆ]({{ .GeneratorURL }})

    Details:
    {{ range .Labels.SortedPairs }}{{ if and (ne (.Name) "severity") (ne (.Name) "summary") }}&gt; - {{ .Name }}: {{ .Value | markdown | html }}
    {{ end }}{{ end }}

    Severity: {{ .Labels.severity }}

    Status: {{ .Status }}

    StartAt: {{ (.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}

    Solution: {{ .Annotations.runbook_url }}

    ------------------------
    {{ end }}{{ end }}

    {{ define "__text_alertresovle_list" }}{{ range .  }}
    Summary: {{ .Annotations.summary }}

    Description: {{ .Annotations.description }}

    Graph: [ğŸ“ˆ]({{ .GeneratorURL }})

    StartsAt: {{ (.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}

    EndsAt: {{ (.EndsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}

    Solution: {{ .Annotations.runbook_url }}

    ------------------------
    {{ end }}{{ end }}

    {{/* Legacy */}}
    {{ define "legacy.title" }}{{ template "__subject" . }}{{ end }}
    {{ define "legacy.content" }}#### \[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}\] **[{{ index .CommonLabels "alertname" }}]({{ template "__alertmanagerURL" . }})**
    {{ if gt (len .Alerts.Firing) 0 -}}
    {{ template "__text_alert_list" .Alerts.Firing }}
    {{- end }}
    {{ if gt (len .Alerts.Resolved) 0 -}}
    {{ template "__text_alertresovle_list" .Alerts.Resolved }}
    {{- end }}
    {{- end }}

    {{/* Following names for compatibility */}}
    {{ define "ding.link.title" }}{{ template "legacy.title" . }}{{ end }}
    {{ define "ding.link.content" }}{{ template "legacy.content" . }}{{ end }}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dingtalk-nginx-ldap
  namespace: monitoring
data:
  app.conf: |-
    upstream dingtalk {
        server prometheus-webhook-dingtalk:8060 weight=1;
    }
    server {
        listen       80;
        server_name  localhost;

        location ~ \.(gif|jpg|png|css|js|svg|woff2|html|json|query)$ {
            proxy_pass http://dingtalk;
        }

        location / {
            proxy_pass http://dingtalk/;
            auth_ldap    "Forbidden";
            auth_ldap_servers   localdir;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }
  nginx.conf: |-
    user  nginx;
    worker_processes  auto;

    error_log  /var/log/nginx/error.log warn;
    pid        /var/run/nginx.pid;

    events {
        worker_connections  1024;
    }

    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;

        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';

        access_log  /var/log/nginx/access.log  main;

        sendfile        on;

        keepalive_timeout  65;

        proxy_ignore_client_abort on;


        ldap_server localdir {
          url ldap://ops-freeipa.xxx.com:389/cn=users,cn=accounts,dc=xxx,dc=com?uid?sub?(&amp;(objectClass=*));
          binddn "uid=admin,cn=users,cn=accounts,dc=xxx,dc=com";
          binddn_passwd "rdIfXD6ZoZ7aBNvY";
          #group_attribute memberuid;
          #group_attribute_is_dn on;
          #require valid_user;
          #max_down_retries 3;
        }

        include /etc/nginx/conf.d/*.conf;
    }
    #include /etc/nginx/tcp.conf;
</pre>
</div>

<p>
service.yaml
</p>
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: v1
kind: Service
metadata:
  name: prometheus-webhook-dingtalk
  namespace: monitoring
  labels:
    app: prometheus-webhook-dingtalk
spec:
  ports:
  - name: http
    protocol: TCP
    port: 8060
    targetPort: 8060
  - name: http-80
    protocol: TCP
    port: 80
    targetPort: 80
  selector:
    app: prometheus-webhook-dingtalk
</pre>
</div>

<p>
deployment.yaml
</p>
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: prometheus-webhook-dingtalk
  name: prometheus-webhook-dingtalk
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus-webhook-dingtalk
  template:
    metadata:
      labels:
        app: prometheus-webhook-dingtalk
    spec:
      nodeSelector:
        type: ops-prod-prometheus
      containers:
      - args:
        - --web.listen-address=:8060
        - --config.file=/config/config.yml
        - --web.enable-ui
        - --web.enable-lifecycle
        image: timonwong/prometheus-webhook-dingtalk:v2.1.0
        imagePullPolicy: IfNotPresent
        name: prometheus-webhook-dingtalk
        ports:
        - containerPort: 8060
          name: http
          protocol: TCP
        resources:
          limits:
            cpu: 1
            memory: 512Mi
          requests:
            cpu: 10m
            memory: 50Mi
        volumeMounts:
        - mountPath: /config
          name: conf
      - args:
        - --webhook-url=http://localhost:8060/-/reload
        - --volume-dir=/config/
        image: jimmidyson/configmap-reload:v0.5.0
        name: module-configmap-reloader
        resources:
          limits:
            cpu: 20m
            memory: 40Mi
          requests:
            cpu: 10m
            memory: 20Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 65534
        volumeMounts:
        - mountPath: /config/
          name: conf
          readOnly: true
      - image: ops-harbor.xxx.com/ops/nginx-ldap
        imagePullPolicy: Always
        name: nginx-ldap
        resources:
          limits:
            cpu: 200m
            memory: 200Mi
          requests:
            cpu: 10m
            memory: 10Mi
        stdin: true
        tty: true
        volumeMounts:
        - mountPath: /etc/nginx/nginx.conf
          name: nginx-conf
          subPath: nginx.conf
        - mountPath: /etc/nginx/conf.d/
          name: nginx-app-conf
      imagePullSecrets:
      - name: docker-secret
      volumes:
      - configMap:
          defaultMode: 420
          name: prometheus-webhook-dingtalk-config
        name: conf
      - configMap:
          defaultMode: 420
          items:
          - key: nginx.conf
            path: nginx.conf
          name: dingtalk-nginx-ldap
        name: nginx-conf
      - configMap:
          defaultMode: 420
          items:
          - key: app.conf
            path: app.conf
          name: dingtalk-nginx-ldap
        name: nginx-app-conf
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ca8d2783-1186-437b-b31e-d14f79500d18" class="outline-3">
<h3 id="h:ca8d2783-1186-437b-b31e-d14f79500d18">éäº‘åŸç”Ÿåº”ç”¨ç›‘æ§ Exporter</h3>
<div class="outline-text-3" id="text-h:ca8d2783-1186-437b-b31e-d14f79500d18">
<p>
å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://prometheus.io/docs/instrumenting/exporters/">https://prometheus.io/docs/instrumenting/exporters/</a>
</p>
</div>
<div id="outline-container-h:a242b9a0-99de-4973-83d9-e2747cacb0ec" class="outline-4">
<h4 id="h:a242b9a0-99de-4973-83d9-e2747cacb0ec">Kafka exporter</h4>
<div class="outline-text-4" id="text-h:a242b9a0-99de-4973-83d9-e2747cacb0ec">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">------------
</span>apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: kafka-exporter
  name: kafka-exporter
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kafka-exporter
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    <span style="color: #483d8b;">type</span>: RollingUpdate
  template:
    metadata:
      labels:
        app: kafka-exporter
    spec:
      containers:
      - args:
        - --kafka.server=kafka-0.kafka-headless.public-service:9092
        env:
        - name: TZ
          value: Asia/Shanghai
        - name: LANG
          value: C.UTF-8
        image: danielqsj/kafka-exporter:latest
        imagePullPolicy: IfNotPresent
        name: kafka-exporter
        ports:
        - containerPort: 9308
          name: web
          protocol: TCP
        resources:
          limits:
            cpu: 249m
            memory: 318Mi
          requests:
            cpu: 10m
            memory: 10Mi
        securityContext:
          allowPrivilegeEscalation: false
          privileged: false
          readOnlyRootFilesystem: false
          runAsNonRoot: false
        volumeMounts:
        - mountPath: /usr/share/zoneinfo/Asia/Shanghai
          name: tz-config
        - mountPath: /etc/localtime
          name: tz-config
        - mountPath: /etc/timezone
          name: timezone
      volumes:
      - hostPath:
          path: /usr/share/zoneinfo/Asia/Shanghai
          <span style="color: #483d8b;">type</span>: <span style="color: #8b2252;">""</span>
        name: tz-config
      - hostPath:
          path: /etc/timezone
          <span style="color: #483d8b;">type</span>: <span style="color: #8b2252;">""</span>
        name: timezone


---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: kafka-exporter
  name: kafka-exporter
  namespace: monitoring
spec:
  ports:
  - name: container-1-web-1
    port: 9308
    protocol: TCP
    targetPort: 9308
  selector:
    app: kafka-exporter
  <span style="color: #483d8b;">type</span>: ClusterIP


---

apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    k8s-app: kafka-exporter
  name: kafka-exporter
  namespace: monitoring
spec:
  endpoints:
  - interval: 30s
    port: container-1-web-1
  namespaceSelector:
    matchNames:
    - monitoring
  selector:
    matchLabels:
      app: kafka-exporter
</pre>
</div>

<p>
åŠ¨æ€å‘ç°
</p>
<div class="org-src-container">
<pre class="src src-shell">cat cas-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kafka-exporter-cas
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kafka-exporter-cas
  template:
    metadata:
      annotations:
        prometheus.io/path: /metrics
        prometheus.io/port: <span style="color: #8b2252;">"9308"</span>
        prometheus.io/scrape: <span style="color: #8b2252;">"true"</span>
      labels:
        app: kafka-exporter-cas
        instance: CAS
    spec:
      containers:
      - command:
        - /bin/sh
        - -c
        - kafka_exporter --kafka.server=172.21.38.219:9092 --kafka.server=172.21.38.233:9092
        image: danielqsj/kafka-exporter:latest
        imagePullPolicy: IfNotPresent
        name: kafka-exporter-cas
        env:
        - name: TZ
          value: Asia/Shanghai
        - name: LANG
          value: C.UTF-8
        ports:
        - containerPort: 9308
          protocol: TCP
        readinessProbe:
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          tcpSocket:
            port: 9308
          timeoutSeconds: 5
        resources:
          limits:
            cpu: 500m
            memory: 1Gi
          requests:
            cpu: 200m
            memory: 10Mi
      imagePullSecrets:
      - name: docker-pull
      nodeSelector:
        eks.amazonaws.com/nodegroup: EKS-DEVOPS-Prometheus
      restartPolicy: Always
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f44b11f1-dbf2-41f2-8c2d-252ece19a380" class="outline-4">
<h4 id="h:f44b11f1-dbf2-41f2-8c2d-252ece19a380">node-exporter</h4>
<div class="outline-text-4" id="text-h:f44b11f1-dbf2-41f2-8c2d-252ece19a380">
<div class="org-src-container">
<pre class="src src-shell">$ ll
node-exporter-clusterRoleBinding.yaml
node-exporter-clusterRole.yaml
node-exporter-daemonset.yaml
node-exporter-serviceAccount.yaml
</pre>
</div>
</div>
<div id="outline-container-h:7c56f1ed-565e-4f25-bcf8-402deaca3cf6" class="outline-5">
<h5 id="h:7c56f1ed-565e-4f25-bcf8-402deaca3cf6">node-exporter-serviceAccount.yaml</h5>
<div class="outline-text-5" id="text-h:7c56f1ed-565e-4f25-bcf8-402deaca3cf6">
<div class="org-src-container">
<pre class="src src-shell">cat node-exporter-serviceAccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: node-exporter
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 1.3.1
  name: node-exporter
  namespace: monitoring
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d27f8e4c-89f6-482d-9396-85422aefe8e7" class="outline-5">
<h5 id="h:d27f8e4c-89f6-482d-9396-85422aefe8e7">node-exporter-clusterRoleBinding.yaml</h5>
<div class="outline-text-5" id="text-h:d27f8e4c-89f6-482d-9396-85422aefe8e7">
<div class="org-src-container">
<pre class="src src-shell">cat node-exporter-clusterRoleBinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: node-exporter
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 1.3.1
  name: node-exporter
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: node-exporter
subjects:
- kind: ServiceAccount
  name: node-exporter
  namespace: monitoring
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3846203e-fd76-4142-9fc5-1a40bd2e7cab" class="outline-5">
<h5 id="h:3846203e-fd76-4142-9fc5-1a40bd2e7cab">node-exporter-clusterRoleBinding.yaml</h5>
<div class="outline-text-5" id="text-h:3846203e-fd76-4142-9fc5-1a40bd2e7cab">
<div class="org-src-container">
<pre class="src src-shell">cat node-exporter-clusterRoleBinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: node-exporter
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 1.3.1
  name: node-exporter
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: node-exporter
subjects:
- kind: ServiceAccount
  name: node-exporter
  namespace: monitoring
[jasper.xu@ip-10-204-43-253 node-exporter]$ cat node-exporter-clusterRole.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: node-exporter
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 1.3.1
  name: node-exporter
rules:
- apiGroups:
  - authentication.k8s.io
  resources:
  - tokenreviews
  verbs:
  - create
- apiGroups:
  - authorization.k8s.io
  resources:
  - subjectaccessreviews
  verbs:
  - create
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bd27efd8-c688-4271-9c06-9120946d58ab" class="outline-5">
<h5 id="h:bd27efd8-c688-4271-9c06-9120946d58ab">node-exporter-daemonset.yaml</h5>
<div class="outline-text-5" id="text-h:bd27efd8-c688-4271-9c06-9120946d58ab">
<div class="org-src-container">
<pre class="src src-shell">cat node-exporter-daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: node-exporter
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: 1.3.1
  name: node-exporter
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: exporter
      app.kubernetes.io/name: node-exporter
      app.kubernetes.io/part-of: kube-prometheus
  template:
    metadata:
      labels:
        app.kubernetes.io/component: exporter
        app.kubernetes.io/name: node-exporter
        app.kubernetes.io/part-of: kube-prometheus
        app.kubernetes.io/version: 1.3.1
    spec:
      automountServiceAccountToken: true
      containers:
      <span style="color: #b22222;">#</span><span style="color: #b22222;">- --web.listen-address=127.0.0.1:9100
</span>      - args:
        - --path.sysfs=/host/sys
        - --path.rootfs=/host/root
        - --no-collector.wifi
        - --no-collector.hwmon
        - --collector.filesystem.mount-points-exclude=^/(dev|proc|sys|run/k3s/containerd/.+|var/lib/docker/.+|var/lib/kubelet/pods/.+)($|/)
        - --collector.netclass.ignored-devices=^(veth.*|[a-f0-9]{15})$
        - --collector.netdev.device-exclude=^(veth.*|[a-f0-9]{15})$
        image: quay.io/prometheus/node-exporter:v1.3.1
        name: node-exporter
        resources:
          limits:
            cpu: 250m
            memory: 180Mi
          requests:
            cpu: 102m
            memory: 180Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            add:
            - SYS_TIME
            drop:
            - ALL
          readOnlyRootFilesystem: true
        ports:
        - containerPort: 9100
          hostPort: 9100
          name: http
        volumeMounts:
        - mountPath: /host/sys
          mountPropagation: HostToContainer
          name: sys
          readOnly: true
        - mountPath: /host/root
          mountPropagation: HostToContainer
          name: root
          readOnly: true
      - args:
        - --logtostderr
        - --secure-listen-address=[$(IP)]:9101
        - --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305
        - --upstream=http://127.0.0.1:9100/
        env:
        - name: IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        image: quay.io/brancz/kube-rbac-proxy:v0.12.0
        name: kube-rbac-proxy
        ports:
        - containerPort: 9101
          hostPort: 9101
          name: https
        resources:
          limits:
            cpu: 20m
            memory: 40Mi
          requests:
            cpu: 10m
            memory: 20Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsGroup: 65532
          runAsNonRoot: true
          runAsUser: 65532
      hostNetwork: true
      hostPID: true
      nodeSelector:
        kubernetes.io/os: linux
      priorityClassName: system-cluster-critical
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
      serviceAccountName: node-exporter
      tolerations:
      - operator: Exists
      volumes:
      - hostPath:
          path: /sys
        name: sys
      - hostPath:
          path: /
        name: root
  updateStrategy:
    rollingUpdate:
      maxUnavailable: 10%
    <span style="color: #483d8b;">type</span>: RollingUpdate
</pre>
</div>
</div>
</div>
<div id="outline-container-h:31d83fec-56e9-404d-be02-7a29bbf99216" class="outline-5">
<h5 id="h:31d83fec-56e9-404d-be02-7a29bbf99216">é™æ€æ³¨å†Œé…ç½®</h5>
<div class="outline-text-5" id="text-h:31d83fec-56e9-404d-be02-7a29bbf99216">
<div class="org-src-container">
<pre class="src src-yaml">- job_name: node-exporter
  honor_timestamps: true
  scrape_interval: 15s
  scrape_timeout: 10s
  metrics_path: /metrics
  scheme: https
  authorization:
    type: Bearer
    credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token
  tls_config:
    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    insecure_skip_verify: true
  follow_redirects: true
  kubernetes_sd_configs:
  - role: node
    kubeconfig_file: ""
    follow_redirects: true
  relabel_configs:
  - source_labels: [__address__]
    separator: ;
    regex: (.*):10250
    target_label: __address__
    replacement: $1:9101
    action: replace
  - source_labels: [__meta_kubernetes_node_label_eks_amazonaws_com_nodegroup]
    separator: ;
    regex: (.*)
    target_label: business
    replacement: $1
    action: replace
  - source_labels: [__meta_kubernetes_node_label_eks_amazonaws_com_nodegroup]
    separator: ;
    regex: (.*)
    target_label: nodegroup
    replacement: $1
    action: replace
  - source_labels: [__meta_kubernetes_node_label_beta_kubernetes_io_instance_type]
    separator: ;
    regex: (.*)
    target_label: instance_type
    replacement: $1
    action: replace
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:225c17b3-0ed3-499b-be9b-8495517fe76b" class="outline-4">
<h4 id="h:225c17b3-0ed3-499b-be9b-8495517fe76b">redis-exporter</h4>
<div class="outline-text-4" id="text-h:225c17b3-0ed3-499b-be9b-8495517fe76b">
<div class="org-src-container">
<pre class="src src-shell">cat redis-exporter.yaml
apiVersion: v1
kind: Service
metadata:
  name: redis-exporter
  namespace: monitoring
  <span style="color: #b22222;">#</span><span style="color: #b22222;">annotations:
</span>  <span style="color: #b22222;">#  </span><span style="color: #b22222;">prometheus.io/scrape: "true"
</span>  labels:
    app: svc-redis-exporter
spec:
  <span style="color: #483d8b;">type</span>: NodePort
  selector:
    app: redis-exporter
  ports:
    - name: tcp-9121
      protocol: TCP
      port: 9121
      targetPort: 9121
---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: monitoring
  name: redis-exporter
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis-exporter
  template:
    metadata:
      <span style="color: #b22222;">#</span><span style="color: #b22222;">annotations:
</span>      <span style="color: #b22222;">#  </span><span style="color: #b22222;">prometheus.io/scrape: "true"
</span>      <span style="color: #b22222;">#  </span><span style="color: #b22222;">prometheus.io/port: "9121"
</span>      labels:
        app: redis-exporter
    spec:
      nodeSelector:
        eks.amazonaws.com/nodegroup: EKS-DEVOPS-Prometheus
      containers:
      - name: redis-exporter
        image: oliver006/redis_exporter:latest
        resources:
          limits:
            cpu: 300m
            memory: 300Mi
          requests:
            cpu: 10m
            memory: 10Mi
        ports:
        - containerPort: 9121
</pre>
</div>

<p>
é™æ€é…ç½®
</p>

<div class="org-src-container">
<pre class="src src-shell">- job_name: <span style="color: #8b2252;">'redis_exporter_targets'</span>
  static_configs:
  - targets:
    - agt-.amazonaws.com:6379
    - redis://agt-necache.amazonaws.com:6379
    - redis://172.21.89.135:6391
    - redis://172.21.89.135:6392
    labels:
      dbtype: db-mysql-db
  metrics_path: /scrape
  relabel_configs:
  - source_labels: [__address__]
    target_label: __param_target
  - source_labels: [__param_target]
    target_label: instance
  - target_label: __address__
    replacement: redis-exporter:9121
</pre>
</div>
</div>
</div>
<div id="outline-container-h:973f36df-5980-4ac8-8f63-7c32474a8afc" class="outline-4">
<h4 id="h:973f36df-5980-4ac8-8f63-7c32474a8afc">rocketmq-exporter</h4>
<div class="outline-text-4" id="text-h:973f36df-5980-4ac8-8f63-7c32474a8afc">
<div class="org-src-container">
<pre class="src src-shell">cat gpl-rocketmq-exporter-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gpl-rocketmq-exporter
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gpl-rocketmq-exporter
  template:
    metadata:
      annotations:
        prometheus.io/path: <span style="color: #8b2252;">"/metrics"</span>
        prometheus.io/port: <span style="color: #8b2252;">"5557"</span>
        prometheus.io/scrape: <span style="color: #8b2252;">"true"</span>
      labels:
        app: gpl-rocketmq-exporter
    spec:
      nodeSelector:
        <span style="color: #483d8b;">type</span>: ops-prod-prometheus
      imagePullSecrets:
      - name: docker-secret
      containers:
      - name: rocketmq-exporter
        image: harbor.xxx.com/devops/rocketmq-exporter:v0.0.2
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5557
        command:
        - /bin/sh
        - -c
        - <span style="color: #8b2252;">'java -jar -Xms2g -Xmx2g -Xmn1024m -Xss256k /opt/rocketmq-exporter/rocketmq-exporter-0.0.2-SNAPSHOT.jar
            --server.port=5557
            --rocketmq.config.namesrvAddr=172.21.89.192:9876'</span>
        readinessProbe:
          tcpSocket:
            port: 5557
          initialDelaySeconds: 5
          timeoutSeconds: 5
        resources:
          limits:
            cpu: 1
            memory: 1Gi
          requests:
            cpu: 10m
            memory: 10Mi
</pre>
</div>

<p>
rocketmq åŠ å¯†
</p>
<div class="org-src-container">
<pre class="src src-shell">cat wallet-rocketmq-exporter-deployment.yaml
apiVersion: apps/v1
kind: Deployment
        command:
        - /bin/sh
        - -c
        - <span style="color: #8b2252;">'java -jar -Xms2g -Xmx2g -Xmn1024m -Xss256k /opt/rocketmq-exporter/rocketmq-exporter-0.0.2-SNAPSHOT.jar
            --server.port=5557
            --rocketmq.config.namesrvAddr=172.21.89.85:9876
            --rocketmq.config.enableACL=true
            --rocketmq.config.accessKey=RocketMQ
            --rocketmq.config.secretKey=12345678'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c3cb474a-e85d-4620-a5a9-0eb259b285b0" class="outline-4">
<h4 id="h:c3cb474a-e85d-4620-a5a9-0eb259b285b0">awk-cloudwatch-exporter</h4>
<div class="outline-text-4" id="text-h:c3cb474a-e85d-4620-a5a9-0eb259b285b0">
<div class="org-src-container">
<pre class="src src-shell">cat cloudwatch-exporter.yaml
---
<span style="color: #b22222;"># </span><span style="color: #b22222;">Source: prometheus-cloudwatch-exporter/templates/serviceaccount.yaml
</span>apiVersion: v1
kind: ServiceAccount
automountServiceAccountToken: true
metadata:
  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
  namespace: monitoring
  labels:
    app: prometheus-cloudwatch-exporter
    chart: prometheus-cloudwatch-exporter-0.19.2
    release: <span style="color: #8b2252;">"cloudwatch-exporter"</span>
    heritage: <span style="color: #8b2252;">"Helm"</span>
---
<span style="color: #b22222;"># </span><span style="color: #b22222;">Source: prometheus-cloudwatch-exporter/templates/secrets.yaml
</span>apiVersion: v1
kind: Secret
metadata:
  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
  namespace: monitoring
  labels:
    app: prometheus-cloudwatch-exporter
    chart: prometheus-cloudwatch-exporter-0.19.2
    heritage: Helm
    release: cloudwatch-exporter
<span style="color: #483d8b;">type</span>: Opaque
data:

  aws_access_key_id: <span style="color: #8b2252;">"QsUtJQs="</span>


  aws_secret_access_key: <span style="color: #8b2252;">"dlJS9Beg=="</span>
---
<span style="color: #b22222;"># </span><span style="color: #b22222;">Source: prometheus-cloudwatch-exporter/templates/configmap.yaml
</span>apiVersion: v1
kind: ConfigMap
metadata:
  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
  namespace: monitoring
  labels:
    app: prometheus-cloudwatch-exporter
    chart: prometheus-cloudwatch-exporter-0.19.2
    release: cloudwatch-exporter
    heritage: Helm
data:
  config.yml: |-

    <span style="color: #b22222;"># </span><span style="color: #b22222;">This is the default configuration for prometheus-cloudwatch-exporter
</span>    region: ap-south-1
    period_seconds: 30
    delay_seconds: 60
    metrics:
    <span style="color: #b22222;">#</span><span style="color: #b22222;">- aws_namespace: AWS/ELB
</span>    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_metric_name: HealthyHostCount
</span>    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_dimensions: [AvailabilityZone, LoadBalancerName]
</span>    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_statistics: [Average]
</span>    <span style="color: #b22222;">#</span><span style="color: #b22222;">
</span>    <span style="color: #b22222;">#</span><span style="color: #b22222;">- aws_namespace: AWS/ELB
</span>    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_metric_name: UnHealthyHostCount
</span>    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_dimensions: [AvailabilityZone, LoadBalancerName]
</span>    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_statistics: [Average]
</span>    <span style="color: #b22222;">#</span><span style="color: #b22222;">
</span>    <span style="color: #b22222;">#</span><span style="color: #b22222;">- aws_namespace: AWS/ELB
</span>    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_metric_name: RequestCount
</span>    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_dimensions: [AvailabilityZone, LoadBalancerName]
</span>    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_statistics: [Sum]
</span>    <span style="color: #b22222;">#</span><span style="color: #b22222;">
</span>    <span style="color: #b22222;">#</span><span style="color: #b22222;">- aws_namespace: AWS/ELB
</span>    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_metric_name: Latency
</span>    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_dimensions: [AvailabilityZone, LoadBalancerName]
</span>    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_statistics: [Average]
</span>    <span style="color: #b22222;">#</span><span style="color: #b22222;">
</span>    <span style="color: #b22222;">#</span><span style="color: #b22222;">- aws_namespace: AWS/ELB
</span>    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_metric_name: SurgeQueueLength
</span>    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_dimensions: [AvailabilityZone, LoadBalancerName]
</span>    <span style="color: #b22222;">#  </span><span style="color: #b22222;">aws_statistics: [Maximum, Sum]
</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;
</span>    - aws_namespace: AWS/ElastiCache
      aws_metric_name: CPUUtilization
      aws_dimensions: [CacheClusterId]
      aws_tag_select:
        tag_selections:
          Owner: [<span style="color: #8b2252;">"Klaus.ma"</span>]
        resource_type_selection: elasticache
        resource_id_dimension: Tags
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: EngineCPUUtilization
      aws_dimensions: [CacheClusterId]
      aws_dimension_select_regex:
         <span style="color: #b22222;">#</span><span style="color: #b22222;">LoadBalancerName: ["app/AGT-APP-Prod-Game-ALB02/b6eb4661b489a15c", "app/AGT-APP-Prod-Game-ALB/9f62266ea9b31940"]
</span>        cache_cluster_id: [<span style="color: #8b2252;">"cc.*"</span>]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: BytesUsedForCache
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: CurrConnections
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: NewConnections
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: DatabaseMemoryUsagePercentage
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: NetworkBytesIn
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: NetworkBytesOut
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: FreeableMemory
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: CacheHits
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: CacheMisses
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: ReplicationLag
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: MemoryFragmentationRatio
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: IsMaster
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: CacheHitRate
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]
    <span style="color: #b22222;">##</span><span style="color: #b22222;">&#26032;&#22686;
</span>    - aws_namespace: AWS/ElastiCache
      aws_metric_name: StringBasedCmdsLatency
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: SortedSetBasedCmdsLatency
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: HashBasedCmdsLatency
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: SetBasedCmdsLatency
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: GetTypeCmdsLatency
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: KeyBasedCmdsLatency
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: ListBasedCmdsLatency
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: SetTypeCmdsLatency
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: StringBasedCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: SetBasedCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: SetTypeCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: GetTypeCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: ListBasedCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: SortedSetBasedCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: EvalBasedCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: HashBasedCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]

    - aws_namespace: AWS/ElastiCache
      aws_metric_name: KeyBasedCmds
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]


    - aws_namespace: AWS/ElastiCache
      aws_metric_name: CurrItems
      aws_dimensions: [CacheClusterId]
      aws_statistics: [Minimum,Maximum,Average]


    - aws_namespace: AWS/ApplicationELB
      aws_metric_name: RequestCount
      aws_dimensions: [AvailabilityZone, LoadBalancer, TargetGroup]
      <span style="color: #b22222;">#</span><span style="color: #b22222;">aws_dimension_select:
</span>      aws_dimension_select_regex:
         <span style="color: #b22222;">#</span><span style="color: #b22222;">LoadBalancerName: ["app/AGT-APP-Prod-Game-ALB02/b6eb4661b489a15c", "app/AGT-APP-Prod-Game-ALB/9f62266ea9b31940"]
</span>         LoadBalancerName: [<span style="color: #8b2252;">"agt*|pg*"</span>]
      aws_statistics: [Sum]
---
<span style="color: #b22222;"># </span><span style="color: #b22222;">Source: prometheus-cloudwatch-exporter/templates/clusterrole.yaml
</span>apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
  labels:
    app: prometheus-cloudwatch-exporter
    chart: prometheus-cloudwatch-exporter-0.19.2
    release: cloudwatch-exporter
    heritage: Helm
rules:
  - apiGroups: [<span style="color: #8b2252;">""</span>]
    resources: [<span style="color: #8b2252;">"secrets"</span>,<span style="color: #8b2252;">"configmap"</span>]
    resourceNames: [<span style="color: #8b2252;">"cloudwatch-exporter-prometheus-cloudwatch-exporter"</span>]
    verbs: [<span style="color: #8b2252;">"get"</span>]
---
<span style="color: #b22222;"># </span><span style="color: #b22222;">Source: prometheus-cloudwatch-exporter/templates/clusterrolebinding.yaml
</span>apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
  labels:
    app: prometheus-cloudwatch-exporter
    chart: prometheus-cloudwatch-exporter-0.19.2
    release: cloudwatch-exporter
    heritage: Helm
subjects:
  - kind: ServiceAccount
    name: cloudwatch-exporter-prometheus-cloudwatch-exporter
    namespace: monitoring
roleRef:
  kind: ClusterRole
  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
  apiGroup: rbac.authorization.k8s.io
---
<span style="color: #b22222;"># </span><span style="color: #b22222;">Source: prometheus-cloudwatch-exporter/templates/service.yaml
</span>apiVersion: v1
kind: Service
metadata:
  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
  namespace: monitoring
  annotations:
    {}
  labels:
    app: prometheus-cloudwatch-exporter
    chart: prometheus-cloudwatch-exporter-0.19.2
    release: cloudwatch-exporter
    heritage: Helm
spec:
  <span style="color: #483d8b;">type</span>: ClusterIP
  ports:
    - port: 9106
      targetPort: container-port
      protocol: TCP
      name: http
  selector:
    app: prometheus-cloudwatch-exporter
    release: cloudwatch-exporter
---
<span style="color: #b22222;"># </span><span style="color: #b22222;">Source: prometheus-cloudwatch-exporter/templates/deployment.yaml
</span>apiVersion: apps/v1
kind: Deployment
metadata:
  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
  namespace: monitoring
  labels:
    app: prometheus-cloudwatch-exporter
    chart: prometheus-cloudwatch-exporter-0.19.2
    release: cloudwatch-exporter
    heritage: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus-cloudwatch-exporter
      release: cloudwatch-exporter
  template:
    metadata:
      labels:
        app: prometheus-cloudwatch-exporter
        release: cloudwatch-exporter
      annotations:

        checksum/config: 98ede3b768cd837965b
        checksum/secrets: 0b63247b8101683bb6
    spec:
      containers:
        - name: prometheus-cloudwatch-exporter
          env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  key: aws_access_key_id
                  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  key: aws_secret_access_key
                  name: cloudwatch-exporter-prometheus-cloudwatch-exporter
          image: <span style="color: #8b2252;">"prom/cloudwatch-exporter:v0.14.3"</span>
          imagePullPolicy: IfNotPresent
          ports:
            - name: container-port
              containerPort: 9106
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /-/healthy
              port: container-port
            initialDelaySeconds: 30
            periodSeconds: 5
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /-/ready
              port: container-port
            initialDelaySeconds: 30
            periodSeconds: 5
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3
          resources:
            {}
          volumeMounts:
            - name: vol-prometheus-cloudwatch-exporter
              mountPath: /config
      nodeSelector:
        eks.amazonaws.com/nodegroup: EKS-DEVOPS-Prometheus
      securityContext:
        fsGroup: 65534
        runAsUser: 65534
      serviceAccount: cloudwatch-exporter-prometheus-cloudwatch-exporter
      serviceAccountName: cloudwatch-exporter-prometheus-cloudwatch-exporter
      volumes:
      - configMap:
          defaultMode: 420
          name: cloudwatch-exporter-prometheus-cloudwatch-exporter
        name: vol-prometheus-cloudwatch-exporter
</pre>
</div>

<p>
é™æ€é…ç½®
</p>
<div class="org-src-container">
<pre class="src src-yaml">- job_name: 'aws_cloudwatch'
 metrics_path: /metrics
 scrape_interval: 50s
 scrape_timeout: 45s
 static_configs:
 - targets:
   - "cloudwatch-exporter-prometheus-cloudwatch-exporter:9106"
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:d59ef2b6-2157-40e1-bfda-656fb7eb2429" class="outline-2">
<h2 id="h:d59ef2b6-2157-40e1-bfda-656fb7eb2429">å‚è€ƒ</h2>
<div class="outline-text-2" id="text-h:d59ef2b6-2157-40e1-bfda-656fb7eb2429">
<ul class="org-ul">
<li><a href="05-k8s-operations-02-prometheus-2.html">prometheuså¸¸ç”¨ç›‘æ§è§„åˆ™</a></li>
<li><a href="https://mp.weixin.qq.com/s/X4ADdHOXtQw5Hy5iQSal8A">Prometheus å‘Šè­¦è§„åˆ™ç”Ÿäº§çº§é…ç½®ï¼š50+ æ ¸å¿ƒæŒ‡æ ‡ä¸æœ€ä½³å®è·µ</a></li>
<li><a href="https://mp.weixin.qq.com/s/lQIExQdA4REMnqMHnwpZiA">Prometheuså‘Šè­¦è§„åˆ™æ¨¡æ¿ä¸é™é»˜ç­–ç•¥ï¼š10åˆ†é’Ÿå®ç°ç”Ÿäº§çº§å‘Šè­¦é›¶è¯¯æŠ¥</a></li>
</ul>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>æ‰“èµ</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Â© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
