<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kubernetes: k8s è¿›é˜¶ç¯‡-é«˜çº§è°ƒåº¦</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/font.css"/>
<link rel="stylesheet" type="text/css" href="/static/drollery.e825b870.css"/>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
</head>
<body>
<header id="preamble" class="status">
<header class="{className}" data-astro-cid-3ef6ksr2>
  <div class=header-branding data-astro-cid-g2lrb5xm>
      <span class=header-text data-astro-cid-g2lrb5xm>
          <span class=dropcap data-astro-cid-g2lrb5xm aria-hidden=true>
              <span class=actual data-astro-cid-g2lrb5xm>J</span>
              <span class=rest data-astro-cid-g2lrb5xm>asper Hsu</span>
              <span class=period data-astro-cid-g2lrb5xm>.</span>
          </span>
          <span class=sr-only data-astro-cid-g2lrb5xm>Drollery</span>
      </span>
      <img alt="Medieval drollery of a knight on a horse" class=spring decoding=async height=250 loading=lazy src=/images/knight-horse.a96eee7d_Z1WCOYs.webp width=68 data-astro-cid-g2lrb5xm>
  </div>

  <nav data-astro-cid-pux6a34n>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/jcodelog.html class=nobracket data-astro-cid-pux6a34n>æŠ€æœ¯</a>
      <span class=flower2 data-astro-cid-pux6a34n>K</span>
      <a href=/reading/index.html class=nobracket data-astro-cid-pux6a34n>é˜…è¯»</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
      <a href=/lisp/jasper-emacs.html class=nobracket data-astro-cid-pux6a34n>æˆ‘çš„Emacsé…ç½®</a>
      <span class=flower2 data-astro-cid-pux6a34n>L</span>
      <a href=/link/index.html class=nobracket data-astro-cid-pux6a34n>å‹é“¾</a>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/about.html class=nobracket data-astro-cid-pux6a34n>å…³äº</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
  </nav>


  <div class="container" data-astro-cid-3ef6ksr2>
    <p class="info" data-astro-cid-3ef6ksr2>
              ğŸ† æ¬¢è¿æ¥åˆ°æœ¬ç«™ï¼š
              <a href="https://xuchangwei.com/">https://xuchangwei.com/</a>ã€‚
              <strong>å¸Œæœ›è¿™é‡Œæœ‰ä½ æ„Ÿå…´è¶£çš„å†…å®¹</strong>ã€‚
            </p>
  </div>
  <div id=borderArtWrapper class="tt1" data-astro-cid-5hce7sga data-turbo-permanent>
      <script>
          var man, shakeCount = 0, noSound = new Audio("/audio/effects/no.m4a"), screamSound = new Audio("/audio/effects/scream.m4a");
          function animateManShakeHandler() {
              man.removeEventListener("animationend", animateManShakeHandler, !1),
              shakeCount += 1,
              man.classList.remove("shakeMan")
          }
          function animateManFallHandler() {
              man.removeEventListener("animationend", animateManFallHandler, !1),
              man.classList.add("hide")
          }
          function animateMan() {
              man = man ?? document.getElementById("borderMan"),
              3 === shakeCount ? (man.classList.add("fallMan"),
              screamSound.play(),
              man.addEventListener("animationend", animateManFallHandler, !1)) : (man.classList.add("shakeMan"),
              noSound.play(),
              man.addEventListener("animationend", animateManShakeHandler, !1))
          }
      </script>
      <div class=borderArt data-astro-cid-5dda5nwp id=articleBorder>
          <img alt="flowery border with man falling" decoding=async height=620 loading=lazy src=/images/border-vines-no-man.b7d246cc_DRxSe.webp width=909 class=border data-astro-cid-5dda5nwp>
          <div class=fallWrapper data-astro-cid-5dda5nwp>
              <img alt="flowery border with man falling" decoding=async height=292 loading=lazy src=/images/man-no-vines.247a3187_Z2ioXNM.webp width=98 class=man data-astro-cid-5dda5nwp id=borderMan onclick=animateMan()>
          </div>
      </div>
  </div>
</header>
</header>
<main class="container" id="content" class="content">
<header>
<h1 class="title">Kubernetes: k8s è¿›é˜¶ç¯‡-é«˜çº§è°ƒåº¦</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org4b58b16">è¿›é˜¶ç¯‡-é«˜çº§è°ƒåº¦</a>
<ul>
<li><a href="#org77e9a2c">CronJob</a>
<ul>
<li><a href="#org1c5e35d">ä»€ä¹ˆæ˜¯ Job</a></li>
<li><a href="#org917968f">Job ä½¿ç”¨</a></li>
<li><a href="#org54dc81a">æ›´å¼ºå¤§çš„è®¡åˆ’ä»»åŠ¡ CronJob ä»‹ç»</a>
<ul>
<li><a href="#org5ae1c67">CronJob é…ç½®å‚æ•°</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org96c62de">InitContainerä»‹ç»</a>
<ul>
<li><a href="#org40feb4a">åˆå§‹åŒ–å®¹å™¨çš„ç”¨é€”</a></li>
<li><a href="#org5d9eaf2">åˆå§‹åŒ–å®¹å™¨å’Œæ™®é€šå®¹å™¨ã€PostStart åŒºåˆ«</a></li>
<li><a href="#orgb120401">ä»€ä¹ˆæ˜¯Init Container</a></li>
<li><a href="#orgd3e176c">åˆå§‹åŒ–å®¹å™¨é…ç½®è§£æ</a></li>
<li><a href="#org2e6b1a8">åˆå§‹åŒ–å®¹å™¨ä½¿ç”¨ç¤ºä¾‹</a></li>
</ul>
</li>
<li><a href="#org08434ee">ä¸´æ—¶å®¹å™¨</a>
<ul>
<li><a href="#org5d97ff9">ä¸ºä»€ä¹ˆè¦ç”¨ä¸´æ—¶å®¹å™¨</a>
<ul>
<li><a href="#orgd4be832">ä»é•œåƒçš„è§’åº¦æ¢è®¨å®¹å™¨çš„å®‰å…¨</a></li>
<li><a href="#org9ea6427">ä¸´æ—¶å®¹å™¨</a></li>
<li><a href="#org360067c">å¼€å¯ä¸´æ—¶å®¹å™¨</a></li>
</ul>
</li>
<li><a href="#org7945813">ä½¿ç”¨ä¸´æ—¶å®¹å™¨åœ¨çº¿ debug</a>
<ul>
<li><a href="#orga6f5178">json æ–¹å¼ä¸´æ—¶å®¹å™¨</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org08dc2bb">æ±¡ç‚¹Taintå’Œå®¹å¿Toleration</a>
<ul>
<li><a href="#orgbcccf2c">å®¹å¿å’Œæ±¡ç‚¹Taintå’ŒToleration è®¾è®¡ç†å¿µ</a>
<ul>
<li><a href="#orgb212eb0">ç”Ÿäº§ç¯å¢ƒçš„è°ƒåº¦å¹¶ééšä¾¿</a></li>
<li><a href="#org5fe6033">å®¹å¿å’Œæ±¡ç‚¹Taintå’ŒToleration</a></li>
</ul>
</li>
<li><a href="#org195329e">æ±¡ç‚¹å’Œå®¹å¿é…ç½®è§£æ</a>
<ul>
<li><a href="#org751deef">æ±¡ç‚¹(Taint)é…ç½®è§£æ</a></li>
<li><a href="#org212a3bd">Toleration é…ç½®è§£æ</a></li>
</ul>
</li>
<li><a href="#orgb86b445">Taint å’Œ  nodeSelector åŒºåˆ«ï¼š</a></li>
<li><a href="#org7f2e04e">æ±¡ç‚¹å’Œå®¹å¿é…ç½®è§£æç¤ºä¾‹</a></li>
<li><a href="#org2663a82">å†…ç½®æ±¡ç‚¹</a>
<ul>
<li><a href="#orgc414699">å®ç°èŠ‚ç‚¹å®•æœºå¿«é€Ÿè¿ç§»æœåŠ¡</a></li>
</ul>
</li>
<li><a href="#org22a02f2">Taint å‘½ä»¤å…¥é—¨</a></li>
</ul>
</li>
<li><a href="#orgb34cfae">Affinity äº²å’ŒåŠ›</a>
<ul>
<li><a href="#orga87d0a0">ç”Ÿäº§ç¯å¢ƒä¾æ—§å­˜åœ¨é«˜å¯ç”¨ç‡é—®é¢˜</a></li>
<li><a href="#orgcd8a615">Affinity åˆ†ç±»</a>
<ul>
<li><a href="#org29d8d46">æå‡å¯ç”¨æ€§</a></li>
</ul>
</li>
<li><a href="#orgde29881">èŠ‚ç‚¹äº²å’ŒåŠ›é…ç½®</a></li>
<li><a href="#orgd9380aa">Pod äº²å’ŒåŠ›å’Œåäº²å’ŒåŠ›é…ç½®</a></li>
<li><a href="#org3289008">èŒƒä¾‹</a>
<ul>
<li><a href="#orga97f3eb">èŒƒä¾‹-å®ç°åŒä¸€ä¸ªåº”ç”¨åˆ†å¸ƒåœ¨ä¸åŒç¼©ä¸»æœº</a></li>
<li><a href="#org602d5a8">èŒƒä¾‹-åº”ç”¨å’Œç¼“å­˜å°½é‡éƒ¨ç½²åœ¨åŒä¸€ä¸ªåŸŸå†…</a></li>
<li><a href="#org681202b">èŒƒä¾‹-å°½é‡è°ƒåº¦åˆ°é«˜é…ç½®æœåŠ¡å™¨</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgf0e84ee">Topology æ‹“æ‰‘åŸŸ</a>
<ul>
<li><a href="#orgda0f174">Topologyæ‹“æ‰‘åŸŸçš„é‡è¦æ€§</a></li>
<li><a href="#org98bf9dd">å¦‚ä½•ä½¿ç”¨topologyKey</a>
<ul>
<li><a href="#orga2390df">åŒä¸€ä¸ªåº”ç”¨å¤šåŒºåŸŸéƒ¨ç½²</a></li>
</ul>
</li>
<li><a href="#orga591352">æ³¨æ„äº‹é¡¹</a></li>
</ul>
</li>
<li><a href="#org3130246">å¼¹æ€§ä¼¸ç¼©æ–¹æ¡ˆ</a>
<ul>
<li><a href="#orga908c91">è™šæ‹ŸèŠ‚ç‚¹</a></li>
</ul>
</li>
<li><a href="#org8cc65fa">å‚è€ƒ</a>
<ul>
<li><a href="#orgdccb66d">Pod æ‹“æ‰‘åˆ†å¸ƒçº¦æŸ</a>
<ul>
<li><a href="#org5900cbd">aws on-demand ä¸ spot å®ä¾‹æ··éƒ¨</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../index.html">Kubernetes</a><br></li>
</ul>
<section id="outline-container-org4b58b16" class="outline-2">
<h2 id="org4b58b16">è¿›é˜¶ç¯‡-é«˜çº§è°ƒåº¦</h2>
<div class="outline-text-2" id="text-org4b58b16">
</div>
<div id="outline-container-org77e9a2c" class="outline-3">
<h3 id="org77e9a2c">CronJob</h3>
<div class="outline-text-3" id="text-org77e9a2c">
</div>
<div id="outline-container-org1c5e35d" class="outline-4">
<h4 id="org1c5e35d">ä»€ä¹ˆæ˜¯ Job</h4>
<div class="outline-text-4" id="text-org1c5e35d">
<p>
<img src="./images/Snipaste_2022-09-16_15-14-28.png" alt="Snipaste_2022-09-16_15-14-28.png"><br>
<img src="./images/Snipaste_2022-09-16_17-42-56.png" alt="Snipaste_2022-09-16_17-42-56.png"><br>
</p>

<ul class="org-ul">
<li>ç­‰å¾…å¯ç”¨åæ‰æ‰§è¡Œ<br></li>
<li>å¹¶è¡Œæ‰§è¡Œå¤šä¸ª podï¼Œåˆ†åˆ«æ‰§è¡Œå„è‡ªçš„é€»è¾‘<br></li>
</ul>
</div>
</div>
<div id="outline-container-org917968f" class="outline-4">
<h4 id="org917968f">Job ä½¿ç”¨</h4>
<div class="outline-text-4" id="text-org917968f">
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: batch/v1
kind: Job
metadata:
  name: echo
  labels:
    job-name: echo
  namespace: default
spec:
  suspend: true # 1.21+
  ttlSecondsAfterFinished: 100
  backoffLimit: 4
  completions: 1
  parallelism: 1
  template:
    spec:
      containers:
      - name: echo
        image: perl:5.34.0
        command: ["perl",  "-Mbignum=bpi", "-wle", "print bpi(2000)"]
        imagePullPolicy: IfNotPresent
        resources: {}
      restartPolicy: Never
</pre>
</div>

<ul class="org-ul">
<li>suspendï¼šé»˜è®¤ falseï¼Œé©¬ä¸Šå¼€å§‹æ‰§è¡Œ Podã€‚è®¾ç½®ä¸º true ä¸ºæŒ‚èµ·çŠ¶æ€ä¸æ‰§è¡Œ podã€‚<br>
<ul class="org-ul">
<li><code>kubectl patch job/xxx --type=strategic --patch '{"spec":{"suspend":false}}'</code><br></li>
</ul></li>
<li>backoffLimit: å¦‚æœä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œå¤±è´¥å¤šå°‘æ¬¡åä¸å†æ‰§è¡Œ<br></li>
<li>completionsï¼šæœ‰å¤šå°‘ä¸ªPodæ‰§è¡ŒæˆåŠŸï¼Œè®¤ä¸ºä»»åŠ¡æ˜¯æˆåŠŸçš„<br>
<ul class="org-ul">
<li>ä¸ºç©ºé»˜è®¤å’Œparallelismæ•°å€¼ä¸€æ ·<br></li>
</ul></li>
<li>parallelismï¼šå¹¶è¡Œæ‰§è¡Œä»»åŠ¡çš„æ•°é‡<br>
<ul class="org-ul">
<li>å¦‚æœparallelismæ•°å€¼å¤§äºæœªå®Œæˆä»»åŠ¡æ•°ï¼Œåªä¼šåˆ›å»ºæœªå®Œæˆçš„æ•°é‡ï¼›æ¯”å¦‚completionsæ˜¯4ï¼Œå¹¶å‘æ˜¯3ï¼Œç¬¬ä¸€æ¬¡ä¼šåˆ›å»º3ä¸ªPodæ‰§è¡Œä»»åŠ¡ï¼Œç¬¬äºŒæ¬¡åªä¼šåˆ›å»ºä¸€ä¸ªPodæ‰§è¡Œä»»åŠ¡<br></li>
</ul></li>
<li>ttlSecondsAfterFinishedï¼šJobåœ¨æ‰§è¡Œç»“æŸä¹‹åï¼ˆçŠ¶æ€ä¸ºcompletedæˆ–Failedï¼‰è‡ªåŠ¨æ¸…ç†ã€‚è®¾ç½®ä¸º0è¡¨ç¤ºæ‰§è¡Œç»“æŸç«‹å³åˆ é™¤ï¼Œä¸è®¾ç½®åˆ™ä¸ä¼šæ¸…é™¤ï¼Œéœ€è¦å¼€å¯TTLAfterFinishedç‰¹æ€§<br></li>
</ul>
</div>
</div>
<div id="outline-container-org54dc81a" class="outline-4">
<h4 id="org54dc81a">æ›´å¼ºå¤§çš„è®¡åˆ’ä»»åŠ¡ CronJob ä»‹ç»</h4>
<div class="outline-text-4" id="text-org54dc81a">
<div class="org-src-container">
<pre class="src src-shell">&#22312;k8s &#37324;&#38754;&#36816;&#34892;&#21608;&#26399;&#24615;&#30340;&#35745;&#21010;&#20219;&#21153;&#65292;crontab
* * * * * &#20998;&#26102;&#26085;&#26376;&#21608;

&#21487;&#20197;&#21033;&#29992; CronJobs &#25191;&#34892;&#22522;&#20110;&#26102;&#38388;&#35843;&#24230;&#30340;&#20219;&#21153;&#12290;&#36825;&#20123;&#33258;&#21160;&#21270;&#20219;&#21153;&#21644; Linux &#25110;&#32773; Unix &#31995;&#32479;&#30340; Cron &#20219;&#21153;&#31867;&#20284;
CronJobs&#22312;&#21019;&#24314;&#21608;&#26399;&#24615;&#20197;&#21450;&#37325;&#22797;&#24615;&#30340;&#20219;&#21153;&#26102;&#24456;&#26377;&#24110;&#21161;&#65292;&#20363;&#22914;&#25191;&#34892;&#22791;&#20221;&#25805;&#20316;&#25110;&#32773;&#21457;&#36865;&#37038;&#20214;&#12290;CronJobs &#20063;&#21487;&#20197;&#22312;&#29305;&#23450;&#26102;&#38388;&#35843;&#24230;&#21333;&#20010;&#20219;&#21153;&#65292;&#20363;&#22914;&#20320;&#24819;&#35843;&#24230;&#20302;&#27963;&#36291;&#21608;&#26399;&#30340;&#20219;&#21153;&#12290;
</pre>
</div>

<p>
.spec.schedule å­—æ®µæ˜¯å¿…éœ€çš„ã€‚è¯¥å­—æ®µçš„å€¼éµå¾ª <a href="https://zh.wikipedia.org/wiki/Cron">Cron</a> è¯­æ³•ï¼š<br>
</p>
<pre class="example" id="org2277279">
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ (0 - 59)
# â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ (0 - 23)
# â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœˆçš„æŸå¤© (1 - 31)
# â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœˆä»½ (1 - 12)
# â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å‘¨çš„æŸå¤© (0 - 6)ï¼ˆå‘¨æ—¥åˆ°å‘¨å…­ï¼‰
# â”‚ â”‚ â”‚ â”‚ â”‚                          æˆ–è€…æ˜¯ sunï¼Œmonï¼Œtueï¼Œwebï¼Œthuï¼Œfriï¼Œsat
# â”‚ â”‚ â”‚ â”‚ â”‚
# â”‚ â”‚ â”‚ â”‚ â”‚
# * * * * *
</pre>
</div>
<div id="outline-container-org5ae1c67" class="outline-5">
<h5 id="org5ae1c67">CronJob é…ç½®å‚æ•°</h5>
<div class="outline-text-5" id="text-org5ae1c67">
<p>
å’Œ Job é…ç½®ç±»ä¼¼<br>
</p>

<div class="org-src-container">
<pre class="src src-yaml">apiVersion: batch/v1
kind: CronJob
metadata:
  name: hello
  labels:
    run: hell
  namespace: default
spec:
  concurrencyPolicy: Allow
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 64800
      template:
        metadata:
          labels:
            run: hello
        spec:
          containers:
          - name: hello
            image: busybox:1.28
            imagePullPolicy: IfNotPresent
            args:
            - /bin/sh
            - -c
            - date; echo Hello from the Kubernetes cluster
            resources: {}
          restartPolicy: OnFailure
  schedule: "*/1 * * * *"
  successfulJobsHistoryLimit: 3
  suspend: false
</pre>
</div>

<p>
å‚æ•°è¯´æ˜ï¼š<br>
</p>
<ul class="org-ul">
<li>apiVersion: batch/v1beta1 #1.21+ batch/v1<br></li>
<li>scheduleï¼šè°ƒåº¦å‘¨æœŸï¼Œå’ŒLinuxä¸€è‡´ï¼Œåˆ†åˆ«æ˜¯åˆ†æ—¶æ—¥æœˆå‘¨ã€‚<br></li>
<li>restartPolicyï¼šé‡å¯ç­–ç•¥ï¼Œå’ŒPodä¸€è‡´ã€‚<br></li>
<li>concurrencyPolicyï¼šå¹¶å‘è°ƒåº¦ç­–ç•¥ã€‚å¯é€‰å‚æ•°å¦‚ä¸‹ï¼š<br>
<ul class="org-ul">
<li>Allowï¼š é»˜è®¤ï¼Œå…è®¸åŒæ—¶è¿è¡Œå¤šä¸ªä»»åŠ¡ã€‚<br></li>
<li>Forbidï¼šä¸å…è®¸å¹¶å‘è¿è¡Œï¼Œå¦‚æœä¹‹å‰çš„ä»»åŠ¡å°šæœªå®Œæˆï¼Œæ–°çš„ä»»åŠ¡ä¸ä¼šè¢«åˆ›å»ºã€‚<br></li>
<li>Replaceï¼šå¦‚æœä¹‹å‰çš„ä»»åŠ¡å°šæœªå®Œæˆï¼Œæ–°çš„ä»»åŠ¡ä¼šæ›¿æ¢çš„ä¹‹å‰çš„ä»»åŠ¡ã€‚<br></li>
</ul></li>
<li>suspendï¼šå¦‚æœè®¾ç½®ä¸ºtrueï¼Œåˆ™æš‚åœåç»­çš„ä»»åŠ¡ï¼Œé»˜è®¤ä¸ºfalseã€‚<br></li>
<li>successfulJobsHistoryLimitï¼šä¿ç•™å¤šå°‘å·²å®Œæˆçš„ä»»åŠ¡ï¼ŒæŒ‰éœ€é…ç½®ã€‚é»˜è®¤ä¸º 3<br></li>
<li>failedJobsHistoryLimitï¼šä¿ç•™å¤šå°‘å¤±è´¥çš„ä»»åŠ¡ã€‚ é»˜è®¤ä¸º 1ï¼Œè®¾ç½®ä¸º 0 ä»£è¡¨ç›¸åº”ç±»å‹çš„ä»»åŠ¡å®Œæˆåä¸ä¼šä¿ç•™ã€‚<br></li>
<li>jobTemplate.spec.ttlSecondsAfterFinished: Jobåœ¨æ‰§è¡Œç»“æŸä¹‹åï¼ˆçŠ¶æ€ä¸ºcompletedæˆ–Failedï¼‰è‡ªåŠ¨æ¸…ç†ã€‚é»˜è®¤ä¸æ¸…ç†ã€‚<br></li>
</ul>

<p>
èŒƒä¾‹ crontJob mysql åˆ é™¤è¡¨æ•°æ®<br>
</p>
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: batch/v1
kind: CronJob
metadata:
  name: ludo-xxl-job-clean
  namespace: ludo
spec:
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 64800
      template:
        spec:
          containers:
          - command:
            - /bin/sh
            - -c
            - echo æ“ä½œå‰æ€»æ•°ä¸ºï¼š;mysql -h$HOST -P 6033 -u$USER -p$PASSWORD ludo_xxl_job -e 'select count(*)
              from xxl_job_log';mysql -h$HOST -P 6033 -u$USER -p$PASSWORD ludo_xxl_job
              -e 'delete from xxl_job_log';  echo æ“ä½œåæ€»æ•°ä¸ºï¼š;mysql -h$HOST -P 6033 -u$USER -p$PASSWORD
              ludo_xxl_job -e 'select count(*) from xxl_job_log'
            env:
            - name: HOST
              value: nlbxxx.elb.ap-south-1.amazonaws.com
            - name: USER
              value: xxl_job
            - name: PASSWORD
              value: FfVFSj/fdUCRYZ8Y
            image: mysql:5.7
            imagePullPolicy: Always
            name: ludo-xxl-job-clean
          nodeSelector:
            type: prod-app
          restartPolicy: OnFailure
  schedule: "58 1 * * *"
</pre>
</div>

<p>
è‡ªåŠ¨æ¸…ç†<br>
ttlSecondsAfterFinished: 64800 æ¯ 12 å°æ—¶æ¸…ç†ä¸€æ¬¡<br>
</p>

<p>
æŸ¥çœ‹job<br>
</p>

<div class="org-src-container">
<pre class="src src-shell">[root@k8s-master01 app]# kubectl get cj hello
NAME    SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
hello   */1 * * * *   False     6        4s              8m20s

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;</span>
[root@k8s-master01 app]# kubectl delete cronjob hello
cronjob.batch <span style="color: #8b2252;">"hello"</span> deleted
</pre>
</div>


<p>
èŒƒä¾‹ï¼šå®šæ—¶é‡å¯æœåŠ¡<br>
</p>
<div class="org-src-container">
<pre class="src src-sh">---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: deployment-restart
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: deployment-restart
  namespace: default
rules:
- apiGroups: [<span style="color: #8b2252;">"apps"</span>, <span style="color: #8b2252;">"extensions"</span>]
  resources: [<span style="color: #8b2252;">"deployments"</span>]
  resourceNames: [<span style="color: #8b2252;">"singapore-report"</span>]
  verbs: [<span style="color: #8b2252;">"get"</span>, <span style="color: #8b2252;">"patch"</span>, <span style="color: #8b2252;">"list"</span>, <span style="color: #8b2252;">"watch"</span>]
- apiGroups: [<span style="color: #8b2252;">""</span>]
  resources: [<span style="color: #8b2252;">"pods"</span>]
  verbs: [<span style="color: #8b2252;">"get"</span>, <span style="color: #8b2252;">"patch"</span>,<span style="color: #8b2252;">"delete"</span>,<span style="color: #8b2252;">"list"</span>, <span style="color: #8b2252;">"watch"</span>]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: deployment-restart
  namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: deployment-restart
subjects:
- kind: ServiceAccount
  name: deployment-restart
  namespace: default
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: deployment-restart
  namespace: default
spec:
  concurrencyPolicy: Forbid
  schedule: <span style="color: #8b2252;">'0 0 * * 0'</span>  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21608;&#26085;0&#28857;</span>
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 64800
      backoffLimit: 2
      activeDeadlineSeconds: 900  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#36229;&#26102;&#26102;&#38388;&#20197;&#24212;&#23545;&#22797;&#26434;&#24773;&#20917;</span>
      template:
        spec:
          serviceAccountName: deployment-restart
          restartPolicy: OnFailure
          containers:
          - name: kubectl
            image: bitnami/kubectl:latest
            <span style="color: #483d8b;">command</span>:
            - /bin/bash
            - -c
            - &gt;-
              which kubectl; kubectl version ; kubectl rollout restart
              deployment singapore-report ; 
              <span style="color: #a0522d;">pod_names</span>=<span style="color: #ff00ff;">`kubectl get po --field-selector 'status.phase=Failed'  |sed '1d'|awk '{print $1}'`</span> ;  
              <span style="color: #a020f0;">if</span> [ -n <span style="color: #8b2252;">"$pod_names"</span> ]; <span style="color: #a020f0;">then</span>  
              <span style="color: #a020f0;">for</span> p<span style="color: #a020f0;"> in</span> ${<span style="color: #a0522d;">pod_names</span>};<span style="color: #a020f0;">do</span>
                <span style="color: #483d8b;">echo</span> delete $<span style="color: #a0522d;">p</span> ;
                kubectl delete po $<span style="color: #a0522d;">p</span> ;
              <span style="color: #a020f0;">done</span>  ;   
              <span style="color: #a020f0;">else</span>  
              <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Nothing to do'</span> ;  
              <span style="color: #a020f0;">fi</span>
<span style="color: #b22222;">#            </span><span style="color: #b22222;">volumeMounts:</span>
<span style="color: #b22222;">#            </span><span style="color: #b22222;">- name: script-volume</span>
<span style="color: #b22222;">#              </span><span style="color: #b22222;">mountPath: /etc/script</span>
<span style="color: #b22222;">#          </span><span style="color: #b22222;">volumes:</span>
<span style="color: #b22222;">#          </span><span style="color: #b22222;">- name: script-volume</span>
<span style="color: #b22222;">#            </span><span style="color: #b22222;">configMap:</span>
<span style="color: #b22222;">#              </span><span style="color: #b22222;">name: restart-script-cm</span>


---
apiVersion: v1
kind: ConfigMap
metadata:
  name: restart-script-cm
  namespace: default
data:
  restart-script: |
    <span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">kubectl --kubeconfig=/tmp/.confg rollout restart deployment/my-deployment</span>
    which kubectl
    kubectl version
    cat /tmp/.config
---
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org96c62de" class="outline-3">
<h3 id="org96c62de">InitContainerä»‹ç»</h3>
<div class="outline-text-3" id="text-org96c62de">
</div>
<div id="outline-container-org40feb4a" class="outline-4">
<h4 id="org40feb4a">åˆå§‹åŒ–å®¹å™¨çš„ç”¨é€”</h4>
<div class="outline-text-4" id="text-org40feb4a">
<ul class="org-ul">
<li>Init å®¹å™¨å¯ä»¥åŒ…å«ä¸€äº›å®‰è£…è¿‡ç¨‹ä¸­åº”ç”¨å®¹å™¨ä¸­ä¸å­˜åœ¨çš„å®ç”¨å·¥å…·æˆ–ä¸ªæ€§åŒ–ä»£ç ï¼›<br></li>
<li>Init å®¹å™¨å¯ä»¥å®‰å…¨åœ°è¿è¡Œè¿™äº›å·¥å…·ï¼Œé¿å…è¿™äº›å·¥å…·å¯¼è‡´åº”ç”¨é•œåƒçš„å®‰å…¨æ€§é™ä½ï¼›<br></li>
<li>Initå®¹å™¨å¯ä»¥ä»¥rootèº«ä»½è¿è¡Œï¼Œæ‰§è¡Œä¸€äº›é«˜æƒé™å‘½ä»¤ï¼›<br></li>
<li>Initå®¹å™¨ç›¸å…³æ“ä½œæ‰§è¡Œå®Œæˆä»¥åå³é€€å‡ºï¼Œä¸ä¼šç»™ä¸šåŠ¡å®¹å™¨å¸¦æ¥å®‰å…¨éšæ‚£ã€‚<br></li>
</ul>

<p>
åœ¨ä¸»åº”ç”¨å¯åŠ¨ä¹‹å‰ï¼Œåšä¸€äº›åˆå§‹åŒ–çš„æ“ä½œï¼Œæ¯”å¦‚åˆ›å»ºæ–‡ä»¶ã€ä¿®æ”¹å†…æ ¸å‚æ•°ã€ç­‰å¾…ä¾èµ–ç¨‹åºå¯åŠ¨æˆ–å…¶ä»–éœ€è¦åœ¨ä¸»ç¨‹åºå¯åŠ¨ä¹‹å‰éœ€è¦åšçš„å·¥ä½œ<br>
</p>
</div>
</div>
<div id="outline-container-org5d9eaf2" class="outline-4">
<h4 id="org5d9eaf2">åˆå§‹åŒ–å®¹å™¨å’Œæ™®é€šå®¹å™¨ã€PostStart åŒºåˆ«</h4>
<div class="outline-text-4" id="text-org5d9eaf2">
<p>
åˆå§‹åŒ–å®¹å™¨å’ŒPostStartåŒºåˆ«ï¼š<br>
</p>
<ul class="org-ul">
<li>PostStartï¼šä¾èµ–ä¸»åº”ç”¨çš„ç¯å¢ƒï¼Œè€Œä¸”å¹¶ä¸ä¸€å®šå…ˆäºCommandè¿è¡Œ<br></li>
<li>InitContainerï¼šä¸ä¾èµ–ä¸»åº”ç”¨çš„ç¯å¢ƒï¼Œå¯ä»¥æœ‰æ›´é«˜çš„æƒé™å’Œæ›´å¤šçš„å·¥å…·ï¼Œä¸€å®šä¼šåœ¨ä¸»åº”ç”¨å¯åŠ¨ä¹‹å‰å®Œæˆ<br></li>
</ul>

<p>
åˆå§‹åŒ–å®¹å™¨å’Œæ™®é€šå®¹å™¨çš„åŒºåˆ«ï¼š<br>
Init å®¹å™¨ä¸æ™®é€šçš„å®¹å™¨éå¸¸åƒï¼Œé™¤äº†å¦‚ä¸‹å‡ ç‚¹ï¼š<br>
</p>
<ul class="org-ul">
<li>å®ƒä»¬æ€»æ˜¯è¿è¡Œåˆ°å®Œæˆï¼›<br></li>
<li>ä¸Šä¸€ä¸ªè¿è¡Œå®Œæˆæ‰ä¼šè¿è¡Œä¸‹ä¸€ä¸ªï¼›<br></li>
<li>å¦‚æœ Pod çš„ Init å®¹å™¨å¤±è´¥ï¼ŒKubernetes ä¼šä¸æ–­åœ°é‡å¯è¯¥ Podï¼Œç›´åˆ° Init å®¹å™¨æˆåŠŸä¸ºæ­¢ï¼Œä½†æ˜¯Pod å¯¹åº”çš„ restartPolicy å€¼ä¸º Neverï¼ŒKubernetes ä¸ä¼šé‡æ–°å¯åŠ¨ Podã€‚<br></li>
<li>Init å®¹å™¨ä¸æ”¯æŒ lifecycleã€livenessProbeã€readinessProbe å’Œ startupProbe<br></li>
</ul>
</div>
</div>
<div id="outline-container-orgb120401" class="outline-4">
<h4 id="orgb120401">ä»€ä¹ˆæ˜¯Init Container</h4>
<div class="outline-text-4" id="text-orgb120401">
<p>
Init Containerå°±æ˜¯ç”¨æ¥åšåˆå§‹åŒ–å·¥ä½œçš„å®¹å™¨ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæˆ–è€…å¤šä¸ªï¼Œå¦‚æœæœ‰å¤šä¸ªçš„è¯ï¼Œè¿™äº›å®¹å™¨ä¼šæŒ‰å®šä¹‰çš„é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œåªæœ‰æ‰€æœ‰çš„Init Containeræ‰§è¡Œå®Œåï¼Œä¸»å®¹å™¨æ‰ä¼šè¢«å¯åŠ¨ã€‚æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªPodé‡Œé¢çš„æ‰€æœ‰å®¹å™¨æ˜¯å…±äº«æ•°æ®å·å’Œç½‘ç»œå‘½åç©ºé—´çš„ï¼Œæ‰€ä»¥Init Containeré‡Œé¢äº§ç”Ÿçš„æ•°æ®å¯ä»¥è¢«ä¸»å®¹å™¨ä½¿ç”¨åˆ°çš„ã€‚<br>
</p>

<p>
Init Containerä¸åº”ç”¨å®¹å™¨æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œä½†ä»–ä»¬æ˜¯ä»…è¿è¡Œä¸€æ¬¡å°±ç»“æŸçš„ä»»åŠ¡ï¼Œå¹¶ä¸”å¿…é¡»åœ¨æˆåŠŸæ‰§è¡Œå®Œåï¼Œç³»ç»Ÿæ‰èƒ½ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªå®¹å™¨<br>
</p>
</div>
</div>
<div id="outline-container-orgd3e176c" class="outline-4">
<h4 id="orgd3e176c">åˆå§‹åŒ–å®¹å™¨é…ç½®è§£æ</h4>
<div class="outline-text-4" id="text-orgd3e176c">
<ul class="org-ul">
<li>initContainers å’Œ containers ã€volumes æ˜¯åŒçº§çš„ã€‚<br></li>
<li>ä¿®æ”¹ç›®å½•æƒé™æ—¶ä¸€å®šè¦æŠŠç›®å½•æŒ‚è½½èµ·æ¥<br></li>
</ul>
</div>
</div>
<div id="outline-container-org2e6b1a8" class="outline-4">
<h4 id="org2e6b1a8">åˆå§‹åŒ–å®¹å™¨ä½¿ç”¨ç¤ºä¾‹</h4>
<div class="outline-text-4" id="text-org2e6b1a8">
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: test-init
  name: test-init
  namespace: default
spec:
  replicas: 3
  selector:
    matchLabels:
      app: test-init
  template:
    metadata:
      labels:
        app: test-init
    spec:
      volumes:
      - name: data
        emptyDir: {}
      initContainers: 
      - command:
        - sh
        - -c 
        - touch /mnt/test-init.txt
        image: nginx
        imagePullPolicy: IfNotPresent
        name: init-touch
        volumeMounts: 
        - name: data
          mountPath: /mnt
      - command:
        - sh
        - -c 
        - for i in `seq 1 100`; do echo $i; sleep 1; done
        image: nginx
        imagePullPolicy: IfNotPresent
        name: echo
      containers:
      - image: nginx
        imagePullPolicy: IfNotPresent
        name: test-init
        volumeMounts: 
        - name: data
          mountPath: /mnt
</pre>
</div>


<p>
æŸ¥çœ‹ pod å®¹å™¨çš„æ—¥å¿—ï¼Œå…ˆ `describe` çœ‹å“ªä¸ªåˆå§‹åŒ–å®¹å™¨æ²¡æ‰§è¡Œå®Œï¼Œä½¿ç”¨ `logs`æŸ¥çœ‹<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl  logs -f test-init-7c58ff4db4-dbhrx -c echo
1
2
3
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org08434ee" class="outline-3">
<h3 id="org08434ee">ä¸´æ—¶å®¹å™¨</h3>
<div class="outline-text-3" id="text-org08434ee">
</div>
<div id="outline-container-org5d97ff9" class="outline-4">
<h4 id="org5d97ff9">ä¸ºä»€ä¹ˆè¦ç”¨ä¸´æ—¶å®¹å™¨</h4>
<div class="outline-text-4" id="text-org5d97ff9">
</div>
<div id="outline-container-orgd4be832" class="outline-5">
<h5 id="orgd4be832">ä»é•œåƒçš„è§’åº¦æ¢è®¨å®¹å™¨çš„å®‰å…¨</h5>
<div class="outline-text-5" id="text-orgd4be832">

<figure id="org1e7d8b6">
<img src="./images/Snipaste_2022-09-18_22-30-17.png" alt="Snipaste_2022-09-18_22-30-17.png"><br>

</figure>

<ul class="org-ul">
<li>å®¹å™¨ä¸­æœ‰ bash æˆ– sh ï¼Œé€šè¿‡æ¸—é€å¯ä»¥æ³¨å…¥ sidecar å½“çŸ¿æœº<br></li>
<li>ä¸è¦ä»¥ root èº«ä»½çš„è¿è¡Œ podï¼Œä¸ä¼šå®‰è£…ä¸€äº›å·¥å…·åŒ…<br></li>
</ul>

<p>
å®¹å™¨æ²¡æœ‰ root æƒé™æˆ–è€…ä¸€äº›å·¥å…·å‘½ä»¤ï¼Œç¨‹åºå‡ºé—®é¢˜æ—¶ä¸å¥½æ’æŸ¥ã€‚<br>
</p>
</div>
</div>
<div id="outline-container-org9ea6427" class="outline-5">
<h5 id="org9ea6427">ä¸´æ—¶å®¹å™¨</h5>
<div class="outline-text-5" id="text-org9ea6427">

<figure id="org0dd43c3">
<img src="./images/Snipaste_2022-09-18_22-37-43.png" alt="Snipaste_2022-09-18_22-37-43.png"><br>

</figure>

<ul class="org-ul">
<li>shareProcessNamespace é»˜è®¤æ˜¯æ‰“å¼€çš„<br></li>
</ul>

<p>
åœ¨ pod ä¸­æ³¨å…¥ä¸´æ—¶å®¹å™¨ï¼š<br>
</p>
<ul class="org-ul">
<li>æœ‰ root æƒé™<br></li>
<li>æœ‰ debug å·¥å…·<br></li>
</ul>
</div>
</div>
<div id="outline-container-org360067c" class="outline-5">
<h5 id="org360067c">å¼€å¯ä¸´æ—¶å®¹å™¨</h5>
<div class="outline-text-5" id="text-org360067c">
<p>
äºŒè¿›åˆ¶ä¿®æ”¹æ–¹å¼<br>
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">master &#33410;&#28857;</span>
vi /usr/lib/systemd/system/kube-apiserver.service
--feature-gates=<span style="color: #a0522d;">EphemeralContainers</span>=true

vi /usr/lib/systemd/system/kube-controller-manager.service
--feature-gates=<span style="color: #a0522d;">EphemeralContainers</span>=true

vi /usr/lib/systemd/system/kube-scheduler.service
--feature-gates=<span style="color: #a0522d;">EphemeralContainers</span>=true

<span style="color: #b22222;"># </span><span style="color: #b22222;">node &#33410;&#28857;</span>
vi /usr/lib/systemd/system/kube-proxy.service
--feature-gates=<span style="color: #a0522d;">EphemeralContainers</span>=true
vi /etc/kubernetes/kubelet-conf.yml
featureGates:
EphemeralContainers: true

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37325;&#21551;&#25152;&#26377;&#26381;&#21153;</span>
systemctl daemon-reload
systemctl restart kube-apiserver kube-scheduler kube-controller-mannager kubelet kube-proxy

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21028;&#26029;&#26159;&#21542;&#29983;&#25928;&#26041;&#27861;&#65306;&#37197;&#32622;&#22909;&#20102;&#65292;&#33021;&#20351;&#29992;&#21629;&#20196;&#25554;&#20214;&#20020;&#26102;&#23481;&#22120;&#35828;&#26126;&#26159;&#21487;&#20197;&#30340;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7945813" class="outline-4">
<h4 id="org7945813">ä½¿ç”¨ä¸´æ—¶å®¹å™¨åœ¨çº¿ debug</h4>
<div class="outline-text-4" id="text-org7945813">
<p>
ä¸´æ—¶å®¹å™¨ä½¿ç”¨<br>
K8s 1.16+ <a href="https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/">https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/</a><br>
</p>

<p>
K8s 1.18+ `kubectl alpha debug redis-new-5b577b46c7-2jv4j -ti &#x2013;image=registry.cn-beijing.aliyuncs.com/dotbalo/debug-tools`<br>
</p>

<p>
K8s 1.20+ `kubectl debug redis-new-5b577b46c7-2jv4j -ti &#x2013;image=registry.cn-beijing.aliyuncs.com/dotbalo/debug-tools`<br>
</p>

<p>
`kubectl debug node/k8s-node01 -it &#x2013;image=registry.cn-beijing.aliyuncs.com/dotbalo/debug-tools`<br>
</p>

<div class="org-src-container">
<pre class="src src-shell">]$ kubectl exec -it stg-prometheus-kube-state-metrics-598bc78c87-j6cpc bash
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed<span style="color: #a020f0;"> in</span> a future version. Use kubectl exec [POD] -- [COMMAND] instead.
OCI runtime exec failed: exec failed: container_linux.go:380: starting container process caused: exec: <span style="color: #8b2252;">"bash"</span>: executable file not found<span style="color: #a020f0;"> in</span> $<span style="color: #a0522d;">PATH</span>: unknown
<span style="color: #483d8b;">command</span> terminated with exit code 126

]$ kubectl exec -it stg-prometheus-kube-state-metrics-598bc78c87-j6cpc sh
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed<span style="color: #a020f0;"> in</span> a future version. Use kubectl exec [POD] -- [COMMAND] instead.
OCI runtime exec failed: exec failed: container_linux.go:380: starting container process caused: exec: <span style="color: #8b2252;">"sh"</span>: executable file not found<span style="color: #a020f0;"> in</span> $<span style="color: #a0522d;">PATH</span>: unknown
<span style="color: #483d8b;">command</span> terminated with exit code 126


kubectl  debug stg-prometheus-kube-state-metrics-598bc78c87-j6cpc -it --image=busybox

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#19978;&#38754;&#32456;&#31471;&#21345;&#27515;&#21487;&#20197;&#20351;&#29992; exec &#36827;&#20837;&#23481;&#22120;</span>
kubectl exec -it podName -c containName -- bash
</pre>
</div>
</div>
<div id="outline-container-orga6f5178" class="outline-5">
<h5 id="orga6f5178">json æ–¹å¼ä¸´æ—¶å®¹å™¨</h5>
<div class="outline-text-5" id="text-orga6f5178">
<p>
ä¸´æ—¶å®¹å™¨ï¼šä¸€ç§ç‰¹æ®Šçš„å®¹å™¨ï¼Œè¯¥å®¹å™¨åœ¨ç°æœ‰ [Pod](<a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/</a>) ä¸­ä¸´æ—¶è¿è¡Œï¼Œä»¥ä¾¿å®Œæˆç”¨æˆ·å‘èµ·çš„æ“ä½œï¼Œä¾‹å¦‚æ•…éšœæ’æŸ¥ã€‚ ä½ ä¼šä½¿ç”¨ä¸´æ—¶å®¹å™¨æ¥æ£€æŸ¥æœåŠ¡ï¼Œè€Œä¸æ˜¯ç”¨å®ƒæ¥æ„å»ºåº”ç”¨ç¨‹åºã€‚<br>
</p>

<p>
ä¸´æ—¶å®¹å™¨ä¸å…¶ä»–å®¹å™¨çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå®ƒä»¬ç¼ºå°‘å¯¹èµ„æºæˆ–æ‰§è¡Œçš„ä¿è¯ï¼Œå¹¶ä¸”æ°¸è¿œä¸ä¼šè‡ªåŠ¨é‡å¯ï¼Œ å› æ­¤ä¸é€‚ç”¨äºæ„å»ºåº”ç”¨ç¨‹åºã€‚ ä¸´æ—¶å®¹å™¨ä½¿ç”¨ä¸å¸¸è§„å®¹å™¨ç›¸åŒçš„ <code>ContainerSpec</code> èŠ‚æ¥æè¿°ï¼Œä½†è®¸å¤šå­—æ®µæ˜¯ä¸å…¼å®¹å’Œä¸å…è®¸çš„ã€‚<br>
</p>

<ul class="org-ul">
<li>ä¸´æ—¶å®¹å™¨æ²¡æœ‰ç«¯å£é…ç½®ï¼Œå› æ­¤åƒ portsï¼ŒlivenessProbeï¼ŒreadinessProbe è¿™æ ·çš„å­—æ®µæ˜¯ä¸å…è®¸çš„ã€‚<br></li>
<li>Pod èµ„æºåˆ†é…æ˜¯ä¸å¯å˜çš„ï¼Œå› æ­¤ <code>resources</code> é…ç½®æ˜¯ä¸å…è®¸çš„ã€‚<br></li>
<li>æœ‰å…³å…è®¸å­—æ®µçš„å®Œæ•´åˆ—è¡¨ï¼Œè¯·å‚è§ [EphemeralContainer å‚è€ƒæ–‡æ¡£](<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#ephemeralcontainer-v1-core">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#ephemeralcontainer-v1-core</a>)ã€‚<br></li>
</ul>

<p>
ä¸´æ—¶å®¹å™¨æ˜¯ä½¿ç”¨ API ä¸­çš„ä¸€ç§ç‰¹æ®Šçš„ <code>ephemeralcontainers</code> å¤„ç†å™¨è¿›è¡Œåˆ›å»ºçš„ï¼Œ è€Œä¸æ˜¯ç›´æ¥æ·»åŠ åˆ° <code>pod.spec</code> æ®µï¼Œå› æ­¤æ— æ³•ä½¿ç”¨ <code>kubectl edit</code> æ¥æ·»åŠ ä¸€ä¸ªä¸´æ—¶å®¹å™¨ã€‚<br>
</p>

<p>
ä¸å¸¸è§„å®¹å™¨ä¸€æ ·ï¼Œå°†ä¸´æ—¶å®¹å™¨æ·»åŠ åˆ° Pod åï¼Œå°†ä¸èƒ½æ›´æ”¹æˆ–åˆ é™¤ä¸´æ—¶å®¹å™¨ã€‚<br>
</p>

<p>
ä¸´æ—¶å®¹å™¨æ˜¯ä½¿ç”¨ Pod çš„ <code>ephemeralcontainers</code> å­èµ„æºåˆ›å»ºçš„ï¼Œå¯ä»¥ä½¿ç”¨ <code>kubectl --raw</code> å‘½ä»¤è¿›è¡Œæ˜¾ç¤ºã€‚ é¦–å…ˆæè¿°ä¸´æ—¶å®¹å™¨è¢«æ·»åŠ ä¸ºä¸€ä¸ª <code>EphemeralContainers</code> åˆ—è¡¨ï¼š<br>
</p>

<div class="org-src-container">
<pre class="src src-json">{
    "apiVersion": "v1",
    "kind": "EphemeralContainers",
    "metadata": {
        "name": "example-pod"
    },
    "ephemeralContainers": [{
        "command": [
            "sh"
        ],
        "image": "busybox",
        "imagePullPolicy": "IfNotPresent",
        "name": "debugger",
        "stdin": true,
        "tty": true,
        "terminationMessagePolicy": "File"
    }]
}
</pre>
</div>

<p>
ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ›´æ–°å·²è¿è¡Œçš„ä¸´æ—¶å®¹å™¨ =example-pod=ï¼š<br>
</p>

<div class="org-src-container">
<pre class="src src-shell">kubectl replace --raw /api/v1/namespaces/default/pods/example-pod/ephemeralcontainers  -f ec.json
</pre>
</div>

<p>
è¿™å°†è¿”å›ä¸´æ—¶å®¹å™¨çš„æ–°åˆ—è¡¨ï¼š<br>
</p>

<div class="org-src-container">
<pre class="src src-json">{
   "kind":"EphemeralContainers",
   "apiVersion":"v1",
   "metadata":{
      "name":"example-pod",
      "namespace":"default",
      "selfLink":"/api/v1/namespaces/default/pods/example-pod/ephemeralcontainers",
      "uid":"a14a6d9b-62f2-4119-9d8e-e2ed6bc3a47c",
      "resourceVersion":"15886",
      "creationTimestamp":"2019-08-29T06:41:42Z"
   },
   "ephemeralContainers":[
      {
         "name":"debugger",
         "image":"busybox",
         "command":[
            "sh"
         ],
         "resources":{

         },
         "terminationMessagePolicy":"File",
         "imagePullPolicy":"IfNotPresent",
         "stdin":true,
         "tty":true
      }
   ]
}
</pre>
</div>

<p>
å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ–°åˆ›å»ºçš„ä¸´æ—¶å®¹å™¨çš„çŠ¶æ€ï¼š<br>
</p>

<div class="org-src-container">
<pre class="src src-sh">kubectl describe pod example-pod
</pre>
</div>

<p>
è¾“å‡ºä¸ºï¼š<br>
</p>

<div class="org-src-container">
<pre class="src src-sh">...
Ephemeral Containers:
  debugger:
    Container ID:  docker://cf81908f149e7e9213d3c3644eda55c72efaff67652a2685c1146f0ce151e80f
    Image:         busybox
    Image ID:      docker-pullable://busybox@sha256:9f1003c480699be56815db0f8146ad2e22efea85129b5b5983d0e0fb52d9ab70
    Port:          &lt;none&gt;
    Host Port:     &lt;none&gt;
    Command:
      sh
    State:          Running
      Started:      Thu, 29 Aug 2019 06:42:21 +0000
    Ready:          False
    Restart Count:  0
    Environment:    &lt;none&gt;
    Mounts:         &lt;none&gt;
...
</pre>
</div>

<p>
å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿æ¥åˆ°æ–°çš„ä¸´æ—¶å®¹å™¨ï¼š<br>
</p>

<div class="org-src-container">
<pre class="src src-sh">kubectl attach -it example-pod -c debugger
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org08dc2bb" class="outline-3">
<h3 id="org08dc2bb">æ±¡ç‚¹Taintå’Œå®¹å¿Toleration</h3>
<div class="outline-text-3" id="text-org08dc2bb">
</div>
<div id="outline-container-orgbcccf2c" class="outline-4">
<h4 id="orgbcccf2c">å®¹å¿å’Œæ±¡ç‚¹Taintå’ŒToleration è®¾è®¡ç†å¿µ</h4>
<div class="outline-text-4" id="text-orgbcccf2c">
</div>
<div id="outline-container-orgb212eb0" class="outline-5">
<h5 id="orgb212eb0">ç”Ÿäº§ç¯å¢ƒçš„è°ƒåº¦å¹¶ééšä¾¿</h5>
<div class="outline-text-5" id="text-orgb212eb0">
<ul class="org-ul">
<li>MasterèŠ‚ç‚¹ï¼šå…¶ä»–ç±»å‹çš„ Pod ä¸è¦éƒ¨ç½²åˆ°æˆ‘èº«ä¸Š<br>
<ul class="org-ul">
<li>Kube-Proxy, Kube-ControllerManager, Kube-APIServer, Calico, Metrics-Server, Dashboard<br></li>
</ul></li>
<li>æ–°å¢èŠ‚ç‚¹ï¼šæˆ‘è¿˜æ²¡æœ‰ç»è¿‡å®Œæ•´çš„å¯ç”¨æ€§æµ‹è¯•ï¼Œä¸èƒ½éƒ¨ç½² Pod åˆ°æˆ‘èº«ä¸Š<br></li>
<li>ç»´æŠ¤èŠ‚ç‚¹ï¼šæˆ‘è¦è¿›è¡Œç»´æŠ¤/å‡çº§äº†ï¼Œéœ€è¦å°† Pod æå‰è¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹<br></li>
<li>ç‰¹æ®ŠèŠ‚ç‚¹ï¼ˆSSD/GPUï¼‰ï¼šæˆ‘å¾ˆæ˜‚è´µï¼Œä¸èƒ½éšä¾¿ä¸€ä¸ª Pod éƒ½èƒ½éƒ¨ç½²åˆ°æˆ‘èº«ä¸Š<br></li>
</ul>
</div>
</div>
<div id="outline-container-org5fe6033" class="outline-5">
<h5 id="org5fe6033">å®¹å¿å’Œæ±¡ç‚¹Taintå’ŒToleration</h5>
<div class="outline-text-5" id="text-org5fe6033">
<p>
è®¾è®¡ç†å¿µï¼šTaint åœ¨ä¸€ç±»æœåŠ¡å™¨ä¸Šæ‰“ä¸Šæ±¡ç‚¹ï¼Œè®©ä¸èƒ½å®¹å¿è¿™ä¸ªæ±¡ç‚¹çš„ Pod ä¸èƒ½éƒ¨ç½²åœ¨æ‰“äº†æ±¡ç‚¹çš„æœåŠ¡å™¨ä¸Šï¼Œç±»ä¼¼ç»™èŠ‚ç‚¹åŠ äº†é”ã€‚Toleration æ˜¯è®© Pod å®¹å¿èŠ‚ç‚¹ä¸Šé…ç½®çš„æ±¡ç‚¹ï¼Œå¯ä»¥è®©ä¸€äº›éœ€è¦ç‰¹æ®Šé…ç½®çš„ Pod èƒ½å¤Ÿè°ƒç”¨åˆ°å…·æœ‰æ±¡ç‚¹å’Œç‰¹æ®Šé…ç½®çš„èŠ‚ç‚¹ä¸Šï¼Œç±»ä¼¼ç»™èŠ‚ç‚¹åŠ é’¥åŒ™ã€‚<br>
</p>

<p>
å®˜ æ–¹ æ–‡ æ¡£ ï¼š<a href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/">https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/</a><br>
</p>

<p>
æ‰€è°“æ±¡ç‚¹å°±æ˜¯æ•…æ„ç»™æŸä¸ªèŠ‚ç‚¹æœåŠ¡å™¨ä¸Šè®¾ç½®ä¸ªæ±¡ç‚¹å‚æ•°ï¼Œé‚£ä¹ˆä½ å°±èƒ½è®©ç”Ÿæˆpodçš„æ—¶å€™ä½¿ç”¨ç›¸åº”çš„å‚æ•°å»é¿å¼€æœ‰æ±¡ç‚¹å‚æ•°çš„nodeæœåŠ¡å™¨ã€‚è€Œå®¹å¿å‘¢ï¼Œå°±æ˜¯å½“èµ„æºä¸å¤Ÿç”¨çš„æ—¶å€™ï¼Œå³ä½¿è¿™ä¸ªnodeæœåŠ¡å™¨ä¸Šæœ‰æ±¡ç‚¹ï¼Œé‚£ä¹ˆåªè¦podçš„yamlé…ç½®æ–‡ä»¶ä¸­å†™äº†å®¹å¿å‚æ•°ï¼Œæœ€ç»ˆpodè¿˜æ˜¯ä¼šå®¹å¿çš„ç”Ÿæˆåœ¨è¯¥æ±¡ç‚¹æœåŠ¡å™¨ä¸Šã€‚é»˜è®¤masterèŠ‚ç‚¹æ˜¯NoSchedule<br>
</p>
</div>
</div>
</div>
<div id="outline-container-org195329e" class="outline-4">
<h4 id="org195329e">æ±¡ç‚¹å’Œå®¹å¿é…ç½®è§£æ</h4>
<div class="outline-text-4" id="text-org195329e">
</div>
<div id="outline-container-org751deef" class="outline-5">
<h5 id="org751deef">æ±¡ç‚¹(Taint)é…ç½®è§£æ</h5>
<div class="outline-text-5" id="text-org751deef">
<p>
åˆ›å»ºä¸€ä¸ªæ±¡ç‚¹ï¼ˆä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªæ±¡ç‚¹ï¼‰ï¼š<br>
ä½¿ç”¨kubectl taintå‘½ä»¤å¯ä»¥ç»™æŸä¸ªNodeèŠ‚ç‚¹è®¾ç½®æ±¡ç‚¹ï¼ŒNodeè¢«è®¾ç½®ä¸Šæ±¡ç‚¹ä¹‹åå°±å’ŒPodä¹‹é—´å­˜åœ¨äº†ä¸€ç§ç›¸æ–¥çš„å…³ç³»ï¼Œå¯ä»¥è®©Nodeæ‹’ç»Podçš„è°ƒåº¦æ‰§è¡Œï¼Œç”šè‡³å°†Nodeå·²ç»å­˜åœ¨çš„Podé©±é€å‡ºå»ã€‚key=value:effect<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl taint nodes NODE_NAME <span style="color: #a0522d;">TAINT_KEY</span>=TAINT_VALUE:EFFECT
&#27604;&#22914;&#65306;
kubectl taint nodes k8s-node01 <span style="color: #a0522d;">ssd</span>=true:PreferNoSchedule
</pre>
</div>


<p>
æ¯ä¸ªæ±¡ç‚¹æœ‰ä¸€ä¸ªkeyå’Œvalueä½œä¸ºæ±¡ç‚¹çš„æ ‡ç­¾ï¼Œå…¶ä¸­valueå¯ä»¥ä¸ºç©ºï¼Œeffectæè¿°æ±¡ç‚¹çš„ä½œç”¨ã€‚å½“å‰taint effectæ”¯æŒå¦‚ä¸‹ä¸‰ä¸ªé€‰é¡¹ï¼š<br>
</p>
<ul class="org-ul">
<li>NoScheduleï¼šç¦æ­¢è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼Œå·²ç»åœ¨è¯¥èŠ‚ç‚¹ä¸Šçš„Podä¸å—å½±å“<br></li>
<li>NoExecuteï¼šç¦æ­¢è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼Œå¦‚æœä¸ç¬¦åˆè¿™ä¸ªæ±¡ç‚¹ï¼Œä¼šç«‹é©¬è¢«é©±é€ï¼ˆæˆ–åœ¨ä¸€æ®µæ—¶é—´åï¼‰<br></li>
<li>PreferNoScheduleï¼šå°½é‡é¿å…å°†Podè°ƒåº¦åˆ°æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæ²¡æœ‰æ›´åˆé€‚çš„èŠ‚ç‚¹ï¼Œå¯ä»¥éƒ¨ç½²åˆ°è¯¥èŠ‚ç‚¹<br></li>
</ul>


<p>
å»é™¤æ±¡ç‚¹NoScheduleï¼Œæœ€åä¸€ä¸ª"-"ä»£è¡¨åˆ é™¤ï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl taint nodes k8s-master02 node-role.kubernetes.io/master:NoSchedule-
</pre>
</div>



<p>
æŸ¥çœ‹æŸä¸ªèŠ‚ç‚¹çš„Tainté…ç½®æƒ…å†µï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">]# kubectl describe node k8s-node01  (&#20869;&#23481;&#22826;&#22810;&#19981;&#36148;&#20840;&#20102;)
Taints:             &lt;none&gt;   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20851;&#27880;&#36825;&#20010;&#22320;&#26041;&#21363;&#21487; ---&#27809;&#26377;&#35774;&#32622;&#36807;&#27745;&#28857;&#30340;&#33410;&#28857;&#23646;&#24615;&#20013;&#30340;&#21442;&#25968;&#26159;&#36825;&#26679;&#30340;Taints:     &lt;none&gt;</span>
</pre>
</div>
</div>
<ul class="org-ul">
<li><a id="org23f65c6"></a>èŠ‚ç‚¹çš„Taintè®¾ç½®æ ·ä¾‹<br>
<div class="outline-text-6" id="text-org23f65c6">
<ul class="org-ul">
<li>MasterèŠ‚ç‚¹ï¼šå…¶ä»–ç±»å‹çš„ Pod ä¸è¦éƒ¨ç½²åˆ°æˆ‘èº«ä¸Š<br>
<ul class="org-ul">
<li>node-role.kubernetes.io/master:NoSchedule<br></li>
</ul></li>
<li>æ–°å¢èŠ‚ç‚¹ï¼šæˆ‘è¿˜æ²¡æœ‰ç»è¿‡å®Œæ•´çš„å¯ç”¨æ€§æµ‹è¯•ï¼Œä¸èƒ½éƒ¨ç½² Pod åˆ°æˆ‘èº«ä¸Š<br>
<ul class="org-ul">
<li>node-role.kubernetes.io/new-node:NoExecute<br></li>
<li>node-role.kubernetes.io/maintain:NoExecute<br></li>
</ul></li>
<li>ç»´æŠ¤èŠ‚ç‚¹ï¼šæˆ‘è¦è¿›è¡Œç»´æŠ¤/å‡çº§äº†ï¼Œéœ€è¦å°† Pod æå‰è¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹<br>
<ul class="org-ul">
<li>node-role.kubernetes.io/new-node: NoSchedule<br></li>
</ul></li>
<li>ç‰¹æ®ŠèŠ‚ç‚¹ï¼ˆSSD/GPUï¼‰ï¼šæˆ‘å¾ˆæ˜‚è´µï¼Œä¸èƒ½éšä¾¿ä¸€ä¸ª Pod éƒ½èƒ½éƒ¨ç½²åˆ°æˆ‘èº«ä¸Š<br>
<ul class="org-ul">
<li>node-role.kubernetes.io/ssd:PreferNoSchedule<br></li>
</ul></li>
</ul>
</div>
</li>
</ul>
</div>
<div id="outline-container-org212a3bd" class="outline-5">
<h5 id="org212a3bd">Toleration é…ç½®è§£æ</h5>
<div class="outline-text-5" id="text-org212a3bd">
<p>
Toleration é…ç½®åœ¨ Pod ä¸­<br>
</p>

<p>
æ–¹å¼ä¸€å®Œå…¨åŒ¹é…ï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-yaml">tolerations:
- key: "key"
  operator: "Equal"
  value: "value"
  effect: "NoSchedule"
</pre>
</div>

<p>
æ–¹å¼äºŒä¸å®Œå…¨åŒ¹é…ï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-yaml">tolerations:
- key: "key"
  operator: "Exists"
  effect: "NoSchedule"
</pre>
</div>

<p>
ä¸€ä¸ªTolerationå’Œä¸€ä¸ªTaintç›¸åŒ¹é…æ˜¯æŒ‡å®ƒä»¬æœ‰ä¸€æ ·çš„keyå’Œeffectï¼Œå¹¶ä¸”å¦‚æœoperatoræ˜¯Existsï¼ˆæ­¤æ—¶tolerationä¸æŒ‡å®švalueï¼‰æˆ–è€…operatoræ˜¯Equalï¼Œåˆ™å®ƒä»¬çš„valueåº”è¯¥ç›¸ç­‰ã€‚<br>
</p>



<p>
æ–¹å¼ä¸‰å¤§èŒƒå›´åŒ¹é…ï¼ˆä¸æ¨èkeyä¸ºå†…ç½®Taintï¼‰ï¼š<br>
å¦‚æœä¸€ä¸ª Toleration çš„ effect ä¸ºç©ºï¼Œåˆ™ key ä¸ä¹‹ç›¸åŒçš„ç›¸åŒ¹é…çš„ Taint çš„ effect å¯ä»¥æ˜¯ä»»æ„å€¼ï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-yaml">tolerations:
- key: "key"
  operator: "Exists"
</pre>
</div>

<p>
æ–¹å¼å››åŒ¹é…æ‰€æœ‰ï¼ˆä¸æ¨èï¼‰ï¼š<br>
å¦‚æœä¸€ä¸ªTolerationçš„keyä¸ºç©ºä¸”operatorä¸ºExistsï¼Œè¡¨ç¤ºè¿™ä¸ªTolerationä¸ä»»æ„çš„keyã€valueå’Œeffectéƒ½åŒ¹é…ï¼Œå³è¿™ä¸ªTolerationèƒ½å®¹å¿ä»»æ„çš„Taintï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-yaml">tolerations:
- operator: "Exists"
</pre>
</div>

<p>
åœç•™æ—¶é—´é…ç½®ï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-yaml">tolerations:
- key: "key1"
  operator: "Equal"
  value: "value1"
  effect: "NoExecute"
  tolerationSeconds: 3600 # åœ¨ 3600 ç§’å pod è¢«é©±é€
</pre>
</div>

<p>
Kubernetesä¼šè‡ªåŠ¨ç»™Podæ·»åŠ ä¸€ä¸ªkeyä¸ºnode.kubernetes.io/not-readyçš„Tolerationå¹¶é…ç½®tolerationSeconds=300ï¼ŒåŒæ ·ä¹Ÿä¼šç»™Podæ·»åŠ ä¸€ä¸ªkeyä¸ºnode.kubernetes.io/unreachableçš„Tolerationå¹¶é…ç½®tolerationSeconds=300ï¼Œé™¤éç”¨æˆ·è‡ªå®šä¹‰äº†ä¸Šè¿°keyï¼Œå¦åˆ™ä¼šé‡‡ç”¨è¿™ä¸ªé»˜è®¤è®¾ç½®ã€‚<br>
</p>
</div>
</div>
</div>
<div id="outline-container-orgb86b445" class="outline-4">
<h4 id="orgb86b445">Taint å’Œ  nodeSelector åŒºåˆ«ï¼š</h4>
<div class="outline-text-4" id="text-orgb86b445">
<ul class="org-ul">
<li>nodeSelector æ˜¯å¼ºåˆ¶æ€§çš„ pod åœ¨æŒ‡å®šèŠ‚ç‚¹ä¸Š<br></li>
<li>toleration ä¸æ˜¯å¼ºåˆ¶æŒ‡å®šèŠ‚ç‚¹è€Œé™„åŠ å…è®¸çš„æ“ä½œï¼›è°ƒåº¦åˆ°è¿™ä¸ªåŠ æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šäº†å°±åŒ¹é…æ˜¯å¦å¯ä»¥å®¹å¿ï¼Œè°ƒåº¦åˆ°æ²¡åŠ æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Š pod æœ‰æ²¡æœ‰å®¹å¿éƒ½å¯ä»¥éƒ¨ç½²ã€‚å¦‚æœæƒ³æŒ‡å®šèŠ‚ç‚¹è¦ç”¨ nodeSelector æˆ–è€… Affinity å®ç°ã€‚<br></li>
</ul>
</div>
</div>
<div id="outline-container-org7f2e04e" class="outline-4">
<h4 id="org7f2e04e">æ±¡ç‚¹å’Œå®¹å¿é…ç½®è§£æç¤ºä¾‹</h4>
<div class="outline-text-4" id="text-org7f2e04e">
<p>
æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯çº¯SSDç¡¬ç›˜çš„èŠ‚ç‚¹ï¼Œç°éœ€è¦åªæœ‰ä¸€äº›éœ€è¦é«˜æ€§èƒ½å­˜å‚¨çš„Podæ‰èƒ½è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¸Š<br>
</p>

<p>
ç»™èŠ‚ç‚¹æ‰“ä¸Šæ±¡ç‚¹å’Œæ ‡ç­¾ï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">1. kubectl taint nodes k8s-node01 <span style="color: #a0522d;">ssd</span>=true:NoExecute&#65288;&#27492;&#26102;&#20250;&#39537;&#36880;&#27809;&#26377;&#23481;&#24525;&#35813;&#27745;&#28857;&#30340;Pod&#65289;
2. kubectl taint nodes k8s-node01 <span style="color: #a0522d;">ssd</span>=true:NoSchedule
3. kubectl label node k8s-node01 <span style="color: #a0522d;">ssd</span>=true
</pre>
</div>

<p>
é…ç½® deplyment nginxï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: nginx
  name: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - image: nginx:1.15.12
        name: nginx
      nodeSelector:
        ssh: "true"
      tolerations:
      - key: "ssd"
        operator: "Exists"
</pre>
</div>


<p>
èŒƒä¾‹ï¼šdeployment<br>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">node &#27745;&#28857;</span>
kubectl taint nodes k8s-node02 <span style="color: #a0522d;">ludo</span>=staging:NoExecute

<span style="color: #b22222;"># </span><span style="color: #b22222;">deploy</span>
  template:
    metadata:
      annotations:
        prometheus.io/scrape: <span style="color: #8b2252;">'true'</span>
        prometheus.io/path: <span style="color: #8b2252;">'/actuator/prometheus'</span>
        prometheus.io/port: <span style="color: #8b2252;">'10082'</span>
      labels:
        department: taskcenter
        app: task-center-job
        env: prod
    spec:
      nodeSelector:
        <span style="color: #483d8b;">type</span>: ludo-staging-app
      tolerations:
      - key: <span style="color: #8b2252;">"ludo"</span>
        operator: <span style="color: #8b2252;">"Exists"</span>
      terminationGracePeriodSeconds: 90
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchLabels:
                  app: task-center-job
              namespaces:
              - taskcenter
              topologyKey: kubernetes.io/hostname
            weight: 1
</pre>
</div>

<p>
damonset åœ¨ä»»æ„èŠ‚ç‚¹è¿è¡Œ<br>
</p>
<pre class="example" id="org8b2abaf">
spec:
  tolerations:
  - effect: NoSchedule
    operator: "Exists"
  - effect: NoExecute
    operator: "Exists"
</pre>
</div>
</div>
<div id="outline-container-org2663a82" class="outline-4">
<h4 id="org2663a82">å†…ç½®æ±¡ç‚¹</h4>
<div class="outline-text-4" id="text-org2663a82">
<p>
k8s èŠ‚ç‚¹å‡ºç°é—®é¢˜æ—¶ pod é£˜ç§»èµ°å°±æ˜¯å› ä¸ºè‡ªåŠ¨æ‰“äº†æ±¡ç‚¹ï¼š<br>
</p>
<ul class="org-ul">
<li>node.kubernetes.io/not-readyï¼šèŠ‚ç‚¹æœªå‡†å¤‡å¥½ï¼Œç›¸å½“äºèŠ‚ç‚¹çŠ¶æ€Readyçš„å€¼ä¸ºFalseã€‚<br></li>
<li>node.kubernetes.io/unreachableï¼šNode Controllerè®¿é—®ä¸åˆ°èŠ‚ç‚¹ï¼Œç›¸å½“äºèŠ‚ç‚¹çŠ¶æ€Readyçš„å€¼ä¸ºUnknownã€‚<br>
<ul class="org-ul">
<li>node.kubernetes.io/out-of-diskï¼šèŠ‚ç‚¹ç£ç›˜è€—å°½ã€‚<br></li>
</ul></li>
<li>node.kubernetes.io/memory-pressureï¼šèŠ‚ç‚¹å­˜åœ¨å†…å­˜å‹åŠ›ã€‚<br></li>
<li>node.kubernetes.io/disk-pressureï¼šèŠ‚ç‚¹å­˜åœ¨ç£ç›˜å‹åŠ›ã€‚<br></li>
<li>node.kubernetes.io/network-unavailableï¼šèŠ‚ç‚¹ç½‘ç»œä¸å¯è¾¾ã€‚<br></li>
<li>node.kubernetes.io/unschedulableï¼šèŠ‚ç‚¹ä¸å¯è°ƒåº¦ã€‚<br></li>
<li>node.cloudprovider.kubernetes.io/uninitializedï¼šå¦‚æœKubeletå¯åŠ¨æ—¶æŒ‡å®šäº†ä¸€ä¸ªå¤–éƒ¨çš„cloudproviderï¼Œå®ƒå°†ç»™å½“å‰èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªTaintå°†å…¶æ ‡è®°ä¸ºä¸å¯ç”¨ã€‚åœ¨cloud-controller-managerçš„ä¸€ä¸ªcontrolleråˆå§‹åŒ–è¿™ä¸ªèŠ‚ç‚¹åï¼ŒKubeletå°†åˆ é™¤è¿™ä¸ªTaintã€‚<br></li>
</ul>

<p>
k8s ä¸º pod è‡ªåŠ¨æ³¨å…¥å®¹å¿ã€‚å½“èŠ‚ç‚¹ä¸å¥åº·ï¼Œpod 6000ç§’åå†é©±é€ï¼ˆé»˜è®¤æ˜¯300ç§’ï¼‰ï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-yaml">tolerations:
- key: "node.kubernetes.io/unreachable"
  operator: "Exists"
  effect: "NoExecute"
  tolerationSeconds: 6000
</pre>
</div>

<p>
èŠ‚ç‚¹ä¸å¥åº·çš„æ£€æŸ¥é—´éš”ç”± controller manager çš„ `&#x2013;node_monitor-period=5s` æ¢æµ‹é—´éš”å’Œ `&#x2013;node-monitor-grace-period=40s` æ ‡è®°ä¸å¯ç”¨æ¥æ§åˆ¶ã€‚<br>
pod çš„é£˜ç§»æ—¶é—´ä¸ºå¤§äº `40+5+pod tolerationSeconds`<br>
</p>
</div>
<div id="outline-container-orgc414699" class="outline-5">
<h5 id="orgc414699">å®ç°èŠ‚ç‚¹å®•æœºå¿«é€Ÿè¿ç§»æœåŠ¡</h5>
<div class="outline-text-5" id="text-orgc414699">
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: nginx
  name: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - image: nginx:1.15.12
        name: nginx
      nodeSelector:
        ssh: "true"
      tolerations:
      - key: ssd
        operator: Equal
        value: "true"
      - effect: NoExecute
        key: node.kubernetes.io/unreachable
        operator: Exists
        tolerationSeconds: 10
      - effect: NoExecute
        key: node.kubernetes.io/not-ready
        operator: Exists
        tolerationSeconds: 10
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org22a02f2" class="outline-4">
<h4 id="org22a02f2">Taint å‘½ä»¤å…¥é—¨</h4>
<div class="outline-text-4" id="text-org22a02f2">
<p>
åˆ›å»ºä¸€ä¸ªæ±¡ç‚¹ï¼ˆä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªæ±¡ç‚¹ï¼‰ï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl taint nodes NODE_NAME <span style="color: #a0522d;">TAINT_KEY</span>=TAINT_VALUE:EFFECT
&#27604;&#22914;&#65306;
kubectl taint nodes k8s-node01 <span style="color: #a0522d;">ssd</span>=true:PreferNoSchedule
</pre>
</div>

<p>
æŸ¥çœ‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ±¡ç‚¹ï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl get node k8s-node01 -o go-template --template {{.spec.taints}}
kubectl describe node k8s-node01 | grep Taints -A 10
</pre>
</div>

<p>
åˆ é™¤æ±¡ç‚¹ï¼ˆå’Œlabelç±»ä¼¼ï¼‰ï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">&#22522;&#20110;Key&#21024;&#38500;&#65306; kubectl taint nodes k8s-node01 ssd-
&#22522;&#20110;Key+Effect&#21024;&#38500;&#65306; kubectl taint nodes k8s-node01 ssd:PreferNoSchedule-
</pre>
</div>


<p>
ä¿®æ”¹æ±¡ç‚¹ï¼ˆKeyå’ŒEffectç›¸åŒï¼‰ï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl taint nodes k8s-node01 <span style="color: #a0522d;">ssd</span>=true:PreferNoSchedule --overwrite
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb34cfae" class="outline-3">
<h3 id="orgb34cfae">Affinity äº²å’ŒåŠ›</h3>
<div class="outline-text-3" id="text-orgb34cfae">
</div>
<div id="outline-container-orga87d0a0" class="outline-4">
<h4 id="orga87d0a0">ç”Ÿäº§ç¯å¢ƒä¾æ—§å­˜åœ¨é«˜å¯ç”¨ç‡é—®é¢˜</h4>
<div class="outline-text-4" id="text-orga87d0a0">
<p>
Podå’ŒèŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»ï¼š<br>
</p>
<ul class="org-ul">
<li>æŸäº›Podä¼˜å…ˆé€‰æ‹©æœ‰ssd=trueæ ‡ç­¾çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰åœ¨è€ƒè™‘éƒ¨ç½²åˆ°å…¶å®ƒèŠ‚ç‚¹ï¼›nodeSelector å› ä¸ºæ˜¯å¼ºåˆ¶æŒ‡å®šæ‰€ä»¥æ»¡è¶³ä¸äº†<br></li>
<li>æŸäº›Podéœ€è¦éƒ¨ç½²åœ¨ssd=trueå’Œtype=physicalçš„èŠ‚ç‚¹ä¸Šï¼Œä½†æ˜¯ä¼˜å…ˆéƒ¨ç½²åœ¨ssd=trueçš„èŠ‚ç‚¹ä¸Šï¼›<br></li>
</ul>

<p>
Podå’ŒPodä¹‹é—´çš„å…³ç³»ï¼š<br>
</p>
<ul class="org-ul">
<li>åŒä¸€ä¸ªåº”ç”¨çš„Podä¸åŒçš„å‰¯æœ¬æˆ–è€…åŒä¸€ä¸ªé¡¹ç›®çš„åº”ç”¨å°½é‡æˆ–å¿…é¡»ä¸éƒ¨ç½²åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…ç¬¦åˆæŸä¸ªæ ‡ç­¾çš„ä¸€ç±»èŠ‚ç‚¹ä¸Šæˆ–è€…ä¸åŒçš„åŒºåŸŸï¼›ï¼ˆåäº²å’ŒåŠ›ï¼‰<br></li>
<li>ç›¸äº’ä¾èµ–çš„ä¸¤ä¸ªPodå°½é‡æˆ–å¿…é¡»éƒ¨ç½²åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šæˆ–è€…åŒä¸€ä¸ªåŸŸå†…ã€‚ï¼ˆäº²å’ŒåŠ›ï¼‰<br></li>
</ul>

<p>
Affinityäº²å’ŒåŠ›å¯ä»¥å¸®å¿™æˆ‘ä»¬è§£å†³è¿™äº›é—®é¢˜ã€‚<br>
</p>
</div>
</div>
<div id="outline-container-orgcd8a615" class="outline-4">
<h4 id="orgcd8a615">Affinity åˆ†ç±»</h4>
<div class="outline-text-4" id="text-orgcd8a615">
<p>
Affinity äº²å’ŒåŠ›ï¼š<br>
</p>
<ul class="org-ul">
<li>NodeAffinityï¼šèŠ‚ç‚¹äº²å’ŒåŠ›/åäº²å’ŒåŠ›<br></li>
<li>PodAffinityï¼šPodäº²å’ŒåŠ›<br></li>
<li>PodAntiAffinityï¼šPodåäº²å’ŒåŠ›<br></li>
</ul>

<p>
Affinity äº²å’ŒåŠ›ï¼š<br>
</p>
<ul class="org-ul">
<li>NodeAffinityï¼š<br>
<ul class="org-ul">
<li>requiredDuringSchedulingIgnoredDuringExecutionï¼ˆç¡¬äº²å’ŒåŠ›ï¼‰<br></li>
<li>preferredDuringSchedulingIgnoredDuringExecutionï¼ˆè½¯äº²å’ŒåŠ›ï¼‰<br></li>
</ul></li>
<li>PodAffinity &amp; PodAntiAffinityï¼šï¼š<br>
<ul class="org-ul">
<li>requiredDuringSchedulingIgnoredDuringExecution ï¼ˆç¡¬äº²å’ŒåŠ›ï¼‰<br></li>
<li>preferredDuringSchedulingIgnoredDuringExecutionï¼ˆè½¯äº²å’ŒåŠ›ï¼‰<br></li>
</ul></li>
</ul>
</div>
<div id="outline-container-org29d8d46" class="outline-5">
<h5 id="org29d8d46">æå‡å¯ç”¨æ€§</h5>
<div class="outline-text-5" id="text-org29d8d46">
<ul class="org-ul">
<li>éƒ¨ç½²åœ¨ä¸åŒçš„å®¿ä¸»æœºä¸Š<br></li>
<li>éƒ¨ç½²åœ¨ä¸åŒæœºæˆ¿<br></li>
<li>å°½é‡æŠŠåŒé¡¹ç›®ä¸­ä¸åŒçš„æœåŠ¡éƒ¨ç½²åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œé¿å…å•èŠ‚ç‚¹æŒ‚æ‰å½±å“èŒƒå›´å¤§é—®é¢˜ã€‚<br></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgde29881" class="outline-4">
<h4 id="orgde29881">èŠ‚ç‚¹äº²å’ŒåŠ›é…ç½®</h4>
<div class="outline-text-4" id="text-orgde29881">
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: v1
kind: Pod
metadata:
  name: with-affinity-anti-affinity
spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/os
            operator: In
            values:
            - linux
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 1
        preference:
          matchExpressions:
          - key: label-1
            operator: In
            values:
            - key-1
      - weight: 50
        preference:
          matchExpressions:
          - key: label-2
            operator: In
            values:
            - key-2
  containers:
  - name: with-node-affinity
    image: k8s.gcr.io/pause:2.0
</pre>
</div>

<p>
é…ç½®è¯´æ˜ï¼š<br>
</p>
<ul class="org-ul">
<li>requiredDuringSchedulingIgnoredDuringExecutionï¼šç¡¬äº²å’ŒåŠ›é…ç½®<br>
<ul class="org-ul">
<li>nodeSelectorTermsï¼šèŠ‚ç‚¹é€‰æ‹©å™¨é…ç½®ï¼Œå¯ä»¥é…ç½®å¤šä¸ªmatchExpressionsï¼ˆæ»¡è¶³å…¶ä¸€ï¼‰ï¼Œæ¯ä¸ªmatchExpressionsä¸‹å¯ä»¥é…ç½®å¤šä¸ªkeyã€valueç±»å‹çš„é€‰æ‹©å™¨ï¼ˆéƒ½éœ€è¦æ»¡è¶³ï¼‰ï¼Œå…¶ä¸­valueså¯ä»¥é…ç½®å¤šä¸ªï¼ˆæ»¡è¶³å…¶ä¸€ï¼‰<br></li>
</ul></li>
<li>preferredDuringSchedulingIgnoredDuringExecutionï¼šè½¯äº²å’ŒåŠ›é…ç½®<br>
<ul class="org-ul">
<li>weightï¼šè½¯äº²å’ŒåŠ›çš„æƒé‡ï¼Œæƒé‡è¶Šé«˜ä¼˜å…ˆçº§è¶Šå¤§ï¼ŒèŒƒå›´1-100<br></li>
<li>preferenceï¼šè½¯äº²å’ŒåŠ›é…ç½®é¡¹ï¼Œå’ŒweightåŒçº§ï¼Œå¯ä»¥é…ç½®å¤šä¸ªï¼ŒmatchExpressionså’Œç¡¬äº²å’ŒåŠ›ä¸€è‡´<br></li>
</ul></li>
<li>operatorï¼šæ ‡ç­¾åŒ¹é…çš„æ–¹å¼<br>
<ul class="org-ul">
<li>Inï¼šç›¸å½“äºkey = valueçš„å½¢å¼<br></li>
<li>NotInï¼šç›¸å½“äºkey != valueçš„å½¢å¼<br></li>
<li>Existsï¼šèŠ‚ç‚¹å­˜åœ¨labelçš„keyä¸ºæŒ‡å®šçš„å€¼å³å¯ï¼Œä¸èƒ½é…ç½®valueså­—æ®µã€‚<br></li>
<li>DoesNotExistï¼šèŠ‚ç‚¹ä¸å­˜åœ¨labelçš„keyä¸ºæŒ‡å®šçš„å€¼å³å¯ï¼Œä¸èƒ½é…ç½®valueså­—æ®µã€‚å¦‚éƒ¨ç½²åœ¨æ²¡æœ‰ GPU key æ ‡ç­¾çš„èŠ‚ç‚¹<br></li>
<li>Gtï¼šå¤§äºvalueæŒ‡å®šçš„å€¼<br></li>
<li>Ltï¼šå°äºvalueæŒ‡å®šçš„å€¼<br></li>
</ul></li>
</ul>

<p>
èŒƒä¾‹ï¼šnode è½¯ç¡¬äº²å’Œæ€§è”åˆ<br>
</p>

<div class="org-src-container">
<pre class="src src-shell">]# cat node_affinity.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: node-affinity-deploy
  labels:
    app: nodeaffinity-deploy
spec:
  replicas: 5
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp-pod
        image: registry.cn-beijing.aliyuncs.com/google_registry/myapp:v1
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 80
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              <span style="color: #b22222;"># </span><span style="color: #b22222;">&#34920;&#31034;node&#26631;&#31614;&#23384;&#22312; cpu-num&#19988;&#20540;&#22823;&#20110;10</span>
            - matchExpressions:
              - key: cpu-num
                operator: Gt
                values:
                - <span style="color: #8b2252;">"10"</span>
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 50
            preference:
              matchExpressions:
                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#34920;&#31034;node&#26631;&#31614;&#23384;&#22312; disk-type=ssd &#25110; disk-type=sas</span>
              - key: disk-type
                operator: In
                values:
                - ssd
                - sas

</pre>
</div>
</div>
</div>
<div id="outline-container-orgd9380aa" class="outline-4">
<h4 id="orgd9380aa">Pod äº²å’ŒåŠ›å’Œåäº²å’ŒåŠ›é…ç½®</h4>
<div class="outline-text-4" id="text-orgd9380aa">
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-server
spec:
  selector:
    matchLabels:
      app: web-store
  replicas: 3
  template:
    metadata:
      labels:
        app: web-store
    spec:
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - store
            topologyKey: failure-domain.beta.kubernetes.io/zone
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: security
                  operator: In
                  values:
                  - S2
              namespaces:
              - default
              topologyKey: failure-domain.beta.kubernetes.io/zone
          - weight: 10
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app: ludo-user
              namespaces:
              - default
              topologyKey: failure-domain.beta.kubernetes.io/zone
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - canal-admin
            namespaces:
            - default
            topologyKey: kubernetes.io/hostname
      containers:
      - name: web-app
        image: nginx:1.16-alpine

</pre>
</div>

<p>
é…ç½®è¯´æ˜:<br>
</p>
<ul class="org-ul">
<li>requiredDuringSchedulingIgnoredDuringExecutionï¼šç¡¬äº²å’ŒåŠ›é…ç½®<br>
<ul class="org-ul">
<li>labelSelectorï¼šPodé€‰æ‹©å™¨é…ç½®ï¼Œå¯ä»¥é…ç½®å¤šä¸ª<br></li>
<li>topologyKeyï¼šåŒ¹é…çš„æ‹“æ‰‘åŸŸçš„keyï¼Œä¹Ÿå°±æ˜¯èŠ‚ç‚¹ä¸Šlabelçš„keyï¼Œkeyå’Œvalueç›¸åŒçš„ä¸ºåŒä¸€ä¸ªåŸŸï¼Œå¯ä»¥ç”¨äºæ ‡æ³¨ä¸åŒçš„æœºæˆ¿å’Œåœ°åŒº<br></li>
<li>namespaces: å’Œå“ªä¸ªå‘½åç©ºé—´çš„Podè¿›è¡ŒåŒ¹é…ï¼Œç©º æˆ–è€…æ²¡æœ‰ namespaceSelector ä¸ºå½“å‰å‘½åç©ºé—´<br></li>
<li>namespaceSelectorï¼šç©º <code>{}</code> ä¸ºæ‰€æœ‰åç§°ç©ºé—´<br></li>
</ul></li>
<li>preferredDuringSchedulingIgnoredDuringExecutionï¼šè½¯äº²å’ŒåŠ›é…ç½®<br>
<ul class="org-ul">
<li>weightï¼šè½¯äº²å’ŒåŠ›çš„æƒé‡ï¼Œæƒé‡è¶Šé«˜ä¼˜å…ˆçº§è¶Šå¤§ï¼ŒèŒƒå›´1-100<br></li>
<li>podAffinityTermï¼šè½¯äº²å’ŒåŠ›é…ç½®é¡¹ï¼Œå’ŒweightåŒçº§<br>
<ul class="org-ul">
<li>labelSelectorï¼šPodé€‰æ‹©å™¨é…ç½®<br></li>
<li>topologyKeyï¼šåŒ¹é…çš„æ‹“æ‰‘åŸŸçš„keyï¼Œä¹Ÿå°±æ˜¯èŠ‚ç‚¹ä¸Šlabelçš„keyï¼Œkeyå’Œvalueç›¸åŒçš„ä¸ºåŒä¸€ä¸ªåŸŸï¼Œå¯ä»¥ç”¨äºæ ‡æ³¨ä¸åŒçš„æœºæˆ¿å’Œåœ°åŒº<br></li>
<li>namespaces: å’Œå“ªä¸ªå‘½åç©ºé—´çš„Podè¿›è¡ŒåŒ¹é…ï¼Œç©º æˆ–è€…æ²¡æœ‰ namespaceSelector ä¸ºå½“å‰å‘½åç©ºé—´<br></li>
<li>namespaceSelectorï¼šç©º`{}`ä¸ºæ‰€æœ‰åç§°ç©ºé—´<br></li>
</ul></li>
</ul></li>

<li>matchExpressionsï¼šå’ŒèŠ‚ç‚¹äº²å’ŒåŠ›é…ç½®ä¸€è‡´<br></li>
<li>operatorï¼šé…ç½®å’ŒèŠ‚ç‚¹äº²å’ŒåŠ›ä¸€è‡´ï¼Œä½†æ˜¯æ²¡æœ‰Gtå’ŒLt<br></li>
</ul>

<p>
ä¸èŠ‚ç‚¹äº²å’Œæ€§ä¸€æ ·ï¼Œå½“å‰æœ‰Podäº²å’Œæ€§/åäº²å’Œæ€§éƒ½æœ‰ä¸¤ç§ç±»å‹ï¼Œç§°ä¸ºrequiredDuringSchedulingIgnoredDuringExecutionå’Œ preferredDuringSchedulingIgnoredDuringExecutionï¼Œåˆ†åˆ«è¡¨ç¤ºâ€œç¡¬â€ä¸â€œè½¯â€è¦æ±‚ã€‚å¯¹äºç¡¬è¦æ±‚ï¼Œå¦‚æœä¸æ»¡è¶³åˆ™podä¼šä¸€ç›´å¤„äºPendingçŠ¶æ€ã€‚<br>
</p>

<p>
Podçš„äº²å’Œæ€§ä¸åäº²å’Œæ€§æ˜¯åŸºäºNodeèŠ‚ç‚¹ä¸Šå·²ç»è¿è¡Œpodçš„æ ‡ç­¾(è€Œä¸æ˜¯èŠ‚ç‚¹ä¸Šçš„æ ‡ç­¾)å†³å®šçš„ï¼Œä»è€Œçº¦æŸå“ªäº›èŠ‚ç‚¹é€‚åˆè°ƒåº¦ä½ çš„podã€‚<br>
</p>

<p>
è§„åˆ™çš„å½¢å¼æ˜¯ï¼šå¦‚æœXå·²ç»è¿è¡Œäº†ä¸€ä¸ªæˆ–å¤šä¸ªç¬¦åˆè§„åˆ™Yçš„podï¼Œåˆ™æ­¤podåº”è¯¥åœ¨Xä¸­è¿è¡Œ(å¦‚æœæ˜¯åäº²å’Œçš„æƒ…å†µä¸‹ï¼Œåˆ™ä¸åº”è¯¥åœ¨Xä¸­è¿è¡Œï¼‰ã€‚å½“ç„¶podå¿…é¡»å¤„åœ¨åŒä¸€åç§°ç©ºé—´ï¼Œä¸ç„¶äº²å’Œæ€§/åäº²å’Œæ€§æ— ä½œç”¨ã€‚ä»æ¦‚å¿µä¸Šè®²ï¼ŒXæ˜¯ä¸€ä¸ªæ‹“æ‰‘åŸŸã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨topologyKeyæ¥è¡¨ç¤ºå®ƒï¼ŒtopologyKey çš„å€¼æ˜¯nodeèŠ‚ç‚¹æ ‡ç­¾çš„é”®ä»¥ä¾¿ç³»ç»Ÿç”¨æ¥è¡¨ç¤ºè¿™æ ·çš„æ‹“æ‰‘åŸŸã€‚å½“ç„¶è¿™é‡Œä¹Ÿæœ‰ä¸ªéšè—æ¡ä»¶ï¼Œå°±æ˜¯nodeèŠ‚ç‚¹æ ‡ç­¾çš„é”®å€¼ç›¸åŒæ—¶ï¼Œæ‰æ˜¯åœ¨åŒä¸€æ‹“æ‰‘åŸŸä¸­ï¼›å¦‚æœåªæ˜¯èŠ‚ç‚¹æ ‡ç­¾åç›¸åŒï¼Œä½†æ˜¯å€¼ä¸åŒï¼Œé‚£ä¹ˆä¹Ÿä¸åœ¨åŒä¸€æ‹“æ‰‘åŸŸã€‚â˜…â˜…â˜…â˜…â˜…<br>
</p>

<p>
ä¹Ÿå°±æ˜¯è¯´ï¼šPodçš„äº²å’Œæ€§/åäº²å’Œæ€§è°ƒåº¦æ˜¯æ ¹æ®æ‹“æ‰‘åŸŸæ¥ç•Œå®šè°ƒåº¦çš„ï¼Œè€Œä¸æ˜¯æ ¹æ®nodeèŠ‚ç‚¹ã€‚â˜…â˜…â˜…â˜…â˜…<br>
</p>

<p>
æ³¨æ„äº‹é¡¹<br>
1ã€podä¹‹é—´äº²å’Œæ€§/åäº²å’Œæ€§éœ€è¦å¤§é‡çš„å¤„ç†ï¼Œè¿™ä¼šæ˜æ˜¾é™ä½å¤§å‹é›†ç¾¤ä¸­çš„è°ƒåº¦é€Ÿåº¦ã€‚ä¸å»ºè®®åœ¨å¤§äºå‡ ç™¾ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ä¸­ä½¿ç”¨å®ƒä»¬ã€‚<br>
</p>

<p>
2ã€Podåäº²å’Œæ€§è¦æ±‚å¯¹èŠ‚ç‚¹è¿›è¡Œä¸€è‡´çš„æ ‡è®°ã€‚æ¢å¥è¯è¯´ï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å¿…é¡»æœ‰ä¸€ä¸ªåŒ¹é…topologyKeyçš„é€‚å½“æ ‡ç­¾ã€‚å¦‚æœæŸäº›æˆ–æ‰€æœ‰èŠ‚ç‚¹ç¼ºå°‘æŒ‡å®šçš„topologyKeyæ ‡ç­¾ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ„å¤–è¡Œä¸ºã€‚<br>
</p>

<p>
requiredDuringSchedulingIgnoredDuringExecutionä¸­äº²å’Œæ€§çš„ä¸€ä¸ªç¤ºä¾‹æ˜¯â€œå°†æœåŠ¡Aå’ŒæœåŠ¡Bçš„Podæ”¾ç½®åœ¨åŒä¸€åŒºåŸŸã€æ‹“æ‰‘åŸŸã€‘ä¸­ï¼Œå› ä¸ºå®ƒä»¬ä¹‹é—´æœ‰å¾ˆå¤šäº¤æµâ€ï¼›preferredDuringSchedulingIgnoredDuringExecutionä¸­åäº²å’Œæ€§çš„ç¤ºä¾‹æ˜¯â€œå°†æ­¤æœåŠ¡çš„ pod è·¨åŒºåŸŸã€æ‹“æ‰‘åŸŸã€‘åˆ†å¸ƒâ€ã€æ­¤æ—¶ç¡¬æ€§è¦æ±‚æ˜¯è¯´ä¸é€šçš„ï¼Œå› ä¸ºä½ å¯èƒ½æ‹¥æœ‰çš„ pod æ•°å¤šäºåŒºåŸŸæ•°ã€‘ã€‚<br>
</p>

<p>
Podäº²å’Œæ€§/åäº²å’Œæ€§è¯­æ³•æ”¯æŒä»¥ä¸‹è¿ç®—ç¬¦ï¼šInï¼ŒNotInï¼ŒExistsï¼ŒDoesNotExistã€‚<br>
</p>

<p>
åŸåˆ™ä¸Šï¼ŒtopologyKeyå¯ä»¥æ˜¯ä»»ä½•åˆæ³•çš„æ ‡ç­¾é”®ã€‚ä½†æ˜¯ï¼Œå‡ºäºæ€§èƒ½å’Œå®‰å…¨æ–¹é¢çš„åŸå› ï¼ŒtopologyKeyæœ‰ä¸€äº›é™åˆ¶ï¼š<br>
</p>

<p>
1ã€å¯¹äºPodäº²å’Œæ€§ï¼Œåœ¨requiredDuringSchedulingIgnoredDuringExecutionå’ŒpreferredDuringSchedulingIgnoredDuringExecutionä¸­topologyKeyéƒ½ä¸å…è®¸ä¸ºç©ºã€‚<br>
</p>

<p>
2ã€å¯¹äºPodåäº²å’Œæ€§ï¼Œåœ¨requiredDuringSchedulingIgnoredDuringExecutionå’ŒpreferredDuringSchedulingIgnoredDuringExecutionä¸­topologyKeyä¹Ÿéƒ½ä¸å…è®¸ä¸ºç©ºã€‚<br>
</p>

<p>
3ã€å¯¹äºrequiredDuringSchedulingIgnoredDuringExecutionçš„podåäº²å’Œæ€§ï¼Œå¼•å…¥äº†å…è®¸æ§åˆ¶å™¨LimitPodHardAntiAffinityTopologyæ¥é™åˆ¶topologyKeyçš„kubernet.io/hostnameã€‚å¦‚æœä½ æƒ³è®©å®ƒå¯¹è‡ªå®šä¹‰æ‹“æ‰‘å¯ç”¨ï¼Œä½ å¯ä»¥ä¿®æ”¹è®¸å¯æ§åˆ¶å™¨ï¼Œæˆ–è€…å¹²è„†ç¦ç”¨å®ƒã€‚<br>
</p>

<p>
4ã€é™¤ä¸Šè¿°æƒ…å†µå¤–ï¼ŒtopologyKeyå¯ä»¥æ˜¯ä»»ä½•åˆæ³•çš„æ ‡ç­¾é”®ã€‚<br>
</p>

<p>
Pod é—´äº²å’Œé€šè¿‡ PodSpec ä¸­ affinity å­—æ®µä¸‹çš„ podAffinity å­—æ®µè¿›è¡ŒæŒ‡å®šã€‚è€Œ pod é—´åäº²å’Œé€šè¿‡ PodSpec ä¸­ affinity å­—æ®µä¸‹çš„ podAntiAffinity å­—æ®µè¿›è¡ŒæŒ‡å®šã€‚<br>
</p>

<p>
Podäº²å’Œæ€§/åäº²å’Œæ€§çš„requiredDuringSchedulingIgnoredDuringExecutionæ‰€å…³è”çš„matchExpressionsä¸‹æœ‰å¤šä¸ªkeyåˆ—è¡¨ï¼Œé‚£ä¹ˆåªæœ‰å½“æ‰€æœ‰keyæ»¡è¶³æ—¶ï¼Œæ‰èƒ½å°†podè°ƒåº¦åˆ°æŸä¸ªåŒºåŸŸã€é’ˆå¯¹Podç¡¬äº²å’Œã€‘ã€‚<br>
</p>

<p>
deployment ç¤ºä¾‹<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">spec:
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - podAffinityTerm:
          labelSelector:
            matchLabels:
              app: xx-1
          namespaces:
          - xx
          topologyKey: kubernetes.io/hostname
        weight: 1
</pre>
</div>
</div>
</div>
<div id="outline-container-org3289008" class="outline-4">
<h4 id="org3289008">èŒƒä¾‹</h4>
<div class="outline-text-4" id="text-org3289008">
</div>
<div id="outline-container-orga97f3eb" class="outline-5">
<h5 id="orga97f3eb">èŒƒä¾‹-å®ç°åŒä¸€ä¸ªåº”ç”¨åˆ†å¸ƒåœ¨ä¸åŒç¼©ä¸»æœº</h5>
<div class="outline-text-5" id="text-orga97f3eb">
<p>
å‡†å¤‡èŠ‚ç‚¹æ± <br>
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#26597;&#33410;&#28857;&#26159;&#21542;&#26377;&#27745;&#28857;</span>
kubectl  describe node |grep Taint
<span style="color: #b22222;"># </span><span style="color: #b22222;">kubectl taint node k8s-node01 ssd-  # &#21024;&#38500;&#27745;&#28857;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#33410;&#28857;&#28155;&#21152;&#26631;&#31614;&#65292;--overwrite&#35206;&#30422;&#24050;&#23384;&#22312;&#30340;&#26631;&#31614;&#20449;&#24687;</span>
kubectl label nodes k8s-node01 <span style="color: #a0522d;">type</span>=app-prod --overwrite
</pre>
</div>

<p>
pod åäº²å’Œ<br>
</p>
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: must-be-diff-nodes
  name: must-be-diff-nodes
  namespace: default
spec:
  replicas: 3
  selector:
    matchLabels:
      app: must-be-diff-nodes
  template:
    metadata:
      labels:
        app: must-be-diff-nodes
    spec:
      nodeSelector:
        type: app-prod
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - must-be-diff-nodes
            topologyKey: kubernetes.io/hostname
      containers:
      - image: nginx:1.15.12
        name: must-be-diff-nodes
        imagePullPolicy: IfNotPresent
</pre>
</div>

<p>
å¦‚æœé…ç½®æ¯ä¸ªé¡¹ç›®ä¸ç”¨çš„æ ‡ç­¾çš„æœåŠ¡åˆ›å»ºåˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œå¯ä»¥ä¸ºè¯¥é¡¹ç›®ä¸­æ‰€æœ‰æœåŠ¡æ·»åŠ ç»Ÿä¸€é¡¹ç›®æ ‡ç­¾ï¼š<br>
</p>

<div class="org-src-container">
<pre class="src src-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: must-be-diff-nodes
  name: must-be-diff-nodes
  namespace: default
spec:
  replicas: 3
  selector:
    matchLabels:
      app: must-be-diff-nodes
      project: multi
  template:
    metadata:
      labels:
        app: must-be-diff-nodes
        project: multi
    spec:
      nodeSelector:
        type: app-prod
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: project
                operator: In
                values:
                - multi
            topologyKey: kubernetes.io/hostname
      containers:
      - image: nginx:1.15.12
        name: must-be-diff-nodes
        imagePullPolicy: IfNotPresent
</pre>
</div>
</div>
</div>
<div id="outline-container-org602d5a8" class="outline-5">
<h5 id="org602d5a8">èŒƒä¾‹-åº”ç”¨å’Œç¼“å­˜å°½é‡éƒ¨ç½²åœ¨åŒä¸€ä¸ªåŸŸå†…</h5>
<div class="outline-text-5" id="text-org602d5a8">
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: web-store
  name: web-store
  namespace: default
spec:
  replicas: 3
  selector:
    matchLabels:
      app: web-store
  template:
    metadata:
      labels:
        app: web-store
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
            matchExpressions:
            - key: app
              operator: In
              values:
              - web-store
          # æ‹“æ‰‘åŸŸ  è‹¥å¤šä¸ªnodeèŠ‚ç‚¹å…·æœ‰ç›¸åŒçš„æ ‡ç­¾ä¿¡æ¯ã€æ ‡ç­¾é”®å€¼ç›¸åŒã€‘ï¼Œåˆ™è¡¨ç¤ºè¿™äº›nodeèŠ‚ç‚¹å°±åœ¨åŒä¸€æ‹“æ‰‘åŸŸ
          topologyKey: kubernetes.io/hostname
        podAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - store
              topologyKey: kubernetes.io/hostname
      containers:
      - image: nginx:1.15.12
        name: web-app
</pre>
</div>
</div>
</div>
<div id="outline-container-org681202b" class="outline-5">
<h5 id="org681202b">èŒƒä¾‹-å°½é‡è°ƒåº¦åˆ°é«˜é…ç½®æœåŠ¡å™¨</h5>
<div class="outline-text-5" id="text-org681202b">
<p>
ä¸å ç”¨ GPU èµ„æºï¼Œåªå  SSD  èµ„æºã€‚<br>
</p>

<p>
ç»™nodeèŠ‚ç‚¹æ‰“labelæ ‡ç­¾ï¼š<br>
</p>

<div class="org-src-container">
<pre class="src src-shell">kubectl label nodes k8s-node01 <span style="color: #a0522d;">ssd</span>=true
kubectl label nodes k8s-master01 <span style="color: #a0522d;">sshd</span>=true 
kubectl label nodes k8s-master01 <span style="color: #a0522d;">gpu</span>=true
kubectl label nodes k8s-node02 <span style="color: #a0522d;">type</span>=physical
</pre>
</div>

<p>
nodeèŠ‚ç‚¹äº²å’Œï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: prefer-ssd
  name: prefer-ssd
  namespace: default
spec:
  replicas: 3
  selector:
    matchLabels:
      app: prefer-ssd
  template:
    metadata:
      labels:
        app: prefer-ssd
    spec:
      nodeSelector:
        type: prefer-ssd
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: ssd
                operator: In
                values:
                - true
              - key: gpu
                operator: NotIn
                values:
                - true
          - weight: 10
            preference:
              matchExpressions:
              - key: type
                operator: In
                values:
                - physical
      containers:
      - image: nginx:1.15.12
        name: prefer-ssd
        imagePullPolicy: IfNotPresent
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orgf0e84ee" class="outline-3">
<h3 id="orgf0e84ee">Topology æ‹“æ‰‘åŸŸ</h3>
<div class="outline-text-3" id="text-orgf0e84ee">
</div>
<div id="outline-container-orgda0f174" class="outline-4">
<h4 id="orgda0f174">Topologyæ‹“æ‰‘åŸŸçš„é‡è¦æ€§</h4>
<div class="outline-text-4" id="text-orgda0f174">
<p>
topologyKeyï¼šæ‹“æ‰‘åŸŸï¼Œä¸»è¦é’ˆå¯¹å®¿ä¸»æœºï¼Œç›¸å½“äºå¯¹å®¿ä¸»æœºè¿›è¡ŒåŒºåŸŸçš„åˆ’åˆ†ã€‚ç”¨labelè¿›è¡Œåˆ¤æ–­ï¼Œ <b>ä¸åŒçš„keyå’Œä¸åŒçš„valueæ˜¯å±äºä¸åŒçš„æ‹“æ‰‘åŸŸ</b> ã€‚<br>
<img src="./images/Snipaste_2022-09-27_14-32-18.png" alt="Snipaste_2022-09-27_14-32-18.png"><br>
</p>
<ul class="org-ul">
<li>æ‹“æ‰‘åŸŸ Aï¼škubernetes.io/hostname=k8s-master01<br></li>
<li>æ‹“æ‰‘åŸŸ Bï¼škubernetes.io/hostname=k8s-master02<br></li>
<li>æ‹“æ‰‘åŸŸ Cï¼škubernetes.io/hostname=k8s-master03<br></li>
<li>æ‹“æ‰‘åŸŸ Dï¼škubernetes.io/hostname=k8s-node01<br></li>
<li>æ‹“æ‰‘åŸŸ Xï¼škubernetes.io/hostname=xxx<br></li>
</ul>

<p>
node èŠ‚ç‚¹ä¼šè‡ªåŠ¨æ‰“ä¸Šæ ‡ç­¾ <code>kubernetes.io/hostname: xxx</code> ï¼Œå¯ä»¥çœ‹å‡ºæ¯ä¸ªç¼©ä¸»æœºæ˜¯ä¸€ä¸ªåŸŸã€‚<br>
</p>

<p>
è¿™é‡Œçš„ topologyKey å¯¹åº”çš„æ˜¯ Node ä¸Šçš„æ ‡ç­¾çš„ Keyï¼ˆæ²¡æœ‰Valueï¼‰ï¼Œå¯ä»¥çœ‹å‡ºï¼Œå…¶å® topologyKey å°±æ˜¯ç”¨äºç­›é€‰ Node çš„ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†å„ä¸ª Pod è¿›è¡Œè·¨é›†ç¾¤ã€è·¨æœºæˆ¿ã€è·¨åœ°åŒºçš„è°ƒåº¦äº†ã€‚<br>
</p>

<p>
æŠŠ node èŠ‚ç‚¹çš„æ¯ä¸ªåŒºåˆ’åˆ†æˆä¸€ä¸ªåŸŸï¼š<br>
<img src="./images/Snipaste_2022-09-27_14-37-12.png" alt="Snipaste_2022-09-27_14-37-12.png"><br>
</p>
<ul class="org-ul">
<li>å¤§å…´åŒºï¼šk8s-master01  region=daxing<br></li>
<li>å¤§å…´åŒºï¼šk8s-master02  region=daxing<br></li>
<li>æœé˜³åŒºï¼šk8s-master03  region=chaoyang<br></li>
<li>æœé˜³åŒºï¼šk8s-node01    region=chaoyang<br></li>
<li>XX åŒºï¼šxxx  region=xxx<br></li>
</ul>

<p>
é’ˆå¯¹æŸä¸ªåŒºåˆ’åˆ†ä¸åŒæœºæˆ¿ã€æœºæŸœï¼š<br>
<img src="./images/Snipaste_2022-09-27_14-40-02.png" alt="Snipaste_2022-09-27_14-40-02.png"><br>
</p>
<ul class="org-ul">
<li>å¤§å…´åŒº<br>
<ul class="org-ul">
<li>æœºæˆ¿ 1<br>
<ul class="org-ul">
<li>æœºæŸœ 1<br></li>
<li>æœºæŸœ 2<br></li>
</ul></li>
<li>æœºæˆ¿ 2<br>
<ul class="org-ul">
<li>æœºæŸœ 1<br></li>
<li>æœºæŸœ 2<br></li>
</ul></li>
<li>æœºæˆ¿ x<br>
<ul class="org-ul">
<li>æœºæŸœ x<br></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org98bf9dd" class="outline-4">
<h4 id="org98bf9dd">å¦‚ä½•ä½¿ç”¨topologyKey</h4>
<div class="outline-text-4" id="text-org98bf9dd">
</div>
<div id="outline-container-orga2390df" class="outline-5">
<h5 id="orga2390df">åŒä¸€ä¸ªåº”ç”¨å¤šåŒºåŸŸéƒ¨ç½²</h5>
<div class="outline-text-5" id="text-orga2390df">
<p>
ç»™èŠ‚ç‚¹æ‰“æ ‡ç­¾ï¼Œåˆ’åˆ† 3 ä¸ªåŸŸï¼š<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl label node k8s-master01 k8s-master02 <span style="color: #a0522d;">region</span>=daxing
kubectl label node k8s-master03 k8s-node01 <span style="color: #a0522d;">region</span>=chaoyang
kubectl label node k8s-node02 <span style="color: #a0522d;">region</span>=xxx
</pre>
</div>

<p>
pod åäº²å’Œ<br>
</p>
<div class="org-src-container">
<pre class="src src-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: must-be-diff-zone
  name: must-be-diff-zone
  namespace: default
spec:
  replicas: 3
  selector:
    matchLabels:
      app: must-be-diff-zone
      project: multi
  template:
    metadata:
      labels:
        app: must-be-diff-zone
        project: multi
    spec:
      nodeSelector:
        type: app-prod
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
            matchExpressions:
            - key: app
              operator: In
              values:
              - must-be-diff-zone
          topologyKey: region
      containers:
      - image: nginx:1.15.12
        name: must-be-diff-zone
        imagePullPolicy: IfNotPresent
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">apiVersion: v1
kind: Pod
metadata:
  name: with-pod-affinity
spec:
  affinity:
    podAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
          - key: security
            operator: In
            values:
            - S1
        topologyKey: failure-domain.beta.kubernetes.io/zone
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: security
              operator: In
              values:
              - S2
          topologyKey: kubernetes.io/hostname
  containers:
  - name: with-pod-affinity
    image: k8s.gcr.io/pause:2.0
</pre>
</div>

<p>
è¿™é‡Œ Pod çš„äº²å’Œæ€§è§„åˆ™æ˜¯ï¼šè¿™ä¸ª Pod è¦è°ƒåº¦åˆ°çš„ Node å¿…é¡»æœ‰ä¸€ä¸ªæ ‡ç­¾ä¸º security: S1 çš„ Podï¼Œä¸”è¯¥ Node å¿…é¡»æœ‰ä¸€ä¸ª Key ä¸º failure-domain.beta.kubernetes.io/zone çš„ æ ‡ç­¾ï¼Œå³ Node å¿…é¡»å±äº failure-domain.beta.kubernetes.io/zone æ‹“æ‰‘åŸŸã€‚<br>
</p>

<p>
Pod çš„åäº²å’Œæ€§è§„åˆ™æ˜¯ï¼šè¿™ä¸ª Pod å°½é‡ä¸è¦è°ƒåº¦åˆ°è¿™æ ·çš„ Nodeï¼Œå…¶åŒ…å«ä¸€ä¸ª Key ä¸º kubernetes.io/hostname çš„æ ‡ç­¾ï¼Œä¸”è¯¥ Node ä¸Šæœ‰æ ‡ç­¾ä¸º security: S2 çš„ Podã€‚<br>
</p>
</div>
</div>
</div>
<div id="outline-container-orga591352" class="outline-4">
<h4 id="orga591352">æ³¨æ„äº‹é¡¹</h4>
<div class="outline-text-4" id="text-orga591352">
<p>
åŸåˆ™ä¸Šï¼ŒtopologyKey å¯ä»¥æ˜¯ä»»ä½•åˆæ³•çš„æ ‡ç­¾ Keyã€‚ä½†æ˜¯å‡ºäºæ€§èƒ½å’Œå®‰å…¨åŸå› ï¼Œå¯¹ topologyKey æœ‰ä¸€äº›é™åˆ¶ï¼š<br>
</p>

<ul class="org-ul">
<li>å¯¹äºäº²å’Œæ€§å’Œ requiredDuringSchedulingIgnoredDuringExecution çš„ Pod åäº²å’Œæ€§ï¼ŒtopologyKey ä¸èƒ½ä¸ºç©ºã€‚<br></li>
<li>å¯¹äº requiredDuringSchedulingIgnoredDuringExecution çš„ Pod åäº²å’Œæ€§ï¼Œå¼•å…¥ LimitPodHardAntiAffinityTopology å‡†å…¥æ§åˆ¶å™¨æ¥é™åˆ¶ topologyKey åªèƒ½æ˜¯ kubernetes.io/hostnameã€‚å¦‚æœè¦ä½¿ç”¨è‡ªå®šä¹‰æ‹“æ‰‘åŸŸï¼Œåˆ™å¯ä»¥ä¿®æ”¹å‡†å…¥æ§åˆ¶å™¨ï¼Œæˆ–è€…ç›´æ¥ç¦ç”¨å®ƒã€‚<br></li>
<li>å¯¹äº preferredDuringSchedulingIgnoredDuringExecution çš„ Pod åäº²å’Œæ€§ï¼Œç©ºçš„ topologyKey è¡¨ç¤ºæ‰€æœ‰æ‹“æ‰‘åŸŸã€‚æˆªæ­¢ v1.12 ç‰ˆæœ¬ï¼Œæ‰€æœ‰æ‹“æ‰‘åŸŸè¿˜åªèƒ½æ˜¯ kubernetes.io/hostnameã€failure-domain.beta.kubernetes.io/zone å’Œ failure-domain.beta.kubernetes.io/region çš„ç»„åˆã€‚<br></li>
<li>é™¤ä¸Šè¿°æƒ…å†µå¤–ï¼ŒtopologyKey å¯ä»¥æ˜¯ä»»ä½•åˆæ³•çš„æ ‡ç­¾ keyã€‚<br></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org3130246" class="outline-3">
<h3 id="org3130246">å¼¹æ€§ä¼¸ç¼©æ–¹æ¡ˆ</h3>
<div class="outline-text-3" id="text-org3130246">
<p>
å¼¹æ€§ä¼¸ç¼©æ–¹æ¡ˆ <a href="https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/auto-scaling-overview?spm=a2c4g.11186623.0.0.49b3470cC3BcmA">https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/auto-scaling-overview?spm=a2c4g.11186623.0.0.49b3470cC3BcmA</a><br>
</p>
</div>
<div id="outline-container-orga908c91" class="outline-4">
<h4 id="orga908c91">è™šæ‹ŸèŠ‚ç‚¹</h4>
<div class="outline-text-4" id="text-orga908c91">
<p>
<a href="https://virtual-kubelet.io/">https://virtual-kubelet.io/</a>  è™šæ‹ŸèŠ‚ç‚¹å¯¹åº”  é˜¿é‡Œ eciã€AWS  fargate<br>
</p>


<p>
<b>ECI</b><br>
</p>

<p>
å®‰è£…ç»„ä»¶åï¼Œpodé…ç½®æ±¡ç‚¹å®¹å¿å’ŒèŠ‚ç‚¹äº²å’Œ<br>
</p>

<p>
<a href="https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/spread-eci-based-pods-across-zones-and-configure-affinities-1?spm=a2c4g.11186623.0.0.636557bcM57Ck7">é˜¿é‡Œeci pod äº²å’Œè°ƒåº¦</a><br>
</p>

<div class="org-src-container">
<pre class="src src-sh">nodeAffinity:
  preferredDuringSchedulingIgnoredDuringExecution:
  - weight: 1
    preference:
      matchExpressions:
      - key: type
        operator: NotIn
        values:
        - virtual-kubelet

tolerations:
  - key: <span style="color: #8b2252;">"virtual-kubelet.io/provider"</span>
    operator: <span style="color: #8b2252;">"Exists"</span>
    effect: <span style="color: #8b2252;">"NoSchedule"</span>
</pre>
</div>

<p>
<b>EKS Fargate</b><br>
</p>

<p>
<a href="https://blog.bitipcman.com/eks-fargate-101/">https://blog.bitipcman.com/eks-fargate-101/</a><br>
</p>

<ul class="org-ul">
<li>åç§°ç©ºé—´<br></li>
<li>åç§°ç©ºé—´+podæ ‡ç­¾<br></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org8cc65fa" class="outline-3">
<h3 id="org8cc65fa">å‚è€ƒ</h3>
<div class="outline-text-3" id="text-org8cc65fa">
</div>
<div id="outline-container-orgdccb66d" class="outline-4">
<h4 id="orgdccb66d">Pod æ‹“æ‰‘åˆ†å¸ƒçº¦æŸ</h4>
<div class="outline-text-4" id="text-orgdccb66d">
</div>
<div id="outline-container-org5900cbd" class="outline-5">
<h5 id="org5900cbd">aws on-demand ä¸ spot å®ä¾‹æ··éƒ¨</h5>
<div class="outline-text-5" id="text-org5900cbd">
<p>
ç›®çš„ï¼špod æœ‰ 4 ä¸ªå‰¯æœ¬ï¼Œä¸€åŠå‰¯æœ¬åœ¨ spot ä¸­ã€‚<br>
</p>


<p>
æ€»ç»“ï¼š<br>
</p>
<ol class="org-ol">
<li>ç‰¹å®šæœºå™¨<br>
<ul class="org-ul">
<li>ä¸å»ºè®®åœ¨åŒä¸€ä¸ªç»„ä¸­åŒæ—¶ spot ,on-demandï¼Œåœ¨è°ƒåº¦å’Œæ‰©å®¹ä¸Šä¼šæœ‰é—®é¢˜ï¼Œè¦æ‹†æˆ2ä¸ªç»„ on-demand å’Œ spot ç»„ï¼Œæ‰“åŒä¸€ä¸ªä¸šåŠ¡æ ‡ç­¾,å¦‚ type: growth<br></li>
<li>spot ä¸è¶³æ—¶ï¼Œæ¨èåœ¨æ‹“æ‰‘åˆ†å¸ƒçº¦æŸä¸­ä½¿ç”¨ <code>whenUnsatisfiable: ScheduleAnyway</code> <br></li>
</ul></li>

<li>å¹³å‡åˆ†é…<br>
<ul class="org-ul">
<li>Pod æ‹“æ‰‘åˆ†å¸ƒçº¦æŸ [1]: ä½ å¯ä»¥ä½¿ç”¨ æ‹“æ‰‘åˆ†å¸ƒçº¦æŸï¼ˆTopology Spread Constraintsï¼‰ æ¥æ§åˆ¶ Pod åœ¨é›†ç¾¤å†…æ•…éšœåŸŸä¹‹é—´çš„åˆ†å¸ƒï¼Œ ä¾‹å¦‚åŒºåŸŸï¼ˆRegionï¼‰ã€å¯ç”¨åŒºï¼ˆZoneï¼‰ã€èŠ‚ç‚¹å’Œå…¶ä»–ç”¨æˆ·è‡ªå®šä¹‰æ‹“æ‰‘åŸŸã€‚ è¿™æ ·åšæœ‰åŠ©äºå®ç°é«˜å¯ç”¨å¹¶æå‡èµ„æºåˆ©ç”¨ç‡<br></li>
<li>èŠ‚ç‚¹äº²å’Œæ€§ (NodeAffinity) [2]: é€šè¿‡èŠ‚ç‚¹äº²å’Œæ€§æ¥çº¦æŸ Pod åªèƒ½è¢«éƒ¨ç½²åœ¨å…·æœ‰ç‰¹å®šæ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šã€‚<br></li>
</ul></li>
</ol>

<div class="org-src-container">
<pre class="src src-yaml">spec:
  topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: eks.amazonaws.com/capacityType
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        &lt;pod label&gt;
  affinity:
    nodeaffinity:
      requiredduringschedulingignoredduringexecution:
        nodeselectorterms:
        - matchexpressions:
          - key: zone
            operator: notin
            values:
            - zonec
</pre>
</div>

<p>
å‚æ•°ï¼š<br>
</p>
<ul class="org-ul">
<li>topologyKeyï¼šæ˜¯èŠ‚ç‚¹æ ‡ç­¾çš„é”®ã€‚æ ¹æ®èŠ‚ç‚¹æ ‡ç­¾ <code>eks.amazonaws.com/capacityType</code> æ¥åšæ‹“æ‰‘åˆ†å¸ƒçº¦æŸï¼Œon-demand å®ä¾‹æ ‡ç­¾ <code>eks.amazonaws.com/capacityType=ON_DEMAND</code> ï¼ŒSpot å®ä¾‹æ ‡ç­¾ <code>eks.amazonaws.com/capacityType=SPOT</code><br></li>

<li>whenUnsatisfiableï¼šæŒ‡ç¤ºå¦‚æœ Pod ä¸æ»¡è¶³åˆ†å¸ƒçº¦æŸæ—¶å¦‚ä½•å¤„ç†ã€‚<br>
<ul class="org-ul">
<li>è®¾å®šä¸º <code>whenUnsatisfiable: DoNotSchedule</code> ï¼Œè¿™æ„å‘³ç€å½“æˆ‘ç¬¬ä¸€ä¸ª Pod éƒ¨ç½²åˆ° On-demand ä¸Šåï¼Œç¬¬äºŒä¸ª Pod ä¸€å®šåªèƒ½éƒ¨ç½²åœ¨ Spot ä¸Šã€‚å¦‚æœæ— æ³•æ»¡è¶³ï¼Œåˆ™ Pod ä¼šå¤„äº Pending çŠ¶æ€æ— æ³•éƒ¨ç½²ï¼Œæ¨èä½¿ç”¨ <code>whenUnsatisfiable: ScheduleAnyway</code><br></li>
<li>ScheduleAnyway çš„åšæ³•ä»ç„¶ä¿æœ‰å¼¹æ€§ç©ºé—´ã€‚æ³¨æ„ï¼šå·²ç»éƒ¨ç½²çš„ Pod ä¸ä¼šé‡æ–°éƒ¨ç½²ï¼Œåç»­çš„éƒ¨ç½²ä¼šå°è¯•æ¢å¤è¿™ä¸ªå¹³è¡¡ã€‚<br>
<ul class="org-ul">
<li>è¦ä¸åœç›‘æ§æ˜¯å¦æœ‰ spot å®ä¾‹æ¥é‡æ–°éƒ¨ç½² pod å—ï¼Ÿç›®å‰è¿˜æ˜¯éœ€è¦ä¾é å¤–éƒ¨çš„ç›‘æ§æˆ–æ˜¯ä»£ç æ¥å®ç°è‡ªåŠ¨åŒ–çš„é‡éƒ¨ç½²<br></li>
</ul></li>
</ul></li>

<li>maxSkewï¼šæè¿°è¿™äº› Pod å¯èƒ½è¢«å‡åŒ€åˆ†å¸ƒçš„ç¨‹åº¦ã€‚å¯ä»¥æŠŠæ­¤å‚æ•°æƒ³åƒä¸ºæœ€å¤§å¯å…è®¸çš„å·®å¼‚å€¼ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœ MaxSkew è®¾å®šä¸º 1ï¼Œåˆ™è¡¨ç¤ºä¸¤ä¸ªåŒºåŸŸæˆ–æ˜¯æ ‡ç­¾ä¹‹é—´çš„ Pod æ•°é‡å·®å¼‚ä¸èƒ½å¤§äº 1ã€‚æ‚¨å¯ä»¥å‚è€ƒæ­¤æ–‡æ¡£æ¥äº†è§£è¯¦ç»†çš„å‚æ•°å®šä¹‰ [3]ã€‚<br></li>
</ul>

<p>
æ³¨æ„ï¼šSpot å®ä¾‹æœ‰å¯èƒ½å› ä¸ºä»»ä½•ç†ç”±è¢«å›æ”¶ï¼Œé™¤äº†ä»·æ ¼ä¹‹å¤–ï¼Œè¿˜æœ‰åŒºåŸŸå®¹é‡ç©ºé—´çš„é—®é¢˜ã€‚åœ¨ä½¿ç”¨ Spot ä¸Šï¼Œæ‚¨è€ƒè™‘çš„ä¸åº”è¯¥æ˜¯æ€æ ·ä¸ä¼šè¢«å›æ”¶ï¼Œè€Œæ˜¯è€ƒè™‘æˆ‘çš„åº”ç”¨èƒ½ä¸èƒ½å¤„ä¾‹è¢«å›æ”¶çš„åœºæ™¯<br>
</p>


<p>
[1] Pod æ‹“æ‰‘åˆ†å¸ƒçº¦æŸ - <a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/topology-spread-constraints/">https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/topology-spread-constraints/</a> <br>
[2] èŠ‚ç‚¹äº²å’Œæ€§ - <a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#node-affinity">https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/assign-pod-node/#node-affinity</a> <br>
[3] maxSkew å‚æ•°å®šä¹‰ï¼š<a href="https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/#spread-constraint-definition">https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/#spread-constraint-definition</a><br>
</p>


<p>
ç»“è®ºï¼š1. è®¾ç½® pod çº¦æŸå¯ä¿éšœæœåŠ¡å¯ç”¨æ€§ã€‚2. pod çº¦æŸæ¡ä»¶åªåœ¨æœåŠ¡å‘å¸ƒæ—¶ç”Ÿæ•ˆï¼Œå¯¹äºè¿å pod çº¦æŸæ¡ä»¶çš„æœåŠ¡éœ€è¦é‡æ–°è°ƒåº¦ï¼Œè¿™é‡Œä½¿ç”¨ Deschedulerï¼Œå‚è€ƒå®˜æ–¹å»ºè®®[1]<br>
</p>

<p>
[1] å·²çŸ¥å±€é™æ€§ <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/#known-limitations">Pod Topology Spread Constraints</a><br>
</p>
</div>
<ul class="org-ul">
<li><a id="orgef78dcd"></a>Descheduler pod é©±é€<br>
<div class="outline-text-6" id="text-orgef78dcd">
<p>
å®‰è£… Descheduler ï¼š<br>
</p>

<div class="org-src-container">
<pre class="src src-sh">git clone -b release-1.21  https://github.com/kubernetes-sigs/descheduler.git
<span style="color: #483d8b;">cd</span> descheduler/
kubectl create -f kubernetes/base/rbac.yaml
kubectl create -f kubernetes/base/configmap.yaml
kubectl create -f kubernetes/deployment/deployment.yaml

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20854;&#20013;&#20462;&#25913;&#20869;&#23481;</span>
$ cat kubernetes/base/configmap.yaml
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: descheduler-policy-configmap
  namespace: kube-system
data:
  policy.yaml: |
    apiVersion: <span style="color: #8b2252;">"descheduler/v1alpha1"</span>
    kind: <span style="color: #8b2252;">"DeschedulerPolicy"</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">nodeSelector: eks.amazonaws.com/capacityType=ON_DEMAND # &#36890;&#36807;&#22312;PodSpec&#20013;&#23450;&#20041;&#23427;&#65292;&#36873;&#25321;node&#26631;&#31614;&#20013;&#21253;&#21547;&#27599;&#20010;&#38190;&#20540;&#23545;&#30340;&#23545;&#24212;&#30340;&#33410;&#28857;</span>
    evictLocalStoragePods: true
    maxNoOfPodsToEvictPerNode: 40
    strategies:
      <span style="color: #8b2252;">"PodLifeTime"</span>:
        enabled: true
        params:
          podLifeTime:
            maxPodLifeTimeSeconds: 86400
            podStatusPhases:
            - <span style="color: #8b2252;">"Pending"</span>
          namespaces:
            include:
            - <span style="color: #8b2252;">"staging-taskcenter"</span>
            - <span style="color: #8b2252;">"dev-taskcenter"</span>
      <span style="color: #8b2252;">"RemovePodsViolatingTopologySpreadConstraint"</span>: <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24320;&#21551; pod &#36719;&#32422;&#26463;&#39537;&#36880;</span>
        enabled: true
        params:
          nodeFit: true
          includeSoftConstraints: true
          namespaces:
            include:
            - <span style="color: #8b2252;">"staging-taskcenter"</span>
            - <span style="color: #8b2252;">"dev-taskcenter"</span>
          labelSelector: <span style="color: #b22222;"># </span><span style="color: #b22222;">podSpec &#20013;&#23450;&#20041;&#30340;&#26631;&#31614;</span>
            matchExpressions:
              - {key: app, operator: In, values: [job,web]}

$ cat kubernetes/deployment/deployment.yaml
      containers:
        - name: descheduler
          image: k8s.gcr.io/descheduler/descheduler:v0.21.0
          imagePullPolicy: IfNotPresent
          <span style="color: #483d8b;">command</span>:
            - <span style="color: #8b2252;">"/bin/descheduler"</span>
          args:
            - --policy-config-file
            - /policy-dir/policy.yaml
            - --descheduling-interval
            - 5m  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#26597;&#39057;&#29575;</span>
            - --v
            - 3
            - --log-dir
            - /tmp
            - --log-file
            - descheduler.log
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</section>
</main class="container">
<footer id="postamble" class="status">
<footer data-astro-cid-sz7xmlte data-turbo-permanent id=rootFooter>
    <script>
        const shuffle = e => e.map((e => ({
            v: e,
            sort: Math.random()
        }))).sort(( (e, o) => e.sort - o.sort)).map(( ({v: e}) => e));
        var songList = ["barbie-girl--stantough", "blue-da-ba-dee--cornelius-link", "hips-dont-lie--stantough", "i-want-it-that-way--stantough", "seven-nation-army--stantough", "smooth-criminal--stantough"]
          , songOrder = songOrder ?? shuffle(songList).map((e => `/audio/music/${e}.opus`))
          , song = new Audio(songOrder[0])
          , nextSong = new Audio(songOrder[1])
          , songIndex = 2
          , musicWrapper = void 0
          , arrow = void 0
          , notes = void 0;
        song.addEventListener("ended", next);
        const toggle = () => song.paused ? play() : pause();
        function play() {
            song.play(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.add("shakeManHorse"),
            notes.classList.remove("hideNotes")
        }
        function pause() {
            song.pause(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.remove("shakeManHorse"),
            notes.classList.add("hideNotes")
        }
        function next() {
            song = nextSong,
            play(),
            songIndex === songOrder.length && (songIndex = 0),
            nextSong = new Audio(songOrder[songIndex]),
            songIndex += 1
        }
        function skip() {
            pause(),
            (arrow = arrow || document.getElementById("musicArrow")).classList.add("shootArrow");
            new Audio("/audio/effects/ohno.m4a").play(),
            arrow.addEventListener("animationend", arrowShootHandler, !1)
        }
        function arrowShootHandler() {
            arrow.removeEventListener("animationend", arrowShootHandler, !1),
            arrow.classList.remove("shootArrow");
            new Audio("/audio/effects/heythathurt.m4a").play(),
            next()
        }
    </script>
    <div id=musicPlayer data-astro-cid-q7a5pyro>
        <button class=skip data-astro-cid-q7a5pyro onclick=skip() title="Skip song">
            <div id=skipWrapper data-astro-cid-q7a5pyro>
                <img alt="Medieval drollery of a man/snail/bat/monkey shooting an arrow" class=archer decoding=async height=334 loading=lazy src=/images/archer-no-arrow.448ccd8b_Z1KfRYq.webp width=226 data-astro-cid-q7a5pyro>
                <img alt="Arrow for archer" class="arrow complete" decoding=async height=23 loading=lazy src=/images/no-archer-full-arrow.87aa9971_Z2qL2KO.webp width=141 data-astro-cid-q7a5pyro id=musicArrow>
            </div>
        </button>
        <button class=playPause data-astro-cid-q7a5pyro onclick=toggle() title="Play/pause song">
            <div id=musicWrapper data-astro-cid-q7a5pyro>
                <div class=hideNotes id=notesWrapper data-astro-cid-q7a5pyro>
                    <div class=lyreNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                    <div class=fluteNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                </div>
                <img alt="Medieval drollery of a man/horse playing a lyre and a horn" class=manHorse decoding=async height=665 loading=lazy src=/images/man-horse-band.e3a2efcf_q8FCa.webp width=531 data-astro-cid-q7a5pyro>
            </div>
        </button>
    </div>
    <hr data-astro-cid-sz7xmlte>
    <div class=salutation data-astro-cid-gdmrbrho>
        <p data-astro-cid-gdmrbrho>
            <span class=flower2 data-astro-cid-gdmrbrho>A</span>
            <span class=smallcap data-astro-cid-gdmrbrho>pax vobiscum</span>
            <span class="flower2 wiggle" data-astro-cid-gdmrbrho id=leaf>a</span>
        </p>
    </div>
    <script>
        function animateLeafBlownHandler() {
            leaf.removeEventListener("animationend", animateLeafBlownHandler, !1),
            leaf.classList.remove("blownAway"),
            leaf.classList.add("wiggle")
        }
        function animateLeaf() {
            leaf = leaf ?? document.getElementById("leaf"),
            leaf.classList.remove("wiggle"),
            leaf.classList.add("blownAway"),
            leaf.addEventListener("animationend", animateLeafBlownHandler, !1)
        }
        document.getElementById("leaf").onclick = animateLeaf
    </script>


    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>æ‰“èµ</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Â© 2024 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
</footer>
</footer>
</body>
</html>
