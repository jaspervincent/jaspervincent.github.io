<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kubernetes: k8s DevOps篇-CICD</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/font.css"/>
<link rel="stylesheet" type="text/css" href="/static/drollery.e825b870.css"/>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<header id="preamble" class="status">
<header class="{className}" data-astro-cid-3ef6ksr2>
  <div class=header-branding data-astro-cid-g2lrb5xm>
      <span class=header-text data-astro-cid-g2lrb5xm>
          <span class=dropcap data-astro-cid-g2lrb5xm aria-hidden=true>
              <span class=actual data-astro-cid-g2lrb5xm>J</span>
              <span class=rest data-astro-cid-g2lrb5xm>asper Hsu</span>
              <span class=period data-astro-cid-g2lrb5xm>.</span>
          </span>
          <span class=sr-only data-astro-cid-g2lrb5xm>Drollery</span>
      </span>
      <img alt="Medieval drollery of a knight on a horse" class=spring decoding=async height=250 loading=lazy src=/images/knight-horse.a96eee7d_Z1WCOYs.webp width=68 data-astro-cid-g2lrb5xm>
  </div>

  <nav data-astro-cid-pux6a34n>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/jcodelog.html class=nobracket data-astro-cid-pux6a34n>技术</a>
      <span class=flower2 data-astro-cid-pux6a34n>K</span>
      <a href=/reading/index.html class=nobracket data-astro-cid-pux6a34n>阅读</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
      <a href=/archives.html class=nobracket data-astro-cid-pux6a34n>归档</a>
      <span class=flower2 data-astro-cid-pux6a34n>L</span>
      <a href=/link/index.html class=nobracket data-astro-cid-pux6a34n>友链</a>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/about.html class=nobracket data-astro-cid-pux6a34n>关于</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
  </nav>


  <div class="container" data-astro-cid-3ef6ksr2>
    <p class="info" data-astro-cid-3ef6ksr2>
              🏆 欢迎来到本站：
              <a href="https://xuchangwei.com/">https://xuchangwei.com/</a>。
              <strong>希望这里有你感兴趣的内容</strong>。
            </p>
  </div>
  <div id=borderArtWrapper class="tt1" data-astro-cid-5hce7sga data-turbo-permanent>
      <script>
          var man, shakeCount = 0, noSound = new Audio("/audio/effects/no.m4a"), screamSound = new Audio("/audio/effects/scream.m4a");
          function animateManShakeHandler() {
              man.removeEventListener("animationend", animateManShakeHandler, !1),
              shakeCount += 1,
              man.classList.remove("shakeMan")
          }
          function animateManFallHandler() {
              man.removeEventListener("animationend", animateManFallHandler, !1),
              man.classList.add("hide")
          }
          function animateMan() {
              man = man ?? document.getElementById("borderMan"),
              3 === shakeCount ? (man.classList.add("fallMan"),
              screamSound.play(),
              man.addEventListener("animationend", animateManFallHandler, !1)) : (man.classList.add("shakeMan"),
              noSound.play(),
              man.addEventListener("animationend", animateManShakeHandler, !1))
          }
      </script>
      <div class=borderArt data-astro-cid-5dda5nwp id=articleBorder>
          <img alt="flowery border with man falling" decoding=async height=620 loading=lazy src=/images/border-vines-no-man.b7d246cc_DRxSe.webp width=909 class=border data-astro-cid-5dda5nwp>
          <div class=fallWrapper data-astro-cid-5dda5nwp>
              <img alt="flowery border with man falling" decoding=async height=292 loading=lazy src=/images/man-no-vines.247a3187_Z2ioXNM.webp width=98 class=man data-astro-cid-5dda5nwp id=borderMan onclick=animateMan()>
          </div>
      </div>
  </div>
</header>
</header>
<main class="container" id="content" class="content">
<header>
<h1 class="title">Kubernetes: k8s DevOps篇-CICD</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:3591ec0f-493e-4b6e-9435-0f03ef8a1ae2">DevOps篇-CICD</a>
<ul>
<li><a href="#h:c7557273-1850-42d4-8f5e-b55036e8235c">什么是 DevOps 和 CICD</a>
<ul>
<li><a href="#h:37100d87-d38a-4fb2-bf98-924a99d35c38">DevOps 简介</a>
<ul>
<li><a href="#h:9a2a24c0-757f-44fd-8abc-9123174d11f4">什么是 DevOps</a></li>
<li><a href="#h:d3c23be4-e7ca-4f02-b45f-d5b197aff244">为什么要推广 DevOps</a></li>
</ul>
</li>
<li><a href="#h:d19b860e-46f4-4322-ac77-58c65aefa044">CICD 概念</a>
<ul>
<li><a href="#h:89244fba-c7c3-4a47-b4a1-1276c7c7e18d">持续集成（CI：Continuous Integration）</a></li>
<li><a href="#h:a95ebf40-fff0-40ad-9b60-114d60a87f39">持续交付（CD：Continuous Delivery）</a></li>
<li><a href="#h:c3cf0da1-b0aa-4f54-8bbf-14a2c1feecf0">持续部署(CD-continuous deployment)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:b6e3e451-289e-40f3-9ad5-80f010e782f9">Jenkins</a>
<ul>
<li><a href="#h:bd2e38bc-44a3-4e9e-9928-7d6086687028">什么是流水线</a></li>
<li><a href="#h:283efc9e-764f-4121-9c98-1fa5e7862ba8">pipline 语法概述</a></li>
<li><a href="#h:79c18518-de40-431c-824e-ada17d3b5ba9">Declarative Pipeline（声明式流水线）</a>
<ul>
<li><a href="#h:a16607b5-ad23-4b8d-8452-1e2c96ca1508">声明式流水线-结构</a></li>
<li><a href="#h:1bc8c33e-0c4e-4229-8b09-47ffd235cd87">语法参考-段Sections</a></li>
<li><a href="#h:6f0d6728-fbf6-4542-a8b3-859d7875dc93">语法参考-指令Directives</a></li>
<li><a href="#h:b00903b9-3092-4099-81c6-147fd139b39f">Parallel 并行执行</a></li>
<li><a href="#h:134df983-c364-4e84-8ba5-9926d3fa1478">常用语法</a></li>
<li><a href="#h:9c468348-3120-4215-90d7-a405fae7a819">可用插件语法</a></li>
</ul>
</li>
<li><a href="#h:92cc7b8c-03a7-41d5-8d0c-96687a4885f2">Scripted Pipeline（脚本式流水线）</a></li>
<li><a href="#h:a1854b88-3006-4489-9ea3-dcf3d45a7793">groovy</a>
<ul>
<li><a href="#h:6edd14b5-5954-4b2d-95a7-3889b60ff964">k8s 发布</a></li>
<li><a href="#h:6244c4a7-8d05-43d4-86ec-160fc0437cf4">从 harbor 获取镜像 tag信息</a></li>
<li><a href="#h:fcfc4970-b374-4638-98f7-122c7379c0fe">获取 gitlab 分支信息</a></li>
<li><a href="#h:d9738758-060a-4095-88b8-cee5ee82c4a1">pipeline cd</a></li>
<li><a href="#h:008afd5d-6a12-40e0-b900-f4fe6e04730b">pipline ci</a></li>
</ul>
</li>
<li><a href="#h:1b58ad70-1d68-4c83-a7d6-4622f97c07c2">jenkins 安装</a></li>
<li><a href="#h:3edf1068-85c0-4f20-bfaa-a5f07376ea89">Jenkinsfile 的使用</a>
<ul>
<li><a href="#h:46361cf9-8321-47cd-a872-4fa6eb192c6d">环境变量</a></li>
<li><a href="#h:20b4307d-f61c-4fd5-ae80-76811f5dbceb">凭证管理</a></li>
<li><a href="#h:a820730a-fcdb-4223-a5c2-2139761031a7">参数处理</a></li>
<li><a href="#h:1e9fd387-432f-4fe1-bddb-78ec90b5e3b7">使用多个代理</a></li>
</ul>
</li>
<li><a href="#h:d081a3ba-57f6-430c-9917-770fd7e40055">DevOps 平台建设</a>
<ul>
<li><a href="#h:ae9c7a73-eefb-442d-bf63-fe11793211d9">自动化构建流水线设计</a></li>
<li><a href="#h:cbc4dcb7-2a05-40e3-a595-99def0067710">jenkins 安装</a></li>
<li><a href="#h:74d893c7-1602-48ca-a0b9-375742f34ebe">gitlab 安装</a></li>
<li><a href="#h:7b54adab-196c-43fc-97c4-97b7d7093a4c">harbor 安装</a></li>
<li><a href="#h:2652696f-54e9-4368-bc3e-18e2f354ba77">jenkins对接各种组件</a></li>
</ul>
</li>
<li><a href="#h:e118e132-094e-40b6-a7f1-fb9fb9f4e851">BlueOcean入门</a>
<ul>
<li><a href="#h:465ce3ab-7397-4b72-a29f-a5d6d350e23f">图形化创建Jenkins案例</a></li>
</ul>
</li>
<li><a href="#h:0f636a09-8c02-4986-98bb-fdf0a557972d">阿里云镜像仓库</a></li>
<li><a href="#h:83cb5c57-53e4-4374-8b73-b49910f87fe1">jenkins 其它配置</a>
<ul>
<li><a href="#h:dc966d04-92fb-429b-8f3d-1a0bda6eb3a3">备份插件ThinBackup</a></li>
</ul>
</li>
<li><a href="#h:b86a6906-aa4b-459c-a0f5-4bcdc5c9c3ce">自动化构建应用</a>
<ul>
<li><a href="#h:ea4386ae-6b3b-4638-a5c6-8c127ea6d083">java  应用</a></li>
<li><a href="#h:9278bcef-7f30-477e-ac29-8fc3786403b6">Vue/H5 应用</a></li>
<li><a href="#h:7ce9a8a4-dcce-437c-bd76-0c27baf3dcc9">Go 应用</a></li>
<li><a href="#h:50dfcf6a-1ae0-4e83-ae28-35c3965357aa">配置自动触发构建</a></li>
<li><a href="#h:bd7b59f7-bf68-4c2f-a9ca-aabfd3e9ceb5">jenkins 共享库</a></li>
</ul>
</li>
<li><a href="#h:a250803d-5571-414f-95fb-5886fa2a1376">杂</a>
<ul>
<li><a href="#h:004d365b-33c6-4d80-9666-62aa27588688">单机启动监控</a></li>
<li><a href="#h:912bad05-e757-41bd-9686-9e5963884b9e">定时备份</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:4f2803a3-0b7a-4e57-97e7-abfa00bac478">Gitlab</a></li>
<li><a href="#h:931e719f-431a-43f0-9062-cf732375d966">harbor</a></li>
<li><a href="#h:d6df48a5-78c6-4a60-b671-23fea6439e7a">样例</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../index.html">Kubernetes</a></li>
</ul>
<section id="outline-container-h:3591ec0f-493e-4b6e-9435-0f03ef8a1ae2" class="outline-2">
<h2 id="h:3591ec0f-493e-4b6e-9435-0f03ef8a1ae2">DevOps篇-CICD</h2>
<div class="outline-text-2" id="text-h:3591ec0f-493e-4b6e-9435-0f03ef8a1ae2">
</div>
<div id="outline-container-h:c7557273-1850-42d4-8f5e-b55036e8235c" class="outline-3">
<h3 id="h:c7557273-1850-42d4-8f5e-b55036e8235c">什么是 DevOps 和 CICD</h3>
<div class="outline-text-3" id="text-h:c7557273-1850-42d4-8f5e-b55036e8235c">
</div>
<div id="outline-container-h:37100d87-d38a-4fb2-bf98-924a99d35c38" class="outline-4">
<h4 id="h:37100d87-d38a-4fb2-bf98-924a99d35c38">DevOps 简介</h4>
<div class="outline-text-4" id="text-h:37100d87-d38a-4fb2-bf98-924a99d35c38">
<p>
Gdevops：<a href="http://dbaplus.cn/">http://dbaplus.cn/</a>
</p>

<p>
DevOps 是 Development 和 Operations 的组合，也就是开发和运维的简写。是一种重视研发人员（Dev）、运维人员（Ops）之间沟通合作的文化、协作和整合。通过自动化"软件交付"和"架构变更"的流程，来使得构建、测试、发布软件能够更加地快捷、频繁和可靠。
</p>

<p>
开发、技术运营、QA、OPS  部门之间沟通、协作与整合，通过一系列自动化工具来完成软件的生命周期管理。
</p>

<p>
DevOps 四大平台：代码托管(gitlab/svn)、项目管理(jira)、运维平台(腾讯蓝鲸/开源平台)、持续交付(Jenkins/gitlab)
</p>
</div>
<div id="outline-container-h:9a2a24c0-757f-44fd-8abc-9123174d11f4" class="outline-5">
<h5 id="h:9a2a24c0-757f-44fd-8abc-9123174d11f4">什么是 DevOps</h5>
<div class="outline-text-5" id="text-h:9a2a24c0-757f-44fd-8abc-9123174d11f4">
<p>
一体化：
</p>
<ul class="org-ul">
<li>Dev
<ul class="org-ul">
<li>DevOps
<ul class="org-ul">
<li>研发运维一体化，持续集成，持续交付</li>
</ul></li>
<li>研发
<ul class="org-ul">
<li>开发流程高效、稳定、快速、交付结果可预期</li>
</ul></li>
</ul></li>
</ul>

<p>
自动化：
</p>
<ul class="org-ul">
<li>Ops
<ul class="org-ul">
<li>运维
<ul class="org-ul">
<li>容器监控，自动化运维，降低维护成本</li>
</ul></li>
</ul></li>
</ul>

<p>
敏捷化：
</p>
<ul class="org-ul">
<li>QA
<ul class="org-ul">
<li>质量
<ul class="org-ul">
<li>持续进行自动化测试，提升交付质量</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:d3c23be4-e7ca-4f02-b45f-d5b197aff244" class="outline-5">
<h5 id="h:d3c23be4-e7ca-4f02-b45f-d5b197aff244">为什么要推广 DevOps</h5>
<div class="outline-text-5" id="text-h:d3c23be4-e7ca-4f02-b45f-d5b197aff244">
<p>
DevOps 强调团队协作、相互协助、持续发展，然而传统的模式是开发人员只顾开发 程序，运维只负责基础环境管理和代码部署及监控等，其并不是为了一个共同的目标 而共同实现最终的目的，而 DevOps 则实现团队作战，即无论是开发、运维还是测试， 都为了最终的代码发布、持续部署和业务稳定而付出各自的努力，从而实现产品设计、 开发、测试和部署的良性循环，实现产品的最终持续交付。
</p>
</div>
</div>
</div>
<div id="outline-container-h:d19b860e-46f4-4322-ac77-58c65aefa044" class="outline-4">
<h4 id="h:d19b860e-46f4-4322-ac77-58c65aefa044">CICD 概念</h4>
<div class="outline-text-4" id="text-h:d19b860e-46f4-4322-ac77-58c65aefa044">
<p>
CI/CD 是一种通过在应用开发阶段引入自动化工具，来频繁向客户交付应用的方法，主要针对在集成新代码时所引发的问题，CICD 是 DevOps 中尤为重要的一个环节。
</p>

<p>
CI/CD 主要分为了三个方面：
</p>
<ul class="org-ul">
<li>持续集成（CI: Continuous Integration）</li>
<li>持续交付（CD: Continuous Delivery）</li>
<li>持续部署(CD: continuous deployment)</li>
</ul>
</div>
<div id="outline-container-h:89244fba-c7c3-4a47-b4a1-1276c7c7e18d" class="outline-5">
<h5 id="h:89244fba-c7c3-4a47-b4a1-1276c7c7e18d">持续集成（CI：Continuous Integration）</h5>
<div class="outline-text-5" id="text-h:89244fba-c7c3-4a47-b4a1-1276c7c7e18d">
<p>
CICD 中的 CI 指持续集成，它属于开发人员的自动化流程。
</p>

<p>
持续集成可以帮助开发人员更加频繁地将代码更改合并到共享分支和主干中。
</p>
</div>
</div>
<div id="outline-container-h:a95ebf40-fff0-40ad-9b60-114d60a87f39" class="outline-5">
<h5 id="h:a95ebf40-fff0-40ad-9b60-114d60a87f39">持续交付（CD：Continuous Delivery）</h5>
<div class="outline-text-5" id="text-h:a95ebf40-fff0-40ad-9b60-114d60a87f39">
<p>
在持续交付中，每个阶段都涉及测试自动化和代码发布自动化。在流程结束时，运维团队可以快速、轻松地将应用部署到生产环境中。
</p>

<p>
持续交付的目标是拥有一个可以随时部署到生产环境的代码库。
</p>
</div>
</div>
<div id="outline-container-h:c3cf0da1-b0aa-4f54-8bbf-14a2c1feecf0" class="outline-5">
<h5 id="h:c3cf0da1-b0aa-4f54-8bbf-14a2c1feecf0">持续部署(CD-continuous deployment)</h5>
<div class="outline-text-5" id="text-h:c3cf0da1-b0aa-4f54-8bbf-14a2c1feecf0">
<p>
对于一个成熟的 CICD 管道来说，最后的阶段是持续部署。作为持续交付（自动将生产就绪型构建版本发布到代码存储库）的延伸，持续部署可以自动将应用发布到生产环境中。
</p>

<p>
持续部署意味着开发人员对应用的更改在最后几分钟内就能生效，这更加便于持续接收和整合用户反馈。
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-h:b6e3e451-289e-40f3-9ad5-80f010e782f9" class="outline-3">
<h3 id="h:b6e3e451-289e-40f3-9ad5-80f010e782f9">Jenkins</h3>
<div class="outline-text-3" id="text-h:b6e3e451-289e-40f3-9ad5-80f010e782f9">
</div>
<div id="outline-container-h:bd2e38bc-44a3-4e9e-9928-7d6086687028" class="outline-4">
<h4 id="h:bd2e38bc-44a3-4e9e-9928-7d6086687028">什么是流水线</h4>
<div class="outline-text-4" id="text-h:bd2e38bc-44a3-4e9e-9928-7d6086687028">
<p>
把复杂的工作拆分为单独的任务。
</p>

<p>
提交、编译、部署是主要的流水线，其中还包括代码检查、安全。
</p>
</div>
</div>
<div id="outline-container-h:283efc9e-764f-4121-9c98-1fa5e7862ba8" class="outline-4">
<h4 id="h:283efc9e-764f-4121-9c98-1fa5e7862ba8">pipline 语法概述</h4>
<div class="outline-text-4" id="text-h:283efc9e-764f-4121-9c98-1fa5e7862ba8">
<p>
Pipeline支持两种语法：
</p>
<ul class="org-ul">
<li>Declarative Pipeline（声明式pipeline，在pipeline2.5中引入，结构化方式）</li>
<li>Scripted Pipeline（脚本式pipeline）
<ul class="org-ul">
<li>需要了解 groovy 语法</li>
</ul></li>
</ul>

<p>
两者都支持建立连续输送的Pipeline。
</p>

<p>
声明式Pipeline是后续Open Blue Ocean所支持类型，建议使用声明式Pipeline的方式进行编写，从jenkins社区动向看，很明显这种语法结构会是未来的趋势。
</p>
</div>
</div>
<div id="outline-container-h:79c18518-de40-431c-824e-ada17d3b5ba9" class="outline-4">
<h4 id="h:79c18518-de40-431c-824e-ada17d3b5ba9">Declarative Pipeline（声明式流水线）</h4>
<div class="outline-text-4" id="text-h:79c18518-de40-431c-824e-ada17d3b5ba9">
<p>
<a href="https://www.jenkins.io/doc/book/pipeline/syntax/">https://www.jenkins.io/doc/book/pipeline/syntax/</a>
</p>

<p>
<a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax/">https://www.jenkins.io/zh/doc/book/pipeline/syntax/</a>
</p>
</div>
<div id="outline-container-h:a16607b5-ad23-4b8d-8452-1e2c96ca1508" class="outline-5">
<h5 id="h:a16607b5-ad23-4b8d-8452-1e2c96ca1508">声明式流水线-结构</h5>
<div class="outline-text-5" id="text-h:a16607b5-ad23-4b8d-8452-1e2c96ca1508">
<div class="org-src-container">
<pre class="src src-shell">pipeline {
    //&#22312;&#20219;&#20309;&#21487;&#29992;&#30340;&#20195;&#29702;&#19978;&#25191;&#34892;Pipeline [&#24517;&#39035;]
    agent any
    // &#36873;&#39033;[&#21487;&#36873;]
    options {}
    // &#24037;&#20855;[&#21487;&#36873;]
    tools{}
    // &#35302;&#21457;&#22120;[&#21487;&#36873;]
    triggers{}
    //&#21442;&#25968;&#21270;&#21464;&#37327;[&#21487;&#36873;]
    parameters {}
    // &#29615;&#22659;&#21464;&#37327;[&#21487;&#36873;]
    environment{}
    // &#24037;&#20316;&#31354;&#38388;[&#24517;&#39035;]
    stages {
        // &#24037;&#20316;&#31354;&#38388;&#30340;&#25551;&#36848;[&#24517;&#39035;]
        stage(<span style="color: #8b2252;">'Example'</span>) {
            // &#24037;&#20855;[&#21487;&#36873;]
            tools{}
            // &#20132;&#20114;&#24335;&#25552;&#31034;[&#21487;&#36873;]
            input{}
            // &#26465;&#20214;&#21028;&#26029;[&#21487;&#36873;]
            when{}
            // &#24037;&#20316;&#31354;&#38388;&#20013;&#25191;&#34892;&#27493;&#39588;[&#24517;&#39035;]
            steps {
                // &#25191;&#34892;&#21629;&#20196;
                <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Hello World'</span>
                sh <span style="color: #8b2252;">"""echo hello'</span>
<span style="color: #8b2252;">                // &#33050;&#26412;[&#21487;&#36873;]</span>
<span style="color: #8b2252;">                script{}</span>
<span style="color: #8b2252;">            }</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">        // &#25191;&#34892;&#32467;&#26524;&#29366;&#24577; [&#21487;&#36873;]</span>
<span style="color: #8b2252;">        post{}</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">    // &#25191;&#34892;&#32467;&#26524;&#29366;&#24577; [&#21487;&#36873;]</span>
<span style="color: #8b2252;">    post{}</span>
<span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">// &#20989;&#25968;&#23450;&#20041;</span>
<span style="color: #8b2252;">def myFunc(myArgs) { &#33050;&#26412;&#35821;&#27861; }</span>
</pre>
</div>

<p>
在声明式流水线中有效的基本语句和表达式遵循与 <a href="http://groovy-lang.org/syntax.html">Groovy的语法</a>同样的规则， 有以下例外:
</p>
<ul class="org-ul">
<li>声明式pipeline可以内嵌脚本式pipeline</li>
<li>有效的声明式pipeline必须包含在一个 `pipeline{}`块中</li>
<li>块只能包含节段Sections，指令Directives，步骤Steps或者赋值语句组成</li>
</ul>

<p>
pipeline 块：
</p>
<ul class="org-ul">
<li>节段（Sections）： 通常包括一个或多个指令或步骤
<ul class="org-ul">
<li>agent：  [必须] 代理执行环境，范围：pipeline block and each stage block.</li>
<li>post：   [可选] 执行结果状态，范围：pipeline block and each stage block.</li>
<li>stages： [必须] 工作空间，包含多个stage指令，范围：pipeline block
<ul class="org-ul">
<li>stage：执行过程（相当于一个阶段），比如 Build、Test、Deploy，但是这个名字根据实际情况进行定义</li>
<li>steps：  [必须] 工作空间中执行步骤，范围：stage block.</li>
</ul></li>
</ul></li>
<li>指令（Directives）： 
<ul class="org-ul">
<li>environment： [可选] 环境变量 范围：pipeline block and stage directives</li>
<li>options： [可选] 选项，也可以由插件提供，如options { timestamps() }，范围：pipeline block and stage block</li>
<li>parameters：[可选] 触发流水线时的参数列表，范围：pipeline block</li>
<li>triggers：[可选] 触发器，流水线被重新触发的自动化方法，范围：pipeline block</li>
<li>stage：[必须] 工作空间的描述，范围：stages section</li>
<li>tools：[可选] 工具，范围：Inside the pipeline block or a stage block</li>
<li>input: [可选] 交互式提示，范围：stage block</li>
<li>when：[可选] 下一步执行判断，范围：stage block</li>
</ul></li>
<li>步骤（steps）： 在steps中可执行脚本式pipeline，如script{}</li>
</ul>
</div>
<ul class="org-ul">
<li><a id="h:5bb36200-e9e7-4618-bf72-76405882127d"></a>注释：<br>
<div class="outline-text-6" id="text-h:5bb36200-e9e7-4618-bf72-76405882127d">
<p>
//
</p>
</div>
</li>
<li><a id="h:56ffc6e4-d040-495b-9e15-36d40d3a31b2"></a>引号的运用<br>
<div class="outline-text-6" id="text-h:56ffc6e4-d040-495b-9e15-36d40d3a31b2">
<p>
echo 中
</p>
<pre class="example" id="orgb9450b9">
'单行命令', '''多行命令'''： 原样输出
"", """"""： 有变量会转译
</pre>

<p>
sh 中
</p>
<pre class="example" id="org3a0d8b3">
'单行命令', '''多行命令'''： 原样输出
"", """"""： 有变量会转译
</pre>

<p>
<b>注意</b> ：
变量的定义加引号，单双引号都可。
</p>

<div class="org-src-container">
<pre class="src src-shell">environment {
 <span style="color: #a0522d;">var1</span>=<span style="color: #8b2252;">'abc'</span>
 <span style="color: #a0522d;">var2</span>=<span style="color: #8b2252;">'d \nf'</span>
}
</pre>
</div>

<p>
变量引用 <code>${var}</code>
</p>

<p>
变量中存在空格或换行，在引用时加双引号转译
</p>

<div class="org-src-container">
<pre class="src src-shell">sh <span style="color: #8b2252;">'echo "${var1} ${var2}"'</span>
sh <span style="color: #8b2252;">"echo \"${var1} \n${var2}\""</span>
</pre>
</div>

<p>
script {}中定义的变量，用双引号或者3双引号引用
</p>
<div class="org-src-container">
<pre class="src src-shell">stages {
  stage(<span style="color: #8b2252;">'Hello'</span>) {
     steps {
        script{
          <span style="color: #a0522d;">var3</span>=<span style="color: #8b2252;">"hi"</span>
          <span style="color: #a0522d;">tag</span> = sh(script: <span style="color: #8b2252;">"date +'%Y%m%d_%H%M%S'"</span>, returnStdout: true).trim()
        }
        sh <span style="color: #8b2252;">"echo ${var3}"</span>   
     }
  }
}
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:1bc8c33e-0c4e-4229-8b09-47ffd235cd87" class="outline-5">
<h5 id="h:1bc8c33e-0c4e-4229-8b09-47ffd235cd87">语法参考-段Sections</h5>
<div class="outline-text-5" id="text-h:1bc8c33e-0c4e-4229-8b09-47ffd235cd87">
</div>
<ul class="org-ul">
<li><a id="h:396cbab0-550c-419e-899c-85a57cee52c8"></a>agent<br>
<div class="outline-text-6" id="text-h:396cbab0-550c-419e-899c-85a57cee52c8">
<p>
Agent表示整个流水线或特定阶段中的步骤和命令执行的位置，该部分必须在pipeline块的顶层被定义，也可以在stage中再次定义，但是stage级别是可选的。
</p>


<p>
<b>any</b>
</p>

<p>
在任何可用的代理上执行流水线，配置语法:
</p>

<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent any
}
</pre>
</div>

<p>
<b>none</b>
</p>

<p>
表示该Pipeline脚本没有全局的agent配置。当顶层的agent配置为none时， 每个stage部分都需要包含它自己的agent。配置语法
</p>
<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent none
  stages {
    stage(<span style="color: #8b2252;">'Stage For Build'</span>){
      agent any
    }
  }
}
</pre>
</div>

<p>
<b>label</b>
</p>

<p>
以节点标签形式选择某个具体的节点执行Pipeline命令，例如：agent { label 'my-defined-label' }。节点需要提前配置标签。
</p>
<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent none
    stages {
      stage(<span style="color: #8b2252;">'Stage For Build'</span>){
        agent { label <span style="color: #8b2252;">'role-master'</span> }
        steps {
          <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"role-master"</span>
        }
      }
    }
}
</pre>
</div>

<p>
<b>node</b>
</p>

<p>
和label配置类似，只不过是可以添加一些额外的配置，比如customWorkspace(设置默认工作目录)
</p>
<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent none
    stages {
      stage(<span style="color: #8b2252;">'Stage For Build'</span>){
        agent { 
          node {
            label <span style="color: #8b2252;">'role-master'</span>
            customWorkspace <span style="color: #8b2252;">"/data"</span>
          }
        }
        steps {
          sh <span style="color: #8b2252;">"echo role-master &gt; 1.txt"</span>
        }
      }
    }
}
</pre>
</div>

<p>
<b>dockerfile</b>
</p>

<p>
使用从源码中包含的Dockerfile所构建的容器执行流水线或stage。此时对应的agent写法如下
</p>
<div class="org-src-container">
<pre class="src src-shell">agent {
   dockerfile {
     filename <span style="color: #8b2252;">'Dockerfile.build'</span>  //dockerfile&#25991;&#20214;&#21517;&#31216;
     dir <span style="color: #8b2252;">'build'</span>                  //&#25191;&#34892;&#26500;&#24314;&#38236;&#20687;&#30340;&#24037;&#20316;&#30446;&#24405;
     label <span style="color: #8b2252;">'role-master'</span>          //&#25191;&#34892;&#30340;node&#33410;&#28857;&#65292;&#26631;&#31614;&#36873;&#25321;
     additionalBuildArgs <span style="color: #8b2252;">'--build-arg version=1.0.2'</span> //&#26500;&#24314;&#21442;&#25968;
   }
}
</pre>
</div>
<p>
agent 中选项 reuseNode 在 label 指定是docker 时有用，值为 true 多个 docker 可共享同工作目录
</p>

<p>
<b>docker</b>
</p>

<p>
相当于dockerfile，可以直接使用docker字段指定外部镜像即可，可以省去构建的时间。比如使用maven镜像进行打包，同时可以指定args
</p>
<div class="org-src-container">
<pre class="src src-shell">agent{
  docker{
    image <span style="color: #8b2252;">'192.168.10.15/kubernetes/alpine:latest'</span>   //&#38236;&#20687;&#22320;&#22336;
    label <span style="color: #8b2252;">'role-master'</span> //&#25191;&#34892;&#30340;&#33410;&#28857;&#65292;&#26631;&#31614;&#36873;&#25321;
    args <span style="color: #8b2252;">'-v /tmp:/tmp'</span>      //&#21551;&#21160;&#38236;&#20687;&#30340;&#21442;&#25968;
  }
}

</pre>
</div>

<p>
<b>kubernetes</b>
</p>

<p>
需要部署kubernetes相关的插件，官方文档：<a href="https://github.com/jenkinsci/kubernetes-plugin/">https://github.com/jenkinsci/kubernetes-plugin/</a>
</p>

<p>
Jenkins 也支持使用 Kubernetes 创建 Slave，也就是常说的动态 Slave。配置示例如下
</p>
<ul class="org-ul">
<li>cloud: Configure Clouds的名称，指定到其中一个k8s</li>
<li>slaveConnectTimeout: 连接超时时间</li>
<li>yaml: pod定义文件，jnlp容器的配置必须有配置无需改变，其余containerd根据自己情况指定</li>
<li>workspaceVolume：持久化jenkins的工作目录。
<ul class="org-ul">
<li>persistentVolumeClaimWorkspaceVolume：挂载已有pvc。</li>
</ul></li>
</ul>
</div>
<ul class="org-ul">
<li><a id="h:c1469d80-353d-43aa-bfc6-77026ed18729"></a>配置示例<br>
<div class="outline-text-7" id="text-h:c1469d80-353d-43aa-bfc6-77026ed18729">
<p>
docker 示例
</p>
<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent none 
  stages {
    stage(<span style="color: #8b2252;">'Example Build'</span>) {
      agent { docker <span style="color: #8b2252;">'maven:3-alpine'</span> } 
      steps {
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Hello, Maven'</span>
        sh <span style="color: #8b2252;">'mvn --version'</span>
      }
    }
    stage(<span style="color: #8b2252;">'Example Test'</span>) {
      agent { docker <span style="color: #8b2252;">'openjdk:8-jre'</span> } 
      steps {
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Hello, JDK'</span>
        sh <span style="color: #8b2252;">'java -version'</span>
      }
    }
  }
}
</pre>
</div>


<p>
kubernetes 示例
</p>

<p>
比如定义三个容器的pod
</p>
<ul class="org-ul">
<li>jnlp 负责与 jenkins master 通信</li>
<li>build 负责执行构建命令</li>
<li>kubectl 负责执行 kubernetes 命令</li>
</ul>

<p>
在 setps 中可能通过 containers 字段，选择在某个容器执行命令：
</p>
<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent {
    kubernetes {
      cloud <span style="color: #8b2252;">'kubernetes'</span>
      slaveConnectTimeout 1200
      workspaceVolume emptyDirWorkspaceVolume()
      yaml <span style="color: #8b2252;">'''</span>
<span style="color: #8b2252;">kind: Pod</span>
<span style="color: #8b2252;">metadata:</span>
<span style="color: #8b2252;">  name: jenkins-agent</span>
<span style="color: #8b2252;">spec:</span>
<span style="color: #8b2252;">  containers:</span>
<span style="color: #8b2252;">  - args: [\'</span>$(JENKINS_SECRET)<span style="color: #8b2252;">\'</span>, <span style="color: #8b2252;">\'</span>$(JENKINS_NAME)<span style="color: #8b2252;">\'</span>]
    image: <span style="color: #8b2252;">'192.168.10.15/kubernetes/jnlp:alpine'</span>
    name: jnlp
    imagePullPolicy: IfNotPresent
  - command:
      - <span style="color: #8b2252;">"cat"</span>
    image: <span style="color: #8b2252;">"192.168.10.15/kubernetes/maven:latest"</span>
    imagePullPolicy: <span style="color: #8b2252;">"IfNotPresent"</span>
    name: <span style="color: #8b2252;">"build"</span>
    tty: true <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20445;&#25345;&#38236;&#20687;&#19981;&#35201;&#36864;&#20986;&#65292;&#36991;&#20813;&#39057;&#32321;&#21024;&#38500;&#21019;&#24314;</span>
  - command:
      - <span style="color: #8b2252;">"cat"</span>
    image: <span style="color: #8b2252;">"192.168.10.15/kubernetes/kubectl:apline"</span>
    imagePullPolicy: <span style="color: #8b2252;">"IfNotPresent"</span>
    name: <span style="color: #8b2252;">"kubectl"</span>
    tty: true
  restartPolicy: Never
<span style="color: #8b2252;">'''</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">  }</span>
<span style="color: #8b2252;">  environment {</span>
<span style="color: #8b2252;">    MY_KUBECONFIG = credentials('</span>kubernetes-cluster<span style="color: #8b2252;">')</span>
<span style="color: #8b2252;">  }</span>
<span style="color: #8b2252;">  stages {</span>
<span style="color: #8b2252;">    stage('</span>Bulding<span style="color: #8b2252;">') {</span>
<span style="color: #8b2252;">      steps {</span>
<span style="color: #8b2252;">        container(name: '</span>build<span style="color: #8b2252;">') {</span>
<span style="color: #8b2252;">          sh """</span>
<span style="color: #8b2252;">            mvn clean install</span>
<span style="color: #8b2252;">          """</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">      }</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">    stage('</span>Deploy<span style="color: #8b2252;">') {</span>
<span style="color: #8b2252;">      steps {</span>
<span style="color: #8b2252;">        container(name: '</span>kubectl<span style="color: #8b2252;">') {</span>
<span style="color: #8b2252;">          sh """</span>
<span style="color: #8b2252;">            kubectl get pod -A  --kubeconfig $MY_KUBECONFIG</span>
<span style="color: #8b2252;">          """</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">      }</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">  }</span>
<span style="color: #8b2252;">}</span>
</pre>
</div>
</div>
</li>
</ul>
</li>
<li><a id="h:4f8ea93e-a23f-42f4-b4bd-93312b928749"></a>post<br>
<div class="outline-text-6" id="text-h:4f8ea93e-a23f-42f4-b4bd-93312b928749">
<p>
post 一般用于流水线结束后的进一步处理，比如错误通知等。Post  可以针对流水线不同的结果做出不同的处理，就像开发程序的错误处理，比如 Python 语言的 try catch。
</p>

<p>
post 可以定义在 Pipeline 或 stage 中，目前支持以下条件:
</p>

<ul class="org-ul">
<li>always：无论 Pipeline 或 stage 的完成状态如何，都允许运行该 post 中定义的指令；</li>
<li>changed：只有当前 Pipeline 或 stage 的完成状态与它之前的运行不同时，才允许在该 post 部分运行该步骤；</li>
<li>fixed：当本次 Pipeline 或 stage 成功，且上一次构建是失败或不稳定时，允许运行该 post 中定义的指令；</li>
<li>regression：当本次 Pipeline 或 stage 的状态为失败、不稳定或终止，且上一次构建的 状态为成功时，允许运行该 post 中定义的指令；</li>
<li>failure：只有当前 Pipeline 或 stage 的完成状态为失败（failure），才允许在 post 部分运行该步骤，通常这时在 Web 界面中显示为红色</li>
<li>success：当前状态为成功（success），执行 post 步骤，通常在 Web 界面中显示为蓝色 或绿色</li>
<li>unstable：当前状态为不稳定（unstable），执行 post 步骤，通常由于测试失败或代码 违规等造成，在 Web 界面中显示为黄色</li>
<li>aborted：当前状态为终止（aborted），执行该 post 步骤，通常由于流水线被手动终止触发，这时在 Web 界面中显示为灰色；</li>
<li>unsuccessful：当前状态不是 success 时，执行该 post 步骤；</li>
<li>cleanup：无论 pipeline 或 stage 的完成状态如何，都允许运行该 post 中定义的指令。 和 always 的区别在于，cleanup 会在其它执行之后执行。</li>
</ul>
</div>
</li>
<li><a id="h:575e7129-fa4c-483f-bfcb-e3fe45b9723f"></a>stages<br>
<div class="outline-text-6" id="text-h:575e7129-fa4c-483f-bfcb-e3fe45b9723f">
</div>
</li>
<li><a id="h:25cc759c-5367-48d4-9c19-0d6c46ece6c2"></a>steps<br>
<div class="outline-text-6" id="text-h:25cc759c-5367-48d4-9c19-0d6c46ece6c2">
</div>
</li>
</ul>
</div>
<div id="outline-container-h:6f0d6728-fbf6-4542-a8b3-859d7875dc93" class="outline-5">
<h5 id="h:6f0d6728-fbf6-4542-a8b3-859d7875dc93">语法参考-指令Directives</h5>
<div class="outline-text-5" id="text-h:6f0d6728-fbf6-4542-a8b3-859d7875dc93">
<ul class="org-ul">
<li>指令（Directives）： 
<ul class="org-ul">
<li>environment： [可选] 环境变量 范围：pipeline block and stage directives</li>
<li>options： [可选] 选项，也可以由插件提供，如options { timestamps() }，范围：pipeline block and stage block</li>
<li>parameters：[可选] 触发流水线时的参数列表，范围：pipeline block</li>
<li>triggers：[可选] 触发器，流水线被重新触发的自动化方法，范围：pipeline block</li>
<li>stage：[必须] 工作空间的描述，范围：stages section</li>
<li>tools：[可选] 工具，范围：Inside the pipeline block or a stage block</li>
<li>input: [可选] 交互式提示，范围：stage block</li>
<li>when：[可选] 下一步执行判断，范围：stage block</li>
</ul></li>
</ul>
</div>
<ul class="org-ul">
<li><a id="h:c61da65b-87c8-4c96-b658-fa47e37b6029"></a>environment<br>
<div class="outline-text-6" id="text-h:c61da65b-87c8-4c96-b658-fa47e37b6029">
<p>
Environment 主要用于在流水线中配置的一些环境变量，根据配置的位置决定环境变量的作用域。可以定义在 pipeline 中作为全局变量，也可以配置在 stage 中作为该 stage 的环境变量。
</p>

<p>
该指令支持一个特殊的方法 credentials()，该方法可用于在 Jenkins 环境中通过标识符访问预定义的凭证。对于类型为 Secret Text 的凭证，credentials()可以将该 Secret 中的文本内容赋值给环境变量。对于类型为标准的账号密码型的凭证，指定的环境变量为 username 和 password，并且也会定义两个额外的环境变量，分别为MYVARNAME_USR和MYVARNAME_PSW。
</p>
</div>
</li>
<li><a id="h:eb557709-639e-4f21-a7f6-ccca912e18a6"></a>options<br>
<div class="outline-text-6" id="text-h:eb557709-639e-4f21-a7f6-ccca912e18a6">
<ul class="org-ul">
<li>buildDiscarder ： 保留多少个流水线的构建记录</li>
<li>disableConcurrentBuilds：禁止流水线并行执行，防止并行流水线同时访问共享资源导致流水线失败。</li>
<li>disableResume ：如果控制器重启，禁止流水线自动恢复。</li>
<li>newContainerPerStage：agent 为 docker 或 dockerfile 时，每个阶段将在同一个节点的新容器中运行，而不是所有的阶段都在同一个容器中运行。</li>
<li>quietPeriod：流水线静默期，也就是触发流水线后等待一会在执行。</li>
<li>retry：流水线失败后重试次数。</li>
<li>timeout：设置流水线的超时时间，超过流水线时间，job 会自动终止。如果不加unit参数默认为1分。</li>
<li>timestamps：为控制台输出时间戳。</li>
</ul>

<p>
定义在pipeline中:
</p>
<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent any
  options {
    timeout(<span style="color: #483d8b;">time</span>: 1, unit: <span style="color: #8b2252;">'HOURS'</span>)  //&#36229;&#26102;&#26102;&#38388;1&#23567;&#26102;&#65292;&#22914;&#26524;&#19981;&#21152;unit&#21442;&#25968;&#40664;&#35748;&#20026;1&#20998;
    timestamps()                     //&#25152;&#26377;&#36755;&#20986;&#27599;&#34892;&#37117;&#20250;&#25171;&#21360;&#26102;&#38388;&#25139;
    buildDiscarder(logRotator(numToKeepStr: <span style="color: #8b2252;">'3'</span>)) //&#20445;&#30041;&#19977;&#20010;&#21382;&#21490;&#26500;&#24314;&#29256;&#26412;
    quietPeriod(10)  //&#27880;&#24847;&#25163;&#21160;&#35302;&#21457;&#30340;&#26500;&#24314;&#19981;&#29983;&#25928;
    retry(3)    //&#27969;&#27700;&#32447;&#22833;&#36133;&#21518;&#37325;&#35797;&#27425;&#25968;
  }
  stages {
    stage(<span style="color: #8b2252;">'env1'</span>) {
      steps {
        sh <span style="color: #8b2252;">"env"</span> 
        sleep 2
      }
    }
    stage(<span style="color: #8b2252;">'env2'</span>) {
      steps {
        sh <span style="color: #8b2252;">"env"</span>  
      }
    }
  }
}
</pre>
</div>

<p>
定义在stage中:
Option除了写在Pipeline顶层，还可以写在stage中，但是写在stage中的option仅支持retry、 timeout、timestamps，或者是和 stage 相关的声明式选项，比如 skipDefaultCheckout。处于stage级别的options写法如下
</p>
<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent any
  stages {
    stage(<span style="color: #8b2252;">'env1'</span>) {
      options {   //&#23450;&#20041;&#22312;&#36825;&#37324;&#36825;&#23545;&#36825;&#20010;stage&#29983;&#25928;
        timeout(<span style="color: #483d8b;">time</span>: 2, unit: <span style="color: #8b2252;">'SECONDS'</span>) //&#36229;&#26102;&#26102;&#38388;2&#31186;
        timestamps()                     //&#25152;&#26377;&#36755;&#20986;&#27599;&#34892;&#37117;&#20250;&#25171;&#21360;&#26102;&#38388;&#25139;
        retry(3)    //&#27969;&#27700;&#32447;&#22833;&#36133;&#21518;&#37325;&#35797;&#27425;&#25968;
      } 
      steps {
        sh <span style="color: #8b2252;">"env &amp;&amp; sleep 2"</span> 
      }
    }
    stage(<span style="color: #8b2252;">'env2'</span>) {
      steps {
        sh <span style="color: #8b2252;">"env"</span>  
      }
    }
  }
}
</pre>
</div>
</div>
</li>
<li><a id="h:0de03bc7-1d47-47e3-a038-086d969d083e"></a>parameters<br>
<div class="outline-text-6" id="text-h:0de03bc7-1d47-47e3-a038-086d969d083e">
<p>
Parameters提供了一个用户在触发流水线时应该提供的参数列表，这些用户指定参数的值可以通过params对象提供给流水线的step（步骤）。只能定义在pipeline顶层。
</p>

<p>
目前支持的参数类型如下：
</p>
<ul class="org-ul">
<li>string：字符串类型的参数。</li>
<li>text：文本型参数，一般用于定义多行文本内容的变量。</li>
<li>booleanParam：布尔型参数。</li>
<li>choice：选择型参数，一般用于给定几个可选的值，然后选择其中一个进行赋值。</li>
<li>password：密码型变量，一般用于定义敏感型变量，在 Jenkins 控制台会输出为*。</li>
</ul>

<p>
插件Parameters：
</p>
<ul class="org-ul">
<li>imageTag：镜像 tag，需要安装 Image Tag Parameter 插件后使用</li>
<li>gitParameter：获取 git 仓库分支，需要安装 Git Parameter 插件后使用</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent any
  parameters { 
    string(name: <span style="color: #8b2252;">'DEPLOY_ENV'</span>, defaultValue:  <span style="color: #8b2252;">'staging'</span>, description: <span style="color: #8b2252;">'1'</span>)   //&#25191;&#34892;&#26500;&#24314;&#26102;&#38656;&#35201;&#25163;&#21160;&#37197;&#32622;&#23383;&#31526;&#20018;&#31867;&#22411;&#21442;&#25968;&#65292;&#20043;&#21518;&#36171;&#20540;&#32473;&#21464;&#37327;
    text(name:  <span style="color: #8b2252;">'DEPLOY_TEXT'</span>, defaultValue: <span style="color: #8b2252;">'One\nTwo\nThree\n'</span>, description: <span style="color: #8b2252;">'2'</span>)  //&#25191;&#34892;&#26500;&#24314;&#26102;&#38656;&#35201;&#25552;&#20379;&#25991;&#26412;&#21442;&#25968;&#65292;&#20043;&#21518;&#36171;&#20540;&#32473;&#21464;&#37327;
    booleanParam(name: <span style="color: #8b2252;">'DEBUG_BUILD'</span>,  defaultValue: true, description: <span style="color: #8b2252;">'3'</span>)   //&#24067;&#23572;&#22411;&#21442;&#25968;
    choice(name: <span style="color: #8b2252;">'CHOICES'</span>, choices: [<span style="color: #8b2252;">'one'</span>, <span style="color: #8b2252;">'two'</span>, <span style="color: #8b2252;">'three'</span>], description: <span style="color: #8b2252;">'4'</span>)  //&#36873;&#25321;&#24418;&#24335;&#21015;&#34920;&#21442;&#25968;
    password(name: <span style="color: #8b2252;">'PASSWORD'</span>, defaultValue: <span style="color: #8b2252;">'SECRET'</span>, description: <span style="color: #8b2252;">'A  secret password'</span>)  //&#23494;&#30721;&#31867;&#22411;&#21442;&#25968;&#65292;&#20250;&#36827;&#34892;&#21152;&#23494; 
    imageTag(name: <span style="color: #8b2252;">'DOCKER_IMAGE'</span>, description: <span style="color: #8b2252;">''</span>, image: <span style="color: #8b2252;">'kubernetes/kubectl'</span>, filter: <span style="color: #8b2252;">'.*'</span>, defaultTag: <span style="color: #8b2252;">''</span>, registry: <span style="color: #8b2252;">'https://192.168.10.15'</span>, credentialId: <span style="color: #8b2252;">'harbor-account'</span>, tagOrder: <span style="color: #8b2252;">'NATURAL'</span>)   //&#33719;&#21462;&#38236;&#20687;&#21517;&#31216;&#19982;tag
    gitParameter(branch: <span style="color: #8b2252;">''</span>, branchFilter: <span style="color: #8b2252;">'origin/(.*)'</span>, defaultValue: <span style="color: #8b2252;">''</span>, description: <span style="color: #8b2252;">'Branch for build and deploy'</span>, name: <span style="color: #8b2252;">'BRANCH'</span>, quickFilterEnabled: false, selectedValue: <span style="color: #8b2252;">'NONE'</span>, sortMode: <span style="color: #8b2252;">'NONE'</span>,  tagFilter: <span style="color: #8b2252;">'*'</span>, type: <span style="color: #8b2252;">'PT_BRANCH'</span>)
  }  //&#33719;&#21462;git&#20179;&#24211;&#20998;&#25903;&#21015;&#34920;&#65292;&#24517;&#39035;&#26377;git&#24341;&#29992;
  stages {
    stage(<span style="color: #8b2252;">'env1'</span>) {
      steps {
        sh <span style="color: #8b2252;">"env"</span> 
      }
    }
    stage(<span style="color: #8b2252;">'git'</span>) {
      steps {
        git branch: <span style="color: #8b2252;">"$BRANCH"</span>, credentialsId: <span style="color: #8b2252;">'gitlab-key'</span>, url: <span style="color: #8b2252;">'git@192.168.10.14:root/env.git'</span>   //&#20351;&#29992;gitParameter&#65292;&#24517;&#39035;&#26377;&#36825;&#20010;
      }
    }
  }
}
</pre>
</div>

<p>
<b>注意</b>
不建议在 pipline 用，第一次构建后才能显示。修改后必须要构建一次才更新。
</p>
</div>
</li>
<li><a id="h:4f68bda2-c8a3-4d79-89ab-953321f9ad87"></a>triggers<br>
<div class="outline-text-6" id="text-h:4f68bda2-c8a3-4d79-89ab-953321f9ad87">
<p>
在 Pipeline 中可以用 triggers 实现自动触发流水线执行任务，可以通过 Webhook、Cron、 pollSCM 和 upstream 等方式触发流水线。
</p>

<p>
<b>cron</b>
</p>

<p>
定时构建假如某个流水线构建的时间比较长，或者某个流水线需要定期在某个时间段执行构建，可以 使用 cron 配置触发器，比如周一到周五每隔四个小时执行一次
</p>

<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent any
  triggers {
    cron(<span style="color: #8b2252;">'H */4 * * 1-5'</span>)   //&#21608;&#19968;&#21040;&#21608;&#20116;&#27599;&#38548;&#22235;&#20010;&#23567;&#26102;&#25191;&#34892;&#19968;&#27425;
    cron(<span style="color: #8b2252;">'H/12 * * * *'</span>)   //&#27599;&#38548;12&#20998;&#38047;&#25191;&#34892;&#19968;&#27425;
    cron(<span style="color: #8b2252;">'H * * * *'</span>)   //&#27599;&#38548;1&#23567;&#26102;&#25191;&#34892;&#19968;&#27425;
  }
  stages {
    stage(<span style="color: #8b2252;">'Example'</span>) {
      steps {
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Hello World'</span>
      }
    }
  }
}
</pre>
</div>

<p>
注意：
</p>
<ul class="org-ul">
<li>H 的意思不是 HOURS 的意思，而是 Hash 的缩写。主要为了解决多个流水线在同一时间同时运行带来的系统负载压力。</li>
</ul>

<p>
使用 cron 字段可以定期执行流水线，如果代码更新想要重新触发流水线，可以使用 pollSCM 字段：
</p>
<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent any
  triggers {
    cronpollSCM(<span style="color: #8b2252;">'H */4 * * 1-5'</span>)   //&#21608;&#19968;&#21040;&#21608;&#20116;&#27599;&#38548;&#22235;&#20010;&#23567;&#26102;&#25191;&#34892;&#19968;&#27425;
  }
  stages {
    stage(<span style="color: #8b2252;">'Example'</span>) {
      steps {
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Hello World'</span>
      }
    }
  }
}
</pre>
</div>


<p>
<b>upstream</b>
</p>

<p>
Upstream可以根据上游 job 的执行结果决定是否触发该流水线。比如当 job1 或 job2 执行成功时触发该流水线
</p>

<p>
目前支持的状态有 SUCCESS、UNSTABLE、FAILURE、NOT_BUILT、ABORTED 等。
</p>
<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent any
  triggers {
    upstream(upstreamProjects: <span style="color: #8b2252;">'env'</span>, threshold: hudson.model.Result.SUCCESS)  //&#24403;env&#26500;&#24314;&#25104;&#21151;&#26102;&#26500;&#24314;&#36825;&#20010;&#27969;&#27700;&#32447;&#65292;&#22810;&#20010;&#29992; , &#36887;&#21495;&#20998;&#38548;
  }
  stages {
    stage(<span style="color: #8b2252;">'Example'</span>) {
      steps {
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Hello World'</span>
      }
    }
  }
}
</pre>
</div>
</div>
</li>
<li><a id="h:52b881ef-67d4-4bfe-858a-ca94f18251f6"></a>input<br>
<div class="outline-text-6" id="text-h:52b881ef-67d4-4bfe-858a-ca94f18251f6">
<p>
Input 字段可以实现在流水线中进行交互式操作，比如选择要部署的环境、是否继续执行某个阶段等。
</p>

<p>
配置Input支持以下选项：
</p>
<ul class="org-ul">
<li>message：必选，需要用户进行 input 的提示信息，比如：“是否发布到生产环境？”；</li>
<li>id：可选，input 的标识符，默认为 stage 的名称；</li>
<li>ok：可选，确认按钮的显示信息，比如：“确定”、“允许”；</li>
<li>submitter：可选，允许提交 input 操作的用户或组的名称，如果为空，任何登录用户均可提交input；</li>
<li>parameters：提供一个参数列表供 input 使用。</li>
</ul>

<p>
假如需要配置一个提示消息为“还继续么”、确认按钮为“继续”、提供一个 PERSON 的变量的参数，并且只能由登录用户为 alice 和 bob 提交的 input 流水线：
</p>
<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent any
  stages {
    stage(<span style="color: #8b2252;">'Example'</span>) {
      input {
        message <span style="color: #8b2252;">"&#36824;&#32487;&#32493;&#20040;?"</span>
        ok <span style="color: #8b2252;">"&#32487;&#32493;"</span>
        submitter <span style="color: #8b2252;">"alice,bob"</span>
        parameters {
          string(name: <span style="color: #8b2252;">'PERSON'</span>, defaultValue: <span style="color: #8b2252;">'Mr Jenkins'</span>, description: <span style="color: #8b2252;">'Who should I say hello to?'</span>)
        }
      }
      steps {
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"Hello, ${PERSON}, nice to meet you."</span>
      }
    }
  }
}

</pre>
</div>
</div>
</li>
<li><a id="h:aa74831c-589b-4eb6-b9bc-9f86e4974867"></a>when<br>
<div class="outline-text-6" id="text-h:aa74831c-589b-4eb6-b9bc-9f86e4974867">
<p>
When 指令允许流水线根据给定的条件决定是否应该执行该 stage，when 指令必须包含至少 一个条件。如果 when 包含多个条件，所有的子条件必须都返回 True，stage 才能执行。
</p>

<p>
When 也可以结合 not、allOf、anyOf 语法达到更灵活的条件匹配。
</p>

<p>
目前比较常用的内置条件如下
</p>
<ul class="org-ul">
<li>branch：当正在构建的分支与给定的分支匹配时，执行这个stage。注意，branch只适用于多分支流水线</li>
<li>changelog：匹配提交的changeLog决定是否构建，例如:`when { changelog '.*^\\[DEPENDENCY\\] .+$' }`</li>
<li>environment：当指定的环境变量和给定的变量匹配时，执行这个 stage，例如：`when { environment name: 'DEPLOY_TO', value: 'production' }`</li>
<li>equals：当期望值和实际值相同时，执行这个 stage，例如：`when { equals expected: 2, actual: currentBuild.number }；`</li>
<li>expression：当指定的 Groovy 表达式评估为 True，执行这个 stage，例如：`when { expression { return params.DEBUG_BUILD } }；`</li>
<li>tag：如果 TAG_NAME 的值和给定的条件匹配，执行这个 stage，例如：`when { tag "release-" }；`</li>
<li>not：当嵌套条件出现错误时，执行这个 stage，必须包含一个条件，例如：`when { not { branch 'master' } }；`</li>
<li>allOf：当所有的嵌套条件都正确时，执行这个 stage，必须包含至少一个条件，例如： `when { allOf { branch 'master'; environment name: 'DEPLOY_TO', value: 'production' } }；`</li>
<li>anyOf：当至少有一个嵌套条件为 True 时，执行这个 stage，例如：`when { anyOf { branch 'master'; branch 'staging' } }`。</li>
</ul>


<p>
示例：当分支为main且DEPLOY_TO变量的值为main时执行Example Deploy步骤
</p>
<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent any
  environment {
    <span style="color: #a0522d;">DEPLOY_TO</span> = <span style="color: #8b2252;">"main"</span>
  }
  stages {
    stage(<span style="color: #8b2252;">'Example Build'</span>) {
      steps {
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Hello World'</span>
      }
    }
    stage(<span style="color: #8b2252;">'Example Deploy'</span>) {
      when {
        branch <span style="color: #8b2252;">'main'</span> //&#22810;&#20998;&#25903;&#27969;&#27700;&#32447;&#65292;&#20998;&#25903;&#20026; main &#25165;&#20250;&#25191;&#34892;&#12290;
        environment name: <span style="color: #8b2252;">'DEPLOY_TO'</span>, value: <span style="color: #8b2252;">'main'</span>
      }
      steps {
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Deploying'</span>
      }
    }
  }
}
</pre>
</div>

<p>
默认情况下，如果定义了某个 stage 的 agent，在进入该 stage 的 agent 后，该stage的when 条件才会被评估，但是可以通过一些选项更改此选项。比如在进入stage的agent前评估when， 可以使用beforeAgent，当when为true时才进行该stage。
</p>

<p>
目前支持的前置条件如下
</p>
<ul class="org-ul">
<li>beforeAgent：如果 beforeAgent为true，则会先评估when条件。在when条件为true时，才会进入该stage</li>
<li>beforeInput：如果beforeInput为true，则会先评估when条件。在when条件为true时，才会进入到input阶段；</li>
<li>beforeOptions：如果beforeInput为true，则会先评估when条件。在when条件为true时，才会进入到options阶段；</li>
<li>beforeOptions优先级大于beforeInput大于beforeAgent</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent none
  stages {
    stage(<span style="color: #8b2252;">'Example Build'</span>) {
      steps {
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Hello World'</span>
      }
    }
    stage(<span style="color: #8b2252;">'Example Deploy'</span>) {
      when {
        beforeAgent true
        branch <span style="color: #8b2252;">'main'</span>
      }
      steps {
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Deploying'</span>
      }
    }
  }
}
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:b00903b9-3092-4099-81c6-147fd139b39f" class="outline-5">
<h5 id="h:b00903b9-3092-4099-81c6-147fd139b39f">Parallel 并行执行</h5>
<div class="outline-text-5" id="text-h:b00903b9-3092-4099-81c6-147fd139b39f">
<p>
场景：
</p>
<ul class="org-ul">
<li>代码检查</li>
</ul>

<p>
在声明式流水线中可以使用 Parallel 字段，即可很方便的实现并发构建，比如对分支 A、B、 C 进行并行处理
</p>

<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent any
  stages {
    stage(<span style="color: #8b2252;">'Non-Parallel Stage'</span>) {
      steps {
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'This stage will be executed first.'</span>
      }
    }
    stage(<span style="color: #8b2252;">'Parallel Stage'</span>) {
      failFast true         //&#34920;&#31034;&#20854;&#20013;&#21482;&#35201;&#26377;&#19968;&#20010;&#20998;&#25903;&#26500;&#24314;&#25191;&#34892;&#22833;&#36133;&#65292;&#23601;&#30452;&#25509;&#25512;&#20986;&#19981;&#31561;&#24453;&#20854;&#20182;&#20998;&#25903;&#26500;&#24314;
      parallel {
        stage(<span style="color: #8b2252;">'Branch A'</span>) {
          steps {
            <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"On Branch A"</span>
          }
        }
        stage(<span style="color: #8b2252;">'Branch B'</span>) {
          steps {
            <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"On Branch B"</span>
          }
        }
        stage(<span style="color: #8b2252;">'Branch C'</span>) {
          stages {
            stage(<span style="color: #8b2252;">'Nested 1'</span>) {
              steps {
                <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"In stage Nested 1 within Branch C"</span>
              }
            }
            stage(<span style="color: #8b2252;">'Nested 2'</span>) {
              steps {
               <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"In stage Nested 2 within Branch C"</span>
              }
            }
          }
        }
      }
    }
  }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:134df983-c364-4e84-8ba5-9926d3fa1478" class="outline-5">
<h5 id="h:134df983-c364-4e84-8ba5-9926d3fa1478">常用语法</h5>
<div class="outline-text-5" id="text-h:134df983-c364-4e84-8ba5-9926d3fa1478">
<p>
可以给node打上标签，在jenkins机器管理中找到。
</p>

<p>
实际上`agent { label 'jdk8' }`是 `agent { node { label 'jdk8' } }` 的简写
</p>
</div>
<ul class="org-ul">
<li><a id="h:6fb5699a-7ccf-436a-9213-e4913577d62a"></a>构建历史<br>
<div class="outline-text-6" id="text-h:6fb5699a-7ccf-436a-9213-e4913577d62a">
<div class="org-src-container">
<pre class="src src-shell">options {
  buildDiscarder(logRotator(daysToKeepStr: <span style="color: #8b2252;">'7'</span>))
}
</pre>
</div>
<p>
daysToKeep: 构建记录将保存的天数
numToKeep: 最多此数目的构建记录将被保存
artifactDaysToKeep: 比此早的发布包将被删除，但构建的日志、操作历史、报告等将被保留
artifactNumToKeep: 最多此数目的构建将保留他们的发布包
</p>
</div>
</li>
<li><a id="h:4704088d-5722-41c8-ba79-15b636c5adf9"></a>构建前清理工作空间<br>
<div class="outline-text-6" id="text-h:4704088d-5722-41c8-ba79-15b636c5adf9">
<p>
<a href="https://plugins.jenkins.io/ws-cleanup/">https://plugins.jenkins.io/ws-cleanup/</a>
</p>

<p>
cleanWs()
</p>

<div class="org-src-container">
<pre class="src src-shell">pipeline {
   agent any
   stages {
      stage(<span style="color: #8b2252;">'Hello'</span>) {
         steps {
            cleanWs()
            sh <span style="color: #8b2252;">"echo hello &gt;&gt;a.log"</span>
         }
      }
   }
}
</pre>
</div>
</div>
</li>
<li><a id="h:1d869373-c569-4c2d-bc50-d81147b534d3"></a>parameters参数化构建的参数<br>
<div class="outline-text-6" id="text-h:1d869373-c569-4c2d-bc50-d81147b534d3">
<p>
parameters指令提供用户在触发Pipeline时的参数列表。这些参数值通过该params对象可用于Pipeline步骤
</p>

<p>
目前只支持[booleanParam, choice, credentials, file, text, password, run, string]这几种参数类型
</p>

<div class="org-src-container">
<pre class="src src-shell">parameters {
  choice(name:<span style="color: #8b2252;">'GIT_ADDR'</span>,choices:<span style="color: #8b2252;">'git@git.ienglish.cn:chinese/chinese-parent-server.git'</span>,description:<span style="color: #8b2252;">''</span>)
  string(name:<span style="color: #8b2252;">'GIT_BRANCH'</span>,defaultValue:<span style="color: #8b2252;">''</span>,description:<span style="color: #8b2252;">''</span>)
}
stages {
  stage(<span style="color: #8b2252;">'Build'</span>) {
    steps {
      timestamps {
        // pull git code
        git branch:<span style="color: #8b2252;">"${GIT_BRANCH}"</span>,url:<span style="color: #8b2252;">"${GIT_ADDR}"</span>
      }
    }
  }
}

</pre>
</div>
</div>
</li>
<li><a id="h:243f3c41-940e-43b9-833c-0440d2d16d48"></a>归档文件<br>
<div class="outline-text-6" id="text-h:243f3c41-940e-43b9-833c-0440d2d16d48">
<p>
<a href="https://www.jenkins.io/doc/pipeline/steps/core/">https://www.jenkins.io/doc/pipeline/steps/core/</a>
</p>

<div class="org-src-container">
<pre class="src src-shell">// &#24402;&#26723;
archiveArtifacts <span style="color: #8b2252;">'target/*.jar'</span>
</pre>
</div>
</div>
</li>
<li><a id="h:8faedff3-86ed-4c55-9213-385006f526bb"></a>构建名<br>
<div class="outline-text-6" id="text-h:8faedff3-86ed-4c55-9213-385006f526bb">
<div class="org-src-container">
<pre class="src src-shell">buildName <span style="color: #8b2252;">"${ENV}--${PROJECT}--${BUILD_NUMBER}"</span>

&#25110;&#32773;
currentBuild.displayName = <span style="color: #8b2252;">"${namespace} ${service_name} ${tags}"</span>
</pre>
</div>

<p>
staging-wa-2 service-admin 20220126_164557
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:9c468348-3120-4215-90d7-a405fae7a819" class="outline-5">
<h5 id="h:9c468348-3120-4215-90d7-a405fae7a819">可用插件语法</h5>
<div class="outline-text-5" id="text-h:9c468348-3120-4215-90d7-a405fae7a819">
</div>
<ul class="org-ul">
<li><a id="h:787702d4-fdbb-471b-9a8b-c52f5e1213fe"></a>User Build Vars获取构建用户<br>
<div class="outline-text-6" id="text-h:787702d4-fdbb-471b-9a8b-c52f5e1213fe">
<p>
<a href="https://plugins.jenkins.io/build-user-vars-plugin/">https://plugins.jenkins.io/build-user-vars-plugin/</a>
</p>

<div class="org-src-container">
<pre class="src src-shell">pipeline {
    agent any
    stages {
        stage(<span style="color: #8b2252;">'test'</span>) {
            steps {
                wrap([$<span style="color: #a0522d;">class</span>: <span style="color: #8b2252;">'BuildUser'</span>]) {
                    <span style="color: #a0522d;">BUILD_USER</span> = <span style="color: #8b2252;">"${env.BUILD_USER}"</span>             
                }
            }
        }
    }
}
</pre>
</div>
</div>
</li>
<li><a id="h:7035678c-7b6b-4b1d-af62-218cb3264f00"></a>Git Parameter选择git分支<br>
<div class="outline-text-6" id="text-h:7035678c-7b6b-4b1d-af62-218cb3264f00">
<p>
选择git分支
 <a href="https://plugins.jenkins.io/git-parameter/">https://plugins.jenkins.io/git-parameter/</a>
</p>

<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent any
  parameters {
    choice(name:<span style="color: #8b2252;">'GIT_ADDR'</span>,choices:<span style="color: #8b2252;">'git@git.ienglish.cn:chinese/chinese-parent-server.git'</span>,description:<span style="color: #8b2252;">''</span>)
    gitParameter branchFilter: <span style="color: #8b2252;">'origin/(.*)'</span>, defaultValue: <span style="color: #8b2252;">'master'</span>, name: <span style="color: #8b2252;">'GIT_BRANCH'</span>, type: <span style="color: #8b2252;">'PT_BRANCH'</span>, listSize: <span style="color: #8b2252;">'3'</span>, selectedValue: <span style="color: #8b2252;">'DEFAULT'</span>, sortMode: <span style="color: #8b2252;">'ASCENDING_SMART'</span>
  }
  stages {
    stage(<span style="color: #8b2252;">'Build'</span>) {
      steps {
        timestamps {
          // pull git code
          git branch:<span style="color: #8b2252;">"${GIT_BRANCH}"</span>,url:<span style="color: #8b2252;">"${GIT_ADDR}"</span>
        }
      }
    }
  }
} 
</pre>
</div>


<figure id="orgbd1fabb">
<img src="./images/img_20240717_004157.png" alt="img_20240717_004157.png" width="40%">

</figure>


<p>
重要的！如果您需要使用其他类型（除分支之外）参数，您必须在结帐时使用 git
</p>
</div>
</li>
<li><a id="h:8e623e51-ced9-44d0-96fe-b520d84470e7"></a>Timestamper构建任务执行时间<br>
<div class="outline-text-6" id="text-h:8e623e51-ced9-44d0-96fe-b520d84470e7">
<p>
<a href="https://plugins.jenkins.io/timestamper/">https://plugins.jenkins.io/timestamper/</a>
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">stage</span>(<span style="color: #8b2252;">'Build'</span>) {
    steps {
      timestamps {
        git branch:<span style="color: #8b2252;">"${GIT_BRANCH}"</span>,url:<span style="color: #8b2252;">"${GIT_ADDR}"</span>
      }
    }
}
</pre>
</div>
</div>
</li>
<li><a id="h:587694d6-c77e-4fcb-a2f0-21d9f3295d0a"></a>AnsiColor输出颜色<br>
<div class="outline-text-6" id="text-h:587694d6-c77e-4fcb-a2f0-21d9f3295d0a">
<p>
<a href="https://plugins.jenkins.io/timestamper/">https://plugins.jenkins.io/timestamper/</a>
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">stage</span>(<span style="color: #8b2252;">'Deploy'</span>) {
  steps {
    timestamps {
      // ansiColor &#36755;&#20986;&#39068;&#33394;
      ansiColor(<span style="color: #8b2252;">'xterm'</span>) {
        sh <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">              export ANSIBLE_FORCE_COLOR=true</span>
<span style="color: #8b2252;">              ansible-playbook  /etc/ansible/01deploy.yml  -e "</span><span style="color: #a0522d;">WORKSPACE</span>=${<span style="color: #a0522d;">WORKSPACE</span>} <span style="color: #8b2252;">\</span>
                  <span style="color: #a0522d;">SERVICE_HOSTS</span>=${<span style="color: #a0522d;">ServiceName</span>}-${<span style="color: #a0522d;">ENV</span>} <span style="color: #8b2252;">\</span>
                  <span style="color: #a0522d;">SERVICE_DIR</span>=${<span style="color: #a0522d;">SERVICE_DIR</span>} <span style="color: #8b2252;">\</span>
                  <span style="color: #a0522d;">SERVICE_NAME</span>=${<span style="color: #a0522d;">ServiceName</span>} <span style="color: #8b2252;">\</span>
                  <span style="color: #a0522d;">PORT</span>=${<span style="color: #a0522d;">PORT</span>} <span style="color: #8b2252;">\</span>
                  <span style="color: #a0522d;">TYPE</span>=${<span style="color: #a0522d;">TYPE</span>} <span style="color: #8b2252;">\</span>
                  <span style="color: #a0522d;">COMMAND</span>=<span style="color: #8b2252;">'${COMMAND}'" </span>
<span style="color: #8b2252;">        """</span>
      }
    }
  }   
}
</pre>
</div>



<figure id="orgbf40817">
<img src="./images/img_20240717_004408.png" alt="img_20240717_004408.png" width="40%">

</figure>
</div>
</li>
<li><a id="h:2a1f52e7-3f90-4b0e-8712-4575c1c32c9b"></a>DingTalk钉钉通知<br>
<div class="outline-text-6" id="text-h:2a1f52e7-3f90-4b0e-8712-4575c1c32c9b">
<p>
<a href="https://plugins.jenkins.io/dingding-notifications">https://plugins.jenkins.io/dingding-notifications</a>
</p>

<p>
(新版本需要在"系统设置中配置钉钉robotid")
</p>
<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent any
  parameters {
    booleanParam(name:<span style="color: #8b2252;">'dingding'</span>,defaultValue:false,description:<span style="color: #8b2252;">''</span>)
    // dingTalk 1.9&#29256;&#26412;
    // string(name:<span style="color: #8b2252;">'dingToken'</span>,defaultValue:<span style="color: #8b2252;">''</span>,description:<span style="color: #8b2252;">''</span>)
  }
  environment {
    // &#38025;&#38025;robotId
    <span style="color: #a0522d;">robotId</span> = <span style="color: #8b2252;">"5e808e23-40ed-4828-8ec6-111864d6cc41"</span>
  }

  stages {
    stage(<span style="color: #8b2252;">'&#24320;&#22987;&#26500;&#24314;&#36890;&#30693;'</span>){
        dingSend(<span style="color: #8b2252;">"&#24320;&#22987;&#26500;&#24314;"</span>)
        // &#28165;&#29702;&#24037;&#20316;&#31354;&#38388;
        cleanWs()
    }
  }
  post {
    // &#25104;&#21151;&#36890;&#30693;
    success {dingSend(<span style="color: #8b2252;">"&#26500;&#24314;&#25104;&#21151;"</span>)}
    // &#22833;&#36133;&#36890;&#30693;
    failure {dingSend(<span style="color: #8b2252;">"&#26500;&#24314;&#22833;&#36133;"</span>)}
  }
}
def dingSend(dMsg) { 
  // sh <span style="color: #8b2252;">'echo start'</span>;
  timestamps {
    <span style="color: #a020f0;">if</span> (params.dingding) {
      // dingTalk 1.9&#29256;&#26412;
      // dingTalk accessToken: <span style="color: #8b2252;">"https://oapi.dingtalk.com/robot/send?access_token=${dingToken}"</span>, jenkinsUrl: <span style="color: #8b2252;">"${env.BUILD_URL}"</span>, message: <span style="color: #8b2252;">"${dMsg} branch: ${GIT_BRANCH} by ${BUILD_USER} email: ${BUILD_USER_EMAIL}"</span>, notifyPeople: <span style="color: #8b2252;">"${notifyPeople}"</span>
      // dingTalk 2.3&#29256;&#26412;
      dingtalk (
          robot: <span style="color: #8b2252;">"${robotId}"</span>,
          <span style="color: #483d8b;">type</span>: <span style="color: #8b2252;">'ACTION_CARD'</span>,
          at:[],
          atAll: true,
          title: <span style="color: #8b2252;">"${env.JOB_BASE_NAME} ${dMsg}"</span>,
          text:[
            <span style="color: #8b2252;">"**** [${env.JOB_BASE_NAME} ${dMsg}](${env.JOB_URL})"</span>,
            <span style="color: #8b2252;">" 1. &#20219;&#21153;: [#${env.BUILD_NUMBER}](${env.BUILD_URL})"</span>,
            <span style="color: #8b2252;">" 2. &#29366;&#24577;&#65306;${dMsg}"</span>,
            <span style="color: #8b2252;">" 3. &#25345;&#32493;&#26102;&#38388;: ${currentBuild.durationString}"</span>,
            <span style="color: #8b2252;">" 4. ${dMsg} branch: ${GIT_BRANCH} by ${BUILD_USER} email: ${BUILD_USER_EMAIL}"</span>
          ],
          messageUrl: <span style="color: #8b2252;">"${env.BUILD_URL}"</span>,
          picUrl:<span style="color: #8b2252;">""</span>,
          singleTitle:<span style="color: #8b2252;">''</span>,
          btns: [
            [
                title: <span style="color: #8b2252;">'&#26500;&#24314;&#35760;&#24405;'</span>,
                actionUrl: <span style="color: #8b2252;">"${env.BUILD_URL}"</span>
            ],
            [
                title: <span style="color: #8b2252;">'&#25511;&#21046;&#21488;'</span>,
                actionUrl: <span style="color: #8b2252;">"${env.JENKINS_URL}"</span>
            ]
          ],
          btnLayout: <span style="color: #8b2252;">'H'</span>,
          hideAvatar: true
      )
    }
  }
}
</pre>
</div>


<figure id="orge96cfbc">
<img src="./images/img_20240717_004647.png" alt="img_20240717_004647.png" width="50%">

</figure>
</div>
</li>
<li><a id="h:4e2ba0a8-3c84-4ea2-91cd-9cefd9ba7137"></a>构建描述<br>
<div class="outline-text-6" id="text-h:4e2ba0a8-3c84-4ea2-91cd-9cefd9ba7137">
<p>
<a href="https://plugins.jenkins.io/build-name-setter/">Build Name and Description Setter</a>构建描述
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">buildDescription</span>(<span style="color: #8b2252;">"Branch: ${GIT_BRANCH} Committer: ${BUILD_USER}"</span>)
</pre>
</div>



<figure id="orgbaf1b57">
<img src="./images/img_20240717_004752.png" alt="img_20240717_004752.png" width="20%">

</figure>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:92cc7b8c-03a7-41d5-8d0c-96687a4885f2" class="outline-4">
<h4 id="h:92cc7b8c-03a7-41d5-8d0c-96687a4885f2">Scripted Pipeline（脚本式流水线）</h4>
<div class="outline-text-4" id="text-h:92cc7b8c-03a7-41d5-8d0c-96687a4885f2">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">//Jenkinsfile</span> (Scripted Pipeline)
node { 
  stage(<span style="color: #8b2252;">'Build'</span>) { 
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Build'</span>
  }
  stage(<span style="color: #8b2252;">'Test'</span>) { 
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Test'</span> 
  }
  stage(<span style="color: #8b2252;">'Deploy'</span>) { 
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Deploy'</span>
  }
}
</pre>
</div>

<ul class="org-ul">
<li>node：在任何可用的代理上执行流水线或它的任何阶段，也可以指定到具体的节点</li>
<li>stage：和声明式的含义一致，定义流水线的阶段。Stage 块在脚本化流水线语法中是可选的，然而在脚本化流水线中实现 stage 块，可以清楚地在Jenkins UI界面中显示每个stage的任务子集。</li>
</ul>


<p>
group/french/french-node.groovy
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">node</span>(<span style="color: #8b2252;">'tpln-jnlp'</span>) {

//  &#23450;&#20041;&#20840;&#23616;&#21464;&#37327;
    <span style="color: #a020f0;">if</span> (<span style="color: #a0522d;">ENV</span> == <span style="color: #8b2252;">'qa'</span>) {
        <span style="color: #a0522d;">K8S_NAMESPACES</span>=<span style="color: #8b2252;">'french-qa'</span>
        <span style="color: #a0522d;">DOCKER_IMAGE_NAMESPACES</span>=<span style="color: #8b2252;">'french-qa'</span>
        <span style="color: #a0522d;">KUBECONFIG</span>=<span style="color: #8b2252;">'/root/.kube/config-qa-bj'</span>
    }

    <span style="color: #a020f0;">if</span> (<span style="color: #a0522d;">ENV</span> == <span style="color: #8b2252;">'prod'</span>) {
        timeout(<span style="color: #483d8b;">time</span>: 5, unit: <span style="color: #8b2252;">'MINUTES'</span>){
            input message: <span style="color: #8b2252;">'&#26159;&#21542;&#21457;&#24067;&#25110;&#22238;&#28378;prod'</span>, ok: <span style="color: #8b2252;">'&#30830;&#35748;'</span>, submitter: <span style="color: #8b2252;">'guoyangchan,zhengxin'</span>
        }
        <span style="color: #a0522d;">K8S_NAMESPACES</span>=<span style="color: #8b2252;">'french-prod'</span>
        <span style="color: #a0522d;">DOCKER_IMAGE_NAMESPACES</span>=<span style="color: #8b2252;">'french-prod'</span>
        <span style="color: #a0522d;">KUBECONFIG</span>=<span style="color: #8b2252;">'/root/.kube/config'</span>
    }

//  &#21457;&#24067;&#20195;&#30721;
    <span style="color: #a020f0;">if</span> (<span style="color: #a0522d;">PROJECT</span> == <span style="color: #8b2252;">'release'</span>) {
            withCredentials([usernamePassword(credentialsId: <span style="color: #8b2252;">'docker_image'</span>, passwordVariable: <span style="color: #8b2252;">'password'</span>, usernameVariable: <span style="color: #8b2252;">'username'</span>)]) {
                sh <span style="color: #8b2252;">"docker login -u ${username} -p ${password} tope365-registry-vpc.cn-beijing.cr.aliyuncs.com"</span>
            }
            //  &#23450;&#20041;Build name
            stage(<span style="color: #8b2252;">'Initialization'</span>) {
                buildName <span style="color: #8b2252;">"${ENV}--${PROJECT}--${BUILD_NUMBER}"</span>
            }
            //  Pull&#20179;&#24211;&#20195;&#30721;
            stage(<span style="color: #8b2252;">'git-clone'</span>) {
                <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&#21457;&#24067;&#20998;&#25903;&#65306;${GIT_BRANCH}"</span>
                git branch: <span style="color: #8b2252;">"${GIT_BRANCH}"</span>, credentialsId: <span style="color: #8b2252;">'devops_git'</span>, url: <span style="color: #8b2252;">'git@git.ienglish.cn:${GIT_GROUP}/${GIT_NAME}.git'</span>
            }
            //  &#32534;&#35793;&#20195;&#30721;
            stage(<span style="color: #8b2252;">'node-build'</span>) {
                sh <span style="color: #8b2252;">"npm install &amp;&amp; npm run ${ENV}"</span>
            }
            //  &#32534;&#35793;Docker image
            stage(<span style="color: #8b2252;">'docker-build'</span>) {
            //  &#21028;&#26029;&#26159;&#21542;&#23384;&#22312;start&#30446;&#24405;&#24182;&#32534;&#35793;Docker
                sh <span style="color: #8b2252;">"docker build -t tope365-registry-vpc.cn-beijing.cr.aliyuncs.com/${DOCKER_IMAGE_NAMESPACES}/${JOB_NAME}:${BUILD_NUMBER} ."</span>
            }
            //  &#19978;&#20256;Docker image
            stage(<span style="color: #8b2252;">'docker-push'</span>) {
                sh <span style="color: #8b2252;">"docker push tope365-registry-vpc.cn-beijing.cr.aliyuncs.com/${DOCKER_IMAGE_NAMESPACES}/${JOB_NAME}:${BUILD_NUMBER}"</span>
            }
            //  &#26356;&#26032;K8S
            stage(<span style="color: #8b2252;">'k8s-update'</span>) {
                sh <span style="color: #8b2252;">"kubectl --kubeconfig ${KUBECONFIG} set image deployment/${JOB_NAME} -n ${K8S_NAMESPACES} ${JOB_NAME}=tope365-registry-vpc.cn-beijing.cr.aliyuncs.com/${DOCKER_IMAGE_NAMESPACES}/${JOB_NAME}:${BUILD_NUMBER}"</span>
            }
    }

//  &#22238;&#28378;&#20195;&#30721; 
    <span style="color: #a020f0;">if</span> (<span style="color: #a0522d;">PROJECT</span> == <span style="color: #8b2252;">'back'</span>) {
            stage(<span style="color: #8b2252;">'Initialization'</span>) {
                buildName <span style="color: #8b2252;">"${ENV}--${PROJECT}--${BACK_TAG}"</span>
            }

            <span style="color: #a020f0;">if</span> (<span style="color: #a0522d;">ENV</span> == <span style="color: #8b2252;">'prod'</span>) {
                stage(<span style="color: #8b2252;">'prod-back'</span>) {
                sh <span style="color: #8b2252;">"kubectl --kubeconfig ${KUBECONFIG} set image deployment/${JOB_NAME} -n ${K8S_NAMESPACES} ${JOB_NAME}=tope365-registry-vpc.cn-beijing.cr.aliyuncs.com/${DOCKER_IMAGE_NAMESPACES}/${JOB_NAME}:${BACK_TAG}"</span>
                }
            }

            <span style="color: #a020f0;">if</span> (<span style="color: #a0522d;">ENV</span> == <span style="color: #8b2252;">'qa'</span>) {
                stage(<span style="color: #8b2252;">'qa-back'</span>) {
                sh <span style="color: #8b2252;">"kubectl --kubeconfig ${KUBECONFIG} set image deployment/${JOB_NAME} -n ${K8S_NAMESPACES} ${JOB_NAME}=tope365-registry-vpc.cn-beijing.cr.aliyuncs.com/${DOCKER_IMAGE_NAMESPACES}/${JOB_NAME}:${BACK_TAG}"</span>
                }
            }

    }

}
</pre>
</div>

<p>
参考
<a href="https://www.cnblogs.com/fengjian2016/p/8227532.html">https://www.cnblogs.com/fengjian2016/p/8227532.html</a>
</p>
</div>
</div>
<div id="outline-container-h:a1854b88-3006-4489-9ea3-dcf3d45a7793" class="outline-4">
<h4 id="h:a1854b88-3006-4489-9ea3-dcf3d45a7793">groovy</h4>
<div class="outline-text-4" id="text-h:a1854b88-3006-4489-9ea3-dcf3d45a7793">
</div>
<div id="outline-container-h:6edd14b5-5954-4b2d-95a7-3889b60ff964" class="outline-5">
<h5 id="h:6edd14b5-5954-4b2d-95a7-3889b60ff964">k8s 发布</h5>
<div class="outline-text-5" id="text-h:6edd14b5-5954-4b2d-95a7-3889b60ff964">
</div>
<ul class="org-ul">
<li><a id="h:4bbaf42b-a8fb-4c3d-998b-26000f960a46"></a>从 prometheus 获取 k8s 信息<br>
<div class="outline-text-6" id="text-h:4bbaf42b-a8fb-4c3d-998b-26000f960a46">
<p>
用于 jenkins 参数构建
</p>

<p>
获取 deployment 信息，即service_name
</p>

<div class="org-src-container">
<pre class="src src-shell">/*
<span style="color: #a0522d;">service_name</span> = []

def <span style="color: #a0522d;">json</span> = <span style="color: #8b2252;">'{"service_namespace":"taskcenter"}'</span>

<span style="color: #a0522d;">text</span>= [<span style="color: #8b2252;">'bash'</span>, <span style="color: #8b2252;">'-c'</span>,<span style="color: #8b2252;">"curl  -X POST -H \"Content-Type:application/json\"   -d '${json}' http://47.74.244.216:9091/api/service_info/service/query"</span>].execute().text
text.eachLine {
 line, count -&gt;if (<span style="color: #a0522d;">count</span> == 0) {
  service_name.push(line+<span style="color: #8b2252;">':selected'</span>) 
}<span style="color: #a020f0;">else</span>{
<span style="color: #0000ff;">service_name.push</span>(line) 
}}
<span style="color: #a020f0;">return</span> service_name
*/

import groovy.json.JsonSlurperClassic
import jenkins.model.Jenkins

def parseJSON(json) {
  <span style="color: #a020f0;">return</span> new groovy.json.JsonSlurperClassic().parseText(json)
}

<span style="color: #a0522d;">response</span> = [<span style="color: #8b2252;">'bash'</span>, <span style="color: #8b2252;">'-c'</span>, <span style="color: #8b2252;">"curl -sS -G --data-urlencode 'query=kube_deployment_created{namespace=\"taskcenter\"}' 'http://prometheus.xxx.com/eks/api/v1/query'"</span>].execute().text
<span style="color: #a0522d;">response</span> = parseJSON(response)

<span style="color: #a0522d;">result</span> = []
<span style="color: #a020f0;">for</span> (data<span style="color: #a020f0;"> in</span> response.data.result.metric){
  <span style="color: #a0522d;">result</span> += data.deployment
}

<span style="color: #a020f0;">return</span> result
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:6244c4a7-8d05-43d4-86ec-160fc0437cf4" class="outline-5">
<h5 id="h:6244c4a7-8d05-43d4-86ec-160fc0437cf4">从 harbor 获取镜像 tag信息</h5>
<div class="outline-text-5" id="text-h:6244c4a7-8d05-43d4-86ec-160fc0437cf4">
<p>
传 deploy（service_name） 信息获取镜像 tag
</p>

<p>
api 接口：harbor登录进页面可找到<a href="https://harbor.xxxx.com/#/artifact/listArtifacts">https://harbor.xxxx.com/#/artifact/listArtifacts</a>
</p>

<div class="org-src-container">
<pre class="src src-shell">/*
<span style="color: #a0522d;">tag</span> = []
def <span style="color: #a0522d;">json</span> = <span style="color: #8b2252;">'{"service_namespace":"taskcenter","service_name":"'</span>+service_name+<span style="color: #8b2252;">'"}'</span>
println json

<span style="color: #a0522d;">text</span>= [<span style="color: #8b2252;">'bash'</span>, <span style="color: #8b2252;">'-c'</span>,<span style="color: #8b2252;">"curl  -X POST -H \"Content-Type:application/json\" -d '$json'    http://47.74.244.216:9091/api/service_info/tag/query"</span>].execute().text
text.eachLine {
 line, count -&gt;if (<span style="color: #a0522d;">count</span> == 0) {
 tag .push(line+<span style="color: #8b2252;">':selected'</span>) 
}<span style="color: #a020f0;">else</span>{
<span style="color: #0000ff;">tag.push</span>(line) 
}}

<span style="color: #a020f0;">return</span> tag 
*/


import groovy.json.JsonSlurperClassic
import jenkins.*
import jenkins.model.*
import hudson.*
import hudson.model.*

// JSON&#23454;&#20363;&#21270;
def parseJSON(json) {
    <span style="color: #a020f0;">return</span> new groovy.json.JsonSlurperClassic().parseText(json)
}

// &#33719;&#21462;Jenkins&#20973;&#35777;
def Credentials(credentials) {
    <span style="color: #a0522d;">jenkinsCredentials</span> = com.cloudbees.plugins.credentials.CredentialsProvider.lookupCredentials(
        com.cloudbees.plugins.credentials.Credentials.class,
        Jenkins.instance,
        null,
        null
    );
    <span style="color: #a020f0;">for</span> (creds<span style="color: #a020f0;"> in</span> jenkinsCredentials) {
        <span style="color: #a020f0;">if</span>(creds.id == credentials) {
            <span style="color: #a0522d;">result</span> = (<span style="color: #8b2252;">"${creds.username}:${creds.password}"</span>)
            <span style="color: #483d8b;">print</span>(result)
            <span style="color: #a020f0;">return</span> result
        }
    }
}

<span style="color: #a0522d;">project</span> = <span style="color: #8b2252;">'taskcenter'</span>

// &#33719;&#21462;Harbor&#38236;&#20687;
def Artifacts(projects, repos) {
    <span style="color: #a0522d;">urls</span> = <span style="color: #8b2252;">"https://harbor.xxx.com/api/v2.0/projects"</span>
    <span style="color: #a0522d;">conn</span> = <span style="color: #8b2252;">"${urls}/${project}/repositories/${service_name}/artifacts?project_name=${project}&amp;repository_name=${project}?&amp;page_size=20&amp;page=1"</span>
    <span style="color: #483d8b;">print</span>(conn)
    <span style="color: #a0522d;">http</span> = new URL(conn).openConnection()

    <span style="color: #a0522d;">users</span> = Credentials(<span style="color: #8b2252;">"harbor.xxx.com"</span>)
    <span style="color: #a0522d;">token</span> = <span style="color: #8b2252;">"Basic ${users.bytes.encodeBase64().toString()}"</span>;

    http.setRequestProperty(<span style="color: #8b2252;">"Authorization"</span>, token)
    http.setRequestMethod(<span style="color: #8b2252;">'GET'</span>)

    <span style="color: #a0522d;">result</span> = []
    <span style="color: #a0522d;">code</span> = http.getResponseCode()

    <span style="color: #a020f0;">if</span>(code.equals(200)) {
        // &#26684;&#24335;&#21270;json
        <span style="color: #a0522d;">response</span> = parseJSON(http.getInputStream().getText())
        // &#38236;&#20687;TAG&#21015;&#34920;
        <span style="color: #a020f0;">for</span> (project<span style="color: #a020f0;"> in</span> response){
            <span style="color: #a020f0;">for</span> (image<span style="color: #a020f0;"> in</span> project.tags){
            <span style="color: #a0522d;">result</span> += image.name
            }
        }
        <span style="color: #a020f0;">return</span> result
    }
}

<span style="color: #a0522d;">service_name</span> = service_name.replace(<span style="color: #8b2252;">"-2"</span>,<span style="color: #8b2252;">""</span>)
<span style="color: #a0522d;">service_name</span> = service_name.replace(<span style="color: #8b2252;">"-1"</span>,<span style="color: #8b2252;">""</span>)

<span style="color: #a020f0;">if</span> (<span style="color: #a0522d;">service_name</span> =~ <span style="color: #8b2252;">'^taskcenter-console-website'</span>) {
  <span style="color: #a0522d;">service_name</span> = <span style="color: #8b2252;">'taskcenter-website'</span>
} <span style="color: #a020f0;">else if</span> (<span style="color: #a0522d;">service_name</span> =~ <span style="color: #8b2252;">'^taskcenter-console-server'</span>) {
  <span style="color: #a0522d;">service_name</span> = <span style="color: #8b2252;">'taskcenter-server'</span>
} <span style="color: #a020f0;">else if</span> (<span style="color: #a0522d;">service_name</span> =~ <span style="color: #8b2252;">'^canal-*'</span>) {
  <span style="color: #a0522d;">project</span> = <span style="color: #8b2252;">'clevertap'</span>
}


<span style="color: #0000ff;">Artifacts</span>(project, service_name)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fcfc4970-b374-4638-98f7-122c7379c0fe" class="outline-5">
<h5 id="h:fcfc4970-b374-4638-98f7-122c7379c0fe">获取 gitlab 分支信息</h5>
<div class="outline-text-5" id="text-h:fcfc4970-b374-4638-98f7-122c7379c0fe">
<p>
构建参数 git_branch
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #a020f0;">if</span>(<span style="color: #a0522d;">namespace</span> == <span style="color: #8b2252;">'clevertap'</span>){
  <span style="color: #a020f0;">if</span> (<span style="color: #a0522d;">service_name</span> =~ <span style="color: #8b2252;">'canal*'</span>){
      def <span style="color: #a0522d;">gettags</span> = (<span style="color: #8b2252;">"git ls-remote -h git@xxx.com:gpchina/bj_dev/canal.git"</span>).execute()
      <span style="color: #a020f0;">return</span> gettags.text.readLines().collect { it.split()[1].replaceAll(<span style="color: #8b2252;">'refs/heads/'</span>, <span style="color: #8b2252;">''</span>)  }.unique()
  }
  <span style="color: #a020f0;">if</span> (<span style="color: #a0522d;">service_name</span> =~ <span style="color: #8b2252;">'clevertap-*'</span>){
      def <span style="color: #a0522d;">gettags</span> = (<span style="color: #8b2252;">"git ls-remote -h git@xxx.com:gpchina/bj_dev/xxx-fence.git"</span>).execute()
      <span style="color: #a020f0;">return</span> gettags.text.readLines().collect { it.split()[1].replaceAll(<span style="color: #8b2252;">'refs/heads/'</span>, <span style="color: #8b2252;">''</span>)  }.unique()
  }
} 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d9738758-060a-4095-88b8-cee5ee82c4a1" class="outline-5">
<h5 id="h:d9738758-060a-4095-88b8-cee5ee82c4a1">pipeline cd</h5>
<div class="outline-text-5" id="text-h:d9738758-060a-4095-88b8-cee5ee82c4a1">
<div class="org-src-container">
<pre class="src src-shell">pipeline {
    agent { node { label <span style="color: #8b2252;">'master'</span> } }
    environment {
        <span style="color: #a0522d;">project</span> = <span style="color: #8b2252;">"taskcenter"</span>

        <span style="color: #a0522d;">code_repo</span> = <span style="color: #8b2252;">"/data/jenkins/building/prod-k8s"</span>
        // kubernetes &#37197;&#32622;&#20179;&#24211;

        <span style="color: #a0522d;">code_path</span> = <span style="color: #8b2252;">"${code_repo}/${project}/${service_name}"</span>
        <span style="color: #a0522d;">eks_deploy_file</span> = <span style="color: #8b2252;">"${service_name}-deployment.yaml"</span>

        // &#38236;&#20687;&#20179;&#24211;
        <span style="color: #a0522d;">harbor_url</span> = <span style="color: #8b2252;">"harbor.xxx.com/${project}"</span>
    }

    stages {
        stage(<span style="color: #8b2252;">'clone code'</span>) {
            steps {
                script {
                    currentBuild.displayName = <span style="color: #8b2252;">"${project} ${service_name} ${tags}"</span>
                }
                dir(<span style="color: #8b2252;">"${code_repo}"</span>) {
                    deleteDir()
                    checkout([
                        $<span style="color: #a0522d;">class</span>: <span style="color: #8b2252;">"GitSCM"</span>,
                        branches: [[name: <span style="color: #8b2252;">"refs/heads/master"</span>]],
                        userRemoteConfigs: [[url: <span style="color: #8b2252;">"git@gitlab.com:gpchina/bj_dev/prod-k8s.git"</span>, credentialsId: <span style="color: #8b2252;">"988f4dd4-c04e-4dd0-8222-a9ddfc8522a8"</span>]]
                    ])
                }
            }
        }

        stage(<span style="color: #8b2252;">'docker image version'</span>) {
            steps {
                script {
                    env.name = sh(script: <span style="color: #8b2252;">"echo ${service_name} | sed -r 's/(-1|-2)//'"</span>, returnStdout:true).trim()

                    // &#38236;&#20687;&#21517;&#31216;
                    env.image_name = sh(
                        script: <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">                            #! /bin/sh</span>
<span style="color: #8b2252;">                                echo "</span>${<span style="color: #a0522d;">harbor_url</span>}/${<span style="color: #a0522d;">name</span>}<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">                        """</span>,
                        returnStdout:true
                    ).trim()



                    // &#38236;&#20687;TAG
                    env.image_tags = sh(
                        script: <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">                            #! /bin/sh</span>
<span style="color: #8b2252;">                            grep '${image_name}' ${code_path}/${eks_deploy_file} | grep -vE '[ ]+#' |awk '{print \$NF}'</span>
<span style="color: #8b2252;">                        """</span>,
                        returnStdout:true
                    ).trim()

                    // &#24046;&#24322;&#26381;&#21153;
                    <span style="color: #a020f0;">if</span> (<span style="color: #a0522d;">service_name</span> == <span style="color: #8b2252;">'taskcenter-console-website'</span>){
                        <span style="color: #a0522d;">code_path</span> = <span style="color: #8b2252;">"${code_repo}/${project}/taskcenter-website"</span>
                        <span style="color: #a0522d;">eks_deploy_file</span> = <span style="color: #8b2252;">"taskcenter-website-deployment.yaml"</span>
                        env.image_name = <span style="color: #8b2252;">"${harbor_url}/taskcenter-website"</span>
                        env.image_tags = sh(script: <span style="color: #8b2252;">"grep '${image_name}' ${code_path}/${eks_deploy_file} | grep -vE '[ ]+#' |awk '{print \$NF}'"</span>, returnStdout:true).trim()

                    } <span style="color: #a020f0;">else if</span> (<span style="color: #a0522d;">service_name</span> == <span style="color: #8b2252;">'taskcenter-console-server'</span>){
                        <span style="color: #a0522d;">code_path</span> = <span style="color: #8b2252;">"${code_repo}/${project}/taskcenter-server"</span>
                        <span style="color: #a0522d;">eks_deploy_file</span> = <span style="color: #8b2252;">"taskcenter-server-deployment.yaml"</span>
                        env.image_name = <span style="color: #8b2252;">"${harbor_url}/taskcenter-server"</span>
                        env.image_tags = sh(script: <span style="color: #8b2252;">"grep '${image_name}' ${code_path}/${eks_deploy_file} | grep -vE '[ ]+#' |awk '{print \$NF}'"</span>, returnStdout:true).trim()


                    } <span style="color: #a020f0;">else if</span> (<span style="color: #a0522d;">service_name</span> =~ <span style="color: #8b2252;">'canal-*'</span>){
                        env.image_name = <span style="color: #8b2252;">"harbor.xxx.com/clevertap/${service_name}"</span>
                        env.image_tags = sh(script: <span style="color: #8b2252;">"grep '${image_name}' ${code_path}/${eks_deploy_file} | grep -vE '[ ]+#' |awk '{print \$NF}'"</span>, returnStdout:true).trim()

                    } 
                }
            }
        }
        stage(<span style="color: #8b2252;">'Deployment Argo'</span>) {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: <span style="color: #8b2252;">'9ded0071-867a-4ba3-bb29-13d48cd2ba9a'</span>, keyFileVariable: <span style="color: #8b2252;">'SSH_KEY'</span>)]) {
                    sh <span style="color: #8b2252;">"""#! /bin/sh</span>
<span style="color: #8b2252;">                        ** set replicas</span>
<span style="color: #8b2252;">                        echo "</span>replicas: ${<span style="color: #a0522d;">replicas</span>}<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">                        if [ "</span>${<span style="color: #a0522d;">replicas</span>}<span style="color: #8b2252;">" != "" ]; then</span>
<span style="color: #8b2252;">                            # sed -i "</span>s#<span style="color: #ff00ff;">`grep 'replicas:' ${code_path}/${service_name}-deployment.yaml`</span><span style="color: #b22222;">#</span><span style="color: #b22222;">replicas: ${replicas}#" ${code_path}/${eks_deploy_file}</span>
                            sed -n <span style="color: #8b2252;">"s#`grep 'replicas:' ${code_path}/${service_name}-deployment.yaml`#replicas: ${replicas}#p"</span> ${<span style="color: #a0522d;">code_path</span>}/${<span style="color: #a0522d;">eks_deploy_file</span>}
                        <span style="color: #a020f0;">fi</span>

                        ** sed image
                        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"sed -i "</span>s#${<span style="color: #a0522d;">image_tags</span>}#${<span style="color: #a0522d;">image_name</span>}:${<span style="color: #a0522d;">tags</span>}#<span style="color: #8b2252;">" ${code_path}/${eks_deploy_file}"</span>
                        sed -i <span style="color: #8b2252;">"s#${image_tags}#${image_name}:${tags}#"</span> ${<span style="color: #a0522d;">code_path</span>}/${<span style="color: #a0522d;">eks_deploy_file</span>}

                        ** git commit
                        <span style="color: #a0522d;">GIT_SSH_COMMAND</span>=<span style="color: #8b2252;">"ssh -i ${SSH_KEY}"</span>
                        <span style="color: #483d8b;">cd</span> ${<span style="color: #a0522d;">code_path</span>}
                        git add ${<span style="color: #a0522d;">eks_deploy_file</span>}
                        git commit -m <span style="color: #8b2252;">"update ${eks_deploy_file}"</span>
                        git push origin HEAD:master
                    <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">                }</span>
<span style="color: #8b2252;">           }</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">    post {</span>
<span style="color: #8b2252;">        success {</span>
<span style="color: #8b2252;">            echo "</span>&#25191;&#34892;&#25104;&#21151;<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">//            dingtalk (</span>
<span style="color: #8b2252;">//                robot: "</span>755c351b-0330-4301-bcea-baabc6b309e6<span style="color: #8b2252;">",</span>
<span style="color: #8b2252;">//                type: "</span>MARKDOWN<span style="color: #8b2252;">",</span>
<span style="color: #8b2252;">//                text: [</span>
<span style="color: #8b2252;">//                    "</span>- &#26500;&#24314;&#39033;&#30446;: ${<span style="color: #a0522d;">service_name</span>}<span style="color: #8b2252;">",</span>
<span style="color: #8b2252;">//                    "</span>- &#38236;&#20687;&#29256;&#26412;: ${<span style="color: #a0522d;">image_name</span>}:${<span style="color: #a0522d;">tags</span>}<span style="color: #8b2252;">",</span>
<span style="color: #8b2252;">//                    "</span>- &#26500;&#24314;&#29366;&#24577;: &lt;font <span style="color: #a0522d;">color</span>=green&gt;&#25104;&#21151;&lt;/font&gt;<span style="color: #8b2252;">",</span>
<span style="color: #8b2252;">//                    "</span>- &#25345;&#32493;&#26102;&#38388;: ${<span style="color: #a0522d;">currentBuild</span>.durationString}<span style="color: #8b2252;">",</span>
<span style="color: #8b2252;">//                    "</span>- &#25805;&#20316;&#20154;&#21592;: ${<span style="color: #a0522d;">currentBuild</span>.buildCauses.shortDescription}<span style="color: #8b2252;">",</span>
<span style="color: #8b2252;">//                ],</span>
<span style="color: #8b2252;">//                atAll: false</span>
<span style="color: #8b2252;">//           )</span>
<span style="color: #8b2252;">        }</span>

<span style="color: #8b2252;">        failure {</span>
<span style="color: #8b2252;">            echo "</span>&#25191;&#34892;&#22833;&#36133;<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">//            dingtalk (</span>
<span style="color: #8b2252;">//                robot: "</span>755c351b-0330-4301-bcea-baabc6b309e6<span style="color: #8b2252;">",</span>
<span style="color: #8b2252;">//                type: "</span>MARKDOWN<span style="color: #8b2252;">",</span>
<span style="color: #8b2252;">//                text: [</span>
<span style="color: #8b2252;">//                    "</span>- &#26500;&#24314;&#39033;&#30446;: ${<span style="color: #a0522d;">service_name</span>}<span style="color: #8b2252;">",</span>
<span style="color: #8b2252;">//                    "</span>- &#38236;&#20687;&#29256;&#26412;: ${<span style="color: #a0522d;">image_name</span>}:${<span style="color: #a0522d;">tags</span>}<span style="color: #8b2252;">",</span>
<span style="color: #8b2252;">//                    "</span>- &#26500;&#24314;&#29366;&#24577;: &lt;font <span style="color: #a0522d;">color</span>=red&gt;&#22833;&#36133;&lt;/font&gt;<span style="color: #8b2252;">",</span>
<span style="color: #8b2252;">//                    "</span>- &#25345;&#32493;&#26102;&#38388;: ${<span style="color: #a0522d;">currentBuild</span>.durationString}<span style="color: #8b2252;">",</span>
<span style="color: #8b2252;">//                    "</span>- &#25805;&#20316;&#20154;&#21592;: ${<span style="color: #a0522d;">currentBuild</span>.buildCauses.shortDescription}<span style="color: #8b2252;">",</span>
<span style="color: #8b2252;">//                ],</span>
<span style="color: #8b2252;">//                atAll: false</span>
<span style="color: #8b2252;">//           )</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:008afd5d-6a12-40e0-b900-f4fe6e04730b" class="outline-5">
<h5 id="h:008afd5d-6a12-40e0-b900-f4fe6e04730b">pipline ci</h5>
<div class="outline-text-5" id="text-h:008afd5d-6a12-40e0-b900-f4fe6e04730b">
<div class="org-src-container">
<pre class="src src-shell">pipeline{
    agent { node { label <span style="color: #8b2252;">'production'</span> } }
    environment {

        <span style="color: #a0522d;">GIT_URL_DIR</span> = <span style="color: #8b2252;">""</span>
        // namespace, service_name, git_address, git_branch &#30001;&#26500;&#24314;&#21442;&#25968;&#25552;&#20379;

        // &#38236;&#20687;&#22320;&#22336;
        <span style="color: #a0522d;">harbor_url</span> = <span style="color: #8b2252;">"harbor.xxx.com"</span>

        // &#20195;&#30721;&#20301;&#32622;
        <span style="color: #a0522d;">code_path</span>=<span style="color: #8b2252;">"/devops/k8s-ci-build/staging/${namespace}/${service_name}"</span>
        // &#21046;&#20316;&#38236;&#20687;&#20301;&#32622;
        <span style="color: #a0522d;">dockerfile_document</span>=<span style="color: #8b2252;">"/devops/k8s-stg/${namespace}/${service_name}"</span>
        // k8s &#37197;&#32622;
        <span style="color: #a0522d;">build_path</span> = <span style="color: #8b2252;">"/devops/dev-k8s"</span>
        <span style="color: #a0522d;">kubernetes</span> = <span style="color: #8b2252;">"${build_path}/${namespace}/${service_name}/kubernetes"</span>
    }

    stages {
        stage(<span style="color: #8b2252;">'git-clone'</span>) {
            //  &#23450;&#20041;Build name &amp;&amp; Pull&#20179;&#24211;&#20195;&#30721;
            steps {
                script {
                    // &#38236;&#20687;&#26631;&#31614;
                    <span style="color: #a0522d;">tags</span> = sh(script: <span style="color: #8b2252;">"date '+%Y%m%d_%H%M%S'"</span>, returnStdout: true).trim()
                    // &#38236;&#20687;&#21517;&#31216;
                    <span style="color: #a0522d;">image_name</span> = <span style="color: #8b2252;">"${harbor_url}/${namespace}/${service_name}:${tags}"</span>
                    // &#26500;&#24314;&#21517;&#31216;
                    currentBuild.displayName = <span style="color: #8b2252;">"${namespace} ${service_name} ${tags}"</span>
                    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&#21517;&#31216;&#31354;&#38388;&#65306;${namespace} &#26381;&#21153;&#21517;&#65306;${service_name} &#38236;&#20687; tag&#65306;${tags} &#21457;&#24067;&#20998;&#25903;&#65306;${git_branch}"</span>

                    // code 
                    dir(<span style="color: #8b2252;">"${code_path}"</span>) {
                        deleteDir()
                        checkout([
                            $<span style="color: #a0522d;">class</span>: <span style="color: #8b2252;">"GitSCM"</span>,
                            branches: [[name: <span style="color: #8b2252;">"refs/heads/${git_branch}"</span>]],
                            userRemoteConfigs: [[url: <span style="color: #8b2252;">"${git_address}"</span>, credentialsId: <span style="color: #8b2252;">"a7adfe2c-5e46-4162-818a-eb2133dedf2d"</span>]]
                        ])
                    }
                    // k8s yaml
                    dir(<span style="color: #8b2252;">"${build_path}"</span>) {
                        //deleteDir()
                        checkout([
                            $<span style="color: #a0522d;">class</span>: <span style="color: #8b2252;">"GitSCM"</span>,
                            branches: [[name: <span style="color: #8b2252;">"refs/heads/jizheng"</span>]],
                            userRemoteConfigs: [[url: <span style="color: #8b2252;">"git@gitlab.com:gpchina/bj_dev/dev-k8s.git"</span>, credentialsId: <span style="color: #8b2252;">"a7adfe2c-5e46-4162-818a-eb2133dedf2d"</span>]]
                        ])
                    }
                }    
            }
        }

        //  &#32534;&#35793;&#20195;&#30721;
        stage(<span style="color: #8b2252;">'node-build'</span>) {
            steps{
                script{
                    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"${code_path}"</span>
                    switch(<span style="color: #8b2252;">"$namespace"</span>) {
                    <span style="color: #a020f0;">case</span> <span style="color: #8b2252;">"poker"</span>:
                        <span style="color: #a020f0;">if</span> ( <span style="color: #a0522d;">service_name</span> == <span style="color: #8b2252;">"poker-cms-site"</span> ) {

                        sh <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">                            rm -rf  ${dockerfile_document}/${service_name}</span>

<span style="color: #8b2252;">                            #sudo cp -a /devops/k8s-ci-build/poker-cms-site /devops/k8s-stg/poker/poker-cms-site/poker-cms-site</span>
<span style="color: #8b2252;">                            cd /devops/k8s-ci-build/poker-cms-site</span>
<span style="color: #8b2252;">                            npm install --registry=https://registry.npm.taobao.org</span>
<span style="color: #8b2252;">                            npm run build</span>
<span style="color: #8b2252;">                            sudo cp -a dist ${dockerfile_document}/</span>
<span style="color: #8b2252;">                            """</span>
                        }
                        <span style="color: #a020f0;">else</span> {
                        sh <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">                        cd ${code_path}</span>
<span style="color: #8b2252;">                         /usr/maven/bin/mvn clean package -P stg -Dmaven.test.skip=true</span>
<span style="color: #8b2252;">                        sudo rm -rf /devops/k8s-stg/poker/${service_name}/${service_name}</span>
<span style="color: #8b2252;">                        sudo mv build/${service_name} /devops/k8s-stg/poker/${service_name}/</span>
<span style="color: #8b2252;">                        """</span>
                        }
                    default:
                        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"************ wrong Job name ************"</span>
                        sh <span style="color: #8b2252;">"exit 127"</span>
                    <span style="color: #a020f0;">break</span>
                    }
                }
            }       
        }


        //  &#32534;&#35793; Docker image
        stage(<span style="color: #8b2252;">'docker-build'</span>) {
            steps {
                //withCredentials([usernamePassword(credentialsId: <span style="color: #8b2252;">'docker_image'</span>, passwordVariable: <span style="color: #8b2252;">'password'</span>, usernameVariable: <span style="color: #8b2252;">'username'</span>)]) {
                //    sh <span style="color: #8b2252;">"docker login -u ${username} -p ${password} ${harbor_url}"</span>
                //}   
                dir(<span style="color: #8b2252;">"${dockerfile_document}"</span>) {
                    sh <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">                       echo "</span>&#32534;&#35793; Docker image<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">                       docker build -t ${image_name} .</span>
<span style="color: #8b2252;">                    """</span>
                }
            }
        }
        //  &#19978;&#20256; Docker image
        stage(<span style="color: #8b2252;">'docker-push'</span>) {
            steps {
                sh <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">                  echo "</span>&#19978;&#20256; Docker image<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">                  docker push ${image_name}</span>
<span style="color: #8b2252;">                """</span>
            }
        }
        // &#21024;&#38500;&#26412;&#22320;&#38236;&#20687;
        stage(<span style="color: #8b2252;">'docker-image-del-local'</span>) {
            steps {
                sh <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">                  echo "</span>&#21024;&#38500;&#26412;&#22320;&#38236;&#20687;<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">                  docker rmi ${image_name}</span>
<span style="color: #8b2252;">                """</span>
            }
        }
        // &#26356;&#26032; K8S
        stage(<span style="color: #8b2252;">'k8s-update'</span>) {
            steps {
                script {
                    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&#26356;&#26032; K8S"</span>
                    <span style="color: #a020f0;">if</span> (<span style="color: #a0522d;">namespace</span> == <span style="color: #8b2252;">"staging-poker"</span> || <span style="color: #a0522d;">namespace</span> == <span style="color: #8b2252;">"staging-callbreak"</span>) {
                        sh <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">                            ssh 172.21.39.68 "</span>python3 /home/scripts/updatp_deployment_image.py ${<span style="color: #a0522d;">namespace</span>} ${<span style="color: #a0522d;">service_name</span>} ${<span style="color: #a0522d;">image_name</span>}<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">                        """</span>
                    } <span style="color: #a020f0;">else</span> {
                        sh <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">                            ssh 172.21.39.68 "</span>kubectl -n ${<span style="color: #a0522d;">namespace</span>} <span style="color: #483d8b;">set</span> image deployment/${<span style="color: #a0522d;">service_name</span>} ${<span style="color: #a0522d;">service_name</span>}=${<span style="color: #a0522d;">image_name</span>}<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">                        """</span>
                    }
                }
            }
        }

        // old flask
        // stage(<span style="color: #8b2252;">'k8s update deployment image'</span>) {
        //     steps { 
        //        sh <span style="color: #8b2252;">"""curl  -X POST -H "</span>Content-Type:application/json<span style="color: #8b2252;">"  -d '{"</span>namespace<span style="color: #8b2252;">":"</span>${<span style="color: #a0522d;">namespace</span>}<span style="color: #8b2252;">","</span>deployment<span style="color: #8b2252;">":"</span>${<span style="color: #a0522d;">service_name</span>}<span style="color: #8b2252;">","</span>new_tag<span style="color: #8b2252;">":"</span>${<span style="color: #a0522d;">tag</span>}<span style="color: #8b2252;">"}' 'http://127.0.0.1:9092/api/update_deployment'"""</span>
        // }


    }

    post {
        success { <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'&#26500;&#24314;&#25104;&#21151;'</span> }
        failure { <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'&#26500;&#24314;&#22833;&#36133;'</span> }
    }
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:1b58ad70-1d68-4c83-a7d6-4622f97c07c2" class="outline-4">
<h4 id="h:1b58ad70-1d68-4c83-a7d6-4622f97c07c2">jenkins 安装</h4>
<div class="outline-text-4" id="text-h:1b58ad70-1d68-4c83-a7d6-4622f97c07c2">
<ol class="org-ol">
<li>下载地址</li>
</ol>

<p>
www.jenkins.io/download
</p>

<p>
mirrors.jenkins.io/war-stable/   2.222.4
</p>

<ol class="org-ol">
<li>安装java 1.8</li>
</ol>


<ol class="org-ol">
<li>install</li>
</ol>

<div class="org-src-container">
<pre class="src src-shell">java -jar jenkins.war --httpPort=28080 &amp;
</pre>
</div>

<p>
浏览器访问：<a href="http://ip:28080">http://ip:28080</a>
</p>

<p>
安装插件：
</p>

<p>
&gt; Active Choices Plug-in
&gt;
&gt; Blue Ocean
&gt;
&gt; Blue Ocean Core JS
&gt;
&gt; Blue Ocean Executor Info
&gt;
&gt; Blue Ocean Pipeline Editor
&gt;
&gt; Build Pipline Plugin
&gt;
&gt; Credentials Binding Plugin
&gt;
&gt; Credentials Plugin
&gt;
&gt; Dashboard for Blue Ocean
&gt;
&gt; Declarative Pipline Migration Assistant
&gt;
&gt; Declarative Pipline Migration Assistant API
&gt;
&gt; Display URL API
&gt;
&gt; Display URL for Blue Ocean
&gt;
&gt; Git Parameter Plug-In
&gt;
&gt; Hidden Parameter  plugin
&gt;
&gt; Kubernetes CLI Plugin
&gt;
&gt; Kubernetes  Plugin
&gt;
&gt; List Git Branches Parameter   PlugIn
&gt;
&gt; Parameterized Remote Trigger Plugin
&gt;
&gt; Parameterized Trigger Plugin
&gt;
&gt; Pipeline
</p>
</div>
</div>
<div id="outline-container-h:3edf1068-85c0-4f20-bfaa-a5f07376ea89" class="outline-4">
<h4 id="h:3edf1068-85c0-4f20-bfaa-a5f07376ea89">Jenkinsfile 的使用</h4>
<div class="outline-text-4" id="text-h:3edf1068-85c0-4f20-bfaa-a5f07376ea89">
<p>
上面讲过流水线支持两种语法，即声明式和脚本式，这两种语法都支持构建持续交付流水线。并且都可以用来在 Web UI 或 Jenkinsfile 中定义流水线，不过通常将 Jenkinsfile 放置于代码仓库中（当然也可以放在单独的代码仓库中进行管理）。
</p>

<p>
创建一个 Jenkinsfile 并将其放置于代码仓库中，有以下好处：
</p>
<ul class="org-ul">
<li>方便对流水线上的代码进行复查/迭代</li>
<li>对管道进行审计跟踪</li>
<li>流水线真正的源代码能够被项目的多个成员查看和编辑</li>
</ul>
</div>
<div id="outline-container-h:46361cf9-8321-47cd-a872-4fa6eb192c6d" class="outline-5">
<h5 id="h:46361cf9-8321-47cd-a872-4fa6eb192c6d">环境变量</h5>
<div class="outline-text-5" id="text-h:46361cf9-8321-47cd-a872-4fa6eb192c6d">
<p>
<b>1.静态变量</b>
</p>

<p>
Jenkins有许多内置变量可以直接在Jenkinsfile中使用，可以通过 `sh "env"` 获取完整列表。目前比较常用的环境变量如下
</p>
<ul class="org-ul">
<li>BUILD_ID：当前构建的ID，与Jenkins版本 1.597+中的BUILD_NUMBER完全相同</li>
<li>BUILD_NUMBER：当前构建的 ID，和BUILD_ID一致</li>
<li>BUILD_TAG：用来标识构建的版本号，格式为：jenkins-\({JOB_NAME}-\){BUILD_NUMBER}， 可以对产物进行命名，比如生产的jar包名字、镜像的TAG等；</li>
<li>BUILD_URL：本次构建的完整 URL，比如：<a href="http://buildserver/jenkins/job/MyJobName/17/">http://buildserver/jenkins/job/MyJobName/17/</a>；</li>
<li>JOB_NAME：本次构建的项目名称</li>
<li>NODE_NAME：当前构建节点的名称；</li>
<li>JENKINS_URL：Jenkins 完整的 URL，需要在SystemConfiguration设置；</li>
<li>WORKSPACE：执行构建的工作目录。</li>
</ul>

<p>
示例如果一个流水线名称为print_env，第2次构建，各个变量的值。
</p>

<div class="org-src-container">
<pre class="src src-shell">BUILD_ID&#65306; 2
BUILD_NUMBER&#65306; 2
BUILD_TAG&#65306;jenkins-print_env-2
BUILD_URL&#65306;http://192.168.10.16:8080/job/print_env/2/
JOB_NAME&#65306;print_env
NODE_NAME&#65306;built-in
JENKINS_URL&#65306;http://192.168.10.16:8080/
WORKSPACE&#65306;/bitnami/jenkins/home/workspace/print_env
</pre>
</div>

<p>
上述变量会保存在一个Map中，可以使用env.BUILD_ID或env.JENKINS_URL引用某个内置变量
</p>
<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent any
  stages {
    stage(<span style="color: #8b2252;">'print env'</span>) {
      parallel {
        stage(<span style="color: #8b2252;">'BUILD_ID'</span>) {
          steps {
            <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$env.BUILD_ID"</span>
          }
        }
        stage(<span style="color: #8b2252;">'BUILD_NUMBER'</span>) {
          steps {
            <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$env.BUILD_NUMBER"</span>
          }
        }
        stage(<span style="color: #8b2252;">'BUILD_TAG'</span>) {
          steps {
            <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$env.BUILD_TAG"</span>
          }
        }
      }
    } 
  }
}
</pre>
</div>

<p>
<b>2.动态变量</b>
</p>

<p>
动态变量是根据某个指令的结果进行动态赋值，变量的值根据指令的执行结果而不同。如下所示
</p>
<ul class="org-ul">
<li>returnStdout：将命令的执行结果赋值给变量，比如下述的命令返回的是clang，此时 CC 的值为“clang”。</li>
<li>returnStatus：将命令的执行状态赋值给变量，比如下述命令的执行状态为 1，此时 EXIT_STATUS 的值为 1。</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">//Jenkinsfile</span> (Declarative Pipeline)
pipeline {
  agent any 
  environment {
    // &#20351;&#29992; returnStdout
    <span style="color: #a0522d;">CC</span> = <span style="color: #8b2252;">"""${sh(</span>
<span style="color: #8b2252;">         returnStdout: true,</span>
<span style="color: #8b2252;">         script: 'echo -n "</span>clang<span style="color: #8b2252;">"'   //&#22914;&#26524;&#20351;&#29992;shell&#21629;&#20196;&#30340;echo&#36171;&#20540;&#21464;&#37327;&#26368;&#22909;&#21152;-n&#21462;&#28040;&#25442;&#34892;</span>
<span style="color: #8b2252;">         )}"""</span> 
    // &#20351;&#29992; returnStatus
    <span style="color: #a0522d;">EXIT_STATUS</span> = <span style="color: #8b2252;">"""${sh(</span>
<span style="color: #8b2252;">         returnStatus: true,</span>
<span style="color: #8b2252;">         script: 'exit 1'</span>
<span style="color: #8b2252;">         )}"""</span>
  }
  stages {
    stage(<span style="color: #8b2252;">'Example'</span>) {
      environment {
        <span style="color: #a0522d;">DEBUG_FLAGS</span> = <span style="color: #8b2252;">'-g'</span>
      }
      steps {
        sh <span style="color: #8b2252;">'printenv'</span>
      }
    }
  }
}
</pre>
</div>



<p>
获取git commit短ID和时间戳
</p>

<div class="org-src-container">
<pre class="src src-shell">pipeline {
    agent any
    stages {
        stage(<span style="color: #8b2252;">'docker build &amp; push'</span>) {
            steps {
                script {
                    env.COMMIT_ID = sh(returnStdout: true, script: <span style="color: #8b2252;">"git log -n 1 --pretty=format:'%h'"</span>).trim()
                    env.TIMESTRAP = sh(returnStdout: true, script: <span style="color: #8b2252;">'date +%Y%m%d%H%M%S'</span>).trim()
                    env.DOCKER_TAG = <span style="color: #8b2252;">"dev_${TIMESTRAP}_${COMMIT_ID}_${BUILD_NUMBER}"</span>
                }
            }
        }
    }
}
</pre>
</div>


<p>
commit短ID变量
</p>

<p>
#+beigin_src shell
stage('get_commit_msg') {
    steps {
        script {
              env.imageTag = sh (script: 'git rev-parse &#x2013;short HEAD ${GIT_COMMIT}', returnStdout: true).trim()
            }   
       }
}
#+end_src
</p>
</div>
</div>
<div id="outline-container-h:20b4307d-f61c-4fd5-ae80-76811f5dbceb" class="outline-5">
<h5 id="h:20b4307d-f61c-4fd5-ae80-76811f5dbceb">凭证管理</h5>
<div class="outline-text-5" id="text-h:20b4307d-f61c-4fd5-ae80-76811f5dbceb">
<p>
Jenkins 的声明式流水线语法有一个 credentials()函数，它支持 secret text（加密文本）、username 和 password（用户名和密码）以及 secret file（加密文件）等。接下来看一下一些常用的凭证处理方法。
</p>

<p>
<b>1.加密文本</b>
</p>

<p>
本实例演示将两个 Secret 文本凭证分配给单独的环境变量来访问 Amazon Web 服务，需要 提前创建这两个文件的 credentials（实践的章节会有演示），Jenkinsfile 文件的内容如下
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">//Jenkinsfile</span> (Declarative Pipeline)
pipeline {
  agent any
  environment {
    <span style="color: #a0522d;">AWS_ACCESS_KEY_ID</span> = credentials(<span style="color: #8b2252;">'txt1'</span>)
    <span style="color: #a0522d;">AWS_SECRET_ACCESS_KEY</span> = credentials(<span style="color: #8b2252;">'txt2'</span>)
  }
  stages {
    stage(<span style="color: #8b2252;">'Example stage 1'</span>) {
      steps { 
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$AWS_ACCESS_KEY_ID"</span>
      }
    }
    stage(<span style="color: #8b2252;">'Example stage 2'</span>) {
      steps {
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$AWS_SECRET_ACCESS_KEY"</span>  
      }
    }
  }
}
</pre>
</div>

<p>
<b>2.用户名密码</b>
</p>

<p>
本示例用来演示 credentials 账号密码的使用，比如使用一个公用账户访问Bitbucket、GitLab、 Harbor 等。假设已经配置完成了用户名密码形式的 credentials，凭证ID为harbor-account
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">//Jenkinsfile</span> (Declarative Pipeline)
pipeline {
  agent any
  environment {
    <span style="color: #a0522d;">BITBUCKET_COMMON_CREDS</span> = credentials(<span style="color: #8b2252;">'harbor-account'</span>)
  }
  stages {
    stage(<span style="color: #8b2252;">'printenv'</span>) {
      steps { 
        sh <span style="color: #8b2252;">"env"</span>
      }
    }
}
</pre>
</div>

<p>
上述的配置会自动生成3个环境变量
</p>
<ul class="org-ul">
<li>BITBUCKET_COMMON_CREDS：包含一个以冒号分隔的用户名和密码，格式为 username:password</li>
<li>BITBUCKET_COMMON_CREDS_USR：仅包含用户名的附加变量</li>
<li>BITBUCKET_COMMON_CREDS_PSW：仅包含密码的附加变量。</li>
</ul>

<p>
<b>3.加密文件</b>
</p>

<p>
需要加密保存的文件，也可以使用 credential，比如链接到 Kubernetes 集群的 kubeconfig 文件等。
</p>

<p>
假如已经配置好了一个kubeconfig文件，此时可以在Pipeline中引用该文件
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #0000ff;">//Jenkinsfile</span> (Declarative Pipeline)
pipeline {
  agent {
    kubernetes {
      cloud <span style="color: #8b2252;">'kubernetes'</span>
      slaveConnectTimeout 1200
      workspaceVolume emptyDirWorkspaceVolume()
      yaml <span style="color: #8b2252;">'''</span>
<span style="color: #8b2252;">kind: Pod</span>
<span style="color: #8b2252;">metadata:</span>
<span style="color: #8b2252;">  name: jenkins-agent</span>
<span style="color: #8b2252;">spec:</span>
<span style="color: #8b2252;">  containers:</span>
<span style="color: #8b2252;">  - args: [\'</span>$(JENKINS_SECRET)<span style="color: #8b2252;">\'</span>, <span style="color: #8b2252;">\'</span>$(JENKINS_NAME)<span style="color: #8b2252;">\'</span>]
    image: <span style="color: #8b2252;">'192.168.10.15/kubernetes/jnlp:alpine'</span>
    name: jnlp
    imagePullPolicy: IfNotPresent
  - command:
      - <span style="color: #8b2252;">"cat"</span>
    image: <span style="color: #8b2252;">"192.168.10.15/kubernetes/kubectl:apline"</span>
    imagePullPolicy: <span style="color: #8b2252;">"IfNotPresent"</span>
    name: <span style="color: #8b2252;">"kubectl"</span>
    tty: true
  restartPolicy: Never
<span style="color: #8b2252;">'''</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">  }</span>
<span style="color: #8b2252;">  environment {</span>
<span style="color: #8b2252;">    MY_KUBECONFIG = credentials('</span>kubernetes-cluster<span style="color: #8b2252;">')</span>
<span style="color: #8b2252;">  }</span>
<span style="color: #8b2252;">  stages {</span>
<span style="color: #8b2252;">    stage('</span>kubectl<span style="color: #8b2252;">') {</span>
<span style="color: #8b2252;">      steps {</span>
<span style="color: #8b2252;">        container(name: '</span>kubectl<span style="color: #8b2252;">') {</span>
<span style="color: #8b2252;">          sh """</span>
<span style="color: #8b2252;">            kubectl get pod -A  --kubeconfig $MY_KUBECONFIG</span>
<span style="color: #8b2252;">          """</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">      }</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">  }</span>
<span style="color: #8b2252;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a820730a-fcdb-4223-a5c2-2139761031a7" class="outline-5">
<h5 id="h:a820730a-fcdb-4223-a5c2-2139761031a7">参数处理</h5>
<div class="outline-text-5" id="text-h:a820730a-fcdb-4223-a5c2-2139761031a7">
</div>
</div>
<div id="outline-container-h:1e9fd387-432f-4fe1-bddb-78ec90b5e3b7" class="outline-5">
<h5 id="h:1e9fd387-432f-4fe1-bddb-78ec90b5e3b7">使用多个代理</h5>
<div class="outline-text-5" id="text-h:1e9fd387-432f-4fe1-bddb-78ec90b5e3b7">
</div>
</div>
</div>
<div id="outline-container-h:d081a3ba-57f6-430c-9917-770fd7e40055" class="outline-4">
<h4 id="h:d081a3ba-57f6-430c-9917-770fd7e40055">DevOps 平台建设</h4>
<div class="outline-text-4" id="text-h:d081a3ba-57f6-430c-9917-770fd7e40055">
</div>
<div id="outline-container-h:ae9c7a73-eefb-442d-bf63-fe11793211d9" class="outline-5">
<h5 id="h:ae9c7a73-eefb-442d-bf63-fe11793211d9">自动化构建流水线设计</h5>
<div class="outline-text-5" id="text-h:ae9c7a73-eefb-442d-bf63-fe11793211d9">

<figure id="orge764830">
<img src="./images/Snipaste_2023-01-01_06-56-29.png" alt="Snipaste_2023-01-01_06-56-29.png">

</figure>

<ul class="org-ul">
<li>gitlab 代码仓库创建项目</li>
<li>配置 jenkins 集成 kubernetes 集群，后期 Jenkins 的 salve 将 kubernetes 中动态创建 slave</li>
<li>jenkins 创建对应任务（job），集成该项目的 git 地址和 kubernetes 集群。</li>
<li>开发者将代码提交到 gitlab</li>
<li>如果配置了钩子，推送（push） 代码会自动触发 jenkins 构建，如果没有钩子，需要手动构建。</li>
<li>jenkins 控制 Kubernetes 集群（使用的是 kubernetes 插件）创建 jenkins slave（pod 形式）</li>
<li>jenkins slave 根据流水线（pipline） 定义步骤执行构建</li>
<li>通过 Dockerfile 生成镜像</li>
<li>将镜像推送（push） 到私有 harbor （或者其它镜像仓库）</li>
<li>jenkins  再次控制 kubernetes 进行最新的镜像部署</li>
<li>流水线结束删除 jenkins slave</li>
</ul>
</div>
</div>
<div id="outline-container-h:cbc4dcb7-2a05-40e3-a595-99def0067710" class="outline-5">
<h5 id="h:cbc4dcb7-2a05-40e3-a595-99def0067710">jenkins 安装</h5>
<div class="outline-text-5" id="text-h:cbc4dcb7-2a05-40e3-a595-99def0067710">
</div>
<ul class="org-ul">
<li><a id="h:5c526f45-85b0-40de-95e9-f458f9e21fa7"></a>通过容器部署jenkins<br>
<div class="outline-text-6" id="text-h:5c526f45-85b0-40de-95e9-f458f9e21fa7">
<p>
需事先部署docker服务。
</p>

<p>
jenkins的镜像仓库：<a href="https://hub.docker.com/r/bitnami/jenkins">https://hub.docker.com/r/bitnami/jenkins</a>
</p>

<p>
官方的镜像仓库以及停止更新了。
</p>

<p>
下载jenkins镜像
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#36873;&#25321;debian&#30340;&#38236;&#20687;&#65292;&#21542;&#21017;&#27809;&#26377;ssh&#21629;&#20196;</span>
docker pull bitnami/jenkins:2.332.2-debian-10-r29
</pre>
</div>

<p>
创建数据目录
</p>
<div class="org-src-container">
<pre class="src src-shell">mkdir /data/jenkins_data -p
chmod -R 777 /data/jenkins_data

docker run -d --name=jenkins --restart=always -e <span style="color: #8b2252;">\</span>
<span style="color: #a0522d;">JENKINS_PASSWORD</span>=admin123 -e <span style="color: #a0522d;">JENKINS_USERNAME</span>=admin -e <span style="color: #8b2252;">\</span>
<span style="color: #a0522d;">JENKINS_HTTP_PORT_NUMBER</span>=8080 -p 8080:8080 -p 50000:50000 -v <span style="color: #8b2252;">\</span>
/data/jenkins_data:/bitnami/jenkins bitnami/jenkins:2.303.1-debian-10-r29
</pre>
</div>

<p>
说明：
</p>
<ul class="org-ul">
<li>8080  端口为web ui</li>
<li>50000  端口为与 master 节点通信端口</li>
<li>指定管理员账号密码 JENKINS_USERNAM、JENKINS_PASSWORD</li>
</ul>

<p>
启动jenkins
</p>

<div class="org-src-container">
<pre class="src src-shell">docker run -d --name=jenkins --restart=always --net host <span style="color: #8b2252;">\</span>
-e <span style="color: #a0522d;">JENKINS_PASSWORD</span>=admin123 <span style="color: #8b2252;">\</span>
-e <span style="color: #a0522d;">JENKINS_USERNAME</span>=admin <span style="color: #8b2252;">\</span>
-e <span style="color: #a0522d;">JENKINS_HTTP_PORT_NUMBER</span>=8080 <span style="color: #8b2252;">\</span>
-v /data/jenkins_data:/bitnami/jenkins <span style="color: #8b2252;">\</span>
192.168.10.254:5000/bitnami/jenkins:2.332.2-debian-10-r29
</pre>
</div>

<p>
验证启动
</p>
<div class="org-src-container">
<pre class="src src-shell">$ docker logs -f jenkins
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26085;&#24535;&#30475;&#21040;Jenkins is fully up and running&#34920;&#31034;&#21551;&#21160;&#25104;&#21151;</span>
</pre>
</div>

<p>
之后通过 Jenkins 宿主机的 IP+8080 即可访问 Jenkins
</p>

<p>
插件安装
</p>

<p>
登录后点击 Manage Jenkins → Manage Plugins 安装需要使用的插件
</p>

<p>
在安装之前首先配置国内的插件源，点击 Advanced，将插件源更改为国内插件源 （<a href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</a>）
</p>

<p>
注意：如果已有 jenkins，在更新插件前一定要先备份插件，有可能会造成 jenkins 启不来。
</p>

<p>
需要安装的插件有：
</p>
<div class="org-src-container">
<pre class="src src-shell">Git
Git Parameter
Git Pipeline for Blue Ocean
GitLab
Credentials
Credentials Binding
Blue Ocean
Blue Ocean Pipeline Editor
Blue Ocean Core JS
Pipeline SCM API for Blue Ocean
Dashboard for Blue Ocean
Build With Parameters
Dynamic Extended Choice Parameter Plug-In
Dynamic Parameter Plug-in
Extended Choice Parameter
List Git Branches Parameter
Pipeline
Pipeline: Declarative
Kubernetes
Kubernetes CLI
Kubernetes Credentials
Image Tag Parameter
Active Choices
</pre>
</div>
<p>
勾选后，点击 Download now and install after restart，jenkins安装完后后重启
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:74d893c7-1602-48ca-a0b9-375742f34ebe" class="outline-5">
<h5 id="h:74d893c7-1602-48ca-a0b9-375742f34ebe">gitlab 安装</h5>
<div class="outline-text-5" id="text-h:74d893c7-1602-48ca-a0b9-375742f34ebe">
<p>
略
</p>

<p>
gitlab 安装及使用
</p>

<p>
安装包下载地址：<a href="https://packages.gitlab.com/gitlab/gitlab-ce">https://packages.gitlab.com/gitlab/gitlab-ce</a>
</p>

<p>
rpm 包国内下载地址：<a href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/">https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/</a>
</p>

<p>
ubuntu 国内下载地址：<a href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/ubuntu/pool/">https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/ubuntu/pool/</a>
</p>

<p>
下载安装gitlab:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#37324;&#20107;&#20808;&#20174;&#28165;&#21326;&#28304;&#19979;&#36733;&#26368;&#26032;&#29256;gitlab</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#23384;&#26368;&#23569;4G</span>
$ free -h
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;</span>
$ yum install gitlab-ce-14.9.4-ce.0.el7.x86_64.rpm -y
</pre>
</div>

<p>
修改gitlab配置文件:
</p>
<div class="org-src-container">
<pre class="src src-shell">$ grep <span style="color: #8b2252;">"^[a-Z]"</span> /etc/gitlab/gitlab.rb
external_url <span style="color: #8b2252;">'http://192.168.10.14'</span>   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#22320;&#22336;</span>
<span style="color: #a0522d;">prometheus</span>[<span style="color: #8b2252;">'enable'</span>] = false          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#38381;&#30417;&#25511;&#19981;&#38656;&#35201;&#23433;&#35013;&#65292;&#21487;&#36890;&#36807; gitlab exporter &#19982;&#33258;&#24314; prometheus &#23454;&#29616;&#30417;&#25511;</span>
</pre>
</div>

<p>
初始化服务
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;&#37197;&#32622;&#24182;&#21551;&#21160;&#26381;&#21153;&#65292;&#22836;&#19968;&#27425;&#21152;&#36733;&#26381;&#21153;&#27604;&#36739;&#24930;&#65292;&#30830;&#20445;&#20869;&#23384;&#22823;&#20110;4G,&#31561;&#24453;&#21551;&#21160;&#23436;&#25104;</span>
gitlab-ctl reconfigure
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;&#23494;&#30721;&#22312; /etc/gitlab/initial_root_password&#65292;&#25991;&#20214;&#26377;&#25928;&#26399; 24h&#12290;</span>
</pre>
</div>

<p>
创建一个组并在组下创建项目，然后可以通过 git  命令拉代码了。
</p>

<p>
在gitlab中添加密钥
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">jenkins &#29983;&#25104;&#23494;&#38053;</span>
ssh-keygen -t rsa -C <span style="color: #8b2252;">"jenkins@xxx.org"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;gitlab&#20013;&#28155;&#21152;&#23494;&#38053;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7b54adab-196c-43fc-97c4-97b7d7093a4c" class="outline-5">
<h5 id="h:7b54adab-196c-43fc-97c4-97b7d7093a4c">harbor 安装</h5>
<div class="outline-text-5" id="text-h:7b54adab-196c-43fc-97c4-97b7d7093a4c">
<p>
略
下载地址：<a href="https://github.com/vmware/harbor/releases">https://github.com/vmware/harbor/releases</a>
</p>

<p>
安装文档： <a href="https://goharbor.io/docs/">https://goharbor.io/docs/</a>
</p>

<p>
由于Harbor是采用docker-compose一键部署的，所以Harbor服务器也需要安装Docker以及docker-compose
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#20256;harbor&#31163;&#32447;&#21253;&#65292;&#24182;&#19988;&#37096;&#32626;</span>
$ tar xf harbor-offline-installer-v2.5.0.tgz  -C /usr/local/
</pre>
</div>

<p>
修改配置文件
</p>
<div class="org-src-container">
<pre class="src src-shell">$ cp /usr/local/harbor/harbor.yml.tmpl /usr/local/harbor/harbor.yml
$ vim /usr/local/harbor/harbor.yml
hostname: 192.168.10.15  <span style="color: #b22222;">#</span><span style="color: #b22222;">harbor&#26381;&#21153;&#22120;&#22320;&#22336;</span>
harbor_admin_password: 123456
data_volume: /data   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#30446;&#24405;&#38656;&#35201;&#25163;&#21160;&#21019;&#24314;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#38500;&#20102;&#36825;&#19977;&#39033;&#22806;&#36824;&#38656;&#35201;&#27880;&#37322;https&#30340;&#20840;&#37096;&#27880;&#37322;</span>
</pre>
</div>

<p>
启动服务
</p>
<div class="org-src-container">
<pre class="src src-shell">$ cd /usr/local/harbor/
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39044;&#37197;&#32622;</span>
$ ./prepare
 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160;</span>
$ ./install.sh
</pre>
</div>

<p>
<b>配置docker或者continerd</b>
</p>

<p>
如果harbor使用的http需要修改容器服务配置，k8s中容器运行时也需要修改
</p>

<p>
docker配置
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;docker&#37197;&#32622;</span>
cat /etc/docker/daemon.json
{
  <span style="color: #8b2252;">"exec-opts"</span>: [<span style="color: #8b2252;">"native.cgroupdriver=systemd"</span>],
  <span style="color: #8b2252;">"registry-mirrors"</span>: [<span style="color: #8b2252;">"https://qai5ut9z.mirror.aliyuncs.com"</span>],
  <span style="color: #8b2252;">"insecure-registries"</span>: [<span style="color: #8b2252;">"192.168.10.254:5000"</span>,<span style="color: #8b2252;">"192.168.10.15"</span>]
}
systemctl daemon-reload
systemctl restart docker
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30331;&#24405;harbor</span>
docker login 192.168.10.15
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#20256;&#38236;&#20687;</span>
docker push 192.168.10.15/kubernetes/alpine:latest
</pre>
</div>

<p>
continerd配置
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;</span>
$ vim /etc/containerd/config.toml
      [plugins.<span style="color: #8b2252;">"io.containerd.grpc.v1.cri"</span>.registry.configs]
        [plugins.<span style="color: #8b2252;">"io.containerd.grpc.v1.cri"</span>.registry.configs.<span style="color: #8b2252;">"192.168.10.15"</span>.auth] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#26159;&#21311;&#21517;&#20179;&#24211;&#25289;&#21462;&#38236;&#20687;&#38656;&#35201;&#35748;&#35777;&#20179;&#24211;&#35748;&#35777;&#20449;&#24687;</span>
          <span style="color: #a0522d;">username</span> = <span style="color: #8b2252;">"admin"</span>                                                 
          <span style="color: #a0522d;">password</span> = <span style="color: #8b2252;">"123456"</span>
      [plugins.<span style="color: #8b2252;">"io.containerd.grpc.v1.cri"</span>.registry.mirrors.<span style="color: #8b2252;">"192.168.10.15"</span>]  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20179;&#24211;&#35774;&#32622;</span>
         <span style="color: #a0522d;">endpoint</span> = [<span style="color: #8b2252;">"http://192.168.10.15"</span>]
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;</span>
$ systemctl restart containerd.service
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25289;&#21462;&#38236;&#20687;&#27979;&#35797;</span>
$ crictl pull 192.168.10.15/kubernetes/alpine:latest
ctr -n k8s.io image pull 192.168.10.15/kubernetes/alpine:latest --plain-http --user admin:123456
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2652696f-54e9-4368-bc3e-18e2f354ba77" class="outline-5">
<h5 id="h:2652696f-54e9-4368-bc3e-18e2f354ba77">jenkins对接各种组件</h5>
<div class="outline-text-5" id="text-h:2652696f-54e9-4368-bc3e-18e2f354ba77">
</div>
<ul class="org-ul">
<li><a id="h:e90421df-6944-436e-bace-79ced5f5cc57"></a>修改jenkins必要设置<br>
<div class="outline-text-6" id="text-h:e90421df-6944-436e-bace-79ced5f5cc57">
<p>
确保这俩个配置与Jenkins的访问地址一致。
</p>

<p>
Jenkins URL == Resource Root URL
</p>

<p>
同时如果配置了域名和 jenkins master 通信的 50000  端口也需要开放
</p>
</div>
</li>
<li><a id="h:2ad6e621-6bc7-4491-8fd1-bb82218f05d1"></a>配置jenkins的凭证<br>
<div class="outline-text-6" id="text-h:2ad6e621-6bc7-4491-8fd1-bb82218f05d1">
<p>
Harbor 的账号密码、GitLab 的私钥、Kubernetes 的证书均使用 Jenkins 的 Credentials 管理。
</p>

<p>
<b>配置kubernetes配置文件</b>
</p>
<ul class="org-ul">
<li>首先需要找到集群中的 KUBECONFIG，一般是 kubectl 节点的~/.kube/config 文件，或者是 KUBECONFIG 环境变量所指向的文件。</li>
<li>接下来只需要把证书文件放置于 Jenkins 的 Credentials 中即可。首先点击 Manage Jenkins， 之后点击 Manage Credentials</li>
<li>然后在点击 Jenkins，之后点击 Add Credentials 选择密钥文件</li>
</ul>

<p>
<b>配置harbor账号密码</b>
</p>

<p>
对于账号密码和 Key 类型的凭证，配置步骤是一致的，只是选择的凭证类型不一样。
</p>

<p>
接下来通过Jenkins凭证管理Harbor的账号密码。 在同样的位置点击 Add Credentials
</p>

<p>
选择类型为 Username with password
</p>

<p>
<b>配置gitlab的key</b>
</p>

<p>
点击 Add Credentials，类型选择为 SSH Username with private key
</p>

<p>
找到jenkins主机的~/.ssh/id_rsa之前生成的。
</p>
</div>
</li>
<li><a id="h:99a7c34a-d342-4003-a52c-423941dd2de5"></a>配置agent<br>
<div class="outline-text-6" id="text-h:99a7c34a-d342-4003-a52c-423941dd2de5">
<p>
通常情况下，Jenkins Slave 会通过 Jenkins Master 节点的 50000 端口与之通信，所以需要开启 Agent 的50000端口。
</p>

<p>
点击 Manage Jenkins，然后点击 Configure Global Security，在 Agents TCP port 中fixed 填写 50000。
</p>

<p>
实际使用时，没有必要把整个 Kubernetes 集群的节点都充当创建Jenkins Slave Pod 的节点， 可以选择任意的一个或多个节点作为创建 Slave Pod 的节点
</p>

<div class="org-src-container">
<pre class="src src-shell">kubectl label node 192.168.10.12 <span style="color: #a0522d;">build</span>=true
</pre>
</div>

<p>
注意：
</p>
<ul class="org-ul">
<li>如果集群并非使用 Docker 作为 Runtime，但是由于构建镜像时，需要使用 Docker，所以该节点需要安装Docker.</li>
</ul>
</div>
</li>
<li><a id="h:e204c2a5-1402-4562-bf52-1a43b6f76bba"></a>jenkins 配置 kubernetes 多集群<br>
<div class="outline-text-6" id="text-h:e204c2a5-1402-4562-bf52-1a43b6f76bba">
<p>
首先点击 Manage Jenkins &#x2013;&gt; Manage Nodes and Clouds，之后点击 Configure Clouds，祥情中只改凭据中找到 kubernetes 的。
</p>

<p>
最后点击 Save 即可，添加完 Kubernetes 后，在 Jenkinsfile 的 Agent 中，就可以选择该集群作为创建Slave的集群。
</p>

<p>
如果想要添加多个集群，重复上述的步骤即可。首先添加 Kubernetes 凭证，然后添加 Cloud 即可。
</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:e118e132-094e-40b6-a7f1-fb9fb9f4e851" class="outline-4">
<h4 id="h:e118e132-094e-40b6-a7f1-fb9fb9f4e851">BlueOcean入门</h4>
<div class="outline-text-4" id="text-h:e118e132-094e-40b6-a7f1-fb9fb9f4e851">
<p>
推荐方式：
</p>

<pre class="example" id="orgdd73523">
1.BlueOcean 创建 Pipline
2.在 gitlab上 创建一个独立的项目
3.BlueOcean 应用上面创建的 gitlab
4.会在 gitlab 上创建的独立项目中生成 Jenkinsfile
5.拷贝上面的 Jenkinsfile, 修改适配自己真实项目的 Jenkinsfile 应用到自己的真实项目中
6.job 调用 job的方式，去复用公共模块。比如说代码扫描等
</pre>

<p>
官方文档：<a href="https://www.jenkins.io/projects/blueocean/">https://www.jenkins.io/projects/blueocean/</a>
</p>

<p>
使用 Jenkins Pipeline 来自动化部署一个 Kubernetes 应用的方法，在实际的项目中，往往一个代码仓库都会有很多分支的，比如开发、测试、线上这些分支都是分开的，一般情况下开发或者测试的分支希望提交代码后就直接进行 CI/CD 操作，而线上的话最好增加一个人工干预的步骤，这就需要 Jenkins 对代码仓库有多分支的支持，当然这个特性是被 Jenkins 支持的。
</p>
</div>
<div id="outline-container-h:465ce3ab-7397-4b72-a29f-a5d6d350e23f" class="outline-5">
<h5 id="h:465ce3ab-7397-4b72-a29f-a5d6d350e23f">图形化创建Jenkins案例</h5>
<div class="outline-text-5" id="text-h:465ce3ab-7397-4b72-a29f-a5d6d350e23f">
<p>
文档：<a href="https://www.jenkins.io/zh/doc/tutorials/create-a-pipeline-in-blue-ocean/">https://www.jenkins.io/zh/doc/tutorials/create-a-pipeline-in-blue-ocean/</a>
</p>
</div>
</div>
</div>
<div id="outline-container-h:0f636a09-8c02-4986-98bb-fdf0a557972d" class="outline-4">
<h4 id="h:0f636a09-8c02-4986-98bb-fdf0a557972d">阿里云镜像仓库</h4>
<div class="outline-text-4" id="text-h:0f636a09-8c02-4986-98bb-fdf0a557972d">
<p>
<a href="https://cr.console.aliyun.com/cn-hangzhou/instance/dashboard">https://cr.console.aliyun.com/cn-hangzhou/instance/dashboard</a>
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">login</span>
sudo docker login --username=jet**** registry.cn-hangzhou.aliyuncs.com
</pre>
</div>

<ol class="org-ol">
<li>配置accessKey</li>

<li>在linux安装 CLI工具</li>
</ol>

<p>
<a href="https://www.alibabacloud.com/help/zh/doc-detail/139508.htm">https://www.alibabacloud.com/help/zh/doc-detail/139508.htm</a>
</p>

<div class="org-src-container">
<pre class="src src-shell">tar xzvf aliyun-cli-linux-3.0.32-amd64.tgz
sudo cp aliyun /usr/local/bin
aliyun --help

aliyun  configure
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20837;accessKey</span>


</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;&#38236;&#20687;tag</span>
aliyun cr GetRepoTags --RepoNamespace &#21629;&#21517;&#31354;&#38388;&#21517;&#31216; --RepoName &#38236;&#20687;&#21517;&#31216; | jq <span style="color: #8b2252;">".data.tags[].tag"</span> -r
</pre>
</div>
</div>
</div>
<div id="outline-container-h:83cb5c57-53e4-4374-8b73-b49910f87fe1" class="outline-4">
<h4 id="h:83cb5c57-53e4-4374-8b73-b49910f87fe1">jenkins 其它配置</h4>
<div class="outline-text-4" id="text-h:83cb5c57-53e4-4374-8b73-b49910f87fe1">
</div>
<div id="outline-container-h:dc966d04-92fb-429b-8f3d-1a0bda6eb3a3" class="outline-5">
<h5 id="h:dc966d04-92fb-429b-8f3d-1a0bda6eb3a3">备份插件ThinBackup</h5>
<div class="outline-text-5" id="text-h:dc966d04-92fb-429b-8f3d-1a0bda6eb3a3">
<p>
<a href="https://plugins.jenkins.io/thinBackup/">https://plugins.jenkins.io/thinBackup/</a>
</p>

<pre class="example" id="org19fd67b">
备份目录: /data/jenkis_backup
备份时间：H 0 * * *
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b86a6906-aa4b-459c-a0f5-4bcdc5c9c3ce" class="outline-4">
<h4 id="h:b86a6906-aa4b-459c-a0f5-4bcdc5c9c3ce">自动化构建应用</h4>
<div class="outline-text-4" id="text-h:b86a6906-aa4b-459c-a0f5-4bcdc5c9c3ce">
<p>
sprintboot: <a href="https://gitee.com/dukuan/spring-boot-project.git">https://gitee.com/dukuan/spring-boot-project.git</a>
</p>

<div class="org-src-container">
<pre class="src src-shell">pipeline {
  agent {
    kubernetes { 
      cloud <span style="color: #8b2252;">'kubernetes'</span>  //&#36825;&#37324;&#38656;&#35201;&#25351;&#23450;&#30456;&#20851;jenkins&#20013;&#21019;&#24314;&#30340;kubernetes&#23545;&#25509;&#20449;&#24687;&#30340;&#21517;&#31216;
      slaveConnectTimeout 1200  //&#36229;&#26102;&#37197;&#32622;
      workspaceVolume emptyDirWorkspaceVolume(hostPath: <span style="color: #8b2252;">"/opt/workspace"</span>, readOnly: false)  //jenkins&#30340;&#24037;&#20316;&#30446;&#24405;&#65292;&#24517;&#39035;&#35774;&#32622;&#36215;&#21040;&#19968;&#20010;Pod&#20013;&#19981;&#21516;container&#30340;&#30446;&#24405;&#20849;&#20139;jenkins&#24037;&#20316;&#30446;&#24405;
      yaml <span style="color: #8b2252;">'''  //&#36825;&#37324;&#20197;&#19979;&#37117;&#26159;Pod&#23450;&#20041;&#20449;&#24687;</span>
<span style="color: #8b2252;">kind: Pod</span>
<span style="color: #8b2252;">metadata:</span>
<span style="color: #8b2252;">  name: jenkins-agent</span>
<span style="color: #8b2252;">  namespace: jenkins</span>
<span style="color: #8b2252;">spec:</span>
<span style="color: #8b2252;">  containers: </span>
<span style="color: #8b2252;">  - args: [\'</span>$(JENKINS_SECRET)<span style="color: #8b2252;">\'</span>, <span style="color: #8b2252;">\'</span>$(JENKINS_NAME)<span style="color: #8b2252;">\'</span>]
    image: <span style="color: #8b2252;">'192.168.10.15/kubernetes/jnlp:alpine'</span>
    name: jnlp                      //jnlp&#23481;&#22120;&#26159;&#24517;&#39035;&#30340;&#20182;&#36127;&#36131;&#36830;&#25509;jenkins&#65292;&#36825;&#37324;&#20445;&#25345;&#40664;&#35748;&#20351;&#29992;&#21363;&#21487;
    imagePullPolicy: IfNotPresent
//&#20197;&#19979;&#23481;&#22120;&#20026;&#20855;&#20307;&#30340;&#24037;&#20316;&#23481;&#22120;&#65292;&#25152;&#26377;&#27969;&#27700;&#32447;&#20013;&#30340;&#20219;&#20309;&#38454;&#27573;&#30340;&#20219;&#21153;&#37117;&#22312;&#23481;&#22120;&#20013;&#25191;&#34892;&#65292;&#21487;&#20197;&#23450;&#20041;&#22810;&#20010;&#22312;&#27969;&#27700;&#32447;&#20013;&#25351;&#23450;&#20219;&#21153;&#20351;&#29992;&#37027;&#20010;&#23481;&#22120;&#36827;&#34892;&#25191;&#34892;
  - command:   //&#25152;&#26377;&#23481;&#22120;&#25512;&#33616;&#20351;&#29992;cat&#21629;&#20196;&#20445;&#35777;&#23481;&#22120;&#22312;&#21551;&#21160;&#21518;&#20445;&#25345;&#36816;&#34892;&#19981;&#36864;&#20986;   
      - <span style="color: #8b2252;">"cat"</span>
    tty: true  //&#20445;&#25345;tty&#65292;&#36215;&#21040;&#23481;&#22120;&#19981;&#36864;&#20986;
    image: <span style="color: #8b2252;">"192.168.10.254:5000/bash/alpine:latest"</span>
    imagePullPolicy: <span style="color: #8b2252;">"IfNotPresent"</span>
    name: <span style="color: #8b2252;">"echo"</span>  //container&#30340;&#21517;&#31216;
  restartPolicy: Never 
  nodeSelector:  
    build: true 
<span style="color: #8b2252;">'''</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">  }</span>
<span style="color: #8b2252;">  //&#20855;&#20307;&#27969;&#27700;&#32447;&#37197;&#32622;</span>
<span style="color: #8b2252;">  stages {</span>
<span style="color: #8b2252;">    //&#36825;&#37324;&#20026;&#27969;&#27700;&#32447;&#23450;&#20041;</span>
<span style="color: #8b2252;">    stage('</span>echo<span style="color: #8b2252;">') {   //stage&#21517;&#31216;</span>
<span style="color: #8b2252;">      steps {</span>
<span style="color: #8b2252;">        container(name: '</span>echo<span style="color: #8b2252;">') {   //&#36825;&#37324;&#23450;&#20041;&#36825;&#20010;&#27493;&#39588;&#20351;&#29992;&#37027;&#20010;container&#36827;&#34892;&#25191;&#34892;&#65292;&#25351;&#23450;container&#30340;&#21517;&#31216;</span>
<span style="color: #8b2252;">          sh "echo hello word"</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">      }</span>
<span style="color: #8b2252;">   }</span>
<span style="color: #8b2252;">}</span>
</pre>
</div>
</div>
<div id="outline-container-h:ea4386ae-6b3b-4638-a5c6-8c127ea6d083" class="outline-5">
<h5 id="h:ea4386ae-6b3b-4638-a5c6-8c127ea6d083">java  应用</h5>
<div class="outline-text-5" id="text-h:ea4386ae-6b3b-4638-a5c6-8c127ea6d083">
</div>
<ul class="org-ul">
<li><a id="h:a80e1505-5570-4845-8fd2-9e7418fe8889"></a>jenkinsfile<br>
<div class="outline-text-6" id="text-h:a80e1505-5570-4845-8fd2-9e7418fe8889">
<div class="org-src-container">
<pre class="src src-shell">pipeline {
  //&#39030;&#23618;&#29615;&#22659;&#21464;&#37327;&#35774;&#32622;
  environment {
    <span style="color: #a0522d;">COMMIT_ID</span> = <span style="color: #8b2252;">""</span>
    <span style="color: #a0522d;">HARBOR_ADDRESS</span> = <span style="color: #8b2252;">"192.168.10.15/bolo"</span>            //&#29983;&#25104;&#38236;&#20687;&#23384;&#25918;&#38236;&#20687;&#30340;&#20179;&#24211;&#22320;&#22336;
    <span style="color: #a0522d;">REGISTRY_DIR</span> = <span style="color: #8b2252;">'kubernetes'</span>
    <span style="color: #a0522d;">IMAGE_NAME</span> = <span style="color: #8b2252;">"sprintg-boot"</span>
    <span style="color: #a0522d;">NAMESPACE</span> = <span style="color: #8b2252;">"bolo"</span>                     //&#26381;&#21153;&#37096;&#32626;&#22312;&#37027;&#20010;namespace&#20013;  
    <span style="color: #a0522d;">GIT_ADDR</span> = <span style="color: #8b2252;">"git@192.168.10.14:kubernetes/bolo-spring-boot.git"</span>  //&#20195;&#30721;&#20179;&#24211;&#22320;&#22336;
    <span style="color: #a0522d;">TAG</span> = <span style="color: #8b2252;">""</span>                               //&#38236;&#20687;tag,&#20250;&#22312;&#19979;&#38754;&#29983;&#25104;,&#36825;&#37324;&#21482;&#26159;&#23450;&#20041;&#20840;&#23616;&#21464;&#37327;
  }
  //&#20840;&#23616;&#37197;&#32622;
  options {
    timestamps()                     //&#25152;&#26377;&#36755;&#20986;&#27599;&#34892;&#37117;&#20250;&#25171;&#21360;&#26102;&#38388;&#25139;
    buildDiscarder(logRotator(numToKeepStr: <span style="color: #8b2252;">'5'</span>))  //&#20445;&#30041;5&#20010;&#21382;&#21490;&#26500;&#24314;&#29256;&#26412;
  }
  //&#25163;&#21160;&#26500;&#24314;&#26102;&#36873;&#25321;&#20998;&#25903;&#21442;&#25968;
  parameters { 
    gitParameter(branch: <span style="color: #8b2252;">''</span>, branchFilter: <span style="color: #8b2252;">'origin/(.*)'</span>, defaultValue: <span style="color: #8b2252;">''</span>, description: <span style="color: #8b2252;">'Branch for build and deploy'</span>, name: <span style="color: #8b2252;">'BRANCH'</span>, quickFilterEnabled: false, selectedValue: <span style="color: #8b2252;">'NONE'</span>, sortMode: <span style="color: #8b2252;">'NONE'</span>,  tagFilter: <span style="color: #8b2252;">'*'</span>, type: <span style="color: #8b2252;">'PT_BRANCH'</span>)
  }
  //agent&#37197;&#32622;
  agent {
    kubernetes {
      cloud <span style="color: #8b2252;">'kubernetes'</span>
      slaveConnectTimeout 1200
      workspaceVolume emptyDirWorkspaceVolume(hostPath: <span style="color: #8b2252;">"/opt/workspace"</span>, readOnly: false)   //&#36825;&#37324;&#20351;&#29992;&#20020;&#26102;&#30446;&#24405;&#20849;&#20139;jenkins&#30340;&#24037;&#20316;&#30446;&#24405;&#40664;&#35748;&#36335;&#24452;&#20026;/home/jenkins/agent&#65292;&#35299;&#20915; nodejs &#19979;&#36733;&#21253;&#38382;&#39064;
      yaml <span style="color: #8b2252;">'''</span>
<span style="color: #8b2252;">kind: Pod</span>
<span style="color: #8b2252;">metadata:</span>
<span style="color: #8b2252;">  name: jenkins-agent</span>
<span style="color: #8b2252;">  namespace: jenkins</span>
<span style="color: #8b2252;">spec:</span>
<span style="color: #8b2252;">  containers:</span>
<span style="color: #8b2252;">  - args: [\'</span>$(JENKINS_SECRET)<span style="color: #8b2252;">\'</span>, <span style="color: #8b2252;">\'</span>$(JENKINS_NAME)<span style="color: #8b2252;">\'</span>]
    image: <span style="color: #8b2252;">'192.168.10.254:5000/kubernetes/jnlp:alpine'</span>
    name: jnlp    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#20010;&#23481;&#22120;&#24517;&#39035;&#26377;&#65292;&#20445;&#25345;&#40664;&#35748;&#21363;&#21487;</span>
    imagePullPolicy: IfNotPresent
    volumeMounts:
    - mountPath: <span style="color: #8b2252;">"/etc/location"</span>  
      name: <span style="color: #8b2252;">"localtime"</span>
      readOnly: false
  - command:  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#23481;&#22120;&#25512;&#33616;&#20351;&#29992;cat&#21629;&#20196;&#20445;&#35777;&#23481;&#22120;&#22312;&#21551;&#21160;&#21518;&#20445;&#25345;&#36816;&#34892;&#19981;&#36864;&#20986;</span>
    - <span style="color: #8b2252;">"cat"</span>
    env:
    - name: <span style="color: #8b2252;">"LANGUAGE"</span>
      value: <span style="color: #8b2252;">"en_US:en"</span>
    - name: <span style="color: #8b2252;">"LC_ALL"</span>
      value: <span style="color: #8b2252;">"en_US.UTF-8"</span>
    - name: <span style="color: #8b2252;">"LANG"</span>
      value: <span style="color: #8b2252;">"en_US.UTF-8"</span>
    image: <span style="color: #8b2252;">"192.168.10.254:5000/kubernetes/maven:3.8.5-openjdk-8-slim"</span>
    imagePullPolicy: <span style="color: #8b2252;">"IfNotPresent"</span>
    name: <span style="color: #8b2252;">"build"</span>
    volumeMounts:
    - mountPath: <span style="color: #8b2252;">"/etc/location"</span>  
      name: <span style="color: #8b2252;">"localtime"</span>
      readOnly: false
    - mountPath: <span style="color: #8b2252;">"/root/.m2"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25345;&#20037;&#21270;&#20381;&#36182;&#21253;&#65292;&#37325;&#22797;&#26500;&#24314;&#19981;&#20250;&#36827;&#34892;&#37325;&#22797;&#19979;&#36733; </span>
      name: <span style="color: #8b2252;">"cachedir"</span>
      readOnly: false
    tty: true <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20445;&#25345;tty&#65292;&#36215;&#21040;&#23481;&#22120;&#19981;&#36864;&#20986;</span>
  - command:
      - <span style="color: #8b2252;">"cat"</span>
    env:
    - name: <span style="color: #8b2252;">"LANGUAGE"</span>
      value: <span style="color: #8b2252;">"en_US:en"</span>
    - name: <span style="color: #8b2252;">"LC_ALL"</span>
      value: <span style="color: #8b2252;">"en_US.UTF-8"</span>
    - name: <span style="color: #8b2252;">"LANG"</span>
      value: <span style="color: #8b2252;">"en_US.UTF-8"</span>
    image: <span style="color: #8b2252;">"192.168.10.254:5000/kubernetes/docker:alpine"</span>
    imagePullPolicy: <span style="color: #8b2252;">"IfNotPresent"</span>
    name: <span style="color: #8b2252;">"docker"</span>  <span style="color: #b22222;">#</span><span style="color: #b22222;">docker&#23481;&#22120;&#38656;&#35201;&#25346;&#36733;docker.sock&#25991;&#20214;&#65292;&#38656;&#35201;&#35843;&#24230;&#21040;&#26377;docker&#30340;node&#33410;&#28857;</span>
    tty: true
    volumeMounts:
    - mountPath: <span style="color: #8b2252;">"/etc/location"</span>  
      name: <span style="color: #8b2252;">"localtime"</span>
      readOnly: false
    - mountPath: <span style="color: #8b2252;">"/var/run/docker.sock"</span>
      name: <span style="color: #8b2252;">"dockersock"</span>
      readOnly: false
  - command:
      - <span style="color: #8b2252;">"cat"</span>
    env:
    - name: <span style="color: #8b2252;">"LANGUAGE"</span>
      value: <span style="color: #8b2252;">"en_US:en"</span>
    - name: <span style="color: #8b2252;">"LC_ALL"</span>
      value: <span style="color: #8b2252;">"en_US.UTF-8"</span>
    - name: <span style="color: #8b2252;">"LANG"</span>
      value: <span style="color: #8b2252;">"en_US.UTF-8"</span>
    image: <span style="color: #8b2252;">"192.168.10.254:5000/kubernetes/kubectl:apline"</span>
    imagePullPolicy: <span style="color: #8b2252;">"IfNotPresent"</span>
    name: <span style="color: #8b2252;">"kubectl"</span>  <span style="color: #b22222;">#</span><span style="color: #b22222;">kubectl&#38236;&#20687;</span>
    tty: true
    volumeMounts:
    - mountPath: <span style="color: #8b2252;">"/etc/location"</span>  
      name: <span style="color: #8b2252;">"localtime"</span>
      readOnly: false
  volumes:          
  - name: mvn-data    
    persistentVolumeClaim:  
      claimName: mvn 
  - hostPath:
      path: <span style="color: #8b2252;">"/var/run/docker.sock"</span>
    name: <span style="color: #8b2252;">"dockersock"</span>  
  restartPolicy: Never
  nodeSelector:   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#37324;&#38656;&#35201;&#32473;&#26377;docker&#30340;node&#33410;&#28857;&#25171;&#26631;&#31614;&#35843;&#24230;Pod&#21040;&#36825;&#20010;&#33410;&#28857;</span>
    build: true
  securityContext: {}
  volumes:
  - hostPath:
      path: <span style="color: #8b2252;">"/var/run/docker.sock"</span>
    name: <span style="color: #8b2252;">"dockersock"</span>
  - hostPath:
      path: <span style="color: #8b2252;">"/usr/share/zoneifo/Asia/Shanghai"</span>
    name: <span style="color: #8b2252;">"localtime"</span>
  - hostPath:
      path: <span style="color: #8b2252;">"/opt/m2"</span>
    name: <span style="color: #8b2252;">"cachedir"</span>
<span style="color: #8b2252;">'''</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">  }</span>
<span style="color: #8b2252;">  //&#20855;&#20307;&#27969;&#27700;&#32447;&#37197;&#32622;</span>
<span style="color: #8b2252;">  stages {</span>
<span style="color: #8b2252;">    //&#20811;&#38534;&#20195;&#30721;</span>
<span style="color: #8b2252;">    stage('</span>Pulling Code<span style="color: #8b2252;">') {</span>
<span style="color: #8b2252;">      //&#24182;&#34892;&#25191;&#34892;</span>
<span style="color: #8b2252;">      //failFast true  //&#24182;&#34892;&#25191;&#34892;&#30340;&#20998;&#25903;&#21482;&#35201;&#26377;&#19968;&#20010;&#22833;&#36133;&#31435;&#21363;&#32467;&#26463;&#27969;&#27700;&#32447;</span>
<span style="color: #8b2252;">      parallel {</span>
<span style="color: #8b2252;">        //&#25163;&#21160;&#25191;&#34892;jenkins&#27969;&#27700;&#32447;</span>
<span style="color: #8b2252;">        stage('</span>Pulling Code by Jenkins<span style="color: #8b2252;">') {</span>
<span style="color: #8b2252;">          when {</span>
<span style="color: #8b2252;">            expression {</span>
<span style="color: #8b2252;">              env.gitlabBranch == null</span>
<span style="color: #8b2252;">            }</span>
<span style="color: #8b2252;">          }</span>
<span style="color: #8b2252;">          steps {</span>
<span style="color: #8b2252;">            //git branch: "${BRANCH}", credentialsId: '</span>gitlab-key<span style="color: #8b2252;">', url: "${GIT}"</span>
<span style="color: #8b2252;">            git(changelog: true, poll: true, url: "${GIT_ADDR}", branch: "${BRANCH}",credentialsId: '</span>gitlab-key<span style="color: #8b2252;">')</span>
<span style="color: #8b2252;">            script {</span>
<span style="color: #8b2252;">              COMMIT_ID = sh(returnStdout: true, script: "git log -n 1 --pretty=format:'</span>%h<span style="color: #8b2252;">'").trim()</span>
<span style="color: #8b2252;">              TAG = BUILD_TAG + '</span>-<span style="color: #8b2252;">' + COMMIT_ID</span>
<span style="color: #8b2252;">              println "Current branch is ${BRANCH}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}"</span>
<span style="color: #8b2252;">            }</span>
<span style="color: #8b2252;">          }</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">        //gitlab&#35302;&#21457;&#26500;&#24314;</span>
<span style="color: #8b2252;">        stage('</span>git clone trigger<span style="color: #8b2252;">') {</span>
<span style="color: #8b2252;">          when {</span>
<span style="color: #8b2252;">            expression {</span>
<span style="color: #8b2252;">              env.gitlabBranch != null</span>
<span style="color: #8b2252;">            }</span>
<span style="color: #8b2252;">          }</span>
<span style="color: #8b2252;">          steps {</span>
<span style="color: #8b2252;">            git branch: "${env.gitlabBranch}", credentialsId: '</span>gitlab-key<span style="color: #8b2252;">', url: "${GIT}"</span>
<span style="color: #8b2252;">            git(changelog: true, poll: true, url: "${GIT_ADDR}", branch: env.gitlabBranch, credentialsId: '</span>gitlab-key<span style="color: #8b2252;">')</span>
<span style="color: #8b2252;">            script {</span>
<span style="color: #8b2252;">              //TAG = sh(returnStdout: true, script: "echo -n ${env.gitlabBranch}-${env.BUILD_ID}")</span>
<span style="color: #8b2252;">              COMMIT_ID = sh(returnStdout: true, script: "git log -n 1 --pretty=format:'</span>%h<span style="color: #8b2252;">'").trim()</span>
<span style="color: #8b2252;">              TAG = BUILD_TAG + '</span>-<span style="color: #8b2252;">' + COMMIT_ID</span>
<span style="color: #8b2252;">              println "Current branch is ${env.gitlabBranch}, Commit ID is ${COMMIT_ID}, Image TAG is ${TAG}"</span>
<span style="color: #8b2252;">            }</span>
<span style="color: #8b2252;">          }</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">      }</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">    //&#25171;&#21253;java&#31243;&#24207;</span>
<span style="color: #8b2252;">    stage('</span>Building<span style="color: #8b2252;">') {</span>
<span style="color: #8b2252;">      steps {</span>
<span style="color: #8b2252;">        container(name: '</span>build<span style="color: #8b2252;">') {</span>
<span style="color: #8b2252;">          sh """</span>
<span style="color: #8b2252;">            curl repo.maven.apache.org</span>
<span style="color: #8b2252;">            mvn clean install -DskipTests"</span>
<span style="color: #8b2252;">            ls target/*</span>
<span style="color: #8b2252;">          """</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">      }</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">    //&#26500;&#24314;&#38236;&#20687;&#24182;&#19988;&#25512;&#36865;&#38236;&#20687;&#20179;&#24211;</span>
<span style="color: #8b2252;">    stage('</span>Docker build for creating image<span style="color: #8b2252;">') {</span>
<span style="color: #8b2252;">      environment {</span>
<span style="color: #8b2252;">        HARBOR_USER = credentials('</span>harbor-account<span style="color: #8b2252;">')  //&#33719;&#21462;&#38236;&#20687;&#20179;&#24211;&#35748;&#35777;&#20449;&#24687;</span>
<span style="color: #8b2252;">      }</span>
<span style="color: #8b2252;">      steps {</span>
<span style="color: #8b2252;">        container(name: '</span>docker<span style="color: #8b2252;">') {</span>
<span style="color: #8b2252;">          sh """</span>
<span style="color: #8b2252;">          echo ${HARBOR_USER_USR} ${HARBOR_USER_PSW} ${TAG}</span>
<span style="color: #8b2252;">          docker build -t ${HARBOR_ADDRESS}/${HARBOR_DIR}/${IMAGE_NAME}:${TAG} ."</span>
<span style="color: #8b2252;">          docker login -u ${HARBOR_USER_USR} -p ${HARBOR_USER_PSW} ${HARBOR_ADDRESS}"</span>
<span style="color: #8b2252;">          docker push ${registries}/${NAME}:${TAG}"</span>
<span style="color: #8b2252;">          """</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">      }</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">   //&#26356;&#26032;k8s&#30456;&#20851;&#24212;&#29992;</span>
<span style="color: #8b2252;">    stage('</span>Deploying to Kubernetes<span style="color: #8b2252;">') {</span>
<span style="color: #8b2252;">      environment {</span>
<span style="color: #8b2252;">        MY_KUBECONFIG = credentials('</span>kubernetes-cluster-stg<span style="color: #8b2252;">')</span>
<span style="color: #8b2252;">      }</span>
<span style="color: #8b2252;">      steps {</span>
<span style="color: #8b2252;">        container(name: '</span>kubectl<span style="color: #8b2252;">') {</span>
<span style="color: #8b2252;">          sh """</span>
<span style="color: #8b2252;">          kubectl --kubeconfig $MY_KUBECONFIG set image deploy -n ${NAMESPACE} -l app=${IMAGE_NAME} ${IMAGE_NAME}=${HARBOR_ADDRESS}/${HARBOR_DIR}/${IMAGE_NAME}:${TAG}"</span>
<span style="color: #8b2252;">          kubectl rollout status deployment -n ${NAMESPACE} ${IMAGE_NAME} --timeout=60s --kubeconfig $MY_KUBECONFIG"</span>
<span style="color: #8b2252;">          """</span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">      } </span>
<span style="color: #8b2252;">        }</span>
<span style="color: #8b2252;">  }</span>
<span style="color: #8b2252;">}</span>
</pre>
</div>
</div>
</li>
<li><a id="h:354e3d22-4a59-41de-b869-37f74dae71d2"></a>dockerfile<br>
<div class="outline-text-6" id="text-h:354e3d22-4a59-41de-b869-37f74dae71d2">
</div>
</li>
<li><a id="h:d480527f-1e85-4e15-9b5b-8043800c9e8f"></a>jenkins job<br>
<div class="outline-text-6" id="text-h:d480527f-1e85-4e15-9b5b-8043800c9e8f">
<p>
new item &#x2013;&gt; job 名为 git 项目名，选择 pipline &#x2013;&gt; Pipline 中选择 Pipline script from SCM，输入 git 项目地址及访问密钥 &#x2013;&gt; Save
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:9278bcef-7f30-477e-ac29-8fc3786403b6" class="outline-5">
<h5 id="h:9278bcef-7f30-477e-ac29-8fc3786403b6">Vue/H5 应用</h5>
<div class="outline-text-5" id="text-h:9278bcef-7f30-477e-ac29-8fc3786403b6">
<p>
把编译生成的 dist 目录构建成一个镜像
</p>

<p>
jenkinsfile 模板一样只是 build 中内容变化了。
</p>
<ul class="org-ul">
<li>编译镜像换成 nodejs，缓存目录不配置，因为 workspace 采用的是 hostPath，该目录被缓存到创建 Pod 节点的 /opt 目录</li>
<li>编译命令改成 npm 命令</li>
</ul>
</div>
</div>
<div id="outline-container-h:7ce9a8a4-dcce-437c-bd76-0c27baf3dcc9" class="outline-5">
<h5 id="h:7ce9a8a4-dcce-437c-bd76-0c27baf3dcc9">Go 应用</h5>
<div class="outline-text-5" id="text-h:7ce9a8a4-dcce-437c-bd76-0c27baf3dcc9">
<p>
jenkinsfile 模板一样只是 build 中内容变化了。
</p>
<ul class="org-ul">
<li>编译镜像换成 golang，缓存目录为 /go/pkg/，执行 go build 时下载的依赖包会缓存在该目录</li>
<li>编译命令改成 go env -w GOPROXY=<a href="https://goproxy.cn,direct">https://goproxy.cn,direct</a>; go build</li>
</ul>

<p>
dockerfile
</p>
<div class="org-src-container">
<pre class="src src-shell">FROM apline-glibc:alpine-3.9

COPY conf ./conf
COPY ./go-project ./

ENTRYPOINT [<span style="color: #8b2252;">"./go-project"</span>]
</pre>
</div>
</div>
</div>
<div id="outline-container-h:50dfcf6a-1ae0-4e83-ae28-35c3965357aa" class="outline-5">
<h5 id="h:50dfcf6a-1ae0-4e83-ae28-35c3965357aa">配置自动触发构建</h5>
<div class="outline-text-5" id="text-h:50dfcf6a-1ae0-4e83-ae28-35c3965357aa">
<p>
之前的构建都是采用手动选择分支进行构建的，实际使用时，项目可能有很多，如果都是手动触发可能比较消耗人力。所以推荐可以按需配置自动触发，即提交代码后自动触发Jenkins进行构建任务。
</p>

<p>
<b>配置jenkins</b>
</p>

<p>
首先找到 Java 项目的 Job，点击 Configure
</p>

<p>
之后选择 Build Triggers，勾选 Build when a change…，记录 webhook URL
</p>

<p>
选择 Allow all branches，如果不想任何分支都可以触发该流水线，可以选择 Filter 进行条件匹配。之后点击 Generate 生成 Secret token， 最后点击 Save 即可。
</p>

<p>
<b>配置gitlab</b>
</p>

<p>
接下来配置 GitLab，首先点击 Menu→Admin，在 Settings &#x2013;&gt; Network 中勾选 Allow requests to the local network from web hooks and services, Allow requests to the local network from system hook
</p>

<p>
保存后，找到 Java 项目，点击 Settings→WebHooks，填写 jenkins job URL 和 token，确认无误后，点击 Add webhook。保存后没有问题可以进行测试。
</p>
</div>
</div>
<div id="outline-container-h:bd7b59f7-bf68-4c2f-a9ca-aabfd3e9ceb5" class="outline-5">
<h5 id="h:bd7b59f7-bf68-4c2f-a9ca-aabfd3e9ceb5">jenkins 共享库</h5>
<div class="outline-text-5" id="text-h:bd7b59f7-bf68-4c2f-a9ca-aabfd3e9ceb5">
</div>
</div>
</div>
<div id="outline-container-h:a250803d-5571-414f-95fb-5886fa2a1376" class="outline-4">
<h4 id="h:a250803d-5571-414f-95fb-5886fa2a1376">杂</h4>
<div class="outline-text-4" id="text-h:a250803d-5571-414f-95fb-5886fa2a1376">
</div>
<div id="outline-container-h:004d365b-33c6-4d80-9666-62aa27588688" class="outline-5">
<h5 id="h:004d365b-33c6-4d80-9666-62aa27588688">单机启动监控</h5>
<div class="outline-text-5" id="text-h:004d365b-33c6-4d80-9666-62aa27588688">
<div class="org-src-container">
<pre class="src src-shell">cat  /data/script/monitoring-jenkins.py
import requests
import subprocess
import logging
import datetime
<span style="color: #0000ff;">logging.basicConfig</span>(<span style="color: #a0522d;">filename</span>=<span style="color: #8b2252;">'/tmp/.jenkins_ops.log'</span>,<span style="color: #a0522d;">level</span>=logging.DEBUG)
<span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">"http://10.204.68.159:8080/jenkins/login"</span>
<span style="color: #a0522d;">cmd</span> = <span style="color: #8b2252;">"/data/app/jenkins-master-01/console restart"</span>
def getJenkinsStatus():
    <span style="color: #a0522d;">curr_time</span> = datetime.datetime.now()
    <span style="color: #a0522d;">resp</span> = requests.get(url,<span style="color: #a0522d;">timeout</span>=5)
    resp.close()
    <span style="color: #a020f0;">if</span> resp.status_code == 502 or resp.status_code == 500:
       <span style="color: #a0522d;">out</span> = subprocess.Popen(cmd,<span style="color: #a0522d;">stdout</span>=subprocess.PIPE, <span style="color: #a0522d;">shell</span>=True)
       <span style="color: #a0522d;">result</span>=out.stdout.readlines()
       logging.debug(<span style="color: #8b2252;">"&#25805;&#20316;&#26102;&#38388; "</span> + str(curr_time))
       logging.debug(<span style="color: #8b2252;">"&#25805;&#20316;&#32467;&#26524;&#22914;&#19979; "</span> + str(result))
    <span style="color: #a020f0;">else</span>:
       logging.debug(<span style="color: #8b2252;">"&#36816;&#34892;&#27491;&#24120;,&#26412;&#27425;&#26816;&#27979;&#26102;&#38388; "</span> + str(curr_time))
<span style="color: #a020f0;">if</span> <span style="color: #a0522d;">__name__</span> == <span style="color: #8b2252;">'__main__'</span>:
    getJenkinsStatus()

crontab -l
*/5 *  *  *  * /usr/bin/python3.7 /data/script/monitoring-jenkins.py
</pre>
</div>
</div>
</div>
<div id="outline-container-h:912bad05-e757-41bd-9686-9e5963884b9e" class="outline-5">
<h5 id="h:912bad05-e757-41bd-9686-9e5963884b9e">定时备份</h5>
<div class="outline-text-5" id="text-h:912bad05-e757-41bd-9686-9e5963884b9e">
<div class="org-src-container">
<pre class="src src-shell">cat /etc/cron.d/jenkins_cron
40 23 * * * root /bin/bash /data/script/jenkins_back.sh

cat /data/script/jenkins_back.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #a0522d;">sourceJobbackupDir</span>=<span style="color: #8b2252;">"/data/jenkins_data/jobs"</span>
<span style="color: #a0522d;">sourcePlugins</span>=<span style="color: #8b2252;">"/data/jenkins_data/plugins"</span>

<span style="color: #a0522d;">dectJobBackupDir</span>=<span style="color: #8b2252;">"/data/jenkins_backup/jobs"</span>
<span style="color: #a0522d;">destPluginsDir</span>=<span style="color: #8b2252;">"/data/jenkins_backup/plugins"</span>

<span style="color: #a0522d;">currentdate</span>=$(date +%Y%m%d)
<span style="color: #483d8b;">cd</span> $<span style="color: #a0522d;">dectJobBackupDir</span>
/usr/bin/tar -zcvf jobs.$<span style="color: #a0522d;">currentdate</span>.tar.gz $<span style="color: #a0522d;">sourceJobbackupDir</span>
find $<span style="color: #a0522d;">dectJobBackupDir</span>/ -type f -name <span style="color: #8b2252;">"jobs.*.tar.gz"</span> -mtime +15 -exec rm -f {} <span style="color: #8b2252;">\;</span>

<span style="color: #483d8b;">cd</span> $<span style="color: #a0522d;">destPluginsDir</span>
/usr/bin/tar -zcvf plugins.$<span style="color: #a0522d;">currentdate</span>.tar.gz $<span style="color: #a0522d;">sourcePlugins</span>
find $<span style="color: #a0522d;">destPluginsDir</span>/ -type f -name <span style="color: #8b2252;">"plugins.*.tar.gz"</span> -mtime +15 -exec rm -f {} <span style="color: #8b2252;">\;</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:4f2803a3-0b7a-4e57-97e7-abfa00bac478" class="outline-3">
<h3 id="h:4f2803a3-0b7a-4e57-97e7-abfa00bac478">Gitlab</h3>
<div class="outline-text-3" id="text-h:4f2803a3-0b7a-4e57-97e7-abfa00bac478">
</div>
</div>
<div id="outline-container-h:931e719f-431a-43f0-9062-cf732375d966" class="outline-3">
<h3 id="h:931e719f-431a-43f0-9062-cf732375d966">harbor</h3>
<div class="outline-text-3" id="text-h:931e719f-431a-43f0-9062-cf732375d966">
<p>
具体使用参考，运维篇
</p>

<div class="org-src-container">
<pre class="src src-shell">Harbor&#38236;&#20687;&#20179;&#24211;&#22320;&#22336;&#65306;172.168.1.249

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;&#39033;&#30446;&#20449;&#24687;</span>

curl -u <span style="color: #8b2252;">"admin:Harbor12345"</span> -X GET -H <span style="color: #8b2252;">"Content-Type: application/json"</span> <span style="color: #8b2252;">"http://172.168.1.249/api/projects/2"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;&#25152;&#26377;&#39033;&#30446;&#20449;&#24687;</span>

curl -u <span style="color: #8b2252;">"admin:Harbor12345"</span> -X GET -H <span style="color: #8b2252;">"Content-Type: application/json"</span> <span style="color: #8b2252;">"http://172.168.1.249/api/projects?"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25628;&#32034;&#38236;&#20687;</span>

curl -u <span style="color: #8b2252;">"admin:Harbor12345"</span> -X GET -H <span style="color: #8b2252;">"Content-Type: application/json"</span> <span style="color: #8b2252;">"http://172.168.1.249/api/search?q=asset"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#39033;&#30446;</span>

curl -u <span style="color: #8b2252;">"admin:Harbor12345"</span> -X DELETE -H <span style="color: #8b2252;">"Content-Type: application/json"</span> <span style="color: #8b2252;">"http://172.168.1.249/api/projects/3"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#39033;&#30446;</span>

curl -u <span style="color: #8b2252;">"admin:Harbor12345"</span> -X POST -H <span style="color: #8b2252;">"Content-Type: application/json"</span> <span style="color: #8b2252;">"http://172.168.1.249/api/projects"</span> -d @createproject.json

createproject.json&#20026;&#25991;&#20214;&#21517;,&#25991;&#20214;&#20869;&#23481;&#21442;&#32771;createproject.json

<span style="color: #b22222;"># </span><span style="color: #b22222;">0&#20026;&#31169;&#26377;</span>

{

    <span style="color: #8b2252;">"project_name"</span>: <span style="color: #8b2252;">"&#39033;&#30446;&#21517;"</span>,

    <span style="color: #8b2252;">"public"</span>: 0

}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#29992;&#25143;</span>

curl -u <span style="color: #8b2252;">"admin:Harbor12345"</span> -X POST -H <span style="color: #8b2252;">"Content-Type: application/json"</span> <span style="color: #8b2252;">"http://172.168.1.249/api/users"</span> -d @user.json

&#25991;&#20214;&#20869;&#23481;&#21442;&#32771;user.json

{

    <span style="color: #8b2252;">"user_id"</span>: 5,

    <span style="color: #8b2252;">"username"</span>: <span style="color: #8b2252;">"test"</span>,

    <span style="color: #8b2252;">"email"</span>: <span style="color: #8b2252;">"test@qq.com"</span>,

    <span style="color: #8b2252;">"password"</span>: <span style="color: #8b2252;">"Harbor12345"</span>,

    <span style="color: #8b2252;">"realname"</span>: <span style="color: #8b2252;">"test"</span>,

    <span style="color: #8b2252;">"role_id"</span>: 0

}

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;&#29992;&#25143;&#20449;&#24687;,&#38500;admin&#22806;</span>

curl -u <span style="color: #8b2252;">"admin:Harbor12345"</span> -X GET -H <span style="color: #8b2252;">"Content-Type: application/json"</span> <span style="color: #8b2252;">"http://172.168.1.249/api/users"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#29992;&#25143;&#20449;&#24687;</span>

curl -u <span style="color: #8b2252;">"admin:Harbor12345"</span> -X GET -H <span style="color: #8b2252;">"Content-Type: application/json"</span> <span style="color: #8b2252;">"http://172.168.1.249/api/users/current"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#29992;&#25143;,3&#26159;&#29992;&#25143;user_id</span>

curl -u <span style="color: #8b2252;">"admin:Harbor12345"</span> -X DELETE -H <span style="color: #8b2252;">"Content-Type: application/json"</span> <span style="color: #8b2252;">"http://172.168.1.249/api/users/34"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;&#29992;&#25143;&#23494;&#30721;</span>

curl -u <span style="color: #8b2252;">"admin:Harbor12345"</span> -X PUT -H <span style="color: #8b2252;">"Content-Type: application/json"</span> <span style="color: #8b2252;">"http://172.168.1.249/api/users/4/password"</span> -d @uppwd.json

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#39033;&#30446;&#30456;&#20851;&#35282;&#33394;</span>

curl -u <span style="color: #8b2252;">"admin:Harbor12345"</span> -X GET -H <span style="color: #8b2252;">"Content-Type: application/json"</span> <span style="color: #8b2252;">"http://172.168.1.249/api/projects/2/members/"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#39033;&#30446;&#28155;&#21152;&#35282;&#33394;</span>

curl -u <span style="color: #8b2252;">"jaymarco:Harbor123456"</span> -X POST -H <span style="color: #8b2252;">"Content-Type: application/json"</span> <span style="color: #8b2252;">"http://172.168.1.249/api/projects/2/members/"</span> -d @role.json

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#38236;&#20687;</span>

curl -u <span style="color: #8b2252;">"admin:Harbor12345"</span> -X GET -H <span style="color: #8b2252;">"Content-Type: application/json"</span> <span style="color: #8b2252;">"http://172.168.1.249/api/repositories?project_id=2&amp;q=&#38236;&#20687;&#21517;"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#38236;&#20687;</span>

curl -u <span style="color: #8b2252;">"admin:Harbor12345"</span> -X DELETE -H <span style="color: #8b2252;">"Content-Type: application/json"</span> <span style="color: #8b2252;">"http://172.168.1.249/api/repositories/marktrace%2Fasset/tags/latest"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;&#38236;&#20687;&#26631;&#31614;</span>

curl -s -u <span style="color: #8b2252;">"admin:Harbor12345"</span> -X GET -H <span style="color: #8b2252;">"Content-Type: application/json"</span> <span style="color: #8b2252;">"http://172.168.1.249/api/repositories/marktrace%2Fasset/tags/"</span> |grep <span style="color: #8b2252;">"digest"</span> -C 2 |grep <span style="color: #8b2252;">""</span>name<span style="color: #8b2252;">""</span>
</pre>
</div>



<p>
具体使用参考，运维篇
</p>

<p>
下载地址：<a href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/">https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/</a>
</p>

<div class="org-src-container">
<pre class="src src-shell">wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-13.0.3-ce.0.el7.x86_64.rpm
yum install gitlab-ce-13.0.3-ce.0.el7.x86_64.rpm -y
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">vim /etc/gitlab/gitlab.rb
external_url <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;  gitlab.test.com</span>
gitlab-ctl reconfigure

<span style="color: #b22222;"># </span><span style="color: #b22222;">win &#20462;&#25913;</span>
win hosts
10.4.7.107 gitlab.test.com
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d6df48a5-78c6-4a60-b671-23fea6439e7a" class="outline-3">
<h3 id="h:d6df48a5-78c6-4a60-b671-23fea6439e7a">样例</h3>
<div class="outline-text-3" id="text-h:d6df48a5-78c6-4a60-b671-23fea6439e7a">
<p>
<a href="../../cicd/cicd.html">cicd</a>
</p>
</div>
</div>
</section>
</main class="container">
<footer id="postamble" class="status">
<footer data-astro-cid-sz7xmlte data-turbo-permanent id=rootFooter>
    <script>
        const shuffle = e => e.map((e => ({
            v: e,
            sort: Math.random()
        }))).sort(( (e, o) => e.sort - o.sort)).map(( ({v: e}) => e));
        var songList = ["barbie-girl--stantough", "blue-da-ba-dee--cornelius-link", "hips-dont-lie--stantough", "i-want-it-that-way--stantough", "seven-nation-army--stantough", "smooth-criminal--stantough"]
          , songOrder = songOrder ?? shuffle(songList).map((e => `/audio/music/${e}.opus`))
          , song = new Audio(songOrder[0])
          , nextSong = new Audio(songOrder[1])
          , songIndex = 2
          , musicWrapper = void 0
          , arrow = void 0
          , notes = void 0;
        song.addEventListener("ended", next);
        const toggle = () => song.paused ? play() : pause();
        function play() {
            song.play(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.add("shakeManHorse"),
            notes.classList.remove("hideNotes")
        }
        function pause() {
            song.pause(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.remove("shakeManHorse"),
            notes.classList.add("hideNotes")
        }
        function next() {
            song = nextSong,
            play(),
            songIndex === songOrder.length && (songIndex = 0),
            nextSong = new Audio(songOrder[songIndex]),
            songIndex += 1
        }
        function skip() {
            pause(),
            (arrow = arrow || document.getElementById("musicArrow")).classList.add("shootArrow");
            new Audio("/audio/effects/ohno.m4a").play(),
            arrow.addEventListener("animationend", arrowShootHandler, !1)
        }
        function arrowShootHandler() {
            arrow.removeEventListener("animationend", arrowShootHandler, !1),
            arrow.classList.remove("shootArrow");
            new Audio("/audio/effects/heythathurt.m4a").play(),
            next()
        }
    </script>
    <div id=musicPlayer data-astro-cid-q7a5pyro>
        <button class=skip data-astro-cid-q7a5pyro onclick=skip() title="Skip song">
            <div id=skipWrapper data-astro-cid-q7a5pyro>
                <img alt="Medieval drollery of a man/snail/bat/monkey shooting an arrow" class=archer decoding=async height=334 loading=lazy src=/images/archer-no-arrow.448ccd8b_Z1KfRYq.webp width=226 data-astro-cid-q7a5pyro>
                <img alt="Arrow for archer" class="arrow complete" decoding=async height=23 loading=lazy src=/images/no-archer-full-arrow.87aa9971_Z2qL2KO.webp width=141 data-astro-cid-q7a5pyro id=musicArrow>
            </div>
        </button>
        <button class=playPause data-astro-cid-q7a5pyro onclick=toggle() title="Play/pause song">
            <div id=musicWrapper data-astro-cid-q7a5pyro>
                <div class=hideNotes id=notesWrapper data-astro-cid-q7a5pyro>
                    <div class=lyreNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                    <div class=fluteNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                </div>
                <img alt="Medieval drollery of a man/horse playing a lyre and a horn" class=manHorse decoding=async height=665 loading=lazy src=/images/man-horse-band.e3a2efcf_q8FCa.webp width=531 data-astro-cid-q7a5pyro>
            </div>
        </button>
    </div>
    <hr data-astro-cid-sz7xmlte>
    <div class=salutation data-astro-cid-gdmrbrho>
        <p data-astro-cid-gdmrbrho>
            <span class=flower2 data-astro-cid-gdmrbrho>A</span>
            <span class=smallcap data-astro-cid-gdmrbrho>pax vobiscum</span>
            <span class="flower2 wiggle" data-astro-cid-gdmrbrho id=leaf>a</span>
        </p>
    </div>
    <script>
        function animateLeafBlownHandler() {
            leaf.removeEventListener("animationend", animateLeafBlownHandler, !1),
            leaf.classList.remove("blownAway"),
            leaf.classList.add("wiggle")
        }
        function animateLeaf() {
            leaf = leaf ?? document.getElementById("leaf"),
            leaf.classList.remove("wiggle"),
            leaf.classList.add("blownAway"),
            leaf.addEventListener("animationend", animateLeafBlownHandler, !1)
        }
        document.getElementById("leaf").onclick = animateLeaf
    </script>


    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2024 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
</footer>
</footer>
</body>
</html>
