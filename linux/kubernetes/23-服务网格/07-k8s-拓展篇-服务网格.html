<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kubernetes: 07-k8s-拓展-服务网络</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/font.css"/>
<link rel="stylesheet" type="text/css" href="/static/drollery.e825b870.css"/>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<header id="preamble" class="status">
<header class="{className}" data-astro-cid-3ef6ksr2>
  <div class=header-branding data-astro-cid-g2lrb5xm>
      <span class=header-text data-astro-cid-g2lrb5xm>
          <span class=dropcap data-astro-cid-g2lrb5xm aria-hidden=true>
              <span class=actual data-astro-cid-g2lrb5xm>J</span>
              <span class=rest data-astro-cid-g2lrb5xm>asper Hsu</span>
              <span class=period data-astro-cid-g2lrb5xm>.</span>
          </span>
          <span class=sr-only data-astro-cid-g2lrb5xm>Drollery</span>
      </span>
      <img alt="Medieval drollery of a knight on a horse" class=spring decoding=async height=250 loading=lazy src=/images/knight-horse.a96eee7d_Z1WCOYs.webp width=68 data-astro-cid-g2lrb5xm>
  </div>

  <nav data-astro-cid-pux6a34n>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/jcodelog.html class=nobracket data-astro-cid-pux6a34n>技术</a>
      <span class=flower2 data-astro-cid-pux6a34n>K</span>
      <a href=/reading/index.html class=nobracket data-astro-cid-pux6a34n>阅读</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
      <a href=/lisp/jasper-emacs.html class=nobracket data-astro-cid-pux6a34n>我的Emacs配置</a>
      <span class=flower2 data-astro-cid-pux6a34n>L</span>
      <a href=/link/index.html class=nobracket data-astro-cid-pux6a34n>友链</a>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/about.html class=nobracket data-astro-cid-pux6a34n>关于</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
  </nav>


  <div class="container" data-astro-cid-3ef6ksr2>
    <p class="info" data-astro-cid-3ef6ksr2>
              🏆 欢迎来到本站：
              <a href="https://xuchangwei.com/">https://xuchangwei.com/</a>。
              <strong>希望这里有你感兴趣的内容</strong>。
            </p>
  </div>
  <div id=borderArtWrapper class="tt1" data-astro-cid-5hce7sga data-turbo-permanent>
      <script>
          var man, shakeCount = 0, noSound = new Audio("/audio/effects/no.m4a"), screamSound = new Audio("/audio/effects/scream.m4a");
          function animateManShakeHandler() {
              man.removeEventListener("animationend", animateManShakeHandler, !1),
              shakeCount += 1,
              man.classList.remove("shakeMan")
          }
          function animateManFallHandler() {
              man.removeEventListener("animationend", animateManFallHandler, !1),
              man.classList.add("hide")
          }
          function animateMan() {
              man = man ?? document.getElementById("borderMan"),
              3 === shakeCount ? (man.classList.add("fallMan"),
              screamSound.play(),
              man.addEventListener("animationend", animateManFallHandler, !1)) : (man.classList.add("shakeMan"),
              noSound.play(),
              man.addEventListener("animationend", animateManShakeHandler, !1))
          }
      </script>
      <div class=borderArt data-astro-cid-5dda5nwp id=articleBorder>
          <img alt="flowery border with man falling" decoding=async height=620 loading=lazy src=/images/border-vines-no-man.b7d246cc_DRxSe.webp width=909 class=border data-astro-cid-5dda5nwp>
          <div class=fallWrapper data-astro-cid-5dda5nwp>
              <img alt="flowery border with man falling" decoding=async height=292 loading=lazy src=/images/man-no-vines.247a3187_Z2ioXNM.webp width=98 class=man data-astro-cid-5dda5nwp id=borderMan onclick=animateMan()>
          </div>
      </div>
  </div>
</header>
</header>
<main class="container" id="content" class="content">
<header>
<h1 class="title">Kubernetes: 07-k8s-拓展-服务网络</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org82626f7">服务网格前世今生</a>
<ul>
<li><a href="#org4ff8aa9">应用架构演变历程</a></li>
<li><a href="#orged156aa">微服务带来的问</a></li>
<li><a href="#org29c0af5">服务网络应运而生</a>
<ul>
<li><a href="#orge216123">SpringCloud / Nacos 并非是完全之策</a></li>
<li><a href="#org784c602">服务网络应运而生</a></li>
<li><a href="#org174df06">什么是服务网络</a>
<ul>
<li><a href="#org6f3f225">服务网格功能</a></li>
<li><a href="#org5655265">服务网格产品</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#org638015a">服务网格 Istio</a>
<ul>
<li><a href="#org46babc1">Istio 架构</a>
<ul>
<li><a href="#org676a26e">Istio 数据平面-Envoy</a></li>
<li><a href="#org83c1382">Istio 控制平面-Istiod</a></li>
</ul>
</li>
<li><a href="#orgb1079ba">Istio 核心资源</a>
<ul>
<li><a href="#orge491ac6">Istio 东西流量管理-VirtualService</a>
<ul>
<li><a href="#org9de16bb">VirtualService 配置示例</a></li>
</ul>
</li>
<li><a href="#org9532afd">Istio 细粒度流量管理-DestinationRule</a>
<ul>
<li><a href="#orga8dd600">DestinationRule 配置分析</a></li>
</ul>
</li>
<li><a href="#orga6259ae">Istio 南北流量管理-Gateway</a>
<ul>
<li><a href="#orgcf76355">Gateway 配置分析</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgc89288a">服务网格 Istio 安装及项目发布</a>
<ul>
<li><a href="#orgcdc5291">Istio 安装</a>
<ul>
<li><a href="#org2cbc4c2">安装注意事项</a></li>
<li><a href="#org8dfc91e">使用 Operator 部署 istio</a></li>
<li><a href="#org5c880dc">配置自动注入</a></li>
<li><a href="#org575720f">可视化工具 kiali</a></li>
<li><a href="#org114d44c">prometheus 和 grafana</a></li>
</ul>
</li>
<li><a href="#orgca778f3">Istio 流量治理</a>
<ul>
<li><a href="#orgba7e154">部署测试用例</a>
<ul>
<li><a href="#org9c41e57">BookInfo 介绍</a></li>
<li><a href="#orge2cccaf">部署 bookinfo</a></li>
<li><a href="#org72781fe">使用 kiali 进行流量监测</a></li>
</ul>
</li>
<li><a href="#org42eb322">IngressGateway 发布服务原理</a></li>
<li><a href="#orgd7268cc">Istio 实现灰度部署</a>
<ul>
<li><a href="#org6adf102">主流发布方案</a></li>
<li><a href="#org937c083">istio 内如何实现灰度发布</a></li>
<li><a href="#orgb7618eb">使用 kiali 图形化管理微服务流量</a></li>
</ul>
</li>
<li><a href="#org8e88cff">Istio 实现 AB 测试</a></li>
<li><a href="#org80195b6">Istio 地址重写和重写向</a>
<ul>
<li><a href="#org16943d4">新旧地址替换</a></li>
<li><a href="#org6c3b637">前后端分离-rewrite 实践</a></li>
</ul>
</li>
<li><a href="#org0f913c5">Istio 负载均衡算法</a></li>
<li><a href="#org6bdaac9">Istio 熔断-并发数连接限制</a></li>
<li><a href="#org874143e">Istio 故障处理</a>
<ul>
<li><a href="#org69adcff">Istio 注入延迟故障</a></li>
<li><a href="#org209c1c8">Istio 注入中断故障</a></li>
<li><a href="#orga206426">Istio 快速超时配置</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../index.html">Kubernetes</a><br></li>
</ul>
<section id="outline-container-org82626f7" class="outline-2">
<h2 id="org82626f7">服务网格前世今生</h2>
<div class="outline-text-2" id="text-org82626f7">
</div>
<div id="outline-container-org4ff8aa9" class="outline-3">
<h3 id="org4ff8aa9">应用架构演变历程</h3>
<div class="outline-text-3" id="text-org4ff8aa9">
<ul class="org-ul">
<li>单体应用<br>
<ul class="org-ul">
<li>退款、登录、下单<br></li>
<li>对某个非关键部分更新影响全局<br></li>
</ul></li>
<li>微服务<br>
<ul class="org-ul">
<li>注册、登录、下单、退款<br></li>
</ul></li>
<li>函数<br>
<ul class="org-ul">
<li>微服务再拆分<br></li>
<li>delete ToDo, addToDo, updateToDo, listToDo, getToDo<br></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orged156aa" class="outline-3">
<h3 id="orged156aa">微服务带来的问</h3>
<div class="outline-text-3" id="text-orged156aa">
<p>
<b>单体应用到微服务带来的问题</b><br>
把单体应用拆分成很多的小模块或者小应用，带来的问题<br>
</p>
<ul class="org-ul">
<li>网络问题<br>
<ul class="org-ul">
<li>挂掉、响应慢<br></li>
</ul></li>
<li>安全性问题<br></li>
</ul>
</div>
</div>
<div id="outline-container-org29c0af5" class="outline-3">
<h3 id="org29c0af5">服务网络应运而生</h3>
<div class="outline-text-3" id="text-org29c0af5">
</div>
<div id="outline-container-orge216123" class="outline-4">
<h4 id="orge216123">SpringCloud / Nacos 并非是完全之策</h4>
<div class="outline-text-4" id="text-orge216123">
<p>
springcloud 是 java 语言；注册表同步是有时间的间隔的，要保证下线 pod ip 及时通知下线。<br>
网络功能代码还是需要开发人员维护（负载均衡、服务发现、熔断降级、动态路由、错误重试、安全通信等），应该只关心业务逻辑。<br>
</p>
</div>
</div>
<div id="outline-container-org784c602" class="outline-4">
<h4 id="org784c602">服务网络应运而生</h4>
<div class="outline-text-4" id="text-org784c602">
<p>
把业务逻辑和网络功能的代码拆分开，业务逻辑开发人员管理，网络功能由服务网络管理。<br>
</p>

<p>
服务网络是在微服务的基础上加了一层代理。<br>
</p>
</div>
</div>
<div id="outline-container-org174df06" class="outline-4">
<h4 id="org174df06">什么是服务网络</h4>
<div class="outline-text-4" id="text-org174df06">
<p>
Service Mesh (服务网格) 是由 buoyant 公司的 ceo willian morgan 发起，目标为解决服务之间复杂的链路关系。<br>
Service Mesh 将程序开发的网络功能和程序本身解耦，网络功能下沉到基础架构，由服务网络实现服务之间的负载均衡等功能，并且除网络功能外，也提供了其它更高级的功能，比如全链路加密、监控、链路追踪等。<br>
</p>
</div>
<div id="outline-container-org6f3f225" class="outline-5">
<h5 id="org6f3f225">服务网格功能</h5>
<div class="outline-text-5" id="text-org6f3f225">
<ul class="org-ul">
<li>负载均衡<br></li>
<li>服务发布<br></li>
<li>熔断降级<br></li>
<li>动态路由<br></li>
<li>故障注入<br></li>
<li>错误重试 （存在幂等性问题，如 a请求 b，b 已经在处理了返回504超时，a再调 b 就存在幂等问题，充值场景）<br></li>
<li>安全通信<br></li>
<li>语言无关<br></li>
</ul>
</div>
</div>
<div id="outline-container-org5655265" class="outline-5">
<h5 id="org5655265">服务网格产品</h5>
<div class="outline-text-5" id="text-org5655265">
<ul class="org-ul">
<li>Linkerd<br></li>
</ul>
<p>
Buoyant 公司在 2016年率先开源的高性能网络代理程序，它的出现标志着 Service Mesh 时代开始<br>
</p>
<ul class="org-ul">
<li>Envoy<br></li>
</ul>
<p>
同 Linkerd 一样，Envoy 也是一款高性能的网络代理程序，为云原生应用而设计<br>
</p>
<ul class="org-ul">
<li>Istio<br></li>
</ul>
<p>
Istio 受 google, ibm, Lyft 及 RedHat 公司的大力支持和推广，于2017年5月底发布，底层为 envoy<br>
</p>
<ul class="org-ul">
<li>Conduit<br></li>
</ul>
<p>
2017年12月发布，是 buoyant 公司的第二款 Service Mesh 产品，根据 Linkerd 在生产线上的实际使用经验而设计，并以最小复杂性作为设计基础。<br>
</p>
<ul class="org-ul">
<li>Kuma<br></li>
</ul>
<p>
由 kong 开发并提供支持，一个通用的现代服务网格控制平面，基于 envoy 构建。kuma 高效的数据平面和先进的控制平面，极大地降低了各团队使用的难度。<br>
</p>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-org638015a" class="outline-2">
<h2 id="org638015a">服务网格 Istio</h2>
<div class="outline-text-2" id="text-org638015a">
</div>
<div id="outline-container-org46babc1" class="outline-3">
<h3 id="org46babc1">Istio 架构</h3>
<div class="outline-text-3" id="text-org46babc1">
<p>
Istio mesh<br>
</p>
<ul class="org-ul">
<li>Data plane<br>
<ul class="org-ul">
<li>Pod sidecar: proxy<br></li>
</ul></li>
<li>Control plane<br>
<ul class="org-ul">
<li>Istiod: Pilot, Citadel, Galley 组件<br></li>
</ul></li>
<li>流量<br>
<ul class="org-ul">
<li>Ingress gateway 入口流量<br></li>
<li>Egress gateway 出口流量<br></li>
</ul></li>
</ul>

<p>
分 2 层数据平面和控制平面。控制层面是对配置进行统一管理，配置可以分发到不同的数据<br>
层面，每个微服务都会 sidecar proxy，proxy 是 istio 的话就是 envoy。 istios 即能管理东西流量即服务之间的流量，也能管理南北流量即出入口流量<br>
</p>
</div>
<div id="outline-container-org676a26e" class="outline-4">
<h4 id="org676a26e">Istio 数据平面-Envoy</h4>
<div class="outline-text-4" id="text-org676a26e">
<p>
Pod<br>
</p>
<ul class="org-ul">
<li>应用容器<br></li>
<li>Envoy 容器<br></li>
</ul>

<p>
istio 的数据平面使用的是 envoy，Envoy 是以 c++ 开发的高性能代理，用于调解服务网络中所有服务的所有入站和出站流量。envoy 代理是唯一一个与数据平面流量交互的 istio 组件。<br>
</p>

<p>
功能：<br>
</p>
<ul class="org-ul">
<li>动态服务发布<br></li>
<li>负载均衡<br></li>
<li>HTTP/2 &amp; gRPC 代理<br></li>
<li>熔断器<br></li>
<li>健康检查、基于百分比流量分析的灰度发布<br></li>
<li>故障注入<br></li>
<li>丰富的度量指标<br></li>
</ul>
</div>
</div>
<div id="outline-container-org83c1382" class="outline-4">
<h4 id="org83c1382">Istio 控制平面-Istiod</h4>
<div class="outline-text-4" id="text-org83c1382">
<p>
Istiod 为 Istio 的控制平面，提供服务发布、配置、证书管理、加密通信和认证。早期的 Istio 控制平台没有 istiod 这个容器，而是由 Mixer(新版本已废弃)、Pilot、Citadel 共同组成，后来为了简化 istio 的架构，将其合并为 istiod，所以对于新版本的 Istio(v1.5+)，部署后仅能看到 istiod 一个 pod。<br>
</p>

<ul class="org-ul">
<li>Pilot: 为 Envoy Sidecar 提供服务发现的功能，为智能路由（例如 A/B 测试、金丝兴雀部署等）和弹性（超时、重试、熔断器等）提供流量管理功能。<br></li>
<li>Citadel：通过内置身份和凭证管理可以提供强大的服务与服务之间的最终身份验证，可以用于升级服务网络中未加密的流量。但我们一般会集成第三方组件来做用户验证如 OPA<br></li>
<li>Galley：负责配置管理的组件，用于验证配置信息的格式和正确性。Galley 使用网格配置协议（ Mesh Configuration Protocol）和其它组件进行配置交互。<br></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgb1079ba" class="outline-3">
<h3 id="orgb1079ba">Istio 核心资源</h3>
<div class="outline-text-3" id="text-orgb1079ba">
<p>
kubernetes 最终生成的是容器，管理的是 Pod。<br>
</p>

<p>
和 kubernetest 一样 istio 中核心资源 VirtualService（VS）、DestinationRule（DR）、Gateway（GW） 最终生成的就是 envoy 配置。<br>
</p>
</div>
<div id="outline-container-orge491ac6" class="outline-4">
<h4 id="orge491ac6">Istio 东西流量管理-VirtualService</h4>
<div class="outline-text-4" id="text-orge491ac6">
<p>
简单理解就是和 service 在一个层面。<br>
</p>

<p>
k8s 中的 service 也是实现东西流量管理，只有简单的轮询功能<br>
k8s Service<br>
</p>
<ul class="org-ul">
<li>Pod<br></li>
<li>Pod<br></li>
</ul>

<p>
VirtualService：VirtualService（虚拟服务）基于 Istio 和对应平台提供的基本连通性和服务发现能力，将请求路由到对应的目标。每一个 VirtualService 包含一组路由规则，Istio 将每个请求根据路由匹配到指定的目标地址。<br>
</p>

<p>
exmapel-users<br>
</p>
<ul class="org-ul">
<li>Pod: deployment V1 版本，可配置百分比流量<br></li>
<li>Pod: deployment V2 版本，可配置百分比流量<br></li>
</ul>
</div>
<div id="outline-container-org9de16bb" class="outline-5">
<h5 id="org9de16bb">VirtualService 配置示例</h5>
<div class="outline-text-5" id="text-org9de16bb">

<figure id="orgcb4483c">
<img src="./images/Snipaste_2022-08-24_11-19-36.png" alt="Snipaste_2022-08-24_11-19-36.png"><br>

</figure>

<div class="org-src-container">
<pre class="src src-yaml">apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews-route
spec:
  hosts:
  - reviews.prod.svc.cluster.local
  http:
  - name: "reviews-v2-routes"
    match:
    - uri:
        prefix: "/wpcatalog"
    - uri:
        prefix: "/consumercatalog"
    rewrite:
      uri: "/newcatalog"
    route:
    - destination:
        host: reviews.prod.svc.cluster.local
        subset: v2
  - name: "reviews-v1-route"
    route:
    - destination:
        host: reviews.prod.svc.cluster.local
        subset: v1
</pre>
</div>

<ul class="org-ul">
<li>apiVersion：对应 API 版本<br></li>
<li>kind：资源类型<br></li>
<li>metadata：元数据。可 kubernetes 资源类似，可以定义 annotations、labels、name、namespace 等；<br></li>
<li>metadata.name： VirtualService 的名称<br></li>
<li>spec：关于 VirtualService 的定义<br></li>
<li>spec.hosts：VirtualService 的主机，即用户指定的目标或路由规则的目标，客户端向服务端发送请求时使用的一个或多个地址。<br></li>
<li>spec.http：路由规则配置，用来指定流量的路由行为，通过该处的配置将 HTTP/1.1、HTTP2 和 gRPC 等流量发送到 hosts 字段指定的目标<br></li>
<li>spec.http[].match：路由规则的条件，可以根据一些条件制定更加细粒度的路由。<br></li>
<li>route：路由规则，destination 字段指定了符合此条件的流量实际目标地址。<br></li>
</ul>


<p>
更多参考官网：<a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/">https://istio.io/latest/docs/reference/config/networking/virtual-service/</a><br>
</p>
</div>
</div>
</div>
<div id="outline-container-org9532afd" class="outline-4">
<h4 id="org9532afd">Istio 细粒度流量管理-DestinationRule</h4>
<div class="outline-text-4" id="text-org9532afd">
<p>
简单理解就是和 pod 在一个层面。<br>
</p>

<p>
类似于给 pod 定义不同标签。<br>
</p>

<p>
DestinationRule：DestinationRule（目标规则）用于后端真实的服务再做进一步划分。<br>
</p>

<p>
exmaple-Service: app=paycenter<br>
</p>
<ul class="org-ul">
<li>Deployment V1: pod: app=paycenter, version=v1<br></li>
<li>Deployment V2: pod: app=paycenter, version=v2<br></li>
</ul>

<p>
DR<br>
</p>
<ul class="org-ul">
<li>具有 app=paycenter 和 version=v1 标签的 pod，归为 v1 版本。<br></li>
<li>具有 app=paycenter 和 version=v2 标签的 pod，归为 v2 版本。<br></li>
</ul>
</div>
<div id="outline-container-orga8dd600" class="outline-5">
<h5 id="orga8dd600">DestinationRule 配置分析</h5>
<div class="outline-text-5" id="text-orga8dd600">

<figure id="orgdba8dd8">
<img src="./images/Snipaste_2022-08-24_14-29-58.png" alt="Snipaste_2022-08-24_14-29-58.png"><br>

</figure>

<div class="org-src-container">
<pre class="src src-yaml">apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: reviews-destination
spec:
  host: reviews.prod.svc.cluster.local
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
</pre>
</div>

<ul class="org-ul">
<li>apiVersion：对应 API 版本<br></li>
<li>kind：资源类型<br></li>
<li>metadata：元数据。可 kubernetes 资源类似，可以定义 annotations、labels、name、namespace 等；<br></li>
<li>metadata.name： DestinationRule 的名称<br></li>
<li>spec：关于 DestinationRule 的定义<br></li>
<li>spec.host：DestinationRule 的主机，即用户指定的目标或路由规则的目标，客户端向服务端发送请求时使用的地址。<br></li>
<li>spec.subnets：版本划分，可以将 pod 划分为不同的版本，进行细粒度的路由管控。<br></li>
</ul>


<p>
官方参考：<a href="https://istio.io/latest/docs/reference/config/networking/destination-rule/">https://istio.io/latest/docs/reference/config/networking/destination-rule/</a><br>
</p>
</div>
</div>
</div>
<div id="outline-container-orga6259ae" class="outline-4">
<h4 id="orga6259ae">Istio 南北流量管理-Gateway</h4>
<div class="outline-text-4" id="text-orga6259ae">
<p>
Gateway：Istio 网关功能，可以使用 Gateway 在网格最外层接收 HTTP/TCP 流量，并将流量转发到网格内的某个服务。同时支持出口流量的管控，可以将出口的流量固定从 EgressGateway 的服务中代理出去。<br>
</p>

<p>
k8s<br>
</p>
<ul class="org-ul">
<li>Istio System<br>
<ul class="org-ul">
<li>IngressGateway  管理入口流量<br></li>
<li>EgressGateway  管理出口流量<br></li>
</ul></li>
<li>Application<br>
<ul class="org-ul">
<li>APP<br></li>
<li>APP<br></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #0000ff;">            </span><span style="color: #0000ff;">|                              |</span>
<span style="color: #0000ff;">            </span><span style="color: #0000ff;">|                              |</span>
<span style="color: #0000ff;">+------+------------------------------+--------+</span>
<span style="color: #0000ff;">|+-----+---------+                   +-----+-------+|</span>
<span style="color: #0000ff;">||IngressGateway |              |Egres|Gateway||</span>
<span style="color: #0000ff;">|+-----+---------+--------------+-----+-------+|</span>
<span style="color: #0000ff;">|      |                              |        |</span>
<span style="color: #0000ff;">|      +------------------------------+        |</span>
<span style="color: #0000ff;">+------+------------------------------+--------+</span>
<span style="color: #0000ff;">            </span><span style="color: #0000ff;">|+--------------------------+  |</span>
<span style="color: #0000ff; text-decoration: line-through;">+------++</span><span style="color: #0000ff;">--------------------------+--+--------+</span>
<span style="color: #0000ff;">| +---------+                +--------+---+    |</span>
<span style="color: #0000ff;">| |  APP    |                |    APP     |    |</span>
<span style="color: #0000ff;">| +---------+                +------------+    |</span>
<span style="color: #0000ff;">|               Application                    |</span>
<span style="color: #0000ff;">+----------------------------------------------+</span>
</pre>
</div>
</div>
<div id="outline-container-orgcf76355" class="outline-5">
<h5 id="orgcf76355">Gateway 配置分析</h5>
<div class="outline-text-5" id="text-orgcf76355">

<figure id="org73ff3d6">
<img src="./images/Snipaste_2022-08-24_15-35-34.png" alt="Snipaste_2022-08-24_15-35-34.png"><br>

</figure>

<p>
一般会配置主机名或者是证书的配置或者是端口的配置，项目比较多可以拆分成多个 gateway。<br>
</p>

<div class="org-src-container">
<pre class="src src-shell">apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: ext-host-gwy
spec:
  selector:
    app: my-gateway-controller
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - ext-host.example.com
    tls:
      mode: SIMPLE
      credentialName: ext-host-cert
</pre>
</div>

<p>
VS 和 gateway 进行绑定<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: virtual-svc
spec:
  hosts:
  - ext-host.example.com
  gateways:
  - ext-host-gwy <span style="color: #b22222;"># </span><span style="color: #b22222;">&lt;gateway namespace&gt;/&lt;gateway name&gt; &#22914;&#26524;&#30465;&#30053;&#27492;&#23383;&#27573;&#65292;&#23558;&#20351;&#29992;&#40664;&#35748;&#32593;&#20851;&#65288;mesh&#65289;</span>
</pre>
</div>

<p>
官方参考：<a href="https://istio.io/latest/docs/concepts/traffic-management/#gateway-example">https://istio.io/latest/docs/concepts/traffic-management/#gateway-example</a><br>
<a href="https://istio.io/latest/docs/reference/config/networking/gateway/">https://istio.io/latest/docs/reference/config/networking/gateway/</a><br>
</p>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-orgc89288a" class="outline-2">
<h2 id="orgc89288a">服务网格 Istio 安装及项目发布</h2>
<div class="outline-text-2" id="text-orgc89288a">
</div>
<div id="outline-container-orgcdc5291" class="outline-3">
<h3 id="orgcdc5291">Istio 安装</h3>
<div class="outline-text-3" id="text-orgcdc5291">
</div>
<div id="outline-container-org2cbc4c2" class="outline-4">
<h4 id="org2cbc4c2">安装注意事项</h4>
<div class="outline-text-4" id="text-org2cbc4c2">
<p>
<a href="https://istio.io/latest/docs/setup/install/">https://istio.io/latest/docs/setup/install/</a><br>
</p>

<p>
推荐用 operator 安装<br>
</p>

<p>
支持版本与 k8s<br>
<a href="https://istio.io/latest/docs/releases/supported-releases/#support-status-of-istio-releases">https://istio.io/latest/docs/releases/supported-releases/#support-status-of-istio-releases</a><br>
</p>
</div>
</div>
<div id="outline-container-org8dfc91e" class="outline-4">
<h4 id="org8dfc91e">使用 Operator 部署 istio</h4>
<div class="outline-text-4" id="text-org8dfc91e">
<p>
下载地址：<a href="https://github.com/istio/istio/releases/">https://github.com/istio/istio/releases/</a><br>
</p>

<p>
安装 istioctl 客户端<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">curl -L -o istio-1.14.3-linux-amd64.tar.gz  https://github.com/istio/istio/releases/download/1.14.3/istio-1.14.3-linux-amd64.tar.gz
<span style="color: #b22222;">#</span><span style="color: #b22222;">curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.14.5 TARGET_ARCH=x86_64 sh -</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35299;&#21387;&#21518;&#65292;&#23558; istio &#30340;&#23458;&#25143;&#31471;&#24037;&#20855; istioctl &#31227;&#21160;&#21040; /usr/local/bin &#30446;&#24405;&#19979;</span>
tar xf istio-1.14.3-linux-amd64.tar.gz
mv istio-1.14.3/bin/istioctl /usr/local/bin/
istioctl version

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21629;&#20196;&#34917;&#20840;</span>
cp tools/istioctl.bash ~/
<span style="color: #483d8b;">source</span> ~/.bash_profile
</pre>
</div>

<p>
接下来安装 istio 的 operator，可以使用 istioctl 一键部署<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">istioctl operator init
</pre>
</div>

<p>
出现 Installation complete 后，查看 pod 是否正常：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl get po -n istio-operator
</pre>
</div>

<p>
之后通过定义 IstioOperator 资源，在 kubernetes 中安装 Istio:<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl apply -f - &lt;&lt;EOF
<span style="color: #ffa54f;">apiVersion: install.istio.io/v1alpha1</span>
<span style="color: #ffa54f;">kind: IstioOperator</span>
<span style="color: #ffa54f;">metadata:</span>
<span style="color: #ffa54f;">  namespace: istio-system</span>
<span style="color: #ffa54f;">  name: example-istiocontrolplane</span>
<span style="color: #ffa54f;">spec:</span>
<span style="color: #ffa54f;">  profile: default</span>
<span style="color: #ffa54f;">  components: # &#33258;&#23450;&#20041;&#32452;&#20214;&#37197;&#32622;</span>
<span style="color: #ffa54f;">    ingressGateways: # &#33258;&#23450;&#20041; ingressGateway &#37197;&#32622;</span>
<span style="color: #ffa54f;">      - name: istio-ingressgateway</span>
<span style="color: #ffa54f;">        enabled: true #  &#24320;&#21551; ingressgateway</span>
<span style="color: #ffa54f;">        k8s:          # &#33258;&#23450;&#20041; ingressgateway &#30340; kubernetes &#37197;&#32622;</span>
<span style="color: #ffa54f;">          service:    # &#23558; Service &#31867;&#22411;&#25913;&#20026; nodePort&#65292;&#40664;&#35748;&#26159; loadbalancer &#31867;&#22411;</span>
<span style="color: #ffa54f;">            type: NodePort</span>
<span style="color: #ffa54f;">            ports:</span>
<span style="color: #ffa54f;">            - port: 15020</span>
<span style="color: #ffa54f;">              nodePort: 30520</span>
<span style="color: #ffa54f;">              name: status-port</span>
<span style="color: #ffa54f;">            - port: 80 # &#27969;&#37327;&#20837;&#21475; 80 &#31471;&#21475;&#26144;&#23556;&#21040; nodePort &#30340; 30080&#65292;&#20043;&#21518;&#36890;&#36807;&#33410;&#28857; IP+30080 &#21363;&#21487;&#35775;&#38382; Istio &#26381;&#21153;</span>
<span style="color: #ffa54f;">              nodePort: 30080</span>
<span style="color: #ffa54f;">              name: http2</span>
<span style="color: #ffa54f;">              targetPort: 8080</span>
<span style="color: #ffa54f;">            - port: 443</span>
<span style="color: #ffa54f;">              nodePort: 30443</span>
<span style="color: #ffa54f;">              name: https</span>
<span style="color: #ffa54f;">              targetPort: 8443</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">istioctl  manifest apply -f istio-operator.yaml</span>
</pre>
</div>

<ul class="org-ul">
<li>profile：根据IstioOperator API的默认设置启用组件。建议将此配置文件用于生产部署和多集群网格中的主集群。通过运行istioctl profile dump命令，可以显示默认设置。<a href="https://istio.io/latest/docs/setup/additional-setup/config-profiles/">https://istio.io/latest/docs/setup/additional-setup/config-profiles/</a><br></li>
</ul>

<p>
官方文档 IstioOperator：<a href="https://istio.io/latest/docs/reference/config/istio.operator.v1alpha1/">https://istio.io/latest/docs/reference/config/istio.operator.v1alpha1/</a><br>
</p>

<p>
查看：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl get svc,po -n istio-sytem
</pre>
</div>
<p>
等待全部安装完成， istio core 、isitod、ingress gateways<br>
</p>
</div>
</div>
<div id="outline-container-org5c880dc" class="outline-4">
<h4 id="org5c880dc">配置自动注入</h4>
<div class="outline-text-4" id="text-org5c880dc">
<p>
修改 APIserver 的配置文件，添加 MutatingAdmissionWebhook, ValidatingAdmissionWebhook（如果 kubernetes 大于 1.16 默认已经开启）：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">vim /etc/kubernetes/manifests/kube-apiserver.yaml <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#20108;&#36827;&#21046;&#23433;&#35013;&#26041;&#24335;&#38656;&#35201;&#25214;&#21040; APIserver &#30340; Service &#25991;&#20214;</span>
- --enable-admission-plugins=MutatingAdmissionWebhook, ValidatingAdmissionWebhook <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#36861;&#21152;&#36825;&#20004;&#39033;</span>
</pre>
</div>

<p>
接下来创建一个测试的 namespace，并添加一个 istio-injection=enabled 的标签，之后在该 namespace 下创建的 pod 就会自动注入 istio 的 proxy<br>
</p>

<p>
创建 namespace 并添加 label:<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl create ns istio-test
kubectl lable namespace istio-test istio-injection=enabled
</pre>
</div>

<p>
切换目录至 istio 的安装包，然后创建测试应用，此时创建的 pod 会被自动注入一个 istio-proxy 容器。<br>
</p>
</div>
</div>
<div id="outline-container-org575720f" class="outline-4">
<h4 id="org575720f">可视化工具 kiali</h4>
<div class="outline-text-4" id="text-org575720f">
<p>
Kiali 为 istio 提供了可视化的界面，可以 kaili 上进行观测流量的走向、调用链，同时还可以使用 kiali 进行配置管理，给用户带来了很好的体验。<br>
</p>

<p>
接下来在  kubernetes 中安装 kiali 工具，首先进入到 istio 的安装包目录：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl create -f samples/addons/kiali.yaml
</pre>
</div>

<p>
查看部署状态：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl get po,svc -n istio-system -l <span style="color: #a0522d;">app</span>=kiali
</pre>
</div>

<p>
配置 ingress 或者 service 改为 nodePort 就可以访问 kiali 服务。<br>
</p>

<p>
在 graph 页面可以看到应用的流量信息。<br>
</p>

<p>
除了 kiali 之外，还需要一个链路追踪工具，安装该工具可以在 kiali 的 workload 页面，查看某个服务的 Traces 信息。直接安装即可：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl create -f samples/addons/jaeger.yaml
</pre>
</div>
</div>
</div>
<div id="outline-container-org114d44c" class="outline-4">
<h4 id="org114d44c">prometheus 和 grafana</h4>
<div class="outline-text-4" id="text-org114d44c">
<p>
Istio 默认暴露了很多监控指标，比如请求数量统计、请求持续时间以及 Service 和工作负载的指标，这些指标可以使用 prometheus 进行收集，grafana 进行展示。<br>
</p>

<p>
Istio 内置了 prometheus 和 grafana 的安装文件，直接安装即可（也可以使用外置的）：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl create -f samples/addons/prometheus.yaml -f samples/addons/grafana.yaml
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgca778f3" class="outline-3">
<h3 id="orgca778f3">Istio 流量治理</h3>
<div class="outline-text-3" id="text-orgca778f3">
</div>
<div id="outline-container-orgba7e154" class="outline-4">
<h4 id="orgba7e154">部署测试用例</h4>
<div class="outline-text-4" id="text-orgba7e154">
</div>
<div id="outline-container-org9c41e57" class="outline-5">
<h5 id="org9c41e57">BookInfo 介绍</h5>
<div class="outline-text-5" id="text-org9c41e57">
<p>
<a href="https://istio.io/latest/docs/examples/bookinfo/">https://istio.io/latest/docs/examples/bookinfo/</a><br>
</p>

<ul class="org-ul">
<li>productpage: productpage 微服务会调用 details 和 reviews 两个微服务，用来生成页面。<br></li>
<li>details：包含了图书的信息<br></li>
<li>reviews：包含了图书相关的评论，它还会调用 ratings 微服务；<br></li>
<li>ratings:：包含了由图书评价组成的评级信息。<br></li>
</ul>

<p>
除了上述外，reviews 微服务还分为了 3 个版本：<br>
</p>
<ul class="org-ul">
<li>v1版本：不会调用 ratings 服务，即不会在页面显示书的评分；<br></li>
<li>v2版本：会调用 ratings 服务，并使用 1 到 5 个黑色星形图标来显示评分信息；<br></li>
<li>v3版本：会调用 ratings 服务，并使用 1 到 5 个红色星形图标来显示评分信息；<br></li>
</ul>
</div>
</div>
<div id="outline-container-orge2cccaf" class="outline-5">
<h5 id="orge2cccaf">部署 bookinfo</h5>
<div class="outline-text-5" id="text-orge2cccaf">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#21517;&#31216;&#31354;&#38388;</span>
kubectl create ns bookinfo

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#33258;&#21160;&#27880;&#20837; proxy</span>
kubectl label namespace bookinfo istio-injection=enabled

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37096;&#32626; bookinfo</span>
kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml -n bookinfo

kubectl get po,svc -n istio-system
</pre>
</div>

<p>
要确认 Bookinfo 应用程序正在运行，请通过来自某个 pod 的 curl 命令向它发送请求，例如来自 ratings<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl exec <span style="color: #8b2252;">"$(</span><span style="color: #ff00ff;">kubectl get pod -l app=ratings -o jsonpath='{.items[0].metadata.name}'</span><span style="color: #8b2252;">)"</span> -c ratings -- curl -sS productpage:9080/productpage | grep -o <span style="color: #8b2252;">"&lt;title&gt;.*&lt;/title&gt;"</span>

&lt;title&gt;Simple Bookstore App&lt;/title&gt;
</pre>
</div>

<p>
接下来创建 Istio 的 Gateway 和 VirtualService 实现域名访问 bookinfo 项目。<br>
</p>

<p>
首先创建 Gateway，假设域名是 bookinfo.kubeasy.com。gateway 配置如下 ：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">cat  samples/bookinfo/networking/bookinfo-gateway.yaml
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway <span style="color: #b22222;"># </span><span style="color: #b22222;">use istio default controller</span>
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - <span style="color: #8b2252;">"*.kubeasy.com"</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21457;&#24067;&#22495;&#21517;&#65292;&#21482;&#20889; * &#20195;&#34920;&#25509;&#25910;&#20840;&#37096;&#27969;&#37327;&#65292;&#29983;&#20135;&#29615;&#22659;&#24314;&#35774;&#19968;&#20010;&#39033;&#30446;&#19968;&#20010; gateway</span>
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo
spec:
  hosts:
  - <span style="color: #8b2252;">"bookinfo.kubeasy.com"</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#25512;&#33616;&#20889; * </span>
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage
        port:
          number: 9080
</pre>
</div>
</div>
</div>
<div id="outline-container-org72781fe" class="outline-5">
<h5 id="org72781fe">使用 kiali 进行流量监测</h5>
<div class="outline-text-5" id="text-org72781fe">
<p>
Graph 可以看到微服务之间的调用关系。点某个服务可以看到流量信息等。<br>
</p>
</div>
</div>
</div>
<div id="outline-container-org42eb322" class="outline-4">
<h4 id="org42eb322">IngressGateway 发布服务原理</h4>
<div class="outline-text-4" id="text-org42eb322">
<p>
使用域名发布服务：<br>
</p>
<ul class="org-ul">
<li>Ingress Controller(ingress-nginx) &#x2013;&gt; Service &#x2013;&gt; Pod<br></li>
<li>Ingress Gateway(istio) &#x2013;&gt; VirtualService( Gateway binding &#x2013;&gt; Service ) &#x2013;&gt; Pod<br></li>
</ul>
</div>
</div>
<div id="outline-container-orgd7268cc" class="outline-4">
<h4 id="orgd7268cc">Istio 实现灰度部署</h4>
<div class="outline-text-4" id="text-orgd7268cc">
<p>
梯度的方式给不同版本分配流量百分比<br>
</p>

<p>
用测试用例模拟生产情况，把 v2, v3 先关闭<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl scale deploy --replicas=0 reviews-v2 reviews-v3 -n bookinfo
</pre>
</div>
</div>
<div id="outline-container-org6adf102" class="outline-5">
<h5 id="org6adf102">主流发布方案</h5>
<div class="outline-text-5" id="text-org6adf102">
<ul class="org-ul">
<li>主流发布方案<br>
<ul class="org-ul">
<li>蓝绿发布<br></li>
<li>滚动发布<br></li>
<li>灰度发布<br></li>
<li>A/B Test<br></li>
</ul></li>
</ul>

<p>
滚动发布：<br>
每次只升级一个或多个服务，升级完成后加入生产环境，不断执行这个过程，直到集群中的全部旧版升级新版本。Kubernetes的默认发布策略，替换生产的镜像。<br>
</p>
<ul class="org-ul">
<li>特点:<br>
<ul class="org-ul">
<li>用户无感知，平滑过渡<br></li>
</ul></li>
<li>缺点：<br>
<ul class="org-ul">
<li>部署周期长<br></li>
<li>发布策略复杂<br></li>
<li>不易回滚<br></li>
<li>有影响范围较大<br></li>
</ul></li>
</ul>


<p>
灰度发布：<br>
只升级部分服务，即让一部分用户继续用老版本，一部分用户开始用新版本，如果用户对新版本没有什么 意见，那么逐步扩大范围，把所有用户都迁移到新版 本上面来。如，生产是 v1 版本， 切部分流量到 v2 新版本，只影响部分用户，没问题后切 100%  流量，v1 下线。<br>
</p>
<ul class="org-ul">
<li>特点：<br>
<ul class="org-ul">
<li>保证系统整体稳定性<br></li>
<li>用户无感知，平滑过渡<br></li>
</ul></li>
<li>缺点：<br>
<ul class="org-ul">
<li>自动化要求高<br></li>
</ul></li>
</ul>

<p>
金丝雀发布：<br>
</p>

<p>
蓝绿发布：<br>
项目逻辑上分为AB组，上线新版本，100%  流量切到新版本，有问题再切回去。<br>
</p>
<ul class="org-ul">
<li>特点:<br>
<ul class="org-ul">
<li>策略简单<br></li>
<li>升级/回滚速度快<br></li>
<li>用户无感知，平滑过渡<br></li>
</ul></li>
<li>缺点：<br>
<ul class="org-ul">
<li>需要两倍以上服务器资源<br></li>
<li>短时间内浪费一定资源成本<br></li>
<li>有问题影响范围大<br></li>
</ul></li>
</ul>

<p>
A/B Test：<br>
灰度发布的一种方式，主要对特定用户采样后，对收 集到的反馈数据做相关对比，然后根据比对结果作出决策。用来测试应用功能表现的方法, 侧重应用的可用性，受欢迎程度等，最后决定是否升级。<br>
</p>
</div>
</div>
<div id="outline-container-org937c083" class="outline-5">
<h5 id="org937c083">istio 内如何实现灰度发布</h5>
<div class="outline-text-5" id="text-org937c083">
<p>
定义微服务的标签，属于哪个项目、前后端、名称、版本<br>
</p>

<ul class="org-ul">
<li>Service：app=xxx<br></li>
<li>Deployment：版本标签<br>
<ul class="org-ul">
<li>Pod：app=xxx, version=v1<br></li>
<li>Pod：app=xxx, version=v2<br></li>
</ul></li>
</ul>

<p>
使用 VS 做拦截来控制流量。<br>
VirtualService<br>
</p>
<ul class="org-ul">
<li>subnet: v1<br></li>
<li>subnet: v2<br></li>
</ul>

<p>
步骤：<br>
</p>
<ul class="org-ul">
<li>使用 DR 划分 subnet<br>
<ul class="org-ul">
<li>具有 version=v1 标签的划分 subnet=v1；具有 version=v2 标签的划分 subnet=v2<br></li>
</ul></li>
<li>使用 VS 将流量导向旧版本<br></li>
<li>部署新版本<br></li>
<li>使用 VS 切换流量<br></li>
</ul>


<p>
步骤1-创建 DR 划分 subnet：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">vim reviews-dr.yaml
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  subsets:
  - name: v1
    labels:
      version: v1 <span style="color: #b22222;"># </span><span style="color: #b22222;">subnet v1 &#25351;&#21521;&#20855;&#26377; version=v1 &#30340; pod</span>
  - name: v2
    labels:
      version: v2 <span style="color: #b22222;"># </span><span style="color: #b22222;">subnet v2 &#25351;&#21521;&#20855;&#26377; version=v2 &#30340; pod</span>
  - name: v3
    labels:
      version: v3 <span style="color: #b22222;"># </span><span style="color: #b22222;">subnet v3 &#25351;&#21521;&#20855;&#26377; version=v3 &#30340; pod</span>


kubectl create -f reviews-dr.yaml -n bookinfo

kubectl get dr -n bookinfo
</pre>
</div>

<p>
步骤2-创建 VS 将流量导向旧版本:<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">vim reviews-v1-all.yaml
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
    - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;&#27969;&#37327;&#25351;&#21521; v1</span>

kubectl create -f reviews-v1-all.yaml -n bookinfo
</pre>
</div>
<p>
再次刷新浏览器，不再评分<br>
</p>

<p>
步骤3-部署新版本：<br>
启动新版本 v2<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl scale deploy --replicas=1 reviews-v2 -n bookinfo
</pre>
</div>


<p>
步骤4-使用 VS 切换流量：<br>
接下来修改 virtualService，将 20% 流量导向 v2 版本：<br>
</p>
<div class="org-src-container">
<pre class="src src-sh">vim reviews-20v2-80v1.yaml
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
    - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558; 80% &#27969;&#37327;&#25351;&#21521; v1</span>
      weight: 80   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21482;&#38656;&#35201;&#37197;&#32622;&#19968;&#20010; weight &#21442;&#25968;&#21363;&#21487;</span>
    - destination:
        host: reviews
        subset: v2 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558; 20% &#27969;&#37327;&#25351;&#21521; v2</span>
      weight: 20

kubectl replace -f reviews-20v2-80v1.yaml -n bookinfo
</pre>
</div>

<p>
没问题后，把所有流量接入到 v2，删除 dr 中的 v1，v1 pod 可以删除。<br>
</p>
</div>
</div>
<div id="outline-container-orgb7618eb" class="outline-5">
<h5 id="orgb7618eb">使用 kiali 图形化管理微服务流量</h5>
<div class="outline-text-5" id="text-orgb7618eb">
<p>
不推荐使用。<br>
</p>

<p>
使用之前需要把手动创建的 vs\dr 删除，不然无法在图形界面修改。<br>
</p>


<p>
Service 中选择 reviews，在 Actions 中选择 Traffic Shifting 可直接修改流量，默认是平均分配的流量。修改完成后会自动创建 VS 和 DR。<br>
</p>
</div>
</div>
</div>
<div id="outline-container-org8e88cff" class="outline-4">
<h4 id="org8e88cff">Istio 实现 AB 测试</h4>
<div class="outline-text-4" id="text-org8e88cff">
<p>
匹配不同类型的用户，如内部和外部用户<br>
</p>

<p>
确认 DR 中有 v3版本。<br>
启动 v3：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl scale deploy --replicas=1 reviews-v3 -n bookinfo
</pre>
</div>

<p>
再次修改 reviews 的 virtualService，将内部用户 jason 指向 v3，外部用户依旧使用 v2 版本。<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">vim reviews-jasonv3.yaml
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - match:
    - headers:         <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21305;&#37197;&#35831;&#27714;&#22836;</span>
        end-user:      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21305;&#37197;&#35831;&#27714;&#22836;&#30340; key &#20026; end-user</span>
          exact: jason <span style="color: #b22222;"># </span><span style="color: #b22222;">value &#20026; jason</span>
    route:
    - destination:
        host: reviews
        subset: v3     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21305;&#37197;&#21040; end-user=jason &#36335;&#30001;&#33267; v3 &#29256;&#26412;</span>
  - route:
    - destination:
        host: reviews
        subset: v2


kubectl replace -f reviews-jasonv3.yaml -n bookinfo
</pre>
</div>
<p>
浏览器中 Sign in 登录 jason 用户验证。<br>
</p>

<p>
官方 match 匹配文档：<a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPMatchRequest">https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPMatchRequest</a><br>
</p>
</div>
</div>
<div id="outline-container-org80195b6" class="outline-4">
<h4 id="org80195b6">Istio 地址重写和重写向</h4>
<div class="outline-text-4" id="text-org80195b6">
</div>
<div id="outline-container-org16943d4" class="outline-5">
<h5 id="org16943d4">新旧地址替换</h5>
<div class="outline-text-5" id="text-org16943d4">
<p>
比如将 bookinfo.kubeasy.com/gx，301重定向跳转到 baidu.com/gx<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl edit vs bookinfo -n bookinfo

  - match:
    - uri:
      prefix: /gx  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21305;&#37197; /gx</span>
    redirect:
      uri: /gx
      authority: baidu.com <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36339;&#36716;&#22495;&#21517;</span>
</pre>
</div>

<p>
参考：<a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPRedirect">https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPRedirect</a><br>
</p>
</div>
</div>
<div id="outline-container-org6c3b637" class="outline-5">
<h5 id="org6c3b637">前后端分离-rewrite 实践</h5>
<div class="outline-text-5" id="text-org6c3b637">
<p>
istio 地址重写配置方式和 重定向类似，假如将 / 重写为 /productpage，配置如下 ：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl edit vs bookinfo -n bookinfo

  - match:
    - uri:
        exact: / <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21305;&#37197;&#26681;&#36335;&#24452;</span>
    rewrite:
      uri: /productpage <span style="color: #b22222;"># </span><span style="color: #b22222;">&#37325;&#20889;&#20026; /productpage</span>
    route:
    - destination:
        host: productpage
        port:
          number: 9080
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org0f913c5" class="outline-4">
<h4 id="org0f913c5">Istio 负载均衡算法</h4>
<div class="outline-text-4" id="text-org0f913c5">
<p>
Istio 原生支持多种负载均衡算法，比如 ROUND_BOBIN、LEAST_CONN、RANDOM 等。<br>
假如一个应用存在多个副本（Pod），可以使用上述算法对多个 pod 进行定制化的负载均衡配置。<br>
</p>

<p>
每种负载均衡的策略如下 ：<br>
</p>
<ul class="org-ul">
<li>ROUND_BOBIN：默认，轮询算法，将请求依次分配给每一个实例。<br></li>
<li>LEAST_CONN：最小连接数，随机选择两个健康实例，将请求分配成两个中连接数最少的那个；<br></li>
<li>RANDOM：随机算法，将请求随机分配给其中一个实例；<br></li>
<li>PASSTHROUGH：将连接转发到调用者请求的原始 IP  地址，而不进行任何形式的负载平衡，目前不推荐使用。<br></li>
</ul>

<p>
首先访问多次 bookinfo 的首页，之后观看 kiali 中 reviews 的流量分配。<br>
</p>

<p>
更改算法<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl edit dr reviews -nbookinfo
...
spec:
  host: reviews
  trafficPolicy:     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#36335;&#30001;&#31574;&#30053;&#65292;&#22312; spec &#19979;&#23545;&#25152;&#26377;&#30340; subnet &#29983;&#25928;&#65292;&#20063;&#21487;&#20197;&#22312; subnet &#20013;&#37197;&#32622;</span>
    loadBalancer:    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#37197;&#32622;&#36127;&#36733;&#22343;&#34913;</span>
      simple: RANDOM <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31574;&#30053;&#20026; RANDOM</span>
</pre>
</div>

<p>
<a href="https://istio.io/latest/docs/reference/config/networking/destination-rule/#LoadBalancerSettings-SimpleLB">https://istio.io/latest/docs/reference/config/networking/destination-rule/#LoadBalancerSettings-SimpleLB</a><br>
</p>
</div>
</div>
<div id="outline-container-org6bdaac9" class="outline-4">
<h4 id="org6bdaac9">Istio 熔断-并发数连接限制</h4>
<div class="outline-text-4" id="text-org6bdaac9">
<p>
假设对 ratings 进行熔断，希望在并发请求数超过 3，并且存在 1 个以上的待处理请求，就触发熔断，此时可以配置 ratings 的 DestinationRule 如下：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">vim ratings-dr.yaml


apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: ratings
  namespace: bookinfo
spec:
  host: ratings
  trafficPolicy:    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#37197;&#32622;&#22312; subsets &#32423;&#21035;</span>
    connectionPool: <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36830;&#25509;&#27744;&#37197;&#32622;&#65292;&#21487;&#20197;&#21333;&#29420;&#20351;&#29992;&#38480;&#21046;&#31243;&#24207;&#30340;&#24182;&#21457;&#25968;</span>
      tcp:
        maxConnections: 3     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26368;&#22823;&#24182;&#21457;&#25968;&#20026; 3</span>
        connectTimeout: 30ms
      http:
        http1MaxPendingRequests: 1 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26368;&#22823;&#30340;&#24453;&#22788;&#29702;&#35831;&#27714;</span>
        maxRequestsPerConnection: 1 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#20010;&#35831;&#27714;&#26368;&#22823;&#30340;&#38142;&#25509;&#25968;</span>
    outlierDetection:         <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29076;&#26029;&#25506;&#27979;&#37197;&#32622;</span>
      consecutive5xxErrors: 1 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#36830;&#32493;&#20986;&#29616;&#30340;&#38169;&#35823;&#36229;&#36807; 1 &#27425;&#65292;&#23601;&#20250;&#29076;&#26029;</span>
      interval: 10s           <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532; 10 &#31186;&#25506;&#27979;&#19968;&#27425;&#21518;&#31471;&#23454;&#20363;</span>
      baseEjectionTime: 3m    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29076;&#26029;&#26102;&#38388;</span>
      maxEjectionPercent: 100 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#34987;&#29076;&#26029;&#23454;&#20363;&#26368;&#22823;&#30334;&#20998;&#27604;&#65292;&#40664;&#35748; 10%</span>
  subsets:
  - name: v1
    labels:
      version: v1 <span style="color: #b22222;"># </span><span style="color: #b22222;">subnet v1 &#25351;&#21521;&#20855;&#26377; version=v1 &#30340; pod</span>
</pre>
</div>

<p>
保存退出后，部署压测工具 fortio，用于对容器业务进行压力测试：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl -n bookinfo apply -f samples/httpbin/sample-client/fortio-deploy.yaml
</pre>
</div>

<p>
等待 fortio 容器启动后，获取 fortrio 容器 id:<br>
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #a0522d;">FORTIO_POD</span>=$(<span style="color: #ff00ff;">kubectl get pod -n bookinfo | grep fortio | awk '{print $1}'</span>)
<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">FORTIO_POD</span>
</pre>
</div>

<p>
发送一个请求，可以看到当前状态码为 200，即连接成功：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl exec -it $<span style="color: #a0522d;">FORTIO_POD</span> -n bookinfo -- fortio load -curl http://ratings:9080/ratings/0
</pre>
</div>

<p>
接下来更改为两个并发连接`-c 2`，发送 20 请求 `-n 20`:<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl exec -it $<span style="color: #a0522d;">FORTIO_POD</span> -n bookinfo -- fortio load -c 2 -gps 0 -n 20-curl http://ratings:9080/ratings/0 | grep Code
</pre>
</div>

<p>
可以看到 503 的结果为 5，说明触发了熔断。提高并发量，可以看到故障率更高。<br>
最后查看 fortio 请求记录（upstream_rq_pending_overflow 表示熔断次数）：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl -n bookinfo exec -it  $<span style="color: #a0522d;">FORTIO_POD</span> -c istio-proxy -- sh -c <span style="color: #8b2252;">'curl localhost:15000/stats'</span> | grep ratings |grep pending_overflow
</pre>
</div>
</div>
</div>
<div id="outline-container-org874143e" class="outline-4">
<h4 id="org874143e">Istio 故障处理</h4>
<div class="outline-text-4" id="text-org874143e">
</div>
<div id="outline-container-org69adcff" class="outline-5">
<h5 id="org69adcff">Istio 注入延迟故障</h5>
<div class="outline-text-5" id="text-org69adcff">
<p>
首先不添加任何延迟，看一下访问速度如何：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#  </span><span style="color: #b22222;">&#21019;&#24314;&#19968;&#20010;&#29992;&#20110;&#27979;&#35797;&#30340;&#24037;&#20855;</span>
kubectl run -it -n bookinfo debug-tools --image=registry.cn-beijing.aliyuncs.com/dotbalo/debug-tools
) <span style="color: #a020f0;">time</span> curl -I -s details:9080
</pre>
</div>

<p>
注入故障<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">vim details-delay.yaml
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: details
  namespace: bookinfo
spec:
  hosts:
  - details
  http:
  - fault:             <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#19968;&#20010;&#38169;&#35823;</span>
      delay:           <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#31867;&#22411;&#20026; delay &#30340;&#25925;&#38556;</span>
        fixedDelay: 5s <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#20837;&#30340;&#24310;&#36831;&#26102;&#38388;</span>
        percentage:    <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#25925;&#38556;&#27880;&#20837;&#30340;&#30334;&#20998;&#27604;</span>
          value: 100   <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#23545;&#25152;&#26377;&#35831;&#27714;&#27880;&#20837;&#25925;&#38556;</span>
    route:
    - destination:
        host: details
        subset: v1

kubectl create -f details-delay.yaml -n bookinfo
</pre>
</div>

<p>
再次进行测试，返回时间已经达到了 5 秒：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">) <span style="color: #a020f0;">time</span> curl -I -s details:9080
</pre>
</div>
</div>
</div>
<div id="outline-container-org209c1c8" class="outline-5">
<h5 id="org209c1c8">Istio 注入中断故障</h5>
<div class="outline-text-5" id="text-org209c1c8">
<p>
中断故障注入只需要将 fault 的 delay 更改为 abort 即可：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">vim details-abort.yaml
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: details
  namespace: bookinfo
spec:
  hosts:
  - details
  http:
  - fault:             <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#19968;&#20010;&#38169;&#35823;</span>
      abort:           <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#31867;&#22411;&#20026; abort &#30340;&#25925;&#38556;</span>
        httpStatus: 400 <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#25925;&#38556;&#29366;&#24577;&#30721;</span>
        percentage:    <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#25925;&#38556;&#27880;&#20837;&#30340;&#30334;&#20998;&#27604;</span>
          value: 100   <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#23545;&#25152;&#26377;&#35831;&#27714;&#27880;&#20837;&#25925;&#38556;</span>
    route:
    - destination:
        host: details
        subset: v1

kubectl replace -f details-delay.yaml -n bookinfo
</pre>
</div>

<p>
再次进行测试，返回 400 错误：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">) <span style="color: #a020f0;">time</span> curl -I -s details:9080
</pre>
</div>
</div>
</div>
<div id="outline-container-orga206426" class="outline-5">
<h5 id="orga206426">Istio 快速超时配置</h5>
<div class="outline-text-5" id="text-orga206426">
<p>
不想因为一个评分系统导致整个访问慢<br>
</p>

<p>
首先向 ratings 服务注入一个 5 秒的延迟模拟 ratings 服务响应比较慢：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">vim ratings-delay.yaml
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings-delay
  namespace: bookinfo
spec:
  hosts:
  - ratings
  http:
  - fault:             <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#19968;&#20010;&#38169;&#35823;</span>
      delay:           <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#31867;&#22411;&#20026; delay &#30340;&#25925;&#38556;</span>
        fixedDelay: 5s <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#20837;&#30340;&#24310;&#36831;&#26102;&#38388;</span>
        percentage:    <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#25925;&#38556;&#27880;&#20837;&#30340;&#30334;&#20998;&#27604;</span>
          value: 100   <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#23545;&#25152;&#26377;&#35831;&#27714;&#27880;&#20837;&#25925;&#38556;</span>
    route:
    - destination:
        host: ratings

kubectl create -f ratings-delay.yaml
</pre>
</div>

<p>
访问测试：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell">) <span style="color: #a020f0;">time</span> curl -I -s ratings:9080
</pre>
</div>

<p>
此时在浏览器访问，可以看到整个页面都变得缓慢。接下来向 reviews 服务配置一个 1 秒超时，因为是 reviews 服务调用的 ratings 服务：<br>
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#32534;&#36753;&#24403;&#21069; reviews &#30340; VS</span>
kubectl edit vs reviews -n bookinfo
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - match:
    - headers:         <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21305;&#37197;&#35831;&#27714;&#22836;</span>
        end-user:      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21305;&#37197;&#35831;&#27714;&#22836;&#30340; key &#20026; end-user</span>
          exact: jason <span style="color: #b22222;"># </span><span style="color: #b22222;">value &#20026; jason</span>
    route:
    - destination:
        host: reviews
        subset: v3     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21305;&#37197;&#21040; end-user=jason &#36335;&#30001;&#33267; v3 &#29256;&#26412;</span>
    timeout: 1s <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#36229;&#26102;&#65292;&#26102;&#38388;&#20026; 1 &#31186;</span>
  - route:
    - destination:
        host: reviews
        subset: v2
</pre>
</div>

<p>
重新编辑后，再次使用浏览器测试，未登录用户大概会有 5 秒以上的延迟，而登录用户为 jason 的，可以很快就能打开页面。<br>
</p>
</div>
</div>
</div>
</div>
</section>
</main class="container">
<footer id="postamble" class="status">
<footer data-astro-cid-sz7xmlte data-turbo-permanent id=rootFooter>
    <script>
        const shuffle = e => e.map((e => ({
            v: e,
            sort: Math.random()
        }))).sort(( (e, o) => e.sort - o.sort)).map(( ({v: e}) => e));
        var songList = ["barbie-girl--stantough", "blue-da-ba-dee--cornelius-link", "hips-dont-lie--stantough", "i-want-it-that-way--stantough", "seven-nation-army--stantough", "smooth-criminal--stantough"]
          , songOrder = songOrder ?? shuffle(songList).map((e => `/audio/music/${e}.opus`))
          , song = new Audio(songOrder[0])
          , nextSong = new Audio(songOrder[1])
          , songIndex = 2
          , musicWrapper = void 0
          , arrow = void 0
          , notes = void 0;
        song.addEventListener("ended", next);
        const toggle = () => song.paused ? play() : pause();
        function play() {
            song.play(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.add("shakeManHorse"),
            notes.classList.remove("hideNotes")
        }
        function pause() {
            song.pause(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.remove("shakeManHorse"),
            notes.classList.add("hideNotes")
        }
        function next() {
            song = nextSong,
            play(),
            songIndex === songOrder.length && (songIndex = 0),
            nextSong = new Audio(songOrder[songIndex]),
            songIndex += 1
        }
        function skip() {
            pause(),
            (arrow = arrow || document.getElementById("musicArrow")).classList.add("shootArrow");
            new Audio("/audio/effects/ohno.m4a").play(),
            arrow.addEventListener("animationend", arrowShootHandler, !1)
        }
        function arrowShootHandler() {
            arrow.removeEventListener("animationend", arrowShootHandler, !1),
            arrow.classList.remove("shootArrow");
            new Audio("/audio/effects/heythathurt.m4a").play(),
            next()
        }
    </script>
    <div id=musicPlayer data-astro-cid-q7a5pyro>
        <button class=skip data-astro-cid-q7a5pyro onclick=skip() title="Skip song">
            <div id=skipWrapper data-astro-cid-q7a5pyro>
                <img alt="Medieval drollery of a man/snail/bat/monkey shooting an arrow" class=archer decoding=async height=334 loading=lazy src=/images/archer-no-arrow.448ccd8b_Z1KfRYq.webp width=226 data-astro-cid-q7a5pyro>
                <img alt="Arrow for archer" class="arrow complete" decoding=async height=23 loading=lazy src=/images/no-archer-full-arrow.87aa9971_Z2qL2KO.webp width=141 data-astro-cid-q7a5pyro id=musicArrow>
            </div>
        </button>
        <button class=playPause data-astro-cid-q7a5pyro onclick=toggle() title="Play/pause song">
            <div id=musicWrapper data-astro-cid-q7a5pyro>
                <div class=hideNotes id=notesWrapper data-astro-cid-q7a5pyro>
                    <div class=lyreNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                    <div class=fluteNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                </div>
                <img alt="Medieval drollery of a man/horse playing a lyre and a horn" class=manHorse decoding=async height=665 loading=lazy src=/images/man-horse-band.e3a2efcf_q8FCa.webp width=531 data-astro-cid-q7a5pyro>
            </div>
        </button>
    </div>
    <hr data-astro-cid-sz7xmlte>
    <div class=salutation data-astro-cid-gdmrbrho>
        <p data-astro-cid-gdmrbrho>
            <span class=flower2 data-astro-cid-gdmrbrho>A</span>
            <span class=smallcap data-astro-cid-gdmrbrho>pax vobiscum</span>
            <span class="flower2 wiggle" data-astro-cid-gdmrbrho id=leaf>a</span>
        </p>
    </div>
    <script>
        function animateLeafBlownHandler() {
            leaf.removeEventListener("animationend", animateLeafBlownHandler, !1),
            leaf.classList.remove("blownAway"),
            leaf.classList.add("wiggle")
        }
        function animateLeaf() {
            leaf = leaf ?? document.getElementById("leaf"),
            leaf.classList.remove("wiggle"),
            leaf.classList.add("blownAway"),
            leaf.addEventListener("animationend", animateLeafBlownHandler, !1)
        }
        document.getElementById("leaf").onclick = animateLeaf
    </script>


    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2024 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
</footer>
</footer>
</body>
</html>
