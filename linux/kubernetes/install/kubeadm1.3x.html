<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kubernetes: k8s-安装篇-kueadm-1.3x</title>
<meta name="description" content="kubernetes, linux" />
<meta name="keywords" content="kubernetes, linux" />
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Kubernetes: k8s-安装篇-kueadm-1.3x</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:547b4f5c-fd62-4a1f-93f2-c0bdc13fc269">安装前必读</a>
<ul>
<li><a href="#h:bade6137-ef1d-412d-b3aa-b3ca2b7e5fc9">网段划分</a></li>
</ul>
</li>
<li><a href="#h:d2964f65-72be-4c3b-b564-125cf6e22dca">安装及优化部分</a>
<ul>
<li><a href="#h:e1965fe3-a78b-432a-a0c3-207c439d8f85">高可用Kubernetes集群规划</a></li>
<li><a href="#h:6dbc4586-2e2e-43c6-b676-75c316a1b351">基本环境配置</a></li>
<li><a href="#h:c76c5e5a-b226-4262-a02a-1c57589a8a5b">内核升级</a></li>
<li><a href="#h:e6df0c63-f665-4b6a-a49c-61b4073f5dc9">k8s 组件和 runtime 安装</a>
<ul>
<li><a href="#h:d71f041f-250b-4459-9f08-132c40505a98">Containerd 作为 Runtime</a></li>
<li><a href="#h:6fb0bd42-6b14-4a3a-9e57-c6570a0c6a6e">Docker 作为 Runtime （版本小于 1.24）</a></li>
<li><a href="#h:31474281-9c84-4e14-99a6-c1f2bd741f6a">安装k8s组件</a></li>
</ul>
</li>
<li><a href="#h:30640a70-34c2-4e49-bc60-7ab000e509b7">高可用组件安装</a></li>
</ul>
</li>
<li><a href="#h:ec12062f-68eb-4b04-8833-2edd72d936b5">集群建立部分</a>
<ul>
<li><a href="#h:05ce7887-a24c-47db-a03b-6944fe20dfa5">集群初始化</a>
<ul>
<li><a href="#h:4e2afd45-6d9c-49e1-ab7f-170ffc410611">kubeadm 命令使用</a></li>
<li><a href="#h:8459c629-b142-43a1-9db8-fb123646c0c7">kubeadm init 命令简介</a></li>
<li><a href="#h:10a34219-ecbf-4307-9819-3197cd660ea6">高可用 master 初始化</a></li>
</ul>
</li>
<li><a href="#h:3e5773ea-b8d7-45a0-8596-2cd2f595158b">高可用Master</a>
<ul>
<li><a href="#h:7711fe4b-3916-43e2-aaf3-0018d9a71bf5">token 过期处理</a></li>
</ul>
</li>
<li><a href="#h:7e6ce312-429c-4991-820e-37ed40f5b234">添加Node节点</a>
<ul>
<li><a href="#h:fad58a69-70dd-43bc-9654-741226b45332">k8s 安装失败故障排查</a></li>
<li><a href="#h:d63e7df5-cb97-4e4c-b68e-0f74d0adea30">给node节点打标签（可选）</a></li>
</ul>
</li>
<li><a href="#h:defb103a-7c80-46e6-b274-872135fe041d">安装网络插件</a>
<ul>
<li><a href="#h:dbe105b9-d0a2-4c28-8b1b-3b47c0edb386">Flannel</a></li>
<li><a href="#h:c5be9576-68b4-497f-8522-b8200fcfca1b">Calico安装</a></li>
<li><a href="#h:5391ef18-5eb2-4a24-81d7-4f5eeed16b90">weave</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:d3df78dc-ede4-4033-8410-8b755a08e493">Addons 安装</a>
<ul>
<li><a href="#h:6a7f1118-dfdd-4ae7-9784-0c28c67ed707">Metrics Server部署</a></li>
<li><a href="#h:dee36232-69a1-4b9d-b257-3ed126c67045">Dashboard部署</a>
<ul>
<li><a href="#h:21e82620-2357-4d59-9b45-b29fd0cc3d22">开启自动生成Token（1.24版本上必做）</a></li>
<li><a href="#h:05cb790c-92df-424a-a3bb-aec07f3668ad">安装指定版本 dashboard</a></li>
<li><a href="#h:74e9f102-f096-4362-870b-aebfb272c81b">安装最新版</a></li>
<li><a href="#h:f2f505b0-689f-4bc7-8ac8-47ff0671f247">登录dashboard</a></li>
<li><a href="#h:4b3aa559-88a7-41e0-84ca-6e978c07e578">dashboard的另一种选择</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:7239c867-fe95-49e4-ad97-78862adb1563">收尾工作</a>
<ul>
<li><a href="#h:fcda1230-1f4a-46bc-83ed-2da4cf0d1b39">一些必须的配置更改</a></li>
<li><a href="#h:739033d5-1c6a-4b43-b750-378cb34ae156">注意事项</a></li>
<li><a href="#h:a4b8287b-e1f0-4a76-8651-121b261a6273">集群检测</a></li>
<li><a href="#h:e95f990c-63ec-4d6e-95b7-4025a17487ca">删除集群</a></li>
<li><a href="#h:a6a25d02-e454-4664-a352-2d4452b0af06">kubeadm 证书更新</a>
<ul>
<li><a href="#h:54aaad72-6794-4141-afda-04d8f36e4f88">更新一年</a></li>
<li><a href="#h:4d59fc88-cb69-4cb8-b2cc-a523b99051e2">更新为 99 年</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:427eaf49-db05-4a2f-a3e7-690ac9e11f0b">参考</a></li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../index.html">Kubernetes</a></li>
</ul>
<section id="outline-container-h:547b4f5c-fd62-4a1f-93f2-c0bdc13fc269" class="outline-2">
<h2 id="h:547b4f5c-fd62-4a1f-93f2-c0bdc13fc269">安装前必读</h2>
<div class="outline-text-2" id="text-h:547b4f5c-fd62-4a1f-93f2-c0bdc13fc269">
<ul class="org-ul">
<li>请不要使用带中文的服务器和克隆的虚拟机</li>
<li>生产环境建议使用二进制安装方式。</li>
<li>请将该文档复制一份，然后进行更改安装。</li>
<li>文档中的IP地址请统一替换，不要一个一个替换</li>
</ul>
</div>
<div id="outline-container-h:bade6137-ef1d-412d-b3aa-b3ca2b7e5fc9" class="outline-3">
<h3 id="h:bade6137-ef1d-412d-b3aa-b3ca2b7e5fc9">网段划分</h3>
<div class="outline-text-3" id="text-h:bade6137-ef1d-412d-b3aa-b3ca2b7e5fc9">
<p>
集群安装时会涉及到三个网段：
</p>
<ul class="org-ul">
<li>宿主机网段：就是安装k8s的服务器</li>
<li>Pod网段：k8s Pod的网段，相当于容器的IP</li>
<li>Service网段：k8s service网段，service用于集群容器通信。</li>
</ul>


<ul class="org-ul">
<li>一般service网段会设置为10.96.0.0/12</li>
<li>Pod网段会设置成10.244.0.0/12或者172.16.0.1/12</li>
<li>宿主机网段可能是192.168.0.0/24</li>
</ul>


<ul class="org-ul">
<li>需要注意的是这三个网段不能有任何交叉。</li>
<li>比如如果宿主机的IP是10.105.0.x</li>
<li>那么service网段就不能是10.96.0.0/12，因为10.96.0.0/12网段可用IP是：</li>
<li>10.96.0.1 ~ 10.111.255.255</li>
<li>所以10.105是在这个范围之内的，属于网络交叉，此时service网段需要更换，</li>
<li>可以更改为192.168.0.0/16网段（注意如果service网段是192.168开头的子网掩码最好不要是12，最好为16，因为子网掩码是12他的起始IP为192.160.0.1 不是192.168.0.1）。</li>
<li>同样的道理，技术别的网段也不能重复。可以通过<a href="http://tools.jb51.net/aideddesign/ip_net_calc/%E8%AE%A1%E7%AE%97">http://tools.jb51.net/aideddesign/ip_net_calc/%E8%AE%A1%E7%AE%97</a>。</li>
</ul>

<p>
所以一般的推荐是，直接第一个开头的就不要重复，比如你的宿主机是192开头的，那么你的service可以是10.96.0.0/12.
</p>

<p>
如果你的宿主机是10开头的，就直接把service的网段改成192.168.0.0/16
</p>

<p>
如果你的宿主机是172开头的，就直接把pod网段改成192.168.0.0/12
</p>


<p>
注意搭配，均为10网段、172网段、192网段的搭配，第一个开头数字不一样就免去了网段冲突的可能性，也可以减去计算的步骤。
</p>


<p>
安装及优化部分
</p>
<ul class="org-ul">
<li>基本环境配置及优化</li>
<li>安装 Runtime</li>
<li>Kubeadm &amp; kubelet</li>
<li>高可用实现</li>
</ul>

<p>
集群建立部分
</p>

<ul class="org-ul">
<li>Master 节点初始化</li>
<li>Node 节点配置</li>
<li>CNI 插件安装</li>
</ul>

<p>
Addons 安装
</p>

<ul class="org-ul">
<li>Metrics Server</li>
<li>Dashboard</li>
<li>&#x2026;</li>
</ul>

<p>
收尾工作
</p>

<ul class="org-ul">
<li>集群可用性验证</li>
<li>生产必备配置</li>
</ul>
</div>
</div>
</section>
<section id="outline-container-h:d2964f65-72be-4c3b-b564-125cf6e22dca" class="outline-2">
<h2 id="h:d2964f65-72be-4c3b-b564-125cf6e22dca">安装及优化部分</h2>
<div class="outline-text-2" id="text-h:d2964f65-72be-4c3b-b564-125cf6e22dca">
<p>
集群网段划分
</p>

<ul class="org-ul">
<li>主机节点网段 192.168.1.0/24</li>
<li>Service 网段 10.96.0.0/16</li>
<li>Pod 网段 10.244.0.0/16</li>
</ul>

<p>
集群资源配置
</p>

<ul class="org-ul">
<li>Master 节点 2C2G * 3</li>
<li>Node 节点 2C2G * 2</li>
</ul>
</div>
<div id="outline-container-h:e1965fe3-a78b-432a-a0c3-207c439d8f85" class="outline-3">
<h3 id="h:e1965fe3-a78b-432a-a0c3-207c439d8f85">高可用Kubernetes集群规划</h3>
<div class="outline-text-3" id="text-h:e1965fe3-a78b-432a-a0c3-207c439d8f85">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">主机名</th>
<th scope="col" class="org-right">IP地址</th>
<th scope="col" class="org-left">角色</th>
<th scope="col" class="org-left">配置</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">k8s-master01</td>
<td class="org-right">192.168.0.107</td>
<td class="org-left">Master</td>
<td class="org-left">2C2G 40G</td>
</tr>

<tr>
<td class="org-left">k8s-master02</td>
<td class="org-right">192.168.0.108</td>
<td class="org-left">Master</td>
<td class="org-left">2C2G 40G</td>
</tr>

<tr>
<td class="org-left">k8s-master03</td>
<td class="org-right">192.168.0.109</td>
<td class="org-left">Master</td>
<td class="org-left">2C2G 40G</td>
</tr>

<tr>
<td class="org-left">k8s-master-lb</td>
<td class="org-right">192.168.0.236</td>
<td class="org-left">keepalived虚拟 IP</td>
<td class="org-left">2C2G 40G</td>
</tr>

<tr>
<td class="org-left">k8s-node01</td>
<td class="org-right">192.168.0.110</td>
<td class="org-left">Node-1</td>
<td class="org-left">2C2G 40G</td>
</tr>

<tr>
<td class="org-left">k8s-node02</td>
<td class="org-right">192.168.0.111</td>
<td class="org-left">Node-2</td>
<td class="org-left">2C2G 40G</td>
</tr>
</tbody>
</table>


<p>
请统一替换这些网段，Pod网段和service和宿主机网段不要重复！！！
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">信息</th>
<th scope="col" class="org-left">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">系统版本</td>
<td class="org-left">CentOS 7.9</td>
</tr>

<tr>
<td class="org-left">Docker版本</td>
<td class="org-left">20.10.x</td>
</tr>

<tr>
<td class="org-left">K8s版本</td>
<td class="org-left">1.20.x</td>
</tr>

<tr>
<td class="org-left">Pod网段</td>
<td class="org-left">172.168.0.0/12</td>
</tr>

<tr>
<td class="org-left">Service网段</td>
<td class="org-left">10.96.0.0/12</td>
</tr>
</tbody>
</table>

<p>
说明：
</p>
<ul class="org-ul">
<li>宿主机网段、K8s Service网段、Pod网段不能重复.</li>
<li>不要使用中文的环境，还有不要克隆的虚拟机。生产环境，使用二进制安装。</li>
<li>VIP（虚拟IP）不要和公司内网IP重复，首先去ping一下，不通才可用。VIP需要和主机在同一个局域网内！</li>
</ul>
</div>
</div>
<div id="outline-container-h:6dbc4586-2e2e-43c6-b676-75c316a1b351" class="outline-3">
<h3 id="h:6dbc4586-2e2e-43c6-b676-75c316a1b351">基本环境配置</h3>
<div class="outline-text-3" id="text-h:6dbc4586-2e2e-43c6-b676-75c316a1b351">
<p>
Kubeadm 安装方式自1.14版本以后，安装方法几乎没有任何变化，此文档可以尝试安装最新的k8s集群，centos采用的是7.x版本。
</p>

<p>
k8s官网：<a href="https://kubernetes.io/docs/setup/">https://kubernetes.io/docs/setup/</a>
</p>

<p>
最新版本高可用安装：<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/</a>
</p>


<p>
所有节点配置hosts,修改 /etc/hosts 如下：
</p>

<p>
主要为了发包方便，不配置也是可以的。
</p>

<div class="org-src-container">
<pre class="src src-shell">[root@k8s-master01 ~]# cat /etc/hosts  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#22914;&#19979;</span>
192.168.0.107 k8s-master01
192.168.0.108 k8s-master02
192.168.0.109 k8s-master03
192.168.0.236 k8s-master-lb <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#19981;&#26159;&#39640;&#21487;&#29992;&#38598;&#32676;&#65292;&#35813;IP&#20026;Master01&#30340;IP</span>
192.168.0.110 k8s-node01
192.168.0.111 k8s-node02
</pre>
</div>

<p>
yum源配置
</p>

<div class="org-src-container">
<pre class="src src-shell">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
<span style="color: #ffa54f;">[kubernetes]</span>
<span style="color: #ffa54f;">name=Kubernetes</span>
<span style="color: #ffa54f;">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span>
<span style="color: #ffa54f;">enabled=1</span>
<span style="color: #ffa54f;">gpgcheck=1</span>
<span style="color: #ffa54f;">repo_gpgcheck=1</span>
<span style="color: #ffa54f;">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span>
<span style="color: #ffa54f;">EOF</span>
sed -i -e <span style="color: #8b2252;">'/mirrors.cloud.aliyuncs.com/d'</span> -e <span style="color: #8b2252;">'/mirrors.aliyuncs.com/d'</span> /etc/yum.repos.d/CentOS-Base.repo
</pre>
</div>

<p>
必备工具安装
</p>

<div class="org-src-container">
<pre class="src src-shell">yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git -y
</pre>
</div>

<p>
所有节点关闭防火墙、selinux、dnsmasq、swap。服务器配置如下：
</p>

<div class="org-src-container">
<pre class="src src-shell">systemctl disable --now firewalld 
systemctl disable --now dnsmasq
systemctl disable --now NetworkManager <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20844;&#26377;&#20113;&#19981;&#35201;&#20851;&#38381;</span>

setenforce 0
sed -i <span style="color: #8b2252;">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/sysconfig/selinux
sed -i <span style="color: #8b2252;">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config
</pre>
</div>

<p>
关闭swap分区
</p>

<div class="org-src-container">
<pre class="src src-shell">swapoff -a &amp;&amp; sysctl -w vm.swappiness=0
sed -ri <span style="color: #8b2252;">'/^[^#]*swap/s@^@#@'</span> /etc/fstab
</pre>
</div>

<p>
安装ntpdate
</p>

<div class="org-src-container">
<pre class="src src-shell">rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm
yum install ntpdate -y
</pre>
</div>

<p>
或者使用chrony
</p>
<div class="org-src-container">
<pre class="src src-shell">yum install -y chrony
sed -ri&#160;<span style="color: #8b2252;">'s/^pool.*/#&amp;/'</span>&#160;/etc/chrony.conf
cat &gt;&gt; /etc/chrony.conf &lt;&lt; EOF
<span style="color: #ffa54f;">pool ntp1.aliyun.com iburst</span>
<span style="color: #ffa54f;">EOF</span>
systemctl restart chronyd
chronyc sources
</pre>
</div>

<p>
所有节点同步时间。时间同步配置如下：
</p>

<div class="org-src-container">
<pre class="src src-shell">ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'Asia/Shanghai'</span> &gt;/etc/timezone
ntpdate time2.aliyun.com
</pre>
</div>

<p>
加入到crontab
</p>

<div class="org-src-container">
<pre class="src src-shell">*/5 * * * * ntpdate time2.aliyun.com
</pre>
</div>

<p>
所有节点配置limit：
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">ulimit</span> -SHn 65535

vim /etc/security/limits.conf
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26411;&#23614;&#28155;&#21152;&#22914;&#19979;&#20869;&#23481;</span>
- oft nofile 655360
- hard nofile 131072
- soft nproc 655350
- hard nproc 655350
- soft memlock unlimited
- hard memlock unlimited
</pre>
</div>



<p>
Master01节点免密钥登录其他节点：
</p>

<p>
主要是方便传包，可做可不做
</p>

<div class="org-src-container">
<pre class="src src-shell">ssh-keygen -t rsa
<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02;<span style="color: #a020f0;">do</span> ssh-copy-id -i .ssh/id_rsa.pub $<span style="color: #a0522d;">i</span>;<span style="color: #a020f0;">done</span>
</pre>
</div>

<p>
下载安装所有的源码文件：
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">cd</span> /root/ ; git clone https://github.com/dotbalo/k8s-ha-install.git
</pre>
</div>

<p>
所有节点升级系统并重启：
</p>

<div class="org-src-container">
<pre class="src src-shell">yum update -y --exclude=kernel*  &amp;&amp; reboot

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#23433;&#35013;&#30340;&#29256;&#26412;</span>
[root@k8s-master01 ~]# cat /etc/redhat-release
CentOS Linux release 7.9.2009 (Core)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c76c5e5a-b226-4262-a02a-1c57589a8a5b" class="outline-3">
<h3 id="h:c76c5e5a-b226-4262-a02a-1c57589a8a5b">内核升级</h3>
<div class="outline-text-3" id="text-h:c76c5e5a-b226-4262-a02a-1c57589a8a5b">
<p>
centos7 需要升级内核至4.18+， 本地神经的版本为4.19
</p>

<p>
在Master01节点下载内核
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">cd</span> /root
wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm
wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm
</pre>
</div>

<p>
在master01拷贝到其他节点
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02; <span style="color: #a020f0;">do</span> scp kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm $<span style="color: #a0522d;">i</span>:/root/ ; <span style="color: #a020f0;">done</span>
</pre>
</div>

<p>
所有节点安装内核
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">cd</span> /root/ &amp;&amp; yum localinstall -y kernel-ml*
</pre>
</div>

<p>
所有节点更改内核启动顺序
</p>

<div class="org-src-container">
<pre class="src src-shell">grub2-set-default 0 &amp;&amp; grub2-mkconfig -o /etc/grub2.cfg

grubby --args=<span style="color: #8b2252;">"user_namespace.enable=1"</span> --update-kernel=<span style="color: #8b2252;">"$(</span><span style="color: #ff00ff;">grubby --default-kernel</span><span style="color: #8b2252;">)"</span>
</pre>
</div>

<p>
检查默认内核是不是4.19
</p>

<div class="org-src-container">
<pre class="src src-shell">[root@k8s-master01 ~]# grubby --default-kernel
/boot/vmlinuz-4.19.12-1.el7.elrepo.x86_64
</pre>
</div>

<p>
所有节点重启，然后检查内核是不是4.19
</p>

<div class="org-src-container">
<pre class="src src-shell">[root@k8s-master01 ~]# uname -a
</pre>
</div>

<p>
<b>其实参考</b>
</p>

<p>
本地包安装
</p>

<p>
安装包rpm : <a href="https://www.kernel.org/">https://www.kernel.org/</a> 和<a href="https://elrepo.org/linux/kernel/el7/x86_64/">https://elrepo.org/linux/kernel/el7/x86_64/</a>
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">kernel-ml-5.13.8-1.el7.elrepo.x86_64.rpm</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">kernel-ml-devel-5.13.8-1.el7.elrepo.x86_64.rpm</span>

yum localinstall -y kernel-ml*
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26356;&#25913;&#20869;&#26680;&#39034;&#24207;&#65306;</span>
grub2-set-default  0 &amp;&amp; grub2-mkconfig -o /etc/grub2.cfg 
grubby --args=<span style="color: #8b2252;">"user_namespace.enable=1"</span> --update-kernel=<span style="color: #8b2252;">"$(</span><span style="color: #ff00ff;">grubby --default-kernel</span><span style="color: #8b2252;">)"</span> &amp;&amp; reboot

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#26426;&#21518;&#26597;&#30475;&#20869;&#26680;&#26159;&#19981;&#26159;&#26368;&#26032;&#30340;</span>
grubby --default-kernel
</pre>
</div>

<p>
yum安装
</p>

<p>
利用elrepo源在CentOS 7 安装新版内核
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#21457;&#34892;&#29256;&#21644;&#20869;&#26680;</span>
cat /etc/redhat-release
uname -r
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992; ELRepo &#20179;&#24211;</span>
yum install https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#21487;&#29992;&#20869;&#26680;&#21253;</span>
yum --disablerepo=<span style="color: #8b2252;">"*"</span> --enablerepo=<span style="color: #8b2252;">"elrepo-kernel"</span> repolist
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#26368;&#26032;&#20869;&#26680;</span>
yum --enablerepo=elrepo-kernel install -y kernel-ml kernel-ml-devel
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24050;&#23433;&#35013;&#30340;&#20869;&#26680;</span>
[root@k8s-master01 ~]# awk -F<span style="color: #8b2252;">\'</span> <span style="color: #8b2252;">'$1=="menuentry " {print i++ " : " $2}'</span> /etc/grub2.cfg
0 : CentOS Linux (5.1.14-1.el7.elrepo.x86_64) 7 (Core)
1 : CentOS Linux (3.10.0-957.el7.x86_64) 7 (Core)
2 : CentOS Linux (0-rescue-8d615a05e5de49a08ca0e56b285958f7) 7 (Core)
<span style="color: #b22222;">##</span><span style="color: #b22222;">&#35774;&#32622;&#21551;&#21160;&#20869;&#26680;&#65292;&#21363;&#23601;&#26159;&#32534;&#21495;&#20026;0&#30340;&#37027;&#20010;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">grub2-set-default 0</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">sed -i 's/saved/0/g'  /etc/default/grub</span>
<span style="color: #b22222;">##</span><span style="color: #b22222;">&#20851;&#38381;NUMA</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">sed -i 's/quiet/quiet numa=off/g' /etc/default/grub</span>
<span style="color: #b22222;">##</span><span style="color: #b22222;">&#37325;&#26032;&#29983;&#25104;grub2&#37197;&#32622;&#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">grub2-mkconfig -o /boot/grub2/grub.cfg</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26356;&#25913;&#20869;&#26680;&#39034;&#24207;&#65306;</span>
grub2-set-default  0 &amp;&amp; grub2-mkconfig -o /etc/grub2.cfg 
grubby --args=<span style="color: #8b2252;">"user_namespace.enable=1"</span> --update-kernel=<span style="color: #8b2252;">"$(</span><span style="color: #ff00ff;">grubby --default-kernel</span><span style="color: #8b2252;">)"</span> &amp;&amp; reboot

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#26426;&#21518;&#26597;&#30475;&#20869;&#26680;</span>
grubby --default-kernel
</pre>
</div>

<p>
<b>所有节点安装ipvsadm</b>
</p>

<p>
默认情况下，Kube-proxy将在kubeadm部署的集群中以iptables模式运行
</p>

<div class="org-src-container">
<pre class="src src-shell">yum install ipvsadm ipset sysstat conntrack libseccomp -y
</pre>
</div>

<p>
所有节点配置ipvs模块, 在内核4.19+版本 nf_conntrack_ipv4 已经修改为 nf_conntrack， 4.18 以下使用 nf_conntrack_ipv4 即可
</p>

<div class="org-src-container">
<pre class="src src-shell">modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack

vim /etc/modules-load.d/ipvs.conf 
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21152;&#20837;&#20197;&#19979;&#20869;&#23481;</span>
ip_vs
ip_vs_lc
ip_vs_wlc
ip_vs_rr
ip_vs_wrr
ip_vs_lblc
ip_vs_lblcr
ip_vs_dh
ip_vs_sh
ip_vs_fo
ip_vs_nq
ip_vs_sed
ip_vs_ftp
ip_vs_sh
nf_conntrack
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip
</pre>
</div>

<p>
然后执行 
</p>

<div class="org-src-container">
<pre class="src src-shell">systemctl enable --now systemd-modules-load.service <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24320;&#26426;&#33258;&#21551;&#21160;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#26159;&#21542;&#21152;&#36733;</span>
lsmod | grep -e ip_vs -e nf_conntrack
</pre>
</div>



<p>
<b>开启一些k8s集群中必须的内核参数</b> ，所有节点配置k8s内核
</p>

<p>
目前对ipv6支持不怎么好，所以里面也关闭ipv6了
</p>

<p>
k8s一定要开启 <code>net.ipv4.ip_forward = 1</code> 路由转发
</p>

<div class="org-src-container">
<pre class="src src-shell">cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s-sysctl.conf
<span style="color: #ffa54f;">#---add k8s---</span>
<span style="color: #ffa54f;">net.ipv4.ip_forward = 1</span>
<span style="color: #ffa54f;">net.netfilter.nf_conntrack_max = 2310720</span>
<span style="color: #ffa54f;">fs.inotify.max_user_watches=89100</span>
<span style="color: #ffa54f;">fs.may_detach_mounts = 1</span>
<span style="color: #ffa54f;">fs.file-max = 52706963</span>
<span style="color: #ffa54f;">fs.nr_open = 52706963</span>

<span style="color: #ffa54f;"># &#35299;&#20915; k8s service &#21516;&#33410;&#28857;&#36890;&#20449;&#38382;&#39064;</span>
<span style="color: #ffa54f;">net.bridge.bridge-nf-call-ip6tables = 1</span>
<span style="color: #ffa54f;">net.bridge.bridge-nf-call-iptables = 1</span>


<span style="color: #ffa54f;">#&#31105;&#27490;&#20351;&#29992; swap &#31354;&#38388;&#65292;&#21482;&#26377;&#24403;&#31995;&#32479; OOM &#26102;&#25165;&#20801;&#35768;&#20351;&#29992;&#23427;</span>
<span style="color: #ffa54f;">vm.swappiness=0</span>
<span style="color: #ffa54f;">vm.panic_on_oom=0  # &#24320;&#21551; OOM</span>
<span style="color: #ffa54f;">vm.overcommit_memory=1 # &#19981;&#26816;&#26597;&#29289;&#29702;&#20869;&#23384;&#26159;&#21542;&#22815;&#29992;</span>

<span style="color: #ffa54f;"># kube-proxy&#20351;&#29992;ipvs&#30340;&#35805;&#20026;&#20102;&#38450;&#27490;timeout&#38656;&#35201;&#35774;&#32622;&#19979;tcp&#21442;&#25968;</span>
<span style="color: #ffa54f;"># https://github.com/moby/moby/issues/31208 </span>
<span style="color: #ffa54f;"># ipvsadm -l --timout</span>
<span style="color: #ffa54f;"># &#20462;&#22797;ipvs&#27169;&#24335;&#19979;&#38271;&#36830;&#25509;timeout&#38382;&#39064; &#23567;&#20110;900&#21363;&#21487;</span>
<span style="color: #ffa54f;">net.ipv4.tcp_keepalive_time = 600</span>
<span style="color: #ffa54f;">net.ipv4.tcp_keepalive_probes = 3</span>
<span style="color: #ffa54f;">net.ipv4.tcp_keepalive_intvl =15</span>

<span style="color: #ffa54f;">net.ipv4.conf.all.arp_announce = 2</span>
<span style="color: #ffa54f;">net.ipv4.tcp_max_tw_buckets = 50000</span>
<span style="color: #ffa54f;">net.ipv4.tcp_tw_reuse = 1</span>
<span style="color: #ffa54f;">net.ipv4.tcp_max_orphans = 327680</span>
<span style="color: #ffa54f;">net.ipv4.tcp_orphan_retries = 3</span>
<span style="color: #ffa54f;">net.ipv4.tcp_syncookies = 1</span>
<span style="color: #ffa54f;">net.ipv4.tcp_max_syn_backlog = 16384</span>
<span style="color: #ffa54f;">net.ipv4.ip_conntrack_max = 65536</span>
<span style="color: #ffa54f;">net.ipv4.tcp_synack_retries = 2</span>
<span style="color: #ffa54f;">net.ipv4.tcp_timestamps = 0</span>
<span style="color: #ffa54f;">net.core.somaxconn = 16384</span>

<span style="color: #ffa54f;">net.ipv6.conf.all.disable_ipv6 = 1</span>
<span style="color: #ffa54f;">net.ipv6.conf.default.disable_ipv6 = 1</span>
<span style="color: #ffa54f;">net.ipv6.conf.lo.disable_ipv6 = 1</span>
<span style="color: #ffa54f;">net.ipv4.neigh.default.gc_stale_time = 120</span>
<span style="color: #ffa54f;">net.ipv4.conf.all.rp_filter = 0</span>
<span style="color: #ffa54f;">net.ipv4.conf.default.rp_filter = 0</span>
<span style="color: #ffa54f;">net.ipv4.conf.default.arp_announce = 2</span>
<span style="color: #ffa54f;">net.ipv4.conf.lo.arp_announce = 2</span>
<span style="color: #ffa54f;">EOF</span>

sysctl --system
</pre>
</div>

<p>
所有节点重启,  检查是否加载
</p>

<div class="org-src-container">
<pre class="src src-sh">reboot
lsmod | grep --color=auto -e ip_vs -e nf_conntrack
</pre>
</div>

<p>
启用 <code>bridge-nf-call-iptables</code> 这个内核参数 (置为 1)，表示 bridge 设备在二层转发时也去调用 iptables 配置的三层规则 (包含 conntrack)，所以开启这个参数就能够解决上述 Service 同节点通信问题，这也是为什么在 Kubernetes 环境中，大多都要求开启 <code>bridge-nf-call-iptables</code> 的原因。
</p>

<p>
参考<a href="https://imroc.cc/post/202105/why-enable-bridge-nf-call-iptables/">https://imroc.cc/post/202105/why-enable-bridge-nf-call-iptables/</a>
</p>
</div>
</div>
<div id="outline-container-h:e6df0c63-f665-4b6a-a49c-61b4073f5dc9" class="outline-3">
<h3 id="h:e6df0c63-f665-4b6a-a49c-61b4073f5dc9">k8s 组件和 runtime 安装</h3>
<div class="outline-text-3" id="text-h:e6df0c63-f665-4b6a-a49c-61b4073f5dc9">
<p>
如果安装的版本低于1.24，选择Docker和Containerd均可，高于1.24选择Containerd作为Runtime。
</p>
</div>
<div id="outline-container-h:d71f041f-250b-4459-9f08-132c40505a98" class="outline-4">
<h4 id="h:d71f041f-250b-4459-9f08-132c40505a98">Containerd 作为 Runtime</h4>
<div class="outline-text-4" id="text-h:d71f041f-250b-4459-9f08-132c40505a98">
<p>
所有节点安装docker-ce-20.10：
</p>
<div class="org-src-container">
<pre class="src src-shell">yum install docker-ce-20.10.* docker-ce-cli-20.10.* -y
</pre>
</div>

<p>
可以无需启动Docker，只需要配置和启动Containerd即可。
</p>

<p>
首先配置Containerd所需的模块（所有节点）：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf</span>
overlay
br_netfilter
EOF
</pre>
</div>

<p>
所有节点加载模块：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">modprobe -- overlay</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">modprobe -- br_netfilter</span>
</pre>
</div>

<p>
所有节点，配置Containerd所需的内核：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span>
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF
</pre>
</div>

<p>
所有节点加载内核：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">sysctl --system</span>
</pre>
</div>

<p>
所有节点配置Containerd的配置文件：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">mkdir -p /etc/containerd</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">containerd config default | tee /etc/containerd/config.toml</span>
</pre>
</div>

<p>
所有节点将Containerd的Cgroup改为Systemd：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">vim /etc/containerd/config.toml</span>
</pre>
</div>
<p>
找到containerd.runtimes.runc.options，下一行添加SystemdCgroup = true，如下图所示：
</p>

<p>
所有节点将sandbox_image的Pause镜像改成符合自己版本的地址registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6：
</p>

<p>
所有节点启动Containerd，并配置开机自启动：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">systemctl daemon-reload</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">systemctl enable --now containerd</span>
</pre>
</div>

<p>
所有节点配置crictl客户端连接的运行时位置：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">cat &gt; /etc/crictl.yaml &lt;&lt;EOF</span>
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 10
debug: false
EOF
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6fb0bd42-6b14-4a3a-9e57-c6570a0c6a6e" class="outline-4">
<h4 id="h:6fb0bd42-6b14-4a3a-9e57-c6570a0c6a6e">Docker 作为 Runtime （版本小于 1.24）</h4>
<div class="outline-text-4" id="text-h:6fb0bd42-6b14-4a3a-9e57-c6570a0c6a6e">
<div class="org-src-container">
<pre class="src src-shell">yum install docker-ce-20.10.* docker-ce-cli-20.10.* -y
</pre>
</div>

<p>
<b>温馨提示</b>
</p>

<p>
由于新版kubelet 建议使用systemd，所以可以把 docker 的 CgroupDriver 改成systemd
</p>

<div class="org-src-container">
<pre class="src src-shell"> mkdir /etc/docker
cat &gt; /etc/docker/daemon.json &lt;&lt;EOF
<span style="color: #ffa54f;">{</span>
<span style="color: #ffa54f;">  "exec-opts": ["native.cgroupdriver=systemd"]</span>
<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
所有节点设置开机自启动Docker
</p>

<div class="org-src-container">
<pre class="src src-shell">systemctl daemon-reload &amp;&amp; systemctl enable --now docker
</pre>
</div>
</div>
</div>
<div id="outline-container-h:31474281-9c84-4e14-99a6-c1f2bd741f6a" class="outline-4">
<h4 id="h:31474281-9c84-4e14-99a6-c1f2bd741f6a">安装k8s组件</h4>
<div class="outline-text-4" id="text-h:31474281-9c84-4e14-99a6-c1f2bd741f6a">
<p>
首先在Master01节点查看最新的Kubernetes版本是多少：
</p>
<div class="org-src-container">
<pre class="src src-shell">yum list kubeadm.x86_64 --showduplicates | sort -r
</pre>
</div>

<p>
所有节点安装最新版本kubeadm
</p>

<div class="org-src-container">
<pre class="src src-shell">yum install -y kubelet kubeadm kubectl
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#29256;&#26412; yum install kubeadm-1.23* kubelet-1.23* kubectl-1.23* -y</span>
</pre>
</div>

<p>
默认配置的pause镜像使用 gcr.io 仓库，国内可能无法访问，所以这里配置 Kubelet 使用阿里云的 pause 镜像，使用 Containerd 可跳过这步：
</p>

<div class="org-src-container">
<pre class="src src-shell">cat &gt;/etc/sysconfig/kubelet&lt;&lt;EOF
<span style="color: #ffa54f;">KUBELET_EXTRA_ARGS="--pod-infra-container-image=registry.cn-6</span>
<span style="color: #ffa54f;">hangzhou.aliyuncs.com/google_containers/pause:3.6"</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
如果选择的是Containerd作为的Runtime，需要更改Kubelet的配置使用Containerd作为Runtime：
</p>

<div class="org-src-container">
<pre class="src src-sh">cat &gt;/etc/sysconfig/kubelet&lt;&lt;EOF
<span style="color: #ffa54f;">KUBELET_KUBEADM_ARGS="--container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///run/containerd/containerd.sock"</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#20934;&#22791;k8s-1.32.9 &#25152;&#38656;&#35201;&#30340;&#38236;&#20687;</span>
kubeadm config images list --kubernetes-version=v1.32.9

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#25552;&#21069;&#25226;&#38236;&#20687;&#19979;&#36733;&#22909;&#65292;&#36825;&#26679;&#23433;&#35013;&#24555;&#65288;&#21487;&#36873;&#27493;&#39588;&#65289;</span>
crictl pull registry.aliyuncs.com/google_containers/kube-apiserver:v1.32.9
crictl pull registry.aliyuncs.com/google_containers/kube-controller-manager:v1.32.9
crictl pull registry.aliyuncs.com/google_containers/kube-scheduler:v1.32.9
crictl pull registry.aliyuncs.com/google_containers/kube-proxy:v1.32.9
crictl pull registry.aliyuncs.com/google_containers/pause:3.10
crictl pull registry.aliyuncs.com/google_containers/etcd:3.5.16-0
crictl pull registry.aliyuncs.com/google_containers/coredns:v1.11.3
</pre>
</div>

<p>
设置Kubelet开机自启动
</p>

<div class="org-src-container">
<pre class="src src-shell">systemctl daemon-reload
systemctl enable --now kubelet
</pre>
</div>

<p>
由于还未初始化，没有kubelet的配置文件，此时kubelet无法启动，无需管理
</p>
</div>
</div>
</div>
<div id="outline-container-h:30640a70-34c2-4e49-bc60-7ab000e509b7" class="outline-3">
<h3 id="h:30640a70-34c2-4e49-bc60-7ab000e509b7">高可用组件安装</h3>
<div class="outline-text-3" id="text-h:30640a70-34c2-4e49-bc60-7ab000e509b7">
<p>
（注意：如果不是高可用集群，haproxy和keepalived无需安装）
</p>

<p>
公有云要用公有云自带的负载均衡，比如阿里云的SLB，腾讯云的ELB，用来替代haproxy和keepalived，因为公有云大部分都是不支持keepalived的，另外如果用阿里云的话，kubectl控制端不能放在master节点，推荐使用腾讯云，因为阿里云的slb有回环的问题，也就是slb代理的服务器不能反向访问SLB，但是腾讯云修复了这个问题。
</p>

<p>
所有Master节点通过yum安装HAProxy和KeepAlived：
</p>

<div class="org-src-container">
<pre class="src src-shell">yum install keepalived haproxy -y
</pre>
</div>

<p>
所有Master节点配置HAProxy（详细配置参考HAProxy文档，所有Master节点的HAProxy配置相同）：
</p>

<div class="org-src-container">
<pre class="src src-shell">[root@k8s-master01 etc]# mkdir /etc/haproxy
[root@k8s-master01 etc]# vim /etc/haproxy/haproxy.cfg 
global
  maxconn  2000
  ulimit-n  16384
  log  127.0.0.1 local0 err
  stats timeout 30s

defaults
  log global
  mode  http
  option  httplog
  timeout connect 5000
  timeout client  50000
  timeout server  50000
  timeout http-request 15s
  timeout http-keep-alive 15s

frontend monitor-in
  <span style="color: #483d8b;">bind</span> *:33305
  mode http
  option httplog
  monitor-uri /monitor

frontend k8s-master
  <span style="color: #483d8b;">bind</span> 0.0.0.0:16443
  <span style="color: #483d8b;">bind</span> 127.0.0.1:16443
  mode tcp
  option tcplog
  tcp-request inspect-delay 5s
  default_backend k8s-master

backend k8s-master
  mode tcp
  option tcplog
  option tcp-check
  balance roundrobin
  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
  <span style="color: #b22222;"># </span><span style="color: #b22222;">3 &#20010; master &#33410;&#28857; ip</span>
  server k8s-master01   192.168.0.107:6443  check
  server k8s-master02   192.168.0.108:6443  check
  server k8s-master03   192.168.0.109:6443  check
</pre>
</div>

<p>
所有Master节点配置KeepAlived，配置不一样，注意区分
</p>

<ul class="org-ul">
<li>网卡名称 interface</li>
<li>mcast_src_ip 地址</li>
<li>virtual_ipaddress 虚拟 vip 地址，与主机在同一网段内</li>
<li>注意每个节点的IP和网卡（interface参数）</li>
</ul>


<p>
Master01节点的配置：
</p>

<div class="org-src-container">
<pre class="src src-shell">[root@k8s-master01 etc]# mkdir /etc/keepalived

[root@k8s-master01 ~]# vim /etc/keepalived/keepalived.conf 
! Configuration File for keepalived
global_defs {
    router_id LVS_DEVEL
script_user root
    enable_script_security
}
vrrp_script chk_apiserver {
    script <span style="color: #8b2252;">"/etc/keepalived/check_apiserver.sh"</span>
    interval 5
    weight -5
    fall 2  
rise 1
}
vrrp_instance VI_1 {
    state MASTER
    interface ens33
    mcast_src_ip 192.168.0.107
    virtual_router_id 51
    priority 101
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.0.236
    }
    track_script {
       chk_apiserver
    }
}
</pre>
</div>

<p>
Master02节点的配置：
</p>

<div class="org-src-container">
<pre class="src src-shell">! Configuration File for keepalived
global_defs {
    router_id LVS_DEVEL
script_user root
    enable_script_security
}
vrrp_script chk_apiserver {
    script <span style="color: #8b2252;">"/etc/keepalived/check_apiserver.sh"</span>
   interval 5
    weight -5
    fall 2  
rise 1
}
vrrp_instance VI_1 {
    state BACKUP
    interface ens33
    mcast_src_ip 192.168.0.108
    virtual_router_id 51
    priority 100
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.0.236
    }
    track_script {
       chk_apiserver
    }
}
</pre>
</div>

<p>
Master03节点的配置：
</p>

<div class="org-src-container">
<pre class="src src-shell">! Configuration File for keepalived
global_defs {
    router_id LVS_DEVEL
script_user root
    enable_script_security
}
vrrp_script chk_apiserver {
    script <span style="color: #8b2252;">"/etc/keepalived/check_apiserver.sh"</span>
 interval 5
    weight -5
    fall 2  
rise 1
}
vrrp_instance VI_1 {
    state BACKUP
    interface ens33
    mcast_src_ip 192.168.0.109
    virtual_router_id 51
    priority 100
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.0.236
    }
    track_script {
       chk_apiserver
    }
}
</pre>
</div>

<p>
所有master节点，配置KeepAlived健康检查文件：
</p>

<div class="org-src-container">
<pre class="src src-shell">[root@k8s-master01 keepalived]# cat /etc/keepalived/check_apiserver.sh 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>

<span style="color: #a0522d;">err</span>=0
<span style="color: #a020f0;">for</span> k<span style="color: #a020f0;"> in</span> $(<span style="color: #ff00ff;">seq 1 3</span>)
<span style="color: #a020f0;">do</span>
    <span style="color: #a0522d;">check_code</span>=$(<span style="color: #ff00ff;">pgrep haproxy</span>)
    <span style="color: #a020f0;">if</span> [[ $<span style="color: #a0522d;">check_code</span> == <span style="color: #8b2252;">""</span> ]]; <span style="color: #a020f0;">then</span>
        <span style="color: #a0522d;">err</span>=$(<span style="color: #ff00ff;">expr $err + 1</span>)
        sleep 1
        <span style="color: #a020f0;">continue</span>
    <span style="color: #a020f0;">else</span>
        <span style="color: #a0522d;">err</span>=0
        <span style="color: #a020f0;">break</span>
    <span style="color: #a020f0;">fi</span>
<span style="color: #a020f0;">done</span>

<span style="color: #a020f0;">if</span> [[ $<span style="color: #a0522d;">err</span> != <span style="color: #8b2252;">"0"</span> ]]; <span style="color: #a020f0;">then</span>
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"systemctl stop keepalived"</span>
    /usr/bin/systemctl stop keepalived
    <span style="color: #a020f0;">exit</span> 1
<span style="color: #a020f0;">else</span>
    <span style="color: #a020f0;">exit</span> 0
<span style="color: #a020f0;">fi</span>


chmod +x /etc/keepalived/check_apiserver.sh
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160;haproxy&#21644;keepalived</span>
[root@k8s-master01 keepalived]# systemctl daemon-reload
[root@k8s-master01 keepalived]# systemctl enable --now haproxy
[root@k8s-master01 keepalived]# systemctl enable --now keepalived
</pre>
</div>

<p>
测试VIP
</p>

<div class="org-src-container">
<pre class="src src-shell">[root@k8s-master01 ~]# ping 192.168.0.236 -c 4
PING 192.168.0.236 (192.168.0.236) 56(84) bytes of data.
64 bytes from 192.168.0.236: <span style="color: #a0522d;">icmp_seq</span>=1 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.464 ms
64 bytes from 192.168.0.236: <span style="color: #a0522d;">icmp_seq</span>=2 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.063 ms
64 bytes from 192.168.0.236: <span style="color: #a0522d;">icmp_seq</span>=3 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.062 ms
64 bytes from 192.168.0.236: <span style="color: #a0522d;">icmp_seq</span>=4 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.063 ms

telnet 192.168.0.236 16443
Escape character is <span style="color: #8b2252;">'^]'</span>.
Connection closed by foreign host.
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26085;&#24535;&#26597;&#30475;</span>
tail -f /var/log/messages
</pre>
</div>

<p>
如果ping不通且telnet没有出现 ] ，则认为VIP不可以，不可在继续往下执行，需要排查keepalived的问题，比如防火墙和selinux，haproxy和keepalived的状态，监听端口等
</p>

<p>
所有节点查看防火墙状态必须为disable和inactive：systemctl status firewalld
</p>

<p>
所有节点查看selinux状态，必须为disable：getenforce
</p>

<p>
master节点查看haproxy和keepalived状态：systemctl status keepalived haproxy
</p>

<p>
master节点查看监听端口：netstat -lntp
</p>
</div>
</div>
</section>
<section id="outline-container-h:ec12062f-68eb-4b04-8833-2edd72d936b5" class="outline-2">
<h2 id="h:ec12062f-68eb-4b04-8833-2edd72d936b5">集群建立部分</h2>
<div class="outline-text-2" id="text-h:ec12062f-68eb-4b04-8833-2edd72d936b5">
</div>
<div id="outline-container-h:05ce7887-a24c-47db-a03b-6944fe20dfa5" class="outline-3">
<h3 id="h:05ce7887-a24c-47db-a03b-6944fe20dfa5">集群初始化</h3>
<div class="outline-text-3" id="text-h:05ce7887-a24c-47db-a03b-6944fe20dfa5">
<p>
官方初始化文档：
</p>

<p>
<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/</a>
</p>
</div>
<div id="outline-container-h:4e2afd45-6d9c-49e1-ab7f-170ffc410611" class="outline-4">
<h4 id="h:4e2afd45-6d9c-49e1-ab7f-170ffc410611">kubeadm 命令使用</h4>
<div class="outline-text-4" id="text-h:4e2afd45-6d9c-49e1-ab7f-170ffc410611">
<div class="org-src-container">
<pre class="src src-shell">Available Commands:
    alpha <span style="color: #b22222;">#</span><span style="color: #b22222;">kubeadm &#22788;&#20110;&#27979;&#35797;&#38454;&#27573;&#30340;&#21629;&#20196;</span>
    completion <span style="color: #b22222;">#</span><span style="color: #b22222;">bash &#21629;&#20196;&#34917;&#20840;&#65292;&#38656;&#35201;&#23433;&#35013; bash-completion</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">mkdir /data/scripts -p</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">kubeadm completion bash &gt; /data/scripts/kubeadm_completion.sh</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">source /data/scripts/kubeadm_completion.sh</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">vim /etc/profile #&#28155;&#21152;&#20869;&#23481;</span>
        <span style="color: #483d8b;">source</span> /data/scripts/kubeadm_completion.sh
    config <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31649;&#29702; kubeadm &#38598;&#32676;&#30340;&#37197;&#32622;&#65292;&#35813;&#37197;&#32622;&#20445;&#30041;&#22312;&#38598;&#32676;&#30340; ConfigMap &#20013;</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">kubeadm config print init-defaults</span>
    <span style="color: #483d8b;">help</span> Help about any command
    init    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#19968;&#20010; Kubernetes &#20027;&#33410;&#28857;</span>
    join    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#33410;&#28857;&#21152;&#20837;&#21040;&#24050;&#32463;&#23384;&#22312;&#30340; k8s master</span>
    reset   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36824;&#21407;&#20351;&#29992; kubeadm init &#25110;&#32773; kubeadm join &#23545;&#31995;&#32479;&#20135;&#29983;&#30340;&#29615;&#22659;&#21464;&#21270;&#12290;&#28165;&#31354;&#33410;&#28857;&#25968;&#25454;</span>
    token   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31649;&#29702; token</span>
    upgrade <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21319;&#32423; k8s &#29256;&#26412;</span>
    version <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#29256;&#26412;&#20449;&#24687;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8459c629-b142-43a1-9db8-fb123646c0c7" class="outline-4">
<h4 id="h:8459c629-b142-43a1-9db8-fb123646c0c7">kubeadm init 命令简介</h4>
<div class="outline-text-4" id="text-h:8459c629-b142-43a1-9db8-fb123646c0c7">
<p>
命令使用：
<a href="https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/">https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/</a>
</p>

<p>
集群初始化：
<a href="https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-init/">https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-init/</a>
</p>

<div class="org-src-container">
<pre class="src src-shell">root@docker-k8s-node1:~# kubeadm init --help
--apiserver-advertise-address string    <span style="color: #b22222;">#</span><span style="color: #b22222;">K8S API Server &#23558;&#35201;&#30417;&#21548;&#30340;&#30417;&#21548;&#30340;&#26412;&#26426; IP</span>
--apiserver-bind-port int32             <span style="color: #b22222;">#</span><span style="color: #b22222;">API Server &#32465;&#23450;&#30340;&#31471;&#21475;,&#40664;&#35748;&#20026; 6443</span>

--apiserver-cert-extra-sans stringSlice <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#36873;&#30340;&#35777;&#20070;&#39069;&#22806;&#20449;&#24687;&#65292;&#29992;&#20110;&#25351;&#23450; API Server &#30340;&#26381;&#21153;&#22120;&#35777;&#20070;&#12290;&#21487;&#20197;&#26159; IP &#22320;&#22336;&#20063;&#21487;&#20197;&#26159; DNS &#21517;&#31216;&#12290;</span>
--cert-dir string                       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35777;&#20070;&#30340;&#23384;&#20648;&#36335;&#24452;&#65292;&#32570;&#30465;&#36335;&#24452;&#20026; /etc/kubernetes/pki</span>
--certificate-key string                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#19968;&#20010;&#29992;&#20110;&#21152;&#23494; kubeadm-certs Secret &#20013;&#30340;&#25511;&#21046;&#24179;&#21488;&#35777;&#20070;&#30340;&#23494;&#38053;</span>
--config string <span style="color: #b22222;">#</span><span style="color: #b22222;">kubeadm                #&#37197;&#32622;&#25991;&#20214;&#30340;&#36335;&#24452;</span>
--control-plane-endpoint string         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#25511;&#21046;&#24179;&#21488;&#25351;&#23450;&#19968;&#20010;&#31283;&#23450;&#30340; IP &#22320;&#22336;&#25110; DNS &#21517;&#31216;&#65292;&#21363;&#37197;&#32622;&#19968;&#20010;&#21487;&#20197;&#38271;&#26399;&#20351;&#29992;&#20999;&#26159;&#39640;&#21487;&#29992;&#30340; VIP &#25110;&#32773;&#22495;&#21517;&#65292;</span>
                                        k8s&#22810;master &#39640;&#21487;&#29992;&#22522;&#20110;&#27492;&#21442;&#25968;&#23454;&#29616;
--cri-socket string                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35201;&#36830;&#25509;&#30340; CRI(&#23481;&#22120;&#36816;&#34892;&#26102;&#25509;&#21475;&#65292;Container Runtime Interface, &#31616;&#31216; CRI)&#22871;&#25509;&#23383;&#30340;&#36335;&#24452;&#65292;&#22914;&#26524;&#20026;&#31354;&#65292;&#21017; kubeadm </span>
                                        &#23558;&#23581;&#35797;&#33258;&#21160;&#26816;&#27979;&#27492;&#20540;&#65292;<span style="color: #8b2252;">"&#20165;&#24403;&#23433;&#35013;&#20102;&#22810;&#20010; CRI &#25110;&#20855;&#26377;&#38750;&#26631;&#20934; CRI &#25554;&#27133;&#26102;&#65292;&#25165;&#20351;&#29992;&#27492;&#36873;&#39033;"</span>
--dry-run                               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#35201;&#24212;&#29992;&#20219;&#20309;&#26356;&#25913;&#65292;&#21482;&#26159;&#36755;&#20986;&#23558;&#35201;&#25191;&#34892;&#30340;&#25805;&#20316;&#65292;&#20854;&#23454;&#23601;&#26159;&#27979;&#35797;&#36816;&#34892;&#12290;</span>
--experimental-kustomize string         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;&#23384;&#20648; kustomize &#20026;&#38745;&#24577; pod &#28165;&#21333;&#25152;&#25552;&#20379;&#30340;&#34917;&#19969;&#30340;&#36335;&#24452;&#12290;</span>
--feature-gates string                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#32452;&#29992;&#26469;&#25551;&#36848;&#21508;&#31181;&#21151;&#33021;&#29305;&#24615;&#30340;&#38190;&#20540;&#65288;key=value&#65289;&#23545;&#65292;&#36873;&#39033;&#26159;&#65306;IPv6DualStack=true|false (ALPHA - default=false)</span>
--ignore-preflight-errors strings       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#24573;&#30053;&#26816;&#26597;&#36807;&#31243; &#20013;&#20986;&#29616;&#30340;&#38169;&#35823;&#20449;&#24687;&#65292;&#27604;&#22914;&#24573;&#30053; swap&#65292;&#22914;&#26524;&#20026; all &#23601;&#24573;&#30053;&#25152;&#26377;</span>
--image-repository string               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#19968;&#20010;&#38236;&#20687;&#20179;&#24211;&#65292;&#40664;&#35748;&#20026; k8s.gcr.io</span>
--kubernetes-version string             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#23433;&#35013; k8s &#29256;&#26412;&#65292;&#40664;&#35748;&#20026; stable-1</span>
--node-name string                      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450; node &#33410;&#28857;&#21517;&#31216;</span>
--pod-network-cidr                      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622; pod ip &#22320;&#22336;&#33539;&#22260;</span>
--service-cidr                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622; service &#32593;&#32476;&#22320;&#22336;&#33539;&#22260;&#65292;&#40664;&#35748;&#20540;&#65306;"10.96.0.0/12"</span>
--service-dns-domain string             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622; k8s&#20869;&#37096;&#22495;&#21517;&#65292;&#40664;&#35748;&#20026; cluster.local&#65292;&#20250;&#26377;&#30456;&#24212;&#30340; DNS &#26381;&#21153;(kube-dns/coredns)&#35299;&#26512;&#29983;&#25104;&#30340;&#22495;&#21517;&#35760;&#24405;&#12290;&#21487;&#20197;&#25442;&#25104;&#20844;&#21496;&#20869;&#37096;&#20351;&#29992;&#30340;&#22495;&#21517;&#65292;&#22914;me.local</span>
--skip-certificate-key-print            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#25171;&#21360;&#29992;&#20110;&#21152;&#23494;&#30340;key &#20449;&#24687;</span>
--skip-phases strings                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35201;&#36339;&#36807;&#21738;&#20123;&#38454;&#27573;</span>
--skip-token-print                      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36339;&#36807;&#25171;&#21360; token &#20449;&#24687;</span>
--token                                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450; token</span>
--token-ttl                             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450; token &#36807;&#26399;&#26102;&#38388;&#65292;&#40664;&#35748;&#20026; 24 &#23567;&#26102;&#65292;0 &#20026;&#27704;&#19981;&#36807;&#26399;</span>
--upload-certs                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26356;&#26032;&#35777;&#20070;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20840;&#23616;&#21487;&#36873;&#39033;&#65306;</span>
--add-dir-header                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#20026; true&#65292;&#22312;&#26085;&#24535;&#22836;&#37096;&#28155;&#21152;&#26085;&#24535;&#30446;&#24405;</span>
--log-file string                       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#19981;&#20026;&#31354;&#65292;&#23558;&#20351;&#29992;&#27492;&#26085;&#24535;&#25991;&#20214;</span>
--log-file-max-size uint                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26085;&#24535;&#25991;&#20214;&#30340;&#26368;&#22823;&#22823;&#23567;&#65292;&#21333;&#20301;&#20026;&#20806;&#65292;&#40664;&#35748;&#20026; 1800 &#20806;&#65292;0 &#20026;&#27809;&#26377;&#38480;&#21046;</span>
--rootfs                                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23487;&#20027;&#26426;&#30340;&#26681;&#36335;&#24452;&#65292;&#20063;&#23601;&#26159;&#32477;&#23545;&#36335;&#24452;</span>
--skip-headers                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#20026; true&#65292;&#22312; log &#26085;&#24535;&#37324;&#38754;&#19981;&#26174;&#31034;&#26631;&#39064;&#21069;&#32512;</span>
--skip-log-headers                      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#20026; true&#65292;&#22312; log &#26085;&#24535;&#37324;&#37324;&#19981;&#26174;&#31034;&#26631;&#39064;</span>
</pre>
</div>

<p>
验证前 当前 kubeadm 版本
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">kubeadm version #&#26597;&#30475;&#24403;&#21069; kubeadm &#29256;&#26412;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">kubeadm version</span>
kubeadm version: &amp;version.Info{Major:<span style="color: #8b2252;">"1"</span>, Minor:<span style="color: #8b2252;">"17"</span>, GitVersion:<span style="color: #8b2252;">"v1.23.3"</span>,
</pre>
</div>

<p>
准备镜像：
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#23433;&#35013;&#25351;&#23450;&#29256;&#26412; k8s &#38656;&#35201;&#30340;&#38236;&#20687;&#26377;&#21738;&#20123;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">kubeadm config images list --kubernetes-version v1.23.3</span>
k8s.gcr.io/kube-apiserver:
k8s.gcr.io/kube-controller-manager:
k8s.gcr.io/kube-scheduler:
k8s.gcr.io/kube-proxy:
k8s.gcr.io/pause: <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#27599;&#20010;pod&#23553;&#35013;&#19968;&#20010;&#24213;&#23618;&#30340;&#32593;&#32476;</span>
k8s.gcr.io/etcd:
k8s.gcr.io/coredns/coredns:
</pre>
</div>
</div>
</div>
<div id="outline-container-h:10a34219-ecbf-4307-9819-3197cd660ea6" class="outline-4">
<h4 id="h:10a34219-ecbf-4307-9819-3197cd660ea6">高可用 master 初始化</h4>
<div class="outline-text-4" id="text-h:10a34219-ecbf-4307-9819-3197cd660ea6">
<p>
Master01节点创建new.yaml配置文件如下：
</p>

<p>
以下文件内容，宿主机网段、podSubnet网段、serviceSubnet网段不能重复
</p>

<div class="org-src-container">
<pre class="src src-shell">kubeadm config print init-defaults &gt; kubeadm-config.yaml <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#40664;&#35748;&#37197;&#32622;&#36755;&#20986;&#33267;&#25991;&#20214;</span>
vim kubeadm-config.yaml
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">apiVersion: kubeadm.k8s.io/v1beta2
bootstrapTokens:
- groups:
  - system:bootstrappers:kubeadm:default-node-token
  token: 7t2weq.bjbawausm0jaxury <span style="color: #b22222;"># </span><span style="color: #b22222;">token&#65292;&#31532;&#20108;&#22825;&#21487;&#33021;&#36807;&#26399;&#65292;&#21518;&#38754;&#20171;&#32461;&#38450;&#27490;&#36807;&#26399;</span>
  ttl: 24h0m0s
  usages:
  - signing
  - authentication
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: 192.168.0.107 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26412;&#22320;&#30417;&#21548;&#22320;&#22336;</span>
  bindPort: 6443
nodeRegistration:
  <span style="color: #b22222;"># </span><span style="color: #b22222;">criSocket: /var/run/dockershim.sock  # &#22914;&#26524;&#26159;Docker&#20316;&#20026;Runtime&#37197;&#32622;&#27492;&#39033;</span>
  criSocket: unix:///var/run/containerd/containerd.sock <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#26159;Containerd&#20316;&#20026;Runtime&#37197;&#32622;&#27492;&#39033;</span>
  name: k8s-master01
  taints:               <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23481;&#24525;&#65292;&#19981;&#21487;&#35843;&#24230;</span>
  - effect: NoSchedule
    key: node-role.kubernetes.io/control-plane
---
apiServer:
  certSANs:
  - 192.168.0.236 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35777;&#20070;&#39041;&#21457;&#32473;&#35841;&#65292; &#25913;&#25104; vip &#25110;&#32773;&#26159;&#20844;&#26377;&#20113;&#36127;&#36733;&#22343;&#34913;&#22320;&#22336;</span>
  timeoutForControlPlane: 4m0s
apiVersion: kubeadm.k8s.io/v1beta2
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controlPlaneEndpoint: 192.168.0.236:16443 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110; VIP &#30340; Endpoint</span>
controllerManager: {}
dns:
  <span style="color: #483d8b;">type</span>: CoreDNS
etcd:
  <span style="color: #483d8b;">local</span>:
    dataDir: /var/lib/etcd
imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38236;&#20687;&#24211;</span>
kind: ClusterConfiguration
kubernetesVersion: v1.26.0 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26356;&#25913;&#27492;&#22788;&#30340;&#29256;&#26412;&#21495;&#21644;kubeadm version&#19968;&#33268;</span>
networking:                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32593;&#32476;&#20449;&#24687;</span>
  dnsDomain: cluster.local
  podSubnet: 172.16.0.0/12
  serviceSubnet: 10.96.0.0/12
scheduler: {}
</pre>
</div>

<p>
<b>注意，如果不是高可用集群，192.168.0.236:16443改为master01的地址，16443改为apiserver的端口，默认是6443，注意更改kubernetesVersion的值和自己服务器kubeadm的版本一致：kubeadm version</b>
</p>

<p>
更新kubeadm文件
</p>

<div class="org-src-container">
<pre class="src src-shell">kubeadm config migrate --old-config kubeadm-config.yaml --new-config new.yaml
</pre>
</div>

<p>
将new.yaml文件复制到其他master节点，之后所有Master节点提前下载镜像，可以节省初始化时间（其他节点不需要更改任何配置，包括IP地址也不需要更改，只是用来下载镜像的）：
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> k8s-master02 k8s-master03; <span style="color: #a020f0;">do</span> scp new.yaml $<span style="color: #a0522d;">i</span>:/root/; <span style="color: #a020f0;">done</span>
kubeadm config images pull --config /root/new.yaml 
</pre>
</div>

<p>
所有节点设置开机自启动kubelet
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl enable --now kubelet <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#21551;&#21160;&#22833;&#36133;&#26080;&#38656;&#31649;&#29702;&#65292;&#21021;&#22987;&#21270;&#25104;&#21151;&#20197;&#21518;&#21363;&#21487;&#21551;&#21160;</span>
</pre>
</div>

<p>
Master01节点初始化，初始化以后会在/etc/kubernetes目录下生成对应的证书和配置文件，之后其他Master节点加入Master01即可：
</p>

<div class="org-src-container">
<pre class="src src-shell">kubeadm init --config /root/new.yaml  --upload-certs
</pre>
</div>

<p>
如果初始化失败，重置后再次初始化，命令如下（没有失败不要执行）：
</p>

<div class="org-src-container">
<pre class="src src-shell">kubeadm reset -f ; ipvsadm --clear  ; rm -rf ~/.kube
</pre>
</div>

<p>
初始化成功以后，会产生Token值，用于其他节点加入时使用，因此要记录下初始化成功生成的token值（令牌值）：
</p>

<div class="org-src-container">
<pre class="src src-shell">Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $<span style="color: #a0522d;">HOME</span>/.kube
  sudo cp -i /etc/kubernetes/admin.conf $<span style="color: #a0522d;">HOME</span>/.kube/config
  sudo chown $(<span style="color: #ff00ff;">id -u</span>):$(<span style="color: #ff00ff;">id -g</span>) $<span style="color: #a0522d;">HOME</span>/.kube/config

Alternatively, if you are the root user, you can run:

  <span style="color: #483d8b;">export</span> <span style="color: #a0522d;">KUBECONFIG</span>=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run <span style="color: #8b2252;">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now join any number of the control-plane node running the following command on each as root:

  kubeadm join 192.168.0.236:16443 --token 7t2weq.bjbawausm0jaxury <span style="color: #8b2252;">\</span>
    --discovery-token-ca-cert-hash sha256:8c92ecb336be2b9372851a9af2c7ca1f7f60c12c68f6ffe1eb513791a1b8a908 <span style="color: #8b2252;">\</span>
    --control-plane --certificate-key ac2854de93aaabdf6dc440322d4846fc230b290c818c32d6ea2e500fc930b0aa

Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
As a safeguard, uploaded-certs will be deleted<span style="color: #a020f0;"> in</span> two hours; If necessary, you can use
<span style="color: #8b2252;">"kubeadm init phase upload-certs --upload-certs"</span> to reload certs afterward.

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 192.168.0.236:16443 --token 7t2weq.bjbawausm0jaxury <span style="color: #8b2252;">\</span>
    --discovery-token-ca-cert-hash sha256:8c92ecb336be2b9372851a9af2c7ca1f7f60c12c68f6ffe1eb513791a1b8a908
</pre>
</div>

<p>
Master01节点配置环境变量，用于访问Kubernetes集群：
</p>

<div class="org-src-container">
<pre class="src src-shell">cat &lt;&lt;EOF &gt;&gt; /root/.bashrc
<span style="color: #ffa54f;">export KUBECONFIG=/etc/kubernetes/admin.conf</span>
<span style="color: #ffa54f;">EOF</span>
<span style="color: #483d8b;">source</span> /root/.bashrc
</pre>
</div>

<p>
查看节点状态：
</p>

<div class="org-src-container">
<pre class="src src-shell"> [root@k8s-master01 ~]# kubectl get nodes
NAME           STATUS     ROLES                  AGE   VERSION
k8s-master01   NotReady   control-plane,master   74s   v1.20.0
<span style="color: #b22222;"># </span><span style="color: #b22222;">kubectl get svc</span>
</pre>
</div>

<p>
采用初始化安装方式，所有的系统组件均以容器的方式运行并且在kube-system命名空间内，此时可以查看Pod状态：
</p>

<div class="org-src-container">
<pre class="src src-shell">[root@k8s-master01 ~]# kubectl get pods -n kube-system -o wide
NAME                                   READY     STATUS    RESTARTS   AGE       IP              NODE
coredns-777d78ff6f-kstsz               0/1       Pending   0          14m       &lt;none&gt;          &lt;none&gt;
coredns-777d78ff6f-rlfr5               0/1       Pending   0          14m       &lt;none&gt;          &lt;none&gt;
etcd-k8s-master01                      1/1       Running   0          14m       192.168.0.107   k8s-master01
kube-apiserver-k8s-master01            1/1       Running   0          13m       192.168.0.107   k8s-master01
kube-controller-manager-k8s-master01   1/1       Running   0          13m       192.168.0.107   k8s-master01
kube-proxy-8d4qc                       1/1       Running   0          14m       192.168.0.107   k8s-master01
kube-scheduler-k8s-master01            1/1       Running   0          13m       192.168.0.107   k8s-master01
</pre>
</div>

<p>
增加命令提示
</p>

<div class="org-src-container">
<pre class="src src-shell">yum install -y bash-completion
<span style="color: #483d8b;">source</span> /usr/share/bash-completion/bash_completion
<span style="color: #483d8b;">source</span> &lt;(kubectl completion bash)
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"source &lt;(kubectl completion bash)"</span> &gt;&gt; ~/.bashrc
</pre>
</div>

<p>
<b>kubeadm init 创建 k8s 集群流程</b> <a href="https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-init/">https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-init/</a>
</p>
</div>
</div>
</div>
<div id="outline-container-h:3e5773ea-b8d7-45a0-8596-2cd2f595158b" class="outline-3">
<h3 id="h:3e5773ea-b8d7-45a0-8596-2cd2f595158b">高可用Master</h3>
<div class="outline-text-3" id="text-h:3e5773ea-b8d7-45a0-8596-2cd2f595158b">
<p>
初始化其他master加入集群, master02, 03加上
</p>

<div class="org-src-container">
<pre class="src src-shell">kubeadm join 192.168.0.236:16443 --token 7t2weq.bjbawausm0jaxury <span style="color: #8b2252;">\</span>
    --discovery-token-ca-cert-hash sha256:8c92ecb336be2b9372851a9af2c7ca1f7f60c12c68f6ffe1eb513791a1b8a908 <span style="color: #8b2252;">\</span>
    --control-plane --certificate-key ac2854de93aaabdf6dc440322d4846fc230b290c818c32d6ea2e500fc930b0aa
</pre>
</div>
</div>
<div id="outline-container-h:7711fe4b-3916-43e2-aaf3-0018d9a71bf5" class="outline-4">
<h4 id="h:7711fe4b-3916-43e2-aaf3-0018d9a71bf5">token 过期处理</h4>
<div class="outline-text-4" id="text-h:7711fe4b-3916-43e2-aaf3-0018d9a71bf5">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">Token&#36807;&#26399;&#21518;&#29983;&#25104;&#26032;&#30340;token&#65306;</span>
[root@k8s-master01 ~]# kubeadm token create --print-join-command
kubeadm join 192.168.1.236:16443 --token 8k8qzk.d43ed9gfgw1st3xi     --discovery-token-ca-cert-hash sha256:3aa4cf3c52c1956cb86d2911fe0f6b8898bfa43c06966b2f1095e5000a00d1a4 

<span style="color: #b22222;"># </span><span style="color: #b22222;">Master&#38656;&#35201;&#29983;&#25104;--certificate-key</span>
[root@k8s-master01 ~]# kubeadm init phase upload-certs  --upload-certs
[upload-certs] Storing the certificates<span style="color: #a020f0;"> in</span> Secret <span style="color: #8b2252;">"kubeadm-certs"</span><span style="color: #a020f0;"> in</span> the <span style="color: #8b2252;">"kube-system"</span> Namespace
[upload-certs] Using certificate key:
43c5695789c0dc4433f480a05683d55887e836b71b452b407138d8dd54cad937
</pre>
</div>


<p>
查看 token 过期时间
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#26597;&#21021;&#22987;&#38598;&#32676;&#26102;&#30340;&#37197;&#32622;&#25991;&#20214;&#65292;&#25214;&#21040; token: 7t2weq.bjbawausm0jaxury</span>
<span style="color: #a0522d;">secret</span>=$(<span style="color: #ff00ff;">kubectl get secret -n kube-system|grep bootstrap |grep 7t2weq | awk '{print $1}'</span>)
kubectl get secret $<span style="color: #a0522d;">secret</span> -o json | jq -r <span style="color: #8b2252;">'.data["expiration"]'</span> | base64 -d
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:7e6ce312-429c-4991-820e-37ed40f5b234" class="outline-3">
<h3 id="h:7e6ce312-429c-4991-820e-37ed40f5b234">添加Node节点</h3>
<div class="outline-text-3" id="text-h:7e6ce312-429c-4991-820e-37ed40f5b234">
<div class="org-src-container">
<pre class="src src-shell">kubeadm join 192.168.0.236:16443 --token 7t2weq.bjbawausm0jaxury <span style="color: #8b2252;">\</span>
    --discovery-token-ca-cert-hash sha256:8c92ecb336be2b9372851a9af2c7ca1f7f60c12c68f6ffe1eb513791a1b8a908
</pre>
</div>

<p>
查看集群状态：
</p>

<div class="org-src-container">
<pre class="src src-shell">[root@k8s-master01]# kubectl  get node
NAME           STATUS     ROLES                  AGE     VERSION
k8s-master01   NotReady   control-plane,master   8m53s   v1.20.0
k8s-master02   NotReady   control-plane,master   2m25s   v1.20.0
k8s-master03   NotReady   control-plane,master   31s     v1.20.0
k8s-node01     NotReady   &lt;none&gt;                 32s     v1.20.0
k8s-node02     NotReady   &lt;none&gt;                 88s     v1.20.0
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31227;&#38500;&#33410;&#28857;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">kubectl drain blog-k8s-n0</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">kubectl delete node blog-k8s-n0</span>
</pre>
</div>

<p>
在没安装网络组件时，节点状态都是noready的
</p>
</div>
<div id="outline-container-h:fad58a69-70dd-43bc-9654-741226b45332" class="outline-4">
<h4 id="h:fad58a69-70dd-43bc-9654-741226b45332">k8s 安装失败故障排查</h4>
<div class="outline-text-4" id="text-h:fad58a69-70dd-43bc-9654-741226b45332">
<p>
如果 kubelet无法启动
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl stop containerd kubelet
rm -fr /etc/kubernetes
rm -fr /var/lib/containerd /var/lib/kubelet <span style="color: #b22222;"># </span><span style="color: #b22222;">umount /var/lib/kubelet/pods/xxx</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37325;&#26032;&#37197;&#32622;&#33410;&#28857; Containerd &#30340;&#37197;&#32622;&#25991;&#20214;</span>
systemctl daemon-reload
systemctl restart containerd
systemctl restart kubelet
tail /var/log/message
<span style="color: #b22222;"># </span><span style="color: #b22222;">kubeadmin join ....</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d63e7df5-cb97-4e4c-b68e-0f74d0adea30" class="outline-4">
<h4 id="h:d63e7df5-cb97-4e4c-b68e-0f74d0adea30">给node节点打标签（可选）</h4>
<div class="outline-text-4" id="text-h:d63e7df5-cb97-4e4c-b68e-0f74d0adea30">
<div class="org-src-container">
<pre class="src src-shell">kubectl label nodes k8s-node01 node-role.kubernetes.io/worker=worker
kubectl label nodes k8s-node02 node-role.kubernetes.io/worker=worker
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:defb103a-7c80-46e6-b274-872135fe041d" class="outline-3">
<h3 id="h:defb103a-7c80-46e6-b274-872135fe041d">安装网络插件</h3>
<div class="outline-text-3" id="text-h:defb103a-7c80-46e6-b274-872135fe041d">
<p>
flannel、calico、weave 选其一安装，推荐 calico
</p>

<p>
calico 支持网络策略，flannel 不支持
</p>
<ul class="org-ul">
<li>Calico是一个纯三层的数据中心网络方案，Calico支持广泛的平台，包括Kubernetes、OpenStack等。</li>
<li>Calico 在每一个计算节点利用 Linux Kernel 实现了一个高效的虚拟路由器（ vRouter） 来负责数据转发，而每个 vRouter 通过 BGP 协议负责把自己上运行的 workload 的路由信息向整个 Calico 网络内传播。</li>
<li>此外，Calico 项目还实现了 Kubernetes 网络策略，提供ACL功能。</li>
</ul>
</div>
<div id="outline-container-h:dbe105b9-d0a2-4c28-8b1b-3b47c0edb386" class="outline-4">
<h4 id="h:dbe105b9-d0a2-4c28-8b1b-3b47c0edb386">Flannel</h4>
<div class="outline-text-4" id="text-h:dbe105b9-d0a2-4c28-8b1b-3b47c0edb386">
<p>
注意： <code>kubeadm init</code> 时设置的是&#x2013;pod-network-cidr=172.16.0.0/12  默认是 &#x2013;pod-network-cidr=10.244.0.0/16，所以要修改一下文件内容，修改成自己的。
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;">#</span><span style="color: #b22222;">https://github.com/coreos/flannel/</span>
kubectl apply -f kube-flannel.yml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c5be9576-68b4-497f-8522-b8200fcfca1b" class="outline-4">
<h4 id="h:c5be9576-68b4-497f-8522-b8200fcfca1b">Calico安装</h4>
<div class="outline-text-4" id="text-h:c5be9576-68b4-497f-8522-b8200fcfca1b">
<p>
以下步骤只在master01执行
</p>

<p>
注意：需要 <code>kubeadm init</code> 时设置 <code>--pod-network-cidr=172.16.0.0/12</code>
</p>

<div class="org-src-container">
<pre class="src src-shell">kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/rbac-kdd.yaml
kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calico-networking/1.7/calico.yaml
</pre>
</div>

<p>
或者使用别人做好的
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">cd</span> /root/k8s-ha-install &amp;&amp; git checkout manual-installation-v1.26.x &amp;&amp; <span style="color: #483d8b;">cd</span> calico/
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;Pod&#32593;&#27573;</span>
<span style="color: #a0522d;">POD_SUBNET</span>=<span style="color: #ff00ff;">`cat /etc/kubernetes/manifests/kube-controller-manager.yaml | grep cluster-cidr= | awk -F= '{print $NF}'`</span>

sed -i <span style="color: #8b2252;">"s#POD_CIDR#${POD_SUBNET}#g"</span> calico.yaml
kubectl apply -f calico.yaml

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38236;&#20687;&#22320;&#22336;&#25442;&#20026;&#22269;&#20869;&#30340;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#20135;&#29615;&#22659;&#24314;&#35758;&#25226;&#38236;&#20687;&#25918;&#21040;&#20844;&#21496;&#20869;&#37096;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">grep -Po 'image:\s+\K\S+' calico-etcd.yaml </span>
</pre>
</div>

<p>
查看集群状态 (<b>需等待几分钟</b>)
</p>

<div class="org-src-container">
<pre class="src src-shell">[root@k8s-master01 dashboard]# kubectl  get po -n kube-system   
NAME                                       READY   STATUS    RESTARTS   AGE
calico-kube-controllers-5f6d4b864b-khq4h   1/1     Running   0          13m
calico-node-5tvxh                          1/1     Running   0          13m
calico-node-kffn7                          1/1     Running   0          13m
calico-node-lltfs                          1/1     Running   0          13m
calico-node-nhgn8                          1/1     Running   0          13m
coredns-54d67798b7-8w5hd                   1/1     Running   0          117m
coredns-54d67798b7-vb2ll                   1/1     Running   0          117m
etcd-k8s-master01                          1/1     Running   0          117m
etcd-k8s-master02                          1/1     Running   0          104m
kube-apiserver-k8s-master01                1/1     Running   0          117m
kube-apiserver-k8s-master02                1/1     Running   0          104m
kube-controller-manager-k8s-master01       1/1     Running   1          117m
kube-controller-manager-k8s-master02       1/1     Running   0          104m
kube-proxy-5bws8                           1/1     Running   0          117m
kube-proxy-pbqjc                           1/1     Running   0          104m
kube-proxy-tpwbt                           1/1     Running   0          86m
kube-proxy-vbpc5                           1/1     Running   0          86m
kube-scheduler-k8s-master01                1/1     Running   1          117m
kube-scheduler-k8s-master02                1/1     Running   0          104m
metrics-server-545b8b99c6-hkgnz            1/1     Running   0          2m38s
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5391ef18-5eb2-4a24-81d7-4f5eeed16b90" class="outline-4">
<h4 id="h:5391ef18-5eb2-4a24-81d7-4f5eeed16b90">weave</h4>
<div class="outline-text-4" id="text-h:5391ef18-5eb2-4a24-81d7-4f5eeed16b90">
<div class="org-src-container">
<pre class="src src-sh">sysctl net.bridge.bridge-nf-call-iptables=1
kubectl apply -f <span style="color: #8b2252;">"https://cloud.weave.works/k8s/net?k8s-version=$(</span><span style="color: #ff00ff;">kubectl version | base64 | tr -d '\n'</span><span style="color: #8b2252;">)"</span>
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:d3df78dc-ede4-4033-8410-8b755a08e493" class="outline-2">
<h2 id="h:d3df78dc-ede4-4033-8410-8b755a08e493">Addons 安装</h2>
<div class="outline-text-2" id="text-h:d3df78dc-ede4-4033-8410-8b755a08e493">
<ul class="org-ul">
<li>metrics server：查看主机、pod 的内存、CPU的使用量</li>
<li>Dashboard：图形化集群管理界面</li>
</ul>
</div>
<div id="outline-container-h:6a7f1118-dfdd-4ae7-9784-0c28c67ed707" class="outline-3">
<h3 id="h:6a7f1118-dfdd-4ae7-9784-0c28c67ed707">Metrics Server部署</h3>
<div class="outline-text-3" id="text-h:6a7f1118-dfdd-4ae7-9784-0c28c67ed707">
<p>
在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率。
将Master01节点的front-proxy-ca.crt复制到所有Node节点
</p>

<div class="org-src-container">
<pre class="src src-shell">scp /etc/kubernetes/pki/front-proxy-ca.crt k8s-node01:/etc/kubernetes/pki/front-proxy-ca.crt
scp /etc/kubernetes/pki/front-proxy-ca.crt k8s-node(&#20854;&#20182;&#33410;&#28857;&#33258;&#34892;&#25335;&#36125;):/etc/kubernetes/pki/front-proxy-ca.crt
</pre>
</div>

<p>
安装metrics server
</p>

<p>
google: kubernetes metrics server
</p>

<ul class="org-ul">
<li><a href="https://github.com/kubernetes-sigs/metrics-server">https://github.com/kubernetes-sigs/metrics-server</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">High Availability</span>
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/high-availability-1.21+.yaml
</pre>
</div>

<p>
或者使用其他人的安装：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">cd</span> /root/k8s-ha-install/kubeadm-metrics-server

<span style="color: #b22222;"># </span><span style="color: #b22222;">kubectl  create -f comp.yaml </span>
serviceaccount/metrics-server created
clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created
clusterrole.rbac.authorization.k8s.io/system:metrics-server created
rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created
clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created
clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created
service/metrics-server created
deployment.apps/metrics-server created
apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created
</pre>
</div>

<p>
等待kube-system命令空间下的Pod全部启动后，查看状态
</p>

<div class="org-src-container">
<pre class="src src-shell">kubectl get po -n kube-system -l k8s-app=metrics-server
&#21464;&#25104;1/1     Running&#21518;

[root@k8s-master01 metrics-server-0.4.x-kubeadm]# kubectl  top node
NAME           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   
k8s-master01   109m         2%     1296Mi          33%       
k8s-master02   99m          2%     1124Mi          29%       
k8s-master03   104m         2%     1082Mi          28%       
k8s-node01     55m          1%     761Mi           19%       
k8s-node02     53m          1%     663Mi           17%

<span style="color: #b22222;"># </span><span style="color: #b22222;">kubectl top po -A</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:dee36232-69a1-4b9d-b257-3ed126c67045" class="outline-3">
<h3 id="h:dee36232-69a1-4b9d-b257-3ed126c67045">Dashboard部署</h3>
<div class="outline-text-3" id="text-h:dee36232-69a1-4b9d-b257-3ed126c67045">
<p>
Dashboard用于展示集群中的各类资源，同时也可以通过Dashboard实时查看Pod的日志和在容器中执行一些命令等。
</p>
</div>
<div id="outline-container-h:21e82620-2357-4d59-9b45-b29fd0cc3d22" class="outline-4">
<h4 id="h:21e82620-2357-4d59-9b45-b29fd0cc3d22">开启自动生成Token（1.24版本上必做）</h4>
<div class="outline-text-4" id="text-h:21e82620-2357-4d59-9b45-b29fd0cc3d22">
<p>
如果安装的K8s版本以上是1.24以上的（包含1.24），关闭了自动生产 token 的配置，需要修改apiserver的以下配置：
所有master节点修改apiserver配置：
</p>
<div class="org-src-container">
<pre class="src src-shell">vim /etc/kubernetes/manifests/kube-apiserver.yaml
</pre>
</div>
<p>
然后在这个文件的command参数的第二行，添加 <code>--feature-gates=LegacyServiceAccountTokenNoAutoGeneration=false</code> (如果有feature-gates参数，直接在后面添加 LegacyServiceAccountTokenNoAutoGeneration=false 即可).
</p>

<p>
同样的方式修改controller-manager
</p>

<p>
之后重启kubelet，然后安装dashboard即可
</p>
<div class="org-src-container">
<pre class="src src-shell">systemctl restart kubelet
</pre>
</div>
</div>
</div>
<div id="outline-container-h:05cb790c-92df-424a-a3bb-aec07f3668ad" class="outline-4">
<h4 id="h:05cb790c-92df-424a-a3bb-aec07f3668ad">安装指定版本 dashboard</h4>
<div class="outline-text-4" id="text-h:05cb790c-92df-424a-a3bb-aec07f3668ad">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">cd</span> /root/k8s-ha-install/dashboard/

[root@k8s-master01 dashboard]# kubectl  create -f .
serviceaccount/admin-user created
clusterrolebinding.rbac.authorization.k8s.io/admin-user created
namespace/kubernetes-dashboard created
serviceaccount/kubernetes-dashboard created
service/kubernetes-dashboard created
secret/kubernetes-dashboard-certs created
secret/kubernetes-dashboard-csrf created
secret/kubernetes-dashboard-key-holder created
configmap/kubernetes-dashboard-settings created
role.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created
rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
deployment.apps/kubernetes-dashboard created
service/dashboard-metrics-scraper created
deployment.apps/dashboard-metrics-scraper created
</pre>
</div>
</div>
</div>
<div id="outline-container-h:74e9f102-f096-4362-870b-aebfb272c81b" class="outline-4">
<h4 id="h:74e9f102-f096-4362-870b-aebfb272c81b">安装最新版</h4>
<div class="outline-text-4" id="text-h:74e9f102-f096-4362-870b-aebfb272c81b">
<p>
官方GitHub地址：<a href="https://github.com/kubernetes/dashboard">https://github.com/kubernetes/dashboard</a>
</p>

<p>
可以在官方dashboard查看到最新版dashboard
</p>

<div class="org-src-container">
<pre class="src src-shell">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.0/aio/deploy/recommended.yaml
</pre>
</div>

<p>
2.5.0 以具体版本号为准
</p>

<div class="org-src-container">
<pre class="src src-shell">vim admin.yaml

apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding 
metadata: 
  name: admin-user
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: <span style="color: #8b2252;">"true"</span>
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kube-system

<span style="color: #b22222;"># </span><span style="color: #b22222;">kubectl apply -f admin.yaml -n kube-system  </span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f2f505b0-689f-4bc7-8ac8-47ff0671f247" class="outline-4">
<h4 id="h:f2f505b0-689f-4bc7-8ac8-47ff0671f247">登录dashboard</h4>
<div class="outline-text-4" id="text-h:f2f505b0-689f-4bc7-8ac8-47ff0671f247">
<p>
在谷歌浏览器（Chrome）启动快捷方式文件中加入启动参数，用于解决无法访问Dashboard的问题：
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;&#26368;&#21518;&#38754;&#21152;</span>
--test-type --ignore-certificate-errors
</pre>
</div>

<p>
更改dashboard的svc为NodePort：
</p>

<div class="org-src-container">
<pre class="src src-shell">kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard
</pre>
</div>
<p>
将ClusterIP更改为NodePort（如果已经为NodePort忽略此步骤)：
</p>

<p>
查看端口号：
</p>
<div class="org-src-container">
<pre class="src src-sh">kubectl get svc kubernetes-dashboard -n kubernetes-dashboard
</pre>
</div>

<p>
根据自己的实例端口号，通过任意安装了kube-proxy的宿主机或者VIP的IP+端口即可访问到dashboard：
</p>

<p>
访问Dashboard：<a href="https://192.168.0.236:18282/">https://192.168.0.236:18282/</a> （请更改18282为自己的端口），选择登录方式为令牌（即token方式)
</p>

<p>
查看token值：
</p>

<div class="org-src-container">
<pre class="src src-shell">[root@k8s-master01 1.1.1]# kubectl -n kube-system describe secret $(<span style="color: #ff00ff;">kubectl -n kube-system get secret | grep admin-user | awk '{print $1}'</span>)
token:  xxxxxx
</pre>
</div>

<p>
将token值输入到令牌后，单击登录即可访问Dashboard
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#25152;&#26377;&#23481;&#22120;&#29366;&#24577;</span>
[root@k8s-master01 dashboard]# kubectl get po -A
NAMESPACE              NAME                                         READY   STATUS    RESTARTS   AGE
kube-system            calico-kube-controllers-5f6d4b864b-khq4h     1/1     Running   0          16m
kube-system            calico-node-5tvxh                            1/1     Running   0          16m
kube-system            calico-node-kffn7                            1/1     Running   0          16m
kube-system            calico-node-lltfs                            1/1     Running   0          16m
kube-system            calico-node-nhgn8                            1/1     Running   0          16m
kube-system            coredns-54d67798b7-8w5hd                     1/1     Running   0          121m
kube-system            coredns-54d67798b7-vb2ll                     1/1     Running   0          121m
kube-system            etcd-k8s-master01                            1/1     Running   0          121m
kube-system            etcd-k8s-master02                            1/1     Running   0          107m
kube-system            kube-apiserver-k8s-master01                  1/1     Running   0          121m
kube-system            kube-apiserver-k8s-master02                  1/1     Running   0          107m
kube-system            kube-controller-manager-k8s-master01         1/1     Running   1          121m
kube-system            kube-controller-manager-k8s-master02         1/1     Running   0          107m
kube-system            kube-proxy-5bws8                             1/1     Running   0          121m
kube-system            kube-proxy-pbqjc                             1/1     Running   0          107m
kube-system            kube-proxy-tpwbt                             1/1     Running   0          90m
kube-system            kube-proxy-vbpc5                             1/1     Running   0          90m
kube-system            kube-scheduler-k8s-master01                  1/1     Running   1          121m
kube-system            kube-scheduler-k8s-master02                  1/1     Running   0          107m
kube-system            metrics-server-545b8b99c6-hkgnz              1/1     Running   0          6m25s
kubernetes-dashboard   dashboard-metrics-scraper-7645f69d8c-hftvd   1/1     Running   0          2m31s
kubernetes-dashboard   kubernetes-dashboard-78cb679857-zksm9        1/1     Running   0          2m32s
</pre>
</div>

<p>
更改dashboard的svc为NodePort
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;type&#30340;ClusterIP&#26356;&#25913;&#20026;NodePort&#65288;&#22914;&#26524;&#24050;&#32463;&#20026;NodePort&#24573;&#30053;&#27492;&#27493;&#39588;&#65289;&#65306;</span>
[root@k8s-master01 dashboard]# kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard
<span style="color: #483d8b;">type</span>: NodePort
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4b3aa559-88a7-41e0-84ca-6e978c07e578" class="outline-4">
<h4 id="h:4b3aa559-88a7-41e0-84ca-6e978c07e578">dashboard的另一种选择</h4>
<div class="outline-text-4" id="text-h:4b3aa559-88a7-41e0-84ca-6e978c07e578">
<p>
www.kuboard.cn
</p>

<p>
<a href="https://www.kuboard.cn/install/v3/install-in-k8s.html#%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4">https://www.kuboard.cn/install/v3/install-in-k8s.html#%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4</a>
</p>
</div>
</div>
</div>
</section>
<section id="outline-container-h:7239c867-fe95-49e4-ad97-78862adb1563" class="outline-2">
<h2 id="h:7239c867-fe95-49e4-ad97-78862adb1563">收尾工作</h2>
<div class="outline-text-2" id="text-h:7239c867-fe95-49e4-ad97-78862adb1563">
</div>
<div id="outline-container-h:fcda1230-1f4a-46bc-83ed-2da4cf0d1b39" class="outline-3">
<h3 id="h:fcda1230-1f4a-46bc-83ed-2da4cf0d1b39">一些必须的配置更改</h3>
<div class="outline-text-3" id="text-h:fcda1230-1f4a-46bc-83ed-2da4cf0d1b39">
<p>
将 Kube-proxy 改为ipvs模式，因为在初始化集群的时候注释了 ipvs配置，所以需要自行修改一下：
</p>

<p>
在master01节点执行
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#21407;&#26469;&#30340;mode&#27169;&#24335;</span>
[root@k8s-master01 ~]# curl 127.0.0.1:10249/proxyMode
iptables

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;</span>
[root@k8s-master01 ~]# kubectl edit cm kube-proxy -n kube-system
mode: <span style="color: #8b2252;">"ipvs"</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">44&#34892;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26356;&#26032;Kube-Proxy&#30340;Pod</span>
[root@k8s-master01 ~]# kubectl patch daemonset kube-proxy -p <span style="color: #8b2252;">"{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"date\":\"`date +'%s'`\"}}}}}"</span> -n kube-system
daemonset.apps/kube-proxy patched

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20877;&#27425;&#26597;&#30475;mode&#27169;&#24335;</span>
[root@k8s-master01 ~]# curl 127.0.0.1:10249/proxyMode
ipvs
</pre>
</div>
</div>
</div>
<div id="outline-container-h:739033d5-1c6a-4b43-b750-378cb34ae156" class="outline-3">
<h3 id="h:739033d5-1c6a-4b43-b750-378cb34ae156">注意事项</h3>
<div class="outline-text-3" id="text-h:739033d5-1c6a-4b43-b750-378cb34ae156">
<p>
注意：kubeadm安装的集群，证书有效期默认是一年。master节点的kube-apiserver、kube-scheduler、kube-controller-manager、etcd都是以容器运行的。可以通过kubectl get po -n kube-system查看。
</p>

<p>
启动和二进制不同的是，kubelet的配置文件在/etc/sysconfig/kubelet和/var/lib/kubelet/config.yaml
</p>

<p>
其他组件的配置文件在/etc/Kubernetes/manifests目录下，比如kube-apiserver.yaml，该yaml文件更改后，kubelet会自动刷新配置，也就是会重启pod。不能再次创建该文件。如果不想等可重启 kubelet
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl restart kubelet
</pre>
</div>

<p>
kube-proxy的配置在kube-system命名空间下的configmap中，可以通过
</p>

<div class="org-src-container">
<pre class="src src-shell">kubectl edit cm kube-proxy -n kube-system
</pre>
</div>

<p>
进行更改，更改完成后，可以通过patch重启kube-proxy
</p>

<div class="org-src-container">
<pre class="src src-shell">kubectl patch daemonset kube-proxy -p <span style="color: #8b2252;">"{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"date\":\"`date +'%s'`\"}}}}}"</span> -n kube-system
</pre>
</div>

<p>
Kubeadm安装后，master节点默认不允许部署pod，可以通过以下方式打开：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;Taints&#65306;</span>
[root@k8s-master01 ~]# kubectl describe node -l node-role.kubernetes.io/master= | grep Taints
Taints:             node-role.kubernetes.io/master:NoSchedule
Taints:             node-role.kubernetes.io/master:NoSchedule
Taints:       node-role.kubernetes.io/master:NoSchedule

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;Taint&#65306;</span>
[root@k8s-master01 ~]# kubectl taint node -l node-role.kubernetes.io/master node-role.kubernetes.io/master:NoSchedule-
node/k8s-master01 untainted
node/k8s-master02 untainted
node/k8s-master03 untainted

[root@k8s-master01 ~]# kubectl describe node -l node-role.kubernetes.io/master= | grep Taints
Taints:       &lt;none&gt;
Taints:       &lt;none&gt;
Taints:       &lt;none&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a4b8287b-e1f0-4a76-8651-121b261a6273" class="outline-3">
<h3 id="h:a4b8287b-e1f0-4a76-8651-121b261a6273">集群检测</h3>
<div class="outline-text-3" id="text-h:a4b8287b-e1f0-4a76-8651-121b261a6273">
<div class="org-src-container">
<pre class="src src-shell">kubectl get po --al-namespaces

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#30417;&#25511;&#25968;&#25454;</span>
kubectl top po -n kube-system

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32593;&#32476;</span>
kubectl get svc  <span style="color: #b22222;"># </span><span style="color: #b22222;">k8s&#30340;svc&#19968;&#33324;&#20026; servic ip &#27573;&#30340;&#31532;&#19968;&#20010; ip</span>
kubectl get svc -n kube-system <span style="color: #b22222;"># </span><span style="color: #b22222;">coredns &#19968;&#33324;&#20026; cluster ip &#30340;&#31532; 10 &#20010; ip</span>

telnet 10.96.0.1 443
telnet 10.96.0.10 53

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#39564;&#35777;&#36328;&#26381;&#21153;&#22120;&#35775;&#38382; pod &#26159;&#21542;&#36890;</span>
kubectl get po --all-namespaces -owide

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#28982;&#21518;&#20854;&#20182;&#33410;&#28857;&#21435;&#35775;&#38382;</span>
ping 172.168.32.130

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#39564;&#35777;pod&#20043;&#38388;&#26159;&#21542;&#36890;</span>
kubectl get po --all-namespaces -owide
kubectl exec -it calico-node-qxs56 -n kube-system -- sh <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36827;&#20837;&#23481;&#22120;&#20869;&#35775;&#38382;</span>
ping 172.168.32.130

<span style="color: #b22222;"># </span><span style="color: #b22222;">dashboard</span>
kubectl get po -n kubernetes-dashboard
kubectl get svc -n kubernetes-dashboard

kubectl edit svc  kubernetes-dashboard -n kubernetes-dashboard
<span style="color: #483d8b;">type</span>: NodePort <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#20026; NodePort</span>
kubectl get po -n kubernetes-dashboard
https://192.168.0.107:32534 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27983;&#35272;&#22120;&#35775;&#38382;</span>


</pre>
</div>
</div>
</div>
<div id="outline-container-h:e95f990c-63ec-4d6e-95b7-4025a17487ca" class="outline-3">
<h3 id="h:e95f990c-63ec-4d6e-95b7-4025a17487ca">删除集群</h3>
<div class="outline-text-3" id="text-h:e95f990c-63ec-4d6e-95b7-4025a17487ca">
<div class="org-src-container">
<pre class="src src-shell">systemctl stop containerd kubelet
rm -fr /etc/kubernetes
rm -f /var/lib/containerd /var/lib/kubelet
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a6a25d02-e454-4664-a352-2d4452b0af06" class="outline-3">
<h3 id="h:a6a25d02-e454-4664-a352-2d4452b0af06">kubeadm 证书更新</h3>
<div class="outline-text-3" id="text-h:a6a25d02-e454-4664-a352-2d4452b0af06">
<p>
<a href="https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-certs/">https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm-certs/</a>
</p>

<p>
使用kubeadm创建的集群默认证书有效期为1年，所以要及时更新证书。或者重新编译源码来设置证书时间
</p>

<p>
生产环境推荐一年更新一次 kubernetes 版本。
</p>
</div>
<div id="outline-container-h:54aaad72-6794-4141-afda-04d8f36e4f88" class="outline-4">
<h4 id="h:54aaad72-6794-4141-afda-04d8f36e4f88">更新一年</h4>
<div class="outline-text-4" id="text-h:54aaad72-6794-4141-afda-04d8f36e4f88">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#26597; kubeadm &#31649;&#29702;&#30340;&#26412;&#22320; PKI &#20013;&#35777;&#20070;&#30340;&#21040;&#26399;&#26102;&#38388;</span>
kubeadm certs check-expiration 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#35777;&#20070;&#36807;&#26399;&#26102;&#38388;</span>
kubeadm alpha certs check-expiration

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26356;&#26032;&#35777;&#20070;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#38598;&#32676;&#37197;&#32622;</span>
kubectl -n kube-system get cm kubeadm-config -o yaml &gt; kubeadm-config.yaml
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26356;&#26032;&#35777;&#20070;</span>
kubeadm alpha certs renew all

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20877;&#27425;&#26816;&#26597;&#35777;&#20070;</span>
kubeadm alpha certs check-expiration

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551; kubelet &#26381;&#21153;</span>
systemctl restart kubelet
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26356;&#26032;&#37197;&#32622;</span>
cp /etc/kubernetes/admin.conf ~/.kube/config
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#39564;&#35777;&#38598;&#32676;</span>
kubectl get node
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4d59fc88-cb69-4cb8-b2cc-a523b99051e2" class="outline-4">
<h4 id="h:4d59fc88-cb69-4cb8-b2cc-a523b99051e2">更新为 99 年</h4>
<div class="outline-text-4" id="text-h:4d59fc88-cb69-4cb8-b2cc-a523b99051e2">
<p>
修改源码
</p>

<div class="org-src-container">
<pre class="src src-shell">kubeadm version
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#19979;&#36733;&#28304;&#30721;&#65292;&#20999;&#25442;&#38598;&#32676;&#19968;&#33268;&#30340;&#29256;&#26412;</span>
git clone https://gitee.com/mirrors/kubernetes.git 
git checkout v1.26.0
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37325;&#26032;&#32534;&#35793;</span>
docker run -it --rm -v <span style="color: #ff00ff;">`pwd`</span>:/go/src/ registry.cn-beijing.aliyuncs.com/dotbalo/golang:kubeadm bash
<span style="color: #483d8b;">cd</span> /go/src
go env -w <span style="color: #a0522d;">GOPROXY</span>=https://goproxy.cn,direct
go env -w <span style="color: #a0522d;">GOSUMDB</span>=off
grep <span style="color: #8b2252;">"365"</span> cmd/kubeadm/app/constants/constants.go
sed -i <span style="color: #8b2252;">'s@365@365 * 100@g'</span> cmd/kubeadm/app/constants/constants.go
grep <span style="color: #8b2252;">'365'</span>  cmd/kubeadm/app/constants/constants.go
mkdir -p _output/
chmod 777 -R _output/
make <span style="color: #a0522d;">WHAT</span>=cmd/kubeadm
cp _output/bin/kubeadm ./kubeadm

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26356;&#26032;&#35777;&#20070;&#65292;&#21508;&#20010; mater &#33410;&#28857;&#25805;&#20316;</span>
cp ./kubeadm /opt/
/opt/kubeadm verson
/opt/kubeadm certs renew all
kubeadm certs check-expiration
systemctl restart kubelet
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:427eaf49-db05-4a2f-a3e7-690ac9e11f0b" class="outline-2">
<h2 id="h:427eaf49-db05-4a2f-a3e7-690ac9e11f0b">参考</h2>
<div class="outline-text-2" id="text-h:427eaf49-db05-4a2f-a3e7-690ac9e11f0b">
<ul class="org-ul">
<li><a href="https://mp.weixin.qq.com/s/jyvZyNs00b2x-Vp2PT1GbQ">领导让我部署一套Kubernetes集群，我咔咔咔给他搞定（1.32无坑版）</a></li>
</ul>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
