<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kubernetes: Gitlab</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/font.css"/>
<link rel="stylesheet" type="text/css" href="/static/drollery.e825b870.css"/>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
</head>
<body>
<header id="preamble" class="status">
<header class="{className}" data-astro-cid-3ef6ksr2>
  <div class=header-branding data-astro-cid-g2lrb5xm>
      <span class=header-text data-astro-cid-g2lrb5xm>
          <span class=dropcap data-astro-cid-g2lrb5xm aria-hidden=true>
              <span class=actual data-astro-cid-g2lrb5xm>J</span>
              <span class=rest data-astro-cid-g2lrb5xm>asper Hsu</span>
              <span class=period data-astro-cid-g2lrb5xm>.</span>
          </span>
          <span class=sr-only data-astro-cid-g2lrb5xm>Drollery</span>
      </span>
      <img alt="Medieval drollery of a knight on a horse" class=spring decoding=async height=250 loading=lazy src=/images/knight-horse.a96eee7d_Z1WCOYs.webp width=68 data-astro-cid-g2lrb5xm>
  </div>

  <nav data-astro-cid-pux6a34n>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/jcodelog.html class=nobracket data-astro-cid-pux6a34n>技术</a>
      <span class=flower2 data-astro-cid-pux6a34n>K</span>
      <a href=/reading/index.html class=nobracket data-astro-cid-pux6a34n>阅读</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
      <a href=/lisp/jasper-emacs.html class=nobracket data-astro-cid-pux6a34n>我的Emacs配置</a>
      <span class=flower2 data-astro-cid-pux6a34n>L</span>
      <a href=/link/index.html class=nobracket data-astro-cid-pux6a34n>友链</a>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/about.html class=nobracket data-astro-cid-pux6a34n>关于</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
  </nav>


  <div class="container" data-astro-cid-3ef6ksr2>
    <p class="info" data-astro-cid-3ef6ksr2>
              🏆 欢迎来到本站：
              <a href="https://xuchangwei.com/">https://xuchangwei.com/</a>。
              <strong>希望这里有你感兴趣的内容</strong>。
            </p>
  </div>
  <div id=borderArtWrapper class="tt1" data-astro-cid-5hce7sga data-turbo-permanent>
      <script>
          var man, shakeCount = 0, noSound = new Audio("/audio/effects/no.m4a"), screamSound = new Audio("/audio/effects/scream.m4a");
          function animateManShakeHandler() {
              man.removeEventListener("animationend", animateManShakeHandler, !1),
              shakeCount += 1,
              man.classList.remove("shakeMan")
          }
          function animateManFallHandler() {
              man.removeEventListener("animationend", animateManFallHandler, !1),
              man.classList.add("hide")
          }
          function animateMan() {
              man = man ?? document.getElementById("borderMan"),
              3 === shakeCount ? (man.classList.add("fallMan"),
              screamSound.play(),
              man.addEventListener("animationend", animateManFallHandler, !1)) : (man.classList.add("shakeMan"),
              noSound.play(),
              man.addEventListener("animationend", animateManShakeHandler, !1))
          }
      </script>
      <div class=borderArt data-astro-cid-5dda5nwp id=articleBorder>
          <img alt="flowery border with man falling" decoding=async height=620 loading=lazy src=/images/border-vines-no-man.b7d246cc_DRxSe.webp width=909 class=border data-astro-cid-5dda5nwp>
          <div class=fallWrapper data-astro-cid-5dda5nwp>
              <img alt="flowery border with man falling" decoding=async height=292 loading=lazy src=/images/man-no-vines.247a3187_Z2ioXNM.webp width=98 class=man data-astro-cid-5dda5nwp id=borderMan onclick=animateMan()>
          </div>
      </div>
  </div>
</header>
</header>
<main class="container" id="content" class="content">
<header>
<h1 class="title">Kubernetes: Gitlab</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org8438e1b">gitlab</a>
<ul>
<li><a href="#orgec783a2">组件介绍</a>
<ul>
<li><a href="#org3588af4">gitlab网络架构</a>
<ul>
<li><a href="#orge73b99a">组件（14.2版本）</a></li>
<li><a href="#org3bb8390">组件说明</a></li>
<li><a href="#org8cd0e6b">gitlab中请求类型</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org643b69d">需求</a>
<ul>
<li><a href="#org9c2f805">gitlab 版本对照</a></li>
</ul>
</li>
<li><a href="#orge331be8">gitlab chart部署介绍</a>
<ul>
<li><a href="#org24a79ca">样例gitlab</a></li>
<li><a href="#org7f08b73">样例gitlab-runner</a></li>
</ul>
</li>
<li><a href="#orgddff42f">测试环境</a>
<ul>
<li><a href="#orga7c211c">提前准备</a>
<ul>
<li><a href="#org3024620">持久卷</a></li>
<li><a href="#org1d21973">域名证书</a></li>
<li><a href="#org124ebf9">启动外部对象存储</a></li>
<li><a href="#org7cf7412">服务连接密码</a></li>
<li><a href="#org9e9a66a">负载均衡ingress slb</a></li>
<li><a href="#org79454ad">制作私有镜像</a></li>
<li><a href="#org1d029ae">脚本</a></li>
</ul>
</li>
<li><a href="#orgea30f3e">部署</a>
<ul>
<li><a href="#org303b20a">helm发布</a></li>
<li><a href="#org82f7c4c">卸载</a></li>
<li><a href="#orga34a1e5">破解</a></li>
<li><a href="#org960275d">部署脚本</a></li>
</ul>
</li>
<li><a href="#org8c47928">性能测试</a>
<ul>
<li><a href="#org06a9a82">准备数据环境</a></li>
<li><a href="#orgcd5c5c7">运行测试</a></li>
<li><a href="#org803387a">性能测试结果</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org7a85804">生产环境</a>
<ul>
<li><a href="#orgfca9a23">前期准备-脚本</a></li>
<li><a href="#org99e8cc0">部署脚本</a></li>
</ul>
</li>
<li><a href="#org4249c15">升级之</a>
<ul>
<li><a href="#org4cfb385">差异比较</a></li>
<li><a href="#orgec8b417">配置</a></li>
<li><a href="#org119f3fa">迭代升级</a>
<ul>
<li><a href="#org50bbb93">升级前检查及备份</a></li>
<li><a href="#org61d561e">使用外置数据库</a></li>
<li><a href="#org29f2107">准备生产数据</a></li>
<li><a href="#orge6e504c">依次升级对应版本安</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org982adff">gitlab备份恢复</a>
<ul>
<li><a href="#org29cdc3d">备份</a>
<ul>
<li><a href="#org8bf3d4e">创建备份</a></li>
<li><a href="#orga5be799">备份秘密</a></li>
</ul>
</li>
<li><a href="#org8d309a6">恢复</a>
<ul>
<li><a href="#orgd9ac8bb">恢复 Rails 的secrets</a></li>
<li><a href="#org32ec508">重新启动 Pod</a></li>
<li><a href="#org63552c2">恢复备份文件</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org5814d5e">迁移</a>
<ul>
<li><a href="#org41a0b8d">从 Helm Chart 迁移到 Linux 包</a></li>
</ul>
</li>
<li><a href="#orgb635bd6">附录</a>
<ul>
<li><a href="#orgbd95194">多版本镜像上传</a></li>
<li><a href="#orgad5a58b">多版本chart-values</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<section id="outline-container-org8438e1b" class="outline-2">
<h2 id="org8438e1b">gitlab</h2>
<div class="outline-text-2" id="text-org8438e1b">
<p>
<a href="https://docs.gitlab.com/charts/">gitlab-chart-kubernetes</a>
采用helm chart方式部署
</p>
</div>
<div id="outline-container-orgec783a2" class="outline-3">
<h3 id="orgec783a2">组件介绍</h3>
<div class="outline-text-3" id="text-orgec783a2">
<ul class="org-ul">
<li>Core GitLab components:
<ul class="org-ul">
<li><a href="https://docs.gitlab.com/charts/charts/nginx/index.html">NGINX Ingress</a> web访问入口</li>
<li><a href="https://docs.gitlab.com/charts/charts/registry/index.html">Registry</a>  代码库，可以是硬盘或 分布式文件系统</li>
<li>GitLab/<a href="https://docs.gitlab.com/charts/charts/gitlab/gitaly/index.html">Gitaly</a> 后台服务，提供对 Git 存储库的高级 RPC 访问的服务</li>
<li>GitLab/<a href="https://docs.gitlab.com/charts/charts/gitlab/gitlab-exporter/index.html">GitLab Exporter</a></li>
<li>GitLab/<a href="https://docs.gitlab.com/charts/charts/gitlab/gitlab-grafana/index.html">GitLab Grafana</a> 默认不安装</li>
<li>GitLab/<a href="https://docs.gitlab.com/charts/charts/gitlab/gitlab-pages/index.html">GitLab Pages</a> 默认关闭，类似github page</li>
<li>GitLab/<a href="https://docs.gitlab.com/charts/charts/gitlab/gitlab-shell/index.html">GitLab Shell</a> 通过 SSH 提供命令处理</li>
<li>GitLab/<a href="https://docs.gitlab.com/charts/charts/gitlab/mailroom/index.html">Mailroom</a>  邮件，默认关闭</li>
<li>GitLab/<a href="https://docs.gitlab.com/charts/charts/gitlab/migrations/index.html">Migrations</a> 迁移服务，默认关闭</li>
<li>GitLab/<a href="https://docs.gitlab.com/charts/charts/gitlab/sidekiq/index.html">Sidekiq</a> 后台服务，从redis队列中提取作业来处理</li>
<li>GitLab/<a href="https://docs.gitlab.com/charts/charts/gitlab/task-runner/index.html">Task Runner</a> 内部任务管理，包括备份</li>
<li>GitLab/<a href="https://docs.gitlab.com/charts/charts/gitlab/webservice/index.html">Webservice</a> 处理web页面和api请求，puma包含webservice（rails
应用）和workhorse（代理）</li>
</ul></li>
</ul>

<ul class="org-ul">
<li>Optional dependencies:
<ul class="org-ul">
<li><a href="https://artifacthub.io/packages/helm/bitnami/postgresql">PostgreSQL</a> 默认安装</li>
<li><a href="https://artifacthub.io/packages/helm/bitnami/redis">Redis</a>  默认安装单点</li>
<li><a href="https://docs.gitlab.com/charts/charts/minio/index.html">MinIO</a>  默认安装，分布式文件系统，兼容s3协议。Glusterfs团队开发</li>
</ul></li>

<li>Optional additions:
<ul class="org-ul">
<li><a href="https://artifacthub.io/packages/helm/prometheus-community/prometheus">Prometheus</a> 默认安装</li>
<li><a href="https://artifacthub.io/packages/helm/grafana/grafana">Grafana</a> 默认关闭</li>
<li><a href="https://docs.gitlab.com/runner/install/kubernetes.html#running-docker-in-docker-containers-with-gitlab-runner">Unprivileged GitLab Runner</a> using the Kubernetes executor</li>
<li>Automatically provisioned SSL via <a href="https://letsencrypt.org/">Let's Encrypt</a>, using <a href="https://www.jetstack.io/">Jetstack</a>'s
<a href="https://cert-manager.io/docs/">cert-manager</a></li>
<li>GitLab/<a href="https://docs.gitlab.com/charts/charts/gitlab/praefect/index.html">Praefect</a> 默认关闭，管理gitaly集群。目前在开发阶段，生产使用
需特殊处理。</li>
<li>GitLab/<a href="https://docs.gitlab.com/charts/charts/gitlab/kas/index.html">Kubernetes Agent Server (KAS)</a> 代理服务器 (KAS) 是一个
GitLab 后端服务，专门用于管理Kubernetes 代理.</li>
</ul></li>
</ul>

<p>
<a href="https://docs.gitlab.com/charts/architecture/goals.html#helm-charts">chart的层次结构</a>
</p>
</div>
<div id="outline-container-org3588af4" class="outline-4">
<h4 id="org3588af4">gitlab网络架构</h4>
<div class="outline-text-4" id="text-org3588af4">
<p>
<a href="https://docs.gitlab.com/charts/architecture/goals.html#helm-charts">gitlab网络架构</a>
</p>

<p>
简化架构图
</p>


<figure id="orgeb60bc6">
<img src="images/architecture_simplified.png" alt="architecture_simplified.png" width="60%">

</figure>
</div>
<div id="outline-container-orge73b99a" class="outline-5">
<h5 id="orge73b99a">组件（14.2版本）</h5>
<div class="outline-text-5" id="text-orge73b99a">
<p>
元件图例
</p>
<ul class="org-ul">
<li>✅ - 默认安装</li>
<li>⚙ - 需要额外配置</li>
<li>⤓ - 需要手动安装</li>
<li>❌ - 不支持或没有说明</li>
<li>不适用 - 不适用</li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Component</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left"><a href="https://docs.gitlab.com/14.2/omnibus/">Omnibus GitLab</a>(rpm)</th>
<th scope="col" class="org-left"><a href="https://docs.gitlab.com/14.2/charts/">GitLab chart</a></th>
<th scope="col" class="org-left"><a href="https://about.gitlab.com/install/ce-or-ee/">CE/EE</a></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#certificate-management">Certificate Management</a></td>
<td class="org-left">TLS证书, Let's Encrypt</td>
<td class="org-left">✅</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#consul">Consul</a></td>
<td class="org-left">数据库节点发现、故障转移</td>
<td class="org-left">⚙</td>
<td class="org-left">❌</td>
<td class="org-left">EE Only</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#database-migrations">Database Migrations</a></td>
<td class="org-left">数据库迁移</td>
<td class="org-left">✅</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#elasticsearch">Elasticsearch</a></td>
<td class="org-left">GitLab 中的搜索</td>
<td class="org-left">⤓</td>
<td class="org-left">⤓</td>
<td class="org-left">EE Only</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#gitaly">Gitaly</a></td>
<td class="org-left">Git RPC服务，用于处理GitLab发出的所有Git调用</td>
<td class="org-left">✅</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#gitlab-exporter">GitLab Exporter</a></td>
<td class="org-left">生成GitLab 指标</td>
<td class="org-left">✅</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#gitlab-geo">GitLab Geo Node</a></td>
<td class="org-left">地理分布的GitLab节点</td>
<td class="org-left">⚙</td>
<td class="org-left">❌</td>
<td class="org-left">EE Only</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#gitlab-kubernetes-agent">GitLab Kubernetes Agent</a></td>
<td class="org-left">以云原生方式集成 Kubernetes 集群</td>
<td class="org-left">⚙</td>
<td class="org-left">⚙</td>
<td class="org-left">EE Only</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#gitlab-pages">GitLab Pages</a></td>
<td class="org-left">gitlab静态网站</td>
<td class="org-left">⚙</td>
<td class="org-left">❌</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#alertmanager">GitLab self-monitoring: Alertmanager</a></td>
<td class="org-left">Prometheus报警</td>
<td class="org-left">⚙</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#grafana">GitLab self-monitoring: Grafana</a></td>
<td class="org-left">指标仪表板</td>
<td class="org-left">✅</td>
<td class="org-left">⚙</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#jaeger">GitLab self-monitoring: Jaeger</a></td>
<td class="org-left">GitLab链路跟踪</td>
<td class="org-left">❌</td>
<td class="org-left">⚙</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#prometheus">GitLab self-monitoring: Prometheus</a></td>
<td class="org-left">时间序列数据库、指标收集和查询服务</td>
<td class="org-left">✅</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#sentry">GitLab self-monitoring: Sentry</a></td>
<td class="org-left">跟踪 GitLab 实例生成的错误</td>
<td class="org-left">⤓</td>
<td class="org-left">⤓</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#gitlab-shell">GitLab Shell</a></td>
<td class="org-left">处理gitSSH 会话</td>
<td class="org-left">✅</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#gitlab-workhorse">GitLab Workhorse</a></td>
<td class="org-left">智能反向代理，处理大型 HTTP 请求</td>
<td class="org-left">✅</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#inbound-email">Inbound email (SMTP)</a></td>
<td class="org-left">接收消息以更新问题</td>
<td class="org-left">⤓</td>
<td class="org-left">⚙</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#jaeger">Jaeger integration</a></td>
<td class="org-left">已部署应用程序的分布式跟踪</td>
<td class="org-left">⤓</td>
<td class="org-left">⤓</td>
<td class="org-left">EE Only</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#ldap-authentication">LDAP Authentication</a></td>
<td class="org-left">根据集中的 LDAP 目录对用户进行身份验证</td>
<td class="org-left">⤓</td>
<td class="org-left">⤓</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#mattermost">Mattermost</a></td>
<td class="org-left">开源 Slack 替代方案</td>
<td class="org-left">⚙</td>
<td class="org-left">⤓</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#minio">MinIO</a></td>
<td class="org-left">对象存储服务</td>
<td class="org-left">⤓</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#nginx">NGINX</a></td>
<td class="org-left">将请求路由到适当的组件，SSL</td>
<td class="org-left">✅</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#node-exporter">Node Exporter</a></td>
<td class="org-left">节点系统指标</td>
<td class="org-left">✅</td>
<td class="org-left">N/A</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#outbound-email">Outbound email (SMTP)</a></td>
<td class="org-left">向用户发送电子邮件</td>
<td class="org-left">⤓</td>
<td class="org-left">⚙</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#patroni">Patroni</a></td>
<td class="org-left">管理 PostgreSQL HA 集群领导者选择和复制</td>
<td class="org-left">⚙</td>
<td class="org-left">❌</td>
<td class="org-left">EE Only</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#pgbouncer-exporter">PgBouncer Exporter</a></td>
<td class="org-left">PgBouncer指标收集</td>
<td class="org-left">⚙</td>
<td class="org-left">❌</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#pgbouncer">PgBouncer</a></td>
<td class="org-left">数据库连接池、故障转移</td>
<td class="org-left">⚙</td>
<td class="org-left">❌</td>
<td class="org-left">EE Only</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#postgresql-exporter">PostgreSQL Exporter</a></td>
<td class="org-left">PostgreSQL指标收集</td>
<td class="org-left">✅</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#postgresql">PostgreSQL</a></td>
<td class="org-left">Database</td>
<td class="org-left">✅</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#praefect">Praefect</a></td>
<td class="org-left">Git 客户端和 Gitaly 存储节点之间的透明代理</td>
<td class="org-left">✅</td>
<td class="org-left">⚙</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#puma">Puma (GitLab Rails)</a></td>
<td class="org-left">处理对 Web 界面和 API 的请求</td>
<td class="org-left">✅</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#redis-exporter">Redis Exporter</a></td>
<td class="org-left">Redis指标收集</td>
<td class="org-left">✅</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#redis">Redis</a></td>
<td class="org-left">缓存服务</td>
<td class="org-left">✅</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#registry">Registry</a></td>
<td class="org-left">容器镜像库</td>
<td class="org-left">⚙</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#gitlab-runner">Runner</a></td>
<td class="org-left">执行 GitLab CI/CD 作业</td>
<td class="org-left">⤓</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#sentry">Sentry integration</a></td>
<td class="org-left">已部署应用程序的错误跟踪</td>
<td class="org-left">⤓</td>
<td class="org-left">⤓</td>
<td class="org-left">CE &amp; EE</td>
</tr>

<tr>
<td class="org-left"><a href="https://docs.gitlab.com/14.2/ee/development/architecture.html#sidekiq">Sidekiq</a></td>
<td class="org-left">后台作业处理器</td>
<td class="org-left">✅</td>
<td class="org-left">✅</td>
<td class="org-left">CE &amp; EE</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org3bb8390" class="outline-5">
<h5 id="org3bb8390">组件说明</h5>
<div class="outline-text-5" id="text-org3bb8390">
<div class="org-src-container">
<pre class="src src-bash">gitlab:
  <span style="color: #b22222;">## </span><span style="color: #b22222;">https://docs.gitlab.com/charts/charts/gitlab/task-runner</span>
  - task-runner
  Task Runner Pod &#29992;&#20110;&#22312; GitLab &#24212;&#29992;&#31243;&#24207;&#20013;&#25191;&#34892;&#23450;&#26399;&#20869;&#21153;&#31649;&#29702;&#20219;&#21153;&#12290;&#36825;&#20123;&#20219;&#21153;&#21253;&#25324;&#22791;&#20221;&#12289;Sidekiq &#32500;&#25252;&#21644; Rake &#20219;&#21153;
  &#38236;&#20687;registry.gitlab.com/gitlab-org/build/cng/gitlab-toolbox-ee:v14.2.0
  <span style="color: #b22222;">## </span><span style="color: #b22222;">https://docs.gitlab.com/charts/charts/gitlab/migrations</span>
  - migrations:
  &#25968;&#25454;&#36801;&#31227;&#65292;&#19982;task-runner&#20351;&#29992;&#21516;&#19968;&#20010;&#38236;&#20687;

  <span style="color: #b22222;">## </span><span style="color: #b22222;">https://docs.gitlab.com/charts/charts/gitlab/webservice</span>
  - webservice:
  Puma(GitLab Rails)&#30340;Web&#26381;&#21153;&#22120;&#30001;2&#20010;&#23481;&#22120;&#32452;&#25104;
  &#38236;&#20687;registry.gitlab.com/gitlab-org/build/cng/gitlab-webservice-ee:v14.2.0
  &#38236;&#20687;registry.gitlab.com/gitlab-org/build/cng/gitlab-workhorse-ee:v14.2.0

  <span style="color: #b22222;">## </span><span style="color: #b22222;">https://docs.gitlab.com/charts/charts/gitlab/sidekiq</span>
  - sidekiq:
  &#21518;&#21488;&#26381;&#21153;&#65292;&#20174;redis&#38431;&#21015;&#20013;&#25552;&#21462;&#20316;&#19994;&#26469;&#22788;&#29702;
  &#38236;&#20687;registry.gitlab.com/gitlab-org/build/cng/gitlab-sidekiq-ee:v14.2.0

  <span style="color: #b22222;">## </span><span style="color: #b22222;">https://docs.gitlab.com/charts/charts/gitlab/gitaly</span>
  - gitaly:
  Git RPC&#26381;&#21153;&#65292;&#29992;&#20110;&#22788;&#29702;GitLab&#21457;&#20986;&#30340;&#25152;&#26377;Git&#35843;&#29992;
  &#38236;&#20687;registry.gitlab.com/gitlab-org/build/cng/gitaly:v14.2.0

  <span style="color: #b22222;">## </span><span style="color: #b22222;">https://docs.gitlab.com/charts/charts/gitlab/gitlab-shell</span>
  - gitlab-shell:
  git ssh&#25903;&#25345;
  image.repository=registry.gitlab.com/gitlab-org/build/cng/gitlab-shell:v13.19.1

  <span style="color: #b22222;">## </span><span style="color: #b22222;">https://docs.gitlab.com/charts/charts/gitlab/gitlab-grafana</span>
  - gitlab-grafana:

</pre>
</div>
</div>
</div>
<div id="outline-container-org8cd0e6b" class="outline-5">
<h5 id="org8cd0e6b">gitlab中请求类型</h5>
<div class="outline-text-5" id="text-org8cd0e6b">
<p>
GitLab 为最终用户提供了两个“接口”来访问服务：
</p>
<ul class="org-ul">
<li>Web HTTP 请求（查看 UI/API）</li>
<li>Git HTTP/SSH 请求（推送/拉取 Git 数据）</li>
</ul>
</div>
<ul class="org-ul">
<li><a id="orge32826a"></a>Web请求(80/443)<br>
<div class="outline-text-6" id="text-orge32826a">

<figure id="org5001f97">
<img src="images/gitlab-web-request.jpg" alt="gitlab-web-request.jpg" width="60%">

</figure>
</div>
</li>
<li><a id="orgeba55be"></a>SSH请求(22)<br>
<div class="outline-text-6" id="text-orgeba55be">

<figure id="org836c5eb">
<img src="images/gitlab-SSH-request.jpg" alt="gitlab-SSH-request.jpg" width="60%">

</figure>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org643b69d" class="outline-3">
<h3 id="org643b69d">需求</h3>
<div class="outline-text-3" id="text-org643b69d">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">服务</td>
<td class="org-right">版本</td>
<td class="org-left">备注</td>
</tr>

<tr>
<td class="org-left">k8s</td>
<td class="org-right">1.16+</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">helm</td>
<td class="org-right">v3</td>
<td class="org-left">3.3.1 或更高版本</td>
</tr>

<tr>
<td class="org-left">postgresql</td>
<td class="org-right">12</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
<div id="outline-container-org9c2f805" class="outline-4">
<h4 id="org9c2f805"><a href="https://gitlab.com/gitlab-org/charts/gitlab/-/blob/master/doc/installation/version_mappings.md">gitlab 版本对照</a></h4>
<div class="outline-text-4" id="text-org9c2f805">
<p>
gitlab 14.1.0 helm3
</p>

<p>
持久化存储
</p>

<p>
以下应用程序需要持久存储来维护状态。
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">&#20197;&#19979;&#24212;&#29992;&#31243;&#24207;&#38656;&#35201;&#25345;&#20037;&#23384;&#20648;&#26469;&#32500;&#25252;&#29366;&#24577;&#12290;

Gitaly&#65288;&#20445;&#30041; Git &#23384;&#20648;&#24211;&#65289;
PostgreSQL&#65288;&#20445;&#30041; GitLab &#25968;&#25454;&#24211;&#25968;&#25454;&#65289;
Redis&#65288;&#20445;&#30041; GitLab &#20316;&#19994;&#25968;&#25454;&#65289;
MinIO&#65288;&#25345;&#20037;&#21270;&#23545;&#35937;&#23384;&#20648;&#25968;&#25454;&#65289;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orge331be8" class="outline-3">
<h3 id="orge331be8">gitlab chart部署介绍</h3>
<div class="outline-text-3" id="text-orge331be8">
<p>
官方参考：<a href="https://docs.gitlab.com/charts/installation/deployment.html">gitlab chart deploy</a>
</p>

<p>
性能测试：<a href="https://docs.gitlab.com/ee/administration/reference_architectures/">架构参考</a>
</p>
</div>
<div id="outline-container-org24a79ca" class="outline-4">
<h4 id="org24a79ca">样例gitlab</h4>
<div class="outline-text-4" id="text-org24a79ca">
<div class="org-src-container">
<pre class="src src-bash">helm upgrade --install  -n gitlab-test-xcw  gitlab-test-xcw gitlab/gitlab <span style="color: #8b2252;">\</span>
     --timeout 600s <span style="color: #8b2252;">\</span>
     --version=5.2.1 <span style="color: #8b2252;">\</span>
     --dry-run <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#22495;&#21517;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/installation/deployment.html#networking-and-dns`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#20027;&#26426;&#22495;&#21517;https://docs.gitlab.com/charts/charts/globals#configure-host-settings`</span> <span style="color: #8b2252;">\</span>
     --set global.hosts.domain=example.com <span style="color: #8b2252;">\</span>
     --set global.hosts.externalIP=10.22.0.71 <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#25345;&#20037;&#23384;&#20648;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/installation/storage.html`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#21160;&#24577;&#21367; kubectl apply -f gitlab_storageclass.yaml`</span> <span style="color: #8b2252;">\</span>
     --set gitlab.gitaly.persistence.storageClass=CUSTOM_STORAGE_CLASS_NAME <span style="color: #8b2252;">\</span>
     --set gitlab.gitaly.persistence.size=200Gi <span style="color: #8b2252;">\</span>
     --set gitlab.gitaly.persistence.accessMode=ReadWriteMany <span style="color: #8b2252;">\</span>
     --set postgresql.persistence.storageClass=CUSTOM_STORAGE_CLASS_NAME <span style="color: #8b2252;">\</span>
     --set postgresql.persistence.size=50Gi <span style="color: #8b2252;">\</span>
     --set postgresql.persistence.accessModes={ReadWriteMany} <span style="color: #8b2252;">\</span>
     --set redis.master.persistence.storageClass=CUSTOM_STORAGE_CLASS_NAME <span style="color: #8b2252;">\</span>
     --set redis.master.persistence.size=20Gi <span style="color: #8b2252;">\</span>
     --set redis.master.persistence.accessModes={ReadWriteMany} <span style="color: #8b2252;">\</span>
     --set minio.persistence.storageClass=CUSTOM_STORAGE_CLASS_NAME <span style="color: #8b2252;">\</span>
     --set minio.persistence.size=40Gi <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--tls&#35777;&#20070;&#31649;&#29702;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/installation/tls.html`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#23548;&#20837;&#36890;&#37197;&#22495;&#21517;&#35777;&#20070; https://docs.gitlab.com/charts/installation/tls.html#option-2-use-your-own-wildcard-certificate`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#kubectl --namespace=gitlab create secret tls &lt;tls-secret-name&gt; --cert=&lt;path/to-full-chain.crt&gt; --key=&lt;path/to.key&gt;`</span> <span style="color: #8b2252;">\</span>
     --set certmanager.install=false <span style="color: #8b2252;">\</span>
     --set global.ingress.configureCertmanager=false <span style="color: #8b2252;">\</span>
     --set global.ingress.tls.secretName=&lt;tls-secret-name&gt; <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#22806;&#37096;postgresql--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/installation/deployment.html#postgresql`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#23494;&#30721;&#21487;&#36890;&#36807;secret&#26041;&#24335;&#23548;&#20837;`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#kubectl -n gitlab create secret generic gitalb-postgresql-password --from-literal=postgresql-password=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64)`</span> <span style="color: #8b2252;">\</span>
     --set postgresql.install=false <span style="color: #8b2252;">\</span>
     --set global.psql.host=production.postgress.hostname.local <span style="color: #8b2252;">\</span>
     --set global.psql.username=<span style="color: #8b2252;">'gitlab'</span> <span style="color: #8b2252;">\</span>
     --set global.psql.password.secret=gitlab-postgresql-password <span style="color: #8b2252;">\</span>
     --set global.psql.password.key=postgres-password <span style="color: #8b2252;">\</span>
     --set global.psql.database=<span style="color: #8b2252;">'gitlabhq_production'</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#22806;&#37096;redis--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/charts/globals.html#configure-redis-settings`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#21487;&#36873;&#21333;&#28857;&#12289;&#21736;&#20853;&#12289;&#38598;&#32676;&#26041;&#24335;&#37096;&#32626;`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#kubectl create secret generic gitlab-redis-secret --from-literal=password=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64)`</span> <span style="color: #8b2252;">\</span>
     --set redis.install=false <span style="color: #8b2252;">\</span>
     --set global.redis.host=<span style="color: #8b2252;">'redis.example.com'</span> <span style="color: #8b2252;">\</span>
     --set global.redis.password.secret=gitlab-redis-secret <span style="color: #8b2252;">\</span>
     --set global.redis.password.key=<span style="color: #8b2252;">'password'</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#21551;&#21160;&#22806;&#37096;&#23545;&#35937;&#23384;&#20648;&#65292;&#19981;&#20351;&#29992;&#20869;&#37096;&#33258;&#24314;&#30340;minio&#20998;&#24067;&#24335;&#23384;&#20648;&#65292;&#38656;&#35201;&#25552;&#21069;&#29983;&#25104;&#36830;&#25509;&#23494;&#38053;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/advanced/external-object-storage/index.html`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#23436;&#25972;&#26679;&#20363; https://gitlab.com/gitlab-org/charts/gitlab/blob/master/examples/values-external-objectstorage.yaml`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#32479;&#19968;&#23384;&#20648;&#65292;https://docs.gitlab.com/charts/charts/globals.html#consolidated-object-storage`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#23384;&#20648;&#21551;&#21160;&#40664;&#35748;&#20540;https://docs.gitlab.com/12.10/charts/charts/globals.html#configure-minio-settings`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#gitlab&#21508;&#23384;&#20648;&#26742;&#36830;&#25509;&#26679;&#20363;&#65292;https://gitlab.com/gitlab-org/charts/gitlab/-/blob/master/examples/objectstorage/rails.s3.yaml`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#kubectl -n gitlab create secret generic gitlab-rails-storage --from-file=connection=rails.yaml`</span> <span style="color: #8b2252;">\</span>
     --set global.minio.enabled=false <span style="color: #8b2252;">\</span>
     --set global.appConfig.object_store.enabled=true <span style="color: #8b2252;">\</span>
     --set global.appConfig.object_store.connection.secret=gitlab-rails-storage <span style="color: #8b2252;">\</span>
     --set global.appConfig.object_store.connection.key=connection <span style="color: #8b2252;">\</span>
     --set global.appConfig.lfs.bucket=gitlab-lfs <span style="color: #8b2252;">\</span>
     --set global.appConfig.artifacts.bucket=gitlab-artifacts <span style="color: #8b2252;">\</span>
     --set global.appConfig.uploads.bucket=gitlab-uploads <span style="color: #8b2252;">\</span>
     --set global.appConfig.packages.bucket=gitlab-packages <span style="color: #8b2252;">\</span>
     --set global.appConfig.externalDiffs.enabled=true <span style="color: #8b2252;">\</span>
     --set global.appConfig.externalDiffs.bucket=gitlab-externaldiffs <span style="color: #8b2252;">\</span>
     --set global.appConfig.terraformState.enabled=true <span style="color: #8b2252;">\</span>
     --set global.appConfig.terraformState.bucket=gitlab-terraform <span style="color: #8b2252;">\</span>
     --set global.appConfig.pseudonymizer.bucket=gitlab-pseudonymizer <span style="color: #8b2252;">\</span>
     --set global.appConfig.dependencyProxy.enabled=true <span style="color: #8b2252;">\</span>
     --set global.appConfig.dependencyProxy.bucket=gitlab-dependencyproxy <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#docker&#38236;&#20687;&#24211;`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/advanced/external-object-storage/index.html#docker-registry-images`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#docker&#38236;&#20687;&#23384;&#20648;&#22320;&#22336;&#26679;&#20363; https://gitlab.com/gitlab-org/charts/gitlab/-/blob/master/examples/objectstorage/registry.s3.yaml`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#kubectl --namespace=gitlab create secret generic registry-storage --from-file=config=registry-storage.yaml`</span> <span style="color: #8b2252;">\</span>
     --set registry.storage.secret=registry-storage <span style="color: #8b2252;">\</span>
     --set registry.storage.key=config <span style="color: #8b2252;">\</span>
     --set global.registry.bucket=bucket-name <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#22791;&#20221;`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/advanced/external-object-storage/index.html#backups`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#22791;&#20221;&#23384;&#20648;&#37197;&#32622;&#26679;&#20363; https://docs.gitlab.com/charts/advanced/external-object-storage/index.html#backups-storage-example`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`kubectl --namespace=gitlab create secret generic storage-config --from-file=config=storage.config`</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.backups.bucket=gitlab-backup-storage <span style="color: #8b2252;">\</span>
     --set global.appConfig.backups.tmpBucket=gitlab-tmp-storage <span style="color: #8b2252;">\</span>
     --set gitlab.task-runner.backups.objectStorage.config.secret=storage-config <span style="color: #8b2252;">\</span>
     --set gitlab.task-runner.backups.objectStorage.config.key=config <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#30417;&#25511;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus#configuration`</span> <span style="color: #8b2252;">\</span>
     --set prometheus.server.persistentVolume.storageClass=CUSTOM_STORAGE_CLASS_NAME <span style="color: #8b2252;">\</span>
     --set prometheus.server.persistentVolume.accessModes={ReadWriteMany} <span style="color: #8b2252;">\</span>
     --set prometheus.server.persistentVolume.size=10Gi <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#22806;&#21457;&#30005;&#23376;&#37038;&#20214;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/installation/command-line-options.html#outgoing-email-configuration`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#kubectl --namespace=gitlab create secret generic gitlab-smtp-password --from-literal=password=yourpasswordhere`</span> <span style="color: #8b2252;">\</span>
     --set global.email.from=gitlab@example.com <span style="color: #8b2252;">\</span>
     --set global.email.display_name=<span style="color: #8b2252;">'GitLab'</span> <span style="color: #8b2252;">\</span>
     --set global.smtp.enabled=true <span style="color: #8b2252;">\</span>
     --set global.smtp.address=smtp.exmail.qq.com <span style="color: #8b2252;">\</span>
     --set global.smtp.tls=true <span style="color: #8b2252;">\</span>
     --set global.smtp.port=456 <span style="color: #8b2252;">\</span>
     --set global.smtp.user_name=<span style="color: #8b2252;">"gitlab@xxx.com"</span> <span style="color: #8b2252;">\</span>
     --set global.smtp.password.secret=<span style="color: #8b2252;">"gitlab-smtp-password"</span> <span style="color: #8b2252;">\</span>
     --set global.smtp.password.key=password <span style="color: #8b2252;">\</span>
     --set global.smtp.authentication=<span style="color: #8b2252;">"login"</span> <span style="color: #8b2252;">\</span>
     --set global.smtp.starttls_auto=true <span style="color: #8b2252;">\</span>
     --set global.smtp.pool=true <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--rbac--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/installation/deployment.html#rbac`</span> <span style="color: #8b2252;">\</span>
     --set certmanager.rbac.create=false <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--cpu&#21644;&#20869;&#23384;&#37197;&#32622;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#26368;&#23567;&#21270;&#37197;&#32622; https://docs.gitlab.com/charts/installation/deployment.html#cpu-and-ram-resource-requirements`</span> <span style="color: #8b2252;">\</span>
     --set gitlab-runner.install=false <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.replicaCount=3 <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.minAvailable=2 <span style="color: #8b2252;">\</span>
     --set nginx-ingress.defaultBackend.replicaCount=2 <span style="color: #8b2252;">\</span>
     --set rails.bootsnap.enabled=false <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.replicaCount=3 <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.replicaCount=3 <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#26102;&#21306;`</span> <span style="color: #8b2252;">\</span>
     --set global.time_zone=Asia/Shanghai <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--ldap&#37197;&#32622;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/charts/globals.html#ldap`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/ee/administration/auth/ldap/`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#kubectl --namespace=gitlab create secret generic gitlab-ldap-password --from-literal=password=yourpasswordhere`</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.label=<span style="color: #8b2252;">'LDAP'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.host=<span style="color: #8b2252;">'ldap.cici.com'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.port=<span style="color: #8b2252;">'389'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.uid=<span style="color: #8b2252;">'cn'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.bind_dn=<span style="color: #8b2252;">'cn=gitlab_admin\,ou=sys_admins\,dc=cici\,dc=com'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.base=<span style="color: #8b2252;">'ou=staff\,dc=cici\,dc=com'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.password.secret=<span style="color: #8b2252;">'gitlab-ldap'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.password.key=<span style="color: #8b2252;">'password'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.allow_username_or_email_login=true <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--omniauth&#35748;&#35777;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/charts/globals#omniauth`</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.omniauth.enabled=true <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#33258;&#21160;&#22791;&#20221;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/backup-restore/index.html`</span> <span style="color: #8b2252;">\</span>
     --set gitlab.task-runner.backups.cron.enabled=true <span style="color: #8b2252;">\</span>
     --set gitlab.task-runner.backups.cron.schedule=<span style="color: #8b2252;">'0 2 * * *'</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#19978;&#20256;&#38480;&#21046;--`</span> <span style="color: #8b2252;">\</span>
     --set global.ingress.proxyBodySize=10Gi <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--qos&#26381;&#21153;&#36136;&#37327;--`</span> <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.resources.requests.cpu=<span style="color: #8b2252;">'100m'</span> <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.resources.requests.memory=<span style="color: #8b2252;">'100Mi'</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--3k&#29992;&#25143;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#24320;&#21551;gitaly&#20195;&#29702;praefect&#65292;&#21551;&#21160;gitaly&#38598;&#32676;`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#praefect&#21551;&#21160;&#38480;&#21046;&#65292;&#23433;&#35013;&#21518;&#21019;&#24314;&#23545;&#24212;&#24211;https://docs.gitlab.com/charts/charts/gitlab/praefect/index.html`</span> <span style="color: #8b2252;">\</span>
     --set global.praefect.enabled=true <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#33258;&#23450;&#20041;&#38236;&#20687;--`</span> <span style="color: #8b2252;">\</span>
     --set global.kubectl.image.repository=registry.gitlab.com/gitlab-org/build/cng/kubectl <span style="color: #8b2252;">\</span>
     --set global.kubectl.image.tag=<span style="color: #8b2252;">"1.16.15"</span> <span style="color: #8b2252;">\</span>
     --set global.certificates.image.repository=registry.gitlab.com/gitlab-org/build/cng/alpine-certificates <span style="color: #8b2252;">\</span>
     --set global.certificates.image.tag=<span style="color: #8b2252;">"20191127-r2"</span> <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.image.repository=registry.gitlab.com/gitlab-org/cloud-native/mirror/images/ingress-nginx/controller <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.image.tag=<span style="color: #8b2252;">"v0.41.2"</span> <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.image.digest=<span style="color: #8b2252;">""</span> <span style="color: #8b2252;">\</span>
     --set nginx-ingress.defaultBackend.image.repository=registry.gitlab.com/gitlab-org/cloud-native/mirror/images/defaultbackend-amd64 <span style="color: #8b2252;">\</span>
     --set nginx-ingress.defaultBackend.image.tag=<span style="color: #8b2252;">"1.5"</span> <span style="color: #8b2252;">\</span>
     --set gitlab.task-runner.image.repository=registry.gitlab.com/gitlab-org/build/cng/gitlab-toolbox-ee <span style="color: #8b2252;">\</span>
     --set gitlab.task-runner.image.tag=<span style="color: #8b2252;">"v14.2.1"</span> <span style="color: #8b2252;">\</span>
     --set gitlab.migrations.image.repository=registry.gitlab.com/gitlab-org/build/cng/gitlab-toolbox-ee <span style="color: #8b2252;">\</span>
     --set gitlab.migrations.image.tag=<span style="color: #8b2252;">"v14.2.1"</span> <span style="color: #8b2252;">\</span>
     --set gitlab.gitaly.image.repository=registry.gitlab.com/gitlab-org/build/cng/gitaly <span style="color: #8b2252;">\</span>
     --set gitlab.gitaly.image.tag=<span style="color: #8b2252;">"v14.2.1"</span> <span style="color: #8b2252;">\</span>
     --set gitlab.praefect.image.repository=registry.gitlab.com/gitlab-org/build/cng/gitaly <span style="color: #8b2252;">\</span>
     --set gitlab.praefect.image.tag=<span style="color: #8b2252;">"v14.2.1"</span> <span style="color: #8b2252;">\</span>
     --set gitlab.sidekiq.image.repository=registry.gitlab.com/gitlab-org/build/cng/gitlab-sidekiq-ee <span style="color: #8b2252;">\</span>
     --set gitlab.sidekiq.image.tag=<span style="color: #8b2252;">"v14.2.1"</span> <span style="color: #8b2252;">\</span>
     --set gitlab.gitlab-shell.image.repository=registry.gitlab.com/gitlab-org/build/cng/gitlab-shell <span style="color: #8b2252;">\</span>
     --set gitlab.gitlab-shell.image.tag=<span style="color: #8b2252;">"v13.19.1"</span> <span style="color: #8b2252;">\</span>
     --set gitlab.webservice.image.repository=registry.gitlab.com/gitlab-org/build/cng/gitlab-webservice-ee <span style="color: #8b2252;">\</span>
     --set gitlab.webservice.image.tag=<span style="color: #8b2252;">"v14.2.1"</span> <span style="color: #8b2252;">\</span>
     --set gitlab.webservice.workhorse.image=registry.gitlab.com/gitlab-org/build/cng/gitlab-workhorse-ee <span style="color: #8b2252;">\</span>
     --set gitlab.webservice.workhorse.tag=<span style="color: #8b2252;">"v14.2.1"</span> <span style="color: #8b2252;">\</span>
     --set registry.image.repository=registry.gitlab.com/gitlab-org/build/cng/gitlab-container-registry <span style="color: #8b2252;">\</span>
     --set registry.image.tag=<span style="color: #8b2252;">"v3.9.0-gitlab"</span> <span style="color: #8b2252;">\</span>
     --set postgresql.image.repository=bitnami/postgresql <span style="color: #8b2252;">\</span>
     --set postgresql.image.tag=<span style="color: #8b2252;">"12.7.0"</span> <span style="color: #8b2252;">\</span>
     --set redis.image.repository=bitnami/redis <span style="color: #8b2252;">\</span>
     --set redis.image.tag=<span style="color: #8b2252;">"6.0.9-debian-10-r0"</span> <span style="color: #8b2252;">\</span>
     --set gitlab-runner.image=gitlab/gitlab-runner:alpine-v14.2.0 <span style="color: #8b2252;">\</span>
     --set gitlab.gitlab-exporter.image.repository=registry.gitlab.com/gitlab-org/build/cng/gitlab-exporter <span style="color: #8b2252;">\</span>
     --set gitlab.gitlab-exporter.image.tag=<span style="color: #8b2252;">"11.2.0"</span> <span style="color: #8b2252;">\</span>
     --set postgresql.metrics.image.repository=bitnami/postgres-exporter <span style="color: #8b2252;">\</span>
     --set postgresql.metrics.image.tag=<span style="color: #8b2252;">"0.8.0-debian-10-r99"</span> <span style="color: #8b2252;">\</span>
     --set redis.metrics.image.repository=bitnami/redis-exporter <span style="color: #8b2252;">\</span>
     --set redis.metrics.image.tag=<span style="color: #8b2252;">"1.12.1-debian-10-r11"</span> <span style="color: #8b2252;">\</span>
     --set prometheus.image.repository=<span style="color: #8b2252;">"prom/prometheus"</span> <span style="color: #8b2252;">\</span>
     --set prometheus.image.tag=<span style="color: #8b2252;">"v2.21.0"</span> <span style="color: #8b2252;">\</span>
     --set prometheus.configmapReload.image.repository=<span style="color: #8b2252;">"jimmidyson/configmap-reload"</span> <span style="color: #8b2252;">\</span>
     --set prometheus.configmapReload.image.tag=<span style="color: #8b2252;">"v0.4.0"</span> <span style="color: #8b2252;">\</span>
     --set global.busybox.image.repository=registry.gitlab.com/gitlab-org/cloud-native/mirror/images/busybox <span style="color: #8b2252;">\</span>
     --set global.busybox.image.tag=latest       

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21021;&#27425;&#30331;&#24405;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">kubectl get secret &lt;name&gt;-gitlab-initial-root-password -ojsonpath='{.data.password}' | base64 --decode ; echo</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org7f08b73" class="outline-4">
<h4 id="org7f08b73">样例gitlab-runner</h4>
<div class="outline-text-4" id="text-org7f08b73">
<p>
查看对应版本
</p>
<div class="org-src-container">
<pre class="src src-bash">helm search repo -l gitlab/gitlab-runner
</pre>
</div>

<p>
GitLab Runner注册
</p>

<div class="org-src-container">
<pre class="src src-bash">1&#31867;&#22411;
- shared &#65306;&#36816;&#34892;&#25972;&#20010;&#24179;&#21488;&#39033;&#30446;&#30340;&#20316;&#19994;&#65288;gitlab&#65289;
- group&#65306;&#36816;&#34892;&#29305;&#23450;group&#19979;&#30340;&#25152;&#26377;&#39033;&#30446;&#30340;&#20316;&#19994;&#65288;group&#65289;
- specific: &#36816;&#34892;&#25351;&#23450;&#30340;&#39033;&#30446;&#20316;&#19994;&#65288;project&#65289;
2&#29366;&#24577;
- locked&#65306;&#38145;&#23450;&#26080;&#27861;&#36816;&#34892;&#39033;&#30446;&#20316;&#19994;
- paused&#65306;&#26242;&#20572;&#19981;&#20250;&#36816;&#34892;&#20316;&#19994;

3&#33719;&#21462;&#27880;&#20876;token
&#33719;&#21462;shared&#31867;&#22411;runnertoken
- &#36827;&#20837;admin--&#27010;&#35272;--Runner
&#33719;&#21462;group&#31867;&#22411;&#30340;runnertoken
- &#36827;&#20837;group -&gt; Settings -&gt; CI/CD -&gt; Runners -&gt; Group Runners
&#33719;&#21462;specific&#31867;&#22411;&#30340;runnertoken
- &#36827;&#20837;&#20855;&#20307;&#30340;&#39033;&#30446; -&gt; Settings -&gt; CI/CD -&gt; Runners -&gt; Specific Runners
</pre>
</div>

<p>
部署helm
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b22222;"># </span><span style="color: #b22222;">For Helm 2</span>
helm install --namespace &lt;NAMESPACE&gt; --name gitlab-runner -f &lt;CONFIG_VALUES_FILE&gt; gitlab/gitlab-runner

<span style="color: #b22222;"># </span><span style="color: #b22222;">For Helm 3</span>
helm install --namespace gitlab-test-xcw gitlab-runner-test-xcw gitlab/gitlab-runner <span style="color: #8b2252;">\</span>
     -f values-test.yaml <span style="color: #8b2252;">\</span>
     --dry-run <span style="color: #8b2252;">\</span>
     --version=0.32.0 <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#35831;&#27714;&#37197;&#32622;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/runner/install/kubernetes.html#required-configuration`</span> <span style="color: #8b2252;">\</span>
     --set <span style="color: #a0522d;">gitlabUrl</span>=https://git-test-xcw.cici.com <span style="color: #8b2252;">\</span>
     --set <span style="color: #a0522d;">runnerRegistrationToken</span>=TkZXLz8yOhP5g50p7YseGzkkYHs24eUqrT8I1Sgl42qn0tHyZtl0PmvS4SsEqlG3 <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#33258;&#23450;&#20041;&#38236;&#20687;--`</span> <span style="color: #8b2252;">\</span>
     --set <span style="color: #a0522d;">image</span>=gitlab/gitlab-runner:alpine-v14.2.0 <span style="color: #8b2252;">\</span>
     --set runners.image=ubuntu:16.04
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;values-test.yaml&#22635;&#20889;[[runners]]</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21368;&#36733;</span>
helm delete  -n gitlab-test-xcw gitlab-runner-test-xcw

<span style="color: #b22222;">#</span><span style="color: #b22222;">local linux</span>
cat &lt;&lt;\EOF&gt; /etc/gitlab-runner/config.toml
<span style="color: #ffa54f;">concurrent = 8</span>
<span style="color: #ffa54f;">check_interval = 0</span>

<span style="color: #ffa54f;">[session_server]</span>
<span style="color: #ffa54f;">  session_timeout = 1800</span>

<span style="color: #ffa54f;">[[runners]]</span>
<span style="color: #ffa54f;">  name = "gitlab-runner1"</span>
<span style="color: #ffa54f;">  url = "https://git.cici.com/"</span>
<span style="color: #ffa54f;">  token = "7c032b4d7954156e8fe47f4828fb79"</span>
<span style="color: #ffa54f;">  executor = "shell"</span>
<span style="color: #ffa54f;">  [runners.cache]</span>

<span style="color: #ffa54f;">[[runners]]</span>
<span style="color: #ffa54f;">  name = "gitlab-runner1-2"</span>
<span style="color: #ffa54f;">  url = "https://git.cici.com/"</span>
<span style="color: #ffa54f;">  Token = "ed5dc1ce69bc92d6403ac7a3b88dac"</span>
<span style="color: #ffa54f;">  executor = "shell"</span>
<span style="color: #ffa54f;">  [runners.cache]</span>

<span style="color: #ffa54f;">[[runners]]</span>
<span style="color: #ffa54f;">  name = "gitlab-runner1-3"</span>
<span style="color: #ffa54f;">  url = "https://git.cici.com/"</span>
<span style="color: #ffa54f;">  token = "f62a7ad1cf3ef656bdb2b104569389"</span>
<span style="color: #ffa54f;">  executor = "shell"</span>
<span style="color: #ffa54f;">  [Runners.cache]</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
部署yum
</p>

<p>
<a href="https://docs.gitlab.com/runner/install/linux-repository.html">https://docs.gitlab.com/runner/install/linux-repository.html</a>
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;gitlab runner&#21253;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">For Debian/Ubuntu/Mint</span>
curl -L <span style="color: #8b2252;">"https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh"</span> | sudo bash
<span style="color: #b22222;"># </span><span style="color: #b22222;">For RHEL/CentOS/Fedora</span>
curl -L <span style="color: #8b2252;">"https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh"</span> | sudo bash
<span style="color: #b22222;"># </span><span style="color: #b22222;">for DEB based systems</span>
apt-cache madison gitlab-runner
sudo apt-get install gitlab-runner-14.2.0-1

<span style="color: #b22222;"># </span><span style="color: #b22222;">for RPM based systems</span>
yum list gitlab-runner --showduplicates | sort -r
sudo yum install gitlab-runner-14.2.0-1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#25968;&#25454;&#20301;&#32622;&#24182;&#21019;&#24314;&#30446;&#24405;&#25480;&#26435;&#29992;&#25143;gitlab-runner</span>
cat /etc/systemd/system/gitlab-runner.service
--working-directory /data/gitlab-runner

systemctl status gitlab-runner

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22686;&#21152;&#20316;&#19994;&#25968;&#37327;</span>
sed -ri <span style="color: #8b2252;">'s/(concurrent ).*/\1= 10/g'</span> /etc/gitlab-runner/config.toml

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21521; GitLab Server &#23436;&#25104;&#35387;&#20874;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#20876;&#31867;&#22411;shared, group, specific</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">a.&#20849;&#20139;</span>
gitlab-runner register <span style="color: #8b2252;">\</span>
  --non-interactive <span style="color: #8b2252;">\</span>
  --url <span style="color: #8b2252;">"https://git-test-xcw.cici.com/"</span> <span style="color: #8b2252;">\</span>
  --registration-token <span style="color: #8b2252;">"m-pV8RG2Rxh5LJj2pCNb"</span> <span style="color: #8b2252;">\</span>
  --executor <span style="color: #8b2252;">"shell"</span> <span style="color: #8b2252;">\</span>
  --description <span style="color: #8b2252;">"gitlab-runner1"</span> <span style="color: #8b2252;">\</span>
  --tag-list <span style="color: #8b2252;">"java,maven"</span> <span style="color: #8b2252;">\</span>
  --run-untagged=<span style="color: #8b2252;">"true"</span> <span style="color: #8b2252;">\</span>
  --locked=<span style="color: #8b2252;">"false"</span> <span style="color: #8b2252;">\</span>
  --access-level=<span style="color: #8b2252;">"not_protected"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">b.&#25351;&#23450;&#39033;&#30446;(&#38656;&#35201;&#20844;&#38053;&#20449;&#24687;)</span>
gitlab-runner register <span style="color: #8b2252;">\</span>
  --non-interactive <span style="color: #8b2252;">\</span>
  --url <span style="color: #8b2252;">"https://git-test-xcw.cici.com/"</span> <span style="color: #8b2252;">\</span>
  --registration-token <span style="color: #8b2252;">"h8aw81DkHm2NhaBEAohX"</span> <span style="color: #8b2252;">\</span>
  --executor <span style="color: #8b2252;">"shell"</span> <span style="color: #8b2252;">\</span>
  --description <span style="color: #8b2252;">"gitlab-runner1-2"</span> <span style="color: #8b2252;">\</span>
  --tag-list <span style="color: #8b2252;">"java,maven"</span> <span style="color: #8b2252;">\</span>
  --run-untagged=<span style="color: #8b2252;">"true"</span> <span style="color: #8b2252;">\</span>
  --locked=<span style="color: #8b2252;">"false"</span> <span style="color: #8b2252;">\</span>
  --access-level=<span style="color: #8b2252;">"not_protected"</span>
<span style="color: #b22222;">##</span><span style="color: #b22222;">&#23558;gitlab-runner&#29992;&#25143;&#30340;&#20844;&#38053;&#19978;&#20256;&#21040;gitlab&#20013;&#65288;&#21487;&#36873;&#65289;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ssh-keygen -t rsa -C "xx@163.com" -P ''</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">cat .ssh/id_rsa.pub</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26356;&#26032;git</span>
yum install http://opensource.wandisco.com/centos/7/git/x86_64/wandisco-git-release-7-2.noarch.rpm
yum install git
yum update git
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgddff42f" class="outline-3">
<h3 id="orgddff42f">测试环境</h3>
<div class="outline-text-3" id="text-orgddff42f">
<p>
3k用户
</p>


<figure id="org9766c54">
<img src="images/3k-arch.png" alt="3k-arch.png" width="60%">

</figure>
</div>
<div id="outline-container-orga7c211c" class="outline-4">
<h4 id="orga7c211c">提前准备</h4>
<div class="outline-text-4" id="text-orga7c211c">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#25351;&#23450;&#30446;&#24405;&#20869;&#29983;&#25104;&#35201;&#20934;&#22791;&#30340;&#25991;&#20214;</span>
mkdir customize_conf; <span style="color: #483d8b;">cd</span> customize_conf
</pre>
</div>
</div>
<div id="outline-container-org3024620" class="outline-5">
<h5 id="org3024620">持久卷</h5>
<div class="outline-text-5" id="text-org3024620">
<p>
准备一台机器创建好对目录
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b22222;">#</span><span style="color: #b22222;">mkdir -p /data/gitlab-test-xcw/{gitaly{,2,3},postgresql,prometheus,redis}</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">Gitaly&#23384;&#20648; 200Gi</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">3k&#29992;&#25143;&#38598;&#32676;&#38656;&#35201;&#21019;&#24314;&#33267;&#23569;3&#20010;gitaly&#26381;&#21153;&#20379;praefect&#20195;&#29702;&#65292;&#40664;&#35748;&#19981;&#21551;&#21160;praefect&#65292;&#21019;&#24314;&#19968;&#20010;gitaly pv&#23601;&#22909;&#12290;</span>
cat &lt;&lt;\EOF&gt; gitlab-pv-sc.yaml
<span style="color: #ffa54f;">---</span>
<span style="color: #ffa54f;">#gitaly1</span>
<span style="color: #ffa54f;">apiVersion: v1</span>
<span style="color: #ffa54f;">kind: PersistentVolume</span>
<span style="color: #ffa54f;">metadata:</span>
<span style="color: #ffa54f;">  name: gitlab-gitaly-test-xcw</span>
<span style="color: #ffa54f;">  labels:</span>
<span style="color: #ffa54f;">    storage: gitaly-data-test-xcw</span>
<span style="color: #ffa54f;">spec:</span>
<span style="color: #ffa54f;">  capacity:</span>
<span style="color: #ffa54f;">    storage: "200Gi"</span>
<span style="color: #ffa54f;">  accessModes:</span>
<span style="color: #ffa54f;">    - "ReadWriteMany"</span>
<span style="color: #ffa54f;">  volumeMode: Filesystem</span>
<span style="color: #ffa54f;">  local:</span>
<span style="color: #ffa54f;">    path: /data/gitlab-test-xcw/gitaly</span>
<span style="color: #ffa54f;">  storageClassName: "gitlab-storageclass-test-xcw"</span>
<span style="color: #ffa54f;">  nodeAffinity:</span>
<span style="color: #ffa54f;">    required:</span>
<span style="color: #ffa54f;">      nodeSelectorTerms:</span>
<span style="color: #ffa54f;">      - matchExpressions:</span>
<span style="color: #ffa54f;">        - key: kubernetes.io/hostname</span>
<span style="color: #ffa54f;">          operator: In</span>
<span style="color: #ffa54f;">          values:</span>
<span style="color: #ffa54f;">          - 10.22.0.18</span>
<span style="color: #ffa54f;">---</span>
<span style="color: #ffa54f;">#gitaly2</span>
<span style="color: #ffa54f;">apiVersion: v1</span>
<span style="color: #ffa54f;">kind: PersistentVolume</span>
<span style="color: #ffa54f;">metadata:</span>
<span style="color: #ffa54f;">  name: gitlab-gitaly2-test-xcw</span>
<span style="color: #ffa54f;">  labels:</span>
<span style="color: #ffa54f;">    storage: gitaly2-data-test-xcw</span>
<span style="color: #ffa54f;">spec:</span>
<span style="color: #ffa54f;">  capacity:</span>
<span style="color: #ffa54f;">    storage: "200Gi"</span>
<span style="color: #ffa54f;">  accessModes:</span>
<span style="color: #ffa54f;">    - "ReadWriteMany"</span>
<span style="color: #ffa54f;">  volumeMode: Filesystem</span>
<span style="color: #ffa54f;">  local:</span>
<span style="color: #ffa54f;">    path: /data/gitlab-test-xcw/gitaly2</span>
<span style="color: #ffa54f;">  storageClassName: "gitlab-storageclass-test-xcw"</span>
<span style="color: #ffa54f;">  nodeAffinity:</span>
<span style="color: #ffa54f;">    required:</span>
<span style="color: #ffa54f;">      nodeSelectorTerms:</span>
<span style="color: #ffa54f;">      - matchExpressions:</span>
<span style="color: #ffa54f;">        - key: kubernetes.io/hostname</span>
<span style="color: #ffa54f;">          operator: In</span>
<span style="color: #ffa54f;">          values:</span>
<span style="color: #ffa54f;">          - 10.22.0.18</span>
<span style="color: #ffa54f;">---</span>
<span style="color: #ffa54f;">#gitaly3</span>
<span style="color: #ffa54f;">apiVersion: v1</span>
<span style="color: #ffa54f;">kind: PersistentVolume</span>
<span style="color: #ffa54f;">metadata:</span>
<span style="color: #ffa54f;">  name: gitlab-gitaly3-test-xcw</span>
<span style="color: #ffa54f;">  labels:</span>
<span style="color: #ffa54f;">    storage: gitaly3-data-test-xcw</span>
<span style="color: #ffa54f;">spec:</span>
<span style="color: #ffa54f;">  capacity:</span>
<span style="color: #ffa54f;">    storage: "200Gi"</span>
<span style="color: #ffa54f;">  accessModes:</span>
<span style="color: #ffa54f;">    - "ReadWriteMany"</span>
<span style="color: #ffa54f;">  volumeMode: Filesystem</span>
<span style="color: #ffa54f;">  local:</span>
<span style="color: #ffa54f;">    path: /data/gitlab-test-xcw/gitaly3</span>
<span style="color: #ffa54f;">  storageClassName: "gitlab-storageclass-test-xcw"</span>
<span style="color: #ffa54f;">  nodeAffinity:</span>
<span style="color: #ffa54f;">    required:</span>
<span style="color: #ffa54f;">      nodeSelectorTerms:</span>
<span style="color: #ffa54f;">      - matchExpressions:</span>
<span style="color: #ffa54f;">        - key: kubernetes.io/hostname</span>
<span style="color: #ffa54f;">          operator: In</span>
<span style="color: #ffa54f;">          values:</span>
<span style="color: #ffa54f;">          - 10.22.0.18</span>
<span style="color: #ffa54f;">---</span>
<span style="color: #ffa54f;">#postgresql</span>
<span style="color: #ffa54f;">apiVersion: v1</span>
<span style="color: #ffa54f;">kind: PersistentVolume</span>
<span style="color: #ffa54f;">metadata:</span>
<span style="color: #ffa54f;">  name: gitlab-postgresql-test-xcw</span>
<span style="color: #ffa54f;">  labels:</span>
<span style="color: #ffa54f;">    storage: postgresql-data-test-xcw</span>
<span style="color: #ffa54f;">spec:</span>
<span style="color: #ffa54f;">  capacity:</span>
<span style="color: #ffa54f;">    storage: "50Gi"</span>
<span style="color: #ffa54f;">  accessModes:</span>
<span style="color: #ffa54f;">    - "ReadWriteMany"</span>
<span style="color: #ffa54f;">  volumeMode: Filesystem</span>
<span style="color: #ffa54f;">  local:</span>
<span style="color: #ffa54f;">    path: /data/gitlab-test-xcw/postgresql</span>
<span style="color: #ffa54f;">  storageClassName: "gitlab-storageclass-test-xcw"</span>
<span style="color: #ffa54f;">  nodeAffinity:</span>
<span style="color: #ffa54f;">    required:</span>
<span style="color: #ffa54f;">      nodeSelectorTerms:</span>
<span style="color: #ffa54f;">      - matchExpressions:</span>
<span style="color: #ffa54f;">        - key: kubernetes.io/hostname</span>
<span style="color: #ffa54f;">          operator: In</span>
<span style="color: #ffa54f;">          values:</span>
<span style="color: #ffa54f;">          - 10.22.0.18</span>
<span style="color: #ffa54f;">---</span>
<span style="color: #ffa54f;">#redis</span>
<span style="color: #ffa54f;">apiVersion: v1</span>
<span style="color: #ffa54f;">kind: PersistentVolume</span>
<span style="color: #ffa54f;">metadata:</span>
<span style="color: #ffa54f;">  name: gitlab-redis-test-xcw</span>
<span style="color: #ffa54f;">  labels:</span>
<span style="color: #ffa54f;">    storage: redis-data-test-xcw</span>
<span style="color: #ffa54f;">spec:</span>
<span style="color: #ffa54f;">  capacity:</span>
<span style="color: #ffa54f;">    storage: "20Gi"</span>
<span style="color: #ffa54f;">  accessModes:</span>
<span style="color: #ffa54f;">    - "ReadWriteMany"</span>
<span style="color: #ffa54f;">  volumeMode: Filesystem</span>
<span style="color: #ffa54f;">  local:</span>
<span style="color: #ffa54f;">    path: /data/gitlab-test-xcw/redis</span>
<span style="color: #ffa54f;">  storageClassName: "gitlab-storageclass-test-xcw"</span>
<span style="color: #ffa54f;">  nodeAffinity:</span>
<span style="color: #ffa54f;">    required:</span>
<span style="color: #ffa54f;">      nodeSelectorTerms:</span>
<span style="color: #ffa54f;">      - matchExpressions:</span>
<span style="color: #ffa54f;">        - key: kubernetes.io/hostname</span>
<span style="color: #ffa54f;">          operator: In</span>
<span style="color: #ffa54f;">          values:</span>
<span style="color: #ffa54f;">          - 10.22.0.18</span>
<span style="color: #ffa54f;">---</span>
<span style="color: #ffa54f;">#prometheus</span>
<span style="color: #ffa54f;">apiVersion: v1</span>
<span style="color: #ffa54f;">kind: PersistentVolume</span>
<span style="color: #ffa54f;">metadata:</span>
<span style="color: #ffa54f;">  name: gitlab-prometheus-test-xcw</span>
<span style="color: #ffa54f;">  labels:</span>
<span style="color: #ffa54f;">    storage: prometheus-data-test-xcw</span>
<span style="color: #ffa54f;">spec:</span>
<span style="color: #ffa54f;">  capacity:</span>
<span style="color: #ffa54f;">    storage: "10Gi"</span>
<span style="color: #ffa54f;">  accessModes:</span>
<span style="color: #ffa54f;">    - "ReadWriteMany"</span>
<span style="color: #ffa54f;">  volumeMode: Filesystem</span>
<span style="color: #ffa54f;">  local:</span>
<span style="color: #ffa54f;">    path: /data/gitlab-test-xcw/prometheus</span>
<span style="color: #ffa54f;">  storageClassName: "gitlab-storageclass-test-xcw"</span>
<span style="color: #ffa54f;">  nodeAffinity:</span>
<span style="color: #ffa54f;">    required:</span>
<span style="color: #ffa54f;">      nodeSelectorTerms:</span>
<span style="color: #ffa54f;">      - matchExpressions:</span>
<span style="color: #ffa54f;">        - key: kubernetes.io/hostname</span>
<span style="color: #ffa54f;">          operator: In</span>
<span style="color: #ffa54f;">          values:</span>
<span style="color: #ffa54f;">          - 10.22.0.18</span>
<span style="color: #ffa54f;">---</span>
<span style="color: #ffa54f;">kind: StorageClass</span>
<span style="color: #ffa54f;">apiVersion: storage.k8s.io/v1</span>
<span style="color: #ffa54f;">metadata:</span>
<span style="color: #ffa54f;">  name: gitlab-storageclass-test-xcw</span>
<span style="color: #ffa54f;">provisioner: kubernetes.io/no-provisioner</span>
<span style="color: #ffa54f;">volumeBindingMode: WaitForFirstConsumer</span>
<span style="color: #ffa54f;">reclaimPolicy: Retain</span>
<span style="color: #ffa54f;">EOF</span>

kubectl apply -f gitlab-pv-sc.yaml
</pre>
</div>
</div>
</div>
<div id="outline-container-org1d21973" class="outline-5">
<h5 id="org1d21973">域名证书</h5>
<div class="outline-text-5" id="text-org1d21973">
<div class="org-src-container">
<pre class="src src-bash">kubectl --namespace=gitlab-test-xcw create secret tls cici-com --cert=cici.com.crt --key=cici.com.key
</pre>
</div>
</div>
</div>
<div id="outline-container-org124ebf9" class="outline-5">
<h5 id="org124ebf9">启动外部对象存储</h5>
<div class="outline-text-5" id="text-org124ebf9">
<p>
ak
</p>
<div class="org-src-container">
<pre class="src src-bash">&#20027;&#36134;&#21495;ID 100000xxx
&#29992;&#25143;&#21517; gitlab-test-xcw 
&#30331;&#24405;&#23494;&#30721; - 
SecretId Axxxx
SecretKey oLxxx
</pre>
</div>

<p>
腾讯云COS存储用户权限策略
</p>

<div class="org-src-container">
<pre class="src src-bash">{
    <span style="color: #8b2252;">"version"</span>: <span style="color: #8b2252;">"2.0"</span>,
    <span style="color: #8b2252;">"statement"</span>: [
        {
            <span style="color: #8b2252;">"effect"</span>: <span style="color: #8b2252;">"allow"</span>,
            <span style="color: #8b2252;">"action"</span>: [
                <span style="color: #8b2252;">"name/cos:*"</span>
            ],
            <span style="color: #8b2252;">"resource"</span>: [
                <span style="color: #8b2252;">"qcs::cos:ap-beijing:uid/1254024480:gitlab-backup-test-xcw-1254024480/"</span>,
                <span style="color: #8b2252;">"qcs::cos:ap-beijing:uid/1254024480:gitlab-backup-test-xcw-1254024480/*"</span>,
                <span style="color: #8b2252;">"qcs::cos:ap-beijing:uid/1254024480:gitlab-backup-tmp-test-xcw-1254024480/"</span>,
                <span style="color: #8b2252;">"qcs::cos:ap-beijing:uid/1254024480:gitlab-backup-tmp-test-xcw-1254024480/*"</span>,
                <span style="color: #8b2252;">"qcs::cos:ap-beijing:uid/1254024480:gitlab-artifacts-test-xcw-1254024480/"</span>,
                <span style="color: #8b2252;">"qcs::cos:ap-beijing:uid/1254024480:gitlab-artifacts-test-xcw-1254024480/*"</span>,
                <span style="color: #8b2252;">"qcs::cos:ap-beijing:uid/1254024480:gitlab-lfs-test-xcw-1254024480/"</span>,
                <span style="color: #8b2252;">"qcs::cos:ap-beijing:uid/1254024480:gitlab-lfs-test-xcw-1254024480/*"</span>,
                <span style="color: #8b2252;">"qcs::cos:ap-beijing:uid/1254024480:gitlab-packages-test-xcw-1254024480/"</span>,
                <span style="color: #8b2252;">"qcs::cos:ap-beijing:uid/1254024480:gitlab-packages-test-xcw-1254024480/*"</span>,
                <span style="color: #8b2252;">"qcs::cos:ap-beijing:uid/1254024480:gitlab-pseudonymizer-test-xcw-1254024480/"</span>,
                <span style="color: #8b2252;">"qcs::cos:ap-beijing:uid/1254024480:gitlab-pseudonymizer-test-xcw-1254024480/*"</span>,
                <span style="color: #8b2252;">"qcs::cos:ap-beijing:uid/1254024480:gitlab-uploads-test-xcw-1254024480/"</span>,
                <span style="color: #8b2252;">"qcs::cos:ap-beijing:uid/1254024480:gitlab-uploads-test-xcw-1254024480/*"</span>,
                <span style="color: #8b2252;">"qcs::cos:ap-beijing:uid/1254024480:gitlab-registry-test-xcw-1254024480/"</span>,
                <span style="color: #8b2252;">"qcs::cos:ap-beijing:uid/1254024480:gitlab-registry-test-xcw-1254024480/*"</span>
            ]
        }
    ]
}
</pre>
</div>
<p>
密钥创建
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#32479;&#19968;&#23384;&#20648;</span>
cat &lt;&lt;EOF&gt; object-storage-test.yaml
<span style="color: #ffa54f;">provider: AWS</span>
<span style="color: #ffa54f;">region: ap-beijing</span>
<span style="color: #ffa54f;">aws_access_key_id: AKIDxxx</span>
<span style="color: #ffa54f;">aws_secret_access_key: oLxxxx</span>
<span style="color: #ffa54f;">aws_signature_version: 2</span>
<span style="color: #ffa54f;">host: "cos.ap-beijing.myqcloud.com"</span>
<span style="color: #ffa54f;">endpoint: "https://cos.ap-beijing.myqcloud.com"</span>
<span style="color: #ffa54f;">EOF</span>
kubectl --namespace=gitlab-test-xcw create secret generic gitlab-rails-storage --from-file=<span style="color: #a0522d;">connection</span>=object-storage-test.yaml


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38236;&#20687;&#23384;&#20648;</span>
cat &gt;registry-test.yaml&lt;&lt;EOF
<span style="color: #ffa54f;">s3:</span>
<span style="color: #ffa54f;">  bucket: gitlab-registry-test</span>
<span style="color: #ffa54f;">  accesskey: AKIDMxxxx</span>
<span style="color: #ffa54f;">  secretkey: oLaZIxxxx</span>
<span style="color: #ffa54f;">  regionendpoint: "https://cos.ap-beijing.myqcloud.com"</span>
<span style="color: #ffa54f;">  region: ap-beijing</span>
<span style="color: #ffa54f;">EOF</span>
kubectl --namespace=gitlab-test-xcw create secret generic gitlab-registry --from-file=<span style="color: #a0522d;">config</span>=registry-test.yaml

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;</span>
cat &lt;&lt;EOF&gt; s3cfg_cos
<span style="color: #ffa54f;">[default]</span>
<span style="color: #ffa54f;">access_key = AKxxx</span>
<span style="color: #ffa54f;">secret_key = oLaZxxxx</span>
<span style="color: #ffa54f;">bucket_location = ap-beijing</span>
<span style="color: #ffa54f;">host_base = cos.ap-beijing.myqcloud.com</span>
<span style="color: #ffa54f;">host_bucket = cos.ap-beijing.myqcloud.com</span>
<span style="color: #ffa54f;">signature_v2 = True</span>
<span style="color: #ffa54f;">EOF</span>
kubectl --namespace=gitlab-test-xcw create secret generic task-runenr-s3-config --from-file=<span style="color: #a0522d;">config</span>=s3cfg_cos
</pre>
</div>
</div>
</div>
<div id="outline-container-org7cf7412" class="outline-5">
<h5 id="org7cf7412">服务连接密码</h5>
<div class="outline-text-5" id="text-org7cf7412">
<div class="org-src-container">
<pre class="src src-bash">cat &lt;&lt;\EOF&gt; pg_redis_ldap_smtp.yaml
<span style="color: #ffa54f;">---</span>
<span style="color: #ffa54f;">apiVersion: v1</span>
<span style="color: #ffa54f;">kind: Secret</span>
<span style="color: #ffa54f;">metadata: </span>
<span style="color: #ffa54f;">  namespace: gitlab-test-xcw</span>
<span style="color: #ffa54f;">  name: gitlab-test-pg</span>
<span style="color: #ffa54f;">type: Opaque </span>
<span style="color: #ffa54f;">data: </span>
<span style="color: #ffa54f;">  password: cG9zdGdyZXM=</span>

<span style="color: #ffa54f;">---</span>
<span style="color: #ffa54f;">apiVersion: v1</span>
<span style="color: #ffa54f;">kind: Secret</span>
<span style="color: #ffa54f;">metadata: </span>
<span style="color: #ffa54f;">  namespace: gitlab-test-xcw</span>
<span style="color: #ffa54f;">  name: gitlab-test-redis</span>
<span style="color: #ffa54f;">type: Opaque </span>
<span style="color: #ffa54f;">data: </span>
<span style="color: #ffa54f;">  password: MTIzNDU2</span>

<span style="color: #ffa54f;">---</span>
<span style="color: #ffa54f;">apiVersion: v1</span>
<span style="color: #ffa54f;">kind: Secret</span>
<span style="color: #ffa54f;">metadata: </span>
<span style="color: #ffa54f;">  namespace: gitlab-test-xcw</span>
<span style="color: #ffa54f;">  name: gitlab-test-ldap</span>
<span style="color: #ffa54f;">type: Opaque </span>
<span style="color: #ffa54f;">data: </span>
<span style="color: #ffa54f;">  password: S3hzWWdKYk52TXdGOEtrcThuZUxiRWtRS1VpYTl4Vks=</span>

<span style="color: #ffa54f;">---</span>
<span style="color: #ffa54f;">apiVersion: v1</span>
<span style="color: #ffa54f;">kind: Secret</span>
<span style="color: #ffa54f;">metadata: </span>
<span style="color: #ffa54f;">  namespace: gitlab-test-xcw</span>
<span style="color: #ffa54f;">  name: gitlab-test-smtp</span>
<span style="color: #ffa54f;">type: Opaque </span>
<span style="color: #ffa54f;">data: </span>
<span style="color: #ffa54f;">  password: WiNwczklMGo=</span>
<span style="color: #ffa54f;">EOF</span>
kubectl apply -f pg_redis_ldap_smtp.yaml

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#20869;&#37096;&#29983;&#25104;&#30340;redis postgresql&#65292;&#19981;&#38656;&#35201;&#20351;&#29992;&#36825;&#37324;&#21019;&#24314;&#30340;&#23494;&#38053;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#20869;&#37096;&#29983;&#25104;&#30340;redis postgresql&#20351;&#29992;&#36825;&#37324;&#30340;&#23494;&#38053;&#65292;&#38656;&#35201;&#25351;&#23450;&#19979;&#38754;&#21442;&#25968;&#21450;&#26381;&#21153;&#22120;&#20869;&#37096;&#23494;&#30721;&#21442;&#25968;</span>
<span style="color: #b22222;">#   </span><span style="color: #b22222;">--set global.psql.password.secret=gitlab-test-pg \</span>
<span style="color: #b22222;">#   </span><span style="color: #b22222;">--set global.psql.password.key='password' \</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">global.postgresql.postgresqlPassword</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">global.postgresql.existingSecret</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org9e9a66a" class="outline-5">
<h5 id="org9e9a66a">负载均衡ingress slb</h5>
<div class="outline-text-5" id="text-org9e9a66a">
<p>
自动创建一个clb，这里选择的内网slb，<a href="https://cloud.tencent.com/document/product/457/45487">https://cloud.tencent.com/document/product/457/45487</a>
</p>

<div class="org-src-container">
<pre class="src src-bash">--set nginx-ingress.controller.service.annotations.service<span style="color: #8b2252;">\\</span>.kubernetes<span style="color: #8b2252;">\\</span>.io<span style="color: #8b2252;">\\</span>/qcloud-loadbalancer-internal-subnetid=subnet-fubxophz
</pre>
</div>

<p>
指定已创建的clb
</p>

<div class="org-src-container">
<pre class="src src-bash">--set global.hosts.externalIP=10.22.0.71 <span style="color: #8b2252;">\</span>
--set nginx-ingress.controller.service.annotations.service<span style="color: #8b2252;">\\</span>.kubernetes<span style="color: #8b2252;">\\</span>.io<span style="color: #8b2252;">\\</span>/qcloud-loadbalancer-internal-subnetid=subnet-fubxophz <span style="color: #8b2252;">\</span>
--set nginx-ingress.controller.service.annotations.kubernetes<span style="color: #8b2252;">\\</span>.io<span style="color: #8b2252;">\\</span>/ingress<span style="color: #8b2252;">\\</span>.existLbId=&lt;loadbalanceid&gt; <span style="color: #8b2252;">\</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org79454ad" class="outline-5">
<h5 id="org79454ad">制作私有镜像</h5>
<div class="outline-text-5" id="text-org79454ad">
<p>
为保证版本固定及拉取速度，核心组件最好做成私有镜像
</p>

<div class="org-src-container">
<pre class="src src-bash">docker push docker.cici.com/library/gitlab/gitlab-container-registry:v3.9.0-gitlab
docker push docker.cici.com/library/gitlab/gitlab-shell:v13.19.1
docker push docker.cici.com/library/gitlab/gitlab-workhorse-ee:v14.2.1
docker push docker.cici.com/library/gitlab/gitlab-toolbox-ee:v14.2.1
docker push docker.cici.com/library/gitlab/gitlab-webservice-ee:v14.2.1
docker push docker.cici.com/library/gitlab/gitlab-sidekiq-ee:v14.2.1
docker push docker.cici.com/library/gitlab/gitaly:v14.2.1
docker push docker.cici.com/library/gitlab/gitlab-exporter:11.2.0
docker push docker.cici.com/library/gitlab/kubectl:1.16.15
docker push docker.cici.com/library/gitlab/postgresql:12.7.0
docker push docker.cici.com/library/gitlab/gitlab-runner:alpine-v14.2.0
docker push docker.cici.com/library/gitlab/alpine-certificates:20191127-r2
docker push docker.cici.com/library/gitlab/nginx-ingress-controller:v0.41.2
docker push docker.cici.com/library/gitlab/redis:6.0.9-debian-10-r0
docker push docker.cici.com/library/gitlab/defaultbackend-amd64:1.5
docker push docker.cici.com/library/gitlab/busybox:latest
</pre>
</div>
</div>
</div>
<div id="outline-container-org1d029ae" class="outline-5">
<h5 id="org1d029ae">脚本</h5>
<div class="outline-text-5" id="text-org1d029ae">
<div class="org-src-container">
<pre class="src src-bash">cat &lt;&lt;\EOF&gt; create_gitlab_secrets.sh
<span style="color: #ffa54f;">#!/bin/bash</span>
<span style="color: #ffa54f;"># --- &#21019;&#24314;&#25345;&#20037;&#21367;</span>
<span style="color: #ffa54f;">kubectl apply -f gitlab-pv-sc.yaml</span>

<span style="color: #ffa54f;"># --- &#21019;&#24314;&#22495;&#21517;&#35777;&#20070;tls secret</span>
<span style="color: #ffa54f;">kubectl --namespace=gitlab-test-xcw create secret tls cici-com --cert=cici.com.crt --key=cici.com.key</span>

<span style="color: #ffa54f;"># --- &#21551;&#21160;&#22806;&#37096;&#23545;&#35937;&#23384;&#20648;</span>
<span style="color: #ffa54f;">#&#32479;&#19968;&#23384;&#20648;</span>
<span style="color: #ffa54f;">kubectl --namespace=gitlab-test-xcw create secret generic gitlab-rails-storage --from-file=connection=object-storage-test.yaml</span>
<span style="color: #ffa54f;">#:&lt;&lt;eof</span>
<span style="color: #ffa54f;">#5.2.1&#29256;&#26412;&#21069;&#27809;&#26377;&#25972;&#21512;&#37197;&#32622;&#65292;&#38656;&#35201;&#21333;&#29420;&#25191;&#34892;</span>
<span style="color: #ffa54f;">kubectl --namespace=gitlab-test-xcw create secret generic gitlab-lfs --from-file=connection=object-storage-test.yaml</span>
<span style="color: #ffa54f;">kubectl --namespace=gitlab-test-xcw create secret generic gitlab-artifacts --from-file=connection=object-storage-test.yaml</span>
<span style="color: #ffa54f;">kubectl --namespace=gitlab-test-xcw create secret generic gitlab-uploads --from-file=connection=object-storage-test.yaml</span>
<span style="color: #ffa54f;">kubectl --namespace=gitlab-test-xcw create secret generic gitlab-packages --from-file=connection=object-storage-test.yaml</span>
<span style="color: #ffa54f;">#kubectl --namespace=gitlab-test-xcw create secret generic gitlab-externaldiffs --from-file=connection=object-storage-test.yaml</span>
<span style="color: #ffa54f;">kubectl --namespace=gitlab-test-xcw create secret generic gitlab-pseudonymizer --from-file=connection=object-storage-test.yaml</span>
<span style="color: #ffa54f;">#eof</span>

<span style="color: #ffa54f;">#&#38236;&#20687;&#23384;&#20648;</span>
<span style="color: #ffa54f;">kubectl --namespace=gitlab-test-xcw create secret generic gitlab-registry --from-file=config=registry-test.yaml</span>
<span style="color: #ffa54f;">#&#22791;&#20221;</span>
<span style="color: #ffa54f;">kubectl --namespace=gitlab-test-xcw create secret generic task-runenr-s3-config --from-file=config=s3cfg_cos</span>

<span style="color: #ffa54f;"># --- &#26381;&#21153;&#36830;&#25509;&#23494;&#30721;</span>
<span style="color: #ffa54f;">kubectl apply -f pg_redis_ldap_smtp.yaml</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgea30f3e" class="outline-4">
<h4 id="orgea30f3e">部署</h4>
<div class="outline-text-4" id="text-orgea30f3e">
</div>
<div id="outline-container-org303b20a" class="outline-5">
<h5 id="org303b20a">helm发布</h5>
<div class="outline-text-5" id="text-org303b20a">
<div class="org-src-container">
<pre class="src src-bash">helm upgrade --install  -n gitlab-test-xcw  gitlab-test-xcw gitlab/gitlab <span style="color: #8b2252;">\</span>
     --timeout 600s <span style="color: #8b2252;">\</span>
     --version=5.2.1 <span style="color: #8b2252;">\</span>
     --dry-run <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#22495;&#21517;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/installation/deployment.html#networking-and-dns`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#20027;&#26426;&#22495;&#21517;https://docs.gitlab.com/charts/charts/globals#configure-host-settings`</span> <span style="color: #8b2252;">\</span>
     --set global.hosts.gitlab.name=<span style="color: #8b2252;">'git-test-xcw.cici.com'</span> <span style="color: #8b2252;">\</span>
     --set global.hosts.gitlab.https=true <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.service.annotations.service<span style="color: #8b2252;">\\</span>.kubernetes<span style="color: #8b2252;">\\</span>.io<span style="color: #8b2252;">\\</span>/qcloud-loadbalancer-internal-subnetid=subnet-fubxophz <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#25345;&#20037;&#23384;&#20648;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/installation/storage.html`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#21160;&#24577;&#21367; kubectl apply -f gitlab_storageclass.yaml`</span> <span style="color: #8b2252;">\</span>
     --set gitlab.gitaly.persistence.storageClass=gitlab-storageclass-test-xcw <span style="color: #8b2252;">\</span>
     --set gitlab.gitaly.persistence.size=200Gi <span style="color: #8b2252;">\</span>
     --set gitlab.gitaly.persistence.accessMode=ReadWriteMany <span style="color: #8b2252;">\</span>
     --set postgresql.persistence.storageClass=gitlab-storageclass-test-xcw <span style="color: #8b2252;">\</span>
     --set postgresql.persistence.size=50Gi <span style="color: #8b2252;">\</span>
     --set postgresql.persistence.accessModes={ReadWriteMany} <span style="color: #8b2252;">\</span>
     --set redis.master.persistence.storageClass=gitlab-storageclass-test-xcw <span style="color: #8b2252;">\</span>
     --set redis.master.persistence.size=20Gi <span style="color: #8b2252;">\</span>
     --set redis.master.persistence.accessModes={ReadWriteMany} <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--tls&#35777;&#20070;&#31649;&#29702;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/installation/tls.html`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#23548;&#20837;&#36890;&#37197;&#22495;&#21517;&#35777;&#20070; https://docs.gitlab.com/charts/installation/tls.html#option-2-use-your-own-wildcard-certificate`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#kubectl --namespace=gitlab-test-xcw create secret tls cici-com-test-xcw --cert=cici.com.crt --key=cici.com.key`</span> <span style="color: #8b2252;">\</span>
     --set certmanager.install=false <span style="color: #8b2252;">\</span>
     --set global.ingress.configureCertmanager=false <span style="color: #8b2252;">\</span>
     --set global.ingress.tls.secretName=cici-com <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#22806;&#37096;postgresql--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/installation/deployment.html#postgresql`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#23494;&#30721;&#21487;&#36890;&#36807;secret&#26041;&#24335;&#23548;&#20837;`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#kubectl -n gitlab create secret generic gitalb-postgresql-password --from-literal=postgresql-password=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64)`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--set postgresql.install=false`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--set global.psql.host=production.postgress.hostname.local`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--set global.psql.username='postgres'`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--set global.psql.password.secret=gitlab-test-pg`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--set global.psql.password.key='password'`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--set global.psql.database='gitlabtest'`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#22806;&#37096;redis--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/charts/globals.html#configure-redis-settings`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#21487;&#36873;&#21333;&#28857;&#12289;&#21736;&#20853;&#12289;&#38598;&#32676;&#26041;&#24335;&#37096;&#32626;`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#kubectl create secret generic gitlab-redis-secret --from-literal=password=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64)`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--set redis.install=false`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--set global.redis.host='redis.example.com'`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--set global.redis.password.secret=gitlab-test-redis`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--set global.redis.password.key='password'`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#21551;&#21160;&#22806;&#37096;&#23545;&#35937;&#23384;&#20648;&#65292;&#19981;&#20351;&#29992;&#20869;&#37096;&#33258;&#24314;&#30340;minio&#20998;&#24067;&#24335;&#23384;&#20648;&#65292;&#38656;&#35201;&#25552;&#21069;&#29983;&#25104;&#36830;&#25509;&#23494;&#38053;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/advanced/external-object-storage/index.html`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#23436;&#25972;&#26679;&#20363; https://gitlab.com/gitlab-org/charts/gitlab/blob/master/examples/values-external-objectstorage.yaml`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#32479;&#19968;&#23384;&#20648;&#65292;https://docs.gitlab.com/charts/charts/globals.html#consolidated-object-storage`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#23384;&#20648;&#21551;&#21160;&#40664;&#35748;&#20540;https://docs.gitlab.com/12.10/charts/charts/globals.html#configure-minio-settings`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#gitlab&#21508;&#23384;&#20648;&#26742;&#36830;&#25509;&#26679;&#20363;&#65292;https://gitlab.com/gitlab-org/charts/gitlab/-/blob/master/examples/objectstorage/rails.s3.yaml`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#kubectl --namespace=gitlab-test-xcw create secret generic gitlab-rails-storage --from-file=connection=rails.yaml`</span> <span style="color: #8b2252;">\</span>
     --set global.minio.enabled=false <span style="color: #8b2252;">\</span>
     --set global.appConfig.object_store.enabled=true <span style="color: #8b2252;">\</span>
     --set global.appConfig.object_store.connection.secret=gitlab-rails-storage <span style="color: #8b2252;">\</span>
     --set global.appConfig.object_store.connection.key=connection <span style="color: #8b2252;">\</span>
     --set global.appConfig.lfs.bucket=gitlab-lfs-test-xcw-1254024480 <span style="color: #8b2252;">\</span>
     --set global.appConfig.artifacts.bucket=gitlab-artifacts-test-xcw-1254024480 <span style="color: #8b2252;">\</span>
     --set global.appConfig.uploads.bucket=gitlab-uploads-test-xcw-1254024480 <span style="color: #8b2252;">\</span>
     --set global.appConfig.packages.bucket=gitlab-packages-test-xcw-1254024480 <span style="color: #8b2252;">\</span>
     --set global.appConfig.pseudonymizer.bucket=gitlab-pseudonymizer-test-xcw-1254024480 <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#docker&#38236;&#20687;&#24211;`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/advanced/external-object-storage/index.html#docker-registry-images`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#docker&#38236;&#20687;&#23384;&#20648;&#22320;&#22336;&#26679;&#20363; https://gitlab.com/gitlab-org/charts/gitlab/-/blob/master/examples/objectstorage/registry.s3.yaml`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#kubectl --namespace=gitlab-test-xcw create secret generic gitlab-registry --from-file=config=registry-test.yaml`</span> <span style="color: #8b2252;">\</span>
     --set registry.storage.secret=gitlab-registry <span style="color: #8b2252;">\</span>
     --set registry.storage.key=config <span style="color: #8b2252;">\</span>
     --set global.registry.bucket=gitlab-registry-test-xcw-1254024480 <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#22791;&#20221;`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/advanced/external-object-storage/index.html#backups`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#22791;&#20221;&#23384;&#20648;&#37197;&#32622;&#26679;&#20363; https://docs.gitlab.com/charts/advanced/external-object-storage/index.html#backups-storage-example`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#kubectl --namespace=gitlab-test-xcw create secret generic task-runenr-s3-config --from-file=config=s3cfg_cos`</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.backups.bucket=gitlab-backup-test-xcw-1254024480 <span style="color: #8b2252;">\</span>
     --set global.appConfig.backups.tmpBucket=gitlab-backup-tmp-test-xcw-1254024480 <span style="color: #8b2252;">\</span>
     --set gitlab.task-runner.backups.objectStorage.config.secret=task-runenr-s3-config <span style="color: #8b2252;">\</span>
     --set gitlab.task-runner.backups.objectStorage.config.key=config <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#30417;&#25511;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus#configuration`</span> <span style="color: #8b2252;">\</span>
     --set prometheus.server.persistentVolume.storageClass=gitlab-storageclass-test-xcw <span style="color: #8b2252;">\</span>
     --set prometheus.server.persistentVolume.accessModes={ReadWriteMany} <span style="color: #8b2252;">\</span>
     --set prometheus.server.persistentVolume.size=10Gi <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#22806;&#21457;&#30005;&#23376;&#37038;&#20214;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/installation/command-line-options.html#outgoing-email-configuration`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#kubectl --namespace=gitlab create secret generic gitlab-smtp-password --from-literal=password=yourpasswordhere`</span> <span style="color: #8b2252;">\</span>
     --set global.email.from=gitlab@cicihuzi.com <span style="color: #8b2252;">\</span>
     --set global.email.display_name=<span style="color: #8b2252;">'GitLab'</span> <span style="color: #8b2252;">\</span>
     --set global.smtp.enabled=true <span style="color: #8b2252;">\</span>
     --set global.smtp.address=smtp.exmail.qq.com <span style="color: #8b2252;">\</span>
     --set global.smtp.tls=true <span style="color: #8b2252;">\</span>
     --set global.smtp.port=456 <span style="color: #8b2252;">\</span>
     --set global.smtp.user_name=<span style="color: #8b2252;">"gitlab@cicihuzi.com"</span> <span style="color: #8b2252;">\</span>
     --set global.smtp.password.secret=<span style="color: #8b2252;">"gitlab-test-smtp"</span> <span style="color: #8b2252;">\</span>
     --set global.smtp.password.key=password <span style="color: #8b2252;">\</span>
     --set global.smtp.authentication=<span style="color: #8b2252;">"login"</span> <span style="color: #8b2252;">\</span>
     --set global.smtp.starttls_auto=true <span style="color: #8b2252;">\</span>
     --set global.smtp.pool=true <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--rbac--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/installation/deployment.html#rbac`</span> <span style="color: #8b2252;">\</span>
     --set certmanager.rbac.create=false <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--cpu&#21644;&#20869;&#23384;&#37197;&#32622;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#26368;&#23567;&#21270;&#37197;&#32622; https://docs.gitlab.com/charts/installation/deployment.html#cpu-and-ram-resource-requirements`</span> <span style="color: #8b2252;">\</span>
     --set gitlab-runner.install=false <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.replicaCount=3 <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.minAvailable=2 <span style="color: #8b2252;">\</span>
     --set nginx-ingress.defaultBackend.replicaCount=2 <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#26102;&#21306;`</span> <span style="color: #8b2252;">\</span>
     --set global.time_zone=Asia/Shanghai <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--ldap&#37197;&#32622;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/charts/globals.html#ldap`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/ee/administration/auth/ldap/`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#kubectl --namespace=gitlab create secret generic gitlab-ldap-password --from-literal=password=yourpasswordhere`</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.label=<span style="color: #8b2252;">'LDAP'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.host=<span style="color: #8b2252;">'ldap.cici.com'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.port=<span style="color: #8b2252;">'389'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.uid=<span style="color: #8b2252;">'cn'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.bind_dn=<span style="color: #8b2252;">'cn=gitlab_admin\,ou=sys_admins\,dc=cici\,dc=com'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.base=<span style="color: #8b2252;">'ou=staff\,dc=cici\,dc=com'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.encryption=<span style="color: #8b2252;">'plain'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.password.secret=<span style="color: #8b2252;">'gitlab-test-ldap'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.password.key=<span style="color: #8b2252;">'password'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.user_filter=<span style="color: #8b2252;">'(&amp;(memberOf=cn=rds\,ou=groups\,dc=cici\,dc=com))'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.attributes.username=<span style="color: #8b2252;">'[cn]'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.attributes.email=<span style="color: #8b2252;">'[mail\, email]'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.attributes.name=<span style="color: #8b2252;">'displayName'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.attributes.first_name=<span style="color: #8b2252;">'givenName'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.attributes.last_name=<span style="color: #8b2252;">'sn'</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.ldap.servers.main.allow_username_or_email_login=true <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--omniauth&#35748;&#35777;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/charts/globals#omniauth`</span> <span style="color: #8b2252;">\</span>
     --set global.appConfig.omniauth.enabled=true <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#33258;&#21160;&#22791;&#20221;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#https://docs.gitlab.com/charts/backup-restore/index.html`</span> <span style="color: #8b2252;">\</span>
     --set gitlab.task-runner.backups.cron.enabled=true <span style="color: #8b2252;">\</span>
     --set gitlab.task-runner.backups.cron.schedule=<span style="color: #8b2252;">'0 2 * * *'</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#19978;&#20256;&#38480;&#21046;--`</span> <span style="color: #8b2252;">\</span>
     --set global.ingress.proxyBodySize=10Gi <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--qos&#26381;&#21153;&#36136;&#37327;--`</span> <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.resources.requests.cpu=<span style="color: #8b2252;">'100m'</span> <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.resources.requests.memory=<span style="color: #8b2252;">'100Mi'</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--3k&#29992;&#25143;--`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#&#24320;&#21551;gitaly&#20195;&#29702;pracefect&#65292;&#21551;&#21160;gitaly&#38598;&#32676;`</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#praefect&#21551;&#21160;&#38480;&#21046;&#65292;&#23433;&#35013;&#21518;&#21019;&#24314;&#23545;&#24212;&#24211;https://docs.gitlab.com/charts/charts/gitlab/praefect/index.html`</span> <span style="color: #8b2252;">\</span>
     --set global.praefect.enabled=true <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#33258;&#23450;&#20041;&#38236;&#20687;--`</span> <span style="color: #8b2252;">\</span>
     --set global.kubectl.image.repository=docker.cici.com/library/gitlab/kubectl <span style="color: #8b2252;">\</span>
     --set global.kubectl.image.tag=<span style="color: #8b2252;">"1.16.15"</span> <span style="color: #8b2252;">\</span>
     --set global.certificates.image.repository=docker.cici.com/library/gitlab/alpine-certificates <span style="color: #8b2252;">\</span>
     --set global.certificates.image.tag=<span style="color: #8b2252;">"20191127-r2"</span> <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.image.repository=docker.cici.com/library/gitlab/nginx-ingress-controller <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.image.tag=<span style="color: #8b2252;">"v0.41.2"</span> <span style="color: #8b2252;">\</span>
     --set nginx-ingress.controller.image.digest=<span style="color: #8b2252;">""</span> <span style="color: #8b2252;">\</span>
     --set nginx-ingress.defaultBackend.image.repository=docker.cici.com/library/gitlab/defaultbackend-amd64 <span style="color: #8b2252;">\</span>
     --set nginx-ingress.defaultBackend.image.tag=<span style="color: #8b2252;">"1.5"</span> <span style="color: #8b2252;">\</span>
     --set gitlab.task-runner.image.repository=docker.cici.com/library/gitlab/gitlab-toolbox-ee <span style="color: #8b2252;">\</span>
     --set gitlab.task-runner.image.tag=<span style="color: #8b2252;">"v14.2.1"</span> <span style="color: #8b2252;">\</span>
     --set gitlab.migrations.image.repository=docker.cici.com/library/gitlab/gitlab-toolbox-ee <span style="color: #8b2252;">\</span>
     --set gitlab.migrations.image.tag=<span style="color: #8b2252;">"v14.2.1"</span> <span style="color: #8b2252;">\</span>
     --set gitlab.gitaly.image.repository=docker.cici.com/library/gitlab/gitaly <span style="color: #8b2252;">\</span>
     --set gitlab.gitaly.image.tag=<span style="color: #8b2252;">"v14.2.1"</span> <span style="color: #8b2252;">\</span>
     --set gitlab.praefect.image.repository=docker.cici.com/library/gitlab/gitaly <span style="color: #8b2252;">\</span>
     --set gitlab.praefect.image.tag=<span style="color: #8b2252;">"v14.2.1"</span> <span style="color: #8b2252;">\</span>
     --set gitlab.sidekiq.image.repository=docker.cici.com/library/gitlab/gitlab-sidekiq-ee <span style="color: #8b2252;">\</span>
     --set gitlab.sidekiq.image.tag=<span style="color: #8b2252;">"v14.2.1"</span> <span style="color: #8b2252;">\</span>
     --set gitlab.gitlab-shell.image.repository=docker.cici.com/library/gitlab/gitlab-shell <span style="color: #8b2252;">\</span>
     --set gitlab.gitlab-shell.image.tag=<span style="color: #8b2252;">"v13.19.1"</span> <span style="color: #8b2252;">\</span>
     --set gitlab.webservice.image.repository=docker.cici.com/library/gitlab/gitlab-webservice-ee <span style="color: #8b2252;">\</span>
     --set gitlab.webservice.image.tag=<span style="color: #8b2252;">"v14.2.1"</span> <span style="color: #8b2252;">\</span>
     --set gitlab.webservice.workhorse.image=docker.cici.com/library/gitlab/gitlab-workhorse-ee <span style="color: #8b2252;">\</span>
     --set gitlab.webservice.workhorse.tag=<span style="color: #8b2252;">"v14.2.1"</span> <span style="color: #8b2252;">\</span>
     --set registry.image.repository=docker.cici.com/library/gitlab/gitlab-container-registry <span style="color: #8b2252;">\</span>
     --set registry.image.tag=<span style="color: #8b2252;">"v3.9.0-gitlab"</span> <span style="color: #8b2252;">\</span>
     --set postgresql.image.repository=docker.cici.com/library/gitlab/postgresql <span style="color: #8b2252;">\</span>
     --set postgresql.image.tag=<span style="color: #8b2252;">"12.7.0"</span> <span style="color: #8b2252;">\</span>
     --set redis.image.repository=docker.cici.com/library/gitlab/redis <span style="color: #8b2252;">\</span>
     --set redis.image.tag=<span style="color: #8b2252;">"6.0.9-debian-10-r0"</span> <span style="color: #8b2252;">\</span>
     --set gitlab-runner.image=docker.cici.com/library/gitlab/gitlab-runner:alpine-v14.2.0 <span style="color: #8b2252;">\</span>
     --set gitlab.gitlab-exporter.image.repository=docker.cici.com/library/gitlab/gitlab-exporter <span style="color: #8b2252;">\</span>
     --set gitlab.gitlab-exporter.image.tag=<span style="color: #8b2252;">"11.2.0"</span> <span style="color: #8b2252;">\</span>
     --set global.busybox.image.repository=docker.cici.com/library/gitlab/busybox <span style="color: #8b2252;">\</span>
     --set global.busybox.image.tag=latest

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21021;&#27425;&#30331;&#24405;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">kubectl -n gitlab-test-xcw  get secret gitlab-test-xcw-gitlab-initial-root-password -ojsonpath='{.data.password}' | base64 --decode ; echo</span>
</pre>
</div>

<p>
3k用户
如果启动了3k用户集群，pracefect是无法运行的。请查看对应后续操作 <a href="https://docs.gitlab.com/charts/charts/gitlab/praefect/index.html">Praefect chart(alpha)</a>
创建praefect连接的postgresql库praefect
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b22222;">#</span><span style="color: #b22222;">1&#30331;&#24405;&#21040;&#24744;&#30340;&#25968;&#25454;&#24211;&#23454;&#20363;</span>
kubectl -n gitlab-test-xcw  exec -it $(<span style="color: #ff00ff;">kubectl -n gitlab-test-xcw get pods -l app=postgresql -o custom-columns=NAME:.metadata.name --no-headers</span>) -- bash
<span style="color: #a0522d;">PGPASSWORD</span>=$(<span style="color: #ff00ff;">cat $POSTGRES_POSTGRES_PASSWORD_FILE</span>) psql -U postgres -d template1
<span style="color: #b22222;">#</span><span style="color: #b22222;">2&#21019;&#24314;&#25968;&#25454;&#24211;&#29992;&#25143;</span>
CREATE ROLE praefect WITH LOGIN;
<span style="color: #b22222;">#</span><span style="color: #b22222;">3&#35774;&#32622;&#25968;&#25454;&#24211;&#29992;&#25143;&#23494;&#30721;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#23494;&#30721;</span>
kubectl -n gitlab-test-xcw get secret  gitlab-test-xcw-praefect-dbsecret -o <span style="color: #a0522d;">jsonpath</span>=<span style="color: #8b2252;">"{.data.secret}"</span> | base64 --decode
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;psql&#25552;&#31034;&#20013;&#35774;&#32622;&#23494;&#30721;</span>
\password praefect
<span style="color: #b22222;">#</span><span style="color: #b22222;">4&#21019;&#24314;&#25968;&#25454;&#24211;&#65306;</span>
CREATE DATABASE praefect WITH OWNER praefect;
</pre>
</div>
</div>
</div>
<div id="outline-container-org82f7c4c" class="outline-5">
<h5 id="org82f7c4c">卸载</h5>
<div class="outline-text-5" id="text-org82f7c4c">
<div class="org-src-container">
<pre class="src src-bash">helm uninstall  -n gitlab-test-xcw  gitlab-test-xcw

cat &lt;&lt;\EOF&gt; delete_gitlab_secrets.sh
<span style="color: #ffa54f;">#!/bin/bash</span>

<span style="color: #ffa54f;">NS=gitlab-test-xcw</span>
<span style="color: #ffa54f;">RELEASE_NAME=gitlab-test-xcw</span>
<span style="color: #ffa54f;">kubectl -n $NS delete secrets \</span>
<span style="color: #ffa54f;">        gitlab-rails-storage \</span>
<span style="color: #ffa54f;">        gitlab-registry \</span>
<span style="color: #ffa54f;">        task-runenr-s3-config \</span>
<span style="color: #ffa54f;">        gitlab-test-pg \</span>
<span style="color: #ffa54f;">        gitlab-test-redis \</span>
<span style="color: #ffa54f;">        gitlab-test-ldap \</span>
<span style="color: #ffa54f;">        gitlab-test-smtp \</span>
<span style="color: #ffa54f;">        cici-com \</span>
<span style="color: #ffa54f;">        gitlab-artifacts \</span>
<span style="color: #ffa54f;">        gitlab-lfs \</span>
<span style="color: #ffa54f;">        gitlab-packages \</span>
<span style="color: #ffa54f;">        gitlab-uploads \</span>
<span style="color: #ffa54f;">        gitlab-pseudonymizer \</span>
<span style="color: #ffa54f;">        `#&#33258;&#21160;&#21019;&#24314;&#30340;` \</span>
<span style="color: #ffa54f;">        ${RELEASE_NAME}-gitaly-secret \</span>
<span style="color: #ffa54f;">        ${RELEASE_NAME}-gitlab-initial-root-password \</span>
<span style="color: #ffa54f;">        ${RELEASE_NAME}-gitlab-runner-secret \</span>
<span style="color: #ffa54f;">        ${RELEASE_NAME}-gitlab-shell-host-keys \</span>
<span style="color: #ffa54f;">        ${RELEASE_NAME}-gitlab-shell-secret \</span>
<span style="color: #ffa54f;">        ${RELEASE_NAME}-gitlab-workhorse-secret \</span>
<span style="color: #ffa54f;">        ${RELEASE_NAME}-rails-secret \</span>
<span style="color: #ffa54f;">        ${RELEASE_NAME}-registry-httpsecret \</span>
<span style="color: #ffa54f;">        ${RELEASE_NAME}-registry-notification \</span>
<span style="color: #ffa54f;">        ${RELEASE_NAME}-registry-secret \</span>
<span style="color: #ffa54f;">        ${RELEASE_NAME}-postgresql-password \</span>
<span style="color: #ffa54f;">        ${RELEASE_NAME}-redis-secret</span>

<span style="color: #ffa54f;">kubectl -n $NS delete cm ingress-controller-leader-gitlab-test-xcw-nginx</span>
<span style="color: #ffa54f;">echo "delete secrets Complete"</span>

<span style="color: #ffa54f;">echo "&#35831;&#27714;&#26597;&#30475;&#23545;&#24212;PVPVC&#32465;&#23450;&#24773;&#20917;&#65292;&#21487;&#21024;&#38500;"</span>
<span style="color: #ffa54f;">kubectl get pv |grep test-xcw</span>
<span style="color: #ffa54f;">kubectl -n gitlab-test-xcw get pvc</span>
<span style="color: #ffa54f;">kubectl get sc |grep gitlab</span>
<span style="color: #ffa54f;">EOF</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-orga34a1e5" class="outline-5">
<h5 id="orga34a1e5">破解</h5>
<div class="outline-text-5" id="text-orga34a1e5">
<p>
<a href="https://tangcuxa.club/gielab-ee-xu-ke-zheng/">破解参考</a>
</p>

<p>
<a href="https://blog.starudream.cn/2020/01/19/6-crack-gitlab/">https://blog.starudream.cn/2020/01/19/6-crack-gitlab/</a>
</p>
</div>
<ul class="org-ul">
<li><a id="orga5b61c4"></a>准备文件-license.rb<br>
<div class="outline-text-6" id="text-orga5b61c4">
<p>
直接从docker镜像中复制下来修改。如
</p>

<div class="org-src-container">
<pre class="src src-bash">docker pull  registry.gitlab.com/gitlab-org/build/cng/gitlab-toolbox-ee:v14.2.1

docker run --rm -d --name temp registry.gitlab.com/gitlab-org/build/cng/gitlab-toolbox-ee:v14.2.1 sleep 10
docker cp temp:/srv/gitlab/ee/app/models/license.rb .
</pre>
</div>

<p>
添加有效期license.rb
</p>

<div class="org-src-container">
<pre class="src src-bash">  def license
    <span style="color: #a020f0;">return</span> unless self.data

    @license ||=
      begin
        Gitlab::License.import(self.data)
      rescue Gitlab::License::ImportError
        nil
      end

<span style="color: #b22222;">#</span><span style="color: #b22222;">-----add</span>
    <span style="color: #a020f0;">if</span> @license
      @license.expires_at = Date.new(2028,12,16)
      @license.notify_admins_at = Date.new(2028,12,16)
      @license.notify_users_at = Date.new(2028,12,16)
      @license.restrictions[:active_user_count] = 5000
      @license.restrictions[:add_ons][:GitLab_Geo] = 5000
      @license.restrictions[:add_ons][:GitLab_FileLocks] = 5000
      @license.restrictions[:add_ons][:GitLab_ServiceDesk] = 5000
      @license.restrictions[:add_ons][:GitLab_DeployBoard] = 5000
      @license.restrictions[:add_ons][:GitLab_Auditor_User] = 5000
    end
    @license
<span style="color: #b22222;">#</span><span style="color: #b22222;">-----</span>
  end
</pre>
</div>
</div>
</li>
<li><a id="org435e0a4"></a>准备文件-files_denylist.yml<br>
<div class="outline-text-6" id="text-org435e0a4">
<p>
<a href="https://docs.gitlab.com/ee/push_rules/push_rules.html#prevent-pushing-secrets-to-the-repository">防止将机密推送到存储库</a>
</p>

<p>
注释了(pem|key)，允许往gitlab中提交`.pem`, `.key`文件
</p>

<p>
之前版本文件名为files_blacklist.yml（&lt;=4.0.12）
</p>

<div class="org-src-container">
<pre class="src src-bash">docker pull  registry.gitlab.com/gitlab-org/build/cng/gitlab-toolbox-ee:v14.2.1

docker run --rm -d --name temp registry.gitlab.com/gitlab-org/build/cng/gitlab-toolbox-ee:v14.2.1 sleep 10
docker cp temp:/srv/gitlab/ee/lib/gitlab/checks/files_denylist.yml .

cat &lt;&lt;\EOF&gt; files_denylist.yml
<span style="color: #ffa54f;">- aws\/credentials$</span>
<span style="color: #ffa54f;"># RSA DSA ECSDA and ED25519 SSH keys</span>
<span style="color: #ffa54f;">- (ssh|config)\/(personal|server)_(rsa|dsa|ed\d+|ecdsa)</span>
<span style="color: #ffa54f;">- id_rsa$</span>
<span style="color: #ffa54f;">- id_dsa$</span>
<span style="color: #ffa54f;">- id_ed25519$</span>
<span style="color: #ffa54f;">- id_ecdsa$</span>
<span style="color: #ffa54f;"># privatekey.pem and secret.key</span>
<span style="color: #ffa54f;"># - \.(pem|key)$</span>

<span style="color: #ffa54f;"># files ending in .history or _history</span>
<span style="color: #ffa54f;">- "[._]history$"</span>
<span style="color: #ffa54f;">- ".DS_Store"</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>
</div>
</li>
<li><a id="orga6d5340"></a>ruby生成lisence<br>
<div class="outline-text-6" id="text-orga6d5340">
<p>
生成一次就行，可持续使用
</p>

<div class="org-src-container">
<pre class="src src-bash">cat &lt;&lt;\EOF&gt; l.rb
<span style="color: #ffa54f;">require 'openssl'</span>
<span style="color: #ffa54f;">require 'gitlab/license'</span>
<span style="color: #ffa54f;">key_pair = OpenSSL::PKey::RSA.generate(2048)</span>
<span style="color: #ffa54f;">File.open("license_key", "w") { |f| f.write(key_pair.to_pem) }</span>
<span style="color: #ffa54f;">public_key = key_pair.public_key</span>
<span style="color: #ffa54f;">File.open("license_key.pub", "w") { |f| f.write(public_key.to_pem) }</span>
<span style="color: #ffa54f;">private_key = OpenSSL::PKey::RSA.new File.read("license_key")</span>
<span style="color: #ffa54f;">Gitlab::License.encryption_key = private_key</span>
<span style="color: #ffa54f;">license = Gitlab::License.new</span>
<span style="color: #ffa54f;">license.licensee = {</span>
<span style="color: #ffa54f;">  "Name"    =&gt; "none",</span>
<span style="color: #ffa54f;">  "Company" =&gt; "none",</span>
<span style="color: #ffa54f;">  "Email"   =&gt; "ex@mail.com"</span>
<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">license.starts_at         = Date.new(2021, 1, 1)</span>
<span style="color: #ffa54f;">license.restrictions  = {</span>
<span style="color: #ffa54f;">  plan: 'ultimate'</span>
<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">puts "License:"</span>
<span style="color: #ffa54f;">puts license</span>
<span style="color: #ffa54f;">data = license.export</span>
<span style="color: #ffa54f;">puts "Exported license:"</span>
<span style="color: #ffa54f;">puts data</span>
<span style="color: #ffa54f;">File.open("GitLabBV.gitlab-license", "w") { |f| f.write(data) }</span>
<span style="color: #ffa54f;">public_key = OpenSSL::PKey::RSA.new File.read("license_key.pub")</span>
<span style="color: #ffa54f;">Gitlab::License.encryption_key = public_key</span>
<span style="color: #ffa54f;">data = File.read("GitLabBV.gitlab-license")</span>
<span style="color: #ffa54f;">$license = Gitlab::License.import(data)</span>
<span style="color: #ffa54f;">puts "Imported license:"</span>
<span style="color: #ffa54f;">puts $license</span>
<span style="color: #ffa54f;">unless $license</span>
<span style="color: #ffa54f;">  raise "The license is invalid."</span>
<span style="color: #ffa54f;">end</span>
<span style="color: #ffa54f;">if $license.restricted?(:active_user_count)</span>
<span style="color: #ffa54f;">  active_user_count = User.active.count</span>
<span style="color: #ffa54f;">  if active_user_count &gt; $license.restrictions[:active_user_count]</span>
<span style="color: #ffa54f;">    raise "The active user count exceeds the allowed amount!"</span>
<span style="color: #ffa54f;">  end</span>
<span style="color: #ffa54f;">end</span>
<span style="color: #ffa54f;">if $license.notify_admins?</span>
<span style="color: #ffa54f;">  puts "The license is due to expire on #{$license.expires_at}."</span>
<span style="color: #ffa54f;">end</span>
<span style="color: #ffa54f;">if $license.notify_users?</span>
<span style="color: #ffa54f;">  puts "The license is due to expire on #{$license.expires_at}."</span>
<span style="color: #ffa54f;">end</span>
<span style="color: #ffa54f;">module Gitlab</span>
<span style="color: #ffa54f;">  class GitAccess</span>
<span style="color: #ffa54f;">    def check(cmd, changes = nil)</span>
<span style="color: #ffa54f;">      if $license.block_changes?</span>
<span style="color: #ffa54f;">        return build_status_object(false, "License expired")</span>
<span style="color: #ffa54f;">      end</span>
<span style="color: #ffa54f;">    end</span>
<span style="color: #ffa54f;">  end</span>
<span style="color: #ffa54f;">end</span>
<span style="color: #ffa54f;">puts "This instance of GitLab Enterprise Edition is licensed to:"</span>
<span style="color: #ffa54f;">$license.licensee.each do |key, value|</span>
<span style="color: #ffa54f;">  puts "#{key}: #{value}"</span>
<span style="color: #ffa54f;">end</span>
<span style="color: #ffa54f;">if $license.expired?</span>
<span style="color: #ffa54f;">  puts "The license expired on #{$license.expires_at}"</span>
<span style="color: #ffa54f;">elsif $license.will_expire?</span>
<span style="color: #ffa54f;">  puts "The license will expire on #{$license.expires_at}"</span>
<span style="color: #ffa54f;">else</span>
<span style="color: #ffa54f;">  puts "The license will never expire."</span>
<span style="color: #ffa54f;">end</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
docker-compose
</p>

<div class="org-src-container">
<pre class="src src-bash">cat &lt;&lt;\EOF&gt; docker-compose.yml
<span style="color: #ffa54f;">version: '3'</span>

<span style="color: #ffa54f;">services:</span>
<span style="color: #ffa54f;">  ruby:</span>
<span style="color: #ffa54f;">    image: 'ruby:latest'</span>
<span style="color: #ffa54f;">    hostname: ruby</span>
<span style="color: #ffa54f;">    command: bash -c "cd /root/test &amp;&amp; gem install gitlab-license &amp;&amp; rm GitLabBV.gitlab-license license_key license_key.pub &amp;&amp; ruby license.rb"</span>
<span style="color: #ffa54f;">    volumes:</span>
<span style="color: #ffa54f;">      - './:/root/test:Z'</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
脚本目录下会生成三个文件:
</p>

<ul class="org-ul">
<li>license_key 为私钥</li>
<li>license_key.pub 为公钥。替换/opt/gitlab/embedded/service/gitlab-rails/.license_encryption_key.pub</li>
<li>GitLabBV.gitlab-license 为 license 文件</li>
</ul>

<p>
导入许可：
</p>
<ul class="org-ul">
<li>登录gitlab后台，管理中心-&gt;许可证 (/admin/license)，导入 GitLabBV.gitlab-license</li>
</ul>
</div>
</li>
<li><a id="org1479ead"></a>镜像制作<br>
<div class="outline-text-6" id="text-org1479ead">
<p>
需要破解的镜像
</p>

<ul class="org-ul">
<li>registry.gitlab.com/gitlab-org/build/cng/gitlab-sidekiq-ee:v14.2.1</li>
<li>registry.gitlab.com/gitlab-org/build/cng/gitlab-toolbox-ee:v14.2.1</li>
<li>registry.gitlab.com/gitlab-org/build/cng/gitlab-webservice-ee:v14.2.1</li>
</ul>
</div>
<ul class="org-ul">
<li><a id="orgfc3f6da"></a>镜像文件Dockerfile<br>
<div class="outline-text-7" id="text-orgfc3f6da">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b22222;">#</span><span style="color: #b22222;">task-runner</span>
cat &lt;&lt;\EOF&gt; task-runner-Dockerfile
<span style="color: #ffa54f;">FROM registry.gitlab.com/gitlab-org/build/cng/gitlab-toolbox-ee:v14.2.1</span>
<span style="color: #ffa54f;">#FROM docker.cici.com/library/gitlab/gitlab-toolbox-ee:v14.2.1</span>
<span style="color: #ffa54f;">#COPY ./license.rb /srv/gitlab/ee/app/models/license.rb</span>
<span style="color: #ffa54f;">COPY ./license_key.pub /srv/gitlab/.license_encryption_key.pub</span>
<span style="color: #ffa54f;">COPY ./files_denylist.yml /srv/gitlab/ee/lib/gitlab/checks/files_denylist.yml</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">sidekiq</span>
cat &lt;&lt;\EOF&gt; sidekiq-Dockerfile
<span style="color: #ffa54f;">FROM registry.gitlab.com/gitlab-org/build/cng/gitlab-sidekiq-ee:v14.2.1</span>
<span style="color: #ffa54f;">#FROM docker.cici.com/library/gitlab/gitlab-sidekiq-ee:v14.2.1</span>
<span style="color: #ffa54f;">#COPY ./license.rb /srv/gitlab/ee/app/models/license.rb</span>
<span style="color: #ffa54f;">COPY ./license_key.pub /srv/gitlab/.license_encryption_key.pub</span>
<span style="color: #ffa54f;">COPY ./files_denylist.yml /srv/gitlab/ee/lib/gitlab/checks/files_denylist.yml</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">webservice</span>
cat &lt;&lt;\EOF&gt; webservice-Dockerfile
<span style="color: #ffa54f;">FROM registry.gitlab.com/gitlab-org/build/cng/gitlab-webservice-ee:v14.2.1</span>
<span style="color: #ffa54f;">#FROM docker.cici.com/library/gitlab/gitlab-webservice-ee:v14.2.1</span>
<span style="color: #ffa54f;">#COPY ./license.rb /srv/gitlab/ee/app/models/license.rb</span>
<span style="color: #ffa54f;">COPY ./license_key.pub /srv/gitlab/.license_encryption_key.pub</span>
<span style="color: #ffa54f;">COPY ./files_denylist.yml /srv/gitlab/ee/lib/gitlab/checks/files_denylist.yml</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>
</div>
</li>
<li><a id="orga898607"></a>制作镜像<br>
<div class="outline-text-7" id="text-orga898607">
<div class="org-src-container">
<pre class="src src-bash">cat &lt;&lt;\EOF&gt; build.sh
<span style="color: #ffa54f;">#!/bin/bash</span>
<span style="color: #ffa54f;">docker build -t docker.cici.com/library/gitlab/$1 -f $2 .</span>
<span style="color: #ffa54f;">docker push  docker.cici.com/library/gitlab/$1</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">Task-runner</span>
bash build.sh gitlab-toolbox-ee:v14.2.1-x1  task-runner-Dockerfile
<span style="color: #b22222;">#</span><span style="color: #b22222;">Sidekiq</span>
bash build.sh gitlab-sidekiq-ee:v14.2.1-x1 sidekiq-Dockerfile
<span style="color: #b22222;">#</span><span style="color: #b22222;">webservice</span>
bash build.sh gitlab-webservice-ee:v14.2.1-x1 webservice-Dockerfile
</pre>
</div>


<p>
gitlab 12.3.1-ee helm2.17.0
pod:tiller-deploy clustrolebinding: helm
</p>
<div class="org-src-container">
<pre class="src src-shell">helm upgrade --install gitlab-test-xcw gitlab/gitlab <span style="color: #8b2252;">\</span>
     --timeout 600s <span style="color: #8b2252;">\</span>
     --set global.hosts.domain=gitlab-test-xcw.cici.com <span style="color: #8b2252;">\</span>
     --set global.hosts.externalIP=10.22.0.128 <span style="color: #8b2252;">\</span>
     --set certmanager-issuer.email=xuchangwei@cici-inc.com <span style="color: #8b2252;">\</span>
     --version=2.3.2 <span style="color: #8b2252;">\</span>
     -n gitlab-test-xcw --dry-run
</pre>
</div>
</div>
</li>
</ul>
</li>
</ul>
</div>
<div id="outline-container-org960275d" class="outline-5">
<h5 id="org960275d">部署脚本</h5>
<div class="outline-text-5" id="text-org960275d">
<p>
下载对应版本gilab chart至本地，将有差异的部署参数单独写入文件，方便后期修正。
</p>

<div class="org-src-container">
<pre class="src src-bash">helm get values -n gitlab-test-xcw  gitlab-test-xcw  &gt;customize_conf/values-test.yaml
</pre>
</div>

<p>
部署
</p>

<div class="org-src-container">
<pre class="src src-bash">cat &lt;&lt;\EOF&gt; deploy-gitlab-test.sh
<span style="color: #ffa54f;">helm upgrade --install -n gitlab-test-xcw gitlab-test-xcw gitlab/gitlab \</span>
<span style="color: #ffa54f;">     --timeout 600s \</span>
<span style="color: #ffa54f;">     --version=5.2.1 \</span>
<span style="color: #ffa54f;">     --dry-run \</span>
<span style="color: #ffa54f;">     -f customize_conf/values-test.yaml \</span>
<span style="color: #ffa54f;">     --set global.hosts.gitlab.name='git-test-xcw.cici.com' \</span>
<span style="color: #ffa54f;">     `#--&#22806;&#37096;postgresql--` \</span>
<span style="color: #ffa54f;">     `#--set postgresql.install=false` \</span>
<span style="color: #ffa54f;">     `#--set global.psql.host=production.postgress.hostname.local` \</span>
<span style="color: #ffa54f;">     `#--set global.psql.password.secret=gitlab-test-pg` \</span>
<span style="color: #ffa54f;">     `#--set global.psql.password.key='password'` \</span>
<span style="color: #ffa54f;">     `#--&#22806;&#37096;redis--` \</span>
<span style="color: #ffa54f;">     `#--set redis.enabled=false` \</span>
<span style="color: #ffa54f;">     `#--set global.redis.host='redis.example.com'` \</span>
<span style="color: #ffa54f;">     `#--set global.redis.password.secret=gitlab-test-redis` \</span>
<span style="color: #ffa54f;">     `#--set global.redis.password.key='password'` \</span>
<span style="color: #ffa54f;">     --set gitlab.migrations.enabled=true </span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org8c47928" class="outline-4">
<h4 id="org8c47928">性能测试</h4>
<div class="outline-text-4" id="text-org8c47928">
<p>
token:9xDp6842xU7_ZGcjcHY
</p>

<p>
性能测试：<a href="https://docs.gitlab.com/ee/administration/reference_architectures/">架构参考</a>
</p>

<p>
部署参考：<a href="https://gitlab.com/gitlab-org/quality/performance">GitLab Performance Tool</a>
</p>
</div>
<div id="outline-container-org06a9a82" class="outline-5">
<h5 id="org06a9a82">准备数据环境</h5>
<div class="outline-text-5" id="text-org06a9a82">
<p>
数据分为，垂直和水平：
</p>

<ul class="org-ul">
<li>垂直：该区域由一个或多个大型项目组成。默认GitLab FOSS项目gitlabhq</li>
<li>横向：该区域由大量子组组成，每个子组又包含大量项目。</li>
</ul>

<div class="org-src-container">
<pre class="src src-bash">mkdir /data/gitlab-gpt/{results,config/{environments,projects}} -p
<span style="color: #483d8b;">cd</span>  /data/gitlab-gpt/config/environments
cat &lt;&lt;\EOF&gt; 10k.json
<span style="color: #ffa54f;">{</span>
<span style="color: #ffa54f;">  "environment": {</span>
<span style="color: #ffa54f;">    "name": "10k",</span>
<span style="color: #ffa54f;">    "url": "https://git-test-xcw.cici.com",</span>
<span style="color: #ffa54f;">    "user": "gpt-admin",</span>
<span style="color: #ffa54f;">    "config": {</span>
<span style="color: #ffa54f;">      "latency": "0"</span>
<span style="color: #ffa54f;">    },</span>
<span style="color: #ffa54f;">    "storage_nodes": ["default"]</span>
<span style="color: #ffa54f;">  },</span>
<span style="color: #ffa54f;">  "gpt_data": {</span>
<span style="color: #ffa54f;">    "root_group": "gpt",</span>
<span style="color: #ffa54f;">    "large_projects": {</span>
<span style="color: #ffa54f;">      "group": "large_projects",</span>
<span style="color: #ffa54f;">      "project": "gitlabhq"</span>
<span style="color: #ffa54f;">    },</span>
<span style="color: #ffa54f;">    "many_groups_and_projects": {</span>
<span style="color: #ffa54f;">      "group": "many_groups_and_projects",</span>
<span style="color: #ffa54f;">      "subgroups": 250,</span>
<span style="color: #ffa54f;">      "subgroup_prefix": "gpt-subgroup-",</span>
<span style="color: #ffa54f;">      "projects": 10,</span>
<span style="color: #ffa54f;">      "project_prefix": "gpt-project-"</span>
<span style="color: #ffa54f;">    }</span>
<span style="color: #ffa54f;">  }</span>
<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">EOF</span>

: &lt;&lt;eof
<span style="color: #ffa54f;">&#36890;&#24120;&#21482;&#38656;&#35201;&#25913;&#21464;&#65306;name&#65292;url&#65292;user&#21644;storage_nodes</span>
<span style="color: #ffa54f;">name- &#29615;&#22659;&#30340;&#21517;&#31216;&#12290;&#20027;&#35201;&#29992;&#20110;&#36755;&#20986;&#21644;&#32467;&#26524;</span>
<span style="color: #ffa54f;">url- &#29615;&#22659;&#30340;&#23436;&#25972; URL&#65292;&#29992;&#20110;&#25152;&#26377;&#27979;&#35797;&#21644;&#20854;&#20182;&#21306;&#22495;&#12290;</span>
<span style="color: #ffa54f;">user- &#20316;&#20026;&#21019;&#24314;&#29992;&#25143;&#27493;&#39588;&#30340;&#19968;&#37096;&#20998;&#20934;&#22791;&#30340;&#29992;&#25143;&#21517;&#31216;&#12290;</span>
<span style="color: #ffa54f;">storage_nodes-&#30446;&#26631; GitLab &#29615;&#22659;&#20013;&#30340;&#23384;&#20648;&#24211;&#23384;&#20648;&#38453;&#21015;</span>
<span style="color: #ffa54f;">eof</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22823;&#39033;&#30446;&#27604;&#36739;&#22823;&#65292;ingress&#24320;&#25918;&#19978;&#20256;&#38480;&#21046;</span>
docker run --rm -it <span style="color: #8b2252;">\</span>
  -e <span style="color: #a0522d;">ACCESS_TOKEN</span>=MnLzZsfPNF-Bgtmomgsm <span style="color: #8b2252;">\</span>
  -v /data/gitlab-gpt/config:/config <span style="color: #8b2252;">\</span>
  -v /data/gitlab-gpt/results:/results <span style="color: #8b2252;">\</span>
  --add-host git-test-xcw.cici.com:10.22.0.207 <span style="color: #8b2252;">\</span>
  gitlab/gpt-data-generator <span style="color: #8b2252;">\</span>
  --environment 10k.json

<span style="color: #b22222;">#</span><span style="color: #b22222;">--no-horizontal #&#19981;&#23548;&#20837;&#27700;&#24179;&#25968;&#25454;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">--no-vertical   #&#19981;&#23548;&#20837;&#22402;&#30452;&#25968;&#25454;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20837;&#33258;&#23450;&#20041;&#39033;&#30446;docker run --rm -it   -e ACCESS_TOKEN=MnLzZsfPNF-Bgtmomgsm   -v /data/gitlab-gpt/config:/config   -v /data/gitlab-gpt/results:/results   --add-host git-test-xcw.cici.com:10.22.0.207   gitlab/gpt-data-generator   --environment 10k.json  --no-horizontal  --large-project-tarball=/config/gitlabhq_export_13.0.0.tar.gz</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgcd5c5c7" class="outline-5">
<h5 id="orgcd5c5c7">运行测试</h5>
<div class="outline-text-5" id="text-orgcd5c5c7">
<p>
提供3种类型测试
</p>

<ul class="org-ul">
<li>API- 针对API端点的测试（RPS 目标：100%）</li>
<li>Git - 针对 Git 端点的测试（RPS 目标：10%）</li>
<li>Web - 针对网页端点的测试（RPS 目标：10%）</li>
</ul>

<div class="org-src-container">
<pre class="src src-bash">:&lt;&lt;EOF
<span style="color: #ffa54f;">&#30446;&#26631;&#29615;&#22659;&#29992;&#25143;&#25968;&#20351;&#29992;&#20197;&#19979;&#36873;&#39033;&#25991;&#20214;&#65306;</span>
<span style="color: #ffa54f;">1&#21315; - 60s_20rps.json</span>
<span style="color: #ffa54f;">2k - 60s_40rps.json</span>
<span style="color: #ffa54f;">3k - 60s_60rps.json</span>
<span style="color: #ffa54f;">5k - 60s_100rps.json</span>
<span style="color: #ffa54f;">10k - 60s_200rps.json</span>
<span style="color: #ffa54f;">EOF</span>

mkdir /data/gitlab-gpt/{results,tests,config/{environments,options,projects}} -p
<span style="color: #483d8b;">cd</span> /data/gitlab-gpt/
cat &lt;&lt;\EOF&gt; config/options/60s_40rps.json
<span style="color: #ffa54f;">{</span>
<span style="color: #ffa54f;">  "stages": [</span>
<span style="color: #ffa54f;">    { "duration": "5s", "target": 40 },</span>
<span style="color: #ffa54f;">    { "duration": "50s", "target": 40 },</span>
<span style="color: #ffa54f;">    { "duration": "5s", "target": 0 }</span>
<span style="color: #ffa54f;">  ],</span>
<span style="color: #ffa54f;">  "rps": 40,</span>
<span style="color: #ffa54f;">  "batchPerHost": 0</span>
<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">EOF</span>

cat &lt;&lt;\EOF&gt; config/options/60s_60rps.json
<span style="color: #ffa54f;">{</span>
<span style="color: #ffa54f;">  "stages": [</span>
<span style="color: #ffa54f;">    { "duration": "5s", "target": 60 },</span>
<span style="color: #ffa54f;">    { "duration": "50s", "target": 60 },</span>
<span style="color: #ffa54f;">    { "duration": "5s", "target": 0 }</span>
<span style="color: #ffa54f;">  ],</span>
<span style="color: #ffa54f;">  "rps": 60,</span>
<span style="color: #ffa54f;">  "batchPerHost": 0</span>
<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">EOF</span>

cat &lt;&lt;\EOF&gt; tests/api_v4_projects_project.js
<span style="color: #ffa54f;">import http from "k6/http";</span>
<span style="color: #ffa54f;">import { group } from "k6";</span>
<span style="color: #ffa54f;">import { Rate } from "k6/metrics";</span>
<span style="color: #ffa54f;">import { logError, getRpsThresholds, getTtfbThreshold, getLargeProjects, selectRandom } from "../../lib/gpt_k6_modules.js";</span>

<span style="color: #ffa54f;">export let rpsThresholds = getRpsThresholds()</span>
<span style="color: #ffa54f;">export let ttfbThreshold = getTtfbThreshold()</span>
<span style="color: #ffa54f;">export let successRate = new Rate("successful_requests")</span>
<span style="color: #ffa54f;">export let options = {</span>
<span style="color: #ffa54f;">  thresholds: {</span>
<span style="color: #ffa54f;">    "successful_requests": [`rate&gt;${__ENV.SUCCESS_RATE_THRESHOLD}`],</span>
<span style="color: #ffa54f;">    "http_req_waiting": [`p(90)&lt;${ttfbThreshold}`],</span>
<span style="color: #ffa54f;">    "http_reqs": [`count&gt;=${rpsThresholds['count']}`]</span>
<span style="color: #ffa54f;">  }</span>
<span style="color: #ffa54f;">};</span>

<span style="color: #ffa54f;">export let projects = getLargeProjects(['encoded_path']);</span>

<span style="color: #ffa54f;">export function setup() {</span>
<span style="color: #ffa54f;">  console.log('')</span>
<span style="color: #ffa54f;">  console.log(`RPS Threshold: ${rpsThresholds['mean']}/s (${rpsThresholds['count']})`)</span>
<span style="color: #ffa54f;">  console.log(`TTFB P90 Threshold: ${ttfbThreshold}ms`)</span>
<span style="color: #ffa54f;">  console.log(`Success Rate Threshold: ${parseFloat(__ENV.SUCCESS_RATE_THRESHOLD)*100}%`)</span>
<span style="color: #ffa54f;">}</span>

<span style="color: #ffa54f;">export default function() {</span>
<span style="color: #ffa54f;">  group("API - Project Overview", function() {</span>
<span style="color: #ffa54f;">    let project = selectRandom(projects);</span>

<span style="color: #ffa54f;">    let params = { headers: { "Accept": "application/json", "PRIVATE-TOKEN": `${__ENV.ACCESS_TOKEN}` } };</span>
<span style="color: #ffa54f;">    let res = http.get(`${__ENV.ENVIRONMENT_URL}/api/v4/projects/${project['encoded_path']}`, params);</span>
<span style="color: #ffa54f;">    /20(0|1)/.test(res.status) ? successRate.add(true) : (successRate.add(false), logError(res));</span>
<span style="color: #ffa54f;">  });</span>
<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25972;&#20010;&#36305;&#27979;&#35797;&#32791;&#26102;&#20037;&#65292;&#21487;&#20197;&#28155;&#21152;--test&#21442;&#25968;&#21333;&#29420;&#19968;&#22359;&#27979;&#35797;</span>
docker run --rm -it <span style="color: #8b2252;">\</span>
  -e <span style="color: #a0522d;">ACCESS_TOKEN</span>=MnLzZsfPNF-Bgtmomgsm <span style="color: #8b2252;">\</span>
  -v /data/gitlab-gpt/config:/config <span style="color: #8b2252;">\</span>
  -v /data/gitlab-gpt/tests:/tests <span style="color: #8b2252;">\</span>
  -v /data/gitlab-gpt/results:/results <span style="color: #8b2252;">\</span>
  --add-host git-test-xcw.cici.com:10.22.0.207 <span style="color: #8b2252;">\</span>
  gitlab/gitlab-performance-tool <span style="color: #8b2252;">\</span>
  --environment 10k.json <span style="color: #8b2252;">\</span>
  --options 60s_40rps.json --tests api_v4_groups_projects.js

<span style="color: #b22222;">#</span><span style="color: #b22222;">3k&#29992;&#25143;</span>
docker run --rm -it <span style="color: #8b2252;">\</span>
  -e <span style="color: #a0522d;">ACCESS_TOKEN</span>=MnLzZsfPNF-Bgtmomgsm <span style="color: #8b2252;">\</span>
  -v /data/gitlab-gpt/config:/config <span style="color: #8b2252;">\</span>
  -v /data/gitlab-gpt/tests:/tests <span style="color: #8b2252;">\</span>
  -v /data/gitlab-gpt/results:/results <span style="color: #8b2252;">\</span>
  --add-host git-test-xcw.cici.com:10.22.0.207 <span style="color: #8b2252;">\</span>
  gitlab/gitlab-performance-tool <span style="color: #8b2252;">\</span>
  --environment 10k.json <span style="color: #8b2252;">\</span>
  --options 60s_60rps.json
</pre>
</div>
</div>
</div>
<div id="outline-container-org803387a" class="outline-5">
<h5 id="org803387a">性能测试结果</h5>
<div class="outline-text-5" id="text-org803387a">
<p>
默认云环境部署最小是支持2k用户性能评估的。部分存在单点
从3k用户开始，高可用无单点。
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-right">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-right">

<col  class="org-left">

<col  class="org-right">
</colgroup>
<tbody>
<tr>
<td class="org-left">service</td>
<td class="org-right">nodes</td>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">配置</td>
<td class="org-left">&#xa0;</td>
<td class="org-right">副本</td>
<td class="org-left">&#xa0;</td>
<td class="org-right">hpa</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-right">2k</td>
<td class="org-right">3k</td>
<td class="org-left">now</td>
<td class="org-left">2k</td>
<td class="org-left">3K</td>
<td class="org-right">3k</td>
<td class="org-left">now</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Webservice</td>
<td class="org-right">3</td>
<td class="org-right">2</td>
<td class="org-left">6</td>
<td class="org-left">3C7.2G</td>
<td class="org-left">16C14.4G</td>
<td class="org-right">4pods 4woker/pod</td>
<td class="org-left">6pods 2woker/pod</td>
<td class="org-right">10</td>
</tr>

<tr>
<td class="org-left">Sidekiq</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-left">4</td>
<td class="org-left">2C7.5G</td>
<td class="org-left">4C15G</td>
<td class="org-right">3</td>
<td class="org-left">4</td>
<td class="org-right">10</td>
</tr>

<tr>
<td class="org-left">nginx</td>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-left">3</td>
<td class="org-left">1C3.75G</td>
<td class="org-left">2C7.5G</td>
<td class="org-right">3</td>
<td class="org-left">3</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">PostgreSQL</td>
<td class="org-right">1</td>
<td class="org-right">3</td>
<td class="org-left">externa</td>
<td class="org-left">2C7.5G</td>
<td class="org-left">2C7.5G</td>
<td class="org-right">3</td>
<td class="org-left">TX</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Redis</td>
<td class="org-right">1</td>
<td class="org-right">3</td>
<td class="org-left">externa</td>
<td class="org-left">1C3.75G</td>
<td class="org-left">2C7.5G</td>
<td class="org-right">3</td>
<td class="org-left">TX</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Gitaly</td>
<td class="org-right">1</td>
<td class="org-right">3</td>
<td class="org-left">1</td>
<td class="org-left">4C15G</td>
<td class="org-left">4C15G</td>
<td class="org-right">3</td>
<td class="org-left">1</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Object storage</td>
<td class="org-right">n/a</td>
<td class="org-right">n/a</td>
<td class="org-left">TX-COS</td>
<td class="org-left">n/a</td>
<td class="org-left">n/a</td>
<td class="org-right">n/a</td>
<td class="org-left">TX</td>
<td class="org-right">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
<ul class="org-ul">
<li><a id="orgc9bb7cd"></a>测试输出<br>
<div class="outline-text-6" id="text-orgc9bb7cd">
<p>
输出说明：
</p>

<div class="org-src-container">
<pre class="src src-bash">&#39318;&#20808;&#26159;&#26377;&#20851;&#29615;&#22659;&#12289;&#27979;&#35797;&#21644; GPT &#29256;&#26412;&#30340;&#32479;&#35745;&#20449;&#24687;&#12290;
&#25509;&#19979;&#26469;&#26159;&#29615;&#22659;&#30340;&#24635;&#20307;&#32467;&#26524;&#24471;&#20998;&#12290;&#36890;&#24120;&#65292;&#24615;&#33021;&#33391;&#22909;&#30340;&#29615;&#22659;&#24212;&#39640;&#20110; 90%&#12290;
&#24471;&#20998;&#21518;&#26159;&#27599;&#27425;&#27979;&#35797;&#36816;&#34892;&#30340;&#20027;&#35201;&#32467;&#26524;&#34920;&#12290;&#22312;&#27492;&#34920;&#20013;&#65292;&#27599;&#21015;&#26174;&#31034;&#20197;&#19979;&#20869;&#23481;&#65306;
NAME- &#27979;&#35797;&#36816;&#34892;&#30340;&#21517;&#31216;&#12290;&#21305;&#37197;&#25991;&#20214;tests&#22841;&#20013;&#30340;&#27979;&#35797;&#25991;&#20214;&#21517;
RPS - &#27979;&#35797;&#26399;&#38388;&#20351;&#29992;&#30340; RPS &#30446;&#26631;&#12290;
RPS RESULT - RPS &#19982;&#36890;&#36807;&#38408;&#20540;&#19968;&#36215;&#23454;&#29616;&#12290;
TTFB AVG-&#20197;&#27627;&#31186;&#20026;&#21333;&#20301;&#30340;&#24179;&#22343;&#31532;&#19968;&#20010;&#23383;&#33410;&#26102;&#38388;(TTFB)&#12290;
TTFB P90- TTFB&#30340;&#31532; 90 &#20010;&#30334;&#20998;&#20301;&#25968;&#21450;&#20854;&#36890;&#36807;&#38408;&#20540;&#12290;
REQ STATUS - &#27979;&#35797;&#21457;&#20986;&#30340;&#36820;&#22238;&#25104;&#21151;&#29366;&#24577;&#65288;&#36820;&#22238; HTTP &#20195;&#30721; 200 / 201&#65289;&#30340;&#35831;&#27714;&#30340;&#30334;&#20998;&#27604;&#21450;&#20854;&#36890;&#36807;&#38408;&#20540;&#12290;
RESULT - &#22522;&#20110;&#38408;&#20540;&#30340;&#27979;&#35797;&#30340;&#26368;&#32456;&#32467;&#26524;&#12290;
&#26368;&#21518;&#65292;&#26681;&#25454;&#32467;&#26524;&#22914;&#20309;&#65292;&#36755;&#20986;&#23558;&#20197;&#25688;&#35201;&#30340;&#19968;&#20123;&#21487;&#36873;&#20449;&#24687;&#27880;&#37322;&#32467;&#26463;&#12290;
</pre>
</div>

<p>
输出内容：2k用户用例。 40个请求/s，运行60秒
</p>

<div class="org-src-container">
<pre class="src src-sh">* Environment:                10k
* Environment Version:        14.2.1-ee <span style="color: #ff00ff;">`018e6242bd5`</span>
* Option:                     60s_40rps
* Date:                       2021-08-31
* Run Time:                   1h 12m 25.77s (Start: 02:50:49 UTC, End: 04:03:14 UTC)
* GPT Version:                v2.8.0

 Overall Results Score: 98.85%
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">NAME</th>
<th scope="col" class="org-left">RPS</th>
<th scope="col" class="org-left">RPS RESULT</th>
<th scope="col" class="org-left">TTFB AVG</th>
<th scope="col" class="org-left">TTFB P90</th>
<th scope="col" class="org-left">REQ STATUS</th>
<th scope="col" class="org-left">RESULT</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">api_v4_groups</td>
<td class="org-left">40/s</td>
<td class="org-left">39.77/s (&gt;32.00/s)</td>
<td class="org-left">72.94ms</td>
<td class="org-left">86.81ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_groups_group</td>
<td class="org-left">40/s</td>
<td class="org-left">32.87/s (&gt;3.20/s)</td>
<td class="org-left">1075.29ms</td>
<td class="org-left">1453.04ms (&lt;7500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_groups_group_subgroups</td>
<td class="org-left">40/s</td>
<td class="org-left">39.74/s (&gt;32.00/s)</td>
<td class="org-left">83.29ms</td>
<td class="org-left">96.44ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_groups_issues</td>
<td class="org-left">40/s</td>
<td class="org-left">39.22/s (&gt;9.60/s)</td>
<td class="org-left">241.84ms</td>
<td class="org-left">280.66ms (&lt;3500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_groups_merge_requests</td>
<td class="org-left">40/s</td>
<td class="org-left">39.2/s (&gt;9.60/s)</td>
<td class="org-left">225.06ms</td>
<td class="org-left">265.36ms (&lt;3500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_groups_projects</td>
<td class="org-left">40/s</td>
<td class="org-left">38.73/s (&gt;16.00/s)</td>
<td class="org-left">387.26ms</td>
<td class="org-left">592.31ms (&lt;3500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects</td>
<td class="org-left">40/s</td>
<td class="org-left">27.02/s (&gt;4.80/s)</td>
<td class="org-left">1313.96ms</td>
<td class="org-left">2025.90ms (&lt;7000ms)</td>
<td class="org-left">99.81% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_deploy_keys</td>
<td class="org-left">40/s</td>
<td class="org-left">39.88/s (&gt;32.00/s)</td>
<td class="org-left">51.42ms</td>
<td class="org-left">62.10ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_issues</td>
<td class="org-left">40/s</td>
<td class="org-left">39.48/s (&gt;32.00/s)</td>
<td class="org-left">167.83ms</td>
<td class="org-left">190.70ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_issues_issue</td>
<td class="org-left">40/s</td>
<td class="org-left">39.44/s (&gt;32.00/s)</td>
<td class="org-left">180.38ms</td>
<td class="org-left">218.84ms (&lt;1500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_issues_search</td>
<td class="org-left">40/s</td>
<td class="org-left">39.04/s (&gt;4.80/s)</td>
<td class="org-left">261.99ms</td>
<td class="org-left">368.66ms (&lt;12000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_languages</td>
<td class="org-left">40/s</td>
<td class="org-left">39.89/s (&gt;32.00/s)</td>
<td class="org-left">48.10ms</td>
<td class="org-left">56.08ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_merge_requests</td>
<td class="org-left">40/s</td>
<td class="org-left">39.36/s (&gt;32.00/s)</td>
<td class="org-left">155.13ms</td>
<td class="org-left">181.33ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_merge_requests_merge_request</td>
<td class="org-left">40/s</td>
<td class="org-left">39.43/s (&gt;16.00/s)</td>
<td class="org-left">216.78ms</td>
<td class="org-left">279.00ms (&lt;2750ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_merge_requests_merge_request_changes</td>
<td class="org-left">40/s</td>
<td class="org-left">36.04/s (&gt;16.00/s)</td>
<td class="org-left">935.58ms</td>
<td class="org-left">1392.85ms (&lt;3500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_merge_requests_merge_request_commits</td>
<td class="org-left">40/s</td>
<td class="org-left">39.74/s (&gt;32.00/s)</td>
<td class="org-left">70.32ms</td>
<td class="org-left">84.07ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_merge_requests_merge_request_discussions</td>
<td class="org-left">40/s</td>
<td class="org-left">39.49/s (&gt;32.00/s)</td>
<td class="org-left">145.58ms</td>
<td class="org-left">180.19ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_project</td>
<td class="org-left">40/s</td>
<td class="org-left">39.69/s (&gt;32.00/s)</td>
<td class="org-left">122.40ms</td>
<td class="org-left">152.55ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_project_pipelines</td>
<td class="org-left">40/s</td>
<td class="org-left">39.82/s (&gt;32.00/s)</td>
<td class="org-left">63.29ms</td>
<td class="org-left">77.12ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_project_pipelines_pipeline</td>
<td class="org-left">40/s</td>
<td class="org-left">39.68/s (&gt;32.00/s)</td>
<td class="org-left">77.16ms</td>
<td class="org-left">97.31ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_project_services</td>
<td class="org-left">40/s</td>
<td class="org-left">39.91/s (&gt;32.00/s)</td>
<td class="org-left">45.74ms</td>
<td class="org-left">51.68ms (&lt;500ms)</td>
<td class="org-left">99.12% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_releases</td>
<td class="org-left">40/s</td>
<td class="org-left">39.68/s (&gt;32.00/s)</td>
<td class="org-left">79.28ms</td>
<td class="org-left">95.06ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_branches</td>
<td class="org-left">40/s</td>
<td class="org-left">39.69/s (&gt;32.00/s)</td>
<td class="org-left">49.57ms</td>
<td class="org-left">56.89ms (&lt;500ms)</td>
<td class="org-left">99.58% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_branches_branch</td>
<td class="org-left">40/s</td>
<td class="org-left">39.81/s (&gt;32.00/s)</td>
<td class="org-left">80.35ms</td>
<td class="org-left">95.04ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_branches_search</td>
<td class="org-left">40/s</td>
<td class="org-left">39.65/s (&gt;9.60/s)</td>
<td class="org-left">46.20ms</td>
<td class="org-left">50.55ms (&lt;6000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_commits</td>
<td class="org-left">40/s</td>
<td class="org-left">39.79/s (&gt;32.00/s)</td>
<td class="org-left">73.83ms</td>
<td class="org-left">85.78ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_commits_commit</td>
<td class="org-left">40/s</td>
<td class="org-left">39.83/s (&gt;32.00/s)</td>
<td class="org-left">64.10ms</td>
<td class="org-left">72.95ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_commits_commit_diff</td>
<td class="org-left">40/s</td>
<td class="org-left">39.63/s (&gt;32.00/s)</td>
<td class="org-left">121.59ms</td>
<td class="org-left">140.03ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_compare</td>
<td class="org-left">40/s</td>
<td class="org-left">39.56/s (&gt;3.20/s)</td>
<td class="org-left">59.82ms</td>
<td class="org-left">71.01ms (&lt;8000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_files_file</td>
<td class="org-left">40/s</td>
<td class="org-left">39.68/s (&gt;32.00/s)</td>
<td class="org-left">125.64ms</td>
<td class="org-left">205.37ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_files_file_blame</td>
<td class="org-left">40/s</td>
<td class="org-left">4.17/s (&gt;0.32/s)</td>
<td class="org-left">8426.11ms</td>
<td class="org-left">11272.54ms (&lt;35000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_files_file_raw</td>
<td class="org-left">40/s</td>
<td class="org-left">39.77/s (&gt;32.00/s)</td>
<td class="org-left">86.64ms</td>
<td class="org-left">109.73ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_tags</td>
<td class="org-left">40/s</td>
<td class="org-left">12.43/s (&gt;6.40/s)</td>
<td class="org-left">2959.33ms</td>
<td class="org-left">3836.65ms (&lt;10000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_tree</td>
<td class="org-left">40/s</td>
<td class="org-left">39.69/s (&gt;32.00/s)</td>
<td class="org-left">100.75ms</td>
<td class="org-left">117.95ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_user</td>
<td class="org-left">40/s</td>
<td class="org-left">39.83/s (&gt;32.00/s)</td>
<td class="org-left">44.66ms</td>
<td class="org-left">50.18ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_users</td>
<td class="org-left">40/s</td>
<td class="org-left">39.66/s (&gt;32.00/s)</td>
<td class="org-left">105.30ms</td>
<td class="org-left">134.00ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">git_ls_remote</td>
<td class="org-left">4/s</td>
<td class="org-left">4.01/s (&gt;3.20/s)</td>
<td class="org-left">54.07ms</td>
<td class="org-left">61.20ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">git_pull</td>
<td class="org-left">4/s</td>
<td class="org-left">3.99/s (&gt;3.20/s)</td>
<td class="org-left">71.51ms</td>
<td class="org-left">88.70ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_group</td>
<td class="org-left">4/s</td>
<td class="org-left">4.01/s (&gt;3.20/s)</td>
<td class="org-left">135.83ms</td>
<td class="org-left">183.69ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_group_issues</td>
<td class="org-left">4/s</td>
<td class="org-left">3.91/s (&gt;3.20/s)</td>
<td class="org-left">306.77ms</td>
<td class="org-left">335.46ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_group_merge_requests</td>
<td class="org-left">4/s</td>
<td class="org-left">3.96/s (&gt;3.20/s)</td>
<td class="org-left">286.81ms</td>
<td class="org-left">324.81ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project</td>
<td class="org-left">4/s</td>
<td class="org-left">3.98/s (&gt;3.20/s)</td>
<td class="org-left">252.23ms</td>
<td class="org-left">299.84ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_branches</td>
<td class="org-left">4/s</td>
<td class="org-left">3.89/s (&gt;3.20/s)</td>
<td class="org-left">369.64ms</td>
<td class="org-left">416.38ms (&lt;800ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_branches_search</td>
<td class="org-left">4/s</td>
<td class="org-left">3.75/s (&gt;3.20/s)</td>
<td class="org-left">725.64ms</td>
<td class="org-left">788.16ms (&lt;1300ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_commit</td>
<td class="org-left">4/s</td>
<td class="org-left">3.34/s (&gt;0.64/s)</td>
<td class="org-left">1023.11ms</td>
<td class="org-left">3192.27ms (&lt;10000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_commits</td>
<td class="org-left">4/s</td>
<td class="org-left">3.83/s (&gt;3.20/s)</td>
<td class="org-left">417.67ms</td>
<td class="org-left">459.98ms (&lt;750ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_file_blame</td>
<td class="org-left">4/s</td>
<td class="org-left">1.16/s (&gt;0.03/s)</td>
<td class="org-left">2848.92ms</td>
<td class="org-left">3632.63ms (&lt;7000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_file_rendered</td>
<td class="org-left">4/s</td>
<td class="org-left">3.87/s (&gt;2.56/s)</td>
<td class="org-left">556.67ms</td>
<td class="org-left">1401.66ms (&lt;1500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">FAILED</td>
</tr>

<tr>
<td class="org-left">web_project_file_source</td>
<td class="org-left">4/s</td>
<td class="org-left">3.79/s (&gt;0.32/s)</td>
<td class="org-left">602.75ms</td>
<td class="org-left">951.71ms (&lt;1700ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_files</td>
<td class="org-left">4/s</td>
<td class="org-left">3.96/s (&gt;3.20/s)</td>
<td class="org-left">171.19ms</td>
<td class="org-left">229.41ms (&lt;800ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_issue</td>
<td class="org-left">4/s</td>
<td class="org-left">3.93/s (&gt;3.20/s)</td>
<td class="org-left">306.58ms</td>
<td class="org-left">753.12ms (&lt;2000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_issues</td>
<td class="org-left">4/s</td>
<td class="org-left">3.95/s (&gt;3.20/s)</td>
<td class="org-left">274.76ms</td>
<td class="org-left">309.11ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_issues_search</td>
<td class="org-left">4/s</td>
<td class="org-left">3.98/s (&gt;3.20/s)</td>
<td class="org-left">282.06ms</td>
<td class="org-left">323.16ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_merge_request</td>
<td class="org-left">4/s</td>
<td class="org-left">3.22/s (&gt;1.28/s)</td>
<td class="org-left">1837.29ms</td>
<td class="org-left">4669.98ms (&lt;7500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_merge_request_changes</td>
<td class="org-left">4/s</td>
<td class="org-left">3.83/s (&gt;3.20/s)</td>
<td class="org-left">422.94ms</td>
<td class="org-left">689.98ms (&lt;1500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_merge_request_commits</td>
<td class="org-left">4/s</td>
<td class="org-left">3.71/s (&gt;1.92/s)</td>
<td class="org-left">619.33ms</td>
<td class="org-left">722.99ms (&lt;1750ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_merge_requests</td>
<td class="org-left">4/s</td>
<td class="org-left">3.98/s (&gt;3.20/s)</td>
<td class="org-left">276.73ms</td>
<td class="org-left">314.99ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_pipelines</td>
<td class="org-left">4/s</td>
<td class="org-left">3.96/s (&gt;1.92/s)</td>
<td class="org-left">297.46ms</td>
<td class="org-left">428.77ms (&lt;1000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_pipelines_pipeline</td>
<td class="org-left">4/s</td>
<td class="org-left">3.96/s (&gt;3.20/s)</td>
<td class="org-left">500.62ms</td>
<td class="org-left">1012.73ms (&lt;2500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_repository_compare</td>
<td class="org-left">4/s</td>
<td class="org-left">0.84/s (&gt;0.16/s)</td>
<td class="org-left">4439.88ms</td>
<td class="org-left">5183.79ms (&lt;7500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_tags</td>
<td class="org-left">4/s</td>
<td class="org-left">3.75/s (&gt;2.56/s)</td>
<td class="org-left">708.61ms</td>
<td class="org-left">783.40ms (&lt;1500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_user</td>
<td class="org-left">4/s</td>
<td class="org-left">4.0/s (&gt;1.92/s)</td>
<td class="org-left">173.82ms</td>
<td class="org-left">265.93ms (&lt;4000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>
</tbody>
</table>

<p>
输出内容：3k用户用例。 60个请求/s，运行60秒
</p>
<div class="org-src-container">
<pre class="src src-org"><span style="color: #0000ff;">* Environment:                10k</span>
<span style="color: #0000ff;">* Environment Version:        14.2.1-ee `018e6242bd5`</span>
<span style="color: #0000ff;">* Option:                     60s_60rps</span>
<span style="color: #0000ff;">* Date:                       2021-08-31</span>
<span style="color: #0000ff;">* Run Time:                   1h 12m 35.66s (Start: 06:32:26 UTC, End: 07:45:01 UTC)</span>
<span style="color: #0000ff;">* GPT Version:                v2.8.0</span>

 Overall Results Score: 98.67%
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">NAME</th>
<th scope="col" class="org-left">RPS</th>
<th scope="col" class="org-left">RPS RESULT</th>
<th scope="col" class="org-left">TTFB AVG</th>
<th scope="col" class="org-left">TTFB P90</th>
<th scope="col" class="org-left">REQ STATUS</th>
<th scope="col" class="org-left">RESULT</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">api_v4_groups</td>
<td class="org-left">60/s</td>
<td class="org-left">59.48/s (&gt;48.00/s)</td>
<td class="org-left">196.27ms</td>
<td class="org-left">351.89ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_groups_group</td>
<td class="org-left">60/s</td>
<td class="org-left">12.89/s (&gt;4.80/s)</td>
<td class="org-left">4241.66ms</td>
<td class="org-left">6280.03ms (&lt;7500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_groups_group_subgroups</td>
<td class="org-left">60/s</td>
<td class="org-left">59.51/s (&gt;48.00/s)</td>
<td class="org-left">115.17ms</td>
<td class="org-left">165.60ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_groups_issues</td>
<td class="org-left">60/s</td>
<td class="org-left">54.75/s (&gt;14.40/s)</td>
<td class="org-left">955.93ms</td>
<td class="org-left">1197.23ms (&lt;3500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_groups_merge_requests</td>
<td class="org-left">60/s</td>
<td class="org-left">57.91/s (&gt;14.40/s)</td>
<td class="org-left">676.09ms</td>
<td class="org-left">984.77ms (&lt;3500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_groups_projects</td>
<td class="org-left">60/s</td>
<td class="org-left">50.65/s (&gt;24.00/s)</td>
<td class="org-left">1040.49ms</td>
<td class="org-left">1621.93ms (&lt;3500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects</td>
<td class="org-left">60/s</td>
<td class="org-left">23.44/s (&gt;7.20/s)</td>
<td class="org-left">2340.33ms</td>
<td class="org-left">3362.55ms (&lt;7000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_deploy_keys</td>
<td class="org-left">60/s</td>
<td class="org-left">59.78/s (&gt;48.00/s)</td>
<td class="org-left">53.79ms</td>
<td class="org-left">65.42ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_issues</td>
<td class="org-left">60/s</td>
<td class="org-left">58.93/s (&gt;48.00/s)</td>
<td class="org-left">187.38ms</td>
<td class="org-left">237.11ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_issues_issue</td>
<td class="org-left">60/s</td>
<td class="org-left">58.59/s (&gt;48.00/s)</td>
<td class="org-left">204.43ms</td>
<td class="org-left">266.81ms (&lt;1500ms)</td>
<td class="org-left">99.88% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_issues_search</td>
<td class="org-left">60/s</td>
<td class="org-left">58.52/s (&gt;7.20/s)</td>
<td class="org-left">295.56ms</td>
<td class="org-left">411.93ms (&lt;12000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_languages</td>
<td class="org-left">60/s</td>
<td class="org-left">59.75/s (&gt;48.00/s)</td>
<td class="org-left">51.46ms</td>
<td class="org-left">60.84ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_merge_requests</td>
<td class="org-left">60/s</td>
<td class="org-left">59.07/s (&gt;48.00/s)</td>
<td class="org-left">177.71ms</td>
<td class="org-left">225.57ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_merge_requests_merge_request</td>
<td class="org-left">60/s</td>
<td class="org-left">58.82/s (&gt;24.00/s)</td>
<td class="org-left">262.37ms</td>
<td class="org-left">397.07ms (&lt;2750ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_merge_requests_merge_request_changes</td>
<td class="org-left">60/s</td>
<td class="org-left">52.88/s (&gt;24.00/s)</td>
<td class="org-left">963.39ms</td>
<td class="org-left">1540.11ms (&lt;3500ms)</td>
<td class="org-left">94.81% (&gt;99%)</td>
<td class="org-left">FAILED</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_merge_requests_merge_request_commits</td>
<td class="org-left">60/s</td>
<td class="org-left">59.6/s (&gt;48.00/s)</td>
<td class="org-left">77.44ms</td>
<td class="org-left">93.66ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_merge_requests_merge_request_discussions</td>
<td class="org-left">60/s</td>
<td class="org-left">59.16/s (&gt;48.00/s)</td>
<td class="org-left">156.24ms</td>
<td class="org-left">197.77ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_project</td>
<td class="org-left">60/s</td>
<td class="org-left">59.32/s (&gt;48.00/s)</td>
<td class="org-left">122.09ms</td>
<td class="org-left">149.43ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_project_pipelines</td>
<td class="org-left">60/s</td>
<td class="org-left">59.74/s (&gt;48.00/s)</td>
<td class="org-left">63.12ms</td>
<td class="org-left">73.93ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_project_pipelines_pipeline</td>
<td class="org-left">60/s</td>
<td class="org-left">59.49/s (&gt;48.00/s)</td>
<td class="org-left">77.71ms</td>
<td class="org-left">95.56ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_project_services</td>
<td class="org-left">60/s</td>
<td class="org-left">59.78/s (&gt;48.00/s)</td>
<td class="org-left">51.16ms</td>
<td class="org-left">60.73ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_releases</td>
<td class="org-left">60/s</td>
<td class="org-left">59.53/s (&gt;48.00/s)</td>
<td class="org-left">79.78ms</td>
<td class="org-left">111.13ms (&lt;500ms)</td>
<td class="org-left">89.65% (&gt;99%)</td>
<td class="org-left">FAILED</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_branches</td>
<td class="org-left">60/s</td>
<td class="org-left">59.54/s (&gt;48.00/s)</td>
<td class="org-left">52.88ms</td>
<td class="org-left">63.13ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_branches_branch</td>
<td class="org-left">60/s</td>
<td class="org-left">59.65/s (&gt;48.00/s)</td>
<td class="org-left">86.54ms</td>
<td class="org-left">110.07ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_branches_search</td>
<td class="org-left">60/s</td>
<td class="org-left">59.54/s (&gt;14.40/s)</td>
<td class="org-left">54.37ms</td>
<td class="org-left">64.79ms (&lt;6000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_commits</td>
<td class="org-left">60/s</td>
<td class="org-left">59.32/s (&gt;48.00/s)</td>
<td class="org-left">82.66ms</td>
<td class="org-left">103.07ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_commits_commit</td>
<td class="org-left">60/s</td>
<td class="org-left">59.69/s (&gt;48.00/s)</td>
<td class="org-left">68.67ms</td>
<td class="org-left">79.86ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_commits_commit_diff</td>
<td class="org-left">60/s</td>
<td class="org-left">59.43/s (&gt;48.00/s)</td>
<td class="org-left">131.34ms</td>
<td class="org-left">156.27ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_compare</td>
<td class="org-left">60/s</td>
<td class="org-left">59.19/s (&gt;4.80/s)</td>
<td class="org-left">64.70ms</td>
<td class="org-left">76.06ms (&lt;8000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_files_file</td>
<td class="org-left">60/s</td>
<td class="org-left">59.38/s (&gt;48.00/s)</td>
<td class="org-left">136.53ms</td>
<td class="org-left">179.17ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_files_file_blame</td>
<td class="org-left">60/s</td>
<td class="org-left">8.11/s (&gt;0.48/s)</td>
<td class="org-left">6544.49ms</td>
<td class="org-left">8564.36ms (&lt;35000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_files_file_raw</td>
<td class="org-left">60/s</td>
<td class="org-left">59.63/s (&gt;48.00/s)</td>
<td class="org-left">86.77ms</td>
<td class="org-left">108.45ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_tags</td>
<td class="org-left">60/s</td>
<td class="org-left">35.86/s (&gt;9.60/s)</td>
<td class="org-left">1501.96ms</td>
<td class="org-left">2341.98ms (&lt;10000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_projects_repository_tree</td>
<td class="org-left">60/s</td>
<td class="org-left">59.56/s (&gt;48.00/s)</td>
<td class="org-left">105.67ms</td>
<td class="org-left">130.88ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_user</td>
<td class="org-left">60/s</td>
<td class="org-left">59.71/s (&gt;48.00/s)</td>
<td class="org-left">43.68ms</td>
<td class="org-left">52.09ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">api_v4_users</td>
<td class="org-left">60/s</td>
<td class="org-left">59.5/s (&gt;48.00/s)</td>
<td class="org-left">107.09ms</td>
<td class="org-left">137.20ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">git_ls_remote</td>
<td class="org-left">6/s</td>
<td class="org-left">6.01/s (&gt;4.80/s)</td>
<td class="org-left">66.97ms</td>
<td class="org-left">79.01ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">git_pull</td>
<td class="org-left">6/s</td>
<td class="org-left">6.01/s (&gt;4.80/s)</td>
<td class="org-left">70.12ms</td>
<td class="org-left">83.64ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_group</td>
<td class="org-left">6/s</td>
<td class="org-left">5.97/s (&gt;4.80/s)</td>
<td class="org-left">153.34ms</td>
<td class="org-left">197.28ms (&lt;500ms)</td>
<td class="org-left">99.16% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_group_issues</td>
<td class="org-left">6/s</td>
<td class="org-left">5.76/s (&gt;4.80/s)</td>
<td class="org-left">321.23ms</td>
<td class="org-left">356.40ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_group_merge_requests</td>
<td class="org-left">6/s</td>
<td class="org-left">5.83/s (&gt;4.80/s)</td>
<td class="org-left">271.90ms</td>
<td class="org-left">313.86ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project</td>
<td class="org-left">6/s</td>
<td class="org-left">5.94/s (&gt;4.80/s)</td>
<td class="org-left">255.85ms</td>
<td class="org-left">290.56ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_branches</td>
<td class="org-left">6/s</td>
<td class="org-left">5.85/s (&gt;4.80/s)</td>
<td class="org-left">384.70ms</td>
<td class="org-left">460.07ms (&lt;800ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_branches_search</td>
<td class="org-left">6/s</td>
<td class="org-left">4.77/s (&gt;4.80/s)</td>
<td class="org-left">1031.66ms</td>
<td class="org-left">1430.82ms (&lt;1300ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">FAILED</td>
</tr>

<tr>
<td class="org-left">web_project_commit</td>
<td class="org-left">6/s</td>
<td class="org-left">5.54/s (&gt;0.96/s)</td>
<td class="org-left">804.76ms</td>
<td class="org-left">2066.71ms (&lt;10000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_commits</td>
<td class="org-left">6/s</td>
<td class="org-left">5.77/s (&gt;4.80/s)</td>
<td class="org-left">412.15ms</td>
<td class="org-left">485.07ms (&lt;750ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_file_blame</td>
<td class="org-left">6/s</td>
<td class="org-left">1.81/s (&gt;0.05/s)</td>
<td class="org-left">2767.15ms</td>
<td class="org-left">3354.83ms (&lt;7000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_file_rendered</td>
<td class="org-left">6/s</td>
<td class="org-left">5.79/s (&gt;3.84/s)</td>
<td class="org-left">568.17ms</td>
<td class="org-left">1160.80ms (&lt;1500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_file_source</td>
<td class="org-left">6/s</td>
<td class="org-left">5.67/s (&gt;0.48/s)</td>
<td class="org-left">630.89ms</td>
<td class="org-left">1112.25ms (&lt;1700ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_files</td>
<td class="org-left">6/s</td>
<td class="org-left">5.89/s (&gt;4.80/s)</td>
<td class="org-left">170.16ms</td>
<td class="org-left">233.29ms (&lt;800ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_issue</td>
<td class="org-left">6/s</td>
<td class="org-left">5.89/s (&gt;4.80/s)</td>
<td class="org-left">293.45ms</td>
<td class="org-left">742.88ms (&lt;2000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_issues</td>
<td class="org-left">6/s</td>
<td class="org-left">5.84/s (&gt;4.80/s)</td>
<td class="org-left">279.11ms</td>
<td class="org-left">307.90ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_issues_search</td>
<td class="org-left">6/s</td>
<td class="org-left">5.9/s (&gt;4.80/s)</td>
<td class="org-left">280.01ms</td>
<td class="org-left">318.71ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_merge_request</td>
<td class="org-left">6/s</td>
<td class="org-left">5.26/s (&gt;1.92/s)</td>
<td class="org-left">1143.74ms</td>
<td class="org-left">4119.07ms (&lt;7500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_merge_request_changes</td>
<td class="org-left">6/s</td>
<td class="org-left">5.78/s (&gt;4.80/s)</td>
<td class="org-left">397.73ms</td>
<td class="org-left">680.55ms (&lt;1500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_merge_request_commits</td>
<td class="org-left">6/s</td>
<td class="org-left">5.68/s (&gt;2.88/s)</td>
<td class="org-left">652.54ms</td>
<td class="org-left">919.78ms (&lt;1750ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_merge_requests</td>
<td class="org-left">6/s</td>
<td class="org-left">5.91/s (&gt;4.80/s)</td>
<td class="org-left">265.21ms</td>
<td class="org-left">307.71ms (&lt;500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_pipelines</td>
<td class="org-left">6/s</td>
<td class="org-left">5.9/s (&gt;2.88/s)</td>
<td class="org-left">314.51ms</td>
<td class="org-left">469.81ms (&lt;1000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_pipelines_pipeline</td>
<td class="org-left">6/s</td>
<td class="org-left">5.94/s (&gt;4.80/s)</td>
<td class="org-left">549.83ms</td>
<td class="org-left">1138.55ms (&lt;2500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_repository_compare</td>
<td class="org-left">6/s</td>
<td class="org-left">1.17/s (&gt;0.24/s)</td>
<td class="org-left">4492.35ms</td>
<td class="org-left">5205.89ms (&lt;7500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_project_tags</td>
<td class="org-left">6/s</td>
<td class="org-left">5.56/s (&gt;3.84/s)</td>
<td class="org-left">758.64ms</td>
<td class="org-left">901.92ms (&lt;1500ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>

<tr>
<td class="org-left">web_user</td>
<td class="org-left">6/s</td>
<td class="org-left">5.97/s (&gt;2.88/s)</td>
<td class="org-left">193.58ms</td>
<td class="org-left">310.01ms (&lt;4000ms)</td>
<td class="org-left">100.00% (&gt;99%)</td>
<td class="org-left">Passed</td>
</tr>
</tbody>
</table>
<p>
#+end_src
</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org7a85804" class="outline-3">
<h3 id="org7a85804">生产环境</h3>
<div class="outline-text-3" id="text-org7a85804">
<p>
修改对应pv存储大小/节点，可用直接使用3k测试环境配置。生产最好有外置redis和postgresql。
</p>
</div>
<div id="outline-container-orgfca9a23" class="outline-4">
<h4 id="orgfca9a23">前期准备-脚本</h4>
<div class="outline-text-4" id="text-orgfca9a23">
<p>
已提前备好资源
</p>

<ul class="org-ul">
<li>pv存储设置</li>
<li>外部对象存储开通权限访问策略</li>
<li>证书文件</li>
<li>外部redis</li>
<li>外部postgresql</li>
<li>ldap</li>
<li>gitlab邮件账号</li>
</ul>

<div class="org-src-container">
<pre class="src src-bash">cat &lt;&lt;\EOF&gt; create_gitlab_secrets_prod.sh
<span style="color: #ffa54f;">#!/bin/bash</span>
<span style="color: #ffa54f;">NS="gitlab-ns"</span>
<span style="color: #ffa54f;"># --- &#21019;&#24314;&#25345;&#20037;&#21367;</span>
<span style="color: #ffa54f;">#kubectl apply -f gitlab-pv-sc.yaml</span>

<span style="color: #ffa54f;"># --- &#21019;&#24314;&#22495;&#21517;&#35777;&#20070;tls secret</span>
<span style="color: #ffa54f;">kubectl --namespace=$NS create secret tls cici-com --cert=cici.com.crt --key=cici.com.key</span>

<span style="color: #ffa54f;"># --- &#21551;&#21160;&#22806;&#37096;&#23545;&#35937;&#23384;&#20648;</span>
<span style="color: #ffa54f;">#&#32479;&#19968;&#23384;&#20648;</span>
<span style="color: #ffa54f;">kubectl --namespace=$NS create secret generic gitlab-rails-storage --from-file=connection=object-storage-prod.yaml</span>
<span style="color: #ffa54f;">:&lt;&lt;eof</span>
<span style="color: #ffa54f;">#5.2.1&#29256;&#26412;&#21069;&#27809;&#26377;&#25972;&#21512;&#37197;&#32622;&#65292;&#38656;&#35201;&#21333;&#29420;&#25191;&#34892;</span>
<span style="color: #ffa54f;">kubectl --namespace=$NS create secret generic gitlab-lfs --from-file=connection=object-storage-prod.yaml</span>
<span style="color: #ffa54f;">kubectl --namespace=$NS create secret generic gitlab-artifacts --from-file=connection=object-storage-prod.yaml</span>
<span style="color: #ffa54f;">kubectl --namespace=$NS create secret generic gitlab-uploads --from-file=connection=object-storage-prod.yaml</span>
<span style="color: #ffa54f;">kubectl --namespace=$NS create secret generic gitlab-packages --from-file=connection=object-storage-prod.yaml</span>
<span style="color: #ffa54f;">#kubectl --namespace=$NS create secret generic gitlab-externaldiffs --from-file=connection=object-storage-prod.yaml</span>
<span style="color: #ffa54f;">kubectl --namespace=$NS create secret generic gitlab-pseudonymizer --from-file=connection=object-storage-prod.yaml</span>
<span style="color: #ffa54f;">eof</span>
<span style="color: #ffa54f;">#&#38236;&#20687;&#23384;&#20648;</span>
<span style="color: #ffa54f;">kubectl --namespace=$NS create secret generic gitlab-registry --from-file=config=registry-prod.yaml</span>
<span style="color: #ffa54f;">#&#22791;&#20221;</span>
<span style="color: #ffa54f;">kubectl --namespace=$NS create secret generic task-runenr-s3-config --from-file=config=s3cfg_cos-prod</span>

<span style="color: #ffa54f;"># --- &#26381;&#21153;&#36830;&#25509;&#23494;&#30721;</span>
<span style="color: #ffa54f;">kubectl apply -f pg_redis_ldap_smtp-prod.yaml</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org99e8cc0" class="outline-4">
<h4 id="org99e8cc0">部署脚本</h4>
<div class="outline-text-4" id="text-org99e8cc0">
<p>
下载对应版本gilab chart至本地，将有差异的部署参数单独写入文件，方便后期修正。
</p>

<div class="org-src-container">
<pre class="src src-bash">cat &lt;&lt;\EOF&gt; deploy-gitlab-prod.sh
<span style="color: #ffa54f;">helm upgrade --install -n gitlab-xcw gitlab . \</span>
<span style="color: #ffa54f;">     --timeout 600s \</span>
<span style="color: #ffa54f;">     --dry-run \</span>
<span style="color: #ffa54f;">     -f customize_conf/values-prod.yaml \</span>
<span style="color: #ffa54f;">     --set global.hosts.gitlab.name='git-xcw.cici.com' \</span>
<span style="color: #ffa54f;">     `#--&#22806;&#37096;postgresql--` \</span>
<span style="color: #ffa54f;">     `#--set postgresql.install=false` \</span>
<span style="color: #ffa54f;">     `#--set global.psql.host=production.postgress.hostname.local` \</span>
<span style="color: #ffa54f;">     `#--set global.psql.password.secret=gitlab-pg` \</span>
<span style="color: #ffa54f;">     `#--set global.psql.password.key='password'` \</span>
<span style="color: #ffa54f;">     `#--&#22806;&#37096;redis--` \</span>
<span style="color: #ffa54f;">     `#--set redis.enabled=false` \</span>
<span style="color: #ffa54f;">     `#--set global.redis.host='redis.example.com'` \</span>
<span style="color: #ffa54f;">     `#--set global.redis.password.secret=gitlab-redis` \</span>
<span style="color: #ffa54f;">     `#--set global.redis.password.key='password'` \</span>
<span style="color: #ffa54f;">     --set gitlab.migrations.enabled=true </span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org4249c15" class="outline-3">
<h3 id="org4249c15">升级之</h3>
<div class="outline-text-3" id="text-org4249c15">
<p>
官方参考：<a href="https://docs.gitlab.com/ee/update/#installation-using-helm">迭代升级</a>
</p>
</div>
<div id="outline-container-org4cfb385" class="outline-4">
<h4 id="org4cfb385">差异比较</h4>
<div class="outline-text-4" id="text-org4cfb385">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<tbody>
<tr>
<td class="org-left">比较</td>
<td class="org-left">12.3.1(2.3.2)</td>
<td class="org-left">14.2.1(5.2.1)</td>
<td class="org-right">13.0.14(4.0.12)</td>
<td class="org-right">12.10.14(3.3.13)</td>
</tr>

<tr>
<td class="org-left">helm</td>
<td class="org-left">v2.16.1</td>
<td class="org-left">v3.6.3</td>
<td class="org-right">helm3/2</td>
<td class="org-right">helm3/2</td>
</tr>

<tr>
<td class="org-left">chart</td>
<td class="org-left">-</td>
<td class="org-left">-</td>
<td class="org-right">Webservice替换unicorn</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-right">支持对象存储整合object_store</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-right">postgresql.image.{repository,tag}</td>
<td class="org-right">postgresql.{image,imageTag}</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-right">redis-master.persistence.accessModes</td>
<td class="org-right">redis.persistence.accessMode</td>
</tr>

<tr>
<td class="org-left">服务-postgresql</td>
<td class="org-left">10.4 (9.6.x-10.x)</td>
<td class="org-left">12.7</td>
<td class="org-right">11.7.0</td>
<td class="org-right">10.9.0</td>
</tr>

<tr>
<td class="org-left">镜像-task-runner</td>
<td class="org-left">gitlab-task-runner-ee</td>
<td class="org-left">gitlab-toolbox-ee</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">镜像-unicorn(webservice)</td>
<td class="org-left">gitlab-unicorn-ee</td>
<td class="org-left">gitlab-webservice-ee</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">gitlab-workhorse-ee</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">服务-migrations</td>
<td class="org-left">-</td>
<td class="org-left">y</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">服务-praefect</td>
<td class="org-left">-</td>
<td class="org-left">- 开发阶段</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">服务-task-runner-cron</td>
<td class="org-left">-</td>
<td class="org-left">y</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">externalDiffs差异化</td>
<td class="org-left">y</td>
<td class="org-left">不使用：<a href="https://docs.gitlab.com/charts/charts/globals.html#when-only-for-external-mr-diffs">详情</a> 性能降低</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">服务-prometheus</td>
<td class="org-left">-</td>
<td class="org-left">y</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">hpa</td>
<td class="org-left">registry: 2-10</td>
<td class="org-left">registry: 2-10</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">gitlab-shell: 2-10  已删</td>
<td class="org-left">gitlab-shell: 2-10</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">sidekiq: 1-10  已删</td>
<td class="org-left">sidekiq: 1-10</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">unicorn: 2-10 已删</td>
<td class="org-left">&#xa0;</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">pod</td>
<td class="org-left">gitlab-shell: 6</td>
<td class="org-left">gitlab-shell:</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">registry: 2</td>
<td class="org-left">registry:</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">sidekiq: 2</td>
<td class="org-left">sidekiq</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">task-runner: 1</td>
<td class="org-left">task-runner: 1</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">unicorn: 6</td>
<td class="org-left">webservice:</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">ingress-controller: 3</td>
<td class="org-left">ingress-controller:</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">ingress-backend: 2</td>
<td class="org-left">ingress-backend:</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-left">分支</td>
<td class="org-left">master</td>
<td class="org-left">main</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-orgec8b417" class="outline-4">
<h4 id="orgec8b417">配置</h4>
<div class="outline-text-4" id="text-orgec8b417">
<p>
描述与默认安装14.2.1版本的额外设置
</p>

<ul class="org-ul">
<li>概览
<ul class="org-ul">
<li>runner
<ul class="org-ul">
<li>运行没有标记的作业</li>
</ul></li>
</ul></li>
<li>推送规则
admin&#x2013;推送规则&#x2013;打开禁止密钥推送</li>
<li>系统钩子</li>
<li>部署密钥</li>
<li>标记</li>
<li>设置
<ul class="org-ul">
<li>通用
<ul class="org-ul">
<li>默认的群组项目创建保护： 维护者</li>
<li>默认分支保护：Not protected</li>
<li>账号： 默认项目限制：10，最大附件大小 (MB)：100，用户的 OAuth 应用程序：不勾</li>
<li>注册：不启动注册</li>
</ul></li>
<li>CICD
<ul class="org-ul">
<li>集成和部署：默认产物过期时间：0</li>
<li>项目中的Auto DevOps去勾选</li>
</ul></li>
<li>报告
<ul class="org-ul">
<li>滥用报告：email:xxx@xxx.com</li>
</ul></li>
<li>指标与分析：
<ul class="org-ul">
<li>分析 - 性能栏：devops</li>
</ul></li>
<li>偏好
<ul class="org-ul">
<li>邮件：勾选在通知电子邮件正文中包含作者姓名</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org119f3fa" class="outline-4">
<h4 id="org119f3fa">迭代升级</h4>
<div class="outline-text-4" id="text-org119f3fa">
<p>
需要按照以下升级步骤确保主版本升级成功：
</p>

<ul class="org-ul">
<li>升级到先前主要版本的最新次要版本。</li>
<li>升级到X.0.Z目标主要版本的第一个次要版本 ( )。</li>
<li>继续升级到较新的版本。</li>
</ul>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#29256;&#26412;</span>
$ helm2  list --namespace=gitlab-test
NAME            REVISION        UPDATED                         STATUS  CHART           APP VERSION     NAMESPACE
gitlab-test     5               Tue Dec 29 18:46:04 2020        FAILED  gitlab-2.3.2    12.3.1          gitlab-test
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#33258;&#23450;&#20041;&#37197;&#32622;</span>
helm2 get values gitla-test
helm get values   -n gitlab-test-xcw gitlab-test-xcw &gt;5.2.1-bed.yaml
</pre>
</div>

<p>
gitlab版本:
</p>

<div class="org-src-container">
<pre class="src src-bash">11.10.0 -&gt; 11.11.3 -&gt; 11.11.8 -&gt; 12.1.0 -&gt; 12.3.1 -&gt;
12.10.14 -&gt; 13.0.14-&gt; 13.1.11-&gt; 13.8.8 -&gt; 13.12.10 -&gt; 14.0.10 -&gt; 14.1.5 -&gt; &#26368;&#26032;14.Y.Z
</pre>
</div>

<p>
对应的chart版本:
</p>

<div class="org-src-container">
<pre class="src src-bash">1.8.0 -&gt; 1.9.3 -&gt; 1.9.8 -&gt; 2.1.0 -&gt; 2.3.2 -&gt;
3.3.13 -&gt; 4.0.12 -&gt; 4.1.12 -&gt; 4.8.8 -&gt; 4.12.10 -&gt; 5.0.10 -&gt; 5.1.5 -&gt; 5.2.1
</pre>
</div>
</div>
<div id="outline-container-org50bbb93" class="outline-5">
<h5 id="org50bbb93">升级前检查及备份</h5>
<div class="outline-text-5" id="text-org50bbb93">
<p>
<a href="https://docs.gitlab.com/ee/update/plan_your_upgrade.html">https://docs.gitlab.com/ee/update/plan_your_upgrade.html</a>
</p>

<p>
对于回滚，提前做好数据备份和密钥备份便于后面恢复数据
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">https://docs.gitlab.com/charts/backup-restore/backup.html</span>
kubectl -n gitlab-test-xcw exec -it &lt;gitlab task-runner pod&gt; -- backup-utility

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#23494;&#38053;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">https://docs.gitlab.com/charts/backup-restore/backup.html#backup-the-secrets</span>
kubectl -n gitlab get secrets | grep rails-secret
kubectl -n gitlab get secrets &lt;rails-secret-name&gt; -o <span style="color: #a0522d;">jsonpath</span>=<span style="color: #8b2252;">"{.data['secrets\.yml']}"</span> | base64 --decode &gt; secrets.yaml
</pre>
</div>
</div>
</div>
<div id="outline-container-org61d561e" class="outline-5">
<h5 id="org61d561e">使用外置数据库</h5>
<div class="outline-text-5" id="text-org61d561e">
<p>
<a href="https://github.com/bitnami/bitnami-docker-postgresql">https://github.com/bitnami/bitnami-docker-postgresql</a>
</p>

<p>
<a href="https://github.com/bitnami/bitnami-docker-postgresql#953-r5">postgresql 9.5之后环境变量的改变</a>
</p>

<p>
<a href="https://github.com/bitnami/bitnami-docker-redis">https://github.com/bitnami/bitnami-docker-redis</a>
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b22222;">#</span><span style="color: #b22222;">cat docker-compose.yml</span>
version: <span style="color: #8b2252;">'3.9'</span>
services:
  postgresql:
    image: <span style="color: #8b2252;">'docker.io/bitnami/postgresql:10'</span>
    restart: always
    ports:
      - 15432:5432
      <span style="color: #b22222;">#</span><span style="color: #b22222;">- POSTGRESQL_USERNAME=cmn_git_web_rw</span>
    environment:
      - <span style="color: #a0522d;">TZ</span>=Asia/Shanghai
      - <span style="color: #a0522d;">ALLOW_EMPTY_PASSWORD</span>=yes
      - <span style="color: #a0522d;">POSTGRESQL_PASSWORD</span>=postgres
      - <span style="color: #a0522d;">POSTGRESQL_DATABASE</span>=cici_cmn_git
    volumes:
      - <span style="color: #8b2252;">'postgresql_data:/bitnami/postgresql'</span>
    networks:
    - app-pr

  redis:
    image: <span style="color: #8b2252;">'docker.io/bitnami/redis:6.0-debian-10'</span>
    restart: always
    ports:
      - 16379:6379
    environment:
      - <span style="color: #a0522d;">TZ</span>=Asia/Shanghai
      - <span style="color: #a0522d;">REDIS_PASSWORD</span>=123456
      - <span style="color: #a0522d;">REDIS_DISABLE_COMMANDS</span>=FLUSHDB,FLUSHALL
    volumes:
      - <span style="color: #8b2252;">'redis_data:/bitnami'</span>
    networks:
      - app-pr
volumes:
  postgresql_data:
    driver: local
  redis_data:
    driver: local
networks:
  app-pr:
    driver: bridge

<span style="color: #b22222;">#</span><span style="color: #b22222;">docker-compose up -d</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21368;&#36733;    </span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">docker-compose stop</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">docker-compose rm -v    </span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">docker-compose down -v #&#21024;&#38500;&#25968;&#25454;&#21367;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org29f2107" class="outline-5">
<h5 id="org29f2107">准备生产数据</h5>
<div class="outline-text-5" id="text-org29f2107">
<p>
数据备份在腾讯云cos中，使用coscmd工具将数据导入新环境中
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b22222;">#</span><span style="color: #b22222;">cat my-up-down.sh</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #b22222;">#</span>
<span style="color: #a0522d;">FILE</span>=$<span style="color: #a0522d;">1</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">DOWN_FILE=1631823001_2021_09_16_12.3.1-ee_gitlab_backup.tar</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">down  avg 8&#20998;26&#31186;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">\cp ~/.cos.conf.prod  ~/.cos.conf</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">coscmd download  ${FILE} ./</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">up  avg 13&#20998;57&#31186;</span>
\cp ~/.cos.conf.bedin  ~/.cos.conf
coscmd upload  ${<span style="color: #a0522d;">FILE</span>}
</pre>
</div>
</div>
</div>
<div id="outline-container-orge6e504c" class="outline-5">
<h5 id="orge6e504c">依次升级对应版本安</h5>
<div class="outline-text-5" id="text-orge6e504c">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#25214;&#29256;&#26412;</span>
helm search repo -l gitlab/gitlab
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#36733;&#65288;&#21487;&#36873;&#65292;&#29992;&#26469;&#23545;&#27604;&#24046;&#24322;&#65289;</span>
helm  pull  gitlab/gitlab --version=2.3.2


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;&#21319;&#32423;12.3.1&#29256;&#26412;&#65292;&#22914;&#26159;&#26032;&#29615;&#22659;&#38656;&#23548;&#20837;&#22791;&#20221;&#25968;&#25454;</span>
cat &lt;&lt;\EOF&gt; up-gitlab-2.3.2-test.sh
<span style="color: #ffa54f;">helm upgrade --install --force --namespace=gitlab-test-xcw gitlab-test-xcw  gitlab/gitlab \</span>
<span style="color: #ffa54f;">     --timeout 600s \</span>
<span style="color: #ffa54f;">     --version=2.3.2 \</span>
<span style="color: #ffa54f;">     `#--dry-run` \</span>
<span style="color: #ffa54f;">     --debug \</span>
<span style="color: #ffa54f;">     -f values-customize-2.3.2-test.yaml \</span>
<span style="color: #ffa54f;">     --set global.hosts.gitlab.name='git-test-xcw.cici.com' \</span>
<span style="color: #ffa54f;">     `#--&#22806;&#37096;postgresql--` \</span>
<span style="color: #ffa54f;">     --set postgresql.install=false \</span>
<span style="color: #ffa54f;">     --set global.psql.host='10.0.0.59' \</span>
<span style="color: #ffa54f;">     --set global.psql.port=15432 \</span>
<span style="color: #ffa54f;">     --set global.psql.password.secret=gitlab-test-pg \</span>
<span style="color: #ffa54f;">     --set global.psql.password.key='password' \</span>
<span style="color: #ffa54f;">     `#--&#22806;&#37096;redis--` \</span>
<span style="color: #ffa54f;">     --set redis.enabled=false \</span>
<span style="color: #ffa54f;">     --set global.redis.host='10.0.0.59' \</span>
<span style="color: #ffa54f;">     --set global.redis.port=16379 \</span>
<span style="color: #ffa54f;">     --set global.redis.password.secret=gitlab-test-redis \</span>
<span style="color: #ffa54f;">     --set global.redis.password.key='password' \</span>
<span style="color: #ffa54f;">     `#--set gitlab.migrations.enabled=true`</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
gitlab-test-xcw-migrations
</p>

<p>
image: registry.gitlab.com/gitlab-org/build/cng/gitlab-rails-ee:v12.3.1
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b22222;">#</span><span style="color: #b22222;">upgrade to GitLab Helm Chart version 2.6.0 before upgrading to 3.3.13</span>
helm upgrade --install --force --namespace=gitlab-test-xcw gitlab-test-xcw  gitlab/gitlab <span style="color: #8b2252;">\</span>
     --timeout 600s <span style="color: #8b2252;">\</span>
     --version=3.3.13 <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--dry-run`</span> <span style="color: #8b2252;">\</span>
     --debug <span style="color: #8b2252;">\</span>
     -f values-customize-3.3.13-test.yaml <span style="color: #8b2252;">\</span>
     --set global.hosts.gitlab.name=<span style="color: #8b2252;">'git-test-xcw.cici.com'</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#22806;&#37096;postgresql--`</span> <span style="color: #8b2252;">\</span>
     --set postgresql.install=false <span style="color: #8b2252;">\</span>
     --set global.psql.host=<span style="color: #8b2252;">'10.0.0.59'</span> <span style="color: #8b2252;">\</span>
     --set global.psql.port=35432 <span style="color: #8b2252;">\</span>
     --set global.psql.password.secret=gitlab-test-pg <span style="color: #8b2252;">\</span>
     --set global.psql.password.key=<span style="color: #8b2252;">'password'</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--&#22806;&#37096;redis--`</span> <span style="color: #8b2252;">\</span>
     --set redis.install=false <span style="color: #8b2252;">\</span>
     --set global.redis.host=<span style="color: #8b2252;">'10.0.0.59'</span> <span style="color: #8b2252;">\</span>
     --set global.redis.port=16379 <span style="color: #8b2252;">\</span>
     --set global.redis.password.secret=gitlab-test-redis <span style="color: #8b2252;">\</span>
     --set global.redis.password.key=<span style="color: #8b2252;">'password'</span> <span style="color: #8b2252;">\</span>
     <span style="color: #ff00ff;">`#--set gitlab.migrations.enabled=true`</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org982adff" class="outline-3">
<h3 id="org982adff">gitlab备份恢复</h3>
<div class="outline-text-3" id="text-org982adff">
<p>
官方升级计划：<a href="https://docs.gitlab.com/ee/update/plan_your_upgrade.html#pre-upgrade-and-post-upgrade-checks">升级计划</a>
</p>

<p>
官方参考：<a href="https://docs.gitlab.com/charts/backup-restore/index.html">chart备份与恢复</a>
</p>

<p>
<a href="https://gitlab.com/gitlab-org/charts/gitlab/-/blob/v2.3.2/doc/backup-restore/index.md">https://gitlab.com/gitlab-org/charts/gitlab/-/blob/v2.3.2/doc/backup-restore/index.md</a>
</p>

<p>
cos：gitlab-backup-1254024480
</p>
</div>
<div id="outline-container-org29cdc3d" class="outline-4">
<h4 id="org29cdc3d">备份</h4>
<div class="outline-text-4" id="text-org29cdc3d">
<p>
<a href="https://docs.gitlab.com/charts/backup-restore/backup.html">备份gitlab</a>
</p>

<p>
Task Runner pod中通过backup-utility程序进行GitLab 备份
</p>
</div>
<div id="outline-container-org8bf3d4e" class="outline-5">
<h5 id="org8bf3d4e">创建备份</h5>
<div class="outline-text-5" id="text-org8bf3d4e">
<p>
分为手动和自动
</p>

<ul class="org-ul">
<li><p>
手动：在Task Runner pod 中运行命令`backup-utility`备份
如果有bucket配置会上传，命名格式&lt;timestamp&gt;_&lt;version&gt;_gitlab_backup.tar
</p>
<div class="org-src-container">
<pre class="src src-bash">kubectl exec &lt;Task Runner pod name&gt; -it -- backup-utility
</pre>
</div></li>

<li><p>
自动：基于cron备份
</p>
<div class="org-src-container">
<pre class="src src-bash">--set gitlab.task-runner.backups.cron.enabled=true
--set gitlab.task-runner.backups.cron.schedule=<span style="color: #8b2252;">'0 1 * * *'</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orga5be799" class="outline-5">
<h5 id="orga5be799">备份秘密</h5>
<div class="outline-text-5" id="text-orga5be799">
<p>
如果使用gitlab-runner构建，需要备份rails secrets。防止只恢复数据后，
runner页面报500错误
</p>

<div class="org-src-container">
<pre class="src src-bash">kubectl -n gitlab get secrets | grep rails-secret
kubectl -n gitlab get secrets &lt;rails-secret-name&gt; -o <span style="color: #a0522d;">jsonpath</span>=<span style="color: #8b2252;">"{.data['secrets\.yml']}"</span> | base64 --decode &gt; secrets.yaml
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org8d309a6" class="outline-4">
<h4 id="org8d309a6">恢复</h4>
<div class="outline-text-4" id="text-org8d309a6">
<p>
<a href="https://docs.gitlab.com/charts/backup-restore/restore.html">恢复gitlab</a>
</p>

<p>
如果您的备份与当前安装的版本不同，则必须 在恢复备份之前<a href="https://docs.gitlab.com/ee/update/package/downgrade.html">降级 GitLab 安装</a>。
</p>

<p>
GitLab Helm chart 提供的备份实用程序支持从以下任何位置恢复 tarball
</p>

<ul class="org-ul">
<li>从gitlab-backups 的对象存储服务桶中恢复。这是默认情况。</li>
<li>从 pod 访问的公共 URL中恢复。</li>
<li>令将本地文件复制到 Task Runner pod容器中恢复。利用`kubectl cp`命令</li>
</ul>
</div>
<div id="outline-container-orgd9ac8bb" class="outline-5">
<h5 id="orgd9ac8bb">恢复 Rails 的secrets</h5>
<div class="outline-text-5" id="text-orgd9ac8bb">
<p>
`/etc/gitlab/gitlab-secrets.json`pod中文件表现为 `secrets.yml`
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20999;&#21040;&#21319;&#32423;&#30340;k8s&#29615;&#22659;</span>
kubectl config use-context k8s-test-context
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#25214; rails secrets &#30340;&#23545;&#35937;&#21517;&#31216;</span>
kubectl -n gitlab-test-xcw get secrets | grep rails-secret
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#29616;&#26377;&#30340;&#31192;&#23494;</span>
kubectl -n gitlab-test-xcw delete secret gitlab-test-xcw-rails-secret
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#19982;&#26087;&#23494;&#38053;&#30456;&#21516;&#30340;&#21517;&#31216;&#21019;&#24314;&#26032;&#23494;&#38053;&#65292;&#24182;&#20256;&#20837;&#24744;&#30340;&#26412;&#22320; YAML &#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">local-yaml-filepath&#20026;&#22791;&#20221;&#26102;&#23548;&#20986;&#30340;rails&#30340;secrets&#25991;&#20214; </span>
kubectl -n gitlab-test-xcw create secret generic gitlab-test-xcw-rails-secret --from-file=secrets.yml=&lt;local-yaml-filepath&gt;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#25214;&#19981;&#21040;&#21407;&#26469;&#30340;&#31192;&#38053;&#25991;&#20214;&#20102;&#65292;&#21487;&#20197;&#37325;&#32622;&#31192;&#38053;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">gitlab-rails console</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&gt;ApplicationSetting.current.reset_runners_registration_token!</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">=&gt;true</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org32ec508" class="outline-5">
<h5 id="org32ec508">重新启动 Pod</h5>
<div class="outline-text-5" id="text-org32ec508">
<p>
使用新的机密，需要重新启动 Webservice、Sidekiq 和 Task Runner pod
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #a0522d;">helm_release_name</span>=gitlab-test-xcw
kubectl -n gitlab-test-xcw delete pods -lapp=sidekiq,<span style="color: #a0522d;">release</span>=${<span style="color: #a0522d;">helm_release_name</span>}
<span style="color: #b22222;">#</span><span style="color: #b22222;">v5.2.1 unicorn &#25913;&#20026;webservice</span>
kubectl -n gitlab-test-xcw delete pods -lapp=unicorn,<span style="color: #a0522d;">release</span>=${<span style="color: #a0522d;">helm_release_name</span>}
kubectl -n gitlab-test-xcw delete pods -lapp=task-runner,<span style="color: #a0522d;">release</span>=${<span style="color: #a0522d;">helm_release_name</span>}
</pre>
</div>
</div>
</div>
<div id="outline-container-org63552c2" class="outline-5">
<h5 id="org63552c2">恢复备份文件</h5>
<div class="outline-text-5" id="text-org63552c2">
<p>
tarball命名格式确保&lt;timestamp&gt;_&lt;version&gt;_gitlab_backup.tar
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24674;&#22797;&#26041;&#24335;1&#65306;bucket&#26742;&#20013;&#35835;&#21462;tarball&#25991;&#20214;&#65292;&#40664;&#35748;</span>
kubectl exec &lt;Task Runner pod name&gt; -it -- backup-utility --restore -t &lt;timestamp&gt;_&lt;version&gt;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24674;&#22797;&#26041;&#24335;2&#65306;url</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24744;&#21487;&#20197;&#25552;&#20379;&#26412;&#22320;&#36335;&#24452;&#20316;&#20026; URL&#65292;&#21482;&#35201;&#23427;&#37319;&#29992;&#20197;&#19979;&#26684;&#24335;&#65306; file://&lt;path&gt;</span>
kubectl exec &lt;Task Runner pod name&gt; -it -- backup-utility --restore -f &lt;URL&gt;
</pre>
</div>

<p>
此过程将花费时间，具体取决于 tarball 的大小。
</p>
<ul class="org-ul">
<li>测试数据恢复时间：
<ul class="org-ul">
<li>60G恢复时间， 2.56s user 2.40s system 0% cpu 3:39:08.33 total</li>
</ul></li>
</ul>

<p>
恢复过程将删除数据库的现有内容，将现有存储库移动到临时位置并提取
tarball 的内容。
</p>

<p>
存储库将被移动到磁盘上的相应位置，其他数据，如工件、上传、LFS 等，将被
上传到对象存储中的相应存储区。
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org5814d5e" class="outline-3">
<h3 id="org5814d5e">迁移</h3>
<div class="outline-text-3" id="text-org5814d5e">
</div>
<div id="outline-container-org41a0b8d" class="outline-4">
<h4 id="org41a0b8d">从 Helm Chart 迁移到 Linux 包</h4>
<div class="outline-text-4" id="text-org41a0b8d">
<p>
参考：<a href="https://docs.gitlab.com/charts/installation/migration/helm_to_package.html">https://docs.gitlab.com/charts/installation/migration/helm_to_package.html</a>
</p>
</div>
</div>
</div>
<div id="outline-container-orgb635bd6" class="outline-3">
<h3 id="orgb635bd6">附录</h3>
<div class="outline-text-3" id="text-orgb635bd6">
</div>
<div id="outline-container-orgbd95194" class="outline-4">
<h4 id="orgbd95194">多版本镜像上传</h4>
<div class="outline-text-4" id="text-orgbd95194">
<ul class="org-ul">
<li>docker-image-v3.3.13.sh</li>
<li>docker-image-v4.0.12.sh</li>
<li>docker-image-v4.12.10.sh</li>
<li>docker-image-v4.8.8.sh</li>
<li>docker-image-v5.0.10.sh</li>
<li>docker-image-v5.2.4.sh</li>
</ul>
</div>
</div>
<div id="outline-container-orgad5a58b" class="outline-4">
<h4 id="orgad5a58b">多版本chart-values</h4>
<div class="outline-text-4" id="text-orgad5a58b">
<ul class="org-ul">
<li>values-customize-2.3.2-test.yaml</li>
<li>values-customize-3.3.13-test.yaml</li>
<li>values-customize-4.0.12-test.yaml</li>
<li>values-customize-4.12.10-test.yaml</li>
<li>values-customize-5.0.10-test.yaml</li>
<li>values-customize-5.2.4-test.yaml</li>
</ul>
</div>
</div>
</div>
</section>
</main class="container">
<footer id="postamble" class="status">
<footer data-astro-cid-sz7xmlte data-turbo-permanent id=rootFooter>
    <script>
        const shuffle = e => e.map((e => ({
            v: e,
            sort: Math.random()
        }))).sort(( (e, o) => e.sort - o.sort)).map(( ({v: e}) => e));
        var songList = ["barbie-girl--stantough", "blue-da-ba-dee--cornelius-link", "hips-dont-lie--stantough", "i-want-it-that-way--stantough", "seven-nation-army--stantough", "smooth-criminal--stantough"]
          , songOrder = songOrder ?? shuffle(songList).map((e => `/audio/music/${e}.opus`))
          , song = new Audio(songOrder[0])
          , nextSong = new Audio(songOrder[1])
          , songIndex = 2
          , musicWrapper = void 0
          , arrow = void 0
          , notes = void 0;
        song.addEventListener("ended", next);
        const toggle = () => song.paused ? play() : pause();
        function play() {
            song.play(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.add("shakeManHorse"),
            notes.classList.remove("hideNotes")
        }
        function pause() {
            song.pause(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.remove("shakeManHorse"),
            notes.classList.add("hideNotes")
        }
        function next() {
            song = nextSong,
            play(),
            songIndex === songOrder.length && (songIndex = 0),
            nextSong = new Audio(songOrder[songIndex]),
            songIndex += 1
        }
        function skip() {
            pause(),
            (arrow = arrow || document.getElementById("musicArrow")).classList.add("shootArrow");
            new Audio("/audio/effects/ohno.m4a").play(),
            arrow.addEventListener("animationend", arrowShootHandler, !1)
        }
        function arrowShootHandler() {
            arrow.removeEventListener("animationend", arrowShootHandler, !1),
            arrow.classList.remove("shootArrow");
            new Audio("/audio/effects/heythathurt.m4a").play(),
            next()
        }
    </script>
    <div id=musicPlayer data-astro-cid-q7a5pyro>
        <button class=skip data-astro-cid-q7a5pyro onclick=skip() title="Skip song">
            <div id=skipWrapper data-astro-cid-q7a5pyro>
                <img alt="Medieval drollery of a man/snail/bat/monkey shooting an arrow" class=archer decoding=async height=334 loading=lazy src=/images/archer-no-arrow.448ccd8b_Z1KfRYq.webp width=226 data-astro-cid-q7a5pyro>
                <img alt="Arrow for archer" class="arrow complete" decoding=async height=23 loading=lazy src=/images/no-archer-full-arrow.87aa9971_Z2qL2KO.webp width=141 data-astro-cid-q7a5pyro id=musicArrow>
            </div>
        </button>
        <button class=playPause data-astro-cid-q7a5pyro onclick=toggle() title="Play/pause song">
            <div id=musicWrapper data-astro-cid-q7a5pyro>
                <div class=hideNotes id=notesWrapper data-astro-cid-q7a5pyro>
                    <div class=lyreNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                    <div class=fluteNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                </div>
                <img alt="Medieval drollery of a man/horse playing a lyre and a horn" class=manHorse decoding=async height=665 loading=lazy src=/images/man-horse-band.e3a2efcf_q8FCa.webp width=531 data-astro-cid-q7a5pyro>
            </div>
        </button>
    </div>
    <hr data-astro-cid-sz7xmlte>
    <div class=salutation data-astro-cid-gdmrbrho>
        <p data-astro-cid-gdmrbrho>
            <span class=flower2 data-astro-cid-gdmrbrho>A</span>
            <span class=smallcap data-astro-cid-gdmrbrho>pax vobiscum</span>
            <span class="flower2 wiggle" data-astro-cid-gdmrbrho id=leaf>a</span>
        </p>
    </div>
    <script>
        function animateLeafBlownHandler() {
            leaf.removeEventListener("animationend", animateLeafBlownHandler, !1),
            leaf.classList.remove("blownAway"),
            leaf.classList.add("wiggle")
        }
        function animateLeaf() {
            leaf = leaf ?? document.getElementById("leaf"),
            leaf.classList.remove("wiggle"),
            leaf.classList.add("blownAway"),
            leaf.addEventListener("animationend", animateLeafBlownHandler, !1)
        }
        document.getElementById("leaf").onclick = animateLeaf
    </script>


    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2024 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
</footer>
</footer>
</body>
</html>
