<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: 软件管理</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux: 软件管理</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:837d61c9-5033-4b42-8399-74678df98576">软件运行和编译</a>
<ul>
<li><a href="#h:b43402c6-743d-4e7d-9043-e060cff006b8">软件相关概念</a>
<ul>
<li><a href="#h:a2ffd68e-cc23-4d23-bdc9-183d86e70fd9">ABI</a></li>
<li><a href="#h:bf4a4c6a-fb66-4de7-accd-43cf585d1372">API</a></li>
<li><a href="#h:c44af887-f3d5-4664-a9c6-c12f7728a3c8">开发语言</a></li>
</ul>
</li>
<li><a href="#h:47ac1fdc-c97d-4b12-835a-eaaba90f1ead">C语言程序的实现过程</a></li>
<li><a href="#h:bb7c01e2-b92b-415f-a84b-9fd0ed59ddee">软件模块的静态和动态链接</a>
<ul>
<li><a href="#h:7fcf09d9-4a42-4751-b037-b0fd9ef035a0">静态链接</a></li>
<li><a href="#h:9928cc67-d25c-4fe9-9c2c-407e7806cd09">动态链接</a></li>
<li><a href="#h:f6abc1a5-4710-4cbb-ae19-e47644be48b9">模块（库）文件</a></li>
</ul>
</li>
<li><a href="#h:338bf581-ed67-4143-b71e-81d55906d115">Java程序编译运行过程</a></li>
</ul>
</li>
<li><a href="#h:6c25e601-3718-486b-b6b7-8e04b22f1059">软件包和包管理器</a>
<ul>
<li><a href="#h:c262c8f6-4488-446e-ad59-2bbc630cb2c5">软件包介绍</a>
<ul>
<li><a href="#h:d806e1a5-d451-414c-aead-787f0d601002">软件包中的文件分类</a></li>
<li><a href="#h:a6a13cef-6563-45f6-9e9c-1b0d15f955e0">程序包管理器</a></li>
<li><a href="#h:f945dcd0-56cb-4234-9149-9856990a3964">包命名</a></li>
<li><a href="#h:479cbf80-b900-4140-82bb-4d9409db95d7">分类和拆包</a></li>
<li><a href="#h:88e272c8-31ce-49d9-9e6f-8f656f72e8e4">包的依赖</a></li>
<li><a href="#h:08dae7f9-2a64-40ec-88ee-25e4e1abbd90">程序包管理器相关文件</a></li>
<li><a href="#h:c31ee92c-a0b4-4955-b1f1-23b06ce5662a">获取程序包的途径</a>
<ul>
<li><a href="#h:e9916de8-6d62-4f17-8191-91295e0a8b6d">系统发版的光盘或官方网站</a></li>
<li><a href="#h:6eaae818-a901-4e66-9b8c-37d4cbe8deb5">第三方组织提供</a></li>
<li><a href="#h:88846cc1-fb66-4d36-95dc-b6ac467f83dc">软件项目官方站点</a></li>
<li><a href="#h:1f246c51-9b36-441e-af80-863893fbb1fc">搜索引擎</a></li>
<li><a href="#h:9f6c3bdd-50d7-4e0c-82a7-7bf3be6bb9ba">自己制作</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:67ed83cd-a5d7-4cc4-ba8d-a431570b2139">包管理器rpm</a>
<ul>
<li><a href="#h:544cfc17-9ebc-43bb-802a-6b9d8a08ae54">安装</a></li>
<li><a href="#h:82ea39a9-0903-4506-8c27-c5d61877a629">升级和降级</a></li>
<li><a href="#h:ce35e207-58c6-4949-a16c-c0a4afa6598b">包查询</a></li>
<li><a href="#h:2e24402e-9d33-404d-95da-ae3ca93125b4">包卸载</a></li>
<li><a href="#h:52014c9c-cf3c-43cf-bedd-6a0d097ce478">包校验</a></li>
<li><a href="#h:5c158fee-1dc8-41e6-a4de-de581a78f60b">数据库</a></li>
</ul>
</li>
<li><a href="#h:328e7c58-986e-4291-ad14-c020117983a8">yum和dnf</a>
<ul>
<li><a href="#h:41183e23-91dd-4eda-9734-10455d42a144">yum/dnf 工作原理</a></li>
<li><a href="#h:11f69a5b-babf-4133-b4eb-7b4b6f01878b">yum客户端配置</a>
<ul>
<li><a href="#h:443242a3-12c4-42aa-9396-05141e1888f1">/etc/yum.conf主配置定义</a></li>
<li><a href="#h:352c0b6b-420b-46fa-a986-0414b2618646">仓库(*.repo)配置文件定义：</a></li>
<li><a href="#h:dffb8357-f15a-4707-8041-e1dfc59eb216">yum-config-manager命令</a></li>
<li><a href="#h:c7e0b143-26b2-45bc-b851-f853ccc21c09">锁定软件版本</a></li>
</ul>
</li>
<li><a href="#h:cba0e6bc-ecc7-4dea-8806-52951d45d63d">yum命令</a>
<ul>
<li><a href="#h:20020b7b-fb37-458f-b470-ae93033ae661">显示仓库列表</a></li>
<li><a href="#h:f767d76f-2dc8-46ea-adb4-e68dbf531e2c">显示程序包</a></li>
<li><a href="#h:8cb17a52-2951-42a3-9c8d-357901b3c0ea">安装程序包</a>
<ul>
<li><a href="#h:b76289ec-56f5-4271-8f29-d98e13b0b6a8">范例：只下载不安装</a></li>
<li><a href="#h:c02ccb31-a0ec-4eb5-a1e3-f735f0c6a8b9">范例：利用elrepo源在CentOS 7 安装新版内核</a></li>
</ul>
</li>
<li><a href="#h:51a5b9e4-4811-42d8-8cd1-e76b78b9ca69">卸载程序包</a></li>
<li><a href="#h:27b4acc9-5922-4c70-bef0-866b76a21596">升级和降级</a></li>
<li><a href="#h:f3fc4561-2146-4283-989c-0f8b847073d7">查询</a></li>
<li><a href="#h:d11b2a47-813a-4c05-ac3e-3718aaf92fea">仓库缓存</a></li>
<li><a href="#h:3cdce67e-9825-4c88-b953-f7c3d77cd8f0">查看yum事务历史</a></li>
<li><a href="#h:151e618d-41f2-4296-86ea-800111925875">安装及升级本地程序包</a></li>
<li><a href="#org39cc6c0">查看包的安全警报</a></li>
<li><a href="#h:1b3ff4a3-da51-4184-ab6d-b6328f171bdc">包组管理的相关命令</a></li>
<li><a href="#h:63ec964a-bb5a-4faa-bbf7-475adcaac0e5">实现私用 yum仓库</a></li>
<li><a href="#h:1a95dba4-44af-4866-b38a-9044eab803b2">DNF 介绍</a></li>
<li><a href="#h:d84bb7d7-5799-403e-aa93-4e95aec4f6c4">yum Troubleshooting</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:ee8702e2-25dc-4096-bf4d-210aae3a906f">程序包编译</a>
<ul>
<li><a href="#h:f64a6f08-63d6-41ce-870b-83b12f331e66">源码编译介绍</a></li>
<li><a href="#h:df05665b-8680-4c49-9de8-0d9361484ae0">开源程序源代码的获取</a></li>
<li><a href="#h:7a2c0189-8b82-4238-bf01-d8a8bd14a162">编译源码的项目工具</a></li>
<li><a href="#h:5eadb370-44cc-4855-ad66-9f9fa91194d1">C语言源代码编译安装过程</a>
<ul>
<li><a href="#h:241bf723-dd84-498b-99b6-3965c0954a2d">编译安装准备</a></li>
<li><a href="#h:e9d3886c-10ff-4f0f-9ee4-1a8f08c88f61">编译安装</a></li>
<li><a href="#h:cde24117-8fde-47ef-b0f3-8ff0ceccf999">安装后的配置</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:4b3e2142-78a3-4377-8161-6562169c891f">Ubuntu 软件管理</a>
<ul>
<li><a href="#h:643f7863-e72b-4023-8f8c-5bbfa5f6918e">APT工作原理</a></li>
<li><a href="#h:da743a3f-8cc6-4931-90b8-6c0820731b2f">dpkg 包管理器</a></li>
<li><a href="#h:49de8721-b2df-4089-a65e-eb1c700e1d30">apt</a></li>
<li><a href="#h:b78fb7e2-f822-4cc3-9092-f15e593aa560">软件管理案例</a></li>
<li><a href="#h:1371b82f-9dfa-4557-9b0c-871c42e2563c">ubuntu建议安装的常用包</a></li>
</ul>
</li>
<li><a href="#h:549bdb1f-b5e7-4961-9f37-ce8737d8e46f">rpm包制作</a>
<ul>
<li><a href="#h:70e2bbad-37db-483a-a457-8e5e11c9bab2">快速制作RPM</a>
<ul>
<li><a href="#h:0e7e9b7d-d09c-48dd-84c2-f2221f059407">快速制作RPM</a>
<ul>
<li><a href="#h:1959d010-332c-490e-ba63-c9e7e317a5c2">准备制作RPM包</a></li>
<li><a href="#h:db3f3648-9db8-4f63-952d-ad166c48a817">规划RPM包</a></li>
<li><a href="#h:e0ea36fb-22a8-4926-a5b8-00442c34a2bb">解释制作的过程</a></li>
<li><a href="#h:3b0b7809-1fe4-40a0-bc15-d49ce8786416">如何使用制作的相关文件</a></li>
<li><a href="#h:1584f173-f06f-4d64-a854-f0e7a932f2f0">验证结果</a></li>
</ul>
</li>
<li><a href="#h:6b808e24-eef0-4d91-8414-9b51bb7273ad">写一个Spec文件</a>
<ul>
<li><a href="#h:c15db9cb-7564-4dc3-9278-0eca504bb8e7">spec文件语法格式</a></li>
<li><a href="#h:9c55a872-4868-4243-a019-1308cc292365">定义包的信息</a></li>
<li><a href="#h:42781958-7adc-403b-a4f1-26e786113853">控制编译安装过程</a></li>
<li><a href="#h:6d5fea45-2645-4a6b-a345-0cc3ecceb9b0">脚本段</a></li>
<li><a href="#h:93f62913-31a8-4197-b70d-3477fdbcfde5">文件段，列出的文件 %files</a></li>
<li><a href="#h:21eb0f66-bbf0-4c4a-a165-a169bd9a21d7">changlog改变日志段 %changelog</a></li>
<li><a href="#h:a118878a-0abc-4706-b96a-f9234488bb64">如何在spec文件中使用宏</a></li>
</ul>
</li>
<li><a href="#h:9aea5127-5c75-4cc8-93ae-7d4ea62ba8c5">RPM包签名</a></li>
<li><a href="#h:0a27839a-f3b4-42b2-8a3a-dc002bddcd71">RPM拆包</a>
<ul>
<li><a href="#h:eb9ce5f0-b998-4060-84f3-0c421a94d2f7">必选功能段</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:fc8d1de9-cc97-4253-aafa-2a0f8b29582b">FPM</a>
<ul>
<li><a href="#h:2543eea9-0288-4092-ba76-427cee89f04b">FPM打包工具</a></li>
<li><a href="#h:c1bc70c3-5442-4fdf-90e2-c39bc6284be2">使用实例&#x2013;实战定制nginx的RPM包</a></li>
<li><a href="#h:0cdf247a-b567-496d-8712-ea7b743045c3">注意事项</a></li>
<li><a href="#h:bf21d0dc-57ca-42cd-8d0e-9df143577cdd">定制LNMP的RPM包思路</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../../index.html">Linux</a></li>
</ul>

<p>
摘要：本文介绍软件管理
</p>

<p>
内容概述
</p>

<ul class="org-ul">
<li>软件运行环境</li>
<li>软件包基础</li>
<li>rpm包管理</li>
<li>yum和dnf 管理</li>
<li>定制yum仓库</li>
<li>编译安装</li>
<li>Ubuntu软件管理</li>
</ul>
<section id="outline-container-h:837d61c9-5033-4b42-8399-74678df98576" class="outline-2">
<h2 id="h:837d61c9-5033-4b42-8399-74678df98576">软件运行和编译</h2>
<div class="outline-text-2" id="text-h:837d61c9-5033-4b42-8399-74678df98576">
</div>
<div id="outline-container-h:b43402c6-743d-4e7d-9043-e060cff006b8" class="outline-3">
<h3 id="h:b43402c6-743d-4e7d-9043-e060cff006b8">软件相关概念</h3>
<div class="outline-text-3" id="text-h:b43402c6-743d-4e7d-9043-e060cff006b8">

<figure id="org86f5aad">
<img src="images/image-20210216014134231.png" alt="image-20210216014134231.png" width="80%">

</figure>



<figure id="org53ff3c2">
<img src="images/image-20210216014154510.png" alt="image-20210216014154510.png" width="80%">

</figure>
</div>
<div id="outline-container-h:a2ffd68e-cc23-4d23-bdc9-183d86e70fd9" class="outline-4">
<h4 id="h:a2ffd68e-cc23-4d23-bdc9-183d86e70fd9">ABI</h4>
<div class="outline-text-4" id="text-h:a2ffd68e-cc23-4d23-bdc9-183d86e70fd9">
<p>
ABI即 Application Binary Interface
</p>


<p>
Windows与Linux不兼容
</p>

<ul class="org-ul">
<li>ELF(Executable and Linkable Format)</li>
<li>PE（Portable Executable）</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">[root@test ~]# file /bin/hostname
/bin/hostname: ELF 64-bit LSB pie executable, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, <span style="color: #a0522d;">BuildID</span>[sha1]=26daeb4dffa6a2e15eb287407e656a762927380b, for GNU/Linux 3.7.0, stripped

</pre>
</div>

<p>
库级别的虚拟化：
</p>

<ul class="org-ul">
<li>Linux: WINE</li>
<li>Windows: Cygwin</li>
</ul>
</div>
</div>
<div id="outline-container-h:bf4a4c6a-fb66-4de7-accd-43cf585d1372" class="outline-4">
<h4 id="h:bf4a4c6a-fb66-4de7-accd-43cf585d1372">API</h4>
<div class="outline-text-4" id="text-h:bf4a4c6a-fb66-4de7-accd-43cf585d1372">
<p>
API即Application Programming Interface，API可以在各种不同的操作系统上
实现给应用程序提供完全相同的接口，而它们本身在这些系统上的实现却可能迥
异，主流的操作系统有两种，一种是Windows系统，另一种是Linux系统。由于操
作系统的不同，API又分为Windows API和Linux API。在Windows平台开发出来的
软件在Linux上无法运行，在Linux上开发的软件在Windows上又无法运行，这就
导致了软件移植困难，POSIX标准的出现就是为了解决这个问题
</p>

<p>
POSIX：Portable Operating System Interface可移植操作系统接口，定义了操
作系统应该为应用程序提供的接口标准，是IEEE为要在各种UNIX操作系统上运行
的软件而定义的一系列API标准的总称。Linux和windows都要实现基本的posix标
准，程序就在源代码级别可移植了
</p>
</div>
</div>
<div id="outline-container-h:c44af887-f3d5-4664-a9c6-c12f7728a3c8" class="outline-4">
<h4 id="h:c44af887-f3d5-4664-a9c6-c12f7728a3c8">开发语言</h4>
<div class="outline-text-4" id="text-h:c44af887-f3d5-4664-a9c6-c12f7728a3c8">
<p>
系统级开发
</p>
<ul class="org-ul">
<li>汇编语言</li>
<li>C</li>
<li>C++</li>
</ul>

<p>
应用级开发
</p>
<ul class="org-ul">
<li>java</li>
<li>Python</li>
<li>go</li>
<li>php</li>
<li>perl</li>
<li>delphi</li>
<li>basic</li>
<li>ruby</li>
<li>bash</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:47ac1fdc-c97d-4b12-835a-eaaba90f1ead" class="outline-3">
<h3 id="h:47ac1fdc-c97d-4b12-835a-eaaba90f1ead">C语言程序的实现过程</h3>
<div class="outline-text-3" id="text-h:47ac1fdc-c97d-4b12-835a-eaaba90f1ead">
<p>
C 程序源代码 &#x2013;&gt; 预处理 &#x2013;&gt; 编译 &#x2013;&gt; 汇编 &#x2013;&gt; 链接
</p>

<p>
C语言的程序编译主要经过四个过程：
</p>



<figure id="orgb95ee31">
<img src="images/image-20210216014218324.png" alt="image-20210216014218324.png" width="60%">

</figure>

<ul class="org-ul">
<li>预处理（Pre-Processing）
<ol class="org-ol">
<li>将所有的#define删除，并且展开所有的宏定义</li>
<li>处理所有的条件预编译指令，比如#if #ifdef #elif #else #endif等</li>
<li>处理#include 预编译指令，将被包含的文件插入到该预编译指令的位置。</li>
<li>删除所有注释 "//"和”/* */“.</li>
<li>添加行号和文件标识，以便编译时产生调试用的行号及编译错误警告行号。</li>
<li>保留所有的#pragma编译器指令，因为编译器需要使用它们</li>
</ol></li>

<li><p>
编译 （Compiling）
</p>

<p>
编译过程就是把预处理完的文件进行一系列的词法分析，语法分析，语义分析
及优化后，最后生成相应的汇编代码
</p></li>

<li><p>
汇编 （Assembling）
</p>

<p>
汇编器是将汇编代码转变成机器可以执行的命令，每一个汇编语句几乎都对应
一条机器指令。汇编相对于编译过程比较简单，根据汇编指令和机器指令的对
照表一一翻译即可
</p></li>

<li><p>
链接 （Linking）
</p>

<p>
通过调用链接器ld来链接程序运行需要的一大堆目标文件，以及所依赖的其它
库文件，最后生成可执行文件
</p></li>
</ul>

<p>
范例：gcc 编译过程
</p>

<div class="org-src-container">
<pre class="src src-sh">cat &lt;&lt;\EOF&gt; hello.c
<span style="color: #ffa54f;">#include &lt;stdio.h&gt;</span>

<span style="color: #ffa54f;">int main(void)</span>
<span style="color: #ffa54f;">{</span>
<span style="color: #ffa54f;">  printf("Hello World!\n");</span>
<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#27493;&#39588;&#32534;&#35793;&#36816;&#34892;</span>
gcc -E hello.c -o hello.i  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;hello.c&#25991;&#20214;&#36827;&#34892;&#39044;&#22788;&#29702;&#65292;&#29983;&#25104;&#20102;hello.i &#25991;&#20214;</span>
gcc -S hello.i -o hello.s  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#39044;&#22788;&#29702;&#25991;&#20214;&#36827;&#34892;&#32534;&#35793;&#65292;&#29983;&#25104;&#20102;&#27719;&#32534;&#25991;&#20214;</span>
gcc -c hello.s -o hello.o  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#27719;&#32534;&#25991;&#20214;&#36827;&#34892;&#32534;&#35793;&#65292;&#29983;&#25104;&#20102;&#30446;&#26631;&#25991;&#20214;</span>
gcc hello.o -o hello        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#30446;&#26631;&#25991;&#20214;&#36827;&#34892;&#38142;&#25509;&#65292;&#29983;&#25104;&#21487;&#25191;&#34892;&#25991;&#20214;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#27493;&#23454;&#29616;&#32534;&#35793;&#36807;&#31243;</span>
gcc hello.c -o hello &#30452;&#25509;&#32534;&#35793;&#38142;&#25509;&#25104;&#21487;&#25191;&#34892;&#30446;&#26631;&#25991;&#20214;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bb7c01e2-b92b-415f-a84b-9fd0ed59ddee" class="outline-3">
<h3 id="h:bb7c01e2-b92b-415f-a84b-9fd0ed59ddee">软件模块的静态和动态链接</h3>
<div class="outline-text-3" id="text-h:bb7c01e2-b92b-415f-a84b-9fd0ed59ddee">
<p>
链接主要作用是把各个模块之间相互引用的部分处理好，使得各个模块之间能够
正确地衔接，分为静态和动态链接
</p>



<figure id="orgfd1e72d">
<img src="images/image-20210216014234673.png" alt="image-20210216014234673.png" width="60%">

</figure>
</div>
<div id="outline-container-h:7fcf09d9-4a42-4751-b037-b0fd9ef035a0" class="outline-4">
<h4 id="h:7fcf09d9-4a42-4751-b037-b0fd9ef035a0">静态链接</h4>
<div class="outline-text-4" id="text-h:7fcf09d9-4a42-4751-b037-b0fd9ef035a0">
<ul class="org-ul">
<li>把程序对应的依赖库复制一份到包</li>
<li>生成模块文件libxxx.a</li>
<li>嵌入程序包</li>
<li>升级难，需重新编译</li>
<li>占用较多空间，迁移容易</li>
</ul>
</div>
</div>
<div id="outline-container-h:9928cc67-d25c-4fe9-9c2c-407e7806cd09" class="outline-4">
<h4 id="h:9928cc67-d25c-4fe9-9c2c-407e7806cd09">动态链接</h4>
<div class="outline-text-4" id="text-h:9928cc67-d25c-4fe9-9c2c-407e7806cd09">
<ul class="org-ul">
<li>只把依赖加做一个动态链接</li>
<li>生成模块文件libxxx.so</li>
<li>连接指向</li>
<li>占用较少空间，升级方便</li>
</ul>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-shell">root@debian:~/.jasper# file hello
hello: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span style="color: #a0522d;">BuildID</span>[sha1]=6d0e42e93b2869fabde6055a1301dd64870fe558, for GNU/Linux 3.2.0, not stripped
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20854;&#20013;  dynamically linked &#34920;&#31034;&#21160;&#24577;&#38142;&#25509;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#31243;&#24207;&#20381;&#36182;&#30340;&#31532;&#19977;&#26041;&#24211; ldd</span>
root@debian:~/.jasper# ldd hello
        linux-vdso.so.1 (0x00007ffdb99b4000)  <span style="color: #b22222;">#</span><span style="color: #b22222;">.so &#25991;&#20214; shared object &#20849;&#20139;&#30340;&#23545;&#35937;</span>
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f64b021d000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f64b0418000)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f6abc1a5-4710-4cbb-ae19-e47644be48b9" class="outline-4">
<h4 id="h:f6abc1a5-4710-4cbb-ae19-e47644be48b9">模块（库）文件</h4>
<div class="outline-text-4" id="text-h:f6abc1a5-4710-4cbb-ae19-e47644be48b9">
<p>
查看二进制程序所依赖的库文件
</p>

<div class="org-src-container">
<pre class="src src-sh">ldd /PATH/TO/BINARY_FILE
</pre>
</div>

<p>
管理及查看本机装载的库文件
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#36733;&#37197;&#32622;&#25991;&#20214;&#20013;&#25351;&#23450;&#30340;&#24211;&#25991;&#20214;</span>
ldconfig

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#26412;&#26426;&#24050;&#32463;&#32531;&#23384;&#30340;&#25152;&#26377;&#21487;&#29992;&#24211;&#25991;&#20214;&#21517;&#21450;&#25991;&#20214;&#36335;&#24452;&#26144;&#23556;&#20851;&#31995;</span>
/sbin/ldconfig &#8211;p
</pre>
</div>

<p>
配置文件：
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/ld.so.conf,
/etc/ld.so.conf.d/*.conf
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">(2) &#23548;&#20986;&#24211;&#25991;&#20214;&#36335;&#24452;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#36753;/etc/ld.so.conf.d/NAME.conf   &#28155;&#21152;&#26032;&#30340;&#24211;&#25991;&#20214;&#25152;&#22312;&#30446;&#24405;&#33267;&#27492;&#25991;&#20214;&#20013;&#65307;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35753;&#31995;&#32479;&#37325;&#26032;&#29983;&#25104;&#32531;&#23384;&#65306;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ldconfig [-v]  #&#35201;&#26174;&#31034;&#36807;&#31243;&#23601;&#21152;-v&#36873;&#39033;</span>
[root@localhost httpd-2.4.18]# cat /etc/ld.so.conf.d/apache2.conf
/usr/local/apache2/lib
[root@localhost httpd-2.4.18]# ldconfig
</pre>
</div>

<p>
缓存文件：
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/ld.so.cache
</pre>
</div>

<p>
范例：库文件破坏后，将导致依赖的程序无法正常运行
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ldd /bin/ls
    linux-vdso.so.1 (0x00007ffc509fd000)
    libselinux.so.1 =&gt; /lib64/libselinux.so.1 (0x00007fc6ef24a000)
    libcap.so.2 =&gt; /lib64/libcap.so.2 (0x00007fc6ef044000)
    libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fc6eec81000)
    libpcre2-8.so.0 =&gt; /lib64/libpcre2-8.so.0 (0x00007fc6ee9fd000)
    libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007fc6ee7f9000)
    /lib64/ld-linux-x86-64.so.2 (0x00007fc6ef698000)
    libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00007fc6ee5d9000)

[root@centos8 ~]#ldd /bin/cat
    linux-vdso.so.1 (0x00007ffe335dd000)
    libc.so.6 =&gt; /lib64/libc.so.6 (0x00007fa34749e000)
    /lib64/ld-linux-x86-64.so.2 (0x00007fa347a6b000)
[root@centos8 ~]#mv /lib64/libc.so.6 /tmp
[root@centos8 ~]#ls
ls: error while loading shared libraries: libc.so.6: cannot open shared object
file: No such file or directory
[root@centos8 ~]#cat
cat: error while loading shared libraries: libc.so.6: cannot open shared object
file: No such file or directory

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21160;&#24577;&#25991;&#20214;&#36801;&#31227;</span>
<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> $(<span style="color: #ff00ff;">ldd /bin/bash | grep -o '/[^[:space:]]\+[0-9]\&gt;'</span>); <span style="color: #a020f0;">do</span> cp $<span style="color: #a0522d;">i</span> /mnt/sysroot/lib64 ;<span style="color: #a020f0;">done</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:338bf581-ed67-4143-b71e-81d55906d115" class="outline-3">
<h3 id="h:338bf581-ed67-4143-b71e-81d55906d115">Java程序编译运行过程</h3>
<div class="outline-text-3" id="text-h:338bf581-ed67-4143-b71e-81d55906d115">

<figure id="orgac90c6a">
<img src="images/image-20210216014252395.png" alt="image-20210216014252395.png" width="60%">

</figure>
</div>
</div>
</section>
<section id="outline-container-h:6c25e601-3718-486b-b6b7-8e04b22f1059" class="outline-2">
<h2 id="h:6c25e601-3718-486b-b6b7-8e04b22f1059">软件包和包管理器</h2>
<div class="outline-text-2" id="text-h:6c25e601-3718-486b-b6b7-8e04b22f1059">
</div>
<div id="outline-container-h:c262c8f6-4488-446e-ad59-2bbc630cb2c5" class="outline-3">
<h3 id="h:c262c8f6-4488-446e-ad59-2bbc630cb2c5">软件包介绍</h3>
<div class="outline-text-3" id="text-h:c262c8f6-4488-446e-ad59-2bbc630cb2c5">
<p>
开源软件最初只提供了.tar.gz的打包的源码文件，用户必须自已编译每个想在
GNU/Linux上运行的软件。用户急需系统能提供一种更加便利的方法来管理这些
软件，当Debian诞生时，这样一个管理工具dpkg也就应运而生，可用来管理deb
后缀的”包”文件。从而著名的”package”概念第一次出现在GNU/Linux系统中，
稍后Red Hat才开发自己的rpm包管理系统
</p>
</div>
<div id="outline-container-h:d806e1a5-d451-414c-aead-787f0d601002" class="outline-4">
<h4 id="h:d806e1a5-d451-414c-aead-787f0d601002">软件包中的文件分类</h4>
<div class="outline-text-4" id="text-h:d806e1a5-d451-414c-aead-787f0d601002">
<ul class="org-ul">
<li>二进制文件</li>
<li>库文件</li>
<li>配置文件</li>
<li>帮助文件</li>
</ul>

<p>
范例：利用 cpio工具查看包文件列表
</p>
<div class="org-src-container">
<pre class="src src-sh">rpm2cpio &#21253;&#25991;&#20214;|cpio &#8211;itv              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#39044;&#35272;&#21253;&#20869;&#25991;&#20214;</span>
rpm2cpio &#21253;&#25991;&#20214;|cpio &#8211;id <span style="color: #8b2252;">"*.conf"</span>  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37322;&#25918;&#21253;&#20869;&#25991;&#20214;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">rpm2cpio jenkins-2.222.1-1.1.noarch.rpm  | cpio -itv</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a6a13cef-6563-45f6-9e9c-1b0d15f955e0" class="outline-4">
<h4 id="h:a6a13cef-6563-45f6-9e9c-1b0d15f955e0">程序包管理器</h4>
<div class="outline-text-4" id="text-h:a6a13cef-6563-45f6-9e9c-1b0d15f955e0">
<p>
软件包管理器功能：将编译好的应用程序的各组成文件打包一个或几个程序包文
件，利用包管理器可以方便快捷地实现程序包的安装、卸载、查询、升级和校验
等管理操作
</p>

<p>
主流的程序包管理器
</p>

<ul class="org-ul">
<li>redhat：rpm文件, rpm 包管理器，rpm：Redhat Package Manager，后来叫RPM
Package Manager</li>
<li>debian：deb文件, dpkg 包管理器</li>
</ul>
</div>
</div>
<div id="outline-container-h:f945dcd0-56cb-4234-9149-9856990a3964" class="outline-4">
<h4 id="h:f945dcd0-56cb-4234-9149-9856990a3964">包命名</h4>
<div class="outline-text-4" id="text-h:f945dcd0-56cb-4234-9149-9856990a3964">
<p>
源代码打包文件命名：
</p>

<div class="org-src-container">
<pre class="src src-sh">name-VERSION.tar.gz|bz2|xz
VERSION: major.minor.release
</pre>
</div>

<p>
rpm包命名方式：
</p>

<div class="org-src-container">
<pre class="src src-sh">name-VERSION-release.arch.rpm
VERSION: major.minor.release
release&#65306;release.OS
</pre>
</div>

<p>
VERSION: major.minor.release
</p>
<ul class="org-ul">
<li>major:主版本号，重大的版本分支</li>
<li>minor：次版本号；功能改变</li>
<li>release：发行号；修复bug，更改一小段代码；</li>
</ul>

<p>
常见的arch：
</p>

<ul class="org-ul">
<li>x86: i386, i486, i586, i686</li>
<li>x86_64: x64, x86_64, amd64</li>
<li>powerpc: ppc</li>
<li>跟平台无关：noarch</li>
</ul>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">bash-3.2-32.el5_9.1.i386.rpm
bash-4.2.46-19.el7.x86_64.rpm
bash-4.4.19-7.el8.x86_64.rpm
bash-4.4.19-7.el8.aarch64.rpm
bash-4.4.19-7.el8.ppc64le.rpm
bc_1.07.1-2_amd64.deb
bc_1.07.1-2_s390x.deb
</pre>
</div>

<p>
范例：统计rpm的架构类型及相应的包数量
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 Packages]#pwd
/misc/cd/BaseOS/Packages
[root@centos8 Packages]#ls *.rpm | grep -Eo <span style="color: #8b2252;">'[^.]+\.rpm$'</span>| grep -Eo <span style="color: #8b2252;">'^[^.]+'</span>|sort |uniq -c
  389 i686
  211 noarch
 1061 x86_64
[root@centos8 Packages]#ls *.rpm |rev|cut -d. -f2|rev |sort |uniq -c
  389 i686
  211 noarch
 1061 x86_64
[root@centos8 Packages]#ls *.rpm | grep -Eo <span style="color: #8b2252;">'[^.]+\.rpm$'</span>|cut -d. -f1|sort |uniq -c
  389 i686
  211 noarch
 1061 x86_64
</pre>
</div>
</div>
</div>
<div id="outline-container-h:479cbf80-b900-4140-82bb-4d9409db95d7" class="outline-4">
<h4 id="h:479cbf80-b900-4140-82bb-4d9409db95d7">分类和拆包</h4>
<div class="outline-text-4" id="text-h:479cbf80-b900-4140-82bb-4d9409db95d7">
<p>
软件包为了管理和使用的便利，会将一个大的软件分类，放在不同的子包中。
</p>

<p>
包的分类
</p>

<ul class="org-ul">
<li>Application-VERSION-ARCH.rpm: 主包</li>
<li>Application-devel-VERSION-ARCH.rpm 开发子包</li>
<li>Application-utils-VERSION-ARHC.rpm 其它子包</li>
<li>Application-libs-VERSION-ARHC.rpm 其它子包</li>
</ul>
</div>
</div>
<div id="outline-container-h:88e272c8-31ce-49d9-9e6f-8f656f72e8e4" class="outline-4">
<h4 id="h:88e272c8-31ce-49d9-9e6f-8f656f72e8e4">包的依赖</h4>
<div class="outline-text-4" id="text-h:88e272c8-31ce-49d9-9e6f-8f656f72e8e4">
<p>
软件包之间可能存在依赖关系，甚至循环依赖，即：A包依赖B包，B包依赖C包，
C包依赖A包
</p>

<p>
安装软件包时，会因为缺少依赖的包，而导致安装包失败。
</p>

<p>
解决依赖包管理工具：
</p>

<ul class="org-ul">
<li>yum：rpm包管理器的前端工具</li>
<li>dnf：Fedora 18+ rpm包管理器前端管理工具，CentOS 8 版代替 yum</li>
<li>apt：deb包管理器前端工具</li>
<li>zypper：suse上的rpm前端管理工具</li>
</ul>
</div>
</div>
<div id="outline-container-h:08dae7f9-2a64-40ec-88ee-25e4e1abbd90" class="outline-4">
<h4 id="h:08dae7f9-2a64-40ec-88ee-25e4e1abbd90">程序包管理器相关文件</h4>
<div class="outline-text-4" id="text-h:08dae7f9-2a64-40ec-88ee-25e4e1abbd90">
<ol class="org-ol">
<li>包文件组成 (每个包独有)
<ul class="org-ul">
<li>包内的文件</li>
<li>元数据，如：包的名称，版本，依赖性，描述等</li>
<li>可能会有包安装或卸载时运行的脚本</li>
</ul></li>

<li>数据库(公共)：/var/lib/rpm
<ul class="org-ul">
<li>程序包名称及版本</li>
<li>依赖关系</li>
<li>功能说明</li>
<li>包安装后生成的各文件路径及校验码信息</li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-h:c31ee92c-a0b4-4955-b1f1-23b06ce5662a" class="outline-4">
<h4 id="h:c31ee92c-a0b4-4955-b1f1-23b06ce5662a">获取程序包的途径</h4>
<div class="outline-text-4" id="text-h:c31ee92c-a0b4-4955-b1f1-23b06ce5662a">
<p>
软件包需要事先将源码进行编译后打包形成，获取包的途径如下：
</p>
</div>
<div id="outline-container-h:e9916de8-6d62-4f17-8191-91295e0a8b6d" class="outline-5">
<h5 id="h:e9916de8-6d62-4f17-8191-91295e0a8b6d">系统发版的光盘或官方网站</h5>
<div class="outline-text-5" id="text-h:e9916de8-6d62-4f17-8191-91295e0a8b6d">
<p>
CentOS镜像：
</p>
<ul class="org-ul">
<li><a href="https://www.centos.org/download/">https://www.centos.org/download/</a></li>
<li><a href="http://mirrors.aliyun.com">http://mirrors.aliyun.com</a></li>
<li><a href="http://mirrors.sohu.com">http://mirrors.sohu.com</a></li>
<li><a href="http://mirrors.163.com">http://mirrors.163.com</a></li>
</ul>

<p>
Ubuntu 镜像：
</p>

<ul class="org-ul">
<li><a href="http://cdimage.ubuntu.com/releases/">http://cdimage.ubuntu.com/releases/</a></li>
<li><a href="http://releases.ubuntu.com">http://releases.ubuntu.com</a></li>
</ul>
</div>
</div>
<div id="outline-container-h:6eaae818-a901-4e66-9b8c-37d4cbe8deb5" class="outline-5">
<h5 id="h:6eaae818-a901-4e66-9b8c-37d4cbe8deb5">第三方组织提供</h5>
<div class="outline-text-5" id="text-h:6eaae818-a901-4e66-9b8c-37d4cbe8deb5">
<ul class="org-ul">
<li>Fedora-EPEL：Extra Packages for Enterprise Linux
<ul class="org-ul">
<li><a href="https://fedoraproject.org/wiki/EPEL">https://fedoraproject.org/wiki/EPEL</a></li>
<li><a href="https://mirrors.aliyun.com/epel/">https://mirrors.aliyun.com/epel/</a></li>
</ul></li>

<li><p>
SCL： Software Collections, 提供较高版本的第三方软件包
</p>

<p>
红帽公司创建的软件集合(SCL)项目站点 <a href="https://wiki.centos.org/SpecialInterestGroup(2f)SCLo.html">https://wiki.centos.org/SpecialInterestGroup(2f)SCLo.html</a>
</p></li>

<li>Community Enterprise Linux Repository：<a href="http://www.elrepo.org">http://www.elrepo.org</a>，支持 <code>最新的内核和硬件</code> 相关包</li>

<li>Rpmforge：官网：<a href="http://repoforge.org/">http://repoforge.org/</a>， RHEL推荐，包很全，即将关闭</li>
</ul>
</div>
</div>
<div id="outline-container-h:88846cc1-fb66-4d36-95dc-b6ac467f83dc" class="outline-5">
<h5 id="h:88846cc1-fb66-4d36-95dc-b6ac467f83dc">软件项目官方站点</h5>
<div class="outline-text-5" id="text-h:88846cc1-fb66-4d36-95dc-b6ac467f83dc">
<ul class="org-ul">
<li><a href="http://yum.mariadb.org/10.4/centos8-amd64/rpms/">http://yum.mariadb.org/10.4/centos8-amd64/rpms/</a></li>
<li><a href="http://repo.mysql.com/yum/mysql-8.0-community/el/8/x86_64/">http://repo.mysql.com/yum/mysql-8.0-community/el/8/x86_64/</a></li>
</ul>
</div>
</div>
<div id="outline-container-h:1f246c51-9b36-441e-af80-863893fbb1fc" class="outline-5">
<h5 id="h:1f246c51-9b36-441e-af80-863893fbb1fc">搜索引擎</h5>
<div class="outline-text-5" id="text-h:1f246c51-9b36-441e-af80-863893fbb1fc">
<ul class="org-ul">
<li><a href="http://pkgs.org">http://pkgs.org</a></li>
<li><a href="http://rpmfind.net">http://rpmfind.net</a></li>
<li><a href="http://rpm.pbone.net">http://rpm.pbone.net</a></li>
<li><a href="https://sourceforge.net/">https://sourceforge.net/</a></li>
</ul>

<p>
注意：第三方包建议要检查其合法性，来源合法性,程序包的完整性
</p>
</div>
</div>
<div id="outline-container-h:9f6c3bdd-50d7-4e0c-82a7-7bf3be6bb9ba" class="outline-5">
<h5 id="h:9f6c3bdd-50d7-4e0c-82a7-7bf3be6bb9ba">自己制作</h5>
<div class="outline-text-5" id="text-h:9f6c3bdd-50d7-4e0c-82a7-7bf3be6bb9ba">
<p>
将源码文件，利用工具，如：rpmbuild，fpm等工具制作成rpm包文件
</p>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:67ed83cd-a5d7-4cc4-ba8d-a431570b2139" class="outline-2">
<h2 id="h:67ed83cd-a5d7-4cc4-ba8d-a431570b2139">包管理器rpm</h2>
<div class="outline-text-2" id="text-h:67ed83cd-a5d7-4cc4-ba8d-a431570b2139">
<p>
CentOS系统上使用rpm命令管理程序包
</p>

<p>
功能： 安装、卸载、升级、查询、校验、数据库维护
</p>

<div class="org-src-container">
<pre class="src src-sh">rpm&#21517;: rpm [OPTIONS] [PACKAGE_FILE]
&#23433;&#35013; : -i&#65292;--install
&#21319;&#32423; : -U&#65292;--updat&#65292;-F&#65292;--freshen
&#21368;&#36733; : -e,--erase
&#26597;&#35810; : -q,--query
&#26657;&#39564; : -V,--verify
&#25968;&#25454;&#24211;&#32500;&#25252; : --builddb,--initdb

&#27880;&#24847;&#65306;&#23433;&#35013;&#38656;&#35201;&#36755;&#20837;PACKAGE_FILE&#65292;&#32780;&#26597;&#35810;&#26102;&#21482;&#38656;&#35201;package&#21517;&#23383;&#23601;&#34892;
</pre>
</div>

<p>
缺点：不能解决包的依赖问题，rpm命令常用在查询
</p>
</div>
<div id="outline-container-h:544cfc17-9ebc-43bb-802a-6b9d8a08ae54" class="outline-3">
<h3 id="h:544cfc17-9ebc-43bb-802a-6b9d8a08ae54">安装</h3>
<div class="outline-text-3" id="text-h:544cfc17-9ebc-43bb-802a-6b9d8a08ae54">
<p>
格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">rpm {-i|--install} [install-options] PACKAGE_FILE&#8230;

&#36873;&#39033;&#65306;
-v: verbose
-vv:
-h:      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;#&#26174;&#31034;&#31243;&#24207;&#21253;&#31649;&#29702;&#25191;&#34892;&#36827;&#24230;</span>

&#24120;&#29992;&#32452;&#21512;&#65306;
rpm -ivh PACKAGE_FILE ...
</pre>
</div>


<p>
rpm包安装[install-options]
</p>

<div class="org-src-container">
<pre class="src src-sh">--test: &#27979;&#35797;&#23433;&#35013;&#65292;&#20294;&#19981;&#30495;&#27491;&#25191;&#34892;&#23433;&#35013;&#65292;&#21363;dry run&#27169;&#24335;
--nodeps&#65306;&#24573;&#30053;&#20381;&#36182;&#20851;&#31995;
--replacepkgs | replacefiles &#37325;&#26032;&#23433;&#35013;&#65307;&#27880;&#24847;&#23427;&#19981;&#33021;&#26367;&#25442;&#37197;&#32622;&#25991;&#20214;&#65292;&#22914;&#26524;&#21253;&#37197;&#32622;&#25991;&#20214;&#34987;&#20462;&#25913;&#24314;&#35758;&#21024;&#25481;&#22312;&#20351;&#29992;&#35813;&#21442;&#25968;&#65307;

--nosignature: &#19981;&#26816;&#26597;&#26469;&#28304;&#21512;&#27861;&#24615;
--nodigest&#65306;&#19981;&#26816;&#26597;&#21253;&#23436;&#25972;&#24615;
--noscripts&#65306;&#19981;&#25191;&#34892;&#31243;&#24207;&#21253;&#33050;&#26412;
        %pre: &#23433;&#35013;&#21069;&#33050;&#26412; --nopre
        %post: &#23433;&#35013;&#21518;&#33050;&#26412; --nopost
        %preun: &#21368;&#36733;&#21069;&#33050;&#26412; --nopreun
        %postun: &#21368;&#36733;&#21518;&#33050;&#26412; --nopostun

&#20854;&#23427;
--justdb : &#26356;&#26032;&#25968;&#25454;&#24211;&#65292;&#23454;&#38469;&#27809;&#26377;&#23433;&#35013;
--root &#25351;&#23450;&#23433;&#35013;&#30340;&#26681;&#30446;&#24405;
</pre>
</div>

<p>
范例：指定根安装
</p>

<div class="org-src-container">
<pre class="src src-sh">rpm -ivh /mnt/cdrom/Packages/rpm-4.11-3-40.el7.x86_64.rpm --root=/mnt/sysimage/
</pre>
</div>
</div>
</div>
<div id="outline-container-h:82ea39a9-0903-4506-8c27-c5d61877a629" class="outline-3">
<h3 id="h:82ea39a9-0903-4506-8c27-c5d61877a629">升级和降级</h3>
<div class="outline-text-3" id="text-h:82ea39a9-0903-4506-8c27-c5d61877a629">
<p>
rpm包升级
</p>

<div class="org-src-container">
<pre class="src src-sh">rpm {-U|--upgrade} [install-options] PACKAGE_FILE...
rpm {-F|--freshen} [install-options] PACKAGE_FILE...
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">--upgrade&#65306;&#23433;&#35013;&#26377;&#26087;&#29256;&#31243;&#24207;&#21253;&#65292;&#21017;<span style="color: #8b2252;">"&#21319;&#32423;"</span>&#65292;&#22914;&#26524;&#19981;&#23384;&#22312;&#26087;&#29256;&#31243;&#24207;&#21253;&#65292;&#21017;<span style="color: #8b2252;">"&#23433;&#35013;"</span>
--freshen&#65306;&#23433;&#35013;&#26377;&#26087;&#29256;&#31243;&#24207;&#21253;&#65292;&#21017;<span style="color: #8b2252;">"&#21319;&#32423;"</span>&#65292; &#22914;&#26524;&#19981;&#23384;&#22312;&#26087;&#29256;&#31243;&#24207;&#21253;&#65292;&#21017;&#19981;&#25191;&#34892;&#21319;&#32423;&#25805;&#20316;

--oldpackage&#65306;&#38477;&#32423;
--force: &#24378;&#21046;&#23433;&#35013;
</pre>
</div>

<p>
常用组合
</p>

<div class="org-src-container">
<pre class="src src-sh">rpm -Uvh PACKAGE_FILE ...
rpm -Fvh PACKAGE_FILE ...
</pre>
</div>

<p>
升级注意项：
</p>
<ol class="org-ol">
<li>不要对内核做升级操作；Linux支持多内核版本并存，因此直接安装新版本内核</li>
<li>如果原程序包的配置文件安装后曾被修改，升级时，新版本提供的同一个配
置文件不会直接覆盖老版本的配置文件，而把新版本文件重命名
(FILENAME.rpmnew)后保留</li>
</ol>
</div>
</div>
<div id="outline-container-h:ce35e207-58c6-4949-a16c-c0a4afa6598b" class="outline-3">
<h3 id="h:ce35e207-58c6-4949-a16c-c0a4afa6598b">包查询</h3>
<div class="outline-text-3" id="text-h:ce35e207-58c6-4949-a16c-c0a4afa6598b">
<p>
数据库(公共)：/var/lib/rpm
</p>

<ul class="org-ul">
<li>程序包名称及版本</li>
<li>依赖关系</li>
<li>功能说明</li>
<li>包安装后生成的各文件路径及校验码信息</li>
</ul>

<p>
查询会从这数据库中查
</p>

<div class="org-src-container">
<pre class="src src-sh">rpm {-q|--query} [select-options] [query-options]
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">[select-options]
-a                                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#21253;</span>
-f                                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#30340;&#25991;&#20214;&#30001;&#21738;&#20010;&#31243;&#24207;&#21253;&#23433;&#35013;&#29983;&#25104;</span>
-p rpmfile                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38024;&#23545;&#23578;&#26410;&#23433;&#35013;&#30340;&#31243;&#24207;&#21253;&#25991;&#20214;&#20570;&#26597;&#35810;&#25805;&#20316;</span>
-g,--group GROUP  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#21253;&#32452;&#20013;&#21253;&#21547;&#20102;&#21738;&#20123;&#21253;</span>

[query-options]
--changelog  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;rpm&#21253;&#30340;changelog</span>
-c                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#31243;&#24207;&#30340;&#37197;&#32622;&#25991;&#20214;</span>
-d                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#31243;&#24207;&#30340;&#25991;&#26723;</span>
-i                   <span style="color: #b22222;">#</span><span style="color: #b22222;">information&#20449;&#24687;</span>
-l                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#30340;&#31243;&#24207;&#21253;&#23433;&#35013;&#21518;&#29983;&#25104;&#30340;&#25152;&#26377;&#25991;&#20214;</span>
--scripts      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31243;&#24207;&#21253;&#33258;&#24102;&#30340;&#33050;&#26412;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21644;CAPABILITY&#30456;&#20851;</span>
--whatprovides CAPABILITY     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#25351;&#23450;&#30340;CAPABILITY&#30001;&#21738;&#20010;&#21253;&#25152;&#25552;&#20379;</span>
--whatrequires CAPABILITY      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#25351;&#23450;&#30340;CAPABILITY&#34987;&#21738;&#20010;&#21253;&#25152;&#20381;&#36182;</span>
--provides                                    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25351;&#23450;&#31243;&#24207;&#21253;&#25152;&#25552;&#20379;&#30340;CAPABILITY</span>
-R                                                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#25351;&#23450;&#30340;&#31243;&#24207;&#21253;&#25152;&#20381;&#36182;&#30340;CAPABILITY</span>
</pre>
</div>

<p>
常用查询用法：
</p>

<div class="org-src-container">
<pre class="src src-sh">&#24050;&#23433;&#35013;&#21253;&#26597;&#35810;
-qa
-q PACKAGE
-qi PACKAGE
-qc PACKAGE
-ql PACKAGE
-qd PACKAGE
-q --scripts PACKAGE  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#21253;&#20013;&#33050;&#26412;</span>
-qf FILE                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#30340;&#25991;&#20214;&#30001;&#21738;&#20010;&#31243;&#24207;&#21253;&#23433;&#35013;&#29983;&#25104;</span>

&#26410;&#23433;&#35013;&#21253;&#26597;&#35810;
-qpi PACKAGE_FILE
-qpl PACKAGE_FILE, ...
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">PACKAGE_NAME : &#26597;&#35810;&#25351;&#23450;&#30340;&#31243;&#24207;&#21253;&#26159;&#21542;&#24050;&#32463;&#23433;&#35013;&#65292;&#21450;&#20854;&#29256;&#26412;&#65307;</span>
rpm -q zsh  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31934;&#30830;&#21517;&#25110;&#21069;&#32512;+TAB&#38190;&#34917;&#20840;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">-a,--all : &#26597;&#35810;&#25152;&#26377;&#24050;&#32463;&#23433;&#35013;&#36807;&#30340;&#21253;</span>
rpm -qa |grep ^zs
rpm -qa  zs* <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25903;&#25345;&#36890;&#37197;&#31526;</span>

rpm -ql wget  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#21253;&#20013;&#21253;&#21547;&#30340;&#25991;&#20214;</span>

rpm -q --scripts wget  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#21253;&#20013;&#33050;&#26412;&#20869;&#23481;</span>

rpm -qa --last|head <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26368;&#36817;&#23433;&#35013;&#30340;&#21253;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">-f FILE : &#26597;&#35810;&#25351;&#23450;&#30340;&#25991;&#20214;&#30001;&#21738;&#20010;&#31243;&#24207;&#21253;&#23433;&#35013;&#29983;&#25104;</span>
[root@node01 Packages]# rpm -qf /etc/fstab
setup-2.8.71-7.el7.noarch

<span style="color: #b22222;"># </span><span style="color: #b22222;">-i,--info : &#31243;&#24207;&#21253;&#30456;&#20851;&#30340;&#20449;&#24687;&#65292;&#29256;&#26412;&#21495;&#12289;&#22823;&#23567;&#12289;&#25152;&#23646;&#30340;&#32452;</span>
rpm -qi bash


<span style="color: #b22222;"># </span><span style="color: #b22222;">--provides : &#21015;&#20986;&#25351;&#23450;&#30340;&#31243;&#24207;&#21253;&#25552;&#20379;&#30340;&#25152;&#26377;&#30340;&#33021;&#21147;CAPABILITY</span>
[root@localhost ~]# rpm -q --provides  bash
/bin/bash
/bin/sh
bash = 4.2.46-12.el7
<span style="color: #0000ff;">bash</span>(x86-64) = 4.2.46-12.el7
<span style="color: #0000ff;">config</span>(bash) = 4.2.46-12.el7

<span style="color: #b22222;"># </span><span style="color: #b22222;">--whatprovides CAPABILITY : &#26597;&#35810;&#25351;&#23450;&#30340;&#33021;&#21147;CAPABILITY&#30001;&#21738;&#20010;&#31243;&#24207;&#21253;&#25552;&#20379;</span>
[root@localhost ~]# rpm -q --whatprovides  bash
bash-4.2.46-12.el7.x86_64
<span style="color: #b22222;"># </span><span style="color: #b22222;">--whatrequires CAPABILITY : &#26597;&#35810;&#25351;&#23450;&#30340;CAPABILITY&#34987;&#21738;&#20010;&#21253;&#25152;&#20381;&#36182;</span>
[root@localhost ~]# rpm -q --whatprovides  <span style="color: #8b2252;">'config(bash)'</span>
bash-4.2.46-12.el7.x86_64

<span style="color: #b22222;"># </span><span style="color: #b22222;">--scripts : &#26597;&#30475;&#31243;&#24207;&#21253;&#33258;&#24102;&#30340;&#33050;&#26412;&#29255;&#26029;&#26377;&#21738;&#20123;</span>
[root@jenkins01 soft]# rpm -qp --scripts tomcat-app-8.0.36-20160817.el7.centos.x86_64.rpm
postinstall scriptlet (using /bin/sh):
<span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">1</span> == 1 ]; <span style="color: #a020f0;">then</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2e24402e-9d33-404d-95da-ae3ca93125b4" class="outline-3">
<h3 id="h:2e24402e-9d33-404d-95da-ae3ca93125b4">包卸载</h3>
<div class="outline-text-3" id="text-h:2e24402e-9d33-404d-95da-ae3ca93125b4">
<p>
格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">rpm {-e|--erase} [--allmatches] [--nodeps] [--noscripts] [--notriggers] [--test] PACKAGE_NAME ...
</pre>
</div>

<p>
注意：当包卸载时，对应的配置文件不会删除， 以FILENAME.rpmsave形式保留
</p>

<div class="org-src-container">
<pre class="src src-sh">--allmatches&#65306;&#21368;&#36733;&#25152;&#26377;&#21305;&#37197;&#30340;&#25351;&#23450;&#21517;&#31216;&#30340;&#31243;&#24207;&#21253;&#30340;&#21508;&#29256;&#26412;&#65307;
--nodep&#65306;&#24573;&#30053;&#20381;&#36182;&#20851;&#31995;
--noscripts&#65306;&#19981;&#25191;&#34892;&#33050;&#26412;
 %pre: &#23433;&#35013;&#21069;&#33050;&#26412; --nopre
 %post: &#23433;&#35013;&#21518;&#33050;&#26412; --nopost
 %preun: &#21368;&#36733;&#21069;&#33050;&#26412; --nopreun
 %postun: &#21368;&#36733;&#21518;&#33050;&#26412; --nopostun

--test&#65306;&#27979;&#35797;&#21368;&#36733;&#65292;dry run&#27169;&#24335;&#65307;
</pre>
</div>

<p>
范例：强行删除rpm包，并恢复
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#rpm -e rpm --nodeps

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;&#36827;&#20837;rescue&#27169;&#24335;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">mkdir /mnt/cdrom</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">mount /dev/sr0 /mnt/cdrom</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">rpm -ivh /mnt/cdrom/Packages/rpm-4.11.3-40.el7.x86_64.rpm --root=/mnt/sysimage</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">reboot</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:52014c9c-cf3c-43cf-bedd-6a0d097ce478" class="outline-3">
<h3 id="h:52014c9c-cf3c-43cf-bedd-6a0d097ce478">包校验</h3>
<div class="outline-text-3" id="text-h:52014c9c-cf3c-43cf-bedd-6a0d097ce478">
<p>
在安装包时，系统也会检查包的来源是否是合法的
</p>

<p>
检查包的完整性和签名
</p>

<div class="org-src-container">
<pre class="src src-sh">rpm -K|--checksig rpmfile 
</pre>
</div>

<p>
在检查包的来源和完整性前，必须导入所需要公钥
</p>

<p>
范例：centos7 导入密钥
</p>

<div class="org-src-container">
<pre class="src src-sh">rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23548;&#20837;&#23494;&#38053;</span>
rpm -qa <span style="color: #8b2252;">"gpg-pubkey*"</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#26597;&#23433;&#35013;&#22909;&#30340;&#23494;&#38053;</span>
</pre>
</div>

<p>
范例：CentOS 8
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -K /misc/cd/AppStream/Packages/httpd-2.4.37-16.module_el8.1.0+256+ae790463.x86_64.rpm
/misc/cd/AppStream/Packages/httpd-2.4.37-16.module_el8.1.0+256+ae790463.x86_64.rpm: digests SIGNATURES NOT OK
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#38656;&#35201;&#20107;&#20808;&#30693;&#36947;&#31614;&#21517;&#65292;&#25152;&#20197;&#19978;&#38754;&#25253;&#38169;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29992;&#20110;&#26816;&#26597;&#31614;&#21517;&#30340;&#25991;&#20214;</span>
[root@centos8 ~]#cat /etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v2.0.22 (GNU/Linux)
mQINBFzMWxkBEADHrskpBgN9OphmhRkc7P/YrsAGSvvl7kfu+e9KAaU6f5MeAVyn
.. ...

[root@centos8 ~]#rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23548;&#20837;&#31614;&#21517;</span>
[root@centos8 rpm-gpg]#rpm -K /misc/cd/AppStream/Packages/httpd-2.4.37-
16.module_el8.1.0+256+ae790463.x86_64.rpm
/misc/cd/AppStream/Packages/httpd-2.4.37-
16.module_el8.1.0+256+ae790463.x86_64.rpm: digests signatures OK

[root@centos8 ~]#rpm -qa <span style="color: #8b2252;">"gpg-pubkey*"</span>
gpg-pubkey-8483c65d-5ccc5b19
[root@centos8 ~]#rpm -qi gpg-pubkey-8483c65d-5ccc5b19
<span style="color: #483d8b;">.</span>
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: rpm-4.14.2 (NSS-3)
mQINBFzMWxkBEADHrskpBgN9OphmhRkc7P/YrsAGSvvl7kfu+e9KAaU6f5MeAVyn
... ...
</pre>
</div>

<p>
范例：校验包文件
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -K /misc/cd/BaseOS/Packages/tree-1.7.0-15.el8.x86_64.rpm
/misc/cd/BaseOS/Packages/tree-1.7.0-15.el8.x86_64.rpm: digests signatures OK
[root@centos8 ~]#cp /misc/cd/BaseOS/Packages/tree-1.7.0-15.el8.x86_64.rpm /data
[root@centos8 ~]#cd /data
[root@centos8 data]#ll
total 60
-r--r--r-- 1 root root 60780 Apr  8 10:11 tree-1.7.0-15.el8.x86_64.rpm
[root@centos8 data]#echo &gt;&gt;tree-1.7.0-15.el8.x86_64.rpm
[root@centos8 data]#ll tree-1.7.0-15.el8.x86_64.rpm
-r--r--r-- 1 root root 60781 Apr  8 10:11 tree-1.7.0-15.el8.x86_64.rpm
[root@centos8 data]#cd
[root@centos8 ~]#rpm -K /data/tree-1.7.0-15.el8.x86_64.rpm
/data/tree-1.7.0-15.el8.x86_64.rpm: DIGESTS SIGNATURES NOT OK
</pre>
</div>

<p>
软件在安装时，会将包里的每个文件的元数据，如：大小，权限，所有者，时间
等记录至rpm相关的数据库中，可以用来检查包中的文件是否和当初安装时有所
变化
</p>

<div class="org-src-container">
<pre class="src src-sh">rpm {-V|--verify} [select-options] [verify-options]
</pre>
</div>

<p>
范例：查看包从安装后是否更改过
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -V centos-release
S.5....T. c /etc/issue

S file Size differs
M Mode differs (includes permissions and file type)
5 digest (formerly MD5 sum) differs
D Device major/minor number mismatch
L readLink(2) path mismatch
U User ownership differs
G Group ownership differs
T mTime differs
P capabilities differ
<span style="color: #483d8b;">.</span> (&#28857;) &#34920;&#31034;&#24403;&#21069;&#20301;&#32622;&#20195;&#34920;&#30340;&#23383;&#31526;&#21547;&#20041;&#19968;&#33268;

c &#25152;&#22312;&#30340;&#20301;&#32622;&#34920;&#31034;&#25991;&#20214;&#31867;&#22411;
c &#37197;&#32622;&#25991;&#20214;
d &#25991;&#20214;&#25968;&#25454;&#25991;&#20214;
g &#35813;&#25991;&#20214;&#19981;&#23646;&#20110;&#26576;&#20010;&#25991;&#20214;(&#26497;&#23569;&#24773;&#20917;)
l &#35768;&#21487;&#35777;&#25991;&#20214;(license file)
r &#33258;&#36848;&#25991;&#20214;(READ ME)

&#21487;&#20197;&#30475;&#21040;&#65292;&#32467;&#26524;&#26174;&#31034;&#20102;&#25991;&#20214;&#34987;&#20462;&#25913;&#30340;&#20449;&#24687;&#12290;&#35813;&#20449;&#24687;&#21487;&#20998;&#20026;&#20197;&#19979; 3 &#37096;&#20998;&#65306;
1 &#26368;&#21069;&#38754;&#30340; 8 &#20010;&#23383;&#31526;&#65288;S.5....T&#65289;&#37117;&#23646;&#20110;&#39564;&#35777;&#20449;&#24687;&#65292;&#21508;&#23383;&#31526;&#30340;&#20855;&#20307;&#21547;&#20041;&#22914;&#19979;&#65306;
S&#65306;&#25991;&#20214;&#22823;&#23567;&#26159;&#21542;&#25913;&#21464;&#12290;
M&#65306;&#25991;&#20214;&#30340;&#31867;&#22411;&#25110;&#25991;&#20214;&#30340;&#26435;&#38480;&#65288;rwx&#65289;&#26159;&#21542;&#25913;&#21464;&#12290;
5&#65306;&#25991;&#20214;MD5&#26657;&#39564;&#21644;&#26159;&#21542;&#25913;&#21464;&#65288;&#21487;&#20197;&#30475;&#25104;&#25991;&#20214;&#20869;&#23481;&#26159;&#21542;&#25913;&#21464;&#65289;&#12290;
D&#65306;&#35774;&#22791;&#30340;&#20027;&#20174;&#20195;&#30721;&#26159;&#21542;&#25913;&#21464;&#12290;
L&#65306;&#25991;&#20214;&#36335;&#24452;&#26159;&#21542;&#25913;&#21464;&#12290;
U&#65306;&#25991;&#20214;&#30340;&#23646;&#20027;&#65288;&#25152;&#26377;&#32773;&#65289;&#26159;&#21542;&#25913;&#21464;&#12290;
G&#65306;&#25991;&#20214;&#30340;&#23646;&#32452;&#26159;&#21542;&#25913;&#21464;&#12290;
T&#65306;&#25991;&#20214;&#30340;&#20462;&#25913;&#26102;&#38388;&#26159;&#21542;&#25913;&#21464;&#12290;
<span style="color: #483d8b;">.</span>&#65306;&#33509;&#30456;&#20851;&#39033;&#27809;&#21457;&#29983;&#25913;&#21464;&#65292;&#29992; . &#34920;&#31034;&#12290;

2 &#34987;&#20462;&#25913;&#25991;&#20214;&#31867;&#22411;&#65292;&#22823;&#33268;&#21487;&#20998;&#20026;&#20197;&#19979;&#20960;&#31867;&#65306;
c&#65306;&#37197;&#32622;&#25991;&#20214;&#65288;configuration file&#65289;&#12290;
d&#65306;&#26222;&#36890;&#25991;&#26723;&#65288;documentation&#65289;&#12290;
g&#65306;<span style="color: #8b2252;">"&#39740;"</span>&#25991;&#20214;&#65288;ghost file&#65289;&#65292;&#24456;&#23569;&#35265;&#65292;&#23601;&#26159;&#35813;&#25991;&#20214;&#19981;&#24212;&#35813;&#34987;&#36825;&#20010; RPM &#21253;&#21253;&#21547;&#12290;
l&#65306;&#25480;&#26435;&#25991;&#20214;&#65288;license file&#65289;&#12290;
r&#65306;&#25551;&#36848;&#25991;&#20214;&#65288;read me&#65289;&#12290;

3 &#34987;&#20462;&#25913;&#25991;&#20214;&#25152;&#22312;&#32477;&#23545;&#36335;&#24452;&#65288;&#21253;&#21547;&#25991;&#20214;&#21517;&#65289;&#12290;

<span style="color: #b22222;">#</span>
S.5....T. c /etc/httpd/conf/httpd.conf &#34920;&#36798;&#30340;&#23436;&#25972;&#21547;&#20041;&#26159;&#65306;&#37197;&#32622;&#25991;&#20214; httpd.conf &#30340;&#22823;&#23567;&#12289;&#20869;&#23481;&#12289;&#20462;&#25913;&#26102;&#38388;&#34987;&#20154;&#20026;&#20462;&#25913;&#36807;&#12290;
</pre>
</div>

<p>
范例：检查包是否被篡改过
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -qf /etc/issue
centos-release-8.1-1.1911.0.8.el8.x86_64
[root@centos8 ~]#vim /var/lib/rpm^C/etc/issue
[root@centos8 ~]#vim /etc/issue
welcome to u                               

\S
Kernel \r on an \m
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#25972;&#20010;&#21253;&#26159;&#21542;&#21253;&#25913;&#36807;</span>
[root@centos8 ~]#rpm -V centos-release
S.5....T. c /etc/issue
[root@centos8 ~]#vim /etc/issue
[root@centos8 ~]#cat /etc/issue
\S
Kernel \r on an \m
[root@centos8 ~]#

[root@centos8 ~]#rpm -V centos-release
.......T. c /etc/issue

[root@centos8 ~]#rpm -ql centos-release
/etc/centos-release
/etc/centos-release-upstream
/etc/issue
/etc/issue.net
/etc/os-release
/etc/redhat-release
/etc/rpm/macros.dist
/etc/system-release
/etc/system-release-cpe
/usr/lib/systemd/system-preset/85-display-manager.preset
/usr/lib/systemd/system-preset/90-default.preset
/usr/lib/systemd/system-preset/99-default-disable.preset
/usr/share/centos-release/EULA
/usr/share/doc/centos-release/Contributors
/usr/share/doc/centos-release/GPL
/usr/share/doc/redhat-release
/usr/share/redhat-release

[root@centos8 ~]#rpm -Va  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#26597;&#30340;&#21253;&#26377;&#27809;&#26377;&#25913;&#21464;</span>
.M....... g /run/dbus
.......T.  /usr/bin/tree
.M....... c /etc/machine-id
missing  c /etc/systemd/system/dbus-org.freedesktop.resolve1.service
.M....... g /var/cache/private
.M....... g /var/lib/private
.M....... g /var/log/btmp
.M....... g /var/log/private
S.5....T. c /etc/issue
.M....G.. g /var/log/lastlog
.M....... d /usr/share/info/dir.old
.M....... g /var/cache/dnf/packages.db
.M....... g /var/lib/plymouth/boot-duration
.......T. c /etc/kdump.conf
S.5....T. c /etc/ssh/sshd_config
.M....... c /etc/rc.d/rc.local
S.5....T. c /root/.bashrc
.M....... g /etc/crypto-policies/back-ends/nss.config
.M....... g /etc/udev/hwdb.bin
.M....... g /var/lib/systemd/random-seed
missing  c /etc/yum.repos.d/CentOS-AppStream.repo
missing  c /etc/yum.repos.d/CentOS-Base.repo
missing  c /etc/yum.repos.d/CentOS-CR.repo
missing  c /etc/yum.repos.d/CentOS-Debuginfo.repo
missing  c /etc/yum.repos.d/CentOS-Extras.repo
missing  c /etc/yum.repos.d/CentOS-HA.repo
missing  c /etc/yum.repos.d/CentOS-Media.repo
missing  c /etc/yum.repos.d/CentOS-PowerTools.repo
missing  c /etc/yum.repos.d/CentOS-Sources.repo
missing  c /etc/yum.repos.d/CentOS-Vault.repo
missing  c /etc/yum.repos.d/CentOS-centosplus.repo
missing  c /etc/yum.repos.d/CentOS-fasttrack.repo
.M.......  /var/log/audit


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#36719;&#20214;&#21253;&#20013;&#30340;&#21333;&#20010;&#25991;&#20214;&#65292;&#22914;&#26524;&#25991;&#20214;&#27809;&#26377;&#34987;&#20462;&#25913;&#36807;&#65292;&#21017;&#19981;&#36755;&#20986;&#20219;&#20309;&#20449;&#24687;</span>
rpm -Vf /etc/crontab

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#25972;&#20010;&#36719;&#20214;&#21253;&#26159;&#21542;&#34987;&#20462;&#25913;&#36807;</span>
rpm -Vp AdobeReader_chs-7.0.9-1.i386.rpm 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5c158fee-1dc8-41e6-a4de-de581a78f60b" class="outline-3">
<h3 id="h:5c158fee-1dc8-41e6-a4de-de581a78f60b">数据库</h3>
<div class="outline-text-3" id="text-h:5c158fee-1dc8-41e6-a4de-de581a78f60b">
<p>
rpm包安装时生成的信息，都放在rpm数据库中
</p>

<div class="org-src-container">
<pre class="src src-sh">/var/lib/rpm
</pre>
</div>

<p>
可以重建数据库
</p>

<div class="org-src-container">
<pre class="src src-sh">rpm {--initdb|--rebuilddb}
initdb: &#21021;&#22987;&#21270;&#65292;&#22914;&#26524;&#20107;&#20808;&#19981;&#23384;&#22312;&#25968;&#25454;&#24211;&#65292;&#21017;&#26032;&#24314;&#20043;&#65292;&#21542;&#21017;&#65292;&#19981;&#25191;&#34892;&#20219;&#20309;&#25805;&#20316;
rebuilddb&#65306;&#37325;&#24314;&#24050;&#23433;&#35013;&#30340;&#21253;&#22836;&#30340;&#25968;&#25454;&#24211;&#32034;&#24341;&#30446;&#24405;
</pre>
</div>

<p>
<b>报错-解决yum install时出现Thread died in Berkeley DB library的错误</b>
</p>


<div class="org-src-container">
<pre class="src src-sh">$ yum install wireshark wireshark-gnome
error: rpmdb: BDB0113 Thread/process 3336/140141695063872 failed: BDB1507 Thread died<span style="color: #a020f0;"> in</span> Berkeley DB library
error: db5 error(-30973) from dbenv-&gt;failchk: BDB0087 DB_RUNRECOVERY: Fatal error, run database recovery
error: cannot open Packages index using db5 -  (-30973)
error: cannot open Packages database<span style="color: #a020f0;"> in</span> /var/lib/rpm
CRITICAL:yum.main:

Error: rpmdb open failed
</pre>
</div>

<p>
原因： 提示rpm相关的数据库损坏了
</p>

<p>
解决：
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir /var/lib/rpm/backup
cp -a /var/lib/rpm/__db* /var/lib/rpm/backup/
rm -f /var/lib/rpm/__db.[0-9][0-9]*
rpm --quiet -qa
rpm --rebuilddb
yum clean all
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:328e7c58-986e-4291-ad14-c020117983a8" class="outline-2">
<h2 id="h:328e7c58-986e-4291-ad14-c020117983a8">yum和dnf</h2>
<div class="outline-text-2" id="text-h:328e7c58-986e-4291-ad14-c020117983a8">
<p>
CentOS 使用 yum, dnf 解决rpm的包依赖关系
</p>

<p>
YUM: Yellowdog Update Modifier，rpm的前端程序，可解决软件包相关依赖性，
可在多个库之间定位软件包，up2date的替代工具，CentOS 8 用dnf 代替了yum
,不过保留了和yum的兼容性，配置也是通用的
</p>
</div>
<div id="outline-container-h:41183e23-91dd-4eda-9734-10455d42a144" class="outline-3">
<h3 id="h:41183e23-91dd-4eda-9734-10455d42a144">yum/dnf 工作原理</h3>
<div class="outline-text-3" id="text-h:41183e23-91dd-4eda-9734-10455d42a144">
<p>
yum/dnf 是基于C/S 模式
</p>
<ul class="org-ul">
<li>yum 服务器存放rpm包和相关包的元数据库</li>
<li>yum 客户端访问yum服务器进行安装或查询等</li>
</ul>


<figure id="orgfb4dfd7">
<img src="images/image-20210216014442131.png" alt="image-20210216014442131.png" width="60%">

</figure>

<p>
yum 实现过程
</p>

<p>
先在yum服务器上创建 yum repository（仓库），在仓库中事先存储了众多rpm
包，以及包的相关的元数据文件（放置于特定目录repodata下），当yum客户端
利用yum/dnf工具进行安装时包时，会自动下载repodata中的元数据，查询远数
据是否存在相关的包及依赖关系，自动从仓库中找到相关包下载并安装。
</p>

<p>
yum获取rpm包过程：
</p>

<ol class="org-ol">
<li>客户端远程连接到提供资源的服务端求情数据</li>
<li>服务端将保持有包的相关元数据信息文件发送给客户端，不过在这之前有一
次发送校验码的过程(repodata目录下repomd.xml文件)；通常元数据文件放
在特定的目录下，而每个元数据文件都有与之对应的校验码以方便查询其完
整性；</li>
<li>客户端将元数据文件放置于本地缓存区域中，并根据元数据文件分析是否有
所需的rpm包名及依赖关系等；</li>
<li>客户端检查本地是否有rpm包相关依赖关系的文件</li>
<li>客户端远程连接至服务端下载所需rpm包，并缓存到本地执行安装；</li>
<li>客户端默认会删除下载的rpm包，但元数据文件不会删除；</li>
</ol>
</div>
</div>
<div id="outline-container-h:11f69a5b-babf-4133-b4eb-7b4b6f01878b" class="outline-3">
<h3 id="h:11f69a5b-babf-4133-b4eb-7b4b6f01878b">yum客户端配置</h3>
<div class="outline-text-3" id="text-h:11f69a5b-babf-4133-b4eb-7b4b6f01878b">
<p>
yum客户端配置文件
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/yum.conf                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#25152;&#26377;&#20179;&#24211;&#25552;&#20379;&#20844;&#20849;&#37197;&#32622;</span>
/etc/yum.repos.d/*.repo      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#27599;&#20010;&#20179;&#24211;&#30340;&#25552;&#20379;&#37197;&#32622;&#25991;&#20214;</span>
</pre>
</div>

<p>
帮助参考： man 5 yum.conf
</p>
</div>
<div id="outline-container-h:443242a3-12c4-42aa-9396-05141e1888f1" class="outline-4">
<h4 id="h:443242a3-12c4-42aa-9396-05141e1888f1">/etc/yum.conf主配置定义</h4>
<div class="outline-text-4" id="text-h:443242a3-12c4-42aa-9396-05141e1888f1">
<p>
范例：CentOS 8 配置文件
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]# ll /etc/yum.conf
lrwxrwxrwx. 1 root root 12 May 14  2019 /etc/yum.conf -&gt; dnf/dnf.conf

[root@centos8 ~]#cat /etc/yum.conf
[main]
<span style="color: #a0522d;">gpgcheck</span>=1   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#21253;&#21069;&#35201;&#20570;&#21253;&#30340;&#21512;&#27861;&#21644;&#23436;&#25972;&#24615;&#26657;&#39564;</span>
<span style="color: #a0522d;">installonly_limit</span>=3 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#26102;&#21487;&#20197;&#23433;&#35013;3&#20010;&#21253;&#65292;&#26368;&#23567;&#20540;&#20026;2&#65292;&#22914;&#35774;&#20026;0&#25110;1&#65292;&#20026;&#19981;&#38480;&#21046;</span>
<span style="color: #a0522d;">clean_requirements_on_remove</span>=True  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#21253;&#26102;&#65292;&#26159;&#21542;&#23558;&#19981;&#20877;&#20351;&#29992;&#30340;&#21253;&#21024;&#38500;</span>
<span style="color: #a0522d;">best</span>=True <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21319;&#32423;&#26102;&#65292;&#33258;&#21160;&#36873;&#25321;&#23433;&#35013;&#26368;&#26032;&#29256;&#65292;&#21363;&#20351;&#32570;&#23569;&#21253;&#30340;&#20381;&#36182;</span>
</pre>
</div>

<p>
范例：CentOS 7的配置文件
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]# ll /etc/yum.conf
-rw-r--r--. 1 root root 970 Aug  8 19:57 /etc/yum.conf

[root@centos7 ~]# cat /etc/yum.conf
[main]
<span style="color: #a0522d;">cachedir</span>=/var/cache/yum/$<span style="color: #a0522d;">basearch</span>/$<span style="color: #a0522d;">releasever</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32531;&#23384;&#25991;&#20214;&#36335;&#24452;</span>
<span style="color: #a0522d;">keepcache</span>=0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26412;&#22320;&#32531;&#23384;&#26159;&#21542;&#20445;&#23384;(rpm&#21253;)</span>
<span style="color: #a0522d;">debuglevel</span>=2 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35843;&#35797;&#32423;&#21035;</span>
<span style="color: #a0522d;">logfile</span>=/var/log/yum.log   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;&#30340;&#26085;&#24535;&#25991;&#20214;</span>
<span style="color: #a0522d;">exactarch</span>=1                     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#21542;&#31934;&#30830;&#24179;&#21488;release&#21305;&#37197;</span>
<span style="color: #a0522d;">obsoletes</span>=1   
<span style="color: #a0522d;">gpgcheck</span>=1                     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#21542;&#26816;&#26597;&#26469;&#28304;&#21512;&#27861;&#24615;&#21644;&#23436;&#25972;&#24615;</span>
<span style="color: #a0522d;">plugins</span>=1                         <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#21542;&#25903;&#25345;&#25554;&#20214;&#26426;&#21046;</span>
<span style="color: #a0522d;">installonly_limit</span>=5              <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21516;&#26102;&#23433;&#35013;&#20960;&#20010;&#31243;&#24207;&#21253;</span>
<span style="color: #a0522d;">bugtracker_url</span>=http://bugs.centos.org/set_project.php? <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36861;&#36394;bug&#36335;&#24452;</span>
<span style="color: #a0522d;">project_id</span>=23&amp;<span style="color: #a0522d;">ref</span>=http://bugs.centos.org/bug_report_page.php?<span style="color: #a0522d;">category</span>=yum
<span style="color: #a0522d;">distroverpkg</span>=centos-release <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24403;&#21069;&#21457;&#34892;&#29256;&#29256;&#26412;&#21495;&#20174;&#21738;&#20799;&#33719;&#21462;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:352c0b6b-420b-46fa-a986-0414b2618646" class="outline-4">
<h4 id="h:352c0b6b-420b-46fa-a986-0414b2618646">仓库(*.repo)配置文件定义：</h4>
<div class="outline-text-4" id="text-h:352c0b6b-420b-46fa-a986-0414b2618646">
<p>
repo仓库配置文件指向的定义：
</p>

<div class="org-src-container">
<pre class="src src-sh">[repositoryID]  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20179;&#24211;ID&#65292;&#21807;&#19968;&#26631;&#35782;&#21035;&#65292;&#19981;&#33021;&#37325;&#22797;</span>
<span style="color: #a0522d;">name</span>=Some name for this repository  <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#23436;&#25972;&#30340;&#20179;&#24211;&#21517;&#31216;&#65292;&#27880;&#24847; = &#31561;&#21495;&#24038;&#21491;&#19981;&#35201;&#26377;&#31354;&#26684;&#65292;&#21542;&#21017;&#21487;&#33021;&#20250;&#20986;&#29616;&#35821;&#27861;&#38169;&#35823;</span>
<span style="color: #a0522d;">baseurl</span>=url://path/to/repository/    <span style="color: #b22222;"># </span><span style="color: #b22222;">yum&#20179;&#24211;&#25351;&#26126;&#30340;&#35775;&#38382;&#36335;&#24452;&#65292;&#22810;&#20010;url&#25442;&#34892;&#20889;&#12290;repodata &#25152;&#22312;&#30340;&#36335;&#24452;&#23601;&#26159; yum &#28304;&#25351;&#21521;&#30340;&#36335;&#24452;.</span>
<span style="color: #a0522d;">enabled</span>={1|0} <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#21542;&#21551;&#29992;&#27492;&#20179;&#24211;&#65292;&#40664;&#35748;1&#21551;&#21160;</span>

&#20854;&#23427;&#36873;&#39033;&#65306;
<span style="color: #a0522d;">keepcache</span>={1|0}   : &#26412;&#22320;&#32531;&#23384;&#26159;&#21542;&#20445;&#23384;(rpm&#21253;)
<span style="color: #a0522d;">enabled</span>={1|0} : &#26159;&#21542;&#21551;&#29992;&#27492;&#20179;&#24211;&#65292;&#40664;&#35748;&#21551;&#21160;
<span style="color: #a0522d;">gpgcheck</span>={1|0}  : &#26159;&#21542;&#26816;&#26597;&#26469;&#28304;&#21512;&#27861;&#24615;&#21644;&#23436;&#25972;&#24615;, &#40664;&#35748;1&#26816;&#26597;
<span style="color: #a0522d;">repo_gpgcheck</span>={1|0}  : &#26816;&#26597;&#20803;&#25968;&#25454;&#23436;&#25972;&#24615;
<span style="color: #a0522d;">gpgkey</span>=URL : &#31192;&#38053;&#25991;&#20214;&#20301;&#32622;&#65292;&#21487;&#33021;&#26159;&#23545;&#26041;&#20179;&#24211;&#25552;&#20379;
<span style="color: #a0522d;">enablegroups</span>={1|0}  : &#26159;&#21542;&#25903;&#25345;&#32452;&#25209;&#37327;&#31649;&#29702;&#31243;&#24207;&#21253;&#65292;&#40664;&#35748;&#25903;&#25345;
<span style="color: #a0522d;">failovermethod</span>={roundrobin|priority} : &#25351;&#26126;baseurl&#26377;&#22810;&#20010;&#26102;&#30340;&#20248;&#20808;&#32423;&#65307;
    roundrobin&#65306;&#24847;&#20026;&#38543;&#26426;&#25361;&#36873;&#65292;&#40664;&#35748;&#20540;
    priority:&#25353;&#39034;&#24207;&#35775;&#38382;&#65292;&#19978;&#32780;&#19979;&#35831;&#27714;
<span style="color: #a0522d;">cost</span>=   : &#24320;&#38144;&#65307;&#40664;&#35748;&#20026;1000&#65307;&#22810;&#20010;&#20179;&#24211;&#37324;&#37117;&#26377;&#21516;&#19968;&#20010;rpm&#21253;&#21487;&#23450;&#20041;&#24320;&#38144;&#65292;&#36234;&#23567;&#36234;&#20808;&#35775;&#38382;&#65307;

mirrorlist   :  &#20197;&#38236;&#20687;&#26041;&#24335;&#25351;&#23450; baseurl&#12290; &#19968;&#20010; baseurl &#22312;&#25351;&#23450;&#22810;&#20010; url &#26102;&#31649;&#29702;&#36215;&#26469;&#19981;&#26041;&#20415;&#65292;&#22312;&#20114;&#32852;&#32593;&#20013;&#25214;&#19968;&#21488;&#26381;&#21153;&#22120;&#65292;&#22312;&#26381;&#21153;&#22120;&#19978;&#30340;&#36890;&#36807;&#25991;&#20214;&#26381;&#21153;&#30340;&#20849;&#20139;&#20301;&#32622;&#21019;&#24314;&#19968;&#20010;&#25991;&#26412;&#25991;&#20214;&#65292;&#22312;&#25991;&#26412;&#25991;&#20214;&#20013;&#21015;&#34920;&#20986; baseurl &#30340;&#35775;&#38382;&#36335;&#24452;&#65292;mirrorlist&#25351;&#21521;&#36825;&#20010;&#25991;&#26412;&#25991;&#20214;&#12290;&#20351;&#29992;mirrorlist &#35201;&#27714; yum &#26377;&#25554;&#20214;&#21151;&#33021;
bandwidth : &#24102;&#23485;&#38480;&#21046;

username : &#29992;&#25143;&#21517;
password : &#26377;&#20123;&#26381;&#21153;&#22120;&#35775;&#38382;&#26102;&#38656;&#35201;&#29992;&#25143;&#26469;&#23494;&#30721;
<span style="color: #a0522d;">keepalive</span>=&#65371;1|0&#65373;: &#26159;&#21542;&#20351;&#29992;&#20445;&#25345;&#36830;&#25509;

&#35828;&#26126;&#65306;
1) *.repo&#21487;&#20197;&#23558;&#22810;&#20010;[repositoryID]&#30340;&#37197;&#32622;&#20449;&#24687;&#25918;&#22312;&#19968;&#20010;&#32780;&#25991;&#20214;&#20869;&#65292;&#20063;&#21487;&#20197;&#20999;&#25104;&#22810;&#20010;&#26041;&#20415;&#31649;&#29702;
2) baseurl&#21487;&#20197;&#20351;&#29992;&#65306;ftp://&#12289;http://&#12289;nfs://&#12289;file:///  &#25351;&#26126;URL&#36335;&#24452;
3)baseurl&#31561;&#21495;&#20004;&#36793;&#19981;&#33021;&#26377;&#31354;&#26684;&#65292;&#20854;&#21518;&#21487;&#20197;&#22635;&#20889;&#22810;&#20010;&#38236;&#20687;&#35775;&#38382;&#36335;&#24452;&#65292;&#27599;&#34892;&#19968;&#20010;&#65292;&#19981;&#33021;&#39030;&#34892;&#20889;
&#22810;&#20010;&#35775;&#38382;&#36335;&#24452;&#38388;&#32852;&#31995;&#26159;&#38236;&#20687;&#30456;&#21516;&#65292;&#30446;&#30340;&#26159;&#20026;&#20102;&#20570;&#22791;&#29992;&#35775;&#38382;
4)&#26356;&#22810;&#36873;&#39033;&#20351;&#29992;man  5  yum.conf&#26597;&#30475;&#65292;&#22522;&#26412;&#37197;&#32622;&#21482;&#38656;&#21069;&#19977;&#34892;&#23601;&#21487;&#20197;        
5)&#21457;&#34892;&#29256;&#20809;&#30424;&#38236;&#20687;&#23433;&#35013;&#21487;&#33021;&#20250;&#33258;&#21160;&#37197;&#32622;&#32593;&#32476;&#38236;&#20687;URL&#22320;&#22336;
</pre>
</div>

<p>
yum服务器的baseurl形式
</p>
<pre class="example" id="org16f2b29">
file:// 本地路径
http://
https://
ftp:// 
</pre>

<p>
<b>注意：yum仓库指向的路径一定必须是repodata目录所在目录</b>
</p>

<p>
<b>相关变量</b>
</p>
<div class="org-src-container">
<pre class="src src-sh">yum&#30340;repo&#37197;&#32622;&#25991;&#20214;&#20013;&#21487;&#29992;&#30340;&#21464;&#37327;&#65306;
$<span style="color: #a0522d;">releasever</span>         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;OS&#30340;&#21457;&#34892;&#29256;&#30340;&#20027;&#29256;&#26412;&#21495;&#65292;&#22914;&#65306;8&#65292;7&#65292;6</span>
$<span style="color: #a0522d;">arch</span>                   <span style="color: #b22222;">#</span><span style="color: #b22222;">CPU&#26550;&#26500;&#65292;&#22914;&#65306;aarch64, i586, i686&#65292;x86_64&#31561;</span>
$<span style="color: #a0522d;">basearch</span>          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31995;&#32479;&#22522;&#30784;&#24179;&#21488;&#65307;i386, x86_64</span>
$<span style="color: #a0522d;">contentdir</span>        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#34920;&#31034;&#30446;&#24405;&#65292;&#27604;&#22914;&#65306;centos-8&#65292;centos-7</span>
$<span style="color: #a0522d;">YUM0</span>-$<span style="color: #a0522d;">YUM9</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#23450;&#20041;&#21464;&#37327;</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">http://server/centos/$<span style="color: #a0522d;">releasever</span>/$<span style="color: #a0522d;">basearch</span>/
http://server/centos/7/x86_64
http://server/centos/6/i386
</pre>
</div>

<p>
<b>baseurl指向的路径</b>
</p>

<p>
阿里云提供了写好的CentOS和ubuntu的仓库文件下载链接<a href="http://mirrors.aliyun.com/repo/">http://mirrors.aliyun.com/repo/</a>
</p>

<p>
Rocky 系统yun源
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21335;&#20140;&#22823;&#23398;</span>
https://mirror.nju.edu.cn/rocky/$<span style="color: #a0522d;">releasever</span>/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#28023;&#20132;&#22823;</span>
https://mirror.sjtu.edu.cn/rocky/$<span style="color: #a0522d;">releasever</span>/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23665;&#19996;&#22823;&#23398;</span>
https://mirrors.sdu.edu.cn/rocky/$<span style="color: #a0522d;">releasever</span>/
</pre>
</div>

<p>
CentOS系统的yum源
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#38463;&#37324;&#20113;</span>
https://mirrors.aliyun.com/centos/$<span style="color: #a0522d;">releasever</span>/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#21326;&#22823;&#23398;</span>
https://mirrors.tuna.tsinghua.edu.cn/centos/$<span style="color: #a0522d;">releasever</span>/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21326;&#20026;&#20113;</span>
https://mirrors.huaweicloud.com/centos/$<span style="color: #a0522d;">releasever</span>/
</pre>
</div>

<p>
EPEL的yum源
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#38463;&#37324;&#20113;</span>
https://mirrors.aliyun.com/epel/$<span style="color: #a0522d;">releasever</span>/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33150;&#35759;&#20113;</span>
https://mirrors.cloud.tencent.com/centos/$<span style="color: #a0522d;">releasever</span>/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21326;&#20026;&#20113;</span>
https://mirrors.huaweicloud.com/epel/$<span style="color: #a0522d;">releasever</span>/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#21326;&#22823;&#23398;</span>
https://mirrors.tuna.tsinghua.edu.cn/epel/$<span style="color: #a0522d;">releasever</span>/
</pre>
</div>

<p>
阿里巴巴开源软件
</p>
<div class="org-src-container">
<pre class="src src-sh">https://opsx.alibaba.com/
</pre>
</div>

<p>
范例：为CentOS7用系统安装光盘作的本地yum仓库
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25346;&#36733;&#20809;&#30424;&#33267;&#26576;&#30446;&#24405;,&#22914;/mnt/cdrom</span>
mount /dev/cdrom /mnt/cdrom

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#37197;&#32622;&#25991;&#20214;</span>
[root@centos7 ~]#vim /etc/yum.repos.d/centos7.repo
[CentOS7]
<span style="color: #a0522d;">name</span>=CentOS 7
<span style="color: #a0522d;">baseurl</span>=file:///mnt/cdrom
<span style="color: #a0522d;">gpgcheck</span>=0
<span style="color: #a0522d;">enabled</span>=1
</pre>
</div>

<p>
范例：为Rocky配置 yum 的系统和EPEL源仓库
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25903;&#25345;&#20809;&#30424;&#65292; /misc/cd&#23545;&#24212;&#23601;&#26159;&#20809;&#30424;&#20869;&#23481;</span>
yum install autofs
systemctl enable --now autofs
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /etc/yum.repos.d/base.repo
[BaseOS]
<span style="color: #a0522d;">name</span>=BaseOS
<span style="color: #a0522d;">baseurl</span>=file:///misc/cd/BaseOS
               https://mirror.nju.edu.cn/rocky/$<span style="color: #a0522d;">releasever</span>/BaseOS/$<span style="color: #a0522d;">basearch</span>/os/
<span style="color: #a0522d;">gpgcheck</span>=1
<span style="color: #a0522d;">gpgkey</span>=/etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial               

[AppStream]
<span style="color: #a0522d;">name</span>=AppStream
<span style="color: #a0522d;">baseurl</span>=file:///misc/cd/AppStream
               https://mirror.nju.edu.cn/rocky/$<span style="color: #a0522d;">releasever</span>/AppStream/$<span style="color: #a0522d;">basearch</span>/os/
<span style="color: #a0522d;">gpgcheck</span>=0

[extras]
<span style="color: #a0522d;">name</span>=extras
<span style="color: #a0522d;">baseurl</span>=https://mirror.nju.edu.cn/rocky/$<span style="color: #a0522d;">releasever</span>/extras/$<span style="color: #a0522d;">basearch</span>/os/
<span style="color: #a0522d;">gpgcheck</span>=0

[epel]
<span style="color: #a0522d;">name</span>=EPEL
<span style="color: #a0522d;">baseurl</span>=http://mirrors.aliyun.com/epel/$<span style="color: #a0522d;">releasever</span>/Everything/$<span style="color: #a0522d;">basearch</span>
               https://mirrors.tuna.tsinghua.edu.cn/epel/$<span style="color: #a0522d;">releasever</span>/Everything/$<span style="color: #a0522d;">basearch</span>/
<span style="color: #a0522d;">gpgcheck</span>=0
<span style="color: #a0522d;">enabled</span>=1
</pre>
</div>

<p>
注意：与之前的版本不同，CentOS 8 系统有两个yum 源：BaseOS和AppStream，
需要分别设置两个仓库
</p>

<p>
范例：用脚本实现创建yum仓库配置文件
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]# cat yum.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
mkdir /etc/yum.repos.d/backup
mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/backup

cat &gt; /etc/yum.repos.d/base.repo &lt;&lt;EOF
<span style="color: #ffa54f;">[base]</span>
<span style="color: #ffa54f;">name=base</span>
<span style="color: #ffa54f;">baseurl=https://mirrors.aliyun.com/centos/\$releasever/os/\$basearch</span>
<span style="color: #ffa54f;">gpgcheck=0</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:dffb8357-f15a-4707-8041-e1dfc59eb216" class="outline-4">
<h4 id="h:dffb8357-f15a-4707-8041-e1dfc59eb216">yum-config-manager命令</h4>
<div class="outline-text-4" id="text-h:dffb8357-f15a-4707-8041-e1dfc59eb216">
<p>
可以生成yum仓库的配置文件及启用或禁用仓库，来自于yum-utils包
</p>

<p>
格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">yum-config-manager --add-repo URL&#25110;file   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22686;&#21152;&#20179;&#24211;</span>
yum-config-manager --disable <span style="color: #8b2252;">"&#20179;&#24211;&#21517;"</span>        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#29992;&#20179;&#24211;</span>
yum-config-manager --enable <span style="color: #8b2252;">"&#20179;&#24211;&#21517;"</span>         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#20179;&#24211;</span>
</pre>
</div>

<p>
范例：创建仓库配置
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -qf <span style="color: #ff00ff;">`which yum-config-manager `</span>
dnf-utils-4.0.2.2-3.el8.noarch

[root@centos8 ~]#yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
Adding repo from: https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
[root@centos8 ~]#ls /etc/yum.repos.d/
backup base.repo docker-ce.repo
</pre>
</div>

<p>
范例：创建仓库配置
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;172.16.0.1_cobbler_ks_mirror_8_.repo</span>
[root@centos8 ~]#yum-config-manager --add-repo=http://172.16.0.1/cobbler/ks_mirror/8/

[root@centos8 ~]#cat /etc/yum.repos.d/172.16.0.1_cobbler_ks_mirror_8_.repo
[172.16.0.1_cobbler_ks_mirror_8_]
<span style="color: #a0522d;">name</span>=created by dnf config-manager from http://172.16.0.1/cobbler/ks_mirror/8/
<span style="color: #a0522d;">baseurl</span>=http://172.16.0.1/cobbler/ks_mirror/8/
<span style="color: #a0522d;">enabled</span>=1
</pre>
</div>

<p>
范例：创建仓库配置
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ls /etc/yum.repos.d/
backup base.repo
[root@centos8 ~]#yum-config-manager --add-repo /data/docker-ce.repo
Adding repo from: file:///data/docker-ce.repo
[root@centos8 ~]#ls /etc/yum.repos.d/
backup base.repo docker-ce.repo
[root@centos8 ~]#yum repolist
</pre>
</div>

<p>
范例：启用和禁用仓库
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum-config-manager --disable epel  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31105;&#29992;epel&#28304;</span>
[root@centos8 ~]#cat /etc/yum.repos.d/base.repo
[BaseOS]
<span style="color: #a0522d;">name</span>=BaseOS
<span style="color: #a0522d;">baseurl</span>=file:///misc/cd/BaseOS
<span style="color: #a0522d;">gpgcheck</span>=0
[AppStream]
<span style="color: #a0522d;">name</span>=AppStream
<span style="color: #a0522d;">baseurl</span>=file:///misc/cd/AppStream
<span style="color: #a0522d;">gpgcheck</span>=0
[epel]
<span style="color: #a0522d;">name</span>=EPEL
<span style="color: #a0522d;">baseurl</span>=http://mirrors.aliyun.com/epel/$<span style="color: #a0522d;">releasever</span>/Everything/$<span style="color: #a0522d;">basearch</span>
   http://mirrors.huaweicloud.com/epel/$<span style="color: #a0522d;">releasever</span>/Everything/$<span style="color: #a0522d;">basearch</span>
<span style="color: #a0522d;">gpgcheck</span>=0
<span style="color: #a0522d;">enabled</span>=0
[extras]
<span style="color: #a0522d;">name</span>=extras
<span style="color: #a0522d;">baseurl</span>=https://mirrors.aliyun.com/centos/$<span style="color: #a0522d;">releasever</span>/extras/$<span style="color: #a0522d;">basearch</span>/os
   http://mirrors.huaweicloud.com/centos/$<span style="color: #a0522d;">releasever</span>/extras/$<span style="color: #a0522d;">basearch</span>/os
<span style="color: #a0522d;">gpgcheck</span>=0
<span style="color: #a0522d;">enabled</span>=1
[root@centos8 ~]#yum repolist

[root@centos8 ~]#yum-config-manager --disable extras
[root@centos8 ~]#yum repolist
BaseOS               3.8 MB/s | 3.9 kB   00:00  
AppStream              4.2 MB/s | 4.3 kB   00:00  
repo id        repo name                      status
AppStream       AppStream                      4,755
BaseOS        BaseOS                        1,659
[root@centos8 ~]#yum-config-manager --enable extras
[root@centos8 ~]#yum repolist
BaseOS                 3.8 MB/s | 3.9 kB   00:00  
AppStream               4.2 MB/s | 4.3 kB   00:00  
extras                 12 kB/s | 1.5 kB   00:00  
repo id        repo name                      status
AppStream       AppStream                      4,755
BaseOS        BaseOS                        1,659
extras extras                         12
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c7e0b143-26b2-45bc-b851-f853ccc21c09" class="outline-4">
<h4 id="h:c7e0b143-26b2-45bc-b851-f853ccc21c09">锁定软件版本</h4>
<div class="outline-text-4" id="text-h:c7e0b143-26b2-45bc-b851-f853ccc21c09">
<p>
锁定后版本无法更新
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo cat /etc/yum/pluginconf.d/versionlock.conf
[main]
enabled = 1
locklist = /etc/yum/pluginconf.d/versionlock.list
<span style="color: #b22222;">#  </span><span style="color: #b22222;">Uncomment this to lock out "upgrade via. obsoletes" etc. (slower)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">follow_obsoletes = 1</span>

cat /etc/yum/pluginconf.d/versionlock.list

<span style="color: #b22222;"># </span><span style="color: #b22222;">Added locks on Sat Mar  4 23:44:04 2023</span>
0:kernel-5.4.231-137.341.amzn2.*

<span style="color: #b22222;"># </span><span style="color: #b22222;">Added locks on Sat Mar  4 23:44:14 2023</span>
0:runc-1.1.4-1.amzn2.*

<span style="color: #b22222;"># </span><span style="color: #b22222;">Added locks on Sat Mar  4 23:44:20 2023</span>
0:containerd-1.6.6-1.amzn2.0.2.*

<span style="color: #b22222;"># </span><span style="color: #b22222;">Added locks on Sat Mar  4 23:44:47 2023</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:cba0e6bc-ecc7-4dea-8806-52951d45d63d" class="outline-3">
<h3 id="h:cba0e6bc-ecc7-4dea-8806-52951d45d63d">yum命令</h3>
<div class="outline-text-3" id="text-h:cba0e6bc-ecc7-4dea-8806-52951d45d63d">
<p>
yum命令的用法：
</p>

<div class="org-src-container">
<pre class="src src-sh">yum [options] [command] [package ...]
</pre>
</div>

<p>
yum的命令行选项：
</p>

<div class="org-src-container">
<pre class="src src-sh">-y <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#21160;&#22238;&#31572;&#20026;"yes"</span>
-q <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38745;&#40664;&#27169;&#24335;</span>
--nogpgcheck <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#27490;&#36827;&#34892;gpg check</span>
--enablerepo=repoidglob   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20020;&#26102;&#21551;&#29992;&#27492;&#22788;&#25351;&#23450;&#30340;repo&#65292;&#25903;&#25345;&#36890;&#37197;&#31526;&#65292;&#22914;&#65306;"*"</span>
--disablerepo=repoidglob <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20020;&#26102;&#31105;&#29992;&#27492;&#22788;&#25351;&#23450;&#30340;repo,&#21644;&#19978;&#38754;&#35821;&#21477;&#21516;&#26102;&#20351;&#29992;&#65292;&#25918;&#22312;&#21518;&#38754;&#30340;&#29983;&#25928;</span>
--showduplicates &#22914;&#26524;&#22810;&#21152;&#20102;&#20179;&#24211;&#28304;&#65292;&#21487;&#26174;&#31034;&#21253;&#30340;&#22810;&#20010;&#29256;&#26412;
</pre>
</div>
</div>
<div id="outline-container-h:20020b7b-fb37-458f-b470-ae93033ae661" class="outline-4">
<h4 id="h:20020b7b-fb37-458f-b470-ae93033ae661">显示仓库列表</h4>
<div class="outline-text-4" id="text-h:20020b7b-fb37-458f-b470-ae93033ae661">
<div class="org-src-container">
<pre class="src src-sh">yum repolist [all|enabled|disabled]

-v    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#20179;&#24211;&#20449;&#24687;&#65292;&#21253;&#24635;&#25968;&#12289;&#24635;&#22823;&#23567;&#31561;</span>
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum repolist
[root@centos8 ~]#yum repolist all
[root@centos8 ~]#yum repolist -v
......
pkgsack time: 0.011
Repo-id      : base/7/x86_64
Repo-name    : CentOS-7 - Base
Repo-revision: 1604001756
Repo-updated : Thu Oct 29 20:03:00 2020
Repo-pkgs    : 10,072
Repo-size    : 8.9 G
Repo-mirrors : http://mirrorlist.centos.org/?<span style="color: #a0522d;">release</span>=7&amp;<span style="color: #a0522d;">arch</span>=x86_64&amp;<span style="color: #a0522d;">repo</span>=os&amp;<span style="color: #a0522d;">infra</span>=genclo
Repo-baseurl : https://download.cf.centos.org/centos/7/os/x86_64/ (1 more)
Repo-expire  : 21,600 second(s) (last: Mon Sep 23 05:38:09 2024)
  Filter     : read-only:present
Repo-filename: /etc/yum.repos.d/CentOS-Base.repo

[root@centos8 ~]#yum --enablerepo=ep* --disablerepo=A* repolist  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20020;&#26102;&#31105;&#29992;ep&#24320;&#22836;&#30340;&#28304;&#65292;&#21551;&#29992;A&#24320;&#22836;&#30340;&#28304;</span>
Last metadata expiration check: 0:01:18 ago on Sun 29 Dec 2019 12:13:27 AM CST.
repo id          repo name                     
status
BaseOS           BaseOS                      
 1,657
epel            EPEL                       
 3,733
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f767d76f-2dc8-46ea-adb4-e68dbf531e2c" class="outline-4">
<h4 id="h:f767d76f-2dc8-46ea-adb4-e68dbf531e2c">显示程序包</h4>
<div class="outline-text-4" id="text-h:f767d76f-2dc8-46ea-adb4-e68dbf531e2c">
<div class="org-src-container">
<pre class="src src-sh">yum list
yum list [all | glob_exp1] [glob_exp2] [...]
yum list {available|installed|updates} [glob_exp1] [...]
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 data]#dnf list mariadb-server
[root@centos8 data]#dnf list mariadb*  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25903;&#25345;&#36890;&#37197;&#31526;</span>

[root@centos8 data]#dnf list mariadb-server --showduplicates  <span style="color: #b22222;"># </span><span style="color: #b22222;">--showduplicates &#22914;&#26524;&#22810;&#21152;&#20102;&#20179;&#24211;&#28304;&#65292;&#21487;&#26174;&#31034;&#21253;&#30340;&#22810;&#20010;&#29256;&#26412;</span>

[root@centos8 data]#dnf list mariadb-server  --disablerepo=AppStream

[root@centos8 data]#dnf list mariadb-server --showduplicates --disablerepo=AppStream
Last metadata expiration check: 0:05:41 ago on Sun 08 Dec 2019 04:11:17 PM CST.
Available Packages
MariaDB-server.x86_64                  10.3.17-1.el8      mariadb
MariaDB-server.x86_64                  10.3.18-1.el8      mariadb
MariaDB-server.x86_64                  10.3.20-1.el8      mariadb
MariaDB-server.x86_64                  10.4.7-1.el8      mariadb2
MariaDB-server.x86_64                  10.4.8-1.el8      mariadb2
MariaDB-server.x86_64                  10.4.10-1.el8      
mariadb2
[root@centos8 ~]#yum --disablerepo=<span style="color: #8b2252;">"A*"</span> --disablerepo=<span style="color: #8b2252;">"B*"</span> --disablerepo=<span style="color: #8b2252;">"e*"</span> list available  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36807;&#28388;&#20986;&#21487;&#29992;&#30340;&#21253;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8cb17a52-2951-42a3-9c8d-357901b3c0ea" class="outline-4">
<h4 id="h:8cb17a52-2951-42a3-9c8d-357901b3c0ea">安装程序包</h4>
<div class="outline-text-4" id="text-h:8cb17a52-2951-42a3-9c8d-357901b3c0ea">
<div class="org-src-container">
<pre class="src src-sh">yum install package1 [package2] [...]
yum reinstall package1 [package2] [...] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#26032;&#23433;&#35013;</span>
</pre>
</div>


<p>
范例：只用 base 源安装服务
</p>

<div class="org-src-container">
<pre class="src src-sh">yum -y --disablerepo=* --enablerepo=base install bridge-utils
</pre>
</div>

<p>
范例：安装epel源
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#yum remove epel-release
[root@centos7 ~]#yum -y install sl
[root@centos7 ~]#rpm -ql sl

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36816;&#34892;&#23433;&#35013;sl&#31243;&#24207;&#65292;&#21487;&#20197;&#30475;&#21040;&#19979;&#38754;&#28779;&#36710;&#65292;&#36825;&#26631;&#24535;&#30528;&#25105;&#20204;&#21487;&#20197;&#24403;&#32769;&#21496;&#26426;&#20102;</span>
[root@centos7 ~]#sl -a
</pre>
</div>
</div>
<div id="outline-container-h:b76289ec-56f5-4271-8f29-d98e13b0b6a8" class="outline-5">
<h5 id="h:b76289ec-56f5-4271-8f29-d98e13b0b6a8">范例：只下载不安装</h5>
<div class="outline-text-5" id="text-h:b76289ec-56f5-4271-8f29-d98e13b0b6a8">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;1 yum </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#19979;&#36733;&#21253;&#21040;&#25351;&#23450;&#30446;&#24405;</span>
yum install --downloadonly --downloaddir=/tmp/php/ php73-php-fpm

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;CentOS/RHEL 6&#25110;&#26356;&#26089;&#26399;&#30340;&#29256;&#26412;&#20013;&#65292;&#20320;&#38656;&#35201;&#23433;&#35013;&#19968;&#20010;&#21333;&#29420;yum&#25554;&#20214;(&#21517;&#31216;&#20026; yum-plugin-downloadonly)&#25165;&#33021;&#20351;&#29992;--downloadonly&#21629;&#20196;&#36873;&#39033;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;2 yumdownloader</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21478;&#22806;&#19968;&#20010;&#19979;&#36733;RPM&#21253;&#30340;&#26041;&#27861;&#23601;&#26159;&#36890;&#36807;&#19968;&#20010;&#19987;&#38376;&#30340;&#21253;&#19979;&#36733;&#24037;&#20855;--yumdownloader&#12290; &#36825;&#20010;&#24037;&#20855;&#26159;yum&#24037;&#20855;&#21253;(&#21253;&#21547;&#20102;&#29992;&#26469;&#36827;&#34892;yum&#21253;&#31649;&#29702;&#30340;&#24110;&#21161;&#24037;&#20855;&#22871;&#20214;)&#30340;&#23376;&#38598;&#12290;</span>
yum install yum-utils 
yumdownloader lsof --resolve --destdir=/data/mydepot/  <span style="color: #b22222;">#</span><span style="color: #b22222;">resolve&#19979;&#36733;&#20381;&#36182;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c02ccb31-a0ec-4eb5-a1e3-f735f0c6a8b9" class="outline-5">
<h5 id="h:c02ccb31-a0ec-4eb5-a1e3-f735f0c6a8b9">范例：利用elrepo源在CentOS 7 安装新版内核</h5>
<div class="outline-text-5" id="text-h:c02ccb31-a0ec-4eb5-a1e3-f735f0c6a8b9">
<p>
<a href="https://www.elrepo.org/">https://www.elrepo.org/</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#yum install https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm
[root@centos7 ~]#rpm -ql elrepo-release-7.0-4.el7.elrepo
/etc/pki/elrepo
/etc/pki/elrepo/SECURE-BOOT-KEY-elrepo.org.der
/etc/pki/rpm-gpg
/etc/pki/rpm-gpg/RPM-GPG-KEY-elrepo.org
/etc/yum.repos.d
/etc/yum.repos.d/elrepo.repo

[root@centos7 ~]#yum repolist

[root@centos7 ~]#cat /etc/yum.repos.d/elrepo.repo
... ...
[elrepo-kernel]
<span style="color: #a0522d;">name</span>=ELRepo.org Community Enterprise Linux Kernel Repository - el7
<span style="color: #a0522d;">baseurl</span>=http://elrepo.org/linux/kernel/el7/$<span style="color: #a0522d;">basearch</span>/
http://mirrors.coreix.net/elrepo/kernel/el7/$<span style="color: #a0522d;">basearch</span>/
http://mirror.rackspace.com/elrepo/kernel/el7/$<span style="color: #a0522d;">basearch</span>/
http://repos.lax-noc.com/elrepo/kernel/el7/$<span style="color: #a0522d;">basearch</span>/
<span style="color: #a0522d;">mirrorlist</span>=http://mirrors.elrepo.org/mirrors-elrepo-kernel.el7
<span style="color: #a0522d;">enabled</span>=0
<span style="color: #a0522d;">gpgcheck</span>=1
<span style="color: #a0522d;">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-elrepo.org
<span style="color: #a0522d;">protect</span>=0
... ...


[root@centos7 ~]#yum --disablerepo=<span style="color: #8b2252;">"*"</span> --enablerepo=<span style="color: #8b2252;">"elrepo-kernel"</span> repolist

[root@u ~]#yum -y --enablerepo=<span style="color: #8b2252;">"elrepo-kernel"</span> install kernel-lt <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#26368;&#26032;&#20869;&#26680;.  kernel-lt-* &#26159;&#38271;&#26399;&#25903;&#25345;&#29256;&#65292; kernel-ml-* &#20027;&#32447;&#29256;&#21363;&#27979;&#35797;&#29256; </span>
[root@centos7 ~]#ls /boot
initramfs-3.10.0-957.el7.x86_64.img         
initramfs-5.4.6-1.el7.elrepo.x86_64.img

[root@centos7 ~]#ls /lib/modules
3.10.0-957.el7.x86_64  5.4.6-1.el7.elrepo.x86_64
[root@centos7 ~]#reboot
[root@centos7 ~]#uname -r
5.4.6-1.el7.elrepo.x86_64

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21368;&#36733;&#20869;&#26680;, &#20808;&#20999;&#21040;&#26087;&#20869;&#26680;</span>
yum remove kernel-lt
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:51a5b9e4-4811-42d8-8cd1-e76b78b9ca69" class="outline-4">
<h4 id="h:51a5b9e4-4811-42d8-8cd1-e76b78b9ca69">卸载程序包</h4>
<div class="outline-text-4" id="text-h:51a5b9e4-4811-42d8-8cd1-e76b78b9ca69">
<div class="org-src-container">
<pre class="src src-sh">yum remove | erase package1 [package2] [...]
</pre>
</div>
</div>
</div>
<div id="outline-container-h:27b4acc9-5922-4c70-bef0-866b76a21596" class="outline-4">
<h4 id="h:27b4acc9-5922-4c70-bef0-866b76a21596">升级和降级</h4>
<div class="outline-text-4" id="text-h:27b4acc9-5922-4c70-bef0-866b76a21596">
<p>
升级和降级
</p>

<div class="org-src-container">
<pre class="src src-sh">yum update [package1] [package2] [...]
yum downgrade package1 [package2] [...] (&#38477;&#32423;)
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]# cat /etc/yum.repos.d/base.repo
[base]
<span style="color: #a0522d;">name</span>=aliyum base
<span style="color: #a0522d;">baseurl</span>=https://mirrors.aliyun.com/centos/$<span style="color: #a0522d;">releasever</span>/os/$<span style="color: #a0522d;">basearch</span>
<span style="color: #a0522d;">gpgcheck</span>=1
<span style="color: #a0522d;">gpgkey</span>=https://mirrors.aliyun.com/centos/$<span style="color: #a0522d;">releasever</span>/os/x86_64/RPM-GPG-KEY-
CentOS-$<span style="color: #a0522d;">releasever</span>
<span style="color: #a0522d;">enabled</span>=1

[update]
<span style="color: #a0522d;">name</span>=aliyun update
<span style="color: #a0522d;">baseurl</span>=https://mirrors.aliyun.com/centos/7/updates/x86_64/
<span style="color: #a0522d;">gpgcheck</span>=0

[root@centos7 ~]#yum --disablerepo=* --enablerep=updates list available
[root@centos7 ~]#yum info samba

[root@centos7 ~]#yum info samba --showduplicates <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26174;&#31034;&#22810;&#20010;&#29256;&#26412;</span>
Name    : samba
Arch    : x86_64
Version   : 4.9.1
Release   : 6.el7

Name    : samba
Arch    : x86_64
Version   : 4.9.1
Release   : 10.el7_7

[root@centos7 ~]#yum install samba --disablerepo=updates
[root@centos7 ~]#yum update samba
[root@centos7 ~]# yum update
</pre>
</div>

<p>
检查可用升级：
</p>

<div class="org-src-container">
<pre class="src src-sh">yum check-update
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f3fc4561-2146-4283-989c-0f8b847073d7" class="outline-4">
<h4 id="h:f3fc4561-2146-4283-989c-0f8b847073d7">查询</h4>
<div class="outline-text-4" id="text-h:f3fc4561-2146-4283-989c-0f8b847073d7">
<p>
查看程序包information：
</p>
<div class="org-src-container">
<pre class="src src-sh">yum info [...] 
</pre>
</div>

<p>
查看指定的特性(可以是某文件)是由哪个程序包所提供：
</p>
<div class="org-src-container">
<pre class="src src-sh">yum provides | whatprovides feature1 [feature2] [...]
</pre>
</div>

<p>
注意：文件要写全路径，而不只是文件名，否则无法查询到
</p>


<p>
以指定的关键字搜索程序包名及summary信息
</p>
<div class="org-src-container">
<pre class="src src-sh">yum search string1 [string2] [...]
</pre>
</div>

<p>
查看指定包所依赖的capabilities：
</p>
<div class="org-src-container">
<pre class="src src-sh">yum deplist package1 [package2] [...]
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dnf info bash
Last metadata expiration check: 0:25:44 ago on Sun 22 Dec 2019 01:56:36 PM CST.
Installed Packages
Name     : bash
Version   : 4.4.19
Release   : 7.el8
Arch     : x86_64
Size     : 6.6 M
Source    : bash-4.4.19-7.el8.src.rpm
Repo     : @System
From repo  : anaconda
Summary   : The GNU Bourne Again shell
URL     : https://www.gnu.org/software/bash
License   : GPLv3+
Description : The GNU Bourne Again shell (Bash) is a shell or command language
      : interpreter that is compatible with the Bourne shell (sh)<span style="color: #483d8b;">.</span> Bash
      : incorporates useful features from the Korn shell (ksh) and the C
shell
      : (csh)<span style="color: #483d8b;">.</span> Most sh scripts can be run by bash without modification.
</pre>
</div>

<p>
范例:
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]# ll /etc/vsftpd/vsftpd.conf
ls: cannot access <span style="color: #8b2252;">'/etc/vsftpd/vsftpd.conf'</span>: No such file or directory

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#35201;&#20889;&#25991;&#20214;&#20840;&#36335;&#24452;&#25165;&#33021;&#26597;&#35810;&#21040;</span>
[root@centos8 ~]#yum provides vsftpd.conf
Last metadata expiration check: 0:56:45 ago on Fri 10 Apr 2020 11:24:00 AM CST.
Error: No Matches found

[root@centos8 ~]# yum provides /etc/vsftpd/vsftpd.conf
Last metadata expiration check: 0:33:13 ago on Fri 27 Dec 2019 03:47:34 PM CST.
vsftpd-3.0.3-28.el8.x86_64 : Very Secure Ftp Daemon
Repo    : AppStream
Matched from:
Filename  : /etc/vsftpd/vsftpd.conf

yum provides */mime.types  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#21253;&#25991;&#20214;&#21253;&#21547;mime.types&#30340;&#21253;</span>
</pre>
</div>


<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -ivh /misc/cd/AppStream/Packages/httpd-2.4.37-16.module_el8.1.0+256+ae790463.x86_64.rpm
error: Failed dependencies:
/etc/mime.types is needed by httpd-2.4.37-16.module_el8.1.0+256+ae790463.x86_64

[root@centos8 ~]#yum provides /etc/mime.types
mailcap-2.1.48-3.el8.noarch : Helper application and MIME type associations for

[root@centos8 ~]#yum deplist httpd
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#21487;&#29992;&#29256;&#26412;</span>
yum list kubeadm.x86_64 --showduplicates | sort -r
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#29256;&#26412;yum install -y kubeadm-1.21.3-0.x86_64 kubectl-1.21.3-0.x86_64 kubelet-1.21.3-0.x86_64</span>
yum install -y kubelet kubeadm kubectl
<span style="color: #b22222;">#</span><span style="color: #b22222;">systemctl enable --now kubelet</span>
</pre>
</div>

<p>
范例：查看未安装包的文件列表
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">centos8</span>
yum repoquery -l memcached

<span style="color: #b22222;">#</span><span style="color: #b22222;">centos7</span>
yum -y install yum-utils
yum -ql memcached
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d11b2a47-813a-4c05-ac3e-3718aaf92fea" class="outline-4">
<h4 id="h:d11b2a47-813a-4c05-ac3e-3718aaf92fea">仓库缓存</h4>
<div class="outline-text-4" id="text-h:d11b2a47-813a-4c05-ac3e-3718aaf92fea">
<p>
清除目录/var/cache/{yum, dnf}/缓存
</p>

<div class="org-src-container">
<pre class="src src-sh">yum clean [ packages | metadata | expire-cache | rpmdb | plugins | all ]
</pre>
</div>

<p>
构建缓存：
</p>
<div class="org-src-container">
<pre class="src src-sh">yum makecache
</pre>
</div>

<p>
范例：管理yum缓存
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#du -sh /var/cache/yum
93M /var/cache/yum
[root@centos7 ~]#ls /var/cache/yum/x86_64/7/
base epel extras timedhosts timedhosts.txt

[root@u ~]#yum clean all  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#38500;&#20803;&#25968;&#25454;</span>
Loaded plugins: fastestmirror
Cleaning repos: base epel extras
Cleaning up list of fastest mirrors
[root@centos7 ~]#du -sh /var/cache/yum
4.0K /var/cache/yum
[root@centos7 ~]#yum makecache  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#26032;&#19979;&#36733;&#20803;&#25968;&#25454;</span>
......
Metadata Cache Created
[root@centos7 ~]#du -sh /var/cache/yum
276M /var/cache/yum
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3cdce67e-9825-4c88-b953-f7c3d77cd8f0" class="outline-4">
<h4 id="h:3cdce67e-9825-4c88-b953-f7c3d77cd8f0">查看yum事务历史</h4>
<div class="outline-text-4" id="text-h:3cdce67e-9825-4c88-b953-f7c3d77cd8f0">
<p>
yum 执行安装卸载命令会记录到相关日志中 日志 文件：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">CentOS 7&#20197;&#21069;&#29256;&#26412;&#26085;&#24535;</span>
/var/log/yum.log

<span style="color: #b22222;">#</span><span style="color: #b22222;">CentOS 8 &#29256;&#26412;&#26085;&#24535;</span>
/var/log/dnf.rpm.log
/var/log/dnf.log

<span style="color: #b22222;"># </span><span style="color: #b22222;">tail  /var/log/anaconda/packaging.log  # &#23433;&#35013;&#25805;&#20316;&#31995;&#32479;&#26102;&#23433;&#35013;&#36807;&#30340;&#21253;</span>
12:38:15,280 INFO packaging: iwl2000-firmware-18.168.6.1-69.el7.noarch (295/298)

12:38:15,280 INFO packaging: iwl6000g2a-firmware-17.168.5.3-69.el7.noarch (296/298)
</pre>
</div>

<p>
日志命令
</p>

<div class="org-src-container">
<pre class="src src-sh">yum history [info|list|packages-list|packages-info|summary|addon-info|redo|undo|rollback|new|sync|stats]
</pre>
</div>

<p>
范例： 查看软件安装事件并删除安装过的包
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dnf history
ID   | Command line       | Date and time  | Action(s)   | Altered
-------------------------------------------------------------------------------
  22 | install yum-utils    | 2019-12-22 13:44 | Install    |   1 
  21 | remove vsftpd      | 2019-12-22 13:39 | Removed    |   1 
  20 | install vsftpd      | 2019-12-22 13:39 | Install    |   1 
  19 | install python3     | 2019-12-22 12:26 | Install    |   3 
  18 | install perl       | 2019-12-22 12:25 | Install    |  156 
  17 | install httpd -y     | 2019-12-21 20:21 | Install    |  10 
...&#30465;&#30053;...
[root@centos8 ~]#dnf history info 22
Transaction ID : 22
Begin time   : Sun 22 Dec 2019 01:44:08 PM CST
Begin rpmdb  : 607:35cd823ff347e56ceb688a9f72715eabb3c53d41
End time    : Sun 22 Dec 2019 01:44:08 PM CST (0 seconds)
End rpmdb   : 608:24139ec38fc131c182b75fdaad0626692045da94
User      : root &lt;root&gt;
Return-Code  : Success
Releasever   : 8
Command Line  : install yum-utils
Packages Altered:
 Install dnf-utils-4.0.2.2-3.el8.noarch @BaseOS
[root@centos8 ~]#dnf history undo 22 -y  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25764;&#38144;&#65292;&#23558;&#21253;&#21450;&#20854;&#23427;&#20381;&#36182;&#21253;&#19968;&#24182;&#21368;&#36733;</span>
Removed:
dnf-utils-4.0.2.2-3.el8.noarch       
Complete!
[root@centos8 ~]#dnf history redo 22 -y  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21453;&#25764;&#38144;&#65292;&#37325;&#26032;&#23433;&#35013;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:151e618d-41f2-4296-86ea-800111925875" class="outline-4">
<h4 id="h:151e618d-41f2-4296-86ea-800111925875">安装及升级本地程序包</h4>
<div class="outline-text-4" id="text-h:151e618d-41f2-4296-86ea-800111925875">
<div class="org-src-container">
<pre class="src src-sh">yum localinstall|install rpmfile1 [rpmfile2] [...]
yum localupdate|update rpmfile1 [rpmfile2] [...]
</pre>
</div>
</div>
</div>
<div id="outline-container-org39cc6c0" class="outline-4">
<h4 id="org39cc6c0">查看包的安全警报</h4>
<div class="outline-text-4" id="text-org39cc6c0">
<div class="org-src-container">
<pre class="src src-sh">yum updateinfo --summary|--list|--info
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-sh">yum updateinfo summary
yum updateinfo
yum updateinfo all
yum updateinfo list
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1b3ff4a3-da51-4184-ab6d-b6328f171bdc" class="outline-4">
<h4 id="h:1b3ff4a3-da51-4184-ab6d-b6328f171bdc">包组管理的相关命令</h4>
<div class="outline-text-4" id="text-h:1b3ff4a3-da51-4184-ab6d-b6328f171bdc">
<div class="org-src-container">
<pre class="src src-sh">yum grouplist [hidden] [groupwildcard] [...]
yum groupinstall group1 [group2] [...]
yum groupupdate group1 [group2] [...]
yum groupremove group1 [group2] [...]
yum groupinfo group1 [...]
</pre>
</div>

<p>
范例：最小化安装的系统安装图形环境
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum grouplist
Last metadata expiration check: 0:21:21 ago on Sun 22 Dec 2019 01:56:36 PM CST.
Available Environment Groups:
 Server with GUI
 Server
 Workstation
 KDE Plasma Workspaces
 Virtualization Host
 Custom Operating System
Installed Environment Groups:
 Minimal Install
Available Groups:
 Container Management
 .NET Core Development
 RPM Development Tools
 Smart Card Support
 Development Tools
 Graphical Administration Tools
 Headless Management
 Legacy UNIX Compatibility
 Network Servers
 Scientific Support
 Security Tools
 System Tools
 Fedora Packager
[root@centos8 ~]#yum groupinfo <span style="color: #8b2252;">"Server with GUI"</span>
Last metadata expiration check: 0:32:00 ago on Wed 08 Apr 2020 04:35:02 PM CST.
Environment Group: Server with GUI
Description: An integrated, easy-to-manage server with a graphical interface.
no group <span style="color: #8b2252;">'dns-server'</span> from environment <span style="color: #8b2252;">'graphical-server-environment'</span>
Mandatory Groups:
 Common NetworkManager submodules
 Container Management
 Core
 Fonts
 GNOME
 Guest Desktop Agents
 Hardware Monitoring Utilities
 Hardware Support
 Headless Management
 Internet Browser
 Multimedia
 Printing Client
 Server product core
 Standard
 base-x
Optional Groups:
 Basic Web Server
 Debugging Tools
 FTP Server
 File and Storage Server
 Guest Agents
 Infiniband Support
 Mail Server
 Network File System Client
 Network Servers
 Performance Tools
 Remote Desktop Clients
 Remote Management for Linux
 Virtualization Client
 Virtualization Hypervisor
 Virtualization Tools
 Windows File Server
[root@centos8 ~]#dnf groupinstall GNOME -y
[root@centos8 ~]#init 5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:63ec964a-bb5a-4faa-bbf7-475adcaac0e5" class="outline-4">
<h4 id="h:63ec964a-bb5a-4faa-bbf7-475adcaac0e5">实现私用 yum仓库</h4>
<div class="outline-text-4" id="text-h:63ec964a-bb5a-4faa-bbf7-475adcaac0e5">
<p>
下载所有yum仓库的相关包和meta 数据
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">CentOS 8 dnf &#24037;&#20855;&#38598;&#25104;</span>
dnf reposync --help <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24110;&#21161;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#21482;&#19979;&#36733;rpm&#21253;&#65292;&#19981;&#19979;&#36733;meta&#25968;&#25454;&#65292;&#38656;&#35201;&#25351;&#23450;--download-metadata &#25165;&#33021;&#19979;&#36733;meta</span>
dnf reposync  --repoid=REPOID --download-metadata -p /path

<span style="color: #b22222;">#</span><span style="color: #b22222;">CentOS 7 &#20197;&#21069;&#29256;&#26412;&#65292;reposync&#24037;&#20855;&#26469;&#33258;&#20110;yum-utils&#21253;</span>
reposync --repoid=REPOID --download-metadata -p /path 
</pre>
</div>

<p>
创建私有yum仓库：
</p>
<div class="org-src-container">
<pre class="src src-sh">createrepo [options] &lt;directory&gt;
</pre>
</div>

<p>
范例：创建局域网的基于Base的私有yum源
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20179;&#24211;&#26381;&#21153;&#22120;&#37197;&#32622;</span>
[root@repo-server ~]#yum -y install httpd
[root@repo-server ~]#systemctl enable --now httpd
[root@repo-server ~]#mkdir /var/www/html/centos/8 -pv
[root@repo-server ~]#mount /dev/sr0 /mnt/  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20809;&#30424;&#25346;&#36733;</span>
[root@repo-server ~]#cp -a /mnt/* /var/www/html/centos/8

<span style="color: #b22222;">#</span><span style="color: #b22222;">yum&#23458;&#25143;&#31471;&#37197;&#32622;</span>
[root@repo-client ~]#cat /etc/yum.repos.d/test.repo
[BaseOS]
<span style="color: #a0522d;">name</span>=BaseOS
<span style="color: #a0522d;">baseurl</span>=http://10.0.0.8/centos/8/BaseOS
<span style="color: #a0522d;">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial
[AppStream]
<span style="color: #a0522d;">name</span>=Appstream
<span style="color: #a0522d;">baseurl</span>=http://10.0.0.8/centos/8/AppStream/
<span style="color: #a0522d;">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial
</pre>
</div>

<p>
范例：下载阿里云的extras源，制作私有yum源
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@repo-server ~]#dnf reposync --repoid=extras --download-metadata -p /var/www/html/centos

[root@repo-server ~]#ls /var/www/html/centos/
8 extras
[root@repo-server ~]#ls /var/www/html/centos/extras/
Packages repodata

[root@repo-client ~]#cat /etc/yum.repos.d/test.repo
[BaseOS]
<span style="color: #a0522d;">name</span>=BaseOS
<span style="color: #a0522d;">baseurl</span>=http://10.0.0.8/centos/8/BaseOS
<span style="color: #a0522d;">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial
[AppStream]
<span style="color: #a0522d;">name</span>=Appstream
<span style="color: #a0522d;">baseurl</span>=http://10.0.0.8/centos/8/AppStream/
<span style="color: #a0522d;">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial
[extras]
<span style="color: #a0522d;">name</span>=extras
<span style="color: #a0522d;">baseurl</span>=http://10.0.0.8/centos/extras/

[root@repo-client ~]#yum repolist
[root@repo-client ~]#yum --disablerepo=* --enablerepo=extras list available
[root@repo-client ~]#yum -y install epel-release
</pre>
</div>

<p>
范例：下载阿里云的EPEL源，制作私有yum源
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /etc/yum.repos.d/base.repo
[epel]
<span style="color: #a0522d;">name</span>=EPEL
<span style="color: #a0522d;">baseurl</span>=https://mirrors.aliyun.com/epel/8/Everything/x86_64/
<span style="color: #a0522d;">gpgcheck</span>=0

[root@centos8 ~]#dnf repolist
Last metadata expiration check: 0:07:40 ago on Sun 22 Dec 2019 03:14:16 PM CST.
repo id       repo name                      status
AppStream      AppStream                      4,681
BaseOS        BaseOS                        1,655
epel         EPEL                         3,707

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#36733;&#30456;&#20851;&#20179;&#24211;&#21253;&#21644;&#20803;&#25968;&#25454;</span>
[root@centos8 ~]#dnf reposync --repoid=epel --download-metadata  -p /var/www/html
<span style="color: #b22222;">#</span><span style="color: #b22222;">--download-metadata &#21152;&#27492;&#36873;&#39033;&#21487;&#20197;&#19979;&#36733;&#20803;&#25968;&#25454;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#36733;&#30456;&#20851;&#30340;key&#25991;&#20214;</span>
[root@repo-server ~]#wget -P /var/www/html/epel/ https://mirrors.aliyun.com/epel/RPM-GPG-KEY-EPEL-8
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#38754;&#20004;&#20010;&#27493;&#39588;&#21482;&#26377;&#27809;meta&#25968;&#25454;&#25165;&#38656;&#35201;&#25191;&#34892;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">[root@centos8 ~]#dnf -y install createrepo httpd</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">[root@centos8 ~]#createrepo /var/www/html/epel/</span>
[root@centos8 ~]#ls /var/www/html/epel/
Packages repodata
[root@centos8 ~]#systemctl start httpd
[root@repo-client ~]#cat /etc/yum.repos.d/test.repo
[BaseOS]
<span style="color: #a0522d;">name</span>=BaseOS
<span style="color: #a0522d;">baseurl</span>=http://10.0.0.8/centos/8/BaseOS
<span style="color: #a0522d;">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial
[AppStream]
<span style="color: #a0522d;">name</span>=Appstream
<span style="color: #a0522d;">baseurl</span>=http://10.0.0.8/centos/8/AppStream/
<span style="color: #a0522d;">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial
[extras]
<span style="color: #a0522d;">name</span>=extras
<span style="color: #a0522d;">baseurl</span>=http://10.0.0.8/centos/extras/
[epel]
<span style="color: #a0522d;">name</span>=epel
<span style="color: #a0522d;">baseurl</span>=http://10.0.0.8/epel/
<span style="color: #a0522d;">gpgkey</span>=http://10.0.0.8/epel/RPM-GPG-KEY-EPEL-8

[root@repo-client ~]#yum repolist
extras                  1.6 MB/s | 4.9 kB   00:00  
epel                   88 MB/s | 6.2 MB   00:00  
repo id     repo name        status
AppStream    Appstream         4,755
BaseOS     BaseOS          1,659
epel      epel           5,206
extras extras          12
[root@repo-client ~]#dnf install openvpn
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1a95dba4-44af-4866-b38a-9044eab803b2" class="outline-4">
<h4 id="h:1a95dba4-44af-4866-b38a-9044eab803b2">DNF 介绍</h4>
<div class="outline-text-4" id="text-h:1a95dba4-44af-4866-b38a-9044eab803b2">
<p>
DNF，即DaNdiFied，是新一代的RPM软件包管理器。DNF发行日期是2015年5月11
日，DNF 包管理器采用Python 编写，发行许可为GPL v2，首先出现在Fedora 18
发行版中。在 RHEL 8.0 版本正式取代了YUM，DNF包管理器克服了YUM包管理器
的一些瓶颈，提升了包括用户体验，内存占用，依赖分析，运行速度等
</p>

<p>
配置文件：
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/dnf/dnf.conf 
</pre>
</div>

<p>
仓库文件：
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/yum.repos.d/ *.repo
</pre>
</div>

<p>
日志：
</p>

<div class="org-src-container">
<pre class="src src-sh">/var/log/dnf.rpm.log
/var/log/dnf.log
</pre>
</div>

<p>
DNF 使用帮助：man dnf
</p>

<p>
dnf 用法与yum一致
</p>

<div class="org-src-container">
<pre class="src src-sh">dnf [options] &lt;command&gt; [&lt;arguments&gt;...]
dnf --version
dnf repolist
dnf reposync
dnf install httpd
dnf remove httpd
dnf clean all
dnf makecache
dnf list installed
dnf list available
dnf search nano
dnf history undo 1
</pre>
</div>

<p>
CentOS 7 使用 dnf ，下载并安装下面包
</p>

<div class="org-src-container">
<pre class="src src-sh">wget http://springdale.math.ias.edu/data/puias/unsupported/7/x86_64/dnf-conf-0.6.4-2.sdl7.noarch.rpm
wget http://springdale.math.ias.edu/data/puias/unsupported/7/x86_64/dnf-0.6.4-2.sdl7.noarch.rpm
wget http://springdale.math.ias.edu/data/puias/unsupported/7/x86_64/python-dnf-0.6.4-2.sdl7.noarch.rpm
wget https://mirrors.aliyun.com/centos/7/extras/x86_64/Packages/python2-libcomps-0.1.8-12.el7.x86_64.rpm
wget https://mirrors.aliyun.com/centos/7/extras/x86_64/Packages/libcomps-0.1.8-12.el7.x86_64.rpm
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d84bb7d7-5799-403e-aa93-4e95aec4f6c4" class="outline-4">
<h4 id="h:d84bb7d7-5799-403e-aa93-4e95aec4f6c4">yum Troubleshooting</h4>
<div class="outline-text-4" id="text-h:d84bb7d7-5799-403e-aa93-4e95aec4f6c4">
<p>
yum 和 dnf 失败最主要原因：
</p>

<ul class="org-ul">
<li>yum的配置文件格式或路径错误
解决方法：检查/etc/yum.repos.d/*.repo文件格式</li>
<li>yum cache 解决方法：yum clean all</li>
<li>网络不通： 解决方法：网卡配置</li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-h:ee8702e2-25dc-4096-bf4d-210aae3a906f" class="outline-2">
<h2 id="h:ee8702e2-25dc-4096-bf4d-210aae3a906f">程序包编译</h2>
<div class="outline-text-2" id="text-h:ee8702e2-25dc-4096-bf4d-210aae3a906f">
</div>
<div id="outline-container-h:f64a6f08-63d6-41ce-870b-83b12f331e66" class="outline-3">
<h3 id="h:f64a6f08-63d6-41ce-870b-83b12f331e66">源码编译介绍</h3>
<div class="outline-text-3" id="text-h:f64a6f08-63d6-41ce-870b-83b12f331e66">
<p>
程序包编译安装： 源代码&#x2013;&gt;预处理&#x2013;&gt;编译&#x2013;&gt;汇编&#x2013;&gt;链接&#x2013;&gt;执行
</p>

<p>
多文件：文件中的代码之间，很可能存在跨文件依赖关系
</p>

<p>
虽然有很多开源软件将软件打成包，供人们使用，但并不是所有源代码都打成包，
如果想使用开源软件，可能需要自已下载源码，进行编译安装。另外即使提供了
包，但是生产中需要用于软件的某些特性，仍然需要自行编译安装。但是利用源
代码编译安装是比较繁琐的，庆幸的是有相关的项目管理工具可以大大减少编译
过程的复杂度
</p>
</div>
</div>
<div id="outline-container-h:df05665b-8680-4c49-9de8-0d9361484ae0" class="outline-3">
<h3 id="h:df05665b-8680-4c49-9de8-0d9361484ae0">开源程序源代码的获取</h3>
<div class="outline-text-3" id="text-h:df05665b-8680-4c49-9de8-0d9361484ae0">
<p>
项目官方自建站点：
</p>

<ul class="org-ul">
<li><a href="https://apache.org">https://apache.org</a> (ASF：Apache Software Foundation)</li>
<li><a href="https://mariadb.org">https://mariadb.org</a></li>
<li>&#x2026;</li>
</ul>

<p>
代码托管：
</p>
<ul class="org-ul">
<li><a href="https://github.com">https://github.com</a></li>
<li><a href="https://gitee.com">https://gitee.com</a></li>
<li><a href="https://sourceforge.net">https://sourceforge.net</a></li>
<li><a href="https://code.google.com">https://code.google.com</a></li>
</ul>
</div>
</div>
<div id="outline-container-h:7a2c0189-8b82-4238-bf01-d8a8bd14a162" class="outline-3">
<h3 id="h:7a2c0189-8b82-4238-bf01-d8a8bd14a162">编译源码的项目工具</h3>
<div class="outline-text-3" id="text-h:7a2c0189-8b82-4238-bf01-d8a8bd14a162">
<ul class="org-ul">
<li><p>
C、C++的源码编译：使用 make 项目管理器
</p>

<p>
configure脚本 &#x2013;&gt; Makefile.in &#x2013;&gt; Makefile
</p>

<p>
相关开发工具：
</p>
<ul class="org-ul">
<li>autoconf: 生成configure脚本</li>
<li>automake：生成Makefile.in</li>
</ul></li>

<li>java的源码编译: 使用 maven</li>
</ul>


<p>
源码编译优势：私人定制更符合自己的要求
</p>
</div>
</div>
<div id="outline-container-h:5eadb370-44cc-4855-ad66-9f9fa91194d1" class="outline-3">
<h3 id="h:5eadb370-44cc-4855-ad66-9f9fa91194d1">C语言源代码编译安装过程</h3>
<div class="outline-text-3" id="text-h:5eadb370-44cc-4855-ad66-9f9fa91194d1">
<p>
利用编译工具，通常只需要三个大的步骤
</p>

<ul class="org-ul">
<li>./configure
<ol class="org-ol">
<li>通过选项传递参数，指定安装路径、启用特性等；执行时会参考用户的指
定以及Makefile.in文件生成Makefile</li>
<li>检查依赖到的外部环境，如依赖的软件包</li>
</ol></li>
<li>make 根据Makefile文件，会检测依赖的环境，进行构建应用程序，</li>
<li>make install 复制文件到相应路径</li>
</ul>

<p>
注意：安装前可以通过查看README，INSTALL获取帮助
</p>
</div>
<div id="outline-container-h:241bf723-dd84-498b-99b6-3965c0954a2d" class="outline-4">
<h4 id="h:241bf723-dd84-498b-99b6-3965c0954a2d">编译安装准备</h4>
<div class="outline-text-4" id="text-h:241bf723-dd84-498b-99b6-3965c0954a2d">
<p>
准备：安装相关的依赖包
</p>

<ul class="org-ul">
<li>开发工具：make, gcc (c/c++编译器GNU C Complier)</li>
<li>开发环境：开发库（glibc：标准库），头文件，可安装开发包组
Development Tools</li>
<li>软件相关依赖包</li>
</ul>

<p>
生产实践：基于最小化安装的系统建议安装下面相关包
</p>

<div class="org-src-container">
<pre class="src src-sh">yum install  gcc make autoconf gcc-c++ glibc glibc-devel pcre pcre-devel openssl openssl-devel 
ncurses-devel systemd-devel zlib-devel  vim lrzsz tree tmux lsof tcpdump wget net-tools iotop bc bzip2 zip unzip nfs-utils man-pages
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e9d3886c-10ff-4f0f-9ee4-1a8f08c88f61" class="outline-4">
<h4 id="h:e9d3886c-10ff-4f0f-9ee4-1a8f08c88f61">编译安装</h4>
<div class="outline-text-4" id="text-h:e9d3886c-10ff-4f0f-9ee4-1a8f08c88f61">
<p>
<b>第一步：运行 configure 脚本，生成Makefile 文件</b>
</p>

<ol class="org-ol">
<li>通过选项传递参数，指定启用特性、安装路径等；执行时会参考用户的指定
以及Makefile.in 文件生成 makefile；</li>

<li>检查依赖到的外部环境；如果此时依赖的外部环境没有配置，会导致报错</li>
</ol>

<p>
其选项主要功能：
</p>

<ul class="org-ul">
<li>可以指定安装位置</li>
<li>指定启用的特性</li>
</ul>

<p>
获取其支持使用的选项
</p>

<div class="org-src-container">
<pre class="src src-sh">./configure --help
</pre>
</div>

<p>
选项分类：
</p>
<div class="org-src-container">
<pre class="src src-sh">- &#23433;&#35013;&#36335;&#24452;&#35774;&#23450;&#65306;
  --prefix=/PATH&#65306;&#25351;&#23450;&#40664;&#35748;&#23433;&#35013;&#20301;&#32622;,&#40664;&#35748;&#20026;/usr/local/
  --sysconfdir=/PATH&#65306;&#37197;&#32622;&#25991;&#20214;&#23433;&#35013;&#20301;&#32622;
  System types&#65306;&#25903;&#25345;&#20132;&#21449;&#32534;&#35793;

- &#36719;&#20214;&#29305;&#24615;&#21644;&#30456;&#20851;&#25351;&#23450;&#65306;
  Optional Features: &#21487;&#36873;&#29305;&#24615;
   --disable-FEATURE <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#29992;&#29305;&#24615;</span>
   --enable-FEATURE[=ARG] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#26576;&#29305;&#24615;</span>
  Optional Packages: &#21487;&#36873;&#21253;
   --with-PACKAGE[=ARG] &#20381;&#36182;&#21253;
   --without-PACKAGE &#31105;&#29992;&#20381;&#36182;&#20851;&#31995;
</pre>
</div>

<p>
注意：通常被编译操作依赖的程序包，需要安装此程序包的”开发”组件，其包
名一般类似于name-devel-VERSION
</p>

<p>
configure和Makefile.in是程序员通过两个工具生成并提供给我们使用的开发工
具：
</p>

<ol class="org-ol">
<li><p>
autoconf : 生成configure脚本；
</p>

<p>
autoconf和别的配置文件结合生产configure 脚本
</p></li>

<li><p>
automake : 生成Makefile.in
</p>

<p>
automake和别的配置文件结合生产Makefile.in文件
</p></li>
</ol>

<p>
<b>第二步：make</b>
</p>

<p>
根据makefile文件，构建应用程序；
</p>

<p>
通过生成的makefile文件调用预处理器，编译器等开始编译安装程序包
</p>

<div class="org-src-container">
<pre class="src src-sh">nproc&#21629;&#20196;&#33719;&#21462;cpu&#20010;&#25968;
make -j $(<span style="color: #ff00ff;">nproc</span>)
</pre>
</div>

<p>
<b>第三步：make install</b>
</p>

<p>
相当于使用了mkdir,install命令，把二进制文件、库文件、配置文件、帮助文
件复制到对应的目录中；
</p>

<p>
make distclean 对目录进行编译清理。
</p>

<p>
建议：安装前查看INSTALL，README
</p>

<p>
c/c++编译通过: gcc (GNU C Complier)编译器来实现；
</p>

<p>
<b>报错解决经验</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#32570;&#23569;&#25991;&#20214;</span>
yum provides */filename  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#25991;&#20214;&#20381;&#36182;&#21738;&#20010;&#21253;</span>
yum provides autoheader  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#31243;&#24207;&#20381;&#36182;&#21738;&#20010;&#21253;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">APR Not find &#20687;&#36825;&#31181;&#27809;&#26377;&#21457;&#29616;&#19968;&#33324;&#37117;&#32570;&#23569;&#24320;&#21457;&#21253;</span>
yum install apr-devel
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cde24117-8fde-47ef-b0f3-8ff0ceccf999" class="outline-4">
<h4 id="h:cde24117-8fde-47ef-b0f3-8ff0ceccf999">安装后的配置</h4>
<div class="outline-text-4" id="text-h:cde24117-8fde-47ef-b0f3-8ff0ceccf999">
<ol class="org-ol">
<li><p>
二进制程序目录导入至PATH环境变量中
</p>

<p>
编辑文件/etc/profile.d/NAME.sh
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">export</span> <span style="color: #a0522d;">PATH</span>=/PATH/TO/BIN:$<span style="color: #a0522d;">PATH</span>
</pre>
</div></li>

<li><p>
相关用户及文件
</p>

<p>
有些开源软件编译完成后，还需要创建相关的用户及文件
</p></li>

<li><p>
导入帮助手册
</p>

<p>
编辑/etc/man.config|man_db.conf文件,添加一个MANPATH
</p></li>
</ol>

<p>
其它：
</p>

<p>
导出库文件路径
</p>

<ol class="org-ol">
<li>编辑/etc/ld.so.conf.d/NAME.conf 添加新的库文件所在目录至此文件中；</li>
<li>让系统重新生成缓存： <code>ldconfig [-v] #要显示过程就加-v选项</code></li>
</ol>

<p>
导出头文件
</p>

<p>
基于链接的方式实现，导出整个目录为一个连接文件；ln -sv
</p>

<p>
如， <code>ln -sv /usr/local/apache2/include/ /usr/include/http2</code>
</p>

<p>
范例：CentOS 7 编译安装 tree1.8
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1 &#23433;&#35013;&#30456;&#20851;&#30340;&#20381;&#36182;&#21253;</span>
[root@centos7 ~]#yum install gcc make

<span style="color: #b22222;">#</span><span style="color: #b22222;">2 &#19979;&#36733;&#28304;&#30721;&#24182;&#35299;&#21387;</span>
[root@centos7 ~]#tar xvf tree-1.8.0.tgz

<span style="color: #b22222;">#</span><span style="color: #b22222;">3 &#36827;&#20837;&#35299;&#21387;&#32553;&#30340;&#30446;&#24405;&#65292;README&#21644;INSTALL</span>
[root@centos7 ~]#cd tree-1.8.0/
[root@centos7 tree-1.8.0]#cat README
[root@centos7 tree-1.8.0]#cat INSTALL

<span style="color: #b22222;">#</span><span style="color: #b22222;">4 &#20462;&#25913;&#28304;&#30721;&#30340;&#29256;&#26412;&#21495;</span>
[root@centos7 tree-1.8.0]#sed -i <span style="color: #8b2252;">'s#v1\.8\.0#v.8.8.8#'</span> tree.c

<span style="color: #b22222;">#</span><span style="color: #b22222;">5 &#32534;&#35793;&#20934;&#22791;</span>
[root@centos7 tree-1.8.0]#vim Makefile
prefix = /apps/tree

<span style="color: #b22222;">#</span><span style="color: #b22222;">6 &#32534;&#35793;</span>
[root@centos7 tree-1.8.0]#make

<span style="color: #b22222;">#</span><span style="color: #b22222;">7 &#23433;&#35013;</span>
[root@centos7 tree-1.8.0]#make install

<span style="color: #b22222;">#</span><span style="color: #b22222;">8 &#20462;&#25913;PATH&#21464;&#37327;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#26080;&#27861;&#30452;&#25509;&#36816;&#34892;tree</span>
[root@centos7 ~]#tree
-bash: tree: command not found
[root@centos7 ~]#echo <span style="color: #8b2252;">'PATH=/apps/tree/bin:$PATH'</span> &gt; /etc/profile.d/tree.sh

<span style="color: #483d8b;">.</span> /etc/profile.d/tree.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#21033;&#29992;&#36719;&#38142;&#25509;&#23454;&#29616;</span>
[root@centos7 ~]#ln -s /apps/tree/bin/tree /usr/local/bin

<span style="color: #483d8b;">hash</span> -r <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#29702;&#32531;&#23384;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">9 &#39564;&#35777;&#32467;&#26524;</span>
[root@centos7 ~]#tree --version
tree v8.8.8 (c) 1996 - 2018 by Steve Baker, Thomas Moore, Francesc Rocher,
Florian Sesser, Kyosuke Tokoro

<span style="color: #b22222;">#</span><span style="color: #b22222;">10 &#28155;&#21152;man&#24110;&#21161;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#26080;&#27861;&#26597;&#30475;man</span>
[root@centos7 ~]#man tree
No manual entry for tree
[root@centos7 ~]#vim /etc/man_db.conf
MANDATORY_MANPATH      /apps/tree/man 
[root@centos7 ~]#man tree

<span style="color: #b22222;">#</span><span style="color: #b22222;">11 &#36816;&#34892;tree&#26597;&#30475;&#29983;&#25104;&#30340;&#25991;&#20214;&#21015;&#34920;</span>
[root@centos7 ~]#tree /apps/tree
/apps/tree
&#9500;&#9472;&#9472; bin
&#9474;  &#9492;&#9472;&#9472; tree
&#9492;&#9472;&#9472; man
 &#9492;&#9472;&#9472; man1
   &#9492;&#9472;&#9472; tree.1
3 directories, 2 files
</pre>
</div>

<p>
范例：CentOS 8 编译安装 黑客帝国代码雨cmatrix
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1 &#23433;&#35013;&#30456;&#20851;&#21253;</span>
[root@centos8 ~]#dnf install gcc make autoconf ncurses-devel

<span style="color: #b22222;">#</span><span style="color: #b22222;">2 &#19979;&#36733;&#24182;&#35299;&#21387;&#32553;&#21253;</span>
<span style="color: #483d8b;">cd</span> /usr/local/src
wget https://github.com/abishekvashok/cmatrix/releases/download/v2.0/cmatrix-v2.0-Butterscotch.tar
tar xvf cmatrix-v2.0-Butterscotch.tar

<span style="color: #b22222;">#</span><span style="color: #b22222;">3 &#37197;&#32622;</span>
<span style="color: #483d8b;">cd</span> cmatrix
./configure --prefix=/apps/cmatrix

<span style="color: #b22222;">#</span><span style="color: #b22222;">4 &#32534;&#35793;&#24182;&#23433;&#35013;</span>
make &amp;&amp; make install

<span style="color: #b22222;">#</span><span style="color: #b22222;">5 &#37197;&#32622;&#29615;&#22659;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'PATH=/apps/cmatrix/bin:$PATH'</span> &gt; /etc/profile.d/cmatrix.sh
<span style="color: #483d8b;">.</span> /etc/profile.d/cmatrix.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#29992;&#36719;&#38142;&#25509;&#23454;&#29616;</span>
[root@centos8 ~]#ln -sv /apps/cmatrix/bin/cmatrix /usr/local/bin/

<span style="color: #b22222;">#</span><span style="color: #b22222;">6&#36816;&#34892;</span>
cmatrix -a -b -C yellow

7#&#24110;&#21161;
[root@centos8 ~]#vim /etc/man_db.conf
MANDATORY_MANPATH            /apps/cmatrix/share/man
[root@centos8 ~]#man cmatrix
</pre>
</div>


<figure id="org573918b">
<img src="images/image-20210216014607145.png" alt="image-20210216014607145.png" width="80%">

</figure>

<p>
范例：centos8 编译安装 httpd-2.4.43
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#21069;&#20934;&#22791;&#65306;&#20851;&#38381;&#38450;&#28779;&#22681;&#21644;SELinux</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">1 &#23433;&#35013;&#21253;</span>
[root@centos8 ~]#dnf install gcc make apr-devel apr-util-devel pcre-devel openssl-devel redhat-rpm-config

<span style="color: #b22222;">#</span><span style="color: #b22222;">2 &#19979;&#36733;&#24182;&#35299;&#21387;&#32553;&#21253;</span>
[root@centos8 ~]#tar xvf httpd-2.4.43.tar.bz2 -C /usr/local/src

<span style="color: #b22222;">#</span><span style="color: #b22222;">3 &#37197;&#32622;</span>
[root@centos8 ~]#cd /usr/local/src/httpd-2.4.43/
[root@centos8 httpd-2.4.43]#./configure --prefix=/apps/httpd24 --sysconfdir=/etc/httpd24 --enable-ssl

<span style="color: #b22222;">#</span><span style="color: #b22222;">4 &#32534;&#35793;&#24182;&#23433;&#35013;</span>
[root@centos8 httpd-2.4.43]#make -j 4 &amp;&amp; make install

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25253;&#38169;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32570;&#23569;&#25991;&#20214;&#65292; yum provides */filename  #&#26816;&#26597;&#25991;&#20214;&#20381;&#36182;&#21738;&#20010;&#21253;</span>
yum provides autoheader  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#31243;&#24207;&#20381;&#36182;&#21738;&#20010;&#21253;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">APR Not find &#65292; &#20687;&#36825;&#31181;&#27809;&#26377;&#21457;&#29616;&#19968;&#33324;&#37117;&#32570;&#23569;&#24320;&#21457;&#21253;&#65292; yum install apr-devel</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">5 &#37197;&#32622;&#29615;&#22659;</span>
[root@centos8 ~]#echo <span style="color: #8b2252;">'PATH=/apps/httpd24/bin:$PATH'</span> &gt; /etc/profile.d/httpd24.sh
[root@centos8 ~]#. /etc/profile.d/httpd24.sh

<span style="color: #b22222;">#</span><span style="color: #b22222;">6&#36816;&#34892;</span>
[root@centos8 ~]#apachectl

<span style="color: #b22222;">#</span><span style="color: #b22222;">7 &#25351;&#23450;&#29992;apache&#29992;&#25143;&#36816;&#34892;</span>
[root@centos8 ~]#useradd -r -s /sbin/nologin -d /var/www -c Apache -u 48 apache
[root@centos8 ~]#vim /etc/httpd24/httpd.conf
user apache
group apache

<span style="color: #b22222;">#</span><span style="color: #b22222;">7&#29983;&#25928;&#21644;&#39564;&#35777;</span>
[root@centos8 ~]#apachectl restart
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;</span>
[root@centos8 ~]#ps aux
</pre>
</div>

<p>
演示：编译安装apache2.4
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1&#12289;&#26356;&#26032;yum&#28304;</span>
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo

<span style="color: #b22222;">#</span><span style="color: #b22222;">2&#12289;&#23433;&#35013;gcc</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#26597;&#26159;&#21542;&#23433;&#35013;gcc:rpm -qa gcc</span>
yum install -y gcc

<span style="color: #b22222;">#</span><span style="color: #b22222;">3&#12289;&#19979;&#36733;httpd&#26381;&#21153;,&#29256;&#26412;&#21495;2.4.18</span>
wget http://olex.openlogic.com/package_versions/28219/download?<span style="color: #a0522d;">package_version_id</span>=105155&amp;<span style="color: #a0522d;">path</span>=https%3A%2F%2Folex-secure.openlogic.com%2Fcontent%2Fopenlogic%2Fapache%2F2.4.18%2Fhttpd-2.4.18.tar.bz2


<span style="color: #b22222;">#</span><span style="color: #b22222;">4&#12289;&#35299;&#21387;http&#28304;&#30721;&#21253;</span>
tar xf httpd-2.4.18.tar.bz2
<span style="color: #483d8b;">cd</span>  httpd-2.4.18/
more INSTALL
     $ ./configure --prefix=PREFIX
     $ make
     $ make install
     $ PREFIX/bin/apachectl start


<span style="color: #b22222;">#</span><span style="color: #b22222;">5&#12289;&#36890;&#36807;./configure &#36319;&#29305;&#23450;&#38656;&#35201;&#30340;&#36873;&#25321;&#36890;&#36807;Makefile.in&#24320;&#22987;&#26500;&#24314;&#29983;&#20135;makefile&#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35299;&#20915;&#20381;&#36182;&#38382;&#39064;&#65306;&#24403;&#28982;&#20063;&#21487;&#20197;&#30452;&#25509;&#23433;&#35013;&#24320;&#21457;&#21253;&#32452;&#26469;&#35299;&#20915;</span>
yum install  -y pcre-devel apr*
./configure --prefix=/usr/local/apache2 --sysconfdir=/etc/httpd2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32570;&#23569;&#20381;&#36182;&#21253;&#25253;&#38169;&#65306;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">configure: error: APR not found.</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">configure: error: pcre-config for libpcre not found</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">6&#12289;make&#36890;&#36807;&#29983;&#25104;&#30340;makefile&#25991;&#20214;&#35843;&#29992;&#39044;&#22788;&#29702;&#22120;&#65292;&#32534;&#35793;&#22120;&#31561;&#24320;&#22987;&#32534;&#35793;&#23433;&#35013;&#31243;&#24207;&#21253;</span>
make

<span style="color: #b22222;"># </span><span style="color: #b22222;">7&#12289;make install&#65306;&#25226;&#20108;&#36827;&#21046;&#25991;&#20214;&#12289;&#24211;&#25991;&#20214;&#12289;&#37197;&#32622;&#25991;&#20214;&#12289;&#24110;&#21161;&#25991;&#20214;&#22797;&#21046;&#21040;&#23545;&#24212;&#30340;&#30446;&#24405;&#20013;</span>
make install

<span style="color: #b22222;">#</span><span style="color: #b22222;">8&#12289;&#23433;&#35013;&#21518;&#30340;&#37197;&#32622;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#23450;&#20041;&#32534;&#35793;&#23433;&#35013;&#20043;&#21518;&#65292;&#23558;&#20854;&#25972;&#20307;&#23433;&#35013;&#22312;&#20102;/usr/local/*&#25991;&#20214;&#19979;&#65292;&#21368;&#36733;&#26102;&#21482;&#38656;&#21024;&#38500;&#35813;&#25991;&#20214;&#22841;&#21363;&#21487;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20294;&#26159;&#65292;&#27492;&#26102;&#31995;&#32479;&#36335;&#24452;&#26159;&#26080;&#27861;&#35835;&#21462;&#35813;&#37197;&#32622;&#25991;&#20214;&#30340;&#65292;&#25152;&#20197;&#26381;&#21153;&#21487;&#33021;&#26080;&#27861;&#21551;&#21160;&#65292;&#38656;&#35201;&#37197;&#32622;&#20854;&#37096;&#20998;&#25991;&#20214;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">(1) &#23548;&#20986;&#20108;&#36827;&#21046;&#31243;&#24207;&#30446;&#24405;&#33267;PATH&#29615;&#22659;&#21464;&#37327;&#20013;&#65307;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#36753;&#25991;&#20214;/etc/profile.d/NAME.sh</span>
[root@localhost httpd2]# cat /etc/profile.d/path_httpd.sh
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">PATH</span>=/usr/local/apache2/bin:$<span style="color: #a0522d;">PATH</span>
[root@localhost httpd2]# . /etc/profile

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#65306;bin&#36335;&#24452;&#30340;&#25918;&#22312;&#21069;&#38754;&#31995;&#32479;&#22312;&#35835;&#21462;&#37197;&#32622;&#25991;&#20214;&#30340;&#26102;&#20505;&#20250;&#25353;&#29031;&#33258;&#24038;&#21521;&#21491;&#30340;&#39034;&#24207;&#35835;&#21462;</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">(2) &#23548;&#20986;&#24211;&#25991;&#20214;&#36335;&#24452;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#36753;/etc/ld.so.conf.d/NAME.conf   &#28155;&#21152;&#26032;&#30340;&#24211;&#25991;&#20214;&#25152;&#22312;&#30446;&#24405;&#33267;&#27492;&#25991;&#20214;&#20013;&#65307;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35753;&#31995;&#32479;&#37325;&#26032;&#29983;&#25104;&#32531;&#23384;&#65306;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ldconfig [-v]  #&#35201;&#26174;&#31034;&#36807;&#31243;&#23601;&#21152;-v&#36873;&#39033;</span>

[root@localhost httpd-2.4.18]# cat /etc/ld.so.conf.d/apache2.conf
/usr/local/apache2/lib
[root@localhost httpd-2.4.18]# ldconfig

<span style="color: #b22222;">#</span><span style="color: #b22222;">(3) &#23548;&#20986;&#22836;&#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110;&#38142;&#25509;&#30340;&#26041;&#24335;&#23454;&#29616;&#65292;&#23548;&#20986;&#25972;&#20010;&#30446;&#24405;&#20026;&#19968;&#20010;&#36830;&#25509;&#25991;&#20214;&#65307;ln -sv</span>

[root@localhost apache2]# ln -sv /usr/local/apache2/include/  /usr/include/http2
&#8216;/usr/include/http2&#8217; -&gt; &#8216;/usr/local/apache2/include/&#8217;
[root@localhost apache2]# ls -l /usr/include/http2
lrwxrwxrwx. 1 root root 27 Dec 26 18:01 /usr/include/http2 -&gt; /usr/local/apache2/include/


<span style="color: #b22222;">#</span><span style="color: #b22222;">(4) &#23548;&#20986;&#24110;&#21161;&#25163;&#20876;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#36753; /etc/man_db.conf  &#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#19968;&#20010;MANPATH</span>

[root@localhost apache2]# grep -B5 apache  /etc/man_db.conf
<span style="color: #b22222;">#</span><span style="color: #b22222;">MANDATORY_MANPATH             /usr/src/pvm3/man</span>
<span style="color: #b22222;">#</span>
MANDATORY_MANPATH            /usr/man
MANDATORY_MANPATH            /usr/share/man
MANDATORY_MANPATH            /usr/local/share/man
MANDATORY_MANPATH            /usr/local/apache2/man
[root@localhost man]# man httpd

<span style="color: #b22222;">#</span><span style="color: #b22222;">9&#12289;&#21551;&#21160;&#26381;&#21153;</span>
[root@localhost man]# apachectl start
AH00558: httpd: Could not reliably determine the server<span style="color: #8b2252;">'s fully qualified domain name, using localhost.localdomain. Set the '</span>ServerName<span style="color: #8b2252;">' directive globally to suppress this message</span>

<span style="color: #8b2252;">[root@localhost man]# ss -lntp | grep 80</span>
<span style="color: #8b2252;">LISTEN     0      128                      :::80                      :::*      users:(("httpd",23704,4),("httpd",23697,4),("httpd",23696,4),("httpd",23695,4))</span>
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:4b3e2142-78a3-4377-8161-6562169c891f" class="outline-2">
<h2 id="h:4b3e2142-78a3-4377-8161-6562169c891f">Ubuntu 软件管理</h2>
<div class="outline-text-2" id="text-h:4b3e2142-78a3-4377-8161-6562169c891f">
<p>
Debian软件包通常为预编译的二进制格式的扩展名”.deb”，类似rpm文件，因
此安装快速，无需编译软件。包文件包括特定功能或软件所必需的文件、元数据
和指令
</p>

<ul class="org-ul">
<li>dpkg：package manager for Debian，类似于rpm，dpkg是基于Debian的系统
的包管理器。可以安装，删除和构建软件包，但无法自动下载和安装软件包或
其依赖项</li>
<li>apt：Advanced Packaging Tool，功能强大的软件管理工具，甚至可升级整个
Ubuntu的系统，基于客户/服务器架构，类似于yum</li>
</ul>
</div>
<div id="outline-container-h:643f7863-e72b-4023-8f8c-5bbfa5f6918e" class="outline-3">
<h3 id="h:643f7863-e72b-4023-8f8c-5bbfa5f6918e">APT工作原理</h3>
<div class="outline-text-3" id="text-h:643f7863-e72b-4023-8f8c-5bbfa5f6918e">
<p>
在服务器上先复制所有DEB包，然后用APT的分析工具genbasedir根据每个DEB包
的包头（Header）信息对所有的DEB包进行分析，并将该分析结果记录在文件夹
base内的一个DEB索引清单文件中，一旦APT服务器内的DEB有所变动，要使用
genbasedir产生新的DEB索引清单。客户端在进行安装或升级时先要查询DEB索引
清单，从而获知所有具有依赖关系的软件包，并一同下载到客户端以便安装。当
客户端需要安装、升级或删除某个软件包时，客户端计算机取得DEB索引清单压
缩文件后，会将其解压置放于/var/cache/apt/，而客户端使用apt-get install
或apt-get upgrade命令的时候，就会将这个文件夹内的数据和客户端计算机内
的DEB数据库比对，知道哪些DEB已安装、未安装或是可以升级的
</p>
</div>
</div>
<div id="outline-container-h:da743a3f-8cc6-4931-90b8-6c0820731b2f" class="outline-3">
<h3 id="h:da743a3f-8cc6-4931-90b8-6c0820731b2f">dpkg 包管理器</h3>
<div class="outline-text-3" id="text-h:da743a3f-8cc6-4931-90b8-6c0820731b2f">
<p>
帮助参看：man dpkg dpkg 常见用法
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#21253;, &#19981;&#25903;&#25345;&#21253;&#20381;&#36182;</span>
dpkg -i package.deb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#21253;&#65292;&#19981;&#24314;&#35758;&#65292;&#19981;&#33258;&#21160;&#21368;&#36733;&#20381;&#36182;&#20110;&#23427;&#30340;&#21253;</span>
dpkg -r package

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#21253;&#65288;&#21253;&#25324;&#37197;&#32622;&#25991;&#20214;&#65289;</span>
dpkg -P package

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#24403;&#21069;&#24050;&#23433;&#35013;&#30340;&#21253;&#65292;&#31867;&#20284;rpm -qa</span>
dpkg -l

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#35813;&#21253;&#30340;&#31616;&#35201;&#35828;&#26126;&#65292;&#31867;&#20284;rpm &#8211;qi</span>
dpkg -l package

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#35813;&#21253;&#30340;&#29366;&#24577;&#65292;&#21253;&#25324;&#35814;&#32454;&#20449;&#24687;&#65292;&#31867;&#20284;rpm &#8211;qi</span>
dpkg -s package

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#35813;&#21253;&#20013;&#25152;&#21253;&#21547;&#30340;&#25991;&#20214;&#65292;&#31867;&#20284;rpm &#8211;ql</span>
dpkg -L package

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25628;&#32034;&#21253;&#21547;pattern&#30340;&#21253;&#65292;&#31867;&#20284;rpm &#8211;qf</span>
dpkg -S &lt;pattern&gt;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#21253;&#65292;-a &#20351;&#29992;&#65292;&#37197;&#32622;&#25152;&#26377;&#27809;&#26377;&#37197;&#32622;&#30340;&#36719;&#20214;&#21253;</span>
dpkg --configure package

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986; deb &#21253;&#30340;&#20869;&#23481;&#65292;&#31867;&#20284;rpm &#8211;qpl</span>
dpkg -c package.deb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35299;&#24320; deb &#21253;&#30340;&#20869;&#23481;</span>
dpkg --unpack package.deb
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#31995;&#32479;&#19978;&#23433;&#35013;&#30340;&#25152;&#26377;&#36719;&#20214;&#21253;</span>
dpkg -l

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#36719;&#20214;&#21253;&#23433;&#35013;&#30340;&#25991;&#20214;</span>
dpkg -L bash

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;/bin/bash&#26469;&#33258;&#20110;&#21738;&#20010;&#36719;&#20214;&#21253;</span>
dpkg -S /bin/bash

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#26412;&#22320;&#30340; .deb &#25991;&#20214;</span>
dpkg -i /mnt/cdrom/pool/main/z/zip/zip_3.0-11build1_amd64.deb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21368;&#36733;&#36719;&#20214;&#21253;</span>
dpkg -r zip
</pre>
</div>

<p>
注意：一般建议不要使用dpkg卸载软件包。因为删除包时，其它依赖它的包不会
卸载，并且可能无法再正常运行
</p>
</div>
</div>
<div id="outline-container-h:49de8721-b2df-4089-a65e-eb1c700e1d30" class="outline-3">
<h3 id="h:49de8721-b2df-4089-a65e-eb1c700e1d30">apt</h3>
<div class="outline-text-3" id="text-h:49de8721-b2df-4089-a65e-eb1c700e1d30">
<p>
Debian 使用apt 工具集来管理包系统，apt-get是其中一个常用的命令行工具，
另外一款较为流行的命令行与 GUI 兼顾的工具是aptitude ，之前最常用的
Linux 包管理命令都被分散在了 apt-get、apt-cache和 apt-config 这三条命
令中
</p>

<p>
在 2014 年apt 命令发布第一个稳定版，Ubuntu 16.04 引入新特性之一便是
apt命令，apt 命令解决了命令过于分散的问题，它包括 apt-get命令出现以来
使用最广泛的功能选项，以及 apt-cache 和 apt-config命令中很少用到的功能。
在使用 apt 命令时，用户不必再由 apt-get 转到apt-cache 或 apt-config，
提供管理软件包所需的必要选项
</p>

<p>
apt 相当于 apt-get、apt-cache 和 apt-config 中最常用命令选项的集合
</p>

<p>
apt具有更精减但足够的命令选项，而且参数选项的组织方式更为有效。此外，
启用的几个特性也非常有帮助。例如：可以在使用apt 命令安装或删除程序时看
到进度条,apt还会在更新存储库数据库时提示用户可升级的软件包个数
</p>

<p>
apt 与 apt-get 有一些类似的命令选项，但它并不能完全向下兼容 apt-get命
令,也即可用 apt 替换部分apt-get 系列命令，但不是全部apt 命令用法
</p>

<p>
查看帮助：apt help
</p>

<p>
<b>apt与apt-get命令对比</b>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">apt 命令</td>
<td class="org-left">被取代的命令</td>
<td class="org-left">命令的功能</td>
</tr>

<tr>
<td class="org-left">apt install</td>
<td class="org-left">apt-get install</td>
<td class="org-left">安装软件包</td>
</tr>

<tr>
<td class="org-left">apt remove</td>
<td class="org-left">apt-get remove</td>
<td class="org-left">移除软件包</td>
</tr>

<tr>
<td class="org-left">apt purge</td>
<td class="org-left">apt-get purge</td>
<td class="org-left">移除软件包及配置文件</td>
</tr>

<tr>
<td class="org-left">apt update</td>
<td class="org-left">apt-get update</td>
<td class="org-left">刷新存储库索引</td>
</tr>

<tr>
<td class="org-left">apt upgrade</td>
<td class="org-left">apt-get upgrade</td>
<td class="org-left">升级所有可升级的软件包</td>
</tr>

<tr>
<td class="org-left">apt autoremove</td>
<td class="org-left">apt-get autoremove</td>
<td class="org-left">自动删除不需要的包</td>
</tr>

<tr>
<td class="org-left">apt full-upgrade</td>
<td class="org-left">apt-get dist-upgrade</td>
<td class="org-left">在升级软件包时自动处理依赖关系</td>
</tr>

<tr>
<td class="org-left">apt search</td>
<td class="org-left">apt-cache search</td>
<td class="org-left">搜索应用程序</td>
</tr>

<tr>
<td class="org-left">apt show</td>
<td class="org-left">apt-cache show</td>
<td class="org-left">显示安装细节</td>
</tr>
</tbody>
</table>

<p>
apt 特有的命令
</p>
<div class="org-src-container">
<pre class="src src-sh">apt list                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#21253;&#21547;&#26465;&#20214;&#30340;&#21253;&#65288;&#24050;&#23433;&#35013;&#65292;&#21487;&#21319;&#32423;&#31561;&#65289;</span>
apt edit-sources  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#36753;&#28304;&#21015;&#34920;</span>
</pre>
</div>

<p>
APT包索引配置文件
</p>
<div class="org-src-container">
<pre class="src src-sh">/etc/apt/sources.list
/etc/apt/sources.list.d
</pre>
</div>

<p>
可以修改上面文件为国内的安装源，提高速度
参考链接：<a href="https://developer.aliyun.com/mirror/ubuntu">https://developer.aliyun.com/mirror/ubuntu</a>
</p>

<p>
apt命令操作（如安装和删除软件包）日志文件
</p>

<div class="org-src-container">
<pre class="src src-sh">/var/log/dpkg.log
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#21253;&#65306;</span>
apt install tree zip
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#22270;&#24418;&#26700;&#38754;</span>
apt install ubuntu-desktop

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#21253;&#65306;</span>
apt remove tree zip
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35828;&#26126;&#65306;apt remove&#20013;&#28155;&#21152;--purge&#36873;&#39033;&#20250;&#21024;&#38500;&#21253;&#37197;&#32622;&#25991;&#20214;&#65292;&#35880;&#24910;&#20351;&#29992;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26356;&#26032;&#21253;&#32034;&#24341;&#65292;&#30456;&#24403;&#20110;yum clean all;yum makecache</span>
apt update 
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21319;&#32423;&#21253;&#65306;&#35201;&#21319;&#32423;&#31995;&#32479;&#65292;&#35831;&#39318;&#20808;&#26356;&#26032;&#36719;&#20214;&#21253;&#32034;&#24341;&#65292;&#20877;&#21319;&#32423;</span>
apt upgrade

<span style="color: #b22222;">#</span><span style="color: #b22222;">apt&#21015;&#20986;&#20179;&#24211;&#36719;&#20214;&#21253;&#65292;&#31561;&#20110;yum list</span>
apt list

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25628;&#32034;&#23433;&#35013;&#21253;</span>
apt search nginx
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26576;&#20010;&#23433;&#35013;&#21253;&#30340;&#35814;&#32454;&#20449;&#24687;</span>
apt show apache2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#32447;&#23433;&#35013;&#36719;&#20214;&#21253;</span>
apt install apache2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21368;&#36733;&#21333;&#20010;&#36719;&#20214;&#21253;&#20294;&#26159;&#20445;&#30041;&#37197;&#32622;&#12098;&#20214;</span>
apt remove apache2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#23433;&#35013;&#21253;&#24182;&#35299;&#20915;&#20381;&#36182;&#20851;&#31995;</span>
apt autoremove apache2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26356;&#26032;&#26412;&#22320;&#36719;&#20214;&#21253;&#21015;&#34920;&#32034;&#24341;&#65292;&#20462;&#25913;&#20102;apt&#20179;&#24211;&#21518;&#24517;&#39035;&#25191;&#12175;</span>
apt update

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21368;&#36733;&#21333;&#20010;&#36719;&#20214;&#21253;&#21024;&#38500;&#37197;&#32622;&#12098;&#20214;</span>
apt purge apache2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21319;&#32423;&#25152;&#26377;&#24050;&#23433;&#35013;&#19988;&#21487;&#21319;&#32423;&#21040;&#26032;&#29256;&#26412;&#30340;&#36719;&#20214;&#21253;</span>
apt upgrade

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21319;&#32423;&#25972;&#20010;&#31995;&#32479;&#65292;&#24517;&#35201;&#26102;&#21487;&#20197;&#31227;&#38500;&#26087;&#36719;&#20214;&#21253;&#12290;</span>
apt full-upgrade

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#36753;source&#28304;&#12098;&#20214;</span>
apt edit-sources

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20179;&#24211;&#20013;&#36719;&#20214;&#21253;&#26377;&#21738;&#20123;&#29256;&#26412;&#21487;&#20197;&#23433;&#35013;</span>
apt-cache madison nginx

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#36719;&#20214;&#21253;&#30340;&#26102;&#20505;&#25351;&#23450;&#23433;&#35013;&#20855;&#20307;&#30340;&#29256;&#26412;</span>
apt install <span style="color: #a0522d;">nginx</span>=1.14.0-0ubuntu1.6

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25991;&#20214;&#26469;&#33258;&#21738;&#20010;&#21253;&#65292;&#31867;&#20284;&#20110;yum provides filename</span>
apt install apt-file
apt-file search <span style="color: #8b2252;">'string'</span>   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#26159;&#21253;&#21547;&#27492;&#23383;&#31526;&#20018;&#30340;&#25991;&#20214;</span>
apt-file search -x <span style="color: #8b2252;">'&#27491;&#21017;&#34920;&#36798;&#24335;'</span>
apt-file search -F /path/file
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b78fb7e2-f822-4cc3-9092-f15e593aa560" class="outline-3">
<h3 id="h:b78fb7e2-f822-4cc3-9092-f15e593aa560">软件管理案例</h3>
<div class="outline-text-3" id="text-h:b78fb7e2-f822-4cc3-9092-f15e593aa560">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#31995;&#32479;&#23433;&#35013;&#21253;&#30340;&#32479;&#35745;&#20449;&#24687;,&#21487;&#20197;&#32479;&#35745;&#24050;&#32463;&#23433;&#35013;&#21253;&#30340;&#25968;&#37327;&#65292;&#22823;&#23567;&#65292;&#21344;&#29992;&#31354;&#38388;&#31561;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">apt-cache stats</span>

[root@ubuntu1804 ~]#apt-cache stats
Total package names: 84873 (1,697 k)
Total package structures: 126998 (5,588 k)
Normal packages: 91623
Pure virtual packages: 2648
Single virtual packages: 10275
Mixed virtual packages: 5110
Missing: 17342
Total distinct versions: 115114 (9,209 k)
Total distinct descriptions: 182818 (4,388 k)
Total dependencies: 905746/262881 (22.3 M)
Total ver/file relations: 39954 (959 k)
Total Desc/File relations: 51746 (1,242 k)
Total Provides mappings: 44540 (1,069 k)
Total globbed strings: 188808 (4,354 k)
Total slack space: 25.8 k
Total space accounted for: 51.3 M
Total buckets<span style="color: #a020f0;"> in</span> PkgHashTable: 50503
Unused: 9337
Used: 41166
Utilization: 81.512%
Average entries: 3.08502
Longest: 60
Shortest: 1
Total buckets<span style="color: #a020f0;"> in</span> GrpHashTable: 50503
Unused: 9337
Used: 41166
Utilization: 81.512%
Average entries: 2.06173
Longest: 12
Shortest: 1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;xxx&#21253;&#30340;&#20449;&#24687;,&#21487;&#20197;&#30475;&#21040;&#26576;&#20010;&#21253;&#30340;&#28304;&#12289;&#29256;&#26412;&#31561;&#20449;&#24687;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">apt-cache show xxx #&#26356;&#35814;&#32454;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">apt show xxx</span>
[root@ubuntu1804 ~]#apt show keepalived
Package: keepalived
Version: 1:1.3.9-1ubuntu0.18.04.2
Priority: optional
Section: admin
Origin: Ubuntu
Maintainer: Ubuntu Developers <a href="mailto:ubuntu-devel-discuss%40lists.ubuntu.com">&lt;ubuntu-devel-discuss@lists.ubuntu.com&gt;</a>
Original-Maintainer: Alexander Wirt <a href="mailto:formorer%40debian.org">&lt;formorer@debian.org&gt;</a>
Bugs: https://bugs.launchpad.net/ubuntu/+filebug
Installed-Size: 844 kB
Depends: iproute2, libc6 (&gt;= 2.27), libglib2.0-0 (&gt;= 2.26.0), libip4tc0 (&gt;=
1.6.0+snapshot20161117), libip6tc0 (&gt;= 1.6.0+snapshot20161117), libnl-3-200 (&gt;=
3.2.27), libnl-genl-3-200 (&gt;= 3.2.7), libnl-route-3-200 (&gt;= 3.2.7), libsnmp30
(&gt;= 5.7.3+dfsg-1.8ubuntu3.1~dfsg), libssl1.1 (&gt;= 1.1.0), libxtables12 (&gt;=
1.6.0+snapshot20161117)
Recommends: ipvsadm
Homepage: http://keepalived.org
Supported: 5y
Download-Size: 244 kB
APT-Manual-Installed: yes
APT-Sources: http://mirrors.aliyun.com/ubuntu bionic-security/main amd64
Packages
Description: Failover and monitoring daemon for LVS clusters
keepalived is used for monitoring real servers within a Linux
Virtual Server (LVS) cluster. keepalived can be configured to
remove real servers from the cluster pool if it stops responding,
as well as send a notification email to make the admin aware of
the service failure.
<span style="color: #483d8b;">.</span>
In addition, keepalived implements an independent Virtual Router
Redundancy Protocol (VRRPv2; see rfc2338 for additional info)
framework for director failover.
<span style="color: #483d8b;">.</span>
You need a kernel &gt;= 2.4.28 or &gt;= 2.6.11 for keepalived.
See README.Debian for more information.
N: There is 1 additional record. Please use the <span style="color: #8b2252;">'-a'</span> switch to see it

[root@ubuntu1804 ~]#apt-cache show keepalived
Package: keepalived
Architecture: amd64
Version: 1:1.3.9-1ubuntu0.18.04.2
Priority: optional
Section: admin
Origin: Ubuntu
Maintainer: Ubuntu Developers <a href="mailto:ubuntu-devel-discuss%40lists.ubuntu.com">&lt;ubuntu-devel-discuss@lists.ubuntu.com&gt;</a>
Original-Maintainer: Alexander Wirt <a href="mailto:formorer%40debian.org">&lt;formorer@debian.org&gt;</a>
Bugs: https://bugs.launchpad.net/ubuntu/+filebug
Installed-Size: 824
Depends: iproute2, libc6 (&gt;= 2.27), libglib2.0-0 (&gt;= 2.26.0), libip4tc0 (&gt;=
1.6.0+snapshot20161117), libip6tc0 (&gt;= 1.6.0+snapshot20161117), libnl-3-200 (&gt;=
3.2.27), libnl-genl-3-200 (&gt;= 3.2.7), libnl-route-3-200 (&gt;= 3.2.7), libsnmp30
(&gt;= 5.7.3+dfsg-1.8ubuntu3.1~dfsg), libssl1.1 (&gt;= 1.1.0), libxtables12 (&gt;=
1.6.0+snapshot20161117)
Recommends: ipvsadm
Filename: pool/main/k/keepalived/keepalived_1.3.9-1ubuntu0.18.04.2_amd64.deb
Size: 243520
MD5sum: 27586893f35660b2a130f344c4b7fcff
SHA1: 36b232cb39ff9179e7197d02c0bd252e32543e97
SHA256: fedef32d748fd4c5180531d1076b254f4705b46523ed61d51eb789f2441dfd56
Homepage: http://keepalived.org
Description-en: Failover and monitoring daemon for LVS clusters
keepalived is used for monitoring real servers within a Linux
Virtual Server (LVS) cluster. keepalived can be configured to
remove real servers from the cluster pool if it stops responding,
as well as send a notification email to make the admin aware of
the service failure.
<span style="color: #483d8b;">.</span>
In addition, keepalived implements an independent Virtual Router
Redundancy Protocol (VRRPv2; see rfc2338 for additional info)
framework for director failover.
<span style="color: #483d8b;">.</span>
You need a kernel &gt;= 2.4.28 or &gt;= 2.6.11 for keepalived.
See README.Debian for more information.
Description-md5: e2d2506352721e77c2c351de4714ddd6
Supported: 5y
Package: keepalived
Architecture: amd64
Version: 1:1.3.9-1build1
Priority: optional
Section: admin
Origin: Ubuntu
Maintainer: Ubuntu Developers <a href="mailto:ubuntu-devel-discuss%40lists.ubuntu.com">&lt;ubuntu-devel-discuss@lists.ubuntu.com&gt;</a>
Original-Maintainer: Alexander Wirt <a href="mailto:formorer%40debian.org">&lt;formorer@debian.org&gt;</a>
Bugs: https://bugs.launchpad.net/ubuntu/+filebug
Installed-Size: 824
Depends: iproute2, libc6 (&gt;= 2.17), libglib2.0-0 (&gt;= 2.26.0), libip4tc0 (&gt;=
1.6.0+snapshot20161117), libip6tc0 (&gt;= 1.6.0+snapshot20161117), libnl-3-200 (&gt;=
3.2.27), libnl-genl-3-200 (&gt;= 3.2.7), libnl-route-3-200 (&gt;= 3.2.7), libsnmp30
(&gt;= 5.7.3+dfsg-1.8ubuntu1~dfsg), libssl1.1 (&gt;= 1.1.0), libxtables12 (&gt;=
1.6.0+snapshot20161117)
Recommends: ipvsadm
Filename: pool/main/k/keepalived/keepalived_1.3.9-1build1_amd64.deb
Size: 243368
MD5sum: 9998fcf3c2769effd8664b838f144bd6
SHA1: 1f22181adff9f47fdd9b08691817df4ac5d486bc
SHA256: 3d72f7e6cd09b7b903faf07c06c3c0d0883a33648a9e33af27b1909aeaf2b77f
Homepage: http://keepalived.org
Description-en: Failover and monitoring daemon for LVS clusters
keepalived is used for monitoring real servers within a Linux
Virtual Server (LVS) cluster. keepalived can be configured to
remove real servers from the cluster pool if it stops responding,
as well as send a notification email to make the admin aware of
the service failure.
<span style="color: #483d8b;">.</span>
In addition, keepalived implements an independent Virtual Router
Redundancy Protocol (VRRPv2; see rfc2338 for additional info)
framework for director failover.
<span style="color: #483d8b;">.</span>
You need a kernel &gt;= 2.4.28 or &gt;= 2.6.11 for keepalived.
See README.Debian for more information.
Description-md5: e2d2506352721e77c2c351de4714ddd6
Supported: 5y

[root@ubuntu1804 ~]#

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#25214;&#25991;&#20214;&#23646;&#20110;&#21738;&#20010;&#21253;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">dpkg -S filename &#65306;&#22312;&#24403;&#21069;&#23433;&#35013;&#30340;&#21253;&#37324;&#26597;&#25214;&#25991;&#20214;</span>

[root@ubuntu1804 ~]#dpkg -S /bin/ls
coreutils: /bin/ls

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#25152;&#26377;&#28304;&#21253;&#37324;&#26597;&#25214;&#25991;&#20214;&#12290;&#65288;&#21253;&#21547;&#26410;&#23433;&#35013;&#30340;&#21253;&#65289;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">apt-file search filename</span>
[root@ubuntu1804 ~]#apt search /bin/tree
Sorting... Done
Full Text Search... Done

[root@ubuntu1804 ~]#apt -y install apt-file
[root@ubuntu1804 ~]#apt-flle upate
[root@ubuntu1804 ~]#apt-file search /bin/tree
arb: /usr/lib/arb/bin/treedist
asp.net-examples: /usr/share/asp.net-demos/bin/treeview.dll
beast-mcmc: /usr/bin/treeannotator
beast-mcmc: /usr/bin/treestat
beast2-mcmc: /usr/bin/treeannotator2
blimps-utils: /usr/share/doc/blimps-utils/html/bin/tree.csh
dosemu: /usr/lib/dosemu/drive_z/bin/tree.com
fastdnaml: /usr/lib/fastdnaml/bin/treefile
fastdnaml: /usr/lib/fastdnaml/bin/treefile2prolog
fastdnaml: /usr/lib/fastdnaml/bin/trees2NEXUS
fastdnaml: /usr/lib/fastdnaml/bin/trees2prolog
phast: /usr/bin/treeGen
phast: /usr/bin/tree_doctor
phylip: /usr/lib/phylip/bin/treedist
prime-phylo: /usr/bin/tree2leafnames
prime-phylo: /usr/bin/treesize
qiime: /usr/lib/qiime/bin/tree_compare.py
seqan-apps: /usr/bin/tree_recon
seqan-apps: /usr/lib/seqan/bin/tree_recon
tree: /usr/bin/tree
tree-ppuzzle: /usr/bin/tree-ppuzzle
tree-puzzle: /usr/bin/tree-puzzle
treeline: /usr/bin/treeline
treesheets: /usr/bin/treesheets
treeview: /usr/bin/treeview
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#36719;&#20214;xxx&#20381;&#36182;&#21738;&#20123;&#21253;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">apt  depends xxx</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">apt-cache depends xxx</span>
[root@ubuntu1804 ~]#apt depends keepalived
keepalived
Depends: iproute2
 iproute2:i386
Depends: libc6 (&gt;= 2.27)
Depends: libglib2.0-0 (&gt;= 2.26.0)
Depends: libip4tc0 (&gt;= 1.6.0+snapshot20161117)
Depends: libip6tc0 (&gt;= 1.6.0+snapshot20161117)
Depends: libnl-3-200 (&gt;= 3.2.27)
Depends: libnl-genl-3-200 (&gt;= 3.2.7)
Depends: libnl-route-3-200 (&gt;= 3.2.7)
Depends: libsnmp30 (&gt;= 5.7.3+dfsg-1.8ubuntu3.1~dfsg)
Depends: libssl1.1 (&gt;= 1.1.0)
Depends: libxtables12 (&gt;= 1.6.0+snapshot20161117)
Recommends: ipvsadm
[root@ubuntu1804 ~]#

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#36719;&#20214;xxx&#34987;&#21738;&#20123;&#21253;&#20381;&#36182;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">apt rdepends xxx</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">apt-cache rdepends xxx</span>

[root@ubuntu1804 ~]#apt rdepends bash
bash
Reverse Depends:
Depends: bash-builtins (= 4.4.18-2ubuntu1.2)
  bash:i386
Recommends: plasma-sdk (&gt;= 4.3)
  bash:i386
PreDepends: foomatic-db-engine (&gt;= 2.05)
  bash:i386
Replaces: bash-doc (&lt;&lt; 4.3-2)
<span style="color: #ffa54f;">Depends: chromium-browser (&gt;= 4)</span>
<span style="color: #ffa54f;">  bash:i386</span>
<span style="color: #ffa54f;">Depends: gdm3 (&gt;= 4.3)</span>
<span style="color: #ffa54f;">  bash:i386</span>
<span style="color: #ffa54f;">Depends: votca-csg-tutorials (&gt;= 4)</span>
<span style="color: #ffa54f;">  bash:i386</span>
<span style="color: #ffa54f;">Depends: votca-csg-scripts (&gt;= 4)</span>
<span style="color: #ffa54f;">  bash:i386</span>
<span style="color: #ffa54f;">Depends: uck (&gt;= 3.0)</span>
<span style="color: #ffa54f;">  bash:i386</span>
<span style="color: #ffa54f;">Depends: txt2regex (&gt;&gt; 2.04)</span>
<span style="color: #ffa54f;">  bash:i386</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1371b82f-9dfa-4557-9b0c-871c42e2563c" class="outline-3">
<h3 id="h:1371b82f-9dfa-4557-9b0c-871c42e2563c">ubuntu建议安装的常用包</h3>
<div class="outline-text-3" id="text-h:1371b82f-9dfa-4557-9b0c-871c42e2563c">
<div class="org-src-container">
<pre class="src src-sh">apt purge ufw lxd lxd-client lxcfs liblxc-common
apt install iproute2 ntpdate tcpdump telnet traceroute nfs-kernel-server nfs-common lrzsz tree openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev gcc openssh-server iotop unzip zip
</pre>
</div>

<p>
练习
</p>
<ul class="org-ul">
<li>查询命令java来自于哪个rpm包</li>
<li>yum的配置和使用,包括yum仓库的创建</li>
<li>编写系统初始化脚本 reset.sh，包括别名，提示符颜色，yum仓库配置文件,
安装tree,ftp,lftp,telnet等包</li>
<li>在CentOS 8上编译安装 apache 2.4.43 源码包,并启动此服务</li>
</ul>
</div>
</div>
</section>
<section id="outline-container-h:549bdb1f-b5e7-4961-9f37-ce8737d8e46f" class="outline-2">
<h2 id="h:549bdb1f-b5e7-4961-9f37-ce8737d8e46f">rpm包制作</h2>
<div class="outline-text-2" id="text-h:549bdb1f-b5e7-4961-9f37-ce8737d8e46f">
</div>
<div id="outline-container-h:70e2bbad-37db-483a-a457-8e5e11c9bab2" class="outline-3">
<h3 id="h:70e2bbad-37db-483a-a457-8e5e11c9bab2">快速制作RPM</h3>
<div class="outline-text-3" id="text-h:70e2bbad-37db-483a-a457-8e5e11c9bab2">
<p>
An Overview
</p>

<ul class="org-ul">
<li>Preparing to build RPMs 准备制作rpm包</li>
<li>Planing for RPMs 制作规划</li>
<li>Explanning the build process 制作过程</li>
<li>Using build files 使用build files 文件</li>
<li>Seeing the results 制作结果</li>
<li>Verifying your RPMs 验证</li>
</ul>

<p>
Writing Spec Files
</p>

<ul class="org-ul">
<li>Writing spec files 写 spec 文件</li>
<li>Defing package information 定义 包 信息</li>
<li>Controlling the build 控制编译</li>
<li>Listing the files in the package 列出包中包含的所有文件</li>
<li>Defining spec file macros 使用宏</li>
</ul>
</div>
<div id="outline-container-h:0e7e9b7d-d09c-48dd-84c2-f2221f059407" class="outline-4">
<h4 id="h:0e7e9b7d-d09c-48dd-84c2-f2221f059407">快速制作RPM</h4>
<div class="outline-text-4" id="text-h:0e7e9b7d-d09c-48dd-84c2-f2221f059407">
</div>
<div id="outline-container-h:1959d010-332c-490e-ba63-c9e7e317a5c2" class="outline-5">
<h5 id="h:1959d010-332c-490e-ba63-c9e7e317a5c2">准备制作RPM包</h5>
<div class="outline-text-5" id="text-h:1959d010-332c-490e-ba63-c9e7e317a5c2">
<p>
制作RPM包的主要任务是The main tasks in building RPMs are:
</p>

<ol class="org-ol">
<li>规划RPM的属性 Planning what you want to build 一个 rpm
可能包含一个软件可能是未被编译的。 a.是否可编译</li>

<li>收集源材料软件包 Gathering the software to package</li>

<li>收集补丁打补丁，在制作过程中打补丁，最好在官方源码上打 Pathching the
software as needed</li>

<li>制定指定路径的RPM包 Creating a reproducible build of the software
比较麻烦</li>

<li>升级功能 Planning for upgrades</li>

<li>规划依赖关系 Outlining any dependencies</li>

<li>制作RPM Building the RPMs</li>

<li>测试RPM Testing the RPMs</li>
</ol>
</div>
</div>
<div id="outline-container-h:db3f3648-9db8-4f63-952d-ad166c48a817" class="outline-5">
<h5 id="h:db3f3648-9db8-4f63-952d-ad166c48a817">规划RPM包</h5>
<div class="outline-text-5" id="text-h:db3f3648-9db8-4f63-952d-ad166c48a817">
<ol class="org-ol">
<li>你打算制作什么 ？ 应该程序 ？</li>

<li>是不是一个纯粹的库文件</li>

<li>是不是一堆系统配置文件</li>

<li>是创建一个二进制包还是源码包，或是都有</li>
</ol>

<p>
包内容可以包括：程序:2进制，源码，库文件，系统配置文件
</p>

<p>
RPM制作过程中将Mysql-5.5.22.tar.gz源码包拆成多个功能的rpm包mysql,
mysql-server, mysql-devel
</p>
</div>
</div>
<div id="outline-container-h:e0ea36fb-22a8-4926-a5b8-00442c34a2bb" class="outline-5">
<h5 id="h:e0ea36fb-22a8-4926-a5b8-00442c34a2bb">解释制作的过程</h5>
<div class="outline-text-5" id="text-h:e0ea36fb-22a8-4926-a5b8-00442c34a2bb">
<p>
rpm 包在制作过程中，每个rpm
都提供一种能力(capabilit)，这种能力很可能被别的包依赖，这种能力大多数跟
rpm 名字相同。每一个rpm 中的文件可以称之为能力。
</p>

<p>
能力：
</p>
<ol class="org-ol">
<li>rpm 自身名字包含的意义</li>
<li>rpm 中的文件可能被别的 rpm 依赖。</li>
</ol>

<p>
依赖分为：编译依赖和安装依赖
</p>

<p>
<b>(1) 四步</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">1) &#35774;&#32622;rpm&#21253;&#30340;&#21046;&#20316;&#36710;&#38388;(&#30446;&#24405;&#32467;&#26500;)
<span style="color: #483d8b;">set</span> up the dirctory structure

2) &#23558;&#28304;&#26448;&#26009;&#25918;&#21040;&#35268;&#21010;&#22909;&#30340;&#30446;&#24405;&#20013;
Place the source<span style="color: #a020f0;"> in</span> the right directory

3) &#21019;&#24314;spec&#25991;&#20214;&#25511;&#21046;&#21046;&#20316;
Create a spec file that tells the rpmbuild command what to<span style="color: #a020f0;"> do</span> 

4) &#32534;&#35793;&#28304;&#20195;&#30721;&#29983;&#25104;rpm&#21253;
Build the source and binary RPMs
&#27880;&#24847;&#65306;&#21046;&#20316;&#36807;&#31243;&#20013;&#19981;&#33021;&#29992;&#31649;&#29702;&#21592;&#36827;&#34892;&#65292;&#36991;&#20813;&#26435;&#38480;&#22826;&#22823;&#35823;&#25805;&#20316;
</pre>
</div>

<p>
<b>(2）目录结构</b>
</p>

<p>
工作车间中要有 5 个子目录，注意目录名都要大写：
</p>

<div class="org-src-container">
<pre class="src src-sh">BUILD : &#28304;&#20195;&#30721;&#35299;&#21387;&#21518;&#23384;&#25918;&#30340;&#20301;&#32622;&#12290;&#30495;&#27491;&#30340;&#21046;&#20316;&#36710;&#38388;&#26159;BUILD&#30446;&#24405;
RPMS : &#21046;&#20316;&#23436;&#25104;&#21518;&#30340;RPM&#21253;&#23384;&#25918;&#20301;&#32622;&#65292;&#20026;&#29305;&#23450;&#24179;&#21488;&#21019;&#24314;&#23376;&#30446;&#24405;
SOURCES : &#25910;&#38598;&#30340;&#21407;&#26448;&#26009;&#23384;&#25918;&#20301;&#32622;
SPECS : &#23384;&#25918;spec&#25991;&#20214;
SRPMS : SRC&#26684;&#24335;&#30340;RPM&#21253;&#23384;&#25918;&#30446;&#24405;
BUILDROOT : &#20551;&#26681;&#65292;&#20351;&#29992;install&#20020;&#26102;&#23433;&#35013;&#21040;&#36825;&#20010;&#30446;&#24405;&#65292;&#25226;&#36825;&#20010;&#30446;&#24405;&#24403;&#20316;&#26681;&#26469;&#29992;&#30340;&#65292;&#25152;&#20197;&#22312;&#36825;&#20010;&#30446;&#24405;&#19979;&#30340;&#30446;&#24405;&#25991;&#20214;&#65292;&#25165;&#26159;&#30495;&#27491;&#30340;&#30446;&#24405;&#25991;&#20214;&#12290;&#24403;&#25171;&#21253;&#23436;&#25104;&#21518;&#65292;&#22312;&#28165;&#29702;&#38454;&#27573;&#65292;&#36825;&#20010;&#30446;&#24405;&#23558;&#34987;&#21024;&#38500;
</pre>
</div>


<figure id="org818a7fd">
<img src="images/image-20210216015434833.png" alt="image-20210216015434833.png" width="60%">

</figure>

<p>
rpm包的默认制作路径在/usr/src/redhat下
</p>

<p>
<b>(3) RPM包的制作车间是由RMP的宏定义的</b>
</p>

<p>
安装：
</p>

<div class="org-src-container">
<pre class="src src-sh">yum -y install rpm-build   <span style="color: #b22222;"># </span><span style="color: #b22222;">centos 7</span>
</pre>
</div>

<p>
1）使用rpmbuild 查看RPM宏
</p>

<div class="org-src-container">
<pre class="src src-sh">rpmbuild --showrc   
</pre>
</div>

<p>
宏以%开头，引用时加{},一个下划线是定义本身环境的，二个下划线通常定义的
是命令为什么要定义宏，因为不同的系统，命令的存放位置可能不同，所以通过
宏的定义找到命令的真正存放位置
</p>

<p>
RPM包宏的位置
</p>

<div class="org-src-container">
<pre class="src src-sh">rpmbuild --showrc | grep macro  <span style="color: #b22222;"># </span><span style="color: #b22222;">{_target}/macros:~/.rpmmacros</span>
</pre>
</div>

<p>
所以只要改变了这个宏，我们就可以自定义工作车间了
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# rpmbuild --showrc |grep _topdir  <span style="color: #b22222;"># </span><span style="color: #b22222;">centos 7 &#24050;&#25351;&#23450;&#29992;&#25143;&#23478;&#30446;&#24405;&#65292;centos 6 &#36824;&#26159; _topdir  %{_usrsrc}/redhat</span>
-14: _builddir    %{_topdir}/BUILD
-14: _buildrootdir    %{_topdir}/BUILDROOT
-14: _rpmdir    %{_topdir}/RPMS
-14: _sourcedir    %{_topdir}/SOURCES
-14: _specdir    %{_topdir}/SPECS
-14: _srcrpmdir    %{_topdir}/SRPMS
-14: _topdir    %{getenv:HOME}/rpmbuild   
</pre>
</div>

<p>
查看版本信息
</p>

<div class="org-src-container">
<pre class="src src-sh">rpmbuild --showrc |grep dist  <span style="color: #b22222;"># </span><span style="color: #b22222;">-14: dist    .el7.centos</span>
</pre>
</div>

<p>
在家目录下定义宏就不再使用系统的宏
</p>

<p>
读取SOURCES文件 &#x2013;&gt;BUILD &#x2013;&gt;BUILDROOT &#x2013;&gt; file段 &#x2013;&gt; clean段
</p>

<p>
rpm官方并不推荐直接更改这个目录，而是在用户家目录下建立一个名
为.rpmmacros的隐藏文件(注意前面的点不能少，这是Linux下隐藏文件的常识)，
然后在里面重新定义%_topdir，指向一个新的目录名。这样就可以满足某些“高
级”用户的差异化需求了。通常情况下.rpmmacros文件里一般只有一行内容，比
如
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# su - jasper
[jasper@node01 ~]$ rpmbuild --showrc |grep _topdir
-14: _builddir    %{_topdir}/BUILD
-14: _buildrootdir    %{_topdir}/BUILDROOT
-14: _rpmdir    %{_topdir}/RPMS
-14: _sourcedir    %{_topdir}/SOURCES
-14: _specdir    %{_topdir}/SPECS
-14: _srcrpmdir    %{_topdir}/SRPMS
-14: _topdir    /home/jasper/rpmbuild

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;&#24037;&#20316;&#36710;&#38388;&#30340;&#23439;</span>
[jasper@node01 ~]$ vim .rpmmacros  
%_topdir /home/jasper/rpmbuild

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20020;&#26102;&#30446;&#24405;&#30340;&#23439;</span>
[jasper@node01 rpmbuild]$ rpmbuild --showrc |grep -i _tmppath
-14: _tmppath    %{_var}/tmp

<span style="color: #b22222;"># </span><span style="color: #b22222;">BUILDROOT&#30340;&#23439;</span>
[jasper@node01 SPECS]$ rpmbuild --showrc |grep -i buildroot
  %{?buildroot:<span style="color: #a0522d;">RPM_BUILD_ROOT</span>=<span style="color: #8b2252;">"%{u2p:%{buildroot}}"</span>
-14: _buildrootdir    %{_topdir}/BUILDROOT
-14: buildroot    %{_buildrootdir}/%{name}-%{version}-%{release}<span style="color: #483d8b;">.</span>%{_arch}

<span style="color: #b22222;"># </span><span style="color: #b22222;">centos7 &#33050;&#26412;&#20301;&#32622;</span>
[jasper@node01 SPECS]$ rpmbuild  --showrc |grep systemd
-14: _unitdir    /usr/lib/systemd/system
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3b0b7809-1fe4-40a0-bc15-d49ce8786416" class="outline-5">
<h5 id="h:3b0b7809-1fe4-40a0-bc15-d49ce8786416">如何使用制作的相关文件</h5>
<div class="outline-text-5" id="text-h:3b0b7809-1fe4-40a0-bc15-d49ce8786416">
<p>
<b>1.定义车间位置</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">centos7</span>
su - jasper
cat &lt;&lt;\EOF &gt;~/.rpmmacros  
<span style="color: #ffa54f;">%_topdir /home/jasper/rpmbuild</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">centos 6 &#22914;&#19979;</span>
cat &gt;&gt; .rpmmacros  &lt;&lt;EOF
<span style="color: #ffa54f;">%_topdir /home/jasper/rpmbuild</span>
<span style="color: #ffa54f;">%buildroot %{_tmppath}/%{name}-%{version}-%{release}-root</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
<b>2.创建目录结构</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir -pv ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
rpmbuild --showrc | grep _topdir  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20197;&#25913;&#25104;&#33258;&#24049;&#30340;&#30446;&#24405;</span>
rpmbuild --showrc | grep buildroot
</pre>
</div>

<p>
<b>3.收集源码包</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[jasper@node01 rpmbuild]$ cd SOURCES/
[jasper@node01 SOURCES]$ wget http://nginx.org/download/nginx-1.13.12.tar.gz
[jasper@node01 SOURCES]$ cat nginx.sysinit  <span style="color: #b22222;"># </span><span style="color: #b22222;">cenos7 &#21551;&#21160;&#33050;&#26412;</span>
[Unit]
<span style="color: #a0522d;">Description</span>=nginx - high performance web server
<span style="color: #a0522d;">Documentation</span>=http://nginx.org/en/docs/
<span style="color: #a0522d;">After</span>=network.target remote-fs.target nss-lookup.target

[Service]
<span style="color: #a0522d;">Type</span>=forking
<span style="color: #a0522d;">PIDFile</span>=/var/run/nginx/nginx.pid
<span style="color: #a0522d;">ExecStartPre</span>=/usr/sbin/nginx -t -c /etc/nginx/nginx.conf
<span style="color: #a0522d;">ExecStart</span>=/usr/sbin/nginx  -c /etc/nginx/nginx.conf
<span style="color: #a0522d;">ExecReload</span>=/bin/kill -s HUP $<span style="color: #a0522d;">MAINPID</span>
<span style="color: #a0522d;">ExecStop</span>=/bin/kill -s QUIT $<span style="color: #a0522d;">MAINPID</span>
<span style="color: #a0522d;">PrivateTmp</span>=true

[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target

[jasper@node01 SOURCES]$ ls
nginx-1.13.12.tar.gz  nginx.sysinit
</pre>
</div>

<p>
<b>4.创建spec文件</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[jasper@node01 SOURCES]$ cd ../SPECS/
[jasper@node01 SPECS]$ vim nginx.spec
</pre>
</div>

<p>
<b>5.用rpmbuild命令制作rpm包</b>
</p>

<p>
rpmbuild命令会根据spec文件来生成rpm包
</p>

<p>
rpmbuild 选项
</p>

<div class="org-src-container">
<pre class="src src-sh">-ba : &#21516;&#26102;&#21046;&#20316;&#25104;&#29983;&#20108;&#36827;&#21046;&#26684;&#24335;&#30340;rpm&#21253;&#21644;&#28304;&#30721;&#26684;&#24335;&#30340;rpm&#21253;&#65307;
-bb : &#20165;&#21046;&#20316;&#20108;&#36827;&#21046;&#26684;&#24335;&#30340;rpm&#21253;&#65307;
-bp : &#20165;&#25191;&#34892;&#33267;spec&#25991;&#20214;&#20013;&#30340;%prep&#38454;&#27573;&#21363;&#20572;&#27490;&#36827;&#34892;&#65307;
-bc : &#20165;&#25191;&#34892;&#21040;spec&#25991;&#20214;&#20013;&#30340;%build&#38454;&#27573;&#21363;&#20572;&#27490;&#36827;&#34892;&#65307;
-bi : &#20165;&#36816;&#34892;&#33267;spec&#25991;&#20214;&#20013;&#30340;%install&#38454;&#27573;&#21363;&#20572;&#27490;&#36816;&#34892;&#65307;
-bl : &#26816;&#26597;spec&#25991;&#20214;&#20013;%file&#27573;&#25152;&#21015;&#20986;&#30340;&#25991;&#20214;&#26159;&#19981;&#26159;&#19982;BUILDROOT&#30446;&#24405;&#20013;&#23384;&#22312;&#30340;&#25991;&#20214;&#23436;&#20840;&#21305;&#37197;&#65307;
-bs : &#20165;&#21046;&#20316;&#29983;&#25104;&#28304;&#30721;&#26684;&#24335;&#30340;rpm&#21253;
</pre>
</div>

<p>
我们可以一步步试，先rpmbuild -bp ,再-bc 再-bi 如果没问题，rpmbuild -ba
生成src包与二进制包吧
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">-bp : &#20165;&#25191;&#34892;&#33267;spec&#25991;&#20214;&#20013;&#30340;%prep&#38454;&#27573;&#21363;&#20572;&#27490;&#36827;&#34892;&#65307;</span>
[jasper@node01 SPECS]$ rpmbuild -bp nginx.spec
<span style="color: #0000ff;">Executing</span>(%prep): /bin/sh -e /var/tmp/rpm-tmp.TfvtrC
+ umask 022
+ cd /home/jasper/rpmbuild/BUILD
+ cd /home/jasper/rpmbuild/BUILD
+ rm -rf nginx-1.13.12
+ /usr/bin/gzip -dc /home/jasper/rpmbuild/SOURCES/nginx-1.13.12.tar.gz
+ /usr/bin/tar -xf -
+ <span style="color: #a0522d;">STATUS</span>=0
+ <span style="color: #8b2252;">'['</span> 0 -ne 0 <span style="color: #8b2252;">']'</span>
+ cd nginx-1.13.12
+ /usr/bin/chmod -Rf a+rX,u+w,g-w,o-w .
+ exit 0
[jasper@node01 SPECS]$ ls ~/rpmbuild/BUILD
nginx-1.13.12
[jasper@node01 SPECS]$ ls ~/rpmbuild/BUILD/nginx-1.13.12/
auto  CHANGES  CHANGES.ru  conf  configure  contrib  html  LICENSE  man  README  src

<span style="color: #b22222;"># </span><span style="color: #b22222;">-bc : &#20165;&#25191;&#34892;&#21040;spec&#25991;&#20214;&#20013;&#30340;%build&#38454;&#27573;&#21363;&#20572;&#27490;&#36827;&#34892;&#65307;</span>
[jasper@node01 SPECS]$ rpmbuild  -bc nginx.spec

<span style="color: #b22222;"># </span><span style="color: #b22222;">-bi : &#20165;&#36816;&#34892;&#33267;spec&#25991;&#20214;&#20013;&#30340;%install&#38454;&#27573;&#21363;&#20572;&#27490;&#36816;&#34892;&#65307;</span>
[jasper@node01 SPECS]$ rpmbuild  -bi nginx.spec

<span style="color: #b22222;"># </span><span style="color: #b22222;">-bb : &#20165;&#21046;&#20316;&#20108;&#36827;&#21046;&#26684;&#24335;&#30340;rpm&#21253;&#65307;</span>
[jasper@node01 SPECS]$ rpmbuild  -bb nginx.spec
[jasper@node01 SPECS]$ ls ../RPMS/x86_64/
nginx-1.13.12-1.el7.centos.x86_64.rpm  nginx-debuginfo-1.13.12-1.el7.centos.x86_64.rpm
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1584f173-f06f-4d64-a854-f0e7a932f2f0" class="outline-5">
<h5 id="h:1584f173-f06f-4d64-a854-f0e7a932f2f0">验证结果</h5>
<div class="outline-text-5" id="text-h:1584f173-f06f-4d64-a854-f0e7a932f2f0">
<p>
安装测试有没有问题，能否正常安装运行，能否正常升级，卸载有没有问题
</p>

<p>
root用户测试安装:
</p>

<div class="org-src-container">
<pre class="src src-sh">rpm -ivh tengine-1.4.2-1.el6.x86_64.rpm  <span style="color: #b22222;">##</span><span style="color: #b22222;">&#27979;&#35797;&#23433;&#35013;</span>
rpm -e tengine                           <span style="color: #b22222;">##</span><span style="color: #b22222;">&#27979;&#35797;&#21368;&#36733;&#65292;&#22914;&#26524;&#29256;&#26412;&#21495;&#27604;&#21407;&#26469;&#30340;&#39640;&#65292;&#21319;&#32423;&#27979;&#35797;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">[jasper@node01 SPECS]$ su -
[root@node01 ~]# rpm --replacepkgs -ivh /home/jasper/rpmbuild/RPMS/x86_64/nginx-1.13.12-2.el7.centos.x86_64.rpm
Preparing...                          <span style="color: #b22222;">################################# </span><span style="color: #b22222;">[100%]</span>
Updating / installing...
   1:nginx-1.13.12-2.el7.centos       <span style="color: #b22222;">################################# </span><span style="color: #b22222;">[100%]</span>

[root@node01 ~]# systemctl start nginx


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36824;&#21407;cpio &#20013;&#30340;&#28304;&#25991;&#20214;&#12290;</span>
[jasper@node01 SRPMS]$ rpm2cpio nginx-1.13.12-2.el7.centos.src.rpm &gt; nginx-1.13.12-2.cpio
[root@node01 SRPMS]# cpio -idvc &lt; nginx-1.13.12-2.cpio
nginx-1.13.12.tar.gz
nginx.spec
nginx.sysinit

&#25110;
[root@node01 SRPMS]# rpm2cpio nginx-1.13.12-2.el7.centos.src.rpm | cpio -idv
nginx-1.13.12.tar.gz
nginx.spec
nginx.sysinit
1995 blocks


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475; &#28304;&#30721;&#21253;&#26377;&#20160;&#20040;&#25991;&#20214;</span>
[jasper@node01 SRPMS]$ rpm2cpio nginx-1.13.12-2.el7.centos.src.rpm | cpio -t
nginx-1.13.12.tar.gz
nginx.spec
nginx.sysinit
1995 blocks

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#28304;&#30721;&#21253;&#21487;&#20197;&#29992; --rebuild &#37325;&#26032;&#32534;&#35793;</span>
[root@node01 SRPMS]# rpmbuild --rebuild nginx-1.13.12-2.el7.centos.src.rpm
</pre>
</div>

<p>
此时编译过程中，会在当前用户家目录下生成rpmbuild目录以及内部相关文件，
等编译结束后只保留编译后的包文件。
</p>

<p>
在制作 rpm 包时必须用普通用制作，这是为了避免别人恶意在制作过程 <code>rm
-fr /</code> 之类的危险命令。
</p>

<p>
如果没问题为rpm包签名吧，防止有人恶意更改
</p>

<p>
范例：快速打包
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1. &#33258;&#21160;&#29983;&#25104;&#24037;&#20316;&#30446;&#24405;</span>
rpmdev-setuptree

&#24037;&#20316;&#30446;&#24405;&#22914;&#19979;&#65306;
~/rpmbuild
~/rpmbuild/SOURCES 
~/rpmbuild/SPECS 
~/rpmbuild/BUILD 
~/rpmbuild/RPMS 
~/rpmbuild/RPMS/i386 
~/rpmbuild/SRPMS 

<span style="color: #b22222;"># </span><span style="color: #b22222;">2. &#29983;&#25104;spec</span>
rpmrebuild -e -p shellname.rpm    //&#20250;&#37325;&#26032;&#29983;&#25104;spec&#65292;&#26681;&#25454;&#37324;&#38754;&#30340;&#25552;&#31034;&#37325;&#26032;&#20462;&#25913;spec&#20869;&#23481;&#65292;&#27492;&#37096;&#20998;&#26159;&#20043;&#21518;&#25490;&#38169;&#25152;&#29992;&#21040;&#65292;&#29616;&#22312;&#26080;&#38656;&#20351;&#29992;

<span style="color: #b22222;"># </span><span style="color: #b22222;">cd rpmbuild/</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">vi BUILD/shellname.spec       //&#25226;&#20197;&#19979;&#25335;&#36125;&#21040;spec&#25991;&#20214;,&#27492;&#25991;&#20214;&#26159;rpm&#25171;&#21253;&#30340;&#26680;&#24515;</span>
Summary:            Prepare net environment
Name:               shellname.x
Version:            43
Release:            el7
License:            GPL
Group:              System Environment/Base
ExclusiveArch:      x86_64
Provides:      shellname.x = 43-el7
Provides:      shellname.x(x86-64) = 43-el7
<span style="color: #0000ff;">Requires</span>(pre): /bin/sh                               <span style="color: #b22222;">#</span><span style="color: #b22222;">requires &#24456;&#26126;&#26174;&#26159;&#23433;&#35013;rpm&#21253;&#25152;&#38656;&#30340;&#20381;&#36182;,&#26681;&#25454;&#20320;&#30340;&#24773;&#20917;&#22635;&#20889;&#21363;&#21487;</span>
<span style="color: #0000ff;">Requires</span>(post): /bin/sh                               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#22635;&#20889;&#20063;&#26159;&#21487;&#20197;&#25171;&#21253;&#25104;&#21151;</span>
<span style="color: #0000ff;">Requires</span>(preun): /bin/sh
Requires:      libc.so.6()(64bit)
Requires:      libc.so.6(GLIBC_2.14)(64bit)
Requires:      libc.so.6(GLIBC_2.2.5)(64bit)
Requires:      libc.so.6(GLIBC_2.7)(64bit)
Requires:      rtld(GNU_HASH)
%description                         <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25551;&#36848;&#20869;&#23481;&#65292;&#38543;&#20415;&#22635;&#23601;&#22909;</span>
shellname.x prepare net bridge environment
%prep                                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#21253;&#21069;&#30340;&#24037;&#20316;&#65292;%{buildroot}&#26159;&#39033;&#30446;&#26681;&#30446;&#24405;&#65292;&#32780;%{_binddir}&#26159;&#25351;/usr/bin&#30446;&#24405;</span>
mkdir -p %{buildroot}%{_bindir}    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#39033;&#30446;&#25152;&#38656;&#30340;&#30446;&#24405;,&#21040;&#26102;&#20505;&#23433;&#35013;rpm&#21253;&#20250;&#29983;&#25104;_binddir&#30446;&#24405;&#19979;</span>
install -c -m 755 $<span style="color: #a0522d;">OLDPWD</span>/shellname.x %{buildroot}%{_bindir}/shellname.x    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;&#25171;&#21253;&#25991;&#20214;&#25335;&#36125;&#21040;&#21040;&#39033;&#30446;&#30446;&#24405;</span>
<span style="color: #a020f0;">exit</span> 0
%files                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27492;&#22788;&#22635;&#20889;&#39033;&#30446;&#21253;&#21547;&#30340;&#30446;&#24405;,&#20063;&#23601;&#26159;&#35828;&#23433;&#35013;&#23436;rpm&#21253;&#65292;&#23558;&#20250;&#29983;&#25104;&#36825;&#20123;&#30446;&#24405;&#21644;&#25991;&#20214;</span>
/usr/bin/shellname.x        
<span style="color: #b22222;">#</span><span style="color: #b22222;">%{_bindir}                # &#27492;&#22788;&#25105;&#26366;&#22635;&#20889;,&#25191;&#34892;rpm&#23433;&#35013;&#25253;&#38169;,&#21407;&#22240;&#26435;&#38480;&#19981;&#22815;,&#29616;&#22312;&#24050;&#27880;&#37322;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">%dir %attr(0755, root, root) "/usr/bin"          # &#27492;&#22788;&#25105;&#26366;&#22635;&#20889;,&#25191;&#34892;rpm&#23433;&#35013;&#25253;&#38169;,&#21407;&#22240;&#26435;&#38480;&#19981;&#22815;,&#29616;&#22312;&#24050;&#27880;&#37322;</span>
%attr(0755, root, root) <span style="color: #8b2252;">"/usr/bin/shellname.x"</span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;&#26435;&#38480;&#21644;&#25152;&#23646;</span>
%pre -p /bin/sh                              <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#28165;&#26970;&#21547;&#20041;&#65292;rpmrebuild&#20462;&#22797;&#21518;&#29983;&#25104;&#20986;&#26469;</span>
%post -p /bin/sh                              <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21516;&#19978;&#65292;rpmrebuild&#20462;&#22797;&#21518;&#29983;&#25104;&#20986;&#26469;</span>
%preun -p /bin/sh                              <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21516;&#19978;&#65292;rpmrebuild&#20462;&#22797;&#21518;&#29983;&#25104;&#20986;&#26469;</span>
%define __spec_install_pre /bin/true                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21516;&#19978;</span>
%build                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27492;&#22788;&#24212;&#35813;&#26159;&#32534;&#35793;&#28304;&#30721;&#21253;&#25152;&#38656;&#35201;&#22635;&#20889;&#30340;</span>
%clean                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26500;&#24314;&#23436;&#39033;&#30446;&#28165;&#29702;</span>
rm -rf %{buildroot}
%changelog             <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#28165;&#26970;&#20316;&#29992;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">3. &#20351;&#29992;rpmbuild&#21629;&#20196;&#25171;&#21253;</span>
rpmbuild -bb /BUILD/shellname.spec
</pre>
</div>

<p>
注意：shellname.x 放在rpmbuild目录 生成的rpm包在rpmbuild/RPMS/目录下，
输出的rpm包就可以执行安装啦！ <code>rpm -ivh shellname.rpm</code>
</p>
</div>
</div>
</div>
<div id="outline-container-h:6b808e24-eef0-4d91-8414-9b51bb7273ad" class="outline-4">
<h4 id="h:6b808e24-eef0-4d91-8414-9b51bb7273ad">写一个Spec文件</h4>
<div class="outline-text-4" id="text-h:6b808e24-eef0-4d91-8414-9b51bb7273ad">
<p>
An Overview
</p>

<ul class="org-ul">
<li>Preparing to build RPMs 准备制作rpm包</li>
<li>Planing for RPMs 制作规划</li>
<li>Explanning the build process 制作过程</li>
<li>Using build files 使用build files 文件</li>
<li>Seeing the results 制作结果</li>
<li>Verifying your RPMs 验证</li>
</ul>

<p>
Writing Spec Files
</p>

<ul class="org-ul">
<li>Writing spec files 写 spec 文件</li>
<li>Defing package information 定义 包 信息</li>
<li>Controlling the build 控制编译</li>
<li>Listing the files in the package 列出包中包含的所有文件</li>
<li>Defining spec file macros 使用宏</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 Packages]# rpm -qi bash-4.2.46-28.el7.x86_64
Name        : bash   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36719;&#20214;&#21253;&#21517;</span>
Version     : 4.2.46  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29256;&#26412;&#21495;</span>
Release     : 28.el7  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21457;&#34892;&#21495;</span>
Architecture: x86_64
Install Date: Thu 18 Jan 2018 04:15:43 PM CST
Group       : System Environment/Shells  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25152;&#23646;&#30340;&#21253;&#32452;</span>
Size        : 3663637
License     : GPLv3+
Signature   : RSA/SHA256, Thu 10 Aug 2017 11:03:40 PM CST, Key ID 24c6a8a7f4a80eb5  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31614;&#21517;&#20449;&#24687;</span>
Source RPM  : bash-4.2.46-28.el7.src.rpm
Build Date  : Thu 03 Aug 2017 05:13:21 AM CST <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21046;&#20316;&#26085;&#26399;</span>
Build Host  : c1bm.rdu2.centos.org   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21046;&#20316;&#20027;&#26426;</span>
Relocations : (not relocatable)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#21542;&#25903;&#25345;&#37325;&#26032;&#23450;&#20041;&#23433;&#35013;&#36335;&#24452;</span>
Packager    : CentOS BuildSystem <a href="http://bugs.centos.org">&lt;http://bugs.centos.org&gt;</a>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35841;&#21046;&#20316;&#30340;</span>
Vendor      : CentOS  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21046;&#20316;&#32773;</span>
URL         : http://www.gnu.org/software/bash
Summary     : The GNU Bourne Again shell  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31616;&#35201;&#35828;&#26126;&#65292;&#19981;&#35201;&#36229;&#36807;50&#20010;&#23383;&#31526;</span>
Description :   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35814;&#32454;&#35828;&#26126;</span>
</pre>
</div>

<p>
基本信息
</p>
<div class="org-src-container">
<pre class="src src-sh">Name: &#36719;&#20214;&#21517;&#31216;
Version: &#36719;&#20214;&#29256;&#26412;
Release: &#21457;&#24067;&#27425;&#25968; &#22914;: 1%{?dist}
Summary: &#36719;&#20214;&#35828;&#26126;

Group: &#36719;&#20214;&#20998;&#32452;
License: &#25480;&#26435;&#27169;&#24335;,&#20363;&#22914; GPL
URL: &#28304;&#30721;&#21253;&#30340;URL&#22320;&#22336;
Source0: &#28304;&#30721;&#21253;,&#21487;&#25351;&#23450;&#22810;&#20010;,&#19979;&#38754;&#21487;&#29992;%{SOURCE0}&#21464;&#37327;&#24341;&#29992;
BuildRoot: &#32534;&#35793;&#36807;&#31243;&#20013;&#30340;&#20013;&#38388;&#23384;&#26723;&#30446;&#24405; &#22914;: %(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXX)
BuildArch: &#24179;&#21488; %{_arch}
BuildRequires:&#32534;&#35793;&#36807;&#31243;&#20381;&#36182;&#30340;&#24037;&#20855;
Requires: &#25152;&#20381;&#36182;&#30340;&#36719;&#20214;&#21253;

</pre>
</div>

<p>
最终的rpm名称: {Name}-{Version}-{Relesae}-{BuildArch}.rpm
</p>
</div>
<div id="outline-container-h:c15db9cb-7564-4dc3-9278-0eca504bb8e7" class="outline-5">
<h5 id="h:c15db9cb-7564-4dc3-9278-0eca504bb8e7">spec文件语法格式</h5>
<div class="outline-text-5" id="text-h:c15db9cb-7564-4dc3-9278-0eca504bb8e7">
<p>
标签： TagName: value (Name: nginx) ​#前面Name是不区分大小写，后面必须
小写
</p>

<p>
自定义宏： %define macro_name value #最好不要跟标签重名，引用宏
%{macro_name} 或 %macro_name
</p>

<p>
注释： #开头的行，在注释中不要使用%，用%%代替
</p>
</div>
</div>
<div id="outline-container-h:9c55a872-4868-4243-a019-1308cc292365" class="outline-5">
<h5 id="h:9c55a872-4868-4243-a019-1308cc292365">定义包的信息</h5>
<div class="outline-text-5" id="text-h:9c55a872-4868-4243-a019-1308cc292365">
<p>
使用 rpm -qi 可以看见的
</p>


<figure id="orgc317b54">
<img src="images/image-20210216015554996.png" alt="image-20210216015554996.png" width="60%">

</figure>

<ol class="org-ol">
<li><p>
包名：
</p>

<div class="org-src-container">
<pre class="src src-sh">Name: Name&#20013;&#19981;&#33021;&#20351;&#29992;<span style="color: #8b2252;">"-"</span>&#65292;<span style="color: #8b2252;">"-"</span>&#26377;&#29305;&#27530;&#24847;&#20041;&#12290;name-version-release.rpm, name-version-release.arch.rpm
Version: &#36319;&#36719;&#20214;&#21253;&#29256;&#26412;&#30456;&#21516;&#29256;&#26412;&#21495;&#65292;version&#20013;&#19981;&#33021;&#20351;&#29992;<span style="color: #8b2252;">"-"</span>
Release: &#20462;&#27491;&#21495;&#12290;&#22914;&#65292;Release: 1%{?dist} <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21457;&#34892;&#21495;&#65292;&#31532;&#20960;&#27425;&#21046;&#20316;&#12290;&#23439;&#21069;&#26377;&#21028;&#26029;?&#21495;&#65292;&#22914;&#26524;&#26377;&#65292;&#21017;&#21152;&#19978;&#23439;</span>
Summary: &#21253;&#30340;&#31616;&#35201;&#25551;&#36848;&#65292;&#19968;&#33324;&#19981;&#35201;&#36229;&#36807;50&#20010;&#23383;&#31526;
Group: &#20351;&#29992; /usr/share/doc/rpm-&#29256;&#26412;&#21495;/GROUPS &#20013;&#29616;&#23384;&#30340;&#32452;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">
</pre>
</div></li>

<li><p>
公司相关信息： License:
</p>

<div class="org-src-container">
<pre class="src src-sh">License: &#29256;&#26435;&#65292;&#22914;&#26524;&#29256;&#26435;&#23646;&#20110;&#21035;&#20154;&#30340;&#28304;&#30721;&#21253;&#65292;&#24314;&#35758;Vendor,URL&#20889;&#25104;&#21035;&#20154;&#30340;
URL&#65306;RPM&#21253;&#19979;&#36733;&#20301;&#32622;(&#21487;&#36873;&#65292;&#26368;&#22909;&#21035;&#30465;)
Packager: RPM&#21253;&#21046;&#20316;&#32773;&#12290;&#20808;&#20889;&#21517;&#23383;(first name, last name)&#21518;&#20889;&#37038;&#31570;&#22320;&#22336; email&#19968;&#33324;&#20889;&#22312;&lt;&gt;&#20013; (&#21487;&#36873;)&#12290;&#22914;&#65292;Packager: jasper hsu <a href="mailto:xcwhome%40gmail.com">&lt;xcwhome@gmail.com&gt;</a>
Vendor: &#25552;&#20379;RPM&#20844;&#21496;&#30456;&#20851;&#20449;&#24687;&#65292;&#20063;&#21487;&#20197;&#26159;&#21046;&#20316;&#32773;(&#21487;&#36873;&#65292;&#26368;&#22909;&#21035;&#30465;)
</pre>
</div></li>

<li>描述信息： %descripition：可分段介绍，每行长度不超过50字符。</li>

<li><p>
设定build目录
</p>

<p>
BUILD：材料放到里面编译 BuildRoot
</p>

<p>
拟定的/目录，通常放在临时目录BUILDROOT中，不区分大小写，会在清理段
%clean删除目录。所有在这个目录下的文件除了DEBUG信息都要做进rpm包中。
</p>

<div class="org-src-container">
<pre class="src src-sh">BuildRoot: %{_tmppath}/%{name}-%{version}-root <span style="color: #b22222;"># </span><span style="color: #b22222;">BuildRoot&#21478;&#19968;&#20010;&#21464;&#37327;&#21517; RPM_BUILD_ROOT&#65292;&#20351;&#29992;&#26102;$RPM_BUILD_ROOT</span>
</pre>
</div>

<p>
cenots7 这里切换BUILDROOT 目录我是在~/.rpmmacros 中定义生效的
</p>

<div class="org-src-container">
<pre class="src src-sh">su - jasper
cat &lt;&lt;\EOF &gt;~/.rpmmacros
<span style="color: #ffa54f;">%_topdir /home/jasper/rpmbuild</span>
<span style="color: #ffa54f;">%buildroot %{_tmppath}/%{name}-%{version}-root</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div></li>

<li><p>
定义包的依赖关系：
</p>

<p>
<code>Requires: capbility</code> 。安装时的依赖，capbility通常是包的名字也可以
是提供的能力,或文件,名字有多个用”,“隔开，可出现多次(可选)
</p>

<div class="org-src-container">
<pre class="src src-sh">Requires: bash,chkconfig
Requires: bash&gt;=2.0             <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29256;&#26412;&#21495;&#22823;&#20110;2.0</span>
Requires: perl(Caro) &gt;=3.2    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38480;&#21046;&#27169;&#22359;&#29256;&#26412;</span>
<span style="color: #0000ff;">Requires</span>(pre):                         <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;&#21069;pre&#33050;&#26412;&#29992;&#21040;</span>
<span style="color: #0000ff;">Requires</span>(post):                        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;&#21518;poste&#33050;&#26412;&#29992;&#21040;</span>
<span style="color: #0000ff;">Requires</span>(preun):                     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21368;&#36733;&#21069;&#30340;&#33050;&#26412;&#29992;&#21040;&#21738;&#20123;&#21253;</span>
<span style="color: #0000ff;">Requires</span>(postun):                   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21368;&#36733;&#21518;&#30340;&#33050;&#26412;&#29992;&#21040;&#21738;&#20123;&#21253;</span>
Provides: capbility                       <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#25552;&#20379;&#30340;&#33021;&#21147;&#65292;&#19981;&#23450;&#20041;&#33021;&#21147;&#20854;&#33021;&#21147;&#26159;&#33258;&#24049;&#30340;&#21253;&#21517;(&#21487;&#36873;)</span>
BuildRequires: capbility               <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32534;&#35793;&#26102;&#38656;&#35201;&#30340;&#20381;&#36182;&#65292;&#21487;&#20986;&#29616;&#22810;&#27425;(&#21487;&#36873;)</span>
</pre>
</div></li>

<li><p>
定义源码包的源文件信息
</p>

<div class="org-src-container">
<pre class="src src-sh">Source0: nginx-1.0.12.tar.gz
Source1: nginx.conf
Source2: nginx.init
Source: http://www.123.com/%{name}-%{version}.tar.gz &#65283;&#26377;URL&#36830;&#25509;&#30340;&#19981;&#20250;&#30495;&#30340;&#19979;&#65292;&#32780;&#26159;&#25226;&#21069;&#38754;&#21435;&#25481;&#21482;&#30041;&#25991;&#20214;&#21517;
</pre>
</div>

<p>
如果源文件只有一个，去掉0，如果有多个就需要编号了0,1,2,&#x2026;
</p>

<p>
源文件必须位于SOURCES目录中
</p></li>

<li><p>
定义补丁名称
</p>

<div class="org-src-container">
<pre class="src src-sh">Patch1: httpd-2.2.22-pcre380.patch
Patch3: httpd-2.2.21-mod_proxy-change-state.patch
</pre>
</div>

<p>
可以使用patch命令打补丁
</p></li>
</ol>
</div>
</div>
<div id="outline-container-h:42781958-7adc-403b-a4f1-26e786113853" class="outline-5">
<h5 id="h:42781958-7adc-403b-a4f1-26e786113853">控制编译安装过程</h5>
<div class="outline-text-5" id="text-h:42781958-7adc-403b-a4f1-26e786113853">
<p>
<b>2.3.1 准备阶段 %prep</b>
</p>

<p>
作用：把源码包解压到%{_builddir}下，解压软件包到BUILD并cd进去，设定编
译前的变量
</p>

<p>
如果是对某归档格式的源程序制作rpm包，此段中经常要使用%setup来实现将源
码解压至%{_topdir}/BUILD目录中，并使用cd命令将制作过程的工作目录切换至
此解压后的源码目录。当然，%setup也有一些选项实现更进一步的设置。
</p>

<p>
%setup 一个宏来完成解压、设定环境、cd 进去
</p>

<p>
<b>精确控制展开方式 %setup 参数</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">-q <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38745;&#40664;&#27169;&#24335;&#65292;&#33267;&#23569;&#36755;&#20986;&#20449;&#24687;</span>
-n <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21578;&#35785;&#23637;&#24320;&#21518;&#30340;&#30446;&#24405;&#21517;&#31216;&#12290; &#22914;nagios-3.3.2.tar.gz &#65292;&#35299;&#21387;&#21518;&#25913;&#21517;&#20026;nagios-hahah</span>
-a number <span style="color: #b22222;"># </span><span style="color: #b22222;">after,&#20808;cd&#21040;&#30446;&#24405;&#35299;&#21387;&#32553;</span>
&#22914;,
Source0: a.tar.gz
Source1: b.tar.gz
Source2: nginx.tar.gz
%setup -q -a 0 -a 1   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20808;cd &#21040;&#30446;&#24405;&#19979;&#65292;&#20877;&#35299;&#21387;&#32553;&#65292;&#20250;&#26377;2&#20010;&#30446;&#24405;</span>

-b number <span style="color: #b22222;"># </span><span style="color: #b22222;">before,&#20808;&#23637;&#24320;&#20877;cd&#21040;&#30446;&#24405;</span>

&#22914;&#65292;
Source0: a.tar.gz
Source1: b.tar.gz
Source2: nginx.tar.gz
%setup -q -b 0 -b 1   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20808;&#23637;&#24320;&#20877;cd&#65292;&#20250;&#26377;1&#20010;&#30446;&#24405;</span>

-c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#19968;&#20010;&#30446;&#24405;&#65292;&#19968;&#33324;&#37197;&#21512;-b</span>
Name: nginx
Version: 1.0.14
mkdir %{BUILD}/nginx-1.0.14

-T <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#23637;&#24320;</span>
-D <span style="color: #b22222;">#</span><span style="color: #b22222;">do not delete the directory before unpacking</span>
</pre>
</div>


<p>
如，rpmbuild -bp : 仅执行至spec文件中的%prep阶段即停止进行；
</p>

<div class="org-src-container">
<pre class="src src-sh">[jasper@node01 SPECS]$ rpmbuild -bp nginx.spec
<span style="color: #0000ff;">Executing</span>(%prep): /bin/sh -e /var/tmp/rpm-tmp.TfvtrC
+ umask 022
+ cd /home/jasper/rpmbuild/BUILD
+ cd /home/jasper/rpmbuild/BUILD
+ rm -rf nginx-1.13.12
+ /usr/bin/gzip -dc /home/jasper/rpmbuild/SOURCES/nginx-1.13.12.tar.gz
+ /usr/bin/tar -xf -
+ <span style="color: #a0522d;">STATUS</span>=0
+ <span style="color: #8b2252;">'['</span> 0 -ne 0 <span style="color: #8b2252;">']'</span>
+ cd nginx-1.13.12
+ /usr/bin/chmod -Rf a+rX,u+w,g-w,o-w .
+ exit 0
[jasper@node01 SPECS]$ ls ~/rpmbuild/BUILD
nginx-1.13.12
[jasper@node01 SPECS]$ ls ~/rpmbuild/BUILD/nginx-1.13.12/
auto  CHANGES  CHANGES.ru  conf  configure  contrib  html  LICENSE  man  README  src

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23454;&#38469;&#30340;&#36807;&#31243;&#26159;</span>
[jasper@node01 ~]$ cd /home/jasper/rpmbuild/BUILD
[jasper@node01 BUILD]$ rm -fr nginx-1.13.12
[jasper@node01 BUILD]$ /usr/bin/gzip -dc /home/jasper/rpmbuild/SOURCES/nginx-1.13.12.tar.gz | tar -xf -
[jasper@node01 BUILD]$ ls
nginx-1.13.12
</pre>
</div>

<p>
如，使用rpmbuild &#x2013;clean 删除BUILD目录中内容
</p>

<div class="org-src-container">
<pre class="src src-sh">[jasper@node01 SPECS]$ rpmbuild --clean nginx.spec
warning: bogus date<span style="color: #a020f0;"> in</span> %changelog: Wed May 22 2018 jasperhsu <a href="mailto:xcwhome%40gmail.com">&lt;xcwhome@gmail.com&gt;</a> -1.13.12-2
<span style="color: #0000ff;">Executing</span>(--clean): /bin/sh -e /var/tmp/rpm-tmp.18hPfd
+ umask 022
+ cd /home/jasper/rpmbuild/BUILD
+ rm -rf nginx-1.13.12
+ exit 0
</pre>
</div>

<p>
如，
</p>

<div class="org-src-container">
<pre class="src src-sh">%prep
%setup -q
%patch       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25171;&#34917;&#19969; &#31532;&#19968;&#20010;&#34917;&#19969;%patch1,&#31532;&#20108;&#20010;&#34917;&#19969;%patch2&#65292;patch&#21629;&#20196;&#20351;&#29992;&#30340;&#21629;&#20196;&#37117;&#21487;&#20197;&#20351;&#29992;</span>
</pre>
</div>

<p>
<b>2.3.2 编译阶段 %build</b>
</p>

<p>
如果制作rpm包的源材料不是源程序，此段可以不用设置；
</p>

<p>
如果是C/C++等类的程序，此处对应于其编译安装过程中的“configure”和“make”两步；
</p>

<p>
如果是perl类的源程序，此处通常对应于其编译安装过程中的“perl Makefile.PL”和“make”两步。
</p>

<p>
然而，为了编译过程中的编译环境设定不出现问题，此处如果要用到configure
脚本时通常要使用宏%configure来替换。可以使用 <code>rpm --eval '%configure'</code>
命令来获取当前系统上%configure宏的相关定义。
</p>

<p>
示例
</p>

<div class="org-src-container">
<pre class="src src-sh">%build
./configure  --prefix=/usr<span style="color: #8b2252;">\</span>
--sysconfdir=/etc/nginx
make %{?_smp_mflags}    <span style="color: #b22222;">#</span><span style="color: #b22222;">smp&#23545;&#31216;&#22810;&#22788;&#29702;&#22120;&#65292;&#23439;&#23384;&#22312;&#21017;&#20351;&#29992;&#65292;&#21487;&#22810;&#26680;&#24182;&#34892;&#32534;&#35793;&#12290;?&#21495;&#34920;&#31034;&#21028;&#23450;&#65292;&#22914;&#26524;&#23439;&#23384;&#22312;&#21017;&#20351;&#29992;&#65292;&#19981;&#23384;&#22312;&#21017;&#19981;&#20351;&#29992;&#12290;</span>
</pre>
</div>

<p>
如，对于 perl 的编译
</p>

<div class="org-src-container">
<pre class="src src-sh">%build
perl Maifile PL
make
</pre>
</div>

<p>
-bc : 仅执行到spec文件中的%build阶段即停止进行；
</p>

<div class="org-src-container">
<pre class="src src-sh">[jasper@node01 SPECS]$ rpmbuild  -bc nginx.spec
</pre>
</div>

<p>
不是源码包不需要编译，留空
</p>

<p>
*2.3.3 安装阶段 %install*制作rpm时，所有要打包进rpm包的文件都需要事先
按照其计划最终安装在系统上的路径先安装至一个临时目录中，此临时目录做为
模拟的系统根目录，其通常称为BUILDROOT目录。此目录可以在spec文件中使用
“BuildRoot:”标签进行定义。因此，可以在后文中使用%{BuildRoot}引用，事
实上其也可以使用$RPM_BUILD_ROOT引用。
</p>

<p>
%install
</p>

<p>
for example
</p>

<div class="org-src-container">
<pre class="src src-sh">%install
rm -rf %{buildroot}   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21046;&#20316;&#36807;&#31243;&#21487;&#33021;&#37325;&#22797;&#22810;&#36941;&#30340;&#65292;&#36991;&#20813;&#19978;&#27425;&#23433;&#35013;&#30340;&#24433;&#21709;&#36825;&#27425;&#23601;&#35201;&#21024;&#38500;BUILDROOT&#30446;&#24405;&#30340;&#20013;&#25968;&#25454;</span>
make install <span style="color: #a0522d;">DESTDIR</span>=%{buildroot}  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#30446;&#26631;&#22320;&#22336;&#20026;%{buildroot}</span>
%{__install} -p -D -m 0644 %{SOURCE5} <span style="color: #8b2252;">\ </span>                    <span style="color: #b22222;"># </span><span style="color: #b22222;">install &#21629;&#20196;&#22797;&#21046;&#25991;&#20214; -d&#21019;&#24314;&#30446;&#24405;&#65292;-D&#25991;&#20214;&#25918;&#21040;&#25351;&#23450;&#30446;&#24405;&#19979;&#65292;&#19981;&#23384;&#22312;&#21017;&#21019;&#24314;&#12290;&#27880;&#24847;&#24341;&#29992;source5&#24517;&#39035;&#20840;&#22823;&#20889;&#12290;</span>
%{buildroot}%{_sysconfdir}/sysconfig/%{name}
%{__install} -p -d -m 0755 %{buildroot}/var/log/nginx
</pre>
</div>

<p>
<b>2.3.4 清理阶段 %clean</b>
</p>

<p>
可自行定义删除哪些 此段通常用于清理其它阶段的命令所创建的文件，比如
<code>rm -rf $RPM_BUILD_ROOT</code> 命令即为删除前次制作rpm包时安装生的BUILDROOT
目录。
</p>

<p>
for example
</p>

<div class="org-src-container">
<pre class="src src-sh">%clean
rm -fr %{buildroot}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6d5fea45-2645-4a6b-a345-0cc3ecceb9b0" class="outline-5">
<h5 id="h:6d5fea45-2645-4a6b-a345-0cc3ecceb9b0">脚本段</h5>
<div class="outline-text-5" id="text-h:6d5fea45-2645-4a6b-a345-0cc3ecceb9b0">
<p>
shell脚本
</p>

<ul class="org-ul">
<li>%pre 安装前执行的脚本</li>
<li>%post 安装后执行的脚本</li>
<li>%preun 卸载前执行的脚本</li>
<li>%postun 卸载后执行的脚本</li>
</ul>

<p>
<b>2.4.1 脚本中的判断动作</b>
</p>

<p>
$1 处理类型或安装类型，1为安装，2-9为升级，0为卸载
</p>

<p>
for example
</p>

<div class="org-src-container">
<pre class="src src-sh">%pre
<span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">1</span> == 1 ]; <span style="color: #a020f0;">then</span>
    /usr/sbin/useradd  -s /bin/false -r  nginx 2&gt;/dev/null || :
<span style="color: #a020f0;">fi</span>
%post
<span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">1</span> == 1 ]; <span style="color: #a020f0;">then</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">/sbin/chkconfig --add %{name}</span>
    /usr/bin/systemctl daemon-reload
    /usr/bin/systemctl enable %{name}
<span style="color: #a020f0;">fi</span>
%preun
<span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">1</span> = 0 ]; <span style="color: #a020f0;">then</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">/sbin/service %{name} stop &gt;/dev/null 2&gt;&amp;1</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">/sbin/chkconfig --del %{name}</span>
    /usr/bin/systemctl stop %{name}
    /usr/bin/systemctl disable %{name}
<span style="color: #a020f0;">fi</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:93f62913-31a8-4197-b70d-3477fdbcfde5" class="outline-5">
<h5 id="h:93f62913-31a8-4197-b70d-3477fdbcfde5">文件段，列出的文件 %files</h5>
<div class="outline-text-5" id="text-h:93f62913-31a8-4197-b70d-3477fdbcfde5">
<p>
任何在RPM包中的文件都需要列出来，且文件在%{buildroot}下必须有
</p>

<ol class="org-ol">
<li><p>
直接指定单个文件
</p>

<div class="org-src-container">
<pre class="src src-sh">%files
/usr/sbin/nginx
/etc/nginx/nginx.conf
</pre>
</div></li>

<li><p>
使用glob 通配符
</p>

<div class="org-src-container">
<pre class="src src-sh">%files
/usr/sbin/nginx
/etc/nginx/nginx.*
</pre>
</div></li>

<li><p>
包含目录下所有文件
</p>

<div class="org-src-container">
<pre class="src src-sh">%files
/usr/sbin/nginx
/etc/nginx/
</pre>
</div></li>

<li><p>
设定文件属性
</p>

<div class="org-src-container">
<pre class="src src-sh">%attr(mode, user, group)              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25991;&#20214;&#20855;&#26377;&#30340;&#26435;&#38480;&#23646;&#24615;</span>
</pre>
</div>

<p>
使用默认的用”-“表示 %attr(-, root, -) /etc/nginx/nginx.conf
</p>

<p>
多个控制指令一起用 %config %attr(-,root,-) /etc/nginx/nginx.conf
​既是配置文件又有文件属性
</p>

<div class="org-src-container">
<pre class="src src-sh">%defattr(&#25991;&#20214;&#26435;&#38480;,&#29992;&#25143;&#21517;,&#32452;&#21517;,&#30446;&#24405;&#26435;&#38480;) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#40664;&#35748;&#26435;&#38480;&#65292;</span>
</pre>
</div>

<p>
示例
</p>
<div class="org-src-container">
<pre class="src src-sh">%files
%defattr(-,root,root,-)
%doc LICENSE CHANGES README
/usr/sbin/nginx
%attr(0755, root, root) %{_unitdir}/%{name}.service
</pre>
</div></li>

<li><p>
文件控制符
</p>

<p>
路径名不要写buildroot，buildroot路径下从什么路径开始写什么路径 。
</p>

<div class="org-src-container">
<pre class="src src-sh">%doc: &#25991;&#20214;&#34987;&#24403;&#20570;&#25991;&#26723;&#65292;&#22914;&#26524;&#32473;&#20986;&#32477;&#23545;&#36335;&#24452;&#65292;&#25991;&#20214;&#25918;&#22312;&#35813;&#36335;&#24452;&#19979;&#65307;&#22914;&#26524;&#19981;&#32473;&#32477;&#23545;&#36335;&#24452;&#65292;&#25918;&#22312;/usr/share/doc/%{name}-%{version}&#30446;&#24405;&#19979;
%dir: &#21482;&#35748;&#30446;&#24405;&#65292;&#19981;&#35782;&#21035;&#37324;&#38754;&#30340;&#25991;&#20214;&#65292;
%docdir: &#30446;&#24405;&#20013;&#25152;&#26377;&#20869;&#23481;&#37117;&#20316;&#20026;&#25991;&#26723;
%config(noreplace | missingok): &#25991;&#20214;&#24403;&#20570;&#37197;&#32622;&#25991;&#20214;&#12290;&#21518;&#36319;&#25324;&#21495;&#20013;&#21152;&#21442;&#25968;&#65292;

&#20854;&#20013;&#65306;
%config(missingok) :
&#27492;&#20462;&#39280;&#31526;&#35774;&#23450;&#25991;&#20214;&#31867;&#22411;&#20026;&#37197;&#32622;&#25991;&#20214;,&#19988;&#27492;&#25991;&#20214;&#21487;&#20002;&#22833;&#12290;&#21363;&#20351;&#20002;&#22833;&#20102;,RPM&#22312;&#21368;&#36733;&#36719;&#20214;&#21253;&#26102;&#24182;&#19981;&#35748;&#20026;&#36825;&#26159;&#20010;&#38169;&#35823;,&#24182;&#19981;&#25253;&#38169;&#12290;
%config(noreplace) :
&#27492;&#20462;&#39280;&#31526;&#35774;&#23450;&#25991;&#20214;&#31867;&#22411;&#20026;&#37197;&#32622;&#25991;&#20214;,&#19988;&#22914;&#26524;&#23433;&#35013;&#26102;&#31995;&#32479;&#20013;&#26377;&#21516;&#21517;&#30340;&#25991;&#20214;,&#21017;&#36719;&#20214;&#21253;&#20013;&#30340;&#36825;&#20010;&#25991;&#20214;&#23558;&#25442;&#20010;&#21517;&#23383;&#23433;&#35013;,&#20854;&#25991;&#20214;&#21517;&#21518;&#32512;&#21152;&#20010;.rpmnew&#12290;&#23545;&#24050;&#25913;&#21464;&#30340;&#20869;&#23481;&#19981;&#20570;&#26367;&#25442;&#65292;&#26032;&#30340;&#21483;.rpmnew&#65307;

&#20363;&#65306;
&#22914;&#25551;&#36848;&#25991;&#20214;&#30340;&#25991;&#20214;&#27573;&#20013;&#23450;&#20041;&#20102;&#36825;&#20040;&#19968;&#34892;:
%config(noreplace) /etc/test
&#21017;&#21046;&#25104;&#30340;&#21253;&#22312;&#23433;&#35013;&#26102;,&#33509;&#31995;&#32479;&#20013;&#24050;&#26377;&#27492;&#25991;&#20214;/etc/test,&#21017;RPM&#20250;&#25552;&#31034;:
warning: /etc/test created as /etc/test.rpmnew
</pre>
</div>

<p>
for example
</p>

<div class="org-src-container">
<pre class="src src-sh">%dir /etc/nginx  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21482;&#35748;&#30446;&#24405;&#65292;&#19981;&#35782;&#21035;&#37324;&#38754;&#30340;&#25991;&#20214;&#65292;</span>
%config(noreplace) /etc/nginx/win-utf <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26631;&#26126;&#26159;&#37197;&#32622;&#25991;&#20214;&#65292;&#26377;&#20004;&#20010;&#21442;&#25968;noreplace&#65292;missingok,&#65292;noreplace&#19981;&#26367;&#25442;&#24050;&#25913;&#21464;&#30340;&#25991;&#20214;,&#29983;&#25104;&#30340;&#25991;&#20214;&#19982;&#21407;&#26377;&#30340;&#26377;&#20914;&#31361;&#20102;&#19981;&#26367;&#25442;&#21407;&#25991;&#20214;&#65292;&#29983;&#25104;.rpmnew&#25991;&#20214;,&#26032;&#26087;&#29256;&#26412;&#19981;&#20860;&#23481;&#65292;&#26087;&#25991;&#20214;&#23601;&#19994;.orig</span>
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-h:21eb0f66-bbf0-4c4a-a165-a169bd9a21d7" class="outline-5">
<h5 id="h:21eb0f66-bbf0-4c4a-a165-a169bd9a21d7">changlog改变日志段 %changelog</h5>
<div class="outline-text-5" id="text-h:21eb0f66-bbf0-4c4a-a165-a169bd9a21d7">
<p>
此段中用于定义当前spec文件每一次改进的作者及改进的相关说明信息。
</p>

<p>
%changelog
</p>

<ul class="org-ul">
<li>date +"%a %b %d %Y" 修改人 邮箱 本次版本x.y.z-p</li>
<li>本次变更修改了那些内容</li>
</ul>

<p>
for example
</p>

<div class="org-src-container">
<pre class="src src-sh">* Tue Jul 23 2013 Petr Pisar <a href="mailto:ppisar%40redhat.com">&lt;ppisar@redhat.com&gt;</a> - 6.04-2
- Perl 5.18 rebuild

* Thu May 02 2013 Petr Pisar <a href="mailto:ppisar%40redhat.com">&lt;ppisar@redhat.com&gt;</a> - 6.04-1
- 6.04 bump <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26412;&#27425;&#21464;&#26356;&#20462;&#25913;&#20102;&#37027;&#20123;&#20869;&#23481;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a118878a-0abc-4706-b96a-f9234488bb64" class="outline-5">
<h5 id="h:a118878a-0abc-4706-b96a-f9234488bb64">如何在spec文件中使用宏</h5>
<div class="outline-text-5" id="text-h:a118878a-0abc-4706-b96a-f9234488bb64">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#23439;</span>
%define nginx_user       nginx
%define nginx_group      %{nginx_user}
%define nginx_confdir    /etc/nginx

... ...

%build
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">DESTDIR</span>=%{buildroot}
./configure <span style="color: #8b2252;">\</span>
  --sbin-path=/usr/sbin/nginx <span style="color: #8b2252;">\</span>
  --conf-path=/etc/nginx/nginx.conf <span style="color: #8b2252;">\</span>
  --error-log-path=/var/log/nginx/error.log <span style="color: #8b2252;">\</span>
  --http-log-path=/var/log/nginx/access.log <span style="color: #8b2252;">\</span>
  --pid-path=/var/run/nginx/nginx.pid  <span style="color: #8b2252;">\</span>
  --lock-path=/var/lock/nginx.lock <span style="color: #8b2252;">\</span>
  --user=%{nginx_user} <span style="color: #8b2252;">\</span>
  --group=%{nginx_group} <span style="color: #8b2252;">\</span>
  --with-http_ssl_module <span style="color: #8b2252;">\</span>
  --with-http_flv_module <span style="color: #8b2252;">\</span>
  --with-http_stub_status_module <span style="color: #8b2252;">\</span>
  --with-http_gzip_static_module <span style="color: #8b2252;">\</span>
  --with-pcre
make %{?_smp_mflags}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:9aea5127-5c75-4cc8-93ae-7d4ea62ba8c5" class="outline-4">
<h4 id="h:9aea5127-5c75-4cc8-93ae-7d4ea62ba8c5">RPM包签名</h4>
<div class="outline-text-4" id="text-h:9aea5127-5c75-4cc8-93ae-7d4ea62ba8c5">
<p>
验证 rpm 的 md5码
</p>

<div class="org-src-container">
<pre class="src src-sh">rpm -K &#21253;&#21517;
</pre>
</div>

<p>
首先说下 PGP，它能实现签名、加密和解密，是个商业产品。 后来有了实现规
范RFC 4880 规范，才有了 GnuPG，简称GPG. rpm包签名使用的是gpg命令
</p>

<ol class="org-ol">
<li><p>
gpg &#x2013;gen-key 生成GPG签名密钥 我用的是root用户
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]$ gpg --gen-key
Your selection?1&lt;Enter&gt;                       <span style="color: #b22222;">##</span><span style="color: #b22222;">&#40664;&#35748;&#21363;&#21487;</span>
What keysize<span style="color: #a020f0;"> do</span> you want? (2048) 1024&lt;Enter&gt;  <span style="color: #b22222;">##</span><span style="color: #b22222;">&#23494;&#38053;&#38271;&#24230;&#65292;&#26377;&#26102;&#21487;&#33021;&#22240;&#20026;&#38543;&#26426;&#25968;&#19981;&#22815;&#23548;&#33268;&#21345;&#22312;&#37027;&#37324;&#65292;&#36825;&#26102;&#20505;&#20320;&#23601;yum &#23433;&#35013;&#20960;&#20010;&#21253;&#32452;&#65292;&#39532;&#19978;&#23601;&#22815;&#20102;</span>
Key is valid for? (0) 1y&lt;Enter&gt;               <span style="color: #b22222;">##</span><span style="color: #b22222;">&#26377;&#25928;&#26399; 0&#20026;&#27704;&#20037;&#26377;&#25928;</span>
Is this correct? (y/N) y&lt;Enter&gt;               <span style="color: #b22222;">##</span><span style="color: #b22222;">&#30830;&#35748;</span>
Real name: Jasper Hsu&lt;Enter&gt;                  <span style="color: #b22222;">##</span><span style="color: #b22222;">&#23494;&#38053;&#21517;&#31216;&#65292;5&#20010;&#23383;&#31526;&#20197;&#19978;</span>
Email address:xcwhome@gmail.com&lt;Enter&gt;        <span style="color: #b22222;">##</span><span style="color: #b22222;">&#37038;&#20214;</span>
Comment: GPG-RPM-KEY&lt;Enter&gt;                   <span style="color: #b22222;">##</span><span style="color: #b22222;">&#22791;&#27880;</span>

You selected this USER-ID:
<span style="color: #8b2252;">"Jasper Hsu <a href="mailto:xcwhome%40gmail.com">&lt;xcwhome@gmail.com&gt;</a>"</span>
<span style="color: #0000ff;">Change</span> (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O&lt;ENTER&gt;   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#37324;&#19968;&#23450;&#36319; .rpmmacros &#20013; %_gpg_name &#20540;&#20445;&#25345;&#19968;&#33268;</span>
Enter passphrase  OK &lt;Enter&gt;     <span style="color: #b22222;">##</span><span style="color: #b22222;">&#20351;&#29992;&#31354;&#23494;&#30721;&#65292;&#20063;&#21487;&#20197;&#36755;&#20837;                             </span>
&lt;Take this one anyway&gt; &lt;Enter&gt;
&lt;Take this one anyway&gt; &lt;Enter&gt;
</pre>
</div>

<p>
最后这个界面比较搞笑，让你随意移动鼠标，敲击键盘，收集足够的随机字
符，产生密钥。
</p></li>

<li><p>
gpg &#x2013;list-keys 查看成生的密钥
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# gpg --list-keys
/root/.gnupg/pubring.gpg
------------------------
pub   1024R/682F2811 2018-05-24
uid                  Jasper Hsu <a href="mailto:xcwhome%40gmail.com">&lt;xcwhome@gmail.com&gt;</a>
sub   1024R/DDF7F2D6 2018-05-24
</pre>
</div></li>

<li><p>
gpg &#x2013;export -a "Jasper Hsu" &gt; RPM-GPG-KEY-NAME
把密钥中的公钥提取出来，以供大家使用验证。
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# gpg --export -a <span style="color: #8b2252;">'Jasper Hsu'</span> &gt;RPM-GPG-KEY-Jasper
</pre>
</div>

<p>
-a : 以 assii码方式导出 文件名称可以随意取
</p></li>

<li><p>
编缉
.rpmmacros说明我们用哪一个密钥加密,我们用root加密的那就在/root下编辑
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# cat ~/.rpmmacros
%_signature gpg
%_gpg_name Jasper Hsu
</pre>
</div></li>

<li><p>
rpm &#x2013;addsign tengine-1.4.2-1.el6.x86_64.rpm 为rpm包加签名
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# rpm --addsign /home/jasper/rpmbuild/RPMS/x86_64/nginx-1.13.12-2.el7.centos.x86_64.rpm
Enter pass phrase:   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20837;&#23494;&#30721;</span>
Pass phrase is good.
/home/jasper/rpmbuild/RPMS/x86_64/nginx-1.13.12-2.el7.centos.x86_64.rpm:
</pre>
</div>

<p>
到此签名添加成功，下面来验证
</p>

<p>
如报错: rpm: /usr/bin/rpmsign: No such file or directory
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# yum install rpm-sign


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37325;&#31614;</span>
rpm --resign &#21253;&#21517;
</pre>
</div></li>

<li><p>
将刚才导出的公钥导入rpm中
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# cp RPM-GPG-KEY-Jasper  /tmp/
[root@node01 ~]# cp /home/jasper/rpmbuild/RPMS/x86_64/nginx-1.13.12-2.el7.centos.x86_64.rpm  /tmp/

[root@node01 ~]# rpm --import /tmp/RPM-GPG-KEY-Jasper
</pre>
</div></li>
</ol>


<ol class="org-ol">
<li><p>
验证
</p>

<div class="org-src-container">
<pre class="src src-sh">rpm --checksig tengine-1.4.2-1.el6.x86_64.rpm 

[root@node01 ~]# rpm -K /tmp/nginx-1.13.12-2.el7.centos.x86_64.rpm
/tmp/nginx-1.13.12-2.el7.centos.x86_64.rpm: RSA sha1 ((MD5) PGP) md5 NOT OK (MISSING KEYS: (MD5) PGP#036049ba)

[root@node01 ~]# rpm -qpi /tmp/nginx-1.13.12-2.el7.centos.x86_64.rpm
warning: /tmp/nginx-1.13.12-2.el7.centos.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID 036049ba: NOKEY
Name        : nginx
Signature   : RSA/SHA1, Thu 24 May 2018 08:51:10 PM CST, Key ID 2573f8ee036049ba
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-h:0a27839a-f3b4-42b2-8a3a-dc002bddcd71" class="outline-4">
<h4 id="h:0a27839a-f3b4-42b2-8a3a-dc002bddcd71">RPM拆包</h4>
<div class="outline-text-4" id="text-h:0a27839a-f3b4-42b2-8a3a-dc002bddcd71">
<p>
在原spec 文件加入定义子包的信息
</p>

<div class="org-src-container">
<pre class="src src-sh">%package       libs    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;libs&#23376;&#21253;   </span>
Summary:        XXXX
Group:            Development/Libraries 
Requires:        %{name}  = %{version}  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;&#26102;&#20381;&#36182;&#20027;&#21253;</span>
%description   libs    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#25551;&#36848;&#20449;&#24687;</span>
sljfljl 

%pres libs     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23376;&#21253;&#30340;&#33050;&#26412;</span>
....

%files  libs     
</pre>
</div>
</div>
<div id="outline-container-h:eb9ce5f0-b998-4060-84f3-0c421a94d2f7" class="outline-5">
<h5 id="h:eb9ce5f0-b998-4060-84f3-0c421a94d2f7">必选功能段</h5>
<div class="outline-text-5" id="text-h:eb9ce5f0-b998-4060-84f3-0c421a94d2f7">
</div>
<ul class="org-ul">
<li><a id="h:8d2208a3-5ec4-49f2-9c3c-5c8c59a8ce7f"></a>%description<br>
<div class="outline-text-6" id="text-h:8d2208a3-5ec4-49f2-9c3c-5c8c59a8ce7f">
<p>
本段是描述段,段的内容是对软件包进行较为详细的介绍,不像文件头的Summary
域仅用一句话说明。
</p>

<p>
此域描述格式有三种:
</p>

<p>
1.%description [子包选项]
</p>

<p>
本功能段描述的内容是关于父包的。它用软件名来命令,其名字格式是：软件名-
版本号-发布序列号.体系.rpm
</p>

<p>
例：test-1.0-1.i386.rpm
</p>

<p>
2.%description [子包选项]
</p>

<p>
子包选项中没有-n选项时,子包是用软件名
加子包名的形式命名。
</p>

<p>
格式为: 软件名-子包名-版本号-发布序列号.体系.rpm
</p>

<p>
例：分成两个子包的test软件: test-bin-1.0-1.i386.rpm(执行程序包)
test-config-1.0-1.i386.rpm(配置文件包)
</p>

<p>
3.%description -n 子包名
</p>

<p>
本功能段描述的内容也是关于子包的。当子包选项中有-n选项时,子包直接采用子包名的形式命名。
</p>

<p>
它不包含软件名,命名格式为: 子包名-版本号-发布序列号.体系.rpm
</p>

<p>
例：:分成两个子包的test软件: bin-1.0-1.i386.rpm(执行程序包)
config-1.0-1.i386.rpm(配置文件包)
</p>

<p>
必选功能段
</p>
</div>
</li>
<li><a id="h:c598509f-54d8-4cef-802d-5e245af8b161"></a>%files<br>
<div class="outline-text-6" id="text-h:c598509f-54d8-4cef-802d-5e245af8b161">
<p>
本段是文件段,它定义的是软件包需要包含哪些文件。
</p>

<p>
本段段名描述格式格式为:
%files [子包选项] [-f 文件名]
</p>

<p>
当没有任何选项时,本段内容定义的是父包要打包的文件列表;
</p>

<p>
当有子包选项时,本段内容定义的则是子包要打包的文件列表;
</p>

<p>
文件段的内容格式为: [修饰符1 [修饰符2] &#x2026;] 文件名
</p>

<p>
其中:修饰符是可选的,一个文件可以有多个修饰符,文件名必须以/开头(绝对路径形式)
</p>

<p>
子软件包
</p>

<p>
一个RPM的软件包描述文件,可以仅生成一个父包或一个子包,也可以生成一个父
包和多个子包。通过设定子包选项,可以使生成的子包采用”软件名-子包名”的
标准命名,也可使生成的子包采用自己的名字。
</p>

<p>
要想创建子软件包,必须描述%package、Summary、Group、%description、%files。
以上几种内容前面已经介绍，此处就不再赘述。 注:更多用法请查看教材SPEC详解
</p>

<p>
如，
</p>


<figure id="org99eb66c">
<img src="images/image-20210216015743732.png" alt="image-20210216015743732.png" width="60%">

</figure>

<p>
经验之谈
</p>
<ol class="org-ol">
<li><p>
编译完成后不检查依赖
</p>

<p>
AutoReqProv: no
</p></li>

<li><p>
不生成debuginfo
</p>

<p>
%define debug_package %{nil}
</p></li>
<li><p>
删除rpm软件后,目录如何销毁
</p>

<p>
在%file段落内的文件,在删除软件后,都会自动销毁.
</p>

<p>
如果在%post段落创建文件,则需要在%postun段落,单独执行删除命令
</p></li>

<li><p>
手动解压
</p>

<p>
在%prep段落,如果%setup函数的解压效果不能满足需求,可手动执行tar zxvf
或者gunzip命令解压
</p></li>
</ol>


<div class="org-src-container">
<pre class="src src-sh">[root@node01 openvswitch-2.5.9]# cat rhel/openvswitch-fedora.spec
<span style="color: #b22222;"># </span><span style="color: #b22222;">rpmbuild -bb --without check rhel/openvswitch-fedora.spec</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">%define kernel 2.6.40.4-5.fc15.x86_64</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">If libcap-ng isn't available and there is no need for running OVS</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">as regular user, specify the '--without libcapng'</span>
%bcond_without libcapng
<span style="color: #b22222;"># </span><span style="color: #b22222;">To enable DPDK support, specify '--with dpdk' when building</span>
%bcond_with dpdk

<span style="color: #b22222;"># </span><span style="color: #b22222;">Enable PIE, bz#955181</span>
%global _hardened_build 1

<span style="color: #b22222;"># </span><span style="color: #b22222;">some distros (e.g: RHEL-7) don't define _rundir macro yet</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Fedora 15 onwards uses /run as _rundir</span>
%if 0%{!?_rundir:1}
%define _rundir /run
%endif

Name: openvswitch
Summary: Open vSwitch
Group: System Environment/Daemons
URL: http://www.openvswitch.org/
Version: 2.5.9

<span style="color: #b22222;"># </span><span style="color: #b22222;">Nearly all of openvswitch is ASL 2.0.  The bugtool is LGPLv2+, and the</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">lib/sflow*.[ch] files are SISSL</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">datapath/ is GPLv2 (although not built into any of the binary packages)</span>
License: ASL 2.0 and LGPLv2+ and SISSL
Release: 1%{?dist}
Source: http://openvswitch.org/releases/%{name}-%{version}.tar.gz

BuildRequires: autoconf automake libtool
BuildRequires: systemd-units openssl openssl-devel
BuildRequires: python python-twisted-core python-zope-interface PyQt4
BuildRequires: desktop-file-utils
BuildRequires: groff graphviz
BuildRequires: checkpolicy, selinux-policy-devel
<span style="color: #b22222;"># </span><span style="color: #b22222;">make check dependencies</span>
BuildRequires: procps-ng
%if %{with libcapng}
BuildRequires: libcap-ng libcap-ng-devel
%endif
%if %{with dpdk}
BuildRequires: dpdk-devel &gt;= 2.2.0
Provides: %{name}-dpdk = %{version}-%{release}
%endif

Requires: openssl iproute module-init-tools
<span style="color: #b22222;">#</span><span style="color: #b22222;">Upstream kernel commit 4f647e0a3c37b8d5086214128614a136064110c3</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">Requires: kernel &gt;= 3.15.0-0</span>

<span style="color: #0000ff;">Requires</span>(post): systemd-units
<span style="color: #0000ff;">Requires</span>(preun): systemd-units
<span style="color: #0000ff;">Requires</span>(postun): systemd-units
Obsoletes: openvswitch-controller &lt;= 0:2.1.0-1

%bcond_without check

%description
Open vSwitch provides standard network bridging functions and
support for the OpenFlow protocol for remote per-flow control of
traffic.

%package selinux-policy
Summary: Open vSwitch SELinux policy
License: ASL 2.0
BuildArch: noarch
Requires: selinux-policy-targeted

%description selinux-policy
Tailored Open vSwitch SELinux policy

%package -n python-openvswitch
Summary: Open vSwitch python bindings
License: ASL 2.0
BuildArch: noarch
Requires: python

%description -n python-openvswitch
Python bindings for the Open vSwitch database

%package test
Summary: Open vSwitch testing utilities
License: ASL 2.0
BuildArch: noarch
Requires: python-openvswitch = %{version}-%{release}
Requires: python python-twisted-core python-twisted-web

%description test
Utilities that are useful to diagnose performance and connectivity
issues<span style="color: #a020f0;"> in</span> Open vSwitch setup.

%package devel
Summary: Open vSwitch OpenFlow development package (library, headers)
License: ASL 2.0
Provides: openvswitch-static = %{version}-%{release}

%description devel
This provides static library, libopenswitch.a and the openvswitch header
files needed to build an external application.

%package ovn
Summary: Open vSwitch - Open Virtual Network support
License: ASL 2.0
Requires: openvswitch

%description ovn
OVN, the Open Virtual Network, is a system to support virtual network
abstraction.  OVN complements the existing capabilities of OVS to add
native support for virtual network abstractions, such as virtual L2 and L3
overlays and security groups.


%prep
%setup -q

%build
%configure <span style="color: #8b2252;">\</span>
%if %{with libcapng}
    --enable-libcapng <span style="color: #8b2252;">\</span>
%else
    --disable-libcapng <span style="color: #8b2252;">\</span>
%endif
%if %{with dpdk}
    --with-dpdk=$(<span style="color: #ff00ff;">dirname %{_datadir}/dpdk/*/.config</span>) <span style="color: #8b2252;">\</span>
%endif
    --enable-ssl <span style="color: #8b2252;">\</span>
    --with-pkidir=%{_sharedstatedir}/openvswitch/pki

make %{?_smp_mflags}
<span style="color: #483d8b;">cd</span> selinux
make -f %{_datadir}/selinux/devel/Makefile

%install
rm -rf $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>
make install <span style="color: #a0522d;">DESTDIR</span>=$<span style="color: #a0522d;">RPM_BUILD_ROOT</span>

install -d -m 0755 $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{_sysconfdir}/openvswitch

install -p -D -m 0644 <span style="color: #8b2252;">\</span>
        rhel/usr_share_openvswitch_scripts_systemd_sysconfig.template <span style="color: #8b2252;">\</span>
        $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>/%{_sysconfdir}/sysconfig/openvswitch
<span style="color: #a020f0;">for</span> service<span style="color: #a020f0;"> in</span> openvswitch ovsdb-server ovs-vswitchd <span style="color: #8b2252;">\</span>
        ovn-controller ovn-controller-vtep ovn-northd; <span style="color: #a020f0;">do</span>
    install -p -D -m 0644 <span style="color: #8b2252;">\</span>
            rhel/usr_lib_systemd_system_${<span style="color: #a0522d;">service</span>}.service <span style="color: #8b2252;">\</span>
            $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{_unitdir}/${<span style="color: #a0522d;">service</span>}.service
<span style="color: #a020f0;">done</span>
install -m 0755 rhel/etc_init.d_openvswitch <span style="color: #8b2252;">\</span>
        $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{_datadir}/openvswitch/scripts/openvswitch.init

install -p -D -m 0644 rhel/etc_logrotate.d_openvswitch <span style="color: #8b2252;">\</span>
        $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>/%{_sysconfdir}/logrotate.d/openvswitch

install -m 0644 vswitchd/vswitch.ovsschema <span style="color: #8b2252;">\</span>
        $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>/%{_datadir}/openvswitch/vswitch.ovsschema

install -d -m 0755 $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>/%{_sysconfdir}/sysconfig/network-scripts/
install -p -m 0755 rhel/etc_sysconfig_network-scripts_ifdown-ovs <span style="color: #8b2252;">\</span>
        $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>/%{_sysconfdir}/sysconfig/network-scripts/ifdown-ovs
install -p -m 0755 rhel/etc_sysconfig_network-scripts_ifup-ovs <span style="color: #8b2252;">\</span>
        $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>/%{_sysconfdir}/sysconfig/network-scripts/ifup-ovs

install -d -m 0755 $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{python_sitelib}
mv $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>/%{_datadir}/openvswitch/python/* <span style="color: #8b2252;">\</span>
   $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{python_sitelib}
rmdir $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>/%{_datadir}/openvswitch/python/

install -d -m 0755 $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>/%{_sharedstatedir}/openvswitch

touch $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{_sysconfdir}/openvswitch/conf.db
touch $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{_sysconfdir}/openvswitch/system-id.conf

install -p -m 644 -D selinux/openvswitch-custom.pp <span style="color: #8b2252;">\</span>
        $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{_datadir}/selinux/packages/%{name}/openvswitch-custom.pp

<span style="color: #b22222;"># </span><span style="color: #b22222;">remove unpackaged files</span>
rm -f $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{_bindir}/ovs-benchmark <span style="color: #8b2252;">\</span>
        $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{_bindir}/ovs-parse-backtrace <span style="color: #8b2252;">\</span>
        $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{_bindir}/ovs-pcap <span style="color: #8b2252;">\</span>
        $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{_bindir}/ovs-tcpundump <span style="color: #8b2252;">\</span>
        $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{_sbindir}/ovs-vlan-bug-workaround <span style="color: #8b2252;">\</span>
        $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{_mandir}/man1/ovs-benchmark.1 <span style="color: #8b2252;">\</span>
        $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{_mandir}/man1/ovs-pcap.1 <span style="color: #8b2252;">\</span>
        $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{_mandir}/man1/ovs-tcpundump.1 <span style="color: #8b2252;">\</span>
        $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{_mandir}/man8/ovs-vlan-bug-workaround.8 <span style="color: #8b2252;">\</span>
        $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>%{_datadir}/openvswitch/scripts/ovs-save

%check
%if %{with check}
    <span style="color: #a020f0;">if</span> make check <span style="color: #a0522d;">TESTSUITEFLAGS</span>=<span style="color: #8b2252;">'%{_smp_mflags}'</span> <span style="color: #a0522d;">RECHECK</span>=yes; <span style="color: #a020f0;">then</span> :;
    <span style="color: #a020f0;">else</span>
        cat tests/testsuite.log
        <span style="color: #a020f0;">exit</span> 1
    <span style="color: #a020f0;">fi</span>
%endif

%clean
rm -rf $<span style="color: #a0522d;">RPM_BUILD_ROOT</span>

%preun
%if 0%{?systemd_preun:1}
    %systemd_preun %{name}.service
%else
    <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">1</span> -eq 0 ] ; <span style="color: #a020f0;">then</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">Package removal, not upgrade</span>
        /bin/systemctl --no-reload disable %{name}.service &gt;/dev/null 2&gt;&amp;1 || :
        /bin/systemctl stop %{name}.service &gt;/dev/null 2&gt;&amp;1 || :
    <span style="color: #a020f0;">fi</span>
%endif

%preun ovn
%if 0%{?systemd_preun:1}
    %systemd_preun ovn-controller.service
    %systemd_preun ovn-controller-vtep.service
    %systemd_preun ovn-northd.service
%else
    <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">1</span> -eq 0 ] ; <span style="color: #a020f0;">then</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">Package removal, not upgrade</span>
        /bin/systemctl --no-reload disable ovn-controller.service &gt;/dev/null 2&gt;&amp;1 || :
        /bin/systemctl stop ovn-controller.service &gt;/dev/null 2&gt;&amp;1 || :
        /bin/systemctl --no-reload disable ovn-controller-vtep.service &gt;/dev/null 2&gt;&amp;1 || :
        /bin/systemctl stop ovn-controller-vtep.service &gt;/dev/null 2&gt;&amp;1 || :
        /bin/systemctl --no-reload disable ovn-northd.service &gt;/dev/null 2&gt;&amp;1 || :
        /bin/systemctl stop ovn-northd.service &gt;/dev/null 2&gt;&amp;1 || :
    <span style="color: #a020f0;">fi</span>
%endif

%post
%if 0%{?systemd_post:1}
    %systemd_post %{name}.service
%else
    <span style="color: #b22222;"># </span><span style="color: #b22222;">Package install, not upgrade</span>
    <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">1</span> -eq 1 ]; <span style="color: #a020f0;">then</span>
        /bin/systemctl daemon-reload &gt;dev/null || :
    <span style="color: #a020f0;">fi</span>
%endif

%post ovn
%if 0%{?systemd_post:1}
    %systemd_post ovn-controller.service
    %systemd_post ovn-controller-vtep.service
    %systemd_post ovn-northd.service
%else
    <span style="color: #b22222;"># </span><span style="color: #b22222;">Package install, not upgrade</span>
    <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">1</span> -eq 1 ]; <span style="color: #a020f0;">then</span>
        /bin/systemctl daemon-reload &gt;dev/null || :
    <span style="color: #a020f0;">fi</span>
%endif

%post selinux-policy
/usr/sbin/semodule -i %{_datadir}/selinux/packages/%{name}/openvswitch-custom.pp &amp;&gt; /dev/null || :

%postun
%if 0%{?systemd_postun:1}
    %systemd_postun %{name}.service
%else
    /bin/systemctl daemon-reload &gt;/dev/null 2&gt;&amp;1 || :
%endif

%postun ovn
%if 0%{?systemd_postun_with_restart:1}
    %systemd_postun_with_restart ovn-controller.service
    %systemd_postun_with_restart ovn-controller-vtep.service
    %systemd_postun_with_restart ovn-northd.service
%else
    /bin/systemctl daemon-reload &gt;/dev/null 2&gt;&amp;1 || :
    <span style="color: #a020f0;">if</span> [ <span style="color: #8b2252;">"$1"</span> -ge <span style="color: #8b2252;">"1"</span> ] ; <span style="color: #a020f0;">then</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">Package upgrade, not uninstall</span>
        /bin/systemctl try-restart ovn-controller.service &gt;/dev/null 2&gt;&amp;1 || :
        /bin/systemctl try-restart ovn-controller-vtep.service &gt;/dev/null 2&gt;&amp;1 || :
        /bin/systemctl try-restart ovn-northd.service &gt;/dev/null 2&gt;&amp;1 || :
    <span style="color: #a020f0;">fi</span>
%endif

%postun selinux-policy
<span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">1</span> -eq 0 ] ; <span style="color: #a020f0;">then</span>
  /usr/sbin/semodule -r openvswitch-custom &amp;&gt; /dev/null || :
<span style="color: #a020f0;">fi</span>

%files selinux-policy
%defattr(-,root,root)
%{_datadir}/selinux/packages/%{name}/openvswitch-custom.pp

%files -n python-openvswitch
%{python_sitelib}/ovs
%doc COPYING

%files test
%{_bindir}/ovs-test
%{_bindir}/ovs-vlan-test
%{_bindir}/ovs-l3ping
%{_mandir}/man8/ovs-test.8*
%{_mandir}/man8/ovs-vlan-test.8*
%{_mandir}/man8/ovs-l3ping.8*
%{python_sitelib}/ovstest

%files devel
%{_libdir}/*.a
%{_libdir}/*.la
%{_libdir}/pkgconfig/*.pc
%{_includedir}/openvswitch/*
%{_includedir}/openflow/*

%files
%defattr(-,root,root)
%{_sysconfdir}/bash_completion.d/ovs-appctl-bashcomp.bash
%{_sysconfdir}/bash_completion.d/ovs-vsctl-bashcomp.bash
%dir %{_sysconfdir}/openvswitch
%config %ghost %{_sysconfdir}/openvswitch/conf.db
%config %ghost %{_sysconfdir}/openvswitch/system-id.conf
%config(noreplace) %{_sysconfdir}/sysconfig/openvswitch
%config(noreplace) %{_sysconfdir}/logrotate.d/openvswitch
%{_unitdir}/openvswitch.service
%{_unitdir}/ovsdb-server.service
%{_unitdir}/ovs-vswitchd.service
%{_datadir}/openvswitch/scripts/openvswitch.init
%{_sysconfdir}/sysconfig/network-scripts/ifup-ovs
%{_sysconfdir}/sysconfig/network-scripts/ifdown-ovs
%{_datadir}/openvswitch/bugtool-plugins/
%{_datadir}/openvswitch/scripts/ovs-bugtool-*
%{_datadir}/openvswitch/scripts/ovs-check-dead-ifs
%{_datadir}/openvswitch/scripts/ovs-lib
%{_datadir}/openvswitch/scripts/ovs-vtep
%{_datadir}/openvswitch/scripts/ovs-ctl
%config %{_datadir}/openvswitch/vswitch.ovsschema
%config %{_datadir}/openvswitch/vtep.ovsschema
%{_bindir}/ovs-appctl
%{_bindir}/ovs-docker
%{_bindir}/ovs-dpctl
%{_bindir}/ovs-dpctl-top
%{_bindir}/ovs-ofctl
%{_bindir}/ovs-vsctl
%{_bindir}/ovsdb-client
%{_bindir}/ovsdb-tool
%{_bindir}/ovs-testcontroller
%{_bindir}/ovs-pki
%{_bindir}/vtep-ctl
%{_sbindir}/ovs-bugtool
%{_sbindir}/ovs-vswitchd
%{_sbindir}/ovsdb-server
%{_mandir}/man1/ovsdb-client.1*
%{_mandir}/man1/ovsdb-server.1*
%{_mandir}/man1/ovsdb-tool.1*
%{_mandir}/man5/ovs-vswitchd.conf.db.5*
%{_mandir}/man5/vtep.5*
%{_mandir}/man8/vtep-ctl.8*
%{_mandir}/man8/ovs-appctl.8*
%{_mandir}/man8/ovs-bugtool.8*
%{_mandir}/man8/ovs-ctl.8*
%{_mandir}/man8/ovs-dpctl.8*
%{_mandir}/man8/ovs-dpctl-top.8*
%{_mandir}/man8/ovs-ofctl.8*
%{_mandir}/man8/ovs-pki.8*
%{_mandir}/man8/ovs-vsctl.8*
%{_mandir}/man8/ovs-vswitchd.8*
%{_mandir}/man8/ovs-parse-backtrace.8*
%{_mandir}/man8/ovs-testcontroller.8*
%doc COPYING DESIGN.md INSTALL.SSL.md NOTICE README.md WHY-OVS.md
%doc FAQ.md NEWS INSTALL.DPDK.md rhel/README.RHEL
/var/lib/openvswitch
/var/log/openvswitch
%ghost %attr(755,root,root) %{_rundir}/openvswitch

%files ovn
%{_bindir}/ovn-controller
%{_bindir}/ovn-controller-vtep
%{_bindir}/ovn-docker-overlay-driver
%{_bindir}/ovn-docker-underlay-driver
%{_bindir}/ovn-nbctl
%{_bindir}/ovn-northd
%{_bindir}/ovn-sbctl
%{_datadir}/openvswitch/scripts/ovn-ctl
%{_mandir}/man8/ovs-testcontroller.8*
%{_mandir}/man5/ovn-nb.5*
%{_mandir}/man5/ovn-sb.5*
%{_mandir}/man7/ovn-architecture.7*
%{_mandir}/man8/ovn-controller.8*
%{_mandir}/man8/ovn-controller-vtep.8*
%{_mandir}/man8/ovn-ctl.8*
%{_mandir}/man8/ovn-nbctl.8*
%{_mandir}/man8/ovn-northd.8*
%{_mandir}/man8/ovn-sbctl.8*
%config %{_datadir}/openvswitch/ovn-nb.ovsschema
%config %{_datadir}/openvswitch/ovn-sb.ovsschema
%{_unitdir}/ovn-controller.service
%{_unitdir}/ovn-controller-vtep.service
%{_unitdir}/ovn-northd.service

%changelog
* Wed Jan 12 2011 Ralf Spenneberg <a href="mailto:ralf%40os-s.net">&lt;ralf@os-s.net&gt;</a>
- First build on F14
</pre>
</div>

<p>
用FPM打包方式：<a href="https://www.cnblogs.com/clsn/p/7755242.html">https://www.cnblogs.com/clsn/p/7755242.html</a>
RPM与DEB打包 ： <a href="https://www.cnblogs.com/hiyang/p/13524537.html">https://www.cnblogs.com/hiyang/p/13524537.html</a>
</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:fc8d1de9-cc97-4253-aafa-2a0f8b29582b" class="outline-3">
<h3 id="h:fc8d1de9-cc97-4253-aafa-2a0f8b29582b">FPM</h3>
<div class="outline-text-3" id="text-h:fc8d1de9-cc97-4253-aafa-2a0f8b29582b">
</div>
<div id="outline-container-h:2543eea9-0288-4092-ba76-427cee89f04b" class="outline-4">
<h4 id="h:2543eea9-0288-4092-ba76-427cee89f04b">FPM打包工具</h4>
<div class="outline-text-4" id="text-h:2543eea9-0288-4092-ba76-427cee89f04b">
<p>
FPM的作者是jordansissel
</p>

<p>
FPM的github：<a href="https://github.com/jordansissel/fpm">https://github.com/jordansissel/fpm</a>
</p>

<p>
FPM功能简单说就是将一种类型的包转换成另一种类型。
</p>

<ol class="org-ol">
<li><p>
支持的源类型包
</p>

<div class="org-src-container">
<pre class="src src-sh">dir         &#23558;&#30446;&#24405;&#25171;&#21253;&#25104;&#25152;&#38656;&#35201;&#30340;&#31867;&#22411;&#65292;&#21487;&#20197;&#29992;&#20110;&#28304;&#30721;&#32534;&#35793;&#23433;&#35013;&#30340;&#36719;&#20214;&#21253;
rpm         &#23545;rpm&#36827;&#34892;&#36716;&#25442;
gem         &#23545;rubygem&#21253;&#36827;&#34892;&#36716;&#25442;
python      &#23558;python&#27169;&#22359;&#25171;&#21253;&#25104;&#30456;&#24212;&#30340;&#31867;&#22411;
</pre>
</div></li>

<li><p>
支持的目标类型包
</p>

<div class="org-src-container">
<pre class="src src-sh">rpm         &#36716;&#25442;&#20026;rpm&#21253;
deb         &#36716;&#25442;&#20026;deb&#21253;
solaris     &#36716;&#25442;&#20026;solaris&#21253;
puppet      &#36716;&#25442;&#20026;puppet&#27169;&#22359;
</pre>
</div></li>

<li><p>
FPM安装
</p>

<div class="org-src-container">
<pre class="src src-sh">fpm&#26159;ruby&#20889;&#30340;&#65292;&#22240;&#27492;&#31995;&#32479;&#29615;&#22659;&#38656;&#35201;ruby&#65292;&#19988;ruby&#29256;&#26412;&#21495;&#22823;&#20110;1.8.5&#12290;
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;ruby&#27169;&#22359;</span>
yum -y install ruby rubygems ruby-devel
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#20351;&#29992;&#30340;rubygems&#20179;&#24211;</span>
gem sources list
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#28120;&#23453;&#30340;Rubygems&#20179;&#24211;&#65292;&#22806;&#22269;&#30340;&#28304;&#24930;&#65292;&#31227;&#38500;&#21407;&#29983;&#30340;Ruby&#20179;&#24211;</span>
gem sources --add https://ruby.taobao.org/ --remove http://rubygems.org/
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;fpm&#65292;gem&#20174;rubygem&#20179;&#24211;&#23433;&#35013;&#36719;&#20214;&#31867;&#20284;yum&#20174;yum&#20179;&#24211;&#23433;&#35013;&#36719;&#20214;&#12290;&#39318;&#20808;&#23433;&#35013;&#20302;&#29256;&#26412;&#30340;json&#65292;&#39640;&#29256;&#26412;&#30340;json&#38656;&#35201;ruby2.0&#20197;&#19978;&#65292;&#28982;&#21518;&#23433;&#35013;&#20302;&#29256;&#26412;&#30340;fpm&#65292;&#22815;&#29992;&#12290;</span>
gem install json -v 1.8.3
gem install fpm -v 1.3.3
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#19978;&#38754;&#30340;2&#27493;&#23433;&#35013;&#20165;&#36866;&#21512;CentOS6&#31995;&#32479;&#65292;CentOS7&#31995;&#32479;&#19968;&#27493;&#25630;&#23450;&#65292;&#21363;gem install fpm</span>
</pre>
</div></li>

<li>FPM参数 详细使用见fpm &#x2013;help</li>
</ol>

<p>
常用参数
</p>

<div class="org-src-container">
<pre class="src src-sh">-s          &#25351;&#23450;&#28304;&#31867;&#22411;
-t          &#25351;&#23450;&#30446;&#26631;&#31867;&#22411;&#65292;&#21363;&#24819;&#35201;&#21046;&#20316;&#20026;&#20160;&#20040;&#21253;
-n          &#25351;&#23450;&#21253;&#30340;&#21517;&#23383;
-v          &#25351;&#23450;&#21253;&#30340;&#29256;&#26412;&#21495;
-C          &#25351;&#23450;&#25171;&#21253;&#30340;&#30456;&#23545;&#36335;&#24452;  Change directory to here before searching forfiles
-d          &#25351;&#23450;&#20381;&#36182;&#20110;&#21738;&#20123;&#21253;
-f          &#31532;&#20108;&#27425;&#25171;&#21253;&#26102;&#30446;&#24405;&#19979;&#22914;&#26524;&#26377;&#21516;&#21517;&#23433;&#35013;&#21253;&#23384;&#22312;&#65292;&#21017;&#35206;&#30422;&#23427;
-p          &#36755;&#20986;&#30340;&#23433;&#35013;&#21253;&#30340;&#30446;&#24405;&#65292;&#19981;&#24819;&#25918;&#22312;&#24403;&#21069;&#30446;&#24405;&#19979;&#23601;&#38656;&#35201;&#25351;&#23450;
--post-install      &#36719;&#20214;&#21253;&#23433;&#35013;&#23436;&#25104;&#20043;&#21518;&#25152;&#35201;&#36816;&#34892;&#30340;&#33050;&#26412;&#65307;&#21516;--after-install
--pre-install       &#36719;&#20214;&#21253;&#23433;&#35013;&#23436;&#25104;&#20043;&#21069;&#25152;&#35201;&#36816;&#34892;&#30340;&#33050;&#26412;&#65307;&#21516;--before-install
--post-uninstall    &#36719;&#20214;&#21253;&#21368;&#36733;&#23436;&#25104;&#20043;&#21518;&#25152;&#35201;&#36816;&#34892;&#30340;&#33050;&#26412;&#65307;&#21516;--after-remove
--pre-uninstall     &#36719;&#20214;&#21253;&#21368;&#36733;&#23436;&#25104;&#20043;&#21069;&#25152;&#35201;&#36816;&#34892;&#30340;&#33050;&#26412;&#65307;&#21516;--before-remove
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c1bc70c3-5442-4fdf-90e2-c39bc6284be2" class="outline-4">
<h4 id="h:c1bc70c3-5442-4fdf-90e2-c39bc6284be2">使用实例&#x2013;实战定制nginx的RPM包</h4>
<div class="outline-text-4" id="text-h:c1bc70c3-5442-4fdf-90e2-c39bc6284be2">
<p>
1.安装nginx
</p>

<div class="org-src-container">
<pre class="src src-sh">yum -y install pcre-devel openssl-devel
useradd nginx -M -s /sbin/nologin
tar xf nginx-1.6.2.tar.gz
<span style="color: #483d8b;">cd</span> nginx-1.6.2


./configure --prefix=/application/nginx-1.6.2 --user=nginx --group=nginx --with-http_ssl_module --with-http_stub_status_module

make &amp;&amp; make install
ln -s /application/nginx-1.6.2/ /application/nginx
</pre>
</div>


<p>
2.编写脚本
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@mc ~]# cd /server/scripts/
[root@mc scripts]# vim nginx_rpm.sh  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#26159;&#23433;&#35013;&#23436;rpm&#21253;&#35201;&#25191;&#34892;&#30340;&#33050;&#26412;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
useradd nginx -M -s /sbin/nologin
ln -s /application/nginx-1.6.2/ /application/nginx
</pre>
</div>

<p>
3.打包
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@mc ~]# fpm -s dir -t rpm -n nginx -v 1.6.2 -d <span style="color: #8b2252;">'pcre-devel,openssl-devel'</span> --post-install /server/scripts/nginx_rpm.sh -f /application/nginx-1.6.2/  
no value for epoch is set, defaulting to nil {:<span style="color: #a0522d;">level</span>=&gt;:warn}
no value for epoch is set, defaulting to nil {:<span style="color: #a0522d;">level</span>=&gt;:warn}
Created package {:<span style="color: #a0522d;">path</span>=&gt;<span style="color: #8b2252;">"nginx-1.6.2-1.x86_64.rpm"</span>}
[root@mc ~]# ll -h nginx-1.6.2-1.x86_64.rpm 
-rw-r--r-- 1 root root 6.7M Nov  1 10:02 nginx-1.6.2-1.x86_64.rpm
</pre>
</div>

<p>
4.装rpm包 安装rpm包的三种方法：
</p>

<p>
rpm命令安装
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@LB-nginx-01 ~]# rpm -ivh nginx-1.6.2-1.x86_64.rpm
error: Failed dependencies:
       pcre-devel is needed by nginx-1.6.2-1.x86_64
       openssl-devel is needed by nginx-1.6.2-1.x86_64
&#20294;&#20250;&#25253;&#22914;&#19978;&#20381;&#36182;&#38169;&#35823;&#65292;&#38656;&#35201;&#20808;yum&#23433;&#35013;&#20381;&#36182;&#25165;&#33021;&#23433;&#35013;rpm&#21253;&#12290;
</pre>
</div>

<p>
yum命令安装rpm包
</p>

<div class="org-src-container">
<pre class="src src-sh">yum -y localinstall nginx-1.6.2-1.x86_64.rpm
&#36825;&#20010;&#21629;&#20196;&#20250;&#33258;&#21160;&#20808;&#23433;&#35013;rpm&#21253;&#30340;&#20381;&#36182;&#65292;&#28982;&#21518;&#20877;&#23433;&#35013;rpm&#21253;&#12290;
</pre>
</div>

<p>
搭建内网yum仓库 YUM仓库搭建
</p>
</div>
</div>
<div id="outline-container-h:0cdf247a-b567-496d-8712-ea7b743045c3" class="outline-4">
<h4 id="h:0cdf247a-b567-496d-8712-ea7b743045c3">注意事项</h4>
<div class="outline-text-4" id="text-h:0cdf247a-b567-496d-8712-ea7b743045c3">
<ol class="org-ol">
<li><p>
相对路径问题
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#30456;&#23545;&#36335;&#24452;</span>
[root@mc nginx]# fpm -s dir -t rpm -n nginx -v 1.6.2 .
no value for epoch is set, defaulting to nil {:<span style="color: #a0522d;">level</span>=&gt;:warn}
no value for epoch is set, defaulting to nil {:<span style="color: #a0522d;">level</span>=&gt;:warn}
Created package {:<span style="color: #a0522d;">path</span>=&gt;<span style="color: #8b2252;">"nginx-1.6.2-1.x86_64.rpm"</span>}
[root@mc nginx]# rpm -qpl nginx-1.6.2-1.x86_64.rpm    
/client_body_temp
/conf/extra/dynamic_pools
/conf/extra/static_pools
&#8230;&#8230;&#8230;&#8230;
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32477;&#23545;&#36335;&#24452;</span>
[root@mc ~]# fpm -s dir -t rpm -n nginx -v 1.6.2 /application/nginx-1.6.2/
no value for epoch is set, defaulting to nil {:<span style="color: #a0522d;">level</span>=&gt;:warn}
no value for epoch is set, defaulting to nil {:<span style="color: #a0522d;">level</span>=&gt;:warn}
Created package {:<span style="color: #a0522d;">path</span>=&gt;<span style="color: #8b2252;">"nginx-1.6.2-1.x86_64.rpm"</span>}
[root@mc ~]# rpm -qpl nginx-1.6.2-1.x86_64.rpm 
/application/nginx-1.6.2/client_body_temp
/application/nginx-1.6.2/conf/extra/dynamic_pools
/application/nginx-1.6.2/conf/extra/static_pools
/application/nginx-1.6.2/conf/fastcgi.conf
/application/nginx-1.6.2/conf/fastcgi.conf.default
&#8230;&#8230;&#8230;&#8230;
&#20351;&#29992;rpm -qpl &#21629;&#20196;&#21487;&#20197;&#26597;&#30475;rpm&#21253;&#30340;&#20869;&#23481;&#12290;
&#27880;&#65306;fpm&#31867;&#20284;tar&#25171;&#21253;&#19968;&#26679;&#65292;&#21482;&#26159;fpm&#25171;&#30340;&#21253;&#33021;&#22815;&#34987;yum&#21629;&#20196;&#35782;&#21035;&#32780;&#24050;&#12290;
</pre>
</div></li>

<li><p>
软链接问题
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@mc ~]# fpm -s dir -t rpm -n nginx -v 1.6.2 /application/nginx
no value for epoch is set, defaulting to nil {:<span style="color: #a0522d;">level</span>=&gt;:warn}
File already exists, refusing to continue: nginx-1.6.2-1.x86_64.rpm {:<span style="color: #a0522d;">level</span>=&gt;:fatal}
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25253;&#38169;&#26159;&#22240;&#20026;&#24403;&#21069;&#30446;&#24405;&#23384;&#22312;&#21516;&#21517;&#30340;rpm&#21253;&#65292;&#21487;&#20197;&#20351;&#29992;-f&#21442;&#25968;&#24378;&#21046;&#35206;&#30422;&#12290;</span>
[root@mc ~]# fpm -s dir -t rpm -n nginx -v 1.6.2 -f /application/nginx
no value for epoch is set, defaulting to nil {:<span style="color: #a0522d;">level</span>=&gt;:warn}
Force flag given. Overwriting package at nginx-1.6.2-1.x86_64.rpm {:<span style="color: #a0522d;">level</span>=&gt;:warn}
no value for epoch is set, defaulting to nil {:<span style="color: #a0522d;">level</span>=&gt;:warn}
Created package {:<span style="color: #a0522d;">path</span>=&gt;<span style="color: #8b2252;">"nginx-1.6.2-1.x86_64.rpm"</span>}
&#25171;&#21253;&#30475;&#20284;&#25104;&#21151;&#65292;&#20294;&#26597;&#30475;&#21253;&#30340;&#20869;&#23481;&#65292;&#21482;&#26159;&#36825;&#19968;&#20010;&#36719;&#38142;&#25509;&#25991;&#20214;&#12290;
[root@mc ~]# rpm -qpl nginx-1.6.2-1.x86_64.rpm 
/application/nginx
&#21407;&#22240;&#65306;&#30446;&#24405;&#32467;&#23614;&#30340;/&#38382;&#39064;&#65292;&#31867;&#20284;rm&#21024;&#38500;&#36719;&#38142;&#25509;&#30446;&#24405;
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-h:bf21d0dc-57ca-42cd-8d0e-9df143577cdd" class="outline-4">
<h4 id="h:bf21d0dc-57ca-42cd-8d0e-9df143577cdd">定制LNMP的RPM包思路</h4>
<div class="outline-text-4" id="text-h:bf21d0dc-57ca-42cd-8d0e-9df143577cdd">
<p>
编译安装好nginx，mysql，php，此处有个问题，就是php的大部分依赖环境是通
过yum安装的，但有一个libiconv-1.14.tar.gz包需要编译安装,安装时已经指定
了安装目录，只需一同打包即可。
</p>

<p>
还有一个问题，就是mysql这个目录比较大，用fpm打包耗时长。平时我们有可能
需要对nginx或php做优化，这样又得重新打包。因此我们可以将mysql分离出来，
分别打包。只需在制作nginx+php的rpm包时添加mysql的依赖即可。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21442;&#32771;&#21629;&#20196;</span>
 [root@web2 ~]# fpm -s dir -t rpm -n web2 -v 1.1 <span style="color: #8b2252;">\</span>
--description <span style="color: #8b2252;">'lnmp.cms,bbs.blog'</span> <span style="color: #8b2252;">\</span>
-d &#8216;libxslt-devel,nfs-utils,rpcbind,mysql,libmcrypt-devel,mhash,mhash-devel,mcrypt<span style="color: #8b2252;">' \</span>
<span style="color: #8b2252;">--post-install /server/scripts/lnmp-init.sh  \</span>
<span style="color: #8b2252;">/application /usr/local/libiconv/ /app/logs/ /data0/  /server/</span>
</pre>
</div>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
