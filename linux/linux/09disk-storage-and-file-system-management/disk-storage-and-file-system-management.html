<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: 磁盘存储和文件系统管理</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/font.css"/>
<link rel="stylesheet" type="text/css" href="/static/drollery.e825b870.css"/>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
</head>
<body>
<header id="preamble" class="status">
<header class="{className}" data-astro-cid-3ef6ksr2>
  <div class=header-branding data-astro-cid-g2lrb5xm>
      <span class=header-text data-astro-cid-g2lrb5xm>
          <span class=dropcap data-astro-cid-g2lrb5xm aria-hidden=true>
              <span class=actual data-astro-cid-g2lrb5xm>J</span>
              <span class=rest data-astro-cid-g2lrb5xm>asper Hsu</span>
              <span class=period data-astro-cid-g2lrb5xm>.</span>
          </span>
          <span class=sr-only data-astro-cid-g2lrb5xm>Drollery</span>
      </span>
      <img alt="Medieval drollery of a knight on a horse" class=spring decoding=async height=250 loading=lazy src=/images/knight-horse.a96eee7d_Z1WCOYs.webp width=68 data-astro-cid-g2lrb5xm>
  </div>

  <nav data-astro-cid-pux6a34n>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/jcodelog.html class=nobracket data-astro-cid-pux6a34n>技术</a>
      <span class=flower2 data-astro-cid-pux6a34n>K</span>
      <a href=/reading/index.html class=nobracket data-astro-cid-pux6a34n>阅读</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
      <a href=/archives.html class=nobracket data-astro-cid-pux6a34n>归档</a>
      <span class=flower2 data-astro-cid-pux6a34n>L</span>
      <a href=/link/index.html class=nobracket data-astro-cid-pux6a34n>友链</a>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/about.html class=nobracket data-astro-cid-pux6a34n>关于</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
  </nav>


  <div class="container" data-astro-cid-3ef6ksr2>
    <p class="info" data-astro-cid-3ef6ksr2>
              🏆 欢迎来到本站：
              <a href="https://xuchangwei.com/">https://xuchangwei.com/</a>。
              <strong>希望这里有你感兴趣的内容</strong>。
            </p>
  </div>
  <div id=borderArtWrapper class="tt1" data-astro-cid-5hce7sga data-turbo-permanent>
      <script>
          var man, shakeCount = 0, noSound = new Audio("/audio/effects/no.m4a"), screamSound = new Audio("/audio/effects/scream.m4a");
          function animateManShakeHandler() {
              man.removeEventListener("animationend", animateManShakeHandler, !1),
              shakeCount += 1,
              man.classList.remove("shakeMan")
          }
          function animateManFallHandler() {
              man.removeEventListener("animationend", animateManFallHandler, !1),
              man.classList.add("hide")
          }
          function animateMan() {
              man = man ?? document.getElementById("borderMan"),
              3 === shakeCount ? (man.classList.add("fallMan"),
              screamSound.play(),
              man.addEventListener("animationend", animateManFallHandler, !1)) : (man.classList.add("shakeMan"),
              noSound.play(),
              man.addEventListener("animationend", animateManShakeHandler, !1))
          }
      </script>
      <div class=borderArt data-astro-cid-5dda5nwp id=articleBorder>
          <img alt="flowery border with man falling" decoding=async height=620 loading=lazy src=/images/border-vines-no-man.b7d246cc_DRxSe.webp width=909 class=border data-astro-cid-5dda5nwp>
          <div class=fallWrapper data-astro-cid-5dda5nwp>
              <img alt="flowery border with man falling" decoding=async height=292 loading=lazy src=/images/man-no-vines.247a3187_Z2ioXNM.webp width=98 class=man data-astro-cid-5dda5nwp id=borderMan onclick=animateMan()>
          </div>
      </div>
  </div>
</header>
</header>
<main class="container" id="content" class="content">
<header>
<h1 class="title">Linux: 磁盘存储和文件系统管理</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:c357b081-29d5-4c40-b512-2b4a74b34494">磁盘结构</a>
<ul>
<li><a href="#h:c8a471c6-ba88-4b3d-b322-1c6400f8b17b">设备文件</a></li>
<li><a href="#h:4ab63e94-0645-40d1-ba26-a763ed38e068">硬盘类型</a></li>
<li><a href="#h:c20e0bfa-1121-408a-898b-6d5c37227196">机械硬盘和固态硬盘</a></li>
<li><a href="#h:4a8be231-6a09-4331-94d0-9c5e7074978b">硬盘存储术语</a></li>
</ul>
</li>
<li><a href="#h:4ca4008e-c9b5-4b46-9dc7-9c2113bae262">管理存储</a>
<ul>
<li><a href="#h:9e2bd0c1-21d6-4ca7-8d54-8451e7ac787d">磁盘分区</a>
<ul>
<li><a href="#h:28ebaa3c-505e-4ba1-808c-9aec2771f8e4">为什么分区</a></li>
<li><a href="#h:3d1827ec-69f5-4770-9a06-717911832c59">分区方式</a>
<ul>
<li><a href="#h:649c5210-a646-4550-a6a7-3dab6c9d393f">MBR分区</a></li>
<li><a href="#h:bbf72e7e-292d-43ce-8106-726733eff049">GPT分区</a></li>
</ul>
</li>
<li><a href="#h:7621c54c-bfe7-4f2c-ab55-9e4febb30289">BIOS和UEFI</a></li>
<li><a href="#h:c91dfc83-06a0-4be7-b8e2-70442d7572ce">管理分区</a>
<ul>
<li><a href="#h:5f9d6e08-dfda-491b-8654-d7d8f1af32ba">列出块设备 lsblk</a></li>
<li><a href="#h:09cba273-0615-45b6-905c-f05fc7feaa3c">parted 命令</a></li>
<li><a href="#h:6d53ac13-e5e5-4ef7-817b-efa6882d6728">分区工具fdisk和gdisk</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:b3fbddc6-7cdb-4263-b4d2-a2d36c8301bb">文件系统</a>
<ul>
<li><a href="#h:3c131bca-7170-492f-acb2-42982c9137a0">文件系统概念</a></li>
<li><a href="#h:a5a0758b-405a-4efb-8f7f-ff9cb367f5b7">文件系统类型</a></li>
<li><a href="#h:408140a8-173d-44ea-a166-f9b6b77d2895">文件系统的组成部分</a></li>
<li><a href="#h:432e0a58-303e-420b-8691-551154f8de43">文件系统选择管理</a>
<ul>
<li><a href="#h:63f2bda1-7472-4755-89e1-9b6e3ee6e585">创建文件系统</a></li>
<li><a href="#h:12595ccb-f7d7-4028-92c1-5727c5d29a85">查看和管理分区信息</a></li>
<li><a href="#h:88f74429-ec9a-4d55-845b-749c4862fc93">文件系统检测和修复</a></li>
<li><a href="#h:57ed1dd5-4d08-4513-9d77-0af1ec131ea9">文件系统中文件恢复</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:fe5371ea-92e7-411e-b933-a5e2531a44f9">挂载</a>
<ul>
<li><a href="#h:9300dc8a-8557-4bcb-924e-9a9886cacf5f">挂载文件系统mount</a></li>
<li><a href="#h:698dd5a2-56c6-46ee-bc9e-b969480bbff9">卸载文件系统 umount</a></li>
<li><a href="#h:d991921a-dab2-4eb7-9951-ba6f8a4e0b32">查看挂载情况</a></li>
<li><a href="#h:50d6a75a-f75a-48b0-b540-4a1ea5c5d1bd">持久挂载</a></li>
</ul>
</li>
<li><a href="#h:a098f076-559a-4920-b220-8960eb56ecdc">处理交换文件和分区</a>
<ul>
<li><a href="#h:7470583d-3528-4316-b425-04624cc37c66">swap 介绍</a></li>
<li><a href="#h:1b8a44ce-deb5-4e21-a31b-71f26a8ce1c6">交换分区实现过程</a></li>
<li><a href="#h:f6966f45-4165-419c-94b5-6274d9f00302">swap的使用策略</a></li>
</ul>
</li>
<li><a href="#h:2ed19f37-bf19-41df-adba-657193b1f13b">移动介质</a>
<ul>
<li><a href="#h:4da950f8-5acb-4af0-947d-dd90f63a069e">使用光盘</a></li>
<li><a href="#h:f755173b-d9fb-4a64-82ce-986a0f53f1c2">USB介质</a>
<ul>
<li><a href="#h:e9a55927-6e9c-41f9-964a-3c5ec441b36d">制作U盘启动安装CentOS</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:87b6ab89-195e-4106-92f1-8302c0cf7544">磁盘常见工具</a>
<ul>
<li><a href="#h:60c75dae-bb03-4e5d-bbd7-0f4e74fe0c11">文件系统空间占用等信息的查看工具df</a></li>
<li><a href="#h:a4448b54-3e98-49fa-9d25-42cd0304ee83">查看某目录总体空间占用状态du</a>
<ul>
<li><a href="#h:c8bdfb52-947b-4763-a054-05047366c079">df和du的区别</a></li>
</ul>
</li>
<li><a href="#h:bbda5d5b-62fe-415f-962d-bd0e74352285">工具dd</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:3b73de93-6c86-4841-b593-d3d87883062f">RAID</a>
<ul>
<li><a href="#h:973a4e72-5a73-4da5-aa9f-22ff8accf254">什么是RAID</a></li>
<li><a href="#h:c4d07f2a-f0f2-4eab-93fe-e541c4321332">RAID级别</a>
<ul>
<li><a href="#h:4972c508-54ae-428d-a521-ecc4f8a69909">RAID-0</a></li>
<li><a href="#h:8fee72f6-f628-4dc3-8ad6-fd9611431aa9">RAID-1</a></li>
<li><a href="#h:c7e3333b-9652-4934-b22d-02d4fa14aa55">RAID-4</a></li>
<li><a href="#h:19bb3bf6-bb09-496a-9f44-1a2185859dcc">RAID-5</a></li>
<li><a href="#h:e04af9c1-08c0-4047-a6e9-8c258d1217fc">RAID-6</a></li>
<li><a href="#h:3d1e1314-f915-46bf-a17b-eeee104d4eee">RAID-10</a></li>
<li><a href="#h:874f487b-55ff-4026-9df6-e595606d2d58">RAID-01</a></li>
<li><a href="#h:bb331ab6-e57d-4a56-90ef-0cfff77d807a">RAID-50</a></li>
<li><a href="#h:3ab099aa-4e48-4f25-b5d0-b082380688ca">其它级别</a></li>
<li><a href="#h:9cebdd7a-3502-49a1-8c2e-cf5fca26e9bb">RAID总结</a></li>
</ul>
</li>
<li><a href="#h:b5c9b1fe-0384-4288-beb3-880300a070f8">实现软RAID</a></li>
</ul>
</li>
<li><a href="#h:8e7781b7-ad87-44dd-b691-4881da975c8f">逻辑卷管理器（LVM）</a>
<ul>
<li><a href="#h:08177873-8507-4d30-9969-6855fee5a55f">LVM介绍</a></li>
<li><a href="#h:4b14bc2f-7089-44bd-a519-52e46a9de2b2">实现逻辑卷</a>
<ul>
<li><a href="#h:1da9df56-8298-4a17-b9a5-198cca47f9b8">pv管理工具</a></li>
<li><a href="#h:dac7283a-62c4-479f-b24a-769a3a65b2a0">vg管理工具</a></li>
<li><a href="#h:033be43b-3a4f-4637-ba3f-fffddf837009">lv管理工具</a></li>
<li><a href="#h:a4df6d57-3275-4971-a21d-b427836afa13">扩展和缩减逻辑卷</a>
<ul>
<li><a href="#h:4bbc1af1-1a91-4d58-8ec9-0485b4fe7f95">在线扩展逻辑卷</a></li>
<li><a href="#h:8a7ec24b-31a5-4abe-9e9e-829230ab0479">缩减逻辑卷</a></li>
</ul>
</li>
<li><a href="#h:4e31819a-fb68-4c57-bc13-556936e150c5">跨主机迁移卷组</a></li>
</ul>
</li>
<li><a href="#h:c901eab5-6c8d-4d6b-badb-561747abb038">逻辑卷快照</a>
<ul>
<li><a href="#h:15b6fce9-8786-45f6-9277-d3df139d65e6">逻辑卷快照原理</a></li>
<li><a href="#h:049936f4-e103-4c0d-87f3-0b0d4da2d63b">实现逻辑卷快照</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:9ee48b0c-52c9-4385-92c6-7e4a21bf4d47">btrfs文件系统管理与应用</a>
<ul>
<li><a href="#h:43f03ce8-5345-4d1c-8687-d5f1e2f6a356">Btrfs文件系统简介</a></li>
<li><a href="#h:ca088b3f-f2ba-4c18-9a66-0efc6c7174ea">核心特性</a></li>
<li><a href="#h:ac5edb5c-f06c-41ec-afe1-aa64e5291c77">创建 b-tree 文件系统</a></li>
<li><a href="#h:35b34bd7-8e74-4621-9c36-a592c768c00e">btrfs 文件系统命令</a></li>
<li><a href="#h:16e27007-cf1d-4a6e-a182-4803dd8b7236">设备管理命令</a></li>
<li><a href="#h:464f5498-d025-4bcc-a4d4-a7ebb7d1567d">块组均衡管理</a></li>
</ul>
</li>
<li><a href="#h:0b9caad1-b74d-4267-b495-11de46b4d2de">ISO制作</a>
<ul>
<li><a href="#h:04af2fe8-0674-474b-86af-8106ce885a94">准备工作</a></li>
<li><a href="#h:b185453f-a697-4e5f-8c24-267fadf124e7">配置文件修改</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../../index.html">Linux</a></li>
</ul>


<p>
磁盘存储和文件系统
</p>

<p>
内容概述
</p>
<ul class="org-ul">
<li>磁盘结构</li>
<li>分区类型</li>
<li>管理分区</li>
<li>管理文件系统</li>
<li>挂载设备</li>
<li>管理swap空间</li>
<li>RAID管理</li>
<li>LVM管理和LVM快照</li>
</ul>
<section id="outline-container-h:c357b081-29d5-4c40-b512-2b4a74b34494" class="outline-2">
<h2 id="h:c357b081-29d5-4c40-b512-2b4a74b34494">磁盘结构</h2>
<div class="outline-text-2" id="text-h:c357b081-29d5-4c40-b512-2b4a74b34494">
</div>
<div id="outline-container-h:c8a471c6-ba88-4b3d-b322-1c6400f8b17b" class="outline-3">
<h3 id="h:c8a471c6-ba88-4b3d-b322-1c6400f8b17b">设备文件</h3>
<div class="outline-text-3" id="text-h:c8a471c6-ba88-4b3d-b322-1c6400f8b17b">
<p>
一切皆文件：open(), read(), write(), close()
</p>

<p>
设备文件：关联至一个设备驱动程序，进而能够跟与之对应硬件设备进行通信
</p>

<p>
设备号码：
</p>

<ul class="org-ul">
<li>主设备号：major number, 标识设备类型</li>
<li>次设备号：minor number, 标识同一类型下的不同设备</li>
</ul>

<p>
只要系统判断 2个文件主设备号 次设备号一样就是同一个设备
</p>

<p>
设备类型：
</p>

<ul class="org-ul">
<li>块设备：block，存取单位”块”，磁盘</li>
<li>字符设备：char，存取单位”字符”，键盘</li>
</ul>

<p>
磁盘设备的设备文件命名：
</p>

<div class="org-src-container">
<pre class="src src-sh">/dev/DEV_FILE
/dev/sdX           <span style="color: #b22222;">#</span><span style="color: #b22222;">SCSI, SATA, SAS, IDE,USB</span>
/dev/nvme0n#  <span style="color: #b22222;">#</span><span style="color: #b22222;">nvme&#21327;&#35758;&#30828;&#30424;&#65292;&#22914;&#65306;&#31532;&#19968;&#20010;&#30828;&#30424;&#65306;nvme0n1&#65292;&#31532;&#20108;&#20010;&#30828;&#30424;&#65306;nvme0n2</span>
</pre>
</div>

<p>
虚拟磁盘：
</p>

<div class="org-src-container">
<pre class="src src-sh">/dev/vd
/dev/xvd
</pre>
</div>

<p>
不同磁盘标识：a-z,aa,ab&#x2026;
</p>

<p>
示例：
</p>

<div class="org-src-container">
<pre class="src src-sh">/dev/sda&#65292;/dev/sdb, ...
</pre>
</div>

<p>
同一设备上的不同分区：1,2, &#x2026;
</p>

<div class="org-src-container">
<pre class="src src-sh">/dev/sda1
/dev/sda5
</pre>
</div>

<p>
范例：创建设备文件
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#df /boot
Filesystem   1K-blocks  Used Available Use% Mounted on
/dev/sda1     999320 130848   799660  15% /boot
[root@centos8 ~]#ls /boot

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21482;&#35201;&#31995;&#32479;&#21028;&#26029; 2&#20010;&#25991;&#20214;&#20027;&#35774;&#22791;&#21495; &#27425;&#35774;&#22791;&#21495;&#19968;&#26679;&#23601;&#26159;&#21516;&#19968;&#20010;&#35774;&#22791;</span>
[root@centos8 ~]#mknod /data/partition-sda1 b 8 1  <span style="color: #b22222;"># </span><span style="color: #b22222;">mknod  &#35774;&#22791;&#36335;&#24452; &#35774;&#22791;&#31867;&#22411; &#20027;&#35201;&#32534;&#21495; &#27425;&#35201;&#32534;&#21495;</span>
[root@centos8 ~]#ll /data/partition-sda1
brw-r--r-- 1 root root 8, 1 Apr 13 09:15 /data/partition-sda1
[root@centos8 ~]#mount /data/partition-sda1 /mnt/
[root@centos8 ~]#ls /mnt

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#19968;&#20010;&#21644;zero&#19968;&#26679;&#30340;&#35774;&#22791;&#25991;&#20214;</span>
[root@centos8 ~]#ll /dev/zero
crw-rw-rw- 1 root root 1, 5 Apr 13 08:03 /dev/zero
[root@centos8 ~]#mknod /data/zero c 1 5
[root@centos8 ~]#ll /data/zero
crw-r--r-- 1 root root 1, 5 Apr 13 09:17 /data/zero

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25805;&#20316;&#35774;&#22791;&#25991;&#20214;</span>
root@debian:~# dd <span style="color: #a0522d;">if</span>=/data/zero <span style="color: #a0522d;">of</span>=/data/test1.img <span style="color: #a0522d;">bs</span>=1 <span style="color: #a0522d;">count</span>=10
10+0 records<span style="color: #a020f0;"> in</span>
10+0 records out
10 bytes copied, 0.000680455 s, 14.7 kB/s
root@debian:~# ls -l /data/test1.img 
-rw-r--r-- 1 root root 10 Oct 11 11:10 /data/test1.img
root@debian:~# hexdump -C /data/test1.img 
00000000  00 00 00 00 00 00 00 00  00 00                    |..........|
0000000a
root@debian:~# rm -f /data/zero 
root@debian:~# cp -a /dev/zero  /data/zero  <span style="color: #b22222;">#</span><span style="color: #b22222;">-a &#22797;&#21046;&#25991;&#20214;&#35774;&#22791;&#31867;&#22411;</span>
root@debian:~# ls -l /data/zero 
crw-rw-rw- 1 root root 1, 5 Oct 11 10:56 /data/zero
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4ab63e94-0645-40d1-ba26-a763ed38e068" class="outline-3">
<h3 id="h:4ab63e94-0645-40d1-ba26-a763ed38e068">硬盘类型</h3>
<div class="outline-text-3" id="text-h:4ab63e94-0645-40d1-ba26-a763ed38e068">

<figure id="org5f9b400">
<img src="images/image-20210216020339143.png" alt="image-20210216020339143.png" width="80%">

</figure>

<p>
<b>硬盘接口类型</b>
</p>

<ul class="org-ul">
<li>IDE：133MB/s，并行接口，早期家用电脑</li>
<li>SCSI：640MB/s，并行接口，早期服务器</li>
<li>SATA：6Gbps，SATA数据端口与电源端口是分开的，即需要两条线，一条数据线，一条电源线</li>
<li>SAS：6Gbps，SAS是一整条线，数据端口与电源端口是一体化的，SAS中是包含
供电线的，而SATA中不包含供电线。SATA标准其实是SAS标准的一个子集，二
者可兼容，SATA硬盘可以插入SAS主板上，反之不成</li>
<li>USB：480MB/s</li>
<li>M.2：</li>
</ul>

<p>
注意：速度不是由单纯的接口类型决定，支持Nvme协议硬盘速度是最快的
</p>

<p>
​<b>服务器硬盘大小</b>
</p>

<ul class="org-ul">
<li>LFF：3.5寸，一般见到的那种台式机硬盘的大小</li>
<li>SFF：Small Form Factor 小形状因数，2.5寸，注意不同于2.5寸的笔记本硬盘</li>
</ul>

<p>
L、S分别是大、小的意思，目前服务器或者盘柜采用sff规格的硬盘主要是考内
虑增大单位密度内的磁盘容量、增强散热、减小功耗
</p>
</div>
</div>
<div id="outline-container-h:c20e0bfa-1121-408a-898b-6d5c37227196" class="outline-3">
<h3 id="h:c20e0bfa-1121-408a-898b-6d5c37227196">机械硬盘和固态硬盘</h3>
<div class="outline-text-3" id="text-h:c20e0bfa-1121-408a-898b-6d5c37227196">
<p>
机械硬盘（HDD）：Hard Disk Drive，即是传统普通硬盘，主要由：盘片，磁头，
盘片转轴及控制电机，磁头控制器，数据转换器，接口，缓存等几个部分组成。
机械硬盘中所有的盘片都装在一个旋转轴上，每张盘片之间是平行的，在每个盘
片的存储面上有一个磁头，磁头与盘片之间的距离比头发丝的直径还小，所有的
磁头联在一个磁头控制器上，由磁头控制器负责各个磁头的运动。磁头可沿盘片
的半径方向运动，加上盘片每分钟几千转的高速旋转，磁头就可以定位在盘片的
指定位置上进行数据的读写操作。数据通过磁头由电磁流来改变极性方式被电磁
流写到磁盘上，也可以通过相反方式读取。硬盘为精密设备，进入硬盘的空气必
须过滤
</p>

<p>
固态硬盘（SSD）：Solid State Drive，用固态电子存储芯片阵列而制成的硬盘，
由控制单元和存储单元（FLASH芯片、DRAM芯片）组成。固态硬盘在接口的规范
和定义、功能及使用方法上与普通硬盘的完全相同，在产品外形和尺寸上也与普
通硬盘一致相较于HDD，SSD在防震抗摔、传输速率、功耗、重量、噪音上有明显
优势，SSD传输速率性能是HDD的2倍
</p>

<p>
固态中支持NVMe通道协议的速度理快
</p>


<figure id="org10a7427">
<img src="images/image-20210216020356031.png" alt="image-20210216020356031.png" width="60%">

</figure>

<p>
相较于SSD，HDD在价格、容量占有绝对优势
</p>

<p>
硬盘有价，数据无价，目前SSD不能完全取代HHD
</p>

<p>
机械硬盘结构
</p>


<figure id="orgea2a1fb">
<img src="images/image-20210216020412234.png" alt="image-20210216020412234.png" width="80%">

</figure>

<p>
固态硬盘（SSD）
</p>


<figure id="orgdfedabd">
<img src="images/image-20210216020438055.png" alt="image-20210216020438055.png" width="80%">

</figure>
</div>
</div>
<div id="outline-container-h:4a8be231-6a09-4331-94d0-9c5e7074978b" class="outline-3">
<h3 id="h:4a8be231-6a09-4331-94d0-9c5e7074978b">硬盘存储术语</h3>
<div class="outline-text-3" id="text-h:4a8be231-6a09-4331-94d0-9c5e7074978b">

<figure id="org3130b5f">
<img src="images/image-20210216020449985.png" alt="image-20210216020449985.png" width="60%">

</figure>

<p>
<b>硬盘存储术语 CHS</b>
</p>

<ul class="org-ul">
<li>head：磁头 磁头数=盘面数</li>
<li>track：磁道 磁道=柱面数</li>
<li>sector：扇区，512bytes</li>
<li>cylinder：柱面 1柱面=512 * sector数/track*head数=512*63*255=7.84M
CentOS 5 之前版本 Linux 以柱面的整数倍划分分区，CentOS 6之后可以支持
以扇区划分分区</li>
</ul>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#echo <span style="color: #8b2252;">"scale=2;512*63*255/1024/1024"</span> |bc
7.84

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;CHS</span>
[root@centos6 ~]#fdisk -l /dev/sda  <span style="color: #b22222;"># </span><span style="color: #b22222;">centos6&#36824;&#26159;&#32769;&#30340;&#26041;&#24335;&#65292;&#20197;&#26609;&#38754;&#21010;&#20998;&#20998;&#21306;</span>
Disk /dev/sda: 214.7 GB, 214748364800 bytes
255 heads, 63 sectors/track, 26108 cylinders
<span style="color: #a0522d;">Units</span> = cylinders of 16065 * <span style="color: #a0522d;">512</span> = 8225280 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk identifier: 0x0006fc79
 Device Boot   Start     End   Blocks  Id System
/dev/sda1  *      1     131   1048576  83 Linux
Partition 1 does not end on cylinder boundary.
/dev/sda2       131    12879  102400000  83 Linux
/dev/sda3      12879    19253   51200000  83 Linux
/dev/sda4      19253    26109   55065600   5 Extended
/dev/sda5      19254    19515   2097152  82 Linux swap / Solaris

<span style="color: #b22222;"># </span><span style="color: #b22222;">centos7&#24320;&#22987;&#20197;&#25159;&#21306;&#21010;&#20998;&#20998;&#21306;</span>
[root@centos8 ~]#fdisk -u=cylinder -l /dev/sda <span style="color: #b22222;"># </span><span style="color: #b22222;">-u=cylinder  &#26174;&#31034;&#26609;&#38754;&#20449;&#24687;</span>

[root@node01 ~]# fdisk -l
Disk /dev/sda: 10.7 GB, 10737418240 &#23383;&#33410;, 20971520 sectors&#25159;&#21306;   <span style="color: #b22222;"># </span><span style="color: #b22222;">/dev/sda&#35774;&#22791;&#19978;&#19968;&#20849;&#22810;&#23569;&#23383;&#33410;&#12289;&#22810;&#23569;&#25159;&#21306;</span>
<span style="color: #a0522d;">Units</span> = sectors of 1 * <span style="color: #a0522d;">512</span> = 512 bytes <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#19968;&#20010;&#25159;&#21306;&#26159; 512 &#23383;&#33410;</span>
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0x000cfd1f   //&#30913;&#30424;&#26631;&#35782;&#31526;

   Device Boot      Start         End      Blocks   Id  System
/dev/sda1   *        2048     1026047      512000   83  Linux
/dev/sda2         1026048    20971519     9972736   8e  Linux LVM

&#20998;&#21306;&#20449;&#24687;&#35299;&#37322;&#65306;
boot : &#26143;&#21495;&#26631;&#35782;&#24341;&#23548;&#20998;&#21306;&#65306;&#25805;&#20316;&#31995;&#32479;&#22312;&#36825;&#20010;&#20998;&#21306;&#19978;&#35013;&#30528;
start-end : cento6&#26631;&#35782;&#26609;&#38754;&#30340;&#36215;&#22987;&#20301;&#32622;&#65292;centos7&#21017;&#26159;&#26631;&#35782;&#25159;&#21306;&#30340;&#36215;&#22987;&#20301;&#32622;
blocks : &#35774;&#22791;&#19978;&#19968;&#20849;&#22810;&#23569;&#20010;&#22359;&#65292;&#20197;1K&#20026;&#21333;&#20301;
id : &#34920;&#31034;&#20998;&#21306;&#25152;&#22312;&#22330;&#26223;&#31867;&#22411;&#65307;Linux&#27491;&#24120;&#20998;&#21306;&#37117;&#29992;83&#26469;&#34920;&#31034;&#65292;&#25193;&#23637;5,&#20132;&#25442;&#20998;&#21306;82  &#12290; 83&#20026;16&#36827;&#21046;&#30340;&#25968;&#23383;&#65307;
System : &#35299;&#37322;id&#25152;&#23545;&#24212;&#30340;&#24847;&#20041;&#26159;&#20160;&#20040; &#12290;&#20027;&#20998;&#21306;linux&#12289;&#25193;&#23637;&#20998;&#21306;Extended&#12289;Linux LVM

<span style="color: #b22222;"># </span><span style="color: #b22222;">awk 'BEGIN{a=512000;printf "%sgb",a/1024/1024}'</span>
0.488281gb
</pre>
</div>

<p>
范例：识别SSD和机械硬盘类型
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1&#34920;&#31034;&#26426;&#26800;&#65292;0&#34920;&#31034;SSD</span>

[root@centos8 ~]#lsblk -d -o name,rota
NAME  ROTA
sda     1
sr0     1
nvme0n1   0
nvme0n2   0

[root@centos8 ~]#ls /sys/block/
nvme0n1 nvme0n2 sda sr0
[root@centos8 ~]#cat /sys/block/*/queue/rotational
0
0
1
1
[root@centos8 ~]#cat /sys/block/sda/queue/rotational
1
[root@centos8 ~]#cat /sys/block/sr0/queue/rotational
1
[root@centos8 ~]#cat /sys/block/nvme0n1/queue/rotational
0
[root@centos8 ~]#cat /sys/block/nvme0n2/queue/rotational
0
</pre>
</div>


<figure id="org158712e">
<img src="images/image-20210216020526867.png" alt="image-20210216020526867.png" width="60%">

</figure>

<p>
<b>区位记录磁盘扇区结构ZBR（Zoned Bit Recording）</b>
</p>



<figure id="org009ac43">
<img src="images/image-20210216020540832.png" alt="image-20210216020540832.png" width="60%">

</figure>

<p>
内外分的扇区个数不一样
</p>

<p>
<b>CHS</b>
</p>

<ul class="org-ul">
<li>传统的CHS采用 24 bit位寻址</li>

<li>其中前10位表示cylinder，中间8位表示head，后面6位表示sector</li>

<li><p>
最大寻址空间 8 GB
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">echo 2^24*512/1024/1024|bc</span>
8192
</pre>
</div>

<p>
这样硬盘容量太小，后面就用LBA了
</p></li>
</ul>

<p>
<b>LBA（logical block addressing）</b>
</p>

<ul class="org-ul">
<li>LBA是一个整数，通过转换成 CHS 格式完成磁盘具体寻址</li>
<li>ATA-1规范中定义了28位寻址模式，以每扇区512位组来计算，ATA-1所定义的
28位LBA上限达到128 GiB。2002年ATA-6规范采用48位LBA，同样以每扇区512
位组计算容量上限可达128Petabytes</li>
</ul>

<p>
由于CHS寻址方式的寻址空间在大概8GB以内，所以在磁盘容量小于大概8GB时，
可以使用CHS寻址方式或是LBA寻址方式；在磁盘容量大于大概8GB时，则只能使
用LBA寻址方式
</p>

<p>
<b>硬盘读数据快慢因素</b>
</p>

<ol class="org-ol">
<li>询道时间</li>
<li>旋转时间。第1个数据到第2个数据磁头转动</li>
<li>读写时间</li>
</ol>

<p>
磁盘转速越快，读数据花时间就越少
</p>

<p>
小技巧：数据放在磁盘外圈更快，编号越小是外圈越大是里圈。那么sda1比sda5
读取数据速度要快。固态硬盘没有机械移动的过程不存在这个情况。
</p>


<figure id="orgd4982b7">
<img src="images/image-20210216020556795.png" alt="image-20210216020556795.png">

</figure>

<p>
机械硬盘数据可恢复率比固态好，固态硬件坏了数据可能完全丢失。
</p>
</div>
</div>
</section>
<section id="outline-container-h:4ca4008e-c9b5-4b46-9dc7-9c2113bae262" class="outline-2">
<h2 id="h:4ca4008e-c9b5-4b46-9dc7-9c2113bae262">管理存储</h2>
<div class="outline-text-2" id="text-h:4ca4008e-c9b5-4b46-9dc7-9c2113bae262">
<p>
使用磁盘空间过程
</p>

<ol class="org-ol">
<li>设备分区</li>
<li>创建文件系统</li>
<li>挂载新的文件系统</li>
</ol>
</div>
<div id="outline-container-h:9e2bd0c1-21d6-4ca7-8d54-8451e7ac787d" class="outline-3">
<h3 id="h:9e2bd0c1-21d6-4ca7-8d54-8451e7ac787d">磁盘分区</h3>
<div class="outline-text-3" id="text-h:9e2bd0c1-21d6-4ca7-8d54-8451e7ac787d">
</div>
<div id="outline-container-h:28ebaa3c-505e-4ba1-808c-9aec2771f8e4" class="outline-4">
<h4 id="h:28ebaa3c-505e-4ba1-808c-9aec2771f8e4">为什么分区</h4>
<div class="outline-text-4" id="text-h:28ebaa3c-505e-4ba1-808c-9aec2771f8e4">
<ul class="org-ul">
<li>优化I/O性能</li>
<li>实现磁盘空间配额限制</li>
<li>提高修复速度</li>
<li>隔离系统和程序</li>
<li>安装多个OS</li>
<li>采用不同文件系统</li>
</ul>
</div>
</div>
<div id="outline-container-h:3d1827ec-69f5-4770-9a06-717911832c59" class="outline-4">
<h4 id="h:3d1827ec-69f5-4770-9a06-717911832c59">分区方式</h4>
<div class="outline-text-4" id="text-h:3d1827ec-69f5-4770-9a06-717911832c59">
<p>
两种分区方式：MBR，GPT
</p>
</div>
<div id="outline-container-h:649c5210-a646-4550-a6a7-3dab6c9d393f" class="outline-5">
<h5 id="h:649c5210-a646-4550-a6a7-3dab6c9d393f">MBR分区</h5>
<div class="outline-text-5" id="text-h:649c5210-a646-4550-a6a7-3dab6c9d393f">
<p>
MBR：Master Boot Record，1982年，使用32位表示扇区数，分区不超过2T
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">echo 2^32*512/1024/1024/1024|bc</span>
2048
</pre>
</div>

<p>
划分分区的单位：
</p>

<ul class="org-ul">
<li>CentOS 5 之前按整柱面划分</li>
<li>CentOS 6 版本后可以按Sector划分</li>
</ul>

<p>
0磁道0扇区：512bytes
</p>

<ul class="org-ul">
<li>446bytes: boot loader</li>
<li>64bytes：分区表，其中每16bytes标识一个分区，因此只能存放4个分区信息</li>
<li>2bytes: 55AA 标识位，表示硬盘是有分区的</li>
</ul>

<p>
MBR分区中一块硬盘最多有4个主分区，也可以3主分区+1扩展(N个逻辑分区)
</p>

<p>
MBR分区：主和扩展分区对应的1&#x2013;4，/dev/sda3，逻辑分区从5开始，/dev/sda5
</p>

<p>
MBR分区结构
</p>


<figure id="org5b80ed1">
<img src="images/image-20210216020614182.png" alt="image-20210216020614182.png" width="90%">

</figure>

<ul class="org-ul">
<li>一个字节 = 8位（8个二进制位） 1Byte = 8bit；</li>
<li>一个十六进制 = 4个二进制位</li>
<li>一个字节 = 2个十六进制</li>
</ul>


<div class="org-src-container">
<pre class="src src-sh">[root@proxy ~]# hexdump -C -n 512 /dev/xvda <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#30913;&#30424;MBR&#20998;&#21306;&#20449;&#24687;</span>
00000000  eb 63 90 10 8e d0 bc 00  b0 b8 00 00 8e d8 8e c0  |.c..............|
00000010  fb be 00 7c bf 00 06 b9  00 02 f3 a4 ea 21 06 00  |...|.........!..|
......
000001a0  b4 0e cd 10 ac 3c 00 75  f4 c3 00 00 00 00 00 00  |.....&lt;.u........|
000001b0  00 00 00 00 00 00 00 00  0e 05 0b 00 00 00 80 20  |............... |
000001c0  21 00 83 fe ff ff 00 08  00 00 df f7 ff 04 00 00  |!...............|
000001d0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000001f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 55 aa  |..............U.|
00000200
</pre>
</div>


<figure id="org447a157">
<img src="images/image-20210216020715868.png" alt="image-20210216020715868.png" width="60%">

<figcaption><span class="figure-number">Figure 1: </span>image-20210216020715868</figcaption>
</figure>

<p>
硬盘主引导记录MBR由4个部分组成
</p>

<ul class="org-ul">
<li>主引导程序（偏移地址0000H&#x2013;0088H），它负责从活动分区中装载，并运行系
统引导程序</li>
<li>出错信息数据区，偏移地址0089H&#x2013;00E1H为出错信息，00E2H&#x2013;01BDH全为0字节</li>
<li>分区表（DPT,Disk Partition Table）含4个分区项，偏移地址01BEH&#x2013;01FDH,
每个分区表项长16个字节，共64字节为分区项1、分区项2、分区项3、分区项4</li>
<li>结束标志字，偏移地址01FE&#x2013;01FF的2个字节值为结束标志55AA</li>
</ul>

<p>
MBR中DPT结构
</p>


<figure id="org1ef5ebb">
<img src="images/image-20210216020731810.png" alt="image-20210216020731810.png" width="80%">

</figure>

<p>
范例: 备份MBR的分区表,并破坏后恢复
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;MBR&#20998;&#21306;&#34920;</span>
dd <span style="color: #a0522d;">if</span>=/dev/sda <span style="color: #a0522d;">of</span>=/data/dpt.img <span style="color: #a0522d;">bs</span>=1 <span style="color: #a0522d;">count</span>=64 <span style="color: #a0522d;">skip</span>=446 <span style="color: #b22222;"># </span><span style="color: #b22222;">skip&#36339;&#36807;&#28304;&#21069;446&#20010;&#23383;&#33410;&#65292;&#21482;&#22791;&#20221;&#20998;&#21306;&#34920;</span>
cp /data/dpt.img 10.0.0.102:~
hexdump -C /data/dpt.img <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20197;16&#36827;&#21046;&#26597;&#30475;&#25991;&#20214;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30772;&#22351;MBR&#20998;&#21306;&#34920;</span>
[root@centos8 ~]#dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=/dev/sda <span style="color: #a0522d;">bs</span>=1 <span style="color: #a0522d;">count</span>=64 <span style="color: #a0522d;">seek</span>=446 <span style="color: #b22222;"># </span><span style="color: #b22222;">seek &#30446;&#26631;&#30340;&#21069;446&#20010;&#23383;&#33410;&#36339;&#36807;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26080;&#27861;&#21551;&#21160;</span>
[root@centos8 ~]#reboot

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20809;&#30424;&#21551;&#21160;,&#36827;&#20837;rescue mode,&#36873;&#31532;3&#39033;skip to shell</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#32593;&#32476;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ifconfig ens160 10.0.0.8/24</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ip a a 10.0.0.8/24 dev/ens160</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">scp 10.0.0.102:/root/dpt.img .</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24674;&#22797;MBR&#20998;&#21306;&#34920;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">dd if=dpt.img of=/dev/sda bs=1 seek=446</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">exit</span>
</pre>
</div>

<p>
问题：利用分区策略相同的另一台主机的分区表来还原和恢复当前主机破环的分区表？
</p>
</div>
</div>
<div id="outline-container-h:bbf72e7e-292d-43ce-8106-726733eff049" class="outline-5">
<h5 id="h:bbf72e7e-292d-43ce-8106-726733eff049">GPT分区</h5>
<div class="outline-text-5" id="text-h:bbf72e7e-292d-43ce-8106-726733eff049">
<p>
GPT：GUID（Globals Unique Identifiers） partition table支持128个分区，
使用64位，支持8Z（512Byte/block ）64Z （ 4096Byte/block）
</p>

<p>
使用128位UUID(Universally Unique Identifier) 表示磁盘和分区
GPT分区表自动备份在头和尾两份，并有CRC校验位
</p>

<p>
UEFI (Unified Extensible Firmware Interface
统一可扩展固件接口)硬件支持GPT，使得操作系统可以启动
</p>

<p>
<b>GPT分区结构</b>
</p>


<figure id="orge23487d">
<img src="images/image-20210216020756367.png" alt="image-20210216020756367.png" width="80%">

</figure>

<p>
windows 中查看分区类型，“我的电脑”右键管理&#x2013;&gt;“磁盘管理”&#x2013;&gt;任意分区右键”属性”&#x2013;&gt;卷"磁盘分区形式"
</p>

<p>
GPT分区结构分为4个区域：
</p>

<ul class="org-ul">
<li>GPT头</li>
<li>分区表</li>
<li>GPT分区</li>
<li>备份区域</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:7621c54c-bfe7-4f2c-ab55-9e4febb30289" class="outline-4">
<h4 id="h:7621c54c-bfe7-4f2c-ab55-9e4febb30289">BIOS和UEFI</h4>
<div class="outline-text-4" id="text-h:7621c54c-bfe7-4f2c-ab55-9e4febb30289">
<p>
BIOS是固化在电脑主板上的程序，主要用于开机系统自检和引导操作系统。目前
新式的电脑基本上都是UEFI启动
</p>

<p>
BIOS（Basic Input Output System基本输入输出系统）主要完成系统硬件自检
和引导操作系统，操作系统开始启动之后，BIOS的任务就完成了。系统硬件自检：
如果系统硬件有故障，主板上的扬声器就会发出长短不同的”滴滴”音，可以简
单的判断硬件故障，比如”1长1短”通常表示内存故障，"1长3短"通常表示显卡
故障
</p>

<p>
BIOS在1975年就诞生了，使用汇编语言编写，当初只有16位，因此只能访问1M的
内存，其中前640K称为基本内存，后384K内存留给开机和各类BIOS本身使用。
BIOS只能识别到主引导记录（MBR）初始化的硬盘，最大支持2T的硬盘，4个主分
区（逻辑分区中的扩展分区除外），而目前普遍实现了64位系统，传统的BIOS已
经无法满足需求了，这时英特尔主导的EFI就诞生了
</p>

<p>
EFI（Extensible Firmware Interface）可扩展固件接口，是 Intel 为 PC固件
的体系结构、接口和服务提出的建议标准。其主要目的是为了提供一组在 OS加
载之前（启动前）在所有平台上一致的、正确指定的启动服务，被看做是BIOS的
继任者，或者理解为新版BIOS。
</p>

<p>
UEFI是由EFI1.10为基础发展起来的，它的所有者已不再是Intel，而是一个称作
Unified EFI Form的国际组织
</p>

<p>
UEFI(Unified Extensible Firmware Interface)统一的可扩展固件接口，是一
种详细描述类型接口的标准。UEFI相当于一个轻量化的操作系统，提供了硬件和
操作系统之间的一个接口，提供了图形化的操作界面。最关键的是引入了GPT分
区表，支持2T以上的硬盘，硬盘分区不受限制
</p>

<p>
<b>BIOS和UEFI区别</b>
</p>

<p>
BIOS采用了16位汇编语言编写，只能运行在实模式（内存寻址方式由16位段寄存
器的内容乘以16(10H)当做段基地址，加上16位偏移地址形成20位的物理地址）
下，可访问的内存空间为1MB，只支持字符操作界面
</p>

<p>
UEFI采用32位或者64位的C语言编写，突破了实模式的限制，可以达到最大的寻
址空间，支持图形操作界面，使用文件方式保存信息，支持GPT分区启动，适合
和较新的系统和硬件的配合使用
</p>

<p>
<b>BIOS+MBR与UEFI+GPT</b>
</p>


<figure id="org22cf0f5">
<img src="images/image-20210216020813567.png" alt="image-20210216020813567.png" width="60%">

</figure>

<p>
MSDN(Microsoft Developer Network)指出，Windows只能安装于BIOS+MBR或是UEF+GPT的组合上，
但是BIOS+GPT+GRUB启动Linux是可以的。
</p>

<p>
范例：查看磁盘分区类型
</p>
<div class="org-src-container">
<pre class="src src-sh">root@debian:~# fdisk -l
Disk /dev/sda: 20 GiB, 21474836480 bytes, 41943040 sectors
Disk model: VMware Virtual S
Units: sectors of 1 * <span style="color: #a0522d;">512</span> = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos   <span style="color: #b22222;">#</span><span style="color: #b22222;">dos &#20195;&#34920;MBR</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c91dfc83-06a0-4be7-b8e2-70442d7572ce" class="outline-4">
<h4 id="h:c91dfc83-06a0-4be7-b8e2-70442d7572ce">管理分区</h4>
<div class="outline-text-4" id="text-h:c91dfc83-06a0-4be7-b8e2-70442d7572ce">
<p>
列出块设备
</p>
<div class="org-src-container">
<pre class="src src-sh">lsblk
</pre>
</div>

<p>
创建分区命令
</p>
<div class="org-src-container">
<pre class="src src-sh">fdisk    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31649;&#29702;MBR&#20998;&#21306;</span>
gdisk   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31649;&#29702;GPT&#20998;&#21306;</span>
parted <span style="color: #b22222;">#</span><span style="color: #b22222;">&#39640;&#32423;&#20998;&#21306;&#25805;&#20316;&#65292;&#21487;&#20197;&#26159;&#20132;&#20114;&#25110;&#38750;&#20132;&#20114;&#26041;&#24335;</span>
</pre>
</div>

<p>
重新设置内存中的内核分区表版本，适合于除了CentOS 6 以外的其它版本5，7，8
</p>
<div class="org-src-container">
<pre class="src src-sh">partprobe
</pre>
</div>

<p>
不重启Linux识别新添加的硬盘
</p>
<div class="org-src-container">
<pre class="src src-sh">ls &#8211;l  /sys/class/scsi_host/
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26377;&#20960;&#20010;host&#25991;&#20214;&#20351;&#29992;&#21629;&#20196;&#25195;&#25551;&#65306;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'- - -'</span> &gt;/sys/class/scsi_host/host0/scan
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'- - -'</span> &gt;/sys/class/scsi_host/host1/scan
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'- - -'</span> &gt;/sys/class/scsi_host/host2/scan

[root@centos8 ~]#alias <span style="color: #a0522d;">scandisk</span>=<span style="color: #8b2252;">'echo - - - &gt;/sys/class/scsi_host/host0/scan;echo - - - &gt;/sys/class/scsi_host/host1/scan;echo - - - &gt; /sys/class/scsi_host/host2/scan'</span>
</pre>
</div>
</div>
<div id="outline-container-h:5f9d6e08-dfda-491b-8654-d7d8f1af32ba" class="outline-5">
<h5 id="h:5f9d6e08-dfda-491b-8654-d7d8f1af32ba">列出块设备 lsblk</h5>
<div class="outline-text-5" id="text-h:5f9d6e08-dfda-491b-8654-d7d8f1af32ba">
<div class="org-src-container">
<pre class="src src-sh">lsblk
&#36873;&#39033;&#19982;&#21442;&#25968;&#65306;
-d &#65306;&#20165;&#21015;&#20986;&#30913;&#30424;&#26412;&#36523;&#65292;&#24182;&#19981;&#20250;&#21015;&#20986;&#35813;&#30913;&#30424;&#30340;&#20998;&#21306;&#25968;&#25454;
-f &#65306;&#21516;&#26102;&#21015;&#20986;&#35813;&#30913;&#30424;&#20869;&#30340;&#25991;&#20214;&#31995;&#32479;&#21517;&#31216; ** 
-i &#65306;&#20351;&#29992; ASCII &#30340;&#32447;&#27573;&#36755;&#20986;&#65292;&#19981;&#35201;&#20351;&#29992;&#22797;&#26434;&#30340;&#32534;&#30721; &#65288;&#20877;&#26576;&#20123;&#29615;&#22659;&#19979;&#24456;&#26377;&#29992;&#65289;
-m &#65306;&#21516;&#26102;&#36755;&#20986;&#35813;&#35774;&#22791;&#22312; /dev &#19979;&#38754;&#30340;&#26435;&#38480;&#25968;&#25454; &#65288;rwx &#30340;&#25968;&#25454;&#65289;
-p &#65306;&#21015;&#20986;&#35813;&#35774;&#22791;&#30340;&#23436;&#25972;&#25991;&#20214;&#21517;&#65281;&#32780;&#19981;&#26159;&#20165;&#21015;&#20986;&#26368;&#21518;&#30340;&#21517;&#23383;&#32780;&#24050;&#12290;
-t &#65306;&#21015;&#20986;&#35813;&#30913;&#30424;&#35774;&#22791;&#30340;&#35814;&#32454;&#25968;&#25454;&#65292;&#21253;&#25324;&#30913;&#30424;&#20267;&#21015;&#26426;&#21046;&#12289;&#39044;&#35835;&#20889;&#30340;&#25968;&#25454;&#37327;&#22823;&#23567;&#31561;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]# lsblk  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#24403;&#21069;&#26377;&#22810;&#23569;&#22359;&#35774;&#22791;</span>
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
fd0      2:0    1    4K  0 disk 
sda      8:0    0  120G  0 disk 
&#9500;&#9472;sda1   8:1    0  512M  0 part /boot
&#9500;&#9472;sda2   8:2    0   20G  0 part /
&#9500;&#9472;sda3   8:3    0   20G  0 part /usr
&#9500;&#9472;sda4   8:4    0    1K  0 part 
&#9500;&#9472;sda5   8:5    0    2G  0 part [SWAP]
&#9492;&#9472;sda6   8:6    0   10G  0 part 
sr0     11:0    1  7.1G  0 rom  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20809;&#39537;</span>
&#36755;&#20986;&#20449;&#24687;&#35299;&#37322;&#65306;
NAME&#65306;&#23601;&#26159;&#35774;&#22791;&#30340;&#25991;&#20214;&#21517;&#65281;&#20250;&#30465;&#30053; /dev &#31561;&#21069;&#23548;&#30446;&#24405;
MAJ:MIN&#65306;&#20998;&#21035;&#26159;&#20027;&#35201;&#65306;&#27425;&#35201;&#35774;&#22791;&#20195;&#30721;
RM&#65306;&#26159;&#21542;&#20026;&#21487;&#21368;&#36733;&#35774;&#22791; &#65288;removable device&#65289;&#65292;&#22914;&#20809;&#30424;&#12289;USB &#30913;&#30424;&#31561;&#31561;
SIZE&#65306;&#24403;&#28982;&#23601;&#26159;&#23481;&#37327;
RO&#65306;&#26159;&#21542;&#20026;&#21482;&#35835;&#35774;&#22791;&#30340;&#24847;&#24605;
TYPE&#65306;&#26159;&#30913;&#30424; &#65288;disk&#65289;&#12289;&#20998;&#21306; &#65288;partition&#65289; &#36824;&#26159;&#21482;&#35835;&#23384;&#20648;&#22120; &#65288;rom&#65289; &#31561;&#36755;&#20986;
MOUTPOINT&#65306;&#25346;&#36733;&#28857;
</pre>
</div>

<p>
范例：识别SSD和机械硬盘类型
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1&#34920;&#31034;&#26426;&#26800;&#65292;0&#34920;&#31034;SSD</span>
[root@centos8 ~]#lsblk -d -o name,rota
NAME  ROTA
sda     1
sr0     1
nvme0n1   0
nvme0n2   0
</pre>
</div>
</div>
</div>
<div id="outline-container-h:09cba273-0615-45b6-905c-f05fc7feaa3c" class="outline-5">
<h5 id="h:09cba273-0615-45b6-905c-f05fc7feaa3c">parted 命令</h5>
<div class="outline-text-5" id="text-h:09cba273-0615-45b6-905c-f05fc7feaa3c">
<p>
<b>注意：parted的操作都是实时生效的，小心使用</b>
</p>

<p>
格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">parted [&#36873;&#39033;]... [&#35774;&#22791; [&#21629;&#20196; [&#21442;&#25968;]...]...]
</pre>
</div>

<p>
选项： -l 显示磁盘信息
</p>

<p>
范例：分区创建删除
</p>

<div class="org-src-container">
<pre class="src src-sh">parted /dev/sdb mklabel gpt|msdos  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#20998;&#21306;&#34920;&#65307;msdos&#34920;&#31034;MBR&#20998;&#21306;</span>
parted /dev/sdb unit mb print  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26174;&#31034;&#20998;&#21306;  &#21333;&#20301;&#26174;&#31034;&#19981;&#19968;&#33268;&#26102;&#65292;unit mb &#25351;&#23450;&#20197;mb&#26174;&#31034;</span>
parted /dev/sdb mkpart primary 1 200 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26032;&#22686;&#20998;&#21306;&#65288;&#40664;&#35748;&#22823;&#23567;M&#65289;&#31435;&#21363;&#29983;&#25928;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">lsblk    &#12289;ll /dev/sdb* &#12289;cat /proc/partitions &#26597;&#30475;&#20998;&#21306; </span>
parted /dev/sdb rm 1  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#20998;&#21306;</span>
parted &#8211;l  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;&#30828;&#30424;&#20998;&#21306;&#20449;&#24687;</span>
</pre>
</div>

<p>
范例：创建分区并格式化文件系统
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir /data
parted /dev/vdb mklabel gpt
parted -s /dev/vdb <span style="color: #8b2252;">'mkpart primary 1049k -1'</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">parted /dev/vdb mkpart primary xfs 0G 4398GB</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">parted -s /dev/vdb mkpart primary 0 100%</span>
mkfs.ext4  /dev/vdb1
<span style="color: #b22222;">#</span><span style="color: #b22222;">mkfs.xfs -f /dev/vdb1</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">blkid</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"/dev/vdb1  /data1                       ext4    defaults,nodelalloc,noatime       0 2"</span> &gt;&gt;/etc/fstab
mount -a
</pre>
</div>

<p>
范例: 新增分区
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#parted /dev/sdb print
Partition Table: unknown
[root@centos8 ~]#parted /dev/sdb mklabel gpt
[root@centos8 ~]#parted /dev/sdb print
Partition Table: gpt
[root@centos8 ~]#parted /dev/sdb mkpart primary 1 1001
[root@centos8 ~]#parted /dev/sdb print
Model: VMware, VMware Virtual S (scsi)
Disk /dev/sdb: 21.5GB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags:
Number Start  End   Size  File system Name   Flags
1   1049kB 1001MB 1000MB        primary
[ 1 ] [ 2 ] [ 3 ] [ 4 ] [ 5 ] [ 6 ]
1. Number&#65306;&#36825;&#20010;&#23601;&#26159;&#20998;&#21306;&#30340;&#21495;&#30721;&#21862;&#65281;&#20030;&#20363;&#26469;&#35828;&#65292;1&#21495;&#20195;&#34920;&#30340;&#26159; /dev/sdb1 &#30340;&#24847;&#24605;&#65307;
2. Start&#65306;&#20998;&#21306;&#30340;&#36215;&#22987;&#20301;&#32622;&#22312;&#36825;&#39063;&#30913;&#30424;&#30340;&#22810;&#23569; MB &#22788;&#65311;
3. End&#65306;&#27492;&#20998;&#21306;&#30340;&#32467;&#26463;&#20301;&#32622;&#22312;&#36825;&#39063;&#30913;&#30424;&#30340;&#22810;&#23569; MB &#22788;&#65311;
4. Size&#65306;&#30001;&#19978;&#36848;&#20004;&#32773;&#30340;&#20998;&#26512;&#65292;&#24471;&#21040;&#36825;&#20010;&#20998;&#21306;&#26377;&#22810;&#23569;&#23481;&#37327;&#65307;
5. File system&#65306;&#20998;&#26512;&#21487;&#33021;&#30340;&#25991;&#20214;&#31995;&#32479;&#31867;&#22411;&#20026;&#20309;&#30340;&#24847;&#24605;&#65281;
6. Name&#65306;&#23601;&#22914;&#21516; gdisk &#30340; System ID &#20043;&#24847;&#12290;
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#39044;&#30041;&#20102;1048k&#65292;&#20026;&#23558;&#26469;&#23384;&#25918;&#21644;&#35745;&#31639;&#26426;&#21551;&#21160;&#30456;&#20851;&#30340;&#19996;&#35199;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#20998;&#21306;</span>
[root@centos8 ~]#parted /dev/sdb mkpart primary 1002 1102
Information: You may need to update /etc/fstab.

[root@centos8 ~]#parted /dev/sdb print
Model: VMware, VMware Virtual S (scsi)
Disk /dev/sdb: 21.5GB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Number Start  End   Size  File system Name   Flags
1   1049kB 1001MB 1000MB        primary
2   1002MB 1102MB  99.6MB        primary

[root@centos8 ~]#parted /dev/sdb rm 2
[root@centos8 ~]#parted /dev/sdb print                  
Model: VMware, VMware Virtual S (scsi)
Disk /dev/sdb: 21.5GB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags:
Number Start  End   Size  File system Name   Flags
1   1049kB 1001MB 1000MB        primary

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21361;&#38505;&#65281;&#21361;&#38505;&#65281;&#21247;&#20081;&#25630;&#65281;&#26080;&#27861;&#22797;&#21407;&#65281;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26356;&#25913;&#29616;&#22312;&#20998;&#21306;&#34920;&#31867;&#22411;</span>
[root@centos8 ~]#parted /dev/sdb mklabel msdos
Warning: The existing disk label on /dev/sdb will be destroyed and all data on
this disk will be lost. Do you want to continue?
Yes/No? Y
Information: You may need to update /etc/fstab.

[root@centos8 ~]#parted /dev/sdb print             
Model: VMware, VMware Virtual S (scsi)
Disk /dev/sdb: 21.5GB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags:
Number Start End Size Type File system Flags
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6d53ac13-e5e5-4ef7-817b-efa6882d6728" class="outline-5">
<h5 id="h:6d53ac13-e5e5-4ef7-817b-efa6882d6728">分区工具fdisk和gdisk</h5>
<div class="outline-text-5" id="text-h:6d53ac13-e5e5-4ef7-817b-efa6882d6728">
<div class="org-src-container">
<pre class="src src-sh">gdisk [device...]       &#31867;fdisk &#30340;GPT&#20998;&#21306;&#24037;&#20855;
fdisk -l [-u] [device...]   &#26597;&#30475;&#20998;&#21306;
fdisk [device...]       &#31649;&#29702;MBR\GPT&#20998;&#21306;
</pre>
</div>

<p>
子命令：适用于fdisk, gdisk命令
</p>

<div class="org-src-container">
<pre class="src src-sh">m &#24110;&#21161;
p &#20998;&#21306;&#21015;&#34920;
t &#26356;&#25913;&#20998;&#21306;&#31867;&#22411;
l &#26597;&#30475;&#25152;&#26377;&#24050;&#30693;&#30340;&#20998;&#21306;&#31867;&#22411; ID **
n &#21019;&#24314;&#26032;&#20998;&#21306;
d &#21024;&#38500;&#20998;&#21306;
v &#26657;&#39564;&#20998;&#21306;
u &#36716;&#25442;&#21333;&#20301;
w &#20445;&#23384;&#24182;&#36864;&#20986;
q &#19981;&#20445;&#23384;&#24182;&#36864;&#20986;
</pre>
</div>

<p>
查看内核是否已经识别新的分区
</p>

<div class="org-src-container">
<pre class="src src-sh">cat /proc/partitions
</pre>
</div>

<p>
<b>CentOS7,8 同步分区表</b>
</p>
<div class="org-src-container">
<pre class="src src-shell">partprobe
</pre>
</div>

<p>
<b>CentOS6 通知内核重新读取硬盘分区表</b>
</p>

<p>
新增分区用
</p>
<div class="org-src-container">
<pre class="src src-sh">partx -a /dev/DEVICE
kpartx -a /dev/DEVICE -f: force

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;</span>
[root@centos6 ~]#partx -a /dev/sda
</pre>
</div>

<p>
删除分区用
</p>

<div class="org-src-container">
<pre class="src src-sh">partx -d --nr M-N /dev/DEVICE
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;</span>
[root@centos6 ~]#partx -d --nr 6-8 /dev/sda
</pre>
</div>

<p>
范例:非交互式创建分区
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">'n\np\n\n\n+2G\nw\n'</span> | fdisk /dev/sdb

fdisk /dev/sdb &lt;&lt;EOF
<span style="color: #ffa54f;">n</span>
<span style="color: #ffa54f;">p</span>


<span style="color: #ffa54f;">+1G</span>
<span style="color: #ffa54f;">w</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
范例: fdisk分区
</p>

<div class="org-src-container">
<pre class="src src-sh">&#21019;&#24314;&#25193;&#23637;&#20998;&#21306;
[root@node01 ~]# fdisk /dev/sdb
n  &#21019;&#24314;&#26032;&#20998;&#21306;
e  &#36873;&#25321;&#20998;&#21306;&#31867;&#22411;&#65292;p &#20026;&#20027;&#20998;&#21306;&#65292;e &#20026;&#25193;&#23637;&#20998;&#21306;
Partition number (1-4, default 1):    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#21306;&#32534;&#21495;&#40664;&#35748;</span>
First sector (2048-41943039, default 2048):    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25159;&#21306;&#24320;&#22987;&#20301;&#32622;&#12290;&#22238;&#36710;&#20026;&#40664;&#35748;</span>
Last sector, +sectors or +size{K,M,G} (2048-41943039, default 41943039): +10G <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25159;&#21306;&#32467;&#26463;&#20301;&#32622;&#12290;&#26377;2&#31181;&#26041;&#24335;&#65292;&#25351;&#23450;&#25159;&#21306;&#21644;&#25351;&#23450;&#22823;&#23567;&#12290;&#25351;&#23450;&#22823;&#23567;&#27604;&#36739;&#26041;&#20415;</span>
p &#25171;&#21360;&#20998;&#21306;&#20449;&#24687;
Disk /dev/sdb: 21.5 GB, 21474836480 bytes, 41943040 sectors
   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1            2048    20973567    10485760    5  Extended
&#25193;&#23637;&#20998;&#21306;&#19981;&#33021;&#21333;&#29420;&#20351;&#29992;&#65292;&#35201;&#32487;&#32493;&#20998;&#25104;&#36923;&#36753;&#20998;&#21306;
n  &#21019;&#24314;&#26032;&#20998;&#21306;
Partition type:
   l   logical (numbered from 5)
<span style="color: #0000ff;">Select</span> (default p): l <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36873;&#25321;&#20998;&#21306;&#31867;&#22411;&#65292;l &#20026;&#36923;&#36753;&#20998;&#21306;</span>
First sector (4096-20973567, default 4096):
Using default value 4096
Last sector, +sectors or +size{K,M,G} (4096-20973567, default 20973567): +2G     
<span style="color: #0000ff;">Command</span> (m for help): p


Disk /dev/sdb: 21.5 GB, 21474836480 bytes, 41943040 sectors
   Device Boot      Start         End      Blocks   Id  System

/dev/sdb1            2048    20973567    10485760    5  Extended
/dev/sdb5            4096     4198399     2097152   83  Linux
w &#20445;&#23384;&#24182;&#36864;&#20986;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22686;&#21152;&#20102;6,7&#20998;&#21306;</span>
[root@centos6 ~]#fdisk /dev/sda
<span style="color: #0000ff;">Command</span> (m for help): w
The partition table has been altered!
Calling ioctl() to re-read partition table.

WARNING: Re-reading the partition table failed with error 16: Device or resource busy.
The kernel still uses the old table. The new table will be used at
the next reboot or after you run partprobe(8) or kpartx(8)
Syncing disks.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#21306;&#34920;&#19981;&#21516;&#27493;</span>
[root@centos6 ~]#lsblk
NAME  MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
sr0   11:0   1  3.7G  0 rom 
sda    8:0   0 200G  0 disk
&#9500;&#9472;sda1  8:1   0  1G  0 part /boot
&#9500;&#9472;sda2  8:2   0 97.7G  0 part /
&#9500;&#9472;sda3  8:3   0 48.8G  0 part /data
&#9500;&#9472;sda4  8:4   0  1K  0 part
&#9492;&#9472;sda5  8:5   0  2G  0 part [SWAP]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#27493;&#20998;&#21306;&#34920;</span>
[root@centos6 ~]#partx -a /dev/sda
BLKPG: Device or resource busy
error adding partition 1
BLKPG: Device or resource busy
error adding partition 2
BLKPG: Device or resource busy
error adding partition 3
BLKPG: Device or resource busy
error adding partition 4
BLKPG: Device or resource busy
error adding partition 5
[root@centos6 ~]#lsblk
NAME  MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
sr0   11:0   1  3.7G  0 rom 
sda    8:0   0 200G  0 disk
&#9500;&#9472;sda1  8:1   0  1G  0 part /boot
&#9500;&#9472;sda2  8:2   0 97.7G  0 part /
&#9500;&#9472;sda3  8:3   0 48.8G  0 part /data
&#9500;&#9472;sda4  8:4   0  1K  0 part
&#9500;&#9472;sda5  8:5   0  2G  0 part [SWAP]
&#9500;&#9472;sda6  8:6   0  2G  0 part
&#9492;&#9472;sda7  8:7   0  3G  0 part

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#20102;6,7&#20998;&#21306;</span>
[root@centos6 ~]#fdisk /dev/sda
<span style="color: #0000ff;">Command</span> (m for help): w
The partition table has been altered!
Calling ioctl() to re-read partition table.
WARNING: Re-reading the partition table failed with error 16: Device or resource
busy.
The kernel still uses the old table. The new table will be used at
the next reboot or after you run partprobe(8) or kpartx(8)
Syncing disks.
[root@centos6 ~]#
[root@centos6 ~]#lsblk
NAME  MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
sr0   11:0   1  3.7G  0 rom 
sda    8:0   0 200G  0 disk
&#9500;&#9472;sda1  8:1   0  1G  0 part /boot
&#9500;&#9472;sda2  8:2   0 97.7G  0 part /
&#9500;&#9472;sda3  8:3   0 48.8G  0 part /data
&#9500;&#9472;sda4  8:4   0  1K  0 part
&#9500;&#9472;sda5  8:5   0  2G  0 part [SWAP]
&#9500;&#9472;sda6  8:6   0  2G  0 part
&#9492;&#9472;sda7  8:7   0  3G  0 part

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#27493;&#20998;&#21306;&#34920;</span>
[root@centos6 ~]#partx -d --nr 6-7 /dev/sda
[root@centos6 ~]#lsblk
NAME  MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
sr0   11:0   1  3.7G  0 rom 
sda    8:0   0 200G  0 disk
&#9500;&#9472;sda1  8:1   0  1G  0 part /boot
&#9500;&#9472;sda2  8:2   0 97.7G  0 part /
&#9500;&#9472;sda3  8:3   0 48.8G  0 part /data
&#9500;&#9472;sda4  8:4   0  1K  0 part
&#9492;&#9472;sda5  8:5   0  2G  0 part [SWAP]
</pre>
</div>

<p>
范例：gdisk分区, 默认MBR会转成GPT
</p>
<div class="org-src-container">
<pre class="src src-sh">gdisk /dev/sdb  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21644;fdisk &#20132;&#20114;&#36873;&#39033;&#19968;&#26679;</span>
p <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;</span>
n <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26032;&#24314;&#20998;&#21306;</span>
w <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20445;&#23384;</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:b3fbddc6-7cdb-4263-b4d2-a2d36c8301bb" class="outline-3">
<h3 id="h:b3fbddc6-7cdb-4263-b4d2-a2d36c8301bb">文件系统</h3>
<div class="outline-text-3" id="text-h:b3fbddc6-7cdb-4263-b4d2-a2d36c8301bb">
</div>
<div id="outline-container-h:3c131bca-7170-492f-acb2-42982c9137a0" class="outline-4">
<h4 id="h:3c131bca-7170-492f-acb2-42982c9137a0">文件系统概念</h4>
<div class="outline-text-4" id="text-h:3c131bca-7170-492f-acb2-42982c9137a0">
<p>
文件系统是操作系统用于明确存储设备或分区上的文件的方法和数据结构；即在
存储设备上组织文件的方法。操作系统中负责管理和存储文件信息的软件结构称
为文件管理系统，简称文件系统
</p>

<p>
从系统角度来看，文件系统是对文件存储设备的空间进行组织和分配，负责文件
存储并对存入的文件进行保护和检索的系统。具体地说，它负责为用户建立文件，
存入、读出、修改、转储文件，控制文件的存取，安全控制，日志，压缩，加密
等
</p>

<p>
支持的文件系统：
</p>

<div class="org-src-container">
<pre class="src src-sh">ls /lib/modules/<span style="color: #ff00ff;">`uname -r`</span>/kernel/fs

[root@proxy ~]# grep -i ext4 /boot/config-3.10.0-1160.119.1.el7.x86_64 
<span style="color: #a0522d;">CONFIG_EXT4_FS</span>=m  <span style="color: #b22222;">#</span><span style="color: #b22222;">m&#34920;&#31034;&#26159;&#19968;&#20010;&#29420;&#31435;&#30340;&#30913;&#30424;&#25991;&#20214;&#65292;y&#34920;&#31034;&#38598;&#25104;&#22312;&#20869;&#26680;&#20013;</span>
<span style="color: #a0522d;">CONFIG_EXT4_USE_FOR_EXT23</span>=y
</pre>
</div>

<p>
各种文件系统：<a href="https://en.wikipedia.org/wiki/Comparison_of_file_systems">https://en.wikipedia.org/wiki/Comparison_of_file_systems</a>
</p>

<p>
帮助：man 5 fs
</p>
</div>
</div>
<div id="outline-container-h:a5a0758b-405a-4efb-8f7f-ff9cb367f5b7" class="outline-4">
<h4 id="h:a5a0758b-405a-4efb-8f7f-ff9cb367f5b7">文件系统类型</h4>
<div class="outline-text-4" id="text-h:a5a0758b-405a-4efb-8f7f-ff9cb367f5b7">
<p>
<b>Linux 常用文件系统</b>
</p>

<ul class="org-ul">
<li>ext2：Extended file system
适用于那些分区容量不是太大，更新也不频繁的情况，例如 /boot 分区</li>
<li>ext3：是 ext2
的改进版本，其支持日志功能，能够帮助系统从非正常关机导致的异常中恢复</li>
<li>ext4：是 ext文件系统的最新版。提供了很多新的特性，包括纳秒级时间戳、
创建和使用巨型文件(16TB)、最大1EB的文件系统，以及速度的提升</li>
<li>xfs：SGI，支持最大8EB的文件系统</li>
<li>swap</li>
<li>iso9660 光盘</li>
<li>btrfs（Oracle）</li>
<li>reiserfs</li>
</ul>

<p>
<b>Windows 常用文件系统</b>
</p>

<ul class="org-ul">
<li>FAT32</li>
<li>NTFS</li>
<li>exFAT</li>
</ul>

<p>
<b>Unix：</b>
</p>

<ul class="org-ul">
<li>FFS（fast）</li>
<li>UFS（unix）</li>
<li>JFS2</li>
</ul>

<p>
<b>网络文件系统：</b>
</p>

<ul class="org-ul">
<li>NFS</li>
<li>CIFS</li>
</ul>

<p>
<b>集群文件系统：</b>
</p>

<ul class="org-ul">
<li>GFS2</li>
<li>OCFS2（oracle）</li>
</ul>

<p>
<b>分布式文件系统：</b>
</p>

<ul class="org-ul">
<li>fastdfs</li>
<li>ceph</li>
<li>moosefs</li>
<li>mogilefs</li>
<li>glusterfs</li>
<li>Lustre</li>
</ul>

<p>
<b>RAW：</b> 未经处理或者未经格式化产生的文件系统
</p>

<p>
<b>常用的文件系统特性：</b> <b>FAT32</b>
</p>

<ul class="org-ul">
<li>最多只能支持16TB的文件系统和4GB的文件</li>
</ul>

<p>
<b>NTFS</b>
</p>

<ul class="org-ul">
<li>最多只能支持16EB的文件系统和16EB的文件</li>
</ul>

<p>
<b>EXT3</b>
</p>

<ul class="org-ul">
<li>最多只能支持32TB的文件系统和2TB的文件，实际只能容纳2TB的文件系统和16GB的文件</li>
<li>Ext3目前只支持32000个子目录</li>
<li>Ext3文件系统使用32位空间记录块数量和 inode数量</li>
<li>当数据写入到Ext3文件系统中时，Ext3的数据块分配器每次只能分配一个4KB的块</li>
</ul>

<p>
<b>EXT4：</b>
</p>

<ul class="org-ul">
<li>EXT4是Linux系统下的日志文件系统，是EXT3文件系统的后继版本</li>
<li>Ext4的文件系统容量达到1EB，而支持单个文件则达到16TB</li>
<li>理论上支持无限数量的子目录</li>
<li>Ext4文件系统使用64位空间记录块数量和 inode数量</li>
<li>Ext4的多块分配器支持一次调用分配多个数据块</li>
<li>修复速度更快</li>
</ul>

<p>
<b>XFS</b>
</p>

<ul class="org-ul">
<li>根据所记录的日志在很短的时间内迅速恢复磁盘文件内容</li>
<li>用优化算法，日志记录对整体文件操作影响非常小</li>
<li>是一个全64-bit的文件系统，最大可以支持8EB的文件系统，而支持单个文件则达到8EB</li>
<li>能以接近裸设备I/O的性能存储数据</li>
</ul>

<p>
查前支持的文件系统：
</p>

<div class="org-src-container">
<pre class="src src-sh">cat /proc/filesystems
</pre>
</div>
</div>
</div>
<div id="outline-container-h:408140a8-173d-44ea-a166-f9b6b77d2895" class="outline-4">
<h4 id="h:408140a8-173d-44ea-a166-f9b6b77d2895">文件系统的组成部分</h4>
<div class="outline-text-4" id="text-h:408140a8-173d-44ea-a166-f9b6b77d2895">
<ul class="org-ul">
<li>内核中的模块：ext4, xfs, vfat</li>
<li>Linux的虚拟文件系统：VFS</li>
<li>用户空间的管理工具：mkfs.ext4, mkfs.xfs,mkfs.vfat</li>
</ul>


<figure id="org68ef4b1">
<img src="images/image-20210216020847687.png" alt="image-20210216020847687.png" width="60%">

</figure>

<p>
VFS: Virtual File
System，不同文件系统和上层接之间口的中间层
</p>
</div>
</div>
<div id="outline-container-h:432e0a58-303e-420b-8691-551154f8de43" class="outline-4">
<h4 id="h:432e0a58-303e-420b-8691-551154f8de43">文件系统选择管理</h4>
<div class="outline-text-4" id="text-h:432e0a58-303e-420b-8691-551154f8de43">
</div>
<div id="outline-container-h:63f2bda1-7472-4755-89e1-9b6e3ee6e585" class="outline-5">
<h5 id="h:63f2bda1-7472-4755-89e1-9b6e3ee6e585">创建文件系统</h5>
<div class="outline-text-5" id="text-h:63f2bda1-7472-4755-89e1-9b6e3ee6e585">
<p>
创建文件管理工具
</p>

<ul class="org-ul">
<li><p>
mkfs命令：
</p>

<div class="org-src-container">
<pre class="src src-sh">(1) mkfs.FS_TYPE /dev/DEVICE
ext4
xfs
btrfs
vfat
(2) mkfs -t FS_TYPE /dev/DEVICE
-L <span style="color: #8b2252;">'LABEL'</span> &#35774;&#23450;&#21367;&#26631;
</pre>
</div></li>

<li>mke2fs：ext系列文件系统专用管理工具</li>
</ul>

<p>
常用选项
</p>

<div class="org-src-container">
<pre class="src src-sh">-t {ext2|ext3|ext4|xfs}   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#25991;&#20214;&#31995;&#32479;&#31867;&#22411;</span>
-b {1024|2048|4096}  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#22359; block &#22823;&#23567;</span>
-L <span style="color: #8b2252;">'LABEL'</span>                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#21367;&#26631;</span>
-j                                    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#24403;&#20110; -t ext3&#65292; mkfs.ext3 = mkfs -t ext3 = mke2fs -j = mke2fs -t ext3</span>
-i                                    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#25968;&#25454;&#31354;&#38388;&#20013;&#27599;&#22810;&#23569;&#20010;&#23383;&#33410;&#21019;&#24314;&#19968;&#20010;inode&#65307;&#19981;&#24212;&#35813;&#23567;&#20110;block&#22823;&#23567;; &#40664;&#35748;&#27599;16kb&#30913;&#30424;&#31354;&#38388;&#20998;&#37197;&#19968;&#20010;inode&#65292;&#19968;&#20010;inode&#22823;&#23567;&#20026;256b</span>
-T                                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#31867;&#22411;&#65307; -T largefile &#30456;&#24403;&#20110; -i 104876</span>
-N                                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#20998;&#21306;&#20013;&#21019;&#24314;&#22810;&#23569;&#20010;inode</span>
-I                                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#20010;inode&#35760;&#24405;&#21344;&#29992;&#30340;&#30913;&#30424;&#31354;&#38388;&#22823;&#23567;&#65292;128---4096</span>
-m                                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;5%,&#20026;&#31649;&#29702;&#20154;&#21592;&#39044;&#30041;&#31354;&#38388;&#21344;&#24635;&#31354;&#38388;&#30340;&#30334;&#20998;&#27604;&#65292;&#30913;&#30424;&#28385;&#20102;&#21487;&#25805;&#20316;&#31354;&#38388;&#22823;&#23567;&#12290;&#30334;&#20998;&#27604;&#25968;&#20540;&#65307;#=1,2,3...100 &#23545;&#20110;&#22823;&#30913;&#30424;&#26469;&#35828;&#39044;&#30041;5%&#32473;&#36229;&#32423;&#31649;&#29702;&#21592;&#22810;&#20102;&#12290;</span>
-O FEATURE[,...]          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#25351;&#23450;&#29305;&#24615;</span>
-O ^FEATURE             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#38381;&#25351;&#23450;&#29305;&#24615;  &#8211;O ^has_journal &#34920;&#31034;&#21435;&#38500;&#26085;&#24535;&#21151;&#33021;</span>
-n                                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27169;&#25311;&#36816;&#34892;&#65292;&#20294;&#19981;&#26684;&#24335;&#21270;</span>
</pre>
</div>

<p>
范例： 创建ext4文件系统
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;ext4</span>
[root@node01 ~]# mkfs.ext4 /dev/sdb5
mke2fs 1.42.9 (28-Dec-2013)
Filesystem <span style="color: #a0522d;">label</span>=                                                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25991;&#20214;&#31995;&#32479;&#21367;&#26631;&#65292;&#36825;&#37324;&#27809;&#25351;&#23450;</span>
OS type: Linux                                                             <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25805;&#20316;&#31995;&#32479;</span>
Block <span style="color: #a0522d;">size</span>=4096 (<span style="color: #a0522d;">log</span>=2)                                             <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22359;&#22823;&#23567;&#65292;&#40664;&#35748;&#20026; 4k</span>
Fragment <span style="color: #a0522d;">size</span>=4096 (<span style="color: #a0522d;">log</span>=2)                                      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20998;&#22359;&#22823;&#23567;&#65292;&#40664;&#35748;&#20026; 4k</span>
<span style="color: #a0522d;">Stride</span>=0 blocks, Stripe <span style="color: #a0522d;">width</span>=0 blocks
131072 inodes, 524288 blocks                                   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19968;&#20849;&#21019;&#24314;&#22810;&#23569; inode &#21644; block</span>
26214 blocks (5.00%) reserved for the super user     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;block &#30913;&#30424;&#22359;&#20013;&#39044;&#30041;&#22810;&#23569;&#32473; &#36229;&#32423;&#31649;&#29702;&#21592;&#12290;&#23545;&#20110;&#22823;&#30913;&#30424;&#26469;&#35828;&#39044;&#30041;5%&#22810;&#20102;&#12290;</span>
First data <span style="color: #a0522d;">block</span>=0                                                       <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532; 1 &#20010;&#30913;&#30424;&#22359;&#30340;&#32534;&#21495;&#20174; 0 &#24320;&#22987;</span>
Maximum filesystem <span style="color: #a0522d;">blocks</span>=536870912                   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26368;&#22823;&#30913;&#30424;&#22359;&#32534;&#21495;</span>
16 block groups                                                          <span style="color: #b22222;"># </span><span style="color: #b22222;">&#30913;&#30424;&#22359;&#32452;&#20010;&#25968;</span>
32768 blocks per group, 32768 fragments per group      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#20010;&#22359;&#32452;&#20869;&#22810;&#23569;&#22359;</span>
8192 inodes per group                                                      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#20010;&#32452;&#20869;&#26377;&#22810;&#23569; inode</span>
Superblock backups stored on blocks:                              <span style="color: #b22222;"># </span><span style="color: #b22222;">superblock &#34987;&#20998;&#22312;&#21738;&#20123;&#22359;&#19978;&#20102;&#65292;&#27599;&#20010;&#22359;&#30340;&#32534;&#21495;</span>
    32768, 98304, 163840, 229376, 294912

Allocating group tables: done                            
Writing inode tables: done                                          <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27491;&#22312;&#20889;&#20837; inode &#34920;</span>
Creating journal (16384 blocks): done                         <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#26085;&#24535;&#21151;&#33021;</span>
Writing superblocks and filesystem accounting information: done

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25991;&#20214;&#31995;&#32479;&#30340; TYPE &#31867;&#22411;</span>
[root@node01 ~]# blkid /dev/sdb5

/dev/sdb5: <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"66d93d3e-0141-4147-ac2c-59fc811a089d"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"ext4"</span> <span style="color: #a0522d;">BLOCK_SIZE</span>=<span style="color: #8b2252;">"4096"</span>
UUID &#20840;&#21306;&#21807;&#19968;&#26631;&#35782;&#31526;
TYPE &#25991;&#20214;&#31995;&#32479;&#31867;&#22411;
BLOCK_SIZE &#25991;&#20214;&#31995;&#32479;&#23384;&#25918;&#25968;&#25454;&#26368;&#23567;&#21333;&#20301;&#12290;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;ext4&#29366;&#24577;&#21644;&#20803;&#25968;&#25454;</span>
tune2fs -l /dev/sdb5

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#25991;&#20214;&#31995;&#32479;&#25351;&#26126;&#21367;&#26631;</span>
[root@node01 ~]# mkfs.ext4 -L MYDATA -b 1024 /dev/sdb5
[root@node01 ~]# blkid /dev/sdb5
/dev/sdb5: <span style="color: #a0522d;">LABEL</span>=<span style="color: #8b2252;">"MYDATA"</span> <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"2d6d8919-1079-4235-923f-33d655b760f2"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"ext4"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#24102;&#26085;&#24535;&#30340;&#25991;&#20214;&#31995;&#32479;&#65292;&#40664;&#35748;ext3&#25991;&#20214;&#31995;&#32479;</span>
[root@node01 ~]# mke2fs -O has_journal  /dev/sdb5
[root@node01 ~]# blkid /dev/sdb5
/dev/sdb5: <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"c86bb335-6ea4-4fe6-bf4a-dfae0e9ab3eb"</span> <span style="color: #a0522d;">SEC_TYPE</span>=<span style="color: #8b2252;">"ext2"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"ext3"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#28040;&#26085;&#24535;&#29305;&#24615;</span>
[root@node01 ~]# mke2fs -O ^has_journal  /dev/sdb5
[root@node01 ~]# blkid /dev/sdb5
/dev/sdb5: <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"6bb9e6e1-0445-4487-9a12-dd1d3e70c045"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"ext2"</span>
</pre>
</div>

<p>
<b>格式化大容量磁盘</b>
</p>

<p>
格式化大容量磁盘，系统会分配过多inode，为inode预留过多空间，导致磁盘空
间占用特别大。
</p>

<p>
可以减小inode占用的磁盘空间，减少磁盘浪费
</p>

<p>
磁盘格式化后inode占用的磁盘空间：node数量 * 每个inode占用的空间 256b
/1024 换算为kb /1024 换算为 mb
</p>

<p>
默认2TB磁盘inode占用：
</p>

<div class="org-src-container">
<pre class="src src-sh">mkfs.ext4 -n /dev/sdc1
122101760 inodes, 488378368 blocks

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36890;&#36807;&#20197;&#19978;&#20449;&#24687;&#21487;&#20197;&#35745;&#31639;&#20986;&#30913;&#30424;&#26684;&#24335;&#21270;&#21518;inode&#21344;&#29992;&#30340;&#30913;&#30424;&#31354;&#38388;</span>
122101760 * 256 / 1024 / <span style="color: #a0522d;">1024</span> = 29810mb
</pre>
</div>

<p>
增大 <code>-i</code> 参数，为数据空间中每多少个字节创建一个inode：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;1m&#31354;&#38388;&#20998;&#37197;&#19968;&#20010;inode&#26469;&#26684;&#24335;&#21270;2TB&#30913;&#30424;</span>
mkfs.ext4 -i 1048576 -n /dev/sdc
1907840 inodes, 488378368 blocks
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;&#20197;&#19978;&#20449;&#24687;&#21487;&#20197;&#35745;&#31639;&#20986;&#30913;&#30424;&#26684;&#24335;&#21270;&#21518;inode&#21344;&#29992;&#30340;&#30913;&#30424;&#31354;&#38388;</span>
1907840 * 256 / 1024 / <span style="color: #a0522d;">1024</span> = 465mb 
&#26356;&#25913;-i&#21442;&#25968;&#65292;&#33410;&#30465;&#20102;29G&#31354;&#38388;
</pre>
</div>

<p>
除了更改-i参加，也可以直接通过-T参数直接指定多大磁盘空间分配一个inode
</p>

<div class="org-src-container">
<pre class="src src-sh">mkfs.ext4 -T largefile -n /dev/sdc1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20960;&#20046;&#22312;&#20960;&#20998;&#38047;&#23436;&#25104;&#24555;&#36895;&#26684;&#24335;&#21270;</span>
mkfs.ext4 -T largefile4 -n /dev/sdc1
</pre>
</div>

<p>
largefile和largefile4对应的【多大磁盘空间分配一个inode】其实是在
/etc/mke2fs.conf 定义的。
</p>

<ul class="org-ul">
<li>largefile 类型就是 1M 一个 inode</li>
<li>largefile4 类型就是 4M 一个 inode</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">mkfs.ext4 -N 314572800 -T largefile /dev/xvdb1
</pre>
</div>

<p>
因为ext4无法动态调整inode空间占比，所以选择将ext4改为xfs(支持动态调整
inode空间占比)
</p>

<p>
xfs硬盘格式inode空间占比(默认为5%)
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">xfs&#25991;&#20214;&#31995;&#32479;&#21160;&#24577;&#25193;&#23481;inode&#31354;&#38388;&#21344;&#27604;&#20026;10%</span>
xfs_growfs -m 10 /minio
</pre>
</div>
</div>
</div>
<div id="outline-container-h:12595ccb-f7d7-4028-92c1-5727c5d29a85" class="outline-5">
<h5 id="h:12595ccb-f7d7-4028-92c1-5727c5d29a85">查看和管理分区信息</h5>
<div class="outline-text-5" id="text-h:12595ccb-f7d7-4028-92c1-5727c5d29a85">
<p>
blkid 可以查看块设备属性信息 格式：
</p>
<div class="org-src-container">
<pre class="src src-sh">blkid [OPTION]... [DEVICE]

&#24120;&#29992;&#36873;&#39033;&#65306;
- -U UUID   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26681;&#25454;&#25351;&#23450;&#30340;UUID&#26469;&#26597;&#25214;&#23545;&#24212;&#30340;&#35774;&#22791;</span>
- -L LABEL  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26681;&#25454;&#25351;&#23450;&#30340;LABEL&#26469;&#26597;&#25214;&#23545;&#24212;&#30340;&#35774;&#22791; &#33539;&#20363;</span>
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# blkid
/dev/sda1: <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"740f2026-5852-4f08-ba89-03a41da96641"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"xfs"</span>
/dev/sda2: <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"kX2LpD-lIl1-sU1x-adD3-ZZDB-S0xt-uhNESv"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"LVM2_member"</span>
/dev/sr0: <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"2017-09-06-10-53-42-00"</span> <span style="color: #a0522d;">LABEL</span>=<span style="color: #8b2252;">"CentOS 7 x86_64"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"iso9660"</span> <span style="color: #a0522d;">PTTYPE</span>=<span style="color: #8b2252;">"dos"</span>
/dev/mapper/centos-root: <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"00d2160a-c185-4a69-b5d0-3616bc34bdac"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"xfs"</span>
/dev/mapper/centos-swap: <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"d99a0da9-3302-46cb-905a-79c12134ee70"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"swap"</span>
</pre>
</div>

<p>
e2label：管理ext系列文件系统的LABEL
</p>
<div class="org-src-container">
<pre class="src src-sh">e2label DEVICE [LABEL]
</pre>
</div>

<p>
findfs ：查找分区
</p>
<div class="org-src-container">
<pre class="src src-sh">findfs [options] <span style="color: #a0522d;">LABEL</span>=&lt;label&gt;
findfs [options] <span style="color: #a0522d;">UUID</span>=&lt;uuid&gt;
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#findfs <span style="color: #a0522d;">UUID</span>=f7f53add-b184-4ddc-8d2c-5263b84d1e15
/dev/sda2
</pre>
</div>

<p>
tune2fs：重新设定ext系列文件系统可调整参数的值
</p>
<div class="org-src-container">
<pre class="src src-sh">-l                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#25991;&#20214;&#31995;&#32479;&#36229;&#32423;&#22359;&#20449;&#24687;&#65307;super block</span>
-L <span style="color: #8b2252;">'LABEL'</span>  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#21367;&#26631;</span>
-m              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#39044;&#30041;&#32473;&#31649;&#29702;&#21592;&#30340;&#31354;&#38388;&#30334;&#20998;&#27604;</span>
-j                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;ext2&#21319;&#32423;&#20026;ext3</span>
-O              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25991;&#20214;&#31995;&#32479;&#23646;&#24615;&#21551;&#29992;&#25110;&#31105;&#29992;, &#8211;O ^has_journal</span>
-o               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35843;&#25972;&#25991;&#20214;&#31995;&#32479;&#30340;&#40664;&#35748;&#25346;&#36733;&#36873;&#39033;&#65292;&#8211;o ^acl</span>
-U UUID    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;UUID&#21495;</span>
</pre>
</div>

<p>
范例：tune2fs -l device ：查看超级块的内容
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# tune2fs -l /dev/sdb5
tune2fs 1.42.9 (28-Dec-2013)
Filesystem volume name:   HAHAH                                    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21367;&#26631;</span>
Last mounted on:          &lt;not available&gt;                            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19978;&#27425;&#20160;&#20040;&#26102;&#20505;&#25346;&#36733;&#12290; not available&#20026;&#19981;&#21487;&#29992;&#27809;&#25346;&#36733;&#36807;</span>
Filesystem UUID:          51f52968-de90-4595-a050-52d325f1805c     <span style="color: #b22222;"># </span><span style="color: #b22222;">UUID&#20840;&#21306;&#21807;&#19968;&#26631;&#35782;&#31526;</span>
Filesystem magic number:  0xEF53                                   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25991;&#20214;&#31995;&#32479;&#30340;&#39764;&#25968;&#65307;&#25991;&#20214;&#31995;&#32479;&#19987;&#29992;&#30340;&#26631;&#35782;</span>
Filesystem revision <span style="color: #b22222;">#</span><span style="color: #b22222;">:    1 (dynamic)  </span>
Filesystem features:      ext_attr resize_inode dir_index filetype sparse_super large_file   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24050;&#32463;&#21551;&#29992;&#29305;&#24615; &#12290;&#20351;&#29992; tune2fs -O [^]feature[,...]  &#24320;&#21551;&#25110;&#20851;&#38381;&#26576;&#31181;&#29305;&#24615;</span>
Filesystem flags:         signed_directory_hash                    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26631;&#24535;</span>
Default mount options:    user_xattr acl                           <span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;&#30340;&#25346;&#36733;&#36873;&#39033;&#65307;tune2fs -o [^]mount-option[,...] &#65306;&#24320;&#21551;&#25110;&#20851;&#38381;&#26576;&#31181;&#40664;&#35748;&#25346;&#36733;&#36873;&#39033;&#65307;</span>
Filesystem state:         clean                                              <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25991;&#20214;&#31995;&#32479;&#29366;&#24577;&#65307;clean &#34920;&#31034;&#19968;&#33268;&#29366;&#24577;&#21363;&#27809;&#26377;&#25991;&#20214;&#22788;&#20110;&#25439;&#22351;&#29366;&#24577;&#12290;dirty &#19981;&#24178;&#20928;&#19981;&#19968;&#33268;&#29366;&#24577;</span>
Errors behavior:          Continue                                       <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20986;&#29616;&#38169;&#35823;&#24590;&#20040;&#21150;&#65311;continue &#32487;&#32493;&#19981;&#31649;&#23427;</span>
Filesystem OS type:       Linux     
Inode count:              131072                                           <span style="color: #b22222;">#  </span><span style="color: #b22222;">inode &#25968;&#37327;</span>
Block count:              524288                                          <span style="color: #b22222;"># </span><span style="color: #b22222;">block &#25968;&#37327;</span>
Reserved block count:     26214                                    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#39044;&#30041; block &#25968;&#37327;</span>
Free blocks:              515284                                         <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31354;&#38386;&#22359;&#25968;</span>
Free inodes:              131061                                         <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31354;&#38386; inode &#25968;</span>
First block:              0                                                      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532; 1 &#20010;&#22359;&#32534;&#21495;</span>
Block size:               4096                                               <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#22359;&#22823;&#23567; </span>
Fragment size:            4096                                           <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20559;&#31227;&#65292;&#29255;&#26029;&#22823;&#23567;</span>
Reserved GDT blocks:      127                                      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#39044;&#30041;&#32473; GDT &#22359;&#32452;&#25551;&#36848;&#31526;&#30340;&#22823;&#23567;</span>
Blocks per group:         32768                                      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#32452;&#22810;&#23569;&#22359;</span>
Fragments per group:      32768                                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#32452;&#22810;&#23569;&#29255;&#26029;</span>
Inodes per group:         8192                                        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#32452;&#22810;&#23569; inode</span>
Inode blocks per group:   512                                      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#32452;&#26377;&#22810;&#23569;&#20010;&#22359;&#26159;&#25918; inode</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">tune2fs -j device &#26080;&#25439;&#21319;&#32423;&#25991;&#20214;&#31995;&#32479;</span>
mke2fs /dev/sdb5 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314; ext2 &#25991;&#20214;&#31995;&#32479;</span>
[root@node01 ~]# blkid /dev/sdb5
/dev/sdb5: <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"7a56c6bd-340c-4247-8ed8-37bb33cf0c36"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"ext2"</span>
[root@node01 ~]# tune2fs -j /dev/sdb5 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21319;&#32423;&#21040; ext3 &#25991;&#20214;&#31995;&#32479;</span>
Creating journal inode: done
[root@node01 ~]# blkid /dev/sdb5
/dev/sdb5: <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"7a56c6bd-340c-4247-8ed8-37bb33cf0c36"</span> <span style="color: #a0522d;">SEC_TYPE</span>=<span style="color: #8b2252;">"ext2"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"ext3</span>

<span style="color: #8b2252;"># tune2fs -m num &#35843;&#25972;&#39044;&#30041;&#32473;&#36229;&#32423;&#31649;&#29702;&#21592;&#30340;&#31354;&#38388;&#30334;&#20998;&#27604;&#12290;&#20174; 5% -&gt; 2%</span>
<span style="color: #8b2252;">[root@node01 ~]# tune2fs -l /dev/sdb5 |grep "</span>Reserved block count<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">Reserved block count:     26214</span>
<span style="color: #8b2252;">[root@node01 ~]# tune2fs -m 2 /dev/sdb5</span>

<span style="color: #8b2252;">Setting reserved blocks percentage to 2% (10485 blocks)</span>
<span style="color: #8b2252;">[root@node01 ~]# tune2fs -l /dev/sdb5 |grep "</span>Reserved block count<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">Reserved block count:     10485</span>

<span style="color: #8b2252;"># tune2fs -O ^has_journal &#20851;&#38381;&#25991;&#20214;&#31995;&#32479;&#26085;&#24535;&#29305;&#24615;</span>
<span style="color: #8b2252;">tune2fs -O ^has_journal /dev/sdb5</span>

<span style="color: #8b2252;"># tune2fs -o ^acl &#20851;&#38381;&#40664;&#35748;&#25346;&#36733;&#39033; acl </span>
<span style="color: #8b2252;">tune2fs -o ^acl /dev/sdb5</span>
</pre>
</div>

<p>
dumpe2fs：显示ext文件系统信息，将磁盘块分组管理
</p>

<div class="org-src-container">
<pre class="src src-shell">-h     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#36229;&#32423;&#22359;&#20449;&#24687;&#65292;&#19981;&#26174;&#31034;&#20998;&#32452;&#20449;&#24687;</span>
</pre>
</div>

<p>
范例：查看ext文件系统的元数据和块组信息
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dumpe2fs /dev/sda1
dumpe2fs 1.44.6 (5-Mar-2019)
Filesystem volume name:  &lt;none&gt;
Last mounted on:     /boot
Filesystem UUID:     5c2216e3-ae34-444e-aa60-83cbaebb47e7
Filesystem magic number: 0xEF53
Filesystem revision <span style="color: #b22222;">#</span><span style="color: #b22222;">:  1 (dynamic)</span>
Filesystem features:   has_journal ext_attr resize_inode dir_index filetype
needs_recovery extent 64bit flex_bg sparse_super large_file huge_file dir_nlink
extra_isize metadata_csum
Filesystem flags:     signed_directory_hash
Default mount options:  user_xattr acl
Filesystem state:     clean
Errors behavior:     Continue
Filesystem OS type:    Linux
Inode count:       65536
Block count:       262144
Reserved block count:   13107  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#39044;&#30041;&#31354;&#38388;&#22823;&#23567;</span>
Free blocks:       217118
Free inodes:       65227
First block:       0
Block size:        4096
Fragment size:      4096
Group descriptor size:  64
Reserved GDT blocks:   127
Blocks per group:     32768
Fragments per group:   32768
Inodes per group:     8192
Inode blocks per group:  512
Flex block group size:  16
Filesystem created:    Thu Jan 16 10:39:10 2020
Last mount time:     Mon Apr 13 12:03:10 2020
Last write time:     Mon Apr 13 12:03:10 2020
Mount count:       6
Maximum mount count:   -1
Last checked:       Thu Jan 16 10:39:10 2020
Check interval:      0 (&lt;none&gt;)
Lifetime writes:     236 MB
Reserved blocks uid:   0 (user root)
Reserved blocks gid:   0 (group root)
First inode:       11
Inode size:     256
Required extra isize:   32
Desired extra isize:   32
Journal inode:      8
Default directory hash:  half_md4
Directory Hash Seed:   5737d3fe-91ce-4cf3-bb5b-125ea41dd70f
Journal backup:      inode blocks
Checksum type:      crc32c
Checksum:         0x66531756
Journal features:     journal_incompat_revoke journal_64bit
journal_checksum_v3
Journal size:       32M
Journal length:      8192
Journal sequence:     0x00000150
Journal start:      1
Journal checksum type:  crc32c
Journal checksum:     0x96f6d31c
Group 0: (Blocks 0-32767)
  Primary superblock at 0, Group descriptors at 1-1        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20027;&#36229;&#32423;&#22359;&#22312; 0 &#32452;&#30340; 0 &#22359;&#19978;&#65292;GDT at 1-1</span>
  Reserved GDT blocks at 2-128                             <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20026; GDT &#39044;&#30041;&#30340;&#22359;&#22312; 2-128</span>
  Block bitmap at 129 (+129), Inode bitmap at 130 (+130)   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22359;&#20301;&#22270;&#22312; 129&#65292;inode &#20301;&#22270;&#22312; 130</span>
  Inode table at 131-642 (+131)                            <span style="color: #b22222;"># </span><span style="color: #b22222;">inode &#34920;&#22312; 131</span>
  32119 free blocks, 8181 free inodes, 2 directories       <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21097;&#20313;&#30340;&#31354;&#38388; block , inode</span>
  Free blocks: 649-32767                                   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#29992;&#22359;&#25968;&#12290;&#22914;&#26524;&#20986;&#29616;&#31163;&#25955;&#25968;&#65292;&#35828;&#26126;&#22359;&#20013;&#26377;&#30862;&#29255;&#12290;</span>
  Free inodes: 12-8192                                     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#29992; inode &#25968;</span>
Group 1: (Blocks 32768-65535)
  Backup superblock at 32768, Group descriptors at 32769-32769
  Reserved GDT blocks at 32770-32896
  Block bitmap at 32897 (+129), Inode bitmap at 32898 (+130)
  Inode table at 32899-33410 (+131)
  32125 free blocks, 8192 free inodes, 0 directories
  Free blocks: 33411-65535
  Free inodes: 8193-16384

... ... 
</pre>
</div>

<p>
xfs_info：显示示挂载或已挂载的 xfs 文件系统信息
</p>

<div class="org-src-container">
<pre class="src src-sh">xfs_info mountpoint|devname
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">xfs_info /dev/vda1</span>
meta-data=/dev/vda1              <span style="color: #a0522d;">isize</span>=512    <span style="color: #a0522d;">agcount</span>=4, <span style="color: #a0522d;">agsize</span>=13107136 blks
         =                       <span style="color: #a0522d;">sectsz</span>=512   <span style="color: #a0522d;">attr</span>=2, <span style="color: #a0522d;">projid32bit</span>=1
         =                       <span style="color: #a0522d;">crc</span>=1        <span style="color: #a0522d;">finobt</span>=0 <span style="color: #a0522d;">spinodes</span>=0
<span style="color: #a0522d;">data</span>     =                       <span style="color: #a0522d;">bsize</span>=4096   <span style="color: #a0522d;">blocks</span>=52428544, <span style="color: #a0522d;">imaxpct</span>=25
         =                       <span style="color: #a0522d;">sunit</span>=0      <span style="color: #a0522d;">swidth</span>=0 blks
<span style="color: #a0522d;">naming</span>   =version 2              <span style="color: #a0522d;">bsize</span>=4096   ascii-ci=0 <span style="color: #a0522d;">ftype</span>=1
<span style="color: #a0522d;">log</span>      =internal               <span style="color: #a0522d;">bsize</span>=4096   <span style="color: #a0522d;">blocks</span>=25599, <span style="color: #a0522d;">version</span>=2
         =                       <span style="color: #a0522d;">sectsz</span>=512   <span style="color: #a0522d;">sunit</span>=0 blks, lazy-count=1
<span style="color: #a0522d;">realtime</span> =none                   <span style="color: #a0522d;">extsz</span>=4096   <span style="color: #a0522d;">blocks</span>=0, <span style="color: #a0522d;">rtextents</span>=0
</pre>
</div>

<p>
<b>超级块和INODE TABLE</b>
</p>


<figure id="org2b9e292">
<img src="images/image-20210216020912193.png" alt="image-20210216020912193.png" width="60%">

</figure>

<p>
<b>块组描述符表(GDT)</b>
</p>

<p>
ext文件系统每一个块组信息使用32字节描述，这32个字节称为块组描述符，所
有块组的块组描述符组成块组描述符表GDT(group descriptor table)。虽然每
个块组都需要块组描述符来记录块组的信息和属性元数据，但是不是每个块组中
都存放了块组描述符。将所有块组的块组信息组成一个GDT保存,并将该GDT存放
于某些块组中，类似存放superblock和备份superblock的块
</p>
</div>
</div>
<div id="outline-container-h:88f74429-ec9a-4d55-845b-749c4862fc93" class="outline-5">
<h5 id="h:88f74429-ec9a-4d55-845b-749c4862fc93">文件系统检测和修复</h5>
<div class="outline-text-5" id="text-h:88f74429-ec9a-4d55-845b-749c4862fc93">
<p>
文件系统夹故障常发生于死机或者非正常关机之后，挂载为文件系统标记为”no clean”
</p>

<p>
<b>注意：一定不要在挂载状态下执行下面命令修复</b>
</p>

<p>
fsck: File System Check
</p>

<div class="org-src-container">
<pre class="src src-sh">fsck.FS_TYPE
fsck -t FS_TYPE
</pre>
</div>

<p>
注意：FS_TYPE 一定要与分区上已经文件类型相同
</p>

<p>
常用选项：
</p>
<div class="org-src-container">
<pre class="src src-sh">-a &#33258;&#21160;&#20462;&#22797; ;&#19981;&#24314;&#35758;&#29992;&#65307;&#20250;&#23558;&#30862;&#29255;&#25991;&#20214;&#21024;&#38500;
-r &#20132;&#20114;&#24335;&#20462;&#22797;&#38169;&#35823;
-f : &#24378;&#21046;&#26816;&#27979;
</pre>
</div>

<p>
e2fsck：ext系列文件专用的检测修复工具
</p>

<div class="org-src-container">
<pre class="src src-sh">-y &#33258;&#21160;&#22238;&#31572;&#20026;yes
-f &#24378;&#21046;&#20462;&#22797;
-p &#33258;&#21160;&#36827;&#34892;&#23433;&#20840;&#30340;&#20462;&#22797;&#25991;&#20214;&#31995;&#32479;&#38382;&#39064;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">&#22914;&#65292;&#24378;&#21046;&#26816;&#27979;&#25991;&#20214;&#31995;&#32479;
[root@node01 ~]# e2fsck -f /dev/sdb5
e2fsck 1.42.9 (28-Dec-2013)
Pass 1: Checking inodes, blocks, and sizes  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#26597; inode, &#22359;&#21644;&#22823;&#23567;</span>
Pass 2: Checking directory structure            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#26597;&#30446;&#24405;&#32467;&#26500;</span>
Pass 3: Checking directory connectivity       <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#26597;&#30446;&#24405;&#36830;&#25509;&#24615;</span>
Pass 4: Checking reference counts                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#26597;&#24341;&#29992;&#35745;&#25968;</span>
Pass 5: Checking group summary information  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#26597;&#31751;&#27010;&#35201;&#20449;&#24687;</span>
/dev/sdb5: 11/131072 files (0.0% non-contiguous), 9004/524288 blocks
</pre>
</div>

<p>
xfs_repair：xfs文件系统专用检测修复工具 常用选项：
</p>

<div class="org-src-container">
<pre class="src src-sh">-f &#20462;&#22797;&#25991;&#20214;&#65292;&#32780;&#35774;&#22791;
-n &#21482;&#26816;&#26597;
-d &#20801;&#35768;&#20462;&#22797;&#21482;&#35835;&#30340;&#25346;&#36733;&#35774;&#22791;&#65292;&#22312;&#21333;&#29992;&#25143;&#19979;&#65288; init 1&#65289;&#20462;&#22797; / &#26102;&#20351;&#29992;&#65292;&#28982;&#21518;&#31435;&#21363;reboot
&#27880;&#24847;&#65306;xfs_repair &#21487;&#20197;&#26816;&#26597;/&#20462;&#22797;&#25991;&#20214;&#31995;&#32479;&#65292;&#19981;&#36807;&#65292;&#22240;&#20026;&#20462;&#22797;&#25991;&#20214;&#31995;&#32479;&#26159;&#20010;&#24456;&#24222;&#22823;&#30340;&#20219;&#21153;&#65281;&#22240;&#27492;&#65292;&#20462;&#22797;&#26102;&#35813;&#25991;&#20214;&#31995;&#32479;&#19981;&#33021;&#34987;&#25346;&#36733;&#65281;
</pre>
</div>

<p>
范例：修改破坏的ext文件系统
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mount /dev/sdb2 /mnt
[root@centos8 ~]#cp /etc/fstab /mnt/f1
[root@centos8 ~]#cp /etc/fstab /mnt/f2
[root@centos8 ~]#ls /mnt
f1 f2 lost+found

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#30772;&#22351;ext&#25991;&#20214;&#31995;&#32479;, &#30772;&#22351;&#20803;&#25968;&#25454;</span>
[root@centos8 ~]#dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=/dev/sdb2 <span style="color: #a0522d;">bs</span>=1M <span style="color: #a0522d;">count</span>=1
[root@centos8 ~]#ls /mnt
[root@centos8 ~]#tune2fs -l /dev/sdb2
tune2fs 1.44.6 (5-Mar-2019)
tune2fs: Bad magic number<span style="color: #a020f0;"> in</span> super-block while trying to open /dev/sdb2
[root@centos8 ~]#df  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22823;&#23567;&#19981;&#27491;&#24120;&#20102;</span>
Filesystem        1K-blocks         Used Available Use% Mounted on
/dev/sdb2    73786976294838107984 73786976294836115464  1976136 100% /mnt

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#22797;</span>
[root@centos8 ~]#umount /mnt
[root@centos8 ~]#e2fsck /dev/sdb2 -y  <span style="color: #b22222;"># </span><span style="color: #b22222;">fsck /dev/sdb2 -y &#20462;&#22797;&#25991;&#20214;&#31995;&#32479;&#30340;&#20803;&#25968;&#25454;&#65292;&#36229;&#32423;&#22359;&#12290; &#33021;&#19981;&#33021;&#25214;&#22238;&#25968;&#25454;&#23601;&#30475;&#36816;&#27668;&#20102;</span>
e2fsck 1.44.6 (5-Mar-2019)
test was not cleanly unmounted, check forced.
Pass 1: Checking inodes, blocks, and sizes
Pass 2: Checking directory structure
Pass 3: Checking directory connectivity
Pass 4: Checking reference counts
Pass 5: Checking group summary information
Free blocks count wrong for group <span style="color: #b22222;">#</span><span style="color: #b22222;">0 (24280, counted=24281).</span>
Fix? yes
Free blocks count wrong for group <span style="color: #b22222;">#</span><span style="color: #b22222;">1 (32511, counted=32509).</span>
Fix? yes
Free blocks count wrong (498131, <span style="color: #a0522d;">counted</span>=498130).
Fix? yes
Free inodes count wrong for group <span style="color: #b22222;">#</span><span style="color: #b22222;">0 (8181, counted=8179).</span>
Fix? yes
Free inodes count wrong (131061, <span style="color: #a0522d;">counted</span>=131059).
Fix? yes
Padding at end of inode bitmap is not set. Fix? yes
test: ***** FILE SYSTEM WAS MODIFIED *****
test: 13/131072 files (0.0% non-contiguous), 26158/524288 blocks

[root@centos8 ~]#tune2fs -l /dev/sdb2
tune2fs 1.44.6 (5-Mar-2019)
Filesystem volume name:  test
Last mounted on:     &lt;not available&gt;
... ...
[root@centos8 ~]#mount /dev/sdb2 /mnt
[root@centos8 ~]#ls /mnt
f1 f2 lost+found
[root@centos8 ~]#cat /mnt/f1
... ...
[root@centos8 ~]#
</pre>
</div>
</div>
</div>
<div id="outline-container-h:57ed1dd5-4d08-4513-9d77-0af1ec131ea9" class="outline-5">
<h5 id="h:57ed1dd5-4d08-4513-9d77-0af1ec131ea9">文件系统中文件恢复</h5>
<div class="outline-text-5" id="text-h:57ed1dd5-4d08-4513-9d77-0af1ec131ea9">
<p>
<b>1.基于正在打开文件的删除恢复</b>
</p>

<p>
程序要把文件内容加载到内存中才能被读取。换句话说，被进程打开的文件在内存是有一个副本的。
</p>

<p>
演示：删除恢复
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1. /var/log/auth.log&#26159;&#34987;rsyslog&#36827;&#31243;&#25171;&#24320;&#30340;&#65292;&#25105;&#20204;&#22791;&#20221;&#24182;&#21024;&#38500;&#23427;</span>
root@u-18:~# cp /var/log/auth.log /root
root@u-18:~# rm -f /var/log/auth.log

<span style="color: #b22222;"># </span><span style="color: #b22222;">2. lsof    &#21015;&#34920;&#20986;&#25152;&#26377;&#34987;&#36827;&#31243;&#35835;&#21462;&#30340;&#25991;&#20214;&#65292;&#33021;&#30475;&#21040;&#25991;&#20214;&#24050;&#32463;&#34987;&#21024;&#38500;&#65292;&#20294;&#20869;&#23481;&#36824;&#22312;&#20869;&#23384;&#20013;&#29992;&#21040;&#12290;</span>
root@u-18:~# lsof |grep /var/log/auth.log
rsyslogd                694                                                                    syslog                8w                        REG                                                                8,1            138318                1704473 /var/log/auth.log (deleted)

<span style="color: #b22222;"># </span><span style="color: #b22222;">3.    &#21040;&#23545;&#24212;&#36827;&#31243;&#20013;&#25214;&#21040;&#35813;&#25991;&#20214;</span>
root@u-18:~# cd /proc/694/fd

root@u-18:/proc/694/fd# ll
l-wx------ 1 root            root            64 5&#26376;            9 00:39 8 -&gt; <span style="color: #8b2252;">'/var/log/auth.log (deleted)'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">4. 8&#36824;&#22312;&#20869;&#23384;&#20013;&#65292;&#25152;&#20197;&#33021;&#35835;&#21462;&#21040;&#65292;&#25105;&#20204;&#24674;&#22797;&#30475;&#30475;</span>
root@u-18:/proc/694/fd# cat 8 &gt; /var/log/auth.log
root@u-18:/proc/694/fd# diff /var/log/auth.log /root/auth.log
</pre>
</div>

<p>
<b>2.人工误删除，没被进程打开的文件恢复</b>
</p>

<p>
2.1 使用extundelete工具
</p>

<p>
常见的开源数据恢复工具有，debugfs、R-Linux、ext3grep、extundelete 等。
ext3grep 跟 extundelete 比较常用，其中 ext3grep 只支持 ext3文件系统，
extundelete 支持 ext3/ext4。
</p>

<p>
都是通过分析文件系统日志，解析出所有文件的 inode 信息，利用 inode去查
找所在 block ,利用 dd 备份出以删除的数据
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1. &#23433;&#35013;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">1). epel &#20179;&#24211;&#23433;&#35013;</span>
yum install epel-release 
yum install extundelete -y
<span style="color: #b22222;"># </span><span style="color: #b22222;">ubuntu&#31995;&#32479;&#23433;&#35013;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">root@u-18:/proc/694/fd# apt install extundelete</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2). &#28304;&#30721;&#32534;&#35793;&#23433;&#35013;</span>
http://jaist.dl.sourceforge.net/project/extundelete/extundelete/0.2.4/extundelete-0.2.4.tar.bz2
yum -y install e2fsprogs-devel
tar jxf extundelete-0.2.4.tar.bz2
<span style="color: #483d8b;">cd</span> extundelete-0.2.4
./configure &amp;&amp; make &amp;&amp; make install

<span style="color: #b22222;"># </span><span style="color: #b22222;">2. &#21024;&#38500;&#19968;&#20010;&#25991;&#20214;</span>
root@u-18:/proc/694/fd# df -hPT
/dev/sda1                        ext4                            69G            14G            52G        21% /
root@u-18:/proc/694/fd# mkdir /data/app -pv
root@u-18:/proc/694/fd# cd /data/app
root@u-18:/data/app# cp /etc/fstab ./
root@u-18:/data/app# cp /var/log/auth.log ./
root@u-18:/data/app# rm -f fstab auth.log

<span style="color: #b22222;"># </span><span style="color: #b22222;">3. &#24674;&#22797;&#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">1) &#31435;&#21363;&#20445;&#35777;&#20998;&#21306;&#26159;&#21482;&#35835;&#30340;&#65292;&#25110;&#32773;&#21368;&#36733;&#20998;&#21306;</span>
root@u-18:/data/app# mount -f -o remount,ro /dev/sda1

<span style="color: #b22222;">#</span><span style="color: #b22222;">2)&#26597;&#30475;&#21024;&#38500;&#30340;&#25991;&#20214;</span>
root@u-18:/data/app# extundelete /dev/sda1 --inode 2

<span style="color: #b22222;">#</span><span style="color: #b22222;">3) &#20999;&#25442;&#21040;&#20854;&#23427;&#20998;&#21306;&#65292;&#25191;&#34892;&#24674;&#22797;</span>
root@u-18:/data/app# cd    
root@u-18:/root# extundelete /dev/sda1 --restore-all     <span style="color: #b22222;">#    </span><span style="color: #b22222;">&#24674;&#22797;&#20840;&#37096;</span>

&#25991;&#20214;&#22312;RECOVERED_FIELES&#65292;&#36827;&#20837;&#21040;&#30446;&#24405;&#19979;cp&#35201;&#24674;&#22797;&#30340;&#25991;&#20214;&#21363;&#21487;&#12290;

<span style="color: #b22222;"># </span><span style="color: #b22222;">4) &#20998;&#21306;&#21464;&#20026;&#35835;&#20889;</span>
root@u-18:/data/app# mount -f -o remount,rw /dev/sda1
</pre>
</div>

<p>
2.2.1 参数选项
</p>

<div class="org-src-container">
<pre class="src src-sh">--after dtime  &#26102;&#38388;&#21442;&#25968;&#65292;&#34920;&#31034;&#22312;&#26576;&#27573;&#26102;&#38388;&#20043;&#21518;&#34987;&#21024;&#38500;&#30340;&#25991;&#20214;&#25110;&#30446;&#24405;
--before dtime  &#26102;&#38388;&#21442;&#25968;&#65292;&#34920;&#31034;&#22312;&#26576;&#27573;&#26102;&#38388;&#20043;&#21069;&#34987;&#21024;&#38500;&#30340;&#25991;&#20214;&#25110;&#30446;&#24405;

&#24120;&#29992;&#21160;&#20316;
--inode ino  &#26174;&#31034;&#33410;&#28857; ino &#30340;&#20449;&#24687;
--block blk  &#26174;&#31034;&#25968;&#25454;&#22359; blk &#30340;&#20449;&#24687;

--restore-inode ino  &#34920;&#31034;&#24674;&#22797;&#33410;&#28857; ino &#30340;&#25991;&#20214;&#65292;&#29992;&#26469;&#24674;&#22797;&#21333;&#20010;&#25991;&#20214;
--restore-file path  &#34920;&#31034;&#24674;&#22797;&#25351;&#23450;&#36335;&#24452;&#19979;&#30340;&#25991;&#20214;&#65292;&#29992;&#26469;&#24674;&#22797;&#30446;&#24405;&#19979;&#25152;&#26377;&#25991;&#20214;
--restore-all  &#34920;&#31034;&#24674;&#22797;&#25152;&#26377;&#34987;&#21024;&#38500;&#30340;&#30446;&#24405;&#36319;&#25991;&#20214;
</pre>
</div>

<p>
CentOS7使用Extundelete恢复误删除的文件
</p>

<p>
常见的开源数据恢复工具有，debugfs、R-Linux、ext3grep、extundelete 等。
ext3grep 跟 extundelete 比较常用，其中 ext3grep 只支持 ext3
文件系统，extundelete 支持 ext3/ext4。
</p>

<p>
都是通过分析文件系统日志，解析出所有文件的 inode 信息，利用 inode
去查找所在 block ,利用 dd 备份出以删除的数据。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1. &#26597;&#25214;&#34987;&#21024;&#38500;&#30340;&#25991;&#20214;</span>
shell &gt; ls -id /usr/local/src
130619 /usr/local/src
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#39318;&#20808;&#26597;&#30475;&#34987;&#21024;&#38500;&#30340;&#19978;&#23618;&#30446;&#24405; inode</span>

shell &gt; extundelete /dev/mapper/vg_study-LogVol00 --inode 130619
...
File name | Inode number | Deleted status
.                 130619
..                130587
package           137256   Deleted
apr-1.5.1         140038
apr-util-1.5.4    535002
httpd-2.4.10      535320
pcre-8.30         656184
siege-3.0.8       656483
libmcrypt-2.5.8   144383
package.xml       146709
mysql-5.6.4-m7    140588
memcache-2.2.7    146712
php-5.4.13        667097
redis-2.2.5       269016
memcached-1.4.15  146806
libevent-master   539531   Deleted
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#21040;&#34987;&#21024;&#38500;&#30340;&#30446;&#24405; package &#29366;&#24577;&#20026; Deleted &#65292;inode &#20026; 137256</span>

shell &gt; extundelete /dev/mapper/vg_study-LogVol00 --inode 137256
...
File name | Inode number | Deleted status
.                 137256
..                130573
e2p.h;54b8ac2f    137260        Deleted
e2p.h             137260
mysql-5.6.4-m7.tar.gz   140630  Deleted
httpd-2.4.10.tar.gz     140035  Deleted
pcre-8.30.tar.gz        140036  Deleted
siege-3.0.8.tar.gz      140037  Deleted
libmcrypt-2.5.8.tar.bz2 144382  Deleted
php-5.4.13.tar.bz2      144439  Deleted
memcache-2.2.7.tgz      144381  Deleted
redis-2.2.5.tgz         146713  Deleted
libevent-master         539531  Deleted
memcached-1.4.15.tar.gz 144377  Deleted
libevent-master.zip     146863  Deleted

<span style="color: #b22222;">## </span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#21040;&#34987;&#21024;&#38500;&#30340;&#30446;&#24405;&#24213;&#19979;&#26377;&#21738;&#20123;&#34987;&#21024;&#38500;&#30340;&#25991;&#20214;&#21450; inode &#21495;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">2. &#24674;&#22797;&#25968;&#25454;</span>

shell &gt; extundelete /dev/mapper/vg_study-LogVol00 --restore-directory /usr/local/src/package
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#25351;&#23450;&#21024;&#38500;&#30446;&#24405;&#25152;&#22312;&#20998;&#21306;&#65292;--restore-directory &#20026;&#24674;&#22797;&#25972;&#20010;&#30446;&#24405;&#65292;&#21518;&#38754;&#26159;&#35201;&#24674;&#22797;&#30340;&#30446;&#24405;</span>
Would you like to continue? (y/n)
y
Loading filesystem metadata ... 151 groups loaded.
Loading journal descriptors ... 22517 descriptors loaded.
Searching for recoverable inodes<span style="color: #a020f0;"> in</span> directory /usr/local/src/package ...
1679 recoverable inodes found.
Looking through the directory structure for deleted files ...
Block 578312 is allocated.
Unable to restore inode 146713 (usr/local/src/package/redis-2.2.5.tgz): Space has been reallocated.
Unable to restore inode 539531 (usr/local/src/package/libevent-master): Space has been reallocated.
1670 recoverable inodes still lost.
&#22797;&#21046;&#20195;&#30721;
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#20854;&#20013;&#65292;redis-2.2.4.tgz &#21644; libevent-master &#27809;&#26377;&#34987;&#24674;&#22797;&#65292;&#22240;&#20026; inode &#34987;&#37325;&#26032;&#20998;&#37197;&#20986;&#21435;&#20102;...</span>

shell &gt; cd RECOVERED_FILES/usr/local/src/package
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#24674;&#22797;&#23436;&#25104;&#21518;&#20250;&#22312;&#24403;&#21069;&#30446;&#24405;&#19979;&#29983;&#25104;&#19968;&#20010; RECOVERED_FILES &#30446;&#24405;</span>

shell &gt; ls
e2p.h;54b8ac2f libmcrypt-2.5.8.tar.bz2 memcached-1.4.15.tar.gz php-5.4.13.tar.bz2
libevent-master.zip memcache-2.2.7.tgz mysql-5.6.4-m7.tar.gz
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#21482;&#24674;&#22797;&#20102; 7 &#20010;&#25991;&#20214;&#65292;&#21024;&#38500;&#30340;&#26377; 12 &#20010;... &#20351;&#29992; find &#26597;&#19968;&#19979;&#27809;&#26377;&#24674;&#22797;&#30340;&#25991;&#20214;&#30340; inode &#21495;</span>

shell &gt; find / -inum 140035
/usr/lib64/libe2p.so
shell &gt; find / -inum 140036
/usr/lib64/libext2fs.a
shell &gt; find / -inum 140037
/usr/lib64/libext2fs.so
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#21457;&#29616; httpd &#12289;pcre &#12289;siege &#30340;&#37117;&#34987;&#20998;&#37197;&#20986;&#21435;&#20102;...&#65292;&#29616;&#22312;&#24674;&#22797;&#19981;&#20986;&#26469;&#30340;&#23601;&#27704;&#36828;&#27809;&#26377;&#20102;..</span>

<span style="color: #b22222;">## </span><span style="color: #b22222;">&#25152;&#20197;&#65292;&#21315;&#19975;&#35760;&#20303;&#65306;&#19975;&#19968;&#35823;&#21024;&#38500;&#25968;&#25454;&#20102;&#65292;&#19968;&#23450;&#35201;&#31532;&#19968;&#26102;&#38388;&#23558;&#25968;&#25454;&#25152;&#22312;&#30913;&#30424;&#21368;&#36733;&#25110;&#25346;&#36733;&#20026;&#21482;&#35835;&#20998;&#21306;&#65292;&#38450;&#27490;&#20889;&#20837;&#25991;&#20214; inode &#34987;&#37325;&#26032;&#20998;&#37197;&#12290;</span>
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#22914;&#26524;&#35823;&#21024;&#30340;&#26159;&#26681;&#20998;&#21306;&#30340;&#25968;&#25454;&#65292;&#37027;&#20040;&#31435;&#21363;&#36827;&#21435;&#21333;&#29992;&#25143;&#27169;&#24335;&#65292;&#23558;&#26681;&#20998;&#21306;&#21482;&#35835;&#25346;&#36733;&#12290;</span>
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#21448;&#24341;&#30003;&#20986;&#19968;&#20010;&#38382;&#39064;&#65292;&#20570;&#31995;&#32479;&#20998;&#21306;&#30340;&#26102;&#20505;&#65292;&#26368;&#22909;&#19981;&#35201;&#21482;&#20998;&#19968;&#20010;&#26681;&#20998;&#21306;&#65292;&#20687;&#36825;&#26679;&#30340;&#24773;&#20917;&#24456;&#38590;&#21150;...</span>
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#31532;&#20108;&#65292;&#25968;&#25454;&#24674;&#22797;&#36719;&#20214;&#20107;&#20808;&#35013;&#22909;&#21543;..</span>
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#31532;&#19977;&#65292;&#21024;&#38500;&#25968;&#25454;&#26102;&#65292;&#20808;&#23558;&#35201;&#21024;&#38500;&#30340;&#25968;&#25454;&#31227;&#21160;&#21040; /tmp&#65288;&#21333;&#29420;&#20998;&#21306;&#65289;&#65292;&#28982;&#21518;&#21024;&#38500;&#25110;&#33050;&#26412;&#23450;&#26399;&#21024;&#38500;</span>
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#31532;&#22235;&#65292;&#20570;&#22909;&#25968;&#25454;&#22791;&#20221;&#12290;</span>
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#26368;&#21518;&#65292;&#25970;&#24930;&#28857; &#65281;&#65281;&#65281;</span>
</pre>
</div>

<p>
2.2 linux自带工具debugfs恢复误删文件方法 不支持xfs文件格式的恢复
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1.&#22312; /example/&#30446;&#24405;&#20013;&#65292;&#21019;&#24314;&#19968;&#20010;&#25991;&#20214;&#20889;&#20837;&#20869;&#23481;&#24182;&#21024;&#38500;</span>
$ cd /example
$ echo 22 &gt;1.c
$ rm 1.c

<span style="color: #b22222;"># </span><span style="color: #b22222;">2.&#26597;&#30475;&#25991;&#20214;&#25152;&#22312;&#20998;&#21306;</span>
$ df ./
Filesystem     1K-blocks     Used Available Use% Mounted on
/dev/sda1       41020640 23113464  15793744  60% /

<span style="color: #b22222;"># </span><span style="color: #b22222;">3.&#21551;&#21160;debugfs&#24037;&#20855;</span>
$ sudo debugfs
debugfs:  open /dev/sda1
debugfs:  ls -d /example/
ls -d&#20250;&#21015;&#20986;&#27492;&#30446;&#24405;&#26368;&#36817;&#30340;&#25805;&#20316;&#65292;&#20854;&#20013;&#21487;&#20197;&#30475;&#21040;&lt;num&gt;&#30340;&#26085;&#24535;&#21024;&#38500;&#35760;&#24405;
&lt;1590178&gt; (4044) 1.c   
&#35760;&#24405;&#19979;&#23574;&#25324;&#21495;&#20869;&#30340;&#25968;&#20540;&#65292;&#25353;q&#22238;&#21040;debugfs&#12290;
&#22914;&#26524;&#32467;&#26524;&#22826;&#22810;&#65292;&#21487;&#20197;&#30452;&#25509;&#25191;&#34892;&#22914;&#19979;&#21629;&#20196;&#65306; echo lsdel | debugfs /dev/sda1 &gt; lsdel.out &#22914;&#27492;&#21487;&#23558;&#32467;&#26524;&#36755;&#20986;&#25104;&#26412;&#22320;&#25991;&#20214;

<span style="color: #b22222;"># </span><span style="color: #b22222;">4 &#25191;&#34892;logdump -i &lt;num&gt; &#26174;&#31034;&#27492;&#26085;&#24535;&#20869;&#23481;,&#24182;&#20351;&#29992;quit&#36864;&#20986;debugfs&#22914;&#19979;</span>
debugfs:  logdump -i &lt;1590178&gt;
Inode 1590178 is at group 194, block 6292541, offset 128
Journal starts at block 33979, transaction 115345
No magic number at block 36187: end of journal.
debugfs:  quit
&#25110;&#32773;
&#22312;debugfs&#27169;&#24335;&#19979;&#65292;&#25191;&#34892; dump &lt;123456&gt; /tmp/123456.bak&#65292;&#21487;&#23558;&#34987;&#21024;&#38500;&#30340;&#25991;&#20214;&#24674;&#22797;&#65292;&#20854;&#20013;123456&#20026;&#34987;&#21024;&#38500;&#25991;&#20214;&#30340;inode&#21495;&#12290;

<span style="color: #b22222;">#</span><span style="color: #b22222;">4.&#24674;&#22797;&#25991;&#20214;</span>
$ sudo dd <span style="color: #a0522d;">if</span>=/dev/sda1 <span style="color: #a0522d;">of</span>=/tmp/example/1.c <span style="color: #a0522d;">bs</span>=128 <span style="color: #a0522d;">count</span>=1 <span style="color: #a0522d;">skip</span>=629541
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:fe5371ea-92e7-411e-b933-a5e2531a44f9" class="outline-3">
<h3 id="h:fe5371ea-92e7-411e-b933-a5e2531a44f9">挂载</h3>
<div class="outline-text-3" id="text-h:fe5371ea-92e7-411e-b933-a5e2531a44f9">
<p>
挂载:将额外文件系统与根文件系统某现存的目录建立起关联关系，进而使得此
目录做为其它文件访问入口的行为
</p>

<p>
卸载:为解除此关联关系的过程
</p>

<p>
把设备关联挂载点：mount Point
</p>

<p>
挂载点下原有文件在挂载完成后会被临时隐藏，因此，挂载点目录一般为空
</p>

<p>
进程正在使用中的设备无法被卸载
</p>
</div>
<div id="outline-container-h:9300dc8a-8557-4bcb-924e-9a9886cacf5f" class="outline-4">
<h4 id="h:9300dc8a-8557-4bcb-924e-9a9886cacf5f">挂载文件系统mount</h4>
<div class="outline-text-4" id="text-h:9300dc8a-8557-4bcb-924e-9a9886cacf5f">
<p>
格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">mount [-fnrsvw] [-t vfstype] [-o options] device mountpoint
</pre>
</div>

<p>
<b>device：指明要挂载的设备</b>
</p>

<ul class="org-ul">
<li>设备文件：例如:/dev/sda5</li>
<li>卷标：-L 'LABEL', 例如 -L 'MYDATA'</li>
<li>UUID： -U 'UUID'：例如 -U '0c50523c-43f1-45e7-85c0-a126711d406e'</li>
<li>伪文件系统名称：proc, sysfs, devtmpfs, configfs</li>
</ul>

<p>
<b>mountpoint：挂载点目录必须事先存在，建议使用空目录</b>
</p>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-shell">blkid
mount <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"xxxxx"</span> /data/tmp
</pre>
</div>

<p>
<b>mount常用命令选项</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">&#19981;&#24102;&#20219;&#20309;&#36873;&#39033;&#30340;&#21629;&#20196;&#26174;&#31034;&#24403;&#21069;&#24050;&#25346;&#36733;&#30340;&#25152;&#26377;&#25991;&#20214;&#31995;&#32479;
-t vsftype &#25351;&#23450;&#35201;&#25346;&#36733;&#30340;&#35774;&#22791;&#19978;&#30340;&#25991;&#20214;&#31995;&#32479;&#31867;&#22411;; &#22810;&#25968;&#24773;&#20917;&#19979;&#21487;&#20197;&#30465;&#30053;&#65292;&#27492;&#26102;mount&#20250;&#36890;&#36807; blkid &#21629;&#20196;&#26469;&#21028;&#26029;&#35201;&#25346;&#36733;&#30340;&#35774;&#22791;&#25991;&#20214;&#31867;&#22411;&#65307;
-r readonly&#65292;&#21482;&#35835;&#25346;&#36733;&#65307;&#20809;&#39537;&#21482;&#33021;&#21482;&#35835;&#25346;&#36733;
-w read and write, &#35835;&#20889;&#25346;&#36733;
-n &#19981;&#26356;&#26032;/etc/mtab&#65292;mount&#19981;&#21487;&#35265;
-a &#33258;&#21160;&#25346;&#36733;&#25152;&#26377;&#25903;&#25345;&#33258;&#21160;&#25346;&#36733;&#30340;&#35774;&#22791;(&#23450;&#20041;&#22312;&#20102;/etc/fstab&#25991;&#20214;&#20013;&#65292;&#19988;&#25346;&#36733;&#36873;&#39033;&#20013;&#26377;auto&#21151;&#33021;)
-L <span style="color: #8b2252;">'LABEL'</span> &#20197;&#21367;&#26631;&#25351;&#23450;&#25346;&#36733;&#35774;&#22791;
-U <span style="color: #8b2252;">'UUID'</span> &#20197;UUID&#25351;&#23450;&#35201;&#25346;&#36733;&#30340;&#35774;&#22791;
-B, --bind &#32465;&#23450;&#30446;&#24405;&#21040;&#21478;&#19968;&#20010;&#30446;&#24405;&#19978;; &#20316;&#20026;&#20854;&#20020;&#26102;&#35775;&#38382;&#20837;&#21475;

-o options&#65306;(&#25346;&#36733;&#25991;&#20214;&#31995;&#32479;&#30340;&#36873;&#39033;)&#65292;&#22810;&#20010;&#36873;&#39033;&#20351;&#29992;&#36887;&#21495;&#20998;&#38548;
    async                              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24322;&#27493;&#27169;&#24335;,&#20869;&#23384;&#26356;&#25913;&#26102;,&#20889;&#20837;&#32531;&#23384;&#21306;buffer,&#36807;&#19968;&#27573;&#26102;&#38388;&#20877;&#20889;&#21040;&#30913;&#30424;&#20013;&#65292;&#25928;&#29575;&#39640;&#65292;&#20294;&#19981;&#23433;&#20840;</span>
    sync                                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#27493;&#27169;&#24335;,&#20869;&#23384;&#26356;&#25913;&#26102;&#65292;&#21516;&#26102;&#20889;&#30913;&#30424;&#65292;&#23433;&#20840;&#65292;&#20294;&#25928;&#29575;&#20302;&#19979;</span>
    atime/noatime               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21253;&#21547;&#30446;&#24405;&#21644;&#25991;&#20214;&#35835;&#26102;&#38388;&#65292;&#25991;&#20214;&#30340;&#35835;&#26102;&#38388;&#19968;&#33324;&#24847;&#20041;&#19981;&#22823;&#21487;&#20197;&#21435;&#25481;noatime&#65292;&#20943;&#23569;&#30913;&#30424;IO&#35835;&#20889;&#12290;</span>
    diratime/nodiratime     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#24405;&#30340;&#35775;&#38382;&#26102;&#38388;&#25139;</span>
    auto/noauto                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#25903;&#25345;&#24320;&#26426;&#33258;&#21160;&#25346;&#36733;&#65292;&#26159;&#21542;&#25903;&#25345;-a&#36873;&#39033;</span>
    exec/noexec                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#25903;&#25345;&#23558;&#25991;&#20214;&#31995;&#32479;&#19978;&#36816;&#34892;&#24212;&#29992;&#31243;&#24207;</span>
    dev/nodev                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#25903;&#25345;&#22312;&#27492;&#25991;&#20214;&#31995;&#32479;&#19978;&#20351;&#29992;&#35774;&#22791;&#25991;&#20214;</span>
    suid/nosuid                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#25903;&#25345;suid&#21644;sgid&#26435;&#38480;</span>
    remount                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#26032;&#25346;&#36733;</span>
    ro/rw                             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#35835;&#12289;&#35835;&#20889; </span>
    user/nouser                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#20801;&#35768;&#26222;&#36890;&#29992;&#25143;&#25346;&#36733;&#27492;&#35774;&#22791;&#65292;/etc/fstab&#20351;&#29992;</span>
    acl/noacl                       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#27492;&#25991;&#20214;&#31995;&#32479;&#19978;&#30340;acl&#21151;&#33021;</span>
    loop                              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;loop&#35774;&#22791;&#65292;&#24517;&#38656;&#26377;&#25991;&#20214;&#31995;&#32479;&#30340;&#25991;&#20214;</span>
    _netdev                         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#32593;&#32476;&#21487;&#29992;&#26102;&#25165;&#23545;&#32593;&#32476;&#36164;&#28304;&#36827;&#34892;&#25346;&#36733;&#65292;&#22914;&#65306;NFS&#25991;&#20214;&#31995;&#32479;</span>
    defaults                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#24403;&#20110;rw, suid, dev, exec, auto, nouser, async</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36879;&#26126;&#21387;&#32553;&#26426;&#21046;&#65306;&#20256;&#30340;&#25968;&#25454;&#20250;&#34987;&#21387;&#32553;&#20043;&#21518;&#23384;&#25918;</span>
&#21629;&#20196;&#65306;mount -o <span style="color: #a0522d;">compress</span>={lzo|zlib} DEVICE MOUNT_POINT
</pre>
</div>

<blockquote>
<p>
同步异步：进程每一次所访问的数据默认都应该在磁盘上的，但是进程是不可能
操作磁盘上的数据，它需要把数据先装入到内存中，在内存中执行读写操作，尤
其是写操作。
</p>

<p>
如何写呢？ 先在内存中写完，过一会再同步到磁盘上，这叫异步。
如果在内存中一写立即同步到磁盘上，这叫同步。
</p>

<p>
想一下，内存是比磁盘快得多，异步性能更好。
</p>
</blockquote>

<p>
<b>挂载规则:</b>
</p>

<ul class="org-ul">
<li>一个挂载点同一时间只能挂载一个设备</li>
<li>一个挂载点同一时间挂载了多个设备，只能看到最后一个设备的数据，其它设
备上的数据将被隐藏</li>
<li>一个设备可以同时挂载到多个挂载点</li>
<li>通常挂载点一般是已存在空的目录</li>
</ul>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1. &#32465;&#23450;&#30446;&#24405;; &#36890;&#36807; /mnt &#30446;&#24405;&#26469;&#35775;&#38382; /etc &#30446;&#24405;</span>
[root@node01 mnt]# mount --bind /etc/ /mnt

<span style="color: #b22222;"># </span><span style="color: #b22222;">2 &#25346;&#36733;&#35774;&#22791;</span>
[root@node01 ~]# mount /dev/sdb5 /mnt/ 

<span style="color: #b22222;"># </span><span style="color: #b22222;">3 &#21482;&#35835;&#25346;&#36733;</span>
[root@node01 ~]# mount -r /dev/sdb5 /media

<span style="color: #b22222;"># </span><span style="color: #b22222;">4 -o options &#25351;&#26126;&#25346;&#36733;&#26102;&#31995;&#32479;&#21551;&#29992;&#30340;&#29305;&#24615;</span>
acl&#65306;&#25903;&#25345;&#20351;&#29992;fac &#25991;&#20214;&#35775;&#38382;&#25511;&#20214;&#21015;&#34920; &#21151;&#33021;&#65307;&#26377; 2 &#31181;&#26041;&#24335;&#23454;&#29616;
1&#12289;# mount -o acl device dir
2&#12289;# tune2fs -o acl device   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;&#21518;&#65292;mount &#21629;&#20196;&#19981;&#20250;&#26174;&#31034;&#26377; acl &#65292;&#20294;&#20854;&#23454;&#26377; acl &#21151;&#33021;&#12290;</span>
&#21333;&#29992;&#25143;&#27169;&#24335;&#19979;&#20197;rw&#26041;&#24335;&#37325;&#26032;&#25346;&#36733; /
mount -o remount,rw /

<span style="color: #b22222;"># </span><span style="color: #b22222;">5 &#25346;&#36733;&#20809;&#30424;&#65306;</span>
mount -r /dev/cdrom &#25346;&#36733;&#28857;
&#20809;&#30424;&#35774;&#22791;&#25991;&#20214;&#65306;/dev/cdrom,/dev/dvd
[root@node01 mnt]# ls -l /dev/cdr*
lrwxrwxrwx 1 root root 3 Jan 18 23:24 /dev/cdrom -&gt; sr0  <span style="color: #b22222;"># </span><span style="color: #b22222;">sr0 &#20854;&#23454;&#26159; SATA &#25509;&#21475;&#30340;&#20809;&#39537;&#35774;&#22791; &#12290; sr0 &#21487;&#33021;&#26159; hdc&#65292;&#34987;&#34394;&#25311;&#25104; IDE &#25509;&#21475;&#20102;</span>

<span style="color: #b22222;">######</span>
&#25346;&#36733;&#20809;&#30424;&#35774;&#22791;&#65306;
&#20809;&#30424;&#35774;&#22791;&#25991;&#20214;&#65306;
IDE: /dev/hdc
SATA: /dev/sr0

&#31526;&#21495;&#38142;&#25509;&#25991;&#20214;&#65306;
/dev/cdrom
/dev/cdrw
/dev/dvd
/dev/dvdrw

<span style="color: #b22222;"># </span><span style="color: #b22222;">6 &#25346;&#36733;U&#30424;&#65306;</span>
&#20107;&#20808;&#35782;&#21035;U&#30424;&#35774;&#22791;&#25991;&#20214;&#65307;

<span style="color: #b22222;"># </span><span style="color: #b22222;">6 &#25346;&#36733;&#26412;&#22320;&#30340;&#22238;&#29615;&#35774;&#22791;&#65306;&#21487;&#20197;&#29992;&#25991;&#20214;&#24403;&#27169;&#25311;&#30828;&#30424;&#29992;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#24847;&#65306;&#26412;&#22320;&#22238;&#29615;&#35774;&#22791;&#26410;&#24517;&#37117;&#26159; ISO &#38236;&#20687;&#65292;&#21487;&#20197;&#26159; image &#25991;&#20214; </span>
dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=/disk.iso <span style="color: #a0522d;">bs</span>=1M <span style="color: #a0522d;">count</span>=100
mkfs.ext4 /disk.iso
mount -o loop /disk.iso  /media

losetup - set up and control loop devices
losetup -a: &#26174;&#31034;&#25152;&#26377;&#24050;&#29992;&#30340;loop&#35774;&#22791;&#30456;&#20851;&#20449;&#24687;
losetup -f: &#26174;&#31034;&#31532;&#19968;&#20010;&#31354;&#38386;&#30340;loop&#35774;&#22791;&#25991;&#20214;
losetup /dev/loop0 /images/xen/busybox3.img

<span style="color: #b22222;"># </span><span style="color: #b22222;">NAS&#25346;&#36733;</span>
mount -t nfs -o <span style="color: #a0522d;">vers</span>=4,<span style="color: #a0522d;">minorversion</span>=0,<span style="color: #a0522d;">rsize</span>=1048576,<span style="color: #a0522d;">wsize</span>=1048576,hard,<span style="color: #a0522d;">timeo</span>=600,<span style="color: #a0522d;">retrans</span>=2,noresvport file-system-id.region.nas.aliyuncs.com:/ /mnt    
&#21442;&#25968;&#35828;&#26126;&#65306;
rsize&#65306;&#23450;&#20041;&#25968;&#25454;&#22359;&#30340;&#22823;&#23567;&#65292;&#29992;&#20110;&#23458;&#25143;&#31471;&#19982;&#25991;&#20214;&#31995;&#32479;&#20043;&#38388;&#35835;&#21462;&#25968;&#25454;&#12290;&#24314;&#35758;&#20540;&#65306;1048576&#12290;
wsize&#65306;&#23450;&#20041;&#25968;&#25454;&#22359;&#30340;&#22823;&#23567;&#65292;&#29992;&#20110;&#23458;&#25143;&#31471;&#19982;&#25991;&#20214;&#31995;&#32479;&#20043;&#38388;&#20889;&#20837;&#25968;&#25454;&#12290;&#24314;&#35758;&#20540;&#65306;1048576&#12290;
&#35828;&#26126; &#22914;&#26524;&#24744;&#38656;&#35201;&#26356;&#25913;IO&#22823;&#23567;&#21442;&#25968;&#65288;rsize&#21644;wsize&#65289;&#65292;&#24314;&#35758;&#24744;&#23613;&#21487;&#33021;&#20351;&#29992;&#26368;&#22823;&#20540;&#65288;1048576&#65289;&#65292;&#20197;&#36991;&#20813;&#24615;&#33021;&#19979;&#38477;&#12290;
hard&#65306;&#22312;&#25991;&#20214;&#23384;&#20648;NAS&#26242;&#26102;&#19981;&#21487;&#29992;&#30340;&#24773;&#20917;&#19979;&#65292;&#20351;&#29992;&#25991;&#20214;&#31995;&#32479;&#19978;&#26576;&#20010;&#25991;&#20214;&#30340;&#26412;&#22320;&#24212;&#29992;&#31243;&#24207;&#26102;&#20250;&#20572;&#27490;&#24182;&#31561;&#24453;&#33267;&#35813;&#25991;&#20214;&#31995;&#32479;&#24674;&#22797;&#22312;&#32447;&#29366;&#24577;&#12290;&#24314;&#35758;&#21551;&#29992;&#35813;&#21442;&#25968;&#12290;
timeo&#65306;&#25351;&#23450;&#26102;&#38271;&#65292;&#21333;&#20301;&#20026;0.1&#31186;&#65292;&#21363;NFS&#23458;&#25143;&#31471;&#22312;&#37325;&#35797;&#21521;&#25991;&#20214;&#31995;&#32479;&#21457;&#36865;&#35831;&#27714;&#20043;&#21069;&#31561;&#24453;&#21709;&#24212;&#30340;&#26102;&#38388;&#12290;&#24314;&#35758;&#20540;&#65306;600&#65288;60&#31186;&#65289;&#12290;
&#35828;&#26126; &#22914;&#26524;&#24744;&#24517;&#39035;&#26356;&#25913;&#36229;&#26102;&#21442;&#25968;&#65288;timeo&#65289;&#65292;&#24314;&#35758;&#24744;&#20351;&#29992;150&#25110;&#26356;&#22823;&#30340;&#20540;&#12290;&#35813;timeo&#21442;&#25968;&#30340;&#21333;&#20301;&#20026;0.1&#31186;&#65292;&#22240;&#27492;150&#34920;&#31034;&#30340;&#26102;&#38388;&#20026;15&#31186;&#12290;
retrans&#65306;NFS&#23458;&#25143;&#31471;&#37325;&#35797;&#35831;&#27714;&#30340;&#27425;&#25968;&#12290;&#24314;&#35758;&#20540;&#65306;2&#12290;
noresvport&#65306;&#22312;&#32593;&#32476;&#37325;&#36830;&#26102;&#20351;&#29992;&#26032;&#30340;TCP&#31471;&#21475;&#65292;&#20445;&#38556;&#22312;&#32593;&#32476;&#21457;&#29983;&#25925;&#38556;&#24674;&#22797;&#26102;&#19981;&#20250;&#20013;&#26029;&#36830;&#25509;&#12290;&#24314;&#35758;&#21551;&#29992;&#35813;&#21442;&#25968;&#12290;
_netdev &#38450;&#27490;&#23458;&#25143;&#31471;&#22312;&#32593;&#32476;&#23601;&#32490;&#20043;&#21069;&#24320;&#22987;&#25346;&#36733;&#25991;&#20214;&#31995;&#32479;&#12290;
/etc/fstab&#26368;&#21518;2&#21015;
0&#65288;noresvport&#21518;&#31532;&#19968;&#39033;&#65289;   &#38750;&#38646;&#20540;&#34920;&#31034;&#25991;&#20214;&#31995;&#32479;&#24212;&#30001;dump&#22791;&#20221;&#12290;&#23545;&#20110;NAS&#25991;&#20214;&#31995;&#32479;&#32780;&#35328;&#65292;&#27492;&#20540;&#40664;&#35748;&#20026;0&#12290;
0&#65288;noresvport&#21518;&#31532;&#20108;&#39033;&#65289;   &#35813;&#20540;&#34920;&#31034;fsck&#22312;&#21551;&#21160;&#26102;&#26816;&#26597;&#25991;&#20214;&#31995;&#32479;&#30340;&#39034;&#24207;&#12290;&#23545;&#20110;NAS&#25991;&#20214;&#31995;&#32479;&#32780;&#35328;&#65292;&#27492;&#20540;&#40664;&#35748;&#20026;0&#65292;&#34920;&#31034;fsck&#19981;&#24212;&#22312;&#21551;&#21160;&#26102;&#36816;&#34892;

<span style="color: #b22222;"># </span><span style="color: #b22222;">smba&#25346;&#36733;</span>
mount -t cifs //xxx-crf23.eu-west-1.nas.aliyuncs.com/myshare /mnt -o <span style="color: #a0522d;">vers</span>=2.1,guest,<span style="color: #a0522d;">uid</span>=0,<span style="color: #a0522d;">gid</span>=0,<span style="color: #a0522d;">dir_mode</span>=0755,<span style="color: #a0522d;">file_mode</span>=0755,mfsymlinks,<span style="color: #a0522d;">cache</span>=strict,<span style="color: #a0522d;">rsize</span>=1048576,<span style="color: #a0522d;">wsize</span>=1048576
&#21442;&#25968;&#35828;&#26126;&#65306;
vers&#65306;&#25903;&#25345;2.1&#25110;&#32773;3.0&#21327;&#35758;&#29256;&#26412;&#12290;
guest&#65306;&#22312;&#35748;&#35777;&#26041;&#38754;&#65292;&#29616;&#22312;&#21482;&#25903;&#25345;&#22522;&#20110;ntlm&#35748;&#35777;&#21327;&#35758;&#30340;guest&#25346;&#36733;&#12290;<span style="color: #a0522d;">&#21363;&#20351;&#29992;username</span>=guest&#12289;<span style="color: #a0522d;">password</span>=guest&#25110;&#32773;guest&#12290;
&#35828;&#26126; &#26381;&#21153;&#22120;&#25903;&#25345;ntlm,ntlmv2&#21644;ntlmssp&#12290;&#40664;&#35748;&#26102;&#65292;SMB&#23458;&#25143;&#31471;&#21644;&#26381;&#21153;&#22120;&#20250;&#21327;&#21830;&#19968;&#20010;&#21487;&#25509;&#21463;&#30340;ntlm&#35748;&#35777;&#21327;&#35758;&#65307;&#25110;&#32773;&#24744;&#22312;&#25346;&#36733;&#26102;&#65292;&#36890;&#36807;sec &lt;option&gt;&#21487;&#20197;&#36873;&#25321;&#19968;&#20010;&#26399;&#26395;&#20540;&#65288;ntlm&#12289;ntlmv2 &#25110;&#32773;ntlmssp&#65289;&#12290;
rsize&#65306;&#29992;&#26469;&#35774;&#32622;&#35835;&#25968;&#25454;&#21253;&#30340;&#26368;&#22823;&#38480;&#21046;&#12290;&#19968;&#33324;&#38656;&#35201;&#35774;&#32622;&#25104;1048576&#65288;1 MB&#65289;&#12290;
wsize&#65306;&#29992;&#26469;&#35774;&#32622;&#20889;&#25968;&#25454;&#21253;&#30340;&#26368;&#22823;&#38480;&#21046;&#65292;&#19968;&#33324;&#38656;&#35201;&#35774;&#32622;&#25104;1048576&#65288;1 MB&#65289;&#12290;
uid&#65306;&#25346;&#36733;&#25104;&#21151;&#21518;&#65292;&#25991;&#20214;&#25152;&#23646;&#30340;&#29992;&#25143;&#12290;&#22914;&#26524;&#26410;&#35774;&#32622;uid&#65292;<span style="color: #a0522d;">&#21017;&#40664;&#35748;uid</span>=0&#12290;
gid&#65306;&#25346;&#36733;&#25104;&#21151;&#21518;&#65292;&#25991;&#20214;&#25152;&#23646;&#30340;&#29992;&#25143;&#32452;&#12290;&#22914;&#26524;&#26410;&#35774;&#32622;gid&#65292;<span style="color: #a0522d;">&#21017;&#40664;&#35748;gid</span>=0&#12290;
dir_mode&#65306;&#21521;&#29992;&#25143;&#25480;&#20104;&#30446;&#24405;&#30340;&#35835;&#21462;&#12289;&#20889;&#20837;&#21644;&#25191;&#34892;&#26435;&#38480;&#12290;&#24517;&#39035;&#20197;0&#24320;&#22836;&#65292;&#20363;&#22914;&#65306;0755&#12289;0644&#31561;&#12290;&#22914;&#26524;&#26410;&#35774;&#32622;dir_more&#65292;<span style="color: #a0522d;">&#21017;&#40664;&#35748;dir_mode</span>=0755&#12290;
file_mode&#65306;&#21521;&#29992;&#25143;&#25480;&#20104;&#26222;&#36890;&#25991;&#20214;&#30340;&#35835;&#21462;&#12289;&#20889;&#20837;&#21644;&#25191;&#34892;&#26435;&#38480;&#12290;&#24517;&#39035;&#20197;0&#24320;&#22836;&#65292;&#20363;&#22914;&#65306;0755&#12289;0644&#31561;&#12290;&#22914;&#26524;&#26410;&#35774;&#32622;file_mode&#65292;<span style="color: #a0522d;">&#21017;&#40664;&#35748;file_mode</span>=0755&#12290;
mfsymlinks&#65306;&#29992;&#20197;&#25903;&#25345;symbol link&#21151;&#33021;&#12290;
cache&#65306;
<span style="color: #a0522d;">cache</span>=strict&#65306;&#35774;&#32622;SMB&#23458;&#25143;&#31471;&#20351;&#29992;&#23458;&#25143;&#31471;&#32531;&#23384;&#12290;&#22914;&#26524;&#26410;&#35774;&#32622;cache&#65292;<span style="color: #a0522d;">&#21017;&#40664;&#35748;cache</span>=strict&#12290;
<span style="color: #a0522d;">cache</span>=none&#65306;&#35774;&#32622;SMB&#23458;&#25143;&#31471;&#19981;&#20351;&#29992;&#23458;&#25143;&#31471;&#32531;&#23384;&#12290;
atime|relatime&#65306;&#22914;&#26524;&#24744;&#30340;&#19994;&#21153;&#19981;&#26159;&#23545;&#25991;&#20214;&#30340;&#35775;&#38382;&#26102;&#38388;&#26497;&#20026;&#25935;&#24863;&#65292;&#35831;&#19981;&#35201;&#22312;&#25346;&#36733;&#26102;&#20351;&#29992;atime&#36873;&#39033;&#65292;&#40664;&#35748;&#26102;&#20250;&#20351;&#29992;relatime&#26041;&#24335;&#25346;&#36733;&#12290;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:698dd5a2-56c6-46ee-bc9e-b969480bbff9" class="outline-4">
<h4 id="h:698dd5a2-56c6-46ee-bc9e-b969480bbff9">卸载文件系统 umount</h4>
<div class="outline-text-4" id="text-h:698dd5a2-56c6-46ee-bc9e-b969480bbff9">
<p>
卸载时：可使用设备，也可以使用挂载点
</p>

<div class="org-src-container">
<pre class="src src-sh">umount &#35774;&#22791;&#21517;|&#25346;&#36733;&#28857;

umount -lf /dev/sdb <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24378;&#21046;&#21462;&#28040;&#25346;&#36733;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d991921a-dab2-4eb7-9951-ba6f8a4e0b32" class="outline-4">
<h4 id="h:d991921a-dab2-4eb7-9951-ba6f8a4e0b32">查看挂载情况</h4>
<div class="outline-text-4" id="text-h:d991921a-dab2-4eb7-9951-ba6f8a4e0b32">
<p>
查看挂载
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;&#26597;&#30475;/etc/mtab&#25991;&#20214;&#26174;&#31034;&#24403;&#21069;&#24050;&#25346;&#36733;&#30340;&#25152;&#26377;&#35774;&#22791;</span>
mount
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20869;&#26680;&#36861;&#36394;&#21040;&#30340;&#24050;&#25346;&#36733;&#30340;&#25152;&#26377;&#35774;&#22791;</span>
cat /proc/mounts
</pre>
</div>

<p>
查看挂载点情况
</p>

<div class="org-src-container">
<pre class="src src-sh">findmnt  MOUNT_POINT|device
</pre>
</div>

<p>
查看正在访问指定文件系统的进程
</p>

<div class="org-src-container">
<pre class="src src-sh">lsof MOUNT_POINT
fuser -v MOUNT_POINT
</pre>
</div>

<p>
终止所有在正访问指定的文件系统的进程
</p>

<div class="org-src-container">
<pre class="src src-sh">fuser -km MOUNT_POINT
</pre>
</div>
</div>
</div>
<div id="outline-container-h:50d6a75a-f75a-48b0-b540-4a1ea5c5d1bd" class="outline-4">
<h4 id="h:50d6a75a-f75a-48b0-b540-4a1ea5c5d1bd">持久挂载</h4>
<div class="outline-text-4" id="text-h:50d6a75a-f75a-48b0-b540-4a1ea5c5d1bd">
<p>
将挂载保存到 /etc/fstab 中可以下次开机时，自动启用挂载
</p>

<p>
/etc/fstab格式帮助：
</p>

<div class="org-src-container">
<pre class="src src-sh">man 5 fstab
</pre>
</div>

<p>
每行定义一个要挂载的文件系统,，其中包括共 6 项
</p>

<div class="org-src-container">
<pre class="src src-sh">/disk.img        /mnt/disk       ext4   loop       0 0
</pre>
</div>

<ol class="org-ol">
<li><p>
要挂载的设备或伪文件系统 设备文件
</p>

<pre class="example" id="org516187e">
LABEL：LABEL=""
UUID：UUID=""
伪文件系统名称：proc, sysfs
推荐用UUID，写设备名的可能不稳定，尤其是逻辑卷，原来是5，6把5删除了6就变成了5
</pre></li>

<li>挂载点：必须是事先存在的目录</li>

<li>文件系统类型：ext4，xfs，iso9660，nfs，none</li>

<li>挂载选项：defaults ，acl，bind</li>

<li>备份频率：0：不做备份 1：每天转储 2：每隔一天转储。基于分区的备份一般不用，写0就好</li>

<li>fsck检查的文件系统的顺序：允许的数字是0 1 2 。 0：不自检，1：首先自检；一般只有rootfs才用 2：非rootfs使用</li>
</ol>

<p>
添加新的挂载项，需要执行下面命令生效
</p>
<div class="org-src-container">
<pre class="src src-sh">mount -a
</pre>
</div>

<p>
范例：vim读书入设备信息
</p>

<div class="org-src-container">
<pre class="src src-sh">vim /etc/fstab
:r!blkid /dev/sdb1
</pre>
</div>

<p>
范例：centos7, 8 /etc/fstab 的分区UUID错误，无法启动
</p>

<div class="org-src-container">
<pre class="src src-sh">&#33258;&#21160;&#36827;&#20837;emergency mode&#25925;&#38556;&#27169;&#24335;,&#36755;&#20837;root &#23494;&#30721;
<span style="color: #b22222;">#</span><span style="color: #b22222;">cat /proc/mounts &#21487;&#20197;&#26597;&#30475;&#21040;/ &#20197;rw&#26041;&#24335;&#25346;&#36733;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">vim /etc/fstab</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">reboot</span>
</pre>
</div>

<p>
范例：centos 6 /etc/fstab 的分区UUID错误，无法启动
</p>

<div class="org-src-container">
<pre class="src src-sh">&#22914;&#26524;/etc/fstab &#30340;&#25346;&#36733;&#35774;&#22791;&#20986;&#38169;&#65292;&#27604;&#22914;&#25991;&#20214;&#31995;&#32479;&#25925;&#38556;&#65292;&#24182;&#19988;&#25991;&#20214;&#31995;&#32479;&#26816;&#27979;&#39033;&#65288;&#21363;&#31532;6&#39033;&#20026;&#38750;0&#65289;&#65292;&#23558;&#23548;&#33268;&#26080;&#27861;&#21551;&#21160;

&#33258;&#21160;&#36827;&#20837;emergency mode,&#36755;&#20837;root &#23494;&#30721;
<span style="color: #b22222;">#</span><span style="color: #b22222;">cat /proc/mounts &#21487;&#20197;&#26597;&#30475;&#21040;/ &#20197;ro&#26041;&#24335;&#25346;&#36733;&#65292;&#26080;&#27861;&#30452;&#25509;&#20462;&#25913;&#37197;&#32622;&#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">mount -o remount,rw /</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">vim /etc/fstab</span>
&#23558;&#25925;&#38556;&#34892;&#30340;&#26368;&#21518;1&#39033;&#65292;&#21363;&#31532;6&#39033;&#20462;&#25913;&#20026;0&#65292;&#24320;&#26426;&#19981;&#26816;&#27979;&#27492;&#39033;&#25346;&#36733;&#35774;&#22791;&#30340;&#20581;&#24247;&#24615;&#65292;&#20174;&#32780;&#24573;&#30053;&#38169;&#35823;&#65292;&#33021;&#23454;&#29616;&#21551;&#21160;
</pre>
</div>

<p>
范例：/etc/fstab格式
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /etc/fstab
<span style="color: #a0522d;">UUID</span>=cb7cae1e-d227-4f64-872b-cd6cce20c911 /data/mysql  ext4  noatime    0 0
/disk.img data/disk   xfs   defaults    0 0
/etc      /mnt/etc                 none  bind      0 0 

[root@centos6 ~]#cat /etc/fstab
/disk.img        /mnt/disk       ext4   loop       0 0
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:a098f076-559a-4920-b220-8960eb56ecdc" class="outline-3">
<h3 id="h:a098f076-559a-4920-b220-8960eb56ecdc">处理交换文件和分区</h3>
<div class="outline-text-3" id="text-h:a098f076-559a-4920-b220-8960eb56ecdc">
</div>
<div id="outline-container-h:7470583d-3528-4316-b425-04624cc37c66" class="outline-4">
<h4 id="h:7470583d-3528-4316-b425-04624cc37c66">swap 介绍</h4>
<div class="outline-text-4" id="text-h:7470583d-3528-4316-b425-04624cc37c66">
<p>
当内存不足时，用磁盘模拟内存使用，速度很慢
</p>

<p>
swap交换分区是系统RAM的补充，swap 分区支持虚拟内存。当没有足够的 RAM保
存系统处理的数据时会将数据写入 swap 分区，当系统缺乏 swap空间时，内核
会因 RAM 内存耗尽而终止进程。配置过多 swap空间会造成存储设备处于分配状
态但闲置，造成浪费，过多 swap空间还会掩盖内存泄露
</p>

<p>
注意：为优化性能，可以将swap 分布存放，或高性能磁盘存放
</p>

<p>
<b>官方推荐推荐系统 swap 空间</b>
</p>

<ul class="org-ul">
<li><a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/installation_guide/sect-disk-partitioning-setup-ppc#sect-recommended-partitioning-scheme-ppc">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/installation_guide/sect-disk-partitioning-setup-ppc#sect-recommended-partitioning-scheme-ppc</a></li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">系统中的 RAM 量</th>
<th scope="col" class="org-left">推荐的 swap 空间</th>
<th scope="col" class="org-left">允许休眠的建议 swap 空间大小</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">低于 2 GB</td>
<td class="org-left">RAM 量的2倍数</td>
<td class="org-left">RAM 容量的三倍</td>
</tr>

<tr>
<td class="org-left">2 GB - 8 GB</td>
<td class="org-left">等于 RAM 量</td>
<td class="org-left">RAM 量的倍数</td>
</tr>

<tr>
<td class="org-left">8 GB - 64 GB</td>
<td class="org-left">4 GB 到 RAM 容量的 0.5 倍</td>
<td class="org-left">RAM 容量的 1.5 倍</td>
</tr>

<tr>
<td class="org-left">超过 64 GB</td>
<td class="org-left">独立负载（至少 4GB）</td>
<td class="org-left">不建议使用休眠功能</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:1b8a44ce-deb5-4e21-a31b-71f26a8ce1c6" class="outline-4">
<h4 id="h:1b8a44ce-deb5-4e21-a31b-71f26a8ce1c6">交换分区实现过程</h4>
<div class="outline-text-4" id="text-h:1b8a44ce-deb5-4e21-a31b-71f26a8ce1c6">
<ol class="org-ol">
<li>创建交换分区或者文件</li>
<li>使用mkswap写入特殊签名</li>
<li>在/etc/fstab文件中添加适当的条目</li>
<li>使用swapon -a 激活交换空间</li>
</ol>

<p>
启用swap分区
</p>

<div class="org-src-container">
<pre class="src src-sh">swapon [OPTION]... [DEVICE]

&#36873;&#39033;&#65306;
-a                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28608;&#27963;&#25152;&#26377;&#30340;&#20132;&#25442;&#20998;&#21306;</span>
-p PRIORITY   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#20248;&#20808;&#32423;&#65292;&#20063;&#21487;&#22312;/etc/fstab &#22312;&#31532;4&#21015;&#25351;&#23450;&#65306;pri=value</span>
-s                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;</span>
</pre>
</div>

<p>
范例: 以磁盘分区方式创建swap
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#echo -e <span style="color: #8b2252;">'n\np\n\n\n+2G\nt\n82\nw\n'</span> | fdisk /dev/sdc
[root@centos8 ~]#mkswap /dev/sdc1
Setting up swapspace version 1, <span style="color: #a0522d;">size</span> = 2 GiB (2147479552 bytes)
no label, <span style="color: #a0522d;">UUID</span>=d3140a7a-65b7-4cb7-8a2b-12d38aa98c6f
[root@centos8 ~]#blkid /dev/sdc1
/dev/sdc1: <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"d3140a7a-65b7-4cb7-8a2b-12d38aa98c6f"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"swap"</span>
<span style="color: #a0522d;">PARTUUID</span>=<span style="color: #8b2252;">"b094d43d-01</span>

<span style="color: #8b2252;">[root@centos8 ~]#vim /etc/fstab</span>
<span style="color: #8b2252;">UUID=d3140a7a-65b7-4cb7-8a2b-12d38aa98c6f swap     swap defaults 0 0</span>

<span style="color: #8b2252;">[root@centos8 ~]#swapon -a</span>
<span style="color: #8b2252;">[root@centos8 ~]#free -h</span>
<span style="color: #8b2252;">      total    used    free   shared buff/cache  available</span>
<span style="color: #8b2252;">Mem:      3.7Gi    264Mi    3.2Gi    9.0Mi    261Mi    3.2Gi</span>
<span style="color: #8b2252;">Swap:     4.0Gi     0B    4.0Gi</span>
<span style="color: #8b2252;">[root@centos8 ~]#cat /proc/swaps</span>
<span style="color: #8b2252;">Filename Type Size Used Priority</span>
<span style="color: #8b2252;">/dev/sda5                partition 2097148 0 -2</span>
<span style="color: #8b2252;">/dev/sdc1                partition 2097148 0 -3</span>
</pre>
</div>

<p>
范例：以文件方式创建swap
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#19968;&#20010;&#29992;&#20110;&#20132;&#25442;&#30340;&#25991;&#20214;</span>
fallocate -l 1G /swapfile
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#20351;&#29992;dd&#21019;&#24314;&#20132;&#25442;&#25991;&#20214;</span>
dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=/swapfile <span style="color: #a0522d;">bs</span>=1M <span style="color: #a0522d;">count</span>=1024

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#27491;&#30830;&#30340;&#26435;&#38480;</span>
chmod 600 /swapfile

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;Linux&#20132;&#25442;&#21306;&#25991;&#20214;&#31995;&#32479;</span>
mkswap /swapfile

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#20132;&#25442;</span>
swapon /swapfile
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27704;&#20037;&#35774;&#32622;&#65292;&#25171;&#24320;/etc/fstab</span>
cat &lt;&lt;\EOF&gt;&gt; /etc/fstab
<span style="color: #ffa54f;">/swapfile swap swap defaults 0 0</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;</span>
swapon -s
free -m

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#20132;&#25442;&#25991;&#20214;</span>
swapoff -v /swapfile
</pre>
</div>


<p>
禁用swap分区：
</p>

<div class="org-src-container">
<pre class="src src-sh">swapoff [OPTION]... [DEVICE]
</pre>
</div>

<p>
范例:禁用swap分区
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#sed -i.bak <span style="color: #8b2252;">'/swap/d'</span> /etc/fstab
[root@centos8 ~]#swapoff -a
</pre>
</div>

<p>
<b>SWAP的优先级</b>
</p>

<p>
可以指定swap分区0到32767的优先级，值越大优先级越高
</p>

<p>
如果用户没有指定，那么核心会自动给swap指定一个优先级，这个优先级从-1开
始，每加入一个新的
</p>

<p>
没有用户指定优先级的swap，会给这个优先级减一
</p>

<p>
先添加的swap的缺省优先级比较高，除非用户自己指定一个优先级，而用户指定
的优先级(是正数)永远高于核心缺省指定的优先级(是负数)
</p>
</div>
</div>
<div id="outline-container-h:f6966f45-4165-419c-94b5-6274d9f00302" class="outline-4">
<h4 id="h:f6966f45-4165-419c-94b5-6274d9f00302">swap的使用策略</h4>
<div class="outline-text-4" id="text-h:f6966f45-4165-419c-94b5-6274d9f00302">
<p>
/proc/sys/vm/swappiness
的值决定了当内存占用达到一定的百分比时，会启用swap分区的空间
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]# cat /proc/sys/vm/swappiness
30
[root@rhel5 ~]# cat /proc/sys/vm/swappiness
60
</pre>
</div>

<p>
说明：内存在使用到100-30=70%的时候，就开始出现有交换分区的使用。简单地
说这个参数定义了系统对swap的使用倾向，默认值为30，值越大表示越倾向于使
用swap。可以设为0，这样做并不会禁止对swap的使用，只是最大限度地降低了
使用swap的可能性
</p>
</div>
</div>
</div>
<div id="outline-container-h:2ed19f37-bf19-41df-adba-657193b1f13b" class="outline-3">
<h3 id="h:2ed19f37-bf19-41df-adba-657193b1f13b">移动介质</h3>
<div class="outline-text-3" id="text-h:2ed19f37-bf19-41df-adba-657193b1f13b">
<p>
挂载意味着使外来的文件系统看起来如同是主目录树的一部分，所有移动介质也
需要挂载，挂载点通常在/media或/mnt下
</p>

<p>
访问前，介质必须被挂载
</p>

<p>
摘除时，介质必须被卸载
</p>

<p>
按照默认设置，非根用户只能挂载某些设备（光盘、DVD、软盘、USB等等）
</p>
</div>
<div id="outline-container-h:4da950f8-5acb-4af0-947d-dd90f63a069e" class="outline-4">
<h4 id="h:4da950f8-5acb-4af0-947d-dd90f63a069e">使用光盘</h4>
<div class="outline-text-4" id="text-h:4da950f8-5acb-4af0-947d-dd90f63a069e">
<p>
在图形环境下自动启动挂载/run/media/&lt;user&gt;/&lt;label&gt;
</p>

<p>
手工挂载
</p>
<div class="org-src-container">
<pre class="src src-sh">mount /dev/cdrom /mnt/
</pre>
</div>

<p>
操作光盘
</p>
<div class="org-src-container">
<pre class="src src-sh">eject           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24377;&#20986;&#20809;&#30424;</span>
eject -t       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24377;&#20837;&#20809;&#30424;</span>
</pre>
</div>

<p>
创建ISO文件
</p>
<div class="org-src-container">
<pre class="src src-sh">cp /dev/cdrom /root/centos.iso
mkisofs -r -o /root/etc.iso /etc <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26469;&#33258;&#20110;genisoimage&#21253;</span>
</pre>
</div>

<p>
刻录光盘
</p>
<div class="org-src-container">
<pre class="src src-sh">wodim &#8211;v &#8211;eject centos.iso
</pre>
</div>

<p>
<b>将ISO制作为U盘工具Rufus</b>
</p>

<p>
Rufus 是开源免费的快速制作U盘和格式化USB的实用小工具，它可以快速把ISO
格式的系统镜像文件快速制作成可引导的USB启动安装盘，支持Windows或Linux
启动。软件体积仅700多KB，麻雀虽小，但五脏俱全！
</p>
</div>
</div>
<div id="outline-container-h:f755173b-d9fb-4a64-82ce-986a0f53f1c2" class="outline-4">
<h4 id="h:f755173b-d9fb-4a64-82ce-986a0f53f1c2">USB介质</h4>
<div class="outline-text-4" id="text-h:f755173b-d9fb-4a64-82ce-986a0f53f1c2">
<p>
查看USB设备是否识别
</p>

<div class="org-src-container">
<pre class="src src-sh">lsusb   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26469;&#33258;&#20110;usbutils&#21253;</span>
</pre>
</div>

<p>
被内核探测为SCSI设备，表现为/dev/sdaX 、 /dev/sdbX 或类似的设备文件
</p>

<p>
在图形环境中自动挂载在/run/media/&lt;user&gt;/&lt;label&gt;
</p>

<p>
手动挂载
</p>

<div class="org-src-container">
<pre class="src src-sh">mount /dev/sdX# /mnt
</pre>
</div>

<p>
范例：插入U盘后可以看到日志信息
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">tail /var/log/messages -f</span>
dmesg
</pre>
</div>

<p>
范例：格式化U盘为 FAT32 文件系统
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dnf -y install dosfstools
[root@centos8 ~]#mkfs.vfat /dev/sdd1
mkfs.fat 4.1 (2017-01-24)
[root@centos8 ~]#mount /dev/sdd1 /mnt
</pre>
</div>

<p>
范例：查看USB设备
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum -y install usbutils
[root@centos8 ~]#lsusb
Bus 004 Device 002: ID 0951:1666 Kingston Technology DataTraveler 100 G3/G4/SE9G2
Bus 004 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 002 Device 003: ID 0e0f:0002 VMware, Inc. Virtual USB Hub
Bus 002 Device 002: ID 0e0f:0003 VMware, Inc. Virtual Mouse
Bus 002 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
</pre>
</div>
</div>
<div id="outline-container-h:e9a55927-6e9c-41f9-964a-3c5ec441b36d" class="outline-5">
<h5 id="h:e9a55927-6e9c-41f9-964a-3c5ec441b36d">制作U盘启动安装CentOS</h5>
<div class="outline-text-5" id="text-h:e9a55927-6e9c-41f9-964a-3c5ec441b36d">
<p>
方法一：使用UltraISO，将u盘做成启动盘
</p>

<p>
1.文件&#x2013;&gt;打开&#x2013;&gt;选择CentOS6.6的iso镜像CentOS-6.6-x86_64-bin-DVD1.iso
</p>


<figure id="orgeaf0365">
<img src="images/image-20210310162916285.png" alt="image-20210310162916285.png" width="80%">

</figure>


<figure id="org3d4ad05">
<img src="images/image-20210310162928701.png" alt="image-20210310162928701.png" width="80%">

</figure>

<p>
2.启动&#x2013;&gt;写入硬盘映像
</p>


<figure id="org2778782">
<img src="images/image-20210310162943318.png" alt="image-20210310162943318.png" width="80%">

</figure>


<figure id="org9f000b8">
<img src="images/image-20210310162956163.png" alt="image-20210310162956163.png" width="80%">

</figure>
</div>
</div>
</div>
</div>
<div id="outline-container-h:87b6ab89-195e-4106-92f1-8302c0cf7544" class="outline-3">
<h3 id="h:87b6ab89-195e-4106-92f1-8302c0cf7544">磁盘常见工具</h3>
<div class="outline-text-3" id="text-h:87b6ab89-195e-4106-92f1-8302c0cf7544">
</div>
<div id="outline-container-h:60c75dae-bb03-4e5d-bbd7-0f4e74fe0c11" class="outline-4">
<h4 id="h:60c75dae-bb03-4e5d-bbd7-0f4e74fe0c11">文件系统空间占用等信息的查看工具df</h4>
<div class="outline-text-4" id="text-h:60c75dae-bb03-4e5d-bbd7-0f4e74fe0c11">
<div class="org-src-container">
<pre class="src src-sh">df [OPTION]... [FILE]...

&#24120;&#29992;&#36873;&#39033;
-H    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;10&#20026;&#21333;&#20301;</span>
-T     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25991;&#20214;&#31995;&#32479;&#31867;&#22411;</span>
-h     <span style="color: #b22222;">#</span><span style="color: #b22222;">human-readable</span>
-i      <span style="color: #b22222;">#</span><span style="color: #b22222;">inodes instead of blocks</span>
-P     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;Posix&#20860;&#23481;&#30340;&#26684;&#24335;&#36755;&#20986;&#12290;&#26684;&#24335;&#25972;&#40784;&#20123;&#65292;&#24403;&#35774;&#22791;&#21517;&#27604;&#36739;&#38271;&#26102;&#21487;&#20197;&#25918;&#19968;&#34892;&#26174;&#31034;&#12290;</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#df -Th
Filesystem   Type   Size Used Avail Use% Mounted on
/dev/sda2   xfs    100G  2.7G  98G  3% /
/dev/sda3   xfs    50G  1.4G  49G  3% /data

[root@centos8 ~]#lsblk -f
NAME  FSTYPE LABEL           UUID                
MOUNTPOINT
sda                                      
&#9500;&#9472;sda1 ext4                5c2216e3-ae34-444e-aa60-83cbaebb47e7
/boot
&#9500;&#9472;sda2 xfs                f7f53add-b184-4ddc-8d2c-5263b84d1e15 /
&#9500;&#9472;sda3 xfs                9a2293a8-9277-4b18-bae1-498e0b9da145
</pre>
</div>

<p>
范例：自动识别目录所在磁盘 df -kP /path
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">df -h</span>
Filesystem                   Size  Used Avail Use% Mounted on
/dev/vda1                     40G   13G   25G  35% /
devtmpfs                     3.7G     0  3.7G   0% /dev
tmpfs                        3.7G     0  3.7G   0% /dev/shm
tmpfs                        3.7G  484K  3.7G   1% /run
tmpfs                        3.7G     0  3.7G   0% /sys/fs/cgroup
/dev/mapper/vg_data-lv_data   89G  2.5G   82G   3% /apps

<span style="color: #b22222;"># </span><span style="color: #b22222;">df -kP /tmp</span>
Filesystem     1024-blocks     Used Available Capacity Mounted on
/dev/vda1         41147472 13424504  25819476      35% /

[root@ali-prod-ops-k8s-kubectl ~] <span style="color: #a0522d;">eth0</span> = 10.16.202.198
<span style="color: #b22222;"># </span><span style="color: #b22222;">df -kP /apps</span>
Filesystem                  1024-blocks    Used Available Capacity Mounted on
/dev/mapper/vg_data-lv_data    92759720 2600600  85424144       3% /apps
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a4448b54-3e98-49fa-9d25-42cd0304ee83" class="outline-4">
<h4 id="h:a4448b54-3e98-49fa-9d25-42cd0304ee83">查看某目录总体空间占用状态du</h4>
<div class="outline-text-4" id="text-h:a4448b54-3e98-49fa-9d25-42cd0304ee83">
<div class="org-src-container">
<pre class="src src-sh">du [OPTION]... DIR

&#24120;&#29992;&#36873;&#39033;
-h   <span style="color: #b22222;">#</span><span style="color: #b22222;">human-readable</span>
-s   <span style="color: #b22222;">#</span><span style="color: #b22222;">summary </span>
--max-depth=#  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#26368;&#22823;&#30446;&#24405;&#23618;&#32423;</span>

&#20854;&#20182;
--exclude=[files] : &#25490;&#38500;&#21305;&#37197;&#25991;&#20214;&#25110;&#25991;&#20214;&#22841;
-a: &#36882;&#24402;&#26174;&#31034;&#25351;&#23450;&#30446;&#24405;&#20013;&#21508;&#25991;&#20214;&#21644;&#23376;&#30446;&#24405;&#20013;&#25991;&#20214;&#21344;&#29992;&#30340;&#25968;&#25454;&#22359;
-l: &#35745;&#31639;&#25152;&#26377;&#25991;&#20214;&#22823;&#23567;&#65292;&#23545;&#30828;&#38142;&#25509;&#25991;&#20214;&#35745;&#31639;&#22810;&#27425;
</pre>
</div>
</div>
<div id="outline-container-h:c8bdfb52-947b-4763-a054-05047366c079" class="outline-5">
<h5 id="h:c8bdfb52-947b-4763-a054-05047366c079">df和du的区别</h5>
<div class="outline-text-5" id="text-h:c8bdfb52-947b-4763-a054-05047366c079">
<ul class="org-ul">
<li>df 查看的是文件系统的空间使用，包括元数据和数据。删除文件后，如果此文件正在使用，不会立即释放空间</li>
<li>du 查看的是文件数据空间使用，不包括元数据。删除文件后空间立即释放。</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:bbda5d5b-62fe-415f-962d-bd0e74352285" class="outline-4">
<h4 id="h:bbda5d5b-62fe-415f-962d-bd0e74352285">工具dd</h4>
<div class="outline-text-4" id="text-h:bbda5d5b-62fe-415f-962d-bd0e74352285">
<p>
dd 命令：convert and copy a file
</p>

<p>
格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">dd <span style="color: #a0522d;">if</span>=/PATH/FROM/SRC <span style="color: #a0522d;">of</span>=/PATH/TO/DEST <span style="color: #a0522d;">bs</span>=# <span style="color: #a0522d;">count</span>=#

&#24120;&#29992;&#36873;&#39033;
<span style="color: #a0522d;">if</span>=file               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#25152;&#21629;&#21517;&#25991;&#20214;&#35835;&#21462;&#32780;&#19981;&#26159;&#20174;&#26631;&#20934;&#36755;&#20837;</span>
<span style="color: #a0522d;">of</span>=file             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20889;&#21040;&#25152;&#21629;&#21517;&#30340;&#25991;&#20214;&#32780;&#19981;&#26159;&#21040;&#26631;&#20934;&#36755;&#20986;</span>
<span style="color: #a0522d;">ibs</span>=size           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#27425;&#35835;size&#20010;byte</span>
<span style="color: #a0522d;">obs</span>=size         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#27425;&#20889;size&#20010;byte</span>
<span style="color: #a0522d;">bs</span>=size           <span style="color: #b22222;">#</span><span style="color: #b22222;">block size, &#25351;&#23450;&#22359;&#22823;&#23567;&#65288;&#26082;&#26159;&#26159;ibs&#20063;&#26159;obs)</span>
<span style="color: #a0522d;">cbs</span>=size         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#27425;&#36716;&#21270;size&#20010;byte</span>
<span style="color: #a0522d;">skip</span>=blocks   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#24320;&#22836;&#24573;&#30053;blocks&#20010;ibs&#22823;&#23567;&#30340;&#22359;</span>
<span style="color: #a0522d;">seek</span>=blocks  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#24320;&#22836;&#24573;&#30053;blocks&#20010;obs&#22823;&#23567;&#30340;&#22359;</span>
<span style="color: #a0522d;">count</span>=n         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;n&#20010;bs</span>
<span style="color: #a0522d;">conv</span>=conversion[,conversion...] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#25351;&#23450;&#30340;&#21442;&#25968;&#36716;&#25442;&#25991;&#20214;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">conversion &#36716;&#25442;&#21442;&#25968;:</span>
ascii &#36716;&#25442; EBCDIC &#20026; ASCII
ebcdic &#36716;&#25442; ASCII &#20026; EBCDIC
lcase &#25226;&#22823;&#20889;&#23383;&#31526;&#36716;&#25442;&#20026;&#23567;&#20889;&#23383;&#31526;
ucase &#25226;&#23567;&#20889;&#23383;&#31526;&#36716;&#25442;&#20026;&#22823;&#20889;&#23383;&#31526;
nocreat &#19981;&#21019;&#24314;&#36755;&#20986;&#25991;&#20214;
noerror &#20986;&#38169;&#26102;&#19981;&#20572;&#27490;
notrunc &#19981;&#25130;&#30701;&#36755;&#20986;&#25991;&#20214;
sync &#25226;&#27599;&#20010;&#36755;&#20837;&#22359;&#22635;&#20805;&#21040;ibs&#20010;&#23383;&#33410;&#65292;&#19981;&#36275;&#37096;&#20998;&#29992;&#31354;(NUL)&#23383;&#31526;&#34917;&#40784;
fdatasync &#20889;&#23436;&#25104;&#21069;&#65292;&#29289;&#29702;&#20889;&#20837;&#36755;&#20986;&#25991;&#20214;
</pre>
</div>

<p>
两个特殊设备：
</p>
<ul class="org-ul">
<li>/dev/null: 数据黑洞；类似于回收站</li>
<li>/dev/zero：吐零机；该设备无穷尽地提供0,（不产生读磁盘IO）</li>
</ul>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat f1.txt;
abcdef
[root@centos8 ~]#cat f2.txt
123456789
[root@centos8 ~]#dd <span style="color: #a0522d;">if</span>=f1.txt <span style="color: #a0522d;">of</span>=f2.txt <span style="color: #a0522d;">bs</span>=1 <span style="color: #a0522d;">count</span>=2 <span style="color: #a0522d;">skip</span>=3 <span style="color: #a0522d;">seek</span>=4 
2+0 records<span style="color: #a020f0;"> in</span>
2+0 records out
2 bytes copied, 6.6515e-05 s, 30.1 kB/s
[root@centos8 ~]#cat f2.txt
1234de[root@centos8 ~]#echo 123456789 &gt; f2.txt
[root@centos8 ~]#cat f2.txt
123456789
[root@centos8 ~]#cat f1.txt
abcdef
[root@centos8 ~]#cat f1.txt; cat f2.txt
abcdef
123456789
[root@centos8 ~]#dd <span style="color: #a0522d;">if</span>=f1.txt <span style="color: #a0522d;">of</span>=f2.txt <span style="color: #a0522d;">bs</span>=1 <span style="color: #a0522d;">count</span>=2 <span style="color: #a0522d;">skip</span>=3 <span style="color: #a0522d;">seek</span>=4 <span style="color: #a0522d;">conv</span>=notrunc
2+0 records<span style="color: #a020f0;"> in</span>
2+0 records out
2 bytes copied, 7.6153e-05 s, 26.3 kB/s
[root@centos8 ~]#cat f2.txt
1234de789
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;MBR</span>
dd <span style="color: #a0522d;">if</span>=/dev/sda <span style="color: #a0522d;">of</span>=/tmp/mbr.bak <span style="color: #a0522d;">bs</span>=512 <span style="color: #a0522d;">count</span>=1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30772;&#22351;MBR&#20013;&#30340;bootloader</span>
dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=/dev/sda <span style="color: #a0522d;">bs</span>=64 <span style="color: #a0522d;">count</span>=1 <span style="color: #a0522d;">seek</span>=446

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26377;&#19968;&#20010;&#22823;&#19982;2K&#30340;&#20108;&#36827;&#21046;&#25991;&#20214;fileA&#12290;&#29616;&#22312;&#24819;&#20174;&#31532;64&#20010;&#23383;&#33410;&#20301;&#32622;&#24320;&#22987;&#35835;&#21462;&#65292;&#38656;&#35201;&#35835;&#21462;&#30340;&#22823;&#23567;&#26159;128Byts&#12290;&#21448;&#26377;fileB, &#24819;&#25226;&#19978;&#38754;&#35835;&#21462;&#21040;&#30340;128Bytes&#20889;&#21040;&#31532;32&#20010;&#23383;&#33410;&#24320;&#22987;&#30340;&#20301;&#32622;&#65292;&#26367;&#25442;128Bytes&#65292;&#23454;&#29616;&#22914;&#19979;</span>
dd <span style="color: #a0522d;">if</span>=fileA <span style="color: #a0522d;">of</span>=fileB <span style="color: #a0522d;">bs</span>=1 <span style="color: #a0522d;">count</span>=128 <span style="color: #a0522d;">skip</span>=63 <span style="color: #a0522d;">seek</span>=31 <span style="color: #a0522d;">conv</span>=notrunc

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#26412;&#22320;&#30340;/dev/sdx&#25972;&#30424;&#22791;&#20221;&#21040;/dev/sdy</span>
dd <span style="color: #a0522d;">if</span>=/dev/sdx <span style="color: #a0522d;">of</span>=/dev/sdy

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;/dev/sdx&#20840;&#30424;&#25968;&#25454;&#22791;&#20221;&#21040;&#25351;&#23450;&#36335;&#24452;&#30340;image&#25991;&#20214;</span>
dd <span style="color: #a0522d;">if</span>=/dev/sdx <span style="color: #a0522d;">of</span>=/path/to/image

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;/dev/sdx&#20840;&#30424;&#25968;&#25454;&#65292;&#24182;&#21033;&#29992;gzip&#21387;&#32553;&#65292;&#20445;&#23384;&#21040;&#25351;&#23450;&#36335;&#24452;</span>
dd <span style="color: #a0522d;">if</span>=/dev/sdx | gzip &gt;/path/to/image.gz

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#22791;&#20221;&#25991;&#20214;&#24674;&#22797;&#21040;&#25351;&#23450;&#30424;</span>
dd <span style="color: #a0522d;">if</span>=/path/to/image <span style="color: #a0522d;">of</span>=/dev/sdx

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#21387;&#32553;&#30340;&#22791;&#20221;&#25991;&#20214;&#24674;&#22797;&#21040;&#25351;&#23450;&#30424;</span>
gzip -dc /path/to/image.gz | dd <span style="color: #a0522d;">of</span>=/dev/sdx

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#20869;&#23384;&#37324;&#30340;&#25968;&#25454;&#25335;&#36125;&#21040;root&#30446;&#24405;&#19979;&#30340;mem.bin&#25991;&#20214;</span>
dd <span style="color: #a0522d;">if</span>=/dev/mem <span style="color: #a0522d;">of</span>=/root/mem.bin <span style="color: #a0522d;">bs</span>=1024

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25335;&#36125;&#20809;&#30424;&#25968;&#25454;&#21040;root&#25991;&#20214;&#22841;&#19979;&#65292;&#24182;&#20445;&#23384;&#20026;cdrom.iso&#25991;&#20214;</span>
dd <span style="color: #a0522d;">if</span>=/dev/cdrom <span style="color: #a0522d;">of</span>=/root/cdrom.iso

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38144;&#27585;&#30913;&#30424;&#25968;&#25454;</span>
dd <span style="color: #a0522d;">if</span>=/dev/urandom <span style="color: #a0522d;">of</span>=/dev/sda1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;&#27604;&#36739;dd&#25351;&#20196;&#36755;&#20986;&#20013;&#21629;&#20196;&#30340;&#25191;&#34892;&#26102;&#38388;&#65292;&#21363;&#21487;&#30830;&#23450;&#31995;&#32479;&#26368;&#20339;&#30340;block size&#22823;&#23567;</span>
dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=/root/1Gb.file <span style="color: #a0522d;">bs</span>=1024 <span style="color: #a0522d;">count</span>=1000000
dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=/root/1Gb.file <span style="color: #a0522d;">bs</span>=2048 <span style="color: #a0522d;">count</span>=500000 
dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=/root/1Gb.file <span style="color: #a0522d;">bs</span>=4096 <span style="color: #a0522d;">count</span>=250000

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;&#30828;&#30424;&#20889;&#36895;&#24230;</span>
dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=/root/1Gb.file <span style="color: #a0522d;">bs</span>=1024 <span style="color: #a0522d;">count</span>=1000000

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;&#30828;&#30424;&#35835;&#36895;&#24230;</span>
dd <span style="color: #a0522d;">if</span>=/root/1Gb.file <span style="color: #a0522d;">bs</span>=64k | dd <span style="color: #a0522d;">of</span>=/dev/null
</pre>
</div>

<p>
练习
</p>

<ul class="org-ul">
<li>创建一个2G的文件系统，块大小为2048byte，预留1%可用空间,文件系统ext4，
卷标为TEST，要求此分区开机后自动挂载至/test目录，且默认有acl挂载选项</li>
<li>写一个脚本，完成如下功能：
<ol class="org-ol">
<li>列出当前系统识别到的所有磁盘设备</li>
<li>如磁盘数量为1，则显示其空间使用信息
否则，则显示最后一个磁盘上的空间使用信息</li>
</ol></li>
<li>将CentOS6的CentOS-6.10-x86_64-bin-DVD1.iso和
CentOS-6.10-x86_64-bin-DVD2.iso两个文件，合并成一个
CentOS-6.10-x86_64-Everything.iso文件，并将其配置为yum源</li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-h:3b73de93-6c86-4841-b593-d3d87883062f" class="outline-2">
<h2 id="h:3b73de93-6c86-4841-b593-d3d87883062f">RAID</h2>
<div class="outline-text-2" id="text-h:3b73de93-6c86-4841-b593-d3d87883062f">
</div>
<div id="outline-container-h:973a4e72-5a73-4da5-aa9f-22ff8accf254" class="outline-3">
<h3 id="h:973a4e72-5a73-4da5-aa9f-22ff8accf254">什么是RAID</h3>
<div class="outline-text-3" id="text-h:973a4e72-5a73-4da5-aa9f-22ff8accf254">
<p>
独立磁盘冗余阵列(RAID, Redundant Arrays of Independent Disks), 旧名称叫廉价磁盘冗余阵列(Redundant Arrays of Inexpensive Disks),
简称磁盘阵列
</p>

<p>
1988年由加利福尼亚大学伯克利分校（University of California-Berkeley）
"A Case for Redundant Arrays of Inexpensive Disks",多个磁盘合成一个”
阵列”来提供更好的性能、冗余，或者两者都提供
</p>

<p>
<b>RAID功能实现</b>
</p>

<ul class="org-ul">
<li>提高IO能力,磁盘并行读写</li>
<li>提高耐用性,磁盘冗余算法来实现</li>
</ul>

<p>
<b>RAID实现的方式</b>
</p>

<ul class="org-ul">
<li>外接式磁盘阵列：通过扩展卡提供适配能力</li>
<li>内接式RAID：主板集成RAID控制器，安装OS前在BIOS里配置</li>
<li>软件RAID：通过OS实现，比如：群晖的NAS</li>
</ul>
</div>
</div>
<div id="outline-container-h:c4d07f2a-f0f2-4eab-93fe-e541c4321332" class="outline-3">
<h3 id="h:c4d07f2a-f0f2-4eab-93fe-e541c4321332">RAID级别</h3>
<div class="outline-text-3" id="text-h:c4d07f2a-f0f2-4eab-93fe-e541c4321332">
<p>
级别：多块磁盘组织在一起的工作方式有所不同
</p>

<div class="org-src-container">
<pre class="src src-sh">RAID-0&#65306;&#26465;&#24102;&#21367;&#65292;strip
RAID-1&#65306;&#38236;&#20687;&#21367;&#65292;mirror
RAID-2
..
RAID-5
RAID-6
RAID-10
RAID-01
RAID&#32423;&#21035;
</pre>
</div>
</div>
<div id="outline-container-h:4972c508-54ae-428d-a521-ecc4f8a69909" class="outline-4">
<h4 id="h:4972c508-54ae-428d-a521-ecc4f8a69909">RAID-0</h4>
<div class="outline-text-4" id="text-h:4972c508-54ae-428d-a521-ecc4f8a69909">
<p>
以 chunk 单位,读写数据，因为读写时都可以并行处理，所以在所有的级别中，
RAID0的速度是最快的。但是RAID0既没有冗余功能，也不具备容错能力，如果一
个磁盘(物理)损坏，所有数据都会丢失。
</p>

<div class="org-src-container">
<pre class="src src-sh">&#35835;&#12289;&#20889;&#24615;&#33021;&#25552;&#21319;
&#21487;&#29992;&#31354;&#38388;&#65306;N*min(S1,S2,...)
&#26080;&#23481;&#38169;&#33021;&#21147;
&#26368;&#23569;&#30913;&#30424;&#25968;&#65306;1+
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8fee72f6-f628-4dc3-8ad6-fd9611431aa9" class="outline-4">
<h4 id="h:8fee72f6-f628-4dc3-8ad6-fd9611431aa9">RAID-1</h4>
<div class="outline-text-4" id="text-h:8fee72f6-f628-4dc3-8ad6-fd9611431aa9">
<p>
也称为镜像，两组以上的N个硬盘相互作镜像，在一些多线程操作系统中能有很
好的读取速度，理论上读取速度等于硬盘数据的倍数，与RAID 0相同。另外写入
速度有稍微的降低。
</p>

<div class="org-src-container">
<pre class="src src-sh">&#35835;&#24615;&#33021;&#25552;&#21319;&#12289;&#20889;&#24615;&#33021;&#30053;&#26377;&#19979;&#38477;
&#21487;&#29992;&#31354;&#38388;&#65306;1*min(S1,S2,...)
&#30913;&#30424;&#21033;&#29992;&#29575; 50%
&#26377;&#20887;&#20313;&#33021;&#21147;
&#26368;&#23569;&#30913;&#30424;&#25968;&#65306;2+
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c7e3333b-9652-4934-b22d-02d4fa14aa55" class="outline-4">
<h4 id="h:c7e3333b-9652-4934-b22d-02d4fa14aa55">RAID-4</h4>
<div class="outline-text-4" id="text-h:c7e3333b-9652-4934-b22d-02d4fa14aa55">
<p>
和RAID5很像. 但有一个硬盘专用于作检验。
</p>

<div class="org-src-container">
<pre class="src src-sh">&#22810;&#22359;&#25968;&#25454;&#30424;&#24322;&#25110;&#36816;&#31639;&#20540;&#23384;&#20110;&#19987;&#29992;&#26657;&#39564;&#30424;
 &#30913;&#30424;&#21033;&#29992;&#29575; (N-1)/N
&#26377;&#20887;&#20313;&#33021;&#21147;
&#26368;&#23569;&#30913;&#30424;&#25968;&#65306;3+
</pre>
</div>
</div>
</div>
<div id="outline-container-h:19bb3bf6-bb09-496a-9f44-1a2185859dcc" class="outline-4">
<h4 id="h:19bb3bf6-bb09-496a-9f44-1a2185859dcc">RAID-5</h4>
<div class="outline-text-4" id="text-h:19bb3bf6-bb09-496a-9f44-1a2185859dcc">
<p>
与RAID 4不同，每一块硬盘都有检验位。
</p>

<div class="org-src-container">
<pre class="src src-sh">&#35835;&#12289;&#20889;&#24615;&#33021;&#25552;&#21319;
&#21487;&#29992;&#31354;&#38388;&#65306;(N-1)*min(S1,S2,...)
&#26377;&#23481;&#38169;&#33021;&#21147;&#65306;&#20801;&#35768;&#26368;&#22810;1&#22359;&#30913;&#30424;&#25439;&#22351;
&#26368;&#23569;&#30913;&#30424;&#25968;&#65306;3, 3+
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e04af9c1-08c0-4047-a6e9-8c258d1217fc" class="outline-4">
<h4 id="h:e04af9c1-08c0-4047-a6e9-8c258d1217fc">RAID-6</h4>
<div class="outline-text-4" id="text-h:e04af9c1-08c0-4047-a6e9-8c258d1217fc">
<p>
RAID5 只允许最多坏一块硬盘，为了防止2块硬盘同时损坏，有了RAID 6, 每块硬盘有2个检验位。
</p>

<div class="org-src-container">
<pre class="src src-sh">&#35835;&#12289;&#20889;&#24615;&#33021;&#25552;&#21319;
&#21487;&#29992;&#31354;&#38388;&#65306;(N-2)*min(S1,S2,...)
&#26377;&#23481;&#38169;&#33021;&#21147;&#65306;&#20801;&#35768;&#26368;&#22810;2&#22359;&#30913;&#30424;&#25439;&#22351;
&#26368;&#23569;&#30913;&#30424;&#25968;&#65306;4, 4+
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3d1e1314-f915-46bf-a17b-eeee104d4eee" class="outline-4">
<h4 id="h:3d1e1314-f915-46bf-a17b-eeee104d4eee">RAID-10</h4>
<div class="outline-text-4" id="text-h:3d1e1314-f915-46bf-a17b-eeee104d4eee">
<p>
是RAID 1和RAID 0的组合。先2块硬盘作成RAID 1，再2个硬盘作成RAID 1，把2个RAID 1组合为 RAID 0
</p>

<div class="org-src-container">
<pre class="src src-sh">&#35835;&#12289;&#20889;&#24615;&#33021;&#25552;&#21319;
&#21487;&#29992;&#31354;&#38388;&#65306;N*min(S1,S2,...)/2
&#26377;&#23481;&#38169;&#33021;&#21147;&#65306;&#27599;&#32452;&#38236;&#20687;&#26368;&#22810;&#21482;&#33021;&#22351;&#19968;&#22359;
&#26368;&#23569;&#30913;&#30424;&#25968;&#65306;4, 4+
</pre>
</div>
</div>
</div>
<div id="outline-container-h:874f487b-55ff-4026-9df6-e595606d2d58" class="outline-4">
<h4 id="h:874f487b-55ff-4026-9df6-e595606d2d58">RAID-01</h4>
<div class="outline-text-4" id="text-h:874f487b-55ff-4026-9df6-e595606d2d58">
<p>
多块磁盘先实现RAID0,再组合成RAID1
</p>
</div>
</div>
<div id="outline-container-h:bb331ab6-e57d-4a56-90ef-0cfff77d807a" class="outline-4">
<h4 id="h:bb331ab6-e57d-4a56-90ef-0cfff77d807a">RAID-50</h4>
<div class="outline-text-4" id="text-h:bb331ab6-e57d-4a56-90ef-0cfff77d807a">

<figure id="org8541b2b">
<img src="images/image-20210216021040451.png" alt="image-20210216021040451.png" width="60%">

</figure>

<p>
多块磁盘先实现RAID5,再组合成RAID0
</p>
</div>
</div>
<div id="outline-container-h:3ab099aa-4e48-4f25-b5d0-b082380688ca" class="outline-4">
<h4 id="h:3ab099aa-4e48-4f25-b5d0-b082380688ca">其它级别</h4>
<div class="outline-text-4" id="text-h:3ab099aa-4e48-4f25-b5d0-b082380688ca">
<p>
<b>JBOD：Just a Bunch Of Disks 只是一堆磁盘</b>
</p>

<p>
功能：将多块磁盘的空间合并一个大的连续空间使用
</p>

<p>
可用空间：sum(S1,S2,&#x2026;)
</p>

<p>
<b>RAID7</b>
</p>

<p>
非公开的RAID标准，是美国公司的私有专利产品。可以理解为一个独立存储计算机，自身带有操作系统和管理工具，可以
独立运行，理论上性能最高的RAID模式
</p>

<p>
<b>SHR(Synology Hybrid RAID)</b>
</p>

<p>
群晖公司的技术，适合不了解RAID的用户
</p>

<p>
根据磁盘个数自动组成不同的RAID, 1块普通磁盘， 2块RAID1, 3块RAID4, SHR2类似RAID6
</p>

<p>
只支持群晖系统
</p>
</div>
</div>
<div id="outline-container-h:9cebdd7a-3502-49a1-8c2e-cf5fca26e9bb" class="outline-4">
<h4 id="h:9cebdd7a-3502-49a1-8c2e-cf5fca26e9bb">RAID总结</h4>
<div class="outline-text-4" id="text-h:9cebdd7a-3502-49a1-8c2e-cf5fca26e9bb">
<p>
常用级别： RAID-0, RAID-1, RAID-5, RAID-10, RAID-50, JBOD
</p>

<p>
RAID 0, 1, 5, 6, 10, 01级别区别
</p>
<pre class="example" id="org17d0bc3">
1. 磁盘利用率
2. 最少几块磁盘实现
3. 有没有容错性，防止几块磁盘损坏
4. 性能好坏
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b5c9b1fe-0384-4288-beb3-880300a070f8" class="outline-3">
<h3 id="h:b5c9b1fe-0384-4288-beb3-880300a070f8">实现软RAID</h3>
<div class="outline-text-3" id="text-h:b5c9b1fe-0384-4288-beb3-880300a070f8">
<p>
生产中没人用软RAID，都是用硬件RAID. 本节可当了解或忽略。
</p>

<p>
mdadm工具：为软RAID提供管理界面，为空余磁盘添加冗余，结合内核中的
md(multi devices)
</p>

<p>
RAID设备可命名为/dev/md0、/dev/md1、/dev/md2、/dev/md3等
</p>

<p>
mdadm：模式化的工具,支持的RAID级别：LINEAR, RAID0, RAID1, RAID4,
RAID5, RAID6, RAID10
</p>

<p>
命令的语法格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">mdadm [mode] &lt;raiddevice&gt; [options] &lt;component-devices&gt;
</pre>
</div>

<p>
常用选项说明
</p>

<div class="org-src-container">
<pre class="src src-sh">&#27169;&#24335;&#65306;
    &#21019;&#24314;&#65306;-C
    &#35013;&#37197;&#65306;-A
    &#30417;&#25511;&#65306;-F
    &#31649;&#29702;&#65306;-f, -r, -a
&lt;raiddevice&gt;: /dev/md#
&lt;component-devices&gt;: &#20219;&#24847;&#22359;&#35774;&#22791;
-C: &#21019;&#24314;&#27169;&#24335;
    -n <span style="color: #b22222;">#</span><span style="color: #b22222;">: &#20351;&#29992;#&#20010;&#22359;&#35774;&#22791;&#26469;&#21019;&#24314;&#27492;RAID</span>
    -l <span style="color: #b22222;">#</span><span style="color: #b22222;">&#65306;&#25351;&#26126;&#35201;&#21019;&#24314;&#30340;RAID&#30340;&#32423;&#21035;</span>
    -a {yes|no}&#65306;&#33258;&#21160;&#21019;&#24314;&#30446;&#26631;RAID&#35774;&#22791;&#30340;&#35774;&#22791;&#25991;&#20214;
    -c CHUNK_SIZE: &#25351;&#26126;&#22359;&#22823;&#23567;,&#21333;&#20301;k
    -x <span style="color: #b22222;">#</span><span style="color: #b22222;">: &#25351;&#26126;&#31354;&#38386;&#30424;&#30340;&#20010;&#25968;</span>
-D&#65306;&#26174;&#31034;raid&#30340;&#35814;&#32454;&#20449;&#24687;
    mdadm -D /dev/md#

&#31649;&#29702;&#27169;&#24335;&#65306;
    -f: &#26631;&#35760;&#25351;&#23450;&#30913;&#30424;&#20026;&#25439;&#22351;
    -a: &#28155;&#21152;&#30913;&#30424;
    -r: &#31227;&#38500;&#30913;&#30424;

&#35266;&#23519;md&#30340;&#29366;&#24577;&#65306; cat /proc/mdstat
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;mdadm&#21019;&#24314;&#24182;&#23450;&#20041;RAID&#35774;&#22791;</span>
mdadm -C /dev/md0 -a yes -l 5 -n 3 -x 1 /dev/sd{b,c,d,e}1
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#25991;&#20214;&#31995;&#32479;&#23545;&#27599;&#20010;RAID&#35774;&#22791;&#36827;&#34892;&#26684;&#24335;&#21270;</span>
mkfs.xfs /dev/md0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;mdadm&#26816;&#26597;RAID&#35774;&#22791;&#30340;&#29366;&#20917;</span>
mdadm --detail|D /dev/md0
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22686;&#21152;&#26032;&#30340;&#25104;&#21592;</span>
mdadm &#8211;G /dev/md0 &#8211;n4  -a /dev/sdf1
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27169;&#25311;&#30913;&#30424;&#25925;&#38556;</span>
mdadm /dev/md0  -f /dev/sda1
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31227;&#38500;&#30913;&#30424;</span>
mdadm  /dev/md0 &#8211;r /dev/sda1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#22791;&#29992;&#39537;&#21160;&#22120;&#19978;&#37325;&#24314;&#20998;&#21306;</span>
mdadm /dev/md0  -a /dev/sda1
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31995;&#32479;&#26085;&#24535;&#20449;&#24687;</span>
cat /proc/mdstat
</pre>
</div>

<p>
生成配置文件：
</p>

<div class="org-src-container">
<pre class="src src-sh">mdadm &#8211;D &#8211;s &gt;&gt; /etc/mdadm.conf
</pre>
</div>

<p>
停止设备：
</p>

<div class="org-src-container">
<pre class="src src-sh">mdadm &#8211;S /dev/md0
</pre>
</div>

<p>
激活设备：
</p>

<div class="org-src-container">
<pre class="src src-sh">mdadm &#8211;A &#8211;s /dev/md0
</pre>
</div>

<p>
强制启动：
</p>

<div class="org-src-container">
<pre class="src src-sh">mdadm &#8211;R /dev/md0
</pre>
</div>

<p>
删除raid信息：
</p>

<div class="org-src-container">
<pre class="src src-sh">mdadm --zero-superblock /dev/sdb1
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:8e7781b7-ad87-44dd-b691-4881da975c8f" class="outline-2">
<h2 id="h:8e7781b7-ad87-44dd-b691-4881da975c8f">逻辑卷管理器（LVM）</h2>
<div class="outline-text-2" id="text-h:8e7781b7-ad87-44dd-b691-4881da975c8f">
</div>
<div id="outline-container-h:08177873-8507-4d30-9969-6855fee5a55f" class="outline-3">
<h3 id="h:08177873-8507-4d30-9969-6855fee5a55f">LVM介绍</h3>
<div class="outline-text-3" id="text-h:08177873-8507-4d30-9969-6855fee5a55f">
<p>
LVM: Logical Volume Manager可以允许对卷进行方便操作的抽象层，包括重新
设定文件系统的大小，允许在多个物理设备间重新组织文件系统
</p>

<p>
LVM可以弹性的更改LVM的容量
</p>

<p>
通过交换PE来进行资料的转换，将原来LV内的PE转移到其他的设备中以降低LV的
容量，或将其他设备中的PE加到LV中以加大容量
</p>

<p>
<b>实现过程</b>
</p>

<ol class="org-ol">
<li>pvcreate 将设备指定为物理卷</li>
<li>vgcreate 用一个或者多个物理卷来创建一个卷组，物理卷是用固定大小的物理区域
（Physical Extent，PE）来定义的</li>
<li>lvcreate 在物理卷上创建的逻辑卷， 是由物理区域（PE）组成</li>
<li><p>
可以在逻辑卷上创建文件系统并挂载
</p>


<figure id="org9a8c1ef">
<img src="images/image-20210216021128040.png" alt="image-20210216021128040.png" width="60%">

</figure></li>
</ol>

<p>
第一个逻辑卷对应设备名： <code>/dev/dm-#</code>
</p>

<p>
dm: device mapper，将一个或多个底层块设备组织成一个逻辑设备的模块
</p>

<p>
软链接：
</p>

<ul class="org-ul">
<li>/dev/mapper/VG_NAME-LV_NAME</li>
<li>/dev/VG_NAME/LV_NAME</li>
</ul>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh">/dev/mapper/vol0-root
/dev/vol0/root
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4b14bc2f-7089-44bd-a519-52e46a9de2b2" class="outline-3">
<h3 id="h:4b14bc2f-7089-44bd-a519-52e46a9de2b2">实现逻辑卷</h3>
<div class="outline-text-3" id="text-h:4b14bc2f-7089-44bd-a519-52e46a9de2b2">
<p>
相关工具来自于 lvm2 包
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum -y install lvm2
</pre>
</div>
</div>
<div id="outline-container-h:1da9df56-8298-4a17-b9a5-198cca47f9b8" class="outline-4">
<h4 id="h:1da9df56-8298-4a17-b9a5-198cca47f9b8">pv管理工具</h4>
<div class="outline-text-4" id="text-h:1da9df56-8298-4a17-b9a5-198cca47f9b8">
<p>
显示pv信息
</p>

<div class="org-src-container">
<pre class="src src-sh">pvs&#65306;&#31616;&#35201;pv&#20449;&#24687;&#26174;&#31034;
pvdisplay
</pre>
</div>

<p>
创建pv
</p>

<div class="org-src-container">
<pre class="src src-sh">pvcreate /dev/DEVICE
</pre>
</div>

<p>
删除pv
</p>

<div class="org-src-container">
<pre class="src src-sh">pvremove /dev/DEVICE
</pre>
</div>
</div>
</div>
<div id="outline-container-h:dac7283a-62c4-479f-b24a-769a3a65b2a0" class="outline-4">
<h4 id="h:dac7283a-62c4-479f-b24a-769a3a65b2a0">vg管理工具</h4>
<div class="outline-text-4" id="text-h:dac7283a-62c4-479f-b24a-769a3a65b2a0">
<p>
显示卷组
</p>

<div class="org-src-container">
<pre class="src src-sh">vgs
vgdisplay
</pre>
</div>

<p>
创建卷组
</p>

<div class="org-src-container">
<pre class="src src-sh">vgcreate [-s <span style="color: #b22222;">#</span><span style="color: #b22222;">[kKmMgGtTpPeE]] VolumeGroupName PhysicalDevicePath [PhysicalDevicePath...]</span>
</pre>
</div>

<p>
管理卷组
</p>

<div class="org-src-container">
<pre class="src src-sh">vgextend VolumeGroupName PhysicalDevicePath [PhysicalDevicePath...]
vgreduce VolumeGroupName PhysicalDevicePath [PhysicalDevicePath...]
</pre>
</div>

<p>
范例：扩展卷组
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#20837;&#21040;&#21367;&#32452;</span>
vgs
vgextend vg0 /dev/vdc
</pre>
</div>

<p>
删除卷组
</p>

<ul class="org-ul">
<li>先做pvmove</li>
<li>再做vgremove</li>
</ul>
</div>
</div>
<div id="outline-container-h:033be43b-3a4f-4637-ba3f-fffddf837009" class="outline-4">
<h4 id="h:033be43b-3a4f-4637-ba3f-fffddf837009">lv管理工具</h4>
<div class="outline-text-4" id="text-h:033be43b-3a4f-4637-ba3f-fffddf837009">
<p>
显示逻辑卷
</p>

<div class="org-src-container">
<pre class="src src-sh">lvs
Lvdisplay
</pre>
</div>

<p>
创建逻辑卷
</p>

<div class="org-src-container">
<pre class="src src-sh">lvcreate -L <span style="color: #b22222;">#</span><span style="color: #b22222;">[mMgGtT] -n NAME VolumeGroup</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">lvcreate -l 60%VG -n mylv testvg
lvcreate -l 100%FREE -n yourlv testvg
</pre>
</div>

<p>
删除逻辑卷
</p>

<div class="org-src-container">
<pre class="src src-sh">lvremove /dev/VG_NAME/LV_NAME
</pre>
</div>

<p>
重设文件系统大小
</p>

<div class="org-src-container">
<pre class="src src-sh">fsadm [options] resize device [new_size[BKMGTEP]] resize2fs [-f] [-F] [-M] [-P] [-p] device [new_size] xfs_growfs /mountpoint
</pre>
</div>

<p>
范例：创建lvm
</p>

<div class="org-src-container">
<pre class="src src-sh">fdisk /dev/sda
n
p
+5G

t <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#20998;&#21306;&#30340;&#35805;&#35201;&#25913;id 8e&#12290;&#22914;&#26524;&#26159;&#30828;&#30424;&#19981;&#29992;&#25913;</span>
w

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#30913;&#30424;&#20998;&#21306;</span>
lsblk

<span style="color: #b22222;">#</span><span style="color: #b22222;">1.&#21019;&#24314;&#29289;&#29702;&#21367;, 2&#20010;&#29289;&#29702;&#21367;</span>
pvcreate /dev/sda3  /dev/sdc
pvs

<span style="color: #b22222;">#</span><span style="color: #b22222;">2.&#20026;&#21367;&#32452;&#20998;&#37197;&#29289;&#29702;&#21367;</span>
vgs
vgcreate vg0 /dev/sda3
vgdisplay

<span style="color: #b22222;">#</span><span style="color: #b22222;">3.&#20174;&#21367;&#32452;&#21019;&#24314;&#36923;&#36753;&#21367;</span>
lvcreate  -L 256M  -n lv-data vg0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26684;&#24335;&#21270;</span>
mkfs.xfs  /dev/vg0/lv-data
<span style="color: #b22222;">#</span><span style="color: #b22222;">4.&#25346;&#36733;</span>
mount /dev/vg0/lv-data /mnt/data#
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a4df6d57-3275-4971-a21d-b427836afa13" class="outline-4">
<h4 id="h:a4df6d57-3275-4971-a21d-b427836afa13">扩展和缩减逻辑卷</h4>
<div class="outline-text-4" id="text-h:a4df6d57-3275-4971-a21d-b427836afa13">
</div>
<div id="outline-container-h:4bbc1af1-1a91-4d58-8ec9-0485b4fe7f95" class="outline-5">
<h5 id="h:4bbc1af1-1a91-4d58-8ec9-0485b4fe7f95">在线扩展逻辑卷</h5>
<div class="outline-text-5" id="text-h:4bbc1af1-1a91-4d58-8ec9-0485b4fe7f95">
<div class="org-src-container">
<pre class="src src-sh">lvextend -L [+]#[mMgGtT] /dev/VG_NAME/LV_NAME

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38024;&#23545;ext</span>
resize2fs /dev/VG_NAME/LV_NAME
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38024;&#23545;xfs</span>
xfs_growfs MOUNTPOINT

lvresize -r -l +100%FREE /dev/VG_NAME/LV_NAME
</pre>
</div>


<p>
范例： lvm扩展
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;pv</span>
lsblk
pvs
pvcreate /dev/vda3

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#20837;&#21040;&#21367;&#32452;</span>
vgs
vgextend cl /dev/vda3

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25193;&#23637;&#36923;&#36753;&#21367;</span>
lvs
lvdisplay
<span style="color: #b22222;">#</span><span style="color: #b22222;">lvextend -L +5G /dev/cl/root  #&#25193;&#23637;&#31354;&#38388;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">lvextend -l +100%free /dev/cl/root  #&#25193;&#23637;&#31354;&#38388;, &#25152;&#26377;&#21097;&#20313;&#31354;&#38388;&#29992;&#23436;</span>
lvextend -r -l +100%free /dev/cl/root  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#31354;&#38388;&#24102;&#25991;&#20214;&#31995;&#32479;&#19968;&#36215;&#25193;&#20102;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25193;&#25991;&#20214;&#31995;&#32479;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38024;&#23545;ext</span>
resize2fs /dev/VG_NAME/LV_NAME
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38024;&#23545;xfs</span>
xfs_growfs MOUNTPOINT
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8a7ec24b-31a5-4abe-9e9e-829230ab0479" class="outline-5">
<h5 id="h:8a7ec24b-31a5-4abe-9e9e-829230ab0479">缩减逻辑卷</h5>
<div class="outline-text-5" id="text-h:8a7ec24b-31a5-4abe-9e9e-829230ab0479">
<p>
<b>注意：缩减有数据损坏的风险，建议先备份再缩减，xfs文件系统不支持缩减</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1</span>
umount /dev/VG_NAME/LV_NAME
e2fsck -f /dev/VG_NAME/LV_NAME
resize2fs /dev/VG_NAME/LV_NAME <span style="color: #b22222;">#</span><span style="color: #b22222;">[mMgGtT]</span>
lvreduce -L [-]#[mMgGtT] /dev/VG_NAME/LV_NAME
mount /dev/VG_NAME/LV_NAME mountpoint

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2&#65306;&#21487;&#20197;&#31616;&#20889;</span>
umount /dev/VG_NAME/LV_NAME
lvreduce -L [-]#[mMgGtT] -r /dev/VG_NAME/LV_NAME <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#33021;&#26159;ext&#31995;&#32479;&#65292;xfs&#25991;&#20214;&#31995;&#32479;&#19981;&#25903;&#25345;&#32553;&#20943;</span>
mount /dev/VG_NAME/LV_NAME mountpoint
</pre>
</div>

<p>
范例：lvm缩减逻辑卷
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#blkid /dev/vg0/mysql
/dev/vg0/mysql: <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"94674607-2196-4015-9194-4632ac23f36a"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"ext4"</span>
[root@centos8 ~]#lvs
LV  VG Attr    LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert
mysql vg0 -wi-a----- 2.99g 

[root@centos8 ~]#df
Filesystem      1K-blocks  Used Available Use% Mounted on
/dev/mapper/vg0-mysql  3022704   9204  2840240  1% /data/mysql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#19968;&#27493;&#65292;&#21462;&#28040;&#25346;&#36733;</span>
[root@centos8 ~]#umount /data/mysql
[root@centos8 ~]#resize2fs /dev/vg0/mysql 1G
resize2fs 1.44.6 (5-Mar-2019)
Please run <span style="color: #8b2252;">'e2fsck -f /dev/vg0/mysql'</span> first.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#20108;&#27493;</span>
[root@centos8 ~]#fsck -f /dev/vg0/mysql
fsck from util-linux 2.32.1
e2fsck 1.44.6 (5-Mar-2019)
Pass 1: Checking inodes, blocks, and sizes
Pass 2: Checking directory structure
Pass 3: Checking directory connectivity
Pass 4: Checking reference counts
Pass 5: Checking group summary information
/dev/mapper/vg0-mysql: 14/196224 files (0.0% non-contiguous), 31009/784384 blocks

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#19977;&#27493;</span>
[root@centos8 ~]#resize2fs /dev/vg0/mysql 1G
resize2fs 1.44.6 (5-Mar-2019)
Resizing the filesystem on /dev/vg0/mysql to 262144 (4k) blocks.
The filesystem on /dev/vg0/mysql is now 262144 (4k) blocks long.

[root@centos8 ~]#lvs
LV  VG Attr    LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert
mysql vg0 -wi-a----- 2.99g                          
[root@centos8 ~]#df
Filesystem   1K-blocks  Used Available Use% Mounted on
devtmpfs      391676    0   391676  0% /dev
tmpfs       408092    0   408092  0% /dev/shm
tmpfs       408092   5792   402300  2% /run
tmpfs       408092    0   408092  0% /sys/fs/cgroup
/dev/sda2    104806400 2274504 102531896  3% /
/dev/sda3    52403200  398576  52004624  1% /data
/dev/sda1     999320  130848   799660  15% /boot
tmpfs        81616    0   81616  0% /run/user/0
[root@centos8 ~]#mount -a

[root@centos8 ~]#df -h
Filesystem       Size Used Avail Use% Mounted on
/dev/mapper/vg0-mysql 944M  7.5M 870M  1% /data/mysql
[root@centos8 ~]#lvs
LV  VG Attr    LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert
mysql vg0 -wi-ao---- 2.99g                          
[root@centos8 ~]#umount /data/mysql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#22235;&#27493;</span>
[root@centos8 ~]#lvreduce -L 1G /dev/vg0/mysql
WARNING: Reducing active logical volume to 1.00 GiB.
THIS MAY DESTROY YOUR DATA (filesystem etc.)
Do you really want to reduce vg0/mysql? [y/n]: y
Size of logical volume vg0/mysql changed from 2.99 GiB (766 extents) to 1.00
<span style="color: #0000ff;">GiB</span> (256 extents).
Logical volume vg0/mysql successfully resized.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#20116;&#27493;&#65292;&#25346;&#36733;&#22238;&#21435;</span>
[root@centos8 ~]#mount -a
[root@centos8 ~]#lvs
LV  VG Attr    LSize Pool Origin Data% Meta% Move Log Cpy%Sync Convert
mysql vg0 -wi-ao---- 1.00g                          
[root@centos8 ~]#df -h
Filesystem       Size Used Avail Use% Mounted on
devtmpfs        383M   0 383M  0% /dev
tmpfs         399M   0 399M  0% /dev/shm
tmpfs         399M  5.7M 393M  2% /run
tmpfs         399M   0 399M  0% /sys/fs/cgroup
/dev/sda2       100G  2.2G  98G  3% /
/dev/sda3        50G 390M  50G  1% /data
/dev/sda1       976M 128M 781M  15% /boot
tmpfs          80M   0  80M  0% /run/user/0
/dev/mapper/vg0-mysql 944M  7.5M 870M  1% /data/mysql
</pre>
</div>

<p>
范例：拆除硬盘，数据迁移
</p>
<div class="org-src-container">
<pre class="src src-shell">vgdisplay <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#21097;&#20313;&#31354;&#38388;&#26159;&#21542;&#22815;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#29289;&#29702;&#21367;&#19978;&#31354;&#38388;&#25968;&#25454;&#36801;&#31227;&#21040;&#20854;&#20182;&#25104;&#21592;&#20013;</span>
pvmove /dev/sdc  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#36801;&#31227;&#65292;&#31561;&#24453;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;</span>
pvs

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31227;&#38500;&#29289;&#29702;&#21367;</span>
vgreduce vg0 /dev/sdc
pvremove /dev/sdc
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:4e31819a-fb68-4c57-bc13-556936e150c5" class="outline-4">
<h4 id="h:4e31819a-fb68-4c57-bc13-556936e150c5">跨主机迁移卷组</h4>
<div class="outline-text-4" id="text-h:4e31819a-fb68-4c57-bc13-556936e150c5">
<p>
源计算机上 1 在旧系统中，umount所有卷组上的逻辑卷 2 禁用卷组
</p>

<div class="org-src-container">
<pre class="src src-sh">vgchange &#8211;a n vg0
lvdisplay
</pre>
</div>

<p>
3 导出卷组
</p>

<div class="org-src-container">
<pre class="src src-sh">vgexport vg0
pvscan
vgdisplay
</pre>
</div>

<p>
4 拆下旧硬盘在目标计算机上,并导入卷组：
</p>

<div class="org-src-container">
<pre class="src src-sh">vgimport vg0
</pre>
</div>

<p>
5 启用
</p>

<div class="org-src-container">
<pre class="src src-sh">vgchange &#8211;ay vg0 
</pre>
</div>

<p>
6 mount 所有卷组上的逻辑卷
</p>
</div>
</div>
</div>
<div id="outline-container-h:c901eab5-6c8d-4d6b-badb-561747abb038" class="outline-3">
<h3 id="h:c901eab5-6c8d-4d6b-badb-561747abb038">逻辑卷快照</h3>
<div class="outline-text-3" id="text-h:c901eab5-6c8d-4d6b-badb-561747abb038">
</div>
<div id="outline-container-h:15b6fce9-8786-45f6-9277-d3df139d65e6" class="outline-4">
<h4 id="h:15b6fce9-8786-45f6-9277-d3df139d65e6">逻辑卷快照原理</h4>
<div class="outline-text-4" id="text-h:15b6fce9-8786-45f6-9277-d3df139d65e6">

<figure id="org2d597d5">
<img src="images/image-20210216021152346.png" alt="image-20210216021152346.png" width="60%">

</figure>

<p>
快照是特殊的逻辑卷，它是在生成快照时存在的逻辑卷的准确拷贝,对于需要备
份或者复制的现有数据临时拷贝以及其它操作来说，快照是最合适的选择,快照
只有在它们和原来的逻辑卷不同时才会消耗空间，建立快照的卷大小小于等于原
始逻辑卷,也可以使用lvextend扩展快照
</p>

<p>
逻辑卷管理器快照
</p>

<p>
快照就是将当时的系统信息记录下来，就好像照相一般，若将来有任何数据改动
了，则原始数据会被移动到快照区，没有改动的区域则由快照区和文件系统共享
</p>

<p>
逻辑卷快照工作原理
</p>

<ul class="org-ul">
<li>在生成快照时会分配给它一定的空间，但只有在原来的逻辑卷或者快照有所改变才会使用这些空间</li>
<li>当原来的逻辑卷中有所改变时，会将旧的数据复制到快照中</li>
<li>快照中只含有原来的逻辑卷中更改的数据或者自生成快照后的快照中更改的数据</li>
</ul>

<p>
由于快照区与原本的LV共用很多PE的区块，因此快照与被快照的LV必须在同一个
VG中.系统恢复的时候的文件数量不能高于快照区的实际容量
</p>

<p>
快照特点：
</p>

<ul class="org-ul">
<li>备份速度快，瞬间完</li>
<li>应用场景是测试环境，不能完成代替备份</li>
<li>快照后，逻辑卷的修改速度会一定有影响</li>
</ul>
</div>
</div>
<div id="outline-container-h:049936f4-e103-4c0d-87f3-0b0d4da2d63b" class="outline-4">
<h4 id="h:049936f4-e103-4c0d-87f3-0b0d4da2d63b">实现逻辑卷快照</h4>
<div class="outline-text-4" id="text-h:049936f4-e103-4c0d-87f3-0b0d4da2d63b">
<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">mkfs.xfs /dev/vg0/data
mount /dev/vg0/data/ /mnt/data

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#29616;&#26377;&#36923;&#36753;&#21367;&#21019;&#24314;&#24555;&#29031;&#65292;&#27880;&#24847;ext4&#24314;&#35758;&#20351;&#29992;-p r &#23454;&#29616;&#21482;&#35835;</span>
lvcreate -l 64 -s -n data-snapshot /dev/vg0/data
<span style="color: #b22222;">#</span><span style="color: #b22222;">lvcreate -l 64 -s -n data-snapshot -p r -L 10G /dev/vg0/data</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25346;&#36733;&#24555;&#29031;, xfs&#27880;&#24847;&#35201;&#20351;&#29992;-o ro&#23454;&#29616;&#21482;&#35835;&#65292;&#38450;&#27490;&#24555;&#29031;&#34987;&#20462;&#25913;</span>
mkdir  -p /mnt/snap
mount -o ro,nouuid /dev/vg0/data-snapshot  /mnt/snap

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24674;&#22797;&#24555;&#29031;</span>
umount /dev/vg0/data-snapshot
umount /dev/vg0/data
lvconvert --merge /dev/vg0/data-snapshot
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#24555;&#29031;</span>
umount /mnt/databackup
lvremove /dev/vg0/databackup
</pre>
</div>

<p>
练习
</p>
<ul class="org-ul">
<li>创建一个至少有两个PV组成的大小为20G的名为testvg的VG；要求PE大小为16MB,</li>
<li>在卷组中创建大小为5G的逻辑卷testlv；挂载至/users目录 2、</li>
<li>用户archlinux，要求其家目录为/users/archlinux，而后su切换至archlinux用户，复制/etc/pam.d目录至自己的家目录</li>
<li>扩展testlv至7G，要求archlinux用户的文件不能丢失</li>
<li>收缩testlv至3G，要求archlinux用户的文件不能丢失</li>
<li>对testlv创建快照，并尝试基于快照备份数据，验证快照的功能</li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-h:9ee48b0c-52c9-4385-92c6-7e4a21bf4d47" class="outline-2">
<h2 id="h:9ee48b0c-52c9-4385-92c6-7e4a21bf4d47">btrfs文件系统管理与应用</h2>
<div class="outline-text-2" id="text-h:9ee48b0c-52c9-4385-92c6-7e4a21bf4d47">
<p>
在 centos7 上叫做技术预览版。在有些企业中已经开始尝试使用了。
</p>
</div>
<div id="outline-container-h:43f03ce8-5345-4d1c-8687-d5f1e2f6a356" class="outline-3">
<h3 id="h:43f03ce8-5345-4d1c-8687-d5f1e2f6a356">Btrfs文件系统简介</h3>
<div class="outline-text-3" id="text-h:43f03ce8-5345-4d1c-8687-d5f1e2f6a356">
<p>
Btrfs透明压缩文件系统 (B-tree, Butter FS, Better FS)是一种
COW(copy-on-write式)文件系统，有着传统文件系统(ext3/4)所没有的一些特性，
如支持可写的磁盘快照(snapshots)，以及支持递归的快照(snapshots of
snapshots)，支持内建磁盘阵列（RAID），支持子卷(Subvolumes)的概念，允许
在线调整文件系统大小等。
</p>

<p>
Oracle 从 2007 年前后开始研发。最重要的特性是支持COW(copy-on-write式写
时复制)机制，比就地修改文件系统有着极大的好处。主要取代ext3/ext4，但在
centos 6 上已经有了 xfs
</p>
</div>
</div>
<div id="outline-container-h:ca088b3f-f2ba-4c18-9a66-0efc6c7174ea" class="outline-3">
<h3 id="h:ca088b3f-f2ba-4c18-9a66-0efc6c7174ea">核心特性</h3>
<div class="outline-text-3" id="text-h:ca088b3f-f2ba-4c18-9a66-0efc6c7174ea">
<p>
核心特性：
</p>

<ul class="org-ul">
<li>多物理卷至支持；btrfs可由多个底层物理卷组成；支持RAID,以及联机"添加"、"移除"，"修改"；</li>
<li>写时复制更新机制(CoW)：复制、更新及替换指针，而非就地更新；文件修改
创建复制份，路径指向复制文件，还原时指向原来文件上；</li>
<li>数据及元数据校验码机制；checksum</li>
<li>支持子卷：sub_volume，子卷实质上是一个保存文件和目录的命名的B树。它
们的inode保存在树根之树中，可以为非根用户和组所有。子卷可选设定块配
额。子卷内的所有块和文件区段都有引用计数以便做快照。和虚拟机存储的动
态扩展相似，其只按需使用设备空间，消除了许多半满的分区。用户也可用不
同的挂载选项挂载子卷，得到更灵活的安全性。</li>
<li>快照：支持快照的快照；命令：btrfs subvolume snapshot</li>
<li>透明压缩机制：传输数据自动压缩，读取时自动解压缩，不仅减小了文件的大
小，还提高了性能。</li>
<li>Btrfs支持在线碎片整理。命令： btrfs filesystem defragment</li>
</ul>

<p>
注意: 在同一个磁盘上不同分区组成一个 btrfs 文件系统并无特殊意义。建议
使用多块硬盘组成 b-TREE 文件系统。
</p>
</div>
</div>
<div id="outline-container-h:ac5edb5c-f06c-41ec-afe1-aa64e5291c77" class="outline-3">
<h3 id="h:ac5edb5c-f06c-41ec-afe1-aa64e5291c77">创建 b-tree 文件系统</h3>
<div class="outline-text-3" id="text-h:ac5edb5c-f06c-41ec-afe1-aa64e5291c77">
<p>
<b>mkfs.btrfs 命令，文件系统创建：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">-L <span style="color: #8b2252;">'LABEL'</span> : &#25351;&#23450;&#21367;&#26631;
-D
-m &lt;profile&gt; : &#35774;&#32622;&#20803;&#25968;&#25454;&#23646;&#24615;&#65292;&#21487;&#20197;&#22522;&#20110;raid0,raid1,raid5,raid6,raid10,single,dup &#21019;&#24314;&#20803;&#25968;&#25454;
-d &lt;type&gt; : &#26126;&#25968;&#25454;&#26159;&#22914;&#20309;&#36328;&#22810;&#35774;&#22791;&#23384;&#25918;&#30340;&#31867;&#22411;raid0,raid1,raid5,raid6,raid10,single(&#21482;&#23384;&#21333;&#20221;)
-O &lt;feature&gt;  : &#25351;&#26126;&#22312;&#26684;&#24335;&#26102;&#25903;&#25345;&#30340;&#23646;&#24615;
    -O list-all&#65306;&#21015;&#20986;&#25903;&#25345;&#30340;feature
</pre>
</div>

<p>
演示：添加 3 块物理磁盘 sdb, sdc, sdd 并做成 b-tree 文件系统
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl set-defaul multi-user.target &#19981;&#21551;&#21160;&#22270;&#24418;&#30028;&#38754;

[root@node01 ~]# lsblk
NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sdb               8:16   0   20G  0 disk
sdc               8:32   0   20G  0 disk
sdd               8:48   0   20G  0 disk

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558; /dev/sdb , /dev/sdc &#20004;&#20010;&#35774;&#22791;&#20570;&#25104; b-tree &#25991;&#20214;&#31995;&#32479;</span>
[root@node01 ~]# mkfs.btrfs -L mydata /dev/sdb /dev/sdc
btrfs-progs v4.9.1
Label:              mydata  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21367;&#26631;</span>
UUID:               ec5cff63-8a4f-4bce-8eb4-4bb64f85e4a7
Node size:          16384
Sector size:        4096
Filesystem size:    40.00GiB  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24635;&#31354;&#38388;&#22823;&#23567;</span>
Block group profiles:
  Data:             RAID0             2.00GiB
  Metadata:         RAID1             1.00GiB
  System:           RAID1             8.00MiB
SSD detected:       no
Incompat features:  extref, skinny-metadata
Number of devices:  2
Devices:
   ID        SIZE  PATH
    1    20.00GiB  /dev/sdb
    2    20.00GiB  /dev/sdc
</pre>
</div>

<p>
<b>显示btr文件系统 btrfs filesystem show</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# btrfs filesystem show
Label: <span style="color: #8b2252;">'mydata'</span>  uuid: ec5cff63-8a4f-4bce-8eb4-4bb64f85e4a7
    Total devices 2 FS bytes used 112.00KiB
    devid    1 size 20.00GiB used 2.01GiB path /dev/sdb
    devid    2 size 20.00GiB used 2.01GiB path /dev/sdc
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992; blkid &#21457;&#29616; /dev/sdb, /dev/sdc &#23646;&#20110;&#21516;&#19968;&#20010;&#21367;&#65292;&#20294;&#23376;&#21367;&#30340; UUID &#19981;&#19968;&#21516;</span>
[root@node01 ~]# blkid /dev/sdb
/dev/sdb: <span style="color: #a0522d;">LABEL</span>=<span style="color: #8b2252;">"mydata"</span> <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"ec5cff63-8a4f-4bce-8eb4-4bb64f85e4a7"</span> <span style="color: #a0522d;">UUID_SUB</span>=<span style="color: #8b2252;">"92ee4816-2fa6-4f5d-a4b5-0158af186c06"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"btrfs"</span>
[root@node01 ~]# blkid /dev/sdc
/dev/sdc: <span style="color: #a0522d;">LABEL</span>=<span style="color: #8b2252;">"mydata"</span> <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"ec5cff63-8a4f-4bce-8eb4-4bb64f85e4a7"</span> <span style="color: #a0522d;">UUID_SUB</span>=<span style="color: #8b2252;">"2267dd05-989b-438f-a9f3-cf1e736f90bf"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"btrfs"</span>
</pre>
</div>

<p>
<b>挂载，挂载任何一个都可以</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# mkdir /mydata
[root@node01 ~]# mount -t btrfs /dev/sdb /mydata/   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25346;&#36733;&#20219;&#20309;&#19968;&#20010; btrfs &#21367;&#23601;&#34892;&#12290;#&#21482;&#35201;blkid&#33021;&#35782;&#21035;&#65292;&#23601;&#19981;&#29992;-t btrfs&#25351;&#23450;&#20102;</span>
[root@node01 ~]# mount
/dev/sdb on /mydata type btrfs (rw,relatime,space_cache,<span style="color: #a0522d;">subvolid</span>=5,<span style="color: #a0522d;">subvol</span>=/)
[root@node01 ~]# df -h
/dev/sdb                  40G   17M   38G   1% /mydata
</pre>
</div>

<p>
<b>透明压缩机制：</b>
</p>

<p>
命令：mount -o compress={lzo|zlib} DEVICE MOUNT_POINT
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# umount /dev/sdb
[root@node01 ~]# mount -o <span style="color: #a0522d;">compress</span>=lzo /dev/sdb /mydata/
[root@node01 ~]# cp /etc/rc.d/init.d/functions  /mydata/
[root@node01 ~]# ll /mydata/
-rw-r--r-- 1 root root 17500 Apr 28 09:40 functions
</pre>
</div>

<p>
这种压缩解压缩是自动的，用户是看不到的。
</p>
</div>
</div>
<div id="outline-container-h:35b34bd7-8e74-4621-9c36-a592c768c00e" class="outline-3">
<h3 id="h:35b34bd7-8e74-4621-9c36-a592c768c00e">btrfs 文件系统命令</h3>
<div class="outline-text-3" id="text-h:35b34bd7-8e74-4621-9c36-a592c768c00e">
<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# btrfs
btrfs               btrfs-convert       btrfs-find-root     btrfs-map-logical   btrfstune           
btrfsck             btrfs-debug-tree    btrfs-image         btrfs-select-super  btrfs-zero-log
</pre>
</div>

<p>
统一命令工具btrfs，将多个命令合并了。
</p>

<ul class="org-ul">
<li>btrfs-convert  动态转换文件系统</li>
<li>btrfsck  文件系统检测</li>
</ul>

<p>
帮助手册 man btrfs
</p>

<p>
<b>btrfs filesystem&lt; subcommand&gt; &lt;args&gt; 文件系统相关</b>
</p>

<ol class="org-ol">
<li><p>
属性查看： btrfs filesystem show [options] [&lt;path&gt;|&lt;uuid&gt;|&lt;device&gt;|label]
</p>

<p>
帮助手册 man btrfs-filesystem
</p>

<p>
-m| &#x2013;mounted : 查看当前文件系统挂载情况. 如，[root@node01 ~]# btrfs filesystem show -m
</p></li>

<li>查看已挂载文件系统空间使用情况：btrfs filesystem df [options] &lt;path&gt;</li>

<li>同步：btrfs filesystem sync &lt;path&gt;</li>

<li>磁盘碎片整理：btrfs filesystem defragment [options] &lt;file&gt;|&lt;dir&gt; [&lt;file&gt;|&lt;dir&gt;&#x2026;]</li>

<li><p>
动态调整大小 ：btrfs filesystem resize [devid:][+/-]&lt;newsize&gt;[kKmMgGtTpPeE]|[devid:]max &lt;path&gt;
</p>

<p>
必须挂载完后调整大小
</p>

<p>
直接调整为最大 [root@node01 ~]# btrfs filesystem resize max /mydata
</p></li>

<li><p>
指明或显示卷标 btrfs filesystem label [&lt;dev&gt;|&lt;mountpoint&gt;] [&lt;newlabel&gt;]
如
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# btrfs filesystem label /dev/sdb 
mydata
</pre>
</div></li>
</ol>


<p>
<b>btrfs device &lt;subcommand&gt; &lt;args&gt; 设备相关</b>
</p>

<p>
手册btrfs-device
</p>

<ol class="org-ol">
<li><code>btrfs device add [-Kf] &lt;dev&gt; [&lt;dev&gt;...] &lt;path&gt;</code>  新增设备</li>
</ol>

<p>
会自动添加自动执行扩展，但数据没有均衡到新设备上，这时就需要使用 btrfs balance 命令
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# btrfs device add /dev/sdd  /mydata
[root@node01 ~]# df -lh
/dev/sdb                  60G   18M   56G   1% /mydata
</pre>
</div>


<ol class="org-ol">
<li>btrfs device delete &lt;dev&gt;|&lt;devid&gt; [&lt;dev&gt;|&lt;devid&gt;&#x2026;] &lt;path&gt;  移除设备</li>
</ol>
<p>
会自动行动设备上的数据到其它设备上。
</p>

<p>
如，[root@node01 ~]# btrfs device delete /dev/sdb /mydata
</p>

<ol class="org-ol">
<li>btrfs device scan [(&#x2013;all-devices|-d)|&lt;device&gt; [&lt;device&gt;&#x2026;]]  扫描设备</li>

<li>btrfs device  ready &lt;device&gt; 转为备用状态</li>

<li>btrfs device stats [options] &lt;path&gt;|&lt;device&gt;  显示 IO 统计数据</li>
</ol>


<p>
<b>btrfs balance &lt;subcommand&gt; &lt;args&gt;  数据平衡</b>
</p>

<ol class="org-ol">
<li>btrfs balance start [options] &lt;path&gt;  在线实现块移动</li>
</ol>

<div class="org-src-container">
<pre class="src src-sh">&#23376;&#21629;&#20196;
-d[&lt;filters&gt;]  &#20462;&#25913;&#25968;&#25454;&#30340;&#32452;&#32455;&#26426;&#21046;
-m[&lt;filters&gt;] &#20462;&#25913;&#20803;&#25968;&#25454;&#32452;&#32455;&#26426;&#21046;
-s[&lt;filters&gt;]  &#20462;&#25913;&#31995;&#32479;&#30340;&#32452;&#32455;&#26426;&#21046;
Profile names, used<span style="color: #a020f0;"> in</span> profiles and convert are one of: raid0, raid1, raid10, raid5, raid6, dup, single
</pre>
</div>

<ol class="org-ol">
<li>btrfs balance pause &lt;path&gt;  暂停</li>

<li>btrfs balance cancel &lt;path&gt; 取消</li>

<li>btrfs balance resume &lt;path&gt; 继续</li>

<li>btrfs balance status [-v] &lt;path&gt; 显示状态</li>
</ol>

<p>
<b>管理子卷和快照命令 btrfs subvolume&lt; subcommand&gt; [&lt;args&gt;]</b>
</p>

<p>
手册 man btrfs-subvolume
</p>

<p>
A subvolume in btrfs can be accessed in two ways:
</p>

<ul class="org-ul">
<li>like any other directory that is accessible to the user</li>
<li>like a separately mounted filesystem (options subvol or subvolid)</li>
</ul>

<p>
子卷下的文件都可以通过父卷访问到
</p>

<ol class="org-ol">
<li><p>
btrfs subvolume create [-i &lt;qgroupid&gt;] [&lt;dest&gt;/]&lt;name&gt; 创建子卷
</p>

<p>
如在mydata 卷下创建logs子卷，[root@node01 ~]# btrfs subvolume create /mydata/logs
</p>

<p>
挂载时使用subvol subvolid 挂载，如 mount -o subvol=logs /dev/sdb /mnt  或  mount -o subvolid=264 /dev/sdb /mnt  
</p>

<p>
mount -o subvol=logs /dev/sdb /mnt/log &#x2013;mkdir
</p></li>

<li>btrfs subvolume delete [options] &lt;subvolume&gt; [&lt;subvolume&gt;&#x2026;] 删除子卷</li>

<li>btrfs subvolume list [options] [-G [+|-]&lt;value&gt;] [-C [+|-]&lt;value&gt;] [&#x2013;sort=rootid,gen,ogen,path] &lt;path&gt; 列出所有子卷</li>

<li>btrfs subvolume snapshot [-r] &lt;source&gt; &lt;dest&gt;|[&lt;dest&gt;/]&lt;name&gt;  做快照快照卷必须与原卷在一个卷组中</li>

<li>btrfs subvolume  get-default &lt;path&gt; 查看默认卷</li>

<li>btrfs subvolume set-default &lt;id&gt; &lt;path&gt; 设置默认卷</li>

<li>btrfs subvolume show &lt;path&gt; 查看子卷信息</li>
</ol>
</div>
</div>
<div id="outline-container-h:16e27007-cf1d-4a6e-a182-4803dd8b7236" class="outline-3">
<h3 id="h:16e27007-cf1d-4a6e-a182-4803dd8b7236">设备管理命令</h3>
<div class="outline-text-3" id="text-h:16e27007-cf1d-4a6e-a182-4803dd8b7236">
<p>
命令：btrfs device&lt; subcommand&gt; &lt;args&gt;
</p>
</div>
</div>
<div id="outline-container-h:464f5498-d025-4bcc-a4d4-a7ebb7d1567d" class="outline-3">
<h3 id="h:464f5498-d025-4bcc-a4d4-a7ebb7d1567d">块组均衡管理</h3>
<div class="outline-text-3" id="text-h:464f5498-d025-4bcc-a4d4-a7ebb7d1567d">
<p>
命令：btrfs [filesystem] balance &lt;subcommand&gt;|&lt;args&gt;
</p>

<p>
btrfs scrub 用来擦除数据
</p>

<p>
btrfs rescue 紧急救援
</p>

<p>
btrfs restore 修复模式
</p>

<p>
范例： 动态调整大小 ：btrfs filesystem resize [devid:][+/-]&lt;newsize&gt;[kKmMgGtTpPeE]|[devid:]max &lt;path&gt;
</p>

<p>
必须挂载完后调整大小
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# btrfs filesystem show /mydata
[root@node01 ~]# btrfs filesystem resize -10G /mydata
Resize <span style="color: #8b2252;">'/mydata'</span> of <span style="color: #8b2252;">'-10G'</span>
[root@node01 ~]# df -h   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#21040;&#21407;&#26412; 40G &#21464;&#25104;&#20102; 30G</span>
/dev/sdb                  30G   18M   18G   1% /mydata
[root@node01 ~]# btrfs filesystem resize +5G /mydata
Resize <span style="color: #8b2252;">'/mydata'</span> of <span style="color: #8b2252;">'+5G'</span>
[root@node01 ~]# df -h
/dev/sdb                  35G   18M   28G   1% /mydata
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#30495;&#27491;&#30340;&#21487;&#29992;&#31354;&#38388;&#20351;&#29992; btrfs &#33258;&#24102;&#30340; df &#21629;&#20196;</span>
[root@node01 ~]# btrfs filesystem df /mydata
Data, RAID0: <span style="color: #a0522d;">total</span>=2.00GiB, <span style="color: #a0522d;">used</span>=780.00KiB
System, RAID1: <span style="color: #a0522d;">total</span>=8.00MiB, <span style="color: #a0522d;">used</span>=16.00KiB
Metadata, RAID1: <span style="color: #a0522d;">total</span>=1.00GiB, <span style="color: #a0522d;">used</span>=112.00KiB
GlobalReserve, single: <span style="color: #a0522d;">total</span>=16.00MiB, <span style="color: #a0522d;">used</span>=0.00B
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#30452;&#25509;&#35843;&#25972;&#20026;&#26368;&#22823;</span>
[root@node01 ~]# btrfs filesystem resize max /mydata

[root@node01 ~]# btrfs filesystem usage -h /mydata
Overall:
    Device size:          40.00GiB
    Device allocated:           4.02GiB
    Device unallocated:          35.98GiB
    Device missing:             0.00B
    Used:               1.01MiB
    Free (estimated):          37.98GiB    (min: 19.99GiB)
    Data ratio:                  1.00
    Metadata ratio:              2.00
    Global reserve:          16.00MiB    (used: 0.00B)

Data,RAID0: Size:2.00GiB, Used:780.00KiB
   /dev/sdb       1.00GiB
   /dev/sdc       1.00GiB

Metadata,RAID1: Size:1.00GiB, Used:112.00KiB
   /dev/sdb       1.00GiB
   /dev/sdc       1.00GiB

System,RAID1: Size:8.00MiB, Used:16.00KiB
   /dev/sdb       8.00MiB
   /dev/sdc       8.00MiB

Unallocated:
   /dev/sdb      17.99GiB
   /dev/sdc      17.99GiB
</pre>
</div>


<p>
范例：  btrfs device add [-Kf] &lt;dev&gt; [&lt;dev&gt;&#x2026;] &lt;path&gt;  新增设备
</p>

<p>
会自动添加自动执行扩展，但数据没有均衡到新设备上，这时就需要使用 btrfs balance 命令
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# btrfs device add /dev/sdd  /mydata
[root@node01 ~]# df -lh
/dev/sdb                  60G   18M   56G   1% /mydata
[root@node01 ~]# btrfs balance start /mydata
WARNING:

    Full balance without filters requested. This operation is very
    intense and takes potentially very long. It is recommended to
    use the balance filters to narrow down the balanced data.
    Use <span style="color: #8b2252;">'btrfs balance start --full-balance'</span> option to skip this
    warning. The operation will start<span style="color: #a020f0;"> in</span> 10 seconds.
</pre>
</div>


<p>
范例 btrfs device delete &lt;dev&gt;|&lt;devid&gt; [&lt;dev&gt;|&lt;devid&gt;&#x2026;] &lt;path&gt;  移除设备
</p>

<p>
会自动行动设备上的数据到其它设备上。
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# btrfs device delete /dev/sdb /mydata
[root@node01 ~]# df -lh
/dev/sdc                  40G   18M   38G   1% /mydata
[root@node01 ~]# btrfs filesystem show /mydata
Label: <span style="color: #8b2252;">'mydata'</span>  uuid: ec5cff63-8a4f-4bce-8eb4-4bb64f85e4a7
    Total devices 2 FS bytes used 908.00KiB
    devid    2 size 20.00GiB used 2.03GiB path /dev/sdc
    devid    3 size 20.00GiB used 2.03GiB path /dev/sdd
</pre>
</div>

<p>
范例  btrfs balance start [options] &lt;path&gt;  在线实现块移动，并修改数据的组织机制为 raid5 
</p>

<p>
子命令
-d[&lt;filters&gt;]  修改数据的组织机制
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# btrfs device  add /dev/sdb /mydata
[root@node01 ~]# btrfs balance start /mydata
[root@node01 ~]# btrfs filesystem show /mydata
    devid    2 size 20.00GiB used 1.03GiB path /dev/sdc
    devid    3 size 20.00GiB used 2.00GiB path /dev/sdd
    devid    4 size 20.00GiB used 2.03GiB path /dev/sdb
[root@node01 ~]# btrfs balance start -dconvert=raid5 /mydata
Done, had to relocate 1 out of 3 chunks
</pre>
</div>


<p>
范例 如在mydata 卷下创建子卷并挂载子卷到 /mnt 下，btrfs subvolume create [-i &lt;qgroupid&gt;] [&lt;dest&gt;/]&lt;name&gt; 创建子卷
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# btrfs subvolume show /mydata
[root@node01 ~]# btrfs subvolume create /mydata/logs
Create subvolume <span style="color: #8b2252;">'/mydata/logs'</span>
[root@node01 ~]# btrfs subvolume show /mydata
/mydata
    Name:             &lt;FS_TREE&gt;
    UUID:             -
    Parent UUID:         -
    Received UUID:         -
    Creation time:         -
    Subvolume ID:         5
    Generation:         86
    Gen at creation:     0
    Parent ID:         0
    Top level ID:         0
    Flags:             -
    Snapshot(s):
                logs
[root@node01 ~]# btrfs subvolume list /mydata  
ID 264 gen 86 top level 5 path logs
&#21487;&#20197;&#30475;&#21040; logs &#23376;&#21367;&#23545;&#24212;&#30340; id &#21495;&#20026;264

[root@node01 ~]# btrfs subvolume create /mydata/cache
[root@node01 ~]# btrfs subvolume list /mydata
ID 264 gen 86 top level 5 path logs
ID 265 gen 87 top level 5 path cache

&#25346;&#36733;&#23376;&#21367;
[root@node01 ~]# umount /mydata
[root@node01 ~]# mount -o <span style="color: #a0522d;">subvol</span>=logs /dev/sdb /mnt
[root@node01 ~]# ls /mnt
[root@node01 ~]# cp /var/log/messages /mnt
[root@node01 ~]# ls /mnt/
messages
[root@node01 ~]# btrfs subvolume show /mnt
/mnt
    Name:             logs
    UUID:             e684c81d-c907-b841-895a-08ce66f3ea0f
    Parent UUID:         -
    Received UUID:         -
    Creation time:         2018-05-07 07:01:23 +0800
    Subvolume ID:         264
    Generation:         89
    Gen at creation:     86
    Parent ID:         5
    Top level ID:         5
    Flags:             -
    Snapshot(s):
&#23376;&#21367;&#19979;&#30340;&#25991;&#20214;&#37117;&#21487;&#20197;&#36890;&#36807;&#29238;&#21367;&#35775;&#38382;&#21040;
[root@node01 ~]# umount  /mnt
[root@node01 ~]# mount /dev/sdb /mydata
[root@node01 ~]# ls /mydata/logs
messages
&#21024;&#38500;&#23376;&#21367;
[root@node01 ~]# btrfs subvolume delete /mydata/logs
[root@node01 ~]# btrfs subvolume list /mydata/
ID 265 gen 87 top level 5 path cache
</pre>
</div>

<p>
演示6  创建子卷快照 btrfs subvolume snapshot [-r] &lt;source&gt; &lt;dest&gt;|[&lt;dest&gt;/]&lt;name&gt;  做快照
</p>

<p>
快照卷必须与原卷在一个卷组中
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# btrfs subvolume create /mydata/logs
[root@node01 ~]# cp /etc/grub2.cfg  /mydata/logs/
[root@node01 ~]# btrfs subvolume snapshot /mydata/logs /mydata/logs_snapshot
[root@node01 ~]# btrfs subvolume list /mydata/logs
ID 265 gen 87 top level 5 path cache
ID 266 gen 95 top level 5 path logs
ID 267 gen 95 top level 5 path logs_snapshot
[root@node01 ~]# btrfs subvolume delete /mydata/logs_snapshot
cp &#21629;&#20196;&#21487;&#20197;&#21333;&#29420;&#20026;&#25991;&#20214;&#21019;&#24314;&#24555;&#29031;
[root@node01 logs]# cp --reflink=auto grub2.cfg grub2.cfg_snap
[root@node01 logs]# vim  grub2.cfg
[root@node01 logs]# vim grub2.cfg_snap
</pre>
</div>


<p>
范例 ext4 文件系统转换为 btrfs 系统
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]# btrfs balance start -dconvert=single -mconvert=raid1 /mydata
&#25286;&#38500;&#19968;&#20010;&#35774;&#22791;&#24182;&#36716;&#25442;&#20026;ext4 &#31995;&#32479;
[root@node01 ~]# btrfs device delete /dev/sdd /mydata
[root@node01 ~]# fdisk  /dev/sdd
<span style="color: #0000ff;">Command</span> (m for help): n
<span style="color: #0000ff;">Select</span> (default p): p
Partition number (1-4, default 1):
First sector (2048-41943039, default 2048):
Last sector, +sectors or +size{K,M,G} (2048-41943039, default 41943039):
<span style="color: #0000ff;">Command</span> (m for help): w   
[root@node01 ~]# mke2fs -t ext4 /dev/sdd1
[root@node01 ~]#  mount /dev/sdd1 /mnt
[root@node01 ~]# cp /etc/fstab  /mnt

&#36716;&#25442;&#20026; btrfs&#31995;&#32479;&#12288;
[root@node01 ~]# umount  /mnt
[root@node01 ~]# fsck -f /dev/sdd1
[root@node01 ~]# btrfs-convert  /dev/sdd1
conversion complete[root@node01 ~]# btrfs filesystem show
Label: <span style="color: #8b2252;">'mydata'</span>  uuid: ec5cff63-8a4f-4bce-8eb4-4bb64f85e4a7
    Total devices 2 FS bytes used 496.00KiB
    devid    2 size 20.00GiB used 1.28GiB path /dev/sdc
    devid    4 size 20.00GiB used 288.00MiB path /dev/sdb

Label: none  uuid: d0092458-52ea-4a27-be4f-4a47840fe0dd
    Total devices 1 FS bytes used 494.20MiB
    devid    1 size 20.00GiB used 808.29MiB path /dev/sdd1


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;btrfs&#25991;&#20214;&#31995;&#32479;&#22238;&#28378;&#21407;&#26469;&#30340;&#25991;&#20214;&#31995;&#32479;</span>
[root@node01 ~]# btrfs-convert  -r /dev/sdd1
[root@node01 ~]# blkid /dev/sdd1
/dev/sdd1: <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"a25e7670-2b48-4a69-a520-e9051e9dba99"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"ext4"</span>
</pre>
</div>



<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">1&#12289;&#21019;&#24314;btrfs&#25991;&#20214;&#31995;&#32479;
      &#22312;vmware&#20013;&#26032;&#22686;&#20004;&#22359;20G&#30913;&#30424;&#65292;/dev/sdb&#19982;/dev/sdc
[root@localhost ~]# mkfs.btrfs -L <span style="color: #8b2252;">'B-tree-fs'</span> -f /dev/sd{b,c}
[root@localhost ~]# btrfs filesystem show
Label: <span style="color: #8b2252;">'B-tree-fs'</span>  uuid: b254b565-0418-4601-8317-f9a5306c6f19
Total devices 2 FS bytes used 112.00KiB
devid    1 size 20.00GiB used 2.03GiB path /dev/sdb
devid    2 size 20.00GiB used 2.01GiB path /dev/sdc

2&#12289;&#25346;&#36733;&#25991;&#20214;&#31995;&#32479;
[root@localhost ~]# mkdir /btrdata
[root@localhost ~]# mount /dev/sdb /btrdata    
[root@localhost ~]# df -h | grep btrdata
/dev/sdb         40G  1.0M   38G   1% /btrdata

3&#12289;&#24314;&#31435;&#23376;&#21367;
[root@localhost ~]# btrfs subvolume create /btrdata/mydata
Create subvolume <span style="color: #8b2252;">'/btrdata/mydata'</span>
[root@localhost ~]# cp -r /root/* /btrdata/mydata    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22797;&#21046;&#25968;&#25454;</span>
[root@localhost ~]# btrfs filesystem show
Label: <span style="color: #8b2252;">'B-tree-fs'</span>  uuid: b254b565-0418-4601-8317-f9a5306c6f19
Total devices 2 FS bytes used 735.67MiB
devid    1 size 20.00GiB used 2.03GiB path /dev/sdb
devid    2 size 20.00GiB used 2.01GiB path /dev/sdc

4&#12289;&#25193;&#23637;&#25991;&#20214;&#31995;&#32479;
[root@localhost ~]# btrfs device add /dev/sdd /btrdata
[root@localhost ~]# btrfs filesystem show
Label: <span style="color: #8b2252;">'B-tree-fs'</span>  uuid: b254b565-0418-4601-8317-f9a5306c6f19
Total devices 3 FS bytes used 735.67MiB
devid    1 size 20.00GiB used 2.03GiB path /dev/sdb
devid    2 size 20.00GiB used 2.01GiB path /dev/sdc
devid    3 size 20.00GiB used 0.00 path /dev/sdd
[root@localhost ~]# df -h | grep btrdata
/dev/sdb         60G  772M   56G   2% /btrdata

5&#12289;&#37325;&#26032;&#22343;&#34913;&#25991;&#20214;&#31995;&#32479;
[root@localhost ~]# btrfs balance start /btrdata
Done, had to relocate 6 out of 6 chunks
[root@localhost ~]# btrfs filesystem show
Label: <span style="color: #8b2252;">'B-tree-fs'</span>  uuid: b254b565-0418-4601-8317-f9a5306c6f19
Total devices 3 FS bytes used 736.20MiB
devid    1 size 20.00GiB used 1.03GiB path /dev/sdb
devid    2 size 20.00GiB used 2.00GiB path /dev/sdc
devid    3 size 20.00GiB used 2.03GiB path /dev/sdd

6&#12289;&#31227;&#38500;&#30828;&#30424;
      &#31227;&#38500;&#30828;&#30424;&#30340;&#26102;&#20505;&#20250;&#20808;&#25226;&#25968;&#25454;&#31227;&#21160;&#21040;&#20854;&#20182;&#30424;&#65292;&#19981;&#38656;&#35201;&#20687;LVM&#37027;&#26679;&#38656;&#35201;&#25163;&#21160;&#31227;&#21160;&#25968;&#25454;
[root@localhost ~]# btrfs device delete /dev/sdb /btrdata
[root@localhost ~]# df -h | grep btrdata
/dev/sdc         40G  772M   38G   2% /btrdata
[root@localhost ~]# ls /btrdata/
commdir  mydata
[root@localhost ~]# head /btrdata/mydata/anaconda-ks.cfg
<span style="color: #b22222;">#</span><span style="color: #b22222;">version=RHEL7</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">System authorization information</span>
auth --enableshadow --passalgo=sha512

<span style="color: #b22222;"># </span><span style="color: #b22222;">Use CDROM installation media</span>
cdrom
<span style="color: #b22222;"># </span><span style="color: #b22222;">Use graphical install</span>
graphical
<span style="color: #b22222;"># </span><span style="color: #b22222;">Run the Setup Agent on first boot</span>
firstboot --enable

7&#12289;&#20462;&#25913;&#25968;&#25454;&#25110;&#20803;&#25968;&#25454;&#30340;RAID&#32423;&#21035;
[root@localhost ~]# btrfs device add /dev/sdb /btrdata
[root@localhost ~]# btrfs filesystem df /btrdata
Data, RAID0: <span style="color: #a0522d;">total</span>=2.00GiB, <span style="color: #a0522d;">used</span>=699.96MiB
System, RAID1: <span style="color: #a0522d;">total</span>=32.00MiB, <span style="color: #a0522d;">used</span>=16.00KiB
Metadata, RAID1: <span style="color: #a0522d;">total</span>=1.00GiB, <span style="color: #a0522d;">used</span>=35.98MiB
GlobalReserve, single: <span style="color: #a0522d;">total</span>=16.00MiB, <span style="color: #a0522d;">used</span>=0.00

[root@localhost ~]# btrfs balance start -mconvert=raid5 /btrdata    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27492;&#22788;&#20462;&#25913;&#20803;&#25968;&#25454;RAID&#32423;&#21035;</span>
Done, had to relocate 2 out of 3 chunks
[root@localhost ~]# btrfs filesystem df /btrdata
Data, RAID0: <span style="color: #a0522d;">total</span>=2.00GiB, <span style="color: #a0522d;">used</span>=700.21MiB
System, RAID5: <span style="color: #a0522d;">total</span>=64.00MiB, <span style="color: #a0522d;">used</span>=16.00KiB
Metadata, RAID5: <span style="color: #a0522d;">total</span>=1.00GiB, <span style="color: #a0522d;">used</span>=35.91MiB
GlobalReserve, single: <span style="color: #a0522d;">total</span>=16.00MiB, <span style="color: #a0522d;">used</span>=0.00
[root@localhost ~]# btrfs filesystem show
Label: <span style="color: #8b2252;">'B-tree-fs'</span>  uuid: b254b565-0418-4601-8317-f9a5306c6f19
Total devices 3 FS bytes used 735.89MiB
devid    2 size 20.00GiB used 1.53GiB path /dev/sdc
devid    3 size 20.00GiB used 1.53GiB path /dev/sdd
devid    4 size 20.00GiB used 544.00MiB path /dev/sdb

8&#12289;&#21019;&#24314;&#24555;&#29031;
[root@localhost ~]# btrfs subvolume snapshot /btrdata/mydata /btrdata/mydata_snapshot
Create a snapshot of <span style="color: #8b2252;">'/btrdata/mydata'</span><span style="color: #a020f0;"> in</span> <span style="color: #8b2252;">'/btrdata/mydata_snapshot'</span>
[root@localhost ~]# cat /btrdata/mydata/1.txt
1
[root@localhost ~]# echo <span style="color: #8b2252;">'just a test'</span> &gt;&gt; /btrdata/mydata/1.txt
[root@localhost ~]# cat /btrdata/mydata/1.txt
1
just a test
[root@localhost ~]# cat /btrdata/mydata_snapshot/1.txt
1
9&#12289;&#36716;&#25442;
[root@localhost ~]# btrfs balance start -dconvert=single -mconvert=raid1 /btrdata
Done, had to relocate 3 out of 3 chunks
[root@localhost ~]# btrfs device delete /dev/sdd /btrdata
[root@localhost ~]# fdisk /dev/sdd
Welcome to fdisk (util-linux 2.23.2).

Changes will remain<span style="color: #a020f0;"> in</span> memory only, until you decide to write them.
Be careful before using the write command.

Device does not contain a recognized partition table
Building a new DOS disklabel with disk identifier 0xadd41340.

<span style="color: #0000ff;">Command</span> (m for help): n
Partition type:
   p   primary (0 primary, 0 extended, 4 free)
   e   extended
<span style="color: #0000ff;">Select</span> (default p): p
Partition number (1-4, default 1): 1
First sector (2048-41943039, default 2048):
Using default value 2048
Last sector, +sectors or +size{K,M,G} (2048-41943039, default 41943039): +5G
Partition 1 of type Linux and of size 5 GiB is set

<span style="color: #0000ff;">Command</span> (m for help): w
The partition table has been altered!

Calling ioctl() to re-read partition table.
Syncing disks.
[root@localhost ~]# mke2fs -t ext4 /dev/sdd1
mke2fs 1.42.9 (28-Dec-2013)
Filesystem <span style="color: #a0522d;">label</span>=
OS type: Linux
Block <span style="color: #a0522d;">size</span>=4096 (<span style="color: #a0522d;">log</span>=2)
Fragment <span style="color: #a0522d;">size</span>=4096 (<span style="color: #a0522d;">log</span>=2)
<span style="color: #a0522d;">Stride</span>=0 blocks, Stripe <span style="color: #a0522d;">width</span>=0 blocks
327680 inodes, 1310720 blocks
65536 blocks (5.00%) reserved for the super user
First data <span style="color: #a0522d;">block</span>=0
Maximum filesystem <span style="color: #a0522d;">blocks</span>=1342177280
40 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks:
32768, 98304, 163840, 229376, 294912, 819200, 884736

Allocating group tables: done                           
Writing inode tables: done                           
Creating journal (32768 blocks): done
Writing superblocks and filesystem accounting information: done

[root@localhost ~]# fsck -f /dev/sdd1
fsck from util-linux 2.23.2
e2fsck 1.42.9 (28-Dec-2013)
Pass 1: Checking inodes, blocks, and sizes
Pass 2: Checking directory structure
Pass 3: Checking directory connectivity
Pass 4: Checking reference counts
Pass 5: Checking group summary information
/dev/sdd1: 12/327680 files (0.0% non-contiguous), 58463/1310720 blocks
[root@localhost ~]# btrfs-convert /dev/sdd1    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;ext4&#25991;&#20214;&#31995;&#32479;&#36716;&#25442;&#20026;btrfs</span>
creating btrfs metadata.
creating ext2fs image file.
cleaning up system chunk.
conversion complete.
[root@localhost ~]# btrfs filesystem show
Label: <span style="color: #8b2252;">'B-tree-fs'</span>  uuid: b254b565-0418-4601-8317-f9a5306c6f19
Total devices 2 FS bytes used 735.81MiB
devid    2 size 20.00GiB used 2.03GiB path /dev/sdc
devid    4 size 20.00GiB used 1.03GiB path /dev/sdb

Label: none  uuid: 12170ec7-9847-4a5a-85ee-13215a478a3c
Total devices 1 FS bytes used 228.42MiB
devid    1 size 5.00GiB used 5.00GiB path /dev/sdd1

Btrfs v3.16.2
[root@localhost ~]# btrfs-convert -r /dev/sdd1     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;btrfs&#25991;&#20214;&#31995;&#32479;&#22238;&#28378;&#21407;&#26469;&#30340;&#25991;&#20214;&#31995;&#32479;</span>
rollback complete.
[root@localhost ~]# blkid /dev/sdd1
/dev/sdd1: <span style="color: #a0522d;">UUID</span>=<span style="color: #8b2252;">"fbbd653f-fb3f-4715-8c42-8c942564c8f4"</span> <span style="color: #a0522d;">TYPE</span>=<span style="color: #8b2252;">"ext4"</span>
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:0b9caad1-b74d-4267-b495-11de46b4d2de" class="outline-2">
<h2 id="h:0b9caad1-b74d-4267-b495-11de46b4d2de">ISO制作</h2>
<div class="outline-text-2" id="text-h:0b9caad1-b74d-4267-b495-11de46b4d2de">
</div>
<div id="outline-container-h:04af2fe8-0674-474b-86af-8106ce885a94" class="outline-3">
<h3 id="h:04af2fe8-0674-474b-86af-8106ce885a94">准备工作</h3>
<div class="outline-text-3" id="text-h:04af2fe8-0674-474b-86af-8106ce885a94">
<p>
<b>目录说明</b>
</p>

<ul class="org-ul">
<li>/home/emacle/script目录为脚本存放目录。</li>
<li>/home/emacle/emacle_rhel_6.3 目录为ISO制作的根目录。</li>
</ul>

<p>
此目录组成为：
</p>
<ol class="org-ol">
<li>源rhel_6.3光盘中除Packages目录下所有安装包。</li>
<li>手动安装操作系统中/root/anaconda-ks.cfg文件。之后会对此文件做定制化修改。</li>
<li>从手动安装操作系统中/root/install.log文件中提取所有安装的rpm包放到Packages目录下。</li>
<li>在从手动安装操作系统中安装所有应用程序。把下载的rpm包放到Packages目录下。</li>
<li>把所有需要编译安装的源码包和不能通过rpm安装的程序文件打成一个rpm包，放到Packages目录下。</li>
</ol>


<p>
<b>安装createrepo包</b>
</p>
</div>
</div>
<div id="outline-container-h:b185453f-a697-4e5f-8c24-267fadf124e7" class="outline-3">
<h3 id="h:b185453f-a697-4e5f-8c24-267fadf124e7">配置文件修改</h3>
<div class="outline-text-3" id="text-h:b185453f-a697-4e5f-8c24-267fadf124e7">
<p>
<b>修改/home/emacle/emacle_rhel_6.3/anaconda-ks.cfg配置文件</b>
</p>

<p>
此文件为自动安装脚本文件。内容如下：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">Kickstart file automatically generated by anaconda.</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">version=DEVEL</span>
install
text
cdrom
lang en_US.UTF-8
keyboard us
network --onboot no --device eth0 --bootproto dhcp --noipv6
rootpw  --iscrypted $<span style="color: #a0522d;">6</span>$<span style="color: #a0522d;">ksiYu</span>.rXVzFbCNNi$<span style="color: #a0522d;">7</span>Q9ho0VOQlSMDTZj.xrJHwL6MVEJ3e5CH/Ko3V834XHQQfHEHmGj04QmzuciR.ufrAxYRGuWO6SfR/RyeOM6j1
firewall --disabled
authconfig --enableshadow --passalgo=sha512
selinux --disabled
timezone --utc Asia/Shanghai
bootloader --location=mbr --driveorder=sda --append=<span style="color: #8b2252;">"crashkernel=auto rhgb quiet"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">The following is the partition information you requested</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Note that any partitions you deleted are not expressed</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">here so unless you clear all partitions first, this is</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">not guaranteed to work</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">clearpart --none</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">part /boot --fstype=ext4 --size=128</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">part swap --size=1024</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">part / --fstype=ext4 --grow --size=200</span>
%packages
@additional-devel
@base
@chinese-support
@client-mgmt-tools
@console-internet
@core
@debugging
@desktop-platform-devel
@development
@directory-client
@eclipse
@hardware-monitoring
@java-platform
@large-systems
@network-file-system-client
@performance
@perl-runtime
@server-platform
@server-platform-devel
@server-policy
@system-admin-tools
libXinerama-devel
openmotif-devel
libXmu-devel
xorg-x11-proto-devel
startup-notification-devel
libgnomeui-devel
libbonobo-devel
junit
libXau-devel
libgcrypt-devel
popt-devel
libdrm-devel
libXrandr-devel
libxslt-devel
libglade2-devel
gnutls-devel
pax
python-dmidecode
oddjob
sgpio
mtools
systemtap-client
desktop-file-utils
ant
rpmdevtools
jpackage-utils
rpmlint
certmonger
pam_krb5
krb5-workstation
perl-DBD-SQLite
<span style="color: #b22222;">#</span><span style="color: #b22222;">app</span>
appserver
webstatic
user_platform
search
tpush
privacycloud_scripts
<span style="color: #b22222;">#</span>
nginx
nginx_config
mongo-10gen
mongo-10gen-server
redis
rabbitmq-server
td-agent
emacle-config
<span style="color: #b22222;">#</span>
%post
<span style="color: #b22222;">###</span><span style="color: #b22222;">sysinfo.log</span>
useradd emacle
<span style="color: #483d8b;">echo</span> emacle2013 | passwd --stdin emacle &gt;/dev/null 2&gt;&amp;1
chmod 755 /home/emacle
<span style="color: #a0522d;">CUR_PWD</span>=<span style="color: #8b2252;">"/usr/local/software"</span>
<span style="color: #a0522d;">PATH</span>=${<span style="color: #a0522d;">PATH</span>}:/usr/local/bin
<span style="color: #483d8b;">export</span> CUR_PWD PATH
<span style="color: #b22222;">#</span>
cat &gt;&gt;/etc/security/limits.conf &lt;&lt;\EOF
<span style="color: #ffa54f;">emacle soft nproc 65535</span>
<span style="color: #ffa54f;">emacle hard nproc 65535</span>
<span style="color: #ffa54f;">emacle soft nofile 65535</span>
<span style="color: #ffa54f;">emacle hard nofile 65535</span>
<span style="color: #ffa54f;">EOF</span>
<span style="color: #b22222;">#</span>
sed -i <span style="color: #8b2252;">'s/SELINUX=enforcing/SELINUX=disabled/g'</span> /etc/selinux/config
sed -i <span style="color: #8b2252;">'s/^exclude/#exclude/'</span> /etc/yum.conf
setenforce 0 &gt;/dev/null 2&gt;&amp;1
iptables -F
<span style="color: #b22222;">#</span><span style="color: #b22222;">yum</span>
yum makecache
yum -q -y install yum-fastestmirror
yum -q -y install gcc gcc-c++ libtool make cmake autoconf automake
yum -q -y groupinstall <span style="color: #8b2252;">'Additional Development'</span> <span style="color: #8b2252;">'Security Tools'</span> <span style="color: #8b2252;">'Development tools'</span>
<span style="color: #b22222;">### </span><span style="color: #b22222;">Install ntp ###</span>
yum -q -y install ntp
ntpdate -u pool.ntp.org
hwclock -w
chkconfig ntpd on
service ntpd restart &gt;/dev/null 2&gt;&amp;1
service ntpd restart &gt;/dev/null 2&gt;&amp;1
<span style="color: #b22222;">#</span><span style="color: #b22222;">service_test</span>
<span style="color: #b22222;">### </span><span style="color: #b22222;">Install openssh ###</span>
yum -q -y install openssh
chkconfig sshd on
sed -i <span style="color: #8b2252;">'s/#UseDNS yes/UseDNS no/'</span> /etc/ssh/sshd_config
service sshd restart &gt;/dev/null 2&gt;&amp;1
service sshd restart &gt;/dev/null 2&gt;&amp;1
<span style="color: #b22222;">#</span><span style="color: #b22222;">service_test</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">install_app.sh</span>
mkdir -p /tmp_ram
chown -R emacle:emacle /tmp_ram
mkdir /home/emacle/logs
chown -R emacle:emacle /home/emacle/logs
<span style="color: #b22222;">#</span><span style="color: #b22222;">install_nginx.sh</span>
chown emacle.emacle -R /home/emacle/services
<span style="color: #b22222;">#</span><span style="color: #b22222;">install_mongodb.sh</span>
mv /etc/init.d/mongod /etc/init.d/mongod.bak
mkdir -p /data/mongodb/{data,log,config,arbiter}
chown mongod -R /data/mongodb
<span style="color: #b22222;">#</span><span style="color: #b22222;">install_redis.sh</span>
sed -i <span style="color: #8b2252;">'s/bind 127.0.0.1/#bind 127.0.0.1/'</span> /etc/redis.conf
cp /etc/redis.conf /etc/redis6380.conf
sed -i <span style="color: #8b2252;">'s!pidfile /var/run/redis/redis.pid!#pidfile /var/run/redis/redis6380.pid!'</span> /etc/redis6380.conf
sed -i <span style="color: #8b2252;">'s!port 6379!port 6380!'</span> /etc/redis6380.conf
sed -i <span style="color: #8b2252;">'s!logfile /var/log/redis/redis.log!logfile /var/log/redis/redis6380.log!'</span> /etc/redis6380.conf
grep <span style="color: #8b2252;">'vm.overcommit_memory = 1'</span> /etc/sysctl.conf &gt;/dev/null 2&gt;&amp;1 || <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'vm.overcommit_memory = 1'</span> &gt;&gt; /etc/sysctl.conf
<span style="color: #b22222;">#</span><span style="color: #b22222;">install_rabbitmq.sh</span>
<span style="color: #a0522d;">HOST</span>=$(hostname | awk -F<span style="color: #8b2252;">'.'</span> <span style="color: #8b2252;">'{print $1}'</span>)
grep <span style="color: #8b2252;">"127.0.0.1\ \+$HOST"</span> /etc/hosts &gt;/dev/null || <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"127.0.0.1 $HOST"</span> &gt;&gt; /etc/hosts
<span style="color: #b22222;">#</span><span style="color: #b22222;">install_fluentd.sh</span>
tar xf /usr/local/software/conf.d/fluentd.tar.gz  -C /
mkdir -p /home/emacle/tmp
chown td-agent /home/emacle/tmp
<span style="color: #b22222;">#</span><span style="color: #b22222;">install_jdk.sh</span>
bash /usr/local/software/soft/jdk-6u45-linux-x64.bin &gt;/dev/null 2&gt;&amp;1
mv jdk1.6.0_45 /usr/local/
cat &gt;&gt;/etc/profile &lt;&lt;\EOF
<span style="color: #ffa54f;">JAVAHOME=/usr/local/jdk1.6.0_45/bin</span>
<span style="color: #ffa54f;">PATH=${PATH}:${JAVAHOME}</span>
<span style="color: #ffa54f;">export PATH JAVAHOME</span>
<span style="color: #ffa54f;">EOF</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">install_hadoop.sh</span>
mkdir -p /home/emacle/app
tar xf /usr/local/software/soft/hadoop-1.0.4.tar.gz -C /home/emacle/app/
tar xf /usr/local/software/conf.d/hadoop.tar.gz  -C /home/emacle/app/hadoop-1.0.4
\cp -r /usr/local/software/soft/.ssh ~emacle
mkdir -p /home/emacle/app/hadoop-1.0.4/data/hadoop/{name,data,tmp}
chown emacle.emacle -R /home/emacle/app
<span style="color: #b22222;">#</span><span style="color: #b22222;">install_python.sh</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">install rpm ###</span>
yum -y -q install zlib zlib-devel openssl openssl-deval freetype freetype-devel libxml2 libxml2-devel libxslt libxslt-devel
rpm -ivh ${<span style="color: #a0522d;">CUR_PWD</span>}/soft/mysql-5.1.61-4.el6.x86_64.rpm
rpm -ivh ${<span style="color: #a0522d;">CUR_PWD</span>}/soft/mysql-devel-5.1.61-4.el6.x86_64.rpm
<span style="color: #a0522d;">InstallLog</span>=<span style="color: #8b2252;">"${CUR_PWD}/install.log"</span>
<span style="color: #a0522d;">PythonDir</span>=<span style="color: #8b2252;">"${CUR_PWD}/soft/python/"</span>
<span style="color: #483d8b;">cd</span> $<span style="color: #a0522d;">PythonDir</span> &amp;&amp; rm -rf Python-2.7.3 pip-1.0
tar jxvf Python-2.7.3.tar.bz2
<span style="color: #483d8b;">cd</span> Python-2.7.3
./configure -q
make  -s all
make -s install
make clean
make distclean
mv /usr/bin/python /usr/bin/python2.6.6
ln -s /usr/local/bin/python2.7 /usr/bin/python
sed -i <span style="color: #8b2252;">'1s@^#!/usr/bin/python@#!/usr/bin/python2.6.6@'</span> /usr/bin/yum
<span style="color: #483d8b;">cd</span> $<span style="color: #a0522d;">PythonDir</span>
chmod 775 setuptools-0.6c11-py2.7.egg
sh setuptools-0.6c11-py2.7.egg
tar xvfz pip-1.0.tar.gz
<span style="color: #483d8b;">cd</span> pip-1.0
python setup.py install
<span style="color: #b22222;">#</span><span style="color: #b22222;">chown emacle.emacle -R /home/emacle</span>
<span style="color: #b22222;">### </span><span style="color: #b22222;">/Install python ###</span>
<span style="color: #b22222;">### </span><span style="color: #b22222;">configuration python env ###</span>
mkdir -p /home/emacle/python_dependency/source
\cp -r ${<span style="color: #a0522d;">PythonDir</span>}/source/* /home/emacle/python_dependency/source/
pip install /home/emacle/python_dependency/source/virtualenv-1.9.1.tar.gz
<span style="color: #b22222;">#</span><span style="color: #b22222;">mkdir -p /home/emacle/services</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">\cp -r ${PythonDir}/user_platform /home/emacle/services</span>
<span style="color: #483d8b;">cd</span> /home/emacle/services
/usr/local/bin/virtualenv --distribute env
<span style="color: #483d8b;">cd</span> /home/emacle/services/user_platform
(
/home/emacle/services/env/bin/easy_install /home/emacle/python_dependency/source/pytz-2013b-py2.7.egg
/home/emacle/services/env/bin/easy_install /home/emacle/python_dependency/source/flup-1.0.3.dev_20110405-py2.7.egg
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/distribute-0.6.45.tar.gz
/home/emacle/services/env/bin/easy_install /home/emacle/python_dependency/source/Babel-0.9.6-py2.7.egg
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/captchaimage-1.3.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/chardet-2.1.1.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/gdata-2.0.18.zip
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/lxml-3.2.1.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/nose-1.3.0.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/pika-0.9.13.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/Imaging-1.1.7.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/pycrypto-2.6.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/pyDes-2.0.1.zip
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/pydns-2.3.6.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/pymongo-2.5.2.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/pystache-0.5.3.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/redis-2.7.6.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/sendgrid-0.1.3.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/SQLAlchemy-0.8.1.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/suds-0.4.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/xlwt-0.7.5.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/mustache-0.1.4.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/httpagentparser-1.2.2.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/speaklater-1.3.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/billiard-2.7.3.28.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/anyjson-0.3.3.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/amqp-1.0.12.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/Werkzeug-0.9.1.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/itsdangerous-0.21.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/MarkupSafe-0.18.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/six-1.3.0.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/MySQL-python-1.2.4.zip
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/python-dateutil-2.1.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/kombu-2.5.11.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/celery-3.0.19.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/Jinja2-2.7.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/Flask-0.9.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/Flask-Babel-0.8.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/Flask-PyMongo-0.2.1.tar.gz
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/vobject-0.8.1c.tar.gz
/home/emacle/services/env/bin/easy_install /home/emacle/python_dependency/source/Flask_Cache-0.12-py2.7.egg
/home/emacle/services/env/bin/pip install /home/emacle/python_dependency/source/IPy-0.81.tar.gz
) &gt; /dev/null 2&gt;&amp;1
chown emacle.emacle -R /home/emacle/services/env/
chown emacle.emacle -R /home/emacle/python_dependency
chown emacle /var/run
<span style="color: #b22222;"># </span><span style="color: #b22222;">td-agent require</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">chown td-agent:emacle /home/emacle/tmp</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">install_celeryd.sh</span>
<span style="color: #a020f0;">if</span> [ ! -d /etc/default ]
<span style="color: #a020f0;">then</span>
        mkdir /etc/default
<span style="color: #a020f0;">fi</span>
\cp ${<span style="color: #a0522d;">CUR_PWD</span>}/soft/celeryd/celeryd /etc/init.d/                <span style="color: #b22222;"># </span><span style="color: #b22222;">celeryd init script</span>
\cp ${<span style="color: #a0522d;">CUR_PWD</span>}/soft/celeryd/config/celeryd /etc/default/        <span style="color: #b22222;"># </span><span style="color: #b22222;">celeryd config</span>
\cp ${<span style="color: #a0522d;">CUR_PWD</span>}/soft/celeryd/celeryctl /usr/bin/                 <span style="color: #b22222;"># </span><span style="color: #b22222;">for sceleryd ervice start|stop</span>
\cp ${<span style="color: #a0522d;">CUR_PWD</span>}/soft/celeryd/celeryd-multi /usr/bin/             <span style="color: #b22222;"># </span><span style="color: #b22222;">for sceleryd ervice status</span>
chmod 755  /usr/bin/celeryd-multi /etc/init.d/celeryd  /usr/bin/celeryctl
mkdir -p /var/log/celery
mkdir -p /var/run/celery
chown emacle.emacle -R /var/log/celery /var/run/celery
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"/etc/init.d/celeryd start"</span> &gt;&gt;/etc/rc.d/rc.local
<span style="color: #b22222;"># </span><span style="color: #b22222;">Init consumer</span>
mkdir /var/run/consumer
chown emacle.emacle /var/run/consumer
<span style="color: #b22222;">#</span><span style="color: #b22222;">install_mysql.sh</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">install_cront.sh</span>
cat /usr/local/software/soft/crontab &gt;&gt; /var/spool/cron/emacle
<span style="color: #b22222;">#</span><span style="color: #b22222;">install_nconvert.sh</span>
\cp /usr/local/software/soft/nconvert /usr/bin
chmod 755 /usr/bin/nconvert
<span style="color: #b22222;">#</span>
<span style="color: #b22222;">### </span><span style="color: #b22222;">Reset owner of file ###</span>
chown emacle.emacle -R /tmp_ram &gt;/dev/null 2&gt;&amp;1
chown emacle.emacle -R /var/log/celery /var/run/celery /var/run/consumer &gt;/dev/null 2&gt;&amp;1
chown td-agent:emacle -R /home/emacle/tmp &gt;/dev/null 2&gt;&amp;1
chown mongod -R /data/mongodb &gt;/dev/null 2&gt;&amp;1
chown emacle /var/run
<span style="color: #b22222;"># </span><span style="color: #b22222;">chkconfig</span>
<span style="color: #a0522d;">SERVICE_ON</span>=<span style="color: #8b2252;">"ntpd nginx mongod redis rabbitmq-server td-agent sshd"</span>
<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> ${<span style="color: #a0522d;">SERVICE_ON</span>}
<span style="color: #a020f0;">do</span>
        chkconfig $<span style="color: #a0522d;">i</span> on
<span style="color: #a020f0;">done</span>
%end
</pre>
</div>

<p>
<b>修改/home/emacle/emacle_rhel_6.3/isolinux/isolinux.cfg配置文件</b>
</p>

<p>
此文件添加“auto”自动安装命令。内容如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">default vesamenu.c32
<span style="color: #b22222;">#</span><span style="color: #b22222;">prompt 1</span>
timeout 600
display boot.msg
menu background splash.jpg
menu title Welcome to Red Hat Enterprise Linux 6.3!
menu color border 0 <span style="color: #b22222;">#</span><span style="color: #b22222;">ffffffff #00000000</span>
menu color sel 7 <span style="color: #b22222;">#</span><span style="color: #b22222;">ffffffff #ff000000</span>
menu color title 0 <span style="color: #b22222;">#</span><span style="color: #b22222;">ffffffff #00000000</span>
menu color tabmsg 0 <span style="color: #b22222;">#</span><span style="color: #b22222;">ffffffff #00000000</span>
menu color unsel 0 <span style="color: #b22222;">#</span><span style="color: #b22222;">ffffffff #00000000</span>
menu color hotsel 0 <span style="color: #b22222;">#</span><span style="color: #b22222;">ff000000 #ffffffff</span>
menu color hotkey 7 <span style="color: #b22222;">#</span><span style="color: #b22222;">ffffffff #ff000000</span>
menu color scrollbar 0 <span style="color: #b22222;">#</span><span style="color: #b22222;">ffffffff #00000000</span>
label linux
  menu label ^Install or upgrade an existing system
  menu default
  kernel vmlinuz
  append <span style="color: #a0522d;">initrd</span>=initrd.img
label vesa
  menu label Install system with ^basic video driver
  kernel vmlinuz
  append <span style="color: #a0522d;">initrd</span>=initrd.img <span style="color: #a0522d;">xdriver</span>=vesa nomodeset
label rescue
  menu label ^Rescue installed system
  kernel vmlinuz
  append <span style="color: #a0522d;">initrd</span>=initrd.img rescue
label local
  menu label Boot from ^local drive
  localboot 0xffff
label memtest86
  menu label ^Memory test
  kernel memtest
  append -
label auto  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26032;&#28155;&#21152;&#19968;&#27573;</span>
  kernel vmlinuz
  append <span style="color: #a0522d;">ks</span>=cdrom:/anaconda-ks.cfg <span style="color: #a0522d;">initrd</span>=initrd.img
</pre>
</div>

<p>
<b>修改/home/emacle/script/build_iso.sh脚本</b>
</p>

<p>
此脚本用于iso制作。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/</span><span style="color: #a020f0;">bash</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Description: Build new iso file of emacle</span>
<span style="color: #a0522d;">DATE</span>=$(date <span style="color: #8b2252;">'+%Y%m%d%H%M'</span>)
<span style="color: #a0522d;">ISODIR</span>=/home/emacle/emacle_rhel_6.3
<span style="color: #a0522d;">NEWRPM</span>=/usr/src/redhat/RPMS/x86_64
<span style="color: #a0522d;">SCRIPT_NAME</span>=$(basename $<span style="color: #a0522d;">0</span>)
<span style="color: #0000ff;">create_iso</span>() {
        rm -f /mnt/mkiso/Emacle_rhel_6.3*.iso
        mv ${<span style="color: #a0522d;">NEWRPM</span>}/* ${<span style="color: #a0522d;">ISODIR</span>}/Packages &gt;/dev/null 2&gt;&amp;1
        <span style="color: #b22222;">#</span><span style="color: #b22222;">Create repodata</span>
        <span style="color: #483d8b;">cd</span> ${<span style="color: #a0522d;">ISODIR</span>}
        createrepo -g repodata/comps-rhel6-Server.xml ${<span style="color: #a0522d;">ISODIR</span>}
        <span style="color: #b22222;"># </span><span style="color: #b22222;">Create iso file</span>
        mkisofs -o /mnt/mkiso/Emacle_rhel_6.3_${<span style="color: #a0522d;">DATE</span>}.iso -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4  -boot-info-table -R -J -v -T ${<span style="color: #a0522d;">ISODIR</span>}
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"Emacle_mini${DATE}.iso is created"</span> &gt;&gt;/home/emacle/script/mkiso.log
}
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"### ${DATE} ISO BUILDING</span>
<span style="color: #8b2252;">$0 $@ command is performed"</span> &gt;&gt;/home/emacle/script/mkiso.log
create_iso
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"### $0 is complete"</span> &gt;&gt;/home/emacle/script/mkiso.log
</pre>
</div>


<p>
第一步，光盘启动。
</p>


<figure id="org764dde1">
<img src="./images/img_20240129_161412.png" alt="img_20240129_161412.png" width="60%">

</figure>


<p>
第二步，按‘ESC’调出命令行模式输入“auto”后回车。
</p>


<figure id="org00a485d">
<img src="./images/img_20240129_161500.png" alt="img_20240129_161500.png" width="60%">

</figure>


<p>
第三步，根据实际情况选择使用磁盘空间。
</p>


<figure id="org88f1068">
<img src="./images/img_20240129_161527.png" alt="img_20240129_161527.png" width="60%">

</figure>



<p>
第四步，程序文件安装。
</p>


<p>
第五步，执行安装脚本。注意：此步骤时间很长，大概要30分钟。
</p>


<p>
第六步，安装完毕！按“Reboot”重启服务器。
</p>


<figure id="org43a6fb5">
<img src="./images/img_20240129_161551.png" alt="img_20240129_161551.png" width="60%">

</figure>
</div>
</div>
</section>
</main class="container">
<footer id="postamble" class="status">
<footer data-astro-cid-sz7xmlte data-turbo-permanent id=rootFooter>
    <script>
        const shuffle = e => e.map((e => ({
            v: e,
            sort: Math.random()
        }))).sort(( (e, o) => e.sort - o.sort)).map(( ({v: e}) => e));
        var songList = ["barbie-girl--stantough", "blue-da-ba-dee--cornelius-link", "hips-dont-lie--stantough", "i-want-it-that-way--stantough", "seven-nation-army--stantough", "smooth-criminal--stantough"]
          , songOrder = songOrder ?? shuffle(songList).map((e => `/audio/music/${e}.opus`))
          , song = new Audio(songOrder[0])
          , nextSong = new Audio(songOrder[1])
          , songIndex = 2
          , musicWrapper = void 0
          , arrow = void 0
          , notes = void 0;
        song.addEventListener("ended", next);
        const toggle = () => song.paused ? play() : pause();
        function play() {
            song.play(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.add("shakeManHorse"),
            notes.classList.remove("hideNotes")
        }
        function pause() {
            song.pause(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.remove("shakeManHorse"),
            notes.classList.add("hideNotes")
        }
        function next() {
            song = nextSong,
            play(),
            songIndex === songOrder.length && (songIndex = 0),
            nextSong = new Audio(songOrder[songIndex]),
            songIndex += 1
        }
        function skip() {
            pause(),
            (arrow = arrow || document.getElementById("musicArrow")).classList.add("shootArrow");
            new Audio("/audio/effects/ohno.m4a").play(),
            arrow.addEventListener("animationend", arrowShootHandler, !1)
        }
        function arrowShootHandler() {
            arrow.removeEventListener("animationend", arrowShootHandler, !1),
            arrow.classList.remove("shootArrow");
            new Audio("/audio/effects/heythathurt.m4a").play(),
            next()
        }
    </script>
    <div id=musicPlayer data-astro-cid-q7a5pyro>
        <button class=skip data-astro-cid-q7a5pyro onclick=skip() title="Skip song">
            <div id=skipWrapper data-astro-cid-q7a5pyro>
                <img alt="Medieval drollery of a man/snail/bat/monkey shooting an arrow" class=archer decoding=async height=334 loading=lazy src=/images/archer-no-arrow.448ccd8b_Z1KfRYq.webp width=226 data-astro-cid-q7a5pyro>
                <img alt="Arrow for archer" class="arrow complete" decoding=async height=23 loading=lazy src=/images/no-archer-full-arrow.87aa9971_Z2qL2KO.webp width=141 data-astro-cid-q7a5pyro id=musicArrow>
            </div>
        </button>
        <button class=playPause data-astro-cid-q7a5pyro onclick=toggle() title="Play/pause song">
            <div id=musicWrapper data-astro-cid-q7a5pyro>
                <div class=hideNotes id=notesWrapper data-astro-cid-q7a5pyro>
                    <div class=lyreNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                    <div class=fluteNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                </div>
                <img alt="Medieval drollery of a man/horse playing a lyre and a horn" class=manHorse decoding=async height=665 loading=lazy src=/images/man-horse-band.e3a2efcf_q8FCa.webp width=531 data-astro-cid-q7a5pyro>
            </div>
        </button>
    </div>
    <hr data-astro-cid-sz7xmlte>
    <div class=salutation data-astro-cid-gdmrbrho>
        <p data-astro-cid-gdmrbrho>
            <span class=flower2 data-astro-cid-gdmrbrho>A</span>
            <span class=smallcap data-astro-cid-gdmrbrho>pax vobiscum</span>
            <span class="flower2 wiggle" data-astro-cid-gdmrbrho id=leaf>a</span>
        </p>
    </div>
    <script>
        function animateLeafBlownHandler() {
            leaf.removeEventListener("animationend", animateLeafBlownHandler, !1),
            leaf.classList.remove("blownAway"),
            leaf.classList.add("wiggle")
        }
        function animateLeaf() {
            leaf = leaf ?? document.getElementById("leaf"),
            leaf.classList.remove("wiggle"),
            leaf.classList.add("blownAway"),
            leaf.addEventListener("animationend", animateLeafBlownHandler, !1)
        }
        document.getElementById("leaf").onclick = animateLeaf
    </script>


    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2024 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
</footer>
</footer>
</body>
</html>
