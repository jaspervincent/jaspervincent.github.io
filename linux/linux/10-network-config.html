<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: 网络协议和管理配置础</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux: 网络协议和管理配置础</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:6c3438a4-a4c3-4b8d-a04e-6cac42acb2a6">网络基础</a>
<ul>
<li><a href="#h:91c51f52-3412-4b59-a189-b5d608172554">网络概念</a></li>
<li><a href="#h:53b66a91-d454-4d00-8af8-c3761923305e">常见的网络物理组件</a></li>
<li><a href="#h:b74150c3-9393-4569-ae56-463f9ada95d7">网络应用程序</a>
<ul>
<li><a href="#h:2559ccba-ba2e-4a2a-b2fa-b888502667f2">各种网络应用</a></li>
<li><a href="#h:73bffde4-e281-4d5c-be2b-383496620d1c">应用程序对网络的要求</a></li>
</ul>
</li>
<li><a href="#h:090450f7-1895-45c5-8d61-6598e1053fd7">网络的特征</a>
<ul>
<li><a href="#h:bef932f7-c48a-42aa-8d37-d1c7fe1dffb8">速度(带宽)</a></li>
<li><a href="#h:10c0cbf3-1aad-49c0-b599-90dec1fbc11d">网络拓扑</a></li>
</ul>
</li>
<li><a href="#h:ccaa19e7-e0b7-4918-954c-8522374c5b6f">网络标准</a>
<ul>
<li><a href="#h:6ca2fc1f-e8a1-4ec6-8512-2879d6a8a978">网络标准和分层</a></li>
<li><a href="#h:98243d37-26cd-45af-b7c2-0279fca3581f">开放系统互联 OSI</a></li>
<li><a href="#h:d3e7d2ed-1c3a-4a45-b0f1-3a3653e13dd0">网络的通信过程</a>
<ul>
<li><a href="#h:166a19fd-4af1-496f-9350-d681428d9325">数据封装和数据解封</a></li>
<li><a href="#h:a9b4c589-ca54-43b3-a695-319bcb94450f">协议数据单元 PDU</a></li>
<li><a href="#h:83eeab5e-d5d5-4716-ba14-df37aedd92fd">三种通讯模式</a></li>
<li><a href="#h:77e74e8a-9dfc-4fef-9011-f7d0df1d9090">冲突域和广播域</a></li>
<li><a href="#h:91d40a4a-0ab8-4dae-a2ab-1c46e54b212f">三种通讯机制</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:759c8304-bed4-418f-9b7b-b83feb537921">局域网 Local Area Network</a>
<ul>
<li><a href="#h:57c646ca-54ff-40d1-9673-3c00fd22c9ac">概述</a>
<ul>
<li><a href="#h:4167b2dc-d875-4917-a07b-897c10f1770a">特点</a></li>
<li><a href="#h:46c9f224-85d9-41b2-b4c1-323c00454e3a">主要功能</a></li>
<li><a href="#h:cde2c391-566f-4274-84d1-181bd71bd821">优点</a></li>
<li><a href="#h:3ce873b4-ea0a-4f69-ac27-6c20ecb9dfa5">标准</a></li>
</ul>
</li>
<li><a href="#h:ad5398cb-b104-4143-897c-c9cb93f48eb2">组网设备</a>
<ul>
<li><a href="#h:ca715938-c9d4-4191-ad98-8f4742f874bf">网络线缆和接口</a>
<ul>
<li><a href="#h:95b93f07-4528-4eb8-9d1d-40f01188f77a">网线标准</a></li>
<li><a href="#h:dfefafcf-cfa1-4889-9ccc-61b4fd68f3a8">网线线序和规范</a></li>
<li><a href="#h:62cb532e-010f-4c46-b0ab-62da13ef1bb8">光纤和接口Fiber-Optic</a></li>
</ul>
</li>
<li><a href="#h:fa83fe9c-7ac1-4e7a-9d4b-bca0e421475b">网络适配器</a></li>
<li><a href="#h:419a45d9-8616-45e7-abbf-bbf9a1242b35">中继器和集线器</a>
<ul>
<li><a href="#h:6455bb70-5e62-4328-840f-c1d29ec638e0">中继器 repeater</a></li>
<li><a href="#h:98ced2be-1fa3-4fb7-82db-14ca8547db00">集线器 hub</a></li>
</ul>
</li>
<li><a href="#h:9cb88bf4-ec26-4689-9caa-86457ce3be53">网桥和交换机</a>
<ul>
<li><a href="#h:3060c7a5-b3d7-4b24-8de6-18999d3ae48d">网桥Bridge</a></li>
<li><a href="#h:6bdc9686-5855-4834-a220-0c209c9b4fe8">交换机switch</a></li>
</ul>
</li>
<li><a href="#h:671d433a-9e4f-4eb0-b46d-1f630de9f850">路由器 router</a></li>
</ul>
</li>
<li><a href="#h:2d5cb477-dbb8-40ae-a241-78af5932b600">Ethernet以太网技术</a>
<ul>
<li><a href="#h:1e2c429e-50a9-4377-934f-56804d41792d">概述</a></li>
<li><a href="#h:e3291166-ab75-4478-9973-3ec1da723697">以太网MAC帧格式</a></li>
<li><a href="#h:bb46b8c4-b6d4-4b57-b30c-1c2e62663a85">MAC地址</a></li>
<li><a href="#h:fa68cf8f-01c5-480e-9420-14cc15dbe0fe">冲突检测的载波侦听多路访问CSMA/CD</a></li>
</ul>
</li>
<li><a href="#h:ab1d4d0b-5409-43c5-a14f-1493038747fc">虚拟局域网 VLAN</a>
<ul>
<li><a href="#h:ebddb3a6-75c6-4582-b7f4-8263169db03a">VLAN 原理</a></li>
<li><a href="#h:83e75bab-d632-405f-b861-ee707fe8a940">IEEE 802.1Q 帧结构</a></li>
</ul>
</li>
<li><a href="#h:0047520c-b9a5-475c-a37d-5ac1fbf14419">分层的网络架构</a></li>
</ul>
</li>
<li><a href="#h:a875bb87-b31c-46e2-b43a-446abed58e9a">TCP/IP 协议栈</a>
<ul>
<li><a href="#h:8f56d593-9656-44ff-a89a-9ca8d19a5f9a">TCP/IP 标准</a>
<ul>
<li><a href="#h:d9d3ef57-90cb-400e-aafd-996aa04a79c9">TCP/IP 介绍</a></li>
<li><a href="#h:8da14656-a0af-48b5-9ba9-eb12272d67ff">TCP/IP 分层</a></li>
<li><a href="#h:f57b10b5-8c08-43d6-9c41-762ad52a5c2f">TCP/IP 通信过程</a></li>
<li><a href="#h:a220c962-cc20-47f1-83c3-4d52bc92043e">TCP/IP和OSI模型的比较</a></li>
</ul>
</li>
<li><a href="#h:4a43b9ba-8dc1-45b3-98ca-35b2be3f2c0b">Transport Layer 传输层</a>
<ul>
<li><a href="#h:8b86f8dd-f666-4ac1-ba02-dea298a0a2e7">TCP Transmission Control Protocol</a>
<ul>
<li><a href="#h:60d033f9-6189-4b70-94cd-6b959d38e4f9">TCP特性</a></li>
<li><a href="#h:eb4cd55d-fee8-4866-8efb-dc9440614e17">TCP包头结构</a></li>
<li><a href="#h:cbbcd216-4e68-4fdc-9b68-5d5f4a2aeac2">TCP协议PORT</a></li>
<li><a href="#h:7033a70b-f8ef-45bb-8cdf-972da7a45fe4">三次握手和四次挥手</a></li>
<li><a href="#h:274661d1-0372-45ac-9721-4b24e068a82a">有限状态机 FSM:Finite State Machine</a></li>
<li><a href="#h:4b385d99-033c-4dfe-b737-746e0717a9ee">sync半连接和accept全连接队列</a></li>
<li><a href="#h:8590cf52-e1e2-4e70-a811-49a0129789b9">TCP超时重传</a></li>
<li><a href="#h:0f57b6c9-286d-4f3b-93d6-62541ff69405">拥塞控制</a></li>
<li><a href="#h:7f56eb5b-304a-4c2e-92b9-9727b930909c">内核TCP参数优化</a></li>
</ul>
</li>
<li><a href="#h:cda7f942-b2e8-4557-87ad-ba9cc944e1c7">UDP User Datagram Protocol</a>
<ul>
<li><a href="#h:55b072a2-5aff-4a22-8505-03fb83f5e7c1">UDP特性</a></li>
<li><a href="#h:af1533e5-a9f2-4cc5-ac91-2863159d2e5f">UDP包头</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:7484cb90-c7d9-476d-938f-a69ca8cab660">Internet Layer 网络层</a>
<ul>
<li><a href="#h:35d0a855-05db-47fe-a779-f22fd6f416e2">Internet Control Message Protocol(ICMP)</a></li>
<li><a href="#h:8c6856a3-c380-4846-8730-51eacf2beaeb">Address Resolution Protocol(ARP)</a>
<ul>
<li><a href="#h:6810101e-7ee0-4482-9eae-01d0532fd309">ARP</a></li>
<li><a href="#h:48ed9e24-3096-42e8-a9d4-454e85a8a3bc">Gratuitous ARP</a></li>
</ul>
</li>
<li><a href="#h:98c10db2-5b33-40ad-9c20-ab80e13b9fcf">Reverse Address Resolution Protocol(RARP)</a></li>
<li><a href="#h:df21c6e8-914c-4f4f-b6e8-7a4182ea47a3">Internet Protocol(IP)</a>
<ul>
<li><a href="#h:8a22db44-fa14-48fd-9704-3ef0725b3365">Internet 协议特征</a></li>
<li><a href="#h:7171118a-6985-4f40-962d-50ac86c6c09c">IP PDU 报头</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:80d722ef-d749-48fa-a950-f849a22e420a">主机到主机的包传递完整过程</a></li>
<li><a href="#h:293d4255-a601-4598-960a-d5a675723946">IP地址</a>
<ul>
<li><a href="#h:f1027f8f-7f83-4501-9612-6d3a5b53d64e">IP地址组成</a></li>
<li><a href="#h:49f34f99-5eb1-4bee-8ece-97db0331fcd0">IP地址分类</a></li>
<li><a href="#h:2246d8c1-4c95-4d6b-8d7c-22bfff60834d">公共和私有IP地址</a></li>
<li><a href="#h:d918cf56-8db4-4dbc-aacd-ab7ed0f9c843">特殊地址</a></li>
<li><a href="#h:c6afac7d-aed1-4bdd-9aec-140e81e7d2f8">保留地址</a></li>
<li><a href="#h:0cf2f901-22cf-43b5-9a13-381b4351dc8d">子网掩码netmask</a></li>
<li><a href="#h:0c118935-c2a0-4bbd-a8c5-2f3dfd6325c2">划分子网</a></li>
<li><a href="#h:b5532e1d-7e98-475c-a713-4f70d56bcdce">优化IP地址分配</a></li>
<li><a href="#h:bdcd5fd5-017a-452e-900b-0a2010398094">跨网络通信</a></li>
<li><a href="#h:6c28f92d-50bf-4681-af1f-25b3b87deea4">动态主机配置协议 DHCP</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:505b57b4-2c04-4ef1-8293-0313b2e42598">网络配置</a>
<ul>
<li><a href="#h:ab07a8ba-6854-4314-81d2-36a4ecd563a7">统一网卡名称</a></li>
<li><a href="#h:fd45562f-6be7-4fc6-be61-7490a8a87d03">网络配置</a>
<ul>
<li><a href="#h:6b85f337-9ae7-468b-9789-ca6f4746aec9">网络配置方式</a></li>
<li><a href="#h:85a11468-8d18-44fe-bc80-300ceb27d6bc">Red Hat系列网卡配置</a></li>
<li><a href="#h:9f8765c4-e6b6-4de2-90a6-ae877f4007fa">Ubuntu系统网卡配置</a></li>
</ul>
</li>
<li><a href="#h:3259854c-47a3-4d7f-b11e-fcbb69b558fa">网络配置命令</a>
<ul>
<li><a href="#h:80be0e63-ecf0-436e-9ed8-7863eb32dd55">主机名</a></li>
<li><a href="#h:5e25d3de-f762-4d3b-b394-628ccae1e016">ifconfig命令</a></li>
<li><a href="#h:0433aa85-d052-4453-8d10-b491b5441dbd">route命令</a></li>
<li><a href="#h:fde2884a-b662-4ee8-ba7e-614f6dc361b3">配置动态路由</a></li>
<li><a href="#h:88978386-ca24-4adc-81ed-15afc6a927e7">netstat命令</a></li>
<li><a href="#h:c364cc23-387a-4a95-a359-47373557edc0">显示接口统计数据</a></li>
<li><a href="#h:1b405a1a-a7a3-4435-98df-daa9f41edd40">ip命令</a>
<ul>
<li><a href="#h:4288a615-400b-4867-a4bc-207eda01a3ec">ip link 网络设备配置</a></li>
<li><a href="#h:8a3fa4c8-88b7-4570-b3ac-bf3ca1c53a6d">ip 地址管理</a></li>
<li><a href="#h:2d272223-d150-42aa-bd6d-df6b5b067bc3">管理路由</a></li>
<li><a href="#h:421be196-3790-4249-b2af-3df7b4797fa1">管理网络名称空间</a></li>
</ul>
</li>
<li><a href="#h:696db829-a288-4298-b0bd-16e65726eb0d">ss 命令</a></li>
<li><a href="#h:932212bc-021d-41bc-b210-236d847b0f96">网络配置工具 nmcli</a></li>
</ul>
</li>
<li><a href="#h:02dc2a62-3464-4308-b307-3f0288570ced">网络配置文件</a>
<ul>
<li><a href="#h:f3ad9452-c900-4b6f-b4bf-4116d4592e5a">配置当前主机的主机名</a></li>
<li><a href="#h:36b314c8-8372-4a43-8a4a-e1beffa91310">本地主机名和IP地址的映射</a></li>
<li><a href="#h:0d9af96d-7fb6-4f64-a415-c3ee5f38d860">DNS域名解析</a></li>
<li><a href="#h:e3166d0a-902b-4f3b-876e-3fa12ee171bb">修改 /etc/hosts和DNS的优先级</a></li>
<li><a href="#h:d83a9c21-14d0-4651-b567-9744eeac79c4">路由相关的配置文件</a></li>
</ul>
</li>
<li><a href="#h:b9ea5b73-5012-41de-981a-6b1499877b38">网卡别名</a></li>
<li><a href="#h:aae3c1c2-71cc-41a5-9390-b4fc00aae54a">多网卡 bonding</a>
<ul>
<li><a href="#h:8ec3aee1-6b23-46bb-8900-3456abbd3584">Bonding 工作模式</a></li>
<li><a href="#h:faa62494-84a3-424a-8799-655fd7564779">Bonding实现</a></li>
<li><a href="#h:f6949c88-9b33-44a1-be63-80ece05f9c91">nmcli实现bonding</a></li>
<li><a href="#h:56ccd22a-374d-45c0-bd50-e00918470781">Ubuntu网卡配置</a>
<ul>
<li><a href="#h:6601370b-d40e-41a2-b699-4b901f664802">双网卡绑定</a></li>
<li><a href="#h:a4d02ee0-c0aa-4f00-9b1d-993a039542f3">网卡的多组绑定</a></li>
<li><a href="#h:a87259e5-a6ae-4c45-949f-a5bd7873dbf2">单网卡桥接</a></li>
<li><a href="#h:a32847b9-4eee-429d-9d1a-26d15e5c6130">多网卡桥接</a></li>
<li><a href="#h:16168340-5490-4c3b-a02c-bcd472847614">双网卡绑定+桥接</a></li>
<li><a href="#h:73903365-34ee-413a-a07e-4b8d05bf7c61">网卡多组绑定+多组桥接</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:9599c7d5-fec3-432c-9818-a2dabcfeefd9">网络组 Network Teaming</a>
<ul>
<li><a href="#h:b6c94074-d152-41db-8104-187c1385c2bb">网络组实现</a>
<ul>
<li><a href="#h:0ab982d6-79f6-4d84-b706-a9939e3b0aa5">修改配置文件实现</a></li>
<li><a href="#h:45275bda-c06a-4da9-946d-6827f5d1ac2f">nmcli命令实现</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:57cf60fe-081e-4fe5-9b2b-387a49d6f3f9">网桥(交换机)</a>
<ul>
<li><a href="#h:f225f4ad-f717-40f3-81ad-9ee638274f58">桥接原理</a></li>
<li><a href="#h:ad72387b-f65b-496e-b6f6-5c5daec0ba7e">配置实现网桥</a>
<ul>
<li><a href="#h:68016ea1-85ca-495d-8978-c9c5f5ad155b">配置文件方式</a></li>
<li><a href="#h:30d0ee6e-aa44-414b-afbb-3144ba491f40">方法1-工具包bridge-utils实现</a></li>
<li><a href="#h:2720dab4-0fa0-4597-8408-a4d55a433305">方法2-工具包iproute实现</a></li>
<li><a href="#h:6c232ebe-e354-4769-8346-6042a0479177">方法3-使用nmcli命令实现创建网桥</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:b6c93e58-d003-4146-b545-5e5b92f3516d">虚拟网卡</a>
<ul>
<li><a href="#h:7a12eef3-0aa8-4384-8e3c-3b6d433b23a3">网桥与网卡</a></li>
<li><a href="#h:3a6d1f36-7489-4413-910b-ec988f0fba2d">虚拟网卡的实现原理</a>
<ul>
<li><a href="#h:58e44b19-8e1b-4df7-97c2-6a62be8399f9">物理网卡收发数据的流程</a></li>
<li><a href="#h:145fd559-a510-4e27-b959-ab0b0392a57a">虚拟网卡设备</a></li>
<li><a href="#h:ac59e8eb-d6f6-467a-96f0-fb9b0be8f2a8">虚拟网卡和物理网卡的对比</a></li>
</ul>
</li>
<li><a href="#h:c2f1b79c-50cd-487e-bd83-b0184ab5dd11">虚拟网络设备 tap/tun 原理解析</a>
<ul>
<li><a href="#h:742b861c-9aab-4a1a-ad70-766c1a4113ee">linux的2种虚拟网络设备：TUN与TAP</a></li>
<li><a href="#h:4fbaa6e3-950a-4760-bdb0-8f2a31fa2e02">用户空间与内核空间的数据传输</a></li>
<li><a href="#h:752acebd-13d6-4a75-ac58-6bc467eda632">tap/tun 和网络协议栈的数据传输</a></li>
<li><a href="#h:7a7840c1-e3ed-4765-a2c1-632c58ca990e">tap/tun 的区别</a></li>
<li><a href="#h:8818ba82-3deb-4790-836c-dc946e89dd58">tap/tun 的应用</a></li>
</ul>
</li>
<li><a href="#h:fdf02f96-8773-4b17-8cea-528e615b18b6">网络虚拟化技术tap+bridge</a></li>
<li><a href="#h:74ec7291-dcfc-485c-a6be-febe433d8d99">网络虚拟化技术macvtap+brdige</a></li>
<li><a href="#h:7f7d2dc2-881f-4df2-85fb-07328074f9a1">网络虚拟化技术veth-pair+brdige</a></li>
</ul>
</li>
<li><a href="#h:673ee247-f4ab-4595-a1fc-42608befae16">网络测试诊断工具</a>
<ul>
<li><a href="#h:14ae64a0-5fc2-40ef-9620-fafe32af3071">测试网络连通性</a>
<ul>
<li><a href="#h:33224ebe-a0fe-43b6-9dbc-25578659225a">ping</a></li>
<li><a href="#h:9c923c9f-7494-40b7-a141-e16cd1b3b8c4">htping</a></li>
<li><a href="#h:b03ffb85-175a-4732-bf3b-21a26d1fe884">httpstat</a></li>
<li><a href="#h:3b775cea-b4e1-4396-9ca0-2487bce64a78">查看本地主机访问公网时使用的IP</a></li>
<li><a href="#h:28a0254b-ceb5-45cb-b359-d52d9fa1702b">fping</a></li>
</ul>
</li>
<li><a href="#h:96f80859-2f66-4edc-809e-e2f00281de88">显示正确的路由表</a>
<ul>
<li><a href="#h:1127dbbf-3f98-4c6a-9e06-84fadec1e865">ip route</a></li>
</ul>
</li>
<li><a href="#h:5e92fda8-da0a-4445-b4b1-3a0596c268bc">跟踪路由</a>
<ul>
<li><a href="#h:ecbe81a7-60bb-4242-9d4a-4c90db9aab9a">traceroute</a></li>
<li><a href="#h:68137a44-f003-4f94-a1fc-c5894ab1c17e">tracepath</a></li>
<li><a href="#h:b146fc47-d46e-4ab2-bfcd-474cfedc83b2">mtr</a></li>
</ul>
</li>
<li><a href="#h:cb5e43e1-3c1d-44b3-837e-9bdd821438ac">确定名称服务器使用</a>
<ul>
<li><a href="#h:ae01c237-4657-40fb-ab71-74bcd818c821">nslookup</a></li>
<li><a href="#h:c65c4759-4009-4e85-9abd-b139385e8fb7">host</a></li>
<li><a href="#h:9492812b-195f-40a1-86c3-adb387d5a627">dig</a></li>
</ul>
</li>
<li><a href="#h:e022fc79-1544-41ae-b09f-500e481843ba">抓包工具</a>
<ul>
<li><a href="#h:8aa2e384-9b78-4d63-81d7-8716782b78e8"><code>tcpdump</code></a></li>
<li><a href="#h:1aac6b2b-ebd5-4f18-b680-f1dad4b7d536">wireshark</a></li>
</ul>
</li>
<li><a href="#h:3df0e07c-bd45-4c52-983b-99cf8527255b">安全扫描工具</a>
<ul>
<li><a href="#h:d3b14673-9bab-476d-9f1d-9dea34fe46af">nmap</a></li>
<li><a href="#h:c21a1969-9af7-4b99-9cc5-aa2b70453543">netcat</a></li>
<li><a href="#h:4431fb31-91ad-4a00-9864-363c45b41de9">流量控制工具 tc</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../index.html">Linux</a></li>
</ul>


<p>
网络协议和管理 内容概述
</p>

<ul class="org-ul">
<li>网络概念</li>
<li>OSI模型</li>
<li>网络设备</li>
<li>TCP/IP</li>
<li>IP地址规划</li>
<li>配置网络</li>
<li>多网卡绑定</li>
<li>网桥</li>
<li>测试网络</li>
<li>网络工具</li>
</ul>
<section id="outline-container-h:6c3438a4-a4c3-4b8d-a04e-6cac42acb2a6" class="outline-2">
<h2 id="h:6c3438a4-a4c3-4b8d-a04e-6cac42acb2a6">网络基础</h2>
<div class="outline-text-2" id="text-h:6c3438a4-a4c3-4b8d-a04e-6cac42acb2a6">
</div>
<div id="outline-container-h:91c51f52-3412-4b59-a189-b5d608172554" class="outline-3">
<h3 id="h:91c51f52-3412-4b59-a189-b5d608172554">网络概念</h3>
<div class="outline-text-3" id="text-h:91c51f52-3412-4b59-a189-b5d608172554">
<p>
计算机网络是一组计算机或网络设备通过有形的线缆或无形的媒介如无线，连接
起来，按照一定的规则，进行通信的集合。
</p>


<figure id="orgd8e81b8">
<img src="images/image-20210126185118404.png" alt="image-20210126185118404.png" width="50%">

</figure>

<p>
网络功能和优点
</p>

<ul class="org-ul">
<li>数据和应用程序</li>
<li>资源</li>
<li>网络存储</li>
<li>备份设备</li>
</ul>

<p>
作用范围分类
</p>

<ul class="org-ul">
<li>广域网(WAN,Wide Area Network)</li>
<li>城域网(MAN,Metropolitan Area Network)</li>
<li>局域网(LAN,Local Area Network)</li>
</ul>
</div>
</div>
<div id="outline-container-h:53b66a91-d454-4d00-8af8-c3761923305e" class="outline-3">
<h3 id="h:53b66a91-d454-4d00-8af8-c3761923305e">常见的网络物理组件</h3>
<div class="outline-text-3" id="text-h:53b66a91-d454-4d00-8af8-c3761923305e">

<figure id="org785c75e">
<img src="images/image-20210126185131722.png" alt="image-20210126185131722.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:b74150c3-9393-4569-ae56-463f9ada95d7" class="outline-3">
<h3 id="h:b74150c3-9393-4569-ae56-463f9ada95d7">网络应用程序</h3>
<div class="outline-text-3" id="text-h:b74150c3-9393-4569-ae56-463f9ada95d7">
</div>
<div id="outline-container-h:2559ccba-ba2e-4a2a-b2fa-b888502667f2" class="outline-4">
<h4 id="h:2559ccba-ba2e-4a2a-b2fa-b888502667f2">各种网络应用</h4>
<div class="outline-text-4" id="text-h:2559ccba-ba2e-4a2a-b2fa-b888502667f2">
<ul class="org-ul">
<li>Web 浏览器（Chrome、IE、Firefox等）</li>
<li>即时消息（QQ、微信、钉钉等）</li>
<li>电子邮件（Outlook、foxmail 等）</li>
<li>协作（视频会议、VNC、Netmeeting、WebEx 等）</li>
<li>web网络服务（apache，nginx，IIS）</li>
<li>文件网络服务（ftp ，nfs，samba）</li>
<li>数据库服务（ MySQL，MariaDB，MongoDB)</li>
<li>中间件服务（Tomcat，JBoss）</li>
<li>安全服务（Netfilter）</li>
</ul>
</div>
</div>
<div id="outline-container-h:73bffde4-e281-4d5c-be2b-383496620d1c" class="outline-4">
<h4 id="h:73bffde4-e281-4d5c-be2b-383496620d1c">应用程序对网络的要求</h4>
<div class="outline-text-4" id="text-h:73bffde4-e281-4d5c-be2b-383496620d1c">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">程序类型</td>
<td class="org-left">场景</td>
<td class="org-left">特点</td>
<td class="org-left">对网络要求</td>
</tr>

<tr>
<td class="org-left">批处理应用程序</td>
<td class="org-left">迅雷下载</td>
<td class="org-left">无需直接人工交互</td>
<td class="org-left">带宽很重要，但并非关键性因素</td>
</tr>

<tr>
<td class="org-left">交互式应用程序</td>
<td class="org-left">电商网站</td>
<td class="org-left">人机交互</td>
<td class="org-left">等待页面结果，响应时间影响用户体验</td>
</tr>

<tr>
<td class="org-left">实时程序</td>
<td class="org-left">视频聊天、直播</td>
<td class="org-left">人与人的交互</td>
<td class="org-left">端到端的延时至关重要</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-h:090450f7-1895-45c5-8d61-6598e1053fd7" class="outline-3">
<h3 id="h:090450f7-1895-45c5-8d61-6598e1053fd7">网络的特征</h3>
<div class="outline-text-3" id="text-h:090450f7-1895-45c5-8d61-6598e1053fd7">
<ul class="org-ul">
<li>速度</li>
<li>成本</li>
<li>安全性</li>
<li>可用性</li>
<li>可扩展性</li>
<li>可靠性</li>
<li>拓扑</li>
</ul>
</div>
<div id="outline-container-h:bef932f7-c48a-42aa-8d37-d1c7fe1dffb8" class="outline-4">
<h4 id="h:bef932f7-c48a-42aa-8d37-d1c7fe1dffb8">速度(带宽)</h4>
<div class="outline-text-4" id="text-h:bef932f7-c48a-42aa-8d37-d1c7fe1dffb8">
<p>
在计算机网络或者是网络运营商中，一般带宽速率的单位用bps(或b/s)表示；
</p>

<p>
bps是bits per second的缩写，表示比特/秒；即表示每秒传输多少位信息；
</p>

<p>
所以运营商所说的1M带宽的意思是1Mbps(兆比特每秒，不是兆字节每秒);
</p>

<p>
100bps = 100/8 B
</p>
</div>
</div>
<div id="outline-container-h:10c0cbf3-1aad-49c0-b599-90dec1fbc11d" class="outline-4">
<h4 id="h:10c0cbf3-1aad-49c0-b599-90dec1fbc11d">网络拓扑</h4>
<div class="outline-text-4" id="text-h:10c0cbf3-1aad-49c0-b599-90dec1fbc11d">
<p>
拓扑结构一般是指由点和线排列成的几何图形
</p>

<p>
计算机网络的拓扑结构是指一个网络的通信链路和计算机结点相互连接构成的几何图形
</p>

<p>
<b>拓扑分类</b>
</p>

<ul class="org-ul">
<li><p>
物理拓扑描述了物理设备的布线方式
</p>

<p>
网络的物理拓扑是设备和电缆的物理布局。必须选择与需要安装的电缆类型匹配的恰当的物理拓扑。
</p>
<ul class="org-ul">
<li>拉网线</li>
</ul></li>

<li><p>
逻辑拓扑描述了信息在网络中流动的方式
</p>

<p>
网络的逻辑拓扑表示信号从网络一个点传输到另一个点的逻辑路径。也就是说，数据访问网络介质，并通过网络介质传输数据包的方式。
</p></li>
</ul>

<p>
<b>拓扑结构分类</b>
</p>


<figure id="orgc758f10">
<img src="./images/img_20241014_113351.png" alt="img_20241014_113351.png" width="50%">

</figure>


<ul class="org-ul">
<li><p>
总线拓扑：所有设备均可接收信号
</p>

<p>
总线拓扑通常也称为线性总线，总线拓扑中的所有设备均由一条线缆进行连接。
</p>

<p>
在总线拓扑中，一条线缆从一台设备延伸到另一设备，类似于城市中的公交线
路，主线段的末端必须采用终结端，当信号到法线路或线缆末端时，终结读将
吸收信号。如果不具备终结端，表示数据的电子信号将在线缆末端弹回，导致
网络出错。
</p></li>

<li><p>
环拓扑：信号绕环传输，单一故障点
</p>

<p>
在这种拓扑结构中，网络上的所有设备都以环的形式连接。环形拓扑不需要终
止的开始端或结束端。数据的传输方式不同于总线拓扑。其中一种实施形式为：
“令牌”沿环移动，并在每台设备处停止。如果一台设备希望传输数据，则会
在令牌中添加数据和目标地址。随后，令牌继续沿环移动，直至最终找到目标
设备，目标设备将从令牌中获取数据。这类方法的优势在于，数据包不会发生
冲突。环形拓扑分为两种：单环和双环。
</p></li>

<li><p>
单环拓扑：信号绕环传输，单一故障点
</p>

<p>
在单环拓扑中，网络上的所有设备共用一条线缆，数据单向传输。各设备等候
轮到自己时再通过网络发送数据。但是，单环拓扑可能存在单一故障点的问题，
一个故障就可能导致整个单环拓扑停止工作。
</p></li>

<li><p>
双环拓扑：信号沿相反方向传输，比单环的复原能力更强
</p>

<p>
在双环拓扑中，两个环形允许双向传输数据。这种设置能提供冗余(容错能力)。
也就是说，如果一个环发生故障，数据仍可在另一个环上传输。
</p></li>

<li><p>
星形和扩展星形拓扑
</p>

<p>
星形拓扑是以太网LAN中最常见的物理拓扑。在星形网络扩展为包含连接主要
网络设备的附加网络设备时，即称其为扩展星形拓扑。
</p>

<ul class="org-ul">
<li><p>
星型拓扑：通过中心点传输，单一故障点
</p>

<p>
星形拓扑将表现为车轮轮辐的形式，它包含一个中央连接点，该点是集线器、
交换机或路由器等设备，所有线缆段均汇集于这一点，网络上的所有设备均使
用自己的线缆连接到中央设备。
</p></li>

<li><p>
扩展星型拓扑：比星型拓扑的复原能力更强
</p>

<p>
扩展星形拓扑的一种常见部署方式就是分层设计，例如WAN、企业LAN或园区LAN.
</p>

<p>
纯粹的扩展星形拓扑的问题在于，如果中央节点发生故障，大部分网络就会
被隔高。因此，大多数扩展星形拓扑都采用一组独立连接设备之外的元余连
接，以避免在设备发生故障时造成隔商。
</p></li>
</ul></li>

<li><p>
网状和部分网状拓扑
</p>

<p>
网状拓扑提供了星形拓扑中设备间的冗余。网络可以是完全网状的，具体取决于所需冗余级别。
这种类型的拓扑有助于提高网络的可用性和可靠性，但是提高成本，也会制约可扩展性。
</p>

<ul class="org-ul">
<li><p>
全网状拓扑：容错能力强，实施成本高
</p>

<p>
全网状拓扑将所有设备(节点)彼此相连，以实现冗余和容错能力，其实施成
本高、难度大。但这种拓扑的容错能力最强，因为任何一条链路的故障都不
会影响网络的连通性.
</p>

<p>
连通线路计算公式:n(n-1)/2。
</p>

<pre class="example" id="org4152a88">
A  AB AC
B BC
C
3=3(3-1/2)

A AB AC AD
B BC BD
C CD
D
6=4(4-1)/2
</pre></li>

<li><p>
部分网状拓扑：在容错能力与成本之间寻求平衡
</p>

<p>
在这种拓扑中，只有重要节点的设备与其它设备具有直接一一相连的线路，对
于其它设备的数据传输，需要从其它节点中继，这种设计有一定的冗余和容
错能力,也降低了全网状拓扑结构的成本和实施难度。
</p></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:ccaa19e7-e0b7-4918-954c-8522374c5b6f" class="outline-3">
<h3 id="h:ccaa19e7-e0b7-4918-954c-8522374c5b6f">网络标准</h3>
<div class="outline-text-3" id="text-h:ccaa19e7-e0b7-4918-954c-8522374c5b6f">
</div>
<div id="outline-container-h:6ca2fc1f-e8a1-4ec6-8512-2879d6a8a978" class="outline-4">
<h4 id="h:6ca2fc1f-e8a1-4ec6-8512-2879d6a8a978">网络标准和分层</h4>
<div class="outline-text-4" id="text-h:6ca2fc1f-e8a1-4ec6-8512-2879d6a8a978">
<p>
旧模型：专有产品，由一个厂商控制应用程序和嵌入的软件
</p>

<p>
基于标准的模型：多厂商软件，分层方法
</p>

<p>
<b>层次划分的必要性</b>
</p>

<p>
计算机网络是由许多硬件、软件和协议交织起来的复杂系统。由于网络设计十分
复杂，如何设计、组织和实现计算机网络是一个挑战，必须要采用科学有效的方
法
</p>

<p>
<b>层次划分的方法</b>
</p>

<ul class="org-ul">
<li>网络的第一层应当具有相对独立的功能</li>
<li>梳理功能之间的关系，使一个功能可以为实现另一个功能提供必要的服务，从
而形成系统的层次结构</li>
<li>为提高系统的工作效率，相同或相近的功能仅在一个层次中实现，而且尽可能
在较高的层次中实现</li>
<li>每一层只为相邻的上一层提供服务</li>
</ul>

<p>
<b>层次划分的优点</b>
</p>

<ul class="org-ul">
<li>各层之间相互独立，每一层只实现一种相对独立的功能，使问题复杂程度降低</li>
<li>灵活性好，各层内部的操作不会影响其他层</li>
<li>结构上可分割开，各层之间都可以采用最合适的技术来实现</li>
<li>易于实现和维护，因为整个系统已被分解成相对独立的子系统</li>
<li>能促进标准化工作，因为每一层的功能及其提供的服务都有了精确的说明</li>
</ul>
</div>
</div>
<div id="outline-container-h:98243d37-26cd-45af-b7c2-0279fca3581f" class="outline-4">
<h4 id="h:98243d37-26cd-45af-b7c2-0279fca3581f">开放系统互联 OSI</h4>
<div class="outline-text-4" id="text-h:98243d37-26cd-45af-b7c2-0279fca3581f">
<p>
OSI七层的记忆口诀
</p>
<pre class="example" id="org2b01659">
ALL People Seem To Need Data Process (物数网传会表应)
</pre>

<table>


<colgroup>
<col  class="org-right">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-right">序号</td>
<td class="org-left">名称</td>
<td class="org-left">英文</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">应用层</td>
<td class="org-left">Application</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">表示层</td>
<td class="org-left">Presentation</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">会话层</td>
<td class="org-left">Session</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">传输层</td>
<td class="org-left">Transport</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">网络层</td>
<td class="org-left">Network</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">数据链路层</td>
<td class="org-left">Data Link</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">物理层</td>
<td class="org-left">Physical</td>
</tr>
</tbody>
</table>

<p>
在制定计算机网络标准方面，起着重大作用的两大国际组织是：国际电信联盟电
信标准化部门，与国际标准组织（ISO），虽然它们工作领域不同，但随着科学
技术的发展，通信与信息处理之间的界限开始变得比较模糊，这也成了国际电信
联盟电信标准化部门和ISO共同关心的领域。1984年，ISO发布了著名的OSI(Open
System Interconnection)标准，它定义了网络互联的7层框架，物理层、数据链
路层、网络层、传输层、会话层、表示层和应用层），即OSI开放系统互连参考
模型
</p>

<p>
<b>OSI 模型的七层结构</b>
</p>


<figure id="org834aa32">
<img src="./images/img_20250312_114550.png" alt="img_20250312_114550.png" width="50%">

</figure>



<figure id="orgbb3ccd3">
<img src="./images/img_20250312_160212.png" alt="img_20250312_160212.png" width="50%">

</figure>


<dl class="org-dl">
<dt>第7层 应用层</dt><dd>应用层（Application Layer）提供为应用软件而设的接口，以设置与另一应
用软件之间的通信。例如:HTTP、HTTPS、FTP、TELNET、SSH、SMTP、POP3、
MySQL等</dd>

<dt>第6层 表示层</dt><dd>主条目：表示层（Presentation Layer）把数据转换为能与接收者的系统格式
兼容并适合传输的格式</dd>

<dt>第5层 会话层</dt><dd>会话层（Session Layer）负责在数据传输中设置和维护电脑网络中两台电脑
之间的通信连接。</dd>

<dt>第4层 传输层</dt><dd>传输层（Transport Layer）把传输表头（TH）加至数据以形成数据包。传输
表头包含了所使用的协议等发送信息。例如:传输控制协议（TCP）等。</dd>

<dt>第3层 网络层</dt><dd><p>
网络层（Network Layer）决定数据的路径选择和转寄，将网络表头（NH）加
至数据包，以形成报文。网络表头包含了网络数据。例如:互联网协议（IP）
等。
</p>

<p>
代表：路由器
</p></dd>

<dt>第2层 数据链接层</dt><dd><p>
数据链路层（Data Link Layer）负责网络寻址、错误侦测和改错。当表头和
表尾被加至数据包时，会形成信息框（Data Frame）。数据链表头（DLH）是
包含了物理地址和错误侦测及改错的方法。数据链表尾（DLT）是一串指示数
据包末端的字符串。例如以太网、无线局域网（Wi-Fi）和通用分组无线服务
（GPRS）等。分为两个子层：
</p>

<p>
逻辑链路控制（logical link control，LLC）子层和介质访问控制（Media
access control，MAC）子层
</p>

<p>
代表：交换机，网卡
</p></dd>

<dt>第1层 物理层</dt><dd><p>
物理层（Physical Layer）在局部局域网上传送数据帧（Data Frame），它负
责管理电脑通信设备和网络媒体之间的互通。包括了针脚、电压、线缆规范、
集线器、中继器、网卡、主机接口卡等
</p>

<p>
代表：集线器hub，网线
</p></dd>
</dl>
</div>
</div>
<div id="outline-container-h:d3e7d2ed-1c3a-4a45-b0f1-3a3653e13dd0" class="outline-4">
<h4 id="h:d3e7d2ed-1c3a-4a45-b0f1-3a3653e13dd0">网络的通信过程</h4>
<div class="outline-text-4" id="text-h:d3e7d2ed-1c3a-4a45-b0f1-3a3653e13dd0">
</div>
<div id="outline-container-h:166a19fd-4af1-496f-9350-d681428d9325" class="outline-5">
<h5 id="h:166a19fd-4af1-496f-9350-d681428d9325">数据封装和数据解封</h5>
<div class="outline-text-5" id="text-h:166a19fd-4af1-496f-9350-d681428d9325">

<figure id="org0f9c60c">
<img src="images/image-20210126185235311.png" alt="image-20210126185235311.png" width="50%">

</figure>


<figure id="orgbe50b1c">
<img src="images/TCPIP工作原理.gif" alt="TCPIP工作原理.gif" width="50%">

<figcaption><span class="figure-number">Figure 4: </span>TCPIP工作原理</figcaption>
</figure>
</div>
</div>
<div id="outline-container-h:a9b4c589-ca54-43b3-a695-319bcb94450f" class="outline-5">
<h5 id="h:a9b4c589-ca54-43b3-a695-319bcb94450f">协议数据单元 PDU</h5>
<div class="outline-text-5" id="text-h:a9b4c589-ca54-43b3-a695-319bcb94450f">

<figure id="org43b876d">
<img src="images/image-20210126185248061.png" alt="image-20210126185248061.png" width="50%">

</figure>

<p>
PDU: Protocol Data Unit,协议数据单元是指对等层次之间传递的数据单位
</p>

<ul class="org-ul">
<li>物理层的 PDU是数据位 bit</li>
<li>数据链路层的 PDU是数据帧 frame</li>
<li>网络层的PDU是数据包 packet</li>
<li>传输层的 PDU是数据段 segment</li>
<li>其他更高层次的PDU是消息 message</li>
</ul>

<p>
统称为数据报文、数据包，只不过在不同的层有自己的专业术语
</p>
</div>
</div>
<div id="outline-container-h:83eeab5e-d5d5-4716-ba14-df37aedd92fd" class="outline-5">
<h5 id="h:83eeab5e-d5d5-4716-ba14-df37aedd92fd">三种通讯模式</h5>
<div class="outline-text-5" id="text-h:83eeab5e-d5d5-4716-ba14-df37aedd92fd">
<ul class="org-ul">
<li>unicast 单播，1对1</li>
<li>broadcast 广播，目标所有</li>
<li>multicast 多播，组播，目标设备多个</li>
</ul>



<figure id="org5451db6">
<img src="images/image-20210126185258589.png" alt="image-20210126185258589.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">ip a</span>
2: eth0: &lt;BROADCAST&#65288;&#24191;&#25773;&#65289;,MULTICAST&#65288;&#22810;&#25773;&#65289;,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 52:54:00:12:84:94 brd ff:ff:ff:ff:ff:ff
    inet 10.0.1.86/22 brd 10.0.3.255 scope global noprefixroute eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::5054:ff:fe12:8494/64 scope link 
       valid_lft forever preferred_lft forever
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#21040;&#24403;&#21069;&#30340;&#32593;&#21345; eth0 &#21363;&#25903;&#25345;&#24191;&#25773;&#20063;&#25903;&#25345;&#22810;&#25773;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:77e74e8a-9dfc-4fef-9011-f7d0df1d9090" class="outline-5">
<h5 id="h:77e74e8a-9dfc-4fef-9011-f7d0df1d9090">冲突域和广播域</h5>
<div class="outline-text-5" id="text-h:77e74e8a-9dfc-4fef-9011-f7d0df1d9090">
<p>
冲突域：两个网络设备同时发送数据,如果发生了冲突,则两个设备处于同一个冲
突域,反之,则各自处于不同的冲突域
</p>

<p>
广播域：一个网络设备发送广播，另一个设备收到了,则两个设备处于同一个广
播域,反之,则各自处于不同的广播域
</p>

<p>
<b>冲突域和广播域的区别</b>
</p>

<p>
<b>冲突域</b>
</p>

<p>
【概念】连接在同一导线上的所有工作站的集合，或者说是同一物理网段上所有
节点的集合或以太网上竞争同一带宽的节点集合。
</p>

<p>
【设备】第二层设备能划分冲突域。即交换机的每一个端口就是一个冲突域。
</p>

<ul class="org-ul">
<li>集线器Hub是物理层设备，不能划分冲突域。所以Hub下面连接的所有主机组成
一个冲突域。</li>
</ul>

<p>
冲突域指的是会产生冲突的最小范围，在计算机和计算机通过设备互联时，会建
立一条通道，如果这条通道只允许瞬间一个数据报文通过，那么在同时如果有两
个或更多的数据报文想从这里通过时就会出现冲突了。
</p>

<p>
冲突域的大小可以衡量设备的性能，多口hub的冲突域也只有一个，即所有的端
口上的数据报文都要排队等待通过。
</p>

<p>
而交换机就明显的缩小了冲突域的大小，使到每一个端口都是一个冲突域，即一
个或多个端口的高速传输不会影响其它端口的传输，因为所有的数据报文不同都
按次序排队通过，而只是到同一端口的数据才要排队。
</p>

<p>
<b>广播域</b>
</p>

<p>
【概念】接收同样广播消息的节点的集合。简单的说如果站点发出一个广播信号，
所有能接收收到这个信号的设备范围称为一个广播域。
</p>

<p>
【设备】第三层设备能划分广播域。即路由器的每一个端口就是一个广播域。
</p>

<p>
如果一个数据报文的目标地址是这个网段的广播地址或者目标计算机的MAC地址
是FF-FF-FF-FF-FF-FF，那么这个数据报文就会被这个网段的所有计算机接收并
响应，这就叫做广播。
</p>

<p>
通常广播用来进行ARP寻址等用途，但是广播域无法控制也会对网络健康带来严
重影响，主要是带宽和网络延迟。这种广播所能覆盖的范围就叫做广播域了，二
层的交换机是转发广播的，所以不能分割广播域，而路由器一般不转发广播，所
以可以分割或定义广播域。
</p>

<p>
网络互连设备可以将网络划分为不同的冲突域、广播域。但是，由于不同的网络
互连设备可能工作在OSI模型的不同层次上。因此，它们划分冲突域、广播域的
效果也就各不相同。
</p>

<p>
如中继器工作在物理层，网桥和交换机工作在数据链路层，路由器工作在网络层，
而网关工作在OSI模型的上三层。而每一层的网络互连设备要根据不同层次的特
点完成各自不同的任务。
</p>

<p>
<b>区别</b> ：
</p>

<ul class="org-ul">
<li>Hub设备既不隔离冲突，也不隔离广播。</li>
<li>交换机隔离冲突，但不隔离广播。</li>
<li>路由器不仅隔离冲突，而且隔离广播。</li>
<li>在同一冲突域的设备必在同一广播域。</li>
<li>全双工模式下不会发生冲突。</li>
</ul>

<p>
计算例题
</p>


<figure id="org3b84e8b">
<img src="images/image-20210126185316005.png" alt="image-20210126185316005.png" width="20%">

</figure>

<p>
分析：没有路由器等第三层设备，所以只有一个广播域；第二次设备交换机，4
个端口直连，有4个冲突域。
</p>


<figure id="orgc8c3f25">
<img src="images/image-20210126185327264.png" alt="image-20210126185327264.png" width="20%">

</figure>

<p>
分析：路由器的3个端口连接3个Bub,3个广播域；每个Hub下面的所有主机组成一个冲突域
</p>


<figure id="org98d7fb7">
<img src="images/image-20210126185351663.png" alt="image-20210126185351663.png" width="20%">

</figure>

<p>
分析：路由器3个端口，3个广播域；每个交换机3个端口连接3太主机共6个冲突
域，Hub下面所有主机组成一个冲突域。
</p>

<p>
关键： <code>路由器到交换机之间还是存在冲突域的，所以到两个交换机分别有2个冲突域。（6+1+2)</code>
</p>


<figure id="orgf0e99ad">
<img src="images/image-20210126185406228.png" alt="image-20210126185406228.png" width="20%">

</figure>

<ul class="org-ul">
<li>答：2个广播域，8个冲突域。</li>
</ul>
</div>
</div>
<div id="outline-container-h:91d40a4a-0ab8-4dae-a2ab-1c46e54b212f" class="outline-5">
<h5 id="h:91d40a4a-0ab8-4dae-a2ab-1c46e54b212f">三种通讯机制</h5>
<div class="outline-text-5" id="text-h:91d40a4a-0ab8-4dae-a2ab-1c46e54b212f">

<figure id="org756239c">
<img src="images/image-20210126185418528.png" alt="image-20210126185418528.png" width="50%">

</figure>

<ul class="org-ul">
<li>单工通信：只有一个方向的通信。如收音机</li>
<li>半双工通信：通信双方都可以发送和接收信息，但不能同时发送，也不能同时接收。如对讲机</li>
<li>全双工通信：通信双方可以同时发送和同时接收。如手机</li>
</ul>

<p>
范例：查看双工和速度
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@localhost ~]# mii-tool eth0
eth0: negotiated 100baseTx-FD, link ok
<span style="color: #b22222;">#</span><span style="color: #b22222;">FD &#20840;&#21452;&#24037;&#65292;100 &#30334;&#20806;&#65292;base &#22522;&#24102;&#20256;&#36755;&#65292;T &#21452;&#32478;&#32447;, link ok &#34920;&#31034;&#32593;&#32476;&#29366;&#24577;&#27491;&#24120;</span>

[root@localhost ~]# mii-tool -v eth0
eth0: negotiated 100baseTx-FD, link ok  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24403;&#21069;&#32593;&#21345;&#29366;&#24577;&#27809;&#38382;&#39064;</span>
product info: vendor 00:07:32, model 17 rev 5
basic mode:     autonegotiation enabled
basic status: autonegotiation complete, link ok
capabilities: 100baseTx-FD 100baseTx-HD 10baseT-FD 10baseT-HD
advertising: 100baseTx-FD 100baseTx-HD 10baseT-FD 10baseT-HD flow-control
link partner: 100baseTx-FD 100baseTx-HD 10baseT-FD 10baseT-HD
Tx: &#21452;&#32478;&#32447;
FD&#65306; &#20840;&#21452;&#24037;
HD&#65306;&#21322;&#21452;&#24037;
capabilities: 100baseTx-FD(&#25903;&#25345;1000&#20806;&#20840;&#21452;&#24335;&#27169;&#24335;) 100baseTx-HD&#65288;&#25903;&#25345;&#30334;&#20806;&#21322;&#21452;&#24037;&#65289; 10baseT-FD 10baseT-HD

[root@centos8 ~]#ethtool -i eth0
driver: vmxnet3
version: 1.4.16.0-k-NAPI               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#21345;&#39537;&#21160;</span>
firmware-version:
expansion-rom-version:
bus-info: 0000:03:00.0
supports-statistics: yes
supports-test: no
supports-eeprom-access: no
supports-register-dump: yes
supports-priv-flags: no

[root@centos8 ~]#ethtool eth0
Settings for eth0:
Supported ports: [ TP ]                                    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#21345;&#25509;&#21475;&#25903;&#25345;&#31867;&#22411; TP &#34920;&#31034;&#21452;&#32478;&#32447;</span>
Supported link modes:     1000baseT/Full        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25903;&#25345;&#30340;&#24037;&#20316;&#27169;&#24335;</span>
                                            10000baseT/Full
Supported pause frame use: No
Supports auto-negotiation: No                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#25903;&#25345;&#33258;&#21160;&#21327;&#21830;</span>
Supported FEC modes: Not reported
Advertised link modes: Not reported
 Advertised pause frame use: No
Advertised auto-negotiation: No                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#21327;&#21830;&#29992;&#20840;&#21452;&#24037;&#36824;&#26159;&#21322;&#21452;&#24037;</span>
Advertised FEC modes: Not reported
Speed: 10000Mb/s                                          <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24403;&#21069;&#36895;&#24230;</span>
Duplex: Full                                                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24037;&#20316;&#27169;&#24335;&#65292;&#20840;&#21452;&#24037;</span>
Port: Twisted Pair                                            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25509;&#21475;&#31867;&#22411;&#65292;Twisted Pair &#34920;&#31034;&#21452;&#32478;&#32447;, FIBRE&#26159;&#20809;&#32420;</span>
PHYAD: 0
Transceiver: internal
Auto-negotiation: off
MDI-X: Unknown
Supports Wake-on: uag                                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#25903;&#25345;wake on LAN&#65292; d &#19981;&#25903;&#25345;&#65292;g&#25903;&#25345;</span>
Wake-on: d                                                    <span style="color: #b22222;">#</span><span style="color: #b22222;">Wake On LAN&#26159;&#21542;&#21551;&#29992;&#65292;d&#31105;&#29992;&#65292;g&#21551;&#29992;</span>
Link detected: yes                                         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#36830;&#25509;&#21040;&#32593;&#32476;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">1000baseT/Full&#65306; &#20840;&#21452;&#24037;</span>

[root@centos8 ~]#mii-tool     eth0
SIOCGMIIPHY on <span style="color: #8b2252;">'eth0'</span> failed: Operation not supported

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;&#26029;&#24320;&#30340;&#29366;&#24577;</span>
[root@centos8 ~]#mii-tool -v eth1
eth1: no link
Link detected: no
[root@centos8 ~]#ip link

3: eth1: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc fq_codel state DOWN
</pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:759c8304-bed4-418f-9b7b-b83feb537921" class="outline-2">
<h2 id="h:759c8304-bed4-418f-9b7b-b83feb537921">局域网 Local Area Network</h2>
<div class="outline-text-2" id="text-h:759c8304-bed4-418f-9b7b-b83feb537921">
</div>
<div id="outline-container-h:57c646ca-54ff-40d1-9673-3c00fd22c9ac" class="outline-3">
<h3 id="h:57c646ca-54ff-40d1-9673-3c00fd22c9ac">概述</h3>
<div class="outline-text-3" id="text-h:57c646ca-54ff-40d1-9673-3c00fd22c9ac">
</div>
<div id="outline-container-h:4167b2dc-d875-4917-a07b-897c10f1770a" class="outline-4">
<h4 id="h:4167b2dc-d875-4917-a07b-897c10f1770a">特点</h4>
<div class="outline-text-4" id="text-h:4167b2dc-d875-4917-a07b-897c10f1770a">
<ul class="org-ul">
<li>网络为一个单位所拥有</li>
<li>地理范围和站点数目均有限</li>
</ul>
</div>
</div>
<div id="outline-container-h:46c9f224-85d9-41b2-b4c1-323c00454e3a" class="outline-4">
<h4 id="h:46c9f224-85d9-41b2-b4c1-323c00454e3a">主要功能</h4>
<div class="outline-text-4" id="text-h:46c9f224-85d9-41b2-b4c1-323c00454e3a">
<p>
资源共享和数据通信
</p>
</div>
</div>
<div id="outline-container-h:cde2c391-566f-4274-84d1-181bd71bd821" class="outline-4">
<h4 id="h:cde2c391-566f-4274-84d1-181bd71bd821">优点</h4>
<div class="outline-text-4" id="text-h:cde2c391-566f-4274-84d1-181bd71bd821">
<ul class="org-ul">
<li>能方便地共享昂贵的外部设备、主机以及软件、数据。从一个站点可以访问全网</li>
<li>便于系统的扩展和逐渐演变，各设备的位置可灵活的调整和改变</li>
<li>提高系统的可靠性、可用性和易用性</li>
</ul>
</div>
</div>
<div id="outline-container-h:3ce873b4-ea0a-4f69-ac27-6c20ecb9dfa5" class="outline-4">
<h4 id="h:3ce873b4-ea0a-4f69-ac27-6c20ecb9dfa5">标准</h4>
<div class="outline-text-4" id="text-h:3ce873b4-ea0a-4f69-ac27-6c20ecb9dfa5">
<p>
IEEE于（国际电子电气工程师协会）1980年2月成立了局域网标准委员会（简称
IEEE802委员会），专门从事局域网标准化工作，并制定了IEEE802标准。802标
准所描述的局域网参考模型只对应OSI参考模型的数据链路层与物理层，它将数
据链路层划分为逻辑链路层LLC子层和介质访问控制MAC子层.
</p>

<p>
LLC子层负责向其上层提供服务;
</p>

<p>
MAC子层的主要功能包括数据帧的封装/卸装，帧的寻址和识别，帧的接收与发送，
链路的管理，帧的差错控制等。MAC子层的存在屏蔽了不同物理链路种类的差异
性。
</p>

<p>
<b>局域网标准</b>
</p>


<figure id="org7e4bc0f">
<img src="images/image-20210126185436707.png" alt="image-20210126185436707.png" width="50%">

</figure>

<pre class="example" id="orgea1da61">
（1） IEEE 802.1标准  局域网体系结构、网络互连、以及网络管理和性能测试
（2）IEEE 802.2标准  逻辑链路控制LLC子层功能与服务
（3）IEEE 802.3标准  带冲突检测的载波侦听多路访问CSMA/CD总线介质访问控制子层与物理层规范
（4）IEEE 802.4标准  令牌总线（Token Bus）介质访问控制子层与物理层规范
（5）IEEE 802.5标准  令牌环（Token Ring）介质访问控制子层与物理层规范
（6）IEEE 802.6标准  城域网MAN介质访问控制子层与物理层规范
（7）IEEE 802.7标准  宽带网络技术
（8）IEEE 802.8标准  光纤传输技术
（9）IEEE 802.9标准  综合语音与数据局域网（IVD LAN）技术
（10）IEEE 802.10标准  可互操作的局域网安全性规范（SILS）
（11）IEEE 802.11标准  无线局域网技术
（12）IEEE 802.12标准  优先度要求的访问控制方法
（13）IEEE 802.13标准  未使用
（14）IEEE 802.14标准  交互式电视网
（15）IEEE 802.15标准  无线个人局域网（WPAN）的MAC子层和物理层规范。代表技术为蓝牙（Bluetooth）
（16）IEEE 802.16标准  宽带无线局域网网络
（17）IEEE802.20标准  移动宽带无线接入系统(MBWA，Mobile Broadband Wireless Access)
（18）IEEE 802.22标准  无线地域网络（Wireless Regional Area Networks，WRAN）
</pre>


<p>
<b>无线网络标准</b>
</p>

<p>
中国国家无线网络标准：WAPI
</p>


<figure id="org5e4e275">
<img src="images/wifi.png" alt="wifi.png" width="50%">

</figure>

<p>
wifi历史：<a href="https://info.support.huawei.com/info-finder/encyclopedia/zh/WiFi.html">https://info.support.huawei.com/info-finder/encyclopedia/zh/WiFi.html</a>
</p>
</div>
</div>
</div>
<div id="outline-container-h:ad5398cb-b104-4143-897c-c9cb93f48eb2" class="outline-3">
<h3 id="h:ad5398cb-b104-4143-897c-c9cb93f48eb2">组网设备</h3>
<div class="outline-text-3" id="text-h:ad5398cb-b104-4143-897c-c9cb93f48eb2">

<figure id="orgdc0ccb6">
<img src="images/image-20210126185503651.png" alt="image-20210126185503651.png" width="50%">

</figure>
</div>
<div id="outline-container-h:ca715938-c9d4-4191-ad98-8f4742f874bf" class="outline-4">
<h4 id="h:ca715938-c9d4-4191-ad98-8f4742f874bf">网络线缆和接口</h4>
<div class="outline-text-4" id="text-h:ca715938-c9d4-4191-ad98-8f4742f874bf">

<figure id="org8ccd19f">
<img src="images/image-20210126185513683.png" alt="image-20210126185513683.png" width="50%">

</figure>

<ol class="org-ol">
<li>双绞线：俩俩搅合在一起。有屏蔽式双绞线和非屏蔽式双绞线，非屏蔽式双
绞线用得较多就是外面没有保持层。俩俩搅合在一起，作用抗干扰，因为线
和线之间如果是平行的，它们彼此之间传输数据时高低压变化会产生电磁干
扰，所以俩俩搅合在一起正好能抵消干扰。俩俩搅合在一起规律同一色系在
一起。RJ-45水晶头中线排序</li>
<li>同轴电缆：有线电视还在用，速度较慢。10Base2 中10表示10兆速度; base
表示基带(数字信号)传输；2表示最大设备的传输距离185米。传输距离超过
185米信号衰减就判断不出来了其高低电平就平了。基带表示数字信号，宽带
表示模拟信号</li>
</ol>
</div>
<div id="outline-container-h:95b93f07-4528-4eb8-9d1d-40f01188f77a" class="outline-5">
<h5 id="h:95b93f07-4528-4eb8-9d1d-40f01188f77a">网线标准</h5>
<div class="outline-text-5" id="text-h:95b93f07-4528-4eb8-9d1d-40f01188f77a">
<p>
上世纪80年代初，诞生了最早的网线标准（CAT）,这个标准一直沿用至今，主要
根据带宽和传输速率来区分，从一类网线CAT1-&#x2013;&#x2014;八类网线CAT8
</p>

<p>
1、一类网线：主要用于传输语音，不同于数据传输主要用于八十年代初之前的
电话线缆，已淘汰。
</p>

<p>
2、二类网线：传输带宽为1MHZ，用于语音传输，最高数据传输速率4Mbps，常见
于使用4Mbps规范令牌传递协议的旧的令牌网（Token Ring），已被淘汰
</p>

<p>
3、三类网线：该电缆的传输带宽16MHz，用于语音传输及最高传输速率为10Mbps
的数据传输，主要用于10BASE&#x2013;T，被ANSI/TIA-568.C.2作为最低使用等级。
</p>

<p>
4、四类网线：该类电缆的传输频率为20MHz，用于语音传输和最高传输速率
16Mbps（指的是16Mbit/s令牌环）的数据传输，主要用于基于令牌的局域网和
10BASE-T/100BASE-T。最大网段长为100m，采用RJ形式的连接器，未被广泛采用。
</p>

<p>
5、五类线：可追溯到1995年，传输带宽为100MHz，可支持10Mbps和=100Mbps传
输速率=（虽然现实中与理论值有一定差距），主要用于双绞线以太网
（10BASE-T/100BASE-T），目前仍可使用，不过在新网络建设中已经很难看到。
最大传输距离100米
</p>

<p>
6、超五类线：标准于2001年被提出，传输带宽为100MHz，近距离情况下传输速
率已可达=1000Mbps=。它具有衰减小，串扰少，比五类线增加了近端串音功率和
测试要求，所以它也成为了当前应用最为广泛的网线
</p>

<p>
7、六类线：继CAT5e之后，CAT6标准被提出，传输带宽为250MHz，最适用于传输
速率为1Gbps的应用。改善了在串扰以及回波损耗方面的性能，这一点对于新一
代全双工的高速网络应用而言是极重要的，还有一个特点是在4个=双绞线中间加
了十字形的骨架=。
</p>

<p>
8、超六类线：超六类线是六类线的改进版，发布于2008年，同样是
ANSI/TIA-568C.2和ISO/IEC 11801超六类/EA级标准中规定的一种双绞线电缆，
主要应用于万兆位网络中。传输频率500 MHz，最大传输速度也可达到=10Gbps=
，在外部串扰等方面有较大改善。
</p>

<p>
9、 七类线：该线是ISO/IEC 11801 7类/F级标准中于2002年认可的一种双绞线，
它主要为了适应万兆以太网技术的应用和发展。但它不再是一种非屏蔽双绞线了，
而是一种=屏蔽双绞线=，所以它的传输频率至少可达600 MHz，传输速率可达10
Gbps。
</p>

<p>
10、超七类线:相对于CAT7最大区别在于，支持的频率带宽提升到了1000MHz，在
国内而言，七类网线已经有很少地方使用了，超七类就更加没有广泛的进入人们
的生活，目前使用范围最广的是超五类、六类等网线
</p>

<p>
11、 八类线CAT8：相关标准由美国通信工业协会（TIA）TR-43委员会在2016年
正式发布，支持2000MHz带宽，支持40Gbps以太网络，主要应用于数据中心
</p>
</div>
</div>
<div id="outline-container-h:dfefafcf-cfa1-4889-9ccc-61b4fd68f3a8" class="outline-5">
<h5 id="h:dfefafcf-cfa1-4889-9ccc-61b4fd68f3a8">网线线序和规范</h5>
<div class="outline-text-5" id="text-h:dfefafcf-cfa1-4889-9ccc-61b4fd68f3a8">
<p>
<b>非屏蔽式双绞线Unshielded Twisted-Pair Cable UTP</b>
</p>

<p>
T568B(用的较多)和T568A
</p>


<figure id="orged1c7fb">
<img src="images/image-20210126185531175.png" alt="image-20210126185531175.png" width="50%">

</figure>

<p>
T568B：橙白、橙、绿白、蓝、蓝白、绿、棕白棕
</p>

<p>
橙蓝绿棕，蓝和绿前面线互换，蓝的前面不是蓝白是绿白，绿的前面是蓝白
</p>

<p>
<b>RJ-45 Connector和Jack</b>
</p>


<figure id="org499d43f">
<img src="images/image-20210126185544265.png" alt="image-20210126185544265.png" width="50%">

</figure>

<p>
<b>UTP直通线(Straight-Through)</b>
</p>

<p>
两边线序一样 Straight-Through Cable
</p>

<p>
再边一样服务器就无法通信了，交换机没事
</p>



<figure id="org4261502">
<img src="images/image-20210126185603702.png" alt="image-20210126185603702.png" width="50%">

</figure>

<p>
<b>UTP交叉线(Crossover)</b>
</p>


<figure id="orgd250210">
<img src="images/image-20210126185616802.png" alt="image-20210126185616802.png" width="50%">

</figure>

<p>
<b>UTP 直通线和交叉线</b>
</p>

<p>
目前的交换机服务器自动能识别
</p>


<figure id="org79149bd">
<img src="images/image-20210126185631060.png" alt="image-20210126185631060.png" width="50%">

</figure>

<p>
<b>双绞线针脚定义</b>
</p>

<p>
注：BI=双向数据 RX=接收数据 Receive Data TX=传送数据 Transmit Data
</p>


<figure id="org6a261a5">
<img src="images/image-20210126185643995.png" alt="image-20210126185643995.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:62cb532e-010f-4c46-b0ab-62da13ef1bb8" class="outline-5">
<h5 id="h:62cb532e-010f-4c46-b0ab-62da13ef1bb8">光纤和接口Fiber-Optic</h5>
<div class="outline-text-5" id="text-h:62cb532e-010f-4c46-b0ab-62da13ef1bb8">
<ul class="org-ul">
<li>Short wavelength (1000BASE-SX) 最远几百米</li>
<li>Long wavelength/long haul (1000BASE-LX/LH) 最远几公里</li>
<li>Extended distance (1000BASE-ZX) 最远上百公里</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:fa83fe9c-7ac1-4e7a-9d4b-bca0e421475b" class="outline-4">
<h4 id="h:fa83fe9c-7ac1-4e7a-9d4b-bca0e421475b">网络适配器</h4>
<div class="outline-text-4" id="text-h:fa83fe9c-7ac1-4e7a-9d4b-bca0e421475b">
<p>
网卡、光线模块
</p>


<figure id="org69fe065">
<img src="images/image-20210126185745725.png" alt="image-20210126185745725.png" width="50%">

</figure>


<figure id="org6c2677e">
<img src="images/image-20210126185757137.png" alt="image-20210126185757137.png" width="50%">

</figure>

<p>
网卡作用
</p>
<ul class="org-ul">
<li><p>
进行串行/并行转换
</p>

<p>
计算机内部可以并行处理32位、64位数据，但在网络中传输是串行1位1位传
</p></li>

<li>数据缓存 缓存到网卡的ram芯片，再复制到内核中</li>
<li>在计算机操作系统中安装设备驱动程序</li>
<li>实现以太网协议</li>
</ul>

<p>
网卡类型
</p>
<ul class="org-ul">
<li>按总线接口类型进行分类: 分为ISA网卡、PCI网卡、PCI-X 网卡、PCMCIA网卡和USB网卡等几种类型</li>
<li>按传输介质接口分类: 细同轴电缆的BNC接口网卡、粗同轴电缆AUI接口网卡、以太网双绞线RJ-45接口网卡、光纤F/O接口网卡、无线网卡等</li>
<li>按传输速率（带宽）分类: 10Mbps网卡、100Mbps以太网卡、10Mbps/100Mbps自适应网卡、1000Mbps千兆以太网卡、40Gbps自适应网卡等</li>
</ul>
</div>
</div>
<div id="outline-container-h:419a45d9-8616-45e7-abbf-bbf9a1242b35" class="outline-4">
<h4 id="h:419a45d9-8616-45e7-abbf-bbf9a1242b35">中继器和集线器</h4>
<div class="outline-text-4" id="text-h:419a45d9-8616-45e7-abbf-bbf9a1242b35">
</div>
<div id="outline-container-h:6455bb70-5e62-4328-840f-c1d29ec638e0" class="outline-5">
<h5 id="h:6455bb70-5e62-4328-840f-c1d29ec638e0">中继器 repeater</h5>
<div class="outline-text-5" id="text-h:6455bb70-5e62-4328-840f-c1d29ec638e0">
<p>
几乎看不到这种设备了
</p>

<p>
实际上是一种信号再生放大器，可将变弱的信号和有失真的信号进行整形与放大，
输出信号比原信号的强度将大大提高,中继器不解释、不改变收到的数字信息，
而只是将其整形放大后再转发出去
</p>

<p>
优点
</p>
<ul class="org-ul">
<li>易于操作</li>
<li>很短的等待时间</li>
<li>价格便宜</li>
<li>突破线缆的距离限制(100米)来扩展局域网段的距离</li>
<li>可用来连接不同的物理介质</li>
</ul>

<p>
缺点
</p>
<ul class="org-ul">
<li>采用中继器连接网络分支的数目要受具体的网络体系结构限制</li>
<li>中继器不能连接不同类型的网络</li>
<li>中继器没有隔离和过滤功能，无路由选择、交换、纠错／检错功能，一个分
支出现故障可能会影响到其他的每一个网络分支</li>
<li>使用中继器扩充网络距离是最简单最廉价的方法，但当负载增加时，网络性
能急剧下降，所以只有当网络负载很轻和网络时延要求不高的条件下才能使用</li>
</ul>
</div>
</div>
<div id="outline-container-h:98ced2be-1fa3-4fb7-82db-14ca8547db00" class="outline-5">
<h5 id="h:98ced2be-1fa3-4fb7-82db-14ca8547db00">集线器 hub</h5>
<div class="outline-text-5" id="text-h:98ced2be-1fa3-4fb7-82db-14ca8547db00">

<figure id="org3a200c9">
<img src="images/image-20210126185814052.png" alt="image-20210126185814052.png" width="50%">

</figure>

<p>
集线器（Hub）工作在物理层，是中继器的一种形式，是一种集中连接缆线的网
络组件，可以认为集线器是一个多端口的中继器，集线器能够提供多端口服务，
主要功能是对接收到的信号进行再生整形放大，以扩大网络的传输距离，同时把
所有节点集中在以它为中心的节点上
</p>

<p>
Hub并不记忆报文是由哪个MAC地址发出，哪个MAC地址在Hub的哪个端口
</p>

<p>
Hub的特点：
</p>

<ul class="org-ul">
<li>共享带宽</li>
<li>半双工</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:9cb88bf4-ec26-4689-9caa-86457ce3be53" class="outline-4">
<h4 id="h:9cb88bf4-ec26-4689-9caa-86457ce3be53">网桥和交换机</h4>
<div class="outline-text-4" id="text-h:9cb88bf4-ec26-4689-9caa-86457ce3be53">
</div>
<div id="outline-container-h:3060c7a5-b3d7-4b24-8de6-18999d3ae48d" class="outline-5">
<h5 id="h:3060c7a5-b3d7-4b24-8de6-18999d3ae48d">网桥Bridge</h5>
<div class="outline-text-5" id="text-h:3060c7a5-b3d7-4b24-8de6-18999d3ae48d">

<figure id="org89e1453">
<img src="images/image-20210126185822461.png" alt="image-20210126185822461.png" width="50%">

</figure>

<p>
网桥（Bridge）也叫桥接器，是连接两个局域网的一种存储/转发设备，根据MAC
地址表对数据帧进行转发，可隔离碰撞域
</p>

<p>
网桥将网络的多个网段在数据链路层连接起来，并对网络数据帧进行管理
</p>

<p>
网桥的内部结构
</p>


<figure id="org0b6b71d">
<img src="images/image-20210126185919132.png" alt="image-20210126185919132.png" width="50%">

</figure>

<p>
优点
</p>
<ul class="org-ul">
<li>过滤通信量</li>
<li>扩大了物理范围</li>
<li>提高了可靠性</li>
<li>可互连不同物理层、不同 MAC 子层和不同速率（如10 Mb/s 和 100 Mb/s以太
网）的局域网</li>
</ul>

<p>
缺点
</p>
<ul class="org-ul">
<li>存储转发增加了时延</li>
<li>在MAC 子层并没有流量控制功能</li>
<li>具有不同 MAC 子层的网段桥接在一起时时延更大</li>
<li>网桥只适合于用户数不太多(不超过几百个)和通信量不太大的局域网，否则有
时还会因传播过多的广播信息而产生网络拥塞。这就是所谓的广播风暴</li>
</ul>
</div>
</div>
<div id="outline-container-h:6bdc9686-5855-4834-a220-0c209c9b4fe8" class="outline-5">
<h5 id="h:6bdc9686-5855-4834-a220-0c209c9b4fe8">交换机switch</h5>
<div class="outline-text-5" id="text-h:6bdc9686-5855-4834-a220-0c209c9b4fe8">

<figure id="org3e4230b">
<img src="images/image-20210126185935514.png" alt="image-20210126185935514.png" width="50%">

</figure>

<p>
交换机是工作在OSI参考模型数据链路层的设备，外表和集线器相似
</p>

<p>
它通过判断数据帧的目的MAC地址，从而将数据帧从合适端口发送出去
</p>

<p>
交换机是通过MAC地址的学习和维护更新机制来实现数据帧的转发
</p>

<p>
内部结构
</p>


<figure id="org98462bd">
<img src="images/image-20210126185946444.png" alt="image-20210126185946444.png" width="50%">

</figure>

<p>
工作原理
</p>

<p>
和网桥工作原理一样
</p>
<ol class="org-ol">
<li>交换机根据收到数据帧中的源MAC地址建立该地址同交换机端口的映射，并将其写入MAC地址表中</li>
<li>交换机将数据帧中的目的MAC地址同已建立的MAC地址表进行比较，以决定由哪个端口进行转发</li>
<li>如数据帧中的目的MAC地址不在MAC地址表中，则向所有端口转发。这一过程称为泛洪（flood）</li>
<li>广播帧和组播帧向所有的端口转发</li>
</ol>

<p>
<code>广播时由于地址表中没有广播地址，所以会泛洪</code>
</p>

<p>
集线器与交换机的比较
</p>


<figure id="org00b9d3f">
<img src="images/image-20210126185957477.png" alt="image-20210126185957477.png" width="50%">

</figure>

<ol class="org-ol">
<li>交换机属于osi 2层 <code>数据链路层</code> 设备，而集线器属于物理层设备</li>
<li>集线器属于osi 1层 <code>物理层</code> 备，在转发帧时，不对传输介质进行检测，
交换机在转发帧之前必须执行CSMA/CD 算法。若在发送过程中出现碰撞，就必须
停止发送和进行退避。所以交换机能隔离冲突，而集线器却只能增加冲突</li>
<li>交换机的每个端口可提供专用的带宽，而集线器的所有端口只能共享带宽</li>
<li>集线器只能实现半双工传送，而交换机可支持全双工传送</li>
<li>集线器和交换机都无法隔离广播域</li>
</ol>

<p>
<code>集线器不能隔断冲突域、不能隔断广播域</code>
</p>

<p>
<code>交换机解决了冲突域的问题，无法解决广播域问题，需要路由器解决，隔断广播</code>
</p>
</div>
</div>
</div>
<div id="outline-container-h:671d433a-9e4f-4eb0-b46d-1f630de9f850" class="outline-4">
<h4 id="h:671d433a-9e4f-4eb0-b46d-1f630de9f850">路由器 router</h4>
<div class="outline-text-4" id="text-h:671d433a-9e4f-4eb0-b46d-1f630de9f850">
<p>
解决跨网段通信问题。
</p>



<figure id="org1dc49df">
<img src="images/image-20210126190023052.png" alt="image-20210126190023052.png" width="50%">

</figure>

<p>
OSI 3层 <code>网络层</code> 设备
</p>

<p>
路由：把一个数据包从一个设备发送到不同网络里的另外一个设备中。这些工作
依靠路由来完成。路由器只关心网络的状态和决定网络中的最佳路径。路由的实
现依靠路由器中的路由表来完成。
</p>

<p>
路由器功能：
</p>
<ul class="org-ul">
<li>工作在网络层</li>
<li>分隔广播域和冲突域</li>
<li>选择路由表中到达目标最好的路径</li>
<li>维护和检查路由信息</li>
<li>连接广域网</li>
</ul>


<figure id="orgad820be">
<img src="images/image-20210126190035094.png" alt="image-20210126190035094.png" width="50%">

</figure>

<p>
<b>对比与总结</b>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">设备</td>
<td class="org-left">ISO</td>
<td class="org-left">域</td>
</tr>

<tr>
<td class="org-left">集线器hub</td>
<td class="org-left">物理层</td>
<td class="org-left">同一冲突域，同一广播域</td>
</tr>

<tr>
<td class="org-left">交换机switch</td>
<td class="org-left">数据链接层</td>
<td class="org-left">每个端口一个冲突域，所有端口都在同一个广播域</td>
</tr>

<tr>
<td class="org-left">路由器router</td>
<td class="org-left">网络层</td>
<td class="org-left">每个端口都有独立广播域</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-h:2d5cb477-dbb8-40ae-a241-78af5932b600" class="outline-3">
<h3 id="h:2d5cb477-dbb8-40ae-a241-78af5932b600">Ethernet以太网技术</h3>
<div class="outline-text-3" id="text-h:2d5cb477-dbb8-40ae-a241-78af5932b600">
<p>
<code>必须要掌握的</code>
</p>
</div>
<div id="outline-container-h:1e2c429e-50a9-4377-934f-56804d41792d" class="outline-4">
<h4 id="h:1e2c429e-50a9-4377-934f-56804d41792d">概述</h4>
<div class="outline-text-4" id="text-h:1e2c429e-50a9-4377-934f-56804d41792d">

<figure id="org59644fb">
<img src="images/image-20210126190046180.png" alt="image-20210126190046180.png" width="50%">

</figure>

<p>
国际上局域网标准
</p>

<p>
802.3，实际上标准是以太网
</p>

<p>
以太网（Ethernet）是一种产生较早且使用相当广泛的局域网，由美国
Xerox（施乐）公司的Palo Alto研究中心（简称为PARC）于20世纪70年代初期开
始研究并于1975年研制成功
</p>
</div>
</div>
<div id="outline-container-h:e3291166-ab75-4478-9973-3ec1da723697" class="outline-4">
<h4 id="h:e3291166-ab75-4478-9973-3ec1da723697">以太网MAC帧格式</h4>
<div class="outline-text-4" id="text-h:e3291166-ab75-4478-9973-3ec1da723697">
<p>
2代以网和以往的以太网有些区别
</p>


<figure id="orgb6f933b">
<img src="images/image-20210126190100509.png" alt="image-20210126190100509.png" width="50%">

</figure>

<pre class="example" id="org54ee292">
+-----------+-----------+-------------+--------------------+----------+
|   DMAC    |   SMAC    |     Type    |          Data      |   FCS    |
|  6 Bytes  |  6 Bytes  |   2 Bytes   |  Variable length   | 4 Bytes  |
+-----------+-----------+-------------+--------------------+----------+
|                                                                     |
         |                                                          |
                   |                                             |
                            |                                  |
                                    |                         |
                                           |                 |
+-------------+-----------+----------------+-----------------+
|   帧间隙    |前同步码   |  帧开始定界符  |  Ethernet Frame |
|至少12Bytes  | 7 Bytes   |  1 Byte        | Variable length |
+-------------+-----------+----------------+-----------------+
</pre>



<figure id="org40f8aa4">
<img src="images/image-20210416200630151.png" alt="image-20210416200630151.png" width="50%">

</figure>

<p>
以太网MAC帧格式
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">Preamble&#21069;&#23548;&#20449;&#24687;</span>(7&#23383;&#33410;)                      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20914;&#31361;&#26816;&#27979;&#65292;&#26080;&#23454;&#38469;&#24847;&#20041;&#12290;&#23454;&#29616;&#24103;&#30340;&#21516;&#27493;</span>
<span style="color: #0000ff;">SOF&#24103;&#36215;&#22987;</span>(1)                                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#26469;&#20998;&#21106;&#21069;&#23548;&#20449;&#24687;&#21644;&#21518;&#32493;&#20869;&#23481;&#12290;&#34920;&#31034;&#24103;&#30340;&#24320;&#22987;</span>
Destination Address&#30446;&#30340;MAC&#22320;&#22336;(6)     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#26631;&#35774;&#22791;&#32593;&#21345;&#21495;</span>
Source Address&#28304;MAC&#22320;&#22336;(6)               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28304;&#35774;&#22791;&#32593;&#21345;&#21495;</span>
<span style="color: #0000ff;">Type&#21327;&#35758;&#31867;&#22411;</span>(2)                                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#22826;&#32593;&#20013;&#24103;&#30340;&#31867;&#22411;&#65292;&#20307;&#29616;&#19978;&#23618;&#21327;&#35758;&#30340;&#31867;&#22411;. Ethernet2</span>
<span style="color: #0000ff;">Length&#38271;&#24230;</span>(2)                                      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#38754;&#23454;&#38469;&#20869;&#23481;&#38271;&#24230;&#12290;IEEE 802.3</span>
802.2 Header and Data&#25968;&#25454;(38~1500)  <span style="color: #b22222;">#</span><span style="color: #b22222;">IP20&#23383;&#33410; + TCP20&#23383;&#33410;+&#25968;&#25454;.    IEEE 802.3</span>
<span style="color: #0000ff;">Data&#25968;&#25454;</span>(46-1500)                               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21253;&#21547;&#20854;&#20182;&#23618;&#21327;&#35758;&#21152;&#20837;&#30340;&#22836;&#20449;&#24687;&#12290;Ethernet2</span>
<span style="color: #0000ff;">FCS&#26816;&#39564;&#20301;</span>(4)                                       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24103;&#30340;&#26657;&#39564;&#24207;&#21015;&#65292;&#35745;&#31639;&#24103;&#26159;&#21542;&#25439;&#22351;&#20002;&#22833;&#12290;</span>
</pre>
</div>

<p>
windows管理员身份运行wireshark抓包软件
</p>

<figure id="orgc5068dd">
<img src="images/image-20210126190306317.png" alt="image-20210126190306317.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:bb46b8c4-b6d4-4b57-b30c-1c2e62663a85" class="outline-4">
<h4 id="h:bb46b8c4-b6d4-4b57-b30c-1c2e62663a85">MAC地址</h4>
<div class="outline-text-4" id="text-h:bb46b8c4-b6d4-4b57-b30c-1c2e62663a85">

<figure id="orga49bffd">
<img src="images/image-20210126190329869.png" alt="image-20210126190329869.png" width="50%">

</figure>

<p>
在局域网中，硬件地址又称为物理地址或MAC地址（因为这种地址用在MAC帧中）
</p>

<p>
IEEE 802标准为局域网规定了一种48位的全球地址（一般都简称为”地址”)，
是局域网中每一台计算机固化在网卡ROM中的地址
</p>

<p>
IEEE 的注册管理机构 RA <b>负责向厂家分配</b> 地址字段的前三个字节(即高位 24
位)
</p>

<p>
地址字段中的后三个字节(即低位 24位)由厂家 <b>自行指派</b> ，称为扩展标识符，
必须保证生产出的适配器没有重复地址
</p>

<p>
使用虚拟机注意：
</p>

<p>
我们在使用vmware虚拟机时，有时会直接复制一份虚拟机，那mac地址就是不唯
一的了，2台机器无法通信，这时就需要修改其中一台虚拟机中的mac地址。
</p>

<p>
<b>各大厂商MAC识别码：</b> <a href="https://standards-oui.ieee.org/oui/oui.txt">https://standards-oui.ieee.org/oui/oui.txt</a>
</p>

<p>
范例： PC使用ipconfig /all 查看以太网网卡厂商，MAC地址前3字节
</p>


<figure id="org5f6d960">
<img src="./images/img_20241016_164403.png" alt="img_20241016_164403.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:fa68cf8f-01c5-480e-9420-14cc15dbe0fe" class="outline-4">
<h4 id="h:fa68cf8f-01c5-480e-9420-14cc15dbe0fe">冲突检测的载波侦听多路访问CSMA/CD</h4>
<div class="outline-text-4" id="text-h:fa68cf8f-01c5-480e-9420-14cc15dbe0fe">
<p>
早期以太网通信机制csma/cd
</p>


<figure id="orgda3a51b">
<img src="images/image-20210126190340565.png" alt="image-20210126190340565.png" width="50%">

</figure>

<p>
工作原理
</p>

<ul class="org-ul">
<li>先听后发：通信前先检测网络中是否有数据报文传输，如果没有人发再发</li>
<li>边发边听</li>
<li>冲突停止</li>
<li>延迟重发</li>
</ul>

<p>
现在网卡都是工作在交换机中的，交换机中是没有冲突的，它是一个接口一个冲突域。
</p>
</div>
</div>
</div>
<div id="outline-container-h:ab1d4d0b-5409-43c5-a14f-1493038747fc" class="outline-3">
<h3 id="h:ab1d4d0b-5409-43c5-a14f-1493038747fc">虚拟局域网 VLAN</h3>
<div class="outline-text-3" id="text-h:ab1d4d0b-5409-43c5-a14f-1493038747fc">
<p>
解决问题：把网络从逻辑上切成小的网络。
</p>

<p>
因为在没有 VLAN前，在局域网中连接网络设备很多都是用交换机连，但交换机
是2层设备不能起到隔离广播的功能，造成所有的设备连在一起就在一个广播域。
</p>

<p>
交换机上的技术
</p>
</div>
<div id="outline-container-h:ebddb3a6-75c6-4582-b7f4-8263169db03a" class="outline-4">
<h4 id="h:ebddb3a6-75c6-4582-b7f4-8263169db03a">VLAN 原理</h4>
<div class="outline-text-4" id="text-h:ebddb3a6-75c6-4582-b7f4-8263169db03a">

<figure id="orgfe59e0f">
<img src="images/image-20210126190351157.png" alt="image-20210126190351157.png" width="50%">

</figure>

<p>
如果像上图都3个楼层都者交换机相连，交换机无法隔断广播的，工程部人员可
以访问HR人员主机上共享的资源
</p>

<pre class="example" id="org66d820a">
#pc机输入地址
\\10.0.0.3
</pre>


<figure id="org9d5ac53">
<img src="images/image-20210126190402817.png" alt="image-20210126190402817.png" width="50%">

</figure>

<p>
虚拟局域网 VLAN 是由一些局域网网段构成的与物理位置无关的逻辑组
</p>

<p>
这些网段具有某些共同的需求。每一个 VLAN的帧都有一个明确的标识符，指明
发送这个帧的工作站是属于哪一个VLAN。虚拟局域网其实只是局域网给用户提供
的一种服务，而并不是一种新型局域网
</p>

<p>
优点
</p>
<ol class="org-ol">
<li>更有效地共享网络资源。如果用交换机构成较大的局域网，大量的广播报文
就会使网络性能下降。VLAN能将广播报文限制在本VLAN范围内，从而提升了
网络的效能</li>
<li>简化网络管理。当结点物理位置发生变化时，如跨越多个局域网，通过逻辑
上配置VLAN即可形成网络设备的逻辑组，无需重新布线和改变IP地址等。这
些逻辑组可以跨越一个或多个二层交换机</li>
<li>提高网络的数据安全性。一个VLAN中的结点接收不到另一个VLAN中其他结点的帧</li>
</ol>

<p>
虚拟局域网的实现技术
</p>
<ol class="org-ol">
<li>基于端口的VLAN</li>
<li>基于MAC地址的VLAN</li>
<li>基于协议的VLAN</li>
<li>基于网络地址的VLAN</li>
</ol>

<p>
范例：查看谁使用了共享资源
</p>

<p>
查看本地共享：我的电脑右键&#x2013;&gt;"管理"&#x2013;&gt;共享文件夹
</p>


<figure id="org91bdf3e">
<img src="images/image-20210126190428877.png" alt="image-20210126190428877.png" width="50%">

</figure>

<p>
windows中用netstat -no| findstr :445查看是否有端口被访问，445共享服务
端口
</p>


<figure id="org8314bf4">
<img src="images/image-20210126190448102.png" alt="image-20210126190448102.png" width="50%">

</figure>

<p>
反向解析计算机名 ping -a IP
</p>


<figure id="orgbeeb304">
<img src="images/image-20210126190459220.png" alt="image-20210126190459220.png" width="50%">

</figure>

<p>
<b>隔断广播域的方式</b>
</p>

<p>
方法1 添加路由器
</p>

<p>
路由器上设置安全策略是否允许不同部门设备穿过
</p>


<figure id="org0963c2f">
<img src="images/image-20210126190510892.png" alt="image-20210126190510892.png" width="50%">

</figure>

<p>
方法2 VLAN技术
</p>

<p>
在交换机上划分广播域，交换机上不同的口组合VLAN，相当于路由器隔离广播域的效果。
</p>


<figure id="org191b9c8">
<img src="images/image-20210126190525915.png" alt="image-20210126190525915.png" width="50%">

</figure>

<p>
<code>跨VLAN之通信需要添加路由设备</code> ，不同VLAN有一个口接入路由器，这样会浪
费一些交换端口，所以 <code>后来有了三层交换机</code> 有路由功能
</p>


<figure id="orgee147b0">
<img src="images/image-20210126190537835.png" alt="image-20210126190537835.png" width="50%">

</figure>

<p>
不用物理交换机机间访问，使用trunk协议共用VLAN，在数据链路层中IEEE
802.1Q帧结构标识VLAN VID
</p>


<figure id="org35b0fbd">
<img src="images/image-20210126190548643.png" alt="image-20210126190548643.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:83e75bab-d632-405f-b861-ee707fe8a940" class="outline-4">
<h4 id="h:83e75bab-d632-405f-b861-ee707fe8a940">IEEE 802.1Q 帧结构</h4>
<div class="outline-text-4" id="text-h:83e75bab-d632-405f-b861-ee707fe8a940">

<figure id="org2fdd017">
<img src="images/image-20210126190558875.png" alt="image-20210126190558875.png" width="50%">

</figure>

<p>
vlan 技术要修改以太网帧的数据结构，使用 trunk 协议完成。
</p>

<p>
trunk栈道，2 个交换机用一根网线连起来走公共的 trunk 网络，trunk 接口上
跑trunk 协议IEEE 802.1Q。
</p>

<p>
vlan 数据占 4 个字节，在目标地址与上层类型之间插入。真正用了 12位，表
示可以划分 2 的 12 次方即 4096 个vlan。但在云环境上不够用，所以现在用
VXLAN
</p>

<p>
IEEE 802.1Q 帧结构
</p>


<figure id="orgb25065a">
<img src="images/image-20210126190610782.png" alt="image-20210126190610782.png" width="50%">

</figure>

<p>
<b>VLAN 标签各字段含义</b>
</p>

<p>
TPID：Tag Protocol Identifier（标签协议标识符），2Byte，表示帧类型，取
值为0x8100时表示IEEE 802.1Q的VLAN数据帧。如果不支持802.1Q的设备收到这
样的帧，会将其丢弃，各设备厂商可以自定义该字段的值。当邻居设备将TPID值
配置为非0x8100时，为了能够识别这样的报文，实现互通，必须在本设备上修改
TPID值，确保和邻居设备的TPID值配置一致
</p>

<p>
PRI：Priority，3bit，表示数据帧的802.1p（是IEEE 802.1Q的扩展协议）优先
级。取值范围为0～7，值越大优先级越高。当网络阻塞时，交换机优先发送优先
级高的数据帧
</p>

<p>
CFI：Canonical Format Indicator（标准格式指示位），1bit,表示MAC地址在
不同的传输介质中是否以标准格式进行封装，用于兼容以太网和令牌环网。CFI
取值为0表示MAC地址以标准格式进行封装，为1表示以非标准格式封装。在以太
网中，CFI的值为0
</p>

<p>
VID：VLAN ID，12bit，表示该数据帧所属VLAN的编号。VLAN ID取值范围是0～
4095。由于0和4095 为协议保留取值，所以VLAN ID的有效取值范围是1～4094
</p>

<p>
VID表示12个位，也就是能表示交换机能管理4096个vlan，但在复杂的云环境中
不满足需求。解决可以用VXLAN
</p>
</div>
</div>
</div>
<div id="outline-container-h:0047520c-b9a5-475c-a37d-5ac1fbf14419" class="outline-3">
<h3 id="h:0047520c-b9a5-475c-a37d-5ac1fbf14419">分层的网络架构</h3>
<div class="outline-text-3" id="text-h:0047520c-b9a5-475c-a37d-5ac1fbf14419">
<p>
需要网络工程师来搭建
</p>

<p>
从网络规划角度讲
</p>


<figure id="org4b62b1d">
<img src="images/image-20210126190622455.png" alt="image-20210126190622455.png" width="50%">

</figure>

<p>
访问层：主机和网络连起来，即交换机和主机连起来
</p>

<p>
分布层：路由器功能，VLAN隔开
</p>

<p>
核心层：高速转发，核心交换机
</p>

<p>
<b>架构一</b>
</p>


<figure id="org539a5c3">
<img src="images/image-20210126190640608.png" alt="image-20210126190640608.png" width="50%">

</figure>

<p>
汇聚交换机：3层交换机，有路由功能
</p>

<p>
<b>架构二</b>
</p>


<figure id="orgf9e768e">
<img src="images/image-20210126190754989.png" alt="image-20210126190754989.png" width="50%">

</figure>


<p>
<b>架构三</b>
</p>


<figure id="org7f3981c">
<img src="images/09-01-jg-3.jpg" alt="09-01-jg-3.jpg" width="50%">

</figure>

<p>
参考：
</p>
</div>
</div>
</section>
<section id="outline-container-h:a875bb87-b31c-46e2-b43a-446abed58e9a" class="outline-2">
<h2 id="h:a875bb87-b31c-46e2-b43a-446abed58e9a">TCP/IP 协议栈</h2>
<div class="outline-text-2" id="text-h:a875bb87-b31c-46e2-b43a-446abed58e9a">
<p>
IETF and RFC
</p>
<ul class="org-ul">
<li>Internet Engineering Task Force (<a href="https://www.ietf.org/">IETF</a>) 负责管理因特网有关标准的开发。</li>
<li>因特网标准以 Request For Comments (<a href="https://www.ietf.org/rfc.html">RFC</a>) 文档形式在因特网上发表。</li>
</ul>
</div>
<div id="outline-container-h:8f56d593-9656-44ff-a89a-9ca8d19a5f9a" class="outline-3">
<h3 id="h:8f56d593-9656-44ff-a89a-9ca8d19a5f9a">TCP/IP 标准</h3>
<div class="outline-text-3" id="text-h:8f56d593-9656-44ff-a89a-9ca8d19a5f9a">
</div>
<div id="outline-container-h:d9d3ef57-90cb-400e-aafd-996aa04a79c9" class="outline-4">
<h4 id="h:d9d3ef57-90cb-400e-aafd-996aa04a79c9">TCP/IP 介绍</h4>
<div class="outline-text-4" id="text-h:d9d3ef57-90cb-400e-aafd-996aa04a79c9">
<p>
Transmission Control Protocol/Internet Protocol传输控制协议/因特网互联协议
</p>

<p>
TCP/IP是一个Protocol Stack，包括TCP、IP、UDP、ICMP、RIP、TELNET、FTP、SMTP、ARP等许多协议
</p>

<p>
最早发源于1969年美国国防部（缩写为DoD）的因特网的前身ARPA网项目，1983
年1月1日，TCP/IP取代了旧的网络控制协议NCP，成为今天的互联网和局域网的
基石和标准,由互联网工程任务组负责维护。
</p>

<p>
但局域网在 90 年代初还在 IPX/SPX 协议，是由 NAVELL网络开发的协议，
NAVELL 公司用的操作系统是 netware操作系统，当时微软还未成为主流的操作
系统只是在家用pc上用。随着微软的技术更新，推出了针对企业的操作系统如
NT4.0，NT4.0 默认使用了 TCP/IP 协议，用微软的 NT4.0在局域网和互联网都
用的 TCP/IP协议，使得机器间通信非常容易，不需要做协议转换。而早期的局
域网 IPX/SPX协议连接互联网中间要安装网关，通过网关做协议转换才能连互联
网。90年代未期普通都采用了TCP/IP 协议。
</p>

<p>
Linux 在 1991 年诞生，2000 年后 linux 已经非常强大，服务器使用了 linux
系统并采用了 TCP/IP 协议。
</p>

<p>
国防高级研究计划局 DRPA 与 BBN 技术公司、斯坦福大学和伦敦大学学院签约，
在多个硬件平台上开发协议的操作版本。在协议开发过程中，数据包路由层的版
本号从版本1 进展到版本 4，后者于 1983 年安装在 ARPANET 中。它被称为互
联网协议版本4 （IPV4）作为协议，仍在互联网使用，连同其目前的继承，互联
网协议版本 6（IPV6）。
</p>

<p>
TCP/IP 规范-RFC 文档：<a href="https://www.ietf.org/rfc/rfc1180.html">https://www.ietf.org/rfc/rfc1180.html</a>
</p>
</div>
</div>
<div id="outline-container-h:8da14656-a0af-48b5-9ba9-eb12272d67ff" class="outline-4">
<h4 id="h:8da14656-a0af-48b5-9ba9-eb12272d67ff">TCP/IP 分层</h4>
<div class="outline-text-4" id="text-h:8da14656-a0af-48b5-9ba9-eb12272d67ff">
<p>
共定义了四层，和OSI参考模型的分层有对应关系
</p>

<p>
RFC 文档： <a href="https://www.ietf.org/rfc/rfc1122#section-1.3.3">https://www.ietf.org/rfc/rfc1122#section-1.3.3</a>
</p>

<p>
RFC 官方分为 四层：
</p>

<ul class="org-ul">
<li>Application Layer 应用层</li>
<li>Transport Layer 传输层</li>
<li>Internet Layer 网络层</li>
<li>Link Layer 链路层</li>
</ul>



<figure id="org88c7f21">
<img src="images/image-20210126190828917.png" alt="image-20210126190828917.png" width="50%">

</figure>


<p>
<b>TCP/IP 应用层</b>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">OSI Layers</td>
<td class="org-left">TCP/IP Layers</td>
<td class="org-left">Type of Data</td>
<td class="org-left">Protocols</td>
<td class="org-left">Represent</td>
</tr>

<tr>
<td class="org-left">Application Layer</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">Messages</td>
<td class="org-left">DNS, DHCP, HTTP, FTP, SMTP, P2P, SSH, Telnet, etc.</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Presentation Layer</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">Encrypted data</td>
<td class="org-left">HTML, JPEG, GIF, MP3, Sockets etc.</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Session Layer</td>
<td class="org-left">Application Layer</td>
<td class="org-left">Data streams</td>
<td class="org-left">NetBIOS, RPC, PPTP, etc.</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Transport Layer</td>
<td class="org-left">Transport Layer</td>
<td class="org-left">Segments(TCP)/Datagram(UDP)</td>
<td class="org-left">TCP, UDP, SCTP, <a href="https://datatracker.ietf.org/doc/html/rfc5246">SSL/TLS</a></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Network Layer</td>
<td class="org-left">Internet Layer</td>
<td class="org-left">Packets</td>
<td class="org-left">IP, ARP, ICMP, IGMP, IPsec, OSPF, etc</td>
<td class="org-left">路由器</td>
</tr>

<tr>
<td class="org-left">Data Link Layer</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">Frames</td>
<td class="org-left">Ethernet, Wi-Fi, Bluetooth</td>
<td class="org-left">交换机，网卡</td>
</tr>

<tr>
<td class="org-left">Physical Layer</td>
<td class="org-left">Link Layer</td>
<td class="org-left">Bits</td>
<td class="org-left">Ethernet, USB, HDMI, etc.</td>
<td class="org-left">集线器，网线</td>
</tr>
</tbody>
</table>


<figure id="org545f4fc">
<img src="images/image-20210126190839970.png" alt="image-20210126190839970.png" width="50%">

</figure>


<figure id="org1b6ce64">
<img src="images/727253187192295424.png" alt="727253187192295424.png" width="50%">

</figure>


<figure id="org53b7e83">
<img src="./images/667308064245682176.png" alt="667308064245682176.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:f57b10b5-8c08-43d6-9c41-762ad52a5c2f" class="outline-4">
<h4 id="h:f57b10b5-8c08-43d6-9c41-762ad52a5c2f">TCP/IP 通信过程</h4>
<div class="outline-text-4" id="text-h:f57b10b5-8c08-43d6-9c41-762ad52a5c2f">

<figure id="orgd7420e2">
<img src="images/image-20210126190904820.png" alt="image-20210126190904820.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:a220c962-cc20-47f1-83c3-4d52bc92043e" class="outline-4">
<h4 id="h:a220c962-cc20-47f1-83c3-4d52bc92043e">TCP/IP和OSI模型的比较</h4>
<div class="outline-text-4" id="text-h:a220c962-cc20-47f1-83c3-4d52bc92043e">
<p>
相同点
</p>
<ul class="org-ul">
<li>两者都是以协议栈的概念为基础</li>
<li>协议栈中的协议彼此相互独立</li>
</ul>
<p>
-下层对上层提供服务
</p>

<p>
不同点
</p>
<ul class="org-ul">
<li>OSI是先有模型；TCP/IP是先有协议，后有模型</li>
<li>OSI是国际标准，适用于各种协议栈；TCP/IP实际标准，只适用于TCP/IP网络</li>
<li>层次数量不同</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:4a43b9ba-8dc1-45b3-98ca-35b2be3f2c0b" class="outline-3">
<h3 id="h:4a43b9ba-8dc1-45b3-98ca-35b2be3f2c0b">Transport Layer 传输层</h3>
<div class="outline-text-3" id="text-h:4a43b9ba-8dc1-45b3-98ca-35b2be3f2c0b">

<figure id="orge44b27d">
<img src="images/image-20210126190927340.png" alt="image-20210126190927340.png" width="50%">

</figure>

<p>
<b>TCP和UDP</b>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">属性</td>
<td class="org-left">TCP</td>
<td class="org-left">UDP</td>
</tr>

<tr>
<td class="org-left">可靠性</td>
<td class="org-left">可靠</td>
<td class="org-left">不可靠</td>
</tr>

<tr>
<td class="org-left">连接性</td>
<td class="org-left">面向连接</td>
<td class="org-left">无连接</td>
</tr>

<tr>
<td class="org-left">目标数</td>
<td class="org-left">1对1</td>
<td class="org-left">支持1对1，1对多，多对1，多对多</td>
</tr>

<tr>
<td class="org-left">有序</td>
<td class="org-left">有序</td>
<td class="org-left">无序</td>
</tr>

<tr>
<td class="org-left">报文</td>
<td class="org-left">面向字节流</td>
<td class="org-left">面向报文</td>
</tr>

<tr>
<td class="org-left">效率</td>
<td class="org-left">传输效率低</td>
<td class="org-left">传输效率高</td>
</tr>

<tr>
<td class="org-left">流量控制</td>
<td class="org-left">滑动窗口</td>
<td class="org-left">无</td>
</tr>

<tr>
<td class="org-left">拥塞控制</td>
<td class="org-left">慢开始、拥塞避免、快重传、快恢复</td>
<td class="org-left">无</td>
</tr>

<tr>
<td class="org-left">传输效率</td>
<td class="org-left">慢</td>
<td class="org-left">快</td>
</tr>

<tr>
<td class="org-left">传输方式</td>
<td class="org-left">面向字节流</td>
<td class="org-left">面向报文</td>
</tr>

<tr>
<td class="org-left">常见应用</td>
<td class="org-left">邮件服务、文件下载、网站浏览等</td>
<td class="org-left">语音聊天、视频聊天等</td>
</tr>
</tbody>
</table>


<figure id="org51f6004">
<img src="images/image-20210126190935675.png" alt="image-20210126190935675.png" width="50%">

</figure>
</div>
<div id="outline-container-h:8b86f8dd-f666-4ac1-ba02-dea298a0a2e7" class="outline-4">
<h4 id="h:8b86f8dd-f666-4ac1-ba02-dea298a0a2e7">TCP Transmission Control Protocol</h4>
<div class="outline-text-4" id="text-h:8b86f8dd-f666-4ac1-ba02-dea298a0a2e7">
</div>
<div id="outline-container-h:60d033f9-6189-4b70-94cd-6b959d38e4f9" class="outline-5">
<h5 id="h:60d033f9-6189-4b70-94cd-6b959d38e4f9">TCP特性</h5>
<div class="outline-text-5" id="text-h:60d033f9-6189-4b70-94cd-6b959d38e4f9">
<ul class="org-ul">
<li>工作在传输层</li>
<li>面向连接协议</li>
<li>全双工协议</li>
<li>半关闭：4 次挥手过程</li>
<li>错误检查</li>
<li>将数据打包成段，排序</li>
<li>确认机制</li>
<li>数据恢复，重传</li>
<li>流量控制，滑动窗口：包头中的窗口，可以一次传输多个包，提高效率</li>
<li>拥塞控制，慢启动和拥塞避免算法</li>
</ul>

<p>
更多关于tcp的内核参数，可参看man 7 tcp
</p>
</div>
</div>
<div id="outline-container-h:eb4cd55d-fee8-4866-8efb-dc9440614e17" class="outline-5">
<h5 id="h:eb4cd55d-fee8-4866-8efb-dc9440614e17">TCP包头结构</h5>
<div class="outline-text-5" id="text-h:eb4cd55d-fee8-4866-8efb-dc9440614e17">
<p>
TCP包头
</p>


<figure id="orgb6a3e35">
<img src="images/image-20210126190946501.png" alt="image-20210126190946501.png" width="50%">

</figure>

<pre class="example" id="orgdd61b11">
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-------------------------------+-------------------------------+
|          Source Port          |       Destination Port        |
+-------------------------------+-------------------------------+
|                        Sequence Number                        |
+---------------------------------------------------------------+
|                    Acknowledgment Number                      |
+-------+-------+-+-+-+-+-+-+-+-+-------------------------------+
|  Data |       |C|E|U|A|P|R|S|F|                               |
| Offset|Rsved  |W|C|R|C|S|S|Y|I|            Window             |
|       |       |R|E|G|K|H|T|N|N|                               |
+-------+-----------+-+-+-+-+-+-+-------------------------------+
|           Checksum            |         Urgent Pointer        |
+-------------------------------+-------------------------------+
|                            Options                            |
+---------------------------------------------------------------+
|                             data                              |
+---------------------------------------------------------------+
</pre>

<p>
固定部分20字节
</p>

<ul class="org-ul">
<li>源端口、目标端口：计算机上的进程要和其他进程通信是要通过计算机端口的，
而一个计算机端口某个时刻只能被一个进程占用，所以通过指定源端口和目标
端口，就可以知道是哪两个进程需要通信。源端口、目标端口是用16位表示的，
可推算计算机的端口个数为2^16个,即65536</li>

<li>序列号：表示本报文段所发送数据的第一个字节的编号。在TCP连接中所传送
的字节流的每一个字节都会按顺序编号。由于序列号由32位表示，所以每2^32
个字节，就会出现序列号回绕，再次从0开始</li>

<li>确认号：表示接收方期望收到发送方下一个报文段的第一个字节数据的编号。
也就是告诉发送方：我希望你（指发送方）下次发送的数据的第一个字节数据
的编号为此确认号</li>

<li>数据偏移：表示TCP报文段的首部长度，共4位，由于TCP首部包含一个长度可
变的选项部分，需要指定这个TCP报文段到底有多长。它指出TCP 报文段的数
据起始处距离 TCP报文段的起始处有多远。该字段的单位是32位(即4个字节为
计算单位），4位二进制最大表示15，所以数据偏移也就是TCP首部最大60字节</li>

<li>URG：表示本报文段中发送的数据是否包含紧急数据。后面的紧急指针字段
（urgent pointer）只有当URG=1时才有效</li>

<li><b>ACK</b> ：表示是否前面确认号字段是否有效。只有当ACK=1时，前面的确认号
字段才有效。TCP规定，连接建立后，ACK必须为1,带ACK标志的TCP报文段称为
确认报文段</li>

<li>PSH：提示接收端应用程序应该立即从TCP接收缓冲区中读走数据，为接收后续
数据腾出空间。如果为1，则表示对方应当立即把数据提交给上层应用，而不
是缓存起来，如果应用程序不将接收到的数据读走，就会一直停留在TCP接收
缓冲区中</li>

<li>RST：如果收到一个RST=1的报文，说明与主机的连接出现了严重错误（如主机
崩溃），必须释放连接，然后再重新建立连接。或者说明上次发送给主机的数
据有问题，主机拒绝响应，带RST标志的TCP报文段称为复位报文段</li>

<li><b>SYN</b> ：在建立连接时使用，用来同步序号。当SYN=1，ACK=0时，表示这是一
个请求建立连接的报文段；当SYN=1，ACK=1时，表示对方同意建立连接。
SYN=1，说明这是一个请求建立连接或同意建立连接的报文。只有在前两次握
手中SYN才置为1，带SYN标志的TCP报文段称为同步报文段</li>

<li><b>FIN</b> ：表示通知对方本端要关闭连接了，标记数据是否发送完毕。如果
FIN=1，即告诉对方："我的数据已经发送完毕，你可以释放连接了"，带FIN标
志的TCP报文段称为结束报文段</li>

<li>窗口大小：表示现在允许对方发送的数据量，也就是告诉对方，从本报文段的
确认号开始允许对方发送的数据量，达到此值，需要ACK确认后才能再继续传
送后面数据，由Window size value * Window size scaling factor（此值在
三次握手阶段TCP选项Window scale协商得到）得出此值</li>

<li>校验和：提供额外的可靠性</li>

<li>紧急指针：标记紧急数据在数据字段中的位置</li>

<li>选项部分：其最大长度可根据TCP首部长度进行推算。TCP首部长度用4位表示，
选项部分最长为：(2^4-1)*4-20=40字节</li>
</ul>

<p>
<b>TCP包头常见选项：</b>
</p>

<ul class="org-ul">
<li><p>
最大报文段长度MSS（Maximum Segment Size）
</p>

<p>
通常1460字节
</p>

<p>
指明自己期望对方发送TCP报文段时那个数据字段的长度。比如：1460字节。
数据字段的长度加上TCP首部的长度才等于整个TCP报文段的长度。MSS不宜设
的太大也不宜设的太小。若选择太小，极端情况下，TCP报文段只含有1字节数
据，在IP层传输的数据报的开销至少有40字节（包括TCP报文段的首部和IP数
据报的首部）。这样，网络的利用率就不会超过1/41。若TCP报文段非常长，
那么在IP层传输时就有可能要分解成多个短数据报片。在终点要把收到的各个
短数据报片装配成原来的TCP报文段。当传输出错时还要进行重传，这些也都
会使开销增大。因此MSS应尽可能大，只要在IP层传输时不需要再分片就行。
在连接建立过程中，双方都把自己能够支持的MSS写入这一字段。MSS只出现在
SYN报文中。即：MSS出现在SYN=1的报文段中
</p>

<p>
MTU和MSS值的关系：MTU=MSS+IP Header+TCP Header, 通信双方最终的MSS值=较小MTU-IP Header-TCP Header
</p></li>

<li><p>
窗口扩大 Window Scale
</p>

<p>
为了扩大窗口，由于TCP首部的窗口大小字段长度是16位，所以其表示的最大
数是65535。但是随着时延和带宽比较大的通信产生（如卫星通信），需要更
大的窗口来满足性能和吞吐率，所以产生了这个窗口扩大选项
</p></li>

<li><p>
时间戳 Timestamps
</p>

<p>
可以用来计算RTT(往返时间)，发送方发送TCP报文时，把当前的时间值放入时
间戳字段，接收方收到后发送确认报文时，把这个时间戳字段的值复制到确认
报文中，当发送方收到确认报文后即可计算出RTT。也可以用来防止回绕序号
PAWS，也可以说可以用来区分相同序列号的不同报文。因为序列号用32为表示，
每2^32个序列号就会产生回绕，那么使用时间戳字段就很容易区分相同序列号
的不同报文
</p></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">man 7 tcp
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cbbcd216-4e68-4fdc-9b68-5d5f4a2aeac2" class="outline-5">
<h5 id="h:cbbcd216-4e68-4fdc-9b68-5d5f4a2aeac2">TCP协议PORT</h5>
<div class="outline-text-5" id="text-h:cbbcd216-4e68-4fdc-9b68-5d5f4a2aeac2">

<figure id="org65563c2">
<img src="images/image-20210126190958157.png" alt="image-20210126190958157.png" width="50%">

</figure>

<p>
传输层通过port号，确定应用层协议，范围0-65535
</p>

<p>
维基百科：<a href="https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers">https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers</a>
</p>

<p>
IANA互联网数字分配机构负责域名，数字资源，协议分配
</p>

<ul class="org-ul">
<li><p>
0-1023：系统端口或特权端口(仅管理员可用)，众所周知，永久的分配给固定
的系统应用使用，
</p>

<p>
22/tcp(ssh), 80/tcp(http), 443/tcp(https)
</p></li>

<li><p>
1024-49151：用户端口或注册端口，但要求并不严格，分配给程序注册为某应
用使用，
</p>

<p>
1433/tcp(SqlServer), 1521/tcp(oracle),3306/tcp(mysql),11211/tcp/udp
(memcached)
</p></li>

<li>49152-65535：动态或私有端口，客户端随机使用端口，范围定
义：/proc/sys/net/ipv4/ip_local_port_range</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24120;&#29992;&#26381;&#21153;&#21450;&#31471;&#21475;&#23545;&#24212;&#20851;&#31995;</span>
cat /etc/services

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#38750;&#29305;&#26435;&#29992;&#25143;&#21487;&#20197;&#20351;&#29992;&#36215;&#22987;&#31471;&#21475;</span>
cat /proc/sys/net/ipv4/ip_unprivileged_port_start

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#23458;&#25143;&#31471;&#21160;&#24577;&#31471;&#21475;&#36215;&#22987;</span>
cat /proc/sys/net/ipv4/ip_local_port_range
</pre>
</div>

<p>
范例：windows 查找端口
</p>

<div class="org-src-container">
<pre class="src src-sh">tasklist | findstr Xshell <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21015;&#20986; xshell &#36827;&#31243;&#21495;</span>
netstat -no | findstr 1476 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#25454;&#36827;&#31243;&#21495;&#26597;&#25214;&#32593;&#32476;&#36830;&#25509;</span>
</pre>
</div>

<p>
范例：linux 自定义客户端端口范围
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /proc/sys/net/ipv4/ip_local_port_range
32768 60999
[root@centos8 ~]#echo 20000 62000 &gt; /proc/sys/net/ipv4/ip_local_port_range
[root@centos8 ~]#cat /proc/sys/net/ipv4/ip_local_port_range
20000 62000

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24120;&#35265;&#30340;&#26381;&#21153;&#31471;&#21475;&#21495;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">vim /etc/services </span>
</pre>
</div>

<p>
范例：nc命令监听端口
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dnf -y install man-pages
[root@centos8 ~]#man 2 socket
[root@centos8 ~]#dnf -y install nc <span style="color: #b22222;">#</span><span style="color: #b22222;">debian apt install netcat-openbsd</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#31471;</span>
[root@centos8 ~]#ss -ntlu <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#26412;&#22320;&#30417;&#21548;&#31471;&#21475;</span>
[root@centos8 ~]#nc -l 22
Ncat: bind to :::22: Address already<span style="color: #a020f0;"> in</span> use. QUITTING.
[root@centos8 ~]#nc -l 9527 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30417;&#21548; 9527&#31471;&#21475;</span>
I am centos7
I am centos8

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;, &#36828;&#31243;&#36830;&#25509;9527&#31471;&#21475;&#65292; &#36755;&#20837;&#20449;&#24687;</span>
[root@centos7 ~]#nc 10.0.0.8 9527
I am centos7
I am centos8
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20877;&#24320;&#19968;&#20010;&#36830;&#25509;&#22833;&#36133;</span>
[root@centos7 ~]#nc 10.0.0.8 9527
Ncat: Connection refused.
[root@centos8 ~]#ss -nt
State             Recv-Q             Send-Q         Local Address:Port                                 Peer
Address:Port
ESTAB             0                         0                             10.0.0.8:9527                                     
10.0.0.7:40706 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#24320;&#21551;UDP&#30340;&#31471;&#21475;</span>
[root@centos8 ~]#nc -l 7000 -u

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#36830;&#25509;</span>
[root@centos7 ~]#nc 10.0.0.8 7000 -u
[root@centos8 ~]#ss -ntu <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#31471;&#21475;</span>
[wang@centos8 ~]$<span style="color: #a0522d;">nc</span> -l 1023
Ncat: bind to :::1023: Permission denied. QUITTING.
</pre>
</div>

<p>
范例：找到端口冲突的应用程序
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nc -l 22
Ncat: bind to :::22: Address already<span style="color: #a020f0;"> in</span> use. QUITTING.
[root@centos8 ~]#ss -ntlp
State     Recv-Q     Send-Q             Local Address:Port     Peer Address:Port             

LISTEN     0                 128                                 0.0.0.0:22                             0.0.0.0:*         
users:((<span style="color: #8b2252;">"sshd"</span>,<span style="color: #a0522d;">pid</span>=699,<span style="color: #a0522d;">fd</span>=4)) 
LISTEN     0                 128                                     [::]:22                                 [::]:*         
users:((<span style="color: #8b2252;">"sshd"</span>,<span style="color: #a0522d;">pid</span>=699,<span style="color: #a0522d;">fd</span>=6)) 

[root@centos8 ~]#lsof -i :22
COMMAND PID USER     FD     TYPE DEVICE SIZE/OFF NODE NAME
sshd         699 root     4u IPv4     26846         0t0 TCP *:ssh (LISTEN)
sshd         699 root     6u IPv6     26848         0t0 TCP *:ssh (LISTEN)
sshd         1287 root     5u IPv4     29875         0t0 TCP centos8.localdomain:ssh-
&gt;10.0.0.1:pc-mta-addrmap (ESTABLISHED)
sshd         1300 root     5u IPv4     29875         0t0 TCP centos8.localdomain:ssh-
&gt;10.0.0.1:pc-mta-addrmap (ESTABLISHED)
</pre>
</div>

<p>
范例：判断端口是否正在打开
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#&lt; /dev/tcp/127.0.0.1/80
[root@centos8 ~]#echo $<span style="color: #a0522d;">?</span>
0
[root@centos8 ~]#&lt; /dev/tcp/127.0.0.1/8080
-bash: connect: Connection refused
-bash: /dev/tcp/127.0.0.1/8080: Connection refused
[root@centos8 ~]#echo $<span style="color: #a0522d;">?</span>
1
</pre>
</div>

<p>
范例：利用重定向模拟浏览器访问网站
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#exec 8&lt;&gt;/dev/tcp/www.baidu.com/80  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#24320;&#26412;&#22320;&#25991;&#20214;&#25551;&#36848;&#31526; &#35775;&#38382;baidu</span>
[root@centos8 ~]#ll /proc/$<span style="color: #a0522d;">$</span>/fd
lrwx------ 1 root root 64 Apr 20 14:14 8 -&gt; <span style="color: #8b2252;">'socket:[32777]'</span>
[root@centos8 ~]# ss -nt |grep 80
ESTAB      0      0      10.0.1.86:41430              182.61.200.7:80
[root@centos8 ~]#echo -e <span style="color: #8b2252;">'GET / HTTP/1.1\n'</span> &gt;&amp; 8 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27169;&#25311;GET&#35831;&#27714;</span>
[root@centos8 ~]#cat &lt;&amp; 8 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35835;&#21462;&#25551;&#36848;&#20869;&#23481; &#19978;&#38754;&#21160;&#20316;&#24555;&#20123;&#65292;&#19981;&#28982;&#36825;&#37324;&#27809;&#26377;&#20869;&#23481;</span>
</pre>
</div>

<p>
<b>TCP端口号通信过程</b>
</p>


<figure id="org35a775c">
<img src="images/image-20210126191018300.png" alt="image-20210126191018300.png" width="50%">

</figure>

<p>
<b>TCP序列和确认号</b>
</p>


<figure id="orgd8100e6">
<img src="images/image-20210126191030496.png" alt="image-20210126191030496.png" width="50%">

</figure>

<p>
<b>TCP确认和固定窗口</b>
</p>

<p>
每次都要要确认效率较低，可以固定窗口，多个包确认一次
</p>


<figure id="orgca6f1fd">
<img src="images/image-20210126191124096.png" alt="image-20210126191124096.png" width="50%">

</figure>

<p>
<b>TCP滑动窗口</b> 窗口大小是经过协商的
</p>


<figure id="orgf233e9c">
<img src="images/image-20210126191134473.png" alt="image-20210126191134473.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:7033a70b-f8ef-45bb-8cdf-972da7a45fe4" class="outline-5">
<h5 id="h:7033a70b-f8ef-45bb-8cdf-972da7a45fe4">三次握手和四次挥手</h5>
<div class="outline-text-5" id="text-h:7033a70b-f8ef-45bb-8cdf-972da7a45fe4">
<p>
<b>建立连接</b>
</p>


<figure id="org8c68d6a">
<img src="images/image-20210126191144573.png" alt="image-20210126191144573.png" width="50%">

</figure>

<p>
<b>TCP三次握手</b>
</p>


<figure id="orgc8df570">
<img src="images/image-20210126191156035.png" alt="image-20210126191156035.png" width="50%">

</figure>

<p>
tcp的三次握手的过程和必要性（这里假设A是client，B是server）
</p>

<ul class="org-ul">
<li><p>
第一次握手：A 发送请求, <code>SYN=1, seq=x</code> , 其中SYN为标志位，seq为序列号
</p>

<p>
先把 TCP 包头中标记 SYN 标记为1，数据包的编
号即包头中的序号打上序号，如是第一个包则写成1，即 seq = 1。通俗讲 A
发送 SYN包（SYNC=j）连接请求到达B，并进入SYN_SEND状态，等待服务器B确
认
</p></li>

<li><p>
第二次握手：B 回应请求, <code>SYN=1, ACK=1, seq=y, ack=x+1</code> , 其中SYN, ACK为标志位，seq为序列号，ack为确认号
</p>

<p>
TCP 包头中标记 SYN 为 1, ACK 为1，请求通信和
确认你来过来的信息，同时数据包的编号 seq = y，包头中确认号为 A 发来
包的序号加 1 即 ack = x + 1 希望下次发 x + 1。通俗讲 B 收到 SYN 包后，
也会发送一个 SYN 包给 A，这个包里面带有ACK=j+1 用来确认 A 的 SYN，和
B 自己的 SYN=k，B 进入 SYN_RECV 状态
</p></li>

<li><p>
第三次握手：A 发回应 让 B 确认刚才请求,  <code>ACK=1,seq=x+1, ack=y+1</code> , 其中ACK为标志位，seq为序列号，ack为确认号
</p>

<p>
标记 ACK = 1，包序号 x + 1，
确认号 y + 1。通俗讲 A 收到 B 的 SYN + ACK 包，向 B 发送确认包
ACK（ACK=k+1），发送完毕，A 和 B 进入 ESTABLISHED 状态，完成三次握手
</p></li>
</ul>

<p>
表述2
</p>
<ul class="org-ul">
<li>请求端（通常称为客户）发送一个 SYN 报文段指明打算连接的服务器的端口，以及初始序号（ISN）。这是报文段 1。</li>
<li>服务器发回包含服务器的初始序号的 SYN 报文段（报文段 2）作为应答。同时，将确认序号设置为客户的 ISN 加 1 以对客户的 SYN 报文段进行确认。一个 SYN 将消耗一个序号。</li>
<li>客户必然将确认序号设置为服务器的 ISN 加 1 以对服务器的 SYN 报文段进行确认（报文段 3）。</li>
</ul>

<p>
表述3
</p>
<ul class="org-ul">
<li>客户端发送 SYN 报文，请求建立连接 （客户端进入 SYN-SEND 状态）</li>
<li>服务端收到 SYN 报文，回复 SYN + ACK 报文，表示同意建立连接 （服务端进入 SYN-RECEIVED 状态，如果服务端停留在这个状态一段时间会自动关闭）</li>
<li>客户端接收到 SYN + ACK 报文，回复 ACK 报文，表示连接建立成功 （客户端和服务端同时进入 ESTABLISHED 状态）</li>
</ul>


<p>
范例：三次握手
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">wireshark &#25235;&#21253;&#20998;&#26512;</span>
(ip.src == 10.0.0.101 and ip.dst == 10.0.0.102) || (ip.dst == 10.0.0.101 and ip.src == 10.0.0.102)
</pre>
</div>

<p>
范例：有限状态机
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#23458;&#25143;&#31471; SYN-SENT&#30636;&#38388;&#29366;&#24577;</span>
iptables -A INPUT -s 10.0.0.208 -j DROP <span style="color: #b22222;">##</span><span style="color: #b22222;">206 &#20316;&#26381;&#21153;&#22120;&#65292;&#20002;&#24323;208&#30340;&#25968;&#25454;&#21253;</span>
ssh  root@10.0.0.206 <span style="color: #b22222;">##</span><span style="color: #b22222;">208 &#23458;&#25143;&#31471;&#24320;&#22987;&#36830;&#25509;&#65292;&#24182;&#26597;&#30475;&#29366;&#24577;</span>
ss -tna |grep SYN-SENT <span style="color: #b22222;">#</span><span style="color: #b22222;">208&#23458;&#25143;&#31471;&#26597;&#30475;&#29366;&#24577;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#26381;&#21153;&#31471;SYN-RECV&#30636;&#38388;&#29366;&#24577;</span>
iptalbes -A INPUT -s 10.0.0.206 -j DROP <span style="color: #b22222;">#</span><span style="color: #b22222;">208&#23458;&#25143;&#31471;&#24320;&#21551;&#38450;&#28779;&#22681;&#65292;&#25243;&#24323;&#26381;&#21153;&#31471;206&#30340;&#21253;&#65292;&#24182;&#21457;&#36215;&#36830;&#25509;</span>
ssh root@10.0.0.206 <span style="color: #b22222;">#</span><span style="color: #b22222;">208&#23458;&#25143;&#31471;&#21457;&#36215;&#36830;&#25509;</span>
ss -tna |grep SYN-RECV <span style="color: #b22222;">#</span><span style="color: #b22222;">206&#26381;&#21153;&#31471;&#26597;&#30475;&#29366;&#24577;</span>
</pre>
</div>


<p>
为什么要三次握手（两次握手不行？）
</p>

<p>
为什么要三次握手？两次握手不行？这主要是为了防止“已失效的连接请求报文段”突然又传送到了 B，因而产生错误。
</p>

<p>
所谓的“已失效的连接请求报文段”是这样产生的。考虑一种正常情况：A 发出
连接请求，但因为连接请求报文丢失而未收到确认。于是 A 再重新发送一次连
接请求。后来收到了确认，建立了连接。数据传输完毕后，就释放了连接。A 一
共发送了两个连接请求报文段，其中第一个丢失，第二个到达了 B。没有“已失
效的连接请求报文段”。
</p>

<p>
现在假定出现一种异常情况，即 A 发出的第一个连接请求报文段并没丢失，而
是在某个网络结点长时间滞留了，以致延误到连接释放以后的某个时间才达到 B。
本来这是一个早已失效的报文段，但 B 收到此失效报文段后，就误认为 A 又发
出一次新的连接请求。于是就向 A 发出确认报文段，同意建立连接。假定不采
用三次握手，那么只要 B 发出确认，B 就进入连接建立状态。由于 A 并没有发
出连接请求，因此，会忽略 B 的连接确认报文段，也不会向 B 发送数据，但是
B 却一直处于连接建立状态，一直在等待 A 发送数据，这样导致 B 的资源被白
白浪费。
</p>

<p>
采用三次握手可以防止上述现象的发生，例如在上述情况下，由于 A 并没有发
出连接请求，因此，并不会发出确认信号，而 B 没有收到确认报文段，也就不
会进入连接建立状态，这样就能避免 A 没有进入连接建立状态，而 B 处于连接
建立状态的情况。
</p>

<p>
<b>TCP四次挥手</b>
</p>


<figure id="orge4ba3c3">
<img src="images/image-20210126191209808.png" alt="image-20210126191209808.png" width="50%">

</figure>

<p>
A 完整的断开连接：
</p>

<ul class="org-ul">
<li><p>
第一次挥手：A-&gt;B, <code>FIN=1, seq=u</code>
</p>

<p>
是ESTABLISHED状态；A向B发出释放连接请求的报文，其
中FIN（终止位）= 1，seq（序列号）=u；在A发送完之后，A的TCP客户端进入
FIN-WAIT-1（终止等待1）状态。此时A还是可以进行收数据的
</p></li>

<li><p>
第二次挥手：B-&gt;A, <code>ACK=1, seq=v, ack=u+1</code>
</p>

<p>
B在收到A的连接释放请求后，随即向A发送确认报文。其
中ACK=1，seq=v，ack（确认号）= u +1;在B发送完毕后，B的服务器端进入
CLOSE_WAIT（关闭等待）状态。此时A收到这个确认后就进入FIN-WAIT-2（终
止等待2）状态，等待B发出连接释放的请求。此时B还是可以发数据的
</p></li>
</ul>

<p>
B 完整的断开连接：
</p>

<ul class="org-ul">
<li><p>
第三次挥手：B-&gt;A, <code>FIN=1, ACK=1, seq=w, ack=u+1</code>
</p>

<p>
当B已经没有要发送的数据时，B就会给A发送一个释放连
接报文，其中FIN=1，ACK=1，seq=w，ack=u+1，在B发送完之后，B进入
LAST-ACK（最后确认）状态。
</p></li>

<li><p>
第四次挥手：A-&gt;B, <code>ACK=1, seq=u+1, ack=w+1</code>
</p>

<p>
当A收到B的释放连接请求时，必须对此发出确认，其中
ACK=1，seq=u+1,ack=w+1;A在发送完毕后，进入到TIME-WAIT（时间等待）状
态。B在收到A的确认之后，进入到CLOSED（关闭）状态。在经过时间等待计时
器设置的时间之后，A才会进入CLOSED状态。
</p></li>
</ul>

<p>
表述2
</p>
<ul class="org-ul">
<li>客户端向服务端发送 FIN 报文，请求断开连接 （客户端进入FIN-WAIT-1 状态）</li>
<li>服务端收到 FIN 报文，回复 ACK 报文 （服务端进入 CLOSE-WAIT 状态,  客户端收到来自服务端的确认后，就进入 FIN-WAIT-2 状态，等待服务端发出的连接释放报文段。）</li>
<li>服务端将未传输完的数据传输完后，向客户端发送 FIN 报文，请求断开连接 （服务端进入 LAST-ACK 状态）</li>
<li>客户端收到 FIN 报文，回复 ACK 报文 （客户端进入 TIME-WAIT 状态，一段时间后 CLOSEED）此时服务端进入 CLOSEED 状态</li>
</ul>

<p>
注意：
</p>

<ul class="org-ul">
<li>客户端收到服务端断开请求，发送确认；客户端状态变为TIMED_WAIT ​#完成双
向传输连接关闭，等待所有分组消失  （报文最长时间的2倍）2MSL</li>

<li>特殊的状态 CLOSING 客户端向服务端发送了FIN但没有收到服务端的ACK而是
服务端FIN；进入CLOSING状态的接下来的流程和FIN_WAIT 2接下来的流程是一
样的 #双方同时尝试关闭传输连接，等待对方确认</li>
</ul>


<p>
范例：查看MSL
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@proxy ~]# sysctl  net.ipv4.tcp_fin_timeout
net.ipv4.tcp_fin_timeout = 60

[root@proxy ~]# cat /proc/sys/net/ipv4/tcp_fin_timeout 
60
</pre>
</div>

<p>
tcp三次握手视频教程<a href="https://www.bilibili.com/video/BV1ai4y1s7sG?from=search&amp;seid=9632617334137845903&amp;spm_id_from=333.337.0.0">https://www.bilibili.com/video/BV1ai4y1s7sG?from=search&amp;seid=9632617334137845903&amp;spm_id_from=333.337.0.0</a>
</p>

<p>
为什么要等待 2MSL（或为什么需要 TIME_WAIT 状态）
</p>

<p>
为什么 A 在 TIME-WAIT 状态必须等待 2MSL 的时间呢？有两个理由：
</p>
<ul class="org-ul">
<li>为了保证 A 发送的最后一个 ACK 报文段能够到达 B。这个 ACK 报文段有可
能丢失，因而使处于 LAST-ACK 状态的 B 收不到对已发送的 FIN+ACK 报文段
的确认。B 会超时重传这个 FIN+ACK 报文段，而 A 就能在 2MSL 时间内收到
这个重传的 FIN+ACK 报文段。</li>
<li>为了本连接持续的时间内所产生的所有报文段都从网络中消失，这样就可以使下一个新的连接中不会出现这种旧的连接请求报文段。</li>
</ul>
</div>
</div>
<div id="outline-container-h:274661d1-0372-45ac-9721-4b24e068a82a" class="outline-5">
<h5 id="h:274661d1-0372-45ac-9721-4b24e068a82a">有限状态机 FSM:Finite State Machine</h5>
<div class="outline-text-5" id="text-h:274661d1-0372-45ac-9721-4b24e068a82a">
<div class="org-src-container">
<pre class="src src-sh">[root@proxy ~]# man 8 netstat

       ESTABLISHED
              The socket has an established connection.

       SYN_SENT
              The socket is actively attempting to establish a connection.

       SYN_RECV
              A connection request has been received from the network.

       FIN_WAIT1
              The socket is closed, and the connection is shutting down.

       FIN_WAIT2
              Connection is closed, and the socket is waiting for a shutdown from the remote end.

       TIME_WAIT
              The socket is waiting after close to handle packets still<span style="color: #a020f0;"> in</span> the network.

       CLOSE  The socket is not being used.

       CLOSE_WAIT
              The remote end has shut down, waiting for the socket to close.

       LAST_ACK
              The remote end has shut down, and the socket is closed. Waiting for acknowledgement.

       LISTEN The socket is listening for incoming connections.  Such sockets are not included<span style="color: #a020f0;"> in</span> the output unless you specify the --listening (-l) or --all (-a) option.

       CLOSING
              Both sockets are shut down but we still don<span style="color: #8b2252;">'t have all our data sent.</span>

<span style="color: #8b2252;">       UNKNOWN</span>
<span style="color: #8b2252;">              The state of the socket is unknown.</span>
</pre>
</div>


<p>
虚线：服务器 实线：客户端
</p>


<figure id="orgc046b59">
<img src="images/image-20210126191232847.png" alt="image-20210126191232847.png" width="50%">

</figure>

<ul class="org-ul">
<li>CLOSED 没有任何连接状态</li>
<li>LISTEN 侦听状态，等待来自远方TCP端口的连接请求</li>
<li>SYN-SENT 在发送连接请求后，等待对方确认</li>
<li>SYN-RECEIVED 在收到和发送一个连接请求后，等待对方确认</li>
<li>ESTABLISHED 代表传输连接建立，双方进入数据传送状态</li>
<li>FIN-WAIT-1 主动关闭,主机已发送关闭连接请求，等待对方确认</li>
<li>FIN-WAIT-2
主动关闭,主机已收到对方关闭传输连接确认，等待对方发送关闭传输连接请求</li>
<li>TIME-WAIT 完成双向传输连接关闭，等待所有分组消失</li>
<li>CLOSE-WAIT 被动关闭,收到对方发来的关闭连接请求，并已确认</li>
<li>LAST-ACK 被动关闭,等待最后一个关闭传输连接确认，并等待所有分组消失</li>
<li>CLOSING 双方同时尝试关闭传输连接，等待对方确认</li>
</ul>

<p>
客户端先发送一个FIN给服务端，自己进入FIN_WAIT_1状态，这时等待接收服务
端报文，该报文会有三种可能：
</p>

<ol class="org-ol">
<li><p>
只有服务端的ACK
</p>

<p>
只收到服务器的ACK，客户端会进入FIN_WAIT_2状态，后续当收到服务端的
FIN时，回应发送一个ACK，会进入到TIME_WAIT状态，这个状态会持续
2MSL(TCP 报文段在网络中的最大生存时间, RFC1122标准的建议值是2min).客
户端等待 2MSL，是为了当最后一个ACK丢失时，可以再发送一次。因为服务端
在等待超时 后会再发送一个FIN给客户端，进而客户端知道ACK已丢失
</p></li>

<li><p>
只有服务端的FIN
</p>

<p>
只有服务端的FIN时，回应一个ACK给服务端，进入CLOSING状态，然后接收到服务端的ACK时，进入TIME_WAIT状态
</p></li>

<li><p>
基于服务端的ACK，又有FIN
</p>

<p>
同时收到服务端的ACK和FIN，直接进入TIME_WAIT状态
</p></li>
</ol>



<p>
<b>客户端的典型状态转移</b>
</p>

<p>
客户端通过connect系统调用主动与服务器建立连接connect系统调用首先给服务
器发送一个同步报文段，使连接转移到SYN_SENT状态
</p>

<p>
此后connect系统调用可能因为如下两个原因失败返回：
</p>

<p>
1、如果connect连接的目标端口不存在（未被任何进程监听），或者该端口仍被
处于TIME_WAIT状态的连接所占用，则服务器将给客户端发送一个复位报文段，
connect调用失败。
</p>

<p>
2、如果目标端口存在，但connect在超时时间内未收到服务器的确认报文段，则
connect调用失败。connect调用失败将使连接立即返回到初始的CLOSED状态。如
果客户端成功收到服务器的同步报文段和确认，则connect调用成功返回，连接
转移至ESTABLISHED状态
</p>

<p>
当客户端执行主动关闭时，它将向服务器发送一个结束报文段，同时连接进入
FIN_WAIT_1状态。若此时客户端收到服务器专门用于确认目的的确认报文段，则
连接转移至FIN_WAIT_2状态。当客户端处于FIN_WAIT_2状态时，服务器处于
CLOSE_WAIT状态，这一对状态是可能发生半关闭的状态。此时如果服务器也关闭
连接（发送结束报文段），则客户端将给予确认并进入TIME_WAIT状态客户端从
FIN_WAIT_1状态可能直接进入TIME_WAIT状态（不经过FIN_WAIT_2状态），前提
是处于FIN_WAIT_1状态的服务器直接收到带确认信息的结束报文段（而不是先收
到确认报文段，再收到结束报文段）
</p>

<p>
处于FIN_WAIT_2状态的客户端需要等待服务器发送结束报文段，才能转移至
TIME_WAIT状态，否则它将一直停留在这个状态。如果不是为了在半关闭状态下
继续接收数据，连接长时间地停留在FIN_WAIT_2状态并无益处。连接停留在
FIN_WAIT_2状态的情况可能发生在：客户端执行半关闭后，未等服务器关闭连接
就强行退出了。此时客户端连接由内核来接管，可称之为孤儿连接（和孤儿进程
类似）
</p>

<p>
Linux为了防止孤儿连接长时间存留在内核中，定义了两个内核参数：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@proxy ~]# cat /proc/sys/net/ipv4/tcp_max_orphans  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#20869;&#26680;&#33021;&#25509;&#31649;&#30340;&#23396;&#20799;&#36830;&#25509;&#25968;&#30446;</span>
16384
[root@proxy ~]# cat /proc/sys/net/ipv4/tcp_fin_timeout <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#23396;&#20799;&#36830;&#25509;&#22312;&#20869;&#26680;&#20013;&#29983;&#23384;&#30340;&#26102;&#38388;</span>
60
</pre>
</div>

<p>
<b>客户机端的三次握手和四次挥手状态转换</b>
</p>


<figure id="org2ac6f4a">
<img src="images/image-20210126191251742.png" alt="image-20210126191251742.png" width="50%">

</figure>

<p>
<b>服务器端的三次握手和四次挥手状态转换</b>
</p>


<figure id="org62832d9">
<img src="images/image-20210126191301568.png" alt="image-20210126191301568.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:4b385d99-033c-4dfe-b737-746e0717a9ee" class="outline-5">
<h5 id="h:4b385d99-033c-4dfe-b737-746e0717a9ee">sync半连接和accept全连接队列</h5>
<div class="outline-text-5" id="text-h:4b385d99-033c-4dfe-b737-746e0717a9ee">
<p>
三次握手中的第一次握手后对方还没回来第 2 第 3个握手之前的状态，没完全
建立连接请求放入队列中，队列的最大值是有限制的。
</p>


<figure id="orgf362034">
<img src="images/image-20210126191317827.png" alt="image-20210126191317827.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-sh">/proc/sys/net/ipv4/tcp_max_syn_backlog   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26410;&#23436;&#25104;&#36830;&#25509;&#38431;&#21015;&#22823;&#23567;&#65292;&#40664;&#35748;&#20540;128,&#24314;&#35758;&#35843;&#25972;&#22823;&#23567;&#20026;1024&#20197;&#19978;</span>
/proc/sys/net/core/somaxconn    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23436;&#25104;&#36830;&#25509;&#38431;&#21015;&#22823;&#23567;&#65292;&#40664;&#35748;&#20540;128,&#24314;&#35758;&#35843;&#25972;&#22823;&#23567;&#20026;1024&#20197;&#19978;</span>
</pre>
</div>


<figure id="orgee5e805">
<img src="images/image-20210126191343421.png" alt="image-20210126191343421.png" width="50%">

</figure>

<p>
bind()函数监听本地端口
</p>


<figure id="orgd5f9454">
<img src="images/image-20210126191400791.png" alt="image-20210126191400791.png" width="50%">

</figure>

<p>
三次握手中syn_sent (client)&#x2013;&gt; syn_rcvd(server) &#x2013;&gt;established(client)
过程半连接， <code>半连接队列</code> 记录 再到established(server)全连接，从半连接
队列中删除，进入 <code>全连接队列</code>
</p>

<p>
范例： <b>单边连接导致交易超时</b>
</p>

<p>
1、分析单边连接产生的原因
</p>

<p>
TCP建立连接三次握手的过程中，若全连接队列满，将导致单边连接。
</p>


<figure id="orgfa0c120">
<img src="images/image-20210512150850717.png" alt="image-20210512150850717.png" width="50%">

</figure>

<p>
全连接队列大小由系统参数 net.core.somaxconn 及
listen(somaxconn,backlog)的 backlog 取最小值决定。somaxconn 是 Linux
内核的参数，默认值是128；backlog 在创建 Socket 时设置，Dubbo2.5.9 中默
认 backlog 值是50。因此，生产环境全连接队列是 50。通过 ss 命令（Socket
Statistics)也查得全连接队列大小为 50。
</p>

<div class="org-src-container">
<pre class="src src-sh">ss -tnp
State      Recv-Q Send-Q          Local Address:Port          Peer Address:Port
ESTAB      0      50          10.0.3.205:22       10.16.202.178:53982users:((<span style="color: #8b2252;">"xx"</span>,<span style="color: #a0522d;">pid</span>=33493,<span style="color: #a0522d;">fd</span>=3),(<span style="color: #8b2252;">"xx"</span>,<span style="color: #a0522d;">pid</span>=33491,<span style="color: #a0522d;">fd</span>=3))
</pre>
</div>

<p>
观察 TCP 连接队列情况，证实存在全连接队列溢出的现象。
</p>


<figure id="orgeefaa81">
<img src="images/image-20210512151243227.png" alt="image-20210512151243227.png" width="50%">

</figure>

<p>
即：全连接队列容量不足导致大量单边连接产生。因在本验证场景下，订阅提供
方的消费方数量过多，当提供方重启后，注册中心向消费方推送提供方上线通知，
所有消费方几乎同时与提供方重建连接，导致全连接队列溢出。
</p>

<p>
2、分析单边连接影响范围
</p>

<p>
单边连接影响范围多为消费方首笔交易，偶发为首笔开始连续失败 2-3 笔。
</p>
</div>
</div>
<div id="outline-container-h:8590cf52-e1e2-4e70-a811-49a0129789b9" class="outline-5">
<h5 id="h:8590cf52-e1e2-4e70-a811-49a0129789b9">TCP超时重传</h5>
<div class="outline-text-5" id="text-h:8590cf52-e1e2-4e70-a811-49a0129789b9">
<p>
异常网络状况下（开始出现超时或丢包），TCP控制数据传输以保证其承诺的可
靠服务TCP服务必须能够重传超时时间内未收到确认的TCP报文段。为此，TCP模
块为每个TCP报文段都维护一个重传定时器，该定时器在TCP报文段第一次被发送
时启动。如果超时时间内未收到接收方的应答，TCP模块将重传TCP报文段并重置
定时器。至于下次重传的超时时间如何选择，以及最多执行多少次重传，就是
TCP的重传策略
</p>

<p>
与TCP超时重传相关的两个内核参数：
</p>

<div class="org-src-container">
<pre class="src src-sh">/proc/sys/net/ipv4/tcp_retries1  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#22312;&#24213;&#23618;IP&#25509;&#31649;&#20043;&#21069;TCP&#26368;&#23569;&#25191;&#34892;&#30340;&#37325;&#20256;&#27425;&#25968;&#65292;&#40664;&#35748;&#20540;&#26159;3</span>
/proc/sys/net/ipv4/tcp_retries2  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#36830;&#25509;&#25918;&#24323;&#21069;TCP&#26368;&#22810;&#21487;&#20197;&#25191;&#34892;&#30340;&#37325;&#20256;&#27425;&#25968;&#65292;&#40664;&#35748;&#20540;15&#65288;&#19968;&#33324;&#23545;&#24212;13&#65374;30min&#65289;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0f57b6c9-286d-4f3b-93d6-62541ff69405" class="outline-5">
<h5 id="h:0f57b6c9-286d-4f3b-93d6-62541ff69405">拥塞控制</h5>
<div class="outline-text-5" id="text-h:0f57b6c9-286d-4f3b-93d6-62541ff69405">
<p>
网络中的带宽、交换结点中的缓存和处理机等，都是网络的资源。在某段时间，
若对网络中某一资源的需求超过了该资源所能提供的可承受的能力，网络的性能
就会变坏。此情况称为拥塞
</p>

<p>
TCP为提高网络利用率，降低丢包率，并保证网络资源对每条数据流的公平性。
即所谓的拥塞控制
</p>

<p>
TCP拥塞控制的标准文档是RFC 5681，其中详细介绍了拥塞控制的四个部分：慢
启动（slow start）、拥塞避免（congestion avoidance）、快速重传（fast
retransmit）和快速恢复（fast recovery）。拥塞控制算法在Linux下有多种实
现，比如reno算法、vegas算法和cubic算法等。它们或者部分或者全部实现了上
述四个部分
</p>

<div class="org-src-container">
<pre class="src src-sh">/proc/sys/net/ipv4/tcp_congestion_control  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#25152;&#20351;&#29992;&#30340;&#25317;&#22622;&#25511;&#21046;&#31639;&#27861;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7f56eb5b-304a-4c2e-92b9-9727b930909c" class="outline-5">
<h5 id="h:7f56eb5b-304a-4c2e-92b9-9727b930909c">内核TCP参数优化</h5>
<div class="outline-text-5" id="text-h:7f56eb5b-304a-4c2e-92b9-9727b930909c">
<p>
参看帮助： man tcp
</p>

<p>
编辑文件/etc/sysctl.conf，加入以下内容：然后执行 sysctl -p 让参数生效。
</p>

<div class="org-src-container">
<pre class="src src-sh">net.ipv4.tcp_fin_timeout = 2
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_keepalive_time = 600
net.ipv4.ip_local_port_range = 2000 65000
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.route.gc_timeout = 100
net.ipv4.tcp_syn_retries = 1
net.ipv4.tcp_synack_retries = 1
net.ipv4.tcp_max_orphans = 16384
net.core.somaxconn = 16384
net.core.netdev_max_backlog = 16384
</pre>
</div>

<p>
作用说明：
</p>

<ul class="org-ul">
<li>net.ipv4.tcp_fin_timeout
表示套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-2状态的时间，默认值是60秒。
该参数对应系统路径为：/proc/sys/net/ipv4/tcp_fin_timeout 60</li>

<li>net.ipv4.tcp_tw_reuse 表示开启重用。允许将TIME-WAIT
sockets重新用于新的TCP连接，默认值为0，表示关闭。
该参数对应系统路径为：/proc/sys/net/ipv4/tcp_tw_reuse 0</li>

<li>net.ipv4.tcp_tw_recycle 表示开启TCP连接中TIME-WAIT sockets的快速回收。
该参数对应系统路径为：/proc/sys/net/ipv4/tcp_tw_recycle，默认为0，表示关闭。
提示：reuse和recycle这两个参数是为防止生产环境下Web、Squid等业务服务器time_wait网络状态数量过多设置的。</li>

<li>net.ipv4.tcp_syncookies 表示开启SYN
Cookies功能。当出现SYN等待队列溢出时，启用Cookies来处理，可防范少量SYN攻击，这个参数也可以不添加。
该参数对应系统路径为：/proc/sys/net/ipv4/tcp_syncookies,默认值为1</li>

<li>net.ipv4.tcp_keepalive_time
表示当keepalive启用时，TCP发送keepalive消息的频度。默认是2小时，建议改为10分钟。
该参数对应系统路径为：/proc/sys/net/ipv4/tcp_keepalive_time,默认为7200秒。</li>

<li>net.ipv4.ip_local_port_range
该选项用来设定允许系统打开的端口范围，即用于向外连接的端口范围。
该参数对应系统路径为：/proc/sys/net/ipv4/ip_local_port_range 32768
61000</li>

<li>net.ipv4.tcp_max_syn_backlog
表示SYN队列的长度，即半连接队列长度，默认为1024，建议加大队列的长度为8192或更多，这样可以容纳更多等待连接的网络连接数。
该参数为服务器端用于记录那些尚未收到客户端确认信息的连接请求最大值。
该参数对象系统路径为：/proc/sys/net/ipv4/tcp_max_syn_backlog</li>

<li>net.ipv4.tcp_max_tw_buckets
表示系统同时保持TIME_WAIT套接字的最大数量，如果超过这个数值，TIME_WAIT套接字将立刻被清除并打印警告信息。
默认为180000，对于Apache、Nginx等服务器来说可以将其调低一点，如改为5000~30000，不通业务的服务器也可以给大一点，比如LVS、Squid。
此项参数可以控制TIME_WAIT套接字的最大数量，避免Squid服务器被大量的TIME_WAIT套接字拖死。
该参数对应系统路径为：/proc/sys/net/ipv4/tcp_max_tw_buckets</li>

<li>net.ipv4.tcp_synack_retries
参数的值决定了内核放弃连接之前发送SYN+ACK包的数量。 该参数
对应系统路径为：/proc/sys/net/ipv4/tcp_synack_retries,默认值为5</li>

<li>net.ipv4.tcp_syn_retries 表示在内核放弃建立连接之前发送SYN包的数量。
该参数对应系统路径为：/proc/sys/net/ipv4/tcp_syn_retries,默认值为6</li>

<li>net.ipv4.tcp_max_orphans
用于设定系统中最多有多少个TCP套接字不被关联到任何一个用户文件句柄上。
如果超过这个数值，孤立连接将被立即被复位并打印出警告信息。
这个限制只有为了防止简单的DoS攻击。不能过分依靠这个限制甚至认为减少这个值，更多的情况是增加这个值。该参数对应系统路径为：/proc/sys/net/ipv4/tcp_max_orphans
，默认值8192</li>

<li>net.core.somaxconn
同时发起的TCP的最大连接数，即全连接队列长度，在高并发请求中，可能会导致链接超时或重传，一般结合并发请求数来调大此值。
该参数对应系统路径为：/proc/sys/net/core/somaxconn ，默认值是128</li>

<li>net.core.netdev_max_backlog
表示当每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许发送到队列的数据包最大数。
该参数对应系统路径为：/proc/sys/net/core/netdev_max_backlog，默认值为1000</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:cda7f942-b2e8-4557-87ad-ba9cc944e1c7" class="outline-4">
<h4 id="h:cda7f942-b2e8-4557-87ad-ba9cc944e1c7">UDP User Datagram Protocol</h4>
<div class="outline-text-4" id="text-h:cda7f942-b2e8-4557-87ad-ba9cc944e1c7">
</div>
<div id="outline-container-h:55b072a2-5aff-4a22-8505-03fb83f5e7c1" class="outline-5">
<h5 id="h:55b072a2-5aff-4a22-8505-03fb83f5e7c1">UDP特性</h5>
<div class="outline-text-5" id="text-h:55b072a2-5aff-4a22-8505-03fb83f5e7c1">
<ul class="org-ul">
<li>工作在传输层</li>
<li>提供不可靠的网络访问</li>
<li>非面向连接协议</li>
<li>有限的错误检查</li>
<li>传输性能高</li>
<li>无数据恢复特性</li>
</ul>

<p>
更多关于udp的内核参数，可参看man 7 udp
</p>
</div>
</div>
<div id="outline-container-h:af1533e5-a9f2-4cc5-ac91-2863159d2e5f" class="outline-5">
<h5 id="h:af1533e5-a9f2-4cc5-ac91-2863159d2e5f">UDP包头</h5>
<div class="outline-text-5" id="text-h:af1533e5-a9f2-4cc5-ac91-2863159d2e5f">

<figure id="org9b33173">
<img src="images/image-20210126191419093.png" alt="image-20210126191419093.png" width="20%">

</figure>

<pre class="example" id="orgd86e670">
 0              15 16             31
+-----------------+-----------------+
| Source Port     |Destination Port |
+-----------------+-----------------+
|                 |                 |
|     Length      |    Checksum     |
+-----------------+-----------------+
|                                   |
|          data octets ...          |
+-----------------------------------+
</pre>

<p>
PS: TCP 和 UDP 协议是独立的，所以可以有相同的端口号。
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-h:7484cb90-c7d9-476d-938f-a69ca8cab660" class="outline-3">
<h3 id="h:7484cb90-c7d9-476d-938f-a69ca8cab660">Internet Layer 网络层</h3>
<div class="outline-text-3" id="text-h:7484cb90-c7d9-476d-938f-a69ca8cab660">

<figure id="org3f00ede">
<img src="images/image-20210126191428369.png" alt="image-20210126191428369.png" width="50%">

</figure>
</div>
<div id="outline-container-h:35d0a855-05db-47fe-a779-f22fd6f416e2" class="outline-4">
<h4 id="h:35d0a855-05db-47fe-a779-f22fd6f416e2">Internet Control Message Protocol(ICMP)</h4>
<div class="outline-text-4" id="text-h:35d0a855-05db-47fe-a779-f22fd6f416e2">

<figure id="org2164129">
<img src="images/image-20210126191437391.png" alt="image-20210126191437391.png" width="50%">

</figure>

<p>
报文格式
</p>
<pre class="example" id="orgf5454e2">
+0------7-------15---------------31
|  Type | Code  |    Checksum    |
+--------------------------------+
|          Message Body          |
|        (Variable length)       |
+--------------------------------+
</pre>

<p>
范例: 利用icmp协议判断网络状态
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">ping 223.5.5.5</span>
PING 223.5.5.5 (223.5.5.5) 56(84) bytes of data.
64 bytes from 223.5.5.5: <span style="color: #a0522d;">icmp_seq</span>=1 <span style="color: #a0522d;">ttl</span>=115 <span style="color: #a0522d;">time</span>=6.33 ms
^C
--- 223.5.5.5 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4003ms
rtt min/avg/max/mdev = 5.502/6.090/6.334/0.303 ms

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35828;&#26126;</span>
64 bytes from    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#23545;&#26041;&#20027;&#26426;&#22238;&#24212;&#30340;64&#23383;&#33410;&#30340;&#25253;&#25991;</span>
icmp_seq            <span style="color: #b22222;">#</span><span style="color: #b22222;">icmp&#32534;&#21495;&#65292;&#39034;&#24207;&#32047;&#21152;</span>
<span style="color: #a0522d;">ttl</span>=64                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#21253;&#30340;&#29983;&#23384;&#26102;&#38388;&#65292;&#20320;&#21487;&#20197;&#21435;&#25913;&#23427;&#65292;&#26377;&#30340;&#31995;&#32479;&#26159;256&#26377;&#30340;&#26159;128&#26377;&#30340;&#26159;64&#20063;&#26377;32&#30340;&#65292;</span>
                            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#19968;&#20010;&#25968;&#25454;&#21253;&#32463;&#36807;&#19968;&#20010;&#36335;&#30001;&#30340;&#26102;&#20505;&#36825;&#20010;&#26102;&#38388;&#23601;&#20250;&#20943;&#19968;&#65292;&#24403;TTL&#65309;1&#30340;&#26102;&#20505;&#25968;&#25454;&#21253;&#36824;&#27809;&#26377;&#21040;&#36798;&#30446;&#30340;&#22320;&#30340;&#26102;&#20505;&#65292;&#25968;&#25454;&#21253;&#23601;&#20250;&#34987;&#20002;&#24323;&#20102;</span>
<span style="color: #a0522d;">time</span>=0.307 ms  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22238;&#24212;&#25253;&#25991;&#33457;&#36153;&#26102;&#38388;</span>
rtt min/avg/max/mdev  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#33324;&#20851;&#27880;&#24179;&#22343;&#20540;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#26041;&#20027;&#26426;&#26080;&#27861;&#36830;&#25509;</span>
[root@centos7 ~]#ping 10.0.0.81
PING 10.0.0.81 (10.0.0.81) 56(84) bytes of data.
From 10.0.0.7 <span style="color: #a0522d;">icmp_seq</span>=1 Destination Host Unreachable
From 10.0.0.7 <span style="color: #a0522d;">icmp_seq</span>=2 Destination Host Unreachable

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#26631;&#31471;&#21475;&#19981;&#21487;&#36798;&#65292;&#21487;&#33021;&#26159;&#38450;&#28779;&#22681;&#21407;&#22240;</span>
[root@centos7 ~]#ping 10.0.0.8
PING 10.0.0.8 (10.0.0.8) 56(84) bytes of data.
From 10.0.0.8 <span style="color: #a0522d;">icmp_seq</span>=1 Destination Port Unreachable
From 10.0.0.8 <span style="color: #a0522d;">icmp_seq</span>=2 Destination Port Unreachable

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21517;&#31216;&#26381;&#21153;&#26410;&#30693;&#65292;&#21487;&#33021;&#26159; dns &#35299;&#26512;&#38382;&#39064;</span>
[root@centos8 ~]#ping www.you.org
ping: www.you.org: Name or service not known
</pre>
</div>

<p>
范例：发大数据包
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748; ICMP &#25968;&#25454;&#25253;&#25991;&#21253;&#30340;&#22823;&#23567;&#20026; 64 &#20010;&#23383;&#33410;&#65292;&#21487;&#20197;&#25351;&#23450;&#22823;&#23567;&#65292;&#26368;&#22823; 65507&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20294;&#20197;&#22826;&#32593;&#25968;&#25454;&#24103;&#30340;&#22823;&#23567;&#20026; 46-1500 &#20301;&#65292;&#35774;&#32622; 65507 &#20250;&#25226;&#23427;&#20999;&#25104;&#23567;&#21253;</span>
[root@centos8 ~]#ping -s 65508 10.0.0.8 
Error: packet size 65508 is too large. Maximum is 65507

<span style="color: #b22222;">#</span><span style="color: #b22222;">-f flood &#23454;&#29616;&#32593;&#32476;&#30340;&#25915;&#20987;</span>
[root@centos8 ~]#ping -s 65507 -f 10.0.0.8 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26368;&#22823;&#21457;&#36865;65507 &#23383;&#33410;&#30340;&#21253;  -f &#23613;CPU&#25152;&#33021;</span>
PING 172.16.21.111 (172.16.21.111) 65507(65535) bytes of data.
........................................................

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23454;&#26102;&#21047;&#26032;&#32593;&#21345;&#25968;&#25454;</span>
watch ifconfig eth0
</pre>
</div>


<figure id="orgacbc703">
<img src="images/image-20210126191451007.png" alt="image-20210126191451007.png" width="50%">

</figure>

<p>
type类型
</p>
<ul class="org-ul">
<li>0是回显应答(ping应答)，8是请求回显(ping请求)</li>
</ul>
</div>
</div>
<div id="outline-container-h:8c6856a3-c380-4846-8730-51eacf2beaeb" class="outline-4">
<h4 id="h:8c6856a3-c380-4846-8730-51eacf2beaeb">Address Resolution Protocol(ARP)</h4>
<div class="outline-text-4" id="text-h:8c6856a3-c380-4846-8730-51eacf2beaeb">
</div>
<div id="outline-container-h:6810101e-7ee0-4482-9eae-01d0532fd309" class="outline-5">
<h5 id="h:6810101e-7ee0-4482-9eae-01d0532fd309">ARP</h5>
<div class="outline-text-5" id="text-h:6810101e-7ee0-4482-9eae-01d0532fd309">
<p>
ARP 地址解析协议由互联网工程任务组（IETF）在1982年11月发布的RFC
826中描述制定，是根据IP地址获取物理地址的一个TCP/IP协议。
</p>

<p>
主机发送信息时将包含目标IP地址的ARP请求广播到局域网络上的所有主机，并
接收返回消息，以此确定目标的物理地址；收到返回消息后将该IP地址和物理地
址存入本机ARP缓存中并保留一定时间，下次请求时直接查询ARP缓存以节约资源。
地址解析协议是建立在网络中各个主机互相信任的基础上的，局域网络上的主机
可以自主发送ARP应答消息，其他主机收到应答报文时不会检测该报文的真实性
就会将其记入本机ARP缓存
</p>

<p>
<b>同网段的ARP</b>
</p>


<figure id="org0b4dae2">
<img src="images/image-20210126191507252.png" alt="image-20210126191507252.png" width="50%">

</figure>

<p>
<b>跨网段的ARP</b>
</p>


<figure id="org6863f8c">
<img src="images/image-20210126191520357.png" alt="image-20210126191520357.png" width="50%">

</figure>

<p>
范例：ARP 表
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@you ~]#ip neigh
192.168.1.110 dev eth0 lladdr 60:02:b4:e3:8a:c0 STALE
192.168.1.156 dev eth0 lladdr 50:01:d9:8a:1d:3f STALE
192.168.1.114 dev eth0 lladdr 40:8d:5c:e1:97:34 STALE
192.168.1.118 dev eth0 lladdr 94:65:2d:38:44:82 STALE

[root@you ~]#arp -n
Address                                 HWtype HWaddress                     Flags Mask                     Iface
192.168.1.110                     ether     60:02:b4:e3:8a:c0     C                                         eth0
192.168.1.156                     ether     50:01:d9:8a:1d:3f     C                                         eth0
192.168.1.114                     ether     40:8d:5c:e1:97:34     C                                         eth0
192.168.1.118                     ether     94:65:2d:38:44:82     C                                         eth0
</pre>
</div>

<p>
范例：分析 arp 数据
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">tcpdump -i eth0 arp -nn</span>
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
11:44:53.836190 ARP, Request who-has 169.254.128.8 tell 10.0.4.12, length 28
11:44:53.836246 ARP, Reply 169.254.128.8 is-at fe:ee:8f:bf:86:99, length 28
</pre>
</div>

<p>
范例：ARP静态绑定可以防止ARP欺骗
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#arp -s 10.0.0.6 00:0c:29:32:80:38
[root@centos8 ~]#arp -n
Address                                 HWtype HWaddress                     Flags Mask                     Iface
10.0.0.6                                 ether     00:0c:29:32:80:38     CM                                     eth0
10.0.0.7                                 ether     00:0c:29:32:80:38     C                                         eth0
10.0.0.1                                 ether     00:50:56:c0:00:08     C                                         eth0
</pre>
</div>

<p>
范例：kali 系统实现 arp 欺骗上网流量劫持
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#36335;&#30001;&#36716;&#21457;&#21151;&#33021;,&#36716;&#21457;&#25968;&#25454;&#25253;&#25991;</span>
[root@kali ~]# echo 1 &gt; /proc/sys/net/ipv4/ip_forward

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#21253;</span>
[root@kali ~]# apt install dsniff

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27450;&#39575;&#30446;&#26631;&#20027;&#26426;&#65292;&#26412;&#26426;&#26159;&#32593;&#20851;</span>
[root@kali ~]# arpspoof -i eth0 -t &#34987;&#21163;&#25345;&#30340;&#30446;&#26631;&#20027;&#26426;IP   &#32593;&#20851;IP

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27450;&#39575;&#32593;&#20851;&#65292;&#26412;&#26426;&#26159;&#30446;&#26631;&#20027;&#26426;</span>
[root@kali ~]# arpspoof -i eth0 -t &#32593;&#20851;IP   &#34987;&#21163;&#25345;&#30340;&#30446;&#26631;&#20027;&#26426;IP
</pre>
</div>
</div>
</div>
<div id="outline-container-h:48ed9e24-3096-42e8-a9d4-454e85a8a3bc" class="outline-5">
<h5 id="h:48ed9e24-3096-42e8-a9d4-454e85a8a3bc">Gratuitous ARP</h5>
<div class="outline-text-5" id="text-h:48ed9e24-3096-42e8-a9d4-454e85a8a3bc">
<p>
Gratuitous ARP也称为免费ARP，无故ARP。Gratuitous ARP不同于一般的ARP请
求，它并非期待得到ip对应的mac地址，而是当主机启动的时候，将发送一个
Gratuitous arp请求，即请求自己的ip地址的mac地址
</p>

<p>
免费ARP可以有两个方面的作用：
</p>

<ul class="org-ul">
<li>验证IP是否冲突：一个主机可以通过它来确定另一个主机是否设置了相同的
IP地址</li>
<li>更换物理网卡：如果发送ARP的主机正好改变了物理地址（如更换物理网卡），
可以使用此方法通知网络中其它主机及时更新ARP缓存</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:98c10db2-5b33-40ad-9c20-ab80e13b9fcf" class="outline-4">
<h4 id="h:98c10db2-5b33-40ad-9c20-ab80e13b9fcf">Reverse Address Resolution Protocol(RARP)</h4>
<div class="outline-text-4" id="text-h:98c10db2-5b33-40ad-9c20-ab80e13b9fcf">
<p>
RARP 即将MAC转换成IP
</p>


<figure id="orgddfe258">
<img src="images/image-20210126191540250.png" alt="image-20210126191540250.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:df21c6e8-914c-4f4f-b6e8-7a4182ea47a3" class="outline-4">
<h4 id="h:df21c6e8-914c-4f4f-b6e8-7a4182ea47a3">Internet Protocol(IP)</h4>
<div class="outline-text-4" id="text-h:df21c6e8-914c-4f4f-b6e8-7a4182ea47a3">
</div>
<div id="outline-container-h:8a22db44-fa14-48fd-9704-3ef0725b3365" class="outline-5">
<h5 id="h:8a22db44-fa14-48fd-9704-3ef0725b3365">Internet 协议特征</h5>
<div class="outline-text-5" id="text-h:8a22db44-fa14-48fd-9704-3ef0725b3365">
<ul class="org-ul">
<li>运行于 OSI 网络层</li>
<li>面向无连接的协议</li>
<li>独立处理数据包</li>
<li>分层编址</li>
<li>尽力而为传输</li>
<li>无数据恢复功能</li>
</ul>
</div>
</div>
<div id="outline-container-h:7171118a-6985-4f40-962d-50ac86c6c09c" class="outline-5">
<h5 id="h:7171118a-6985-4f40-962d-50ac86c6c09c">IP PDU 报头</h5>
<div class="outline-text-5" id="text-h:7171118a-6985-4f40-962d-50ac86c6c09c">

<figure id="orgd79f9b6">
<img src="images/image-20210126191552408.png" alt="image-20210126191552408.png" width="50%">

</figure>

<pre class="example" id="org720e46d">
0       3       7              15              23              31
+---------------------------------------------------------------+
|Version|  IHL  |Type of Service|          Total Length         |
+---------------------------------------------------------------+
|        Identification         | Flags |    Fragment Offset    |
+---------------------------------------------------------------+
| Time to Live  |   Protocol    |        Header Checksum        |
+---------------------------------------------------------------+
|                        Source Address                         |
+---------------------------------------------------------------+
|                       Destination Address                     |
+---------------------------------------------------------------+
|                   Options                     |    Options    |
+---------------------------------------------------------------+
</pre>

<p>
<b>IP PDU 报头格式</b>
</p>

<p>
固定部分20字节，可变长部分不超过40字节
</p>

<ul class="org-ul">
<li>版本:占4位,指 IP 协议的版本目前的IP协议版本号为4，6版本将为主流</li>

<li><p>
首部长度:占4位,可表示的最大数值是15个单位，一个单位为4字节，因此IP的
首部长度的最大值是60字节
</p>

<p>
区分服务:占8位,用来获得更好的服务,在旧标准中叫做服务类型,但实际上一
直未被使用过.后改名为区分服务.只有在使用区分服务(DiffServ)时,这个字
段才起作用.一般的情况下不使用
</p></li>

<li>总长度:占16位,指首部和数据之和的长度,单位为字节,因此数据报的最大长度
为65535 字节.总长度必须不超过最大传送单元 MTU</li>

<li>标识:占16位,它是一个计数器,通常，每发送一个报文，该值会加1，
也用于数据包分片，在同一个包的若干分片中，该值是相同的</li>

<li><p>
标志(flag):占3位,目前只有后两位有意义
</p>

<p>
DF： Don't Fragment中间的一位，只有当 DF=0 时才允许分片
</p>

<p>
MF： More Fragment最后一位，MF=1表示后面还有分片,MF=0 表示最后一个分
片 IP PDU 报头
</p></li>

<li>片偏移:占13位,指较长的分组在分片后，该分片在原分组中的相对位置.片偏
移以8个字节为偏移单位</li>

<li>生存时间:占8位,记为TTL (Time To Live)数据报在网络中可通过的路由器数
的最大值,TTL 字段是由发送端初始设置一个8 bit字段.推荐的初始值由分配
数字 RFC 指定,当前值为 64.发送 ICMP回显应答时经常把 TTL 设为最大值
255</li>

<li>协议:占8位,指出此数据报携带的数据使用何种协议以便目的主机的IP层将数
据部分上交给哪个处理过程, 1表示为 ICMP 协议, 2表示为 IGMP 协议, 6表
示为 TCP 协议, 17表示为 UDP协议</li>

<li>首部检验和:占16位,只检验数据报的首部不检验数据部分.这里不采用 CRC检
验码而采用简单的计算方法</li>

<li>源地址和目的地址:都各占4字节,分别记录源地址和目的地址</li>
</ul>

<p>
经过路由器数=初始值 - TTL
</p>

<div class="org-src-container">
<pre class="src src-sh">C:\Users\jasper&gt;ping www.whitehouse.gov
&#27491;&#22312; Ping e4036.dscb.akamaiedge.net [23.195.194.51] &#20855;&#26377; 32 &#23383;&#33410;&#30340;&#25968;&#25454;:
&#26469;&#33258; 23.195.194.51 &#30340;&#22238;&#22797;: <span style="color: #a0522d;">&#23383;&#33410;</span>=32 <span style="color: #a0522d;">&#26102;&#38388;</span>=211ms <span style="color: #a0522d;">TTL</span>=49

C:\Users\jasper&gt;tracert  -d www.whitehouse.gov
&#36890;&#36807;&#26368;&#22810; 30 &#20010;&#36291;&#28857;&#36319;&#36394;
&#21040; e4036.dscb.akamaiedge.net [23.195.194.51] &#30340;&#36335;&#30001;:

  1     1 ms     1 ms     1 ms  192.168.1.1
  2     3 ms     3 ms     3 ms  10.39.128.1
  3     8 ms     5 ms     5 ms  211.136.88.141
  4     6 ms     5 ms     5 ms  221.179.171.41
  5     *        6 ms     6 ms  111.24.3.13
  6     7 ms     7 ms     7 ms  111.24.2.250
  7    10 ms     8 ms     9 ms  221.176.21.190
  8    24 ms   126 ms    12 ms  221.183.52.1
  9    94 ms    21 ms    20 ms  221.183.55.113
 10   154 ms   125 ms    40 ms  223.120.22.22
 11   168 ms    60 ms     *     223.120.2.13
 12     *       54 ms     *     223.120.2.42
 13    53 ms    51 ms    51 ms  223.120.2.118
 14    45 ms    45 ms    54 ms  134.159.128.213
 15    53 ms     *        *     202.84.157.38
 16   240 ms   228 ms   230 ms  202.84.157.38
 17     *        *      222 ms  202.84.143.41
 18     *      328 ms     *     210.57.59.66
 19   212 ms   212 ms   211 ms  23.195.194.51

&#36319;&#36394;&#23436;&#25104;&#12290;
</pre>
</div>

<p>
范例：修改默认ttl
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@proxy ~]# cat /proc/sys/net/ipv4/ip_default_ttl 
64

<span style="color: #483d8b;">echo</span> 100 &gt;/proc/sys/net/ipv4/ip_default_ttl 
</pre>
</div>

<p>
范例：发现IP冲突的主机
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#arping 10.0.0.6
ARPING 10.0.0.6 from 10.0.0.8 eth0
Unicast reply from 10.0.0.6 [00:0C:29:E0:2F:37]     0.779ms
Unicast reply from 10.0.0.6 [00:0C:29:32:80:38]     0.798ms
Unicast reply from 10.0.0.6 [00:0C:29:32:80:38]     0.926ms
Unicast reply from 10.0.0.6 [00:0C:29:32:80:38]     0.864ms
^CSent 3 probes (1 broadcast(s))
Received 4 response(s)
</pre>
</div>

<p>
范例：禁用 ipv6
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#21551;&#21160;&#20102; ipv6</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">ip a</span>
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 52:54:00:17:75:51 brd ff:ff:ff:ff:ff:ff
    inet 10.0.4.12/22 brd 10.0.7.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::5054:ff:fe17:7551/64 scope link 
       valid_lft forever preferred_lft forever

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#20869;&#26680;&#37197;&#32622;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">vim /etc/sysctl.conf</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#19979;&#38754; 2 &#34892;</span>
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
<span style="color: #b22222;">#</span><span style="color: #b22222;">sysctl -p</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;ip # ip a</span>
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 52:54:00:17:75:51 brd ff:ff:ff:ff:ff:ff
    inet 10.0.4.12/22 brd 10.0.7.255 scope global eth0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#31105;&#29992; ipv6 &#21487;&#33021;&#20250;&#24433;&#21709;&#19968;&#20123;&#26381;&#21153;&#30340;&#21551;&#21160;&#65292;&#22914;ssh, postfix, mysql&#31561;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">vim /etc/ssh/sshd_config</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">AddressFamily any # &#27492;&#34892;&#25913;&#20026;&#19979;&#38754;&#34892;</span>
AddressFamily inet
<span style="color: #b22222;">#</span><span style="color: #b22222;">systemctl restart sshd</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">vim /etc/postfix/main.cf</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">inet-interfaces = localhost # &#27492;&#34892;&#25913;&#20026;&#19979;&#38754;</span>
inet-interfaces = 127.0.0.1
<span style="color: #b22222;">#</span><span style="color: #b22222;">systemctl restart postfix</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:80d722ef-d749-48fa-a950-f849a22e420a" class="outline-3">
<h3 id="h:80d722ef-d749-48fa-a950-f849a22e420a">主机到主机的包传递完整过程</h3>
<div class="outline-text-3" id="text-h:80d722ef-d749-48fa-a950-f849a22e420a">
<p>
思科官方图解
</p>

<p>
左边A：192.168.3.1 与 右边B: 192.168.3.2进行网络通信 http服务
</p>


<figure id="org659a902">
<img src="images/image-20210126191739068.png" alt="image-20210126191739068.png" width="50%">

</figure>

<p>
1.A业务层与应用层发消息要与B建立可靠连接(程序里写明使用TCP连接)。发送
数据报文给B，与B建立TCP 3次握手。完整的报文中不清楚的是B的MAC地址
</p>


<figure id="orga730fb1">
<img src="images/image-20210127050157798.png" alt="image-20210127050157798.png" width="50%">

</figure>

<p>
2.拿到B的MAC地址：网络层找到B的MAC
</p>


<figure id="org9c741c8">
<img src="images/image-20210126191824702.png" alt="image-20210126191824702.png" width="50%">

</figure>

<p>
3.拿到B的MAC地址：网络层ARP缓存找B的MAC，没有则ARP广播
</p>

<p>
4.拿到B的MAC地址：网络层ARP广播，我是A192.168.3.1谁是B 192.168.3.2
</p>


<figure id="orgaed0553">
<img src="images/image-20210126191852977.png" alt="image-20210126191852977.png" width="50%">

</figure>

<p>
5.拿到B的MAC地址：网络层ARP广播，所有的计算机都会收到
</p>

<p>
6.拿到B的MAC地址：网络层ARP广播，B收到广播，学习到A的地址和对应MAC，写
到自己的ARP缓存中
</p>


<figure id="org374653f">
<img src="images/image-20210126191927798.png" alt="image-20210126191927798.png" width="50%">

</figure>

<p>
7.拿到B的MAC地址：B收到广播，回应
</p>

<p>
8.拿到B的MAC地址：B收到广播，回应，发送自己的ARP响应报文
</p>


<figure id="org63563ae">
<img src="images/image-20210126191954448.png" alt="image-20210126191954448.png" width="50%">

</figure>

<p>
9.拿到B的MAC地址：B收到广播，回应，发送自己的ARP响应报文，自己的MAC地址和IP地址
</p>

<p>
10.拿到B的MAC地址：A收到B的ARP回应报文
</p>


<figure id="orgccf857f">
<img src="images/image-20210126192011061.png" alt="image-20210126192011061.png" width="50%">

</figure>

<p>
11.拿到B的MAC地址：A收到B的ARP回应报文，从中拿到B的MAC地址，整个数据报文信息就能补全了。
</p>


<figure id="orgc5f802a">
<img src="images/image-20210126192026112.png" alt="image-20210126192026112.png" width="50%">

</figure>

<p>
12.A与B三次握手：第一次，A SYN
</p>

<p>
13.A与B三次握手：第二次，B 回应 SYN ACK
</p>

<p>
14.A与B三次握手：第三次，A收到B报文，解报文得到B的SYN ACK
</p>


<figure id="orgf3c6438">
<img src="images/image-20210126192100230.png" alt="image-20210126192100230.png" width="50%">

</figure>

<p>
15.A与B三次握手：第三次，A返回给B，A 自己的 ACK
</p>

<p>
16.A与B数据通信：开始数据通信
</p>

<p>
17.A与B数据通信：A封闭数据报文发送给B
</p>

<p width="50%">
<img src="images/image-20210126192118171.png" alt="image-20210126192118171.png" width="50%">
17.A与B数据通信：B拆数据报文得到数据data
</p>

<p>
18.A与B数据通信：B回应报文给A
</p>

<p>
ARP之前，需要判断路由，判断IP是否在自己网段。
</p>

<p>
2个主机程序进行通信
</p>

<div class="org-src-container">
<pre class="src src-sh">1. &#30693;&#36947;&#23545;&#26041;IP&#65292;&#21487;&#33021;&#26159;&#30452;&#25509;&#25110;&#38388;&#25509;&#26041;&#24335;
2. &#26159;&#21542;&#22312;&#21516;&#19968;&#20010;&#32593;&#27573;&#65311;&#36335;&#30001;&#65311;
&#22312;&#21516;&#19968;&#32593;&#27573;&#30452;&#25509;ARP&#25214;&#21040;&#23545;&#26041;MAC&#65292;&#19981;&#22312;&#21516;&#19968;&#32593;&#27573;&#23558;&#21033;&#29992;&#36335;&#30001;&#22120;&#25214;&#21040;&#23545;&#26041;MAC
3. ARP IP --MAC
4. &#19977;&#27425;&#25569;&#25163;(TCP)
5. &#36890;&#20449;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:293d4255-a601-4598-960a-d5a675723946" class="outline-3">
<h3 id="h:293d4255-a601-4598-960a-d5a675723946">IP地址</h3>
<div class="outline-text-3" id="text-h:293d4255-a601-4598-960a-d5a675723946">
</div>
<div id="outline-container-h:f1027f8f-7f83-4501-9612-6d3a5b53d64e" class="outline-4">
<h4 id="h:f1027f8f-7f83-4501-9612-6d3a5b53d64e">IP地址组成</h4>
<div class="outline-text-4" id="text-h:f1027f8f-7f83-4501-9612-6d3a5b53d64e">
<p>
它们可唯一标识 IP 网络中的每台设备，每台主机（计算机、网络设备、外围设备）必须具有唯一的地址
</p>

<p>
mac属于物理地址，mac地址不可改变，一出厂就写死，标识唯一设备。-----&#x2013;&#x2014;身份证号
</p>

<p>
ip属于逻辑地址，逻辑地址可修改，人为赋予，可以修改，使用灵活，便于管理。----&#x2013;&#x2014;姓名
</p>

<p>
ipv4  32位二进制，以二进制显示
</p>

<p>
ipv6 128位二进制，以十六进制显示
</p>



<p>
在线进制转换: <a href="https://www.sojson.com/hexconvert.html">https://www.sojson.com/hexconvert.html</a>
</p>

<p>
范例：网卡ip地址转换进制，一样能ping通
</p>
<div class="org-src-container">
<pre class="src src-sh">ping 10.0.0.7
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'ibase=2; 1010000000000000000000000111'</span>  |bc  <span style="color: #b22222;"># </span><span style="color: #b22222;">167772167</span>
ping ping &#21487;&#20197;&#36890;
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh">32&#20301;&#20108;&#36827;&#21046;&#65292;&#20197;.&#20998;&#38548;&#65292;&#25152;&#20197;&#27599;&#22788;&#37117;&#26159;8&#36827;&#21046;
<span style="color: #a0522d;">10</span>=8+2           00001010
<span style="color: #a0522d;">0</span>=               00000000
<span style="color: #a0522d;">0</span>=               00000000
<span style="color: #a0522d;">158</span>=128+16+8+4+2 10011110

00001010.00000000.00000000.10011110


<span style="color: #b22222;">#</span><span style="color: #b22222;">10&#36827;&#21046;&#36716;2&#36827;&#21046;</span>
[root@proxy ~]# echo <span style="color: #8b2252;">'obase=2;10'</span>|bc
1010
[root@proxy ~]# echo <span style="color: #8b2252;">'obase=2;10;0;0;158'</span>|bc
1010
0
0
10011110


[root@proxy ~]# echo <span style="color: #8b2252;">'obase=10;ibase=2;00001010000000000000000010011110'</span>|bc  <span style="color: #b22222;">#</span><span style="color: #b22222;">2&#36827;&#21046;&#36716;10&#36827;&#21046;</span>
167772318
[root@proxy ~]# echo <span style="color: #8b2252;">'obase=8;ibase=2;00001010000000000000000010011110'</span>|bc  <span style="color: #b22222;">#</span><span style="color: #b22222;">2&#36827;&#21046;&#36716;8&#36827;&#21046;</span>
1200000236
[root@proxy ~]# echo <span style="color: #8b2252;">'obase=16;ibase=2;00001010000000000000000010011110'</span>|bc  <span style="color: #b22222;">#</span><span style="color: #b22222;">2&#36827;&#21046;&#36716;16&#36827;&#21046;</span>
A00009E

&#31995;&#32479;&#20013;&#34920;&#31034;16&#36827;&#21046;&#21069;&#38754;&#35201;&#21152;0x&#65292;8&#36827;&#21046;&#21069;&#21152;0
ping 167772318 <span style="color: #b22222;">#</span><span style="color: #b22222;">10&#36827;&#21046;</span>
ping 01200000236 <span style="color: #b22222;">#</span><span style="color: #b22222;">8&#36827;&#21046;</span>
ping 0xA00009E <span style="color: #b22222;">#</span><span style="color: #b22222;">16&#36827;&#21046;</span>
</pre>
</div>

<p>
范例：遍历检测当前网段内的主机
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">10.0.01--10.0.0.254</span>
[root@proxy ~]# echo <span style="color: #8b2252;">'obase=2;10;0;0;254'</span> |bc
1010
0
0
11111110
[root@proxy ~]# echo <span style="color: #8b2252;">'obase=10;ibase=2;00001010000000000000000000000001'</span>|bc  <span style="color: #b22222;">#</span><span style="color: #b22222;">10.0.0.1, 2&#36827;&#21046;&#36716;10&#36827;&#21046;</span>
167772161
[root@proxy ~]# echo <span style="color: #8b2252;">'obase=10;ibase=2;00001010000000000000000011111110'</span>|bc  <span style="color: #b22222;">#</span><span style="color: #b22222;">10.0.0.254, 2&#36827;&#21046;&#36716;10&#36827;&#21046;</span>
167772414

<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> {167772161..167772414} ; <span style="color: #a020f0;">do</span> ping -c1 -W1 $<span style="color: #a0522d;">i</span> &amp;&amp; <span style="color: #483d8b;">echo</span> the $<span style="color: #a0522d;">i</span> is up || <span style="color: #483d8b;">echo</span> the $<span style="color: #a0522d;">i</span> is down; <span style="color: #a020f0;">done</span>;

<span style="color: #a0522d;">net</span>=10.0.0; <span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> {1..254}; <span style="color: #a020f0;">do</span> ping -c1 -W1 $<span style="color: #a0522d;">net</span>.$<span style="color: #a0522d;">1</span> &amp;&gt;/dev/null &amp;&amp; <span style="color: #483d8b;">echo</span> the $<span style="color: #a0522d;">net</span>.$<span style="color: #a0522d;">i</span> is up || <span style="color: #483d8b;">echo</span> the $<span style="color: #a0522d;">net</span>.$<span style="color: #a0522d;">i</span> is down; <span style="color: #a020f0;">done</span>;
</pre>
</div>

<p>
IP地址由两部分组成
</p>

<ul class="org-ul">
<li><b>网络ID</b> ：标识网络，每个网段分配一个网络ID，处于 <b>高位</b></li>
<li><b>主机 ID</b> ：标识单个主机，由组织分配给各设备，处于 <b>低位</b></li>
</ul>

<p>
IPv4地址格式：点分十进制记法
</p>


<figure id="orge66acab">
<img src="images/image-20210126192214019.png" alt="image-20210126192214019.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:49f34f99-5eb1-4bee-8ece-97db0331fcd0" class="outline-4">
<h4 id="h:49f34f99-5eb1-4bee-8ece-97db0331fcd0">IP地址分类</h4>
<div class="outline-text-4" id="text-h:49f34f99-5eb1-4bee-8ece-97db0331fcd0">
<dl class="org-dl">
<dt>A类</dt><dd><p>
0 0000000 - 0 1111111.X.Y.Z : 0-127.X.Y.Z
</p>

<p>
网络 ID位是最高8位，最高位为 0，可变的只有 7 位，主机 ID 是 24 位低位
</p>

<p>
网络数：126=2^7-2 即 2^ 可变是的网络ID位数 -(0 和 127 不能要)
</p>

<p>
每个网络中的主机数：2^24-2=16777214 即 2^主机 id 的位数 - (全为 0的
网络地址和 全为 1 的广播地址)
</p>

<p>
默认子网掩码：255.0.0.0
</p>

<p>
私网地址：10.0.0.0
</p>

<p>
范例:114.114.114.114,8.8.8.8,1.1.1.1，58.87.87.99，119.29.29.29
</p></dd>

<dt>B类</dt><dd><p>
10 000000 - 10 111111.X.Y.Z：128-191.X.Y.Z
</p>

<p>
网络ID位是最高16位,主机ID是16位低位
</p>

<p>
网络数：2^14=16384
</p>

<p>
每个网络中的主机数：2^16-2=65534
</p>

<p>
默认子网掩码：255.255.0.0
</p>

<p>
私网地址：172.16.0.0-172.31.0.0
</p>

<p>
范例:180.76.76.76，172.16.0.1
</p></dd>

<dt>C类</dt><dd><p>
110 0 0000 - 110 1 1111.X.Y.Z: 192-223.X.Y.Z
</p>

<p>
网络ID位是最高24位,主机ID是8位低位
</p>

<p>
网络数：2^21=2097152
</p>

<p>
每个网络中的主机数：2^8-2=254
</p>

<p>
默认子网掩码：255.255.255.0
</p>

<p>
私网地址：192.168.0.0-192.168.255.0
</p>

<p>
范例: 223.6.6.6
</p></dd>

<dt>D类</dt><dd>组（多）播，1110 0000 - 1110 1111.X.Y.Z: 224-239.X.Y.Z</dd>

<dt>E类</dt><dd>保留未使用，240-255</dd>
</dl>

<div class="org-src-container">
<pre class="src src-sh">&#20844;&#24335;&#65306;
&#32593;&#27573;&#25968;&#65306;2^&#21487;&#21464;&#32593;&#32476;ID&#30340;&#20301;&#25968;
&#20027;&#26426;&#25968;&#65306;2^&#20027;&#26426;ID&#30340;&#20301;&#25968;-2=2^(32-&#32593;&#32476;ID&#30340;&#20301;&#25968;)
1-126 A 128-191 B 192-223 C
</pre>
</div>

<p>
上面分类的方式太僵化，之后出现了无类分配方式
</p>

<p>
无类分配方式：IP地址主机ID的位数、网络ID的位数可以根据生产需要分配
</p>
</div>
</div>
<div id="outline-container-h:2246d8c1-4c95-4d6b-8d7c-22bfff60834d" class="outline-4">
<h4 id="h:2246d8c1-4c95-4d6b-8d7c-22bfff60834d">公共和私有IP地址</h4>
<div class="outline-text-4" id="text-h:2246d8c1-4c95-4d6b-8d7c-22bfff60834d">
<p>
私有IP地址：不直接用于互联网，通常在局域网中使用
</p>

<ul class="org-ul">
<li>A 类私有 IP 地址：10.0.0.0 &#x2014; 10.255.255.255</li>

<li>B 类私有 IP 地址：172.16.0.0 &#x2014;172.31.255.255</li>

<li>C 类私有 IP 地址：192.168.0.0 &#x2014; 192.168.255.255</li>
</ul>


<p>
公共IP地址：互联网上设备拥有的唯一地址
</p>

<ul class="org-ul">
<li>A 类公共 IP 地址：1.0.0.0 &#x2014; 9.255.255.255 、11.0.0.0 &#x2014; 126.255.255.255</li>

<li>B 类公共 IP 地址：128.0.0.0 &#x2014; 172.15.255.255、172.32.0.0 &#x2014; 191.255.255.255</li>

<li>C 类公共 IP 地址：192.0.0.0 &#x2014; 192.167.255.255、192.169.0.0 &#x2014; 223.255.255.255</li>
</ul>
</div>
</div>
<div id="outline-container-h:d918cf56-8db4-4dbc-aacd-ab7ed0f9c843" class="outline-4">
<h4 id="h:d918cf56-8db4-4dbc-aacd-ab7ed0f9c843">特殊地址</h4>
<div class="outline-text-4" id="text-h:d918cf56-8db4-4dbc-aacd-ab7ed0f9c843">
<ul class="org-ul">
<li>0.0.0.0  不是一个真正意义上的IP地址。它表示所有不清楚的主机和目的网络</li>

<li>255.255.255.255  限制广播地址。对本机来说，这个地址指本网段内(同一广播域)的所有主机</li>

<li>127.0.0.1～127.255.255.254  本机回环地址，主要用于测试。在传输介质上永远不应该出现目的地址为”127.0.0.1”的数据包</li>

<li>224.0.0.0到239.255.255.255  组播地址，224.0.0.1特指所有主机，224.0.0.2特指所有路由器。224.0.0.5指OSPF路由器，地址多用于一些特定的程序以及多媒体程序</li>

<li>169.254.x.x  如果Windows主机使用了DHCP自动分配IP地址，而又无法从DHCP服务器获取地址，系统会为主机分配这样地址</li>
</ul>
</div>
</div>
<div id="outline-container-h:c6afac7d-aed1-4bdd-9aec-140e81e7d2f8" class="outline-4">
<h4 id="h:c6afac7d-aed1-4bdd-9aec-140e81e7d2f8">保留地址</h4>
<div class="outline-text-4" id="text-h:c6afac7d-aed1-4bdd-9aec-140e81e7d2f8">
<p>
在一个IP地址中，如果主机ID全为0，或主机ID全为1，则该地址是保留地址。
</p>

<p>
范例: 172.16.0.0 网络中的两个地址:172.16.0.0 172.16.255.255
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;&#22320;&#22336;</span>
&lt;------------32&#20301;---------&gt;
&#32593;&#32476;0000000000000000

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24191;&#25773;&#22320;&#22336;</span>
&lt;------------32&#20301;---------&gt;
&#32593;&#32476;1111111111111111
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0cf2f901-22cf-43b5-9a13-381b4351dc8d" class="outline-4">
<h4 id="h:0cf2f901-22cf-43b5-9a13-381b4351dc8d">子网掩码netmask</h4>
<div class="outline-text-4" id="text-h:0cf2f901-22cf-43b5-9a13-381b4351dc8d">
<p>
<b>CIDR</b> ：无类域间路由，目前的网络已不再按A，B，C类划分网段，可以任意指定网段的范围
</p>

<p>
<b>CIDR 无类域间路由表示法：IP/网络ID位数</b> ，如：172.16.0.100/16
</p>

<p>
<b>netmask子网掩码：32位或128位（IPv6）的数字，和IP成对使用， 用来确认IP地址中的网络ID和主机ID，对应网络ID的位为1，对应主机ID的位为0</b>
</p>

<p>
范例:255.255.255.0，表现为连续的高位为1，连续的低位为0
</p>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">ip&#22320;&#22336;&#65306; 172.16.0.0
&#23376;&#32593;&#25513;&#30721;&#65306;11111111.11111111.000000000.00000000
&#23376;&#32593;&#25513;&#30721;10&#36827;&#21046;&#34920;&#31034;&#65306;255.255.0.0
</pre>
</div>

<p>
子网掩码的八位
</p>

<div class="org-src-container">
<pre class="src src-sh">128 64 32 16 8  4  2  1
---------------
0   0  0  0  0  0  0  0
1   0  0  0  0  0  0  0 = 128
1   1  0  0  0  0  0  0 = 192
1   1  1  0  0  0  0  0 = 224
1   1  1  1  0  0  0  0 = 240
1   1  1  1  1  0  0  0 = 248
1   1  1  1  1  1  0  0 = 252
1   1  1  1  1  1  1  0 = 254
1   1  1  1  1  1  1  1 = 255
</pre>
</div>


<p>
<b>相关公式：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">1. &#19968;&#20010;&#32593;&#32476;&#30340;&#26368;&#22810;&#20027;&#26426;&#25968;&#65309; 2^&#20027;&#26426;ID&#20301;&#25968;-2 =2^(32-&#32593;&#32476;ID&#30340;&#20301;&#25968;)-2
2. &#32593;&#32476;(&#27573;)<span style="color: #a0522d;">&#25968;</span>=2^&#32593;&#32476;ID&#20013;&#21487;&#21464;&#30340;&#20301;&#25968;
3. <span style="color: #a0522d;">&#32593;&#32476;ID</span>=IP&#19982;netmask <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#29992;&#26469;&#21028;&#26029;&#24403;&#21069;&#20027;&#26426;&#22312;&#21738;&#20010;&#32593;&#27573;&#65292;&#21644;0&#30456;&#19982;&#20026;0&#65292;&#21644;1&#30456;&#19982;&#20026;&#21407;&#20540;</span>
</pre>
</div>

<p>
如：子网掩码为 255.240.0.0
</p>

<ul class="org-ul">
<li>网络 ID: 找全为 1 的，255 是 8 位， 240 是 4 位， 共 12 bit</li>
<li>主机 ID：32 - 12（网络 ID） = 20 bit</li>
<li>主机数：2^主机 ID 的位数 - 2 = 2^(32-网络ID的位数) - 2 2^20</li>
</ul>

<p>
范例: netmask: 255.255.224.0,网络ID位:19 主机ID位:13,主机数=2^13-2=8190
</p>

<p>
<b>CIDR 无类域间路由表示法</b> ：IP/网络ID位数，IP/12
</p>


<div class="org-src-container">
<pre class="src src-sh">&#20108;&#36827;&#21046;&#21644;&#21313;&#36827;&#21046;&#36716;&#25442;
2^<span style="color: #a0522d;">0</span>=<span style="color: #a0522d;">1</span>=1
2^<span style="color: #a0522d;">1</span>=<span style="color: #a0522d;">2</span>=10
2^<span style="color: #a0522d;">3</span>=<span style="color: #a0522d;">8</span>=1000
2^<span style="color: #a0522d;">4</span>=<span style="color: #a0522d;">16</span>=10000
2^<span style="color: #a0522d;">5</span>=32
2^<span style="color: #a0522d;">6</span>=64
2^<span style="color: #a0522d;">7</span>=<span style="color: #a0522d;">128</span>=10000000
2^<span style="color: #a0522d;">8</span>=<span style="color: #a0522d;">256</span>=100000000
2^<span style="color: #a0522d;">9</span>=512
2^<span style="color: #a0522d;">10</span>=1024
2^<span style="color: #a0522d;">11</span>=2048
2^<span style="color: #a0522d;">12</span>=4096
</pre>
</div>


<p>
范例：一个主机：203.101.123.163/28
</p>

<div class="org-src-container">
<pre class="src src-sh">1. netmask: 255.255.255.11110000  &#21363; 255.255.255.240
2. &#20027;&#26426;&#25968;&#65306;2^(32-&#32593;&#32476;ID&#30340;&#20301;&#25968;) &#21363; 2^(32 - 28) - <span style="color: #a0522d;">2</span>=2^4-2=14
3. IP &#33539;&#22260;&#65306;
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'obase=2;163'</span> |bc <span style="color: #b22222;"># </span><span style="color: #b22222;">163&#30340;&#20108;&#36827;&#21046; 10100011</span>

203.101.123.10100011 <span style="color: #b22222;">#</span><span style="color: #b22222;">IP  163 = 128 + 32 + 2 + 1 = 1010 0011 &#26681;&#25454; netmask &#21069; 28 &#20301;&#20026;&#32593;&#32476; ID</span>
11111111.11111111.11111111.11110000 <span style="color: #b22222;">#</span><span style="color: #b22222;">netmask&#23376;&#32593;&#25513;&#30721; 28</span>
203.101.123.1010 0000 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;ID, &#21069;28&#20301;&#65292;128+32  &#21363; 203.101.123.160</span>
&#20027;&#26426;ID 0000

<span style="color: #b22222;">#</span><span style="color: #b22222;">8&#20301;</span>
128 64 32 16 8  4  2  1
---------------
0   0  0  0  0  0  0  0
<span style="color: #b22222;">#</span>

&#26368;&#23567; ip 203.101.123.1010 0001 &#21363; 203.101.123.161
&#26368;&#22823; ip 203.101.123.1010 1110 &#21363; 203.101.123.(160+(2^3+2^+2^1)) 203.101.123.174  
</pre>
</div>


<p>
不同ip类型对应的netmask
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<tbody>
<tr>
<td class="org-left">IP类型</td>
<td class="org-right">netmak</td>
<td class="org-right">netmask</td>
</tr>

<tr>
<td class="org-left">A</td>
<td class="org-right">255.0.0.0</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-left">B</td>
<td class="org-right">255.255.0.0</td>
<td class="org-right">16</td>
</tr>

<tr>
<td class="org-left">C</td>
<td class="org-right">255.255.255.0</td>
<td class="org-right">25</td>
</tr>
</tbody>
</table>

<p>
两种写法转换
</p>
<div class="org-src-container">
<pre class="src src-sh">10.0.0.100/23      <span style="color: #a0522d;">23</span>=8+8+7+<span style="color: #a0522d;">0</span>=255.255.254.0
172.16.2.50/18  <span style="color: #a0522d;">18</span>=8+8+2+<span style="color: #a0522d;">0</span>=255.255.192.0
</pre>
</div>


<p>
<b>判断对方主机是否在同一个网段：</b>
</p>

<p>
用自已的子网掩码分别和自已的IP及对方的IP相与，比较结果，相同则同一网络，不同则不同网段
</p>


<p>
范例：判断A和B是否在网一个网段?
</p>
<div class="org-src-container">
<pre class="src src-sh">A: 192.168.1.100 netmask:255.255.255.0
B: 192.168.2.100 netmask:255.255.0.0

&#20551;&#35774;A&#35201;&#21644;B&#36890;&#20449;&#65292;A&#30693;&#36947;&#33258;&#24049;&#30340;IP&#21644;&#23376;&#32593;&#25513;&#30721;&#65292;&#30693;&#36947;B&#30340;IP&#65292;&#19981;&#28165;&#26970;B&#30340;&#23376;&#32593;&#25513;&#30721;
A: 192.168.1.100 A&#30340;netmask:255.255.255.0 &#32593;&#32476;ID&#65306;192.168.1.0
B: 192.168.2.100 A&#30340;netmask:255.255.255.0   &#32593;&#32476;ID&#65306;192.168.2.0

A--&gt;B
1. A&#32593;&#32476;ID
11000000.10101000.00000001.01100000  <span style="color: #b22222;">#</span><span style="color: #b22222;">A&#30340;IP 192.168.1.100</span>
11111111.11111111.11111111.00000000  <span style="color: #b22222;">#</span><span style="color: #b22222;">A&#30340;netmask 24&#30456;&#19982;</span>
11000000.10101000.00000001.00000000  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;iD 192.168.1.0</span>

2. B&#32593;&#32476;ID
192.168.2 ^ 24
11000000.10101000.00000010.01100000  <span style="color: #b22222;">#</span><span style="color: #b22222;">B&#30340;IP 192.168.2.100</span>
11111111.11111111.11111111.00000000  <span style="color: #b22222;">#</span><span style="color: #b22222;">A&#30340;netmask 24&#30456;&#19982;</span>
11000000.10101000.00000010..00000000 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;ID192.168.2.0</span>

3. AB&#32593;&#32476;&#27604;&#36739;&#65292;A&#29992;&#33258;&#24049;&#30340;&#23376;&#32593;&#25513;&#30721;&#35745;&#31639;&#65292;&#19981;&#21516;&#21017;&#19981;&#21516;&#32593;&#27573;&#12290;A&#22312;&#32593;&#32476;&#36890;&#35759;&#26102;&#35748;&#20026;B&#19981;&#21487;&#21040;&#36798;&#65292;&#21018;&#25918;&#24323;ARP&#65292;&#30452;&#25509;&#36208;&#32593;&#20851;

B--&gt;A
&#20551;&#35774;B&#35775;&#38382;A&#65292;&#35745;&#31639;&#21518;B&#35748;&#20026;A&#21644;&#33258;&#24049;&#26159;&#21516;&#19968;&#32593;&#27573;&#12290;B&#20250;&#21457;&#36865;ARP&#35831;&#27714;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0c118935-c2a0-4bbd-a8c5-2f3dfd6325c2" class="outline-4">
<h4 id="h:0c118935-c2a0-4bbd-a8c5-2f3dfd6325c2">划分子网</h4>
<div class="outline-text-4" id="text-h:0c118935-c2a0-4bbd-a8c5-2f3dfd6325c2">
<p>
划分子网：将一个大的网络（主机数多，主机 ID位多）划分成多个小的网络
（主机数少，主机 ID 位少），网络ID位数变多，网络ID 位向主机 ID 位借 N
位，将划分成 2^N 个子网。
</p>


<figure id="orgba28c88">
<img src="images/image-20210126192343625.png" alt="image-20210126192343625.png" width="50%">

</figure>

<p>
可变长度子网掩码
</p>


<figure id="orgc5ff8fb">
<img src="images/image-20210126192357555.png" alt="image-20210126192357555.png" width="50%">

</figure>

<p>
Subnet地址
</p>


<figure id="org969577e">
<img src="images/image-20210126192412022.png" alt="image-20210126192412022.png" width="50%">

</figure>


<pre class="example" id="org88cd17a">
划分子网数=2^(网络ID向主机ID借的位数)
</pre>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-sh">10.0.0.0/8
&#20027;&#26426;&#20301; 2^24-2=16777214
10.0.0.1 -- 10.255.255.254

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;ID&#21521;&#20027;&#26426;ID&#20511;1&#20301;&#65292;&#33021;&#21010;&#20998;&#25104;2&#20010;&#23376;&#32593;</span>
10.0 0000000.00000000.00000000 10.0.0.0/9
10.1 0000000.00000000.00000000 10.128.0.0/9

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;ID&#21521;&#20027;&#26426;ID&#20511;2&#20301;&#65292;&#33021;&#21010;&#20998;&#25104;4&#20010;&#23376;&#32593;</span>
10.00 000000.00000000.00000000          10.0.0.0/10
10.01 000000.00000000.00000000          10.64.0.0/10
10.10 000000.00000000.00000000          10.128.0.0/10
10.11 000000.00000000.00000000          10.192.0.0/10

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21010;&#20998;&#25104;32&#20010;&#23376;&#32593;&#65292; 2^5=32, &#25152;&#20197;&#20511;5&#20301;</span>
10.00000 000.00000000.00000000          10.0.0.0/13
... ...
10.11111 000.00000000.00000000          10.248.0.0/13
</pre>
</div>

<p>
范例：中国移动10.0.0.0/8， 给32个各省公司划分对应的子网
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27010;&#24565;</span>
&#32593;&#32476;ID &#65306;&#26631;&#35782;&#32593;&#32476;&#65292;&#27599;&#20010;&#32593;&#27573;&#20998;&#37197;&#19968;&#20010;&#32593;&#32476;ID&#65292;&#22788;&#20110;&#39640;&#20301;
&#20027;&#26426; ID &#65306;&#26631;&#35782;&#21333;&#20010;&#20027;&#26426;&#65292;&#30001;&#32452;&#32455;&#20998;&#37197;&#32473;&#21508;&#35774;&#22791;&#65292;&#22788;&#20110;&#20302;&#20301;
netmask&#23376;&#32593;&#25513;&#30721;&#65306;32&#20301;&#25110;128&#20301;&#65288;IPv6&#65289;&#30340;&#25968;&#23383;&#65292;&#21644;IP&#25104;&#23545;&#20351;&#29992;&#65292; &#29992;&#26469;&#30830;&#35748;IP&#22320;&#22336;&#20013;&#30340;&#32593;&#32476;ID&#21644;&#20027;&#26426;ID&#65292;&#23545;&#24212;&#32593;&#32476;ID&#30340;&#20301;&#20026;1&#65292;&#23545;&#24212;&#20027;&#26426;ID&#30340;&#20301;&#20026;0
CIDR &#26080;&#31867;&#22495;&#38388;&#36335;&#30001;&#34920;&#31034;&#27861;&#65306;IP/&#32593;&#32476;ID&#20301;&#25968;&#65292;&#22914;&#65306;172.16.0.100/16

&#20844;&#24335;&#65306;
&#19968;&#20010;&#32593;&#32476;&#30340;&#26368;&#22810;&#30340;&#20027;&#26426;&#25968;&#65306;2^&#20027;&#26426;ID&#20301;&#25968;-2=2^(32-&#32593;&#32476;ID&#30340;&#20301;&#25968;)
&#32593;&#32476;&#65288;&#27573;&#65289;&#25968;&#65306;2^&#32593;&#32476;ID&#20013;&#21487;&#21464;&#30340;&#20301;&#25968;
&#32593;&#32476;ID&#65306;IP&#19982;netmask <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#29992;&#26469;&#21028;&#26029;&#24403;&#21069;&#20027;&#26426;&#22312;&#21738;&#20010;&#32593;&#27573;&#65292;&#21644;0&#30456;&#19982;&#20026;0&#65292;&#21644;1&#30456;&#19982;&#20026;&#21407;&#20540;</span>
&#21010;&#20998;&#23376;&#32593;&#65306;&#23558;&#22823;&#32593;&#20998;&#25104;&#33509;&#24178;&#20010;&#23567;&#32593;&#65292;&#32593;&#32476;ID&#21521;&#20027;&#26426;ID&#20511;N&#20301;&#65292;&#23558;&#21010;&#20998;&#20026;2^N&#27425;&#26041;&#20010;&#23376;&#32593;

1) &#27599;&#20010;&#30465;&#20844;&#21496;&#30340;&#23376;&#32593;&#30340;netmask&#65311;
&#21010;&#20998;32&#20010;&#23376;&#32593;&#65292;&#21017;&#32593;&#32476;ID&#35201;&#21521;&#20027;&#26426;ID&#20511;5&#20301;&#12290; 2^5&gt;=32
&#21017;&#32593;&#32476;&#20301;&#26159; 8+<span style="color: #a0522d;">5</span>=13
netmask&#26159; 11111111.11111000.00000000.00000000 = 255.11111000.0.0 =255.248.0.0

2) &#27599;&#20010;&#30465;&#20844;&#21496;&#30340;&#23376;&#32593;&#30340;&#20027;&#26426;&#25968;&#26377;&#22810;&#23569;&#65311;
2^(32-13)-2=524286

3) &#25152;&#26377;&#23376;&#32593;&#20013;&#26368;&#23567;&#21644;&#26368;&#22823;&#30340;&#23376;&#32593;&#30340;&#32593;&#32476;ID&#65311;
10.00000 000.0.0  &#26368;&#23567;&#23376;&#32593;&#30340;&#32593;&#32476;ID&#65292;10.0.0.0/13
10.11111 000.0.0  &#26368;&#22823;&#23376;&#32593;&#30340;&#32593;&#32476;ID&#65292;10.248.0.0/13

 &#24471;&#21040;&#31532;10&#20010;&#23376;&#32593;&#65292;&#32593;&#32476;ID&#65311;
10.00000 000.0.0/13
10.01001 000.0.0/13  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;10&#20010;&#23376;&#32593; &#32593;&#32476;ID+9, 9=8+1</span>
10.72.0.0/13

4) &#27827;&#21335;&#30465;&#24471;&#21040;&#31532;10&#20010;&#23376;&#32593;&#30340;&#26368;&#23567;IP&#21644;&#26368;&#22823;&#30340;IP&#65311;
10.01001 000.0.1
10.01001 111.11111111.11111110
10.72.0.1---10.79.255.254

5&#65289;&#25152;&#26377;&#23376;&#32593;&#20013;&#26368;&#22823;&#65292;&#26368;&#23567;&#30340;&#23376;&#32593;&#30340;netid&#65311;
10.00000 000.0.0/13 10.0.0.0/13
10.11111 000.0.0/13 10.248.0.0/13
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">&#20013;&#22269;&#31227;&#21160;10.0.0.0/8 &#32473;32&#20010;&#21508;&#30465;&#20844;&#21496;&#21010;&#20998;&#23545;&#24212;&#30340;&#23376;&#32593;,&#27827;&#21335;&#30465;&#24471;&#21040;&#31532;10&#20010;&#23376;&#32593;,&#20877;&#32473;&#30465;&#20869;&#30340;16&#20010;&#22320;&#24066;&#21010;&#20998;&#23376;&#32593;
1&#65289;&#27599;&#20010;&#24066;&#20844;&#21496;&#30340;&#23376;&#32593;&#30340;netmask&#65311;
2&#65289;&#27599;&#20010;&#24066;&#20844;&#21496;&#30340;&#23376;&#32593;&#30340;&#20027;&#26426;&#25968;&#26377;&#22810;&#23569;&#65311;
3&#65289;&#21508;&#22320;&#24066;&#30340;&#26368;&#23567;netid&#21644;&#26368;&#22823;&#30340;netid&#65311;
4&#65289;&#27931;&#38451;&#24066;&#31532;2&#20010;&#23376;&#32593;&#65292;&#26368;&#23567;IP&#21644;&#26368;&#22823;IP&#65311;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b5532e1d-7e98-475c-a713-4f70d56bcdce" class="outline-4">
<h4 id="h:b5532e1d-7e98-475c-a713-4f70d56bcdce">优化IP地址分配</h4>
<div class="outline-text-4" id="text-h:b5532e1d-7e98-475c-a713-4f70d56bcdce">

<figure id="org86964f5">
<img src="images/image-20210126192424033.png" alt="image-20210126192424033.png" width="50%">

</figure>

<p>
合并超网：将多个小网络合并成一个大网，主机ID位向网络ID位借位，主要实现路由聚合功能
</p>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">8&#20010;C&#31867;&#32593;&#27573;</span>
220.78.168.0/24
220.78.169.0/24
220.78.170.0/24
220.78.171.0/24
220.78.172.0/24
220.78.173.0/24
220.78.174.0/24
220.78.175.0/24

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#26426;ID&#21521;&#32593;&#32476;ID&#20511;3&#20301;&#65292;&#32593;&#32476;ID&#21464;&#25104;21&#20301;&#65292; 168=128+32+8</span>
220.78.10101 000.0     220.78.168.0/24
220.78.10101 001.0     220.78.169.0/24
220.78.10101 010.0     220.78.170.0/24
......
220.78.10101 110.0     220.78.174.0/24
220.78.10101 111.0     220.78.175.0/24

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21512;&#24182;&#25104;&#19968;&#20010;&#22823;&#32593;</span>
220.78.168.0/21
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bdcd5fd5-017a-452e-900b-0a2010398094" class="outline-4">
<h4 id="h:bdcd5fd5-017a-452e-900b-0a2010398094">跨网络通信</h4>
<div class="outline-text-4" id="text-h:bdcd5fd5-017a-452e-900b-0a2010398094">
<p>
跨网络通信：路由,选择路径
</p>

<p>
路由分类：
</p>

<ul class="org-ul">
<li>主机路由 精确固定</li>
<li>网络路由 到达网段路径</li>
<li>默认路由</li>
</ul>

<p>
优先级：精度越高，优先级越高
</p>
</div>
</div>
<div id="outline-container-h:6c28f92d-50bf-4681-af1f-25b3b87deea4" class="outline-4">
<h4 id="h:6c28f92d-50bf-4681-af1f-25b3b87deea4">动态主机配置协议 DHCP</h4>
<div class="outline-text-4" id="text-h:6c28f92d-50bf-4681-af1f-25b3b87deea4">

<figure id="orgc48ef0d">
<img src="images/image-20210126192437286.png" alt="image-20210126192437286.png" width="50%">

</figure>

<p>
自动获取IP地址
</p>

<p>
server udp 67,  client udp 68
</p>
</div>
</div>
</div>
</section>
<section id="outline-container-h:505b57b4-2c04-4ef1-8293-0313b2e42598" class="outline-2">
<h2 id="h:505b57b4-2c04-4ef1-8293-0313b2e42598">网络配置</h2>
<div class="outline-text-2" id="text-h:505b57b4-2c04-4ef1-8293-0313b2e42598">
<p>
将Linux主机接入到网络，需要配置网络相关设置
</p>

<p>
一般包括如下内容：
</p>

<ul class="org-ul">
<li>主机名</li>
<li>IP/netmask</li>
<li>路由：默认网关</li>
<li>DNS服务器
<ul class="org-ul">
<li>主DNS服务器</li>
<li>次DNS服务器</li>
<li>第三个DNS服务器</li>
</ul></li>
</ul>
</div>
<div id="outline-container-h:ab07a8ba-6854-4314-81d2-36a4ecd563a7" class="outline-3">
<h3 id="h:ab07a8ba-6854-4314-81d2-36a4ecd563a7">统一网卡名称</h3>
<div class="outline-text-3" id="text-h:ab07a8ba-6854-4314-81d2-36a4ecd563a7">
<p>
CentOS 6之前，网络接口使用连续号码命名：eth0、eth1等,当增加或删除网卡时，名称可能会发生变化
</p>

<p>
CentOS 7开始，改变了网卡设备命名规则，基于硬件生成网卡名，如ens33, ens160等，可以保持网卡名称稳定且唯一；
但是在批量环境中，没办法统一；
</p>

<p>
出于批量管理，以及脚本的通用性等方面的考虑；
在某些情况下，需要将新的网卡命令规则改成传统的命名方式；即将ens33, ens160等名称改为eth0, eth1。
</p>

<p>
网卡组成格式
</p>
<div class="org-src-container">
<pre class="src src-sh">en: Ethernet &#26377;&#32447;&#23616;&#22495;&#32593;
wl: wlan &#26080;&#32447;&#23616;&#22495;&#32593;
ww: wwan&#26080;&#32447;&#24191;&#22495;&#32593;
o&lt;index&gt;: &#38598;&#25104;&#35774;&#22791;&#30340;&#35774;&#22791;&#32034;&#24341;&#21495;
s&lt;slot&gt;: &#25193;&#23637;&#27133;&#30340;&#32034;&#24341;&#21495;
x&lt;MAC&gt;: &#22522;&#20110;MAC&#22320;&#22336;&#30340;&#21629;&#21517;
p&lt;bus&gt;s&lt;slot&gt;: enp2s1
</pre>
</div>

<p>
修改方法
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#29992;&#25805;&#20316;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">1 &#20462;&#25913;/etc/default/grub</span>
<span style="color: #a0522d;">GRUB_CMDLINE_LINUX</span>=<span style="color: #8b2252;">"net.ifnames=0"</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#26159;dell&#20844;&#21496;&#30340;&#32593;&#21345;&#23601;&#22810;&#21152;&#36825;&#20010;biosdevname=0</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2 &#20026;grub2&#29983;&#25104;&#20854;&#37197;&#32622;&#25991;&#20214;</span>
grub2-mkconfig -o /etc/grub2.cfg
<span style="color: #b22222;"># </span><span style="color: #b22222;">3.&#20462;&#25913;&#32593;&#21345;&#21517;&#31216; </span>
vim /etc/sysconfig/network-scripts/ifcfg-eno16777736
&#20462;&#25913;&#20026; 
<span style="color: #a0522d;">NAME</span>=eth0 
<span style="color: #a0522d;">DEVICE</span>=eth0
<span style="color: #b22222;"># </span><span style="color: #b22222;">4 &#37325;&#21551;&#31995;&#32479;</span>
robot

<span style="color: #b22222;">#</span><span style="color: #b22222;">Rocky8</span>
&#20462;&#25913; /etc/sysconfig/network-scripts/ifcfg-ens160 &#23558;&#25991;&#20214;&#20013;&#30340;ens160&#26367;&#25442;&#25104;eth0, &#24182;&#20462;&#25913;&#25991;&#20214;&#21517;&#65292;&#23558;ifcfg-ens160 &#20462;&#25913;&#20026;ifcfg-eth0

&#37325;&#26032;&#35835;&#21462;&#37197;&#32622;&#25991;&#20214;
&#22522;&#20110;UEFI&#27169;&#24335;&#24341;&#23548;&#31995;&#32479;  grub2-mkconfig -o /boot/efi/EFI/radhat/grub2.cfg
&#22522;&#20110;BIOS&#27169;&#24335;&#24341;&#23548;&#31995;&#32479;  grub2-mkconfig -o /boot/grub2/grub2.cfg

&#20877;&#25191;&#34892;&#37325;&#21551; reboot


<span style="color: #b22222;">#</span><span style="color: #b22222;">Ubutu22</span>

&#37325;&#26032;&#35835;&#21462;&#37197;&#32622;&#25991;&#20214; grub-mkconfig -o /boot/grub/grub.cfg

&#20462;&#25913; /etc/netplan/00-installer-config.yaml  &#23558;ens160&#25913;&#20026;eht0

&#20877;&#25191;&#34892;&#37325;&#21551; reboot
</pre>
</div>


<p>
范例：ubuntu改网卡名
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;&#25991;&#20214;&#20026;&#19979;&#38754;&#24418;&#24335;</span>
root@ubuntu1804:~#vi /etc/default/grub
<span style="color: #a0522d;">GRUB_CMDLINE_LINUX</span>=<span style="color: #8b2252;">"net.ifnames=0"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;sed&#20462;&#25913;</span>
root@ubuntu1804:~# sed -i.bak <span style="color: #8b2252;">'/^GRUB_CMDLINE_LINUX=/s#"$#net.ifnames=0"#'</span> /etc/default/grub

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25928;&#26032;&#30340;grub.cfg&#25991;&#20214;</span>
root@ubuntu1804:~# grub-mkconfig -o /boot/grub/grub.cfg
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;</span>
root@ubuntu1804:~# update-grub
root@ubuntu1804:~# grep net.ifnames /boot/grub/grub.cfg
            linux /vmlinuz-4.15.0-96-generic <span style="color: #a0522d;">root</span>=<span style="color: #a0522d;">UUID</span>=51517b88-7e2b-4d4a-8c14-fe1a48ba153c ro net.ifnames=0
            linux /vmlinuz-4.15.0-96-generic <span style="color: #a0522d;">root</span>=<span style="color: #a0522d;">UUID</span>=51517b88-7e2b-4d4a-8c14-fe1a48ba153c ro net.ifnames=0
            linux /vmlinuz-4.15.0-96-generic <span style="color: #a0522d;">root</span>=<span style="color: #a0522d;">UUID</span>=51517b88-7e2b-4d4a-8c14-fe1a48ba153c ro recovery nomodeset net.ifnames=0
            linux /vmlinuz-4.15.0-76-generic <span style="color: #a0522d;">root</span>=<span style="color: #a0522d;">UUID</span>=51517b88-7e2b-4d4a-8c14-fe1a48ba153c ro net.ifnames=0
            linux /vmlinuz-4.15.0-76-generic <span style="color: #a0522d;">root</span>=<span style="color: #a0522d;">UUID</span>=51517b88-7e2b-4d4a-8c14-fe1a48ba153c ro recovery nomodeset net.ifnames=0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913; /etc/netplan/00-installer-config.yaml  &#23558;ens160&#25913;&#20026;eht0</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;&#29983;&#25928;</span>
root@ubuntu1804:~# reboot
</pre>
</div>

<p>
<b>在安装系统的时候手动设置内核参数</b>
</p>

<ol class="org-ol">
<li>光标选择 "Install CentOS 7"</li>
<li>点击 Tab，打开 kernel 启动选项后，增加 net.ifnames=0</li>
</ol>


<p>
<b>临时修改网卡名称</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#ip link set eth0 down
[root@centos6 ~]#ip link set eth0 name abc
[root@centos6 ~]#ip link set abc up
</pre>
</div>

<p>
<b>其他版本操作系统, 修改网卡名</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">centos6 &#25913;&#32593;&#21345;&#21517;</span>
vim /etc/udev/rules.d/70-persistent-net.rules  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#23436;&#65292;&#37325;&#21551;&#29983;&#25928;</span>
<span style="color: #a0522d;">SUBSYSTEM</span>==<span style="color: #8b2252;">"net"</span>, <span style="color: #a0522d;">ACTION</span>==<span style="color: #8b2252;">"add"</span>, xxxxxxxxxxx,     <span style="color: #a0522d;">NAME</span>==<span style="color: #8b2252;">"eth0"</span>
</pre>
</div>

<p>
查看网卡： dmesg |grep &#x2013;i eth ethtool -i eth0
</p>

<p>
卸载网卡驱动： modprobe -r e1000 rmmod e1000
</p>

<p>
装载网卡驱动： modprobe e1000
</p>

<p>
<b>vmware虚拟机问题</b>
</p>

<p>
进入vmware控制台查看，还是显示原网卡名称，再查看网络服务状态，显示failed
</p>

<p>
如何解决？
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@controller ~]# cd /etc/udev/rules.d/
&#26597;&#30475; 90-eno-pix.rules

<span style="color: #b22222;"># </span><span style="color: #b22222;">This file was automatically generated on systemd update</span>
<span style="color: #a0522d;">SUBSYSTEM</span>==<span style="color: #8b2252;">"net"</span>, <span style="color: #a0522d;">ACTION</span>==<span style="color: #8b2252;">"add"</span>, <span style="color: #a0522d;">DRIVERS</span>==<span style="color: #8b2252;">"?*"</span>, ATTR{address}==<span style="color: #8b2252;">"00:50:56:3a:78:ee"</span>, <span style="color: #a0522d;">NAME</span>=<span style="color: #8b2252;">"eno16777736"</span>
<span style="color: #a0522d;">SUBSYSTEM</span>==<span style="color: #8b2252;">"net"</span>, <span style="color: #a0522d;">ACTION</span>==<span style="color: #8b2252;">"add"</span>, <span style="color: #a0522d;">DRIVERS</span>==<span style="color: #8b2252;">"?*"</span>, ATTR{address}==<span style="color: #8b2252;">"00:0c:29:72:41:10"</span>, <span style="color: #a0522d;">NAME</span>=<span style="color: #8b2252;">"eno33554984"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30475;&#21040;&#36824;&#26159;&#20043;&#21069;&#30340;&#32593;&#21345;&#21517;&#31216;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#25481;&#27492;&#25991;&#20214;&#65292;&#25110;&#32773;&#25913;&#20026;&#27491;&#30830;&#30340;&#32593;&#21345;&#21517;&#31216;&#65292;&#27880;&#24847;&#21644;mac&#23545;&#24212;&#65292;&#28982;&#21518;&#37325;&#21551;&#26426;&#22120;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fd45562f-6be7-4fc6-be61-7490a8a87d03" class="outline-3">
<h3 id="h:fd45562f-6be7-4fc6-be61-7490a8a87d03">网络配置</h3>
<div class="outline-text-3" id="text-h:fd45562f-6be7-4fc6-be61-7490a8a87d03">
</div>
<div id="outline-container-h:6b85f337-9ae7-468b-9789-ca6f4746aec9" class="outline-4">
<h4 id="h:6b85f337-9ae7-468b-9789-ca6f4746aec9">网络配置方式</h4>
<div class="outline-text-4" id="text-h:6b85f337-9ae7-468b-9789-ca6f4746aec9">
<p>
将主机接入到网络，需要进制网络配置，每个网卡都需要有对应的配置文件，才能生效。
</p>

<p>
<b>静态指定</b> : static, 写在配置文件中，不会根据环境的改变而发生变化
</p>

<p>
<b>动态分配</b> : DHCP: Dynamic Host Configuration Protocol 根据动态主机配置协议生成相应的配置
</p>
</div>
</div>
<div id="outline-container-h:85a11468-8d18-44fe-bc80-300ceb27d6bc" class="outline-4">
<h4 id="h:85a11468-8d18-44fe-bc80-300ceb27d6bc">Red Hat系列网卡配置</h4>
<div class="outline-text-4" id="text-h:85a11468-8d18-44fe-bc80-300ceb27d6bc">
<p>
<b>配置文件</b>
</p>

<p>
网卡配置文件存在于 /etc/sysconfig/network-scripts/目录中，以ifcfg-XXX的格式命名
</p>

<p>
路径是固定的，文件命名规则也是固定的。
</p>

<p>
<b>常用配置</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">DEVICE</span>=eth0
<span style="color: #a0522d;">NAME</span>=eth0
<span style="color: #a0522d;">BOOTPROTO</span>=static
<span style="color: #a0522d;">ONBOOT</span>=yes

<span style="color: #a0522d;">IPADDR</span>=10.0.1.86
<span style="color: #a0522d;">PREFIX</span>=24
<span style="color: #a0522d;">GATEWAY</span>=10.0.0.1
<span style="color: #a0522d;">DNS1</span>=223.6.6.6
<span style="color: #a0522d;">DNS2</span>=180.76.76.76
</pre>
</div>

<p>
说明参考： <code>/usr/share/doc/initcripts-*/sysconfig.txt</code>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">===&#19968;&#33324;&#36873;&#39033;</span>
<span style="color: #a0522d;">TYPE</span>=                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25509;&#21475;&#31867;&#22411;&#65292;&#24120;&#35265;&#30340;&#26377;Ethernet&#20197;&#22826;&#32593;, Bridge&#26725;&#25509;</span>
<span style="color: #a0522d;">NAME</span>=                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25551;&#36848;&#12290;&#27492;&#37197;&#32622;&#25991;&#20214;&#24212;&#29992;&#21040;&#30340;&#35774;&#22791;&#65292;&#38543;&#20415;&#20889;&#65292;&#19968;&#33324;&#19982;&#35774;&#22791;&#21517;&#19968;&#33268;&#65292;&#21487;&#36873;  nmcli connection&#21629;&#20196;&#20250;&#26174;&#31034;&#36825;&#30340;&#21517;&#23383;</span>
<span style="color: #a0522d;">DEVICE</span>=               <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#22791;&#21517;&#65292;&#36319;&#32593;&#21345;&#21517;&#21305;&#37197;</span>
<span style="color: #a0522d;">BOOTPROTO</span>=            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;IP&#26041;&#24335;&#65292;dhcp &#21160;&#24577;, static | none | bootp &#38745;&#24577;</span>
<span style="color: #a0522d;">ONBOOT</span>=               <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#21542;&#24320;&#26426;&#21551;&#21160;&#65292; yes&#21551;&#21160;,no&#31105;&#29992;</span>
<span style="color: #a0522d;">IPADDR</span>=               <span style="color: #b22222;"># </span><span style="color: #b22222;">IPV4&#30340;IP&#22320;&#22336;&#65292;&#22810;&#20010;&#22320;&#22336;&#21487;&#20197;&#20889;&#25104;IPADDR2, IPADDR3</span>
<span style="color: #a0522d;">NETMASK</span>=              <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23376;&#32593;&#25513;&#30721;&#65292;&#20256;&#32479;&#20889;&#27861;&#65292;&#22914;:255.255.255.0&#65292;&#21487;&#20197; PREFIX &#20195;&#26367;</span>
<span style="color: #a0522d;">PREFIX</span>=               <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23376;&#32593;&#25513;&#30721;&#65292;&#26032;&#20889;&#27861; &#65292;&#32593;&#32476;ID&#30340;&#20301;&#25968;, &#19982;NETMASK&#31561;&#20215;&#12290;PREFIX=24&#65292;&#22810;&#22320;&#22336;&#21487;&#20197;&#23450;&#25104;PREFIX2, PREFIX3</span>
<span style="color: #a0522d;">GATEWAY</span>=              <span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;&#32593;&#20851;, &#36335;&#30001;&#22120;&#30340;&#22320;&#22336;&#65292;&#25552;&#20379;&#36328;&#32593;&#27573;&#36890;&#35759;&#21151;&#33021;&#12290;</span>
<span style="color: #a0522d;">DNS1</span>=                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20027;DNS</span>
<span style="color: #a0522d;">DNS2</span>=                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27425;DNS</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">===&#38468;&#21152;&#36873;&#39033;</span>
<span style="color: #a0522d;">UUID</span>=                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27492;&#35774;&#22791;&#30340;&#24799;&#19968;&#26631;&#35782;</span>
<span style="color: #a0522d;">HWADDR</span>=               <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23545;&#24212;&#30340;&#35774;&#22791;&#30340;MAC&#22320;&#22336;</span>
<span style="color: #a0522d;">DOMAIN</span>=               <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22495;&#21517;&#21518;&#32512;&#12290;&#20027;&#26426;&#19981;&#23436;&#25972;&#26102;&#65292;&#33258;&#21160;&#25628;&#32034;&#30340;&#22495;&#21517;&#21518;&#32512;</span>
<span style="color: #a0522d;">USERCTL</span>=              <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26222;&#36890;&#29992;&#25143;&#26159;&#21542;&#21487;&#25511;&#21046;&#27492;&#35774;&#22791;</span>
<span style="color: #a0522d;">DEFROUTE</span>=             <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#19981;&#35774;&#32622;&#20026;&#40664;&#35748;&#36335;&#30001;; &#40664;&#35748; yes&#65307;</span>
<span style="color: #a0522d;">PEERDNS</span>=              <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;BOOTPROTO&#30340;&#20540;&#20026;"dhcp"&#65292;YES&#23558;&#20801;&#35768;dhcp server&#20998;&#37197;&#30340;dns&#26381;&#21153;&#22120;&#20449;&#24687;&#30452;&#25509;&#35206;&#30422;&#33267;/etc/resolv.conf&#25991;&#20214;&#65292;NO&#19981;&#20801;&#35768;&#20462;&#25913;resolv.conf</span>
<span style="color: #a0522d;">PEERROUTES</span>=           <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33258;&#21160;&#33719;&#21462;&#36335;&#30001;&#12290;server&#20998;&#37197;&#30340;dns&#26381;&#21153;&#22120;&#25351;&#21521;&#35206;&#30422;&#26412;&#22320;&#25163;&#21160;&#25351;&#23450;&#30340;DNS&#26381;&#21153;&#22120;&#25351;&#21521;&#65307;&#40664;&#35748;&#20026;&#20801;&#35768;&#65307;</span>
<span style="color: #a0522d;">NM_CONTROLLED</span>=        <span style="color: #b22222;"># </span><span style="color: #b22222;">NM&#26159;NetworkManager&#30340;&#31616;&#20889;&#65292;&#27492;&#32593;&#21345;&#26159;&#21542;&#25509;&#21463;NM&#25511;&#21046;; &#22312;CentOS 6&#19978;networkManager&#19981;&#23436;&#21892;&#65292;&#38598;&#32676;&#12289;&#34394;&#25311;&#21270;&#26725;&#25509;&#22312;&#27492;&#32593;&#32476;&#26381;&#21153;&#19979;&#26080;&#27861;&#20351;&#29992;</span>

<span style="color: #a0522d;">PROXY_METHOD</span>=none                     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20195;&#29702;&#26041;&#24335;&#65306;&#20851;&#38381;&#29366;&#24577;</span>
<span style="color: #a0522d;">BROWSER_ONLY</span>=no                       <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21482;&#26159;&#27983;&#35272;&#22120;&#19978;&#32593;&#65306;&#21542;</span>
<span style="color: #a0522d;">IPV4_FAILURE_FATAL</span>=no                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#19981;&#24320;&#21551;IPV4&#33268;&#21629;&#38169;&#35823;&#26816;&#27979;&#65306;&#21542;</span>
<span style="color: #a0522d;">IPV6INIT</span>=yes                          <span style="color: #b22222;"># </span><span style="color: #b22222;">IPV6&#26159;&#21542;&#33258;&#21160;&#21021;&#22987;&#21270;: &#26159;[&#19981;&#20250;&#26377;&#20219;&#20309;&#24433;&#21709;, &#29616;&#22312;&#36824;&#27809;&#29992;&#21040;IPV6]</span>
<span style="color: #a0522d;">IPV6_AUTOCONF</span>=yes                     <span style="color: #b22222;"># </span><span style="color: #b22222;">IPV6&#26159;&#21542;&#33258;&#21160;&#37197;&#32622;&#65306;&#26159;[&#19981;&#20250;&#26377;&#20219;&#20309;&#24433;&#21709;, &#29616;&#22312;&#36824;&#27809;&#29992;&#21040;IPV6]</span>
<span style="color: #a0522d;">IPV6_DEFROUTE</span>=yes                     <span style="color: #b22222;"># </span><span style="color: #b22222;">IPV6&#26159;&#21542;&#21487;&#20197;&#20026;&#40664;&#35748;&#36335;&#30001;&#65306;&#26159;[&#19981;&#20250;&#26377;&#20219;&#20309;&#24433;&#21709;, &#29616;&#22312;&#36824;&#27809;&#29992;&#21040;IPV6]</span>
<span style="color: #a0522d;">IPV6_FAILURE_FATAL</span>=no                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#19981;&#24320;&#21551;IPV6&#33268;&#21629;&#38169;&#35823;&#26816;&#27979;&#65306;&#21542;</span>
<span style="color: #a0522d;">IPV6_ADDR_GEN_MODE</span>=stable-privacy     <span style="color: #b22222;"># </span><span style="color: #b22222;">IPV6&#22320;&#22336;&#29983;&#25104;&#27169;&#22411;&#65306;stable-privacy [&#36825;&#21482;&#19968;&#31181;&#29983;&#25104;IPV6&#30340;&#31574;&#30053;]</span>
</pre>
</div>


<p>
生效
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">centos7,8</span>
nmcli connection reload <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#36733;&#37197;&#32622;&#25991;&#20214;</span>
nmcli con  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;</span>
nmcli connection up eth0

<span style="color: #b22222;">#</span><span style="color: #b22222;">centos7</span>
systemctl restart network
<span style="color: #b22222;">#</span><span style="color: #b22222;">centos6\7</span>
service network restart
</pre>
</div>

<p>
检查是否生效
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">ip &#30830;&#35748;</span>
ip a
ip a show device

ifconfig
ifconfig device

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36335;&#30001;&#30830;&#35748;</span>
route -n
ip route

<span style="color: #b22222;">#</span><span style="color: #b22222;">DNS&#30830;&#35748;</span>
</pre>
</div>


<p>
范例：在centos中为网卡多配置几个ip地址
</p>
<div class="org-src-container">
<pre class="src src-sh">vim /etc/sysconfig/network-scripts/ifcfg-ens5
<span style="color: #a0522d;">DEVICE</span>=ens5
<span style="color: #a0522d;">NAME</span>=ens5
<span style="color: #a0522d;">BOOTPROTO</span>=static
<span style="color: #a0522d;">ONBOOT</span>=yes

<span style="color: #a0522d;">IPADDR</span>=10.0.1.86
<span style="color: #a0522d;">PREFIX</span>=24

<span style="color: #a0522d;">IPADDR2</span>=10.0.1.87
<span style="color: #a0522d;">PREFIX2</span>=24

<span style="color: #a0522d;">IPADDR3</span>=10.0.1.88
<span style="color: #a0522d;">PREFIX3</span>=24

<span style="color: #a0522d;">GATEWAY</span>=10.0.0.1
<span style="color: #a0522d;">DNS1</span>=223.6.6.6
<span style="color: #a0522d;">DNS2</span>=180.76.76.76

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#26032;&#29983;&#25928;</span>
nmcli con reload; nmcli con up ens5
ip a show ens5

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26032;&#22686;&#21035;&#21517;&#25991;&#20214;&#26041;&#27861;</span>
cp ifcfg-ens5  ifcfg-ens5:1
vim ifcfg-ens5:1
<span style="color: #a0522d;">DEVICE</span>=ens5:1
<span style="color: #a0522d;">BOOTPROTO</span>=static
<span style="color: #a0522d;">IPADDR</span>=10.0.1.89
<span style="color: #a0522d;">PREFIX</span>=24

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#26032;&#29983;&#25928;</span>
nmcli con reload; nmcli con up ens5
ip a show ens5

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#38500;</span>
rm ifcfg-ens5:1
nmcli con reload; nmcli con up ens5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9f8765c4-e6b6-4de2-90a6-ae877f4007fa" class="outline-4">
<h4 id="h:9f8765c4-e6b6-4de2-90a6-ae877f4007fa">Ubuntu系统网卡配置</h4>
<div class="outline-text-4" id="text-h:9f8765c4-e6b6-4de2-90a6-ae877f4007fa">
<p>
官网文档：
</p>

<ul class="org-ul">
<li><a href="https://help.ubuntu.com/">https://help.ubuntu.com/</a></li>
<li><a href="https://ubuntu.com/server/docs/network-configuration">https://ubuntu.com/server/docs/network-configuration</a></li>
</ul>

<p>
<b>配置文件</b>
</p>

<p>
网卡配置文件在 <i>etc/netplan</i> 目录中，以XXX.yaml的格式命名。
</p>

<p>
路径是固定的，文件命名规则也是固定的。
</p>


<p>
配置自动获取IP
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">root@ubuntu1804:~# cat /etc/netplan/01-netcfg.yaml
<span style="color: #b22222;"># </span><span style="color: #b22222;">This file describes the network interfaces available on your system</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">For more information, see netplan(5).</span>
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: yes

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#32593;&#21345;&#37197;&#32622;&#25991;&#20214;&#21518;&#38656;&#25191;&#34892;&#21629;&#20196;&#29983;&#25928;&#65306;</span>
root@ubuntu1804:~#netplan apply
</pre>
</div>

<p>
常见配置项
</p>
<div class="org-src-container">
<pre class="src src-sh">dhcp4               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#36890;&#36807;dhcp&#26381;&#21153;&#33719;&#21462;IP&#65292; ture|false</span>
addresses           <span style="color: #b22222;">#</span><span style="color: #b22222;">IP&#22320;&#22336;&#65292;&#21015;&#34920;</span>
gateway4            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#20851;</span>
nameservers         <span style="color: #b22222;">#</span><span style="color: #b22222;">DNS</span>
version             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29256;&#26412;&#65292;&#40664;&#35748;&#20889;2</span>
search              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22495;&#21517;&#21518;&#32512;&#65292;&#21015;&#34920;</span>
</pre>
</div>


<p>
配置静态IP
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">root@ubuntu1804:~#vim /etc/netplan/01-netcfg.yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      addresses: [192.168.8.10/24,10.0.0.10/8]     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#29992;&#19979;&#38754;&#20004;&#34892;,&#20004;&#31181;&#26684;&#24335;&#19981;&#33021;&#28151;&#29992;</span>
      - 192.168.8.10/24
      - 10.0.0.10/8
      gateway4: 192.168.8.1
      nameservers:
        search: [you.com, you.org]
        addresses: [180.76.76.76, 8.8.8.8, 1.1.1.1]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25928;</span>
netplan apply

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;ip&#21644;gateway</span>
root@ubuntu1804:~#ip addr
root@ubuntu1804:~#route -n

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;DNS</span>
root@ubuntu1804:~#ls -l /etc/resolv.conf
lrwxrwxrwx 1 root root 39 Dec 12 11:36 /etc/resolv.conf -&gt;../run/systemd/resolve/stub-resolv.conf

root@ubuntu1804:~# systemd-resolve --status <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992;&#19987;&#38376;&#30340;&#21629;&#20196;&#30475;</span>
... ...               
  Current DNS Server: 180.76.76.76
         DNS Servers: 8.8.8.8
                      1.1.1.1
         DNS Domain: you.com
                     you.org
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:3259854c-47a3-4d7f-b11e-fcbb69b558fa" class="outline-3">
<h3 id="h:3259854c-47a3-4d7f-b11e-fcbb69b558fa">网络配置命令</h3>
<div class="outline-text-3" id="text-h:3259854c-47a3-4d7f-b11e-fcbb69b558fa">
</div>
<div id="outline-container-h:80be0e63-ecf0-436e-9ed8-7863eb32dd55" class="outline-4">
<h4 id="h:80be0e63-ecf0-436e-9ed8-7863eb32dd55">主机名</h4>
<div class="outline-text-4" id="text-h:80be0e63-ecf0-436e-9ed8-7863eb32dd55">
<p>
<b>hostname</b>
</p>

<p>
hostname 是临时有效，重启后消失
</p>

<div class="org-src-container">
<pre class="src src-sh">hostname [-b] {hostname|-F file}                   <span style="color: #483d8b;">set</span> host name (from file)
hostname [-a|-A|-d|-f|-i|-I|-s|-y]                 display frmatted name
hostname                                           display host name

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24120;&#29992;&#36873;&#39033;</span>
-a|--alias            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#21015;&#21035;&#21517;</span>
-F|--file             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#25991;&#20214;&#20013;&#35835;&#21462;</span>
-i|--ip-address       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;IP&#22320;&#22336;&#65292;&#20165;&#26174;&#31034;&#33021;&#35299;&#26512;&#22320;&#22336;</span>
-I|--all-ip-address   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#25152;&#26377;IP&#22320;&#22336;&#65292;&#21253;&#21547;&#19981;&#33021;&#34987;&#35299;&#26512;&#30340;&#65292;&#20294;&#19981;&#26174;&#31034;IPV6&#22320;&#22336;&#65292;&#19981;&#26174;&#31034;&#22238;&#29615;&#22320;&#22336;</span>
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@test ~]# hostname 
<span style="color: #483d8b;">test</span>
[root@test ~]# hostname -a

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#20174;&#25991;&#20214;&#20013;&#35835;&#21462;</span>
[root@test ~]# echo <span style="color: #8b2252;">"abc"</span> &gt; name.txt
[root@test ~]# hostname -F name.txt 
[root@test ~]# hostname
abc

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;IP&#22320;&#22336;&#65292;&#20250;&#21345;&#19968;&#20250;&#65292;&#22240;&#20026;&#35201;&#36890;&#36807;DNS&#21453;&#35299;&#26512;&#20027;&#26426;&#21517;</span>
[root@test ~]# hostname -i
fe80::894:e4ff:fe15:4375%ens5 fe80::42:78ff:fe46:572%docker0 10.0.129.226 172.17.0.1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#25152;&#26377;IPV4&#22320;&#22336;</span>
[root@test ~]# hostname -I
10.0.129.226 172.17.0.1 
</pre>
</div>

<p>
<b>hostnamectl</b>
</p>

<p>
写配置文件，永久有效
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;</span>
[root@test ~]# hostnamectl status
   Static hostname: ip-10-0-129-226.af-south-1.compute.internal
Transient hostname: abc
         Icon name: computer-vm
           Chassis: vm &#128436;
        Machine ID: ec24775dff9a810f40403ef5efb91521
           Boot ID: 38485ee08a4e4f94b6d3471cbc4ebd40
    Virtualization: amazon
  Operating System: Amazon Linux 2023.5.20240903
       CPE OS Name: cpe:2.3:o:amazon:amazon_linux:2023
            Kernel: Linux 6.1.106-116.188.amzn2023.aarch64
      Architecture: arm64
   Hardware Vendor: Amazon EC2
    Hardware Model: t4g.medium
  Firmware Version: 1.0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#65292;&#20250;&#20889;&#36827;/etc/hostname &#25991;&#20214;&#20013;&#65292;&#27704;&#20037;&#26377;&#25928;</span>
[root@test ~]# hostnamectl hostname af-south1-jump
[root@test ~]# cat /etc/hostname
af-south1-jump

</pre>
</div>
</div>
</div>
<div id="outline-container-h:5e25d3de-f762-4d3b-b394-628ccae1e016" class="outline-4">
<h4 id="h:5e25d3de-f762-4d3b-b394-628ccae1e016">ifconfig命令</h4>
<div class="outline-text-4" id="text-h:5e25d3de-f762-4d3b-b394-628ccae1e016">
<p>
来自于net-tools包，建议使用 ip 代替
</p>

<p>
默认不能显示第二地址，只能显示主地址。指明标签(接口别名)就能够显示了
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">rpm -qf `which ifconfig`</span>
net-tools-2.0-0.25.20131004git.el7.x86_64

<span style="color: #b22222;"># </span><span style="color: #b22222;">rpm -qi net-tools</span>
... ...
Most of them are obsolete. For replacement check iproute package.
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">NAME
       ifconfig - configure a network interface

SYNOPSIS
       ifconfig [-v] [-a] [-s] [interface]
       ifconfig [-v] interface [aftype] options | address ...

NOTE
       This program is obsolete!  For replacement check ip addr and ip link.  For statistics use ip -s link.
</pre>
</div>

<p>
用法
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;&#21482;&#20250;&#26174;&#31034;&#28608;&#27963;&#29366;&#24577;&#30340;&#32593;&#21345;&#20449;&#24687;</span>
ifconfig [interface]
ifconfig -a <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26174;&#31034;&#25152;&#26377;&#25509;&#21475;&#65292;&#21253;&#25324;inactive&#29366;&#24577;&#30340;&#25509;&#21475;&#65307;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#29992;/&#20851;&#38381;&#32593;&#21345;</span>
ifconfig IFACE [up|down]
ifup/ifdown&#21629;&#20196;

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23454;&#29616;&#22320;&#22336;&#37197;&#32622;</span>
ifconfig interface [aftype] options | address ...
  ifconfig IFACE IP/netmask [up]
  ifconfig IFACE IP netmask NETMASK

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#25351;&#23450;&#25509;&#21475;&#32593;&#21345;&#30340;&#22320;&#22336;&#65306;</span>
ifconfig  INTERFACE  0
</pre>
</div>

<p>
注意：立即生效
</p>

<p>
启用混杂模式：[-]promisc混杂模式；减号是去掉此功能,直接加表示进入混杂模式
</p>

<p>
范例：网卡状态
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">CentOS 7</span>
[root@centos7 ~]# ifconfig 
eno16777736: <span style="color: #a0522d;">flags</span>=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.1.110  netmask 255.255.255.0  broadcast 192.168.1.255
        inet6 fe80::20c:29ff:fefc:81b2  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether 00:0c:29:fc:81:b2  txqueuelen 1000  (Ethernet)
        RX packets 159  bytes 19117 (18.6 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 116  bytes 14163 (13.8 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0


eno16777736: <span style="color: #a0522d;">flags</span>=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
    eno16777736     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#21345;&#25509;&#21475;&#21517;&#31216;&#65306;</span>
    <span style="color: #a0522d;">flags</span>=4163      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26631;&#24535;&#20301;&#65292;UP&#34920;&#31034;&#32593;&#21345;&#21551;&#29992;&#28608;&#27963;&#29366;&#24577;</span>
    UP              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28608;&#27963;&#29366;&#24577;</span>
    BROADCAST       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25903;&#25345;&#24191;&#25773;&#21151;&#33021;</span>
    MULTICAST       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;&#32452;&#25773;(&#21363;&#22810;&#25773;)&#21151;&#33021;</span>
    RUNNING         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#29366;&#24577;</span>
    mtu 1500        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25903;&#25345;&#32593;&#21345;&#26368;&#22823;&#30340;&#20256;&#36755;&#21333;&#20301;1500&#23383;&#33410;&#65307;</span>

inet 192.168.1.110  netmask 255.255.255.0  broadcast 192.168.1.255
    inet 192.168.1.110       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;&#22320;&#22336;</span>
    netmask 255.255.255.0    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23376;&#32593;&#25513;&#30721;</span>
    broadcast 192.168.1.255  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24191;&#25773;&#22320;&#22336;</span>

ether 00:0c:29:fc:81:b2  txqueuelen 1000  (Ethernet)
    ether 00:0c:29:fc:81:b2      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#22826;&#32593;&#22320;&#22336;</span>
    txqueuelen 1000  (Ethernet)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20256;&#36755;&#38431;&#21015;&#38271;&#24230;</span>

RX packets 159  bytes 19117 (18.6 KiB)                      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27492;&#27425;&#32593;&#21345;&#28608;&#27963;&#21518;&#25509;&#25628;&#21040;&#30340;&#25253;&#25991;&#25968;&#37327;&#65292;&#24635;&#22823;&#23567;</span>
RX errors 0  dropped 0  overruns 0  frame 0                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25509;&#25910;&#26102;&#38169;&#35823;&#12289;&#20002;&#22833;&#12289;&#28322;&#20986;&#12289;&#24103;&#30340;&#25968;&#37327;</span>
TX packets 116  bytes 14163 (13.8 KiB)                      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20256;&#20986;&#30340;&#25968;&#25454;&#25253;&#25991;&#65292;&#19968;&#20849;&#23383;&#33410;</span>
TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20256;&#36755;&#30340;&#38169;&#35823;&#12289;&#20002;&#21253;&#12289;&#28322;&#20986;&#12289;&#24103;</span>
&#27880;&#24847;&#65306;&#36825;&#37324;&#38656;&#35201;&#20851;&#27880;&#30340;&#26159;errors\drooped&#25968;&#37327;

<span style="color: #b22222;"># </span><span style="color: #b22222;">CentOS 6</span>
 [root@centos6 ~]# ifconfig 
eth0      Link encap:Ethernet  HWaddr 00:0C:29:FB:24:6E  
          inet addr:192.168.1.113  Bcast:192.168.1.255  Mask:255.255.255.0
          inet6 addr: fe80::20c:29ff:fefb:246e/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:794092 errors:0 dropped:0 overruns:0 frame:0
          TX packets:13268 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:51277004 (48.9 MiB)  TX bytes:12174059 (11.6 MiB)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25152;&#26377;&#35774;&#22791;&#65292;&#21253;&#25324;&#31105;&#29992;&#30340;</span>
ifconfig -a
</pre>
</div>

<p>
范例: 网卡配置
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ifconfig eth0 10.0.0.68 netmask 255.255.0.0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#38500;eth0&#19978;&#38754;&#30340;IP&#22320;&#22336;</span>
[root@centos8 ~]#ifconfig eth0 0.0.0.0/0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#21644;&#31105;&#29992;&#32593;&#21345;</span>
[root@centos8 ~]#ifconfig eth0 down
[root@centos8 ~]#ifconfig eth0 up

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#19968;&#20010;&#32593;&#21345;&#35774;&#32622;&#22810;&#20010;IP&#22320;&#22336;</span>
[root@centos8 ~]#ifconfig eth0:1 172.16.0.8/24  <span style="color: #b22222;"># </span><span style="color: #b22222;">CIDR&#34920;&#31034;&#27861;</span>
[root@centos8 ~]#ifconfig
eth0: <span style="color: #a0522d;">flags</span>=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500
            inet 10.0.0.8 netmask 255.0.0.0 broadcast 10.255.255.255

eth0:1: <span style="color: #a0522d;">flags</span>=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500
            inet 172.16.0.8 netmask 255.255.255.0 broadcast 172.16.0.255
            ether 00:0c:29:45:a8:a1 txqueuelen 1000 (Ethernet)


[root@centos8 ~]#ifconfig eth0:1 down
[root@centos8 ~]#ifconfig
</pre>
</div>

<p>
范例: 统计当前网卡流量
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@test ~]# ifconfig -s
Iface      MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg
ens5             9001 11183467      0      0 0      14622313      0      0      0 BMRU
lo              65536  3711807      0      0 0       3711807      0      0      0 LRU

ping -f 10.0.1.86 -s 65507 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25915;&#20987; -s &#26368;&#22823;&#21457;&#36865;65507 &#23383;&#33410;&#30340;&#21253;  -f &#23613;CPU&#25152;&#33021;</span>
watch ifconfig -s eth0     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21160;&#24577;&#30417;&#21548;&#32593;&#32476;&#27969;&#37327;</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23383;&#27573;&#35828;&#26126;</span>
Iface         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;&#35774;&#22791;</span>
MTU           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35813;&#25509;&#21475;&#35774;&#22791;&#26368;&#22823;&#20256;&#36755;&#21333;&#20803;&#65292;&#21333;&#20301;&#26159;&#23383;&#33410;&#65292;&#23601;&#26159;&#19968;&#20010;&#25968;&#25454;&#21253;&#19981;&#33021;&#36229;&#36807;1500&#23383;&#33410;</span>
RX-OK         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25910;&#21253;&#26102;&#25104;&#21151;&#25509;&#25910;&#30340;&#25968;&#25454;&#21253;&#25968;&#37327;</span>
RX-ERR        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25910;&#21253;&#26102;&#20986;&#38169;&#30340;&#25968;&#25454;&#21253;&#25968;&#37327;</span>
RX-DRP        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25910;&#21253;&#26102;&#20002;&#24323;&#30340;&#25968;&#25454;&#21253;&#25968;&#37327;</span>
RX-OVR        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25910;&#21253;&#26102;&#30001;&#20110;&#36807;&#36895;(&#25509;&#25910;&#35774;&#22791;&#25910;&#19981;&#36807;&#26469;)&#32780;&#20002;&#24323;&#30340;&#25968;&#25454;&#21253;&#25968;&#37327;</span>
TX-OK         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21457;&#21253;&#26102;&#25104;&#21151;&#21457;&#36865;&#30340;&#25968;&#25454;&#21253;&#25968;&#37327;</span>
TX-ERR        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21457;&#21253;&#26102;&#20986;&#38169;&#30340;&#25968;&#25454;&#21253;&#25968;&#37327;</span>
TX-DRP        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21457;&#21253;&#26102;&#20002;&#24323;&#30340;&#25968;&#25454;&#21253;&#25968;&#37327;</span>
TX-OVR        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21457;&#21253;&#26102;&#30001;&#20110;&#36807;&#36895;(&#25509;&#25910;&#35774;&#22791;&#25910;&#19981;&#36807;&#26469;)&#32780;&#20002;&#24323;&#30340;&#25968;&#25454;&#21253;&#25968;&#37327;</span>
Flg           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26631;&#24535;&#20301;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">Flg&#23383;&#27573;&#35828;&#26126;</span>
B   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35813;&#35774;&#22791;&#24050;&#32463;&#35774;&#32622;&#20102;&#24191;&#25773;&#22320;&#22336;</span>
L   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35813;&#35774;&#22791;&#26159;&#19968;&#20010;&#22238;&#29615;&#22320;&#22336;</span>
M   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35813;&#35774;&#22791;&#33021;&#25509;&#25910;&#25152;&#26377;&#32463;&#36807;&#23427;&#30340;&#25968;&#25454;&#21253;&#65292;&#32780;&#19981;&#35770;&#20854;&#30446;&#30340;&#22320;&#22336;&#26159;&#21542;&#26159;&#23427;&#26412;&#36523;(&#28151;&#20081;&#27169;&#24335;)</span>
N   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35813;&#35774;&#22791;&#19981;&#33021;&#34987;&#36861;&#36394;</span>
O   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#35774;&#22791;&#19978;&#31105;&#27490;ARP</span>
P   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#26159;&#19968;&#20010;&#28857;&#21040;&#28857;&#36830;&#25509;</span>
R   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#35774;&#22791;&#27491;&#22312;&#36816;&#34892;</span>
U   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#35774;&#22791;&#22788;&#20110;&#27963;&#21160;&#29366;&#24577;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0433aa85-d052-4453-8d10-b491b5441dbd" class="outline-4">
<h4 id="h:0433aa85-d052-4453-8d10-b491b5441dbd">route命令</h4>
<div class="outline-text-4" id="text-h:0433aa85-d052-4453-8d10-b491b5441dbd">
<p>
判断网络问题，路由是很重要的一环。只要是和网络通信的主机都有路由表。
</p>

<p>
路由分类：
</p>

<ul class="org-ul">
<li>主机路由 精确固定</li>
<li>网络路由 到达网段路径</li>
<li>默认路由 目标为任意网络， 0.0.0.0/0</li>
</ul>

<p>
优先级：精度越高，优先级越高
</p>

<p>
<b>路由表主要构成:</b>
</p>

<ul class="org-ul">
<li>目标网络Destination:
<ul class="org-ul">
<li>目标网络ID,表示可以到达的目标网络ID,0.0.0.0/0
表示所有未知网络,又称为默认路由,优先级最低</li>
</ul></li>
<li>子网掩码Genmask:
<ul class="org-ul">
<li>目标网络对应的netmask</li>
</ul></li>
<li>接口Iface:
<ul class="org-ul">
<li>到达对应网络,应该从当前主机哪个网卡发送出来</li>
</ul></li>
<li>网关Gateway:
<ul class="org-ul">
<li>到达非直连的网络，将数据发送到临近(下一个)路由器的临近本主机的接口
的IP地址，下一跳next hop</li>
<li>如果是直连网络,gateway是0.0.0.0</li>
</ul></li>
<li>Metric: 开销cost,值越小,路由记录的优先级最高</li>
</ul>

<p>
<b>路由配置规则</b>
</p>

<ul class="org-ul">
<li>直连网络，自动会配置路由

<ul class="org-ul">
<li>回还地址 lo 除外。lo网段中的地址在本机都是可以访问通的。可以手动设
置lo的路由</li>
</ul></li>

<li>相隔的网络，距离自己最近的路由网卡接口做网关，即连接相通的目标地址做网关</li>
</ul>

<p>
<b>什么时间配置默认路由</b>
</p>

<ul class="org-ul">
<li>对于计算机来讲他不是路由器，计算机是整个网络的边界后面没有东西了就是
一台电脑只有一条出口，那可以只配置默认路由</li>

<li>对路由器来讲，要看路由器是不是网络的边界也可以合并配置为默认路由，否
则为多条路由</li>
</ul>

<p>
路由表管理命令
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24120;&#29992;&#36873;&#39033;</span>
-v|--verbose        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#35814;&#32454;&#20449;&#24687;</span>
-n|--numeric        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;IP&#26684;&#24335;&#26174;&#31034;&#65292;&#32780;&#19981;&#26159;&#20197;&#20027;&#26426;&#21517;&#26174;&#31034;</span>
-e|--extend         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#25193;&#23637;&#23383;&#27573;</span>
-F|--fib            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#36716;&#21457;&#20449;&#24687;</span>
-C|--cache          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#36335;&#30001;&#32531;&#23384;</span>
-V|--version        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#29256;&#26412;&#21495;</span>
-h|--help           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#24110;&#21161;&#20449;&#24687;</span>
-f                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#38500;&#32593;&#20851;&#20837;&#21475;&#22788;&#36335;&#30001;&#34920;</span>
-net                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#26631;&#26159;&#19968;&#20010;&#32593;&#32476;</span>
-host               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#26631;&#26159;&#19968;&#20010;&#20027;&#26426;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24120;&#29992;&#23376;&#21629;&#20196;</span>
add
del
flush
netmask
gw
metric
Destination
Gateway
</pre>
</div>

<p>
查看路由表：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">linux</span>
route
route -n <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20197;&#25968;&#23383;&#24418;&#24335;&#26174;&#31034;&#65292;&#32780;&#19981;&#35201;&#21453;&#35299;&#12290;&#33509;&#26377;&#24456;&#22810;&#36335;&#30001;&#20449;&#24687;&#30340;&#26102;&#20505;&#65292;&#21453;&#21521;&#35299;&#26512;&#20026;&#20027;&#26426;&#21517;&#21644;&#31471;&#21475;&#21517;&#20250;&#21344;&#29992;&#24456;&#22810;&#36164;&#28304;&#24320;&#38144;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">windows</span>
route print
</pre>
</div>

<p>
范例:路由表主要构成
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">route -n</span>
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.0.1        0.0.0.0         UG    100    0        0 eth0
10.0.0.0        0.0.0.0         255.255.252.0   U     100    0        0 eth0 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#30452;&#36830;&#32593;&#27573;&#65292;&#20250;&#33258;&#21160;&#37197;&#32622;&#36335;&#30001;</span>

Destination   <span style="color: #b22222;">#</span><span style="color: #b22222;">target &#30446;&#26631;&#32593;&#32476;DI&#12290;&#22914;&#26524;&#26159;0.0.0.0&#65292;&#20854;&#21518;Gateway&#20195;&#34920;&#40664;&#35748;&#32593;&#20851;&#22320;&#22336;&#65307;</span>
Gateway       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#20851;&#65292;&#19979;&#19968;&#36339;&#22320;&#22336;</span>
Genmask       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#26631;&#32593;&#32476;&#25513;&#30721;&#22320;&#22336;</span>
Flags         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36335;&#30001;&#26631;&#24535;&#65307;</span>
  U (route is up)                                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#34920;&#31034;&#21551;&#29992;&#29366;&#24577;</span>
  H (target is a host)                            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#26631;&#22320;&#22336;&#26159;&#19968;&#20010;&#20027;&#26426;&#22320;&#22336;</span>
  G (use gateway)                                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#32593;&#20851;</span>
  R (reinstate route for dynamic routing)         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21160;&#24577;&#36335;&#30001;</span>
  D (dynamically installed by daemon or redirect) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21160;&#24577;&#23433;&#35013;</span>
  M (modified from routing daemon or redirect)    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21160;&#24577;&#20462;&#25913;</span>
  A (installed by addrconf)
  C (cache entry)                                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32531;&#23384;</span>
  !  (reject route)                               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25298;&#32477;</span>
G&#65306;&#34920;&#31034;&#26159;&#19968;&#20010;&#32593;&#20851;&#65292;&#20294;&#19981;&#19968;&#23450;&#26159;&#30446;&#26631;&#32593;&#20851;&#65292;&#21482;&#26377;&#30446;&#26631;&#22320;&#22336;&#26159;0.0.0.0&#30340;&#25165;&#26159;&#40664;&#35748;&#32593;&#20851;

Metric       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24230;&#37327;&#20540;&#65292;&#21040;&#36798;&#32593;&#32476;&#25152;&#38656;&#24320;&#38144;&#12290;&#20540;&#36234;&#23567;&#65292;&#36335;&#30001;&#35760;&#24405;&#30340;&#20248;&#20808;&#32423;&#26368;&#39640;</span>
Ref          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24341;&#29992;&#27492;&#36335;&#30001;&#30340;&#27425;&#25968;    </span>
Use          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#27425;&#25968;</span>
Iface        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25509;&#21475;&#65292;&#21040;&#36798;&#23545;&#24212;&#32593;&#32476;&#65292;&#24212;&#35813;&#20174;&#24403;&#21069;&#20027;&#26426;&#21738;&#20010;&#32593;&#21345;&#21457;&#36865;&#20986;&#26469;</span>
</pre>
</div>

<p>
添加：route add
</p>

<div class="org-src-container">
<pre class="src src-sh">route add [-net|-host|default] target [netmask Nm] [gw GW] [[dev] If]
    [gw GW] &#65306;gw&#20026;&#20851;&#38190;&#23383;&#65292;GW&#34920;&#31034;&#30495;&#27491;&#30340;&#19979;&#19968;&#36339;&#22320;&#22336;
        &#19979;&#19968;&#36339;&#24517;&#39035;&#19982;&#33258;&#24049;&#30340;&#26576;&#22359;&#32593;&#21345;&#22312;&#21516;&#19968;&#32593;&#27573;&#20869;&#65292;&#19988;&#23384;&#22312;
    [[dev] If] &#65306;&#36827;&#30001;&#21738;&#22359;&#32593;&#21345;&#65292;&#21487;&#20197;&#30465;&#30053;&#65292;&#33021;&#33258;&#21160;&#21028;&#26029;
</pre>
</div>

<p>
删除：route del
</p>

<div class="org-src-container">
<pre class="src src-sh">route del [-net|-host] target [gw Gw] [netmask Nm] [[dev] If]
</pre>
</div>

<p>
范例：配置路由
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#26426;&#36335;&#30001; &#30446;&#26631;&#65306;192.168.1.3 &#32593;&#20851;&#65306;172.16.0.1</span>
route add -host 192.168.1.3 gw 172.16.0.1 dev eth0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;&#36335;&#30001; &#30446;&#26631;&#65306;192.168.0.0 &#32593;&#20851;&#65306;172.16.0.1</span>
route add -net 192.168.0.0 netmask 255.255.255.0 gw 172.16.0.1 dev eth0 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20256;&#32479;&#24418;&#24335;</span>
route add -net 192.168.0.0/24 gw 172.16.0.1 dev eth0 <span style="color: #b22222;"># </span><span style="color: #b22222;">CIDR &#26080;&#31867;&#22495;&#38388;&#36335;&#30001;&#34920;&#31034;&#27861;</span>
route add -net 192.168.8.0/24 dev eth1 metric 200 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;2&#26465;&#37117;&#33021;&#21040;&#36798;&#30446;&#26631;&#65292;&#36873;&#25321;metric&#65292;&#27809;&#26377;&#21152;&#32593;&#20851;&#21487;&#20197;&#35748;&#20026;&#19982;&#30446;&#26631;&#22312;&#19968;&#20010;&#32593;&#27573;&#20869;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#36335;&#30001;&#65292;&#32593;&#20851;&#65306;172.16.0.1</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#36335;&#30001;&#21363;&#26410;&#30693;&#32593;&#32476;&#65292;&#19981;&#30693;&#36947;&#30340;&#36335;&#30001;&#25353;&#40664;&#35748;&#36335;&#30001;&#30340;&#36335;&#24452;&#36208;</span>
route add -net 0.0.0.0 netmask 0.0.0.0 gw 172.16.0.1 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#24335;1 &#20256;&#32479;&#24418;&#24335;</span>
route add -net 0.0.0.0/0 gw 172.16.0.1 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#24335;2 CIDR&#34920;&#31034;&#27861;</span>
route add default gw 172.16.0.1 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#24335;3 &#25512;&#33616;&#20889;&#27861;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#20027;&#26426;&#36335;&#30001;&#26465;&#30446; &#30446;&#26631;&#65306;192.168.1.3 &#32593;&#20851;&#65306;172.16.0.1</span>
route del -host 192.168.1.3

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#32593;&#32476;&#36335;&#30001;&#26465;&#30446; &#30446;&#26631;&#65306;192.168.0.0 &#32593;&#20851;&#65306;172.16.0.1</span>
route del -net 192.168.0.0 netmask 255.255.255.0 gw 172.16.0.1
route del -net 192.168.0.0/24 gw 172.16.0.1
</pre>
</div>

<p>
<b>范例：实现静态路由</b> 环境：
</p>

<div class="org-src-container">
<pre class="src src-sh">&#22235;&#21488;&#20027;&#26426;&#65306;
A --NAT-- R1 --net1-- R2 --net0-- B

A&#20027;&#26426;&#65306;
eth0 10.0.0.123/8 NAT&#27169;&#24335; Gw 10.0.0.200

R1&#20027;&#26426;&#65306;
eth0 10.0.0.200/8 NAT&#27169;&#24335;
eth1 192.168.0.200/24 &#20165;&#20027;&#26426;&#27169;&#24335;

R2&#20027;&#26426;&#65306;
eth0 172.16.0.200/16 &#26725;&#25509;&#27169;&#24335;
eth1 192.168.0.201/24 &#20165;&#20027;&#26426;&#27169;&#24335;

B&#20027;&#26426;&#65306;
eth0 172.16.0.123/16 &#26725;&#25509;&#27169;&#24335; Gw 172.16.0.200 
</pre>
</div>


<figure id="org9e9c96c">
<img src="images/image-20210126192951134.png" alt="image-20210126192951134.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;A&#20027;&#26426;</span>
ifconfig eth0 10.0.0.123/8
route add -net 10.0.0.0/8 dev eth0  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#36830;&#36335;&#30001;&#19981;&#29992;&#31649;&#65292;&#20250;&#33258;&#21160;&#29983;&#25104;</span>
route add default gw 10.0.0.200 dev eth0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;R1</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ifconfig eth0 10.0.0.200/8</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ifconfig eth1 192.168.0.200/24</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#20889;&#21040;&#25991;&#20214;&#20013;</span>
cat &gt; ifcfg-eth0
<span style="color: #a0522d;">DEVICE</span>=eth0
<span style="color: #a0522d;">NAME</span>=eth0
<span style="color: #a0522d;">BOOTPROTO</span>=static
<span style="color: #a0522d;">IPADDR</span>=10.0.0.200
<span style="color: #a0522d;">PREFIX</span>=8
<span style="color: #a0522d;">ONBOOT</span>=yes
cat &gt; ifcfg-eth1
<span style="color: #a0522d;">DEVICE</span>=eth1
<span style="color: #a0522d;">NAME</span>=eth1
<span style="color: #a0522d;">BOOTPROTO</span>=static
<span style="color: #a0522d;">IPADDR</span>=192.168.0.200
<span style="color: #a0522d;">PREFIX</span>=24
<span style="color: #a0522d;">ONBOOT</span>=yes

service restart network

route add -net 10.0.0.0/8 dev eth0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#36830;&#36335;&#30001;&#19981;&#29992;&#31649;&#65292;&#20250;&#33258;&#21160;&#29983;&#25104;</span>
route add -net 192.168.0.0/24 dev eth1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#36830;&#36335;&#30001;&#19981;&#29992;&#31649;&#65292;&#20250;&#33258;&#21160;&#29983;&#25104;</span>
route add -net 172.16.0.0/16 gw 192.168.0.201 dev eth1
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27491;&#24120;&#32593;&#21345;&#30475;&#21040;&#25968;&#25454;&#25253;&#25991;&#65292;&#26159;&#33258;&#24049;&#30340;&#23601;&#25509;&#25910;&#65292;&#19981;&#26159;&#23601;&#25243;&#24323;&#12290;&#25152;&#20197;&#38656;&#35201;&#21152;&#36716;&#21457;&#65292;&#36716;&#21457;&#25968;&#25454;&#25253;&#25991;</span>
<span style="color: #483d8b;">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;R2</span>
ifconfig eth0 172.16.0.200/16
ifconfig eth1 192.168.0.201/24 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#36830;&#36335;&#30001;&#19981;&#29992;&#31649;&#65292;&#20250;&#33258;&#21160;&#29983;&#25104;</span>
route add -net 192.168.0.0/24 dev eth1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#36830;&#36335;&#30001;&#19981;&#29992;&#31649;&#65292;&#20250;&#33258;&#21160;&#29983;&#25104;</span>
route add -net 172.16.0.0/16 dev eth0
route add -net 10.0.0.0/8 gw 10.0.0.200 dev eth1
<span style="color: #483d8b;">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;B</span>
ifconfig eth0 172.16.0.123/16
route add -net 172.16.0.0/16 dev eth0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#36830;&#36335;&#30001;&#19981;&#29992;&#31649;&#65292;&#20250;&#33258;&#21160;&#29983;&#25104;</span>
route add default gw 172.16.0.200 dev eth0


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">1.&#30830;&#20445;&#30452;&#36830;&#32593;&#32476;&#33021;&#36890;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">2.A ping B &#19981;&#36890;&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312; r1 &#19978; tcpdump -i eth0 -nn icmp &#26377;&#21457;&#32473; b &#30340;&#21253;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312; r1 &#19978; tcpdump -i eth1 -nn icmp &#27809;&#26377;&#21457;&#32473; b &#30340;&#21253;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#26159;&#22240;&#20026;&#27809;&#26377;&#35774;&#32622;&#36335;&#30001;&#36716;&#21457;&#65292;&#40664;&#35748;&#36335;&#30001;&#22120;&#33258;&#21160;&#24320;&#21551;&#36716;&#21457;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;r1 &#21644; r2 &#24320;&#21551;&#36335;&#30001;&#36716;&#21457; echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">3.A &#36861;&#36394;&#36335;&#30001; </span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">mtr 172.16.0.123</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">tracepath 172.16.0.123</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">traceroute 172.16.0.123</span>
</pre>
</div>

<p>
范例：多路由实现
</p>


<figure id="org88bb883">
<img src="images/image-20210126193018670.png" alt="image-20210126193018670.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-sh">3&#20010;&#36335;&#30001;&#22120;&#12289;2 &#20010;&#20132;&#25442;&#26426;&#25226;&#23458;&#25143;&#26426; A B &#36830;&#25509;&#21040;&#32593;&#32476;&#20013;&#65292;&#21516;&#26102;&#20132;&#25442;&#26426;&#36830;&#25509;&#30528;&#36335;&#30001;&#22120;&#12290;
&#20998;&#21035;&#22312; 3 &#20010;&#36335;&#30001;&#22120;&#19978;&#37197;&#32622;&#36335;&#30001;&#34920;
R1 &#30452;&#36830;&#30340;&#32593;&#27573;&#65306;&#21040; A 172.16.0.0/16&#65292;&#21040; R2 eth0 172.18.0.0/16
R2 &#30452;&#36830;&#30340;&#32593;&#27573;&#65306;&#21040; R1 eth1 172.18.0.0/16&#65292;&#21040; R3 eth0 172.20.0.0/16
R3 &#30452;&#36830;&#30340;&#32593;&#27573;&#65306;&#21040; B 172.22.0.0/16&#65292;&#21040; R2 eth1 172.20.0.0/16
&#30452;&#36830;&#32593;&#32476;&#30340;&#36335;&#30001;&#26159;&#19981;&#29992;&#28155;&#21152;&#30340;&#65292;&#20250;&#33258;&#21160;&#28155;&#21152;

&#28155;&#21152;&#38750;&#30452;&#36830;&#36335;&#30001;&#65306;
<span style="color: #b22222;">#</span><span style="color: #b22222;">R1</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#36830;&#32593;&#27573;&#19981;&#29992;&#31649;&#65292;&#28155;&#21152;&#19981;&#30452;&#36830;&#30340;&#32593;&#27573;</span>
route add -net 172.20.0.0/16 gw 172.18.0.201 dev eth1
route add -net 172.22.0.0/16 gw 172.18.0.201 dev eth1
route add default gw 172.18.0.201 dev eth1


<span style="color: #b22222;">#</span><span style="color: #b22222;">R2</span>
route add -net 172.16.0.0/16 gw 172.18.0.200 dev eth0
route add -net 172.22.0.0/16 gw 172.20.0.201 dev eth1


<span style="color: #b22222;">#</span><span style="color: #b22222;">R3</span>
route add default gw 172.20.0.200 dev eth0
</pre>
</div>

<p>
实验时同网络的网卡在一个vmware虚拟网段
</p>


<figure id="orgf8b1ae5">
<img src="images/image-20210131083541306.png" alt="image-20210131083541306.png" width="50%">

</figure>

<p>
上图A访问B
</p>

<div class="org-src-container">
<pre class="src src-sh">&#26816;&#26597;&#36807;&#31243;&#65306;
&#20174;A ping B &#19981;&#36890;
&#26816;&#26597; R1 eth0&#26377;&#25509;&#25910;&#21040;ping&#65292; &#20294;R1 eth1 &#27809;&#36716;&#21457;&#20986;&#21435;
tcpdump -i eth0 -nn icmp <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26377;</span>
tcpdump -i eth0 -nn icmp <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27809;&#26377;&#36716;&#21457;&#21040;B&#30340;ping&#21253;</span>
&#35299;&#20915;&#65306;# &#27491;&#24120;&#32593;&#21345;&#30475;&#21040;&#25968;&#25454;&#25253;&#25991;&#65292;&#26159;&#33258;&#24049;&#30340;&#23601;&#25509;&#25910;&#65292;&#19981;&#26159;&#23601;&#25243;&#24323;&#12290;&#25152;&#20197;&#38656;&#35201;&#22312;&#36335;&#30001;&#22120;&#19978;&#21152;&#36716;&#21457;&#65292;&#36716;&#21457;&#25968;&#25454;&#25253;&#25991;
[root@router ~]#echo 1 &gt; /proc/sys/net/ipv4/ip_forward
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36319;&#36394;&#19968;&#19979;&#36335;&#30001;</span>
traceroute 172.22.0.100 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24930;</span>
tracepath 172.22.0.100 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24930;</span>
mtr 172.22.0.100  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27604;traceroute&#24555;&#20123;</span>
</pre>
</div>


<figure id="org40dcf2f">
<img src="images/image-20210131174900499.png" alt="image-20210131174900499.png" width="50%">

</figure>


<figure id="org83593c6">
<img src="images/image-20210131175109137.png" alt="image-20210131175109137.png" width="50%">

</figure>

<p>
范例：单臂路由
</p>

<p>
A B 用同一个交换机，各自在不同网段
</p>

<p>
由于AB在不同网段，通信过程不走ARP协议，所以无法连通。解决方法底层使用路由解决
</p>


<figure id="org881c19e">
<img src="images/image-20210131184146415.png" alt="image-20210131184146415.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;1 &#28155;&#21152;&#19968;&#20010;&#36335;&#30001;&#35774;&#22791;&#65292;&#24418;&#25104;&#21333;&#33218;&#36335;&#30001;</span>
R1:
ip a a 7.7.7.200/24 dev eth0:7
ip a a 8.8.8.200/24 dev eth0:8
<span style="color: #483d8b;">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward
A:
ip route add default via 7.7.7.200 
B:
ip route add default via 8.8.8.200 
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;2 &#26412;&#22320;&#35774;&#32622;&#40664;&#35748;&#32593;&#20851;&#65292;&#35753;&#20854;&#33021;&#21457;ARP&#21327;&#35758;</span>
ip route add default dev eth0 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27809;&#26377;&#25351;&#23450;&#32593;&#20851;&#65292;&#21482;&#35201;&#26159;&#26410;&#30693;&#32593;&#27573;&#23601;&#34892;eth0&#21457;&#20986;&#21435;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fde2884a-b662-4ee8-ba7e-614f6dc361b3" class="outline-4">
<h4 id="h:fde2884a-b662-4ee8-ba7e-614f6dc361b3">配置动态路由</h4>
<div class="outline-text-4" id="text-h:fde2884a-b662-4ee8-ba7e-614f6dc361b3">
<p>
在大型网络中，手动配置路由不现实
</p>

<p>
通过守护进程获取动态路由，安装 quagga 包,通过命令 vtysh 配置
</p>

<p>
支持多种路由协议：
</p>

<ul class="org-ul">
<li>RIP：Routing Information Protocol，路由信息协议</li>
<li>OSPF：Open Shortest Path First，开放式最短路径优先，会考虑带宽(企业内部用的比较多)</li>
<li>BGP：Border Gateway Protocol，边界网关协议 （互联网用的比较多）</li>
</ul>
</div>
</div>
<div id="outline-container-h:88978386-ca24-4adc-81ed-15afc6a927e7" class="outline-4">
<h4 id="h:88978386-ca24-4adc-81ed-15afc6a927e7">netstat命令</h4>
<div class="outline-text-4" id="text-h:88978386-ca24-4adc-81ed-15afc6a927e7">
<p>
来自于net-tools包，建议使用 ss 代替
</p>

<p>
显示网络连接：
</p>

<div class="org-src-container">
<pre class="src src-sh">netstat [--tcp|-t] [--udp|-u] [--raw|-w] [--listening|-l] [--all|-a] [--
numeric|-n] [--extend|-e[--extend|-e]] [--program|-p]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24120;&#29992;&#36873;&#39033;</span>
-A                      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#32593;&#32476;&#31867;&#22411; inet|inet6|unix|ipx|ax25|netrom|econet|ddp|bluetooth</span>
-t|--tcp                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;tcp&#31471;&#21475;&#25968;&#25454;</span>
-u|--udp                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;udp&#31471;&#21475;&#25968;&#25454;</span>
-w|--raw                <span style="color: #b22222;">#</span><span style="color: #b22222;">raw socket&#30456;&#20851;</span>
-l|--listening          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20165;&#26174;&#31034;&#22788;&#20110;&#30417;&#21548;&#29366;&#24577;&#30340;&#31471;&#21475;</span>
-a|--all                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#29366;&#24577;</span>
-n|--numeric            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#25968;&#23383;&#26174;&#31034;IP&#21644;&#31471;&#21475;</span>
-s|--statistice         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#32479;&#35745;&#25968;&#25454;</span>
-e|                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25193;&#23637;&#26684;&#24335;</span>
-p|--program            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#30456;&#20851;&#36827;&#31243;&#21450;PID</span>
-x|--unix               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516; -A unix</span>
-ip|--inet              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516; -A</span>
-I|--interfaces=&lt;Iface&gt; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#35774;&#22791;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24120;&#29992;&#32452;&#21512;&#65306;</span>
-tan, -uan, -tnl, -unl
</pre>
</div>

<p>
范例：显示路由表：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;IP&#26684;&#24335;&#26174;&#31034;&#36335;&#30001;&#34920;</span>
[root@test ~]# netstat -nr
Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
0.0.0.0         10.0.129.1      0.0.0.0         UG        0 0          0 ens5
10.0.0.2        10.0.129.1      255.255.255.255 UGH       0 0          0 ens5
10.0.129.0      0.0.0.0         255.255.255.0   U         0 0          0 ens5
10.0.129.1      0.0.0.0         255.255.255.255 UH        0 0          0 ens5
172.17.0.0      0.0.0.0         255.255.0.0     U         0 0          0 docker0
</pre>
</div>

<p>
范例：如何查看哪个程序在监听端口
</p>
<div class="org-src-container">
<pre class="src src-sh">netstat -tunlp |grep <span style="color: #8b2252;">":22"</span>
ss -tnulp |grep <span style="color: #8b2252;">":22"</span>
lsof -i :22
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c364cc23-387a-4a95-a359-47373557edc0" class="outline-4">
<h4 id="h:c364cc23-387a-4a95-a359-47373557edc0">显示接口统计数据</h4>
<div class="outline-text-4" id="text-h:c364cc23-387a-4a95-a359-47373557edc0">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#32479;&#35745;&#25152;&#26377;&#32593;&#21345;&#20449;&#24687;</span>
netstat -i|ifconfig -s |cat /proc/net/dev

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32479;&#35745;&#25152;&#26377;&#25351;&#23450;&#20449;&#24687;</span>
netstat -Ieth0|netstat -I=eth0|ifconfig -s eth0| {cat /proc/net/dev |grep eth0}
</pre>
</div>

<p>
范例:显示接口的统计数据
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">netstat -Ieth0</span>
Kernel Interface table
Iface             MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg
eth0             1500 1098450850      0     52 0       2805717      0      0      0 BMRU

<span style="color: #b22222;"># </span><span style="color: #b22222;">ifconfig -s eth0</span>
Iface      MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg
eth0             1500 1098453216      0     52 0       2805757      0      0      0 BMRU

[root@centos8 ~]#netstat -nt
Active Internet connections (w/o servers)
Proto Recv-Q Send-Q Local Address                     Foreign Address                 State         
tcp     0    52 10.0.0.8:22                10.0.0.1:4927                     ESTABLISHED
Proto&#65306;&#21327;&#35758;
Recv-Q&#65306;&#25509;&#25910;&#38431;&#21015;&#38271;&#24230;
Send-Q&#65306;&#21457;&#36865;&#38431;&#21015;&#38271;&#24230;
Local Address&#65306;&#26412;&#26426;&#22320;&#22336;
Foreign Address&#65306;&#36828;&#31243;&#22320;&#22336;
State&#65306;&#29366;&#24577;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1b405a1a-a7a3-4435-98df-daa9f41edd40" class="outline-4">
<h4 id="h:1b405a1a-a7a3-4435-98df-daa9f41edd40">ip命令</h4>
<div class="outline-text-4" id="text-h:1b405a1a-a7a3-4435-98df-daa9f41edd40">
<p>
来自于iproute包，可用于代替ifconfig
</p>

<p>
后面有很多子命令形成工具集的功能。
</p>

<p>
<b>ip 命令说明：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@test ~]# ip --help
Usage: ip [ OPTIONS ] OBJECT { COMMAND | <span style="color: #483d8b;">help</span> }
       ip [ -force ] -batch filename
where  OBJECT := { link | address | addrlabel | route | rule | neigh | ntable |
                   tunnel | tuntap | maddress | mroute | mrule | monitor | xfrm |
                   netns | l2tp | fou | macsec | tcp_metrics | token | netconf | ila |
                   vrf | sr | nexthop | mptcp }
       OPTIONS := { -V[ersion] | -s[tatistics] | -d[etails] | -r[esolve] |
                    -h[uman-readable] | -iec | -j[son] | -p[retty] |
                    -f[amily] { inet | inet6 | mpls | bridge | link } |
                    -4 | -6 | -I | -D | -M | -B | -0 |
                    -l[oops] { maximum-addr-flush-attempts } | -br[ief] |
                    -o[neline] | -t[imestamp] | -ts[hort] | -b[atch] [filename] |
                    -rc[vbuf] [size] | -n[etns] name | -N[umeric] | -a[ll] |
                    -c[olor]}


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35828;&#26126;&#65306;</span>
OBJECT := { link | addr | route | netns  }&#31649;&#29702;&#23545;&#35937;

ip link     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#22791;&#31649;&#29702;</span>
ip address  <span style="color: #b22222;">#</span><span style="color: #b22222;">ip&#22320;&#22336;&#31649;&#29702;</span>
ip route    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31649;&#29702;&#31649;&#29702;</span>
ip netns    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;&#21517;&#31216;&#31354;&#38388;&#31649;&#29702;</span>
ip tuntap   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#34394;&#25311;&#32593;&#32476;&#35774;&#22791;</span>
</pre>
</div>

<p>
注意： OBJECT可简写，各OBJECT的子命令也可简写；
</p>

<p>
帮助
</p>
<div class="org-src-container">
<pre class="src src-sh">ip l help <span style="color: #b22222;">#</span><span style="color: #b22222;">man ip-link</span>
ip a help <span style="color: #b22222;">#</span><span style="color: #b22222;">man ip-address</span>
ip r help <span style="color: #b22222;">#</span><span style="color: #b22222;">man ip-route</span>
ip ru help <span style="color: #b22222;">#</span><span style="color: #b22222;">man ip-rule</span>
</pre>
</div>

<p>
查看
</p>
<div class="org-src-container">
<pre class="src src-sh">ip link
ip a
ip route
</pre>
</div>
</div>
<div id="outline-container-h:4288a615-400b-4867-a4bc-207eda01a3ec" class="outline-5">
<h5 id="h:4288a615-400b-4867-a4bc-207eda01a3ec">ip link 网络设备配置</h5>
<div class="outline-text-5" id="text-h:4288a615-400b-4867-a4bc-207eda01a3ec">
<div class="org-src-container">
<pre class="src src-sh">[root@af ~]# ip link 
add     delete  help    set     show 
</pre>
</div>
</div>
<ul class="org-ul">
<li><a id="h:d5ac7a4c-9848-407e-b563-0ac967a0c244"></a>ip link add 增加网络设备<br>
<div class="outline-text-6" id="text-h:d5ac7a4c-9848-407e-b563-0ac967a0c244">
<div class="org-src-container">
<pre class="src src-sh">       ip link add [ link DEVICE ] [ name ] NAME
               <span style="color: #483d8b;">type</span> TYPE [ ARGS ]
   ip link add - add virtual link
       link DEVICE
              specifies &#25191;&#34892;&#25805;&#20316;&#30340;&#29289;&#29702;&#35774;&#22791;&#12290;
              NAME &#25351;&#23450;&#26032;&#34394;&#25311;&#35774;&#22791;&#30340;&#21517;&#31216;&#12290;
              TYPE &#25351;&#23450;&#26032;&#35774;&#22791;&#30340;&#31867;&#22411;&#12290;
              Link types:
                      bridge - &#20197;&#22826;&#32593;&#26725;&#25509;&#35774;&#22791;
                      bond - Bonding device
                      dummy - &#34394;&#25311;&#32593;&#32476;&#25509;&#21475;
                      hsr - &#39640;&#21487;&#29992;&#24615;&#26080;&#32541;&#20887;&#20313;&#35774;&#22791;
                      ifb - &#20013;&#32423;&#21151;&#33021;&#22359;&#35774;&#22791;
                      ipoib - Infiniband &#35774;&#22791;&#19978;&#30340; IP
                      macvlan - &#22522;&#20110;&#38142;&#36335;&#23618;&#22320;&#22336;&#30340;&#34394;&#25311;&#25509;&#21475;(MAC)
                      macvtap - &#22522;&#20110;&#38142;&#36335;&#23618;&#22320;&#22336;&#30340;&#34394;&#25311;&#25509;&#21475;(MAC) and TAP.
                      vcan - &#34394;&#25311;&#25511;&#21046;&#22120;&#23616;&#22495;&#32593;&#25509;&#21475;
                      vxcan - &#34394;&#25311;&#25511;&#21046;&#22120;&#23616;&#22495;&#32593;&#38567;&#36947;&#25509;&#21475;
                      veth - &#34394;&#25311;&#20197;&#22826;&#32593;&#25509;&#21475;
                      vlan - 802.1q tagged virtual LAN interface
                      vxlan - &#34394;&#25311;&#25193;&#23637;&#23616;&#22495;&#32593;
                      ip6tnl - Virtual tunnel interface IPv4|IPv6 over IPv6
                      ipip - &#34394;&#25311;&#38567;&#36947;&#25509;&#21475; IPv4 over IPv4
                      sit - Virtual tunnel interface IPv6 over IPv4
                      gre - IPv4 &#19978;&#30340;&#34394;&#25311;&#38567;&#36947;&#25509;&#21475; GRE
                      gretap - Virtual L2 tunnel interface GRE over IPv4
                      erspan - Encapsulated Remote SPAN over GRE and IPv4
                      ip6gre - Virtual tunnel interface GRE over IPv6
                      ip6gretap - Virtual L2 tunnel interface GRE over IPv6
                      ip6erspan - Encapsulated Remote SPAN over GRE and IPv6
                      vti - &#34394;&#25311;&#38567;&#36947;&#25509;&#21475;
                      nlmon - Netlink &#30417;&#25511;&#35774;&#22791;
                      ipvlan - Interface for L3 (IPv6/IPv4) based VLANs
                      ipvtap - Interface for L3 (IPv6/IPv4) based VLANs and TAP
                      lowpan - Interface for 6LoWPAN (IPv6) over IEEE 802.15.4 / Bluetooth
                      geneve - GEneric NEtwork Virtualization Encapsulation
                      bareudp - Bare UDP L3 encapsulation support
                      macsec - IEEE 802.1AE MAC &#23433;&#20840;&#25509;&#21475;(MACsec)
                      vrf - L3 VRF &#22495;&#30340;&#25509;&#21475;
                      netdevsim - Netdev API &#27979;&#35797;&#25509;&#21475;
                      rmnet - &#39640;&#36890; rmnet &#35774;&#22791;
                      xfrm - &#34394;&#25311; xfrm &#25509;&#21475;


ip link add DEVICE type { veth | vxcan } [ peer name NAME ]       
ip link add link DEVICE name NAME type { macvlan | macvtap } mode { private | vepa | bridge | passthru  [ nopromisc ] | <span style="color: #483d8b;">source</span> }
ip link add DEVICE type bridge [ stp_state STP_STATE ] ...
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#29289;&#29702;&#30452;&#36830;&#32593;&#21345;&#65292;&#26725;&#25509;&#27169;&#24335;</span>
ip link add link eth0  xu-macvtap0 type macvtap mode bridge
<span style="color: #b22222;">#</span><span style="color: #b22222;">ip link set macvtap0 address 1a:2b:3c:4d:5e:6a up </span>
ip link set  xu-macvtap0  up
ip link show type macvtap
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;kvm&#34394;&#25311;&#26426;&#32593;&#21345;</span>


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#34394;&#25311;&#32593;&#21345;mytap01&#65292; &#37197;&#32622;&#19978;IP&#24182;&#28608;&#27963;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">tunctl -u `whoami` -t $1</span>
ip tuntap add mytap01  mode tap user <span style="color: #ff00ff;">`whoami`</span> &amp;&amp; ip link set hd1 up
ip addr add 10.100.21.134/32 dev mytap01
ip tuntap show

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#26725;</span>
<span style="color: #a0522d;">br</span>=<span style="color: #8b2252;">"br-in"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">brctl addbr $switch &amp;&amp; brctl stp $switch on</span>
ip link add $<span style="color: #a0522d;">br</span> type bridge stp_state 1 &amp;&amp; ip link set $<span style="color: #a0522d;">br</span> up
ip link show type bridge

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#32852;&#26725;</span>
ip link set mytap01 master $<span style="color: #a0522d;">br</span>
ip addr flush dev mytap01 &amp;&amp; ip addr add 10.100.21.134/32  dev $<span style="color: #a0522d;">br</span> &amp;&amp; ip link set $<span style="color: #a0522d;">br</span> up
ip link show master $<span style="color: #a0522d;">br</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#32593;&#21345;&#23545;</span>
ip link add veth1.0 type veth peer name veth1.1  
<span style="color: #b22222;">#</span><span style="color: #b22222;">VETH(&#34394;&#25311;&#20197;&#22826;&#32593;&#32593;&#21345;)&#35774;&#22791;&#26159;&#25104;&#23545;&#30340;&#65292;&#20004;&#20010;&#35774;&#22791;&#38388;&#25968;&#25454;&#26159;&#20114;&#36890;&#30340;&#65292;&#21069;&#38754;&#26159;&#31532;1&#27573;&#21518;&#38754;&#26159;&#31532;2&#27573;&#12290;</span>
</pre>
</div>
</div>
</li>
<li><a id="h:311df09c-a4fc-4574-bfe5-f1aec3cced3f"></a>ip link set 修改设备属性<br>
<div class="outline-text-6" id="text-h:311df09c-a4fc-4574-bfe5-f1aec3cced3f">
<p>
类似于ifconfig命令功能
</p>

<div class="org-src-container">
<pre class="src src-sh">dev NAME (default)                      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#26126;&#35201;&#31649;&#29702;&#30340;&#35774;&#22791;&#65292;dev&#20851;&#38190;&#23383;&#21487;&#30465;&#30053;&#65307;</span>
up&#21644;down                                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28608;&#27963;&#25110;&#31105;&#29992;&#25351;&#23450;&#25509;&#21475;&#65292;&#30456;&#24403;&#20110; ifup/ifdown</span>
multicast on or multicast off           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#25110;&#31105;&#29992;&#22810;&#25773;&#21151;&#33021;&#65307;</span>
name NAME                               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21629;&#21517;&#25509;&#21475;</span>
mtu NUMBER                              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;MTU&#30340;&#22823;&#23567;&#65292;&#40664;&#35748;&#20026;1500&#65307;</span>
netns PID                               <span style="color: #b22222;">#</span><span style="color: #b22222;">ns&#20026;namespace&#65292;&#29992;&#20110;&#23558;&#25509;&#21475;&#31227;&#21160;&#21040;&#25351;&#23450;&#30340;&#32593;&#32476;&#21517;&#31216;&#31354;&#38388;&#65307;&#21482;&#33021;CentOS 7 &#19978;&#20570;&#65307;</span>
promisc { on | off }                    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#24320;&#21551;&#28151;&#26434;&#27169;&#24335;</span>
master DEVICE                           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#35774;&#22791;&#30340;&#20027;&#35774;&#22791;&#65288;&#20174;&#23646;&#35774;&#22791;&#65289;&#12290;</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#29992;&#32593;&#21345;</span>
ip link set eth1 down

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#21345;&#25913;&#21517;</span>
ip link set eth1 name wangnet 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#32593;&#21345;</span>
ip link set wangnet up
</pre>
</div>
</div>
</li>
<li><a id="h:79817b63-21ef-4dce-a01c-18f65d105a8a"></a>ip link show 显示二层设备属性<br>
<div class="outline-text-6" id="text-h:79817b63-21ef-4dce-a01c-18f65d105a8a">
<p>
也可以 ip  link  list显示
</p>
<div class="org-src-container">
<pre class="src src-sh">show [dev IFACE] [up] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#25509;&#21475; &#65292;up &#20165;&#26174;&#31034;&#22788;&#20110;&#28608;&#27963;&#29366;&#24577;&#30340;&#25509;&#21475;</span>
</pre>
</div>




<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">ip  link  show  &#26174;&#31034;&#20108;&#23618;&#35774;&#22791;&#23646;&#24615;</span>
[root@centos7 ~]# ip link show
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: eno16777736: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT qlen 1000
    link/ether 00:0c:29:fc:81:b2 brd ff:ff:ff:ff:ff:ff
qdisc&#65306;&#38431;&#21015;
pfifo_fast &#65306;&#38431;&#21015;&#31867;&#22411;pfifo_fast &#20808;&#36827;&#20808;&#20986;&#38431;&#21015;
state UP&#65306;&#29366;&#24577;
mode DEFAULT qlen 1000&#65306;&#25903;&#25345;&#30340;&#38431;&#21015;&#38271;&#24230;

<span style="color: #b22222;"># </span><span style="color: #b22222;">ip  link  set &#20462;&#25913;&#35774;&#22791;&#23646;&#24615;&#20851;&#25481;&#22810;&#25773;&#65306;</span>
[root@centos7 ~]# ip link set eno16777736 multicast off
[root@centos7 ~]# ip link show
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: eno16777736: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT qlen 1000
    link/ether 00:0c:29:fc:81:b2 brd ff:ff:ff:ff:ff:ff
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:8a3fa4c8-88b7-4570-b3ac-bf3ca1c53a6d" class="outline-5">
<h5 id="h:8a3fa4c8-88b7-4570-b3ac-bf3ca1c53a6d">ip 地址管理</h5>
<div class="outline-text-5" id="text-h:8a3fa4c8-88b7-4570-b3ac-bf3ca1c53a6d">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1. ip&#22320;&#22336;&#30340;&#28155;&#21152;&#21644;&#22320;&#22336;&#21024;&#38500;</span>
ip addr { add | del } IFADDR dev STRING [label LABEL] [scope {global|link|host}] [broadcast ADDRESS]

[label LABEL]&#65306;&#28155;&#21152;&#22320;&#22336;&#26102;&#25351;&#26126;&#32593;&#21345;&#21035;&#21517;
[scope {global|link|host}]&#65306;&#25351;&#26126;&#20316;&#29992;&#22495;,global: &#20840;&#23616;&#21487;&#29992;.link: &#20165;&#38142;&#25509;&#21487;&#29992;,host: &#26412;&#26426;&#21487;&#29992;
[broadcast ADDRESS]&#65306;&#25351;&#26126;&#24191;&#25773;&#22320;&#22336;

<span style="color: #b22222;"># </span><span style="color: #b22222;">2. ip&#22320;&#22336;&#26597;&#30475;</span>
ip address show &#25110; ip addr list

<span style="color: #b22222;"># </span><span style="color: #b22222;">3. ip&#22320;&#22336;&#28165;&#31354;</span>
ip addr flush 
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#21345;&#21035;&#21517;</span>
ip addr add 172.16.100.100/16 dev eth0 label eth0:0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;ip</span>
ip addr del 172.16.100.100/16 dev eth0 label eth0:0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#38500;&#32593;&#21345;&#19978;&#25152;&#26377;IP&#22320;&#22336;</span>
ip addr flush dev eth0
</pre>
</div>

<p>
范例：网卡生命周期
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;ip&#65292; 30s&#29983;&#21629;&#21608;&#26399;,  ip&#24050;&#23384;&#22312;&#33258;&#21160;&#28155;&#21152;&#29983;&#21629;&#21608;&#26399;</span>
ip a change 10.0.0.137/24 dev eth1 preferred_lft 30 valid_lft 30

ip a s eth1
2: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 0a:94:e4:15:43:75 brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    altname eni-0e0895d76178caece
    altname device-number-0.0
    inet 10.0.0.137/24 metric 512 brd 10.0.0.255 scope global dynamic ens5
       valid_lft 27sec preferred_lft 27sec  <span style="color: #b22222;">#</span><span style="color: #b22222;">forver &#27704;&#20037;&#26377;&#25928;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">30s&#21518;&#65292;ip&#33258;&#21160;&#21024;&#38500;i</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2d272223-d150-42aa-bd6d-df6b5b067bc3" class="outline-5">
<h5 id="h:2d272223-d150-42aa-bd6d-df6b5b067bc3">管理路由</h5>
<div class="outline-text-5" id="text-h:2d272223-d150-42aa-bd6d-df6b5b067bc3">
<p>
ip route 用法
</p>

<p>
相对于route输出的格式化，ip route显示的内容可以将已生成的规则可以直接
复制使用。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#36335;&#30001;&#65306;</span>
ip route add TARGET via GW dev IFACE src SOURCE_IP
    TARGET:
        &#20027;&#26426;&#36335;&#30001;&#65306;IP
        &#32593;&#32476;&#36335;&#30001;&#65306;NETWORK/MASK

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#32593;&#20851;&#65306;</span>
ip route add default via GW dev IFACE

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#36335;&#30001;&#65306;</span>
ip route del TARGET
ip route del <span style="color: #ff00ff;">`ip route |tail -1`</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#36335;&#30001;&#65306;</span>
ip route show|list

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#31354;&#36335;&#30001;&#34920;&#65306;</span>
ip route flush [dev IFACE] [via PREFIX]

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26367;&#25442;&#36335;&#30001;</span>
ip route replace TARGET via GW dev IFACE src SOURCE_IP
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">ip route add 192.168.0.0/24 via 172.16.0.1
ip route add 192.168.1.100 via 172.16.0.1
ip route add 192.168.3.0/24 via 10.0.0.1 dev eth0 src 10.0.20.100 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#36335;&#30001;&#65292;&#25351;&#26126;&#20174;&#25509;&#21475;&#37027;&#20010;ip&#20986;&#21435;</span>
ip route add default via 172.16.0.1
ip route flush dev eth0
</pre>
</div>
</div>
</div>
<div id="outline-container-h:421be196-3790-4249-b2af-3df7b4797fa1" class="outline-5">
<h5 id="h:421be196-3790-4249-b2af-3df7b4797fa1">管理网络名称空间</h5>
<div class="outline-text-5" id="text-h:421be196-3790-4249-b2af-3df7b4797fa1">
<div class="org-src-container">
<pre class="src src-sh">ip  netns  list&#65306;&#21015;&#20986;&#25152;&#26377;&#30340;netns
ip  netns  add  NAME&#65306;&#21019;&#24314;&#25351;&#23450;&#30340;netns
ip  netns  del  NAME&#65306;&#21024;&#38500;&#25351;&#23450;&#30340;netns
ip  netns   exec  NAME  COMMAND&#65306;&#22312;&#25351;&#23450;&#30340;netns&#20013;&#36816;&#34892;&#21629;&#20196;
</pre>
</div>

<p>
范例：ip netns 管理网络名称空间
</p>

<div class="org-src-container">
<pre class="src src-sh">&#23558;&#25509;&#21475;&#31227;&#21160;&#21040;&#25351;&#23450;&#30340;&#32593;&#32476;&#21517;&#31216;&#31354;&#38388;
ip netns add mynet
ip link set eno16777736 netns mynet
ip netns exec mynet ip link show  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#34394;&#25311;&#32593;&#32476;&#20013;&#30340;&#20351;&#29992;&#21629;&#20196;&#26597;&#30475;</span>
ip netns del mynet   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#34394;&#25311;&#32593;&#32476;&#31354;&#38388;&#21518;&#65292;&#20854;&#37324;&#32593;&#21345;&#35774;&#22791;&#20063;&#23601;&#36824;&#21407;&#21407;&#20301;&#32622;&#20102;&#65307;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:696db829-a288-4298-b0bd-16e65726eb0d" class="outline-4">
<h4 id="h:696db829-a288-4298-b0bd-16e65726eb0d">ss 命令</h4>
<div class="outline-text-4" id="text-h:696db829-a288-4298-b0bd-16e65726eb0d">
<p>
来自于iproute包，代替netstat，netstat 通过遍历 /proc来获取socket信息，
ss 使用 netlink与内核tcp_diag 模块通信获取 socket 信息
</p>

<p>
格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">ss [OPTION]... [FILTER]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24120;&#29992;&#36873;&#39033;&#65306;</span>
-t: tcp&#21327;&#35758;&#30456;&#20851;
-u: udp&#21327;&#35758;&#30456;&#20851;
-w: &#35064;&#22871;&#25509;&#23383;&#30456;&#20851;
-x&#65306;unix sock&#30456;&#20851;
-l: listen&#29366;&#24577;&#30340;&#36830;&#25509;
-a: &#25152;&#26377;
-n: &#25968;&#23383;&#26684;&#24335;
-p: &#30456;&#20851;&#30340;&#31243;&#24207;&#21450;PID
-e: &#25193;&#23637;&#30340;&#20449;&#24687;
-m&#65306;&#20869;&#23384;&#29992;&#37327;
-o&#65306;&#35745;&#26102;&#22120;&#20449;&#24687;
&#36807;&#28388;&#22120;&#65306;&#21482;&#30475;&#26576;&#31181;&#29366;&#24577;&#30340;&#36830;&#25509;
</pre>
</div>

<p>
格式说明
</p>

<div class="org-src-container">
<pre class="src src-sh">FILTER : [ state TCP-STATE ] [ EXPRESSION ] &#29366;&#24577;&#36807;&#28388;&#21151;&#33021;
TCP&#30340;&#24120;&#35265;&#29366;&#24577;&#65306;
    tcp finite state machine:
        LISTEN: &#30417;&#21548;
        ESTABLISHED&#65306;&#24050;&#24314;&#31435;&#30340;&#36830;&#25509;
        FIN_WAIT_1
        FIN_WAIT_2
        SYN_SENT
        SYN_RECV
        CLOSED
established&#65306;&#20195;&#34920;&#19968;&#20010;&#25171;&#24320;&#30340;&#36830;&#25509;
syn-sent&#65306;&#20877;&#21457;&#36865;&#36830;&#25509;&#35831;&#27714;&#21518;&#31561;&#24453;&#21305;&#37197;&#30340;&#36830;&#25509;&#35831;&#27714;
syn-recv&#65306;&#20877;&#25910;&#21040;&#21644;&#21457;&#36865;&#19968;&#20010;&#36830;&#25509;&#35831;&#27714;&#21518;&#31561;&#24453;&#23545;&#26041;&#23545;&#36830;&#25509;&#35831;&#27714;&#30340;&#30830;&#35748;
fin-wait-1&#65306;&#31561;&#24453;&#36828;&#31243;TCP&#36830;&#25509;&#20013;&#26029;&#35831;&#27714;&#65292;&#25110;&#20808;&#21069;&#30340;&#36830;&#25509;&#20013;&#26029;&#35831;&#27714;&#30340;&#30830;&#35748;
fin-wait-2&#65306;&#20174;&#36828;&#31243;TCP&#31561;&#24453;&#36830;&#25509;&#20013;&#26029;&#35831;&#27714;
time-wait&#65306;&#31561;&#24453;&#36275;&#22815;&#30340;&#26102;&#38388;&#20197;&#30830;&#20445;&#36828;&#31243;TCP&#25509;&#25910;&#21040;&#36830;&#25509;&#20013;&#26029;&#35831;&#27714;&#30340;&#30830;&#35748;
closed:&#65306;&#27809;&#26377;&#20219;&#20309;&#36830;&#25509;&#29366;&#24577;
close-wait&#65306;&#31561;&#24453;&#20174;&#26412;&#22320;&#29992;&#25143;&#21457;&#26469;&#30340;&#36830;&#25509;&#20013;&#26029;&#35831;&#27714;
last-ack&#65306;&#31561;&#24453;&#21407;&#26469;&#30340;&#21457;&#21521;&#36828;&#31243;TCP&#30340;&#36830;&#25509;&#20013;&#26029;&#35831;&#27714;&#30340;&#30830;&#35748;
listen&#65306;&#20390;&#21548;&#26469;&#33258;&#36828;&#26041;&#30340;TCP&#31471;&#21475;&#30340;&#36830;&#25509;&#35831;&#27714;
closing&#65306;&#31561;&#24453;&#36828;&#31243;TCP&#23545;&#36830;&#25509;&#20013;&#26029;&#30340;&#30830;&#35748;

all : &#25152;&#26377;&#20197;&#19978;&#29366;&#24577;
connected : &#38500;&#20102;listen and closed&#30340;&#25152;&#26377;&#29366;&#24577;
synchronized :&#25152;&#26377;&#24050;&#36830;&#25509;&#30340;&#29366;&#24577;&#38500;&#20102;syn-sent
bucket : &#26174;&#31034;&#29366;&#24577;&#20026;maintained as minisockets,&#22914;&#65306;time-wait&#21644;syn-recv.
big : &#21644;bucket&#30456;&#21453;.

EXPRESSION:
    dport =
    sport =
</pre>
</div>

<p>
ss使用IP地址筛选
</p>

<p>
ss src ADDRESS_PATTERN
</p>

<p>
ss dst ADDRESS_PATTERN
</p>

<p>
src：表示来源
</p>

<p>
dst：表示目的
</p>

<p>
ADDRESS_PATTERN：表示地址规则
</p>

<p>
如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">ss src 120.33.31.1 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21015;&#20986;&#26469;&#20043;20.33.31.1&#30340;&#36830;&#25509; </span>
&#65283;&#12288;&#21015;&#20986;&#26469;&#33267;120.33.31.1,80&#31471;&#21475;&#30340;&#36830;&#25509;
ss src 120.33.31.1:http
ss src 120.33.31.1:80
</pre>
</div>

<p>
ss使用端口筛选
</p>

<p>
ss dport OP PORT 远程端口和一个数比较；ss sport OP PORT本地端口和一个
数比较。 OP 可以代表以下任意一个:
</p>

<div class="org-src-container">
<pre class="src src-sh">&lt;= or le : &#23567;&#20110;&#25110;&#31561;&#20110;&#31471;&#21475;&#21495;
&gt;= or ge : &#22823;&#20110;&#25110;&#31561;&#20110;&#31471;&#21475;&#21495;
== or eq : &#31561;&#20110;&#31471;&#21475;&#21495;
!= or ne : &#19981;&#31561;&#20110;&#31471;&#21475;&#21495;
&lt; or gt : &#23567;&#20110;&#31471;&#21475;&#21495;
&gt; or lt : &#22823;&#20110;&#31471;&#21475;&#21495;
</pre>
</div>

<p>
常用组合：
</p>

<div class="org-src-container">
<pre class="src src-sh">-tan, -tanl, -tanlp, -uan
</pre>
</div>

<p>
范例：常见用法
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;IP&#26684;&#24335;&#26174;&#31034;&#25152;&#26377;&#36830;&#25509;&#25968;&#25454;</span>
ss -n

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#25152;&#26377;TCP&#36830;&#25509;&#65292;&#27491;&#22788;&#20110;&#36830;&#25509;&#29366;&#24577;</span>
ss -pl

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#25152;&#26377;tcp&#36830;&#25509;</span>
ss -tan

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#25152;&#26377;&#22788;&#20110;&#30417;&#21548;&#29366;&#24577;&#30340;TCP, UDP&#36830;&#25509;&#65292;&#24182;&#26174;&#31034;&#31243;&#24207;&#21644;&#36827;&#31243;ID</span>
ss -tunlp

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#25152;&#26377;&#24050;&#24314;&#31435;&#30340;ssh&#36830;&#25509;</span>
ss -o state established <span style="color: #8b2252;">'( dport = :ssh or sport = :ssh )'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#25152;&#26377;&#24050;&#24314;&#31435;&#30340;HTTP&#36830;&#25509;</span>
ss -o state established <span style="color: #8b2252;">'( dport = :http or sport = :http )'</span>
[root@centos8 ~]#ss -no state established <span style="color: #8b2252;">'( dport = :21 or sport = :21 )'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#24403;&#21069;socket&#35814;&#32454;&#20449;&#24687;</span>
ss -s
</pre>
</div>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#38142;&#25509;&#29366;&#24577;&#26816;&#26597;&#65306;</span>
ss -ant | awk <span style="color: #8b2252;">'{name[$1]++}END{for(n in name)print n,name[n]}'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#35775;&#38382;IP</span>
ss -an | awk <span style="color: #8b2252;">'$NF ~ /.*:.*/{split($NF,A,":");a[A[1]]++}END{for(i in a) print i,a[i]}'</span> |grep  <span style="color: #8b2252;">'^[0-9]'</span> |sort -nr -k2,2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32467;&#21512;&#20135;&#21697;</span>
[root@hd-test-all-01 nhd_server]# netstat -n |grep <span style="color: #8b2252;">'^tcp'</span> |tail -n1
tcp        0      0 ::ffff:192.168.1.150:3306   ::ffff:192.168.1.150:40712  ESTABLISHED
[root@hd-test-all-01 nhd_server]# netstat -n |grep <span style="color: #8b2252;">'^tcp'</span> |head -n1
tcp        0      0 192.168.1.150:6379          192.168.1.150:46096         ESTABLISHED

[root@hd-test-all-01 nhd_server]# netstat -n | awk <span style="color: #8b2252;">'/^tcp/ {n=split($(</span><span style="color: #ff00ff;">NF-1</span><span style="color: #8b2252;">),array,":"); if(n&lt;=2) IP[array[1]]++; else IP[array[4]]++; stat[$NF]++; ++snum} END {for(i in IP){printf("%-20s %s\n", i, IP[i]); num++}printf("%-20s %s\n","TOTAL_IP",num); for(s in stat)printf("%-20s %s\n",s, stat[s]); printf("%-20s %s\n","TOTAL_LINK",snum);}'</span> |tail -n10
192.168.1.35         1
192.168.1.100        4
192.168.1.26         2
192.168.1.44         30
TOTAL_IP             36
TIME_WAIT            65
CLOSE_WAIT           1
FIN_WAIT2            5
ESTABLISHED          1138
TOTAL_LINK           1209
</pre>
</div>

<p>
拓展：netstat工作原理
</p>

<p>
<a href="https://www.cyub.vip/2020/11/22/Go%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0%E7%AE%80%E6%98%93%E7%89%88netstat%E5%91%BD%E4%BB%A4/">https://www.cyub.vip/2020/11/22/Go%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0%E7%AE%80%E6%98%93%E7%89%88netstat%E5%91%BD%E4%BB%A4/</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@game-ticket-job-798fc84d58-bd7r4 net]# ss -tnl
State      Recv-Q Send-Q                                            Local Address:Port                                                           Peer Address:Port
LISTEN     0      100                                                           *:10095                                                                     *:*
LISTEN     0      100                                                           *:18082                                                                     *:*
LISTEN     0      4096                                                          *:9993                                                                      *:*
[root@4 net]# cat /proc/net/tcp |head -n4
  sl  local_address rem_address   st tx_queue rx_queue tr tm-&gt;when retrnsmt   uid  timeout inode
   0: 00000000:276F 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 92486795 1 0000000000000000 100 0 0 10 0
   1: 00000000:46A2 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 92479401 1 0000000000000000 100 0 0 10 0
   2: 00000000:2709 00000000:0000 0A 00000000:00000000 00:00000000 00000000     0        0 92486189 1 0000000000000000 100 0 0 10 0

   46: 010310AC:9C4C 030310AC:1770 01 
   |      |      |      |      |   |--&gt; connection state
   |      |      |      |      |------&gt; remote TCP port number
   |      |      |      |-------------&gt; remote IPv4 address
   |      |      |--------------------&gt; local TCP port number
   |      |---------------------------&gt; local IPv4 address
   |----------------------------------&gt; number of entry

[root@game-ticket-job-798fc84d58-bd7r4 net]# printf <span style="color: #8b2252;">'%d\n'</span> 0x46A2
18082
[root@game-ticket-job-798fc84d58-bd7r4 net]# printf <span style="color: #8b2252;">'%d\n'</span> 0x2709
9993
[root@game-ticket-job-798fc84d58-bd7r4 net]# printf <span style="color: #8b2252;">'%d\n'</span> 0x276F
10095
</pre>
</div>
</div>
</div>
<div id="outline-container-h:932212bc-021d-41bc-b210-236d847b0f96" class="outline-4">
<h4 id="h:932212bc-021d-41bc-b210-236d847b0f96">网络配置工具 nmcli</h4>
<div class="outline-text-4" id="text-h:932212bc-021d-41bc-b210-236d847b0f96">
<p>
<b>NetworkManager</b>
</p>

<p>
NetworkManager是2004年由RedHat启动的项目，目的是让用户更轻松的管理Linux中的网络，它是一个动态的事件驱动的网络管理服务。
</p>

<p>
该项目提供了丰富的管理工具
</p>
<ul class="org-ul">
<li>图形工具：nm-connection-editor</li>
<li>字符配置 tui工具：nmtui, nmtui-connect, nmtui-edit, nmtui-hostname</li>
<li>命令行工具：nmcli</li>
</ul>

<p>
<i>centos6 推荐使用network ，centos7往后推荐使用NetworkManager服务</i>
</p>

<p>
<b>nmcli命令</b>
</p>

<p>
格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">nmcli [ OPTIONS ] OBJECT { COMMAND | <span style="color: #483d8b;">help</span> }
    device - show and manage network interfaces
    nmcli device help
    connection - start, stop, and manage network connections
    nmcli connection help

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24120;&#29992;&#36873;&#39033;</span>
-a|--ask           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35810;&#38382;</span>
-c|--color         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#26102;&#26159;&#21542;&#26174;&#31034;&#39068;&#33394; auto|yes|no</span>
-e|--ecape         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#36716;&#20041;&#20998;&#38548;&#31526; yes|no</span>
-f|--fields        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#36755;&#20986;&#21015; &lt;field, ...&gt;|all|commmon</span>
-m|--mode          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#27169;&#24335; tabular|multiline</span>
-o|--overview      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#39044;&#35272;&#27169;&#24335;&#36755;&#20986;</span>
-p|--pretty        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23436;&#32654;&#26684;&#24335;&#36755;&#20986;</span>
-t|--terse         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31616;&#27905;&#26684;&#24335;&#36755;&#20986;</span>
-v|--version       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#29256;&#26412;&#20449;&#24687;</span>
-h|--help          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#24110;&#21161;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">OBJECT</span>
g[eneral]          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#33324;&#29366;&#24577;&#31649;&#29702;</span>
n[etworking]       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25972;&#20307;&#32593;&#32476;&#31649;&#29702;</span>
r[adio]            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;&#36830;&#25509;&#20999;&#25442;</span>
c[onnection]       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;&#36830;&#25509;&#31649;&#29702;</span>
d[evice]           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;&#35774;&#22791;&#31649;&#29702;</span>
a[gent]            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;&#20013;&#30340;&#20195;&#29702;</span>
m[onitor]          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;&#20013;&#30340;&#27969;&#37327;&#25968;&#25454;&#30417;&#25511;</span>
</pre>
</div>



<p>
修改IP地址等属性：
</p>

<div class="org-src-container">
<pre class="src src-sh">nmcli connection modify IFACE [+|-]setting.property value
setting.property: ipv4.addresses ipv4.gateway ipv4.dns1 ipv4.method manual |auto
</pre>
</div>

<p>
修改配置文件执行生效：
</p>

<div class="org-src-container">
<pre class="src src-sh">nmcli con reload
nmcli con up con-name
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">nmcli con mod</th>
<th scope="col" class="org-left">ifcfg*-** 文件</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">type ethernet</td>
<td class="org-left">TYPE=Ethernet</td>
</tr>

<tr>
<td class="org-left">ipv4.method manual</td>
<td class="org-left">BOOTPROTO=none</td>
</tr>

<tr>
<td class="org-left">ipv4.method auto</td>
<td class="org-left">BOOTPROTO=dhcp</td>
</tr>

<tr>
<td class="org-left">ipv4.addresses 192.168.2.1/24</td>
<td class="org-left">IPADDR=192.168.2.1 PREFIX=24</td>
</tr>

<tr>
<td class="org-left">ipv4.gateway 172.16.0.200</td>
<td class="org-left">GATEWAY=192.0.2.254</td>
</tr>

<tr>
<td class="org-left">ipv4.dns 8.8.8.8</td>
<td class="org-left">DNS0=8.8.8.8</td>
</tr>

<tr>
<td class="org-left">ipv4.dns-search example.com</td>
<td class="org-left">DOMAIN=example.com</td>
</tr>

<tr>
<td class="org-left">ipv4.ignore-auto-dns true</td>
<td class="org-left">PEERDNS=no</td>
</tr>

<tr>
<td class="org-left">connection.autoconnect yes</td>
<td class="org-left">ONBOOT=yes</td>
</tr>

<tr>
<td class="org-left">connection.id eth0</td>
<td class="org-left">NAME=eth0</td>
</tr>

<tr>
<td class="org-left">connection.interface-name eth0</td>
<td class="org-left">DEVICE=eth0</td>
</tr>

<tr>
<td class="org-left">802-3-ethernet.mac-address . . .</td>
<td class="org-left">HWADDR= . . .</td>
</tr>
</tbody>
</table>


<p>
常用
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24110;&#21161;</span>
nmcli con add help

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;nmcli&#37197;&#32622;&#32593;&#32476;</span>
nmcli con
nmcli con show

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#25152;&#26377;&#27963;&#21160;&#36830;&#25509;</span>
nmcli con show --active

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#32593;&#32476;&#36830;&#25509;&#37197;&#32622;</span>
nmcli con show     <span style="color: #8b2252;">"System eth0"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#35774;&#22791;&#29366;&#24577;</span>
nmcli dev status

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#32593;&#32476;&#25509;&#21475;&#23646;&#24615;</span>
nmcli dev show eth0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#26032;&#36830;&#25509;default&#65292;IP&#33258;&#21160;&#36890;&#36807;dhcp&#33719;&#21462;</span>
nmcli con add con-name default type Ethernet ifname eth0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#36830;&#25509;</span>
nmcli con del default

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#26032;&#36830;&#25509;static &#65292;&#25351;&#23450;&#38745;&#24577;IP&#65292;&#19981;&#33258;&#21160;&#36830;&#25509;</span>
nmcti con add con-name static     <span style="color: #8b2252;">\</span>
ifname eth0 autoconnect no type Ethernet <span style="color: #8b2252;">\</span>
ipv4.addresses 172.25.X.10/24 ipv4.gateway     172.25.X.254

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;static&#36830;&#25509;&#37197;&#32622;</span>
nmcli con up static

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;default&#36830;&#25509;&#37197;&#32622;</span>
nmcli con up default

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#19968;&#35774;&#22791;&#26032;&#22686;&#37197;&#32622;</span>
nmcli con mo static +ipv4.address 10.0.0.199/24
nmcli con mo static +ipv4.dns 8.8.8.8

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#19968;&#35774;&#22791;&#21024;&#38500;&#37197;&#32622;</span>
nmcli con mo static -ipv4.address 10.0.0.199/24
nmcli con mo static -ipv4.dns 8.8.8.8

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#36830;&#25509;&#35774;&#32622;</span>
nmcli con mod <span style="color: #8b2252;">"static"</span> connection.autoconnect no
nmcli con mod <span style="color: #8b2252;">"static"</span> ipv4.dns 172.25.X.254
nmcli con mod <span style="color: #8b2252;">"static"</span> ipv4.addresses <span style="color: #8b2252;">"172.16.X.10/24     172.16.X.254"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">DNS&#35774;&#32622;&#23384;&#25918;&#22312;/etc/resolv.conf&#65292;PEERDNS=no &#34920;&#31034;&#24403;IP&#36890;&#36807;dhcp&#33258;&#21160;&#33719;&#21462;&#26102;&#65292;dns&#20173;&#26159;&#25163;&#21160;&#35774;&#32622;&#65292;&#19981;&#33258;&#21160;&#33719;&#21462;&#31561;&#20215;&#20110;&#19979;&#38754;&#21629;&#20196;</span>
nmcli con mod <span style="color: #8b2252;">"system eth0"</span> ipv4.ignore-auto-dns yes
</pre>
</div>

<p>
范例：vmware增加的网卡配置
</p>

<div class="org-src-container">
<pre class="src src-sh">nmcli connection <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#32593;&#32476;&#29366;&#24577; &#21487;&#20197;&#30475;&#21040;&#22686;&#30340;&#32593;&#21345;&#20889;&#21040;&#20869;&#23384;&#20013;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;&#26032;&#22686;&#32593;&#21345;&#20174;&#20869;&#23384;&#20889;&#20837;&#21040;&#25991;&#20214;&#65292;&#24182;&#25913;&#32593;&#21345;&#21517;</span>
nmcli connection modify Wired<span style="color: #8b2252;">\ </span>connection<span style="color: #8b2252;">\ </span>1 con-name eth1-home
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25913;ip&#12289;&#32593;&#20851;&#22320;&#22336;&#12289;dns&#22320;&#22336;</span>
nmcli connection modify eth1-home ipv4.addresses 192.168.0.100/24 ipv4.gateway 192.168.0.1 ipv4.dns 223.6.6.6 ipv4.method manual
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25928;&#65292;&#37325;&#21551;&#21152;&#36733;&#32593;&#21345;</span>
nmcli connection reload
nmcli connection up eth1-hhome

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20877;&#28155;&#21152;&#32593;&#21345;</span>
nmcli connection add con-name eth1-work ipv4.method manual ipv4.addresses 172.16.0.100/16  ifname eth0 type Ethernet
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25928;&#65292;&#37325;&#21551;&#21152;&#36733;&#32593;&#21345;</span>
nmcli connection reload
nmcli connection up eth1-work <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24076;&#26395;&#35841;&#29983;&#25928;&#23601;&#21152;&#36733;&#35841;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;</span>
mcli connection   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#21040;eth1-home&#24050;&#32463;&#39030;&#26367;&#19979;&#26469;&#20102;</span>
</pre>
</div>


<figure id="orge22e269">
<img src="images/image-20210201014234753.png" alt="image-20210201014234753.png" width="50%">

</figure>

<p>
在ubuntu使用nmcli
</p>
<div class="org-src-container">
<pre class="src src-sh">apt install network-manager
vim /etc/Network-kManager/NetworkManager.conf
...
[ifupdown]
<span style="color: #a0522d;">managed</span>=false &#25913;&#20026; <span style="color: #a0522d;">managed</span>=true

systemctl restart NetworkManager.service

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#32593;&#21345;&#37197;&#32622;</span>
vim /etcnetplan/00-installer-config.yaml
network:
  renderer: NetworkManger   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#27492;&#34892;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25928;</span>
netplan apply
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:02dc2a62-3464-4308-b307-3f0288570ced" class="outline-3">
<h3 id="h:02dc2a62-3464-4308-b307-3f0288570ced">网络配置文件</h3>
<div class="outline-text-3" id="text-h:02dc2a62-3464-4308-b307-3f0288570ced">
</div>
<div id="outline-container-h:f3ad9452-c900-4b6f-b4bf-4116d4592e5a" class="outline-4">
<h4 id="h:f3ad9452-c900-4b6f-b4bf-4116d4592e5a">配置当前主机的主机名</h4>
<div class="outline-text-4" id="text-h:f3ad9452-c900-4b6f-b4bf-4116d4592e5a">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">centos7 &#20197;&#21518;&#29256;</span>
/etc/hostname
HOSTNAME

<span style="color: #b22222;">#</span><span style="color: #b22222;">centos6 &#20043;&#21069;&#29256;&#26412;</span>
/etc/sysconfig/network
<span style="color: #a0522d;">HOSTNAME</span>=
</pre>
</div>


<p>
范例：修改主机名
</p>

<div class="org-src-container">
<pre class="src src-sh">root@ubuntu1804:~# hostnamectl set-hostname ubuntu1804.you.org
root@ubuntu1804:~# cat /etc/hostname
ubuntu1804.you.org
root@ubuntu1804:~# hostname
ubuntu1804.you.org
root@ubuntu1804:~# echo $<span style="color: #a0522d;">HOSTNAME</span>
ubuntu1804
root@ubuntu1804:~# exit
<span style="color: #a020f0;">logout</span>
wang@ubuntu1804:~$ sudo -i
root@ubuntu1804:~# echo $<span style="color: #a0522d;">HOSTNAME</span>
ubuntu1804.you.org
</pre>
</div>
</div>
</div>
<div id="outline-container-h:36b314c8-8372-4a43-8a4a-e1beffa91310" class="outline-4">
<h4 id="h:36b314c8-8372-4a43-8a4a-e1beffa91310">本地主机名和IP地址的映射</h4>
<div class="outline-text-4" id="text-h:36b314c8-8372-4a43-8a4a-e1beffa91310">
<p>
优先于使用DNS前检查
</p>

<p>
getent hosts 查看/etc/hosts 内容
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/hosts
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0d9af96d-7fb6-4f64-a415-c3ee5f38d860" class="outline-4">
<h4 id="h:0d9af96d-7fb6-4f64-a415-c3ee5f38d860">DNS域名解析</h4>
<div class="outline-text-4" id="text-h:0d9af96d-7fb6-4f64-a415-c3ee5f38d860">
<p>
DNS负责将域名转换成IP地址
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/resolv.conf
nameserver DNS_SERVER_IP1 
nameserver DNS_SERVER_IP2
nameserver DNS_SERVER_IP3
search DOMAIN <span style="color: #b22222;"># </span><span style="color: #b22222;">DOMAIN&#30340;&#21517;&#23383;&#40664;&#35748;&#26159;&#20174;&#20027;&#26426;&#21517;&#26469;&#30340;&#65292;&#27604;&#22914;&#20027;&#26426;&#21517;&#20026;centos7.b.com DOMAIN&#23601;&#26159;b.com&#12290;&#20063;&#21487;&#20197;&#20462;&#25913;&#32593;&#21345;&#37197;&#32622;&#39033;&#30446;DOMAIN</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26368;&#22810;&#26377;3&#21488;&#20027;&#26426;&#34987;&#24403;&#20316;DNS&#20027;&#26426;&#22320;&#22336;</span>
</pre>
</div>

<p>
ubuntu dns
</p>
<div class="org-src-container">
<pre class="src src-sh">root@ubuntu1804:~#vim /etc/netplan/01-netcfg.yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      addresses: [192.168.8.10/24,10.0.0.10/8]     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#29992;&#19979;&#38754;&#20004;&#34892;,&#20004;&#31181;&#26684;&#24335;&#19981;&#33021;&#28151;&#29992;</span>
      - 192.168.8.10/24
      - 10.0.0.10/8
      gateway4: 192.168.8.1
      nameservers:
        search: [you.com, you.org]
        addresses: [180.76.76.76, 8.8.8.8, 1.1.1.1]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25928;</span>
netplan apply

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;dns</span>
resovlectl status

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#35774;&#22791;&#30340;dns</span>
resolvectl dns eth0
</pre>
</div>

<p>
范例：如何测试(host/nslookup/dig)：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">dig -t A FQDN #&#20027;&#26426;&#21517;&#35299;&#26512;&#65292;&#19981;&#32463;&#36807;hosts&#25991;&#20214;</span>
FQDN --&gt; IP 

<span style="color: #b22222;"># </span><span style="color: #b22222;">dig -x IP</span>
IP --&gt; FQDN
</pre>
</div>

<p>
范例：指定dns服务解析域名
</p>
<div class="org-src-container">
<pre class="src src-shell">host www.baidu.com 10.0.0.2
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e3166d0a-902b-4f3b-876e-3fa12ee171bb" class="outline-4">
<h4 id="h:e3166d0a-902b-4f3b-876e-3fa12ee171bb">修改 /etc/hosts和DNS的优先级</h4>
<div class="outline-text-4" id="text-h:e3166d0a-902b-4f3b-876e-3fa12ee171bb">
<div class="org-src-container">
<pre class="src src-sh">/etc/nsswitch.conf
hosts: files dns
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d83a9c21-14d0-4651-b567-9744eeac79c4" class="outline-4">
<h4 id="h:d83a9c21-14d0-4651-b567-9744eeac79c4">路由相关的配置文件</h4>
<div class="outline-text-4" id="text-h:d83a9c21-14d0-4651-b567-9744eeac79c4">
<div class="org-src-container">
<pre class="src src-sh">/etc/sysconfig/network-scripts/route-IFACE

&#20004;&#31181;&#39118;&#26684;&#65306;
(1) TARGET via GW (&#25512;&#33616;)
&#22914;&#65306;10.0.0.0/8 via 172.16.0.1

(2) &#27599;&#19977;&#34892;&#23450;&#20041;&#19968;&#26465;&#36335;&#30001;
ADDRESS#=TARGET
NETMASK#=mask
GATEWAY#=GW
</pre>
</div>

<p>
生效: systemctl restart network.service
</p>
</div>
</div>
</div>
<div id="outline-container-h:b9ea5b73-5012-41de-981a-6b1499877b38" class="outline-3">
<h3 id="h:b9ea5b73-5012-41de-981a-6b1499877b38">网卡别名</h3>
<div class="outline-text-3" id="text-h:b9ea5b73-5012-41de-981a-6b1499877b38">
<p>
将多个IP地址绑定到一个NIC上
</p>

<p>
每个IP绑定到独立逻辑网卡，即网络别名，命名格式： ethX:Y，如：eth0:1
、eth0:2、eth0:3
</p>

<p>
范例：ifconfig命令
</p>

<div class="org-src-container">
<pre class="src src-sh">ifconfig eth0:0 192.168.1.100/24 up
ifconfig eth0:0 down
</pre>
</div>

<p>
范例：ip 命令
</p>

<div class="org-src-container">
<pre class="src src-sh">ip addr add 172.16.1.1/16 dev eth0
ip addr add 172.16.1.2/16 dev eth0 label eth0:0
ip addr del 172.16.1.2/16 dev eth0 label eth0:0
ip addr flush dev eth0 label eth0:0
</pre>
</div>

<p>
为每个设备别名生成独立的接口配置文件，格式为：ifcfg-ethX:xxx
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /etc/sysconfig/network-scripts/ifcfg-eth0:1
<span style="color: #a0522d;">DEVICE</span>=eth0:1
<span style="color: #a0522d;">IPADDR</span>=10.0.0.100
<span style="color: #a0522d;">PREFIX</span>=8

[root@centos8 ~]#ifconfig
eth0: <span style="color: #a0522d;">flags</span>=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500
            inet 10.0.0.8 netmask 255.255.255.0 broadcast 10.0.0.255
eth0:1: <span style="color: #a0522d;">flags</span>=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500
            inet 10.0.0.100 netmask 255.0.0.0 broadcast 10.255.255.255
</pre>
</div>

<p>
注意：
</p>

<ul class="org-ul">
<li>建议 CentOS 6 关闭 NetworkManager 服务</li>
<li>网卡别名必须使用静态地址</li>
</ul>
</div>
</div>
<div id="outline-container-h:aae3c1c2-71cc-41a5-9390-b4fc00aae54a" class="outline-3">
<h3 id="h:aae3c1c2-71cc-41a5-9390-b4fc00aae54a">多网卡 bonding</h3>
<div class="outline-text-3" id="text-h:aae3c1c2-71cc-41a5-9390-b4fc00aae54a">
<p>
将多块网卡绑定同一IP地址对外提供服务，可以实现高可用或者负载均衡。直接
给两块网卡设置同一IP地址是不可以的。通过bonding，虚拟一块网卡对外提供
连接，物理网卡的被修改为相同的MAC地址
</p>
</div>
<div id="outline-container-h:8ec3aee1-6b23-46bb-8900-3456abbd3584" class="outline-4">
<h4 id="h:8ec3aee1-6b23-46bb-8900-3456abbd3584">Bonding 工作模式</h4>
<div class="outline-text-4" id="text-h:8ec3aee1-6b23-46bb-8900-3456abbd3584">
<p>
bond聚合链路模式共7种模式：0-6 Mode
</p>

<ul class="org-ul">
<li><p>
mode=0，即：(balance-rr) Round-robin policy (轮询)
聚合数据报文按包轮询从物理接口转发。
</p>

<p>
负载均衡：所有链处于负载均衡状态，轮询方式往每条链路发送报文，这模式
的特点增加了带宽，同时支持容错能力，当有链路问题时，会把流量切换到正
常的链路上。
</p>

<p>
性能问题：一个连接或会话的数据包如果从不同的接口发出来的话，中途再经
过不同的链路，在客户端很有可能会出现数据包无序到达的问题，而无序到达
的数据包需要重新要求被发送，这样网络的吞吐量会下降，bound0在大压力的
网络传输下，性能增长的并不是很理想。需要交换机进行端口绑定
</p></li>

<li><p>
mode=1，即(active-backup) Active-backup policy (主-备份策略) 只有
Active 状态的物理接口才能转发数据报文。
</p>

<p>
容错能力：只有一个 slave 是激活的(active)。也就是说同一时刻只有一个
网卡处于工作状态，其他的 slave都处于备份状态，只有在当前激活的 slave
故障后才有可能会变为激活的(active)。
</p>

<p>
无负载均衡：此算法的优点是可以提供高网络连接的可用性，但是他的资源利
用率比较低，只有一个接口处于工作状态，在有N 个网络接口的情况下，资源
利用率为 1/N。
</p></li>

<li><p>
mode=2，即：(balance-xor) XOR policy （平衡策略）聚合数据报文源目MAC、
源目 IP、源目端口进行异或 HASH运算得到一个值，根据该值查找接口转发数
据报文。
</p>

<p>
负载均衡：基于指定的传输 HASH 策略传输数据包
</p>

<p>
容错能力：这模式的特点增加了带宽，同时支持容错能力，当有链路出现问题
时，会把流量切换到正常的链路上。
</p>

<p>
性能问题：该模式将限制流量，以保证到达特定对端的流量总是从一个接口上
发出。既然目的地是通过MAC地址来决定的，因此该模式在本地网络配置下可
以工作得很好。如果所有流量是通过单个路由器，由于只有一个网关，源和目
标MAC都固定了，那么这个算法的线路就一直是同一条，那么这种模式就没有
多少意义了。
</p>

<p>
需要交换机配置为 port channel
</p></li>

<li><p>
mode=3，即：(broadcast) (广播策略)这种模式的特点是一个报文会复制两份
往 bound 下的两个接口分别发送出去。
</p>

<p>
当有对端交换机失效时，感觉不到任何downtime，但此法过于浪费资源；不过
这种模式有很好的容错机制。此模式适用于金融行业，因为他们需要高可靠性
的网络，不允许出现任何问题。
</p></li>

<li><p>
mode=4，即：(802.3ad) IEEE 802.3ad Dynamic link aggregation（IEEE
802.3ad 动态链接聚合）
</p>

<p>
在动态模式下，聚合组内的成员端口上均启用 LACP (链路控制汇聚协议)协议，
其端口状态通过该协议自动进行维护。
</p>

<p>
负载均衡：基于指定的传输 HASH 策略传输数据包。默认算法与 balance-xor
一样
</p>

<p>
容错能力：这模式的特点增加了带宽，同时支持容错能力，当有链路出问题，
会把流量切换到正常的链路上。对比balance-xor，这种模式定期发送 LACPDU
报文维护链路聚合状态，保证链路质量。
</p>

<p>
需要交换机支持 LACP 协议
</p></li>

<li><p>
mode=5，即：(balance-tlb) Adaptive transmit load
balancing(适配器传输负载均衡)
</p>

<p>
在每个物理接口上根据当前的负载（根据速度计算）分配外出流量。如果正在
接收数据的物理接口出故障了，另一个物理接口接管该故障物理接口的MAC 地
址。
</p>

<p>
需要 ethtool 支持获取每个 slave 的速率。
</p></li>

<li><p>
mode=6，即：(balance-alb) Adaptive load balancing
(适配器适应性负载均衡)
</p>

<p>
该模式包含了 balance-tlb 模式，同时加上针对 IPV4流量的接收负载均衡，
而且不需要任何 switch (交换机)的支持。接收负载均衡是通过 ARP 协商实
现的。bonding驱动截获本机发送的 ARP 应答，并把源硬件地址改写为 bond
中某个物理接口的唯一硬件地址，从而使得不同的对端使用不同的硬件地址进
行通信。
</p>

<p>
mod=6 与 mod=0 的区别：mod=6 先把 eth0 流量占满，再占eth1，eth2&#x2026;；
而 mode=0 的话，会发现 2个口的流量都很稳定，基本一样的带宽。而 mod=6
会发现第一个口流量很高，第 2 个口只占了小部分流量。
</p></li>
</ul>

<p>
说明
</p>

<div class="org-src-container">
<pre class="src src-sh">&#24120;&#29992;&#30340;&#27169;&#24335;&#20026; 0, 1, 3, 6
mode 1, 5, 6 &#19981;&#38656;&#35201;&#20132;&#25442;&#26426;&#37197;&#32622;
mode 0, 2, 3, 4 &#38656;&#35201;&#20132;&#25442;&#26426;&#37197;&#32622;
active-backup, balance-tlb, balance-alb &#27169;&#24335;&#19981;&#38656;&#35201;&#20132;&#25442;&#26426;&#30340;&#20219;&#20309;&#29305;&#27530;&#37197;&#32622;&#12290;&#20854;&#20182;&#32465;&#23450;&#27169;&#24335;&#38656;&#35201;&#37197;&#32622;&#20132;&#25442;&#26426;&#20197;&#20415;&#25972;&#21512;&#38142;&#25509;&#12290;&#22914;&#65306;cisco &#20132;&#25442;&#26426;&#38656;&#35201;&#22312;&#27169;&#24335;0, 2, 3 &#20013;&#20351;&#29992; EtherChannel&#65292;&#20294;&#22312;&#27169;&#24335; 4 &#20013;&#38656;&#35201; LACP &#21644; EtherChannel
</pre>
</div>
</div>
</div>
<div id="outline-container-h:faa62494-84a3-424a-8799-655fd7564779" class="outline-4">
<h4 id="h:faa62494-84a3-424a-8799-655fd7564779">Bonding实现</h4>
<div class="outline-text-4" id="text-h:faa62494-84a3-424a-8799-655fd7564779">
<p>
详细帮助：
</p>
<ul class="org-ul">
<li><a href="https://www.kernel.org/doc/Documentation/networking/bonding.txt">https://www.kernel.org/doc/Documentation/networking/bonding.txt</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">/usr/share/doc/kernel-doc- version/Documentation/networking/bonding.txt
</pre>
</div>

<p>
准备2块网卡,   如果是vmware中仅主机模式
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /etc/sysconfig/network-scripts/
~]# ls
ifcfg-eth0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;bonding&#35774;&#22791;&#30340;&#37197;&#32622;&#25991;&#20214;</span>
/etc/sysconfig/network-scripts/ifcfg-bond0
<span style="color: #a0522d;">TYPE</span>=bond
<span style="color: #a0522d;">DEVICE</span>=bond0
<span style="color: #a0522d;">BOOTPROTO</span>=none
<span style="color: #a0522d;">IPADDR</span>=10.0.0.100
<span style="color: #a0522d;">PREFIX</span>=8
<span style="color: #a0522d;">BONDING_OPTS</span>=<span style="color: #8b2252;">"mode=1 miimon=100"</span>  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24037;&#20316;&#27169;&#24335;&#20026;&#20027;&#22791;&#65292;&#24515;&#36339;&#26816;&#27979;&#38388;&#38548;100ms</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#32593;&#21345;&#37197;&#32622;&#25991;&#20214;</span>
/etc/sysconfig/network-scripts/ifcfg-eth1
<span style="color: #a0522d;">NAME</span>=eth1
<span style="color: #a0522d;">DEVICE</span>=eth1
<span style="color: #a0522d;">BOOTPROTO</span>=none
<span style="color: #a0522d;">MASTER</span>=bond0
<span style="color: #a0522d;">SLAVE</span>=yes
<span style="color: #a0522d;">ONBOOT</span>=yes

/etc/sysconfig/network-scripts/ifcfg-eth2
<span style="color: #a0522d;">NAME</span>=eth2
<span style="color: #a0522d;">DEVICE</span>=eth2
<span style="color: #a0522d;">BOOTPROTO</span>=none
<span style="color: #a0522d;">MASTER</span>=bond0
<span style="color: #a0522d;">SLAVE</span>=yes
<span style="color: #a0522d;">ONBOOT</span>=yes


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25928;</span>
nmcli con reload
nmcli up bond0
nmcli con

</pre>
</div>

<p>
查看bond0状态：
</p>

<div class="org-src-container">
<pre class="src src-sh">/proc/net/bonding/bond0

<span style="color: #b22222;"># </span><span style="color: #b22222;">mii-tool eth1 ; mii-tool eth2 #&#26597;&#30475;&#32593;&#21345;&#26159;&#21542;&#36830;&#25509;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">ethtool eth1 ; ethtool eth2 #&#26597;&#30475;&#32593;&#21345;&#26159;&#21542;&#36830;&#25509;</span>
</pre>
</div>

<p>
测试
</p>
<div class="org-src-container">
<pre class="src src-sh">ping 10.0.0.100
</pre>
</div>

<p>
网卡删除再次上后，bond不会改变，因为切换网卡可能会引起网络震荡。
</p>

<p>
删除bond0
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">ifconfig bond0 down</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">rmmod bonding</span>

nmcli conn down bond0
rm -f ifcfg-bond0 ifcfg-eth1 ifcfg-eth2
nmcli conn reload; nmcli conn
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f6949c88-9b33-44a1-be63-80ece05f9c91" class="outline-4">
<h4 id="h:f6949c88-9b33-44a1-be63-80ece05f9c91">nmcli实现bonding</h4>
<div class="outline-text-4" id="text-h:f6949c88-9b33-44a1-be63-80ece05f9c91">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;bonding&#25509;&#21475;</span>
nmcli con add type bond con-name mybond0 ifname bond0 mode active-backup ipv4.method manual ipv4.address 192.168.10.100/24

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#20174;&#23646;&#25509;&#21475;</span>
nmcli con add type bond-slave ifname eth1 master bond0
nmcli con add type bond-slave ifname eth2 master bond0
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#65306;&#22914;&#26080;&#20026;&#20174;&#23646;&#25509;&#21475;&#25552;&#20379;&#36830;&#25509;&#21517;&#65292;&#21017;&#35813;&#21517;&#31216;&#26159;&#25509;&#21475;&#21517;&#31216;&#21152;&#31867;&#22411;&#26500;&#25104;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35201;&#21551;&#21160;&#32465;&#23450;&#65292;&#21017;&#24517;&#39035;&#39318;&#20808;&#21551;&#21160;&#20174;&#23646;&#25509;&#21475;</span>
nmcli con up bond-slave-eth0
nmcli con up bond-slave-eth1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#32465;&#23450;</span>
nmcli con up mybond0
</pre>
</div>
</div>
</div>
<div id="outline-container-h:56ccd22a-374d-45c0-bd50-e00918470781" class="outline-4">
<h4 id="h:56ccd22a-374d-45c0-bd50-e00918470781">Ubuntu网卡配置</h4>
<div class="outline-text-4" id="text-h:56ccd22a-374d-45c0-bd50-e00918470781">
</div>
<div id="outline-container-h:6601370b-d40e-41a2-b699-4b901f664802" class="outline-5">
<h5 id="h:6601370b-d40e-41a2-b699-4b901f664802">双网卡绑定</h5>
<div class="outline-text-5" id="text-h:6601370b-d40e-41a2-b699-4b901f664802">
<div class="org-src-container">
<pre class="src src-sh">root@ubuntu1804:~# vim /etc/netplan/bond0.yaml
<span style="color: #b22222;"># </span><span style="color: #b22222;">This file describes the network interfaces available on your system</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">For more information, see netplan(5).</span>
network:
  version: 2
  renderer: networkd
  ethernets:
    eth1:
      addresses: []
      dhcp4: no
      dhcp6: no
    eth2:
      addresses: []
      dhcp4: no
      dhcp6: no
  bonds:
    bond0:
      interfaces: [eth1, eth2]
      addresses: [10.0.0.18/16]
      gateway4: 10.0.0.1
      nameservers:
        addresses: [223.6.6.6,223.5.5.5]
      parameters:
        mode: balance-rr             <span style="color: #b22222;">#</span><span style="color: #b22222;">bond&#24037;&#20316;&#27169;&#24335;&#65292;&#36718;&#35810;</span>
        mii-monitor-interval: 100

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25928;</span>
root@ubuntu1804:~# netplan apply

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#27979;</span>
root@ubuntu1804:~# ifconfig -s  <span style="color: #b22222;">#</span><span style="color: #b22222;">netstat -i</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21478;&#19968;&#21488;&#26426;&#22120;ping</span>

root@ubuntu1804:~# cat /proc/net/bonding/bond0
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a4d02ee0-c0aa-4f00-9b1d-993a039542f3" class="outline-5">
<h5 id="h:a4d02ee0-c0aa-4f00-9b1d-993a039542f3">网卡的多组绑定</h5>
<div class="outline-text-5" id="text-h:a4d02ee0-c0aa-4f00-9b1d-993a039542f3">
<p>
可以实现网卡的多组绑定，比如：eth0,eth1绑定至bond0,eth2和eth3绑定bond1
</p>

<div class="org-src-container">
<pre class="src src-sh">root@ubuntu1804:~#cat /etc/netplan/01-netcfg.yaml
<span style="color: #b22222;"># </span><span style="color: #b22222;">This file describes the network interfaces available on your system</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">For more information, see netplan(5).</span>
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: no
      dhcp6: no
    eth1:
      dhcp4: no
      dhcp6: no
    eth2:
      dhcp4: no
      dhcp6: no
    eth3:
      dhcp4: no
      dhcp6: no
  bonds:
    bond0:
      interfaces:
      - eth0
      - eth1
      addresses: [10.0.0.18/16]
      gateway4: 10.0.0.1
      nameservers:
        addresses: [223.6.6.6,223.5.5.5]
      parameters:
        mode: active-backup
        mii-monitor-interval: 100
    bond1:
      interfaces:
      - eth2
      - eth3
      addresses: [10.10.0.18/16]
      parameters:
        mode: active-backup
        mii-monitor-interval: 100
      routes:
      - to: 10.20.0.0/16
        via: 10.10.0.1
      - to: 10.30.0.0/16
        via: 10.10.0.1
      - to: 10.40.0.0/16
        via: 10.10.0.1
      - to: 10.50.0.0/16
        via: 10.10.0.1

root@ubuntu1804:~# netplan apply
root@ubuntu1804:~# ifconfig
root@ubuntu1804:~# route -n
Kernel IP routing table
Destination     Gateway      Genmask        Flags Metric Ref   Use Iface
0.0.0.0         10.0.0.1     0.0.0.0        UG     0     0      0 bond0
10.0.0.0        0.0.0.0      255.255.0.0    U      0     0      0 bond0
10.10.0.0       0.0.0.0      255.255.0.0    U      0     0      0 bond1
10.20.0.0       10.10.0.1    255.255.0.0    UG     0     0      0 bond1
10.30.0.0       10.10.0.1    255.255.0.0    UG     0     0      0 bond1
10.40.0.0       10.10.0.1    255.255.0.0    UG     0     0      0 bond1
10.50.0.0       10.10.0.1    255.255.0.0    UG     0     0      0 bond1

root@ubuntu1804:~# cat /proc/net/bonding/bond0
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a87259e5-a6ae-4c45-949f-a5bd7873dbf2" class="outline-5">
<h5 id="h:a87259e5-a6ae-4c45-949f-a5bd7873dbf2">单网卡桥接</h5>
<div class="outline-text-5" id="text-h:a87259e5-a6ae-4c45-949f-a5bd7873dbf2">
<div class="org-src-container">
<pre class="src src-sh">root@ubuntu1804:~# apt install -y bridge-utils
root@ubuntu1804:~# dpkg -L bridge-utils
/sbin/brctl
......
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37197;&#32622;&#25991;&#20214;&#65292;&#27704;&#20037;&#29983;&#25928;</span>
root@ubuntu1804:~# cat /etc/netplan/01-netcfg.yaml
<span style="color: #b22222;"># </span><span style="color: #b22222;">This file describes the network interfaces available on your system</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">For more information, see netplan(5).</span>
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: yes
    eth1:
      dhcp4: no
      dhcp6: no
    eth2:
      dhcp4: no     
  bridges:
    br0:
      dhcp4: no
      dhcp6: no
      addresses: [10.0.0.18/16]
      gateway4: 10.0.0.2
      nameservers:
        addresses: [223.6.6.6]
      interfaces:
      - eth1
      - eth2

root@ubuntu1804:~# netplan apply

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;</span>
root@ubuntu1804:~# ifconfig br0
br0: <span style="color: #a0522d;">flags</span>=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500
            inet 10.0.0.18 netmask 255.255.0.0 broadcast 10.0.255.255
            inet6 fe80::9cbe:1dff:fe85:6601 prefixlen 64 scopeid 0x20&lt;link&gt;
            ether 9e:be:1d:85:66:01 txqueuelen 1000 (Ethernet)
            RX packets 158 bytes 19534 (19.5 KB)
            RX errors 0 dropped 0 overruns 0 frame 0
            TX packets 10 bytes 796 (796.0 B)
            TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0

root@ubuntu1804:~# brctl show
bridge name bridge id STP enabled interfaces
br0 8000.9ebe1d856601 no eth1
                         eth2
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a32847b9-4eee-429d-9d1a-26d15e5c6130" class="outline-5">
<h5 id="h:a32847b9-4eee-429d-9d1a-26d15e5c6130">多网卡桥接</h5>
<div class="outline-text-5" id="text-h:a32847b9-4eee-429d-9d1a-26d15e5c6130">
<div class="org-src-container">
<pre class="src src-sh">root@ubuntu1804:~#vim     /etc/netplan/01-netcfg.yaml
<span style="color: #b22222;"># </span><span style="color: #b22222;">This file describes the network interfaces available on your system</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">For more information, see netplan(5).</span>
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: no
      dhcp6: no
    eth1:
      dhcp4: no
      dhcp6: no
  bridges:
    br0:
      dhcp4: no
      dhcp6: no
      addresses: [10.0.0.18/16]
      gateway4: 10.0.0.1
      nameservers:
        addresses: [223.6.6.6]
      interfaces:
      - eth0
    br1:
      dhcp4: no
      dhcp6: no
      addresses: [10.10.0.18/16]
      routes:
      - to: 10.20.0.0/16
        via: 10.10.0.1
      - to: 10.30.0.0/16
        via: 10.10.0.1
      - to: 10.4.0.0/16
        via: 10.10.0.1
      - to: 10.50.0.0/16
        via: 10.10.0.1
      interfaces:
      - eth1

root@ubuntu1804:~# brctl show
bridbr0 8000.96dbd15c1daf no eth0
br1 8000.9e02ab0faeb0 no eth1
root@ubuntu1804:~# ifconfig br0
br0: <span style="color: #a0522d;">flags</span>=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500
            inet 10.0.0.18 netmask 255.255.0.0 broadcast 10.0.255.255

root@ubuntu1804:~# ifconfig br1
br1: <span style="color: #a0522d;">flags</span>=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500
            inet 10.10.0.18 netmask 255.255.0.0 broadcast 10.10.255.255

root@ubuntu1804:~# route -n
Kernel IP routing table
Destination    Gateway         Genmask         Flags Metric Ref     Use Iface
0.0.0.0        10.0.0.1       0.0.0.0          UG      0    0       0 br0
10.0.0.0       0.0.0.0        255.255.0.0      U       0    0       0 br0
10.10.0.0      0.0.0.0        255.255.0.0      U       0    0       0 br1
10.20.0.0      10.10.0.1      255.255.0.0      UG      0    0       0 br1
10.30.0.0      10.10.0.1      255.255.0.0      UG      0    0       0 br1
10.50.0.0      10.10.0.1      255.255.0.0      UG      0    0       0 br1ge name bridge id STP enabled interfaces
</pre>
</div>
</div>
</div>
<div id="outline-container-h:16168340-5490-4c3b-a02c-bcd472847614" class="outline-5">
<h5 id="h:16168340-5490-4c3b-a02c-bcd472847614">双网卡绑定+桥接</h5>
<div class="outline-text-5" id="text-h:16168340-5490-4c3b-a02c-bcd472847614">
<p>
网卡绑定用于提供网卡接口冗余以及高可用和端口聚合功能，桥接网卡再给需要
桥接设备的服务使用
</p>


<div class="org-src-container">
<pre class="src src-sh">root@ubuntu1804:~# cat /etc/netplan/01-netcfg.yaml
<span style="color: #b22222;"># </span><span style="color: #b22222;">This file describes the network interfaces available on your system</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">For more information, see netplan(5).</span>
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: no
      dhcp6: no
    eth1:
      dhcp4: no
      dhcp6: no
  bonds:
    bond0:
      interfaces:
      - eth0
      - eth1
      parameters:
        mode: active-backup
        mii-monitor-interval: 100
  bridges:
    br0:
      dhcp4: no
      dhcp6: no
      addresses: [10.0.0.18/16]
      gateway4: 10.0.0.1
      nameservers:
        addresses: [223.6.6.6,223.5.5.5]
      interfaces:
      - bond0

root@ubuntu1804:~# netplan apply

root@ubuntu1804:~# brctl show
root@ubuntu1804:~# ifconfig br0
root@ubuntu1804:~# route -n
root@ubuntu1804:~# ifconfig
</pre>
</div>
</div>
</div>
<div id="outline-container-h:73903365-34ee-413a-a07e-4b8d05bf7c61" class="outline-5">
<h5 id="h:73903365-34ee-413a-a07e-4b8d05bf7c61">网卡多组绑定+多组桥接</h5>
<div class="outline-text-5" id="text-h:73903365-34ee-413a-a07e-4b8d05bf7c61">
<div class="org-src-container">
<pre class="src src-sh">root@ubuntu1804:~# cat /etc/netplan/01-netcfg.yaml
<span style="color: #b22222;"># </span><span style="color: #b22222;">This file describes the network interfaces available on your system</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">For more information, see netplan(5).</span>
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: no
      dhcp6: no
    eth1:
      dhcp4: no
      dhcp6: no
    eth2:
      dhcp4: no
      dhcp6: no
    eth3:
      dhcp4: no
      dhcp6: no
  bonds:
    bond0:
      interfaces:
      - eth0
      - eth1
      parameters:
        mode: active-backup
        mii-monitor-interval: 100
    bond1:
      interfaces:
      - eth2
      - eth3
      parameters:
        mode: active-backup
        mii-monitor-interval: 100
  bridges:
    br0:
      dhcp4: no
      dhcp6: no
      addresses: [10.0.0.18/16]
      gateway4: 10.0.0.1
      nameservers:
        addresses: [223.6.6.6,223.5.5.5]
      interfaces:
      - bond0
    br1:
      dhcp4: no
      dhcp6: no
      interfaces:
      - bond1
      addresses: [10.10.0.18/16]
      routes:
      - to: 10.20.0.0/16
        via: 10.10.0.1
      - to: 10.30.0.0/16
        via: 10.10.0.1
      - to: 10.40.0.0/16
        via: 10.10.0.1
      - to: 10.50.0.0/16
        via: 10.10.0.1

root@ubuntu1804:~# netplan apply

root@ubuntu1804:~# brctl show
root@ubuntu1804:~# route -n
Kernel IP routing table
Destination    Gateway    Genmask        Flags Metric Ref     Use Iface
0.0.0.0        0.0.0.1    0.0.0.0        UG    0      0       0 br0
10.0.0.0       0.0.0.0    255.255.0.0    U     0      0       0 br0
10.10.0.0      0.0.0.0    255.255.0.0    U     0      0       0 br1
10.20.0.0      10.10.0.1  255.255.0.0    UG    0      0       0 br1
10.30.0.0      10.10.0.1  255.255.0.0    UG    0      0       0 br1
10.40.0.0      10.10.0.1  255.255.0.0    UG    0      0       0 br1
10.50.0.0      10.10.0.1  255.255.0.0    UG    0      0       0 br1
root@ubuntu1804:~# ifconfig
root@ubuntu1804:~# cat /proc/net/bonding/bond1
root@ubuntu1804:~#
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:9599c7d5-fec3-432c-9818-a2dabcfeefd9" class="outline-3">
<h3 id="h:9599c7d5-fec3-432c-9818-a2dabcfeefd9">网络组 Network Teaming</h3>
<div class="outline-text-3" id="text-h:9599c7d5-fec3-432c-9818-a2dabcfeefd9">
<p>
从 centos7 开始使用，代替早期的 bond
</p>

<p>
网络组：是将多个网卡聚合在一起方法，从而实现冗错和提高吞吐量
</p>

<p>
网络组不同于旧版中bonding技术，提供更好的性能和扩展性
</p>

<p>
网络组由内核驱动和teamd守护进程实现
</p>

<p>
网络组特点
</p>

<ul class="org-ul">
<li>启动网络组接口不会自动启动网络组中的port接口</li>
<li>启动网络组接口中的port接口总会自动启动网络组接口</li>
<li>禁用网络组接口会自动禁用网络组中的port接口</li>
<li>没有port接口的网络组接口可以启动静态IP连接</li>
<li>启用DHCP连接时，没有port接口的网络组会等待port接口的加入</li>
</ul>

<p>
常用工作模式
</p>
<ul class="org-ul">
<li>broadcast 广播</li>
<li>roundrobin 轮询</li>
<li>random 随机</li>
<li>activebackup 主备</li>
<li>loadbalance 负载均衡</li>
<li>lacp (implements the 802.3ad Link Aggregation Control Protocol)</li>
</ul>

<p>
查看帮助
</p>
<div class="org-src-container">
<pre class="src src-sh">man teamd
man teamd.conf
</pre>
</div>
</div>
<div id="outline-container-h:b6c94074-d152-41db-8104-187c1385c2bb" class="outline-4">
<h4 id="h:b6c94074-d152-41db-8104-187c1385c2bb">网络组实现</h4>
<div class="outline-text-4" id="text-h:b6c94074-d152-41db-8104-187c1385c2bb">
</div>
<div id="outline-container-h:0ab982d6-79f6-4d84-b706-a9939e3b0aa5" class="outline-5">
<h5 id="h:0ab982d6-79f6-4d84-b706-a9939e3b0aa5">修改配置文件实现</h5>
<div class="outline-text-5" id="text-h:0ab982d6-79f6-4d84-b706-a9939e3b0aa5">
<p>
添加2块网卡， 如果vmware 网卡设置成仅主机模式
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /etc/sysconfig/network-scripts/
~]# ls
ifcfg-eth0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;team&#25509;&#21475;&#25991;&#20214;</span>
cat &lt;&lt;\EOF&gt; ifcfg-team0
<span style="color: #ffa54f;">DEVICE=team0</span>
<span style="color: #ffa54f;">DEVICETYPE=Team</span>
<span style="color: #ffa54f;">TEAM_CONFIG="{\"runner\": {\"name\": \"loadbalance\"}}"</span>
<span style="color: #ffa54f;">BOOTPROTO=none</span>
<span style="color: #ffa54f;">IPADDR0=172.16.0.100</span>
<span style="color: #ffa54f;">PREFIX0=24</span>
<span style="color: #ffa54f;">NAME=team0</span>
<span style="color: #ffa54f;">ONBOOT=yes</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;port&#37197;&#32622;&#25991;&#20214;</span>
cat &lt;&lt;\EOF&gt; ifcfg-team0-eth1
<span style="color: #ffa54f;">DEVICE=eth1</span>
<span style="color: #ffa54f;">DEVICETYPE=TeamPort</span>
<span style="color: #ffa54f;">TEAM_MASTER=team0</span>
<span style="color: #ffa54f;">NAME=team0-eth1</span>
<span style="color: #ffa54f;">ONBOOT=yes</span>
<span style="color: #ffa54f;">EOF</span>

cat &lt;&lt;\EOF&gt; ifcfg-team0-eth2
<span style="color: #ffa54f;">DEVICE=eth2</span>
<span style="color: #ffa54f;">DEVICETYPE=TeamPort</span>
<span style="color: #ffa54f;">TEAM_MASTER=team0</span>
<span style="color: #ffa54f;">NAME=team0-eth2</span>
<span style="color: #ffa54f;">ONBOOT=yes</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;</span>
nmcli con reload; nmcli con up team0
nmcli con

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;</span>
teamdctl team0 state

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21478;&#19968;&#21488;&#26443;&#22120; ping</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:45275bda-c06a-4da9-946d-6827f5d1ac2f" class="outline-5">
<h5 id="h:45275bda-c06a-4da9-946d-6827f5d1ac2f">nmcli命令实现</h5>
<div class="outline-text-5" id="text-h:45275bda-c06a-4da9-946d-6827f5d1ac2f">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#32593;&#32476;&#32452;&#25509;&#21475;</span>
nmcli con add type team con-name CON-NAME ifname TEAM-INAME [config JSON]
CON-NAME <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#21517;</span>
TEAM-INAME <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25509;&#21475;&#21517;</span>
JSON <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#39033;,&#26684;&#24335;&#65306;'{"runner": {"name": "METHOD"}}'</span>
METHOD <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27969;&#37327;&#31639;&#27861;&#65292;broadcast, roundrobin, activebackup, loadbalance, lacp</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;port&#25509;&#21475;</span>
nmcli con add type team-slave con-name CON-NAME ifname CON-TEAM-INAME master TEAM-NAME

CON-NAME <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#21517;,&#36830;&#25509;&#21517;&#33509;&#19981;&#25351;&#23450;&#65292;&#40664;&#35748;&#20026;team-slave-IFACE</span>
CON-TEAM-INAME <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;&#25509;&#21475;&#21517;</span>
TEAM-NAME <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#32476;&#32452;&#25509;&#21475;&#21517;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26029;&#24320;&#21644;&#21551;&#21160;</span>
nmcli dev dis INAME
nmcli con up CNAME

INAME <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#22791;&#21517; CNAME &#32593;&#32476;&#32452;&#25509;&#21475;&#21517;&#25110;port&#25509;&#21475;</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;team</span>
nmcli con add type team con-name myteam0 ifname team0 config <span style="color: #8b2252;">'{"runner":{"name": "loadbalance"}}'</span> ipv4.addresses 192.168.1.100/24 ipv4.method manual

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#32593;&#21345;</span>
nmcli con add con-name team0-eth1 type team-slave ifname eth1 master team0
nmcli con add con-name team0-eth2 type team-slave ifname eth2 master team0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;</span>
nmcli con up myteam0
nmcli con up team0-eth1
nmcli con up team0-eth2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;</span>
teamdctl team0 state

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;</span>
ping -I team0 192.168.0.254
nmcli dev dis eth1  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26029;&#24320;eth1</span>
teamdctl team0 state
nmcli con up team0-port1
nmcli dev dis eth2 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26029;&#24320;eth2</span>
teamdctl team0 state
nmcli con up team0-port2
teamdctl team0 state

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#32593;&#32476;&#32452;</span>
nmcli con down team0
nmcli con del team0
nmcli con del team0-eth0
nmcli con del team0-eth1
nmcli con show
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:57cf60fe-081e-4fe5-9b2b-387a49d6f3f9" class="outline-3">
<h3 id="h:57cf60fe-081e-4fe5-9b2b-387a49d6f3f9">网桥(交换机)</h3>
<div class="outline-text-3" id="text-h:57cf60fe-081e-4fe5-9b2b-387a49d6f3f9">
<p>
vmware 中
</p>

<p>
NAT 相当于 hub 集线顺，连接多个虚拟机，再和 windows 虚拟网卡 vwnet8一
般是 10.0.0.1 连接。
</p>

<p>
vmnet1 仅主机，多虚拟机连在 vmnet1 上，再连到 windows 中还一块虚拟网卡
vmnet1 地址 192.168.10.1/24
</p>

<p>
vmnet 0 桥接，vmnet0 与 windows 物理主机的网卡连通。
</p>
</div>
<div id="outline-container-h:f225f4ad-f717-40f3-81ad-9ee638274f58" class="outline-4">
<h4 id="h:f225f4ad-f717-40f3-81ad-9ee638274f58">桥接原理</h4>
<div class="outline-text-4" id="text-h:f225f4ad-f717-40f3-81ad-9ee638274f58">
<p>
桥接：把一台机器上的若干个网络接口”连接”起来。其结果是，其中一个网口
收到的报文会被复制给其他网口并发送出去。以使得网口之间的报文能够互相转
发。网桥就是这样一个设备，它有若干个网口，并且这些网口是桥接起来的。与
网桥相连的主机就能通过交换机的报文转发而互相通信。
</p>


<figure id="orgdb369db">
<img src="images/image-20210126193059421.png" alt="image-20210126193059421.png" width="50%">

</figure>

<p>
主机A发送的报文被送到交换机S1的eth0口，由于eth0与eth1、eth2桥接在一起，
故而报文被复制到eth1和eth2，并且发送出去，然后被主机B和交换机S2接收到。
而S2又会将报文转发给主机C、D
</p>
</div>
</div>
<div id="outline-container-h:ad72387b-f65b-496e-b6f6-5c5daec0ba7e" class="outline-4">
<h4 id="h:ad72387b-f65b-496e-b6f6-5c5daec0ba7e">配置实现网桥</h4>
<div class="outline-text-4" id="text-h:ad72387b-f65b-496e-b6f6-5c5daec0ba7e">
<p>
公有网桥Public Bridge与私有虚拟网桥的步骤基本相同，唯一区别是把宿主
host的网卡加入到Bridge中。
</p>

<p>
A(10.0.0.5) &#x2013;vmnet1&#x2013;centos7 &#x2013;vmnet8&#x2013;B(10.0.0.8)
</p>
</div>
<div id="outline-container-h:68016ea1-85ca-495d-8978-c9c5f5ad155b" class="outline-5">
<h5 id="h:68016ea1-85ca-495d-8978-c9c5f5ad155b">配置文件方式</h5>
<div class="outline-text-5" id="text-h:68016ea1-85ca-495d-8978-c9c5f5ad155b">
<p>
永久生效, 但配置较繁琐
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /etc/sysconfig/network-scripts/
cp ifcfg-eth0 ifcfg-br0

<span style="color: #b22222;"># </span><span style="color: #b22222;">1. &#21019;&#24314;&#26725;&#35774;&#22791;&#25991;&#20214;</span>
cat &gt;ifcfg-br0&lt;&lt;\EOF
<span style="color: #ffa54f;">TYPE=Bridge</span>
<span style="color: #ffa54f;">DEVICE=br0</span>
<span style="color: #ffa54f;">BOOTPROTO=none</span>
<span style="color: #ffa54f;">NM_CONTROLLED=no</span>
<span style="color: #ffa54f;">ONBOOT=yes</span>

<span style="color: #ffa54f;">IPADDR=172.20.20.10</span>
<span style="color: #ffa54f;">PREFIX=16</span>
<span style="color: #ffa54f;">GATEWAY=172.20.0.2</span>
<span style="color: #ffa54f;">DNS1=8.8.8.8</span>
<span style="color: #ffa54f;">IPV6INIT=no</span>
<span style="color: #ffa54f;">USERCTL=no</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">2. &#20462;&#25913;&#29289;&#29702;&#32593;&#21345;&#25991;&#20214;</span>
cat  &gt;ifcfg-eth0&lt;&lt;\EOF
<span style="color: #ffa54f;">TYPE=Ethernet</span>
<span style="color: #ffa54f;">BOOTPROTO=static</span>

<span style="color: #ffa54f;">DEVICE=eth0</span>
<span style="color: #ffa54f;">ONBOOT=yes</span>
<span style="color: #ffa54f;">NM_CONTROLLED=no</span>
<span style="color: #ffa54f;">BRIDGE=br0</span>
<span style="color: #ffa54f;">IPV6INIT=no</span>
<span style="color: #ffa54f;">USERCTL=no</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">3. &#37325;&#21551;&#32593;&#32476;</span>
systemctl restart network
</pre>
</div>
</div>
</div>
<div id="outline-container-h:30d0ee6e-aa44-414b-afbb-3144ba491f40" class="outline-5">
<h5 id="h:30d0ee6e-aa44-414b-afbb-3144ba491f40">方法1-工具包bridge-utils实现</h5>
<div class="outline-text-5" id="text-h:30d0ee6e-aa44-414b-afbb-3144ba491f40">
<p>
目前 CentOS 8 无此包
</p>

<div class="org-src-container">
<pre class="src src-sh">yum install bridge-utils

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#32593;&#26725;</span>
brctl show

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;CAM(content addressable memory&#20869;&#23481;&#21487;&#23547;&#22336;&#23384;&#20648;&#22120;)&#34920;</span>
brctl showmacs br0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#21644;&#21024;&#38500;&#32593;&#26725;</span>
brctl addbr | delbr br0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#21644;&#21024;&#38500;&#32593;&#26725;&#20013;&#32593;&#21345;</span>
brctl addif | delif br0 eth0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;br0 &#26159;down,&#24517;&#39035;&#21551;&#29992;</span>
ifconfig br0 up

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;STP</span>
[root@centos7 ~]#brctl show
bridge name bridge id STP enabled interfaces
br0 8000.000c297e67a3 no eth1
eth2
[root@centos7 ~]#brctl stp br0 on
[root@centos7 ~]#brctl show
bridge name bridge id STP enabled interfaces
br0 8000.000c297e67a3 yes eth1
                        eth2
</pre>
</div>

<p>
注意：NetworkManager只支持以太网接口接口连接到网桥，不支持聚合接口
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">yum install bridge-utils
brctl show <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#32593;&#26725;</span>
brctl showmacs br0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;CAM(content addressable memory&#20869;&#23481;&#21487;&#23547;&#22336;&#23384;&#20648;&#22120;)&#34920;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">0. &#20934;&#22791;&#32593;&#21345;&#65292;&#21487;&#20197;&#26159;&#29289;&#29702;&#32593;&#21345;&#25110;&#34394;&#25311;&#32593;&#21345;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">1. &#25163;&#21160;&#21019;&#24314;&#26725;</span>
brctl addbr br0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#32593;&#26725;</span>
brctl stp br0 on <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;STP</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">2. &#28155;&#21152;&#19968;&#20010;&#29289;&#29702;&#32593;&#19978;&#21040;&#36825;&#20010;&#26725;&#19978;</span>
brctl addif br0 eth0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#32593;&#26725;&#20013;&#32593;&#21345;</span>
brctl addif br0 eth1

<span style="color: #b22222;">#</span><span style="color: #b22222;">3. br0&#20998;&#37197;&#22320;&#22336;&#21644;&#36335;&#30001;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">yum install -y net-tools #ifconfig&#21629;&#20196;</span>
ifconfig br0 up <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;br0 &#26159;down,&#24517;&#39035;&#21551;&#29992;</span>
ifconfig eth0 0 up  <span style="color: #b22222;"># </span><span style="color: #b22222;">ifconfig eth0 0.0.0.0 #&#29289;&#29702;&#32593;&#21345;&#22788;&#20110;&#28151;&#26434;&#27169;&#24335;&#65292;&#19981;&#29992;&#37197;&#32622;IP</span>
ifconfig br0 IP/NETMASK up <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#38656;&#35201;&#32473;&#32593;&#26725;&#37197;&#32622;&#19968;&#20010;IP&#21363;&#21487;</span>
route add default gw IP


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#21019;&#24314;&#30340;&#26725;&#65292;&#24674;&#22797;&#32593;&#32476;</span>
route del default <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#40664;&#35748;&#36335;&#30001;</span>
brctl delif br0 eth0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#32593;&#26725;&#20013;&#32593;&#21345;</span>
brctl delbr br0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#32593;&#26725;</span>
ifdown eth0
ifup eth0
systemctl restart network
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2720dab4-0fa0-4597-8408-a4d55a433305" class="outline-5">
<h5 id="h:2720dab4-0fa0-4597-8408-a4d55a433305">方法2-工具包iproute实现</h5>
<div class="outline-text-5" id="text-h:2720dab4-0fa0-4597-8408-a4d55a433305">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">0. &#20934;&#22791;&#32593;&#21345;&#65292;&#21487;&#20197;&#26159;&#29289;&#29702;&#32593;&#21345;&#25110;&#34394;&#25311;&#32593;&#21345;</span>
ip tuntap add $<span style="color: #a0522d;">1</span> mode tap user <span style="color: #ff00ff;">`whoami`</span>
ip link set $<span style="color: #a0522d;">1</span> up
<span style="color: #b22222;"># </span><span style="color: #b22222;">ip tuntap show</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">1. &#25163;&#21160;&#21019;&#24314;&#26725;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">yum install -y iproute</span>
ip link add name br0 type bridge stp_state 1  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#32593;&#26725;&#24182;&#24320;&#21551;STP</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">ip link show type bridge</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">2. &#28155;&#21152;&#19968;&#20010;&#29289;&#29702;&#32593;&#19978;&#21040;&#36825;&#20010;&#26725;&#19978;</span>
ip link set eth0 master br0  <span style="color: #b22222;">#</span><span style="color: #b22222;">eth0&#21482;&#33021;&#32465;&#23450;&#19968;&#20010;master</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">ip link show master $br</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">ip link set eth0 nomaster # &#35299;&#38500;&#32465;&#23450;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">3. br0&#20998;&#37197;&#22320;&#22336;&#21644;&#36335;&#30001;</span>
ip addr flush dev eth0 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28165;&#31354;&#32593;&#21345;&#22320;&#22336;</span>
ip addr add 172.20.20.12/16 dev br0 &amp;&amp; ip link set br0 up
ip route add default via 172.20.20.1
<span style="color: #b22222;">#</span><span style="color: #b22222;">ip link show &amp;&amp; ip route show</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ip link show type bridge &amp;&amp; ip link show master br0 </span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#21019;&#24314;&#30340;&#26725;&#65292;&#24674;&#22797;&#32593;&#32476;</span>
ip route del default 
ip link set $<span style="color: #a0522d;">local_network</span> nomaster <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#32593;&#26725;&#20013;&#32593;&#21345;</span>
ip link set $<span style="color: #a0522d;">bridge</span> down 
ip link delete dev $<span style="color: #a0522d;">bridge</span>
ip link set $<span style="color: #a0522d;">local_network</span> down <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20851;&#38381;&#32593;&#21345;</span>
ip link set $<span style="color: #a0522d;">local_network</span> up
systemctl restart network
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6c232ebe-e354-4769-8346-6042a0479177" class="outline-5">
<h5 id="h:6c232ebe-e354-4769-8346-6042a0479177">方法3-使用nmcli命令实现创建网桥</h5>
<div class="outline-text-5" id="text-h:6c232ebe-e354-4769-8346-6042a0479177">
<div class="org-src-container">
<pre class="src src-sh">nmcli con add con-name mybr0 type bridge ifname br0
nmcli con modify mybr0 ipv4.addresses 192.168.0.100/24 ipv4.method manual
nmcli con add con-name br0-port0 type bridge-slave ifname eth0 master br0
</pre>
</div>

<p>
查看配置文件
</p>

<div class="org-src-container">
<pre class="src src-sh">cat /etc/sysconfig/network-scripts/ifcfg-br0
cat /etc/sysconfig/network-scripts/ifcfg-br0-port0
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1&#21019;&#24314;&#32593;&#26725;</span>
nmcli con add type bridge con-name br0 ifname br0
nmcli connection modify br0 ipv4.addresses 192.168.0.100/24 ipv4.method manual
nmcli con up br0

<span style="color: #b22222;">#</span><span style="color: #b22222;">2&#21152;&#20837;&#29289;&#29702;&#32593;&#21345;</span>
nmcli con add type bridge-slave con-name br0-port0 ifname eth0 master br0
nmcli con add type bridge-slave con-name br0-port1 ifname eth1 master br0
nmcli con up br0-port0
nmcli con up br0-port1

<span style="color: #b22222;">#</span><span style="color: #b22222;">3&#26597;&#30475;&#32593;&#26725;&#37197;&#32622;&#25991;&#20214;</span>
cat /etc/sysconfig/network-scripts/ifcfg-br0
<span style="color: #a0522d;">DEVICE</span>=br0
<span style="color: #a0522d;">STP</span>=yes
<span style="color: #a0522d;">TYPE</span>=Bridge
<span style="color: #a0522d;">BOOTPROTO</span>=static
<span style="color: #a0522d;">IPADDR</span>=192.168.0.100
<span style="color: #a0522d;">PREFIX</span>=24

cat /etc/sysconfig/network-scripts/ifcfg-br0-port0
<span style="color: #a0522d;">TYPE</span>=Ethernet
<span style="color: #a0522d;">NAME</span>=br0-port0
<span style="color: #a0522d;">DEVICE</span>=eth0
<span style="color: #a0522d;">ONBOOT</span>=yes
<span style="color: #a0522d;">BRIDGE</span>=br0
<span style="color: #a0522d;">UUID</span>=23f41d3b-b57c-4e26-9b17-d5f02dafd12d

<span style="color: #b22222;">#</span><span style="color: #b22222;">4&#26816;&#26597;</span>
nmcli dev show eth1
bridge link show
<span style="color: #b22222;">#</span><span style="color: #b22222;">yum install bridge-utils</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">brctl show</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">5&#21024;&#38500;br0</span>
nmcli con down br0
rm /etc/sysconfig/network-scripts/ifcfg-br0*
nmcli con reload
</pre>
</div>

<p>
<b>STP生成树协议</b>
</p>

<p>
正常情况下，三台交换机，连2条网线，但这种情况下，如果断掉一条网线，则网络就会中断，为了解决此问题，三台交换机，
连3条网线。这样，如果断了一条线，网络还是可用的，但这样会形成一个环形网络，由于交换机执行广播请求，那这种
网络会造成网络风暴，所以需要启动stp规避此问题。
</p>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:b6c93e58-d003-4146-b545-5e5b92f3516d" class="outline-2">
<h2 id="h:b6c93e58-d003-4146-b545-5e5b92f3516d">虚拟网卡</h2>
<div class="outline-text-2" id="text-h:b6c93e58-d003-4146-b545-5e5b92f3516d">
</div>
<div id="outline-container-h:7a12eef3-0aa8-4384-8e3c-3b6d433b23a3" class="outline-3">
<h3 id="h:7a12eef3-0aa8-4384-8e3c-3b6d433b23a3">网桥与网卡</h3>
<div class="outline-text-3" id="text-h:7a12eef3-0aa8-4384-8e3c-3b6d433b23a3">
<p>
如果你想要实现两台主机之间的通信，最直接的办法，就是把它们用一根网线连接起来；而如果你想要实现多台主机之间的通信，那就需要用网线，把它们连接在一台交换机上。
在 Linux
中，能够起到虚拟交换机作用的网络设备，是网桥（Bridge）。它是一个工作在数据链路层（Data
Link）的设备，主要功能是根据 MAC
地址学习来将数据包转发到网桥的不同端口（Port）上。
</p>

<p>
主机之间需要 MAC
地址才能进行通信，这就是网络分层模型的基础知识了，可参考：
</p>

<p>
<a href="https://www.lifewire.com/layers-of-the-osi-model-illustrated-818017">https://www.lifewire.com/layers-of-the-osi-model-illustrated-818017</a>
</p>
</div>
</div>
<div id="outline-container-h:3a6d1f36-7489-4413-910b-ec988f0fba2d" class="outline-3">
<h3 id="h:3a6d1f36-7489-4413-910b-ec988f0fba2d">虚拟网卡的实现原理</h3>
<div class="outline-text-3" id="text-h:3a6d1f36-7489-4413-910b-ec988f0fba2d">

<figure id="org43b7f0f">
<img src="images/image-20210202181639293.png" alt="image-20210202181639293.png" width="20%">

</figure>

<p>
linux中每当启动一个虚拟机时，在hypervisor上都会显示一张虚拟网卡，这个
虚拟网卡不但能显现在虚拟机上，还显示在物理机上且上下建立关联关系。也就
是每个虚拟网络设备都有两段组成。
</p>

<p>
如果是通过隔离模式下，各guest间实现通信都要连接在虚拟交换机上，而实际
上是物理上对应网卡的另外一半的设备连接虚拟交换机
</p>
</div>
<div id="outline-container-h:58e44b19-8e1b-4df7-97c2-6a62be8399f9" class="outline-4">
<h4 id="h:58e44b19-8e1b-4df7-97c2-6a62be8399f9">物理网卡收发数据的流程</h4>
<div class="outline-text-4" id="text-h:58e44b19-8e1b-4df7-97c2-6a62be8399f9">
<p>
物理网卡可以接收和发送数据：
</p>

<ul class="org-ul">
<li>收：外界向该物理网卡发送数据时，外界发送到网卡的数据最终会传输到内核
空间的网络协议栈中</li>
<li>发：本机要从物理网卡发送数据时，数据将从内核的网络协议栈传输到网卡，
网卡负责将数据发送出去</li>
<li>现在的网卡具备DMA能力，所以网卡和网络协议栈之间的数据传输由网卡负责，
而非由内核亲自占用CPU来执行读和写</li>
</ul>

<p>
这里可以将内核看作是一个封闭的加工厂，将物理网卡看作是加工厂的一扇门，
门的一端是加工厂，门的另一端是外界。物理网卡也一样，它的一端是内核空间
的网络协议栈，另一端是外界网络，物理网卡就是这两者之间以比特流方式收发
数据的硬件设备。
</p>


<figure id="orgcdb5ba7">
<img src="images/image-20210206153546786.png" alt="image-20210206153546786.png" width="50%">

</figure>

<p>
一般来说，数据的起点和终点是用户程序，所以多数时候的数据需要在用户空间
和内核空间(网络协议栈)再传输一次：
</p>

<ul class="org-ul">
<li>当用户进程的数据要发送出去时，数据从用户空间写入内核的网络协议栈，再
从网络协议栈传输到网卡，最后发送出去</li>
<li>当用户进程等待外界响应数据时，数据从网卡流入，传输至内核的网络协议栈，
最后数据写入用户空间被用户进程读取</li>
</ul>

<p>
在这些过程中， <code>内核和用户空间的数据传输由内核占用CPU来完成，内核和网
卡之间的数据传输由网卡的DMA来完成</code> ，不需要占用过多的CPU。
</p>


<figure id="orgc198b73">
<img src="images/image-20210206154541520.png" alt="image-20210206154541520.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:145fd559-a510-4e27-b959-ab0b0392a57a" class="outline-4">
<h4 id="h:145fd559-a510-4e27-b959-ab0b0392a57a">虚拟网卡设备</h4>
<div class="outline-text-4" id="text-h:145fd559-a510-4e27-b959-ab0b0392a57a">
<p>
物理网卡需要通过网卡驱动在内核中注册后才能工作，它在内核网络协议栈和外
界网络之间传递数据，用户可以为物理网卡配置网卡接口属性，比如IP地址，这
些属性都配置在内核的网络协议栈中。
</p>

<p>
内核也可以直接创建虚拟的网卡，只要为虚拟网卡提供网卡驱动程序，使其在内
核中可以注册成为网卡设备，它就可以工作。
</p>

<p>
其实，从Linux内核3.x版本开始，物理网卡和虚拟网卡是平等的设备，它们都会
在注册时创建net_device数据结构来保存(物理或虚拟)设备信息。
</p>

<p>
相比于物理网卡负责内核网络协议栈和外界网络之间的数据传输，虚拟网卡的两
端则是=内核网络协议栈和用户空间=，它负责在内核网络协议栈和用户空间的程
序之间传递数据：
</p>

<ul class="org-ul">
<li>发送到虚拟网卡的数据来自于用户空间，然后被内核读取到网络协议栈中</li>
<li>内核写入虚拟网卡数据，数据来源是该网卡发送过来的数据，目的地是用户空间</li>
</ul>


<figure id="org19e4050">
<img src="images/image-20210206155024824.png" alt="image-20210206155024824.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:ac59e8eb-d6f6-467a-96f0-fb9b0be8f2a8" class="outline-4">
<h4 id="h:ac59e8eb-d6f6-467a-96f0-fb9b0be8f2a8">虚拟网卡和物理网卡的对比</h4>
<div class="outline-text-4" id="text-h:ac59e8eb-d6f6-467a-96f0-fb9b0be8f2a8">
<p>
和物理网卡对比一下，物理网卡是硬件网卡，它位于硬件层，虚拟网卡则可以看
作是用户空间的网卡，就像用户空间的文件系统(fuse)一样。
</p>

<p>
物理网卡和虚拟网卡唯一的不同点在于物理网卡本身的硬件功能：物理网卡以比
特流的方式传输数据。
</p>

<p>
也就是说，内核会公平对待物理网卡和虚拟网卡，物理网卡能做的配置，虚拟网
卡也能做。比如可以为虚拟网卡接口配置IP地址、设置子网掩码，可以将虚拟网
卡接入网桥等等。
</p>

<p>
只有在数据流经物理网卡和虚拟网卡的那一刻，才会体现出它们的不同，即传输
数据的方式不同：物理网卡以比特流的方式传输数据，虚拟网卡则直接在内存中
拷贝数据(即，在内核之间和读写虚拟网卡的程序之间传输)。
</p>

<p>
正因为虚拟网卡不具备物理网卡以比特流方式传输数据的硬件功能，所以， <code>绝 不可能通过虚拟网卡向外界发送数据，外界数据也不可能直接发送到虚拟网卡上</code> 。能够直接收发外界数据的，只能是物理设备。
虽然虚拟网卡无法将数据传输到外界网络，但却：
</p>

<ul class="org-ul">
<li><code>可以将数据传输到本机的另一个网卡(虚拟网卡或物理网卡)或其它虚拟设备(如虚拟交换机)上</code></li>
<li><code>可以在用户空间运行一个可读写虚拟网卡的程序，该程序可将流经虚拟网卡
  的数据包进行处理</code> ，这个用户程序就像是物理网卡的硬件功能一样，可以收
发数据(可将物理网卡的硬件功能看作是嵌入在网卡上的程序)，比如OpenVPN
就是这样的工具很多人会误解这样的用户空间程序，认为它们可以对数据进行
封装。比如认为OpenVPN可以在数据包的基础上再封装一层隧道IP首部，但这
种理解是错的。</li>
</ul>

<p>
一定请注意， <code>用户空间的程序是无法对数据包做任何封装和解封操作的，所有
的封装和解封都只能由内核的网络协议栈来完成。</code>
</p>

<p>
使用OpenVPN之所以可以对数据再封装一层隧道IP层，是因为OpenVPN可以读取已
经封装过一次IP首部的数据，并将包含ip首部的数据作为普通数据通过虚拟网卡
再次传输给内核。因为内核接收到的是来自虚拟网卡的数据，所以内核会将其当
作普通数据从头开始封装(从四层封装到二层封装)。当数据从网络协议栈流出时，
就有了两层IP首部的封装。
</p>

<p>
换句话说，每一次看似由用户空间程序进行的额外封装，都意味着数据要从内核
空间到用户空间，再到内核空间。以OpenVPN为例：
</p>

<div class="org-src-container">
<pre class="src src-sh">tcp/ip stack --&gt; tun --&gt; OpenVPN --&gt; tcp/ip stack --&gt; Phyical NIC
</pre>
</div>

<p>
其中tun是OpenVPN创建的一个三层虚拟网卡，tun设备在用户空间和内核空间之
间传递数据。
</p>

<p>
具体的openvpn数据封装和数据流向的细节。
</p>
</div>
</div>
</div>
<div id="outline-container-h:c2f1b79c-50cd-487e-bd83-b0184ab5dd11" class="outline-3">
<h3 id="h:c2f1b79c-50cd-487e-bd83-b0184ab5dd11">虚拟网络设备 tap/tun 原理解析</h3>
<div class="outline-text-3" id="text-h:c2f1b79c-50cd-487e-bd83-b0184ab5dd11">
</div>
<div id="outline-container-h:742b861c-9aab-4a1a-ad70-766c1a4113ee" class="outline-4">
<h4 id="h:742b861c-9aab-4a1a-ad70-766c1a4113ee">linux的2种虚拟网络设备：TUN与TAP</h4>
<div class="outline-text-4" id="text-h:742b861c-9aab-4a1a-ad70-766c1a4113ee">
<p>
在计算机网络中，TUN与TAP是操作系统内核中的虚拟网络设备。不同于普通靠硬
件网路板卡实现的设备，这些虚拟的网络设备全部用软件实现，并向运行于操作
系统上的软件提供与硬件的网络设备完全相同的功能；它们都属于网络设备，都
可以配置 IP，都归 Linux 网络设备管理模块统一管理。
</p>

<p>
作为网络设备，tap/tun 也需要配套相应的驱动程序才能工作。tap/tun驱动程
序包括两个部分，一个是字符设备驱动，一个是网卡驱动。这两部分驱动程序分
工不太一样，字符驱动负责数据包在内核空间和用户空间的传送，网卡驱动负责
数据包在TCP/IP 网络协议栈上的传输和处理
</p>

<p>
<b>TAP</b> 等同于一个以太网设备，它操作第二层数据包如以太网数据帧。虚拟机间
通信是靠MAC地址
</p>

<p>
<b>TUN</b> 模拟了网络层设备，操作第三层数据包比如IP数据封包；虚拟机间通信是
靠IP地址
</p>

<p>
操作系统通过TUN/TAP设备向绑定该设备的用户空间的程序发送数据，反之，用
户空间的程序也可以像操作硬件网络设备那样，通过TUN/TAP设备发送数据。在
后一种情况下，TUN/TAP设备向操作系统的网络栈投递（或“注入”）数据包，
从而模拟从外部接受数据的过程；
</p>

<p>
tap/tun提供了一台主机内用户空间的数据传输机制。它虚拟了一套网络接口，
这套接口和物理的接口无任何区别，可以配置IP，可以路由流量，不同的是，它
的流量只在主机内流通。
</p>

<p>
tap/tun 有些许的不同，tun 只操作三层的 IP 包，而 tap操作二层的以太网帧。
</p>


<figure id="org030a206">
<img src="images/image-20210202181813395.png" alt="image-20210202181813395.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:4fbaa6e3-950a-4760-bdb0-8f2a31fa2e02" class="outline-4">
<h4 id="h:4fbaa6e3-950a-4760-bdb0-8f2a31fa2e02">用户空间与内核空间的数据传输</h4>
<div class="outline-text-4" id="text-h:4fbaa6e3-950a-4760-bdb0-8f2a31fa2e02">
<p>
在 Linux中，用户空间和内核空间的数据传输有多种方式，字符设备就是其中的
一种。tap/tun通过驱动程序和一个与之关联的字符设备，来实现用户空间和内
核空间的通信接口。
</p>

<p>
在 Linux 内核 2.6.x 之后的版本中，tap/tun 对应的字符设备文件分别为：
</p>

<ul class="org-ul">
<li>tap：/dev/tap0</li>
<li>tun：/dev/net/tun</li>
</ul>

<p>
设备文件即充当了用户空间和内核空间通信的接口。当应用程序打开设备文件时，
驱动程序就会创建并注册相应的虚拟设备接口，一般以tunX 或 tapX 命名。当
应用程序关闭文件时，驱动也会自动删除 tunX 和 tapX设备，还会删除已经建
立起来的路由等信息。
</p>

<p>
tap/tun设备文件就像一个管道，一端连接着用户空间，一端连接着内核空间。
当用户程序向文件/dev/net/tun 或 /dev/tap0 写数据时，内核就可以从对应的
tunX 或 tapX接口读到数据，反之，内核可以通过相反的方式向用户程序发送数
据。
</p>


<figure id="org6fe307d">
<img src="images/image-20210202181830272.png" alt="image-20210202181830272.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:752acebd-13d6-4a75-ac58-6bc467eda632" class="outline-4">
<h4 id="h:752acebd-13d6-4a75-ac58-6bc467eda632">tap/tun 和网络协议栈的数据传输</h4>
<div class="outline-text-4" id="text-h:752acebd-13d6-4a75-ac58-6bc467eda632">
<p>
tap/tun通过实现相应的网卡驱动程序来和网络协议栈通信。一般的流程和物理
网卡和协议栈的交互流程是一样的，不同的是物理网卡一端是连接物理网络，而
tap/tun 虚拟网卡一般连接到用户空间。
</p>

<p>
如下图的示意图，我们有两个应用程序 A、B，物理网卡 eth0 和虚拟网卡 tun0
分别配置 IP：10.1.1.11 和 192.168.1.11，程序 A 希望构造数据包发往
192.168.1.0/24 网段的主机 192.168.1.1。
</p>


<figure id="org22714c8">
<img src="images/image-20210202182007828.png" alt="image-20210202182007828.png" width="20%">

</figure>

<p>
基于上图，我们看看数据包的流程：
</p>

<ol class="org-ol">
<li>应用程序 A 构造数据包，目的 IP 是 192.168.1.1，通过 socket A将这个
数据包发给协议栈。</li>
<li>协议栈根据数据包的目的 IP 地址，匹配路由规则，发现要从 tun0 出去。</li>
<li>tun0 发现自己的另一端被应用程序 B 打开了，于是将数据发给程序 B.</li>
<li>程序 B 收到数据后，做一些跟业务相关的操作，然后构造一个新的数据包，
源IP 是 eth0 的 IP，目的 IP 是 10.1.1.0/24 的网关10.1.1.1，封装原来
的数据的数据包，重新发给协议栈。</li>
<li>协议栈再根据本地路由，将这个数据包从 eth0 发出。</li>
</ol>

<p>
后续步骤，当 10.1.1.1收到数据包后，会进行解封装，读取里面的原始数据包，
继而转发给本地的主机192.168.1.1。当接收回包时，也遵循同样的流程。
</p>

<p>
在这个流程中，应用程序 B 的作用其实是利用 tun0对数据包做了一层隧道封装。
其实 tun 设备的最大用途就是用于隧道通信的。
</p>
</div>
</div>
<div id="outline-container-h:7a7840c1-e3ed-4765-a2c1-632c58ca990e" class="outline-4">
<h4 id="h:7a7840c1-e3ed-4765-a2c1-632c58ca990e">tap/tun 的区别</h4>
<div class="outline-text-4" id="text-h:7a7840c1-e3ed-4765-a2c1-632c58ca990e">
<p>
看到这里，你可能还不大明白 tap/tun 的区别。
</p>

<p>
tap 和 tun虽然都是虚拟网络设备，但它们的工作层次还不太一样。
</p>

<ul class="org-ul">
<li>tap 是一个二层设备（或者以太网设备），只能处理二层的以太网帧；</li>
<li>tun 是一个点对点的三层设备（或网络层设备），只能处理三层的 IP 数据包。</li>
</ul>
</div>
</div>
<div id="outline-container-h:8818ba82-3deb-4790-836c-dc946e89dd58" class="outline-4">
<h4 id="h:8818ba82-3deb-4790-836c-dc946e89dd58">tap/tun 的应用</h4>
<div class="outline-text-4" id="text-h:8818ba82-3deb-4790-836c-dc946e89dd58">
<p>
从上面的数据流程中可以看到，tun 设备充当了一层隧道，所以，tap/tun最常
见的应用也就是用于隧道通信，比如 VPN，包括 tunnel 和应用层的 IPsec等，
其中比较有名的两个开源项目是 openvpn 和 VTun。
</p>

<p>
常见用法：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314; tap/tun &#35774;&#22791;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#21629;&#20196;&#21019;&#24314;tun&#12289;tap&#35774;&#22791;&#30340;&#26041;&#24335;&#26377;&#22810;&#31181;&#65292;&#27604;&#22914;openvpn --mktun&#12289;ip tuntap&#12289;tunctl&#31561;</span>
ip tuntap add dev tap0 mod tap <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314; tap </span>
ip tuntap add dev tun0 mod tun <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314; tun</span>

openvpn --mktun --dev tun0
openvpn --mktun --dev tap0

tunctl -t tap0      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;&#21019;&#24314;tap&#35774;&#22791;</span>
tunctl -n -t tap0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500; tap/tun &#35774;&#22791;&#65306;</span>
ip tuntap del dev tap0 mod tap <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500; tap </span>
ip tuntap del dev tun0 mod tun <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500; tun</span>
PS: user &#21644; group &#21442;&#25968;&#21644; tunctl &#30340; -u&#12289; -g &#21442;&#25968;&#26159;&#19968;&#26679;&#30340;&#12290;

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#20026;tun/tap&#20998;&#37197;IP&#22320;&#22336;&#25110;&#37197;&#32622;&#20854;&#23427;&#23646;&#24615;</span>
ifconfig tun0 10.0.0.33 up
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25110;&#32773;</span>
ip link set tun0 up
ip addr add 10.0.0.33/24 dev tun0
</pre>
</div>


<p>
<a href="https://www.cnblogs.com/bakari/p/10449664.html">https://www.cnblogs.com/bakari/p/10449664.html</a>
</p>


<figure id="org2f6886f">
<img src="images/image-20210202182031676.png" alt="image-20210202182031676.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#26725;</span>
ip link add br0 type bridge stp_state on
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;macvtap&#31867;&#22411;&#65292;&#30452;&#36830;&#29289;&#29702;&#32593;&#32476;&#65292;kvm virt-manager&#21019;&#24314;&#34394;&#25311;&#26426;&#29992;&#21040;&#36807;</span>
ip link add link xu0  xu2 type macvtap mode bridge
ip link show type macvtap
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;tap&#31867;&#22411;(&#34394;&#25311;&#32593;&#21345;)&#65292;&#25163;&#21160;&#26725;&#19979;&#29992;&#21040;&#65292;</span>
ip tuntap add xu3 mode tap user root
ip link set xu3 master xu0
ip  tuntap show

[root@node01 ~]# ip a
5: xu0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether 4e:1e:15:04:21:a3 brd ff:ff:ff:ff:ff:ff
7: xu2@xu0: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN group default qlen 500
    link/ether 36:6d:69:3c:82:27 brd ff:ff:ff:ff:ff:ff
8: xu3: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop master xu0 state DOWN group default qlen 1000
    link/ether 4e:1e:15:04:21:a3 brd ff:ff:ff:ff:ff:ff
[root@node01 ~]# brctl show
bridge name bridge id       STP enabled interfaces
xu0     8000.4e1e150421a3   yes     xu3
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:fdf02f96-8773-4b17-8cea-528e615b18b6" class="outline-3">
<h3 id="h:fdf02f96-8773-4b17-8cea-528e615b18b6">网络虚拟化技术tap+bridge</h3>
<div class="outline-text-3" id="text-h:fdf02f96-8773-4b17-8cea-528e615b18b6">
<p>
传统的linux网络虚拟化技术采用的是tap+bridge方式，将虚拟机连接到虚拟的
tap网卡，然后将tap网卡加入到bridge。bridge相当于用软件实现的交换机，这
种解决方案实际上就是用服务器的cpu通过软件模拟网络。
</p>

<p>
传统的tap+bridge虚拟化网络技术，这种技术有三个缺点：
</p>

<ol class="org-ol">
<li>每台宿主机内都存在bridge会使网络拓扑变复杂，相当于增加了交换机的级联层数；</li>

<li>同一宿主机上的虚拟机之间的流量直接在bridge完成交换，使流量监控、监管困难；</li>

<li><p>
bridge是软件实现的二层交换技术，会加大服务器的负担。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1. &#21019;&#24314;&#26725;&#35774;&#22791;</span>
<span style="color: #a0522d;">br</span>=<span style="color: #8b2252;">"br0"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#34394;&#25311;&#32593;&#21345;mytap01&#65292; &#37197;&#32622;&#19978;IP&#24182;&#28608;&#27963;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">tunctl -u `whoami` -t $1</span>
ip tuntap add mytap01  mode tap user <span style="color: #ff00ff;">`whoami`</span> &amp;&amp; ip link set hd1 up
ip addr add 10.100.21.134/32 dev mytap01
ip tuntap show

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#26725;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">brctl addbr $switch &amp;&amp; brctl stp $switch on</span>
ip link add $<span style="color: #a0522d;">br</span> type bridge stp_state 1 &amp;&amp; ip link set $<span style="color: #a0522d;">br</span> up
ip link show type bridge

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#32852;&#26725;</span>
ip link set mytap01 master $<span style="color: #a0522d;">br</span>
ip addr flush dev mytap01 &amp;&amp; ip addr add 10.100.21.134/32  dev $<span style="color: #a0522d;">br</span> &amp;&amp; ip link set $<span style="color: #a0522d;">br</span> up
ip link show type bridge
ip link show master $<span style="color: #a0522d;">br</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#36335;&#30001;</span>
</pre>
</div></li>
</ol>

<p>
如何配置？
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1) &#23545;&#20110;qemu command line&#26041;&#24335;&#65306;</span>
qemu-system-x86_64 -m 2048 -enable-kvm <span style="color: #8b2252;">\</span>
-netdev bridge,<span style="color: #a0522d;">br</span>=br0,<span style="color: #a0522d;">id</span>=br-new <span style="color: #8b2252;">\</span>
-device virtio-net,<span style="color: #a0522d;">netdev</span>=br-new,<span style="color: #a0522d;">id</span>=net0 <span style="color: #8b2252;">\</span>
...

<span style="color: #b22222;"># </span><span style="color: #b22222;">2) &#23545;&#20110;libvirt xml&#30340;&#26041;&#24335;&#65306;</span>
    &lt;interface <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'bridge'</span>&gt;
      &lt;source <span style="color: #a0522d;">bridge</span>=<span style="color: #8b2252;">'br0'</span>/&gt;
      &lt;model <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'virtio'</span>/&gt;
      &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x00'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x01'</span> <span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x0'</span>/&gt;
    &lt;/interface&gt;

<span style="color: #b22222;"># </span><span style="color: #b22222;">3) &#23545;&#20110;virt-install&#30340;&#26041;&#24335;&#65306;</span>

virt-install -n centos6.7 -r 512 --vcpus=2,<span style="color: #a0522d;">maxvcpus</span>=4 --pxe --disk /images/centos/centos6.7.qcow2,<span style="color: #a0522d;">size</span>=120,<span style="color: #a0522d;">format</span>=qcow2,<span style="color: #a0522d;">bus</span>=virtio,<span style="color: #a0522d;">sparse</span>=yes --network <span style="color: #a0522d;">bridge</span>=br0,<span style="color: #a0522d;">model</span>=virtio --force
</pre>
</div>
</div>
</div>
<div id="outline-container-h:74ec7291-dcfc-485c-a6be-febe433d8d99" class="outline-3">
<h3 id="h:74ec7291-dcfc-485c-a6be-febe433d8d99">网络虚拟化技术macvtap+brdige</h3>
<div class="outline-text-3" id="text-h:74ec7291-dcfc-485c-a6be-febe433d8d99">
<p>
<a href="https://blog.csdn.net/dylloveyou/article/details/53283598">macvtap简介</a>
</p>


<figure id="orgb12c0c2">
<img src="images/image-20210202182214854.png" alt="image-20210202182214854.png" width="20%">

</figure>

<p>
kvm创建桥参考<a href="http://www.linux-kvm.org/page/Networking">http://www.linux-kvm.org/page/Networking</a>
<a href="https://www.cnblogs.com/echo1937/p/7249812.html">macvtap与vhost-net技术</a>
</p>

<p>
针对云计算中的复杂网络问题，业界主要提出了两种扩展技术标准：802.1Qbg
与802.1Qbh。802.1Qbh Bridge Port Extension 主要由Vmware与 Cisco提出，
尝试从接入层到汇聚层提供一个完整的虚拟化网络解决方案，尽可能达到软件定
义一个可控网络的目的。它扩展了传统的网络协议，因此需要新的网络设备支持，
成本较高。802.1Qbg Edge Virtual Bridging (EVB) 主要由 HP等公司联合提出，
尝试以较低成本利用现有设备改进软件模拟的网络。
</p>

<p>
802.1Qbg 的一个核心概念是 VEPA（Virtual Ethernet Port Aggregator )，简
单来说它通过端口汇聚和数据分类转发，把宿主机上原来由 CPU和软件来做的网
络处理工作转移到接入层交换机上，减少宿主机CPU负载，同时使得在一级的交
换机上做虚拟机网络流量监控成为可能，从而更清晰地分割服务器与网络设备的
工作范围，方便系统的管理。
</p>

<p>
为支持新的虚拟化网络技术，Linux 引入了新的网络设备模型：MACVTAP。
MACVTAP的实现基于传统的 MACVLAN。和 TAP 设备一样，每一个 MACVTAP设备拥
有一个对应的 Linux 字符设备，并拥有和 TAP 设备一样的 IOCTL接口，因此能
直接被 KVM/Qemu使用，方便地完成网络数据交换工作。引入MACVTAP 设备的目
标是：简化虚拟化环境中的交换网络，代替传统的 Linux TAP设备加 Bridge 设
备组合，同时支持新的虚拟化网络技术，如 802.1 Qbg。
</p>

<p>
macvtap设备有三种不同的工作模式：Virtual Ethernet Port
Aggregator(VEPA)、Bridge、Private。
</p>

<ul class="org-ul">
<li><p>
VEPA（默认）在这种
</p>

<p>
模式下，同一物理网卡下的macvtap设备之间的流量也要发送到外部交换机，
再由外部交换机转发回到服务器，前提是交换机必须支持hairpin模式；
</p></li>
<li><p>
Bridge 这种模式类似传统Linux
</p>

<p>
Bridge，同一物理网卡下的macvtap设备可以直接进行以太网帧的交换，不需
要外部交换机的介入；
</p></li>

<li><p>
Private
</p>

<p>
在Private模式下，同一物理网卡下的macvtap设备互相无法连通，无论外部交
换机支不支持hairpin模式。
</p></li>
</ul>

<p>
综上，结论如下：
</p>

<ol class="org-ol">
<li>对于有交换机支持的网络中

<ul class="org-ul">
<li>使用VEPA模式和bridge模式都可以实现物理机与虚拟机之间的所有通信。</li>
</ul></li>

<li>在无交换机支持的网络中，

<ul class="org-ul">
<li>使用VEPA模式，虚拟机之间及物理机与虚拟机之间不能进行任何形式的通信；</li>
<li>使用bridge模式，虚拟机之间可以正常通信，虚拟机与物理机不能正常通信。</li>
</ul></li>
</ol>

<p>
创建macvtap
</p>

<div class="org-src-container">
<pre class="src src-sh">ip link add link eth0  xu-macvtap0 type macvtap mode bridge
<span style="color: #b22222;">#</span><span style="color: #b22222;">ip link set macvtap0 address 1a:2b:3c:4d:5e:6a up </span>
ip link set  xu-macvtap0  up
ip link show type macvtap

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#21040;&#35813;&#35774;&#22791;&#23545;&#24212;&#20102;/dev/tap8 (qemu&#21629;&#20196;&#34892;&#20013;&#20250;&#29992;&#21040;)</span>
[root@node01 kvm]# cat /sys/class/net/xu-macvtap0/ifindex 
8
[root@node01 kvm]# cat /sys/class/net/xu-macvtap0/address 
8e:c7:d9:f1:0d:4a
[root@node01 kvm]# ls /sys/devices/virtual/net/xu-macvtap0/macvtap/tap8
dev  device  power  subsystem  uevent
[root@node01 kvm]# ip a |grep xu-macvtap0
8: xu-macvtap0@eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 500
[root@node01 kvm]# ip a |grep xu-macvtap0|cut -t: -f 1
cut: invalid option -- <span style="color: #8b2252;">'t'</span>
Try <span style="color: #8b2252;">'cut --help'</span> for more information.
[root@node01 kvm]# ip a |grep xu-macvtap0|cut -d: -f 1
8
</pre>
</div>

<p>
参考：virbr0/macvtap/bridge) to add the netdev for the vm
</p>

<p>
<a href="https://blog.csdn.net/Shirleylinyuer/article/details/79390388">https://blog.csdn.net/Shirleylinyuer/article/details/79390388</a>
</p>

<p>
如何配置？
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1) qemu command line&#30340;&#26041;&#24335;&#65306;</span>
qemu-system-x86_64 -m 2048 -enable-kvm <span style="color: #8b2252;">\</span>
-netdev tap,<span style="color: #a0522d;">id</span>=macvtap-test,<span style="color: #a0522d;">fd</span>=3 3&lt;&gt;/dev/tap8 <span style="color: #8b2252;">\</span>
-device virtio-net,<span style="color: #a0522d;">netdev</span>=macvtap-test,<span style="color: #a0522d;">id</span>=net0,<span style="color: #a0522d;">mac</span>=0e:83:9f:cb:07:84 <span style="color: #8b2252;">\</span>
...

<span style="color: #b22222;"># </span><span style="color: #b22222;">2) &#23545;&#20110;libvirt xml&#30340;&#26041;&#24335;&#65292;&#21442;&#25968;&#23450;&#20041;&#20026;&#65306;</span>
    &lt;interface <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'direct'</span>&gt;
      &lt;source <span style="color: #a0522d;">dev</span>=<span style="color: #8b2252;">'eth0'</span> <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">'bridge'</span>/&gt;
      &lt;target <span style="color: #a0522d;">dev</span>=<span style="color: #8b2252;">'macvtap-test'</span>/&gt;
      &lt;model <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'virtio'</span>/&gt;
      &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x00'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x02'</span> <span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x0'</span>/&gt;
    &lt;/interface&gt;

<span style="color: #b22222;"># </span><span style="color: #b22222;">3) &#23545;&#20110;virt-install&#30340;&#26041;&#24335;&#65306;</span>
virt-install ...<span style="color: #8b2252;">\</span>
--network <span style="color: #a0522d;">type</span>=direct,<span style="color: #a0522d;">source</span>=eth0,<span style="color: #a0522d;">source_mode</span>=bridge,<span style="color: #a0522d;">model</span>=virtio <span style="color: #8b2252;">\</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7f7d2dc2-881f-4df2-85fb-07328074f9a1" class="outline-3">
<h3 id="h:7f7d2dc2-881f-4df2-85fb-07328074f9a1">网络虚拟化技术veth-pair+brdige</h3>
<div class="outline-text-3" id="text-h:7f7d2dc2-881f-4df2-85fb-07328074f9a1">
<p>
<a href="https://www.cnblogs.com/bakari/p/10613710.html">https://www.cnblogs.com/bakari/p/10613710.html</a>
</p>

<p>
Veth Pair 设备的特点是：它被创建出来后，总是以两张虚拟网卡（Veth Peer）
的形式成对出现的。并且，从其中一个”网卡”发出的数据包，可以直接出现在
与它对应的另一张”网卡”上，哪怕这两个”网卡”在不同的Network
Namespace 里。
</p>

<p>
这就使得 Veth Pair 常常被用作连接不同 Network Namespace 的”网线”。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#19968;&#23545; veth-pair veth0 veth1</span>
ip l a veth0 type veth peer name veth1
</pre>
</div>

<p>
范例：两对 veth-pair 分别将两个 namespace 连到 Bridge 上。
</p>


<figure id="org6fc48c6">
<img src="images/image-20210206164113220.png" alt="image-20210206164113220.png" width="50%">

</figure>

<p>
同样给 veth-pair 配置 IP，测试其连通性：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#39318;&#20808;&#21019;&#24314; bridge br0</span>
ip l a br0 type bridge
ip l s br0 up 

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#28982;&#21518;&#21019;&#24314;&#20004;&#23545; veth-pair</span>
ip l a veth0 type veth peer name br-veth0
ip l a veth1 type veth peer name br-veth1

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20998;&#21035;&#23558;&#20004;&#23545; veth-pair &#21152;&#20837;&#20004;&#20010; ns &#21644; br0</span>
ip l s veth0 netns ns1
ip l s br-veth0 master br0
ip l s br-veth0 up

ip l s veth1 netns ns2
ip l s br-veth1 master br0
ip l s br-veth1 up

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32473;&#20004;&#20010; ns &#20013;&#30340; veth &#37197;&#32622; IP &#24182;&#21551;&#29992;</span>
ip netns exec ns1 ip a a 10.1.1.2/24 dev veth0
ip netns exec ns1 ip l s veth0 up

ip netns exec ns2 ip a a 10.1.1.3/24 dev veth1
ip netns exec ns2 ip l s veth1 up

<span style="color: #b22222;"># </span><span style="color: #b22222;">veth0 ping veth1</span>
[root@localhost ~]# ip netns exec ns1 ping 10.1.1.3
PING 10.1.1.3 (10.1.1.3) 56(84) bytes of data.
64 bytes from 10.1.1.3: <span style="color: #a0522d;">icmp_seq</span>=1 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.060 ms
64 bytes from 10.1.1.3: <span style="color: #a0522d;">icmp_seq</span>=2 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.105 ms

--- 10.1.1.3 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 999ms
rtt min/avg/max/mdev = 0.060/0.082/0.105/0.024 ms
</pre>
</div>

<p>
<b>docker容器之间访问也采用一样的原理</b>
</p>

<p>
范例：
</p>

<p>
docker nginx-1 172.17.0.2
</p>

<p>
docker nginx-2 172.17.0.3
</p>


<figure id="org42dc735">
<img src="images/image-20210206164255399.png" alt="image-20210206164255399.png" width="50%">

</figure>

<p>
其原理如下： 当你在 nginx-1 容器里访问 nginx-2 容器的 IP 地址（比如
ping 172.17.0.3）的时候，这个目的 IP 地址会匹配到 nginx-1容器里的第二
条路由规则。可以看到，这条路由规则的网关（Gateway）是0.0.0.0，这就意味
着这是一条直连规则，即：凡是匹配到这条规则的 IP包，应该经过本机的 eth0
网卡，通过二层网络直接发往目的主机。
</p>

<p>
而要通过二层网络到达 nginx-2 容器，就需要有 172.17.0.3 这个 IP地址对应
的 MAC 地址。所以 nginx-1 容器的网络协议栈，就需要通过 eth0网卡发送一
个 ARP 广播，来通过 IP 地址查找对应的 MAC地址。备注：ARP（Address
Resolution Protocol），是通过三层的 IP地址找到对应的二层 MAC 地址的协
议。
</p>

<p>
这个 eth0 网卡，是一个 Veth Pair，它的一端在这个 nginx-1 容器的
Network Namespace 里，而另一端则位于宿主机上（Host Namespace），并且被
“插”在了宿主机的 docker0 网桥上。
</p>

<p>
一旦一张虚拟网卡被“插”在网桥上，它就会变成该网桥的“从设备”。从设备
会被“剥夺”调用网络协议栈处理数据包的资格，从而“降级”成为网桥上的一
个端口。而这个端口唯一的作用，就是接收流入的数据包，然后把这些数据包的
“生杀大权”（比如转发或者丢弃），全部交给对应的网桥。
</p>

<p>
所以，在收到这些 ARP 请求之后，docker0 网桥就会扮演二层交换机的角色，
把ARP 广播转发到其他被“插”在 docker0 上的虚拟网卡上。这样，同样连接
在docker0 上的 nginx-2 容器的网络协议栈就会收到这个 ARP 请求，从而将
172.17.0.3 所对应的 MAC 地址回复给 nginx-1 容器。
</p>

<p>
有了这个目的 MAC 地址，nginx-1 容器的 eth0 网卡就可以将数据包发出去。
</p>

<p>
而根据 Veth Pair 设备的原理，这个数据包会立刻出现在宿主机上的
veth9c02e56 虚拟网卡上。不过，此时这个 veth9c02e56网卡的网络协议栈的资
格已经被“剥夺”，所以这个数据包就直接流入到了 docker0网桥里。
</p>

<p>
docker0 处理转发的过程，则继续扮演二层交换机的角色。此时，docker0网桥
根据数据包的目的 MAC 地址（也就是 nginx-2 容器的 MAC 地址），在它的CAM
表（即交换机通过 MAC 地址学习维护的端口和 MAC地址的对应表）里查到对应
的端口（Port）为：vethb4963f3，然后把数据包发往这个端口。
</p>

<p>
而这个端口，正是 nginx-2 容器“插”在 docker0网桥上的另一块虚拟网卡，
当然，它也是一个 Veth Pair设备。这样，数据包就进入到了 nginx-2 容器的
Network Namespace 里。
</p>

<p>
所以，nginx-2 容器看到的情况是，它自己的 eth0网卡上出现了流入的数据包。
这样，nginx-2的网络协议栈就会对请求进行处理，最后将响应（Pong）返回到
nginx-1。
</p>

<p>
以上，就是同一个宿主机上的不同容器通过 docker0 网桥进行通信的流程了。
</p>

<p>
需要注意的是，在实际的数据传递时，上述数据的传递过程在网络协议栈的不同
层次，都有Linux 内核 Netfilter 参与其中。所以，如果感兴趣的话，你可以
通过打开iptables 的 TRACE 功能查看到数据包的传输过程，具体方法如下所示：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;&#23487;&#20027;&#26426;&#19978;&#25191;&#34892;</span>
iptables -t raw -A OUTPUT -p icmp -j TRACE
iptables -t raw -A PREROUTING -p icmp -j TRACE
</pre>
</div>

<p>
通过上述设置，你就可以在 /var/log/syslog 里看到数据包传输的日志了。
</p>

<p>
同样我们还可以推出docker容器和其它宿主机之间通信原理：
</p>

<p>
当一个容器试图连接到另外一个宿主机时，比如：ping 10.168.0.3，它发出的
请求数据包，首先经过 docker0网桥出现在宿主机上。然后根据宿主机的路由表
里的直连路由规则（10.168.0.0/24 via eth0)），对 10.168.0.3 的访问请求
就会交给宿主机的 eth0 处理。
</p>


<figure id="orge07e87a">
<img src="images/image-20210206165223582.png" alt="image-20210206165223582.png" width="50%">

</figure>

<p>
<code>同样我们还可以推出不同宿主机之间容器通信(跨主通信)原理</code> ：
</p>

<p>
我们通过软件的方式，创建一个整个集群“公用”的网桥，然后把集群里的所有
容器都连接到这个网桥上
</p>


<figure id="org72a2e21">
<img src="images/image-20210206165647347.png" alt="image-20210206165647347.png" width="50%">

</figure>

<p>
构建这种容器网络的核心在于：我们需要在已有的宿主机网络上，再通过软件构
建一个覆盖在已有宿主机网络之上的、可以把所有容器连通在一起的虚拟网络。
所以，这种技术就被称为：Overlay Network（覆盖网络）
</p>

<p>
软件实现
</p>

<ul class="org-ul">
<li>flannel 支持：VXLAN；host-gw；UDP(性能差)</li>
<li>calico 与host-gw模样几乎一样</li>
</ul>


<figure id="orgd3dff8a">
<img src="images/image-20210206171151121.png" alt="image-20210206171151121.png" width="50%">

</figure>


<figure id="orge914ba3">
<img src="images/image-20210206171203487.png" alt="image-20210206171203487.png" width="50%">

</figure>


<figure id="org4d9e6c9">
<img src="images/image-20210206171306712.png" alt="image-20210206171306712.png" width="50%">

</figure>

<p>
k8s 使用CNI网桥接口代替docker0
</p>


<figure id="org133c631">
<img src="images/image-20210206171431729.png" alt="image-20210206171431729.png" width="50%">

</figure>


<figure id="org4d6b51d">
<img src="images/image-20210206171740361.png" alt="image-20210206171740361.png" width="50%">

</figure>


<figure id="orgecc715a">
<img src="images/image-20210206172054976.png" alt="image-20210206172054976.png" width="50%">

</figure>


<figure id="org634b712">
<img src="images/image-20210206172107825.png" alt="image-20210206172107825.png" width="50%">

</figure>
</div>
</div>
</section>
<section id="outline-container-h:673ee247-f4ab-4595-a1fc-42608befae16" class="outline-2">
<h2 id="h:673ee247-f4ab-4595-a1fc-42608befae16">网络测试诊断工具</h2>
<div class="outline-text-2" id="text-h:673ee247-f4ab-4595-a1fc-42608befae16">
<ul class="org-ul">
<li><p>
测试网络连通性 ping
</p>

<p>
htping (epel源提供package: hping3)
</p>

<p>
httpstat
</p></li>

<li>显示正确的路由表 ip route</li>

<li>跟踪路由 traceroute tracepath mtr</li>

<li>确定名称服务器使用 nslookup host dig</li>

<li>抓包工具 tcpdump wireshark</li>

<li>安全扫描工具 nmap netcat ：网络界的瑞士军刀，即nc</li>

<li>流量控制工具 tc</li>
</ul>
</div>
<div id="outline-container-h:14ae64a0-5fc2-40ef-9620-fafe32af3071" class="outline-3">
<h3 id="h:14ae64a0-5fc2-40ef-9620-fafe32af3071">测试网络连通性</h3>
<div class="outline-text-3" id="text-h:14ae64a0-5fc2-40ef-9620-fafe32af3071">
</div>
<div id="outline-container-h:33224ebe-a0fe-43b6-9dbc-25578659225a" class="outline-4">
<h4 id="h:33224ebe-a0fe-43b6-9dbc-25578659225a">ping</h4>
<div class="outline-text-4" id="text-h:33224ebe-a0fe-43b6-9dbc-25578659225a">
<div class="org-src-container">
<pre class="src src-sh">&#25925;&#38556;1&#65306;
cennect:Network is unreachable &#32593;&#32476;&#19981;&#21487;&#36798;&#65292;&#19968;&#33324;&#20026;&#36335;&#30001;&#32570;&#22833;
&#25925;&#38556;2&#65306;
From 10.0.0.8 <span style="color: #a0522d;">icmp_seq</span>=1 Destination Host Unreachable &#30446;&#26631;&#20027;&#26426;&#21487;&#36798;&#65292;&#21487;&#33021;&#26159;&#36335;&#24452;&#38169;&#35823;&#12290;ping &#36335;&#30001;&#22320;&#22336;&#26159;&#21542;&#27491;&#30830;
&#25925;&#38556;3&#65306;
ping: www.baidu.com: Name or service not known  &#26080;&#27861;&#35299;&#26512;&#25104;ip&#22320;&#22336; &#26597;&#30475;dns&#37197;&#32622;&#25991;&#20214;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">-c <span style="color: #b22222;">#           </span><span style="color: #b22222;">#&#21457;&#36865;&#30340;ping&#21253;&#20010;&#25968;&#65307;</span>
-w <span style="color: #b22222;">#          </span><span style="color: #b22222;">#ping&#21629;&#20196;&#36229;&#26102;&#26102;&#38271;&#65307;</span>
-W <span style="color: #b22222;">#         </span><span style="color: #b22222;">#&#19968;&#27425;ping&#25805;&#20316;&#20013;&#65292;&#31561;&#24453;&#23545;&#26041;&#21709;&#24212;&#30340;&#36229;&#26102;&#26102;&#38271;&#65307;</span>
-f               <span style="color: #b22222;">#</span><span style="color: #b22222;">flood ping</span>
-s <span style="color: #b22222;">#           </span><span style="color: #b22222;">#&#25351;&#23450;&#21517;ping&#21253;&#25253;&#25991;&#22823;&#23567;&#65307;</span>
&#27880;&#24847;&#65306;ddos&#25915;&#20987;&#65292;1W&#21488;&#20027;&#26426;&#27861;ping&#21253;
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748; ICMP &#25968;&#25454;&#25253;&#25991;&#21253;&#30340;&#22823;&#23567;&#20026; 64 &#20010;&#23383;&#33410;&#65292;&#21487;&#20197;&#25351;&#23450;&#22823;&#23567;&#65292;&#26368;&#22823; 65507&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20294;&#20197;&#22826;&#32593;&#25968;&#25454;&#24103;&#30340;&#22823;&#23567;&#20026; 46-1500 &#20301;&#65292;&#35774;&#32622; 65507 &#20250;&#25226;&#23427;&#20999;&#25104;&#23567;&#21253;</span>
[root@centos8 ~]#ping -s 65508 10.0.0.8 
Error: packet size 65508 is too large. Maximum is 65507


<span style="color: #b22222;">#</span><span style="color: #b22222;">-f flood &#23454;&#29616;&#32593;&#32476;&#30340;&#25915;&#20987;</span>
[root@centos8 ~]#ping -s 65507 -f 10.0.0.8 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26368;&#22823;&#21457;&#36865;65507 &#23383;&#33410;&#30340;&#21253;  -f &#23613;CPU&#25152;&#33021;</span>
PING 172.16.21.111 (172.16.21.111) 65507(65535) bytes of data.
........................................................

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23454;&#26102;&#21047;&#26032;&#32593;&#21345;&#25968;&#25454;</span>
watch ifconfig eth0


[root@proxy ~]# ping 127.0.0.01
PING 127.0.0.01 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: <span style="color: #a0522d;">icmp_seq</span>=1 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.033 ms
^C
--- 127.0.0.01 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 1999ms
rtt min/avg/max/mdev = 0.033/0.040/0.044/0.007 ms

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35828;&#26126;</span>
64 bytes from    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#23545;&#26041;&#20027;&#26426;&#22238;&#24212;&#30340;64&#23383;&#33410;&#30340;&#25253;&#25991;</span>
icmp_seq            <span style="color: #b22222;">#</span><span style="color: #b22222;">icmp&#32534;&#21495;&#65292;&#39034;&#24207;&#32047;&#21152;</span>
<span style="color: #a0522d;">ttl</span>=64                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#21253;&#30340;&#29983;&#23384;&#26102;&#38388;&#65292;&#20320;&#21487;&#20197;&#21435;&#25913;&#23427;&#65292;&#26377;&#30340;&#31995;&#32479;&#26159;256&#26377;&#30340;&#26159;128&#26377;&#30340;&#26159;64&#20063;&#26377;32&#30340;&#65292;</span>
                            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#19968;&#20010;&#25968;&#25454;&#21253;&#32463;&#36807;&#19968;&#20010;&#36335;&#30001;&#30340;&#26102;&#20505;&#36825;&#20010;&#26102;&#38388;&#23601;&#20250;&#20943;&#19968;&#65292;&#24403;TTL&#65309;1&#30340;&#26102;&#20505;&#25968;&#25454;&#21253;&#36824;&#27809;&#26377;&#21040;&#36798;&#30446;&#30340;&#22320;&#30340;&#26102;&#20505;&#65292;&#25968;&#25454;&#21253;&#23601;&#20250;&#34987;&#20002;&#24323;&#20102;</span>
<span style="color: #a0522d;">time</span>=0.307 ms  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22238;&#24212;&#25253;&#25991;&#33457;&#36153;&#26102;&#38388;</span>
rtt min/avg/max/mdev  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#33324;&#20851;&#27880;&#24179;&#22343;&#20540;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9c923c9f-7494-40b7-a141-e16cd1b3b8c4" class="outline-4">
<h4 id="h:9c923c9f-7494-40b7-a141-e16cd1b3b8c4">htping</h4>
<div class="outline-text-4" id="text-h:9c923c9f-7494-40b7-a141-e16cd1b3b8c4">
<p>
(epel源提供package: hping3)
</p>

<p>
send (almost) arbitrary TCP/IP packets to network hosts
发送直接TCP/IP报文
</p>

<div class="org-src-container">
<pre class="src src-sh">--fast &#24555;&#36895;&#21457;ping&#21253;&#65292;1&#31186;10&#20010;&#65307;
--faster &#33021;&#21457;&#22810;&#22359;&#21457;&#22810;&#24555;
--flood  
-S &#21442;&#25968;&#34920;&#31034;&#35774;&#32622; TCP &#21327;&#35758;&#30340; SYN&#65288;&#21516;&#27493;&#24207;&#21015;&#21495;&#65289;&#65292;
-p &#34920;&#31034;&#30446;&#30340;&#31471;&#21475;&#20026; 80
-i uX &#65306;&#25351;&#26126;&#26102;&#38388;&#38388;&#38548;&#65292;u&#34920;&#31034;&#24494;&#31186;&#65307;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">-i u100 &#34920;&#31034;&#27599;&#38548; 100 &#24494;&#31186;&#21457;&#36865;&#19968;&#20010;&#32593;&#32476;&#24103;&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#65306;&#22914;&#26524;&#20320;&#22312;&#23454;&#36341;&#36807;&#31243;&#20013;&#29616;&#35937;&#19981;&#26126;&#26174;&#65292;&#21487;&#20197;&#23581;&#35797;&#25226; 100 &#35843;&#23567;&#65292;&#27604;&#22914;&#35843;&#25104; 10 &#29978;&#33267; 1</span>
$ hping3 -S -p 80 -i u100 192.168.0.30
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b03ffb85-175a-4732-bf3b-21a26d1fe884" class="outline-4">
<h4 id="h:b03ffb85-175a-4732-bf3b-21a26d1fe884">httpstat</h4>
<div class="outline-text-4" id="text-h:b03ffb85-175a-4732-bf3b-21a26d1fe884">
<div class="org-src-container">
<pre class="src src-sh">pip install httpstat

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;</span>
httpstat URL
</pre>
</div>


<figure id="org6193698">
<img src="images/image-20210304150141422.png" alt="image-20210304150141422.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:3b775cea-b4e1-4396-9ca0-2487bce64a78" class="outline-4">
<h4 id="h:3b775cea-b4e1-4396-9ca0-2487bce64a78">查看本地主机访问公网时使用的IP</h4>
<div class="outline-text-4" id="text-h:3b775cea-b4e1-4396-9ca0-2487bce64a78">
<div class="org-src-container">
<pre class="src src-sh">curl http://ip.sb
curl http://ipinfo.io/ip/
curl http://ifconfig.me
curl -L http://tool.lu/ip
curl -sS --connect-timeout 10 -m 60 https://www.bt.cn/Api/getIpAddress
curl cip.cc

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;</span>
curl http://www.cip.cc/39.164.140.134
</pre>
</div>
</div>
</div>
<div id="outline-container-h:28a0254b-ceb5-45cb-b359-d52d9fa1702b" class="outline-4">
<h4 id="h:28a0254b-ceb5-45cb-b359-d52d9fa1702b">fping</h4>
<div class="outline-text-4" id="text-h:28a0254b-ceb5-45cb-b359-d52d9fa1702b">
<p>
fping是一个程序，用于将ICMP探测发送到网络主机，类似于ping，fping的历史
由来已久：Roland Schemers在1992年确实发布了它的第一个版本，从那时起它
就确立了自己的地位，成为网络诊断和统计的标准工具
</p>

<p>
相对于ping多个主机时性能要高得多。fping完全不同于ping，可以在命令行上
定义任意数量的主机，或者指定包含要ping的IP地址或主机列表的文件,常在
shell 脚本中使用
</p>

<p>
CentOS 中由EPEL源提供
</p>

<p>
官方 ：<a href="http://www.fping.org/">http://www.fping.org/</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">root@centos8 ~]#yum -y install fping

[root@centos8 ~]#fping 10.0.0.7
10.0.0.7 is alive

[root@centos7 ~]#echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;ping</span>
[root@centos8 ~]#fping 10.0.0.7
10.0.0.7 is unreachable

[root@centos8 ~]#fping 10.0.0.7
10.0.0.7 is unreachable
[root@centos8 ~]#fping 10.0.0.7 10.0.0.8
10.0.0.8 is alive
10.0.0.7 is unreachable

<span style="color: #b22222;">#</span><span style="color: #b22222;">-g &#36873;&#39033;&#21487;&#20197;&#25351;&#23450;&#32593;&#27573;&#25110;&#22320;&#22336;&#33539;&#22260;</span>
[root@centos8 ~]#fping -g 10.0.0.0/24
10.0.0.1 is alive
10.0.0.2 is alive
10.0.0.8 is alive
10.0.0.100 is alive
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.3
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.3
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.6
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.6
......
[root@centos8 ~]#fping -g 10.0.0.5 10.0.0.10
10.0.0.8 is alive
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.6
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.6
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.6
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.6
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.5
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.5
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.5
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.5
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.10
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.10
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.10
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.10
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.9
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.9
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.9
ICMP Host Unreachable from 10.0.0.8 for ICMP Echo sent to 10.0.0.9
10.0.0.5 is unreachable
10.0.0.6 is unreachable
10.0.0.7 is unreachable
10.0.0.9 is unreachable
10.0.0.10 is unreachable


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#25991;&#20214;&#20013;&#30340;&#20027;&#26426;&#26102;&#34892;&#27979;&#35797;</span>
[root@centos8 ~]#tee hosts.txt &lt;&lt;EOF
<span style="color: #ffa54f;">10.0.0.7</span>
<span style="color: #ffa54f;">10.0.0.8</span>
<span style="color: #ffa54f;">EOF</span>
10.0.0.7
10.0.0.8
[root@centos8 ~]#fping &lt; hosts.txt
10.0.0.8 is alive
10.0.0.7 is unreachable
[root@centos8 ~]#fping -s &lt; hosts.txt
10.0.0.8 is alive
10.0.0.7 is unreachable
&#160;&#160;&#160;2 targets
&#160;&#160;&#160;1 alive
&#160;&#160;&#160;1 unreachable
&#160;&#160;&#160;0 unknown addresses
&#160;&#160;&#160;1 timeouts (waiting for response)
&#160;&#160;&#160;5 ICMP Echos sent
&#160;&#160;&#160;1 ICMP Echo Replies received
&#160;&#160;&#160;0 other ICMP received
0.07 ms (min round trip time)
0.07 ms (avg round trip time)
0.07 ms (max round trip time)
&#160;&#160;&#160;&#160;4.080 sec (elapsed real time)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:96f80859-2f66-4edc-809e-e2f00281de88" class="outline-3">
<h3 id="h:96f80859-2f66-4edc-809e-e2f00281de88">显示正确的路由表</h3>
<div class="outline-text-3" id="text-h:96f80859-2f66-4edc-809e-e2f00281de88">
</div>
<div id="outline-container-h:1127dbbf-3f98-4c6a-9e06-84fadec1e865" class="outline-4">
<h4 id="h:1127dbbf-3f98-4c6a-9e06-84fadec1e865">ip route</h4>
<div class="outline-text-4" id="text-h:1127dbbf-3f98-4c6a-9e06-84fadec1e865">
</div>
</div>
</div>
<div id="outline-container-h:5e92fda8-da0a-4445-b4b1-3a0596c268bc" class="outline-3">
<h3 id="h:5e92fda8-da0a-4445-b4b1-3a0596c268bc">跟踪路由</h3>
<div class="outline-text-3" id="text-h:5e92fda8-da0a-4445-b4b1-3a0596c268bc">
</div>
<div id="outline-container-h:ecbe81a7-60bb-4242-9d4a-4c90db9aab9a" class="outline-4">
<h4 id="h:ecbe81a7-60bb-4242-9d4a-4c90db9aab9a">traceroute</h4>
<div class="outline-text-4" id="text-h:ecbe81a7-60bb-4242-9d4a-4c90db9aab9a">
<p>
跟踪从源主机到目标主机之间经过的网关
</p>
</div>
</div>
<div id="outline-container-h:68137a44-f003-4f94-a1fc-c5894ab1c17e" class="outline-4">
<h4 id="h:68137a44-f003-4f94-a1fc-c5894ab1c17e">tracepath</h4>
<div class="outline-text-4" id="text-h:68137a44-f003-4f94-a1fc-c5894ab1c17e">
</div>
</div>
<div id="outline-container-h:b146fc47-d46e-4ab2-bfcd-474cfedc83b2" class="outline-4">
<h4 id="h:b146fc47-d46e-4ab2-bfcd-474cfedc83b2">mtr</h4>
<div class="outline-text-4" id="text-h:b146fc47-d46e-4ab2-bfcd-474cfedc83b2">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26222;&#36890;&#20351;&#29992;</span>
mtr -n 221.236.1.1
mtr -n -i 2 221.236.1.1

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#26597;5&#27425;&#21518;&#65292;&#36755;&#20986;&#25253;&#21578;</span>
mtr -n -c 5 -r 221.236.1.1
mtr -n -c 1 -r -w 221.236.1.1
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:cb5e43e1-3c1d-44b3-837e-9bdd821438ac" class="outline-3">
<h3 id="h:cb5e43e1-3c1d-44b3-837e-9bdd821438ac">确定名称服务器使用</h3>
<div class="outline-text-3" id="text-h:cb5e43e1-3c1d-44b3-837e-9bdd821438ac">
</div>
<div id="outline-container-h:ae01c237-4657-40fb-ab71-74bcd818c821" class="outline-4">
<h4 id="h:ae01c237-4657-40fb-ab71-74bcd818c821">nslookup</h4>
<div class="outline-text-4" id="text-h:ae01c237-4657-40fb-ab71-74bcd818c821">
</div>
</div>
<div id="outline-container-h:c65c4759-4009-4e85-9abd-b139385e8fb7" class="outline-4">
<h4 id="h:c65c4759-4009-4e85-9abd-b139385e8fb7">host</h4>
<div class="outline-text-4" id="text-h:c65c4759-4009-4e85-9abd-b139385e8fb7">
<div class="org-src-container">
<pre class="src src-sh">[root@iZt4n9qrho9qwpmp5fz97sZ ~]# host baidu.com
baidu.com has address 39.156.66.10
baidu.com has address 110.242.68.66
baidu.com mail is handled by 20 usmx01.baidu.com.
baidu.com mail is handled by 20 jpmx.baidu.com.
baidu.com mail is handled by 20 mx1.baidu.com.
baidu.com mail is handled by 10 mx.maillb.baidu.com.
baidu.com mail is handled by 15 mx.n.shifen.com.
baidu.com mail is handled by 20 mx50.baidu.com.
[root@iZt4n9qrho9qwpmp5fz97sZ ~]# host baidu.com 114.114.114.114
Using domain server:
Name: 114.114.114.114
Address: 114.114.114.114#53
Aliases: 

baidu.com has address 39.156.66.10
baidu.com has address 110.242.68.66
baidu.com mail is handled by 10 mx.maillb.baidu.com.
baidu.com mail is handled by 20 mx50.baidu.com.
baidu.com mail is handled by 20 mx1.baidu.com.
baidu.com mail is handled by 20 jpmx.baidu.com.
baidu.com mail is handled by 15 mx.n.shifen.com.
baidu.com mail is handled by 20 usmx01.baidu.com.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9492812b-195f-40a1-86c3-adb387d5a627" class="outline-4">
<h4 id="h:9492812b-195f-40a1-86c3-adb387d5a627">dig</h4>
<div class="outline-text-4" id="text-h:9492812b-195f-40a1-86c3-adb387d5a627">
</div>
</div>
</div>
<div id="outline-container-h:e022fc79-1544-41ae-b09f-500e481843ba" class="outline-3">
<h3 id="h:e022fc79-1544-41ae-b09f-500e481843ba">抓包工具</h3>
<div class="outline-text-3" id="text-h:e022fc79-1544-41ae-b09f-500e481843ba">
</div>
<div id="outline-container-h:8aa2e384-9b78-4d63-81d7-8716782b78e8" class="outline-4">
<h4 id="h:8aa2e384-9b78-4d63-81d7-8716782b78e8"><code>tcpdump</code></h4>
<div class="outline-text-4" id="text-h:8aa2e384-9b78-4d63-81d7-8716782b78e8">
<p>
tcpdump：dump the traffic on a network，网络数据包截获分析工具。支持针
对网络层、协议、主机、网络或端口的过滤。并提供and、or、not等逻辑语句帮
助去除无用的信息。
</p>

<p>
官网：<a href="https://www.tcpdump.org/">https://www.tcpdump.org/</a>
</p>

<p>
<b>工作原理</b>
</p>

<p>
一般情况下网络硬件和TCP/IP堆栈不支持接收或发送与本计算机无关的数据包，
为了接收这些数据包，就必须使用网卡的混杂模式(promisc)，并绕过标准的
TCP/IP堆栈才行。在FreeBSD下，这就需要内核支持伪设备bpfilter。当网卡被
设置为混杂模式时，系统会在控制台和日志文件中留下记录，提醒管理员留意这
台系统是否被用作攻击同网络的其他计算机的跳板。
</p>

<p>
<b>tcpdump选项</b>
</p>


<div class="org-src-container">
<pre class="src src-sh">tcpu [options]   [ expression ]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25235;&#21253;&#36873;&#39033;</span>
-c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#35201;&#25235;&#21462;&#30340;&#21253;&#25968;&#37327;&#12290;&#27880;&#24847;&#65292;&#26159;&#26368;&#32456;&#35201;&#33719;&#21462;&#36825;&#20040;&#22810;&#20010;&#21253;&#12290;&#20363;&#22914;&#65292;&#25351;&#23450;"-c 10"&#23558;&#33719;&#21462;10&#20010;&#21253;&#65292;&#20294;&#21487;&#33021;&#24050;&#32463;&#22788;&#29702;&#20102;100&#20010;&#21253;&#65292;&#21482;&#19981;&#36807;&#21482;&#26377;10&#20010;&#21253;&#26159;&#28385;&#36275;&#26465;&#20214;&#30340;&#21253;&#12290;</span>
-i&lt;&#32593;&#32476;&#25509;&#21475;&gt; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#25351;&#23450;&#30340;&#32593;&#32476;&#25130;&#38754;&#36865;&#20986;&#25968;&#25454;&#21253;&#12290;&#21487;&#20197;&#20351;&#29992;'any'&#20851;&#38190;&#23383;&#34920;&#31034;&#25152;&#26377;&#32593;&#32476;&#25509;&#21475;&#12290;</span>
-n <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#25226;&#20027;&#26426;&#30340;&#32593;&#32476;&#22320;&#22336;&#36716;&#25442;&#25104;&#21517;&#23383;&#12290;</span>
-nn <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#36827;&#34892;&#31471;&#21475;&#21517;&#31216;&#30340;&#36716;&#25442;&#65292;&#31471;&#21475;&#26174;&#31034;&#20026;&#25968;&#20540;,&#12290;</span>
-N <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#25171;&#21360;&#20986;host&#30340;&#22495;&#21517;&#37096;&#20998;&#12290;&#20363;&#22914;tcpdump&#23558;&#20250;&#25171;&#21360;'nic'&#32780;&#19981;&#26159;'nic.ddn.mil'&#12290;</span>
-P <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22823;P &#25351;&#23450;&#35201;&#25235;&#21462;&#30340;&#21253;&#26159;&#27969;&#20837;&#36824;&#26159;&#27969;&#20986;&#30340;&#21253;&#12290;&#21487;&#20197;&#32473;&#23450;&#30340;&#20540;&#20026;"in"&#12289;"out"&#21644;"inout"&#65292;&#40664;&#35748;&#20026;"inout"&#12290;</span>
-s&lt;&#25968;&#25454;&#21253;&#22823;&#23567;&gt; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#27599;&#20010;&#25968;&#25454;&#21253;&#30340;&#22823;&#23567;&#12290;&#40664;&#35748;68&#20010;&#23383;&#33410;</span>
      &#23545;&#20110;&#35201;&#25235;&#21462;&#30340;&#25968;&#25454;&#21253;&#36739;&#22823;&#26102;&#65292;&#38271;&#24230;&#35774;&#32622;&#19981;&#22815;&#21487;&#33021;&#20250;&#20135;&#29983;&#21253;&#25130;&#26029;&#65292;&#33509;&#20986;&#29616;&#21253;&#25130;&#26029;&#65292;
      &#65306;&#36755;&#20986;&#34892;&#20013;&#20250;&#20986;&#29616;<span style="color: #8b2252;">"[|proto]"</span>&#30340;&#26631;&#24535;(proto&#23454;&#38469;&#20250;&#26174;&#31034;&#20026;&#21327;&#35758;&#21517;)&#12290;&#20294;&#26159;&#25235;&#21462;len&#36234;&#38271;&#65292;&#21253;&#30340;&#22788;&#29702;&#26102;&#38388;&#36234;&#38271;&#65292;&#24182;&#19988;&#20250;&#20943;&#23569;tcpdump&#21487;&#32531;&#23384;&#30340;&#25968;&#25454;&#21253;&#30340;&#25968;&#37327;&#65292;
      &#65306;&#20174;&#32780;&#20250;&#23548;&#33268;&#25968;&#25454;&#21253;&#30340;&#20002;&#22833;&#65292;&#25152;&#20197;&#22312;&#33021;&#25235;&#21462;&#25105;&#20204;&#24819;&#35201;&#30340;&#21253;&#30340;&#21069;&#25552;&#19979;&#65292;&#25235;&#21462;&#38271;&#24230;&#36234;&#23567;&#36234;&#22909;&#12290;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#36873;&#39033;&#65306;</span>
-e   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#30340;&#27599;&#34892;&#20013;&#37117;&#23558;&#21253;&#25324;&#25968;&#25454;&#38142;&#36335;&#23618;&#22836;&#37096;&#20449;&#24687;&#65292;&#20363;&#22914;&#28304;MAC&#21644;&#30446;&#26631;MAC&#12290;</span>
-q   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24555;&#36895;&#36755;&#20986;&#65292;&#20165;&#21015;&#20986;&#23569;&#25968;&#30340;&#20256;&#36755;&#21327;&#35758;&#20449;&#24687;&#12290;</span>
-X   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#21253;&#30340;&#22836;&#37096;&#25968;&#25454;&#65292;&#20250;&#20197;16&#36827;&#21046;&#21644;ASCII&#20004;&#31181;&#26041;&#24335;&#21516;&#26102;&#36755;&#20986;&#12290;</span>
-XX  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#21253;&#30340;&#22836;&#37096;&#25968;&#25454;&#65292;&#20250;&#20197;16&#36827;&#21046;&#21644;ASCII&#20004;&#31181;&#26041;&#24335;&#21516;&#26102;&#36755;&#20986;&#65292;&#26356;&#35814;&#32454;&#12290;</span>
-v   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#20998;&#26512;&#21644;&#25171;&#21360;&#30340;&#26102;&#20505;&#65292;&#20135;&#29983;&#35814;&#32454;&#30340;&#36755;&#20986;&#12290;</span>
-vv  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20135;&#29983;&#27604;-v&#26356;&#35814;&#32454;&#30340;&#36755;&#20986;&#12290;</span>
-vvv <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20135;&#29983;&#27604;-vv&#26356;&#35814;&#32454;&#30340;&#36755;&#20986;&#12290;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20854;&#20182;&#21151;&#33021;&#24615;&#36873;&#39033;&#65306;</span>
-D             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#21487;&#29992;&#20110;&#25235;&#21253;&#30340;&#25509;&#21475;&#12290;&#23558;&#20250;&#21015;&#20986;&#25509;&#21475;&#30340;&#25968;&#20540;&#32534;&#21495;&#21644;&#25509;&#21475;&#21517;&#65292;&#23427;&#20204;&#37117;&#21487;&#20197;&#29992;&#20110;"-i"&#21518;&#12290;</span>
-F&lt;&#34920;&#36798;&#25991;&#20214;&gt;   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#20869;&#21547;&#34920;&#36798;&#26041;&#24335;&#30340;&#25991;&#20214;&#12290;&#33509;&#20351;&#29992;&#35813;&#36873;&#39033;&#65292;&#21017;&#21629;&#20196;&#34892;&#20013;&#32473;&#23450;&#30340;&#20854;&#20182;&#34920;&#36798;&#24335;&#37117;&#23558;&#22833;&#25928;&#12290;</span>
-w&lt;&#25968;&#25454;&#21253;&#25991;&#20214;&gt; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25226;&#25968;&#25454;&#21253;&#25968;&#25454;&#20889;&#20837;&#25351;&#23450;&#30340;&#25991;&#20214;&#12290;&#21487;&#20197;&#21516;&#26102;&#37197;&#21512;"-G time"&#36873;&#39033;&#20351;&#24471;&#36755;&#20986;&#25991;&#20214;&#27599;time&#31186;&#23601;&#33258;&#21160;&#20999;&#25442;&#21040;&#21478;&#19968;&#20010;&#25991;&#20214;&#12290;&#21487;&#36890;&#36807;"-r"&#36873;&#39033;&#36733;&#20837;&#36825;&#20123;&#25991;&#20214;&#20197;&#36827;&#34892;&#20998;&#26512;&#21644;&#25171;&#21360;&#12290;</span>
-r&lt;&#25968;&#25454;&#21253;&#25991;&#20214;&gt; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#25351;&#23450;&#30340;&#25991;&#20214;&#35835;&#21462;&#25968;&#25454;&#21253;&#25968;&#25454;&#12290;&#20351;&#29992;"-"&#34920;&#31034;&#20174;&#26631;&#20934;&#36755;&#20837;&#20013;&#35835;&#21462;&#12290;(&#36825;&#20123;&#21253;&#19968;&#33324;&#36890;&#36807;-w&#36873;&#39033;&#20135;&#29983;)</span>


-A   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;ASCII&#26684;&#24335;&#25171;&#21360;&#20986;&#25152;&#26377;&#20998;&#32452;&#65292;&#24182;&#23558;&#38142;&#36335;&#23618;&#30340;&#22836;&#26368;&#23567;&#21270;&#12290;</span>
-a   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23581;&#35797;&#23558;&#32593;&#32476;&#21644;&#24191;&#25773;&#22320;&#22336;&#36716;&#25442;&#25104;&#21517;&#31216;&#12290;</span>
-C   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#23558;&#19968;&#20010;&#21407;&#22987;&#20998;&#32452;&#20889;&#20837;&#25991;&#20214;&#20043;&#21069;&#65292;&#26816;&#26597;&#25991;&#20214;&#24403;&#21069;&#30340;&#22823;&#23567;&#26159;&#21542;&#36229;&#36807;&#20102;&#21442;&#25968;file_size &#20013;&#25351;&#23450;&#30340;&#22823;&#23567;&#12290;&#22914;&#26524;&#36229;&#36807;&#20102;&#25351;&#23450;&#22823;&#23567;&#65292;&#21017;&#20851;&#38381;&#24403;&#21069;&#25991;&#20214;&#65292;&#28982;&#21518;&#22312;&#25171;&#24320;&#19968;&#20010;&#26032;&#30340;&#25991;&#20214;&#12290;&#21442;&#25968; file_size &#30340;&#21333;&#20301;&#26159;&#20806;&#23383;&#33410;&#65288;&#26159;1,000,000&#23383;&#33410;&#65292;&#32780;&#19981;&#26159;1,048,576&#23383;&#33410;&#65289;&#12290;</span>
-d   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25226;&#32534;&#35793;&#36807;&#30340;&#25968;&#25454;&#21253;&#32534;&#30721;&#36716;&#25442;&#25104;&#21487;&#38405;&#35835;&#30340;&#26684;&#24335;&#65292;&#24182;&#20542;&#20498;&#21040;&#26631;&#20934;&#36755;&#20986;&#12290;</span>
-dd  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25226;&#32534;&#35793;&#36807;&#30340;&#25968;&#25454;&#21253;&#32534;&#30721;&#36716;&#25442;&#25104;C&#35821;&#35328;&#30340;&#26684;&#24335;&#65292;&#24182;&#20542;&#20498;&#21040;&#26631;&#20934;&#36755;&#20986;&#12290;</span>
-ddd <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25226;&#32534;&#35793;&#36807;&#30340;&#25968;&#25454;&#21253;&#32534;&#30721;&#36716;&#25442;&#25104;&#21313;&#36827;&#21046;&#25968;&#23383;&#30340;&#26684;&#24335;&#65292;&#24182;&#20542;&#20498;&#21040;&#26631;&#20934;&#36755;&#20986;&#12290;</span>
-E   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;spi@ipaddr algo:secret&#35299;&#23494;&#37027;&#20123;&#20197;addr&#20316;&#20026;&#22320;&#22336;&#65292;&#24182;&#19988;&#21253;&#21547;&#20102;&#23433;&#20840;&#21442;&#25968;&#32034;&#24341;&#20540;spi&#30340;IPsec ESP&#20998;&#32452;&#12290;</span>
-f   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#25968;&#23383;&#26174;&#31034;&#32593;&#38469;&#32593;&#32476;&#22320;&#22336;&#12290;</span>
-l   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#26631;&#20934;&#36755;&#20986;&#21015;&#30340;&#32531;&#20914;&#21306;&#12290;&#21487;&#20197;&#25226;&#25968;&#25454;&#23548;&#20986;&#21040;&#25991;&#20214;</span>
-L   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#32593;&#32476;&#25509;&#21475;&#30340;&#24050;&#30693;&#25968;&#25454;&#38142;&#36335;&#12290;</span>
-m   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#25991;&#20214;module&#20013;&#23548;&#20837;SMI MIB&#27169;&#22359;&#23450;&#20041;&#12290;&#35813;&#21442;&#25968;&#21487;&#20197;&#34987;&#20351;&#29992;&#22810;&#27425;&#65292;&#20197;&#23548;&#20837;&#22810;&#20010;MIB&#27169;&#22359;&#12290;</span>
-M   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;tcp&#25253;&#25991;&#20013;&#23384;&#22312;TCP-MD5&#36873;&#39033;&#65292;&#21017;&#38656;&#35201;&#29992;secret&#20316;&#20026;&#20849;&#20139;&#30340;&#39564;&#35777;&#30721;&#29992;&#20110;&#39564;&#35777;TCP-MD5&#36873;&#36873;&#39033;&#25688;&#35201;&#65288;&#35814;&#24773;&#21487;&#21442;&#32771;RFC 2385&#65289;&#12290;</span>
-b   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#25968;&#25454;-&#38142;&#36335;&#23618;&#19978;&#36873;&#25321;&#21327;&#35758;&#65292;&#21253;&#25324;ip&#12289;arp&#12289;rarp&#12289;ipx&#37117;&#26159;&#36825;&#19968;&#23618;&#30340;&#12290;</span>
-O   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#23558;&#25968;&#25454;&#21253;&#32534;&#30721;&#26368;&#20339;&#21270;&#12290;</span>
-p   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#35753;&#32593;&#32476;&#30028;&#38754;&#36827;&#20837;&#28151;&#26434;&#27169;&#24335;&#12290;</span>
-S   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#32477;&#23545;&#32780;&#38750;&#30456;&#23545;&#25968;&#20540;&#21015;&#20986;TCP&#20851;&#32852;&#25968;&#12290;</span>
-t   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#27599;&#21015;&#20542;&#20498;&#36164;&#26009;&#19978;&#19981;&#26174;&#31034;&#26102;&#38388;&#25139;&#35760;&#12290;</span>
-tt  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#27599;&#21015;&#20542;&#20498;&#36164;&#26009;&#19978;&#26174;&#31034;&#26410;&#32463;&#26684;&#24335;&#21270;&#30340;&#26102;&#38388;&#25139;&#35760;&#12290;</span>
-ttt <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#26412;&#34892;&#21644;&#21069;&#38754;&#19968;&#34892;&#20043;&#38388;&#30340;&#26102;&#38388;&#24046;&#12290;</span>
-tttt <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#27599;&#19968;&#34892;&#20013;&#36755;&#20986;&#30001;date&#22788;&#29702;&#30340;&#40664;&#35748;&#26684;&#24335;&#30340;&#26102;&#38388;&#25139;&#12290;</span>
-T&lt;&#25968;&#25454;&#21253;&#31867;&#22411;&gt; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24378;&#21046;&#23558;&#34920;&#36798;&#26041;&#24335;&#25152;&#25351;&#23450;&#30340;&#25968;&#25454;&#21253;&#36716;&#35793;&#25104;&#35774;&#32622;&#30340;&#25968;&#25454;&#21253;&#31867;&#22411;&#12290;&#24120;&#35265;&#30340;&#31867;&#22411;&#26377;rpc&#36828;&#31243;&#36807;&#31243;&#35843;&#29992;&#65289;&#21644;snmp&#65288;&#31616;&#21333;&#32593;&#32476;&#31649;&#29702;&#21327;&#35758;&#65307;&#65289;&#12290;</span>
-u   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#26410;&#35299;&#30721;&#30340;NFS&#21477;&#26564;&#12290;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24120;&#29992;&#32452;&#21512;</span>
-nn -vvv -A
</pre>
</div>

<p>
<b>tcpdump表达式</b>
</p>

<p>
帮助 man pcap-filter
</p>


<figure id="org8c42dfd">
<img src="images/image-20210203030527721.png" alt="image-20210203030527721.png" width="50%">

</figure>

<p>
tcpdump的表达式由一个或多个”单元”组成，每个单元一般包含ID的修饰符和一个ID(数字或名称)。
</p>

<div class="org-src-container">
<pre class="src src-sh">tcpdump [options] [&#20462;&#39280;&#31526;] [&#25805;&#20316;&#31526;&#12289;&#20851;&#38190;&#23383;&#12289;&#31639;&#26415;&#34920;&#36798;&#24335;] 


&#20462;&#39280;&#31526;: proto dir type
proto <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#21327;&#35758;&#65292;tcp/udp/arp/ip/ether/icmp&#31561;, &#33509;&#26410;&#32473;&#23450;&#21327;&#35758;&#31867;&#22411;&#65292;&#21017;&#21305;&#37197;&#25152; &#26377;&#21487;&#33021;&#30340;&#31867;&#22411;&#12290;&#20363;&#22914;&#8221;tcp port 21&#8221;&#65292;"udp portrange 7000-7009"</span>
dir <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#20256;&#36755;&#26041;&#21521;&#65292;src, dst, src or dst, src and dst &#40664;&#35748; src or dst</span>
<span style="color: #483d8b;">type</span>  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#31867;&#22411;&#65292;host,net,port,portrange &#40664;&#35748;host</span>

&#34920;&#36798;&#24335;&#20043;&#38388;&#32452;&#21512;&#26465;&#20214;&#65306;
    and &amp;&amp;
    or  ||
    not  !

&#20851;&#38190;&#23383; <span style="color: #b22222;">#</span><span style="color: #b22222;">gateway&#65292;broadcast&#65292;less&#65292;greater</span>

&#20351;&#29992;&#25324;&#21495;&#8221;()<span style="color: #8b2252;">"&#21487;&#20197;&#25913;&#21464;&#34920;&#36798;&#24335;&#30340;&#20248;&#20808;&#32423;&#65292;&#20294;&#38656;&#35201;&#27880;&#24847;&#30340;&#26159;&#25324;&#21495;&#20250;&#34987;shell&#35299;&#37322;&#65292;&#25152;&#20197;&#24212;&#35813;&#20351;&#29992;&#21453;&#26012;&#32447;""&#36716;&#20041;&#20026;&#8221;()&#8220;&#65292;&#22312;&#38656;&#35201;&#30340;&#26102;&#20505;&#65292;&#36824;&#38656;&#35201;&#21253;&#22260;&#22312;&#24341;&#21495;&#20013;&#12290;</span>

<span style="color: #8b2252;">&#21516;&#26679;&#30340;&#20462;&#39280;&#31526;&#21487;&#30465;&#30053;</span>
<span style="color: #8b2252;">tcp dst port ftp or ftp-data or domain &#19982; tcp dst port ftp or tcp dst port ftp-data or tcp dst port domain &#31561;&#20215;</span>
</pre>
</div>


<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#32593;&#21345;</span>
[root@centos8 ~]#tcpdump -D
1.eth0 [Up, Running]
2.lo [Up, Running, Loopback]
<span style="color: #0000ff;">3.any</span> (Pseudo-device that captures on all interfaces) [Up, Running]
<span style="color: #0000ff;">4.bluetooth-monitor</span> (Bluetooth Linux Monitor) [none]
<span style="color: #0000ff;">5.nflog</span> (Linux netfilter log (NFLOG) interface) [none]
<span style="color: #0000ff;">6.nfqueue</span> (Linux netfilter queue (NFQUEUE) interface) [none]
<span style="color: #0000ff;">7.usbmon0</span> (All USB buses) [none]
<span style="color: #0000ff;">8.usbmon1</span> (USB bus number 1)
<span style="color: #0000ff;">9.usbmon2</span> (USB bus number 2)


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#25351;&#23450;&#20219;&#20309;&#21442;&#25968;&#65292;&#30417;&#21548;&#31532;&#19968;&#22359;&#32593;&#21345;&#19978;&#32463;&#36807;&#30340;&#25968;&#25454;&#21253;&#12290;&#20027;&#26426;&#19978;&#21487;&#33021;&#26377;&#19981;&#27490;&#19968;&#22359;&#32593;&#21345;&#65292;&#25152;&#20197;&#32463;&#24120;&#38656;&#35201;&#25351;&#23450;&#32593;&#21345;&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">tcpdump</span>
20:01:50.766275 IP iZ2ze9syjt6dldfkhqzdw2Z.11822 &gt; 10.0.1.194.57897: Flags [P.], seq 2478363413:2478363601, ack 815052156, win 302, length 188

Flags &#30340;&#23436;&#25972;&#21015;&#34920;&#12290;
S: SYN
F: FIN
P: PUSH
R: RST
U: URG
W: ECN CWR
E: ECN Echo
<span style="color: #483d8b;">.</span>: ACACK

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30417;&#21548;&#29305;&#23450;&#20027;&#26426;&#65292;&#30417;&#21548;&#20027;&#26426;10.0.0.100 &#30340;&#36890;&#20449;&#21253;&#65292;&#27880;&#24847;&#65306;&#20986;&#12289;&#20837;&#30340;&#21253;&#37117;&#20250;&#34987;&#30417;&#21548;&#12290;</span>
tcpdump -i eth0 host 10.0.0.100

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29305;&#23450;&#26469;&#28304;</span>
tcpdump src host hostname
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29305;&#23450;&#30446;&#26631;&#22320;&#22336;</span>
tcpdump dst host hostname

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38754;&#35797;&#39064;</span>
[root@centos8 ~]#tcpdump -i eth0 -nn icmp and    src host 10.0.0.6 and dst host 10.0.0.7

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29305;&#23450;&#31471;&#21475;</span>
tcpdump port 3000

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29305;&#23450;&#21327;&#35758; &#30417;&#21548;TCP/UDP&#65292;&#26381;&#21153;&#22120;&#19978;&#19981;&#21516;&#26381;&#21153;&#20998;&#21035;&#29992;&#20102;TCP&#12289;UDP&#20316;&#20026;&#20256;&#36755;&#23618;&#65292;&#20551;&#22914;&#21482;&#24819;&#30417;&#21548;TCP&#30340;&#25968;&#25454;&#21253;</span>
tcpdump tcp

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32452;&#21512;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32452;&#21512;&#65306;&#26469;&#28304;&#20027;&#26426;+&#31471;&#21475;+TCP&#65292;&#30417;&#21548;&#26469;&#33258;&#20027;&#26426;10.0.0.100&#22312;&#31471;&#21475;22&#19978;&#30340;TCP&#25968;&#25454;&#21253;</span>
tcpdump tcp port 22 and src host 10.0.0.100
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32452;&#21512;&#65306;&#30417;&#21548;&#29305;&#23450;&#20027;&#26426;&#20043;&#38388;&#30340;&#36890;&#20449;</span>
tcpdump ip host 10.0.0.101 and 10.0.0.102
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#26426;10.0.0.101&#21644;&#20027;&#26426;10.0.0.102 &#25110;172.16.100.77&#30340;&#36890;&#20449;</span>
tcpdump ip host 10.0.0.101 and <span style="color: #8b2252;">\(</span>10.0.0.102 or 172.16.100.77 <span style="color: #8b2252;">\)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32452;&#21512;&#65306;10.0.0.101&#21644;&#38500;&#20102;10.0.0.1&#20043;&#22806;&#30340;&#20027;&#26426;&#20043;&#38388;&#30340;&#36890;&#20449;</span>
tcpdump ip host 10.0.0.101 and ! 10.0.0.1

<span style="color: #b22222;">#</span><span style="color: #b22222;">HTTP&#25235;&#21253;</span>
tcpdump -nn -vvv -A |grep baidu.com

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38480;&#21046;&#25235;&#21253;&#30340;&#25968;&#37327;&#65292;&#22914;&#19979;&#65292;&#25235;&#21040;1000&#20010;&#21253;&#21518;&#65292;&#33258;&#21160;&#36864;&#20986;</span>
tcpdump -c 1000

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25171;&#21360;&#25152;&#26377;&#36890;&#36807;&#32593;&#20851;snup&#30340;ftp&#25968;&#25454;&#21253;(&#27880;&#24847;,&#34920;&#36798;&#24335;&#34987;&#21333;&#24341;&#21495;&#25324;&#36215;&#26469;&#20102;,&#36825;&#21487;&#20197;&#38450;&#27490;shell&#23545;&#20854;&#20013;&#30340;&#25324;&#21495;&#36827;&#34892;&#38169;&#35823;&#35299;&#26512;)</span>
tcpdump <span style="color: #8b2252;">'gateway snup and (port ftp or ftp-data)'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">10. &#35299;&#26512;&#21253;&#25968;&#25454;</span>
tcpdump -c 2 -q -XX -vvv -nn -i eth0 tcp dst port 22

<span style="color: #b22222;"># </span><span style="color: #b22222;">11. &#20445;&#23384;&#21040;&#26412;&#22320;&#65292;tcpdump&#40664;&#35748;&#20250;&#23558;&#36755;&#20986;&#20889;&#21040;&#32531;&#20914;&#21306;&#65292;&#21482;&#26377;&#32531;&#20914;&#21306;&#20869;&#23481;&#36798;&#21040;&#19968;&#23450;&#30340;&#22823;&#23567;&#65292;&#25110;&#32773;tcpdump&#36864;&#20986;&#26102;&#65292;&#25165;&#20250;&#23558;&#36755;&#20986;&#20889;&#21040;&#26412;&#22320;&#30913;&#30424;,&#21487;&#20197;&#21152;&#19978;-U&#24378;&#21046;&#31435;&#21363;&#20889;&#21040;&#26412;&#22320;&#30913;&#30424;&#65288;&#19968;&#33324;&#19981;&#24314;&#35758;&#65292;&#24615;&#33021;&#30456;&#23545;&#36739;&#24046;&#65289;</span>
tcpdump -n -vvv -c 1000 -w /tmp/tcpdump_save.cap

<span style="color: #b22222;">#</span><span style="color: #b22222;">tcpdump &#23545;&#25130;&#33719;&#30340;&#25968;&#25454;&#24182;&#27809;&#26377;&#36827;&#34892;&#24443;&#24213;&#35299;&#30721;&#65292;&#25968;&#25454;&#21253;&#20869;&#30340;&#22823;&#37096;&#20998;&#20869;&#23481;&#26159;&#20351;&#29992;&#21313;&#20845;&#36827;&#21046;&#30340;&#24418;&#24335;&#30452;&#25509;&#25171;&#21360;&#36755;&#20986;&#30340;&#12290;&#26174;&#28982;&#36825;&#19981;&#21033;&#20110;&#20998;&#26512;&#32593;&#32476;&#25925;&#38556;&#65292;&#36890;&#24120;&#30340;&#35299;&#20915;&#21150;&#27861;&#26159;&#20808;&#20351;&#29992;&#24102;-w&#21442; &#25968;&#30340;tcpdump &#25130;&#33719;&#25968;&#25454;&#24182;&#20445;&#23384;&#21040;&#25991;&#20214;&#20013;&#65292;&#28982;&#21518;&#20877;&#20351;&#29992;&#20854;&#20182;&#31243;&#24207;(&#22914;Wireshark)&#36827;&#34892;&#35299;&#30721;&#20998;&#26512;&#12290;&#24403;&#28982;&#20063;&#24212;&#35813;&#23450;&#20041;&#36807;&#28388;&#35268;&#21017;&#65292;&#20197;&#36991;&#20813;&#25429;&#33719;&#30340;&#25968;&#25454;&#21253;&#22635;&#28385;&#25972;&#20010;&#30828;&#30424;&#12290;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">tcpdump &#19982;wireshark</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">Wireshark(&#20197;&#21069;&#26159;ethereal)&#26159;Windows&#19979;&#38750;&#24120;&#31616;&#21333;&#26131;&#29992;&#30340;&#25235;&#21253;&#24037;&#20855;&#12290;&#20294;&#22312;Linux&#19979;&#24456;&#38590;&#25214;&#21040;&#19968;&#20010;&#22909;&#29992;&#30340;&#22270;&#24418;&#21270;&#25235;&#21253;&#24037;&#20855;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25105;&#20204;&#21487;&#20197;&#29992;Tcpdump + Wireshark &#30340;&#23436;&#32654;&#32452;&#21512;&#23454;&#29616;&#65306;&#22312; Linux &#37324;&#25235;&#21253;&#65292;&#28982;&#21518;&#22312;Windows &#37324;&#20998;&#26512;&#21253;&#12290;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35814;&#32454;&#31034;&#20363;</span>
tcpdump tcp -i eth1 -t -s 0 -c 100 and dst port ! 22 and src net 192.168.1.0/24 -w ./target.cap
(1)tcp: ip icmp arp rarp &#21644; tcp&#12289;udp&#12289;icmp&#36825;&#20123;&#36873;&#39033;&#31561;&#37117;&#35201;&#25918;&#21040;&#31532;&#19968;&#20010;&#21442;&#25968;&#30340;&#20301;&#32622;&#65292;&#29992;&#26469;&#36807;&#28388;&#25968;&#25454;&#25253;&#30340;&#31867;&#22411;
(2)-i eth1 : &#21482;&#25235;&#32463;&#36807;&#25509;&#21475;eth1&#30340;&#21253;
(3)-t : &#19981;&#26174;&#31034;&#26102;&#38388;&#25139;
(4)-s 0 : &#25235;&#21462;&#25968;&#25454;&#21253;&#26102;&#40664;&#35748;&#25235;&#21462;&#38271;&#24230;&#20026;68&#23383;&#33410;&#12290;&#21152;&#19978;-S 0 &#21518;&#21487;&#20197;&#25235;&#21040;&#23436;&#25972;&#30340;&#25968;&#25454;&#21253;
(5)-c 100 : &#21482;&#25235;&#21462;100&#20010;&#25968;&#25454;&#21253;
(6)dst port ! 22 : &#19981;&#25235;&#21462;&#30446;&#26631;&#31471;&#21475;&#26159;22&#30340;&#25968;&#25454;&#21253;
(7)src net 192.168.1.0/24 : &#25968;&#25454;&#21253;&#30340;&#28304;&#32593;&#32476;&#22320;&#22336;&#20026;192.168.1.0/24
(8)-w ./target.cap : &#20445;&#23384;&#25104;cap&#25991;&#20214;&#65292;&#26041;&#20415;&#29992;wireshark&#20998;&#26512;
</pre>
</div>

<p>
vmware的网络实例上是个hub，无法隔离冲突域，无法真的模拟交换机。所以同
一个nat网络里虽然不同主机网段不同但还是可以抓到包。跨网段通信，实验时
可以让网卡在不同的网络中，如eth0在nat网络eth1在仅主机网段，那么从
10.0.0.6 ping eth0的10.0.0.8的数据就不同在eth1网卡上抓到了。
</p>


<figure id="org02df68a">
<img src="images/image-20210203000452441.png" alt="image-20210203000452441.png" width="50%">

</figure>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#29992;tcpdump&#21957;&#25506;80&#31471;&#21475;&#30340;&#35775;&#38382;&#30475;&#30475;&#35841;&#26368;&#39640;</span>
tcpdump -i eth0 -tnn dst port 80 -c 1000 | awk -F<span style="color: #8b2252;">"."</span> <span style="color: #8b2252;">'{print $1"."$2"."$3"."$4}'</span> | sort | uniq -c | sort -nr |head -n 20

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#26159;&#21738;&#20123;&#29228;&#34411;&#22312;&#25235;&#21462;&#20869;&#23481;&#12290;</span>
tcpdump -i eth0 -l -s 0 -w - dst port 80 | strings | grep -i user-agent | grep -i -E <span style="color: #8b2252;">'bot|crawler|slurp|spider'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#25968;&#25454;&#24211;&#25191;&#34892;&#30340;sql&#35821;&#21477;</span>
tcpdump -i eth0 -s 0 -l -w - dst port 3306 | strings | egrep -i <span style="color: #8b2252;">'SELECT|UPDATE|DELETE|INSERT|SET|COMMIT|ROLLBACK|CREATE|DROP|ALTER|CALL'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#21360;TCP&#20250;&#35805;&#20013;&#30340;&#30340;&#24320;&#22987;&#21644;&#32467;&#26463;&#25968;&#25454;&#21253;, &#24182;&#19988;&#25968;&#25454;&#21253;&#30340;&#28304;&#25110;&#30446;&#30340;&#19981;&#26159;&#26412;&#22320;&#32593;&#32476;&#19978;&#30340;&#20027;&#26426;.(nt: localnet, &#23454;&#38469;&#20351;&#29992;&#26102;&#35201;&#30495;&#27491;&#26367;&#25442;&#25104;&#26412;&#22320;&#32593;&#32476;&#30340;&#21517;&#23383;))</span>
tcpdump <span style="color: #8b2252;">'tcp[tcpflags] &amp; (tcp-syn|tcp-fin) != 0 and not src and dst net localnet'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#21360;&#25152;&#26377;&#28304;&#25110;&#30446;&#30340;&#31471;&#21475;&#26159;80, &#32593;&#32476;&#23618;&#21327;&#35758;&#20026;IPv4, &#24182;&#19988;&#21547;&#26377;&#25968;&#25454;,&#32780;&#19981;&#26159;SYN,FIN&#20197;&#21450;ACK-only&#31561;&#19981;&#21547;&#25968;&#25454;&#30340;&#25968;&#25454;&#21253;.(ipv6&#30340;&#29256;&#26412;&#30340;&#34920;&#36798;&#24335;&#21487;&#20570;&#32451;&#20064;)</span>
tcpdump <span style="color: #8b2252;">'tcp port 80 and (((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) - ((tcp[12]&amp;0xf0)&gt;&gt;2)) != 0)'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">(nt: &#21487;&#29702;&#35299;&#20026;, ip[2:2]&#34920;&#31034;&#25972;&#20010;ip&#25968;&#25454;&#21253;&#30340;&#38271;&#24230;, (ip[0]&amp;0xf)&lt;&lt;2)&#34920;&#31034;ip&#25968;&#25454;&#21253;&#21253;&#22836;&#30340;&#38271;&#24230;(ip[0]&amp;0xf&#20195;&#34920;&#21253;&#20013;&#30340;IHL&#22495;, &#32780;&#27492;&#22495;&#30340;&#21333;&#20301;&#20026;32bit, &#35201;&#25442;&#31639;&#25104;&#23383;&#33410;&#25968;&#38656;&#35201;&#20056;&#20197;4,&#12288;&#21363;&#24038;&#31227;2.&#12288;(tcp[12]&amp;0xf0)&gt;&gt;4 &#34920;&#31034;tcp&#22836;&#30340;&#38271;&#24230;, &#27492;&#22495;&#30340;&#21333;&#20301;&#20063;&#26159;32bit,&#12288;&#25442;&#31639;&#25104;&#27604;&#29305;&#25968;&#20026; ((tcp[12]&amp;0xf0) &gt;&gt; 4)&#12288;&lt;&lt;&#12288;&#65298;,&#12288;&#21363; ((tcp[12]&amp;0xf0)&gt;&gt;2).&#12288;((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) - ((tcp[12]&amp;0xf0)&gt;&gt;2)) != 0&#12288;&#34920;&#31034;: &#25972;&#20010;ip&#25968;&#25454;&#21253;&#30340;&#38271;&#24230;&#20943;&#21435;ip&#22836;&#30340;&#38271;&#24230;,&#20877;&#20943;&#21435;tcp&#22836;&#30340;&#38271;&#24230;&#19981;&#20026;0, &#36825;&#23601;&#24847;&#21619;&#30528;, ip&#25968;&#25454;&#21253;&#20013;&#30830;&#23454;&#26159;&#26377;&#25968;&#25454;.&#23545;&#20110;ipv6&#29256;&#26412;&#21482;&#38656;&#32771;&#34385;ipv6&#22836;&#20013;&#30340;'Payload Length' &#19982; 'tcp&#22836;&#30340;&#38271;&#24230;'&#30340;&#24046;&#20540;, &#24182;&#19988;&#20854;&#20013;&#34920;&#36798;&#26041;&#24335;'ip[]'&#38656;&#25442;&#25104;'ip6[]'.)</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#21360;&#38271;&#24230;&#36229;&#36807;576&#23383;&#33410;, &#24182;&#19988;&#32593;&#20851;&#22320;&#22336;&#26159;snup&#30340;IP&#25968;&#25454;&#21253;</span>
tcpdump <span style="color: #8b2252;">'gateway snup and ip[2:2] &gt; 576'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#21360;&#25152;&#26377;IP&#23618;&#24191;&#25773;&#25110;&#22810;&#25773;&#30340;&#25968;&#25454;&#21253;&#65292; &#20294;&#19981;&#26159;&#29289;&#29702;&#20197;&#22826;&#32593;&#23618;&#30340;&#24191;&#25773;&#25110;&#22810;&#25773;&#25968;&#25454;&#25253;</span>
tcpdump <span style="color: #8b2252;">'ether[0] &amp; 1 = 0 and ip[16] &gt;= 224'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#21360;&#38500;'echo request'&#25110;&#32773;'echo reply'&#31867;&#22411;&#20197;&#22806;&#30340;ICMP&#25968;&#25454;&#21253;( &#27604;&#22914;,&#38656;&#35201;&#25171;&#21360;&#25152;&#26377;&#38750;ping &#31243;&#24207;&#20135;&#29983;&#30340;&#25968;&#25454;&#21253;&#26102;&#21487;&#29992;&#21040;&#27492;&#34920;&#36798;&#24335; .</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">(nt: 'echo reuqest' &#19982; 'echo reply' &#36825;&#20004;&#31181;&#31867;&#22411;&#30340;ICMP&#25968;&#25454;&#21253;&#36890;&#24120;&#30001;ping&#31243;&#24207;&#20135;&#29983;))</span>
tcpdump <span style="color: #8b2252;">'icmp[icmptype] != icmp-echo and icmp[icmptype] != icmp-echoreply'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992;tcpdump&#25235;&#21462;HTTP&#21253;</span>
tcpdump  -XvvennSs 0 -i eth0 <span style="color: #a0522d;">tcp</span>[20:2]=0x4745 or tcp[20:2]=0x4854
<span style="color: #b22222;">#</span><span style="color: #b22222;">0x4745 &#20026;"GET"&#21069;&#20004;&#20010;&#23383;&#27597;"GE",0x4854 &#20026;"HTTP"&#21069;&#20004;&#20010;&#23383;&#27597;"HT"&#12290;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1aac6b2b-ebd5-4f18-b680-f1dad4b7d536" class="outline-4">
<h4 id="h:1aac6b2b-ebd5-4f18-b680-f1dad4b7d536">wireshark</h4>
<div class="outline-text-4" id="text-h:1aac6b2b-ebd5-4f18-b680-f1dad4b7d536">
</div>
</div>
</div>
<div id="outline-container-h:3df0e07c-bd45-4c52-983b-99cf8527255b" class="outline-3">
<h3 id="h:3df0e07c-bd45-4c52-983b-99cf8527255b">安全扫描工具</h3>
<div class="outline-text-3" id="text-h:3df0e07c-bd45-4c52-983b-99cf8527255b">
</div>
<div id="outline-container-h:d3b14673-9bab-476d-9f1d-9dea34fe46af" class="outline-4">
<h4 id="h:d3b14673-9bab-476d-9f1d-9dea34fe46af">nmap</h4>
<div class="outline-text-4" id="text-h:d3b14673-9bab-476d-9f1d-9dea34fe46af">
<p>
扫描远程主机工具，功能远超越用世人皆知的 Ping 工具发送简单的 ICMP
回声请求报文 官方帮助：<a href="https://nmap.org/book/man.html">https://nmap.org/book/man.html</a>
</p>

<p>
格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">nmap [Scan Type(s)] [Options] {target specification}

&#21629;&#20196;&#36873;&#39033;
-sT     TCP connect() &#25195;&#25551;&#65292;&#36825;&#26159;&#26368;&#22522;&#26412;&#30340; TCP &#25195;&#25551;&#26041;&#24335;&#12290;&#36825;&#31181;&#25195;&#25551;&#24456;&#23481;&#26131;&#34987;&#26816;&#27979;&#21040;&#65292;&#22312;&#30446;&#26631;&#20027;&#26426;&#30340;&#26085;&#24535;&#20013;&#20250;&#35760;&#24405;&#22823;&#25209;&#30340;&#36830;&#25509;&#35831;&#27714;&#20197;&#21450;&#38169;&#35823;&#20449;&#24687;     
-sS     TCP &#21516;&#27493;&#25195;&#25551; (TCP SYN)&#65292;&#22240;&#20026;&#19981;&#24517;&#20840;&#37096;&#25171;&#24320;&#19968;&#20010; TCP &#36830;&#25509;&#65292;&#25152;&#20197;&#36825;&#39033;&#25216;&#26415;&#36890;&#24120;&#31216;&#20026;&#21322;&#24320;&#25195;&#25551;(half-open)&#12290;&#36825;&#39033;&#25216;&#26415;&#26368;&#22823;&#30340;&#22909;&#22788;&#26159;&#65292;&#24456;&#23569;&#26377;&#31995;&#32479;&#33021;&#22815;&#25226;&#36825;&#35760;&#20837;&#31995;&#32479;&#26085;&#24535; 
-sF,-sX,-sN     &#31192;&#23494; FIN &#25968;&#25454;&#21253;&#25195;&#25551;&#12289;&#22307;&#35806;&#26641; (Xmas Tree)&#12289;&#31354; (Null) &#25195;&#25551;&#27169;&#24335;&#12290;&#36825;&#20123;&#25195;&#25551;&#26041;&#24335;&#30340;&#29702;&#35770;&#20381;&#25454;&#26159;&#65306;&#20851;&#38381;&#30340;&#31471;&#21475;&#38656;&#35201;&#23545;&#20320;&#30340;&#25506;&#27979;&#21253;&#22238;&#24212; RST &#21253;&#65292;&#32780;&#25171;&#24320;&#30340;&#31471;&#21475;&#24517;&#38656;&#24573;&#30053;&#26377;&#38382;&#39064;&#30340;&#21253;     
-sP     ping &#25195;&#25551;&#65292;&#29992; ping &#26041;&#24335;&#26816;&#26597;&#32593;&#32476;&#19978;&#21738;&#20123;&#20027;&#26426;&#27491;&#22312;&#36816;&#34892;&#12290;&#24403;&#20027;&#26426;&#38459;&#22622; ICMP echo &#35831;&#27714;&#21253;&#26159;ping &#25195;&#25551;&#26159;&#26080;&#25928;&#30340;&#12290;nmap &#22312;&#20219;&#20309;&#24773;&#20917;&#19979;&#37117;&#20250;&#36827;&#34892; ping &#25195;&#25551;&#65292;&#21482;&#26377;&#30446;&#26631;&#20027;&#26426;&#22788;&#20110;&#36816;&#34892;&#29366;&#24577;&#65292;&#25165;&#20250;&#36827;&#34892;&#21518;&#32493;&#30340;&#25195;&#25551;     
-sU     UDP &#30340;&#25968;&#25454;&#21253;&#36827;&#34892;&#25195;&#25551;&#65292;&#24819;&#30693;&#36947;&#22312;&#26576;&#21488;&#20027;&#26426;&#19978;&#25552;&#20379;&#21738;&#20123; UDP &#26381;&#21153;&#65292;&#21487;&#20197;&#20351;&#29992;&#27492;&#36873;&#39033;     
-sA     ACK &#25195;&#25551;&#65292;&#36825;&#39033;&#39640;&#32423;&#30340;&#25195;&#25551;&#26041;&#27861;&#36890;&#24120;&#21487;&#20197;&#29992;&#26469;&#31359;&#36807;&#38450;&#28779;&#22681;&#12290;     
-sW     &#28369;&#21160;&#31383;&#21475;&#25195;&#25551;&#65292;&#38750;&#24120;&#31867;&#20284;&#20110; ACK &#30340;&#25195;&#25551;     
-sR     RPC &#25195;&#25551;&#65292;&#21644;&#20854;&#23427;&#19981;&#21516;&#30340;&#31471;&#21475;&#25195;&#25551;&#26041;&#27861;&#32467;&#21512;&#20351;&#29992;&#12290;     
-b      FTP &#21453;&#24377;&#25915;&#20987; (bounce attack)&#65292;&#36830;&#25509;&#21040;&#38450;&#28779;&#22681;&#21518;&#38754;&#30340;&#19968;&#21488; FTP &#26381;&#21153;&#22120;&#20570;&#20195;&#29702;&#65292;&#25509;&#30528;&#36827;&#34892;&#31471;&#21475;&#25195;&#25551;&#12290;
-P0     &#22312;&#25195;&#25551;&#20043;&#21069;&#65292;&#19981; ping &#20027;&#26426;&#12290;     
-PT     &#25195;&#25551;&#20043;&#21069;&#65292;&#20351;&#29992; TCP ping &#30830;&#23450;&#21738;&#20123;&#20027;&#26426;&#27491;&#22312;&#36816;&#34892;     
-PS     &#23545;&#20110; root &#29992;&#25143;&#65292;&#36825;&#20010;&#36873;&#39033;&#35753; nmap &#20351;&#29992; SYN &#21253;&#32780;&#19981;&#26159; ACK &#21253;&#26469;&#23545;&#30446;&#26631;&#20027;&#26426;&#36827;&#34892;&#25195;&#25551;&#12290;     
-PI     &#35774;&#32622;&#36825;&#20010;&#36873;&#39033;&#65292;&#35753; nmap &#20351;&#29992;&#30495;&#27491;&#30340; ping(ICMP echo &#35831;&#27714;&#65289;&#26469;&#25195;&#25551;&#30446;&#26631;&#20027;&#26426;&#26159;&#21542;&#27491;&#22312;&#36816;&#34892;&#12290;  
-PB     &#36825;&#26159;&#40664;&#35748;&#30340; ping &#25195;&#25551;&#36873;&#39033;&#12290;&#23427;&#20351;&#29992; ACK(-PT) &#21644; ICMP(-PI) &#20004;&#31181;&#25195;&#25551;&#31867;&#22411;&#24182;&#34892;&#25195;&#25551;&#12290;&#22914;&#26524;&#38450;&#28779;&#22681;&#33021;&#22815;&#36807;&#28388;&#20854;&#20013;&#19968;&#31181;&#21253;&#65292;&#20351;&#29992;&#36825;&#31181;&#26041;&#27861;&#65292;&#20320;&#23601;&#33021;&#22815;&#31359;&#36807;&#38450;&#28779;&#22681;&#12290;     
-O     &#36825;&#20010;&#36873;&#39033;&#28608;&#27963;&#23545; TCP/IP &#25351;&#32441;&#29305;&#24449; (fingerprinting) &#30340;&#25195;&#25551;&#65292;&#33719;&#24471;&#36828;&#31243;&#20027;&#26426;&#30340;&#26631;&#24535;&#65292;&#20063;&#23601;&#26159;&#25805;&#20316;&#31995;&#32479;&#31867;&#22411;
-I     &#25171;&#24320; nmap &#30340;&#21453;&#21521;&#26631;&#24535;&#25195;&#25551;&#21151;&#33021;&#12290;     
-f     &#20351;&#29992;&#30862;&#29255; IP &#25968;&#25454;&#21253;&#21457;&#36865; SYN&#12289;FIN&#12289;XMAS&#12289;NULL&#12290;&#21253;&#22686;&#21152;&#21253;&#36807;&#28388;&#12289;&#20837;&#20405;&#26816;&#27979;&#31995;&#32479;&#30340;&#38590;&#24230;&#65292;&#20351;&#20854;&#26080;&#27861;&#30693;&#36947;&#20320;&#30340;&#20225;&#22270;     
-v     &#20887;&#20313;&#27169;&#24335;&#12290;&#24378;&#28872;&#25512;&#33616;&#20351;&#29992;&#36825;&#20010;&#36873;&#39033;&#65292;&#23427;&#20250;&#32473;&#20986;&#25195;&#25551;&#36807;&#31243;&#20013;&#30340;&#35814;&#32454;&#20449;&#24687;&#12290;     
-S &lt;IP&gt;     &#22312;&#19968;&#20123;&#24773;&#20917;&#19979;&#65292;nmap &#21487;&#33021;&#26080;&#27861;&#30830;&#23450;&#20320;&#30340;&#28304;&#22320;&#22336; &#12290;&#22312;&#36825;&#31181;&#24773;&#20917;&#20351;&#29992;&#36825;&#20010;&#36873;&#39033;&#32473;&#20986;&#25351;&#23450; IP &#22320;&#22336; 
-g port     &#35774;&#32622;&#25195;&#25551;&#30340;&#28304;&#31471;&#21475;
-oN     &#25226;&#25195;&#25551;&#32467;&#26524;&#37325;&#23450;&#21521;&#21040;&#19968;&#20010;&#21487;&#35835;&#30340;&#25991;&#20214; logfilename &#20013; 
-oS     &#25195;&#25551;&#32467;&#26524;&#36755;&#20986;&#21040;&#26631;&#20934;&#36755;&#20986;&#12290;     
--host_timeout     &#35774;&#32622;&#25195;&#25551;&#19968;&#21488;&#20027;&#26426;&#30340;&#26102;&#38388;&#65292;&#20197;&#27627;&#31186;&#20026;&#21333;&#20301;&#12290;&#40664;&#35748;&#30340;&#24773;&#20917;&#19979;&#65292;&#27809;&#26377;&#36229;&#26102;&#38480;&#21046;     
--max_rtt_timeout     &#35774;&#32622;&#23545;&#27599;&#27425;&#25506;&#27979;&#30340;&#31561;&#24453;&#26102;&#38388;&#65292;&#20197;&#27627;&#31186;&#20026;&#21333;&#20301;&#12290;&#22914;&#26524;&#36229;&#36807;&#36825;&#20010;&#26102;&#38388;&#38480;&#21046;&#23601;&#37325;&#20256;&#25110;&#32773;&#36229;&#26102;&#12290;&#40664;&#35748;&#20540;&#26159;&#22823;&#32422; 9000 &#27627;&#31186;     
--min_rtt_timeout     &#35774;&#32622; nmap &#23545;&#27599;&#27425;&#25506;&#27979;&#33267;&#23569;&#31561;&#24453;&#20320;&#25351;&#23450;&#30340;&#26102;&#38388;&#65292;&#20197;&#27627;&#31186;&#20026;&#21333;&#20301;     
-M count     &#32622;&#36827;&#34892; TCP connect() &#25195;&#25551;&#26102;&#65292;&#26368;&#22810;&#20351;&#29992;&#22810;&#23569;&#20010;&#22871;&#25509;&#23383;&#36827;&#34892;&#24182;&#34892;&#30340;&#25195;&#25551;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">Tcp ack &#25195;&#25551;&#65292;&#24182;&#21457;2000&#65292;&#36895;&#24230;&#24555;</span>
nmap -n -PA --min-parallelism 2000 172.16.0.0/16 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20165;&#21015;&#20986;&#25351;&#23450;&#32593;&#27573;&#19978;&#30340;&#27599;&#21488;&#20027;&#26426;,&#19981;&#21457;&#36865;&#20219;&#20309;&#25253;&#25991;&#21040;&#30446;&#26631;&#20027;&#26426;.</span>
[root@centos8 ~]#nmap -sL 10.0.0.0/24
Starting Nmap 7.70 ( https://nmap.org ) at 2020-04-23 12:28 CST
Nmap scan report for 10.0.0.0
Nmap scan report for 10.0.0.1
......
Nmap scan report for 10.0.0.254
Nmap scan report for 10.0.0.255
Nmap done: 256 IP addresses (0 hosts up) scanned<span style="color: #a020f0;"> in</span> 1.04 seconds

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#25351;&#23450;&#19968;&#20010;IP&#22320;&#22336;&#33539;&#22260;</span>
[root@centos8 ~]#nmap -sP 10.0.0.1-10 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#21542;&#23384;&#27963;</span>
Nmap scan report for 10.0.0.1
Host is up (0.000081s latency)<span style="color: #483d8b;">.</span>
... ...
Nmap done: 10 IP addresses (5 hosts up) scanned<span style="color: #a020f0;"> in</span> 2.89 seconds

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25209;&#37327;&#25195;&#25551;&#19968;&#20010;&#32593;&#27573;&#30340;&#20027;&#26426;&#23384;&#27963;&#25968;</span>
nmap -sP -v 192.168.1.0/24
nmap &#8211;v &#8211;sn ip/24

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26377;&#20123;&#20027;&#26426;&#20851;&#38381;&#20102;ping&#26816;&#27979;,&#25152;&#20197;&#21487;&#20197;&#20351;&#29992;-P0&#36339;&#36807;ping&#30340;&#25506;&#27979;,&#21487;&#20197;&#21152;&#24555;&#25195;&#25551;&#36895;&#24230;.</span>
nmap -P0 192.168.1.100

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25195;&#25551;&#20027;&#26426;</span>
nmap &#8211;v &#8211;A IP 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#27425;&#24615;&#25195;&#25551;&#22810;&#21488;&#30446;&#26631;&#20027;&#26426;</span>
[root@centos8 ~]#nmap 10.0.0.6 10.0.0.7
Starting Nmap 7.70 ( https://nmap.org ) at 2020-04-23 12:39 CST
Nmap scan report for 10.0.0.6
Host is up (0.00055s latency)<span style="color: #483d8b;">.</span>
Not shown: 998 closed ports
PORT     STATE SERVICE
22/tcp open     ssh
111/tcp open rpcbind
MAC Address: 00:0C:29:4D:EF:2C (VMware)
Nmap scan report for 10.0.0.7
Host is up (0.00050s latency)<span style="color: #483d8b;">.</span>
Not shown: 999 closed ports
PORT     STATE SERVICE
22/tcp open     ssh
MAC Address: 00:0C:29:29:F9:26 (VMware)
Nmap done: 2 IP addresses (2 hosts up) scanned<span style="color: #a020f0;"> in</span> 101.01 seconds

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#19968;&#20010;&#25991;&#20214;&#20013;&#23548;&#20837;IP&#22320;&#22336;,&#24182;&#36827;&#34892;&#25195;&#25551;</span>
[root@centos8 ~]#cat hosts.txt
10.0.0.7
10.0.0.6
58.87.87.99

[root@centos8 ~]#nmap -iL hosts.txt
Starting Nmap 7.70 ( https://nmap.org ) at 2020-04-23 12:43 CST
Nmap scan report for 10.0.0.7
Host is up (0.0024s latency)<span style="color: #483d8b;">.</span>
Not shown: 999 closed ports
PORT     STATE SERVICE
22/tcp open     ssh
MAC Address: 00:0C:29:29:F9:26 (VMware)
Nmap scan report for 10.0.0.6
Host is up (0.0032s latency)<span style="color: #483d8b;">.</span>
Not shown: 998 closed ports
PORT     STATE SERVICE
22/tcp open     ssh
111/tcp open rpcbind
MAC Address: 00:0C:29:4D:EF:2C (VMware)
Nmap scan report for 58.87.87.99
Host is up (0.016s latency)<span style="color: #483d8b;">.</span>
Not shown: 998 filtered ports
PORT         STATE SERVICE
80/tcp     open http
3306/tcp open mysql
Nmap done: 3 IP addresses (3 hosts up) scanned<span style="color: #a020f0;"> in</span> 120.33 seconds

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25506;&#27979;&#30446;&#26631;&#20027;&#26426;&#24320;&#25918;&#30340;&#31471;&#21475;,&#21487;&#25351;&#23450;&#19968;&#20010;&#20197;&#36887;&#21495;&#20998;&#38548;&#30340;&#31471;&#21475;&#21015;&#34920;(&#22914;-PS22,443,80)</span>
[root@centos8 ~]#nmap -PS22,80,443 10.0.0.1
Starting Nmap 7.70 ( https://nmap.org ) at 2020-04-23 12:31 CST
Nmap scan report for 10.0.0.1
Host is up (0.00042s latency)<span style="color: #483d8b;">.</span>
Not shown: 996 filtered ports
PORT         STATE SERVICE
135/tcp open msrpc
139/tcp open netbios-ssn
445/tcp open microsoft-ds
8082/tcp open blackice-alerts
MAC Address: 00:50:56:C0:00:08 (VMware)
Nmap done: 1 IP address (1 host up) scanned<span style="color: #a020f0;"> in</span> 12.65 seconds

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;SYN&#21322;&#24320;&#25918;&#25195;&#25551;</span>
[root@centos8 ~]#nmap -sS 10.0.0.1
Starting Nmap 7.70 ( https://nmap.org ) at 2020-04-23 12:33 CST
Nmap scan report for 10.0.0.1
Host is up (-0.052s latency)<span style="color: #483d8b;">.</span>
Not shown: 996 filtered ports
PORT         STATE SERVICE
135/tcp open msrpc
139/tcp open netbios-ssn
445/tcp open microsoft-ds
8082/tcp open blackice-alerts
MAC Address: 00:50:56:C0:00:08 (VMware)
Nmap done: 1 IP address (1 host up) scanned<span style="color: #a020f0;"> in</span> 10.07 seconds

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25195;&#25551;&#24320;&#25918;&#20102;TCP&#31471;&#21475;&#30340;&#35774;&#22791;</span>
[root@centos8 ~]#nmap -sT 10.0.0.1
Starting Nmap 7.70 ( https://nmap.org ) at 2020-04-23 12:34 CST
Nmap scan report for 10.0.0.1
Host is up (0.00040s latency)<span style="color: #483d8b;">.</span>
Not shown: 996 filtered ports
PORT         STATE SERVICE
135/tcp open msrpc
139/tcp open netbios-ssn
445/tcp open microsoft-ds
8082/tcp open blackice-alerts
MAC Address: 00:50:56:C0:00:08 (VMware)
Nmap done: 1 IP address (1 host up) scanned<span style="color: #a020f0;"> in</span> 4.52 seconds

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25195;&#25551;&#24320;&#25918;&#20102;UDP&#31471;&#21475;&#30340;&#35774;&#22791;</span>
[root@centos8 ~]#nmap -sU 10.0.0.1
Starting Nmap 7.70 ( https://nmap.org ) at 2020-04-23 12:34 CST
Nmap scan report for 10.0.0.1
Host is up (0.00046s latency)<span style="color: #483d8b;">.</span>
Not shown: 999 open|filtered ports
PORT     STATE SERVICE
137/udp open netbios-ns
MAC Address: 00:50:56:C0:00:08 (VMware)
Nmap done: 1 IP address (1 host up) scanned<span style="color: #a020f0;"> in</span> 18.52 seconds

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#25195;&#25551;UDP&#31471;&#21475;</span>
nmap &#8211;e eth1 -sU -O 10.0.0.1 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25195;&#25551;TCP&#21644;UDP&#31471;&#21475;</span>
nmap -sTU -O 10.0.0.1 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;&#25195;&#25551;&#30446;&#26631;&#20027;&#26426;&#26381;&#21153;&#29256;&#26412;&#21495;</span>
[root@centos8 ~]#nmap -sV 10.0.0.7
Starting Nmap 7.70 ( https://nmap.org ) at 2020-04-23 12:37 CST
Nmap scan report for 10.0.0.7
Host is up (0.0011s latency)<span style="color: #483d8b;">.</span>
Not shown: 999 closed ports
PORT     STATE SERVICE VERSION
22/tcp open     ssh         OpenSSH 7.4 (protocol 2.0)
MAC Address: 00:0C:29:29:F9:26 (VMware)
Service detection performed. Please report any incorrect results at
https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned<span style="color: #a020f0;"> in</span> 1.97 seconds

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20027;&#26426;&#24403;&#21069;&#24320;&#25918;&#30340;&#31471;&#21475;</span>
nmap localhost     

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20027;&#26426;&#31471;&#21475;&#65288;1024-65535&#65289;&#20013;&#24320;&#25918;&#30340;&#31471;&#21475;</span>
nmap -p 1024-65535 localhost 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25506;&#27979;&#30446;&#26631;&#20027;&#26426;&#24320;&#25918;&#30340;&#31471;&#21475;</span>
nmap -PS 10.0.0.1 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25506;&#27979;&#25152;&#21015;&#20986;&#30340;&#30446;&#26631;&#20027;&#26426;&#31471;&#21475;</span>
nmap -PS22,80,3306 10.0.0.1 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25506;&#27979;&#30446;&#26631;&#20027;&#26426;&#25805;&#20316;&#31995;&#32479;&#31867;&#22411;</span>
nmap -O 10.0.0.1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25506;&#27979;&#30446;&#26631;&#20027;&#26426;&#25805;&#20316;&#31995;&#32479;&#31867;&#22411;</span>
nmap -A 10.0.0.1
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c21a1969-9af7-4b99-9cc5-aa2b70453543" class="outline-4">
<h4 id="h:c21a1969-9af7-4b99-9cc5-aa2b70453543">netcat</h4>
<div class="outline-text-4" id="text-h:c21a1969-9af7-4b99-9cc5-aa2b70453543">
<p>
网络界的瑞士军刀，即nc
</p>

<div class="org-src-container">
<pre class="src src-sh">nc: &#30001;nc&#25552;&#20379;
&#21478;&#22806;&#19968;&#20010;&#23454;&#29616;&#65306;ncat,&#30001;nmap&#25552;&#20379;
&#25991;&#20214;&#20256;&#36755;&#26041;&#26696;&#65306;&#30417;&#21548;&#32773;&#20026;&#25509;&#25910;&#26041;
    nc -l PORT &gt; /PATH/TO/SOMEFILE <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26381;&#21153;&#26041;&#30417;&#21548;&#31471;&#21475;&#24182;&#23558;&#25968;&#25454;&#20889;&#20837;&#25991;&#20214;</span>
    nc IP PORT &lt; /PATH/FROM/SOMEFILE <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23458;&#25143;&#26041;&#21521;&#26381;&#21153;&#26041;IP &#31471;&#21475;&#20256;&#36755;&#25968;&#25454;</span>

&#25991;&#20214;&#20256;&#36755;&#26041;&#26696;&#65306;&#30417;&#21548;&#32773;&#20026;&#25509;&#25910;&#26041;
    nc -l PORT &lt; /PATH/FROM/SOMEFILE
    nc IP PORT &gt; /PATH/TO/SOMEFILE
&#27880;&#24847;&#65306;&#20256;&#36755;&#30446;&#24405;&#38656;&#35201;&#20808;&#24402;&#26723;&#65307;

-p PORT&#65306; &#25351;&#26126;&#36830;&#25509;&#30417;&#21548;&#30340;&#26381;&#21153;&#22120;&#26102;&#20351;&#29992;&#30340;&#31471;&#21475;&#65307;
web&#23458;&#25143;&#31471;&#65306;
    nc WEBSERVER PORT

&#25195;&#25551;&#22120;&#65306;
    nc -v -w <span style="color: #b22222;"># </span><span style="color: #b22222;">IP -z PORTRAGE</span>
        ~]# nc -w 1 172.16.100.7 -z 1-1023

&#32842;&#22825;&#24037;&#20855;&#65306;
    nc -l PORT
    nc IP PORT
&#20854;&#23427;&#36873;&#39033;&#65306;
    -s SOURCE-IP
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4431fb31-91ad-4a00-9864-363c45b41de9" class="outline-4">
<h4 id="h:4431fb31-91ad-4a00-9864-363c45b41de9">流量控制工具 tc</h4>
<div class="outline-text-4" id="text-h:4431fb31-91ad-4a00-9864-363c45b41de9">
<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">tc qdisc add dev eth0 root netem loss 50% <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#32593;&#21345;&#20002;&#21253;&#29575;</span>
tc qdisc add dev eth0 root netem delay 1000ms <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#32593;&#21345;&#24310;&#36831;</span>
tc qdisc show dev eth0
tc qdisc del 
</pre>
</div>


<p>
参考：
</p>
<ol class="org-ol">
<li><a href="https://support.huawei.com/enterprise/zh/doc/EDOC1100174722/f926746c">链路层</a></li>
<li><a href="https://support.huawei.com/enterprise/zh/doc/EDOC1100174722/2b688c59">网络层</a></li>
<li><a href="https://support.huawei.com/enterprise/zh/doc/EDOC1100174722/6cb678f">传输层</a></li>
<li><a href="https://support.huawei.com/enterprise/zh/doc/EDOC1100174722/a88e445c">应用层</a></li>
</ol>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
