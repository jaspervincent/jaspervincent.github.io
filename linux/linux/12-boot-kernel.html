<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: Linux启动和内核管理</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux: Linux启动和内核管理</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:0b546144-e571-48d9-a009-0f9cbe0cdbe7">CentOS 6 的启动管理</a>
<ul>
<li><a href="#h:2b567e78-f3ae-437e-b118-0c78a9658f39">Linux 组成</a></li>
<li><a href="#h:54676b88-2d8d-44fc-85e2-ad4352393c65">内核设计流派</a></li>
<li><a href="#h:94b1f8fa-6a22-4304-8f3a-369184a4355e">CentOS 6启动流程</a>
<ul>
<li><a href="#h:22a12376-fbdd-4906-aa55-546dcd9816eb">CentOS 6 启动流程</a></li>
<li><a href="#h:f7232f45-7a26-484d-8409-b8856a4acba1">硬件启动POST</a></li>
<li><a href="#h:5e23a4ab-6b97-4074-a986-9431073d2bc7">启动加载器 bootloader</a>
<ul>
<li><a href="#h:e969a394-0bf8-482f-be79-9a4963ad8a90">grub 功能和组成</a></li>
<li><a href="#h:baaa672b-bc8a-4bb4-88a6-d5920b841811">CentOS 6 grub 安装</a></li>
<li><a href="#h:6e1a49bc-5a04-43b2-b36b-f87bce8e5188">grub legacy 管理-老版本</a></li>
<li><a href="#h:01c8ac6f-260f-4472-82ee-29480796bbf8">范例: CentOS 6 grub 1阶段1.5阶段修复</a></li>
<li><a href="#h:d748c701-b6ac-478b-a1f4-e017fbd435ea">范例：破解root口令</a></li>
<li><a href="#h:46b18b4d-50ff-447d-b261-0cd00eb96f42">范例: grub定制背景图：</a></li>
</ul>
</li>
<li><a href="#h:5ad3069c-afe1-4589-afc0-7a21c41947ae">加载 kernel</a>
<ul>
<li><a href="#h:e6735169-2d9b-49a9-a7a6-b4711266f38d">ramdisk文件的制作</a></li>
<li><a href="#h:c7694ad5-1b56-4643-b12c-0667a2e9184a">范例: 误删除/boot/initramfs-2.6.32-754.el6.x86_64.img无法启动，故障恢复</a></li>
<li><a href="#h:a04675a0-6c3c-47e7-9b0c-c3eb21e9ff51">范例：误删除/boot目录，进行故障恢复</a></li>
</ul>
</li>
<li><a href="#h:922e18db-8e34-4983-a49c-e6981c4d049d">init初始化</a>
<ul>
<li><a href="#h:a3070eb9-6255-4bee-982a-1e7ffcfe3ed4">运行级别</a></li>
<li><a href="#h:c24479f4-cd07-49f4-aac2-c46a4868a46e">初始化脚本 sysinit</a></li>
<li><a href="#h:329773be-3b6d-4bda-ae51-75bc045717be">服务管理</a></li>
<li><a href="#h:89dbf263-728d-4b4b-b3e6-12e8d75b9c11">非独立服务</a></li>
<li><a href="#h:eb3705a5-0b35-4b40-9393-53fdd3cffaa9">开机启动文件 rc.local</a></li>
</ul>
</li>
<li><a href="#h:68d3f8f3-bb2c-493c-a893-75b491828d0e">CentOS6 启动过程总结</a></li>
<li><a href="#h:bc7e0987-9d2c-4c05-a5a2-6754a03a6938">启动过程的故障排错</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:49913cb0-0a1e-42a0-9aec-aad809382950">CentOS7</a>
<ul>
<li><a href="#h:cf968388-2306-4340-a133-e0987ef64338">CentOS 7之后版本引导顺序</a></li>
<li><a href="#h:f8905e48-bb3a-42bc-a312-d2ee1162f23e">破解 CentOS 7和8的 root 密码</a></li>
<li><a href="#h:920aa398-c45d-46a3-a9c1-9ea439dd507f">实现GRUB2安全</a></li>
<li><a href="#h:a6970b05-11b5-46fb-a408-4bc10305ed9a">修复GRUB2</a></li>
<li><a href="#h:eb90ecd0-adf0-4fda-9787-375d8ccc54e2">故障排错实战案例</a>
<ul>
<li><a href="#h:4b318177-22c5-4bab-94a2-76eb5afd7e46">实战案例1：centos 7 ，8 破坏MBR后进行恢复</a></li>
<li><a href="#h:8437d6fe-03cf-4818-9a49-8a810e8fc515">实战案例2：Centos 7 ，8删除/boot/grub2/*所有内容进行恢复</a></li>
<li><a href="#h:70071c20-fa3c-4f8d-b9ea-439de69806dc">实战案例3：CentOS 7 ，8 删除/boot/下所有文件后进行恢复</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:de26e8c1-e341-4303-b061-58b9a47e9dbc">systemd</a>
<ul>
<li><a href="#systemd-特性">systemd 特性</a></li>
<li><a href="#h:c2706445-f151-4bdb-aff6-8ba2673635cc">systemctl管理系统服务service unit</a></li>
<li><a href="#h:ea007418-a7c5-4f5d-a690-a15f8663c759">service unit文件格式</a></li>
<li><a href="#h:aa278884-730a-49e7-b6ee-72532922b8e6">运行级别</a></li>
<li><a href="#h:be3a7920-7c43-404b-81a9-b530d92d7ab4">设置内核参数</a></li>
</ul>
</li>
<li><a href="#h:fa9b09be-a7d3-4d9f-8564-44bcfed39546">journalctl</a></li>
<li><a href="#h:10153c76-1ed8-43cb-861e-273504654859">/proc 目录和内核参数管理</a>
<ul>
<li><a href="#h:a9ad6fa0-356f-4c89-9d4c-85b27fa7d308">systctl设置/proc/sys</a></li>
</ul>
</li>
<li><a href="#h:99edcc75-a6f5-464e-a8c4-ee70d80156f3">/sys 目录</a></li>
<li><a href="#h:cf699c8b-b48e-4f44-a0f2-577ecad299b1">内核模块管理和编译</a>
<ul>
<li><a href="#h:4204a51c-b3f6-4d17-ab2e-fd819ae78ced">内核版本</a></li>
<li><a href="#h:8c326ac8-2293-4cd6-a4ed-0b8a19bf4157">内核模块命令</a></li>
<li><a href="#h:f30f3641-467f-49b3-a788-56a87a18d863">编译内核</a></li>
</ul>
</li>
<li><a href="#h:332c7b43-6385-41d2-9f54-965a542e9c76">Busybox</a>
<ul>
<li><a href="#h:a1d005de-1031-4f4c-afcd-6d4da7b3f72a">Busybox介绍</a></li>
<li><a href="#h:ca4d2c03-5a53-4e61-b59e-1ed6b628baec">Busybox使用</a></li>
<li><a href="#h:80f0d7a7-d098-4aee-9bd1-448f8e6068fe">busybox编译安装</a></li>
</ul>
</li>
<li><a href="#h:b31b2d22-3823-4f22-8e68-9cfbf9c37a31">自制linux系统</a>
<ul>
<li><a href="#h:1ef25d2b-9c84-42c9-aaa9-581a8435956d">Centos6自制linux系统</a></li>
</ul>
</li>
<li><a href="#h:1c4bc5c2-f8ee-43c8-b2fb-569c58d50dc6">/proc 其他文件</a></li>
<li><a href="#h:1dc55300-5491-499f-87d4-abaa4325afa9">Linux kernel map</a></li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../index.html">Linux</a></li>
</ul>


<p>
摘要：本文介绍Linux启动和内核管理
</p>

<p>
内容概述
</p>

<ul class="org-ul">
<li>CentOS 6 之前版本的启动流程</li>
<li>服务管理</li>
<li>Grub管理</li>
<li>自制Linux</li>
<li>启动排错</li>
<li>编译安装内核</li>
<li>BusyBox</li>
<li>CentOS 7 以后版本启动流程</li>
<li>Unit介绍</li>
<li>服务管理和查看</li>
<li>启动排错</li>
<li>破解口令</li>
<li>修复Grub2</li>
</ul>
<section id="outline-container-h:0b546144-e571-48d9-a009-0f9cbe0cdbe7" class="outline-2">
<h2 id="h:0b546144-e571-48d9-a009-0f9cbe0cdbe7">CentOS 6 的启动管理</h2>
<div class="outline-text-2" id="text-h:0b546144-e571-48d9-a009-0f9cbe0cdbe7">
</div>
<div id="outline-container-h:2b567e78-f3ae-437e-b118-0c78a9658f39" class="outline-3">
<h3 id="h:2b567e78-f3ae-437e-b118-0c78a9658f39">Linux 组成</h3>
<div class="outline-text-3" id="text-h:2b567e78-f3ae-437e-b118-0c78a9658f39">
<ul class="org-ul">
<li>kernel 实现进程管理、内存管理、网络管理、驱动程序、文件系统、安全功能等功能</li>
<li><p>
rootfs 包括程序和 glibc 库
</p>

<p>
程序：二进制执行文件
</p>

<p>
库：函数集合, function, 调用接口（头文件负责描述）
</p></li>
</ul>
</div>
</div>
<div id="outline-container-h:54676b88-2d8d-44fc-85e2-ad4352393c65" class="outline-3">
<h3 id="h:54676b88-2d8d-44fc-85e2-ad4352393c65">内核设计流派</h3>
<div class="outline-text-3" id="text-h:54676b88-2d8d-44fc-85e2-ad4352393c65">
<ul class="org-ul">
<li>宏内核(monolithic kernel)：又称单内核和强内核，Unix，Linux把所有系统
服务都放到内核里，所有功能集成于同一个程序，分层实现不同功能，系统庞
大复杂，Linux其实在单内核内核实现了模块化，也就相当于吸收了微内核的
优点</li>

<li><p>
微内核(micro kernel)：Windows，Solaris，HarmonyOS
</p>

<p>
简化内核功能，在内核之外的用户态尽可能多地实现系统服务，同时加入相互
之间的安全保护，每种功能使用一个单独子系统实现，将内核功能移到用户空
间，性能差
</p></li>
</ul>
</div>
</div>
<div id="outline-container-h:94b1f8fa-6a22-4304-8f3a-369184a4355e" class="outline-3">
<h3 id="h:94b1f8fa-6a22-4304-8f3a-369184a4355e">CentOS 6启动流程</h3>
<div class="outline-text-3" id="text-h:94b1f8fa-6a22-4304-8f3a-369184a4355e">
</div>
<div id="outline-container-h:22a12376-fbdd-4906-aa55-546dcd9816eb" class="outline-4">
<h4 id="h:22a12376-fbdd-4906-aa55-546dcd9816eb">CentOS 6 启动流程</h4>
<div class="outline-text-4" id="text-h:22a12376-fbdd-4906-aa55-546dcd9816eb">

<figure id="orgc3fe8fe">
<img src="./images/image-20210120111434311.png" alt="image-20210120111434311.png" width="50%">

</figure>



<figure id="orge42270c">
<img src="./images/image-20210227224724401.png" alt="image-20210227224724401.png" width="50%">

</figure>

<p>
POST &#x2013;&gt; Boot Sequence(BIOS) &#x2013;&gt; Boot Loader (MBR) &#x2013;&gt; Kernel(ramdisk)
&#x2013;&gt; rootfs &#x2013;&gt; switchroot &#x2013;&gt; /sbin/init &#x2013;&gt;(/etc/inittab,
/etc/init/*.conf) &#x2013;&gt; 设定运行级别 &#x2013;&gt; 系统初始化脚本 &#x2013;&gt;
关闭或启动对应级别下的服务 &#x2013;&gt; 启动终端
</p>

<ol class="org-ol">
<li>加载BIOS的硬件信息，获取第一个启动设备</li>
<li>读取第一个启动设备MBR的引导加载程序(grub)的启动信息</li>
<li>加载核心操作系统的核心信息，核心开始解压缩，并尝试驱动所有的硬件设备</li>
<li>核心执行init程序，并获取默认的运行信息</li>
<li>init程序执行/etc/rc.d/rc.sysinit文件，重新挂载根文件系统</li>
<li>启动核心的外挂模块</li>
<li>init执行运行的各个批处理文件(scripts)</li>
<li>init执行/etc/rc.d/rc.local</li>
<li>执行/bin/login程序，等待用户登录</li>
<li>登录之后开始以Shell控制主机</li>
</ol>
</div>
</div>
<div id="outline-container-h:f7232f45-7a26-484d-8409-b8856a4acba1" class="outline-4">
<h4 id="h:f7232f45-7a26-484d-8409-b8856a4acba1">硬件启动POST</h4>
<div class="outline-text-4" id="text-h:f7232f45-7a26-484d-8409-b8856a4acba1">
<p>
POST：Power-On-Self-Test，加电自检，是BIOS功能的一个主要部分。负责完
成对CPU、主板、内存、硬盘子系统、显示子系统、串并行接口、键盘等硬件
情况的检测
</p>

<ul class="org-ul">
<li>主板的ROM：BIOS，Basic Input and Output System，保存着有关计算机系统
最重要的基本输入输出程序，系统信息设置、开机加电自检程序和系统启动自
举程序等</li>

<li>主板的RAM：CMOS互补金属氧化物半导体，保存各项参数的设定，按次序查找
引导设备，第一个有引导程序的设备为本次启动设备</li>
</ul>
</div>
</div>
<div id="outline-container-h:5e23a4ab-6b97-4074-a986-9431073d2bc7" class="outline-4">
<h4 id="h:5e23a4ab-6b97-4074-a986-9431073d2bc7">启动加载器 bootloader</h4>
<div class="outline-text-4" id="text-h:5e23a4ab-6b97-4074-a986-9431073d2bc7">
<p>
连接硬件和软件的过度阶段，启动引导操作系统
</p>

<p>
bootloader存放在硬盘的第一个扇区512字节。第一个扇区分为3部分：
</p>
<ul class="org-ul">
<li>前446字节</li>
<li>中间64字节的分区表</li>
<li>最后2个字节，55aa标记位</li>
</ul>
</div>
<div id="outline-container-h:e969a394-0bf8-482f-be79-9a4963ad8a90" class="outline-5">
<h5 id="h:e969a394-0bf8-482f-be79-9a4963ad8a90">grub 功能和组成</h5>
<div class="outline-text-5" id="text-h:e969a394-0bf8-482f-be79-9a4963ad8a90">
<p>
bootloader: 引导加载器，引导程序
</p>

<ul class="org-ul">
<li>windows: ntloader，仅是启动OS</li>
<li>Linux：功能丰富，提供菜单，允许用户选择要启动系统或不同的内核版本；
把用户选定的内核装载到内存中的特定空间中，解压、展开，并把系统控制权
移交给内核</li>
<li>虚拟机bios设定：开机F2(虚拟机</li>
</ul>

<p>
Linux的bootloader
</p>

<ul class="org-ul">
<li>LILO：LInux LOader，早期的bootloader，功能单一</li>
<li>GRUB: GRand Unified Bootloader, CentOS5,6 GRUB 0.97: GRUB Legacy，CentOS 7 以后使用GRUB 2.02</li>
</ul>

<p>
GRUB 启动阶段
</p>

<ul class="org-ul">
<li><p>
primary boot loader :
</p>

<p>
1st stage：MBR的前446个字节
</p>

<p>
1.5 stage： mbr之后的扇区，让stage1中的bootloader能识别stage2所在的
分区上的文件系统
</p></li>

<li>secondary boot loader ：2nd stage，分区文件/boot/grub/</li>
</ul>


<blockquote>
<p>
bootloader找到硬盘的前446个字节后，要进一步进入操作系统进行启动。但启动操作系统的话必然要加载操作系统的文件，那么就必须能识别文件系统，而446字节太小无法存放文件系统的驱动。
通过1.5阶段，利用mbr之后的扇区，找到文件系统驱动。找文件系统驱动后就可以把linux内核对应的分区文件系统加载，并进入到boot中找到内核文件。2阶段就是来存放启动内核相关文件的。grub.conf
定义了内核文件在哪。加载内核操作系统就能进一步启动了。
</p>
</blockquote>

<p>
范例：查看文件系统驱动
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;
</span>modinfo ext4
</pre>
</div>

<p>
如果不小心把某个阶段破坏了，可以通过grub的grub-install命令或者grub来修复。
</p>

<p>
范例： 本实例操作系统，/boot/grub是放在/dev/sda 第1个分区中。 sda1 存放了bootloader 的1阶段、1.5阶段、2阶段
</p>
<div class="org-src-container">
<pre class="src src-sh">df -T
/dev/sda2     /
/dev/sda1    /boot
</pre>
</div>
</div>
</div>
<div id="outline-container-h:baaa672b-bc8a-4bb4-88a6-d5920b841811" class="outline-5">
<h5 id="h:baaa672b-bc8a-4bb4-88a6-d5920b841811">CentOS 6 grub 安装</h5>
<div class="outline-text-5" id="text-h:baaa672b-bc8a-4bb4-88a6-d5920b841811">
<p>
安装grub：
</p>

<p>
(1) grub-install 安装
</p>

<p>
grub stage1和stage1.5到/dev/DISK磁盘上，并复制GRUB相关文件到 DIR/boot目录下
</p>

<div class="org-src-container">
<pre class="src src-sh">grub-install --root-directory=DIR /dev/DISK
</pre>
</div>

<p>
(2) grub
</p>
<div class="org-src-container">
<pre class="src src-sh">grub&gt; root (hd#,#)  hd&#34920;&#31034;&#30828;&#30424;&#65292;#&#21495;&#34920;&#31034;&#31532;&#20960;&#20010;&#30424;&#31532;&#20960;&#20010;&#20998;&#21306;
grub&gt; setup (hd#)
</pre>
</div>

<p>
上面grub stage1和stage1.5阶段都能修复
</p>
</div>
</div>
<div id="outline-container-h:6e1a49bc-5a04-43b2-b36b-f87bce8e5188" class="outline-5">
<h5 id="h:6e1a49bc-5a04-43b2-b36b-f87bce8e5188">grub legacy 管理-老版本</h5>
<div class="outline-text-5" id="text-h:6e1a49bc-5a04-43b2-b36b-f87bce8e5188">
<p>
配置文件：/boot/grub/grub.conf &lt;&#x2013; /etc/grub.conf
stage2及内核等通常放置于一个基本磁盘分区
</p>

<p>
grub legacy 功用：
</p>

<ol class="org-ol">
<li><p>
提供启动菜单、并提供交互式接口 
</p>

<p>
a：内核参数 
</p>

<p>
e：编辑模式，用于编辑菜单 
</p>

<p>
c：命令模式，交互式接口 
</p></li>

<li><p>
加载用户选择的内核或操作系统 
</p>

<p>
允许传递参数给内核 
</p>

<p>
可隐藏启动菜单 
</p></li>
<li><p>
为菜单提供了保护机制 
</p>

<p>
为编辑启动菜单进行认证 
</p>

<p>
为启用内核或操作系统进行认证
</p></li>
</ol>

<p>
<b>grub legacy配置文件：/boot/grub/grub.conf</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">default</span>=#: &#35774;&#23450;&#40664;&#35748;&#21551;&#21160;&#30340;&#33756;&#21333;&#39033;&#65307;&#33756;&#21333;&#39033;(title)&#32534;&#21495;&#20174;0&#24320;&#22987;
<span style="color: #a0522d;">timeout</span>=#&#65306;&#25351;&#23450;&#33756;&#21333;&#39033;&#31561;&#24453;&#36873;&#39033;&#36873;&#25321;&#30340;&#26102;&#38271;
<span style="color: #a0522d;">splashimage</span>=(hd#,#)/PATH/XPM_FILE&#65306;&#33756;&#21333;&#32972;&#26223;&#22270;&#29255;&#25991;&#20214;&#36335;&#24452;  hd&#34920;&#31034;&#30828;&#30424;&#65292;#&#21495;&#34920;&#31034;&#31532;&#20960;&#20010;&#30424;&#31532;&#20960;&#20010;&#20998;&#21306;
password [--md5| --encrypt] STRING: &#21551;&#21160;&#33756;&#21333;&#32534;&#36753;&#35748;&#35777;
hiddenmenu&#65306;&#38544;&#34255;&#33756;&#21333;(title)
title TITLE&#65306;&#23450;&#20041;&#33756;&#21333;&#39033;&#8220;&#26631;&#39064;&#8221;, &#21487;&#20986;&#29616;&#22810;&#27425;
  root (hd#,#)&#65306;&#26597;&#25214;stage2&#21450;kernel&#25991;&#20214;&#25152;&#22312;&#35774;&#22791;&#20998;&#21306;&#65307;&#20026;grub&#30340;&#26681;/boot. &#31532;1&#20010;#&#20195;&#34920;&#31532;&#20960;&#22359;&#30828;&#30424;&#65292;&#31532;2&#20010;#&#20195;&#34920;&#31532;&#20960;&#20010;&#20998;&#21306;
  kernel /PATH/TO/VMLINUZ_FILE [PARAMETERS]&#65306;&#21551;&#21160;&#30340;&#20869;&#26680;&#12290;&#26377;&#20869;&#26680;&#25991;&#20214;&#20301;&#32622;&#65292;&#22914;/vmlinuz;   &#36824;&#26377;&#25972;&#20010;&#25805;&#20316;&#31995;&#32479;&#26681;&#20301;&#32622;&#65292;&#21487;&#20197;&#26159;&#35774;&#22791;&#21517;&#65292;&#22914; <span style="color: #a0522d;">root</span>=/dev/sda2, &#25110;&#32773;&#35774;&#22791;UUID, <span style="color: #a0522d;">&#22914;root</span>=<span style="color: #a0522d;">UUID</span>=e76sljf-sldjf-xx
  initrd /PATH/TO/INITRAMFS_FILE: &#20869;&#26680;&#21305;&#37197;&#30340;ramfs&#25991;&#20214;&#65292;/&#26681;&#23454;&#38469;&#19978;&#26159;/boot&#30446;&#24405;&#12290;&#23384;&#20648;&#20102;&#21508;&#31181;&#25991;&#20214;&#31995;&#32479;&#39537;&#21160;&#31243;&#24207;
  password [--md5|--encrypted ] STRING: &#21551;&#21160;&#36873;&#23450;&#30340;&#20869;&#26680;&#25110;&#25805;&#20316;&#31995;&#32479;&#26102;&#36827;&#34892;&#35748;&#35777;
</pre>
</div>

<p>
范例：grub.conf
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">default</span>=0
<span style="color: #a0522d;">timeout</span>=5
  root (hd0, 0)                                                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26681;&#20026;boot&#30446;&#24405;&#20301;&#32622;&#12290;&#36825;&#37324;&#20026;&#31532;&#19968;&#20010;&#30828;&#30424;&#20013;&#30340;&#31532;&#19968;&#20010;&#21306;&#20998;&#65292;&#36825;&#37324;&#20026;/dev/sda1
</span>  kernel (hd0,0)/vmlinuz <span style="color: #a0522d;">root</span>=/dev/sda2         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#26680;&#21551;&#21160;&#21253;&#21547;&#65292;&#20869;&#26680;&#25991;&#20214;&#20301;&#32622;&#21644;&#25972;&#20010;&#25805;&#20316;&#31995;&#32479;&#30340;&#26681;&#12290; &#20854;&#20182;&#20013;(hd0,0)&#21487;&#30465;&#30053;&#19981;&#20889;
</span>  initrd (hd0,0)/initramfs.img                              <span style="color: #b22222;">#</span><span style="color: #b22222;">boot&#30446;&#24405;&#19979;&#30340;&#25991;&#20214;</span>
</pre>
</div>


<p>
<b>grub的命令行接口</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">help: &#33719;&#21462;&#24110;&#21161;&#21015;&#34920;
help KEYWORD: &#35814;&#32454;&#24110;&#21161;&#20449;&#24687;
<span style="color: #0000ff;">find</span> (hd#,#)/PATH/TO/SOMEFILE&#65306;
<span style="color: #0000ff;">root</span> (hd#,#) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#24403;&#21069;&#20351;&#29992;&#30340;&#26681;&#35774;&#22791;&#65307;&#26681;&#35774;&#22791;&#25351;&#31532;&#20108;&#38454;&#27573;&#25152;&#22312;&#30913;&#30424;&#20998;&#21306;
</span>kernel /PATH/TO/KERNEL_FILE: &#35774;&#23450;&#26412;&#27425;&#21551;&#21160;&#30340;&#20869;&#26680;&#25991;&#20214;&#65307;&#39069;&#22806;&#36824;&#21487;&#28155;&#21152;&#35768;&#22810;&#20869;&#26680;&#25903;&#25345;&#20351;&#29992;&#30340;cmdline&#21442;&#25968;
    &#20363;&#22914;&#65306;<span style="color: #a0522d;">max_loop</span>=100 <span style="color: #a0522d;">selinux</span>=0 <span style="color: #a0522d;">init</span>=/path/to/init  <span style="color: #b22222;">#</span><span style="color: #b22222;">init=&#34920;&#31034;&#21738;&#20010;&#25991;&#20214;&#24403;Init&#31243;&#24207;
</span>initrd /PATH/TO/INITRAMFS_FILE: &#35774;&#23450;&#20026;&#36873;&#23450;&#30340;&#20869;&#26680;&#25552;&#20379;&#39069;&#22806;&#25991;&#20214;&#30340;ramdisk
boot: &#24341;&#23548;&#21551;&#21160;&#36873;&#23450;&#30340;&#20869;&#26680;
</pre>
</div>

<p>
cat /proc/cmdline 内核参数
</p>

<p>
内核参数文档:
</p>

<div class="org-src-container">
<pre class="src src-sh">/usr/share/doc/kernel-doc-2.6.32/Documentation/kernel-parameters.txt
</pre>
</div>

<p>
grub legacy识别硬盘设备
</p>

<div class="org-src-container">
<pre class="src src-sh">(hd#,#)
hd#: &#30913;&#30424;&#32534;&#21495;&#65292;&#29992;&#25968;&#23383;&#34920;&#31034;&#65307;&#20174;0&#24320;&#22987;&#32534;&#21495;
<span style="color: #b22222;">#</span><span style="color: #b22222;">: &#20998;&#21306;&#32534;&#21495;&#65292;&#29992;&#25968;&#23383;&#34920;&#31034;; &#20174;0&#24320;&#22987;&#32534;&#21495;
</span>&#31034;&#20363;&#65306;
(hd0,0) &#31532;&#19968;&#22359;&#30828;&#30424;&#65292;&#31532;&#19968;&#20010;&#20998;&#21306;
</pre>
</div>

<p>
手动在grub命令行接口启动系统
</p>

<div class="org-src-container">
<pre class="src src-sh">grub&gt; root (hd#,#) &#25214;&#21040;grub&#30340;&#26681;
grub&gt; kernel /vmlinuz-VERSION-RELEASE ro <span style="color: #a0522d;">root</span>=/dev/DEVICE 
grub&gt; initrd /initramfs-VERSION-RELEASE.img
grub&gt; boot
</pre>
</div>


<p>
grub加密生成grub口令
</p>

<div class="org-src-container">
<pre class="src src-sh">grub-md5-crypt
grub-crypt
</pre>
</div>

<p>
更多生成密码的方法，请看<a href="https://xuchangwei.com/linux/linux/04linux-user-groups-and-permission-management/linux-user-groups-and-permission-management">用户组和权限管理章节</a>。
</p>
</div>
</div>
<div id="outline-container-h:01c8ac6f-260f-4472-82ee-29480796bbf8" class="outline-5">
<h5 id="h:01c8ac6f-260f-4472-82ee-29480796bbf8">范例: CentOS 6 grub 1阶段1.5阶段修复</h5>
<div class="outline-text-5" id="text-h:01c8ac6f-260f-4472-82ee-29480796bbf8">
<p>
范例：修复grub的第1阶段故障
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos6 grub]#hexdump -C -n 512 /dev/sda
00000000  eb 48 90 10 8e d0 bc 00  b0 b8 00 00 8e d8 8e c0  |.H..............|
    ......
000001b0  00 00 00 00 00 00 00 00  b7 47 02 00 00 00 80 20  |.........G..... |
000001c0  21 00 83 aa 28 82 00 08  00 00 00 00 20 00 00 aa  |!...(....... ...|
000001d0  29 82 83 fe ff ff 00 08  20 00 00 00 35 0c 00 fe  |)....... ...5...|
000001e0  ff ff 83 fe ff ff 00 08  55 0c 00 80 1a 06 00 fe  |........U.......|
000001f0  ff ff 05 fe ff ff 00 88  6f 12 00 78 90 06 55 aa  |........o..x..U.|
00000200

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30772;&#22351;grub&#31532;1&#38454;&#27573;, &#21069;446&#23383;&#33410;&#28165;0&#12290;&#20998;&#21306;&#34920;&#19981;&#35201;&#30772;&#22351;&#65292;&#19981;&#28982;&#25214;&#19981;&#21040;&#20998;&#21306;&#20102;
</span>[root@centos6 grub]#dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=/dev/sda <span style="color: #a0522d;">bs</span>=1 <span style="color: #a0522d;">count</span>=446
446+0 records<span style="color: #a020f0;"> in</span>
446+0 records out
446 bytes (446 B) copied, 0.00200007 s, 223 kB/s

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26159;&#21542;&#34987;&#30772;&#22351;
</span>[root@centos6 grub]#hexdump -C -n 512 /dev/sda
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
......
000001b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 80 20  |............... |
000001c0  21 00 83 aa 28 82 00 08  00 00 00 00 20 00 00 aa  |!...(....... ...|
000001d0  29 82 83 fe ff ff 00 08  20 00 00 00 35 0c 00 fe  |)....... ...5...|
000001e0  ff ff 83 fe ff ff 00 08  55 0c 00 80 1a 06 00 fe  |........U.......|
000001f0  ff ff 05 fe ff ff 00 88  6f 12 00 78 90 06 55 aa  |........o..x..U.|
00000200

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;&#26426;&#22120;&#65292;&#21457;&#29616;&#26080;&#27861;&#21551;&#21160;
</span>[root@centos6 grub]#reboot
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20986;&#29616;&#19979;&#38754;&#25552;&#31034;</span>
</pre>
</div>


<figure id="org6abf1f0">
<img src="./images/image-20210120111655668.png" alt="image-20210120111655668.png" width="50%">

</figure>

<p>
修复bootloader 1阶段
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25554;&#20837;&#20809;&#30424;&#65292;&#20351;&#29992;&#20809;&#30424;&#21551;&#21160;&#65292;&#36827;&#20837;rescue&#25937;&#25588;&#27169;&#24335;&#8220;Rescue installed system&#8221;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25805;&#20316;&#31995;&#32479;&#30340;&#26681;&#25346;&#36733;&#21040;&#20102;/mnt/sysimge&#25991;&#20214;&#22841;&#19979;
</span>chroot /mnt/sysimage    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20999;&#26681;&#65292;&#23558;&#30913;&#30424;&#30340;&#26681;&#24403;&#30495;&#27491;&#30340;&#26681;
</span>grub-install /dev/sda      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#22797;1, 1.5&#38454;&#27573;
</span>sync <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25968;&#25454;&#20889;&#20837;&#30913;&#30424;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#21069;446&#23383;&#33410;
</span>hexdump -C -n 512 /dev/sda <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;MBR&#20998;&#21306;&#26159;&#21542;&#20462;&#22797;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">exit
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">exit
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">reboot</span>
</pre>
</div>

<p>
范例：修复grub的第1.5 阶段故障
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#30772;&#22351;1&#38454;&#27573;
</span>[root@centos6 ~]#dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=/dev/sda <span style="color: #a0522d;">bs</span>=1 <span style="color: #a0522d;">count</span>=446
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#22797;&#25152;&#26377;&#38454;&#27573;
</span>[root@centos6 ~]#grub
grub&gt; root (hd0,0)
<span style="color: #0000ff;">root</span> (hd0,0)
 Filesystem type is ext2fs, partition type 0x83
grub&gt; setup (hd0)
<span style="color: #0000ff;">setup</span> (hd0)
 Checking if <span style="color: #8b2252;">"/boot/grub/stage1"</span> exists... no
 Checking if <span style="color: #8b2252;">"/grub/stage1"</span> exists... yes
 Checking if <span style="color: #8b2252;">"/grub/stage2"</span> exists... yes
 Checking if <span style="color: #8b2252;">"/grub/e2fs_stage1_5"</span> exists... yes
 Running <span style="color: #8b2252;">"embed /grub/e2fs_stage1_5 (hd0)"</span>...  27 sectors are embedded.
succeeded
 Running <span style="color: #8b2252;">"install /grub/stage1 (hd0) (hd0)1+27 p (hd0,0)/grub/stage2 /grub/grub.conf"</span>... succeeded
Done.
grub&gt; quit
quit

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#30772;&#22351;&#31532;1.5 &#38454;&#27573;&#25925;&#38556;
</span>[root@centos6 ~]#dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=/dev/sda <span style="color: #a0522d;">bs</span>=512 <span style="color: #a0522d;">count</span>=25 <span style="color: #a0522d;">seek</span>=1
[root@centos6 ~]#reboot
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26080;&#27861;&#21551;&#21160;&#65292;&#26174;&#31034;&#19979;&#38754;&#30028;&#38754;</span>
</pre>
</div>


<figure id="org18cfa3f">
<img src="./images/image-20210214172820316.png" alt="image-20210214172820316.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20809;&#30424;&#21551;&#21160;&#65292;&#36827;&#20837;rescue&#27169;&#24335; 
</span>chroot /mnt/sysimage
grub-install /dev/sda
sync 
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25353; ctrl+alt+delete &#19977;&#20010;&#38190;&#37325;&#21551;&#21160;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d748c701-b6ac-478b-a1f4-e017fbd435ea" class="outline-5">
<h5 id="h:d748c701-b6ac-478b-a1f4-e017fbd435ea">范例：破解root口令</h5>
<div class="outline-text-5" id="text-h:d748c701-b6ac-478b-a1f4-e017fbd435ea">
<p>
方法1：插入光盘，使用救援模式，进入系统把/etc/shadow中root密码删除
</p>

<p>
方法2：单用户模式，无法连网络，只能在现场
</p>
<pre class="example" id="org6f57215">
1. 操作系统启动时，输入任意键显示出grub菜单。提示如下
    回车：直接启动
    e: 启动前编辑命令
    a: 修改内核参数
    c: 进入命令行

2. 输入a添加参数，在选定的kernel最后附加1、 s、 S、single 任意一个，都可以进入单用户模式。
3. 重设root密码，输入 passwd
</pre>

<p>
范例: 给grub 添加密码,防止单用户模式破解root密码
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#grub-crypt <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#23494;&#30721;
</span>Password: 
Retype password: 
$<span style="color: #a0522d;">6</span>$<span style="color: #a0522d;">RedtvBe0D0sM8yKq</span>$<span style="color: #a0522d;">yKwmmnHSDb9wDRUuZbC3H1ZNwIlf</span>/Mh88MXa3JzXloXyy0hXIxFwLIoMdgmYFfkWXxkP.vW3ypIla4P5zUKuT.

[root@centos6 ~]#vim /boot/grub/grub.conf <span style="color: #b22222;"># </span><span style="color: #b22222;">grub &#21152;&#23494;
</span><span style="color: #a0522d;">default</span>=0
<span style="color: #a0522d;">timeout</span>=5
password --encrypt $<span style="color: #a0522d;">6</span>$<span style="color: #a0522d;">RedtvBe0D0sM8yKq</span>$<span style="color: #a0522d;">yKwmmnHSDb9wDRUuZbC3H1ZNwIlf</span>/Mh88MXa3JzXloXyy0hXIxFwLIoMdgmYFfkWXxkP.vW3ypIla4P5zUKuT.
<span style="color: #a0522d;">splashimage</span>=(hd0,0)/grub/splash.xpm.gz
hiddenmenu
title CentOS 6 (2.6.32-754.el6.x86_64)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:46b18b4d-50ff-447d-b261-0cd00eb96f42" class="outline-5">
<h5 id="h:46b18b4d-50ff-447d-b261-0cd00eb96f42">范例: grub定制背景图：</h5>
<div class="outline-text-5" id="text-h:46b18b4d-50ff-447d-b261-0cd00eb96f42">
<ul class="org-ul">
<li>JPG/JPEG 图像必须是 8-bit (256 色)</li>
<li>图像应该是非索引的，RGB</li>
</ul>

<p>
方法1：GRUB_BACKGROUND 中定义图像路径
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20934;&#22791;png&#25110;jpg&#25991;&#20214;, &#22914;a.png&#65292;&#25918;&#21040;/usr/share/grub/
</span>vim /etc/default/grub
<span style="color: #b22222;">#</span><span style="color: #b22222;">GRUB_TERMINAL=console  # &#27880;&#37322;&#35813;&#34892;&#65292;&#40664;&#35748;&#24773;&#20917;&#19979;&#32456;&#31471;&#20197;&#25991;&#26412;&#26041;&#24335;&#36755;&#20986;
</span><span style="color: #a0522d;">GRUB_BACKGROUND</span>=<span style="color: #8b2252;">"/usr/share/grub/a.png"</span>

update-grub
reboot
</pre>
</div>

<p>
方法2：安装主题背景
</p>

<ul class="org-ul">
<li><a href="https://www.gnome-look.org/">https://www.gnome-look.org/</a> 下载主题文件</li>
</ul>
<div class="org-src-container">
<pre class="src src-sh">mkdir -p /boot/grub2/themes <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23384;&#25918;&#30382;&#32932;&#37197;&#32622;&#25991;&#20214;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#36733;&#30382;&#32932;
</span>cp -r bios/ /boot/grub/themes/

 &gt;_ tree -L 2 /boot/grub2/themes/
/boot/grub2/themes/  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#30830;&#20445;&#26159;&#19968;&#20010;&#29420;&#31435;&#30340;&#30446;&#24405;
</span><span style="color: #ff00ff;">`-- bios
    |-- a.jpg
    |-- b.jpg
    `</span>-- theme.txt   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#30830;&#20445;&#30446;&#24405;&#19979;&#26377;&#36825;&#20010;&#25991;&#20214;
</span>
vim /etc/default/grub
<span style="color: #b22222;">#</span><span style="color: #b22222;">GRUB_TERMINAL=console  # &#27880;&#37322;&#35813;&#34892;&#65292;&#40664;&#35748;&#24773;&#20917;&#19979;&#32456;&#31471;&#20197;&#25991;&#26412;&#26041;&#24335;&#36755;&#20986;
</span><span style="color: #a0522d;">GRUB_THEME</span>=<span style="color: #8b2252;">"/boot/grub2/themes/bois/theme.txt"</span>  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#30382;&#32932;&#37197;&#32622;&#25991;&#20214;
</span><span style="color: #a0522d;">GRUB_GFXMODE</span>=1920x1080,auto                    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32456;&#31471;&#20998;&#36776;&#29575;&#12290;&#20248;&#20808;&#20351;&#29992;1920x1080&#65292;&#26080;&#27861;&#28385;&#36275;&#21017;&#33258;&#21160;&#35774;&#32622;&#20998;&#36776;&#29575;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">grub&#37197;&#32622;&#25991;&#20214;&#29983;&#20135;
</span>grub-mkconfig &gt;/boot/grub/grub.cfg  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25110;&#32773; update-grub
</span>reboot  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;&#29983;&#25928;</span>
</pre>
</div>

<p>
gimp软件，xpm图片格式要求
</p>
<ol class="org-ol">
<li>图片必须是xpm格式</li>
<li>图片大小必须是640×480</li>
<li>图片只能有14种颜色</li>
</ol>

<p>
范例：生成背景图片
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20934;&#22791;&#22270;&#29255; winner.png &#65292;&#21046;&#20316;
</span>[root@centos6 ~]#convert -resize 640x480 -colors 14 winner.png splash.xpm
[root@centos6 ~]#more splash.xpm <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32467;&#26524;&#20013;&#26377; 640 480 41&#31561;&#21363;&#20026;&#27491;&#24120;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104; grub &#25903;&#25345;&#30340; gz&#26684;&#24335;&#65292;splash.xpm.gz
</span>[root@centos6 ~]#gzip   splash.xpm 
[root@centos6 ~]#mv splash.xpm.gz /boot/grub
&#20462;&#25913;/boot/grub/menu.lst
splashimage /boot/grub/splash.xpm.gz
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:5ad3069c-afe1-4589-afc0-7a21c41947ae" class="outline-4">
<h4 id="h:5ad3069c-afe1-4589-afc0-7a21c41947ae">加载 kernel</h4>
<div class="outline-text-4" id="text-h:5ad3069c-afe1-4589-afc0-7a21c41947ae">
<p>
kernel 自身初始化过程
</p>

<ol class="org-ol">
<li>探测可识别到的所有硬件设备</li>
<li>加载硬件驱动程序（借助于ramdisk加载驱动）</li>
<li>以只读方式挂载根文件系统</li>
<li>运行用户空间的第一个应用程序：/sbin/init</li>
</ol>

<p>
Linux内核特点：
</p>

<ul class="org-ul">
<li>支持模块化：.ko（内核对象），如：文件系统，硬件驱动，网络协议等</li>
<li>支持内核模块的动态装载和卸载</li>
</ul>

<p>
内核组成部分：
</p>

<ul class="org-ul">
<li><p>
核心文件：/boot/vmlinuz-VERSION-release
</p>

<p>
ramdisk：辅助的伪根系统，加载相应的硬件驱动，ramdisk &#x2013;&gt; ramfs提高速度
</p>
<ul class="org-ul">
<li>CentOS 5 /boot/initrd-VERSION-release.img</li>
<li>CentOS 6 以后版本/boot/initramfs-VERSION-release.img （加载根）</li>
</ul></li>

<li>模块文件：/lib/modules/VERSION-release</li>
</ul>

<p>
范例：误删除内核文件/boot/vmlinuz-2.6.32-754.el6.x86_64无法启动，故障恢复
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20869;&#26680;&#25991;&#20214;&#26469;&#33258;&#21738;&#20010;&#21253;
</span>[root@centos6 ~]#rpm -qf /boot/vmlinuz-2.6.32-754.el6.x86_64
kernel-2.6.32-754.el6.x86_64

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30772;&#22351;&#65292;&#21024;&#38500;&#20869;&#26680;&#25991;&#20214;
</span>[root@centos6 ~]#rm -f /boot/vmlinuz-2.6.32-754.el6.x86_64
[root@centos6 ~]#reboot

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25554;&#20837;&#20809;&#30424;&#65292;&#20351;&#29992;&#20809;&#30424;&#21551;&#21160;&#65292;&#36827;&#20837;rescue&#25937;&#25588;&#27169;&#24335;&#8220;Rescue installed system&#8221;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25805;&#20316;&#31995;&#32479;&#30340;&#26681;&#25346;&#36733;&#21040;&#20102;/mnt/sysimge&#25991;&#20214;&#22841;&#19979;
</span>chroot /mnt/sysimage
mount /dev/sr0 /mnt/  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25346;&#20809;&#30424;&#65292;&#37324;&#38754;&#26377;&#20869;&#26680;&#23433;&#35013;&#21253;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1 
</span>rpm -ivh /mnt/Packages/kernel.xxxx.rpm --root=/mnt/sysimage --force  

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2 
</span>cp /mnt/isolinux/vmlinuz /boot/vmlinuz-2.6.32-754.el6.x86_64
sync
<span style="color: #a020f0;">exit</span>
reboot
</pre>
</div>
</div>
<div id="outline-container-h:e6735169-2d9b-49a9-a7a6-b4711266f38d" class="outline-5">
<h5 id="h:e6735169-2d9b-49a9-a7a6-b4711266f38d">ramdisk文件的制作</h5>
<div class="outline-text-5" id="text-h:e6735169-2d9b-49a9-a7a6-b4711266f38d">
<p>
mkinitrd命令
</p>
<div class="org-src-container">
<pre class="src src-sh">mkinitrd /boot/initramfs-$(uname -r).img $(uname -r) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38388;&#25509;&#35843;&#29992;dracut&#21629;&#20196;</span>
</pre>
</div>

<p>
dracut命令
</p>
<div class="org-src-container">
<pre class="src src-sh">dracut /boot/initramfs-$(uname -r).img $(uname -r)
</pre>
</div>

<blockquote>
<p>
目前，加载文件系统的驱动是boot所在分区的文件系统驱动。而我们加载文件系统驱动能找到内核了，
内核启动之后加载真正硬盘根，真正硬盘根的文件系统和boot中的根(/vmlinuz)文件系统可能是不一样的，
进入到真正硬盘中根就要加载文件系统驱动，驱动程序文件实际上是在硬盘上的，通过 <code>modinfo ext4</code> 来找到已运行实例文件系统对应驱动位置，
但我们不能直接进入真正的硬盘，这时就会用/boot下文件，提前存放了各种文件系统驱动程序。
<code>initrd /initramfs.im</code> 精简版小linux系统，存放了多种文件系统驱动
</p>

<p>
加载操作系统根后，才能进行后续的启动过程
</p>
</blockquote>

<p>
范例：查看文件系统驱动
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25991;&#20214;&#31867;&#22411;&#65292;&#21457;&#29616;&#26159;&#21387;&#32553;&#25991;&#20214;&#65292;&#20351;&#29992;&#23545;&#24212;&#30340;&#35299;&#21387;&#32553;&#24037;&#20855;&#35299;&#21387;
</span>[root@test jasper]# file initramfs-6.1.106-116.188.amzn2023.aarch64.img 
initramfs-6.1.106-116.188.amzn2023.aarch64.img: Zstandard compressed data (v0.8+), Dictionary ID: None
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#25991;&#20214;&#21518;&#32512;
</span>[root@test jasper]# mv initramfs-6.1.106-116.188.amzn2023.aarch64.img  initramfs-6.1.106-116.188.amzn2023.aarch64.img.zst
[root@test jasper]# zstd -d initramfs-6.1.106-116.188.amzn2023.aarch64.img.zst 
initramfs-6.1.106-116.188.amzn2023.aarch64.img.zst: 50185216 bytes

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25991;&#20214;&#31867;&#22411;&#65292;&#21457;&#29616;&#26159;cpio&#25991;&#20214;
</span>[root@test jasper]# file initramfs-6.1.106-116.188.amzn2023.aarch64.img
initramfs-6.1.106-116.188.amzn2023.aarch64.img: ASCII cpio archive (SVR4 with no CRC)
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;cpio&#25991;&#20214;&#20869;&#23481;
</span>[root@test jasper]# cpio -tv &lt; initramfs-6.1.106-116.188.amzn2023.aarch64.img
drwxr-xr-x  12 root     root            0 Jul  6  2023 .
lrwxrwxrwx   1 root     root            7 Jul  6  2023 bin -&gt; usr/bin
drwxr-xr-x   2 root     root            0 Jul  6  2023 dev
crw-r--r--   1 root     root       5,   1 Jul  6  2023 dev/console
crw-r--r--   1 root     root       1,  11 Jul  6  2023 dev/kmsg
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35299;&#21387;cpio&#25991;&#20214;
</span>[root@test jasper]# cpio -idv &lt; initramfs-6.1.106-116.188.amzn2023.aarch64.img
[root@test jasper]# ls
bin  etc   initramfs-6.1.106-116.188.amzn2023.aarch64.img      lib    proc  run   shutdown  sysroot  usr
dev  init  initramfs-6.1.106-116.188.amzn2023.aarch64.img.zst  lib64  root  sbin  sys       tmp      var

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26377;&#27809;&#26377;ext4&#30340;&#39537;&#21160;
</span>[root@test jasper]# find -name ext4.ko
./usr/lib/modules/6.1.106-116.188.amzn2023.aarch64/kernel/fs/ext4/ext4.ko
</pre>
</div>

<p>
小结：启动过程
</p>
<ol class="org-ol">
<li>POST加电自检</li>
<li>bootloader</li>
<li>kernel 借助grub.conf找到操作系统内核</li>
<li>intramfs.&lt;version&gt;.img 在进入到操作系统的根之前，借助intramfs.&lt;version&gt;.img 小型linux来挂载完整版的根</li>
<li>/ 进入操作系统的根</li>
</ol>
</div>
</div>
<div id="outline-container-h:c7694ad5-1b56-4643-b12c-0667a2e9184a" class="outline-5">
<h5 id="h:c7694ad5-1b56-4643-b12c-0667a2e9184a">范例: 误删除/boot/initramfs-2.6.32-754.el6.x86_64.img无法启动，故障恢复</h5>
<div class="outline-text-5" id="text-h:c7694ad5-1b56-4643-b12c-0667a2e9184a">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#30772;&#22351;&#65292;&#21024;&#38500;&#20266;&#26681;&#25991;&#20214;&#31995;&#32479;
</span>[root@centos6 ~]#rm -f /boot/initramfs-2.6.32-754.el6.x86_64.img
[root@centos6 ~]#reboot

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25554;&#20837;&#20809;&#30424;&#65292;&#20351;&#29992;&#20809;&#30424;&#21551;&#21160;&#65292;&#36827;&#20837;rescue&#25937;&#25588;&#27169;&#24335;&#8220;Rescue installed system&#8221;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25805;&#20316;&#31995;&#32479;&#30340;&#26681;&#25346;&#36733;&#21040;&#20102;/mnt/sysimge&#25991;&#20214;&#22841;&#19979;
</span>chroot /mnt/sysimage
mkinitrd /boot/initramfs-$(uname -r).img $(uname -r)
sync

<span style="color: #a020f0;">exit</span>
<span style="color: #a020f0;">exit</span>
reboot
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a04675a0-6c3c-47e7-9b0c-c3eb21e9ff51" class="outline-5">
<h5 id="h:a04675a0-6c3c-47e7-9b0c-c3eb21e9ff51">范例：误删除/boot目录，进行故障恢复</h5>
<div class="outline-text-5" id="text-h:a04675a0-6c3c-47e7-9b0c-c3eb21e9ff51">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#30772;&#22351;&#65292;&#21024;&#38500;/boot&#30446;&#24405;
</span>rm -fr /boot
reboot

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25554;&#20837;&#20809;&#30424;&#65292;&#20351;&#29992;&#20809;&#30424;&#21551;&#21160;&#65292;&#36827;&#20837;rescue&#25937;&#25588;&#27169;&#24335;&#8220;Rescue installed system&#8221;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25805;&#20316;&#31995;&#32479;&#30340;&#26681;&#25346;&#36733;&#21040;&#20102;/mnt/sysimge&#25991;&#20214;&#22841;&#19979;
</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20808;&#20462;&#22797;&#20869;&#26680;&#65292;&#20877;&#20462;&#22797;grub
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">1.&#20462;&#20869;&#26680;
</span>chroot /mnt/sysimage
mount /dev/sr0 /mnt/  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25346;&#20809;&#30424;&#65292;&#37324;&#38754;&#26377;&#20869;&#26680;&#23433;&#35013;&#21253;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1 
</span>rpm -ivh /mnt/Packages/kernel.xxxx.rpm --root=/mnt/sysimage --force
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2 
</span>cp /mnt/isolinux/vmlinuz /boot/ <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#22797;&#20869;&#26680;
</span>mkinitrd /boot/initramfs.img $(uname -r)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#22797;nitramfs
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">2.&#20462;grub
</span>grub-install /dev/sda

<span style="color: #b22222;">#</span><span style="color: #b22222;">2.1&#28155;&#21152;grub.conf
</span>cat &lt;&lt;\EOF&gt; /boot/grub/grub.conf<span style="color: #ffa54f;">
default=0
timeout=5
title My Linux
kernel (hd0,0)/vmlinuz root=/dev/sda2
initrd (hd0,0)/initramfs.img
EOF
</span>
sync
reboot
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:922e18db-8e34-4983-a49c-e6981c4d049d" class="outline-4">
<h4 id="h:922e18db-8e34-4983-a49c-e6981c4d049d">init初始化</h4>
<div class="outline-text-4" id="text-h:922e18db-8e34-4983-a49c-e6981c4d049d">
<p>
POST &#x2013;&gt; BootSequence (BIOS) &#x2013;&gt; Bootloader(MBR) &#x2013;&gt; kernel(ramdisk) &#x2013;&gt;rootfs(只读) &#x2013;&gt; init（systemd）
</p>

<p>
小结：启动过程
</p>
<ol class="org-ol">
<li>POST加电自检</li>
<li>GRUB1阶段MBR446</li>
<li>GRUB1.5阶段MBR之后(提供grub2文件所有分区的文件系统)</li>
<li>GRUB2阶段(grub.conf)</li>
<li>kernel (initramfs.img)借助grub.conf找到操作系统内核, 根分区的文件系统由initramfs.img提供</li>
<li>/ 进入操作系统的根</li>
<li>/sbin/init 加载系统中第一个进程，初始化</li>
<li><i>etc/inittab 进入系统模式, 每个模式启动的服务是不一样的。每个模式都一个文件夹 /etc/rc*.d</i>, 如 <i>etc/rc0.d</i>, <i>etc/rc1.d</i>,&#x2026;, <i>etc/rc6.d</i>, <i>etc/rc.d</i>.   文件夹里都是软连接指向服务启动停止脚本 /etc/init.d/*</li>
</ol>

<p>
init程序的类型：
</p>

<ol class="org-ol">
<li>SysV: init, CentOS 5之前 配置文件：/etc/inittab</li>
<li>Upstart: init,CentOS 6 配置文件：/etc/inittab, /etc/init/*.conf</li>
<li>Systemd：systemd, CentOS 7 配置文件：/usr/lib/systemd/system   /etc/systemd/system</li>
</ol>
</div>
<div id="outline-container-h:a3070eb9-6255-4bee-982a-1e7ffcfe3ed4" class="outline-5">
<h5 id="h:a3070eb9-6255-4bee-982a-1e7ffcfe3ed4">运行级别</h5>
<div class="outline-text-5" id="text-h:a3070eb9-6255-4bee-982a-1e7ffcfe3ed4">
<p>
运行级别：为系统运行或维护等目的而设定；0-6：7个级别，一般使用3,
5做为默认级别
</p>

<div class="org-src-container">
<pre class="src src-sh">0&#65306;&#20851;&#26426;
1&#65306;&#21333;&#29992;&#25143;&#27169;&#24335;(root&#33258;&#21160;&#30331;&#24405;), single, &#32500;&#25252;&#27169;&#24335;
2&#65306;&#22810;&#29992;&#25143;&#27169;&#24335;&#65292;&#21551;&#21160;&#32593;&#32476;&#21151;&#33021;&#65292;&#20294;&#19981;&#20250;&#21551;&#21160;NFS&#65307;&#32500;&#25252;&#27169;&#24335;
3&#65306;&#22810;&#29992;&#25143;&#27169;&#24335;&#65292;&#27491;&#24120;&#27169;&#24335;&#65307;&#25991;&#26412;&#30028;&#38754;
4&#65306;&#39044;&#30041;&#32423;&#21035;&#65307;&#21487;&#21516;3&#32423;&#21035;
5&#65306;&#22810;&#29992;&#25143;&#27169;&#24335;&#65292;&#27491;&#24120;&#27169;&#24335;&#65307;&#22270;&#24418;&#30028;&#38754;
6&#65306;&#37325;&#21551;
</pre>
</div>

<p>
切换级别：
</p>

<div class="org-src-container">
<pre class="src src-sh">init <span style="color: #b22222;">#</span>
</pre>
</div>

<p>
查看级别：
</p>

<div class="org-src-container">
<pre class="src src-sh">runlevel 
who -r
</pre>
</div>

<p>
定义运行级别
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/inittab
</pre>
</div>

<p>
CentOS 5 的inittab文件还定义以下内容
</p>

<pre class="example" id="orgc26a1c5">
初始运行级别(RUN LEVEL)
系统初始化脚本
对应运行级别的脚本目录
捕获某个关键字顺序
定义UPS电源终端/恢复脚本
在虚拟控制台生成getty
在运行级别5初始化X
</pre>

<p>
CentOS 5 的inittab文件每一行格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">id:runlevel:action:process

id&#65306;&#26159;&#24799;&#19968;&#26631;&#35782;&#35813;&#39033;&#30340;&#23383;&#31526;&#24207;&#21015;
runlevels&#65306; &#23450;&#20041;&#20102;&#25805;&#20316;&#25152;&#20351;&#29992;&#30340;&#36816;&#34892;&#32423;&#21035;
action&#65306; &#25351;&#23450;&#20102;&#35201;&#25191;&#34892;&#30340;&#29305;&#23450;&#25805;&#20316;
         <span style="color: #483d8b;">wait</span>: &#20999;&#25442;&#33267;&#27492;&#32423;&#21035;&#36816;&#34892;&#19968;&#27425;
         respawn&#65306;&#27492;process&#32456;&#27490;&#65292;&#23601;&#37325;&#26032;&#21551;&#21160;&#20043;
         initdefault&#65306;&#35774;&#23450;&#40664;&#35748;&#36816;&#34892;&#32423;&#21035;&#65307;process&#30465;&#30053;
         sysinit&#65306;&#35774;&#23450;&#31995;&#32479;&#21021;&#22987;&#21270;&#26041;&#24335;
process&#65306;&#23450;&#20041;&#20102;&#35201;&#25191;&#34892;&#30340;&#36827;&#31243;
</pre>
</div>

<p>
范例：CentOS 5 的inittab文件
</p>

<div class="org-src-container">
<pre class="src src-sh">id:5:initdefault:
si::sysinit:/etc/rc.d/rc.sysinit
l0:0:wait:/etc/rc.d/rc 0
l1:1:wait:/etc/rc.d/rc 1
l2:2:wait:/etc/rc.d/rc 2
l3:3:wait:/etc/rc.d/rc 3
l4:4:wait:/etc/rc.d/rc 4
l5:5:wait:/etc/rc.d/rc 5
l6:6:wait:/etc/rc.d/rc 6
ca::ctrlaltdel:/sbin/shutdown -t3 -r now
pf::powerfail:/sbin/shutdown -f -h +2 <span style="color: #8b2252;">"Power Failure; System Shutting Down&#8221;
pr:12345:powerokwait:/sbin/shutdown -c "</span>Power Restored; Shutdown Cancelled&#8221;
1:2345:respawn:/sbin/mingetty tty1
2:2345:respawn:/sbin/mingetty tty2
3:2345:respawn:/sbin/mingetty tty3
4:2345:respawn:/sbin/mingetty tty4
5:2345:respawn:/sbin/mingetty tty5
6:2345:respawn:/sbin/mingetty tty6
x:5:respawn:/etc/X11/prefdm -nodaemon
</pre>
</div>

<p>
CentOS 6 /etc/inittab和相关文件
</p>

<p>
CentOS 6 init程序为 upstart, 其配置文件/etc/inittab, /etc/init/*.conf，
配置文件的语法 遵循upstart配置文件语法格式，和CentOS5不同
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/inittab &#35774;&#32622;&#31995;&#32479;&#40664;&#35748;&#30340;&#36816;&#34892;&#32423;&#21035;
/etc/init/control-alt-delete.conf
/etc/init/tty.conf
/etc/init/start-ttys.conf
/etc/init/rc.conf
/etc/init/prefdm.conf
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c24479f4-cd07-49f4-aac2-c46a4868a46e" class="outline-5">
<h5 id="h:c24479f4-cd07-49f4-aac2-c46a4868a46e">初始化脚本 sysinit</h5>
<div class="outline-text-5" id="text-h:c24479f4-cd07-49f4-aac2-c46a4868a46e">
<div class="org-src-container">
<pre class="src src-sh">/etc/rc.d/rc.sysinit
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#cat /etc/init/rcS.conf  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36890;&#36807;&#36825;&#20010;&#25991;&#20214;&#35843;&#29992; &#33050;&#26412; /etc/rc.d/rc.sysinit</span>
</pre>
</div>

<p>
系统初始化脚本功能
</p>

<div class="org-src-container">
<pre class="src src-sh">(1) &#35774;&#32622;&#20027;&#26426;&#21517;
(2) &#35774;&#32622;&#27426;&#36814;&#20449;&#24687;
(3) &#28608;&#27963;udev&#21644;selinux 
(4) &#25346;&#36733;/etc/fstab&#25991;&#20214;&#20013;&#23450;&#20041;&#30340;&#25991;&#20214;&#31995;&#32479;
(5) &#26816;&#27979;&#26681;&#25991;&#20214;&#31995;&#32479;&#65292;&#24182;&#20197;&#35835;&#20889;&#26041;&#24335;&#37325;&#26032;&#25346;&#36733;&#26681;&#25991;&#20214;&#31995;&#32479;
(6) &#35774;&#32622;&#31995;&#32479;&#26102;&#38047;
(7) &#28608;&#27963;swap&#35774;&#22791;
(8) &#26681;&#25454;/etc/sysctl.conf&#25991;&#20214;&#35774;&#32622;&#20869;&#26680;&#21442;&#25968;
(9) &#28608;&#27963;lvm&#21450;software raid&#35774;&#22791;
(10)&#21152;&#36733;&#39069;&#22806;&#35774;&#22791;&#30340;&#39537;&#21160;&#31243;&#24207;
(11)&#28165;&#29702;&#25805;&#20316;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:329773be-3b6d-4bda-ae51-75bc045717be" class="outline-5">
<h5 id="h:329773be-3b6d-4bda-ae51-75bc045717be">服务管理</h5>
<div class="outline-text-5" id="text-h:329773be-3b6d-4bda-ae51-75bc045717be">
<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#cat /etc/init/rc.conf 
<span style="color: #b22222;"># </span><span style="color: #b22222;">rc - System V runlevel compatibility
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">This task runs the old sysv-rc runlevel scripts. It
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">is usually started by the telinit compatibility wrapper.
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">Do not edit this file directly. If you want to change the behaviour,
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">please create a file rc.override and put your changes there.
</span>
start on runlevel [0123456]

stop on runlevel [!$<span style="color: #a0522d;">RUNLEVEL</span>]

task

<span style="color: #483d8b;">export</span> RUNLEVEL
console output
<span style="color: #a020f0;">exec</span> /etc/rc.d/rc $<span style="color: #a0522d;">RUNLEVEL</span>
</pre>
</div>

<p>
service 命令：手动管理服务
</p>

<div class="org-src-container">
<pre class="src src-sh">service &#26381;&#21153; start|stop|restart
service --status-all
</pre>
</div>

<p>
/etc/rc.d/rc 控制服务脚本的开机自动运行
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a020f0;">for</span> srv<span style="color: #a020f0;"> in</span> /etc/rc.d/rcN.d/K*; <span style="color: #a020f0;">do</span>
    $<span style="color: #a0522d;">srv</span> stop
<span style="color: #a020f0;">done</span>
<span style="color: #a020f0;">for</span> srv<span style="color: #a020f0;"> in</span> /etc/rc.d/rcN.d/S*; <span style="color: #a020f0;">do</span>
    $<span style="color: #a0522d;">srv</span> start
<span style="color: #a020f0;">done</span>
</pre>
</div>

<p>
说明：rc N &#x2013;&gt; 意味着读取/etc/rc.d/rcN.d/
</p>
<ul class="org-ul">
<li>K: K##：##运行次序；按照字母的字符序来排序运行；数字越小的服务，通常为依赖到
别的服务</li>

<li>S: S##：##运行次序；按照字母的字符序来排序运行；数字越小的服务，通常为被依赖
到的服务</li>
</ul>

<p>
配置服务开机启动
</p>

<ul class="org-ul">
<li>chkconfig命令</li>
<li>ntsysv命令 废弃了，图形界面 只能改一种模式</li>
</ul>

<p>
<b>chkconfig 命令管理服务</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26381;&#21153;&#22312;&#25152;&#26377;&#32423;&#21035;&#30340;&#21551;&#21160;&#25110;&#20851;&#38381;&#35774;&#23450;&#24773;&#24418;&#65306;
</span>chkconfig [--list] [name]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#26381;&#21153;
</span><span style="color: #0000ff;">SysV&#30340;&#26381;&#21153;&#33050;&#26412;&#25918;&#32622;&#20110;/etc/rc.d/init.d</span> (/etc/init.d)

<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash
</span>chkconfig: LLLL nn nn  <span style="color: #b22222;">#</span><span style="color: #b22222;">LLLL &#34920;&#31034;&#21021;&#22987;&#22312;&#21738;&#20010;&#32423;&#21035;&#19979;&#21551;&#21160;&#65292;-&#34920;&#31034;&#37117;&#19981;&#21551;&#21160;
</span>description : &#25551;&#36848;&#20449;&#24687;

chkconfig --add name

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#26381;&#21153;
</span>chkconfig --del name

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#25351;&#23450;&#30340;&#36816;&#34892;&#32423;&#21035;
</span>chkconfig [--level levels] name &lt;on|off|reset&gt;
&#35828;&#26126;&#65306;--level LLLL: &#25351;&#23450;&#35201;&#35774;&#32622;&#30340;&#32423;&#21035;&#65307;&#30465;&#30053;&#26102;&#34920;&#31034;2345
chkconfig --level 35 chronyd on
</pre>
</div>

<p>
范例：开机启动脚本
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#vim /etc/init.d/testservice
[root@centos6 ~]#cat /etc/init.d/testservice
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">chkconfig: - 98 3 
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">description : test service scripts
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#37324;&#30340; - &#27178;&#32447;&#21021;&#22987;&#40664;&#35748;&#20840;&#26159;off&#30340;
</span>
. /etc/init.d/functions

<span style="color: #0000ff;">start</span> (){
    touch /var/lock/subsys/testservice
    action <span style="color: #8b2252;">"Starting testservice:"</span>
    sleep 3
}
<span style="color: #0000ff;">stop</span> (){
    rm -f /var/lock/subsys/testservice
    action <span style="color: #8b2252;">"Shutting down testservice:"</span>
}
<span style="color: #0000ff;">restart</span> (){
    stop
    start
}
<span style="color: #0000ff;">status</span> (){
    <span style="color: #a020f0;">if</span> [ -e /var/lock/subsys/testservice ] ;<span style="color: #a020f0;">then</span>
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"testservice is running..."</span>
    <span style="color: #a020f0;">else</span>
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"testservice is stopped"</span>
    <span style="color: #a020f0;">fi</span>
}

<span style="color: #a020f0;">case</span> $<span style="color: #a0522d;">1</span><span style="color: #a020f0;"> in</span>
start)
    start
    ;;
stop)
    stop
    ;;
restart)
    restart
    ;;
status)
    status
    ;;
*)
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"Usage:/etc/init.d/testservice {start|stop|restart|status}"</span>
    ;;
<span style="color: #a020f0;">esac</span>
[root@centos6 ~]#chmod +x /etc/init.d/testservice
[root@centos6 ~]#chkconfig --add testservice
[root@centos6 ~]#chkconfig --list testservice
testservice     0:off   1:off   2:on    3:on    4:on    5:on    6:off
[root@centos6 ~]#chkconfig --del testservice <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#24320;&#26426;&#21551;&#21160;&#65292;&#23454;&#38469;&#21024;&#38500;&#36719;&#36830;&#25509;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:89dbf263-728d-4b4b-b3e6-12e8d75b9c11" class="outline-5">
<h5 id="h:89dbf263-728d-4b4b-b3e6-12e8d75b9c11">非独立服务</h5>
<div class="outline-text-5" id="text-h:89dbf263-728d-4b4b-b3e6-12e8d75b9c11">
<p>
服务分为独立服务和非独立服务
</p>

<p>
瞬态（Transient）服务被超级守护进程 xinetd 进程所管理，也称为非独立服务。服务有访问了就会被守护进程启动。
</p>

<p>
进入的请求首先被xinetd代理
</p>

<p>
配置文件：
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/xinetd.conf
/etc/xinetd.d/&lt;service&gt;
</pre>
</div>

<p>
用chkconfig控制非独立服务开机启动
示例：chkconfig tftp on
</p>

<p>
范例：非独立服务telnet-server
</p>
<div class="org-src-container">
<pre class="src src-sh">yum install telnet-server -y  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#21160;&#25226;&#23432;&#20449;&#26381;&#21153;xinetd&#23433;&#35013;
</span>chkconfig --list

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28608;&#27963;telnet-server
</span>chkconfig telent-server on
service xinetd start  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30417;&#25511;&#32593;&#32476;&#20013;&#30340;&#35831;&#27714;&#65292;&#26377;&#35775;&#38382;telnet-server 23&#31471;&#21475;&#26102;&#65292;&#28608;&#27963;telnet-server&#26381;&#21153;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;, &#30331;&#24405;ssh
</span>~]# telnet 10.0.0.6
centos6 login: root
Password:

</pre>
</div>
</div>
</div>
<div id="outline-container-h:eb3705a5-0b35-4b40-9393-53fdd3cffaa9" class="outline-5">
<h5 id="h:eb3705a5-0b35-4b40-9393-53fdd3cffaa9">开机启动文件 rc.local</h5>
<div class="outline-text-5" id="text-h:eb3705a5-0b35-4b40-9393-53fdd3cffaa9">
<div class="org-src-container">
<pre class="src src-sh">/etc/rc.d/rc.local
</pre>
</div>

<p>
注意：
</p>

<ul class="org-ul">
<li>正常级别下，最后启动一个服务S99local没有链接至/etc/rc.d/init.d一个服
务脚本，而是指向了/etc/rc.d/rc.local脚本</li>
<li>不便或不需写服务脚本放置于/etc/rc.d/init.d/目录，且又想开机时自动运
行的命令，可直接放置于/etc/rc.d/rc.local文件中</li>
<li>/etc/rc.d/rc.local在指定运行级别脚本后运行</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:68d3f8f3-bb2c-493c-a893-75b491828d0e" class="outline-4">
<h4 id="h:68d3f8f3-bb2c-493c-a893-75b491828d0e">CentOS6 启动过程总结</h4>
<div class="outline-text-4" id="text-h:68d3f8f3-bb2c-493c-a893-75b491828d0e">
<pre class="example" id="org3fcd998">
POST
boot loader
vmlinux(initramfs.img)
roofs
/sbin/init
/etc/inittab 设置默认运行级别
/etc/rc.d/rc.sysinit   运行系统初始脚本完成系统初始化
/etc/rc#.d/Sxxxx  启动需要启动服务关闭对应不需要启动服务
/etc/rc.d/rc.local
设置登录终端
</pre>

<p>
小结：启动过程
</p>
<ol class="org-ol">
<li>POST加电自检</li>
<li>GRUB1阶段MBR446</li>
<li>GRUB1.5阶段MBR之后空间(提供grub2文件所有分区的文件系统)</li>
<li>GRUB2阶段(grub.conf)</li>
<li>kernel (initramfs.img)借助grub.conf找到操作系统内核, 根分区的文件系统由initramfs.img提供</li>
<li>/ 进入操作系统的根</li>
<li>/sbin/init 加载系统中第一个进程，初始化</li>
<li><i>etc/inittab 进入系统模式, 每个模式启动的服务是不一样的。每个模式都一个文件夹 /etc/rc*.d</i>, 如 <i>etc/rc0.d</i>, <i>etc/rc1.d</i>,&#x2026;, <i>etc/rc6.d</i>, <i>etc/rc.d</i>.   文件夹里都是软连接指向服务启动停止脚本 /etc/init.d/*</li>
<li>/etc/rc.d/rc.sysinit 系统初始化脚本</li>
<li>/etc/rc.d/rc  脚本内容，遍历/etc/rc&lt;N&gt;.d/文件夹下运行模式， /etc/rcN.d/K*所有K*开头文件运行脚本并加stop参数；/etc/rcN.d/S*所有S*开头文件运行脚本并加start参数；</li>
<li><i>etc/rcN.d</i> 调用文件夹下软连接脚本</li>
<li>/etc/rc.local</li>
<li>login登录</li>
</ol>

<p>
参看：
</p>


<figure id="org5f89818">
<img src="./images/Screenshot.jpg" alt="Screenshot.jpg" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:bc7e0987-9d2c-4c05-a5a2-6754a03a6938" class="outline-4">
<h4 id="h:bc7e0987-9d2c-4c05-a5a2-6754a03a6938">启动过程的故障排错</h4>
<div class="outline-text-4" id="text-h:bc7e0987-9d2c-4c05-a5a2-6754a03a6938">
<p>
<b>实战案例 故障: 删除 /sbin/init 无法启动 恢复过程</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">1 &#20808;&#36827;&#20837;grub&#33756;&#21333;&#65292;&#22312;kernel&#21442;&#25968;&#21518;&#21152; <span style="color: #a0522d;">selinux</span>=0 <span style="color: #a0522d;">init</span>=/bin/bash 

2 mount -o remount,rw /

3 mount /dev/sr0 /mnt/

4 rpm2cpio /mnt/Packages/upstart.xxx.rpm | cpio -idv ./sbin/init 

5 mv ./sbin/init /sbin/
</pre>
</div>

<p>
<b>实战案例</b>
</p>

<p>
故障：rm -rf /boot/* 和 /etc/fstab 进行恢复
</p>

<p>
恢复过程
</p>

<ol class="org-ol">
<li>用光盘进入 rescue mode，找到/ 所在分区并恢复/etc/fstab</li>
</ol>


<figure id="org6552576">
<img src="./images/image-20210120112802465.png" alt="image-20210120112802465.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">fdisk -l 
mkdir /mnt/rootdir
mount /dev/sdaN /mnt/rootdir  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#26597;&#26159;&#19981;&#26159;&#26681;&#30446;&#24405;
</span>ls /mnt/rootdir
mount /dev/sda2 /mnt/rootdir

vim /mnt/rootdir/etc/fstab 
/dev/sda1 /boot ext4 defaults 0 0 
/dev/sda2 /   ext4 defaults 0 0
/dev/sda3 /data ext4 defaults 0 0
/dev/sda5 swap swap defaults 0 0

reboot
</pre>
</div>

<ol class="org-ol">
<li><p>
rescue mode 恢复内核和initrd 文件
</p>

<p>
/dev/sda2 &#x2013;&gt; /mnt/sysimage
</p></li>
</ol>

<div class="org-src-container">
<pre class="src src-sh">chroot /mnt/sysimage
mount /dev/sr0 /mnt/
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1 
</span>rpm -ivh /mnt/Packages/kernel.xxxx.rpm --root=/mnt/sysimage --force  
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2 
</span>cp /mnt/isolinux/vmlinuz /boot/
mkinitrd /boot/initramfs.img <span style="color: #ff00ff;">`uname -r`</span>
</pre>
</div>

<ol class="org-ol">
<li>修复 grub</li>
</ol>

<div class="org-src-container">
<pre class="src src-sh">grub-install /dev/sda 
vim /boot/grub/grub.conf &#26041;&#27861;2
[root@centos6 ~]#cat /boot/grub/grub.conf 
<span style="color: #a0522d;">default</span>=0
<span style="color: #a0522d;">timeout</span>=5
title centos
kernel /vmlinuz <span style="color: #a0522d;">root</span>=/dev/sda2
initrd /initramfs.img
</pre>
</div>

<ol class="org-ol">
<li>reboot</li>
</ol>
</div>
</div>
</div>
</section>
<section id="outline-container-h:49913cb0-0a1e-42a0-9aec-aad809382950" class="outline-2">
<h2 id="h:49913cb0-0a1e-42a0-9aec-aad809382950">CentOS7</h2>
<div class="outline-text-2" id="text-h:49913cb0-0a1e-42a0-9aec-aad809382950">
</div>
<div id="outline-container-h:cf968388-2306-4340-a133-e0987ef64338" class="outline-3">
<h3 id="h:cf968388-2306-4340-a133-e0987ef64338">CentOS 7之后版本引导顺序</h3>
<div class="outline-text-3" id="text-h:cf968388-2306-4340-a133-e0987ef64338">
<ol class="org-ol">
<li>UEFi或BIOS初始化，运行POST开机自检</li>
<li>选择启动设备</li>
<li><p>
引导装载程序, centos7是grub2,加载装载程序的配置文件： <i>etc/grub.d</i>
</p>

<p>
/etc/default/grub /boot/grub2/grub.cfg
</p></li>

<li>加载initramfs驱动模块(可以实现根文件系统的挂载)</li>
<li>加载内核选项</li>
<li>内核初始化，centos7使用systemd代替init</li>
<li>执行initrd.target所有单元，包括挂载/etc/fstab</li>
<li>从initramfs根文件系统切换到磁盘根目录</li>
<li><p>
systemd执行默认target配置，配置文件
</p>

<p>
/etc/systemd/system/default.target
</p></li>

<li>systemd执行sysinit.target初始化系统及basic.target准备操作系统</li>
<li>systemd启动multi-user.target下的本机与服务器服务</li>
<li>systemd执行multi-user.target下的/etc/rc.d/rc.local</li>
<li>Systemd执行multi-user.target下的getty.target及登录服务</li>
<li>systemd执行graphical需要的服务</li>
</ol>

<p>
查看运行模式3依赖关系
</p>
<div class="org-src-container">
<pre class="src src-sh">systemctl list-dependencies multi-user.target
</pre>
</div>

<p>
通过systemd-analyze 工具可以了解启动的详细过程
</p>

<div class="org-src-container">
<pre class="src src-sh">systemd-analyze time <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#26102;&#38388; 
</span>systemd-analyze blame <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35814;&#32454;&#21551;&#21160;&#20869;&#23481;
</span>systemd-analyze plot &gt;bootime.svg <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#22270;&#29255;
</span>systemd-analyze plot &gt; boot.html <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#32593;&#39029;</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8-A ~]#systemd-analyze blame
         46.797s dnf-makecache.service
          5.789s kdump.service
          5.370s tuned.service
          5.110s postfix.service
          3.551s systemd-udev-settle.service
          2.837s sssd.service
          2.753s vdo.service
          2.240s NetworkManager-wait-online.service
          1.982s systemd-machined.service
          1.958s plymouth-quit.service
          1.913s plymouth-quit-wait.service
          1.755s lvm2-monitor.service
          1.501s polkit.service
          1.481s systemd-resolved.service
          1.391s dracut-initqueue.service
          1.288s systemd-logind.service
          1.183s ModemManager.service
          1.120s libvirtd.service
          1.025s cockpit-motd.service
          1.004s rsyslog.service
           985ms avahi-daemon.service
           737ms initrd-switch-root.service
           675ms bluetooth.service
           652ms systemd-journald.service
           629ms NetworkManager.service
           531ms gssproxy.service
           528ms cups.service
           ......
            58ms rpcbind.service
            56ms systemd-fsck-root.service
            55ms rpc-statd-notify.service
            49ms date.mount
            48ms systemd-rfkill.service
            45ms cockpit.socket
            43ms import-state.service
            38ms dracut-pre-udev.service
            31ms plymouth-switch-root.service
            30ms systemd-tmpfiles-setup.service
            29ms sys-kernel-config.mount
            26ms systemd-journal-flush.service
            26ms systemd-tmpfiles-clean.service
            25ms systemd-update-utmp-runlevel.service
            24ms initrd-udevadm-cleanup-db.service
            22ms initrd-cleanup.service
            18ms plymouth-read-write.service
            10ms systemd-update-utmp.service
             8ms sysstat-collect.service
             7ms dracut-shutdown.service
</pre>
</div>

<p>
范例：生成网页
</p>

<div class="org-src-container">
<pre class="src src-sh">systemd-analyze plot &gt; boot.html
</pre>
</div>


<figure id="org2340229">
<img src="./images/image-20210120141206840.png" alt="image-20210120141206840.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:f8905e48-bb3a-42bc-a312-d2ee1162f23e" class="outline-3">
<h3 id="h:f8905e48-bb3a-42bc-a312-d2ee1162f23e">破解 CentOS 7和8的 root 密码</h3>
<div class="outline-text-3" id="text-h:f8905e48-bb3a-42bc-a312-d2ee1162f23e">
<p>
方法一
</p>

<div class="org-src-container">
<pre class="src src-sh">&#21551;&#21160;&#26102;&#20219;&#24847;&#38190;&#26242;&#20572;&#21551;&#21160;
&#25353;e&#38190;&#36827;&#20837;&#32534;&#36753;&#27169;&#24335;
&#23558;&#20809;&#26631;&#31227;&#21160;linux &#24320;&#22987;&#30340;&#34892;&#65292;&#28155;&#21152;&#20869;&#26680;&#21442;&#25968;rd.break &#25171;&#30772;&#27491;&#24120;&#21551;&#21160;
&#25353;ctrl-x&#21551;&#21160;
mount &#8211;o remount,rw /sysroot
chroot /sysroot
passwd root

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;SELinux&#26159;&#21551;&#29992;&#30340;,&#25165;&#38656;&#35201;&#25191;&#34892;&#19979;&#38754;&#25805;&#20316;,&#22914;&#26597;&#27809;&#26377;&#21551;&#21160;,&#19981;&#38656;&#35201;&#25191;&#34892;
</span>touch /.autorelabel

<span style="color: #a020f0;">exit</span>
reboot
</pre>
</div>

<p>
方法二
</p>

<div class="org-src-container">
<pre class="src src-sh">&#21551;&#21160;&#26102;&#20219;&#24847;&#38190;&#26242;&#20572;&#21551;&#21160;
&#25353;e&#38190;&#36827;&#20837;&#32534;&#36753;&#27169;&#24335;
&#23558;&#20809;&#26631;&#31227;&#21160;linux &#24320;&#22987;&#30340;&#34892;&#65292;&#25913;&#20026;rw <span style="color: #a0522d;">init</span>=/sysroot/bin/sh
&#25353;ctrl-x&#21551;&#21160;
chroot /sysroot
passwd root

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;SELinux&#26159;&#21551;&#29992;&#30340;,&#25165;&#38656;&#35201;&#25191;&#34892;&#19979;&#38754;&#25805;&#20316;,&#22914;&#26597;&#27809;&#26377;&#21551;&#21160;,&#19981;&#38656;&#35201;&#25191;&#34892;
</span>touch /.autorelabel

<span style="color: #a020f0;">exit</span>
reboot
</pre>
</div>
</div>
</div>
<div id="outline-container-h:920aa398-c45d-46a3-a9c1-9ea439dd507f" class="outline-3">
<h3 id="h:920aa398-c45d-46a3-a9c1-9ea439dd507f">实现GRUB2安全</h3>
<div class="outline-text-3" id="text-h:920aa398-c45d-46a3-a9c1-9ea439dd507f">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;grub&#23494;&#30721;&#65292;&#20250;&#22312;/boot/grub2/&#19979;&#29983;&#25104;user.cfg&#25991;&#20214;
</span>[root@centos8 ~]#grub2-setpassword
Enter password: 
Confirm password: 

[root@centos8 ~]#ls -l /boot/grub2/
total 32
drwxr-xr-x 2 root root  4096 Jan 19 15:17 fonts
-rw-r--r-- 1 root root  5101 Jan 19 15:18 grub.cfg
-rw-r--r-- 1 root root  1024 Jan 19 15:18 grubenv
drwxr-xr-x 2 root root 12288 Jan 19 15:17 i386-pc
-rw------- 1 root root   298 Jan 19 18:20 user.cfg
[root@centos8 ~]#ls -l /boot/grub2/user.cfg 
-rw------- 1 root root 298 Jan 19 18:20 /boot/grub2/user.cfg
[root@centos8 ~]#cat /boot/grub2/user.cfg
<span style="color: #a0522d;">GRUB2_PASSWORD</span>=grub.pbkdf2.sha512.10000.60AAA29A65F4DC77E8861EF25BDE2034C9B30CE1
E07EE688D7F30460E7E87E7356B0893A6DFFB250B27D2EB9D3ED3E9207199C494D7882E2E8C772C8
2E2DDB7A.5E42FD69FA04293DECD68F077E83875A8E4572A7FBB89BA9F161B15EAFE54FBA963FE5D
52E16764944823396231803E5118DA1D9CAF3EB73C175A7D7A3682A90

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#31354;grub&#23494;&#30721;
</span>[root@centos8 ~]#cat /dev/null &gt; /boot/grub2/user.cfg
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a6970b05-11b5-46fb-a408-4bc10305ed9a" class="outline-3">
<h3 id="h:a6970b05-11b5-46fb-a408-4bc10305ed9a">修复GRUB2</h3>
<div class="outline-text-3" id="text-h:a6970b05-11b5-46fb-a408-4bc10305ed9a">
<p>
GRUB2：CentOS
7，8及ubuntu1804都使用引导提示时可以使用命令行界面，可从文件系统引导
</p>

<p>
主要配置文件：/boot/grub2/grub.cfg
</p>

<p>
修复配置文件：grub2-mkconfig &gt; /boot/grub2/grub.cfg
</p>

<p>
修复grub
</p>

<div class="org-src-container">
<pre class="src src-sh">grub2-install /dev/sda <span style="color: #b22222;">#</span><span style="color: #b22222;">BIOS&#29615;&#22659;
</span>grub2-install <span style="color: #b22222;">#</span><span style="color: #b22222;">UEFI&#29615;&#22659;</span>
</pre>
</div>

<p>
范例：调整默认启动内核
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8-A ~]#cat /boot/grub2/grubenv 
<span style="color: #b22222;"># </span><span style="color: #b22222;">GRUB Environment Block
</span><span style="color: #a0522d;">saved_entry</span>=b74f53e89700498b96f22ddee0f70ced-4.18.0-147.el8.x86_64  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#25163;&#21160;&#20462;&#25913;&#20026;&#24819;&#21551;&#21160;&#30340;&#20869;&#26680;&#20869;&#23481;&#65292;&#36866;&#21512;centos8
</span><span style="color: #a0522d;">kernelopts</span>=<span style="color: #a0522d;">root</span>=<span style="color: #a0522d;">UUID</span>=6498b37b-cbbf-4771-8327-b65704274aef ro <span style="color: #a0522d;">crashkernel</span>=auto <span style="color: #a0522d;">resume</span>=<span style="color: #a0522d;">UUID</span>=8424a27b-4f74-4249-b229-0ba992a5c4e7 rhgb quiet net.ifnames=0 
<span style="color: #a0522d;">boot_success</span>=0
<span style="color: #a0522d;">boot_indeterminate</span>=0
<span style="color: #b22222;">#############################################################</span><span style="color: #b22222;">
</span>
[root@centos8-A ~]#ls /boot/loader/entries/
b74f53e89700498b96f22ddee0f70ced-0-rescue.conf  
b74f53e89700498b96f22ddee0f70ced-4.18.0-147.el8.x86_64.conf

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#19979;&#21629;&#20196;&#26159;&#20462;&#25913; /boot/grub2/grubenv &#23454;&#29616; &#36866;&#21512;centos7
</span>[root@centos8 ~]#grub2-set-default 1  
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;
</span>[root@centos8 ~]#vim /etc/default/grub 
<span style="color: #a0522d;">GRUB_DEFAULT</span>=1
</pre>
</div>


<figure id="org755a95b">
<img src="./images/image-20210227191424514.png" alt="image-20210227191424514.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:eb90ecd0-adf0-4fda-9787-375d8ccc54e2" class="outline-3">
<h3 id="h:eb90ecd0-adf0-4fda-9787-375d8ccc54e2">故障排错实战案例</h3>
<div class="outline-text-3" id="text-h:eb90ecd0-adf0-4fda-9787-375d8ccc54e2">
</div>
<div id="outline-container-h:4b318177-22c5-4bab-94a2-76eb5afd7e46" class="outline-4">
<h4 id="h:4b318177-22c5-4bab-94a2-76eb5afd7e46">实战案例1：centos 7 ，8 破坏MBR后进行恢复</h4>
<div class="outline-text-4" id="text-h:4b318177-22c5-4bab-94a2-76eb5afd7e46">
<div class="org-src-container">
<pre class="src src-sh">dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=/dev/sda <span style="color: #a0522d;">bs</span>=1 <span style="color: #a0522d;">count</span>=446
&#20809;&#30424;&#36827;&#20837;&#25937;&#25588;&#27169;&#24335;
grub2-install --root-directory=/mnt/sysimage /dev/sda
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8437d6fe-03cf-4818-9a49-8a810e8fc515" class="outline-4">
<h4 id="h:8437d6fe-03cf-4818-9a49-8a810e8fc515">实战案例2：Centos 7 ，8删除/boot/grub2/*所有内容进行恢复</h4>
<div class="outline-text-4" id="text-h:8437d6fe-03cf-4818-9a49-8a810e8fc515">

<figure id="orgc4481b0">
<img src="./images/image-20210120141254875.png" alt="image-20210120141254875.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-sh">&#20809;&#30424;&#36827;&#20837;&#25937;&#25588;&#27169;&#24335;
chroot /mnt/sysimage
grub2-install /dev/sda
grub2-mkconfig -o /boot/grub2/grub.cfg
</pre>
</div>
</div>
</div>
<div id="outline-container-h:70071c20-fa3c-4f8d-b9ea-439de69806dc" class="outline-4">
<h4 id="h:70071c20-fa3c-4f8d-b9ea-439de69806dc">实战案例3：CentOS 7 ，8 删除/boot/下所有文件后进行恢复</h4>
<div class="outline-text-4" id="text-h:70071c20-fa3c-4f8d-b9ea-439de69806dc">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1 &#20809;&#30424;&#25937;&#25588;&#27169;&#24335;&#19979;&#23433;&#35013;grub2
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29305;&#21035;&#35828;&#26126;&#65306;Centos8 &#24517;&#39035;&#20808;grub&#65292;&#20877;&#23433;&#35013;kernel,&#21542;&#21017;&#23433;&#35013;kernel-core&#26102;&#20250;&#25552;&#31034;grub&#20986;&#38169;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">centos8 &#20999;&#26681;
</span>chroot /mnt/sysroot
<span style="color: #b22222;">#</span><span style="color: #b22222;">centos7 &#20999;&#26681;
</span>chroot /mnt/sysimage

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;grub
</span>grub2-install /dev/sda  <span style="color: #b22222;">#</span><span style="color: #b22222;">BIOS&#29615;&#22659;
</span>grub2-install  <span style="color: #b22222;">#</span><span style="color: #b22222;">UEFI&#29615;&#22659;
</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">2 &#23433;&#35013;Kernel
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">CentOS 7
</span>mount /dev/sr0 /mnt
rpm &#8211;ivh /mnt/Packages/kernel-3.10.0-1062.el7.x86_64.rpm --force

<span style="color: #b22222;">#</span><span style="color: #b22222;">CentOS 8 
</span>mount /dev/sr0 /mnt
rpm -ivh /mnt/BaseOS/Packages/kernel-core-4.18.0-147.el8.x86_64.rpm --force

<span style="color: #b22222;">#</span><span style="color: #b22222;">3 &#20462;&#22797;grub&#37197;&#32622;&#25991;&#20214;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;grub2.cfg&#25991;&#20214;
</span>grub2-mkconfig &#8211;o /boot/grub2/grub.cfg

<span style="color: #b22222;">#</span><span style="color: #b22222;">4 &#36864;&#20986;&#37325;&#21551;
</span>sync
sync
<span style="color: #a020f0;">exit</span>
<span style="color: #a020f0;">exit</span>
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:de26e8c1-e341-4303-b061-58b9a47e9dbc" class="outline-2">
<h2 id="h:de26e8c1-e341-4303-b061-58b9a47e9dbc">systemd</h2>
<div class="outline-text-2" id="text-h:de26e8c1-e341-4303-b061-58b9a47e9dbc">
<p>
官方文档：<a href="https://systemd.io/">https://systemd.io/</a>
</p>
<ul class="org-ul">
<li><a href="https://www.freedesktop.org/software/systemd/man/">索引</a></li>
<li>The systemd for Administrators Blog Series</li>
</ul>

<p>
init的发展
</p>

<ul class="org-ul">
<li>CentOS 5: SysV init,串行启动</li>
<li>CentOS 6：Upstart,并行启动，借鉴ubantu</li>
<li>CentOS 7：Systemd,并行启动，借鉴MAC。即使有依赖关系也能同时启动，访问时才会确认依赖关系状态。</li>
</ul>

<p>
范例：centos7 开始init已经换成systemd, 因此操作系统启动的第一个进程变成了systemd
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@test jasper]# ll <span style="color: #ff00ff;">`which init`</span>
lrwxrwxrwx. 1 root root 22 Jun 17 21:21 /usr/sbin/init -&gt; ../lib/systemd/systemd
[root@test jasper]# rpm -qf <span style="color: #ff00ff;">`which init`</span>
systemd-xxxx
</pre>
</div>
</div>
<div id="outline-container-systemd-特性" class="outline-3">
<h3 id="systemd-特性">systemd 特性</h3>
<div class="outline-text-3" id="text-systemd-特性">
<p>
Systemd：从 CentOS 7 版本之后开始用 systemd实现init进程，系统启动和服
务器守护进程管理器，负责在系统启动或运行时，激活系统资源，服务器进程和
其它进程
</p>

<p>
Systemd新特性
</p>

<ul class="org-ul">
<li>系统引导时实现服务并行启动</li>
<li>按需启动守护进程</li>
<li>自动化的服务依赖关系管理</li>
<li>同时采用socket式与D-Bus总线式激活服务</li>
<li>socket与服务程序分离</li>
<li>向后兼容sysv init脚本</li>
<li>使用systemctl命令管理，systemctl命令固定不变，不可扩展，非由systemd
启动的服务，systemctl无法与之通信和控制</li>
<li>系统状态快照</li>
</ul>

<p>
systemd核心概念：unit
</p>

<p>
unit表示不同类型的systemd对象，通过配置文件进行标识和配置；文件中主要
包含了系统服务、监听socket、保存的系统快照以及其它与init相关的信息
</p>

<p>
Unit类型：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;unit&#25903;&#25345;&#30340;&#36164;&#28304;&#31867;&#22411;
</span>[root@centos8-A ~]#systemctl -t help
Available unit types:
service                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;
</span>socket                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22871;&#25509;&#23383;
</span>target                   <span style="color: #b22222;">#</span><span style="color: #b22222;">runlevel&#36816;&#34892;&#27169;&#24335;
</span>device                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#22791;
</span>mount                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25346;&#36733;
</span>automount
swap                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20132;&#25442;&#20998;&#21306;
</span>timer                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35745;&#25968;&#22120;
</span>path
slice
scope
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#26641;&#29366;&#32467;&#26500;&#23637;&#31034;&#31995;&#32479;&#30340;&#25511;&#21046;&#32452;&#65288;cgroup&#65289;&#23618;&#32423;&#20851;&#31995;
</span>systemd-cgls
systemd-cgls -u docke
</pre>
</div>

<ul class="org-ul">
<li>service unit: 文件扩展名为.service,用于定义系统服务，相当于开启服务脚本</li>
<li>Socket unit: .socket,定义进程间通信用的socket文件，也可在系统启动时，延迟启动服务，实现按需启动，代替了xinetd</li>
<li>Target unit: 文件扩展名为.target，用于模拟实现运行级别，相当于runlevel</li>
<li>Device unit: .device, 用于定义内核识别的设备</li>
<li>Mount unit: .mount, 定义文件系统挂载点</li>
<li>Snapshot unit: .snapshot, 管理系统快照</li>
<li>Swap unit: .swap, 用于标识swap设备</li>
<li>Automount unit: .automount，文件系统的自动挂载点</li>
<li>Path unit: .path，用于定义文件系统中的一个文件或目录使用,常用于当文件系统变化时，延迟激活服务，如：spool目录</li>
</ul>

<p>
范例：systemd实现了socket与服务程序分离
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">socket ip &#31471;&#21475;
</span>[root@ali-bj-prod-web001 ~]# yum install telnet-server
[root@ali-bj-prod-web001 ~]# systemctl start  telnet.socket
[root@ali-bj-prod-web001 ~]# systemctl status telnet.socket
&#9679; telnet.socket - Telnet Server Activation Socket
   Loaded: loaded (/usr/lib/systemd/system/telnet.socket; disabled; vendor preset: disabled)
   Active: active (listening) since Sat 2021-02-27 07:25:12 CST; 2s ago

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#26597; telnet&#26381;&#21153;&#24182;&#27809;&#26377;&#21551;&#21160;&#65292;&#32780;systemd&#21551;&#21160;&#19968;&#20010;23&#31471;&#21475;
</span>[root@ali-bj-prod-web001 ~]# ps -ef|grep telnet 
root        1655    1339  0 07:25 pts/0    00:00:00 grep --color=auto telnet
[root@ali-bj-prod-web001 ~]# ss -tnlp   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#21040;23&#31471;&#21475;&#30001;systemd&#30417;&#25511;
</span>State         Recv-Q        Send-Q               Local Address:Port               Peer Address:Port    
LISTEN        0             128                              *:23                            *:*            users:((<span style="color: #8b2252;">"systemd"</span>,<span style="color: #a0522d;">pid</span>=1,<span style="color: #a0522d;">fd</span>=24))                  
[root@ali-bj-prod-web001 ~]# lsof -i :23
COMMAND PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
systemd   1 root   24u  IPv6  29270      0t0  TCP *:telnet (LISTEN)

<span style="color: #b22222;"># </span><span style="color: #b22222;">windows&#36828;&#31243; 23&#31471;&#21475; 
</span>[c:<span style="color: #8b2252;">\~</span>]$ telnet 182.92.4.110 23
Connecting to 182.92.4.110:23.
Connection established.
To escape to local shell, press Ctrl+Alt+].

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20877;&#26816;&#26597;&#65292;telnet&#26381;&#21153;&#21551;&#21160;
</span>[root@ali-bj-prod-web001 ~]# lsof -i :23
COMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
systemd      1 root   19u  IPv6  29811      0t0  TCP ali-bj-prod-web001:telnet-&gt;120.244.188.76:30963 (ESTABLISHED)
systemd      1 root   24u  IPv6  29270      0t0  TCP *:telnet (LISTEN)
in.telnet 1666 root    0u  IPv6  29811      0t0  TCP ali-bj-prod-web001:telnet-&gt;120.244.188.76:30963 (ESTABLISHED)
in.telnet 1666 root    1u  IPv6  29811      0t0  TCP ali-bj-prod-web001:telnet-&gt;120.244.188.76:30963 (ESTABLISHED)
in.telnet 1666 root    2u  IPv6  29811      0t0  TCP ali-bj-prod-web001:telnet-&gt;120.244.188.76:30963 (ESTABLISHED)
[root@ali-bj-prod-web001 ~]# ps -ef|grep telnet 
root        1666       1  0 07:26 ?        00:00:00 in.telnetd: ::ffff:120.244.188.76

<span style="color: #b22222;"># </span><span style="color: #b22222;">socket&#19982;&#26381;&#21153;&#31243;&#24207;&#20998;&#31163;
</span>[root@ali-bj-prod-web001 ~]# yum install rpcbind -y
[root@ali-bj-prod-web001 ~]# rpm -ql rpcbind
/usr/lib/systemd/system/rpcbind.service
/usr/lib/systemd/system/rpcbind.socket
[root@ali-bj-prod-web001 ~]# systemctl start   rpcbind.socket
[root@ali-bj-prod-web001 ~]# ps -ef|grep rpcbind
root        1905    1339  0 07:31 pts/0    00:00:00 grep --color=auto rpcbind
[root@ali-bj-prod-web001 ~]# ss -tnlp   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#21040;111&#31471;&#21475;&#30001;systemd&#30417;&#25511;
</span>LISTEN        0             128                        0.0.0.0:111                     0.0.0.0:*            users:((<span style="color: #8b2252;">"systemd"</span>,<span style="color: #a0522d;">pid</span>=1,<span style="color: #a0522d;">fd</span>=108))   

[root@ali-bj-prod-web001 ~]# lsof -i :111
COMMAND PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
systemd   1 root  108u  IPv4  30718      0t0  TCP *:sunrpc (LISTEN)
systemd   1 root  109u  IPv4  30719      0t0  UDP *:sunrpc 
systemd   1 root  110u  IPv6  30720      0t0  TCP *:sunrpc (LISTEN)
systemd   1 root  111u  IPv6  31745      0t0  UDP *:sunrpc 


<span style="color: #b22222;"># </span><span style="color: #b22222;">windows&#36828;&#31243; 23&#31471;&#21475; 
</span>[c:<span style="color: #8b2252;">\~</span>]$ telnet 182.92.4.110 111
Connecting to 182.92.4.110:111.
Connection established.
To escape to local shell, press Ctrl+Alt+].

[root@ali-bj-prod-web001 ~]# ps -ef|grep rpcbind
rpc         1961       1  3 07:33 ?        00:00:00 /usr/bin/rpcbind -w -f
root        1976    1339  0 07:33 pts/0    00:00:00 grep --color=auto rpcbind

[root@ali-bj-prod-web001 ~]# systemctl status  rpcbind
&#9679; rpcbind.service - RPC Bind
   Loaded: loaded (/usr/lib/systemd/system/rpcbind.service; enabled; vendor preset: enabled)
   Active: active (running) since Sat 2021-02-27 07:33:04 CST; 5s ago
     Docs: man:rpcbind(8)
 Main PID: 1961 (rpcbind)
    Tasks: 1 (<span style="color: #483d8b;">limit</span>: 4652)
   Memory: 996.0K
   CGroup: /system.slice/rpcbind.service
           &#9492;&#9472;1961 /usr/bin/rpcbind -w -f

Feb 27 07:33:03 ali-bj-prod-web001 systemd[1]: Starting RPC Bind...
Feb 27 07:33:04 ali-bj-prod-web001 systemd[1]: Started RPC Bind.
</pre>
</div>

<p>
<b>unit的配置文件</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">/usr/lib/systemd/system         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#20010;&#26381;&#21153;&#26368;&#20027;&#35201;&#30340;&#21551;&#21160;&#33050;&#26412;&#35774;&#32622;&#65292;&#31867;&#20284;&#20110;&#20043;&#21069;&#30340;/etc/init.d/
</span>/lib/systemd/system                <span style="color: #b22222;">#</span><span style="color: #b22222;">ubutun&#30340;&#23545;&#24212;&#30446;&#24405;&#65292;&#20860;&#23481;&#20110;CentOS7,8&#21644;Ubuntu
</span>
/run/systemd/system              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31995;&#32479;&#25191;&#34892;&#36807;&#31243;&#20013;&#25152;&#20135;&#29983;&#30340;&#26381;&#21153;&#33050;&#26412;&#65292;&#27604;&#19978;&#38754;&#30446;&#24405;&#20248;&#20808;&#36816;&#34892;
</span>/etc/systemd/system               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31649;&#29702;&#21592;&#24314;&#31435;&#30340;&#25191;&#34892;&#33050;&#26412;&#65292;&#31867;&#20284;&#20110;/etc/rcN.d/Sxx&#30340;&#21151;&#33021;&#65292;&#27604;&#19978;&#38754;&#30446;&#24405;&#20248;&#20808;&#36816;&#34892;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c2706445-f151-4bdb-aff6-8ba2673635cc" class="outline-3">
<h3 id="h:c2706445-f151-4bdb-aff6-8ba2673635cc">systemctl管理系统服务service unit</h3>
<div class="outline-text-3" id="text-h:c2706445-f151-4bdb-aff6-8ba2673635cc">
<p>
命令
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl COMMAND name.service
</pre>
</div>

<p>
<b>服务状态</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#29366;&#24577;
</span>systemctl list-unit-files --type service --all
</pre>
</div>

<ul class="org-ul">
<li>loaded Unit配置文件已处理</li>
<li>active(running) 一次或多次持续处理的运行</li>
<li>active(exited) 成功完成一次性的配置</li>
<li>active(waiting) 运行中，等待一个事件</li>
<li>inactive 不运行</li>
<li>enabled 开机启动</li>
<li>disabled 开机不启动</li>
<li>static 开机不启动，但可被另一个启用的服务激活</li>
<li>indirect 重定向到别处</li>
</ul>

<p>
查看
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;&#24320;&#26426;&#21551;&#21160;&#30340;&#26381;&#21153;
</span>systemctl list-unit-files --type=service --state=enabled
systemctl list-unit-files --type=service | grep enabled

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26381;&#21153;&#21333;&#20803;&#30340;&#21551;&#29992;&#21644;&#31105;&#29992;&#29366;&#24577;&#65292;&#21450;&#24320;&#26426;&#33258;&#21551;&#29366;&#24577;&#65292;&#30456;&#24403;&#20110;chkconfig --list
</span>systemctl list-unit-files --type service

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#29366;&#24577;&#65306;&#30456;&#24403;&#20110;service name status
</span>systemctl status name.service
systemctl -l status sshd.service  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;sshd&#26381;&#21153;&#21333;&#20803;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;service&#25991;&#20214;&#20869;&#23481;
</span>systemctl cat name.service

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26576;&#26381;&#21153;&#24403;&#21069;&#28608;&#27963;&#19982;&#21542;&#30340;&#29366;&#24577;&#65306;
</span>systemctl is-active name.service    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27809;&#26377;&#21551;&#21160;&#65292;&#36820;&#22238;&#29366;&#24577;&#30721;&#20026;&#38750;0&#12290;&#21551;&#21160;&#36820;&#22238;&#29366;&#24577;&#30721;&#20026;0
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25152;&#26377;&#24050;&#32463;&#28608;&#27963;&#30340;&#26381;&#21153;&#65306;
</span>systemctl --type=service
systemctl list-units --type service
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25152;&#26377;&#26381;&#21153;&#65306;
</span>systemctl &#25110; systemctl list-units
systemctl list-units --type service --all

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26159;&#21542;&#24320;&#26426;&#21551;&#21160;
</span>systemctl is-enabled name.service


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#26469;&#21015;&#20986;&#35813;&#26381;&#21153;&#22312;&#21738;&#20123;&#36816;&#34892;&#32423;&#21035;&#19979;&#21551;&#29992;&#21644;&#31105;&#29992;&#65306;chkconfig &#8211;list name
</span>ls /etc/systemd/system/*.wants/name.service

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#22833;&#36133;&#30340;&#26381;&#21153;
</span>systemctl --failed --type=service

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26381;&#21153;&#30340;&#20381;&#36182;&#20851;&#31995;&#65306;
</span>systemctl list-dependencies name.service
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">##</span><span style="color: #b22222;">setp1
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#65306;&#30456;&#24403;&#20110;service name start 
</span>systemctl start name1.service  name2.service   

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20572;&#27490;&#65306;&#30456;&#24403;&#20110;service name stop
</span>systemctl stop name.service

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;&#65306;&#30456;&#24403;&#20110;service name restart 
</span>systemctl restart name.service 

<span style="color: #b22222;">##</span><span style="color: #b22222;">setp2
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#27490;&#33258;&#21160;&#21644;&#25163;&#21160;&#21551;&#21160;&#65306;
</span>systemctl mask name.service <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25226; /etc/systemd/system/&#19979;&#30340;&#36719;&#36830;&#25509;&#25991;&#20214;&#25351;&#21521;/dev/null
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#28040;&#31105;&#27490;
</span>systemctl unmask name.service

<span style="color: #b22222;">##</span><span style="color: #b22222;">setp3
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#23450;&#26576;&#26381;&#21153;&#24320;&#26426;&#33258;&#21551;&#65292;&#30456;&#24403;&#20110;chkconfig name on 
</span>systemctl enable name.service 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#23450;&#26576;&#26381;&#21153;&#24320;&#26426;&#31105;&#27490;&#21551;&#21160;&#65306;&#30456;&#24403;&#20110;chkconfig name off
</span>systemctl disable name.service

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#26426;&#24182;&#31435;&#21363;&#21551;&#21160;&#25110;&#20572;&#27490;
</span>systemctl enable --now postfix 
systemctl disable  --now postfix

<span style="color: #b22222;">##</span><span style="color: #b22222;">setp4
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26432;&#25481;&#36827;&#31243;&#65306;
</span>systemctl kill unitname
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ea007418-a7c5-4f5d-a690-a15f8663c759" class="outline-3">
<h3 id="h:ea007418-a7c5-4f5d-a690-a15f8663c759">service unit文件格式</h3>
<div class="outline-text-3" id="text-h:ea007418-a7c5-4f5d-a690-a15f8663c759">
<ul class="org-ul">
<li>/etc/systemd/system：系统管理员和用户使用</li>
<li>/usr/lib/systemd/system：发行版打包者使用</li>
</ul>

<p>
帮助参考： systemd.directives（7），systemd.unit(5),systemd.service(5), systemd.socket(5), systemd.target(5),systemd.exec(5)
</p>

<p>
unit 格式说明：
</p>

<ul class="org-ul">
<li>以 "#" 开头的行后面的内容会被认为是注释</li>
<li>相关布尔值，1、yes、on、true 都是开启，0、no、off、false 都是关闭</li>
<li>时间单位默认是秒，所以要用毫秒（ms）分钟（m）等须显式说明</li>
</ul>

<p>
service unit file文件通常由三部分组成：
</p>

<ul class="org-ul">
<li>[Unit]：定义与Unit类型无关的通用选项；用于提供unit的描述信息、unit行为及依赖关系等</li>
<li>[Service]：与特定类型相关的专用选项；此处为Service类型</li>
<li>[Install]：定义由“systemctl enable”以及”systemctl
disable“命令在实现服务启用或禁用时用到的一些选项</li>
</ul>

<p>
参考：
</p>

<ul class="org-ul">
<li>Unit及Instatll字段参考：<a href="https://www.jinbuguo.com/systemd/systemd.unit.html#AllowIsolate">https://www.jinbuguo.com/systemd/systemd.unit.html#AllowIsolate</a></li>
<li>systemd.service — 服务单元配置：<a href="https://www.jinbuguo.com/systemd/systemd.service.html">https://www.jinbuguo.com/systemd/systemd.service.html</a></li>
<li>systemd.exec — 执行环境配置: <a href="https://www.jinbuguo.com/systemd/systemd.exec.html#">https://www.jinbuguo.com/systemd/systemd.exec.html#</a></li>
<li>systemd.kill — 配置 如何杀死进程: <a href="https://www.jinbuguo.com/systemd/systemd.kill.html">https://www.jinbuguo.com/systemd/systemd.kill.html</a></li>
<li>systemd.resource-control — 单元的资源限制: <a href="https://www.jinbuguo.com/systemd/systemd.resource-control.html#">https://www.jinbuguo.com/systemd/systemd.resource-control.html#</a></li>
</ul>

<p>
<b>Unit段的常用选项：</b>
</p>

<ul class="org-ul">
<li>Description：描述信息</li>
<li>Documentation= 一组用空格分隔的文档URI列表. 如 Documentation=<a href="https://github.com/kubernetes/kubernetes">https://github.com/kubernetes/kubernetes</a></li>
<li>After：定义unit的启动次序，表示当前unit应该晚于哪些unit启动，其功能与Before相反</li>
<li>Requires：依赖到的其它units，强依赖，被依赖的units无法激活时，当前unit也无法激活</li>
<li>Wants：依赖到的其它units，弱依赖</li>
<li>Conflicts：定义units间的冲突关系</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#head -n 5 /lib/systemd/system/postfix.service 
[Unit]
<span style="color: #a0522d;">Description</span>=Postfix Mail Transport Agent
<span style="color: #a0522d;">After</span>=syslog.target network.target
<span style="color: #a0522d;">Conflicts</span>=sendmail.service exim.service
</pre>
</div>

<p>
<b>Service段的常用选项：</b>
</p>

<p>
<a href="https://www.jinbuguo.com/systemd/systemd.service.html#">systemd.service — 服务单元配置</a>:
</p>

<ul class="org-ul">
<li>Type：定义影响ExecStart及相关参数的功能的unit进程启动类型

<ul class="org-ul">
<li>simple：默认值，这个daemon主要由ExecStart接的指令串来启动，启动后
常驻于内存中</li>
<li>forking：由ExecStart启动的程序透过spawns延伸出其他子程序来作为此
daemon的主要服务。原生父程序在启动结束后就会终止</li>
<li>oneshot：与simple类似，不过这个程序在工作完毕后就结束了，不会常驻
在内存中</li>
<li>dbus：与simple类似，但这个daemon必须要在取得一个D-Bus的名称后，才
会继续运作.因此通常也要同时设定BusNname=才行</li>
<li>notify：在启动完成后会发送一个通知消息。还需要配合 NotifyAccess 来
让Systemd 接收消息</li>
<li>idle：与simple类似，要执行这个daemon必须要所有的工作都顺利执行完毕
后才会执行。这类的daemon通常是开机到最后才执行即可的服务</li>
</ul></li>

<li>ExecStart：指明启动unit要运行命令或脚本的绝对路径</li>

<li>ExecStartPre： ExecStart前运行。语法规则与 ExecStart= 完全相同。 如果设置了多个命令行</li>

<li>ExecStartPost： ExecStart后运行</li>

<li>ExecReload  ：重新载入配置。特殊的环境变量 $MAINPID 可用于表示主进程的PID。 /bin/kill -s HUP $MAINPID</li>

<li>ExecStop：指明停止unit要运行的命令或脚本</li>

<li>Restart：是否重新启动该服务. no(默认值) 表示不会被重启。 always 表示会被无条件的重启。on-failure 表示 仅在服务进程异常退出时重启</li>

<li>PrivateTmp：设定为yes时，会在生成
/tmp/systemd-private-UUID-NAME.service-XXXXX/tmp/目录</li>

<li>RestartSec=: 设置在重启服务(Restart=)前暂停多长时间。默认值是100毫秒
(100ms)。 如果未指定时间单位，那么将视为以秒为单位。例如设为”20”等
价于设为”20s”。</li>
</ul>

<p>
<a href="https://www.jinbuguo.com/systemd/systemd.exec.html#">systemd.exec 执行环境配置</a>:
</p>
<ul class="org-ul">
<li>路径
<ul class="org-ul">
<li>WorkingDirectory= 设置进程的工作目录。</li>
<li>EnvironmentFile：环境配置文件. 但可在路径前加上 "-" 前缀表示忽略不存在的文件。 可以多次使用此选项，以从多个不同的文件中读取设置。</li>
</ul></li>

<li>凭证
<ul class="org-ul">
<li>User=, Group= : 设置进程在执行时使用的用户与组。</li>
</ul></li>

<li>进程属性
<ul class="org-ul">
<li>OOMScoreAdjust= 设置进程因内存不足而被杀死的优先级。 可设为 -1000(禁止被杀死) 到 1000(最先被杀死)之间的整数值。 详见 <a href="https://www.kernel.org/doc/Documentation/filesystems/proc.txt">proc.txt</a> 文档。</li>
<li>LimitCPU=, LimitFSIZE=, LimitDATA=, LimitSTACK=, LimitCORE=, LimitRSS=, LimitNOFILE=, LimitAS=, LimitNPROC=, LimitMEMLOCK=, LimitLOCKS=, LimitSIGPENDING=, LimitMSGQUEUE=, LimitNICE=, LimitRTPRIO=, LimitRTTIME=
<ul class="org-ul">
<li>特殊值 infinity 表示没有限制。</li>
</ul></li>
</ul></li>
</ul>


<figure id="org73c8148">
<img src="./images/image-20210228010307414.png" alt="image-20210228010307414.png" width="50%">

<figcaption><span class="figure-number">Figure 1: </span>表 1. 资源限制指令、对应的 ulimit 命令、单位</figcaption>
</figure>


<p>
<a href="https://www.jinbuguo.com/systemd/systemd.kill.html">systemd.kill — 配置 如何杀死进程</a>:
</p>

<ul class="org-ul">
<li>KillMode=设置在单元停止时，杀死进程的方法。 取值范围如下： control-group, process, mixed, none
<ul class="org-ul">
<li>control-group 表示杀死该单元的 cgroup 内的所有进程. 默认值</li>
<li>process 表示仅杀死主进程。</li>
</ul></li>
</ul>

<p>
<a href="https://www.jinbuguo.com/systemd/systemd.resource-control.html#">systemd.resource-control — 单元的资源限制</a>: 
</p>

<ul class="org-ul">
<li>CPUQuota= 为此单元的进程设置CPU时间限额，必须设为一个以"%"结尾的百分数， 表示该单元最多可使用单颗CPU总时间的百分之多少。
<ul class="org-ul">
<li>例如 CPUQuota=20% 能够确保 此单元的进程永远不会使用超过 20% 的单颗CPU时间。</li>
</ul></li>
<li>MemoryMin=bytes 设置该单元进程的最低内存用量保证值。 选项值可以是以字节为单位的绝对内存大小 (可以使用以1024为基数的 K, M, G, T 后缀)， 也可以是以百分比表示的相对内存大小(相对于系统的全部物理内存)。
<ul class="org-ul">
<li>例如 MemoryLimit=250M。</li>
</ul></li>
</ul>

<p>
<b>Install段的常用选项：</b>
</p>

<ul class="org-ul">
<li>Alias：别名，可使用systemctl command Alias.service</li>
<li>RequiredBy：被哪些units所依赖，强依赖</li>
<li>WantedBy：被哪些units所依赖，弱依赖</li>
<li>Also：安装本服务的时候还要安装别的相关服务</li>
</ul>

<p>
注意：对于新创建的unit文件，或者修改了的unit文件，要通知systemd重载此
配置文件,而后可以选择重启
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl daemon-reload
</pre>
</div>

<p>
范例：服务Unit文件
</p>

<div class="org-src-container">
<pre class="src src-sh">[Unit]
<span style="color: #a0522d;">Description</span>=The Nginx HTTP Server daemon <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25551;&#36848;&#20449;&#24687;
</span><span style="color: #a0522d;">After</span>=network.target remote-fs.target nss-lookup.target 
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#21551;&#21160;nginx&#20043;&#21069;&#38656;&#35201;&#20854;&#20182;&#30340;&#20854;&#20182;&#26381;&#21153;&#65292;&#22914;network.target&#31561;
</span>
[Service]
<span style="color: #b22222;"># </span><span style="color: #b22222;">Type&#20026;&#26381;&#21153;&#31867;&#22411;&#65292;&#20165;&#21551;&#21160;&#19968;&#20010;&#20027;&#36827;&#31243;&#30340;&#26381;&#21153;&#20026;simple&#65292;&#38656;&#35201;&#21551;&#21160;&#33509;&#24178;&#23376;&#36827;&#31243;&#30340;&#26381;&#21153;&#20026;forking
</span><span style="color: #a0522d;">Type</span>=forking 

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#25191;&#34892;systemctl start nginx&#21518;&#38656;&#35201;&#21551;&#21160;&#30340;&#20855;&#20307;&#21629;&#20196;
</span><span style="color: #a0522d;">ExecStart</span>=/usr/local/nginx/sbin/nginx

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#25191;&#34892;systemctl reload nginx&#21518;&#38656;&#35201;&#25191;&#34892;&#30340;&#20855;&#20307;&#21629;&#20196;
</span><span style="color: #a0522d;">ExecReload</span>=/usr/local/nginx/sbin/nginx -s reload

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#25191;&#34892;systemctl stop nginx&#21518;&#38656;&#35201;&#25191;&#34892;&#30340;&#20855;&#20307;&#21629;&#20196;
</span><span style="color: #a0522d;">ExecStop</span>=/bin/kill -s QUIT ${<span style="color: #a0522d;">MAINPID</span>}

[Install]
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#22312;&#20160;&#20040;&#27169;&#24335;&#19979;&#34987;&#23433;&#35013;&#65292;&#35774;&#32622;&#24320;&#26426;&#21551;&#21160;&#30340;&#26102;&#20505;&#38656;&#35201;
</span><span style="color: #a0522d;">WantedBy</span>=multi-user.target
</pre>
</div>

<p>
范例：kubelet
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@ip-10-0-133-61 ~]#  systemctl cat kubelet
<span style="color: #b22222;"># </span><span style="color: #b22222;">/etc/systemd/system/kubelet.service
</span>[Unit]
<span style="color: #a0522d;">Description</span>=Kubernetes Kubelet
<span style="color: #a0522d;">Documentation</span>=https://github.com/kubernetes/kubernetes
<span style="color: #a0522d;">After</span>=containerd.service sandbox-image.service
<span style="color: #a0522d;">Requires</span>=containerd.service sandbox-image.service

[Service]
<span style="color: #a0522d;">Slice</span>=runtime.slice
<span style="color: #a0522d;">ExecStartPre</span>=/sbin/iptables -P FORWARD ACCEPT -w 5
<span style="color: #a0522d;">ExecStart</span>=/usr/bin/kubelet <span style="color: #8b2252;">\</span>
    --config /etc/kubernetes/kubelet/kubelet-config.json <span style="color: #8b2252;">\</span>
    --kubeconfig /var/lib/kubelet/kubeconfig <span style="color: #8b2252;">\</span>
    --container-runtime-endpoint unix:///run/containerd/containerd.sock <span style="color: #8b2252;">\</span>
    --image-credential-provider-config /etc/eks/image-credential-provider/config.json <span style="color: #8b2252;">\</span>
    --image-credential-provider-bin-dir /etc/eks/image-credential-provider <span style="color: #8b2252;">\</span>
    $<span style="color: #a0522d;">KUBELET_ARGS</span> <span style="color: #8b2252;">\</span>
    $<span style="color: #a0522d;">KUBELET_EXTRA_ARGS</span>

<span style="color: #a0522d;">Restart</span>=on-failure
<span style="color: #a0522d;">RestartForceExitStatus</span>=SIGPIPE
<span style="color: #a0522d;">RestartSec</span>=5
<span style="color: #a0522d;">KillMode</span>=process
<span style="color: #a0522d;">CPUAccounting</span>=true
<span style="color: #a0522d;">MemoryAccounting</span>=true

[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target

<span style="color: #b22222;"># </span><span style="color: #b22222;">/etc/systemd/system/kubelet.service.d/10-kubelet-args.conf
</span>[Service]
<span style="color: #a0522d;">Environment</span>=<span style="color: #8b2252;">'KUBELET_ARGS=--node-ip=10.0.133.61 --pod-infra-container-image=8770xxxx.dkr.ecr.af-south-1.amazonaws.com/eks/pause:3.5 --v=2 --hostname-override=ip-10-0-133-61.af-south-1
# /etc/systemd/system/kubelet.service.d/30-kubelet-extra-args.conf
[Service]
Environment='</span><span style="color: #a0522d;">KUBELET_EXTRA_ARGS</span>=--node-labels=eks.amazonaws.com/sourceLaunchTemplateVersion=8,eks.amazonaws.com/nodegroup-image=ami-0660eafe04534cc32,eks.amazonaws.com/capacityType=ON_DEM
</pre>
</div>

<p>
范例：服务Unit文件示例（了解）
</p>

<div class="org-src-container">
<pre class="src src-sh">vim /usr/lib/systemd/system/tomcat.service 
[Unit]
<span style="color: #a0522d;">Description</span>=java tomcat project
<span style="color: #a0522d;">After</span>=syslog.target network.target

[Service]
<span style="color: #a0522d;">Type</span>=forking
<span style="color: #a0522d;">EnvironmentFile</span>=/usr/local/tomcat/conf/tomcat.conf
<span style="color: #a0522d;">ExecStart</span>=/usr/local/tomcat/bin/startup.sh
<span style="color: #a0522d;">ExecStop</span>=/usr/local/tomcat/bin/shutdown.sh
<span style="color: #a0522d;">PrivateTmp</span>=true
<span style="color: #a0522d;">User</span>=tomcat

[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target
</pre>
</div>

<p>
范例：服务Unit文件示例（了解）
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@test jasper]# systemctl  cat nginx
<span style="color: #b22222;"># </span><span style="color: #b22222;">/usr/lib/systemd/system/nginx.service
</span>[Unit]
<span style="color: #a0522d;">Description</span>=nginx - high performance web server
<span style="color: #a0522d;">Documentation</span>=http://nginx.org/en/docs/
<span style="color: #a0522d;">After</span>=network-online.target remote-fs.target nss-lookup.target
<span style="color: #a0522d;">Wants</span>=network-online.target

[Service]
<span style="color: #a0522d;">Type</span>=forking
<span style="color: #a0522d;">PIDFile</span>=/var/run/nginx.pid
<span style="color: #a0522d;">ExecStart</span>=/usr/sbin/nginx -c /etc/nginx/nginx.conf
<span style="color: #a0522d;">ExecReload</span>=/bin/sh -c <span style="color: #8b2252;">"/bin/kill -s HUP $(/bin/cat /var/run/nginx.pid)"</span>
<span style="color: #a0522d;">ExecStop</span>=/bin/sh -c <span style="color: #8b2252;">"/bin/kill -s TERM $(/bin/cat /var/run/nginx.pid)"</span>

[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">cat &gt;/usr/lib/systemd/system/nginx.service&lt;&lt;\EOF<span style="color: #ffa54f;">
[Unit]
Description=The NGINX HTTP and reverse proxy server
Documentation=http://nginx.org/en/docs/
After=network-online.target remote-fs.target nss-lookup.target
Wants=network-online.target

[Service]
Type=forking
PIDFile=/usr/local/nginx/logs/nginx.pid
ExecStartPre=/usr/local/nginx/sbin/nginx -t
ExecStart=/usr/local/nginx/sbin/nginx
ExecReload=/usr/local/nginx/sbin/nginx -s reload
#ExecReload=/bin/kill -s HUP $MAINPID
ExecStop=/bin/kill -s QUIT $MAINPID
PrivateTmp=true
LimitNOFILE=infinity

[Install]
WantedBy=multi-user.target
EOF
</span>systemctl daemon-reload
systemctl enable nginx


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#26435;&#38480;
</span>sudo chmod +x /usr/lib/systemd/system/nginx.service
sudo systemctl enable nginx.service

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29616;&#22312;&#21487;&#20197;&#20351;&#29992;&#19979;&#38754;&#30340;&#25351;&#20196;&#26469;&#25511;&#21046;nginx&#21862;
</span>sudo systemctl start nginx.service
sudo systemctl reload nginx.service
sudo systemctl restart nginx.service
sudo systemctl stop nginx.service

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26085;&#24535;
</span>journalctl -f -u nginx.service

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26381;&#21153;&#36164;&#28304;&#38480;&#21046;
</span>systemctl show nginx.service |grep -i limit
</pre>
</div>

<p>
范例：zookeeper unit文件
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@master01 ~]# cat /usr/lib/systemd/system/zookeeper.service
[Unit]
<span style="color: #a0522d;">Description</span>=Apache ZooKeeperPI
<span style="color: #a0522d;">After</span>=network.target
<span style="color: #a0522d;">ConditionPathExists</span>=/etc/zookeeper/conf/zoo.cfg
<span style="color: #a0522d;">ConditionPathExists</span>=/etc/zookeeper/conf/log4j.properties

[Service]
<span style="color: #a0522d;">Environment</span>=<span style="color: #8b2252;">"ZOOCFGDIR=/etc/zookeeper/conf"</span>
<span style="color: #a0522d;">SyslogIdentifier</span>=zookeeper
<span style="color: #a0522d;">WorkingDirectory</span>=/opt/mesosphere/zookeeper
<span style="color: #a0522d;">ExecStart</span>=/opt/mesosphere/zookeeper/bin/zkServer.sh start-foreground
<span style="color: #a0522d;">Restart</span>=on-failure
<span style="color: #a0522d;">RestartSec</span>=20
<span style="color: #a0522d;">User</span>=root
<span style="color: #a0522d;">Group</span>=root

[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target
</pre>
</div>

<p>
范例：服务
</p>

<div class="org-src-container">
<pre class="src src-sh">[Unit]
<span style="color: #a0522d;">Description</span>=Java Service

[Service]
<span style="color: #a0522d;">User</span>=www
<span style="color: #a0522d;">WorkingDirectory</span>=/rummy/rummy-pot
<span style="color: #a0522d;">Environment</span>=<span style="color: #a0522d;">LOG_DIR</span>=/rummy/rummy-pot
<span style="color: #a0522d;">ExecStart</span>=/usr/local/java/bin/java  -XX:<span style="color: #a0522d;">MetaspaceSize</span>=128m -XX:<span style="color: #a0522d;">MaxMetaspaceSize</span>=128m -XX:+HeapDumpOnOutOfMemoryError -Xms4g -Xmx4g  -Xss256k  -XX:+UseG1GC -XX:<span style="color: #a0522d;">MaxGCPauseMillis</span>=200 -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -XX:+PrintGCDetails -Xloggc:/rummy/rummy-pot/logs/gc.log -jar rummy-pot.jar
<span style="color: #a0522d;">SuccessExitStatus</span>=143
<span style="color: #a0522d;">TimeoutStopSec</span>=10
<span style="color: #a0522d;">Restart</span>=on-failure
<span style="color: #a0522d;">RestartSec</span>=5
<span style="color: #a0522d;">LimitNOFILE</span> = 200000

[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target
</pre>
</div>

<p>
范例：Ubutun实现开机自动运行程序
</p>

<div class="org-src-container">
<pre class="src src-sh">root@ubuntu1804 ~]#ll /lib/systemd/system/rc.local.service 
lrwxrwxrwx 1 root root 16 Dec 12  2018 /lib/systemd/system/rc.local.service -&gt; 
rc-local.service
[root@ubuntu1804 ~]#grep -v <span style="color: #8b2252;">"^#"</span> /lib/systemd/system/rc.local.service 
[Unit]
<span style="color: #a0522d;">Description</span>=/etc/rc.local Compatibility
<span style="color: #a0522d;">Documentation</span>=man:systemd-rc-local-generator(8)
<span style="color: #a0522d;">ConditionFileIsExecutable</span>=/etc/rc.local
<span style="color: #a0522d;">After</span>=network.target

[Service]
<span style="color: #a0522d;">Type</span>=forking
<span style="color: #a0522d;">ExecStart</span>=/etc/rc.local start
<span style="color: #a0522d;">TimeoutSec</span>=0
<span style="color: #a0522d;">RemainAfterExit</span>=yes
<span style="color: #a0522d;">GuessMainPID</span>=no

[root@ubuntu1804 ~]#vim /etc/rc.local
[root@ubuntu1804 ~]#cat /etc/rc.local
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash
</span><span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">'\E[31;1mstarting test service\E[0m'</span>
sleep 10
[root@ubuntu1804 ~]#chmod +x /etc/rc.local
[root@ubuntu1804 ~]#reboot
</pre>
</div>

<p>
<b>多进程管理</b>
</p>

<p>
在systemd中，我们不需要为每个实例化进程编写一份配置文件，只需要编写一
个模板文件，然后在启用时候调用模板文件即可，模板文件可以通过匹配模板时
传入的字符串实例化进程模板文件中的%I、%i被展开为命令中@之后.service之
前的字符串，即ethN。%I与%i的区别在此例中看不出来，实际上%I展开后是不转
义的字符串，而%i展开后是转移的字符串。
</p>

<p>
memcached unit 文件：
</p>

<div class="org-src-container">
<pre class="src src-sh">cp /lib/systemd/system/memcached.service /lib/systemd/system/memcached@.service

[Unit]
<span style="color: #a0522d;">Description</span>=Memcached
<span style="color: #a0522d;">Before</span>=httpd.service
<span style="color: #a0522d;">After</span>=network.target

[Service]
<span style="color: #a0522d;">Type</span>=simple
<span style="color: #a0522d;">EnvironmentFile</span>=-/etc/sysconfig/memcached%i
<span style="color: #a0522d;">ExecStart</span>=/usr/bin/memcached -u $<span style="color: #a0522d;">USER</span> -p $<span style="color: #a0522d;">PORT</span> -m $<span style="color: #a0522d;">CACHESIZE</span> -c $<span style="color: #a0522d;">MAXCONN</span> $<span style="color: #a0522d;">OPTIONS</span>

[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target

systemctl start memcached@1 &#22312;service&#25991;&#20214;&#37324;&#29992;%i&#26469;&#25509;&#21463;&#21442;&#25968;

systemctl enable memcached@2.service
systemctl enable memcached@1.service
[root@xu-2 sysconfig]# systemctl list-unit-files|grep enable|grep memcached
memcached@.service   

&#24403; systemd &#26597;&#25214;&#21333;&#20803;&#25991;&#20214;&#26102;&#65292;&#20250;&#39318;&#20808;&#26597;&#25214;&#19982;&#21333;&#20803;&#21517;&#31216;&#23436;&#20840;&#21563;&#21512;&#30340;&#21333;&#20803;&#25991;&#20214;&#65292; &#22914;&#26524;&#27809;&#26377;&#25214;&#21040;&#65292;&#24182;&#19988;&#21333;&#20803;&#21517;&#31216;&#20013;&#21253;&#21547; <span style="color: #8b2252;">"@"</span> &#23383;&#31526;&#65292; &#37027;&#20040; systemd &#23558;&#20250;&#32487;&#32493;&#26597;&#25214;&#25317;&#26377;&#30456;&#21516;&#21069;&#32512;&#30340;&#27169;&#26495;&#25991;&#20214;&#65292; &#22914;&#26524;&#25214;&#21040;&#65292;&#37027;&#20040;&#23558;&#20174;&#36825;&#20010;&#27169;&#26495;&#25991;&#20214;&#23454;&#20363;&#21270;&#19968;&#20010;&#21333;&#20803;&#26469;&#20351;&#29992;&#12290; &#20363;&#22914;&#65292;&#23545;&#20110; getty@tty3.service &#21333;&#20803;&#26469;&#35828;&#65292; &#20854;&#23545;&#24212;&#30340;&#27169;&#26495;&#25991;&#20214;&#26159; getty@.service (&#20063;&#23601;&#26159;&#21435;&#25481; <span style="color: #8b2252;">"@"</span> &#19982;&#21518;&#32512;&#21517;&#20043;&#38388;&#30340;&#37096;&#20998;)&#12290;
systemctl enable --now memcached@2
</pre>
</div>

<p>
参考: <a href="https://www.cnblogs.com/xdao/p/systemctl_muti.html">https://www.cnblogs.com/xdao/p/systemctl_muti.html</a>
</p>
</div>
</div>
<div id="outline-container-h:aa278884-730a-49e7-b6ee-72532922b8e6" class="outline-3">
<h3 id="h:aa278884-730a-49e7-b6ee-72532922b8e6">运行级别</h3>
<div class="outline-text-3" id="text-h:aa278884-730a-49e7-b6ee-72532922b8e6">
<p>
target units：相当于CentOS 6之前的runlevel ,unit
</p>

<p>
配置文件：.target
</p>

<div class="org-src-container">
<pre class="src src-sh">ls /usr/lib/systemd/system/*.target
systemctl list-unit-files --type target --all
</pre>
</div>

<p>
和运行级别对应关系
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">0</span> ==&gt; runlevel0.target, poweroff.target
<span style="color: #a0522d;">1</span> ==&gt; runlevel1.target, rescue.target
<span style="color: #a0522d;">2</span> ==&gt; runlevel2.target, multi-user.target
<span style="color: #a0522d;">3</span> ==&gt; runlevel3.target, multi-user.target
<span style="color: #a0522d;">4</span> ==&gt; runlevel4.target, multi-user.target
<span style="color: #a0522d;">5</span> ==&gt; runlevel5.target, graphical.target
<span style="color: #a0522d;">6</span> ==&gt; runlevel6.target, reboot.target
0&#65306;&#20851;&#26426;
1&#65306;&#21333;&#29992;&#25143;&#27169;&#24335;(root&#33258;&#21160;&#30331;&#24405;), single, &#32500;&#25252;&#27169;&#24335;
2&#65306;&#22810;&#29992;&#25143;&#27169;&#24335;&#65292;&#21551;&#21160;&#32593;&#32476;&#21151;&#33021;&#65292;&#20294;&#19981;&#20250;&#21551;&#21160;NFS&#65307;&#32500;&#25252;&#27169;&#24335;
3&#65306;&#22810;&#29992;&#25143;&#27169;&#24335;&#65292;&#27491;&#24120;&#27169;&#24335;&#65307;&#25991;&#26412;&#30028;&#38754;
4&#65306;&#39044;&#30041;&#32423;&#21035;&#65307;&#21487;&#21516;3&#32423;&#21035;
5&#65306;&#22810;&#29992;&#25143;&#27169;&#24335;&#65292;&#27491;&#24120;&#27169;&#24335;&#65307;&#22270;&#24418;&#30028;&#38754;
6&#65306;&#37325;&#21551;
</pre>
</div>

<p>
查看依赖性：
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl list-dependencies graphical.target
</pre>
</div>

<p>
级别切换：相当于 init N
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl isolate name.target
</pre>
</div>

<p>
进入默认target
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl default  
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20999;&#25442;&#33267;&#23383;&#31526;&#27169;&#24335;
</span>systemctl isolate multi-user.target
</pre>
</div>

<p>
注意：只有/lib/systemd/system/*.target文件中AllowIsolate=yes
才能切换(修改文件需执行systemctl daemon-reload才能生效)
</p>

<p>
获取默认运行级别： 相当于查看 /etc/inittab
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl get-default
</pre>
</div>

<p>
修改默认级别：相当于修改 /etc/inittab
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl set-default name.target
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#systemctl set-default multi-user.target
[root@centos8 ~]#ls -l /etc/systemd/system/default.target
lrwxrwxrwx. 1 root root 37 Nov 7 19:32 /etc/systemd/system/default.target -&gt; 
/lib/systemd/system/multi-user.target
</pre>
</div>

<p>
切换至紧急救援模式：
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl rescue
</pre>
</div>

<p>
切换至emergency模式：
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl emergency
</pre>
</div>

<p>
说明：rescue.target 比emergency 支持更多的功能，例如日志等
</p>

<p>
传统命令init，poweroff，halt，reboot都成为 systemctl的软链接
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#26426;
</span>systemctl halt&#12289;systemctl poweroff

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;&#65306;
</span>systemctl reboot

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25346;&#36215;&#65306;
</span>systemctl suspend

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20241;&#30496;&#65306;
</span>systemctl hibernate

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20241;&#30496;&#24182;&#25346;&#36215;&#65306;
</span>systemctl hybrid-sleep
</pre>
</div>

<p>
范例：禁用ctrl+alt+delete 重启快捷键
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ls -l /lib/systemd/system/ctrl-alt-del.target    
lrwxrwxrwx. 1 root root 13 May 23 2019 /lib/systemd/system/ctrl-alt-del.target 
-&gt; reboot.target
[root@centos8 ~]#systemctl mask ctrl-alt-del.target 
Created symlink /etc/systemd/system/ctrl-alt-del.target &#8594; /dev/null.

[root@centos8 ~]#init q  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#24403;&#20110;systemctl daemon-reload &#37325;&#26032;&#21152;&#36733;&#21551;&#21160;&#25991;&#20214;
</span>[root@centos8 ~]#systemctl daemon-reload
</pre>
</div>
</div>
</div>
<div id="outline-container-h:be3a7920-7c43-404b-81a9-b530d92d7ab4" class="outline-3">
<h3 id="h:be3a7920-7c43-404b-81a9-b530d92d7ab4">设置内核参数</h3>
<div class="outline-text-3" id="text-h:be3a7920-7c43-404b-81a9-b530d92d7ab4">
<p>
设置内核参数，只响应当次请求
</p>

<p>
启动时，到启动菜单，按e键，找到在linux开头的行后添加systemd.unit=&lt;期望的运行模式&gt;.target
</p>

<p>
比如
</p>
<div class="org-src-container">
<pre class="src src-sh">systemd.unit=multi-user.target
systemd.unit=emergency.target
systemd.unit=rescue.target
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:fa9b09be-a7d3-4d9f-8564-44bcfed39546" class="outline-2">
<h2 id="h:fa9b09be-a7d3-4d9f-8564-44bcfed39546">journalctl</h2>
<div class="outline-text-2" id="text-h:fa9b09be-a7d3-4d9f-8564-44bcfed39546">
<p>
参考：
</p>
<ul class="org-ul">
<li>The systemd for Administrators Blog Series
<ul class="org-ul">
<li><a href="https://0pointer.de/blog/projects/journalctl.html">#17: Using the Journal</a></li>
</ul></li>
<li>journalctl命令选项：
<ul class="org-ul">
<li><a href="https://manpages.debian.org/unstable/manpages-zh/journalctl.1.zh_CN.html">Debian-manpage: journalctl</a></li>
<li><a href="https://manpages.ubuntu.com/manpages/questing/zh_CN/man1/journalctl.1.html">Ubuntu-manpage: journalctl</a></li>
</ul></li>
<li><a href="https://blog.csdn.net/omaidb/article/details/116019014?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=journalctl%20&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-8-116019014.142%5Ev102%5Epc_search_result_base6&amp;spm=1018.2226.3001.4187">CSDN:journalctl日志管理</a></li>
</ul>

<p>
命令选项
</p>
<div class="org-src-container">
<pre class="src src-sh">-f, --follow &#21482;&#26174;&#31034;&#26368;&#26032;&#30340;&#26085;&#24535;&#39033;&#65292;&#24182;&#19988;&#19981;&#26029;&#26174;&#31034;&#26032;&#29983;&#25104;&#30340;&#26085;&#24535;&#39033;&#12290; &#27492;&#36873;&#39033;&#38544;&#21547;&#20102; -n &#36873;&#39033;&#12290;

-e  &#33258;&#21160;&#28378;&#21160;&#21040;&#26368;&#26032;&#30340;&#26085;&#24535;&#26465;&#30446;&#12290;&#36339;&#36716;&#21040;&#26085;&#24535;&#30340;&#23614;&#37096;&#12290;

-n &#38480;&#21046;&#26174;&#31034;&#26368;&#26032;&#30340;&#26085;&#24535;&#34892;&#25968;&#12290; &#40664;&#35748;10&#34892;&#12290;

-o, --output=  &#25511;&#21046;&#26085;&#24535;&#30340;&#36755;&#20986;&#26684;&#24335;&#12290; &#21487;&#20197;&#20351;&#29992;&#22914;&#19979;&#36873;&#39033;

  verbose &#20197;&#32467;&#26500;&#21270;&#30340;&#26684;&#24335;&#26174;&#31034;&#27599;&#26465;&#26085;&#24535;&#30340;&#25152;&#26377;&#23383;&#27573;
  <span style="color: #483d8b;">export</span> &#23558;&#26085;&#24535;&#24207;&#21015;&#21270;&#20026;&#20108;&#36827;&#21046;&#23383;&#33410;&#27969;


-b [ID][&#177;offset], --boot=[ID][&#177;offset] &#26174;&#31034;&#29305;&#23450;&#20110;&#26576;&#27425;&#21551;&#21160;&#30340;&#26085;&#24535;&#65292; &#36825;&#30456;&#24403;&#20110;&#28155;&#21152;&#20102;&#19968;&#20010; <span style="color: #8b2252;">"_BOOT_ID="</span> &#21305;&#37197;&#26465;&#20214;&#12290;

-k, --dmesg &#20165;&#26174;&#31034;&#20869;&#26680;&#26085;&#24535;&#12290;&#38544;&#21547;&#20102; -b &#36873;&#39033;&#20197;&#21450; <span style="color: #8b2252;">"_TRANSPORT=kernel"</span> &#21305;&#37197;&#39033;&#12290;

-u, --unit=UNIT|PATTERN  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20165;&#26174;&#31034;&#23646;&#20110;&#29305;&#23450;&#21333;&#20803;&#30340;&#26085;&#24535;&#12290; (UNIT)
</span>
-x, --catalog &#22312;&#26085;&#24535;&#30340;&#36755;&#20986;&#20013;&#22686;&#21152;&#19968;&#20123;&#35299;&#37322;&#24615;&#30340;&#30701;&#25991;&#26412;&#65292; &#20197;&#24110;&#21161;&#36827;&#19968;&#27493;&#35828;&#26126;&#26085;&#24535;&#30340;&#21547;&#20041;&#12289; &#38382;&#39064;&#30340;&#35299;&#20915;&#26041;&#26696;&#12289;&#25903;&#25345;&#35770;&#22363;&#12289; &#24320;&#21457;&#25991;&#26723;&#12289;&#20197;&#21450;&#20854;&#20182;&#20219;&#20309;&#20869;&#23481;&#12290; 

-S, --since=, -U, --until=

  &#21442;&#25968;&#30340;&#26684;&#24335;&#31867;&#20284; <span style="color: #8b2252;">"2012-10-30 18:17:16"</span> &#12290; &#21442;&#25968;&#36824;&#21487;&#20197;&#36827;&#34892;&#22914;&#19979;&#35774;&#32622;&#65306; 
  (1)&#35774;&#20026; <span style="color: #8b2252;">"yesterday"</span>, <span style="color: #8b2252;">"today"</span>, <span style="color: #8b2252;">"tomorrow"</span> &#20197;&#34920;&#31034;&#37027;&#19968;&#22825;&#30340;&#38646;&#28857;(00:00:00)&#12290; 
  (2)&#35774;&#20026; <span style="color: #8b2252;">"now"</span> &#20197;&#34920;&#31034;&#24403;&#21069;&#26102;&#38388;&#12290; 
  (3)&#21487;&#20197;&#22312;<span style="color: #8b2252;">"&#24180;-&#26376;-&#26085; &#26102;:&#20998;:&#31186;"</span>&#21069;&#21152;&#19978; <span style="color: #8b2252;">"-"</span>(&#21069;&#31227;) &#25110; <span style="color: #8b2252;">"+"</span>(&#21518;&#31227;) &#21069;&#32512;&#20197;&#34920;&#31034;&#30456;&#23545;&#20110;&#24403;&#21069;&#26102;&#38388;&#30340;&#20559;&#31227;&#12290; 
  &#20851;&#20110;&#26102;&#38388;&#19982;&#26085;&#26399;&#30340;&#35814;&#32454;&#35268;&#33539;&#65292; &#21442;&#35265; systemd.time(7)

--disk-usage &#26174;&#31034;&#25152;&#26377;&#26085;&#24535;&#25991;&#20214;(&#24402;&#26723;&#25991;&#20214;&#19982;&#27963;&#21160;&#25991;&#20214;)&#30340;&#30913;&#30424;&#21344;&#29992;&#24635;&#37327;&#12290;
</pre>
</div>


<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26174;&#31034;&#23614;&#37096;&#25351;&#23450;&#34892;&#25968;&#30340;&#26085;&#24535;
</span>journalctl -n 20
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20174;&#26368;&#21518;&#19968;&#27425;&#21551;&#21160;&#24320;&#22987;&#30340;&#31995;&#32479;&#26381;&#21153;&#21644;&#20869;&#26680;&#26085;&#24535;
</span>journalctl -b --system
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20174;&#26368;&#21518;&#19968;&#27425;&#21551;&#21160;&#24320;&#22987;&#30340;&#24403;&#21069;&#29992;&#25143;&#30340;&#26381;&#21153;&#26085;&#24535;
</span>journalctl -b --user
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20174;&#26368;&#21518;&#19968;&#27425;&#21551;&#21160;&#24320;&#22987;&#30340; "$unit" &#24037;&#20316;&#26085;&#24535;
</span>journalctl -b -u $<span style="color: #a0522d;">unit</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20174;&#26368;&#21518;&#19968;&#27425;&#21551;&#21160;&#24320;&#22987;&#30340; "$unit"&#30340;&#24037;&#20316;&#26085;&#24535; ("tail -f" &#24335;&#26679;)
</span>journalctl -b -u $<span style="color: #a0522d;">unit</span> -f

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#26597;&#24403;&#21069;&#30001;journald&#31649;&#29702;&#30340;&#25152;&#26377;&#26085;&#24535;&#30340;&#23481;&#37327;
</span>journalctl --disk-usage

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475; systemd &#26085;&#24535;
</span>journalctl -u cron.service --since <span style="color: #8b2252;">"11:40:00"</span>
journalctl -u sshd --since <span style="color: #8b2252;">"2025-05-04 04:00:00"</span> --until <span style="color: #8b2252;">"2025-05-07 05:00:00"</span>
</pre>
</div>

<p>
显示元数据
</p>
<div class="org-src-container">
<pre class="src src-sh">$ journalctl -o verbose -n
[...]
Tue, 2012-10-23 23:51:38 CEST [<span style="color: #a0522d;">s</span>=ac9e9c423355411d87bf0ba1a9b424e8;<span style="color: #a0522d;">i</span>=4301;<span style="color: #a0522d;">b</span>=5335e9cf5d954633bb99aefc0ec38c25;<span style="color: #a0522d;">m</span>=882ee28d2;<span style="color: #a0522d;">t</span>=4ccc0f98326e6;<span style="color: #a0522d;">x</span>=f21e8b1b0994d7ee]
        <span style="color: #a0522d;">PRIORITY</span>=6
        <span style="color: #a0522d;">SYSLOG_FACILITY</span>=3
        <span style="color: #a0522d;">_MACHINE_ID</span>=a91663387a90b89f185d4e860000001a
        <span style="color: #a0522d;">_HOSTNAME</span>=epsilon
        <span style="color: #a0522d;">_TRANSPORT</span>=syslog
        <span style="color: #a0522d;">SYSLOG_IDENTIFIER</span>=avahi-daemon
        <span style="color: #a0522d;">_COMM</span>=avahi-daemon
        <span style="color: #a0522d;">_EXE</span>=/usr/sbin/avahi-daemon
        <span style="color: #a0522d;">_SYSTEMD_CGROUP</span>=/system/avahi-daemon.service
        <span style="color: #a0522d;">_SYSTEMD_UNIT</span>=avahi-daemon.service
        <span style="color: #a0522d;">_SELINUX_CONTEXT</span>=system_u:system_r:avahi_t:s0
        <span style="color: #a0522d;">_UID</span>=70
        <span style="color: #a0522d;">_GID</span>=70
        <span style="color: #a0522d;">_CMDLINE</span>=avahi-daemon: registering [epsilon.local]
        <span style="color: #a0522d;">MESSAGE</span>=Joining mDNS multicast group on interface wlan0.IPv4 with address 172.31.0.53.
        <span style="color: #a0522d;">_BOOT_ID</span>=5335e9cf5d954633bb99aefc0ec38c25
        <span style="color: #a0522d;">_PID</span>=27937
        <span style="color: #a0522d;">SYSLOG_PID</span>=27937
        <span style="color: #a0522d;">_SOURCE_REALTIME_TIMESTAMP</span>=1351029098747042

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#25152;&#26377;&#26469;&#33258; Linux &#29992;&#25143; ID 70 &#25110; 71 &#30340;&#26085;&#24535;&#28040;&#24687;
</span>journalctl <span style="color: #a0522d;">_UID</span>=70 <span style="color: #a0522d;">_UID</span>=71
</pre>
</div>

<p>
会话详情
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#36890;&#36807; journalctl &#36807;&#28388;&#29305;&#23450;&#20250;&#35805;
</span>journalctl <span style="color: #a0522d;">_PID</span>=4771
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25110;&#26597;&#30475;&#25152;&#26377; root &#29992;&#25143;&#20250;&#35805;
</span>journalctl <span style="color: #a0522d;">_UID</span>=0
</pre>
</div>

<p>
范例: ssh暴力破解检查
</p>
<div class="org-src-container">
<pre class="src src-sh">~]# tail /var/log/messages
May  8 13:50:01 overseas-tools systemd: Started Session 4786 of user root.

~]# grep 14450 /var/log/secure
May  4 04:18:22 overseas-tools sshd[14450]: Invalid user a from 195.211.191.197 port 39244
May  4 04:18:22 overseas-tools sshd[14450]: input_userauth_request: invalid user a [preauth]
May  4 04:18:24 overseas-tools sshd[14450]: Connection closed by 195.211.191.197 port 39244 [preauth]
<span style="color: #b22222;">#</span><span style="color: #b22222;">invalid user a&#65306;&#23581;&#35797;&#20351;&#29992;&#26080;&#25928;&#29992;&#25143;&#21517; a &#36827;&#34892;&#35748;&#35777;&#65292;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">[preauth]&#65306;&#27492;&#27425;&#35748;&#35777;&#35831;&#27714;&#22312;SSH&#30340;&#8220;&#39044;&#35748;&#35777;&#38454;&#27573;&#8221;&#34987;&#25298;&#32477;&#65288;&#26410;&#23436;&#25104;&#23494;&#38053;&#20132;&#25442;&#25110;&#23494;&#30721;&#39564;&#35777;&#21069;&#65289;&#12290;
</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36890;&#36807; journalctl &#36807;&#28388;&#29305;&#23450;&#20250;&#35805;
</span>~]# journalctl <span style="color: #a0522d;">_PID</span>=14450
-- Logs begin at Thu 2023-10-19 11:48:25 CST, end at Thu 2025-05-08 14:11:00 CST. --
Feb 19 08:10:01 overseas-tools CROND[14450]: (root) CMD (/usr/lib64/sa/sa1 1 1)
Mar 11 14:51:03 overseas-tools sshd[14450]: Invalid user centos from 59.148.102.58 port 50150
Mar 11 14:51:03 overseas-tools sshd[14450]: input_userauth_request: invalid user centos [preauth]
Mar 11 14:51:03 overseas-tools sshd[14450]: Connection closed by 59.148.102.58 port 50150 [preauth]
-- Reboot --
May 04 04:18:22 overseas-tools sshd[14450]: Invalid user a from 195.211.191.197 port 39244
May 04 04:18:22 overseas-tools sshd[14450]: input_userauth_request: invalid user a [preauth]
May 04 04:18:24 overseas-tools sshd[14450]: Connection closed by 195.211.191.197 port 39244 [preauth]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35786;&#26029;
</span><span style="color: #b22222;">## </span><span style="color: #b22222;">&#32479;&#35745;&#25152;&#26377;&#26080;&#25928;&#29992;&#25143;&#21517;&#30340;&#23581;&#35797;&#27425;&#25968;
</span>grep <span style="color: #8b2252;">"invalid user"</span> /var/log/secure | awk <span style="color: #8b2252;">'{print $(NF-1)}'</span> | sort | uniq -c | sort -nr
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#25552;&#21462;&#25152;&#26377;&#23581;&#35797;&#38750;&#27861;&#30331;&#24405;&#30340;IP&#22320;&#22336;
</span>grep <span style="color: #8b2252;">"sshd.*Invalid user.*from"</span> /var/log/secure | grep -oE <span style="color: #8b2252;">'([0-9]{1,3}\.){3}[0-9]{1,3}'</span> | sort | uniq -c

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;SSH&#37197;&#32622;
</span><span style="color: #b22222;">##</span><span style="color: #b22222;">&#30830;&#35748;SSH&#26381;&#21153;&#30417;&#21548;&#33539;&#22260;
</span>ss -tulnp | grep sshd
<span style="color: #b22222;">##</span><span style="color: #b22222;">&#26597;&#30475;SSH&#35748;&#35777;&#22833;&#36133;&#35760;&#24405;
</span>journalctl -u sshd --since <span style="color: #8b2252;">"2025-05-04 04:00:00"</span> --until <span style="color: #8b2252;">"2025-05-07 05:00:00"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38450;&#25252;
</span><span style="color: #b22222;">##</span><span style="color: #b22222;">&#38480;&#21046;SSH&#35775;&#38382;IP
</span><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"AllowUsers *@192.168.1.0/24"</span> &gt;&gt; /etc/ssh/sshd_config
<span style="color: #b22222;">##</span><span style="color: #b22222;">&#31105;&#29992;&#23494;&#30721;&#30331;&#24405;&#65292;&#21551;&#29992;&#23494;&#38053;&#35748;&#35777;
</span>sed -i <span style="color: #8b2252;">'s/#PasswordAuthentication yes/PasswordAuthentication no/g'</span> /etc/ssh/sshd_config
systemctl restart sshd
<span style="color: #b22222;">##</span><span style="color: #b22222;">&#26356;&#25913;SSH&#40664;&#35748;&#31471;&#21475;
</span><span style="color: #b22222;">##</span><span style="color: #b22222;">&#37096;&#32626;Fail2ban,&#33258;&#21160;&#23553;&#31105;&#22810;&#27425;&#23581;&#35797;&#22833;&#36133;&#30340;IP
</span>apt install fail2ban  <span style="color: #b22222;"># </span><span style="color: #b22222;">Debian/Ubuntu
</span>yum install fail2ban  <span style="color: #b22222;"># </span><span style="color: #b22222;">CentOS/RHEL
</span>systemctl enable --now fail2ban
<span style="color: #b22222;">##</span><span style="color: #b22222;">&#37197;&#32622;&#38450;&#28779;&#22681;&#35268;&#21017;&#65306;&#20351;&#29992; iptables &#25110; ufw &#38480;&#21046;SSH&#31471;&#21475;&#30340;&#35775;&#38382;&#39057;&#29575;
</span>ufw limit proto tcp to 0.0.0.0/0 port 22

<span style="color: #b22222;">#</span><span style="color: #b22222;">IP&#23433;&#20840;&#26816;&#26597;
</span><span style="color: #b22222;">##</span><span style="color: #b22222;">&#26816;&#26597;&#24403;&#21069;&#36830;&#25509;&#29366;&#24577;
</span>netstat -antp | grep 195.211.191.197
<span style="color: #b22222;">##</span><span style="color: #b22222;">&#26597;&#30475;&#21487;&#30097;&#36827;&#31243;
</span>ps -aux | grep [PID]
<span style="color: #b22222;">##</span><span style="color: #b22222;">&#23041;&#32961;&#24773;&#25253;&#24179;&#21488;&#39564;&#35777;
</span>&#24494;&#27493;&#22312;&#32447;&#65288;ThreatBook&#65289;&#65306;&#35775;&#38382; https://x.threatbook.cn/ &#36755;&#20837;IP&#65292;&#26597;&#30475;&#20854;&#21382;&#21490;&#23041;&#32961;&#26631;&#31614;&#65288;&#22914;&#26159;&#21542;&#20851;&#32852;&#24694;&#24847;&#36719;&#20214;&#23478;&#26063;&#25110;&#20725;&#23608;&#32593;&#32476;&#65289;&#12290;
VirusTotal&#65306;&#36890;&#36807; https://www.virustotal.com/ &#20998;&#26512;IP&#30340;&#20449;&#35465;&#35780;&#20998;&#21450;&#20851;&#32852;&#26679;&#26412;&#12290;
<span style="color: #b22222;">##</span><span style="color: #b22222;">&#20998;&#26512;&#35813;IP&#30340;&#20840;&#29699;&#23041;&#32961;&#30011;&#20687;
</span>&#21487;&#36890;&#36807; Shodan &#26597;&#35810;&#20854;&#24320;&#25918;&#31471;&#21475;&#21450;&#26381;&#21153;&#20449;&#24687; https://www.shodan.io/

<span style="color: #b22222;">##</span><span style="color: #b22222;">&#23553;&#31105;IP
</span>iptables -A INPUT -s 195.211.191.197 -j DROP
<span style="color: #b22222;">##</span><span style="color: #b22222;">&#28145;&#24230;&#25490;&#26597;
</span>&#26816;&#26597;&#31995;&#32479;&#23436;&#25972;&#24615;:
- &#20351;&#29992;&#24037;&#20855;&#65288;&#22914; rkhunter&#12289;chkrootkit&#65289;&#25195;&#25551;&#38544;&#34255;&#21518;&#38376;&#25110;Rootkit
- &#26816;&#26597;&#35745;&#21010;&#20219;&#21153;&#12289;&#21551;&#21160;&#39033;&#12289;&#26381;&#21153;&#21015;&#34920;&#26159;&#21542;&#23384;&#22312;&#24322;&#24120;&#26465;&#30446;
&#20840;&#30424;&#26432;&#27602;&#65306;
- &#20351;&#29992;ClamAV&#25110;&#20225;&#19994;&#32423;&#26432;&#27602;&#24037;&#20855;&#65288;&#22914;&#21345;&#24052;&#26031;&#22522;&#65289;&#25195;&#25551;&#24694;&#24847;&#25991;&#20214;
<span style="color: #b22222;">##</span><span style="color: #b22222;">&#27861;&#24459;&#19982;&#25253;&#21578;
</span>&#30041;&#23384;&#35777;&#25454;&#65306;
- &#23548;&#20986;&#23436;&#25972;&#26085;&#24535;&#21644;&#32593;&#32476;&#27969;&#37327;&#35760;&#24405;&#65292;&#29992;&#20110;&#21518;&#32493;&#21462;&#35777;&#12290;

&#19978;&#25253;&#30456;&#20851;&#37096;&#38376;&#65306;
- &#33509;&#30830;&#35748;&#25915;&#20987;&#28041;&#21450;&#37325;&#22823;&#23041;&#32961;&#65292;&#21487;&#32852;&#31995;&#22269;&#23478;&#32593;&#32476;&#23433;&#20840;&#36890;&#25253;&#20013;&#24515;&#25110;&#24403;&#22320;&#32593;&#35686;
</pre>
</div>

<p>
范例：服务无法启动排查
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">1. &#26597;&#30475;&#26381;&#21153;&#29366;&#24577;&#21644;&#26085;&#24535;
</span>systemctl status service_name
journalctl -u service_name -n 50

<span style="color: #b22222;"># </span><span style="color: #b22222;">2. &#26816;&#26597;&#31471;&#21475;&#21344;&#29992;
</span>ss -tlnp | grep :&#31471;&#21475;&#21495;
lsof -i :&#31471;&#21475;&#21495;

<span style="color: #b22222;"># </span><span style="color: #b22222;">3. &#26816;&#26597;&#37197;&#32622;&#25991;&#20214;&#35821;&#27861;
</span>nginx -t
httpd -t
mysql --help --verbose | grep -A 1 <span style="color: #8b2252;">"Default options"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">4. &#26816;&#26597;&#26435;&#38480;&#38382;&#39064;
</span>ls -la /path/to/service
namei -l /path/to/service/file

<span style="color: #b22222;"># </span><span style="color: #b22222;">5. &#26597;&#30475;SELinux&#38382;&#39064;
</span>getenforce
setenforce 0  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20020;&#26102;&#20851;&#38381;&#27979;&#35797;
</span>ausearch -m AVC -ts recent
</pre>
</div>

<p>
范例：使用journalctl高效排查
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#26102;&#38388;&#27573;&#30340;&#26085;&#24535;
</span>journalctl --since <span style="color: #8b2252;">"2024-01-01 00:00:00"</span> --until <span style="color: #8b2252;">"2024-01-01 01:00:00"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#26381;&#21153;&#30340;&#26085;&#24535;
</span>journalctl -u nginx.service -f

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#20869;&#26680;&#26085;&#24535;
</span>journalctl -k

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#20248;&#20808;&#32423;&#30340;&#26085;&#24535;
</span>journalctl -p err..emerg

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23548;&#20986;&#26085;&#24535;for&#20998;&#26512;
</span>journalctl -u service_name -o json &gt; service.json
</pre>
</div>
</div>
</section>
<section id="outline-container-h:10153c76-1ed8-43cb-861e-273504654859" class="outline-2">
<h2 id="h:10153c76-1ed8-43cb-861e-273504654859">/proc 目录和内核参数管理</h2>
<div class="outline-text-2" id="text-h:10153c76-1ed8-43cb-861e-273504654859">
<p>
/proc目录：内核把自己内部状态信息及统计信息，以及可配置参数通过proc伪文件系统加以输出
</p>

<p>
帮助：man proc
</p>

<div class="org-src-container">
<pre class="src src-sh">yum install -y man-pages
man proc
</pre>
</div>

<p>
内核参数：
</p>
<ul class="org-ul">
<li>只读：只用于输出信息</li>
<li>可写：可接受用户指定“新值”来实现对内核某功能或特性的配置</li>
</ul>
</div>
<div id="outline-container-h:a9ad6fa0-356f-4c89-9d4c-85b27fa7d308" class="outline-3">
<h3 id="h:a9ad6fa0-356f-4c89-9d4c-85b27fa7d308">systctl设置/proc/sys</h3>
<div class="outline-text-3" id="text-h:a9ad6fa0-356f-4c89-9d4c-85b27fa7d308">
<p>
systctl是一个允许改变正在运行中的linux系统的接口，修改的是整个系统的内核参数。sysctl的修改是立即且临时的(重启后失效)。
也可以通过修改sysctl.conf配置文件，达到永久生效。
</p>

<p>
sysctl命令用于查看或设定此目录中诸多参数
</p>

<div class="org-src-container">
<pre class="src src-sh">sysctl -w path.to.parameter=VALUE
</pre>
</div>

<ul class="org-ul">
<li>默认配置文件：/etc/sysctl.conf 及以下文件(参数设置放在任何一个都可以)</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">/run/sysctl.d/*.conf
/etc/sysctl.d/*.conf
/usr/local/lib/sysctl.d/*.conf
/usr/lib/sysctl.d/*.conf
/lib/sysctl.d/*.conf
/etc/sysctl.conf
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">sysctl -w kernel.hostname=mail.me.com
</pre>
</div>

<ul class="org-ul">
<li>echo命令通过重定向方式也可以修改大多数参数的值</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"VALUE"</span> &gt; /proc/sys/path/to/parameter
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">echo</span> &#8220;websrv&#8221; &gt; /proc/sys/kernel/hostname
</pre>
</div>

<p>
sysctl命令：
(1) 临时设置某参数
</p>

<div class="org-src-container">
<pre class="src src-sh">sysctl -w <span style="color: #a0522d;">parameter</span>=VALUE
</pre>
</div>

<p>
(2) 通过读取配置文件设置参数
</p>

<div class="org-src-container">
<pre class="src src-sh">sysctl -p [/path/to/conf_file]
</pre>
</div>

<p>
(3) 查看所有生效参数
</p>

<div class="org-src-container">
<pre class="src src-sh">sysctl -a
</pre>
</div>

<p>
常用的内核参数：
</p>

<div class="org-src-container">
<pre class="src src-sh">net.ipv4.ip_forward                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36335;&#30001;&#21151;&#33021;,&#34920;&#31034;&#24320;&#21551;ip&#36716;&#21457;
</span>net.ipv4.icmp_echo_ignore_all  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20801;&#35768;ping&#35774;&#32622;
</span>net.ipv4.ip_nonlocal_bind          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20801;&#35768;&#24212;&#29992;&#31243;&#24207;&#21487;&#20197;&#30417;&#21548;&#26412;&#22320;&#19981;&#23384;&#22312;&#30340;IP  &#65292;vip&#26102;&#20250;&#29992;&#21040;
</span>vm.drop_caches                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37322;&#25918;&#32531;&#20914;&#21306;
</span>fs.file-max = 1020000               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#22823;&#25991;&#20214;&#20010;&#25968;
</span>
vm.overcommit_memory = 0
<span style="color: #b22222;">#</span><span style="color: #b22222;">0&#34920;&#31034;&#20869;&#26680;&#23558;&#26816;&#26597;&#26159;&#21542;&#26377;&#36275;&#22815;&#21487;&#29992;&#20869;&#23384;&#20379;&#36827;&#31243;&#20351;&#29992;&#65307;&#22914;&#26524;&#26377;&#36275;&#22815;&#21487;&#29992;&#20869;&#23384;&#65292;&#20869;&#23384;&#30003;&#35831;&#20801;&#35768;&#65307;&#21542;&#21017;&#20869;&#23384;&#30003;&#35831;&#22833;&#36133;&#65292;&#24182;&#25226;&#38169;&#35823;&#36820;&#22238;&#32473;&#24212;&#29992;&#36827;&#31243;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">1&#34920;&#31034;&#20869;&#26680;&#20801;&#35768;&#20998;&#37197;&#25152;&#26377;&#30340;&#29289;&#29702;&#20869;&#23384;&#65292;&#32780;&#19981;&#31649;&#24403;&#21069;&#20869;&#23384;&#29366;&#24577;&#22914;&#20309;&#12290;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">2&#34920;&#31034;&#20869;&#26680;&#20801;&#35768;&#20998;&#37197;&#36229;&#36807;&#25152;&#26377;&#29289;&#29702;&#20869;&#23384;&#21644;&#20132;&#25442;&#31354;&#38388;&#24635;&#21644;&#30340;&#20869;&#23384;
</span>
vm.swappiness = 10         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#20869;&#23384;&#36824;&#21097;&#20313;10%&#31354;&#38386;&#31354;&#38388;&#26102;&#65292;&#23601;&#20250;&#20351;&#29992;swap&#31354;&#38388;&#65292;&#40664;&#35748;&#20540;&#20026;30&#65292;&#20540;&#36234;&#22823;&#34920;&#31034;&#36234;&#20542;&#21521;&#20110;&#20351;&#29992;swap
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#29992;ipv6
</span>net.ipv6.conf.all.disable_ipv6 =1
net.ipv6.conf.default.disable_ipv6 =1
</pre>
</div>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /proc/sys/net/ipv4/icmp_echo_ignore_all 
0
[root@centos8 ~]#vim /etc/sysctl.d/test.conf
[root@centos8 ~]#cat /etc/sysctl.d/test.conf
net.ipv4.icmp_echo_ignore_all=1
[root@centos8 ~]#sysctl -p /etc/sysctl.d/test.conf
net.ipv4.icmp_echo_ignore_all = 1
[root@centos8 ~]#cat /proc/sys/net/ipv4/icmp_echo_ignore_all 
1
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:99edcc75-a6f5-464e-a8c4-ee70d80156f3" class="outline-2">
<h2 id="h:99edcc75-a6f5-464e-a8c4-ee70d80156f3">/sys 目录</h2>
<div class="outline-text-2" id="text-h:99edcc75-a6f5-464e-a8c4-ee70d80156f3">
<p>
/sys目录：
</p>

<p>
使用sysfs文件系统，为用户使用的伪文件系统， <b>输出内核识别出的各硬件设
备的相关属性信息</b> ，也有内核对硬件特性的设定信息；有些参数是可以修改的，
用于调整硬件工作特性
</p>

<p>
udev通过此路径下输出的信息动态为各设备创建所需要设备文件，udev是运行用
户空间程序
</p>

<p>
专用工具：udevadmin, hotplug
</p>

<p>
udev为设备创建设备文件时，会读取其事先定义好的规则文件，一般在
/etc/udev/rules.d 及/usr/lib/udev/rules.d目录下
</p>
</div>
</section>
<section id="outline-container-h:cf699c8b-b48e-4f44-a0f2-577ecad299b1" class="outline-2">
<h2 id="h:cf699c8b-b48e-4f44-a0f2-577ecad299b1">内核模块管理和编译</h2>
<div class="outline-text-2" id="text-h:cf699c8b-b48e-4f44-a0f2-577ecad299b1">
<p>
单内核体系设计、但充分借鉴了微内核设计体系的优点，为内核引入模块化机制
</p>

<p>
内核组成部分：
</p>

<ul class="org-ul">
<li>kernel：内核核心，一般为bzImage，通常在/boot目录下 , 名称为
vmlinuz-VERSION-RELEASE</li>
<li>kernel object：内核对象，一般放置于 <code>/lib/modules/VERSION-RELEASE/</code></li>
<li>辅助文件：ramdisk
<ul class="org-ul">
<li>initrd：从CentOS 5 版本以前</li>
<li>initramfs：从CentOS6 版本以后</li>
</ul></li>
</ul>
</div>
<div id="outline-container-h:4204a51c-b3f6-4d17-ab2e-fd819ae78ced" class="outline-3">
<h3 id="h:4204a51c-b3f6-4d17-ab2e-fd819ae78ced">内核版本</h3>
<div class="outline-text-3" id="text-h:4204a51c-b3f6-4d17-ab2e-fd819ae78ced">
<p>
运行中的内核：
</p>

<p>
uname命令：
</p>

<p>
uname - print system information
</p>

<p>
uname [OPTION]&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-sh">-n: &#26174;&#31034;&#33410;&#28857;&#21517;&#31216;
-r: &#26174;&#31034;VERSION-RELEASE
-a:&#26174;&#31034;&#25152;&#26377;&#20449;&#24687;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8c326ac8-2293-4cd6-a4ed-0b8a19bf4157" class="outline-3">
<h3 id="h:8c326ac8-2293-4cd6-a4ed-0b8a19bf4157">内核模块命令</h3>
<div class="outline-text-3" id="text-h:8c326ac8-2293-4cd6-a4ed-0b8a19bf4157">
<p>
<b>lsmod命令：</b>
</p>

<ul class="org-ul">
<li>显示由核心已经装载的内核模块</li>
<li>显示的内容来自于: /proc/modules文件</li>
</ul>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#lsmod 
Module                 Size Used by
uas                    28672  0
usb_storage            73728  1 uas
nls_utf8               16384  0
isofs                  45056  0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#65306;&#21517;&#31216;&#12289;&#22823;&#23567;&#65292;&#20351;&#29992;&#27425;&#25968;&#65292;&#34987;&#21738;&#20123;&#27169;&#22359;&#20381;&#36182;</span>
</pre>
</div>

<p>
<b>modinfo命令：</b>
</p>

<p>
功能：管理内核模块
</p>

<p>
配置文件：/etc/modprobe.conf, /etc/modprobe.d/*.conf
</p>

<ul class="org-ul">
<li>显示模块的详细描述信息</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">modinfo [ -k kernel ] [ modulename|filename... ]
</pre>
</div>

<p>
常用选项：
</p>

<div class="org-src-container">
<pre class="src src-sh">-n&#65306;&#21482;&#26174;&#31034;&#27169;&#22359;&#25991;&#20214;&#36335;&#24452;&#65307;&#30456;&#23545;&#20110;-F filename
-p&#65306;&#26174;&#31034;&#27169;&#22359;&#21442;&#25968;
-a&#65306;&#20316;&#32773;
-d&#65306;&#25551;&#36848;
-F field&#65306;&#20165;&#26174;&#31034;&#25351;&#23450;&#23383;&#27573;&#30340;&#20449;&#24687;&#65307;
-k kernel&#65306;&#22810;&#20869;&#26680;&#24182;&#23384;&#26102;&#33509;&#35201;&#26597;&#35810;&#21478;&#22806;&#19968;&#20010;kernel&#19978;&#30340;&#27169;&#22359;&#20449;&#24687;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8-A ~]#lsmod |grep xfs
xfs                  1474560  2
libcrc32c              16384  3 nf_conntrack,nf_nat,xfs
[root@centos8-A ~]#modinfo xfs
filename:       /lib/modules/4.18.0-147.el8.x86_64/kernel/fs/xfs/xfs.ko.xz
license:        GPL
description:    SGI XFS with ACLs, security attributes, no debug enabled
author:         Silicon Graphics, Inc.
<span style="color: #483d8b;">alias</span>:          fs-xfs
rhelversion:    8.1
srcversion:     947E2EDC226CFCEC0F1F71B
depends:        libcrc32c
intree:         Y
name:           xfs
vermagic:       4.18.0-147.el8.x86_64 SMP mod_unload modversions 
sig_id:         PKCS#7
signer:         CentOS Linux kernel signing key
sig_key:        79:05:D0:5C:21:6F:8A:C5:DD:6E:19:BB:77:9D:05:F6:F2:21:B8:17
sig_hashalgo:   sha256
signature:      C9:68:71:F6:2D:2A:F9:83:AC:A8:12:30:29:E3:61:1C:0C:2F:1E:7E:
        BC:1D:87:B9:56:00:4E:6F:87:9C:6F:22:78:09:D1:D9:C0:D0:21:C1:
        8F:0F:62:11:C0:15:E5:6E:70:D4:A5:92:F7:15:D8:0F:C4:4E:F4:7E:
        87:74:A9:32:CC:D7:97:1B:11:B9:3C:98:51:25:DD:99:1D:15:55:19:
        C2:E4:67:58:AE:A0:7F:21:13:3C:F5:A1:8B:86:81:70:49:3F:62:3B:
        F0:37:A9:8F:87:01:5D:7F:FA:5C:5A:1F:16:88:EE:87:DA:03:8C:9D:
        92:7E:5E:F4:D6:56:AF:FF:DB:FA:8A:AC:D3:BE:2F:13:7A:1D:CB:BF:
        A5:EB:2C:06:2C:7D:55:E6:AA:78:83:51:F4:CA:72:98:79:C1:55:E4:
        80:C2:8D:4F:E5:CB:EC:A4:9D:AB:5A:AA:CB:8A:A5:FE:0C:E1:CC:1E:
        26:A3:D1:E7:FA:F4:D2:66:12:1F:BB:4F:73:16:8A:A0:19:7E:A5:17:
        3D:DF:2A:A5:B2:4F:64:44:2B:3E:06:A1:3A:5F:FF:DD:CC:6B:71:20:
        A8:6E:83:AF:A6:C0:38:B6:3A:C3:72:2F:74:64:1F:E4:1C:EC:E5:B4:
        77:AA:5D:38:3B:50:EB:1A:82:79:13:7C:A6:70:B1:37:A0:1E:4C:18:
        C9:14:46:7A:0B:D4:2F:A3:29:E6:49:42:D4:A8:03:4F:33:FA:D7:3E:
        C4:CE:F7:53:C7:1D:7F:28:4F:70:F5:67:71:29:2E:9C:E5:A6:60:02:
        D2:49:7F:F1:6D:3D:E6:F9:FF:B0:01:F8:C2:50:C3:AB:23:50:F4:19:
        A2:45:DC:9B:C3:1C:DA:C0:36:88:7C:C0:9B:D7:7D:B6:3A:D5:83:AD:
        AD:7A:33:92:09:D2:7F:B0:0E:B4:21:2F:DB:F9:F7:50:E4:C8:94:D1:
        29:E6:2D:C1:5D:51:94:14:1C:72:04:CB:BF:FC:DA:6E:A3:66:D2:0A:
        C5:E0:F2:0F
</pre>
</div>

<p>
<b>装载或卸载内核模块</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">modprobe [ -C config-file ] [ modulename ] [ module parame-ters... ] 
modprobe [ -r ] modulename&#8230; &#21368;&#36733;
&#21516;&#26102;&#20250;&#25346;&#36733;&#20381;&#36182;&#30340;&#27169;&#22359;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8-A ~]#lsmod |grep usb
btusb                  53248  0
btrtl                  16384  1 btusb
btbcm                  16384  1 btusb
btintel                24576  1 btusb
bluetooth             630784  27 btrtl,btintel,btbcm,bnep,btusb,rfcomm
[root@centos8-A ~]#modprobe usb_storage
[root@centos8-A ~]#lsmod |grep usb
usb_storage            73728  0
btusb                  53248  0
btrtl                  16384  1 btusb
btbcm                  16384  1 btusb
btintel                24576  1 btusb
bluetooth             630784  27 btrtl,btintel,btbcm,bnep,btusb,rfcomm
[root@centos8-A ~]#modprobe -r usb_storage
[root@centos8-A ~]#lsmod |grep uas

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22240;&#20026;uas&#20381;&#36182;usb_storage,&#23433;&#35013;uas&#20250;&#33258;&#21160;&#21152;&#36733;usb_storage
</span>[root@centos8-A ~]#modprobe uas
[root@centos8-A ~]#lsmod |grep usb
usb_storage            73728  1 uas
btusb                  53248  0
btrtl                  16384  1 btusb
btbcm                  16384  1 btusb
btintel                24576  1 btusb
bluetooth             630784  27 btrtl,btintel,btbcm,bnep,btusb,rfcomm
[root@centos8-A ~]#lsmod |grep -E <span style="color: #8b2252;">'usb|uas'</span>
uas                    28672  0
usb_storage            73728  1 uas
btusb                  53248  0
btrtl                  16384  1 btusb
btbcm                  16384  1 btusb
btintel                24576  1 btusb
bluetooth             630784  27 btrtl,btintel,btbcm,bnep,btusb,rfcomm

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22240;&#20026;uas&#20381;&#36182;usb_storage&#65292;&#26080;&#27861;&#30452;&#25509;&#21368;&#36733;usb_storage
</span>[root@centos8-A ~]#modprobe -r usb_storage
modprobe: FATAL: Module usb_storage is<span style="color: #a020f0;"> in</span> use.

[root@centos8-A ~]#modprobe -r uas
[root@centos8-A ~]#modprobe -r usb_storage
</pre>
</div>

<p>
depmod命令：内核模块依赖关系文件及系统信息映射文件的生成工具
</p>

<p>
insmod命令：可以安装模块，需要指定模块文件路径，并且不自动解决依赖模块
</p>

<div class="org-src-container">
<pre class="src src-sh">insmod [ filename ] [ module options... ]
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">insmod <span style="color: #ff00ff;">`modinfo &#8211;n exportfs`</span>
insmod <span style="color: #ff00ff;">`modinfo &#8211;n xfs`</span>
</pre>
</div>

<p>
rmmod命令：卸载模块
</p>

<div class="org-src-container">
<pre class="src src-sh">rmmod [ modulename ]
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">rmmod xfs
rmmod exportfs
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f30f3641-467f-49b3-a788-56a87a18d863" class="outline-3">
<h3 id="h:f30f3641-467f-49b3-a788-56a87a18d863">编译内核</h3>
<div class="outline-text-3" id="text-h:f30f3641-467f-49b3-a788-56a87a18d863">
<p>
编译安装内核准备：
</p>
<ol class="org-ol">
<li>准备好开发环境</li>
<li>获取目标主机上硬件设备的相关信息</li>
<li>获取目标主机系统功能的相关信息，例如:需要启用相应的文件系统</li>
<li>获取内核源代码包， www.kernel.org</li>
</ol>

<p>
<b>编译准备</b>
</p>

<p>
<b>目标主机硬件设备相关信息</b>
</p>

<p>
CPU：
</p>

<div class="org-src-container">
<pre class="src src-sh">cat /proc/cpuinfo
x86info -a
lscpu
</pre>
</div>

<p>
PCI设备：lspci -v ，-vv
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]# lspci <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;PCI&#35774;&#22791;
</span>00:00.0 Host bridge: Intel Corporation 440BX/ZX/DX - 82443BX/ZX/DX Host bridge (rev 01)
00:01.0 PCI bridge&#65288;&#21271;&#26725;&#65289;: Intel Corporation 440BX/ZX/DX - 82443BX/ZX/DX AGP bridge (rev 01)
00:07.0 ISA bridge&#65288;&#21335;&#26725;&#65289;: Intel Corporation 82371AB/EB/MB PIIX4 ISA (rev 08)
00:07.1 IDE interface(IDE&#25509;&#21475;): Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)
00:07.3 Bridge(&#39640;&#32423;&#30005;&#28304;&#31649;&#29702;&#26725;): Intel Corporation 82371AB/EB/MB PIIX4 ACPI (rev 08)
00:07.7 System peripheral&#65288;&#38598;&#25104;&#25509;&#21475;&#65289;: VMware Virtual Machine Communication Interface (rev 10)
00:0f.0 VGA compatible controller&#65288;&#26174;&#21345;&#25509;&#21475;&#65289;: VMware SVGA II Adapter
00:10.0 SCSI storage controller&#65288;&#23384;&#20648;&#25511;&#21046;&#22120;&#65289;: LSI Logic / Symbios Logic 53c1030 PCI-X Fusion-MPT Dual Ultra320 SCSI (rev 01)
... ...
00:18.7 PCI bridge: VMware PCI Express Root Port (rev 01)
02:00.0 USB controller: VMware USB1.1 UHCI Controller&#65288;&#22411;&#21495;UHCI&#65292;USB1.1&#25511;&#21046;&#22120;&#65289;
02:01.0 Ethernet controller: Intel Corporation 82545EM Gigabit Ethernet Controller (Copper) (rev 01)&#65288;&#21315;&#20806;&#20197;&#22826;&#32593;&#32593;&#25511;&#21046;&#22120;&#65289;
02:02.0 Multimedia audio controller: Ensoniq ES1371 / Creative Labs CT2518 [AudioPCI-97] (rev 02)
02:03.0 USB controller: VMware USB2 EHCI Controller&#65288;&#22411;&#21495;EHCI&#65292;USB2&#25511;&#21046;&#22120;&#65289;
</pre>
</div>

<p>
USB设备：lsusb -v，-vv
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8-A ~]#dnf install usbutils -y
[root@centos8-A ~]#lsusb
Bus 001 Device 004: ID 0951:1666 Kingston Technology DataTraveler 100 G3/G4/SE9 
G2
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 002 Device 003: ID 0e0f:0002 VMware, Inc. Virtual USB Hub
Bus 002 Device 002: ID 0e0f:0003 VMware, Inc. Virtual Mouse
Bus 002 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
[root@centos8-A ~]#lsmod |grep usb
usb_storage           73728 1 uas
</pre>
</div>

<p>
lsblk 块设备
</p>

<p>
全部硬件设备信息：hal-device：CentOS 6
</p>

<p>
<b>开发环境相关包</b>
</p>

<p>
gcc make ncurses-devel flex bison openssl-devel elfutils-libelf-devel
</p>

<p>
<b>内核编译安装实现</b>
</p>

<ul class="org-ul">
<li>下载源码文件</li>
<li>准备文本配置文件/boot/config-`uname -r`</li>
<li>make menuconfig：配置内核选项 ，相当于./configure</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">[ ]: N
[M]: M  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29420;&#31435;&#27169;&#22359;&#26680;&#24515;&#25991;&#20214;
</span>[*]: Y  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#21253;&#21040;&#20869;&#26680;&#25991;&#20214;&#20013;</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
make [-j #] 或者用以下两步实现：
</p>

<p>
make -j # bzImage
</p>

<p>
make -j # modules
</p></li>

<li>安装模块：make modules_install</li>
<li>安装内核相关文件：make install
<ul class="org-ul">
<li>安装bzImage为 /boot/vmlinuz-VERSION-RELEASE</li>
<li>生成initramfs文件</li>
<li>编辑grub的配置文件</li>
</ul></li>
</ul>

<p>
范例：编译内核
</p>

<div class="org-src-container">
<pre class="src src-sh">&#33719;&#21462;&#28304;&#20195;&#30721;
tar xf linux-
<span style="color: #483d8b;">cd</span> /usr/src
ln -sv linux-3.10.67 linux  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#35793;&#39537;&#21160;&#26102;&#36890;&#24120;&#20250;&#25214;linux&#30446;&#24405;&#65292;&#36825;&#37324;&#21019;&#24314;&#20010;&#36719;&#36830;&#25509;
</span><span style="color: #483d8b;">cd</span> linux
make menuconfig             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#20869;&#26680;&#36873;&#39033;
</span>make [-j <span style="color: #b22222;">#</span><span style="color: #b22222;">]                 #&#32534;&#35793;&#20869;&#26680;&#65292;&#21487;&#20351;&#29992;-j&#25351;&#23450;&#32534;&#35793;&#32447;&#31243;&#25968;&#25454;&#27969;
</span>make modules_install        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#20869;&#26680;&#27169;&#22359;
</span>make install                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#20869;&#26680;
</span>&#37325;&#21551;&#31995;&#32479;&#65292;&#36873;&#25321;&#20351;&#29992;&#26032;&#20869;&#26680;&#65307;
</pre>
</div>

<p>
<b>编译安装内核实战案例</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;&#20381;&#36182;
</span>[root@centos8 ~]#yum -y install gcc make ncurses-devel flex bison openssl-devel elfutils-libelf-devel
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#19979;&#36733;&#20869;&#26680;
</span>[root@centos8 ~]#tar xf linux-5.6.12.tar.xz -C /usr/local/src
[root@centos8 ~]#cd /usr/local/src
[root@centos8 ~]#ln -sv linux-5.6.12 linux

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32534;&#35793;
</span>[root@centos8 ~]#cd /usr/src/linux
[root@centos8 linux]#cp /boot/config-$(uname -r)   ./.config
[root@centos8 linux]#vim .config 
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#19979;&#38754;&#20004;&#34892;&#65292;CentOS7&#26080;&#38656;&#20462;&#25913;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">CONFIG_MODULE_SIG is not set
</span><span style="color: #a0522d;">CONFIG_SYSTEM_TRUSTED_KEYS</span>=<span style="color: #8b2252;">""</span>

[root@centos8 linux]#make help
[root@centos8 linux]#make menuconfig  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22823;&#31383;&#21475;&#25165;&#33021;&#26174;&#31034;
</span>[root@centos8 linux]#time make -j $(nproc)  <span style="color: #b22222;"># </span><span style="color: #b22222;">nproc &#33719;&#21462;CPU&#20010;&#25968;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#20004;&#27493;&#23454;&#29616;&#65306;make -j 2 bzImage ; make -j 2 modules
</span>......
 LD [M] sound/xen/snd_xen_front.ko
 LD [M] virt/lib/irqbypass.ko

real 82m52.128s
user 133m37.982s
sys 25m46.311s
[root@centos8 linux]#pwd
/usr/local/src/linux
[root@centos8 linux]#du -sh .
15G .
[root@centos8 linux]#make modules_install
[root@centos8 linux]#ls /lib/modules
4.18.0-147.el8.x86_64  5.6.12-cuilinux-6.6.6
[root@centos8 linux]#du -sh /lib/modules/5.6.12-cuilinux-6.6.6/
3.5G /lib/modules/5.6.12-cuilinux-6.6.6/

[root@centos8 linux]#make install  <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#20250;&#33258;&#21160;&#20462;&#25913;grub&#20449;&#24687;
</span>[root@centos8 linux]#ls /boot
System.map-4.18.0-147.el8.x86_64
System.map-5.6.12-cuilinux-6.6.6
vmlinuz-5.6.12-cuilinux-6.6.6

[root@centos8 ~]#ls /boot/loader/entries/ 
5b85fc7444b240a992c42ce2a9f65db5-0-rescue.conf
5b85fc7444b240a992c42ce2a9f65db5-5.6.12-cuilinux-6.6.6.conf
[root@centos8 ~]#cat /boot/loader/entries/5b85fc7444b240a992c42ce2a9f65db5-5.6.12-cuilinux-6.6.6.conf 
title CentOS Linux (5.6.12-cuilinux-6.6.6) 8 (Core)
version 5.6.12-cuilinux-6.6.6
linux /vmlinuz-5.6.12-cuilinux-6.6.6
initrd /initramfs-5.6.12-cuilinux-6.6.6.img $<span style="color: #a0522d;">tuned_initrd</span>
options $<span style="color: #a0522d;">kernelopts</span> $<span style="color: #a0522d;">tuned_params</span>
id centos-20200513060531-5.6.12-cuilinux-6.6.6
grub_users $<span style="color: #a0522d;">grub_users</span>
grub_arg --unrestricted
grub_class kernel

[root@centos8 ~]#reboot 
[root@centos8 ~]#uname -r
5.6.12-cuilinux-6.6.6
</pre>
</div>


<figure id="org7f00af4">
<img src="./images/image-20210120113001460.png" alt="image-20210120113001460.png" width="50%">

</figure>

<p>
centos7编译报错
</p>

<div class="org-src-container">
<pre class="src src-sh">cc1: error: -Werror=date-time: no option -Wdate-time
<span style="color: #b22222;"># </span><span style="color: #b22222;">4.9&#20197;&#21450;&#20043;&#21518;&#30340;gcc&#29256;&#26412;&#20013;&#25165;&#26377;&#36825;&#20004;&#20010;&#36873;&#39033;&#65292;&#22914;&#26524;&#20320;&#22312;gcc&#29256;&#26412;&#23567;&#20110;4.9&#30340;&#31995;&#32479;&#19978;&#32534;&#35793;&#65292;&#27604;&#22914;&#22312;centos7.2&#31995;&#32479;&#20013;&#65292;centos&#20013;&#40664;&#35748;&#30340;gcc&#29256;&#26412;&#26159;4.8.5&#65292;&#32534;&#35793;&#26102;&#23601;&#20250;&#25253;"cc1: &#38169;&#35823;&#65306;-Werror=date-time&#65306;&#27809;&#26377;&#36873;&#39033; -Wdate-time"&#38169;&#35823;&#65292;&#25152;&#20197;&#36825;&#31181;&#35299;&#20915;&#26041;&#27861;&#22914;&#26524;&#21482;&#26159;&#20351;&#29992;4.9&#20197;&#19978;&#30340;gcc&#29256;&#26412;&#26159;&#27809;&#26377;&#38382;&#39064;&#30340;&#65307;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;1 &#21319;&#32423;gcc 4.9
</span>yum install bzip2 -y
wget -P /usr/src https://mirrors.aliyun.com/gnu/gcc/gcc-10.2.0/gcc-10.2.0.tar.gz
<span style="color: #483d8b;">cd</span> /usr/src &amp;&amp; tar -xzvf gcc-10.2.0.tar.gz
<span style="color: #483d8b;">cd</span> gcc-10.2.0/ &amp;&amp; ./contrib/download_prerequisites <span style="color: #b22222;"># </span><span style="color: #b22222;">&#37197;&#32622;&#20381;&#36182;&#39033;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#19968;&#27493;&#21487;&#33021;&#22269;&#20869;&#20250;&#31561;&#24453;&#27604;&#36739;&#20037;&#65292;&#32784;&#24515;&#31561;&#24453;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#25253;&#38169;&#20854;&#20182;&#25991;&#20214;&#19981;&#33021;&#19979;&#36733;&#65292;&#21435;https://gcc.gnu.org/pub/gcc/infrastructure/&#19979;&#36733;&#23545;&#24212;&#25991;&#20214;&#65292;&#22797;&#21046;&#21040;/usr/src/gcc-10.2.0&#21363;&#21487;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#23433;&#35013;&#25991;&#20214;&#22841;&#21644;&#32534;&#35793;&#25991;&#20214;&#22841;
</span>mkdir /usr/lib/gcc/x86_64-redhat-linux/10.2.0
mkdir /usr/src/gcc-build-10.2.0

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37197;&#32622;&#23433;&#35013;&#25991;&#20214;
</span><span style="color: #483d8b;">cd</span> /usr/src/gcc-10.2.0
./configure --prefix=/usr/lib/gcc/x86_64-redhat-linux/10.2.0/ --enable-checking=release --enable-languages=c,c++ --disable-multilib

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25191;&#34892;&#32534;&#35793;&#24182;&#23433;&#35013;(&#32534;&#35793;&#38656;&#35201;2-3&#23567;&#26102;&#65292;&#35831;&#32784;&#24515;&#31561;&#24453;)
</span><span style="color: #483d8b;">time</span> make -j $(nproc) &amp;&amp; make install

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22791;&#20221;&#21407;gcc&#24182;&#38142;&#25509;&#26032;gcc
</span>mv /usr/bin/gcc /usr/bin/gcc-4.8.5
mv /usr/bin/g++ /usr/bin/g++-4.8.5
alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.8.5 88 --slave /usr/bin/g++ g++ /usr/bin/g++-4.8.5
alternatives --install /usr/bin/gcc gcc /usr/lib/gcc/x86_64-redhat-linux/10.2.0/bin/x86_64-pc-linux-gnu-gcc 99 --slave /usr/bin/g++ g++ /usr/lib/gcc/x86_64-redhat-linux/10.2.0/bin/x86_64-pc-linux-gnu-g++
alternatives --config gcc

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#35810;&#29256;&#26412;
</span>gcc -v
g++ -v

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#20986;&#29616;&#38169;&#35823;
</span>/lib64/libstdc++.so.6: version <span style="color: #ff00ff;">`GLIBCXX_3.4.21' not found
/lib64/libstdc++.so.6: version `</span>GLIBCXX_3.4.22<span style="color: #8b2252;">' not found
#&#25191;&#34892;&#38142;&#25509;&#26032;&#30340;libstdc++.so.6&#24211;&#25991;&#20214;
rm -f /usr/lib64/libstdc++.so.6
ln -s /usr/lib/gcc/x86_64-redhat-linux/10.2.0/lib64/libstdc++.so.6 /usr/lib64/libstdc++.so.6
#&#21487;&#20197;&#29992;&#20197;&#19979;&#25351;&#20196;&#26597;&#30475;&#30446;&#21069;&#21253;&#21547;&#21738;&#20123;&#24211;
strings /usr/lib64/libstdc++.so.6 | grep GLIBC</span>
</pre>
</div>

<p>
<b>内核编译说明</b>
</p>

<p>
1.配置内核选项 
</p>

<p>
支持“更新”模式进行配置：make help 
</p>

<ol class="org-ol">
<li>make config：基于命令行以遍历的方式配置内核中可配置的每个选项</li>
<li>make menuconfig：基于curses的文本窗口界面</li>
<li>make gconfig：基于GTK(GNOME）环境窗口界面</li>
<li>make xconfig：基于QT(KDE)环境的窗口界面</li>
</ol>

<p>
支持“全新配置”模式进行配置 
</p>
<ol class="org-ol">
<li>make defconfig：基于内核为目标平台提供的“默认”配置进行配置</li>
<li>make allyesconfig: 所有选项均回答为“yes“</li>
<li>make allnoconfig: 所有选项均回答为“no“</li>
</ol>


<p>
2.编译内核
</p>

<ul class="org-ul">
<li>全编译:</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">make [-j <span style="color: #b22222;">#</span><span style="color: #b22222;">]</span>
</pre>
</div>

<ul class="org-ul">
<li>编译内核的一部分功能：</li>
</ul>

<p>
(a) 只编译某子目录中的相关代码
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /usr/src/linux; make dir/
</pre>
</div>

<p>
(b) 只编译一个特定的模块
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /usr/src/linux; make dir/file.ko
</pre>
</div>

<p>
范例：只为e1000编译驱动：
</p>

<div class="org-src-container">
<pre class="src src-sh">make drivers/net/ethernet/intel/e1000/e1000.ko
</pre>
</div>

<p>
3 交叉编译内核
</p>

<p>
编译的目标平台与当前平台不相同 make ARCH=arch_name
</p>

<p>
要获取特定目标平台的使用帮助 make ARCH=arch_name help
</p>

<p>
示例：
</p>

<div class="org-src-container">
<pre class="src src-sh">make <span style="color: #a0522d;">ARCH</span>=arm help
</pre>
</div>

<p>
4 重新编译需要事先清理操作
</p>

<div class="org-src-container">
<pre class="src src-sh">make clean&#65306;&#28165;&#29702;&#22823;&#22810;&#25968;&#32534;&#35793;&#29983;&#25104;&#30340;&#25991;&#20214;&#65292;&#20294;&#20250;&#20445;&#30041;.config&#25991;&#20214;&#31561;
make mrproper: &#28165;&#29702;&#25152;&#26377;&#32534;&#35793;&#29983;&#25104;&#30340;&#25991;&#20214;&#12289;config&#21450;&#26576;&#20123;&#22791;&#20221;&#25991;&#20214;
make distclean&#65306;&#21253;&#21547; make mrproper,&#24182;&#28165;&#29702;patches&#20197;&#21450;&#32534;&#36753;&#22120;&#22791;&#20221;&#25991;&#20214;
</pre>
</div>

<p>
<b>卸载内核</b>
</p>

<ul class="org-ul">
<li>删除/usr/src/linux/目录下不需要的内核源码</li>
<li>删除/lib/modules/目录下不需要的内核库文件</li>
<li>删除/boot目录下启动的内核和内核映像文件</li>
<li>更改grub的配置文件，删除不需要的内核启动列表 grub2-mkconfig -o
/boot/grub2/grub.cfg</li>
<li>CentOS 8 还需要删除
/boot/loader/entries/5b85fc7444b240a992c42ce2a9f65db5-新内核版 本.conf</li>
</ul>
</div>
</div>
</section>
<section id="outline-container-h:332c7b43-6385-41d2-9f54-965a542e9c76" class="outline-2">
<h2 id="h:332c7b43-6385-41d2-9f54-965a542e9c76">Busybox</h2>
<div class="outline-text-2" id="text-h:332c7b43-6385-41d2-9f54-965a542e9c76">
</div>
<div id="outline-container-h:a1d005de-1031-4f4c-afcd-6d4da7b3f72a" class="outline-3">
<h3 id="h:a1d005de-1031-4f4c-afcd-6d4da7b3f72a">Busybox介绍</h3>
<div class="outline-text-3" id="text-h:a1d005de-1031-4f4c-afcd-6d4da7b3f72a">
<p>
Busybox 最初是由 Bruce Perens 在 1996 年为 Debian GNU/Linux安装盘编写
的。其目标是在一张软盘(存储空间只有1MB多)上创建一个GNU/Linux系统，可以
用作安装盘和急救盘
</p>

<p>
Busybox 是一个开源项目，遵循GPL v2协议。Busybox将众多的UNIX命令集合进
一个很小的可执行程序中，可以用来替代GNU fileutils、shellutils等工具集。
Busybox中各种命令与相应的GNU工具相比，所能提供的选项比较少，但是也足够
一般的应用了。Busybox主要用于嵌入式系统
</p>

<p>
Busybox 是一个集成了三百多个最常用Linux命令和工具的软件。BusyBox包含了
一些简单的工具，例如ls、cat和echo等等，还包含了一些更大、更复杂的工具，
例grep、find、mount以及telnet。有些人将BusyBox 称为 Linux工具里的瑞士
军刀。简单的说BusyBox就好像是个大工具箱，它集成压缩了Linux的许多工具和
命令，也包含了 Android 系统的自带的shell
</p>

<p>
定制小型的Linux操作系统：linux内核+busybox
</p>

<p>
官方网站：<a href="https://busybox.net/">https://busybox.net/</a>
</p>
</div>
</div>
<div id="outline-container-h:ca4d2c03-5a53-4e61-b59e-1ed6b628baec" class="outline-3">
<h3 id="h:ca4d2c03-5a53-4e61-b59e-1ed6b628baec">Busybox使用</h3>
<div class="outline-text-3" id="text-h:ca4d2c03-5a53-4e61-b59e-1ed6b628baec">
<p>
busybox 的编译过程与Linux内核的编译类似
</p>

<p>
busybox的使用有三种方式：
</p>

<ul class="org-ul">
<li>busybox后直接跟命令，如 busybox ls</li>
<li>直接将busybox重命名，如 cp busybox tar</li>
<li>创建符号链接，如 ln -s busybox rm</li>
</ul>

<p>
busybox的安装
</p>

<p>
以上方法中，第三种方法最方便，但为busybox中每个命令都创建一个软链接，
相当费事，busybox提供自动方法：busybox编译成功后，执行make install,则
会产生一个_install目录，其中包含了busybox及每个命令的软链接
</p>

<p>
编译Busybox
</p>
</div>
</div>
<div id="outline-container-h:80f0d7a7-d098-4aee-9bd1-448f8e6068fe" class="outline-3">
<h3 id="h:80f0d7a7-d098-4aee-9bd1-448f8e6068fe">busybox编译安装</h3>
<div class="outline-text-3" id="text-h:80f0d7a7-d098-4aee-9bd1-448f8e6068fe">
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#yum -y install   gcc gcc-c++ glibc glibc-devel make pcre pcredevel openssl openssl-devel systemd-devel zlib-devel glibc-static ncurses-devel

[root@centos7 ~]#wget https://busybox.net/downloads/busybox-1.31.1.tar.bz2

[root@centos7 ~]#tar xvf busybox-1.31.1.tar.bz2 
[root@centos7 ~]#cd busybox-1.31.1/
[root@centos7 busybox-1.31.1]#make menuconfig 
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25353;&#19979;&#38754;&#36873;&#25321;&#65292;&#25226;busybox&#32534;&#35793;&#20063;&#38745;&#24577;&#20108;&#36827;&#21046;&#12289;&#19981;&#29992;&#20849;&#20139;&#24211;:Settings --&gt;Build Options --&gt;[*] Build static binary (no shared libs)
</span>
[root@centos7 busybox-1.31.1]#make 
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#20986;&#38169;&#65292;&#25191;&#34892;make clean&#21518;&#65292;&#37325;&#26032;&#25191;&#34892;&#19978;&#38754;&#21629;&#20196;
</span>[root@centos7 busybox-1.31.1]#ls 
[root@centos7 busybox-1.31.1]#make install 
[root@centos7 busybox-1.31.1]#pwd
/root/busybox-1.31.1
[root@Centos7 busybox-1.31.1]#ls
applets                 debianutils  loginutils              qemu_multiarch_testing
applets_sh              docs         mailutils               README
arch                    e2fsprogs    Makefile                runit
archival                editors      Makefile.custom         scripts
AUTHORS                 examples     Makefile.flags          selinux
busybox                 findutils    Makefile.help           shell
busybox.links           include      make_single_applets.sh  size_single_applets.sh
busybox_unstripped      init         miscutils               sysklogd
busybox_unstripped.map  _install     modutils                testsuite
busybox_unstripped.out  INSTALL      networking              TODO
Config.in               klibc-utils  NOFORK_NOEXEC.lst       TODO_unicode
configs                 libbb        NOFORK_NOEXEC.sh        util-linux
console-tools           libpwdgrp    printutils
coreutils               LICENSE      procps
[root@Centos7 busybox-1.31.1]#ll busybox -h
-rwxr-xr-x 1 root root 2.6M May 14 09:35 busybox

[root@Centos7 busybox-1.31.1]#ls _install/
bin  linuxrc  sbin  usr
[root@Centos7 busybox-1.31.1]#ls _install/bin
arch     cttyhack       fdflush   kbd_mode  mknod       ping           run-parts     tar
ash      date           fgrep     kill      mktemp      ping6          scriptreplay  touch
base64   dd             fsync     link      more        pipe_progress  sed           true
busybox  df             getopt    linux32   mount       printenv       setarch       umount
cat      dmesg          grep      linux64   mountpoint  ps             setpriv       uname
chattr   dnsdomainname  gunzip    ln        mpstat      pwd            setserial     usleep
chgrp    dumpkmap       gzip      login     mt          reformime      sh            vi
chmod    echo           hostname  ls        mv          resume         sleep         watch
chown    ed             hush      lsattr    netstat     rev            stat          zcat
conspy   egrep          ionice    lzop      nice        rm             stty
cp       false          iostat    makemime  nuke        rmdir          su
cpio     fatattr        ipcalc    mkdir     pidof       rpm            sync

[root@Centos7 busybox-1.31.1]#find _install/ -type l |wc -l
396
[root@Centos7 busybox-1.31.1]#du -sh _install/
2.6M    _install/

[root@Centos7 busybox-1.31.1]#mkdir /mnt/sysroot/
[root@Centos7 busybox-1.31.1]#cp -a _install/* /mnt/sysroot/
</pre>
</div>



<figure id="org827c42f">
<img src="./images/img_20241001_204253.png" alt="img_20241001_204253.png" width="50%">

</figure>
</div>
</div>
</section>
<section id="outline-container-h:b31b2d22-3823-4f22-8e68-9cfbf9c37a31" class="outline-2">
<h2 id="h:b31b2d22-3823-4f22-8e68-9cfbf9c37a31">自制linux系统</h2>
<div class="outline-text-2" id="text-h:b31b2d22-3823-4f22-8e68-9cfbf9c37a31">
</div>
<div id="outline-container-h:1ef25d2b-9c84-42c9-aaa9-581a8435956d" class="outline-3">
<h3 id="h:1ef25d2b-9c84-42c9-aaa9-581a8435956d">Centos6自制linux系统</h3>
<div class="outline-text-3" id="text-h:1ef25d2b-9c84-42c9-aaa9-581a8435956d">
<p>
<b>1 分区并创建文件系统</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#20004;&#20010;&#24517;&#35201;&#30340;&#20998;&#21306;,/dev/sdb1&#23545;&#24212;/boot   /dev/sdb2&#23545;&#24212;&#26681; /
</span>[root@centos6 ~]#echo -e <span style="color: #8b2252;">'n\np\n1\n\n+1G\nw\n'</span> | fdisk /dev/sdb
[root@centos6 ~]#echo -e <span style="color: #8b2252;">'n\np\n2\n\n\n\nw\n'</span> | fdisk /dev/sdb
[root@centos6 ~]#mkfs.ext4 /dev/sdb1
[root@centos6 ~]#mkfs.ext4 /dev/sdb2
</pre>
</div>

<p>
<b>2 挂载boot</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23376;&#30446;&#24405;&#24517;&#39035;&#20026;boot
</span>[root@centos6 ~]#mkdir /mnt/boot
[root@centos6 ~]#mount /dev/sdb1 /mnt/boot
</pre>
</div>

<p>
<b>3 安装grub</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#grub-install --root-directory=/mnt/ /dev/sdb
</pre>
</div>

<p>
<b>4 准备内核和initramfs文件</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#cp /boot/vmlinuz-2.6.32-754.el6.x86_64 /mnt/boot/vmlinuz
[root@centos6 ~]#cp /boot/initramfs-2.6.32-754.el6.x86_64.img /mnt/boot/initramfs.img
</pre>
</div>

<p>
<b>5 建立grub.conf</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#cat /mnt/boot/grub/grub.conf
<span style="color: #a0522d;">default</span>=0
<span style="color: #a0522d;">timeout</span>=5
title cui linux 
<span style="color: #0000ff;">root</span> (hd0,0)
kernel /vmlinuz <span style="color: #a0522d;">root</span>=/dev/sda2 <span style="color: #a0522d;">selinux</span>=0 <span style="color: #a0522d;">init</span>=/bin/bash
initrd /initramfs.img

<span style="color: #b22222;"># </span><span style="color: #b22222;">root=/dev/sda2 &#23545;&#20110;&#35201;&#21551;&#21160;&#30340;&#31995;&#32479;&#32780;&#35328;
</span>[root@centos6 ~]#tree /mnt/boot
/mnt/boot
&#9500;&#9472;&#9472; grub
&#9474;   &#9500;&#9472;&#9472; device.map
&#9474;   &#9500;&#9472;&#9472; e2fs_stage1_5
&#9474;   &#9500;&#9472;&#9472; fat_stage1_5
&#9474;   &#9500;&#9472;&#9472; ffs_stage1_5
&#9474;   &#9500;&#9472;&#9472; grub.conf
&#9474;   &#9500;&#9472;&#9472; iso9660_stage1_5
&#9474;   &#9500;&#9472;&#9472; jfs_stage1_5
&#9474;   &#9500;&#9472;&#9472; minix_stage1_5
&#9474;   &#9500;&#9472;&#9472; reiserfs_stage1_5
&#9474;   &#9500;&#9472;&#9472; stage1
&#9474;   &#9500;&#9472;&#9472; stage2
&#9474;   &#9500;&#9472;&#9472; ufs2_stage1_5
&#9474;   &#9500;&#9472;&#9472; vstafs_stage1_5
&#9474;   &#9492;&#9472;&#9472; xfs_stage1_5
&#9500;&#9472;&#9472; initramfs-2.6.32-754.el6.x86_64.img
&#9500;&#9472;&#9472; lost+found
&#9492;&#9472;&#9472; vmlinuz.img

2 directories, 16 files
</pre>
</div>

<p>
<b>6 准备根下面相关程序和库</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#mkdir /mnt/sysroot
[root@centos6 ~]#mount /dev/sdb2   /mnt/sysroot
[root@centos6 ~]#mkdir &#8211;pv /mnt/sysroot/{boot,dev,sys,proc,etc,lib,lib64,bin,sbin,tmp,var,usr,opt,home,root,mnt,media}
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;bash&#31561;&#21629;&#20196;&#21644;&#30456;&#20851;&#24211;&#25991;&#20214;&#65292;&#22914;&#65306;
</span>bash,ifconfig,insmod,ping,mount,ls,cat,df,lsblk,blkid,tree,fdisk

[root@centos6 ~]#mkdir /mnt/sysroot/{dev,proc,etc,sys,lib,home,root}
<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> $(ldd /bin/bash | grep -o <span style="color: #8b2252;">'/[^[:space:]]\+[0-9]\&gt;'</span>); <span style="color: #a020f0;">do</span> cp $<span style="color: #a0522d;">i</span> /mnt/sysroot/lib64 ;<span style="color: #a020f0;">done</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20934;&#22791;&#32593;&#21345;&#39537;&#21160;
</span>[root@centos6 ~]#ethtool -i eth0
driver: e1000
version: 7.3.21-k8-NAPI
firmware-version: 
bus-info: 0000:02:01.0
supports-statistics: yes
supports-test: yes
supports-eeprom-access: yes
supports-register-dump: yes
supports-priv-flags: no
[root@centos6 ~]#modinfo e1000
filename:/lib/modules/2.6.32-754.el6.x86_64/kernel/drivers/net/e1000/e1000.ko

[root@centos6 ~]#cp /lib/modules/2.6.32-754.el6.x86_64/kernel/drivers/net/e1000/e1000.ko /mnt/sysroot/lib/

[root@centos6 ~]#chroot /mnt/sysroot/
bash-4.1# pwd
/
</pre>
</div>

<p>
<b>7 准备新的虚拟机</b>
</p>

<p>
将前一虚拟机sdb硬盘对应的vmdk文件增加进去，删除原有磁盘，开机启动
</p>


<figure id="org57f0622">
<img src="./images/image-20210120112617421.png" alt="image-20210120112617421.png" width="50%">

</figure>



<figure id="org31bbca2">
<img src="./images/img_20241001_204653.png" alt="img_20241001_204653.png" width="50%">

</figure>



<figure id="org7bad1a4">
<img src="./images/img_20241001_204612.png" alt="img_20241001_204612.png" width="50%">

</figure>



<figure id="orgd9f9da9">
<img src="./images/image-20210120112739319.png" alt="image-20210120112739319.png" width="50%">

</figure>
</div>
</div>
</section>
<section id="outline-container-h:1c4bc5c2-f8ee-43c8-b2fb-569c58d50dc6" class="outline-2">
<h2 id="h:1c4bc5c2-f8ee-43c8-b2fb-569c58d50dc6">/proc 其他文件</h2>
<div class="outline-text-2" id="text-h:1c4bc5c2-f8ee-43c8-b2fb-569c58d50dc6">
<p>
<a href="linux-proc.html">/proc</a>
</p>
</div>
</section>
<section id="outline-container-h:1dc55300-5491-499f-87d4-abaa4325afa9" class="outline-2">
<h2 id="h:1dc55300-5491-499f-87d4-abaa4325afa9">Linux kernel map</h2>
<div class="outline-text-2" id="text-h:1dc55300-5491-499f-87d4-abaa4325afa9">
<p>
这幅图是一张 Linux 内核地图（Linux Kernel Map），由 Costa Shulyupin 制作并维护，是一个系统性地展示 Linux 内核架构的可视化项目。它不仅是技术图谱，更是一个交互式学习工具，帮助你理解 Linux 内核的组成、模块间的关联与数据流动。
</p>


<figure id="orgce73c24">
<img src="./images/LKM.svg" alt="LKM.svg" class="org-svg" width="100%">

</figure>

<ul class="org-ul">
<li>纵向：内核功能层</li>
<li>横向：内核子系统</li>
</ul>

<p>
为什么你应该关注? 
</p>
<ol class="org-ol">
<li>学习路径：如果你是内核新手，可以沿着图的结构逐步学习，从用户接口到底层驱动。</li>
<li>调试与调优：了解模块间的依赖和数据流，有助于定位性能瓶颈或系统问题。</li>
<li>架构理解：无论你是开发者、运维还是嵌入式工程师，都能从中获得对 Linux 内核整体架构的直观认识。</li>
</ol>

<p>
链接：
</p>
<ul class="org-ul">
<li><a href="https://github.com/makelinux/linux_kernel_map">github: linux_kernel_map</a></li>
<li><a href="https://makelinux.github.io/kernel/map/">在线交互</a></li>
</ul>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
