<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>scripts-kubernetes</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">scripts-kubernetes</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org9a9bd04">小脚本</a>
<ul>
<li><a href="#org80274fe">工具1</a></li>
<li><a href="#org9fb2bc2">工具2</a></li>
<li><a href="#org6e42449">小工具3</a></li>
<li><a href="#org92bd861">定时修改Hpa副本数</a></li>
<li><a href="#orgf70ba6d">bash脚本监控</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../index.html">Script</a></li>
</ul>
<section id="outline-container-org9a9bd04" class="outline-2">
<h2 id="org9a9bd04">小脚本</h2>
<div class="outline-text-2" id="text-org9a9bd04">
</div>
<div id="outline-container-org80274fe" class="outline-3">
<h3 id="org80274fe">工具1</h3>
<div class="outline-text-3" id="text-org80274fe">
<p>
服务操作，适合不熟悉命令行的人
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir ~/bin/
<span style="color: #483d8b;">cd</span> ~/bin
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">cat &lt;&lt;\EOF&gt; podnamespace
<span style="color: #ffa54f;">#!/bin/bash</span>
<span style="color: #ffa54f;">#</span>
<span style="color: #ffa54f;">if [ $# -ge 1 ]; then</span>
<span style="color: #ffa54f;">   [[ $2 =~ "kubeconfig" ]] &amp;&amp; config=$2 ||:</span>
<span style="color: #ffa54f;">   n_list=$(</span><span style="color: #ff00ff;">kubectl $config  get ns -o jsonpath='{.items[*].metadata.name}'|tr ' ' '\n'|sort |awk '{printf("%-4d%s\n", NR, $0</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">   echo -e "\e[31mPlease execute the command:\e[0m \e[1;32m source podnamespace [anyone]\e[0m"</span>
<span style="color: #ffa54f;">   echo "${n_list}"</span>
<span style="color: #ffa54f;">   echo -n "Choose a namespace: "</span>
<span style="color: #ffa54f;">   read no</span>
<span style="color: #ffa54f;">   namespace=$(</span><span style="color: #ff00ff;">echo "${n_list}"| awk '{print $2}'|sed -n "${no}p"</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">   export namespace</span>
<span style="color: #ffa54f;">   echo Namespace: $namespace</span>
<span style="color: #ffa54f;">fi</span>

<span style="color: #ffa54f;">[ $# -eq 0 ] &amp;&amp; {</span>
<span style="color: #ffa54f;">namespace=monitoring</span>
<span style="color: #ffa54f;">export namespace</span>
<span style="color: #ffa54f;">#p=$(</span><span style="color: #ff00ff;">ps -fp $(echo $$</span><span style="color: #ffa54f;">) |sed '1d'|awk '{print $3}')</span>
<span style="color: #ffa54f;">#echo -e "\e[31mSwitching Namespaces:\e[0m \e[1;32m source podnamespace [anyone]\e[0m" &gt;/proc/$p/fd/2</span>
<span style="color: #ffa54f;">echo Namespace: $namespace</span>
<span style="color: #ffa54f;">} || :</span>
<span style="color: #ffa54f;">EOF</span>

cat &lt;&lt;\EOF&gt; podlist
<span style="color: #ffa54f;">#!/bin/bash</span>
<span style="color: #ffa54f;">: ${namespace:=$(</span><span style="color: #ff00ff;">podnamespace|awk '/Namespace: /{print $2}'</span><span style="color: #ffa54f;">)}</span>
<span style="color: #ffa54f;">app_name=$1</span>

<span style="color: #ffa54f;"># kubectl -n ${namespace} get pods -o wide|grep ${app_name}</span>
<span style="color: #ffa54f;">[ -z "${app_name}" ] &amp;&amp; kubectl -n ${namespace} get pods -o wide || { </span>
<span style="color: #ffa54f;">pods=$(</span><span style="color: #ff00ff;">kubectl -n ${namespace} get pods -o wide|grep ${app_name}|awk '{printf("%-4d%s\t%s\t%s\t%s\t%s\t%s\n", NR, $1, $2, $3, $5, $6, $7</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">echo "${pods}"</span>
<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">EOF</span>

cat &lt;&lt;\EOF&gt; poddesc
<span style="color: #ffa54f;">#!/bin/bash</span>
<span style="color: #ffa54f;">: ${namespace:=$(</span><span style="color: #ff00ff;">podnamespace|awk '/Namespace: /{print $2}'</span><span style="color: #ffa54f;">)}</span>
<span style="color: #ffa54f;">app_name=$1</span>

<span style="color: #ffa54f;">stty erase ^H</span>
<span style="color: #ffa54f;"># kubectl -n ${namespace} get pods -o wide|grep ${app_name}</span>
<span style="color: #ffa54f;">pods=$(</span><span style="color: #ff00ff;">kubectl -n ${namespace} get pods -o wide|grep -E ${app_name}|awk '{printf("%-4d%s\t%s\t%s\t%s\t%s\t%s\n", NR, $1, $2, $3, $5, $6, $7</span><span style="color: #ffa54f;">)}')</span>

<span style="color: #ffa54f;">echo "${pods}"</span>
<span style="color: #ffa54f;">echo -n "Choose a pod: "</span>
<span style="color: #ffa54f;">read no</span>
<span style="color: #ffa54f;">pod=$(</span><span style="color: #ff00ff;">echo "${pods}"|awk '{print $2}'|sed -n "${no}p"</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">kubectl -n ${namespace} describe po/"${pod}"</span>
<span style="color: #ffa54f;">EOF</span>


cat &lt;&lt;\EOF&gt; podlog
<span style="color: #ffa54f;">#!/bin/bash</span>
<span style="color: #ffa54f;">: ${namespace:=$(</span><span style="color: #ff00ff;">podnamespace|awk '/Namespace: /{print $2}'</span><span style="color: #ffa54f;">)}</span>
<span style="color: #ffa54f;">app_name=$1</span>

<span style="color: #ffa54f;"># kubectl -n ${namespace} get pods -o wide|grep ${app_name}</span>
<span style="color: #ffa54f;">pods=$(</span><span style="color: #ff00ff;">kubectl -n ${namespace} get pods -o wide|grep ${app_name}|awk '{printf("%-4d%s\t%s\t%s\t%s\t%s\n", NR, $1, $3, $5, $6, $7</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">echo "${pods}"</span>
<span style="color: #ffa54f;">echo -n "Choose a pod: "</span>
<span style="color: #ffa54f;">read no</span>
<span style="color: #ffa54f;">pod=$(</span><span style="color: #ff00ff;">echo "${pods}"|awk '{print $2}'|sed -n "${no}p"</span><span style="color: #ffa54f;">)</span>

<span style="color: #ffa54f;">if ! kubectl  get po -n $namespace $pod -o jsonpath="{.spec['containers'][1].name}" &amp;&gt;/dev/null; then</span>
<span style="color: #ffa54f;">  kubectl -n ${namespace} logs -f --tail=50 "${pod}"</span>
<span style="color: #ffa54f;">else</span>
<span style="color: #ffa54f;">  cat -n &lt;(kubectl  get po -n $namespace $pod -o jsonpath="{.spec['containers'][*].name}"|tr ' ' '\n')</span>
<span style="color: #ffa54f;">  echo</span>
<span style="color: #ffa54f;">  read -p "Please input container number: " no</span>
<span style="color: #ffa54f;">  container_name=$(</span><span style="color: #ff00ff;">kubectl -n $namespace get po $pod -o jsonpath="{.spec.containers[$[no-1]].name}"</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">  kubectl -n ${namespace} logs -f --tail=50 "${pod}" -c ${container_name} </span>
<span style="color: #ffa54f;">fi</span>
<span style="color: #ffa54f;">EOF</span>


cat &lt;&lt;\EOF&gt; podexec
<span style="color: #ffa54f;">#!/bin/bash</span>
<span style="color: #ffa54f;">: ${namespace:=$(</span><span style="color: #ff00ff;">podnamespace|awk '/Namespace: /{print $2}'</span><span style="color: #ffa54f;">)}</span>
<span style="color: #ffa54f;">app_name=$1</span>

<span style="color: #ffa54f;"># kubectl -n ${namespace} get pods -o wide|grep ${app_name}</span>
<span style="color: #ffa54f;">pods=$(</span><span style="color: #ff00ff;">kubectl -n ${namespace} get pods -o wide|grep ${app_name}|awk '{printf("%-4d%s\t%s\t%s\t%s\t%s\t%s\n", NR, $1, $2, $3, $5, $6, $7</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">echo "${pods}"</span>
<span style="color: #ffa54f;">echo -n "Choose a pod: "</span>
<span style="color: #ffa54f;">read no</span>
<span style="color: #ffa54f;">pod=$(</span><span style="color: #ff00ff;">echo "${pods}"|awk '{print $2}'|sed -n "${no}p"</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">if ! kubectl  get po -n $namespace $pod -o jsonpath="{.spec['containers'][1].name}" &amp;&gt;/dev/null; then </span>
<span style="color: #ffa54f;">  kubectl -n ${namespace} exec -ti "${pod}" -- bash  2&gt;/dev/null || kubectl -n ${namespace} exec -it $pod -- sh</span>
<span style="color: #ffa54f;">else</span>
<span style="color: #ffa54f;">  cat -n &lt;(kubectl  get po -n $namespace $pod -o jsonpath="{.spec['containers'][*].name}"|tr ' ' '\n')</span>
<span style="color: #ffa54f;">  echo</span>
<span style="color: #ffa54f;">  read -p "Please input container number: " no </span>
<span style="color: #ffa54f;">  container_name=$(</span><span style="color: #ff00ff;">kubectl -n $namespace get po $pod -o jsonpath="{.spec.containers[$[no-1]].name}"</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">  kubectl -n ${namespace} exec -ti "${pod}" -c ${container_name}  -- bash  2&gt;/dev/null || kubectl -n ${namespace} exec -it $pod -c ${container_name} -- sh</span>
<span style="color: #ffa54f;">fi</span>
<span style="color: #ffa54f;">EOF</span>

cat &lt;&lt;\EOF&gt; poddel
<span style="color: #ffa54f;">#!/bin/bash</span>
<span style="color: #ffa54f;">: ${namespace:=$(</span><span style="color: #ff00ff;">podnamespace|awk '/Namespace: /{print $2}'</span><span style="color: #ffa54f;">)}</span>
<span style="color: #ffa54f;">app_name=$1</span>
<span style="color: #ffa54f;"># kubectl -n ${namespace} get pods -o wide|grep ${app_name}</span>
<span style="color: #ffa54f;">pods=$(</span><span style="color: #ff00ff;">kubectl -n ${namespace} get pods -o wide|grep ${app_name}|awk '{printf("%-4d%s\t%s\t%s\t%s\t%s\n", NR, $1, $3, $5, $6, $7</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">echo "${pods}"</span>
<span style="color: #ffa54f;">echo -n "Choose a pod: "</span>
<span style="color: #ffa54f;">read no</span>
<span style="color: #ffa54f;">pod=$(</span><span style="color: #ff00ff;">echo "${pods}"|awk '{print $2}'|sed -n "${no}p"</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">set -x</span>
<span style="color: #ffa54f;">kubectl -n ${namespace} delete pod/"${pod}"</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org9fb2bc2" class="outline-3">
<h3 id="org9fb2bc2">工具2</h3>
<div class="outline-text-3" id="text-org9fb2bc2">
<p>
服务操作，适合不熟悉命令行的人
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir ~/bin/
<span style="color: #483d8b;">cd</span> ~/bin
</pre>
</div>

<p>
k8s_taillog 脚本内容
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/</span><span style="color: #a020f0;">bash</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">read &#20013;&#20801;&#35768;&#36864;&#26684;&#38190;&#21024;&#38500;&#23383;&#31526;</span>
stty erase ^H
<span style="color: #a0522d;">server</span>=$<span style="color: #a0522d;">2</span>
<span style="color: #a0522d;">temp_list</span>=<span style="color: #8b2252;">"/tmp/kube_po_${RANDOM}.list"</span>
<span style="color: #a0522d;">title</span>=<span style="color: #8b2252;">"/tmp/k8s_title"</span>
<span style="color: #a0522d;">config_prod</span>=<span style="color: #8b2252;">'--kubeconfig=/root/.kube/config_prod'</span>
<span style="color: #a0522d;">config_dev</span>=<span style="color: #8b2252;">'--kubeconfig=/root/.kube/config_dev'</span>
<span style="color: #a020f0;">if </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">1</span>|grep -iq <span style="color: #8b2252;">'prod'</span>;<span style="color: #a020f0;">then</span>
   <span style="color: #a0522d;">config</span>=<span style="color: #8b2252;">"-n default $config_prod"</span>
<span style="color: #a020f0;">elif </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">1</span>|grep -iq <span style="color: #8b2252;">'dev'</span>;<span style="color: #a020f0;">then</span>
   <span style="color: #a0522d;">config</span>=<span style="color: #8b2252;">"$config_dev"</span>
<span style="color: #a020f0;">else</span>

    <span style="color: #483d8b;">echo</span> -en <span style="color: #8b2252;">"\e[31;1mERROR &#19981;&#27491;&#30830;&#30340;&#21442;&#25968;\e[0m\n\n\e[1m&#29615;&#22659;&#21442;&#25968;\e[32m&#65288;&#24517;&#36873;&#39033;&#65289; \e[0m\n"</span>
    <span style="color: #483d8b;">echo</span> -en <span style="color: #8b2252;">"\E[$[RANDOM%7+31];1m"</span>
    cat &lt;&lt;EOF
<span style="color: #ffa54f;">prod: &#27491;&#24335;&#29615;&#22659;</span>
<span style="color: #ffa54f;">dev:  &#24320;&#21457;&#29615;&#22659;</span>
<span style="color: #ffa54f;">stag: qa&#27979;&#35797;&#29615;&#22659;</span>
<span style="color: #ffa54f;">EOF</span>
    <span style="color: #483d8b;">echo</span> -en <span style="color: #8b2252;">'\E[0m'</span>

    <span style="color: #483d8b;">echo</span> -en <span style="color: #8b2252;">"\E[$[RANDOM%7+31];1m"</span>
    cat &lt;&lt;EOF
<span style="color: #ffa54f;">match &#21305;&#37197;&#26381;&#21153;&#21517;&#31216;,&#25903;&#25345;&#27169;&#31946;&#21305;&#37197;&#65288;&#21487;&#36873;&#39033;&#65289;</span>

<span style="color: #ffa54f;">Usage: $0 prod [match]</span>
<span style="color: #ffa54f;">EOF</span>
    <span style="color: #483d8b;">echo</span> -en <span style="color: #8b2252;">'\E[0m'</span>
   <span style="color: #a020f0;">exit</span> 1
<span style="color: #a020f0;">fi</span>
<span style="color: #0000ff;">print_help</span>(){
   <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">   \e[32;1mUsage:\e[0m</span>
<span style="color: #8b2252;">    \e[36;1mCheck\e[0m</span>
<span style="color: #8b2252;">    1. \e[32;1m&lt;num bash&gt;\e[0m         &#25968;&#23383;&#21518;&#21152;&#31354;&#26684;bash&#36827;&#20837;&#23481;&#22120;,&#27604;&#22914; &lt;1 bash&gt;</span>
<span style="color: #8b2252;">    ------------------------------------------------------------------------------------</span>
<span style="color: #8b2252;">    2. \e[32;1m&lt;num&gt; [line_num]\e[0m   &#30452;&#25509;&#36755;&#20837;&#23545;&#24212;&#25968;&#23383;&#22238;&#36710;&#23454;&#26102;&#36755;&#20986;&#26368;&#21518;200&#34892;&#26085;&#24535;,&#20063;&#21487;&#20197;&#25351;&#23450;&#34892;&#25968;line_num</span>
<span style="color: #8b2252;">    ------------------------------------------------------------------------------------</span>
<span style="color: #8b2252;">    3. \e[32;1m&lt;num des&gt;\e[0m           &#25968;&#23383;&#21152;des&#26597;&#30475;pod&#35814;&#32454;&#20449;&#24687;,&#27604;&#22914;&lt;1 des&gt;</span>
<span style="color: #8b2252;">    ------------------------------------------------------------------------------------</span>
<span style="color: #8b2252;">    4. \e[32;1m&lt;num MATCH&gt;\e[0m        &#25968;&#23383;&#21152;&#31354;&#26684;&#21333;&#35789;&#36827;&#34892;&#26085;&#24535;&#21305;&#37197;,&#27604;&#22914; &lt;1 ERROR&gt; &#22914;&#26524;&#21305;&#37197;&#25968;&#23383;&#38656;&#35201;&#22312;&#21305;&#37197;</span>
<span style="color: #8b2252;">                          &#30340;&#25968;&#23383;&#20004;&#36793;&#21152;&#19978;&#20013;&#25324;&#21495;&#20197;&#36991;&#20813;&#21644;&#26597;&#30475;&#26085;&#24535;&#34892;&#25968;&#20914;&#31361;&#65292;&#27604;&#22914;&#65306; &lt;1 [12345]&gt;</span>
<span style="color: #8b2252;">    ------------------------------------------------------------------------------------</span>
<span style="color: #8b2252;">    5. \e[32;1m&lt;num1,num2 [MATCH]&gt;\e[0m              &#25968;&#23383;&#29992;,&#20998;&#38548;&#21487;&#20197;&#23454;&#26102;&#26597;&#30475;&#22810;&#20010;&#23481;&#22120;&#30340;&#32858;&#21512;&#26085;&#24535;</span>
<span style="color: #8b2252;">                                        &#27604;&#22914; 1,2,3 &#26597;&#30475;1 2 3 &#19977;&#20010;&#23481;&#22120;&#30340;&#32858;&#21512;&#26085;&#24535;</span>
<span style="color: #8b2252;">                                        &#31532;&#20108;&#20010;&#21442;&#25968;&#26159;&#21487;&#36873;&#21442;&#25968;:&#21487;&#20197;&#25628;&#32034;&#21305;&#37197;&#30340;&#26085;&#24535; </span>
<span style="color: #8b2252;">    ------------------------------------------------------------------------------------</span>
<span style="color: #8b2252;">    6. \e[32;1m&lt;num_start..num_end [MATCH]&gt;\e[0m     &#25968;&#23383;&#29992;..&#20998;&#38548;&#21487;&#20197;&#23454;&#26102;&#26597;&#30475;&#24320;&#22987;&#21040;&#32467;&#23614;&#22810;&#20010;&#23481;&#22120;&#30340;&#32858;&#21512;&#26085;&#24535;</span>
<span style="color: #8b2252;">                                        &#27604;&#22914; 1..4 &#26597;&#30475;1&#21040;4&#22235;&#20010;&#23481;&#22120;&#30340;&#32858;&#21512;&#26085;&#24535;</span>
<span style="color: #8b2252;">                                        &#31532;&#20108;&#20010;&#21442;&#25968;&#26159;&#21487;&#36873;&#21442;&#25968;:&#21487;&#20197;&#25628;&#32034;&#21305;&#37197;&#30340;&#26085;&#24535; </span>
<span style="color: #8b2252;">    ------------------------------------------------------------------------------------</span>

<span style="color: #8b2252;">    \e[36;1mModify\e[0m</span>
<span style="color: #8b2252;">    1. \e[32;1m&lt;num cp&gt;\e[0m            &#25968;&#23383;&#21152;&#31354;&#26684;cp&#22797;&#21046;&#25991;&#20214;&#25110;&#32773;&#30446;&#24405;,&#27604;&#22914; &lt;1 cp&gt;</span>
<span style="color: #8b2252;">    ------------------------------------------------------------------------------------</span>
<span style="color: #8b2252;">    2. \e[32;1m&lt;num update&gt;\e[0m        &#25968;&#23383;&#21152;update,&#26356;&#26032;&#38236;&#20687;&#29256;&#26412;&#65292;&#29992;&#20110;&#26356;&#26032;&#25110;&#32773;&#22238;&#28378;</span>
<span style="color: #8b2252;">    ------------------------------------------------------------------------------------</span>
<span style="color: #8b2252;">    3. \e[32;1m&lt;num scale&gt;\e[0m         &#25968;&#23383;&#21152;scale&#65292;&#20280;&#32553;&#26381;&#21153;&#25968;&#37327;&#65292;&#35774;&#32622;&#20026;0&#20572;&#27490;&#26381;&#21153;</span>
<span style="color: #8b2252;">                           &#23545;&#20110;&#24050;&#32463;&#35774;&#32622;&#20026;0&#30340;&#26381;&#21153;&#38656;&#35201;&#36755;&#20837;  0 scale &#20877;&#36827;&#34892;&#26356;&#25913;</span>
<span style="color: #8b2252;">    ------------------------------------------------------------------------------------</span>
<span style="color: #8b2252;">    4. \e[32;1m&lt;num restart all&gt;\e[0m  &#37325;&#21551;&#25351;&#23450;&#23481;&#22120;&#30456;&#20851;&#30340;&#25152;&#26377;&#23481;&#22120;&#65292;&#28378;&#21160;&#37325;&#21551;&#19981;&#24433;&#21709;&#26381;&#21153;</span>
<span style="color: #8b2252;">    ------------------------------------------------------------------------------------</span>
<span style="color: #8b2252;">    5. \e[32;1m&lt;num restart&gt;\e[0m      &#25968;&#23383;&#21152;&#31354;&#26684;restart&#37325;&#21551;&#26381;&#21153;,&#27604;&#22914; &lt;1 restart&gt;</span>
<span style="color: #8b2252;">                          &#25968;&#23383;&#21152;&#31354;&#26684;restart force&#24378;&#21046;&#21024;&#38500;&#26381;&#21153;&#65292;&#27604;&#22914;&lt;1 restart force&gt; &#19968;&#33324;&#38271;</span>
<span style="color: #8b2252;">                          &#26102;&#38388;&#22788;&#20110;Terminal&#29366;&#24577;&#25110;&#32773;&#26080;&#27861;&#37325;&#21551;&#26102;&#20351;&#29992;</span>
<span style="color: #8b2252;">    ------------------------------------------------------------------------------------</span>

<span style="color: #8b2252;">    \e[36;1mHelp\e[0m</span>
<span style="color: #8b2252;">    1. \e[32;1m&lt;r&gt;\e[0m                &#36755;&#20837;r&#21047;&#26032;&#24403;&#21069;&#21015;&#34920;\e[0m</span>
<span style="color: #8b2252;">    ------------------------------------------------------------------------------------</span>
<span style="color: #8b2252;">    2. \e[32;1m&lt;help&gt;\e[0m             &#36755;&#20837;help&#26597;&#30475;&#24110;&#21161;&#20449;&#24687;\e[0m</span>
<span style="color: #8b2252;">    ------------------------------------------------------------------------------------</span>
<span style="color: #8b2252;">    3. \e[32;1m&lt;exit|quit&gt;\e[0m        &#36864;&#20986;\e[0m</span>
<span style="color: #8b2252;">    ------------------------------------------------------------------------------------</span>
<span style="color: #8b2252;">    4. \e[32;1m&lt;num:num [MATCH]&gt;\e[0m  &#22914;&#26524;&#26377;&#22810;&#20010;&#23481;&#22120;&#65292;&#20882;&#21495;&#21518;&#30340;&#25968;&#23383;&#26159;&#25351;&#23450;&#23481;&#22120;</span>
<span style="color: #8b2252;">    ------------------------------------------------------------------------------------</span>
<span style="color: #8b2252;">   "</span>
}
<span style="color: #0000ff;">print_list</span>(){
   <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">'&#26381;&#21153;\t&#25968;&#37327;\t&#29366;&#24577;\t&#37325;&#21551;&#27425;&#25968;\t&#21019;&#24314;&#26102;&#38388;\t&#23481;&#22120;IP\t&#23487;&#20027;&#26426;'</span> &gt; $<span style="color: #a0522d;">title</span>
   kubectl $<span style="color: #a0522d;">config</span> get po -o wide|grep -vP <span style="color: #8b2252;">'^elastic|NAME'</span>|grep -P <span style="color: #8b2252;">"$server"</span> &gt; $<span style="color: #a0522d;">temp_list</span>
   <span style="color: #a0522d;">sep</span>=$(<span style="color: #ff00ff;">printf "%140s\n"|tr ' ' '='</span>)
   cat -n $<span style="color: #a0522d;">title</span> $<span style="color: #a0522d;">temp_list</span>|awk <span style="color: #8b2252;">'{$1--;print $0}'</span> |column -t -o <span style="color: #8b2252;">'| '</span>|awk -F<span style="color: #8b2252;">'|'</span> <span style="color: #8b2252;">'BEGIN{OFS=" | "}{print $1,"\033[34;1m"$2"\033[0m",$3,$4,$5,$6,$7,$8}'</span>|sed <span style="color: #8b2252;">"1a${sep}"</span>
   <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$sep"</span>
   <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\e[1mTips: &#33050;&#26412;&#21442;&#25968;&#21487;&#30452;&#25509;&#36755;&#20986;&#21305;&#37197;&#30340;&#26381;&#21153;&#21517;&#31216;\n\t$0 [match]\e[0m"</span>
   <span style="color: #483d8b;">read</span> -p <span style="color: #8b2252;">"&#36755;&#20837;&#32534;&#21495;&#26597;&#30475;&#26085;&#24535;(&#36755;&#20837;help&#25171;&#21360;&#24110;&#21161;): "</span> num;<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\e[0m"</span>

   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24110;&#24537;&#19982;&#36864;&#20986;</span>
   <span style="color: #a020f0;">if </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qiP <span style="color: #8b2252;">'^\s*help\s*$'</span>;<span style="color: #a020f0;">then</span>
      print_help
      <span style="color: #483d8b;">read</span> -p <span style="color: #8b2252;">"&#36755;&#20837;&#32534;&#21495;&#26597;&#30475;&#26085;&#24535;: "</span> num;<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\e[0m"</span>
   <span style="color: #a020f0;">fi</span>

   <span style="color: #a020f0;">if </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qiP <span style="color: #8b2252;">'exit|quit'</span>;<span style="color: #a020f0;">then exit</span> 0;<span style="color: #a020f0;">fi</span>

   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#23481;&#22120;</span>
   <span style="color: #a020f0;">if </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qiP <span style="color: #8b2252;">'^\d+:\d+.*$'</span>;<span style="color: #a020f0;">then</span>
      <span style="color: #a0522d;">operation</span>=$(<span style="color: #ff00ff;">echo $num|awk '{print $2}'</span>)
      <span style="color: #a0522d;">container_num</span>=$(<span style="color: #ff00ff;">echo $num|awk -F':|[[:space:]]+' '{print $2}'</span>)
      <span style="color: #a0522d;">num</span>=<span style="color: #8b2252;">"$(</span><span style="color: #ff00ff;">echo $num|awk -F: '{print $1}'</span><span style="color: #8b2252;">) ${operation}"</span>
   <span style="color: #a020f0;">fi</span>

   <span style="color: #b22222;">##</span><span style="color: #b22222;">&#26597;&#30475; </span>
   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36827;&#23481;&#22120;: &lt;num bash&gt; &#25968;&#23383;&#21518;&#21152;&#31354;&#26684;bash&#36827;&#20837;&#23481;&#22120;,&#27604;&#22914; &lt;1 bash&gt;</span>
   <span style="color: #a020f0;">if </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qiP <span style="color: #8b2252;">'\d+\s+bash'</span>;<span style="color: #a020f0;">then</span>
      <span style="color: #a0522d;">cs</span>=<span style="color: #ff00ff;">`sed -n "$(echo $num|awk '{print $1}')p" $temp_list|awk '{print $1}'`</span>
      <span style="color: #a020f0;">if</span> [ ! -z $<span style="color: #a0522d;">container_num</span> ];<span style="color: #a020f0;">then</span>
<span style="color: #b22222;">#         </span><span style="color: #b22222;">[[ $cs =~ (^.*)-[^-]+-[^-]+$ ]]</span>
         ((container_num--))
         <span style="color: #a0522d;">container_name</span>=$(<span style="color: #ff00ff;">kubectl get po $cs -o jsonpath="{.spec.containers[$container_num].name}"</span>)
         <span style="color: #a0522d;">container_cmd</span>=<span style="color: #8b2252;">"-c $container_name"</span>
      <span style="color: #a020f0;">fi</span>
      <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\e[33;1m=== &#36827;&#20837;&#23481;&#22120; $cs &#36755;&#20837;&#21629;&#20196;exit&#36864;&#20986; ====\n\e[0m"</span>
      kubectl $<span style="color: #a0522d;">config</span> exec -it $<span style="color: #a0522d;">cs</span> ${<span style="color: #a0522d;">container_cmd</span>} -- bash  2&gt;/dev/null || kubectl $<span style="color: #a0522d;">config</span> exec -it $<span style="color: #a0522d;">cs</span> ${<span style="color: #a0522d;">container_cmd</span>} -- sh
      <span style="color: #a020f0;">exit</span> 0

   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#26085;&#24535;: &lt;num&gt; [line_num] &#30452;&#25509;&#36755;&#20837;&#23545;&#24212;&#25968;&#23383;&#22238;&#36710;&#23454;&#26102;&#36755;&#20986;&#26368;&#21518;200&#34892;&#26085;&#24535;,&#20063;&#21487;&#20197;&#25351;&#23450;&#34892;&#25968;line_num</span>
   <span style="color: #a020f0;">elif </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qP <span style="color: #8b2252;">'^\d+$'</span>;<span style="color: #a020f0;">then</span>
      <span style="color: #a0522d;">cs</span>=<span style="color: #ff00ff;">`sed -n "${num}p" $temp_list|awk '{print $1}'`</span>
      <span style="color: #a020f0;">if</span> [ ! -z $<span style="color: #a0522d;">container_num</span> ];<span style="color: #a020f0;">then</span>
         <span style="color: #b22222;">#</span><span style="color: #b22222;">[[ $cs =~ (^.*)-[^-]+-[^-]+$ ]]</span>
         <span style="color: #b22222;">#</span><span style="color: #b22222;">container_cmd="-c ${BASH_REMATCH[1]}${container_suffix}"</span>
         ((container_num--))
         <span style="color: #a0522d;">container_name</span>=$(<span style="color: #ff00ff;">kubectl $config get po $cs -o jsonpath="{.spec.containers[$container_num].name}"</span>)
         <span style="color: #a0522d;">container_cmd</span>=<span style="color: #8b2252;">"-c $container_name"</span>
      <span style="color: #a020f0;">fi</span>
      kubectl $<span style="color: #a0522d;">config</span> logs -f --tail=1000 $<span style="color: #a0522d;">cs</span> ${<span style="color: #a0522d;">container_cmd</span>}

   <span style="color: #a020f0;">elif </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qP <span style="color: #8b2252;">'^\d+\s+\d+$'</span>;<span style="color: #a020f0;">then</span>
      <span style="color: #a0522d;">cs</span>=<span style="color: #ff00ff;">`sed -n "$(echo $num|awk '{print $1}')p" $temp_list|awk '{print $1}'`</span>
      <span style="color: #a020f0;">if</span> [ ! -z $<span style="color: #a0522d;">container_num</span> ];<span style="color: #a020f0;">then</span>
         <span style="color: #b22222;">#</span><span style="color: #b22222;">[[ $cs =~ (^.*)-[^-]+-[^-]+$ ]]</span>
         <span style="color: #b22222;">#</span><span style="color: #b22222;">container_cmd="-c ${BASH_REMATCH[1]}${container_suffix}"</span>
         ((container_num--))
         <span style="color: #a0522d;">container_name</span>=$(<span style="color: #ff00ff;">kubectl get po $cs -o jsonpath="{.spec.containers[$container_num].name}"</span>)
         <span style="color: #a0522d;">container_cmd</span>=<span style="color: #8b2252;">"-c $container_name"</span>
      <span style="color: #a020f0;">fi</span>
       <span style="color: #a0522d;">line</span>=<span style="color: #ff00ff;">`echo $num|awk '{print $2}'`</span>
       kubectl $<span style="color: #a0522d;">config</span> logs -f --tail=$<span style="color: #a0522d;">line</span> $<span style="color: #a0522d;">cs</span> ${<span style="color: #a0522d;">container_cmd</span>}

   <span style="color: #b22222;">#</span><span style="color: #b22222;">pod&#35814;&#24773;: &lt;num des&gt; &#25968;&#23383;&#21152;des&#26597;&#30475;pod&#35814;&#32454;&#20449;&#24687;,&#27604;&#22914;&lt;1 des&gt;</span>
   <span style="color: #a020f0;">elif </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qP <span style="color: #8b2252;">'^\d+\s+des$'</span>;<span style="color: #a020f0;">then</span>
           <span style="color: #a0522d;">match</span>=<span style="color: #ff00ff;">`echo $num|sed -rn 's/^[0-9]+[[:space:]]+//p'`</span>
           <span style="color: #a0522d;">num</span>=<span style="color: #ff00ff;">`echo $num|awk '{print $1}'`</span>
           <span style="color: #a0522d;">cs</span>=<span style="color: #ff00ff;">`sed -n "${num}p" $temp_list|awk '{print $1}'`</span>
           kubectl $<span style="color: #a0522d;">config</span> describe po $<span style="color: #a0522d;">cs</span>

   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26085;&#24535;&#21305;&#37197;: &lt;num MATCH&gt; &#25968;&#23383;&#21152;&#31354;&#26684;&#21333;&#35789;&#36827;&#34892;&#26085;&#24535;&#21305;&#37197;,&#27604;&#22914; &lt;1 ERROR&gt;, &#21305;&#37197;&#25968;&#23383;&#38656;&#35201;&#23558;&#25968;&#23383;&#25324;&#36215;&#26469; &lt;1 [12345]&gt;</span>
   <span style="color: #a020f0;">elif </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qP <span style="color: #8b2252;">'^\d+\s+.+$'</span>;<span style="color: #a020f0;">then</span>
      <span style="color: #a0522d;">match</span>=<span style="color: #ff00ff;">`echo $num|sed -rn 's/^[0-9]+[[:space:]]+//p'`</span>
      <span style="color: #a020f0;">if </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">match</span>|grep -qP <span style="color: #8b2252;">'\[\d+\]'</span>;<span style="color: #a020f0;">then</span> <span style="color: #a0522d;">match</span>=$(<span style="color: #ff00ff;">echo $match|sed -nr 's/\[([0-9]+</span><span style="color: #8b2252;">)\]/\1/p'</span>);<span style="color: #a020f0;">fi</span>
      <span style="color: #a0522d;">num</span>=<span style="color: #ff00ff;">`echo $num|awk '{print $1}'`</span>
      <span style="color: #a0522d;">cs</span>=<span style="color: #ff00ff;">`sed -n "${num}p" $temp_list|awk '{print $1}'`</span>
      kubectl $<span style="color: #a0522d;">config</span> logs -f --tail=200 $<span style="color: #a0522d;">cs</span>|grep --color -iP <span style="color: #8b2252;">"$match"</span>
   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#23481;&#22120;&#32858;&#21512;&#26085;&#24535;: &lt;num1,num2 [MATCH]&gt; &#27604;&#22914; 1,3,5 &#26597;&#30475;1 3 5 &#19977;&#20010;&#23481;&#22120;&#30340;&#32858;&#21512;&#26085;&#24535;</span>
   <span style="color: #a020f0;">elif </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qP <span style="color: #8b2252;">'^\d+,\d+'</span>;<span style="color: #a020f0;">then</span>
      <span style="color: #a0522d;">awk_re</span>=<span style="color: #ff00ff;">`echo $num|awk '{print $1}'|awk -F: '{gsub(/,/,"||NR==");print "NR=="$0}'`</span>
      <span style="color: #a0522d;">match</span>=<span style="color: #ff00ff;">`echo $num|awk '{print $2}'`</span>
      <span style="color: #a0522d;">cs</span>=<span style="color: #ff00ff;">`awk '{if('''$awk_re''')print $1}' $temp_list`</span>
      stern $<span style="color: #a0522d;">config</span> ${<span style="color: #a0522d;">cs</span>//[[:space:]]/|} --tail 1000 --include <span style="color: #8b2252;">"$match"</span>
   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#20010;&#23481;&#22120;&#30340;&#32858;&#21512;&#26085;&#24535;: &lt;num_start..num_end [MATCH]&gt; &#27604;&#22914; 1..4 &#26597;&#30475;1&#21040;4&#22235;&#20010;&#23481;&#22120;&#30340;&#32858;&#21512;&#26085;&#24535;</span>
   <span style="color: #a020f0;">elif </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qP <span style="color: #8b2252;">'^\d+..\d+'</span>;<span style="color: #a020f0;">then</span>
       <span style="color: #a0522d;">num_list</span>=<span style="color: #ff00ff;">`echo $num|awk '{print $1}'`</span>
       <span style="color: #a0522d;">awk_re</span>=<span style="color: #ff00ff;">`eval echo {$num_list}|awk '{gsub(/ /,"||NR==");print "NR=="$0}'`</span>
       <span style="color: #a0522d;">match</span>=<span style="color: #ff00ff;">`echo $num|awk '{print $2}'`</span>
       <span style="color: #a0522d;">cs</span>=<span style="color: #ff00ff;">`awk '{if('''$awk_re''')print $1}' $temp_list`</span>
       stern $<span style="color: #a0522d;">config</span> ${<span style="color: #a0522d;">cs</span>//[[:space:]]/|} --tail 1000 --include <span style="color: #8b2252;">"$match"</span>

   <span style="color: #b22222;">##</span><span style="color: #b22222;">&#20462;&#25913;</span>
   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26356;&#26032;&#38236;&#20687;: &lt;num update&gt; &#25968;&#23383;&#21152;update,&#26356;&#26032;&#38236;&#20687;&#29256;&#26412;&#65292;&#29992;&#20110;&#26356;&#26032;&#25110;&#32773;&#22238;&#28378;</span>
   <span style="color: #a020f0;">elif </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qiP <span style="color: #8b2252;">'\d+\s+update'</span>;<span style="color: #a020f0;">then</span>
      <span style="color: #a0522d;">cs</span>=<span style="color: #ff00ff;">`sed -n "$(echo $num|awk '{print $1}')p" $temp_list|awk '{print $1}'|sed -n -r 's/^(.*)-[^-]+-[^-]+$/\1/p'`</span>
      <span style="color: #a0522d;">iver</span>=<span style="color: #ff00ff;">`kubectl $config describe deploy $cs|awk -F: '/Image:/{print $NF}'`</span>
      <span style="color: #a0522d;">image</span>=<span style="color: #ff00ff;">`kubectl $config describe deploy $cs|awk -F'[ |:]' '/Image:/{print $(NF-1)}'`</span>
      <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\e[33;1m===  $cs &#24403;&#21069;&#29256;&#26412;&#20026; [$iver] ====\n\e[0m"</span>
      <span style="color: #483d8b;">read</span> -p <span style="color: #8b2252;">'&#36755;&#20837;&#26032;&#30340;&#29256;&#26412;&#21495;(&#25968;&#23383;&#25110;&#32773;latest,&#40664;&#35748;&#20026;latest)&#65306;'</span> nver
      kubectl $<span style="color: #a0522d;">config</span> set image deployment/$<span style="color: #a0522d;">cs</span> ${<span style="color: #a0522d;">cs</span>}=${<span style="color: #a0522d;">image</span>}:${<span style="color: #a0522d;">nver</span>:=latest}
      <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\e[33;1m\t&#24050;&#35774;&#32622; $cs &#38236;&#20687;&#29256;&#26412;&#20026;\n===  ${image}:$nver  ====\n\e[0m"</span>

   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;&#25991;&#20214;: &lt;num cp&gt; &#25968;&#23383;&#21152;&#31354;&#26684;cp&#22797;&#21046;&#25991;&#20214;&#25110;&#32773;&#30446;&#24405;,&#27604;&#22914; &lt;1 cp&gt;</span>
   <span style="color: #a020f0;">elif </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qiP <span style="color: #8b2252;">'\d+\s+cp'</span>;<span style="color: #a020f0;">then</span>
      <span style="color: #a0522d;">copydir</span>=$<span style="color: #a0522d;">RANDOM</span>
      mkdir /tmp/$<span style="color: #a0522d;">copydir</span>
      <span style="color: #a0522d;">cs</span>=<span style="color: #ff00ff;">`sed -n "$(echo $num|awk '{print $1}')p" $temp_list|awk '{print $1}'`</span>
      <span style="color: #483d8b;">read</span> -p <span style="color: #8b2252;">'&#36755;&#20837;&#35201;&#22797;&#21046;&#30340;&#30446;&#24405;&#25110;&#32773;&#25991;&#20214;&#65288;&#32477;&#23545;&#36335;&#24452;&#65289;&#65306;'</span> copyfile
      kubectl $<span style="color: #a0522d;">config</span> cp ${<span style="color: #a0522d;">cs</span>}:$<span style="color: #a0522d;">copyfile</span> /tmp/$<span style="color: #a0522d;">copydir</span>/$(<span style="color: #ff00ff;">basename $copyfile</span>) 2&gt;/dev/null &amp;&amp; <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"&#25991;&#20214;&#24050;&#32463;&#22797;&#21046;&#21040;/tmp/$copydir"</span>

   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#20280;&#32553;: &lt;num scale&gt; &#25968;&#23383;&#34920;&#31034;&#36873;&#23450;&#35201;&#20280;&#32553;&#30340;&#26381;&#21153;&#65292;&#22914;&lt;1 scale&gt;&#65292;&#33258;&#23450;&#20041;&#20280;&#32553;&#30340;&#26381;&#21153; &lt;0 scale&gt;</span>
   <span style="color: #a020f0;">elif </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qiP <span style="color: #8b2252;">'\d+\s+scale$'</span>;<span style="color: #a020f0;">then</span>
      <span style="color: #a020f0;">if</span> [ $(<span style="color: #ff00ff;">echo $num|awk '{print $1}'</span>) == 0 ];<span style="color: #a020f0;">then</span>
          <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\e[1m--- &#20197;&#19979;&#26381;&#21153;&#25968;&#37327;&#20026;0 ---"</span>
          kubectl $<span style="color: #a0522d;">config</span> get deploy|awk -F<span style="color: #8b2252;">' +|/'</span> <span style="color: #8b2252;">'$3==0{print $1}'</span>
          <span style="color: #483d8b;">read</span> -p <span style="color: #8b2252;">'&#36755;&#20837;&#23545;&#24212;&#26381;&#21153;&#21517;&#31216;&#65306;'</span> deploy
      <span style="color: #a020f0;">else</span>
          <span style="color: #a0522d;">cs</span>=<span style="color: #ff00ff;">`sed -n "$(echo $num|awk '{print $1}')p" $temp_list|awk '{print $1}'`</span>
          <span style="color: #a0522d;">deploy</span>=$(<span style="color: #ff00ff;">echo $cs|sed -nr 's/-[^-]+-[^-]+$//p'</span>)
      <span style="color: #a020f0;">fi</span>
      <span style="color: #a0522d;">c_num</span>=$(<span style="color: #ff00ff;">kubectl $config get deploy $deploy|sed -n '2p'|awk -F' +|/' '{print $3}'</span>)
      <span style="color: #483d8b;">read</span> -p <span style="color: #8b2252;">"&#24403;&#21069;&#36873;&#25321; $deploy &#26381;&#21153;&#65292;&#36755;&#20837;&#35201;&#20280;&#32553;&#30340;&#26381;&#21153;&#25968;&#37327;[&#24403;&#21069;&#25968;&#37327;&#20026; $c_num ]&#65306;"</span> scale_num
<span style="color: #b22222;">#      </span><span style="color: #b22222;">expr $scale_num + 0 &gt;/dev/null 2&gt;&amp;1</span>
      <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">scale_num</span>|grep -P <span style="color: #8b2252;">'^\d+$'</span> &gt;/dev/null
      <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">?</span> -ne 0 ];<span style="color: #a020f0;">then</span>
          <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\e[31;1mError&#65306;&#24517;&#39035;&#36755;&#20837;&#19968;&#20010;&#25972;&#25968;&#65281;\e[0m"</span>;<span style="color: #a020f0;">exit</span> 1
      <span style="color: #a020f0;">else</span>
          <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\e[1m&#27491;&#22312;&#20280;&#32553; ${deploy} &#25968;&#37327;&#20026; $scale_num ...\e[0m"</span>;sleep 1
          kubectl $<span style="color: #a0522d;">config</span> scale deploy ${<span style="color: #a0522d;">deploy</span>} --replicas=$<span style="color: #a0522d;">scale_num</span>
      <span style="color: #a020f0;">fi</span>

   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;&#25351;&#23450;&#30456;&#20851;&#25152;&#26377;&#26381;&#21153;</span>
   <span style="color: #a020f0;">elif </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qiP <span style="color: #8b2252;">'\d+\s+restart\s+all'</span>;<span style="color: #a020f0;">then</span>
      <span style="color: #a0522d;">cs</span>=<span style="color: #ff00ff;">`sed -n "$(echo $num|awk '{print $1}')p" $temp_list|awk '{print $1}'|sed -n -r 's/^(.*)-[^-]+-[^-]+$/\1/p'`</span>
      kubectl $<span style="color: #a0522d;">config</span> rollout restart deploy $<span style="color: #a0522d;">cs</span>
      <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\e[33;1m===  &#27491;&#22312;&#37325;&#21551;&#25152;&#26377;$cs&#23481;&#22120;  ====\n\e[0m"</span>

   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;&#26381;&#21153;: &lt;num restart&gt; &#25968;&#23383;&#21152;&#31354;&#26684;restart&#37325;&#21551;&#26381;&#21153;,&#27604;&#22914; &lt;1 restart&gt; &#24378;&#21046;&#21024;&#38500;&#26381;&#21153;&#22914;&lt;1 restart force&gt;</span>
   <span style="color: #a020f0;">elif </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qiP <span style="color: #8b2252;">'\d+\s+restart\s+force'</span>;<span style="color: #a020f0;">then</span>
      <span style="color: #a0522d;">cs</span>=<span style="color: #ff00ff;">`sed -n "$(echo $num|awk '{print $1}')p" $temp_list|awk '{print $1}'`</span>
      <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\e[33;1m=== &#27491;&#22312;&#24378;&#21046;&#37325;&#21551;&#23481;&#22120; $cs  ====\n\e[0m"</span>
      kubectl $<span style="color: #a0522d;">config</span> delete pod $<span style="color: #a0522d;">cs</span> --force --grace-period=0
      <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\e[33;1m=== &#24378;&#21046;&#37325;&#21551;&#23436;&#27605;  ====\n\e[0m"</span>
      <span style="color: #a020f0;">exit</span> 0
   <span style="color: #a020f0;">elif </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qiP <span style="color: #8b2252;">'\d+\s+restart$'</span>;<span style="color: #a020f0;">then</span>
      <span style="color: #a0522d;">cs</span>=<span style="color: #ff00ff;">`sed -n "$(echo $num|awk '{print $1}')p" $temp_list|awk '{print $1}'`</span>
      <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\e[33;1m=== &#27491;&#22312;&#37325;&#21551;&#23481;&#22120; $cs  ====\n\e[0m"</span>
      kubectl $<span style="color: #a0522d;">config</span> delete pod $<span style="color: #a0522d;">cs</span>
      <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\e[33;1m=== &#37325;&#21551;&#23436;&#27605;  ====\n\e[0m"</span>
      <span style="color: #a020f0;">exit</span> 0

   <span style="color: #b22222;">##</span><span style="color: #b22222;">&#20854;&#20182; </span>
   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21047;&#26032;&#24403;&#21069;&#21015;&#34920;</span>
   <span style="color: #a020f0;">elif </span><span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">num</span>|grep -qP <span style="color: #8b2252;">'^reload$|^r$'</span>;<span style="color: #a020f0;">then</span>
      print_list
   <span style="color: #a020f0;">else</span>
      <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\e[32;1mERROR: Not a Correct Command !!!\e[0m"</span>
      <span style="color: #a020f0;">exit</span> 1
   <span style="color: #a020f0;">fi</span>
}
print_list
</pre>
</div>
</div>
</div>
<div id="outline-container-org6e42449" class="outline-3">
<h3 id="org6e42449">小工具3</h3>
<div class="outline-text-3" id="text-org6e42449">
<p>
功能：登入容器
</p>

<p>
kube-ci选项
</p>
<pre class="example" id="orgdc1453f">
kube-ci [名称空间] pod名称 [shell路径] [k8s配置文件]
[]为可选
默认 kube-ci pod名称 为登入生产环境名称空间为english-prod的容器，使用shell为/bin/bash
</pre>

<p>
脚本内容
</p>
<div class="org-src-container">
<pre class="src src-sh">cat &lt;&lt;\EOF &gt; kube-ci 
<span style="color: #ffa54f;">#!/bin/bash</span>
<span style="color: #ffa54f;">[ $# -eq 0 ] &amp;&amp; echo -e "Please input: \e[31;1m kube-ci\e[0m [nameSpace] \e[31;1m podName \e[0m [shellPath] [kubeConfigPath]\n" &amp;&amp; exit 1</span>
<span style="color: #ffa54f;">[ $# -eq 2 ] &amp;&amp; namesapce=$1 podname=$2 </span>
<span style="color: #ffa54f;">[ $# -eq 3 ] &amp;&amp; namesapce=$1 podname=$2 shell_path=$3</span>
<span style="color: #ffa54f;">[ $# -gt 3 ] &amp;&amp; namesapce=$1 podname=$2 shell_path=$3  config=$4</span>
<span style="color: #ffa54f;">: export ${namesapce:="english-prod"} ${podname:=$1} ${shell_path:=/bin/bash} ${config:="/data/ops/config_prod"}</span>
<span style="color: #ffa54f;">kubectl --kubeconfig=$config -n $namesapce exec -it $podname ${shell_path}</span>
<span style="color: #ffa54f;">EOF</span>

chmod +x kube-ci
</pre>
</div>

<p>
脚本加密
</p>
<div class="org-src-container">
<pre class="src src-sh">shc -T -r -f kube-ci
mv -f  kube-ci .kube-ci ; mv -f kube-ci.x kube-ci ; rm -f kube-ci.x.c
ln -svf /data/ops/scripts/kube-ci /usr/bin/
</pre>
</div>

<p>
验证：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">kube-ci  english-activity-server-68f797b6b8-ww4mh</span>
[root@english-activity-server-68f797b6b8-ww4mh data]# 

<span style="color: #b22222;"># </span><span style="color: #b22222;">kube-ci bigdata-prod data-center-point-web-7765887f5f-st4gs</span>
[root@data-center-point-web-7765887f5f-st4gs data]# 
</pre>
</div>
</div>
</div>
<div id="outline-container-org92bd861" class="outline-3">
<h3 id="org92bd861">定时修改Hpa副本数</h3>
<div class="outline-text-3" id="text-org92bd861">
<p>
可以用cronhpa
</p>

<div class="org-src-container">
<pre class="src src-sh">crontab -l
<span style="color: #b22222;"># </span><span style="color: #b22222;">k8s &#25253;&#35686; by xuchangwei</span>
*/5 8-23 * * * bash  /data/ops/k8s_ding.sh &amp;&gt;/root/tmp.log
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22823;&#36187;HPA</span>
20 20 * * * bash  /data/ops/k8s_hot_etp_hpa.sh --up  &amp;&gt;/dev/null
30 21 * * * bash  /data/ops/k8s_hot_etp_hpa.sh --down  &amp;&gt;/dev/null
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">cat &lt;&lt;\EOF &gt;k8s_hot_etp_hpa.sh 
<span style="color: #ffa54f;">#!/bin/bash</span>
<span style="color: #ffa54f;">source /etc/profile</span>
<span style="color: #ffa54f;">kube_conf_file=/etc/kubernetes/admin.conf</span>
<span style="color: #ffa54f;">namespace=english-prod</span>
<span style="color: #ffa54f;">kube_CMD="kubectl --kubeconfig=$kube_conf_file"</span>
<span style="color: #ffa54f;">tokens="1923d71ff377813"</span>
<span style="color: #ffa54f;">#--------------------</span>
<span style="color: #ffa54f;">[ ! -e  /data/ops/logs ] &amp;&amp; mkdir -p ./logs</span>
<span style="color: #ffa54f;">declare -A monitor_info</span>

<span style="color: #ffa54f;">unset scale_up</span>
<span style="color: #ffa54f;">unset scale_down</span>
<span style="color: #ffa54f;">declare -A SCALE</span>
<span style="color: #ffa54f;">scale_down="</span>
<span style="color: #ffa54f;">english-etp-race-mqtt|english-etp-race-mqtt|2</span>
<span style="color: #ffa54f;">english-etp-web|english-etp-web|10</span>
<span style="color: #ffa54f;">"</span>

<span style="color: #ffa54f;">scale_up="</span>
<span style="color: #ffa54f;">english-etp-race-mqtt|english-etp-race-mqtt|40</span>
<span style="color: #ffa54f;">english-etp-web|english-etp-web|20</span>
<span style="color: #ffa54f;">"</span>
<span style="color: #ffa54f;">SCALE["UP"]=$scale_up</span>
<span style="color: #ffa54f;">SCALE["DOWN"]=$scale_down</span>

<span style="color: #ffa54f;">#dingding push</span>
<span style="color: #ffa54f;">function dingding() {</span>
<span style="color: #ffa54f;">local access_tokens=$1</span>
<span style="color: #ffa54f;">local ding_url='https://oapi.dingtalk.com/robot/send'</span>
<span style="color: #ffa54f;">local ding_header='Content-Type: application/json'</span>
<span style="color: #ffa54f;">local msg=$2</span>
<span style="color: #ffa54f;">for key in $access_tokens; do</span>
<span style="color: #ffa54f;">curl -s -connect-timeout 40 -XPOST -H "$ding_header" "$ding_url?access_token=$key" \</span>
<span style="color: #ffa54f;">-d '{"msgtype": "text",</span>
<span style="color: #ffa54f;">    "text": {</span>
<span style="color: #ffa54f;">        "content": "&#12304;&#29983;&#20135;k8s-hpa&#21464;&#26356;&#36890;&#30693;&#12305; \n'"$msg"'"</span>
<span style="color: #ffa54f;">    },</span>
<span style="color: #ffa54f;">"at": {</span>
<span style="color: #ffa54f;">      "atMobiles": [],</span>
<span style="color: #ffa54f;">      "isAtAll": true</span>
<span style="color: #ffa54f;">  }</span>
<span style="color: #ffa54f;">}'</span>
<span style="color: #ffa54f;">done</span>
<span style="color: #ffa54f;">}</span>


<span style="color: #ffa54f;">function set_hpa() {</span>
<span style="color: #ffa54f;">    local hpa_info=${SCALE["$1"]}</span>
<span style="color: #ffa54f;">    [ -z "${hpa_info}" ] &amp;&amp; exit 1</span>
<span style="color: #ffa54f;">    for h in ${hpa_info}; do</span>
<span style="color: #ffa54f;">        deployment_name=$(</span><span style="color: #ff00ff;">echo $h | awk -F'|' '{print $1}'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        hpa_name=$(</span><span style="color: #ff00ff;">echo $h | awk -F'|' '{print $2}'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        hpa_min_num=$(</span><span style="color: #ff00ff;">echo $h | awk -F'|' '{print $3}'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        [ -z "${hpa_name}" -o -z "${hpa_min_num}" ] &amp;&amp; continue</span>
<span style="color: #ffa54f;">        monitor_info[${#monitor_info[*]}]="${deployment_name} &#26368;&#23567;&#21103;&#26412;&#25968;&#65306; ${hpa_min_num}\n"</span>
<span style="color: #ffa54f;">        $kube_CMD -n $namespace patch hpa ${hpa_name} -p '{"spec":{"minReplicas":'"${hpa_min_num}"'}}' &gt;/dev/null</span>
<span style="color: #ffa54f;">        echo "$kube_CMD -n $namespace patch hpa ${hpa_name} -p '{"spec":{"minReplicas":'"${hpa_min_num}"'}}' "</span>

<span style="color: #ffa54f;">    done</span>

<span style="color: #ffa54f;">    [ ${#monitor_info[@]} -gt 0 ] &amp;&amp; {</span>
<span style="color: #ffa54f;">        # chinese&#25253;&#35686;&#32676;</span>
<span style="color: #ffa54f;">        dingding "a74e585f34d" "$(</span><span style="color: #ff00ff;">echo -e "${monitor_info[@]}"</span><span style="color: #ffa54f;">)\\n"</span>
<span style="color: #ffa54f;">       :</span>
<span style="color: #ffa54f;">    }</span>
<span style="color: #ffa54f;">}</span>

<span style="color: #ffa54f;">main() {</span>
<span style="color: #ffa54f;">    set_hpa "$1"</span>
<span style="color: #ffa54f;">    #echo  -e "${monitor_info[@]}"</span>
<span style="color: #ffa54f;">    [ ${#monitor_info[@]} -gt 0 ] &amp;&amp; {</span>
<span style="color: #ffa54f;">        dingding "$tokens" "$(</span><span style="color: #ff00ff;">echo -e "${monitor_info[@]}"</span><span style="color: #ffa54f;">)\\n"</span>
<span style="color: #ffa54f;">        echo -e "${monitor_info[@]}" &gt;&gt; /data/ops/logs/k8s_hpa_`date +"%Y-%m"`.log</span>
<span style="color: #ffa54f;">    }</span>
<span style="color: #ffa54f;">}</span>

<span style="color: #ffa54f;">usage(){</span>
<span style="color: #ffa54f;">cat &lt;&lt;EOF</span>
<span style="color: #ffa54f;">Usage: $0  [OPTION]</span>

<span style="color: #ffa54f;">OPTION:</span>
<span style="color: #ffa54f;">  -u, --up                 chang minReplicas</span>
<span style="color: #ffa54f;">  -d, --down               chang minReplicas</span>
<span style="color: #ffa54f;">  --version                show version</span>
<span style="color: #ffa54f;">  --help                   show help</span>
<span style="color: #ffa54f;">EOF</span>
}

getopt -T &amp;&gt;/dev/null;[ $<span style="color: #a0522d;">?</span> -ne 4 ] &amp;&amp; { <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"not enhanced version"</span>;<span style="color: #a020f0;">exit</span> 1; }

<span style="color: #a0522d;">parameters</span>=$(<span style="color: #ff00ff;">getopt -o ud --long up,down,help,version -n "$0" -- "$@"</span>)
[ $<span style="color: #a0522d;">?</span> -ne 0 ] &amp;&amp; { <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"Try '$0 --help' for more information."</span>; <span style="color: #a020f0;">exit</span> 1; }

<span style="color: #483d8b;">eval</span> set -- <span style="color: #8b2252;">"$parameters"</span>

<span style="color: #a020f0;">while</span> true; <span style="color: #a020f0;">do</span>
    <span style="color: #a020f0;">case</span> <span style="color: #8b2252;">"$1"</span><span style="color: #a020f0;"> in</span>
    -u|--up)   main UP ; <span style="color: #483d8b;">shift</span> ; <span style="color: #a020f0;">exit</span> ;;
    -d|--down) main DOWN ; <span style="color: #483d8b;">shift</span> ; <span style="color: #a020f0;">exit</span> ;;
    --version) <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$0 version V0.1"</span>; <span style="color: #a020f0;">exit</span> ;;
    --help) usage;<span style="color: #a020f0;">exit</span> ;;
    --)
        <span style="color: #483d8b;">shift</span>
        [ <span style="color: #8b2252;">"$1"</span> = <span style="color: #8b2252;">""</span> ] &amp;&amp; usage ||  {
        <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"$0: invalid floating point argument: $@\nTry '$0 --help' for more information."</span> ; <span style="color: #a020f0;">exit</span> 1; }
        [ <span style="color: #8b2252;">"$#"</span> -ge 2 ] &amp;&amp; {
        <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"$0: invalid floating point argument: $@\nTry '$0 --help' for more information."</span> ; <span style="color: #a020f0;">exit</span> 1; }
        <span style="color: #a0522d;">FIRST</span>=$<span style="color: #a0522d;">1</span>
        <span style="color: #a0522d;">SECOND</span>=$<span style="color: #a0522d;">2</span>
        <span style="color: #a0522d;">LAST</span>=$<span style="color: #a0522d;">3</span>
        <span style="color: #a020f0;">break</span> ;;
    *) <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"0k"</span>  ;;
    <span style="color: #a020f0;">esac</span>
<span style="color: #a020f0;">done</span>
EOF
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf70ba6d" class="outline-3">
<h3 id="orgf70ba6d">bash脚本监控</h3>
<div class="outline-text-3" id="text-orgf70ba6d">
<p>
定时任务 
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">k8s &#25253;&#35686; by xuchangwei</span>
*/5 8-23 * * * bash /data/ops/k8s_ding.sh &amp;&gt;/dev/null
</pre>
</div>

<p>
执行输出
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@ali-h-ops-elkf-kibana-prod-bj01 /data/ops] eth0 = 10.16.202.198
<span style="color: #b22222;"># </span><span style="color: #b22222;">bash  k8s_ding.sh </span>
&#38598;&#32676;CPU&#20351;&#29992;&#29575;62.55, &#35831;&#27714;/&#24635;&#39069;:960.75/1536
&#38598;&#32676;&#20869;&#23384;&#20351;&#29992;&#29575;74.05, &#35831;&#27714;/&#24635;&#39069;:2219494/2997146.30
&#38598;&#32676; [ops] CPU&#20351;&#29992;&#29575;19.67, &#35831;&#27714;/&#24635;&#39069;(&#26680;):12.59/64, &#33410;&#28857;&#25968;:2 
&#38598;&#32676; [ops] &#20869;&#23384;&#20351;&#29992;&#29575;16.45, &#35831;&#27714;/&#24635;&#39069;(Gi):19.99/121.54, &#33410;&#28857;&#25968;:2
.....
&#38598;&#32676; [bigdata] CPU&#20351;&#29992;&#29575;77.64, &#35831;&#27714;/&#24635;&#39069;(&#26680;):149.06/192, &#33410;&#28857;&#25968;:6 
&#38598;&#32676; [bigdata] &#20869;&#23384;&#20351;&#29992;&#29575;77.38, &#35831;&#27714;/&#24635;&#39069;(Gi):282.14/364.62, &#33410;&#28857;&#25968;:6
&#38598;&#32676; [application] CPU&#20351;&#29992;&#29575;65.01, &#35831;&#27714;/&#24635;&#39069;(&#26680;):748.91/1152, &#33410;&#28857;&#25968;:36 
&#38598;&#32676; [application] &#20869;&#23384;&#20351;&#29992;&#29575;81.72, &#35831;&#27714;/&#24635;&#39069;(Gi):1795.96/2197.66, &#33410;&#28857;&#25968;:36
</pre>
</div>

<p>
脚本内容(已废)
</p>

<div class="org-src-container">
<pre class="src src-sh">cat &lt;&lt;\EOF &gt; k8s_ding.sh 
<span style="color: #ffa54f;">#!/bin/bash</span>
<span style="color: #ffa54f;">set -e</span>
<span style="color: #ffa54f;">source /etc/profile</span>
<span style="color: #ffa54f;">PATH=/usr/local/bin/:$PATH</span>
<span style="color: #ffa54f;">DIR="$(</span><span style="color: #ff00ff;"> cd "$( dirname "${BASH_SOURCE[0]}" </span><span style="color: #ffa54f;">)" &amp;&amp; pwd )"</span>
<span style="color: #ffa54f;">cd $DIR</span>
<span style="color: #ffa54f;">bash ./k8s_node_ding.sh  &amp;</span>
<span style="color: #ffa54f;">bash ./k8s_namespace_ding.sh bigdata-prod &amp;</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">node&#30417;&#25511;</span>
cat &lt;&lt;\EOF &gt; k8s_node_ding.sh 
<span style="color: #ffa54f;">#!/bin/bash</span>
<span style="color: #ffa54f;">set -e</span>
<span style="color: #ffa54f;">source /etc/profile</span>
<span style="color: #ffa54f;">PATH=/usr/local/bin/:$PATH</span>
<span style="color: #ffa54f;">#kube_conf_file=/etc/kubernetes/admin.conf</span>
<span style="color: #ffa54f;">kube_conf_file=/root/xuchangwei/config_prod</span>
<span style="color: #ffa54f;">kube_CMD="kubectl --kubeconfig=$kube_conf_file"</span>
<span style="color: #ffa54f;">namespace=english-prod </span>
<span style="color: #ffa54f;">node_cpu=4             # node CPU &#39044;&#35686;&#20540;(&#26680;)</span>
<span style="color: #ffa54f;">node_memory=5          # node &#20869;&#23384; &#39044;&#35686;&#20540;(GB)</span>
<span style="color: #ffa54f;">node_cpu_pre=90        # node cpu&#20351;&#29992;&#29575; &#39044;&#35686;&#20540;(%)</span>
<span style="color: #ffa54f;">node_memory_pre=90     # node &#20869;&#23384;&#20351;&#29992;&#29575; &#39044;&#35686;&#20540;(%)</span>
<span style="color: #ffa54f;">tokens="1923dbd1ff377813"</span>
<span style="color: #ffa54f;">#--------------------</span>
<span style="color: #ffa54f;">mkdir -p ./logs</span>
<span style="color: #ffa54f;">unset monitor_info</span>
<span style="color: #ffa54f;">declare -A monitor_info</span>

<span style="color: #ffa54f;">#&#25552;&#21069;&#23545;node&#25171;&#19978;node&#26631;&#31614;</span>

<span style="color: #ffa54f;">function caler() {</span>
<span style="color: #ffa54f;">    res=`awk 'BEGIN{printf "%.2f\n",'$1'/'$2'*100}'`</span>
<span style="color: #ffa54f;">}</span>

<span style="color: #ffa54f;">function node_check() {</span>
<span style="color: #ffa54f;">:</span>
<span style="color: #ffa54f;">   n_cpu=0</span>
<span style="color: #ffa54f;">   n_memory=0 </span>
<span style="color: #ffa54f;">   n_cpu_request=0</span>
<span style="color: #ffa54f;">   n_memory_request=0</span>
<span style="color: #ffa54f;">   declare -A n_cpu_roles</span>
<span style="color: #ffa54f;">   declare -A n_memory_roles</span>
<span style="color: #ffa54f;">   declare -A n_cpu_request_roles</span>
<span style="color: #ffa54f;">   declare -A n_memory_request_roles</span>
<span style="color: #ffa54f;">   declare -A n_num_roles</span>
<span style="color: #ffa54f;">   while read n; do</span>
<span style="color: #ffa54f;">        #echo $n</span>
<span style="color: #ffa54f;">        #n=$(</span><span style="color: #ff00ff;">kubectl get       node cn-beijing.10.16.20.146 |sed '1d'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        node_name=$(</span><span style="color: #ff00ff;">echo $n | awk '{print $1}'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        #node_roles=$(</span><span style="color: #ff00ff;">echo $n | awk '{print $3}'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        node_roles=$(</span><span style="color: #ff00ff;">echo $n | grep  -Eo 'node=[[:alnum:]-]{1,}' | awk -F'node=' '{print $2}'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        if [ ${node_roles} != "ingress" ]; then</span>
<span style="color: #ffa54f;">        node_info=$(</span><span style="color: #ff00ff;">$kube_CMD describe node ${node_name} </span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        node_total_info=$(</span><span style="color: #ff00ff;">echo "${node_info}"|grep -A15 Capacity</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        node_rl_info=$(</span><span style="color: #ff00ff;">echo "${node_info}"|grep -E 'cpu |memory  '</span><span style="color: #ffa54f;">)</span>

<span style="color: #ffa54f;">        node_cpu_total=$(</span><span style="color: #ff00ff;">echo "${node_total_info}"|grep -A6 Capacity|grep cpu|awk '{print $2}'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        node_memory_total=$(</span><span style="color: #ff00ff;">echo "${node_total_info}"|grep -A6 Capacity|grep memory|awk '{print $2}'|sed 's/Ki//'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        node_cpu_total_allocatable=$(</span><span style="color: #ff00ff;">echo "${node_total_info}"|grep -A6 Allocatable|grep cpu|awk '{print $2}'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        node_memory_total_allocatable=$(</span><span style="color: #ff00ff;">echo "${node_total_info}"|grep -A6 Allocatable|grep memory|awk '{print $2}'|sed 's/Ki//'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        n_cpu=$[${node_cpu_total}+${n_cpu}]</span>
<span style="color: #ffa54f;">        n_memory=$[${node_memory_total}+${n_memory}]</span>
<span style="color: #ffa54f;">        [ -z "${n_num_roles["${node_roles}"]}" ] &amp;&amp; n_num_roles["${node_roles}"]=0</span>
<span style="color: #ffa54f;">        [ -z "${n_cpu_roles["${node_roles}"]}" ] &amp;&amp; n_cpu_roles["${node_roles}"]=0</span>
<span style="color: #ffa54f;">        [ -z "${n_memory_roles["${node_roles}"]}" ] &amp;&amp; n_memory_roles["${node_roles}"]=0</span>
<span style="color: #ffa54f;">        n_num_roles["${node_roles}"]=$[ 1 + ${n_num_roles["${node_roles}"]} ]</span>
<span style="color: #ffa54f;">        n_cpu_roles["${node_roles}"]=$[ ${node_cpu_total} + ${n_cpu_roles["${node_roles}"]} ]</span>
<span style="color: #ffa54f;">        n_memory_roles["${node_roles}"]=$[ ${node_memory_total} + ${n_memory_roles["${node_roles}"]} ]</span>

<span style="color: #ffa54f;">        node_cpu_requests=$(</span><span style="color: #ff00ff;">echo "${node_rl_info}"|grep 'cpu ' |awk '{print $2}'|sed 's/m//'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        #node_cpu_requests_pre=$(</span><span style="color: #ff00ff;">echo "${node_rl_info}"|grep 'cpu ' |awk '{print $3}'|sed -r 's/(\(|\</span><span style="color: #ffa54f;">)|%)//g')</span>
<span style="color: #ffa54f;">        node_cpu_requests_pre=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_cpu_requests}/${node_cpu_total}"'/1000*100</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">        node_cpu_limits=$(</span><span style="color: #ff00ff;">echo "${node_rl_info}"|grep 'cpu ' |awk '{print $4}'|sed 's/m//'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        node_cpu_limits_pre=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_cpu_limits}/${node_cpu_total}"'/1000*100</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">        node_cpu_allocatable=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_cpu_total_allocatable}-${node_cpu_requests}/1000"'</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">        if echo "${node_rl_info}"|grep 'memory  ' |awk '{print $2}' | grep 'Mi'&amp;&gt;/dev/null; then</span>
<span style="color: #ffa54f;">            node_memory_requests=$(</span><span style="color: #ff00ff;">echo "${node_rl_info}"|grep 'memory  ' |awk '{print $2}'|sed 's/Mi//'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">            node_memory_requests_pre=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_memory_requests}/${node_memory_total}"'*1024*100</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">            node_memory_allocatable=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_memory_total_allocatable}/1024/1024-${node_memory_requests}/1024"'</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">        node_memory_limits=$(</span><span style="color: #ff00ff;">echo "${node_rl_info}"|grep 'memory  ' |awk '{print $4}'|sed 's/Mi//'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        node_memory_limits_pre=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_memory_limits}/${node_memory_total}"'*1024*100</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">        elif echo "${node_rl_info}"|grep 'memory  ' |awk '{print $2}'|grep 'Gi'&amp;&gt;/dev/null; then</span>
<span style="color: #ffa54f;">            node_memory_requests=$(</span><span style="color: #ff00ff;">echo "${node_rl_info}"|grep 'memory  ' |awk '{print $2}'|sed 's/Gi//'|awk '{printf "%.2f",($1*1024</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">            node_memory_requests_pre=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_memory_requests}/${node_memory_total}"'*1024*100</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">            node_memory_allocatable=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_memory_total_allocatable}/1024/1024-${node_memory_requests}/1024"'</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">        node_memory_limits=$(</span><span style="color: #ff00ff;">echo "${node_rl_info}"|grep 'memory  ' |awk '{print $4}'|sed 's/Mi//'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        node_memory_limits_pre=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_memory_limits}/${node_memory_total}"'*1024*100</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">        elif echo "${node_rl_info}"|grep 'memory  ' |awk '{print $2}'|grep 'm'&amp;&gt;/dev/null; then</span>
<span style="color: #ffa54f;">            node_memory_requests=$(</span><span style="color: #ff00ff;">echo "${node_rl_info}"|grep 'memory  ' |awk '{print $2}'|sed 's/m//'|awk '{printf "%.2f",($1/1024/1024/1024</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">            node_memory_requests_pre=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_memory_requests}/${node_memory_total}"'*1024*100</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">            node_memory_allocatable=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_memory_total_allocatable}/1024/1024-${node_memory_requests}/1024"'</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">        node_memory_limits=$(</span><span style="color: #ff00ff;">echo "${node_rl_info}"|grep 'memory  ' |awk '{print $4}'|sed 's/m//'|awk '{printf "%.2f",($1/1024/1024/1024</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">        node_memory_limits_pre=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_memory_limits}/${node_memory_total}"'*1024*100</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">        else</span>
<span style="color: #ffa54f;">            node_memory_requests=$(</span><span style="color: #ff00ff;">echo "${node_rl_info}"|grep 'memory  ' |awk '{print $2}'|sed 's/Mi//'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">            node_memory_requests_pre=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_memory_requests}/${node_memory_total}"'*1024*100</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">            node_memory_allocatable=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_memory_total_allocatable}/1024/1024-${node_memory_requests}/1024"'</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">        node_memory_limits=$(</span><span style="color: #ff00ff;">echo "${node_rl_info}"|grep 'memory  ' |awk '{print $4}'|sed 's/Mi//'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">        node_memory_limits_pre=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_memory_limits}/${node_memory_total}"'*1024*100</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">        fi</span>
<span style="color: #ffa54f;">        n_cpu_request=$[${node_cpu_requests}+${n_cpu_request}]</span>
<span style="color: #ffa54f;">        #n_memory_request=$[${node_memory_requests}+${n_memory_request}]</span>
<span style="color: #ffa54f;">        n_memory_request=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_memory_requests}+${n_memory_request}"'</span><span style="color: #ffa54f;">)}')</span>
<span style="color: #ffa54f;">        [ -z "${n_cpu_request_roles["${node_roles}"]}" ] &amp;&amp; n_cpu_request_roles["${node_roles}"]=0</span>
<span style="color: #ffa54f;">        [ -z "${n_memory_request_roles["${node_roles}"]}" ] &amp;&amp; n_memory_request_roles["${node_roles}"]=0</span>
<span style="color: #ffa54f;">        n_cpu_request_roles["${node_roles}"]=$[ ${node_cpu_requests} + ${n_cpu_request_roles["${node_roles}"]} ]</span>
<span style="color: #ffa54f;">        #n_memory_request_roles["${node_roles}"]=$[ ${node_memory_requests} + ${n_memory_request_roles["${node_roles}"]} ]</span>
<span style="color: #ffa54f;">        n_memory_request_roles["${node_roles}"]=$(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",('"${node_memory_requests} + ${n_memory_request_roles[${node_roles}]}"'</span><span style="color: #ffa54f;">)}')</span>

<span style="color: #ffa54f;">       # # &#21333;&#33410;&#28857;&#30417;&#25511;</span>
<span style="color: #ffa54f;">       # if_cpu=$(</span><span style="color: #ff00ff;">awk 'BEGIN{if (int('"${node_cpu_allocatable}"'</span><span style="color: #ffa54f;">) &lt;= int('"$node_cpu"')){print "1"}}')</span>
<span style="color: #ffa54f;">       # [ "${if_cpu}"  == "1" ] &amp;&amp; { </span>
<span style="color: #ffa54f;">       #     cpu_waring=$(</span><span style="color: #ff00ff;">printf "%s(%s</span><span style="color: #ffa54f;">)&#21487;&#20998;&#37197;CPU&#19981;&#36275;&#65292;CPU&#21097;&#20313;%s&#26680;&#65292;CPU&#24635;&#39069;: %s&#26680;&#65292;CPU requrests: %s (%s%%)&#65292;CPU limits: %s (%s%%)\n" ${node_name} ${node_roles} ${node_cpu_allocatable} `awk 'BEGIN{printf "%.2f\n",'"${node_cpu_total_allocatable}"'}'` ${node_cpu_requests}m ${node_cpu_requests_pre} ${node_cpu_limits}m ${node_cpu_limits_pre})</span>
<span style="color: #ffa54f;">       #     monitor_info[${#monitor_info[*]}]="${cpu_waring}\n"</span>
<span style="color: #ffa54f;">       #     }</span>
<span style="color: #ffa54f;">       # if_memory=$(</span><span style="color: #ff00ff;">awk 'BEGIN{if (int('"${node_memory_allocatable}"'</span><span style="color: #ffa54f;">) &lt;= int('"$node_memory"')){print "1"}}')</span>
<span style="color: #ffa54f;">       # [ "${if_memory}"  == "1" ] &amp;&amp; {</span>
<span style="color: #ffa54f;">       #      memory_waring=$(</span><span style="color: #ff00ff;">printf "%s(%s</span><span style="color: #ffa54f;">)&#21487;&#20998;&#37197;&#20869;&#23384;&#19981;&#36275;&#65292;&#20869;&#23384;&#21097;&#20313;%sGi&#65292;&#20869;&#23384;&#24635;&#39069;: %sGi&#65292;&#20869;&#23384; requrests: %s (%s%%)&#65292;&#20869;&#23384; limits: %s (%s%%)\n" ${node_name} ${node_roles} ${node_memory_allocatable} `awk 'BEGIN{printf "%.2f\n",'"${node_memory_total_allocatable}/1024/1024"'}'` ${node_memory_requests}Mi ${node_memory_requests_pre} ${node_memory_limits}Mi ${node_memory_limits_pre})</span>
<span style="color: #ffa54f;">       #      monitor_info[${#monitor_info[*]}]="${memory_waring}\n"</span>
<span style="color: #ffa54f;">       #      }</span>

<span style="color: #ffa54f;">        #echo ${#monitor_info[*]}</span>
<span style="color: #ffa54f;">        fi</span>
<span style="color: #ffa54f;">   done  &lt; &lt;($kube_CMD get node --show-labels|sed '1d')</span>
<span style="color: #ffa54f;">#   echo ${monitor_info[@]}</span>
<span style="color: #ffa54f;">   # &#38598;&#32676;&#33410;&#28857;&#30417;&#25511;</span>
<span style="color: #ffa54f;">   caler "(${n_cpu_request}/1000)" ${n_cpu}</span>
<span style="color: #ffa54f;">   [ "`awk -v num1=$res -v num2=${node_cpu_pre} 'BEGIN{print(num1&gt;num2)?"0":"1"}'`" == "0" ] &amp;&amp; monitor_info[${#monitor_info[*]}]="&#38598;&#32676;CPU&#20351;&#29992;&#29575;&gt;${node_cpu_pre}%, &#24403;&#21069;$res&#65292;&#35831;&#27714;/&#24635;&#39069;:`awk 'BEGIN{printf "%.2f",('"${n_cpu_request}/1000"')}'`/${n_cpu}\n"</span>
<span style="color: #ffa54f;">   echo "&#38598;&#32676;CPU&#20351;&#29992;&#29575;$res, &#35831;&#27714;/&#24635;&#39069;:`awk 'BEGIN{printf "%.2f",('"${n_cpu_request}/1000"')}'`/${n_cpu}"</span>
<span style="color: #ffa54f;">   caler ${n_memory_request} "(${n_memory}/1024)"</span>
<span style="color: #ffa54f;">   echo "&#38598;&#32676;&#20869;&#23384;&#20351;&#29992;&#29575;$res, &#35831;&#27714;/&#24635;&#39069;:${n_memory_request}/`awk 'BEGIN{printf "%.2f",'"(${n_memory}/1024)"'}'`"</span>
<span style="color: #ffa54f;">   # roles</span>
<span style="color: #ffa54f;">   for r in ${!n_cpu_roles[@]};do</span>
<span style="color: #ffa54f;">       caler "(${n_cpu_request_roles[$r]}/1000)" "${n_cpu_roles[$r]}"</span>
<span style="color: #ffa54f;">       [ "`awk -v num1=$res -v num2=${node_cpu_pre} 'BEGIN{print(num1&gt;num2)?"0":"1"}'`" == "0" ] &amp;&amp; monitor_info[${#monitor_info[*]}]="&#38598;&#32676; [$r] CPU&#20351;&#29992;&#29575;&gt;${node_cpu_pre}%, &#24403;&#21069;$res, &#35831;&#27714;/&#24635;&#39069;(&#26680;): $(</span><span style="color: #ff00ff;">awk 'BEGIN{printf "%.2f",'"(${n_cpu_request_roles[$r]}/1000</span><span style="color: #ffa54f;">)"'}')/${n_cpu_roles[$r]}, &#33410;&#28857;&#25968;:${n_num_roles[$r]} \n"</span>
<span style="color: #ffa54f;">       echo "&#38598;&#32676; [$r] CPU&#20351;&#29992;&#29575;$res, &#35831;&#27714;/&#24635;&#39069;(&#26680;):`awk 'BEGIN{printf "%.2f",'"(${n_cpu_request_roles[$r]}/1000)"'}'`/${n_cpu_roles[$r]}, &#33410;&#28857;&#25968;:${n_num_roles[$r]} "</span>
<span style="color: #ffa54f;">       caler ${n_memory_request_roles[$r]} "(${n_memory_roles[$r]}/1024)"</span>
<span style="color: #ffa54f;">       [ "`awk -v num1=$res -v num2=${node_memory_pre} 'BEGIN{print(num1&gt;num2)?"0":"1"}'`" == "0" ] &amp;&amp; monitor_info[${#monitor_info[*]}]="&#38598;&#32676; [$r] &#20869;&#23384;&#20351;&#29992;&#29575;&gt;${node_memory_pre}%, &#24403;&#21069;$res, &#35831;&#27714;/&#24635;&#39069;(Gi):`awk 'BEGIN{printf "%.2f",'"(${n_memory_request_roles[$r]}/1024)"'}'`/`awk 'BEGIN{printf "%.2f",'"(${n_memory_roles[$r]}/1024/1024)"'}'`, &#33410;&#28857;&#25968;:${n_num_roles[$r]}\n"</span>
<span style="color: #ffa54f;">       echo "&#38598;&#32676; [$r] &#20869;&#23384;&#20351;&#29992;&#29575;$res, &#35831;&#27714;/&#24635;&#39069;(Gi):`awk 'BEGIN{printf "%.2f",'"(${n_memory_request_roles[$r]}/1024)"'}'`/`awk 'BEGIN{printf "%.2f",'"(${n_memory_roles[$r]}/1024/1024)"'}'`, &#33410;&#28857;&#25968;:${n_num_roles[$r]}"</span>
<span style="color: #ffa54f;">   done</span>

<span style="color: #ffa54f;">}</span>

<span style="color: #ffa54f;">#dingding push</span>
<span style="color: #ffa54f;">function dingding() {</span>
<span style="color: #ffa54f;">local access_tokens=$1</span>
<span style="color: #ffa54f;">local ding_url='https://oapi.dingtalk.com/robot/send'</span>
<span style="color: #ffa54f;">local ding_header='Content-Type: application/json'</span>
<span style="color: #ffa54f;">local msg=$2</span>
<span style="color: #ffa54f;">for key in $access_tokens; do</span>
<span style="color: #ffa54f;">curl -s -connect-timeout 40 -XPOST -H "$ding_header" "$ding_url?access_token=$key" \</span>
<span style="color: #ffa54f;">-d '{"msgtype": "text",</span>
<span style="color: #ffa54f;">    "text": {</span>
<span style="color: #ffa54f;">        "content": "&#12304;&#22269;&#20869;&#39033;&#30446;&#25253;&#35686;&#65306;bj-prod-k8s&#12305; \n'"$msg"'"</span>
<span style="color: #ffa54f;">    },</span>
<span style="color: #ffa54f;">"at": {</span>
<span style="color: #ffa54f;">      "atMobiles": [],</span>
<span style="color: #ffa54f;">      "isAtAll": true</span>
<span style="color: #ffa54f;">  }</span>
<span style="color: #ffa54f;">}'</span>
<span style="color: #ffa54f;">done</span>
<span style="color: #ffa54f;">}</span>

<span style="color: #ffa54f;">function check_k8s() {</span>
<span style="color: #ffa54f;">    # node &#26816;&#26597;</span>
<span style="color: #ffa54f;">    check_node_status=`$kube_CMD get node |sed '1d'|awk  '$2 != "Ready"{print $1,$2}'`</span>
<span style="color: #ffa54f;">    [ -n "${check_node_status}" -a "${check_node_status}" != "\\n" ] &amp;&amp; monitor_info[${#monitor_info[*]}]="node&#24322;&#24120;&#65306;\n${check_node_status}"</span>
<span style="color: #ffa54f;">    node_check</span>
<span style="color: #ffa54f;">}</span>

<span style="color: #ffa54f;">main() {</span>
<span style="color: #ffa54f;">    check_k8s</span>
<span style="color: #ffa54f;">    #echo  -e "${monitor_info[@]}"</span>
<span style="color: #ffa54f;">    [ ${#monitor_info[@]} -gt 0 ] &amp;&amp; {</span>
<span style="color: #ffa54f;">        dingding "$tokens" "$(</span><span style="color: #ff00ff;">echo -e "${monitor_info[@]}"</span><span style="color: #ffa54f;">)"</span>
<span style="color: #ffa54f;">        echo -e "${monitor_info[@]}" &gt;&gt; ./logs/k8s_check_`date +"%Y-%m"`.log</span>
<span style="color: #ffa54f;">    }</span>
<span style="color: #ffa54f;">    :</span>
<span style="color: #ffa54f;">}</span>

<span style="color: #ffa54f;">main</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">namespace&#30417;&#25511;</span>
cat &lt;&lt;\EOF &gt; k8s_namespace_ding.sh 
<span style="color: #ffa54f;">#!/bin/bash</span>
<span style="color: #ffa54f;">set -e</span>
<span style="color: #ffa54f;">source /etc/profile</span>
<span style="color: #ffa54f;">PATH=/usr/local/bin/:$PATH</span>
<span style="color: #ffa54f;">#kube_conf_file=/etc/kubernetes/admin.conf</span>
<span style="color: #ffa54f;">kube_conf_file=/root/xuchangwei/config_prod</span>
<span style="color: #ffa54f;">kube_CMD="kubectl --kubeconfig=$kube_conf_file"</span>
<span style="color: #ffa54f;">namespace=$1</span>
<span style="color: #ffa54f;">cpu_num=95             # pod cpu&#20351;&#29992;&#29575; &#39044;&#35686;&#20540;(%)</span>
<span style="color: #ffa54f;">mem_num=90             # pod &#20869;&#23384;&#20351;&#29992;&#29575; &#39044;&#35686;&#20540;(%)</span>
<span style="color: #ffa54f;">mem_hpa=95             # pod hpa&#20869;&#23384;&#20351;&#29992;&#29575; &#39044;&#35686;&#20540;(%)</span>
<span style="color: #ffa54f;">pod_num=45             # pod &#21103;&#26412;&#25968; &#39044;&#35686;&#20540;(&#20010;)</span>
<span style="color: #ffa54f;">tokens="1923d7c93ff377813"</span>
<span style="color: #ffa54f;">#--------------------</span>
<span style="color: #ffa54f;">mkdir -p ./logs</span>
<span style="color: #ffa54f;">unset podname_limit</span>
<span style="color: #ffa54f;">unset podname_now</span>
<span style="color: #ffa54f;">unset monitor_info</span>
<span style="color: #ffa54f;">declare -A podname_limit</span>
<span style="color: #ffa54f;">declare -A podname_now</span>
<span style="color: #ffa54f;">declare -A monitor_info</span>

<span style="color: #ffa54f;">function check_cpu_mem(){</span>
<span style="color: #ffa54f;">    podnames=`$kube_CMD -n $namespace get pod |grep Running|awk '{print $1}'`</span>
<span style="color: #ffa54f;">    for p in $podnames; do </span>
<span style="color: #ffa54f;">        limit_cm=`$kube_CMD -n $namespace describe pod $p|grep -A 2 Limits|awk '{print $2}'|sed -n '2,3{N;s/\n/\@/p}'`</span>
<span style="color: #ffa54f;">        #echo "$p  ${limit_cm}"</span>
<span style="color: #ffa54f;">        [ -n "$limit_cm" ] &amp;&amp; podname_limit[$p]="${limit_cm}"</span>
<span style="color: #ffa54f;">    done</span>

<span style="color: #ffa54f;">    podnames_now=`sed -r 's#[ ]+#@#g'  &lt;($kube_CMD -n $namespace top pod|sed '1d')`</span>
<span style="color: #ffa54f;">    for n in ${podnames_now}; do </span>
<span style="color: #ffa54f;">        pname=`echo $n |awk -F@ '{print $1}'`</span>
<span style="color: #ffa54f;">        pinfo=`echo $n |awk -F@ '{print $2"@"$3}'`</span>
<span style="color: #ffa54f;">        [ -n "`$kube_CMD -n $namespace get pods $pname|awk '$NF~"([5-9]m|[1-5][0-9]m|d|h|y)"{print}'`" ] &amp;&amp; \</span>
<span style="color: #ffa54f;">            podname_now[$pname]=$pinfo</span>
<span style="color: #ffa54f;">    done</span>

<span style="color: #ffa54f;">}</span>

<span style="color: #ffa54f;">function caler() {</span>
<span style="color: #ffa54f;">    res=`awk 'BEGIN{printf "%.2f\n",'$1'/'$2'*100}'`</span>
<span style="color: #ffa54f;">}</span>


<span style="color: #ffa54f;">#dingding push</span>
<span style="color: #ffa54f;">function dingding() {</span>
<span style="color: #ffa54f;">local access_tokens=$1</span>
<span style="color: #ffa54f;">local ding_url='https://oapi.dingtalk.com/robot/send'</span>
<span style="color: #ffa54f;">local ding_header='Content-Type: application/json'</span>
<span style="color: #ffa54f;">local msg=$2</span>
<span style="color: #ffa54f;">for key in $access_tokens; do</span>
<span style="color: #ffa54f;">curl -s -connect-timeout 40 -XPOST -H "$ding_header" "$ding_url?access_token=$key" \</span>
<span style="color: #ffa54f;">-d '{"msgtype": "text",</span>
<span style="color: #ffa54f;">    "text": {</span>
<span style="color: #ffa54f;">        "content": "&#12304;&#22269;&#20869;&#39033;&#30446;&#25253;&#35686;&#65306;bj-prod-k8s-'"$namespace"'&#12305; \n'"$msg"'"</span>
<span style="color: #ffa54f;">    },</span>
<span style="color: #ffa54f;">"at": {</span>
<span style="color: #ffa54f;">      "atMobiles": [],</span>
<span style="color: #ffa54f;">      "isAtAll": true</span>
<span style="color: #ffa54f;">  }</span>
<span style="color: #ffa54f;">}'</span>
<span style="color: #ffa54f;">done</span>
<span style="color: #ffa54f;">}</span>

<span style="color: #ffa54f;">function check_k8s() {</span>
<span style="color: #ffa54f;">    ## &#26816;&#26597;pod&#25968;</span>
<span style="color: #ffa54f;">    #check_pod_num="`$kube_CMD -n $namespace get deploy |sed '1d'|awk '{split($2,num,"/");if(num[2]&gt;='"${pod_num}"')printf "%sPOD&#25968;%s&gt;=%s&#65292;&#35831;&#20851;&#27880;\n",$1,num[2],'"${pod_num}"'}'`\\n"</span>
<span style="color: #ffa54f;">    #[ -n "${check_pod_num}" -a "${check_pod_num}" != "\\n" ] &amp;&amp; monitor_info[${#monitor_info[*]}]="${check_pod_num}"</span>

<span style="color: #ffa54f;">    ## hpa &#20869;&#23384;&#19981;&#36275;&#65292;MAXPODS&#31561;&#20110;REPLICAS&#65292;TARGETS&#20013;&#22823;&#20110;70&#65292;&#26080;&#27861;&#21160;&#24577;&#20280;&#32553;</span>
<span style="color: #ffa54f;">    #hpa_info="`$kube_CMD get hpa -n $namespace |sed '1d' |awk '$5==$6{split($3,tag,"/");deploy[$1]=tag[1]; pnum[$1]=$6}END{for(d in deploy)if(deploy[d]&gt;'"${mem_hpa}"')printf "%s&#20869;&#23384;&#19981;&#36275;&#26080;&#27861;&#21160;&#24577;&#20280;&#32553;&#65292;&#24403;&#21069;&#20869;&#23384;%s&#65292;&#21103;&#26412;&#25968;%s&#20010;\\n",d,deploy[d],pnum[d]}'`\\n"</span>
<span style="color: #ffa54f;">    #[ -n "$hpa_info" -a "$hpa_info" != "\\n" ] &amp;&amp; monitor_info[${#monitor_info[*]}]="${hpa_info}"</span>

<span style="color: #ffa54f;">    ## pod cpu mem&#30417;&#25511;</span>
<span style="color: #ffa54f;">    #check_cpu_mem</span>
<span style="color: #ffa54f;">    #for p in ${!podname_limit[@]}; do</span>
<span style="color: #ffa54f;">    #    #echo $p </span>
<span style="color: #ffa54f;">    #    cpu_limit=`echo ${podname_limit[$p]}|awk -F@ '{print $1*1000}'`</span>
<span style="color: #ffa54f;">    #    mem_limit=`echo ${podname_limit[$p]}|awk -F@ '{print $2}'|sed 's#Mi##'`</span>
<span style="color: #ffa54f;">    #    [[ ${mem_limit} =~ "Gi" ]] &amp;&amp; mem_limit=`awk 'BEGIN{printf "%s",(int('"${mem_limit}"')*1024)}'`</span>
<span style="color: #ffa54f;">    #    cpu_now=`echo ${podname_now[$p]}|awk -F@ '{print $1}'|sed 's#m##'`</span>
<span style="color: #ffa54f;">    #    mem_now=`echo ${podname_now[$p]}|awk -F@ '{print $2}'|sed 's#Mi##'`</span>
<span style="color: #ffa54f;">    #</span>
<span style="color: #ffa54f;">    #    if [ -n "$cpu_now" -a -n "$mem_now" ]; then</span>
<span style="color: #ffa54f;">    #    caler $cpu_now $cpu_limit</span>
<span style="color: #ffa54f;">    #    [ "`awk -v num1=$res -v num2=${cpu_num} 'BEGIN{print(num1&gt;num2)?"0":"1"}'`" == "0" ] &amp;&amp; monitor_info[${#monitor_info[*]}]="$p CPU&#20351;&#29992;&#29575;&gt;${cpu_num}%, &#24403;&#21069;$res, &#24050;&#20351;&#29992;$cpu_now\n"</span>
<span style="color: #ffa54f;">    #    caler $mem_now $mem_limit</span>
<span style="color: #ffa54f;">    #    [ "`awk -v num1=$res -v num2=${mem_num} 'BEGIN{print(num1&gt;num2)?"0":"1"}'`" == "0" ] &amp;&amp; monitor_info[${#monitor_info[*]}]="$p &#20869;&#23384;&#20351;&#29992;&#29575;&gt;${mem_num}%, &#24403;&#21069;$res, &#24050;&#20351;&#29992;$mem_now Mi\n"</span>
<span style="color: #ffa54f;">    #    fi</span>
<span style="color: #ffa54f;">    #done</span>

<span style="color: #ffa54f;">    podnames_unrun=`$kube_CMD -n $namespace get pod |sed '1d'|awk '$(</span><span style="color: #ff00ff;">NF-3</span><span style="color: #ffa54f;">)~"0/" &amp;&amp; $NF!~"(^[1-6]m|^[1-60]s)"{print $1}'`</span>
<span style="color: #ffa54f;">    [ -n "${podnames_unrun}" -a "${podnames_unrun}" != "\\n" ] &amp;&amp; monitor_info[${#monitor_info[*]}]="pod&#21551;&#21160;&#22833;&#36133;\\n${podnames_unrun}\\n"</span>
<span style="color: #ffa54f;">    :</span>

<span style="color: #ffa54f;">    # events</span>
<span style="color: #ffa54f;">    #check_events_status=`$kube_CMD -n $namespace get events   --field-selector type=Warning,reason=FailedScheduling --sort-by='.metadata.creationTimestamp' -o 'go-template={{range .items}}{{.involvedObject.name}}{{"\t"}}{{.involvedObject.kind}}{{"\t"}}{{.message}}{{"\t"}}{{.reason}}{{"\t"}}{{.type}}{{"\t"}}{{.firstTimestamp}}{{"\n"}}{{end}}'`</span>
<span style="color: #ffa54f;">    #[ -n "${check_events_status}" -a "${check_events_status}" != "\\n" ] &amp;&amp; monitor_info[${#monitor_info[*]}]="node&#36164;&#28304;&#19981;&#22815;&#65306;\n${check_events_status}"</span>

<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">function monitor_k8s(){</span>
<span style="color: #ffa54f;">    # pod&#37325;&#21551;&#30417;&#25511;</span>
<span style="color: #ffa54f;">    podnames_restart=`$kube_CMD -n $namespace get pods |sed '1d'|awk '$(</span><span style="color: #ff00ff;">NF-1</span><span style="color: #ffa54f;">)&gt;0{print}' |awk '$NF~"(^[1-5]m)"{printf "%s@%s@%s\n",$1,$(</span><span style="color: #ff00ff;">NF-1</span><span style="color: #ffa54f;">),$NF}'`</span>
<span style="color: #ffa54f;">    #podnames_restart="$podnames_restart `$kube_CMD -n $namespace get pods |sed '1d'|awk '$(</span><span style="color: #ff00ff;">NF-1</span><span style="color: #ffa54f;">)&gt;0{print}' |awk '$NF!="(^[1-5]m)" &amp;&amp; $3!="Running"{split($2,num,"/");if(num[1]==0)printf "%s@%s@%s\n",$1,$(</span><span style="color: #ff00ff;">NF-1</span><span style="color: #ffa54f;">),$NF}'`"</span>
<span style="color: #ffa54f;">    podnames_restart="$podnames_restart `$kube_CMD -n $namespace get pods |sed '1d'|awk '$(</span><span style="color: #ff00ff;">NF-1</span><span style="color: #ffa54f;">)&gt;0{print}' |awk '$NF!="(^[1-5]m)"{split($2,num,"/");if(num[1]==0)printf "%s@%s@%s\n",$1,$(</span><span style="color: #ff00ff;">NF-1</span><span style="color: #ffa54f;">),$NF}'`"</span>
<span style="color: #ffa54f;">    for p in $podnames_restart; do</span>
<span style="color: #ffa54f;">        rname=`echo $p |awk -F@ '{print $1}'`</span>
<span style="color: #ffa54f;">        rinfo=`echo $p |awk -F@ '{print $3"&#20869;&#37325;&#21551;"$2"&#27425;"}'`</span>
<span style="color: #ffa54f;">        rinfo2=`$kube_CMD -n $namespace get pods $rname  -o go-template="{{range .status.containerStatuses}}{{.lastState.terminated.finishedAt}}@{{.lastState.terminated.reason}}{{end}}@{{.status.podIP}}@{{.status.hostIP}}"`</span>
<span style="color: #ffa54f;">        r_last_time=`date -d "@$(</span><span style="color: #ff00ff;">date -d "$(echo $rinfo2|awk -F@ '{print $1}'</span><span style="color: #ffa54f;">)" +%s)" +"%F %H:%M:%S"`</span>
<span style="color: #ffa54f;">        rinfo="$rname&#21457;&#29983;&#37325;&#21551;&#65292;$rinfo&#65292;&#26368;&#36817;$r_last_time&#65292;&#21407;&#22240;&#65306;$(</span><span style="color: #ff00ff;">echo $rinfo2|awk -F@ '{print $2}'</span><span style="color: #ffa54f;">)&#65292;&#23481;&#22120;ip/&#33410;&#28857;ip:$(</span><span style="color: #ff00ff;">echo $rinfo2|awk -F@ '{print $3}'</span><span style="color: #ffa54f;">)/$(</span><span style="color: #ff00ff;">echo $rinfo2|awk -F@ '{print $4}'</span><span style="color: #ffa54f;">)\n"</span>
<span style="color: #ffa54f;">        monitor_info[${#monitor_info[*]}]="$rinfo"</span>
<span style="color: #ffa54f;">    done</span>
<span style="color: #ffa54f;">    [ ${#monitor_info[@]} -gt 0 ] &amp;&amp; {</span>
<span style="color: #ffa54f;">        # PL&#25253;&#35686;&#32676;</span>
<span style="color: #ffa54f;">        dingding "a74e7f47383f0c7585f34d" "$(</span><span style="color: #ff00ff;">echo -e "${monitor_info[@]}"</span><span style="color: #ffa54f;">)"</span>
<span style="color: #ffa54f;">    } </span>
<span style="color: #ffa54f;">    :</span>
<span style="color: #ffa54f;">}</span>

<span style="color: #ffa54f;">main() {</span>
<span style="color: #ffa54f;">    monitor_k8s</span>
<span style="color: #ffa54f;">    check_k8s</span>
<span style="color: #ffa54f;">    #echo  -e "${monitor_info[@]}"</span>
<span style="color: #ffa54f;">    [ ${#monitor_info[@]} -gt 0 ] &amp;&amp; {</span>
<span style="color: #ffa54f;">        dingding "$tokens" "$(</span><span style="color: #ff00ff;">echo -e "${monitor_info[@]}"</span><span style="color: #ffa54f;">)"</span>
<span style="color: #ffa54f;">        echo -e "${monitor_info[@]}" &gt;&gt; ./logs/k8s_check_`date +"%Y-%m"`.log</span>
<span style="color: #ffa54f;">    }</span>
<span style="color: #ffa54f;">    :</span>
<span style="color: #ffa54f;">}</span>

<span style="color: #ffa54f;">main</span>
<span style="color: #ffa54f;">echo $1</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
