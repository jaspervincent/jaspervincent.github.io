<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>scripts-monitor</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/font.css"/>
<link rel="stylesheet" type="text/css" href="/static/drollery.e825b870.css"/>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
</head>
<body>
<header id="preamble" class="status">
<header class="{className}" data-astro-cid-3ef6ksr2>
  <div class=header-branding data-astro-cid-g2lrb5xm>
      <span class=header-text data-astro-cid-g2lrb5xm>
          <span class=dropcap data-astro-cid-g2lrb5xm aria-hidden=true>
              <span class=actual data-astro-cid-g2lrb5xm>J</span>
              <span class=rest data-astro-cid-g2lrb5xm>asper Hsu</span>
              <span class=period data-astro-cid-g2lrb5xm>.</span>
          </span>
          <span class=sr-only data-astro-cid-g2lrb5xm>Drollery</span>
      </span>
      <img alt="Medieval drollery of a knight on a horse" class=spring decoding=async height=250 loading=lazy src=/images/knight-horse.a96eee7d_Z1WCOYs.webp width=68 data-astro-cid-g2lrb5xm>
  </div>

  <nav data-astro-cid-pux6a34n>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/jcodelog.html class=nobracket data-astro-cid-pux6a34n>技术</a>
      <span class=flower2 data-astro-cid-pux6a34n>K</span>
      <a href=/reading/index.html class=nobracket data-astro-cid-pux6a34n>阅读</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
      <a href=/archives.html class=nobracket data-astro-cid-pux6a34n>归档</a>
      <span class=flower2 data-astro-cid-pux6a34n>L</span>
      <a href=/link/index.html class=nobracket data-astro-cid-pux6a34n>友链</a>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/about.html class=nobracket data-astro-cid-pux6a34n>关于</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
  </nav>


  <div class="container" data-astro-cid-3ef6ksr2>
    <p class="info" data-astro-cid-3ef6ksr2>
              🏆 欢迎来到本站：
              <a href="https://xuchangwei.com/">https://xuchangwei.com/</a>。
              <strong>希望这里有你感兴趣的内容</strong>。
            </p>
  </div>
  <div id=borderArtWrapper class="tt1" data-astro-cid-5hce7sga data-turbo-permanent>
      <script>
          var man, shakeCount = 0, noSound = new Audio("/audio/effects/no.m4a"), screamSound = new Audio("/audio/effects/scream.m4a");
          function animateManShakeHandler() {
              man.removeEventListener("animationend", animateManShakeHandler, !1),
              shakeCount += 1,
              man.classList.remove("shakeMan")
          }
          function animateManFallHandler() {
              man.removeEventListener("animationend", animateManFallHandler, !1),
              man.classList.add("hide")
          }
          function animateMan() {
              man = man ?? document.getElementById("borderMan"),
              3 === shakeCount ? (man.classList.add("fallMan"),
              screamSound.play(),
              man.addEventListener("animationend", animateManFallHandler, !1)) : (man.classList.add("shakeMan"),
              noSound.play(),
              man.addEventListener("animationend", animateManShakeHandler, !1))
          }
      </script>
      <div class=borderArt data-astro-cid-5dda5nwp id=articleBorder>
          <img alt="flowery border with man falling" decoding=async height=620 loading=lazy src=/images/border-vines-no-man.b7d246cc_DRxSe.webp width=909 class=border data-astro-cid-5dda5nwp>
          <div class=fallWrapper data-astro-cid-5dda5nwp>
              <img alt="flowery border with man falling" decoding=async height=292 loading=lazy src=/images/man-no-vines.247a3187_Z2ioXNM.webp width=98 class=man data-astro-cid-5dda5nwp id=borderMan onclick=animateMan()>
          </div>
      </div>
  </div>
</header>
</header>
<main class="container" id="content" class="content">
<header>
<h1 class="title">scripts-monitor</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:5defa03d-c8f2-4307-a0a9-ba835f4d701b">监控_rabbitmq</a></li>
<li><a href="#h:b9afa82a-7b3e-497c-b1ec-2c24b7ccc897">监控_实时文件对比</a></li>
<li><a href="#h:eac0ad2a-2b28-4ab1-b28d-1bd17998500e">监控_网络流量</a>
<ul>
<li><a href="#h:f36c9204-573a-4168-a480-bf0909a534ee">监控_网络流量1</a></li>
<li><a href="#h:a42010eb-afce-4eee-a1fb-2e6aa0555895">监控_网络流量2</a></li>
</ul>
</li>
<li><a href="#h:986c1252-31a6-407d-831a-699573410f1f">监控_连接数检查</a></li>
<li><a href="#h:356fe2c1-f269-48e7-954a-9810563e7d6e">监控-marathon-check</a></li>
<li><a href="#h:b73a8850-4e2e-4774-9e18-ae426741fc99">高峰关闭服务</a></li>
<li><a href="#h:1afde075-2ee4-499a-9451-7fe9d84fd56d">prometheus</a>
<ul>
<li><a href="#h:8748d3fe-8b3b-4eb9-9c3a-ec9216e4e62b">阿里SLS分析</a></li>
</ul>
</li>
<li><a href="#h:fb49990a-421f-4368-9a44-f96a808530db">openflcon</a>
<ul>
<li><a href="#h:18e1e22c-e42f-4020-a5ac-e5e5d59320c0">网络质量监控脚本</a></li>
<li><a href="#h:725329d7-d66d-4578-aeaf-c3cc41e813e9">openflacon-zookeeeper</a></li>
<li><a href="#h:294b25b4-1d3a-4777-b478-51dc1a70deed">服务监控治理</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../index.html">Script</a></li>
</ul>
<section id="outline-container-h:5defa03d-c8f2-4307-a0a9-ba835f4d701b" class="outline-2">
<h2 id="h:5defa03d-c8f2-4307-a0a9-ba835f4d701b">监控_rabbitmq</h2>
<div class="outline-text-2" id="text-h:5defa03d-c8f2-4307-a0a9-ba835f4d701b">
<div class="org-src-container">
<pre class="src src-sh">monitor_rabbitmq.sh

<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">20140102</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">AUTHOR coolber</span>

<span style="color: #a0522d;">DATE</span>=$(date <span style="color: #8b2252;">"+%F %T"</span>)
<span style="color: #a0522d;">MONITOR_LOG</span>=/root/scripts/log/monitor_rabbitmq_queue.log
<span style="color: #a0522d;">RECEIVE_MAILER2</span>=changwei.xu@cici.com
<span style="color: #a0522d;">METRIC_NUM</span>=100


<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"### ${DATE} Rabbitmq queue ###"</span> &gt;$<span style="color: #a0522d;">MONITOR_LOG</span>

/usr/local/rabbitmq/sbin/rabbitmqctl list_queues &gt;&gt;$<span style="color: #a0522d;">MONITOR_LOG</span>

<span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">?</span> -eq 0 ]
<span style="color: #a020f0;">then</span>
    <span style="color: #a020f0;">while </span><span style="color: #483d8b;">read</span> i
    <span style="color: #a020f0;">do</span>
        <span style="color: #a0522d;">CUR_NUM</span>=$( <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">i</span> | awk <span style="color: #8b2252;">'{ print $NF }'</span> | grep -vE <span style="color: #8b2252;">'^#|^$'</span> | grep -E <span style="color: #8b2252;">'[0-9]+'</span> )
        <span style="color: #b22222;">#</span><span style="color: #b22222;">if [[ ! -z $CUR_NUM &amp;&amp; $METRIC_NUM -gt $CUR_NUM ]]</span>
        <span style="color: #a020f0;">if</span> [[ $<span style="color: #a0522d;">METRIC_NUM</span> -lt $<span style="color: #a0522d;">CUR_NUM</span> ]]
        <span style="color: #a020f0;">then</span>
            <span style="color: #b22222;">#</span><span style="color: #b22222;">echo -e "### $DATE #### \n${i} " | mail -s "Host: nameserver,rabbitmq queue is Abnormal" $RECEIVE_MAILER</span>
            <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"### $DATE #### \n${i} "</span> | mail -s <span style="color: #8b2252;">"Host: nameserver,rabbitmq queue is Abnormal"</span> $<span style="color: #a0522d;">RECEIVE_MAILER2</span>
        <span style="color: #a020f0;">fi</span>
    <span style="color: #a020f0;">done</span> &lt;${<span style="color: #a0522d;">MONITOR_LOG</span>}
<span style="color: #a020f0;">else</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">echo "rabbitmq queue info Abnormal" | mail -s  " rabbitmq service is maybe Unavailable " $RECEIVE_MAILER</span>
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"rabbitmq queue info Abnormal"</span> | mail -s  <span style="color: #8b2252;">" rabbitmq service is maybe Unavailable "</span> $<span style="color: #a0522d;">RECEIVE_MAILER2</span>
<span style="color: #a020f0;">fi</span>
</pre>
</div>
</div>
</section>
<section id="outline-container-h:b9afa82a-7b3e-497c-b1ec-2c24b7ccc897" class="outline-2">
<h2 id="h:b9afa82a-7b3e-497c-b1ec-2c24b7ccc897">监控_实时文件对比</h2>
<div class="outline-text-2" id="text-h:b9afa82a-7b3e-497c-b1ec-2c24b7ccc897">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#65281;/bin/bash</span>
<span style="color: #a0522d;">DATE</span>=$(date <span style="color: #8b2252;">"+%F %T"</span>)
<span style="color: #a0522d;">i</span>=0
<span style="color: #a0522d;">interval</span>=1700

<span style="color: #a0522d;">old_date</span>=(<span style="color: #ff00ff;">`tail -1 /mnt/logs/consumer/apps_consumer.log|sed 's#\([^ ]*\) \([^,]*\),\([0-9]*\)\(\[.*\)#\1 \2 \3 \4#g'`</span>)
<span style="color: #a0522d;">old_date_d</span>=${<span style="color: #a0522d;">old_date</span>[0]}
<span style="color: #a0522d;">old_date_h</span>=${<span style="color: #a0522d;">old_date</span>[1]}
<span style="color: #a0522d;">old_java_n</span>=${<span style="color: #a0522d;">old_date</span>[2]}

<span style="color: #a0522d;">count</span>=$[1700/$<span style="color: #a0522d;">interval</span>]   <span style="color: #b22222;"># </span><span style="color: #b22222;">$[]&#21482;&#33021;&#36827;&#34892;&#25972;&#25968;&#36816;&#31639;</span>
<span style="color: #a0522d;">RECEIVE_MAILER1</span>=xiahua.yan@emacle.com
<span style="color: #a0522d;">RECEIVE_MAILER2</span>=changwei.xu@emacle.com

<span style="color: #a020f0;">while</span> [ $<span style="color: #a0522d;">i</span> -lt $<span style="color: #a0522d;">count</span> ]
<span style="color: #a020f0;">do</span>
    sleep $<span style="color: #a0522d;">interval</span>
    <span style="color: #a0522d;">new_date</span>=(<span style="color: #ff00ff;">`tail -1 /mnt/logs/consumer/apps_consumer.log|sed 's#\([^ ]*\) \([^,]*\),\([0-9]*\)\(\[.*\)#\1 \2 \3 \4#g'`</span>)
    <span style="color: #a0522d;">new_date_d</span>=${<span style="color: #a0522d;">new_date</span>[0]}
    <span style="color: #a0522d;">new_date_h</span>=${<span style="color: #a0522d;">new_date</span>[1]}
    <span style="color: #a0522d;">new_java_n</span>=${<span style="color: #a0522d;">new_date</span>[2]}
<span style="color: #b22222;">#</span><span style="color: #b22222;">if [ ${old_date_d} == $(tail -1 /mnt/logs/consumer/apps_consumer.log|sed 's#\([^ ]*\) \([^,]*\).*#\1#g') -a ${old_date_h} == $(tail -1 /mnt/logs/consumer/apps_consumer.log|sed 's#\([^ ]*\) \([^,]*\).*#\2#g')  ];then</span>
    <span style="color: #a020f0;">if</span> [ ${<span style="color: #a0522d;">old_date_d</span>} == ${<span style="color: #a0522d;">new_date_d</span>} -a ${<span style="color: #a0522d;">old_date_h</span>} == ${<span style="color: #a0522d;">new_date_h</span>} -a ${<span style="color: #a0522d;">old_java_n</span>} == ${<span style="color: #a0522d;">new_java_n</span>} ];<span style="color: #a020f0;">then</span>
        <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"### $DATE #### \n'/mnt/logs/consumer/apps_consumer.log  not updated' \n consumer_info:\n ${new_date[@]} "</span> | mail -s <span style="color: #8b2252;">"Host(134): searchlog,rabbitmq queue is Abnormal"</span> $<span style="color: #a0522d;">RECEIVE_MAILER1</span>
        <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"### $DATE #### \n'/mnt/logs/consumer/apps_consumer.log  not updated' \n consumer_info:\n ${new_date[@]} "</span> | mail -s <span style="color: #8b2252;">"Host(134): searchlog,rabbitmq queue is Abnormal"</span> $<span style="color: #a0522d;">RECEIVE_MAILER2</span>
    <span style="color: #a020f0;">fi</span>
    ((i++))
<span style="color: #a020f0;">done</span>
</pre>
</div>
</div>
</section>
<section id="outline-container-h:eac0ad2a-2b28-4ab1-b28d-1bd17998500e" class="outline-2">
<h2 id="h:eac0ad2a-2b28-4ab1-b28d-1bd17998500e">监控_网络流量</h2>
<div class="outline-text-2" id="text-h:eac0ad2a-2b28-4ab1-b28d-1bd17998500e">
</div>
<div id="outline-container-h:f36c9204-573a-4168-a480-bf0909a534ee" class="outline-3">
<h3 id="h:f36c9204-573a-4168-a480-bf0909a534ee">监控_网络流量1</h3>
<div class="outline-text-3" id="text-h:f36c9204-573a-4168-a480-bf0909a534ee">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/</span><span style="color: #a020f0;">bash</span>
<span style="color: #a0522d;">PATH</span>=/bin:/usr/bin:/sbin:/usr/sbin:/usr/local/bin:/usr/local/sbin;
<span style="color: #483d8b;">export</span> PATH

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26412;&#22320;&#32593;&#21345;&#21517;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">local nic_arr=(`ifconfig | grep -E -o "^[a-z0-9]+" | grep -v "lo" | uniq`)</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26412;&#22320;&#32593;&#21345;&#20010;&#25968;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">local nicLen=${#nic_arr[@]}</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">eth=$nic_arr</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#27969;&#37327;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">traffic_be=(`awk -v eth=$eth -F'[: ]+' '{if ($0 ~eth){print $3,$11}}' /proc/net/dev`)</span>


<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">traffic_monitor</span> {
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31995;&#32479;&#29256;&#26412;</span>
  <span style="color: #a0522d;">OS_NAME</span>=$(sed -n <span style="color: #8b2252;">'1p'</span> /etc/issue)
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32593;&#21475;&#21517;</span>
  <span style="color: #a0522d;">eth</span>=$<span style="color: #a0522d;">1</span>
  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21028;&#26029;&#32593;&#21345;&#23384;&#22312;&#19982;&#21542;,&#19981;&#23384;&#22312;&#21017;&#36864;&#20986;</span>
  <span style="color: #a020f0;">if</span> [ ! -d /sys/class/net/$<span style="color: #a0522d;">eth</span> ];<span style="color: #a020f0;">then</span>
      <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"Network-Interface Not Found"</span>
      <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"You system have network-interface:\n`ls /sys/class/net`"</span>
      <span style="color: #a020f0;">exit</span> 5
  <span style="color: #a020f0;">fi</span>
  <span style="color: #a020f0;">while</span> [ <span style="color: #8b2252;">"1"</span> ]
  <span style="color: #a020f0;">do</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29366;&#24577;</span>
    <span style="color: #a0522d;">STATUS</span>=<span style="color: #8b2252;">"fine"</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;&#24403;&#21069;&#26102;&#21051;&#32593;&#21475;&#25509;&#25910;&#19982;&#21457;&#36865;&#30340;&#27969;&#37327;</span>
    <span style="color: #a0522d;">RXpre</span>=$(cat /proc/net/dev | grep $<span style="color: #a0522d;">eth</span> | tr : <span style="color: #8b2252;">" "</span> | awk <span style="color: #8b2252;">'{print $2}'</span>)
    <span style="color: #a0522d;">TXpre</span>=$(cat /proc/net/dev | grep $<span style="color: #a0522d;">eth</span> | tr : <span style="color: #8b2252;">" "</span> | awk <span style="color: #8b2252;">'{print $10}'</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;1&#31186;&#21518;&#32593;&#21475;&#25509;&#25910;&#19982;&#21457;&#36865;&#30340;&#27969;&#37327;</span>
    sleep 1
    <span style="color: #a0522d;">RXnext</span>=$(cat /proc/net/dev | grep $<span style="color: #a0522d;">eth</span> | tr : <span style="color: #8b2252;">" "</span> | awk <span style="color: #8b2252;">'{print $2}'</span>)
    <span style="color: #a0522d;">TXnext</span>=$(cat /proc/net/dev | grep $<span style="color: #a0522d;">eth</span> | tr : <span style="color: #8b2252;">" "</span> | awk <span style="color: #8b2252;">'{print $10}'</span>)
    clear
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;&#36825;1&#31186;&#38047;&#23454;&#38469;&#30340;&#36827;&#20986;&#27969;&#37327;</span>
    <span style="color: #a0522d;">RX</span>=$((${<span style="color: #a0522d;">RXnext</span>}-${<span style="color: #a0522d;">RXpre</span>}))
    <span style="color: #a0522d;">TX</span>=$((${<span style="color: #a0522d;">TXnext</span>}-${<span style="color: #a0522d;">TXpre</span>}))
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21028;&#26029;&#25509;&#25910;&#27969;&#37327;&#22914;&#26524;&#22823;&#20110;MB&#25968;&#37327;&#32423;&#21017;&#26174;&#31034;MB&#21333;&#20301;,&#21542;&#21017;&#26174;&#31034;KB&#25968;&#37327;&#32423;</span>
    <span style="color: #a020f0;">if</span> [[ $<span style="color: #a0522d;">RX</span> -lt 1024 ]];<span style="color: #a020f0;">then</span>
      <span style="color: #a0522d;">RX</span>=<span style="color: #8b2252;">"${RX}B/s"</span>
    <span style="color: #a020f0;">elif</span> [[ $<span style="color: #a0522d;">RX</span> -gt 1048576 ]];<span style="color: #a020f0;">then</span>
      <span style="color: #a0522d;">RX</span>=$(<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">RX</span> | awk <span style="color: #8b2252;">'{print $1/1048576 "MB/s"}'</span>)
      $<span style="color: #a0522d;">STATUS</span>=<span style="color: #8b2252;">"busy"</span>
    <span style="color: #a020f0;">else</span>
      <span style="color: #a0522d;">RX</span>=$(<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">RX</span> | awk <span style="color: #8b2252;">'{print $1/1024 "KB/s"}'</span>)
    <span style="color: #a020f0;">fi</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21028;&#26029;&#21457;&#36865;&#27969;&#37327;&#22914;&#26524;&#22823;&#20110;MB&#25968;&#37327;&#32423;&#21017;&#26174;&#31034;MB&#21333;&#20301;,&#21542;&#21017;&#26174;&#31034;KB&#25968;&#37327;&#32423;</span>
    <span style="color: #a020f0;">if</span> [[ $<span style="color: #a0522d;">TX</span> -lt 1024 ]];<span style="color: #a020f0;">then</span>
      <span style="color: #a0522d;">TX</span>=<span style="color: #8b2252;">"${TX}B/s"</span>
      <span style="color: #a020f0;">elif</span> [[ $<span style="color: #a0522d;">TX</span> -gt 1048576 ]];<span style="color: #a020f0;">then</span>
      <span style="color: #a0522d;">TX</span>=$(<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">TX</span> | awk <span style="color: #8b2252;">'{print $1/1048576 "MB/s"}'</span>)
    <span style="color: #a020f0;">else</span>
      <span style="color: #a0522d;">TX</span>=$(<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">TX</span> | awk <span style="color: #8b2252;">'{print $1/1024 "KB/s"}'</span>)
    <span style="color: #a020f0;">fi</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#21360;&#20449;&#24687;    echo -e "Date:   `date +%F`"</span>
 <span style="color: #b22222;">#   </span><span style="color: #b22222;">echo -e "Time:   `date +%k:%M:%S`"</span>
 <span style="color: #b22222;">#   </span><span style="color: #b22222;">echo -e "Port:   $1"</span>
 <span style="color: #b22222;">#   </span><span style="color: #b22222;">echo -e "Status: $STATUS"</span>
 <span style="color: #b22222;">#   </span><span style="color: #b22222;">echo -e  " \t     RX \tTX"</span>
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"------------------------------"</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#21360;&#23454;&#26102;&#27969;&#37327;</span>
    <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"Time:`date +%k:%M:%S` $eth \t 'RX:'$RX   'TX:'$TX "</span>
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"------------------------------"</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36864;&#20986;&#20449;&#24687;</span>
    <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"Press 'Ctrl+C' to exit"</span>
  <span style="color: #a020f0;">done</span>
}
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21028;&#26029;&#25191;&#34892;&#21442;&#25968;</span>
<span style="color: #a020f0;">if</span> [[ -n <span style="color: #8b2252;">"$1"</span> ]];<span style="color: #a020f0;">then</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25191;&#34892;&#20989;&#25968;</span>
  traffic_monitor $<span style="color: #a0522d;">1</span>
<span style="color: #a020f0;">else</span>
  <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"None parameter,please add system netport after run the script! \nExample: 'sh traffic_monitor eth0'"</span>
<span style="color: #a020f0;">fi</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a42010eb-afce-4eee-a1fb-2e6aa0555895" class="outline-3">
<h3 id="h:a42010eb-afce-4eee-a1fb-2e6aa0555895">监控_网络流量2</h3>
<div class="outline-text-3" id="text-h:a42010eb-afce-4eee-a1fb-2e6aa0555895">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/</span><span style="color: #a020f0;">bash</span>
<span style="color: #a0522d;">R2</span>=<span style="color: #ff00ff;">`cat /sys/class/net/$1/statistics/rx_bytes`</span>
<span style="color: #a0522d;">T2</span>=<span style="color: #ff00ff;">`cat /sys/class/net/$1/statistics/tx_bytes`</span>
<span style="color: #a0522d;">NUM</span>=100000
<span style="color: #a020f0;">if</span> [ -z <span style="color: #8b2252;">"$1"</span> ]; <span style="color: #a020f0;">then</span>
        <span style="color: #483d8b;">echo</span>
        <span style="color: #483d8b;">echo</span> usage: $<span style="color: #a0522d;">0</span> network-interface
        <span style="color: #483d8b;">echo</span>
        <span style="color: #483d8b;">echo</span> e.g. $<span style="color: #a0522d;">0</span> eth0
        <span style="color: #483d8b;">echo</span>
        <span style="color: #a020f0;">exit</span>
<span style="color: #a020f0;">fi</span>
<span style="color: #a0522d;">IF</span>=$<span style="color: #a0522d;">1</span>
<span style="color: #a020f0;">while </span><span style="color: #483d8b;">true</span>
<span style="color: #a020f0;">do</span>
        <span style="color: #a0522d;">R1</span>=<span style="color: #ff00ff;">`cat /sys/class/net/$1/statistics/rx_bytes`</span>
        <span style="color: #a0522d;">T1</span>=<span style="color: #ff00ff;">`cat /sys/class/net/$1/statistics/tx_bytes`</span>
        <span style="color: #a0522d;">TBPS</span>=<span style="color: #ff00ff;">`expr $T1 - $T2`</span>
        <span style="color: #a0522d;">RBPS</span>=<span style="color: #ff00ff;">`expr $R1 - $R2`</span>
        <span style="color: #a0522d;">TKBPS</span>=<span style="color: #ff00ff;">`expr $TBPS / 1024`</span>
        <span style="color: #a0522d;">RKBPS</span>=<span style="color: #ff00ff;">`expr $RBPS / 1024`</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">RKBPS1=`echo "scale=3; $RBPS/$NUM"|bc`</span>
        <span style="color: #483d8b;">eval</span> <span style="color: #ff00ff;">`date "+day=%d; month=%m; year=%Y; hour=%H; minute=%M second=%S"`</span>
        <span style="color: #a0522d;">INSTFIL4</span>=<span style="color: #8b2252;">"$hour:$minute:$second"</span>
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$INSTFIL4 tx $1: $TKBPS kb/ rx $RKBPS kb/s "</span>

        <span style="color: #a0522d;">R2</span>=<span style="color: #ff00ff;">`cat /sys/class/net/$1/statistics/rx_bytes`</span>
        <span style="color: #a0522d;">T2</span>=<span style="color: #ff00ff;">`cat /sys/class/net/$1/statistics/tx_bytes`</span>
        sleep 1s
<span style="color: #a020f0;">done</span>
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:986c1252-31a6-407d-831a-699573410f1f" class="outline-2">
<h2 id="h:986c1252-31a6-407d-831a-699573410f1f">监控_连接数检查</h2>
<div class="outline-text-2" id="text-h:986c1252-31a6-407d-831a-699573410f1f">
<div class="org-src-container">
<pre class="src src-sh">cat &lt;&lt;\EOF&gt; monitor_conntrack.sh
<span style="color: #ffa54f;">#!/bin/bash</span>

<span style="color: #ffa54f;">#set -x</span>
<span style="color: #ffa54f;">#CON_NUM=$(wc -l /proc/net/ip_conntrack | awk '{print $1}')</span>
<span style="color: #ffa54f;">#CON_NUM=$(cat /proc/sys/net/ipv4/netfilter/ip_conntrack_count)</span>
<span style="color: #ffa54f;">CON_NUM=$(cat /proc/sys/net/netfilter/nf_conntrack_count)</span>
<span style="color: #ffa54f;">TRACK_LOG=/root/tools/logs/conntrack.log</span>
<span style="color: #ffa54f;">ALARM_NUM=50000</span>
<span style="color: #ffa54f;">REC_MAILER='changwei.xu@emacle.com'</span>
<span style="color: #ffa54f;">DATE=$(date '+%F %T')</span>
<span style="color: #ffa54f;">HOST_NAME=$(hostname)</span>

<span style="color: #ffa54f;">echo "$DATE  $HOST_NAME Current conntrack number is $CON_NUM " &gt;&gt;$TRACK_LOG</span>
<span style="color: #ffa54f;">if [ $ALARM_NUM -le $CON_NUM ]</span>
<span style="color: #ffa54f;">then</span>
<span style="color: #ffa54f;">    echo "$DATE $HOST_NAME Current conntrack number is $CON_NUM "| mail -s 'Conntrack alarm' $REC_MAILER</span>
<span style="color: #ffa54f;">fi</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>
</div>
</section>
<section id="outline-container-h:356fe2c1-f269-48e7-954a-9810563e7d6e" class="outline-2">
<h2 id="h:356fe2c1-f269-48e7-954a-9810563e7d6e">监控-marathon-check</h2>
<div class="outline-text-2" id="text-h:356fe2c1-f269-48e7-954a-9810563e7d6e">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/python</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">-*- coding: utf-8 -*-</span>
<span style="color: #a020f0;">import</span> urllib2
<span style="color: #a020f0;">import</span> sys
<span style="color: #a020f0;">import</span> subprocess
<span style="color: #a020f0;">import</span> urllib
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> socket
<span style="color: #a020f0;">import</span> os,re
<span style="color: #a020f0;">import</span> requests,json
<span style="color: #a020f0;">import</span> commands

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_host_ip</span>():
    <span style="color: #a020f0;">try</span>:
        <span style="color: #a0522d;">s</span> = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        s.connect((<span style="color: #8b2252;">'8.8.8.8'</span>, 80))
        <span style="color: #a0522d;">ip</span> = s.getsockname()[0]
    <span style="color: #a020f0;">finally</span>:
        s.close()
    <span style="color: #a020f0;">return</span> ip
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_nginx_conf</span>():
    <span style="color: #a0522d;">apps</span> = []
    <span style="color: #a020f0;">try</span>:
       <span style="color: #a020f0;">if</span> os.path.exists(<span style="color: #8b2252;">"/home/sh/nginx_marathon/nginx_conf.sh"</span>):
           os.system(<span style="color: #8b2252;">'/usr/bin/sh /home/sh/nginx_marathon/nginx_conf.sh'</span>)
       <span style="color: #a020f0;">if</span> os.path.exists(<span style="color: #8b2252;">"/home/sh/nginx_marathon/nginx_conf"</span>):
           <span style="color: #a0522d;">fs</span> = commands.getoutput(<span style="color: #8b2252;">'cat /home/sh/nginx_marathon/nginx_conf'</span>)
           <span style="color: #a020f0;">if</span> fs:
               <span style="color: #a0522d;">b</span>=re.<span style="color: #483d8b;">compile</span>(<span style="color: #8b2252;">'^upstream\s*(.\S*)\s*{</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">\s+(.*)'</span>,re.MULTILINE)
               <span style="color: #a0522d;">tags</span> = (b.findall(fs))
               <span style="color: #b22222;">#</span><span style="color: #b22222;">print tags</span>
               <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> tags:
                   <span style="color: #a020f0;">try</span>:
                       <span style="color: #b22222;">#</span><span style="color: #b22222;">b=re.findall('(.*)-\d+',i[0])[0]</span>
                       <span style="color: #a0522d;">d</span>=re.<span style="color: #483d8b;">compile</span>(<span style="color: #8b2252;">'(\d+.\d+.\d+.\d+)+'</span>,re.MULTILINE)
                       apps.append([re.findall(<span style="color: #8b2252;">'(.*)-\d+'</span>,i[0])[0],d.findall(i[1])])
                   <span style="color: #a020f0;">except</span>:
                       <span style="color: #a020f0;">continue</span>
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">str</span>(e))
    <span style="color: #a020f0;">return</span> apps

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">dindin</span>(token,msg):
    <span style="color: #a020f0;">try</span>:
        <span style="color: #a0522d;">dindinapi</span> = <span style="color: #8b2252;">'https://oapi.dingtalk.com/robot/send?access_token=%s'</span> % token
        <span style="color: #a0522d;">headers</span> = {<span style="color: #8b2252;">'content-type'</span>: <span style="color: #8b2252;">'application/json'</span>,<span style="color: #8b2252;">'charset'</span>:<span style="color: #8b2252;">'utf-8'</span>}
        <span style="color: #a0522d;">data</span>  = {
         <span style="color: #8b2252;">"msgtype"</span>: <span style="color: #8b2252;">"text"</span>,
         <span style="color: #8b2252;">"text"</span>: {
         <span style="color: #8b2252;">"content"</span>: msg
         },
         <span style="color: #8b2252;">"at"</span>: {
         <span style="color: #8b2252;">"atMobiles"</span>: [
         ],
         <span style="color: #8b2252;">"isAtAll"</span>: <span style="color: #008b8b;">True</span>
         }
        }
        <span style="color: #a0522d;">req</span>=requests.post(dindinapi,json=data,headers=headers)
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">str</span>(e))
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">check_marathon</span>():
    <span style="color: #a020f0;">try</span>:
        <span style="color: #a0522d;">marathon_ip</span> = <span style="color: #8b2252;">'192.168.101.150'</span>
        <span style="color: #a0522d;">host_ip</span> = get_host_ip()
        <span style="color: #a0522d;">hostname</span> = commands.getoutput(<span style="color: #8b2252;">'hostname'</span>)
        <span style="color: #a0522d;">tokens</span> = <span style="color: #8b2252;">'a6184389010ffc41f045ab23eab3d40f8ebe1cd9526e7832a131d718aa13057c'</span>
        <span style="color: #a0522d;">apps</span> = get_nginx_conf()
        <span style="color: #a0522d;">r</span> = requests.Session()
        r.<span style="color: #a0522d;">auth</span> = (<span style="color: #8b2252;">'wowotuan'</span>,<span style="color: #8b2252;">'wowotuan'</span>)
        <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> apps:
            <span style="color: #a020f0;">if</span> i[0]:
                <span style="color: #a020f0;">try</span>:
                    <span style="color: #a0522d;">s</span> = r.get(<span style="color: #8b2252;">'http://%s:8080/v2/apps/%s'</span> % (marathon_ip,i[0].encode(<span style="color: #8b2252;">'utf8'</span>)))
                    <span style="color: #a0522d;">app_infos</span> = s.json()[<span style="color: #8b2252;">'app'</span>]
                    <span style="color: #a0522d;">hosts</span> = []
                    <span style="color: #a020f0;">if</span> app_infos:
                        <span style="color: #a020f0;">for</span> task <span style="color: #a020f0;">in</span> app_infos[<span style="color: #8b2252;">'tasks'</span>]:
                            hosts.append(task[<span style="color: #8b2252;">'host'</span>].encode(<span style="color: #8b2252;">'utf8'</span>))
                    <span style="color: #a020f0;">for</span> ip <span style="color: #a020f0;">in</span> i[1]:
                        <span style="color: #a020f0;">if</span> ip.encode(<span style="color: #8b2252;">'utf8'</span>) <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> hosts:
                            <span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">'tc hb2  nginx:%s-%s app:%s ip:%s &#27880;&#20876;&#22833;&#36133;'</span> % (hostname,host_ip,i[0],ip)
                            <span style="color: #483d8b;">print</span> msg
                            dindin(tokens,msg)
                        <span style="color: #a020f0;">else</span>:
                            <span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">'tc hb2  nginx:%s-%s app:%s ip:%s  &#27880;&#20876;&#25104;&#21151;'</span> % (hostname,host_ip,i[0],ip)
                            <span style="color: #483d8b;">print</span> msg
                <span style="color: #a020f0;">except</span>:
                   <span style="color: #a020f0;">continue</span>
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">str</span>(e))
<span style="color: #b22222;">#</span><span style="color: #b22222;">print get_nginx_conf()</span>
check_marathon()
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">[root@tc-xy-nginx002 ~]# /usr/bin/python  /home/sh/nginx_marathon/nginx_marathon_check.py
tc hb2  nginx:tc-xy-nginx002-192.168.100.81 app:xy-qd-api-yzprod ip:192.168.101.248  &#27880;&#20876;&#25104;&#21151;
tc hb2  nginx:tc-xy-nginx002-192.168.100.81 app:yzbizcenter-admin-yzprod ip:192.168.101.26  &#27880;&#20876;&#25104;&#21151;
tc hb2  nginx:tc-xy-nginx002-192.168.100.81 app:yzbizcenter-admin-yzprod ip:192.168.101.2  &#27880;&#20876;&#25104;&#21151;
</pre>
</div>
</div>
</section>
<section id="outline-container-h:b73a8850-4e2e-4774-9e18-ae426741fc99" class="outline-2">
<h2 id="h:b73a8850-4e2e-4774-9e18-ae426741fc99">高峰关闭服务</h2>
<div class="outline-text-2" id="text-h:b73a8850-4e2e-4774-9e18-ae426741fc99">
<p>
18 19 20 21 22 高峰时间停止服务运行
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@jumpserver01 ~]# cat /alidata/xuchangwei/checkpy.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #b22222;">#</span>
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">JAVA_HOME</span>=/usr/java/jdk1.8.0_40
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">CLASSPATH</span>=.:$<span style="color: #a0522d;">JAVA_HOME</span>/jre/lib/rt.jar:$<span style="color: #a0522d;">JAVA_HOME</span>/lib/dt.jar:$<span style="color: #a0522d;">JAVA_HOME</span>/lib/tools.jar
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">PATH</span>=$<span style="color: #a0522d;">PATH</span>:$<span style="color: #a0522d;">JAVA_HOME</span>/bin

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">check_time</span>() {
    <span style="color: #a0522d;">high</span>=<span style="color: #8b2252;">"18 19 20 21 22"</span>
    <span style="color: #a020f0;">if</span> [[ <span style="color: #8b2252;">"$high"</span> =~ <span style="color: #8b2252;">"$(date +%H)"</span> ]]; <span style="color: #a020f0;">then</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">if [[ "$high" =~ "14" ]]; then</span>
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"kill service"</span>
        <span style="color: #483d8b;">kill</span> -9 $(ps -ef |grep updateCover |grep -v grep|awk <span style="color: #8b2252;">'{print $2}'</span>)
        <span style="color: #483d8b;">kill</span> -9 $(ps -ef |grep monitorjob.py |grep -v grep|awk <span style="color: #8b2252;">'{print $2}'</span>)
        <span style="color: #483d8b;">kill</span> -9 $(ps -ef |grep imagedeal-jar-with-dependencies.jar|grep -v grep| awk <span style="color: #8b2252;">'{print $2}'</span>)
    <span style="color: #a020f0;">else</span>
        check_pid
    <span style="color: #a020f0;">fi</span>
}

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">check_pid</span>() {
    <span style="color: #a0522d;">i</span>=0
    <span style="color: #a0522d;">interval</span>=10
    <span style="color: #a0522d;">count</span>=$[60/$<span style="color: #a0522d;">interval</span>]

    <span style="color: #a020f0;">while</span> [ $<span style="color: #a0522d;">i</span> -lt $<span style="color: #a0522d;">count</span> ]; <span style="color: #a020f0;">do</span>
        <span style="color: #a0522d;">p_num</span>=$(ps -ef |grep updateCover |grep -v grep |wc -l)
        <span style="color: #a0522d;">m_num</span>=$(ps -ef |grep monitorjob.py |grep -v grep |wc -l)
        <span style="color: #a0522d;">i_num</span>=$(ps -ef |grep imagedeal-jar-with-dependencies.jar|grep -v grep|wc -l)
        <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">p_num</span> == <span style="color: #8b2252;">'0'</span> ]; <span style="color: #a020f0;">then</span>
            <span style="color: #483d8b;">cd</span> /alidata/xuchangwei/dealcover
            nohup python updateCover.py 1 300000000 &amp;&gt;&gt;to.log &amp;
        <span style="color: #a020f0;">fi</span>
        <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">m_num</span> == <span style="color: #8b2252;">'0'</span> ]; <span style="color: #a020f0;">then</span>
            <span style="color: #483d8b;">cd</span> /alidata/xuchangwei/monitorcv
            nohup python monitorjob.py 10000 &amp;&gt;m.log &amp;
        <span style="color: #a020f0;">fi</span>

        <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">i_num</span> == <span style="color: #8b2252;">'0'</span> ]; <span style="color: #a020f0;">then</span>
            <span style="color: #483d8b;">cd</span> /alidata/imagedeal/project/waterDeal/target/
            nohup java -jar /alidata/imagedeal/project/waterDeal/target/imagedeal-jar-with-dependencies.jar online 45 &gt;/alidata/imagedeal/project/imagedeal.log 2&gt;&amp;1 &amp;
        <span style="color: #a020f0;">fi</span>


        ((i++))
        sleep $<span style="color: #a0522d;">interval</span>
    <span style="color: #a020f0;">done</span>
}

check_time
</pre>
</div>
</div>
</section>
<section id="outline-container-h:1afde075-2ee4-499a-9451-7fe9d84fd56d" class="outline-2">
<h2 id="h:1afde075-2ee4-499a-9451-7fe9d84fd56d">prometheus</h2>
<div class="outline-text-2" id="text-h:1afde075-2ee4-499a-9451-7fe9d84fd56d">
</div>
<div id="outline-container-h:8748d3fe-8b3b-4eb9-9c3a-ec9216e4e62b" class="outline-3">
<h3 id="h:8748d3fe-8b3b-4eb9-9c3a-ec9216e4e62b">阿里SLS分析</h3>
<div class="outline-text-3" id="text-h:8748d3fe-8b3b-4eb9-9c3a-ec9216e4e62b">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">-*- coding:UTF-8 -*-</span>
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">from</span> alibabacloud_cms20190101 <span style="color: #a020f0;">import</span> models <span style="color: #a020f0;">as</span> cms_20190101_models
<span style="color: #a020f0;">from</span> alibabacloud_cms20190101.client <span style="color: #a020f0;">import</span> Client <span style="color: #a020f0;">as</span> Cms20190101Client
<span style="color: #a020f0;">from</span> alibabacloud_sls20201230 <span style="color: #a020f0;">import</span> models <span style="color: #a020f0;">as</span> sls_20201230_models
<span style="color: #a020f0;">from</span> alibabacloud_sls20201230.client <span style="color: #a020f0;">import</span> Client <span style="color: #a020f0;">as</span> Sls20201230Client
<span style="color: #a020f0;">from</span> alibabacloud_tea_openapi <span style="color: #a020f0;">import</span> models <span style="color: #a020f0;">as</span> open_api_models
<span style="color: #a020f0;">from</span> alibabacloud_tea_util <span style="color: #a020f0;">import</span> models <span style="color: #a020f0;">as</span> util_models
<span style="color: #a020f0;">from</span> alibabacloud_tea_util.client <span style="color: #a020f0;">import</span> Client <span style="color: #a020f0;">as</span> UtilClient
<span style="color: #a020f0;">from</span> prometheus_client <span style="color: #a020f0;">import</span> Gauge, start_http_server

<span style="color: #a0522d;">g4_1</span> = Gauge(<span style="color: #8b2252;">'sls_undertow_service_qps'</span>, <span style="color: #8b2252;">'service qps'</span>, [<span style="color: #8b2252;">'service'</span>])
<span style="color: #a0522d;">g4_2</span> = Gauge(<span style="color: #8b2252;">'sls_undertow_service_avg_rt'</span>, <span style="color: #8b2252;">'service avg rt'</span>, [<span style="color: #8b2252;">'service'</span>])
<span style="color: #a0522d;">g4_3_0</span> = Gauge(<span style="color: #8b2252;">'sls_undertow_api_slow_level0'</span>, <span style="color: #8b2252;">'api slow graater than 200ms '</span>, [<span style="color: #8b2252;">'service'</span>, <span style="color: #8b2252;">'uri'</span>])
<span style="color: #a0522d;">g4_3_4</span> = Gauge(<span style="color: #8b2252;">'sls_undertow_api_slow_detail'</span>, <span style="color: #8b2252;">'slow query detail'</span>,
               [<span style="color: #8b2252;">'service'</span>, <span style="color: #8b2252;">'uri'</span>, <span style="color: #8b2252;">'avg_timeused'</span>, <span style="color: #8b2252;">'min_timeused'</span>, <span style="color: #8b2252;">'max_timeused'</span>])

<span style="color: #a0522d;">g6</span> = Gauge(<span style="color: #8b2252;">'sls_exception_qpm'</span>, <span style="color: #8b2252;">'exception qpm'</span>, [<span style="color: #8b2252;">'service'</span>])


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_content_from_file</span>(file_path):
    <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> os.path.exists(file_path):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">""</span>
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(file_path, <span style="color: #8b2252;">'r'</span>) <span style="color: #a020f0;">as</span> f:
        <span style="color: #a0522d;">content</span> = f.readlines()
        <span style="color: #a020f0;">if</span> content:
            <span style="color: #a020f0;">return</span> content[0].strip()
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">""</span>


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">set_content_to_file</span>(content, file_path):
    <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(file_path, <span style="color: #8b2252;">'w'</span>) <span style="color: #a020f0;">as</span> f:
        f.write(content)
        f.close()


<span style="color: #a020f0;">class</span> <span style="color: #228b22;">getSlsLogData</span>:
    <span style="color: #a0522d;">access_key_id</span> = <span style="color: #8b2252;">"Lxx"</span>
    <span style="color: #a0522d;">access_key_secret</span> = <span style="color: #8b2252;">"fxxx"</span>
    <span style="color: #a0522d;">undertow_project</span> = <span style="color: #8b2252;">"singapore"</span>
    <span style="color: #a0522d;">undertow_logstore</span> = <span style="color: #8b2252;">"undertow"</span>
    <span style="color: #a0522d;">logback_project</span> = <span style="color: #8b2252;">"overseas-logback-server"</span>
    <span style="color: #a0522d;">logback_logstore</span> = <span style="color: #8b2252;">"server-exception"</span>
    <span style="color: #a0522d;">sls_endpoint</span> = f<span style="color: #8b2252;">'ap-southeast-1-intranet.log.aliyuncs.com'</span>
    <span style="color: #a0522d;">service_all</span> = [
        <span style="color: #8b2252;">"attribute-server"</span>,
        <span style="color: #8b2252;">"attribute-server-manager"</span>,
    ]
    <span style="color: #a0522d;">prefix_uris</span> = [
        <span style="color: #8b2252;">"/episodic_drama"</span>,
        <span style="color: #8b2252;">"/ads_unlock/episodic_drama"</span>,
    ]

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a0522d;">config</span> = open_api_models.Config(
            access_key_id=<span style="color: #a020f0;">self</span>.access_key_id,
            access_key_secret=<span style="color: #a020f0;">self</span>.access_key_secret
        )
        config.<span style="color: #a0522d;">endpoint</span> = <span style="color: #a020f0;">self</span>.sls_endpoint
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">client</span> = Sls20201230Client(config)
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">is_pre</span> = <span style="color: #008b8b;">False</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_sls_data</span>(<span style="color: #a020f0;">self</span>, current=0, project=<span style="color: #8b2252;">""</span>, logstore=<span style="color: #8b2252;">""</span>, query=<span style="color: #8b2252;">""</span>):
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> current:
            <span style="color: #a0522d;">current</span> = <span style="color: #483d8b;">int</span>(time.time())
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> project:
            <span style="color: #a0522d;">project</span> = <span style="color: #a020f0;">self</span>.undertow_project
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> logstore:
            <span style="color: #a0522d;">logstore</span> = <span style="color: #a020f0;">self</span>.undertow_logstore
        <span style="color: #a0522d;">from_time</span> = current - 60
        <span style="color: #a0522d;">to_time</span> = current
        <span style="color: #a0522d;">headers</span> = {}
        <span style="color: #a0522d;">runtime</span> = util_models.RuntimeOptions()
        <span style="color: #a0522d;">get_logs_request</span> = sls_20201230_models.GetLogsRequest(from_=from_time, to=to_time, query=query)
        <span style="color: #a020f0;">try</span>:
            <span style="color: #a0522d;">res</span> = <span style="color: #a020f0;">self</span>.client.get_logs_with_options(project, logstore, get_logs_request, headers, runtime)
            <span style="color: #a020f0;">return</span> res.body
        <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> error:
            UtilClient.assert_as_string(error)
            <span style="color: #a020f0;">return</span> []

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">set_metric_service_qps</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a0522d;">query</span> = <span style="color: #8b2252;">'*|select "__tag__:_container_name_" as service ,COUNT(*) as cnt group by service order by cnt desc '</span>
        <span style="color: #a0522d;">res_list</span> = <span style="color: #a020f0;">self</span>.get_sls_data(query=query)
        <span style="color: #a020f0;">for</span> data <span style="color: #a020f0;">in</span> res_list:
            <span style="color: #a0522d;">service</span> = data[<span style="color: #8b2252;">"service"</span>]
            <span style="color: #a0522d;">cnt</span> = <span style="color: #483d8b;">float</span>(data[<span style="color: #8b2252;">"cnt"</span>])
            g4_1.labels(service).<span style="color: #483d8b;">set</span>(cnt)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">set_metric_service_avg_rt</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a0522d;">query</span> = <span style="color: #8b2252;">'* |select "__tag__:_container_name_" as service , avg(timeUsed) as avg_time  group by service order by avg_time desc '</span>
        <span style="color: #a0522d;">res_list</span> = <span style="color: #a020f0;">self</span>.get_sls_data(query=query)
        <span style="color: #a020f0;">for</span> data <span style="color: #a020f0;">in</span> res_list:
            <span style="color: #a0522d;">service</span> = data[<span style="color: #8b2252;">"service"</span>]
            <span style="color: #a020f0;">try</span>:
                <span style="color: #a0522d;">avg_time_ns</span> = <span style="color: #483d8b;">float</span>(data[<span style="color: #8b2252;">"avg_time"</span>])
            <span style="color: #a020f0;">except</span>:
                <span style="color: #a020f0;">continue</span>
            <span style="color: #a0522d;">avg_time_ms</span> = <span style="color: #483d8b;">int</span>(avg_time_ns / 1000)
            g4_2.labels(service).<span style="color: #483d8b;">set</span>(avg_time_ms)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_undertow_data_daily</span>(<span style="color: #a020f0;">self</span>, query=<span style="color: #8b2252;">""</span>):
        <span style="color: #a0522d;">now</span> = datetime.datetime.now()
        <span style="color: #a0522d;">midnight</span> = now.replace(hour=0, minute=0, second=0, microsecond=0)
        <span style="color: #a0522d;">midnight_ts</span> = <span style="color: #483d8b;">int</span>(midnight.timestamp())
        <span style="color: #a0522d;">from_time</span> = midnight_ts - 9000
        <span style="color: #a0522d;">to_time</span> = from_time + 1800
        <span style="color: #a0522d;">project</span> = <span style="color: #a020f0;">self</span>.undertow_project
        <span style="color: #a0522d;">logstore</span> = <span style="color: #a020f0;">self</span>.undertow_logstore
        <span style="color: #a0522d;">headers</span> = {}
        <span style="color: #a0522d;">runtime</span> = util_models.RuntimeOptions()
        <span style="color: #a0522d;">get_logs_request</span> = sls_20201230_models.GetLogsRequest(from_=from_time, to=to_time, query=query)
        <span style="color: #a020f0;">try</span>:
            <span style="color: #a0522d;">res</span> = <span style="color: #a020f0;">self</span>.client.get_logs_with_options(project, logstore, get_logs_request, headers, runtime)
            <span style="color: #a020f0;">return</span> res.body
        <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> error:
            UtilClient.assert_as_string(error)
            <span style="color: #a020f0;">return</span> []

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">set_metric_slow_detail</span>(<span style="color: #a020f0;">self</span>):
        g4_3_4.clear()
        <span style="color: #a020f0;">for</span> service <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">self</span>.get_service_list():
            <span style="color: #a0522d;">query</span> = <span style="color: #8b2252;">'* and __tag__:_container_name_: {} |select COUNT(*) as cnt, avg(timeUsed)/1000 as avg_timeused, min(timeUsed)/1000 as min_timeused, max(timeUsed)/1000 as max_timeused , sum(timeUsed)/1000 as sum_timeused, "__tag__:_container_name_" as service ,uri group by service,uri  HAVING  avg_timeused &gt;200 order by avg_timeused desc limit 100000'</span>.<span style="color: #483d8b;">format</span>(
                service)
            <span style="color: #a0522d;">res_list</span> = <span style="color: #a020f0;">self</span>.get_undertow_data_daily(query=query)
            <span style="color: #a0522d;">pre_map</span> = {}
            <span style="color: #483d8b;">sum</span> = <span style="color: #483d8b;">float</span>(0)
            <span style="color: #a020f0;">for</span> data <span style="color: #a020f0;">in</span> res_list:
                <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">is_pre</span> = <span style="color: #008b8b;">False</span>
                <span style="color: #a0522d;">uri</span> = data[<span style="color: #8b2252;">"uri"</span>]
                <span style="color: #a0522d;">cnt</span> = <span style="color: #483d8b;">float</span>(data[<span style="color: #8b2252;">"cnt"</span>])
                <span style="color: #a0522d;">min_timeused</span> = <span style="color: #483d8b;">float</span>(data[<span style="color: #8b2252;">"min_timeused"</span>])
                <span style="color: #a0522d;">max_timeused</span> = <span style="color: #483d8b;">float</span>(data[<span style="color: #8b2252;">"max_timeused"</span>])
                <span style="color: #483d8b;">sum</span> += cnt

                <span style="color: #a020f0;">for</span> prefix_uri <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">self</span>.prefix_uris:
                    <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> uri.startswith(prefix_uri):
                        <span style="color: #a020f0;">continue</span>
                    <span style="color: #a0522d;">uri_len</span> = <span style="color: #483d8b;">len</span>(uri.split(<span style="color: #8b2252;">"/"</span>))
                    <span style="color: #a0522d;">prefix_uri_len</span> = <span style="color: #483d8b;">len</span>(prefix_uri.split(<span style="color: #8b2252;">"/"</span>))
                    <span style="color: #a0522d;">param_str</span> = <span style="color: #8b2252;">""</span>
                    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(uri_len - prefix_uri_len):
                        <span style="color: #a0522d;">param_str</span> = param_str + <span style="color: #8b2252;">"/{param}"</span>
                    <span style="color: #a0522d;">sum_timeused</span> = <span style="color: #483d8b;">float</span>(data[<span style="color: #8b2252;">"sum_timeused"</span>])
                    <span style="color: #a0522d;">key</span> = prefix_uri + param_str
                    <span style="color: #a0522d;">pre_uri_data</span> = pre_map.get(key, {})
                    <span style="color: #a0522d;">pre_uri_data</span>[<span style="color: #8b2252;">"sum_timeused"</span>] = <span style="color: #483d8b;">float</span>(pre_uri_data.get(<span style="color: #8b2252;">"sum_timeused"</span>, 0)) + sum_timeused
                    <span style="color: #a0522d;">pre_uri_data</span>[<span style="color: #8b2252;">"cnt"</span>] = <span style="color: #483d8b;">float</span>(pre_uri_data.get(<span style="color: #8b2252;">"cnt"</span>, 0)) + cnt
                    <span style="color: #a0522d;">pre_uri_data</span>[<span style="color: #8b2252;">"min_timeused"</span>] = <span style="color: #483d8b;">min</span>(<span style="color: #483d8b;">float</span>(pre_uri_data.get(<span style="color: #8b2252;">"min_timeused"</span>, min_timeused)),
                                                       min_timeused)
                    <span style="color: #a0522d;">pre_uri_data</span>[<span style="color: #8b2252;">"max_timeused"</span>] = <span style="color: #483d8b;">max</span>(<span style="color: #483d8b;">float</span>(pre_uri_data.get(<span style="color: #8b2252;">"max_timeused"</span>, max_timeused)),
                                                       max_timeused)
                    <span style="color: #a0522d;">pre_map</span>[key] = pre_uri_data
                    <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">is_pre</span> = <span style="color: #008b8b;">True</span>
                    <span style="color: #a020f0;">break</span>
                <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">self</span>.is_pre:
                    <span style="color: #a0522d;">avg_timeused</span> = data[<span style="color: #8b2252;">"avg_timeused"</span>]
                    <span style="color: #a0522d;">min_timeused</span> = <span style="color: #483d8b;">str</span>(min_timeused)
                    <span style="color: #a0522d;">max_timeused</span> = <span style="color: #483d8b;">str</span>(max_timeused)
                    g4_3_4.labels(service, uri, avg_timeused, min_timeused, max_timeused).<span style="color: #483d8b;">set</span>(cnt)

            <span style="color: #a020f0;">for</span> uri, pre_uri_data <span style="color: #a020f0;">in</span> pre_map.items():
                <span style="color: #a0522d;">cnt</span> = pre_uri_data[<span style="color: #8b2252;">"cnt"</span>]
                <span style="color: #a0522d;">sum_timeused</span> = pre_uri_data[<span style="color: #8b2252;">"sum_timeused"</span>]
                <span style="color: #a0522d;">min_timeused</span> = <span style="color: #483d8b;">str</span>(pre_uri_data[<span style="color: #8b2252;">"min_timeused"</span>])
                <span style="color: #a0522d;">max_timeused</span> = <span style="color: #483d8b;">str</span>(pre_uri_data[<span style="color: #8b2252;">"max_timeused"</span>])
                <span style="color: #a0522d;">avg_timeused</span> = <span style="color: #483d8b;">str</span>(<span style="color: #483d8b;">round</span>(sum_timeused / cnt, 2))
                g4_3_4.labels(service, uri, avg_timeused, min_timeused, max_timeused).<span style="color: #483d8b;">set</span>(cnt)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_service_list</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a0522d;">service_list</span> = []
        <span style="color: #a0522d;">query</span> = <span style="color: #8b2252;">'*|select DISTINCT "__tag__:_container_name_" as service'</span>
        <span style="color: #a0522d;">res_list</span> = <span style="color: #a020f0;">self</span>.get_undertow_data_daily(query=query)
        <span style="color: #a020f0;">for</span> data <span style="color: #a020f0;">in</span> res_list:
            <span style="color: #a0522d;">service</span> = data[<span style="color: #8b2252;">"service"</span>]
            service_list.append(service)
        <span style="color: #a020f0;">return</span> service_list

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">set_metric_api_slow_level0</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a0522d;">query</span> = <span style="color: #8b2252;">'* and timeUsed &gt;= 200000|select "__tag__:_container_name_" as service ,uri, COUNT(*) as cnt group by service,uri order by cnt desc '</span>
        <span style="color: #a0522d;">res_list</span> = <span style="color: #a020f0;">self</span>.get_sls_data(query=query)
        g4_3_0.clear()
        <span style="color: #a020f0;">for</span> data <span style="color: #a020f0;">in</span> res_list:
            <span style="color: #a0522d;">service</span> = data[<span style="color: #8b2252;">"service"</span>]
            <span style="color: #a0522d;">uri</span> = data[<span style="color: #8b2252;">"uri"</span>]
            <span style="color: #a0522d;">cnt</span> = <span style="color: #483d8b;">float</span>(data[<span style="color: #8b2252;">"cnt"</span>])
            g4_3_0.labels(service, uri).<span style="color: #483d8b;">set</span>(cnt)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">set_metric_logback_exception</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a0522d;">query</span> = <span style="color: #8b2252;">"* | select __topic__ as service , COUNT(*) as cnt group by service"</span>
        <span style="color: #a0522d;">res_list</span> = <span style="color: #a020f0;">self</span>.get_sls_data(project=<span style="color: #a020f0;">self</span>.logback_project, logstore=<span style="color: #a020f0;">self</span>.logback_logstore, query=query)
        g6.clear()
        g6.labels(<span style="color: #8b2252;">"content-distribution-platform"</span>).<span style="color: #483d8b;">set</span>(0)
        <span style="color: #a020f0;">for</span> service <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">self</span>.service_all:
            g6.labels(service).<span style="color: #483d8b;">set</span>(0)
        <span style="color: #a020f0;">for</span> data <span style="color: #a020f0;">in</span> res_list:
            <span style="color: #a0522d;">service</span> = data[<span style="color: #8b2252;">"service"</span>]
            <span style="color: #a0522d;">cnt</span> = data[<span style="color: #8b2252;">"cnt"</span>]
            g6.labels(service).<span style="color: #483d8b;">set</span>(cnt)


<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">'__main__'</span>:
    <span style="color: #a0522d;">already_file</span> = <span style="color: #8b2252;">"/opt/ops/others/already_run"</span>
    start_http_server(9111)  <span style="color: #b22222;"># </span><span style="color: #b22222;">8006&#31471;&#21475;&#21551;&#21160;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#30417;&#25511;&#31243;&#24207;&#21551;&#21160;..."</span>)
    <span style="color: #a0522d;">data4</span> = getSlsLogData()
    <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
        <span style="color: #a020f0;">try</span>:
            <span style="color: #a0522d;">current_day</span> = datetime.datetime.now().strftime(<span style="color: #8b2252;">"%Y%m%d"</span>)
            <span style="color: #a0522d;">already_day</span> = get_content_from_file(already_file)
            <span style="color: #a020f0;">if</span> current_day != already_day:
                set_content_to_file(current_day, already_file)
                <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#25191;&#34892;&#24930;&#25509;&#21475;&#32479;&#35745;&#20219;&#21153;"</span>)
                data4.set_metric_slow_detail()
                <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#24930;&#25509;&#21475;&#32479;&#35745;&#20219;&#21153;&#25191;&#34892;&#23436;&#27605;"</span>)
            data4.set_metric_service_qps()
            data4.set_metric_service_avg_rt()
            data4.set_metric_api_slow_level0()
            data4.set_metric_logback_exception()
            <span style="color: #a0522d;">current_time</span> = datetime.datetime.now().strftime(<span style="color: #8b2252;">"%Y-%m-%d %H:%M:%S"</span>)
            <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"{} &#30417;&#25511;&#25968;&#25454;&#37319;&#38598;&#25104;&#21151;"</span>.<span style="color: #483d8b;">format</span>(current_time))
            time.sleep(40)
        <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
            <span style="color: #483d8b;">print</span>(e)
            time.sleep(40)
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:fb49990a-421f-4368-9a44-f96a808530db" class="outline-2">
<h2 id="h:fb49990a-421f-4368-9a44-f96a808530db">openflcon</h2>
<div class="outline-text-2" id="text-h:fb49990a-421f-4368-9a44-f96a808530db">
</div>
<div id="outline-container-h:18e1e22c-e42f-4020-a5ac-e5e5d59320c0" class="outline-3">
<h3 id="h:18e1e22c-e42f-4020-a5ac-e5e5d59320c0">网络质量监控脚本</h3>
<div class="outline-text-3" id="text-h:18e1e22c-e42f-4020-a5ac-e5e5d59320c0">
<p>
脚本逻辑：通过定量ping内网地址，将丢包的比例上报的open-falcon上，并在open-falcon中设定阈值；
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/</span><span style="color: #a020f0;">sh</span>
<span style="color: #b22222;">#########################</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">system variable</span>
<span style="color: #a0522d;">timestamp</span>=<span style="color: #ff00ff;">`date +%s`</span>
<span style="color: #a0522d;">host_name</span>=<span style="color: #ff00ff;">`hostname`</span>
<span style="color: #a0522d;">tc_ping</span>=<span style="color: #ff00ff;">`ping -c 10 192.168.100.43 |grep "packet loss" |awk '{print $6}' |sed 's/%//g'`</span>
<span style="color: #a0522d;">sc_ping</span>=<span style="color: #ff00ff;">`ping -c 10 192.168.10.65 |grep "packet loss" |awk '{print $6}' |sed 's/%//g'`</span>

<span style="color: #b22222;">#########################</span>
<span style="color: #0000ff;">main</span> () {
        curl -X POST -d <span style="color: #8b2252;">'[{"metric": "tc high-speed channel", "endpoint": "'</span>$<span style="color: #a0522d;">host_name</span><span style="color: #8b2252;">'", "timestamp": '</span>$<span style="color: #a0522d;">timestamp</span><span style="color: #8b2252;">', "step": 60,"value": '</span>$<span style="color: #a0522d;">tc_ping</span><span style="color: #8b2252;">',"counterType": "GAUGE","tags": ""}]'</span> http://127.0.0.1:1988/v1/push
        curl -X POST -d <span style="color: #8b2252;">'[{"metric": "sc high-speed channel", "endpoint": "'</span>$<span style="color: #a0522d;">host_name</span><span style="color: #8b2252;">'", "timestamp": '</span>$<span style="color: #a0522d;">timestamp</span><span style="color: #8b2252;">', "step": 60,"value": '</span>$<span style="color: #a0522d;">sc_ping</span><span style="color: #8b2252;">',"counterType": "GAUGE","tags": ""}]'</span> http://127.0.0.1:1988/v1/push
}

main
</pre>
</div>
</div>
</div>
<div id="outline-container-h:725329d7-d66d-4578-aeaf-c3cc41e813e9" class="outline-3">
<h3 id="h:725329d7-d66d-4578-aeaf-c3cc41e813e9">openflacon-zookeeeper</h3>
<div class="outline-text-3" id="text-h:725329d7-d66d-4578-aeaf-c3cc41e813e9">
<div class="org-src-container">
<pre class="src src-sh">[root@zk-1 ~]# crontab -l
<span style="color: #b22222;">################## </span><span style="color: #b22222;">monitor falcon agent ######################</span>
*/1 * * * * /usr/bin/sh /data/work/open-falcon/script/report_agent.sh

[root@zk-1 ~]# cat /data/work/open-falcon/script/report_agent.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #a0522d;">timestamp</span>=<span style="color: #ff00ff;">`date +%s`</span>
<span style="color: #a0522d;">host_name</span>=<span style="color: #ff00ff;">`hostname`</span>
<span style="color: #b22222;">### </span><span style="color: #b22222;">check zk ###&#26032;###</span>
<span style="color: #a0522d;">zk_pid</span>=<span style="color: #ff00ff;">`ps -ef|grep 'zookeeper'|grep -v 'grep'|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_port_2181</span>=<span style="color: #ff00ff;">`netstat -antlp|grep $zk_pid|grep 2181|wc -l`</span>
<span style="color: #a0522d;">zk_num</span>=<span style="color: #ff00ff;">`ps -ef|grep 'zookeeper'|grep -v grep | wc -l`</span>
curl -X POST -d <span style="color: #8b2252;">'[{"metric": "zookeeper.status", "endpoint": "'</span>$<span style="color: #a0522d;">host_name</span><span style="color: #8b2252;">'", "timestamp": '</span>$<span style="color: #a0522d;">timestamp</span><span style="color: #8b2252;">', "step": 60,"value": '</span>$<span style="color: #a0522d;">zk_num</span><span style="color: #8b2252;">',"counterType": "GAUGE","tags": ""}]'</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">'[{"metric": "zookeeper.connect_port_2181", "endpoint": "'</span>$<span style="color: #a0522d;">host_name</span><span style="color: #8b2252;">'", "timestamp": '</span>$<span style="color: #a0522d;">timestamp</span><span style="color: #8b2252;">', "step": 60,"value": '</span>$<span style="color: #a0522d;">zk_port_2181</span><span style="color: #8b2252;">',"counterType": "GAUGE","tags": ""}]'</span> http://127.0.0.1:1988/v1/push

<span style="color: #a0522d;">role</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_server_state|awk '{print $2}'`</span>
<span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">role</span> = <span style="color: #8b2252;">"leader"</span> ];<span style="color: #a020f0;">then</span>
<span style="color: #a0522d;">zk_avg_latency</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_avg_latency|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_max_latency</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_max_latency |awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_min_latency</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_min_latency|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_packets_received</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_packets_received|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_packets_sent</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_packets_sent|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_num_alive_connections</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_num_alive_connections|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_outstanding_requests</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_outstanding_requests|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_znode_count</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_znode_count|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_watch_count</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_watch_count|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_ephemerals_count</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_ephemerals_count|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_approximate_data_size</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_approximate_data_size|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_open_file_descriptor_count</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_open_file_descriptor_count|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_max_file_descriptor_count</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_max_file_descriptor_count|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_followers</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_followers|awk '{print $2}'`</span>
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_avg_latency\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_avg_latency,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_max_latency\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_max_latency,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_min_latency\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_min_latency,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_packets_received\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_packets_received,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_packets_sent\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_packets_sent,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_num_alive_connections\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_num_alive_connections,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_outstanding_requests\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_outstanding_requests,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_znode_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_znode_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_watch_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_watch_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_ephemerals_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_ephemerals_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_approximate_data_size\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_approximate_data_size,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_open_file_descriptor_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_open_file_descriptor_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_max_file_descriptor_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_max_file_descriptor_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_followers\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_followers,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push

<span style="color: #a020f0;">else</span>
<span style="color: #a0522d;">zk_avg_latency</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_avg_latency|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_max_latency</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_max_latency |awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_min_latency</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_min_latency|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_packets_received</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_packets_received|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_packets_sent</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_packets_sent|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_num_alive_connections</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_num_alive_connections|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_outstanding_requests</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_outstanding_requests|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_znode_count</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_znode_count|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_watch_count</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_watch_count|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_ephemerals_count</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_ephemerals_count|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_approximate_data_size</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_approximate_data_size|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_open_file_descriptor_count</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_open_file_descriptor_count|awk '{print $2}'`</span>
<span style="color: #a0522d;">zk_max_file_descriptor_count</span>=<span style="color: #ff00ff;">`echo mntr|nc 127.0.0.1 2181 |grep zk_max_file_descriptor_count|awk '{print $2}'`</span>
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_avg_latency\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_avg_latency,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_max_latency\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_max_latency,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_min_latency\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_min_latency,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_packets_received\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_packets_received,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_packets_sent\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_packets_sent,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_num_alive_connections\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_num_alive_connections,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_outstanding_requests\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_outstanding_requests,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_znode_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_znode_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_watch_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_watch_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_ephemerals_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_ephemerals_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_approximate_data_size\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_approximate_data_size,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_open_file_descriptor_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_open_file_descriptor_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span style="color: #8b2252;">"[{\"metric\": \"ZK.zk_max_file_descriptor_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_max_file_descriptor_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
<span style="color: #a020f0;">fi</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:294b25b4-1d3a-4777-b478-51dc1a70deed" class="outline-3">
<h3 id="h:294b25b4-1d3a-4777-b478-51dc1a70deed">服务监控治理</h3>
<div class="outline-text-3" id="text-h:294b25b4-1d3a-4777-b478-51dc1a70deed">
<p>
监控脚本说明
</p>
<div class="org-src-container">
<pre class="src src-sh">&#21442;&#25968;&#35828;&#26126;&#65306;
--service&#65306;&#26381;&#21153;&#31867;&#22411;
--ports&#65306;&#26381;&#21153;&#31471;&#21475;&#65292;&#22810;&#31471;&#21475;&#38388;,&#36887;&#21495;&#20998;&#38548;&#12290;&#27809;&#26377;&#31471;&#21475;&#21017;&#22635;0&#12290;
--names: &#30417;&#25511;&#25351;&#26631;&#12290;&#22810;&#20010;&#25351;&#26631;&#20197;,&#36887;&#21495;&#20998;&#38548;&#12290;
</pre>
</div>

<p>
bash脚本模板
</p>

<div class="org-src-container">
<pre class="src src-sh">monitor[root@nginx001 vhosts]# crontab -l
<span style="color: #b22222;">#</span><span style="color: #b22222;">Ansible: zookeeper.connect_port</span>
*/1 * * * * /home/scripts/zookeeper/zookeeper.connect_port.sh  --service zk  --ports 2181,3888  --names  zk.connect_port
<span style="color: #b22222;">#</span><span style="color: #b22222;">Ansible: zookeeper.daemon_status</span>
*/1 * * * * /home/scripts/zookeeper/zookeeper.daemon_status.sh  --service zk  --ports 0  --names  zk.daemon_status
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/</span><span style="color: #a020f0;">env</span><span style="color: #b22222;"> bash</span>
<span style="color: #b22222;">#</span>
<span style="color: #483d8b;">source</span> /etc/profile
<span style="color: #a0522d;">timestamp</span>=<span style="color: #ff00ff;">`date +%s`</span>
<span style="color: #a0522d;">host_name</span>=<span style="color: #ff00ff;">`hostname`</span>
<span style="color: #a0522d;">exit_status</span>=0

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">usage</span>(){
cat &lt;&lt;EOF
<span style="color: #ffa54f;">Usage: $0 [MODE] [OPTION]</span>

<span style="color: #ffa54f;">OPTION:</span>
<span style="color: #ffa54f;">  -s, --service &lt;server_name&gt;     &#25351;&#23450;&#26381;&#21153;</span>
<span style="color: #ffa54f;">  -p, --ports &lt;port1,port2...&gt;    &#25351;&#23450;&#31471;&#21475;&#21495;</span>
<span style="color: #ffa54f;">  -n, --names &lt;tag_name&gt;          &#25351;&#23450;&#30417;&#25511;&#25351;&#26631;</span>
<span style="color: #ffa54f;">  --help                   show help</span>
<span style="color: #ffa54f;">EOF</span>
}

<span style="color: #a0522d;">parameters</span>=$(getopt -o s:p:n: --long service:,ports:,names:,help -n <span style="color: #8b2252;">"$0"</span> -- <span style="color: #8b2252;">"$@"</span>)
[ $<span style="color: #a0522d;">?</span> -ne 0 ] &amp;&amp; { <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"Try '$0 --help' for more information."</span>; <span style="color: #a020f0;">exit</span> 1; }

<span style="color: #483d8b;">eval</span> set -- <span style="color: #8b2252;">"$parameters"</span>

<span style="color: #a020f0;">while </span><span style="color: #483d8b;">true</span>; <span style="color: #a020f0;">do</span>
    <span style="color: #a020f0;">case</span> <span style="color: #8b2252;">"$1"</span><span style="color: #a020f0;"> in</span>
    -s|--service) <span style="color: #a0522d;">service</span>=$<span style="color: #a0522d;">2</span>; <span style="color: #483d8b;">shift</span> 2;;
    -p|--ports) <span style="color: #a0522d;">ports</span>=$<span style="color: #a0522d;">2</span> ; <span style="color: #483d8b;">shift</span> 2 ;;
    -n|--names) <span style="color: #a0522d;">names</span>=$<span style="color: #a0522d;">2</span> ; <span style="color: #483d8b;">shift</span> 2 ;;
    --help) usage;<span style="color: #a020f0;">exit</span> ;;
    --)
        <span style="color: #483d8b;">shift</span>
        <span style="color: #a0522d;">FIRST</span>=$<span style="color: #a0522d;">1</span>
        <span style="color: #a0522d;">SECOND</span>=$<span style="color: #a0522d;">2</span>
        <span style="color: #a0522d;">LAST</span>=$<span style="color: #a0522d;">3</span>
        <span style="color: #a020f0;">break</span> ;;
    *) usage;<span style="color: #a020f0;">exit</span> 1 ;;
    <span style="color: #a020f0;">esac</span>
<span style="color: #a020f0;">done</span>

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">open_falcon_push</span>() {
    <span style="color: #483d8b;">local</span> <span style="color: #a0522d;">metric</span>=$<span style="color: #a0522d;">1</span>
    <span style="color: #483d8b;">local</span> <span style="color: #a0522d;">tag</span>=$<span style="color: #a0522d;">2</span>
    <span style="color: #483d8b;">local</span> <span style="color: #a0522d;">value</span>=$<span style="color: #a0522d;">3</span>
    curl --connect-timeout 5 -X POST -d <span style="color: #8b2252;">'[{"'</span>metric<span style="color: #8b2252;">'": "'</span>$<span style="color: #a0522d;">metric</span><span style="color: #8b2252;">'", "endpoint": "'</span>$<span style="color: #a0522d;">host_name</span><span style="color: #8b2252;">'", "timestamp": '</span>$<span style="color: #a0522d;">timestamp</span><span style="color: #8b2252;">', "step": 60,"value": '</span>$<span style="color: #a0522d;">value</span><span style="color: #8b2252;">',"counterType": "GAUGE","tags": "'</span>$<span style="color: #a0522d;">tag</span><span style="color: #8b2252;">'"}]'</span> http://127.0.0.1:1988/v1/push
    <span style="color: #b22222;">#</span><span style="color: #b22222;">echo  '[{"metric": "'$metric'", "endpoint": "'$host_name'", "timestamp": '$timestamp', "step": 60,"value": '$value',"counterType": "GAUGE","tags": "'$tag'"}]' http://127.0.0.1:1988/v1/push</span>
}

[ -z <span style="color: #8b2252;">"$service"</span> ] &amp;&amp; { <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31;1;4mERR\033[0m: the service is not found, please --help"</span> &amp;&amp; <span style="color: #a0522d;">exit_status</span>=1; }
[ -z <span style="color: #8b2252;">"$ports"</span> ] &amp;&amp; { <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31;1;4mERR\033[0m: the ports are not found, please --help"</span> &amp;&amp; <span style="color: #a0522d;">exit_status</span>=1; }
[ -z <span style="color: #8b2252;">"$names"</span> ] &amp;&amp; { <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31;1;4mERR\033[0m: the names are not found, please --help"</span> &amp;&amp; <span style="color: #a0522d;">exit_status</span>=1; }
[  $<span style="color: #a0522d;">exit_status</span> == 1 ]&amp;&amp; <span style="color: #a020f0;">exit</span> 1


<span style="color: #b22222;">#</span><span style="color: #b22222;">----------------------------------change</span>
[ -z <span style="color: #8b2252;">"$(which nc)"</span> ] &amp;&amp; yum install -y nc
<span style="color: #a0522d;">daemon_status</span>=<span style="color: #ff00ff;">`echo ruok | nc 127.0.0.1 2181|grep imok|wc -l`</span>

<span style="color: #a0522d;">zk_pid</span>=<span style="color: #ff00ff;">`jps |grep QuorumPeerMain| grep -v 'grep'|awk '{print $1}'`</span>

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">noport_check</span>() {
    <span style="color: #a020f0;">for</span> port<span style="color: #a020f0;"> in</span> $(<span style="color: #483d8b;">echo</span> ${<span style="color: #a0522d;">ports</span>//,/ }); <span style="color: #a020f0;">do</span>
        <span style="color: #a020f0;">if</span> [ <span style="color: #8b2252;">"$port"</span> -ge 0 ] 2&gt;/dev/null ; <span style="color: #a020f0;">then</span> :;<span style="color: #a020f0;">else </span><span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31;1;4mERR\033[0m: port $port is not number"</span> &amp;&amp; <span style="color: #a020f0;">exit</span> 1; <span style="color: #a020f0;">fi</span>
        <span style="color: #a020f0;">for</span> name<span style="color: #a020f0;"> in</span> $(<span style="color: #483d8b;">echo</span> ${<span style="color: #a0522d;">names</span>//,/ }); <span style="color: #a020f0;">do</span>
            open_falcon_push   <span style="color: #8b2252;">"$name"</span> <span style="color: #8b2252;">"name=$name,port=0,service=$service"</span> <span style="color: #8b2252;">"$daemon_status"</span>
        <span style="color: #a020f0;">done</span>
    <span style="color: #a020f0;">done</span>
}

<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">ports_check</span>() {
    <span style="color: #a020f0;">for</span> port<span style="color: #a020f0;"> in</span> $(<span style="color: #483d8b;">echo</span> ${<span style="color: #a0522d;">ports</span>//,/ }); <span style="color: #a020f0;">do</span>
        <span style="color: #a020f0;">if</span> [ <span style="color: #8b2252;">"$port"</span> -ge 0 ] 2&gt;/dev/null ; <span style="color: #a020f0;">then</span> :;<span style="color: #a020f0;">else </span><span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31;1;4mERR\033[0m: port $port is not number"</span> &amp;&amp; <span style="color: #a020f0;">exit</span> 1; <span style="color: #a020f0;">fi</span>
        <span style="color: #a020f0;">for</span> name<span style="color: #a020f0;"> in</span> $(<span style="color: #483d8b;">echo</span> ${<span style="color: #a0522d;">names</span>//,/ }); <span style="color: #a020f0;">do</span>
            <span style="color: #a0522d;">zk_port</span>=<span style="color: #ff00ff;">`netstat -antlp|grep $zk_pid|grep $port|wc -l`</span>
            open_falcon_push   <span style="color: #8b2252;">"$name"</span> <span style="color: #8b2252;">"name=$name,port=$port,service=$service"</span> <span style="color: #8b2252;">"$zk_port"</span>
        <span style="color: #a020f0;">done</span>
    <span style="color: #a020f0;">done</span>
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">----------------------------------end</span>
<span style="color: #a020f0;">function</span> <span style="color: #0000ff;">monitor</span>() {
   noport_check
   <span style="color: #b22222;">#</span><span style="color: #b22222;">ports_check</span>
}
</pre>
</div>



<p>
python脚本模板
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@nginx001 vhosts]# /home/scripts/nginx/nginx.openfiles_check.py  --service nginx  --ports 0  --names  nginx.openfiles_check
success
[{<span style="color: #8b2252;">'metric'</span>: <span style="color: #8b2252;">'nginx.openfiles_check'</span>, <span style="color: #8b2252;">'endpoint'</span>: <span style="color: #8b2252;">'nginx001'</span>, <span style="color: #8b2252;">'timestamp'</span>: 1575447496, <span style="color: #8b2252;">'step'</span>: 120, <span style="color: #8b2252;">'value'</span>: 1, <span style="color: #8b2252;">'counterType'</span>: <span style="color: #8b2252;">'GAUGE'</span>, <span style="color: #8b2252;">'tags'</span>: <span style="color: #8b2252;">'name=nginx.openfiles_check,port=0,service=nginx'</span>}]
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python3</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">-*- coding:utf-8 -*-</span>
<span style="color: #a020f0;">import</span> time,datetime
<span style="color: #a020f0;">import</span> json
<span style="color: #a020f0;">import</span> socket
<span style="color: #a020f0;">import</span> requests
<span style="color: #a020f0;">import</span> os

<span style="color: #a020f0;">import</span> argparse
<span style="color: #a0522d;">parser</span> = argparse.ArgumentParser(description=<span style="color: #8b2252;">'monitor script'</span>)
parser.add_argument(<span style="color: #8b2252;">"-s"</span>,<span style="color: #8b2252;">"--service"</span>, <span style="color: #483d8b;">help</span>=<span style="color: #8b2252;">"&#25351;&#23450;&#26381;&#21153;"</span>, <span style="color: #483d8b;">type</span>=<span style="color: #483d8b;">str</span>, required=<span style="color: #008b8b;">True</span>)
parser.add_argument(<span style="color: #8b2252;">"-p"</span>,<span style="color: #8b2252;">"--ports"</span>, <span style="color: #483d8b;">help</span>=<span style="color: #8b2252;">"&#25351;&#23450;&#31471;&#21475;&#21495;"</span>, <span style="color: #483d8b;">type</span>=<span style="color: #483d8b;">str</span>, required=<span style="color: #008b8b;">True</span>)
parser.add_argument(<span style="color: #8b2252;">"-n"</span>,<span style="color: #8b2252;">"--names"</span>, <span style="color: #483d8b;">help</span>=<span style="color: #8b2252;">"&#25351;&#23450;&#30417;&#25511;&#25351;&#26631;"</span>, <span style="color: #483d8b;">type</span>=<span style="color: #483d8b;">str</span>, required=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">args</span> = parser.parse_args()

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">open_falcon_push</span>(payload):
    <span style="color: #a0522d;">url</span> = <span style="color: #8b2252;">'http://127.0.0.1:1988/v1/push'</span>
    <span style="color: #a0522d;">headers</span> = {<span style="color: #8b2252;">"Content-Type"</span>: <span style="color: #8b2252;">"application/json"</span>}
    <span style="color: #a020f0;">try</span>:
        <span style="color: #a0522d;">r</span> = requests.post(url, data=json.dumps(payload), headers=headers, timeout=3)
        <span style="color: #a020f0;">if</span> r.status_code == 200:
            <span style="color: #483d8b;">print</span>(r.text)
        <span style="color: #a020f0;">else</span>:
            <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'{"err":1,"msg":"%s"}'</span> % r.text)
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"Exception: {traceback.format_exc(chain=False)}"</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">---------------------------------------------change</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">main</span>():
    <span style="color: #a0522d;">service</span> = args.service
    <span style="color: #a0522d;">ports</span> = args.ports
    <span style="color: #a0522d;">names</span> = args.names
    <span style="color: #a0522d;">hostname</span> = socket.gethostname()
    <span style="color: #a0522d;">timestamp</span> = <span style="color: #483d8b;">int</span>(time.time())
    <span style="color: #a0522d;">step</span> = 120
    <span style="color: #a0522d;">payload</span> = []

    <span style="color: #a020f0;">try</span>:
        <span style="color: #a0522d;">ports</span> = ports.split(<span style="color: #8b2252;">','</span>)
        <span style="color: #a0522d;">names</span> = names.split(<span style="color: #8b2252;">','</span>)

        <span style="color: #a020f0;">for</span> port <span style="color: #a020f0;">in</span> ports:
            <span style="color: #a0522d;">tags</span> = <span style="color: #8b2252;">'port=%s'</span> % port
            <span style="color: #a020f0;">for</span> name <span style="color: #a020f0;">in</span> names:
                <span style="color: #a0522d;">tag</span> =<span style="color: #8b2252;">"name={},port={},service={}"</span>.<span style="color: #483d8b;">format</span>(name,port,service)
                <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">"openfiles_check"</span> <span style="color: #a020f0;">in</span> name: 
                    <span style="color: #a0522d;">value</span> = openfiles()
                    <span style="color: #a0522d;">i</span> = {
                        <span style="color: #8b2252;">'metric'</span>: name,
                        <span style="color: #8b2252;">'endpoint'</span>: hostname,
                        <span style="color: #8b2252;">'timestamp'</span>: timestamp,
                        <span style="color: #8b2252;">'step'</span>: step,
                        <span style="color: #8b2252;">'value'</span>: value,
                        <span style="color: #8b2252;">'counterType'</span>: <span style="color: #8b2252;">"GAUGE"</span>,
                        <span style="color: #8b2252;">'tages'</span>: tag
                    }
                    payload.append(i)
        open_falcon_push(payload)
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        <span style="color: #a0522d;">msg</span> = traceback.format_exc(chain=<span style="color: #008b8b;">False</span>)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"Exception: {msg}"</span>)
    <span style="color: #a020f0;">finally</span>:
        <span style="color: #483d8b;">print</span>(payload)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">openfiles</span>():
    <span style="color: #a0522d;">nginx_conf</span> = []
    <span style="color: #a0522d;">nginx_path</span> = <span style="color: #8b2252;">"/data/logs/"</span>
    <span style="color: #a0522d;">value</span>=1

    <span style="color: #a0522d;">g</span> = os.walk(nginx_path)
    <span style="color: #a020f0;">for</span> path, dir_list, file_list <span style="color: #a020f0;">in</span> g:
        <span style="color: #a020f0;">for</span> <span style="color: #483d8b;">file</span> <span style="color: #a020f0;">in</span> file_list:
            <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'error.log'</span> <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">file</span> <span style="color: #a020f0;">and</span> <span style="color: #8b2252;">'2019'</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">file</span>:
                nginx_conf.append(<span style="color: #483d8b;">file</span>)

    <span style="color: #a020f0;">for</span> conf_name <span style="color: #a020f0;">in</span> nginx_conf:
        <span style="color: #a0522d;">nginxpath</span> = <span style="color: #8b2252;">''</span>
        <span style="color: #a0522d;">nginxpath</span> = nginx_path + conf_name
        <span style="color: #a0522d;">f</span> = <span style="color: #483d8b;">open</span>(nginxpath,<span style="color: #8b2252;">"r"</span>,encoding=<span style="color: #8b2252;">'utf-8'</span>, errors=<span style="color: #8b2252;">'replace'</span>)
        <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> f.readlines():
            <span style="color: #a0522d;">i</span> = i.strip(<span style="color: #8b2252;">"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">"</span>)
            <span style="color: #a0522d;">time_date</span> = i.split(<span style="color: #8b2252;">" "</span>)
            <span style="color: #a0522d;">fiveminago</span> =  (datetime.datetime.now()-datetime.timedelta(minutes=5)).strftime(<span style="color: #8b2252;">"%H:%M:%S"</span>)
            <span style="color: #a020f0;">if</span> time_date[1] &lt; fiveminago:
                <span style="color: #a020f0;">pass</span>
            <span style="color: #a020f0;">else</span>:
                <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">"Too many open files"</span> <span style="color: #a020f0;">in</span> i :
                    <span style="color: #a0522d;">value</span>=0
        f.close()
    <span style="color: #a020f0;">return</span> value
<span style="color: #b22222;">#</span><span style="color: #b22222;">--------------------------------------end</span>

<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">'__main__'</span>:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(sys.argv)</span>
    main()
</pre>
</div>

<p>
go脚本模板
</p>
<div class="org-src-container">
<pre class="src src-sh">
</pre>
</div>
</div>
</div>
</section>
</main class="container">
<footer id="postamble" class="status">
<footer data-astro-cid-sz7xmlte data-turbo-permanent id=rootFooter>
    <script>
        const shuffle = e => e.map((e => ({
            v: e,
            sort: Math.random()
        }))).sort(( (e, o) => e.sort - o.sort)).map(( ({v: e}) => e));
        var songList = ["barbie-girl--stantough", "blue-da-ba-dee--cornelius-link", "hips-dont-lie--stantough", "i-want-it-that-way--stantough", "seven-nation-army--stantough", "smooth-criminal--stantough"]
          , songOrder = songOrder ?? shuffle(songList).map((e => `/audio/music/${e}.opus`))
          , song = new Audio(songOrder[0])
          , nextSong = new Audio(songOrder[1])
          , songIndex = 2
          , musicWrapper = void 0
          , arrow = void 0
          , notes = void 0;
        song.addEventListener("ended", next);
        const toggle = () => song.paused ? play() : pause();
        function play() {
            song.play(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.add("shakeManHorse"),
            notes.classList.remove("hideNotes")
        }
        function pause() {
            song.pause(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.remove("shakeManHorse"),
            notes.classList.add("hideNotes")
        }
        function next() {
            song = nextSong,
            play(),
            songIndex === songOrder.length && (songIndex = 0),
            nextSong = new Audio(songOrder[songIndex]),
            songIndex += 1
        }
        function skip() {
            pause(),
            (arrow = arrow || document.getElementById("musicArrow")).classList.add("shootArrow");
            new Audio("/audio/effects/ohno.m4a").play(),
            arrow.addEventListener("animationend", arrowShootHandler, !1)
        }
        function arrowShootHandler() {
            arrow.removeEventListener("animationend", arrowShootHandler, !1),
            arrow.classList.remove("shootArrow");
            new Audio("/audio/effects/heythathurt.m4a").play(),
            next()
        }
    </script>
    <div id=musicPlayer data-astro-cid-q7a5pyro>
        <button class=skip data-astro-cid-q7a5pyro onclick=skip() title="Skip song">
            <div id=skipWrapper data-astro-cid-q7a5pyro>
                <img alt="Medieval drollery of a man/snail/bat/monkey shooting an arrow" class=archer decoding=async height=334 loading=lazy src=/images/archer-no-arrow.448ccd8b_Z1KfRYq.webp width=226 data-astro-cid-q7a5pyro>
                <img alt="Arrow for archer" class="arrow complete" decoding=async height=23 loading=lazy src=/images/no-archer-full-arrow.87aa9971_Z2qL2KO.webp width=141 data-astro-cid-q7a5pyro id=musicArrow>
            </div>
        </button>
        <button class=playPause data-astro-cid-q7a5pyro onclick=toggle() title="Play/pause song">
            <div id=musicWrapper data-astro-cid-q7a5pyro>
                <div class=hideNotes id=notesWrapper data-astro-cid-q7a5pyro>
                    <div class=lyreNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                    <div class=fluteNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                </div>
                <img alt="Medieval drollery of a man/horse playing a lyre and a horn" class=manHorse decoding=async height=665 loading=lazy src=/images/man-horse-band.e3a2efcf_q8FCa.webp width=531 data-astro-cid-q7a5pyro>
            </div>
        </button>
    </div>
    <hr data-astro-cid-sz7xmlte>
    <div class=salutation data-astro-cid-gdmrbrho>
        <p data-astro-cid-gdmrbrho>
            <span class=flower2 data-astro-cid-gdmrbrho>A</span>
            <span class=smallcap data-astro-cid-gdmrbrho>pax vobiscum</span>
            <span class="flower2 wiggle" data-astro-cid-gdmrbrho id=leaf>a</span>
        </p>
    </div>
    <script>
        function animateLeafBlownHandler() {
            leaf.removeEventListener("animationend", animateLeafBlownHandler, !1),
            leaf.classList.remove("blownAway"),
            leaf.classList.add("wiggle")
        }
        function animateLeaf() {
            leaf = leaf ?? document.getElementById("leaf"),
            leaf.classList.remove("wiggle"),
            leaf.classList.add("blownAway"),
            leaf.addEventListener("animationend", animateLeafBlownHandler, !1)
        }
        document.getElementById("leaf").onclick = animateLeaf
    </script>


    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2024 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
</footer>
</footer>
</body>
</html>
