<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>scripts-monitor</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/distro-htmlize.css">
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">scripts-monitor</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:5defa03d-c8f2-4307-a0a9-ba835f4d701b">监控_rabbitmq</a></li>
<li><a href="#h:b9afa82a-7b3e-497c-b1ec-2c24b7ccc897">监控_实时文件对比</a></li>
<li><a href="#h:eac0ad2a-2b28-4ab1-b28d-1bd17998500e">监控_网络流量</a>
<ul>
<li><a href="#h:f36c9204-573a-4168-a480-bf0909a534ee">监控_网络流量1</a></li>
<li><a href="#h:a42010eb-afce-4eee-a1fb-2e6aa0555895">监控_网络流量2</a></li>
</ul>
</li>
<li><a href="#h:986c1252-31a6-407d-831a-699573410f1f">监控_连接数检查</a></li>
<li><a href="#h:356fe2c1-f269-48e7-954a-9810563e7d6e">监控-marathon-check</a></li>
<li><a href="#h:b73a8850-4e2e-4774-9e18-ae426741fc99">高峰关闭服务</a></li>
<li><a href="#h:1afde075-2ee4-499a-9451-7fe9d84fd56d">prometheus</a>
<ul>
<li><a href="#h:8748d3fe-8b3b-4eb9-9c3a-ec9216e4e62b">阿里SLS分析</a></li>
</ul>
</li>
<li><a href="#h:fb49990a-421f-4368-9a44-f96a808530db">openflcon</a>
<ul>
<li><a href="#h:18e1e22c-e42f-4020-a5ac-e5e5d59320c0">网络质量监控脚本</a></li>
<li><a href="#h:725329d7-d66d-4578-aeaf-c3cc41e813e9">openflacon-zookeeeper</a></li>
<li><a href="#h:294b25b4-1d3a-4777-b478-51dc1a70deed">服务监控治理</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="./../index.html">Script</a></li>
</ul>
<section id="outline-container-h:5defa03d-c8f2-4307-a0a9-ba835f4d701b" class="outline-2">
<h2 id="h:5defa03d-c8f2-4307-a0a9-ba835f4d701b"><a href="#h:5defa03d-c8f2-4307-a0a9-ba835f4d701b">监控_rabbitmq</a></h2>
<div class="outline-text-2" id="text-h:5defa03d-c8f2-4307-a0a9-ba835f4d701b">
<div class="org-src-container">
<pre class="src src-sh">monitor_rabbitmq.sh

<span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/bash
</span><span class="org-comment-delimiter"># </span><span class="org-comment">20140102
</span><span class="org-comment-delimiter"># </span><span class="org-comment">AUTHOR coolber
</span>
<span class="org-variable-name">DATE</span>=$(date <span class="org-string">"+%F %T"</span>)
<span class="org-variable-name">MONITOR_LOG</span>=/root/scripts/log/monitor_rabbitmq_queue.log
<span class="org-variable-name">RECEIVE_MAILER2</span>=changwei.xu@cici.com
<span class="org-variable-name">METRIC_NUM</span>=100


<span class="org-builtin">echo</span> <span class="org-string">"### ${DATE} Rabbitmq queue ###"</span> &gt;$<span class="org-variable-name">MONITOR_LOG</span>

/usr/local/rabbitmq/sbin/rabbitmqctl list_queues &gt;&gt;$<span class="org-variable-name">MONITOR_LOG</span>

<span class="org-keyword">if</span> [ $<span class="org-variable-name">?</span> -eq 0 ]
<span class="org-keyword">then</span>
    <span class="org-keyword">while </span><span class="org-builtin">read</span> i
    <span class="org-keyword">do</span>
        <span class="org-variable-name">CUR_NUM</span>=$( <span class="org-builtin">echo</span> $<span class="org-variable-name">i</span> | awk <span class="org-string">'{ print $NF }'</span> | grep -vE <span class="org-string">'^#|^$'</span> | grep -E <span class="org-string">'[0-9]+'</span> )
        <span class="org-comment-delimiter">#</span><span class="org-comment">if [[ ! -z $CUR_NUM &amp;&amp; $METRIC_NUM -gt $CUR_NUM ]]
</span>        <span class="org-keyword">if</span> [[ $<span class="org-variable-name">METRIC_NUM</span> -lt $<span class="org-variable-name">CUR_NUM</span> ]]
        <span class="org-keyword">then</span>
            <span class="org-comment-delimiter">#</span><span class="org-comment">echo -e "### $DATE #### \n${i} " | mail -s "Host: nameserver,rabbitmq queue is Abnormal" $RECEIVE_MAILER
</span>            <span class="org-builtin">echo</span> -e <span class="org-string">"### $DATE #### \n${i} "</span> | mail -s <span class="org-string">"Host: nameserver,rabbitmq queue is Abnormal"</span> $<span class="org-variable-name">RECEIVE_MAILER2</span>
        <span class="org-keyword">fi</span>
    <span class="org-keyword">done</span> &lt;${<span class="org-variable-name">MONITOR_LOG</span>}
<span class="org-keyword">else</span>
<span class="org-comment-delimiter">#    </span><span class="org-comment">echo "rabbitmq queue info Abnormal" | mail -s  " rabbitmq service is maybe Unavailable " $RECEIVE_MAILER
</span>    <span class="org-builtin">echo</span> <span class="org-string">"rabbitmq queue info Abnormal"</span> | mail -s  <span class="org-string">" rabbitmq service is maybe Unavailable "</span> $<span class="org-variable-name">RECEIVE_MAILER2</span>
<span class="org-keyword">fi</span>
</pre>
</div>
</div>
</section>
<section id="outline-container-h:b9afa82a-7b3e-497c-b1ec-2c24b7ccc897" class="outline-2">
<h2 id="h:b9afa82a-7b3e-497c-b1ec-2c24b7ccc897"><a href="#h:b9afa82a-7b3e-497c-b1ec-2c24b7ccc897">监控_实时文件对比</a></h2>
<div class="outline-text-2" id="text-h:b9afa82a-7b3e-497c-b1ec-2c24b7ccc897">
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">&#65281;/bin/bash
</span><span class="org-variable-name">DATE</span>=$(date <span class="org-string">"+%F %T"</span>)
<span class="org-variable-name">i</span>=0
<span class="org-variable-name">interval</span>=1700

<span class="org-variable-name">old_date</span>=(<span class="org-sh-quoted-exec">`tail -1 /mnt/logs/consumer/apps_consumer.log|sed 's#\([^ ]*\) \([^,]*\),\([0-9]*\)\(\[.*\)#\1 \2 \3 \4#g'`</span>)
<span class="org-variable-name">old_date_d</span>=${<span class="org-variable-name">old_date</span>[0]}
<span class="org-variable-name">old_date_h</span>=${<span class="org-variable-name">old_date</span>[1]}
<span class="org-variable-name">old_java_n</span>=${<span class="org-variable-name">old_date</span>[2]}

<span class="org-variable-name">count</span>=$[1700/$<span class="org-variable-name">interval</span>]   <span class="org-comment-delimiter"># </span><span class="org-comment">$[]&#21482;&#33021;&#36827;&#34892;&#25972;&#25968;&#36816;&#31639;
</span><span class="org-variable-name">RECEIVE_MAILER1</span>=xiahua.yan@emacle.com
<span class="org-variable-name">RECEIVE_MAILER2</span>=changwei.xu@emacle.com

<span class="org-keyword">while</span> [ $<span class="org-variable-name">i</span> -lt $<span class="org-variable-name">count</span> ]
<span class="org-keyword">do</span>
    sleep $<span class="org-variable-name">interval</span>
    <span class="org-variable-name">new_date</span>=(<span class="org-sh-quoted-exec">`tail -1 /mnt/logs/consumer/apps_consumer.log|sed 's#\([^ ]*\) \([^,]*\),\([0-9]*\)\(\[.*\)#\1 \2 \3 \4#g'`</span>)
    <span class="org-variable-name">new_date_d</span>=${<span class="org-variable-name">new_date</span>[0]}
    <span class="org-variable-name">new_date_h</span>=${<span class="org-variable-name">new_date</span>[1]}
    <span class="org-variable-name">new_java_n</span>=${<span class="org-variable-name">new_date</span>[2]}
<span class="org-comment-delimiter">#</span><span class="org-comment">if [ ${old_date_d} == $(tail -1 /mnt/logs/consumer/apps_consumer.log|sed 's#\([^ ]*\) \([^,]*\).*#\1#g') -a ${old_date_h} == $(tail -1 /mnt/logs/consumer/apps_consumer.log|sed 's#\([^ ]*\) \([^,]*\).*#\2#g')  ];then
</span>    <span class="org-keyword">if</span> [ ${<span class="org-variable-name">old_date_d</span>} == ${<span class="org-variable-name">new_date_d</span>} -a ${<span class="org-variable-name">old_date_h</span>} == ${<span class="org-variable-name">new_date_h</span>} -a ${<span class="org-variable-name">old_java_n</span>} == ${<span class="org-variable-name">new_java_n</span>} ];<span class="org-keyword">then</span>
        <span class="org-builtin">echo</span> -e <span class="org-string">"### $DATE #### \n'/mnt/logs/consumer/apps_consumer.log  not updated' \n consumer_info:\n ${new_date[@]} "</span> | mail -s <span class="org-string">"Host(134): searchlog,rabbitmq queue is Abnormal"</span> $<span class="org-variable-name">RECEIVE_MAILER1</span>
        <span class="org-builtin">echo</span> -e <span class="org-string">"### $DATE #### \n'/mnt/logs/consumer/apps_consumer.log  not updated' \n consumer_info:\n ${new_date[@]} "</span> | mail -s <span class="org-string">"Host(134): searchlog,rabbitmq queue is Abnormal"</span> $<span class="org-variable-name">RECEIVE_MAILER2</span>
    <span class="org-keyword">fi</span>
    ((i++))
<span class="org-keyword">done</span>
</pre>
</div>
</div>
</section>
<section id="outline-container-h:eac0ad2a-2b28-4ab1-b28d-1bd17998500e" class="outline-2">
<h2 id="h:eac0ad2a-2b28-4ab1-b28d-1bd17998500e"><a href="#h:eac0ad2a-2b28-4ab1-b28d-1bd17998500e">监控_网络流量</a></h2>
<div class="outline-text-2" id="text-h:eac0ad2a-2b28-4ab1-b28d-1bd17998500e">
</div>
<div id="outline-container-h:f36c9204-573a-4168-a480-bf0909a534ee" class="outline-3">
<h3 id="h:f36c9204-573a-4168-a480-bf0909a534ee"><a href="#h:f36c9204-573a-4168-a480-bf0909a534ee">监控_网络流量1</a></h3>
<div class="outline-text-3" id="text-h:f36c9204-573a-4168-a480-bf0909a534ee">
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span><span class="org-comment">
</span><span class="org-variable-name">PATH</span>=/bin:/usr/bin:/sbin:/usr/sbin:/usr/local/bin:/usr/local/sbin;
<span class="org-builtin">export</span> PATH

<span class="org-comment-delimiter">#</span><span class="org-comment">&#26412;&#22320;&#32593;&#21345;&#21517;
</span><span class="org-comment-delimiter">#</span><span class="org-comment">local nic_arr=(`ifconfig | grep -E -o "^[a-z0-9]+" | grep -v "lo" | uniq`)
</span><span class="org-comment-delimiter">#</span><span class="org-comment">&#26412;&#22320;&#32593;&#21345;&#20010;&#25968;
</span><span class="org-comment-delimiter">#</span><span class="org-comment">local nicLen=${#nic_arr[@]}
</span><span class="org-comment-delimiter">#</span><span class="org-comment">eth=$nic_arr
</span><span class="org-comment-delimiter">#</span><span class="org-comment">&#24403;&#21069;&#27969;&#37327;
</span><span class="org-comment-delimiter">#</span><span class="org-comment">traffic_be=(`awk -v eth=$eth -F'[: ]+' '{if ($0 ~eth){print $3,$11}}' /proc/net/dev`)
</span>

<span class="org-keyword">function</span> <span class="org-function-name">traffic_monitor</span> {
  <span class="org-comment-delimiter"># </span><span class="org-comment">&#31995;&#32479;&#29256;&#26412;
</span>  <span class="org-variable-name">OS_NAME</span>=$(sed -n <span class="org-string">'1p'</span> /etc/issue)
  <span class="org-comment-delimiter"># </span><span class="org-comment">&#32593;&#21475;&#21517;
</span>  <span class="org-variable-name">eth</span>=$<span class="org-variable-name">1</span>
  <span class="org-comment-delimiter">#</span><span class="org-comment">&#21028;&#26029;&#32593;&#21345;&#23384;&#22312;&#19982;&#21542;,&#19981;&#23384;&#22312;&#21017;&#36864;&#20986;
</span>  <span class="org-keyword">if</span> [ <span class="org-negation-char">!</span> -d /sys/class/net/$<span class="org-variable-name">eth</span> ];<span class="org-keyword">then</span>
      <span class="org-builtin">echo</span> -e <span class="org-string">"Network-Interface Not Found"</span>
      <span class="org-builtin">echo</span> -e <span class="org-string">"You system have network-interface:\n`ls /sys/class/net`"</span>
      <span class="org-keyword">exit</span> 5
  <span class="org-keyword">fi</span>
  <span class="org-keyword">while</span> [ <span class="org-string">"1"</span> ]
  <span class="org-keyword">do</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#29366;&#24577;
</span>    <span class="org-variable-name">STATUS</span>=<span class="org-string">"fine"</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#33719;&#21462;&#24403;&#21069;&#26102;&#21051;&#32593;&#21475;&#25509;&#25910;&#19982;&#21457;&#36865;&#30340;&#27969;&#37327;
</span>    <span class="org-variable-name">RXpre</span>=$(cat /proc/net/dev | grep $<span class="org-variable-name">eth</span> | tr : <span class="org-string">" "</span> | awk <span class="org-string">'{print $2}'</span>)
    <span class="org-variable-name">TXpre</span>=$(cat /proc/net/dev | grep $<span class="org-variable-name">eth</span> | tr : <span class="org-string">" "</span> | awk <span class="org-string">'{print $10}'</span>)
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#33719;&#21462;1&#31186;&#21518;&#32593;&#21475;&#25509;&#25910;&#19982;&#21457;&#36865;&#30340;&#27969;&#37327;
</span>    sleep 1
    <span class="org-variable-name">RXnext</span>=$(cat /proc/net/dev | grep $<span class="org-variable-name">eth</span> | tr : <span class="org-string">" "</span> | awk <span class="org-string">'{print $2}'</span>)
    <span class="org-variable-name">TXnext</span>=$(cat /proc/net/dev | grep $<span class="org-variable-name">eth</span> | tr : <span class="org-string">" "</span> | awk <span class="org-string">'{print $10}'</span>)
    clear
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#33719;&#21462;&#36825;1&#31186;&#38047;&#23454;&#38469;&#30340;&#36827;&#20986;&#27969;&#37327;
</span>    <span class="org-variable-name">RX</span>=$((${<span class="org-variable-name">RXnext</span>}-${<span class="org-variable-name">RXpre</span>}))
    <span class="org-variable-name">TX</span>=$((${<span class="org-variable-name">TXnext</span>}-${<span class="org-variable-name">TXpre</span>}))
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#21028;&#26029;&#25509;&#25910;&#27969;&#37327;&#22914;&#26524;&#22823;&#20110;MB&#25968;&#37327;&#32423;&#21017;&#26174;&#31034;MB&#21333;&#20301;,&#21542;&#21017;&#26174;&#31034;KB&#25968;&#37327;&#32423;
</span>    <span class="org-keyword">if</span> [[ $<span class="org-variable-name">RX</span> -lt 1024 ]];<span class="org-keyword">then</span>
      <span class="org-variable-name">RX</span>=<span class="org-string">"${RX}B/s"</span>
    <span class="org-keyword">elif</span> [[ $<span class="org-variable-name">RX</span> -gt 1048576 ]];<span class="org-keyword">then</span>
      <span class="org-variable-name">RX</span>=$(<span class="org-builtin">echo</span> $<span class="org-variable-name">RX</span> | awk <span class="org-string">'{print $1/1048576 "MB/s"}'</span>)
      $<span class="org-variable-name">STATUS</span>=<span class="org-string">"busy"</span>
    <span class="org-keyword">else</span>
      <span class="org-variable-name">RX</span>=$(<span class="org-builtin">echo</span> $<span class="org-variable-name">RX</span> | awk <span class="org-string">'{print $1/1024 "KB/s"}'</span>)
    <span class="org-keyword">fi</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#21028;&#26029;&#21457;&#36865;&#27969;&#37327;&#22914;&#26524;&#22823;&#20110;MB&#25968;&#37327;&#32423;&#21017;&#26174;&#31034;MB&#21333;&#20301;,&#21542;&#21017;&#26174;&#31034;KB&#25968;&#37327;&#32423;
</span>    <span class="org-keyword">if</span> [[ $<span class="org-variable-name">TX</span> -lt 1024 ]];<span class="org-keyword">then</span>
      <span class="org-variable-name">TX</span>=<span class="org-string">"${TX}B/s"</span>
      <span class="org-keyword">elif</span> [[ $<span class="org-variable-name">TX</span> -gt 1048576 ]];<span class="org-keyword">then</span>
      <span class="org-variable-name">TX</span>=$(<span class="org-builtin">echo</span> $<span class="org-variable-name">TX</span> | awk <span class="org-string">'{print $1/1048576 "MB/s"}'</span>)
    <span class="org-keyword">else</span>
      <span class="org-variable-name">TX</span>=$(<span class="org-builtin">echo</span> $<span class="org-variable-name">TX</span> | awk <span class="org-string">'{print $1/1024 "KB/s"}'</span>)
    <span class="org-keyword">fi</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#25171;&#21360;&#20449;&#24687;    echo -e "Date:   `date +%F`"
</span> <span class="org-comment-delimiter">#   </span><span class="org-comment">echo -e "Time:   `date +%k:%M:%S`"
</span> <span class="org-comment-delimiter">#   </span><span class="org-comment">echo -e "Port:   $1"
</span> <span class="org-comment-delimiter">#   </span><span class="org-comment">echo -e "Status: $STATUS"
</span> <span class="org-comment-delimiter">#   </span><span class="org-comment">echo -e  " \t     RX \tTX"
</span>    <span class="org-builtin">echo</span> <span class="org-string">"------------------------------"</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#25171;&#21360;&#23454;&#26102;&#27969;&#37327;
</span>    <span class="org-builtin">echo</span> -e <span class="org-string">"Time:`date +%k:%M:%S` $eth \t 'RX:'$RX   'TX:'$TX "</span>
    <span class="org-builtin">echo</span> <span class="org-string">"------------------------------"</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#36864;&#20986;&#20449;&#24687;
</span>    <span class="org-builtin">echo</span> -e <span class="org-string">"Press 'Ctrl+C' to exit"</span>
  <span class="org-keyword">done</span>
}
<span class="org-comment-delimiter"># </span><span class="org-comment">&#21028;&#26029;&#25191;&#34892;&#21442;&#25968;
</span><span class="org-keyword">if</span> [[ -n <span class="org-string">"$1"</span> ]];<span class="org-keyword">then</span>
  <span class="org-comment-delimiter"># </span><span class="org-comment">&#25191;&#34892;&#20989;&#25968;
</span>  traffic_monitor $<span class="org-variable-name">1</span>
<span class="org-keyword">else</span>
  <span class="org-builtin">echo</span> -e <span class="org-string">"None parameter,please add system netport after run the script! \nExample: 'sh traffic_monitor eth0'"</span>
<span class="org-keyword">fi</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a42010eb-afce-4eee-a1fb-2e6aa0555895" class="outline-3">
<h3 id="h:a42010eb-afce-4eee-a1fb-2e6aa0555895"><a href="#h:a42010eb-afce-4eee-a1fb-2e6aa0555895">监控_网络流量2</a></h3>
<div class="outline-text-3" id="text-h:a42010eb-afce-4eee-a1fb-2e6aa0555895">
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span><span class="org-comment">
</span><span class="org-variable-name">R2</span>=<span class="org-sh-quoted-exec">`cat /sys/class/net/$1/statistics/rx_bytes`</span>
<span class="org-variable-name">T2</span>=<span class="org-sh-quoted-exec">`cat /sys/class/net/$1/statistics/tx_bytes`</span>
<span class="org-variable-name">NUM</span>=100000
<span class="org-keyword">if</span> [ -z <span class="org-string">"$1"</span> ]; <span class="org-keyword">then</span>
        <span class="org-builtin">echo</span>
        <span class="org-builtin">echo</span> usage: $<span class="org-variable-name">0</span> network-interface
        <span class="org-builtin">echo</span>
        <span class="org-builtin">echo</span> e.g. $<span class="org-variable-name">0</span> eth0
        <span class="org-builtin">echo</span>
        <span class="org-keyword">exit</span>
<span class="org-keyword">fi</span>
<span class="org-variable-name">IF</span>=$<span class="org-variable-name">1</span>
<span class="org-keyword">while </span><span class="org-builtin">true</span>
<span class="org-keyword">do</span>
        <span class="org-variable-name">R1</span>=<span class="org-sh-quoted-exec">`cat /sys/class/net/$1/statistics/rx_bytes`</span>
        <span class="org-variable-name">T1</span>=<span class="org-sh-quoted-exec">`cat /sys/class/net/$1/statistics/tx_bytes`</span>
        <span class="org-variable-name">TBPS</span>=<span class="org-sh-quoted-exec">`expr $T1 - $T2`</span>
        <span class="org-variable-name">RBPS</span>=<span class="org-sh-quoted-exec">`expr $R1 - $R2`</span>
        <span class="org-variable-name">TKBPS</span>=<span class="org-sh-quoted-exec">`expr $TBPS / 1024`</span>
        <span class="org-variable-name">RKBPS</span>=<span class="org-sh-quoted-exec">`expr $RBPS / 1024`</span>
        <span class="org-comment-delimiter">#</span><span class="org-comment">RKBPS1=`echo "scale=3; $RBPS/$NUM"|bc`
</span>        <span class="org-builtin">eval</span> <span class="org-sh-quoted-exec">`date "+day=%d; month=%m; year=%Y; hour=%H; minute=%M second=%S"`</span>
        <span class="org-variable-name">INSTFIL4</span>=<span class="org-string">"$hour:$minute:$second"</span>
        <span class="org-builtin">echo</span> <span class="org-string">"$INSTFIL4 tx $1: $TKBPS kb/ rx $RKBPS kb/s "</span>

        <span class="org-variable-name">R2</span>=<span class="org-sh-quoted-exec">`cat /sys/class/net/$1/statistics/rx_bytes`</span>
        <span class="org-variable-name">T2</span>=<span class="org-sh-quoted-exec">`cat /sys/class/net/$1/statistics/tx_bytes`</span>
        sleep 1s
<span class="org-keyword">done</span>
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:986c1252-31a6-407d-831a-699573410f1f" class="outline-2">
<h2 id="h:986c1252-31a6-407d-831a-699573410f1f"><a href="#h:986c1252-31a6-407d-831a-699573410f1f">监控_连接数检查</a></h2>
<div class="outline-text-2" id="text-h:986c1252-31a6-407d-831a-699573410f1f">
<div class="org-src-container">
<pre class="src src-sh">cat &lt;&lt;\EOF&gt; monitor_conntrack.sh<span class="org-sh-heredoc">
#!/bin/bash

#set -x
#CON_NUM=$(wc -l /proc/net/ip_conntrack | awk '{print $1}')
#CON_NUM=$(cat /proc/sys/net/ipv4/netfilter/ip_conntrack_count)
CON_NUM=$(cat /proc/sys/net/netfilter/nf_conntrack_count)
TRACK_LOG=/root/tools/logs/conntrack.log
ALARM_NUM=50000
REC_MAILER='changwei.xu@emacle.com'
DATE=$(date '+%F %T')
HOST_NAME=$(hostname)

echo "$DATE  $HOST_NAME Current conntrack number is $CON_NUM " &gt;&gt;$TRACK_LOG
if [ $ALARM_NUM -le $CON_NUM ]
then
    echo "$DATE $HOST_NAME Current conntrack number is $CON_NUM "| mail -s 'Conntrack alarm' $REC_MAILER
fi
EOF</span>
</pre>
</div>
</div>
</section>
<section id="outline-container-h:356fe2c1-f269-48e7-954a-9810563e7d6e" class="outline-2">
<h2 id="h:356fe2c1-f269-48e7-954a-9810563e7d6e"><a href="#h:356fe2c1-f269-48e7-954a-9810563e7d6e">监控-marathon-check</a></h2>
<div class="outline-text-2" id="text-h:356fe2c1-f269-48e7-954a-9810563e7d6e">
<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/python
</span><span class="org-comment-delimiter"># </span><span class="org-comment">-*- coding: utf-8 -*-
</span><span class="org-keyword">import</span> urllib2
<span class="org-keyword">import</span> sys
<span class="org-keyword">import</span> subprocess
<span class="org-keyword">import</span> urllib
<span class="org-keyword">import</span> time
<span class="org-keyword">import</span> socket
<span class="org-keyword">import</span> os,re
<span class="org-keyword">import</span> requests,json
<span class="org-keyword">import</span> commands

<span class="org-keyword">def</span> <span class="org-function-name">get_host_ip</span>():
    <span class="org-keyword">try</span>:
        <span class="org-variable-name">s</span> <span class="org-operator">=</span> socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        s.connect((<span class="org-string">'8.8.8.8'</span>, 80))
        <span class="org-variable-name">ip</span> <span class="org-operator">=</span> s.getsockname()[0]
    <span class="org-keyword">finally</span>:
        s.close()
    <span class="org-keyword">return</span> ip
<span class="org-keyword">def</span> <span class="org-function-name">get_nginx_conf</span>():
    <span class="org-variable-name">apps</span> <span class="org-operator">=</span> []
    <span class="org-keyword">try</span>:
       <span class="org-keyword">if</span> os.path.exists(<span class="org-string">"/home/sh/nginx_marathon/nginx_conf.sh"</span>):
           os.system(<span class="org-string">'/usr/bin/sh /home/sh/nginx_marathon/nginx_conf.sh'</span>)
       <span class="org-keyword">if</span> os.path.exists(<span class="org-string">"/home/sh/nginx_marathon/nginx_conf"</span>):
           <span class="org-variable-name">fs</span> <span class="org-operator">=</span> commands.getoutput(<span class="org-string">'cat /home/sh/nginx_marathon/nginx_conf'</span>)
           <span class="org-keyword">if</span> fs:
               <span class="org-variable-name">b</span><span class="org-operator">=</span>re.<span class="org-builtin">compile</span>(<span class="org-string">'^upstream\s*(.\S*)\s*{</span><span class="org-constant">\n</span><span class="org-string">\s+(.*)'</span>,re.MULTILINE)
               <span class="org-variable-name">tags</span> <span class="org-operator">=</span> (b.findall(fs))
               <span class="org-comment-delimiter">#</span><span class="org-comment">print tags
</span>               <span class="org-keyword">for</span> i <span class="org-keyword">in</span> tags:
                   <span class="org-keyword">try</span>:
                       <span class="org-comment-delimiter">#</span><span class="org-comment">b=re.findall('(.*)-\d+',i[0])[0]
</span>                       <span class="org-variable-name">d</span><span class="org-operator">=</span>re.<span class="org-builtin">compile</span>(<span class="org-string">'(\d+.\d+.\d+.\d+)+'</span>,re.MULTILINE)
                       apps.append([re.findall(<span class="org-string">'(.*)-\d+'</span>,i[0])[0],d.findall(i[1])])
                   <span class="org-keyword">except</span>:
                       <span class="org-keyword">continue</span>
    <span class="org-keyword">except</span> <span class="org-type">Exception</span> <span class="org-keyword">as</span> e:
        <span class="org-builtin">print</span>(<span class="org-builtin">str</span>(e))
    <span class="org-keyword">return</span> apps

<span class="org-keyword">def</span> <span class="org-function-name">dindin</span>(token,msg):
    <span class="org-keyword">try</span>:
        <span class="org-variable-name">dindinapi</span> <span class="org-operator">=</span> <span class="org-string">'https://oapi.dingtalk.com/robot/send?access_token=%s'</span> <span class="org-operator">%</span> token
        <span class="org-variable-name">headers</span> <span class="org-operator">=</span> {<span class="org-string">'content-type'</span>: <span class="org-string">'application/json'</span>,<span class="org-string">'charset'</span>:<span class="org-string">'utf-8'</span>}
        <span class="org-variable-name">data</span>  <span class="org-operator">=</span> {
         <span class="org-string">"msgtype"</span>: <span class="org-string">"text"</span>,
         <span class="org-string">"text"</span>: {
         <span class="org-string">"content"</span>: msg
         },
         <span class="org-string">"at"</span>: {
         <span class="org-string">"atMobiles"</span>: [
         ],
         <span class="org-string">"isAtAll"</span>: <span class="org-constant">True</span>
         }
        }
        <span class="org-variable-name">req</span><span class="org-operator">=</span>requests.post(dindinapi,json<span class="org-operator">=</span>data,headers<span class="org-operator">=</span>headers)
    <span class="org-keyword">except</span> <span class="org-type">Exception</span> <span class="org-keyword">as</span> e:
        <span class="org-builtin">print</span>(<span class="org-builtin">str</span>(e))
<span class="org-keyword">def</span> <span class="org-function-name">check_marathon</span>():
    <span class="org-keyword">try</span>:
        <span class="org-variable-name">marathon_ip</span> <span class="org-operator">=</span> <span class="org-string">'192.168.101.150'</span>
        <span class="org-variable-name">host_ip</span> <span class="org-operator">=</span> get_host_ip()
        <span class="org-variable-name">hostname</span> <span class="org-operator">=</span> commands.getoutput(<span class="org-string">'hostname'</span>)
        <span class="org-variable-name">tokens</span> <span class="org-operator">=</span> <span class="org-string">'a6184389010ffc41f045ab23eab3d40f8ebe1cd9526e7832a131d718aa13057c'</span>
        <span class="org-variable-name">apps</span> <span class="org-operator">=</span> get_nginx_conf()
        <span class="org-variable-name">r</span> <span class="org-operator">=</span> requests.Session()
        r.<span class="org-variable-name">auth</span> <span class="org-operator">=</span> (<span class="org-string">'wowotuan'</span>,<span class="org-string">'wowotuan'</span>)
        <span class="org-keyword">for</span> i <span class="org-keyword">in</span> apps:
            <span class="org-keyword">if</span> i[0]:
                <span class="org-keyword">try</span>:
                    <span class="org-variable-name">s</span> <span class="org-operator">=</span> r.get(<span class="org-string">'http://%s:8080/v2/apps/%s'</span> <span class="org-operator">%</span> (marathon_ip,i[0].encode(<span class="org-string">'utf8'</span>)))
                    <span class="org-variable-name">app_infos</span> <span class="org-operator">=</span> s.json()[<span class="org-string">'app'</span>]
                    <span class="org-variable-name">hosts</span> <span class="org-operator">=</span> []
                    <span class="org-keyword">if</span> app_infos:
                        <span class="org-keyword">for</span> task <span class="org-keyword">in</span> app_infos[<span class="org-string">'tasks'</span>]:
                            hosts.append(task[<span class="org-string">'host'</span>].encode(<span class="org-string">'utf8'</span>))
                    <span class="org-keyword">for</span> ip <span class="org-keyword">in</span> i[1]:
                        <span class="org-keyword">if</span> ip.encode(<span class="org-string">'utf8'</span>) <span class="org-keyword">not</span> <span class="org-keyword">in</span> hosts:
                            <span class="org-variable-name">msg</span> <span class="org-operator">=</span> <span class="org-string">'tc hb2  nginx:%s-%s app:%s ip:%s &#27880;&#20876;&#22833;&#36133;'</span> <span class="org-operator">%</span> (hostname,host_ip,i[0],ip)
                            <span class="org-builtin">print</span> msg
                            dindin(tokens,msg)
                        <span class="org-keyword">else</span>:
                            <span class="org-variable-name">msg</span> <span class="org-operator">=</span> <span class="org-string">'tc hb2  nginx:%s-%s app:%s ip:%s  &#27880;&#20876;&#25104;&#21151;'</span> <span class="org-operator">%</span> (hostname,host_ip,i[0],ip)
                            <span class="org-builtin">print</span> msg
                <span class="org-keyword">except</span>:
                   <span class="org-keyword">continue</span>
    <span class="org-keyword">except</span> <span class="org-type">Exception</span> <span class="org-keyword">as</span> e:
        <span class="org-builtin">print</span>(<span class="org-builtin">str</span>(e))
<span class="org-comment-delimiter">#</span><span class="org-comment">print get_nginx_conf()
</span>check_marathon()
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">[root@tc-xy-nginx002 ~]# /usr/bin/python  /home/sh/nginx_marathon/nginx_marathon_check.py
tc hb2  nginx:tc-xy-nginx002-192.168.100.81 app:xy-qd-api-yzprod ip:192.168.101.248  &#27880;&#20876;&#25104;&#21151;
tc hb2  nginx:tc-xy-nginx002-192.168.100.81 app:yzbizcenter-admin-yzprod ip:192.168.101.26  &#27880;&#20876;&#25104;&#21151;
tc hb2  nginx:tc-xy-nginx002-192.168.100.81 app:yzbizcenter-admin-yzprod ip:192.168.101.2  &#27880;&#20876;&#25104;&#21151;
</pre>
</div>
</div>
</section>
<section id="outline-container-h:b73a8850-4e2e-4774-9e18-ae426741fc99" class="outline-2">
<h2 id="h:b73a8850-4e2e-4774-9e18-ae426741fc99"><a href="#h:b73a8850-4e2e-4774-9e18-ae426741fc99">高峰关闭服务</a></h2>
<div class="outline-text-2" id="text-h:b73a8850-4e2e-4774-9e18-ae426741fc99">
<p>
18 19 20 21 22 高峰时间停止服务运行
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@jumpserver01 ~]# cat /alidata/xuchangwei/checkpy.sh
<span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/bash
</span><span class="org-comment-delimiter">#</span><span class="org-comment">
</span><span class="org-builtin">export</span> <span class="org-variable-name">JAVA_HOME</span>=/usr/java/jdk1.8.0_40
<span class="org-builtin">export</span> <span class="org-variable-name">CLASSPATH</span>=.:$<span class="org-variable-name">JAVA_HOME</span>/jre/lib/rt.jar:$<span class="org-variable-name">JAVA_HOME</span>/lib/dt.jar:$<span class="org-variable-name">JAVA_HOME</span>/lib/tools.jar
<span class="org-builtin">export</span> <span class="org-variable-name">PATH</span>=$<span class="org-variable-name">PATH</span>:$<span class="org-variable-name">JAVA_HOME</span>/bin

<span class="org-keyword">function</span> <span class="org-function-name">check_time</span>() {
    <span class="org-variable-name">high</span>=<span class="org-string">"18 19 20 21 22"</span>
    <span class="org-keyword">if</span> [[ <span class="org-string">"$high"</span> =~ <span class="org-string">"$(date +%H)"</span> ]]; <span class="org-keyword">then</span>
    <span class="org-comment-delimiter">#</span><span class="org-comment">if [[ "$high" =~ "14" ]]; then
</span>        <span class="org-builtin">echo</span> <span class="org-string">"kill service"</span>
        <span class="org-builtin">kill</span> -9 $(ps -ef |grep updateCover |grep -v grep|awk <span class="org-string">'{print $2}'</span>)
        <span class="org-builtin">kill</span> -9 $(ps -ef |grep monitorjob.py |grep -v grep|awk <span class="org-string">'{print $2}'</span>)
        <span class="org-builtin">kill</span> -9 $(ps -ef |grep imagedeal-jar-with-dependencies.jar|grep -v grep| awk <span class="org-string">'{print $2}'</span>)
    <span class="org-keyword">else</span>
        check_pid
    <span class="org-keyword">fi</span>
}

<span class="org-keyword">function</span> <span class="org-function-name">check_pid</span>() {
    <span class="org-variable-name">i</span>=0
    <span class="org-variable-name">interval</span>=10
    <span class="org-variable-name">count</span>=$[60/$<span class="org-variable-name">interval</span>]
    
    <span class="org-keyword">while</span> [ $<span class="org-variable-name">i</span> -lt $<span class="org-variable-name">count</span> ]; <span class="org-keyword">do</span>
        <span class="org-variable-name">p_num</span>=$(ps -ef |grep updateCover |grep -v grep |wc -l)
        <span class="org-variable-name">m_num</span>=$(ps -ef |grep monitorjob.py |grep -v grep |wc -l)
        <span class="org-variable-name">i_num</span>=$(ps -ef |grep imagedeal-jar-with-dependencies.jar|grep -v grep|wc -l)
        <span class="org-keyword">if</span> [ $<span class="org-variable-name">p_num</span> == <span class="org-string">'0'</span> ]; <span class="org-keyword">then</span>
            <span class="org-builtin">cd</span> /alidata/xuchangwei/dealcover
            nohup python updateCover.py 1 300000000 &amp;&gt;&gt;to.log &amp;
        <span class="org-keyword">fi</span>
        <span class="org-keyword">if</span> [ $<span class="org-variable-name">m_num</span> == <span class="org-string">'0'</span> ]; <span class="org-keyword">then</span>
            <span class="org-builtin">cd</span> /alidata/xuchangwei/monitorcv
            nohup python monitorjob.py 10000 &amp;&gt;m.log &amp;
        <span class="org-keyword">fi</span>
        
        <span class="org-keyword">if</span> [ $<span class="org-variable-name">i_num</span> == <span class="org-string">'0'</span> ]; <span class="org-keyword">then</span>
            <span class="org-builtin">cd</span> /alidata/imagedeal/project/waterDeal/target/
            nohup java -jar /alidata/imagedeal/project/waterDeal/target/imagedeal-jar-with-dependencies.jar online 45 &gt;/alidata/imagedeal/project/imagedeal.log 2&gt;&amp;1 &amp;
        <span class="org-keyword">fi</span>
        
        
        ((i++))
        sleep $<span class="org-variable-name">interval</span>
    <span class="org-keyword">done</span>
}

check_time
</pre>
</div>
</div>
</section>
<section id="outline-container-h:1afde075-2ee4-499a-9451-7fe9d84fd56d" class="outline-2">
<h2 id="h:1afde075-2ee4-499a-9451-7fe9d84fd56d"><a href="#h:1afde075-2ee4-499a-9451-7fe9d84fd56d">prometheus</a></h2>
<div class="outline-text-2" id="text-h:1afde075-2ee4-499a-9451-7fe9d84fd56d">
</div>
<div id="outline-container-h:8748d3fe-8b3b-4eb9-9c3a-ec9216e4e62b" class="outline-3">
<h3 id="h:8748d3fe-8b3b-4eb9-9c3a-ec9216e4e62b"><a href="#h:8748d3fe-8b3b-4eb9-9c3a-ec9216e4e62b">阿里SLS分析</a></h3>
<div class="outline-text-3" id="text-h:8748d3fe-8b3b-4eb9-9c3a-ec9216e4e62b">
<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">-*- coding:UTF-8 -*-
</span><span class="org-keyword">import</span> datetime
<span class="org-keyword">import</span> os
<span class="org-keyword">import</span> time

<span class="org-keyword">from</span> alibabacloud_cms20190101 <span class="org-keyword">import</span> models <span class="org-keyword">as</span> cms_20190101_models
<span class="org-keyword">from</span> alibabacloud_cms20190101.client <span class="org-keyword">import</span> Client <span class="org-keyword">as</span> Cms20190101Client
<span class="org-keyword">from</span> alibabacloud_sls20201230 <span class="org-keyword">import</span> models <span class="org-keyword">as</span> sls_20201230_models
<span class="org-keyword">from</span> alibabacloud_sls20201230.client <span class="org-keyword">import</span> Client <span class="org-keyword">as</span> Sls20201230Client
<span class="org-keyword">from</span> alibabacloud_tea_openapi <span class="org-keyword">import</span> models <span class="org-keyword">as</span> open_api_models
<span class="org-keyword">from</span> alibabacloud_tea_util <span class="org-keyword">import</span> models <span class="org-keyword">as</span> util_models
<span class="org-keyword">from</span> alibabacloud_tea_util.client <span class="org-keyword">import</span> Client <span class="org-keyword">as</span> UtilClient
<span class="org-keyword">from</span> prometheus_client <span class="org-keyword">import</span> Gauge, start_http_server

<span class="org-variable-name">g4_1</span> <span class="org-operator">=</span> Gauge(<span class="org-string">'sls_undertow_service_qps'</span>, <span class="org-string">'service qps'</span>, [<span class="org-string">'service'</span>])
<span class="org-variable-name">g4_2</span> <span class="org-operator">=</span> Gauge(<span class="org-string">'sls_undertow_service_avg_rt'</span>, <span class="org-string">'service avg rt'</span>, [<span class="org-string">'service'</span>])
<span class="org-variable-name">g4_3_0</span> <span class="org-operator">=</span> Gauge(<span class="org-string">'sls_undertow_api_slow_level0'</span>, <span class="org-string">'api slow graater than 200ms '</span>, [<span class="org-string">'service'</span>, <span class="org-string">'uri'</span>])
<span class="org-variable-name">g4_3_4</span> <span class="org-operator">=</span> Gauge(<span class="org-string">'sls_undertow_api_slow_detail'</span>, <span class="org-string">'slow query detail'</span>,
               [<span class="org-string">'service'</span>, <span class="org-string">'uri'</span>, <span class="org-string">'avg_timeused'</span>, <span class="org-string">'min_timeused'</span>, <span class="org-string">'max_timeused'</span>])

<span class="org-variable-name">g6</span> <span class="org-operator">=</span> Gauge(<span class="org-string">'sls_exception_qpm'</span>, <span class="org-string">'exception qpm'</span>, [<span class="org-string">'service'</span>])


<span class="org-keyword">def</span> <span class="org-function-name">get_content_from_file</span>(file_path):
    <span class="org-keyword">if</span> <span class="org-keyword">not</span> os.path.exists(file_path):
        <span class="org-keyword">return</span> <span class="org-string">""</span>
    <span class="org-keyword">with</span> <span class="org-builtin">open</span>(file_path, <span class="org-string">'r'</span>) <span class="org-keyword">as</span> f:
        <span class="org-variable-name">content</span> <span class="org-operator">=</span> f.readlines()
        <span class="org-keyword">if</span> content:
            <span class="org-keyword">return</span> content[0].strip()
        <span class="org-keyword">return</span> <span class="org-string">""</span>


<span class="org-keyword">def</span> <span class="org-function-name">set_content_to_file</span>(content, file_path):
    <span class="org-keyword">with</span> <span class="org-builtin">open</span>(file_path, <span class="org-string">'w'</span>) <span class="org-keyword">as</span> f:
        f.write(content)
        f.close()


<span class="org-keyword">class</span> <span class="org-type">getSlsLogData</span>:
    <span class="org-variable-name">access_key_id</span> <span class="org-operator">=</span> <span class="org-string">"Lxx"</span>
    <span class="org-variable-name">access_key_secret</span> <span class="org-operator">=</span> <span class="org-string">"fxxx"</span>
    <span class="org-variable-name">undertow_project</span> <span class="org-operator">=</span> <span class="org-string">"singapore"</span>
    <span class="org-variable-name">undertow_logstore</span> <span class="org-operator">=</span> <span class="org-string">"undertow"</span>
    <span class="org-variable-name">logback_project</span> <span class="org-operator">=</span> <span class="org-string">"overseas-logback-server"</span>
    <span class="org-variable-name">logback_logstore</span> <span class="org-operator">=</span> <span class="org-string">"server-exception"</span>
    <span class="org-variable-name">sls_endpoint</span> <span class="org-operator">=</span> f<span class="org-string">'ap-southeast-1-intranet.log.aliyuncs.com'</span>
    <span class="org-variable-name">service_all</span> <span class="org-operator">=</span> [
        <span class="org-string">"attribute-server"</span>,
        <span class="org-string">"attribute-server-manager"</span>,
    ]
    <span class="org-variable-name">prefix_uris</span> <span class="org-operator">=</span> [
        <span class="org-string">"/episodic_drama"</span>,
        <span class="org-string">"/ads_unlock/episodic_drama"</span>,
    ]

    <span class="org-keyword">def</span> <span class="org-function-name">__init__</span>(<span class="org-keyword">self</span>):
        <span class="org-variable-name">config</span> <span class="org-operator">=</span> open_api_models.Config(
            access_key_id<span class="org-operator">=</span><span class="org-keyword">self</span>.access_key_id,
            access_key_secret<span class="org-operator">=</span><span class="org-keyword">self</span>.access_key_secret
        )
        config.<span class="org-variable-name">endpoint</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.sls_endpoint
        <span class="org-keyword">self</span>.<span class="org-variable-name">client</span> <span class="org-operator">=</span> Sls20201230Client(config)
        <span class="org-keyword">self</span>.<span class="org-variable-name">is_pre</span> <span class="org-operator">=</span> <span class="org-constant">False</span>

    <span class="org-keyword">def</span> <span class="org-function-name">get_sls_data</span>(<span class="org-keyword">self</span>, current<span class="org-operator">=</span>0, project<span class="org-operator">=</span><span class="org-string">""</span>, logstore<span class="org-operator">=</span><span class="org-string">""</span>, query<span class="org-operator">=</span><span class="org-string">""</span>):
        <span class="org-keyword">if</span> <span class="org-keyword">not</span> current:
            <span class="org-variable-name">current</span> <span class="org-operator">=</span> <span class="org-builtin">int</span>(time.time())
        <span class="org-keyword">if</span> <span class="org-keyword">not</span> project:
            <span class="org-variable-name">project</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.undertow_project
        <span class="org-keyword">if</span> <span class="org-keyword">not</span> logstore:
            <span class="org-variable-name">logstore</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.undertow_logstore
        <span class="org-variable-name">from_time</span> <span class="org-operator">=</span> current <span class="org-operator">-</span> 60
        <span class="org-variable-name">to_time</span> <span class="org-operator">=</span> current
        <span class="org-variable-name">headers</span> <span class="org-operator">=</span> {}
        <span class="org-variable-name">runtime</span> <span class="org-operator">=</span> util_models.RuntimeOptions()
        <span class="org-variable-name">get_logs_request</span> <span class="org-operator">=</span> sls_20201230_models.GetLogsRequest(from_<span class="org-operator">=</span>from_time, to<span class="org-operator">=</span>to_time, query<span class="org-operator">=</span>query)
        <span class="org-keyword">try</span>:
            <span class="org-variable-name">res</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.client.get_logs_with_options(project, logstore, get_logs_request, headers, runtime)
            <span class="org-keyword">return</span> res.body
        <span class="org-keyword">except</span> <span class="org-type">Exception</span> <span class="org-keyword">as</span> error:
            UtilClient.assert_as_string(error)
            <span class="org-keyword">return</span> []

    <span class="org-keyword">def</span> <span class="org-function-name">set_metric_service_qps</span>(<span class="org-keyword">self</span>):
        <span class="org-variable-name">query</span> <span class="org-operator">=</span> <span class="org-string">'*|select "__tag__:_container_name_" as service ,COUNT(*) as cnt group by service order by cnt desc '</span>
        <span class="org-variable-name">res_list</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.get_sls_data(query<span class="org-operator">=</span>query)
        <span class="org-keyword">for</span> data <span class="org-keyword">in</span> res_list:
            <span class="org-variable-name">service</span> <span class="org-operator">=</span> data[<span class="org-string">"service"</span>]
            <span class="org-variable-name">cnt</span> <span class="org-operator">=</span> <span class="org-builtin">float</span>(data[<span class="org-string">"cnt"</span>])
            g4_1.labels(service).<span class="org-builtin">set</span>(cnt)

    <span class="org-keyword">def</span> <span class="org-function-name">set_metric_service_avg_rt</span>(<span class="org-keyword">self</span>):
        <span class="org-variable-name">query</span> <span class="org-operator">=</span> <span class="org-string">'* |select "__tag__:_container_name_" as service , avg(timeUsed) as avg_time  group by service order by avg_time desc '</span>
        <span class="org-variable-name">res_list</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.get_sls_data(query<span class="org-operator">=</span>query)
        <span class="org-keyword">for</span> data <span class="org-keyword">in</span> res_list:
            <span class="org-variable-name">service</span> <span class="org-operator">=</span> data[<span class="org-string">"service"</span>]
            <span class="org-keyword">try</span>:
                <span class="org-variable-name">avg_time_ns</span> <span class="org-operator">=</span> <span class="org-builtin">float</span>(data[<span class="org-string">"avg_time"</span>])
            <span class="org-keyword">except</span>:
                <span class="org-keyword">continue</span>
            <span class="org-variable-name">avg_time_ms</span> <span class="org-operator">=</span> <span class="org-builtin">int</span>(avg_time_ns <span class="org-operator">/</span> 1000)
            g4_2.labels(service).<span class="org-builtin">set</span>(avg_time_ms)

    <span class="org-keyword">def</span> <span class="org-function-name">get_undertow_data_daily</span>(<span class="org-keyword">self</span>, query<span class="org-operator">=</span><span class="org-string">""</span>):
        <span class="org-variable-name">now</span> <span class="org-operator">=</span> datetime.datetime.now()
        <span class="org-variable-name">midnight</span> <span class="org-operator">=</span> now.replace(hour<span class="org-operator">=</span>0, minute<span class="org-operator">=</span>0, second<span class="org-operator">=</span>0, microsecond<span class="org-operator">=</span>0)
        <span class="org-variable-name">midnight_ts</span> <span class="org-operator">=</span> <span class="org-builtin">int</span>(midnight.timestamp())
        <span class="org-variable-name">from_time</span> <span class="org-operator">=</span> midnight_ts <span class="org-operator">-</span> 9000
        <span class="org-variable-name">to_time</span> <span class="org-operator">=</span> from_time <span class="org-operator">+</span> 1800
        <span class="org-variable-name">project</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.undertow_project
        <span class="org-variable-name">logstore</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.undertow_logstore
        <span class="org-variable-name">headers</span> <span class="org-operator">=</span> {}
        <span class="org-variable-name">runtime</span> <span class="org-operator">=</span> util_models.RuntimeOptions()
        <span class="org-variable-name">get_logs_request</span> <span class="org-operator">=</span> sls_20201230_models.GetLogsRequest(from_<span class="org-operator">=</span>from_time, to<span class="org-operator">=</span>to_time, query<span class="org-operator">=</span>query)
        <span class="org-keyword">try</span>:
            <span class="org-variable-name">res</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.client.get_logs_with_options(project, logstore, get_logs_request, headers, runtime)
            <span class="org-keyword">return</span> res.body
        <span class="org-keyword">except</span> <span class="org-type">Exception</span> <span class="org-keyword">as</span> error:
            UtilClient.assert_as_string(error)
            <span class="org-keyword">return</span> []

    <span class="org-keyword">def</span> <span class="org-function-name">set_metric_slow_detail</span>(<span class="org-keyword">self</span>):
        g4_3_4.clear()
        <span class="org-keyword">for</span> service <span class="org-keyword">in</span> <span class="org-keyword">self</span>.get_service_list():
            <span class="org-variable-name">query</span> <span class="org-operator">=</span> <span class="org-string">'* and __tag__:_container_name_: {} |select COUNT(*) as cnt, avg(timeUsed)/1000 as avg_timeused, min(timeUsed)/1000 as min_timeused, max(timeUsed)/1000 as max_timeused , sum(timeUsed)/1000 as sum_timeused, "__tag__:_container_name_" as service ,uri group by service,uri  HAVING  avg_timeused &gt;200 order by avg_timeused desc limit 100000'</span>.<span class="org-builtin">format</span>(
                service)
            <span class="org-variable-name">res_list</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.get_undertow_data_daily(query<span class="org-operator">=</span>query)
            <span class="org-variable-name">pre_map</span> <span class="org-operator">=</span> {}
            <span class="org-builtin">sum</span> <span class="org-operator">=</span> <span class="org-builtin">float</span>(0)
            <span class="org-keyword">for</span> data <span class="org-keyword">in</span> res_list:
                <span class="org-keyword">self</span>.<span class="org-variable-name">is_pre</span> <span class="org-operator">=</span> <span class="org-constant">False</span>
                <span class="org-variable-name">uri</span> <span class="org-operator">=</span> data[<span class="org-string">"uri"</span>]
                <span class="org-variable-name">cnt</span> <span class="org-operator">=</span> <span class="org-builtin">float</span>(data[<span class="org-string">"cnt"</span>])
                <span class="org-variable-name">min_timeused</span> <span class="org-operator">=</span> <span class="org-builtin">float</span>(data[<span class="org-string">"min_timeused"</span>])
                <span class="org-variable-name">max_timeused</span> <span class="org-operator">=</span> <span class="org-builtin">float</span>(data[<span class="org-string">"max_timeused"</span>])
                <span class="org-builtin">sum</span> <span class="org-operator">+=</span> cnt

                <span class="org-keyword">for</span> prefix_uri <span class="org-keyword">in</span> <span class="org-keyword">self</span>.prefix_uris:
                    <span class="org-keyword">if</span> <span class="org-keyword">not</span> uri.startswith(prefix_uri):
                        <span class="org-keyword">continue</span>
                    <span class="org-variable-name">uri_len</span> <span class="org-operator">=</span> <span class="org-builtin">len</span>(uri.split(<span class="org-string">"/"</span>))
                    <span class="org-variable-name">prefix_uri_len</span> <span class="org-operator">=</span> <span class="org-builtin">len</span>(prefix_uri.split(<span class="org-string">"/"</span>))
                    <span class="org-variable-name">param_str</span> <span class="org-operator">=</span> <span class="org-string">""</span>
                    <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(uri_len <span class="org-operator">-</span> prefix_uri_len):
                        <span class="org-variable-name">param_str</span> <span class="org-operator">=</span> param_str <span class="org-operator">+</span> <span class="org-string">"/{param}"</span>
                    <span class="org-variable-name">sum_timeused</span> <span class="org-operator">=</span> <span class="org-builtin">float</span>(data[<span class="org-string">"sum_timeused"</span>])
                    <span class="org-variable-name">key</span> <span class="org-operator">=</span> prefix_uri <span class="org-operator">+</span> param_str
                    <span class="org-variable-name">pre_uri_data</span> <span class="org-operator">=</span> pre_map.get(key, {})
                    <span class="org-variable-name">pre_uri_data</span>[<span class="org-string">"sum_timeused"</span>] <span class="org-operator">=</span> <span class="org-builtin">float</span>(pre_uri_data.get(<span class="org-string">"sum_timeused"</span>, 0)) <span class="org-operator">+</span> sum_timeused
                    <span class="org-variable-name">pre_uri_data</span>[<span class="org-string">"cnt"</span>] <span class="org-operator">=</span> <span class="org-builtin">float</span>(pre_uri_data.get(<span class="org-string">"cnt"</span>, 0)) <span class="org-operator">+</span> cnt
                    <span class="org-variable-name">pre_uri_data</span>[<span class="org-string">"min_timeused"</span>] <span class="org-operator">=</span> <span class="org-builtin">min</span>(<span class="org-builtin">float</span>(pre_uri_data.get(<span class="org-string">"min_timeused"</span>, min_timeused)),
                                                       min_timeused)
                    <span class="org-variable-name">pre_uri_data</span>[<span class="org-string">"max_timeused"</span>] <span class="org-operator">=</span> <span class="org-builtin">max</span>(<span class="org-builtin">float</span>(pre_uri_data.get(<span class="org-string">"max_timeused"</span>, max_timeused)),
                                                       max_timeused)
                    <span class="org-variable-name">pre_map</span>[key] <span class="org-operator">=</span> pre_uri_data
                    <span class="org-keyword">self</span>.<span class="org-variable-name">is_pre</span> <span class="org-operator">=</span> <span class="org-constant">True</span>
                    <span class="org-keyword">break</span>
                <span class="org-keyword">if</span> <span class="org-keyword">not</span> <span class="org-keyword">self</span>.is_pre:
                    <span class="org-variable-name">avg_timeused</span> <span class="org-operator">=</span> data[<span class="org-string">"avg_timeused"</span>]
                    <span class="org-variable-name">min_timeused</span> <span class="org-operator">=</span> <span class="org-builtin">str</span>(min_timeused)
                    <span class="org-variable-name">max_timeused</span> <span class="org-operator">=</span> <span class="org-builtin">str</span>(max_timeused)
                    g4_3_4.labels(service, uri, avg_timeused, min_timeused, max_timeused).<span class="org-builtin">set</span>(cnt)

            <span class="org-keyword">for</span> uri, pre_uri_data <span class="org-keyword">in</span> pre_map.items():
                <span class="org-variable-name">cnt</span> <span class="org-operator">=</span> pre_uri_data[<span class="org-string">"cnt"</span>]
                <span class="org-variable-name">sum_timeused</span> <span class="org-operator">=</span> pre_uri_data[<span class="org-string">"sum_timeused"</span>]
                <span class="org-variable-name">min_timeused</span> <span class="org-operator">=</span> <span class="org-builtin">str</span>(pre_uri_data[<span class="org-string">"min_timeused"</span>])
                <span class="org-variable-name">max_timeused</span> <span class="org-operator">=</span> <span class="org-builtin">str</span>(pre_uri_data[<span class="org-string">"max_timeused"</span>])
                <span class="org-variable-name">avg_timeused</span> <span class="org-operator">=</span> <span class="org-builtin">str</span>(<span class="org-builtin">round</span>(sum_timeused <span class="org-operator">/</span> cnt, 2))
                g4_3_4.labels(service, uri, avg_timeused, min_timeused, max_timeused).<span class="org-builtin">set</span>(cnt)

    <span class="org-keyword">def</span> <span class="org-function-name">get_service_list</span>(<span class="org-keyword">self</span>):
        <span class="org-variable-name">service_list</span> <span class="org-operator">=</span> []
        <span class="org-variable-name">query</span> <span class="org-operator">=</span> <span class="org-string">'*|select DISTINCT "__tag__:_container_name_" as service'</span>
        <span class="org-variable-name">res_list</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.get_undertow_data_daily(query<span class="org-operator">=</span>query)
        <span class="org-keyword">for</span> data <span class="org-keyword">in</span> res_list:
            <span class="org-variable-name">service</span> <span class="org-operator">=</span> data[<span class="org-string">"service"</span>]
            service_list.append(service)
        <span class="org-keyword">return</span> service_list

    <span class="org-keyword">def</span> <span class="org-function-name">set_metric_api_slow_level0</span>(<span class="org-keyword">self</span>):
        <span class="org-variable-name">query</span> <span class="org-operator">=</span> <span class="org-string">'* and timeUsed &gt;= 200000|select "__tag__:_container_name_" as service ,uri, COUNT(*) as cnt group by service,uri order by cnt desc '</span>
        <span class="org-variable-name">res_list</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.get_sls_data(query<span class="org-operator">=</span>query)
        g4_3_0.clear()
        <span class="org-keyword">for</span> data <span class="org-keyword">in</span> res_list:
            <span class="org-variable-name">service</span> <span class="org-operator">=</span> data[<span class="org-string">"service"</span>]
            <span class="org-variable-name">uri</span> <span class="org-operator">=</span> data[<span class="org-string">"uri"</span>]
            <span class="org-variable-name">cnt</span> <span class="org-operator">=</span> <span class="org-builtin">float</span>(data[<span class="org-string">"cnt"</span>])
            g4_3_0.labels(service, uri).<span class="org-builtin">set</span>(cnt)

    <span class="org-keyword">def</span> <span class="org-function-name">set_metric_logback_exception</span>(<span class="org-keyword">self</span>):
        <span class="org-variable-name">query</span> <span class="org-operator">=</span> <span class="org-string">"* | select __topic__ as service , COUNT(*) as cnt group by service"</span>
        <span class="org-variable-name">res_list</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.get_sls_data(project<span class="org-operator">=</span><span class="org-keyword">self</span>.logback_project, logstore<span class="org-operator">=</span><span class="org-keyword">self</span>.logback_logstore, query<span class="org-operator">=</span>query)
        g6.clear()
        g6.labels(<span class="org-string">"content-distribution-platform"</span>).<span class="org-builtin">set</span>(0)
        <span class="org-keyword">for</span> service <span class="org-keyword">in</span> <span class="org-keyword">self</span>.service_all:
            g6.labels(service).<span class="org-builtin">set</span>(0)
        <span class="org-keyword">for</span> data <span class="org-keyword">in</span> res_list:
            <span class="org-variable-name">service</span> <span class="org-operator">=</span> data[<span class="org-string">"service"</span>]
            <span class="org-variable-name">cnt</span> <span class="org-operator">=</span> data[<span class="org-string">"cnt"</span>]
            g6.labels(service).<span class="org-builtin">set</span>(cnt)


<span class="org-keyword">if</span> <span class="org-builtin">__name__</span> <span class="org-operator">==</span> <span class="org-string">'__main__'</span>:
    <span class="org-variable-name">already_file</span> <span class="org-operator">=</span> <span class="org-string">"/opt/ops/others/already_run"</span>
    start_http_server(9111)  <span class="org-comment-delimiter"># </span><span class="org-comment">8006&#31471;&#21475;&#21551;&#21160;
</span>    <span class="org-builtin">print</span>(<span class="org-string">"&#30417;&#25511;&#31243;&#24207;&#21551;&#21160;..."</span>)
    <span class="org-variable-name">data4</span> <span class="org-operator">=</span> getSlsLogData()
    <span class="org-keyword">while</span> <span class="org-constant">True</span>:
        <span class="org-keyword">try</span>:
            <span class="org-variable-name">current_day</span> <span class="org-operator">=</span> datetime.datetime.now().strftime(<span class="org-string">"%Y%m%d"</span>)
            <span class="org-variable-name">already_day</span> <span class="org-operator">=</span> get_content_from_file(already_file)
            <span class="org-keyword">if</span> current_day <span class="org-operator">!=</span> already_day:
                set_content_to_file(current_day, already_file)
                <span class="org-builtin">print</span>(<span class="org-string">"&#25191;&#34892;&#24930;&#25509;&#21475;&#32479;&#35745;&#20219;&#21153;"</span>)
                data4.set_metric_slow_detail()
                <span class="org-builtin">print</span>(<span class="org-string">"&#24930;&#25509;&#21475;&#32479;&#35745;&#20219;&#21153;&#25191;&#34892;&#23436;&#27605;"</span>)
            data4.set_metric_service_qps()
            data4.set_metric_service_avg_rt()
            data4.set_metric_api_slow_level0()
            data4.set_metric_logback_exception()
            <span class="org-variable-name">current_time</span> <span class="org-operator">=</span> datetime.datetime.now().strftime(<span class="org-string">"%Y-%m-%d %H:%M:%S"</span>)
            <span class="org-builtin">print</span>(<span class="org-string">"{} &#30417;&#25511;&#25968;&#25454;&#37319;&#38598;&#25104;&#21151;"</span>.<span class="org-builtin">format</span>(current_time))
            time.sleep(40)
        <span class="org-keyword">except</span> <span class="org-type">Exception</span> <span class="org-keyword">as</span> e:
            <span class="org-builtin">print</span>(e)
            time.sleep(40)
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:fb49990a-421f-4368-9a44-f96a808530db" class="outline-2">
<h2 id="h:fb49990a-421f-4368-9a44-f96a808530db"><a href="#h:fb49990a-421f-4368-9a44-f96a808530db">openflcon</a></h2>
<div class="outline-text-2" id="text-h:fb49990a-421f-4368-9a44-f96a808530db">
</div>
<div id="outline-container-h:18e1e22c-e42f-4020-a5ac-e5e5d59320c0" class="outline-3">
<h3 id="h:18e1e22c-e42f-4020-a5ac-e5e5d59320c0"><a href="#h:18e1e22c-e42f-4020-a5ac-e5e5d59320c0">网络质量监控脚本</a></h3>
<div class="outline-text-3" id="text-h:18e1e22c-e42f-4020-a5ac-e5e5d59320c0">
<p>
脚本逻辑：通过定量ping内网地址，将丢包的比例上报的open-falcon上，并在open-falcon中设定阈值；
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">sh</span><span class="org-comment">
</span><span class="org-comment-delimiter">#########################</span><span class="org-comment">
</span><span class="org-comment-delimiter">#</span><span class="org-comment">system variable
</span><span class="org-variable-name">timestamp</span>=<span class="org-sh-quoted-exec">`date +%s`</span>
<span class="org-variable-name">host_name</span>=<span class="org-sh-quoted-exec">`hostname`</span>
<span class="org-variable-name">tc_ping</span>=<span class="org-sh-quoted-exec">`ping -c 10 192.168.100.43 |grep "packet loss" |awk '{print $6}' |sed 's/%//g'`</span>
<span class="org-variable-name">sc_ping</span>=<span class="org-sh-quoted-exec">`ping -c 10 192.168.10.65 |grep "packet loss" |awk '{print $6}' |sed 's/%//g'`</span>

<span class="org-comment-delimiter">#########################</span><span class="org-comment">
</span><span class="org-function-name">main</span> () {
        curl -X POST -d <span class="org-string">'[{"metric": "tc high-speed channel", "endpoint": "'</span>$<span class="org-variable-name">host_name</span><span class="org-string">'", "timestamp": '</span>$<span class="org-variable-name">timestamp</span><span class="org-string">', "step": 60,"value": '</span>$<span class="org-variable-name">tc_ping</span><span class="org-string">',"counterType": "GAUGE","tags": ""}]'</span> http://127.0.0.1:1988/v1/push
        curl -X POST -d <span class="org-string">'[{"metric": "sc high-speed channel", "endpoint": "'</span>$<span class="org-variable-name">host_name</span><span class="org-string">'", "timestamp": '</span>$<span class="org-variable-name">timestamp</span><span class="org-string">', "step": 60,"value": '</span>$<span class="org-variable-name">sc_ping</span><span class="org-string">',"counterType": "GAUGE","tags": ""}]'</span> http://127.0.0.1:1988/v1/push
}

main
</pre>
</div>
</div>
</div>
<div id="outline-container-h:725329d7-d66d-4578-aeaf-c3cc41e813e9" class="outline-3">
<h3 id="h:725329d7-d66d-4578-aeaf-c3cc41e813e9"><a href="#h:725329d7-d66d-4578-aeaf-c3cc41e813e9">openflacon-zookeeeper</a></h3>
<div class="outline-text-3" id="text-h:725329d7-d66d-4578-aeaf-c3cc41e813e9">
<div class="org-src-container">
<pre class="src src-sh">[root@zk-1 ~]# crontab -l
<span class="org-comment-delimiter">################## </span><span class="org-comment">monitor falcon agent ######################
</span>*/1 * * * * /usr/bin/sh /data/work/open-falcon/script/report_agent.sh

[root@zk-1 ~]# cat /data/work/open-falcon/script/report_agent.sh
<span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/bash
</span><span class="org-variable-name">timestamp</span>=<span class="org-sh-quoted-exec">`date +%s`</span>
<span class="org-variable-name">host_name</span>=<span class="org-sh-quoted-exec">`hostname`</span>
<span class="org-comment-delimiter">### </span><span class="org-comment">check zk ###&#26032;###
</span><span class="org-variable-name">zk_pid</span>=<span class="org-sh-quoted-exec">`ps -ef|grep 'zookeeper'|grep -v 'grep'|awk '{print $2}'`</span>
<span class="org-variable-name">zk_port_2181</span>=<span class="org-sh-quoted-exec">`netstat -antlp|grep $zk_pid|grep 2181|wc -l`</span>
<span class="org-variable-name">zk_num</span>=<span class="org-sh-quoted-exec">`ps -ef|grep 'zookeeper'|grep -v grep | wc -l`</span>
curl -X POST -d <span class="org-string">'[{"metric": "zookeeper.status", "endpoint": "'</span>$<span class="org-variable-name">host_name</span><span class="org-string">'", "timestamp": '</span>$<span class="org-variable-name">timestamp</span><span class="org-string">', "step": 60,"value": '</span>$<span class="org-variable-name">zk_num</span><span class="org-string">',"counterType": "GAUGE","tags": ""}]'</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">'[{"metric": "zookeeper.connect_port_2181", "endpoint": "'</span>$<span class="org-variable-name">host_name</span><span class="org-string">'", "timestamp": '</span>$<span class="org-variable-name">timestamp</span><span class="org-string">', "step": 60,"value": '</span>$<span class="org-variable-name">zk_port_2181</span><span class="org-string">',"counterType": "GAUGE","tags": ""}]'</span> http://127.0.0.1:1988/v1/push

<span class="org-variable-name">role</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_server_state|awk '{print $2}'`</span>
<span class="org-keyword">if</span> [ $<span class="org-variable-name">role</span> = <span class="org-string">"leader"</span> ];<span class="org-keyword">then</span>
<span class="org-variable-name">zk_avg_latency</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_avg_latency|awk '{print $2}'`</span>
<span class="org-variable-name">zk_max_latency</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_max_latency |awk '{print $2}'`</span>
<span class="org-variable-name">zk_min_latency</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_min_latency|awk '{print $2}'`</span>
<span class="org-variable-name">zk_packets_received</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_packets_received|awk '{print $2}'`</span>
<span class="org-variable-name">zk_packets_sent</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_packets_sent|awk '{print $2}'`</span>
<span class="org-variable-name">zk_num_alive_connections</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_num_alive_connections|awk '{print $2}'`</span>
<span class="org-variable-name">zk_outstanding_requests</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_outstanding_requests|awk '{print $2}'`</span>
<span class="org-variable-name">zk_znode_count</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_znode_count|awk '{print $2}'`</span>
<span class="org-variable-name">zk_watch_count</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_watch_count|awk '{print $2}'`</span>
<span class="org-variable-name">zk_ephemerals_count</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_ephemerals_count|awk '{print $2}'`</span>
<span class="org-variable-name">zk_approximate_data_size</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_approximate_data_size|awk '{print $2}'`</span>
<span class="org-variable-name">zk_open_file_descriptor_count</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_open_file_descriptor_count|awk '{print $2}'`</span>
<span class="org-variable-name">zk_max_file_descriptor_count</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_max_file_descriptor_count|awk '{print $2}'`</span>
<span class="org-variable-name">zk_followers</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_followers|awk '{print $2}'`</span>
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_avg_latency\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_avg_latency,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_max_latency\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_max_latency,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_min_latency\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_min_latency,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_packets_received\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_packets_received,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_packets_sent\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_packets_sent,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_num_alive_connections\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_num_alive_connections,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_outstanding_requests\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_outstanding_requests,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_znode_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_znode_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_watch_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_watch_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_ephemerals_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_ephemerals_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_approximate_data_size\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_approximate_data_size,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_open_file_descriptor_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_open_file_descriptor_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_max_file_descriptor_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_max_file_descriptor_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_followers\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_followers,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push

<span class="org-keyword">else</span>
<span class="org-variable-name">zk_avg_latency</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_avg_latency|awk '{print $2}'`</span>
<span class="org-variable-name">zk_max_latency</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_max_latency |awk '{print $2}'`</span>
<span class="org-variable-name">zk_min_latency</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_min_latency|awk '{print $2}'`</span>
<span class="org-variable-name">zk_packets_received</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_packets_received|awk '{print $2}'`</span>
<span class="org-variable-name">zk_packets_sent</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_packets_sent|awk '{print $2}'`</span>
<span class="org-variable-name">zk_num_alive_connections</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_num_alive_connections|awk '{print $2}'`</span>
<span class="org-variable-name">zk_outstanding_requests</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_outstanding_requests|awk '{print $2}'`</span>
<span class="org-variable-name">zk_znode_count</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_znode_count|awk '{print $2}'`</span>
<span class="org-variable-name">zk_watch_count</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_watch_count|awk '{print $2}'`</span>
<span class="org-variable-name">zk_ephemerals_count</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_ephemerals_count|awk '{print $2}'`</span>
<span class="org-variable-name">zk_approximate_data_size</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_approximate_data_size|awk '{print $2}'`</span>
<span class="org-variable-name">zk_open_file_descriptor_count</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_open_file_descriptor_count|awk '{print $2}'`</span>
<span class="org-variable-name">zk_max_file_descriptor_count</span>=<span class="org-sh-quoted-exec">`echo mntr|nc 127.0.0.1 2181 |grep zk_max_file_descriptor_count|awk '{print $2}'`</span>
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_avg_latency\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_avg_latency,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_max_latency\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_max_latency,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_min_latency\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_min_latency,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_packets_received\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_packets_received,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_packets_sent\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_packets_sent,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_num_alive_connections\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_num_alive_connections,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_outstanding_requests\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_outstanding_requests,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_znode_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_znode_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_watch_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_watch_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_ephemerals_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_ephemerals_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_approximate_data_size\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_approximate_data_size,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_open_file_descriptor_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_open_file_descriptor_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
curl -X POST -d <span class="org-string">"[{\"metric\": \"ZK.zk_max_file_descriptor_count\", \"endpoint\": \"$host_name\", \"timestamp\": $timestamp, \"step\": 60,\"value\": $zk_max_file_descriptor_count,\"counterType\": \"GAUGE\",\"tags\": \"\"}]"</span> http://127.0.0.1:1988/v1/push
<span class="org-keyword">fi</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:294b25b4-1d3a-4777-b478-51dc1a70deed" class="outline-3">
<h3 id="h:294b25b4-1d3a-4777-b478-51dc1a70deed"><a href="#h:294b25b4-1d3a-4777-b478-51dc1a70deed">服务监控治理</a></h3>
<div class="outline-text-3" id="text-h:294b25b4-1d3a-4777-b478-51dc1a70deed">
<p>
监控脚本说明
</p>
<div class="org-src-container">
<pre class="src src-sh">&#21442;&#25968;&#35828;&#26126;&#65306;
--service&#65306;&#26381;&#21153;&#31867;&#22411;
--ports&#65306;&#26381;&#21153;&#31471;&#21475;&#65292;&#22810;&#31471;&#21475;&#38388;,&#36887;&#21495;&#20998;&#38548;&#12290;&#27809;&#26377;&#31471;&#21475;&#21017;&#22635;0&#12290;
--names: &#30417;&#25511;&#25351;&#26631;&#12290;&#22810;&#20010;&#25351;&#26631;&#20197;,&#36887;&#21495;&#20998;&#38548;&#12290;
</pre>
</div>

<p>
bash脚本模板
</p>

<div class="org-src-container">
<pre class="src src-sh">monitor[root@nginx001 vhosts]# crontab -l
<span class="org-comment-delimiter">#</span><span class="org-comment">Ansible: zookeeper.connect_port
</span>*/1 * * * * /home/scripts/zookeeper/zookeeper.connect_port.sh  --service zk  --ports 2181,3888  --names  zk.connect_port
<span class="org-comment-delimiter">#</span><span class="org-comment">Ansible: zookeeper.daemon_status
</span>*/1 * * * * /home/scripts/zookeeper/zookeeper.daemon_status.sh  --service zk  --ports 0  --names  zk.daemon_status
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/</span><span class="org-keyword">env</span><span class="org-comment"> bash
</span><span class="org-comment-delimiter">#</span><span class="org-comment">
</span><span class="org-builtin">source</span> /etc/profile
<span class="org-variable-name">timestamp</span>=<span class="org-sh-quoted-exec">`date +%s`</span>
<span class="org-variable-name">host_name</span>=<span class="org-sh-quoted-exec">`hostname`</span>
<span class="org-variable-name">exit_status</span>=0

<span class="org-keyword">function</span> <span class="org-function-name">usage</span>(){
cat &lt;&lt;EOF<span class="org-sh-heredoc">
Usage: $0 [MODE] [OPTION]

OPTION:
  -s, --service &lt;server_name&gt;     &#25351;&#23450;&#26381;&#21153;
  -p, --ports &lt;port1,port2...&gt;    &#25351;&#23450;&#31471;&#21475;&#21495;
  -n, --names &lt;tag_name&gt;          &#25351;&#23450;&#30417;&#25511;&#25351;&#26631;
  --help                   show help
EOF
</span>}

<span class="org-variable-name">parameters</span>=$(getopt -o s:p:n: --long service:,ports:,names:,help -n <span class="org-string">"$0"</span> -- <span class="org-string">"$@"</span>)
[ $<span class="org-variable-name">?</span> -ne 0 ] &amp;&amp; { <span class="org-builtin">echo</span> <span class="org-string">"Try '$0 --help' for more information."</span>; <span class="org-keyword">exit</span> 1; }

<span class="org-builtin">eval</span> set -- <span class="org-string">"$parameters"</span>

<span class="org-keyword">while </span><span class="org-builtin">true</span>; <span class="org-keyword">do</span>
    <span class="org-keyword">case</span> <span class="org-string">"$1"</span><span class="org-keyword"> in</span>
    -s|--service) <span class="org-variable-name">service</span>=$<span class="org-variable-name">2</span>; <span class="org-builtin">shift</span> 2;;
    -p|--ports) <span class="org-variable-name">ports</span>=$<span class="org-variable-name">2</span> ; <span class="org-builtin">shift</span> 2 ;;
    -n|--names) <span class="org-variable-name">names</span>=$<span class="org-variable-name">2</span> ; <span class="org-builtin">shift</span> 2 ;;
    --help) usage;<span class="org-keyword">exit</span> ;;
    --)
        <span class="org-builtin">shift</span>
        <span class="org-variable-name">FIRST</span>=$<span class="org-variable-name">1</span>
        <span class="org-variable-name">SECOND</span>=$<span class="org-variable-name">2</span>
        <span class="org-variable-name">LAST</span>=$<span class="org-variable-name">3</span>
        <span class="org-keyword">break</span> ;;
    *) usage;<span class="org-keyword">exit</span> 1 ;;
    <span class="org-keyword">esac</span>
<span class="org-keyword">done</span>

<span class="org-keyword">function</span> <span class="org-function-name">open_falcon_push</span>() {
    <span class="org-builtin">local</span> <span class="org-variable-name">metric</span>=$<span class="org-variable-name">1</span>
    <span class="org-builtin">local</span> <span class="org-variable-name">tag</span>=$<span class="org-variable-name">2</span>
    <span class="org-builtin">local</span> <span class="org-variable-name">value</span>=$<span class="org-variable-name">3</span>
    curl --connect-timeout 5 -X POST -d <span class="org-string">'[{"'</span>metric<span class="org-string">'": "'</span>$<span class="org-variable-name">metric</span><span class="org-string">'", "endpoint": "'</span>$<span class="org-variable-name">host_name</span><span class="org-string">'", "timestamp": '</span>$<span class="org-variable-name">timestamp</span><span class="org-string">', "step": 60,"value": '</span>$<span class="org-variable-name">value</span><span class="org-string">',"counterType": "GAUGE","tags": "'</span>$<span class="org-variable-name">tag</span><span class="org-string">'"}]'</span> http://127.0.0.1:1988/v1/push
    <span class="org-comment-delimiter">#</span><span class="org-comment">echo  '[{"metric": "'$metric'", "endpoint": "'$host_name'", "timestamp": '$timestamp', "step": 60,"value": '$value',"counterType": "GAUGE","tags": "'$tag'"}]' http://127.0.0.1:1988/v1/push
</span>}

[ -z <span class="org-string">"$service"</span> ] &amp;&amp; { <span class="org-builtin">echo</span> -e <span class="org-string">"\033[31;1;4mERR\033[0m: the service is not found, please --help"</span> &amp;&amp; <span class="org-variable-name">exit_status</span>=1; }
[ -z <span class="org-string">"$ports"</span> ] &amp;&amp; { <span class="org-builtin">echo</span> -e <span class="org-string">"\033[31;1;4mERR\033[0m: the ports are not found, please --help"</span> &amp;&amp; <span class="org-variable-name">exit_status</span>=1; }
[ -z <span class="org-string">"$names"</span> ] &amp;&amp; { <span class="org-builtin">echo</span> -e <span class="org-string">"\033[31;1;4mERR\033[0m: the names are not found, please --help"</span> &amp;&amp; <span class="org-variable-name">exit_status</span>=1; }
[  $<span class="org-variable-name">exit_status</span> == 1 ]&amp;&amp; <span class="org-keyword">exit</span> 1


<span class="org-comment-delimiter">#</span><span class="org-comment">----------------------------------change
</span>[ -z <span class="org-string">"$(which nc)"</span> ] &amp;&amp; yum install -y nc
<span class="org-variable-name">daemon_status</span>=<span class="org-sh-quoted-exec">`echo ruok | nc 127.0.0.1 2181|grep imok|wc -l`</span>

<span class="org-variable-name">zk_pid</span>=<span class="org-sh-quoted-exec">`jps |grep QuorumPeerMain| grep -v 'grep'|awk '{print $1}'`</span>

<span class="org-keyword">function</span> <span class="org-function-name">noport_check</span>() {
    <span class="org-keyword">for</span> port<span class="org-keyword"> in</span> $(<span class="org-builtin">echo</span> ${<span class="org-variable-name">ports</span>//,/ }); <span class="org-keyword">do</span>
        <span class="org-keyword">if</span> [ <span class="org-string">"$port"</span> -ge 0 ] 2&gt;/dev/null ; <span class="org-keyword">then</span> :;<span class="org-keyword">else </span><span class="org-builtin">echo</span> -e <span class="org-string">"\033[31;1;4mERR\033[0m: port $port is not number"</span> &amp;&amp; <span class="org-keyword">exit</span> 1; <span class="org-keyword">fi</span>
        <span class="org-keyword">for</span> name<span class="org-keyword"> in</span> $(<span class="org-builtin">echo</span> ${<span class="org-variable-name">names</span>//,/ }); <span class="org-keyword">do</span>
            open_falcon_push   <span class="org-string">"$name"</span> <span class="org-string">"name=$name,port=0,service=$service"</span> <span class="org-string">"$daemon_status"</span>
        <span class="org-keyword">done</span>
    <span class="org-keyword">done</span>
}

<span class="org-keyword">function</span> <span class="org-function-name">ports_check</span>() {
    <span class="org-keyword">for</span> port<span class="org-keyword"> in</span> $(<span class="org-builtin">echo</span> ${<span class="org-variable-name">ports</span>//,/ }); <span class="org-keyword">do</span>
        <span class="org-keyword">if</span> [ <span class="org-string">"$port"</span> -ge 0 ] 2&gt;/dev/null ; <span class="org-keyword">then</span> :;<span class="org-keyword">else </span><span class="org-builtin">echo</span> -e <span class="org-string">"\033[31;1;4mERR\033[0m: port $port is not number"</span> &amp;&amp; <span class="org-keyword">exit</span> 1; <span class="org-keyword">fi</span>
        <span class="org-keyword">for</span> name<span class="org-keyword"> in</span> $(<span class="org-builtin">echo</span> ${<span class="org-variable-name">names</span>//,/ }); <span class="org-keyword">do</span>
            <span class="org-variable-name">zk_port</span>=<span class="org-sh-quoted-exec">`netstat -antlp|grep $zk_pid|grep $port|wc -l`</span>
            open_falcon_push   <span class="org-string">"$name"</span> <span class="org-string">"name=$name,port=$port,service=$service"</span> <span class="org-string">"$zk_port"</span>
        <span class="org-keyword">done</span>
    <span class="org-keyword">done</span>
}

<span class="org-comment-delimiter">#</span><span class="org-comment">----------------------------------end
</span><span class="org-keyword">function</span> <span class="org-function-name">monitor</span>() {
   noport_check
   <span class="org-comment-delimiter">#</span><span class="org-comment">ports_check
</span>}
</pre>
</div>



<p>
python脚本模板
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@nginx001 vhosts]# /home/scripts/nginx/nginx.openfiles_check.py  --service nginx  --ports 0  --names  nginx.openfiles_check
success
[{<span class="org-string">'metric'</span>: <span class="org-string">'nginx.openfiles_check'</span>, <span class="org-string">'endpoint'</span>: <span class="org-string">'nginx001'</span>, <span class="org-string">'timestamp'</span>: 1575447496, <span class="org-string">'step'</span>: 120, <span class="org-string">'value'</span>: 1, <span class="org-string">'counterType'</span>: <span class="org-string">'GAUGE'</span>, <span class="org-string">'tags'</span>: <span class="org-string">'name=nginx.openfiles_check,port=0,service=nginx'</span>}]
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/env python3
</span><span class="org-comment-delimiter"># </span><span class="org-comment">-*- coding:utf-8 -*-
</span><span class="org-keyword">import</span> time,datetime
<span class="org-keyword">import</span> json
<span class="org-keyword">import</span> socket
<span class="org-keyword">import</span> requests
<span class="org-keyword">import</span> os

<span class="org-keyword">import</span> argparse
<span class="org-variable-name">parser</span> <span class="org-operator">=</span> argparse.ArgumentParser(description<span class="org-operator">=</span><span class="org-string">'monitor script'</span>)
parser.add_argument(<span class="org-string">"-s"</span>,<span class="org-string">"--service"</span>, <span class="org-builtin">help</span><span class="org-operator">=</span><span class="org-string">"&#25351;&#23450;&#26381;&#21153;"</span>, <span class="org-builtin">type</span><span class="org-operator">=</span><span class="org-builtin">str</span>, required<span class="org-operator">=</span><span class="org-constant">True</span>)
parser.add_argument(<span class="org-string">"-p"</span>,<span class="org-string">"--ports"</span>, <span class="org-builtin">help</span><span class="org-operator">=</span><span class="org-string">"&#25351;&#23450;&#31471;&#21475;&#21495;"</span>, <span class="org-builtin">type</span><span class="org-operator">=</span><span class="org-builtin">str</span>, required<span class="org-operator">=</span><span class="org-constant">True</span>)
parser.add_argument(<span class="org-string">"-n"</span>,<span class="org-string">"--names"</span>, <span class="org-builtin">help</span><span class="org-operator">=</span><span class="org-string">"&#25351;&#23450;&#30417;&#25511;&#25351;&#26631;"</span>, <span class="org-builtin">type</span><span class="org-operator">=</span><span class="org-builtin">str</span>, required<span class="org-operator">=</span><span class="org-constant">True</span>)
<span class="org-variable-name">args</span> <span class="org-operator">=</span> parser.parse_args()

<span class="org-keyword">def</span> <span class="org-function-name">open_falcon_push</span>(payload):
    <span class="org-variable-name">url</span> <span class="org-operator">=</span> <span class="org-string">'http://127.0.0.1:1988/v1/push'</span>
    <span class="org-variable-name">headers</span> <span class="org-operator">=</span> {<span class="org-string">"Content-Type"</span>: <span class="org-string">"application/json"</span>}
    <span class="org-keyword">try</span>:
        <span class="org-variable-name">r</span> <span class="org-operator">=</span> requests.post(url, data<span class="org-operator">=</span>json.dumps(payload), headers<span class="org-operator">=</span>headers, timeout<span class="org-operator">=</span>3)
        <span class="org-keyword">if</span> r.status_code <span class="org-operator">==</span> 200:
            <span class="org-builtin">print</span>(r.text)
        <span class="org-keyword">else</span>:
            <span class="org-builtin">print</span>(<span class="org-string">'{"err":1,"msg":"%s"}'</span> <span class="org-operator">%</span> r.text)
    <span class="org-keyword">except</span> <span class="org-type">Exception</span> <span class="org-keyword">as</span> e:
        <span class="org-builtin">print</span>(<span class="org-string">"Exception: {traceback.format_exc(chain=False)}"</span>)

<span class="org-comment-delimiter">#</span><span class="org-comment">---------------------------------------------change
</span><span class="org-keyword">def</span> <span class="org-function-name">main</span>():
    <span class="org-variable-name">service</span> <span class="org-operator">=</span> args.service
    <span class="org-variable-name">ports</span> <span class="org-operator">=</span> args.ports
    <span class="org-variable-name">names</span> <span class="org-operator">=</span> args.names
    <span class="org-variable-name">hostname</span> <span class="org-operator">=</span> socket.gethostname()
    <span class="org-variable-name">timestamp</span> <span class="org-operator">=</span> <span class="org-builtin">int</span>(time.time())
    <span class="org-variable-name">step</span> <span class="org-operator">=</span> 120
    <span class="org-variable-name">payload</span> <span class="org-operator">=</span> []

    <span class="org-keyword">try</span>:
        <span class="org-variable-name">ports</span> <span class="org-operator">=</span> ports.split(<span class="org-string">','</span>)
        <span class="org-variable-name">names</span> <span class="org-operator">=</span> names.split(<span class="org-string">','</span>)

        <span class="org-keyword">for</span> port <span class="org-keyword">in</span> ports:
            <span class="org-variable-name">tags</span> <span class="org-operator">=</span> <span class="org-string">'port=%s'</span> <span class="org-operator">%</span> port
            <span class="org-keyword">for</span> name <span class="org-keyword">in</span> names:
                <span class="org-variable-name">tag</span> <span class="org-operator">=</span><span class="org-string">"name={},port={},service={}"</span>.<span class="org-builtin">format</span>(name,port,service)
                <span class="org-keyword">if</span> <span class="org-string">"openfiles_check"</span> <span class="org-keyword">in</span> name: 
                    <span class="org-variable-name">value</span> <span class="org-operator">=</span> openfiles()
                    <span class="org-variable-name">i</span> <span class="org-operator">=</span> {
                        <span class="org-string">'metric'</span>: name,
                        <span class="org-string">'endpoint'</span>: hostname,
                        <span class="org-string">'timestamp'</span>: timestamp,
                        <span class="org-string">'step'</span>: step,
                        <span class="org-string">'value'</span>: value,
                        <span class="org-string">'counterType'</span>: <span class="org-string">"GAUGE"</span>,
                        <span class="org-string">'tages'</span>: tag
                    }
                    payload.append(i)
        open_falcon_push(payload)
    <span class="org-keyword">except</span> <span class="org-type">Exception</span> <span class="org-keyword">as</span> e:
        <span class="org-variable-name">msg</span> <span class="org-operator">=</span> traceback.format_exc(chain<span class="org-operator">=</span><span class="org-constant">False</span>)
        <span class="org-builtin">print</span>(<span class="org-string">"Exception: {msg}"</span>)
    <span class="org-keyword">finally</span>:
        <span class="org-builtin">print</span>(payload)

<span class="org-keyword">def</span> <span class="org-function-name">openfiles</span>():
    <span class="org-variable-name">nginx_conf</span> <span class="org-operator">=</span> []
    <span class="org-variable-name">nginx_path</span> <span class="org-operator">=</span> <span class="org-string">"/data/logs/"</span>
    <span class="org-variable-name">value</span><span class="org-operator">=</span>1
    
    <span class="org-variable-name">g</span> <span class="org-operator">=</span> os.walk(nginx_path)
    <span class="org-keyword">for</span> path, dir_list, file_list <span class="org-keyword">in</span> g:
        <span class="org-keyword">for</span> <span class="org-builtin">file</span> <span class="org-keyword">in</span> file_list:
            <span class="org-keyword">if</span> <span class="org-string">'error.log'</span> <span class="org-keyword">in</span> <span class="org-builtin">file</span> <span class="org-keyword">and</span> <span class="org-string">'2019'</span> <span class="org-keyword">not</span> <span class="org-keyword">in</span> <span class="org-builtin">file</span>:
                nginx_conf.append(<span class="org-builtin">file</span>)
    
    <span class="org-keyword">for</span> conf_name <span class="org-keyword">in</span> nginx_conf:
        <span class="org-variable-name">nginxpath</span> <span class="org-operator">=</span> <span class="org-string">''</span>
        <span class="org-variable-name">nginxpath</span> <span class="org-operator">=</span> nginx_path <span class="org-operator">+</span> conf_name
        <span class="org-variable-name">f</span> <span class="org-operator">=</span> <span class="org-builtin">open</span>(nginxpath,<span class="org-string">"r"</span>,encoding<span class="org-operator">=</span><span class="org-string">'utf-8'</span>, errors<span class="org-operator">=</span><span class="org-string">'replace'</span>)
        <span class="org-keyword">for</span> i <span class="org-keyword">in</span> f.readlines():
            <span class="org-variable-name">i</span> <span class="org-operator">=</span> i.strip(<span class="org-string">"</span><span class="org-constant">\n</span><span class="org-string">"</span>)
            <span class="org-variable-name">time_date</span> <span class="org-operator">=</span> i.split(<span class="org-string">" "</span>)
            <span class="org-variable-name">fiveminago</span> <span class="org-operator">=</span>  (datetime.datetime.now()<span class="org-operator">-</span>datetime.timedelta(minutes<span class="org-operator">=</span>5)).strftime(<span class="org-string">"%H:%M:%S"</span>)
            <span class="org-keyword">if</span> time_date[1] <span class="org-operator">&lt;</span> fiveminago:
                <span class="org-keyword">pass</span>
            <span class="org-keyword">else</span>:
                <span class="org-keyword">if</span> <span class="org-string">"Too many open files"</span> <span class="org-keyword">in</span> i :
                    <span class="org-variable-name">value</span><span class="org-operator">=</span>0
        f.close()
    <span class="org-keyword">return</span> value
<span class="org-comment-delimiter">#</span><span class="org-comment">--------------------------------------end
</span>
<span class="org-keyword">if</span> <span class="org-builtin">__name__</span> <span class="org-operator">==</span> <span class="org-string">'__main__'</span>:
    <span class="org-comment-delimiter"># </span><span class="org-comment">print(sys.argv)
</span>    main()
</pre>
</div>

<p>
go脚本模板
</p>
<div class="org-src-container">
<pre class="src src-sh">
</pre>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
