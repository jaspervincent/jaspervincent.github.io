<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>scripts-ssl证书</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/distro-htmlize.css">
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">scripts-ssl证书</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:69c91061-2259-4549-9e4f-cbcef1e9e05f">Let's Encrypt  免费证书</a>
<ul>
<li><a href="#h:0f307b33-08df-485e-990b-072354d159c2">certbot</a>
<ul>
<li><a href="#h:7bba60d4-4f5d-4f94-b68a-4fec2be3af94">安装</a></li>
<li><a href="#h:8a1e7632-021d-4f91-b709-0f7c7b524f70">申请证书</a></li>
<li><a href="#h:99f4c06a-31b3-4ced-9959-2c0afd01a643">自动续订</a></li>
<li><a href="#h:3ee7dffd-d555-4ef6-8965-b76a2d70c62d">配置 nginx</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:26a29de8-63c5-4a18-9d1a-fca2df75a40e">证书脚本</a>
<ul>
<li><a href="#h:68155449-dd9d-4de0-878c-976a7a6816f7">00-安装配置管理</a></li>
<li><a href="#h:eafcb5a8-c119-4d53-b6d9-c9b0eb17e311">01-申请过程</a></li>
<li><a href="#h:250af8f5-2cf7-4c8b-a720-6028c6db0871">02-自动申请续期</a></li>
<li><a href="#h:620e3ad4-c053-4c5d-8a32-99917782282a">03-nginx证书过期同步</a>
<ul>
<li><a href="#h:1d2b637b-f6fd-4d8f-a1bd-df2f9586a9b6">免交互式</a></li>
<li><a href="#h:8e24ecf5-ad06-4cd1-96a4-e5ebec7babf8">定时任务</a></li>
<li><a href="#h:ce14dcaf-6b5f-4c33-b425-10b105d0a292">nginx服务器更新证书脚本</a></li>
</ul>
</li>
<li><a href="#h:e008414f-3b5b-4edc-9c0e-c620fc0b9862">04-使用Python检查域名证书剩余时间</a></li>
<li><a href="#h:9f941296-afee-4127-aa9a-39d9137bd8ff">05-自动扫描自动监控</a></li>
<li><a href="#h:afaeb348-a3db-49f3-835d-1ca1fb74d4b0">06-云厂商产品证书自动更新</a></li>
<li><a href="#h:144c1f4d-b0d5-4543-a875-9fce4ee32c42">07-检查-nginx有哪些443域名</a></li>
<li><a href="#h:aec1e819-9ae6-40b5-a517-843c2f1af3af">08-ansible批量修改</a></li>
<li><a href="#h:0b78299d-8821-41c4-a602-e2f6f9f6fc79">09-客户私有化部署</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="./../../index.html">Script</a></li>
</ul>
<section id="outline-container-h:69c91061-2259-4549-9e4f-cbcef1e9e05f" class="outline-2">
<h2 id="h:69c91061-2259-4549-9e4f-cbcef1e9e05f"><a href="#h:69c91061-2259-4549-9e4f-cbcef1e9e05f">Let's Encrypt  免费证书</a></h2>
<div class="outline-text-2" id="text-h:69c91061-2259-4549-9e4f-cbcef1e9e05f">
<p>
<a href="https://letsencrypt.org/">https://letsencrypt.org/</a>
</p>

<p>
有效期 3 个月
支持不用的客户端命令申请证书，官方推荐使用 <a href="https://certbot.eff.org/">Certbot</a>
</p>
</div>
<div id="outline-container-h:0f307b33-08df-485e-990b-072354d159c2" class="outline-3">
<h3 id="h:0f307b33-08df-485e-990b-072354d159c2"><a href="#h:0f307b33-08df-485e-990b-072354d159c2">certbot</a></h3>
<div class="outline-text-3" id="text-h:0f307b33-08df-485e-990b-072354d159c2">
<p>
<a href="https://www.wangan.com/docs/1245">certbot 中文文档</a>
</p>
</div>
<div id="outline-container-h:7bba60d4-4f5d-4f94-b68a-4fec2be3af94" class="outline-4">
<h4 id="h:7bba60d4-4f5d-4f94-b68a-4fec2be3af94"><a href="#h:7bba60d4-4f5d-4f94-b68a-4fec2be3af94">安装</a></h4>
<div class="outline-text-4" id="text-h:7bba60d4-4f5d-4f94-b68a-4fec2be3af94">
<p>
<b>MacOS</b>
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">Install Certbot
</span>brew install certbot

certbot --version <span class="org-comment-delimiter"># </span><span class="org-comment">&#26597;&#30475;&#29256;&#26412;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8a1e7632-021d-4f91-b709-0f7c7b524f70" class="outline-4">
<h4 id="h:8a1e7632-021d-4f91-b709-0f7c7b524f70"><a href="#h:8a1e7632-021d-4f91-b709-0f7c7b524f70">申请证书</a></h4>
<div class="outline-text-4" id="text-h:8a1e7632-021d-4f91-b709-0f7c7b524f70">
<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">&#20351;&#29992;DNS&#35748;&#35777;&#30340;&#26041;&#24335;&#26469;&#33719;&#21462;&#35777;&#20070;
</span>sudo certbot certonly  -d <span class="org-string">"*.aiull.com"</span> --manual --preferred-challenges dns
</pre>
</div>

<p>
参数说明
</p>
<div class="org-src-container">
<pre class="src src-shell">certonly &#23433;&#35013;&#27169;&#24335;
-d &#30003;&#35831;&#35777;&#20070;&#30340;&#22495;&#21517;&#65292;&#22914;&#26524;&#26159;&#36890;&#37197;&#31526;&#22495;&#21517;&#36755;&#20837; *.example.com
&#8211;manual &#25163;&#21160;&#23433;&#35013;&#25554;&#20214;
&#8211;preferred-challenges dns &#20351;&#29992; DNS &#26041;&#24335;&#26657;&#39564;&#22495;&#21517;&#25152;&#26377;&#26435;&#12290;certbot &#23558;&#35201;&#27714;&#24744;&#23558;&#21253;&#21547;&#29305;&#23450;&#20869;&#23481;&#30340; TXT DNS &#35760;&#24405;&#25918;&#32622;&#22312;&#22495;&#21517;&#19979;&#65292;&#35813;&#22495;&#21517;&#30001;&#35201;&#20026;&#20854;&#39041;&#21457;&#35777;&#20070;&#30340;&#20027;&#26426;&#21517;&#32452;&#25104;&#65292;&#21069;&#32512;&#20026;_acme-challenge
&#8211;server&#65292;Let&#8217;s Encrypt ACME v2 &#29256;&#26412;&#65292;&#40664;&#35748;&#20026; https://acme-staging-v02.api.letsencrypt.org/directory

<span class="org-comment-delimiter"># </span><span class="org-comment">&#21629;&#20196;&#34892;&#36873;&#39033;
</span>certbot --help all

&#25163;&#21160;&#23433;&#35013;&#25554;&#20214;
--manual-auth-hook &#21644; --manual-cleanup-hook &#26631;&#24535;&#25351;&#23450;&#33050;&#26412;&#26469;&#20934;&#22791;&#36827;&#34892;&#39564;&#35777;&#65292;&#25191;&#34892;&#36523;&#20221;&#39564;&#35777;&#36807;&#31243;&#21644; / &#25110;&#22312;&#36523;&#20221;&#39564;&#35777;&#20043;&#21518;&#36827;&#34892;&#28165;&#29702;&#12290;


<span class="org-comment-delimiter"># </span><span class="org-comment">&#38145;&#23450;&#25991;&#20214;
</span>--work-dir--logs-dir &#21644; --config-dir&#12290;&#40664;&#35748;&#24773;&#20917;&#19979;&#65292;&#36825;&#20123;&#20998;&#21035;&#37117;&#26159; /var/lib/letsencrypt&#65292;/var/log/letsencrypt &#21644; /etc/letsencrypt
&#22914;&#65306;
mkdir zhengzhu ; <span class="org-builtin">cd</span> zhengzhu
sudo certbot certonly  -d <span class="org-string">"*.aiull.com"</span> --manual --preferred-challenges dns --server https://acme-v02.api.letsencrypt.org/directory --config-dir ./config --work-dir ./work --logs-dir ./log
</pre>
</div>



<p>
第一次执行完命令之后会提示需要输入邮箱，和一些协议需要同意和确认，然后每次运行此命令需要记录 IP 信息，需要同意不然不能继续申请
</p>


<p>
<b>设置DNS TXT记录</b>
将提示的 txt 记录值配置在域名供应商 dns 域名解析中。由于 DNS 记录不会马上生效，所以稍后再按回车键。
</p>
<div class="org-src-container">
<pre class="src src-shell："># 验证
nslookup -q=txt _acme-challenge.example.com
dig +short -t txt _acme-challenge.example.com
或者
host -t txt _acme-challenge.alicdn.com
</pre>
</div>

<p>
验证证书有效期
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo openssl x509 -noout -text -in /Users/7tq6lr/zhengzhu/config/live/aiull.com/fullchain.pem
</pre>
</div>

<p>
默认证书目录为：`/etc/letsencrypt/live/$domain`
</p>

<p>
查看证书
</p>
<div class="org-src-container">
<pre class="src src-shell">certbot certificates
</pre>
</div>
</div>
</div>
<div id="outline-container-h:99f4c06a-31b3-4ced-9959-2c0afd01a643" class="outline-4">
<h4 id="h:99f4c06a-31b3-4ced-9959-2c0afd01a643"><a href="#h:99f4c06a-31b3-4ced-9959-2c0afd01a643">自动续订</a></h4>
<div class="outline-text-4" id="text-h:99f4c06a-31b3-4ced-9959-2c0afd01a643">
<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">&#25163;&#21160;&#32493;&#35746;
</span>sudo certbot renew -dry-run

<span class="org-comment-delimiter"># </span><span class="org-comment">&#24110;&#21161; certbot --help renew
</span><span class="org-comment-delimiter"># </span><span class="org-comment">--force-renewal &#24378;&#21046;&#26356;&#26032;&#24573;&#30053;&#26377;&#25928;&#26399;&#65292;&#20294;&#35777;&#20070;&#39041;&#21457;&#26426;&#26500;&#26377;&#36895;&#29575;&#38480;&#21046;&#19981;&#36866;&#21512;&#27599;&#22825;&#26356;&#26032;&#65292;&#19968;&#21608;&#20869;&#19981;&#36229;&#36807;5&#27425;&#12290; https://letsencrypt.org/docs/duplicate-certificate-limit/
</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">&#35774;&#32622;&#33258;&#21160;&#32493;&#35746; &#25105;&#20204;&#24314;&#35758;&#36816;&#34892;&#20197;&#19979;&#34892;&#65292;&#36825;&#20250;&#23558; cron &#20316;&#19994;&#28155;&#21152;&#21040;&#40664;&#35748; crontab&#12290;
</span><span class="org-builtin">echo</span> <span class="org-string">"0 0,12 * * * root $(command -v python3) -c 'import random; import time; time.sleep(random.random() * 3600)' &amp;&amp; sudo $(command -v certbot) renew -q"</span> | sudo tee -a /etc/crontab &gt; /dev/null
<span class="org-comment-delimiter"># </span><span class="org-comment">&#39564;&#35777;&#35777;&#20070;&#26377;&#25928;&#24615;</span>
</pre>
</div>

<p>
使用dns申请的证书是没办法直接使用certbot renew来更新证书的. 幸亏 cerbot 提供了一个 manual-auth-hook hook
可以编写一个脚本，由这个脚本来先完成 DNS 验证，然后再进行 renew。对应的脚本会自动添加 DNS 记录，从而完成 DNS 校验，并自动 renew 证书。
</p>

<p>
参考：<a href="https://blog.k4nz.com/704d5b9b81a53f14ffc04a07befc7e55/">https://blog.k4nz.com/704d5b9b81a53f14ffc04a07befc7e55/</a>
<a href="https://www.cnblogs.com/ellisonzhang/p/14298492.html">https://www.cnblogs.com/ellisonzhang/p/14298492.html</a>
</p>
<div class="org-src-container">
<pre class="src src-shell">pip install certbot-dns-aliyun

<span class="org-comment-delimiter"># </span><span class="org-comment">&#21069;&#24448; https://ram.console.aliyun.com &#30003;&#35831;&#38463;&#37324;&#20113;&#23376;&#36134;&#21495;&#24182;&#25480;&#20104; AliyunDNSFullAccess &#26435;&#38480;
</span><span class="org-comment-delimiter"># </span><span class="org-comment">&#21019;&#24314; AccessKey AccessToken
</span>
cat &gt; /etc/letsencrypt/dns-aliyun-credentials.ini &lt;&lt;EOF<span class="org-sh-heredoc">
certbot_dns_aliyun:dns_aliyun_access_key = 12345678
certbot_dns_aliyun:dns_aliyun_access_key_secret = xxxxcdef
EOF
</span>
chmod 600 /etc/letsencrypt/dns-aliyun-credentials.ini

certbot certonly <span class="org-sh-escaped-newline">\</span>
    -a certbot-dns-aliyun:dns-aliyun <span class="org-sh-escaped-newline">\</span>
    --certbot-dns-aliyun:dns-aliyun-credentials /etc/letsencrypt/dns-aliyun-credentials.ini <span class="org-sh-escaped-newline">\</span>
    -d <span class="org-string">"*.example.com"</span> <span class="org-sh-escaped-newline">\</span>
    --dry-run
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3ee7dffd-d555-4ef6-8965-b76a2d70c62d" class="outline-4">
<h4 id="h:3ee7dffd-d555-4ef6-8965-b76a2d70c62d"><a href="#h:3ee7dffd-d555-4ef6-8965-b76a2d70c62d">配置 nginx</a></h4>
<div class="outline-text-4" id="text-h:3ee7dffd-d555-4ef6-8965-b76a2d70c62d">
</div>
</div>
</div>
</section>
<section id="outline-container-h:26a29de8-63c5-4a18-9d1a-fca2df75a40e" class="outline-2">
<h2 id="h:26a29de8-63c5-4a18-9d1a-fca2df75a40e"><a href="#h:26a29de8-63c5-4a18-9d1a-fca2df75a40e">证书脚本</a></h2>
<div class="outline-text-2" id="text-h:26a29de8-63c5-4a18-9d1a-fca2df75a40e">
</div>
<div id="outline-container-h:68155449-dd9d-4de0-878c-976a7a6816f7" class="outline-3">
<h3 id="h:68155449-dd9d-4de0-878c-976a7a6816f7"><a href="#h:68155449-dd9d-4de0-878c-976a7a6816f7">00-安装配置管理</a></h3>
<div class="outline-text-3" id="text-h:68155449-dd9d-4de0-878c-976a7a6816f7">
<ol class="org-ol">
<li>证书申请</li>
</ol>

<p>
1.1 证书域名申请服务器
</p>

<p>
rsync-server  10.200.46.63 
</p>


<p>
1.2 自动申请脚本
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@rsync-server ~]# crontab -l
<span class="org-comment-delimiter"># </span><span class="org-comment">update certificate
</span>30 09 * * * /bin/sh /home/script/update_cer.sh &gt; /dev/null
<span class="org-comment-delimiter"># </span><span class="org-comment">&#22495;&#21517;&#26816;&#26597;
</span>40 10 * * * cd /home/yongzhi.shi/python &amp;&amp; /usr/bin/python /home/yongzhi.shi/python/check_domain.py &amp;&gt; /dev/null 
</pre>
</div>

<ol class="org-ol">
<li>nginx证书管理</li>
</ol>

<p>
2.1 挂载NAS
</p>

<p>
对应机房申请容量型NAS。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">&#25346;&#36733;NAS
</span>yum install nfs-utils -y
mkdir /usr/local/zhengshu/

vim /etc/fstab
&#23545;&#24212;NAS&#22320;&#22336;:/ /usr/local/zhengshu    nfs4   <span class="org-variable-name">vers</span>=4.0,<span class="org-variable-name">rsize</span>=1048576,<span class="org-variable-name">wsize</span>=1048576,hard,<span class="org-variable-name">timeo</span>=600,<span class="org-variable-name">retrans</span>=2,_netdev,noresvport 0 0

mount -a 
</pre>
</div>

<p>
2.2 ansible推送脚本
</p>

<p>
1 登录sw执行推送脚本
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo su - oap
<span class="org-builtin">cd</span> tools/ansible/
<span class="org-comment-delimiter"># </span><span class="org-comment">hosts&#25991;&#20214;[ssl]&#19979;&#21152;&#19978;&#26377;&#35777;&#20070;&#30340;nginx&#30340;IP
</span>ansible-playbook change_ssl.yml
</pre>
</div>

<p>
2 修改证书更新策略
</p>

<p>
证书剩余28天升级
</p>
<div class="org-src-container">
<pre class="src src-sh">vim change_ssl.yml
<span class="org-comment-delimiter"># </span><span class="org-comment">&#20462;&#25913;--days &#21442;&#25968;
</span>- parameters: <span class="org-string">"--days 28"</span>
</pre>
</div>

<p>
3 修改证书脚本 
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo su - oap
<span class="org-builtin">cd</span> tools/ansible/
vim files/ssl_monitor.sh
<span class="org-comment-delimiter"># </span><span class="org-comment">&#21482;&#20462;&#25913;server_name &#21644; curl_name&#20869;&#23481;</span>
</pre>
</div>

<p>
nginx本地shell邮件配置
</p>

<div class="org-src-container">
<pre class="src src-sh">rsync -r  sa@5.11.58::file/mailssl/certs.tar.gz /tmp/
<span class="org-comment-delimiter"># </span><span class="org-comment">&#23494;&#30721;&#65306;wowonetwork
</span>tar xf /tmp/certs.tar.gz  -C /root/
cat &gt;&gt;/etc/mail.rc&lt;&lt; \EOF<span class="org-sh-heredoc">
set bsdcompat
set from=scans@cici.com
set smtp=smtps://smtp.cici.com:994
set smtp-auth-user=scans@cici.com
set smtp-auth-password='LZ6t0IoL'
set smtp-auth=login
set ssl-verify=ignore
set nss-config-dir=/root/.certs
EOF</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:eafcb5a8-c119-4d53-b6d9-c9b0eb17e311" class="outline-3">
<h3 id="h:eafcb5a8-c119-4d53-b6d9-c9b0eb17e311"><a href="#h:eafcb5a8-c119-4d53-b6d9-c9b0eb17e311">01-申请过程</a></h3>
<div class="outline-text-3" id="text-h:eafcb5a8-c119-4d53-b6d9-c9b0eb17e311">
<p>
### 阿里key
</p>


<div class="org-src-container">
<pre class="src src-sh"><span class="org-builtin">export</span> <span class="org-variable-name">Ali_Key</span>=<span class="org-string">"LhIS"</span>
<span class="org-builtin">export</span> <span class="org-variable-name">Ali_Secret</span>=<span class="org-string">"yjUJFu3Ut"</span>
</pre>
</div>

<p>
测试nginx的公网地址
</p>
<div class="org-src-container">
<pre class="src src-sh">~/.acme.sh/acme.sh --issue --dnssleep 10 --dns dns_ali -d cici.com -d <span class="org-string">"*.cici.com"</span> <span class="org-sh-escaped-newline">\</span>
--installcert<span class="org-sh-escaped-newline">\</span>
--key-file /usr/local/nginx/conf/cici.com.key <span class="org-sh-escaped-newline">\</span>
--fullchain-file /usr/local/nginx/conf/fullchain.cer <span class="org-sh-escaped-newline">\</span>
--reloadcmd <span class="org-string">"service nginx force-reload"</span>

<span class="org-comment-delimiter">#</span><span class="org-comment">&#26356;&#26032;
</span>~/.acme.sh/acme.sh --renew --dns -d c2c.com -d *.c2c.com
</pre>
</div>

<p>
*.cici.com域名证书申请
</p>
<div class="org-src-container">
<pre class="src src-sh">~/.acme.sh/acme.sh --issue --dns dns_ali -d cici.com -d <span class="org-string">"*.cici.com"</span> -d <span class="org-string">"*.yf.cici.com"</span> -d <span class="org-string">"*.partnergate.cici.com"</span> -d <span class="org-string">"*.crossacc.cici.com"</span>

<span class="org-comment-delimiter">#</span><span class="org-comment">&#26356;&#26032;
</span>~/.acme.sh/acme.sh --renew --force --dns -d cici.com -d <span class="org-string">"*.cici.com"</span> -d <span class="org-string">"*.yf.cici.com"</span> -d <span class="org-string">"*.partnergate.cici.com"</span> -d <span class="org-string">"*.crossacc.cici.com"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">&#26597;&#30475;&#35777;&#20070;&#20855;&#20307;&#20869;&#23481;
</span>openssl x509 -in /data/zhengshu/cici.com/fullchain.cer  -noout -text
<span class="org-comment-delimiter">#</span><span class="org-comment">&#26597;&#30475;&#35777;&#20070;&#26102;&#38388;
</span>openssl x509 -in /data/zhengshu/cici.com/fullchain.cer  -noout -dates
</pre>
</div>
</div>
</div>
<div id="outline-container-h:250af8f5-2cf7-4c8b-a720-6028c6db0871" class="outline-3">
<h3 id="h:250af8f5-2cf7-4c8b-a720-6028c6db0871"><a href="#h:250af8f5-2cf7-4c8b-a720-6028c6db0871">02-自动申请续期</a></h3>
<div class="outline-text-3" id="text-h:250af8f5-2cf7-4c8b-a720-6028c6db0871">
<p>
ssl证书自动申请
</p>

<p>
本证书申请是在rsync的服务器上进行更新证书的，处理逻辑是根据现有的域名证书去检查剩余的时间，如果时间低于28天则去申请更新证书，如果大于28天则只发送邮件告诉sa证书的剩余时间；
</p>

<p>
定时任务
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">update certificate
</span>30 09 * * * /bin/sh /home/script/update_cer.sh &gt; /dev/null
</pre>
</div>

<p>
脚本
</p>
<div class="org-src-container">
<pre class="src src-sh">cat &gt;/home/script/update_cer.sh &lt;&lt;\EOF<span class="org-sh-heredoc">
#!/bin/sh
###############################
#system variable
timestamp=`date +%s`
cer_dir="/root/.acme.sh/"
domain_name="
cici.com
xxx.com
"
renew_flag=1

###############################
#yunzong domain name info
Cici_Key () {
    export Ali_Key="LTAh"
    export Ali_Secret="Nl2aJ4e"
}

#xxx domain name info
XXX._Key () {
    export Ali_Key="LTAIICw"
    export Ali_Secret="SnpWvDX"
}


#application certificate
App_Cer () {
    ~/.acme.sh/acme.sh --force --renew-all --dnssleep 10
}

#copy certificate to directory
Copy_Cer () {
    /bin/cp -af /root/.acme.sh/cici.com/fullchain.cer /data/zhengshu/cici.com
    /bin/cp -af /root/.acme.sh/XXX.com/fullchain.cer /data/zhengshu/XXX.com
}

#check certificate endtime
declare -A apply_certs
declare -A certs_days
Check_Cer () {
    for domain in ${domain_name}; do
        cd ${cer_dir}${domain}
        check_key=`/bin/openssl x509 -in fullchain.cer -noout -dates|head -n 2|awk -F= '{print $2}'|tail -n 1`
        key_time=$[(`date -d "${check_key}" +%s`-${timestamp})/24/3600]
        if [ ${key_time} -le 28 ];then
            apply_certs[${#apply_certs[*]}]="`pwd` Certificate time remaining ${key_time} day,this applying\n"
            renew_flag=0
        else
            certs_days[${#certs_days[*]}]="`pwd` ${key_time} day \n"
        fi
    done

    if [ $renew_flag -eq 0 ]; then
        Cici_Key
        App_Cer
        sleep 30
        XXX._Key
        App_Cer
        Copy_Cer
    fi
}


#dingding push
dingding() {
local access_tokens=$1
local ding_url='https://oapi.dingtalk.com/robot/send'
local ding_header='Content-Type: application/json'
local msg=$2
for key in $access_tokens; do
curl  -connect-timeout 40 -XPOST -H "$ding_header" "$ding_url?access_token=$key" \
-d '{"msgtype": "text",
    "text": {
        "content": "&#12304;ssl&#35777;&#20070;&#28304;&#25991;&#20214;&#29366;&#24577;&#12305; \n'"$msg"'"
    },
"at": {
      "atMobiles": [],
      "isAtAll": true
  }
}'
done
}

tokens="a618438957c"
main (){
    Check_Cer
    [ ${#apply_certs[@]} -gt 0 ] &amp;&amp; {
        echo -e "${apply_certs[@]}" | mail -s 'Ali Certificate Details' sa@cici.com
        dingding "$tokens" "$(echo -e "(${apply_certs[@]}")"
    }
    echo -e "rsync&#26381;&#21153;&#22120;&#19978;&#24050;&#30003;&#35831;&#35777;&#20070;&#30340;&#26377;&#25928;&#26399;&#65306;\n ${certs_days[@]}" | mail  -s 'Ali Certificate Details' sa@cici.com
    dingding "$tokens" "$(echo -e "rsync&#26381;&#21153;&#22120;&#19978;&#24050;&#30003;&#35831;&#35777;&#20070;&#30340;&#26377;&#25928;&#26399;&#65306;\n ${certs_days[@]}")"
}

main
EOF</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:620e3ad4-c053-4c5d-8a32-99917782282a" class="outline-3">
<h3 id="h:620e3ad4-c053-4c5d-8a32-99917782282a"><a href="#h:620e3ad4-c053-4c5d-8a32-99917782282a">03-nginx证书过期同步</a></h3>
<div class="outline-text-3" id="text-h:620e3ad4-c053-4c5d-8a32-99917782282a">
<p>
脚本逻辑：
</p>
<ol class="org-ol">
<li>从rsync服务器获取证书，并存放在/tmp下，脚本执行结束后删除临时文件</li>
<li>根据server_name域名变量对比本地证书目录，如果不存在域名目录，则创建</li>
<li>如果本地证书剩40天时，则替换证书。分2种情况替换
<ul class="org-ul">
<li>假设1：检验证书存储点的证书，如果证书CN域名与证书存储目录不对应，则从/tmp中替换证书，并备份变化之前证书</li>
<li>假设2：如果/tmp目录下的证书剩余大于40天，则从/tmp目录中替换证书</li>
</ul></li>
<li>每次脚本运行会生成证书信息，以待下次对比变化。</li>
<li>如果发现一个证书事件，则重载nginx配置文件。</li>
</ol>

<pre class="example" id="org878a5fa">
```mermaid
graph TD
A(第一次检查)--&gt;|内部|B(循环并发执行)
B--&gt;|内部|C(删除临时证书目录)
C--&gt;D(删除老的证书备份文件)
D--&gt;|删除30天前备份|E(第二次检查)
E--&gt;|内部|F(nginx重启)

A--&gt;AA{证书更新记录是否存在}
AA--&gt;|存在|AA1{本地证书文件是否存在}
AA1--&gt;|存在|AA2{本地证书是否更新过-比对在1天以内误差}
AA2--&gt;|没更新|AA3(创建nginx重启触发文件)
AA3--&gt;F

B--&gt;BB[从rsync服务端拉取证书]
BB--&gt;|放到临时证书目录/tmp/zhengshuXXX下|BB1[备份证书]
BB1--&gt;|备份原证书到/data/backup/zhengshu_bak目录下|BB2[循环域名检查]
BB2--&gt;|内部|C

BB2--&gt;|并发执行|BBB{证书目录及文件是否存在}
BBB--&gt;|不存在|OO[替换此证书到本地证书目录]
BBB--&gt;|存在|BBB1{判断本地证书是否有效}
BBB1--&gt;|无效|BBB2[备份无效证书]
BBB2--&gt;OO
BBB--&gt;|存在|BBB11{判断证书剩余时间}
BBB11--&gt;|小于等于26天|OO
OO--&gt;OOO[更新证书记录-证书要大于26天]
OOO--&gt;C

E--&gt;EE[访问本地证书]
EE--&gt;EE1{判断本地curl_name是否能访问}
EE1--&gt;|能访问|EE2{判断证书剩余时间}
EE2--&gt;|判断证书剩余时间与证书更新记录文件中不相等|AA3
```
</pre>
</div>
<div id="outline-container-h:1d2b637b-f6fd-4d8f-a1bd-df2f9586a9b6" class="outline-4">
<h4 id="h:1d2b637b-f6fd-4d8f-a1bd-df2f9586a9b6"><a href="#h:1d2b637b-f6fd-4d8f-a1bd-df2f9586a9b6">免交互式</a></h4>
<div class="outline-text-4" id="text-h:1d2b637b-f6fd-4d8f-a1bd-df2f9586a9b6">
<p>
1.1 rsync同步，免除手动输入密码
</p>
<div class="org-src-container">
<pre class="src src-sh">yum install -y expect
[root@agent01 ~]# cat rsync_pull.exp
<span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/expect -f
</span><span class="org-builtin">set</span> user <span class="org-string">"sa"</span>
<span class="org-builtin">set</span> ip <span class="org-string">"124.x7.109.95"</span>
<span class="org-builtin">set</span> rs_name <span class="org-string">"zhengshu"</span>
<span class="org-builtin">set</span> src_path [lindex $<span class="org-variable-name">argv</span> 0]
<span class="org-builtin">set</span> dest_path [lindex $<span class="org-variable-name">argv</span> 1]
<span class="org-builtin">set</span> passwd <span class="org-string">"wowonetwork"</span>

<span class="org-builtin">set</span> timeout 10

spawn rsync -q -az ${<span class="org-variable-name">user</span>}@${<span class="org-variable-name">ip</span>}::${<span class="org-variable-name">rs_name</span>}/${<span class="org-variable-name">src_path</span>} ${<span class="org-variable-name">dest_path</span>}

expect {
   <span class="org-string">"*Password:"</span> {send <span class="org-string">"$passwd\r"</span>}
}
expect eof
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8e24ecf5-ad06-4cd1-96a4-e5ebec7babf8" class="outline-4">
<h4 id="h:8e24ecf5-ad06-4cd1-96a4-e5ebec7babf8"><a href="#h:8e24ecf5-ad06-4cd1-96a4-e5ebec7babf8">定时任务</a></h4>
<div class="outline-text-4" id="text-h:8e24ecf5-ad06-4cd1-96a4-e5ebec7babf8">
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">ssl_monitor &#21097;&#20313;28&#22825;&#26356;&#26032;
</span>0 23 * * * /bin/bash /home/sh/ssl_monitor.sh - -days 28 &amp;&gt;/dev/null
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ce14dcaf-6b5f-4c33-b425-10b105d0a292" class="outline-4">
<h4 id="h:ce14dcaf-6b5f-4c33-b425-10b105d0a292"><a href="#h:ce14dcaf-6b5f-4c33-b425-10b105d0a292">nginx服务器更新证书脚本</a></h4>
<div class="outline-text-4" id="text-h:ce14dcaf-6b5f-4c33-b425-10b105d0a292">
<p>
3.1 简单版本
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@agent01 ~]# cat rsync_pull.sh
<span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/bash
</span>
<span class="org-variable-name">DIR</span>=<span class="org-string">"$( cd "$( dirname "${BASH_SOURCE[0]}" )" &amp;&amp; pwd )"</span>
<span class="org-variable-name">max_process</span>=5
<span class="org-variable-name">ssl_path</span>=/data
<span class="org-variable-name">ssl_pem</span>=fullchain.cer
<span class="org-variable-name">now_seconds</span>=$(date <span class="org-string">'+%s'</span>)
<span class="org-variable-name">server_name</span>=<span class="org-string">"
cici.com
xxx.com
"</span>
<span class="org-builtin">cd</span> $<span class="org-variable-name">DIR</span>

<span class="org-function-name">Multi_process_init</span>() {
    <span class="org-keyword">trap</span> <span class="org-string">'exec 5&gt;&amp;-;exec 5&lt;&amp;-;exit 0'</span> 2
    <span class="org-variable-name">pipe</span>=<span class="org-sh-quoted-exec">`mktemp -u tmp.XXXX`</span>
    mkfifo $<span class="org-variable-name">pipe</span>
    <span class="org-keyword">exec</span> 5&lt;&gt;$<span class="org-variable-name">pipe</span>
    rm -f $<span class="org-variable-name">pipe</span>

    seq $<span class="org-variable-name">1</span> &gt;&amp;5
}

<span class="org-keyword">function</span> <span class="org-function-name">ssl_pull_all</span>() {
    <span class="org-keyword">for</span> s<span class="org-keyword"> in</span> ${<span class="org-variable-name">server_name</span>}; <span class="org-keyword">do</span>
        <span class="org-variable-name">src_path</span>=$<span class="org-variable-name">s</span>
        <span class="org-variable-name">dest_path</span>=${<span class="org-variable-name">ssl_path</span>}/$<span class="org-variable-name">s</span>
        expect rsync_pull.exp $<span class="org-variable-name">src_path</span>/ $<span class="org-variable-name">dest_path</span>
    <span class="org-keyword">done</span>
}

<span class="org-keyword">function</span> <span class="org-function-name">ssl_pull_one</span>() {
    <span class="org-keyword">for</span> s<span class="org-keyword"> in</span> $<span class="org-variable-name">1</span>; <span class="org-keyword">do</span>
        <span class="org-variable-name">src_path</span>=$<span class="org-variable-name">s</span>
        <span class="org-variable-name">dest_path</span>=${<span class="org-variable-name">ssl_path</span>}/$<span class="org-variable-name">s</span>
        expect rsync_pull.exp $<span class="org-variable-name">src_path</span>/ $<span class="org-variable-name">dest_path</span> &amp;&gt;/dev/null
    <span class="org-keyword">done</span>
    <span class="org-builtin">wait</span>
}

<span class="org-comment-delimiter"># </span><span class="org-comment">check
</span><span class="org-comment-delimiter">#</span><span class="org-comment">end_date=$(echo |\
</span><span class="org-comment-delimiter">#         </span><span class="org-comment">openssl s_client -host cmserver.zonghengke.com -port 443 -showcerts &lt;/dev/null 2&gt;/dev/null |\
</span><span class="org-comment-delimiter">#         </span><span class="org-comment">openssl x509  -noout -dates |\
</span><span class="org-comment-delimiter">#         </span><span class="org-comment">sed -n 's@notAfter=@@p')
</span><span class="org-keyword">function</span> <span class="org-function-name">ssl_check_time</span>() {
    <span class="org-keyword">for</span> s<span class="org-keyword"> in</span> ${<span class="org-variable-name">server_name</span>}; <span class="org-keyword">do</span>
        <span class="org-builtin">read</span> -u5
        {
            [ <span class="org-negation-char">!</span> -e ${<span class="org-variable-name">ssl_path</span>}/${<span class="org-variable-name">s</span>}/ ] &amp;&amp; ssl_pull_one $<span class="org-variable-name">s</span>
            <span class="org-variable-name">end_date</span>=$(openssl x509  -noout -dates -in ${<span class="org-variable-name">ssl_path</span>}/${<span class="org-variable-name">s</span>}/${<span class="org-variable-name">ssl_pem</span>} | sed -n <span class="org-string">'s@notAfter=@@p'</span>)
            <span class="org-builtin">echo</span> $<span class="org-variable-name">s</span> $<span class="org-variable-name">end_date</span>
            <span class="org-variable-name">last_time</span>=$((($(date <span class="org-string">'+%s'</span> --date <span class="org-string">"$end_date"</span>) - $<span class="org-variable-name">now_seconds</span>)/24/3600))
            <span class="org-builtin">echo</span> $<span class="org-variable-name">last_time</span>
            <span class="org-keyword">if</span> [ $<span class="org-variable-name">last_time</span> -le 55  ]; <span class="org-keyword">then</span>
                ssl_pull_one $<span class="org-variable-name">s</span>
            <span class="org-keyword">fi</span>
            <span class="org-builtin">echo</span> &gt;&amp;5
            <span class="org-variable-name">echo</span> ======${<span class="org-variable-name">ssl_path</span>}/${<span class="org-variable-name">s</span>}/ certificate finshed
        }&amp;
    <span class="org-keyword">done</span>
    <span class="org-builtin">wait</span>
}

<span class="org-comment-delimiter">#</span><span class="org-comment">ssl_pull
</span><span class="org-keyword">function</span> <span class="org-function-name">main</span>() {
Multi_process_init $<span class="org-variable-name">max_process</span>
ssl_check_time
<span class="org-keyword">exec</span> 5&gt;&amp;-;<span class="org-keyword">exec</span> 5&lt;&amp;-
}

main
</pre>
</div>

<p>
3.2 完整版
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@agent01 ~]# cat ssl_monitor.sh
<span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/bash
</span><span class="org-comment-delimiter">#</span><span class="org-comment">========================
</span><span class="org-comment-delimiter"># </span><span class="org-comment">version= 0.1
</span><span class="org-comment-delimiter"># </span><span class="org-comment">&#21151;&#33021;&#65306;&#35777;&#20070;&#36807;&#26399;&#26367;&#25442;&#65292;nginx&#26381;&#21153;&#37325;&#36733;&#37197;&#32622;&#12290;
</span><span class="org-comment-delimiter"># </span><span class="org-comment">&#22330;&#26223;&#65306;
</span><span class="org-comment-delimiter"># </span><span class="org-comment">1. &#36866;&#29992;&#20110;&#21333;&#26426;nginx&#29615;&#22659;
</span><span class="org-comment-delimiter"># </span><span class="org-comment">2. &#36866;&#29992;&#20110;&#26377;&#20849;&#20139;&#23384;&#20648;&#30340;&#22810;&#26426;nginx&#29615;&#22659;
</span><span class="org-comment-delimiter"># </span><span class="org-comment">&#36816;&#34892;&#38480;&#21046;&#65306;&#25552;&#21069;&#25351;&#23450;&#27599;&#20010;server_name&#21464;&#37327;&#65292;nginx&#35777;&#20070;&#30446;&#24405;&#35268;&#33539;&#32479;&#19968;&#25918;&#22312;&#33050;&#26412;&#23450;&#20041;&#30340;ssl_path&#21464;&#37327;&#19979;&#12290;
</span><span class="org-comment-delimiter"># </span><span class="org-comment">&#33050;&#26412;&#36923;&#36753;&#65306;
</span><span class="org-comment-delimiter"># </span><span class="org-comment">0. &#20174;rsync&#26381;&#21153;&#22120;&#33719;&#21462;&#35777;&#20070;&#65292;&#24182;&#23384;&#25918;&#22312;/tmp&#19979;&#65292;&#33050;&#26412;&#25191;&#34892;&#32467;&#26463;&#21518;&#21024;&#38500;&#20020;&#26102;&#25991;&#20214;
</span><span class="org-comment-delimiter"># </span><span class="org-comment">1. &#26681;&#25454;server_name&#22495;&#21517;&#21464;&#37327;&#23545;&#27604;&#26412;&#22320;&#35777;&#20070;&#30446;&#24405;&#65292;&#22914;&#26524;&#19981;&#23384;&#22312;&#22495;&#21517;&#30446;&#24405;&#65292;&#21017;&#21019;&#24314;
</span><span class="org-comment-delimiter"># </span><span class="org-comment">2. &#22914;&#26524;&#26412;&#22320;&#35777;&#20070;&#21097;40&#22825;&#26102;&#65292;&#21017;&#26367;&#25442;&#35777;&#20070;&#12290;&#20998;2&#31181;&#24773;&#20917;&#26367;&#25442;
</span><span class="org-comment-delimiter"># </span><span class="org-comment">2.1. &#20551;&#35774;1&#65306;&#26816;&#39564;&#35777;&#20070;&#23384;&#20648;&#28857;&#30340;&#35777;&#20070;&#65292;&#22914;&#26524;&#35777;&#20070;CN&#22495;&#21517;&#19982;&#35777;&#20070;&#23384;&#20648;&#30446;&#24405;&#19981;&#23545;&#24212;&#65292;&#21017;&#20174;/tmp&#20013;&#26367;&#25442;&#35777;&#20070;&#65292;&#24182;&#22791;&#20221;&#21464;&#21270;&#20043;&#21069;&#35777;&#20070;
</span><span class="org-comment-delimiter"># </span><span class="org-comment">2.2. &#20551;&#35774;2&#65306;&#22914;&#26524;/tmp&#30446;&#24405;&#19979;&#30340;&#35777;&#20070;&#21097;&#20313;&#22823;&#20110;40&#22825;&#65292;&#21017;&#20174;/tmp&#30446;&#24405;&#20013;&#26367;&#25442;&#35777;&#20070;
</span><span class="org-comment-delimiter"># </span><span class="org-comment">3. &#27599;&#27425;&#33050;&#26412;&#36816;&#34892;&#20250;&#29983;&#25104;&#35777;&#20070;&#20449;&#24687;&#65292;&#20197;&#24453;&#19979;&#27425;&#23545;&#27604;&#21464;&#21270;&#12290;
</span><span class="org-comment-delimiter"># </span><span class="org-comment">4. &#22914;&#26524;&#21457;&#29616;&#19968;&#20010;&#35777;&#20070;&#20107;&#20214;&#65292;&#21017;&#37325;&#36733;nginx&#65533;&#65533;&#65533;&#32622;&#25991;&#20214;&#12290;
</span><span class="org-comment-delimiter">#########################</span><span class="org-comment">
</span><span class="org-comment-delimiter">#</span><span class="org-comment">source /etc/profile
</span><span class="org-builtin">export</span> <span class="org-variable-name">LANG</span>=en_US.UTF8
<span class="org-variable-name">host_ip</span>=$(/usr/sbin/ifconfig eth0 | sed -n <span class="org-string">'/inet /p'</span>| awk <span class="org-string">'{print $2}'</span>)
<span class="org-variable-name">host_name</span>=$(hostname)
<span class="org-variable-name">DIR</span>=<span class="org-string">"$( cd "$( dirname "${BASH_SOURCE[0]}" )" &amp;&amp; pwd )"</span>
<span class="org-variable-name">max_process</span>=5
<span class="org-variable-name">tmpfile</span>=$(mktemp -u zhengshu.XXXX)
<span class="org-variable-name">tmp_path</span>=/tmp/.${<span class="org-variable-name">tmpfile</span>}
<span class="org-variable-name">backup_path</span>=/data/backup/zhengshu_bak
<span class="org-variable-name">ssl_path</span>=/usr/local/zhengshu
<span class="org-variable-name">ssl_pem</span>=fullchain.cer
<span class="org-variable-name">now_seconds</span>=$(date <span class="org-string">'+%s'</span>)
<span class="org-variable-name">event_file</span>=/tmp/ssl_monitor_event
<span class="org-variable-name">old_info</span>=/data/backup/ssl_old_info
<span class="org-variable-name">email_file</span>=/tmp/email_file
<span class="org-variable-name">tokens</span>=<span class="org-string">"a618xxx"</span>
<span class="org-variable-name">min_days</span>=28
<span class="org-comment-delimiter">#</span><span class="org-comment">&#35777;&#20070;&#22495;&#21517;&#21464;&#37327;(&#37325;&#35201;)
</span><span class="org-variable-name">server_name</span>=<span class="org-string">"
cici.com
c2c.com
c3c.com
"</span>

<span class="org-comment-delimiter">#</span><span class="org-comment">&#26412;&#22320;&#35777;&#20070;&#26377;&#25928;&#26816;&#26597;&#21464;&#37327;(&#21487;&#36873;)
</span><span class="org-variable-name">curl_name</span>=<span class="org-string">"
pur.cici.com
emc.c2c.com
"</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">&#26816;&#26597;&#30446;&#24405;&#26159;&#21542;&#23384;&#23384;
</span><span class="org-builtin">cd</span> $<span class="org-variable-name">DIR</span>
[ <span class="org-negation-char">!</span> -e  $<span class="org-variable-name">tmp_path</span> ] &amp;&amp; mkdir -p $<span class="org-variable-name">tmp_path</span>
[ <span class="org-negation-char">!</span> -e  $<span class="org-variable-name">backup_path</span> ] &amp;&amp; mkdir -p $<span class="org-variable-name">backup_path</span>
[ <span class="org-negation-char">!</span> -e  $<span class="org-variable-name">ssl_path</span> ] &amp;&amp; mkdir -p $<span class="org-variable-name">ssl_path</span>
&gt;$<span class="org-variable-name">email_file</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">echo $tmp_path
</span>[ -z <span class="org-string">"$(which mail)"</span> ] &amp;&amp; yum install -y mailx

<span class="org-comment-delimiter"># </span><span class="org-comment">&#26597;&#26816;&#31243;&#24207;&#20381;&#36182;
</span><span class="org-function-name">create_expect</span>() {
  [ -z <span class="org-string">"$(which expect)"</span> ] &amp;&amp; yum install -y expect
  [ -z <span class="org-string">"$(which rsync)"</span> ] &amp;&amp; yum install -y rsync
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#21019;&#24314;&#20813;&#20132;&#20114;&#25991;&#20214;
</span>    cat &gt; ssl_monitor.exp &lt;&lt; \EOF<span class="org-sh-heredoc">
#!/usr/bin/expect -f
set user "sa"
#set ip "124.x7.109.95"
set ip "47.xx.11.58"
set rs_name "zhengshu"
set src_path [lindex $argv 0]
set dest_path [lindex $argv 1]
set passwd "wowonetwork"

set timeout 10

spawn rsync -q -az ${user}@${ip}::${rs_name}/${src_path} ${dest_path}

expect {
    "*Password:" {send "$passwd\r"}
}
expect eof
EOF
</span>chmod +x ssl_monitor.exp
}

<span class="org-comment-delimiter"># </span><span class="org-comment">&#36827;&#24230;&#26465;&#20989;&#25968;
</span><span class="org-function-name">load</span>() {
    <span class="org-builtin">local</span> <span class="org-variable-name">i</span>=0;
    <span class="org-builtin">local</span> <span class="org-variable-name">str</span>=<span class="org-string">""</span>
    <span class="org-keyword">while</span> [ $<span class="org-variable-name">i</span> -le 100 ]; <span class="org-keyword">do</span>
      printf <span class="org-string">"\e[0;1m[%-100s]1/1\r\e[0m"</span> <span class="org-string">"$str"</span>
      usleep 5000
      <span class="org-builtin">let</span> i++
      <span class="org-comment-delimiter">#</span><span class="org-comment">str+='&#9608;'
</span>      <span class="org-variable-name">str</span>+=<span class="org-string">'#'</span>
    <span class="org-keyword">done</span>
    printf <span class="org-string">"\n"</span>
}

<span class="org-comment-delimiter"># </span><span class="org-comment">&#24182;&#21457;&#20989;&#25968;
</span><span class="org-function-name">Multi_process_init</span>() {
    <span class="org-keyword">trap</span> <span class="org-string">'exec 5&gt;&amp;-;exec 5&lt;&amp;-;exit 0; rm -fr $tmp_path'</span> 2
    <span class="org-variable-name">pipe</span>=<span class="org-sh-quoted-exec">`mktemp -u tmp.XXXX`</span>
    mkfifo $<span class="org-variable-name">pipe</span>
    <span class="org-keyword">exec</span> 5&lt;&gt;$<span class="org-variable-name">pipe</span>
    rm -f $<span class="org-variable-name">pipe</span>

    seq $<span class="org-variable-name">1</span> &gt;&amp;5
}

<span class="org-comment-delimiter"># </span><span class="org-comment">&#25289;&#21462;rsync&#26381;&#21153;&#22120;&#20013;&#35777;&#20070;&#20989;&#25968;
</span><span class="org-function-name">ssl_pull_all</span>() {
    <span class="org-keyword">for</span> s<span class="org-keyword"> in</span> ${<span class="org-variable-name">server_name</span>}; <span class="org-keyword">do</span>
        <span class="org-builtin">read</span> -u5
        {
        <span class="org-variable-name">src_path</span>=$<span class="org-variable-name">s</span>
        <span class="org-variable-name">dest_path</span>=${<span class="org-variable-name">tmp_path</span>}/$<span class="org-variable-name">s</span>
        expect ssl_monitor.exp $<span class="org-variable-name">src_path</span>/ $<span class="org-variable-name">dest_path</span> &amp;&gt;/dev/null
        <span class="org-builtin">echo</span> &gt;&amp;5
        }&amp;
    <span class="org-keyword">done</span>
    <span class="org-builtin">wait</span>
}

<span class="org-comment-delimiter"># </span><span class="org-comment">&#26412;&#22320;&#26087;&#35777;&#20070;&#22791;&#20221;&#20989;&#25968;
</span><span class="org-function-name">ssl_old_backup</span>() {
    <span class="org-variable-name">ssl_change</span>=$<span class="org-variable-name">1</span>
    <span class="org-variable-name">ssl_server_name</span>=$<span class="org-variable-name">2</span>
    <span class="org-keyword">if</span> [ <span class="org-string">"$ssl_change"</span> == <span class="org-string">"true"</span> ]; <span class="org-keyword">then</span>
        <span class="org-builtin">echo</span> <span class="org-string">"Problem: Local ssl $ssl_server_name err "</span>
        rsync -rlpgoDz --delete ${<span class="org-variable-name">ssl_path</span>}/${<span class="org-variable-name">ssl_server_name</span>} ${<span class="org-variable-name">backup_path</span>}/${<span class="org-variable-name">ssl_path</span>##*/}_ssl_problem_change_before.$(date +%Y%m%d%H)/
    <span class="org-keyword">else</span>
        rsync -rlpgoDz --delete ${<span class="org-variable-name">ssl_path</span>}/ ${<span class="org-variable-name">backup_path</span>}/${<span class="org-variable-name">ssl_path</span>##*/}.$(date +%Y%m%d%H%M)/
        <span class="org-comment-delimiter">#</span><span class="org-comment">cp -dR ${ssl_path}/ ${backup_path}/${ssl_path##*/}.$(date +%Y%m%d%H%M)/
</span>    <span class="org-keyword">fi</span>
}

<span class="org-comment-delimiter"># </span><span class="org-comment">&#26412;&#22320;&#26087;&#35777;&#20070;&#36807;&#26399;&#21024;&#38500;&#20989;&#25968;
</span><span class="org-function-name">ssl_old_del</span>() {
    find ${<span class="org-variable-name">backup_path</span>} -maxdepth 1 -type d -mtime +30 -iname <span class="org-string">"${ssl_path##*/}*"</span> | xargs rm -rf
}

<span class="org-comment-delimiter"># </span><span class="org-comment">&#37038;&#20214;&#20869;&#23481;&#20989;&#25968;
</span><span class="org-function-name">send_mail</span>() {
   :
   <span class="org-variable-name">host_name</span>=$<span class="org-variable-name">host_name</span>
   <span class="org-variable-name">host_ip</span>=$<span class="org-variable-name">host_ip</span>
   <span class="org-variable-name">email_file</span>=$<span class="org-variable-name">email_file</span>
   <span class="org-variable-name">domain</span>=$<span class="org-variable-name">1</span>
   <span class="org-variable-name">msg</span>=$<span class="org-variable-name">2</span>

   [ <span class="org-string">"`grep $domain $email_file`"</span> ] || <span class="org-builtin">echo</span> <span class="org-string">"[$domain]"</span> &gt;&gt; $<span class="org-variable-name">email_file</span>
   [ <span class="org-string">"`sed -rn "/\[$domain\]/,/[^\[]/p" $email_file  |grep "$msg"`"</span> ] || sed -i <span class="org-string">"/\[${domain}\]/a$host_ip $host_name $msg"</span> $<span class="org-variable-name">email_file</span>
}

<span class="org-comment-delimiter">#</span><span class="org-comment">dingding push
</span><span class="org-function-name">dingding</span>() {
<span class="org-builtin">local</span> <span class="org-variable-name">access_tokens</span>=$<span class="org-variable-name">1</span>
<span class="org-builtin">local</span> <span class="org-variable-name">ding_url</span>=<span class="org-string">'https://oapi.dingtalk.com/robot/send'</span>
<span class="org-builtin">local</span> <span class="org-variable-name">ding_header</span>=<span class="org-string">'Content-Type: application/json'</span>
<span class="org-builtin">local</span> <span class="org-variable-name">msg</span>=$<span class="org-variable-name">2</span>
<span class="org-keyword">for</span> key<span class="org-keyword"> in</span> $<span class="org-variable-name">access_tokens</span>; <span class="org-keyword">do</span>
curl  -connect-timeout 40 -XPOST -H <span class="org-string">"$ding_header"</span> <span class="org-string">"$ding_url?access_token=$key"</span> <span class="org-sh-escaped-newline">\</span>
-d <span class="org-string">'{"msgtype": "text",
    "text": {
        "content": "&#12304;nginx&#35777;&#20070;&#26356;&#26032;&#36890;&#30693;&#12305; \n'"$msg"'"
    },
"at": {
      "atMobiles": [],
      "isAtAll": true
  }
}'</span>
<span class="org-keyword">done</span>
}

<span class="org-comment-delimiter"># </span><span class="org-comment">&#26412;&#22320;&#35777;&#20070;&#19982;&#25289;&#21462;&#21040;&#35777;&#20070;&#27604;&#23545;&#20989;&#25968;&#65292;&#26377;&#25928;&#21017;&#26356;&#26032;&#26412;&#22320;&#35777;&#20070;(&#37325;&#35201;)
</span><span class="org-function-name">ssl_copy_one</span>() {
    <span class="org-keyword">for</span> s<span class="org-keyword"> in</span> $<span class="org-variable-name">1</span>; <span class="org-keyword">do</span>
        <span class="org-builtin">local</span> <span class="org-variable-name">src_path</span>=${<span class="org-variable-name">tmp_path</span>}/$<span class="org-variable-name">s</span>
        <span class="org-builtin">local</span> <span class="org-variable-name">dest_path</span>=${<span class="org-variable-name">ssl_path</span>}/$<span class="org-variable-name">s</span>
        <span class="org-builtin">local</span> <span class="org-variable-name">remot_end_date</span>=$(openssl x509  -noout -dates -in ${<span class="org-variable-name">tmp_path</span>}/${<span class="org-variable-name">s</span>}/${<span class="org-variable-name">ssl_pem</span>} | sed -n <span class="org-string">'s@notAfter=@@p'</span>)
        <span class="org-builtin">local</span> <span class="org-variable-name">remot_last_time</span>=$((($(date <span class="org-string">'+%s'</span> --date <span class="org-string">"${remot_end_date}"</span>) - $<span class="org-variable-name">now_seconds</span>)/24/3600))
        <span class="org-keyword">if</span> [ $<span class="org-variable-name">remot_last_time</span> -gt $<span class="org-variable-name">min_days</span> ]; <span class="org-keyword">then</span>
            <span class="org-builtin">echo</span> <span class="org-string">"remot_last_time $remot_last_time &gt; min_days $min_days "</span>
            rsync -az --delete --timeout=100 $<span class="org-variable-name">src_path</span>/ $<span class="org-variable-name">dest_path</span>
            touch $<span class="org-variable-name">event_file</span>
            send_mail $<span class="org-variable-name">s</span> <span class="org-string">"$2"</span>
        <span class="org-keyword">fi</span>
    <span class="org-keyword">done</span>
    <span class="org-builtin">wait</span>
}

<span class="org-comment-delimiter"># </span><span class="org-comment">&#26412;&#22320;nginx&#37325;&#36733;&#37197;&#32622;&#20989;&#25968;(&#37325;&#35201;)
</span><span class="org-function-name">ng_reload</span>() {
    <span class="org-builtin">echo</span> <span class="org-string">"... Reload nginx?"</span>
    <span class="org-variable-name">ng_p</span>=$(ps -ef|grep nginx|grep master |awk <span class="org-string">'{print $2}'</span>)
    [  -z <span class="org-string">"$ng_p"</span> ] &amp;&amp; { <span class="org-builtin">echo</span> nginx is not running; <span class="org-keyword">exit</span> 1; }
    <span class="org-variable-name">ng_cmd</span>=$(ls -l /proc/${<span class="org-variable-name">ng_p</span>}/exe| awk <span class="org-string">'{print $11}'</span>)
    <span class="org-variable-name">nginx_reload_sum</span>=0
    <span class="org-keyword">if</span> [ -f <span class="org-string">"$event_file"</span> ]; <span class="org-keyword">then</span>
        <span class="org-keyword">if</span>  $<span class="org-variable-name">ng_cmd</span> -t &amp;&gt;/dev/null; <span class="org-keyword">then</span>
            <span class="org-builtin">let</span> nginx_reload_sum++
            <span class="org-comment-delimiter">#</span><span class="org-comment">echo $nginx_reload_sum
</span>        <span class="org-keyword">else</span>
            <span class="org-builtin">let</span> nginx_reload_sum--
            <span class="org-comment-delimiter">#</span><span class="org-comment">echo $nginx_reload_sum
</span>        <span class="org-keyword">fi</span>
        rm -f $<span class="org-variable-name">event_file</span>
        [ $<span class="org-variable-name">nginx_reload_sum</span> -ge 0 ] &amp;&amp; { <span class="org-builtin">echo</span> <span class="org-string">"yes, done"</span> ; $<span class="org-variable-name">ng_cmd</span> -s reload; } || { $<span class="org-variable-name">ng_cmd</span> -t; <span class="org-keyword">exit</span> 1; }
    <span class="org-keyword">else</span>
       <span class="org-builtin">echo</span> <span class="org-string">"no, nothing is changed"</span>
    <span class="org-keyword">fi</span>

}

<span class="org-comment-delimiter"># </span><span class="org-comment">&#26816;&#26597;&#26412;&#22320;&#26356;&#26032;&#25991;&#20214;&#65292;&#21464;&#21270;&#21017;&#29983;&#25104;&#37325;&#36733;nginx&#35302;&#21457;&#20107;&#20214;&#25991;&#20214;
</span><span class="org-function-name">ssl_check_first</span>() {
    <span class="org-keyword">if</span> [ -f $<span class="org-variable-name">old_info</span> ]; <span class="org-keyword">then</span>
        <span class="org-keyword">for</span> s<span class="org-keyword"> in</span> ${<span class="org-variable-name">server_name</span>}; <span class="org-keyword">do</span>
            <span class="org-keyword">if</span> [ -e ${<span class="org-variable-name">ssl_path</span>}/${<span class="org-variable-name">s</span>}/  -a  -f ${<span class="org-variable-name">ssl_path</span>}/${<span class="org-variable-name">s</span>}/fullchain.cer -a -f ${<span class="org-variable-name">ssl_path</span>}/${<span class="org-variable-name">s</span>}/${<span class="org-variable-name">s</span>}.key ]; <span class="org-keyword">then</span>
                <span class="org-variable-name">end_date</span>=$(openssl x509  -noout -dates -in ${<span class="org-variable-name">ssl_path</span>}/${<span class="org-variable-name">s</span>}/${<span class="org-variable-name">ssl_pem</span>} | sed -n <span class="org-string">'s@notAfter=@@p'</span>)
                <span class="org-variable-name">last_time</span>=$((($(date <span class="org-string">'+%s'</span> --date <span class="org-string">"$end_date"</span>) - $<span class="org-variable-name">now_seconds</span>)/24/3600))
                <span class="org-variable-name">yes_time</span>=$((($(date <span class="org-string">'+%s'</span> --date <span class="org-string">"$end_date"</span>) - $<span class="org-variable-name">now_seconds</span>)/24/3600+1))
                <span class="org-variable-name">old_time</span>=$(cat ${<span class="org-variable-name">old_info</span>} |sed -rn <span class="org-string">"/${s}/s@${s},(.*)@\1@gp"</span> | head -1)
                <span class="org-keyword">if</span> [ <span class="org-string">"$last_time"</span> != <span class="org-string">"$old_time"</span> -a <span class="org-string">"$yes_time"</span> != <span class="org-string">"$old_time"</span> ]; <span class="org-keyword">then</span>
                   <span class="org-builtin">echo</span> <span class="org-string">"$s $last_time != $old_time Create event file: $event_file"</span>
                   touch $<span class="org-variable-name">event_file</span>
                   send_mail $<span class="org-variable-name">s</span> <span class="org-string">"&#35302;&#21457;nginx reload&#20107;&#20214;. &#19982;&#26412;&#27425;&#30340;&#26356;&#26032;&#35760;&#24405;${new_time}&#19981;&#19968;&#33268;&#65292;&#26412;&#22320;&#35777;&#20070;&#26377;&#25928;&#26399;${last_time}"</span>
                   sleep 2
                <span class="org-keyword">fi</span>
            <span class="org-keyword">fi</span>
        <span class="org-keyword">done</span>
    <span class="org-keyword">else</span>
        touch $<span class="org-variable-name">old_info</span>
    <span class="org-keyword">fi</span>
}

<span class="org-comment-delimiter"># </span><span class="org-comment">&#26412;&#22320;&#26816;&#26597;nginx&#37325;&#36733;&#21518;&#65292;&#35777;&#20070;&#39564;&#35777;&#20989;&#25968;
</span><span class="org-function-name">ssl_check_second</span>() {
  :
  <span class="org-keyword">for</span> s<span class="org-keyword"> in</span> ${<span class="org-variable-name">curl_name</span>}; <span class="org-keyword">do</span>
      <span class="org-keyword">if</span> curl -I -v -m 1 --resolve <span class="org-string">"${s}:443:${host_ip}"</span> <span class="org-string">"https://${s}/"</span> &amp;&gt;/dev/null; <span class="org-keyword">then</span>
          <span class="org-variable-name">end_date</span>=$(curl -I -v -m 1 --resolve <span class="org-string">"${s}:443:${host_ip}"</span> <span class="org-string">"https://${s}/"</span> 2&gt;&amp;1 |sed -nr <span class="org-string">'s@.*expire date: @@p'</span>)
          <span class="org-variable-name">last_time</span>=$((($(date <span class="org-string">'+%s'</span> --date <span class="org-string">"$end_date"</span>) - $<span class="org-variable-name">now_seconds</span>)/24/3600))
          <span class="org-variable-name">s_name</span>=$(<span class="org-builtin">echo</span> ${<span class="org-variable-name">s</span>#*.})
          <span class="org-variable-name">new_time</span>=$(cat ${<span class="org-variable-name">old_info</span>} |sed -rn <span class="org-string">"/${s_name}/s@${s_name},(.*)@\1@gp"</span> | head -1)
          <span class="org-keyword">if</span> [ <span class="org-string">"$last_time"</span> != <span class="org-string">"$new_time"</span> ]; <span class="org-keyword">then</span>
             <span class="org-builtin">echo</span> <span class="org-string">"$s $last_time != $new_time Create event file: $event_file"</span>
             touch $<span class="org-variable-name">event_file</span>
             send_mail ${<span class="org-variable-name">s_name</span>} <span class="org-string">"&#35302;&#21457;nginx reload&#20107;&#20214;. &#19982;&#26412;&#27425;&#30340;&#26356;&#26032;&#35760;&#24405;${new_time}&#19981;&#19968;&#33268;&#65292;&#27169;&#25311;&#35775;&#38382;&#26412;&#22320;&#22495;&#21517;&#35777;&#20070;&#26377;&#25928;&#26399;${last_time}"</span>
             sleep 1
          <span class="org-keyword">fi</span>
      <span class="org-keyword">fi</span>
  <span class="org-keyword">done</span>
}

<span class="org-comment-delimiter"># </span><span class="org-comment">check
</span><span class="org-comment-delimiter">#</span><span class="org-comment">end_date=$(echo |\
</span><span class="org-comment-delimiter">#         </span><span class="org-comment">openssl s_client -host cmserver.zizi.com -port 443 -showcerts &lt;/dev/null 2&gt;/dev/null |\
</span><span class="org-comment-delimiter">#         </span><span class="org-comment">openssl x509  -noout -dates |\
</span><span class="org-comment-delimiter">#         </span><span class="org-comment">sed -n 's@notAfter=@@p')
</span><span class="org-comment-delimiter"># </span><span class="org-comment">&#20027;&#36923;&#36753;&#20989;&#25968;&#65292;&#26412;&#22320;&#35777;&#20070;&#23567;&#20110;min_days&#22825;&#35302;&#21457;
</span><span class="org-function-name">ssl_check_time</span>() {
    <span class="org-builtin">echo</span> <span class="org-string">"Monitor the certificates ..."</span>
    ssl_pull_all
    ssl_old_backup
    <span class="org-builtin">echo</span> <span class="org-string">"Local certificate validation ..."</span>
    <span class="org-builtin">echo</span> <span class="org-string">'Remote certificate validation ...'</span>
    &gt; $<span class="org-variable-name">old_info</span>
    <span class="org-keyword">for</span> s<span class="org-keyword"> in</span> ${<span class="org-variable-name">server_name</span>}; <span class="org-keyword">do</span>
        <span class="org-builtin">read</span> -u5
        {
            <span class="org-keyword">if</span> [ <span class="org-negation-char">!</span> -e ${<span class="org-variable-name">ssl_path</span>}/${<span class="org-variable-name">s</span>}/  -o <span class="org-negation-char">!</span> -f ${<span class="org-variable-name">ssl_path</span>}/${<span class="org-variable-name">s</span>}/fullchain.cer -o  <span class="org-negation-char">!</span> -f ${<span class="org-variable-name">ssl_path</span>}/${<span class="org-variable-name">s</span>}/${<span class="org-variable-name">s</span>}.key ]; <span class="org-keyword">then</span>
                rsync -az --delete --timeout=100 ${<span class="org-variable-name">tmp_path</span>}/$<span class="org-variable-name">s</span>/ ${<span class="org-variable-name">ssl_path</span>}/$<span class="org-variable-name">s</span>
                send_mail $<span class="org-variable-name">s</span> <span class="org-string">"&#35777;&#20070;&#25991;&#20214;&#19981;&#23384;&#22312;&#65292;&#24050;&#21516;&#27493;"</span>
                <span class="org-variable-name">end_date</span>=$(openssl x509  -noout -dates -in ${<span class="org-variable-name">ssl_path</span>}/${<span class="org-variable-name">s</span>}/${<span class="org-variable-name">ssl_pem</span>} | sed -n <span class="org-string">'s@notAfter=@@p'</span>)
                <span class="org-variable-name">last_time</span>=$((($(date <span class="org-string">'+%s'</span> --date <span class="org-string">"$end_date"</span>) - $<span class="org-variable-name">now_seconds</span>)/24/3600))
                <span class="org-builtin">echo</span> <span class="org-string">"$s,$lasttime"</span> &gt;&gt;$<span class="org-variable-name">old_info</span>
            <span class="org-keyword">else</span>
                <span class="org-variable-name">end_date</span>=$(openssl x509  -noout -dates -in ${<span class="org-variable-name">ssl_path</span>}/${<span class="org-variable-name">s</span>}/${<span class="org-variable-name">ssl_pem</span>} | sed -n <span class="org-string">'s@notAfter=@@p'</span>)
                <span class="org-variable-name">last_time</span>=$((($(date <span class="org-string">'+%s'</span> --date <span class="org-string">"$end_date"</span>) - $<span class="org-variable-name">now_seconds</span>)/24/3600))
                <span class="org-comment-delimiter">#</span><span class="org-comment">echo "$s,$last_time" &gt;&gt;/data/backup/ssl_old_info
</span>                <span class="org-variable-name">local_ssl_CN</span>=$(openssl x509  -noout -subject -in ${<span class="org-variable-name">ssl_path</span>}/${<span class="org-variable-name">s</span>}/${<span class="org-variable-name">ssl_pem</span>} |sed -r <span class="org-string">'s@subject= /CN=(.*)@\1@g'</span>)
                <span class="org-keyword">if ! </span><span class="org-builtin">echo</span> ${<span class="org-variable-name">local_ssl_CN</span>} | grep <span class="org-string">"$s"</span> &amp;&gt;/dev/null ; <span class="org-keyword">then</span>
                    ssl_old_backup <span class="org-string">"true"</span> <span class="org-string">"$s"</span>
                    rsync -az --delete --timeout=100 ${<span class="org-variable-name">tmp_path</span>}/$<span class="org-variable-name">s</span>/ ${<span class="org-variable-name">ssl_path</span>}/$<span class="org-variable-name">s</span>
                    send_mail $<span class="org-variable-name">s</span> <span class="org-string">"&#35777;&#20070;&#25991;&#20214;&#19981;&#22312;&#35813;&#22495;&#21517;&#20013;&#65292;&#24050;&#26367;&#25442;"</span>
                <span class="org-keyword">fi</span>
                <span class="org-keyword">if</span> [ $<span class="org-variable-name">last_time</span> -le $<span class="org-variable-name">min_days</span>  ]; <span class="org-keyword">then</span>
                    ssl_copy_one $<span class="org-variable-name">s</span> <span class="org-string">"&#35777;&#20070;&#25991;&#20214;&#26356;&#26032;&#65292;&#24403;&#21069;&#21097;&#20313;$last_time&#22825;"</span>
                <span class="org-keyword">fi</span>
                <span class="org-variable-name">end_date</span>=$(openssl x509  -noout -dates -in ${<span class="org-variable-name">ssl_path</span>}/${<span class="org-variable-name">s</span>}/${<span class="org-variable-name">ssl_pem</span>} | sed -n <span class="org-string">'s@notAfter=@@p'</span>)
                <span class="org-comment-delimiter">#</span><span class="org-comment">echo $s $end_date
</span>                <span class="org-variable-name">last_time</span>=$((($(date <span class="org-string">'+%s'</span> --date <span class="org-string">"$end_date"</span>) - $<span class="org-variable-name">now_seconds</span>)/24/3600))
                <span class="org-builtin">echo</span> <span class="org-string">"$s,$last_time"</span> &gt;&gt;$<span class="org-variable-name">old_info</span>
            <span class="org-keyword">fi</span>

            <span class="org-builtin">echo</span> &gt;&amp;5
            <span class="org-builtin">echo</span> ... ${<span class="org-variable-name">ssl_path</span>}/${<span class="org-variable-name">s</span>}/ certificate is fished
        }&amp;
    <span class="org-keyword">done</span>
    <span class="org-builtin">wait</span>
    <span class="org-comment-delimiter">#</span><span class="org-comment">load
</span>}

<span class="org-comment-delimiter">#</span><span class="org-comment">ssl_pull
</span><span class="org-function-name">main</span>() {
    ssl_check_first
    Multi_process_init $<span class="org-variable-name">max_process</span>
    ssl_check_time
    rm -fr $<span class="org-variable-name">tmp_path</span>
    ssl_old_del
    <span class="org-keyword">exec</span> 5&gt;&amp;-;<span class="org-keyword">exec</span> 5&lt;&amp;-
    ssl_check_second
    ng_reload
    <span class="org-keyword">if</span>  <span class="org-sh-quoted-exec">`grep 'nss-config-dir' /etc/mail.rc`</span>; <span class="org-keyword">then</span>
        [ <span class="org-sh-quoted-exec">`wc -l $email_file|awk '{print $1}'`</span> != <span class="org-string">"0"</span>  ] &amp;&amp; cat $<span class="org-variable-name">email_file</span>|mail -s <span class="org-string">"&#12304;&#35777;&#20070;&#26356;&#26032;&#12305;$host_ip"</span> sa@cici.com
    <span class="org-keyword">fi</span>
    [ <span class="org-sh-quoted-exec">`wc -l $email_file|awk '{print $1}'`</span> != <span class="org-string">"0"</span>  ] &amp;&amp;  dingding <span class="org-string">"$tokens"</span> <span class="org-string">"$(echo -e "$(cat $email_file)")"</span>
    rm -f $<span class="org-variable-name">email_file</span>
}
<span class="org-comment-delimiter">#</span><span class="org-comment">create_expect
</span><span class="org-comment-delimiter">#</span><span class="org-comment">main
</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">------------
</span><span class="org-function-name">usage</span>(){
cat &lt;&lt;EOF<span class="org-sh-heredoc">
Usage: $0 [MODE] [OPTION]

OPTION:
  -s, --show               default show dir of old ssl, show ssl information you can exec ssl -s or https -s
  -r, --rollback &lt;date&gt;    rollback  dir, before you cmd -s.
  -d, --days &lt;num&gt;         unit day.
  --version                show version
  --help                   show help
MODE:
  ssl, https
EOF
</span>}

getopt -T &amp;&gt;/dev/null;[ $<span class="org-variable-name">?</span> -ne 4 ] &amp;&amp; { <span class="org-builtin">echo</span> <span class="org-string">"not enhanced version"</span>;<span class="org-keyword">exit</span> 1; }

<span class="org-variable-name">parameters</span>=$(getopt -o r:d:s --long rollback:,days:,show,help,version -n <span class="org-string">"$0"</span> -- <span class="org-string">"$@"</span>)
[ $<span class="org-variable-name">?</span> -ne 0 ] &amp;&amp; { <span class="org-builtin">echo</span> <span class="org-string">"Try '$0 --help' for more information."</span>; <span class="org-keyword">exit</span> 1; }

<span class="org-builtin">eval</span> set -- <span class="org-string">"$parameters"</span>

<span class="org-keyword">while </span><span class="org-builtin">true</span>; <span class="org-keyword">do</span>
    <span class="org-keyword">case</span> <span class="org-string">"$1"</span><span class="org-keyword"> in</span>
    -s|--show) <span class="org-variable-name">Type</span>=<span class="org-string">"show"</span>; <span class="org-builtin">shift</span> ;;
    -r|--rollback) <span class="org-variable-name">Type</span>=<span class="org-string">"rollback"</span> <span class="org-variable-name">RollFile</span>=$<span class="org-variable-name">2</span> ; <span class="org-builtin">shift</span> 2 ;;
    -d|--days) <span class="org-variable-name">Type</span>=<span class="org-string">"days"</span> <span class="org-variable-name">Days_to_empty</span>=$<span class="org-variable-name">2</span> ; <span class="org-builtin">shift</span> 2 ;;
    --version) <span class="org-builtin">echo</span> <span class="org-string">"$0 version V0.1"</span>; <span class="org-keyword">exit</span> ;;
    --help) usage;<span class="org-keyword">exit</span> ;;
    --)
        <span class="org-builtin">shift</span>
        [ <span class="org-string">"$1"</span> = <span class="org-string">""</span> -o <span class="org-string">"$1"</span> = <span class="org-string">"ssl"</span> -o <span class="org-string">"$1"</span> = <span class="org-string">"https"</span>  ] &amp;&amp; <span class="org-variable-name">MODE</span>=$<span class="org-variable-name">1</span> ||  {
        <span class="org-builtin">echo</span> -e <span class="org-string">"$0: invalid floating point argument: $@\nTry '$0 --help' for more information."</span> ; <span class="org-keyword">exit</span> 1; }
        [ <span class="org-string">"$#"</span> -ge 2 ] &amp;&amp; {
        <span class="org-builtin">echo</span> -e <span class="org-string">"$0: invalid floating point argument: $@\nTry '$0 --help' for more information."</span> ; <span class="org-keyword">exit</span> 1; }
        <span class="org-variable-name">FIRST</span>=$<span class="org-variable-name">1</span>
        <span class="org-variable-name">SECOND</span>=$<span class="org-variable-name">2</span>
        <span class="org-variable-name">LAST</span>=$<span class="org-variable-name">3</span>
        <span class="org-keyword">break</span> ;;
    *) <span class="org-builtin">echo</span> <span class="org-string">"0k"</span>  ;;
    <span class="org-keyword">esac</span>
<span class="org-keyword">done</span>

<span class="org-comment-delimiter">#</span><span class="org-comment">echo $parameters
</span><span class="org-keyword">case</span> <span class="org-string">"$Type"</span><span class="org-keyword"> in</span>
<span class="org-string">""</span>)
   [ -n <span class="org-string">"$MODE"</span> ] &amp;&amp;  { <span class="org-builtin">echo</span> -e <span class="org-string">"$0: invalid floating point argument: $@\nTry '$0 --help' for more information."</span> ; <span class="org-keyword">exit</span> 1; }
   create_expect
   main
   rm -f ssl_monitor.exp
   <span class="org-builtin">echo</span> <span class="org-string">"exec main"</span> ;;
show)
   <span class="org-keyword">if</span> [ -n <span class="org-string">"$MODE"</span> ]; <span class="org-keyword">then</span>
       <span class="org-builtin">echo</span> <span class="org-string">"Before the change ssl information"</span>
       [ -f $<span class="org-variable-name">old_info</span> ] &amp;&amp; cat $<span class="org-variable-name">old_info</span> || <span class="org-builtin">echo</span> <span class="org-string">"cannot access $old_info: No such file"</span>
   <span class="org-keyword">else</span>
       [ -d $<span class="org-variable-name">backup_path</span> ] &amp;&amp; ls -l $<span class="org-variable-name">backup_path</span> | less || <span class="org-builtin">echo</span> <span class="org-string">"cannot access $backup_path: No such directory"</span>
   <span class="org-keyword">fi</span>
   ;;
rollback)
   [ -n <span class="org-string">"$MODE"</span> ] &amp;&amp;  { <span class="org-builtin">echo</span> -e <span class="org-string">"$0: invalid floating point argument: $@\nTry '$0 --help' for more information."</span> ; <span class="org-keyword">exit</span> 1; }
   [ <span class="org-negation-char">!</span> -d $<span class="org-variable-name">backup_path</span>/zhengshu.$<span class="org-variable-name">RollFile</span> ] &amp;&amp; { <span class="org-builtin">echo</span> <span class="org-string">"cannot access $backup_path/zhengshu.$RollFile: No such directory"</span>; <span class="org-keyword">exit</span> 1; }
   <span class="org-builtin">echo</span> $<span class="org-variable-name">RollFile</span>
   ;;
days)
   <span class="org-comment-delimiter">#</span><span class="org-comment">[ -n "$MODE" ] &amp;&amp;  { echo -e "$0: invalid floating point argument: $@\nTry '$0 --help' for more information." ; exit 1; }
</span>   [  $(<span class="org-builtin">echo</span> ${<span class="org-variable-name">Days_to_empty</span>} |grep <span class="org-string">'^[^[:digit:]]*$'</span>)  ] &amp;&amp; { <span class="org-builtin">echo</span> -e <span class="org-string">"$0: invalid floating point argument: $@\nTry '$0 --help' for more information."</span> ; <span class="org-keyword">exit</span> 1; }
   <span class="org-variable-name">min_days</span>=${<span class="org-variable-name">Days_to_empty</span>}
   create_expect
   main
   rm -f ssl_monitor.exp
   <span class="org-builtin">echo</span> <span class="org-string">"exec main"</span>
   ;;
*) <span class="org-builtin">echo</span> <span class="org-string">"no"</span> ;;
<span class="org-keyword">esac</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:e008414f-3b5b-4edc-9c0e-c620fc0b9862" class="outline-3">
<h3 id="h:e008414f-3b5b-4edc-9c0e-c620fc0b9862"><a href="#h:e008414f-3b5b-4edc-9c0e-c620fc0b9862">04-使用Python检查域名证书剩余时间</a></h3>
<div class="outline-text-3" id="text-h:e008414f-3b5b-4edc-9c0e-c620fc0b9862">
<p>
通过Python检查设定好的域名，通过域名的访问去检查证书的剩余时间，并且发送邮件通知
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">!/usr/bin/env python
</span><span class="org-comment-delimiter"># </span><span class="org-comment">-*- coding:utf-8 -*-
</span><span class="org-comment-delimiter">#</span><span class="org-comment">
</span>
<span class="org-keyword">import</span> commands

<span class="org-keyword">import</span> smtplib
<span class="org-keyword">from</span> email.mime.image <span class="org-keyword">import</span> MIMEImage
<span class="org-keyword">from</span> email.mime.multipart <span class="org-keyword">import</span> MIMEMultipart
<span class="org-keyword">from</span> email.mime.text <span class="org-keyword">import</span> MIMEText
<span class="org-keyword">from</span> email.header <span class="org-keyword">import</span> Header

<span class="org-keyword">def</span> <span class="org-function-name">send_email</span>(to_addr, cc_addr, subject, content):
    <span class="org-comment-delimiter"># </span><span class="org-comment">to_addr = ['xcwhxxe@xxx.com']  # &#25509;&#25910;&#37038;&#20214;&#65292;&#21487;&#35774;&#32622;&#20026;&#20320;&#30340;QQ&#37038;&#31665;&#25110;&#32773;&#20854;&#20182;&#37038;&#31665;
</span>    <span class="org-comment-delimiter"># </span><span class="org-comment">cc_addr = ['xcwhxxe'] # &#25220;&#36865;
</span>    <span class="org-comment-delimiter"># </span><span class="org-comment">subject = 'Python SMTP &#37038;&#20214;&#27979;&#35797;' # &#20027;&#39064;
</span>
    <span class="org-variable-name">mail_host</span> <span class="org-operator">=</span> <span class="org-string">"smtp.cici.com"</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">&#35774;&#32622;&#26381;&#21153;&#22120;
</span>    <span class="org-variable-name">mail_user</span> <span class="org-operator">=</span> <span class="org-string">"scans@cici.com"</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">&#29992;&#25143;&#21517;
</span>    <span class="org-variable-name">mail_pass</span> <span class="org-operator">=</span> <span class="org-string">"LZ"</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">&#21475;&#20196;
</span>    <span class="org-variable-name">sender</span> <span class="org-operator">=</span> <span class="org-string">'scans'</span>

    <span class="org-variable-name">msgRoot</span> <span class="org-operator">=</span> MIMEMultipart(<span class="org-string">'related'</span>)
    <span class="org-variable-name">msgRoot</span>[<span class="org-string">'From'</span>] <span class="org-operator">=</span> Header(mail_user, <span class="org-string">'utf-8'</span>)
    <span class="org-variable-name">msgRoot</span>[<span class="org-string">'To'</span>] <span class="org-operator">=</span> Header(<span class="org-string">","</span>.join(to_addr), <span class="org-string">'utf-8'</span>)
    <span class="org-comment-delimiter">#</span><span class="org-comment">msgRoot['Cc'] = Header(",".join(cc_addr)) # &#25220;&#36865;
</span>    <span class="org-variable-name">msgRoot</span>[<span class="org-string">'Subject'</span>] <span class="org-operator">=</span> Header(subject, <span class="org-string">'utf-8'</span>)

    <span class="org-keyword">if</span> is_html:
        <span class="org-variable-name">msgAlternative</span> <span class="org-operator">=</span> MIMEMultipart(<span class="org-string">'alternative'</span>)
        msgRoot.attach(msgAlternative)

        <span class="org-variable-name">mail_msg</span> <span class="org-operator">=</span><span class="org-string">'&lt;h2&gt;&#22270;&#31034;&#65306;&lt;/h2&gt;'</span>
        msgAlternative.attach(MIMEText(content<span class="org-operator">+</span>mail_msg, <span class="org-string">'html'</span>, <span class="org-string">'utf-8'</span>))
    <span class="org-keyword">else</span>:
        <span class="org-variable-name">msg_content</span> <span class="org-operator">=</span> MIMEText(content, <span class="org-string">'plain'</span>, <span class="org-string">'utf-8'</span>)
        msgRoot.attach(msg_content)

    <span class="org-keyword">try</span>:
        <span class="org-variable-name">smtpObj</span> <span class="org-operator">=</span> smtplib.SMTP_SSL()
        smtpObj.connect(mail_host, 994)  <span class="org-comment-delimiter"># </span><span class="org-comment">25 &#20026; SMTP &#31471;&#21475;&#21495;
</span>        smtpObj.login(mail_user, mail_pass)
        smtpObj.sendmail(mail_user, to_addr, msgRoot.as_string())
        <span class="org-comment-delimiter">#</span><span class="org-comment">smtpObj.sendmail(mail_user, to_addr+cc_addr, msgRoot.as_string())
</span>        <span class="org-builtin">print</span>(<span class="org-string">"&#37038;&#20214;&#21457;&#36865;&#25104;&#21151;"</span>)
    <span class="org-keyword">except</span> smtplib.SMTPException:
        <span class="org-builtin">print</span>(<span class="org-string">"Error: &#26080;&#27861;&#21457;&#36865;&#37038;&#20214;"</span>)


<span class="org-builtin">dict</span> <span class="org-operator">=</span> {<span class="org-string">'xy_hd1'</span>:[<span class="org-string">'emc.cici.net'</span>], \
        <span class="org-string">'xy_hd2'</span>:[<span class="org-string">'hd2-1.btrade.cici.com'</span>], \
        <span class="org-string">'zhiyunshan'</span>:[<span class="org-string">'hd2-1.zysmul.zizi.com'</span>,<span class="org-string">'hb2-1.zysmul.zizi.com'</span>]
        }

<span class="org-variable-name">f</span> <span class="org-operator">=</span> <span class="org-builtin">open</span>(<span class="org-string">'~/python/domain_info.txt'</span>, <span class="org-string">'w'</span>)

<span class="org-keyword">for</span> machine_room <span class="org-keyword">in</span> <span class="org-builtin">dict</span>.keys():
    <span class="org-keyword">for</span> domain <span class="org-keyword">in</span> <span class="org-builtin">dict</span>[machine_room]:
        <span class="org-builtin">print</span> <span class="org-string">"========%s"</span><span class="org-operator">%</span>domain
        <span class="org-variable-name">cmd</span> <span class="org-operator">=</span> <span class="org-string">"echo | openssl s_client -connect %s:443 2&gt;/dev/null | openssl x509 -noout -dates | awk -F= '{print $2}'|tail -n 1"</span> <span class="org-operator">%</span>domain
        <span class="org-variable-name">cer_time</span> <span class="org-operator">=</span> commands.getoutput(cmd)
        <span class="org-builtin">print</span> cer_time
        <span class="org-variable-name">cmd1</span> <span class="org-operator">=</span> <span class="org-string">"date -d '%s' +%%s"</span> <span class="org-operator">%</span>cer_time
        <span class="org-variable-name">end_time</span> <span class="org-operator">=</span> commands.getoutput(cmd1)
        <span class="org-builtin">print</span> end_time
        <span class="org-variable-name">now_time</span> <span class="org-operator">=</span> commands.getoutput(<span class="org-string">'date +%s'</span>)
        <span class="org-variable-name">time</span> <span class="org-operator">=</span> (<span class="org-builtin">int</span>(end_time) <span class="org-operator">-</span> <span class="org-builtin">int</span>(now_time))<span class="org-operator">/</span>24<span class="org-operator">/</span>3600
        <span class="org-builtin">print</span> <span class="org-string">"time = %s"</span><span class="org-operator">%</span>time
        <span class="org-variable-name">info</span> <span class="org-operator">=</span> <span class="org-string">"&#26426;&#25151;:%s &#22495;&#21517;:%s &#21097;&#20313;&#22825;&#25968;%s</span><span class="org-constant">\n</span><span class="org-string">"</span> <span class="org-operator">%</span>(machine_room,domain,time)
        f.write(info)
f.close()

<span class="org-variable-name">send_cmd</span> <span class="org-operator">=</span> <span class="org-string">"mail -s '&#22495;&#21517;&#35777;&#20070;&#26816;&#26597;&#25253;&#21578;' sa@cici.com &lt; domain_info.txt"</span>
<span class="org-variable-name">send_mail</span> <span class="org-operator">=</span> commands.getoutput(send_cmd)

<span class="org-variable-name">f1</span> <span class="org-operator">=</span> <span class="org-builtin">open</span>(<span class="org-string">"domain_info.txt"</span>,<span class="org-string">"r"</span>)
<span class="org-variable-name">content</span> <span class="org-operator">=</span> <span class="org-string">""</span>.join(f1.readlines())
f1.close()
<span class="org-variable-name">to_addr</span> <span class="org-operator">=</span> [<span class="org-string">'sa@zizi.cn'</span>]
<span class="org-variable-name">cc_addr</span> <span class="org-operator">=</span> [<span class="org-string">'sa@cici.com'</span>]
<span class="org-variable-name">subject</span> <span class="org-operator">=</span> <span class="org-string">'&#22495;&#21517;&#35777;&#20070;&#26816;&#26597;&#25253;&#21578;'</span>  <span class="org-comment-delimiter"># </span><span class="org-comment">&#20027;&#39064;
</span><span class="org-variable-name">is_html</span> <span class="org-operator">=</span> <span class="org-constant">False</span>
send_email(to_addr,cc_addr,subject,content)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9f941296-afee-4127-aa9a-39d9137bd8ff" class="outline-3">
<h3 id="h:9f941296-afee-4127-aa9a-39d9137bd8ff"><a href="#h:9f941296-afee-4127-aa9a-39d9137bd8ff">05-自动扫描自动监控</a></h3>
<div class="outline-text-3" id="text-h:9f941296-afee-4127-aa9a-39d9137bd8ff">
<p>
邮件
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">&#21019;&#24314;&#35777;&#20070;&#30446;&#24405;
</span>mkdir -p /root/.certs/
<span class="org-comment-delimiter"># </span><span class="org-comment">&#33719;&#21462;&#35777;&#20070;&#20869;&#23481;&#65288;&#21487;&#20998;&#24320;&#25191;&#34892;&#26597;&#30475;&#36807;&#31243;&#65289;
</span><span class="org-builtin">echo</span> -n | openssl s_client -connect smtp.exmail.qq.com:465 | sed -ne <span class="org-string">'/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p'</span> &gt; ~/.certs/qq.crt
<span class="org-comment-delimiter"># </span><span class="org-comment">&#28155;&#21152;&#19968;&#20010;&#35777;&#20070;&#21040;&#35777;&#20070;&#25968;&#25454;&#24211;&#20013;
</span>certutil -A -n <span class="org-string">"GeoTrust SSL CA"</span> -t <span class="org-string">"C,,"</span> -d ~/.certs -i ~/.certs/qq.crt 
certutil -A -n <span class="org-string">"GeoTrust Global CA"</span> -t <span class="org-string">"C,,"</span> -d ~/.certs -i ~/.certs/qq.crt 
<span class="org-comment-delimiter"># </span><span class="org-comment">&#21015;&#20986;&#30446;&#24405;&#19979;&#35777;&#20070;
</span>certutil -L -d /root/.certs
<span class="org-comment-delimiter"># </span><span class="org-comment">&#25351;&#26126;&#21463;&#26032;&#20154;&#35777;&#20070;&#12289;&#38450;&#25253;&#38169;
</span><span class="org-builtin">cd</span> /root/.certs/
certutil -A -n <span class="org-string">"GeoTrust SSL CA - G3"</span> -t <span class="org-string">"Pu,Pu,Pu"</span> -d ./ -i qq.crt

<span class="org-comment-delimiter"># </span><span class="org-comment">&#32534;&#36753;mail&#30340;&#37197;&#32622;&#25991;&#20214;
</span>cat &gt;&gt;/etc/mail.rc&lt;&lt; \EOF<span class="org-sh-heredoc">
set bsdcompat
set from=ops-alarm@cici.cn
set smtp=smtps://smtp.exmail.qq.com:465
set smtp-auth-user=ops-alarm@cici.cn
set smtp-auth-password='NHFNpVxQrshes'
set smtp-auth=login
set ssl-verify=ignore
set nss-config-dir=/root/.certs
EOF
</span>
<span class="org-builtin">echo</span> <span class="org-string">"aaa"</span> |mail -s <span class="org-string">"title"</span> -a  /etc/fstab xuchangwei@cici.cn
</pre>
</div>

<p>
依赖
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">&#23433;&#35013;py3
</span>yum -y install python36 python36-devel
python3.6 -m venv /opt/py3 
<span class="org-builtin">source</span> /opt/py3/bin/activate

cat &lt;&lt; EOF &gt;/data/ops/requirements.txt <span class="org-sh-heredoc">
requests == 2.24.0
aliyun-python-sdk-alidns == 2.6.18
aliyun-python-sdk-core  == 2.13.25
EOF
</span>
pip install -r /data/ops/requirements.txt
</pre>
</div>

<p>
配置文件
</p>
<div class="org-src-container">
<pre class="src src-sh">cat &lt;&lt;EOF &gt; /data/ops/qsdnskeyconfig.conf <span class="org-sh-heredoc">
# login aliyun rest api info
# slb type: nginx/none(dubbo)/slb
# if slb_type = slb which be need
[aliyun_u_p]
aki = LTAIF
aks = GRlA0T
domains = cici.com
#mail config
mail_host = 
mail_user = 
user = 'scans'
mail_pass = 
#config more mail, plsae use ',' split
to_addr=xuchangwei@cici.cn
cc_addr=xuchangwei@cici.cn
#dingdingconfig
dindin_token=14896a600456c3c661bcc69
EOF</span>
</pre>
</div>

<p>
执行文件
</p>
<div class="org-src-container">
<pre class="src src-sh">cat &lt;&lt;\EOF &gt;start_check_ssl.sh <span class="org-sh-heredoc">
#!/usr/bin/env bash
tokens="14896a600bcc69"
#--------------------
#dingding push
function dingding() {
local access_tokens=$1
local ding_url='https://oapi.dingtalk.com/robot/send'
local ding_header='Content-Type: application/json'
local msg=$2
for key in $access_tokens; do
curl -s -connect-timeout 40 -XPOST -H "$ding_header" "$ding_url?access_token=$key" \
-d '{"msgtype": "text",
    "text": {
        "content": "&#12304;k8s&#25253;&#35686;&#12305; \n'"$msg"'"
    },
"at": {
      "atMobiles": [],
      "isAtAll": true
  }
}'
done
}
/opt/py3/bin/python /data/ops/check_ssl.py
if [ `wc -l dns.log |awk '{print $1}'` -gt 0 ] ; then
    conect=`cat dns.log|sed '1d'|awk '{print $1}' | grep -v 'CNAME'|sort -t '|' -nr -k1,1`
    conect="${conect}\\n `cat dns.log|sed '1d'|awk '{print $1}' | grep  'CNAME'|sort -t '|' -nr -k1,1`"
    dingding "$tokens" "$(echo -e "&#22495;&#21517;&#35777;&#20070;&#23567;&#20110;28&#22825;&#26377;&#25928;&#26399;&#22914;&#19979;&#65306;\\n ${conect}")\\n"
    echo -e "&#22495;&#21517;&#35777;&#20070;&#23567;&#20110;28&#22825;&#26377;&#25928;&#26399;&#22914;&#19979;&#65306;\\n ${conect}"  |mail -s "&#35777;&#20070;&#26816;&#27979;" -a /data/ops/dns.log  system@cici.cn
fi 
EOF</span>
</pre>
</div>

<p>
脚本内容
</p>
<div class="org-src-container">
<pre class="src src-python">cat <span class="org-operator">&lt;&lt;</span>\EOF <span class="org-operator">&gt;</span> check_ssl.py 
<span class="org-comment-delimiter">#</span><span class="org-comment">coding=utf-8
</span><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/env python
</span><span class="org-comment-delimiter">#</span><span class="org-comment">&#22522;&#30784;&#20869;&#32622;&#27169;&#22359;
</span><span class="org-keyword">import</span> json
<span class="org-keyword">import</span> ssl
<span class="org-keyword">import</span> sys
<span class="org-keyword">import</span> configparser
<span class="org-keyword">import</span> telnetlib
<span class="org-keyword">import</span> time
<span class="org-keyword">import</span> datetime
<span class="org-keyword">import</span> os
<span class="org-keyword">import</span> math
<span class="org-keyword">import</span> requests
<span class="org-comment-delimiter">#</span><span class="org-comment">&#37038;&#31665;&#27169;&#22359;
</span><span class="org-keyword">from</span> email.mime.text <span class="org-keyword">import</span> MIMEText
<span class="org-keyword">from</span> email.utils <span class="org-keyword">import</span> formatdate
<span class="org-keyword">from</span> email.header <span class="org-keyword">import</span> Header
<span class="org-keyword">import</span> smtplib
<span class="org-keyword">from</span> email.mime.multipart <span class="org-keyword">import</span> MIMEMultipart
<span class="org-keyword">from</span> email.mime.base <span class="org-keyword">import</span> MIMEBase
<span class="org-comment-delimiter">#</span><span class="org-comment">&#23548;&#20837;&#38463;&#37324;&#27169;&#22359;
</span><span class="org-keyword">from</span> aliyunsdkcore.client <span class="org-keyword">import</span> AcsClient
<span class="org-keyword">from</span> aliyunsdkalidns.request.v20150109.DescribeDomainRecordsRequest <span class="org-keyword">import</span> DescribeDomainRecordsRequest
<span class="org-comment-delimiter">#</span><span class="org-comment">&#35774;&#32622;&#20840;&#23616;&#27599;&#27425;&#35831;&#27714;&#38463;&#37324;&#20113;&#19981;&#20351;&#29992;&#35777;&#20070;
</span>ssl.<span class="org-variable-name">_create_default_https_context</span> <span class="org-operator">=</span> ssl._create_unverified_context
<span class="org-doc">'''
&#37197;&#32622;&#25991;&#20214;&#20013;&#35835;&#21462;&#38463;&#37324;&#39564;&#35777;&#38656;&#35201;&#30340;key&#20449;&#24687;
'''</span>
<span class="org-keyword">class</span> <span class="org-type">ali_operation</span>():
    <span class="org-doc">'''
    &#37197;&#32622;&#25991;&#20214;&#20013;&#35835;&#21462;&#38463;&#37324;&#39564;&#35777;&#38656;&#35201;&#30340;key&#20449;&#24687;
    '''</span>
    <span class="org-keyword">def</span> <span class="org-function-name">dnsconfig</span>(<span class="org-keyword">self</span>):
        <span class="org-variable-name">cf</span> <span class="org-operator">=</span> configparser.ConfigParser()
        cf.read(<span class="org-string">"qsdnskeyconfig.conf"</span>)
        <span class="org-variable-name">secs</span> <span class="org-operator">=</span> cf.sections()
        <span class="org-comment-delimiter">#</span><span class="org-comment">print(secs)
</span>        <span class="org-keyword">if</span> secs.count(<span class="org-string">'aliyun_u_p'</span>) <span class="org-operator">!=</span> 1:
           sys.<span class="org-constant">exit</span>(<span class="org-string">' Error: need a aliyun_u_p config'</span>)
        <span class="org-variable-name">ali_auth</span><span class="org-operator">=</span>{<span class="org-string">'aki'</span>:cf.get(<span class="org-string">'aliyun_u_p'</span>,<span class="org-string">'aki'</span>),<span class="org-string">'aks'</span>:cf.get(<span class="org-string">'aliyun_u_p'</span>,<span class="org-string">'aks'</span>),
                  <span class="org-string">'domains'</span>:cf.get(<span class="org-string">'aliyun_u_p'</span>,<span class="org-string">'domains'</span>),
                  <span class="org-string">'mail_host'</span>:cf.get(<span class="org-string">'aliyun_u_p'</span>,<span class="org-string">'mail_host'</span>),
                  <span class="org-string">'mail_user'</span>:cf.get(<span class="org-string">'aliyun_u_p'</span>,<span class="org-string">'mail_user'</span>),
                  <span class="org-string">'user'</span>:cf.get(<span class="org-string">'aliyun_u_p'</span>,<span class="org-string">'user'</span>),
                  <span class="org-string">'mail_pass'</span>:cf.get(<span class="org-string">'aliyun_u_p'</span>,<span class="org-string">'mail_pass'</span>),
                  <span class="org-string">'to_addr'</span>:cf.get(<span class="org-string">'aliyun_u_p'</span>,<span class="org-string">'to_addr'</span>),
                  <span class="org-string">'cc_addr'</span>:cf.get(<span class="org-string">'aliyun_u_p'</span>,<span class="org-string">'cc_addr'</span>),
                  <span class="org-string">'dindin_token'</span>:cf.get(<span class="org-string">'aliyun_u_p'</span>,<span class="org-string">'dindin_token'</span>),
                  }
        <span class="org-keyword">return</span> ali_auth
    <span class="org-string">'''
    &#23545;&#38463;&#37324;&#25509;&#21475;&#21457;&#36215;&#35831;&#27714;
    '''</span>
    <span class="org-keyword">def</span> <span class="org-function-name">connect_retry</span>(<span class="org-keyword">self</span>,aki,aks,request, print_def):
        <span class="org-variable-name">client</span> <span class="org-operator">=</span>  AcsClient(aki,aks)
        <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(3):
            <span class="org-keyword">try</span>:
                <span class="org-variable-name">responese</span> <span class="org-operator">=</span> client.do_action_with_exception(request)
            <span class="org-keyword">except</span> <span class="org-type">Exception</span> <span class="org-keyword">as</span> e:
                <span class="org-builtin">print</span>(<span class="org-string">'--Error '</span> <span class="org-operator">+</span> print_def <span class="org-operator">+</span> <span class="org-string">' error, error info: </span><span class="org-constant">\n</span><span class="org-string">'</span><span class="org-operator">+</span><span class="org-string">' '</span><span class="org-operator">*</span>8<span class="org-operator">+</span><span class="org-string">'%s'</span><span class="org-operator">%</span>(e))
                <span class="org-keyword">if</span> i <span class="org-operator">==</span> 2:
                    <span class="org-keyword">return</span>(1)
                <span class="org-keyword">else</span>:
                    <span class="org-keyword">continue</span>
            <span class="org-keyword">return</span> responese
    <span class="org-comment-delimiter">#</span><span class="org-comment">&#22495;&#21517;&#26597;&#35810;&#25509;&#21475;&#21442;&#25968;&#37197;&#32622;
</span>    <span class="org-keyword">def</span> <span class="org-function-name">dns_query</span>(<span class="org-keyword">self</span>,domainname,pagenum):
        <span class="org-variable-name">request</span> <span class="org-operator">=</span> DescribeDomainRecordsRequest()
        <span class="org-comment-delimiter">#</span><span class="org-comment">request.set_action_name('DescribeDomainRecords')
</span>        request.set_DomainName(domainname)
        <span class="org-keyword">if</span> pagenum <span class="org-operator">&gt;=</span> 1:
           request.set_PageNumber(pagenum)
        <span class="org-keyword">return</span>  request
    <span class="org-comment-delimiter">#</span><span class="org-comment">&#20998;&#39029;&#33719;&#21462;&#20108;&#32423;&#22495;&#21517;
</span>    <span class="org-keyword">def</span>  <span class="org-function-name">dnslist</span>(<span class="org-keyword">self</span>,pagenum,domainnames):
        <span class="org-variable-name">ali_key</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.dnsconfig()
        <span class="org-keyword">if</span> pagenum <span class="org-operator">&gt;=</span> 1:
            <span class="org-variable-name">dnslists</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.dns_query(domainnames,pagenum<span class="org-operator">=</span>pagenum)
        <span class="org-keyword">else</span>:
            <span class="org-variable-name">dnslists</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.dns_query(domainnames,pagenum<span class="org-operator">=</span>0)

        <span class="org-variable-name">info</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.connect_retry(ali_key[<span class="org-string">'aki'</span>],ali_key[<span class="org-string">'aks'</span>],dnslists,<span class="org-string">'dns'</span>)
        <span class="org-keyword">return</span> info
    <span class="org-comment-delimiter">#</span><span class="org-comment">&#22495;&#21517;&#25968;&#25454;&#22788;&#29702;&#65292;&#40664;&#35748;&#26159;bite&#25968;&#25454;&#38656;&#35201;&#36716;&#25442;&#20026;unicode
</span>    <span class="org-keyword">def</span> <span class="org-function-name">dataprocess</span>(<span class="org-keyword">self</span>,pagenum,domainname):
        <span class="org-variable-name">dnsdata</span> <span class="org-operator">=</span> json.loads(<span class="org-keyword">self</span>.dnslist(pagenum,domainname).decode(<span class="org-string">'utf-8'</span>))
        <span class="org-keyword">return</span>  dnsdata
    <span class="org-comment-delimiter">#</span><span class="org-comment">&#22495;&#21517;&#20570;&#21028;&#26029;&#65292;&#36807;&#28388;&#35843;'@'&#21644;'*'&#30340;&#20108;&#32423;&#22495;&#21517;
</span>    <span class="org-keyword">def</span> <span class="org-function-name">dnsifprocess</span>(<span class="org-keyword">self</span>,dnsdata):
        <span class="org-variable-name">subdomainnames</span><span class="org-operator">=</span>[]
        <span class="org-keyword">for</span> i <span class="org-keyword">in</span> dnsdata[<span class="org-string">'DomainRecords'</span>][<span class="org-string">'Record'</span>]:
            <span class="org-keyword">if</span> i[<span class="org-string">'RR'</span>] <span class="org-operator">==</span> <span class="org-string">"@"</span>:
                <span class="org-keyword">continue</span>
                <span class="org-variable-name">subdomainname</span><span class="org-operator">=</span>i[<span class="org-string">'Value'</span>]<span class="org-operator">+</span><span class="org-string">'|'</span><span class="org-operator">+</span>i[<span class="org-string">'DomainName'</span>]<span class="org-operator">+</span><span class="org-string">'|'</span><span class="org-operator">+</span>i[<span class="org-string">'Type'</span>]
            <span class="org-keyword">elif</span> <span class="org-string">'*'</span> <span class="org-keyword">in</span> i[<span class="org-string">'RR'</span>]:
                <span class="org-keyword">continue</span>
            <span class="org-keyword">elif</span> <span class="org-string">'TXT'</span> <span class="org-keyword">in</span> i[<span class="org-string">'Type'</span>]:
                <span class="org-keyword">continue</span>
            <span class="org-keyword">else</span>:
                <span class="org-variable-name">subdomainname</span><span class="org-operator">=</span>i[<span class="org-string">'Value'</span>]<span class="org-operator">+</span><span class="org-string">'|'</span><span class="org-operator">+</span>i[<span class="org-string">'RR'</span>]<span class="org-operator">+</span><span class="org-string">'.'</span><span class="org-operator">+</span>i[<span class="org-string">'DomainName'</span>]<span class="org-operator">+</span><span class="org-string">'|'</span><span class="org-operator">+</span>i[<span class="org-string">'Type'</span>]
            subdomainnames.append(subdomainname)
        <span class="org-keyword">return</span>  subdomainnames
    <span class="org-comment-delimiter">#</span><span class="org-comment">&#27719;&#24635;&#25152;&#26377;&#20108;&#32423;&#22495;&#21517;
</span>    <span class="org-keyword">def</span> <span class="org-function-name">dnslists</span>(<span class="org-keyword">self</span>):
        <span class="org-variable-name">domains</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.dnsconfig()[<span class="org-string">'domains'</span>]
        <span class="org-variable-name">allsubdomainnames</span><span class="org-operator">=</span>[]
        <span class="org-keyword">for</span> domainname <span class="org-keyword">in</span> domains.split(<span class="org-string">','</span>):
            <span class="org-builtin">print</span>(domainname)
            <span class="org-variable-name">domainname</span> <span class="org-operator">=</span> domainname
            <span class="org-variable-name">pagenum</span><span class="org-operator">=</span>1
            <span class="org-variable-name">dnsdata</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.dataprocess(pagenum,domainname)
            <span class="org-variable-name">pagenum</span><span class="org-operator">=</span>math.ceil(dnsdata[<span class="org-string">'TotalCount'</span>]<span class="org-operator">/</span>dnsdata[<span class="org-string">'PageSize'</span>])
            <span class="org-keyword">if</span> pagenum <span class="org-operator">&gt;=</span> 1:
                <span class="org-keyword">for</span> c <span class="org-keyword">in</span> <span class="org-builtin">range</span>(pagenum):
                    <span class="org-variable-name">c</span> <span class="org-operator">+=</span> 1
                    <span class="org-variable-name">dnsdata</span> <span class="org-operator">=</span>  <span class="org-keyword">self</span>.dataprocess(c,domainname)
                    allsubdomainnames.append(<span class="org-keyword">self</span>.dnsifprocess(dnsdata))
        <span class="org-comment-delimiter">#</span><span class="org-comment">print(allsubdomainnames)
</span>        <span class="org-keyword">return</span>  allsubdomainnames

<span class="org-keyword">class</span> <span class="org-type">TelnetClient</span>():
    <span class="org-doc">'''
        telnet &#27169;&#22359;
    '''</span>
    <span class="org-keyword">def</span> <span class="org-function-name">__init__</span>(<span class="org-keyword">self</span>,):
        <span class="org-keyword">self</span>.<span class="org-variable-name">tn</span> <span class="org-operator">=</span> telnetlib.Telnet()

    <span class="org-comment-delimiter"># </span><span class="org-comment">&#27492;&#20989;&#25968;&#23454;&#29616;telnet&#30331;&#24405;&#20027;&#26426;
</span>    <span class="org-keyword">def</span> <span class="org-function-name">login_host</span>(<span class="org-keyword">self</span>,host_ip):
        <span class="org-keyword">try</span>:
            <span class="org-comment-delimiter"># </span><span class="org-comment">self.tn = telnetlib.Telnet(host_ip,port=23)
</span>            <span class="org-keyword">self</span>.tn.<span class="org-builtin">open</span>(host_ip,port<span class="org-operator">=</span>443,timeout<span class="org-operator">=</span>3)
            <span class="org-keyword">return</span> <span class="org-constant">True</span>
        <span class="org-keyword">except</span>:
            <span class="org-keyword">return</span> <span class="org-constant">False</span>
    <span class="org-keyword">def</span> <span class="org-function-name">logout_host</span>(<span class="org-keyword">self</span>):
        <span class="org-keyword">self</span>.tn.write(b<span class="org-string">"exit</span><span class="org-constant">\n</span><span class="org-string">"</span>)

<span class="org-keyword">class</span> <span class="org-type">https_certificate_verification</span>():

    <span class="org-doc">'''
    &#33719;&#21462;&#27599;&#20010;&#22495;&#21517;&#30340;&#35777;&#20070;&#26102;&#38388;
    '''</span>
    <span class="org-comment-delimiter">#</span><span class="org-comment">&#25191;&#34892;shell&#21629;&#20196;
</span>    <span class="org-keyword">def</span> <span class="org-function-name">commd</span>(<span class="org-keyword">self</span>,commnd):
        <span class="org-comment-delimiter">#</span><span class="org-comment">data=subprocess.Popen(commnd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT).stdout.readlines()
</span>        <span class="org-variable-name">data</span><span class="org-operator">=</span>os.popen(commnd).readlines()
        <span class="org-keyword">return</span> data
    <span class="org-comment-delimiter">#</span><span class="org-comment">&#19979;&#36733;&#35777;&#20070;&#65292;&#24182;&#19988;&#33719;&#21462;&#35777;&#20070;&#26102;&#38388;
</span>    <span class="org-keyword">def</span> <span class="org-function-name">https_download</span>(<span class="org-keyword">self</span>,domain):
        <span class="org-comment-delimiter"># </span><span class="org-comment">commd =  "echo | openssl s_client -connect %s:443 2&gt;/dev/null | openssl x509 -noout -dates | awk -F= '{print $2}'|tail -n 1" %domain
</span>        <span class="org-variable-name">commd</span> <span class="org-operator">=</span>  <span class="org-string">"curl -I -v -m 1  'https://%s/' 2&gt;&amp;1 |sed -nr 's@.*expire date: @@p'"</span> <span class="org-operator">%</span>domain
        <span class="org-keyword">return</span>  <span class="org-keyword">self</span>.commd(commd)
    <span class="org-comment-delimiter">#</span><span class="org-comment">&#23558;&#35777;&#20070;&#30340;GMT&#26102;&#38388;&#23383;&#31526;&#20018;&#36716;&#25442;&#20026;&#26102;&#38388;&#26684;&#24335;
</span>    <span class="org-keyword">def</span> <span class="org-function-name">string_toDatetime</span>(<span class="org-keyword">self</span>,st):
        <span class="org-keyword">return</span>  datetime.datetime.strptime(st, <span class="org-string">"%b %d  %H:%M:%S %Y GMT"</span>)
    <span class="org-comment-delimiter">#</span><span class="org-comment">&#33719;&#21462;&#35777;&#20070;&#26377;&#25928;&#26399;&#21097;&#20313;&#22825;&#25968;
</span>    <span class="org-keyword">def</span> <span class="org-function-name">https_ca_verification</span>(<span class="org-keyword">self</span>,domain):
        <span class="org-variable-name">dm</span><span class="org-operator">=</span>domain.split(<span class="org-string">'|'</span>)[1]
        <span class="org-variable-name">cur_time</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.https_download(dm)
        <span class="org-keyword">if</span> cur_time:
            <span class="org-variable-name">cur_time</span><span class="org-operator">=</span><span class="org-string">"%s"</span> <span class="org-operator">%</span> (cur_time[0].strip(<span class="org-string">'</span><span class="org-constant">\n</span><span class="org-string">'</span>))
            <span class="org-variable-name">cur_time</span><span class="org-operator">=</span><span class="org-keyword">self</span>.string_toDatetime(cur_time)
            <span class="org-variable-name">ca_time</span><span class="org-operator">=</span>time.mktime(cur_time.timetuple())
            <span class="org-variable-name">nowtime</span><span class="org-operator">=</span>time.time()
            <span class="org-variable-name">time1</span> <span class="org-operator">=</span> (<span class="org-builtin">int</span>(ca_time<span class="org-operator">+</span>28800) <span class="org-operator">-</span> <span class="org-builtin">int</span>(nowtime))<span class="org-operator">/</span>24<span class="org-operator">/</span>3600
            <span class="org-keyword">return</span> <span class="org-string">"%s,%s,%d"</span> <span class="org-operator">%</span> (domain,<span class="org-constant">True</span>,math.floor(time1))
        <span class="org-keyword">else</span>:
            <span class="org-keyword">return</span>  <span class="org-string">"%s,%s"</span> <span class="org-operator">%</span> (domain,<span class="org-constant">False</span>)
    <span class="org-comment-delimiter">#</span><span class="org-comment">&#22495;&#21517;&#25286;&#20998;
</span>    <span class="org-keyword">def</span> <span class="org-function-name">domanin_split</span>(<span class="org-keyword">self</span>,domain):
        <span class="org-variable-name">domain_split</span><span class="org-operator">=</span>domain.split(<span class="org-string">'.'</span>)
        <span class="org-keyword">if</span> <span class="org-builtin">len</span>(domain_split) <span class="org-operator">&gt;</span> 2:
            <span class="org-keyword">return</span> <span class="org-string">'.'</span>.join(domain_split[1:])
        <span class="org-keyword">else</span>:
            <span class="org-keyword">return</span> domain

    <span class="org-comment-delimiter">#</span><span class="org-comment">&#30830;&#35748;&#35777;&#20070;&#26159;&#21542;&#21644;&#22495;&#21517;&#30456;&#21305;&#37197;
</span>    <span class="org-keyword">def</span> <span class="org-function-name">ca_is_match</span>(<span class="org-keyword">self</span>,domain):
        <span class="org-variable-name">commd</span> <span class="org-operator">=</span> <span class="org-string">"echo | openssl s_client -connect  %s:443  2&gt;/dev/null | openssl x509 -noout   -text | grep -i 'DNS' | sed 's/[ ]*//g'"</span> <span class="org-operator">%</span> domain
        <span class="org-variable-name">ca_support_domain</span><span class="org-operator">=</span><span class="org-keyword">self</span>.commd(commd)
        <span class="org-variable-name">ca_support_domain</span> <span class="org-operator">=</span> ca_support_domain[0].replace(<span class="org-string">'DNS:'</span>,<span class="org-string">''</span>).replace(<span class="org-string">'*.'</span>,<span class="org-string">''</span>).strip(<span class="org-string">'</span><span class="org-constant">\n</span><span class="org-string">'</span>)
        <span class="org-variable-name">domain_split</span><span class="org-operator">=</span><span class="org-keyword">self</span>.domanin_split(domain)
        <span class="org-keyword">if</span> domain_split <span class="org-keyword">in</span> ca_support_domain.split(<span class="org-string">','</span>):
            <span class="org-keyword">return</span> <span class="org-constant">True</span>
        <span class="org-keyword">else</span>:
            <span class="org-keyword">return</span>  <span class="org-constant">False</span>


<span class="org-keyword">class</span> <span class="org-type">call</span>():
    <span class="org-keyword">def</span> <span class="org-function-name">__init__</span>(<span class="org-keyword">self</span>):
        <span class="org-keyword">self</span>.<span class="org-variable-name">confg</span> <span class="org-operator">=</span> ali_operation().dnsconfig()
    <span class="org-doc">'''
        &#36890;&#30693;&#27169;&#22359;&#12289;&#37038;&#31665;&#12289;&#38025;&#38025;
    '''</span>
    <span class="org-keyword">def</span> <span class="org-function-name">dindin</span>(<span class="org-keyword">self</span>,msg):
       <span class="org-doc">'''
        &#21482;&#26159;&#25226;&#38025;&#38025;&#30340;&#25509;&#21475;&#23553;&#35013;&#20102;&#19979;&#65292;&#30446;&#30340;&#22823;&#23478;&#21035;&#37325;&#22797;&#36896;&#36718;&#23376;
        url&#35831;&#27714;&#30340;&#27169;&#22359;&#26159;requests
        &#35843;&#29992;&#20989;&#25968;&#26041;&#24335; dindin(token=token,msg=msg)
        token&#26159;&#38025;&#38025;&#26426;&#22120;&#20154;&#30340;token
        msg&#26159;&#35201;&#25253;&#35686;&#30340;&#20869;&#23481;
        &#21442;&#32771;&#25991;&#26723;&#65306;
        https://open-doc.dingtalk.com/docs/doc.htm?spm=a219a.7629140.0.0.43964a97im55WS&amp;treeId=257&amp;articleId=105735&amp;docType=1
       '''</span>
       <span class="org-variable-name">token</span><span class="org-operator">=</span><span class="org-keyword">self</span>.confg[<span class="org-string">'dindin_token'</span>]
       <span class="org-variable-name">dindinapi</span> <span class="org-operator">=</span> <span class="org-string">'https://oapi.dingtalk.com/robot/send?access_token=%s'</span> <span class="org-operator">%</span> token <span class="org-comment-delimiter">#</span><span class="org-comment">token&#38025;&#38025;&#26426;&#22120;&#20154;&#35748;&#35777;&#30340;token
</span>       <span class="org-variable-name">headers</span> <span class="org-operator">=</span> {<span class="org-string">'content-type'</span>: <span class="org-string">'application/json'</span>,<span class="org-string">'charset'</span>:<span class="org-string">'utf-8'</span>} <span class="org-comment-delimiter">#</span><span class="org-comment">http&#22836;&#20869;&#23384;&#65292;&#38025;&#38025;&#24517;&#22635;&#39033;
</span>       <span class="org-variable-name">data</span>  <span class="org-operator">=</span> {
         <span class="org-string">"msgtype"</span>: <span class="org-string">"text"</span>,
         <span class="org-string">"text"</span>: {
             <span class="org-string">"content"</span>: msg
         },
         <span class="org-string">"at"</span>: {
             <span class="org-string">"atMobiles"</span>: [
             ],
             <span class="org-string">"isAtAll"</span>: <span class="org-constant">True</span>
         }
       }
       <span class="org-keyword">try</span>:
        <span class="org-variable-name">req</span><span class="org-operator">=</span>requests.post(dindinapi,json<span class="org-operator">=</span>data,headers<span class="org-operator">=</span>headers)
       <span class="org-keyword">except</span>:
           <span class="org-keyword">return</span>  0
    <span class="org-keyword">def</span> <span class="org-function-name">send_email</span>(<span class="org-keyword">self</span>,subject,content):
      <span class="org-variable-name">mail_host</span><span class="org-operator">=</span><span class="org-keyword">self</span>.confg[<span class="org-string">'mail_host'</span>]
      <span class="org-comment-delimiter">#</span><span class="org-comment">mail_host='smtp.yunzongnet.com'
</span>      <span class="org-variable-name">mail_user</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.confg[<span class="org-string">"mail_user"</span>]
      <span class="org-variable-name">user</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.confg[<span class="org-string">'user'</span>]
      <span class="org-variable-name">mail_pass</span> <span class="org-operator">=</span> <span class="org-keyword">self</span>.confg[<span class="org-string">"mail_pass"</span>]
      <span class="org-variable-name">to_addr</span><span class="org-operator">=</span><span class="org-keyword">self</span>.confg[<span class="org-string">'to_addr'</span>].split(<span class="org-string">','</span>)
      <span class="org-variable-name">cc_addr</span><span class="org-operator">=</span><span class="org-keyword">self</span>.confg[<span class="org-string">'cc_addr'</span>].split(<span class="org-string">','</span>)
      <span class="org-builtin">print</span> (to_addr,cc_addr)
      <span class="org-variable-name">msg</span> <span class="org-operator">=</span> MIMEMultipart()
      <span class="org-variable-name">msg</span>[<span class="org-string">'From'</span>] <span class="org-operator">=</span> mail_user
      <span class="org-variable-name">msg</span>[<span class="org-string">'To'</span>] <span class="org-operator">=</span> <span class="org-string">','</span>.join(to_addr)
      <span class="org-keyword">if</span> cc_addr:
        <span class="org-variable-name">msg</span>[<span class="org-string">'Cc'</span>] <span class="org-operator">=</span> <span class="org-string">','</span>.join(cc_addr)
      <span class="org-variable-name">msg</span>[<span class="org-string">'Subject'</span>] <span class="org-operator">=</span> subject
      msg.attach(MIMEText(content, <span class="org-string">'plain'</span>))
      <span class="org-variable-name">smtp</span> <span class="org-operator">=</span> smtplib.SMTP_SSL(mail_host, 994)
      smtp.ehlo()
      smtp.login(mail_user, mail_pass)
      smtp.sendmail(mail_user,to_addr<span class="org-operator">+</span>cc_addr,msg.as_string())

<span class="org-keyword">if</span> <span class="org-builtin">__name__</span> <span class="org-operator">==</span> <span class="org-string">'__main__'</span>:
    <span class="org-variable-name">cm</span><span class="org-operator">=</span><span class="org-string">'&gt;dns.log'</span>
    <span class="org-variable-name">i</span><span class="org-operator">=</span>os.popen(cm)
    <span class="org-variable-name">validlist</span><span class="org-operator">=</span>[]
    <span class="org-variable-name">normal_list</span><span class="org-operator">=</span>[]
    <span class="org-variable-name">d_err_list</span><span class="org-operator">=</span>[]
    <span class="org-variable-name">domainlist</span> <span class="org-operator">=</span> ali_operation().dnslists()
    <span class="org-keyword">for</span> i <span class="org-keyword">in</span> domainlist:
        <span class="org-keyword">for</span> j <span class="org-keyword">in</span> i:
            <span class="org-keyword">if</span> TelnetClient().login_host(j.split(<span class="org-string">'|'</span>)[1]):
                <span class="org-comment-delimiter">#</span><span class="org-comment">TelnetClient().logout_host()
</span>                <span class="org-variable-name">j</span><span class="org-operator">=</span><span class="org-string">'%s'</span> <span class="org-operator">%</span> j
                <span class="org-variable-name">f</span> <span class="org-operator">=</span> https_certificate_verification().https_ca_verification(j)
                <span class="org-keyword">if</span> <span class="org-string">"False"</span> <span class="org-keyword">in</span> f:
                    validlist.append(f)
                <span class="org-keyword">elif</span> <span class="org-string">"True"</span> <span class="org-keyword">in</span> f:
                    normal_list.append(f)
            <span class="org-keyword">else</span>:
                d_err_list.append(j)
                <span class="org-keyword">continue</span>
    <span class="org-variable-name">ca_normalmsg</span><span class="org-operator">=</span><span class="org-string">''</span>
    <span class="org-variable-name">ca_warmsg</span><span class="org-operator">=</span><span class="org-string">''</span>
    <span class="org-variable-name">ca_crimsg</span><span class="org-operator">=</span><span class="org-string">''</span>
    <span class="org-variable-name">no_camsg</span><span class="org-operator">=</span><span class="org-string">''</span>
    <span class="org-variable-name">not_is_match_ca</span><span class="org-operator">=</span><span class="org-string">''</span>
    <span class="org-keyword">for</span> i <span class="org-keyword">in</span> normal_list:
        <span class="org-keyword">if</span> i:
            <span class="org-variable-name">domain</span><span class="org-operator">=</span>i.split(<span class="org-string">','</span>)[0]
            <span class="org-variable-name">ca_time</span><span class="org-operator">=</span><span class="org-builtin">int</span>(i.split(<span class="org-string">','</span>)[2])
            <span class="org-comment-delimiter"># </span><span class="org-comment">if https_certificate_verification().ca_is_match(domain):
</span>            <span class="org-comment-delimiter">#     </span><span class="org-comment">pass
</span>            <span class="org-comment-delimiter"># </span><span class="org-comment">else:
</span>            <span class="org-comment-delimiter">#    </span><span class="org-comment">not_is_match_ca += '%s' % domain +'\n'
</span>            <span class="org-keyword">if</span> ca_time <span class="org-operator">&gt;</span> 29:
                <span class="org-variable-name">ca_normalmsg</span><span class="org-operator">+=</span><span class="org-string">'%s %d &#22825;'</span> <span class="org-operator">%</span> (domain,ca_time) <span class="org-operator">+</span><span class="org-string">'</span><span class="org-constant">\n</span><span class="org-string">'</span>
            <span class="org-keyword">elif</span> ca_time <span class="org-operator">&lt;=</span> 28 <span class="org-keyword">and</span> ca_time<span class="org-operator">&gt;=</span>1 :
                <span class="org-variable-name">ca_warmsg</span><span class="org-operator">+=</span><span class="org-string">'%s %d &#22825;'</span> <span class="org-operator">%</span> (domain,ca_time) <span class="org-operator">+</span><span class="org-string">'</span><span class="org-constant">\n</span><span class="org-string">'</span>
            <span class="org-keyword">elif</span> ca_time <span class="org-operator">&lt;</span> 1 :
                <span class="org-variable-name">ca_crimsg</span><span class="org-operator">+=</span><span class="org-string">'%s %d &#22825;'</span> <span class="org-operator">%</span> (domain,ca_time) <span class="org-operator">+</span><span class="org-string">'</span><span class="org-constant">\n</span><span class="org-string">'</span>
    <span class="org-keyword">if</span> validlist:
        <span class="org-keyword">for</span> i <span class="org-keyword">in</span> validlist:
            <span class="org-variable-name">no_camsg</span><span class="org-operator">+=</span><span class="org-string">'%s'</span> <span class="org-operator">%</span> i.split(<span class="org-string">','</span>)[0] <span class="org-operator">+</span><span class="org-string">'</span><span class="org-constant">\n</span><span class="org-string">'</span>
        <span class="org-variable-name">no_camsg</span><span class="org-operator">=</span><span class="org-string">'&#26410;&#33719;&#21462;&#21040;&#35777;&#20070;&#22495;&#21517;&#22914;&#19979;&#65306;'</span><span class="org-operator">+</span><span class="org-string">'</span><span class="org-constant">\n</span><span class="org-string">'</span><span class="org-operator">+</span><span class="org-string">'%s'</span>  <span class="org-operator">%</span>  no_camsg
        <span class="org-comment-delimiter">#</span><span class="org-comment">call().dindin(no_camsg)
</span>    <span class="org-keyword">if</span> ca_normalmsg:
        <span class="org-variable-name">ca_normalmsg</span><span class="org-operator">=</span><span class="org-string">'&#22495;&#21517;&#35777;&#20070;&#27491;&#24120;&#26377;&#25928;&#26399;&#22914;&#19979;&#65306;'</span><span class="org-operator">+</span><span class="org-string">'</span><span class="org-constant">\n</span><span class="org-string">'</span><span class="org-operator">+</span><span class="org-string">'%s'</span><span class="org-operator">%</span>  ca_normalmsg
        <span class="org-comment-delimiter">#</span><span class="org-comment">call().dindin(ca_normalmsg)
</span>        <span class="org-comment-delimiter"># </span><span class="org-comment">call().send_email('&#22495;&#21517;&#35777;&#20070;&#26377;&#25928;&#26399;&#25253;&#35686;',ca_normalmsg)
</span>    <span class="org-keyword">if</span> ca_warmsg:
        <span class="org-variable-name">ca_warmsg</span><span class="org-operator">=</span><span class="org-string">'&#22495;&#21517;&#35777;&#20070;&#23567;&#20110;28&#22825;&#26377;&#25928;&#26399;&#22914;&#19979;&#65306;'</span><span class="org-operator">+</span><span class="org-string">'</span><span class="org-constant">\n</span><span class="org-string">'</span><span class="org-operator">+</span><span class="org-string">'%s'</span>  <span class="org-operator">%</span>  ca_warmsg
        <span class="org-comment-delimiter">#</span><span class="org-comment">call().dindin(ca_warmsg)
</span>        <span class="org-keyword">with</span> <span class="org-builtin">open</span>(<span class="org-string">'dns.log'</span>, mode<span class="org-operator">=</span><span class="org-string">'w+'</span>,encoding<span class="org-operator">=</span><span class="org-string">'utf-8'</span>) <span class="org-keyword">as</span> f:
            f.seek(0)
            f.writelines(ca_warmsg)
        <span class="org-comment-delimiter"># </span><span class="org-comment">call().send_email('&#35777;&#20070;&#23567;&#20110;28&#22825;&#26377;&#25928;&#26399;&#22495;&#21517;',ca_normalmsg)
</span>    <span class="org-keyword">if</span> ca_crimsg:
        <span class="org-variable-name">ca_crimsg</span><span class="org-operator">=</span><span class="org-string">'&#35777;&#20070;&#24050;&#36807;&#26399;&#22495;&#21517;&#22914;&#19979;&#65306;'</span><span class="org-operator">+</span><span class="org-string">'</span><span class="org-constant">\n</span><span class="org-string">'</span><span class="org-operator">+</span><span class="org-string">'%s'</span> <span class="org-operator">%</span>  ca_crimsg
        <span class="org-comment-delimiter">#</span><span class="org-comment">call().dindin(ca_crimsg)
</span>        <span class="org-comment-delimiter"># </span><span class="org-comment">call().send_email('&#35777;&#20070;&#24050;&#36807;&#26399;&#22495;&#21517;',ca_normalmsg)
</span>EOF
</pre>
</div>
</div>
</div>
<div id="outline-container-h:afaeb348-a3db-49f3-835d-1ca1fb74d4b0" class="outline-3">
<h3 id="h:afaeb348-a3db-49f3-835d-1ca1fb74d4b0"><a href="#h:afaeb348-a3db-49f3-835d-1ca1fb74d4b0">06-云厂商产品证书自动更新</a></h3>
<div class="outline-text-3" id="text-h:afaeb348-a3db-49f3-835d-1ca1fb74d4b0">
<p>
<b>SLB证书自动更新</b>
</p>

<p>
环境 python3  pip包
</p>
<div class="org-src-container">
<pre class="src src-sh">cat &gt;request.txt&lt;&lt;EOF<span class="org-sh-heredoc">
aliyun-python-sdk-core-v3==2.13.11
aliyun-python-sdk-slb==3.2.16
requests==2.22.0
EOF
</span>pip install -r request.txt
</pre>
</div>


<p>
计划任务
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">update xiaoqian ssl
</span>0 0 * * * /root/.pyenv/versions/py367/bin/python  /home/scripts/py/xiaoqian-slb.py &amp;&gt;/dev/null
</pre>
</div>


<p>
脚本内容
</p>
<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/env python
</span><span class="org-comment-delimiter">#</span><span class="org-comment">coding=utf-8
</span><span class="org-keyword">import</span> json
<span class="org-keyword">import</span> requests
<span class="org-keyword">import</span> datetime
<span class="org-keyword">import</span> subprocess
<span class="org-keyword">import</span> sys
<span class="org-keyword">from</span> aliyunsdkcore.client <span class="org-keyword">import</span> AcsClient
<span class="org-keyword">from</span> aliyunsdkcore.acs_exception.exceptions <span class="org-keyword">import</span> ClientException
<span class="org-keyword">from</span> aliyunsdkcore.acs_exception.exceptions <span class="org-keyword">import</span> ServerException
<span class="org-keyword">from</span> aliyunsdkslb.request.v20140515.UploadServerCertificateRequest <span class="org-keyword">import</span> UploadServerCertificateRequest
<span class="org-keyword">from</span> aliyunsdkslb.request.v20140515.SetLoadBalancerHTTPSListenerAttributeRequest <span class="org-keyword">import</span> SetLoadBalancerHTTPSListenerAttributeRequest
<span class="org-keyword">from</span> aliyunsdkslb.request.v20140515.DescribeLoadBalancerHTTPSListenerAttributeRequest <span class="org-keyword">import</span> DescribeLoadBalancerHTTPSListenerAttributeRequest
<span class="org-keyword">from</span> aliyunsdkslb.request.v20140515.DeleteServerCertificateRequest <span class="org-keyword">import</span> DeleteServerCertificateRequest

<span class="org-string">'''Judge the validity of the certificate'''</span>
<span class="org-keyword">def</span> <span class="org-function-name">CheckDomain</span>(domain):
    <span class="org-variable-name">cmd</span> <span class="org-operator">=</span> <span class="org-string">"echo | openssl s_client -connect %s:443 2&gt;/dev/null | openssl x509 -noout -dates | awk -F= '{print $2}'|tail -n 1"</span> <span class="org-operator">%</span>domain
    <span class="org-variable-name">cer_time</span> <span class="org-operator">=</span> subprocess.getoutput(cmd)
    <span class="org-variable-name">cmd1</span> <span class="org-operator">=</span> <span class="org-string">"date -d '%s' +%%s"</span> <span class="org-operator">%</span>cer_time
    <span class="org-variable-name">end_time</span>, <span class="org-variable-name">now_time</span> <span class="org-operator">=</span> subprocess.getoutput(cmd1), subprocess.getoutput(<span class="org-string">'date +%s'</span>)
    <span class="org-variable-name">time</span> <span class="org-operator">=</span> <span class="org-builtin">int</span>((<span class="org-builtin">int</span>(end_time) <span class="org-operator">-</span> <span class="org-builtin">int</span>(now_time))<span class="org-operator">/</span>24<span class="org-operator">/</span>3600)
    <span class="org-variable-name">info</span> <span class="org-operator">=</span> <span class="org-string">"&#26426;&#25151;:%s &#22495;&#21517;:%s &#21097;&#20313;&#22825;&#25968;%s</span><span class="org-constant">\n</span><span class="org-string">"</span> <span class="org-operator">%</span>(<span class="org-string">'&#31038;&#39184;&#21326;&#19996;1'</span>,domain,time)
    <span class="org-builtin">print</span>(info)
    <span class="org-keyword">return</span> time

<span class="org-keyword">def</span> <span class="org-function-name">GetNewCertInfo</span>(domain):
    <span class="org-variable-name">cmd</span> <span class="org-operator">=</span>r<span class="org-string">'''
    cat &gt;tmp.sh &lt;&lt;\EOF
#!/usr/bin/env bash
export LANG=en_US.UTF8
[ -z "$(which rsync)" ] &amp;&amp; yum install -y rsync
[ -z "$(which jq)" ] &amp;&amp; wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo &amp;&amp; yum install -y jq
export RSYNC_PASSWORD=wowonetwork
tmpfile=$(mktemp -u zhengshu.XXXX)
tmp_path=/tmp/.${tmpfile}
now_seconds=$(date '+%s')
ssl_pem=fullchain.cer

domain=$1
[ -z "$domain" ] &amp;&amp; echo "err, please: .sh domain" &amp;&amp; exit 1
[ ! -e  $tmp_path ] &amp;&amp; mkdir -p $tmp_path
rsync -r sa@124.127.109.95::zhengshu/$domain/ $tmp_path/$domain
cert_info=$(cat $tmp_path/$domain/${ssl_pem}|grep -vE '^$'|sed ':a;N;$!ba;s/\n/\\n/g')
key_info=$(cat $tmp_path/$domain/${domain}.key|grep -vE '^$'|sed ':a;N;$!ba;s/\n/\\n/g')

end_date=$(openssl x509 -noout -dates -in $tmp_path/$domain/${ssl_pem} | sed -n 's@notAfter=@@p')
last_time=$((($(date '+%s' --date "$end_date") - $now_seconds)/24/3600))
rm -fr $tmp_path
[ $last_time -lt 30 ] &amp;&amp; echo "" &amp;&amp; exit 0
echo  '{"cert_info":"'$cert_info'","key_info":"'$key_info'"}'
EOF
    '''</span>
    subprocess.getoutput(cmd)
    <span class="org-variable-name">cmd1</span><span class="org-operator">=</span>r<span class="org-string">'bash tmp.sh %s|jq .cert_info'</span> <span class="org-operator">%</span>(domain)
    <span class="org-variable-name">cmd2</span><span class="org-operator">=</span>r<span class="org-string">'bash tmp.sh %s|jq .key_info &amp;&amp; rm -f tmp.sh'</span> <span class="org-operator">%</span>(domain)
    <span class="org-variable-name">cert_info</span>, <span class="org-variable-name">key_info</span> <span class="org-operator">=</span>subprocess.getoutput(cmd1), subprocess.getoutput(cmd2)
    <span class="org-keyword">return</span> {<span class="org-string">"cert_info"</span>:cert_info, <span class="org-string">"key_info"</span>:key_info}

<span class="org-string">'''upload a new certificate'''</span> 
<span class="org-keyword">def</span> <span class="org-function-name">UpLoadCert</span>(cert_info,key_info,now<span class="org-operator">=</span><span class="org-constant">None</span>):
    <span class="org-variable-name">request</span> <span class="org-operator">=</span> UploadServerCertificateRequest()
    request.set_accept_format(<span class="org-string">'json'</span>)
    request.set_ServerCertificate(cert_info)
    request.set_PrivateKey(key_info)
    request.set_ServerCertificateName(<span class="org-string">"xq"</span><span class="org-operator">+</span>now)

    <span class="org-variable-name">response</span> <span class="org-operator">=</span> client.do_action_with_exception(request)
    <span class="org-builtin">print</span>(<span class="org-builtin">str</span>(response, encoding<span class="org-operator">=</span><span class="org-string">'utf-8'</span>))
    <span class="org-keyword">return</span> <span class="org-builtin">str</span>(response, encoding<span class="org-operator">=</span><span class="org-string">'utf-8'</span>)

<span class="org-string">'''delete  certificate'''</span>
<span class="org-keyword">def</span> <span class="org-function-name">DelCert</span>(<span class="org-builtin">id</span>):
    <span class="org-variable-name">request</span> <span class="org-operator">=</span> DeleteServerCertificateRequest()
    request.set_accept_format(<span class="org-string">'json'</span>)
    <span class="org-builtin">print</span>(<span class="org-builtin">id</span>)
    request.set_ServerCertificateId(<span class="org-builtin">id</span>)

    <span class="org-variable-name">response</span> <span class="org-operator">=</span> client.do_action_with_exception(request)
    <span class="org-builtin">print</span>(<span class="org-builtin">str</span>(response, encoding<span class="org-operator">=</span><span class="org-string">'utf-8'</span>))
    <span class="org-keyword">return</span> <span class="org-builtin">str</span>(response, encoding<span class="org-operator">=</span><span class="org-string">'utf-8'</span>)

<span class="org-string">'''get an old certificate id'''</span>
<span class="org-keyword">def</span> <span class="org-function-name">DesSlbhttps</span>(slb_id):
    <span class="org-variable-name">request</span> <span class="org-operator">=</span> DescribeLoadBalancerHTTPSListenerAttributeRequest()
    request.set_accept_format(<span class="org-string">'json'</span>)

    request.set_ListenerPort(443)
    request.set_LoadBalancerId(slb_id)

    <span class="org-variable-name">response</span> <span class="org-operator">=</span> client.do_action_with_exception(request)
    <span class="org-builtin">print</span>(<span class="org-builtin">str</span>(response, encoding<span class="org-operator">=</span><span class="org-string">'utf-8'</span>))
    <span class="org-keyword">return</span> <span class="org-builtin">str</span>(response, encoding<span class="org-operator">=</span><span class="org-string">'utf-8'</span>)

<span class="org-string">'''replace slb certificate'''</span>
<span class="org-keyword">def</span> <span class="org-function-name">SetSlbHttps</span>(slb_id,cert_id):
    <span class="org-variable-name">request</span> <span class="org-operator">=</span> SetLoadBalancerHTTPSListenerAttributeRequest()
    request.set_accept_format(<span class="org-string">'json'</span>)

    request.set_ListenerPort(443)
    request.set_LoadBalancerId(slb_id)
    request.set_ServerCertificateId(cert_id)

    <span class="org-variable-name">response</span> <span class="org-operator">=</span> client.do_action_with_exception(request)
    <span class="org-builtin">print</span>(<span class="org-builtin">str</span>(response, encoding<span class="org-operator">=</span><span class="org-string">'utf-8'</span>))
    <span class="org-keyword">return</span> <span class="org-builtin">str</span>(response, encoding<span class="org-operator">=</span><span class="org-string">'utf-8'</span>)

<span class="org-string">'''get aliyun RAM key'''</span>
<span class="org-keyword">def</span> <span class="org-function-name">GetAliRamKey</span>():
    <span class="org-variable-name">sw_url</span> <span class="org-operator">=</span> <span class="org-string">"http://10.200.41.37:10435/api/v1/sw_decode_passwd"</span>
    <span class="org-variable-name">headers</span> <span class="org-operator">=</span> {<span class="org-string">'content-type'</span>: <span class="org-string">'application/json'</span>}
    <span class="org-variable-name">data</span> <span class="org-operator">=</span> {<span class="org-string">"pass_key"</span>:<span class="org-string">"bbf79631a4de0836c1b2b97887359a50"</span>}
    <span class="org-variable-name">parameters</span> <span class="org-operator">=</span> {<span class="org-string">"url"</span>: sw_url,<span class="org-string">"headers"</span>: headers,<span class="org-string">"timeout"</span>:10,<span class="org-string">"data"</span>: json.dumps(data)}
    <span class="org-variable-name">res_discache</span> <span class="org-operator">=</span> requests.post(<span class="org-operator">**</span>parameters)
    <span class="org-variable-name">res_discache</span> <span class="org-operator">=</span> json.loads(res_discache.text)
    <span class="org-keyword">return</span> res_discache[<span class="org-string">"username"</span>], res_discache[<span class="org-string">"passwd"</span>],

<span class="org-string">'''push dingding'''</span>
<span class="org-keyword">def</span> <span class="org-function-name">dingding</span>(token,msg):
    <span class="org-keyword">try</span>:
        <span class="org-variable-name">dindinapi</span> <span class="org-operator">=</span> <span class="org-string">'https://oapi.dingtalk.com/robot/send?access_token=%s'</span> <span class="org-operator">%</span> token
        <span class="org-variable-name">headers</span> <span class="org-operator">=</span> {<span class="org-string">'content-type'</span>: <span class="org-string">'application/json'</span>,<span class="org-string">'charset'</span>:<span class="org-string">'utf-8'</span>}
        <span class="org-variable-name">data</span>  <span class="org-operator">=</span> {
         <span class="org-string">"msgtype"</span>: <span class="org-string">"text"</span>,
         <span class="org-string">"text"</span>: {
         <span class="org-string">"content"</span>: msg
         },
         <span class="org-string">"at"</span>: {
         <span class="org-string">"atMobiles"</span>: [
         ],
         <span class="org-string">"isAtAll"</span>: <span class="org-constant">True</span>
         }
        }
        <span class="org-variable-name">req</span><span class="org-operator">=</span>requests.post(dindinapi,json<span class="org-operator">=</span>data,headers<span class="org-operator">=</span>headers)
    <span class="org-keyword">except</span> <span class="org-type">Exception</span> <span class="org-keyword">as</span> e:
        <span class="org-builtin">print</span>(<span class="org-builtin">str</span>(e))

<span class="org-keyword">if</span> <span class="org-builtin">__name__</span> <span class="org-operator">==</span> <span class="org-string">'__main__'</span>:
    <span class="org-variable-name">now</span> <span class="org-operator">=</span> datetime.datetime.now().strftime(<span class="org-string">"%Y%m%d-%H%M%S"</span>)
    <span class="org-variable-name">username</span>,<span class="org-variable-name">passwd</span> <span class="org-operator">=</span> GetAliRamKey()
    <span class="org-variable-name">client</span> <span class="org-operator">=</span> AcsClient(username, passwd, <span class="org-string">'cn-hangzhou'</span>)
    <span class="org-variable-name">slb_id</span> <span class="org-operator">=</span><span class="org-string">'lb-bp10x2hqas6pv5cfliiab'</span>
    <span class="org-variable-name">domain</span> <span class="org-operator">=</span><span class="org-string">'xqapic.zizi.com'</span>
    <span class="org-variable-name">domain1</span> <span class="org-operator">=</span> <span class="org-string">'cici..com'</span>
    <span class="org-variable-name">token</span> <span class="org-operator">=</span> <span class="org-string">'a6184389010ffc418aa13057c'</span>

    <span class="org-comment-delimiter">#</span><span class="org-comment">1. Judge the validity of the certificate, 27day remaining
</span>    <span class="org-variable-name">days</span><span class="org-operator">=</span>CheckDomain(domain)
    <span class="org-keyword">if</span> days <span class="org-operator">&lt;</span> 28:
        <span class="org-builtin">print</span>(<span class="org-string">"the certificate will be expired, continue..."</span>)
    <span class="org-keyword">else</span>:
        <span class="org-keyword">try</span>:  
            sys.<span class="org-constant">exit</span>(0)  
        <span class="org-keyword">except</span>:  
            <span class="org-builtin">print</span>(<span class="org-string">'the certificate is not expired'</span>) 
            sys.<span class="org-constant">exit</span>(0)
    
    <span class="org-comment-delimiter">#</span><span class="org-comment">2. upload a new certificate
</span>    <span class="org-comment-delimiter">#</span><span class="org-comment">2.1 get a new certificate
</span>    <span class="org-comment-delimiter"># </span><span class="org-comment">cert_info,key_info = GetNewCertInfo(domain1)
</span>    <span class="org-comment-delimiter"># </span><span class="org-comment">&#27492;&#22788;&#20026;&#20102;&#35299;&#20915;&#23383;&#31526;&#20018;&#21152;r&#38382;&#39064;&#12290;&#22914;r"a\n" &#21464;&#25104;"a\n"&#65292;&#20351;&#29992;"%s"%r"a\n".replace('\\n',"\n")
</span>    <span class="org-variable-name">cert_info</span> <span class="org-operator">=</span> <span class="org-string">"%s"</span><span class="org-operator">%</span> GetNewCertInfo(domain1)[<span class="org-string">"cert_info"</span>].replace(<span class="org-string">'</span><span class="org-constant">\\</span><span class="org-string">n'</span>,<span class="org-string">"</span><span class="org-constant">\n</span><span class="org-string">"</span>).replace(<span class="org-string">'"'</span>,<span class="org-string">""</span>)
    <span class="org-variable-name">key_info</span> <span class="org-operator">=</span>  <span class="org-string">"%s"</span><span class="org-operator">%</span> GetNewCertInfo(domain1)[<span class="org-string">"key_info"</span>].replace(<span class="org-string">'</span><span class="org-constant">\\</span><span class="org-string">n'</span>,<span class="org-string">"</span><span class="org-constant">\n</span><span class="org-string">"</span>).replace(<span class="org-string">'"'</span>,<span class="org-string">""</span>)
    <span class="org-builtin">print</span>(cert_info)
    <span class="org-builtin">print</span>(key_info)
    <span class="org-comment-delimiter"># </span><span class="org-comment">cert_info_origin="&lt;CERTIFICATE&gt;" 
</span>    <span class="org-comment-delimiter"># </span><span class="org-comment">key_info_origin="&lt;PRIVATE KEY&gt;"
</span>
    <span class="org-comment-delimiter">#</span><span class="org-comment">2.2 upload a new certificate
</span>    <span class="org-variable-name">upload_cert_info</span><span class="org-operator">=</span>json.loads(UpLoadCert(cert_info,key_info,now))
    <span class="org-variable-name">cert_name</span>,<span class="org-variable-name">cert_id</span><span class="org-operator">=</span>upload_cert_info[<span class="org-string">'ServerCertificateName'</span>],upload_cert_info[<span class="org-string">'ServerCertificateId'</span>]
    <span class="org-comment-delimiter">#</span><span class="org-comment">print(cert_name,cert_id)
</span>
    <span class="org-comment-delimiter">#</span><span class="org-comment">3. replace slb certificate
</span>    <span class="org-comment-delimiter">#</span><span class="org-comment">3.1 get an old certificate id
</span>    <span class="org-variable-name">old_cert_id</span><span class="org-operator">=</span>json.loads(DesSlbhttps(slb_id))[<span class="org-string">'ServerCertificateId'</span>]
    <span class="org-comment-delimiter"># </span><span class="org-comment">print(old_cert_id)
</span>    <span class="org-comment-delimiter">#</span><span class="org-comment">3.2 replace slb certificate
</span>    SetSlbHttps(slb_id,cert_id)
    <span class="org-comment-delimiter">#</span><span class="org-comment">3.3 delete old certificate
</span>    DelCert(old_cert_id)

    <span class="org-comment-delimiter">#</span><span class="org-comment">4. dingding
</span>    <span class="org-variable-name">newdays</span><span class="org-operator">=</span>CheckDomain(domain)
    <span class="org-variable-name">msg</span> <span class="org-operator">=</span> <span class="org-string">'&#35777;&#20070;&#26356;&#26032;&#36890;&#30693;:</span><span class="org-constant">\n</span><span class="org-string">&#26426;&#25151;&#65306;%s, &#23567;&#21315;SLB: %s &#22495;&#21517;&#65306;%s,  &#26032;&#35777;&#20070;&#26377;&#25928;&#26399;&#65306;%s&#22825;, &#35777;&#20070;&#21517;:%s'</span> <span class="org-operator">%</span> (<span class="org-string">'1'</span>,slb_id, domain, newdays, cert_name)
    <span class="org-builtin">print</span>(msg)
    dingding(token,msg)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:144c1f4d-b0d5-4543-a875-9fce4ee32c42" class="outline-3">
<h3 id="h:144c1f4d-b0d5-4543-a875-9fce4ee32c42"><a href="#h:144c1f4d-b0d5-4543-a875-9fce4ee32c42">07-检查-nginx有哪些443域名</a></h3>
<div class="outline-text-3" id="text-h:144c1f4d-b0d5-4543-a875-9fce4ee32c42">
<p>
需求：
统计所有证书情况，区分域名不在116.213.103段的证书。
</p>

<p>
统计结果格式：配置文件位置，域名，证书名
</p>

<div class="org-src-container">
<pre class="src src-sh">cat  &gt;check_ssl.sh &lt;&lt; \EOF<span class="org-sh-heredoc">
#!/bin/bash
ng_p=$(ps -ef|grep nginx|grep master |awk '{print $2}')
[  -z "$ng_p" ] &amp;&amp; exit 1
ng_dir=$(ls -l /proc/${ng_p}/exe| awk '{print $11}' | awk -F'/sbin/nginx' '{print $1}')
#/usr/local/nginx/sbin/nginx -V 2&gt;&amp;1 |sed -rn '/conf-path/s@.*conf-path=([[:graph:]]{1,}).*@\1@gp'
#&#22914;&#26524;&#27809;&#26377;&#65292;&#21017;&#32534;&#35793;&#29992;&#25163;&#40664;&#35748;--prefix&#30446;&#24405;&#19979;&#30340;conf
ng_main_conf=$(echo ${ng_dir}/conf/nginx.conf)
ng_main_path=$(echo ${ng_main_conf%/nginx.conf*})
ng_conf=$(grep '^[^#][[:space:]\t]\+include' ${ng_main_conf}|grep -v mime.types|awk -F'[\t ;]+' '{print $3}')
ng_conf_dir=$(echo ${ng_conf%/*})

cd ${ng_main_path}/${ng_conf_dir}
for f in *.conf; do
        if grep -A 11 '[^#]listen.*443' $f &amp;&gt;/dev/null; then
        for server_name in $(grep -A 11 -w '[^#]listen.*443' $f  | grep -EA 11 '^[^#][[:space:]\t]+listen.*443' | grep -E '^[^#][[:space:]\t]+server_name' | awk -F'server_name[ ]+' '{print $2}' |awk -F';' '{print $1}'); do
                #server_name=$(grep -A 4 '[^#]listen.*443' $f | grep -E 'server_name' | awk -F'[ ;]+' '{print $3}')
                pc_ip=$(ping  -c1 -W 1 $server_name | grep -o '\([0-9]\{1,3\}\.\)\{3\}' 2&gt;/dev/null)

                if [ "210.14.157." == "$pc_ip" ]; then
                    key=$(grep -A 11 '^[^#][[:space:]\t]\+listen.*443' $f|grep -A 11 -E '^[^#][[:space:]\t]+server_name'| grep -A 9   -E "${server_name}" | grep -E "^[^#][[:space:]\t]+ssl_certificate_key"| awk -F'[ ;]+' /ssl/'{print "key="$(NF-1)}')
                    echo  "HLGconf=$f,server_name=${server_name},$key"
                else
                    key=$(grep -A 11 '^[^#][[:space:]\t]\+listen.*443' $f| grep -A 11 -E '^[^#][[:space:]\t]+server_name'|grep -A 9  -E "${server_name}" | grep -E "^[^#][[:space:]\t]+ssl_certificate_key" | awk -F'[ ;]+' /ssl/'{print "key="$(NF-1)}')
                    echo  "otherconf=$f,server_name=${server_name},$key"
                        
                fi
        done
        fi
done
EOF
</span>
sh   check_ssl.sh  | sort |grep -v  <span class="org-string">'^key'</span> &gt;sc-$(hostname).csv
sed -nr <span class="org-string">'s@.*server_name=(.*),.*@\1@gp'</span> sc-$(hostname).csv
</pre>
</div>
</div>
</div>
<div id="outline-container-h:aec1e819-9ae6-40b5-a517-843c2f1af3af" class="outline-3">
<h3 id="h:aec1e819-9ae6-40b5-a517-843c2f1af3af"><a href="#h:aec1e819-9ae6-40b5-a517-843c2f1af3af">08-ansible批量修改</a></h3>
<div class="outline-text-3" id="text-h:aec1e819-9ae6-40b5-a517-843c2f1af3af">
<p>
role ssl
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">&#25191;&#34892;&#21629;&#20196;
</span>ansible-playbook change_ssl.yml
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">&#21019;&#24314;&#22522;&#30784;&#29615;&#22659;
</span>mkdir ansible/
<span class="org-builtin">cd</span> ansible

cat &gt;ansible.cfg&lt;&lt;EOF<span class="org-sh-heredoc">
[defaults]
inventory = ./hosts
forks          = 5
remote_port    = 22
roles_path    = ./roles
host_key_checking = False
timeout = 30
log_path = ./logs/ansible.log
private_key_file = /home/oap/.ssh/id_rsa
[inventory]
[privilege_escalation]
become=True
become_method=sudo
become_user=root
become_ask_pass=False
[paramiko_connection]
record_host_keys=False
[ssh_connection]
[persistent_connection]
[accelerate]
[selinux]
[colors]
[diff]
EOF
</span>
mkdir {logs,roles,files}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">&#21019;&#24314;&#35777;&#20070;role&#29615;&#22659;
</span>mkdir  -pv roles/cron_ssl/{defaults,files,handlers,tasks,templates}

<span class="org-comment-delimiter"># </span><span class="org-comment">&#29983;&#25104;&#25191;&#34892;yml
</span>cat &gt;change_ssl.yml&lt;&lt; \EOF<span class="org-sh-heredoc">
---
- name: Change cron for ssl manage
  hosts: ssl
  vars:
    - script_name: "ssl_monitor.sh"
    - script_dest_path: "/home/sh"
    - script_type: "sh"
    - parameters: "--days 26"
    #- state: "absent"
    - state: "present"
    - {minute: "0", hour: "23", day: "*", month: "*", weekday: "*"}

  roles:
    - cron_ssl
EOF
</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">&#29983;&#25104;&#35777;&#20070;&#29615;&#22659;&#21464;&#37327;
</span>cat &gt;roles/cron_ssl/defaults/main.yml&lt;&lt;\EOF<span class="org-sh-heredoc">
ssl_script: "ssl_monitor.sh"
script_name: ""
script_source_path: ""
script_dest_path: "/home/sh"
script_type: "sh"
state: "present"

user: "root"
minute: "*"
hour: "*"
day: "*"
month: "*"
weekday: "*"
EOF
</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">&#29983;&#25104;&#35777;&#20070;&#20219;&#21153;
</span>cat &gt;roles/cron_ssl/tasks/main.yml&lt;&lt; EOF<span class="org-sh-heredoc">
---
- include: cron.yml
EOF
</span>
cat &gt;roles/cron_ssl/tasks/cron.yml&lt;&lt; \EOF<span class="org-sh-heredoc">
---
- name: Copy {{ script_name }} to
  copy: src={{ item.src }} dest={{ item.dest }}
  with_items:
    - { src: "./files/{{ script_name  }}", dest: "{{ script_dest_path }}/{{ script_name }}" }

- name: Backup {{ script_name  }}
  shell: "cp {{ script_dest_path }}/{{ script_name }} /data/backup/{{ script_name }}.$(date +'%F-%H')"
  ignore_errors: yes

- name: Cat cron
  shell: crontab -l
  register: cat_cron
  ignore_errors: yes
  
- name: Cat cron
  debug: msg="{{ cat_cron.stdout_lines }}"

- name: Del cron that which is "{{ script_name }}"
  cron: name={{ script_name }} state="absent"
  when: state  == "absent"

- name: Del notcron that which is "{{ script_name }}"
  shell: "[ $(crontab -l |grep {{ script_name }}|wc -l) != $(crontab -l |grep -A 2 Ansible| grep {{ script_name }}|wc -l) ] &amp;&amp; sed -ri '/ssl_monitor.sh/d' /var/spool/cron/root"
  ignore_errors: yes
  when: state  == "present"

- name: Cron bash "{{ script_name }}" to "{{ state }}"
  cron: name={{ script_name }} minute={{ minute }} hour={{ hour }} day={{ day }} month={{ month }} weekday={{ weekday }} job='/bin/bash {{ script_dest_path }}/{{ script_name }} {{ parameters }} &amp;&gt;/dev/null'
  when: script_type == "sh" and state == "present"

- name: Cat cron
  shell: crontab -l
  register: cat_cron

- name: Cat cron
  debug: msg="{{ cat_cron.stdout_lines }}"
EOF</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0b78299d-8821-41c4-a602-e2f6f9f6fc79" class="outline-3">
<h3 id="h:0b78299d-8821-41c4-a602-e2f6f9f6fc79"><a href="#h:0b78299d-8821-41c4-a602-e2f6f9f6fc79">09-客户私有化部署</a></h3>
<div class="outline-text-3" id="text-h:0b78299d-8821-41c4-a602-e2f6f9f6fc79">
<p>
目标：
</p>
<ol class="org-ol">
<li>自动申请证书</li>
<li>证书管理，到期天数</li>
</ol>

<p>
计划：
</p>

<p>
使用Let's Encrypt 免费泛域名证书
[<a href="https://letsencrypt.org/">https://letsencrypt.org/</a>](<a href="https://letsencrypt.org/">https://letsencrypt.org/</a>)
</p>

<ol class="org-ol">
<li>自动申请证书</li>
</ol>

<p>
1.0 安装rsync 服务端
</p>

<p>
服务器地址后面证书自动更新脚本要用到。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">&#23433;&#35013;rsync&#26381;&#21153;
</span>yum -y install rsync
systemctl enable rsyncd
systemctl start rsyncd

<span class="org-comment-delimiter"># </span><span class="org-comment">&#20462;&#25913;&#37197;&#32622;
</span>cat &gt;/etc/rsyncd.conf &lt;&lt;\EOF<span class="org-sh-heredoc">
pid file = /var/run/rsyncd.pid
port = 873
address = 0.0.0.0
uid = root
gid = root
use chroot = yes
read only = no
write only = no
#host allow = 172.16.1.0/24
#hosts deny = 0.0.0.0/32
max connections = 10
list = false
log file = /var/log/rsyncd.log
transfer logging = yes
log format = %t %a %m %f %b
syslog facility = local3
timeout = 300
[zhengshu]
comment = "certificate dir"
path=/data/zhengshu
list=yes
auth users = sa
secrets file = /etc/rsyncd.secrets
EOF
</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">&#35748;&#35777;&#25991;&#20214;
</span>cat &gt;/etc/rsyncd.secrets &lt;&lt;\EOF<span class="org-sh-heredoc">
sa:helloworld
EOF
</span>
chmod 600 /etc/rsyncd.secrets
systemctl restart rsyncd
</pre>
</div>

<p>
1.1 安装客户端
</p>
<div class="org-src-container">
<pre class="src src-sh">curl  https://get.acme.sh | sh
<span class="org-builtin">alias</span> acme.sh=~/.acme.sh/acme.sh
<span class="org-builtin">echo</span> <span class="org-string">'alias acme.sh=~/.acme.sh/acme.sh'</span> &gt;&gt;/etc/profile
</pre>
</div>

<p>
自动为你创建 cronjob, 每天 0:00 点自动检测所有的证书, 如果快过期了, 需要更新, 则会自动更新证书. 
</p>


<p>
1.2 申请阿里云证书-dns方式
</p>

<p>
定义全局变量
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">&#23450;&#20041;&#20840;&#23616;&#21464;&#37327;
</span><span class="org-builtin">export</span> <span class="org-variable-name">Ali_Key</span>=<span class="org-string">"LTAI4Fqxb"</span> 
<span class="org-builtin">export</span> <span class="org-variable-name">Ali_Secret</span>=<span class="org-string">"whTtVJmhiEjg"</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">&#30003;&#35831;&#35777;&#20070;
</span>~/.acme.sh/acme.sh --issue --dnssleep 10 --dns dns_ali -d qxhcloud.com -d <span class="org-string">"*.qxd.com"</span> 
<span class="org-comment-delimiter"># </span><span class="org-comment">&#31561;&#24453;...
</span><span class="org-comment-delimiter"># </span><span class="org-comment">&#26597;&#30475;&#35777;&#20070;&#20855;&#20307;&#20869;&#23481;
</span>openssl x509 -in /root/.acme.sh/qxhcloud.com/fullchain.cer  -noout -text
</pre>
</div>


<p>
1.3 上传自动申请证书脚本并配置定时任务
</p>

<p>
脚本update_cer.sh上传到/home/script/目录下。
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir /home/script/
cat &gt;/home/script/update_cer.sh &lt;&lt;\EOF <span class="org-sh-heredoc">
#!/bin/sh
###############################
#system variable
timestamp=`date +%s`
cer_dir="/root/.acme.sh/"
domain_name="
cici.com
"
renew_flag=1

###############################
#qxhcloud domain name info
Qxhcloud_Key () {
    export Ali_Key="LTAI3Wcxb" 
    export Ali_Secret="wmhiEjg"
}

#application certificate
App_Cer () {
    ~/.acme.sh/acme.sh --force --renew-all --dnssleep 10
}

#copy certificate to directory
Copy_Cer () {
    mkdir -p /data/zhengshu/
    /bin/cp -dR /root/.acme.sh/qxhcloud.com /data/zhengshu
}

#check certificate endtime
declare -A apply_certs
declare -A certs_days
Check_Cer () {
    for domain in ${domain_name}; do
    cd ${cer_dir}${domain}
    check_key=`/bin/openssl x509 -in fullchain.cer -noout -dates|head -n 2|awk -F= '{print $2}'|tail -n 1`
    key_time=$[(`date -d "${check_key}" +%s`-${timestamp})/24/3600]
    if [ ${key_time} -le 28 ];then
            apply_certs[${#apply_certs[*]}]="`pwd` Certificate time remaining ${key_time} day,this applying\n"
            renew_flag=0
    else
            certs_days[${#certs_days[*]}]="`pwd` ${key_time} day \n"
    fi
    done
    
    if [ $renew_flag -eq 0 ]; then
        Qxhcloud_Key
        App_Cer
        Copy_Cer
    fi
}


main (){
    Check_Cer
    #[ ${#apply_certs[@]} -gt 0 ] &amp;&amp; echo -e "${apply_certs[@]}" | mail -s 'Ali Certificate Details' 12345@163.COM
    #echo -e "${certs_days[@]}" | mail  -s 'Ali Certificate Details' 12345@163.COM
}

main
EOF
</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">&#37197;&#32622;&#23450;&#26102;&#20219;&#21153;
</span><span class="org-builtin">echo</span> -e <span class="org-string">"# update certificate\n30 09 * * * /bin/sh /home/script/update_cer.sh &gt; /dev/null"</span> &gt;&gt;/var/spool/cron/root 
</pre>
</div>

<p>
2 上传证书自动更新脚本并配置定时任务
</p>

<p>
2.1 上传证书自动更新脚本
</p>

<p>
脚本ssl_monitor.sh上传到/home/script/目录下，目录没有刚创建
</p>

<p>
注意：
</p>
<ol class="org-ol">
<li>脚本配置在nginx主机上。</li>
<li>nginx配置证书目录必须为/usr/local/zhengshu</li>
</ol>

<p>
2.2 配置定时任务
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">&#37197;&#32622;&#23450;&#26102;&#20219;&#21153;
</span><span class="org-builtin">echo</span> -e <span class="org-string">"# ssl_monitor &#21097;&#20313;28&#22825;&#26356;&#26032;\n0 23 * * * /bin/bash /home/script/ssl_monitor.sh -days 28 &amp;&gt;/dev/null"</span> &gt;&gt;/var/spool/cron/root 
</pre>
</div>

<p>
注意：
</p>
<ol class="org-ol">
<li>修改脚本中rsync服务端地址</li>
</ol>

<p>
3 nginx ssl配置
</p>

<div class="org-src-container">
<pre class="src src-sh">server {
    <span class="org-comment-delimiter">#</span><span class="org-comment">listen 80;
</span>    listen 443 ssl http2;
    server_name *.qxd.com;
    ssl                  on;
    ssl_certificate      /usr/local/zhengshu/qxd.com/fullchain.cer;
    ssl_certificate_key  /usr/local/zhengshu/qxd.com/nfin.com.key;
    ssl_ciphers                EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;
    ssl_prefer_server_ciphers  on;
    ssl_protocols              TLSv1 TLSv1.1 TLSv1.2;
    ssl_session_cache          shared:SSL:1024m;
    ssl_session_timeout        10m;
    ssl_session_tickets        on;
    ssl_stapling               on;
    ssl_stapling_verify        on;

    ssl_trusted_certificate   /usr/local/zhengshu/qxd.com/fullchain.cer;
... ...
</pre>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
