<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: RRDtool简体中文教程</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux: RRDtool简体中文教程</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:c26dd0d9-1f22-40e0-b057-aba02af82b3e">RRDtool简体中文教程</a>
<ul>
<li><a href="#h:b0812e43-8c15-4de9-bd85-2a2b10d22bdd">1. RRDtool 简介</a>
<ul>
<li><a href="#h:3046356f-96d6-4a1b-84ca-7aa296a3a250">一）MRTG 不能作什么？</a></li>
<li><a href="#h:760e8a5d-2aed-4ac6-a0dd-6228c4c43b74">二） MRTG 的优点</a></li>
<li><a href="#h:5470c865-3622-4b06-8347-6fe4af732f07">三） RRDtool 的定义</a></li>
<li><a href="#h:7cff7877-76d2-46a4-b0fd-8e43fcd4b77b">四）RRDtool 的特殊之处</a></li>
<li><a href="#h:5ea935f4-7ad4-4cd8-8469-ed39173d4edb">五）总结RRDtool 和 MRTG 的不同之处</a></li>
</ul>
</li>
<li><a href="#h:6200ebdd-354b-49c1-bf96-bef7bfdf4372">2. rrdtool安装</a></li>
<li><a href="#h:13b57d29-15d3-4137-9ea8-9e0e2c1ddaae">3. 前期规划</a>
<ul>
<li><a href="#h:bf0f289a-09c0-4880-b894-c11eab7a92c7">一）MRTG 的前期规划</a></li>
<li><a href="#h:1e9d4196-d48d-4eb0-b1b9-b97d194ccacb">二）RRDtool 的前期规划</a></li>
<li><a href="#h:6c6d30c6-799b-4959-87ce-3e3a640c0877">三）实际例子</a></li>
</ul>
</li>
<li><a href="#h:c9831d60-eeb0-46ec-a13c-c0b6e77d6c52">4. 建立 RRD 数据库</a>
<ul>
<li><a href="#h:6f47a585-01b3-4d0e-81d8-78f6ab19c1b8">4.1 语法格式</a></li>
<li><a href="#h:588bfb09-fe2a-4786-a55b-90d9fdda72c5">4.2 参数解释</a></li>
<li><a href="#h:2fa26253-cc1b-42a6-a0e9-5a84f8100d52">4.3 DS:ds-name:DST:dst arguments</a>
<ul>
<li><a href="#h:39bf10fb-b7ce-4065-9ebc-8e93c7201a7d">4.3.1 DS ：DS 用于定义 Data Soure 。也可以理解为声明数据变量的关键字。</a></li>
<li><a href="#h:69081947-de68-48ae-9876-225ee0ae6a4a">4.3.2 DS-NAME：变量名，可以理解为你给这个数据源起的助记符(变量名)（简称DSN）。</a></li>
<li><a href="#h:332609d2-ec73-44ee-b7f9-f10830fed7c7">4.3.3 DST：DS数据源的类型，有 COUNTER、GUAGE、DERIVE、ABSOLUTE、COMPUTE 5种。官方介绍了7 种</a></li>
<li><a href="#h:4928e07f-4dc2-4183-868b-6ea66a98fbd1">4.3.4. heartbeat 心跳有效期</a></li>
<li><a href="#h:3da8ee51-ec73-4e94-aa0a-225a73447210">4.3.5 min:max 记录数据的最小值和最大值</a></li>
</ul>
</li>
<li><a href="#h:4e17622b-5511-4480-b844-6727b316c3e7">4.4 RRA:CF:cf arguments</a>
<ul>
<li><a href="#h:7e3b7aaf-408e-4c28-88cf-33fd6b205425">4.4.1 RRA：用以声明RRAs的关键字</a></li>
<li><a href="#h:0c768ff6-8243-4923-b001-3ceba26dd9ce">4.4.2 CF：consolidation function 合并方式，包含四类：</a></li>
<li><a href="#h:024a9cf4-a085-42f5-9df1-702147a03541">4.4.3 xff：xfiles factor 和unkown数据有关，很多资料都取0.5</a></li>
<li><a href="#h:847e40a2-f190-494e-8b5b-aeaf7dafcf8b">4.4.4 step：有step条PDP合并形成一条CDP</a></li>
<li><a href="#h:93a04777-acb1-49ba-9892-b5f1c216481e">4.4.5 row：记录的合并数据点CDP条数</a></li>
</ul>
</li>
<li><a href="#h:b05725c3-ce9d-4466-9d62-ba49bda103ae">4.5 开始建库</a></li>
</ul>
</li>
<li><a href="#h:a9c373e6-cd3a-4f33-8745-8db54f831bde">5. 如何获取RRD文件的信息</a>
<ul>
<li><a href="#h:7993a21e-7eb9-4962-852e-046e81f41a34">一）前言</a></li>
<li><a href="#h:045ada26-f8d5-4ef1-8ca5-b995d5a3ab7d">二）如何查询一个 RRD 文件的结构信息</a></li>
<li><a href="#h:507ac785-9ccb-46cc-b1eb-b3f19d272dea">三）第一次更新/最近一次更新</a></li>
</ul>
</li>
<li><a href="#h:9dd80630-f89a-4575-9d73-8b3bb2b6e501">6. 更新RRD文件</a>
<ul>
<li><a href="#h:25594a92-a82d-43cc-81fb-dd68888cd010">一）前言</a></li>
<li><a href="#h:6816a64c-331f-4d3a-8c5d-8c5d7dbaa165">二）update 操作的语法格式</a></li>
<li><a href="#h:699f949b-d7c1-4c9a-8544-aaaf55e1dbfa">三）手工方式 update 数据库</a></li>
<li><a href="#h:c4805594-7dbc-481f-ac6b-f6540a5a5021">四）自动更新数据库</a></li>
<li><a href="#h:88d469f7-eeb9-4581-81a0-8a673fc1f621">五）接下来是什么呢？</a></li>
</ul>
</li>
<li><a href="#h:08fe2df4-ff64-4131-9d9f-e7fa226c66e5">7. 从RRD文件中提取数据</a>
<ul>
<li><a href="#h:5c5ce3b2-d776-4007-a6a1-5660936bb839">一）前言</a></li>
<li><a href="#h:d697a16a-d31c-48bc-baa4-f2563dccad4a">二）fetch 操作的语法</a></li>
<li><a href="#h:38975481-276f-43ee-b1fa-dafa6a7bb7fb">三）fetch 如何取数据</a></li>
<li><a href="#h:86146f4d-7965-4dd0-943c-46467f1ea9ee">四）实际例子</a></li>
<li><a href="#h:69e4730c-74a5-465f-920a-4f775814fb9f">五）总结</a></li>
</ul>
</li>
<li><a href="#h:97d7adc7-db99-4b87-be94-f214bb285098">8. 使用RRDtool 进行绘图（一）</a>
<ul>
<li><a href="#h:180d9727-b5c5-4326-b449-a2fd804aa371">一）前言</a></li>
<li><a href="#h:e5390439-dc46-4020-b2bc-34f3f5514831">二、graph 操作的语法</a></li>
<li><a href="#h:0056975e-a48d-4015-943d-247b2653716b">三）选项分类</a></li>
<li><a href="#h:57b89f3f-7d81-48e0-b2bb-7f6836f05e4b">四）时间范围控制（Time Range）</a></li>
<li><a href="#h:15268ca3-632f-494b-8039-fe20e4df63b8">五）说明文字（Label）</a></li>
<li><a href="#h:8427c0df-6f7f-4b70-a5f5-66a17fa17468">六）图表大小（Size）</a></li>
<li><a href="#h:b9ce772f-02f1-4c4a-88fe-eaf6f42fc1f1">七） Y 轴上下限（Limits）</a></li>
<li><a href="#h:0a76f9a2-877e-4dd6-bdf8-a4aba614d80b">八） X/Y 轴刻度（Grid）</a></li>
<li><a href="#h:54ce9a11-fda2-43b2-abbf-95fa01e67ab5">九、 其他（Miscellaneous）</a></li>
<li><a href="#h:4941ee8e-a0ef-45eb-ae0f-599dc4bb1c7b">十）数字报表</a></li>
<li><a href="#h:8122d385-b80f-426c-b6db-99d3e1c04625">十一）特殊功能</a></li>
<li><a href="#h:f699777f-f247-461b-be3a-d8689713f5d8">十二）总结</a></li>
</ul>
</li>
<li><a href="#h:f5020159-65b9-4c66-b40b-06529ce9b31c">9. RRDtool简体中文教程_9：如何使用RPN</a>
<ul>
<li><a href="#h:2bd9c6f1-a035-4230-9bcc-81a763c36863">一）前言</a></li>
<li><a href="#h:f2cfcb54-522f-44b3-8803-f1b274b954ea">二）操作符</a></li>
<li><a href="#h:42e12837-5339-49b1-a38c-2d0e5baf385e">三）RPN 操作符的分类</a></li>
<li><a href="#h:dcad6cde-48d7-4709-a0eb-79434b74d22c">四）RPN 操作的结果</a></li>
<li><a href="#h:775ecb9b-2b3b-41e0-9cbc-af66351361ba">五）如何阅读 RPN</a></li>
<li><a href="#h:4066656e-e96e-4fec-9d99-581f989f5f5d">六、RPN 实例</a></li>
<li><a href="#h:cf8c29ed-928b-451f-b54b-b67824a12682">七）如何表示 AND、OR 关系</a></li>
<li><a href="#h:055c05fa-241c-45f2-bdfe-13f2e811c946">八）实例</a></li>
<li><a href="#h:e05d6b95-757d-4b85-9580-5ee117e0030a">九、完结</a></li>
<li><a href="#h:c05d58a8-50af-4923-b922-e7418c1d0f59">十、 本人的一点学习体会</a></li>
</ul>
</li>
<li><a href="#h:0cf0cd94-43e7-4e04-9fb1-8c5c4a861ee8">10. 实例</a></li>
<li><a href="#h:81d3876b-90bc-4043-878d-c96bae59bc52">11. python与rrdtool结合画图</a>
<ul>
<li><a href="#h:c118795b-7cae-40e5-b30e-1a1f83c48205">11.1 准备依赖</a></li>
<li><a href="#h:06a42d4a-94a3-499f-87a5-47e190eeddd2">11.2 代码实例</a></li>
<li><a href="#h:b34f4973-99c6-47e6-976b-8d5abe64d161">11.2 多实例聚合版本</a></li>
</ul>
</li>
<li><a href="#h:859253c8-387c-46fe-a522-0b952edc62e2">12. golang与rrdtool结合画图</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../../index.html">Linux</a></li>
</ul>
<section id="outline-container-h:c26dd0d9-1f22-40e0-b057-aba02af82b3e" class="outline-2">
<h2 id="h:c26dd0d9-1f22-40e0-b057-aba02af82b3e">RRDtool简体中文教程</h2>
<div class="outline-text-2" id="text-h:c26dd0d9-1f22-40e0-b057-aba02af82b3e">
</div>
<div id="outline-container-h:b0812e43-8c15-4de9-bd85-2a2b10d22bdd" class="outline-3">
<h3 id="h:b0812e43-8c15-4de9-bd85-2a2b10d22bdd">1. RRDtool 简介</h3>
<div class="outline-text-3" id="text-h:b0812e43-8c15-4de9-bd85-2a2b10d22bdd">
<p>
之前，让我们先回顾一下它的前身：MRTG。相信只要做网管工作的朋友，对
MRTG这个软件一定不会陌生， 至少也可能听过。MRTG 可以通过 SNMP 协议直接
访问SNMP Object ，例如 ifInOctect 和 ifOutOctect ；也可以通过外部
script的方式，来监测cpu、内存、磁盘利用率、数据库的表空间利用率等信息。
只要把MRTG 放入 crontab 中让其自动运行， MRTG就可以自动为你绘制出每天、
每周、每月、每年的统计图表。 MRTG甚至还为你提供了自动生成配置文件的
cfgmaker 和 自动生成 HTML 页面的indexmaker 这两个工具，让你省去逐个编
写 cfg文件的痛苦。到目前为止，还有很多人在使用它。它现在 有 Unix、
Windows各种平台，windows 平台上甚至出现了 PRTG 这样和 MRTG很象的东东，
轻点鼠标就可以漂亮的完成工作。 既然如此，我们为什么还要介绍RRDtool 呢？
先让我们看几个问题，几个在 MRTG 使用中常见的问题 ：
</p>
</div>
<div id="outline-container-h:3046356f-96d6-4a1b-84ca-7aa296a3a250" class="outline-4">
<h4 id="h:3046356f-96d6-4a1b-84ca-7aa296a3a250">一）MRTG 不能作什么？</h4>
<div class="outline-text-4" id="text-h:3046356f-96d6-4a1b-84ca-7aa296a3a250">
<ul class="org-ul">
<li><code>MRTG 一张图表只能显示2个对象，一个输入，一个输出。</code> 如果你想同时</li>
</ul>
<p>
显示多个对象呢？例如笔者的单位有12台服务器。如果想把它们的负载情况都显
示在一个图表上，MRTG至少需要6张图。
</p>

<ul class="org-ul">
<li><code>MRTG无法回放数据。</code> MRTG 的图是自动生成的，所采用的数据也是由 MRTG</li>
</ul>
<p>
自己提取的，例如5分钟平均的记录有288条，
MRTG每20分钟合并一次，每次合并4个记录。在50个小时后，288条记录将全部变成20分钟平均的数据。如果你想回放这些数据怎么办呢？对不起，只能去看第2个图了（每周）。
</p>

<ul class="org-ul">
<li><p>
<code>MRTG 只有 COUNTER 和 GAUGE 这两种计算类新。</code> 如果我要监测两个数值型
的对象之间的大小，它们之间的差值可以是正数，也可以是负数。MRTG能实现
吗？笔者在多次试验中发现，MRTG 对于负数的和 '.15'这样格式的小数（通
常都是bc的输出）的识别会出错。
</p>

<p>
例如把 '.72' 识别为 72，把 -1 识别为 1。
</p></li>

<li>=MRTG 无法实现有条件的绘图。=有时候我们只想看某个服务器在一年之中的
宕机时间，正常时间我们不关心；或者我们想看当前值和去年同期相比究竟如
何？这些都是MRTG无法做到的</li>
</ul>
</div>
</div>
<div id="outline-container-h:760e8a5d-2aed-4ac6-a0dd-6228c4c43b74" class="outline-4">
<h4 id="h:760e8a5d-2aed-4ac6-a0dd-6228c4c43b74">二） MRTG 的优点</h4>
<div class="outline-text-4" id="text-h:760e8a5d-2aed-4ac6-a0dd-6228c4c43b74">
<p>
那 MRTG 和 RRDtool相比就没有优点了吗？也不是。简单、方便就是它的最大优
点。
</p>

<p>
（MRTG 中还有一个好东西就是自动告警功能，相比之下，RRDtool在这方面的配
置比较复杂，还不如直接作到 shell script中）
</p>

<p>
前面提到 MRTG 能够通过 cfgmaker 和 indexmaker快速建立配置文件和HTML页
面。而 RRDtool 在这两方面都需要自己动手。
</p>

<p>
数据的采集→插入数据→提取数据→绘图→建立 HTML，这些步骤都是需要你自
己动手的。RRDtool给了使用它的人最大程度的自由。但这种自由对于新手或者
没有耐心的人来说可能是一种考验。相比之下，MRTG就容易上手多了。
</p>
</div>
</div>
<div id="outline-container-h:5470c865-3622-4b06-8347-6fe4af732f07" class="outline-4">
<h4 id="h:5470c865-3622-4b06-8347-6fe4af732f07">三） RRDtool 的定义</h4>
<div class="outline-text-4" id="text-h:5470c865-3622-4b06-8347-6fe4af732f07">
<p>
RRDtool 代表 "Round Robin Database tool" ，作者同时也是 MRTG软件的发明
人。官方站点位于<a href="http://oss.oetiker.ch/rrdtool/">http://oss.oetiker.ch/rrdtool/</a> 。
</p>

<p>
所谓的“Round Robin”其实是一种存储数据的方式，使用固定大小的空间来存
储数据，并有一个指针指向最新的数据的位置。我们可以把用于存储数据的数据
库的空间看成一个圆，上面有很多刻度。这些刻度所在的位置就代表用于存储数
据的地方。所谓指针，可以认为是从圆心指向这些刻度的一条直线。指针会随着
数据的读写操作自动移动。要注意的是，这个圆没有起点和终点，所以指针可以
一直移动，而不用担心到达终点后就无法前进的问题。在一段时间后，当所有的
空间都存满了数据，就又从头开始存放。这样整个存储空间的大小就是一个固定
的数值。所以RRDtool就是使用类似的方式来存放数据的工具，RRDtool 所使用
的数据库文件的后缀名是'.rrd'。
</p>
</div>
</div>
<div id="outline-container-h:7cff7877-76d2-46a4-b0fd-8e43fcd4b77b" class="outline-4">
<h4 id="h:7cff7877-76d2-46a4-b0fd-8e43fcd4b77b">四）RRDtool 的特殊之处</h4>
<div class="outline-text-4" id="text-h:7cff7877-76d2-46a4-b0fd-8e43fcd4b77b">
<ul class="org-ul">
<li>首先 RRDtool 存储数据，扮演了一个后台工具的角色。但同时 RRDtool 又允
许创建图表，这使得 RRDtoo看起来又像是前端工具。其他的数据库只能存储
数据，不能创建图表。</li>

<li>RDtool 的每个 rrd 文件的大小是固定的，而普通的数据库文件的大小是随着
时间而增加的</li>

<li>其他数据库只是被动的接受数据， RRDtool 可以对收到的数据进行计算，例如
前后两个数据的变化程度（rate of change），并存储该结果。</li>

<li>RRDtool 要求定时获取数据，其他数据库则没有该要求。如果在一个时间间隔
内（heartbeat）没有收到值，则会用UNKN 代替，其他数据库则不会这样做</li>
</ul>
</div>
</div>
<div id="outline-container-h:5ea935f4-7ad4-4cd8-8469-ed39173d4edb" class="outline-4">
<h4 id="h:5ea935f4-7ad4-4cd8-8469-ed39173d4edb">五）总结RRDtool 和 MRTG 的不同之处</h4>
<div class="outline-text-4" id="text-h:5ea935f4-7ad4-4cd8-8469-ed39173d4edb">
<ul class="org-ul">
<li>MRTG 是采用配置文件的方式来监控的； RRDtool 则没有配置文件一说。所有
操作都是通过命令（也可以写成script方式）执行</li>

<li>MRTG 有自动采集数据的功能（通过 snmp）； RRDtool 没有，需要手工或者
通过 shell/perl 脚本来获取数据</li>

<li>MRTG 每次运行都会更新图片和日志； RRDtool 默认只是接收数据，并不会绘
图，除非手工执行 graph 命令</li>

<li>MRTG 采用明文的 log 方式存放历史数据； RRDtool 采用数据库的方式来存
放数据；</li>

<li><p>
MRTG 无法回放日志数据，因为 MRTG 会对日志进行合并；
</p>

<p>
<code>RRDtool 采用 RRA 的概念，把不同统计周期的数据单独存放，所以可以做到历史数据的回放功能</code>
</p></li>

<li><p>
MRTG 的 log 中每种周期的记录的数量是自动维护的；
</p>

<p>
<code>RRDtool 的 RRA 中的记录数是可以自定义的。</code>
</p></li>

<li><p>
MRTG 中数据的统计时间间隔是固定的，例如5分钟平均，30分钟平均，2小时
平均，1天平均；
</p>

<p>
<code>RRDtool 可以任意设置（试过1分钟一次）</code>
</p></li>

<li>MRTG 一张图只能显示2个对象； <code>RRDtool 可以显示多个。</code></li>

<li><p>
MRTG 的数据类型只有 COUNTER 和 GAUGE 两种；
</p>

<p>
<code>RRDtool 有5种，COUNTER、GAUGE、DERIVE、ABSOLUTE、COMPUTE</code>
</p></li>

<li><p>
MRTG 的图表只能显示当前值、最大值、平均值；
</p>

<p>
<code>RRDtool 可以显示当前值（LAST）、初值（FIRST）、最大值(MAX)、最小值
  （MIN）、平均值（AVG）、总和（TOTAL）等</code>
</p></li>

<li><p>
MRTG 绘图方式只有 AREA、LINE 方式；
</p>

<p>
<code>RRDtool 则有 AREA、LINE（1|2|3）、STACK 方式；</code>
</p></li>

<li><p>
MRTG 负责搜集、存储、绘图、建档（HTML）；
</p>

<p>
<code>RRDtool 只负责存储、绘图这两个阶段，所以需要自己建立 HTML 文件</code>
</p></li>

<li><p>
MRTG 的运算功能较差；
</p>

<p>
<code>RRDtool 可以通过 CDEF 对取出来的数据进行算术和逻辑运算；</code>
</p></li>

<li><p>
MRTG 只能原原本本的显示数据；
</p>

<p>
<code>RRDtool 可以对数据进行处理，或者有条件的显示；</code>
</p></li>
</ul>

<p>
看来 RRDtool 的功能是不是比 MRTG 强很多呢？！
</p>

<p>
具体的差异目前就只能想到这些，不知各位还有没有什么补充呢？ ！！^_^ ！！
</p>

<p>
相信这么讲的话还是比较抽象的，不过不用急，目前只是一个开始而已。
</p>

<p>
下一节我们开始讲如何安装 RRDtool 。
</p>
</div>
</div>
</div>
<div id="outline-container-h:6200ebdd-354b-49c1-bf96-bef7bfdf4372" class="outline-3">
<h3 id="h:6200ebdd-354b-49c1-bf96-bef7bfdf4372">2. rrdtool安装</h3>
<div class="outline-text-3" id="text-h:6200ebdd-354b-49c1-bf96-bef7bfdf4372">
<p>
安装，我直接用的apt-get install rrdtool即可安装成功
</p>
</div>
</div>
<div id="outline-container-h:13b57d29-15d3-4137-9ea8-9e0e2c1ddaae" class="outline-3">
<h3 id="h:13b57d29-15d3-4137-9ea8-9e0e2c1ddaae">3. 前期规划</h3>
<div class="outline-text-3" id="text-h:13b57d29-15d3-4137-9ea8-9e0e2c1ddaae">
<p>
可能大家会觉得奇怪，做个 RRDtool还要规划什么？俗话说：磨刀不误砍柴工。
好的规划必须具备灵活性、可扩展性，否则会给将来的使用带来不少的麻烦。我
们先谈一下 MRTG 的规划，再谈 RRDtool的规划。
</p>
</div>
<div id="outline-container-h:bf0f289a-09c0-4880-b894-c11eab7a92c7" class="outline-4">
<h4 id="h:bf0f289a-09c0-4880-b894-c11eab7a92c7">一）MRTG 的前期规划</h4>
<div class="outline-text-4" id="text-h:bf0f289a-09c0-4880-b894-c11eab7a92c7">
<ul class="org-ul">
<li><code>想要监测监测什么对象？</code> 并列出一个清单；</li>

<li><code>想要以什么方法来取得数据？</code> 是通过 SNMP 还是 shell 、perl 。 如果使
用SNMP ，监测对象所在主机的 SNMP 服务安装了吗？是否配置完毕；</li>

<li><p>
<code>每个对象的监测时间是多长时间一次？</code> 并以此对监测对象进行分类。
</p>

<p>
例如笔者本人共用 MRTG 监测了 80 多个对象，并根据内容分成四类 ：
</p>

<ul class="org-ul">
<li>重要状态方面 ： 例如 HACMP 的切换动作监控；Oracle 服务的状态；LVM
中的 vg 是否在线；服务器是否宕机等。这些监测对象对于一个系统的运行
来说都是十分重要的，一旦发生故障，需要立即处理的。所以对于这类对象，
按最小时间间隔（5分钟一次）设置</li>
<li>I/O性能方面 ：主要是 I/O 吞吐量、I/O 服务时间方面的监测。这类对象是7分钟一次</li>
<li>次要状态方面 ：例如 cpu 利用率、内存利用率、在线人数、温度、拨号用
户人数等。20分钟一次</li>
<li>利用率方面 ：由于实际应用的问题，所以对利用率比较关心。单独拎出来
做一块监测。主要是监控Oracle的各个表空间的利率，以及LVM磁盘系统各
个分区的利用率。每25分钟一次</li>
<li>监控机本身：负责监控的监控机本身也需要监控。主要监控当前监测的对象
数量，以及系统负荷。这类就30分钟一次。</li>
</ul></li>

<li><p>
<code>每个对象一个 cfg 文件？还是全部集中在一个 cfg 文件中呢？</code>
</p>

<p>
我本人还是比较倾向于每个Target一个 cfg 文件，每个 cfg 中都定 义
Workdir、Language这两个选项。针对上面的5个分类，建立5个 "大的"cfg 文
件，再利用 MRTG 中的Include 功能导入一个个"小的"、具体的 cfg 文件。
这样当日后对某个监测对象进行修改时（例如修改数据的获取脚本，或者修改
图片的外观），可以单独测试 该对象。不用连同其他对象也一起跑一次，节
省不少时间。如果想取消那个对象的监测，在前面提到的那个“大的”cfg 文
件中，把对应 的 Include 语句注释掉就可以了，是不是更方便呢？
</p></li>

<li><code>为个监控对象起一个合适的名称。</code> 一般用的方式。这一步也满重要的。一
开始不注意，随便给个名字，等到后来自己都搞不清楚了，建议一开始就规划
好。如果要使用 MRTG的告警功能，就更应该好好规划了，要不然收到告警邮
件都不知道是那个对象，那个机器出现问题，白白浪费时间。</li>

<li><code>是否需要用到 MRTG 的告警功能。</code> MRTG有告警功能，可以设置输入/出的最
大值，最小值。超过限制就会调用 ThreshProgI 和 ThreshProgO 选项指定的
程序。我一般用发送邮件和HTML配合的方式。</li>
</ul>

<p>
差不多也就这些了，就可以开始动手写 script 了。
</p>
</div>
</div>
<div id="outline-container-h:1e9d4196-d48d-4eb0-b1b9-b97d194ccacb" class="outline-4">
<h4 id="h:1e9d4196-d48d-4eb0-b1b9-b97d194ccacb">二）RRDtool 的前期规划</h4>
<div class="outline-text-4" id="text-h:1e9d4196-d48d-4eb0-b1b9-b97d194ccacb">
<p>
RRDtool 的前期规划相对多一点，因为 RRDtool很多东西需要自己设定。除了上
述 MRTG 考虑的几点之外，我一般还考虑以下几点：
</p>

<ul class="org-ul">
<li><p>
是一个 RRD 文件中包括多个监测对象（DS），还是分成多个 RRD 文件？
</p>

<p>
RRDtool 提供了 tune 操作，可以增加监测对象或者删除 RRD 文件中的某个
对象，而且绘图时也可以指定要画的是那个对象，这点看个人喜欢而定。
</p></li>

<li>如何统计取得的数据 ：MRTG是固定的，5分钟、20分钟、2小时、1天。
RRDtool 则可以自己设置</li>

<li><p>
如何保存/统计这些数据 ：这是和 MRTG 不同的地方。MRTG log的建立和维护
是自动的，RRDtool 的数据存放 则需要自己定义。但我们可以参照MRTG 的方
式：
</p>

<pre class="example" id="org0e11602">
每日统计图（5分钟平均）  ： 600 个，大约2天的时间

每周统计图（20分钟平均） ： 600 个，大约8天的时间

每月统计图 （2小时平均） ： 600 个，50 天的时间

每年统计图 （1天平均） ：730 个， 2年的时间
</pre></li>

<li><p>
要以什么方式绘图 ：MRTG绘图方式只有曲线（LINE）和方块（AREA）两种；
</p>

<p>
RRDtool除了这两种外，还有一种是 STACK 方式。就是在前一个曲线或者方块
的基础上绘图图，而不是直接从 X轴开始绘图。这样绘制出来的图比较清晰，
不会出现交叉的现象，但此时 Y轴的值等于当前对象的值加上前一个绘图对象
的值。例如前一个对象（cpu的系统进程利用率）的值是10，采用的是 AREA
方式绘图。当前对象（cpu的用户级进程的利用率）是5，采用的是 STACK 方
式，则“cpu的用户级进程利用率”对应的Y轴刻度是10+5=15；所以如果不加
说明，别人可能会误解。
</p></li>
</ul>
</div>
</div>
<div id="outline-container-h:6c6d30c6-799b-4959-87ce-3e3a640c0877" class="outline-4">
<h4 id="h:6c6d30c6-799b-4959-87ce-3e3a640c0877">三）实际例子</h4>
<div class="outline-text-4" id="text-h:6c6d30c6-799b-4959-87ce-3e3a640c0877">
<ul class="org-ul">
<li>搞清楚究竟想要监测什么对象 ：监测本地主机的网络流量。包括 eth0 和 lo 接口的流量。</li>

<li><p>
想要以什么方法来取得数据 ：sar 也可以统计网卡接口的流量。但这里我们
用 SNMP ，访问 ifInOctets 和 ifOutOctets 。
</p>

<pre class="example" id="org387536f">
假设脚本名称是 get_eth0_traffic.sh 和 get_lo_traffic.sh
</pre></li>

<li>每个对象的监测时间是多长时间一次 ：5分钟</li>

<li>是采用一个 RRD 文件还是多个 ：2个 RRD 文件，一个是 eth0.rrd，一个是 lo.rrd</li>

<li>[color=bl;ue]为每个监测对象起名 ：分别是 eth0_in ,eth0_out ,lo_in, lo_out</li>

<li>统计频率 ：5分钟、20分钟、2小时、1天</li>

<li>如何保存统计数据 ：600个、600个、600个、730个</li>

<li>要以什么方式绘图 ：目前暂不考虑该问题。等到实际绘图时再体验。</li>
</ul>

<p>
注 ：实际上我们可以把数据的插入、绘图一起做到 get_eth0_traffic.sh 和
get_lo_traffic.sh 中，但目前这两个脚本只是负责取数据并输出而已，到最后
我们再把这些功能合并到一起。
</p>

<p>
四）下面是脚本的内容
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;net-snmp</span>
wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
yum install net-snmp -y
<span style="color: #483d8b;">cd</span> /etc/snmp/
cp snmpd.conf snmpd.conf.bak
cat snmpd.conf.bak |grep -vE <span style="color: #8b2252;">'^$|^#'</span> &gt; snmpd.conf

cat &gt;/etc/snmp/snmpd.conf&lt;&lt;\EOF
<span style="color: #ffa54f;">com2sec notConfigUser  default       public</span>
<span style="color: #ffa54f;">group   notConfigGroup v1           notConfigUser</span>
<span style="color: #ffa54f;">group   notConfigGroup v2c           notConfigUser</span>
<span style="color: #ffa54f;">view    all    included   .1</span>
<span style="color: #ffa54f;">view    systemview    included   .1.3.6.1.2.1.1</span>
<span style="color: #ffa54f;">view    systemview    included   .1.3.6.1.2.1.25.1.1</span>
<span style="color: #ffa54f;">access  notConfigGroup ""      any       noauth    exact  all none none</span>
<span style="color: #ffa54f;">access  notConfigGroup ""      any       noauth    exact  systemview none none</span>
<span style="color: #ffa54f;">syslocation Unknown (edit /etc/snmp/snmpd.conf)</span>
<span style="color: #ffa54f;">syscontact Root <a href="mailto:root%40localhost">&lt;root@localhost&gt;</a> (configure /etc/snmp/snmp.local.conf)</span>
<span style="color: #ffa54f;">dontLogTCPWrappersConnects yes</span>
<span style="color: #ffa54f;">EOF</span>

systemctl start snmpd
systemctl enable snmpd
yum -y install net-snmp-utils
&#21442;&#32771;&#65306;
https://www.cnblogs.com/createyuan/p/3997228.html

ubuntu&#23433;&#35013;&#65306;
sudo apt-get install librrd-dev libpython3-dev

<span style="color: #b22222;"># </span><span style="color: #b22222;">yum install rrdtool-devel python34-devel</span>
pip install rrdtool
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">cat &gt;get_eth0_traffic.sh&lt;&lt;\EOF
<span style="color: #ffa54f;">#!/bin/bash</span>
<span style="color: #ffa54f;"># &#39318;&#20808;&#21462;&#24471; eth0 &#25509;&#21475;&#30340; ifIndex </span>
<span style="color: #ffa54f;">index=$(</span><span style="color: #ff00ff;">snmpwalk -IR -v 1 -c public localhost RFC1213-MIB::ifDescr |grep eth0|cut -d '=' -f 1|cut -d '.' -f 2</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;"># &#20877;&#36890;&#36807; snmp &#21327;&#35758;&#21462;&#24471; ififInOctets &#21644; ifOutOctets &#30340;&#20540;</span>
<span style="color: #ffa54f;"># &#30001;&#20110;&#22312; /etc/snmp.conf &#20013;&#37197;&#32622;&#20102; defVersion &#21644; defCommunity &#65292;&#25152;&#20197; snmpget &#21629;&#20196;&#19981;&#29992;&#25351;&#23450;&#36825;&#20004;&#20010;&#21442;&#25968;</span>
<span style="color: #ffa54f;">eth0_in=$(</span><span style="color: #ff00ff;">snmpget -v 1 -c public  -IR -Os localhost ifInOctets.${index}|cut -d ':' -f 2|tr -d '[:blank:]'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">eth0_out=$(</span><span style="color: #ff00ff;">snmpget -v 1 -c public  -IR -Os localhost ifOutOctets.${index}|cut -d ':' -f 2 |tr -d '[:blank:]'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">echo $eth0_in</span>
<span style="color: #ffa54f;">echo $eth0_out</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">cat &gt;get_lo_traffic.sh&lt;&lt;\EOF      
<span style="color: #ffa54f;">#!/bin/bash</span>
<span style="color: #ffa54f;"># &#39318;&#20808;&#21462;&#24471; eth0 &#25509;&#21475;&#30340; ifIndex </span>
<span style="color: #ffa54f;">index=$(</span><span style="color: #ff00ff;">snmpwalk  -v 1 -c public  -IR localhost RFC1213-MIB::ifDescr |grep lo|cut -d '=' -f 1|cut -d '.' -f 2</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">lo_in=$(</span><span style="color: #ff00ff;">snmpget -v 1 -c public  -IR -Os localhost ifInOctets.${index}|cut -d ':' -f 2|tr -d '[:blank:]'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">lo_out=$(</span><span style="color: #ff00ff;">snmpget  -v 1 -c public -IR -Os localhost ifOutOctets.${index}|cut -d ':' -f 2 |tr -d '[:blank:]'</span><span style="color: #ffa54f;">)</span>
<span style="color: #ffa54f;">echo $lo_in</span>
<span style="color: #ffa54f;">echo $lo_out</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
再把这2个脚本放入 crontab 中，每5分钟执行一次
</p>

<div class="org-src-container">
<pre class="src src-sh">*/5 * * * * /bin/bash  /home/sh/get_eth0_traffic.sh
*/5 * * * * /bin/bash /home/sh/get_lo_traffic.sh
</pre>
</div>

<p>
不过这样会有讨厌的邮件产生，也可以在脚本中用 while true 循环，配合
sleep 300 让脚本一直运行，而不是重复启动脚本。具体选择那样你自己决定。
</p>

<p>
当所有的准备工作都完成后，就可以开始考虑建库了。
</p>
</div>
</div>
</div>
<div id="outline-container-h:c9831d60-eeb0-46ec-a13c-c0b6e77d6c52" class="outline-3">
<h3 id="h:c9831d60-eeb0-46ec-a13c-c0b6e77d6c52">4. 建立 RRD 数据库</h3>
<div class="outline-text-3" id="text-h:c9831d60-eeb0-46ec-a13c-c0b6e77d6c52">
<pre class="example" id="org6bda631">
准备工作都做完了，脚本也写完了，就可以开始建库了。建库实际上就是建立后缀名为 .rrd 的 RRD 文件。
</pre>
</div>
<div id="outline-container-h:6f47a585-01b3-4d0e-81d8-78f6ab19c1b8" class="outline-4">
<h4 id="h:6f47a585-01b3-4d0e-81d8-78f6ab19c1b8">4.1 语法格式</h4>
<div class="outline-text-4" id="text-h:6f47a585-01b3-4d0e-81d8-78f6ab19c1b8">
<div class="org-src-container">
<pre class="src src-sh">rrdtool create filename [--start|-b start time] [--step|-s step] 
                         [DS:ds-name:DST:dst arguments]  
                         [RRA:CF:cf arguments]
</pre>
</div>

<p>
其中 filename 、DS 部分和 RRA 部分是必须的。其他两个参数可免。
</p>

<p>
我们用一个官方例子对整个语法进行解释（以下都用这个例子说明参数的使用）：
</p>

<pre class="example" id="org95c2628">
rrdtool create target.rrd
--start 1023654125
--step 300
DS:mem:GAUGE:600:0:671744
RRA:AVERAGE:0.5:12:24
RRA:AVERAGE:0.5:288:31
</pre>
</div>
</div>
<div id="outline-container-h:588bfb09-fe2a-4786-a55b-90d9fdda72c5" class="outline-4">
<h4 id="h:588bfb09-fe2a-4786-a55b-90d9fdda72c5">4.2 参数解释</h4>
<div class="outline-text-4" id="text-h:588bfb09-fe2a-4786-a55b-90d9fdda72c5">
<ul class="org-ul">
<li><code>&lt;filename&gt;</code> ： 默认是以 .rrd 结尾，但也以随你设定。</li>

<li>&#x2013;step ： 集数据的间隔时间，默认是5分钟。习惯上我们会设 300(秒)，当
然你可以自行调整，这也是RRD的优势所在。但是采集周期不应该过短 也不应
小于你的update rrd文件周期，否则可能会造成服务器负载过重。 和 MRTG
的 interval同样含义。默认是5分钟。我们的脚本也应该是每5分钟运行一 次。</li>

<li><p>
&#x2013;start ： 这个参数可以指定 filename 的数据记录起始日期，你可以指定
为 1970 年至今的秒数（参数为-b <code>date -d "1970/01/01" +%s</code> ），如果你
不指定，那么起始时间默认就是现在。 RRDtool 不会接受任何采样时间小于
或者等于指定时间的数据。也就是说 &#x2014;start指定了数据库最早的那个记录
是从什么时候开始的。 如果 update 操作中给出的时间在 &#x2014;start 之前，
则 RRDtool拒绝接受。 &#x2013;satrt 选项也是可选的。按照 我们在前一篇中的设
定，则默认是当前时间减去 600*300秒，也就是50个小时前。 如果你想指
定&#x2013;start 为1天前，可以用
</p>

<pre class="example" id="org39b54a6">
--start $(date -d '1 days aog' +%s)
</pre>

<p>
注意，&#x2013;start 选项的值必须是 timestamp 的格式。
</p></li>
</ul>
</div>
</div>
<div id="outline-container-h:2fa26253-cc1b-42a6-a0e9-5a84f8100d52" class="outline-4">
<h4 id="h:2fa26253-cc1b-42a6-a0e9-5a84f8100d52">4.3 DS:ds-name:DST:dst arguments</h4>
<div class="outline-text-4" id="text-h:2fa26253-cc1b-42a6-a0e9-5a84f8100d52">
<pre class="example" id="orgc693165">
DS:ds-name:{GAUGE | COUNTER | DERIVE | DCOUNTER | DDERIVE | ABSOLUTE}:heartbeat:min:max
DS:ds-name:COMPUTE:rpn-expression
</pre>
</div>
<div id="outline-container-h:39bf10fb-b7ce-4065-9ebc-8e93c7201a7d" class="outline-5">
<h5 id="h:39bf10fb-b7ce-4065-9ebc-8e93c7201a7d">4.3.1 DS ：DS 用于定义 Data Soure 。也可以理解为声明数据变量的关键字。</h5>
<div class="outline-text-5" id="text-h:39bf10fb-b7ce-4065-9ebc-8e93c7201a7d">
</div>
</div>
<div id="outline-container-h:69081947-de68-48ae-9876-225ee0ae6a4a" class="outline-5">
<h5 id="h:69081947-de68-48ae-9876-225ee0ae6a4a">4.3.2 DS-NAME：变量名，可以理解为你给这个数据源起的助记符(变量名)（简称DSN）。</h5>
<div class="outline-text-5" id="text-h:69081947-de68-48ae-9876-225ee0ae6a4a">
<ol class="org-ol">
<li>当每一个刷新周期到来的时候，数据文档中各变量对应的值就会被更新。这
个变量对应的值在官方文档中也叫做主要数据点――PDP（Primary Data
Point）。</li>
<li>DSN 从 1-19 个字符，必须是 0-9,a-z,A-Z 。像我们前面提到的 eth0_in
,eth0_out, lo_in , lo_out 。</li>
</ol>
</div>
</div>
<div id="outline-container-h:332609d2-ec73-44ee-b7f9-f10830fed7c7" class="outline-5">
<h5 id="h:332609d2-ec73-44ee-b7f9-f10830fed7c7">4.3.3 DST：DS数据源的类型，有 COUNTER、GUAGE、DERIVE、ABSOLUTE、COMPUTE 5种。官方介绍了7 种</h5>
<div class="outline-text-5" id="text-h:332609d2-ec73-44ee-b7f9-f10830fed7c7">
<ol class="org-ol">
<li>GAUGE：我们用的最多的就是GAUGE了，它的中文解释是：测量。在这里它表
示实际的值。比如说输入次序为98 100 98，那么输出顺序也是98 100 98。</li>
<li>COUNTER：累计值，必须是递增的,除非是计数器溢出(overflows)。在这种情
况下,RRDtool会自动修改收到的值。例如网络接口流量、收到的packets数量
都属于这一类型。自己进行计算，比如说输入次序为98 100 98，那么输出顺
序也是2 -2，怎么出来的这两个数值呢？100-98 98-100，其实就是两个差值，
它表示的是经过一个刷新周期的变化率。</li>
<li>DERIVE：和 COUNTER类似。但可以是递增,也可以递减,或者一会增加一会儿
减少。</li>
<li>ABSOLUTE：它每次都假定前一个interval的值是0,再计算平均值。
COUNTER/DERIVE/AVSOLVTE虽然都是取差值,但会再除以两次间隔间的秒数。
例,两次间隔间为300秒,那画出来的就是2/300,-2/300 的值</li>
<li>COMPUTE : COMPUTE比较特殊,它并不接受输入,它的定义是一个表达式,能够
引用其他DS并自动计算出某个值。例如：</li>
</ol>

<div class="org-src-container">
<pre class="src src-sh">DS:eth0_bytes:COUNTER:600:0:U DS:eth0_bits:COMPUTE:bytes,8,*
</pre>
</div>

<p>
则 eth0_bytes 每得到一个值，eth0_bits 会自动计算出它的值：将
eth0_bytes的值乘以 8 。不过 COMPUTE 型的 DS 有个限制，只能应用
</p>

<div class="org-src-container">
<pre class="src src-sh">&#20877;&#32473;&#20986;&#19968;&#20010;&#20363;&#23376;&#24110;&#21161;&#22823;&#23478;&#29702;&#35299;&#65306;

Values = 300, 600, 900, 1200 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23454;&#38469;&#20540;&#36755;&#20837;&#20540;&#65288;&#27599;&#38548;300S&#36755;&#20837;&#19968;&#20010;&#65289;</span>
Step = 300 seconds <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21047;&#26032;&#21608;&#26399;</span>
COUNTER DS = 1, 1, 1, 1 <span style="color: #b22222;"># </span><span style="color: #b22222;">COUNTER&#23450;&#20041;&#30340;DS&#30340;&#20540;&#12290;(300-0)/300&#65292;(600-300)/300&#65292;(900-600)/300&#65292;(1200-900)/300 &#65292;&#25152;&#20197;&#32467;&#26524;&#20026; 1&#65292;1&#65292;1&#65292;1</span>
DERIVE DS = 1, 1, 1, 1 <span style="color: #b22222;"># </span><span style="color: #b22222;">DERIVE&#23450;&#20041;&#30340;DS&#30340;&#20540;&#12290;&#21516;&#19978;</span>
ABSOLUTE DS = 1, 2, 3, 4 <span style="color: #b22222;"># </span><span style="color: #b22222;">ABSOLUTE&#23450;&#20041;&#30340;DS&#30340;&#20540;&#12290;(300-0)/300,(600-0)/300 , (900-0)/300, (1200-0)/300&#65292;&#25152;&#20197;&#32467;&#26524;&#20026; 1&#65292;2&#65292;3&#65292;4</span>
GAUGE DS = 300, 600, 900, 1200 <span style="color: #b22222;"># </span><span style="color: #b22222;">GAUGE&#23450;&#20041;&#30340;DS&#30340;&#20540;&#12290;300 , 600 ,900 ,1200 &#19981;&#20570;&#36816;&#31639;&#65292;&#30452;&#25509;&#23384;&#20837;&#25968;&#25454;&#24211;</span>
</pre>
</div>

<p>
所以第一行的 values 并不是 PDP ，后面4行才是 PDP
</p>

<p>
概念：PDP Primary Data Point 。正常情况下每个 interval RRDtool都会收到
一个值；RRDtool 在收到脚本给来的值后 会计算出另外一个值（例如平均值），
这个 值就是 PDP；这个值代表的一般是“xxx/秒”的含义。注意，该值不一定
等于RRDtool收到的那个值。除非是GAUGE ，可以看下面的例子就知道了
</p>
</div>
</div>
<div id="outline-container-h:4928e07f-4dc2-4183-868b-6ea66a98fbd1" class="outline-5">
<h5 id="h:4928e07f-4dc2-4183-868b-6ea66a98fbd1">4.3.4. heartbeat 心跳有效期</h5>
<div class="outline-text-5" id="text-h:4928e07f-4dc2-4183-868b-6ea66a98fbd1">
<pre class="example" id="org516f135">
rrdtool create target.rrd
--start 1023654125
--step 300
DS:mem:GAUGE:600:0:671744
RRA:AVERAGE:0.5:12:24
RRA:AVERAGE:0.5:288:31
</pre>

<pre class="example" id="orgadf617f">
date -d@1023654125 +"%F %T"
2002-06-10 04:22:05
</pre>

<p>
比如在例子中，我们定义了心跳有效时间是600秒，也就是两个刷新周期。举个
例子，在12点的时候没有产生数据，那么前后300S（共600S）的平均值就会绘成
12点的值，但如果在两个刷新周期内，都没有接收到数据更新，那么这个时候，
必须往数据文档中写入一个（UN）UNKNOWN值。这是RRDTool的一个特别的地方。
要知道MRTG在处理网络中断的时候，记录的是0值。这个0和UN还是有一定区别的。
</p>
</div>
</div>
<div id="outline-container-h:3da8ee51-ec73-4e94-aa0a-225a73447210" class="outline-5">
<h5 id="h:3da8ee51-ec73-4e94-aa0a-225a73447210">4.3.5 min:max 记录数据的最小值和最大值</h5>
<div class="outline-text-5" id="text-h:3da8ee51-ec73-4e94-aa0a-225a73447210">
<p>
DS数值的有效范围，超出就是UN喽。也可以写成 U:U 代表不限范围。小技巧：
将数据源建立方式记为 "三文字,三数字"
</p>

<div class="org-src-container">
<pre class="src src-sh">DS:ds-name:DST:heartbeat:min:max

&#26696;&#20363;&#65306;DS:mysql:COUNTER:600:0:100000000
  * DS(Data Source&#65292;&#25968;&#25454;&#28304;)&#34920;&#36798;&#24335;&#24635;&#20849;&#26377;&#20845;&#20010;&#26639;&#20301;&#65306;
  * DS &#34920;&#31034;&#36825;&#20010;&#20026;DS&#34920;&#36798;&#24335;
  * ds-name &#25968;&#25454;&#22495;&#21629;&#21517;
  * DST &#23450;&#20041;&#25968;&#25454;&#28304;&#30340;&#31867;&#22411;
  * heartbeat &#26377;&#25928;&#26399;(heartbeat)&#65292;&#26696;&#20363;&#37324;&#30340;&#20540;&#20026;<span style="color: #8b2252;">'600'</span>&#65292;&#20551;&#35774;&#35201;&#21462;12:00&#30340;&#25968;&#25454;&#65292;&#32780;&#21069;&#21518;300&#31186;&#37324;&#30340;&#20540;(11:55-12:05)&#32463;&#36807;&#24179;&#22343;&#25110;&#26159;&#21462;&#26368;&#22823;&#25110;&#26368;&#23567;&#37117;&#31639;&#26159;12:00&#30340;&#26377;&#25928;&#20540;&#65307;
  * min &#20801;&#35768;&#23384;&#25918;&#30340;&#26368;&#23567;&#20540;&#65292;&#27492;&#20363;&#20801;&#35768;&#26368;&#23567;&#20026;0&#12290;
  * max &#20801;&#35768;&#23384;&#25918;&#30340;&#26368;&#22823;&#20540;&#65292;&#26368;&#22823;&#20026;100000000&#12290;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">rrdtool create Flow.rrd <span style="color: #8b2252;">\</span>
--start $(<span style="color: #ff00ff;">date -d "1 year ago" +%s</span>) <span style="color: #8b2252;">\</span>
--step 300 <span style="color: #8b2252;">\</span>
DS:eth0_in:GAUGE:600:0:5000 <span style="color: #8b2252;">\</span>
DS:eth0_out:GAUGE:600:0:5000 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:1:600 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:6:700 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:24:775 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:288:797 <span style="color: #8b2252;">\</span>
RRA:MAX:0.5:1:600 <span style="color: #8b2252;">\</span>
RRA:MAX:0.5:6:700 <span style="color: #8b2252;">\</span>
RRA:MAX:0.5:24:775 <span style="color: #8b2252;">\</span>
RRA:MAX:0.5:444:797 <span style="color: #8b2252;">\</span>
RRA:MIN:0.5:1:600 <span style="color: #8b2252;">\</span>
RRA:MIN:0.5:6:700 <span style="color: #8b2252;">\</span>
RRA:MIN:0.5:24:775 <span style="color: #8b2252;">\</span>
RRA:MIN:0.5:444:797
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:4e17622b-5511-4480-b844-6727b316c3e7" class="outline-4">
<h4 id="h:4e17622b-5511-4480-b844-6727b316c3e7">4.4 RRA:CF:cf arguments</h4>
<div class="outline-text-4" id="text-h:4e17622b-5511-4480-b844-6727b316c3e7">
<p>
RRA：用于指定数据如何存放。我们可以把一个RRA 看成一个表，各保存不同
interval 的统计结果。 RRA 即 Round Robin Archive，Archive是什么，存档。
比如我们每5分钟产生一条刷新的数据，那么一个小时就是12条。每天就是288条。
这么庞大的数据量，一定不可能都存下来。肯定有一个合并（consolidate）数
据的方式，那么这个就是RRA的作用了。下面具体介绍怎么应用RRA：
</p>

<div class="org-src-container">
<pre class="src src-sh">RRA:{AVERAGE | MIN | MAX | LAST}:xff:steps:rows
</pre>
</div>
</div>
<div id="outline-container-h:7e3b7aaf-408e-4c28-88cf-33fd6b205425" class="outline-5">
<h5 id="h:7e3b7aaf-408e-4c28-88cf-33fd6b205425">4.4.1 RRA：用以声明RRAs的关键字</h5>
<div class="outline-text-5" id="text-h:7e3b7aaf-408e-4c28-88cf-33fd6b205425">
</div>
</div>
<div id="outline-container-h:0c768ff6-8243-4923-b001-3ceba26dd9ce" class="outline-5">
<h5 id="h:0c768ff6-8243-4923-b001-3ceba26dd9ce">4.4.2 CF：consolidation function 合并方式，包含四类：</h5>
<div class="outline-text-5" id="text-h:0c768ff6-8243-4923-b001-3ceba26dd9ce">
<p>
AVERAGE, MIN,MAX, LAST //平均值，最大值，最小值，最后一笔
</p>

<p>
概念：CDP上面说过了，经过一个刷新周期，会获得一个主数据点（PDP），将若
干个PDPs使用合并方式（CF）合并后会产生一个合并数据点CDP（consolidated
data point）。这个值就是存入 RRA 的数据，绘图时使用的也是这些数据
</p>
</div>
</div>
<div id="outline-container-h:024a9cf4-a085-42f5-9df1-702147a03541" class="outline-5">
<h5 id="h:024a9cf4-a085-42f5-9df1-702147a03541">4.4.3 xff：xfiles factor 和unkown数据有关，很多资料都取0.5</h5>
<div class="outline-text-5" id="text-h:024a9cf4-a085-42f5-9df1-702147a03541">
<p>
细心的朋友可能会发现，在 RRA 的定义中有一个数值，固定是 0.5，这个到底
是什么东东呢？ 这个称为 xff 字段，是 xfile factor的缩写。让我们来看它
的定义 ：
</p>

<p>
例如
</p>

<div class="org-src-container">
<pre class="src src-sh">RRA:AVERAGE:0.5:24:600
</pre>
</div>

<p>
这个 RRA 中，每24个 PDP （共两小时）就合成为一个 CDP，如果这 24 个 PDP
中有部分值是 UNKNOWN （原因可以很多），例如1个，那么这个 CDP
</p>

<p>
合成的结果如何呢？是否就为 UNKNOWN 呢？
</p>

<p>
不是的，这要看 xff 字段而定。Xff 字段实际就是一个比例值。0.5 表示一个
CDP 中的所有 PDP 如果超过一半的值为 UNKNOWN ，则该 CDP 的值就被标为
</p>

<p>
UNKNOWN。也就是说，如果24个 PDP中有12个或者超过12个 PDP 的值是 UNKNOWN，
则该 CPD 就无法合成，或者合成的结果为 UNKNOWN；
</p>

<p>
如果是11个 PDP 的值为 UNKNOWN ，则该 CDP 的值等于剩下 13 个 PDP
的平均值。
</p>

<p>
如果一个 CDP 是有2个 PDP 组成，xff 为 0.5 ，那么只要有一个 PDP 为
UNKNOWN ，则该 PDP 所对应的 CDP 的值就是 UNKNOWN 了
</p>
</div>
</div>
<div id="outline-container-h:847e40a2-f190-494e-8b5b-aeaf7dafcf8b" class="outline-5">
<h5 id="h:847e40a2-f190-494e-8b5b-aeaf7dafcf8b">4.4.4 step：有step条PDP合并形成一条CDP</h5>
<div class="outline-text-5" id="text-h:847e40a2-f190-494e-8b5b-aeaf7dafcf8b">
</div>
</div>
<div id="outline-container-h:93a04777-acb1-49ba-9892-b5f1c216481e" class="outline-5">
<h5 id="h:93a04777-acb1-49ba-9892-b5f1c216481e">4.4.5 row：记录的合并数据点CDP条数</h5>
<div class="outline-text-5" id="text-h:93a04777-acb1-49ba-9892-b5f1c216481e">
<p>
我们在例子中对RRA是这样定义的：
</p>

<pre class="example" id="org5f5654b">
rrdtool create target.rrd
--start 1023654125
--step 300
DS:mem:GAUGE:600:0:671744
RRA:AVERAGE:0.5:12:24  //1天
RRA:AVERAGE:0.5:288:31 //1月
</pre>

<p>
对于第一个RRA，12条的PDP（每经过一个刷新周期产生一个PDP）经过
CFed（AVERAGE），也就是取平均值，产生一个CDP，24个CDPs存档。我们一起来
计算一下时间，如果一个周期是300秒，那么12个PDP的产生时间就是一个小时，
也就是一个小时产生一个CDP。24个CDPs时间就是一天。说明通过这条RRA，我们
可以取得一天的数据值。一天后，又经过一个小时。就会产生第25条，那么如何
记录这个第25条数据呢？根据我们这个RRA的定义，它将会替代第一条CDP的位置。
我们通过下面这个图来说明：
</p>

<p>
实例（检测某核心交换的端口）（create_nic_7609.sh）
</p>

<div class="org-src-container">
<pre class="src src-sh">/usr/local/rrd/bin/rrdtool create /www/rrd/NIC_7609.rrd -s 300 <span style="color: #8b2252;">\</span>
DS:ifInOctets1:COUNTER:600:U:U <span style="color: #8b2252;">\</span>
DS:ifInOctets2:COUNTER:600:U:U <span style="color: #8b2252;">\</span>
DS:ifInOctets9:COUNTER:600:U:U <span style="color: #8b2252;">\</span>
DS:ifInOctets11:COUNTER:600:U:U <span style="color: #8b2252;">\</span>
DS:ifInOctets14:COUNTER:600:U:U <span style="color: #8b2252;">\</span>
DS:ifInOctets53:COUNTER:600:U:U <span style="color: #8b2252;">\</span>
DS:ifOutOctets1:COUNTER:600:U:U <span style="color: #8b2252;">\</span>
DS:ifOutOctets2:COUNTER:600:U:U <span style="color: #8b2252;">\</span>
DS:ifOutOctets9:COUNTER:600:U:U <span style="color: #8b2252;">\</span>
DS:ifOutOctets11:COUNTER:600:U:U <span style="color: #8b2252;">\</span>
DS:ifOutOctets14:COUNTER:600:U:U <span style="color: #8b2252;">\</span>
DS:ifOutOctets53:COUNTER:600:U:U <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:1:4800 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:6:2400 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:24:1200 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:288:600 <span style="color: #8b2252;">\</span>
RRA:MAX:0.5:1:4800 <span style="color: #8b2252;">\</span>
RRA:MAX:0.5:6:2400 <span style="color: #8b2252;">\</span>
RRA:MAX:0.5:24:1200 <span style="color: #8b2252;">\</span>
RRA:MAX:0.5:288:600
</pre>
</div>

<p>
我们举例来看
</p>

<div class="org-src-container">
<pre class="src src-sh">RRA:AVERAGE:0.5:1:603 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:6:603 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:24:603 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:288:800 <span style="color: #8b2252;">\</span>
RRA:MAX:0.5:1:603 <span style="color: #8b2252;">\</span>
RRA:MAX:0.5:6:603 <span style="color: #8b2252;">\</span>
RRA:MAX:0.5:24:603 <span style="color: #8b2252;">\</span>
RRA:MAX:0.5:288:800
</pre>
</div>

<pre class="example" id="orge4fe06a">
解释一下，首先你要记得step我们设置为300秒，那么
0.5:1:603
因为我们将step设置为300秒，若原计算时间点为12:00，记录时11:57:30~12:02:30的平均值为主，这个值若在此时间点內只有一笔资料的话，其意即是平均值，所以此一值即表共要记录几笔，603是指要存603笔，超過603筆，則最早一笔將被移出。
0.5:6:603 仅就6解释，取6笔资料(每笔为step值，在此意即5分钟)为平均值( 30 分钟), 存 603 笔
0.5:24:603 24 即2小時
0.5:288:800 288 即1天
请注意,不是0.5:1:603中的1 就是五分钟，这个是依据你的--step值而定，如果--step 3600,那0.5:6:603这一行就是六小时合起來的平均值了。若将 AVERAGE 换成MIN/MAX 的意义则是取该时间点中 (如上例之5min/30min/2hr..)之最大值或最小值，而通常在监测系统时最大值与平均值是比较有实际意义的。下面这个图来帮助你记忆。

RRA:MIN:0.5:1:600 \
RRA:MIN:0.5:6:700 \
RRA:MIN:0.5:24:775 \
RRA:MIN:0.5:288:797 //一般可按cacti标准取值

个人理解
1、CF(N个PDP为一个刻度单位)=CDP
*只限COUNTER、DERIVE、ABSOLUTE、COMPUTE

2、N个PDP为一个刻度单位=CDP
*只限GUAGE

3、xff字段如何计算？
PDP/(PDP UNKNOWN数)

4、PDP数据如何得出？
COUNTER(接收Value)=PDP
DERIVE(接收Value)=PDP
ABSOLUTE(接收Value)=PDP
COMPUTE(接收Value)=PDP
*GUAGE除外
</pre>
</div>
<ul class="org-ul">
<li><a id="h:b5cd48ef-2474-4388-946d-a5f775bc2427"></a>解释度（Resolution）<br>
<div class="outline-text-6" id="text-h:b5cd48ef-2474-4388-946d-a5f775bc2427">
<div class="org-src-container">
<pre class="src src-sh">rrdtool create eth0.rrd <span style="color: #8b2252;">\</span>
--start <span style="color: #8b2252;">"$(</span><span style="color: #ff00ff;">date -d '1 days ago' +%s</span><span style="color: #8b2252;">)"</span> <span style="color: #8b2252;">\</span>
--step 300 <span style="color: #8b2252;">\</span>
DS:eth0_in:COUNTER:600:0:12500000  <span style="color: #8b2252;">\#</span>  600 &#26159; heartbeat&#65307;0 &#26159;&#26368;&#23567;&#20540;&#65307;12500000 &#34920;&#31034;&#26368;&#22823;&#20540;&#65307; 
DS:eth0_out:COUNTER:600:0:U <span style="color: #8b2252;">\#</span> &#22914;&#26524;&#27809;&#26377;&#26368;&#23567;&#20540;/&#26368;&#22823;&#20540;&#65292;&#21487;&#20197;&#29992; U &#20195;&#26367;&#65292;&#20363;&#22914; U:U
RRA:AVERAGE:0.5:1:600 <span style="color: #8b2252;">\#</span>1 &#34920;&#31034;&#23545;1&#20010; PDP &#21462;&#24179;&#22343;&#65292;&#27599;4&#20010; PDP &#21512;&#25104;&#20026;&#19968;&#20010; CDP&#12290;&#23454;&#38469;&#19978;&#23601;&#31561;&#20110; PDP &#30340;&#20540;
RRA:AVERAGE:0.5:4:600 <span style="color: #8b2252;">\#</span> 4 &#34920;&#31034;&#27599;4&#20010; PDP &#21512;&#25104;&#20026;&#19968;&#20010; CDP&#65292;&#20063;&#23601;&#26159;20&#20998;&#38047;&#12290;&#26041;&#27861;&#26159;&#23545;4&#20010;PDP&#21462;&#24179;&#22343;&#65292;
RRA:AVERAGE:0.5:24:600 <span style="color: #8b2252;">\#</span> &#21516;&#19978;&#65292;&#20294;&#25913;&#20026;24&#20010;&#65292;&#20063;&#23601;&#26159;24*<span style="color: #a0522d;">5</span>=<span style="color: #a0522d;">120&#20998;&#38047;</span>=2&#23567;&#26102;&#12290;
RRA:AVERAGE:0.5:288:730# &#21516;&#19978;&#65292;&#20294;&#25913;&#20026;288&#20010;&#65292;&#20063;&#23601;&#26159; 288*<span style="color: #a0522d;">5</span>=<span style="color: #a0522d;">1440&#20998;&#38047;</span>=1&#22825;
</pre>
</div>

<p>
举个例子，如果我们要绘制1小时的数据，也就是60分钟，那么我们可以从第一
个RRA中取出12个 CDP 来绘图；也可以从第2个 RRA 中取出2个 CDP 来绘图。到
底RRDtool 会使用那个呢？
</p>

<p>
让我们看一下 RRA 的定义 ：RRA:AVERAGE:0.5:4:600 。 Resolution 就等于
4 * step = 4 * 300 = 1200 ，也就是说 ，resolution 是每个CDP所代表的时
间范围，或者说 RRA 中每个CDP（记录）之间的时间间隔。所以第一个 RRA 的
resolution 是 1* step=300，第2是 1200，第三个是 24*300=7200，第4个 RRA
是 86400 。默认情况下，RRDtool 会自动挑选合适的 resolution 的那个 RRA
的数据来绘图。我们大可不必关心它。但如果自己想取特定 RRA的数据，就需要
用到它了。 关于 Resolution 我们还会在 fetch 和 graph操作中提到它。
</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:b05725c3-ce9d-4466-9d62-ba49bda103ae" class="outline-4">
<h4 id="h:b05725c3-ce9d-4466-9d62-ba49bda103ae">4.5 开始建库</h4>
<div class="outline-text-4" id="text-h:b05725c3-ce9d-4466-9d62-ba49bda103ae">
<div class="org-src-container">
<pre class="src src-sh">rrdtool create eth0.rrd <span style="color: #8b2252;">\</span>
--start <span style="color: #8b2252;">"$(</span><span style="color: #ff00ff;">date -d '1 days ago' +%s</span><span style="color: #8b2252;">)"</span> <span style="color: #8b2252;">\</span>
--step 300 <span style="color: #8b2252;">\</span>
DS:eth0_in:COUNTER:600:0:U <span style="color: #8b2252;">\</span>
DS:eth0_out:COUNTER:600:0:U <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:1:600 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:4:600 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:24:600 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:288:730

rrdtool create eth0.rrd <span style="color: #8b2252;">\</span>
--start <span style="color: #8b2252;">"$(</span><span style="color: #ff00ff;">date -d '1 days ago' +%s</span><span style="color: #8b2252;">)"</span> <span style="color: #8b2252;">\</span>
--step 300 <span style="color: #8b2252;">\</span>
DS:eth0_in:COUNTER:600:0:12500000  <span style="color: #8b2252;">\ </span>#  600 &#26159; heartbeat&#65307;0 &#26159;&#26368;&#23567;&#20540;&#65307;12500000 &#34920;&#31034;&#26368;&#22823;&#20540;&#65307; 
DS:eth0_out:COUNTER:600:0:U <span style="color: #8b2252;">\#</span> &#22914;&#26524;&#27809;&#26377;&#26368;&#23567;&#20540;/&#26368;&#22823;&#20540;&#65292;&#21487;&#20197;&#29992; U &#20195;&#26367;&#65292;&#20363;&#22914; U:U
RRA:AVERAGE:0.5:1:600 <span style="color: #8b2252;">\ </span>#1 &#34920;&#31034;&#23545;1&#20010; PDP &#21462;&#24179;&#22343;&#12290;&#23454;&#38469;&#19978;&#23601;&#31561;&#20110; PDP &#30340;&#20540;
RRA:AVERAGE:0.5:4:600 <span style="color: #8b2252;">\#</span> 4 &#34920;&#31034;&#27599;4&#20010; PDP &#21462;&#24179;&#22343;&#20540;&#21512;&#25104;&#20026;&#19968;&#20010; CDP&#65292;&#20063;&#23601;&#26159;20&#20998;&#38047;&#12290;&#26041;&#27861;&#26159;&#23545;4&#20010;PDP&#21462;&#24179;&#22343;&#65292;
RRA:AVERAGE:0.5:24:600 <span style="color: #8b2252;">\#</span> &#21516;&#19978;&#65292;&#20294;&#25913;&#20026;24&#20010;&#65292;&#20063;&#23601;&#26159;24*<span style="color: #a0522d;">5</span>=<span style="color: #a0522d;">120&#20998;&#38047;</span>=2&#23567;&#26102;&#12290;
RRA:AVERAGE:0.5:288:730# &#21516;&#19978;&#65292;&#20294;&#25913;&#20026;288&#20010;&#65292;&#20063;&#23601;&#26159; 288*<span style="color: #a0522d;">5</span>=<span style="color: #a0522d;">1440&#20998;&#38047;</span>=1&#22825;


&#27880;&#65306;&#19978;&#38754;&#31532;2-4&#20010; RRA&#30340;&#35760;&#24405;&#25968;&#23454;&#38469;&#19978;&#24212;&#35813;&#26159; 700&#65292;775&#65292;790&#65292;&#32780;&#19981;&#26159; 600&#65292;600&#65292;730&#12290;
600 samples of 5 minutes  (2 days and 2 hours)= 180000 &#31186; &#65288;2.08&#22825;&#65289;
700 samples of 30 minutes (2 days and 2 hours, plus 12.5 days)= 1260000 &#31186; &#65288;14.58&#22825; &#65292;2&#21608;&#65289;
775 samples of 2 hours    (above + 50 days) = 5580000 &#31186; &#65288;64.58 &#22825;&#65292;2&#20010;&#26376;&#65289;
797 samples of 1 day      (above + 732 days, rounded up to 797) = 68860800 &#31186;&#65288;2&#24180;&#65289;
&#21487;&#20197;&#30475;&#20986;&#27599;&#20010; RRA &#37117;&#23384;&#20648;&#20102;&#30456;&#24212;&#21333;&#20301;2&#20493;&#26102;&#38388;&#30340;&#25968;&#25454;&#65292;&#20363;&#22914;&#27599;&#22825;&#30340; RRA &#23384;&#20648;2&#22825;&#30340;&#25968;&#25454;&#65292;&#27599;&#21608;&#30340; RRA &#23384;&#20648;2&#21608;&#30340;&#25968;&#25454;&#65292;&#27599;&#26376;&#30340; RRA &#23384;&#20648;2&#20010;&#26376;&#30340;&#25968;&#25454;&#65292;&#27599;&#24180;&#30340; RRA &#23384;&#20648;2&#24180;&#30340;&#25968;&#25454;

&#22914;&#65306;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#21015;&#21069;4&#20010;RRA&#30340;&#23450;&#20041;&#35828;&#26126;&#22914;&#19979;&#65292;&#20854;&#20182;&#23450;&#20041;&#19982;AVERAGE&#26041;&#24335;&#30456;&#20284;&#65292;&#21306;&#21035;&#26159;&#23384;&#26368;&#22823;&#20540;&#19982;&#26368;&#23567;&#20540;  </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#38548;5&#20998;&#38047;(1*300&#31186;)&#23384;&#19968;&#27425;&#25968;&#25454;&#30340;&#24179;&#22343;&#20540;,&#23384;600&#31508;&#65292;&#21363;2.08&#22825;  </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#38548;30&#20998;&#38047;(6*300&#31186;)&#23384;&#19968;&#27425;&#25968;&#25454;&#30340;&#24179;&#22343;&#20540;,&#23384;700&#31508;&#65292;&#21363;14.58&#22825;&#65288;2&#21608;&#65289;  </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#38548;2&#23567;&#26102;(24*300&#31186;)&#23384;&#19968;&#27425;&#25968;&#25454;&#30340;&#24179;&#22343;&#20540;,&#23384;775&#31508;&#65292;&#21363;64.58&#22825;&#65288;2&#20010;&#26376;&#65289;  </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#38548;24&#23567;&#26102;(288*300&#31186;)&#23384;&#19968;&#27425;&#25968;&#25454;&#30340;&#24179;&#22343;&#20540;,&#23384;797&#31508;&#65292;&#21363;797&#22825;(2&#24180;)  </span>
RRA:AVERAGE:0.5:1:600
RRA:AVERAGE:0.5:6:700
RRA:AVERAGE:0.5:24:775
RRA:AVERAGE:0.5:288:797

&#26816;&#26597;&#19968;&#19979;&#32467;&#26524;
(py3) [root@rabbitmq01 sh]# ll -h eth0.rrd 
-rw-r--r-- 1 root root 42K May 13 15:20 eth0.rrd
</pre>
</div>

<p>
有的人可能会问，上面有两个 DS，那 RRA 中究竟存的是那个 DS
的数据呢？实际上，这些 RRA 是共用的，你只需建立一个
RRA，它就可以用于全部的 DS 。
</p>

<p>
所以在定义 RRA 时不需要指定是给那个 DS 用的。
</p>
</div>
<ul class="org-ul">
<li><a id="h:cb46282c-6b62-4497-8094-872d0a9c1cb0"></a>个人经验：<br>
<div class="outline-text-6" id="text-h:cb46282c-6b62-4497-8094-872d0a9c1cb0">
<p>
每分钟收集数据时，尽量把第一个RRA在存满1天。如果第一个RRA只收集10小时
数据，第二个2天，那么要画1周数据图时只显示10小时的数据线。下面我还是按
照2天、14天、2个月、2年的方式来存数据
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #8b2252;">'RRA:AVERAGE:0.5:1:2880'</span>,  <span style="color: #b22222;"># </span><span style="color: #b22222;">2&#22825;</span>
<span style="color: #8b2252;">'RRA:AVERAGE:0.5:6:3360'</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">14&#22825;</span>
<span style="color: #8b2252;">'RRA:AVERAGE:0.5:24:3870'</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">64.5&#22825;</span>
<span style="color: #8b2252;">'RRA:AVERAGE:0.5:288:3985'</span>, <span style="color: #b22222;"># </span><span style="color: #b22222;">68860800 &#31186;&#65288;2&#24180;&#65289;</span>
<span style="color: #8b2252;">'RRA:MAX:0.5:1:2880'</span>,
<span style="color: #8b2252;">'RRA:MAX:0.5:6:3360'</span>,
<span style="color: #8b2252;">'RRA:MAX:0.5:24:3870'</span>,
<span style="color: #8b2252;">'RRA:MAX:0.5:444:3985'</span>,
<span style="color: #8b2252;">'RRA:MIN:0.5:1:2880'</span>,
<span style="color: #8b2252;">'RRA:MIN:0.5:6:3360'</span>,
<span style="color: #8b2252;">'RRA:MIN:0.5:24:3870'</span>,
<span style="color: #8b2252;">'RRA:MIN:0.5:444:3985'</span>,
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:a9c373e6-cd3a-4f33-8745-8db54f831bde" class="outline-3">
<h3 id="h:a9c373e6-cd3a-4f33-8745-8db54f831bde">5. 如何获取RRD文件的信息</h3>
<div class="outline-text-3" id="text-h:a9c373e6-cd3a-4f33-8745-8db54f831bde">
<p>
获取 RRD 文件的信息
</p>
</div>
<div id="outline-container-h:7993a21e-7eb9-4962-852e-046e81f41a34" class="outline-4">
<h4 id="h:7993a21e-7eb9-4962-852e-046e81f41a34">一）前言</h4>
<div class="outline-text-4" id="text-h:7993a21e-7eb9-4962-852e-046e81f41a34">
<p>
可能你已经颇不亟待的想知道如何往 RRD文件插入数据、如何绘图了吧？hoho，
先别急，在你做这些事情之前，最好先思考以下几个问题：
</p>

<ul class="org-ul">
<li>如果给你一个 RRD 文件，你能知道它的第一次/最后一次 update的时间是在
什么时候吗？</li>

<li>如果你很久之前建立了一个 RRD 文件，现在因为工作原因需要对该 RRD文件
进行一些修改。不过遗憾的是，你已经不记得得当初设置的具体选项和参数了，
这时候该怎么办呢？</li>
</ul>

<p>
这两个问题就对应今天要讲的两个操作 ：first/last 、info 。
</p>

<p>
first就是用于查看该 RRD 文件中某个 RRA的第一个数据是在什么时候插入的
（或者说第一次更新）； last 就是查看该 RRD文件的最近一次更新； info就
是查看 rrd 文件的结构信息。
</p>

<p>
下面就以实际例子来看一下该怎么用这三个命令 ：
</p>
</div>
</div>
<div id="outline-container-h:045ada26-f8d5-4ef1-8ca5-b995d5a3ab7d" class="outline-4">
<h4 id="h:045ada26-f8d5-4ef1-8ca5-b995d5a3ab7d">二）如何查询一个 RRD 文件的结构信息</h4>
<div class="outline-text-4" id="text-h:045ada26-f8d5-4ef1-8ca5-b995d5a3ab7d">
<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool info eth0.rrd        &#65288;&#30001;&#20110;&#36755;&#20986;&#20449;&#24687;&#36739;&#22810;&#65292;&#25130;&#21462;&#20102;&#19968;&#37096;&#20998;&#65289;
filename = <span style="color: #8b2252;">"eth0.rrd"</span>
rrd_version = <span style="color: #8b2252;">"0003"</span>
step = 300                                        <span style="color: #b22222;"># </span><span style="color: #b22222;">RRDtool &#24076;&#26395;&#27599;5&#20998;&#38047;&#25910;&#21040;&#19968;&#20010;&#25968;&#25454;</span>
last_update = 1163862985                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#26159;&#26368;&#36817;&#19968;&#27425;&#26356;&#26032;&#30340; timestamp &#12290;&#21487;&#20197;&#29992; date &#36716;&#25442;&#20026;&#20855;&#20307;&#30340;&#26102;&#38388;date -d '@1163862985'</span>
ds[eth0_in].type = <span style="color: #8b2252;">"COUNTER"</span>                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26377;&#19968;&#20010;&#21517;&#20026; eth0_in &#30340; DS&#65292;DST&#26159; COUNTER</span>
ds[eth0_in].minimal_heartbeat = 600        <span style="color: #b22222;"># </span><span style="color: #b22222;">hearbeat &#26102;&#38388;&#26159;600 &#31186;</span>
ds[eth0_in].min = 0.0000000000e+00        <span style="color: #b22222;"># </span><span style="color: #b22222;">eth0_in &#30340;&#26368;&#23567;&#20540;&#26159; 0 &#65288;bytes&#65289;</span>
ds[eth0_in].max = 1.2500000000e+07        <span style="color: #b22222;"># </span><span style="color: #b22222;">eth0_in &#30340;&#26368;&#22823;&#20540;&#26159; 1250000000 &#65288;bytes&#65289;</span>
ds[eth0_in].last_ds = <span style="color: #8b2252;">"UNKN"</span>        
ds[eth0_in].value = 0.0000000000e+00
ds[eth0_in].unknown_sec = 85
ds[eth0_out].type = <span style="color: #8b2252;">"COUNTER"</span>
ds[eth0_out].minimal_heartbeat = 600
ds[eth0_out].min = 0.0000000000e+00
ds[eth0_out].max = 1.2500000000e+07
ds[eth0_out].last_ds = <span style="color: #8b2252;">"UNKN"</span>
ds[eth0_out].value = 0.0000000000e+00
ds[eth0_out].unknown_sec = 85
rra[0].cf = <span style="color: #8b2252;">"AVERAGE"</span>                                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#19968;&#20010; RRA &#30340;&#32534;&#21495;&#26159;0&#65292;&#19981;&#26159;1&#12290;</span>
rra[0].rows = 600                                        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20849;&#20445;&#23384; 600 &#20010;&#35760;&#24405;</span>
rra[0].pdp_per_row = 1                        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#20010; CDP &#30001;&#19968;&#20010; PDP &#32479;&#35745;&#24471;&#20986;</span>
rra[0].xff = 5.0000000000e-01                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21482;&#35201;&#24403;&#21069;interval &#30340; PDP &#20026; unknown &#65292;&#21017;&#35813; CDP &#30340;&#20540;&#20063;&#26159;unknown</span>
rra[0].cdp_prep[0].value = NaN
rra[0].cdp_prep[0].unknown_datapoints = 0
rra[0].cdp_prep[1].value = NaN
rra[0].cdp_prep[1].unknown_datapoints = 0
rra[1].cf = <span style="color: #8b2252;">"AVERAGE"</span>                                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#20108;&#20010; RRA &#30340;&#32534;&#21495;&#26159; 1&#12290;&#21516;&#26679;&#20063;&#26159; AVERAGE &#22411;&#12290;</span>
rra[1].rows = 600                                        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20063;&#26159;&#20445;&#23384; 600 &#20010;&#35760;&#24405;</span>
rra[1].pdp_per_row = 4                        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#20010; CDP &#30001;4&#20010; PDP &#30340;&#27714;&#24179;&#22343;&#20540;&#24471;&#20986;</span>
rra[1].xff = 5.0000000000e-01                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;&#20010; CDP &#26368;&#22810;&#20801;&#35768;2&#20010; PDP &#20026; unknown &#65292;&#36229;&#36807;&#21017;&#35813; CDP &#20026;unknown</span>
rra[1].cdp_prep[0].value = NaN
rra[1].cdp_prep[0].unknown_datapoints = 3
rra[1].cdp_prep[1].value = NaN
rra[1].cdp_prep[1].unknown_datapoints = 3
[root@dns1 bob]#
</pre>
</div>

<p>
由于信息太长，这里截取了后面2个 RRA 的信息。
</p>
</div>
</div>
<div id="outline-container-h:507ac785-9ccb-46cc-b1eb-b3f19d272dea" class="outline-4">
<h4 id="h:507ac785-9ccb-46cc-b1eb-b3f19d272dea">三）第一次更新/最近一次更新</h4>
<div class="outline-text-4" id="text-h:507ac785-9ccb-46cc-b1eb-b3f19d272dea">
<p>
如果想知道最近一次更新发生在什么时候，除了可以用上面的 info
操作，还可以用 last 操作
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@rabbitmq01 sh]# rrdtool last eth0.rrd 
1557645649
[root@rabbitmq01 sh]# date -d <span style="color: #8b2252;">'@1557645649'</span> +<span style="color: #8b2252;">'%F %T'</span>
2019-05-12 15:20:49


&#22914;&#26524;&#36716;&#25442;&#25104;&#20855;&#20307;&#30340;&#26102;&#38388;&#23601;&#26159; &#65306;
[root@dns1 bob]# rrdtool last eth0.rrd |xargs -i date -d <span style="color: #8b2252;">'1970-01-01 {} sec utc'</span>
&#20845; 11&#26376; 18 23:16:25 CST 2006
</pre>
</div>

<pre class="example" id="org63af8b6">
[root@dns1 bob]# rrdtool first eth0.rrd
1163683200

如果换成具体的时间就是 ：
[root@dns1 bob]# [root@dns1 bob]# rrdtool first eth0.rrd |xargs -i date -d '1970-01-01 {} sec utc' 
四 11月 16 21:20:00 CST 2006
[root@dns1 bob]#
</pre>

<p>
这三个命令的语法都非常简单，但并不可以因此小看它们的功能，尤其是 info
操作。日后如果需要对 RRD 文件进行调整，是经常需要用到的。
</p>
</div>
</div>
</div>
<div id="outline-container-h:9dd80630-f89a-4575-9d73-8b3bb2b6e501" class="outline-3">
<h3 id="h:9dd80630-f89a-4575-9d73-8b3bb2b6e501">6. 更新RRD文件</h3>
<div class="outline-text-3" id="text-h:9dd80630-f89a-4575-9d73-8b3bb2b6e501">
</div>
<div id="outline-container-h:25594a92-a82d-43cc-81fb-dd68888cd010" class="outline-4">
<h4 id="h:25594a92-a82d-43cc-81fb-dd68888cd010">一）前言</h4>
<div class="outline-text-4" id="text-h:25594a92-a82d-43cc-81fb-dd68888cd010">
<p>
写了N多东东，总算到了 update 部分了。这里有必要比较一下 RRDtool 和 MRTG
在 update 方面的差别。
</p>

<ul class="org-ul">
<li><p>
MRTG 可以通过 SNMP 协议直接访问 SNMP 对象，你只需要在 cfg 文件中的
Target 指定 OID ，MRTG 就可以自动替你取回数据。
</p>

<p>
例如Target[as1_eth0]: 2:n7css@172.17.64.11:::::1 ，表示使用 SNMP v1
协议访问 172.17.64.11 主机上 index 为 2 的那个接口，
</p>

<pre class="example" id="org6e23d38">
默认是取 ifInOctets 和 ifOutOctets 这两个对象的值。RRDtool 则没有这个功能，只能你自己写脚本取数据。
</pre></li>

<li>MRTG 只支持 COUNTER 和 GAUGE 类型的 Target ；RRDtool 则还可以使用
DERIVE、ABSOLUTE、COMPUTE</li>

<li><p>
由于上面的原因，MRTG 无法识别小数，负数。例如你给 MRTG 一个 -1 的值，
它会解释为 1 ；这点可以通过 LOG 看出来。
</p>

<pre class="example" id="orga8469ea">
小数也不行。例如 .72 （bc 的输出）会被识别为 72 ，而不是 0.72。
</pre></li>

<li>MRTG 每次 update 每次运行只更新一次，或者说只插入一行记录。但
RRDtool 可以在一个 updat操作中插入多个记录。</li>

<li>MRTG 一次要求2个值，RRDtool 则没有该方面的限制。</li>

<li>最大的一个区别是， MRTG 在收到一个值后会自动得出 timestamp ，并记录
在 log 的第一个字段；而 RRDtool 是需要你给出一个 timestamp ，表示该
数据是什么时间采集的。</li>
</ul>
</div>
</div>
<div id="outline-container-h:6816a64c-331f-4d3a-8c5d-8c5d7dbaa165" class="outline-4">
<h4 id="h:6816a64c-331f-4d3a-8c5d-8c5d7dbaa165">二）update 操作的语法格式</h4>
<div class="outline-text-4" id="text-h:6816a64c-331f-4d3a-8c5d-8c5d7dbaa165">
<div class="org-src-container">
<pre class="src src-sh">rrdtool {update | updatev} filename [--template|-t ds-name[:ds-name]...]
[--daemon|-d address] [--] N|timestamp:value[:value...]  at-timestamp@value[:value...]
[timestamp:value[:value...] ...]
</pre>
</div>

<p>
N 表示 now 的意思，会被 RRDtool 替换为当前的 timestamp ，也就是 date
+%s的结果。Timestamp 部分比较灵活，可以是数字形式，也可以是AT-风格的时
间（参考 at 命令的 manual），有点类似于自然语言的风格。
</p>
</div>
</div>
<div id="outline-container-h:699f949b-d7c1-4c9a-8544-aaaf55e1dbfa" class="outline-4">
<h4 id="h:699f949b-d7c1-4c9a-8544-aaaf55e1dbfa">三）手工方式 update 数据库</h4>
<div class="outline-text-4" id="text-h:699f949b-d7c1-4c9a-8544-aaaf55e1dbfa">
<p>
我们先学习一下如何手工 update 数据库。Update 命令分成两部分 ：
</p>

<ul class="org-ul">
<li><p>
时间戳 （timestamp）：表示该数据是在那个时间点采集的。Timestamp 的格式可以非常灵活 ：
</p>

<p>
数字形式 ：例如1164419418 ，表示 "六 11月 25 09:50:18 CST 2006"。通
常用于手工插入的方式。
</p>

<p>
快捷方式 ：N 。字母N 表示当前时间（Now）。如果是通过 crontab 的方式
来运行 update 操作，这是最实用的方式。
</p>

<p>
AT-风格 ：所谓的 AT 风格的时间，可以参考 at 命令的 manual。例如now、
yesterday、now-1hour、now+5min 都是 AT风格的时间。
</p>

<p>
AT风格的时间，则时间和第一个value之间使用 @ 分隔，而不是 ":"
</p></li>

<li>数值部分 ：一个 RRD 文件可以有多个 DS ，所以一次 update 可以给出多个
value 。多个 value 之间用 ":" 分隔。不过是不是所有的 DS 都必须给出值
呢？不一定。有时候你只想给出一部分 DS 的值，甚至有时候某些类型的 DS
是不允许赋值的，例如 COMPUTE 型的 DS 就是这样一个例子。</li>
</ul>

<p>
四）实际操作
</p>

<p>
实例一 ：一个错误的例子
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool update eth0.rrd 1163862980:1:2        
ERROR: illegal attempt to update using time 0 when last update time is 1163862985 (minimum one second step)
[root@dns1 bob]#
</pre>
</div>

<p>
咦？为什么出错了呢？是语法错误吗？不是的，RRDtool提示最近一次更新是在
1163862985 这个时候。也就是说，update给出的时间戳必须大于该值。
</p>

<p>
不能等于或者小于该时刻。因为数据一旦插入到 RRA中，就不允许再次修改。所
以 update会检查给出的时间戳是否大于最后一次更新的时间戳，如果不是则报
错，不予执行。那如何才能知道最近一次更新的时间戳呢？还记得前一篇“如何
获取RRD文件的信息”中介绍的last 和 info 命令吗？对了！就是它们。
</p>

<p>
执行一下看看是什么结果 ？
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool last eth0.rrd
1163862985        
[root@dns1 bob]#
</pre>
</div>

<p>
last 操作显示的时间戳和上面的报错信息给出的值一样。这个时间是
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# date -d <span style="color: #8b2252;">'1970-01-01 1163862985 sec utc'</span>
&#20845; 11&#26376; 18 23:16:25 CST 2006
[root@dns1 bob]#
</pre>
</div>

<p>
总之如果要 update 数据库，则 update 操作给出的时间戳必须晚于最后一次
update 的时间。
</p>

<p>
实例二 ：还是一个错误的例子 我们挑 23:16的下一个5分钟23:20作为时间戳吧。
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# date -d <span style="color: #8b2252;">'2006-11-18 23:20'</span> +%s
1163863200
[root@dns1 bob]#
</pre>
</div>

<p>
所以 update 命令为 ：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool update eth0.rrd 1163863200:1
ERROR: expected 2 data source readings (got 1) from 1163863200:1:...
[root@dns1 bob]#
</pre>
</div>

<p>
还是不行？！！ 仔细看错误信息，原来是我们给少了一个值。还记得 info命令
吗？这会儿它派上用场了。
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool info eth0.rrd
filename = <span style="color: #8b2252;">"eth0.rrd"</span>
&#8230;..(&#30465;&#30053;)
last_update = 1163862985
ds[eth0_in].type = <span style="color: #8b2252;">"COUNTER"</span>
ds[eth0_out].type = <span style="color: #8b2252;">"COUNTER"</span>
</pre>
</div>

<p>
原来是2个 DS ，怪不得 RRDtool 会报错了
</p>

<p>
实例三 ：这次应该成功了吧？
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool update eth0.rrd 1163863200:1:2
[root@dns1 bob]#
</pre>
</div>

<p>
这会倒是没有错误信息，那究竟数据是否别插入到 RRA 中了呢？对于该问题，
有两个方法，一个是通过 fetch 操作，从 RRA中提取数据；但这个我们下一篇
再讲。 还有一种方法就是用 updatev 操作来代替update 。updatev 的 v 表示
verbose 的意思，现在就来看 updatev 的作用 ：
</p>

<p>
实例四 ：updatev 的好处 我们执行多个 update 操作
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool last eth0.rrd
1163864400
[root@dns1 bob]#
[root@dns1 bob]# rrdtool update eth0.rrd 1163864700:3000:4000
[root@dns1 bob]# rrdtool updatev eth0.rrd 1163865000:3300:4600
return_value = 0
[1163865000]RRA[AVERAGE][1]DS[eth0_in] = 1.0000000000e+00
[1163865000]RRA[AVERAGE][1]DS[eth0_out] = 2.0000000000e+00
</pre>
</div>

<p>
可以看到 return value 是 0，这个 return value 你可以理解为 shell编程中
的 exit status 。updatev用 0 表示成功，-1 表示失败。不过我们插入的值明
明是 3300 和 4600 ，为什么出来的结果是 1和2 呢？这是因为 eth0_in 和
eth0_out 都是 COUNTER 型的 DS，所以 RRDtool 在收到3300 和 4600 后，会
作一个运算，就是 （3300-3000）/ step （300）= 1，（4600-4000）
/step（300）=2 ，这就是 1和 2这两个值的来源了。还记得前面提到的 PDP 吗？
这两个值 （1 和2）就是 PDP了，而不是 3300 和 4600 。这点要搞清楚。
</p>

<p>
实例五 ：另外一个 updatev 的例子
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]#
[root@dns1 bob]# rrdtool updatev eth0.rrd 1163865300:3300:4600
return_value = 0
[1163865300]RRA[AVERAGE][1]DS[eth0_in] = 0.0000000000e+00
[1163865300]RRA[AVERAGE][1]DS[eth0_out] = 0.0000000000e+00
[root@dns1 bob]#
</pre>
</div>

<p>
在1163865300 这个时刻我们给出的值和上次一样，所以 eth0_in 和 eth0_out
的PDP 都为 0
</p>

<p>
搞清楚了 PDP 的概念，现在我们来看什么是 CDP ，以及 CDP 是如何计算的
</p>

<p>
实例六 ：通过 updatev 掌握 CF 的概念
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool updatev eth0.rrd 1163865600:4000:5000
return_value = 0
[1163865600]RRA[AVERAGE][1]DS[eth0_in] = 2.3333333333e+00
[1163865600]RRA[AVERAGE][1]DS[eth0_out] = 1.3333333333e+00
[1163865600]RRA[AVERAGE][4]DS[eth0_in] = 1.6666666667e+00
[1163865600]RRA[AVERAGE][4]DS[eth0_out] = 1.6666666667e+00
[1163865600]RRA[AVERAGE][24]DS[eth0_in] = NaN
[1163865600]RRA[AVERAGE][24]DS[eth0_out] = NaN
[root@dns1 bob]#
</pre>
</div>

<p>
这次的输出和上次又不一样了。这次 update 操作影响到几个 RRA ，看到 []中
的 1，4，24 了吗？它们就是代表不同的 RRA 中每个 CDP 所包含的 PDP数量。
</p>

<p>
1 就是 1个 CDP 包含1 个 PDP，4 就是 一个 CDP 包含4个 PDP（20分钟）、24
就是 一个 CDP 包含24个 PDP（2小时）。
</p>

<p>
不过为什么没有 288 呢？eth0.rrd 的第4个 RRA 不是规定每288个 PDP
合并为一个 CDP 吗？
</p>

<p>
因为这个时候还轮不到它出场。1163865600 / 7200 = 161648 ,
也就是说刚好1163865600 是在 7200 的某个周期上（161648）。
</p>

<p>
但1163865600 / 86400 ≈ 13470.66 ，说明1163865600 还不到 86400 的周期。
</p>

<p>
必须等到13471* 86400=1163894400 才会出现 [288] 的CDP，那这个时间戳代表
的时间是什么时候呢？看下面的 date 命令就知道了 ：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# date -d <span style="color: #8b2252;">'1970-01-01 1163894400 sec utc'</span>
&#26085; 11&#26376; 19 08:00:00 CST 2006
[root@dns1 bob]#
[root@dns1 root]# date -d <span style="color: #8b2252;">'1970-01-01 1163865600 sec utc'</span> 
&#26085; 11&#26376; 19 00:00:00 CST 2006
[root@dns1 root]#
</pre>
</div>

<p>
这样不就是刚好相差1天的时间了吗？你可能会觉得很奇怪，为什么不是00:00
而是 08:00呢？
</p>

<p>
还记得create 操作的语法吗？其中有一个 &#x2013;start参数吗？不记得了？没关系，
那就得用 first 操作来重新找出来，
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool first eth0.rrd --rraindex 3
1100822400
[root@dns1 bob]#
[root@dns1 bob]# date -d <span style="color: #8b2252;">'1970-01-01 1100822400 sec utc'</span>
&#20116; 11&#26376; 19 08:00:00 CST 2004
[root@dns1 bob]#
</pre>
</div>

<p>
看到了吗？是 2004 年的 11 月19日早上8点正，距离 2006-11-19
刚好是2年，也就是 730 天，因为 eth0.rrd 的第4个RRA
</p>

<p>
只保存730个记录。每个记录时间上相差1天。也就是第一个记录是 2004/11/19
8:00 ,第二个记录是 2004/11/20 8:00 ，
</p>

<p>
第三个记录代表 2004/11/21 8:00 ，依次类推。所以离1163865600最近的下一
个记录是发生在 2006/11/19 8:00 。
</p>

<p>
所以严格意义上来说，RRDtool 中的一天并不一定是从 0:00开始的，但可以保
证的就是两个记录之间肯定相差86400秒（1天）。
</p>
</div>
</div>
<div id="outline-container-h:c4805594-7dbc-481f-ac6b-f6540a5a5021" class="outline-4">
<h4 id="h:c4805594-7dbc-481f-ac6b-f6540a5a5021">四）自动更新数据库</h4>
<div class="outline-text-4" id="text-h:c4805594-7dbc-481f-ac6b-f6540a5a5021">
<p>
其实这些都只不过是手工 update时需要注意的一些地方，如果是自动更新数据
库，时间戳方面就交给 RRDtool去处理吧，我们不用操心了。 前面我们已经写
好了一个脚本，现在就用它来更新
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@rabbitmq01 sh]# cat get_eth0_traffic.sh 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#39318;&#20808;&#21462;&#24471; eth0 &#25509;&#21475;&#30340; ifIndex </span>
<span style="color: #a0522d;">index</span>=$(<span style="color: #ff00ff;">snmpwalk -IR -v 1 -c public localhost RFC1213-MIB::ifDescr |grep eth0|cut -d '=' -f 1|cut -d '.' -f 2</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20877;&#36890;&#36807; snmp &#21327;&#35758;&#21462;&#24471; ififInOctets &#21644; ifOutOctets &#30340;&#20540;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#30001;&#20110;&#22312; /etc/snmp.conf &#20013;&#37197;&#32622;&#20102; defVersion &#21644; defCommunity &#65292;&#25152;&#20197; snmpget &#21629;&#20196;&#19981;&#29992;&#25351;&#23450;&#36825;&#20004;&#20010;&#21442;&#25968;</span>
<span style="color: #a0522d;">eth0_in</span>=$(<span style="color: #ff00ff;">snmpget -v 1 -c public  -IR -Os localhost ifInOctets.${index}|cut -d ':' -f 2|tr -d '[:blank:]'</span>)
<span style="color: #a0522d;">eth0_out</span>=$(<span style="color: #ff00ff;">snmpget -v 1 -c public  -IR -Os localhost ifOutOctets.${index}|cut -d ':' -f 2 |tr -d '[:blank:]'</span>)
<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">eth0_in</span>
<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">eth0_out</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#38656;&#35201;&#25105;&#35201;&#29992;&#36825;&#20123;&#25968;&#25454;&#26469;&#26356;&#26032; eth0.rrd &#65292;&#27880;&#24847; update &#26102;&#30340; timestamp &#25105;&#20204;&#29992;&#30340;&#26159; N         </span>
/usr/bin/rrdtool updatev /home/sh/eth0.rrd N:${<span style="color: #a0522d;">eth0_in</span>}:${<span style="color: #a0522d;">eth0_out</span>}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:88d469f7-eeb9-4581-81a0-8a673fc1f621" class="outline-4">
<h4 id="h:88d469f7-eeb9-4581-81a0-8a673fc1f621">五）接下来是什么呢？</h4>
<div class="outline-text-4" id="text-h:88d469f7-eeb9-4581-81a0-8a673fc1f621">
<p>
有了数据，下面该学什么了呢？是绘图吗？ 不是！^_^!! （估计有人快疯了吧）
在绘图之前，你有没有想过 RRDtool 在绘图时如何取数据的呢？
</p>

<p>
例如我想画2小时内的数据，那么我们有4个 RRA ，其 resolution 分别是300，
1200，7200，86400 （还记得什么是 resolution 吗？就是每个 RRA 中两个CDP
相隔的时间）。是从第一个 RRA 取出 7200/300=24 个记录， 还是从第二个RRA
取出 7200/1200=6 个记录呢？或者是从第三个 RRA中取出1个记录就可以呢？这
些问题我们就留待下一篇再学习吧。这里给大家留几个问题 ：
</p>

<ul class="org-ul">
<li>如果 eth0.rrd 在5分钟内收到不止1个更新，结果会怎样？提示：用 updatev
可以看出来了</li>
<li>如果过了 eth0.rrd 在5分钟内没有收到脚本返回的值，是否立即就用
UNKNOWN 作为 PDP 的值？</li>
<li>参考上面的例子，搞清楚 heartbeat 的含义 D）在搞清楚 heartbeat后，再
想一下 heartbeat 和 step 之间的关系。</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:08fe2df4-ff64-4131-9d9f-e7fa226c66e5" class="outline-3">
<h3 id="h:08fe2df4-ff64-4131-9d9f-e7fa226c66e5">7. 从RRD文件中提取数据</h3>
<div class="outline-text-3" id="text-h:08fe2df4-ff64-4131-9d9f-e7fa226c66e5">
</div>
<div id="outline-container-h:5c5ce3b2-d776-4007-a6a1-5660936bb839" class="outline-4">
<h4 id="h:5c5ce3b2-d776-4007-a6a1-5660936bb839">一）前言</h4>
<div class="outline-text-4" id="text-h:5c5ce3b2-d776-4007-a6a1-5660936bb839">
<p>
RRD 是 Round Robin Database的意思，那么是否可以象普通的数据库进行查询
操作呢？ 答案是可以的。fetch就是用来做这种事情的工具。当然 fetch 不能
和 select语句相比，它只是根据用户指定的时间， 从合适的 RRA中取出数据，
并加以格式化。不过和 MRTG相比，已经好很多了，至少你不用取看该死的 log
文件。 实际上，fetch操作其实可以不学，因为 RRDtool 会自动帮你选好数据。
但你如何确定 RRDtool取的数据就是你想要的呢？ 或者说你如何证明 RRDtool
绘制出来的图是正确的呢？ 废话少说，下面开始正文
</p>
</div>
</div>
<div id="outline-container-h:d697a16a-d31c-48bc-baa4-f2563dccad4a" class="outline-4">
<h4 id="h:d697a16a-d31c-48bc-baa4-f2563dccad4a">二）fetch 操作的语法</h4>
<div class="outline-text-4" id="text-h:d697a16a-d31c-48bc-baa4-f2563dccad4a">
<div class="org-src-container">
<pre class="src src-sh">rrdtool fetch filename CF [--resolution|-r resolution] [--start|-s start] [--end|-e end]
</pre>
</div>

<p>
其中 &#x2013;start、&#x2013;end、-r 都是可选的 。RRDtool 默认的 &#x2013;end 是
now，&#x2013;start 是 end-1day ，也就是1天前。
</p>

<p>
CF 可以是 AVERAGE、MAX、MIN、LAST ，当然必须建库时有该 CF 类型的 RRA才
可以查，否则会报错。
</p>
</div>
</div>
<div id="outline-container-h:38975481-276f-43ee-b1fa-dafa6a7bb7fb" class="outline-4">
<h4 id="h:38975481-276f-43ee-b1fa-dafa6a7bb7fb">三）fetch 如何取数据</h4>
<div class="outline-text-4" id="text-h:38975481-276f-43ee-b1fa-dafa6a7bb7fb">
<p>
在确定了时间范围后，RRDtool 会从多个 RRA 中挑选最佳的那个 RRA
的数据。至于什么是“最佳”，则从两个方面考虑 ：
</p>

<p>
A）第一是该 RRA 的数据要尽可能的覆盖所请求的时间范围。如何计算一个 RRA
的覆盖时间呢？以 eth0.rrd 的第一个RRA 为例，
</p>

<pre class="example" id="orgd2b6b84">
有 600 个记录，每个记录相隔300秒，则总的时间覆盖范围是180000 秒≈2天，所以如果 –-start 和 -–end 规定的时间范围

大于2天，则 RRDtool 不会从该 RRA 中取数据。
</pre>

<p>
B）第二是 resolution的要求。还是上面的例子，如果是要画3天的数据，从时
间覆盖范围上来讲，第2、3、4个 RRA 都符合要求。
</p>

<pre class="example" id="org61c2760">
那究竟挑选那个 RRA 的数据呢？如果 fetch 中有指定 –r 选项，则挑选 resolution 等于 –r 指定的值那个 RRA 的数据。如果没有 

–r 选项，则从第一个合适的 RRA 中取数据。
</pre>

<p>
C）fetch 如果不加 &#x2014;start、&#x2013;end、-r ，则默认输出 resolution 最小的那
个RRA 的数据。就像下面的例子1一样。
</p>
</div>
</div>
<div id="outline-container-h:86146f4d-7965-4dd0-943c-46467f1ea9ee" class="outline-4">
<h4 id="h:86146f4d-7965-4dd0-943c-46467f1ea9ee">四）实际例子</h4>
<div class="outline-text-4" id="text-h:86146f4d-7965-4dd0-943c-46467f1ea9ee">
<p>
实例一 ：默认情况
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool fetch eth0.rrd AVERAGE |more
                        eth0_in            eth0_out
1164467700: 1.1337243905e+01 9.6323712631e-02
1164468000: 1.7896453039e+01 0.0000000000e+00
1164468300: 1.8469136234e+01 1.2215723119e+00
&#12290;&#12290;&#12290;&#12290;&#65288;&#20013;&#38388;&#30465;&#30053;&#65289;
1164553800: 6.9634610564e+01 4.9644415243e+01
1164554100: nan nan
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# date                        &#65288;&#24403;&#21069;&#26102;&#38388;&#65289;
&#26085; 11&#26376; 26 23:11:12 CST 2006
[root@dns1 bob]# date -d <span style="color: #8b2252;">'1970-1-1 1164554100 sec utc'</span>                (&#26368;&#21518;&#19968;&#20010;&#35760;&#24405;&#30340;&#26102;&#38388;)
&#26085; 11&#26376; 26 23:15:00 CST 2006
[root@dns1 bob]#
[root@dns1 bob]# date -d <span style="color: #8b2252;">'1970-1-1 1164467700 sec utc'</span>                &#65288;&#31532;&#19968;&#20010;&#35760;&#24405;&#30340;&#26102;&#38388;&#65289;
&#20845; 11&#26376; 25 23:15:00 CST 2006
[root@dns1 bob]#
</pre>
</div>

<p>
fetch 输出的第一列是 timestamp ，表示后面的数据是在什么时间收到
的。”:”后面就是DS的值。fetch 不能指定只取那个 DS 的数据，
</p>

<p>
只能一次性取出全部 DS 的值。可以看到，eth0.rrd 有两个 DS ：eth0_in 和
eth0_out ，每个 DS 的值用 空格进行分隔，一律采用科学记数法的格式。
</p>

<p>
如果 fetch 不指定 &#x2014;start 和 &#x2014;end，则默认取从当前时刻算起，往前1天
的数据（289个记录）。因为现在是 23:11，还不到 23:15,所以最后一个记
</p>

<p>
录的值是 NaN （Not a Number），也就是 UNKNOWN的意思。可以看到，两个记
录之间的时间间隔是300。
</p>

<p>
实例二：使用 &#x2013;start 和 &#x2013;end 指定时间范围
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool fetch eth0.rrd AVERAGE --start 1164467700 --end 1164553800 |more
                        eth0_in            eth0_out
1164468000: 1.7896453039e+01 0.0000000000e+00
1164468300: 1.8469136234e+01 1.2215723119e+00
1164468600: 1.5988336199e+01 1.4417769382e-01
&#12290;&#12290;&#12290;&#12290;&#12290;&#65288;&#20013;&#38388;&#30465;&#30053;&#24456;&#22810;&#65289;
1164553800: 6.9634610564e+01 4.9644415243e+01
1164554100: 1.7481962958e+02 2.3086574912e+02
[root@dns1 bob]#
</pre>
</div>

<p>
可以看到第一个记录和最后一个记录都比 &#x2014;start 和 &#x2014;end 晚了300秒。
</p>

<p>
实例三 ：使用 AT风格的时间
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool fetch eth0.rrd AVERAGE --start end-1day --end 1164553800 |more
                        eth0_in            eth0_out
1164467700: 1.1337243905e+01 9.6323712631e-02
1164468000: 1.7896453039e+01 0.0000000000e+00
&#12290;&#12290;&#12290;&#12290;&#12290;&#12290;&#12290;&#65288;&#20013;&#38388;&#30465;&#30053;&#24456;&#22810;&#65289;
1164554100: 1.7481962958e+02 2.3086574912e+02
[root@dns1 bob]#
</pre>
</div>

<p>
注意 &#x2013;start 的值是 end-1day ，这就是 AT风格的时间。end 就是 &#x2013;end中给
出的1164553800 。具体的时间范围是表示起始时间从1164553800 往前1天 。
</p>

<p>
可以看到，现在第一个记录和实例二相比，提前了300秒。和例2中的 &#x2013;start一
致了。所以能够用 AT风格的时间的时候还是用 AT 风格的时间比较方便。
</p>

<p>
可以省去计算的麻烦，别人也比较容易看。
</p>

<p>
实例四 ：提取指定 resolution 的数据
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool fetch eth0.rrd AVERAGE --start 1164467700 --end start+1day -r 1200 |more
                        eth0_in            eth0_out
1164468000: 1.7899370295e+01 3.8782610300e+00
1164469200: 2.0828335735e+01 3.4166666667e-01
1164470400: 1.4581351504e+01 3.5000000000e-02
&#12290;&#12290;&#12290;&#12290;&#12290;&#12290;&#65288;&#20013;&#38388;&#30465;&#30053;&#24456;&#22810;&#65289;
1164554400: 9.4367707174e+01 9.4866775629e+01
[root@dns1 bob]
</pre>
</div>

<p>
可以看到，现在记录两两之间的时间间隔变成了1200 了。输出的行数为
（86400/1200）+1=73 （72+1）。
</p>

<p>
实例五：如果指定一个不存在的 resolution 呢？
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool fetch eth0.rrd AVERAGE --start 1164467700 --end start+1day -r 1000 |more 
                        eth0_in            eth0_out
1164468000: 1.7899370295e+01 3.8782610300e+00
1164469200: 2.0828335735e+01 3.4166666667e-01
&#12290;&#12290;&#12290;&#12290;&#12290;&#12290;&#65288;&#20013;&#38388;&#30465;&#30053;&#24456;&#22810;&#65289;
1164554400: 9.4367707174e+01 9.4866775629e+01
[root@dns1 bob]#
</pre>
</div>

<p>
我们指定的 resolution 是 1000 ，但并没有那个 RRA 的 resolution 为1000，
所以 RRDtool 挑选了第一个合适的 resolution ， 也就是 1200 的那个RRA 的
数据作为结果输出。注意，RRDtool 只会挑选 resolution 比 &#x2013;r指定的值相等
或者更高的 RRA ，不会挑 选比 &#x2013;r 指定的值小的 RRA。例如在该例子中，
RRDtool 就不会挑选 resolution=300 的第一个 RRA。为什么呢？
</p>

<p>
各位可以自己根据第三部分“fetch 如何提取数据”的两个准则考虑一下
</p>

<p>
实例六 ：再来看一个 &#x2013;r 的例子 如果我不想指定 &#x2014;start 或者 &#x2013;end
，就想看 resolution 为 1200 呢？
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool fetch eth0.rrd AVERAGE -r 1200
                        eth0_in            eth0_out
1164470400: 1.4581351504e+01 3.5000000000e-02
1164471600: 1.9312781373e+01 3.5000000000e-02
&#12290;&#12290;&#12290;&#12290;&#12290;&#65288;&#20013;&#38388;&#30465;&#30053;&#24456;&#22810;&#65289;
1164555600: 8.5249300043e+01 7.0171152327e+01
1164556800: nan nan
[root@dns1 bob]#
</pre>
</div>

<p>
咦？为什么还是使用记录的时间间隔还是 300 秒呢？我们不是指定了 &#x2013;r 1200
吗？ 老实说，这种方法 90% 以上的机率是不会成功吗？那应该怎么办呢？
</p>

<p>
实例七 ：正确使用 &#x2013;r 的方式
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool fetch eth0.rrd AVERAGE -r 1200 --end $(<span style="color: #ff00ff;">(($(date +%s</span>)/1200)*1200)) |more
                        eth0_in            eth0_out
1164470400: 1.4581351504e+01 3.5000000000e-02
1164471600: 1.9312781373e+01 3.5000000000e-02
1164472800: 1.7383358822e+01 3.5000000000e-02
1164474000: 1.4781054841e+01 3.3225406191e-01
&#12290;&#12290;&#12290;&#12290;&#12290;&#12290;&#65288;&#20013;&#38388;&#30465;&#30053;&#24456;&#22810;&#65289;
1164555600: 8.5249300043e+01 7.0171152327e+01
1164556800: nan nan
[root@dns1 bob]#
</pre>
</div>

<p>
现在 resolution 已经变成 1200 的了。同理，如果想看 7200，86400
resolution的 RRA，只要把 end 部分的 （）中的数字替换为相应的值就可以了。
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool fetch eth0.rrd AVERAGE -r 7200 --end $(<span style="color: #ff00ff;">(($(date +%s</span>)/7200)*7200))   
[root@dns1 bob]# rrdtool fetch eth0.rrd AVERAGE -r 86400 --end $(<span style="color: #ff00ff;">(($(date +%s</span>)/86400)*86400))
</pre>
</div>

<p>
实例八 ：关于 fetch 提取数据准则1的测试
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool fetch eth0.rrd --start now-3day AVERAGE |more
                        eth0_in            eth0_out
1164298800: nan nan
1164300000: nan nan
&#12290;&#12290;&#12290;&#12290;&#12290;&#12290;&#65288;&#20013;&#38388;&#30465;&#30053;&#24456;&#22810;&#65289;
1164556800: 6.4118014239e+01 1.8871145267e+01
1164558000: nan nan
[root@dns1 bob]#
</pre>
</div>

<p>
和第一个例子不同，这次的 resolution 是 1200了？为什么呢？因为我们指定
的时间范围是3天，而第一个RRA只保存2天的数据多一点，所以 RRDtool 不会从
该 RRA取数据，那么会从那个 RRA 取数据呢？由于我们没有指定 &#x2013;r 选项，所
以RRDtool 选择1200 的那个 RRA
</p>

<p>
实例九 ：关于 fetch 提取数据准则2的测试
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool fetch eth0.rrd --start now-3day AVERAGE -r 7200 |more
                        eth0_in            eth0_out
1164304800: nan nan
1164312000: nan nan
1164319200: nan nan
&#12290;&#12290;&#12290;&#12290;&#12290;&#12290;&#65288;&#20013;&#38388;&#30465;&#30053;&#24456;&#22810;&#65289;
1164549600: 5.1899602485e+01 4.3073128067e-01
1164556800: 7.9766222122e+01 4.0644151093e+01
1164564000: nan nan
[root@dns1 bob]#
</pre>
</div>

<p>
现在 resolution 不再是 1200 ，而是指定的 7200 了。 因为虽然
resolution=1200 的 RRA 就可以满足 &#x2013;start 和 &#x2013;end 的需求，
</p>

<p>
但因为 -r 指定 resolution=7200 ，所以从第3个 RRA 中取数据
</p>
</div>
</div>
<div id="outline-container-h:69e4730c-74a5-465f-920a-4f775814fb9f" class="outline-4">
<h4 id="h:69e4730c-74a5-465f-920a-4f775814fb9f">五）总结</h4>
<div class="outline-text-4" id="text-h:69e4730c-74a5-465f-920a-4f775814fb9f">
<p>
从上面我们可以看出，fetch实际上是非常复杂的一个命令，如果想要输出你所
要的数据，就必须考虑好几个因素：
</p>

<ul class="org-ul">
<li>第一是具体想输出的时间范围?</li>
<li>第二是计算好 &#x2014;start 和&#x2013;end。建议至少给出一个，最好2个都给出</li>
<li>第三是如果有多个RRA符合条件，则使用 &#x2013;r 指定具体的 resolution</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:97d7adc7-db99-4b87-be94-f214bb285098" class="outline-3">
<h3 id="h:97d7adc7-db99-4b87-be94-f214bb285098">8. 使用RRDtool 进行绘图（一）</h3>
<div class="outline-text-3" id="text-h:97d7adc7-db99-4b87-be94-f214bb285098">
<div class="org-src-container">
<pre class="src src-sh">rrdtool graph  /data/rrdtool_data/MySQL_SQLSlowLog.png <span style="color: #8b2252;">\</span>
-n DEFAULT:10 <span style="color: #8b2252;">\</span>
-s -2day -e now+2day -t <span style="color: #8b2252;">'MySQL_SQLSlowLog week'</span> --x-grid HOUR:12:DAY:1:HOUR:24:0:<span style="color: #8b2252;">'%a'</span> <span style="color: #8b2252;">\</span>
-Y -w 900 -h  400 -v <span style="color: #8b2252;">'count'</span> <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">v_zystraderead_slo</span>=/data/rrdtool_data/MySQL_SQLSlowLog.rrd:zystraderead_slo:LAST <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">v_zysbaseread_slo</span>=/data/rrdtool_data/MySQL_SQLSlowLog.rrd:zysbaseread_slo:LAST <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">v_zystrademaster_slo</span>=/data/rrdtool_data/MySQL_SQLSlowLog.rrd:zystrademaster_slo:LAST <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">v_zysbasemaster_slo</span>=/data/rrdtool_data/MySQL_SQLSlowLog.rrd:zysbasemaster_slo:LAST <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">'\n'</span> <span style="color: #8b2252;">\</span>
LINE2:v_zystraderead_slo#A9A9A9:<span style="color: #8b2252;">'zystraderead_slo    \t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_zystraderead_slo:LAST:<span style="color: #8b2252;">'LAST\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_zystraderead_slo:AVERAGE:<span style="color: #8b2252;">'AVERAGE\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_zystraderead_slo:MAX:<span style="color: #8b2252;">'MAX\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_zystraderead_slo:MIN:<span style="color: #8b2252;">'MIN\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">'\n'</span> <span style="color: #8b2252;">\</span>
LINE2:v_zysbaseread_slo#8B008B:<span style="color: #8b2252;">'zysbaseread_slo     \t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_zysbaseread_slo:LAST:<span style="color: #8b2252;">'LAST\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_zysbaseread_slo:AVERAGE:<span style="color: #8b2252;">'AVERAGE\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_zysbaseread_slo:MAX:<span style="color: #8b2252;">'MAX\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_zysbaseread_slo:MIN:<span style="color: #8b2252;">'MIN\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">'\n'</span> <span style="color: #8b2252;">\</span>
LINE2:v_zystrademaster_slo#00FFFF:<span style="color: #8b2252;">'zystrademaster_slo  \t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_zystrademaster_slo:LAST:<span style="color: #8b2252;">'LAST\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_zystrademaster_slo:AVERAGE:<span style="color: #8b2252;">'AVERAGE\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_zystrademaster_slo:MAX:<span style="color: #8b2252;">'MAX\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_zystrademaster_slo:MIN:<span style="color: #8b2252;">'MIN\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">'\n'</span> <span style="color: #8b2252;">\</span>
LINE2:v_zysbasemaster_slo#0000ff:<span style="color: #8b2252;">'zysbasemaster_slo   \t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_zysbasemaster_slo:LAST:<span style="color: #8b2252;">'LAST\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_zysbasemaster_slo:AVERAGE:<span style="color: #8b2252;">'AVERAGE\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_zysbasemaster_slo:MAX:<span style="color: #8b2252;">'MAX\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_zysbasemaster_slo:MIN:<span style="color: #8b2252;">'MIN\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">'\n'</span> <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">'                                               update\:2019-05-29 17\:20\:24'</span> <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">'                                              Aliyun RDS Report'</span>
</pre>
</div>
</div>
<div id="outline-container-h:180d9727-b5c5-4326-b449-a2fd804aa371" class="outline-4">
<h4 id="h:180d9727-b5c5-4326-b449-a2fd804aa371">一）前言</h4>
<div class="outline-text-4" id="text-h:180d9727-b5c5-4326-b449-a2fd804aa371">
<p>
使用RRDtool我们最关心什么？当然是如何把数据画出来了。虽然前面谈了很多，
但这些都是基础来的。掌握好了，可以让你在绘图时更加得心应手。本来还有
RPN（反向波兰表达式）一节的，但考虑一下，觉得还是放到后面，先从基本的
绘图讲起。这一节的内容虽然很多，但基本都是实验性的内容，只要多试几次就
可以了。
</p>
</div>
</div>
<div id="outline-container-h:e5390439-dc46-4020-b2bc-34f3f5514831" class="outline-4">
<h4 id="h:e5390439-dc46-4020-b2bc-34f3f5514831">二、graph 操作的语法</h4>
<div class="outline-text-4" id="text-h:e5390439-dc46-4020-b2bc-34f3f5514831">
<div class="org-src-container">
<pre class="src src-sh">rrdtool graph|graphv filename [option ...] 
   [data definition ...]
   [data calculation ...]        
   [variable definition ...]
   [graph element ...]
   [print element ...]
</pre>
</div>

<p>
其中的 data definiton、variable definition 、data calculation、分别是
下面的格式
</p>

<div class="org-src-container">
<pre class="src src-sh">DEF:&lt;vname&gt;=&lt;rrdfile&gt;:&lt;ds-name&gt;:&lt;CF&gt;[:<span style="color: #a0522d;">step</span>=&lt;step&gt;][:<span style="color: #a0522d;">start</span>=&lt;time&gt;][:<span style="color: #a0522d;">end</span>=&lt;time&gt;][:<span style="color: #a0522d;">reduce</span>=&lt;CF&gt;]
VDEF:<span style="color: #a0522d;">vname</span>=RPN expression
CDEF:<span style="color: #a0522d;">vname</span>=RPN expression
</pre>
</div>

<p>
其中 filename 就是你想要生成的图片文件的名称，默认是 png。你可以通过选
项修改图片的类型，可以有 PNG、SVG、EPS、PDF四种。
</p>

<p>
A）DEF 是 Definition（定义）的意思。定义一个变量。你要绘图，总要有数据
源吧？DEF 就是告诉RRDtool 从那个 RRD 中取出指定
</p>

<p>
语法：
</p>

<pre class="example" id="org3ce1c95">
DEF:&lt;vname&gt;=&lt;rrdfile&gt;:&lt;ds-name&gt;:&lt;CF&gt;[:step=&lt;step&gt;][:start=&lt;time&gt;][:end=&lt;time&gt;][:reduce=&lt;CF&gt;]
</pre>

<p>
用如下表示更清楚一些
</p>

<pre class="example" id="org5dbb7fc">
DEF:vname=rrd_filename:DS_name:[AVERAGE|MAX..]
</pre>

<p>
主要用处在于您要取出哪个 RRD 档案的 DSN 到这个 graph來。从上很容易看出，
你要定义一个虚拟的变量，变量从（.rrd）数据文件中取得数据源（DS）经过数
据合并（CF）后的数据。看到这里，大家应该知道，前面在定义文档中为什么有
那么多的参数，其实都是为了绘图做准备的。
</p>

<p>
为什么还有一个 CF 字段？因为 RRA 有多种 CF 类型，有些 RRA可能用来保存
平均值、有些 RRA可能用于统计最大值、最小值等等。所以你必须同时指定使用
什么 CF 类型的RRA的数据。至于 :start 和 :end 、:reduce 则用得比较少，
最常用的就是:step 了，它可以让你控制 RRDtool 从那个 RRA 中取数据。
</p>

<p>
B）VDEF 是 Variable Definition （变量定义）的意思。 VDEF语句。但在使用
过程中，却发现 VDEF 的使用反而造成了困扰。 例如你有5个 DS要画，每个 DS
你都想输出最大值、最小值、平均值、当前值。 如果使用 VDEF，则需要 4 * 5
= 20 个 VDEF语句，这会造成极大的困扰。具体例子可以看第十一节“数字报
表”部分。
</p>

<div class="org-src-container">
<pre class="src src-python">
rrdtool graph graph.png /
     --end now --start end-120000s --width 400 /
     -t <span style="color: #8b2252;">"VDEF&#12289;CDEF&#24212;&#29992;&#20030;&#20363;"</span> /
     --font TITLE:14:FZZHYJW.ttf /
     --x-grid MINUTE:30:HOUR:4:HOUR:4:0:%H:%M /                                         
     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27599;30&#20998;&#38047;&#19968;&#26465;&#32447;&#65292;&#27599;4&#23567;&#26102;&#19968;&#26465;&#20027;&#32447;&#65292;4&#23567;&#26102;&#19968;&#20010;&#26631;&#31614;&#26631;&#20110;&#20027;&#32447;&#19979;&#26041;&#65292;&#26631;&#31614;&#26684;&#24335;&#8220;&#23567;&#26102;:&#20998;&#38047;&#8221;</span>
     -Y /
   <span style="color: #a0522d;">DEF</span>:<span style="color: #228b22;">ds0</span>=/home/rrdtool/data/router2.rrd :Inbound :AVERAGE /
   <span style="color: #a0522d;">DEF</span>:<span style="color: #228b22;">ds1</span>=/home/rrdtool/data/router2.rrd :Outbound:AVERAGE /

   <span style="color: #a0522d;">VDEF</span>:<span style="color: #228b22;">ds0max</span>=ds0,MAXIMUM /
   <span style="color: #a0522d;">VDEF</span>:<span style="color: #228b22;">ds0avg</span>=ds0,AVERAGE /
   <span style="color: #a0522d;">VDEF</span>:<span style="color: #228b22;">ds0min</span>=ds0,MINIMUM /
   <span style="color: #a0522d;">VDEF</span>:<span style="color: #228b22;">ds0pct</span>=ds0,95,PERCENT /
   <span style="color: #a0522d;">VDEF</span>:<span style="color: #228b22;">ds1max</span>=ds1,MAXIMUM /
   <span style="color: #a0522d;">VDEF</span>:<span style="color: #228b22;">ds1avg</span>=ds1,AVERAGE /
   <span style="color: #a0522d;">VDEF</span>:<span style="color: #228b22;">ds1min</span>=ds1,MINIMUM /
   <span style="color: #a0522d;">VDEF</span>:<span style="color: #228b22;">ds1pct</span>=ds1,95,PERCENT /

   <span style="color: #a0522d;">CDEF</span>:<span style="color: #228b22;">ds0bits</span>=ds0,8,* /
   <span style="color: #a0522d;">CDEF</span>:<span style="color: #228b22;">ds1bits</span>=ds1,8,* /

   COMMENT:<span style="color: #8b2252;">"          "</span> /
   COMMENT:<span style="color: #8b2252;">"Maximum    "</span> /
   COMMENT:<span style="color: #8b2252;">"Average    "</span> /
   COMMENT:<span style="color: #8b2252;">"Minimum    "</span> /
   COMMENT:<span style="color: #8b2252;">"95th percentile/l"</span> /

   AREA:ds0bits<span style="color: #b22222;">#</span><span style="color: #b22222;">00FF00:"Inbound " /</span>
   GPRINT:ds0max:<span style="color: #8b2252;">"%6.2lf %Sbps"</span> /
   GPRINT:ds0avg:<span style="color: #8b2252;">"%6.2lf %Sbps"</span> /
   GPRINT:ds0min:<span style="color: #8b2252;">"%6.2lf %Sbps"</span> /
   GPRINT:ds0pct:<span style="color: #8b2252;">"%6.2lf %Sbps/l"</span> /

   LINE1:ds1bits<span style="color: #b22222;">#</span><span style="color: #b22222;">FF0000:"Outbound" /</span>
   GPRINT:ds1max:<span style="color: #8b2252;">"%6.2lf %Sbps"</span> /
   GPRINT:ds1avg:<span style="color: #8b2252;">"%6.2lf %Sbps"</span> /
   GPRINT:ds1min:<span style="color: #8b2252;">"%6.2lf %Sbps"</span> /
   GPRINT:ds1pct:<span style="color: #8b2252;">"%6.2lf %Sbps/l"</span> /

   COMMENT:<span style="color: #8b2252;">"/s"</span> /
   VRULE:1186562026<span style="color: #b22222;">#</span><span style="color: #b22222;">000000:x-mark /</span>
   HRULE:1700000000<span style="color: #b22222;">#</span><span style="color: #b22222;">0000FF:y-mark /</span>
   COMMENT:<span style="color: #8b2252;">"         update time/: `date /"</span>+%Y/%m/%d %H/:%M/:%S/<span style="color: #8b2252;">"`"</span> COMMENT:<span style="color: #8b2252;">"/l"</span>
</pre>
</div>



<figure id="orgc53bd28">
<img src="./images/img_20240220_031740.png" alt="img_20240220_031740.png" width="80%">

</figure>

<p>
C）CDEF 是 Calculation Define 的意思。一個虚拟的变数,其值为 DEF的某些
运算,语法如下： 语法：CDEF:vname=rpn-expression先举一个例子，我们从例
子中说明问题。我们取得某端口流入流量的字节数，我们希望画在图上的是bit
为单位，很明显我们要将字节数乘以8。
</p>

<p>
例：
</p>

<pre class="example" id="org548e699">
DEF:in_bytes_1=$RRD_PATH:ifInOctets1:AVERAGE //这句刚刚说过了
CDEF:in_bits_1= 8,in_bytes_1,* //将DEF中定义的in_bytes_1×8放在in_bits_1
</pre>

<p>
很好理解吧？那为什么不写成in_bits_1= in_bytes_1* 8？现在我们回到语法解
释： rpn（Reverse Polish Notation）逆波兰表达式，它的语法规定，表达式
必须以逆波兰表达式的方式给出。那么什么是逆波兰表达式呢？逆波兰表达式又
叫做后缀表达式。
</p>

<p>
D）绘图方式
</p>
<pre class="example" id="orgd899bb6">
AREA:vname[#rrggbb[:legend]]
LINE{1|2|3}:vname[#rrggbb[:legend]]
STACK:vname[#rrggbb[:legend]]

① vname：根据虚拟变量（vname）画图。
② #rrggbb：颜色的16进制表示，可以找个软件来看。
③ legend：对该颜色的提示，最后会写在图上的。
④ 特别的，画线有粗细之分，所以有LINE1－LINE3，line1最细，LINE3最粗。
⑤ AREA 可以画出资料数值至0之间的区块图
⑥ STACK 是表现在的图的值,叠在上一个值上
</pre>

<p>
例子：
</p>

<pre class="example" id="orgd6c8202">
AREA:in_bits_1#00cc00: " Current In"
LINE1:out_bits_1#0000ff: " Current Out "
</pre>

<p>
请注意,如果使用 AREA/STACK 则需特別注意图盖图的问题,一定要先画大的值,
再画小的值,才会有层次的效果,不然,最大的数据若最后画,你就看不到前面的值
了，都被最后一个图给压过去了。
</p>
</div>
</div>
<div id="outline-container-h:0056975e-a48d-4015-943d-247b2653716b" class="outline-4">
<h4 id="h:0056975e-a48d-4015-943d-247b2653716b">三）选项分类</h4>
<div class="outline-text-4" id="text-h:0056975e-a48d-4015-943d-247b2653716b">
<p>
本部分我们按照官方文档的方式，把选项分成几大类，分为 ：
</p>

<p>
A）Time range ：用于控制图表的X轴显示的起始/结束时间，也包括从RRA中提取指定时间的数据。
</p>

<p>
B）Labels ：用于控制 X/Y 轴的说明文字。
</p>

<p>
C）Size ：用于控制图片的大小。
</p>

<p>
D）Limits ：用于控制 Y 轴的上下限。
</p>

<p>
E）Grid ：用于控制 X/Y 轴的刻度如何显示。
</p>

<p>
F）Miscellaneous ：其他选项。例如显示中文、水印效果等等。
</p>

<p>
G）Report ：数字报表
</p>

<p>
需要说明的是，本篇当中并不是列出了所有选项的用法，只是列出较为常用的选
项，如果想查看所有选项的的用法，可以到官方站点下载文档，这里就不一一列
出了，望各位见谅。
</p>
</div>
</div>
<div id="outline-container-h:57b89f3f-7d81-48e0-b2bb-7f6836f05e4b" class="outline-4">
<h4 id="h:57b89f3f-7d81-48e0-b2bb-7f6836f05e4b">四）时间范围控制（Time Range）</h4>
<div class="outline-text-4" id="text-h:57b89f3f-7d81-48e0-b2bb-7f6836f05e4b">
<div class="org-src-container">
<pre class="src src-sh">[-s|--start time] [-e|--end time] [-S|--step seconds]
</pre>
</div>

<p>
既然要绘图，就应该有一个起始/结束的时间。Graph 操作中有 &#x2013;s ，-e选项。
这两个选项即可以用于控制图表的 X 轴显示的时间范围，也可以用于控制
RRDtool 从 RRA 中提取对应时间的数据。如果没有指定 &#x2014;end ，默认为now；
如果没有指定 &#x2014;start，则默认为1天前。如果两者都没有指定，则图表默认显
示从当前算起1天内的。数 回头看一下 DEF 中，也有 :start ,:end , :step
，这些和 &#x2014;start、&#x2013;end、&#x2013;step 之间有什么关系呢？
</p>

<p>
让我们先看 :step 和 &#x2013;step之间的关系是如何的。
</p>

<p>
下面以 eth0.rrrd 为例，假设要绘制的时间范围 range 等于 end -start[
</p>
<div class="org-src-container">
<pre class="src src-sh">rrdtool create eth0.rrd <span style="color: #8b2252;">\</span>
--start <span style="color: #8b2252;">"$(</span><span style="color: #ff00ff;">date -d '1 days ago' +%s</span><span style="color: #8b2252;">)"</span> <span style="color: #8b2252;">\</span>
--step 300 <span style="color: #8b2252;">\</span>
DS:eth0_in:COUNTER:600:0:U <span style="color: #8b2252;">\</span>
DS:eth0_out:COUNTER:600:0:U <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:1:600 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:4:600 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:24:600 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:288:730
</pre>
</div>

<p>
A）如果 0 &lt; ragne &lt; 180000 （第一个 RRA 的时间覆盖范围），则默认从第1
个RRA中取数据 ：
</p>

<pre class="example" id="orgbd53fae">
如果 DEF 中给出的 :step &gt; 300 ，例如 1000 ，则从 resolution= 1000 的或者第一个高于 1000 的RRA 中挑选数据，由于 eth0.rrd 中没有resolution = 1000 的 RRA，则 RRDtool 会从 resolution = 1200 的第2 RRA 中取数据。

如果 DEF 中给出的 :step &lt;= 300 ，例如 200 ，则 RRDtool 会忽略该设定，还是从第一个 RRA 中取数据。
</pre>

<p>
B）如果 180000 &lt; range &lt; 720000，由于第一个RRA只能保存2天的数据，所以
默认从第2个RRA中取数据 ： 如果 DEF中给出的 :step &gt; 1200 ，例如 1800，
则 RRDtool 会从 resolution = 7200的第3 RRA 中取数据
</p>

<pre class="example" id="org74014e4">
如果 DEF 中给出 :step&lt;= 1200，例如 300 ，则 RRDtool 会忽略，还是从第2个 RRA 中取数据
</pre>

<p>
C）如果 720000 &lt; range &lt; 4320000 ，则默认从第三个 RRA 中取数据 ： 如果
DEF 中给出的 :step &gt; 7200 ，例如 10000 ，则从第4个 RRA中取数据
</p>

<pre class="example" id="orgbaf88c1">
如果 DEF 中给出的 :step &lt;= 7200 ， 例如 1200 ，则忽略该值，并还是从第3 个 RRA 中取数据
</pre>

<p>
D）如果 4320000 &lt; range &lt; 63072000 ，则默认从第4个 RRA 中取数据 ： 如
果DEF 中给出的 :step &gt; 86400 ，则行为未知
</p>

<pre class="example" id="orgbdd0072">
如果 DEF 中给出的 :step &lt;=86400 ，则从第4个 RRA 中取数据
</pre>

<p>
E）-S 选项可以直接控制 RRDtool 如何挑选 RRA 。
</p>

<pre class="example" id="org36bff94">
例如 -S 1200 ，即使DEF 中不加 :setp ，则 RRDtool 会从第2个 RRA 中取数据，即使 rang &lt; 180000 

如果 -S 和 :step 同时出现，则 :step 优先。
</pre>

<p>
F）DEF 中的 :start 和 :end 可以覆盖 &#x2014;start 和 &#x2014;end 的值。
</p>

<pre class="example" id="org86485a5">
 默认情况下，如果 DEF 中不加 :start 和 :end ，则等于 –-start 和 –end

如果 DEF 中定义了 :start 和 :end ，则以 :start 和 :end 为准。
</pre>

<p>
<b>实例1 ：使用 &#x2014;start 指定 X 轴的起始时间</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">rrdtool graph 1.png <span style="color: #8b2252;">\</span>
--start now-1day <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
AREA:value1#ff0000 


[root@rabbitmq01 sh]# rrdtool graph 1.png <span style="color: #8b2252;">\</span>
&gt; --start now-120000 <span style="color: #8b2252;">\ </span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#34920;&#31034;&#36215;&#22987;&#26102;&#38388;&#26159;&#24403;&#21069;&#26102;&#38388;&#24448;&#21069; 120000 &#31186;&#65292;&#20063;&#23601;&#26159; 33 &#20010;&#23567;&#26102;&#24038;&#21491;</span>
&gt; DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\ </span># &#20174;eth0.rrd &#20013;&#21462;&#20986; eth0_in &#30340;&#25968;&#25454;&#65292;CF &#31867;&#22411;&#20026; AVERAGE
&gt; AREA:value1#ff0000   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29992;&#8220;&#26041;&#22359;&#8221;&#30340;&#24418;&#24335;&#26469;&#32472;&#21046; value1 &#65292;&#27880;&#24847;&#36825;&#37324;&#26159;&#29992; value1 &#65292;&#19981;&#26159;&#29992; eth0_in</span>
481x141                     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524; RRDtool &#26377;&#32472;&#22270;&#26041;&#38754;&#30340;&#35821;&#21477;&#65292;&#21017;&#36825;&#37324;&#26174;&#31034;&#22270;&#29255;&#22823;&#23567;&#65292;&#21542;&#21017;&#20026; 0x0</span>
</pre>
</div>


<figure id="org2f065f3">
<img src="./images/img_20240220_032347.png" alt="img_20240220_032347.png" width="80%">

</figure>

<p>
可以看到 X 轴的文字有些是乱码，不过不要紧，你可以临时已用 env LANG=C
rrdtool xxxx 来解决该问题，或者在后面用 &#x2013;n 来设定 RRDtool使用中文字体，
就不会出现这样的情况了
</p>

<p>
<b>实例2 ：使用 :step 从第2个RRA中取数据</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">rrdtool graph 2.png <span style="color: #8b2252;">\</span>
--start now-120000 <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">step</span>=1000 <span style="color: #8b2252;">\</span>
AREA:value1#ff0000 

<span style="color: #b22222;"># </span><span style="color: #b22222;">:step &#25351;&#23450; resolution=1000 </span>
</pre>
</div>

<p>
这里是 :step=1000，但 RRDtool 会取 :step=1200 的 第2个 RRA
的数据来绘图,可以和上面的 1.png 比较，发现比较平滑。
</p>


<figure id="org25fa8d6">
<img src="./images/img_20240220_032435.png" alt="img_20240220_032435.png" width="80%">

</figure>


<p>
<b>实例3 ：使用 &#x2013;S 从第2个RRA中取数据</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">rrdtool graph 4.png <span style="color: #8b2252;">\</span>
-S 1200 <span style="color: #8b2252;">\</span>
--start now-120000 <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
AREA:value1#ff0000 

 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992; &#8211;S &#25511;&#21046; RRDtool &#20174; resolution=1200 &#30340; RRA &#20013;&#21462;&#25968;&#25454;</span>
</pre>
</div>


<figure id="org9fd8033">
<img src="./images/img_20240220_032506.png" alt="img_20240220_032506.png" width="80%">

</figure>


<p>
可以看到和上面的图一样，说明 RRDtool 的确按照 -S 的设置从第2个RRA中取
数据了 使用 &#x2013;S 可以对 DEF 中所有的 DS 都使用相同的resolution，等于在
每个 DEF后都加上 :step= ，value 是 &#x2013;S 的值
</p>

<p>
*实例4 ：同时使用 &#x2013;S 和 :step *
</p>

<div class="org-src-container">
<pre class="src src-sh">rrdtool graph 5.png <span style="color: #8b2252;">\</span>
-S 1200 <span style="color: #8b2252;">\</span>
--start now-120000 <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">step</span>=300 <span style="color: #8b2252;">\</span>
AREA:value1#ff0000 

 <span style="color: #b22222;"># </span><span style="color: #b22222;">-S &#25351;&#23450; resolution=1200</span>
 <span style="color: #b22222;"># </span><span style="color: #b22222;">:step &#25351;&#23450; resolution=300</span>
</pre>
</div>


<figure id="orga6fa476">
<img src="./images/img_20240220_032548.png" alt="img_20240220_032548.png" width="80%">

</figure>

<p>
可以看到 5.png 和 1.png是一样的，也就是说 &#x2013;S 1200 并没有起作用，而是
:step=300 起作用了
</p>

<p>
<b>实例5 ：使用 :start 和 :end 只显示指定时间内的数据</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">rrdtool graph 1.png <span style="color: #8b2252;">\</span>
--start now-1h <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">start</span>=now-600:<span style="color: #a0522d;">end</span>=now-300 <span style="color: #8b2252;">\</span>
AREA:value1#ff0000:in


[root@rabbitmq01 sh]# rrdtool graph 1.png <span style="color: #8b2252;">\</span>
&gt; --start now-1h <span style="color: #8b2252;">\ </span># X &#36724;&#26174;&#31034;1&#20010;&#23567;&#26102;&#30340;&#38271;&#24230;
&gt; DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">start</span>=now-600:<span style="color: #a0522d;">end</span>=now-300 <span style="color: #8b2252;">\ </span># &#20294;&#21482;&#21462;10&#20998;&#38047;&#21069;&#21040;5&#20998;&#38047;&#21069;&#30340;&#36825;&#37096;&#20998;
&gt; AREA:value1#ff0000:in
481x155
</pre>
</div>


<figure id="org279b4d8">
<img src="./images/img_20240220_032614.png" alt="img_20240220_032614.png" width="80%">

</figure>


<p>
如果我们不加 :start 和 :end ，则效果如下 ：
</p>


<figure id="orgf6953df">
<img src="./images/img_20240220_032631.png" alt="img_20240220_032631.png" width="80%">

</figure>

<p>
我们甚至可以让两个对象显示不同的时间，例如
</p>

<p>
<b>实例6 ：让两个对象显示不同时间段的数据</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">rrdtool graph 1.png <span style="color: #8b2252;">\</span>
--start now-2h <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">start</span>=now-1h:<span style="color: #a0522d;">end</span>=now <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_out:AVERAGE <span style="color: #8b2252;">\</span>
AREA:value1#ff0000:in <span style="color: #8b2252;">\</span>
LINE2:value2#ff0000:out:STACK

[root@rabbitmq01 sh]# rrdtool graph 1.png <span style="color: #8b2252;">\</span>
&gt; --start now-2h <span style="color: #8b2252;">\ </span># &#35268;&#23450;&#26102;&#38388;&#20026;2&#23567;&#26102;&#20869;
&gt; DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">start</span>=now-1h:<span style="color: #a0522d;">end</span>=now <span style="color: #8b2252;">\ </span># &#35268;&#23450;&#26102;&#38388;&#20026;1&#23567;&#26102;&#20869; 
&gt; DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_out:AVERAGE <span style="color: #8b2252;">\ </span># &#27809;&#26377;&#25351;&#23450; :start &#21644; :end&#65292;&#40664;&#35748;&#21644; &#8211;-start &#19968;&#26679;&#20063;&#26159;2&#23567;&#26102;
&gt; AREA:value1#ff0000:in <span style="color: #8b2252;">\</span>
&gt; LINE2:value2#ff0000:out:STACK
481x155
</pre>
</div>



<figure id="org4cd36e7">
<img src="./images/img_20240220_032651.png" alt="img_20240220_032651.png" width="80%">

</figure>

<p>
<b>实例7 ：把一段时间分为几段分别显示 ：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">rrdtool graph 1.png <span style="color: #8b2252;">\</span>
--start now-2h <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">end</span>=now:<span style="color: #a0522d;">start</span>=end-1h <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">end</span>=now-1h:<span style="color: #a0522d;">start</span>=end-2h <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value3</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">end</span>=now-2h:<span style="color: #a0522d;">start</span>=end-3h <span style="color: #8b2252;">\</span>
LINE1:value1#00ff00:<span style="color: #8b2252;">"1 hours ago"</span> <span style="color: #8b2252;">\</span>
LINE2:value2#ff0000:<span style="color: #8b2252;">"2 hours ago"</span> <span style="color: #8b2252;">\</span>
LINE3:value3#000000:<span style="color: #8b2252;">"3 hours ago"</span>

[root@rabbitmq01 sh]# rrdtool graph 1.png <span style="color: #8b2252;">\</span>
&gt; --start now-2h <span style="color: #8b2252;">\</span>
&gt; DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">end</span>=now:<span style="color: #a0522d;">start</span>=end-1h <span style="color: #8b2252;">\ </span># &#24403;&#21069;1&#23567;&#26102;&#20869;
&gt; DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">end</span>=now-1h:<span style="color: #a0522d;">start</span>=end-2h <span style="color: #8b2252;">\ </span># 2&#23567;&#26102;&#21069;
&gt; DEF:<span style="color: #a0522d;">value3</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">end</span>=now-2h:<span style="color: #a0522d;">start</span>=end-3h <span style="color: #8b2252;">\ </span># 3&#23567;&#26102;&#21069;
&gt; LINE1:value1#00ff00:<span style="color: #8b2252;">"1 hours ago"</span> <span style="color: #8b2252;">\</span>
&gt; LINE2:value2#ff0000:<span style="color: #8b2252;">"2 hours ago"</span> <span style="color: #8b2252;">\</span>
&gt; LINE3:value3#000000:<span style="color: #8b2252;">"3 hours ago"</span>
481x155
</pre>
</div>

<p>
我们把3个小时内的数据用三种不同粗细、不同颜色的曲线画了出来。
</p>



<figure id="org6c27621">
<img src="./images/img_20240220_032712.png" alt="img_20240220_032712.png" width="80%">

</figure>

<p>
看到了吗，out部分（红色）显示了2个小时内的流量，而in部分（绿色）则只显示了1个小时内的部分
</p>

<p>
在这里要提一点，虽然我们指定了 &#x2013;start 或者 &#x2014;end ,或者 :start ,
:end，但并不意味着曲线就一定会从指定的时间点开始和结束。
</p>

<p>
例如我们上面指定了 :start=now-600:end=now-300，也就是只显示5分钟的数据。
但图表出来的效果却是10(10:05-10:15)分钟的数据，这是因为我们挑选的时间
当中“不慎”横垮了两个周期(10:05-10:10,10:10-10:15)，所以RRDtool 会把
它们全部画出来，而不是只画其中的5分钟。
</p>
</div>
</div>
<div id="outline-container-h:15268ca3-632f-494b-8039-fe20e4df63b8" class="outline-4">
<h4 id="h:15268ca3-632f-494b-8039-fe20e4df63b8">五）说明文字（Label）</h4>
<div class="outline-text-4" id="text-h:15268ca3-632f-494b-8039-fe20e4df63b8">
<pre class="example" id="org2f51849">
[-t|--title string] [-v|--vertical-label string]
</pre>

<p>
-t 是用于图表上方的标题，-v 是用于 Y 轴的说明文字
</p>

<p>
实例1 ：给图表增加标题
</p>

<div class="org-src-container">
<pre class="src src-sh">rrdtool graph 1.png <span style="color: #8b2252;">\</span>
--start now-183600 <span style="color: #8b2252;">\</span>
-t <span style="color: #8b2252;">"51 hours ago"</span> -v <span style="color: #8b2252;">"Traffic"</span> <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_out:AVERAGE <span style="color: #8b2252;">\</span>
LINE1:value1#0000ff:in <span style="color: #8b2252;">\</span>
LINE2:value2#ff0000:out

[root@rabbitmq01 sh]# rrdtool graph 1.png <span style="color: #8b2252;">\</span>
&gt; --start now-183600 <span style="color: #8b2252;">\ </span># &#20174;&#24403;&#21069;&#24320;&#22987;&#24448;&#21069;51&#20010;&#23567;&#26102;
&gt; -t <span style="color: #8b2252;">"51 hours ago"</span> -v <span style="color: #8b2252;">"Traffic"</span> <span style="color: #8b2252;">\ </span># &#26631;&#39064;&#26159; &#8220;51 hours ago&#8221;&#65292;Y &#36724;&#30340;&#35828;&#26126;&#25991;&#23383;&#26159; &#8220;Traffic&#8221;
&gt; DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
&gt; DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_out:AVERAGE <span style="color: #8b2252;">\</span>
&gt; LINE1:value1#0000ff:in <span style="color: #8b2252;">\ </span># &#27880;&#37322; &#65306;&#20197;1&#20010;&#20687;&#32032;&#23485;&#30340;&#26354;&#32447;&#30011;&#20986; value1&#65292;&#39068;&#33394;&#26159;&#34013;&#33394;&#65292;&#22270;&#20363;&#30340;&#35828;&#26126;&#25991;&#23383;&#26159;&#8220;in&#8221;
&gt; LINE2:value2#ff0000:out  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#37322; &#65306;&#20197;2&#20010;&#20687;&#32032;&#23485;&#30340;&#26354;&#32447;&#30011;&#20986; value2&#65292;&#39068;&#33394;&#26159;&#32418;&#33394;&#65292;&#22270;&#20363;&#30340;&#35828;&#26126;&#25991;&#23383;&#26159; &#8220;out&#8221;</span>
497x173
</pre>
</div>



<figure id="org18f7e59">
<img src="./images/img_20240220_032756.png" alt="img_20240220_032756.png" width="80%">

</figure>

<p>
现在我们用的是 LINE 的方式来绘图。LINE 可以有3种，分别是LINE1|2|3,也就
是线条的粗细。还有一种是 STACK 方式下面再介绍。可以看到流入的流量比流
出的流量稍大，这样看的话，out流量比较难看，是否可以有别的方式呢？
RRDtool 还提供了 另外一种格式，就是STACK 。意思就是在前一个对象的基础
（把前一个对象的值当成 X轴）上绘图，而不是从 X 轴开始。
</p>

<p>
实例2 ：使用 STACK 方式绘图
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool graph 3.png <span style="color: #8b2252;">\</span>
&gt; --start now-120000 <span style="color: #8b2252;">\</span>
&gt; -t <span style="color: #8b2252;">"33 hours ago"</span> <span style="color: #8b2252;">\</span>
&gt; -v <span style="color: #8b2252;">"Traffic"</span> <span style="color: #8b2252;">\</span>
&gt; DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
&gt; DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_out:AVERAGE <span style="color: #8b2252;">\</span>
&gt; AREA:value1#00ff00:in <span style="color: #8b2252;">\</span>
&gt; LINE:value2#ff0000:out:STACK                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#24847;&#26368;&#21518;&#30340; &#8220;STACK&#8221; &#65292;&#34920;&#31034;&#22312; value1 &#30340;&#22522;&#30784;&#19978;&#32472;&#22270;</span>
497x179
[root@dns1 bob]#
</pre>
</div>


<figure id="org92a48ec">
<img src="./images/img_20240220_032818.png" alt="img_20240220_032818.png" width="80%">

</figure>


<p>
这是没有采用 STACK 方式绘图的效果 ： 
</p>


<figure id="orge9b9b17">
<img src="./images/img_20240220_032838.png" alt="img_20240220_032838.png" width="80%">

</figure>

<p>
可以看得出上面采用 STACK 方式的比较清晰，但要注意，采用 STACK方式后，
在读取 out 流量时，Y 轴的刻度不再是 out 的值， 应该用刻度值减去in 的值，
才是 out 真正的值。这点比较麻烦。需要配合 GPRINT语句才能达到一定的效果。
</p>
</div>
</div>
<div id="outline-container-h:8427c0df-6f7f-4b70-a5f5-66a17fa17468" class="outline-4">
<h4 id="h:8427c0df-6f7f-4b70-a5f5-66a17fa17468">六）图表大小（Size）</h4>
<div class="outline-text-4" id="text-h:8427c0df-6f7f-4b70-a5f5-66a17fa17468">
<div class="org-src-container">
<pre class="src src-sh">[-w|--width pixels] [-h|--height pixels]
</pre>
</div>

<p>
这里说图表大小而不是图片大小，是因为 &#x2013;w ，-h 控制的是 X/Y轴共同围起来
的那部分大小，而不是整个图片的大小，这点在前面就可以看出了。
</p>

<p>
默认的图表大小是 400 （长）x 100 （高），但一般会返回497x179这样的数字，
这个才是图片的大小。
</p>

<p>
RRDtool 比 MRTG 好的一个地方就是 MRTG 一放大图片，就会变得模糊。RRDtool
则不会。
</p>

<p>
在官方文档中，-w 似乎是一个比较敏感的参数，我们看下面的描述 ：
</p>

<pre class="example" id="org57d5f47">
First it makes sure that the RRA covers as much of the graphing time frame as possible. Second it looks at the resolution of the

RRA compared to the resolution of the graph. It tries to find one which has the same or higher better resolution. With the ``-r'' 

option you can force RRDtool to assume a different resolution than the one calculated from the pixel width of the graph.
</pre>

<pre class="example" id="orge10fd56">
By default, rrdtool graph calculates the width of one pixel in the time domain and tries to get data from an RRA with that resolution. 

With the step option you can alter this behaviour. If you want rrdtool graph to get data at a one-hour resolution from the RRD, set 

step to 3'600. Note: a step smaller than one pixel will silently be ignored
</pre>

<p>
这两段话分别是从rrd-beginners 和 rrd_graph 文档中摘出来的。似乎看起来&#x2013;w
会影响到图表的 resolution ，进一步影响到 RRDtool 如何选择 RRA，但经过
实验却发现并非如此。 我对这两段话中的图表的 resolution一词不知如何理解
和计算，希望好心的朋友能够指点一下 ^_^ .
</p>

<p>
实例1 ：使用 &#x2013;w 设定图表大小为 300 像素
</p>

<div class="org-src-container">
<pre class="src src-sh">rrdtool graph 3.png <span style="color: #8b2252;">\</span>
-w 500 <span style="color: #8b2252;">\</span>
--start now-120000 <span style="color: #8b2252;">\</span>
-t <span style="color: #8b2252;">"33 hours ago"</span> -v <span style="color: #8b2252;">"Traffic"</span> <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
AREA:value1#ff0000:in

[root@rabbitmq01 sh]# rrdtool graph 3.png <span style="color: #8b2252;">\</span>
&gt; -w 500 <span style="color: #8b2252;">\ </span>                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#23450; size &#20026; 500 pixel</span>
&gt; --start now-120000 <span style="color: #8b2252;">\</span>
&gt; -t <span style="color: #8b2252;">"33 hours ago"</span> -v <span style="color: #8b2252;">"Traffic"</span> <span style="color: #8b2252;">\</span>
&gt; DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
&gt; AREA:value1#ff0000:in
597x173
</pre>
</div>


<figure id="org4e11f18">
<img src="./images/img_20240220_032913.png" alt="img_20240220_032913.png" width="80%">

</figure>


<p>
可以看到图表是不是变小了呢？而且整个图片的大小也变小了。如果用前面的话
来推理，由于 120000/300（-w的值）= 400 &gt; 300（step）,由于没有
resolution=400 的 RRA， 所以应该采用 resolution=7200的第2个 RRA 的数据
来绘图，但实际上不是。
</p>

<p>
上面这个才是 300 pixel 宽，resolution=7200 的效果 所以我觉得 &#x2013;w 和
&#x2013;h并不能影响 RRDtool 如何选择 RRA ，只能起到缩小放大的作用。BTW：当你
绘制的时间范围较大时，可以使用 &#x2013;w增大图表大小，这样看起来比较“舒服“
</p>
</div>
</div>
<div id="outline-container-h:b9ce772f-02f1-4c4a-88fe-eaf6f42fc1f1" class="outline-4">
<h4 id="h:b9ce772f-02f1-4c4a-88fe-eaf6f42fc1f1">七） Y 轴上下限（Limits）</h4>
<div class="outline-text-4" id="text-h:b9ce772f-02f1-4c4a-88fe-eaf6f42fc1f1">
<div class="org-src-container">
<pre class="src src-sh">[-u|--upper-limit value] [-l|--lower-limit value] [-r|--rigid]
</pre>
</div>

<p>
默认情况下，RRDtool 会和 MRTG 一样自动调整 Y轴的数字，来配合当前的数值
大小。如果想禁止该特性，可以通过 &#x2013;upper-limit和 &#x2013;lower-limit 来做限
制，表示Y轴显示的值从多少到多少。如果没有指定&#x2013;rigid ，则在图表的上下
边界处还是会有一些延伸，但如果指定了 &#x2013;rigid，则严格按照
&#x2013;upper-limit 和 &#x2013;lower-limit 绘制。
</p>

<p>
在使用 &#x2013;lower-limit 时要注意，如果数据中有负数，如果 &#x2013;lower-limit 为
0，则负数部分是显示不出来的。
</p>

<p>
实例1 ：使用 &#x2013;upper-limit 和 &#x2013;lower-limit 限制 Y 轴的上下限
</p>

<div class="org-src-container">
<pre class="src src-sh">
rrdtool graph 1.png <span style="color: #8b2252;">\</span>
--start now-120000 <span style="color: #8b2252;">\</span>
-t <span style="color: #8b2252;">"33 hours ago"</span> -v <span style="color: #8b2252;">"Traffic"</span> <span style="color: #8b2252;">\</span>
--lower-limit -5000 <span style="color: #8b2252;">\</span>
--upper-limit 10000 <span style="color: #8b2252;">\</span>
--rigid <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_out:AVERAGE <span style="color: #8b2252;">\</span>
AREA:value1#00ff00:in <span style="color: #8b2252;">\</span>
LINE1:value2#ff0000:out:STACK

[root@rabbitmq01 sh]# rrdtool graph 1.png <span style="color: #8b2252;">\</span>
&gt; --start now-120000 <span style="color: #8b2252;">\</span>
&gt; -t <span style="color: #8b2252;">"33 hours ago"</span> -v <span style="color: #8b2252;">"Traffic"</span> <span style="color: #8b2252;">\</span>
&gt; --lower-limit -5000 <span style="color: #8b2252;">\ </span># &#38480;&#21046;Y&#36724;&#19979;&#38480;&#20026; -5000 
&gt; --upper-limit 10000 <span style="color: #8b2252;">\ </span># &#19978;&#38480;&#20026; 10000
&gt; --rigid <span style="color: #8b2252;">\ </span>                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20005;&#26684;&#25353;&#29031;&#19978;&#38754;&#30340;&#35268;&#23450;&#26469;&#30011;</span>
&gt; DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
&gt; DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_out:AVERAGE <span style="color: #8b2252;">\</span>
&gt; AREA:value1#00ff00:in <span style="color: #8b2252;">\</span>
&gt; LINE1:value2#ff0000:out:STACK
497x173
</pre>
</div>


<figure id="org7c01103">
<img src="./images/img_20240220_033006.png" alt="img_20240220_033006.png" width="80%">

</figure>
</div>
</div>
<div id="outline-container-h:0a76f9a2-877e-4dd6-bdf8-a4aba614d80b" class="outline-4">
<h4 id="h:0a76f9a2-877e-4dd6-bdf8-a4aba614d80b">八） X/Y 轴刻度（Grid）</h4>
<div class="outline-text-4" id="text-h:0a76f9a2-877e-4dd6-bdf8-a4aba614d80b">
<div class="org-src-container">
<pre class="src src-sh">[-x|--x-grid GTM:GST:MTM:MST:LTM:LST:LPR:LFM] 
[-x|--x-grid none]
[-y|--y-grid grid step:label factor] 
[-y|--y-grid none]
[-Y|--alt-y-grid]
[-X|--units-exponent value]
</pre>
</div>

<p>
RRDtool 中设置 X 轴的刻度比较复杂，如果没有必要，可以交给 RRDtool
自动去处理。
</p>

<p>
例如上面的图，33 小时的情况下，X轴只有2个值，显得很不足。这时候有两种
方法 ：
</p>

<ul class="org-ul">
<li>一是使用 &#x2013;w增大图表的宽度，这样 RRDtool 会自动加多一些刻度上去。不
过需要增加多大才会有上面的这种效果不得而知，所以这种方法不是很方便。</li>

<li><p>
二是通过上面的选项自己设置 X/Y 轴的刻度如何显示。首先看上图，在垂直
的线中，红色的线称为 Major Grid（主要网格线），
</p>

<pre class="example" id="org218fcaa">
灰色的线称为 Base Grid （次要网格线）（这里是借用 EXCEL 中的概念 ^_^ ）。 X 轴下面的时间文字成为 Label 。了解这

三样东西后，就可以动手调整刻度了。
</pre></li>

<li><p>
有两种方法可以快速去掉 X/Y 轴的刻度，就是 &#x2014;x-grid none 和 &#x2014;y-grid none
</p>

<p>
[-x|&#x2013;x-grid GTM:GST:MTM:MST:LTM:LST:LPR:LFM]
</p>

<pre class="example" id="orge53aaf9">
--x-grid HOUR:12:DAY:1:HOUR:24:0:'%a'
</pre></li>

<li><p>
GTM:GST ：控制 <code>次要格网线</code> 的位置。
</p>

<p>
GTM 是一个时间单位，可以是 SECOND、MINUTE、HOUR、DAY 、WEEK、MONTH、
YEAR 。
</p>

<p>
GST则是一个数字，控制每隔多长时间放置一根 <code>次要格线</code> 。
</p>

<p>
例如我们要画一个1天的图表，决定每15分钟一根次要网格线，则格式为
MINUTE:15
</p></li>

<li><p>
MTM:MST ：控制 <code>主要网格线</code> 的位置。
</p>

<p>
MTM 同样是时间单位，MST是一个数字。接上面的例子，决定一个小时1根主要
网格线。则格式为 HOUR:1
</p>

<p>
LTM:LST ：控制每隔多长时间输出一个label 。决定为1小时1个 label。则格
式为 HOUR:1
</p>

<p>
建议 MST是 GST 的2-6倍，这样画出来的图比较美观一些
</p></li>

<li><p>
LTM:LST 只是决定了 label 的显示位置了，没有指定要显示什么内容。
</p>

<p>
建议 MST 和 LST 相同。这样画出来的图比较美观一些
</p>

<p>
LPR:LFM ： LPR 指的是如何放置 label 。如果LPR 为0，则数字对齐格线
（适用于显示时间）。如果不为0，则会做一些偏移（适用于显示星期几、月
份等）。至于LFM则需要熟悉一下 date 命令的参数，常用的有 %a（星期几）、
</p>

<pre class="example" id="org6dd0524">
%b（月份）、%d（天）、%H（小时）、%M（分）、%Y（年）。我们决定显示小时和分，所以用 %H%M
</pre></li>

<li><p>
综合起来，X 轴的刻度定义就是 &#x2014;x-grid MINUTE:15:HOUR:1:HOUR:1:0:'%H:%M'。
</p>

<p>
最好把 %H:%M 括起来
</p>

<p>
建议 MST是 GST的2-6倍，MST 和 LST 相同。这样画出来的图比较美观一些
</p>

<p>
这明显就是图片太小了，不够显示。把上面的 :%M 去掉就可以了，只显示小时，不显示分钟
</p>

<p>
如果把图片放大一点就更好了 (-w 800) 所以在设置 X 轴的刻度时，要记得
不要显示太多东西，否则需要增大图片的大小
</p>

<div class="org-src-container">
<pre class="src src-sh">rrdtool graph 1.png <span style="color: #8b2252;">\</span>
-w 800 <span style="color: #8b2252;">\</span>
--start now-120000 <span style="color: #8b2252;">\</span>
-t <span style="color: #8b2252;">"33 hours ago "</span> -v <span style="color: #8b2252;">"Traffic"</span> <span style="color: #8b2252;">\</span>
--x-grid MINUTE:15:HOUR:1:HOUR:1:0:<span style="color: #8b2252;">'%H'</span> <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_out:AVERAGE <span style="color: #8b2252;">\</span>
AREA:value1#00ff00:in <span style="color: #8b2252;">\</span>
LINE1:value2#ff0000:out:STACK
</pre>
</div>


<figure id="org5aaacdb">
<img src="./images/img_20240220_033644.png" alt="img_20240220_033644.png" width="80%">

</figure></li>
</ul>


<ul class="org-ul">
<li><p>
Y 轴刻度的设置又不一样了
</p>

<pre class="example" id="orgdff9b94">
[-y|--y-grid grid step:label factor]
[-y|--y-grid none]

grid step ：用于控制Y轴每隔多少显示一根水平线
label factor ：默认为1，也就是在每根水平线的高度那里显示一个值。
</pre></li>
</ul>


<p>
例如下面就是一个例子 （每隔800显示一根水平线）
</p>


<figure id="org7aee2f6">
<img src="./images/img_20240220_033807.png" alt="img_20240220_033807.png" width="80%">

</figure>

<ul class="org-ul">
<li>Y 轴还有一个很方便的选项就是 &#x2013;Y ，它可以最大限度的优化 Y 轴的刻度，
建议每次绘图都加上去。</li>

<li><p>
Y 轴另外一个有用的选项就是 &#x2013;X （虽然选项名是 -X ，但确实是用来设置
Y 轴刻度值的）。在上面的图我们看到 RRDtool 自动对 Y 轴的值进行调整，
</p>

<pre class="example" id="org2e4776e">
以 k 为单位显示。但如果你不想以 k 显示，而是想固定以某个单位来显示（M，b）该怎么办呢？这就要用到 –X 选项了。-X 后面跟一个参数，参数值

范围是 -18、-15、-12、-9、-6 、-3、0、3、6、9、12、15、18 。0 表示以原值显示，3 表示数值除以1000，也就是以 k 为单位显示，6 就是以

M 显示，9 就是以 G 显示。如果你给出1或者2，则 RRDtool 也可以接受，但会被“静悄悄”的改为0。下面就是一个以原值（-X 0）显示的例子
</pre>

<div class="org-src-container">
<pre class="src src-sh">rrdtool graph 1.png <span style="color: #8b2252;">\</span>
-w 800 <span style="color: #8b2252;">\</span>
--start now-120000 <span style="color: #8b2252;">\</span>
-t <span style="color: #8b2252;">"33 hours ago "</span> -v <span style="color: #8b2252;">"Traffic"</span> <span style="color: #8b2252;">\</span>
-Y -X 3 <span style="color: #8b2252;">\</span>
--x-grid MINUTE:15:HOUR:1:HOUR:1:0:<span style="color: #8b2252;">'%H'</span> <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_out:AVERAGE <span style="color: #8b2252;">\</span>
AREA:value1#00ff00:in <span style="color: #8b2252;">\</span>
LINE1:value2#ff0000:out:STACK
</pre>
</div></li>
</ul>



<figure id="org50826a4">
<img src="./images/img_20240220_033958.png" alt="img_20240220_033958.png" width="80%"> 

</figure>
</div>
</div>
<div id="outline-container-h:54ce9a11-fda2-43b2-abbf-95fa01e67ab5" class="outline-4">
<h4 id="h:54ce9a11-fda2-43b2-abbf-95fa01e67ab5">九、 其他（Miscellaneous）</h4>
<div class="outline-text-4" id="text-h:54ce9a11-fda2-43b2-abbf-95fa01e67ab5">
<div class="org-src-container">
<pre class="src src-sh">[-n|--font FONTTAG:size:[font]]
[-g|--no-legend]
[-b|--base value]
</pre>
</div>

<p>
A）-n | &#x2013;font 是一个有意思的选项。CU 的 abel 兄曾提供了一个中文 patch
可以实现显示中文的效果。但对于我这等对 C一窍不通的家伙，就不知道怎么用
了。
</p>

<pre class="example" id="orgd63309d">
不过幸好 –n 选项可以实现这个目的，只需要中文字体的文件就可以搞定了。

 首先你要找出一个中文的字体文件。例如/usr/share/fonts/zh_CN/TrueType/gkai00mp.ttf 。你也可以把 Windows 上的 C:\Windows\Fonts 下面的中
 
 文字体拷贝到 Linux 上，例如home/bob/Fonts/simhei.ttf （黑体）效果不错，其他的则不太行，会出现模糊或者重叠的情况。建议就使用黑体算了。

 其次是确定字体大小。中文字体不宜小于 7 ，否则看不清楚

 确定你要修改的是图表的那个部分。有 DEFAULT（全部），TITLE （标题）、AXIS（坐标轴字体）、UNIT（Y轴单位字体）、LEGEND（图例字体）几种。
</pre>

<p>
下面就以实际的例子来说明如何显示中文 ：
</p>

<p>
实例1 ：使用 &#x2013;n 让 RRDtool 显示中文
</p>

<div class="org-src-container">
<pre class="src src-sh">rrdtool graph 4.png <span style="color: #8b2252;">\</span>
-n TITLE:10:<span style="color: #8b2252;">"/home/sh/Fonts/simhei.ttf"</span> <span style="color: #8b2252;">\</span>
-n AXIS:10:<span style="color: #8b2252;">"/home/sh/Fonts/simhei.ttf"</span> <span style="color: #8b2252;">\</span>
-Y -X 3 -w 600 <span style="color: #8b2252;">\</span>
-t <span style="color: #8b2252;">"33&#23567;&#26102;&#21069;&#30340; eth0 &#25509;&#21475;&#27969;&#37327; "</span> -v <span style="color: #8b2252;">"&#27969;&#37327;"</span> <span style="color: #8b2252;">\</span>
--start now-120000 <span style="color: #8b2252;">\</span>
--x-grid MINUTE:12:HOUR:1:HOUR:1:0:<span style="color: #8b2252;">'%H'</span> <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_out:AVERAGE <span style="color: #8b2252;">\</span>
AREA:value1#00ff00:in <span style="color: #8b2252;">\</span>
LINE1:value2#ff0000:out
</pre>
</div>

<p>
这就是最终的效果了，可以看到标题和 X 轴都是中文的，但 Y
轴的字体还是默认的字体。
</p>

<p>
B）-g |&#x2013;no-legend 用于取消图表下方的图例，不过不建议这么做。
C）-b|&#x2013;base value 在 MRTG 和 RRDtool 中，默认 1k=1000 ，使用 &#x2013;b
可以进行调整，例如 &#x2013;b 1024
</p>
</div>
</div>
<div id="outline-container-h:4941ee8e-a0ef-45eb-ae0f-599dc4bb1c7b" class="outline-4">
<h4 id="h:4941ee8e-a0ef-45eb-ae0f-599dc4bb1c7b">十）数字报表</h4>
<div class="outline-text-4" id="text-h:4941ee8e-a0ef-45eb-ae0f-599dc4bb1c7b">
<p>
看看上面的图表，是不是觉得还少了些什么呢？对了，就是只有图，没有文字说
明。如何象MRTG 那样能够显示“最大值”、"平均值"、"当前值"呢？
</p>

<p>
这就需要用到 GRPINT 和 COMMENT 语句了。 GPRINT就是在图表的下方（仍然属
于图片的内部）输出最大值、最小值、平均值这些东东；COMMENT就是用来输出
一些字符串，例如报表的表头。
</p>

<p>
A）GPRINT的格式是GPRINT:vname:CF:format 。由于 format部分太多参数了，
我这里就用最常用的那个 ： %x.ylf 。 B）COMMENT的格式是COMMENT:text 。
要注意 COMMENT默认是不输出换行的，如果要输出换行，必须用 "\n" 。
</p>

<p>
下面就以一个实例来说明如何打印报表 :
绘制1小时前的流量图，并打印数字报表（参照 abel 兄给出的例子）
</p>

<div class="org-src-container">
<pre class="src src-sh">rrdtool graph 4.png <span style="color: #8b2252;">\</span>
-n DEFAULT:8 <span style="color: #8b2252;">\</span>
--start now-30h -t <span style="color: #8b2252;">"30 hours ago(update time:$(</span><span style="color: #ff00ff;">date +'%F %T'</span><span style="color: #8b2252;">))"</span>  --x-grid MINUTE:12:HOUR:1:HOUR:1:0:<span style="color: #8b2252;">'%H'</span> <span style="color: #8b2252;">\</span>
-Y -X 3 -w 700 -v <span style="color: #8b2252;">"Bytes/s"</span> <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_out:AVERAGE <span style="color: #8b2252;">\</span>
CDEF:<span style="color: #a0522d;">inbits</span>=value1,8,* <span style="color: #8b2252;">\</span>
CDEF:<span style="color: #a0522d;">outbits</span>=value2,8,* <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">"\n"</span> <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">"\t   LAST\t\t AVERAGE\t\t\tMAX\t\t\tMIN "</span> <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">"\n"</span> <span style="color: #8b2252;">\</span>
AREA:value1#00ff00:<span style="color: #8b2252;">"in\t"</span> <span style="color: #8b2252;">\</span>
GPRINT:inbits:LAST:<span style="color: #8b2252;">'LAST\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:inbits:AVERAGE:<span style="color: #8b2252;">'AVERAGE\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:inbits:MAX:<span style="color: #8b2252;">'MAX\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:inbits:MIN:<span style="color: #8b2252;">'MIN\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">"\n"</span> <span style="color: #8b2252;">\</span>
LINE1:value2#0000ff:<span style="color: #8b2252;">"out\t"</span> <span style="color: #8b2252;">\</span>
GPRINT:outbits:LAST:<span style="color: #8b2252;">'LAST\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:outbits:AVERAGE:<span style="color: #8b2252;">'AVERAGE\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:outbits:MAX:<span style="color: #8b2252;">'MAX\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:outbits:MIN:<span style="color: #8b2252;">'MIN\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">"\n"</span> 

&#27880;&#24847;&#65306;
CDEF:<span style="color: #a0522d;">inbits</span>=value1,8,* <span style="color: #8b2252;">\ </span>#&#23558;&#20837;&#27969;&#37327;&#25442;&#31639;&#25104;bit 
</pre>
</div>


<figure id="org89da64a">
<img src="./images/img_20240220_034146.png" alt="img_20240220_034146.png" width="80%">

</figure>

<p>
注意比较 Y 轴刻度值和“流出”部分的值的关系， Y 轴刻度值 &#x2014;"流入" ="流出"
</p>

<p>
由于时间精力有限，关于对齐方面的工作就大家自己试验吧.如果绘制的对象数
量不是很多，可以用横向报表，不要用这种垂直的格式，
</p>

<p>
这种格式的好处是便于比较各个对象的值。不过我可以肯定，如何让这些数字和
上面的表头对齐是一个会令你极度抓狂的工作的！！！
</p>

<p>
上面的 COMMENT 一是输出表头，二是输出空行。注意，要用 COMMENT输出空行，
必须用 COMMENT:' \n' 。
</p>

<p>
注意到 '' 前面的空格吗？这个是不可以漏的，否则就不会有空行的效果了。
</p>
</div>
</div>
<div id="outline-container-h:8122d385-b80f-426c-b6db-99d3e1c04625" class="outline-4">
<h4 id="h:8122d385-b80f-426c-b6db-99d3e1c04625">十一）特殊功能</h4>
<div class="outline-text-4" id="text-h:8122d385-b80f-426c-b6db-99d3e1c04625">
<div class="org-src-container">
<pre class="src src-sh">VRULE:time#color[:legend]
HRULE:value#color[:legend]
SHIFT:vname:offset
</pre>
</div>

<p>
A）VRULE/HRULE可以用于在图表上面绘制垂直线/水平线。例如我们想要在图表
上面标出最大值，可以用HRULE 在 Y 轴的指定刻度值
</p>

<pre class="example" id="orgbfb2438">
那里绘制一根水平线，例如 HRUE:100000#ff0000:”最大值” 在 100k 处画一根水平线，并指出这是最大值。
</pre>

<div class="org-src-container">
<pre class="src src-sh">rrdtool graph 4.png <span style="color: #8b2252;">\</span>
-n DEFAULT:8 <span style="color: #8b2252;">\</span>
--start now-30h -t <span style="color: #8b2252;">"30 hours ago(update time:$(</span><span style="color: #ff00ff;">date +'%F %T'</span><span style="color: #8b2252;">))"</span>  --x-grid MINUTE:12:HOUR:1:HOUR:1:0:<span style="color: #8b2252;">'%H'</span> <span style="color: #8b2252;">\</span>
-Y -X 3 -w 700 -v <span style="color: #8b2252;">"Bytes/s"</span> <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_out:AVERAGE <span style="color: #8b2252;">\</span>
CDEF:<span style="color: #a0522d;">inbits</span>=value1,8,* <span style="color: #8b2252;">\</span>
CDEF:<span style="color: #a0522d;">outbits</span>=value2,8,* <span style="color: #8b2252;">\</span>
HRULE:350000#FF0000:<span style="color: #8b2252;">'Alarm value\r'</span> <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">"\n"</span> <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">"\t   LAST\t\t AVERAGE\t\t\tMAX\t\t\tMIN "</span> <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">"\n"</span> <span style="color: #8b2252;">\</span>
AREA:value1#00ff00:<span style="color: #8b2252;">"in\t"</span> <span style="color: #8b2252;">\</span>
GPRINT:inbits:LAST:<span style="color: #8b2252;">'LAST\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:inbits:AVERAGE:<span style="color: #8b2252;">'AVERAGE\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:inbits:MAX:<span style="color: #8b2252;">'MAX\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:inbits:MIN:<span style="color: #8b2252;">'MIN\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">"\n"</span> <span style="color: #8b2252;">\</span>
LINE1:value2#0000ff:<span style="color: #8b2252;">"out\t"</span> <span style="color: #8b2252;">\</span>
GPRINT:outbits:LAST:<span style="color: #8b2252;">'LAST\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:outbits:AVERAGE:<span style="color: #8b2252;">'AVERAGE\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:outbits:MAX:<span style="color: #8b2252;">'MAX\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:outbits:MIN:<span style="color: #8b2252;">'MIN\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">"\n"</span> 
</pre>
</div>


<figure id="org8fbed0d">
<img src="./images/img_20240220_034219.png" alt="img_20240220_034219.png" width="80%">

</figure>


<p>
SHIFT 可以用来移动数据，例如 abel 兄曾经在 "[教學]中的教學(二) RRDTOOL
1.2 更新項目"中提到过一个问题，就是“xx同期相比”如何画？下面就以如何
比较3天的数据。
</p>

<p>
实例1 ：绘制连续3天的数据
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool graph 1.png <span style="color: #8b2252;">\</span>
&gt; DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">end</span>=now:<span style="color: #a0522d;">start</span>=now-1d <span style="color: #8b2252;">\ </span>               <span style="color: #b22222;"># </span><span style="color: #b22222;">1&#22825;&#21069;</span>
&gt; DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">end</span>=now-1d:<span style="color: #a0522d;">start</span>=now-2d <span style="color: #8b2252;">\ </span>               <span style="color: #b22222;"># </span><span style="color: #b22222;">2&#22825;&#21069;</span>
&gt; DEF:<span style="color: #a0522d;">value3</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">end</span>=now-2d:<span style="color: #a0522d;">start</span>=now-3d <span style="color: #8b2252;">\ </span>               <span style="color: #b22222;"># </span><span style="color: #b22222;">3&#22825;&#21069;</span>
&gt; LINE1:value1#00ff00:<span style="color: #8b2252;">"1 day ago"</span> <span style="color: #8b2252;">\</span>
&gt; LINE1:value2#ff0000:<span style="color: #8b2252;">"2 days ago"</span> <span style="color: #8b2252;">\</span>
&gt; LINE1:value3#000000:<span style="color: #8b2252;">"3 days aog"</span> <span style="color: #8b2252;">\</span>
&gt; -Y
475x168
You have new mail<span style="color: #a020f0;"> in</span> /var/spool/mail/root
[root@dns1 bob]#
</pre>
</div>


<figure id="org34a4ee9">
<img src="./images/img_20240220_034244.png" alt="img_20240220_034244.png" width="80%">

</figure>

<p>
为什么只有1天前的数据呢？因为我们没有指定 &#x2014;start ，RRDtool
默认只绘制1天前的数据。由于这里覆盖了3天，
</p>

<p>
所以我们可以把 &#x2014;start 定义为 &#x2014;start now-3d 就可以了。
</p>


<figure id="orgc49dec3">
<img src="./images/img_20240220_034304.png" alt="img_20240220_034304.png" width="80%">

</figure>

<p>
现在是不是3天的数据都画出来了呢？不过由于它们是横向排列的，所以要比较
同个时间段的并不容易，能否把它们
</p>

<p>
按“垂直”的方式排列呢？这就要用到 SHIFT 了！
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@dns1 bob]# rrdtool graph 3.png <span style="color: #8b2252;">\</span>
&gt; DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">end</span>=now:<span style="color: #a0522d;">start</span>=now-1d <span style="color: #8b2252;">\ </span>               <span style="color: #b22222;"># </span><span style="color: #b22222;">1&#22825;&#21069;</span>
&gt; DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">end</span>=now-1d:<span style="color: #a0522d;">start</span>=now-2d <span style="color: #8b2252;">\ </span>               <span style="color: #b22222;"># </span><span style="color: #b22222;">2&#22825;&#21069;</span>
&gt; DEF:<span style="color: #a0522d;">value3</span>=eth0.rrd:eth0_in:AVERAGE:<span style="color: #a0522d;">end</span>=now-2d:<span style="color: #a0522d;">start</span>=now-3d <span style="color: #8b2252;">\ </span>               <span style="color: #b22222;"># </span><span style="color: #b22222;">3&#22825;&#21069;</span>
&gt; LINE1:value1#00ff00:<span style="color: #8b2252;">"1 day ago"</span>  <span style="color: #8b2252;">\ </span>                                                               
&gt; SHIFT:value2:86400 LINE1:value2#ff0000:<span style="color: #8b2252;">"2 days ago"</span> <span style="color: #8b2252;">\ </span>                       <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25226;&#26354;&#32447;&#21521;&#21491;&#31227;&#21160;1&#22825;</span>
&gt; SHIFT:value3:172800 LINE1:value3#000000:<span style="color: #8b2252;">"3 days ago"</span> <span style="color: #8b2252;">\ </span>                       <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25226;&#26354;&#32447;&#21521;&#21491;&#31227;&#21160;2&#22825;</span>
&gt; -Y &#8211;w 600
475x168
</pre>
</div>


<figure id="org58647d1">
<img src="./images/img_20240220_034327.png" alt="img_20240220_034327.png" width="80%">

</figure>

<p>
和上面的图表比较，是否可以发现 X轴不同了，不再是3天，而是1天多1点了。
而且3根曲线重叠在一起了，可以看出在这三天中，
</p>

<p>
只有1天前的23点左右有一点流量之外，其余绝大部分都没有流量。
</p>

<p>
这就是 SHIFT 的功能了，可以把曲线/方块沿着 X轴移动（左右都可以），我们
达到比较同期数据的目的。是不是很好用呢？
</p>
</div>
</div>
<div id="outline-container-h:f699777f-f247-461b-be3a-d8689713f5d8" class="outline-4">
<h4 id="h:f699777f-f247-461b-be3a-d8689713f5d8">十二）总结</h4>
<div class="outline-text-4" id="text-h:f699777f-f247-461b-be3a-d8689713f5d8">
<p>
这次的内容可真够多的，足足写了19页。不过工具性的东西就是这样 ：别看内
容N多，你只要动手画出1个图之后，就会觉得一切都很简单了。以后只要套用就
可以了。关键是如何更好的把你想要的数据以合适的发给你是呈现出来。上面这
些内容都是我通过实验得出的，由于具体的环境不同，可能会跟大家的不同，或
者出现错误。我希望大家不要客气，有错误的地方就指正，有什么好的发现也提
出来，一起完善 RRDtool的文档。这样就可以让越来越多的人了解、掌握
RRDtool 了 。
</p>
</div>
</div>
</div>
<div id="outline-container-h:f5020159-65b9-4c66-b40b-06529ce9b31c" class="outline-3">
<h3 id="h:f5020159-65b9-4c66-b40b-06529ce9b31c">9. RRDtool简体中文教程_9：如何使用RPN</h3>
<div class="outline-text-3" id="text-h:f5020159-65b9-4c66-b40b-06529ce9b31c">
<p>
如何使用RPN
</p>
</div>
<div id="outline-container-h:2bd9c6f1-a035-4230-9bcc-81a763c36863" class="outline-4">
<h4 id="h:2bd9c6f1-a035-4230-9bcc-81a763c36863">一）前言</h4>
<div class="outline-text-4" id="text-h:2bd9c6f1-a035-4230-9bcc-81a763c36863">
<p>
RPN 代表逆波兰式（Reverse Polish Notation）。逆波兰式最早于1920年由Jan
Lukasiewicz 发明，最神奇的地方是用它来表示数学表达式，完全不需要括号。
而且 RPN不像普通的数学表达式那样，操作符在操作数的中间，而是在操作数的
右边。例如3+2 用 RPN 表示就是 3,2,+ ； 3+（2X5） 用 RPN 表示就是
3,2,5,x,+最后运算的部分（加法部分）的操作符放在最后，乘号放在前面，表
示先执行 2 x 5 ，在把结果和3相加。 在 RRDtool 中，RPN 还可以用来表示
if-then-else关系。这点在绘图中很有用。例如你要看 eth0 接口在一天当中流
量 ≥ 10Mb/s的部分，"隐藏"
</p>

<p>
其他低于 10Mb/s 的部分，则可以用到这个功能。
</p>
</div>
</div>
<div id="outline-container-h:f2cfcb54-522f-44b3-8803-f1b274b954ea" class="outline-4">
<h4 id="h:f2cfcb54-522f-44b3-8803-f1b274b954ea">二）操作符</h4>
<div class="outline-text-4" id="text-h:f2cfcb54-522f-44b3-8803-f1b274b954ea">
<p>
什么是 RPN
</p>

<ul class="org-ul">
<li>RPN 是 Reverse Polish Notation的缩写，是用于表示算术运算</li>
</ul>
<p>
和逻辑运算的一种语法格式。
</p>

<ul class="org-ul">
<li>RRDtool 的 CDEF语句中就经常使用 RPN 来对 DEF 取出来的数据进行运算。</li>

<li>RPN 的特点是操作数和操作符出现的顺序和运算的顺序一致，这样就不需要使用括号了</li>

<li>RPN 的格式是 ,, ,[,,]&#x2026; 可以看出是操作数在前，操作符在后的格式</li>

<li>RPN 需要提到堆栈的概念（stack）。堆栈是用来存储操作数和操作符的。</li>

<li><p>
当堆栈中压入（push）一个操作符时，就从堆栈中取出（pop）所需要的操作
数进行计算（根据操作的不同pop出不同数量的操作数）。
</p>

<p>
结果再返回（push）堆栈，最终整个 RPN 应该只返回一个值，或者说堆栈中只有一个元素
</p></li>

<li>在 CDEF 中书写 RPN 操作符，要一律以大写的格式出现</li>

<li>RPN 中，如果某个部分的运算结果非 0，则被认为是 true ，只有 0 才被认为是 false</li>
</ul>
</div>
</div>
<div id="outline-container-h:42e12837-5339-49b1-a38c-2d0e5baf385e" class="outline-4">
<h4 id="h:42e12837-5339-49b1-a38c-2d0e5baf385e">三）RPN 操作符的分类</h4>
<div class="outline-text-4" id="text-h:42e12837-5339-49b1-a38c-2d0e5baf385e">
<p>
A）布尔操作符 ：GT、GE、LT、LE、EQ、NE、
</p>

<p>
B）特殊值比较符 ：UN、ISINF、
</p>

<p>
C）条件操作符 ：IF
</p>

<p>
D）比较操作符 ：MIN、MAX、LIMIT
</p>

<p>
E）算术操作符 ：+ 、-、*、/、%、SIN, COS, LOG, EXP, SQRT、FLOOR, CEIL、
ATAN、ATAN2、DEG2RAD, RAD2DEG
</p>

<p>
F）数据集操作符：所谓数据集（sets），就是指多个数据。SORT、REV、AVG、
TREND
</p>

<p>
G）特殊值 ：UNKN、INF、NEINF、PREV、COUNT
</p>

<p>
H）时间操作符 ：NOW、TIME、LTIME
</p>

<p>
I）堆栈操作符 ：POP、DUP、EXC
</p>
</div>
</div>
<div id="outline-container-h:dcad6cde-48d7-4709-a0eb-79434b74d22c" class="outline-4">
<h4 id="h:dcad6cde-48d7-4709-a0eb-79434b74d22c">四）RPN 操作的结果</h4>
<div class="outline-text-4" id="text-h:dcad6cde-48d7-4709-a0eb-79434b74d22c">
<p>
A）布尔操作符 ：从堆栈中 pop 出两个元素，并根据比较结果返回 0 （false）
或者 1 。任何同 UNKNOWN 或者 INF 、NEINF 比较的都为 0
</p>

<p>
B）特殊值比较符 ：从堆栈中 pop 出1个元素，并同 UNKNOWN 或者 INF、NEINF
比较。结果为 0 或者 1
</p>

<p>
C）条件操作符：从堆栈中pop出3个元素，如果最后pop出的那个元素不为0（条
件部分为true），则第2次 pop 出的那个元素被重新入栈（then部分）；
</p>

<pre class="example" id="orgb5fb2bb">
否则第一次pop出的元素重新入栈（else部分）。结果为 then 部分或者 else 部分返回的值，不一定为0或者1
</pre>

<p>
D）比较操作符 ：
</p>

<pre class="example" id="orgb064759">
对于 MIN/MAX 操作符来说，从堆栈中 pop 出两个操作符，并把较大/小的那个重新入栈。如果其中有一个 unknown ，则结果为 unknonw

对于 LIMIT 操作符来说，先从堆栈中 pop 出2个操作数，作为边界的定义；再 pop 出1个操作数，比较该操作数是否落在前面定义的范围内。

如果是则把最后 pop 出的那个元素重新入栈；否则把 UNKN 值入栈；注意，是 UNKN ，不是 0
</pre>

<p>
E）算术操作符 ：根据操作符 pop出所需数量的操作数，并把算术运算的结果重
新入栈
</p>

<p>
F）数据集操作符 ：
</p>

<pre class="example" id="orgb0ea3b4">
对于 SORT、REV 来说，先从堆栈中 POP 出一个元素，该元素的值就是下面要 pop 出的元素的数量。然后对堆栈从上到下的若干个元素
</pre>

<p>
由第一次 pop 的出的那个元素的值决定）进行排序/反向排序。结果再重新入栈。
</p>

<p>
注意：由于堆栈的特点是后进先出，所以要操作的元素是从SORT操作符往左方向
计数。例如v1,v2,v3,v4,3,SORT是对v2~v4 排序，
</p>

<pre class="example" id="org4597131">
不是对 v1~v3 排序。  这点在书写 RPN 时要特别注意。
</pre>

<p>
注意 ：SORT 操作是最小值在堆栈的最顶部；REV则相反，最小值是在堆栈的最
顶部。
</p>

<p>
对于 AVG 操作来说，同样是先 pop出1个元素，并按照指定的数量对后续的若干
个操作数进行操作，但结果只有一个数值，并入栈。
</p>

<p>
G）特殊值 ：
</p>

<pre class="example" id="org9947e4e">
UNKN 表示压入一个 UNKN 值；INF、NEINF 分别表示把 INF、NEINF 值压入堆栈
</pre>

<p>
H）时间操作符 ：
</p>

<p>
TIME 返回当前所提取的记录的 timestamp ，注意 TIME 直接返回当前记录的
timestamp ，不用任何参数
</p>

<p>
NOW 返回当前时间，同样 NOW 不用任何参数
</p>

<p>
I）堆栈操作符 ：
</p>

<p>
POP ：弹出堆栈的最顶部的那个元素
</p>

<p>
EXC ：交换堆栈顶部的第一个和第二个元素的值
</p>
</div>
</div>
<div id="outline-container-h:775ecb9b-2b3b-41e0-9cbc-af66351361ba" class="outline-4">
<h4 id="h:775ecb9b-2b3b-41e0-9cbc-af66351361ba">五）如何阅读 RPN</h4>
<div class="outline-text-4" id="text-h:775ecb9b-2b3b-41e0-9cbc-af66351361ba">
<p>
A）首先按照从左到右的顺序，找出第一个 RPN操作符，并根据上一节的内容，
对相应的操作数进行操作
</p>

<p>
B）操作结果分成两种 ：
</p>

<pre class="example" id="orgeecf984">
如果是一个值，直接替换掉该部分 RPN 

如果是多个值（数据集操作，但 AVG 操作只返回一个值），则结果可能为多个数值。则把这若干个数值用 ‘,’ 隔开，替换原来那部分 RPN 
</pre>

<p>
C）如此循环，一直到整个 RPN 只返回一个值为止
</p>
</div>
</div>
<div id="outline-container-h:4066656e-e96e-4fec-9d99-581f989f5f5d" class="outline-4">
<h4 id="h:4066656e-e96e-4fec-9d99-581f989f5f5d">六、RPN 实例</h4>
<div class="outline-text-4" id="text-h:4066656e-e96e-4fec-9d99-581f989f5f5d">
<p>
A）布尔型操作符 ：2,1,GE 表示 2&gt;=1 ；
</p>

<p>
B）特殊值比较符 ：mydata,UN 表示 mydata == UNKNOWN
</p>

<p>
C）条件操作符 ：mydata,UN,0,mydata,IF 表示如果 mydata 等于 UNKNOWN，则
返回 0；否则还是返回 mydata 本身
</p>

<p>
D）比较操作符 ：mydata,20,MAX 表示返回 mydata，20这两个数值中较大的一
个；alpha,0,100,LIMIT 表示测试 alpha的值是否小于等于0，大于等于100；
</p>

<p>
E）算术操作符 ：1,2,- 表示 1-2=-1
</p>

<p>
F）数据集操作符 ：
</p>

<pre class="example" id="org02f86e9">
v1,v2,v3,v4,v5,4,SORT 表示对 v1~v4 进行正向排序，结果堆栈中还是有5个元素；

v1,v2,v3,v4,3,AVG,+,2,/ 表示对 v4,v3,v2 进行求平均值，并把结果入栈。假设v2~v4的结果为 k ，则为 v1,k,+,2,/ 也就是返回 (v1+k)/2
</pre>

<p>
G）特殊值 ：mydata,0,GT,UNKN,mydata,IF 表示如果 mydata 大于 0则返回
UNKNOWN ，否则还是 mydata
</p>

<p>
H）时间操作符 ： TIME,=date –d “2006-10-01 10:00” +%s=,GT,0,1,IF表示
如果当前记录的采集时间是在 2006-10-01 10:00 之后就返回1，否则返回 0
</p>

<p>
I）堆栈操作符 ：POP 就立即弹出第一个元素
</p>
</div>
</div>
<div id="outline-container-h:cf8c29ed-928b-451f-b54b-b67824a12682" class="outline-4">
<h4 id="h:cf8c29ed-928b-451f-b54b-b67824a12682">七）如何表示 AND、OR 关系</h4>
<div class="outline-text-4" id="text-h:cf8c29ed-928b-451f-b54b-b67824a12682">
<p>
A）我们知道 RPN 表达式的值除非0，否则都认为是 true
</p>

<p>
B）我们可以利用 加法操作和乘法操作来实现 OR 和 AND 的逻辑关系；如果两
个RPN 表达式的值相加不等于0，就一定为 true ；
</p>

<pre class="example" id="org3137cb1">
如果两个 RPN 表达式的值相乘不等于0，就一定为 true
</pre>

<p>
C）AND 关系的例子 ：例如要比较某个值（15，9）是否在特定范围内可以用 :
</p>

<pre class="example" id="org9b82b7e">
15,10,GT,15,20,LT,* ，结果就是（15&gt;10）*（15 &lt; 20）= 1 * 1 =1 ，所以为 true

 9,10,GT,9,20,LT,* ，结果就是 （9 &gt;10）* （ 9 &lt; 20）= 0 * 1 =0 ，所以为 false
</pre>

<p>
D）OR 关系的例子：同上例如要比较某个值(7,15)小于10，或者大于20：
</p>

<pre class="example" id="orge01cce8">
7,10,LT,7,20,GT,+ ，结果为 （7 &lt; 10）+ （7 &gt; 20） = 1+0 = 1,所以为 true

15,10,LT,15,20,GT,+ ，结果为 ( 15 &lt; 10) + ( 15 &gt; 20) = 0 + 0 =0 ，所以为 false
</pre>

<p>
E）不过使用 + 需要注意一个地方：相加的双方都必须是正数，否则可能出现问
题，例如一个正数（-5，true）和另外一个正数（5，true）相加为0（false）
</p>

<pre class="example" id="org952981b">
如果是按照 OR 的关系，应该是 true 的，但结果变成0（false），所以在使用 + 来表示 OR 的关系时，要注意该问题
</pre>

<p>
F）使用 * 则没有该问题了，正数 * 负数 = 负数 （true）。所以如果遇到 OR
关系的时候，可以转换为 AND 关系来计算。
</p>

<pre class="example" id="orgba564c8">
例如要表达 (x &lt; a) OR ( x &gt; b) 的关系，可以改为 (x &gt;a) AND ( x &lt; b ) ，诀窍就是把比较操作符调反方向，把 + 改为 *
</pre>
</div>
</div>
<div id="outline-container-h:055c05fa-241c-45f2-bdfe-13f2e811c946" class="outline-4">
<h4 id="h:055c05fa-241c-45f2-bdfe-13f2e811c946">八）实例</h4>
<div class="outline-text-4" id="text-h:055c05fa-241c-45f2-bdfe-13f2e811c946">
<p>
实例1：例如要看 eth0的总流量，可以用如下的定义
</p>

<div class="org-src-container">
<pre class="src src-sh">DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_out:AVERAGE <span style="color: #8b2252;">\</span>
CDEF:<span style="color: #a0522d;">value3</span>=value1,value2,+ <span style="color: #8b2252;">\</span>
AREA:value3#ff0000:&#8221;total&#8221;
</pre>
</div>

<p>
实例2 ：假设我们要把 eth0 和 lo 的流入流量相加，得出总的流入流量
</p>

<div class="org-src-container">
<pre class="src src-sh">DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value2</span>=lo.rrd:lo_out:AVERAGE <span style="color: #8b2252;">\</span>
CDEF:<span style="color: #a0522d;">value3</span>=value2,UN,0,value2,IF <span style="color: #8b2252;">\</span>
CDEF:<span style="color: #a0522d;">value4</span>=value1,value3,+ <span style="color: #8b2252;">\</span>
AREA:value4#00ff00:&#8221;total<span style="color: #a020f0;"> in</span>&#8221;
</pre>
</div>

<p>
由于 lo.rrd 一直没有数据插入，所以一直都是 NaN ，如果直接把 value1 和
value2 相加，由于 value2 是 UNKNOWN，
</p>

<p>
所以相加的结果也是 UNKNOWN 。图表上将什么都不显示，所以需要对 value2进
行判断，如果 value2 的值 UNKNOWN （value2,UN），
</p>

<p>
则返回0，否则返回 value2 本身。然后把这个值赋予变量 value3 ，最后把
value1 和 value3 相加，才得出真正入流量
</p>

<p>
实例3 ：只看 eth0 中流量大于 10Mb/s 的部分，其余不看
</p>

<div class="org-src-container">
<pre class="src src-sh">DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0-_out:AVERAGE <span style="color: #8b2252;">\</span>
CDEF:<span style="color: #a0522d;">value3</span>=value1,1000000,GT,value1,UNKN,IF <span style="color: #8b2252;">\</span>
CDEF:<span style="color: #a0522d;">value4</span>=value2,1000000,GT,value2,UNKN,IF <span style="color: #8b2252;">\</span>
AREA:value3#00ff00:&#8221;traffic_in <span style="color: #8b2252;">\&gt;</span> 10M<span style="color: #8b2252;">\/</span>s&#8221; <span style="color: #8b2252;">\</span>
AREA:value4#ff0000:&#8221;traffic_out <span style="color: #8b2252;">\&gt;</span> 10Mb<span style="color: #8b2252;">\/</span>s&#8221;:STACK
</pre>
</div>

<p>
实例4 ：只绘制特定时间段（在 2006/11/29 10:30 ~ 2006/11/29 12:30）的数据
</p>

<div class="org-src-container">
<pre class="src src-sh">DEF:<span style="color: #a0522d;">value1</span>=eth0.rrd:eth0_in:AVERAGE <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">value2</span>=eth0.rrd:eth0_out:AVERAGE <span style="color: #8b2252;">\</span>
CDEF:<span style="color: #a0522d;">value3</span>=TIME,$(<span style="color: #ff00ff;">date &#8211;d &#8216;2006-11-29 10:30&#8217; +%s</span>),GT,TIME,$(<span style="color: #ff00ff;">date &#8211;d '2006-11-29 12:30' +%s</span>),LT,*,value1,UNKN,IF <span style="color: #8b2252;">\</span>
CDEF:<span style="color: #a0522d;">value4</span>=TIME,$(<span style="color: #ff00ff;">date &#8211;d &#8216;2006-11-29 12:30&#8217; +%s</span>),GT,TIME,$(<span style="color: #ff00ff;">date &#8211;d '2006-11-29 13:30' +%s</span>),LT,*,value2,UNKN,IF <span style="color: #8b2252;">\</span>
AREA:value3#00ff00:&#8221;traffic_in&#8221; <span style="color: #8b2252;">\</span>
AREA:value4#ff0000:&#8221;traffic_out&#8221;:STACK
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e05d6b95-757d-4b85-9580-5ee117e0030a" class="outline-4">
<h4 id="h:e05d6b95-757d-4b85-9580-5ee117e0030a">九、完结</h4>
<div class="outline-text-4" id="text-h:e05d6b95-757d-4b85-9580-5ee117e0030a">
<p>
相信到目前为止，大家对 RRDtool的认识应该更深了吧。一定要多做实验，这样
才能做到熟能生巧，灵活应用。
</p>

<p>
其实剩下的还有 xport、dump、restore、resize、tune、rrdcgi几个操作没讲，
而且有一些应用经验方面的东西也没有提到，
</p>

<p>
不过想要全部写出来，可能太耗时间和精力了，这些东西足足写了我2个星期才
写完。中间还要不断的做实验以验证正确性，怕误导了大家。
</p>

<p>
如果需要的话，可以自己下载官方文档学习，或者能有热心的朋友补充就更好了，
^_^。
</p>
</div>
</div>
<div id="outline-container-h:c05d58a8-50af-4923-b922-e7418c1d0f59" class="outline-4">
<h4 id="h:c05d58a8-50af-4923-b922-e7418c1d0f59">十、 本人的一点学习体会</h4>
<div class="outline-text-4" id="text-h:c05d58a8-50af-4923-b922-e7418c1d0f59">
<p>
本人从开始看 RRDtool 官方文档到开始写这篇教程，差不多用了2个月。
RRDtool比学习 MRTG 难多了，资料少，RRDtool 的中文资料目前就只有 abel兄
写的那一篇教程，如果没有实际的上机操作，是不可能看懂的，所以 abel兄也
特别交代这点。如果只一心想速成，到头来反而吃亏的是自己。
</p>

<p>
象sendmail、bind 这些服务器的配置，随便在 google上都可以搜到一大把所谓
的“快速入门”，很多人也都照着做了。但明明别人可以的，为什么轮到自己
</p>

<p>
却失败呢？相信这是很多人心中曾有的郁闷经历。其实归根到底就是基础的问题，
再深入一些就是学习心态的问题。"不积跬步，无以至千里；不积小流,无以成江
海"。
</p>

<p>
配置一个服务器并不是照抄配置就可以的。环境的不同，需求的不同这些因素都
要考虑在内。怎么可能做到完全一样呢？同一个语句换个环境可能就不行了。所
以我很
</p>

<p>
少看那些所谓的快速入门，要么看 manual ，要么看书（说到这里，感觉
O'Reilly 的书真是不错！^_^），如果是象RRDtool这种的，就只好看官方文档
了。
</p>

<p>
学习的同时也要注意选择好的教材。有时候一本好书能带给无穷的好处。这点在
我第一次看O'Reilly 的 《dns &amp; bind 4th》就有感觉，老外的书很注重循序渐
进，
</p>

<p>
通常他们都是从某个实际工作环境的一个小例子说起，逐步引入各个命令、配置
语句。然后随着需求的壮大，不断引入新的内容，最后形成一个总体。这样看完
后会心中会
</p>

<p>
有一个整体的框架和概念。不象国内一些书，毫不顾及条理，一上来就讲语法、
命令，搞得读者很快都没有兴趣。这样的书可谓害人不浅。
</p>

<p>
同时也建议大家读英文原版的书。为什么呢？虽然中文的看起来快一些，但学习
不是竞走比赛。不是比谁看的快，而是比谁学的牢。英文书的词汇其实都是专业
词汇，
</p>

<p>
只要看多了，自然记住了。实在记不住，可以用金山词霸等工具辅助。俺的英文
水平只有二级，但并不妨碍我看书。况且看英文书，有一个“英文→中文”的转
换的过程。就
</p>

<p>
是揣摩作者这句话的含义，或者说这句话应该如何翻译好。有些人觉得这个没有
什么，但我觉得这个过程是你弄清作者思想的重要步骤。在你不断的揣摩中，可
能会有不同
</p>

<p>
的理解，直到你认为这是最正确的那一种解释为止。如果是看中文书，可能会由
于惰性，比较容易就接受作者的想法，而失去这个主动我思考的过程。
</p>

<p>
一时有感而发，胡乱写了一通，请各位朋友见谅了。
</p>

<p>
书山有路勤为径，学海无涯苦做舟！愿以该座右铭和各位有志于Linux的朋友一
起共勉！
</p>
</div>
</div>
</div>
<div id="outline-container-h:0cf0cd94-43e7-4e04-9fb1-8c5c4a861ee8" class="outline-3">
<h3 id="h:0cf0cd94-43e7-4e04-9fb1-8c5c4a861ee8">10. 实例</h3>
<div class="outline-text-3" id="text-h:0cf0cd94-43e7-4e04-9fb1-8c5c4a861ee8">
<div class="org-src-container">
<pre class="src src-sh">
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;rdd&#24211;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25353;&#22825;&#26356;&#26032;&#25968;&#25454;&#65292;&#38388;&#38548;&#20026;86400&#65292;&#25968;&#25454;&#28304;&#30340;&#24515;&#36339;&#26377;&#25928;&#26399;&#20026;2&#22825;&#20197;&#20869;</span>
rrdtool create Flow.rrd <span style="color: #8b2252;">\</span>
--start $(<span style="color: #ff00ff;">date -d "2018-06-10 09:00:00" +%s</span>) <span style="color: #8b2252;">\</span>
--step 86400 <span style="color: #8b2252;">\</span>
DS:eth0_in:GAUGE:172800:0:U <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:1:600 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:6:700 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:24:775 <span style="color: #8b2252;">\</span>
RRA:AVERAGE:0.5:288:797 <span style="color: #8b2252;">\</span>
RRA:MAX:0.5:1:600 <span style="color: #8b2252;">\</span>
RRA:MAX:0.5:6:700 <span style="color: #8b2252;">\</span>
RRA:MAX:0.5:24:775 <span style="color: #8b2252;">\</span>
RRA:MAX:0.5:444:797 <span style="color: #8b2252;">\</span>
RRA:MIN:0.5:1:600 <span style="color: #8b2252;">\</span>
RRA:MIN:0.5:6:700 <span style="color: #8b2252;">\</span>
RRA:MIN:0.5:24:775 <span style="color: #8b2252;">\</span>
RRA:MIN:0.5:444:797

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26356;&#26032;rrd&#24211;</span>
jasperhsu@u-18:/data/rrdtool_data$ date -d <span style="color: #8b2252;">"2019-05-25 08:00:00"</span> +%s
1558742400
jasperhsu@u-18:/data/rrdtool_data$ date -d <span style="color: #8b2252;">"2019-05-26 08:00:00"</span> +%s
1558828800
jasperhsu@u-18:/data/rrdtool_data$ date -d <span style="color: #8b2252;">"2019-05-27 08:00:00"</span> +%s
1558915200
jasperhsu@u-18:/data/rrdtool_data$ date -d <span style="color: #8b2252;">"2019-05-28 08:00:00"</span> +%s
1559001600
jasperhsu@u-18:/data/rrdtool_data$ date -d <span style="color: #8b2252;">"2019-05-29 08:00:00"</span> +%s
1559088000
jasperhsu@u-18:/data/rrdtool_data$ date -d <span style="color: #8b2252;">"2019-05-30 08:00:00"</span> +%s
1559174400


rrdtool updatev Flow.rrd 1558742400:12
rrdtool updatev Flow.rrd 1558828800:4
rrdtool updatev Flow.rrd 1558915200:8
rrdtool updatev Flow.rrd 1559001600:10
rrdtool updatev Flow.rrd 1559088000:4
rrdtool updatev Flow.rrd 1559174400:6

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#30011;&#22270;</span>
rrdtool graph  Flow.png <span style="color: #8b2252;">\</span>
-n DEFAULT:10 <span style="color: #8b2252;">\</span>
-s -8day -e now+2day -t <span style="color: #8b2252;">'Flow week'</span> --x-grid HOUR:12:DAY:1:HOUR:24:0:<span style="color: #8b2252;">'%a'</span> <span style="color: #8b2252;">\</span>
-Y -w 600 -h  300 -v <span style="color: #8b2252;">'count'</span> <span style="color: #8b2252;">\</span>
DEF:<span style="color: #a0522d;">v_eth0_in</span>=Flow.rrd:eth0_in:LAST:<span style="color: #a0522d;">step</span>=86400 <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">'\n'</span> <span style="color: #8b2252;">\</span>
LINE2:v_eth0_in#A9A9A9:<span style="color: #8b2252;">'eth0_in    \t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_eth0_in:LAST:<span style="color: #8b2252;">'LAST\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_eth0_in:AVERAGE:<span style="color: #8b2252;">'AVERAGE\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_eth0_in:MAX:<span style="color: #8b2252;">'MAX\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
GPRINT:v_eth0_in:MIN:<span style="color: #8b2252;">'MIN\: %6.2lf%s\t'</span> <span style="color: #8b2252;">\</span>
COMMENT:<span style="color: #8b2252;">'\n'</span>
</pre>
</div>


<figure id="org8e19273">
<img src="./images/img_20240220_034728.png" alt="img_20240220_034728.png" width="80%">

</figure>
</div>
</div>
<div id="outline-container-h:81d3876b-90bc-4043-878d-c96bae59bc52" class="outline-3">
<h3 id="h:81d3876b-90bc-4043-878d-c96bae59bc52">11. python与rrdtool结合画图</h3>
<div class="outline-text-3" id="text-h:81d3876b-90bc-4043-878d-c96bae59bc52">
<blockquote>
<p>
python与rrdtool结合画图
安装方式：<a href="https://pythonhosted.org/rrdtool/index.html">https://pythonhosted.org/rrdtool/index.html</a>
</p>
</blockquote>
</div>
<div id="outline-container-h:c118795b-7cae-40e5-b30e-1a1f83c48205" class="outline-4">
<h4 id="h:c118795b-7cae-40e5-b30e-1a1f83c48205">11.1 准备依赖</h4>
<div class="outline-text-4" id="text-h:c118795b-7cae-40e5-b30e-1a1f83c48205">
<p>
ubuntu安装：
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo apt-get install librrd-dev libpython3-dev

<span style="color: #b22222;"># </span><span style="color: #b22222;">yum install rrdtool-devel python34-devel</span>

pip install rrdtool
</pre>
</div>

<p>
aliyun sdk
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">SDK&#26680;&#24515;&#24211;</span>
pip install aliyun-python-sdk-core
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#38463;&#37324;&#20113;&#20851;&#31995;&#22411;&#25968;&#25454;&#24211;</span>
pip install aliyun-python-sdk-rds
</pre>
</div>
</div>
</div>
<div id="outline-container-h:06a42d4a-94a3-499f-87a5-47e190eeddd2" class="outline-4">
<h4 id="h:06a42d4a-94a3-499f-87a5-47e190eeddd2">11.2 代码实例</h4>
<div class="outline-text-4" id="text-h:06a42d4a-94a3-499f-87a5-47e190eeddd2">
<p>
rds性能图表
</p>

<p>
DS最多19个字符
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">coding=utf-8</span>

<span style="color: #a020f0;">from</span> aliyunsdkcore.client <span style="color: #a020f0;">import</span> AcsClient
<span style="color: #a020f0;">from</span> aliyunsdkcore.acs_exception.exceptions <span style="color: #a020f0;">import</span> ClientException
<span style="color: #a020f0;">from</span> aliyunsdkcore.acs_exception.exceptions <span style="color: #a020f0;">import</span> ServerException
<span style="color: #a020f0;">from</span> aliyunsdkrds.request.v20140815.DescribeDBInstancesRequest <span style="color: #a020f0;">import</span> DescribeDBInstancesRequest
<span style="color: #a020f0;">from</span> aliyunsdkrds.request.v20140815.DescribeDBInstancePerformanceRequest <span style="color: #a020f0;">import</span> DescribeDBInstancePerformanceRequest

<span style="color: #a020f0;">import</span> sys,os
<span style="color: #a020f0;">import</span> json
<span style="color: #a020f0;">import</span> re
<span style="color: #a020f0;">import</span> datetime,time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_rds_info</span>(fileter=<span style="color: #008b8b;">None</span>):
    <span style="color: #8b2252;">'''Get aliyun RDS information'''</span>

    <span style="color: #a0522d;">request</span> = DescribeDBInstancesRequest()
    request.set_accept_format(<span style="color: #8b2252;">'json'</span>)

    request.set_DBInstanceStatus(<span style="color: #8b2252;">"Running"</span>)
    request.set_Engine(<span style="color: #8b2252;">"MySQL"</span>)
    request.set_ClientToken(<span style="color: #8b2252;">"123455667"</span>)

    <span style="color: #a0522d;">response</span> = client.do_action_with_exception(request)

    <span style="color: #a020f0;">if</span> fileter == <span style="color: #008b8b;">None</span>:
        <span style="color: #a0522d;">fileter</span>=<span style="color: #8b2252;">""</span>

    <span style="color: #a0522d;">my_list</span>={}
    <span style="color: #a0522d;">rds_info</span>=json.loads(response)
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> rds_info[<span style="color: #8b2252;">'Items'</span>][<span style="color: #8b2252;">'DBInstance'</span>]:
        <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'private'</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> i[<span style="color: #8b2252;">'DBInstanceDescription'</span>]:
            <span style="color: #a020f0;">if</span> re.<span style="color: #a020f0;">match</span>(r<span style="color: #8b2252;">'.*'</span>+fileter+<span style="color: #8b2252;">'.*'</span>, i[<span style="color: #8b2252;">'DBInstanceDescription'</span>]):
                my_list[i[<span style="color: #8b2252;">'DBInstanceDescription'</span>]]=i[<span style="color: #8b2252;">'DBInstanceId'</span>]

    <span style="color: #a020f0;">return</span> my_list

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_rds_performance_info</span>(<span style="color: #483d8b;">id</span>,keys):
    <span style="color: #8b2252;">'''Get RDS Performance information'''</span>

    <span style="color: #a0522d;">request</span> = DescribeDBInstancePerformanceRequest()
    request.set_accept_format(<span style="color: #8b2252;">'json'</span>)
    <span style="color: #a0522d;">start_time</span> = (datetime.datetime.now() - datetime.timedelta(days=6) - datetime.timedelta(hours=8)).strftime(
        <span style="color: #8b2252;">'%Y-%m-%dT%H:%MZ'</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">start_time = (datetime.datetime.now() - datetime.timedelta(hours=9)).strftime('%Y-%m-%dT%H:%MZ')</span>
    <span style="color: #a0522d;">end_time</span> = (datetime.datetime.now()-datetime.timedelta(hours=8)).strftime(<span style="color: #8b2252;">'%Y-%m-%dT%H:%MZ'</span>)
    request.set_EndTime(end_time)
    request.set_StartTime(start_time)
    request.set_Key(keys)
    request.set_DBInstanceId(<span style="color: #483d8b;">id</span>)

    <span style="color: #a0522d;">response</span> = client.do_action_with_exception(request)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">python2:  print(response)</span>
    <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">str</span>(response, encoding=<span style="color: #8b2252;">'utf-8'</span>)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">utc_to_local</span>(india_time_str,india_format = <span style="color: #8b2252;">'%Y-%m-%dT%H:%M:%SZ'</span>):
    <span style="color: #8b2252;">'''UTC to beijing timestamp'''</span>

    <span style="color: #a0522d;">india_dt</span> = datetime.datetime.strptime(india_time_str, india_format)
    <span style="color: #a0522d;">local_dt</span> = india_dt + datetime.timedelta(hours=8,minutes=0)
    <span style="color: #a0522d;">local_format</span> = <span style="color: #8b2252;">"%Y-%m-%d %H:%M:%S"</span>
    <span style="color: #a0522d;">time_str</span> = local_dt.strftime(local_format)
    <span style="color: #a020f0;">return</span> time_str

<span style="color: #a020f0;">import</span> rrdtool
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">create_rrd</span>(name,key_ds):
    <span style="color: #a0522d;">cur_time</span> = <span style="color: #483d8b;">str</span>(<span style="color: #483d8b;">int</span>((datetime.datetime.now() - datetime.timedelta(days=128)).timestamp()))  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;&#24403;&#21069;Linux&#26102;&#38388;&#25139;&#20316;&#20026;rrd&#36215;&#22987;&#26102;&#38388;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">print(cur_time)</span>

    <span style="color: #a0522d;">rrd_DS</span> = []
    <span style="color: #a020f0;">for</span> DS <span style="color: #a020f0;">in</span> key_ds:
        rrd_DS.append(<span style="color: #8b2252;">'DS:'</span>+ DS +<span style="color: #8b2252;">':GAUGE:600:0:U'</span>)
    <span style="color: #483d8b;">print</span>(rrd_DS) <span style="color: #b22222;"># </span><span style="color: #b22222;">['DS:active_session:GAUGE:600:0:U', 'DS:total_session:GAUGE:600:0:U']</span>

    <span style="color: #a0522d;">rrd_name</span> = <span style="color: #8b2252;">'/data/rrdtool_data/'</span> + name + <span style="color: #8b2252;">'.rrd'</span>
    <span style="color: #a0522d;">rrd_RRA</span> = [
        <span style="color: #8b2252;">'RRA:AVERAGE:0.5:1:600'</span>,
        <span style="color: #8b2252;">'RRA:AVERAGE:0.5:6:700'</span>,
        <span style="color: #8b2252;">'RRA:AVERAGE:0.5:24:775'</span>,
        <span style="color: #8b2252;">'RRA:AVERAGE:0.5:288:797'</span>,
        <span style="color: #8b2252;">'RRA:MAX:0.5:1:600'</span>,
        <span style="color: #8b2252;">'RRA:MAX:0.5:6:700'</span>,
        <span style="color: #8b2252;">'RRA:MAX:0.5:24:775'</span>,
        <span style="color: #8b2252;">'RRA:MAX:0.5:444:797'</span>,
        <span style="color: #8b2252;">'RRA:MIN:0.5:1:600'</span>,
        <span style="color: #8b2252;">'RRA:MIN:0.5:6:700'</span>,
        <span style="color: #8b2252;">'RRA:MIN:0.5:24:775'</span>,
        <span style="color: #8b2252;">'RRA:MIN:0.5:444:797'</span>,
    ]

    <span style="color: #a020f0;">if</span>  <span style="color: #a020f0;">not</span> os.path.exists(rrd_name):
        <span style="color: #a0522d;">rrd</span> = rrdtool.create(rrd_name, <span style="color: #8b2252;">'--step'</span>, <span style="color: #8b2252;">'300'</span>, <span style="color: #8b2252;">'--start'</span>, cur_time,
                            rrd_DS,rrd_RRA)
        <span style="color: #a020f0;">if</span> rrd:
            <span style="color: #483d8b;">print</span> (rrdtool.error())

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">update_rrd</span>(name, value, rrd_time):
    <span style="color: #a0522d;">rrd_name</span> = <span style="color: #8b2252;">'/data/rrdtool_data/'</span>+name+<span style="color: #8b2252;">'.rrd'</span>

    <span style="color: #a0522d;">last_update_time</span> = rrdtool.last(rrd_name)

    <span style="color: #a020f0;">if</span> rrd_time &gt; last_update_time:
        <span style="color: #a0522d;">str_value</span> = []
        <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> value:
            str_value.append(i)
        <span style="color: #a0522d;">str_value</span> = <span style="color: #8b2252;">'{}:{}'</span>.<span style="color: #483d8b;">format</span>(<span style="color: #483d8b;">str</span>(rrd_time), <span style="color: #8b2252;">':'</span>.join(str_value))
        <span style="color: #b22222;">#</span><span style="color: #b22222;">print(str_value) #1558592494:1.04:19.7</span>

        <span style="color: #a0522d;">update</span> = rrdtool.updatev(rrd_name, str_value)
        <span style="color: #b22222;">#</span><span style="color: #b22222;">print(update)</span>


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">graph_rrd</span>(name, key_ds, key_unit, select=<span style="color: #8b2252;">'week'</span>):
    <span style="color: #a0522d;">custum_file</span> = <span style="color: #8b2252;">'/data/rrdtool_data/'</span> + name +<span style="color: #8b2252;">'.png'</span>
    <span style="color: #a0522d;">custum_d</span> = [<span style="color: #8b2252;">'-s'</span>, <span style="color: #8b2252;">"now-30h"</span>, <span style="color: #8b2252;">'-e'</span>, <span style="color: #8b2252;">'now-1min'</span>, <span style="color: #8b2252;">'-t'</span>, name + <span style="color: #8b2252;">' 30 hours ago'</span>, <span style="color: #8b2252;">'--x-grid'</span>, <span style="color: #8b2252;">'MINUTE:12:HOUR:1:HOUR:1:0:%H'</span>]
    <span style="color: #a0522d;">custum_w</span> = [<span style="color: #8b2252;">'-s'</span>, <span style="color: #8b2252;">"-8day"</span>, <span style="color: #8b2252;">'-e'</span>, <span style="color: #8b2252;">'now-1min'</span>, <span style="color: #8b2252;">'-t'</span>, name + <span style="color: #8b2252;">' week'</span>, <span style="color: #8b2252;">'--x-grid'</span>, <span style="color: #8b2252;">'HOUR:2:HOUR:6:HOUR:24:0:%a'</span>]
    <span style="color: #a0522d;">custum_m</span> = [<span style="color: #8b2252;">'-s'</span>, <span style="color: #8b2252;">"-40day"</span>, <span style="color: #8b2252;">'-e'</span>, <span style="color: #8b2252;">'now-1min'</span>, <span style="color: #8b2252;">'-t'</span>, name + <span style="color: #8b2252;">' last month'</span>, <span style="color: #8b2252;">'--x-grid'</span>, <span style="color: #8b2252;">'HOUR:12:HOUR:24:HOUR:24:0:%d'</span>]
    <span style="color: #a0522d;">custum_y</span> = [<span style="color: #8b2252;">'-s'</span>, <span style="color: #8b2252;">"-20month"</span>, <span style="color: #8b2252;">'-e'</span>, <span style="color: #8b2252;">'now-1min'</span>, <span style="color: #8b2252;">'-t'</span>, name + <span style="color: #8b2252;">' last year'</span>, <span style="color: #8b2252;">'--x-grid'</span>, <span style="color: #8b2252;">'MONTH:1:MONTH:1:MONTH:1:0:%b'</span>]

    <span style="color: #a0522d;">custum_str</span> = custum_w
    <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'day'</span> == select:
        <span style="color: #a0522d;">custum_str</span> = custum_d
    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'week'</span> == select:
        <span style="color: #a0522d;">custum_str</span> = custum_w
    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'month'</span> == select:
        <span style="color: #a0522d;">custum_str</span> = custum_m
    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'year'</span> == select:
        <span style="color: #a0522d;">custum_str</span> = custum_y

    <span style="color: #a0522d;">custum_size</span> = [<span style="color: #8b2252;">'-Y'</span>, <span style="color: #8b2252;">'-w'</span>, <span style="color: #8b2252;">'900'</span>, <span style="color: #8b2252;">'-h'</span>, <span style="color: #8b2252;">'400'</span>, <span style="color: #8b2252;">'-v'</span>, key_unit]

    <span style="color: #a0522d;">rrd_name</span> = <span style="color: #8b2252;">'/data/rrdtool_data/'</span> + name + <span style="color: #8b2252;">'.rrd'</span>

    <span style="color: #a0522d;">rrd_DEF</span> = []
    <span style="color: #a020f0;">for</span> DS <span style="color: #a020f0;">in</span> key_ds:
        rrd_DEF.append(<span style="color: #8b2252;">'DEF:v_{}={}:{}:LAST'</span>.<span style="color: #483d8b;">format</span>(DS,rrd_name,DS))
    <span style="color: #483d8b;">print</span>(rrd_DEF) <span style="color: #b22222;"># </span><span style="color: #b22222;">exampale ['DEF:v_cpuusage=/xxx.rrd:cpuusage:LAST',]</span>

    <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">    #0000ff &#34013;</span>
<span style="color: #8b2252;">    #00FFFF &#27973;&#34013;</span>
<span style="color: #8b2252;">    #00ff00 &#32511;</span>
<span style="color: #8b2252;">    #FF00FF &#32043;</span>
<span style="color: #8b2252;">    #FFFF00 &#40644;</span>
<span style="color: #8b2252;">    """</span>
    <span style="color: #a0522d;">color</span> = [<span style="color: #8b2252;">'#00FFFF'</span>, <span style="color: #8b2252;">'#FF00FF'</span>, <span style="color: #8b2252;">'#FFFF00'</span>, <span style="color: #8b2252;">'#0000ff'</span>, <span style="color: #8b2252;">'#00ff00'</span>]

    <span style="color: #b22222;"># </span><span style="color: #b22222;">MySQL_MemCpuUsage MySQL&#23454;&#20363;CPU&#20351;&#29992;&#29575;(&#21344;&#25805;&#20316;&#31995;&#32479;&#24635;&#25968;)&#65292;MySQL&#23454;&#20363;&#20869;&#23384;&#20351;&#29992;&#29575;(&#21344;&#25805;&#20316;&#31995;&#32479;&#24635;&#25968;)&#12290;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">MySQL_Sessions    &#24403;&#21069;&#27963;&#36291;&#36830;&#25509;&#25968;&#65292;&#24403;&#21069;&#24635;&#36830;&#25509;&#25968;&#12290;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">slavestat &#21482;&#35835;&#23454;&#20363;&#24310;&#36831;&#12290;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">MySQL_IOPS    MySQL&#23454;&#20363;&#30340;IOPS&#65288;&#27599;&#31186;IO&#35831;&#27714;&#27425;&#25968;&#65289;&#12290;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">MySQL_NetworkTraffic  MySQL&#23454;&#20363;&#24179;&#22343;&#27599;&#31186;&#38047;&#30340;&#36755;&#20837;&#27969;&#37327;&#65292;MySQL&#23454;&#20363;&#24179;&#22343;&#27599;&#31186;&#38047;&#30340;&#36755;&#20986;&#27969;&#37327;&#12290;&#21333;&#20301;&#20026;KB&#12290;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">MySQL_DetailedSpaceUsage  MySQL&#23454;&#20363;&#31354;&#38388;&#21344;&#29992;&#35814;&#24773;&#65306;ins_size&#23454;&#20363;&#24635;&#31354;&#38388;&#20351;&#29992;&#37327;;data_size&#25968;&#25454;&#31354;&#38388;;log_size&#26085;&#24535;&#31354;&#38388;;tmp_size&#20020;&#26102;&#31354;&#38388;;other_size&#31995;&#32479;&#31354;&#38388;&#12290;</span>
    <span style="color: #a0522d;">graph</span> = [<span style="color: #8b2252;">'AREA'</span>, <span style="color: #8b2252;">'LINE'</span>, <span style="color: #8b2252;">'AREA'</span>, <span style="color: #8b2252;">'LINE2'</span>, <span style="color: #8b2252;">'LINE2'</span>, <span style="color: #8b2252;">'LINE2'</span>]
    <span style="color: #b22222;">#</span><span style="color: #b22222;">print(''.join(name.partition('MySQL')[-2:]))</span>
    <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">''</span>.join(name.partition(<span style="color: #8b2252;">'MySQL'</span>)[-2:]) <span style="color: #a020f0;">in</span> [<span style="color: #8b2252;">'MySQL_MemCpuUsage'</span>, <span style="color: #8b2252;">'MySQL_IOPS'</span>]:
        <span style="color: #a0522d;">graph</span> = [<span style="color: #8b2252;">'AREA'</span>, <span style="color: #8b2252;">'LINE'</span>, <span style="color: #8b2252;">'LINE'</span>, <span style="color: #8b2252;">'LINE'</span>, <span style="color: #8b2252;">'AREA'</span>, <span style="color: #8b2252;">'LINE2'</span>, <span style="color: #8b2252;">'LINE2'</span>, <span style="color: #8b2252;">'LINE2'</span>]
    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">''</span>.join(name.partition(<span style="color: #8b2252;">'MySQL'</span>)[-2:]) <span style="color: #a020f0;">in</span> [<span style="color: #8b2252;">'MySQL_DetailedSpaceUsage'</span>]:
        <span style="color: #a0522d;">graph</span> = [<span style="color: #8b2252;">'LINE2'</span>, <span style="color: #8b2252;">'LINE2'</span>, <span style="color: #8b2252;">'LINE2'</span>, <span style="color: #8b2252;">'LINE2'</span>, <span style="color: #8b2252;">'LINE2'</span>, <span style="color: #8b2252;">'AREA'</span>, <span style="color: #8b2252;">'AREA'</span>, <span style="color: #8b2252;">'AREA'</span>, <span style="color: #8b2252;">'AREA'</span>, <span style="color: #8b2252;">'AREA'</span>]
    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">''</span>.join(name.partition(<span style="color: #8b2252;">'MySQL'</span>)[-2:]) <span style="color: #a020f0;">in</span> [<span style="color: #8b2252;">'MySQL_NetworkTraffic'</span>]:
        <span style="color: #a0522d;">graph</span> = [<span style="color: #8b2252;">'AREA'</span>, <span style="color: #8b2252;">'LINE2'</span>]

    <span style="color: #a0522d;">ds_length</span> = []
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> key_ds:
        ds_length.append(<span style="color: #483d8b;">len</span>(i))
    <span style="color: #a0522d;">max_length</span> = <span style="color: #483d8b;">max</span>(ds_length)
    <span style="color: #a0522d;">rrd_GRAPH</span> = []
    <span style="color: #a020f0;">for</span> DS <span style="color: #a020f0;">in</span> key_ds:
        rrd_GRAPH.append(<span style="color: #8b2252;">"{}:v_{}{}:{}{}</span><span style="color: #008b8b;">\t</span><span style="color: #8b2252;">"</span>.<span style="color: #483d8b;">format</span>(graph.pop(), DS, color.pop(), DS, <span style="color: #8b2252;">' '</span>*(max_length - <span style="color: #483d8b;">len</span>(DS))))
        rrd_GRAPH.append(<span style="color: #8b2252;">"GPRINT:v_{}:LAST:LAST\: %6.2lf%s</span><span style="color: #008b8b;">\t</span><span style="color: #8b2252;">"</span>.<span style="color: #483d8b;">format</span>(DS))
        rrd_GRAPH.append(<span style="color: #8b2252;">"GPRINT:v_{}:AVERAGE:AVERAGE\: %6.2lf%s</span><span style="color: #008b8b;">\t</span><span style="color: #8b2252;">"</span>.<span style="color: #483d8b;">format</span>(DS))
        rrd_GRAPH.append(<span style="color: #8b2252;">"GPRINT:v_{}:MAX:MAX\: %6.2lf%s</span><span style="color: #008b8b;">\t</span><span style="color: #8b2252;">"</span>.<span style="color: #483d8b;">format</span>(DS))
        rrd_GRAPH.append(<span style="color: #8b2252;">"GPRINT:v_{}:MIN:MIN\: %6.2lf%s</span><span style="color: #008b8b;">\t</span><span style="color: #8b2252;">"</span>.<span style="color: #483d8b;">format</span>(DS))
        rrd_GRAPH.append(<span style="color: #8b2252;">"COMMENT:</span><span style="color: #008b8b;">\\</span><span style="color: #8b2252;">n"</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">AREA:value1#00ff00:"cpuusage\t"</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">GPRINT:value1:LAST:'LAST\: %6.2lf%s\t'</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">GPRINT:value1:AVERAGE:'AVERAGE\: %6.2lf%s\t'</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">GPRINT:value1:MAX:'MAX\: %6.2lf%s\t'</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">GPRINT:value1:MIN:'MIN\: %6.2lf%s\t'</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">COMMENT:"\n"</span>
    <span style="color: #a0522d;">custum_list</span> = [<span style="color: #8b2252;">"COMMENT:</span><span style="color: #008b8b;">\\</span><span style="color: #8b2252;">n"</span>, <span style="color: #8b2252;">"COMMENT:"</span>+ <span style="color: #8b2252;">' '</span>*max_length + <span style="color: #8b2252;">"</span><span style="color: #008b8b;">\t\t</span><span style="color: #8b2252;">  LAST</span><span style="color: #008b8b;">\t\t\t</span><span style="color: #8b2252;"> AVERAGE</span><span style="color: #008b8b;">\t\t</span><span style="color: #8b2252;">MAX</span><span style="color: #008b8b;">\t\t\t</span><span style="color: #8b2252;">MIN"</span>, <span style="color: #8b2252;">"COMMENT:</span><span style="color: #008b8b;">\\</span><span style="color: #8b2252;">n"</span>]
    <span style="color: #a0522d;">rrd_GRAPH</span> = custum_list + rrd_GRAPH
    <span style="color: #b22222;">#</span><span style="color: #b22222;">print(rrd_GRAPH)</span>

    <span style="color: #a0522d;">rrd_HRULE</span> = <span style="color: #8b2252;">"-Y"</span>
    <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">"%"</span> <span style="color: #a020f0;">in</span> key_unit:
        <span style="color: #a0522d;">rrd_HRULE</span> = <span style="color: #8b2252;">"HRULE:90#FF0000:Alarm value</span><span style="color: #008b8b;">\\</span><span style="color: #8b2252;">r"</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">: &#38656;&#35201;&#36716;&#20041;</span>
    <span style="color: #a0522d;">cur_time</span> = datetime.datetime.now().strftime(<span style="color: #8b2252;">"%Y-%m-%d %H\:%M\:%S"</span>)

    rrdtool.graph(custum_file,
                  <span style="color: #8b2252;">'-n'</span>, <span style="color: #8b2252;">'DEFAULT:10'</span>,
                  custum_str,
                  custum_size,
                  rrd_DEF,
                  rrd_HRULE,
                  rrd_GRAPH,
                  <span style="color: #8b2252;">"COMMENT:</span><span style="color: #008b8b;">\t\t\t\t\t\t\t\t\t\t\t\t</span><span style="color: #8b2252;"> update\:"</span>+cur_time,
                  <span style="color: #8b2252;">"COMMENT:</span><span style="color: #008b8b;">\t\t\t\t\t\t\t\t\t\t\t\t</span><span style="color: #8b2252;"> Aliyun RDS Report"</span>)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">analyze_data</span>(rds_info=<span style="color: #008b8b;">None</span>,keys=<span style="color: #008b8b;">None</span>, select=<span style="color: #8b2252;">'week'</span>):
    <span style="color: #a020f0;">if</span> rds_info == <span style="color: #008b8b;">None</span> <span style="color: #a020f0;">or</span> keys == <span style="color: #008b8b;">None</span>:
        sys.<span style="color: #008b8b;">exit</span>(1)
    <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> <span style="color: #483d8b;">isinstance</span>(rds_info, <span style="color: #483d8b;">dict</span>):
        sys.<span style="color: #008b8b;">exit</span>(1)

    <span style="color: #a0522d;">my_dict</span> = {}
    <span style="color: #a020f0;">for</span> rds,<span style="color: #483d8b;">id</span> <span style="color: #a020f0;">in</span> rds_info.items():
        <span style="color: #a0522d;">info</span> = json.loads(get_rds_performance_info(<span style="color: #483d8b;">id</span>,keys))

        <span style="color: #a0522d;">performance_info</span> = info[<span style="color: #8b2252;">'PerformanceKeys'</span>][<span style="color: #8b2252;">'PerformanceKey'</span>]
        <span style="color: #a020f0;">for</span> key_info <span style="color: #a020f0;">in</span> performance_info:
            <span style="color: #a0522d;">key_name</span> = rds + <span style="color: #8b2252;">'_'</span> + key_info[<span style="color: #8b2252;">'Key'</span>]
            <span style="color: #a0522d;">key_ds</span> = key_info[<span style="color: #8b2252;">'ValueFormat'</span>].split(<span style="color: #8b2252;">'&amp;'</span>)
            <span style="color: #a0522d;">key_unit</span> = key_info[<span style="color: #8b2252;">'Unit'</span>]

            <span style="color: #b22222;"># </span><span style="color: #b22222;">create rrd</span>
            create_rrd(key_name, key_ds)

            <span style="color: #a0522d;">values_info</span> = key_info[<span style="color: #8b2252;">'Values'</span>][<span style="color: #8b2252;">'PerformanceValue'</span>]
            <span style="color: #a020f0;">for</span> value_info <span style="color: #a020f0;">in</span> values_info:
                <span style="color: #b22222;">#</span><span style="color: #b22222;">print(value_info['Value'].split('&amp;'),int(datetime.datetime.strptime(utc_to_local(value_info['Date']),'%Y-%m-%d %H:%M:%S').timestamp()))</span>
                <span style="color: #a0522d;">value</span> = value_info[<span style="color: #8b2252;">'Value'</span>].split(<span style="color: #8b2252;">'&amp;'</span>)
                <span style="color: #a0522d;">rrd_time</span> = <span style="color: #483d8b;">int</span>(datetime.datetime.strptime(utc_to_local(value_info[<span style="color: #8b2252;">'Date'</span>]),<span style="color: #8b2252;">'%Y-%m-%d %H:%M:%S'</span>).timestamp())

                <span style="color: #b22222;"># </span><span style="color: #b22222;">update rrd data</span>
                update_rrd(key_name, value, rrd_time)

            <span style="color: #b22222;"># </span><span style="color: #b22222;">graph rrd</span>
            graph_rrd(key_name, key_ds, key_unit, select)

<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">'__main__'</span>:
    <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">    keys = "MySQL_MemCpuUsage,MySQL_Sessions,slavestat,MySQL_IOPS,MySQL_NetworkTraffic,MySQL_DetailedSpaceUsage"</span>
<span style="color: #8b2252;">    MySQL_MemCpuUsage   MySQL&#23454;&#20363;CPU&#20351;&#29992;&#29575;(&#21344;&#25805;&#20316;&#31995;&#32479;&#24635;&#25968;)&#65292;MySQL&#23454;&#20363;&#20869;&#23384;&#20351;&#29992;&#29575;(&#21344;&#25805;&#20316;&#31995;&#32479;&#24635;&#25968;)&#12290;</span>
<span style="color: #8b2252;">    MySQL_Sessions  &#24403;&#21069;&#27963;&#36291;&#36830;&#25509;&#25968;&#65292;&#24403;&#21069;&#24635;&#36830;&#25509;&#25968;&#12290;</span>
<span style="color: #8b2252;">    slavestat   &#21482;&#35835;&#23454;&#20363;&#24310;&#36831;&#12290;</span>
<span style="color: #8b2252;">    MySQL_IOPS  MySQL&#23454;&#20363;&#30340;IOPS&#65288;&#27599;&#31186;IO&#35831;&#27714;&#27425;&#25968;&#65289;&#12290;</span>
<span style="color: #8b2252;">    MySQL_NetworkTraffic    MySQL&#23454;&#20363;&#24179;&#22343;&#27599;&#31186;&#38047;&#30340;&#36755;&#20837;&#27969;&#37327;&#65292;MySQL&#23454;&#20363;&#24179;&#22343;&#27599;&#31186;&#38047;&#30340;&#36755;&#20986;&#27969;&#37327;&#12290;&#21333;&#20301;&#20026;KB&#12290;</span>
<span style="color: #8b2252;">    MySQL_DetailedSpaceUsage    MySQL&#23454;&#20363;&#31354;&#38388;&#21344;&#29992;&#35814;&#24773;&#65306;ins_size&#23454;&#20363;&#24635;&#31354;&#38388;&#20351;&#29992;&#37327;;data_size&#25968;&#25454;&#31354;&#38388;;log_size&#26085;&#24535;&#31354;&#38388;;tmp_size&#20020;&#26102;&#31354;&#38388;;other_size&#31995;&#32479;&#31354;&#38388;&#12290;</span>

<span style="color: #8b2252;">    slow_log</span>
<span style="color: #8b2252;">    :return:</span>
<span style="color: #8b2252;">    """</span>
    <span style="color: #a0522d;">client</span> = AcsClient(<span style="color: #8b2252;">'LTAIkH7ssssY'</span>, <span style="color: #8b2252;">'YbYiHIHsssso'</span>, <span style="color: #8b2252;">'cn-beijing'</span>)
    <span style="color: #483d8b;">print</span>(get_rds_info(<span style="color: #8b2252;">'zys'</span>))
    <span style="color: #a0522d;">rds_info</span> = get_rds_info(<span style="color: #8b2252;">'zys'</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">keys = "MySQL_MemCpuUsage,MySQL_Sessions,slavestat,MySQL_InnoDBBufferRatio,MySQL_InnoDBDataReadWriten,MySQL_InnoDBLogRequests,MySQL_RowDML"</span>
    <span style="color: #a0522d;">keys</span> = <span style="color: #8b2252;">"MySQL_MemCpuUsage,MySQL_Sessions,MySQL_IOPS,MySQL_DetailedSpaceUsage,MySQL_NetworkTraffic"</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">select can be 'day', 'week', 'month', 'year'. default 'week'.</span>
    analyze_data(rds_info, keys, select=<span style="color: #8b2252;">'day'</span>)
</pre>
</div>


<figure id="org52dea34">
<img src="./images/img_20240220_034845.png" alt="img_20240220_034845.png" width="80%">

</figure>
</div>
</div>
<div id="outline-container-h:b34f4973-99c6-47e6-976b-8d5abe64d161" class="outline-4">
<h4 id="h:b34f4973-99c6-47e6-976b-8d5abe64d161">11.2 多实例聚合版本</h4>
<div class="outline-text-4" id="text-h:b34f4973-99c6-47e6-976b-8d5abe64d161">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">coding=utf-8</span>

<span style="color: #a020f0;">from</span> aliyunsdkcore.client <span style="color: #a020f0;">import</span> AcsClient
<span style="color: #a020f0;">from</span> aliyunsdkcore.acs_exception.exceptions <span style="color: #a020f0;">import</span> ClientException
<span style="color: #a020f0;">from</span> aliyunsdkcore.acs_exception.exceptions <span style="color: #a020f0;">import</span> ServerException
<span style="color: #a020f0;">from</span> aliyunsdkrds.request.v20140815.DescribeDBInstancesRequest <span style="color: #a020f0;">import</span> DescribeDBInstancesRequest
<span style="color: #a020f0;">from</span> aliyunsdkrds.request.v20140815.DescribeDBInstanceAttributeRequest <span style="color: #a020f0;">import</span> DescribeDBInstanceAttributeRequest
<span style="color: #a020f0;">from</span> aliyunsdkrds.request.v20140815.DescribeDBInstancePerformanceRequest <span style="color: #a020f0;">import</span> DescribeDBInstancePerformanceRequest
<span style="color: #a020f0;">from</span> aliyunsdkrds.request.v20140815.DescribeSlowLogsRequest <span style="color: #a020f0;">import</span> DescribeSlowLogsRequest

<span style="color: #a020f0;">import</span> sys,os
<span style="color: #a020f0;">import</span> json
<span style="color: #a020f0;">import</span> re
<span style="color: #a020f0;">import</span> datetime,time
<span style="color: #a020f0;">import</span> random
<span style="color: #a020f0;">from</span> collections <span style="color: #a020f0;">import</span> OrderedDict

<span style="color: #a020f0;">import</span> smtplib
<span style="color: #a020f0;">from</span> email.mime.image <span style="color: #a020f0;">import</span> MIMEImage
<span style="color: #a020f0;">from</span> email.mime.multipart <span style="color: #a020f0;">import</span> MIMEMultipart
<span style="color: #a020f0;">from</span> email.mime.text <span style="color: #a020f0;">import</span> MIMEText
<span style="color: #a020f0;">from</span> email.header <span style="color: #a020f0;">import</span> Header

<span style="color: #8b2252;">'''</span>
<span style="color: #8b2252;">#CentOS7 python3</span>
<span style="color: #8b2252;">yum install rrdtool-devel python34-devel</span>
<span style="color: #8b2252;">pip install rrdtool</span>
<span style="color: #8b2252;">'''</span>

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">send_email</span>(to_addr, cc_addr, subject, content, is_html=<span style="color: #008b8b;">True</span>, images=[], url=<span style="color: #008b8b;">None</span>):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">to_addr = ['xcwhxxe@xxx.com']  # &#25509;&#25910;&#37038;&#20214;&#65292;&#21487;&#35774;&#32622;&#20026;&#20320;&#30340;QQ&#37038;&#31665;&#25110;&#32773;&#20854;&#20182;&#37038;&#31665;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">cc_addr = ['xcwhxxe'] # &#25220;&#36865;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">subject = 'Python SMTP &#37038;&#20214;&#27979;&#35797;' # &#20027;&#39064;</span>

    <span style="color: #a0522d;">mail_host</span> = <span style="color: #8b2252;">"smtp.cici.com"</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#26381;&#21153;&#22120;</span>
    <span style="color: #a0522d;">mail_user</span> = <span style="color: #8b2252;">"scans@cici.com"</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29992;&#25143;&#21517;</span>
    <span style="color: #a0522d;">mail_pass</span> = <span style="color: #8b2252;">"sssssssssss"</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21475;&#20196;</span>
    <span style="color: #a0522d;">sender</span> = <span style="color: #8b2252;">'scans'</span>

    <span style="color: #a0522d;">msgRoot</span> = MIMEMultipart(<span style="color: #8b2252;">'related'</span>)
    <span style="color: #a0522d;">msgRoot</span>[<span style="color: #8b2252;">'From'</span>] = Header(mail_user, <span style="color: #8b2252;">'utf-8'</span>)
    <span style="color: #a0522d;">msgRoot</span>[<span style="color: #8b2252;">'To'</span>] = Header(<span style="color: #8b2252;">","</span>.join(to_addr), <span style="color: #8b2252;">'utf-8'</span>)
    <span style="color: #a0522d;">msgRoot</span>[<span style="color: #8b2252;">'Cc'</span>] = Header(<span style="color: #8b2252;">","</span>.join(cc_addr)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25220;&#36865;</span>
    <span style="color: #a0522d;">msgRoot</span>[<span style="color: #8b2252;">'Subject'</span>] = Header(subject, <span style="color: #8b2252;">'utf-8'</span>)

    <span style="color: #a020f0;">if</span> is_html:
        <span style="color: #a0522d;">msgAlternative</span> = MIMEMultipart(<span style="color: #8b2252;">'alternative'</span>)
        msgRoot.attach(msgAlternative)

        <span style="color: #a0522d;">mail_msg</span> =<span style="color: #8b2252;">''</span>
        <span style="color: #a020f0;">for</span> i, img_name <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">enumerate</span>(images):
            <span style="color: #483d8b;">print</span>(img_name)
            <span style="color: #b22222;"># </span><span style="color: #b22222;">i_name = img_name.split('\\')[-1].split('/')[-1].strip('.png')</span>
            <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">"SQLSlowLog"</span> <span style="color: #a020f0;">in</span> img_name:
                <span style="color: #a0522d;">i_name</span> = <span style="color: #8b2252;">'&#24930;&#26085;&#24535;&#25968;'</span>
            <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'DetailedSpaceUsage'</span> <span style="color: #a020f0;">in</span> img_name:
                <span style="color: #a0522d;">i_name</span> = <span style="color: #8b2252;">'&#24635;&#31354;&#38388;&#20351;&#29992;&#29575;(%)'</span>
            <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'IOPS_io'</span> <span style="color: #a020f0;">in</span> img_name:
                <span style="color: #a0522d;">i_name</span> = <span style="color: #8b2252;">'IOPS&#20351;&#29992;&#29575;(%)'</span>
            <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'cpuusage'</span> <span style="color: #a020f0;">in</span> img_name:
                <span style="color: #a0522d;">i_name</span> = <span style="color: #8b2252;">'CPU&#20351;&#29992;&#29575;(%)'</span>
            <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'memusage'</span> <span style="color: #a020f0;">in</span> img_name:
                <span style="color: #a0522d;">i_name</span> = <span style="color: #8b2252;">'&#20869;&#23384;&#20351;&#29992;&#29575;(%)'</span>
            <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'active_session'</span> <span style="color: #a020f0;">in</span> img_name:
                <span style="color: #a0522d;">i_name</span> = <span style="color: #8b2252;">'&#27963;&#36291;&#36830;&#25509;&#25968;'</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">print(i_name)</span>
            <span style="color: #b22222;">#</span><span style="color: #b22222;">&lt;p&gt;&lt;img src="cid:image{1}" height="400" width="900"&gt;&lt;/p&gt;</span>
            <span style="color: #a0522d;">mail_msg</span> = mail_msg + <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">            &lt;h2&gt;{0}&#22270;&#31034;&#65306;&lt;/h2&gt;</span>
<span style="color: #8b2252;">            &lt;p&gt;&lt;img src="cid:image{1}"&gt;&lt;/p&gt; </span>
<span style="color: #8b2252;">            &lt;p&gt;&lt;/p&gt;</span>
<span style="color: #8b2252;">            """</span>.<span style="color: #483d8b;">format</span>(i_name, i)
        msgAlternative.attach(MIMEText(content+mail_msg, <span style="color: #8b2252;">'html'</span>, <span style="color: #8b2252;">'utf-8'</span>))

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#22270;&#29255;&#20026;&#24403;&#21069;&#30446;&#24405;</span>
        <span style="color: #a020f0;">for</span> i, img_name <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">enumerate</span>(images):
            <span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(img_name, <span style="color: #8b2252;">'rb'</span>) <span style="color: #a020f0;">as</span> fp:
                <span style="color: #a0522d;">img_data</span> = fp.read()
            <span style="color: #a0522d;">msgImage</span> = MIMEImage(img_data)
            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#22270;&#29255; ID&#65292;&#22312; HTML &#25991;&#26412;&#20013;&#24341;&#29992;</span>
            msgImage.add_header(<span style="color: #8b2252;">'Content-ID'</span>, <span style="color: #8b2252;">'&lt;image{0}&gt;'</span>.<span style="color: #483d8b;">format</span>(i))
            msgRoot.attach(msgImage)
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a0522d;">msg_content</span> = MIMEText(content, <span style="color: #8b2252;">'plain'</span>, <span style="color: #8b2252;">'utf-8'</span>)
        msgRoot.attach(msg_content)

    <span style="color: #a020f0;">try</span>:
        <span style="color: #a0522d;">smtpObj</span> = smtplib.SMTP_SSL()
        smtpObj.connect(mail_host, 994)  <span style="color: #b22222;"># </span><span style="color: #b22222;">25 &#20026; SMTP &#31471;&#21475;&#21495;</span>
        smtpObj.login(mail_user, mail_pass)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">smtpObj.sendmail(mail_user, to_addr, msgRoot.as_string())</span>
        smtpObj.sendmail(mail_user, to_addr+cc_addr, msgRoot.as_string())
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"&#37038;&#20214;&#21457;&#36865;&#25104;&#21151;"</span>)
    <span style="color: #a020f0;">except</span> smtplib.SMTPException:
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"Error: &#26080;&#27861;&#21457;&#36865;&#37038;&#20214;"</span>)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_rds_info</span>(fileter=<span style="color: #008b8b;">None</span>):
    <span style="color: #8b2252;">'''Get aliyun RDS information'''</span>

    <span style="color: #a0522d;">request</span> = DescribeDBInstancesRequest()
    request.set_accept_format(<span style="color: #8b2252;">'json'</span>)

    request.set_DBInstanceStatus(<span style="color: #8b2252;">"Running"</span>)
    request.set_Engine(<span style="color: #8b2252;">"MySQL"</span>)
    request.set_ClientToken(<span style="color: #8b2252;">"123455667"</span>)

    <span style="color: #a0522d;">response</span> = client.do_action_with_exception(request)

    <span style="color: #a020f0;">if</span> fileter == <span style="color: #008b8b;">None</span>:
        <span style="color: #a0522d;">fileter</span>=<span style="color: #8b2252;">""</span>

    <span style="color: #a0522d;">my_list</span>={}
    <span style="color: #a0522d;">rds_info</span>=json.loads(response)
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> rds_info[<span style="color: #8b2252;">'Items'</span>][<span style="color: #8b2252;">'DBInstance'</span>]:
        <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'private'</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> i[<span style="color: #8b2252;">'DBInstanceDescription'</span>]:
            <span style="color: #a020f0;">if</span> re.<span style="color: #a020f0;">match</span>(r<span style="color: #8b2252;">'.*'</span>+fileter+<span style="color: #8b2252;">'.*'</span>, i[<span style="color: #8b2252;">'DBInstanceDescription'</span>]):
                my_list[i[<span style="color: #8b2252;">'DBInstanceDescription'</span>]]=i[<span style="color: #8b2252;">'DBInstanceId'</span>]

    <span style="color: #a020f0;">return</span> my_list

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_rds_more</span>(<span style="color: #483d8b;">id</span>):
    <span style="color: #a0522d;">request</span> = DescribeDBInstanceAttributeRequest()
    request.set_accept_format(<span style="color: #8b2252;">'json'</span>)

    request.set_DBInstanceId(<span style="color: #483d8b;">id</span>)

    <span style="color: #a0522d;">response</span> = client.do_action_with_exception(request)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">python2:  print(response)</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(str(response, encoding='utf-8'))</span>

    <span style="color: #a0522d;">my_list</span> = {}
    <span style="color: #a0522d;">rds_more</span> = json.loads(response)
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> rds_more[<span style="color: #8b2252;">'Items'</span>][<span style="color: #8b2252;">'DBInstanceAttribute'</span>]:
        <span style="color: #a0522d;">my_list</span>[<span style="color: #8b2252;">'MaxConnections'</span>] = i[<span style="color: #8b2252;">'MaxConnections'</span>]
        <span style="color: #a0522d;">my_list</span>[<span style="color: #8b2252;">'MaxIOPS'</span>] = i[<span style="color: #8b2252;">'MaxIOPS'</span>]
        <span style="color: #a0522d;">my_list</span>[<span style="color: #8b2252;">'DBInstanceStorage'</span>] = i[<span style="color: #8b2252;">'DBInstanceStorage'</span>] <span style="color: #b22222;"># </span><span style="color: #b22222;">GB</span>
        <span style="color: #a0522d;">my_list</span>[<span style="color: #8b2252;">'DBInstanceId'</span>] = i[<span style="color: #8b2252;">'DBInstanceId'</span>]
        <span style="color: #a0522d;">my_list</span>[<span style="color: #8b2252;">'RegionId'</span>] = i[<span style="color: #8b2252;">'RegionId'</span>]
        <span style="color: #a0522d;">my_list</span>[<span style="color: #8b2252;">'DBInstanceDescription'</span>] = i[<span style="color: #8b2252;">'DBInstanceDescription'</span>]
    <span style="color: #a020f0;">return</span> my_list

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_rds_performance_info</span>(<span style="color: #483d8b;">id</span>, keys, time_now):
    <span style="color: #8b2252;">'''Get RDS Performance information'''</span>

    <span style="color: #a0522d;">request</span> = DescribeDBInstancePerformanceRequest()
    request.set_accept_format(<span style="color: #8b2252;">'json'</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">start_time = (time_now - datetime.timedelta(days=6) - datetime.timedelta(hours=8)).strftime(</span>
    <span style="color: #b22222;">#     </span><span style="color: #b22222;">'%Y-%m-%dT%H:%MZ')</span>
    <span style="color: #a0522d;">start_time</span> = (time_now - datetime.timedelta(days=3) - datetime.timedelta(hours=8)).strftime(<span style="color: #8b2252;">'%Y-%m-%dT%H:%MZ'</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">start_time = (time_now - datetime.timedelta(hours=8,minutes=3)).strftime('%Y-%m-%dT%H:%MZ')</span>
    <span style="color: #a0522d;">end_time</span> = (time_now -datetime.timedelta(hours=8)).strftime(<span style="color: #8b2252;">'%Y-%m-%dT%H:%MZ'</span>)
    request.set_EndTime(end_time)
    request.set_StartTime(start_time)
    request.set_Key(keys)
    request.set_DBInstanceId(<span style="color: #483d8b;">id</span>)

    <span style="color: #a0522d;">response</span> = client.do_action_with_exception(request)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">python2:  print(response)</span>
    <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">str</span>(response, encoding=<span style="color: #8b2252;">'utf-8'</span>)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_rds_slowlog_info</span>(<span style="color: #483d8b;">id</span>,time_now, page_num):
    <span style="color: #a0522d;">request</span> = DescribeSlowLogsRequest()
    request.set_accept_format(<span style="color: #8b2252;">'json'</span>)

    request.set_PageNumber(page_num)
    request.set_SortKey(<span style="color: #8b2252;">"TotalQueryTimes"</span>)
    <span style="color: #a0522d;">start_time</span> = (time_now - datetime.timedelta(days=1)).strftime(<span style="color: #8b2252;">'%Y-%m-%dZ'</span>)
    <span style="color: #a0522d;">end_time</span> = time_now.strftime(<span style="color: #8b2252;">'%Y-%m-%dZ'</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print("start_time:{0},end_time:{1}".format(start_time, end_time))</span>
    request.set_EndTime(end_time)
    request.set_StartTime(start_time)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">request.set_DBInstanceId("rr-2ze1a2d2rkuknvvp0")</span>
    request.set_DBInstanceId(<span style="color: #483d8b;">id</span>)

    <span style="color: #a0522d;">response</span> = client.do_action_with_exception(request)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">python2:  print(response)</span>
    <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">str</span>(response, encoding=<span style="color: #8b2252;">'utf-8'</span>)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">utc_to_local</span>(india_time_str,india_format = <span style="color: #8b2252;">'%Y-%m-%dT%H:%M:%SZ'</span>):
    <span style="color: #8b2252;">'''UTC to beijing timestamp'''</span>

    <span style="color: #a0522d;">india_dt</span> = datetime.datetime.strptime(india_time_str, india_format).replace(second=0,microsecond=0)
    <span style="color: #a0522d;">local_dt</span> = india_dt + datetime.timedelta(hours=8,minutes=0)
    <span style="color: #a0522d;">local_format</span> = <span style="color: #8b2252;">"%Y-%m-%d %H:%M:%S"</span>
    <span style="color: #a0522d;">time_str</span> = local_dt.strftime(local_format)
    <span style="color: #a020f0;">return</span> time_str

<span style="color: #a020f0;">import</span> rrdtool
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">create_rrd</span>(name,key_ds, key_id, merge_flag):
    <span style="color: #8b2252;">'''create rrd'''</span>

    <span style="color: #a0522d;">rrd_dir</span> = <span style="color: #8b2252;">'/data/rrdtool_data/'</span>
    <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> os.path.exists(rrd_dir):
        os.makedirs(rrd_dir)

    <span style="color: #a0522d;">cur_time</span> = <span style="color: #483d8b;">str</span>(<span style="color: #483d8b;">int</span>((datetime.datetime.now() - datetime.timedelta(days=128)).replace(hour=9,minute=0,second=0,microsecond=0).timestamp()))  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33719;&#21462;&#24403;&#21069;Linux&#26102;&#38388;&#25139;&#20316;&#20026;rrd&#36215;&#22987;&#26102;&#38388;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(cur_time)</span>

    <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'SQLSlowLog'</span> <span style="color: #a020f0;">in</span> name:
        <span style="color: #a0522d;">rrd_RRA</span> = [
            <span style="color: #8b2252;">'RRA:AVERAGE:0.5:1:600'</span>,
            <span style="color: #8b2252;">'RRA:AVERAGE:0.5:6:700'</span>,
            <span style="color: #8b2252;">'RRA:AVERAGE:0.5:24:775'</span>,
            <span style="color: #8b2252;">'RRA:AVERAGE:0.5:288:797'</span>,
            <span style="color: #8b2252;">'RRA:MAX:0.5:1:600'</span>,
            <span style="color: #8b2252;">'RRA:MAX:0.5:6:700'</span>,
            <span style="color: #8b2252;">'RRA:MAX:0.5:24:775'</span>,
            <span style="color: #8b2252;">'RRA:MAX:0.5:444:797'</span>,
            <span style="color: #8b2252;">'RRA:MIN:0.5:1:600'</span>,
            <span style="color: #8b2252;">'RRA:MIN:0.5:6:700'</span>,
            <span style="color: #8b2252;">'RRA:MIN:0.5:24:775'</span>,
            <span style="color: #8b2252;">'RRA:MIN:0.5:444:797'</span>,
        ]

    <span style="color: #a020f0;">else</span>:
        <span style="color: #a0522d;">rrd_RRA</span> = [
            <span style="color: #8b2252;">'RRA:AVERAGE:0.5:1:2880'</span>,
            <span style="color: #8b2252;">'RRA:AVERAGE:0.5:6:3360'</span>,
            <span style="color: #8b2252;">'RRA:AVERAGE:0.5:24:3870'</span>,
            <span style="color: #8b2252;">'RRA:AVERAGE:0.5:288:3985'</span>,
            <span style="color: #8b2252;">'RRA:MAX:0.5:1:2880'</span>,
            <span style="color: #8b2252;">'RRA:MAX:0.5:6:3360'</span>,
            <span style="color: #8b2252;">'RRA:MAX:0.5:24:3870'</span>,
            <span style="color: #8b2252;">'RRA:MAX:0.5:444:3985'</span>,
            <span style="color: #8b2252;">'RRA:MIN:0.5:1:2880'</span>,
            <span style="color: #8b2252;">'RRA:MIN:0.5:6:3360'</span>,
            <span style="color: #8b2252;">'RRA:MIN:0.5:24:3870'</span>,
            <span style="color: #8b2252;">'RRA:MIN:0.5:444:3985'</span>,
        ]

    <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> merge_flag:
        <span style="color: #a020f0;">for</span> <span style="color: #483d8b;">id</span> <span style="color: #a020f0;">in</span> key_id:
            <span style="color: #a0522d;">rrd_DS</span> = []
            <span style="color: #a020f0;">for</span> DS <span style="color: #a020f0;">in</span> key_ds:
                <span style="color: #a0522d;">DS</span> = <span style="color: #8b2252;">''</span>.join(DS.replace(<span style="color: #8b2252;">'-'</span>,<span style="color: #8b2252;">'_'</span>).split(<span style="color: #8b2252;">'_'</span>)[-3:]) + <span style="color: #8b2252;">"_"</span> + <span style="color: #483d8b;">id</span>[0:3]
                rrd_DS.append(<span style="color: #8b2252;">'DS:'</span>+ DS +<span style="color: #8b2252;">':GAUGE:120:0:U'</span>)
            <span style="color: #b22222;"># </span><span style="color: #b22222;">print(rrd_DS) # ['DS:active_session:GAUGE:600:0:U', 'DS:total_session:GAUGE:600:0:U']</span>

            <span style="color: #a0522d;">rrd_name</span> = rrd_dir + name + <span style="color: #8b2252;">'_'</span> + <span style="color: #483d8b;">id</span> + <span style="color: #8b2252;">'.rrd'</span>

            <span style="color: #a020f0;">if</span>  <span style="color: #a020f0;">not</span> os.path.exists(rrd_name):
                <span style="color: #a0522d;">rrd</span> = rrdtool.create(rrd_name, <span style="color: #8b2252;">'--step'</span>, <span style="color: #8b2252;">'60'</span>, <span style="color: #8b2252;">'--start'</span>, cur_time,
                                    rrd_DS,rrd_RRA)
                <span style="color: #a020f0;">if</span> rrd:
                    <span style="color: #483d8b;">print</span> (rrdtool.error())
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a0522d;">rrd_DS</span> = []
        <span style="color: #a020f0;">for</span> <span style="color: #483d8b;">id</span> <span style="color: #a020f0;">in</span> key_id:
            <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'SQLSlowLog'</span> <span style="color: #a020f0;">in</span> name:
                <span style="color: #a020f0;">for</span> DS <span style="color: #a020f0;">in</span> key_ds:
                    <span style="color: #a0522d;">DS</span> = <span style="color: #8b2252;">''</span>.join(DS.replace(<span style="color: #8b2252;">'-'</span>,<span style="color: #8b2252;">'_'</span>).split(<span style="color: #8b2252;">'_'</span>)[-3:]) + <span style="color: #8b2252;">"_"</span> + <span style="color: #483d8b;">id</span>[0:3]
                    rrd_DS.append(<span style="color: #8b2252;">'DS:'</span>+ DS +<span style="color: #8b2252;">':GAUGE:172800:0:U'</span>)
            <span style="color: #a020f0;">else</span>:
                <span style="color: #a020f0;">for</span> DS <span style="color: #a020f0;">in</span> key_ds:
                    <span style="color: #a0522d;">DS</span> = <span style="color: #8b2252;">''</span>.join(DS.replace(<span style="color: #8b2252;">'-'</span>,<span style="color: #8b2252;">'_'</span>).split(<span style="color: #8b2252;">'_'</span>)[-3:]) + <span style="color: #8b2252;">"_"</span> + <span style="color: #483d8b;">id</span>[0:3]
                    rrd_DS.append(<span style="color: #8b2252;">'DS:'</span>+ DS +<span style="color: #8b2252;">':GAUGE:120:0:U'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(rrd_DS) # ['DS:active_session:GAUGE:600:0:U', 'DS:total_session:GAUGE:600:0:U']</span>

        <span style="color: #a0522d;">rrd_name</span> = rrd_dir + name + <span style="color: #8b2252;">'.rrd'</span>

        <span style="color: #a020f0;">if</span>  <span style="color: #a020f0;">not</span> os.path.exists(rrd_name):
            <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'SQLSlowLog'</span> <span style="color: #a020f0;">in</span> name:
                <span style="color: #a0522d;">rrd</span> = rrdtool.create(rrd_name, <span style="color: #8b2252;">'--step'</span>, <span style="color: #8b2252;">'86400'</span>, <span style="color: #8b2252;">'--start'</span>, cur_time,rrd_DS,rrd_RRA)
            <span style="color: #a020f0;">else</span>:
                <span style="color: #a0522d;">rrd</span> = rrdtool.create(rrd_name, <span style="color: #8b2252;">'--step'</span>, <span style="color: #8b2252;">'60'</span>, <span style="color: #8b2252;">'--start'</span>, cur_time,rrd_DS,rrd_RRA)

            <span style="color: #a020f0;">if</span> rrd:
                <span style="color: #483d8b;">print</span> (rrdtool.error())

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">update_rrd</span>(name, value, rrd_time, key_id, num, merge_flag):
    <span style="color: #8b2252;">'''update rrd'''</span>

    <span style="color: #a0522d;">rrd_dir</span> = <span style="color: #8b2252;">'/data/rrdtool_data/'</span>

    <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> merge_flag <span style="color: #a020f0;">and</span> <span style="color: #483d8b;">len</span>(value) == num :
        <span style="color: #a020f0;">for</span> num,<span style="color: #483d8b;">id</span> <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">enumerate</span>(key_id):
            <span style="color: #a0522d;">rrd_name</span> = rrd_dir + name + <span style="color: #8b2252;">'_'</span> + <span style="color: #483d8b;">id</span> + <span style="color: #8b2252;">'.rrd'</span>

            <span style="color: #a0522d;">last_update_time</span> = rrdtool.last(rrd_name)

            <span style="color: #a020f0;">if</span> rrd_time &gt; last_update_time:
                <span style="color: #b22222;"># </span><span style="color: #b22222;">print("last:", last_update_time, "cur:", rrd_time, )</span>
                <span style="color: #a0522d;">str_value</span> = []
                <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> value:
                    str_value.append(i[num])
                <span style="color: #a0522d;">str_value</span> = <span style="color: #8b2252;">'{}:{}'</span>.<span style="color: #483d8b;">format</span>(<span style="color: #483d8b;">str</span>(rrd_time), <span style="color: #8b2252;">':'</span>.join(str_value))
                <span style="color: #b22222;"># </span><span style="color: #b22222;">print(str_value) #1558592494:1.04:19.7</span>

                <span style="color: #a0522d;">update</span> = rrdtool.updatev(rrd_name, str_value)
                <span style="color: #b22222;"># </span><span style="color: #b22222;">print(update)</span>
    <span style="color: #a020f0;">elif</span> merge_flag <span style="color: #a020f0;">and</span> <span style="color: #483d8b;">len</span>(value) == num:
        <span style="color: #a0522d;">rrd_name</span> = rrd_dir + name+<span style="color: #8b2252;">'.rrd'</span>

        <span style="color: #a0522d;">last_update_time</span> = rrdtool.last(rrd_name)

        <span style="color: #a020f0;">if</span> rrd_time &gt; last_update_time:
            <span style="color: #b22222;"># </span><span style="color: #b22222;">print("last:", last_update_time, "cur:", rrd_time, )</span>
            <span style="color: #a0522d;">str_value</span> = []
            <span style="color: #a020f0;">for</span> num, _ <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">enumerate</span>(key_id):
                <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> value:
                    str_value.append(i[num])
            <span style="color: #a0522d;">str_value</span> = <span style="color: #8b2252;">'{}:{}'</span>.<span style="color: #483d8b;">format</span>(<span style="color: #483d8b;">str</span>(rrd_time), <span style="color: #8b2252;">':'</span>.join(str_value))
            <span style="color: #b22222;"># </span><span style="color: #b22222;">print(str_value) #1558592494:1.04:19.7</span>

            <span style="color: #a0522d;">update</span> = rrdtool.updatev(rrd_name, str_value)
            <span style="color: #b22222;"># </span><span style="color: #b22222;">print(update)</span>

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">graph_rrd</span>(name, key_ds, key_unit, key_id, merge_flag, select=<span style="color: #8b2252;">'week'</span> ):
    <span style="color: #8b2252;">'''graph rrd'''</span>

    <span style="color: #a0522d;">rrd_dir</span> = <span style="color: #8b2252;">'/data/rrdtool_data/'</span>

    <span style="color: #a0522d;">custum_file</span> = rrd_dir + name +<span style="color: #8b2252;">'.png'</span>
    <span style="color: #a0522d;">custum_d</span> = [<span style="color: #8b2252;">'-s'</span>, <span style="color: #8b2252;">"now-30h"</span>, <span style="color: #8b2252;">'-e'</span>, <span style="color: #8b2252;">'now-1min'</span>, <span style="color: #8b2252;">'-t'</span>, name + <span style="color: #8b2252;">' 30 hours ago'</span>, <span style="color: #8b2252;">'--x-grid'</span>, <span style="color: #8b2252;">'MINUTE:12:HOUR:1:HOUR:1:0:%H'</span>]
    <span style="color: #a0522d;">custum_w</span> = [<span style="color: #8b2252;">'-s'</span>, <span style="color: #8b2252;">"-8day"</span>, <span style="color: #8b2252;">'-e'</span>, <span style="color: #8b2252;">'now-1min'</span>, <span style="color: #8b2252;">'-t'</span>, name + <span style="color: #8b2252;">' week'</span>, <span style="color: #8b2252;">'--x-grid'</span>, <span style="color: #8b2252;">'MONTH:1:MONTH:1:HOUR:24:0:%d'</span>]
    <span style="color: #a0522d;">custum_m</span> = [<span style="color: #8b2252;">'-s'</span>, <span style="color: #8b2252;">"-40day"</span>, <span style="color: #8b2252;">'-e'</span>, <span style="color: #8b2252;">'now-1min'</span>, <span style="color: #8b2252;">'-t'</span>, name + <span style="color: #8b2252;">' last month'</span>, <span style="color: #8b2252;">'--x-grid'</span>, <span style="color: #8b2252;">'HOUR:12:HOUR:24:HOUR:24:0:%d'</span>]
    <span style="color: #a0522d;">custum_y</span> = [<span style="color: #8b2252;">'-s'</span>, <span style="color: #8b2252;">"-20month"</span>, <span style="color: #8b2252;">'-e'</span>, <span style="color: #8b2252;">'now-1min'</span>, <span style="color: #8b2252;">'-t'</span>, name + <span style="color: #8b2252;">' last year'</span>, <span style="color: #8b2252;">'--x-grid'</span>, <span style="color: #8b2252;">'MONTH:1:MONTH:1:MONTH:1:0:%b'</span>]

    <span style="color: #a0522d;">custum_str</span> = custum_w
    <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'day'</span> == select:
        <span style="color: #a0522d;">custum_str</span> = custum_d
    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'week'</span> == select:
        <span style="color: #a0522d;">custum_str</span> = custum_w
    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'month'</span> == select:
        <span style="color: #a0522d;">custum_str</span> = custum_m
    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'year'</span> == select:
        <span style="color: #a0522d;">custum_str</span> = custum_y

    <span style="color: #b22222;"># </span><span style="color: #b22222;">custum_size = ['-Y', '-w', '900', '-h', '400', '-v', key_unit]</span>
    <span style="color: #a0522d;">custum_size</span> = [<span style="color: #8b2252;">'-Y'</span>, <span style="color: #8b2252;">'-w'</span>, <span style="color: #8b2252;">'700'</span>, <span style="color: #8b2252;">'-h'</span>, <span style="color: #8b2252;">'300'</span>, <span style="color: #8b2252;">'-v'</span>, key_unit]

    <span style="color: #a0522d;">color_dict</span> = {
        <span style="color: #8b2252;">'&#34013;'</span>:<span style="color: #8b2252;">'#0000ff'</span>,
        <span style="color: #8b2252;">'&#27973;&#34013;'</span>:<span style="color: #8b2252;">'#00FFFF'</span>,
        <span style="color: #8b2252;">'&#32511;'</span>:<span style="color: #8b2252;">'#00ff00'</span>,
        <span style="color: #8b2252;">'&#32043;'</span>:<span style="color: #8b2252;">'#FF00FF'</span>,
        <span style="color: #8b2252;">'&#40644;'</span>:<span style="color: #8b2252;">'#FFFF00'</span>,
        <span style="color: #8b2252;">'&#27973;&#31881;&#32418;'</span>:<span style="color: #8b2252;">'#FFB6C1'</span>,
        <span style="color: #8b2252;">'&#20848;&#33457;&#30340;&#32043;&#33394;'</span>:<span style="color: #8b2252;">'#DA70D6'</span>,
        <span style="color: #8b2252;">'&#28145;&#27915;&#32418;&#33394;'</span>:<span style="color: #8b2252;">'#8B008B'</span>,
        <span style="color: #8b2252;">'&#36866;&#20013;&#30340;&#32043;&#33394;'</span>:<span style="color: #8b2252;">'#9370DB'</span>,
        <span style="color: #8b2252;">'&#36866;&#20013;&#30340;&#26495;&#23721;&#26263;&#34013;&#28784;&#33394;'</span>:<span style="color: #8b2252;">'#7B68EE'</span>,
        <span style="color: #8b2252;">'&#30343;&#23478;&#34013;'</span>:<span style="color: #8b2252;">'#4169E1'</span>,
        <span style="color: #8b2252;">'&#28129;&#38050;&#34013;'</span>:<span style="color: #8b2252;">'#B0C4DE'</span>,
        <span style="color: #8b2252;">'&#27973;&#30707;&#26495;&#28784;'</span>:<span style="color: #8b2252;">'#778899'</span>,
        <span style="color: #8b2252;">'&#22825;&#34013;&#33394;'</span>:<span style="color: #8b2252;">'#87CEEB'</span>,
        <span style="color: #8b2252;">'&#20891;&#26657;&#34013;'</span>:<span style="color: #8b2252;">'#5F9EA0'</span>,
        <span style="color: #8b2252;">'&#28145;&#32511;&#23453;&#30707;'</span>:<span style="color: #8b2252;">'#00CED1'</span>,
        <span style="color: #8b2252;">'&#26149;&#22825;&#30340;&#32511;&#33394;'</span>:<span style="color: #8b2252;">'#3CB371'</span>,
        <span style="color: #8b2252;">'&#33609;&#22378;&#32511;'</span>:<span style="color: #8b2252;">'#7CFC00'</span>,
        <span style="color: #8b2252;">'&#32511;&#40644;&#33394;'</span>:<span style="color: #8b2252;">'#ADFF2F'</span>,
        <span style="color: #8b2252;">'&#28145;&#21345;&#20854;&#24067;'</span>:<span style="color: #8b2252;">'#BDB76B'</span>,
        <span style="color: #8b2252;">'&#27204;&#27012;'</span>:<span style="color: #8b2252;">'#808000'</span>,
        <span style="color: #8b2252;">'&#28784;&#31179;&#40594;&#40607;'</span>:<span style="color: #8b2252;">'#EEE8AA'</span>,
        <span style="color: #8b2252;">'&#37329;'</span>:<span style="color: #8b2252;">'#FFD700'</span>,
        <span style="color: #8b2252;">'&#24039;&#20811;&#21147;'</span>:<span style="color: #8b2252;">'#D2691E'</span>,
        <span style="color: #8b2252;">'&#28145;&#27225;&#33394;'</span>:<span style="color: #8b2252;">'#FF8C00'</span>,
        <span style="color: #8b2252;">'&#28145;&#28784;&#33394;'</span>:<span style="color: #8b2252;">'#A9A9A9'</span>,
    }

    <span style="color: #a0522d;">color</span> = <span style="color: #483d8b;">list</span>(color_dict.values())
    random.shuffle(color)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">color = ['#00FFFF', '#FF00FF', '#FFFF00', '#0000ff', '#00ff00']*200</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">MySQL_MemCpuUsage MySQL&#23454;&#20363;CPU&#20351;&#29992;&#29575;(&#21344;&#25805;&#20316;&#31995;&#32479;&#24635;&#25968;)&#65292;MySQL&#23454;&#20363;&#20869;&#23384;&#20351;&#29992;&#29575;(&#21344;&#25805;&#20316;&#31995;&#32479;&#24635;&#25968;)&#12290;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">MySQL_Sessions    &#24403;&#21069;&#27963;&#36291;&#36830;&#25509;&#25968;&#65292;&#24403;&#21069;&#24635;&#36830;&#25509;&#25968;&#12290;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">slavestat &#21482;&#35835;&#23454;&#20363;&#24310;&#36831;&#12290;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">MySQL_IOPS    MySQL&#23454;&#20363;&#30340;IOPS&#65288;&#27599;&#31186;IO&#35831;&#27714;&#27425;&#25968;&#65289;&#12290;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">MySQL_NetworkTraffic  MySQL&#23454;&#20363;&#24179;&#22343;&#27599;&#31186;&#38047;&#30340;&#36755;&#20837;&#27969;&#37327;&#65292;MySQL&#23454;&#20363;&#24179;&#22343;&#27599;&#31186;&#38047;&#30340;&#36755;&#20986;&#27969;&#37327;&#12290;&#21333;&#20301;&#20026;KB&#12290;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">MySQL_DetailedSpaceUsage  MySQL&#23454;&#20363;&#31354;&#38388;&#21344;&#29992;&#35814;&#24773;&#65306;ins_size&#23454;&#20363;&#24635;&#31354;&#38388;&#20351;&#29992;&#37327;;data_size&#25968;&#25454;&#31354;&#38388;;log_size&#26085;&#24535;&#31354;&#38388;;tmp_size&#20020;&#26102;&#31354;&#38388;;other_size&#31995;&#32479;&#31354;&#38388;&#12290;</span>
    <span style="color: #a0522d;">graph</span> = [<span style="color: #8b2252;">'LINE2'</span>, <span style="color: #8b2252;">'LINE2'</span>, <span style="color: #8b2252;">'LINE2'</span>]*200
    <span style="color: #b22222;">#</span><span style="color: #b22222;">print(''.join(name.partition('MySQL')[-2:]))</span>
    <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">''</span>.join(name.partition(<span style="color: #8b2252;">'MySQL'</span>)[-2:]) <span style="color: #a020f0;">in</span> [<span style="color: #8b2252;">'MySQL_MemCpuUsage'</span>, <span style="color: #8b2252;">'MySQL_IOPS'</span>]:
        <span style="color: #a0522d;">graph</span> = [<span style="color: #8b2252;">'LINE2'</span>, <span style="color: #8b2252;">'LINE2'</span>, <span style="color: #8b2252;">'LINE2'</span>]*200
    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">''</span>.join(name.partition(<span style="color: #8b2252;">'MySQL'</span>)[-2:]) <span style="color: #a020f0;">in</span> [<span style="color: #8b2252;">'MySQL_DetailedSpaceUsage'</span>]:
        <span style="color: #a0522d;">graph</span> = [<span style="color: #8b2252;">'LINE2'</span>, <span style="color: #8b2252;">'LINE2'</span>, <span style="color: #8b2252;">'LINE2'</span>]*200
    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">''</span>.join(name.partition(<span style="color: #8b2252;">'MySQL'</span>)[-2:]) <span style="color: #a020f0;">in</span> [<span style="color: #8b2252;">'MySQL_NetworkTraffic'</span>]:
        <span style="color: #a0522d;">graph</span> = [<span style="color: #8b2252;">'AREA'</span>, <span style="color: #8b2252;">'LINE2'</span>]*200

    <span style="color: #a0522d;">rrd_HRULE</span> = <span style="color: #8b2252;">"-Y"</span>
    <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">"%"</span> <span style="color: #a020f0;">in</span> key_unit:
        <span style="color: #a0522d;">rrd_HRULE</span> = <span style="color: #8b2252;">"HRULE:90#FF0000:Alarm value</span><span style="color: #008b8b;">\\</span><span style="color: #8b2252;">r"</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">: &#38656;&#35201;&#36716;&#20041;</span>
    <span style="color: #a0522d;">cur_time</span> = datetime.datetime.now().strftime(<span style="color: #8b2252;">"%Y-%m-%d %H\:%M\:%S"</span>)

    <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> merge_flag:
        <span style="color: #a020f0;">for</span> <span style="color: #483d8b;">id</span> <span style="color: #a020f0;">in</span> key_id:
            <span style="color: #a0522d;">custum_file</span> = <span style="color: #8b2252;">'/data/rrdtool_data/'</span> + name + <span style="color: #8b2252;">'_'</span> + <span style="color: #483d8b;">id</span> +<span style="color: #8b2252;">'.png'</span>
            <span style="color: #a0522d;">custum_d</span> = [<span style="color: #8b2252;">'-s'</span>, <span style="color: #8b2252;">"now-30h"</span>, <span style="color: #8b2252;">'-e'</span>, <span style="color: #8b2252;">'now-1min'</span>, <span style="color: #8b2252;">'-t'</span>, name + <span style="color: #8b2252;">'_'</span> + <span style="color: #483d8b;">id</span> +<span style="color: #8b2252;">' 30 hours ago'</span>, <span style="color: #8b2252;">'--x-grid'</span>,
                        <span style="color: #8b2252;">'MINUTE:12:HOUR:1:HOUR:1:0:%H'</span>]
            <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'SQLSlowLog'</span> <span style="color: #a020f0;">in</span> name:
                <span style="color: #a0522d;">custum_w</span> = [<span style="color: #8b2252;">'-s'</span>, <span style="color: #8b2252;">"-8day"</span>, <span style="color: #8b2252;">'-e'</span>, <span style="color: #8b2252;">'now-1min'</span>, <span style="color: #8b2252;">'-t'</span>, name + <span style="color: #8b2252;">'_'</span> + <span style="color: #483d8b;">id</span> + <span style="color: #8b2252;">' week'</span>, <span style="color: #8b2252;">'--x-grid'</span>,
                            <span style="color: #8b2252;">'MONTH:1:MONTH:1:HOUR:24:0:%d'</span>]
            <span style="color: #a020f0;">else</span>:
                <span style="color: #a0522d;">custum_w</span> = [<span style="color: #8b2252;">'-s'</span>, <span style="color: #8b2252;">"-8day"</span>, <span style="color: #8b2252;">'-e'</span>, <span style="color: #8b2252;">'now-1min'</span>, <span style="color: #8b2252;">'-t'</span>, name + <span style="color: #8b2252;">'_'</span> + <span style="color: #483d8b;">id</span> + <span style="color: #8b2252;">' week'</span>, <span style="color: #8b2252;">'--x-grid'</span>, <span style="color: #8b2252;">'MONTH:1:MONTH:1:HOUR:24:0:%d'</span>]

            <span style="color: #a0522d;">custum_m</span> = [<span style="color: #8b2252;">'-s'</span>, <span style="color: #8b2252;">"-40day"</span>, <span style="color: #8b2252;">'-e'</span>, <span style="color: #8b2252;">'now-1min'</span>, <span style="color: #8b2252;">'-t'</span>, name + <span style="color: #8b2252;">'_'</span> + <span style="color: #483d8b;">id</span> +<span style="color: #8b2252;">' last month'</span>, <span style="color: #8b2252;">'--x-grid'</span>,
                        <span style="color: #8b2252;">'HOUR:12:HOUR:24:HOUR:24:0:%d'</span>]
            <span style="color: #a0522d;">custum_y</span> = [<span style="color: #8b2252;">'-s'</span>, <span style="color: #8b2252;">"-20month"</span>, <span style="color: #8b2252;">'-e'</span>, <span style="color: #8b2252;">'now-1min'</span>, <span style="color: #8b2252;">'-t'</span>, name + <span style="color: #8b2252;">'_'</span> + <span style="color: #483d8b;">id</span> + <span style="color: #8b2252;">' last year'</span>, <span style="color: #8b2252;">'--x-grid'</span>,
                        <span style="color: #8b2252;">'MONTH:1:MONTH:1:MONTH:1:0:%b'</span>]

            <span style="color: #a0522d;">custum_str</span> = custum_w
            <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'day'</span> == select:
                <span style="color: #a0522d;">custum_str</span> = custum_d
            <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'week'</span> == select:
                <span style="color: #a0522d;">custum_str</span> = custum_w
            <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'month'</span> == select:
                <span style="color: #a0522d;">custum_str</span> = custum_m
            <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'year'</span> == select:
                <span style="color: #a0522d;">custum_str</span> = custum_y

            <span style="color: #a0522d;">rrd_name</span> = rrd_dir + name + <span style="color: #8b2252;">'_'</span> + <span style="color: #483d8b;">id</span> + <span style="color: #8b2252;">'.rrd'</span>

            <span style="color: #a0522d;">rrd_DEF</span> = []
            <span style="color: #a020f0;">for</span> DS <span style="color: #a020f0;">in</span> key_ds:
                <span style="color: #a0522d;">DS</span> = <span style="color: #8b2252;">''</span>.join(DS.replace(<span style="color: #8b2252;">'-'</span>,<span style="color: #8b2252;">'_'</span>).split(<span style="color: #8b2252;">'_'</span>)[-3:]) + <span style="color: #8b2252;">"_"</span> + <span style="color: #483d8b;">id</span>[0:3]
                rrd_DEF.append(<span style="color: #8b2252;">'DEF:v_{}={}:{}:AVERAGE'</span>.<span style="color: #483d8b;">format</span>(DS,rrd_name,DS))
            <span style="color: #b22222;"># </span><span style="color: #b22222;">print(rrd_DEF) # exampale ['DEF:v_cpuusage=/xxx.rrd:cpuusage:LAST',]</span>

            <span style="color: #a0522d;">ds_length</span> = []
            <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> key_ds:
                <span style="color: #a0522d;">i</span> = <span style="color: #8b2252;">''</span>.join(DS.replace(<span style="color: #8b2252;">'-'</span>, <span style="color: #8b2252;">'_'</span>).split(<span style="color: #8b2252;">'_'</span>)[-3:]) + <span style="color: #8b2252;">"_"</span> + <span style="color: #483d8b;">id</span>[0:3]
                ds_length.append(<span style="color: #483d8b;">len</span>(i))
            <span style="color: #a0522d;">max_length</span> = <span style="color: #483d8b;">max</span>(ds_length)
            <span style="color: #a0522d;">rrd_GRAPH</span> = []
            <span style="color: #a020f0;">for</span> DS <span style="color: #a020f0;">in</span> key_ds:
                <span style="color: #a0522d;">DS</span> = <span style="color: #8b2252;">''</span>.join(DS.replace(<span style="color: #8b2252;">'-'</span>, <span style="color: #8b2252;">'_'</span>).split(<span style="color: #8b2252;">'_'</span>)[-3:]) + <span style="color: #8b2252;">"_"</span> + <span style="color: #483d8b;">id</span>[0:3]
                rrd_GRAPH.append(<span style="color: #8b2252;">"{}:v_{}{}:{}{}"</span>.<span style="color: #483d8b;">format</span>(graph.pop(), DS, color.pop(), DS, <span style="color: #8b2252;">' '</span> * (max_length - <span style="color: #483d8b;">len</span>(DS))))
                rrd_GRAPH.append(<span style="color: #8b2252;">"GPRINT:v_{}:LAST:LAST\: %6.2lf%s"</span>.<span style="color: #483d8b;">format</span>(DS))
                rrd_GRAPH.append(<span style="color: #8b2252;">"GPRINT:v_{}:AVERAGE:AVERAGE\: %6.2lf%s"</span>.<span style="color: #483d8b;">format</span>(DS))
                rrd_GRAPH.append(<span style="color: #8b2252;">"GPRINT:v_{}:MAX:MAX\: %6.2lf%s"</span>.<span style="color: #483d8b;">format</span>(DS))
                rrd_GRAPH.append(<span style="color: #8b2252;">"GPRINT:v_{}:MIN:MIN\: %6.2lf%s"</span>.<span style="color: #483d8b;">format</span>(DS))
                rrd_GRAPH.append(<span style="color: #8b2252;">"COMMENT:</span><span style="color: #008b8b;">\\</span><span style="color: #8b2252;">n"</span>)

            <span style="color: #b22222;"># </span><span style="color: #b22222;">AREA:value1#00ff00:"cpuusage\t"</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">GPRINT:value1:LAST:'LAST\: %6.2lf%s\t'</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">GPRINT:value1:AVERAGE:'AVERAGE\: %6.2lf%s\t'</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">GPRINT:value1:MAX:'MAX\: %6.2lf%s\t'</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">GPRINT:value1:MIN:'MIN\: %6.2lf%s\t'</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">COMMENT:"\n"</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">custum_list = ["COMMENT:\\n","COMMENT:" + ' ' * max_length + "\t\t  LAST\t\t\t AVERAGE\t\tMAX\t\t\tMIN","COMMENT:\\n"]</span>
            <span style="color: #a0522d;">custum_list</span> = [<span style="color: #8b2252;">"COMMENT:</span><span style="color: #008b8b;">\\</span><span style="color: #8b2252;">n"</span>,<span style="color: #8b2252;">"COMMENT:"</span> + <span style="color: #8b2252;">' '</span> * max_length + <span style="color: #8b2252;">"</span><span style="color: #008b8b;">\t</span><span style="color: #8b2252;">  LAST</span><span style="color: #008b8b;">\t\t</span><span style="color: #8b2252;"> AVERAGE</span><span style="color: #008b8b;">\t</span><span style="color: #8b2252;">MAX</span><span style="color: #008b8b;">\t\t</span><span style="color: #8b2252;">MIN"</span>,<span style="color: #8b2252;">"COMMENT:</span><span style="color: #008b8b;">\\</span><span style="color: #8b2252;">n"</span>]
            <span style="color: #a0522d;">rrd_GRAPH</span> = custum_list + rrd_GRAPH
            <span style="color: #b22222;"># </span><span style="color: #b22222;">print(rrd_GRAPH)</span>

            rrdtool.graph(custum_file,
                          <span style="color: #8b2252;">'-n'</span>, <span style="color: #8b2252;">'DEFAULT:10'</span>,
                          custum_str,
                          custum_size,
                          rrd_DEF,
                          rrd_HRULE,
                          rrd_GRAPH,
                          <span style="color: #8b2252;">"COMMENT:</span><span style="color: #008b8b;">\t\t\t\t\t\t\t\t\t\t</span><span style="color: #8b2252;"> Aliyun RDS Report"</span>)

            <span style="color: #b22222;">#               </span><span style="color: #b22222;">"COMMENT:\t\t\t\t\t\t\t\t\t\t\t\t update\:" + cur_time,</span>
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a0522d;">rrd_name</span> = rrd_dir + name + <span style="color: #8b2252;">'.rrd'</span>

        <span style="color: #a0522d;">rrd_DEF</span> = []
        <span style="color: #a020f0;">for</span> <span style="color: #483d8b;">id</span> <span style="color: #a020f0;">in</span> key_id:
            <span style="color: #a020f0;">for</span> DS <span style="color: #a020f0;">in</span> key_ds:
                <span style="color: #a0522d;">DS</span> = <span style="color: #8b2252;">''</span>.join(DS.replace(<span style="color: #8b2252;">'-'</span>, <span style="color: #8b2252;">'_'</span>).split(<span style="color: #8b2252;">'_'</span>)[-3:]) + <span style="color: #8b2252;">"_"</span> + <span style="color: #483d8b;">id</span>[0:3]
                rrd_DEF.append(<span style="color: #8b2252;">'DEF:v_{}={}:{}:AVERAGE'</span>.<span style="color: #483d8b;">format</span>(DS,rrd_name,DS))
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(rrd_DEF)  # exampale ['DEF:v_cpuusage=/xxx.rrd:cpuusage:LAST',]</span>

        <span style="color: #a0522d;">ds_length</span> = []
        <span style="color: #a020f0;">for</span> <span style="color: #483d8b;">id</span> <span style="color: #a020f0;">in</span> key_id:
            <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> key_ds:
                <span style="color: #a0522d;">i</span> = <span style="color: #8b2252;">''</span>.join(DS.replace(<span style="color: #8b2252;">'-'</span>, <span style="color: #8b2252;">'_'</span>).split(<span style="color: #8b2252;">'_'</span>)[-3:]) + <span style="color: #8b2252;">"_"</span> + <span style="color: #483d8b;">id</span>[0:3]
                ds_length.append(<span style="color: #483d8b;">len</span>(i))
        <span style="color: #a0522d;">max_length</span> = <span style="color: #483d8b;">max</span>(ds_length)

        <span style="color: #a0522d;">rrd_GRAPH</span> = []
        <span style="color: #a020f0;">for</span> <span style="color: #483d8b;">id</span> <span style="color: #a020f0;">in</span> key_id:
            <span style="color: #a020f0;">for</span> DS <span style="color: #a020f0;">in</span> key_ds:
                <span style="color: #a0522d;">DS</span> = <span style="color: #8b2252;">''</span>.join(DS.replace(<span style="color: #8b2252;">'-'</span>, <span style="color: #8b2252;">'_'</span>).split(<span style="color: #8b2252;">'_'</span>)[-3:]) + <span style="color: #8b2252;">"_"</span> + <span style="color: #483d8b;">id</span>[0:3]
                rrd_GRAPH.append(<span style="color: #8b2252;">"{}:v_{}{}:{}{}"</span>.<span style="color: #483d8b;">format</span>(graph.pop(), DS, color.pop(), DS, <span style="color: #8b2252;">' '</span>*(max_length - <span style="color: #483d8b;">len</span>(DS))))
                rrd_GRAPH.append(<span style="color: #8b2252;">"GPRINT:v_{}:LAST:LAST\: %6.2lf%s"</span>.<span style="color: #483d8b;">format</span>(DS))
                rrd_GRAPH.append(<span style="color: #8b2252;">"GPRINT:v_{}:AVERAGE:AVERAGE\: %6.2lf%s"</span>.<span style="color: #483d8b;">format</span>(DS))
                rrd_GRAPH.append(<span style="color: #8b2252;">"GPRINT:v_{}:MAX:MAX\: %6.2lf%s"</span>.<span style="color: #483d8b;">format</span>(DS))
                rrd_GRAPH.append(<span style="color: #8b2252;">"GPRINT:v_{}:MIN:MIN\: %6.2lf%s"</span>.<span style="color: #483d8b;">format</span>(DS))
                rrd_GRAPH.append(<span style="color: #8b2252;">"COMMENT:</span><span style="color: #008b8b;">\\</span><span style="color: #8b2252;">n"</span>)

        <span style="color: #a0522d;">custum_list</span> = [<span style="color: #8b2252;">"COMMENT:</span><span style="color: #008b8b;">\\</span><span style="color: #8b2252;">n"</span>, <span style="color: #8b2252;">"COMMENT:"</span> + <span style="color: #8b2252;">' '</span> * max_length + <span style="color: #8b2252;">"</span><span style="color: #008b8b;">\t</span><span style="color: #8b2252;">  LAST</span><span style="color: #008b8b;">\t\t</span><span style="color: #8b2252;"> AVERAGE</span><span style="color: #008b8b;">\t</span><span style="color: #8b2252;">MAX</span><span style="color: #008b8b;">\t\t</span><span style="color: #8b2252;">MIN"</span>, <span style="color: #8b2252;">"COMMENT:</span><span style="color: #008b8b;">\\</span><span style="color: #8b2252;">n"</span>]
        <span style="color: #a0522d;">rrd_GRAPH</span> = custum_list + rrd_GRAPH
        <span style="color: #b22222;">#</span><span style="color: #b22222;">print(rrd_GRAPH)</span>

        rrdtool.graph(custum_file,
                      <span style="color: #8b2252;">'-n'</span>, <span style="color: #8b2252;">'DEFAULT:10'</span>,
                      custum_str,
                      custum_size,
                      rrd_DEF,
                      rrd_HRULE,
                      rrd_GRAPH,
                      <span style="color: #8b2252;">"COMMENT:</span><span style="color: #008b8b;">\t\t\t\t\t\t\t\t\t\t</span><span style="color: #8b2252;"> Aliyun RDS Report"</span>)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">analyze_rds_slowlog</span>(rds_info,time_now, time_yes):
    <span style="color: #8b2252;">'''analyze slowlog and create slowlog dict'''</span>

    <span style="color: #a0522d;">slowlog_dict</span> = {<span style="color: #8b2252;">'SQLSlowLog'</span>: {<span style="color: #8b2252;">"key_id"</span>:[<span style="color: #8b2252;">'slow_log'</span>], <span style="color: #8b2252;">'Unit'</span>:<span style="color: #8b2252;">'count'</span>, <span style="color: #8b2252;">'Values'</span>: OrderedDict(), <span style="color: #8b2252;">'RDS_name'</span>: [], <span style="color: #8b2252;">'SlowLog_Top'</span>: {}, <span style="color: #8b2252;">'DOD'</span>:{}}}

    <span style="color: #a020f0;">for</span> rds,<span style="color: #483d8b;">id</span> <span style="color: #a020f0;">in</span> rds_info.items():
        <span style="color: #b22222;"># </span><span style="color: #b22222;">SQLSlowLog analyze</span>
        <span style="color: #a020f0;">if</span> rds <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">"RDS_name"</span>]:
            slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">"RDS_name"</span>].append(rds)

        <span style="color: #a0522d;">page_num</span> = 1
        <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
            <span style="color: #a0522d;">slowlog_info</span> = json.loads(get_rds_slowlog_info(<span style="color: #483d8b;">id</span>, time_now, page_num))
            <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(slowlog_info[<span style="color: #8b2252;">"Items"</span>][<span style="color: #8b2252;">"SQLSlowLog"</span>]) == 0 <span style="color: #a020f0;">and</span> slowlog_info[<span style="color: #8b2252;">'PageNumber'</span>] &gt; 1:
                <span style="color: #a020f0;">break</span>

            <span style="color: #a0522d;">slowlog_TotalRecordCount</span> = slowlog_info[<span style="color: #8b2252;">'TotalRecordCount'</span>]

            <span style="color: #a0522d;">slowlog_list</span> = slowlog_info[<span style="color: #8b2252;">"Items"</span>][<span style="color: #8b2252;">"SQLSlowLog"</span>]
            <span style="color: #a020f0;">for</span> values <span style="color: #a020f0;">in</span> slowlog_list:
                <span style="color: #a020f0;">if</span> rds <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">'SlowLog_Top'</span>].keys():
                    slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">'SlowLog_Top'</span>][rds] = []
                <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">'SlowLog_Top'</span>][rds]) &lt; 3:
                    slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">'SlowLog_Top'</span>][rds].append(<span style="color: #8b2252;">'{4}:{0}(DBNAME: {1}, MaxExecutionTime:{2}):</span><span style="color: #008b8b;">\n\'</span><span style="color: #8b2252;">{3}</span><span style="color: #008b8b;">\'</span><span style="color: #8b2252;">'</span>.<span style="color: #483d8b;">format</span>(rds, values[<span style="color: #8b2252;">'DBName'</span>], values[<span style="color: #8b2252;">'MaxExecutionTime'</span>], values[<span style="color: #8b2252;">'SQLText'</span>], values[<span style="color: #8b2252;">'CreateTime'</span>]))

            <span style="color: #a0522d;">value</span> = [<span style="color: #483d8b;">str</span>(slowlog_TotalRecordCount)]

            <span style="color: #b22222;"># </span><span style="color: #b22222;">DOD</span>
            <span style="color: #a0522d;">slowlog_2day_ago_info</span> = json.loads(get_rds_slowlog_info(<span style="color: #483d8b;">id</span>, time_yes, 1))
            <span style="color: #a0522d;">value_2day_ago</span> = slowlog_2day_ago_info[<span style="color: #8b2252;">'TotalRecordCount'</span>]
            <span style="color: #a0522d;">rrd_time_1day_ago</span> = <span style="color: #483d8b;">int</span>(datetime.datetime.strptime( (time_now - datetime.timedelta(days=1)).replace(hour=8,minute=0,second=0,microsecond=0).strftime(<span style="color: #8b2252;">'%Y-%m-%d %H'</span>), <span style="color: #8b2252;">'%Y-%m-%d %H'</span>).timestamp())
            <span style="color: #a0522d;">rrd_time_2day_ago</span> = <span style="color: #483d8b;">int</span>(datetime.datetime.strptime( (time_now - datetime.timedelta(days=2)).replace(hour=8,minute=0,second=0,microsecond=0).strftime(<span style="color: #8b2252;">'%Y-%m-%d %H'</span>), <span style="color: #8b2252;">'%Y-%m-%d %H'</span>).timestamp())

            <span style="color: #a020f0;">if</span> rds <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">'DOD'</span>].keys():
                slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">'DOD'</span>][rds] = {}

            <span style="color: #a020f0;">if</span> rrd_time_2day_ago <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">'DOD'</span>][rds].keys():
                slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">'DOD'</span>][rds][rrd_time_2day_ago] = {<span style="color: #8b2252;">'slowlog'</span>:{<span style="color: #8b2252;">'MAX'</span>:value_2day_ago ,<span style="color: #8b2252;">'MIN'</span>:value_2day_ago, <span style="color: #8b2252;">'SUM'</span>:value_2day_ago, <span style="color: #8b2252;">'COUNT'</span>:1, <span style="color: #8b2252;">'AVG'</span>:value_2day_ago}}

            <span style="color: #a020f0;">if</span> rrd_time_1day_ago <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">'DOD'</span>][rds].keys():
                slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">'DOD'</span>][rds][rrd_time_1day_ago] = {<span style="color: #8b2252;">'slowlog'</span>:{<span style="color: #8b2252;">'MAX'</span>:slowlog_TotalRecordCount ,<span style="color: #8b2252;">'MIN'</span>:slowlog_TotalRecordCount, <span style="color: #8b2252;">'SUM'</span>:slowlog_TotalRecordCount, <span style="color: #8b2252;">'COUNT'</span>:1, <span style="color: #8b2252;">'AVG'</span>:slowlog_TotalRecordCount}}

            <span style="color: #a020f0;">if</span> slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">"Values"</span>].get(rrd_time_2day_ago):
                slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">"Values"</span>][rrd_time_2day_ago].append(<span style="color: #483d8b;">str</span>(value_2day_ago))
            <span style="color: #a020f0;">else</span>:
                slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">"Values"</span>][rrd_time_2day_ago] = [<span style="color: #483d8b;">str</span>(value_2day_ago)]

            <span style="color: #a020f0;">if</span> slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">"Values"</span>].get(rrd_time_1day_ago):
                slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">"Values"</span>][rrd_time_1day_ago].append(value)
            <span style="color: #a020f0;">else</span>:
                slowlog_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">"Values"</span>][rrd_time_1day_ago] = [value]
            <span style="color: #a0522d;">page_num</span> += 1
    <span style="color: #a020f0;">return</span> slowlog_dict

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">analyz_rds_performance</span>(rds_info, time_now):

    <span style="color: #a0522d;">data_dict</span> = {}
    <span style="color: #a020f0;">for</span> rds,<span style="color: #483d8b;">id</span> <span style="color: #a020f0;">in</span> rds_info.items():
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(rds)</span>
        <span style="color: #a0522d;">rds_describe</span> = get_rds_more(<span style="color: #483d8b;">id</span>)
        <span style="color: #a0522d;">rds_MaxIOPS</span> = rds_describe[<span style="color: #8b2252;">'MaxIOPS'</span>]
        <span style="color: #a0522d;">rds_MaxConnections</span> = rds_describe[<span style="color: #8b2252;">'MaxConnections'</span>]
        <span style="color: #a0522d;">rds_DBInstanceStorage</span> = rds_describe[<span style="color: #8b2252;">'DBInstanceStorage'</span>]*1024

        <span style="color: #b22222;"># </span><span style="color: #b22222;">Performance analyze</span>
        <span style="color: #a0522d;">info</span> = json.loads(get_rds_performance_info(<span style="color: #483d8b;">id</span>,keys, time_now))
        <span style="color: #b22222;">#</span><span style="color: #b22222;">print(info)</span>

        <span style="color: #a0522d;">performance_info</span> = info[<span style="color: #8b2252;">'PerformanceKeys'</span>][<span style="color: #8b2252;">'PerformanceKey'</span>]
        <span style="color: #a020f0;">for</span> key_info <span style="color: #a020f0;">in</span> performance_info:
            <span style="color: #a0522d;">key_name</span> = key_info[<span style="color: #8b2252;">'Key'</span>]
            <span style="color: #a0522d;">key_id</span> = key_info[<span style="color: #8b2252;">'ValueFormat'</span>].split(<span style="color: #8b2252;">'&amp;'</span>)
            <span style="color: #a0522d;">key_unit</span> = key_info[<span style="color: #8b2252;">'Unit'</span>]

            <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'ins_size'</span> <span style="color: #a020f0;">in</span> key_id:
                <span style="color: #a0522d;">key_unit</span> = <span style="color: #8b2252;">'%'</span>
            <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'io'</span> <span style="color: #a020f0;">in</span> key_id:
                <span style="color: #a0522d;">key_unit</span> = <span style="color: #8b2252;">'%'</span>

            <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> data_dict.get(key_name):
                <span style="color: #a0522d;">data_dict</span>[key_name] = {<span style="color: #8b2252;">"key_id"</span>:key_id,<span style="color: #8b2252;">"Unit"</span>:key_unit,<span style="color: #8b2252;">"Values"</span>:OrderedDict(),<span style="color: #8b2252;">"RDS_name"</span>:[], <span style="color: #8b2252;">'DOD'</span>:{}}

            <span style="color: #a020f0;">if</span> rds <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> data_dict[key_name][<span style="color: #8b2252;">"RDS_name"</span>]:
                data_dict[key_name][<span style="color: #8b2252;">"RDS_name"</span>].append(rds)
                <span style="color: #b22222;"># </span><span style="color: #b22222;">print(data_dict[key_name]["RDS_name"])</span>

            <span style="color: #a0522d;">values_info</span> = key_info[<span style="color: #8b2252;">'Values'</span>][<span style="color: #8b2252;">'PerformanceValue'</span>]
            <span style="color: #a020f0;">for</span> value_info <span style="color: #a020f0;">in</span> values_info:
                <span style="color: #b22222;">#</span><span style="color: #b22222;">print(value_info['Value'].split('&amp;'),int(datetime.datetime.strptime(utc_to_local(value_info['Date']),'%Y-%m-%d %H:%M:%S').timestamp()))</span>
                <span style="color: #a0522d;">value</span> = value_info[<span style="color: #8b2252;">'Value'</span>].split(<span style="color: #8b2252;">'&amp;'</span>)
                <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'ins_size'</span> <span style="color: #a020f0;">in</span> key_id:
                    <span style="color: #a0522d;">value</span> = [<span style="color: #483d8b;">str</span>(<span style="color: #483d8b;">float</span>(<span style="color: #8b2252;">'%.2f'</span>%y)) <span style="color: #a020f0;">for</span> y <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x:(<span style="color: #483d8b;">float</span>(x)/rds_DBInstanceStorage)*100, value_info[<span style="color: #8b2252;">'Value'</span>].split(<span style="color: #8b2252;">'&amp;'</span>))]
                <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'io'</span> <span style="color: #a020f0;">in</span> key_id:
                    <span style="color: #a0522d;">value</span> = [<span style="color: #483d8b;">str</span>(<span style="color: #483d8b;">float</span>(<span style="color: #8b2252;">'%.2f'</span>%y)) <span style="color: #a020f0;">for</span> y <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">map</span>(<span style="color: #a020f0;">lambda</span> x:(<span style="color: #483d8b;">float</span>(x)/rds_MaxIOPS)*100, value_info[<span style="color: #8b2252;">'Value'</span>].split(<span style="color: #8b2252;">'&amp;'</span>))]

                <span style="color: #a0522d;">this_time</span> = datetime.datetime.strptime(utc_to_local(value_info[<span style="color: #8b2252;">'Date'</span>]),<span style="color: #8b2252;">'%Y-%m-%d %H:%M:%S'</span>)
                <span style="color: #a0522d;">rrd_time</span> = <span style="color: #483d8b;">int</span>(this_time.timestamp())

                <span style="color: #a020f0;">if</span> data_dict[key_name][<span style="color: #8b2252;">"Values"</span>].get(rrd_time):
                        data_dict[key_name][<span style="color: #8b2252;">"Values"</span>][rrd_time].append(value)
                <span style="color: #a020f0;">else</span>:
                    data_dict[key_name][<span style="color: #8b2252;">"Values"</span>][rrd_time]=[value]

                <span style="color: #b22222;"># </span><span style="color: #b22222;">DOD</span>
                <span style="color: #a0522d;">DOD_time</span> = <span style="color: #483d8b;">int</span>(this_time.replace(hour=8,minute=0, second=0, microsecond=0).timestamp())
                <span style="color: #b22222;"># </span><span style="color: #b22222;">print(DOD_time)</span>
                <span style="color: #a020f0;">if</span> rds <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> data_dict[key_name][<span style="color: #8b2252;">"DOD"</span>].keys():
                    data_dict[key_name][<span style="color: #8b2252;">"DOD"</span>][rds]  = {}

                <span style="color: #a020f0;">if</span> DOD_time <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> data_dict[key_name][<span style="color: #8b2252;">"DOD"</span>][rds].keys():
                    data_dict[key_name][<span style="color: #8b2252;">"DOD"</span>][rds][DOD_time] = {}
                <span style="color: #a020f0;">for</span> i, v <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">enumerate</span>(key_id):
                    <span style="color: #a020f0;">if</span> v <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> data_dict[key_name][<span style="color: #8b2252;">"DOD"</span>][rds][DOD_time].keys():
                        data_dict[key_name][<span style="color: #8b2252;">"DOD"</span>][rds][DOD_time][v] = {<span style="color: #8b2252;">'MAX'</span>:value[i] ,<span style="color: #8b2252;">'MIN'</span>:value[i], <span style="color: #8b2252;">'SUM'</span>:value[i], <span style="color: #8b2252;">'COUNT'</span>:1, <span style="color: #8b2252;">'AVG'</span>: value[i]}
                    <span style="color: #a020f0;">else</span>:
                        <span style="color: #a0522d;">MAX</span> = <span style="color: #483d8b;">float</span>(data_dict[key_name][<span style="color: #8b2252;">"DOD"</span>][rds][DOD_time][v][<span style="color: #8b2252;">'MAX'</span>])
                        <span style="color: #a0522d;">MIN</span> = <span style="color: #483d8b;">float</span>(data_dict[key_name][<span style="color: #8b2252;">"DOD"</span>][rds][DOD_time][v][<span style="color: #8b2252;">'MIN'</span>])
                        <span style="color: #a0522d;">SUM</span> = <span style="color: #483d8b;">float</span>(data_dict[key_name][<span style="color: #8b2252;">"DOD"</span>][rds][DOD_time][v][<span style="color: #8b2252;">'SUM'</span>]) + <span style="color: #483d8b;">float</span>(value[i])
                        <span style="color: #a0522d;">COUNT</span> = data_dict[key_name][<span style="color: #8b2252;">"DOD"</span>][rds][DOD_time][v][<span style="color: #8b2252;">'COUNT'</span>] + 1
                        <span style="color: #a0522d;">AVG</span> = <span style="color: #483d8b;">float</span>(<span style="color: #8b2252;">'%.2f'</span>%(SUM/COUNT))
                        <span style="color: #a020f0;">if</span> MAX &lt; <span style="color: #483d8b;">float</span>(value[i]):
                            <span style="color: #a0522d;">MAX</span> = <span style="color: #483d8b;">float</span>(value[i])
                        <span style="color: #a020f0;">if</span> MIN &gt; <span style="color: #483d8b;">float</span>(value[i]):
                            <span style="color: #a0522d;">MIN</span> = <span style="color: #483d8b;">float</span>(value[i])
                        data_dict[key_name][<span style="color: #8b2252;">"DOD"</span>][rds][DOD_time][v] = {<span style="color: #8b2252;">'MAX'</span>: MAX, <span style="color: #8b2252;">'MIN'</span>: MIN,
                                                                        <span style="color: #8b2252;">'SUM'</span>: SUM, <span style="color: #8b2252;">'COUNT'</span>: COUNT, <span style="color: #8b2252;">'AVG'</span>:AVG}
    <span style="color: #a020f0;">return</span> data_dict

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">creat_pesponse</span>(dict_list):
    <span style="color: #a0522d;">response_dict</span> = {}

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">if_dict</span>(per_key, before, after):
        <span style="color: #a020f0;">if</span> before:
            <span style="color: #a0522d;">RATE</span> = <span style="color: #8b2252;">'%0.2f'</span> % (((after / before) - 1) * 100)
            <span style="color: #a0522d;">res_dict</span> = {per_key + <span style="color: #8b2252;">'_'</span> + k: {<span style="color: #8b2252;">"MAX"</span>: MAX, <span style="color: #8b2252;">"MIN"</span>: MIN, <span style="color: #8b2252;">"AVG"</span>: AVG, <span style="color: #8b2252;">"RATE"</span>: RATE + <span style="color: #8b2252;">'%'</span>}}
        <span style="color: #a020f0;">else</span>:
            <span style="color: #a0522d;">res_dict</span> = {per_key + <span style="color: #8b2252;">'_'</span> + k: {<span style="color: #8b2252;">"MAX"</span>: MAX, <span style="color: #8b2252;">"MIN"</span>: MIN, <span style="color: #8b2252;">"AVG"</span>: AVG, <span style="color: #8b2252;">"RATE"</span>: <span style="color: #8b2252;">'0%'</span>}}
        <span style="color: #a020f0;">return</span> res_dict

    <span style="color: #a020f0;">for</span> data_dict <span style="color: #a020f0;">in</span> dict_list:
        <span style="color: #a020f0;">for</span> per_key, perdata <span style="color: #a020f0;">in</span> data_dict.items():
            <span style="color: #a020f0;">for</span> <span style="color: #483d8b;">id</span>, data <span style="color: #a020f0;">in</span> perdata[<span style="color: #8b2252;">"DOD"</span>].items():
                <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">id</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> response_dict.keys():
                    <span style="color: #a0522d;">response_dict</span>[<span style="color: #483d8b;">id</span>] = []
                <span style="color: #b22222;"># </span><span style="color: #b22222;">print(data.keys())</span>

                <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">"SQLSlowLog"</span> <span style="color: #a020f0;">in</span> per_key:
                    <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">id</span> <span style="color: #a020f0;">in</span> data_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">'SlowLog_Top'</span>].keys():
                        response_dict[<span style="color: #483d8b;">id</span>].append({<span style="color: #8b2252;">"SQL"</span>:data_dict[<span style="color: #8b2252;">'SQLSlowLog'</span>][<span style="color: #8b2252;">'SlowLog_Top'</span>][<span style="color: #483d8b;">id</span>]})
                    <span style="color: #a020f0;">else</span>:
                        response_dict[<span style="color: #483d8b;">id</span>].append({<span style="color: #8b2252;">"SQL"</span>: [<span style="color: #8b2252;">"NONE"</span>]})
                    <span style="color: #a0522d;">per_time</span> = <span style="color: #483d8b;">sorted</span>(data.keys())[-2:]
                    <span style="color: #a0522d;">per_before_time</span> = per_time[-2]
                    <span style="color: #a0522d;">per_after_time</span> = per_time[-1]
                <span style="color: #a020f0;">else</span>:
                    <span style="color: #a0522d;">per_time</span> = <span style="color: #483d8b;">sorted</span>(data.keys())[-3:]
                    <span style="color: #a0522d;">per_before_time</span> = per_time[-3]
                    <span style="color: #a0522d;">per_after_time</span> = per_time[-2]

                <span style="color: #a0522d;">per_before_time_str</span> = datetime.datetime.utcfromtimestamp(per_before_time).strftime(<span style="color: #8b2252;">"%m&#26376;%d&#26085;"</span>)
                <span style="color: #a0522d;">per_after_time_str</span> = datetime.datetime.utcfromtimestamp(per_after_time).strftime(<span style="color: #8b2252;">"%m&#26376;%d&#26085;"</span>)
                <span style="color: #a020f0;">for</span> k, v <span style="color: #a020f0;">in</span> data[per_after_time].items():
                    <span style="color: #a0522d;">per_after_MAX</span> = data[per_after_time][k][<span style="color: #8b2252;">"MAX"</span>]
                    <span style="color: #a0522d;">per_after_MIN</span> = data[per_after_time][k][<span style="color: #8b2252;">"MIN"</span>]
                    <span style="color: #a0522d;">per_after_AVG</span> = data[per_after_time][k][<span style="color: #8b2252;">"AVG"</span>]
                    <span style="color: #a0522d;">per_before_MAX</span> = data[per_before_time][k][<span style="color: #8b2252;">"MAX"</span>]
                    <span style="color: #a0522d;">per_before_MIN</span> = data[per_before_time][k][<span style="color: #8b2252;">"MIN"</span>]
                    <span style="color: #a0522d;">per_before_AVG</span> = data[per_before_time][k][<span style="color: #8b2252;">"AVG"</span>]
                    <span style="color: #a0522d;">MAX</span> = [[per_before_time_str, per_before_MAX], [per_after_time_str, per_after_MAX]]
                    <span style="color: #a0522d;">MIN</span> = [[per_before_time_str, per_before_MIN], [per_after_time_str, per_after_MIN]]
                    <span style="color: #a0522d;">AVG</span> = [[per_before_time_str, per_before_AVG], [per_after_time_str, per_after_AVG]]

                    <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">"SQLSlowLog"</span> <span style="color: #a020f0;">in</span> k:
                        <span style="color: #a0522d;">res_dict</span> = if_dict(per_key, per_before_MAX, per_after_MAX)
                        response_dict[<span style="color: #483d8b;">id</span>].append(res_dict)
                    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'ins_size'</span> <span style="color: #a020f0;">in</span> k:
                        <span style="color: #a0522d;">res_dict</span> = if_dict(per_key, per_before_MAX, per_after_MAX)
                        response_dict[<span style="color: #483d8b;">id</span>].append(res_dict)
                    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'io'</span> <span style="color: #a020f0;">in</span> k:
                        <span style="color: #a0522d;">res_dict</span> = if_dict(per_key, per_before_AVG, per_after_AVG)
                        response_dict[<span style="color: #483d8b;">id</span>].append(res_dict)
                    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'cpuusage'</span> <span style="color: #a020f0;">in</span> k <span style="color: #a020f0;">or</span> <span style="color: #8b2252;">'memusage'</span> <span style="color: #a020f0;">in</span> k:
                        <span style="color: #a0522d;">res_dict</span> = if_dict(per_key, per_before_AVG, per_after_AVG)
                        response_dict[<span style="color: #483d8b;">id</span>].append(res_dict)

                    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'active_session'</span> <span style="color: #a020f0;">in</span> k:
                        <span style="color: #a0522d;">res_dict</span> = if_dict(per_key, per_before_MAX, per_after_MAX)
                        response_dict[<span style="color: #483d8b;">id</span>].append(res_dict)
                    <span style="color: #a020f0;">else</span>:
                        <span style="color: #a0522d;">res_dict</span> = if_dict(per_key, per_before_MAX, per_after_MAX)
                        response_dict[<span style="color: #483d8b;">id</span>].append(res_dict)

    <span style="color: #a020f0;">return</span> response_dict

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">create_graph</span>(dict_list, select):
    <span style="color: #a020f0;">for</span> graph_dict <span style="color: #a020f0;">in</span> dict_list:
        <span style="color: #a020f0;">for</span> key, data <span style="color: #a020f0;">in</span> graph_dict.items():
            <span style="color: #a0522d;">key_name</span> = key
            <span style="color: #a0522d;">key_ds</span> = data[<span style="color: #8b2252;">"RDS_name"</span>]
            <span style="color: #a0522d;">key_unit</span> = data[<span style="color: #8b2252;">"Unit"</span>]
            <span style="color: #a0522d;">key_id</span> = data[<span style="color: #8b2252;">"key_id"</span>]
            <span style="color: #b22222;"># </span><span style="color: #b22222;">print(key_id)</span>

            <span style="color: #a0522d;">merge_flag</span> = <span style="color: #008b8b;">False</span>
            <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'SQLSlowLog'</span> <span style="color: #a020f0;">in</span> key:
                <span style="color: #a0522d;">key_name</span> = <span style="color: #8b2252;">'MySQL_'</span> + key
                <span style="color: #a0522d;">merge_flag</span> = <span style="color: #008b8b;">True</span>

            <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">"Sessions"</span> <span style="color: #a020f0;">in</span> key_name:
                <span style="color: #a0522d;">merge_flag</span> = <span style="color: #008b8b;">False</span>
                <span style="color: #a0522d;">key_id</span> = [key_id[0]]
            <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">"MySQL_DetailedSpaceUsage"</span> <span style="color: #a020f0;">in</span> key_name:
                <span style="color: #a0522d;">merge_flag</span> = <span style="color: #008b8b;">True</span>
                <span style="color: #a0522d;">key_id</span> = [key_id[0]]
                <span style="color: #b22222;"># </span><span style="color: #b22222;">print(key_id)</span>

            <span style="color: #b22222;"># </span><span style="color: #b22222;">create rrd</span>
            create_rrd(key_name, key_ds, key_id, merge_flag)

            <span style="color: #a020f0;">for</span> rrd_time, value <span style="color: #a020f0;">in</span> data[<span style="color: #8b2252;">"Values"</span>].items():
                <span style="color: #b22222;"># </span><span style="color: #b22222;">update rrd data</span>
                update_rrd(key_name, value, rrd_time, key_id, <span style="color: #483d8b;">len</span>(key_ds), merge_flag)

            <span style="color: #b22222;"># </span><span style="color: #b22222;">graph rrd</span>
            graph_rrd(key_name, key_ds, key_unit, key_id, merge_flag, select)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">analyze_data</span>(rds_info=<span style="color: #008b8b;">None</span>,keys=<span style="color: #008b8b;">None</span>, select=<span style="color: #8b2252;">'week'</span>):
    <span style="color: #8b2252;">'''analyze data'''</span>

    <span style="color: #a020f0;">if</span> rds_info == <span style="color: #008b8b;">None</span> <span style="color: #a020f0;">or</span> keys == <span style="color: #008b8b;">None</span>:
        sys.<span style="color: #008b8b;">exit</span>(1)
    <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> <span style="color: #483d8b;">isinstance</span>(rds_info, <span style="color: #483d8b;">dict</span>):
        sys.<span style="color: #008b8b;">exit</span>(1)

    <span style="color: #a0522d;">time_now</span> = datetime.datetime.now()
    <span style="color: #a0522d;">time_yes</span> = time_now - datetime.timedelta(days=1)

    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"create data"</span>)
    <span style="color: #a0522d;">data_dict</span> = analyz_rds_performance(rds_info,time_now)
    <span style="color: #a0522d;">slowlog_dict</span> = analyze_rds_slowlog(rds_info, time_now, time_yes)
    <span style="color: #a0522d;">dict_list</span> = [data_dict, slowlog_dict]

    <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">    print(data_dict)</span>
<span style="color: #8b2252;">    {</span>
<span style="color: #8b2252;">        "MySQL_MemCpuUsage": {</span>
<span style="color: #8b2252;">            "key_id": [</span>
<span style="color: #8b2252;">                "cpuusage",</span>
<span style="color: #8b2252;">                "memusage"</span>
<span style="color: #8b2252;">            ],</span>
<span style="color: #8b2252;">            "Unit": "%",</span>
<span style="color: #8b2252;">            "Values": {</span>
<span style="color: #8b2252;">                "1558931820": [</span>
<span style="color: #8b2252;">                    ["1.12", "65.2"],</span>
<span style="color: #8b2252;">                    ["3.49", "30.0"],</span>
<span style="color: #8b2252;">                    ["1.36", "65.5"],</span>
<span style="color: #8b2252;">                    ["1.84", "20.2"]</span>
<span style="color: #8b2252;">                ],</span>
<span style="color: #8b2252;">            },</span>
<span style="color: #8b2252;">            "RDS_name": [</span>
<span style="color: #8b2252;">                "hb2-zys-trade-read",</span>
<span style="color: #8b2252;">                "hb2-zys-base-read",</span>
<span style="color: #8b2252;">                "hb2-zys-trade-master",</span>
<span style="color: #8b2252;">                "hb2-zys-base-master"</span>
<span style="color: #8b2252;">            ]</span>
<span style="color: #8b2252;">        },</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">    """</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(slowlog_dict['SQLSlowLog']['DOD'])</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(data_dict['MySQL_IOPS']["DOD"]['hb2-zys-trade-read'])</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(data_dict['MySQL_IOPS'])</span>

    <span style="color: #a0522d;">response_dict</span> = creat_pesponse(dict_list)
    create_graph(dict_list, select)

    <span style="color: #a020f0;">return</span> response_dict

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">create_html_table</span>(k, v_rate, v_max1, v_max2, v_min1, v_min2, v_avg1, v_avg2, v_coment=<span style="color: #8b2252;">'MAX&#22686;&#38271;&#29575;&#22823;&#20110;10%'</span>, v_more=<span style="color: #8b2252;">''</span>, flag=<span style="color: #8b2252;">'max'</span>):
    <span style="color: #8b2252;">'''crate html table'''</span>

    <span style="color: #a020f0;">if</span> flag == <span style="color: #8b2252;">'max'</span>:
        <span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">'''</span>
<span style="color: #8b2252;">        &lt;tr onmouseover="this.style.backgroundColor='#d4e3e5';" onmouseout="this.style.backgroundColor='#FFFFFF';"&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td bgcolor="red"&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">        &lt;/tr&gt;</span>
<span style="color: #8b2252;">        '''</span>.<span style="color: #483d8b;">format</span>(k, v_rate, v_max1, v_max2, v_min1, v_min2, v_avg1, v_avg2, v_coment,  v_more)
    <span style="color: #a020f0;">elif</span> flag == <span style="color: #8b2252;">'rate'</span>:
        <span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">'''</span>
<span style="color: #8b2252;">        &lt;tr onmouseover="this.style.backgroundColor='#d4e3e5';" onmouseout="this.style.backgroundColor='#FFFFFF';"&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td bgcolor="red"&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">        &lt;/tr&gt;</span>
<span style="color: #8b2252;">        '''</span>.<span style="color: #483d8b;">format</span>(k, v_rate, v_max1, v_max2, v_min1, v_min2, v_avg1, v_avg2, v_coment,  v_more)
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">'''</span>
<span style="color: #8b2252;">        &lt;tr onmouseover="this.style.backgroundColor='#d4e3e5';" onmouseout="this.style.backgroundColor='#FFFFFF';"&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">            &lt;td&gt;{}&lt;/td&gt;</span>
<span style="color: #8b2252;">        &lt;/tr&gt;</span>
<span style="color: #8b2252;">        '''</span>.<span style="color: #483d8b;">format</span>(k, v_rate, v_max1, v_max2, v_min1, v_min2, v_avg1, v_avg2, v_coment,  v_more)
    <span style="color: #a020f0;">return</span> msg

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">create_email_content</span>(response):
    <span style="color: #a0522d;">html_stye</span> = <span style="color: #8b2252;">'''</span>
<span style="color: #8b2252;">    &lt;style type="text/css"&gt;</span>
<span style="color: #8b2252;">    /* Table Head */</span>
<span style="color: #8b2252;">    #table-6 thead th {</span>
<span style="color: #8b2252;">    background-color: rgb(128, 102, 160);</span>
<span style="color: #8b2252;">    color: #fff;</span>
<span style="color: #8b2252;">    border-bottom-width: 0;</span>
<span style="color: #8b2252;">    }</span>

<span style="color: #8b2252;">    /* Column Style */</span>
<span style="color: #8b2252;">    #table-6 td {</span>
<span style="color: #8b2252;">    color: #000;</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">    /* Heading and Column Style */</span>
<span style="color: #8b2252;">    #table-6 tr, #table-6 th {</span>
<span style="color: #8b2252;">    border-width: 1px;</span>
<span style="color: #8b2252;">    border-style: solid;</span>
<span style="color: #8b2252;">    border-color: #fff;</span>
<span style="color: #8b2252;">    }</span>

<span style="color: #8b2252;">    /* Padding and font style */</span>
<span style="color: #8b2252;">    #table-6 td, #table-6 th {</span>
<span style="color: #8b2252;">    padding: 5px 10px;</span>
<span style="color: #8b2252;">    font-size: 12px;</span>
<span style="color: #8b2252;">    font-family: Verdana;</span>
<span style="color: #8b2252;">    font-weight: bold;</span>
<span style="color: #8b2252;">    }</span>
<span style="color: #8b2252;">    &lt;/style&gt;</span>
<span style="color: #8b2252;">        '''</span>
    <span style="color: #a0522d;">content</span> = <span style="color: #8b2252;">'''</span>
<span style="color: #8b2252;">        &lt;h1&gt;&#19968;&#12289;xxx&#25968;&#25454;&#24211;&#20998;&#26512;:&lt;/h1&gt;</span>
<span style="color: #8b2252;">        &lt;p&gt;&lt;/p&gt;</span>
<span style="color: #8b2252;">        '''</span>

    <span style="color: #a0522d;">comment_content</span> = <span style="color: #8b2252;">""</span>
    <span style="color: #a0522d;">seo_content</span> = <span style="color: #8b2252;">""</span>
    <span style="color: #a0522d;">other_content</span> = <span style="color: #8b2252;">""</span>
    <span style="color: #a0522d;">html_slowlog</span> = <span style="color: #8b2252;">""</span>
    <span style="color: #a020f0;">for</span> rds, values <span style="color: #a020f0;">in</span> response.items():
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(rds,values)</span>
        <span style="color: #a0522d;">other_content</span> += <span style="color: #8b2252;">'&lt;h2&gt;&#24211;&#21517;&#65306;{}&lt;/h2&gt;'</span>.<span style="color: #483d8b;">format</span>(rds)
        <span style="color: #a0522d;">msg_new</span> = <span style="color: #8b2252;">''</span>
        <span style="color: #a0522d;">msg</span> = <span style="color: #8b2252;">''</span>
        <span style="color: #a020f0;">for</span> value <span style="color: #a020f0;">in</span> values:

            <span style="color: #a020f0;">for</span> k, v <span style="color: #a020f0;">in</span> value.items():

                <span style="color: #a020f0;">if</span> k <span style="color: #a020f0;">in</span> [<span style="color: #8b2252;">"SQL"</span>, <span style="color: #8b2252;">"MySQL_DetailedSpaceUsage_data_size"</span>, <span style="color: #8b2252;">"MySQL_DetailedSpaceUsage_log_size"</span>,
                         <span style="color: #8b2252;">"MySQL_DetailedSpaceUsage_tmp_size"</span>, <span style="color: #8b2252;">"MySQL_DetailedSpaceUsage_other_size"</span>,
                         <span style="color: #8b2252;">'MySQL_Sessions_total_session'</span>]:
                    <span style="color: #a020f0;">pass</span>
                    <span style="color: #b22222;"># </span><span style="color: #b22222;">if k == "SQL":</span>
                    <span style="color: #b22222;">#     </span><span style="color: #b22222;">html_slowlog += '&lt;h4&gt;&#24930;&#26085;&#24535;:&lt;/h4&gt;'</span>
                    <span style="color: #b22222;">#     </span><span style="color: #b22222;">for i in v:</span>
                    <span style="color: #b22222;">#         </span><span style="color: #b22222;">html_slowlog +='&lt;p&gt;{}&lt;/p&gt;'.format(i)</span>
                <span style="color: #a020f0;">else</span>:
                    <span style="color: #a0522d;">before_time</span> = v[<span style="color: #8b2252;">'MAX'</span>][0][0]
                    <span style="color: #a0522d;">after_time</span> = v[<span style="color: #8b2252;">'MAX'</span>][1][0]
                    <span style="color: #a0522d;">v_rate</span> = v[<span style="color: #8b2252;">'RATE'</span>]
                    <span style="color: #a0522d;">v_max1</span>, <span style="color: #a0522d;">v_max2</span> = v[<span style="color: #8b2252;">'MAX'</span>][0][1], v[<span style="color: #8b2252;">'MAX'</span>][1][1]
                    <span style="color: #a0522d;">v_min1</span>, <span style="color: #a0522d;">v_min2</span> = v[<span style="color: #8b2252;">'MIN'</span>][0][1], v[<span style="color: #8b2252;">'MIN'</span>][1][1]
                    <span style="color: #a0522d;">v_avg1</span>, <span style="color: #a0522d;">v_avg2</span> = v[<span style="color: #8b2252;">'AVG'</span>][0][1], v[<span style="color: #8b2252;">'AVG'</span>][1][1]

                    <span style="color: #a0522d;">msg_new</span> = <span style="color: #8b2252;">'&lt;thead&gt;&lt;th&gt;&#25351;&#26631;&lt;/th&gt;&lt;th&gt;&#22686;&#38271;&#29575;&lt;/th&gt;&lt;th&gt;{}MAX&lt;/th&gt;&lt;th&gt;{}MAX&lt;/th&gt;&lt;th&gt;{}MIN&lt;/th&gt;&lt;th&gt;{}MIN&lt;/th&gt;&lt;th&gt;{}AVG&lt;/th&gt;&lt;th&gt;{}AVG&lt;/th&gt;&lt;th&gt;&#22522;&#20934;&#20540;&lt;/th&gt;&lt;th&gt;&#35814;&#24773;&lt;/th&gt;&lt;/thead&gt;&lt;tbody&gt;'</span>.<span style="color: #483d8b;">format</span>(
                        before_time, after_time, before_time, after_time, before_time, after_time)

                    <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">"SQLSlowLog"</span> <span style="color: #a020f0;">in</span> k:
                        <span style="color: #a0522d;">k</span> = <span style="color: #8b2252;">'&#24930;&#26085;&#24535;&#25968;'</span>
                    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'ins_size'</span> <span style="color: #a020f0;">in</span> k:
                        <span style="color: #a0522d;">k</span> = <span style="color: #8b2252;">'&#24635;&#31354;&#38388;&#20351;&#29992;&#29575;(%)'</span>
                    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'IOPS_io'</span> <span style="color: #a020f0;">in</span> k:
                        <span style="color: #a0522d;">k</span> = <span style="color: #8b2252;">'IOPS&#20351;&#29992;&#29575;(%)'</span>
                    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'cpuusage'</span> <span style="color: #a020f0;">in</span> k:
                        <span style="color: #a0522d;">k</span> = <span style="color: #8b2252;">'CPU&#20351;&#29992;&#29575;(%)'</span>
                    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'memusage'</span> <span style="color: #a020f0;">in</span> k:
                        <span style="color: #a0522d;">k</span> = <span style="color: #8b2252;">'&#20869;&#23384;&#20351;&#29992;&#29575;(%)'</span>
                    <span style="color: #a020f0;">elif</span> <span style="color: #8b2252;">'active_session'</span> <span style="color: #a020f0;">in</span> k:
                        <span style="color: #a0522d;">k</span> = <span style="color: #8b2252;">'&#27963;&#36291;&#36830;&#25509;&#25968;'</span>

                    <span style="color: #a0522d;">v_more</span> = <span style="color: #8b2252;">''</span>
                    <span style="color: #a0522d;">flag</span> = <span style="color: #8b2252;">''</span>
                    <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">float</span>(v[<span style="color: #8b2252;">'RATE'</span>].strip(<span style="color: #8b2252;">'%'</span>)) &gt;= 10:
                        <span style="color: #a020f0;">if</span> k == <span style="color: #8b2252;">'&#27963;&#36291;&#36830;&#25509;&#25968;'</span>:
                            <span style="color: #a0522d;">v_coment</span> = <span style="color: #8b2252;">'MAX&#22823;&#20110;30'</span>
                            <span style="color: #a020f0;">if</span> v_max2 &gt;= 30:
                                <span style="color: #b22222;"># </span><span style="color: #b22222;">v_more = '&lt;a href="http://www.baidu.com"&gt;MORE..&lt;/a&gt;'</span>
                                <span style="color: #a0522d;">flag</span> = <span style="color: #8b2252;">'max'</span>
                                <span style="color: #a0522d;">comment_content</span> += <span style="color: #8b2252;">'&lt;p&gt;{}&#25351;&#26631;{}&#36739;&#39640;&#65292;{}&#26368;&#22823;&#20540;&#20026;{}&#65292;&#35831;&#20851;&#27880;&#12290;&lt;/p&gt;'</span>.<span style="color: #483d8b;">format</span>(rds, k.strip(<span style="color: #8b2252;">'%()'</span>),
                                                                                                       after_time, v_max2)
                                <span style="color: #a0522d;">v_rate</span> = v_rate + <span style="color: #8b2252;">' &lt;font color="red"&gt;&amp;#8593&lt;/font&gt;'</span>
                            <span style="color: #a0522d;">msg</span> += create_html_table(k, v_rate, v_max1, v_max2, v_min1, v_min2, v_avg1, v_avg2, v_coment,
                                                    v_more, flag)
                        <span style="color: #a020f0;">elif</span> k == <span style="color: #8b2252;">'&#24635;&#31354;&#38388;&#20351;&#29992;&#29575;(%)'</span>:
                            <span style="color: #a0522d;">v_coment</span> = <span style="color: #8b2252;">'MAX&#22823;&#20110;70%'</span>
                            <span style="color: #a020f0;">if</span> v_max2 &gt; 70:
                                <span style="color: #b22222;"># </span><span style="color: #b22222;">v_more = '&lt;a href="http://www.baidu.com"&gt;MORE..&lt;/a&gt;'</span>
                                <span style="color: #a0522d;">flag</span> = <span style="color: #8b2252;">'max'</span>
                                <span style="color: #a0522d;">comment_content</span> += <span style="color: #8b2252;">'&lt;p&gt;{}&#25351;&#26631;{}&#36739;&#39640;, {}&#26368;&#22823;&#20540;&#20026;{}&#65292;&#35831;&#20851;&#27880;&#12290;&lt;/p&gt;'</span>.<span style="color: #483d8b;">format</span>(rds, k.strip(<span style="color: #8b2252;">'%()'</span>),
                                                                                                  after_time, v_max2)
                                <span style="color: #a0522d;">v_rate</span> = v_rate + <span style="color: #8b2252;">' &lt;font color="red"&gt;&amp;#8593&lt;/font&gt;'</span>
                            <span style="color: #a0522d;">msg</span> += create_html_table(k, v_rate, v_max1, v_max2, v_min1, v_min2, v_avg1, v_avg2, v_coment,
                                                    v_more, flag)
                        <span style="color: #a020f0;">elif</span> k == <span style="color: #8b2252;">'IOPS&#20351;&#29992;&#29575;(%)'</span>:
                            <span style="color: #a0522d;">v_coment</span> = <span style="color: #8b2252;">'AVG&#22686;&#38271;&#29575;&#22823;&#20110;10%'</span>
                            <span style="color: #a020f0;">if</span> v_avg2 == 100:
                                <span style="color: #b22222;"># </span><span style="color: #b22222;">v_more = '&lt;a href="http://www.baidu.com"&gt;MORE..&lt;/a&gt;'</span>
                                <span style="color: #a0522d;">flag</span> = <span style="color: #8b2252;">'rate'</span>
                                <span style="color: #a0522d;">comment_content</span> += <span style="color: #8b2252;">'&lt;p&gt;{}&#25351;&#26631;{}&#36739;&#39640;&#65292;&#36817;2&#22825;AVG&#22686;&#38271;&#29575;&#20026;{}&#65292;&#35831;&#20851;&#27880;&#12290;&lt;/p&gt;'</span>.<span style="color: #483d8b;">format</span>(rds, k.strip(<span style="color: #8b2252;">'%()'</span>), v_rate)
                            <span style="color: #a0522d;">msg</span> += create_html_table(k, v_rate + <span style="color: #8b2252;">' &lt;font color="red"&gt;&amp;#8593&lt;/font&gt;'</span>, v_max1, v_max2,
                                                    v_min1, v_min2, v_avg1, v_avg2, v_coment, v_more, flag)
                        <span style="color: #a020f0;">elif</span> k == <span style="color: #8b2252;">'CPU&#20351;&#29992;&#29575;(%)'</span> <span style="color: #a020f0;">or</span> k == <span style="color: #8b2252;">'&#20869;&#23384;&#20351;&#29992;&#29575;(%)'</span>:
                            <span style="color: #a0522d;">v_coment</span> = <span style="color: #8b2252;">'AVG&#22686;&#38271;&#29575;&#22823;&#20110;10%'</span>
                            <span style="color: #a020f0;">if</span> v_avg2 &gt; 90:
                                <span style="color: #b22222;"># </span><span style="color: #b22222;">v_more = '&lt;a href="http://www.baidu.com"&gt;MORE..&lt;/a&gt;'</span>
                                <span style="color: #a0522d;">flag</span> = <span style="color: #8b2252;">'rate'</span>
                                <span style="color: #a0522d;">comment_content</span> += <span style="color: #8b2252;">'&lt;p&gt;{}&#25351;&#26631;{}&#36739;&#39640;&#65292;&#36817;2&#22825;AVG&#22686;&#38271;&#29575;&#20026;{}&#65292;&#35831;&#20851;&#27880;&#12290;&lt;/p&gt;'</span>.<span style="color: #483d8b;">format</span>(rds, k.strip(<span style="color: #8b2252;">'%()'</span>), v_rate)
                            <span style="color: #a0522d;">msg</span> += create_html_table(k, v_rate + <span style="color: #8b2252;">' &lt;font color="red"&gt;&amp;#8593&lt;/font&gt;'</span>, v_max1, v_max2,
                                                    v_min1, v_min2, v_avg1, v_avg2, v_coment, v_more, flag)
                        <span style="color: #a020f0;">elif</span> k == <span style="color: #8b2252;">'&#24930;&#26085;&#24535;&#25968;'</span>:
                            <span style="color: #a0522d;">v_coment</span> = <span style="color: #8b2252;">'MAX&#22686;&#38271;&#29575;&#22823;&#20110;10%'</span>
                            <span style="color: #a020f0;">if</span> v_max2 &gt; 100:
                                <span style="color: #b22222;"># </span><span style="color: #b22222;">v_more = '&lt;a href="http://www.baidu.com"&gt;MORE..&lt;/a&gt;'</span>
                                <span style="color: #a0522d;">flag</span> = <span style="color: #8b2252;">'rate'</span>
                                <span style="color: #a0522d;">comment_content</span> += <span style="color: #8b2252;">'&lt;p&gt;{}&#25351;&#26631;{}&#36739;&#39640;&#65292;&#36817;2&#22825;MAX&#22686;&#38271;&#29575;&#20026;{}&#65292;&#35831;&#20851;&#27880;&#12290;&lt;/p&gt;'</span>.<span style="color: #483d8b;">format</span>(rds, k.strip(<span style="color: #8b2252;">'%()'</span>), v_rate)
                            <span style="color: #a0522d;">msg</span> += create_html_table(k, v_rate + <span style="color: #8b2252;">' &lt;font color="red"&gt;&amp;#8593&lt;/font&gt;'</span>, v_max1, v_max2,
                                                 v_min1, v_min2, v_avg1, v_avg2, v_coment, v_more, flag)
                        <span style="color: #a020f0;">else</span>:
                            <span style="color: #a0522d;">v_coment</span> = <span style="color: #8b2252;">'MAX&#22686;&#38271;&#29575;&#22823;&#20110;10%'</span>
                            <span style="color: #b22222;"># </span><span style="color: #b22222;">v_more = '&lt;a href="http://www.baidu.com"&gt;MORE..&lt;/a&gt;'</span>
                            <span style="color: #a0522d;">msg</span> += create_html_table(k, v_rate + <span style="color: #8b2252;">' &lt;font color="red"&gt;&amp;#8593&lt;/font&gt;'</span>, v_max1, v_max2,
                                                    v_min1, v_min2, v_avg1, v_avg2, v_coment, v_more, flag)
                            <span style="color: #a0522d;">comment_content</span> += <span style="color: #8b2252;">'&lt;p&gt;{}&#25351;&#26631;{}&#36739;&#39640;&#65292;&#36817;2&#22825;MAX&#22686;&#38271;&#29575;&#20026;{}&#65292;&#35831;&#20851;&#27880;&#12290;&lt;/p&gt;'</span>.<span style="color: #483d8b;">format</span>(rds, k.strip(<span style="color: #8b2252;">'%()'</span>), v_rate)
                    <span style="color: #a020f0;">else</span>:
                        <span style="color: #a020f0;">if</span> k == <span style="color: #8b2252;">'&#27963;&#36291;&#36830;&#25509;&#25968;'</span>:
                            <span style="color: #a0522d;">v_coment</span> = <span style="color: #8b2252;">'MAX&#22823;&#20110;30'</span>
                            <span style="color: #a020f0;">if</span> v_max2 &gt;= 30:
                                <span style="color: #b22222;"># </span><span style="color: #b22222;">v_more = '&lt;a href="http://www.baidu.com"&gt;MORE..&lt;/a&gt;'</span>
                                <span style="color: #a0522d;">flag</span> = <span style="color: #8b2252;">'max'</span>
                                <span style="color: #a0522d;">comment_content</span> += <span style="color: #8b2252;">'&lt;p&gt;{}&#25351;&#26631;{}&#36739;&#39640;, {}&#26368;&#22823;&#20540;&#20026;{}&#65292;&#35831;&#20851;&#27880;&#12290;&lt;/p&gt;'</span>.<span style="color: #483d8b;">format</span>(rds, k.strip(<span style="color: #8b2252;">'%()'</span>),
                                                                                          after_time, v_max2)
                            <span style="color: #a0522d;">msg</span> += create_html_table(k, v_rate, v_max1, v_max2,
                                                    v_min1, v_min2, v_avg1, v_avg2, v_coment, v_more, flag)
                        <span style="color: #a020f0;">elif</span> k == <span style="color: #8b2252;">'&#24635;&#31354;&#38388;&#20351;&#29992;&#29575;(%)'</span>:
                            <span style="color: #a0522d;">v_coment</span> = <span style="color: #8b2252;">'MAX&#22823;&#20110;70%'</span>
                            <span style="color: #a020f0;">if</span> v_max2 &gt; 70:
                                <span style="color: #b22222;"># </span><span style="color: #b22222;">v_more = '&lt;a href="http://www.baidu.com"&gt;MORE..&lt;/a&gt;'</span>
                                <span style="color: #a0522d;">flag</span> = <span style="color: #8b2252;">'max'</span>
                                <span style="color: #a0522d;">comment_content</span> += <span style="color: #8b2252;">'&lt;p&gt;{}&#25351;&#26631;{}&#36739;&#39640;, {}&#26368;&#22823;&#20540;&#20026;{}&#65292;&#35831;&#20851;&#27880;&#12290;&lt;/p&gt;'</span>.<span style="color: #483d8b;">format</span>(rds, k.strip(<span style="color: #8b2252;">'%()'</span>),
                                                                                          after_time, v_max2)
                            <span style="color: #a0522d;">msg</span> += create_html_table(k, v_rate, v_max1, v_max2, v_min1, v_min2, v_avg1, v_avg2, v_coment,
                                                    v_more, flag)
                        <span style="color: #a020f0;">elif</span> k == <span style="color: #8b2252;">'IOPS&#20351;&#29992;&#29575;(%)'</span>:
                            <span style="color: #a0522d;">v_coment</span> = <span style="color: #8b2252;">'AVG&#22686;&#38271;&#29575;&#22823;&#20110;10%'</span>
                            <span style="color: #a020f0;">if</span> v_avg2 == 100:
                                <span style="color: #b22222;"># </span><span style="color: #b22222;">v_more = '&lt;a href="http://www.baidu.com"&gt;MORE..&lt;/a&gt;'</span>
                                <span style="color: #a0522d;">flag</span> = <span style="color: #8b2252;">''</span>
                                <span style="color: #a0522d;">comment_content</span> += <span style="color: #8b2252;">'&lt;p&gt;{}&#25351;&#26631;{}&#24050;&#21344;&#28385;&#65292;{}&#24179;&#22343;&#20540;&#20026;{}&#65292;&#35831;&#20851;&#27880;&#12290;&lt;/p&gt;'</span>.<span style="color: #483d8b;">format</span>(rds, k.strip(<span style="color: #8b2252;">'%()'</span>), after_time, v_avg2)
                            <span style="color: #a0522d;">msg</span> += create_html_table(k, v_rate, v_max1, v_max2,
                                                    v_min1, v_min2, v_avg1, v_avg2, v_coment, v_more, flag)
                        <span style="color: #a020f0;">elif</span> k == <span style="color: #8b2252;">'CPU&#20351;&#29992;&#29575;(%)'</span> <span style="color: #a020f0;">or</span> k == <span style="color: #8b2252;">'&#20869;&#23384;&#20351;&#29992;&#29575;(%)'</span>:
                            <span style="color: #a0522d;">v_coment</span> = <span style="color: #8b2252;">'AVG&#22686;&#38271;&#29575;&#22823;&#20110;10%'</span>
                            <span style="color: #a020f0;">if</span> v_avg2 &gt; 90:
                                <span style="color: #b22222;"># </span><span style="color: #b22222;">v_more = '&lt;a href="http://www.baidu.com"&gt;MORE..&lt;/a&gt;'</span>
                                <span style="color: #a0522d;">flag</span> = <span style="color: #8b2252;">''</span>
                                <span style="color: #a0522d;">comment_content</span> += <span style="color: #8b2252;">'&lt;p&gt;{}&#25351;&#26631;{}&#36739;&#39640;&#65292;{}&#24179;&#22343;&#20540;&#20026;{}&#65292;&#35831;&#20851;&#27880;&#12290;&lt;/p&gt;'</span>.<span style="color: #483d8b;">format</span>(rds, k.strip(<span style="color: #8b2252;">'%()'</span>), after_time, v_avg2)
                            <span style="color: #a0522d;">msg</span> += create_html_table(k, v_rate, v_max1, v_max2,
                                                    v_min1, v_min2, v_avg1, v_avg2, v_coment, v_more, flag)
                        <span style="color: #a020f0;">elif</span> k == <span style="color: #8b2252;">'&#24930;&#26085;&#24535;&#25968;'</span>:
                            <span style="color: #a0522d;">v_coment</span> = <span style="color: #8b2252;">'MAX&#22686;&#38271;&#29575;&#22823;&#20110;10%'</span>
                            <span style="color: #a020f0;">if</span> v_max2 &gt; 100:
                                <span style="color: #b22222;"># </span><span style="color: #b22222;">v_more = '&lt;a href="http://www.baidu.com"&gt;MORE..&lt;/a&gt;'</span>
                                <span style="color: #a0522d;">flag</span> = <span style="color: #8b2252;">'rate'</span>
                                <span style="color: #a0522d;">comment_content</span> += <span style="color: #8b2252;">'&lt;p&gt;{}&#25351;&#26631;{}&#36739;&#39640;&#65292;{}&#26368;&#22823;&#20540;&#20026;{}&#65292;&#35831;&#20851;&#27880;&#12290;&lt;/p&gt;'</span>.<span style="color: #483d8b;">format</span>(rds, k.strip(<span style="color: #8b2252;">'%()'</span>), after_time, v_max2)
                            <span style="color: #a0522d;">msg</span> += create_html_table(k, v_rate, v_max1, v_max2,
                                                 v_min1, v_min2, v_avg1, v_avg2, v_coment, v_more, flag)
                        <span style="color: #a020f0;">else</span>:
                            <span style="color: #a0522d;">v_coment</span> = <span style="color: #8b2252;">'MAX&#22686;&#38271;&#29575;&#22823;&#20110;10%'</span>
                            <span style="color: #b22222;"># </span><span style="color: #b22222;">v_more = '&lt;a href="http://www.baidu.com"&gt;MORE..&lt;/a&gt;'</span>
                            <span style="color: #a0522d;">flag</span> = <span style="color: #8b2252;">''</span>
                            <span style="color: #a0522d;">msg</span> += create_html_table(k, v_rate, v_max1, v_max2,
                                                    v_min1, v_min2, v_avg1, v_avg2, v_coment, v_more, flag)
                    <span style="color: #b22222;"># </span><span style="color: #b22222;">other_content += '&lt;p&gt;&lt;b&gt;{}:&lt;/b&gt; &#22686;&#38271;&#29575;:{},  &#26368;&#22823;&#20540;:{}&lt;/p&gt;'.format(k, v['Rate'],v['Max'])</span>
        <span style="color: #a0522d;">msg_new</span> = <span style="color: #8b2252;">'&lt;table border="1" id="table-6"&gt;'</span> + msg_new + msg + <span style="color: #8b2252;">'&lt;/tbody&gt;&lt;/table&gt;'</span>
        <span style="color: #a0522d;">other_content</span> += <span style="color: #8b2252;">'&lt;p&gt;&lt;/p&gt;'</span> + msg_new

    <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(comment_content) == 0:
        <span style="color: #a0522d;">comment_content</span> = <span style="color: #8b2252;">"&lt;p&gt;&#30446;&#21069;&#25968;&#25454;&#24211;&#36816;&#34892;&#27491;&#24120;&#65292;&#35814;&#24773;&#22914;&#19979;&#65306;&lt;/p&gt;&lt;hr /&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;"</span>
    <span style="color: #a020f0;">else</span>:
        <span style="color: #a0522d;">seo_content</span> = <span style="color: #8b2252;">""</span>

        <span style="color: #8b2252;">'''&lt;h3&gt;&#20248;&#21270;&#24314;&#35758;&#65306;&lt;/h3&gt;</span>
<span style="color: #8b2252;">            &lt;p&gt;IOPS&#20248;&#21270;&#24314;&#35758;&#65306;&#22871;&#36335;1&lt;/p&gt;</span>
<span style="color: #8b2252;">            &lt;p&gt;CPU/MEMORY&#20248;&#21270;&#24314;&#35758;&#65306;&#22871;&#36335;2&lt;/p&gt;</span>
<span style="color: #8b2252;">            &lt;p&gt;&#27963;&#36291;&#38142;&#25509;&#25968;&#20248;&#21270;&#24314;&#35758;&#65306;&#22871;&#36335;3&lt;/p&gt;</span>
<span style="color: #8b2252;">            &lt;p&gt;&#24635;&#31354;&#38388;&#20351;&#29992;&#29575;&#20248;&#21270;&#24314;&#35758;&#65306;&#22871;&#36335;4&lt;/p&gt;'''</span>
        <span style="color: #a0522d;">comment_content</span> += <span style="color: #8b2252;">'&lt;hr /&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;'</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(html_stye, comment_content, seo_content, other_content, html_slowlog)</span>

    <span style="color: #a020f0;">return</span> html_stye+content+comment_content+seo_content+other_content+html_slowlog

<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">'__main__'</span>:
    <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">    keys = "MySQL_MemCpuUsage,MySQL_Sessions,slavestat,MySQL_IOPS,MySQL_NetworkTraffic,MySQL_DetailedSpaceUsage"</span>
<span style="color: #8b2252;">    MySQL_MemCpuUsage   MySQL&#23454;&#20363;CPU&#20351;&#29992;&#29575;(&#21344;&#25805;&#20316;&#31995;&#32479;&#24635;&#25968;)&#65292;MySQL&#23454;&#20363;&#20869;&#23384;&#20351;&#29992;&#29575;(&#21344;&#25805;&#20316;&#31995;&#32479;&#24635;&#25968;)&#12290;</span>
<span style="color: #8b2252;">    MySQL_Sessions  &#24403;&#21069;&#27963;&#36291;&#36830;&#25509;&#25968;&#65292;&#24403;&#21069;&#24635;&#36830;&#25509;&#25968;&#12290;</span>
<span style="color: #8b2252;">    slavestat   &#21482;&#35835;&#23454;&#20363;&#24310;&#36831;&#12290;</span>
<span style="color: #8b2252;">    MySQL_IOPS  MySQL&#23454;&#20363;&#30340;IOPS&#65288;&#27599;&#31186;IO&#35831;&#27714;&#27425;&#25968;&#65289;&#12290;</span>
<span style="color: #8b2252;">    MySQL_NetworkTraffic    MySQL&#23454;&#20363;&#24179;&#22343;&#27599;&#31186;&#38047;&#30340;&#36755;&#20837;&#27969;&#37327;&#65292;MySQL&#23454;&#20363;&#24179;&#22343;&#27599;&#31186;&#38047;&#30340;&#36755;&#20986;&#27969;&#37327;&#12290;&#21333;&#20301;&#20026;KB&#12290;</span>
<span style="color: #8b2252;">    MySQL_DetailedSpaceUsage    MySQL&#23454;&#20363;&#31354;&#38388;&#21344;&#29992;&#35814;&#24773;&#65306;ins_size&#23454;&#20363;&#24635;&#31354;&#38388;&#20351;&#29992;&#37327;;data_size&#25968;&#25454;&#31354;&#38388;;log_size&#26085;&#24535;&#31354;&#38388;;tmp_size&#20020;&#26102;&#31354;&#38388;;other_size&#31995;&#32479;&#31354;&#38388;&#12290;</span>

<span style="color: #8b2252;">    slow_log</span>
<span style="color: #8b2252;">    :return:</span>
<span style="color: #8b2252;">    """</span>
    <span style="color: #a0522d;">client</span> = AcsClient(<span style="color: #8b2252;">'LTAsssssssss'</span>, <span style="color: #8b2252;">'kv5sssss'</span>, <span style="color: #8b2252;">'cn-beijing'</span>)
    <span style="color: #483d8b;">print</span>(get_rds_info(<span style="color: #8b2252;">'zys'</span>))
    <span style="color: #a0522d;">rds_info</span> = get_rds_info(<span style="color: #8b2252;">'zys'</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">keys = "MySQL_IOPS"</span>
    <span style="color: #a0522d;">keys</span> = <span style="color: #8b2252;">"MySQL_MemCpuUsage,MySQL_Sessions,MySQL_IOPS,MySQL_DetailedSpaceUsage"</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">select can be 'day', 'week', 'month', 'year'. default 'week'.</span>
    <span style="color: #a0522d;">response</span> =analyze_data(rds_info, keys, select=<span style="color: #8b2252;">"week"</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(response)</span>

    <span style="color: #a0522d;">content</span> = create_email_content(response)
    <span style="color: #a0522d;">to_addr</span> = [<span style="color: #8b2252;">'shenhuiliang@mankebao.com'</span>,<span style="color: #8b2252;">'dba@yunzongnet.com'</span>]  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25509;&#25910;&#37038;&#20214;&#65292;&#21487;&#35774;&#32622;&#20026;&#20320;&#30340;QQ&#37038;&#31665;&#25110;&#32773;&#20854;&#20182;&#37038;&#31665;</span>
    <span style="color: #a0522d;">cc_addr</span> = [<span style="color: #8b2252;">'sa@yunzongnet.com'</span>]
    <span style="color: #a0522d;">subject</span> = <span style="color: #8b2252;">'&#20113;xxx&#25968;&#25454;&#24211;&#24033;&#26816;&#25253;&#21578;(&#21326;&#21271;2)'</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20027;&#39064;</span>

    <span style="color: #a0522d;">images</span> = [
        <span style="color: #8b2252;">'/data/rrdtool_data/MySQL_SQLSlowLog.png'</span>,
        <span style="color: #8b2252;">'/data/rrdtool_data/MySQL_Sessions_active_session.png'</span>,
        <span style="color: #8b2252;">'/data/rrdtool_data/MySQL_DetailedSpaceUsage.png'</span>,
        <span style="color: #8b2252;">'/data/rrdtool_data/MySQL_MemCpuUsage_cpuusage.png'</span>,
        <span style="color: #8b2252;">'/data/rrdtool_data/MySQL_MemCpuUsage_memusage.png'</span>,
        <span style="color: #8b2252;">'/data/rrdtool_data/MySQL_IOPS_io.png'</span>,
    ]

    <span style="color: #a0522d;">is_html</span> = <span style="color: #008b8b;">True</span>
    send_email(to_addr,cc_addr,subject,content, is_html, images, url=<span style="color: #008b8b;">None</span>)
</pre>
</div>


<figure id="orgb1e6e62">
<img src="./images/img_20240220_035225.png" alt="img_20240220_035225.png" width="80%">

</figure>


<figure id="org021c497">
<img src="./images/img_20240220_035248.png" alt="img_20240220_035248.png" width="80%">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:859253c8-387c-46fe-a522-0b952edc62e2" class="outline-3">
<h3 id="h:859253c8-387c-46fe-a522-0b952edc62e2">12. golang与rrdtool结合画图</h3>
<div class="outline-text-3" id="text-h:859253c8-387c-46fe-a522-0b952edc62e2">
<p>
工具包：<a href="https://github.com/ziutek/rrd/">https://github.com/ziutek/rrd/</a>
</p>


<p>
参考：
</p>
<ul class="org-ul">
<li>官方文档 ： <a href="https://oss.oetiker.ch/rrdtool/doc/index.en.html">https://oss.oetiker.ch/rrdtool/doc/index.en.html</a></li>
<li>RRDtool 简体中文教程 v1.01 &lt;<a href="https://bbs.chinaunix.net/thread-864861-1-1.html">https://bbs.chinaunix.net/thread-864861-1-1.html</a>&gt;</li>
</ul>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
