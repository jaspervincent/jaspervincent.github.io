<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: Mysql</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux: Mysql</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:e8075145-6425-4461-99cd-38b2160dfffa">数据库原理</a>
<ul>
<li><a href="#h:68cc6e3a-3a9b-43d9-a192-ed0c460d33c4">数据的时代</a></li>
<li><a href="#h:7f0df53b-ab70-4a3c-8615-5ddec5b3e4b0">数据库的发展史</a></li>
<li><a href="#h:404013c3-d37b-4eb4-b4cb-a8f9a66d2808">DBMS 数据库管理系统</a></li>
<li><a href="#h:6082bafe-ec6a-45de-8caf-463529542019">数据库管理系统的优点</a></li>
<li><a href="#h:4d118851-3112-4fed-a11b-4d7546f3e894">数据库管理系统的基本功能</a></li>
<li><a href="#h:159dacb7-c5ab-442c-932a-fb22031ed400">数据库系统的架构</a></li>
<li><a href="#h:16c05096-849c-42ef-a455-8ff20a53d6ba">各种数据库管理系统</a></li>
<li><a href="#h:15bb13db-5f1d-4b71-96c4-d598d38e718f">关系型数据库理论</a>
<ul>
<li><a href="#h:3f935997-bc10-439a-99e8-744f58d3308f">实体-联系模型E-R</a></li>
<li><a href="#h:612a284f-a8f2-4b51-9aa2-d0ee2047eb4e">联系类型</a></li>
<li><a href="#h:10aad7fb-c025-4ec8-b601-ff8d50e75097">数据的操作</a></li>
<li><a href="#h:0cea8785-cad9-4968-9171-28ea8fe8d7d0">数据库规划流程</a></li>
<li><a href="#h:683b58b5-0f40-47d8-91cd-196871f86802">数据库的正规化分析</a>
<ul>
<li><a href="#h:b087b452-44cb-4c7f-9b42-556d5eb6a713">第一范式：1NF</a></li>
<li><a href="#h:d4f9d3f2-2f07-4da4-a98f-20e9f903e881">第二范式：2NF</a></li>
<li><a href="#h:23e9b1b2-800d-4b3e-a440-5a2b60d9f27f">第三范式：3NF</a></li>
</ul>
</li>
<li><a href="#h:b48cb938-1d16-4a1a-8dc2-42f1ec4c939f">SQL 结构化查询语言简介</a></li>
<li><a href="#h:a326e770-fbde-4447-b3e0-81d2cfb63457">数据约束</a></li>
<li><a href="#h:95922a03-e4e7-46cd-8546-afbc5016ed86">关系运算</a></li>
<li><a href="#h:bdfcf297-0b6b-4624-8026-64357cb6b7f1">数据抽象</a></li>
<li><a href="#h:b95fa268-a9af-4985-8f5a-7a24db0f2a52">关系模型的分类</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:10279ad5-3445-4d04-af7b-c2b8ebc6512f">MySQL安装和基本使用</a>
<ul>
<li><a href="#h:451a53b2-4abc-4a2a-97f5-c91bc6b79896">MySQL 介绍</a>
<ul>
<li><a href="#h:72a5999e-f9f8-4cd6-8864-f0d9f12f96b7">MySQL 历史</a></li>
<li><a href="#h:a046c222-e01f-4192-ac2a-2f5c098f6dbb">MySQL系列</a>
<ul>
<li><a href="#h:51a8cf2a-4339-45c2-86c6-2c9383cdef45">MySQL 的三大主要分支</a></li>
<li><a href="#h:83d1e748-8389-42c5-92f1-70fe787780f8">官方网址</a></li>
<li><a href="#h:1fe34616-ea9a-46b9-af38-1fcc13df92e2">官方文档</a></li>
<li><a href="#h:c50a77f6-a202-4998-80d2-8246e3f15596">版本演变</a></li>
</ul>
</li>
<li><a href="#h:43784de4-7842-4d95-8730-c108c9e5a27b">MYSQL的特性</a></li>
</ul>
</li>
<li><a href="#h:3e553713-59dd-4c41-b3ca-dabdd544da67">MySQL 安装</a>
<ul>
<li><a href="#h:9966cdc0-1527-409b-af98-87e6867b2666">安装方式</a></li>
<li><a href="#h:09b107c1-ad82-4094-8ac0-198b1a9809ae">RPM包安装MySQL</a></li>
<li><a href="#h:8b52f820-ca7e-4e49-9987-5e0d74c49bc4">初始化脚本提高安全性</a></li>
</ul>
</li>
<li><a href="#h:c1f1d240-4b0a-477f-8b00-6e705cd7c8af">MySQL 组成</a>
<ul>
<li><a href="#h:4f7f28c1-9aa7-4282-a4ba-81038fb0de29">客户端程序</a></li>
<li><a href="#h:eec18cbb-916a-4f05-a505-16d98e150a82">服务器端程序</a></li>
<li><a href="#h:27efe8ff-50bd-48fd-b96d-b9f1a1cb934a">用户账号</a></li>
<li><a href="#h:daf8dbb2-08c8-4685-8b3f-e169f8b555df">mysql 命令</a>
<ul>
<li><a href="#h:d8e87d65-c69c-464b-9a3f-ebce3e6883dd">mysql 运行命令类型</a></li>
<li><a href="#h:59c03c0d-7463-47cb-b641-211f42ae199f">mysql使用模式</a></li>
<li><a href="#h:8e4feeb1-5f95-49e5-8a4b-dd812b3f77b1">mysql命令使用格式</a></li>
<li><a href="#h:3540d1db-b2b2-4a5b-8bef-430698036761">mysqladmin命令</a></li>
<li><a href="#h:28aa0cd0-b012-4cf9-8382-47f28887f6af">mycli</a></li>
</ul>
</li>
<li><a href="#h:1ca92f4b-640a-425a-b94e-fa3422c80231">服务器端配置</a>
<ul>
<li><a href="#h:943837cf-472a-4195-8406-62914bc5ee54">服务器端配置文件</a></li>
<li><a href="#h:d85ee8a6-9786-407d-8b10-fadcfcc21588">socket 连接说明</a></li>
<li><a href="#h:21f87e86-83e9-4311-910a-4a31b8c27877">关闭mysqld网络连接</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:46e883ed-908e-457e-91fa-fec70297785b">通用二进制格式安装MySQL</a>
<ul>
<li><a href="#h:d8b6b6d5-10fd-4b0d-9267-231713fe4c02">通用二进制格式安装 MySQL5.6</a></li>
<li><a href="#h:0719ce3f-bc78-41de-9c38-d978bbe0ad65">实战案例：一键安装mysql-5.6二进制包的脚本</a></li>
<li><a href="#h:f0b5c3a8-7083-4b6e-aad7-fd86923f0e1f">实战案例：通用二进制安装MySQL5.7和MySQL8.0</a></li>
<li><a href="#h:22c4c8d6-4b3c-414c-8012-b35085ba2624">实战案例：一键安装MySQL5.7和MySQL8.0二进制包的脚本</a></li>
</ul>
</li>
<li><a href="#h:8ed018ee-1edb-47fd-8677-0782933d364b">源码编译安装MySQL</a></li>
<li><a href="#h:b3ae154c-2cbc-43b7-bb1f-92c97801550d">基于docker容器创建MySQL</a>
<ul>
<li><a href="#h:192e9a09-8724-4642-b654-ca7a06e5094e">docker-compose</a></li>
</ul>
</li>
<li><a href="#h:336e7d0a-4c7f-4596-b71e-730a8fd6cb6c">MySQL多实例</a>
<ul>
<li><a href="#h:d6ac88f6-7b2a-4864-b37b-10c6f1edbe78">多实例介绍</a></li>
<li><a href="#h:57de1e17-b55c-4f27-90e1-6d6a7ea19aa6">多实例常见的配置方案</a></li>
<li><a href="#h:eb0466be-7f8f-49cf-a7c4-576109eaef22">实战案例：CentOS 8实现MySQL的多实例</a></li>
<li><a href="#h:3fa1b332-9977-4cb0-b5cd-cd8221ca9419">实战案例：CentOS 7 实现MySQL的多实例</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:44a7af11-fb8e-40e2-ba0f-79f048edafb1">SQL语言</a>
<ul>
<li><a href="#h:974e902c-0026-41ff-9533-f1410f9d5e1b">关系型数据库的常见组件</a></li>
<li><a href="#h:24ad07b3-9c08-49c5-b323-d20c3ac20091">SQL语言的兴起与语法标准</a>
<ul>
<li><a href="#h:d8408bc0-933d-479e-9c2f-33915b9fb35d">SQL语言规范</a>
<ul>
<li><a href="#h:f2ea4919-8354-400b-a3f2-8aa60ac5fa07">注释</a></li>
</ul>
</li>
<li><a href="#h:f20a66ab-3544-49f3-84ce-766c701da20c">数据库对象和命名</a></li>
<li><a href="#h:1a48785f-7064-40c3-9941-2fd86c7fc8c1">SQL语句分类</a></li>
<li><a href="#h:5e2c74f2-19ff-44dd-a076-f53efaf5be1d">SQL语句构成</a></li>
<li><a href="#h:19d078ca-e087-455f-9825-70e41211a350">字符集和排序</a></li>
</ul>
</li>
<li><a href="#h:476c40ea-cc96-44a6-b28e-1c8e18ceecdf">管理数据库</a>
<ul>
<li><a href="#h:a34d293d-c5ee-4b3c-b028-9b2d691ec1ac">创建数据库</a></li>
<li><a href="#h:f21792dc-e9e9-4d48-9492-aafeee193e36">修改数据库</a></li>
<li><a href="#h:03e40a88-2187-41d9-a938-f5672cca4d9a">删除数据库</a></li>
<li><a href="#h:2da943ef-be61-49a9-9437-adebcbc7e2e7">查看数据库列表</a></li>
</ul>
</li>
<li><a href="#h:1a17248f-37c1-46d4-8063-df2a502fa7bb">数据类型</a>
<ul>
<li><a href="#h:572483ab-00ea-4cc3-9022-cf3d17e6c0bc">整数型</a>
<ul>
<li><a href="#h:f0867143-411a-4b66-8fef-1d1a841fc59d">零填充</a></li>
</ul>
</li>
<li><a href="#h:af7b63d4-b4ff-44b9-9aff-dca3f8e5e6a7">浮点型(float和double)，近似值</a></li>
<li><a href="#h:db829c2f-54ff-4e21-adde-e6ea987c0eff">定点数</a></li>
<li><a href="#h:da0b7754-219c-49fa-bb57-f6f17c46c30a">字符串(char,varchar,text)</a></li>
<li><a href="#h:e94c37d7-0356-4523-8322-b7f35473de09">二进制数据BLOB</a></li>
<li><a href="#h:1bb58cb3-8284-4970-9301-cca9322c1b0c">日期时间类型</a></li>
<li><a href="#h:87e7d092-dda2-4ebb-b874-bab94862259e">修饰符</a></li>
</ul>
</li>
<li><a href="#h:344b8414-c94a-49fc-9c9d-117ddabc6634">DDL语句</a>
<ul>
<li><a href="#h:9cc4f8c5-beaf-42ba-861a-0c4e32686872">创建表</a>
<ul>
<li><a href="#h:7a12dc72-888d-4fbe-8f90-7150423fe0b2">直接创建</a></li>
<li><a href="#h:6cff1492-8dee-42b4-b30a-89f997e25e9e">通过查询现存表创建；</a></li>
<li><a href="#h:cef0503c-c5df-4ce9-940c-043d781ac1e4">通过复制现存的表的表结构创建</a></li>
</ul>
</li>
<li><a href="#h:540298c9-f3a0-47c0-94c8-fdf3fd6f0113">表查看</a></li>
<li><a href="#h:e9ed5f2b-c733-44f6-b29d-11753bf3cc63">修改和删除表</a></li>
</ul>
</li>
<li><a href="#h:1278e416-e04a-4aee-8c2c-10c473390141">DML语句</a>
<ul>
<li><a href="#h:5fad30c4-6393-4c8d-9014-6f59a0e00a23">INSERT 语句</a></li>
<li><a href="#h:bfba86b0-daaa-4777-8722-3d836af81d68">UPDATE 语句</a></li>
<li><a href="#h:178af40d-46f8-4083-862b-08908a258541">DELETE语句</a></li>
</ul>
</li>
<li><a href="#h:a20665f6-5b6a-41cf-812d-232e2682d64c">DQL语句</a>
<ul>
<li><a href="#h:9091368c-62d0-4eac-bee9-7535e790f690">单表操作</a>
<ul>
<li><a href="#h:11b01c3c-4ae7-4a7f-91be-6092858665e4">范例DQL查询</a></li>
<li><a href="#h:5fbd7b8a-f187-4d67-84e0-f9b0e04fd160">范例：SQL 注入攻击</a></li>
</ul>
</li>
<li><a href="#h:4f013738-cd22-4e8d-a0d0-ab36ca8720b6">多表查询</a>
<ul>
<li><a href="#h:1b243197-450a-4923-9c0a-f31824d60c4d">子查询</a></li>
<li><a href="#h:dce359a5-2421-4c85-adbe-81ab03823140">联合查询：UNION</a></li>
<li><a href="#h:3a8b03fe-e27a-4121-8ff9-a12cedd4c88a">交叉连接</a></li>
<li><a href="#h:c07299d0-0fd0-4a5d-bfbc-70511ee971ad">内连接</a></li>
<li><a href="#h:7dd0291f-d5f7-41cb-aa9a-e86006b405cb">左和右外连接</a></li>
<li><a href="#h:67970beb-08af-4256-9d99-c0367cf30c66">完全外连接</a></li>
<li><a href="#h:3779ba7b-09af-4e30-9fc2-cf17f4b23684">自连接</a></li>
</ul>
</li>
<li><a href="#h:e8617f0a-8811-4cc3-a06c-152a5ccf9ddd">SELECT语句处理的顺序</a></li>
</ul>
</li>
<li><a href="#h:66c3a9d6-08c4-4603-99a3-ba05bf0d0075">VIEW 视图</a></li>
<li><a href="#h:51c1117c-9815-453d-b73d-b94b26365b9e">FUNCTION函数</a></li>
<li><a href="#h:2a5f6ed2-cdc6-42b1-9cf6-f95674b364df">PROCEDURE 存储过程</a></li>
<li><a href="#h:f80bd23f-fd88-4aa3-853c-a02739cd87c9">TRIGGER触发器</a></li>
<li><a href="#h:d51dfa5e-e72c-4c13-a756-4e81e1b2995f">Event 事件</a>
<ul>
<li><a href="#h:917a0998-0d2c-405b-9627-5358d14e37b7">Event 事件介绍</a></li>
<li><a href="#h:581c701f-e400-4ec0-bc6e-2f0c17caebaa">Event 管理</a></li>
</ul>
</li>
<li><a href="#h:df32b01a-be72-4054-9731-04119ba20970">MySQL用户管理</a></li>
<li><a href="#h:346de87c-8110-4b77-bfdb-b6a1816599fc">权限管理和DCL语句</a>
<ul>
<li><a href="#h:e465dad3-a7ff-4371-a20c-87b98b1f3aa2">权限类别</a></li>
<li><a href="#h:19f4dfe6-71ce-465d-b03f-a83a0b0b7300">授权</a></li>
<li><a href="#h:7c2ad19d-eb4e-4cd4-8cb1-f39cf4bc0e59">取消授权</a></li>
<li><a href="#h:38e881a9-120d-407c-bc1c-04f15144ea3c">查看指定用户获得的授权</a></li>
</ul>
</li>
<li><a href="#h:b5f1a88b-10d4-472f-b677-05711bd72a82">MySQL的图形化的远程管理工具</a>
<ul>
<li><a href="#h:bcf1b4e3-6142-4338-8eb0-da81eb9339e8">Navicat 工具</a></li>
<li><a href="#h:4c35febf-a83d-48ce-afe0-f7b8ed94c9b8">SQLyog 工具</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:c5656d63-861f-40b8-9a17-f730410d9b13">MySQL架构和性能优化</a>
<ul>
<li><a href="#h:4e664f29-0593-4b9a-937e-e7db5602cc1f">存储引擎</a>
<ul>
<li><a href="#h:3110850c-c00c-43d8-805d-24bac5ed9eca">MyISAM存储引擎</a></li>
<li><a href="#h:da93cbf5-ef31-44d0-b46c-98562ba68cf5">InnoDB引擎</a></li>
<li><a href="#h:6c3b9816-c874-4bde-9f4a-48abb72ac52b">其它存储擎</a></li>
<li><a href="#h:28463359-f410-47b8-8332-0703c17788e4">管理存储引擎</a></li>
</ul>
</li>
<li><a href="#h:532a2efb-a8fe-4117-8cb2-ca48dee4ab15">MySQL中的系统数据库</a></li>
<li><a href="#h:60740cea-39aa-4e28-ab2b-a73b6c02e704">服务器配置和状态</a>
<ul>
<li><a href="#h:dd9652f1-b828-48c8-bfba-519dc4068895">服务器选项</a></li>
<li><a href="#h:d1c8edd5-6e51-4d1d-99d1-a9d1620c852e">服务器系统变量</a></li>
<li><a href="#h:2c19a9c9-aeb5-4eaf-903a-768ce6e1baf5">服务器状态变量</a></li>
<li><a href="#h:53e12fb7-b477-424d-a215-2af6f7bf2e7c">服务器变量 SQL_MODE</a></li>
</ul>
</li>
<li><a href="#h:9a24ca51-7a13-4050-9938-c0b929fa062e">Query Cache 查询缓存</a>
<ul>
<li><a href="#h:4cc5da30-42d2-47da-af85-12d4c0aa2fd2">查询缓存原理</a></li>
<li><a href="#h:5a365c2c-82b8-46a5-8a00-b164f3f5f79c">查询缓存相关的服务器变量</a></li>
<li><a href="#h:a3ca6b41-122c-4785-9d87-b24328cf4099">SELECT语句的缓存控制</a></li>
<li><a href="#h:58da837a-7de6-48d2-9486-af526545e234">查询缓存相关的状态变量：</a></li>
<li><a href="#h:7af5b956-e639-439f-89bd-77f9ef98a78a">命中率和内存使用率估算</a></li>
<li><a href="#h:c98974a2-805f-4d46-91d4-b438655d1946">MySQL 8.0 变化 MySQL8.0 取消查询缓存的功能</a></li>
</ul>
</li>
<li><a href="#h:2c4d773a-c488-4e84-9be8-795e81442717">INDEX 索引</a>
<ul>
<li><a href="#h:015a3bcd-e4e2-4de6-a5d3-f0b9accbcc1e">索引介绍</a></li>
<li><a href="#h:a48789cf-06ad-46b3-9a35-8fb531ad12ba">索引结构</a></li>
<li><a href="#h:0ea4c831-3921-4250-9d92-31e2eab497da">索引优化</a></li>
<li><a href="#h:1f0ea039-68fc-40f9-a342-647a4a117a8d">管理索引</a></li>
<li><a href="#h:84a7c1fa-68d6-4b34-aa18-1f4d327eafec">EXPLAIN 工具</a></li>
<li><a href="#h:4ef33225-dcb1-48d2-8bec-e8ebea91d41d">使用profile工具</a></li>
</ul>
</li>
<li><a href="#h:ed57c9e8-2b90-46e5-a398-650a37fe8b21">并发控制</a>
<ul>
<li><a href="#h:56cc3ebc-25d5-446b-9d1e-291459941522">锁机制</a></li>
<li><a href="#h:4867302c-4591-4888-9c38-6a80978ef68a">显式使用锁</a></li>
<li><a href="#h:a52b3615-195e-418a-97e3-558ebaf95d0c">事务</a>
<ul>
<li><a href="#h:f714fe44-8c27-4e41-85a4-f0896aab06a1">事务特性</a></li>
<li><a href="#h:ab416fe1-5ac4-49f5-8e3a-0c674ebacc32">管理事务</a></li>
<li><a href="#h:79390ef8-c5d8-471a-bab2-f2b7c9d22e64">事务隔离级别</a></li>
<li><a href="#h:ad711803-f199-4f45-938d-537bfb99e817">MVCC工作机制</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:d18c785f-0f5b-4181-a6ea-6d7f9465a156">日志管理</a>
<ul>
<li><a href="#h:d54d3dd5-c9e8-4f7b-8f3a-871daa8e722b">事务日志</a></li>
<li><a href="#h:246b10a1-f5ac-4c8b-b956-645ae8d2d2df">错误日志</a></li>
<li><a href="#h:fb76ea6f-d574-4448-b6f2-a3e5a33692fa">通用日志</a></li>
<li><a href="#h:064cce78-4b19-4ad5-9a4e-f480a0105613">慢查询日志</a></li>
<li><a href="#h:0f282e7d-4879-46a9-933e-3cedfccf5bd3">二进制日志(备份)</a>
<ul>
<li><a href="#h:f5457a3b-8db0-4860-9e7a-29c20486e44c">mysqlbinlog</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:c2e008fc-d831-4561-8856-3969b2f53836">备份和恢复</a>
<ul>
<li><a href="#h:932f6731-d19d-44c1-af01-6532488fdb93">备份恢复概述</a>
<ul>
<li><a href="#h:51610076-d324-4546-8dfe-d76b2d60e646">为什么要备份</a></li>
<li><a href="#h:d9dea3d7-6c34-47e1-9279-27ceddcb8bee">备份类型</a></li>
<li><a href="#h:f952dfa0-221d-4731-8e90-d4b9bf91cd41">备份什么</a></li>
<li><a href="#h:e0473e80-62a1-4f65-b56e-fff1fb4bb9df">备份注意要点</a></li>
<li><a href="#h:13c68889-fd48-4076-82e8-7603b6580fa5">还原要点</a></li>
<li><a href="#h:ed0ade02-29af-468b-aeae-67ad6d196510">备份工具</a></li>
<li><a href="#h:d38e51fd-7202-4390-b575-d0be9471ca5b">实战案例：数据库冷备份和还原</a></li>
<li><a href="#h:7d9ce158-20da-44ba-b49c-923231e2514f">基于 LVM 的快照备份</a></li>
</ul>
</li>
<li><a href="#h:276d44d1-0862-402e-a013-d6c07968dc4c">mysqldump备份工具</a>
<ul>
<li><a href="#h:c2524df1-54d7-49fb-ae52-c3286ed47274">mysqldump 说明</a></li>
<li><a href="#h:d0c19868-4c36-454f-93cd-4aae7468fcb6">生产环境实战备份策略</a></li>
<li><a href="#h:940374e7-e698-4759-881e-9e0399165167">mysqldump 备份还原实战案例</a>
<ul>
<li><a href="#h:630b6256-da69-48b8-8d9d-e8a6590b7bc8">实战案例：特定数据库的备份脚本</a></li>
<li><a href="#h:82e9e745-3e58-453f-8091-18f3a352c70e">实战案例：分库备份并压缩</a></li>
<li><a href="#h:3f736f26-7383-4a9b-8f4d-5af2947125e8">实战案例:分库备份的实战脚本</a></li>
<li><a href="#h:a5ecffba-72d7-403c-acf4-a90bc886546b">实战案例：完全备份和还原</a></li>
<li><a href="#h:1211aeb1-af7f-41ac-a91a-85e2212151d4">实战案例：利用二进制日志，还原数据库最新状态</a></li>
<li><a href="#h:15002842-d474-4e66-8878-14da6f20a3ad">实战案例：mysqldump 和二进制日志结合实现增量备份</a></li>
<li><a href="#h:639bfb04-e165-47db-9d81-21d19c77aaf9">实战案例：恢复误删除的表</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:60db1127-9599-4ff3-8eac-32d2e0edbf5d">xtrabackup备份工具</a>
<ul>
<li><a href="#h:8c1072a7-0439-4b03-8f82-fd7c0d7556d7">xtrabackup工具介绍</a></li>
<li><a href="#h:fca7414b-3e5e-45ba-9a2e-e4d7ecb80633">xtrabackup安装</a></li>
<li><a href="#h:40e80201-3fe6-47fc-9384-3be79844bee4">xtrabackup用法</a></li>
<li><a href="#h:9fbca042-4fb9-4a6b-98c5-965efadaa90d">实战案例：利用xtrabackup实现完全备份及还原</a></li>
<li><a href="#h:8786f2f2-6407-4e69-b4ac-017248ffe81c">实战案例：利用xtrabackup完全，增量备份及还原</a></li>
<li><a href="#h:5d8831e8-cf5b-4c05-9303-3c8c3a18755c">实战案例：xtrabackup单表导出和导入</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:15552be7-052b-4781-8129-4eba774d8564">MySQL 集群 Cluster</a>
<ul>
<li><a href="#h:1486d879-d01d-41b8-8ba1-2b1e4490767f">MySQL主从复制</a>
<ul>
<li><a href="#h:dc2e32b0-3f12-4959-a99a-3527784d344e">主从复制架构和原理</a>
<ul>
<li><a href="#h:ca0fb76a-662c-4e33-a7bc-c19d54688784">MySQL的主从复制</a></li>
<li><a href="#h:fe0aed3a-1860-496b-b35d-8e08ca68e4ab">复制的功用</a></li>
<li><a href="#h:226fca84-1b26-42d6-9028-bd9be49f1c2b">复制架构</a></li>
<li><a href="#h:1be6945f-6e86-46dd-996b-832e93941f73">主从复制原理</a></li>
<li><a href="#h:aef021ab-8d3a-4f17-862b-77628f1019d9">主从复制特点</a></li>
<li><a href="#h:d3a6bad6-75dd-4e13-a777-fabeba439737">各种复制架构</a></li>
</ul>
</li>
<li><a href="#h:2fc749dc-0a2f-42d7-94c2-bd00df868ecf">实现主从复制配置</a></li>
<li><a href="#h:77d1178c-c61f-4453-936b-f6938a3f2655">主从复制相关</a>
<ul>
<li><a href="#h:c3fa4477-f9df-46e4-9f70-aaec9261777d">限制从服务器为只读</a></li>
<li><a href="#h:10a909a1-6ca2-4ce6-a4e0-9994470d6652">在从节点清除信息</a></li>
<li><a href="#h:0164501b-6112-4ef2-b451-ece373f8c9c7">复制错误解决方法</a></li>
<li><a href="#h:2c146f37-99fa-4776-a394-f038f92b79ed">START SLAVE 语句，指定执到特定的点</a></li>
<li><a href="#h:55189aa4-6984-4381-bc37-ce58f2c9b652">保证主从复制的事务安全</a></li>
<li><a href="#h:5f799f0f-282a-407b-bf84-dc2fa93ff0be">范例：将旧的mysql单机变成主从复制架构</a></li>
<li><a href="#h:414ba383-dd17-419f-bb77-7302e6f6e70c">范例：当master服务器宕机，提升一个slave成为新的master</a></li>
</ul>
</li>
<li><a href="#h:ca568fc7-ad2e-4822-af4c-6e8d3379a32e">实现级联复制</a></li>
<li><a href="#h:0e537cb8-9e82-4bd3-8632-51eb6290f8f6">主主复制</a></li>
<li><a href="#h:3435e7c5-bdce-4b56-95cc-e19f5226d9a1">半同步复制</a></li>
<li><a href="#h:4a6e2b30-49f5-4186-9110-e808c10a2d25">复制过滤器</a></li>
<li><a href="#h:1d03f0ef-3e0b-4979-b69a-5d8f08261958">主从复制加密</a></li>
<li><a href="#h:a9de387c-6027-4df8-a78c-6b777402df2c">GTID复制</a></li>
<li><a href="#h:99119b23-45e8-48ff-92e5-62c97ef7129d">复制的监控和维护</a>
<ul>
<li><a href="#h:8e9a5133-3f7e-404b-99d9-d43d00f56232">清理日志</a></li>
<li><a href="#h:d2bb8fec-749e-449f-a157-bb041fbe3cea">复制监控</a></li>
<li><a href="#h:ff4591ee-9a69-484c-8cab-1d9e07d2cbfe">从服务器是否落后于主服务</a></li>
<li><a href="#h:2ef7a0f9-1029-435b-8439-6b9ef00a3794">如何确定主从节点数据是否一致</a></li>
<li><a href="#h:fd70a6dd-f8aa-49ca-b5c8-fae3dd4b1f4a">数据不一致如何修复</a></li>
</ul>
</li>
<li><a href="#h:d1d77357-557b-4865-ad89-658d9a702f55">复制的问题和解决方案</a>
<ul>
<li><a href="#h:c48dafb9-8de4-43d9-82d6-9903ca00a320">数据损坏或丢失</a></li>
<li><a href="#h:e27fd0d8-a3a8-4466-a930-4c49fc83d227">不惟一的server id</a></li>
<li><a href="#h:2851788f-e1b2-4a1a-95a6-eee7901f2679">复制延迟</a></li>
<li><a href="#h:aeaebffb-219f-457f-a0a9-ebe08bcbc070">MySQL主从数据不一致</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:9929b512-8098-4e62-9b02-a45d3c3298cd">MySQL 中间件代理服务器</a>
<ul>
<li><a href="#h:908a8f2f-6510-49dd-8edf-1e96e1e08960">关系型数据库和 NoSQL 数据库</a></li>
<li><a href="#h:6ee2ce35-6080-4fc9-818a-386fbe8d9a45">数据切分</a>
<ul>
<li><a href="#h:a1caa0f5-14d9-4f9a-8ab6-034ab6ce6e02">垂直切分</a></li>
<li><a href="#h:eb23a234-94fe-4522-8f39-a4da5f4a5c42">水平切分</a></li>
</ul>
</li>
<li><a href="#h:b23a49a8-6bc9-4f71-b311-5223b2ff8aa2">MySQL中间件各种应用</a></li>
<li><a href="#h:675285e4-bab1-406a-b953-d0dfe472424c">Mycat</a>
<ul>
<li><a href="#h:a93777d8-98cd-4116-807c-19da89718e31">Mycat介绍</a></li>
<li><a href="#h:b0ea64ab-0095-4040-8b8c-38bbdd5bb793">Mycat安装</a></li>
<li><a href="#h:5c9be5a8-69c9-4a67-8700-9bdc6250cf64">Mycat 主要配置文件说明</a></li>
<li><a href="#h:ded17984-e30b-4dfe-820f-10aaa0061482">实战案例：利用Mycat实现MySQL的读写分离</a></li>
</ul>
</li>
<li><a href="#h:f1d63e42-f699-45c3-8254-36c352290aba">ProxySQL</a>
<ul>
<li><a href="#h:33786871-b4ee-43c1-a0b9-8c3f58f9096a">ProxySQL 介绍</a></li>
<li><a href="#h:31d0b902-918c-45c9-92a8-cfb87c727a42">ProxySQL安装</a></li>
<li><a href="#h:d8f9f4e2-dc92-40a5-a20d-346c2d687b6c">实战案例：利用ProxySQL实现读写分离</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:83a17d25-ebaf-4b3a-ae01-de3823df15eb">MySQL高可用</a>
<ul>
<li><a href="#h:cb30b1df-b169-4e4b-b326-60038c05c3c9">MySQL高可用解决方案</a></li>
<li><a href="#h:d23a3908-636b-435a-9e0c-f0447ea4445f">MHA Master High Availability</a>
<ul>
<li><a href="#h:3a77991a-da90-435c-8e43-cebe3ff3aad3">MHA 工作原理和架构</a></li>
<li><a href="#h:f8e0467b-6fdd-4224-842e-d842a42a2a55">实现MHA实战案例</a></li>
</ul>
</li>
<li><a href="#h:3cd55e5d-2a3b-4c78-b4d0-781185a16897">Galera Cluster</a>
<ul>
<li><a href="#h:c370e826-3692-4782-aa25-5804b18be867">Galera Cluster介绍</a></li>
<li><a href="#h:c122f355-bbeb-4d85-b851-a1a720e918f9">PXC 原理</a></li>
<li><a href="#h:469ca160-3ddf-4b5e-9ec1-72dc63a5a3b2">实战案例：Percona XtraDB Cluster(PXC 5.7）</a></li>
<li><a href="#h:4ad13043-2483-4f6d-8a0c-79ca90cb3542">实战案例：MariaDB Galera Cluster</a></li>
</ul>
</li>
<li><a href="#h:5da7b53d-e331-4b3b-9fc0-56cfd2b86670">TiDB概述</a>
<ul>
<li><a href="#h:baec973e-904f-45c0-904b-d73c90a85ddb">核心特点</a></li>
<li><a href="#h:526de852-4b26-48c4-9c7a-dd47f559f915">TiDB整体架构</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:2095ad92-531c-43e6-ade8-c897a6933f13">性能优化</a>
<ul>
<li><a href="#h:b0c9cd34-5da5-4002-81e3-2e49b72252fc">压力测试工具</a>
<ul>
<li><a href="#h:bec493ed-c80c-4b98-97df-49db1a0bcbf7">常见MySQl压力测试工具</a></li>
<li><a href="#h:044ca7ee-78aa-4721-b1bd-7dfa88809954">mysqlslap</a></li>
</ul>
</li>
<li><a href="#h:306deea3-ed8c-4b0a-816e-35d8f4fd3c42">生产环境 my.cnf 配置案例</a></li>
<li><a href="#h:1443fc58-3fba-48b3-a120-ebba311c3f5a">MySQL配置最佳实践</a>
<ul>
<li><a href="#h:d701fdd6-7527-46da-81be-9d98bebd08a5">基础规范</a></li>
<li><a href="#h:b26a9d77-8d02-489f-b0ea-e2dca201d4eb">命名规范</a></li>
<li><a href="#h:e8abfc26-77c9-44aa-8cf7-410bfab5bb25">表设计规范</a></li>
<li><a href="#h:14b17690-5a59-41c0-aaf7-9892a52859eb">字段设计规范</a></li>
<li><a href="#h:63a6c8d5-b903-4b18-81c9-23e55ae1b98a">索引设计规范</a></li>
<li><a href="#h:bfb142a4-990b-4b4e-998a-4871bb204729">SQL使用规范</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../index.html">Linux</a></li>
</ul>
<section id="outline-container-h:e8075145-6425-4461-99cd-38b2160dfffa" class="outline-2">
<h2 id="h:e8075145-6425-4461-99cd-38b2160dfffa">数据库原理</h2>
<div class="outline-text-2" id="text-h:e8075145-6425-4461-99cd-38b2160dfffa">
</div>
<div id="outline-container-h:68cc6e3a-3a9b-43d9-a192-ed0c460d33c4" class="outline-3">
<h3 id="h:68cc6e3a-3a9b-43d9-a192-ed0c460d33c4">数据的时代</h3>
<div class="outline-text-3" id="text-h:68cc6e3a-3a9b-43d9-a192-ed0c460d33c4">
<ul class="org-ul">
<li>涉及的数据量大</li>
<li>数据不随程序的结束而消失</li>
<li>数据被多个应用程序共享</li>
<li>大数据</li>
</ul>

<p>
*数据的分类*：
</p>

<ul class="org-ul">
<li>结构化的数据：即有固定格式和有限长度的数据。例如填的表格就是结构化的
数据，国籍：中华人民共和国，民族：汉，性别：男，这都叫结构化数据</li>
<li>非结构化的数据：非结构化的数据越来越多，就是不定长、无固定格式的数据，
例如网页，有时候非常长，有时候几句话就没了；例如语音，视频都是非结构
化的数据</li>
<li>半结构化数据：比如：XML或者HTML的格式的数据</li>
</ul>
</div>
</div>
<div id="outline-container-h:7f0df53b-ab70-4a3c-8615-5ddec5b3e4b0" class="outline-3">
<h3 id="h:7f0df53b-ab70-4a3c-8615-5ddec5b3e4b0">数据库的发展史</h3>
<div class="outline-text-3" id="text-h:7f0df53b-ab70-4a3c-8615-5ddec5b3e4b0">
<ul class="org-ul">
<li><p>
萌芽阶段：文件系统
</p>

<p>
使用磁盘文件来存储数据
</p></li>
<li><p>
初级阶段：第一代数据库
</p>

<p>
出现了网状模型、层次模型的数据库
</p></li>

<li><p>
中级阶段：第二代数据库
</p>

<p>
关系型数据库和结构化查询语言
</p></li>

<li><p>
高级阶段：新一代数据库
</p>

<p>
"关系-对象"型数据库
</p></li>
</ul>

<p>
<b>文件管理系统的缺点</b>
</p>

<ul class="org-ul">
<li>编写应用程序不方便</li>
<li>数据冗余不可避免</li>
<li>应用程序依赖性</li>
<li>不支持对文件的并发访问</li>
<li>数据间联系弱</li>
<li>难以按用户视图表示数据</li>
<li>无安全控制功能</li>
</ul>
</div>
</div>
<div id="outline-container-h:404013c3-d37b-4eb4-b4cb-a8f9a66d2808" class="outline-3">
<h3 id="h:404013c3-d37b-4eb4-b4cb-a8f9a66d2808">DBMS 数据库管理系统</h3>
<div class="outline-text-3" id="text-h:404013c3-d37b-4eb4-b4cb-a8f9a66d2808">
<ul class="org-ul">
<li>数据库：database是数据的汇集，它以一定的组织形式存于存储介质上</li>
<li>DBMS：是管理数据库的系统软件，它实现数据库系统的各种功能。是数据库系
统的核心</li>
<li>DBA：负责数据库的规划、设计、协调、维护和管理等工作</li>
<li>应用程序：指以数据库为基础的应用程序</li>
</ul>
</div>
</div>
<div id="outline-container-h:6082bafe-ec6a-45de-8caf-463529542019" class="outline-3">
<h3 id="h:6082bafe-ec6a-45de-8caf-463529542019">数据库管理系统的优点</h3>
<div class="outline-text-3" id="text-h:6082bafe-ec6a-45de-8caf-463529542019">
<ul class="org-ul">
<li>相互关联的数据的集合</li>
<li>较少的数据冗余</li>
<li>程序与数据相互独立</li>
<li>保证数据的安全、可靠</li>
<li>最大限度地保证数据的正确性</li>
<li>数据可以并发使用并能同时保证一致性</li>
</ul>
</div>
</div>
<div id="outline-container-h:4d118851-3112-4fed-a11b-4d7546f3e894" class="outline-3">
<h3 id="h:4d118851-3112-4fed-a11b-4d7546f3e894">数据库管理系统的基本功能</h3>
<div class="outline-text-3" id="text-h:4d118851-3112-4fed-a11b-4d7546f3e894">
<ul class="org-ul">
<li>数据定义</li>
<li>数据处理</li>
<li>数据安全</li>
<li>数据备份</li>
</ul>
</div>
</div>
<div id="outline-container-h:159dacb7-c5ab-442c-932a-fb22031ed400" class="outline-3">
<h3 id="h:159dacb7-c5ab-442c-932a-fb22031ed400">数据库系统的架构</h3>
<div class="outline-text-3" id="text-h:159dacb7-c5ab-442c-932a-fb22031ed400">
<ul class="org-ul">
<li>单机架构</li>
<li>Microsof 中的 access 数据库，账务用的</li>
<li>大型主机/终端架构</li>
<li>主从式架构（C/S）</li>
<li>分布式架构</li>
<li>TIDB</li>
</ul>
</div>
</div>
<div id="outline-container-h:16c05096-849c-42ef-a455-8ff20a53d6ba" class="outline-3">
<h3 id="h:16c05096-849c-42ef-a455-8ff20a53d6ba">各种数据库管理系统</h3>
<div class="outline-text-3" id="text-h:16c05096-849c-42ef-a455-8ff20a53d6ba">
<p>
<b>层次数据库</b>
</p>

<p>
以树型结构表示实体及其之间联系。这种结构简单，但缺乏灵活性，因为这种关
系只支持一对多
</p>

<p>
代表数据库：IBM IMS
</p>

<p>
<b>网状数据库</b>
</p>

<p>
最早出现的是网状DBMS，1964年通用电气公司的Charles Bachman成功地开发出
世界上第一个网状IDS，也是第一个数据库管理系统，IDS具有数据模式和日志的
特征，只能在GE主机运行
</p>

<p>
<b>RDBMS 关系型数据库</b>
</p>

<p>
Relational Database Management System，关系模型最初由IBM公司开始开发系
统R，这是一个开发RDBMS原型的研究项目。然而，第一个商业上可用的RDBMS是
甲骨文，于1979年发布。
</p>

<p>
<b>关系统型数据库相关概念</b>
</p>

<ul class="org-ul">
<li>关系 ：关系就是二维表，其中：表中的行、列次序并不重要</li>
<li>行row：表中的每一行，又称为一条记录record</li>
<li>列column：表中的每一列，称为属性，字段，域field</li>
<li>主键Primary key：PK，一个或多个字段的组合，用于惟一确定一个记录的字段，一张表只有一个主键，主键字段不能为空NULL</li>
<li>唯一键Unique Key: 一个或多个字段的组合，用于惟一确定一个记录的字段，一张表可以有多个UK，且UK字段可以为空NULL，</li>
<li>域domain：属性的取值范围，如，性别只能是'男'和'女'两个值，人类的年龄只能0-150</li>
</ul>

<p>
<b>1.7.3.2 常用关系数据库</b>
</p>

<ul class="org-ul">
<li>MySQL: MySQL, MariaDB, Percona Server</li>
<li>PostgreSQL: 简称为pgsql，EnterpriseDB</li>
<li>Oracle</li>
<li>MSSQL</li>
<li>DB2</li>
</ul>

<p>
<b>1.7.3.3 数据库排名</b>
</p>

<p>
<a href="https://db-engines.com/en/ranking">https://db-engines.com/en/ranking</a>
</p>
</div>
</div>
<div id="outline-container-h:15bb13db-5f1d-4b71-96c4-d598d38e718f" class="outline-3">
<h3 id="h:15bb13db-5f1d-4b71-96c4-d598d38e718f">关系型数据库理论</h3>
<div class="outline-text-3" id="text-h:15bb13db-5f1d-4b71-96c4-d598d38e718f">
</div>
<div id="outline-container-h:3f935997-bc10-439a-99e8-744f58d3308f" class="outline-4">
<h4 id="h:3f935997-bc10-439a-99e8-744f58d3308f">实体-联系模型E-R</h4>
<div class="outline-text-4" id="text-h:3f935997-bc10-439a-99e8-744f58d3308f">
<p>
E-R模型实体-关系模型，E-R 模型就是描述数据库存储数据的结构模型。对于大
型公司开发项目，需要根据产品的设计，先使用建模工具，如power designer,
db desinger 等这些软件来画出实体-关系模型（E-R模型）
</p>

<ul class="org-ul">
<li>实体Entity：客观存在并可以相互区分的客观事物或抽象事件称为实体,在E-R图中用矩形框表示实体，把实体名写在框内</li>
<li>属性：实体所具有的特征或性质，用椭圆形表示。</li>
<li>联系relation：联系是数据之间的关联集合，是客观存在的应用语义链
<ul class="org-ul">
<li>实体内部的联系：指组成实体的各属性之间的联系。如职工实体中，职工号和部门经理号之间有一种关联关系</li>
<li>实体之间的联系：指不同实体之间联系。例：学生选课实体和学生基本信息实体之间</li>
<li>实体之间的联系用菱形框表示</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:612a284f-a8f2-4b51-9aa2-d0ee2047eb4e" class="outline-4">
<h4 id="h:612a284f-a8f2-4b51-9aa2-d0ee2047eb4e">联系类型</h4>
<div class="outline-text-4" id="text-h:612a284f-a8f2-4b51-9aa2-d0ee2047eb4e">
<ul class="org-ul">
<li>一对一联系(1:1): 在表A和表B中创建一个字段，存储另一个表的主键值。如：一个人只有一个身份证</li>
<li>一对多联系(1:n)：外键。一张表的字段与另一张表字段有依赖关系。如部门和员工。</li>
<li>多对多联系(m:n)：增加第三张表。如：学生和课程</li>
</ul>
</div>
</div>
<div id="outline-container-h:10aad7fb-c025-4ec8-b601-ff8d50e75097" class="outline-4">
<h4 id="h:10aad7fb-c025-4ec8-b601-ff8d50e75097">数据的操作</h4>
<div class="outline-text-4" id="text-h:10aad7fb-c025-4ec8-b601-ff8d50e75097">
<p>
开发工程师CRUD(增加Create、查询Retrieve或Read、更新Update、删除Delete)
</p>

<ul class="org-ul">
<li>数据提取：在数据集合中提取感兴趣的内容。SELECT</li>
<li>数据更新：变更数据库中的数据。INSERT、DELETE、UPDATE</li>
</ul>
</div>
</div>
<div id="outline-container-h:0cea8785-cad9-4968-9171-28ea8fe8d7d0" class="outline-4">
<h4 id="h:0cea8785-cad9-4968-9171-28ea8fe8d7d0">数据库规划流程</h4>
<div class="outline-text-4" id="text-h:0cea8785-cad9-4968-9171-28ea8fe8d7d0">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">概念模型 CDM</th>
<th scope="col" class="org-left">逻辑模型LDM</th>
<th scope="col" class="org-left">物理模型PDM</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">目的</td>
<td class="org-left">描述业务系统要管理的对象</td>
<td class="org-left">基于概念模型，详细列出所有实体、实体的属性及关系</td>
<td class="org-left">概念逻辑模型，结合数据库的物理结构，设计具体的表结构，字段列表及主外键</td>
</tr>

<tr>
<td class="org-left">特点</td>
<td class="org-left">用概念名词来描述现实中的实体及业务规则，如联系人</td>
<td class="org-left">基于业务的描述和数据库无关</td>
<td class="org-left">技术实现细节和具体的数据类型相关</td>
</tr>

<tr>
<td class="org-left">主要使用者</td>
<td class="org-left">用户、需求分析师</td>
<td class="org-left">需求分析师、架构师及开发</td>
<td class="org-left">开发、DBA</td>
</tr>
</tbody>
</table>

<ol class="org-ol">
<li><p>
收集数据，得到字段
</p>

<p>
收集必要且完整的数据项
</p>

<p>
转换成数据表的字段
</p></li>

<li><p>
把字段分类，归入表，建立表的关联
</p>

<p>
关联：表和表间的关系
</p>

<p>
分割数据表并建立关联的优点
</p>

<p>
节省空间
</p>

<p>
减少输入错误
</p>

<p>
方便数据修改
</p></li>

<li>规范化数据库</li>
</ol>
</div>
</div>
<div id="outline-container-h:683b58b5-0f40-47d8-91cd-196871f86802" class="outline-4">
<h4 id="h:683b58b5-0f40-47d8-91cd-196871f86802">数据库的正规化分析</h4>
<div class="outline-text-4" id="text-h:683b58b5-0f40-47d8-91cd-196871f86802">
<p>
数据库规范化，又称数据库或资料库的正规化、标准化，是数据库设计中的一系
列原理和技术，以减少数据库中数据冗余，增进数据的一致性。关系模型的发明
者埃德加·科德最早提出这一概念，并于1970年代初定义了第一范式、第二范式
和第三范式的概念
</p>

<p>
设计关系数据库时，遵从不同的规范要求，设计出合理的关系型数据库，不同的
规范要求被称为不同范式，各种范式呈递次规范，越高的范式数据库冗余越小
</p>

<p>
目前关系数据库有六种范式：第一范式（1NF）、第二范式（2NF）、第三范式
（3NF）、巴德斯科范式（BCNF）、第四范式(4NF）和第五范式（5NF，又称完美
范式）。满足最低要求的范式是第一范式（1NF）。在第一范式的基础上进一步
满足更多规范要求的称为第二范式（2NF），其余范式以次类推。一般数据库只
需满足第三范式(3NF）即可
</p>

<p>
规则是死的，人是活的，所以范式是否必须遵守，要看业务需要而定掌握范式的
目的是为了在合适场景下违反范式。
</p>
</div>
<div id="outline-container-h:b087b452-44cb-4c7f-9b42-556d5eb6a713" class="outline-5">
<h5 id="h:b087b452-44cb-4c7f-9b42-556d5eb6a713">第一范式：1NF</h5>
<div class="outline-text-5" id="text-h:b087b452-44cb-4c7f-9b42-556d5eb6a713">
<p>
无重复的列，每一列都是不可分割的基本数据项，同一列中不能有多个值，即实
体中的某个属性不能有多个值或者不能有重复的属性，确保每一列的原子性。除
去同类型的字段，就是无重复的列
</p>

<p>
说明：第一范式（1NF）是对关系模式的基本要求，不满足第一范式（1NF）的数
据库就不是关系数据库
</p>

<p>
如： 表1
</p>
<table>


<colgroup>
<col  class="org-right">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-right">id</td>
<td class="org-left">作者</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">u1</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">u2</td>
</tr>
</tbody>
</table>

<p>
表2
</p>
<table>


<colgroup>
<col  class="org-right">

<col  class="org-right">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-right">id</td>
<td class="org-right">作者id</td>
<td class="org-left">书名</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-left">xx1</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-left">xx2</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">1</td>
<td class="org-left">xx3</td>
</tr>
</tbody>
</table>

<p>
作者id与表1是主外键关系
</p>
</div>
</div>
<div id="outline-container-h:d4f9d3f2-2f07-4da4-a98f-20e9f903e881" class="outline-5">
<h5 id="h:d4f9d3f2-2f07-4da4-a98f-20e9f903e881">第二范式：2NF</h5>
<div class="outline-text-5" id="text-h:d4f9d3f2-2f07-4da4-a98f-20e9f903e881">
<p>
第二范式必须先满足第一范式，属性完全依赖于主键，要求表中的每个行必须可
以被唯一地区分，通常为表加上每行的唯一标识PK，非PK的字段需要与整个PK有
直接相关性，即非PK的字段不能依赖于部分主键
</p>

<p>
例：员工表
</p>


<figure id="orgeac821e">
<img src="./images/Snipaste_2023-05-07_08-25-59.png" alt="Snipaste_2023-05-07_08-25-59.png" width="60%">

</figure>

<p>
同名的人在不同的城市，在同一个城市中每个人的姓名都不一样。设置主键必须
唯一，name和city联合作为复合主键。
</p>

<p>
但我们发现非主键字段依赖了主键，不符合第二范式。需要重新设计
</p>


<figure id="org6f86eae">
<img src="./images/Snipaste_2023-05-07_21-20-17.png" alt="Snipaste_2023-05-07_21-20-17.png" width="60%">

</figure>
</div>
</div>
<div id="outline-container-h:23e9b1b2-800d-4b3e-a440-5a2b60d9f27f" class="outline-5">
<h5 id="h:23e9b1b2-800d-4b3e-a440-5a2b60d9f27f">第三范式：3NF</h5>
<div class="outline-text-5" id="text-h:23e9b1b2-800d-4b3e-a440-5a2b60d9f27f">
<p>
属性不依赖于其它非主属性，满足第三范式必须先满足第二范式。第三范式要求
一个数据表中不包含已在其它表中已包含的非主关键字信息，非PK的字段间不能
有从属关系
</p>
</div>
</div>
</div>
<div id="outline-container-h:b48cb938-1d16-4a1a-8dc2-42f1ec4c939f" class="outline-4">
<h4 id="h:b48cb938-1d16-4a1a-8dc2-42f1ec4c939f">SQL 结构化查询语言简介</h4>
<div class="outline-text-4" id="text-h:b48cb938-1d16-4a1a-8dc2-42f1ec4c939f">
<p>
SQL：结构化查询语言，Structure Query Language
</p>

<p>
SQL解释器：将SQL语句解释成机器语言
</p>

<p>
数据存储协议：应用层协议，C/S
</p>
<ul class="org-ul">
<li>S：server,监听于套接字，接收并处理客户端的应用请求</li>
<li>C：Client</li>
</ul>

<p>
客户端程序接口
</p>
<ul class="org-ul">
<li>CLI</li>
<li>GUI</li>
</ul>

<p>
应用编程接口
</p>
<ul class="org-ul">
<li>ODBC：Open Database Connectivity</li>
<li>JDBC：Java Data Base Connectivity</li>
</ul>
</div>
</div>
<div id="outline-container-h:a326e770-fbde-4447-b3e0-81d2cfb63457" class="outline-4">
<h4 id="h:a326e770-fbde-4447-b3e0-81d2cfb63457">数据约束</h4>
<div class="outline-text-4" id="text-h:a326e770-fbde-4447-b3e0-81d2cfb63457">
<p>
约束：constraint，表中的数据在数据类型限定的基础上额外要遵守的限制
</p>

<p>
常见约束如下：
</p>
<ul class="org-ul">
<li>非空not null：此字段不允许填写空值</li>
<li>主键primary key：一个或多个字段的组合，填入的数据必须能在本表中唯一标识本行；必须提供数据，即NOT NULL，一个表只能有一个</li>
<li>惟一键unique：一个或多个字段的组合，填入的数据必须能在本表中唯一标识本行；允许为NULL，一个表可以存在多个</li>
<li>默认 default：当不填写字段对应的值会使用默认值，如果填写时以填写为准。</li>
<li>外键foreign key：一个表中的某字段可填入的数据取决于另一个表的主键或唯一键已有的数据</li>
<li>检查：字段值在一定范围内。如年龄在0到150之间。</li>
</ul>
</div>
</div>
<div id="outline-container-h:95922a03-e4e7-46cd-8546-afbc5016ed86" class="outline-4">
<h4 id="h:95922a03-e4e7-46cd-8546-afbc5016ed86">关系运算</h4>
<div class="outline-text-4" id="text-h:95922a03-e4e7-46cd-8546-afbc5016ed86">
<ul class="org-ul">
<li>选择：挑选出符合条件的行</li>
<li>投影：挑选出需要的字段</li>
<li>连接：表间字段的关联</li>
</ul>
</div>
</div>
<div id="outline-container-h:bdfcf297-0b6b-4624-8026-64357cb6b7f1" class="outline-4">
<h4 id="h:bdfcf297-0b6b-4624-8026-64357cb6b7f1">数据抽象</h4>
<div class="outline-text-4" id="text-h:bdfcf297-0b6b-4624-8026-64357cb6b7f1">
<ul class="org-ul">
<li>物理层：数据存储格式，即RDBMS在磁盘上如何组织文件</li>
<li>逻辑层：DBA角度，描述存储什么数据，以及数据间存在什么样的关系</li>
<li>视图层：用户角度，描述DB中的部分数据</li>
</ul>
</div>
</div>
<div id="outline-container-h:b95fa268-a9af-4985-8f5a-7a24db0f2a52" class="outline-4">
<h4 id="h:b95fa268-a9af-4985-8f5a-7a24db0f2a52">关系模型的分类</h4>
<div class="outline-text-4" id="text-h:b95fa268-a9af-4985-8f5a-7a24db0f2a52">
<ul class="org-ul">
<li>关系模型</li>
<li>基于对象的关系模型</li>
<li>半结构化的关系模型：XML数据</li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-h:10279ad5-3445-4d04-af7b-c2b8ebc6512f" class="outline-2">
<h2 id="h:10279ad5-3445-4d04-af7b-c2b8ebc6512f">MySQL安装和基本使用</h2>
<div class="outline-text-2" id="text-h:10279ad5-3445-4d04-af7b-c2b8ebc6512f">
</div>
<div id="outline-container-h:451a53b2-4abc-4a2a-97f5-c91bc6b79896" class="outline-3">
<h3 id="h:451a53b2-4abc-4a2a-97f5-c91bc6b79896">MySQL 介绍</h3>
<div class="outline-text-3" id="text-h:451a53b2-4abc-4a2a-97f5-c91bc6b79896">
</div>
<div id="outline-container-h:72a5999e-f9f8-4cd6-8864-f0d9f12f96b7" class="outline-4">
<h4 id="h:72a5999e-f9f8-4cd6-8864-f0d9f12f96b7">MySQL 历史</h4>
<div class="outline-text-4" id="text-h:72a5999e-f9f8-4cd6-8864-f0d9f12f96b7">
<p>
MySQL的历史可以追溯到1979年，它的创始人叫做 Michael widenius，他在开发
一个报表工具时，设计了一套API，后来他的客户要求他的API支持SQL语句，他
直接借助于mSQL（当时比较牛）的代码，将它集成到自己的存储引擎中。但是他
总是感觉不满意，萌生了自己做一套数据库的想法。
</p>

<p>
直到1996年，MySQL 1.0发布，Michael Widenius的大女儿的简称就是MY，
Michael Widenius大概也是把MySQL当成自己女儿一样对待。仅仅过了几个月的
时间，1996年10月MySQL 3.11.1 当时发布了Solaris的版本，一个月后，linux
的版本诞生，从那里开始，MySQL慢慢的被人所接受。
</p>

<p>
1999年，Michael Widenius成立了MySQL AB公司，MySQL由个人开发转变为团队
开发，2000年使用GPL协议开源。
</p>

<p>
2001年，MySQL生命中大事发生了，那就是存储引擎InnoDB的诞生。Oracle在
2005年收集了InnoDB，只不过InnoDB一直以来都只能作为第三方插件供用户选择。
直到现在，MySQL可以选择的众多存储引擎中，InnoDB依然是第一选择。
</p>

<p>
2008年，MySQL AB公司被Sun公司以10亿美元收购，MySQL数据库进入Sun时代。
Sun为MySQL的发展提供了绝佳的环境，2008年11月，MySQL 5.1发布，MySQL成为
了最受欢迎的小型数据库。
</p>

<p>
2009年4月，Oracle公司以74亿美元收购Sun公司，MySQL也随之进入Oracle时代。
</p>

<p>
2010年12月，MySQL 5.5发布，Oracle终于把InnoDB做成了MySQL的默认存储引擎，
Mysql从此进入了辉煌时代。
</p>

<p>
然而，从那之后，Oracle对MySQL的态度渐渐发生了变化，Oracle虽然宣称MySQL
依然遵守GPL协议，但却暗地里把开发人员全部换成了Oracle自己人，开源社区
再也影响不了MySQL发展的脚步，真正有心做贡献的人也被拒之门外，MySQL随时
都有闭源的可能&#x2026;..
</p>

<p>
看着自己辛苦养大的MySQL被Oracle搞成这样，Michael Widenius非常失望，决
定在MySQL走向闭源前，将MySQL进行分支化，依然是使用了自己小女儿的名字
MariaDB。
</p>

<p>
MariaDB数据库管理系统是MySQL的一个分支，主要由开源社区在维护，采用GPL
协议，MariaDB的目的是完全兼容MySQL，包括API和命令行，使之能轻松成为
MySQL的代替品。在存储引擎方面，使用XtraDB来代替MySQL的InnoDB。
</p>

<p>
MariaDB由MySQL的创始人主导，由开源社区的大神进行开发。因此，大家都认为，
MariaDB拥有比MySQL纯正的MySQL血脉。
</p>

<p>
最初的版本更新与MySQL同步，相对MySQL5以后的版本，MariaDB也有相应的
5.1-5.5版本。后来MariaDB终于摆脱了MySQL，它的版本号直接从10.0开始，以
自己的步伐进行开发，当然，还是可以对MySQL完全兼容。
</p>

<p>
Mysql大事记：
</p>
<ul class="org-ul">
<li>1979年：TcX公司 Monty Widenius，Unireg</li>
<li>1996年：发布MySQL1.0，Solaris版本，Linux版本</li>
<li>1999年：MySQL AB公司，瑞典</li>
<li>2003年：MySQL 5.0版本，提供视图、存储过程等功能</li>
<li>2008年：Sun 花10亿美元收购MySQL</li>
<li>2009年：Oracle 花75亿美元收购sun</li>
<li>2009年：Monty成立MariaDB</li>
</ul>
</div>
</div>
<div id="outline-container-h:a046c222-e01f-4192-ac2a-2f5c098f6dbb" class="outline-4">
<h4 id="h:a046c222-e01f-4192-ac2a-2f5c098f6dbb">MySQL系列</h4>
<div class="outline-text-4" id="text-h:a046c222-e01f-4192-ac2a-2f5c098f6dbb">
</div>
<div id="outline-container-h:51a8cf2a-4339-45c2-86c6-2c9383cdef45" class="outline-5">
<h5 id="h:51a8cf2a-4339-45c2-86c6-2c9383cdef45">MySQL 的三大主要分支</h5>
<div class="outline-text-5" id="text-h:51a8cf2a-4339-45c2-86c6-2c9383cdef45">
<ul class="org-ul">
<li>mysql</li>
<li>mariadb</li>
<li>percona Server</li>
</ul>
</div>
</div>
<div id="outline-container-h:83d1e748-8389-42c5-92f1-70fe787780f8" class="outline-5">
<h5 id="h:83d1e748-8389-42c5-92f1-70fe787780f8">官方网址</h5>
<div class="outline-text-5" id="text-h:83d1e748-8389-42c5-92f1-70fe787780f8">
<ul class="org-ul">
<li><a href="https://www.mysql.com/">https://www.mysql.com/</a></li>
<li><a href="http://mariadb.org/">http://mariadb.org/</a></li>
<li><a href="https://www.percona.com">https://www.percona.com</a></li>
</ul>
</div>
</div>
<div id="outline-container-h:1fe34616-ea9a-46b9-af38-1fcc13df92e2" class="outline-5">
<h5 id="h:1fe34616-ea9a-46b9-af38-1fcc13df92e2">官方文档</h5>
<div class="outline-text-5" id="text-h:1fe34616-ea9a-46b9-af38-1fcc13df92e2">
<ul class="org-ul">
<li><a href="https://dev.mysql.com/doc/">https://dev.mysql.com/doc/</a></li>
<li><a href="https://mariadb.com/kb/en/">https://mariadb.com/kb/en/</a></li>
<li><a href="https://www.percona.com/software/mysql-database/percona-server">https://www.percona.com/software/mysql-database/percona-server</a></li>
</ul>
</div>
</div>
<div id="outline-container-h:c50a77f6-a202-4998-80d2-8246e3f15596" class="outline-5">
<h5 id="h:c50a77f6-a202-4998-80d2-8246e3f15596">版本演变</h5>
<div class="outline-text-5" id="text-h:c50a77f6-a202-4998-80d2-8246e3f15596">
<p>
MySQL：5.1 &#x2013;&gt; 5.5 &#x2013;&gt; 5.6 &#x2013;&gt; 5.7 &#x2013;&gt;8.0
</p>

<p>
MariaDB：5.5 &#x2013;&gt;10.0&#x2013;&gt; 10.1 &#x2013;&gt; 10.2 &#x2013;&gt; 10.3 &#x2013;&gt; 10.4 &#x2013;&gt; 10.5 &#x2026; &#x2013;&gt; 11.1
</p>
</div>
</div>
</div>
<div id="outline-container-h:43784de4-7842-4d95-8730-c108c9e5a27b" class="outline-4">
<h4 id="h:43784de4-7842-4d95-8730-c108c9e5a27b">MYSQL的特性</h4>
<div class="outline-text-4" id="text-h:43784de4-7842-4d95-8730-c108c9e5a27b">
<ul class="org-ul">
<li>插件式存储引擎：也称为“表类型”，存储管理器有多种实现版本，功能和特
性可能均略有差别；用户可根据需要灵活选择,Mysql5.5.5开始innoDB引擎是
MYSQL默认引擎
<ul class="org-ul">
<li>MyISAM ==&gt; Aria</li>
<li>InnoDB ==&gt; XtraDB</li>
</ul></li>
<li>单进程，多线程</li>
<li>诸多扩展和新特性</li>
<li>提供了较多测试组件</li>
<li>开源</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:3e553713-59dd-4c41-b3ca-dabdd544da67" class="outline-3">
<h3 id="h:3e553713-59dd-4c41-b3ca-dabdd544da67">MySQL 安装</h3>
<div class="outline-text-3" id="text-h:3e553713-59dd-4c41-b3ca-dabdd544da67">
</div>
<div id="outline-container-h:9966cdc0-1527-409b-af98-87e6867b2666" class="outline-4">
<h4 id="h:9966cdc0-1527-409b-af98-87e6867b2666">安装方式</h4>
<div class="outline-text-4" id="text-h:9966cdc0-1527-409b-af98-87e6867b2666">
<ul class="org-ul">
<li>源代码：编译安装</li>
<li>二进制格式的程序包：展开至特定路径，并经过简单配置后即可使用</li>
<li>程序包管理器管理的程序包</li>
</ul>
</div>
</div>
<div id="outline-container-h:09b107c1-ad82-4094-8ac0-198b1a9809ae" class="outline-4">
<h4 id="h:09b107c1-ad82-4094-8ac0-198b1a9809ae">RPM包安装MySQL</h4>
<div class="outline-text-4" id="text-h:09b107c1-ad82-4094-8ac0-198b1a9809ae">
<p>
CentOS 安装光盘
</p>

<p>
项目官方：<a href="https://downloads.mariadb.org/mariadb/repositories/">https://downloads.mariadb.org/mariadb/repositories/</a>
</p>

<p>
国内镜像：<a href="https://mirrors.tuna.tsinghua.edu.cn/mariadb/yum/">https://mirrors.tuna.tsinghua.edu.cn/mariadb/yum/</a>
<a href="https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/">https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/</a>
</p>

<p>
CentOS 8：安装光盘直接提供
</p>

<ul class="org-ul">
<li>mysql-server：8.0</li>
<li>mariadb-server : 10.3.17</li>
</ul>

<p>
CentOS 7：安装光盘直接提供
</p>

<ul class="org-ul">
<li>mariadb-server：5.5 服务器包</li>
<li>mariadb 客户端工具包</li>
</ul>

<p>
CentOS 6：
</p>

<ul class="org-ul">
<li>mysql-server：5.1 服务器包</li>
<li>mysql 客户端工具包</li>
</ul>

<p>
范例: CentOS 7 安装MySQL5.7
</p>

<div class="org-src-container">
<pre class="src src-sh">[10:54:25 root@centos7 ~]#cat /etc/yum.repos.d/mysql57.repo 
[mysql57]
<span style="color: #a0522d;">name</span>=mysql57
<span style="color: #a0522d;">baseurl</span>=https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql-5.7-community-el7-x86_64/
<span style="color: #a0522d;">gpgcheck</span>=0

[10:55:08 root@centos7 ~]#yum list | grep mysql57
mysql-community-client.i686              5.7.33-1.el7                  mysql57  
mysql-community-libs-compat.x86_64       5.7.33-1.el7                  mysql57  
mysql-community-server.x86_64            5.7.33-1.el7                  mysql57  
mysql-community-test.x86_64              5.7.33-1.el7                  mysql57  
[10:55:17 root@centos7 ~]#yum install mysql-community-server -y
[11:00:53 root@centos7 ~]#systemctl enable --now mysqld
[11:04:08 root@centos7 ~]#ss -ntl
State       Recv-Q Send-Q        Local Address:Port                       Peer Address:Port                         
LISTEN      0      80                     [::]:3306                               [::]:*                  
[11:04:26 root@centos7 ~]#mysql
ERROR 1045 (28000): Access denied for user <span style="color: #8b2252;">'root'</span>@<span style="color: #8b2252;">'localhost'</span> (using password: NO)
[11:05:15 root@centos7 ~]#grep password /var/log/mysqld.log 
2021-01-28T03:04:05.376619Z 1 [Note] A temporary password is generated for root@localhost: j9eNwN#IsToD
2021-01-28T03:05:15.225574Z 2 [Note] Access denied for user <span style="color: #8b2252;">'root'</span>@<span style="color: #8b2252;">'localhost'</span> (using password: NO)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#21021;&#22987;&#23494;&#30721;&#26041;&#27861;1</span>
[11:37:14 root@centos7 ~]#mysql -uroot -p<span style="color: #8b2252;">'j9eNwN#IsToD'</span>
mysql&gt; alter user root@<span style="color: #8b2252;">'localhost'</span> identified by <span style="color: #8b2252;">'Zhangzhuo@0705'</span>;
Query OK, 0 rows affected (0.00 sec)
mysql&gt; status
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#21021;&#22987;&#23494;&#30721;&#26041;&#27861;2</span>
[11:38:28 root@centos7 ~]#mysqladmin -uroot -p<span style="color: #8b2252;">'j9eNwN#IsToD'</span> password <span style="color: #8b2252;">'Zhangzhuo@0705'</span>
</pre>
</div>

<p>
范例：centos7安装Mariadb
</p>

<div class="org-src-container">
<pre class="src src-sh">[11:42:44 root@centos7 ~]#cat /etc/yum.repos.d/mariadb.repo
[mariadb105]
<span style="color: #a0522d;">name</span>=mariadb105
<span style="color: #a0522d;">baseurl</span>=https://mirrors.tuna.tsinghua.edu.cn/mariadb/yum/10.5/centos/7/x86_64/
<span style="color: #a0522d;">gpgcheck</span>=0
[11:47:06 root@centos7 ~]#yum install -y MariaDB-server
[11:47:43 root@centos7 ~]#systemctl enable --now mariadb.service
[11:48:08 root@centos7 ~]#mysql
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 3
Server version: 10.5.8-MariaDB MariaDB Server

<span style="color: #0000ff;">Copyright</span> (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type <span style="color: #8b2252;">'help;'</span> or <span style="color: #8b2252;">'\h'</span> for help. Type <span style="color: #8b2252;">'\c'</span> to clear the current input statement.

MariaDB [(none)]&gt; status
------------------------

mysql  Ver 15.1 Distrib 10.5.8-MariaDB, for Linux (x86_64) using readline 5.1

Connection id:      3
Current database:   
Current user:       root@localhost
SSL:            Not<span style="color: #a020f0;"> in</span> use
Current pager:      stdout
Using outfile:      <span style="color: #8b2252;">''</span>
Using delimiter:    ;
Server:         MariaDB
Server version:     10.5.8-MariaDB MariaDB Server
Protocol version:   10
Connection:     Localhost via UNIX socket
Server characterset:    latin1
Db     characterset:    latin1
Client characterset:    utf8
Conn.  characterset:    utf8
UNIX socket:        /var/lib/mysql/mysql.sock
Uptime:         18 sec

Threads: 2  Questions: 4  Slow queries: 0  Opens: 16  Open tables: 10  Queries per second avg: 0.222
</pre>
</div>

<p>
范例：ubuntu安装MySQL
</p>
<div class="org-src-container">
<pre class="src src-sh">apt list mysql*

apt install mysql-server

ss -tnlp
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#26381;&#21153;&#40664;&#35748;&#21551;&#21160;&#20102;&#65292;&#19988;&#31471;&#21475;&#32465;&#23450;&#22312;127.0.0.1&#19978;&#65292;&#38656;&#35201;&#25163;&#21160;&#25913;&#37197;&#32622;&#25991;&#20214;&#12290;</span>
</pre>
</div>


<p>
命令帮助
加分号的命令是传给服务端的命令，不加分号是客户端命令
客户端命令
</p>
<div class="org-src-container">
<pre class="src src-sh">mysql&gt; \h

For information about MySQL products and services, visit:
   http://www.mysql.com/
For developer information, including the MySQL Reference Manual, visit:
   http://dev.mysql.com/
To buy MySQL Enterprise support, training, or other products, visit:
   https://shop.mysql.com/

List of all MySQL commands:
Note that all text commands must be first on line and end with <span style="color: #8b2252;">';'</span>
?         (<span style="color: #8b2252;">\?</span>) Synonym for <span style="color: #ff00ff;">`help'.</span>
<span style="color: #ff00ff;">clear     (\c) Clear the current input statement.</span>
<span style="color: #ff00ff;">connect   (\r) Reconnect to the server. Optional arguments are db and host.</span>
<span style="color: #ff00ff;">delimiter (\d) Set statement delimiter.</span>
<span style="color: #ff00ff;">edit      (\e) Edit command with $EDITOR.</span>
<span style="color: #ff00ff;">ego       (\G) Send command to mysql server, display result vertically.</span>
<span style="color: #ff00ff;">exit      (\q) Exit mysql. Same as quit.</span>
<span style="color: #ff00ff;">go        (\g) Send command to mysql server.</span>
<span style="color: #ff00ff;">help      (\h) Display this help.</span>
<span style="color: #ff00ff;">nopager   (\n) Disable pager, print to stdout.</span>
<span style="color: #ff00ff;">notee     (\t) Don't write into outfile.</span>
<span style="color: #ff00ff;">pager     (\P) Set PAGER [to_pager]. Print the query results via PAGER.</span>
<span style="color: #ff00ff;">print     (\p) Print current command.</span>
<span style="color: #ff00ff;">prompt    (\R) Change your mysql prompt.</span>
<span style="color: #ff00ff;">quit      (\q) Quit mysql. &#36864;&#20986;</span>
<span style="color: #ff00ff;">rehash    (\#) Rebuild completion hash.</span>
<span style="color: #ff00ff;">source    (\.) Execute an SQL script file. Takes a file name as an argument. &#24341;&#29992;&#26412;&#22320;SQL&#33050;&#26412;</span>
<span style="color: #ff00ff;">status    (\s) Get status information from the server. &#29366;&#24577;</span>
<span style="color: #ff00ff;">system    (\!) Execute a system shell command.</span>
<span style="color: #ff00ff;">tee       (\T) Set outfile [to_outfile]. Append everything into given outfile.</span>
<span style="color: #ff00ff;">use       (\u) Use another database. Takes database name as argument.</span>
<span style="color: #ff00ff;">charset   (\C) Switch to another charset. Might be needed for processing binlog with multi-byte charsets.</span>
<span style="color: #ff00ff;">warnings  (\W) Show warnings after every statement.</span>
<span style="color: #ff00ff;">nowarning (\w) Don't show warnings after every statement.</span>
<span style="color: #ff00ff;">resetconnection(\x) Clean session context.</span>

<span style="color: #ff00ff;">For server side help, type 'help contents'</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-h:8b52f820-ca7e-4e49-9987-5e0d74c49bc4" class="outline-4">
<h4 id="h:8b52f820-ca7e-4e49-9987-5e0d74c49bc4">初始化脚本提高安全性</h4>
<div class="outline-text-4" id="text-h:8b52f820-ca7e-4e49-9987-5e0d74c49bc4">
<p>
运行脚本：mysql_secure_installation 
</p>

<p>
范例：运行安全加固脚本
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">mysql_secure_installation</span>
&#35774;&#32622;&#25968;&#25454;&#31649;&#29702;&#21592;root&#21475;&#20196;
&#31105;&#27490;root&#36828;&#31243;&#30331;&#24405;
&#21024;&#38500;anonymous&#29992;&#25143;&#24080;&#21495;
&#21024;&#38500;test&#25968;&#25454;&#24211;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:c1f1d240-4b0a-477f-8b00-6e705cd7c8af" class="outline-3">
<h3 id="h:c1f1d240-4b0a-477f-8b00-6e705cd7c8af">MySQL 组成</h3>
<div class="outline-text-3" id="text-h:c1f1d240-4b0a-477f-8b00-6e705cd7c8af">
</div>
<div id="outline-container-h:4f7f28c1-9aa7-4282-a4ba-81038fb0de29" class="outline-4">
<h4 id="h:4f7f28c1-9aa7-4282-a4ba-81038fb0de29">客户端程序</h4>
<div class="outline-text-4" id="text-h:4f7f28c1-9aa7-4282-a4ba-81038fb0de29">
<ul class="org-ul">
<li>mysql: 交互式的CLI工具</li>
<li>mysqldump：备份工具，基于mysql协议向mysqld发起查询请求，并将查得的所
有数据转换成insert等写操作语句保存文本文件中</li>
<li>mysqladmin：基于mysql协议管理mysqld</li>
<li>mysqlimport：数据导入工具</li>
<li>MyISAM存储引擎的管理工具：</li>
<li>myisamchk：检查MyISAM库</li>
<li>myisampack：打包MyISAM表，只读</li>
</ul>
</div>
</div>
<div id="outline-container-h:eec18cbb-916a-4f05-a505-16d98e150a82" class="outline-4">
<h4 id="h:eec18cbb-916a-4f05-a505-16d98e150a82">服务器端程序</h4>
<div class="outline-text-4" id="text-h:eec18cbb-916a-4f05-a505-16d98e150a82">
<ul class="org-ul">
<li>mysqld_safe</li>
<li>mysqld</li>
<li>mysqld_multi 多实例，示例：mysqld_multi &#x2013;example</li>
</ul>
</div>
</div>
<div id="outline-container-h:27efe8ff-50bd-48fd-b96d-b9f1a1cb934a" class="outline-4">
<h4 id="h:27efe8ff-50bd-48fd-b96d-b9f1a1cb934a">用户账号</h4>
<div class="outline-text-4" id="text-h:27efe8ff-50bd-48fd-b96d-b9f1a1cb934a">
<p>
mysql用户账号由两部分组成：
</p>

<div class="org-src-container">
<pre class="src src-she">'USERNAME'@'HOST'
</pre>
</div>

<p>
说明：
</p>
<ul class="org-ul">
<li>HOST限制此用户可通过哪些远程主机连接mysql服务器</li>
</ul>

<p>
支持使用通配符：
</p>
<div class="org-src-container">
<pre class="src src-sh">% &#21305;&#37197;&#20219;&#24847;&#38271;&#24230;&#30340;&#20219;&#24847;&#23383;&#31526;&#65292;&#30456;&#24403;&#20110;shell&#20013;&#30340;*&#12290;&#20363;&#65306;172.16.0.0/255.255.0.0 &#25110; 172.16.%.%
_ &#21305;&#37197;&#20219;&#24847;&#21333;&#20010;&#23383;&#31526;&#65292;&#30456;&#24403;&#20110;shell&#20013;&#30340;?
</pre>
</div>

<p>
范例：查询当前系统账号
</p>
<div class="org-src-container">
<pre class="src src-sh">&gt; selet user,host from mysql.user;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:daf8dbb2-08c8-4685-8b3f-e169f8b555df" class="outline-4">
<h4 id="h:daf8dbb2-08c8-4685-8b3f-e169f8b555df">mysql 命令</h4>
<div class="outline-text-4" id="text-h:daf8dbb2-08c8-4685-8b3f-e169f8b555df">
</div>
<div id="outline-container-h:d8e87d65-c69c-464b-9a3f-ebce3e6883dd" class="outline-5">
<h5 id="h:d8e87d65-c69c-464b-9a3f-ebce3e6883dd">mysql 运行命令类型</h5>
<div class="outline-text-5" id="text-h:d8e87d65-c69c-464b-9a3f-ebce3e6883dd">
<ul class="org-ul">
<li>客户端命令：本地执行，每个命令都完整形式和简写格式</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">mysql&gt; \h, help
mysql&gt; \u&#65292;use &#20999;&#25442;&#25968;&#25454;&#24211;
mysql&gt; \s&#65292;status
mysql&gt; <span style="color: #8b2252;">\!</span>&#65292;system
</pre>
</div>

<ul class="org-ul">
<li>服务端命令：通过mysql协议发往服务器执行并取回结果，命令末尾都必须使
用命令结束符号，默认为分号</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;</span>
mysql&gt;SELECT VERSION();
</pre>
</div>
</div>
</div>
<div id="outline-container-h:59c03c0d-7463-47cb-b641-211f42ae199f" class="outline-5">
<h5 id="h:59c03c0d-7463-47cb-b641-211f42ae199f">mysql使用模式</h5>
<div class="outline-text-5" id="text-h:59c03c0d-7463-47cb-b641-211f42ae199f">
<ul class="org-ul">
<li>交互式模式</li>
<li>脚本模式：</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">mysql &#8211;uUSERNAME -pPASSWORD &lt; /path/somefile.sql
cat /path/somefile.sql | mysql &#8211;uUSERNAME -pPASSWORD

mysql&gt;source /path/from/somefile.sql
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8e4feeb1-5f95-49e5-8a4b-dd812b3f77b1" class="outline-5">
<h5 id="h:8e4feeb1-5f95-49e5-8a4b-dd812b3f77b1">mysql命令使用格式</h5>
<div class="outline-text-5" id="text-h:8e4feeb1-5f95-49e5-8a4b-dd812b3f77b1">
<div class="org-src-container">
<pre class="src src-sh">mysql [OPTIONS] [database]
</pre>
</div>

<p>
mysql客户端常用选项：
</p>

<div class="org-src-container">
<pre class="src src-sh">-A, --no-auto-rehash &#31105;&#27490;&#34917;&#20840;
-u, --user= &#29992;&#25143;&#21517;,&#40664;&#35748;&#20026;root
-h, --host= &#26381;&#21153;&#22120;&#20027;&#26426;,&#40664;&#35748;&#20026;localhost
-p, --passowrd= &#29992;&#25143;&#23494;&#30721;,&#24314;&#35758;&#20351;&#29992;-p,&#40664;&#35748;&#20026;&#31354;&#23494;&#30721;
-P, --port= &#26381;&#21153;&#22120;&#31471;&#21475;
-S, --socket= &#25351;&#23450;&#36830;&#25509;socket&#25991;&#20214;&#36335;&#24452;
-D, --database= &#25351;&#23450;&#40664;&#35748;&#25968;&#25454;&#24211;
-C, --compress &#21551;&#29992;&#21387;&#32553;
-N  --skip-column-names &#20195;&#34920;&#19981;&#26174;&#31034;&#21015;&#21517;
-e &#8220;SQL&#8220; &#25191;&#34892;SQL&#21629;&#20196;
-V, --version &#26174;&#31034;&#29256;&#26412;
-v --verbose &#26174;&#31034;&#35814;&#32454;&#20449;&#24687;
--print-defaults &#33719;&#21462;&#31243;&#24207;&#40664;&#35748;&#20351;&#29992;&#30340;&#37197;&#32622;
</pre>
</div>

<p>
登录系统：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#31354;&#23494;&#30721;&#30331;&#24405;</span>
mysql &#8211;uroot &#8211;p
</pre>
</div>

<p>
运行mysql命令：
</p>

<div class="org-src-container">
<pre class="src src-sh">mysql&gt;use mysql                           <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20999;&#25442;&#21040;&#25968;&#25454;&#24211;</span>
mysql&gt;select user();                      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#29992;&#25143;</span>
mysql&gt;SELECT User,Host,Password FROM user;
&gt; system clear                                   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28165;&#23631;</span>
</pre>
</div>

<p>
范例：不显示列名
</p>
<div class="org-src-container">
<pre class="src src-sh">$ mysql -Ne <span style="color: #8b2252;">'select * from db1.student;'</span>
+----+--------+------+------+
| 10 |    tom |   22 |    M |
| 11 |      k |   30 |    F |
| 12 | jasper |   22 |    M |
| 13 |      q |   22 |    F |
+----+--------+------+------+
[jasper@c5 ~] eth0 = 10.0.4.12
$ mysql -e <span style="color: #8b2252;">'select * from db1.student;'</span>
+----+--------+------+--------+
| id | name   | age  | gender |
+----+--------+------+--------+
| 10 | tom    |   22 | M      |
| 11 | k      |   30 | F      |
| 12 | jasper |   22 | M      |
| 13 | q      |   22 | F      |
+----+--------+------+--------+
</pre>
</div>

<p>
范例：mysql的配置文件，修改提示符
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;mysql&#29256;&#26412;</span>
[root@centos8 ~]#mysql -V
mysql Ver 15.1 Distrib 10.3.11-MariaDB, for Linux (x86_64) using readline 5.1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20020;&#26102;&#20462;&#25913;mysql&#25552;&#31034;&#31526;</span>
[root@centos8 ~]#mysql -uroot -pcentos --prompt=<span style="color: #8b2252;">"\\r:\\m:\\s(\\u@\\h) [\\d]&gt;\\_"</span>
01:51:47(root@localhost) [(none)]&gt;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25345;&#20037;&#20462;&#25913;mysql&#25552;&#31034;&#31526;</span>
[root@centos8 ~]#vim /etc/my.cnf.d/mysql-clients.cnf
[mysql]
<span style="color: #a0522d;">prompt</span>=<span style="color: #8b2252;">"\\r:\\m:\\s(\\u@\\h) [\\d]&gt;\\_"</span>

[root@centos8 ~]#mysql --print-defaults -v
mysql would have been started with the following arguments:
--prompt=\r:\m:\s(\u@\h) [\d]&gt;<span style="color: #8b2252;">\_</span> -v

[root@centos8 ~]#mysql
10:29:30(root@localhost) [(none)]&gt; use mysql
Database changed
10:29:34(root@localhost) [mysql]&gt; exit
</pre>
</div>

<p>
范例：配置客户端mysql的自动登录
</p>

<div class="org-src-container">
<pre class="src src-sh">vim/etc/my.cnf.d/client.conf
[client]
<span style="color: #a0522d;">user</span>=wang
<span style="color: #a0522d;">password</span>=centos

[mysql]
<span style="color: #a0522d;">prompt</span>=(<span style="color: #8b2252;">\\</span>u@<span style="color: #8b2252;">\\</span>h) [<span style="color: #8b2252;">\\</span>d]&gt;<span style="color: #8b2252;">\\</span>_
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3540d1db-b2b2-4a5b-8bef-430698036761" class="outline-5">
<h5 id="h:3540d1db-b2b2-4a5b-8bef-430698036761">mysqladmin命令</h5>
<div class="outline-text-5" id="text-h:3540d1db-b2b2-4a5b-8bef-430698036761">
<p>
mysqladmin 命令格式
</p>

<div class="org-src-container">
<pre class="src src-sh">mysqladmin [OPTIONS] command command....
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;mysql&#26381;&#21153;&#26159;&#21542;&#27491;&#24120;&#65292;&#22914;&#26524;&#27491;&#24120;&#25552;&#31034;mysqld is alive</span>
mysqladmin -uroot -pcentos ping

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#38381;mysql&#26381;&#21153;&#65292;&#20294;mysqladmin&#21629;&#20196;&#26080;&#27861;&#24320;&#21551;</span>
mysqladmin &#8211;uroot &#8211;pcentos shutdown

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#25968;&#25454;&#24211;testdb</span>
mysqladmin -uroot &#8211;pcentos create testdb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#25968;&#25454;&#24211;testdb</span>
mysqladmin -uroot -pcentos drop testdb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;root&#23494;&#30721;</span>
mysqladmin &#8211;uroot &#8211;pcentos password <span style="color: #8b2252;">'xxx'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26085;&#24535;&#28378;&#21160;,&#29983;&#25104;&#26032;&#25991;&#20214;/var/lib/mysql/mariadb-bin.00000N</span>
mysqladmin -uroot -pcentos flush-logs
</pre>
</div>
</div>
</div>
<div id="outline-container-h:28aa0cd0-b012-4cf9-8382-47f28887f6af" class="outline-5">
<h5 id="h:28aa0cd0-b012-4cf9-8382-47f28887f6af">mycli</h5>
<div class="outline-text-5" id="text-h:28aa0cd0-b012-4cf9-8382-47f28887f6af">
<p>
MyCLI 是 MySQL，MariaDB和Percona的命令行界面，具有自动完成和语法突出显示功能
</p>

<p>
安装
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">centos8&#23433;&#35013;</span>
yum install python3-pip
pip3 install mycli

<span style="color: #b22222;">#</span><span style="color: #b22222;">ubuntu&#23433;&#35013;</span>
apt -y install mycli
</pre>
</div>

<p>
使用
</p>
<div class="org-src-container">
<pre class="src src-sh">mycli -uroot -S /var/lib/mysql/mysql.sock
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:1ca92f4b-640a-425a-b94e-fa3422c80231" class="outline-4">
<h4 id="h:1ca92f4b-640a-425a-b94e-fa3422c80231">服务器端配置</h4>
<div class="outline-text-4" id="text-h:1ca92f4b-640a-425a-b94e-fa3422c80231">
</div>
<div id="outline-container-h:943837cf-472a-4195-8406-62914bc5ee54" class="outline-5">
<h5 id="h:943837cf-472a-4195-8406-62914bc5ee54">服务器端配置文件</h5>
<div class="outline-text-5" id="text-h:943837cf-472a-4195-8406-62914bc5ee54">
<p>
服务器端(mysqld)：工作特性有多种配置方式
</p>

<ul class="org-ul">
<li>命令行选项:</li>
<li>配置文件：类ini格式,集中式的配置，能够为mysql的各应用程序提供配置信息</li>
</ul>

<p>
服务器端配置文件：
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/my.cnf       <span style="color: #b22222;">#</span><span style="color: #b22222;">Global&#36873;&#39033;</span>
/etc/mysql/my.cnf <span style="color: #b22222;">#</span><span style="color: #b22222;">Global&#36873;&#39033;</span>
~/.my.cnf         <span style="color: #b22222;">#</span><span style="color: #b22222;">User-specific &#36873;&#39033;</span>
</pre>
</div>

<p>
配置文件格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">[mysqld]
[mysqld_safe]
[mysqld_multi]
[mysql]
[mysqldump]
[server]
[client]
</pre>
</div>

<p>
格式：parameter = value
</p>

<p>
说明：
</p>
<div class="org-src-container">
<pre class="src src-sh">_&#21644;- &#30456;&#21516;
1&#65292;ON&#65292;TRUE&#24847;&#20041;&#30456;&#21516;&#65292; 0&#65292;OFF&#65292;FALSE&#24847;&#20041;&#30456;&#21516;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d85ee8a6-9786-407d-8b10-fadcfcc21588" class="outline-5">
<h5 id="h:d85ee8a6-9786-407d-8b10-fadcfcc21588">socket 连接说明</h5>
<div class="outline-text-5" id="text-h:d85ee8a6-9786-407d-8b10-fadcfcc21588">
<p>
官方说明：<a href="https://dev.mysql.com/doc/mysql-port-reference/en/mysql-ports-reference-tables.html#mysql-client-server-ports">https://dev.mysql.com/doc/mysql-port-reference/en/mysql-ports-reference-tables.html#mysql-client-server-ports</a>
</p>

<p>
服务器监听的两种socket地址：
</p>
<ul class="org-ul">
<li>ip socket: 监听在tcp的3306端口，支持远程通信，侦听3306/tcp端口可以在
绑定有一个或全部接口IP上</li>
<li>unix sock: 监听在sock文件上，仅支持本机通信，如：
/var/lib/mysql/mysql.sock。说明：host为localhost 时自动使用unix sock</li>
</ul>

<p>
范例：MySQL的端口
</p>
<div class="org-src-container">
<pre class="src src-sh">&gt; show variables like <span style="color: #8b2252;">'port'</span>;

<span style="color: #b22222;"># </span><span style="color: #b22222;">MySQL8.0&#22686;&#21152;&#20102;&#19968;&#20010;33060/tcp&#31471;&#21475;</span>

&gt; show avriables lik <span style="color: #8b2252;">'mysqlx_port'</span> 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:21f87e86-83e9-4311-910a-4a31b8c27877" class="outline-5">
<h5 id="h:21f87e86-83e9-4311-910a-4a31b8c27877">关闭mysqld网络连接</h5>
<div class="outline-text-5" id="text-h:21f87e86-83e9-4311-910a-4a31b8c27877">
<p>
只侦听本地客户端，所有客户端和服务器的交互都通过一个socket文件实现，
socket的配置存放在/var/lib/mysql/mysql.sock），可在/etc/my.cnf修改
</p>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">vim /etc/my.cnf
[mysqld]
skip-networking=1
<span style="color: #a0522d;">bind_address</span>=127.0.0.1
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:46e883ed-908e-457e-91fa-fec70297785b" class="outline-3">
<h3 id="h:46e883ed-908e-457e-91fa-fec70297785b">通用二进制格式安装MySQL</h3>
<div class="outline-text-3" id="text-h:46e883ed-908e-457e-91fa-fec70297785b">
</div>
<div id="outline-container-h:d8b6b6d5-10fd-4b0d-9267-231713fe4c02" class="outline-4">
<h4 id="h:d8b6b6d5-10fd-4b0d-9267-231713fe4c02">通用二进制格式安装 MySQL5.6</h4>
<div class="outline-text-4" id="text-h:d8b6b6d5-10fd-4b0d-9267-231713fe4c02">
<p>
下载地址：<a href="https://downloads.mysql.com/archives/community/">https://downloads.mysql.com/archives/community/</a>
</p>

<p>
Product Version: 5.7.41
</p>

<p>
Operating System:Linux - Generic
</p>

<p>
OS Version: Linux - Generic (glibc 2.12) (x86, 64-bit)
</p>


<p>
<b>准备用户</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">groupadd -r -g 306 mysql
useradd -r -g 306 -u 306 -d /data/mysql mysql  <span style="color: #b22222;"># </span><span style="color: #b22222;">-r &#31995;&#32479;&#29992;&#25143;&#65292;&#20182;&#30340;&#23478;&#30446;&#24405;&#38656;&#35201;&#25552;&#21069;&#25163;&#21160;&#21019;&#24314;</span>
</pre>
</div>

<p>
<b>准备数据目录，建议使用逻辑卷</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#36873;&#20570;&#65292;&#21518;&#38754;&#30340;&#33050;&#26412;mysql_install_db&#21487;&#33258;&#21160;&#29983;&#25104;&#27492;&#30446;&#24405;</span>
mkdir /data/mysql
chown mysql:mysql /data/mysql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;&#20108;&#65306;&#36923;&#36753;&#21367;</span>
fdisk /dev/sda
yum install -y lvm2  
pvcreate /dev/sda6
vgcreate vg0 /dev/sda6
lvcreate -n mysql -l 100%free vg0
mkfs.ext4 /dev/vg0/mysql <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#25991;&#20214;&#31995;&#32479;</span>
vim /etc/fstab <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;&#25991;&#20214;&#65292;&#24320;&#26426;&#33258;&#21160;&#25346;&#36733;</span>
mount -a  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20840;&#37096;&#25346;&#36733;</span>
df -h       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#35748;&#25346;&#36733;&#26159;&#21542;&#25104;&#21151;</span>
</pre>
</div>

<p>
<b>准备二进制程序</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24102;&#26377;linux&#26159;&#32534;&#35793;&#22909;&#30340;&#65292;&#36335;&#24452;&#24050;&#32463;&#25351;&#23450;</span>
tar xf mariadb-VERSION-linux-x86_64.tar.gz -C /usr/local
<span style="color: #483d8b;">cd</span> /usr/local
ln -sv mariadb-VERSION mysql
chown -R root:root /usr/local/mysql/
</pre>
</div>

<p>
<b>准备配置文件</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /usr/local/mysql
cp -b support-files/my-large.cnf /etc/my.cnf
vim /etc/my.cnf
<span style="color: #b22222;">#</span><span style="color: #b22222;">mysql&#35821;&#21477;&#22359;&#20013;&#28155;&#21152;&#20197;&#19979;&#19977;&#20010;&#36873;&#39033;</span>
[mysqld]
datadir = /data/mysql       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#20301;&#32622;</span>
innodb_file_per_table = on  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;mariadb5.5&#20197;&#19978;&#29256;&#30340;&#26159;&#40664;&#35748;&#20540;&#65292;&#21487;&#19981;&#21152;</span>
skip_name_resolve = on      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#27490;&#20027;&#26426;&#21517;&#35299;&#26512;&#65292;&#24314;&#35758;&#20351;&#29992;</span>
</pre>
</div>

<p>
<b>创建数据库文件</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /usr/local/mysql/
./scripts/mysql_install_db --datadir=/data/mysql --user=mysql

[root@centos8 mysql]#ls /data/mysql/ -l
total 110604
-rw-rw---- 1 mysql mysql 12582912 Jun 1 16:44 ibdata1
-rw-rw---- 1 mysql mysql 50331648 Jun 1 16:44 ib_logfile0
-rw-rw---- 1 mysql mysql 50331648 Jun 1 16:44 ib_logfile1
drwx------ 2 mysql mysql 4096 Jun 1 16:44 mysql
drwx------ 2 mysql mysql 4096 Jun 1 16:44 performance_schema
drwx------ 2 mysql mysql 4096 Jun 1 16:44 test
</pre>
</div>

<p>
<b>准备服务脚本，并启动服务</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">cp ./support-files/mysql.server /etc/rc.d/init.d/mysqld
chkconfig --add mysqld
service mysqld start

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#26377;&#23545;&#24212;&#30340;service &#25991;&#20214;&#21487;&#20197;&#25191;&#34892;&#19979;&#38754;</span>
cp support-files/systemd/mariadb.service /usr/lib/systemd/system/
systemctl daemon-reload
systemctl enable --now mariadb
</pre>
</div>

<p>
<b>PATH路径</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'PATH=/user/local/mysql/bin:$PATH'</span> &gt; /etc/profile.d/mysql.sh
<span style="color: #483d8b;">.</span> /etc/profile.d/mysql.sh
</pre>
</div>

<p>
<b>安全初始化</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">/user/local/mysql/bin/mysql_secure_installation
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0719ce3f-bc78-41de-9c38-d978bbe0ad65" class="outline-4">
<h4 id="h:0719ce3f-bc78-41de-9c38-d978bbe0ad65">实战案例：一键安装mysql-5.6二进制包的脚本</h4>
<div class="outline-text-4" id="text-h:0719ce3f-bc78-41de-9c38-d978bbe0ad65">
<p>
范例：离线安装mysql5.6二进制包的脚本
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">vim mysql-install.sh</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #a0522d;">DIR</span>=<span style="color: #ff00ff;">`pwd`</span>
<span style="color: #a0522d;">NAME</span>=<span style="color: #8b2252;">"mysql-5.6.34-linux-glibc2.5-x86_64.tar.gz"</span>
<span style="color: #a0522d;">FULL_NAME</span>=${<span style="color: #a0522d;">DIR</span>}/${<span style="color: #a0522d;">NAME</span>}
<span style="color: #a0522d;">DATA_DIR</span>=<span style="color: #8b2252;">"/data/mysql"</span>

yum install libaio perl-Data-Dumper vim gcc gcc-c++ wget autoconf net-tools lrzsz -y
yum install curl policycoreutils openssh-server openssh-clients postfix -y

<span style="color: #a020f0;">if</span> [ -f ${<span style="color: #a0522d;">FULL_NAME</span>} ];<span style="color: #a020f0;">then</span>
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&#23433;&#35013;&#25991;&#20214;&#23384;&#22312;"</span>
<span style="color: #a020f0;">else</span>
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&#23433;&#35013;&#25991;&#20214;&#19981;&#23384;&#22312;"</span>
    <span style="color: #a020f0;">exit</span> 3
<span style="color: #a020f0;">fi</span>
<span style="color: #a020f0;">if</span> [ -h /usr/local/mysql ];<span style="color: #a020f0;">then</span>
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"Mysql &#24050;&#32463;&#23433;&#35013;"</span>
    <span style="color: #a020f0;">exit</span> 3
<span style="color: #a020f0;">else</span>
    tar xvf ${<span style="color: #a0522d;">FULL_NAME</span>} -C /usr/local/src
    ln -sv /usr/local/src/mysql-5.6.34-linux-glibc2.5-x86_64 /usr/local/mysql
    <span style="color: #a020f0;">if</span> id mysql;<span style="color: #a020f0;">then</span>
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"mysql &#29992;&#25143;&#24050;&#32463;&#23384;&#22312;&#65292;&#36339;&#36807;&#21019;&#24314;&#29992;&#25143;&#36807;&#31243;"</span>
    <span style="color: #a020f0;">else</span>
        useradd -r -s /sbin/nologin mysql
    <span style="color: #a020f0;">fi</span>

    <span style="color: #a020f0;">if</span> id mysql;<span style="color: #a020f0;">then</span>
        chown -R mysql.mysql /usr/local/mysql/*
        <span style="color: #a020f0;">if</span> [ ! -d /data/mysql ];<span style="color: #a020f0;">then</span>
            mkdir -pv /data/mysql &amp;&amp; chown -R mysql.mysql /data
            /usr/local/mysql/scripts/mysql_install_db --user=mysql --datadir=/data/mysql --basedir=/usr/local/mysql/
            cp /usr/local/src/mysql-5.6.34-linux-glibc2.5-x86_64/support-files/mysql.server /etc/init.d/mysqld
            chmod a+x /etc/init.d/mysqld
            cp ${<span style="color: #a0522d;">DIR</span>}/my.cnf /etc/my.cnf
            ln -sv /usr/local/mysql/bin/mysql /usr/bin/mysql 
            /etc/init.d/mysqld start
            chkconfig --add mysqld
        <span style="color: #a020f0;">else</span>
            <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"MySQL&#25968;&#25454;&#30446;&#24405;&#24050;&#32463;&#23384;&#22312;,"</span>
            <span style="color: #a020f0;">exit</span> 3
        <span style="color: #a020f0;">fi</span>
    <span style="color: #a020f0;">fi</span>
<span style="color: #a020f0;">fi</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">my.cnf</span>
[mysqld]
<span style="color: #a0522d;">socket</span>=/var/lib/mysql/mysql.sock
<span style="color: #a0522d;">user</span>=mysql
symbolic-links=0
<span style="color: #a0522d;">datadir</span>=/data/mysql
<span style="color: #a0522d;">innodb_file_per_table</span>=1

[client]
<span style="color: #a0522d;">port</span>=3306
<span style="color: #a0522d;">socket</span>=/var/lib/mysql/mysql.sock

[mysqld_safe]
log-error=/var/log/mysqld.log
pid-file=/tmp/mysql.pid
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f0b5c3a8-7083-4b6e-aad7-fd86923f0e1f" class="outline-4">
<h4 id="h:f0b5c3a8-7083-4b6e-aad7-fd86923f0e1f">实战案例：通用二进制安装MySQL5.7和MySQL8.0</h4>
<div class="outline-text-4" id="text-h:f0b5c3a8-7083-4b6e-aad7-fd86923f0e1f">
<p>
<b>安装相关包</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">yum -y install libaio numactl-libs
</pre>
</div>

<p>
<b>用户和组</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">groupadd mysql
useradd -r -g mysql -s /bin/false mysql
</pre>
</div>

<p>
<b>准备程序文件</b>
</p>

<p>
<a href="https://repo.huaweicloud.com/mysql/Downloads/MySQL-5.7/mysql-5.7.33-linux-glibc2.12-x86_64.tar">https://repo.huaweicloud.com/mysql/Downloads/MySQL-5.7/mysql-5.7.33-linux-glibc2.12-x86_64.tar</a>
</p>
<div class="org-src-container">
<pre class="src src-sh">wget 
tar xf mysql-5.7.29-linux-glibc2.12-x86_64.tar.gz &#8211;C /usr/local
<span style="color: #483d8b;">cd</span> /usr/local/
ln -s mysql-5.7.29-linux-glibc2.12-x86_64/ mysql
chown -R root.root /usr/local/mysql/
</pre>
</div>

<p>
<b>准备环境变量</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'PATH=/usr/local/mysql/bin:$PATH'</span> &gt; /etc/profile.d/mysql.sh
<span style="color: #483d8b;">.</span> /etc/profile.d/mysql.sh
</pre>
</div>

<p>
<b>准备配置文件</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">cp /etc/my.cnf{,.bak}
vim /etc/my.cnf
[mysqld]
<span style="color: #a0522d;">datadir</span>=/data/mysql
<span style="color: #a0522d;">skip_name_resolve</span>=1
<span style="color: #a0522d;">socket</span>=/data/mysql/mysql.sock
log-error=/data/mysql/mysql.log
pid-file=/data/mysql/mysql.pid
[client]
<span style="color: #a0522d;">socket</span>=/data/mysql/mysql.sock
</pre>
</div>

<p>
<b>生成数据库文件,并提取root密码</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#24335;1 &#29983;&#25104;&#38543;&#26426;&#23494;&#30721;</span>
mysqld --initialize --user=mysql --datadir=/data/mysql
...&#30465;&#30053;...
2019-07-04T13:03:54.258140Z 1 [Note] A temporary password is generated for
root@localhost: LufavlMka6,! <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#29983;&#25104;root&#30340;&#21021;&#22987;&#23494;&#30721;</span>

grep password /data/mysql/mysql.log
2019-12-26T13:31:30.458826Z 1 [Note] A temporary password is generated for
root@localhost: LufavlMka6,!
awk <span style="color: #8b2252;">'/temporary password/{print $NF}'</span> /data/mysql/mysql.log
LufavlMka6,!

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#24335;2 &#29983;&#25104;root&#31354;&#23494;&#30721;</span>
mysqld --initialize-insecure --user=mysql --datadir=/data/mysql
</pre>
</div>

<p>
<b>准备服务脚本和启动</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
chkconfig --add mysqld
service mysqld start

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25110;</span>
cp support-files/systemd/mariadb.service /usr/lib/systemd/system/
systemctl daemon-reload
systemctl enable --now mariadb
</pre>
</div>

<p>
<b>修改口令</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#21069;&#38754;&#29983;&#25104;&#30340;&#38543;&#26426;&#23494;&#30721;</span>
mysqladmin -uroot -p<span style="color: #8b2252;">'LufavlMka6,!'</span> password xxx

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#21069;&#38754;&#29983;&#25104;&#30340;&#31354;&#23494;&#30721;</span>
mysqladmin -uroot password xxx
</pre>
</div>

<p>
<b>测试登录</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">mysql -uroot -pxxx
</pre>
</div>

<p>
8.0
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /usr/local/src/
wget https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.42-linux-glibc2.28-aarch64.tar.xz
yum install libncurses* -y
tar -xf mysql-8.0.42-linux-glibc2.28-aarch64.tar.xz

groupadd mysql
useradd -r -g mysql -s /bin/false mysql
mkdir /data/mysql/{data,log/{binlog,slow,relaylog},startsql} -p
touch /data/mysql/log/mysql_error.log
mkdir /var/lib/mysql

mv mysql-8.0.42-linux-glibc2.28-aarch64 /usr/local/mysql
chown -R mysql:mysql /data/mysql* /var/lib/mysql*
mkdir /data/mysql/tmp
chown -R mysql:mysql /data/mysql* /var/lib/mysql*


vi /etc/my.cnf
/usr/local/mysql/bin/mysqld --initialize --user=mysql --datadir=/data/mysql/data --basedir=/usr/local/mysql --port=3306

cat /data/mysql/log/error.log|grep <span style="color: #8b2252;">"temporary password"</span>

cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
/usr/local/mysql/bin/mysqld_safe --defaults-file=/etc/my.cnf --user=mysql &amp;

mysql -uroot -p -S /var/lib/mysql/mysqld.sock

mysql -uroot -p -S /var/lib/mysql/mysqld.sock &lt; /tmp/all.sql 
mysqldump -udev_user -h abcip -p --single-transaction --master-data=2 --set-gtid-purged=OFF -E -R --triggers --databases game_user_center a_b a_c a_d &gt; /tmp/all.sql
</pre>
</div>
</div>
</div>
<div id="outline-container-h:22c4c8d6-4b3c-414c-8012-b35085ba2624" class="outline-4">
<h4 id="h:22c4c8d6-4b3c-414c-8012-b35085ba2624">实战案例：一键安装MySQL5.7和MySQL8.0二进制包的脚本</h4>
<div class="outline-text-4" id="text-h:22c4c8d6-4b3c-414c-8012-b35085ba2624">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/</span><span style="color: #a020f0;">bash</span>
<span style="color: #483d8b;">.</span> /etc/init.d/functions
<span style="color: #a0522d;">SRC_DIR</span>=<span style="color: #ff00ff;">`pwd`</span>
<span style="color: #a0522d;">MYSQL</span>=<span style="color: #8b2252;">'mysql-5.7.29-linux-glibc2.12-x86_64.tar.gz'</span>
<span style="color: #a0522d;">COLOR</span>=<span style="color: #8b2252;">'echo -e \E[01;31m'</span>
<span style="color: #a0522d;">END</span>=<span style="color: #8b2252;">'\E[0m'</span>
<span style="color: #a0522d;">MYSQL_ROOT_PASSWORD</span>=xxx

<span style="color: #0000ff;">check</span> (){

<span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">UID</span> -ne 0 ]; <span style="color: #a020f0;">then</span>
    action <span style="color: #8b2252;">"&#24403;&#21069;&#29992;&#25143;&#19981;&#26159;root,&#23433;&#35013;&#22833;&#36133;"</span> false
    <span style="color: #a020f0;">exit</span> 1
<span style="color: #a020f0;">fi</span>

<span style="color: #483d8b;">cd</span> $<span style="color: #a0522d;">SRC_DIR</span>
<span style="color: #a020f0;">if</span> [ ! -e $<span style="color: #a0522d;">MYSQL</span> ];<span style="color: #a020f0;">then</span>
    $<span style="color: #a0522d;">COLOR</span><span style="color: #8b2252;">"&#32570;&#23569;${MYSQL}&#25991;&#20214;"</span>$<span style="color: #a0522d;">END</span>
    $<span style="color: #a0522d;">COLOR</span><span style="color: #8b2252;">"&#35831;&#23558;&#30456;&#20851;&#36719;&#20214;&#25918;&#22312;${SRC_DIR}&#30446;&#24405;&#19979;"</span>$<span style="color: #a0522d;">END</span>
    <span style="color: #a020f0;">exit</span>
<span style="color: #a020f0;">elif</span> [ -e /usr/local/mysql ];<span style="color: #a020f0;">then</span>
    action <span style="color: #8b2252;">"&#25968;&#25454;&#24211;&#24050;&#23384;&#22312;&#65292;&#23433;&#35013;&#22833;&#36133;"</span> false
    <span style="color: #a020f0;">exit</span>
<span style="color: #a020f0;">else</span>
    <span style="color: #a020f0;">return</span>
<span style="color: #a020f0;">fi</span>
}

<span style="color: #0000ff;">install_mysql</span>(){
    $<span style="color: #a0522d;">COLOR</span><span style="color: #8b2252;">"&#24320;&#22987;&#23433;&#35013;MySQL&#25968;&#25454;&#24211;..."</span>$<span style="color: #a0522d;">END</span>
    yum -y -q install libaio numactl-libs ncurses-compat-libs libncurses.so.5 &amp;&gt; /dev/null
    <span style="color: #483d8b;">cd</span> $<span style="color: #a0522d;">SRC_DIR</span>
    tar xf $<span style="color: #a0522d;">MYSQL</span> -C /usr/local/
    <span style="color: #a0522d;">MYSQL_DIR</span>=<span style="color: #ff00ff;">`echo $MYSQL| sed -nr 's/^(.*[0-9]).*/\1/p'`</span>
    ln -s /usr/local/$<span style="color: #a0522d;">MYSQL_DIR</span> /usr/local/mysql
    chown -R root.root /usr/local/mysql/
    id mysql &amp;&gt; /dev/null || { useradd -s /sbin/nologin -r mysql ; action <span style="color: #8b2252;">"&#21019;&#24314;mysql&#29992;&#25143;"</span>; }

    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'PATH=/usr/local/mysql/bin/:$PATH'</span> &gt; /etc/profile.d/mysql.sh
    <span style="color: #483d8b;">.</span> /etc/profile.d/mysql.sh
    cat &gt; /etc/my.cnf &lt;&lt;EOF
<span style="color: #ffa54f;">[mysqld]</span>
<span style="color: #ffa54f;">server-id=1</span>
<span style="color: #ffa54f;">log-bin</span>
<span style="color: #ffa54f;">datadir=/data/mysql</span>
<span style="color: #ffa54f;">socket=/data/mysql/mysql.sock</span>
<span style="color: #ffa54f;">log-error=/data/mysql/mysql.log</span>
<span style="color: #ffa54f;">pid-file=/data/mysql/mysql.pid</span>
<span style="color: #ffa54f;">[client]</span>
<span style="color: #ffa54f;">socket=/data/mysql/mysql.sock</span>
<span style="color: #ffa54f;">EOF</span>
    mysqld --initialize --user=mysql --datadir=/data/mysql
    cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
    chkconfig --add mysqld
    chkconfig mysqld on
    service mysqld start
    [ $<span style="color: #a0522d;">?</span> -ne 0 ] &amp;&amp; { $<span style="color: #a0522d;">COLOR</span><span style="color: #8b2252;">"&#25968;&#25454;&#24211;&#21551;&#21160;&#22833;&#36133;&#65292;&#36864;&#20986;!"</span>$<span style="color: #a0522d;">END</span>;<span style="color: #a020f0;">exit</span>; }
    <span style="color: #a0522d;">MYSQL_OLDPASSWORD</span>=<span style="color: #ff00ff;">`awk '/A temporary password/{print $NF}' /data/mysql/mysql.log`</span>
    mysqladmin -uroot -p$<span style="color: #a0522d;">MYSQL_OLDPASSWORD</span> password $<span style="color: #a0522d;">MYSQL_ROOT_PASSWORD</span> &amp;&gt;/dev/null
    action <span style="color: #8b2252;">"&#25968;&#25454;&#24211;&#23433;&#35013;&#23436;&#25104;"</span>
}

check
install_mysql
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:8ed018ee-1edb-47fd-8677-0782933d364b" class="outline-3">
<h3 id="h:8ed018ee-1edb-47fd-8677-0782933d364b">源码编译安装MySQL</h3>
<div class="outline-text-3" id="text-h:8ed018ee-1edb-47fd-8677-0782933d364b">
<p>
<b>建议：内存4G以上</b>
</p>

<p>
<b>安装相关依赖包</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">yum -y install bison bison-devel zlib-devel libcurl-devel libarchive-devel boost-devel gcc gcc-c++ cmake ncurses-devel gnutls-devel libxml2-devel openssl-devel libevent-devel libaio-devel
</pre>
</div>

<p>
<b>做准备用户和数据目录</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">useradd -r -s /sbin/nologin -d /data/mysql mysql
</pre>
</div>

<p>
<b>准备数据库目录</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir /data/mysql
chown mysql.mysql /data/mysql
</pre>
</div>

<p>
<b>源码编译安装</b>
</p>

<p>
编译安装说明
</p>

<p>
利用cmake编译,而利用传统方法，cmake的重要特性之一是其独立于源码
(out-of-source)的编译功能，即编译工作可以在另一个指定的目录中而非源码
目录中进行，这可以保证源码目录不受任何一次编译的影响，因此在同一个源码
树上可以进行多次不同的编译，如针对于不同平台编译
</p>

<p>
编译选项:<a href="https://dev.mysql.com/doc/refman/5.7/en/source-configuration-options.html">https://dev.mysql.com/doc/refman/5.7/en/source-configuration-options.html</a>
</p>

<p>
<b>下载并解压缩源码包</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">tar xvf mariadb-10.2.18.tar.gz -C /usr/local/src
<span style="color: #b22222;">#</span><span style="color: #b22222;">mysql-5.6.51.tar.gz</span>
</pre>
</div>

<p>
<b>源码编译安装mariadb</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> mariadb-10.2.18/
cmake . <span style="color: #8b2252;">\</span>
-DCMAKE_INSTALL_PREFIX=/apps/mysql <span style="color: #8b2252;">\</span>
-DMYSQL_DATADIR=/data/mysql/ <span style="color: #8b2252;">\</span>
-DSYSCONFDIR=/etc/ <span style="color: #8b2252;">\</span>
-DMYSQL_USER=mysql <span style="color: #8b2252;">\</span>
-DWITH_INNOBASE_STORAGE_ENGINE=1 <span style="color: #8b2252;">\</span>
-DWITH_ARCHIVE_STORAGE_ENGINE=1 <span style="color: #8b2252;">\</span>
-DWITH_BLACKHOLE_STORAGE_ENGINE=1 <span style="color: #8b2252;">\</span>
-DWITH_PARTITION_STORAGE_ENGINE=1 <span style="color: #8b2252;">\</span>
-DWITHOUT_MROONGA_STORAGE_ENGINE=1 <span style="color: #8b2252;">\</span>
-DWITH_DEBUG=0 <span style="color: #8b2252;">\</span>
-DWITH_READLINE=1 <span style="color: #8b2252;">\</span>
-DWITH_SSL=system <span style="color: #8b2252;">\</span>
-DWITH_ZLIB=system <span style="color: #8b2252;">\</span>
-DWITH_LIBWRAP=0 <span style="color: #8b2252;">\</span>
-DENABLED_LOCAL_INFILE=1 <span style="color: #8b2252;">\</span>
-DMYSQL_UNIX_ADDR=/data/mysql/mysql.sock <span style="color: #8b2252;">\</span>
-DDEFAULT_CHARSET=utf8 <span style="color: #8b2252;">\</span>
-DDEFAULT_COLLATION=utf8_general_ci

make &amp;&amp; make install

<span style="color: #b22222;">#</span><span style="color: #b22222;">make -e 16 &amp;&amp; make install # &#24182;&#34892;16&#26680;&#32534;&#35793;</span>
</pre>
</div>

<p>
提示：如果出错，执行`rm -f CMakeCache.txt`
</p>

<p>
<b>准备环境变量</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'PATH=/apps/mysql/bin:$PATH'</span> &gt; /etc/profile.d/mysql.sh
<span style="color: #483d8b;">.</span> /etc/profile.d/mysql.sh
</pre>
</div>

<p>
<b>生成数据库文件</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /apps/mysql/
scripts/mysql_install_db --datadir=/data/mysql/ --user=mysql
</pre>
</div>

<p>
<b>准备配置文件</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#38024;&#23545;&#32769;&#29256;&#26412;&#25110;mariadb-10.2.18</span>
cp /apps/mysql/support-files/my-huge.cnf /etc/my.cnf

<span style="color: #b22222;">#</span><span style="color: #b22222;">mysql5.7</span>
cp -b /apps/mysql/support-files/my-default.cnf /etc/my.cnf
</pre>
</div>

<p>
<b>准备启动脚本,并启动服务</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">cp /app/mysql/support-files/mysql.server /etc/init.d/mysqld
chkconfig --add mysqld
service mysqld start
</pre>
</div>

<p>
<b>安全初始化</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">mysql_secure_installation
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b3ae154c-2cbc-43b7-bb1f-92c97801550d" class="outline-3">
<h3 id="h:b3ae154c-2cbc-43b7-bb1f-92c97801550d">基于docker容器创建MySQL</h3>
<div class="outline-text-3" id="text-h:b3ae154c-2cbc-43b7-bb1f-92c97801550d">
<div class="org-src-container">
<pre class="src src-sh">docker run -d  --name mysql -e <span style="color: #a0522d;">MYSQL_ROOT_PASSWORD</span>=123456 -p 3306:3306 mysql
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-shell">mkdir -p /data/mysql/data

cat /data/mysql/my.cnf
<span style="color: #b22222;">#</span><span style="color: #b22222;">For advice on how to change settings please see</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">http://dev.mysql.com/doc/refman/5.6/en/server-configuration-defaults.html</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">*** DO NOT EDIT THIS FILE. It's a template which will be copied to the</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">*** default location during install, and will be replaced if you</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">*** upgrade to a newer version of MySQL.</span>

[mysqld]
<span style="color: #b22222;">#</span><span style="color: #b22222;">basedir=/var/lib/mysql</span>
<span style="color: #a0522d;">datadir</span>=/var/lib/mysql
<span style="color: #b22222;">#</span><span style="color: #b22222;">socket=/var/lib/mysql/tmp/mysql.sock</span>
<span style="color: #a0522d;">socket</span>=/var/run/mysqld/mysqld.sock
secure-file-priv=/var/lib/mysql-files
<span style="color: #a0522d;">user</span>=mysql
<span style="color: #b22222;">#</span><span style="color: #b22222;">tmpdir=/tmp</span>
<span style="color: #a0522d;">max_connections</span>=2000
character-set-server=utf8
<span style="color: #b22222;">#</span><span style="color: #b22222;">sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span>
<span style="color: #a0522d;">lower_case_table_names</span>=1
skip-name-resolve
<span style="color: #a0522d;">max_connections</span>=3000
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#26381;&#21153;&#31471;&#20351;&#29992;&#30340;&#23383;&#31526;&#38598;&#40664;&#35748;&#20026;8&#27604;&#29305;&#32534;&#30721;&#30340;latin1&#23383;&#31526;&#38598;</span>
character-set-server=utf8mb4
<span style="color: #b22222;">## </span><span style="color: #b22222;">&#21019;&#24314;&#26032;&#34920;&#26102;&#23558;&#20351;&#29992;&#30340;&#40664;&#35748;&#23384;&#20648;&#24341;&#25806;</span>
default-storage-engine=INNODB
<span style="color: #b22222;">#</span><span style="color: #b22222;">lower_case_table_name=1</span>
<span style="color: #a0522d;">max_allowed_packet</span>=1024M
<span style="color: #a0522d;">max_length_for_sort_data</span>=838860
<span style="color: #a0522d;">group_concat_max_len</span>=1844674407370954752
<span style="color: #a0522d;">query_cache_type</span>=1
<span style="color: #a0522d;">loose_max_statement_time</span>=3000000
<span style="color: #a0522d;">table_open_cache</span>=4096
<span style="color: #a0522d;">max_connect_errors</span>=100000
<span style="color: #a0522d;">sort_buffer_size</span>=3M
<span style="color: #a0522d;">join_buffer_size</span>=3M
<span style="color: #a0522d;">log_bin_trust_function_creators</span>=1
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#24930;&#26085;&#24535;</span>
<span style="color: #a0522d;">log_output</span>=file
<span style="color: #a0522d;">slow_query_log</span>=on
slow_query_log_file = /var/lib/mysql/mysql-slow.log
<span style="color: #a0522d;">log_queries_not_using_indexes</span>=on
long_query_time = 1
sql_mode = <span style="color: #8b2252;">"ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Remove leading # and set to the amount of RAM for the most important data</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">innodb_buffer_pool_size = 128M</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Remove leading # to turn on a very important data integrity option: logging</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">changes to the binary log between backups.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">log_bin</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">These are commonly set, remove the # and set as required.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">basedir = .....</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">datadir = .....</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">port = .....</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">server_id = .....</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">socket = .....</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Remove leading # to set options mainly useful for reporting servers.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">The server defaults are faster for transactions and fast SELECTs.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Adjust sizes as needed, experiment to find the optimal values.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">join_buffer_size = 128M</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">sort_buffer_size = 2M</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">read_rnd_buffer_size = 2M</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES</span>
[mysqld_safe]
log-error=/var/lib/mysql/error.log
pid-file=/var/lib/mysql/mysql.pid
[mysqldump]
<span style="color: #a0522d;">user</span>=root
<span style="color: #a0522d;">password</span>=VW4rbQfLTn


cat /data/mysql/start.sh
docker run -d -p 3306:3306 --restart always -v /data/mysql/data:/var/lib/mysql -v /data/mysql/my.cnf:/etc/my.cnf -e <span style="color: #8b2252;">"MYSQL_ROOT_PASSWORD=VW4rbQfLTn"</span> -e <span style="color: #8b2252;">"TZ=Asia/Shanghai"</span> --name mysql mysql:5.7

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160;</span>
bash /data/mysql/start.sh
</pre>
</div>
</div>
<div id="outline-container-h:192e9a09-8724-4642-b654-ca7a06e5094e" class="outline-4">
<h4 id="h:192e9a09-8724-4642-b654-ca7a06e5094e">docker-compose</h4>
<div class="outline-text-4" id="text-h:192e9a09-8724-4642-b654-ca7a06e5094e">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#30446;&#24405;</span>
$ mkdir -p /data/mysql

<span style="color: #b22222;"># </span><span style="color: #b22222;">mysql&#37197;&#32622;&#25991;&#20214;</span>
cat &lt;&lt; EOF &gt; my.cnf
<span style="color: #ffa54f;">#For advice on how to change settings please see</span>
<span style="color: #ffa54f;"># http://dev.mysql.com/doc/refman/5.6/en/server-configuration-defaults.html</span>
<span style="color: #ffa54f;"># *** DO NOT EDIT THIS FILE. It's a template which will be copied to the</span>
<span style="color: #ffa54f;"># *** default location during install, and will be replaced if you</span>
<span style="color: #ffa54f;"># *** upgrade to a newer version of MySQL.</span>

<span style="color: #ffa54f;">[mysqld]</span>
<span style="color: #ffa54f;">basedir=/var/lib/mysql</span>
<span style="color: #ffa54f;">datadir=/var/lib/mysql</span>
<span style="color: #ffa54f;">socket=/var/lib/mysql/tmp/mysql.sock</span>
<span style="color: #ffa54f;">user=mysql</span>
<span style="color: #ffa54f;">tmpdir=/tmp</span>
<span style="color: #ffa54f;">max_connections=200</span>
<span style="color: #ffa54f;">character-set-server=utf8</span>
<span style="color: #ffa54f;">#sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span>
<span style="color: #ffa54f;">max_connections=100</span>
<span style="color: #ffa54f;">character-set-server=utf8</span>
<span style="color: #ffa54f;">lower_case_table_names=1</span>
<span style="color: #ffa54f;">skip-name-resolve</span>
<span style="color: #ffa54f;">max_connections=3000</span>
<span style="color: #ffa54f;">## &#26381;&#21153;&#31471;&#20351;&#29992;&#30340;&#23383;&#31526;&#38598;&#40664;&#35748;&#20026;8&#27604;&#29305;&#32534;&#30721;&#30340;latin1&#23383;&#31526;&#38598;</span>
<span style="color: #ffa54f;">character-set-server=utf8mb4</span>
<span style="color: #ffa54f;">## &#21019;&#24314;&#26032;&#34920;&#26102;&#23558;&#20351;&#29992;&#30340;&#40664;&#35748;&#23384;&#20648;&#24341;&#25806;</span>
<span style="color: #ffa54f;">default-storage-engine=INNODB</span>
<span style="color: #ffa54f;">#lower_case_table_name=1</span>
<span style="color: #ffa54f;">max_allowed_packet=1024M</span>
<span style="color: #ffa54f;">max_length_for_sort_data=838860</span>
<span style="color: #ffa54f;">group_concat_max_len=1844674407370954752</span>
<span style="color: #ffa54f;">query_cache_type=1</span>
<span style="color: #ffa54f;">loose_max_statement_time=3000000</span>
<span style="color: #ffa54f;">table_open_cache=4096</span>
<span style="color: #ffa54f;">max_connect_errors=100000</span>
<span style="color: #ffa54f;">sort_buffer_size=3M</span>
<span style="color: #ffa54f;">join_buffer_size=3M</span>
<span style="color: #ffa54f;">log_bin_trust_function_creators=1</span>
<span style="color: #ffa54f;">#&#24320;&#21551;&#24930;&#26085;&#24535;</span>
<span style="color: #ffa54f;">log_output=file</span>
<span style="color: #ffa54f;">slow_query_log=on</span>
<span style="color: #ffa54f;">slow_query_log_file = /var/lib/mysql/mysql-slow.log</span>
<span style="color: #ffa54f;">log_queries_not_using_indexes=on</span>
<span style="color: #ffa54f;">long_query_time = 1</span>
<span style="color: #ffa54f;">sql_mode = "ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,ALLOW_INVALID_DATES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"</span>

<span style="color: #ffa54f;"># Remove leading # and set to the amount of RAM for the most important data</span>
<span style="color: #ffa54f;"># cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.</span>
<span style="color: #ffa54f;"># innodb_buffer_pool_size = 128M</span>

<span style="color: #ffa54f;"># Remove leading # to turn on a very important data integrity option: logging</span>
<span style="color: #ffa54f;"># changes to the binary log between backups.</span>
<span style="color: #ffa54f;"># log_bin</span>

<span style="color: #ffa54f;"># These are commonly set, remove the # and set as required.</span>
<span style="color: #ffa54f;"># basedir = .....</span>
<span style="color: #ffa54f;"># datadir = .....</span>
<span style="color: #ffa54f;"># port = .....</span>
<span style="color: #ffa54f;"># server_id = .....</span>
<span style="color: #ffa54f;"># socket = .....</span>

<span style="color: #ffa54f;"># Remove leading # to set options mainly useful for reporting servers.</span>
<span style="color: #ffa54f;"># The server defaults are faster for transactions and fast SELECTs.</span>
<span style="color: #ffa54f;"># Adjust sizes as needed, experiment to find the optimal values.</span>
<span style="color: #ffa54f;"># join_buffer_size = 128M</span>
<span style="color: #ffa54f;"># sort_buffer_size = 2M</span>
<span style="color: #ffa54f;"># read_rnd_buffer_size = 2M</span>

<span style="color: #ffa54f;">#sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES</span>
<span style="color: #ffa54f;">[mysqld_safe]</span>
<span style="color: #ffa54f;">log-error=/var/lib/mysql/error.log</span>
<span style="color: #ffa54f;">pid-file=/var/lib/mysql/mysql.pid</span>
<span style="color: #ffa54f;">[mysqldump]</span>
<span style="color: #ffa54f;">user=root</span>
<span style="color: #ffa54f;">password=123</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">mysql docker-compose</span>
$ cat &lt;&lt; EOF &gt; /data/mysql/mysql-single.yaml
<span style="color: #ffa54f;">version: "3.5"</span>
<span style="color: #ffa54f;">services:</span>
<span style="color: #ffa54f;">  db:</span>
<span style="color: #ffa54f;">    image: mysql:5.7</span>
<span style="color: #ffa54f;">    container_name: mysql</span>
<span style="color: #ffa54f;">    hostname: mysql</span>
<span style="color: #ffa54f;">    volumes:</span>
<span style="color: #ffa54f;">      - ./data:/var/lib/mysql</span>
<span style="color: #ffa54f;">      - ./my.cnf:/etc/my.cnf</span>
<span style="color: #ffa54f;">    restart: always</span>
<span style="color: #ffa54f;">    ports:</span>
<span style="color: #ffa54f;">      - "3306:3306"</span>
<span style="color: #ffa54f;">    environment:</span>
<span style="color: #ffa54f;">      - MYSQL_ROOT_PASSWORD=123</span>
<span style="color: #ffa54f;">      - TZ=Asia/Shanghai</span>
<span style="color: #ffa54f;">    networks:</span>
<span style="color: #ffa54f;">      mysql:</span>
<span style="color: #ffa54f;">        aliases:</span>
<span style="color: #ffa54f;">          - db</span>

<span style="color: #ffa54f;">networks:</span>
<span style="color: #ffa54f;">  mysql:</span>
<span style="color: #ffa54f;">    name: mysql</span>
<span style="color: #ffa54f;">    driver: bridge</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160; mysql</span>
$ docker-compose -f /data/mysql/mysql-single.yaml up -d
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:336e7d0a-4c7f-4596-b71e-730a8fd6cb6c" class="outline-3">
<h3 id="h:336e7d0a-4c7f-4596-b71e-730a8fd6cb6c">MySQL多实例</h3>
<div class="outline-text-3" id="text-h:336e7d0a-4c7f-4596-b71e-730a8fd6cb6c">
</div>
<div id="outline-container-h:d6ac88f6-7b2a-4864-b37b-10c6f1edbe78" class="outline-4">
<h4 id="h:d6ac88f6-7b2a-4864-b37b-10c6f1edbe78">多实例介绍</h4>
<div class="outline-text-4" id="text-h:d6ac88f6-7b2a-4864-b37b-10c6f1edbe78">
<p>
什么是数据库多实例
</p>
<ul class="org-ul">
<li>MySQL多实例就是在一台服务器上同时开启多个不同的服务端口（如：3306、
3307等），同时运行多个MySQL服务进程，这些服务进程通过不同的Socket监
听不同的服务端口来提供服务。多实例可能是MySQL的不同版本,也可能是
MySQL的同一版本实现</li>
</ul>

<p>
多实例的好处
</p>
<ul class="org-ul">
<li>可有效利用服务器资源。当单个服务器资源有剩余时，可以充分利用剩余资源
提供更多的服务，且可以实现资源的逻辑隔离节约服务器资源。例如公司服务
器资源紧张，但是数据库又需要各自尽量独立的提供服务，并且还需要到主从
复制等技术，多实例就是最佳选择</li>
</ul>

<p>
多实例弊端
</p>
<ul class="org-ul">
<li>存在资源互相抢占的问题。比如：当某个数据库实例并发很高或者SQL查询慢
时，整个实例会消耗大量的CPU、磁盘I/O等资源，导致服务器上面其他的数据
库实例在提供服务的质量也会下降,所以具体的需求要根据自己的实际情况而
定。</li>
</ul>
</div>
</div>
<div id="outline-container-h:57de1e17-b55c-4f27-90e1-6d6a7ea19aa6" class="outline-4">
<h4 id="h:57de1e17-b55c-4f27-90e1-6d6a7ea19aa6">多实例常见的配置方案</h4>
<div class="outline-text-4" id="text-h:57de1e17-b55c-4f27-90e1-6d6a7ea19aa6">
<ul class="org-ul">
<li>单一的配置文件、单一启动程序多实例部署方式
<ul class="org-ul">
<li>MySQL官方文档提到的单一配置文件、单一启动程序多实例部署方式</li>
<li>耦合度太高，一个配置文件不好管理。不是很推荐</li>
</ul></li>

<li>多配置文件、多启动程序部署方式
<ul class="org-ul">
<li>多配置文件、多启动程序部署方式是针对每个实例都有独立的配置文件和目
录，管理灵活，此方案耦合度较低</li>
<li>工作开发和运维的统一原则：降低耦合度。所以建议此方式</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:eb0466be-7f8f-49cf-a7c4-576109eaef22" class="outline-4">
<h4 id="h:eb0466be-7f8f-49cf-a7c4-576109eaef22">实战案例：CentOS 8实现MySQL的多实例</h4>
<div class="outline-text-4" id="text-h:eb0466be-7f8f-49cf-a7c4-576109eaef22">
<p>
<b>实验目的</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">CentOS 8 yum&#23433;&#35013;mariadb-10.3.17&#24182;&#23454;&#29616;&#19977;&#20010;&#23454;&#20363;
</pre>
</div>

<p>
<b>环境要求</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">&#19968;&#21488;&#31995;&#32479;CentOS 8.X&#20027;&#26426;
</pre>
</div>

<p>
<b>前提准备</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">&#20851;&#38381;SElinux
&#20851;&#38381;&#38450;&#28779;&#22681;
&#26102;&#38388;&#21516;&#27493;
</pre>
</div>

<p>
<b>实现步骤</b>
</p>

<p>
安装mariadb
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum install mariadb-server
</pre>
</div>

<p>
准备三个实例的目录
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mkdir -pv
/mysql/{3306,3307,3308}/{data,etc,socket,log,bin,pid}
[root@centos8 ~]#chown -R mysql.mysql /mysql
[root@centos8 ~]#tree -d /mysql/
/mysql/
&#9500;&#9472;&#9472; 3306
&#9474;   &#9500;&#9472;&#9472; bin
&#9474;   &#9500;&#9472;&#9472; data
&#9474;   &#9500;&#9472;&#9472; etc
&#9474;   &#9500;&#9472;&#9472; log
&#9474;   &#9500;&#9472;&#9472; pid
&#9474;   &#9492;&#9472;&#9472; socket
&#9500;&#9472;&#9472; 3307
&#9474;   &#9500;&#9472;&#9472; bin
&#9474;   &#9500;&#9472;&#9472; data
&#9474;   &#9500;&#9472;&#9472; etc
&#9474;   &#9500;&#9472;&#9472; log
&#9474;   &#9500;&#9472;&#9472; pid
&#9474;   &#9492;&#9472;&#9472; socket
&#9492;&#9472;&#9472; 3308
    &#9500;&#9472;&#9472; bin
    &#9500;&#9472;&#9472; data
    &#9500;&#9472;&#9472; etc
    &#9500;&#9472;&#9472; log
    &#9500;&#9472;&#9472; pid
    &#9492;&#9472;&#9472; socket

21 directories
</pre>
</div>

<p>
生成数据库文件
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mysql_install_db --datadir=/mysql/3306/data --user=mysql
[root@centos8 ~]#mysql_install_db --datadir=/mysql/3307/data --user=mysql
[root@centos8 ~]#mysql_install_db --datadir=/mysql/3308/data --user=mysql
</pre>
</div>

<p>
准备配置文件
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /mysql/3306/etc/my.cnf
[mysqld]
<span style="color: #a0522d;">port</span>=3306
<span style="color: #a0522d;">datadir</span>=/mysql/3306/data
<span style="color: #a0522d;">socket</span>=/mysql/3306/socket/mysql.sock
log-error=/mysql/3306/log/mysql.log
pid-file=/mysql/3306/pid/mysql.pid

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#22797;&#19978;&#38754;&#27493;&#39588;&#35774;&#32622;3307&#65292;3308</span>
sed <span style="color: #8b2252;">'s/3306/3307/'</span> /mysql/3306/etc/my.cnf &gt; /mysql/3307/etc/my.cnf
sed <span style="color: #8b2252;">'s/3306/3308/'</span> /mysql/3306/etc/my.cnf &gt; /mysql/3308/etc/my.cnf
</pre>
</div>

<p>
准备启动脚本
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /mysql/3306/bin/mysqld
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #a0522d;">port</span>=3306
<span style="color: #a0522d;">mysql_user</span>=<span style="color: #8b2252;">"root"</span>
<span style="color: #a0522d;">mysql_pwd</span>=<span style="color: #8b2252;">"xxx"</span>
<span style="color: #a0522d;">cmd_path</span>=<span style="color: #8b2252;">"/usr/bin"</span>
<span style="color: #a0522d;">mysql_basedir</span>=<span style="color: #8b2252;">"/mysql"</span>
<span style="color: #a0522d;">mysql_sock</span>=<span style="color: #8b2252;">"${mysql_basedir}/${port}/socket/mysql.sock"</span>

<span style="color: #0000ff;">function_start_mysql</span>()
{
    <span style="color: #a020f0;">if</span> [ ! -e <span style="color: #8b2252;">"$mysql_sock"</span> ];<span style="color: #a020f0;">then</span>
        <span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">"Starting MySQL...\n"</span>
        ${<span style="color: #a0522d;">cmd_path</span>}/mysqld_safe --defaults-file=${<span style="color: #a0522d;">mysql_basedir</span>}/${<span style="color: #a0522d;">port</span>}/etc/my.cnf &amp;&gt; /dev/null &amp;
    <span style="color: #a020f0;">else</span>
        <span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">"MySQL is running...\n"</span>
        <span style="color: #a020f0;">exit</span>
    <span style="color: #a020f0;">fi</span>
}

<span style="color: #0000ff;">function_stop_mysql</span>()
{
    <span style="color: #a020f0;">if</span> [ ! -e <span style="color: #8b2252;">"$mysql_sock"</span> ];<span style="color: #a020f0;">then</span>
        <span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">"MySQL is stopped...\n"</span>
        <span style="color: #a020f0;">exit</span>
    <span style="color: #a020f0;">else</span>
        <span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">"Stoping MySQL...\n"</span>
        ${<span style="color: #a0522d;">cmd_path</span>}/mysqladmin -u ${<span style="color: #a0522d;">mysql_user</span>} -p${<span style="color: #a0522d;">mysql_pwd</span>} -S ${<span style="color: #a0522d;">mysql_sock</span>} shutdown
    <span style="color: #a020f0;">fi</span>
}

<span style="color: #0000ff;">function_restart_mysql</span>()
{
    <span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">"Restarting MySQL...\n"</span>
    function_stop_mysql
    sleep 2
    function_start_mysql
}

<span style="color: #a020f0;">case</span> $<span style="color: #a0522d;">1</span><span style="color: #a020f0;"> in</span>
start)
    function_start_mysql
    ;;
stop)
    function_stop_mysql
    ;;
restart)
    function_restart_mysql
    ;;
*)
    <span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">"Usage: ${mysql_basedir}/${port}/bin/mysqld {start|stop|restart}\n"</span>
<span style="color: #a020f0;">esac</span>

[root@centos8 ~]#chmod +x /mysql/3306/bin/mysqld

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#22797;&#19978;&#36848;&#36807;&#31243;&#65292;&#20998;&#21035;&#24314;&#31435;3307&#65292;3308&#30340;&#21551;&#21160;&#33050;&#26412;</span>
sed <span style="color: #8b2252;">'s/3306/3307/'</span> /mysql/3306/bin/mysqld &gt;/mysql/3307/bin/mysqld
sed <span style="color: #8b2252;">'s/3306/3308/'</span> /mysql/3306/bin/mysqld &gt;/mysql/3308/bin/mysqld
</pre>
</div>

<p>
启动服务
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#/mysql/3306/bin/mysqld start
[root@centos8 ~]#/mysql/3307/bin/mysqld start
[root@centos8 ~]#/mysql/3308/bin/mysqld start
[root@centos8 ~]#ss -ntl
State      Recv-Q       Send-Q              Local Address:Port             Peer Address:Port             
LISTEN     0            128                       0.0.0.0:22                    0.0.0.0:*               
LISTEN     0            128                          [::]:22                       [::]:*         
LISTEN     0            80                              *:3306                        *:*         
LISTEN     0            80                              *:3307                        *:*             
LISTEN     0            80                              *:3308                        *:* 
</pre>
</div>

<p>
<b>登录实例</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#/mysql/3308/bin/mysqld start
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20004;&#31181;&#36830;&#25509;&#26041;&#27861;</span>
[root@centos8 ~]#mysql -h127.0.0.1 -P3308
[root@centos8 ~]#mysql -uroot -S /mysqldb/3306/socket/mysql.sock
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#35748;&#36830;&#25509;&#30340;&#31471;&#21475;</span>
MariaDB [(none)]&gt; show variables like <span style="color: #8b2252;">'port'</span>;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| port          | 3306  |
+---------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [(none)]&gt; 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#38381;&#25968;&#25454;&#24211;&#65292;&#38656;&#35201;&#25163;&#21160;&#36755;&#20837;root&#30340;&#23494;&#30721;</span>
[root@centos8 ~]#/mysql/3308/bin/mysqld stop
Stoping MySQL...
Enter password:
[root@centos8 ~]#/mysql/3308/bin/mysqld start
Starting MySQL...
</pre>
</div>

<p>
<b>修改root密码</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#19978;root&#30340;&#21475;&#20196;</span>
[root@centos8 ~]#mysqladmin -uroot -S /mysql/3306/socket/mysql.sock password <span style="color: #8b2252;">'xxx'</span>
[root@centos8 ~]#mysqladmin -uroot -S /mysql/3307/socket/mysql.sock password <span style="color: #8b2252;">'xxx'</span>
[root@centos8 ~]#mysqladmin -uroot -S /mysql/3308/socket/mysql.sock password <span style="color: #8b2252;">'xxx'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#30331;&#24405;mysql,&#25191;&#34892;&#19979;&#38754;&#20063;&#21487;&#20197;</span>
Mariadb&gt;update mysql.user set <span style="color: #a0522d;">password</span>=password(&#8220;centos&#8221;) where <span style="color: #a0522d;">user</span>=<span style="color: #8b2252;">'root'</span>;
Mariadb&gt;flush privileges;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#22797;&#27493;&#39588;&#65292;&#20998;&#21035;&#20462;&#25913;&#21035;&#22806;&#20004;&#20010;&#23454;&#20363;3307&#65292;3308&#23545;&#24212;root&#21475;&#20196;</span>
</pre>
</div>

<p>
<b>测试连接</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mysql -uroot -p -S /mysql/3306/socket/mysql.sock <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#31034;&#36755;&#20837;&#21475;&#20196;&#25165;&#33021;&#30331;&#24405;</span>
</pre>
</div>

<p>
<b>开机启动</b>
</p>
<div class="org-src-container">
<pre class="src src-sh">vim /etc/rc.d/rc.local
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26368;&#21518;&#28155;&#21152;&#19979;&#38754;&#20869;&#23481;</span>
<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> {3306..3308};<span style="color: #a020f0;">do</span> /mysql/$<span style="color: #a0522d;">i</span>/bin/mysqld start; <span style="color: #a020f0;">done</span>

chmod +x /etc/rc.d/rc.local
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3fa1b332-9977-4cb0-b5cd-cd8221ca9419" class="outline-4">
<h4 id="h:3fa1b332-9977-4cb0-b5cd-cd8221ca9419">实战案例：CentOS 7 实现MySQL的多实例</h4>
<div class="outline-text-4" id="text-h:3fa1b332-9977-4cb0-b5cd-cd8221ca9419">
<p>
<b>实验目的</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">CentOS 7.7 yum&#23433;&#35013;mariadb&#24182;&#23454;&#29616;&#19977;&#20010;&#23454;&#20363;
</pre>
</div>

<p>
<b>环境要求</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">&#19968;&#21488;&#20027;&#26426;
&#31995;&#32479;&#65306;CentOS 7.X
</pre>
</div>

<p>
<b>前提准备</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">&#20851;&#38381;SElinux
&#20851;&#38381;&#38450;&#28779;&#22681;
&#26102;&#38388;&#21516;&#27493;
</pre>
</div>

<p>
<b>实现步骤</b>
</p>

<p>
安装mariadb
</p>

<div class="org-src-container">
<pre class="src src-sh">yum install mariadb-server
Systemctl start mariadb
</pre>
</div>

<p>
准备三个实例的目录
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir -pv /mysql/{3306,3307,3308}/{data,etc,socket,log,bin,pid}
chown -R mysql.mysql /mysql
</pre>
</div>

<p>
生成数据库文件
</p>
<div class="org-src-container">
<pre class="src src-sh">mysql_install_db --datadir=/mysql/3306/data --user=mysql
mysql_install_db --datadir=/mysql/3307/data --user=mysql
mysql_install_db --datadir=/mysql/3308/data --user=mysql
</pre>
</div>

<p>
准备启动脚本
</p>

<div class="org-src-container">
<pre class="src src-sh">cp /etc/my.cnf /mysql/3306/etc/
vim /mysql/3306/etc/my.cnf
[mysqld]
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#27492;&#34892;&#65292;&#22914;&#26524;port&#26159;3306&#21487;&#30465;&#30053;&#27492;&#34892;</span>
<span style="color: #a0522d;">port</span>=3306
<span style="color: #a0522d;">datadir</span>=/mysql/3306/data/
<span style="color: #a0522d;">socket</span>=/mysql/3306/socket/mysql.sock
[mysqld_safe]
log-error=/mysql/3306/log/mariadb.log
pid-file=/mysql/3306/pid/mariadb.pid
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#22797;&#19978;&#38754;&#27493;&#39588;&#35774;&#32622;3307&#65292;3308</span>
</pre>
</div>

<p>
准备配置文件
</p>

<div class="org-src-container">
<pre class="src src-sh">vim /mysql/3306/bin/mysqld
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #a0522d;">port</span>=3306
<span style="color: #a0522d;">mysql_user</span>=<span style="color: #8b2252;">"root"</span>
<span style="color: #a0522d;">mysql_pwd</span>=<span style="color: #8b2252;">"xxx"</span>
<span style="color: #a0522d;">cmd_path</span>=<span style="color: #8b2252;">"/usr/bin"</span>
<span style="color: #a0522d;">mysql_basedir</span>=<span style="color: #8b2252;">"/mysql"</span>
<span style="color: #a0522d;">mysql_sock</span>=<span style="color: #8b2252;">"${mysql_basedir}/${port}/socket/mysql.sock"</span>

<span style="color: #0000ff;">function_start_mysql</span>()
{
    <span style="color: #a020f0;">if</span> [ ! -e <span style="color: #8b2252;">"$mysql_sock"</span> ];<span style="color: #a020f0;">then</span>
        <span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">"Starting MySQL...\n"</span>
        ${<span style="color: #a0522d;">cmd_path</span>}/mysqld_safe --defaults-file=${<span style="color: #a0522d;">mysql_basedir</span>}/${<span style="color: #a0522d;">port</span>}/etc/my.cnf &amp;&gt; /dev/null &amp;
    <span style="color: #a020f0;">else</span>
        <span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">"MySQL is running...\n"</span>
        <span style="color: #a020f0;">exit</span>
    <span style="color: #a020f0;">fi</span>
}

<span style="color: #0000ff;">function_stop_mysql</span>()
{
    <span style="color: #a020f0;">if</span> [ ! -e <span style="color: #8b2252;">"$mysql_sock"</span> ];<span style="color: #a020f0;">then</span>
        <span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">"MySQL is stopped...\n"</span>
        <span style="color: #a020f0;">exit</span>
    <span style="color: #a020f0;">else</span>
        <span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">"Stoping MySQL...\n"</span>
        ${<span style="color: #a0522d;">cmd_path</span>}/mysqladmin -u ${<span style="color: #a0522d;">mysql_user</span>} -p${<span style="color: #a0522d;">mysql_pwd</span>} -S ${<span style="color: #a0522d;">mysql_sock</span>} shutdown
    <span style="color: #a020f0;">fi</span>
}

<span style="color: #0000ff;">function_restart_mysql</span>()
{
    <span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">"Restarting MySQL...\n"</span>
    function_stop_mysql
    sleep 2
    function_start_mysql
}

<span style="color: #a020f0;">case</span> $<span style="color: #a0522d;">1</span><span style="color: #a020f0;"> in</span>
start)
    function_start_mysql
    ;;
stop)
    function_stop_mysql
    ;;
restart)
    function_restart_mysql
    ;;
*)
    <span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">"Usage: ${mysql_basedir}/${port}/bin/mysqld {start|stop|restart}\n"</span>
<span style="color: #a020f0;">esac</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#22797;&#19978;&#36848;&#36807;&#31243;&#65292;&#20998;&#21035;&#24314;&#31435;3307&#65292;3308&#30340;&#21551;&#21160;&#33050;&#26412;</span>
</pre>
</div>

<p>
启动关闭服务
</p>

<div class="org-src-container">
<pre class="src src-sh">/mysql/3306/bin/mysqld start
/mysql/3307/bin/mysqld start
/mysql/3308/bin/mysqld start
</pre>
</div>

<p>
登录实例
</p>

<div class="org-src-container">
<pre class="src src-sh">/mysql/3306/bin/mysqld start
mysql -uroot -S /mysql/3306/socket/mysql.sock
mariadb&gt;show variables like <span style="color: #8b2252;">'port'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#35748;&#36830;&#25509;&#30340;&#31471;&#21475;</span>
</pre>
</div>

<p>
修改root密码
</p>

<div class="org-src-container">
<pre class="src src-sh">mysqladmin -uroot -S /mysql/3306/socket/mysql.sock password <span style="color: #8b2252;">'xxx'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#19978;&#26032;&#21475;&#20196;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#30331;&#24405;mysql,&#25191;&#34892;&#19979;&#38754;&#20063;&#21487;&#20197;</span>
Mariadb&gt;update mysql.user set <span style="color: #a0522d;">password</span>=password(&#8220;centos&#8221;) where <span style="color: #a0522d;">user</span>=<span style="color: #8b2252;">'root'</span>;
Mariadb&gt;flush privileges;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#22797;&#27493;&#39588;&#65292;&#20998;&#21035;&#20462;&#25913;&#21035;&#22806;&#20004;&#20010;&#23454;&#20363;3307&#65292;3308&#23545;&#24212;root&#21475;&#20196;</span>
</pre>
</div>

<p>
测试连接
</p>

<div class="org-src-container">
<pre class="src src-sh">mysql -uroot -S /mysql/3306/socket/mysql.sock &#8211;p <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#31034;&#36755;&#20837;&#21475;&#20196;&#25165;&#33021;&#30331;&#24405;</span>
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:44a7af11-fb8e-40e2-ba0f-79f048edafb1" class="outline-2">
<h2 id="h:44a7af11-fb8e-40e2-ba0f-79f048edafb1">SQL语言</h2>
<div class="outline-text-2" id="text-h:44a7af11-fb8e-40e2-ba0f-79f048edafb1">
</div>
<div id="outline-container-h:974e902c-0026-41ff-9533-f1410f9d5e1b" class="outline-3">
<h3 id="h:974e902c-0026-41ff-9533-f1410f9d5e1b">关系型数据库的常见组件</h3>
<div class="outline-text-3" id="text-h:974e902c-0026-41ff-9533-f1410f9d5e1b">
<ul class="org-ul">
<li>数据库：database</li>
<li>表：table，行：row 列：column</li>
<li>索引：index</li>
<li>视图：view</li>
<li>用户：user</li>
<li>权限：privilege</li>
<li>存储过程：procedure</li>
<li>存储函数：function</li>
<li>触发器：trigger</li>
<li>事件调度器：event scheduler，任务计划</li>
</ul>
</div>
</div>
<div id="outline-container-h:24ad07b3-9c08-49c5-b323-d20c3ac20091" class="outline-3">
<h3 id="h:24ad07b3-9c08-49c5-b323-d20c3ac20091">SQL语言的兴起与语法标准</h3>
<div class="outline-text-3" id="text-h:24ad07b3-9c08-49c5-b323-d20c3ac20091">
<p>
20世纪70年代，IBM开发出SQL，用于DB2
</p>

<p>
1981年，IBM推出SQL/DS数据库
</p>

<p>
业内标准微软和Sybase的T-SQL，Oracle的PL/SQL
</p>

<p>
SQL作为关系型数据库所使用的标准语言，最初是基于IBM的实现在1986年被批准
的。1987年，国际标准化组织(ISO)把ANSI(美国国家标准化组织) SQL作为国际
标准
</p>

<p>
SQL：ANSI SQL，SQL-1986, SQL-1989, SQL-1992, SQL-1999, SQL-2003，SQL-2008, SQL-2011
</p>
</div>
<div id="outline-container-h:d8408bc0-933d-479e-9c2f-33915b9fb35d" class="outline-4">
<h4 id="h:d8408bc0-933d-479e-9c2f-33915b9fb35d">SQL语言规范</h4>
<div class="outline-text-4" id="text-h:d8408bc0-933d-479e-9c2f-33915b9fb35d">
<ul class="org-ul">
<li>在数据库系统中，SQL语句不区分大小写，建议用大写</li>
<li>SQL语句可单行或多行书写，以“;”结尾</li>
<li>关键词不能跨多行或简写</li>
<li>用空格和缩进来提高语句的可读性</li>
<li>子句通常位于独立行，便于编辑，提高可读性</li>
</ul>
</div>
<div id="outline-container-h:f2ea4919-8354-400b-a3f2-8aa60ac5fa07" class="outline-5">
<h5 id="h:f2ea4919-8354-400b-a3f2-8aa60ac5fa07">注释</h5>
<div class="outline-text-5" id="text-h:f2ea4919-8354-400b-a3f2-8aa60ac5fa07">
<p>
官方参考：<a href="https://dev.mysql.com/doc/refman/8.4/en/comments.html">https://dev.mysql.com/doc/refman/8.4/en/comments.html</a>
</p>

<p>
MySQL 服务器支持三种注释风格：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21333;&#34892;&#27880;&#37322;&#20869;&#23481;&#12290;</span>
-- &#27880;&#37322;&#20869;&#23481;&#12290;&#31532;&#20108;&#20010;&#30772;&#25240;&#21495;&#21518;&#33267;&#23569;&#26377;&#19968;&#20010;&#31354;&#30333;&#25110;&#25511;&#21046;&#23383;&#31526;&#65292;&#20363;&#22914;&#31354;&#26684;&#25110;&#21046;&#34920;&#31526;
/*&#27880;&#37322;&#20869;&#23481;*/ &#31867;&#20284;&#20110; C &#35821;&#35328;&#12290;&#36825;&#31181;&#35821;&#27861;&#20801;&#35768;&#27880;&#37322;&#36328;&#36234;&#22810;&#34892;
</pre>
</div>

<p>
内联注释
</p>
<pre class="example" id="orgc175511">
/*!MySQL-specific */
只有MySQL能识别它是注释，但不具备注释的语义。
!字符后添加一个版本号，则只有当 MySQL 版本大于或等于指定的版本号时，才执行注释内的语法。
</pre>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #a020f0;">SELECT</span> 1+1;     #comment 
mysql&gt; <span style="color: #a020f0;">SELECT</span> 1+1;     <span style="color: #b22222;">-- </span><span style="color: #b22222;">comment</span>
mysql&gt; <span style="color: #a020f0;">SELECT</span> 1 <span style="color: #b22222;">/*comment*/</span> + 1;
mysql&gt; <span style="color: #a020f0;">SELECT</span> 1+
<span style="color: #b22222;">/*</span>
<span style="color: #b22222;">this is a</span>
<span style="color: #b22222;">multiple-line comment</span>
<span style="color: #b22222;">*/</span>
1;

<span style="color: #b22222;">/*!select*/</span> 1;
<span style="color: #b22222;">/*!50110 select*/</span> 1;  #MySQL 5.1.10 &#25110;&#26356;&#39640;&#29256;&#26412;
</pre>
</div>



<div class="org-src-container">
<pre class="src src-sh">mysql&gt; select 1+1--1;  <span style="color: #b22222;">#</span><span style="color: #b22222;">--1&#27809;&#26377;&#34987;&#35782;&#21035;&#20026;&#27880;&#37322;&#65292;&#32780;&#26159;&#34987;&#35299;&#37322;&#20026;&#20943;&#36127;1 &#21363;1+1-(-1)</span>
+--------+
| 1+1--1 |
+--------+
|      3 |
+--------+
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)

mysql&gt; select 1+1--<span style="color: #8b2252;">'a'</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">--'a'&#34987;&#35782;&#21035;&#20026;&#27880;&#37322;&#65292;&#22240;&#20026;--&#21518;&#38754;&#36319;&#30528;&#38750;&#25968;&#23383;&#23383;&#31526;</span>
+----------+
| 1+1--<span style="color: #8b2252;">'a'</span> |
+----------+
|        2 |
+----------+
mysql&gt;  SELECT 1 /**/ + 1--<span style="color: #8b2252;">'s'</span>+<span style="color: #8b2252;">'2'</span>/*!+1*/;
+-----------------------+
| 1 /**/ + 1--<span style="color: #8b2252;">'s'</span>+<span style="color: #8b2252;">'2'</span>+1 |
+-----------------------+
|                     5 |
+-----------------------+
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:f20a66ab-3544-49f3-84ce-766c701da20c" class="outline-4">
<h4 id="h:f20a66ab-3544-49f3-84ce-766c701da20c">数据库对象和命名</h4>
<div class="outline-text-4" id="text-h:f20a66ab-3544-49f3-84ce-766c701da20c">
<p>
数据库的组件(对象)：
</p>
<ul class="org-ul">
<li>数据库、表、索引、视图、用户、存储过程、函数、触发器、事件调度器等</li>
</ul>

<p>
命名规则：
</p>
<ul class="org-ul">
<li>必须以字母开头，可包括数字和三个特殊字符`# _ $`</li>
<li>不要使用MySQL的保留字</li>
<li>同一database(Schema)下的对象不能同名</li>
</ul>
</div>
</div>
<div id="outline-container-h:1a48785f-7064-40c3-9941-2fd86c7fc8c1" class="outline-4">
<h4 id="h:1a48785f-7064-40c3-9941-2fd86c7fc8c1">SQL语句分类</h4>
<div class="outline-text-4" id="text-h:1a48785f-7064-40c3-9941-2fd86c7fc8c1">
<ul class="org-ul">
<li>DDL: Data Defination Language 数据定义语言，定义或修改数据库对象（如表、索引、视图等）的结构。关键字：
<ul class="org-ul">
<li>CREATE（创建数据库或表）</li>
<li>ALTER（修改表结构）</li>
<li>DROP（删除数据库或表）</li>
<li>TRUNCATE（快速清空表数据并重置结构）</li>
</ul></li>

<li>DML: Data Manipulation Language 数据操纵语言，对表中的数据进行增、删、改操作。关键字：
<ul class="org-ul">
<li>INSERT（插入数据）</li>
<li>UPDATE（更新数据）</li>
<li>DELETE（删除数据）</li>
</ul></li>

<li>DQL：Data Query Language 数据查询语言，从数据库中检索数据，是SQL的核心部分。关键字：
<ul class="org-ul">
<li>SELECT（查询数据）。特点：支持单表查询、多表连接（如内连接、外连接）、聚合函数（SUM、COUNT等）、分组（GROUP BY）和条件筛选（HAVING）</li>
</ul></li>

<li>DCL：Data Control Language 数据控制语言，管理数据库权限和事务控制。关键字：
<ul class="org-ul">
<li>GRANT（授予权限）</li>
<li>REVOKE（撤销权限）</li>
<li>COMMIT（提交事务）</li>
<li>ROLLBACK（回滚事务）</li>
</ul></li>

<li>TCL: Transaction Control Language 事务控制语言，负责处理ACID事务,确保数据库操作的原子性和一致性。关键字：
<ul class="org-ul">
<li>BEGIN TRANSACTION（开始事务）</li>
<li>SAVEPOINT（设置保存点）</li>
<li>COMMIT（提交事务）</li>
<li>ROLLBACK（回滚到保存点或事务起点）</li>
</ul></li>
</ul>

<p>
SQL的CRUD(Create-Read-Update-Delete)，即 Insert,update,delete,select 四条语句
</p>

<p>
软件开发：CRUD
</p>

<p>
运维人员：查询居多
</p>
</div>
</div>
<div id="outline-container-h:5e2c74f2-19ff-44dd-a076-f53efaf5be1d" class="outline-4">
<h4 id="h:5e2c74f2-19ff-44dd-a076-f53efaf5be1d">SQL语句构成</h4>
<div class="outline-text-4" id="text-h:5e2c74f2-19ff-44dd-a076-f53efaf5be1d">
<p>
关健字Keyword组成子句clause，多条clause组成语句
</p>

<p>
示例：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> *            #<span style="color: #a020f0;">SELECT</span>&#23376;&#21477;
<span style="color: #a020f0;">FROM</span> products       #<span style="color: #a020f0;">FROM</span>&#23376;&#21477;
<span style="color: #a020f0;">WHERE</span> price&gt;400     #<span style="color: #a020f0;">WHERE</span>&#23376;&#21477;
</pre>
</div>

<p>
说明：一组SQL语句，由三个子句构成，SELECT,FROM和WHERE是关键字
</p>

<p>
数据库操作
</p>

<p>
获取SQL 命令使用帮助：
</p>

<p>
官方帮助：<a href="https://dev.mysql.com/doc/refman/8.0/en/sql-statements.html">https://dev.mysql.com/doc/refman/8.0/en/sql-statements.html</a>
</p>

<div class="org-src-container">
<pre class="src src-sql">mysql&gt; HELP KEYWORD
</pre>
</div>
</div>
</div>
<div id="outline-container-h:19d078ca-e087-455f-9825-70e41211a350" class="outline-4">
<h4 id="h:19d078ca-e087-455f-9825-70e41211a350">字符集和排序</h4>
<div class="outline-text-4" id="text-h:19d078ca-e087-455f-9825-70e41211a350">
<p>
早期MySQL版本默认为latin1，从MySQL8.0开始默认字符集已经为 utf8mb4
</p>

<p>
查看支持所有字符集：
</p>
<div class="org-src-container">
<pre class="src src-sql">shwo charset;

SHOW <span style="color: #228b22;">CHARACTER</span> <span style="color: #a020f0;">SET</span>;
</pre>
</div>

<p>
范例：字符集和相关文件
</p>

<div class="org-src-container">
<pre class="src src-sql">mysql&gt; SHOW <span style="color: #228b22;">CHARACTER</span> <span style="color: #a020f0;">SET</span>;
# &#23383;&#31526;&#38598;  &#25551;&#36848;  &#40664;&#35748;&#25490;&#24207; &#26368;&#22823;&#25903;&#25345;&#30340;&#23383;&#33410;&#25968;
+<span style="color: #b22222;">----------</span><span style="color: #b22222;">+---------------------------------+---------------------+--------+</span>
| Charset  | Description                     | <span style="color: #a020f0;">Default</span> <span style="color: #a020f0;">collation</span>   | Maxlen |
+<span style="color: #b22222;">----------</span><span style="color: #b22222;">+---------------------------------+---------------------+--------+</span>
| armscii8 | ARMSCII-8 Armenian              | armscii8_general_ci |      1 |
| ascii    | US ASCII                        | ascii_general_ci    |      1 |
| big5     | Big5 Traditional Chinese        | big5_chinese_ci     |      2 |
| <span style="color: #228b22;">binary</span>   | <span style="color: #228b22;">Binary</span> pseudo charset           | <span style="color: #228b22;">binary</span>              |      1 |
| cp1250   | Windows Central European        | cp1250_general_ci   |      1 |
| cp1251   | Windows Cyrillic                | cp1251_general_ci   |      1 |
| cp1256   | Windows Arabic                  | cp1256_general_ci   |      1 |
| cp1257   | Windows Baltic                  | cp1257_general_ci   |      1 |
| cp850    | DOS West European               | cp850_general_ci    |      1 |
| cp852    | DOS Central European            | cp852_general_ci    |      1 |
| cp866    | DOS Russian                     | cp866_general_ci    |      1 |
| cp932    | SJIS <span style="color: #a020f0;">for</span> Windows Japanese       | cp932_japanese_ci   |      2 |
| dec8     | <span style="color: #228b22;">DEC</span> West European               | dec8_swedish_ci     |      1 |
| eucjpms  | UJIS <span style="color: #a020f0;">for</span> Windows Japanese       | eucjpms_japanese_ci |      3 |
| euckr    | EUC-KR Korean                   | euckr_korean_ci     |      2 |
| gb18030  | China <span style="color: #228b22;">National</span> Standard GB18030 | gb18030_chinese_ci  |      4 |
| gb2312   | GB2312 Simplified Chinese       | gb2312_chinese_ci   |      2 |
| gbk      | GBK Simplified Chinese          | gbk_chinese_ci      |      2 |
| geostd8  | GEOSTD8 Georgian                | geostd8_general_ci  |      1 |
| greek    | ISO 8859-7 Greek                | greek_general_ci    |      1 |
| hebrew   | ISO 8859-8 Hebrew               | hebrew_general_ci   |      1 |
| hp8      | HP West European                | hp8_english_ci      |      1 |
| keybcs2  | DOS Kamenicky Czech-Slovak      | keybcs2_general_ci  |      1 |
| koi8r    | KOI8-R Relcom Russian           | koi8r_general_ci    |      1 |
| koi8u    | KOI8-U Ukrainian                | koi8u_general_ci    |      1 |
| latin1   | cp1252 West European            | latin1_swedish_ci   |      1 |
| latin2   | ISO 8859-2 Central European     | latin2_general_ci   |      1 |
| latin5   | ISO 8859-9 Turkish              | latin5_turkish_ci   |      1 |
| latin7   | ISO 8859-13 Baltic              | latin7_general_ci   |      1 |
| macce    | Mac Central European            | macce_general_ci    |      1 |
| macroman | Mac West European               | macroman_general_ci |      1 |
| sjis     | Shift-JIS Japanese              | sjis_japanese_ci    |      2 |
| swe7     | 7bit Swedish                    | swe7_swedish_ci     |      1 |
| tis620   | TIS620 Thai                     | tis620_thai_ci      |      1 |
| ucs2     | UCS-2 Unicode                   | ucs2_general_ci     |      2 |
| ujis     | EUC-JP Japanese                 | ujis_japanese_ci    |      3 |
| utf16    | UTF-16 Unicode                  | utf16_general_ci    |      4 |
| utf16le  | UTF-16LE Unicode                | utf16le_general_ci  |      4 |
| utf32    | UTF-32 Unicode                  | utf32_general_ci    |      4 |
| utf8     | UTF-8 Unicode                   | utf8_general_ci     |      3 |
| utf8mb4  | UTF-8 Unicode                   | utf8mb4_0900_ai_ci  |      4 |
+<span style="color: #b22222;">----------</span><span style="color: #b22222;">+---------------------------------+---------------------+--------+</span>
41 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.00 sec)
# &#21487;&#20197;&#30475;&#21040; utf8&#21482;&#21344;&#20102;3&#20010;&#23383;&#33410;&#65292;&#23646;&#20110;&#38409;&#21106;&#29256;&#30340;utf8&#12290;utf8mb4 &#25165;&#26159;&#30495;&#30340;utf8.


[root@centos8 ~]#ll /usr/share/mysql/charsets/
total 240
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  5939 Jun 25  2019 armscii8.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  5925 Jun 25  2019 ascii.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  8654 Jun 25  2019 cp1250.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  8783 Jun 25  2019 cp1251.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  5982 Jun 25  2019 cp1256.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  9315 Jun 25  2019 cp1257.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  5919 Jun 25  2019 cp850.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  5941 Jun 25  2019 cp852.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  6026 Jun 25  2019 cp866.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  6942 Jun 25  2019 dec8.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  5929 Jun 25  2019 geostd8.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  6141 Jun 25  2019 greek.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  5930 Jun 25  2019 hebrew.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  5915 Jun 25  2019 hp8.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root 19495 Jun 25  2019 Index.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  5942 Jun 25  2019 keybcs2.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  5923 Jun 25  2019 koi8r.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  6945 Jun 25  2019 koi8u.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root 10229 Jun 25  2019 latin1.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  7651 Jun 25  2019 latin2.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  5928 Jun 25  2019 latin5.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  7851 Jun 25  2019 latin7.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  8460 Jun 25  2019 macce.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  8471 Jun 25  2019 macroman.xml</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  1749 Jun 25  2019 README</span>
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root  6943 Jun 25  2019 swe7.xml</span>
</pre>
</div>

<p>
查看当前字符集的使用情况
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [mysql]&gt; show variables <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'character%'</span>;
+<span style="color: #b22222;">--------------------------</span><span style="color: #b22222;">+------------------------------+</span>
| Variable_name            | <span style="color: #a020f0;">Value</span>                        |
+<span style="color: #b22222;">--------------------------</span><span style="color: #b22222;">+------------------------------+</span>
| character_set_client     | utf8                         |
| character_set_connection | utf8                         |
| character_set_database   | latin1                       |
| character_set_filesystem | <span style="color: #228b22;">binary</span>                       |
| character_set_results    | utf8                         |
| character_set_server     | latin1                       |
| character_set_system     | utf8                         |
| character_sets_dir       | /usr/share/mariadb/charsets/ |
+<span style="color: #b22222;">--------------------------</span><span style="color: #b22222;">+------------------------------+</span>
8 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>

<p>
查看支持所有排序规则：
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW <span style="color: #a020f0;">COLLATION</span>;
</pre>
</div>

<p>
查看当前使用的排序规则
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW VARIABLES <span style="color: #a020f0;">LIKE</span> <span style="color: #8b2252;">'collation%'</span>;
</pre>
</div>

<p>
设置服务器默认的字符集
</p>

<div class="org-src-container">
<pre class="src src-sql">vim /etc/my.cnf
[mysqld]
<span style="color: #228b22;">character</span>-<span style="color: #a020f0;">set</span>-server=utf8mb4
</pre>
</div>

<p>
设置mysql客户端默认的字符集，这个要跟服务器端一致
</p>

<div class="org-src-container">
<pre class="src src-sh">vim /etc/my.cnf
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38024;&#23545;mysql&#23458;&#25143;&#31471;</span>
[mysql]
default-character-set=utf8mb4

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38024;&#23545;&#25152;&#26377;mysql&#23458;&#25143;&#31471;</span>
[client]
default-character-set=utf8mb4
</pre>
</div>

<p>
范例：Mariadb10.3 默认的字符集和排序规则
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [mysql]&gt; <span style="color: #a020f0;">SELECT</span> VERSION();
+<span style="color: #b22222;">-----------------</span><span style="color: #b22222;">+</span>
| VERSION()       |
+<span style="color: #b22222;">-----------------</span><span style="color: #b22222;">+</span>
| 10.3.17-MariaDB |
+<span style="color: #b22222;">-----------------</span><span style="color: #b22222;">+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [mysql]&gt; show variables <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'character%'</span>;
+<span style="color: #b22222;">--------------------------</span><span style="color: #b22222;">+------------------------------+</span>
| Variable_name            | <span style="color: #a020f0;">Value</span>                        |
+<span style="color: #b22222;">--------------------------</span><span style="color: #b22222;">+------------------------------+</span>
| character_set_client     | utf8                         |
| character_set_connection | utf8                         |
| character_set_database   | latin1                       |
| character_set_filesystem | <span style="color: #228b22;">binary</span>                       |
| character_set_results    | utf8                         |
| character_set_server     | latin1                       |
| character_set_system     | utf8                         |
| character_sets_dir       | /usr/share/mariadb/charsets/ |
+<span style="color: #b22222;">--------------------------</span><span style="color: #b22222;">+------------------------------+</span>
8 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [mysql]&gt; SHOW VARIABLES <span style="color: #a020f0;">LIKE</span> <span style="color: #8b2252;">'collation%'</span>;
+<span style="color: #b22222;">----------------------</span><span style="color: #b22222;">+-------------------+</span>
| Variable_name        | <span style="color: #a020f0;">Value</span>             |
+<span style="color: #b22222;">----------------------</span><span style="color: #b22222;">+-------------------+</span>
| collation_connection | utf8_general_ci   |
| collation_database   | latin1_swedish_ci |
| collation_server     | latin1_swedish_ci |
+<span style="color: #b22222;">----------------------</span><span style="color: #b22222;">+-------------------+</span>
3 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>

<p>
范例：MySQL 8.0 默认的字符集和排序规则
</p>

<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #a020f0;">SELECT</span> VERSION();
+<span style="color: #b22222;">-----------</span><span style="color: #b22222;">+</span>
| VERSION() |
+<span style="color: #b22222;">-----------</span><span style="color: #b22222;">+</span>
| 8.0.17    |
+<span style="color: #b22222;">-----------</span><span style="color: #b22222;">+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.00 sec)

mysql&gt; show variables <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'character%'</span>;
+<span style="color: #b22222;">--------------------------</span><span style="color: #b22222;">+----------------------------+</span>
| Variable_name            | <span style="color: #a020f0;">Value</span>                      |
+<span style="color: #b22222;">--------------------------</span><span style="color: #b22222;">+----------------------------+</span>
| character_set_client     | utf8mb4                    |
| character_set_connection | utf8mb4                    |
| character_set_database   | utf8mb4                    |
| character_set_filesystem | <span style="color: #228b22;">binary</span>                     |
| character_set_results    | utf8mb4                    |
| character_set_server     | utf8mb4                    |
| character_set_system     | utf8                       |
| character_sets_dir       | /usr/share/mysql/charsets/ |
+<span style="color: #b22222;">--------------------------</span><span style="color: #b22222;">+----------------------------+</span>
8 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.00 sec)

mysql&gt; SHOW VARIABLES <span style="color: #a020f0;">LIKE</span> <span style="color: #8b2252;">'collation%'</span>;
+<span style="color: #b22222;">----------------------</span><span style="color: #b22222;">+--------------------+</span>
| Variable_name        | <span style="color: #a020f0;">Value</span>              |
+<span style="color: #b22222;">----------------------</span><span style="color: #b22222;">+--------------------+</span>
| collation_connection | utf8mb4_0900_ai_ci |
| collation_database   | utf8mb4_0900_ai_ci |
| collation_server     | utf8mb4_0900_ai_ci |
+<span style="color: #b22222;">----------------------</span><span style="color: #b22222;">+--------------------+</span>
3 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.01 sec)
</pre>
</div>

<p>
查看所有排序规则
</p>
<div class="org-src-container">
<pre class="src src-sh">SHOW COLLATION;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:476c40ea-cc96-44a6-b28e-1c8e18ceecdf" class="outline-3">
<h3 id="h:476c40ea-cc96-44a6-b28e-1c8e18ceecdf">管理数据库</h3>
<div class="outline-text-3" id="text-h:476c40ea-cc96-44a6-b28e-1c8e18ceecdf">
</div>
<div id="outline-container-h:a34d293d-c5ee-4b3c-b028-9b2d691ec1ac" class="outline-4">
<h4 id="h:a34d293d-c5ee-4b3c-b028-9b2d691ec1ac">创建数据库</h4>
<div class="outline-text-4" id="text-h:a34d293d-c5ee-4b3c-b028-9b2d691ec1ac">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> DATABASE|<span style="color: #a020f0;">SCHEMA</span> [IF <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">EXISTS</span>] <span style="color: #8b2252;">'DB_NAME'</span>
<span style="color: #228b22;">CHARACTER</span> <span style="color: #a020f0;">SET</span> <span style="color: #8b2252;">'character set name'</span>
<span style="color: #a020f0;">COLLATE</span> <span style="color: #8b2252;">'collate name'</span>;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">MariaDB [mysql]&gt; create database db1;
Query OK, 1 row affected (0.000 sec)

MariaDB [mysql]&gt; show create database db1;
+----------+----------------------------------------------------------------+
| Database | Create Database                                                |
+----------+----------------------------------------------------------------+
| db1      | CREATE DATABASE <span style="color: #ff00ff;">`db1`</span> /*!40100 DEFAULT CHARACTER SET latin1 */ |
+----------+----------------------------------------------------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#23383;&#31526;&#38598;&#21644;&#25490;&#24207;&#26041;&#24335;</span>
[root@centos8 ~]#cat /var/lib/mysql/db1/db.opt
default-character-set=latin1
default-collation=latin1_swedish_ci

MariaDB [(none)]&gt; create database db1;
ERROR 1007 (HY000): Can<span style="color: #8b2252;">'t create database '</span>db1<span style="color: #8b2252;">'; database exists</span>
<span style="color: #8b2252;">MariaDB [(none)]&gt; create database IF NOT EXISTS db1;</span>
<span style="color: #8b2252;">Query OK, 0 rows affected, 1 warning (0.000 sec)</span>

<span style="color: #8b2252;">MariaDB [(none)]&gt; show warnings;</span>
<span style="color: #8b2252;">+-------+------+----------------------------------------------+</span>
<span style="color: #8b2252;">| Level | Code | Message                                      |</span>
<span style="color: #8b2252;">+-------+------+----------------------------------------------+</span>
<span style="color: #8b2252;">| Note  | 1007 | Can'</span>t create database <span style="color: #8b2252;">'db1'</span>; database exists |
+-------+------+----------------------------------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)
</pre>
</div>

<p>
范例：指定字符集创建新数据库
</p>

<div class="org-src-container">
<pre class="src src-sh">CREATE DATABASE IF NOT EXISTS xxx CHARACTER SET <span style="color: #8b2252;">'utf8mb4'</span> COLLATE utf8mb4_general_ci;

MariaDB [(none)]&gt; create database IF NOT EXISTS db2 CHARACTER SET <span style="color: #8b2252;">'utf8'</span> collate utf8_bin; <span style="color: #b22222;"># </span><span style="color: #b22222;">utf8_bin&#26159;&#21306;&#20998;&#22823;&#23567;&#20889;&#30340;&#25490;&#24207;&#35268;&#21017;</span>
Query OK, 1 row affected (0.000 sec)

MariaDB [(none)]&gt; SHOW CREATE DATABASE db2;
+----------+--------------------------------------------------------------+
| Database | Create Database                                              |
+----------+--------------------------------------------------------------+
| db2      | CREATE DATABASE <span style="color: #ff00ff;">`db2`</span> /*!40100 DEFAULT CHARACTER SET utf8 */ |
+----------+--------------------------------------------------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)

MariaDB [(none)]&gt; 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#25991;&#20214;&#25351;&#23450;&#40664;&#35748;&#23383;&#31526;&#38598;&#21644;&#25490;&#24207;</span>
[root@centos8 ~]#cat /mysql/3306/data/db2/db.opt
default-character-set=utf8
default-collation=utf8_general_ci
</pre>
</div>


<p>
范例：以容器方式启动并创建数据库
</p>
<div class="org-src-container">
<pre class="src src-sh">docker run -p 3306:3306 --name mysql-server -t <span style="color: #8b2252;">\</span>
  -e <span style="color: #a0522d;">MYSQL_DATABASE</span>=<span style="color: #8b2252;">"zabbix"</span> <span style="color: #8b2252;">\</span>
  -e <span style="color: #a0522d;">MYSQL_USER</span>=<span style="color: #8b2252;">"zabbix"</span> <span style="color: #8b2252;">\</span>
  -e <span style="color: #a0522d;">MYSQL_PASSWORD</span>=<span style="color: #8b2252;">"zabbix_pwd"</span> <span style="color: #8b2252;">\</span>
  -e <span style="color: #a0522d;">MYSQL_ROOT_PASSWORD</span>=<span style="color: #8b2252;">"root_pwd"</span> <span style="color: #8b2252;">\</span>
  -d mysql:5.7 <span style="color: #8b2252;">\</span>
  --character-set-server=utf8 --collation-server=utf8_bin

</pre>
</div>
</div>
</div>
<div id="outline-container-h:f21792dc-e9e9-4d48-9492-aafeee193e36" class="outline-4">
<h4 id="h:f21792dc-e9e9-4d48-9492-aafeee193e36">修改数据库</h4>
<div class="outline-text-4" id="text-h:f21792dc-e9e9-4d48-9492-aafeee193e36">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">ALTER</span> DATABASE DB_NAME <span style="color: #228b22;">character</span> <span style="color: #a020f0;">set</span> utf8;
</pre>
</div>

<p>
范例：修改数据库字符集和排序规则
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; <span style="color: #a020f0;">ALTER</span> DATABASE db1 <span style="color: #228b22;">character</span> <span style="color: #a020f0;">set</span> utf8 <span style="color: #a020f0;">COLLATE</span> utf8_bin;

MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; show <span style="color: #a020f0;">create</span> database db1;
[root@centos8 ~]#cat /var/lib/mysql/db1/db.opt
</pre>
</div>
</div>
</div>
<div id="outline-container-h:03e40a88-2187-41d9-a938-f5672cca4d9a" class="outline-4">
<h4 id="h:03e40a88-2187-41d9-a938-f5672cca4d9a">删除数据库</h4>
<div class="outline-text-4" id="text-h:03e40a88-2187-41d9-a938-f5672cca4d9a">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DROP</span> DATABASE|<span style="color: #a020f0;">SCHEMA</span> [IF <span style="color: #a020f0;">EXISTS</span>] <span style="color: #8b2252;">'DB_NAME'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">MariaDB [(none)]&gt; drop database db1;
MariaDB [(none)]&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
+--------------------+


[root@centos8 ~]#ls /var/lib/mysql/ <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23454;&#38469;&#19978;&#23601;&#26159;&#21024;&#38500;&#30446;&#24405;</span>
aria_log.00000001   ib_buffer_pool   ib_logfile0   ibtmp1            mysql
mysql_upgrade_info tc.log
aria_log_control    ibdata1          ib_logfile1   multi-master.info mysql.sock
performance_schema
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2da943ef-be61-49a9-9437-adebcbc7e2e7" class="outline-4">
<h4 id="h:2da943ef-be61-49a9-9437-adebcbc7e2e7">查看数据库列表</h4>
<div class="outline-text-4" id="text-h:2da943ef-be61-49a9-9437-adebcbc7e2e7">
<div class="org-src-container">
<pre class="src src-sql">SHOW DATABASES;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">MariaDB [(none)]&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
+--------------------+
3 rows<span style="color: #a020f0;"> in</span> set (0.000 sec)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#25968;&#25454;&#24211;&#21019;&#24314;&#25351;&#20196;</span>
show create database db_xxx1;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:1a17248f-37c1-46d4-8063-df2a502fa7bb" class="outline-3">
<h3 id="h:1a17248f-37c1-46d4-8063-df2a502fa7bb">数据类型</h3>
<div class="outline-text-3" id="text-h:1a17248f-37c1-46d4-8063-df2a502fa7bb">
<p>
数据类型：
</p>
<ul class="org-ul">
<li>数据长什么样</li>
<li>数据需要多少空间来存放</li>
</ul>

<p>
数据类型
</p>
<ul class="org-ul">
<li>系统内置数据类型</li>
<li>用户定义数据类型</li>
</ul>

<p>
MySQL支持多种内置数据类型
</p>
<ul class="org-ul">
<li>数值类型</li>
<li>日期/时间类型</li>
<li>字符串(字符)类型</li>
</ul>

<p>
数据类型参考链接
<a href="https://dev.mysql.com/doc/refman/9.3/en/data-types.html">https://dev.mysql.com/doc/refman/9.3/en/data-types.html</a>
</p>



<figure id="orgcf5e3d6">
<img src="./images/img_20250217_152531.png" alt="img_20250217_152531.png" width="90%">

</figure>


<p>
选择正确的数据类型对于获得高性能至关重要，三大原则：
</p>
<ol class="org-ol">
<li>更小的通常更好，尽量使用可正确存储数据的最小数据类型</li>
<li>简单就好，简单数据类型的操作通常需要更少的CPU周期</li>
<li>尽量避免NULL，包含为NULL的列，对MySQL更难优化</li>
</ol>
</div>
<div id="outline-container-h:572483ab-00ea-4cc3-9022-cf3d17e6c0bc" class="outline-4">
<h4 id="h:572483ab-00ea-4cc3-9022-cf3d17e6c0bc">整数型</h4>
<div class="outline-text-4" id="text-h:572483ab-00ea-4cc3-9022-cf3d17e6c0bc">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">tinyint</span>(m)    &#36855;&#20320;&#25972;&#22411;  1&#20010;&#23383;&#33410; &#33539;&#22260;(-128~127)
<span style="color: #0000ff;">smallint</span>(m)   &#30701;&#25972;&#22411;  2&#20010;&#23383;&#33410; &#33539;&#22260;(-32768~32767)
<span style="color: #0000ff;">mediumint</span>(m)   &#20013;&#25972;&#22411; 3&#20010;&#23383;&#33410; &#33539;&#22260;(-8388608~8388607)
<span style="color: #0000ff;">int</span>(m)         &#26631;&#20934;&#25972;&#22411; 4&#20010;&#23383;&#33410; &#33539;&#22260;(-2147483648~2147483647)
<span style="color: #0000ff;">bigint</span>(m)      &#22823;&#25972;&#22411; 8&#20010;&#23383;&#33410; &#33539;&#22260;(+-9.22*10&#30340;18&#27425;&#26041;)
</pre>
</div>

<p>
上述数据类型，如果 <b>加修饰符unsigned后，则最大值翻倍</b> （ <b>默认第一位都是符号位，导致范围正负都有</b> ）
</p>

<p>
如：tinyint unsigned的取值范围为(0~255) int(m)里的m是表示SELECT查询结
果集中的显示宽度，并不影响实际的取值范围，规定了MySQL的一些交互工具
（例如MySQL命令行客户端）用来显示字符的个数。对于存储和计算来说，
Int(1)和Int(20)是相同的
</p>

<p>
BOOL，BOOLEAN：布尔型，是TINYINT(1)的同义词。zero值被视为假，非zero值视为真
</p>
</div>
<div id="outline-container-h:f0867143-411a-4b66-8fef-1d1a841fc59d" class="outline-5">
<h5 id="h:f0867143-411a-4b66-8fef-1d1a841fc59d">零填充</h5>
<div class="outline-text-5" id="text-h:f0867143-411a-4b66-8fef-1d1a841fc59d">
<p>
整数类型的显示宽度、零填充
</p>

<p>
我们在很多设计表中，可能会看到比如 int(11) 这种数据类型，这里面的 11 代表的就是 显示宽度 。
</p>

<p>
所谓的显示宽度，其实就是显示的时候，看到的最少数字个数。
</p>

<p>
比如 int(2) ，表示不管你的数值是多少，最少可以看到两个数字。假如你存的
数值是9，没有满两位，就会在前面补零，显示为 09 ；假如你的数值是120，超
过了显示宽度，则直接显示原始值，不会做零填充。
</p>

<p>
显示宽度的注意事项：
</p>
<ul class="org-ul">
<li>显示宽度只适用于 MySQL 的整数类型。</li>
<li>显示宽度只是指明 MySQL 整数类型最少显示的数字个数（可以通过desc查看表字段显示）。</li>
<li><b>显示宽度只是在显示的时候改变数值的样式，不会对原本的值进行更改。</b></li>
<li>显示宽度和数值类型的取值范围无关。例如int(10) 他的取值范围依然是(-2
147 483 648，2 147 483 647)，即int的范围。</li>
</ul>

<p>
零填充的注意事项：
</p>
<ul class="org-ul">
<li>要想让显示宽度自动进行零填充，必须要配合 ZEROFILL 这个关键字一起使用。</li>
<li>零填充只能针对正整数，也就是说， ZEROFILL 要求整型为无符号型。</li>
</ul>

<p>
举例：
</p>

<p>
1、新建一张表，然后在这张表中新增 num1 字段，要求 num1 显示3位，不够3位的自动进行零填充：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26032;&#24314;&#19968;&#24352;&#34920;</span>
CREATE TABLE table_xxx1 (
  id int NOT NULL AUTO_INCREMENT PRIMARY KEY
);

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26174;&#31034;&#23485;&#24230;&#26377;&#25928;&#65288;&#27491;&#30830;&#20889;&#27861;&#65289;</span>
alter table table_xxx1 add num1 int(3) zerofill;

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23545;&#27604;&#65306;&#26222;&#36890;&#20889;&#27861;&#65292;&#26174;&#31034;&#23485;&#24230;&#26080;&#25928;</span>
alter table table_xxx1 add num2 int(3);

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23545;&#27604;&#65306;&#26222;&#36890;&#20889;&#27861;</span>
alter table table_xxx1 add num3 int;
</pre>
</div>

<p>
上述命令中，如果把 zerofill 这个关键字去掉，是达不到显示宽度的效果的。执行完上述命令后，
我们执行 desc table_xxx1 命令，对比一下 num1、num2、num3 的字段结构就知道了：
</p>
</div>
</div>
</div>
<div id="outline-container-h:af7b63d4-b4ff-44b9-9aff-dca3f8e5e6a7" class="outline-4">
<h4 id="h:af7b63d4-b4ff-44b9-9aff-dca3f8e5e6a7">浮点型(float和double)，近似值</h4>
<div class="outline-text-4" id="text-h:af7b63d4-b4ff-44b9-9aff-dca3f8e5e6a7">
<p>
float(m,d) 单精度浮点型 8位精度(4字节) m总个数，d小数位
</p>

<p>
double(m,d) 双精度浮点型16位精度(8字节) m总个数，d小数位
</p>

<p>
设一个字段定义为float(6,3)，如果插入一个数123.45678,实际数据库里存的是
123.457，但总个数还以实际为准，即6位
</p>
</div>
</div>
<div id="outline-container-h:db829c2f-54ff-4e21-adde-e6ea987c0eff" class="outline-4">
<h4 id="h:db829c2f-54ff-4e21-adde-e6ea987c0eff">定点数</h4>
<div class="outline-text-4" id="text-h:db829c2f-54ff-4e21-adde-e6ea987c0eff">
<p>
在数据库中存放的是精确值,存为十进制
</p>

<p>
decimal(m,d) 参数m&lt;65 是总个数，d&lt;30且 d&lt;m 是小数位
</p>

<p>
MySQL5.0和更高版本将数字打包保存到一个二进制字符串中（每4个字节存9个数字）。
</p>

<p>
例如:
</p>

<p>
decimal(18,9)小数点两边将各存储9个数字，一共使用9个字节：其中，小数点
前的9个数字用4个字节，小数点后的9个数字用4个字节，小数点本身占1个字节
</p>

<p>
浮点类型在存储同样范围的值时，通常比decimal使用更少的空间。float使用4
个字节存储。double占用8个字节
</p>

<p>
因为需要额外的空间和计算开销，所以应该尽量只在对小数进行精确计算时才使
用decimal，例如存储财务数据。但在数据量比较大的时候，可以考虑使用
bigint代替decimal
</p>
</div>
</div>
<div id="outline-container-h:da0b7754-219c-49fa-bb57-f6f17c46c30a" class="outline-4">
<h4 id="h:da0b7754-219c-49fa-bb57-f6f17c46c30a">字符串(char,varchar,text)</h4>
<div class="outline-text-4" id="text-h:da0b7754-219c-49fa-bb57-f6f17c46c30a">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #228b22;">char</span>(n)      &#22266;&#23450;&#38271;&#24230;&#65292;&#26368;&#22810;255&#20010;&#23383;&#31526;
<span style="color: #228b22;">varchar</span>(n)   &#21487;&#21464;&#38271;&#24230;&#65292;&#26368;&#22810;65535&#20010;&#23383;&#31526;
tinytext     &#21487;&#21464;&#38271;&#24230;&#65292;&#26368;&#22810;255&#20010;&#23383;&#31526;
text         &#21487;&#21464;&#38271;&#24230;&#65292;&#26368;&#22810;65535&#20010;&#23383;&#31526;
mediumtext   &#21487;&#21464;&#38271;&#24230;&#65292;&#26368;&#22810;2&#30340;24&#27425;&#26041;-1&#20010;&#23383;&#31526;
longtext     &#21487;&#21464;&#38271;&#24230;&#65292;&#26368;&#22810;2&#30340;32&#27425;&#26041;-1&#20010;&#23383;&#31526;
<span style="color: #228b22;">BINARY</span>(<span style="color: #a020f0;">M</span>)    &#22266;&#23450;&#38271;&#24230;&#65292;&#21487;&#23384;&#20108;&#36827;&#21046;&#25110;&#23383;&#31526;&#65292;&#38271;&#24230;&#20026;0-<span style="color: #a020f0;">M</span>&#23383;&#33410;
VARBINARY(<span style="color: #a020f0;">M</span>) &#21487;&#21464;&#38271;&#24230;&#65292;&#21487;&#23384;&#20108;&#36827;&#21046;&#25110;&#23383;&#31526;&#65292;&#20801;&#35768;&#38271;&#24230;&#20026;0-<span style="color: #a020f0;">M</span>&#23383;&#33410;
&#20869;&#24314;&#31867;&#22411;&#65306;ENUM&#26522;&#20030;, <span style="color: #a020f0;">SET</span>&#38598;&#21512;
</pre>
</div>


<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">类型</td>
<td class="org-left">大小</td>
<td class="org-left">用途</td>
</tr>

<tr>
<td class="org-left">CHAR</td>
<td class="org-left">0-255bytes</td>
<td class="org-left">定长字符串</td>
</tr>

<tr>
<td class="org-left">VARCHAR</td>
<td class="org-left">0-65535bytes</td>
<td class="org-left">变长字符串</td>
</tr>

<tr>
<td class="org-left">TINYBLOB</td>
<td class="org-left">0-255bytes</td>
<td class="org-left">不超过255个字符的二进制字符串</td>
</tr>

<tr>
<td class="org-left">TINYTEXT</td>
<td class="org-left">0-255bytes</td>
<td class="org-left">短文本字符串</td>
</tr>

<tr>
<td class="org-left">BLOB</td>
<td class="org-left">0-65 535bytes</td>
<td class="org-left">二进制形式的长文本数据</td>
</tr>

<tr>
<td class="org-left">TEXT</td>
<td class="org-left">0-65 535bytes</td>
<td class="org-left">长文本数据</td>
</tr>

<tr>
<td class="org-left">MEDIUMBLOB</td>
<td class="org-left">0-16 777 215bytes</td>
<td class="org-left">二进制形式的中等长度文本数据</td>
</tr>

<tr>
<td class="org-left">MEDIUMTEXT</td>
<td class="org-left">0-16 777 215bytes</td>
<td class="org-left">中等长度文本数据</td>
</tr>

<tr>
<td class="org-left">LONGBLOB</td>
<td class="org-left">0-4 294 967 295bytes</td>
<td class="org-left">二进制形式的极大文本数据</td>
</tr>

<tr>
<td class="org-left">LONGTEXT</td>
<td class="org-left">0-4 294 967 295bytes</td>
<td class="org-left">极大文本数据</td>
</tr>
</tbody>
</table>

<p>
<b>char和varchar</b> ：
</p>

<p>
参考：<a href="https://dev.mysql.com/doc/refman/8.0/en/char.html">https://dev.mysql.com/doc/refman/8.0/en/char.html</a>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Value</th>
<th scope="col" class="org-left">CHAR(4)</th>
<th scope="col" class="org-left">Storage Required</th>
<th scope="col" class="org-left">VARCHAR(4)</th>
<th scope="col" class="org-left">Storage Required</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">''</td>
<td class="org-left">' '</td>
<td class="org-left">4 bytes</td>
<td class="org-left">''</td>
<td class="org-left">1 byte</td>
</tr>

<tr>
<td class="org-left">'ab'</td>
<td class="org-left">'ab'</td>
<td class="org-left">4 bytes</td>
<td class="org-left">'ab'</td>
<td class="org-left">3 bytes</td>
</tr>

<tr>
<td class="org-left">'abcd'</td>
<td class="org-left">'abcd'</td>
<td class="org-left">4 bytes</td>
<td class="org-left">'abcd'</td>
<td class="org-left">5 bytes</td>
</tr>

<tr>
<td class="org-left">'abcdefgh'</td>
<td class="org-left">'abcd'</td>
<td class="org-left">4 bytes</td>
<td class="org-left">'abcd'</td>
<td class="org-left">5 bytes</td>
</tr>
</tbody>
</table>

<p>
1.char(n)若存入字符数小于n，则以空格补于其后，查询之时再将空格去掉，所
以char类型存储的字符串末尾不能有空格，varchar不限于此
</p>

<p>
2.char(n)固定长度，char(4)不管是存入几个字符，都将占用4个字节，varchar
是存入的实际字符数+1个字节（n&lt;n&gt;255)，所以varchar(4),存入3个字符将占用
4个字节
</p>

<p>
3.char类型的字符串检索速度要比varchar类型的快
</p>

<p>
<b>varchar和text</b> ：
</p>

<p>
1.varchar可指定n，text不能指定，内部存储varchar是存入的实际字符数+1个
字节（n&lt;n&gt;255)，text是实际字符数+2个字节。
</p>

<p>
2.text类型不能有默认值
</p>

<p>
3.varchar可直接创建索引，text创建索引要指定前多少个字符。varchar查询速
度快于text数据类型
</p>

<p>
问：VARCHAR(50)能存放几个utf8编码的汉字
</p>

<p>
答：存放汉字个数与版本相关。mysql5.0以上版本，varchar(50)指的是50字符，
无论存放的是数字、字母还是utf8编码汉字，都可以存放50个。
</p>
</div>
</div>
<div id="outline-container-h:e94c37d7-0356-4523-8322-b7f35473de09" class="outline-4">
<h4 id="h:e94c37d7-0356-4523-8322-b7f35473de09">二进制数据BLOB</h4>
<div class="outline-text-4" id="text-h:e94c37d7-0356-4523-8322-b7f35473de09">
<p>
BLOB和text存储方式不同，TEXT以文本方式存储，英文存储区分大小写，而Blob
以二进制方式存储，不分大小写
</p>

<p>
BLOB存储的数据只能整体读出
</p>

<p>
TEXT可以指定字符集，BLOB不用指定字符集
</p>
</div>
</div>
<div id="outline-container-h:1bb58cb3-8284-4970-9301-cca9322c1b0c" class="outline-4">
<h4 id="h:1bb58cb3-8284-4970-9301-cca9322c1b0c">日期时间类型</h4>
<div class="outline-text-4" id="text-h:1bb58cb3-8284-4970-9301-cca9322c1b0c">
<p>
date 日期 '2008-12-2'
</p>

<p>
time 时间 '12:25:36'
</p>

<p>
datetime 日期时间 '2008-12-2 22:06:44'
</p>

<p>
timestamp 自动存储记录修改时间
</p>

<p>
YEAR(2), YEAR(4)：年份
</p>

<p>
timestamp字段里的时间数据会随其他字段修改的时候自动刷新，这个数据类型
的字段可以存放这条记录最后被修改的时间
</p>
</div>
</div>
<div id="outline-container-h:87e7d092-dda2-4ebb-b874-bab94862259e" class="outline-4">
<h4 id="h:87e7d092-dda2-4ebb-b874-bab94862259e">修饰符</h4>
<div class="outline-text-4" id="text-h:87e7d092-dda2-4ebb-b874-bab94862259e">
<p>
<b>适用所有类型的修饰符</b> ：
</p>

<p>
NULL 数据列可包含NULL值，默认值
</p>

<p>
NOT NULL 数据列不允许包含NULL值，*为必填选项
</p>

<p>
DEFAULT 默认值
</p>

<p>
PRIMARY KEY 主键，所有记录中此字段的值不能重复，且不能为NULL
</p>

<p>
UNIQUE KEY 唯一键，所有记录中此字段的值不能重复，但可以为NULL
</p>

<p>
CHARACTER SET name 指定一个字符集
</p>

<p>
<b>适用数值型的修饰符</b> ：
</p>

<p>
AUTO_INCREMENT 自动递增，适用于整数类型
</p>

<p>
UNSIGNED 无符号
</p>

<p>
范例：关于AUTO_INCREMENT
</p>

<div class="org-src-container">
<pre class="src src-sh">MariaDB [hellodb]&gt; SHOW VARIABLES LIKE <span style="color: #8b2252;">'auto_inc%'</span>;
+--------------------------+-------+
| Variable_name            | Value |
+--------------------------+-------+
| auto_increment_increment | 1     |
| auto_increment_offset    | 1     |
+--------------------------+-------+
2 rows<span style="color: #a020f0;"> in</span> set (0.001 sec)

<span style="color: #b22222;"># </span><span style="color: #b22222;">auto_increment_offset &#23450;&#20041;&#21021;&#22987;&#20540;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">auto_increment_increment &#23450;&#20041;&#27493;&#36827;</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #a020f0;">create</span> database test;
Query OK, 1 <span style="color: #228b22;">row</span> affected (0.00 sec)
mysql&gt; use test
Database changed

mysql&gt; <span style="color: #a020f0;">create</span> <span style="color: #a020f0;">table</span> student (id <span style="color: #228b22;">smallint</span> unsigned <span style="color: #a020f0;">primary</span> <span style="color: #a020f0;">key</span> auto_increment, <span style="color: #a020f0;">name</span> <span style="color: #228b22;">varchar</span>(10), age tinyint unsigned, gender enum(<span style="color: #8b2252;">'M'</span>,<span style="color: #8b2252;">'F'</span>) <span style="color: #a020f0;">default</span> <span style="color: #8b2252;">'M'</span>) ENGINE=InnoDB AUTO_INCREMENT=10 <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8;
mysql&gt; show <span style="color: #a020f0;">create</span> <span style="color: #a020f0;">table</span> student;
+<span style="color: #b22222;">---------</span><span style="color: #b22222;">+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
| <span style="color: #a020f0;">Table</span>   | <span style="color: #a020f0;">Create</span> <span style="color: #a020f0;">Table</span>                                                                                                                                                                                                                                                                 |
+<span style="color: #b22222;">---------</span><span style="color: #b22222;">+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
| student | <span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `student` (
  `id` <span style="color: #228b22;">smallint</span>(5) unsigned <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> AUTO_INCREMENT,
  `<span style="color: #a020f0;">name</span>` <span style="color: #228b22;">varchar</span>(10) <span style="color: #a020f0;">DEFAULT</span> <span style="color: #a020f0;">NULL</span>,
  `age` tinyint(3) unsigned <span style="color: #a020f0;">DEFAULT</span> <span style="color: #a020f0;">NULL</span>,
  `gender` enum(<span style="color: #8b2252;">'M'</span>,<span style="color: #8b2252;">'F'</span>) <span style="color: #a020f0;">DEFAULT</span> <span style="color: #8b2252;">'M'</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=10 <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8 |
+<span style="color: #b22222;">---------</span><span style="color: #b22222;">+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.01 sec)


mysql&gt; <span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> t1 <span style="color: #a020f0;">values</span>(<span style="color: #a020f0;">null</span>);
Query OK, 1 <span style="color: #228b22;">row</span> affected (0.01 sec)

mysql&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> t1;
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+</span>
| id         |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+</span>
| 4294967294 |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.00 sec)
mysql&gt; <span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> t1 <span style="color: #a020f0;">values</span>(<span style="color: #a020f0;">null</span>);
Query OK, 1 <span style="color: #228b22;">row</span> affected (0.00 sec)
mysql&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> t1;
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+</span>
| id         |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+</span>
| 4294967294 |
| 4294967295 |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+</span>
2 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.00 sec)
mysql&gt; <span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> t1 <span style="color: #a020f0;">values</span>(<span style="color: #a020f0;">null</span>);
ERROR 1062 (23000): Duplicate entry <span style="color: #8b2252;">'4294967295'</span> <span style="color: #a020f0;">for</span> <span style="color: #a020f0;">key</span> <span style="color: #8b2252;">'PRIMARY'</span>

MariaDB [testdb]&gt; <span style="color: #a020f0;">insert</span> t1 <span style="color: #a020f0;">value</span>(<span style="color: #a020f0;">null</span>);
ERROR 167 (22003): <span style="color: #a020f0;">Out</span> <span style="color: #a020f0;">of</span> range <span style="color: #a020f0;">value</span> <span style="color: #a020f0;">for</span> <span style="color: #a020f0;">column</span> <span style="color: #8b2252;">'id'</span> <span style="color: #a020f0;">at</span> <span style="color: #228b22;">row</span> 1
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:344b8414-c94a-49fc-9c9d-117ddabc6634" class="outline-3">
<h3 id="h:344b8414-c94a-49fc-9c9d-117ddabc6634">DDL语句</h3>
<div class="outline-text-3" id="text-h:344b8414-c94a-49fc-9c9d-117ddabc6634">
<p>
表：二维关系
</p>

<p>
设计表：遵循规范
</p>

<p>
定义：字段，索引
</p>

<ul class="org-ul">
<li>字段：字段名，字段数据类型，修饰符</li>
<li>约束，索引：应该创建在经常用作查询条件的字段上</li>
</ul>
</div>
<div id="outline-container-h:9cc4f8c5-beaf-42ba-861a-0c4e32686872" class="outline-4">
<h4 id="h:9cc4f8c5-beaf-42ba-861a-0c4e32686872">创建表</h4>
<div class="outline-text-4" id="text-h:9cc4f8c5-beaf-42ba-861a-0c4e32686872">
<p>
创建表：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span>
</pre>
</div>

<p>
获取帮助：
</p>

<div class="org-src-container">
<pre class="src src-sql">HELP <span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span>
</pre>
</div>

<p>
创建表的方法
</p>
</div>
<div id="outline-container-h:7a12dc72-888d-4fbe-8f90-7150423fe0b2" class="outline-5">
<h5 id="h:7a12dc72-888d-4fbe-8f90-7150423fe0b2">直接创建</h5>
<div class="outline-text-5" id="text-h:7a12dc72-888d-4fbe-8f90-7150423fe0b2">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> [IF <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">EXISTS</span>] <span style="color: #8b2252;">'tbl_name'</span> (col1 type1 &#20462;&#39280;&#31526;, col2 type2 &#20462;&#39280;&#31526;, ...)
#&#23383;&#27573;&#20449;&#24687;
col type1
<span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span>(col1,...)
INDEX(col1, ...)
<span style="color: #a020f0;">UNIQUE</span> <span style="color: #a020f0;">KEY</span>(col1, ...)
#&#34920;&#36873;&#39033;&#65306;
ENGINE [=] engine_name
ROW_FORMAT [=] {<span style="color: #a020f0;">DEFAULT</span>|<span style="color: #a020f0;">DYNAMIC</span>|FIXED|COMPRESSED|REDUNDANT|COMPACT}
</pre>
</div>

<p>
注意：
</p>

<ul class="org-ul">
<li>Storage Engine是指表类型，也即在表创建时指明其使用的存储引擎</li>
<li>同一库中不同表可以使用不同的存储引擎</li>
<li>同一个库中表建议要使用同一种存储引擎类型</li>
</ul>

<p>
范例：创建表
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">student</span> (               #&#34920;&#21517;
id <span style="color: #228b22;">int</span> UNSIGNED AUTO_INCREMENT <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span>,   #&#23383;&#27573;&#21517;&#65292;&#23383;&#27573;&#31867;&#22411;
<span style="color: #a020f0;">name</span> <span style="color: #228b22;">VARCHAR</span>(20) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
age tinyint UNSIGNED,
gender ENUM(<span style="color: #8b2252;">'M'</span>,<span style="color: #8b2252;">'F'</span>) <span style="color: #a020f0;">default</span> <span style="color: #8b2252;">'M'</span>     #ENUM&#26522;&#20030;&#22411;&#65292;&#21482;&#33021;&#36873;&#19968;&#20010;
)ENGINE=InnoDB AUTO_INCREMENT=10 <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8;  #ENGINE&#23384;&#20648;&#24341;&#25806;
#id&#23383;&#27573;&#20197;10&#21021;&#22987;&#20540;

MariaDB [testdb]&gt; <span style="color: #a020f0;">desc</span> student;
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
| Field  | <span style="color: #a020f0;">Type</span>                | <span style="color: #a020f0;">Null</span> | <span style="color: #a020f0;">Key</span> | <span style="color: #a020f0;">Default</span> | Extra          |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
| id     | <span style="color: #228b22;">int</span>(10) unsigned    | <span style="color: #a020f0;">NO</span>   | PRI | <span style="color: #a020f0;">NULL</span>    | auto_increment |
| <span style="color: #a020f0;">name</span>   | <span style="color: #228b22;">varchar</span>(20)         | <span style="color: #a020f0;">NO</span>   |     | <span style="color: #a020f0;">NULL</span>    |                |
| age    | tinyint(3) unsigned | YES  |     | <span style="color: #a020f0;">NULL</span>    |                |
| gender | enum(<span style="color: #8b2252;">'M'</span>,<span style="color: #8b2252;">'F'</span>)       | YES  |     | <span style="color: #a020f0;">M</span>       |                |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
#10&#20195;&#34920;&#39044;&#30041;&#20102;10&#20010;&#23383;&#33410;&#65292;20&#65292;3&#21516;&#29702;
MariaDB [testdb]&gt; <span style="color: #a020f0;">insert</span> student (<span style="color: #a020f0;">name</span>,age)<span style="color: #a020f0;">values</span>(<span style="color: #8b2252;">'xiaoming'</span>,20);
Query OK, 1 <span style="color: #228b22;">row</span> affected (0.001 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> student;
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+----------+------+--------+</span>
| id | <span style="color: #a020f0;">name</span>     | age  | gender |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+----------+------+--------+</span>
| 10 | xiaoming |   20 | <span style="color: #a020f0;">M</span>      |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+----------+------+--------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">insert</span> student (<span style="color: #a020f0;">name</span>,age,gender)<span style="color: #a020f0;">values</span>(<span style="color: #8b2252;">'xiaohong'</span>,18,<span style="color: #8b2252;">'f'</span>);
Query OK, 1 <span style="color: #228b22;">row</span> affected (0.001 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> student;
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+----------+------+--------+</span>
| id | <span style="color: #a020f0;">name</span>     | age  | gender |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+----------+------+--------+</span>
| 10 | xiaoming |   20 | <span style="color: #a020f0;">M</span>      |
| 11 | xiaohong |   18 | F      |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+----------+------+--------+</span>
2 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

#&#22797;&#21512;&#20027;&#38190;
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">employee</span> (id <span style="color: #228b22;">int</span> UNSIGNED <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> ,<span style="color: #a020f0;">name</span> <span style="color: #228b22;">VARCHAR</span>(20) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,age
tinyint UNSIGNED,<span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span>(id,<span style="color: #a020f0;">name</span>));
</pre>
</div>

<p>
范例：auto_increment 属性
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [testdb]&gt; SHOW VARIABLES <span style="color: #a020f0;">LIKE</span> <span style="color: #8b2252;">'auto_inc%'</span>;
+<span style="color: #b22222;">--------------------------</span><span style="color: #b22222;">+-------+</span>
| Variable_name            | <span style="color: #a020f0;">Value</span> |
+<span style="color: #b22222;">--------------------------</span><span style="color: #b22222;">+-------+</span>
| auto_increment_increment | 1     |
| auto_increment_offset    | 1     |
+<span style="color: #b22222;">--------------------------</span><span style="color: #b22222;">+-------+</span>
2 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">SET</span> @@auto_increment_increment=10;
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.000 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">SET</span> @@auto_increment_offset=3;
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.000 sec)

MariaDB [testdb]&gt; SHOW VARIABLES <span style="color: #a020f0;">LIKE</span> <span style="color: #8b2252;">'auto_inc%'</span>;
+<span style="color: #b22222;">--------------------------</span><span style="color: #b22222;">+-------+</span>
| Variable_name            | <span style="color: #a020f0;">Value</span> |
+<span style="color: #b22222;">--------------------------</span><span style="color: #b22222;">+-------+</span>
| auto_increment_increment | 10    |
| auto_increment_offset    | 3     |
+<span style="color: #b22222;">--------------------------</span><span style="color: #b22222;">+-------+</span>
2 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> autoinc1 (col <span style="color: #228b22;">INT</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> AUTO_INCREMENT <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span>);
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.006 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> autoinc1 <span style="color: #a020f0;">VALUES</span> (<span style="color: #a020f0;">NULL</span>),(<span style="color: #a020f0;">NULL</span>),(<span style="color: #a020f0;">NULL</span>),(<span style="color: #a020f0;">NULL</span>);
Query OK, 4 <span style="color: #a020f0;">rows</span> affected (0.001 sec)
Records: 4  Duplicates: 0  Warnings: 0

MariaDB [testdb]&gt; <span style="color: #a020f0;">SELECT</span> col <span style="color: #a020f0;">FROM</span> autoinc1;
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+</span>
| col |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+</span>
|   3 |
|  13 |
|  23 |
|  33 |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+</span>
4 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #a020f0;">create</span> <span style="color: #a020f0;">table</span> testdate (id <span style="color: #228b22;">int</span> auto_increment <span style="color: #a020f0;">primary</span> <span style="color: #a020f0;">key</span>,<span style="color: #228b22;">date</span> <span style="color: #228b22;">timestamp</span>
<span style="color: #a020f0;">DEFAULT</span> <span style="color: #483d8b;">CURRENT_TIMESTAMP</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6cff1492-8dee-42b4-b30a-89f997e25e9e" class="outline-5">
<h5 id="h:6cff1492-8dee-42b4-b30a-89f997e25e9e">通过查询现存表创建；</h5>
<div class="outline-text-5" id="text-h:6cff1492-8dee-42b4-b30a-89f997e25e9e">
<p>
新表会被直接插入查询而来的数据
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> [<span style="color: #a020f0;">TEMPORARY</span>] <span style="color: #a020f0;">TABLE</span> [IF <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">EXISTS</span>] tbl_name [(create_definition,...)]
[table_options]
[partition_options] select_statement
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [db1]&gt; <span style="color: #a020f0;">create</span> <span style="color: #a020f0;">table</span> <span style="color: #483d8b;">user</span> <span style="color: #a020f0;">select</span> <span style="color: #483d8b;">user</span>,<span style="color: #a020f0;">host</span>,password <span style="color: #a020f0;">from</span> mysql.<span style="color: #483d8b;">user</span>;
Query OK, 6 <span style="color: #a020f0;">rows</span> affected (0.004 sec)
Records: 6  Duplicates: 0  Warnings: 0

MariaDB [db1]&gt; show tables;
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+</span>
| Tables_in_db1 |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+</span>
| <span style="color: #483d8b;">user</span>          |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [db1]&gt; <span style="color: #a020f0;">desc</span> <span style="color: #483d8b;">user</span>;
+<span style="color: #b22222;">----------</span><span style="color: #b22222;">+----------+------+-----+---------+-------+</span>
| Field    | <span style="color: #a020f0;">Type</span>     | <span style="color: #a020f0;">Null</span> | <span style="color: #a020f0;">Key</span> | <span style="color: #a020f0;">Default</span> | Extra |
+<span style="color: #b22222;">----------</span><span style="color: #b22222;">+----------+------+-----+---------+-------+</span>
| <span style="color: #483d8b;">user</span>     | <span style="color: #228b22;">char</span>(80) | <span style="color: #a020f0;">NO</span>   |     |         |       |
| <span style="color: #a020f0;">host</span>     | <span style="color: #228b22;">char</span>(60) | <span style="color: #a020f0;">NO</span>   |     |         |       |
| password | <span style="color: #228b22;">char</span>(41) | <span style="color: #a020f0;">NO</span>   |     |         |       |
+<span style="color: #b22222;">----------</span><span style="color: #b22222;">+----------+------+-----+---------+-------+</span>
3 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cef0503c-c5df-4ce9-940c-043d781ac1e4" class="outline-5">
<h5 id="h:cef0503c-c5df-4ce9-940c-043d781ac1e4">通过复制现存的表的表结构创建</h5>
<div class="outline-text-5" id="text-h:cef0503c-c5df-4ce9-940c-043d781ac1e4">
<p>
但不复制数据
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> [<span style="color: #a020f0;">TEMPORARY</span>] <span style="color: #a020f0;">TABLE</span> [IF <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">EXISTS</span>] tbl_name { <span style="color: #a020f0;">LIKE</span> old_tbl_name | (<span style="color: #a020f0;">LIKE</span>
old_tbl_name) }
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [testdb]&gt; <span style="color: #a020f0;">desc</span> student;
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
| Field  | <span style="color: #a020f0;">Type</span>                | <span style="color: #a020f0;">Null</span> | <span style="color: #a020f0;">Key</span> | <span style="color: #a020f0;">Default</span> | Extra          |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
| id     | <span style="color: #228b22;">int</span>(10) unsigned    | <span style="color: #a020f0;">NO</span>   | PRI | <span style="color: #a020f0;">NULL</span>    | auto_increment |
| <span style="color: #a020f0;">name</span>   | <span style="color: #228b22;">varchar</span>(20)         | <span style="color: #a020f0;">NO</span>   |     | <span style="color: #a020f0;">NULL</span>    |                |
| age    | tinyint(3) unsigned | YES  |     | <span style="color: #a020f0;">NULL</span>    |                |
| gender | enum(<span style="color: #8b2252;">'M'</span>,<span style="color: #8b2252;">'F'</span>)       | YES  |     | <span style="color: #a020f0;">M</span>       |                |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
4 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">create</span> <span style="color: #a020f0;">table</span> teacher <span style="color: #a020f0;">like</span> student;
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.007 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">desc</span> teacher;
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
| Field  | <span style="color: #a020f0;">Type</span>                | <span style="color: #a020f0;">Null</span> | <span style="color: #a020f0;">Key</span> | <span style="color: #a020f0;">Default</span> | Extra          |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
| id     | <span style="color: #228b22;">int</span>(10) unsigned    | <span style="color: #a020f0;">NO</span>   | PRI | <span style="color: #a020f0;">NULL</span>    | auto_increment |
| <span style="color: #a020f0;">name</span>   | <span style="color: #228b22;">varchar</span>(20)         | <span style="color: #a020f0;">NO</span>   |     | <span style="color: #a020f0;">NULL</span>    |                |
| age    | tinyint(3) unsigned | YES  |     | <span style="color: #a020f0;">NULL</span>    |                |
| gender | enum(<span style="color: #8b2252;">'M'</span>,<span style="color: #8b2252;">'F'</span>)       | YES  |     | <span style="color: #a020f0;">M</span>       |                |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
4 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:540298c9-f3a0-47c0-94c8-fdf3fd6f0113" class="outline-4">
<h4 id="h:540298c9-f3a0-47c0-94c8-fdf3fd6f0113">表查看</h4>
<div class="outline-text-4" id="text-h:540298c9-f3a0-47c0-94c8-fdf3fd6f0113">
<p>
查看支持的engine类型
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW ENGINES;
</pre>
</div>

<p>
查看表：
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW TABLES [<span style="color: #a020f0;">FROM</span> db_name]
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [testdb]&gt; show tables;
+<span style="color: #b22222;">------------------</span><span style="color: #b22222;">+</span>
| Tables_in_testdb |
+<span style="color: #b22222;">------------------</span><span style="color: #b22222;">+</span>
| student          |
| teacher          |
+<span style="color: #b22222;">------------------</span><span style="color: #b22222;">+</span>
2 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
</pre>
</div>

<p>
查看表结构：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DESC</span> [db_name.]tb_name   #&#25512;&#33616;
SHOW COLUMNS <span style="color: #a020f0;">FROM</span> [db_name.]tb_name
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [testdb]&gt; <span style="color: #a020f0;">desc</span> student;
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
| Field  | <span style="color: #a020f0;">Type</span>                | <span style="color: #a020f0;">Null</span> | <span style="color: #a020f0;">Key</span> | <span style="color: #a020f0;">Default</span> | Extra          |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
| id     | <span style="color: #228b22;">int</span>(10) unsigned    | <span style="color: #a020f0;">NO</span>   | PRI | <span style="color: #a020f0;">NULL</span>    | auto_increment |
| <span style="color: #a020f0;">name</span>   | <span style="color: #228b22;">varchar</span>(20)         | <span style="color: #a020f0;">NO</span>   |     | <span style="color: #a020f0;">NULL</span>    |                |
| age    | tinyint(3) unsigned | YES  |     | <span style="color: #a020f0;">NULL</span>    |                |
| gender | enum(<span style="color: #8b2252;">'M'</span>,<span style="color: #8b2252;">'F'</span>)       | YES  |     | <span style="color: #a020f0;">M</span>       |                |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
4 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [testdb]&gt; SHOW COLUMNS <span style="color: #a020f0;">FROM</span> student;
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
| Field  | <span style="color: #a020f0;">Type</span>                | <span style="color: #a020f0;">Null</span> | <span style="color: #a020f0;">Key</span> | <span style="color: #a020f0;">Default</span> | Extra          |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
| id     | <span style="color: #228b22;">int</span>(10) unsigned    | <span style="color: #a020f0;">NO</span>   | PRI | <span style="color: #a020f0;">NULL</span>    | auto_increment |
| <span style="color: #a020f0;">name</span>   | <span style="color: #228b22;">varchar</span>(20)         | <span style="color: #a020f0;">NO</span>   |     | <span style="color: #a020f0;">NULL</span>    |                |
| age    | tinyint(3) unsigned | YES  |     | <span style="color: #a020f0;">NULL</span>    |                |
| gender | enum(<span style="color: #8b2252;">'M'</span>,<span style="color: #8b2252;">'F'</span>)       | YES  |     | <span style="color: #a020f0;">M</span>       |                |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
4 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>

<p>
查看表创建命令（创建表的过程）：
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW <span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> tbl_name
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [testdb]&gt; show <span style="color: #a020f0;">create</span> <span style="color: #a020f0;">table</span> student;
+<span style="color: #b22222;">---------</span><span style="color: #b22222;">+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
| <span style="color: #a020f0;">Table</span>   | <span style="color: #a020f0;">Create</span> <span style="color: #a020f0;">Table</span>                                                                                                                                                                                                                                                           |
+<span style="color: #b22222;">---------</span><span style="color: #b22222;">+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
| student | <span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `student` (
  `id` <span style="color: #228b22;">int</span>(10) unsigned <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> AUTO_INCREMENT,
  `<span style="color: #a020f0;">name</span>` <span style="color: #228b22;">varchar</span>(20) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `age` tinyint(3) unsigned <span style="color: #a020f0;">DEFAULT</span> <span style="color: #a020f0;">NULL</span>,
  `gender` enum(<span style="color: #8b2252;">'M'</span>,<span style="color: #8b2252;">'F'</span>) <span style="color: #a020f0;">DEFAULT</span> <span style="color: #8b2252;">'M'</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=12 <span style="color: #a020f0;">DEFAULT</span> CHARSET=latin1 |
+<span style="color: #b22222;">---------</span><span style="color: #b22222;">+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
</pre>
</div>

<p>
查看表状态：
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW <span style="color: #a020f0;">TABLE</span> STATUS <span style="color: #a020f0;">LIKE</span> <span style="color: #8b2252;">'&#34920;&#21517;'</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [testdb]&gt; SHOW <span style="color: #a020f0;">TABLE</span> STATUS <span style="color: #a020f0;">LIKE</span> <span style="color: #8b2252;">'student'</span>\G   #\G&#31446;&#21521;&#26174;&#31034;
************************** 1. <span style="color: #228b22;">row</span> ***************************
            <span style="color: #a020f0;">Name</span>: student
          Engine: InnoDB
         Version: 10
      Row_format: <span style="color: #a020f0;">Dynamic</span>
            <span style="color: #a020f0;">Rows</span>: 2
  Avg_row_length: 8192
     Data_length: 16384
 Max_data_length: 0
    Index_length: 0
       Data_free: 0
  Auto_increment: 12
     Create_time: 2020-06-05 03:24:53
     Update_time: 2020-06-05 03:28:35
      Check_time: <span style="color: #a020f0;">NULL</span>
       <span style="color: #a020f0;">Collation</span>: latin1_swedish_ci   #&#23383;&#31526;&#25490;&#24207;&#35268;&#21017;
        Checksum: <span style="color: #a020f0;">NULL</span>
  Create_options: 
         Comment: 
Max_index_length: 0
       <span style="color: #a020f0;">Temporary</span>: N
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>

<p>
查看库中所有表状态
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW <span style="color: #a020f0;">TABLE</span> STATUS <span style="color: #a020f0;">FROM</span> db_name
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [testdb]&gt; SHOW <span style="color: #a020f0;">TABLE</span> STATUS <span style="color: #a020f0;">FROM</span> testdb\G
************************** 1. <span style="color: #228b22;">row</span> ***************************
            <span style="color: #a020f0;">Name</span>: student
          Engine: InnoDB
         Version: 10
      Row_format: <span style="color: #a020f0;">Dynamic</span>
            <span style="color: #a020f0;">Rows</span>: 2
  Avg_row_length: 8192
     Data_length: 16384
 Max_data_length: 0
    Index_length: 0
       Data_free: 0
  Auto_increment: 12
     Create_time: 2020-06-05 03:24:53
     Update_time: 2020-06-05 03:28:35
      Check_time: <span style="color: #a020f0;">NULL</span>
       <span style="color: #a020f0;">Collation</span>: latin1_swedish_ci
        Checksum: <span style="color: #a020f0;">NULL</span>
  Create_options: 
         Comment: 
Max_index_length: 0
       <span style="color: #a020f0;">Temporary</span>: N
************************** 2. <span style="color: #228b22;">row</span> ***************************
            <span style="color: #a020f0;">Name</span>: teacher
          Engine: InnoDB
         Version: 10
      Row_format: <span style="color: #a020f0;">Dynamic</span>
            <span style="color: #a020f0;">Rows</span>: 0
  Avg_row_length: 0
     Data_length: 16384
 Max_data_length: 0
    Index_length: 0
       Data_free: 0
  Auto_increment: 1
     Create_time: 2020-06-05 06:01:43
     Update_time: <span style="color: #a020f0;">NULL</span>
      Check_time: <span style="color: #a020f0;">NULL</span>
       <span style="color: #a020f0;">Collation</span>: latin1_swedish_ci
        Checksum: <span style="color: #a020f0;">NULL</span>
  Create_options: 
         Comment: 
Max_index_length: 0
       <span style="color: #a020f0;">Temporary</span>: N
2 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e9ed5f2b-c733-44f6-b29d-11753bf3cc63" class="outline-4">
<h4 id="h:e9ed5f2b-c733-44f6-b29d-11753bf3cc63">修改和删除表</h4>
<div class="outline-text-4" id="text-h:e9ed5f2b-c733-44f6-b29d-11753bf3cc63">
<p>
修改表
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #8b2252;">'tbl_name'</span>
#&#23383;&#27573;&#65306;
#&#28155;&#21152;&#23383;&#27573;&#65306;<span style="color: #a020f0;">add</span>
<span style="color: #a020f0;">ADD</span> col1 data_type [<span style="color: #a020f0;">FIRST</span>|<span style="color: #a020f0;">AFTER</span> col_name]  #<span style="color: #a020f0;">FIRST</span>&#25351;&#28155;&#21152;&#21040;col_name&#30340;&#21069;&#38754;
#&#21024;&#38500;&#23383;&#27573;&#65306;<span style="color: #a020f0;">drop</span>
#&#20462;&#25913;&#23383;&#27573;&#65306;
<span style="color: #a020f0;">alter</span>&#65288;&#40664;&#35748;&#20540;&#65289;, change&#65288;&#23383;&#27573;&#21517;&#65289;, <span style="color: #a020f0;">modify</span>&#65288;&#23383;&#27573;&#23646;&#24615;&#65289;
</pre>
</div>

<p>
查看修改表帮助
</p>

<div class="org-src-container">
<pre class="src src-sql">Help <span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span>
</pre>
</div>

<p>
删除表
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">TABLE</span> [IF <span style="color: #a020f0;">EXISTS</span>] <span style="color: #8b2252;">'tbl_name'</span>;
</pre>
</div>

<p>
面试题：修改表范例
</p>

<div class="org-src-container">
<pre class="src src-sh">ALTER TABLE students RENAME s1;  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25110;&#32773;rename table &#21407;&#34920;&#21517; to &#26032;&#34920;&#21517;;</span>
ALTER TABLE s1 ADD phone varchar(11) AFTER name;
ALTER TABLE s1 MODIFY phone int;
ALTER TABLE s1 CHANGE COLUMN phone mobile char(11); <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25913;&#26032;&#23383;&#27573;&#21517;</span>
ALTER TABLE s1 DROP COLUMN mobile;  
ALTER TABLE s1 character set utf8;
ALTER TABLE s1 change name name varchar(20) character set utf8;
ALTER TABLE students ADD gender ENUM(<span style="color: #8b2252;">'m'</span>,<span style="color: #8b2252;">'f'</span>);
ALETR TABLE students CHANGE id sid int UNSIGNED NOT NULL PRIMARY KEY;
ALTER TABLE students DROP age;
DESC students;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26032;&#24314;&#34920;&#26080;&#20027;&#38190;&#65292;&#28155;&#21152;&#21644;&#21024;&#38500;&#20027;&#38190;</span>
CREATE TABLE t1 SELECT * FROM students;
ALTER TABLE t1 add primary key (stuid);
ALTER TABLE t1 drop primary key ;
</pre>
</div>

<p>
举例1：
在 name 字段的后面，新增一个 home 字段：
</p>
<div class="org-src-container">
<pre class="src src-shell">alter table &#34920;&#21517; add home varchar(255) default null comment <span style="color: #8b2252;">'&#22320;&#22336;'</span> after name;
</pre>
</div>
<p>
注意，上方举例中，如果是新建 varchar 类型的字段，一定要指定 varchar 的长度（比如255），否则报错。
</p>

<p>
举例2：
新增一个 id 字段，放到最前面：
</p>
<div class="org-src-container">
<pre class="src src-shell">alter table &#34920;&#21517; add id int first;
insert into &#34920;&#21517; value(3,<span style="color: #8b2252;">'xxx2'</span>,<span style="color: #8b2252;">'China'</span>,27,<span style="color: #8b2252;">'man'</span>);
</pre>
</div>

<p>
修改字段名 sex 为 sexy ：
</p>
<div class="org-src-container">
<pre class="src src-shell">alter table &#34920;&#21517; change sex sexy varchar(255);
</pre>
</div>

<p>
举例1、针对现有的字段 name 和 age ，将age放在name之后：
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#24847;&#65292;&#36825;&#37324;&#30340; age &#21518;&#38754;&#19968;&#23450;&#35201;&#36319;&#19978;&#23427;&#30340;&#23383;&#27573;&#31867;&#22411;&#65292;&#21542;&#21017;&#25191;&#34892;&#22833;&#36133;</span>
alter table &#34920;&#21517; modify age int after name;
</pre>
</div>

<p>
修改字段的默认值
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#33509;&#26412;&#36523;&#23384;&#22312;&#40664;&#35748;&#20540;&#65292;&#21017;&#20808;&#21024;&#38500;</span>
alter table &#34920;&#21517; alter column &#23383;&#27573;&#21517; drop default;

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#33509;&#26412;&#36523;&#19981;&#23384;&#22312;&#21017;&#21487;&#20197;&#30452;&#25509;&#35774;&#23450;</span>
alter table &#34920;&#21517; alter column &#23383;&#27573;&#21517; set default &#40664;&#35748;&#20540;;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20030;&#20363;</span>
alter table &#34920;&#21517; alter column sexy set default <span style="color: #8b2252;">'man'</span>;
insert into &#34920;&#21517; value(4,<span style="color: #8b2252;">'xxx3'</span>,<span style="color: #8b2252;">'China'</span>,27,default);
</pre>
</div>

<p>
举例：（删除表中的 age 这个字段）
</p>
<div class="org-src-container">
<pre class="src src-shell">alter table &#34920;&#21517; drop age;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:1278e416-e04a-4aee-8c2c-10c473390141" class="outline-3">
<h3 id="h:1278e416-e04a-4aee-8c2c-10c473390141">DML语句</h3>
<div class="outline-text-3" id="text-h:1278e416-e04a-4aee-8c2c-10c473390141">
<p>
DML: INSERT, DELETE, UPDATE
增、删、改
</p>
</div>
<div id="outline-container-h:5fad30c4-6393-4c8d-9014-6f59a0e00a23" class="outline-4">
<h4 id="h:5fad30c4-6393-4c8d-9014-6f59a0e00a23">INSERT 语句</h4>
<div class="outline-text-4" id="text-h:5fad30c4-6393-4c8d-9014-6f59a0e00a23">
<p>
功能：一次插入一行或多行数据
</p>

<p>
语法
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">INSERT</span> [LOW_PRIORITY | DELAYED | HIGH_PRIORITY] [<span style="color: #a020f0;">IGNORE</span>]
    [<span style="color: #a020f0;">INTO</span>] tbl_name [(col_name,...)]
    {<span style="color: #a020f0;">VALUES</span> | <span style="color: #a020f0;">VALUE</span>} ({expr | <span style="color: #a020f0;">DEFAULT</span>},...),(...),...
    [ <span style="color: #a020f0;">ON</span> DUPLICATE <span style="color: #a020f0;">KEY</span> <span style="color: #a020f0;">UPDATE</span>
      col_name=expr
        [, col_name=expr] ... ]
<span style="color: #a020f0;">INSERT</span> [LOW_PRIORITY | DELAYED | HIGH_PRIORITY] [<span style="color: #a020f0;">IGNORE</span>]
    [<span style="color: #a020f0;">INTO</span>] tbl_name
    <span style="color: #a020f0;">SET</span> col_name={expr | <span style="color: #a020f0;">DEFAULT</span>}, ...
    [ <span style="color: #a020f0;">ON</span> DUPLICATE <span style="color: #a020f0;">KEY</span> <span style="color: #a020f0;">UPDATE</span>
      col_name=expr
        [, col_name=expr] ... ]
<span style="color: #a020f0;">INSERT</span> [LOW_PRIORITY | HIGH_PRIORITY] [<span style="color: #a020f0;">IGNORE</span>]
    [<span style="color: #a020f0;">INTO</span>] tbl_name [(col_name,...)]
    <span style="color: #a020f0;">SELECT</span> ...
    [ <span style="color: #a020f0;">ON</span> DUPLICATE <span style="color: #a020f0;">KEY</span> <span style="color: #a020f0;">UPDATE</span>
      col_name=expr
        [, col_name=expr] ... ]
</pre>
</div>

<p>
简化写法：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">INSERT</span> tbl_name [(col1,...)] <span style="color: #a020f0;">VALUES</span> (val1,...), (val21,...)
</pre>
</div>


<p>
<b>方式1、全字段插入：</b>
</p>

<p>
语法格式：
</p>
<div class="org-src-container">
<pre class="src src-shell">insert into &#34920;&#21517; values(&#20540;1, &#20540;2, ... &#26368;&#21518;&#19968;&#20010;&#20540;);
</pre>
</div>

<p>
解释：
</p>
<ul class="org-ul">
<li>值的顺序必须与所有字段的顺序一致。</li>
<li>值的数据类型也必须与字段定义的数据类型一致。</li>
</ul>

<p>
举例（给表中插入一条完整的数据）：
</p>
<div class="org-src-container">
<pre class="src src-shell">insert into &#34920;&#21517; values(3, <span style="color: #8b2252;">'qianguyihao'</span>, 28);
</pre>
</div>

<p>
<b>方式2、部分字段插入：</b>
</p>

<p>
语法格式：
</p>
<div class="org-src-container">
<pre class="src src-shell">insert into &#34920;&#21517; (&#23383;&#27573;1, &#23383;&#27573;2, &#23383;&#27573;3) values(&#20540;1, &#20540;2, &#20540;3);
</pre>
</div>

<p>
解释：字段的顺序可以随意，但值的顺序必须要与前面的字段顺序一一对应，数
据类型也要一致。
</p>

<p>
举例（给表中的指定字段插入数据）：
</p>
<div class="org-src-container">
<pre class="src src-shell">insert into &#34920;&#21517; (id, name) values(4, <span style="color: #8b2252;">'xusong'</span>);
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #a020f0;">create</span> <span style="color: #a020f0;">table</span> student (id <span style="color: #228b22;">smallint</span> unsigned <span style="color: #a020f0;">primary</span> <span style="color: #a020f0;">key</span> auto_increment, <span style="color: #a020f0;">name</span> <span style="color: #228b22;">varchar</span>(10), age tinyint unsigned, gender enum(<span style="color: #8b2252;">'M'</span>,<span style="color: #8b2252;">'F'</span>) <span style="color: #a020f0;">default</span> <span style="color: #8b2252;">'M'</span>) ENGINE=InnoDB AUTO_INCREMENT=10 <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8;

mysql&gt; <span style="color: #a020f0;">insert</span> student(<span style="color: #a020f0;">name</span>,age) <span style="color: #a020f0;">values</span>(<span style="color: #8b2252;">'tom'</span>,22),(<span style="color: #8b2252;">'k'</span>,30);

mysql&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> student;
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+------+------+--------+</span>
| id | <span style="color: #a020f0;">name</span> | age  | gender |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+------+------+--------+</span>
| 10 | tom  |   22 | <span style="color: #a020f0;">M</span>      |
| 11 | k    |   30 | <span style="color: #a020f0;">M</span>      |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+------+------+--------+</span>

mysql&gt; <span style="color: #a020f0;">insert</span> student <span style="color: #a020f0;">values</span>(<span style="color: #a020f0;">null</span>,<span style="color: #8b2252;">'jasper'</span>,22,<span style="color: #8b2252;">'M'</span>),(<span style="color: #a020f0;">null</span>,<span style="color: #8b2252;">'q'</span>,22,<span style="color: #8b2252;">'F'</span>);

mysql&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> student;
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+--------+------+--------+</span>
| id | <span style="color: #a020f0;">name</span>   | age  | gender |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+--------+------+--------+</span>
| 10 | tom    |   22 | <span style="color: #a020f0;">M</span>      |
| 11 | k      |   30 | <span style="color: #a020f0;">M</span>      |
| 12 | jasper |   22 | <span style="color: #a020f0;">M</span>      |
| 13 | q      |   22 | F      |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+--------+------+--------+</span>

mysql&gt; <span style="color: #a020f0;">insert</span> student <span style="color: #a020f0;">values</span>(<span style="color: #a020f0;">null</span>,<span style="color: #8b2252;">'xxx'</span>,18,<span style="color: #a020f0;">default</span>);
Query OK, 1 <span style="color: #228b22;">row</span> affected (0.00 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bfba86b0-daaa-4777-8722-3d836af81d68" class="outline-4">
<h4 id="h:bfba86b0-daaa-4777-8722-3d836af81d68">UPDATE 语句</h4>
<div class="outline-text-4" id="text-h:bfba86b0-daaa-4777-8722-3d836af81d68">
<p>
语法：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">UPDATE</span> [LOW_PRIORITY] [<span style="color: #a020f0;">IGNORE</span>] table_reference
    <span style="color: #a020f0;">SET</span> col_name1={expr1|<span style="color: #a020f0;">DEFAULT</span>} [, col_name2={expr2|<span style="color: #a020f0;">DEFAULT</span>}] ...
    [<span style="color: #a020f0;">WHERE</span> where_condition]
    [<span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span> ...]
    [<span style="color: #a020f0;">LIMIT</span> <span style="color: #a020f0;">row_count</span>]
</pre>
</div>

<p>
注意： <b>一定要有限制条件，否则将修改所有行的指定字段</b>
</p>

<p>
可利用mysql 选项避免此错误：
</p>

<div class="org-src-container">
<pre class="src src-sql">mysql -U | <span style="color: #b22222;">--</span><span style="color: #b22222;">safe-updates| --i-am-a-dummy</span>

[root@centos8 ~]#vim /etc/my.cnf
[mysql]
safe-updates
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #a020f0;">update</span> student <span style="color: #a020f0;">set</span> gender=<span style="color: #8b2252;">'F'</span> <span style="color: #a020f0;">where</span> id=11;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:178af40d-46f8-4083-862b-08908a258541" class="outline-4">
<h4 id="h:178af40d-46f8-4083-862b-08908a258541">DELETE语句</h4>
<div class="outline-text-4" id="text-h:178af40d-46f8-4083-862b-08908a258541">
<p>
删除表中数据，但不会自动缩减数据文件的大小。
</p>

<p>
语法:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DELETE</span> [LOW_PRIORITY] [QUICK] [<span style="color: #a020f0;">IGNORE</span>] <span style="color: #a020f0;">FROM</span> tbl_name
    [<span style="color: #a020f0;">WHERE</span> where_condition]
    [<span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span> ...]
    [<span style="color: #a020f0;">LIMIT</span> <span style="color: #a020f0;">row_count</span>]
    &#21487;&#20808;&#25490;&#24207;&#20877;&#25351;&#23450;&#21024;&#38500;&#30340;&#34892;&#25968;
</pre>
</div>

<p>
注意： <b>一定要有限制条件，否则将清空表中的所有数据</b>
</p>

<p>
如果想清空表，保留表结构，也可以使用下面语句，此语句会自动缩减数据文件的大小。
</p>

<div class="org-src-container">
<pre class="src src-sql">TRUNCATE <span style="color: #a020f0;">TABLE</span> tbl_name;
</pre>
</div>

<p>
<b>缩减表大小</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">OPTIMIZE <span style="color: #a020f0;">TABLE</span> tb_name
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:a20665f6-5b6a-41cf-812d-232e2682d64c" class="outline-3">
<h3 id="h:a20665f6-5b6a-41cf-812d-232e2682d64c">DQL语句</h3>
<div class="outline-text-3" id="text-h:a20665f6-5b6a-41cf-812d-232e2682d64c">
</div>
<div id="outline-container-h:9091368c-62d0-4eac-bee9-7535e790f690" class="outline-4">
<h4 id="h:9091368c-62d0-4eac-bee9-7535e790f690">单表操作</h4>
<div class="outline-text-4" id="text-h:9091368c-62d0-4eac-bee9-7535e790f690">
<p>
语法：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span>
    [<span style="color: #a020f0;">ALL</span> | <span style="color: #a020f0;">DISTINCT</span> | DISTINCTROW ]
      [HIGH_PRIORITY]  #&#39640;&#20248;&#20808;&#32423;
      [STRAIGHT_JOIN]
      [SQL_SMALL_RESULT] [SQL_BIG_RESULT] [SQL_BUFFER_RESULT]
      [SQL_CACHE | SQL_NO_CACHE] [SQL_CALC_FOUND_ROWS]
    select_expr [, select_expr ...]
    [<span style="color: #a020f0;">FROM</span> table_references
    [<span style="color: #a020f0;">WHERE</span> where_condition]
    [<span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span> {col_name | expr | <span style="color: #a020f0;">position</span>}
      [<span style="color: #a020f0;">ASC</span> | <span style="color: #a020f0;">DESC</span>], ... [<span style="color: #a020f0;">WITH</span> <span style="color: #a020f0;">ROLLUP</span>]]
    [<span style="color: #a020f0;">HAVING</span> where_condition]
    [<span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span> {col_name | expr | <span style="color: #a020f0;">position</span>}
      [<span style="color: #a020f0;">ASC</span> | <span style="color: #a020f0;">DESC</span>], ...]
    [<span style="color: #a020f0;">LIMIT</span> {[offset,] <span style="color: #a020f0;">row_count</span> | <span style="color: #a020f0;">row_count</span> OFFSET offset}]
    [<span style="color: #a020f0;">PROCEDURE</span> procedure_name(argument_list)]
    [<span style="color: #a020f0;">INTO</span> OUTFILE <span style="color: #8b2252;">'file_name'</span>
        [<span style="color: #228b22;">CHARACTER</span> <span style="color: #a020f0;">SET</span> charset_name]
        export_options
      | <span style="color: #a020f0;">INTO</span> DUMPFILE <span style="color: #8b2252;">'file_name'</span>
      | <span style="color: #a020f0;">INTO</span> var_name [, var_name]]
    [<span style="color: #a020f0;">FOR</span> <span style="color: #a020f0;">UPDATE</span> | LOCK <span style="color: #a020f0;">IN</span> SHARE MODE]]
</pre>
</div>

<p>
<b>说明</b>:
</p>

<ul class="org-ul">
<li>字段显示可以使用别名:</li>
</ul>
<div class="org-src-container">
<pre class="src src-sql">col1 <span style="color: #a020f0;">AS</span> alias1, col2 <span style="color: #a020f0;">AS</span> alias2, ... <span style="color: #a020f0;">as</span>&#21487;&#30465;&#30053;
</pre>
</div>

<ul class="org-ul">
<li>WHERE子句：指明过滤条件以实现“选择”的功能：</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql">&#36807;&#28388;&#26465;&#20214;&#65306;&#24067;&#23572;&#22411;&#34920;&#36798;&#24335;
&#31639;&#26415;&#25805;&#20316;&#31526;&#65306;+, -, *, /, %
&#27604;&#36739;&#25805;&#20316;&#31526;&#65306;=,&lt;=&gt;&#65288;&#30456;&#31561;&#25110;&#37117;&#20026;&#31354;&#65289;, &lt;&gt;, !=(&#38750;&#26631;&#20934;<span style="color: #a020f0;">SQL</span>), &gt;,&gt;=, &lt;, &lt;=
&#33539;&#20363;&#26597;&#35810;&#65306;<span style="color: #a020f0;">BETWEEN</span> min_num <span style="color: #a020f0;">AND</span> max_num
&#19981;&#36830;&#32493;&#26597;&#35810;&#65306;<span style="color: #a020f0;">IN</span> (element1, element2, ...)   &#20174;&#25324;&#21495;&#20013;&#30340;&#20803;&#32032;&#21462;&#19968;&#20010;
&#31354;&#26597;&#35810;&#65306;<span style="color: #a020f0;">IS</span> <span style="color: #a020f0;">NULL</span>, <span style="color: #a020f0;">IS</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>
<span style="color: #a020f0;">DISTINCT</span> &#21435;&#38500;&#37325;&#22797;&#34892;&#65292;&#33539;&#20363;&#65306;<span style="color: #a020f0;">SELECT</span> <span style="color: #a020f0;">DISTINCT</span> gender <span style="color: #a020f0;">FROM</span> students;
&#27169;&#31946;&#26597;&#35810;&#65306;<span style="color: #a020f0;">LIKE</span> &#20351;&#29992; % &#34920;&#31034;&#20219;&#24847;&#38271;&#24230;&#30340;&#20219;&#24847;&#23383;&#31526;&#65292;_ &#34920;&#31034;&#20219;&#24847;&#21333;&#20010;&#23383;&#31526;
RLIKE&#65306;&#27491;&#21017;&#34920;&#36798;&#24335;&#65292;&#32034;&#24341;&#22833;&#25928;&#65292;&#19981;&#24314;&#35758;&#20351;&#29992;
REGEXP&#65306;&#21305;&#37197;&#23383;&#31526;&#20018;&#21487;&#29992;&#27491;&#21017;&#34920;&#36798;&#24335;&#20070;&#20889;&#27169;&#24335;&#65292;&#21516;&#19978;
&#36923;&#36753;&#25805;&#20316;&#31526;&#65306;<span style="color: #a020f0;">NOT</span>&#65292;<span style="color: #a020f0;">AND</span>&#65292;<span style="color: #a020f0;">OR</span>&#65292;XOR
</pre>
</div>

<ul class="org-ul">
<li>GROUP：根据指定的条件把查询结果进行“分组”以用于做“聚合”运算</li>
</ul>
<div class="org-src-container">
<pre class="src src-sh">&#24120;&#35265;&#32858;&#21512;&#20989;&#25968;&#65306;avg(), max(), min(), count(), sum()&#65292;&#27880;&#24847;&#32858;&#21512;&#20989;&#25968;&#19981;&#23545;null&#32479;&#35745;
HAVING: &#23545;&#20998;&#32452;&#32858;&#21512;&#36816;&#31639;&#21518;&#30340;&#32467;&#26524;&#25351;&#23450;&#36807;&#28388;&#26465;&#20214;
&#19968;&#26086;&#20998;&#32452;group by &#65292;select&#35821;&#21477;&#21518;&#21482;&#36319;&#20998;&#32452;&#30340;&#23383;&#27573;&#65292;&#32858;&#21512;&#20989;&#25968;
</pre>
</div>

<ul class="org-ul">
<li>ORDER BY: 根据指定的字段对查询结果进行排序
升序：ASC
降序：DESC</li>
<li><p>
LIMIT [[offset,]row_count]：对查询的结果进行输出行数数量限制
</p>
<ul class="org-ul">
<li>注意： select * from table limit m,n ，其中 m 是指记录开始，从
0 开始，表示第一条记录； n 是指从第 m+1 条开始，取 n 条</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#36820;&#22238;5&#26465;&#35760;&#24405;&#65292; [1,5]&#24038;&#38381;&#21491;&#38381;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">as</span> emp <span style="color: #a020f0;">LIMIT</span> 5;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#36820;&#22238;5&#26465;&#35760;&#24405;&#65292;&#20559;&#31227;3&#26465;&#65292;limit3, 5 ---  (3,3+5]&#24038;&#24320;&#21491;&#38381; start:end start:len &#20998;&#39029;&#29992;&#21040;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">as</span> emp <span style="color: #a020f0;">LIMIT</span> 3, 5;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31561;&#20215;&#20110;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">as</span> emp <span style="color: #a020f0;">LIMIT</span> 5 offset 3;
</pre>
</div></li>
<li><p>
对查询结果中的数据请求施加“锁”
</p>

<p>
FOR UPDATE: 写锁，独占或排它锁，只有一个读和写操作
</p>

<p>
LOCK IN SHARE MODE: 读锁，共享锁，同时多个读操作
</p></li>
</ul>
</div>
<div id="outline-container-h:11b01c3c-4ae7-4a7f-91be-6092858665e4" class="outline-5">
<h5 id="h:11b01c3c-4ae7-4a7f-91be-6092858665e4">范例DQL查询</h5>
<div class="outline-text-5" id="text-h:11b01c3c-4ae7-4a7f-91be-6092858665e4">
<p>
范例：字段别名
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> stuid &#23398;&#21592;ID,<span style="color: #a020f0;">name</span> <span style="color: #a020f0;">as</span> &#22995;&#21517;,gender &#24615;&#21035; <span style="color: #a020f0;">from</span> students;
+<span style="color: #b22222;">----------</span><span style="color: #b22222;">+---------------+--------+</span>
| &#23398;&#21592;ID   | &#22995;&#21517;        | &#24615;&#21035;   |
+<span style="color: #b22222;">----------</span><span style="color: #b22222;">+---------------+--------+</span>
|      1 | Shi Zhongyu   | <span style="color: #a020f0;">M</span>    |
|      2 | Shi Potian    | <span style="color: #a020f0;">M</span>    |
|      3 | Xie Yanke     | <span style="color: #a020f0;">M</span>    |
|      4 | Ding Dian     | <span style="color: #a020f0;">M</span>    |
|      5 | Yu Yutong     | <span style="color: #a020f0;">M</span>    |
|      6 | Shi Qing      | <span style="color: #a020f0;">M</span>    |
|      7 | Xi Ren      | F    |
|      8 | Lin Daiyu     | F    |
|      9 | Ren Yingying  | F    |
|       10 | Yue Lingshan  | F    |
|       11 | Yuan Chengzhi | <span style="color: #a020f0;">M</span>    |
|       12 | Wen Qingqing  | F    |
|       13 | Tian Boguang  | <span style="color: #a020f0;">M</span>    |
|       14 | Lu Wushuang   | F    |
|     15 | Duan Yu     | <span style="color: #a020f0;">M</span>    |
|     16 | Xu Zhu      | <span style="color: #a020f0;">M</span>    |
|     17 | Lin Chong     | <span style="color: #a020f0;">M</span>    |
|     18 | Hua Rong      | <span style="color: #a020f0;">M</span>    |
|     19 | Xue Baochai   | F    |
|     20 | Diao Chan     | F    |
|     21 | Huang Yueying | F    |
|     22 | Xiao Qiao     | F    |
|     23 | Ma Chao     | <span style="color: #a020f0;">M</span>    |
|     24 | Xu Xian     | <span style="color: #a020f0;">M</span>    |
|     25 | Sun Dasheng   | <span style="color: #a020f0;">M</span>    |
+<span style="color: #b22222;">----------</span><span style="color: #b22222;">+---------------+--------+</span>
25 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
</pre>
</div>

<p>
范例：简单查询
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DESC</span> students;
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> students <span style="color: #a020f0;">VALUES</span>(1,<span style="color: #8b2252;">'tom'</span>&#65292;<span style="color: #8b2252;">'m'</span>),(2,<span style="color: #8b2252;">'alice'</span>,<span style="color: #8b2252;">'f'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> students(id,<span style="color: #a020f0;">name</span>) <span style="color: #a020f0;">VALUES</span>(3,<span style="color: #8b2252;">'jack'</span>),(4,<span style="color: #8b2252;">'allen'</span>);
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">WHERE</span> id &lt; 3;
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">WHERE</span> gender=<span style="color: #8b2252;">'m'</span>;
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">WHERE</span> gender <span style="color: #a020f0;">IS</span> <span style="color: #a020f0;">NULL</span>;
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">WHERE</span> gender <span style="color: #a020f0;">IS</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>;
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span> <span style="color: #a020f0;">name</span> <span style="color: #a020f0;">DESC</span> <span style="color: #a020f0;">LIMIT</span> 2;
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span> <span style="color: #a020f0;">name</span> <span style="color: #a020f0;">DESC</span> <span style="color: #a020f0;">LIMIT</span> 1,2; 
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">WHERE</span> id &gt;=2 <span style="color: #a020f0;">and</span> id &lt;=4
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">WHERE</span> <span style="color: #a020f0;">BETWEEN</span> 2 <span style="color: #a020f0;">AND</span> 4
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">WHERE</span> <span style="color: #a020f0;">name</span> <span style="color: #a020f0;">LIKE</span> <span style="color: #8b2252;">'t%'</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">WHERE</span> <span style="color: #a020f0;">name</span> RLIKE <span style="color: #8b2252;">'.*[lo].*'</span>;
<span style="color: #a020f0;">SELECT</span> id stuid,<span style="color: #a020f0;">name</span> <span style="color: #a020f0;">as</span> stuname <span style="color: #a020f0;">FROM</span> students

<span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> classid <span style="color: #a020f0;">in</span> (1,3,5);
<span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> classid <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> (1,3,5);
</pre>
</div>

<p>
范例：判断是否为NULL
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> classid <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">null</span>;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+</span>
| StuID | <span style="color: #a020f0;">Name</span>        | Age | Gender | ClassID | TeacherID |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+</span>
|    24 | Xu Xian     | 27  | <span style="color: #a020f0;">M</span>    | <span style="color: #a020f0;">NULL</span>    | <span style="color: #a020f0;">NULL</span>      |
|    25 | Sun Dasheng | 100 | <span style="color: #a020f0;">M</span>    | <span style="color: #a020f0;">NULL</span>    | <span style="color: #a020f0;">NULL</span>      |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+</span>
2 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.002 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> classid &lt;=&gt; <span style="color: #a020f0;">null</span>;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+</span>
| StuID | <span style="color: #a020f0;">Name</span>      | Age | Gender | ClassID | TeacherID |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+</span>
| 24  | Xu Xian     | 27  | <span style="color: #a020f0;">M</span>    | <span style="color: #a020f0;">NULL</span>    | <span style="color: #a020f0;">NULL</span>      |
| 25  | Sun Dasheng | 100 | <span style="color: #a020f0;">M</span>    | <span style="color: #a020f0;">NULL</span>    | <span style="color: #a020f0;">NULL</span>      |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+</span>
2 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> classid <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">null</span>;
</pre>
</div>

<p>
范例： 去重
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> <span style="color: #a020f0;">distinct</span> gender <span style="color: #a020f0;">from</span> students ;
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+</span>
| gender |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+</span>
| <span style="color: #a020f0;">M</span>    |
| F    |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+</span>
2 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>

<p>
范例：分组统计
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#20998;&#32452;&#32479;&#35745;
<span style="color: #a020f0;">select</span> classid,<span style="color: #483d8b;">avg</span>(age) <span style="color: #a020f0;">as</span> &#24179;&#22343;&#24180;&#40836; <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> classid &gt; 3 <span style="color: #a020f0;">group</span> <span style="color: #a020f0;">by</span> classid <span style="color: #a020f0;">having</span> &#24179;&#22343;&#24180;&#40836; &gt;30 ;

<span style="color: #a020f0;">select</span> gender,<span style="color: #483d8b;">avg</span>(age) &#24179;&#22343;&#24180;&#40836; <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">group</span> <span style="color: #a020f0;">by</span> gender <span style="color: #a020f0;">having</span> gender=<span style="color: #8b2252;">'M'</span>;
<span style="color: #a020f0;">select</span> classid,gender,<span style="color: #483d8b;">avg</span>(age) <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">group</span> <span style="color: #a020f0;">by</span> classid,gender;
</pre>
</div>

<p>
范例：排序
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">select</span> classid,<span style="color: #483d8b;">sum</span>(age) <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> classid <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">null</span> <span style="color: #a020f0;">group</span> <span style="color: #a020f0;">by</span> classid <span style="color: #a020f0;">order</span> <span style="color: #a020f0;">by</span> classid;
<span style="color: #a020f0;">select</span> classid,<span style="color: #483d8b;">sum</span>(age) <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">group</span> <span style="color: #a020f0;">by</span> classid <span style="color: #a020f0;">having</span> classid <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">null</span> <span style="color: #a020f0;">order</span> <span style="color: #a020f0;">by</span> classid;
<span style="color: #a020f0;">select</span> classid,<span style="color: #483d8b;">sum</span>(age) <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> classid <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">null</span> <span style="color: #a020f0;">group</span> <span style="color: #a020f0;">by</span> classid <span style="color: #a020f0;">order</span> <span style="color: #a020f0;">by</span> classid <span style="color: #a020f0;">limit</span> 2,3; # <span style="color: #a020f0;">limit</span> 2,3 &#36339;&#36807;&#21069;2&#20010;&#24448;&#21518;&#30340;3&#20010;

#&#24517;&#39035;&#20808;&#36807;&#28388;&#65292;&#20877;&#25490;&#24207;
<span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> classid <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">null</span> <span style="color: #a020f0;">order</span> <span style="color: #a020f0;">by</span> gender <span style="color: #a020f0;">desc</span>, age <span style="color: #a020f0;">asc</span> ;

#&#22810;&#21015;&#25490;&#24207;
<span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">order</span> <span style="color: #a020f0;">by</span> gender <span style="color: #a020f0;">desc</span>, age <span style="color: #a020f0;">asc</span>;
</pre>
</div>

<p>
范例：正序排序，NULL记录排在最后
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#23545;classid &#27491;&#24207;&#25490;&#24207;&#65292;<span style="color: #a020f0;">NULL</span>&#35760;&#24405;&#25490;&#22312;&#26368;&#21518;
<span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">order</span> <span style="color: #a020f0;">by</span> -classid <span style="color: #a020f0;">desc</span> ;
</pre>
</div>

<p>
范例：分组和排序
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#20998;&#32452;&#21518;&#20877;&#25490;&#24207;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> gender,classid,<span style="color: #483d8b;">avg</span>(age) <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> classid <span style="color: #a020f0;">is</span>
<span style="color: #a020f0;">not</span> <span style="color: #a020f0;">null</span> <span style="color: #a020f0;">group</span> <span style="color: #a020f0;">by</span> gender,classid <span style="color: #a020f0;">order</span> <span style="color: #a020f0;">by</span> gender,classid;
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------+----------+</span>
| gender | classid | <span style="color: #483d8b;">avg</span>(age) |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------+----------+</span>
| F    |     1 | 19.0000  |
| F    |     3 | 18.3333  |
| F    |     6 | 20.0000  |
| F    |     7 | 18.0000  |
| F    |    77 | 18.0000  |
| F    |    93 | 18.0000  |
| <span style="color: #a020f0;">M</span>    |     1 | 21.5000  |
| <span style="color: #a020f0;">M</span>    |     2 | 35.2000  |
| <span style="color: #a020f0;">M</span>    |     3 | 23.0000  |
| <span style="color: #a020f0;">M</span>    |     4 | 23.6000  |
| <span style="color: #a020f0;">M</span>    |     5 | 46.0000  |
| <span style="color: #a020f0;">M</span>    |     6 | 23.0000  |
| <span style="color: #a020f0;">M</span>    |     7 | 23.0000  |
| <span style="color: #a020f0;">M</span>    |    94 | 18.0000  |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+---------+----------+</span>
14 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">order</span> <span style="color: #a020f0;">by</span> age <span style="color: #a020f0;">limit</span> 10;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+</span>
| StuID | <span style="color: #a020f0;">Name</span>      | Age | Gender | ClassID | TeacherID |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+</span>
| 14  | Lu Wushuang   | 17  | F      | 3     | <span style="color: #a020f0;">NULL</span>    |
| 8   | Lin Daiyu   | 17  | F    | 7     | <span style="color: #a020f0;">NULL</span>    |
| 33  | Miejue Shitai | 18  | F    | 77    | <span style="color: #a020f0;">NULL</span>    |
| 32  | Zhang Sanfeng | 18  | <span style="color: #a020f0;">M</span>    | 94    | <span style="color: #a020f0;">NULL</span>    |
| 27  | liudehua    | 18  | F    | 1     | <span style="color: #a020f0;">NULL</span>    |
| 34    | Lin Chaoying  | 18  | F    | 93    | <span style="color: #a020f0;">NULL</span>    |
| 19  | Xue Baochai   | 18  | F    | 6     | <span style="color: #a020f0;">NULL</span>    |
| 7   | Xi Ren    | 19  | F    | 3     | <span style="color: #a020f0;">NULL</span>    |
| 12  | Wen Qingqing  | 19  | F    | 1     | <span style="color: #a020f0;">NULL</span>    |
| 20    | Diao Chan   | 19  | F    | 7     | <span style="color: #a020f0;">NULL</span>    |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+</span>
10 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">order</span> <span style="color: #a020f0;">by</span> age <span style="color: #a020f0;">limit</span> 3,10;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+</span>
| StuID | <span style="color: #a020f0;">Name</span>      | Age | Gender | ClassID | TeacherID |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+</span>
| 34  | Lin Chaoying  | 18  | F      | 93    | <span style="color: #a020f0;">NULL</span>    |
| 19  | Xue Baochai   | 18  | F      | 6     | <span style="color: #a020f0;">NULL</span>    |
| 32  | Zhang Sanfeng | 18  | <span style="color: #a020f0;">M</span>      | 94    | <span style="color: #a020f0;">NULL</span>    |
| 27  | liudehua    | 18  | F    | 1     | <span style="color: #a020f0;">NULL</span>    |
| 20  | Diao Chan   | 19  | F    | 7     | <span style="color: #a020f0;">NULL</span>    |
| 12  | Wen Qingqing  | 19  | F      | 1     | <span style="color: #a020f0;">NULL</span>    |
| 10  | Yue Lingshan  | 19  | F      | 3     | <span style="color: #a020f0;">NULL</span>    |
| 15  | Duan Yu     | 19  | <span style="color: #a020f0;">M</span>    | 4     | <span style="color: #a020f0;">NULL</span>    |
| 7   | Xi Ren    | 19  | F      | 3     | <span style="color: #a020f0;">NULL</span>    |
| 29  | wuyanzu     | 19  | <span style="color: #a020f0;">M</span>      | 4     | <span style="color: #a020f0;">NULL</span>    |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+</span>
10 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> <span style="color: #a020f0;">distinct</span> age <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">order</span> <span style="color: #a020f0;">by</span> age <span style="color: #a020f0;">limit</span> 3 ;
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+</span>
| age |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+</span>
| 17  |
| 18  |
| 19  |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+</span>
3 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> <span style="color: #a020f0;">distinct</span> age <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">order</span> <span style="color: #a020f0;">by</span> age <span style="color: #a020f0;">limit</span> 3,5 ;
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+</span>
| age |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+</span>
| 20  |
| 21  |
| 22  |
| 23  |
| 25  |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+</span>
5 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>

<p>
范例：时间字段进行过滤查询
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [testdb]&gt;<span style="color: #a020f0;">create</span> <span style="color: #a020f0;">table</span> testdate (id <span style="color: #228b22;">int</span>,<span style="color: #228b22;">date</span> <span style="color: #228b22;">timestamp</span> <span style="color: #a020f0;">DEFAULT</span>
<span style="color: #483d8b;">CURRENT_TIMESTAMP</span> );
MariaDB [testdb]&gt; <span style="color: #a020f0;">insert</span> testdate (id) <span style="color: #a020f0;">values</span>(1);
MariaDB [testdb]&gt; <span style="color: #a020f0;">insert</span> testdate (id) <span style="color: #a020f0;">values</span>(2);

MariaDB [testdb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> testdate;
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+---------------------+</span>
| id | <span style="color: #228b22;">date</span>          |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+---------------------+</span>
| 1  | 2020-06-03 15:21:03 |
| 2  | 2020-06-03 15:21:12 |
| 3  | 2020-06-03 15:21:14 |
| 4  | 2020-06-03 15:21:17 |
| 5  | 2020-06-03 18:27:39 |
| 6  | 2020-06-03 18:27:44 |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+---------------------+</span>
6 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> testdate <span style="color: #a020f0;">where</span> <span style="color: #228b22;">date</span> <span style="color: #a020f0;">between</span> <span style="color: #8b2252;">'2020-06-03</span>
<span style="color: #8b2252;">15:21:12'</span> <span style="color: #a020f0;">and</span> <span style="color: #8b2252;">'2020-06-03 18:27:40'</span>;
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+---------------------+</span>
| id |          <span style="color: #228b22;">date</span> |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+---------------------+</span>
| 2  | 2020-06-03 15:21:12 |
| 3  | 2020-06-03 15:21:14 |
| 4  | 2020-06-03 15:21:17 |
| 5  | 2020-06-03 18:27:39 |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+---------------------+</span>
4 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> testdate <span style="color: #a020f0;">where</span> <span style="color: #228b22;">date</span> &gt;= <span style="color: #8b2252;">'2020-06-03 15:21:12'</span>
<span style="color: #a020f0;">and</span> <span style="color: #228b22;">date</span> &lt;= <span style="color: #8b2252;">'2020-06-03 18:27:40'</span>;
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+---------------------+</span>
| id |         <span style="color: #228b22;">date</span>  |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+---------------------+</span>
| 2  | 2020-06-03 15:21:12 |
| 3  | 2020-06-03 15:21:14 |
| 4  | 2020-06-03 15:21:17 |
| 5  | 2020-06-03 18:27:39 |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+---------------------+</span>
4 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5fbd7b8a-f187-4d67-84e0-f9b0e04fd160" class="outline-5">
<h5 id="h:5fbd7b8a-f187-4d67-84e0-f9b0e04fd160">范例：SQL 注入攻击</h5>
<div class="outline-text-5" id="text-h:5fbd7b8a-f187-4d67-84e0-f9b0e04fd160">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> <span style="color: #483d8b;">user</span> <span style="color: #a020f0;">where</span> <span style="color: #a020f0;">name</span>=<span style="color: #8b2252;">'admin'</span> <span style="color: #a020f0;">and</span> password=<span style="color: #8b2252;">''</span> <span style="color: #a020f0;">or</span> <span style="color: #8b2252;">'1'</span>=<span style="color: #8b2252;">'1'</span>;
<span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> <span style="color: #483d8b;">user</span> <span style="color: #a020f0;">where</span> <span style="color: #a020f0;">name</span>=<span style="color: #8b2252;">'admin'</span> <span style="color: #a020f0;">and</span> password=<span style="color: #8b2252;">''</span> <span style="color: #a020f0;">or</span> <span style="color: #8b2252;">'1=1'</span>;
<span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> <span style="color: #483d8b;">user</span> <span style="color: #a020f0;">where</span> <span style="color: #a020f0;">name</span>=<span style="color: #8b2252;">'admin'</span>; <span style="color: #b22222;">-- </span><span style="color: #b22222;">' and password='xxx123';</span>
<span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> <span style="color: #483d8b;">user</span> <span style="color: #a020f0;">where</span> <span style="color: #a020f0;">name</span>=<span style="color: #8b2252;">'admin'</span>; # <span style="color: #8b2252;">' and password='</span>xxx123<span style="color: #8b2252;">';</span>
</pre>
</div>

<p>
范例：sql 注入
</p>

<p>
存在隐式转换。跟字段类型有关，如果是数字类型，'1ssss' 隐式转换为 1
</p>

<p>
<b>隐式转换</b> ：某个参数的类型是int类型，当给参数赋值时给的是string类型，
mysql就会识别string的第一个字符，如果第一个字符是数字就会被转换成int类
型，否则转换失败不会向后执行。
</p>


<div class="org-src-container">
<pre class="src src-sql">mysql&gt; <span style="color: #a020f0;">create</span> <span style="color: #a020f0;">table</span> <span style="color: #483d8b;">user</span> (id <span style="color: #228b22;">int</span> <span style="color: #a020f0;">primary</span> <span style="color: #a020f0;">key</span> auto_increment,<span style="color: #a020f0;">name</span> <span style="color: #228b22;">varchar</span>(20) <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">null</span>,password <span style="color: #228b22;">varchar</span>(30) <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">null</span>);
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.04 sec)

mysql&gt; <span style="color: #a020f0;">desc</span> <span style="color: #483d8b;">user</span>;
+<span style="color: #b22222;">----------</span><span style="color: #b22222;">+-------------+------+-----+---------+----------------+</span>
| Field    | <span style="color: #a020f0;">Type</span>        | <span style="color: #a020f0;">Null</span> | <span style="color: #a020f0;">Key</span> | <span style="color: #a020f0;">Default</span> | Extra          |
+<span style="color: #b22222;">----------</span><span style="color: #b22222;">+-------------+------+-----+---------+----------------+</span>
| id       | <span style="color: #228b22;">int</span>(11)     | <span style="color: #a020f0;">NO</span>   | PRI | <span style="color: #a020f0;">NULL</span>    | auto_increment |
| <span style="color: #a020f0;">name</span>     | <span style="color: #228b22;">varchar</span>(20) | <span style="color: #a020f0;">NO</span>   |     | <span style="color: #a020f0;">NULL</span>    |                |
| password | <span style="color: #228b22;">varchar</span>(30) | <span style="color: #a020f0;">NO</span>   |     | <span style="color: #a020f0;">NULL</span>    |                |
+<span style="color: #b22222;">----------</span><span style="color: #b22222;">+-------------+------+-----+---------+----------------+</span>
3 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.00 sec)

mysql&gt; <span style="color: #a020f0;">insert</span> <span style="color: #483d8b;">user</span> <span style="color: #a020f0;">values</span>(<span style="color: #a020f0;">null</span>,<span style="color: #8b2252;">'admin'</span>,<span style="color: #8b2252;">'123456'</span>);
Query OK, 1 <span style="color: #228b22;">row</span> affected (0.01 sec)

mysql&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> <span style="color: #483d8b;">user</span> <span style="color: #a020f0;">where</span> <span style="color: #a020f0;">name</span>=<span style="color: #8b2252;">'admin'</span> <span style="color: #a020f0;">and</span> password=<span style="color: #8b2252;">'123456'</span>;
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------+----------+</span>
| id | <span style="color: #a020f0;">name</span>  | password |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------+----------+</span>
|  1 | <span style="color: #a020f0;">admin</span> | 123456   |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------+----------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.00 sec)

mysql&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> <span style="color: #483d8b;">user</span> <span style="color: #a020f0;">where</span> <span style="color: #a020f0;">name</span>=<span style="color: #8b2252;">'admin'</span> <span style="color: #a020f0;">and</span> password=<span style="color: #8b2252;">'12345'</span>;
Empty <span style="color: #a020f0;">set</span> (0.00 sec)


# &#21019;&#24314;&#19968;&#20010;&#29305;&#27530;&#30340;&#23494;&#30721; <span style="color: #8b2252;">'or'</span>1<span style="color: #8b2252;">'='</span>1
# <span style="color: #a020f0;">name</span>=<span style="color: #8b2252;">'admin'</span> <span style="color: #a020f0;">and</span> password=<span style="color: #8b2252;">''</span><span style="color: #a020f0;">or</span><span style="color: #8b2252;">'1'</span>=<span style="color: #8b2252;">'1'</span>
mysql&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> <span style="color: #483d8b;">user</span> <span style="color: #a020f0;">where</span> <span style="color: #a020f0;">name</span>=<span style="color: #8b2252;">'admin'</span> <span style="color: #a020f0;">and</span> password=<span style="color: #8b2252;">''</span><span style="color: #a020f0;">or</span><span style="color: #8b2252;">'1'</span>=<span style="color: #8b2252;">'1'</span>;
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------+----------+</span>
| id | <span style="color: #a020f0;">name</span>  | password |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------+----------+</span>
|  1 | <span style="color: #a020f0;">admin</span> | 123456   |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------+----------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.00 sec)


mysql&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> <span style="color: #483d8b;">user</span> <span style="color: #a020f0;">where</span> <span style="color: #a020f0;">name</span>=<span style="color: #8b2252;">'admin'</span>; <span style="color: #b22222;">-- </span><span style="color: #b22222;">' and password='xxx123';</span>
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------+----------+</span>
| id | <span style="color: #a020f0;">name</span>  | password |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------+----------+</span>
|  1 | <span style="color: #a020f0;">admin</span> | 123456   |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------+----------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.00 sec)

mysql&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> <span style="color: #483d8b;">user</span> <span style="color: #a020f0;">where</span> <span style="color: #a020f0;">name</span>=<span style="color: #8b2252;">'admin'</span>; # <span style="color: #8b2252;">' and password='</span>xxx123<span style="color: #8b2252;">';</span>
<span style="color: #8b2252;">+----+-------+----------+</span>
<span style="color: #8b2252;">| id | name  | password |</span>
<span style="color: #8b2252;">+----+-------+----------+</span>
<span style="color: #8b2252;">|  1 | admin | 123456   |</span>
<span style="color: #8b2252;">+----+-------+----------+</span>
<span style="color: #8b2252;">1 row in set (0.00 sec)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:4f013738-cd22-4e8d-a0d0-ab36ca8720b6" class="outline-4">
<h4 id="h:4f013738-cd22-4e8d-a0d0-ab36ca8720b6">多表查询</h4>
<div class="outline-text-4" id="text-h:4f013738-cd22-4e8d-a0d0-ab36ca8720b6">

<figure id="orgf75b56e">
<img src="./images/clipboard-bbdb33d8.png" alt="clipboard-bbdb33d8.png" width="90%">

</figure>

<p>
多表查询，即查询结果来自于多张表
</p>

<ul class="org-ul">
<li>子查询：在SQL语句嵌套着查询语句，性能较差，基于某语句的查询结果再次进行的查询</li>
<li>联合查询：UNION</li>
<li>交叉连接：笛卡尔乘积</li>
<li>内连接：
<ul class="org-ul">
<li>等值连接：让表之间的字段以“等值”建立连接关系</li>
<li>不等值连接</li>
<li>自然连接：去掉重复列的等值连接，语法：FROM table NATURAL JOIN table2;</li>
</ul></li>
<li>外连接：
<ul class="org-ul">
<li>左外连接：FROM tb1 LEFT JOIN tb2 ON tb1.col=tb2.col</li>
<li>右外连接：FROM tb1 RIGHT JOIN tb2 ON tb1.col=tb2.col</li>
<li>完全外连接：FROM tb1 FULL OUTER JOIN tb2 ON tb1.col=tb2.col 注意：MySQL不支持此SQL语法</li>
</ul></li>
<li>自连接：本表和本表进行连接查询</li>
</ul>
</div>
<div id="outline-container-h:1b243197-450a-4923-9c0a-f31824d60c4d" class="outline-5">
<h5 id="h:1b243197-450a-4923-9c0a-f31824d60c4d">子查询</h5>
<div class="outline-text-5" id="text-h:1b243197-450a-4923-9c0a-f31824d60c4d">
<p>
常用在WHERE子句中的子查询
</p>

<ol class="org-ol">
<li>用于比较表达式中的子查询；子查询仅能返回单个值</li>
</ol>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> <span style="color: #a020f0;">Name</span>,Age <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">WHERE</span> Age&gt;(<span style="color: #a020f0;">SELECT</span> <span style="color: #483d8b;">avg</span>(Age) <span style="color: #a020f0;">FROM</span> students);
</pre>
</div>

<ol class="org-ol">
<li>用于IN中的子查询：子查询应该单键查询并返回一个或多个值从构成列表</li>
</ol>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> <span style="color: #a020f0;">Name</span>,Age <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">WHERE</span> Age <span style="color: #a020f0;">IN</span> (<span style="color: #a020f0;">SELECT</span> Age <span style="color: #a020f0;">FROM</span> teachers);
</pre>
</div>

<ol class="org-ol">
<li>用于EXISTS 和 Not EXISTS</li>
</ol>

<p>
参考链接：<a href="https://dev.mysql.com/doc/refman/8.0/en/exists-and-not-exists-subqueries.html">https://dev.mysql.com/doc/refman/8.0/en/exists-and-not-exists-subqueries.html</a>
</p>

<p>
EXISTS(包括 NOT EXISTS )子句的返回值是一个BOOL值。 EXISTS内部有一个子
查询语句(SELECT&#x2026; FROM&#x2026;)，将其称为EXIST的内查询语句。其内查询语句返
回一个结果集。EXISTS子句根据其内查询语句的结果集空或者非空，返回一个布
尔值。将外查询表的每一行，代入内查询作为检验，如果内查询返回的结果为非
空值，则EXISTS子句返回TRUE，外查询的这一行数据便可作为外查询的结果行返
回，否则不能作为结果
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">Select</span> * <span style="color: #a020f0;">from</span> TableA a <span style="color: #a020f0;">where</span> <span style="color: #a020f0;">Exists</span> &#65288;<span style="color: #a020f0;">Select</span> * <span style="color: #a020f0;">from</span> TableB b <span style="color: #a020f0;">where</span>
a.id=b.id <span style="color: #a020f0;">and</span> a.<span style="color: #a020f0;">name</span>=b.<span style="color: #a020f0;">name</span>&#65289;;
#TableA a &#32473;&#34920;TableA&#21462;&#21035;&#21517;&#20026;a

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students s <span style="color: #a020f0;">where</span> <span style="color: #a020f0;">EXISTS</span> (<span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> teachers t <span style="color: #a020f0;">where</span> s.teacherid=t.tid);
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+</span>
| StuID | <span style="color: #a020f0;">Name</span>        | Age | Gender | ClassID | TeacherID |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+</span>
|     1 | Shi Zhongyu |  22 | <span style="color: #a020f0;">M</span>      |       2 |         3 |
|     4 | Ding Dian   |  32 | <span style="color: #a020f0;">M</span>      |       4 |         4 |
|     5 | Yu Yutong   |  26 | <span style="color: #a020f0;">M</span>      |       3 |         1 |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+</span>
3 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students s <span style="color: #a020f0;">where</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">EXISTS</span> (<span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> teachers t <span style="color: #a020f0;">where</span> s.teacherid=t.tid);
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+</span>
| StuID | <span style="color: #a020f0;">Name</span>          | Age | Gender | ClassID | TeacherID |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+</span>
|     2 | Shi Potian    |  22 | <span style="color: #a020f0;">M</span>      |       1 |         7 |
|     3 | Xie Yanke     |  53 | <span style="color: #a020f0;">M</span>      |       2 |        16 |
|     6 | Shi Qing      |  46 | <span style="color: #a020f0;">M</span>      |       5 |      <span style="color: #a020f0;">NULL</span> |
|     7 | Xi Ren        |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> |
|     8 | Lin Daiyu     |  17 | F      |       7 |      <span style="color: #a020f0;">NULL</span> |
|     9 | Ren Yingying  |  20 | F      |       6 |      <span style="color: #a020f0;">NULL</span> |
|    10 | Yue Lingshan  |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> |
|    11 | Yuan Chengzhi |  23 | <span style="color: #a020f0;">M</span>      |       6 |      <span style="color: #a020f0;">NULL</span> |
|    12 | Wen Qingqing  |  19 | F      |       1 |      <span style="color: #a020f0;">NULL</span> |
|    13 | Tian Boguang  |  33 | <span style="color: #a020f0;">M</span>      |       2 |      <span style="color: #a020f0;">NULL</span> |
|    14 | Lu Wushuang   |  17 | F      |       3 |      <span style="color: #a020f0;">NULL</span> |
|    15 | Duan Yu       |  19 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> |
|    16 | Xu Zhu        |  21 | <span style="color: #a020f0;">M</span>      |       1 |      <span style="color: #a020f0;">NULL</span> |
|    17 | Lin Chong     |  25 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> |
|    18 | Hua Rong      |  23 | <span style="color: #a020f0;">M</span>      |       7 |      <span style="color: #a020f0;">NULL</span> |
|    19 | Xue Baochai   |  18 | F      |       6 |      <span style="color: #a020f0;">NULL</span> |
|    20 | Diao Chan     |  19 | F      |       7 |      <span style="color: #a020f0;">NULL</span> |
|    21 | Huang Yueying |  22 | F      |       6 |      <span style="color: #a020f0;">NULL</span> |
|    22 | Xiao Qiao     |  20 | F      |       1 |      <span style="color: #a020f0;">NULL</span> |
|    23 | Ma Chao       |  23 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> |
|    24 | Xu Xian       |  27 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> |
|    25 | Sun Dasheng   | 100 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+</span>
22 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>

<p>
说明：
</p>
<ul class="org-ul">
<li>Exists（Not Exists）用在where之后，且后面紧跟子查询语句（带括号）</li>
<li>Not Exists(Exists) 只关心子查询有没有结果,并不关心子查询的结果具体是什么</li>
<li>把TableA的记录逐条代入到子查询，如果子查询结果集为空，说明不存在，那
么这条TableA的记录出现在最终结果集，否则被排除</li>
<li>用于FROM子句中的子查询</li>
</ul>

<p>
使用格式：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> tb_alias.col1,... <span style="color: #a020f0;">FROM</span> (<span style="color: #a020f0;">SELECT</span> clause) <span style="color: #a020f0;">AS</span> tb_alias <span style="color: #a020f0;">WHERE</span> Clause;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> s.aage,s.ClassID <span style="color: #a020f0;">FROM</span> (<span style="color: #a020f0;">SELECT</span> <span style="color: #483d8b;">avg</span>(Age) <span style="color: #a020f0;">AS</span> aage,ClassID <span style="color: #a020f0;">FROM</span> students
<span style="color: #a020f0;">WHERE</span> ClassID <span style="color: #a020f0;">IS</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> <span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span> ClassID) <span style="color: #a020f0;">AS</span> s <span style="color: #a020f0;">WHERE</span> s.aage&gt;30;
</pre>
</div>

<p>
范例：子查询
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#23376;&#26597;&#35810;&#65306;<span style="color: #a020f0;">select</span> &#30340;&#25191;&#34892;&#32467;&#26524;&#65292;&#34987;&#20854;&#23427;<span style="color: #a020f0;">SQL</span>&#35843;&#29992;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> stuid,<span style="color: #a020f0;">name</span>,age <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> age &gt; (<span style="color: #a020f0;">select</span> <span style="color: #483d8b;">avg</span>(age) <span style="color: #a020f0;">from</span> students);
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+--------------+-----+</span>
| stuid | <span style="color: #a020f0;">name</span>         | age |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+--------------+-----+</span>
|     3 | Xie Yanke    |  53 |
|     4 | Ding Dian    |  32 |
|     6 | Shi Qing     |  46 |
|    13 | Tian Boguang |  33 |
|    25 | Sun Dasheng  | 100 |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+--------------+-----+</span>
5 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>

<p>
范例：子查询用于更新表
</p>

<div class="org-src-container">
<pre class="src src-sql">&#25226;&#22235;&#21495;&#32769;&#24072;&#30340;&#24180;&#40836;&#26356;&#25913;&#20026;&#23398;&#29983;&#30340;&#24179;&#22343;&#24180;&#40836;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">update</span> teachers <span style="color: #a020f0;">set</span> age=(<span style="color: #a020f0;">select</span> <span style="color: #483d8b;">avg</span>(age) <span style="color: #a020f0;">from</span> students) <span style="color: #a020f0;">where</span> tid=4;
Query OK, 1 <span style="color: #228b22;">row</span> affected (0.003 sec)
<span style="color: #a020f0;">Rows</span> matched: 1  Changed: 1  Warnings: 0

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> teachers;
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+---------------+-----+--------+</span>
| TID | <span style="color: #a020f0;">Name</span>          | Age | Gender |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+---------------+-----+--------+</span>
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |
|   3 | Miejue Shitai |  77 | F      |
|   4 | Lin Chaoying  |  29 | F      |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+---------------+-----+--------+</span>
4 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:dce359a5-2421-4c85-adbe-81ab03823140" class="outline-5">
<h5 id="h:dce359a5-2421-4c85-adbe-81ab03823140">联合查询：UNION</h5>
<div class="outline-text-5" id="text-h:dce359a5-2421-4c85-adbe-81ab03823140">
<p>
联合查询 Union 实现的条件，多个表的字段数量相同，字段名和数据类型可以
不同，但一般数据类型是相同的。
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> <span style="color: #a020f0;">Name</span>,Age <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">UNION</span> <span style="color: #a020f0;">SELECT</span> <span style="color: #a020f0;">Name</span>,Age <span style="color: #a020f0;">FROM</span> teachers;
</pre>
</div>

<p>
union 去重
union all 重复字段也会显示
</p>

<p>
范例：联合查询
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#22810;&#34920;&#32437;&#21521;&#21512;&#24182;<span style="color: #a020f0;">union</span>
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> teachers <span style="color: #a020f0;">union</span> <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> teachers <span style="color: #a020f0;">union</span> <span style="color: #a020f0;">select</span> stuid,<span style="color: #a020f0;">name</span>,age,gender <span style="color: #a020f0;">from</span> students;
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+---------------+-----+--------+</span>
| TID | <span style="color: #a020f0;">Name</span>          | Age | Gender |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+---------------+-----+--------+</span>
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |
|   3 | Miejue Shitai |  77 | F      |
|   4 | Lin Chaoying  |  29 | F      |
|   1 | Shi Zhongyu   |  45 | <span style="color: #a020f0;">M</span>      |
|   2 | Shi Potian    |  22 | <span style="color: #a020f0;">M</span>      |
|   3 | Xie Yanke     |  77 | <span style="color: #a020f0;">M</span>      |
|   4 | Ding Dian     |  32 | <span style="color: #a020f0;">M</span>      |
|   5 | Yu Yutong     |  26 | <span style="color: #a020f0;">M</span>      |
|   6 | Shi Qing      |  46 | <span style="color: #a020f0;">M</span>      |
|   7 | Xi Ren        |  19 | F      |
|   8 | Lin Daiyu     |  17 | F      |
|   9 | Ren Yingying  |  20 | F      |
|  10 | Yue Lingshan  |  19 | F      |
|  11 | Yuan Chengzhi |  23 | <span style="color: #a020f0;">M</span>      |
|  12 | Wen Qingqing  |  19 | F      |
|  13 | Tian Boguang  |  33 | <span style="color: #a020f0;">M</span>      |
|  14 | Lu Wushuang   |  17 | F      |
|  15 | Duan Yu       |  19 | <span style="color: #a020f0;">M</span>      |
|  16 | Xu Zhu        |  21 | <span style="color: #a020f0;">M</span>      |
|  17 | Lin Chong     |  25 | <span style="color: #a020f0;">M</span>      |
|  18 | Hua Rong      |  23 | <span style="color: #a020f0;">M</span>      |
|  19 | Xue Baochai   |  18 | F      |
|  20 | Diao Chan     |  19 | F      |
|  21 | Huang Yueying |  22 | F      |
|  22 | Xiao Qiao     |  20 | F      |
|  23 | Ma Chao       |  23 | <span style="color: #a020f0;">M</span>      |
|  24 | Xu Xian       |  27 | <span style="color: #a020f0;">M</span>      |
|  25 | Sun Dasheng   | 100 | <span style="color: #a020f0;">M</span>      |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+---------------+-----+--------+</span>
29 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.002 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> teachers <span style="color: #a020f0;">union</span> <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> teachers;
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+---------------+-----+--------+</span>
| TID | <span style="color: #a020f0;">Name</span>          | Age | Gender |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+---------------+-----+--------+</span>
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |
|   3 | Miejue Shitai |  77 | F      |
|   4 | Lin Chaoying  |  29 | F      |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+---------------+-----+--------+</span>
4 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> teachers <span style="color: #a020f0;">union</span> <span style="color: #a020f0;">all</span> <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> teachers;
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+---------------+-----+--------+</span>
| TID | <span style="color: #a020f0;">Name</span>          | Age | Gender |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+---------------+-----+--------+</span>
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |
|   3 | Miejue Shitai |  77 | F      |
|   4 | Lin Chaoying  |  29 | F      |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |
|   3 | Miejue Shitai |  77 | F      |
|   4 | Lin Chaoying  |  29 | F      |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+---------------+-----+--------+</span>
8 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3a8b03fe-e27a-4121-8ff9-a12cedd4c88a" class="outline-5">
<h5 id="h:3a8b03fe-e27a-4121-8ff9-a12cedd4c88a">交叉连接</h5>
<div class="outline-text-5" id="text-h:3a8b03fe-e27a-4121-8ff9-a12cedd4c88a">
<p>
即笛卡尔乘积，"雨露均沾"，横向合并，利用 cross join实现
</p>

<p>
范例：交叉连接
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#27178;&#21521;&#21512;&#24182;&#65292;&#20132;&#21449;&#36830;&#25509;&#65288;&#27178;&#21521;&#31515;&#21345;&#23572;&#65289;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">cross</span> <span style="color: #a020f0;">join</span> teachers;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> teachers,students;
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+---------------+-----+--------+-------+---------------+-----+--------+---------+-----------+</span>
| TID | <span style="color: #a020f0;">Name</span>          | Age | Gender | StuID | <span style="color: #a020f0;">Name</span>          | Age | Gender | ClassID | TeacherID |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+---------------+-----+--------+-------+---------------+-----+--------+---------+-----------+</span>
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |     1 | Shi Zhongyu   |  45 | <span style="color: #a020f0;">M</span>      |       2 |         3 |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |     1 | Shi Zhongyu   |  45 | <span style="color: #a020f0;">M</span>      |       2 |         3 |
|   3 | Miejue Shitai |  77 | F      |     1 | Shi Zhongyu   |  45 | <span style="color: #a020f0;">M</span>      |       2 |         3 |
|   4 | Lin Chaoying  |  29 | F      |     1 | Shi Zhongyu   |  45 | <span style="color: #a020f0;">M</span>      |       2 |         3 |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |     2 | Shi Potian    |  22 | <span style="color: #a020f0;">M</span>      |       1 |         7 |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |     2 | Shi Potian    |  22 | <span style="color: #a020f0;">M</span>      |       1 |         7 |
|   3 | Miejue Shitai |  77 | F      |     2 | Shi Potian    |  22 | <span style="color: #a020f0;">M</span>      |       1 |         7 |
|   4 | Lin Chaoying  |  29 | F      |     2 | Shi Potian    |  22 | <span style="color: #a020f0;">M</span>      |       1 |         7 |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |     3 | Xie Yanke     |  77 | <span style="color: #a020f0;">M</span>      |       2 |        16 |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |     3 | Xie Yanke     |  77 | <span style="color: #a020f0;">M</span>      |       2 |        16 |
|   3 | Miejue Shitai |  77 | F      |     3 | Xie Yanke     |  77 | <span style="color: #a020f0;">M</span>      |       2 |        16 |
|   4 | Lin Chaoying  |  29 | F      |     3 | Xie Yanke     |  77 | <span style="color: #a020f0;">M</span>      |       2 |        16 |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |     4 | Ding Dian     |  32 | <span style="color: #a020f0;">M</span>      |       4 |         4 |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |     4 | Ding Dian     |  32 | <span style="color: #a020f0;">M</span>      |       4 |         4 |
|   3 | Miejue Shitai |  77 | F      |     4 | Ding Dian     |  32 | <span style="color: #a020f0;">M</span>      |       4 |         4 |
|   4 | Lin Chaoying  |  29 | F      |     4 | Ding Dian     |  32 | <span style="color: #a020f0;">M</span>      |       4 |         4 |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |     5 | Yu Yutong     |  26 | <span style="color: #a020f0;">M</span>      |       3 |         1 |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |     5 | Yu Yutong     |  26 | <span style="color: #a020f0;">M</span>      |       3 |         1 |
|   3 | Miejue Shitai |  77 | F      |     5 | Yu Yutong     |  26 | <span style="color: #a020f0;">M</span>      |       3 |         1 |
|   4 | Lin Chaoying  |  29 | F      |     5 | Yu Yutong     |  26 | <span style="color: #a020f0;">M</span>      |       3 |         1 |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |     6 | Shi Qing      |  46 | <span style="color: #a020f0;">M</span>      |       5 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |     6 | Shi Qing      |  46 | <span style="color: #a020f0;">M</span>      |       5 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |     6 | Shi Qing      |  46 | <span style="color: #a020f0;">M</span>      |       5 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |     6 | Shi Qing      |  46 | <span style="color: #a020f0;">M</span>      |       5 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |     7 | Xi Ren        |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |     7 | Xi Ren        |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |     7 | Xi Ren        |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |     7 | Xi Ren        |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |     8 | Lin Daiyu     |  17 | F      |       7 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |     8 | Lin Daiyu     |  17 | F      |       7 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |     8 | Lin Daiyu     |  17 | F      |       7 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |     8 | Lin Daiyu     |  17 | F      |       7 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |     9 | Ren Yingying  |  20 | F      |       6 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |     9 | Ren Yingying  |  20 | F      |       6 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |     9 | Ren Yingying  |  20 | F      |       6 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |     9 | Ren Yingying  |  20 | F      |       6 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |    10 | Yue Lingshan  |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |    10 | Yue Lingshan  |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |    10 | Yue Lingshan  |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |    10 | Yue Lingshan  |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |    11 | Yuan Chengzhi |  23 | <span style="color: #a020f0;">M</span>      |       6 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |    11 | Yuan Chengzhi |  23 | <span style="color: #a020f0;">M</span>      |       6 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |    11 | Yuan Chengzhi |  23 | <span style="color: #a020f0;">M</span>      |       6 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |    11 | Yuan Chengzhi |  23 | <span style="color: #a020f0;">M</span>      |       6 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |    12 | Wen Qingqing  |  19 | F      |       1 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |    12 | Wen Qingqing  |  19 | F      |       1 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |    12 | Wen Qingqing  |  19 | F      |       1 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |    12 | Wen Qingqing  |  19 | F      |       1 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |    13 | Tian Boguang  |  33 | <span style="color: #a020f0;">M</span>      |       2 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |    13 | Tian Boguang  |  33 | <span style="color: #a020f0;">M</span>      |       2 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |    13 | Tian Boguang  |  33 | <span style="color: #a020f0;">M</span>      |       2 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |    13 | Tian Boguang  |  33 | <span style="color: #a020f0;">M</span>      |       2 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |    14 | Lu Wushuang   |  17 | F      |       3 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |    14 | Lu Wushuang   |  17 | F      |       3 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |    14 | Lu Wushuang   |  17 | F      |       3 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |    14 | Lu Wushuang   |  17 | F      |       3 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |    15 | Duan Yu       |  19 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |    15 | Duan Yu       |  19 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |    15 | Duan Yu       |  19 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |    15 | Duan Yu       |  19 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |    16 | Xu Zhu        |  21 | <span style="color: #a020f0;">M</span>      |       1 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |    16 | Xu Zhu        |  21 | <span style="color: #a020f0;">M</span>      |       1 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |    16 | Xu Zhu        |  21 | <span style="color: #a020f0;">M</span>      |       1 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |    16 | Xu Zhu        |  21 | <span style="color: #a020f0;">M</span>      |       1 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |    17 | Lin Chong     |  25 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |    17 | Lin Chong     |  25 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |    17 | Lin Chong     |  25 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |    17 | Lin Chong     |  25 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |    18 | Hua Rong      |  23 | <span style="color: #a020f0;">M</span>      |       7 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |    18 | Hua Rong      |  23 | <span style="color: #a020f0;">M</span>      |       7 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |    18 | Hua Rong      |  23 | <span style="color: #a020f0;">M</span>      |       7 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |    18 | Hua Rong      |  23 | <span style="color: #a020f0;">M</span>      |       7 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |    19 | Xue Baochai   |  18 | F      |       6 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |    19 | Xue Baochai   |  18 | F      |       6 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |    19 | Xue Baochai   |  18 | F      |       6 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |    19 | Xue Baochai   |  18 | F      |       6 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |    20 | Diao Chan     |  19 | F      |       7 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |    20 | Diao Chan     |  19 | F      |       7 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |    20 | Diao Chan     |  19 | F      |       7 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |    20 | Diao Chan     |  19 | F      |       7 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |    21 | Huang Yueying |  22 | F      |       6 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |    21 | Huang Yueying |  22 | F      |       6 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |    21 | Huang Yueying |  22 | F      |       6 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |    21 | Huang Yueying |  22 | F      |       6 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |    22 | Xiao Qiao     |  20 | F      |       1 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |    22 | Xiao Qiao     |  20 | F      |       1 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |    22 | Xiao Qiao     |  20 | F      |       1 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |    22 | Xiao Qiao     |  20 | F      |       1 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |    23 | Ma Chao       |  23 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |    23 | Ma Chao       |  23 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |    23 | Ma Chao       |  23 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |    23 | Ma Chao       |  23 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |    24 | Xu Xian       |  27 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |    24 | Xu Xian       |  27 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |    24 | Xu Xian       |  27 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |    24 | Xu Xian       |  27 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> |
|   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |    25 | Sun Dasheng   | 100 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> |
|   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |    25 | Sun Dasheng   | 100 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> |
|   3 | Miejue Shitai |  77 | F      |    25 | Sun Dasheng   | 100 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> |
|   4 | Lin Chaoying  |  29 | F      |    25 | Sun Dasheng   | 100 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+---------------+-----+--------+-------+---------------+-----+--------+---------+-----------+</span>
100 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.002 sec)


MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> stuid,students.<span style="color: #a020f0;">name</span> student_name,students.age,tid,teachers.<span style="color: #a020f0;">name</span> teacher_name,teachers.age <span style="color: #a020f0;">from</span> teachers <span style="color: #a020f0;">cross</span> <span style="color: #a020f0;">join</span> students;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+-----+---------------+-----+</span>
| stuid | student_name  | age | tid | teacher_name  | age |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+-----+---------------+-----+</span>
|     1 | Shi Zhongyu   |  45 |   1 | Song Jiang    |  45 |
|     1 | Shi Zhongyu   |  45 |   2 | Zhang Sanfeng |  94 |
|     1 | Shi Zhongyu   |  45 |   3 | Miejue Shitai |  77 |
|     1 | Shi Zhongyu   |  45 |   4 | Lin Chaoying  |  29 |
|     2 | Shi Potian    |  22 |   1 | Song Jiang    |  45 |
|     2 | Shi Potian    |  22 |   2 | Zhang Sanfeng |  94 |
|     2 | Shi Potian    |  22 |   3 | Miejue Shitai |  77 |
|     2 | Shi Potian    |  22 |   4 | Lin Chaoying  |  29 |
|     3 | Xie Yanke     |  77 |   1 | Song Jiang    |  45 |
|     3 | Xie Yanke     |  77 |   2 | Zhang Sanfeng |  94 |
|     3 | Xie Yanke     |  77 |   3 | Miejue Shitai |  77 |
|     3 | Xie Yanke     |  77 |   4 | Lin Chaoying  |  29 |
|     4 | Ding Dian     |  32 |   1 | Song Jiang    |  45 |
|     4 | Ding Dian     |  32 |   2 | Zhang Sanfeng |  94 |
|     4 | Ding Dian     |  32 |   3 | Miejue Shitai |  77 |
|     4 | Ding Dian     |  32 |   4 | Lin Chaoying  |  29 |
|     5 | Yu Yutong     |  26 |   1 | Song Jiang    |  45 |
|     5 | Yu Yutong     |  26 |   2 | Zhang Sanfeng |  94 |
|     5 | Yu Yutong     |  26 |   3 | Miejue Shitai |  77 |
|     5 | Yu Yutong     |  26 |   4 | Lin Chaoying  |  29 |
|     6 | Shi Qing      |  46 |   1 | Song Jiang    |  45 |
|     6 | Shi Qing      |  46 |   2 | Zhang Sanfeng |  94 |
|     6 | Shi Qing      |  46 |   3 | Miejue Shitai |  77 |
|     6 | Shi Qing      |  46 |   4 | Lin Chaoying  |  29 |
|     7 | Xi Ren        |  19 |   1 | Song Jiang    |  45 |
|     7 | Xi Ren        |  19 |   2 | Zhang Sanfeng |  94 |
|     7 | Xi Ren        |  19 |   3 | Miejue Shitai |  77 |
|     7 | Xi Ren        |  19 |   4 | Lin Chaoying  |  29 |
|     8 | Lin Daiyu     |  17 |   1 | Song Jiang    |  45 |
|     8 | Lin Daiyu     |  17 |   2 | Zhang Sanfeng |  94 |
|     8 | Lin Daiyu     |  17 |   3 | Miejue Shitai |  77 |
|     8 | Lin Daiyu     |  17 |   4 | Lin Chaoying  |  29 |
|     9 | Ren Yingying  |  20 |   1 | Song Jiang    |  45 |
|     9 | Ren Yingying  |  20 |   2 | Zhang Sanfeng |  94 |
|     9 | Ren Yingying  |  20 |   3 | Miejue Shitai |  77 |
|     9 | Ren Yingying  |  20 |   4 | Lin Chaoying  |  29 |
|    10 | Yue Lingshan  |  19 |   1 | Song Jiang    |  45 |
|    10 | Yue Lingshan  |  19 |   2 | Zhang Sanfeng |  94 |
|    10 | Yue Lingshan  |  19 |   3 | Miejue Shitai |  77 |
|    10 | Yue Lingshan  |  19 |   4 | Lin Chaoying  |  29 |
|    11 | Yuan Chengzhi |  23 |   1 | Song Jiang    |  45 |
|    11 | Yuan Chengzhi |  23 |   2 | Zhang Sanfeng |  94 |
|    11 | Yuan Chengzhi |  23 |   3 | Miejue Shitai |  77 |
|    11 | Yuan Chengzhi |  23 |   4 | Lin Chaoying  |  29 |
|    12 | Wen Qingqing  |  19 |   1 | Song Jiang    |  45 |
|    12 | Wen Qingqing  |  19 |   2 | Zhang Sanfeng |  94 |
|    12 | Wen Qingqing  |  19 |   3 | Miejue Shitai |  77 |
|    12 | Wen Qingqing  |  19 |   4 | Lin Chaoying  |  29 |
|    13 | Tian Boguang  |  33 |   1 | Song Jiang    |  45 |
|    13 | Tian Boguang  |  33 |   2 | Zhang Sanfeng |  94 |
|    13 | Tian Boguang  |  33 |   3 | Miejue Shitai |  77 |
|    13 | Tian Boguang  |  33 |   4 | Lin Chaoying  |  29 |
|    14 | Lu Wushuang   |  17 |   1 | Song Jiang    |  45 |
|    14 | Lu Wushuang   |  17 |   2 | Zhang Sanfeng |  94 |
|    14 | Lu Wushuang   |  17 |   3 | Miejue Shitai |  77 |
|    14 | Lu Wushuang   |  17 |   4 | Lin Chaoying  |  29 |
|    15 | Duan Yu       |  19 |   1 | Song Jiang    |  45 |
|    15 | Duan Yu       |  19 |   2 | Zhang Sanfeng |  94 |
|    15 | Duan Yu       |  19 |   3 | Miejue Shitai |  77 |
|    15 | Duan Yu       |  19 |   4 | Lin Chaoying  |  29 |
|    16 | Xu Zhu        |  21 |   1 | Song Jiang    |  45 |
|    16 | Xu Zhu        |  21 |   2 | Zhang Sanfeng |  94 |
|    16 | Xu Zhu        |  21 |   3 | Miejue Shitai |  77 |
|    16 | Xu Zhu        |  21 |   4 | Lin Chaoying  |  29 |
|    17 | Lin Chong     |  25 |   1 | Song Jiang    |  45 |
|    17 | Lin Chong     |  25 |   2 | Zhang Sanfeng |  94 |
|    17 | Lin Chong     |  25 |   3 | Miejue Shitai |  77 |
|    17 | Lin Chong     |  25 |   4 | Lin Chaoying  |  29 |
|    18 | Hua Rong      |  23 |   1 | Song Jiang    |  45 |
|    18 | Hua Rong      |  23 |   2 | Zhang Sanfeng |  94 |
|    18 | Hua Rong      |  23 |   3 | Miejue Shitai |  77 |
|    18 | Hua Rong      |  23 |   4 | Lin Chaoying  |  29 |
|    19 | Xue Baochai   |  18 |   1 | Song Jiang    |  45 |
|    19 | Xue Baochai   |  18 |   2 | Zhang Sanfeng |  94 |
|    19 | Xue Baochai   |  18 |   3 | Miejue Shitai |  77 |
|    19 | Xue Baochai   |  18 |   4 | Lin Chaoying  |  29 |
|    20 | Diao Chan     |  19 |   1 | Song Jiang    |  45 |
|    20 | Diao Chan     |  19 |   2 | Zhang Sanfeng |  94 |
|    20 | Diao Chan     |  19 |   3 | Miejue Shitai |  77 |
|    20 | Diao Chan     |  19 |   4 | Lin Chaoying  |  29 |
|    21 | Huang Yueying |  22 |   1 | Song Jiang    |  45 |
|    21 | Huang Yueying |  22 |   2 | Zhang Sanfeng |  94 |
|    21 | Huang Yueying |  22 |   3 | Miejue Shitai |  77 |
|    21 | Huang Yueying |  22 |   4 | Lin Chaoying  |  29 |
|    22 | Xiao Qiao     |  20 |   1 | Song Jiang    |  45 |
|    22 | Xiao Qiao     |  20 |   2 | Zhang Sanfeng |  94 |
|    22 | Xiao Qiao     |  20 |   3 | Miejue Shitai |  77 |
|    22 | Xiao Qiao     |  20 |   4 | Lin Chaoying  |  29 |
|    23 | Ma Chao       |  23 |   1 | Song Jiang    |  45 |
|    23 | Ma Chao       |  23 |   2 | Zhang Sanfeng |  94 |
|    23 | Ma Chao       |  23 |   3 | Miejue Shitai |  77 |
|    23 | Ma Chao       |  23 |   4 | Lin Chaoying  |  29 |
|    24 | Xu Xian       |  27 |   1 | Song Jiang    |  45 |
|    24 | Xu Xian       |  27 |   2 | Zhang Sanfeng |  94 |
|    24 | Xu Xian       |  27 |   3 | Miejue Shitai |  77 |
|    24 | Xu Xian       |  27 |   4 | Lin Chaoying  |  29 |
|    25 | Sun Dasheng   | 100 |   1 | Song Jiang    |  45 |
|    25 | Sun Dasheng   | 100 |   2 | Zhang Sanfeng |  94 |
|    25 | Sun Dasheng   | 100 |   3 | Miejue Shitai |  77 |
|    25 | Sun Dasheng   | 100 |   4 | Lin Chaoying  |  29 |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+-----+---------------+-----+</span>
100 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c07299d0-0fd0-4a5d-bfbc-70511ee971ad" class="outline-5">
<h5 id="h:c07299d0-0fd0-4a5d-bfbc-70511ee971ad">内连接</h5>
<div class="outline-text-5" id="text-h:c07299d0-0fd0-4a5d-bfbc-70511ee971ad">
<p>
取交集。
</p>


<p>
范例：内连接,都符合某一条件
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#20869;&#36830;&#25509;<span style="color: #a020f0;">inner</span> <span style="color: #a020f0;">join</span>
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">inner</span> <span style="color: #a020f0;">join</span> teachers <span style="color: #a020f0;">on</span> students.teacherid=teachers.tid; 
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span>
| StuID | <span style="color: #a020f0;">Name</span>        | Age | Gender | ClassID | TeacherID | TID | <span style="color: #a020f0;">Name</span>          | Age | Gender |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span>
|     5 | Yu Yutong   |  26 | <span style="color: #a020f0;">M</span>      |       3 |         1 |   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |
|     1 | Shi Zhongyu |  45 | <span style="color: #a020f0;">M</span>      |       2 |         3 |   3 | Miejue Shitai |  77 | F      |
|     4 | Ding Dian   |  32 | <span style="color: #a020f0;">M</span>      |       4 |         4 |   4 | Lin Chaoying  |  29 | F      |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span>
3 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

#&#22914;&#26524;&#34920;&#23450;&#20041;&#20102;&#21035;&#21517;&#65292;&#21407;&#34920;&#21517;&#23558;&#26080;&#27861;&#20351;&#29992;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> stuid,s.<span style="color: #a020f0;">name</span> <span style="color: #a020f0;">as</span> student_name ,tid,t.<span style="color: #a020f0;">name</span> <span style="color: #a020f0;">as</span> teacher_name <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">as</span> s <span style="color: #a020f0;">inner</span> <span style="color: #a020f0;">join</span> teachers <span style="color: #a020f0;">as</span> t <span style="color: #a020f0;">on</span> s.teacherid=t.tid;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+--------------+-----+---------------+</span>
| stuid | student_name | tid | teacher_name  |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+--------------+-----+---------------+</span>
|     5 | Yu Yutong    |   1 | Song Jiang    |
|     1 | Shi Zhongyu  |   3 | Miejue Shitai |
|     4 | Ding Dian    |   4 | Lin Chaoying  |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+--------------+-----+---------------+</span>
3 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> stuid,s.<span style="color: #a020f0;">name</span> studentname,s.age studentage,tid,t.<span style="color: #a020f0;">name</span> <span style="color: #a020f0;">as</span> teachername,t.age teacherage <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">as</span> s <span style="color: #a020f0;">inner</span> <span style="color: #a020f0;">join</span> teachers t <span style="color: #a020f0;">on</span> s.teacherid=t.tid;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+------------+-----+---------------+------------+</span>
| stuid | studentname | studentage | tid | teachername   | teacherage |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+------------+-----+---------------+------------+</span>
|     5 | Yu Yutong   |         26 |   1 | Song Jiang    |         45 |
|     1 | Shi Zhongyu |         45 |   3 | Miejue Shitai |         77 |
|     4 | Ding Dian   |         32 |   4 | Lin Chaoying  |         29 |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+------------+-----+---------------+------------+</span>
3 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students,teachers <span style="color: #a020f0;">where</span> students.teacherid=teachers.tid;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span>
| StuID | <span style="color: #a020f0;">Name</span>        | Age | Gender | ClassID | TeacherID | TID | <span style="color: #a020f0;">Name</span>          | Age | Gender |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span>
|     5 | Yu Yutong   |  26 | <span style="color: #a020f0;">M</span>      |       3 |         1 |   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |
|     1 | Shi Zhongyu |  45 | <span style="color: #a020f0;">M</span>      |       2 |         3 |   3 | Miejue Shitai |  77 | F      |
|     4 | Ding Dian   |  32 | <span style="color: #a020f0;">M</span>      |       4 |         4 |   4 | Lin Chaoying  |  29 | F      |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span>
3 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> s.<span style="color: #a020f0;">name</span> &#23398;&#29983;&#22995;&#21517;,s.age &#23398;&#29983;&#24180;&#40836;,s.gender &#23398;&#29983;&#24615;&#21035;,t.<span style="color: #a020f0;">name</span> &#32769;&#24072;&#22995;&#21517;,t.age &#32769;&#24072;&#24180;&#40836;,t.gender &#32769;&#24072;&#24615;&#21035; <span style="color: #a020f0;">from</span> students s <span style="color: #a020f0;">inner</span> <span style="color: #a020f0;">join</span> teachers t <span style="color: #a020f0;">on</span> s.gender &lt;&gt; t.gender; 
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+--------------+--------------+---------------+--------------+--------------+</span>
| &#23398;&#29983;&#22995;&#21517;      | &#23398;&#29983;&#24180;&#40836;     | &#23398;&#29983;&#24615;&#21035;     | &#32769;&#24072;&#22995;&#21517;      | &#32769;&#24072;&#24180;&#40836;     | &#32769;&#24072;&#24615;&#21035;     |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+--------------+--------------+---------------+--------------+--------------+</span>
| Shi Zhongyu   |           45 | <span style="color: #a020f0;">M</span>            | Miejue Shitai |           77 | F            |
| Shi Zhongyu   |           45 | <span style="color: #a020f0;">M</span>            | Lin Chaoying  |           29 | F            |
| Shi Potian    |           22 | <span style="color: #a020f0;">M</span>            | Miejue Shitai |           77 | F            |
| Shi Potian    |           22 | <span style="color: #a020f0;">M</span>            | Lin Chaoying  |           29 | F            |
| Xie Yanke     |           77 | <span style="color: #a020f0;">M</span>            | Miejue Shitai |           77 | F            |
| Xie Yanke     |           77 | <span style="color: #a020f0;">M</span>            | Lin Chaoying  |           29 | F            |
| Ding Dian     |           32 | <span style="color: #a020f0;">M</span>            | Miejue Shitai |           77 | F            |
| Ding Dian     |           32 | <span style="color: #a020f0;">M</span>            | Lin Chaoying  |           29 | F            |
| Yu Yutong     |           26 | <span style="color: #a020f0;">M</span>            | Miejue Shitai |           77 | F            |
| Yu Yutong     |           26 | <span style="color: #a020f0;">M</span>            | Lin Chaoying  |           29 | F            |
| Shi Qing      |           46 | <span style="color: #a020f0;">M</span>            | Miejue Shitai |           77 | F            |
| Shi Qing      |           46 | <span style="color: #a020f0;">M</span>            | Lin Chaoying  |           29 | F            |
| Xi Ren        |           19 | F            | Song Jiang    |           45 | <span style="color: #a020f0;">M</span>            |
| Xi Ren        |           19 | F            | Zhang Sanfeng |           94 | <span style="color: #a020f0;">M</span>            |
| Lin Daiyu     |           17 | F            | Song Jiang    |           45 | <span style="color: #a020f0;">M</span>            |
| Lin Daiyu     |           17 | F            | Zhang Sanfeng |           94 | <span style="color: #a020f0;">M</span>            |
| Ren Yingying  |           20 | F            | Song Jiang    |           45 | <span style="color: #a020f0;">M</span>            |
| Ren Yingying  |           20 | F            | Zhang Sanfeng |           94 | <span style="color: #a020f0;">M</span>            |
| Yue Lingshan  |           19 | F            | Song Jiang    |           45 | <span style="color: #a020f0;">M</span>            |
| Yue Lingshan  |           19 | F            | Zhang Sanfeng |           94 | <span style="color: #a020f0;">M</span>            |
| Yuan Chengzhi |           23 | <span style="color: #a020f0;">M</span>            | Miejue Shitai |           77 | F            |
| Yuan Chengzhi |           23 | <span style="color: #a020f0;">M</span>            | Lin Chaoying  |           29 | F            |
| Wen Qingqing  |           19 | F            | Song Jiang    |           45 | <span style="color: #a020f0;">M</span>            |
| Wen Qingqing  |           19 | F            | Zhang Sanfeng |           94 | <span style="color: #a020f0;">M</span>            |
| Tian Boguang  |           33 | <span style="color: #a020f0;">M</span>            | Miejue Shitai |           77 | F            |
| Tian Boguang  |           33 | <span style="color: #a020f0;">M</span>            | Lin Chaoying  |           29 | F            |
| Lu Wushuang   |           17 | F            | Song Jiang    |           45 | <span style="color: #a020f0;">M</span>            |
| Lu Wushuang   |           17 | F            | Zhang Sanfeng |           94 | <span style="color: #a020f0;">M</span>            |
| Duan Yu       |           19 | <span style="color: #a020f0;">M</span>            | Miejue Shitai |           77 | F            |
| Duan Yu       |           19 | <span style="color: #a020f0;">M</span>            | Lin Chaoying  |           29 | F            |
| Xu Zhu        |           21 | <span style="color: #a020f0;">M</span>            | Miejue Shitai |           77 | F            |
| Xu Zhu        |           21 | <span style="color: #a020f0;">M</span>            | Lin Chaoying  |           29 | F            |
| Lin Chong     |           25 | <span style="color: #a020f0;">M</span>            | Miejue Shitai |           77 | F            |
| Lin Chong     |           25 | <span style="color: #a020f0;">M</span>            | Lin Chaoying  |           29 | F            |
| Hua Rong      |           23 | <span style="color: #a020f0;">M</span>            | Miejue Shitai |           77 | F            |
| Hua Rong      |           23 | <span style="color: #a020f0;">M</span>            | Lin Chaoying  |           29 | F            |
| Xue Baochai   |           18 | F            | Song Jiang    |           45 | <span style="color: #a020f0;">M</span>            |
| Xue Baochai   |           18 | F            | Zhang Sanfeng |           94 | <span style="color: #a020f0;">M</span>            |
| Diao Chan     |           19 | F            | Song Jiang    |           45 | <span style="color: #a020f0;">M</span>            |
| Diao Chan     |           19 | F            | Zhang Sanfeng |           94 | <span style="color: #a020f0;">M</span>            |
| Huang Yueying |           22 | F            | Song Jiang    |           45 | <span style="color: #a020f0;">M</span>            |
| Huang Yueying |           22 | F            | Zhang Sanfeng |           94 | <span style="color: #a020f0;">M</span>            |
| Xiao Qiao     |           20 | F            | Song Jiang    |           45 | <span style="color: #a020f0;">M</span>            |
| Xiao Qiao     |           20 | F            | Zhang Sanfeng |           94 | <span style="color: #a020f0;">M</span>            |
| Ma Chao       |           23 | <span style="color: #a020f0;">M</span>            | Miejue Shitai |           77 | F            |
| Ma Chao       |           23 | <span style="color: #a020f0;">M</span>            | Lin Chaoying  |           29 | F            |
| Xu Xian       |           27 | <span style="color: #a020f0;">M</span>            | Miejue Shitai |           77 | F            |
| Xu Xian       |           27 | <span style="color: #a020f0;">M</span>            | Lin Chaoying  |           29 | F            |
| Sun Dasheng   |          100 | <span style="color: #a020f0;">M</span>            | Miejue Shitai |           77 | F            |
| Sun Dasheng   |          100 | <span style="color: #a020f0;">M</span>            | Lin Chaoying  |           29 | F            |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+--------------+--------------+---------------+--------------+--------------+</span>
50 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> stuid,s.<span style="color: #a020f0;">name</span>,tid,t.<span style="color: #a020f0;">name</span> <span style="color: #a020f0;">from</span> students s, teachers t <span style="color: #a020f0;">where</span> s.teacherid=t.tid;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+---------------+</span>
| stuid | <span style="color: #a020f0;">name</span>        | tid | <span style="color: #a020f0;">name</span>          |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+---------------+</span>
|     5 | Yu Yutong   |   1 | Song Jiang    |
|     1 | Shi Zhongyu |   3 | Miejue Shitai |
|     4 | Ding Dian   |   4 | Lin Chaoying  |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+---------------+</span>
3 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)


#&#20869;&#36830;&#25509;&#21518;&#36807;&#28388;&#25968;&#25454;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students s <span style="color: #a020f0;">inner</span> <span style="color: #a020f0;">join</span> teachers t <span style="color: #a020f0;">on</span> s.teacherid=t.tid <span style="color: #a020f0;">and</span> s.age &gt; 30;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span>
| StuID | <span style="color: #a020f0;">Name</span>        | Age | Gender | ClassID | TeacherID | TID | <span style="color: #a020f0;">Name</span>          | Age | Gender |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span>
|     1 | Shi Zhongyu |  45 | <span style="color: #a020f0;">M</span>      |       2 |         3 |   3 | Miejue Shitai |  77 | F      |
|     4 | Ding Dian   |  32 | <span style="color: #a020f0;">M</span>      |       4 |         4 |   4 | Lin Chaoying  |  29 | F      |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span>
2 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students s <span style="color: #a020f0;">inner</span> <span style="color: #a020f0;">join</span> teachers t <span style="color: #a020f0;">on</span> s.teacherid=t.tid <span style="color: #a020f0;">where</span> s.age &gt; 30;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span>
| StuID | <span style="color: #a020f0;">Name</span>        | Age | Gender | ClassID | TeacherID | TID | <span style="color: #a020f0;">Name</span>          | Age | Gender |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span>
|     1 | Shi Zhongyu |  45 | <span style="color: #a020f0;">M</span>      |       2 |         3 |   3 | Miejue Shitai |  77 | F      |
|     4 | Ding Dian   |  32 | <span style="color: #a020f0;">M</span>      |       4 |         4 |   4 | Lin Chaoying  |  29 | F      |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span>
2 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7dd0291f-d5f7-41cb-aa9a-e86006b405cb" class="outline-5">
<h5 id="h:7dd0291f-d5f7-41cb-aa9a-e86006b405cb">左和右外连接</h5>
<div class="outline-text-5" id="text-h:7dd0291f-d5f7-41cb-aa9a-e86006b405cb">
<p>
范例：左，右外连接，outer可以省略
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#24038;&#22806;&#36830;&#25509;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> s.stuid,s.<span style="color: #a020f0;">name</span>,s.age,s.teacherid,t.tid,t.<span style="color: #a020f0;">name</span>,t.age <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">as</span> s <span style="color: #a020f0;">left</span> <span style="color: #a020f0;">outer</span> <span style="color: #a020f0;">join</span> teachers <span style="color: #a020f0;">as</span> t <span style="color: #a020f0;">on</span> s.teacherid=t.tid;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+-----------+------+---------------+------+</span>
| stuid | <span style="color: #a020f0;">name</span>          | age | teacherid | tid  | <span style="color: #a020f0;">name</span>          | age  |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+-----------+------+---------------+------+</span>
|     1 | Shi Zhongyu   |  45 |         3 |    3 | Miejue Shitai |   77 |
|     2 | Shi Potian    |  22 |         7 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|     3 | Xie Yanke     |  77 |        16 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|     4 | Ding Dian     |  32 |         4 |    4 | Lin Chaoying  |   29 |
|     5 | Yu Yutong     |  26 |         1 |    1 | Song Jiang    |   45 |
|     6 | Shi Qing      |  46 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|     7 | Xi Ren        |  19 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|     8 | Lin Daiyu     |  17 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|     9 | Ren Yingying  |  20 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    10 | Yue Lingshan  |  19 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    11 | Yuan Chengzhi |  23 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    12 | Wen Qingqing  |  19 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    13 | Tian Boguang  |  33 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    14 | Lu Wushuang   |  17 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    15 | Duan Yu       |  19 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    16 | Xu Zhu        |  21 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    17 | Lin Chong     |  25 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    18 | Hua Rong      |  23 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    19 | Xue Baochai   |  18 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    20 | Diao Chan     |  19 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    21 | Huang Yueying |  22 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    22 | Xiao Qiao     |  20 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    23 | Ma Chao       |  23 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    24 | Xu Xian       |  27 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    25 | Sun Dasheng   | 100 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+-----------+------+---------------+------+</span>
25 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.002 sec)

#&#24038;&#22806;&#36830;&#25509;&#25193;&#23637;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students s <span style="color: #a020f0;">left</span> <span style="color: #a020f0;">outer</span> <span style="color: #a020f0;">join</span> teachers t <span style="color: #a020f0;">on</span> s.teacherid=t.tid <span style="color: #a020f0;">where</span> t.tid <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">null</span>;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+------+------+------+--------+</span>
| StuID | <span style="color: #a020f0;">Name</span>          | Age | Gender | ClassID | TeacherID | TID  | <span style="color: #a020f0;">Name</span> | Age  | Gender |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+------+------+------+--------+</span>
|     2 | Shi Potian    |  22 | <span style="color: #a020f0;">M</span>      |       1 |         7 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     3 | Xie Yanke     |  77 | <span style="color: #a020f0;">M</span>      |       2 |        16 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     6 | Shi Qing      |  46 | <span style="color: #a020f0;">M</span>      |       5 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     7 | Xi Ren        |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     8 | Lin Daiyu     |  17 | F      |       7 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     9 | Ren Yingying  |  20 | F      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    10 | Yue Lingshan  |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    11 | Yuan Chengzhi |  23 | <span style="color: #a020f0;">M</span>      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    12 | Wen Qingqing  |  19 | F      |       1 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    13 | Tian Boguang  |  33 | <span style="color: #a020f0;">M</span>      |       2 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    14 | Lu Wushuang   |  17 | F      |       3 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    15 | Duan Yu       |  19 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    16 | Xu Zhu        |  21 | <span style="color: #a020f0;">M</span>      |       1 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    17 | Lin Chong     |  25 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    18 | Hua Rong      |  23 | <span style="color: #a020f0;">M</span>      |       7 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    19 | Xue Baochai   |  18 | F      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    20 | Diao Chan     |  19 | F      |       7 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    21 | Huang Yueying |  22 | F      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    22 | Xiao Qiao     |  20 | F      |       1 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    23 | Ma Chao       |  23 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    24 | Xu Xian       |  27 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    25 | Sun Dasheng   | 100 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+------+------+------+--------+</span>
22 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

#&#22810;&#20010;&#26465;&#20214;&#30340;&#24038;&#22806;&#36830;&#25509;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students s <span style="color: #a020f0;">left</span> <span style="color: #a020f0;">outer</span> <span style="color: #a020f0;">join</span> teachers t <span style="color: #a020f0;">on</span> s.teacherid=t.tid <span style="color: #a020f0;">and</span> s.teacherid <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">null</span>;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+------+------+------+--------+</span>
| StuID | <span style="color: #a020f0;">Name</span>          | Age | Gender | ClassID | TeacherID | TID  | <span style="color: #a020f0;">Name</span> | Age  | Gender |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+------+------+------+--------+</span>
|     1 | Shi Zhongyu   |  45 | <span style="color: #a020f0;">M</span>      |       2 |         3 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     2 | Shi Potian    |  22 | <span style="color: #a020f0;">M</span>      |       1 |         7 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     3 | Xie Yanke     |  77 | <span style="color: #a020f0;">M</span>      |       2 |        16 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     4 | Ding Dian     |  32 | <span style="color: #a020f0;">M</span>      |       4 |         4 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     5 | Yu Yutong     |  26 | <span style="color: #a020f0;">M</span>      |       3 |         1 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     6 | Shi Qing      |  46 | <span style="color: #a020f0;">M</span>      |       5 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     7 | Xi Ren        |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     8 | Lin Daiyu     |  17 | F      |       7 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     9 | Ren Yingying  |  20 | F      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    10 | Yue Lingshan  |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    11 | Yuan Chengzhi |  23 | <span style="color: #a020f0;">M</span>      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    12 | Wen Qingqing  |  19 | F      |       1 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    13 | Tian Boguang  |  33 | <span style="color: #a020f0;">M</span>      |       2 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    14 | Lu Wushuang   |  17 | F      |       3 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    15 | Duan Yu       |  19 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    16 | Xu Zhu        |  21 | <span style="color: #a020f0;">M</span>      |       1 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    17 | Lin Chong     |  25 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    18 | Hua Rong      |  23 | <span style="color: #a020f0;">M</span>      |       7 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    19 | Xue Baochai   |  18 | F      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    20 | Diao Chan     |  19 | F      |       7 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    21 | Huang Yueying |  22 | F      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    22 | Xiao Qiao     |  20 | F      |       1 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    23 | Ma Chao       |  23 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    24 | Xu Xian       |  27 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    25 | Sun Dasheng   | 100 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+------+------+------+--------+</span>
25 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

#&#20808;&#24038;&#22806;&#36830;&#25509;&#65292;&#20877;&#36807;&#28388;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students s <span style="color: #a020f0;">left</span> <span style="color: #a020f0;">outer</span> <span style="color: #a020f0;">join</span> teachers t <span style="color: #a020f0;">on</span> s.teacherid=t.tid <span style="color: #a020f0;">where</span> s.teacherid <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">null</span>;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+------+------+------+--------+</span>
| StuID | <span style="color: #a020f0;">Name</span>          | Age | Gender | ClassID | TeacherID | TID  | <span style="color: #a020f0;">Name</span> | Age  | Gender |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+------+------+------+--------+</span>
|     6 | Shi Qing      |  46 | <span style="color: #a020f0;">M</span>      |       5 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     7 | Xi Ren        |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     8 | Lin Daiyu     |  17 | F      |       7 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     9 | Ren Yingying  |  20 | F      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    10 | Yue Lingshan  |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    11 | Yuan Chengzhi |  23 | <span style="color: #a020f0;">M</span>      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    12 | Wen Qingqing  |  19 | F      |       1 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    13 | Tian Boguang  |  33 | <span style="color: #a020f0;">M</span>      |       2 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    14 | Lu Wushuang   |  17 | F      |       3 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    15 | Duan Yu       |  19 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    16 | Xu Zhu        |  21 | <span style="color: #a020f0;">M</span>      |       1 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    17 | Lin Chong     |  25 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    18 | Hua Rong      |  23 | <span style="color: #a020f0;">M</span>      |       7 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    19 | Xue Baochai   |  18 | F      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    20 | Diao Chan     |  19 | F      |       7 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    21 | Huang Yueying |  22 | F      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    22 | Xiao Qiao     |  20 | F      |       1 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    23 | Ma Chao       |  23 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    24 | Xu Xian       |  27 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    25 | Sun Dasheng   | 100 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----+--------+---------+-----------+------+------+------+--------+</span>
20 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

#&#21491;&#22806;&#36830;&#25509;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students s <span style="color: #a020f0;">right</span> <span style="color: #a020f0;">outer</span> <span style="color: #a020f0;">join</span> teachers t <span style="color: #a020f0;">on</span> s.teacherid=t.tid;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+------+--------+---------+-----------+-----+---------------+-----+--------+</span>
| StuID | <span style="color: #a020f0;">Name</span>        | Age  | Gender | ClassID | TeacherID | TID | <span style="color: #a020f0;">Name</span>          | Age | Gender |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+------+--------+---------+-----------+-----+---------------+-----+--------+</span>
|     1 | Shi Zhongyu |   45 | <span style="color: #a020f0;">M</span>      |       2 |         3 |   3 | Miejue Shitai |  77 | F      |
|     4 | Ding Dian   |   32 | <span style="color: #a020f0;">M</span>      |       4 |         4 |   4 | Lin Chaoying  |  29 | F      |
|     5 | Yu Yutong   |   26 | <span style="color: #a020f0;">M</span>      |       3 |         1 |   1 | Song Jiang    |  45 | <span style="color: #a020f0;">M</span>      |
|  <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>        | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> |   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-------------+------+--------+---------+-----------+-----+---------------+-----+--------+</span>
4 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

#&#21491;&#22806;&#36830;&#25509;&#30340;&#25193;&#23637;&#29992;&#27861;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students s <span style="color: #a020f0;">right</span> <span style="color: #a020f0;">outer</span> <span style="color: #a020f0;">join</span> teachers t <span style="color: #a020f0;">on</span> s.teacherid=t.tid <span style="color: #a020f0;">where</span> s.teacherid <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">null</span>;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+------+------+--------+---------+-----------+-----+---------------+-----+--------+</span>
| StuID | <span style="color: #a020f0;">Name</span> | Age  | Gender | ClassID | TeacherID | TID | <span style="color: #a020f0;">Name</span>          | Age | Gender |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+------+------+--------+---------+-----------+-----+---------------+-----+--------+</span>
|  <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> |   2 | Zhang Sanfeng |  94 | <span style="color: #a020f0;">M</span>      |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+------+------+--------+---------+-----------+-----+---------------+-----+--------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:67970beb-08af-4256-9d99-c0367cf30c66" class="outline-5">
<h5 id="h:67970beb-08af-4256-9d99-c0367cf30c66">完全外连接</h5>
<div class="outline-text-5" id="text-h:67970beb-08af-4256-9d99-c0367cf30c66">
<p>
范例：完全外连接，MySQL不支持
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#23436;&#20840;&#22806;&#36830;&#25509; <span style="color: #a020f0;">full</span> <span style="color: #a020f0;">outer</span> <span style="color: #a020f0;">join</span>
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students s <span style="color: #a020f0;">left</span> <span style="color: #a020f0;">join</span> teachers t <span style="color: #a020f0;">on</span> s.teacherid=t.tid
    -&gt; <span style="color: #a020f0;">union</span>
    -&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students s <span style="color: #a020f0;">right</span> <span style="color: #a020f0;">join</span> teachers t <span style="color: #a020f0;">on</span> s.teacherid=t.tid;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+------+--------+---------+-----------+------+---------------+------+--------+</span>
| StuID | <span style="color: #a020f0;">Name</span>          | Age  | Gender | ClassID | TeacherID | TID  | <span style="color: #a020f0;">Name</span>          | Age  | Gender |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+------+--------+---------+-----------+------+---------------+------+--------+</span>
|     1 | Shi Zhongyu   |   45 | <span style="color: #a020f0;">M</span>      |       2 |         3 |    3 | Miejue Shitai |   77 | F      |
|     2 | Shi Potian    |   22 | <span style="color: #a020f0;">M</span>      |       1 |         7 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     3 | Xie Yanke     |   77 | <span style="color: #a020f0;">M</span>      |       2 |        16 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     4 | Ding Dian     |   32 | <span style="color: #a020f0;">M</span>      |       4 |         4 |    4 | Lin Chaoying  |   29 | F      |
|     5 | Yu Yutong     |   26 | <span style="color: #a020f0;">M</span>      |       3 |         1 |    1 | Song Jiang    |   45 | <span style="color: #a020f0;">M</span>      |
|     6 | Shi Qing      |   46 | <span style="color: #a020f0;">M</span>      |       5 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     7 | Xi Ren        |   19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     8 | Lin Daiyu     |   17 | F      |       7 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     9 | Ren Yingying  |   20 | F      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    10 | Yue Lingshan  |   19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    11 | Yuan Chengzhi |   23 | <span style="color: #a020f0;">M</span>      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    12 | Wen Qingqing  |   19 | F      |       1 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    13 | Tian Boguang  |   33 | <span style="color: #a020f0;">M</span>      |       2 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    14 | Lu Wushuang   |   17 | F      |       3 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    15 | Duan Yu       |   19 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    16 | Xu Zhu        |   21 | <span style="color: #a020f0;">M</span>      |       1 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    17 | Lin Chong     |   25 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    18 | Hua Rong      |   23 | <span style="color: #a020f0;">M</span>      |       7 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    19 | Xue Baochai   |   18 | F      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    20 | Diao Chan     |   19 | F      |       7 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    21 | Huang Yueying |   22 | F      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    22 | Xiao Qiao     |   20 | F      |       1 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    23 | Ma Chao       |   23 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    24 | Xu Xian       |   27 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    25 | Sun Dasheng   |  100 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|  <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> |    2 | Zhang Sanfeng |   94 | <span style="color: #a020f0;">M</span>      |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+------+--------+---------+-----------+------+---------------+------+--------+</span>
26 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)


MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> s.stuid,s.<span style="color: #a020f0;">name</span>,s.age,t.tid,t.<span style="color: #a020f0;">name</span>,t.age <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">as</span> s <span style="color: #a020f0;">left</span> <span style="color: #a020f0;">join</span> teachers <span style="color: #a020f0;">as</span> t <span style="color: #a020f0;">on</span> s.teacherid=t.tid
    -&gt; <span style="color: #a020f0;">union</span>
    -&gt; <span style="color: #a020f0;">select</span> s.stuid,s.<span style="color: #a020f0;">name</span>,s.age,t.tid,t.<span style="color: #a020f0;">name</span>,t.age <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">as</span> s <span style="color: #a020f0;">right</span> <span style="color: #a020f0;">join</span> teachers <span style="color: #a020f0;">as</span> t <span style="color: #a020f0;">on</span> s.teacherid=t.tid;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+------+------+---------------+------+</span>
| stuid | <span style="color: #a020f0;">name</span>          | age  | tid  | <span style="color: #a020f0;">name</span>          | age  |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+------+------+---------------+------+</span>
|     1 | Shi Zhongyu   |   45 |    3 | Miejue Shitai |   77 |
|     2 | Shi Potian    |   22 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|     3 | Xie Yanke     |   77 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|     4 | Ding Dian     |   32 |    4 | Lin Chaoying  |   29 |
|     5 | Yu Yutong     |   26 |    1 | Song Jiang    |   45 |
|     6 | Shi Qing      |   46 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|     7 | Xi Ren        |   19 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|     8 | Lin Daiyu     |   17 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|     9 | Ren Yingying  |   20 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    10 | Yue Lingshan  |   19 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    11 | Yuan Chengzhi |   23 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    12 | Wen Qingqing  |   19 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    13 | Tian Boguang  |   33 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    14 | Lu Wushuang   |   17 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    15 | Duan Yu       |   19 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    16 | Xu Zhu        |   21 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    17 | Lin Chong     |   25 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    18 | Hua Rong      |   23 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    19 | Xue Baochai   |   18 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    20 | Diao Chan     |   19 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    21 | Huang Yueying |   22 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    22 | Xiao Qiao     |   20 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    23 | Ma Chao       |   23 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    24 | Xu Xian       |   27 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|    25 | Sun Dasheng   |  100 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |
|  <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> |    2 | Zhang Sanfeng |   94 |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+------+------+---------------+------+</span>
26 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)


#&#23436;&#20840;&#22806;&#36830;&#25509;&#30340;&#25193;&#23637;&#31034;&#20363;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students s <span style="color: #a020f0;">left</span> <span style="color: #a020f0;">outer</span> <span style="color: #a020f0;">join</span> teachers t <span style="color: #a020f0;">on</span> s.teacherid=t.tid <span style="color: #a020f0;">where</span> t.tid <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">null</span> <span style="color: #a020f0;">union</span> <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students s <span style="color: #a020f0;">right</span> <span style="color: #a020f0;">outer</span> <span style="color: #a020f0;">join</span> teachers t <span style="color: #a020f0;">on</span> s.teacherid=t.tid <span style="color: #a020f0;">where</span> s.teacherid <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">null</span>;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+------+--------+---------+-----------+------+---------------+------+--------+</span>
| StuID | <span style="color: #a020f0;">Name</span>          | Age  | Gender | ClassID | TeacherID | TID  | <span style="color: #a020f0;">Name</span>          | Age  | Gender |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+------+--------+---------+-----------+------+---------------+------+--------+</span>
|     2 | Shi Potian    |   22 | <span style="color: #a020f0;">M</span>      |       1 |         7 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     3 | Xie Yanke     |   77 | <span style="color: #a020f0;">M</span>      |       2 |        16 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     6 | Shi Qing      |   46 | <span style="color: #a020f0;">M</span>      |       5 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     7 | Xi Ren        |   19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     8 | Lin Daiyu     |   17 | F      |       7 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|     9 | Ren Yingying  |   20 | F      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    10 | Yue Lingshan  |   19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    11 | Yuan Chengzhi |   23 | <span style="color: #a020f0;">M</span>      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    12 | Wen Qingqing  |   19 | F      |       1 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    13 | Tian Boguang  |   33 | <span style="color: #a020f0;">M</span>      |       2 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    14 | Lu Wushuang   |   17 | F      |       3 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    15 | Duan Yu       |   19 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    16 | Xu Zhu        |   21 | <span style="color: #a020f0;">M</span>      |       1 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    17 | Lin Chong     |   25 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    18 | Hua Rong      |   23 | <span style="color: #a020f0;">M</span>      |       7 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    19 | Xue Baochai   |   18 | F      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    20 | Diao Chan     |   19 | F      |       7 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    21 | Huang Yueying |   22 | F      |       6 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    22 | Xiao Qiao     |   20 | F      |       1 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    23 | Ma Chao       |   23 | <span style="color: #a020f0;">M</span>      |       4 |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    24 | Xu Xian       |   27 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|    25 | Sun Dasheng   |  100 | <span style="color: #a020f0;">M</span>      |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |
|  <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>   |    <span style="color: #a020f0;">NULL</span> |      <span style="color: #a020f0;">NULL</span> |    2 | Zhang Sanfeng |   94 | <span style="color: #a020f0;">M</span>      |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+------+--------+---------+-----------+------+---------------+------+--------+</span>
23 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> (<span style="color: #a020f0;">select</span> s.stuid,s.<span style="color: #a020f0;">name</span> s_name,s.teacherid,t.tid,t.<span style="color: #a020f0;">name</span> t_name <span style="color: #a020f0;">from</span> students s <span style="color: #a020f0;">left</span> <span style="color: #a020f0;">outer</span> <span style="color: #a020f0;">join</span> teachers t <span style="color: #a020f0;">on</span> s.teacherid=t.tid <span style="color: #a020f0;">union</span> <span style="color: #a020f0;">select</span> s.stuid,s.<span style="color: #a020f0;">name</span>,s.teacherid,t.tid,t.<span style="color: #a020f0;">name</span> <span style="color: #a020f0;">from</span> students s <span style="color: #a020f0;">right</span> <span style="color: #a020f0;">outer</span> <span style="color: #a020f0;">join</span> teachers t <span style="color: #a020f0;">on</span> s.teacherid=t.tid) <span style="color: #a020f0;">as</span> a <span style="color: #a020f0;">where</span> a.teacherid <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">null</span> <span style="color: #a020f0;">or</span> a.tid <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">null</span>;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----------+------+---------------+</span>
| stuid | s_name        | teacherid | tid  | t_name        |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----------+------+---------------+</span>
|     2 | Shi Potian    |         7 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|     3 | Xie Yanke     |        16 | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|     6 | Shi Qing      |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|     7 | Xi Ren        |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|     8 | Lin Daiyu     |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|     9 | Ren Yingying  |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|    10 | Yue Lingshan  |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|    11 | Yuan Chengzhi |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|    12 | Wen Qingqing  |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|    13 | Tian Boguang  |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|    14 | Lu Wushuang   |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|    15 | Duan Yu       |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|    16 | Xu Zhu        |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|    17 | Lin Chong     |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|    18 | Hua Rong      |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|    19 | Xue Baochai   |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|    20 | Diao Chan     |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|    21 | Huang Yueying |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|    22 | Xiao Qiao     |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|    23 | Ma Chao       |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|    24 | Xu Xian       |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|    25 | Sun Dasheng   |      <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |
|  <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>          |      <span style="color: #a020f0;">NULL</span> |    2 | Zhang Sanfeng |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+---------------+-----------+------+---------------+</span>
23 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3779ba7b-09af-4e30-9fc2-cf17f4b23684" class="outline-5">
<h5 id="h:3779ba7b-09af-4e30-9fc2-cf17f4b23684">自连接</h5>
<div class="outline-text-5" id="text-h:3779ba7b-09af-4e30-9fc2-cf17f4b23684">
<p>
即：表自身连接自身
</p>

<p>
范例：自连接
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#33258;&#36830;&#25509;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> emp;
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+----------+-----------+</span>
| id | <span style="color: #a020f0;">name</span>     | leader_id |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+----------+-----------+</span>
|  1 | cici     |      <span style="color: #a020f0;">NULL</span> |
|  2 | zsir |         1 |
|  3 | wang     |         2 |
|  4 | zhang    |         3 |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+----------+-----------+</span>
4 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> e.<span style="color: #a020f0;">name</span> &#21592;&#24037;&#22995;&#21517;,l.<span style="color: #a020f0;">name</span> &#39046;&#23548;&#22995;&#21517; <span style="color: #a020f0;">from</span> emp e <span style="color: #a020f0;">inner</span> <span style="color: #a020f0;">join</span> emp l <span style="color: #a020f0;">on</span> e.leader_id=l.id;
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+--------------+</span>
| &#21592;&#24037;&#22995;&#21517;      | &#39046;&#23548;&#22995;&#21517;     |
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+--------------+</span>
| zsir     | cici         |
| wang         | zsir     |
| zhang        | wang         |
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+--------------+</span>
3 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> e.<span style="color: #a020f0;">name</span> &#21592;&#24037;&#22995;&#21517;,l.<span style="color: #a020f0;">name</span> &#39046;&#23548;&#22995;&#21517; <span style="color: #a020f0;">from</span> emp e <span style="color: #a020f0;">left</span> <span style="color: #a020f0;">join</span> emp l <span style="color: #a020f0;">on</span> e.leader_id=l.id;
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+--------------+</span>
| &#21592;&#24037;&#22995;&#21517;      | &#39046;&#23548;&#22995;&#21517;     |
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+--------------+</span>
| cici         | <span style="color: #a020f0;">NULL</span>         |
| zsir     | cici         |
| wang         | zsir     |
| zhang        | wang         |
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+--------------+</span>
4 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> e.<span style="color: #a020f0;">name</span> &#21592;&#24037;&#22995;&#21517;,IFNULL(l.<span style="color: #a020f0;">name</span>,<span style="color: #8b2252;">'&#26080;&#19978;&#32423;'</span>) &#39046;&#23548;&#22995;&#21517; <span style="color: #a020f0;">from</span> emp e <span style="color: #a020f0;">left</span> <span style="color: #a020f0;">join</span> emp l <span style="color: #a020f0;">on</span> e.leader_id=l.id;
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+--------------+</span>
| &#21592;&#24037;&#22995;&#21517;     | &#39046;&#23548;&#22995;&#21517;     |
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+--------------+</span>
| cici         | &#26080;&#19978;&#32423;       |
| zsir     | cici         |
| wang         | zsir     |
| zhang        | wang         |
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+--------------+</span>
4 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>

<p>
范例：三表连接
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#19977;&#24352;&#34920;&#36830;&#25509;&#31034;&#20363;
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> courses;
+<span style="color: #b22222;">----------</span><span style="color: #b22222;">+----------------+</span>
| CourseID | Course         |
+<span style="color: #b22222;">----------</span><span style="color: #b22222;">+----------------+</span>
|        1 | Hamo Gong      |
|        2 | Kuihua Baodian |
|        3 | Jinshe Jianfa  |
|        4 | Taiji Quan     |
|        5 | Daiyu Zanghua  |
|        6 | Weituo Zhang   |
|        7 | Dagou Bangfa   |
+<span style="color: #b22222;">----------</span><span style="color: #b22222;">+----------------+</span>
7 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> scores;
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------+----------+-------+</span>
| ID | StuID | CourseID | Score |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------+----------+-------+</span>
|  1 |     1 |        2 |    77 |
|  2 |     1 |        6 |    93 |
|  3 |     2 |        2 |    47 |
|  4 |     2 |        5 |    97 |
|  5 |     3 |        2 |    88 |
|  6 |     3 |        6 |    75 |
|  7 |     4 |        5 |    71 |
|  8 |     4 |        2 |    89 |
|  9 |     5 |        1 |    39 |
| 10 |     5 |        7 |    63 |
| 11 |     6 |        1 |    96 |
| 12 |     7 |        1 |    86 |
| 13 |     7 |        7 |    83 |
| 14 |     8 |        4 |    57 |
| 15 |     8 |        3 |    93 |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------+----------+-------+</span>
15 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> st.<span style="color: #a020f0;">name</span>,sc.score <span style="color: #a020f0;">from</span> students st <span style="color: #a020f0;">inner</span> <span style="color: #a020f0;">join</span> scores sc <span style="color: #a020f0;">on</span> st.stuid=sc.stuid;
+<span style="color: #b22222;">-------------</span><span style="color: #b22222;">+-------+</span>
| <span style="color: #a020f0;">name</span>        | score |
+<span style="color: #b22222;">-------------</span><span style="color: #b22222;">+-------+</span>
| Shi Zhongyu |    77 |
| Shi Zhongyu |    93 |
| Shi Potian  |    47 |
| Shi Potian  |    97 |
| Xie Yanke   |    88 |
| Xie Yanke   |    75 |
| Ding Dian   |    71 |
| Ding Dian   |    89 |
| Yu Yutong   |    39 |
| Yu Yutong   |    63 |
| Shi Qing    |    96 |
| Xi Ren      |    86 |
| Xi Ren      |    83 |
| Lin Daiyu   |    57 |
| Lin Daiyu   |    93 |
+<span style="color: #b22222;">-------------</span><span style="color: #b22222;">+-------+</span>
15 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> st.<span style="color: #a020f0;">name</span>,sc.CourseID,sc.score <span style="color: #a020f0;">from</span> students st <span style="color: #a020f0;">inner</span> <span style="color: #a020f0;">join</span> scores sc <span style="color: #a020f0;">on</span> st.stuid=sc.stuid;
+<span style="color: #b22222;">-------------</span><span style="color: #b22222;">+----------+-------+</span>
| <span style="color: #a020f0;">name</span>        | CourseID | score |
+<span style="color: #b22222;">-------------</span><span style="color: #b22222;">+----------+-------+</span>
| Shi Zhongyu |        2 |    77 |
| Shi Zhongyu |        6 |    93 |
| Shi Potian  |        2 |    47 |
| Shi Potian  |        5 |    97 |
| Xie Yanke   |        2 |    88 |
| Xie Yanke   |        6 |    75 |
| Ding Dian   |        5 |    71 |
| Ding Dian   |        2 |    89 |
| Yu Yutong   |        1 |    39 |
| Yu Yutong   |        7 |    63 |
| Shi Qing    |        1 |    96 |
| Xi Ren      |        1 |    86 |
| Xi Ren      |        7 |    83 |
| Lin Daiyu   |        4 |    57 |
| Lin Daiyu   |        3 |    93 |
+<span style="color: #b22222;">-------------</span><span style="color: #b22222;">+----------+-------+</span>
15 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> st.<span style="color: #a020f0;">name</span>,co.Course,sc.score <span style="color: #a020f0;">from</span> students st <span style="color: #a020f0;">inner</span> <span style="color: #a020f0;">join</span> scores sc <span style="color: #a020f0;">on</span> st.stuid=sc.stuid <span style="color: #a020f0;">inner</span> <span style="color: #a020f0;">join</span> courses co <span style="color: #a020f0;">on</span> sc.courseid=co.courseid;
+<span style="color: #b22222;">-------------</span><span style="color: #b22222;">+----------------+-------+</span>
| <span style="color: #a020f0;">name</span>        | Course         | score |
+<span style="color: #b22222;">-------------</span><span style="color: #b22222;">+----------------+-------+</span>
| Shi Zhongyu | Kuihua Baodian |    77 |
| Shi Zhongyu | Weituo Zhang   |    93 |
| Shi Potian  | Kuihua Baodian |    47 |
| Shi Potian  | Daiyu Zanghua  |    97 |
| Xie Yanke   | Kuihua Baodian |    88 |
| Xie Yanke   | Weituo Zhang   |    75 |
| Ding Dian   | Daiyu Zanghua  |    71 |
| Ding Dian   | Kuihua Baodian |    89 |
| Yu Yutong   | Hamo Gong      |    39 |
| Yu Yutong   | Dagou Bangfa   |    63 |
| Shi Qing    | Hamo Gong      |    96 |
| Xi Ren      | Hamo Gong      |    86 |
| Xi Ren      | Dagou Bangfa   |    83 |
| Lin Daiyu   | Taiji Quan     |    57 |
| Lin Daiyu   | Jinshe Jianfa  |    93 |
+<span style="color: #b22222;">-------------</span><span style="color: #b22222;">+----------------+-------+</span>
15 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:e8617f0a-8811-4cc3-a06c-152a5ccf9ddd" class="outline-4">
<h4 id="h:e8617f0a-8811-4cc3-a06c-152a5ccf9ddd">SELECT语句处理的顺序</h4>
<div class="outline-text-4" id="text-h:e8617f0a-8811-4cc3-a06c-152a5ccf9ddd">

<figure id="orgbd13784">
<img src="./images/img_20250217_152845.png" alt="img_20250217_152845.png" width="90%">

</figure>


<p>
查询执行路径中的组件：查询缓存、解析器、预处理器、优化器、查询执行引擎、存储引擎
</p>

<p>
SELECT语句的执行流程：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">FROM</span> Clause <span style="color: #b22222;">--</span><span style="color: #b22222;">&gt; WHERE Clause --&gt; GROUP BY --&gt; HAVING Clause --&gt;SELECT --&gt; ORDER</span>
<span style="color: #a020f0;">BY</span> <span style="color: #b22222;">--</span><span style="color: #b22222;">&gt; LIMIT</span>
</pre>
</div>

<p>
练习
导入hellodb.sql生成数据库
</p>

<ol class="org-ol">
<li>在students表中，查询年龄大于25岁，且为男性的同学的名字和年龄</li>
<li>以ClassID为分组依据，显示每组的平均年龄</li>
<li>显示第2题中平均年龄大于30的分组及平均年龄</li>
<li>显示以L开头的名字的同学的信息</li>
<li>显示TeacherID非空的同学的相关信息</li>
<li>以年龄排序后，显示年龄最大的前10位同学的信息</li>
<li>查询年龄大于等于20岁，小于等于25岁的同学的信息</li>
<li>以ClassID分组，显示每班的同学的人数</li>
<li>以Gender分组，显示其年龄之和</li>
<li>以ClassID分组，显示其平均年龄大于25的班级</li>
<li>以Gender分组，显示各组中年龄大于25的学员的年龄之和</li>
<li>显示前5位同学的姓名、课程及成绩</li>
<li>显示其成绩高于80的同学的名称及课程</li>
<li>取每位同学各门课的平均成绩，显示成绩前三名的同学的姓名和平均成绩</li>
<li>显示每门课程课程名称及学习了这门课的同学的个数</li>
<li>显示其年龄大于平均年龄的同学的名字</li>
<li>显示其学习的课程为第1、2，4或第7门课的同学的名字</li>
<li>显示其成员数最少为3个的班级的同学中年龄大于同班同学平均年龄的同学</li>
<li>统计各班级中年龄大于全校同学平均年龄的同学</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-h:66c3a9d6-08c4-4603-99a3-ba05bf0d0075" class="outline-3">
<h3 id="h:66c3a9d6-08c4-4603-99a3-ba05bf0d0075">VIEW 视图</h3>
<div class="outline-text-3" id="text-h:66c3a9d6-08c4-4603-99a3-ba05bf0d0075">
<p>
视图：虚拟表，保存有实表的查询结果，相当于别名
</p>

<p>
利用视图，可以隐匿表的真实结构，在程序中利用视图进行查询，可以避免表结
构的变化，而修改程序，降低程序和数据库之间的耦合度。
</p>

<p>
创建方法：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">VIEW</span> <span style="color: #0000ff;">view_name</span> [(column_list)]
    <span style="color: #a020f0;">AS</span> select_statement
    [<span style="color: #a020f0;">WITH</span> [<span style="color: #a020f0;">CASCADED</span> | <span style="color: #a020f0;">LOCAL</span>] <span style="color: #a020f0;">CHECK</span> <span style="color: #a020f0;">OPTION</span>]
</pre>
</div>

<p>
查看视图定义：
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW <span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">VIEW</span> view_name #&#21482;&#33021;&#30475;&#35270;&#22270;&#23450;&#20041;
SHOW <span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> view_name # &#21487;&#20197;&#26597;&#30475;&#34920;&#21644;&#35270;&#22270;
</pre>
</div>

<p>
删除视图：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">VIEW</span> [IF <span style="color: #a020f0;">EXISTS</span>]
    view_name [, view_name] ...
    [<span style="color: #a020f0;">RESTRICT</span> | <span style="color: #a020f0;">CASCADE</span>]
</pre>
</div>

<p>
注意：视图中的数据事实上存储于“基表”中，因此，其修改操作也会针对基表
实现；其修改操作受基表限制
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [hellodb]&gt; <span style="color: #a020f0;">create</span> <span style="color: #a020f0;">view</span> v_score <span style="color: #a020f0;">as</span> <span style="color: #a020f0;">select</span> st.<span style="color: #a020f0;">name</span>,co.Course,sc.score <span style="color: #a020f0;">from</span> students st <span style="color: #a020f0;">inner</span> <span style="color: #a020f0;">join</span> scores sc <span style="color: #a020f0;">on</span> st.stuid=sc.stuid <span style="color: #a020f0;">inner</span> <span style="color: #a020f0;">join</span> courses co <span style="color: #a020f0;">on</span> sc.courseid=co.courseid;
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.002 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> v;
ERROR 1146 (42S02): <span style="color: #a020f0;">Table</span> <span style="color: #8b2252;">'hellodb.v'</span> doesn<span style="color: #8b2252;">'t exist</span>
<span style="color: #8b2252;">MariaDB [hellodb]&gt; select * from v_score;</span>
<span style="color: #8b2252;">+-------------+----------------+-------+</span>
<span style="color: #8b2252;">| name        | Course         | score |</span>
<span style="color: #8b2252;">+-------------+----------------+-------+</span>
<span style="color: #8b2252;">| Shi Zhongyu | Kuihua Baodian |    77 |</span>
<span style="color: #8b2252;">| Shi Zhongyu | Weituo Zhang   |    93 |</span>
<span style="color: #8b2252;">| Shi Potian  | Kuihua Baodian |    47 |</span>
<span style="color: #8b2252;">| Shi Potian  | Daiyu Zanghua  |    97 |</span>
<span style="color: #8b2252;">| Xie Yanke   | Kuihua Baodian |    88 |</span>
<span style="color: #8b2252;">| Xie Yanke   | Weituo Zhang   |    75 |</span>
<span style="color: #8b2252;">| Ding Dian   | Daiyu Zanghua  |    71 |</span>
<span style="color: #8b2252;">| Ding Dian   | Kuihua Baodian |    89 |</span>
<span style="color: #8b2252;">| Yu Yutong   | Hamo Gong      |    39 |</span>
<span style="color: #8b2252;">| Yu Yutong   | Dagou Bangfa   |    63 |</span>
<span style="color: #8b2252;">| Shi Qing    | Hamo Gong      |    96 |</span>
<span style="color: #8b2252;">| Xi Ren      | Hamo Gong      |    86 |</span>
<span style="color: #8b2252;">| Xi Ren      | Dagou Bangfa   |    83 |</span>
<span style="color: #8b2252;">| Lin Daiyu   | Taiji Quan     |    57 |</span>
<span style="color: #8b2252;">| Lin Daiyu   | Jinshe Jianfa  |    93 |</span>
<span style="color: #8b2252;">+-------------+----------------+-------+</span>
<span style="color: #8b2252;">15 rows in set (0.001 sec)</span>

<span style="color: #8b2252;">MariaDB [hellodb]&gt; SHOW TABLE STATUS LIKE '</span>v_score<span style="color: #8b2252;">'\G</span>
<span style="color: #8b2252;">************************** 1. row ***************************</span>
<span style="color: #8b2252;">            Name: v_score</span>
<span style="color: #8b2252;">          Engine: NULL</span>
<span style="color: #8b2252;">         Version: NULL</span>
<span style="color: #8b2252;">      Row_format: NULL</span>
<span style="color: #8b2252;">            Rows: NULL</span>
<span style="color: #8b2252;">  Avg_row_length: NULL</span>
<span style="color: #8b2252;">     Data_length: NULL</span>
<span style="color: #8b2252;"> Max_data_length: NULL</span>
<span style="color: #8b2252;">    Index_length: NULL</span>
<span style="color: #8b2252;">       Data_free: NULL</span>
<span style="color: #8b2252;">  Auto_increment: NULL</span>
<span style="color: #8b2252;">     Create_time: NULL</span>
<span style="color: #8b2252;">     Update_time: NULL</span>
<span style="color: #8b2252;">      Check_time: NULL</span>
<span style="color: #8b2252;">       Collation: NULL</span>
<span style="color: #8b2252;">        Checksum: NULL</span>
<span style="color: #8b2252;">  Create_options: NULL</span>
<span style="color: #8b2252;">         Comment: VIEW</span>
<span style="color: #8b2252;">Max_index_length: NULL</span>
<span style="color: #8b2252;">       Temporary: NULL</span>
<span style="color: #8b2252;">1 row in set (0.001 sec)</span>

<span style="color: #8b2252;">[root@centos8 ~]#ls /var/lib/mysql/hellodb/</span>
<span style="color: #8b2252;">classes.frm  courses.frm  emp.ibd       students.ibd   teachers.ibd</span>
<span style="color: #8b2252;">classes.ibd  courses.ibd  scores.frm    teachers2.frm  toc.frm</span>
<span style="color: #8b2252;">coc.frm      db.opt       scores.ibd    teachers2.ibd  toc.ibd</span>
<span style="color: #8b2252;">coc.ibd      emp.frm      students.frm  teachers.frm   v_score.frm</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:51c1117c-9815-453d-b73d-b94b26365b9e" class="outline-3">
<h3 id="h:51c1117c-9815-453d-b73d-b94b26365b9e">FUNCTION函数</h3>
<div class="outline-text-3" id="text-h:51c1117c-9815-453d-b73d-b94b26365b9e">
<p>
函数：分为系统内置函数和自定义函数
</p>

<ul class="org-ul">
<li><p>
系统内置函数参考：
</p>

<p>
<a href="https://dev.mysql.com/doc/refman/5.7/en/built-in-function-reference.html">https://dev.mysql.com/doc/refman/5.7/en/built-in-function-reference.html</a>
</p></li>

<li>自定义函数：user-defined function UDF，保存在mysql.proc表中</li>
</ul>

<p>
<b>创建UDF语法</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> [<span style="color: #a020f0;">AGGREGATE</span>] <span style="color: #a020f0;">FUNCTION</span> function_name(<span style="color: #a020f0;">parameter_name</span> <span style="color: #a020f0;">type</span>,[<span style="color: #a020f0;">parameter_name</span>
<span style="color: #a020f0;">type</span>,...])
  <span style="color: #a020f0;">RETURNS</span> {STRING|<span style="color: #228b22;">INTEGER</span>|<span style="color: #228b22;">REAL</span>}
  runtime_body
</pre>
</div>

<p>
说明：
</p>

<ul class="org-ul">
<li>参数可以有多个,也可以没有参数</li>
<li>无论有无参数，小括号（）是必须的</li>
<li>必须有且只有一个返回值</li>
</ul>

<p>
*查看函数列表*：
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW <span style="color: #a020f0;">FUNCTION</span> STATUS;
</pre>
</div>

<p>
<b>查看函数定义</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW <span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">FUNCTION</span> function_name
</pre>
</div>

<p>
<b>删除UDF</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">FUNCTION</span> <span style="color: #0000ff;">function_name</span>
</pre>
</div>

<p>
<b>调用自定义函数语法</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> function_name(parameter_value,...)
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#26080;&#21442;UDF
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">FUNCTION</span> <span style="color: #0000ff;">simpleFun</span>() <span style="color: #a020f0;">RETURNS</span> <span style="color: #228b22;">VARCHAR</span>(20) <span style="color: #a020f0;">RETURN</span> "Hello World";

#&#26377;&#21442;&#25968;UDF
DELIMITER //   <span style="color: #b22222;">-- </span><span style="color: #b22222;">&#35748;&#20026;//&#26159;&#32467;&#26463;&#65292;&#32780;&#19981;&#26159;;</span>

<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">FUNCTION</span> <span style="color: #0000ff;">deleteById</span>(id <span style="color: #228b22;">SMALLINT</span> UNSIGNED) <span style="color: #a020f0;">RETURNS</span> <span style="color: #228b22;">VARCHAR</span>(20)
<span style="color: #a020f0;">BEGIN</span>
  <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">WHERE</span> stuid = id;
  <span style="color: #a020f0;">RETURN</span> (<span style="color: #a020f0;">SELECT</span> <span style="color: #483d8b;">COUNT</span>(*) <span style="color: #a020f0;">FROM</span> students);
<span style="color: #a020f0;">END</span>//

DELIMITER ;
</pre>
</div>

<p>
<b>MySQL中的变量</b>
</p>

<p>
两种变量：系统内置变量和用户自定义变量
</p>

<ul class="org-ul">
<li>系统变量：MySQL数据库中内置的变量，可用@@var_name引用</li>
<li>用户自定义变量分为以下两种
<ul class="org-ul">
<li>普通变量：在当前会话中有效，可用@var_name引用</li>
<li>局部变量：在函数或存储过程内才有效，需要用DECLARE 声明，之后直接用
var_name引用</li>
</ul></li>
</ul>

<p>
<b>自定义函数中定义局部变量语法</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DECLARE</span> &#21464;&#37327;1[,&#21464;&#37327;2,... ]&#21464;&#37327;&#31867;&#22411; [<span style="color: #a020f0;">DEFAULT</span> &#40664;&#35748;&#20540;]
</pre>
</div>

<p>
说明：局部变量的作用范围是在BEGIN&#x2026;END程序中,而且定义局部变量语句必须在BEGIN&#x2026;END的第一行定义
</p>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sql">DELIMITER //
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">FUNCTION</span> <span style="color: #0000ff;">addTwoNumber</span>(x <span style="color: #228b22;">SMALLINT</span> UNSIGNED, y <span style="color: #228b22;">SMALLINT</span> UNSIGNED)
<span style="color: #a020f0;">RETURNS</span> <span style="color: #228b22;">SMALLINT</span>
<span style="color: #a020f0;">BEGIN</span>
  <span style="color: #a020f0;">DECLARE</span> a, b <span style="color: #228b22;">SMALLINT</span> UNSIGNED;
  <span style="color: #a020f0;">SET</span> a = x, b = y;
  <span style="color: #a020f0;">RETURN</span> a+b;
<span style="color: #a020f0;">END</span>//
DELIMITER ;

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> addTwoNumber(10,20);
+<span style="color: #b22222;">---------------------</span><span style="color: #b22222;">+</span>
| addTwoNumber(10,20) |
+<span style="color: #b22222;">---------------------</span><span style="color: #b22222;">+</span>
|                  30 |
+<span style="color: #b22222;">---------------------</span><span style="color: #b22222;">+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
</pre>
</div>

<p>
<b>为变量赋值语法</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SET</span> <span style="color: #a020f0;">parameter_name</span> = <span style="color: #a020f0;">value</span>[,<span style="color: #a020f0;">parameter_name</span> = <span style="color: #a020f0;">value</span>...]
<span style="color: #a020f0;">SELECT</span> <span style="color: #a020f0;">INTO</span> <span style="color: #a020f0;">parameter_name</span>
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sql">.....
<span style="color: #a020f0;">DECLARE</span> x <span style="color: #228b22;">int</span>;
<span style="color: #a020f0;">SELECT</span> <span style="color: #483d8b;">COUNT</span>(*) <span style="color: #a020f0;">FROM</span> tdb_name <span style="color: #a020f0;">INTO</span> x;
<span style="color: #a020f0;">RETURN</span> x;
<span style="color: #a020f0;">END</span>//
</pre>
</div>

<p>
范例：自定义的普通变量
</p>
</div>
</div>
<div id="outline-container-h:2a5f6ed2-cdc6-42b1-9cf6-f95674b364df" class="outline-3">
<h3 id="h:2a5f6ed2-cdc6-42b1-9cf6-f95674b364df">PROCEDURE 存储过程</h3>
<div class="outline-text-3" id="text-h:2a5f6ed2-cdc6-42b1-9cf6-f95674b364df">
<p>
存储过程：多表SQL的语句的集合，可以独立执行，存储过程保存在mysql.proc表中
</p>

<p>
<b>存储过程优势</b>
</p>

<p>
存储过程把经常使用的SQL语句或业务逻辑封装起来,预编译保存在数据库中,当
需要时从数据库中直接调用,省去了编译的过程，提高了运行速度，同时降低网
络数据传输量
</p>

<p>
<b>存储过程与自定义函数的区别</b>
</p>

<ul class="org-ul">
<li>存储过程实现的过程要复杂一些,而函数的针对性较强</li>
<li>存储过程可以有多个返回值,而自定义函数只有一个返回值</li>
<li>存储过程一般可独立执行,而函数往往是作为其他SQL语句的一部分来使用</li>
<li>无参数的存储过程执行过程中可以不加()，函数必须加()</li>
</ul>

<p>
<b>创建存储过程</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">PROCEDURE</span> <span style="color: #0000ff;">sp_name</span> ([ proc_parameter [,proc_parameter ...]])
routime_body

proc_parameter : [<span style="color: #a020f0;">IN</span>|<span style="color: #a020f0;">OUT</span>|<span style="color: #a020f0;">INOUT</span>] <span style="color: #a020f0;">parameter_name</span> <span style="color: #a020f0;">type</span>
</pre>
</div>

<p>
说明：其中IN表示输入参数，OUT表示输出参数，INOUT表示既可以输入也可以输
出；param_name 表示参数名称；type表示参数的类型
</p>

<p>
<b>查看存储过程列表</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW <span style="color: #a020f0;">PROCEDURE</span> STATUS;
</pre>
</div>

<p>
<b>查看存储过程定义</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW <span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">PROCEDURE</span> sp_name
</pre>
</div>

<p>
<b>调用存储过程</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CALL</span> sp_name ([ proc_parameter [,proc_parameter ...]])
</pre>
</div>

<p>
说明:当无参时,可以省略”()",当有参数时,不可省略"()”
</p>

<p>
<b>存储过程修改</b>
</p>

<p>
ALTER语句修改存储过程只能修改存储过程的注释等无关紧要的东西,不能修改存
储过程体,所以要修改存储过程,方法就是删除重建
</p>

<p>
<b>删除存储过程</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">PROCEDURE</span> [IF <span style="color: #a020f0;">EXISTS</span>] sp_name
</pre>
</div>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sql"># &#21019;&#24314;&#26080;&#21442;&#23384;&#20648;&#36807;&#31243;
delimiter //
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">PROCEDURE</span> <span style="color: #0000ff;">showTime</span>()
<span style="color: #a020f0;">BEGIN</span>
  <span style="color: #a020f0;">SELECT</span> now();
<span style="color: #a020f0;">END</span>//
delimiter ;

<span style="color: #a020f0;">CALL</span> showTime;
</pre>
</div>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#21019;&#24314;&#21547;&#21442;&#23384;&#20648;&#36807;&#31243;&#65306;&#21482;&#26377;&#19968;&#20010;<span style="color: #a020f0;">IN</span>&#21442;&#25968;
delimiter //
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">PROCEDURE</span> <span style="color: #0000ff;">selectById</span>(<span style="color: #a020f0;">IN</span> id <span style="color: #228b22;">SMALLINT</span> UNSIGNED)
<span style="color: #a020f0;">BEGIN</span>
  <span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">WHERE</span> stuid = id;
<span style="color: #a020f0;">END</span>//
delimiter ;
<span style="color: #a020f0;">call</span> selectById(2);
</pre>
</div>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sql">delimiter //
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">PROCEDURE</span> <span style="color: #0000ff;">dorepeat</span>(n <span style="color: #228b22;">INT</span>)
<span style="color: #a020f0;">BEGIN</span>
  <span style="color: #a020f0;">SET</span> @i = 0;
  <span style="color: #a020f0;">SET</span> @<span style="color: #483d8b;">sum</span> = 0;
  REPEAT <span style="color: #a020f0;">SET</span> @<span style="color: #483d8b;">sum</span> = @<span style="color: #483d8b;">sum</span>+@i;
  <span style="color: #a020f0;">SET</span> @i = @i + 1;
  UNTIL @i &gt; n <span style="color: #a020f0;">END</span> REPEAT;
<span style="color: #a020f0;">END</span>//
delimiter ;
<span style="color: #a020f0;">CALL</span> dorepeat(100);
<span style="color: #a020f0;">SELECT</span> @<span style="color: #483d8b;">sum</span>;
</pre>
</div>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#21019;&#24314;&#21547;&#21442;&#23384;&#20648;&#36807;&#31243;:&#21253;&#21547;<span style="color: #a020f0;">IN</span>&#21442;&#25968;&#21644;<span style="color: #a020f0;">OUT</span>&#21442;&#25968;
delimiter //
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">PROCEDURE</span> <span style="color: #0000ff;">deleteById</span>(<span style="color: #a020f0;">IN</span> id <span style="color: #228b22;">SMALLINT</span> UNSIGNED, <span style="color: #a020f0;">OUT</span> num <span style="color: #228b22;">SMALLINT</span> UNSIGNED)
<span style="color: #a020f0;">BEGIN</span>
<span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">WHERE</span> stuid &gt;= id;
<span style="color: #a020f0;">SELECT</span> <span style="color: #a020f0;">row_count</span>() <span style="color: #a020f0;">into</span> num;
<span style="color: #a020f0;">END</span>//
delimiter ;
<span style="color: #a020f0;">call</span> deleteById(2,@Line);
<span style="color: #a020f0;">SELECT</span> @Line;
#&#35828;&#26126;:&#21019;&#24314;&#23384;&#20648;&#36807;&#31243;deleteById,&#21253;&#21547;&#19968;&#20010;<span style="color: #a020f0;">IN</span>&#21442;&#25968;&#21644;&#19968;&#20010;<span style="color: #a020f0;">OUT</span>&#21442;&#25968;.&#35843;&#29992;&#26102;,&#20256;&#20837;&#21024;&#38500;&#30340;ID&#21644;&#20445;&#23384;&#34987;&#20462;&#25913;&#30340;&#34892;&#25968;&#20540;&#30340;&#29992;&#25143;&#21464;&#37327;@Line,<span style="color: #a020f0;">select</span> @Line;&#36755;&#20986;&#34987;&#24433;&#21709;&#34892;&#25968;
#<span style="color: #a020f0;">row_count</span>() &#31995;&#32479;&#20869;&#32622;&#20989;&#25968;&#65292;&#29992;&#20110;&#23384;&#25918;&#21069;&#19968;&#26465;<span style="color: #a020f0;">SQL</span>&#20462;&#25913;&#36807;&#30340;&#34920;&#30340;&#35760;&#24405;&#25968;
</pre>
</div>

<p>
<b>流程控制</b>
</p>

<p>
存储过程和函数中可以使用流程控制来控制语句的执行
</p>

<ul class="org-ul">
<li>IF：用来进行条件判断。根据是否满足条件，执行不同语句</li>
<li>CASE：用来进行条件判断，可实现比IF语句更复杂的条件判断</li>
<li>LOOP：重复执行特定的语句，实现一个简单的循环</li>
<li>LEAVE：用于跳出循环控制，相当于SHELL中break</li>
<li>ITERATE：跳出本次循环，然后直接进入下一次循环，相当于SHELL中continue</li>
<li>REPEAT：有条件控制的循环语句。当满足特定条件时，就会跳出循环语句</li>
<li>WHILE：有条件控制的循环语句</li>
</ul>

<p>
范例：CASE 判断
</p>
<div class="org-src-container">
<pre class="src src-sh">body.errorType: 2  | SELECT
  <span style="color: #8b2252;">"body.errorType"</span> AS <span style="color: #8b2252;">"errorType"</span>,
  COUNT(*) AS cnt,
  (
    CASE
      WHEN <span style="color: #8b2252;">"body.errorType"</span> = 2 THEN <span style="color: #8b2252;">'&#25238;&#38899;&#23567;&#31243;&#24207;&#35270;&#39057;&#38169;&#35823;'</span>
      ELSE <span style="color: #8b2252;">'&#26410;&#30693;&#24322;&#24120;&#65292;&#35831;&#25490;&#26597;'</span>
    END
  ) AS <span style="color: #8b2252;">"errorDesc"</span>,
  ARRAY_JOIN(
    ARRAY_AGG(
     DISTINCT CASE
        WHEN <span style="color: #8b2252;">"body"</span> LIKE <span style="color: #8b2252;">'%videoUrlObj%'</span> THEN
          REGEXP_EXTRACT(<span style="color: #8b2252;">"body"</span>, <span style="color: #8b2252;">'(?&lt;="compilationsId":)([0-9]+)'</span>)
        ELSE NULL
      END
    ),
    <span style="color: #8b2252;">','</span>
  ) AS <span style="color: #8b2252;">"&#21512;&#38598;ID"</span>
FROM <span style="color: #8b2252;">"error-push"</span>
GROUP BY
  <span style="color: #8b2252;">"body.errorType"</span>
ORDER BY
  cnt DESC
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f80bd23f-fd88-4aa3-853c-a02739cd87c9" class="outline-3">
<h3 id="h:f80bd23f-fd88-4aa3-853c-a02739cd87c9">TRIGGER触发器</h3>
<div class="outline-text-3" id="text-h:f80bd23f-fd88-4aa3-853c-a02739cd87c9">
<p>
触发器的执行不是由程序调用，也不是由手工启动，而是由事件来触发、激活从
而实现执行。但一般由应用端完成，触发器会增加数据库负担
</p>

<p>
<b>创建触发器</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> [<span style="color: #a020f0;">DEFINER</span> = { <span style="color: #483d8b;">user</span> | <span style="color: #483d8b;">CURRENT_USER</span> }]
  <span style="color: #a020f0;">TRIGGER</span> <span style="color: #a020f0;">trigger_name</span>
  trigger_time trigger_event
  <span style="color: #a020f0;">ON</span> tbl_name <span style="color: #a020f0;">FOR</span> <span style="color: #a020f0;">EACH</span> <span style="color: #228b22;">ROW</span>
  trigger_body
</pre>
</div>

<p>
说明：
</p>

<p>
trigger_name：触发器的名称
</p>

<p>
trigger_time：{ BEFORE | AFTER }，表示在事件之前或之后触发
</p>

<p>
trigger_event:：{ INSERT |UPDATE | DELETE }，触发的具体事件
</p>

<p>
tbl_name：该触发器作用在表名
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#21019;&#24314;&#35302;&#21457;&#22120;&#65292;&#22312;&#21521;&#23398;&#29983;&#34920;<span style="color: #a020f0;">INSERT</span>&#25968;&#25454;&#26102;&#65292;&#23398;&#29983;&#25968;&#22686;&#21152;&#65292;<span style="color: #a020f0;">DELETE</span>&#23398;&#29983;&#26102;&#65292;&#23398;&#29983;&#25968;&#20943;&#23569;
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">student_info</span> (
  stu_id <span style="color: #228b22;">INT</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> AUTO_INCREMENT ,
  stu_name <span style="color: #228b22;">VARCHAR</span>(255) <span style="color: #a020f0;">DEFAULT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (stu_id)
);
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">student_count</span> (
  student_count <span style="color: #228b22;">INT</span>(11) <span style="color: #a020f0;">DEFAULT</span> 0
);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> student_count <span style="color: #a020f0;">VALUES</span>(0);

<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TRIGGER</span> <span style="color: #0000ff;">trigger_student_count_insert</span>
<span style="color: #a020f0;">AFTER</span> <span style="color: #a020f0;">INSERT</span>
<span style="color: #a020f0;">ON</span> student_info <span style="color: #a020f0;">FOR</span> <span style="color: #a020f0;">EACH</span> <span style="color: #228b22;">ROW</span>
<span style="color: #a020f0;">UPDATE</span> student_count <span style="color: #a020f0;">SET</span> student_count=student_count+1;

<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TRIGGER</span> <span style="color: #0000ff;">trigger_student_count_delete</span>
<span style="color: #a020f0;">AFTER</span> <span style="color: #a020f0;">DELETE</span>
<span style="color: #a020f0;">ON</span> student_info <span style="color: #a020f0;">FOR</span> <span style="color: #a020f0;">EACH</span> <span style="color: #228b22;">ROW</span>
<span style="color: #a020f0;">UPDATE</span> student_count <span style="color: #a020f0;">SET</span> student_count=student_count-1;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /var/lib/mysql/hellodb/trigger_student_count_delete.TRN 
<span style="color: #a0522d;">TYPE</span>=TRIGGERNAME
<span style="color: #a0522d;">trigger_table</span>=student_info
[root@centos8 ~]#cat /var/lib/mysql/hellodb/trigger_student_count_insert.TRN 
<span style="color: #a0522d;">TYPE</span>=TRIGGERNAME
<span style="color: #a0522d;">trigger_table</span>=student_info
[root@centos8 ~]#cat /var/lib/mysql/hellodb/student_info.TRG 
<span style="color: #a0522d;">TYPE</span>=TRIGGERS
<span style="color: #a0522d;">triggers</span>=<span style="color: #8b2252;">'CREATE DEFINER=`root`@`localhost` TRIGGER trigger_student_count_insert\nAFTER INSERT\nON student_info FOR EACH ROW\nUPDATE student_count SET student_count=student_count+1'</span> <span style="color: #8b2252;">'CREATE DEFINER=`root`@`localhost` TRIGGER trigger_student_count_delete\nAFTER DELETE\nON student_info FOR EACH ROW\nUPDATE student_count SET student_count=student_count-1'</span>
<span style="color: #a0522d;">sql_modes</span>=1411383296 1411383296
<span style="color: #a0522d;">definers</span>=<span style="color: #8b2252;">'root@localhost'</span> <span style="color: #8b2252;">'root@localhost'</span>
<span style="color: #a0522d;">client_cs_names</span>=<span style="color: #8b2252;">'utf8'</span> <span style="color: #8b2252;">'utf8'</span>
<span style="color: #a0522d;">connection_cl_names</span>=<span style="color: #8b2252;">'utf8_general_ci'</span> <span style="color: #8b2252;">'utf8_general_ci'</span>
<span style="color: #a0522d;">db_cl_names</span>=<span style="color: #8b2252;">'utf8_general_ci'</span> <span style="color: #8b2252;">'utf8_general_ci'</span>
<span style="color: #a0522d;">created</span>=159142866954 159142867177
</pre>
</div>



<figure id="org2603204">
<img src="./images/20200606153423730.png" alt="20200606153423730.png" width="60%">

</figure>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> student_info;
Empty <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> student_count;
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+</span>
| student_count |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+</span>
|             0 |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">insert</span> student_info (stu_name)<span style="color: #a020f0;">value</span>(<span style="color: #8b2252;">'xioaming'</span>);
Query OK, 1 <span style="color: #228b22;">row</span> affected (0.002 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> student_info;
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+----------+</span>
| stu_id | stu_name |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+----------+</span>
|      1 | xioaming |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+----------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> student_count;
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+</span>
| student_count |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+</span>
|             1 |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">insert</span> student_info (stu_name)<span style="color: #a020f0;">value</span>(<span style="color: #8b2252;">'xiaohong'</span>);
Query OK, 1 <span style="color: #228b22;">row</span> affected (0.001 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">insert</span> student_info (stu_name)<span style="color: #a020f0;">value</span>(<span style="color: #8b2252;">'xiaoqiang'</span>),(<span style="color: #8b2252;">'wangcai'</span>);
Query OK, 2 <span style="color: #a020f0;">rows</span> affected (0.002 sec)
Records: 2  Duplicates: 0  Warnings: 0

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> student_info;
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+-----------+</span>
| stu_id | stu_name  |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+-----------+</span>
|      1 | xioaming  |
|      2 | xiaohong  |
|      3 | xiaoqiang |
|      4 | wangcai   |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+-----------+</span>
4 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> student_count;
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+</span>
| student_count |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+</span>
|             4 |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">delete</span> <span style="color: #a020f0;">from</span> student_info <span style="color: #a020f0;">where</span> stu_id &gt;= 3;
Query OK, 2 <span style="color: #a020f0;">rows</span> affected (0.001 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> student_count;
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+</span>
| student_count |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+</span>
|             2 |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> student_info;
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+----------+</span>
| stu_id | stu_name |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+----------+</span>
|      1 | xioaming |
|      2 | xiaohong |
+<span style="color: #b22222;">--------</span><span style="color: #b22222;">+----------+</span>
2 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
</pre>
</div>

<p>
<b>查看触发器</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#22312;&#24403;&#21069;&#25968;&#25454;&#24211;&#23545;&#24212;&#30340;&#30446;&#24405;&#19979;&#65292;&#21487;&#20197;&#26597;&#30475;&#21040;&#26032;&#29983;&#25104;&#30340;&#30456;&#20851;&#25991;&#20214;&#65306;<span style="color: #a020f0;">trigger_name</span>.TRN,<span style="color: #a020f0;">table</span> _name.TRG
SHOW TRIGGERS;
#&#26597;&#35810;&#31995;&#32479;&#34920;information_schema.triggers&#30340;&#26041;&#24335;&#25351;&#23450;&#26597;&#35810;&#26465;&#20214;&#65292;&#26597;&#30475;&#25351;&#23450;&#30340;&#35302;&#21457;&#22120;&#20449;&#24687;&#12290;
USE information_schema;
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> triggers <span style="color: #a020f0;">WHERE</span> <span style="color: #a020f0;">trigger_name</span>=<span style="color: #8b2252;">'trigger_student_count_insert'</span>;
</pre>
</div>

<p>
<b>删除触发器</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">TRIGGER</span> <span style="color: #a020f0;">trigger_name</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d51dfa5e-e72c-4c13-a756-4e81e1b2995f" class="outline-3">
<h3 id="h:d51dfa5e-e72c-4c13-a756-4e81e1b2995f">Event 事件</h3>
<div class="outline-text-3" id="text-h:d51dfa5e-e72c-4c13-a756-4e81e1b2995f">
</div>
<div id="outline-container-h:917a0998-0d2c-405b-9627-5358d14e37b7" class="outline-4">
<h4 id="h:917a0998-0d2c-405b-9627-5358d14e37b7">Event 事件介绍</h4>
<div class="outline-text-4" id="text-h:917a0998-0d2c-405b-9627-5358d14e37b7">
<p>
事件（event）是MySQL在相应的时刻调用的过程式数据库对象。一个事件可调用
一次，也可周期性的启动，它由一个特定的线程来管理的，也就是所谓的“事件
调度器”。
</p>

<p>
事件和触发器类似，都是在某些事情发生的时候启动。当数据库上启动一条语句
的时候，触发器就启动了，而事件是根据调度事件来启动的。由于它们彼此相似，
所以事件也称为临时性触发器。
</p>

<p>
事件取代了原先只能由操作系统的计划任务来执行的工作，而且MySQL的事件调
度器可以精确到每秒钟执行一个任务，而操作系统的计划任务（如：Linux下的
CRON或Windows下的任务计划）只能精确到每分钟执行一次。
</p>

<p>
<b>事件的优缺点</b>
</p>

<p>
优点：一些对数据定时性操作不再依赖外部程序，而直接使用数据库本身提供的
功能，可以实现每秒钟执行一个任务，这在一些对实时性要求较高的环境下就非
常实用
</p>

<p>
缺点：定时触发，不可以直接调用
</p>
</div>
</div>
<div id="outline-container-h:581c701f-e400-4ec0-bc6e-2f0c17caebaa" class="outline-4">
<h4 id="h:581c701f-e400-4ec0-bc6e-2f0c17caebaa">Event 管理</h4>
<div class="outline-text-4" id="text-h:581c701f-e400-4ec0-bc6e-2f0c17caebaa">
<p>
<b>相关变量和服务器选项</b>
</p>

<p>
MySQL事件调度器event_scheduler负责调用事件，它默认是关闭的。这个调度器
不断地监视一个事件是否要调用，要创建事件，必须打开调度器
</p>

<p>
服务器系统变量和服务器选项：
</p>

<p>
event_scheduler：默认值为OFF，设置为ON才支持Event，并且系统自动打开专用的线程
</p>

<p>
范例：开启和关闭event_scheduler
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#40664;&#35748;&#20107;&#20214;&#35843;&#24230;&#21151;&#33021;&#26159;&#20851;&#38381;&#30340;
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; <span style="color: #a020f0;">select</span> @@event_scheduler; <span style="color: #b22222;">-- </span><span style="color: #b22222;">@@ &#34920;&#31034;&#31995;&#32479;&#33258;&#24102;&#21464;&#37327;</span>
+<span style="color: #b22222;">-------------------</span><span style="color: #b22222;">+</span>
| @@event_scheduler |
+<span style="color: #b22222;">-------------------</span><span style="color: #b22222;">+</span>
| <span style="color: #a020f0;">OFF</span>               |
+<span style="color: #b22222;">-------------------</span><span style="color: #b22222;">+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

#&#20020;&#26102;&#24320;&#21551;&#20107;&#20214;&#35843;&#24230;&#21151;&#33021;
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; <span style="color: #a020f0;">set</span> <span style="color: #a020f0;">global</span> event_scheduler=1; <span style="color: #b22222;">-- </span><span style="color: #b22222;">1 on true &#37117;&#26159;&#31561;&#20215;&#30340;</span>
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.000 sec)

MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; show processlist;
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-----------------+-----------+------+---------+------+--------------------------+------------------+----------+</span>
| Id | <span style="color: #483d8b;">User</span>            | <span style="color: #a020f0;">Host</span>      | db   | Command | <span style="color: #228b22;">Time</span> | <span style="color: #a020f0;">State</span>                    | Info             | Progress |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-----------------+-----------+------+---------+------+--------------------------+------------------+----------+</span>
|  1 | <span style="color: #a020f0;">system</span> <span style="color: #483d8b;">user</span>     |           | <span style="color: #a020f0;">NULL</span> | Daemon  | <span style="color: #a020f0;">NULL</span> | InnoDB purge coordinator | <span style="color: #a020f0;">NULL</span>             |    0.000 |
|  2 | <span style="color: #a020f0;">system</span> <span style="color: #483d8b;">user</span>     |           | <span style="color: #a020f0;">NULL</span> | Daemon  | <span style="color: #a020f0;">NULL</span> | InnoDB purge worker      | <span style="color: #a020f0;">NULL</span>             |    0.000 |
|  4 | <span style="color: #a020f0;">system</span> <span style="color: #483d8b;">user</span>     |           | <span style="color: #a020f0;">NULL</span> | Daemon  | <span style="color: #a020f0;">NULL</span> | InnoDB purge worker      | <span style="color: #a020f0;">NULL</span>             |    0.000 |
|  3 | <span style="color: #a020f0;">system</span> <span style="color: #483d8b;">user</span>     |           | <span style="color: #a020f0;">NULL</span> | Daemon  | <span style="color: #a020f0;">NULL</span> | InnoDB purge worker      | <span style="color: #a020f0;">NULL</span>             |    0.000 |
|  5 | <span style="color: #a020f0;">system</span> <span style="color: #483d8b;">user</span>     |           | <span style="color: #a020f0;">NULL</span> | Daemon  | <span style="color: #a020f0;">NULL</span> | InnoDB shutdown handler  | <span style="color: #a020f0;">NULL</span>             |    0.000 |
|  6 | event_scheduler | localhost | <span style="color: #a020f0;">NULL</span> | Daemon  | 2166 | Waiting <span style="color: #a020f0;">on</span> empty queue   | <span style="color: #a020f0;">NULL</span>             |    0.000 |
| 10 | root            | localhost | <span style="color: #a020f0;">NULL</span> | Query   |    0 | Init                     | show processlist |    0.000 |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-----------------+-----------+------+---------+------+--------------------------+------------------+----------+</span>
7 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

#&#20020;&#26102;&#20851;&#38381;&#20107;&#20214;&#35843;&#24230;&#21151;&#33021;
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; <span style="color: #a020f0;">set</span> <span style="color: #a020f0;">global</span> event_scheduler=0;
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.000 sec)

MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; show processlist;
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------------+-----------+------+---------+------+--------------------------+------------------+----------+</span>
| Id | <span style="color: #483d8b;">User</span>        | <span style="color: #a020f0;">Host</span>      | db   | Command | <span style="color: #228b22;">Time</span> | <span style="color: #a020f0;">State</span>                    | Info             | Progress |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------------+-----------+------+---------+------+--------------------------+------------------+----------+</span>
|  1 | <span style="color: #a020f0;">system</span> <span style="color: #483d8b;">user</span> |           | <span style="color: #a020f0;">NULL</span> | Daemon  | <span style="color: #a020f0;">NULL</span> | InnoDB purge coordinator | <span style="color: #a020f0;">NULL</span>             |    0.000 |
|  2 | <span style="color: #a020f0;">system</span> <span style="color: #483d8b;">user</span> |           | <span style="color: #a020f0;">NULL</span> | Daemon  | <span style="color: #a020f0;">NULL</span> | InnoDB purge worker      | <span style="color: #a020f0;">NULL</span>             |    0.000 |
|  4 | <span style="color: #a020f0;">system</span> <span style="color: #483d8b;">user</span> |           | <span style="color: #a020f0;">NULL</span> | Daemon  | <span style="color: #a020f0;">NULL</span> | InnoDB purge worker      | <span style="color: #a020f0;">NULL</span>             |    0.000 |
|  3 | <span style="color: #a020f0;">system</span> <span style="color: #483d8b;">user</span> |           | <span style="color: #a020f0;">NULL</span> | Daemon  | <span style="color: #a020f0;">NULL</span> | InnoDB purge worker      | <span style="color: #a020f0;">NULL</span>             |    0.000 |
|  5 | <span style="color: #a020f0;">system</span> <span style="color: #483d8b;">user</span> |           | <span style="color: #a020f0;">NULL</span> | Daemon  | <span style="color: #a020f0;">NULL</span> | InnoDB shutdown handler  | <span style="color: #a020f0;">NULL</span>             |    0.000 |
| 10 | root        | localhost | <span style="color: #a020f0;">NULL</span> | Query   |    0 | Init                     | show processlist |    0.000 |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------------+-----------+------+---------+------+--------------------------+------------------+----------+</span>
6 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

#&#25345;&#20037;&#24320;&#21551;&#20107;&#20214;&#35843;&#24230;
[root@centos8 ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
event_scheduler=<span style="color: #a020f0;">ON</span>
[root@centos8 ~]#systemctl restart mariadb
</pre>
</div>

<p>
<b>管理事件</b>
</p>

<p>
create event语句创建一个事件。每个事件由两个主要部分组成，第一部分是事
件调度（event schedule），表示事件何时启动以及按什么频率启动，第二部分
是事件动作（event action），这是事件启动时执行的代码，事件的动作包含一
条SQL语句，它可能是一个简单地insert或者update语句，也可以使一个存储过
程或者benin&#x2026;end语句块，这两种情况允许我们执行多条SQL
</p>


<p>
一个事件可以是活动（打开）的或停止（关闭）的，活动意味着事件调度器检查
事件动作是否必须调用，停止意味着事件的声明存储在目录中，但调度器不会检
查它是否应该调用。在一个事件创建之后，它立即变为活动的，一个活动的事件
可以执行一次或者多次
</p>

<p>
<b>创建Event</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span>
    [<span style="color: #a020f0;">DEFINER</span> = { <span style="color: #483d8b;">user</span> | <span style="color: #483d8b;">CURRENT_USER</span> }]
    EVENT
    [IF <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">EXISTS</span>]
    event_name
    <span style="color: #a020f0;">ON</span> SCHEDULE schedule
    [<span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">COMPLETION</span> [<span style="color: #a020f0;">NOT</span>] <span style="color: #a020f0;">PRESERVE</span>]
    [ENABLE | DISABLE | DISABLE <span style="color: #a020f0;">ON</span> SLAVE]
    [COMMENT <span style="color: #8b2252;">'comment'</span>]
    DO event_body;

schedule:
    <span style="color: #a020f0;">AT</span> <span style="color: #228b22;">timestamp</span> [+ <span style="color: #228b22;">INTERVAL</span> <span style="color: #228b22;">interval</span>] ...
  | <span style="color: #a020f0;">EVERY</span> <span style="color: #228b22;">interval</span>
    [STARTS <span style="color: #228b22;">timestamp</span> [+ <span style="color: #228b22;">INTERVAL</span> <span style="color: #228b22;">interval</span>] ...]
    [ENDS <span style="color: #228b22;">timestamp</span> [+ <span style="color: #228b22;">INTERVAL</span> <span style="color: #228b22;">interval</span>] ...]

<span style="color: #228b22;">interval</span>:
    quantity {<span style="color: #a020f0;">YEAR</span> | QUARTER | <span style="color: #a020f0;">MONTH</span> | <span style="color: #a020f0;">DAY</span> | <span style="color: #a020f0;">HOUR</span> | <span style="color: #a020f0;">MINUTE</span> |
              WEEK | <span style="color: #a020f0;">SECOND</span> | YEAR_MONTH | DAY_HOUR | DAY_MINUTE |
              DAY_SECOND | HOUR_MINUTE | HOUR_SECOND | MINUTE_SECOND}
</pre>
</div>

<p>
说明：
</p>

<ul class="org-ul">
<li>event_name ：创建的event名字，必须是唯一确定的</li>
<li>ON SCHEDULE：计划任务</li>
<li>schedule:决定event的执行时间和频率（注意时间一定要是将来的时间，过去
的时间会出错），有两种形式AT和EVERY</li>
<li>[ON COMPLETION [NOT] PRESERVE]： 可选项，默认是ON COMPLETION NOT
PRESERVE 即计划任务执行完毕后自动drop该事件；ON COMPLETION PRESERVE
则不会drop掉</li>
<li>[COMMENT 'comment'] ：可选项，comment
用来描述event；相当注释，最大长度64个字节</li>
<li>[ENABLE | DISABLE]：设定event的状态，默认ENABLE：表示系统尝试执行这
个事件，DISABLE：关闭该事情，可以用alter修改</li>
<li>DO event_body: 需要执行的sql语句，可以是复合语句</li>
</ul>

<p>
提示：event事件是存放在mysql.event表中
</p>

<p>
<b>查看Event</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW EVENTS [{<span style="color: #a020f0;">FROM</span> | <span style="color: #a020f0;">IN</span>} <span style="color: #a020f0;">schema_name</span>]
[<span style="color: #a020f0;">LIKE</span> <span style="color: #8b2252;">'pattern'</span> | <span style="color: #a020f0;">WHERE</span> expr]
</pre>
</div>

<p>
注意：事件执行完即释放，如立即执行事件，执行完后，事件便自动删除，多次
调用事件或等待执行事件,才可以用上述命令查看到。
</p>

<p>
<b>修改Event</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">ALTER</span>
    [<span style="color: #a020f0;">DEFINER</span> = { <span style="color: #483d8b;">user</span> | <span style="color: #483d8b;">CURRENT_USER</span> }]
    EVENT event_name
    [<span style="color: #a020f0;">ON</span> SCHEDULE schedule]
    [<span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">COMPLETION</span> [<span style="color: #a020f0;">NOT</span>] <span style="color: #a020f0;">PRESERVE</span>]
    [RENAME <span style="color: #a020f0;">TO</span> new_event_name]
    [ENABLE | DISABLE | DISABLE <span style="color: #a020f0;">ON</span> SLAVE]
    [COMMENT <span style="color: #8b2252;">'comment'</span>]
    [DO event_body]
</pre>
</div>

<p>
注意：alter event语句可以修改事件的定义和属性。可以让一个事件成为停止
的或者再次让它活动，也可以修改一个事件的名字或者整个调度。然而当一个使
用 ON COMPLETION NOT PRESERVE 属性定义的事件最后一次执行后，事件直接就
不存在了，不能修改
</p>

<p>
<b>删除Event</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DROP</span> EVENT [IF <span style="color: #a020f0;">EXISTS</span>] event_name
</pre>
</div>

<p>
<b>范例</b>
</p>

<p>
范例：创建立即启动事件
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; <span style="color: #a020f0;">create</span> database testdb;
Query OK, 1 <span style="color: #228b22;">row</span> affected (0.000 sec)
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; use testdb
Database changed
#&#21019;&#24314;&#19968;&#20010;&#34920;&#35760;&#24405;&#27599;&#27425;&#20107;&#20214;&#35843;&#24230;&#30340;&#21517;&#23383;&#21644;&#20107;&#20214;&#25139;
MariaDB [testdb]&gt; <span style="color: #a020f0;">create</span> <span style="color: #a020f0;">table</span> events_list(event_name <span style="color: #228b22;">varchar</span>(20) <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">null</span>,event_started <span style="color: #228b22;">timestamp</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">null</span>);
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.006 sec)

#&#20020;&#26102;&#20851;&#38381;&#20107;&#20214;&#35843;&#24230;&#21151;&#33021;
MariaDB [testdb]&gt; <span style="color: #a020f0;">set</span> <span style="color: #a020f0;">global</span> event_scheduler=0;
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.000 sec)
MariaDB [testdb]&gt; show variables <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'event_scheduler'</span>;
+<span style="color: #b22222;">-----------------</span><span style="color: #b22222;">+-------+</span>
| Variable_name   | <span style="color: #a020f0;">Value</span> |
+<span style="color: #b22222;">-----------------</span><span style="color: #b22222;">+-------+</span>
| event_scheduler | <span style="color: #a020f0;">OFF</span>   |
+<span style="color: #b22222;">-----------------</span><span style="color: #b22222;">+-------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

#&#21019;&#24314;&#19968;&#27425;&#24615;&#20107;&#20214;
MariaDB [testdb]&gt; <span style="color: #a020f0;">create</span> event event_now <span style="color: #a020f0;">on</span> schedule <span style="color: #a020f0;">at</span> now() do <span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> events_list <span style="color: #a020f0;">values</span>(<span style="color: #8b2252;">'event_now'</span>, now());
Query OK, 0 <span style="color: #a020f0;">rows</span> affected, 1 warning (0.000 sec)

#&#22240;&#20026;&#20107;&#20214;&#35843;&#24230;&#21151;&#33021;&#31105;&#29992;&#65292;&#25152;&#26377;&#34920;&#20013;&#26080;&#35760;&#24405;
MariaDB [testdb]&gt; <span style="color: #a020f0;">select</span> *<span style="color: #a020f0;">from</span> events_list;
Empty <span style="color: #a020f0;">set</span> (0.001 sec)

#&#26597;&#30475;&#20107;&#20214;
MariaDB [testdb]&gt; show events\G
************************** 1. <span style="color: #228b22;">row</span> ***************************
                  Db: testdb
                <span style="color: #a020f0;">Name</span>: event_now
             <span style="color: #a020f0;">Definer</span>: root@localhost
           <span style="color: #228b22;">Time</span> <span style="color: #228b22;">zone</span>: <span style="color: #a020f0;">SYSTEM</span>
                <span style="color: #a020f0;">Type</span>: ONE <span style="color: #228b22;">TIME</span>
          <span style="color: #a020f0;">Execute</span> <span style="color: #a020f0;">at</span>: 2020-06-06 16:52:08
      <span style="color: #228b22;">Interval</span> <span style="color: #a020f0;">value</span>: <span style="color: #a020f0;">NULL</span>
      <span style="color: #228b22;">Interval</span> field: <span style="color: #a020f0;">NULL</span>
              Starts: <span style="color: #a020f0;">NULL</span>
                Ends: <span style="color: #a020f0;">NULL</span>
              Status: ENABLED
          Originator: 1
character_set_client: utf8
collation_connection: utf8_general_ci
  Database <span style="color: #a020f0;">Collation</span>: latin1_swedish_ci
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

#&#20219;&#21153;&#35745;&#21010;&#23384;&#25918;&#22312;mysql.event&#34920;&#20013;
MariaDB [testdb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> mysql.event\G
************************** 1. <span style="color: #228b22;">row</span> ***************************
                  db: testdb
                <span style="color: #a020f0;">name</span>: event_now
                body: <span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> events_list <span style="color: #a020f0;">values</span>(<span style="color: #8b2252;">'event_now'</span>, now())
             <span style="color: #a020f0;">definer</span>: root@localhost
          execute_at: 2020-06-06 08:52:08
      interval_value: <span style="color: #a020f0;">NULL</span>
      interval_field: <span style="color: #a020f0;">NULL</span>
             created: 2020-06-06 16:52:08
            modified: 2020-06-06 16:52:08
       last_executed: <span style="color: #a020f0;">NULL</span>
              starts: <span style="color: #a020f0;">NULL</span>
                ends: <span style="color: #a020f0;">NULL</span>
              status: ENABLED
       on_completion: <span style="color: #a020f0;">DROP</span>
            sql_mode: STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
             comment: 
          originator: 1
           time_zone: <span style="color: #a020f0;">SYSTEM</span>
character_set_client: utf8
collation_connection: utf8_general_ci
        db_collation: latin1_swedish_ci
           body_utf8: <span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> events_list <span style="color: #a020f0;">values</span>(<span style="color: #8b2252;">'event_now'</span>, now())
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

#&#24320;&#21551;&#20107;&#20214;&#35843;&#24230;&#21151;&#33021;
MariaDB [testdb]&gt; <span style="color: #a020f0;">set</span> <span style="color: #a020f0;">global</span> event_scheduler=1;
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.000 sec)
#&#20107;&#20214;&#31435;&#21363;&#25191;&#34892;&#65292;&#27599;&#31186;&#25554;&#20837;&#19968;&#26465;&#35760;&#24405;
MariaDB [testdb]&gt; <span style="color: #a020f0;">select</span> *<span style="color: #a020f0;">from</span> events_list;
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+---------------------+</span>
| event_name | event_started       |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+---------------------+</span>
| event_now  | 2020-06-06 16:52:39 |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+---------------------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

#&#20107;&#20214;&#25191;&#34892;&#23436;&#25104;&#21518;&#33258;&#21160;&#21024;&#38500;
MariaDB [testdb]&gt; show events;
Empty <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>

<p>
范例：创建每秒启动的事件
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#19968;&#20010;&#34920;&#35760;&#24405;&#27599;&#27425;&#20107;&#20214;&#35843;&#24230;&#30340;&#21517;&#23383;&#21644;&#20107;&#20214;&#25139;</span>
MariaDB [testdb]&gt; create table events_list(event_name varchar(20) not null,event_started timestamp not null);
Query OK, 0 rows affected (0.005 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#20107;&#20214;&#35843;&#24230;&#21151;&#33021;</span>
MariaDB [testdb]&gt; set global <span style="color: #a0522d;">event_scheduler</span>=1;
Query OK, 0 rows affected (0.000 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#20107;&#20214;</span>
MariaDB [testdb]&gt; CREATE EVENT event_every_second ON SCHEDULE EVERY 1 SECOND DO INSERT INTO events_list VALUES(<span style="color: #8b2252;">'event_now'</span>, now());
Query OK, 0 rows affected, 1 warning (0.000 sec)

MariaDB [testdb]&gt; SHOW EVENTS\G
************************** 1. row ***************************
                  Db: testdb
                Name: event_every_second
             Definer: root@localhost
           Time zone: SYSTEM
                Type: RECURRING
          Execute at: NULL
      Interval value: 1
      Interval field: SECOND
              Starts: 2020-06-06 17:27:44
                Ends: NULL
              Status: ENABLED
          Originator: 1
character_set_client: utf8
collation_connection: utf8_general_ci
  Database Collation: latin1_swedish_ci
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20107;&#20214;&#26159;&#23384;&#25918;&#22312;mysql.event&#34920;&#20013;</span>
MariaDB [testdb]&gt; select *from mysql.event\G
************************** 1. row ***************************
                  db: testdb
                name: event_every_second
                body: INSERT INTO events_list VALUES(<span style="color: #8b2252;">'event_now'</span>, now())
             definer: root@localhost
          execute_at: NULL
      interval_value: 1
      interval_field: SECOND
             created: 2020-06-06 17:27:44
            modified: 2020-06-06 17:27:44
       last_executed: NULL
              starts: 2020-06-06 09:27:44
                ends: NULL
              status: ENABLED
       on_completion: DROP
            sql_mode: STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
             comment: 
          originator: 1
           time_zone: SYSTEM
character_set_client: utf8
collation_connection: utf8_general_ci
        db_collation: latin1_swedish_ci
           body_utf8: INSERT INTO events_list VALUES(<span style="color: #8b2252;">'event_now'</span>, now())
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)


MariaDB [testdb]&gt; select *from events_list;
+------------+---------------------+
| event_name | event_started       |
+------------+---------------------+
| event_now  | 2020-06-06 17:28:09 |
| event_now  | 2020-06-06 17:28:10 |
| event_now  | 2020-06-06 17:28:11 |
| event_now  | 2020-06-06 17:28:12 |
| event_now  | 2020-06-06 17:28:13 |
| event_now  | 2020-06-06 17:28:14 |
| event_now  | 2020-06-06 17:28:15 |
| event_now  | 2020-06-06 17:28:16 |
| event_now  | 2020-06-06 17:28:17 |
| event_now  | 2020-06-06 17:28:18 |
| event_now  | 2020-06-06 17:28:19 |
| event_now  | 2020-06-06 17:28:20 |
| event_now  | 2020-06-06 17:28:21 |
| event_now  | 2020-06-06 17:28:22 |
+------------+---------------------+
14 rows<span style="color: #a020f0;"> in</span> set (0.000 sec)

MariaDB [testdb]&gt; drop event event_every_second;
Query OK, 0 rows affected (0.000 sec)

MariaDB [testdb]&gt; SHOW EVENTS\G
Empty set (0.001 sec)

MariaDB [testdb]&gt; select *from mysql.event\G
Empty set (0.000 sec)
</pre>
</div>

<p>
范例： 创建每分钟启动的事件
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [testdb]&gt; show variables <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'event_scheduler'</span>;
+<span style="color: #b22222;">-----------------</span><span style="color: #b22222;">+-------+</span>
| Variable_name   | <span style="color: #a020f0;">Value</span> |
+<span style="color: #b22222;">-----------------</span><span style="color: #b22222;">+-------+</span>
| event_scheduler | <span style="color: #a020f0;">ON</span>    |
+<span style="color: #b22222;">-----------------</span><span style="color: #b22222;">+-------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">create</span> event testdb.event_every_minute <span style="color: #a020f0;">on</span> schedule <span style="color: #a020f0;">every</span> 1 <span style="color: #a020f0;">minute</span> do <span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> events_list <span style="color: #a020f0;">values</span>(<span style="color: #8b2252;">'event_now'</span>, now());
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.000 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">select</span> now();
+<span style="color: #b22222;">---------------------</span><span style="color: #b22222;">+</span>
| now()               |
+<span style="color: #b22222;">---------------------</span><span style="color: #b22222;">+</span>
| 2020-06-06 17:34:30 |
+<span style="color: #b22222;">---------------------</span><span style="color: #b22222;">+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">select</span> *<span style="color: #a020f0;">from</span> events_list;
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+---------------------+</span>
| event_name | event_started       |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+---------------------+</span>
| event_now  | 2020-06-06 17:34:26 |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+---------------------+</span>
20 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [testdb]&gt; SHOW EVENTS\G
************************** 1. <span style="color: #228b22;">row</span> ***************************
                  Db: testdb
                <span style="color: #a020f0;">Name</span>: event_every_minute
             <span style="color: #a020f0;">Definer</span>: root@localhost
           <span style="color: #228b22;">Time</span> <span style="color: #228b22;">zone</span>: <span style="color: #a020f0;">SYSTEM</span>
                <span style="color: #a020f0;">Type</span>: RECURRING
          <span style="color: #a020f0;">Execute</span> <span style="color: #a020f0;">at</span>: <span style="color: #a020f0;">NULL</span>
      <span style="color: #228b22;">Interval</span> <span style="color: #a020f0;">value</span>: 1
      <span style="color: #228b22;">Interval</span> field: <span style="color: #a020f0;">MINUTE</span>
              Starts: 2020-06-06 17:34:26
                Ends: <span style="color: #a020f0;">NULL</span>
              Status: ENABLED
          Originator: 1
character_set_client: utf8
collation_connection: utf8_general_ci
  Database <span style="color: #a020f0;">Collation</span>: latin1_swedish_ci
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">select</span> *<span style="color: #a020f0;">from</span> events_list;
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+---------------------+</span>
| event_name | event_started       |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+---------------------+</span>
| event_now  | 2020-06-06 17:34:26 |
| event_now  | 2020-06-06 17:35:26 |
| event_now  | 2020-06-06 17:36:26 |
| event_now  | 2020-06-06 17:37:26 | 
| event_now  | 2020-06-06 17:38:26 |
| event_now  | 2020-06-06 17:39:26 |
| event_now  | 2020-06-06 17:40:26 |
| event_now  | 2020-06-06 17:41:26 |
| event_now  | 2020-06-06 17:42:26 |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+---------------------+</span>
9 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
</pre>
</div>

<p>
范例：创建定时调用存储过程的事件
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [testdb]&gt; <span style="color: #a020f0;">drop</span> event event_every_minute;
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.000 sec)

MariaDB [testdb]&gt; truncate <span style="color: #a020f0;">table</span> events_list;
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.007 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">select</span> *<span style="color: #a020f0;">from</span> events_list;
Empty <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [testdb]&gt; delimiter //
MariaDB [testdb]&gt;  <span style="color: #a020f0;">create</span> <span style="color: #a020f0;">procedure</span> sp_insert()
    -&gt; <span style="color: #a020f0;">begin</span>
    -&gt; <span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> events_list <span style="color: #a020f0;">values</span>(<span style="color: #8b2252;">'event_now'</span>, now());
    -&gt; <span style="color: #a020f0;">end</span>//
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.000 sec)

MariaDB [testdb]&gt; delimiter ;
MariaDB [testdb]&gt; <span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">DEFINER</span>=`root`@`localhost` EVENT event_test <span style="color: #a020f0;">ON</span> SCHEDULE <span style="color: #a020f0;">EVERY</span> 10 <span style="color: #a020f0;">SECOND</span> STARTS <span style="color: #8b2252;">'2019-12-02 22:55:00'</span> <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">COMPLETION</span> <span style="color: #a020f0;">PRESERVE</span> ENABLE DO <span style="color: #a020f0;">call</span> sp_insert();
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.001 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">select</span> now();
+<span style="color: #b22222;">---------------------</span><span style="color: #b22222;">+</span>
| now()               |
+<span style="color: #b22222;">---------------------</span><span style="color: #b22222;">+</span>
| 2020-06-06 18:11:06 |
+<span style="color: #b22222;">---------------------</span><span style="color: #b22222;">+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [testdb]&gt; <span style="color: #a020f0;">select</span> *<span style="color: #a020f0;">from</span> events_list;
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+---------------------+</span>
| event_name | event_started       |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+---------------------+</span>
| event_now  | 2020-06-06 18:11:10 |
| event_now  | 2020-06-06 18:11:20 |
| event_now  | 2020-06-06 18:11:30 |
| event_now  | 2020-06-06 18:11:40 |
+<span style="color: #b22222;">------------</span><span style="color: #b22222;">+---------------------+</span>
4 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
</pre>
</div>

<p>
范例：修改事件
</p>

<div class="org-src-container">
<pre class="src src-sh">MariaDB [testdb]&gt; ALTER <span style="color: #a0522d;">DEFINER</span>=<span style="color: #8b2252;">'root'</span>@<span style="color: #8b2252;">'localhost'</span> EVENT event_test ON SCHEDULE EVERY 30 SECOND ON COMPLETION PRESERVE ENABLE DO call sp_insert();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#29992;&#20107;&#20214;</span>
MariaDB [testdb]&gt; alter event testdb.event_test disable;
MariaDB [testdb]&gt; show events\G

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#20107;&#20214;</span>
MariaDB [testdb]&gt; alter event testdb.event_test enable;
Query OK, 0 rows affected (0.000 sec)
MariaDB [testdb]&gt; show events\G

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#20107;&#20214;&#21517;&#31216;</span>
MariaDB [testdb]&gt; alter event testdb.event_test rename to event_test2;
Query OK, 0 rows affected (0.001 sec)
MariaDB [testdb]&gt; show events\G
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:df32b01a-be72-4054-9731-04119ba20970" class="outline-3">
<h3 id="h:df32b01a-be72-4054-9731-04119ba20970">MySQL用户管理</h3>
<div class="outline-text-3" id="text-h:df32b01a-be72-4054-9731-04119ba20970">
<p>
<b>相关数据库和表</b>
</p>
<div class="org-src-container">
<pre class="src src-sh">&#20803;&#25968;&#25454;&#25968;&#25454;&#24211;&#65306;mysql
&#31995;&#32479;&#25480;&#26435;&#34920;&#65306;db, host, user, columns_priv, tables_priv, procs_priv, proxies_priv
</pre>
</div>

<p>
<b>用户账号</b>
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #8b2252;">'USERNAME'</span>@<span style="color: #8b2252;">'HOST'</span>

@<span style="color: #8b2252;">'HOST'</span>: &#20027;&#26426;&#21517;&#65306; user1@<span style="color: #8b2252;">'web1.xxx.org'</span>
IP&#22320;&#22336;&#25110;Network
    &#36890;&#37197;&#31526;&#65306; % _
    &#31034;&#20363;&#65306;wang@172.16.%.%
         user2@<span style="color: #8b2252;">'192.168.1.%'</span>
         xxx@<span style="color: #8b2252;">'10.0.0.0/255.255.0.0'</span>
</pre>
</div>

<p>
<b>创建用户：CREATE USER</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> <span style="color: #483d8b;">USER</span> <span style="color: #8b2252;">'USERNAME'</span>@<span style="color: #8b2252;">'HOST'</span> [IDENTIFIED <span style="color: #a020f0;">BY</span> <span style="color: #8b2252;">'password'</span>]&#65307;

&#31034;&#20363;&#65306;
<span style="color: #a020f0;">create</span> <span style="color: #483d8b;">user</span> test@<span style="color: #8b2252;">'10.0.0.0/255.255.255.0'</span> identified <span style="color: #a020f0;">by</span> <span style="color: #8b2252;">'123456'</span>;
<span style="color: #a020f0;">create</span> <span style="color: #483d8b;">user</span> test2@<span style="color: #8b2252;">'10.0.0.%'</span> identified <span style="color: #a020f0;">by</span> 123456;
</pre>
</div>
<p>
新建用户的默认权限：USAGE
</p>

<p>
<b>用户重命名：RENAME USER</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">RENAME <span style="color: #483d8b;">USER</span> old_user_name <span style="color: #a020f0;">TO</span> new_user_name;
</pre>
</div>

<p>
<b>删除用户：</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DROP</span> <span style="color: #483d8b;">USER</span> <span style="color: #8b2252;">'USERNAME'</span>@<span style="color: #8b2252;">'HOST'</span>
</pre>
</div>

<p>
范例：删除默认的空用户
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DROP</span> <span style="color: #483d8b;">USER</span> <span style="color: #8b2252;">''</span>@<span style="color: #8b2252;">'localhost'</span>;
</pre>
</div>

<p>
<b>修改密码</b> ：
</p>

<p>
注意：
</p>
<ul class="org-ul">
<li>新版mysql中用户密码可以保存在mysql.user表的authentication_string字段中</li>
<li>如果mysql.user表的authentication_string和password字段都保存密码，authentication_string优先生效</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1&#65306;&#29992;&#25143;&#21487;&#20197;&#36890;&#36807;&#27492;&#26041;&#24335;&#20462;&#25913;&#33258;&#24049;&#30340;&#23494;&#30721;</span>
SET PASSWORD FOR <span style="color: #8b2252;">'user'</span>@<span style="color: #8b2252;">'host'</span> = PASSWORD(<span style="color: #8b2252;">'password'</span>); <span style="color: #b22222;">#</span><span style="color: #b22222;">MySQL8.0 &#29256;&#26412;&#19981;&#25903;&#25345;&#27492;&#26041;&#27861;&#65292;&#22240;&#20026;passwod&#20989;&#25968;&#34987;&#21462;&#28040;</span>
<span style="color: #483d8b;">set</span> password for root@<span style="color: #8b2252;">'localhost'</span>=<span style="color: #8b2252;">'123456'</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">MySQL8.0&#29256;&#26412;&#25903;&#25345;&#27492;&#26041;&#27861;&#65292;&#27492;&#26041;&#24335;&#30452;&#25509;&#23558;&#23494;&#30721;123456&#21152;&#23494;&#21518;&#23384;&#25918;&#22312;mysql.user&#34920;&#30340;authentication_string&#23383;&#27573;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2</span>
ALTER USER test@<span style="color: #8b2252;">'%'</span> IDENTIFIED BY <span style="color: #8b2252;">'centos'</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;&#25913;&#23494;&#30721;&#26041;&#27861;&#65292;&#29992;&#25143;&#21487;&#20197;&#36890;&#36807;&#27492;&#26041;&#27861;&#20462;&#25913;&#33258;&#24049;&#30340;&#23494;&#30721;&#65292;MySQL8.0&#29256;&#26412;&#20462;&#25913;&#23494;&#30721;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;3&#65306;&#27492;&#26041;&#27861;MySQL8.0&#19981;&#25903;&#25345;&#65292;&#22240;&#20026;password&#20989;&#25968;&#34987;&#21462;&#28040;</span>
UPDATE mysql.user SET <span style="color: #a0522d;">password</span>=PASSWORD(<span style="color: #8b2252;">'password'</span>) WHERE clause;
<span style="color: #b22222;">#</span><span style="color: #b22222;">mariadb 10.3</span>
update mysql.user set <span style="color: #a0522d;">authentication_string</span>=password(<span style="color: #8b2252;">'ubuntu'</span>) where <span style="color: #a0522d;">user</span>=<span style="color: #8b2252;">'xxx'</span>;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27492;&#26041;&#27861;&#38656;&#35201;&#25191;&#34892;&#19979;&#38754;&#25351;&#20196;&#25165;&#33021;&#29983;&#25928;&#65306;</span>
FLUSH PRIVILEGES;
</pre>
</div>

<p>
<b>忘记管理员密码的解决办法：</b>
</p>

<ol class="org-ol">
<li>启动mysqld进程时，为其使用如下选项：</li>
</ol>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">--</span><span style="color: #b22222;">skip-grant-tables</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">skip-networking</span>
</pre>
</div>

<ol class="org-ol">
<li>使用UPDATE命令修改管理员密码</li>
<li>关闭mysqld进程，移除上述两个选项，重启mysqld</li>
</ol>

<p>
范例：Mariadb和MySQL5.6之前版本破解root密码
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /etc/my.cnf
[mysqld]
skip-grant-tables
skip-networking

[root@centos8 ~]#systemctl restart mariadb
[root@centos8 ~]#mysql
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">mariadb &#26087;&#29256;&#26412;&#21644;MySQL5.6&#29256;&#20043;&#21069;</span>
MariaDB [(none)]&gt; update mysql.user set <span style="color: #a0522d;">password</span>=password(<span style="color: #8b2252;">'ubuntu'</span>) where <span style="color: #a0522d;">user</span>=<span style="color: #8b2252;">'root'</span>;
<span style="color: #b22222;">#</span><span style="color: #b22222;">mariadb &#26032;&#29256;</span>
MariaDB [(none)]&gt; update mysql.user set <span style="color: #a0522d;">authentication_string</span>=password(<span style="color: #8b2252;">'ubuntu'</span>) where <span style="color: #a0522d;">user</span>=<span style="color: #8b2252;">'root'</span>;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2</span>
&gt; flush privileges;
&gt; alter user root@<span style="color: #8b2252;">'localhost'</span> identified by <span style="color: #8b2252;">'ubuntu'</span>;


[root@centos8 ~]#vim /etc/my.cnf
[mysqld]
<span style="color: #b22222;">#</span><span style="color: #b22222;">skip-grant-tables</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">skip-networking</span>

[root@centos8 ~]#systemctl restart mariadb
[root@centos8 ~]#mysql -uroot -pubuntu
</pre>
</div>

<p>
范例：MySQL5.7和8.0破解root密码
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /etc/my.cnf
[mysqld]
skip-grant-tables
skip-networking <span style="color: #b22222;">#</span><span style="color: #b22222;">MySQL8.0&#19981;&#38656;&#35201;</span>

[root@centos8 ~]#systemctl restart mysqld
[root@centos8 ~]#mysql
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1</span>
&gt; update mysql.user set <span style="color: #a0522d;">authentication_string</span>=<span style="color: #8b2252;">'ubuntu'</span> where <span style="color: #a0522d;">user</span>=<span style="color: #8b2252;">'root'</span> and <span style="color: #a0522d;">host</span>=<span style="color: #8b2252;">'localhost'</span>;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2</span>
&gt; flush privileges;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20877;&#25191;&#34892;&#19979;&#38754;&#20219;&#24847;&#19968;&#20010;&#21629;&#20196;</span>
&gt; alter user root@<span style="color: #8b2252;">'localhost'</span> identified by <span style="color: #8b2252;">'ubuntu'</span>;
&gt; set password for root@<span style="color: #8b2252;">'localhost'</span>=<span style="color: #8b2252;">'ubuntu'</span>;


[root@centos8 ~]#vim /etc/my.cnf
[mysqld]
<span style="color: #b22222;">#</span><span style="color: #b22222;">skip-grant-tables</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">skip-networking</span>

[root@centos8 ~]#systemctl restart mysqld
[root@centos8 ~]#mysql -uroot -pubuntu
</pre>
</div>

<p>
范例：删库跑路之清空root密码方法
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27492;&#26041;&#27861;&#36866;&#29992;&#20110;&#21253;&#23433;&#35013;&#26041;&#24335;&#30340;MySQL&#25110;MariaDB</span>
systemctl stop mysqld
rm -fr /var/lib/mysql/*
systemctl start mysqld
</pre>
</div>
</div>
</div>
<div id="outline-container-h:346de87c-8110-4b77-bfdb-b6a1816599fc" class="outline-3">
<h3 id="h:346de87c-8110-4b77-bfdb-b6a1816599fc">权限管理和DCL语句</h3>
<div class="outline-text-3" id="text-h:346de87c-8110-4b77-bfdb-b6a1816599fc">
</div>
<div id="outline-container-h:e465dad3-a7ff-4371-a20c-87b98b1f3aa2" class="outline-4">
<h4 id="h:e465dad3-a7ff-4371-a20c-87b98b1f3aa2">权限类别</h4>
<div class="outline-text-4" id="text-h:e465dad3-a7ff-4371-a20c-87b98b1f3aa2">
<ul class="org-ul">
<li>管理类</li>
<li>程序类</li>
<li>数据库级别</li>
<li>表级别</li>
<li>字段级别</li>
</ul>

<p>
*管理类*：
</p>

<ul class="org-ul">
<li>CREATE USER</li>
<li>FILE</li>
<li>SUPER</li>
<li>SHOW DATABASES</li>
<li>RELOAD</li>
<li>SHUTDOWN</li>
<li>REPLICATION SLAVE 数据库复制</li>
<li>REPLICATION CLIENT</li>
<li>LOCK TABLES</li>
<li>PROCESS</li>
<li>CREATE TEMPORARY TABLES</li>
</ul>

<p>
<b>程序类：针对 FUNCTION、PROCEDURE、TRIGGER</b>
</p>

<ul class="org-ul">
<li>CREATE</li>
<li>ALTER</li>
<li>DROP</li>
<li>EXCUTE</li>
</ul>

<p>
<b>库和表级别：针对 DATABASE、TABLE</b>
</p>

<ul class="org-ul">
<li>ALTER</li>
<li>CREATE</li>
<li>CREATE VIEW</li>
<li>DROP INDEX</li>
<li>SHOW VIEW</li>
<li>WITH GRANT OPTION：能将自己获得的权限转赠给其他用户</li>
</ul>

<p>
<b>数据操作</b>
</p>

<ul class="org-ul">
<li>SELECT</li>
<li>INSERT</li>
<li>DELETE</li>
<li>UPDATE</li>
</ul>

<p>
<b>字段级别</b>
</p>

<ul class="org-ul">
<li>SELECT(col1,col2,&#x2026;)</li>
<li>UPDATE(col1,col2,&#x2026;)</li>
<li>INSERT(col1,col2,&#x2026;)</li>
</ul>

<p>
<b>所有权限</b>
</p>

<ul class="org-ul">
<li>ALL PRIVILEGES 或 ALL</li>
</ul>
</div>
</div>
<div id="outline-container-h:19f4dfe6-71ce-465d-b03f-a83a0b0b7300" class="outline-4">
<h4 id="h:19f4dfe6-71ce-465d-b03f-a83a0b0b7300">授权</h4>
<div class="outline-text-4" id="text-h:19f4dfe6-71ce-465d-b03f-a83a0b0b7300">
<p>
授权：GRANT
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">GRANT</span> priv_type [(column_list)],... <span style="color: #a020f0;">ON</span> [object_type] priv_level <span style="color: #a020f0;">TO</span> <span style="color: #8b2252;">'user'</span>@<span style="color: #8b2252;">'host'</span> [IDENTIFIED <span style="color: #a020f0;">BY</span> <span style="color: #8b2252;">'password'</span>] [<span style="color: #a020f0;">WITH</span> <span style="color: #a020f0;">GRANT</span> <span style="color: #a020f0;">OPTION</span>];
priv_type: <span style="color: #a020f0;">ALL</span> [<span style="color: #a020f0;">PRIVILEGES</span>]
object_type:<span style="color: #a020f0;">TABLE</span> | <span style="color: #a020f0;">FUNCTION</span> | <span style="color: #a020f0;">PROCEDURE</span>
priv_level: *(&#25152;&#26377;&#24211;) |*.* | db_name.* | db_name.tbl_name | tbl_name(&#24403;&#21069;&#24211;&#30340;&#34920;) | db_name.<span style="color: #a020f0;">routine_name</span>(&#25351;&#23450;&#24211;&#30340;&#20989;&#25968;,&#23384;&#20648;&#36807;&#31243;,&#35302;&#21457;&#22120;)
with_option: <span style="color: #a020f0;">GRANT</span> <span style="color: #a020f0;">OPTION</span>
| MAX_QUERIES_PER_HOUR <span style="color: #483d8b;">count</span>
| MAX_UPDATES_PER_HOUR <span style="color: #483d8b;">count</span>
| MAX_CONNECTIONS_PER_HOUR <span style="color: #483d8b;">count</span>
| MAX_USER_CONNECTIONS <span style="color: #483d8b;">count</span>
</pre>
</div>

<p>
参考：<a href="https://dev.mysql.com/doc/refman/5.7/en/grant.html">https://dev.mysql.com/doc/refman/5.7/en/grant.html</a>
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">GRANT SELECT (col1), INSERT (col1,col2) ON mydb.mytbl TO <span style="color: #8b2252;">'someuser'</span>@<span style="color: #8b2252;">'somehost'</span>;
GRANT ALL ON wordpress.* TO wordpress@<span style="color: #8b2252;">'10.0.0.%'</span>;
GRANT ALL PRIVILEGES ON *.* TO <span style="color: #8b2252;">'root'</span>@<span style="color: #8b2252;">'10.0.0.%'</span> WITH GRANT OPTION;  <span style="color: #b22222;"># </span><span style="color: #b22222;">WITH GRANT OPTION&#21516;&#26102;&#20801;&#35768;&#25226;&#33258;&#24049;&#30340;&#26435;&#38480;&#25480;&#26435;&#32473;&#21035;&#20154;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#29992;&#25143;&#21644;&#25480;&#26435;&#21516;&#26102;&#25191;&#34892;&#30340;&#26041;&#24335;&#22312;MySQL8.0&#21462;&#28040;&#20102;</span>
GRANT ALL ON wordpress.* TO wordpress@<span style="color: #8b2252;">'192.168.8.%'</span> IDENTIFIED BY <span style="color: #8b2252;">'xxx'</span>;
GRANT ALL PRIVILEGES ON *.* TO <span style="color: #8b2252;">'root'</span>@<span style="color: #8b2252;">'192.168.8.%'</span> IDENTIFIED BY <span style="color: #8b2252;">'xxx'</span> WITH GRANT OPTION;  
<span style="color: #b22222;">#</span><span style="color: #b22222;">mysql8&#19978;&#24050;&#28120;&#27760;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7c2ad19d-eb4e-4cd4-8cb1-f39cf4bc0e59" class="outline-4">
<h4 id="h:7c2ad19d-eb4e-4cd4-8cb1-f39cf4bc0e59">取消授权</h4>
<div class="outline-text-4" id="text-h:7c2ad19d-eb4e-4cd4-8cb1-f39cf4bc0e59">
<p>
取消授权：REVOKE
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">REVOKE</span> priv_type [(column_list)] [, priv_type [(column_list)]] ... <span style="color: #a020f0;">ON</span> [object_type] priv_level <span style="color: #a020f0;">FROM</span> <span style="color: #483d8b;">user</span> [, <span style="color: #483d8b;">user</span>] ...
</pre>
</div>

<p>
参考：<a href="https://dev.mysql.com/doc/refman/5.7/en/revoke.html">https://dev.mysql.com/doc/refman/5.7/en/revoke.html</a>
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">REVOKE</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">ON</span> testdb.* <span style="color: #a020f0;">FROM</span> <span style="color: #8b2252;">'testuser'</span>@<span style="color: #8b2252;">'172.16.0.%'</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:38e881a9-120d-407c-bc1c-04f15144ea3c" class="outline-4">
<h4 id="h:38e881a9-120d-407c-bc1c-04f15144ea3c">查看指定用户获得的授权</h4>
<div class="outline-text-4" id="text-h:38e881a9-120d-407c-bc1c-04f15144ea3c">
<div class="org-src-container">
<pre class="src src-sql">Help SHOW GRANTS
SHOW GRANTS <span style="color: #a020f0;">FOR</span> <span style="color: #8b2252;">'user'</span>@<span style="color: #8b2252;">'host'</span>;
SHOW GRANTS <span style="color: #a020f0;">FOR</span> <span style="color: #483d8b;">CURRENT_USER</span>[()];
</pre>
</div>

<p>
注意：MariaDB服务进程启动时会读取mysql库中所有授权表至内存
</p>

<p>
(1) GRANT或REVOKE等执行权限操作会保存于系统表中，MariaDB的服务进程通常
会自动重读授权表，使之生效
</p>

<p>
(2)对于不能够或不能及时重读授权表的命令，可手动让MariaDB的服务进程重读
授权表：mysql&gt;FLUSH PRIVILEGES;
</p>
</div>
</div>
</div>
<div id="outline-container-h:b5f1a88b-10d4-472f-b677-05711bd72a82" class="outline-3">
<h3 id="h:b5f1a88b-10d4-472f-b677-05711bd72a82">MySQL的图形化的远程管理工具</h3>
<div class="outline-text-3" id="text-h:b5f1a88b-10d4-472f-b677-05711bd72a82">
<p>
在MySQL数据库中创建用户并授权后，可以使用相关图形化工具进行远程的管理。
</p>

<p>
常见的图形化管理工具：
</p>

<ul class="org-ul">
<li>Navicat</li>
<li>SQLyog</li>
</ul>
</div>
<div id="outline-container-h:bcf1b4e3-6142-4338-8eb0-da81eb9339e8" class="outline-4">
<h4 id="h:bcf1b4e3-6142-4338-8eb0-da81eb9339e8">Navicat 工具</h4>
<div class="outline-text-4" id="text-h:bcf1b4e3-6142-4338-8eb0-da81eb9339e8">

<figure id="orgc4302c7">
<img src="./images/20200607100012654.png" alt="20200607100012654.png" width="60%">

</figure>


<figure id="orgc8ec37c">
<img src="./images/20200607100628577.png" alt="20200607100628577.png" width="60%">

</figure>
</div>
</div>
<div id="outline-container-h:4c35febf-a83d-48ce-afe0-f7b8ed94c9b8" class="outline-4">
<h4 id="h:4c35febf-a83d-48ce-afe0-f7b8ed94c9b8">SQLyog 工具</h4>
<div class="outline-text-4" id="text-h:4c35febf-a83d-48ce-afe0-f7b8ed94c9b8">

<figure id="org1b854bb">
<img src="./images/20200607100955706.png" alt="20200607100955706.png" width="60%">

</figure>
</div>
</div>
</div>
</section>
<section id="outline-container-h:c5656d63-861f-40b8-9a17-f730410d9b13" class="outline-2">
<h2 id="h:c5656d63-861f-40b8-9a17-f730410d9b13">MySQL架构和性能优化</h2>
<div class="outline-text-2" id="text-h:c5656d63-861f-40b8-9a17-f730410d9b13">

<figure id="org7d1c429">
<img src="./images/Snipaste_2023-05-11_17-47-49.png" alt="Snipaste_2023-05-11_17-47-49.png" width="60%">

</figure>


<p width="60%">
<img src="./images/20200608091123729.png" alt="20200608091123729.png" width="60%">
MySQL是C/S 架构的，connectors是连接器；可供Native C API、JDBC、ODBC、
NET、PHP、Perl、Python、Ruby、Cobol等连接mysql；ODBC叫开放数据库（系统）
互联，open database connection；每种语言都有各自的连接数据库的API接
口;JDBC是主要用于java语言利用较为底层的驱动连接数据库；以上这些，站在
编程角度可以理解为连入数据库管理系统的驱动，站在mysql角度称作专用语言
对应的链接器.
</p>

<p>
任何链接器连入mysql以后， <b>mysql是单进程多线程模型</b> 的，因此， <b>每个用
户连接，都会创建一个单独的连接线程</b> ；其实mysql连接也有长短连接两种方
式，使用mysql客户端连入数据库后，直到使用quit命令才退出，可认为是长连
接；使用mysql中的-e选项，在mysql客户端向服务器端申请运行一个命令后则立
即退出，也就意味着连接会立即断开；所以，mysql也支持长短连接类似于两种
类型；所以，用户连入mysql后，创建一个连接线程，完成之后，能够通过这个
链接线程完成接收客户端发来的请求，为其处理请求，构建响应报文并发给客户
端；由于是单进程模型，就意味着必须要维持一个线程池，跟之前介绍过的
varnish很接近，需要一个线程池来管理这众多线程是如何对众多客户端的并发
请求，完成并发响应的，组件connection pool就是实现这样功能；connection
pool对于mysql而言，它所实现的功能，包括authentication认证，用户发来的
账号密码是否正确要完成认证功能；thread reuse线程重用功能，一般当一个用
户连接进来以后要用一个线程来响应它，而后当用户退出这个线程有可能并非被
销毁，而是把它清理完以后，重新收归到线程池当中的空闲线程中去，以完成所
谓的线程重用；connection limit 线程池的大小决定了连接并发数量的上限，
例如，最多容纳100线程，一旦到达此上限后续到达的连接请求则只能排队或拒
绝连接；check memory用来检测内存，caches实现线程缓存；整个都属于线程池
的功能.当用户请求之后，通过线程池建立一个用户连接，这个线程一直存在，
然后用户就通过这个会话，发送对应的SQL语句到服务器端.
</p>

<p>
服务器收到SQL语句后，要对语句完成执行，首先要能理解sql语句需要有sql解释器或叫sql接口， <b>sqlinterface就可理解为是整个mysql的外壳</b> ，就像shell是linux操作系统的外壳一样道理；用户无论通过哪种链接器发来的基本的SQL请求，当然，事实上通过native C API也有发过来的不是SQL
请求，而仅仅是对API中的传递参数后的调用；不是SQL语句不过都统统理解为sql语句罢了；对SQL而言分为DDL和DML两种类型，但是无论哪种类型，提交以后必须交给内核，让内核来运行，在这之前必须要告诉内核哪个是命令，哪个是选项，哪些是参数，是否存在语法错误等等；因此，这个整个 <b>SQL接口就是一个完完整整的sql命令的解释器</b> ，并且这个sql接口还有提供完整的sql接口应该具备的功能，比如支持所谓过程式编程，支持代码块的实现像存储过程、存储函数，触发器、必要时还要实现部署一个关系型数据库应该具备的基本组件例如视图等等，其实都在sql interface这个接口实现的； <b>SQL接口做完词法分析、句法分析后，要分析语句如何执行让parser解析器或分析器实现，parser是专门的分析器</b> ，这个分析器并不是分析语法问题的，语法问题在sql接口时就能发现是否有错误了，一个语句没有问题，就要做执行分析，所谓叫查询翻译，把一个查询语句给它转换成对应的能够在本地执行的特定操作；比如说看上去是语句而背后可能是执行的一段二进制指令，这个时候就完成对应的指令，还要根据用户请求的对象，比如某一字段查询内容是否有对应数据的访问权限，或叫对象访问权限；在数据库中库、表、字段、字段中的数据有时都称为object，叫一个数据库的对象，用户认证的通过，并不意味着就能一定能访问数据库上的所有数据，所以说， <b>mysql的认证大概分为两过程都要完成，第一是连入时需要认证账号密码是否正确这是authentication，然后，验证成功后用户发来sql语句还要验证用户是否有权限获取它期望请求获取的数据；这个称为object
privilege，这一切都是有parser分析器进行的</b>
</p>

<p>
分析器分析完成之后，可能会生成多个执行树，也就意味着为了能够达到访问期望访问到的目的，可能有多条路径都可实现，就像文件系统一样可以使用相对路径也可使用绝对路径；它有多种方式，在多种路径当中一定有一个是最优的，类似路由选择，因此，  <b>optimizer就要去衡量多个访问路径中哪一个代价或开销是最小的</b> ，这个开销的计算要依赖于索引等各种内部组件来进行评估；而且这个评估的只是近似值，同时还要考虑到当前mysql内部在实现资源访问时统计数据，比如，根据判断认为是1号路径的开销最小的，但是众多统计数据表明发往1号路径的访问的资源开销并不小，并且比3号路径大的多，因此，可能会依据3号路径访问；这就是所谓的optimizer它负责检查多条路径，每条路径的开销，然后评估开销，这个评估根据内部的静态数据，索引，根域根据动态生成的统计数据来判定每条路径的开销大小，因此这里还有statics；一旦优化完成之后，还要生成统计数据，这就是优化器的作用；如果没有优化器mysql执行语句是最慢的，其实优化还包括一种功能，一旦选择完一条路径后，例如用户给的这个命令执行起来，大概需要100个开销，如果通过改写语句能够达到同样目的可能只需要30个开销；于是，optimizer还要试图改写sql语句；所以优化本身还包括查询语句的改写；一旦优化完成，接下来就交给存储引擎完成.
</p>

<p>
mysql是插件式存储引擎，它就能够替换使用选择多种不同的引擎，MyISAM是MySQL 经典的存储引擎之一，InnoDB是innobase提供给MySQL的，NDB主要用于MySQL Cluster 分布式集群环境，archive做归档的等等，还有许多第三方开发的存储引擎；存储引擎负责把具体分析的结果完成对磁盘上文件路径访问的转换，数据库中的行数据都是存储在磁盘块上的，因此存储引擎要把数据库数据映射为磁盘块，并把磁盘块加载至内存中；进程实现数据处理时，是不可能直接访问磁盘上的数据的，因为它没有权限，只有让内核来把它所访问的数据加载至内存中以后，进程在内存中完成修改，由内核再负责把数据存回磁盘；对于文件系统而言，数据的存储都是以磁盘块方式存储的，但是，mysql在实现数据组织时，不完全依赖于磁盘，而是把磁盘块再次组织成更大一级的逻辑单位，类似于lvm中的PE或LE的形式；其实，MySQL的存储引擎在实现数据管理时，也是在文件系统之上布设文件格式，对于文件而言在逻辑层上还会再次组织成一个逻辑单位，这个逻辑单位称为mysql的数据块datablock一般为16k，对于关系型数据库，数据是按行存储的；一般一行数据都是存储在一起的，因此，MySQL 在内部有一个数据块datablock，在datablock就存储一行数据，一个数据块里可能存放了n行数据；将来在查询加载一行数据时，内核会把整个一个数据数据块加载至内存中，而mysql存储引擎，就从中挑出来某一行返回给查询者，是这样实现的；所以整个存储是以datablock在底层为其最终级别的.
</p>

<p>
事实上，整个存取过程，尤其是访问比较热点的数据，也不可能每一次当用户访问时或当某SQL语句用到时再临时从磁盘加载到内存中，因此，为了能够加上整个性能，mysql的有些存储引擎可以实现，把频繁访问到的热点数据，统统装入内存，用户访问、修改时直接在内存中操作，只不过周期性的写入磁盘上而已，比如像InnoDB，所以caches和buffers组件就是实现此功能的；MySQL为了执行加速，因为它会不断访问数据，而随计算机来说io是最慢的一环，尤其是磁盘io，所以为了加速都载入内存中管理；这就需要MySQL维护cache和buffer缓存或缓冲；这是由MySQL服务器自己维护的；有很多存储引擎自己也有cache和buffer；一个数据库提供了3种视图，物理视图就是看到的对应的文件系统存储为一个个的文件，*MySQL的数据文件类型，常见的有redo log重做日志，undo log撤销日志，data是真正的数据文件，index是索引文件，binary log是二进制日志文件，error log错误日志，query log查询日志，slow query log慢查询日志，在复制架构中还存在中继日志文件*，跟二进制属于同种格式；这是mysql数据文件类型，也就是物理视图；逻辑视图这是在mysql接口上通过存储引擎把mysql文件尤其是data文件，给它映射为一个个关系型数据库应该具备组成部分，比如表，一张表在底层是一个数据文件而已，里面组织的就是datablock，最终映射为磁盘上文件系统的block，然后再次映射为本地扇区的存储，但是整个mysql需要把他们映射成一个二维关系表的形式，需要依赖sql接口以及存储引擎共同实现；所以，把底层数据文件映射成关系型数据库的组件就是逻辑视图；DBA 就是关注内部组件是如何运作的，并且定义、配置其运作模式，而链接器都是终端用户通过链接器的模式进入数据库来访问数据；数据集可能非常大，每一类用户可能只有一部分数据的访问权限，这个时候，最终的终端用户所能访问到的数据集合称作用户视图；为了保证MySQL运作还提供了管理和服务工具，例如:备份恢复工具，安全工具，复制工具，集群服务，管理、配置、迁移、元数据等工具
</p>
</div>
<div id="outline-container-h:4e664f29-0593-4b9a-937e-e7db5602cc1f" class="outline-3">
<h3 id="h:4e664f29-0593-4b9a-937e-e7db5602cc1f">存储引擎</h3>
<div class="outline-text-3" id="text-h:4e664f29-0593-4b9a-937e-e7db5602cc1f">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Feature</th>
<th scope="col" class="org-left">MyISAM</th>
<th scope="col" class="org-left">InnoDB</th>
<th scope="col" class="org-left">Memory</th>
<th scope="col" class="org-left">Archive</th>
<th scope="col" class="org-left">NDB</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Storage limits</td>
<td class="org-left">256TB</td>
<td class="org-left">64TB</td>
<td class="org-left">RAM</td>
<td class="org-left">None</td>
<td class="org-left">384EB</td>
</tr>

<tr>
<td class="org-left">Transactions事务</td>
<td class="org-left">No</td>
<td class="org-left">Yes</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left">Locking granularity 锁粒度</td>
<td class="org-left">Table表级锁</td>
<td class="org-left">Row行级锁</td>
<td class="org-left">Table</td>
<td class="org-left">Row</td>
<td class="org-left">Row</td>
</tr>

<tr>
<td class="org-left">MVCC多版本并发控制机制</td>
<td class="org-left">No</td>
<td class="org-left">Yes</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
</tr>

<tr>
<td class="org-left">Clustered indexes聚簇索引</td>
<td class="org-left">No</td>
<td class="org-left">Yes</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
</tr>

<tr>
<td class="org-left">Foreign key support外键支持</td>
<td class="org-left">No</td>
<td class="org-left">Yes</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left">Data caches数据缓存</td>
<td class="org-left">No</td>
<td class="org-left">Yes</td>
<td class="org-left">N/A</td>
<td class="org-left">No</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left">Geospatial data type support</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">No</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left">Geospatial indexing support</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
</tr>

<tr>
<td class="org-left">B-tree indexes</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
</tr>

<tr>
<td class="org-left">T-tree indexes</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left">Hash indexes</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
<td class="org-left">Yes</td>
<td class="org-left">No</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left">Index caches</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">N/A</td>
<td class="org-left">No</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left">Cluster database support</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left">Compressed data</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">No</td>
<td class="org-left">Yes</td>
<td class="org-left">No</td>
</tr>

<tr>
<td class="org-left">Encrypted data</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left">Full-text search indexes</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
<td class="org-left">No</td>
</tr>

<tr>
<td class="org-left">Backup/point-in-time recovery</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left">Replication support</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">Limited</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
</tr>

<tr>
<td class="org-left">Update statistics for data dictionary</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
<td class="org-left">Yes</td>
</tr>
</tbody>
</table>

<p>
MySQL中的数据用各种不同的技术存储在文件（或者内存）中。这些技术中的每
一种技术都使用不同的存储机制、索引技巧、锁定水平并且最终提供广泛的不同
的功能和能力,此种技术称为存储擎,MySQL支持多种存储引擎，其中目前*应用最
广泛的是InnoDB和MyISAM两种*
</p>

<p>
官方参考资料：
</p>
<ul class="org-ul">
<li><a href="https://docs.oracle.com/cd/E17952_01/mysql-8.0-en/storage-engines.html">https://docs.oracle.com/cd/E17952_01/mysql-8.0-en/storage-engines.html</a></li>
<li><a href="https://docs.oracle.com/cd/E17952_01/mysql-5.7-en/storage-engines.html">https://docs.oracle.com/cd/E17952_01/mysql-5.7-en/storage-engines.html</a></li>
</ul>
</div>
<div id="outline-container-h:3110850c-c00c-43d8-805d-24bac5ed9eca" class="outline-4">
<h4 id="h:3110850c-c00c-43d8-805d-24bac5ed9eca">MyISAM存储引擎</h4>
<div class="outline-text-4" id="text-h:3110850c-c00c-43d8-805d-24bac5ed9eca">
<p>
<b>MyISAM引擎特点</b>
</p>

<ul class="org-ul">
<li>不支持事务</li>
<li>表级锁定</li>
<li>读写相互阻塞，写入不能读，读时不能写</li>
<li>只缓存索引</li>
<li>不支持外键约束</li>
<li>不支持聚簇索引</li>
<li>读取数据较快，占用资源较少</li>
<li>不支持MVCC（多版本并发控制机制）高并发</li>
<li>崩溃恢复性较差</li>
<li>MySQL5.5.5前默认的数据库引擎</li>
</ul>

<p>
<b>MyISAM存储引擎适用场景</b>
</p>

<ul class="org-ul">
<li>只读（或者写较少）、</li>
<li>表较小（可以接受长时间进行修复操作）</li>
</ul>

<p>
<b>MyISAM引擎文件</b>
</p>

<ul class="org-ul">
<li>tbl_name.frm 表格式定义</li>
<li>tbl_name.MYD 数据文件</li>
<li>tbl_name.MYI 索引文件</li>
</ul>
</div>
</div>
<div id="outline-container-h:da93cbf5-ef31-44d0-b46c-98562ba68cf5" class="outline-4">
<h4 id="h:da93cbf5-ef31-44d0-b46c-98562ba68cf5">InnoDB引擎</h4>
<div class="outline-text-4" id="text-h:da93cbf5-ef31-44d0-b46c-98562ba68cf5">
<p>
<b>InnoDB引擎特点</b>
</p>

<ul class="org-ul">
<li>行级锁</li>
<li>支持事务，适合处理大量短期事务</li>
<li>读写阻塞与事务隔离级别相关</li>
<li>可缓存数据和索引</li>
<li>支持聚簇索引</li>
<li>崩溃恢复性更好</li>
<li>支持MVCC高并发</li>
<li>从MySQL5.5后支持全文索引</li>
<li>从MySQL5.5.5开始为默认的数据库引擎</li>
</ul>

<p>
MVCC说明：
</p>
<ol class="org-ol">
<li>执行修改操作时，实际上执行的是删除加插入，这样做的优点就是数据库就
可以并发访问，修改时也可以访问</li>
<li>在3200时间点访问数据库时，看到的数据是前三个</li>
</ol>

<p>
<b>InnoDB数据库文件</b>
</p>


<figure id="org2f36659">
<img src="./images/20200608200826373.png" alt="20200608200826373.png" width="60%">

</figure>

<p>
大概流程：一行里有若干域，一页（16K）里有若干行，多个页放到extent盘区
里，extent合并成一个段，最后段放在表空间中；其中页是存放数据的最小空间
</p>

<ul class="org-ul">
<li>所有InnoDB表的数据和索引放置于同一个表空间中</li>
</ul>

<div class="org-src-container">
<pre class="src src-mysql">数据文件：ibdata1, ibdata2,存放在datadir定义的目录下;  #centos6默认在/var/lib/mysql/
表格式定义：tb_name.frm,存放在datadir定义的每个数据库对应的目录下
</pre>
</div>

<ul class="org-ul">
<li>每个表单独使用一个表空间存储表的数据和索引</li>
</ul>

<div class="org-src-container">
<pre class="src src-mysql">两类文件放在对应每个数据库独立目录中
数据文件(存储数据和索引)：tb_name.ibd
表格式定义：tb_name.frm
</pre>
</div>

<p>
启用：innodb_file_per_table=ON (MariaDB 5.5以后版是默认值)
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#36825;&#20010;&#21464;&#37327;&#26159;&#21542;&#24320;&#21551;&#23545;&#24212;&#21151;&#33021;&#12290;@@&#26597;&#20869;&#32622;&#21464;&#37327;</span>
&gt;select @@innodb_file_per_table 
</pre>
</div>
<p>
参看：<a href="https://mariadb.com/kb/en/library/xtradbinnodb-server-system-variables/#innodb_file_per_table">https://mariadb.com/kb/en/library/xtradbinnodb-server-system-variables/#innodb_file_per_table</a>
</p>
</div>
</div>
<div id="outline-container-h:6c3b9816-c874-4bde-9f4a-48abb72ac52b" class="outline-4">
<h4 id="h:6c3b9816-c874-4bde-9f4a-48abb72ac52b">其它存储擎</h4>
<div class="outline-text-4" id="text-h:6c3b9816-c874-4bde-9f4a-48abb72ac52b">
<ul class="org-ul">
<li>Performance_Schema：Performance_Schema数据库使用</li>
<li>Memory：将所有数据存储在RAM中，以便在需要快速查找参考和其他类似数据
的环境中进行快速访问。适用存放临时数据。引擎以前被称为HEAP引擎</li>
<li>MRG_MyISAM：使MySQLDBA或开发人员能够对一系列相同的MyISAM表进行逻辑分
组，并将它们作为一个对象引用。适用于VLDB(Very Large Data Base)环境，
如数据仓库</li>
<li>Archive：为存储和检索大量很少参考的存档或安全审核信息，只支持SELECT
和INSERT操作；支持行级锁和专用缓存区</li>
<li>Federated联合：用于访问其它远程MySQL服务器一个代理，它通过创建一个到
远程MySQL服务器的客户端连接，并将查询传输到远程服务器执行，而后完成
数据存取，提供链接单独MySQL服务器的能力，以便从多个物理服务器创建一
个逻辑数据库。非常适合分布式或数据集市环境</li>
<li>BDB：可替代InnoDB的事务引擎，支持COMMIT、ROLLBACK和其他事务特性</li>
<li>Cluster/NDB：MySQL的簇式数据库引擎，尤其适合于具有高性能查找要求的应
用程序，这类查找需求还要求具有最高的正常工作时间和可用性</li>
<li>CSV：CSV存储引擎使用逗号分隔值格式将数据存储在文本文件中。可以使用
CSV引擎以CSV格式导入和导出其他软件和应用程序之间的数据交换</li>
<li>BLACKHOLE：黑洞存储引擎接受但不存储数据，检索总是返回一个空集。该功
能可用于分布式数据库设计，数据自动复制，但不是本地存储</li>
<li>example："stub"引擎，它什么都不做。可以使用此引擎创建表，但不能将数
据存储在其中或从中检索。目的是作为例子来说明如何开始编写新的存储引擎</li>
</ul>
</div>
</div>
<div id="outline-container-h:28463359-f410-47b8-8332-0703c17788e4" class="outline-4">
<h4 id="h:28463359-f410-47b8-8332-0703c17788e4">管理存储引擎</h4>
<div class="outline-text-4" id="text-h:28463359-f410-47b8-8332-0703c17788e4">
<p>
查看mysql支持的存储引擎
</p>

<div class="org-src-container">
<pre class="src src-sql">show engines;
</pre>
</div>

<p>
查看当前默认的存储引擎
</p>

<div class="org-src-container">
<pre class="src src-sql">show variables <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'%storage_engine%'</span>;
</pre>
</div>

<p>
设置默认的存储引擎
</p>

<div class="org-src-container">
<pre class="src src-sh">vim /etc/my.conf
[mysqld]
<span style="color: #a0522d;">default_storage_engine</span>= InnoDB
</pre>
</div>

<p>
查看库中所有表使用的存储引擎
</p>

<div class="org-src-container">
<pre class="src src-sql">show <span style="color: #a020f0;">table</span> status <span style="color: #a020f0;">from</span> db_name;
</pre>
</div>

<p>
查看库中指定表的存储引擎
</p>

<div class="org-src-container">
<pre class="src src-sql">show <span style="color: #a020f0;">table</span> status <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'tb_name'</span>;
show <span style="color: #a020f0;">create</span> <span style="color: #a020f0;">table</span> tb_name;
</pre>
</div>

<p>
设置表的存储引擎：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">tb_name</span>(... ) ENGINE=InnoDB;
<span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">tb_name</span> ENGINE=InnoDB;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:532a2efb-a8fe-4117-8cb2-ca48dee4ab15" class="outline-3">
<h3 id="h:532a2efb-a8fe-4117-8cb2-ca48dee4ab15">MySQL中的系统数据库</h3>
<div class="outline-text-3" id="text-h:532a2efb-a8fe-4117-8cb2-ca48dee4ab15">
<ul class="org-ul">
<li><p>
<b>mysql数据库</b>
</p>

<p>
是mysql的核心数据库，类似于Sql Server中的master库，主要负责存储数据库的用户、权限设置、关键字等mysql自己需要使用的控制和管理信息
</p></li>

<li><p>
<b>performance_schema数据库</b>
</p>

<p>
MySQL5.5开始新增的数据库，主要用于收集数据库服务器性能参数,库里表的
存储引擎均为PERFORMANCE_SCHEMA，用户不能创建存储引擎为
PERFORMANCE_SCHEMA的表
</p></li>

<li><p>
<b>information_schema数据库</b>
</p>

<p>
MySQL5.0之后产生的，一个虚拟数据库，物理上并不存在information_schema
数据库类似与“数据字典”，提供了访问数据库元数据的方式，即数据的数据。
比如数据库名或表名，列类型，访问权限（更加细化的访问方式）
</p></li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">information_schema&#25968;&#25454;&#24211;&#20013;&#26377;&#19977;&#20010;&#34920;&#38750;&#24120;&#37325;&#35201;&#65306;

- SCHEMATA&#65306;&#34920;&#37324;&#21253;&#21547;&#25152;&#26377;&#25968;&#25454;&#24211;&#30340;&#21517;&#23383;
- TABLES&#65306;&#34920;&#37324;&#21253;&#21547;&#25152;&#26377;&#25968;&#25454;&#24211;&#30340;&#25152;&#26377;&#34920;&#65292;&#40664;&#35748;&#23383;&#27573;&#20026;table_name
- COLUMNS&#65306;&#34920;&#37324;&#21253;&#21547;&#25152;&#26377;&#25968;&#25454;&#24211;&#30340;&#25152;&#26377;&#34920;&#30340;&#25152;&#26377;&#23383;&#27573;

&#19977;&#20010;&#21015;&#38750;&#24120;&#37325;&#35201;&#65306;

- TABLE_SCHEMA&#65306;&#25968;&#25454;&#24211;&#21517;
- TABLE_NAME&#65306;&#34920;&#21517;
- COLUMN_NAME&#65306;&#23383;&#27573;&#21517;
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-mysql">mysql&gt; use information_schema
mysql&gt; desc COLUMNS; # 查看所有表的字段
+--------------------------+---------------------+------+-----+---------+-------+
| Field                    | Type                | Null | Key | Default | Extra |
+--------------------------+---------------------+------+-----+---------+-------+
| TABLE_SCHEMA             | varchar(64)         | NO   |     |         |       |
| TABLE_NAME               | varchar(64)         | NO   |     |         |       |
| COLUMN_NAME              | varchar(64)         | NO   |     |         |       |

mysql&gt; select table_name from information_schema.tables where table_schema = 'dvwa';
+------------+
| table_name |
+------------+
| guestbook  |
| users      |
+------------+
</pre>
</div>

<ul class="org-ul">
<li><p>
<b>sys数据库</b>
</p>

<p>
MySQL5.7之后新增加的数据库，库中所有数据源来自performance_schema。目
标是把performance_schema的把复杂度降低，让DBA能更好的阅读这个库里的
内容。让DBA更快的了解DB的运行情况
</p></li>
</ul>
</div>
</div>
<div id="outline-container-h:60740cea-39aa-4e28-ab2b-a73b6c02e704" class="outline-3">
<h3 id="h:60740cea-39aa-4e28-ab2b-a73b6c02e704">服务器配置和状态</h3>
<div class="outline-text-3" id="text-h:60740cea-39aa-4e28-ab2b-a73b6c02e704">
<p>
可以通过mysqld选项，服务器系统变量和服务器状态变量进行MySQL的配置和查看状态
</p>

<p>
<b>官方帮助</b> ：
</p>
<ul class="org-ul">
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/server-option-variable-reference.html">https://dev.mysql.com/doc/refman/8.0/en/server-option-variable-reference.html</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/server-option-variable-reference.html">https://dev.mysql.com/doc/refman/5.7/en/server-option-variable-reference.html</a></li>
<li><a href="https://mariadb.com/kb/en/library/full-list-of-mariadb-options-system-and-status-variables/">https://mariadb.com/kb/en/library/full-list-of-mariadb-options-system-and-status-variables/</a></li>
</ul>

<p>
<b>说明</b>:
</p>

<p>
<b>Cmd-Line和Option File 都为yes时就是服务器选项</b>
</p>

<p>
<b>System Var 为yes时就是服务器变量</b>
</p>

<p>
<b>Dynamic 为 No 时代表变量为只读，只能看不能改</b>
</p>

<p>
注意：
</p>

<ul class="org-ul">
<li>其中有些参数支持运行时修改，会立即生效</li>
<li>有些参数不支持动态修改，且只能通过修改配置文件，并重启服务器程序生效</li>
<li>有些参数作用域是全局的，为所有会话设置</li>
<li>有些可以为每个用户提供单独（会话）的设置</li>
</ul>
</div>
<div id="outline-container-h:dd9652f1-b828-48c8-bfba-519dc4068895" class="outline-4">
<h4 id="h:dd9652f1-b828-48c8-bfba-519dc4068895">服务器选项</h4>
<div class="outline-text-4" id="text-h:dd9652f1-b828-48c8-bfba-519dc4068895">
<p>
获取mysqld的可用选项列表：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;mysqld&#21487;&#29992;&#36873;&#39033;&#21015;&#34920;&#21644;&#21450;&#24403;&#21069;&#20540;</span>
mysqld --verbose --help

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;mysqld&#24403;&#21069;&#21551;&#21160;&#36873;&#39033;</span>
mysqld --print-defaults
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#21487;&#29992;&#36873;&#39033;&#21015;&#34920;&#21644;&#24403;&#21069;&#20540;</span>
[root@centos8 ~]#/usr/libexec/mysqld --verbose --help

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;mysqld&#30340;&#24403;&#21069;&#21551;&#21160;&#36873;&#39033;</span>
[root@centos8 ~]#/usr/libexec/mysqld --print-defaults
/usr/libexec/mysqld would have been started with the following arguments:
--plugin-load-add=auth_gssapi.so --datadir=/var/lib/mysql --
<span style="color: #a0522d;">socket</span>=/var/lib/mysql/mysql.sock --log-error=/var/log/mariadb/mariadb.log --pidfile=/run/mariadb/mariadb.pid
</pre>
</div>

<p>
设置服务器选项方法：
</p>

<ol class="org-ol">
<li>在命令行中设置</li>
</ol>

<div class="org-src-container">
<pre class="src src-sh">shell&gt; /usr/bin/mysqld_safe --skip-name-resolve=1
shell&gt; /usr/libexec/mysqld --basedir=/usr
</pre>
</div>

<ol class="org-ol">
<li>在配置文件my.cnf中设置</li>
</ol>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">vim /etc/my.cnf
[mysqld]
<span style="color: #a0522d;">skip_name_resolve</span>=1
skip-grant-tables
</pre>
</div>

<p>
范例: skip-grant-tables是服务器选项,但不是系统变量
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mysqladmin variables |grep skip_grant_tables
[root@centos8 ~]#mysql
MariaDB [(none)]&gt; show variables like <span style="color: #8b2252;">'skip_grant_tables'</span>;
Empty set (0.001 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d1c8edd5-6e51-4d1d-99d1-a9d1620c852e" class="outline-4">
<h4 id="h:d1c8edd5-6e51-4d1d-99d1-a9d1620c852e">服务器系统变量</h4>
<div class="outline-text-4" id="text-h:d1c8edd5-6e51-4d1d-99d1-a9d1620c852e">
<p>
服务器系统变量：可以分全局和会话两种
获取系统变量
</p>

<div class="org-src-container">
<pre class="src src-sh">SHOW GLOBAL VARIABLES;      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#26597;&#30475;global&#21464;&#37327;</span>
SHOW [SESSION] VARIABLES;   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25152;&#26377;&#21464;&#37327;(&#21253;&#25324;global&#21644;session)</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#30340;&#31995;&#32479;&#21464;&#37327;</span>
SHOW VARIABLES LIKE <span style="color: #8b2252;">'VAR_NAME'</span>;
SELECT @@VAR_NAME;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#36873;&#39033;&#21644;&#37096;&#20998;&#21464;&#37327;</span>
[root@centos8 ~]#mysqladmin variables
</pre>
</div>

<p>
修改服务器变量的值：
</p>
<div class="org-src-container">
<pre class="src src-sql">help <span style="color: #a020f0;">SET</span>
</pre>
</div>

<p>
修改全局变量：仅对修改后新创建的会话有效；对已经建立的会话无效
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SET</span> <span style="color: #a020f0;">GLOBAL</span> system_var_name=<span style="color: #a020f0;">value</span>;
<span style="color: #a020f0;">SET</span> @@<span style="color: #a020f0;">global</span>.system_var_name=<span style="color: #a020f0;">value</span>;
</pre>
</div>

<p>
修改会话变量：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SET</span> [<span style="color: #a020f0;">SESSION</span>] system_var_name=<span style="color: #a020f0;">value</span>;
<span style="color: #a020f0;">SET</span> @@[<span style="color: #a020f0;">session</span>.]system_var_name=<span style="color: #a020f0;">value</span>;
</pre>
</div>

<p>
范例: character_set_results是系统变量并非服务器选项
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mysql
MariaDB [(none)]&gt; show variables like <span style="color: #8b2252;">'character_set_results'</span>;
+-----------------------+-------+
| Variable_name         | Value |
+-----------------------+-------+
| character_set_results | utf8  |
+-----------------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [(none)]&gt; set <span style="color: #a0522d;">character_set_results</span>=<span style="color: #8b2252;">"utf8mb4"</span>;
Query OK, 0 rows affected (0.000 sec)

MariaDB [(none)]&gt; show variables like <span style="color: #8b2252;">'character_set_results'</span>;
+-----------------------+---------+
| Variable_name         | Value   |
+-----------------------+---------+
| character_set_results | utf8mb4 |
+-----------------------+---------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

[root@centos8 ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
<span style="color: #a0522d;">character_set_results</span>=utf8mb4

<span style="color: #b22222;">#</span><span style="color: #b22222;">character_set_results&#19981;&#26159;&#26381;&#21153;&#22120;&#36873;&#39033;,&#20889;&#20837;&#37197;&#32622;&#25991;&#20214;&#23558;&#23548;&#33268;&#26080;&#27861;&#21551;&#21160;</span>
[root@centos8 ~]#systemctl restart mariadb
Job for mariadb.service failed because the control process exited with error code.
See <span style="color: #8b2252;">"systemctl status mariadb.service"</span> and <span style="color: #8b2252;">"journalctl -xe"</span> for details.
</pre>
</div>

<p>
范例：修改mysql的最大并发连接数
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#20540;&#20026;151</span>
[root@centos8 ~]#mysqladmin variables |grep <span style="color: #8b2252;">'\&lt;max_connections'</span>
| max_connections | 151
[root@centos8 ~]#mysql
MariaDB [(none)]&gt; show variables like <span style="color: #8b2252;">'max_connections'</span>;
+-----------------+-------+
| Variable_name   | Value |
+-----------------+-------+
| max_connections | 151   |
+-----------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [hellodb]&gt; set global <span style="color: #a0522d;">max_connections</span>=2000;
Query OK, 0 rows affected (0.000 sec)

MariaDB [hellodb]&gt; show variables like <span style="color: #8b2252;">'max_connections'</span>;
+-----------------+-------+
| Variable_name   | Value |
+-----------------+-------+
| max_connections | 2000  |
+-----------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

[root@centos8 ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
max_connections = 8000

[root@centos8 ~]#systemctl restart mariadb
[root@centos8 ~]#mysql -uroot -p
MariaDB [(none)]&gt; select @@max_connections;
+-------------------+
| @@max_connections |
+-------------------+
|               594 |
+-------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1</span>
[root@centos8 ~]#vim /usr/lib/systemd/system/mariadb.service
[Service]
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#19979;&#38754;&#19968;&#34892;</span>
<span style="color: #a0522d;">LimitNOFILE</span>=65535

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2</span>
[root@centos8 ~]#mkdir /etc/systemd/system/mariadb.service.d/
[root@node3 ~]#vim /etc/systemd/system/mariadb.service.d/limits.conf
[Service]
<span style="color: #a0522d;">LimitNOFILE</span>=65535

[root@centos8 ~]#systemctl daemon-reload
[root@centos8 ~]#systemctl restart mariadb
[root@centos8 ~]#mysql -uroot -p -e <span style="color: #8b2252;">"select @@max_connections"</span>
Enter password:
+-------------------+
| @@max_connections |
+-------------------+
|              8000 |
+-------------------+
</pre>
</div>

<p>
范例：修改页大小
</p>

<p>
参看：<a href="https://mariadb.com/kb/en/innodb-system-variables/#innodb_page_size">https://mariadb.com/kb/en/innodb-system-variables/#innodb_page_size</a>
</p>

<p>
说明：初始化数据目录后，不能更改此系统变量的值。
</p>

<p>
在MariaDB实例启动时设置InnoDB的页面大小，此后保持不变。
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mysqladmin variables |grep innodb_page_size
| innodb_page_size | 16384

[root@centos8 ~]#mysql
MariaDB [(none)]&gt; show variables like <span style="color: #8b2252;">"innodb_page_size"</span>;
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| innodb_page_size | 16384 |
+------------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

[root@centos8 ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
<span style="color: #a0522d;">innodb_page_size</span>=64k

[root@centos8 ~]#rm -rf /var/lib/mysql/*
[root@centos8 ~]#systemctl restart mariadb

[root@centos8 ~]#mysql
MariaDB [(none)]&gt; show variables like <span style="color: #8b2252;">"innodb_page_size"</span>;
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| innodb_page_size | 65536 |
+------------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2c19a9c9-aeb5-4eaf-903a-768ce6e1baf5" class="outline-4">
<h4 id="h:2c19a9c9-aeb5-4eaf-903a-768ce6e1baf5">服务器状态变量</h4>
<div class="outline-text-4" id="text-h:2c19a9c9-aeb5-4eaf-903a-768ce6e1baf5">
<p>
服务器状态变量：分全局和会话两
</p>

<p>
状态变量（只读）：用于保存mysqld运行中的统计数据的变量，不可更改，只影响自己的session
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW <span style="color: #a020f0;">GLOBAL</span> STATUS;
SHOW [<span style="color: #a020f0;">SESSION</span>] STATUS;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">MariaDB [(none)]&gt; show status like <span style="color: #8b2252;">"innodb_page_size"</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#20010;&#23384;&#20648;&#24341;&#25806;&#39029;&#30340;&#22823;&#23567;</span>
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| Innodb_page_size | 16384 |
+------------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [hellodb]&gt; SHOW GLOBAL STATUS like <span style="color: #8b2252;">'com_select'</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#25968;&#25454;&#24211;&#26597;&#35810;&#30340;&#27425;&#25968;</span>
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| Com_select    |     5 |
+---------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:53e12fb7-b477-424d-a215-2af6f7bf2e7c" class="outline-4">
<h4 id="h:53e12fb7-b477-424d-a215-2af6f7bf2e7c">服务器变量 SQL_MODE</h4>
<div class="outline-text-4" id="text-h:53e12fb7-b477-424d-a215-2af6f7bf2e7c">
<p>
SQL_MODE：对其设置可以完成一些约束检查的工作,可分别进行全局的设置或当前会话的设置
</p>

<p>
<b>参考</b> ：
</p>
<ul class="org-ul">
<li><a href="https://mariadb.com/kb/en/library/sql-mode/">https://mariadb.com/kb/en/library/sql-mode/</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/server-options.html#option_mysqld_sql-mode">https://dev.mysql.com/doc/refman/5.7/en/server-options.html#option_mysqld_sql-mode</a></li>
</ul>

<p>
<b>常见MODE</b>:
</p>

<ul class="org-ul">
<li>NO_AUTO_CREATE_USER： 禁止GRANT创建密码为空的用户</li>
<li>NO_ZERO_DATE：在严格模式，不允许使用'0000-00-00'的时间</li>
<li>ONLY_FULL_GROUP_BY： 对于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出现，那么将认为这个SQL是不合法的</li>
<li>NO_BACKSLASH_ESCAPES： 反斜杠“\”作为普通字符而非转义字符</li>
<li>PIPES_AS_CONCAT： 将”||"视为连接操作符而非“或"运算符</li>
</ul>

<p>
范例：CentOS 8 修改SQL_MODE变量实现分组语句控制
</p>

<div class="org-src-container">
<pre class="src src-sh">MariaDB [hellodb]&gt; show variables like <span style="color: #8b2252;">'sql_mode'</span>;
+---------------+-------------------------------------------------------------------------------------------+
| Variable_name | Value                                                                                     |
+---------------+-------------------------------------------------------------------------------------------+
| sql_mode      | STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |
+---------------+-------------------------------------------------------------------------------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [hellodb]&gt; select classid,count(*) from students group by classid;
+---------+----------+
| classid | count(*) |
+---------+----------+
|    NULL |        2 |
|       1 |        4 |
|       2 |        3 |
|       3 |        4 |
|       4 |        4 |
|       5 |        1 |
|       6 |        4 |
|       7 |        3 |
+---------+----------+
8 rows<span style="color: #a020f0;"> in</span> set (0.000 sec)

MariaDB [hellodb]&gt; select stuid,classid,count(*) from students group by classid;
+-------+---------+----------+
| stuid | classid | count(*) |
+-------+---------+----------+
|    24 |    NULL |        2 |
|     2 |       1 |        4 |
|     1 |       2 |        3 |
|     5 |       3 |        4 |
|     4 |       4 |        4 |
|     6 |       5 |        1 |
|     9 |       6 |        4 |
|     8 |       7 |        3 |
+-------+---------+----------+
8 rows<span style="color: #a020f0;"> in</span> set (0.000 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;SQL_MODE</span>
MariaDB [hellodb]&gt; set <span style="color: #a0522d;">sql_mode</span>=<span style="color: #8b2252;">'ONLY_FULL_GROUP_BY'</span>;
Query OK, 0 rows affected (0.000 sec)

MariaDB [hellodb]&gt; show variables like <span style="color: #8b2252;">'sql_mode'</span>;
+---------------+--------------------+
| Variable_name | Value              |
+---------------+--------------------+
| sql_mode      | ONLY_FULL_GROUP_BY |
+---------------+--------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [hellodb]&gt; select classid,count(*) from students group by classid;
+---------+----------+
| classid | count(*) |
+---------+----------+
|    NULL |        2 |
|       1 |        4 |
|       2 |        3 |
|       3 |        4 |
|       4 |        4 |
|       5 |        1 |
|       6 |        4 |
|       7 |        3 |
+---------+----------+
8 rows<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [hellodb]&gt; select stuid,classid,count(*) from students group by classid;
ERROR 1055 (42000): <span style="color: #8b2252;">'hellodb.students.StuID'</span> isn<span style="color: #8b2252;">'t in GROUP BY</span>
</pre>
</div>

<p>
范例：CentOS 7 修改SQL_MODE变量
</p>

<div class="org-src-container">
<pre class="src src-sh">MariaDB [hellodb]&gt; create table test (id int,name varchar(3));
Query OK, 0 rows affected (0.008 sec)

MariaDB [hellodb]&gt; insert test values(1,<span style="color: #8b2252;">'abcde'</span>);
Query OK, 1 row affected, 1 warning (0.003 sec)

MariaDB [hellodb]&gt; show warnings;
+---------+------+-------------------------------------------+
| Level   | Code | Message                                   |
+---------+------+-------------------------------------------+
| Warning | 1265 | Data truncated for column <span style="color: #8b2252;">'name'</span> at row 1 |
+---------+------+-------------------------------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)

MariaDB [hellodb]&gt; select * from test;
+------+------+
| id   | name |
+------+------+
|    1 | abc  |
+------+------+
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)

MariaDB [hellodb]&gt; show variables like <span style="color: #8b2252;">'SQL_MODE'</span>;
+---------------+-----------+
| Variable_name | Value     |
+---------------+-----------+
| sql_mode      |           |
+---------------+-----------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [hellodb]&gt; set <span style="color: #a0522d;">SQL_MODE</span>=TRADITIONAL;
Query OK, 0 rows affected (0.000 sec)

MariaDB [hellodb]&gt; show variables like <span style="color: #8b2252;">'SQL_MODE'</span>;
+---------------+------------------------------------------------------------------------------------------------------------------------------------------------------+
| Variable_name | Value                                                                                                                                                |
+---------------+------------------------------------------------------------------------------------------------------------------------------------------------------+
| sql_mode      | STRICT_TRANS_TABLES,STRICT_ALL_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,TRADITIONAL,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |
+---------------+------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.002 sec)

MariaDB [hellodb]&gt; insert test values(1,<span style="color: #8b2252;">'xxx'</span>);
ERROR 1406 (22001): Data too long for column <span style="color: #8b2252;">'name'</span> at row 1
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:9a24ca51-7a13-4050-9938-c0b929fa062e" class="outline-3">
<h3 id="h:9a24ca51-7a13-4050-9938-c0b929fa062e">Query Cache 查询缓存</h3>
<div class="outline-text-3" id="text-h:9a24ca51-7a13-4050-9938-c0b929fa062e">
</div>
<div id="outline-container-h:4cc5da30-42d2-47da-af85-12d4c0aa2fd2" class="outline-4">
<h4 id="h:4cc5da30-42d2-47da-af85-12d4c0aa2fd2">查询缓存原理</h4>
<div class="outline-text-4" id="text-h:4cc5da30-42d2-47da-af85-12d4c0aa2fd2">
<p>
<b>查询执行路径</b>
</p>


<figure id="org47b1860">
<img src="./images/img_20240130_023148.png" alt="img_20240130_023148.png" width="60%">

</figure>

<p>
<b>查询缓存原理</b>
</p>

<p>
缓存SELECT操作或预处理查询的结果集和SQL语句，当有新的SELECT语句或预处
理查询语句请求，先去查询缓存，判断是否存在可用的记录集，*查询命令会转
换成hash值*，判断标准：hash值与缓存的SQL语句hash值，是否完全一样，区分
大小写
</p>

<p>
<b>优缺点</b>
</p>

<p>
不需要对SQL语句做任何解析和执行，当然语法解析必须通过在先，直接从Query
Cache中获得查询结果，提高查询性能
</p>

<p>
查询缓存的判断规则，不够智能，也即提高了查询缓存的使用门槛，降低效率
</p>

<p>
查询缓存的使用，会增加检查和清理Query Cache中记录集的开销
</p>

<p>
<b>哪些查询可能不会被缓存</b>
</p>

<ul class="org-ul">
<li>查询语句中加了SQL_NO_CACHE参数</li>
<li>查询语句中含有获得值的函数，包含:自定义函数，如：NOW()，CURDATE()、GET_LOCK()、RAND()、CONVERT_TZ()等</li>
<li>对系统数据库的查询：mysql、information_schema
查询语句中使用SESSION级别变量或存储过程中的局部变量</li>
<li>查询语句中使用了LOCK IN SHARE MODE、FOR
UPDATE的语句，查询语句中类似SELECT &#x2026;INTO 导出数据的语句</li>
<li>对临时表的查询操作</li>
<li>存在警告信息的查询语句</li>
<li>不涉及任何表或视图的查询语句</li>
<li>某用户只有列级别权限的查询语句</li>
<li>事务隔离级别为Serializable时，所有查询语句都不能缓存</li>
</ul>
</div>
</div>
<div id="outline-container-h:5a365c2c-82b8-46a5-8a00-b164f3f5f79c" class="outline-4">
<h4 id="h:5a365c2c-82b8-46a5-8a00-b164f3f5f79c">查询缓存相关的服务器变量</h4>
<div class="outline-text-4" id="text-h:5a365c2c-82b8-46a5-8a00-b164f3f5f79c">
<ul class="org-ul">
<li>query_cache_min_res_unit：查询缓存中内存块的最小分配单位，默认4k，较
小值会减少浪费，但会导致更频繁的内存分配操作，较大值会带来浪费，会导
致碎片过多，内存不足</li>
<li>query_cache_limit：单个查询结果能缓存的最大值，单位字节，默认为1M，
对于查询结果过大而无法缓存的语句，建议使用SQL_NO_CACHE</li>
<li>query_cache_size：查询缓存总共可用的内存空间；单位字节，必须是1024的
整数倍，最小值40KB，低于此值有警报，临时设置时不能使用单位，修改配置
文件可以使用单位</li>
<li>query_cache_wlock_invalidate：如果某表被其它的会话锁定，是否仍然可以
从查询缓存中返回结果，默认值为OFF，表示可以在表被其它会话锁定的场景
中继续从缓存返回数据；ON则表示不允许</li>
<li>query_cache_type：是否开启缓存功能，取值为ON, OFF, DEMAND</li>
</ul>
</div>
</div>
<div id="outline-container-h:a3ca6b41-122c-4785-9d87-b24328cf4099" class="outline-4">
<h4 id="h:a3ca6b41-122c-4785-9d87-b24328cf4099">SELECT语句的缓存控制</h4>
<div class="outline-text-4" id="text-h:a3ca6b41-122c-4785-9d87-b24328cf4099">
<ul class="org-ul">
<li>SQL_CACHE：显式指定存储查询结果于缓存之中</li>
<li>SQL_NO_CACHE：显式查询结果不予缓存</li>
<li>query_cache_type参数变量</li>
<li>query_cache_type的值为OFF或0时，查询缓存功能关闭</li>
<li>query_cache_type的值为ON或1时，查询缓存功能打开，SELECT的结果符合缓
存条件即会缓存，否则，不予缓存，显式指定SQL_NO_CACHE，不予缓存，此为
默认值</li>
<li>query_cache_type的值为DEMAND或2时，查询缓存功能按需进行，显式指定
SQL_CACHE的SELECT语句才会缓存；其它均不予缓存</li>
</ul>

<p>
官方帮助：
</p>
<pre class="example" id="org650d8ed">
- &lt;https://mariadb.com/kb/en/library/server-system-variables/#query_cache_type&gt;
- &lt;https://dev.mysql.com/doc/refman/5.7/en/query-cache-configuration.html&gt;
</pre>
</div>
</div>
<div id="outline-container-h:58da837a-7de6-48d2-9486-af526545e234" class="outline-4">
<h4 id="h:58da837a-7de6-48d2-9486-af526545e234">查询缓存相关的状态变量：</h4>
<div class="outline-text-4" id="text-h:58da837a-7de6-48d2-9486-af526545e234">
<ul class="org-ul">
<li>Qcache_free_blocks：处于空闲状态 Query Cache中内存 Block 数</li>
<li>Qcache_total_blocks：Query Cache 中总Block，当Qcache_free_blocks相对
此值较大时，可能用内存碎片，执行FLUSH QUERY CACHE清理碎片</li>
<li>Qcache_free_memory：处于空闲状态的 Query Cache 内存总量</li>
<li>Qcache_hits：Query Cache 命中次数（查询时利用了查询缓存，即命中一次）</li>
<li>Qcache_inserts：向 Query Cache 中插入新的 Query Cache的次数，即没有命中的次数</li>
<li>Qcache_lowmem_prunes：记录因为内存不足而被移除出查询缓存的查询数</li>
<li>Qcache_not_cached：没有被 Cache 的 SQL 数，包括无法被 Cache 的 SQL
以及由于query_cache_type 设置的不会被 Cache 的 SQL语句</li>
<li>Qcache_queries_in_cache：在 Query Cache 中的 SQL 数量</li>
</ul>
</div>
</div>
<div id="outline-container-h:7af5b956-e639-439f-89bd-77f9ef98a78a" class="outline-4">
<h4 id="h:7af5b956-e639-439f-89bd-77f9ef98a78a">命中率和内存使用率估算</h4>
<div class="outline-text-4" id="text-h:7af5b956-e639-439f-89bd-77f9ef98a78a">
<ul class="org-ul">
<li>查询缓存中内存块的最小分配单位query_cache_min_res_unit ：</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql">(query_cache_size - Qcache_free_memory) / Qcache_queries_in_cache
#&#65288;&#26597;&#35810;&#32531;&#23384;&#30340;&#24635;&#23481;&#37327; - &#21097;&#20313;&#20869;&#23384;&#30340;&#31354;&#38388;&#65289;/&#24050;&#32463;&#32531;&#23384;&#19979;&#26469;&#30340;&#35760;&#24405;&#25968;
</pre>
</div>

<ul class="org-ul">
<li>查询缓存命中率 ：</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql">Qcache_hits / ( Qcache_hits + Qcache_inserts ) * 100%
</pre>
</div>

<ul class="org-ul">
<li>查询缓存内存使用率：</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql">(query_cache_size &#8211; qcache_free_memory) / query_cache_size * 100%
#&#65288;&#26597;&#35810;&#32531;&#23384;&#30340;&#24635;&#23481;&#37327; - &#21097;&#20313;&#20869;&#23384;&#30340;&#31354;&#38388;&#65289;/&#24635;&#30340;&#26597;&#35810;&#32531;&#23384;&#31354;&#38388;
#&#65288;&#30446;&#21069;&#21344;&#29992;&#30340;&#31354;&#38388;&#65289;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">[root@centos7 ~]#vim /etc/my.cnf
[mysqld]
query_cache_type=<span style="color: #a020f0;">ON</span>
query_cache_size=10M

[root@centos8 ~]#systemctl restart mariadb
[root@centos8 ~]#mysql -uroot -p
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; show variables <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'query_cache%'</span>;
+<span style="color: #b22222;">------------------------------</span><span style="color: #b22222;">+----------+</span>
| Variable_name                | <span style="color: #a020f0;">Value</span>    |
+<span style="color: #b22222;">------------------------------</span><span style="color: #b22222;">+----------+</span>
| query_cache_limit            | 1048576  |
| query_cache_min_res_unit     | 4096     |
| query_cache_size             | 10485760 |
| query_cache_strip_comments   | <span style="color: #a020f0;">OFF</span>      |
| query_cache_type             | <span style="color: #a020f0;">ON</span>       |
| query_cache_wlock_invalidate | <span style="color: #a020f0;">OFF</span>      |
+<span style="color: #b22222;">------------------------------</span><span style="color: #b22222;">+----------+</span>
6 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; show <span style="color: #a020f0;">GLOBAL</span> STATUS <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'Qcache%'</span>;
+<span style="color: #b22222;">-------------------------</span><span style="color: #b22222;">+---------+</span>
| Variable_name           | <span style="color: #a020f0;">Value</span>   |
+<span style="color: #b22222;">-------------------------</span><span style="color: #b22222;">+---------+</span>
| Qcache_free_blocks      | 1       |
| Qcache_free_memory      | 1027736 |
| Qcache_hits             | 4       |
| Qcache_inserts          | 3       |
| Qcache_lowmem_prunes    | 0       |
| Qcache_not_cached       | 0       |
| Qcache_queries_in_cache | 3       |
| Qcache_total_blocks     | 8       |
+<span style="color: #b22222;">-------------------------</span><span style="color: #b22222;">+---------+</span>
8 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c98974a2-805f-4d46-91d4-b438655d1946" class="outline-4">
<h4 id="h:c98974a2-805f-4d46-91d4-b438655d1946">MySQL 8.0 变化 MySQL8.0 取消查询缓存的功能</h4>
<div class="outline-text-4" id="text-h:c98974a2-805f-4d46-91d4-b438655d1946">
<p>
尽管MySQL Query
Cache旨在提高性能，但它存在严重的可伸缩性问题，并且很容易成为严重的瓶颈。
</p>

<p>
自MySQL 5.6（2013）以来，默认情况下已禁用查询缓存，其不能与多核计算机
上在高吞吐量工作负载情况下进行扩展。
</p>

<p>
另外有时因为查询缓存往往弊大于利。比如:查询缓存的失效非常频繁，只要有
对一个表的更新，这个表上的所有的查询缓存都会被清空。因此很可能你费劲地
把结果存起来，还没使用呢，就被一个更新全清空了。对于更新压力大的数据库
来说，查询缓存的命中率会非常低。除非你的业务有一张静态表，很长时间更新
一次，比如系统配置表，那么这张表的查询才适合做查询缓存。
</p>

<p>
目前大多数应用都把缓存做到了应用逻辑层，比如:使用redis或者memcache
</p>
</div>
</div>
</div>
<div id="outline-container-h:2c4d773a-c488-4e84-9be8-795e81442717" class="outline-3">
<h3 id="h:2c4d773a-c488-4e84-9be8-795e81442717">INDEX 索引</h3>
<div class="outline-text-3" id="text-h:2c4d773a-c488-4e84-9be8-795e81442717">
</div>
<div id="outline-container-h:015a3bcd-e4e2-4de6-a5d3-f0b9accbcc1e" class="outline-4">
<h4 id="h:015a3bcd-e4e2-4de6-a5d3-f0b9accbcc1e">索引介绍</h4>
<div class="outline-text-4" id="text-h:015a3bcd-e4e2-4de6-a5d3-f0b9accbcc1e">
<p>
索引：是排序的快速查找的特殊数据结构，定义作为查找条件的字段上，又称为
键key，索引通过存储引擎实现
</p>

<p>
<b>优点</b> ：
</p>

<ul class="org-ul">
<li>索引可以降低服务需要扫描的数据量，减少了IO次数</li>
<li>索引可以帮助服务器避免排序和使用临时表</li>
<li>索引可以帮助将随机I/O转为顺序I/O</li>
</ul>

<p>
<b>缺点</b> ：
</p>

<ul class="org-ul">
<li>占用额外空间，影响插入速度</li>
</ul>

<p>
<b>索引类型</b> ：
</p>

<ul class="org-ul">
<li>`B+ TREE、HASH、R TREE、FULL TEXT`</li>
<li>聚簇（集）索引、非聚簇索引：数据和索引是否存储在一起；如innodb是聚集，MyISAM是非聚集</li>
<li>主键索引、二级（辅助）索引</li>
<li>稠密索引、稀疏索引：是否索引了每一个数据项</li>
<li>简单索引、组合索引：是否是多个字段的索引</li>
<li>左前缀索引：取前面的字符做索引</li>
<li>覆盖索引：从索引中即可取出要查询的数据，性能高</li>
</ul>
</div>
</div>
<div id="outline-container-h:a48789cf-06ad-46b3-9a35-8fb531ad12ba" class="outline-4">
<h4 id="h:a48789cf-06ad-46b3-9a35-8fb531ad12ba">索引结构</h4>
<div class="outline-text-4" id="text-h:a48789cf-06ad-46b3-9a35-8fb531ad12ba">
<p>
参考链接：<a href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html">https://www.cs.usfca.edu/~galles/visualization/Algorithms.html</a>
</p>

<p>
<b>二叉树</b>:
</p>

<p>
参考链接：<a href="https://www.cs.usfca.edu/~galles/visualization/BST.html">https://www.cs.usfca.edu/~galles/visualization/BST.html</a>
</p>

<p>
可能会有不平衡的情况
</p>

<p>
<b>红黑树</b>:
</p>

<p>
参考链接：<a href="https://www.cs.usfca.edu/~galles/visualization/RedBlack.html">https://www.cs.usfca.edu/~galles/visualization/RedBlack.html</a>
</p>

<p>
平衡树
</p>

<p>
<b>B Tree 索引</b>
</p>

<p>
参考链接：<a href="https://www.cs.usfca.edu/~galles/visualization/BTree.html">https://www.cs.usfca.edu/~galles/visualization/BTree.html</a>
</p>

<p>
每次查询时效率可能不一样，时高时低。
</p>

<p>
数据越小，分支越多，层数越低，磁盘IO次数越少；（可以考虑只放编号，占用
空间少，分支多，也就是B+TREE）
</p>

<p>
<b>B+Tree索引</b>
</p>

<p>
参考链接：<a href="https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html">https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html</a>
</p>

<p>
每次查询时效率相同，磁盘IO次数少，索引节点不放数据，叶子节点之间是有关系的
</p>

<p>
B+Tree索引：只有叶子节点放数据，按顺序存储，每一个叶子节点到根结点的距离是相同的；左前缀索引，适合查询范围类的数据
</p>

<p>
博客参考：<a href="https://www.cnblogs.com/cangqinglang/p/15042752.html">https://www.cnblogs.com/cangqinglang/p/15042752.html</a>
</p>

<p>
<b>面试题：InnoDB中一颗B+树可以存放多少行数据？</b>
</p>
<div class="org-src-container">
<pre class="src src-sh">&#20551;&#35774;&#23450;&#20041;&#19968;&#39063;B+&#26641;&#39640;&#24230;&#20026;2&#65292;&#21363;&#19968;&#20010;&#26681;&#33410;&#28857;&#21644;&#33509;&#24178;&#21494;&#23376;&#33410;&#28857;&#12290;&#37027;&#20040;&#36825;&#26869;B+<span style="color: #a0522d;">&#26641;&#30340;&#23384;&#25918;&#24635;&#34892;&#35760;&#24405;&#25968;</span>=&#26681;&#33410;&#28857;&#25351;&#38024;&#25968;*&#21333;&#20010;&#21494;&#23376;&#35760;&#24405;&#34892;&#25968;&#12290;&#36825;&#37324;&#20808;&#35745;&#31639;&#21494;&#23376;&#33410;&#28857;&#65292;B+&#26641;&#20013;&#21333;&#20010;&#21494;&#23376;&#33410;&#28857;&#30340;&#22823;&#23567;&#20026;16K&#65292;&#20551;&#35774;&#27599;&#19968;&#26465;&#30446;&#20026;1K&#65292;&#37027;&#20040;&#35760;&#24405;&#25968;&#21363;&#20026;16(16K/1K=16)&#65292;&#28982;&#21518;&#35745;&#31639;&#38750;&#21494;&#23376;&#33410;&#28857;&#33021;&#22815;&#23384;&#25918;&#22810;&#20010;&#25351;&#38024;&#65292;&#20551;&#35774;&#20027;&#38190;ID&#20026;bigint&#31867;&#22411;&#65292;&#37027;&#20040;&#38271;&#24230;&#20026;8&#23383;&#33410;&#65292;&#32780;&#25351;&#38024;&#22823;&#23567;&#22312;InnoDB&#20013;&#26159;&#35774;&#32622;&#20026;6&#20010;&#23383;&#33410;&#65292;&#36825;&#26679;&#21152;&#36215;&#26469;&#19968;&#20849;&#26159;14&#20010;&#23383;&#33410;&#12290;&#37027;&#20040;&#36890;&#36807;&#39029;&#22823;&#23567;/&#65288;&#20027;&#38190;ID&#22823;&#23567;+&#25351;&#38024;&#22823;&#23567;&#65289;&#65292;&#21363;16384/14=1170&#20010;&#25351;&#38024;&#65292;&#25152;&#20197;&#19968;&#39063;&#39640;&#24230;&#20026;2&#30340;B+&#26641;&#33021;&#23384;&#25918;16*<span style="color: #a0522d;">1170</span>=18720&#26465;&#36825;&#26679;&#30340;&#35760;&#24405;&#12290;&#26681;&#25454;&#36825;&#20010;&#21407;&#29702;&#21487;&#20197;&#31639;&#20986;&#19968;&#39063;&#39640;&#24230;&#20026;3&#30340;B+&#26641;&#21487;&#20197;&#23384;&#25918;16*1170*<span style="color: #a0522d;">1170</span>=21902400&#26465;&#35760;&#24405;&#12290;&#25152;&#20197;&#22312;InnoDB&#20013;B+&#26641;&#39640;&#24230;&#19968;&#33324;&#20026;2-3&#23618;&#65292;&#23427;&#23601;&#33021;&#28385;&#36275;&#21315;&#19975;&#32423;&#30340;&#25968;&#25454;&#23384;&#20648;&#12290;
</pre>
</div>

<p>
<b>可以使用B+Tree索引的查询类型</b>: (假设前提：姓，名，年龄三个字段建立了一个复合索引)
</p>
<ul class="org-ul">
<li>全值匹配：精确所有索引列，如：姓wang，名xiaochun，年龄30</li>
<li>匹配最左前缀：即只使用索引的第一列，如：姓wang</li>
<li>匹配列前缀：只匹配一列值开头部分，如：姓以w开头的</li>
<li>匹配范围值：如：姓ma和姓wang之间</li>
<li>精确匹配某一列并范围匹配另一列：如：姓wang,名以x开头的</li>
<li>只访问索引的查询</li>
</ul>

<p>
<b>B+Tree索引的限制</b> ：
</p>
<ul class="org-ul">
<li><b>如不从最左列开始，则无法使用索引</b> ，如：查找名为xiaochun（%xiaochun%），或姓为g结尾（g%）</li>
<li>不能跳过索引中的列：如：查找姓wang，年龄30的，只能使用索引第一列</li>
</ul>

<p>
<b>特别提示</b>
</p>

<p>
索引列的顺序和查询语句的写法应相匹配，才能更好的利用索引
</p>

<p>
为优化性能，可能需要针对相同的列但顺序不同创建不同的索引来满足不同类型的查询需求
</p>

<p>
<b>Hash索引</b>
</p>

<p>
Hash索引：基于哈希表实现，只有精确匹配索引中的所有列的查询才有效，索引
自身只存储索引列对应的哈希值和数据指针，索引结构紧凑，查询性能好
</p>

<p>
Memory存储引擎支持显式hash索引，InnoDB和MyISAM存储引擎不支持
</p>

<p>
适用场景：只支持等值比较查询，包括=, &lt;=&gt;, IN()
</p>

<p>
<b>不适合使用hash索引的场景</b>
</p>

<ul class="org-ul">
<li>不适用于顺序查询：索引存储顺序的不是值的顺序</li>
<li>不支持模糊匹配</li>
<li>不支持范围查询</li>
<li>不支持部分索引列匹配查找：如A，B列索引，只查询A列索引无效</li>
</ul>

<p>
<b>空间数据索引R-Tree（ Geospatial indexing ）</b>
</p>

<p>
MyISAM支持地理空间索引，可使用任意维度组合查询，使用特有的函数访问，常
用于做地理数据存储，使用不多
</p>

<p>
InnoDB从MySQL5.7之后也开始支持
</p>

<p>
<b>全文索引(FULLTEXT)</b>
</p>

<p>
在文本中查找关键词，而不是直接比较索引中的值，类似搜索引擎
</p>

<p>
InnoDB从MySQL 5.6之后也开始支持
</p>

<p>
<b>聚簇和非聚簇索引，主键和二级索引</b>
</p>



<p>
<b>MyISAM 主索引结构-&#x2013;&#x2014;非聚簇索引</b>
</p>



<p>
<b>冗余和重复索引</b> ：
</p>

<ul class="org-ul">
<li>冗余索引：（A），（A，B）</li>
<li>重复索引：已经有索引，再次建立索引</li>
</ul>
</div>
</div>
<div id="outline-container-h:0ea4c831-3921-4250-9d92-31e2eab497da" class="outline-4">
<h4 id="h:0ea4c831-3921-4250-9d92-31e2eab497da">索引优化</h4>
<div class="outline-text-4" id="text-h:0ea4c831-3921-4250-9d92-31e2eab497da">
<ul class="org-ul">
<li>独立地使用列：尽量避免其参与运算，独立的列指索引列不能是表达式的一部
分，也不能是函数的参数，在where条件中，始终将索引列单独放在比较符号
的一侧，尽量不要在列上进行运算（函数操作和表达式操作）</li>
<li>左前缀索引：构建指定索引字段的左侧的字符数，要通过索引选择性（不重复
的索引值和数据表的记录总数的比值）来评估，尽量使用短索引，如果可以，
应该制定一个前缀长度</li>
<li>多列索引：AND操作时更适合使用多列索引，而非为每个列创建单独的索引</li>
<li>选择合适的索引列顺序：无排序和分组时，将选择性最高放左侧</li>
<li>只要列中含有NULL值，就最好不要在此列设置索引，复合索引如果有NULL值，
此列在使用时也不会使用索引</li>
<li>对于经常在where子句使用的列，最好设置索引</li>
<li>对于有多个列where或者order by子句，应该建立复合索引</li>
<li>对于like语句，以 % 或者 _ 开头的不会使用索引，以 % 结尾会使用索引</li>
<li>尽量不要使用not in和&lt;&gt;操作,虽然可能使用索引,但性能不高</li>
<li>不要使用RLIKE正则表达式会导致索引失效</li>
<li>查询时，能不要_就不用_，尽量写全字段名，比如:select id,name,age from
students;</li>
<li>大部分情况连接效率远大于子查询</li>
<li>在有大量记录的表分页时使用limit</li>
<li>对于经常使用的查询，可以开启查询缓存</li>
<li>多使用explain和profile分析查询语句</li>
<li>查看慢查询日志，找出执行时间长的sql语句优化</li>
</ul>
</div>
</div>
<div id="outline-container-h:1f0ea039-68fc-40f9-a342-647a4a117a8d" class="outline-4">
<h4 id="h:1f0ea039-68fc-40f9-a342-647a4a117a8d">管理索引</h4>
<div class="outline-text-4" id="text-h:1f0ea039-68fc-40f9-a342-647a4a117a8d">
<p>
<b>创建索引</b>
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> [<span style="color: #a020f0;">UNIQUE</span>] INDEX index_name <span style="color: #a020f0;">ON</span> tbl_name (index_col_name[(<span style="color: #a020f0;">length</span>)],...); #uniqe&#21807;&#19968;&#38190;&#32034;&#24341;
<span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">tbl_name</span> <span style="color: #a020f0;">ADD</span> INDEX index_name(index_col_name[(<span style="color: #a020f0;">length</span>)]);
help <span style="color: #a020f0;">CREATE</span> INDEX;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">&gt; create index idx_name on students(name(5)); <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25343;student&#34920;&#20013;name&#30340;&#21069;5&#20010;&#20570;&#20026;&#32034;&#24341;</span>
&gt; show index from student; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#32034;&#24341;</span>
</pre>
</div>

<p>
<b>删除索引</b>
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DROP</span> INDEX index_name <span style="color: #a020f0;">ON</span> tbl_name;
<span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">tbl_name</span> <span style="color: #a020f0;">DROP</span> INDEX index_name(index_col_name);
</pre>
</div>

<p>
<b>查看索引</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW INDEXES <span style="color: #a020f0;">FROM</span> [db_name.]tbl_name;
</pre>
</div>

<p>
<b>优化表空间</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">OPTIMIZE <span style="color: #a020f0;">TABLE</span> tb_name;
</pre>
</div>

<p>
<b>查看索引的使用</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SET</span> <span style="color: #a020f0;">GLOBAL</span> userstat=1;  #&#32479;&#35745;&#32034;&#24341;&#30340;&#21033;&#29992;&#24773;&#20917; 
SHOW INDEX_STATISTICS;
</pre>
</div>

<p>
范例:KEY上有值代表有索引
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [hellodb]&gt; <span style="color: #a020f0;">SET</span> <span style="color: #a020f0;">GLOBAL</span> userstat=1;
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.000 sec)

MariaDB [hellodb]&gt; SHOW INDEX_STATISTICS;
Empty <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">desc</span> students;
+<span style="color: #b22222;">-----------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
| Field     | <span style="color: #a020f0;">Type</span>                | <span style="color: #a020f0;">Null</span> | <span style="color: #a020f0;">Key</span> | <span style="color: #a020f0;">Default</span> | Extra          |
+<span style="color: #b22222;">-----------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
| StuID     | <span style="color: #228b22;">int</span>(10) unsigned    | <span style="color: #a020f0;">NO</span>   | PRI | <span style="color: #a020f0;">NULL</span>    | auto_increment |
| <span style="color: #a020f0;">Name</span>      | <span style="color: #228b22;">varchar</span>(50)         | <span style="color: #a020f0;">NO</span>   |     | <span style="color: #a020f0;">NULL</span>    |                |
| Age       | tinyint(3) unsigned | <span style="color: #a020f0;">NO</span>   |     | <span style="color: #a020f0;">NULL</span>    |                |
| Gender    | enum(<span style="color: #8b2252;">'F'</span>,<span style="color: #8b2252;">'M'</span>)       | <span style="color: #a020f0;">NO</span>   |     | <span style="color: #a020f0;">NULL</span>    |                |
| ClassID   | tinyint(3) unsigned | YES  |     | <span style="color: #a020f0;">NULL</span>    |                |
| TeacherID | <span style="color: #228b22;">int</span>(10) unsigned    | YES  |     | <span style="color: #a020f0;">NULL</span>    |                |
+<span style="color: #b22222;">-----------</span><span style="color: #b22222;">+---------------------+------+-----+---------+----------------+</span>
6 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; show indexes <span style="color: #a020f0;">from</span> students\G;
************************* 1. <span style="color: #228b22;">row</span> ***************************
        <span style="color: #a020f0;">Table</span>: students
   Non_unique: 0
     Key_name: <span style="color: #a020f0;">PRIMARY</span>
 Seq_in_index: 1
  <span style="color: #a020f0;">Column_name</span>: StuID
    <span style="color: #a020f0;">Collation</span>: A
  <span style="color: #483d8b;">Cardinality</span>: 25
     Sub_part: <span style="color: #a020f0;">NULL</span>
       Packed: <span style="color: #a020f0;">NULL</span>
         <span style="color: #a020f0;">Null</span>: 
   Index_type: BTREE
      Comment: 
Index_comment: 
1 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; SHOW INDEX_STATISTICS;
Empty <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> stuid=10;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+--------------+-----+--------+---------+-----------+</span>
| StuID | <span style="color: #a020f0;">Name</span>         | Age | Gender | ClassID | TeacherID |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+--------------+-----+--------+---------+-----------+</span>
|    10 | Yue Lingshan |  19 | F      |       3 |      <span style="color: #a020f0;">NULL</span> |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+--------------+-----+--------+---------+-----------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; show INDEX_STATISTICS;
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+------------+------------+-----------+</span>
| Table_schema | <span style="color: #a020f0;">Table_name</span> | Index_name | Rows_read |
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+------------+------------+-----------+</span>
| hellodb      | students   | <span style="color: #a020f0;">PRIMARY</span>    |         1 |
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+------------+------------+-----------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> stuid=20;
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-----------+-----+--------+---------+-----------+</span>
| StuID | <span style="color: #a020f0;">Name</span>      | Age | Gender | ClassID | TeacherID |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-----------+-----+--------+---------+-----------+</span>
|    20 | Diao Chan |  19 | F      |       7 |      <span style="color: #a020f0;">NULL</span> |
+<span style="color: #b22222;">-------</span><span style="color: #b22222;">+-----------+-----+--------+---------+-----------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; show INDEX_STATISTICS;
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+------------+------------+-----------+</span>
| Table_schema | <span style="color: #a020f0;">Table_name</span> | Index_name | Rows_read |
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+------------+------------+-----------+</span>
| hellodb      | students   | <span style="color: #a020f0;">PRIMARY</span>    |         2 |
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+------------+------------+-----------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:84a7c1fa-68d6-4b34-aa18-1f4d327eafec" class="outline-4">
<h4 id="h:84a7c1fa-68d6-4b34-aa18-1f4d327eafec">EXPLAIN 工具</h4>
<div class="outline-text-4" id="text-h:84a7c1fa-68d6-4b34-aa18-1f4d327eafec">
<p>
可以通过EXPLAIN来分析索引的有效性,获取查询执行计划信息，用来查看查询优化器如何执行查询
</p>

<p>
参考资料：
<a href="https://dev.mysql.com/doc/refman/5.7/en/explain-output.html">https://dev.mysql.com/doc/refman/5.7/en/explain-output.html</a>
</p>

<p>
语法：
</p>

<div class="org-src-container">
<pre class="src src-sql">EXPLAIN <span style="color: #a020f0;">SELECT</span> clause
</pre>
</div>

<p>
*EXPLAIN输出信息说明*：
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">列名</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">id</td>
<td class="org-left">执行编号，标识select所属的行。如果在语句中没子查询或关联查询，只有唯一的select，每行都将显示1。否则，内层的select语句一般会顺序编号，对应于其在原始语句中的位置</td>
</tr>

<tr>
<td class="org-left">select_type</td>
<td class="org-left">简单查询：SIMPLE。复杂查询：PRIMARY(最外面的SELECT)、DERIVED(用于FROM中的子查询)、UNION(UNION语句的第一个之后的SELECT语句)、UNION RESULT(匿名临时表)、SUBQUERY(简单子查询)</td>
</tr>

<tr>
<td class="org-left">table</td>
<td class="org-left">访问引用哪个表（引用某个查询，如“derived3”）</td>
</tr>

<tr>
<td class="org-left">type</td>
<td class="org-left">关联类型或访问类型，即MySQL决定的如何去查询表中的行的方式</td>
</tr>

<tr>
<td class="org-left">possible_keys</td>
<td class="org-left">查询可能会用到的索引</td>
</tr>

<tr>
<td class="org-left">key</td>
<td class="org-left">显示mysql决定采用哪个索引来优化查询</td>
</tr>

<tr>
<td class="org-left">key_len</td>
<td class="org-left">显示mysql在索引里使用的字节数</td>
</tr>

<tr>
<td class="org-left">ref</td>
<td class="org-left">根据索引返回表中匹配某单个值的所有行</td>
</tr>

<tr>
<td class="org-left">rows</td>
<td class="org-left">为了找到所需的行而需要读取的行数，估算值，不精确。通过把所有rows列值相乘，可粗略估算整个查询会检查的行数</td>
</tr>

<tr>
<td class="org-left">Extra</td>
<td class="org-left">额外信息</td>
</tr>
</tbody>
</table>

<p>
额外信息：
</p>
<ul class="org-ul">
<li>Using index：MySQL将会使用覆盖索引，以避免访问表</li>
<li>Using where：MySQL服务器将在存储引擎检索后，再进行一次过滤</li>
<li>Using temporary：MySQL对结果排序时会使用临时表</li>
<li>Using filesort：对结果使用一个外部索引排序</li>
</ul>

<p>
说明：
</p>

<p>
type显示的是访问类型，是较为重要的一个指标，结果值从好到坏依次是：NULL
&gt;system &gt; const &gt;eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge
&gt;unique_subquery &gt; index_subquery &gt; range &gt;index &gt; ALL，一般来说，得保
证查询至少达到range级别，最好能达到ref
</p>

<div class="org-src-container">
<pre class="src src-sh">NULL &gt;system &gt; const &gt;eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt;unique_subquery &gt; index_subquery &gt; range &gt;index &gt; ALL //&#26368;&#22909;&#21040;&#26368;&#24046;
&#22791;&#27880;&#65306;&#25484;&#25569;&#20197;&#19979;10&#31181;&#24120;&#35265;&#30340;&#21363;&#21487;
NULL &gt;system &gt; const &gt;eq_ref &gt;ref &gt; ref_or_null &gt; index_merge &gt;range &gt;index &gt; ALL
</pre>
</div>


<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">All</td>
<td class="org-left">最坏的情况,全表扫描</td>
</tr>

<tr>
<td class="org-left">index</td>
<td class="org-left">和全表扫描一样。只是扫描表的时候按照索引次序进行而不是行。主要优点就是避免了排序, 但是开销仍然非常大。如在Extra列看到Using index，说明正在使用覆盖索引，只扫描索引的数据，它比按索引次序全表扫描的开销要小很多</td>
</tr>

<tr>
<td class="org-left">range</td>
<td class="org-left">范围扫描，一个有限制的索引扫描。key 列显示使用了哪个索引。当使用=、 &lt;&gt;、&gt;、&gt;=、&lt;、&lt;=、IS NULL、&lt;=&gt;、BETWEEN 或者 IN 操作符,用常量比较关键字列时,可以使用 range</td>
</tr>

<tr>
<td class="org-left">ref</td>
<td class="org-left">一种索引访问，它返回所有匹配某个单个值的行。此类索引访问只有当使用非唯一性索引或唯一性索引非唯一性前缀时才会发生。这个类型跟eq_ref不同的是，它用在关联操作只使用了索引的最左前缀，或者索引不是UNIQUE和PRIMARY KEY。ref可以用于使用=或&lt;=&gt;操作符的带索引的列。</td>
</tr>

<tr>
<td class="org-left">eq_ref</td>
<td class="org-left">最多只返回一条符合条件的记录。使用唯一性索引或主键查找时会发生 （高效）</td>
</tr>

<tr>
<td class="org-left">const</td>
<td class="org-left">当确定最多只会有一行匹配的时候，MySQL优化器会在查询前读取它而且只读取一次，因此非常快。当主键放入where子句时，mysql把这个查询转为一个常量（高效）</td>
</tr>

<tr>
<td class="org-left">system</td>
<td class="org-left">这是const连接类型的一种特例，表仅有一行满足条件。</td>
</tr>

<tr>
<td class="org-left">Null</td>
<td class="org-left">意味着mysql能在优化阶段分解查询语句，在执行阶段甚至用不到访问表或索引（高效）</td>
</tr>
</tbody>
</table>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [hellodb]&gt; explain <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> stuid <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> (5,10,20);
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+------+---------------+------+---------+------+------+-------------+</span>
| id   | select_type | <span style="color: #a020f0;">table</span>    | <span style="color: #a020f0;">type</span> | possible_keys | <span style="color: #a020f0;">key</span>  | key_len | <span style="color: #228b22;">ref</span>  | <span style="color: #a020f0;">rows</span> | Extra       |
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+------+---------------+------+---------+------+------+-------------+</span>
|    1 | <span style="color: #a020f0;">SIMPLE</span>      | students | <span style="color: #a020f0;">ALL</span>  | <span style="color: #a020f0;">PRIMARY</span>       | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>    | <span style="color: #a020f0;">NULL</span> |   25 | <span style="color: #a020f0;">Using</span> <span style="color: #a020f0;">where</span> |
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+------+---------------+------+---------+------+------+-------------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; explain <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> stuid &lt;&gt; 10;
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+-------+---------------+---------+---------+------+------+-------------+</span>
| id   | select_type | <span style="color: #a020f0;">table</span>    | <span style="color: #a020f0;">type</span>  | possible_keys | <span style="color: #a020f0;">key</span>     | key_len | <span style="color: #228b22;">ref</span>  | <span style="color: #a020f0;">rows</span> | Extra       |
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+-------+---------------+---------+---------+------+------+-------------+</span>
|    1 | <span style="color: #a020f0;">SIMPLE</span>      | students | range | <span style="color: #a020f0;">PRIMARY</span>       | <span style="color: #a020f0;">PRIMARY</span> | 4       | <span style="color: #a020f0;">NULL</span> |   24 | <span style="color: #a020f0;">Using</span> <span style="color: #a020f0;">where</span> |
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+-------+---------------+---------+---------+------+------+-------------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; explain <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> age &gt; (<span style="color: #a020f0;">select</span> <span style="color: #483d8b;">avg</span>(age) <span style="color: #a020f0;">from</span> teachers);
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+------+---------------+------+---------+------+------+-------------+</span>
| id   | select_type | <span style="color: #a020f0;">table</span>    | <span style="color: #a020f0;">type</span> | possible_keys | <span style="color: #a020f0;">key</span>  | key_len | <span style="color: #228b22;">ref</span>  | <span style="color: #a020f0;">rows</span> | Extra       |
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+------+---------------+------+---------+------+------+-------------+</span>
|    1 | <span style="color: #a020f0;">PRIMARY</span>     | students | <span style="color: #a020f0;">ALL</span>  | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>    | <span style="color: #a020f0;">NULL</span> |   25 | <span style="color: #a020f0;">Using</span> <span style="color: #a020f0;">where</span> |
|    2 | SUBQUERY    | teachers | <span style="color: #a020f0;">ALL</span>  | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>    | <span style="color: #a020f0;">NULL</span> |    4 |             |
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+------+---------------+------+---------+------+------+-------------+</span>
2 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">create</span> index idx_age <span style="color: #a020f0;">on</span> students(age);
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.007 sec)
Records: 0  Duplicates: 0  Warnings: 0

MariaDB [hellodb]&gt; explain <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> age &gt; (<span style="color: #a020f0;">select</span> <span style="color: #483d8b;">avg</span>(age) <span style="color: #a020f0;">from</span> teachers);
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+-------+---------------+---------+---------+------+------+-------------+</span>
| id   | select_type | <span style="color: #a020f0;">table</span>    | <span style="color: #a020f0;">type</span>  | possible_keys | <span style="color: #a020f0;">key</span>     | key_len | <span style="color: #228b22;">ref</span>  | <span style="color: #a020f0;">rows</span> | Extra       |
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+-------+---------------+---------+---------+------+------+-------------+</span>
|    1 | <span style="color: #a020f0;">PRIMARY</span>     | students | range | idx_age       | idx_age | 1       | <span style="color: #a020f0;">NULL</span> |    1 | <span style="color: #a020f0;">Using</span> <span style="color: #a020f0;">where</span> |
|    2 | SUBQUERY    | teachers | <span style="color: #a020f0;">ALL</span>   | <span style="color: #a020f0;">NULL</span>          | <span style="color: #a020f0;">NULL</span>    | <span style="color: #a020f0;">NULL</span>    | <span style="color: #a020f0;">NULL</span> |    4 |             |
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+-------+---------------+---------+---------+------+------+-------------+</span>
2 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
</pre>
</div>

<p>
范例:创建索引和使用索引
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [hellodb]&gt; <span style="color: #a020f0;">create</span> index idx_name <span style="color: #a020f0;">on</span> students(<span style="color: #a020f0;">name</span>(10));
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.009 sec)
Records: 0 Duplicates: 0 Warnings: 0

MariaDB [hellodb]&gt; show indexes <span style="color: #a020f0;">from</span> students\G;
************************* 1. <span style="color: #228b22;">row</span> ***************************
        <span style="color: #a020f0;">Table</span>: students
   Non_unique: 0
     Key_name: <span style="color: #a020f0;">PRIMARY</span>
 Seq_in_index: 1
  <span style="color: #a020f0;">Column_name</span>: StuID
    <span style="color: #a020f0;">Collation</span>: A
  <span style="color: #483d8b;">Cardinality</span>: 25
     Sub_part: <span style="color: #a020f0;">NULL</span>
       Packed: <span style="color: #a020f0;">NULL</span>
         <span style="color: #a020f0;">Null</span>: 
   Index_type: BTREE
      Comment: 
Index_comment: 
************************* 2. <span style="color: #228b22;">row</span> ***************************
        <span style="color: #a020f0;">Table</span>: students
   Non_unique: 1
     Key_name: idx_name
 Seq_in_index: 1
  <span style="color: #a020f0;">Column_name</span>: <span style="color: #a020f0;">Name</span>
    <span style="color: #a020f0;">Collation</span>: A
  <span style="color: #483d8b;">Cardinality</span>: 25
     Sub_part: 10
       Packed: <span style="color: #a020f0;">NULL</span>
         <span style="color: #a020f0;">Null</span>: 
   Index_type: BTREE
      Comment: 
Index_comment:  
2 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)


MariaDB [hellodb]&gt; explain <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> <span style="color: #a020f0;">name</span> <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'w%'</span>;
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+-------+---------------+----------+---------+------+------+-------------+</span>
| id   | select_type | <span style="color: #a020f0;">table</span>    | <span style="color: #a020f0;">type</span>  | possible_keys | <span style="color: #a020f0;">key</span>      | key_len | <span style="color: #228b22;">ref</span>  | <span style="color: #a020f0;">rows</span> | Extra       |
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+-------+---------------+----------+---------+------+------+-------------+</span>
|    1 | <span style="color: #a020f0;">SIMPLE</span>      | students | range | idx_name      | idx_name | 32      | <span style="color: #a020f0;">NULL</span> |    1 | <span style="color: #a020f0;">Using</span> <span style="color: #a020f0;">where</span> |
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+-------+---------------+----------+---------+------+------+-------------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

MariaDB [hellodb]&gt; explain <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> students <span style="color: #a020f0;">where</span> <span style="color: #a020f0;">name</span> <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'x%'</span>;
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+------+---------------+------+---------+------+------+-------------+</span>
| id   | select_type | <span style="color: #a020f0;">table</span>    | <span style="color: #a020f0;">type</span> | possible_keys | <span style="color: #a020f0;">key</span>  | key_len | <span style="color: #228b22;">ref</span>  | <span style="color: #a020f0;">rows</span> | Extra       |
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+------+---------------+------+---------+------+------+-------------+</span>
|    1 | <span style="color: #a020f0;">SIMPLE</span>      | students | <span style="color: #a020f0;">ALL</span>  | idx_name      | <span style="color: #a020f0;">NULL</span> | <span style="color: #a020f0;">NULL</span>    | <span style="color: #a020f0;">NULL</span> |   25 | <span style="color: #a020f0;">Using</span> <span style="color: #a020f0;">where</span> |
+<span style="color: #b22222;">------</span><span style="color: #b22222;">+-------------+----------+------+---------------+------+---------+------+------+-------------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4ef33225-dcb1-48d2-8bec-e8ebea91d41d" class="outline-4">
<h4 id="h:4ef33225-dcb1-48d2-8bec-e8ebea91d41d">使用profile工具</h4>
<div class="outline-text-4" id="text-h:4ef33225-dcb1-48d2-8bec-e8ebea91d41d">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25171;&#24320;&#21518;&#65292;&#20250;&#26174;&#31034;&#35821;&#21477;&#25191;&#34892;&#35814;&#32454;&#30340;&#36807;&#31243;</span>
<span style="color: #483d8b;">set</span> profiling = ON;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#35821;&#21477;&#65292;&#27880;&#24847;&#32467;&#26524;&#20013;&#30340;query_id&#20540;</span>
show profiles;


mysql&gt; show profiles;
+----------+------------+--------------------+
| Query_ID | Duration   | Query              |
+----------+------------+--------------------+
|        1 | 0.00013450 | <span style="color: #a020f0;">select</span> @@profiling |
|        2 | 0.00020450 | <span style="color: #a020f0;">select</span> * from user |
+----------+------------+--------------------+
2 rows<span style="color: #a020f0;"> in</span> set, 1 warning (0.00 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#35821;&#21477;&#35814;&#32454;&#25191;&#34892;&#27493;&#39588;&#21644;&#26102;&#38271;</span>
show profile for query <span style="color: #b22222;">#</span>

mysql&gt; show profile for query 2;
+----------------------+----------+
| Status               | Duration |
+----------------------+----------+
| starting             | 0.000053 |
| checking permissions | 0.000007 |
| Opening tables       | 0.000018 |
| init                 | 0.000015 |
| System lock          | 0.000006 |
| optimizing           | 0.000004 |
| statistics           | 0.000011 |
| preparing            | 0.000009 |
| executing            | 0.000003 |
| Sending data         | 0.000038 |
| end                  | 0.000003 |
| query end            | 0.000006 |
| closing tables       | 0.000006 |
| freeing items        | 0.000015 |
| cleaning up          | 0.000011 |
+----------------------+----------+
15 rows<span style="color: #a020f0;"> in</span> set, 1 warning (0.00 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;cpu&#20351;&#29992;&#24773;&#20917;</span>
show profile cpu for query <span style="color: #b22222;">#</span>

mysql&gt; show profile cpu  for query 2;
+----------------------+----------+----------+------------+
| Status               | Duration | CPU_user | CPU_system |
+----------------------+----------+----------+------------+
| starting             | 0.000053 | 0.000000 |   0.000047 |
| checking permissions | 0.000007 | 0.000000 |   0.000007 |
| Opening tables       | 0.000018 | 0.000000 |   0.000018 |
| init                 | 0.000015 | 0.000000 |   0.000015 |
| System lock          | 0.000006 | 0.000000 |   0.000006 |
| optimizing           | 0.000004 | 0.000000 |   0.000005 |
| statistics           | 0.000011 | 0.000000 |   0.000010 |
| preparing            | 0.000009 | 0.000000 |   0.000009 |
| executing            | 0.000003 | 0.000000 |   0.000003 |
| Sending data         | 0.000038 | 0.000000 |   0.000037 |
| end                  | 0.000003 | 0.000000 |   0.000003 |
| query end            | 0.000006 | 0.000000 |   0.000006 |
| closing tables       | 0.000006 | 0.000000 |   0.000006 |
| freeing items        | 0.000015 | 0.000000 |   0.000015 |
| cleaning up          | 0.000011 | 0.000000 |   0.000012 |
+----------------------+----------+----------+------------+
15 rows<span style="color: #a020f0;"> in</span> set, 1 warning (0.00 sec)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ed57c9e8-2b90-46e5-a398-650a37fe8b21" class="outline-3">
<h3 id="h:ed57c9e8-2b90-46e5-a398-650a37fe8b21">并发控制</h3>
<div class="outline-text-3" id="text-h:ed57c9e8-2b90-46e5-a398-650a37fe8b21">
</div>
<div id="outline-container-h:56cc3ebc-25d5-446b-9d1e-291459941522" class="outline-4">
<h4 id="h:56cc3ebc-25d5-446b-9d1e-291459941522">锁机制</h4>
<div class="outline-text-4" id="text-h:56cc3ebc-25d5-446b-9d1e-291459941522">
<p>
说明：锁机制太严格会造成并发性的损失
</p>

<p>
锁类型：
</p>
<ul class="org-ul">
<li>读锁：共享锁，也称为 S 锁 ,只读不可写（包括当前事务） ，多个读互不阻塞; 维护阶段会用到</li>
<li>写锁：独占锁，排它锁，也称为 X 锁，写锁会阻塞其它事务（不包括当前事务）的读和写</li>
<li>S 锁和 S 锁是兼容的，X 锁和其它锁都 <b>不兼容</b>
<ul class="org-ul">
<li>举个例子，事务 T1获取了一个行 r1 的 S 锁，另外事务 T2 可以立即获得
行 r1 的 S 锁，此时 T1和 T2 共同获得行 r1 的 S 锁，此种情况称为*锁
兼容*，但是另外一个事务 T2此时如果想获得行 r1 的 X 锁，则必须等待
T1 对行锁的释放，此种情况也成为 <b>锁冲突</b></li>
</ul></li>
</ul>

<p>
锁粒度：
</p>

<ul class="org-ul">
<li>表级锁：MyISAM</li>
<li>行级锁：InnodB</li>
</ul>

<p>
实现
</p>

<ul class="org-ul">
<li>存储引擎：自行实现其锁策略和锁粒度</li>
<li>服务器级：实现了锁，表级锁，用户可显式请求</li>
</ul>

<p>
分类：
</p>

<ul class="org-ul">
<li>隐式锁：由存储引擎自动施加锁（MyISAM）</li>
<li>显式锁：用户手动请求</li>
</ul>

<p>
锁策略：在锁粒度及数据安全性寻求的平衡机制
</p>
</div>
</div>
<div id="outline-container-h:4867302c-4591-4888-9c38-6a80978ef68a" class="outline-4">
<h4 id="h:4867302c-4591-4888-9c38-6a80978ef68a">显式使用锁</h4>
<div class="outline-text-4" id="text-h:4867302c-4591-4888-9c38-6a80978ef68a">
<p>
帮助:<a href="https://mariadb.com/kb/en/lock-tables/">https://mariadb.com/kb/en/lock-tables/</a>
</p>

<p>
加锁
</p>

<div class="org-src-container">
<pre class="src src-sh">LOCK TABLES tbl_name [[AS] alias] lock_type [, tbl_name [[AS] alias]
lock_type] ...

lock_type:
READ  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35835;&#38145;</span>
WRITE <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20889;&#38145;</span>
</pre>
</div>

<p>
解锁
</p>

<div class="org-src-container">
<pre class="src src-sql">UNLOCK TABLES
</pre>
</div>

<p>
关闭正在打开的表（清除查询缓存），通常在备份前加全局读锁
</p>

<div class="org-src-container">
<pre class="src src-sh">FLUSH TABLES [tb_name[,...]] [WITH READ LOCK]
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#29992;&#25143;&#26412;&#36136;&#26159;&#20462;&#25913;&#25968;&#25454;&#24211;&#65292;&#20462;&#25913;user&#34920;&#65292;&#25925;&#20063;&#19981;&#33021;&#25191;&#34892;&#25104;&#21151;</span>
</pre>
</div>

<p>
查询时加写或读锁
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> clause [<span style="color: #a020f0;">FOR</span> <span style="color: #a020f0;">UPDATE</span> | LOCK <span style="color: #a020f0;">IN</span> SHARE MODE]
</pre>
</div>

<p>
范例: 加读锁
</p>

<div class="org-src-container">
<pre class="src src-sh">mysql&gt; lock tables students read ;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; update students set <span style="color: #a0522d;">classid</span>=2 where <span style="color: #a0522d;">stuid</span>=24;
ERROR 1099 (HY000): Table <span style="color: #8b2252;">'students'</span> was locked with a READ lock and can<span style="color: #8b2252;">'t be updated</span>
<span style="color: #8b2252;">mysql&gt; unlock tables ;</span>

<span style="color: #8b2252;">mysql&gt; update students set classid=2 where stuid=24;</span>
<span style="color: #8b2252;">Query OK, 1 row affected (1 min 45.52 sec)</span>
<span style="color: #8b2252;">Rows matched: 1 Changed: 1 Warnings: 0</span>
</pre>
</div>

<p>
范例: 同时在两个终端对同一行记录修改
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#26102;&#23545;&#21516;&#19968;&#34892;&#35760;&#24405;&#25191;&#34892;update</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#31532;&#19968;&#32456;&#31471;&#25552;&#31034;1&#34892;&#25104;&#21151;</span>
MariaDB [hellodb]&gt; update students set <span style="color: #a0522d;">classid</span>=1 where <span style="color: #a0522d;">stuid</span>=24;
Query OK, 1 row affected (0.002 sec)
Rows matched: 1 Changed: 1 Warnings: 0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#31532;&#20108;&#32456;&#31471;&#25552;&#31034;0&#34892;&#20462;&#25913;</span>
MariaDB [hellodb]&gt; update students set <span style="color: #a0522d;">classid</span>=1 where <span style="color: #a0522d;">stuid</span>=24;
Query OK, 0 rows affected (0.000 sec)
Rows matched: 1 Changed: 0 Warnings: 0
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a52b3615-195e-418a-97e3-558ebaf95d0c" class="outline-4">
<h4 id="h:a52b3615-195e-418a-97e3-558ebaf95d0c">事务</h4>
<div class="outline-text-4" id="text-h:a52b3615-195e-418a-97e3-558ebaf95d0c">
<p>
事务Transactions：一组原子性的SQL语句，或一个独立工作单元
</p>

<p>
事务日志：记录事务信息，实现undo,redo等故障恢复功能 ；
</p>

<p>
说明：事务日志会循环覆盖
</p>
</div>
<div id="outline-container-h:f714fe44-8c27-4e41-85a4-f0896aab06a1" class="outline-5">
<h5 id="h:f714fe44-8c27-4e41-85a4-f0896aab06a1">事务特性</h5>
<div class="outline-text-5" id="text-h:f714fe44-8c27-4e41-85a4-f0896aab06a1">
<p>
*ACID特性*：
</p>

<ul class="org-ul">
<li>A：atomicity原子性；整个事务中的所有操作要么全部成功执行，要么全部失败后回滚</li>
<li>C：consistency一致性；数据库总是从一个一致性状态转换为另一个一致性状态。类似于能量守恒定律。</li>
<li>I：Isolation隔离性；一个事务所做出的操作在提交之前，是不能为其它事务所见；隔离有多种隔离级别，实现并发</li>
<li>D：durability持久性；一旦事务提交，其所做的修改会永久保存于数据库中</li>
</ul>

<p>
<b>Transaction生命周期</b>
</p>


<figure id="org5e6a13e">
<img src="./images/Snipaste_2023-05-12_22-24-27.png" alt="Snipaste_2023-05-12_22-24-27.png" width="60%">

</figure>
</div>
</div>
<div id="outline-container-h:ab416fe1-5ac4-49f5-8e3a-0c674ebacc32" class="outline-5">
<h5 id="h:ab416fe1-5ac4-49f5-8e3a-0c674ebacc32">管理事务</h5>
<div class="outline-text-5" id="text-h:ab416fe1-5ac4-49f5-8e3a-0c674ebacc32">
<p>
<b>显式启动事务</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"># &#20197;&#19979;&#20219;&#24847;&#19968;&#20010;
<span style="color: #a020f0;">BEGIN</span>
<span style="color: #a020f0;">BEGIN</span> <span style="color: #a020f0;">WORK</span>
<span style="color: #a020f0;">START</span> <span style="color: #a020f0;">TRANSACTION</span>
</pre>
</div>

<p>
*结束事务*：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#20132;&#65292;&#30456;&#24403;&#20110;vi&#20013;&#30340;wq&#20445;&#23384;&#36864;&#20986;</span>
COMMIT

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22238;&#28378;&#65292;&#30456;&#24403;&#20110;vi&#20013;&#30340;q!&#19981;&#20445;&#23384;&#36864;&#20986;</span>
ROLLBACK
</pre>
</div>

<p>
注意：只有事务型存储引擎中的DML语句方能支持此类操作
</p>

<p>
*自动提交*：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">set</span> <span style="color: #a0522d;">autocommit</span>={1|0}  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33258;&#21160;&#25552;&#20132;&#26159;1</span>
</pre>
</div>

<p>
默认为1，为0时设为非自动提交
建议：显式请求和提交事务，而不要使用“自动提交”功能
</p>

<p>
<b>事务支持保存点</b>
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SAVEPOINT</span> identifier
<span style="color: #a020f0;">ROLLBACK</span> [<span style="color: #a020f0;">WORK</span>] <span style="color: #a020f0;">TO</span> [<span style="color: #a020f0;">SAVEPOINT</span>] identifier
RELEASE <span style="color: #a020f0;">SAVEPOINT</span> identifier
</pre>
</div>

<p>
<b>查看事务：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#27491;&#22312;&#36827;&#34892;&#30340;&#20107;&#21153;</span>
SELECT * FROM INFORMATION_SCHEMA.INNODB_TRX;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#38145;&#23450;&#30340;&#20107;&#21153;</span>
SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#31561;&#38145;&#30340;&#20107;&#21153;</span>
SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS;
</pre>
</div>

<p>
<b>死锁：</b>
</p>

<p>
两个或多个事务在同一资源相互占用，并请求锁定对方占用的资源的状态。
</p>


<p>
范例：找到未完成的导致阻塞的事务
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#31532;&#19968;&#20250;&#35805;&#20013;&#25191;&#34892;</span>
MariaDB [hellodb]&gt; begin;
MariaDB [hellodb]&gt; update teachers set <span style="color: #a0522d;">age</span>=25;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#31532;&#20108;&#20010;&#20250;&#35805;&#20013;&#25191;&#34892;</span>
MariaDB [hellodb]&gt; update teachers set <span style="color: #a0522d;">age</span>=30;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#31532;&#19977;&#20010;&#20250;&#35805;&#20013;&#25191;&#34892;</span>
MariaDB [hellodb]&gt; show engine innodb status;
...&#30465;&#30053;...
---TRANSACTION 2384, ACTIVE 162 sec
3 lock struct(s), heap size 1136, 7 row lock(s), undo log entries 4
MySQL thread id 16, OS thread handle 140653843576576, query id 300158 localhost root 
...&#30465;&#30053;...

MariaDB [hellodb]&gt; select * from information_schema.innodb_locks;
+-------------+-------------+-----------+-----------+----------------------+------------+------------+-----------+----------+-----------+
| lock_id     | lock_trx_id | lock_mode | lock_type | lock_table           | lock_index | lock_space | lock_page | lock_rec | lock_data |
+-------------+-------------+-----------+-----------+----------------------+------------+------------+-----------+----------+-----------+
| 2394:25:3:2 | 2394        | X         | RECORD    | <span style="color: #ff00ff;">`hellodb`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`teachers`</span> | PRIMARY    |         25 |         3 |        2 | 1         |
| 2384:25:3:2 | 2384        | X         | RECORD    | <span style="color: #ff00ff;">`hellodb`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`teachers`</span> | PRIMARY    |         25 |         3 |        2 | 1         |
+-------------+-------------+-----------+-----------+----------------------+------------+------------+-----------+----------+-----------+
2 rows<span style="color: #a020f0;"> in</span> set (0.002 sec)

MariaDB [hellodb]&gt; select * from information_schema.innodb_lock_waits;
+-------------------+-------------------+-----------------+------------------+
| requesting_trx_id | requested_lock_id | blocking_trx_id | blocking_lock_id |
+-------------------+-------------------+-----------------+------------------+
| 2395              | 2395:25:3:2       | 2384            | 2384:25:3:2      |
+-------------------+-------------------+-----------------+------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#27491;&#22312;&#36827;&#34892;&#30340;&#20107;&#21153;</span>
MariaDB [hellodb]&gt; select * from information_schema.innodb_trx\G;
************************* 1. row ***************************
                    trx_id: 2395
                 trx_state: LOCK WAIT
               trx_started: 2020-06-11 14:23:26
     trx_requested_lock_id: 2395:25:3:2
          trx_wait_started: 2020-06-11 14:23:26
                trx_weight: 2
       trx_mysql_thread_id: 18                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32447;&#31243;ID</span>
                 trx_query: update teachers set <span style="color: #a0522d;">age</span>=30
       trx_operation_state: starting index read
         trx_tables_in_use: 1
         trx_tables_locked: 1
          trx_lock_structs: 2
     trx_lock_memory_bytes: 1136
           trx_rows_locked: 1
         trx_rows_modified: 0
   trx_concurrency_tickets: 0
       trx_isolation_level: REPEATABLE READ
         trx_unique_checks: 1
    trx_foreign_key_checks: 1
trx_last_foreign_key_error: NULL
          trx_is_read_only: 0
trx_autocommit_non_locking: 0
************************* 2. row ***************************
                    trx_id: 2384
                 trx_state: RUNNING
               trx_started: 2020-06-11 14:18:39
     trx_requested_lock_id: NULL
          trx_wait_started: NULL
                trx_weight: 7
       trx_mysql_thread_id: 16                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32447;&#31243;ID</span>
                 trx_query: NULL
       trx_operation_state: NULL
         trx_tables_in_use: 0
         trx_tables_locked: 1
          trx_lock_structs: 3
     trx_lock_memory_bytes: 1136
           trx_rows_locked: 7
         trx_rows_modified: 4
   trx_concurrency_tickets: 0
       trx_isolation_level: REPEATABLE READ
         trx_unique_checks: 1
    trx_foreign_key_checks: 1
trx_last_foreign_key_error: NULL
          trx_is_read_only: 0
trx_autocommit_non_locking: 0
2 rows<span style="color: #a020f0;"> in</span> set (0.001 sec)


MariaDB [hellodb]&gt; show processlist;
+----+-------------+-----------+---------+---------+-------+--------------------------+----------------------------+----------+
| Id | User        | Host      | db      | Command | Time  | State                    | Info                       | Progress |
+----+-------------+-----------+---------+---------+-------+--------------------------+----------------------------+----------+
|  3 | system user |           | NULL    | Daemon  |  NULL | InnoDB purge worker      | NULL                       |    0.000 |
|  2 | system user |           | NULL    | Daemon  |  NULL | InnoDB purge coordinator | NULL                       |    0.000 |
|  1 | system user |           | NULL    | Daemon  |  NULL | InnoDB purge worker      | NULL                       |    0.000 |
|  4 | system user |           | NULL    | Daemon  |  NULL | InnoDB purge worker      | NULL                       |    0.000 |
|  5 | system user |           | NULL    | Daemon  |  NULL | InnoDB shutdown handler  | NULL                       |    0.000 |
|  9 | root        | localhost | hellodb | Sleep   | 13312 |                          | NULL                       |    0.000 |
| 11 | root        | localhost | hellodb | Sleep   | 13312 |                          | NULL                       |    0.000 |
| 14 | root        | localhost | hellodb | Sleep   |  7338 |                          | NULL                       |    0.000 |
| 16 | root        | localhost | hellodb | Sleep   |   268 |                          | NULL                       |    0.000 |
| 18 | root        | localhost | hellodb | Query   |    42 | Updating                 | update teachers set <span style="color: #a0522d;">age</span>=30 |    0.000 |
| 19 | root        | localhost | hellodb | Query   |     0 | Init                     | show processlist           |    0.000 |
+----+-------------+-----------+---------+---------+-------+--------------------------+----------------------------+----------+
11 rows<span style="color: #a020f0;"> in</span> set (0.000 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26432;&#25481;&#26410;&#23436;&#25104;&#30340;&#20107;&#21153;</span>
MariaDB [hellodb]&gt; kill 16;
Query OK, 0 rows affected (0.001 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26432;&#25481;&#20043;&#21518;&#65292;&#31532;&#20108;&#20010;&#20250;&#35805;&#20013;&#30340;&#21629;&#20196;&#31435;&#21363;&#25191;&#34892;&#25104;&#21151;&#65292;&#31561;&#24453;&#20102;&#19977;&#21313;&#22810;&#31186;</span>
MariaDB [hellodb]&gt; update teachers set <span style="color: #a0522d;">age</span>=30;
Query OK, 4 rows affected (36.498 sec)
Rows matched: 4  Changed: 4  Warnings: 0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20107;&#21153;&#38145;&#30340;&#36229;&#26102;&#26102;&#38271;&#65292;&#40664;&#35748;50s</span>
MariaDB [hellodb]&gt; show global variables like <span style="color: #8b2252;">'innodb_lock_wait_timeout'</span>;
+--------------------------+-------+
| Variable_name            | Value |
+--------------------------+-------+
| innodb_lock_wait_timeout | 50    |
+--------------------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.002 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:79390ef8-c5d8-471a-bab2-f2b7c9d22e64" class="outline-5">
<h5 id="h:79390ef8-c5d8-471a-bab2-f2b7c9d22e64">事务隔离级别</h5>
<div class="outline-text-5" id="text-h:79390ef8-c5d8-471a-bab2-f2b7c9d22e64">
<p>
MySQL 支持四种隔离级别，事务隔离级别：从上至下更加严格
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">隔离级别</th>
<th scope="col" class="org-left">脏读</th>
<th scope="col" class="org-left">不可重复读</th>
<th scope="col" class="org-left">㓜读</th>
<th scope="col" class="org-left">加读锁</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">读未提交</td>
<td class="org-left">可以出现</td>
<td class="org-left">可以出现</td>
<td class="org-left">可以出现</td>
<td class="org-left">否</td>
</tr>

<tr>
<td class="org-left">读提交</td>
<td class="org-left">不允许出现</td>
<td class="org-left">可以出现</td>
<td class="org-left">可以出现</td>
<td class="org-left">否</td>
</tr>

<tr>
<td class="org-left">可重复读</td>
<td class="org-left">不允许出现</td>
<td class="org-left">不允许出现</td>
<td class="org-left">可以出现</td>
<td class="org-left">否</td>
</tr>

<tr>
<td class="org-left">序列化</td>
<td class="org-left">不允许出现</td>
<td class="org-left">不允许出现</td>
<td class="org-left">不允许出现</td>
<td class="org-left">是</td>
</tr>
</tbody>
</table>


<ul class="org-ul">
<li><p>
READ UNCOMMITTED
</p>

<p>
可读取到未提交数据，产生 <b>脏读</b>
</p></li>

<li><p>
READ COMMITTED
</p>

<p>
可读取到提交数据，但未提交数据不可读，产生 <b>不可重复读</b> ，即可读取到
多个提交数据，导致每次读取数据不一致（当备份数据库时就很头疼）
</p></li>

<li><p>
REPEATABLE READ
</p>

<p>
可重复读，多次读取数据都一致，产生 <b>幻读</b> ，即读取过程中，即使有其它
提交的事务修改数据，仍只能读取到未修改前的旧数据。此为MySQL默认设置
（适合备份）
</p></li>

<li><p>
SERIALIZABLE
</p>

<p>
可串行化，未提交的读事务阻塞修改事务（加读锁，但不阻塞读事务），或者
未提交的修改事务阻塞读事务（加写锁，其它事务的读，写都不可以执行）。
会导致 <b>并发性能差</b>
</p></li>
</ul>

<p>
<b>MVCC和事务的隔离级别</b>:
</p>

<p>
MVCC（多版本并发控制机制）只在REPEATABLE READ和READ COMMITTED两个隔离
级别下工作。其他两个隔离级别都和MVCC不兼容,因为READ UNCOMMITTED总是读
取最新的数据行，而不是符合当前事务版本的数据行。而SERIALIZABLE则会对所
有读取的行都加锁
</p>

<p>
<b>指定事务隔离级别</b>:
</p>

<ul class="org-ul">
<li>服务器变量tx_isolation指定，默认为REPEATABLE-READ，可在GLOBAL和
SESSION级进行设置</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SET</span> tx_isolation=<span style="color: #8b2252;">'READ-UNCOMMITTED|READ-COMMITTED|REPEATABLEREAD|SERIALIZABLE'</span>
</pre>
</div>

<ul class="org-ul">
<li>服务器选项中指定</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">vim /etc/my.cnf
[mysqld]
transaction-isolation=<span style="color: #8b2252;">"SERIALIZABLE"</span>
</pre>
</div>

<p>
<b>死锁</b> ：
</p>

<p>
两个或多个事务在同一资源相互占用，并请求锁定对方占用的资源的状态
</p>

<p>
范例：MySQL8.0事务隔离级别系统变量tx_isolation取消
</p>
<div class="org-src-container">
<pre class="src src-sh">&gt;select @@tx_isolation; <span style="color: #b22222;">#</span><span style="color: #b22222;">8.0&#20013;&#21462;&#28040;</span>
&gt;select @@transaction_isolation;
</pre>
</div>

<p>
范例：默认为事务隔离级别REPEATABLE READ，可重复读，多次读取数据都一致，
产生 <b>幻读</b>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#19968;&#20010;&#20250;&#35805;&#65306;&#20462;&#25913;&#25968;&#25454;&#24182;&#25552;&#20132;</span>
MariaDB [hellodb]&gt; select * from teachers;
+-----+---------------+-----+--------+
| TID | Name          | Age | Gender |
+-----+---------------+-----+--------+
|   1 | Song Jiang    |  45 | M      |
|   2 | Zhang Sanfeng |  94 | M      |
|   3 | Miejue Shitai |  77 | F      |
|   4 | Lin Chaoying  |  40 | F      |
+-----+---------------+-----+--------+
4 rows<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [hellodb]&gt; begin;
Query OK, 0 rows affected (0.000 sec)

MariaDB [hellodb]&gt; update teachers set <span style="color: #a0522d;">age</span>=4 where <span style="color: #a0522d;">tid</span>=4;
Query OK, 1 row affected (0.000 sec)
Rows matched: 1  Changed: 1  Warnings: 0

MariaDB [hellodb]&gt; commit;
Query OK, 0 rows affected (0.001 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#20108;&#20010;&#20250;&#35805;&#65306;&#20135;&#29983;&#24187;&#35835;&#65292;&#26597;&#30475;&#21040;&#30340;&#26159;&#20462;&#25913;&#21069;&#30340;&#25968;&#25454;</span>
MariaDB [hellodb]&gt; select * from teachers;
+-----+---------------+-----+--------+
| TID | Name          | Age | Gender |
+-----+---------------+-----+--------+
|   1 | Song Jiang    |  45 | M      |
|   2 | Zhang Sanfeng |  94 | M      |
|   3 | Miejue Shitai |  77 | F      |
|   4 | Lin Chaoying  |  40 | F      |
+-----+---------------+-----+--------+
4 rows<span style="color: #a020f0;"> in</span> set (0.000 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ad711803-f199-4f45-938d-537bfb99e817" class="outline-5">
<h5 id="h:ad711803-f199-4f45-938d-537bfb99e817">MVCC工作机制</h5>
<div class="outline-text-5" id="text-h:ad711803-f199-4f45-938d-537bfb99e817">
<p>
MVCC（多版本并发控制，Multi-Version Concurrency Control）是一种常用于
数据库管理系统中的并发控制机制。MVCC工作机制基本可以概括为：通过创建多
个版本来实现事务并发控制，以允许多个读操作同时进行，而避免写操作之间的
冲突。
</p>

<p>
具体来说，MVCC会在数据库中为每个操作创建不同的版本。对于写操作，它会将
其版本的时间戳设置为当前时间，并将该版本加入数据库中，同时将旧版本的快
照保存到undo log中；对于读操作，会将其版本时间戳设置为读取时的时间，然
后根据时间戳获取符合条件的数据版本，以此保证读操作与其他读操作之间不会
产生冲突。
</p>

<p>
当一个事务启动时，会根据隔离级别创建一个事务快照。在事务执行过程中，只
能看到在创建快照之前创建或更新的记录，这也就保证了读操作的正确性。
</p>

<p>
当有多个读写事务同时访问同一条记录时，MVCC会通过版本号的比较来判断是否
存在冲突，并对并发事务进行适当的隔离和锁定，以避免产生数据不一致的情况。
</p>

<p>
总之，MVCC通过创建多个版本，并使用版本号来进行标识和管理，以实现更高效、
更安全的并发控制，是较为成熟的数据库管理系统中一种常用的并发控制机制。
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-h:d18c785f-0f5b-4181-a6ea-6d7f9465a156" class="outline-3">
<h3 id="h:d18c785f-0f5b-4181-a6ea-6d7f9465a156">日志管理</h3>
<div class="outline-text-3" id="text-h:d18c785f-0f5b-4181-a6ea-6d7f9465a156">
<p>
MySQL 支持丰富的日志类型，如下：
</p>

<ul class="org-ul">
<li>事务日志：transaction log</li>
<li>事务日志的写入类型为“追加”，因此其操作为“顺序IO”；通常也被称为：
预写式日志write ahead logging（先于数据前记录日志）事务日志文件：
ib_logfile0， ib_logfile1</li>
<li>错误日志error log</li>
<li>通用日志general log</li>
<li>慢查询日志 slow query log</li>
<li>二进制日志 binary log</li>
<li>中继日志reley log，在主从复制架构中，从服务器用于保存从主服务器的二
进制日志中读取的事件</li>
</ul>
</div>
<div id="outline-container-h:d54d3dd5-c9e8-4f7b-8f3a-871daa8e722b" class="outline-4">
<h4 id="h:d54d3dd5-c9e8-4f7b-8f3a-871daa8e722b">事务日志</h4>
<div class="outline-text-4" id="text-h:d54d3dd5-c9e8-4f7b-8f3a-871daa8e722b">
<p>
事务日志：transaction log
</p>
<ul class="org-ul">
<li>redo log：实现WAL（Write Ahead Log），数据更新前先记录redo log</li>
<li>undo log：保存与执行的操作相反的操作，用于实现rollback</li>
</ul>

<p>
事务型存储引擎自行管理和使用，建议和数据文件分开存放
</p>

<p>
<b>Innodb事务日志相关配置</b>:
</p>

<div class="org-src-container">
<pre class="src src-sh">MariaDB [hellodb]&gt; show variables like <span style="color: #8b2252;">'%innodb_log%'</span>;

innodb_log_file_size 50331648 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#20010;&#26085;&#24535;&#25991;&#20214;&#22823;&#23567;&#65292;&#29983;&#20135;&#20013;&#24314;&#35758;&#35774;&#32622;&#22823;&#20123;&#65292;&#25918;&#22312;&#29420;&#31435;&#30340;&#30913;&#30424;&#20998;&#21306;&#20013;&#25968;&#25454;&#21487;&#20445;&#35777;&#26159;&#36830;&#32493;&#30340;&#12290;</span>
innodb_log_files_in_group 2   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26085;&#24535;&#32452;&#25104;&#21592;&#20010;&#25968;&#65292;&#29983;&#20135;&#20013;&#24314;&#35758;&#35774;&#32622;&#22823;&#20123;</span>
innodb_log_group_home_dir ./  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20107;&#21153;&#25991;&#20214;&#36335;&#24452;</span>
</pre>
</div>

<p>
<b>InnoDB事务日性能优化</b>
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">innodb_flush_log_at_trx_commit</span>=0|1|2 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;&#20026;1</span>
</pre>
</div>


<figure id="org3c7c39c">
<img src="./images/Snipaste_2023-05-13_12-45-57.png" alt="Snipaste_2023-05-13_12-45-57.png" width="60%">

</figure>


<div class="org-src-container">
<pre class="src src-sql">1 &#27492;&#20026;&#40664;&#35748;&#20540;&#65292;&#26085;&#24535;&#32531;&#20914;&#21306;&#23558;&#20889;&#20837;&#26085;&#24535;&#25991;&#20214;&#65292;&#24182;&#22312;&#27599;&#27425;&#20107;&#21153;&#21518;&#25191;&#34892;&#21047;&#26032;&#21040;&#30913;&#30424;&#12290; &#36825;&#26159;&#23436;&#20840;&#36981;&#23432;ACID&#29305;&#24615;&#65288;&#33509;&#19968;&#31186;&#38047;&#21457;&#29983;&#20102;&#19968;&#30334;&#27425;&#20107;&#21153;&#23601;&#20889;&#19968;&#30334;&#27425;&#30913;&#30424;&#65292;&#20445;&#35777;&#25968;&#25454;&#19981;&#20002;&#22833;&#65289;
0 &#25552;&#20132;&#26102;&#27809;&#26377;&#20889;&#30913;&#30424;&#30340;&#25805;&#20316;; &#32780;&#26159;&#27599;&#31186;&#25191;&#34892;&#19968;&#27425;&#23558;&#26085;&#24535;&#32531;&#20914;&#21306;&#30340;&#25552;&#20132;&#30340;&#20107;&#21153;&#20889;&#20837;&#21047;&#26032;&#21040;&#30913;&#30424;&#12290; &#36825;&#26679;&#21487;&#25552;&#20379;&#26356;&#22909;&#30340;&#24615;&#33021;&#65292;&#20294;&#26381;&#21153;&#22120;&#23849;&#28291;&#21487;&#33021;&#20002;&#22833;&#26368;&#21518;&#19968;&#31186;&#30340;&#20107;&#21153;&#65288;&#36861;&#27714;&#24615;&#33021;&#26102;&#65289;
2 &#27599;&#27425;&#25552;&#20132;&#21518;&#37117;&#20250;&#20889;&#20837;OS&#30340;&#32531;&#20914;&#21306;&#65292;&#20294;&#27599;&#31186;&#25165;&#20250;&#36827;&#34892;&#19968;&#27425;&#21047;&#26032;&#21040;&#30913;&#30424;&#25991;&#20214;&#20013;&#12290; &#24615;&#33021;&#27604;0&#30053;&#24046;&#19968;&#20123;&#65292;&#20294;&#25805;&#20316;&#31995;&#32479;&#25110;&#20572;&#30005;&#21487;&#33021;&#23548;&#33268;&#26368;&#21518;&#19968;&#31186;&#30340;&#20132;&#26131;&#20002;&#22833;&#65288;&#36861;&#27714;&#24615;&#33021;&#26102;&#65289;
</pre>
</div>


<p>
范例：修改事务文件路径
</p>

<div class="org-src-container">
<pre class="src src-sql">[root@centos8 ~]#mkdir /<span style="color: #a020f0;">data</span>/trans_log
[root@centos8 ~]#chown mysql.mysql /<span style="color: #a020f0;">data</span>/trans_log
[root@centos8 ~]#vim /etc/my.cnf.d/mariadb-server.cnf 
[mysqld]
innodb_log_group_home_dir=/<span style="color: #a020f0;">data</span>/trans_log

[root@centos8 ~]#ll /<span style="color: #a020f0;">data</span>/trans_log/
total 614400
-rw-rw<span style="color: #b22222;">---- </span><span style="color: #b22222;">1 mysql mysql 209715200 Jun 11 16:14 ib_logfile0</span>
-rw-rw<span style="color: #b22222;">---- </span><span style="color: #b22222;">1 mysql mysql 209715200 Jun 11 16:14 ib_logfile1</span>
-rw-rw<span style="color: #b22222;">---- </span><span style="color: #b22222;">1 mysql mysql 209715200 Jun 11 16:14 ib_logfile2</span>
</pre>
</div>


<p>
<b>高并发业务行业最佳实践，是使用第三种折衷配置（=2）</b> ：
</p>

<div class="org-src-container">
<pre class="src src-sql">1.&#37197;&#32622;&#20026;2&#21644;&#37197;&#32622;&#20026;0&#65292;&#24615;&#33021;&#24046;&#24322;&#24182;&#19981;&#22823;&#65292;&#22240;&#20026;&#23558;&#25968;&#25454;&#20174;Log Buffer&#25335;&#36125;&#21040;OS cache&#65292;&#34429;&#28982;&#36328;&#36234;&#29992;&#25143;&#24577;&#19982;&#20869;&#26680;&#24577;&#65292;&#20294;&#27605;&#31455;&#21482;&#26159;&#20869;&#23384;&#30340;&#25968;&#25454;&#25335;&#36125;&#65292;&#36895;&#24230;&#24456;&#24555;
2.&#37197;&#32622;&#20026;2&#21644;&#37197;&#32622;&#20026;0&#65292;&#23433;&#20840;&#24615;&#24046;&#24322;&#24040;&#22823;&#65292;&#25805;&#20316;&#31995;&#32479;&#23849;&#28291;&#30340;&#27010;&#29575;&#30456;&#27604;MySQL&#24212;&#29992;&#31243;&#24207;&#23849;&#28291;&#30340;&#27010;&#29575;&#65292;&#23567;&#24456;&#22810;&#65292;&#35774;&#32622;&#20026;2&#65292;&#21482;&#35201;&#25805;&#20316;&#31995;&#32479;&#19981;&#22868;&#28291;&#65292;&#20063;&#32477;&#23545;&#19981;&#20250;&#20002;&#25968;&#25454;
</pre>
</div>

<p>
说明：
</p>

<ul class="org-ul">
<li>设置为1，同时sync_binlog = 1表示最高级别的容错</li>
<li>innodb_use_global_flush_log_at_trx_commit=0时，将不能用SET语句重置此
变量（ MariaDB 10.2.6后废弃）</li>
</ul>

<p>
范例: 十万次事务测试
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#27169;&#24335;1
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> @@innodb_flush_log_at_trx_commit;
+<span style="color: #b22222;">----------------------------------</span><span style="color: #b22222;">+</span>
| @@innodb_flush_log_at_trx_commit |
+<span style="color: #b22222;">----------------------------------</span><span style="color: #b22222;">+</span>
|                                1 |
+<span style="color: #b22222;">----------------------------------</span><span style="color: #b22222;">+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">call</span> sp_testlog;
Query OK, 100000 <span style="color: #a020f0;">rows</span> affected (38.593 sec)

#&#27169;&#24335;0
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> @@innodb_flush_log_at_trx_commit;
+<span style="color: #b22222;">----------------------------------</span><span style="color: #b22222;">+</span>
| @@innodb_flush_log_at_trx_commit |
+<span style="color: #b22222;">----------------------------------</span><span style="color: #b22222;">+</span>
|                                0 |
+<span style="color: #b22222;">----------------------------------</span><span style="color: #b22222;">+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">call</span> sp_testlog;
Query OK, 100000 <span style="color: #a020f0;">rows</span> affected (3.639 sec)

#&#27169;&#24335;2
MariaDB [hellodb]&gt; <span style="color: #a020f0;">select</span> @@innodb_flush_log_at_trx_commit;
+<span style="color: #b22222;">----------------------------------</span><span style="color: #b22222;">+</span>
| @@innodb_flush_log_at_trx_commit |
+<span style="color: #b22222;">----------------------------------</span><span style="color: #b22222;">+</span>
|                                2 |
+<span style="color: #b22222;">----------------------------------</span><span style="color: #b22222;">+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)

MariaDB [hellodb]&gt; <span style="color: #a020f0;">call</span> sp_testlog;
Query OK, 100000 <span style="color: #a020f0;">rows</span> affected (4.422 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:246b10a1-f5ac-4c8b-b956-645ae8d2d2df" class="outline-4">
<h4 id="h:246b10a1-f5ac-4c8b-b956-645ae8d2d2df">错误日志</h4>
<div class="outline-text-4" id="text-h:246b10a1-f5ac-4c8b-b956-645ae8d2d2df">
<p>
<b>错误日志</b>
</p>
<ul class="org-ul">
<li>mysqld启动和关闭过程中输出的事件信息</li>
<li>mysqld运行中产生的错误信息</li>
<li>event scheduler运行一个event时产生的日志信息</li>
<li>在主从复制架构中的从服务器上启动从服务器线程时产生的信息</li>
</ul>

<p>
<b>错误文件路径</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW <span style="color: #a020f0;">GLOBAL</span> VARIABLES <span style="color: #a020f0;">LIKE</span> <span style="color: #8b2252;">'log_error'</span>
</pre>
</div>

<p>
范例：查看错误文件路径
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [hellodb]&gt; show <span style="color: #a020f0;">global</span> variables <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'log_error'</span>;
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+------------------------------+</span>
| Variable_name | <span style="color: #a020f0;">Value</span>                        |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+------------------------------+</span>
| log_error     | /var/log/mariadb/mariadb.log |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+------------------------------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.002 sec)
</pre>
</div>

<p>
<b>记录哪些警告信息至错误日志文件</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">#CentOS7 mariadb 5.5 &#40664;&#35748;&#20540;&#20026;1
#CentOS8 mariadb 10.3 &#40664;&#35748;&#20540;&#20026;2
log_warnings=0|1|2|3...
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sql">MariaDB [hellodb]&gt; SHOW <span style="color: #a020f0;">GLOBAL</span> VARIABLES <span style="color: #a020f0;">LIKE</span> <span style="color: #8b2252;">'log_warnings'</span>;
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+-------+</span>
| Variable_name | <span style="color: #a020f0;">Value</span> |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+-------+</span>
| log_warnings  | 2     |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+-------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

# mysql8.0 &#21464;&#37327;&#21464;&#21270;
show <span style="color: #a020f0;">global</span> variables <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'log_error_verbosity'</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fb76ea6f-d574-4448-b6f2-a3e5a33692fa" class="outline-4">
<h4 id="h:fb76ea6f-d574-4448-b6f2-a3e5a33692fa">通用日志</h4>
<div class="outline-text-4" id="text-h:fb76ea6f-d574-4448-b6f2-a3e5a33692fa">
<p>
通用日志：记录对数据库的通用操作，包括:错误的SQL语句
</p>

<p>
通用日志可以保存在：file（默认值）或 table（mysql.general_log表）
</p>

<p>
通用日志相关设置
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">general_log</span>=ON|OFF <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#27809;&#26377;&#24320;&#21551;</span>
<span style="color: #a0522d;">general_log_file</span>=HOSTNAME.log
<span style="color: #a0522d;">log_output</span>=TABLE|FILE|NONE
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">mysql&gt; select @@general_log;
+---------------+
| @@general_log |
+---------------+
|             0 |
+---------------+

mysql&gt; show variables like <span style="color: #8b2252;">'general_log%'</span>;
+------------------+-----------------------+
| Variable_name    | Value                 |
+------------------+-----------------------+
| general_log      | OFF                   |
| general_log_file | /var/lib/mysql/c5.log |
+------------------+-------------

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24320;&#21551;&#33021;&#29992;&#26085;&#24535;</span>
mysql&gt; set global <span style="color: #a0522d;">general_log</span>=1;
Query OK, 0 rows affected (0.09 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#36890;&#29992;&#26085;&#24535;&#65292;&#35760;&#24405;&#36890;&#29992;&#26085;&#24535;&#33267;mysql.general_log&#34920;&#20013;</span>
MariaDB [hellodb]&gt; set global <span style="color: #a0522d;">log_output</span>=<span style="color: #8b2252;">"table"</span>;
Query OK, 0 rows affected (0.000 sec)

MariaDB [hellodb]&gt; show global variables like <span style="color: #8b2252;">'log_output'</span>;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| log_output    | TABLE |
+---------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [mysql]&gt; select * from mysql.general_log\G
...&#30465;&#30053;...
************************* 37. row ***************************
  event_time: 2020-06-11 19:05:16.450156
   user_host: root[root] @ localhost []
   thread_id: 8
   server_id: 1
command_type: Query
    argument: show tables
************************* 38. row ***************************
  event_time: 2020-06-11 19:05:23.554815
   user_host: root[root] @ localhost []
   thread_id: 8
   server_id: 1
command_type: Query
    argument: select * from mysql.general_log
38 rows<span style="color: #a020f0;"> in</span> set (0.001 sec)

<span style="color: #b22222;"># </span><span style="color: #b22222;">general_log&#34920;&#26159;CSV&#26684;&#24335;&#30340;&#23384;&#20648;&#24341;&#25806;</span>

mysql&gt; show table status like <span style="color: #8b2252;">'general_log'</span>\G
*************************** 1. row ***************************
           Name: general_log
         Engine: CSV
        Version: 10
     Row_format: Dynamic
           Rows: 1
 Avg_row_length: 0
    Data_length: 0
Max_data_length: 0
   Index_length: 0
      Data_free: 0
 Auto_increment: NULL
    Create_time: NULL
    Update_time: NULL
     Check_time: NULL
      Collation: utf8_general_ci
       Checksum: NULL
 Create_options:
        Comment: General log
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

<span style="color: #b22222;"># </span><span style="color: #b22222;">tail -f general_log.CSV</span>
<span style="color: #8b2252;">"2023-05-15 05:30:33.781471"</span>,<span style="color: #8b2252;">"root[root] @ localhost []"</span>,29,0,<span style="color: #8b2252;">"Query"</span>,<span style="color: #8b2252;">"select * from general_log"</span>
<span style="color: #8b2252;">"2023-05-15 05:30:54.884528"</span>,<span style="color: #8b2252;">"root[root] @ localhost []"</span>,29,0,<span style="color: #8b2252;">"Query"</span>,<span style="color: #8b2252;">"show table status like 'general_log'"</span>
</pre>
</div>

<p>
范例：查找执行次数最多的前三条语句
</p>
<div class="org-src-container">
<pre class="src src-sh">mysql&gt; select argument,count(argument) num from mysql.general_log group by argument order by num limit 3;
</pre>
</div>

<p>
范例:对访问的语句进行排序
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mysql -e <span style="color: #8b2252;">'select argument from mysql.general_log'</span> | awk <span style="color: #8b2252;">'{sql[$0]++}END{for(i in sql){print sql[i],i}}'</span>|sort -nr
[root@centos8 ~]#mysql -e <span style="color: #8b2252;">'select argument from mysql.general_log'</span> |sort |uniq -c |sort -nr
</pre>
</div>
</div>
</div>
<div id="outline-container-h:064cce78-4b19-4ad5-9a4e-f480a0105613" class="outline-4">
<h4 id="h:064cce78-4b19-4ad5-9a4e-f480a0105613">慢查询日志</h4>
<div class="outline-text-4" id="text-h:064cce78-4b19-4ad5-9a4e-f480a0105613">
<p>
慢查询日志：记录执行查询时长超出指定时长的操作
</p>

<p>
慢查询相关变量
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">slow_query_log</span>=ON|OFF <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#25110;&#20851;&#38381;&#24930;&#26597;&#35810;&#65292;&#25903;&#25345;&#20840;&#23616;&#21644;&#20250;&#35805;&#65292;&#21482;&#26377;&#20840;&#23616;&#35774;&#32622;&#25165;&#20250;&#29983;&#25104;&#24930;&#26597;&#35810;&#25991;&#20214;</span>
<span style="color: #a0522d;">long_query_time</span>=N     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24930;&#26597;&#35810;&#30340;&#38400;&#20540;&#65292;&#21333;&#20301;&#31186;&#65292;&#40664;&#35748;10s</span>
<span style="color: #a0522d;">slow_query_log_file</span>=HOSTNAME-slow.log <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24930;&#26597;&#35810;&#26085;&#24535;&#25991;&#20214;</span>
log_slow_filter = admin,filesort,filesort_on_disk,full_join,full_scan,
query_cache,query_cache_miss,tmp_table,tmp_table_on_disk
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#36848;&#26597;&#35810;&#31867;&#22411;&#19988;&#26597;&#35810;&#26102;&#38271;&#36229;&#36807;long_query_time&#65292;&#21017;&#35760;&#24405;&#26085;&#24535;</span>
<span style="color: #a0522d;">log_queries_not_using_indexes</span>=ON <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#20351;&#29992;&#32034;&#24341;&#25110;&#20351;&#29992;&#20840;&#32034;&#24341;&#25195;&#25551;&#65292;&#19981;&#35770;&#26159;&#21542;&#36798;&#21040;&#24930;&#26597;&#35810;&#38400;&#20540;&#30340;&#35821;&#21477;&#26159;&#21542;&#35760;&#24405;&#26085;&#24535;&#65292;&#40664;&#35748;OFF&#65292;&#21363;&#19981;&#35760;&#24405;</span>
log_slow_rate_limit = 1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#23569;&#27425;&#26597;&#35810;&#25165;&#35760;&#24405;&#65292;mariadb&#29305;&#26377;</span>
<span style="color: #a0522d;">log_slow_verbosity</span>= Query_plan,explain <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35760;&#24405;&#20869;&#23481;</span>
log_slow_queries = OFF <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;slow_query_log&#65292;MariaDB 10.0/MySQL 5.6.1 &#29256;&#21518;&#24050;&#21024;&#38500;</span>
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">&gt; select sleep(2); <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20241;&#30496;2&#31186;&#30475;&#30475;&#26377;&#27809;&#26377;&#35760;&#24405;</span>
</pre>
</div>

<p>
范例：慢查询分析工具mysqldumpslow
</p>
<div class="org-src-container">
<pre class="src src-sh">mysqldumpslow -s c -t 2 /var/lib/mysql/centos8-slow.log
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0f282e7d-4879-46a9-933e-3cedfccf5bd3" class="outline-4">
<h4 id="h:0f282e7d-4879-46a9-933e-3cedfccf5bd3">二进制日志(备份)</h4>
<div class="outline-text-4" id="text-h:0f282e7d-4879-46a9-933e-3cedfccf5bd3">
<ul class="org-ul">
<li>记录导致数据改变或潜在导致数据改变的SQL语句</li>
<li>记录已提交的日志</li>
<li>不依赖于存储引擎类型</li>
</ul>

<p>
功能：通过“重放”日志文件中的事件来生成数据副本
</p>

<p>
注意：建议二进制日志和数据文件分开存放
</p>

<p>
<b>二进制日志记录三种格式</b>
</p>
<ul class="org-ul">
<li>基于“语句”记录：statement，记录语句，默认模式（ MariaDB 10.2.3版本以下 ），日志量较少</li>
<li>基于“行”记录：row，记录数据，日志量较大，更加安全，建议使用的格式</li>
<li>混合模式：mixed, 让系统自行判定该基于哪种方式进行，默认模式（ MariaDB10.2.4及版本以上）</li>
</ul>

<p>
<b>格式配置</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [hellodb]&gt; show variables <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'binlog_format'</span>;
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+-------+</span>
| Variable_name | <span style="color: #a020f0;">Value</span> |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+-------+</span>
| binlog_format | MIXED |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+-------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

#MySQL 8.0 &#40664;&#35748;&#20351;&#29992;<span style="color: #228b22;">ROW</span>&#26041;&#24335;
mysql&gt; show variables <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'binlog_format'</span>;
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+-------+</span>
| Variable_name | <span style="color: #a020f0;">Value</span> |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+-------+</span>
| binlog_format | <span style="color: #228b22;">ROW</span>   |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+-------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.07 sec)
</pre>
</div>

<p>
<b>二进制日志文件的构成</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">&#26377;&#20004;&#31867;&#25991;&#20214;
1.&#26085;&#24535;&#25991;&#20214;&#65306;mysql|mariadb-bin.&#25991;&#20214;&#21517;&#21518;&#32512;&#65292;&#20108;&#36827;&#21046;&#26684;&#24335;,&#22914;&#65306; mariadb-bin.000001
2.&#32034;&#24341;&#25991;&#20214;&#65306;mysql|mariadb-bin.index&#65292;&#25991;&#26412;&#26684;&#24335;
</pre>
</div>

<p>
二进制日志相关的服务器变量：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">sql_log_bin</span>=ON|OFF&#65306;#&#26159;&#21542;&#35760;&#24405;&#20108;&#36827;&#21046;&#26085;&#24535;&#65292;&#40664;&#35748;ON&#65292;&#25903;&#25345;&#21160;&#24577;&#20462;&#25913;&#65292;&#31995;&#32479;&#21464;&#37327;&#65292;&#32780;&#38750;&#26381;&#21153;&#22120;&#36873;&#39033;&#65292;session&#32423;
<span style="color: #a0522d;">log_bin</span>=/PATH/BIN_LOG_FILE&#21517;&#21069;&#32512;&#65306;#&#25351;&#23450;&#25991;&#20214;&#20301;&#32622;&#65307;&#40664;&#35748;OFF&#65292;&#34920;&#31034;&#19981;&#21551;&#29992;&#20108;&#36827;&#21046;&#26085;&#24535;&#21151;&#33021;&#65292;&#19978;&#36848;&#20004;&#39033;&#37117;&#24320;&#21551;&#25165;&#21487;&#20197;&#65292;&#19981;&#33021;&#21160;&#24577;&#26356;&#25913;
&#20108;&#36827;&#21046;&#25991;&#20214;&#24314;&#35758;&#19982;&#25968;&#25454;&#30446;&#24405;&#20998;&#24320;&#25918;&#12290;

<span style="color: #a0522d;">binlog_format</span>=STATEMENT|ROW|MIXED&#65306;#&#20108;&#36827;&#21046;&#26085;&#24535;&#35760;&#24405;&#30340;&#26684;&#24335;&#65292;mariadb5.5&#40664;&#35748;STATEMENT &#35760;&#24405;&#21629;&#20196;&#26412;&#36523;&#12290;ROW &#25286;&#20998;&#25104;&#27599;&#34892;&#20462;&#25913;&#30340;&#35821;&#21477;&#12290;
<span style="color: #a0522d;">max_binlog_size</span>=1073741824&#65306;#&#21333;&#20010;&#20108;&#36827;&#21046;&#26085;&#24535;&#25991;&#20214;&#30340;&#26368;&#22823;&#20307;&#31215;&#65292;&#21040;&#36798;&#26368;&#22823;&#20540;&#20250;&#33258;&#21160;&#28378;&#21160;&#65292;&#40664;&#35748;&#20026;1G
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35828;&#26126;&#65306;&#25991;&#20214;&#36798;&#21040;&#19978;&#38480;&#26102;&#30340;&#22823;&#23567;&#26410;&#24517;&#20026;&#25351;&#23450;&#30340;&#31934;&#30830;&#20540;</span>
<span style="color: #a0522d;">binlog_cache_size</span>=4m <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27492;&#21464;&#37327;&#30830;&#23450;&#22312;&#27599;&#27425;&#20107;&#21153;&#20013;&#20445;&#23384;&#20108;&#36827;&#21046;&#26085;&#24535;&#26356;&#25913;&#35760;&#24405;&#30340;&#32531;&#23384;&#30340;&#22823;&#23567;&#65288;&#27599;&#27425;&#36830;&#25509;&#65289;</span>
<span style="color: #a0522d;">max_binlog_cache_size</span>=512m <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38480;&#21046;&#29992;&#20110;&#32531;&#23384;&#22810;&#20107;&#21153;&#26597;&#35810;&#30340;&#23383;&#33410;&#22823;&#23567;&#12290;</span>
<span style="color: #a0522d;">sync_binlog</span>=1|0&#65306;#&#35774;&#23450;&#26159;&#21542;&#21551;&#21160;&#20108;&#36827;&#21046;&#26085;&#24535;&#21363;&#26102;&#21516;&#27493;&#30913;&#30424;&#21151;&#33021;&#65292;&#40664;&#35748;0&#65292;&#30001;&#25805;&#20316;&#31995;&#32479;&#36127;&#36131;&#21516;&#27493;&#26085;&#24535;&#21040;&#30913;&#30424;
<span style="color: #a0522d;">expire_logs_days</span>=N&#65306;#&#20108;&#36827;&#21046;&#26085;&#24535;&#21487;&#20197;&#33258;&#21160;&#21024;&#38500;&#30340;&#22825;&#25968;&#12290; &#40664;&#35748;&#20026;0&#65292;&#21363;&#19981;&#33258;&#21160;&#21024;&#38500;
</pre>
</div>

<p>
binlog_format说明：
</p>
<ul class="org-ul">
<li><p>
STATEMENT： 数据不全，在不同的时间执行结果不同。有可能带来数据的丢失
</p>

<p>
update students set age=20 where stuid&gt;=10;
</p></li>

<li><p>
ROW 数据完全，在不同的时间执行结构相同。
</p>

<p>
update students set age=20 where stuid=10;
</p>

<p>
update students set age=20 where stuid=11;
</p></li>
</ul>



<p>
<b>二进制日志相关配置</b>
</p>

<p>
<b>查看mariadb自行管理使用中的二进制日志文件列表，及大小</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW {<span style="color: #228b22;">BINARY</span> | MASTER} LOGS
</pre>
</div>

<p>
范例：查看binlog创建时间
</p>
<div class="org-src-container">
<pre class="src src-sh">mysql&gt; show full binary logs;
+------------------+-----------+---------------------+
| Log_name         | File_size | Modify_time         |
+------------------+-----------+---------------------+
| mysql-bin.000140 | 524290440 | 2025-02-20 11:16:23 |
| mysql-bin.000141 | 524365941 | 2025-02-21 18:01:18 |
</pre>
</div>

<p>
<b>查看使用中的二进制日志文件</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW MASTER STATUS
</pre>
</div>

<p>
<b>在线查看二进制文件中的指定内容</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">SHOW BINLOG EVENTS [<span style="color: #a020f0;">IN</span> <span style="color: #8b2252;">'log_name'</span>] [<span style="color: #a020f0;">FROM</span> pos] [<span style="color: #a020f0;">LIMIT</span> [offset,] <span style="color: #a020f0;">row_count</span>]
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">show binlog events <span style="color: #a020f0;">in</span> <span style="color: #8b2252;">'mysql-bin.000001'</span> <span style="color: #a020f0;">from</span> 6516 <span style="color: #a020f0;">limit</span> 2,3
</pre>
</div>

<p>
清除指定二进制日志
</p>

<div class="org-src-container">
<pre class="src src-sql">PURGE { <span style="color: #228b22;">BINARY</span> | MASTER } LOGS { <span style="color: #a020f0;">TO</span> <span style="color: #8b2252;">'log_name'</span> | <span style="color: #a020f0;">BEFORE</span> datetime_expr }
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">PURGE <span style="color: #228b22;">BINARY</span> LOGS <span style="color: #a020f0;">TO</span> <span style="color: #8b2252;">'mariadb-bin.000003'</span>; #&#21024;&#38500;mariadb-bin.000003&#20043;&#21069;&#30340;&#26085;&#24535;
PURGE <span style="color: #228b22;">BINARY</span> LOGS <span style="color: #a020f0;">BEFORE</span> <span style="color: #8b2252;">'2017-01-23'</span>;
PURGE <span style="color: #228b22;">BINARY</span> LOGS <span style="color: #a020f0;">BEFORE</span> <span style="color: #8b2252;">'2017-03-22 09:25:30'</span>;
</pre>
</div>

<p>
删除所有二进制日志，index文件重新记数
</p>

<div class="org-src-container">
<pre class="src src-sh">RESET MASTER [TO <span style="color: #b22222;">#</span><span style="color: #b22222;">]; #&#21024;&#38500;&#25152;&#26377;&#20108;&#36827;&#21046;&#26085;&#24535;&#25991;&#20214;&#65292;&#24182;&#37325;&#26032;&#29983;&#25104;&#26085;&#24535;&#25991;&#20214;&#65292;&#25991;&#20214;&#21517;&#20174;#&#24320;&#22987;&#35760;&#25968;&#65292;&#40664;&#35748;&#20174;1&#24320;&#22987;&#65292;&#19968;&#33324;&#26159;master&#20027;&#26426;&#31532;&#19968;&#27425;&#21551;&#21160;&#26102;&#25191;&#34892;&#65292;MariaDB 10.1.6&#24320;&#22987;&#25903;&#25345;TO #</span>
</pre>
</div>

<p>
<b>切换日志文件</b> ：
生成新的日志文件
</p>
<div class="org-src-container">
<pre class="src src-sh">FLUSH LOGS;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21629;&#20196;&#34892;</span>
mysqladmin -uroot -p flush-logs
</pre>
</div>
</div>
<div id="outline-container-h:f5457a3b-8db0-4860-9e7a-29c20486e44c" class="outline-5">
<h5 id="h:f5457a3b-8db0-4860-9e7a-29c20486e44c">mysqlbinlog</h5>
<div class="outline-text-5" id="text-h:f5457a3b-8db0-4860-9e7a-29c20486e44c">
<p>
<b>mysqlbinlog</b> ：二进制日志的客户端命令工具，支持离线查看二进制日志
</p>

<p>
命令格式：
</p>

<div class="org-src-container">
<pre class="src src-sql">mysqlbinlog [<span style="color: #a020f0;">OPTIONS</span>] log_file&#8230;
#&#24120;&#29992;&#36873;&#39033;
<span style="color: #b22222;">--</span><span style="color: #b22222;">start-datetime&#65306;&#25351;&#23450;&#24320;&#22987;&#26102;&#38388;&#65292;&#26684;&#24335;&#20026;YYYY-MM-DD HH:MM:SS&#12290;</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">stop-datetime&#65306;&#25351;&#23450;&#32467;&#26463;&#26102;&#38388;&#65292;&#26684;&#24335;&#20026;YYYY-MM-DD HH:MM:SS&#12290;</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">start-position&#65306;&#25351;&#23450;&#24320;&#22987;&#20301;&#32622;&#65292;&#21333;&#20301;&#20026;&#23383;&#33410;&#12290;</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">stop-position&#65306;&#25351;&#23450;&#32467;&#26463;&#20301;&#32622;&#65292;&#21333;&#20301;&#20026;&#23383;&#33410;&#12290;</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">verbose&#65306;&#36755;&#20986;&#26356;&#35814;&#32454;&#30340;&#20449;&#24687;&#65292;&#21253;&#25324;SQL&#35821;&#21477;&#30340;&#23436;&#25972;&#24418;&#24335;&#12290;</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">base64-output=DECODE-ROWS&#65306;&#35299;&#30721;&#34892;&#20107;&#20214;&#20013;&#30340;Base64&#32534;&#30721;&#25968;&#25454;</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">database=my_db&#65306;&#25351;&#23450;&#35201;&#25805;&#20316;&#30340;&#25968;&#25454;&#24211;</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">raw: &#33719;&#21462;&#21040;&#30340;Binlog&#25991;&#20214;&#25353;&#25968;&#25454;&#21407;&#26377;&#26684;&#24335;&#25171;&#21360;&#65292;&#32780;&#19981;&#20250;&#23637;&#31034;&#35299;&#26512;&#21518;&#30340;&#25968;&#25454;</span>
-v -vvv : &#26597;&#30475;&#20855;&#20307;<span style="color: #a020f0;">SQL</span>&#35821;&#21477;&#21450;&#22791;&#27880;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sql">mysqlbinlog <span style="color: #b22222;">--</span><span style="color: #b22222;">start-position=678 --stop-position=752 /var/lib/mysql/mariadb-bin.000003 -v</span>
mysqlbinlog <span style="color: #b22222;">--</span><span style="color: #b22222;">start-datetime="2018-01-30 20:30:10" --stop-datetime="2018-01-30 20:35:22" mariadb-bin.000003 -vvv</span>
</pre>
</div>

<p>
二进制日志事件的格式：
</p>

<div class="org-src-container">
<pre class="src src-sql">.jasper]# mysqlbinlog mysql-bin.000067  |head -n50
# <span style="color: #a020f0;">at</span> 4
#250108 23:02:50 server id 1703559787  end_log_pos 175 CRC32 0x0bfa2b8d     <span style="color: #a020f0;">Start</span>: binlog v 4, server v 8.0.13 created 250108 23:02:50
BINLOG <span style="color: #8b2252;">'</span>
<span style="color: #8b2252;">m</span>
<span style="color: #8b2252;">'</span><span style="color: #b22222;">/*!*/</span>;
# <span style="color: #a020f0;">at</span> 321
#250108 23:02:50 server id 1703559787  end_log_pos 414 CRC32 0x202c5e4d     Query   thread_id=329608114 exec_time=0 error_code=0
<span style="color: #a020f0;">SET</span> <span style="color: #228b22;">TIMESTAMP</span>=1736348570<span style="color: #b22222;">/*!*/</span>;
<span style="color: #a020f0;">BEGIN</span>
<span style="color: #b22222;">/*!*/</span>;
# <span style="color: #a020f0;">at</span> 414
#250108 23:02:50 server id 1703559787  end_log_pos 570 CRC32 0xd77f9baf     Table_map: `user_account`.`apps_flyer_push_event` mapped <span style="color: #a020f0;">to</span> <span style="color: #a020f0;">number</span> 622540
# <span style="color: #a020f0;">at</span> 570
#250108 23:02:50 server id 1703559787  end_log_pos 1372 CRC32 0xc0e3f73f    Write_rows_v1: <span style="color: #a020f0;">table</span> id 622540 flags: STMT_END_F
BINLOG <span style="color: #8b2252;">'</span>
<span style="color: #8b2252;">P/fjwA==</span>
<span style="color: #8b2252;">'</span><span style="color: #b22222;">/*!*/</span>;


#&#35299;&#37322;&#36755;&#20986;&#20869;&#23481;
&#20107;&#20214;&#21457;&#29983;&#30340;&#26085;&#26399;&#21644;&#26102;&#38388;&#65306;250108 23:02:50   25&#24180;01&#26376;08&#21495;
&#20107;&#20214;&#21457;&#29983;&#30340;&#26381;&#21153;&#22120;&#26631;&#35782;&#65306;server id 1703559787
&#20107;&#20214;&#30340;&#32467;&#26463;&#20301;&#32622;&#65306;end_log_pos 175
&#20107;&#20214;&#30340;&#31867;&#22411;&#65306;Query
&#20107;&#20214;&#21457;&#29983;&#26102;&#25152;&#22312;&#26381;&#21153;&#22120;&#25191;&#34892;&#27492;&#20107;&#20214;&#30340;&#32447;&#31243;&#30340;ID&#65306;thread_id=1
&#35821;&#21477;&#30340;&#26102;&#38388;&#25139;&#19982;&#23558;&#20854;&#20889;&#20837;&#20108;&#36827;&#21046;&#25991;&#20214;&#20013;&#30340;&#26102;&#38388;&#24046;&#65306;exec_time=0
&#38169;&#35823;&#20195;&#30721;&#65306;error_code=0
&#20107;&#20214;&#20869;&#23481;&#65306;
GTID&#65306;<span style="color: #a020f0;">Global</span> <span style="color: #a020f0;">Transaction</span> ID&#65292;mysql5.6&#20197;mariadb10&#20197;&#19978;&#29256;&#26412;&#19987;&#23646;&#23646;&#24615;&#65306;GTID
<span style="color: #a020f0;">BEGIN</span>&#65306;&#34920;&#31034;&#20107;&#21153;&#24320;&#22987;&#12290;
Table_map&#65306;&#34920;&#31034;&#34920;&#26144;&#23556;&#20107;&#20214;&#12290;
Write_rows&#65306;&#34920;&#31034;&#20889;&#20837;&#34892;&#20107;&#20214;&#12290;
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span>&#65306;&#34920;&#31034;&#25554;&#20837;&#35821;&#21477;&#12290;
</pre>
</div>

<p>
范例：回溯某时间段事件
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#35748;MySQL&#37197;&#32622;&#65306;&#30830;&#20445;MySQL&#37197;&#32622;&#20013;&#21551;&#29992;&#20102;binlog</span>
[mysqld]
log-bin=mysql-bin

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;Binlog&#25991;&#20214;&#65292;&#24182;&#26597;&#30475;&#25152;&#26377;binlog&#25991;&#20214;&#21015;&#34920;</span>
SHOW MASTER STATUS;
show binary logs

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36828;&#31243;&#19979;&#36733;binlog&#65292; &#24182;&#26597;&#30475;&#26102;&#38388;</span>
mysqlbinlog  -h rds.xx.com -u king_root -p --read-from-remote-server <span style="color: #8b2252;">\</span>
  --raw mysql-bin.000067

[root@grafana .jasper]# mysqlbinlog  mysql-bin.000067 |head
<span style="color: #b22222;"># </span><span style="color: #b22222;">at 4</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">250108 23:02:50 server id 1703559787  end_log_pos 175 CRC32 0x0bfa2b8d     Start: binlog v 4, server v 8.0.13 created 250108 23:02:50</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36807;&#28388;&#26102;&#38388;&#27573;&#12289;&#24211;&#65292;&#24182;&#35299;&#30721;SQL&#35821;&#21477;</span>
mysqlbinlog  <span style="color: #8b2252;">\</span>
 --start-datetime=<span style="color: #8b2252;">"2025-01-09 10:40:00"</span> --stop-datetime=<span style="color: #8b2252;">"2025-01-09 10:50:00"</span> <span style="color: #8b2252;">\</span>
 --base64-output=decode-rows -v <span style="color: #8b2252;">\</span>
 --database=user_account <span style="color: #8b2252;">\</span>
mysql-bin.000067 &gt; binlog-109.sql
</pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:c2e008fc-d831-4561-8856-3969b2f53836" class="outline-2">
<h2 id="h:c2e008fc-d831-4561-8856-3969b2f53836">备份和恢复</h2>
<div class="outline-text-2" id="text-h:c2e008fc-d831-4561-8856-3969b2f53836">
</div>
<div id="outline-container-h:932f6731-d19d-44c1-af01-6532488fdb93" class="outline-3">
<h3 id="h:932f6731-d19d-44c1-af01-6532488fdb93">备份恢复概述</h3>
<div class="outline-text-3" id="text-h:932f6731-d19d-44c1-af01-6532488fdb93">
</div>
<div id="outline-container-h:51610076-d324-4546-8dfe-d76b2d60e646" class="outline-4">
<h4 id="h:51610076-d324-4546-8dfe-d76b2d60e646">为什么要备份</h4>
<div class="outline-text-4" id="text-h:51610076-d324-4546-8dfe-d76b2d60e646">
<p>
灾难恢复：硬件故障、软件故障、自然灾害、黑客攻击、误操作测试等数据丢失场景
</p>

<p>
参考链接：<a href="https://www.infoq.cn/article/uuf06fYgW2vi3yd3pwzR">https://www.infoq.cn/article/uuf06fYgW2vi3yd3pwzR</a>
</p>
</div>
</div>
<div id="outline-container-h:d9dea3d7-6c34-47e1-9279-27ceddcb8bee" class="outline-4">
<h4 id="h:d9dea3d7-6c34-47e1-9279-27ceddcb8bee">备份类型</h4>
<div class="outline-text-4" id="text-h:d9dea3d7-6c34-47e1-9279-27ceddcb8bee">
<ul class="org-ul">
<li><p>
完全备份，部分备份
</p>

<p>
完全备份：整个数据集
</p>

<p>
部分备份：只备份数据子集，如部分库或表
</p></li>

<li><p>
完全备份、增量备份、差异备份
</p>

<p>
增量备份：仅备份最近一次完全备份或增量备份（如果存在增量）以来变化的
数据，备份较快，还原复杂
</p></li>
</ul>



<figure id="org00d4515">
<img src="./images/Snipaste_2023-05-15_08-35-43.png" alt="Snipaste_2023-05-15_08-35-43.png" width="60%">

</figure>

<p>
差异备份：仅备份最近一次完全备份以来变化的数据，备份较慢，还原简单
</p>



<figure id="org30d940a">
<img src="./images/Snipaste_2023-05-15_08-36-37.png" alt="Snipaste_2023-05-15_08-36-37.png" width="60%">

</figure>

<p>
注意：二进制日志文件不应该与数据文件放在同一磁盘
</p>

<ul class="org-ul">
<li>冷、温、热备份
<ul class="org-ul">
<li>冷备：读、写操作均不可进行，数据库停止服务</li>
<li>温备：读操作可执行；但写操作不可执行</li>
<li>热备：读、写操作均可执行
<ul class="org-ul">
<li>MyISAM：温备，不支持热备，不支持事务</li>
<li>InnoDB：都支持</li>
</ul></li>
</ul></li>

<li><p>
物理和逻辑备份
</p>

<p>
物理备份：直接复制数据文件进行备份，与存储引擎有关，占用较多的空间，速度快（需要停服务）
</p>

<p>
逻辑备份：从数据库中“导出”数据另存而进行的备份，与存储引擎无关，占用空间少，速度慢，可能丢失精度
</p></li>
</ul>
</div>
</div>
<div id="outline-container-h:f952dfa0-221d-4731-8e90-d4b9bf91cd41" class="outline-4">
<h4 id="h:f952dfa0-221d-4731-8e90-d4b9bf91cd41">备份什么</h4>
<div class="outline-text-4" id="text-h:f952dfa0-221d-4731-8e90-d4b9bf91cd41">
<ul class="org-ul">
<li>数据</li>
<li>二进制日志、InnoDB的事务日志</li>
<li>用户帐号，权限设置，程序代码（存储过程、函数、触发器、事件调度器）</li>
<li>服务器的配置文件</li>
</ul>
</div>
</div>
<div id="outline-container-h:e0473e80-62a1-4f65-b56e-fff1fb4bb9df" class="outline-4">
<h4 id="h:e0473e80-62a1-4f65-b56e-fff1fb4bb9df">备份注意要点</h4>
<div class="outline-text-4" id="text-h:e0473e80-62a1-4f65-b56e-fff1fb4bb9df">
<ul class="org-ul">
<li>能容忍最多丢失多少数据</li>
<li>备份产生的负载，增加io</li>
<li>备份过程的时长</li>
<li>温备的持锁多久</li>
<li>恢复数据需要在多长时间内完成</li>
<li>需要备份和恢复哪些数据</li>
</ul>
</div>
</div>
<div id="outline-container-h:13c68889-fd48-4076-82e8-7603b6580fa5" class="outline-4">
<h4 id="h:13c68889-fd48-4076-82e8-7603b6580fa5">还原要点</h4>
<div class="outline-text-4" id="text-h:13c68889-fd48-4076-82e8-7603b6580fa5">
<ul class="org-ul">
<li><b>做还原测试，用于测试备份的可用性</b></li>
<li>还原演练，写成规范的技术文档</li>
</ul>
</div>
</div>
<div id="outline-container-h:ed0ade02-29af-468b-aeae-67ad6d196510" class="outline-4">
<h4 id="h:ed0ade02-29af-468b-aeae-67ad6d196510">备份工具</h4>
<div class="outline-text-4" id="text-h:ed0ade02-29af-468b-aeae-67ad6d196510">
<ul class="org-ul">
<li>cp,tar等复制归档工具：物理备份工具，适用所有存储引擎；只支持冷备；完
全和部分备份（需要停服务，无法保证数据时间一致性）</li>
<li>LVM的快照：先加读锁，做快照后解锁，几乎热备；借助文件系统工具进行备
份（用的不多）</li>
<li>mysqldump：逻辑备份工具，适用所有存储引擎，对MyISAM存储引擎进行温备；
支持完全或部分备份；对InnoDB存储引擎支持热备，结合binlog的增量备份
（主流工具）</li>
<li>xtrabackup：由Percona提供支持对InnoDB做热备(物理备份)的工具，支持完
全备份、增量备份（相对较少）</li>
<li>MariaDB Backup： 从MariaDB 10.1.26开始集成，基于Percona
XtraBackup2.3.8实现（付费）</li>
<li>mysqlbackup：热备份， MySQL Enterprise Edition组件，收费</li>
<li>mysqlhotcopy：PERL 语言实现，几乎冷备，仅适用于MyISAM存储引擎，使用
LOCK TABLES、FLUSH TABLES和cp或scp来快速备份数据库（用的越来越少）</li>
</ul>
</div>
</div>
<div id="outline-container-h:d38e51fd-7202-4390-b575-d0be9471ca5b" class="outline-4">
<h4 id="h:d38e51fd-7202-4390-b575-d0be9471ca5b">实战案例：数据库冷备份和还原</h4>
<div class="outline-text-4" id="text-h:d38e51fd-7202-4390-b575-d0be9471ca5b">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#30446;&#26631;&#26381;&#21153;&#22120;&#65288;10.0.0.18&#65289;&#23433;&#35013;mariadb-server&#65292;&#19981;&#21551;&#21160;&#26381;&#21153;</span>
[root@centos8 ~]#dnf install mariadb-server

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#28304;&#20027;&#26426;&#65288;10.0.0.8&#65289;&#20808;&#21551;&#29992;&#20108;&#36827;&#21046;&#26085;&#24535;  &#65288;&#23454;&#39564;&#38656;&#35201;&#65289;</span>
[root@centos8 ~]#vim /etc/my.cnf.d/mariadb-server.cnf 
[mysqld]
log-bin=/data/logbin/mysql-bin
[root@centos8 ~]#mkdir /data/logbin
[root@centos8 ~]#chown mysql.mysql /data/logbin
[root@centos8 ~]#systemctl restart mariadb
[root@centos8 ~]#ll /data/logbin/
total 8
-rw-rw---- 1 mysql mysql 328 Jun 12 21:37 mysql-bin.000001
-rw-rw---- 1 mysql mysql  30 Jun 12 21:37 mysql-bin.index

<span style="color: #b22222;">#</span><span style="color: #b22222;">1 &#22312;&#28304;&#20027;&#26426;&#65288;10.0.0.8&#65289;&#25191;&#34892;&#20572;&#27490;&#26381;&#21153;</span>
[root@centos8 ~]# systemctl stop mariadb

<span style="color: #b22222;">#</span><span style="color: #b22222;">2 &#22797;&#21046;&#30456;&#20851;&#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#37197;&#32622;&#21450;&#20108;&#36827;&#21046;&#25991;&#20214;&#30456;&#20851;&#26377;&#29305;&#27530;&#35774;&#32622;&#20063;&#38656;&#35201;&#22791;&#20221;</span>
[root@centos8 ~]# scp /etc/my.cnf.d/mariadb-server.cnf 10.0.0.18:/etc/my.cnf.d/
[root@centos8 ~]# scp -r /var/lib/mysql/* 10.0.0.18:/var/lib/mysql/
[root@centos8 ~]# scp -r /data/logbin/ 10.0.0.18:/data/ <span style="color: #b22222;">#</span><span style="color: #b22222;">10.0.0.18&#20107;&#20808;&#23384;&#22312;/data/&#30446;&#24405;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">2 &#20445;&#30041;&#23646;&#24615;&#65306;&#25512;&#33616;&#20351;&#29992;rsync</span>
[root@centos8 ~]#rsync -av /var/lib/mysql/ 10.0.0.18:/var/lib/mysql/
[root@centos8 ~]#rsync -av /data/logbin 10.0.0.18:/backup  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#26356;&#26032;&#20043;&#21069;&#30340;&#20108;&#36827;&#21046;&#26085;&#24535;</span>
[root@centos8 ~]#rsync -a /etc/my.cnf.d/mariadb-server.cnf  10.0.0.18:/backup
[root@centos8 ~]#ll /data/logbin/
total 8
-rw-rw---- 1 mysql mysql 351 Jun 12 21:44 mysql-bin.000001
-rw-rw---- 1 mysql mysql  30 Jun 12 21:37 mysql-bin.index
-rw-rw---- 1 mysql mysql   0 Jun 12 21:44 mysql-bin.state

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33509;&#28304;&#20027;&#26426;&#22312;&#22791;&#20221;&#20043;&#21518;&#21448;&#26356;&#26032;&#20102;&#25968;&#25454;&#24211;&#65292;&#21017;&#38656;&#35201;&#23558;&#26368;&#26032;&#30340;&#20108;&#36827;&#21046;&#26085;&#24535;&#20063;&#36827;&#34892;&#22791;&#20221;</span>
[root@centos8 ~]#rsync -av /data/logbin 10.0.0.18:/backup/newlogbin
[root@centos8 ~]#ll /backup/newlogbin/
total 12
-rw-r----- 1 root root 351 Jun 13 23:16 mysql-bin.000001
-rw-r----- 1 root root 913 Jun 13 23:16 mysql-bin.000002
-rw-r----- 1 root root  60 Jun 13 23:16 mysql-bin.index
[root@centos8 ~]#mysqlbinlog /backup/newlogbin/mysql-bin.000002 &gt; logbin.sql  <span style="color: #b22222;">#</span><span style="color: #b22222;">mysqlbinlog&#21487;&#20197;&#26597;&#30475;&#20108;&#36827;&#21046;&#26085;&#24535;</span>
MariaDB [(none)]&gt; show variables like <span style="color: #8b2252;">'sql_log_bin'</span>;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| sql_log_bin   | ON    |
+---------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [(none)]&gt; set <span style="color: #a0522d;">sql_log_bin</span>=0;
Query OK, 0 rows affected (0.000 sec)

MariaDB [(none)]&gt; show variables like <span style="color: #8b2252;">'sql_log_bin'</span>;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| sql_log_bin   | OFF   |
+---------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [(none)]&gt; source /root/logbin.sql
MariaDB [hellodb]&gt; set <span style="color: #a0522d;">sql_log_bin</span>=1;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21040;&#27492;&#26356;&#26032;&#21518;&#30340;&#25968;&#25454;&#20063;&#37117;&#36824;&#21407;&#20102;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">3 &#22312;&#30446;&#26631;&#20027;&#26426;&#65288;10.0.0.18&#65289;&#25191;&#34892;</span>
[root@centos8 ~]#chown -R mysql.mysql /var/lib/mysql/
[root@centos8 ~]#chown -R mysql.mysql /data/logbin/
[root@centos8 ~]#systemctl start mariadb
</pre>
</div>

<p>
注意：
</p>

<p>
<b>还原数据时要把二进制日志功能停掉sql_log_bin，不然还原的过程也会存到日志里</b>
</p>
</div>
</div>
<div id="outline-container-h:7d9ce158-20da-44ba-b49c-923231e2514f" class="outline-4">
<h4 id="h:7d9ce158-20da-44ba-b49c-923231e2514f">基于 LVM 的快照备份</h4>
<div class="outline-text-4" id="text-h:7d9ce158-20da-44ba-b49c-923231e2514f">
<p>
生产中用的较少，前提是事先要把数据库存到逻辑卷里
</p>

<div class="org-src-container">
<pre class="src src-sql">(1) &#35831;&#27714;&#38145;&#23450;&#25152;&#26377;&#34920;
mysql&gt; FLUSH TABLES <span style="color: #a020f0;">WITH</span> <span style="color: #a020f0;">READ</span> LOCK;
(2) &#35760;&#24405;&#20108;&#36827;&#21046;&#26085;&#24535;&#25991;&#20214;&#21450;&#20107;&#20214;&#20301;&#32622;
mysql&gt; FLUSH LOGS;          #&#21047;&#26032;&#26085;&#24535;&#65292;&#29983;&#25104;&#26032;&#30340;&#20108;&#36827;&#21046;&#26085;&#24535;
mysql&gt; SHOW MASTER STATUS;  #&#30475;&#21040;&#24403;&#21069;&#20108;&#36827;&#21046;&#22823;&#23567;&#21644;&#20351;&#29992;&#25991;&#20214;&#26159;&#35841;
mysql -e <span style="color: #8b2252;">'SHOW MASTER STATUS'</span> &gt; /<span style="color: #a020f0;">PATH</span>/<span style="color: #a020f0;">TO</span>/SOMEFILE
(3) &#21019;&#24314;&#24555;&#29031;
lvcreate -L # -s -p r -n <span style="color: #a020f0;">NAME</span> /DEV/VG_NAME/LV_NAME
(4) &#37322;&#25918;&#38145;
mysql&gt; UNLOCK TABLES;
(5) &#25346;&#36733;&#24555;&#29031;&#21367;&#65292;&#25191;&#34892;&#25968;&#25454;&#22791;&#20221;
(6) &#22791;&#20221;&#23436;&#25104;&#21518;&#65292;&#21024;&#38500;&#24555;&#29031;&#21367;     #&#19981;&#21024;&#30340;&#35805;&#21482;&#35201;&#26377;&#25968; &#25454;&#26356;&#26032;&#23601;&#20250;&#20889;&#20837;&#24555;&#29031;&#65292;&#24433;&#21709;&#24615;&#33021;
(7) &#21046;&#23450;&#22909;&#31574;&#30053;&#65292;&#36890;&#36807;&#21407;&#21367;&#22791;&#20221;&#20108;&#36827;&#21046;&#26085;&#24535;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:276d44d1-0862-402e-a013-d6c07968dc4c" class="outline-3">
<h3 id="h:276d44d1-0862-402e-a013-d6c07968dc4c">mysqldump备份工具</h3>
<div class="outline-text-3" id="text-h:276d44d1-0862-402e-a013-d6c07968dc4c">
</div>
<div id="outline-container-h:c2524df1-54d7-49fb-ae52-c3286ed47274" class="outline-4">
<h4 id="h:c2524df1-54d7-49fb-ae52-c3286ed47274">mysqldump 说明</h4>
<div class="outline-text-4" id="text-h:c2524df1-54d7-49fb-ae52-c3286ed47274">
<p>
<b>逻辑备份工具</b> ：
</p>

<p>
mysqldump, mydumper, phpMyAdmin
</p>

<p>
Schema和数据存储在一起、巨大的SQL语句、单个巨大的备份文件
</p>

<p>
mysqldump:是MySQL的客户端命令，通过mysql协议连接至mysql服务器进行备份
</p>

<p>
<b>命令格式</b>:
</p>

<div class="org-src-container">
<pre class="src src-sh">mysqldump [OPTIONS] database [tables] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25903;&#25345;&#25351;&#23450;&#25968;&#25454;&#24211;&#21644;&#25351;&#23450;&#22810;&#34920;&#30340;&#22791;&#20221;&#65292;&#20294;&#25968;&#25454;&#24211;&#26412;&#36523;&#23450;&#20041;&#19981;&#22791;&#20221;&#65292;&#36896;&#25104;&#30340;&#38382;&#39064;&#36739;&#22810;&#65292;&#22914;&#23383;&#31526;&#38598;&#65292;&#25490;&#24207;&#35268;&#21017;&#31561;&#33509;&#27809;&#26377;&#25552;&#21069;&#22791;&#20221;&#65292;&#21017;&#25968;&#25454;&#24211;&#19981;&#21487;&#29992;</span>
mysqldump [OPTIONS] &#8211;B DB1 [DB2 DB3...] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25903;&#25345;&#25351;&#23450;&#25968;&#25454;&#24211;&#22791;&#20221;&#65292;&#21253;&#21547;&#25968;&#25454;&#24211;&#26412;&#36523;&#23450;&#20041;&#20063;&#20250;&#22791;&#20221;</span>
mysqldump [OPTIONS] &#8211;A [OPTIONS] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#25152;&#26377;&#25968;&#25454;&#24211;&#65292;&#21253;&#21547;&#25968;&#25454;&#24211;&#26412;&#36523;&#23450;&#20041;&#20063;&#20250;&#22791;&#20221;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mysqldump -uroot -p<span style="color: #8b2252;">''</span> hellodb students &gt; students.sql
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21033;&#29992;students.sql&#23601;&#21487;&#20197;&#36827;&#34892;&#36824;&#21407;</span>
</pre>
</div>

<p>
mysqldump参考：
</p>

<p>
<a href="https://dev.mysql.com/doc/refman/5.7/en/mysqldump.html">https://dev.mysql.com/doc/refman/5.7/en/mysqldump.html</a>
</p>

<p>
mysqldump 常见通用选项：
</p>

<div class="org-src-container">
<pre class="src src-sh">-A, --all-databases      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#25152;&#26377;&#25968;&#25454;&#24211;&#65292;&#21547;create database; &#19981;&#21253;&#21547;information_schema&#21644;performance_schema&#36825;&#20004;&#20010;&#24211;</span>
-B, --databases db_name&#8230; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#22791;&#20221;&#30340;&#25968;&#25454;&#24211;&#65292;&#21253;&#25324;create database&#35821;&#21477;</span>
-E, --events&#65306;           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#30456;&#20851;&#30340;&#25152;&#26377;event scheduler</span>
-R, --routines&#65306;         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#25152;&#26377;&#23384;&#20648;&#36807;&#31243;&#21644;&#33258;&#23450;&#20041;&#20989;&#25968;&#65288;mysql&#25968;&#25454;&#24211;&#21253;&#21547;&#20102;&#23384;&#20648;&#36807;&#31243;&#21644;&#33258;&#23450;&#20041;&#20989;&#25968;&#65292;&#19981;&#21152;-R&#36873;&#39033;&#30452;&#25509;&#22791;&#20221;nysql&#25968;&#25454;&#24211;&#20063;&#21487;&#20197;&#65289;</span>
--triggers&#65306;             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#34920;&#30456;&#20851;&#35302;&#21457;&#22120;&#65292;&#40664;&#35748;&#21551;&#29992;,&#29992;--skip-triggers&#65292;&#19981;&#22791;&#20221;&#35302;&#21457;&#22120;</span>
--default-character-set=utf8 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#23383;&#31526;&#38598;  &#65288;&#25289;&#19969;&#23383;&#31526;&#38598;&#34987;utf8&#25152;&#21253;&#21547;&#65289;</span>
--master-data[=#]&#65306;      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27492;&#36873;&#39033;&#39035;&#21551;&#29992;&#20108;&#36827;&#21046;&#26085;&#24535;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">1&#65306;&#25152;&#22791;&#20221;&#30340;&#25968;&#25454;&#20043;&#21069;&#21152;&#19968;&#26465;&#35760;&#24405;&#20026;CHANGE MASTER TO&#35821;&#21477;&#65292;&#38750;&#27880;&#37322;&#65292;&#19981;&#25351;&#23450;#&#65292;&#40664;&#35748;&#20026;1&#65292;&#36866;&#21512;&#20110;&#20027;&#20174;&#22797;&#21046;&#22810;&#26426;&#20351;&#29992;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">2&#65306;&#35760;&#24405;&#20026;&#34987;&#27880;&#37322;&#30340;#CHANGE MASTER TO&#35821;&#21477;&#65292;&#36866;&#21512;&#20110;&#21333;&#26426;&#20351;&#29992;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27492;&#36873;&#39033;&#20250;&#33258;&#21160;&#20851;&#38381;--lock-tables&#21151;&#33021;&#65292;&#33258;&#21160;&#25171;&#24320;-x | --lock-all-tables&#21151;&#33021;&#65288;&#38500;&#38750;&#24320;&#21551;--single-transaction&#65289;</span>
-F, --flush-logs <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#21069;&#28378;&#21160;&#26085;&#24535;&#65292;&#38145;&#23450;&#34920;&#23436;&#25104;&#21518;&#65292;&#25191;&#34892;flush logs&#21629;&#20196;,&#29983;&#25104;&#26032;&#30340;&#20108;&#36827;&#21046;&#26085;&#24535;&#25991;&#20214;&#65292;&#37197;&#21512;-A &#25110; -B &#36873;&#39033;&#26102;&#65292;&#20250;&#23548;&#33268;&#21047;&#26032;&#22810;&#27425;&#25968;&#25454;&#24211;&#12290;&#24314;&#35758;&#22312;&#21516;&#19968;&#26102;&#21051;&#25191;&#34892;&#36716;&#20648;&#21644;&#26085;&#24535;&#21047;&#26032;&#65292;&#21487;&#36890;&#36807;&#21644;--single-transaction&#25110;-x&#65292;--master-data &#19968;&#36215;&#20351;&#29992;&#23454;&#29616;&#65292;&#27492;&#26102;&#21482;&#21047;&#26032;&#19968;&#27425;&#20108;&#36827;&#21046;&#26085;&#24535;</span>
--compact               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21435;&#25481;&#27880;&#37322;&#65292;&#36866;&#21512;&#35843;&#35797;&#65292;&#33410;&#32422;&#22791;&#20221;&#21344;&#29992;&#30340;&#31354;&#38388;&#65292;&#29983;&#20135;&#19981;&#20351;&#29992;</span>
-d, --no-data           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#22791;&#20221;&#34920;&#32467;&#26500;&#65292;&#19981;&#22791;&#20221;&#25968;&#25454;&#65292;&#21363;&#21482;&#22791;&#20221;create table</span>
-t, --no-create-info    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#22791;&#20221;&#25968;&#25454;,&#19981;&#22791;&#20221;&#34920;&#32467;&#26500;&#65292;&#21363;&#19981;&#22791;&#20221;create table</span>
-n,--no-create-db       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#22791;&#20221;create database&#65292;&#21487;&#34987;-A&#25110;-B&#35206;&#30422;</span>
--flush-privileges      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;mysql&#25110;&#30456;&#20851;&#26102;&#38656;&#35201;&#20351;&#29992;</span>
-f, --force             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24573;&#30053;SQL&#38169;&#35823;&#65292;&#32487;&#32493;&#25191;&#34892;</span>
--hex-blob              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#21313;&#20845;&#36827;&#21046;&#31526;&#21495;&#36716;&#20648;&#20108;&#36827;&#21046;&#21015;&#65292;&#24403;&#26377;&#21253;&#25324;BINARY&#65292; VARBINARY&#65292;BLOB&#65292;BIT&#30340;&#25968;&#25454;&#31867;&#22411;&#30340;&#21015;&#26102;&#20351;&#29992;&#65292;&#36991;&#20813;&#20081;&#30721;</span>
-q, --quick             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#32531;&#23384;&#26597;&#35810;&#65292;&#30452;&#25509;&#36755;&#20986;&#65292;&#21152;&#24555;&#22791;&#20221;&#36895;&#24230;</span>
</pre>
</div>

<p>
<b>mysqldump的MyISAM存储引擎相关的备份选项</b>
</p>

<p>
MyISAM不支持事务，只能支持温备；不支持热备，所以必须先锁定要备份的库，而后启动备份操作
</p>

<div class="org-src-container">
<pre class="src src-sql">-x,<span style="color: #b22222;">--</span><span style="color: #b22222;">lock-all-tables #&#21152;&#20840;&#23616;&#35835;&#38145;&#65292;&#38145;&#23450;&#25152;&#26377;&#24211;&#30340;&#25152;&#26377;&#34920;&#65292;&#21516;&#26102;&#21152;--single-transaction&#25110;--lock-tables&#36873;&#39033;&#20250;&#20851;&#38381;&#27492;&#36873;&#39033;&#21151;&#33021;&#65292;&#27880;&#24847;&#65306;&#25968;&#25454;&#37327;&#22823;&#26102;&#65292;&#21487;&#33021;&#20250;&#23548;&#33268;&#38271;&#26102;&#38388;&#26080;&#27861;&#24182;&#21457;&#35775;&#38382;&#25968;&#25454;&#24211;</span>
-l,<span style="color: #b22222;">--</span><span style="color: #b22222;">lock-tables #&#23545;&#20110;&#38656;&#35201;&#22791;&#20221;&#30340;&#27599;&#20010;&#25968;&#25454;&#24211;&#65292;&#22312;&#21551;&#21160;&#22791;&#20221;&#20043;&#21069;&#20998;&#21035;&#38145;&#23450;&#20854;&#25152;&#26377;&#34920;&#65292;&#40664;&#35748;&#20026;on,--skip-lock-tables&#36873;&#39033;&#21487;&#31105;&#29992;,&#23545;&#22791;&#20221;MyISAM&#30340;&#22810;&#20010;&#24211;,&#21487;&#33021;&#20250;&#36896;&#25104;&#25968;&#25454;&#19981;&#19968;&#33268;</span>
#&#27880;&#65306;&#20197;&#19978;&#36873;&#39033;&#23545;InnoDB&#34920;&#19968;&#26679;&#29983;&#25928;&#65292;&#23454;&#29616;&#28201;&#22791;&#65292;&#20294;&#19981;&#25512;&#33616;&#20351;&#29992;
</pre>
</div>

<p>
<b>mysqldump的InnoDB存储引擎相关的备份选项</b>:
</p>

<p>
InnoDB 存储引擎支持事务,可以利用事务的相应的隔离级别,实现热备。也可以实现温备但不建议用
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">--</span><span style="color: #b22222;">single-transaction</span>
#&#27492;&#36873;&#39033;Innodb&#20013;&#25512;&#33616;&#20351;&#29992;&#65292;&#19981;&#36866;&#29992;MyISAM&#65292;&#27492;&#36873;&#39033;&#20250;&#24320;&#22987;&#22791;&#20221;&#21069;&#65292;&#20808;&#25191;&#34892;<span style="color: #a020f0;">START</span> <span style="color: #a020f0;">TRANSACTION</span>&#25351;&#20196;&#24320;&#21551;&#20107;&#21153;
#&#27492;&#36873;&#39033;&#36890;&#36807;&#22312;&#21333;&#20010;&#20107;&#21153;&#20013;&#36716;&#20648;&#25152;&#26377;&#34920;&#26469;&#21019;&#24314;&#19968;&#33268;&#30340;&#24555;&#29031;&#12290; &#20165;&#36866;&#29992;&#20110;&#23384;&#20648;&#22312;&#25903;&#25345;&#22810;&#29256;&#26412;&#25511;&#21046;&#30340;&#23384;&#20648;&#24341;&#25806;&#20013;&#30340;&#34920;&#65288;&#30446;&#21069;&#21482;&#26377;InnoDB&#21487;&#20197;&#65289;; &#36716;&#20648;&#19981;&#20445;&#35777;&#19982;&#20854;&#20182;&#23384;&#20648;&#24341;&#25806;&#20445;&#25345;&#19968;&#33268;&#12290; &#22312;&#36827;&#34892;&#21333;&#20107;&#21153;&#36716;&#20648;&#26102;&#65292;&#35201;&#30830;&#20445;&#26377;&#25928;&#30340;&#36716;&#20648;&#25991;&#20214;&#65288;&#27491;&#30830;&#30340;&#34920;&#20869;&#23481;&#21644;&#20108;&#36827;&#21046;&#26085;&#24535;&#20301;&#32622;&#65289;&#65292;&#27809;&#26377;&#20854;&#20182;&#36830;&#25509;&#24212;&#35813;&#20351;&#29992;&#20197;&#19979;&#35821;&#21477;&#65306;<span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span>&#65292;DROPTABLE&#65292;RENAME <span style="color: #a020f0;">TABLE</span>&#65292;TRUNCATE <span style="color: #a020f0;">TABLE</span>,&#27492;&#36873;&#39033;&#21644;<span style="color: #b22222;">--</span><span style="color: #b22222;">lock-tables&#65288;&#27492;&#36873;&#39033;&#38544;&#21547;&#25552;&#20132;&#25346;&#36215;&#30340;&#20107;&#21153;&#65289;&#36873;&#39033;&#26159;&#30456;&#20114;&#25490;&#26021;,&#22791;&#20221;&#22823;&#22411;&#34920;&#26102;&#65292;&#24314;&#35758;&#23558;--single-transaction&#36873;&#39033;&#21644;--quick&#32467;&#21512;&#19968;&#36215;&#20351;&#29992;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d0c19868-4c36-454f-93cd-4aae7468fcb6" class="outline-4">
<h4 id="h:d0c19868-4c36-454f-93cd-4aae7468fcb6">生产环境实战备份策略</h4>
<div class="outline-text-4" id="text-h:d0c19868-4c36-454f-93cd-4aae7468fcb6">
<p>
<b>InnoDB建议备份策略</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">mysqldump &#8211;uroot -p &#8211;A &#8211;F &#8211;E &#8211;R --triggers --single-transaction --master-data=1 --flush-privileges  --default-character-set=utf8 --hex-blob &gt;${<span style="color: #a0522d;">BACKUP</span>}/fullbak_${<span style="color: #a0522d;">BACKUP_TIME</span>}.sql
<span style="color: #b22222;">#</span><span style="color: #b22222;">A&#20840;&#22791;&#20221;&#37117;&#33021;&#22791;&#20221;&#65292;&#25152;&#20197; &#8211;E &#8211;R --triggers &#36873;&#39033;&#21487;&#20197;&#19981;&#21152;&#65292;&#21152;&#20102;&#20250;&#21152;&#37325;mysql&#36127;&#36733;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">--hex-blob&#21313;&#20845;&#36827;&#21046;&#20445;&#23384;  -F&#29983;&#25104;&#26032;&#30340;&#20108;&#36827;&#21046;&#26085;&#24535;   -E&#22791;&#20221;&#20107;&#21153; </span>
</pre>
</div>

<p>
MyISAM建议备份策略
</p>

<div class="org-src-container">
<pre class="src src-sh">mysqldump &#8211;uroot -p &#8211;A &#8211;F &#8211;E &#8211;R &#8211;x --master-data=1 --flush-privileges --triggers --default-character-set=utf8 --hex-blob &gt;${<span style="color: #a0522d;">BACKUP</span>}/fullbak_${<span style="color: #a0522d;">BACKUP_TIME</span>}.sql
<span style="color: #b22222;">#</span><span style="color: #b22222;">-x&#38145;&#23450;&#25972;&#20010;&#25968;&#25454;&#24211;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:940374e7-e698-4759-881e-9e0399165167" class="outline-4">
<h4 id="h:940374e7-e698-4759-881e-9e0399165167">mysqldump 备份还原实战案例</h4>
<div class="outline-text-4" id="text-h:940374e7-e698-4759-881e-9e0399165167">

<figure id="org570691d">
<img src="./images/20200614202950679.png" alt="20200614202950679.png" width="60%">

</figure>

<div class="org-src-container">
<pre class="src src-sh">&#22791;&#20221;&#36824;&#21407;&#30340;&#24605;&#36335;&#65306;
1.&#31105;&#27490;&#29992;&#25143;&#35775;&#38382;&#65292;&#19994;&#21153;&#21319;&#32423;&#65292;skip-networking
2.&#20808;&#36824;&#21407;&#25968;&#25454;&#21040;&#20004;&#28857;&#65292;&#25214;&#21040;&#20004;&#28857;&#20197;&#21518;&#30340;&#20108;&#36827;&#21046;&#26085;&#24535;&#29983;&#25104;sql&#35821;&#21477;&#65292;&#23548;&#20986;&#26469;&#21518;&#65292;2&#65306;00&#21040;10&#65306;10&#30340;&#20108;&#36827;&#21046;&#26085;&#24535;&#20013;&#26377;&#21024;&#34920;&#30340;&#25805;&#20316;&#65292;&#25226;&#27492;&#25805;&#20316;&#21024;&#38500;&#21518;&#20877;&#24674;&#22797;
3.&#20108;&#36827;&#21046;&#26085;&#24535;&#21151;&#33021;&#20851;&#38381;&#65292;&#20808;&#24674;&#22797;&#20004;&#28857;&#20043;&#21069;&#25968;&#25454;&#65292;&#22312;&#24674;&#22797;&#20004;&#28857;&#20043;&#21518;&#25968;&#25454;
4.&#19968;&#20010;&#24211;&#37324;&#34920;&#21644;&#34920;&#26102;&#38388;&#19981;&#32479;&#19968;&#65288;&#20551;&#35774;10&#65306;10&#28857;&#30340;&#34920;&#26159;&#24211;&#23384;&#34920;&#65292;10&#65306;30&#20998;&#30340;&#34920;&#26159;&#35746;&#21333;&#34920;&#65289;&#65292;10&#65306;10&#26102;&#24211;&#23384;&#34920;&#34987;&#21024;&#20102;&#65292;&#32780;&#35746;&#21333;&#21364;&#19968;&#30452;&#22312;&#21464;&#65292;&#24211;&#23384;&#21364;&#27809;&#26377;&#23545;&#24212;&#20943;&#23569;&#65292;&#24433;&#21709;&#19994;&#21153;&#12290;&#36825;&#31181;&#24773;&#20917;&#19979;&#25968;&#25454;&#23601;&#26368;&#22909;&#24674;&#22797;&#21040;&#21024;&#34920;&#20043;&#21069;&#30340;&#29366;&#24577;&#65292;&#21024;&#34920;&#20043;&#21518;&#30340;&#29366;&#24577;&#21482;&#33021;&#20002;&#24323;

&#20855;&#20307;&#27493;&#39588;&#22914;&#19979;&#65306;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20986;&#26085;&#24535;</span>
[root@centos8 ~]#mysqldump -A --master-data=2 &gt; /backup/all_2.sql
[root@centos8 ~]#less /backup/alll_2.sql  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25968;&#25454;&#26356;&#26032;&#21040;&#21738;&#20010;&#28857;</span>
-- CHANGE MASTER TO <span style="color: #a0522d;">MASTER_LOG_FILE</span>=<span style="color: #8b2252;">'mysql_bin.000001'</span>, <span style="color: #a0522d;">MASTER_LOG_POS</span>=328;
[root@centos8 ~]#mysqlbinlog /data/logbin/mysql_bin.000001 --start-position=328 &gt; /backup/inc.sql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#34920;&#25805;&#20316;&#21024;&#38500;</span>
[root@centos8 ~]#sed -i.bak <span style="color: #8b2252;">'/^DROP TABLE/d'</span> /backup/inc.sql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#38381;&#20108;&#36827;&#21046;&#26085;&#24535;&#21151;&#33021;</span>
MariaDB [(none)]&gt; set <span style="color: #a0522d;">sql_log_bin</span>=off;
Query OK, 0 rows affected (0.000 sec)

MariaDB [(none)]&gt; select @@sql_log_bin;
+---------------+
| @@sql_log_bin |
+---------------+
|             0 |
+---------------+
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#36824;&#21407;</span>
MariaDB [(none)]&gt; source /backup/all_2.sql
MariaDB [mysql]&gt; source /backup/inc.sql
MariaDB [hellodb]&gt; set <span style="color: #a0522d;">sql_log_bin</span>=on;
</pre>
</div>
</div>
<div id="outline-container-h:630b6256-da69-48b8-8d9d-e8a6590b7bc8" class="outline-5">
<h5 id="h:630b6256-da69-48b8-8d9d-e8a6590b7bc8">实战案例：特定数据库的备份脚本</h5>
<div class="outline-text-5" id="text-h:630b6256-da69-48b8-8d9d-e8a6590b7bc8">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat backup_hellodb.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #a0522d;">TIME</span>=<span style="color: #ff00ff;">`date +%F_%H-%M-%S`</span>
<span style="color: #a0522d;">DIR</span>=/backup
<span style="color: #a0522d;">DB</span>=hellodb
<span style="color: #a0522d;">PASS</span>=xxx

[ -d $<span style="color: #a0522d;">DIR</span> ] || mkdir $<span style="color: #a0522d;">DIR</span> -p
mysqldump -uroot -p <span style="color: #8b2252;">"$PASS"</span> -F &#8211;E &#8211;R --triggers --single-transaction --master-data=2 --default-character-set=utf8 -q -B $<span style="color: #a0522d;">DB</span> | gzip &gt; ${<span style="color: #a0522d;">DIR</span>}/${<span style="color: #a0522d;">DB</span>}_${<span style="color: #a0522d;">TIME</span>}.sql.gz
<span style="color: #b22222;">#</span><span style="color: #b22222;">-B&#25351;&#23450;&#26576;&#20010;&#24211;&#22791;&#20221;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:82e9e745-3e58-453f-8091-18f3a352c70e" class="outline-5">
<h5 id="h:82e9e745-3e58-453f-8091-18f3a352c70e">实战案例：分库备份并压缩</h5>
<div class="outline-text-5" id="text-h:82e9e745-3e58-453f-8091-18f3a352c70e">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#for db<span style="color: #a020f0;"> in</span> <span style="color: #ff00ff;">`mysql -uroot -e 'show databases'|grep -Ev '^(Database|information_schema|performance_schema)$'`</span>;<span style="color: #a020f0;">do</span> mysqldump -B $<span style="color: #a0522d;">db</span> | gzip &gt; /data/$<span style="color: #a0522d;">db</span>.sql.gz;<span style="color: #a020f0;">done</span>

[root@centos8 ~]#mysql -uroot -e <span style="color: #8b2252;">'show databases'</span>|grep -Ev <span style="color: #8b2252;">'^(Database|information_schema|performance_schema)$'</span>|<span style="color: #a020f0;">while </span><span style="color: #483d8b;">read</span> db;<span style="color: #a020f0;">do</span> mysqldump -B $<span style="color: #a0522d;">db</span> | gzip &gt; /data/$<span style="color: #a0522d;">db</span>.sql.gz;<span style="color: #a020f0;">done</span>

[root@centos8 ~]#for db<span style="color: #a020f0;"> in</span> <span style="color: #ff00ff;">`mysql -e 'show databases' | grep -Ev 'Database|information_schema|performance_schema'`</span>;<span style="color: #a020f0;">do</span> mysqldump -B $<span style="color: #a0522d;">db</span> &gt; /backup/${<span style="color: #a0522d;">db</span>}_<span style="color: #ff00ff;">`date +%F`</span>.sql;<span style="color: #a020f0;">done</span>

[root@centos8 ~]#mysql -uroot -e <span style="color: #8b2252;">'show databases'</span>|grep -Ev <span style="color: #8b2252;">'^(Database|information_schema|performance_schema)$'</span> | sed -rn <span style="color: #8b2252;">'s# (.*)#mysqldump -B \1 | gzip &gt; /data/\1.sql.gz#p'</span> |bash

[root@centos8 ~]#mysql -uroot -e <span style="color: #8b2252;">'show databases'</span>|sed -rn <span style="color: #8b2252;">'/^(Database|information_schema|performance_schema)$/!s#(.*)#mysqldump -B \1 |gzip &gt; /data/\1.sql.gz#p'</span> |bash


[root@centos8 ~]#ll /backup/
total 484
-rw-r--r-- 1 root root   7803 Jun 13 10:07 hellodb_2020-06-13.sql
-rw-r--r-- 1 root root   3012 Jun 13 10:07 hellodb2_2020-06-13.sql
-rw-r--r-- 1 root root 481308 Jun 13 10:07 mysql_2020-06-13.sql
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3f736f26-7383-4a9b-8f4d-5af2947125e8" class="outline-5">
<h5 id="h:3f736f26-7383-4a9b-8f4d-5af2947125e8">实战案例:分库备份的实战脚本</h5>
<div class="outline-text-5" id="text-h:3f736f26-7383-4a9b-8f4d-5af2947125e8">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat backup_db.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #a0522d;">TIME</span>=<span style="color: #ff00ff;">`date +%F_%H-%M-%S`</span>
<span style="color: #a0522d;">DIR</span>=/backup
<span style="color: #a0522d;">PASS</span>=xxx

[ -d <span style="color: #8b2252;">"$DIR"</span> ] || mkdir $<span style="color: #a0522d;">DIR</span>

<span style="color: #a020f0;">for</span> DB<span style="color: #a020f0;"> in</span> <span style="color: #ff00ff;">`mysql -uroot -p "$PASS" -e 'show databases' | grep -Ev</span>
<span style="color: #ff00ff;">"^Database|.*schema$"`</span>;<span style="color: #a020f0;">do</span>
    mysqldump -F --single-transaction --master-data=2 --default-characterset=utf8 -q -B $<span style="color: #a0522d;">DB</span> | gzip &gt; ${<span style="color: #a0522d;">DIR</span>}/${<span style="color: #a0522d;">DB</span>}_${<span style="color: #a0522d;">TIME</span>}.sql.gz
<span style="color: #a020f0;">done</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a5ecffba-72d7-403c-acf4-a90bc886546b" class="outline-5">
<h5 id="h:a5ecffba-72d7-403c-acf4-a90bc886546b">实战案例：完全备份和还原</h5>
<div class="outline-text-5" id="text-h:a5ecffba-72d7-403c-acf4-a90bc886546b">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#20108;&#36827;&#21046;&#26085;&#24535;</span>
[root@centos8 ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
log-bin

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;</span>
[root@centos8 ~]#mysqldump -uroot -pxxx -A -F --single-transaction --masterdata=2 |gzip &gt; /backup/all-<span style="color: #ff00ff;">`date +%F`</span>.sql.gz

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36824;&#21407;</span>
[root@centos8 backup]#dnf install mariadb-server
[root@centos8 backup]#gzip -d all-2019-11-27.sql.gz
[root@centos8 ~]#mysql
MariaDB [(none)]&gt; set <span style="color: #a0522d;">sql_log_bin</span>=off; <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24674;&#22797;&#26399;&#38388;&#19981;&#35760;&#24405;&#20108;&#36827;&#21046;&#26085;&#24535;</span>
MariaDB [(none)]&gt; source /backup/all-2019-11-27.sql
MariaDB [(none)]&gt; set <span style="color: #a0522d;">sql_log_bin</span>=on;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1211aeb1-af7f-41ac-a91a-85e2212151d4" class="outline-5">
<h5 id="h:1211aeb1-af7f-41ac-a91a-85e2212151d4">实战案例：利用二进制日志，还原数据库最新状态</h5>
<div class="outline-text-5" id="text-h:1211aeb1-af7f-41ac-a91a-85e2212151d4">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20108;&#36827;&#21046;&#26085;&#24535;&#29420;&#31435;&#23384;&#25918;</span>
[mysqld]
log-bin=/data/mysql/mysql-bin

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23436;&#20840;&#22791;&#20221;&#65292;&#24182;&#35760;&#24405;&#22791;&#20221;&#30340;&#20108;&#36827;&#21046;&#20301;&#32622;</span>
mysqldump -uroot -pxxx -A -F --default-character-set=utf8 --single-transaction --master-data=2 | gzip &gt; /backup/all_<span style="color: #ff00ff;">`date +%F`</span>.sql.gz

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#25968;&#25454;&#24211;</span>
insert students (name,age,gender)value(<span style="color: #8b2252;">'xxx'</span>,20,<span style="color: #8b2252;">'M'</span>);
insert students (name,age,gender)value(<span style="color: #8b2252;">'wang'</span>,22,<span style="color: #8b2252;">'M'</span>);

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25439;&#22351;&#25968;&#25454;&#24211;</span>
rm -rf /var/lib/mysql/*

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36824;&#21407;</span>
<span style="color: #483d8b;">cd</span> /backup
gzip -d all_2019-11-25.sql.gz

<span style="color: #b22222;">#</span><span style="color: #b22222;">CentOS 8 &#38656;&#35201;&#20107;&#20808;&#29983;&#25104;&#25968;&#25454;&#24211;&#30456;&#20851;&#25991;&#20214;&#65292;CentOS7 &#19981;&#38656;&#35201;&#25191;&#34892;&#27492;&#27493;</span>
mysql_install_db --user=mysql
systemctl restart mariadb

MariaDB [(none)]&gt; show master logs;
+------------------+-----------+
| Log_name         | File_size |
+------------------+-----------+
| mysql-bin.000001 |       998 |
| mysql-bin.000002 |     28090 |
| mysql-bin.000003 |       342 |
+------------------+-----------+
3 rows<span style="color: #a020f0;"> in</span> set (0.000 sec)

MariaDB [(none)]&gt;set <span style="color: #a0522d;">sql_log_bin</span>=0;
MariaDB [(none)]&gt;source /data/all_2019-11-25.sql

[root@centos8 ~]#grep <span style="color: #8b2252;">'^-- CHANGE MASTER TO'</span> /data/all_2019-11-25.sql
-- CHANGE MASTER TO <span style="color: #a0522d;">MASTER_LOG_FILE</span>=<span style="color: #8b2252;">'mysql-bin.000001'</span>, <span style="color: #a0522d;">MASTER_LOG_POS</span>=328;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20108;&#36827;&#21046;&#26085;&#24535;&#30340;&#22791;&#20221;</span>
[root@centos8 mysql]#mysqlbinlog mysql-bin.000001 --start-position=328 &gt; /backup/inc.sql
[root@centos8 mysql]#mysqlbinlog mysql-bin.000002 &gt;&gt; /backup/inc.sql

MariaDB [(none)]&gt;set <span style="color: #a0522d;">sql_log_bin</span>=0;
MariaDB [(none)]&gt;source /backup/inc.sql
MariaDB [(none)]&gt;set <span style="color: #a0522d;">sql_log_bin</span>=1;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:15002842-d474-4e66-8878-14da6f20a3ad" class="outline-5">
<h5 id="h:15002842-d474-4e66-8878-14da6f20a3ad">实战案例：mysqldump 和二进制日志结合实现增量备份</h5>
<div class="outline-text-5" id="text-h:15002842-d474-4e66-8878-14da6f20a3ad">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mysqldump -uroot -p -A -F --single-transaction --master-data=2 |gzip &gt; /backup/all-<span style="color: #ff00ff;">`date +%F`</span>.sql.gz

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35266;&#23519;&#22791;&#20221;&#25991;&#20214;&#20013;&#30340;&#20108;&#36827;&#21046;&#25991;&#20214;&#21644;&#20301;&#32622;&#65292;&#23558;&#20043;&#21518;&#30340;&#20108;&#36827;&#21046;&#26085;&#24535;&#36827;&#34892;&#22797;&#21046;&#22791;&#20221;</span>
[root@centos8 ~]#cp /var/lib/mysql/mariadb-bin.000003 /backup
[root@centos8 ~]#mysqlbinlog --start-position=389 /backup/mariadb-bin.000003 &gt; /backup/inc.sql
</pre>
</div>
</div>
</div>
<div id="outline-container-h:639bfb04-e165-47db-9d81-21d19c77aaf9" class="outline-5">
<h5 id="h:639bfb04-e165-47db-9d81-21d19c77aaf9">实战案例：恢复误删除的表</h5>
<div class="outline-text-5" id="text-h:639bfb04-e165-47db-9d81-21d19c77aaf9">
<p>
案例说明：每天2：30做完全备份，早上10：00误删除students，10：10才发现
故障，现需要将数据库还原到10：10的状态，且恢复被删除的students表
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20108;&#36827;&#21046;&#25991;&#20214;&#25918;&#29420;&#31435;&#30340;&#20301;&#32622;&#65292;&#20108;&#36827;&#21046;&#26684;&#24335;&#29992;&#34892;ROW&#26684;&#24335;</span>
[mysqld]
<span style="color: #a0522d;">log_bin</span>=/data/mysql/logbin/mysql-bin
<span style="color: #a0522d;">binlog_format</span>=ROW
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773; &#25968;&#25454;&#20013;&#25191;&#34892;&#25351;&#20196; set global binlog_format = row</span>

mysql&gt; show variables like <span style="color: #8b2252;">'binlog_format'</span>;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| binlog_format | ROW   |
+---------------+-------+

mkdir -pv /data/mysql/logbin/
chown  mysql.mysql /data/mysql/logbin

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23436;&#20840;&#22791;&#20221;</span>
[root@centos8 ~]#mysqldump -uroot -p -A -F --single-transaction --master-data=2 &gt; /backup/allbackup_<span style="color: #ff00ff;">`date +%F_%T`</span>.sql
[root@centos8 ~]#ll /backup/
total 2992
-rw-r--r-- 1 root root 3060921 Nov 27 10:20 allbackup_2019-11-27_10:20:08.sql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23436;&#20840;&#22791;&#20221;&#21518;&#25968;&#25454;&#26356;&#26032;</span>
MariaDB [testdb]&gt; insert students (name,age,gender) values(<span style="color: #8b2252;">'rose'</span>,20,<span style="color: #8b2252;">'f'</span>);
Query OK, 1 row affected (0.001 sec)

MariaDB [testdb]&gt; insert students (name,age,gender) values(<span style="color: #8b2252;">'jack'</span>,22,<span style="color: #8b2252;">'M'</span>);
Query OK, 1 row affected (0.001 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">10&#65306;00&#35823;&#21024;&#38500;&#20102;&#19968;&#20010;&#37325;&#35201;&#30340;&#34920;</span>
MariaDB [testdb]&gt; drop table students;
Query OK, 0 rows affected (0.021 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#32493;&#20854;&#23427;&#34920;&#32487;&#32493;&#26356;&#26032;</span>
MariaDB [testdb]&gt; use hellodb;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MariaDB [hellodb]&gt; insert teachers (name,age,gender)values(<span style="color: #8b2252;">'wang'</span>,30,<span style="color: #8b2252;">'M'</span>);
Query OK, 1 row affected (0.002 sec)

MariaDB [hellodb]&gt; insert teachers (name,age,gender)values(<span style="color: #8b2252;">'xxx'</span>,28,<span style="color: #8b2252;">'M'</span>);
Query OK, 1 row affected (0.002 sec)

MariaDB [hellodb]&gt; select * from teachers;
+-----+---------------+-----+--------+
| TID | Name          | Age | Gender |
+-----+---------------+-----+--------+
|   1 | Song Jiang    |  45 | M      |
|   2 | Zhang Sanfeng |  94 | M      |
|   3 | Miejue Shitai |  77 | F      |
|   4 | Lin Chaoying  |  93 | F      |
|   5 | wang          |  30 | M      |
|   6 | cici          |  28 | M      |
+-----+---------------+-----+--------+
6 rows<span style="color: #a020f0;"> in</span> set (0.000 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">10&#65306;10&#21457;&#29616;&#34920;&#21024;&#38500;&#65292;&#36827;&#34892;&#36824;&#21407;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20572;&#27490;&#25968;&#25454;&#24211;&#35775;&#38382;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#23436;&#20840;&#22791;&#20221;&#20013;&#65292;&#25214;&#21040;&#20108;&#36827;&#21046;&#20301;&#32622;</span>
[root@centos8 ~]#grep <span style="color: #8b2252;">'\-\- CHANGE MASTER TO'</span> /backup/allbackup_2019-11-
27_10<span style="color: #8b2252;">\:</span>20<span style="color: #8b2252;">\:</span>08.sql
-- CHANGE MASTER TO <span style="color: #a0522d;">MASTER_LOG_FILE</span>=<span style="color: #8b2252;">'mysql-bin.000003'</span>, <span style="color: #a0522d;">MASTER_LOG_POS</span>=389;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#20174;&#23436;&#20840;&#22791;&#20221;&#21518;&#30340;&#20108;&#36827;&#21046;&#26085;&#24535;</span>
[root@centos8 ~]#mysqlbinlog --start-position=389 //data/mysql/logbin/mysql-bin.000003 &gt; /backup/inc.sql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25214;&#21040;&#35823;&#21024;&#38500;&#30340;&#35821;&#21477;&#65292;&#20174;&#22791;&#20221;&#20013;&#21024;&#38500;&#27492;&#35821;&#21477;</span>
[root@centos8 ~]#vim /data/inc.sql
<span style="color: #b22222;">#</span><span style="color: #b22222;">DROP TABLE `student_info` /* generated by server */</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#25991;&#20214;&#36807;&#22823;&#65292;&#21487;&#20197;&#20351;&#29992;sed&#23454;&#29616;</span>
[root@centos8 ~]#sed -i.bak <span style="color: #8b2252;">'/^DROP TABLE/d'</span> /data/inc.sql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21033;&#29992;&#23436;&#20840;&#22791;&#20221;&#21644;&#20462;&#25913;&#36807;&#30340;&#20108;&#36827;&#21046;&#26085;&#24535;&#36827;&#34892;&#36824;&#21407;</span>
[root@centos8 ~]#mysql -uroot -p
MariaDB [hellodb]&gt; set <span style="color: #a0522d;">sql_log_bin</span>=0;
MariaDB [hellodb]&gt; source /backup/allbackup_2019-11-27_10:20:08.sql;
MariaDB [hellodb]&gt; source /backup/inc.sql
MariaDB [hellodb]&gt; set <span style="color: #a0522d;">sql_log_bin</span>=1;
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:60db1127-9599-4ff3-8eac-32d2e0edbf5d" class="outline-3">
<h3 id="h:60db1127-9599-4ff3-8eac-32d2e0edbf5d">xtrabackup备份工具</h3>
<div class="outline-text-3" id="text-h:60db1127-9599-4ff3-8eac-32d2e0edbf5d">
</div>
<div id="outline-container-h:8c1072a7-0439-4b03-8f82-fd7c0d7556d7" class="outline-4">
<h4 id="h:8c1072a7-0439-4b03-8f82-fd7c0d7556d7">xtrabackup工具介绍</h4>
<div class="outline-text-4" id="text-h:8c1072a7-0439-4b03-8f82-fd7c0d7556d7">
<p>
<b>Percona 公司</b>
</p>

<p>
官网：<a href="http://www.percona.com">http://www.percona.com</a>
</p>

<p>
percona-server
</p>

<p>
InnoDB &#x2013;&gt; XtraDB
</p>

<p>
<b>Xtrabackup备份工具</b>
</p>

<p>
percona提供的mysql数据库备份工具，惟一开源的能够对innodb和xtradb数据库进行热备的工具
</p>

<p>
手册：<a href="https://www.percona.com/doc/percona-xtrabackup/LATEST/index.html">https://www.percona.com/doc/percona-xtrabackup/LATEST/index.html</a>
</p>

<p>
下载: <a href="https://www.percona.com/downloads/">https://www.percona.com/downloads/</a>
</p>

<p>
xtrabackup 特点：
</p>

<ul class="org-ul">
<li>备份还原过程快速、可靠</li>
<li>备份过程不会打断正在执行的事务</li>
<li>能够基于压缩等功能节约磁盘空间和流量</li>
<li>自动实现备份检验</li>
<li>开源，免费</li>
</ul>

<p>
<b>xtrabackup工具文件组成</b>
</p>

<p>
Xtrabackup2.2 版之前包括4个可执行文件：
</p>
<ul class="org-ul">
<li>innobackupex: Perl 脚本</li>
<li>xtrabackup:   C/C++，编译的二进制程序</li>
<li>xbcrypt:      加解密</li>
<li>xbstream:     支持并发写的流文件格式</li>
</ul>

<p>
说明：
</p>

<p>
xtrabackup 是用来备份 InnoDB 表的，不能备份非 InnoDB 表，和 MySQL Server 没有交互
</p>

<p>
innobackupex 脚本用来备份非 InnoDB 表，同时会调用 xtrabackup 命令来备
份 InnoDB 表，还会和MySQL Server 发送命令进行交互，如加全局读锁
（FTWRL）、获取位点（SHOW SLAVE STATUS）等。即innobackupex是在
xtrabackup 之上做了一层封装实现的
</p>

<p>
<b>xtrabackup的新版变化</b>
</p>

<p>
xtrabackup版本升级到2.4后，相比之前的2.1有了比较大的变化：innobackupex
功能全部集成到xtrabackup 里面，只有一个binary程序，另外为了兼容考虑，
innobackupex作为 xtrabackup的软链接，即xtrabackup现在支持非Innodb表备
份，并且 Innobackupex在下一版本中移除，建议通过xtrabackup替换
innobackupex
</p>

<p>
<b>xtrabackup备份过程</b>
</p>


<figure id="org9370d84">
<img src="./images/Snipaste_2023-05-15_17-50-16.png" alt="Snipaste_2023-05-15_17-50-16.png" width="60%">

</figure>

<p>
<b>备份生成的相关文件</b>
</p>

<p>
使用innobackupex备份时，其会调用xtrabackup备份所有的InnoDB表，复制所有
关于表结构定义的相关文件(.frm)、以及MyISAM、MERGE、CSV和ARCHIVE表的相
关文件，同时还会备份触发器和数据库配置信息相关的文件。这些文件会被保存
至一个以时间命名的目录中,在备份时，innobackupex还会在备份目录中创建如
下文件：
</p>

<ul class="org-ul">
<li>xtrabackup_info：文本文件，innobackupex工具执行时的相关信息，包括版
本，备份选项，备份时长，备份LSN(log sequence number日志序列号)，
BINLOG的位置</li>

<li>xtrabackup_checkpoints：文本文件，备份类型（如完全或增量）、备份状态
（如是否已经为prepared状态）和LSN范围信息,每个InnoDB页(通常为16k大小)都
会包含一个日志序列号LSN。LSN是整个数据库系统的系统版本号，每个页面相
关的LSN能够表明此页面最近是如何发生改变的</li>

<li>xtrabackup_binlog_info：文本文件，MySQL服务器当前正在使用的二进制日
志文件及至备份这一刻为止二进制日志事件的位置，可利用实现基于binlog的
恢复</li>

<li>backup-my.cnf：文本文件，备份命令用到的配置选项信息</li>

<li>xtrabackup_logfile：备份生成的二进制日志文件</li>
</ul>

<p>
范例:相关文件
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ll /usr/bin/innobackupex 
lrwxrwxrwx 1 root root 10 Apr 11 04:10 /usr/bin/innobackupex -&gt; xtrabackup
[root@centos8 ~]#ll /usr/bin/xtrabackup 
-rwxr-xr-x 1 root root 21303696 Apr 11 04:10 /usr/bin/xtrabackup

[root@centos8 ~]#ll /backup/
total 12340
-rw-r----- 1 root root      487 Jun 13 22:10 backup-my.cnf
drwxr-x--- 2 root root      272 Jun 13 22:10 hellodb
-rw-r----- 1 root root      425 Jun 13 22:10 ib_buffer_pool
-rw-r----- 1 root root 12582912 Jun 13 22:10 ibdata1
drwxr-x--- 2 root root     4096 Jun 13 22:10 mysql
drwxr-x--- 2 root root     8192 Jun 13 22:10 performance_schema
drwxr-x--- 2 root root     8192 Jun 13 22:10 sys
-rw-r----- 1 root root       25 Jun 13 22:10 xtrabackup_binlog_info
-rw-r----- 1 root root      135 Jun 13 22:10 xtrabackup_checkpoints
-rw-r----- 1 root root      479 Jun 13 22:10 xtrabackup_info
-rw-r----- 1 root root     2560 Jun 13 22:10 xtrabackup_logfile

[root@centos8 ~]#cat /backup/xtrabackup_checkpoints 
backup_type = full-backuped
from_lsn = 0
to_lsn = 2682522
last_lsn = 2682531
compact = 0
recover_binlog_info = 0
flushed_lsn = 2682531

[root@centos8 ~]#cat /backup/xtrabackup_info 
uuid = 9ea8b2fb-ad7f-11ea-9cd4-000c2930800a
name = 
tool_name = xtrabackup
tool_command = -uroot -pxxx --backup --target-dir=/backup/
tool_version = 2.4.20
ibbackup_version = 2.4.20
server_version = 5.7.29-log
start_time = 2020-06-13 22:10:20
end_time = 2020-06-13 22:10:22
lock_time = 1
binlog_pos = filename <span style="color: #8b2252;">'centos8-bin.000002'</span>, position <span style="color: #8b2252;">'10185'</span>
innodb_from_lsn = 0
innodb_to_lsn = 2682522
partial = N
incremental = N
format = file
compact = N
compressed = N
encrypted = N

[root@centos8 ~]#ll /backup/xtrabackup_binlog_info
-rw-r----- 1 root root 25 Jun 13 22:10 /backup/xtrabackup_binlog_info
[root@centos8 ~]#cat /backup/xtrabackup_binlog_info 
centos8-bin.000002  10185
mysql&gt; show master logs;
+--------------------+-----------+
| Log_name           | File_size |
+--------------------+-----------+
| centos8-bin.000001 |       177 |
| centos8-bin.000002 |     10185 |
+--------------------+-----------+
2 rows<span style="color: #a020f0;"> in</span> set (0.00 sec)

[root@centos8 ~]#file /backup/xtrabackup_logfile
/backup/xtrabackup_logfile: data

[root@centos8 ~]#cat /backup/backup-my.cnf
<span style="color: #b22222;"># </span><span style="color: #b22222;">This MySQL options file was generated by innobackupex.</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">The MySQL server</span>
[mysqld]
<span style="color: #a0522d;">innodb_checksum_algorithm</span>=crc32
<span style="color: #a0522d;">innodb_log_checksum_algorithm</span>=strict_crc32
<span style="color: #a0522d;">innodb_data_file_path</span>=ibdata1:12M:autoextend
<span style="color: #a0522d;">innodb_log_files_in_group</span>=2
<span style="color: #a0522d;">innodb_log_file_size</span>=50331648
<span style="color: #a0522d;">innodb_fast_checksum</span>=false
<span style="color: #a0522d;">innodb_page_size</span>=16384
<span style="color: #a0522d;">innodb_log_block_size</span>=512
<span style="color: #a0522d;">innodb_undo_directory</span>=./
<span style="color: #a0522d;">innodb_undo_tablespaces</span>=0
<span style="color: #a0522d;">server_id</span>=1
<span style="color: #a0522d;">redo_log_version</span>=1
<span style="color: #a0522d;">server_uuid</span>=64f21c70-ad78-11ea-80fc-000c2930800a
<span style="color: #a0522d;">master_key_id</span>=0
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fca7414b-3e5e-45ba-9a2e-e4d7ecb80633" class="outline-4">
<h4 id="h:fca7414b-3e5e-45ba-9a2e-e4d7ecb80633">xtrabackup安装</h4>
<div class="outline-text-4" id="text-h:fca7414b-3e5e-45ba-9a2e-e4d7ecb80633">
<p>
yum install percona-xtrabackup 在EPEL源中
</p>

<p>
最新版本下载安装：
<a href="https://www.percona.com/downloads/XtraBackup/LATEST/">https://www.percona.com/downloads/XtraBackup/LATEST/</a>
</p>
</div>
</div>
<div id="outline-container-h:40e80201-3fe6-47fc-9384-3be79844bee4" class="outline-4">
<h4 id="h:40e80201-3fe6-47fc-9384-3be79844bee4">xtrabackup用法</h4>
<div class="outline-text-4" id="text-h:40e80201-3fe6-47fc-9384-3be79844bee4">
<p>
xtrabackup工具备份和还原，需要三步实现
</p>

<ol class="org-ol">
<li>备份：对数据库做完全或增量备份</li>
<li>预准备： 还原前，先对备份的数据，整理至一个临时目录，</li>
<li>还原：将整理好的数据，复制回数据库目录中</li>
</ol>

<p>
<b>xtrabackup 选项参考</b> ：
</p>

<p>
<a href="https://docs.percona.com/percona-xtrabackup/8.0/xtrabackup_bin/xbk_option_reference.html">https://docs.percona.com/percona-xtrabackup/8.0/xtrabackup_bin/xbk_option_reference.html</a>
</p>

<p>
*备份*：
</p>

<div class="org-src-container">
<pre class="src src-sql">innobackupex [<span style="color: #a020f0;">option</span>] BACKUP-ROOT-DIR
</pre>
</div>

<p>
选项说明：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">--</span><span style="color: #b22222;">user&#65306;         #&#35813;&#36873;&#39033;&#34920;&#31034;&#22791;&#20221;&#36134;&#21495;</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">password&#65306;     #&#35813;&#36873;&#39033;&#34920;&#31034;&#22791;&#20221;&#30340;&#23494;&#30721;</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">host&#65306;         #&#35813;&#36873;&#39033;&#34920;&#31034;&#22791;&#20221;&#25968;&#25454;&#24211;&#30340;&#22320;&#22336;</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">databases&#65306;    #&#35813;&#36873;&#39033;&#25509;&#21463;&#30340;&#21442;&#25968;&#20026;&#25968;&#25454;&#24211;&#21517;&#65292;&#22914;&#26524;&#35201;&#25351;&#23450;&#22810;&#20010;&#25968;&#25454;&#24211;&#65292;&#24444;&#27492;&#38388;&#38656;&#35201;&#20197;&#31354;&#26684;&#38548;&#24320;&#65307;</span>
&#22914;&#65306;"xtra_test dba_test"&#65292;&#21516;&#26102;&#65292;&#22312;&#25351;&#23450;&#26576;&#25968;&#25454;&#24211;&#26102;&#65292;&#20063;&#21487;&#20197;&#21482;&#25351;&#23450;&#20854;&#20013;&#30340;&#26576;&#24352;&#34920;&#12290;
&#22914;&#65306;"mydatabase.mytable"&#12290;&#35813;&#36873;&#39033;&#23545;innodb&#24341;&#25806;&#34920;&#26080;&#25928;&#65292;&#36824;&#26159;&#20250;&#22791;&#20221;&#25152;&#26377;innodb&#34920;
<span style="color: #b22222;">--</span><span style="color: #b22222;">defaults-file&#65306;#&#35813;&#36873;&#39033;&#25351;&#23450;&#20174;&#21738;&#20010;&#25991;&#20214;&#35835;&#21462;MySQL&#37197;&#32622;&#65292;&#24517;&#39035;&#25918;&#22312;&#21629;&#20196;&#34892;&#31532;&#19968;&#20010;&#36873;&#39033;&#20301;&#32622;</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">incremental&#65306;  #&#35813;&#36873;&#39033;&#34920;&#31034;&#21019;&#24314;&#19968;&#20010;&#22686;&#37327;&#22791;&#20221;&#65292;&#38656;&#35201;&#25351;&#23450;--incremental-basedir</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">incremental-basedir&#65306;#&#35813;&#36873;&#39033;&#25351;&#23450;&#20026;&#21069;&#19968;&#27425;&#20840;&#22791;&#20221;&#25110;&#22686;&#37327;&#22791;&#20221;&#30340;&#30446;&#24405;&#65292;&#19982;--incremental&#21516;&#26102;&#20351;&#29992;</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">incremental-dir&#65306;    #&#35813;&#36873;&#39033;&#34920;&#31034;&#36824;&#21407;&#26102;&#22686;&#37327;&#22791;&#20221;&#30340;&#30446;&#24405;</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">include=name&#65306;       #&#25351;&#23450;&#34920;&#21517;&#65292;&#26684;&#24335;&#65306;databasename.tablename</span>
</pre>
</div>

<p>
<b>Prepare预准备</b> ：
</p>

<div class="org-src-container">
<pre class="src src-sql">innobackupex <span style="color: #b22222;">--</span><span style="color: #b22222;">apply-log [option] BACKUP-DIR</span>
</pre>
</div>

<p>
选项说明：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">--</span><span style="color: #b22222;">apply-log&#65306;#&#19968;&#33324;&#24773;&#20917;&#19979;,&#22312;&#22791;&#20221;&#23436;&#25104;&#21518;&#65292;&#25968;&#25454;&#23578;&#19988;&#19981;&#33021;&#29992;&#20110;&#24674;&#22797;&#25805;&#20316;&#65292;&#22240;&#20026;&#22791;&#20221;&#30340;&#25968;&#25454;&#20013;&#21487;&#33021;&#20250;&#21253;&#21547;&#23578;&#26410;&#25552;&#20132;&#30340;&#20107;&#21153;&#25110;&#24050;&#32463;&#25552;&#20132;&#20294;&#23578;&#26410;&#21516;&#27493;&#33267;&#25968;&#25454;&#25991;&#20214;&#20013;&#30340;&#20107;&#21153;&#12290;&#22240;&#27492;&#65292;&#27492;&#26102;&#25968;&#25454;&#25991;&#20214;&#20173;&#22788;&#29702;&#19981;&#19968;&#33268;&#29366;&#24577;&#12290;&#27492;&#36873;&#39033;&#20316;&#29992;&#26159;&#36890;&#36807;&#22238;&#28378;&#26410;&#25552;&#20132;&#30340;&#20107;&#21153;&#21450;&#21516;&#27493;&#24050;&#32463;&#25552;&#20132;&#30340;&#20107;&#21153;&#33267;&#25968;&#25454;&#25991;&#20214;&#20351;&#25968;&#25454;&#25991;&#20214;&#22788;&#20110;&#19968;&#33268;&#24615;&#29366;&#24577;</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">use-memory&#65306;#&#21644;--apply-log&#36873;&#39033;&#19968;&#36215;&#20351;&#29992;&#65292;&#24403;prepare &#22791;&#20221;&#26102;&#65292;&#20570;crash recovery&#20998;&#37197;&#30340;&#20869;&#23384;&#22823;&#23567;&#65292;&#21333;&#20301;&#23383;&#33410;&#65292;&#20063;&#21487;1MB,1M,1G,1GB&#31561;&#65292;&#25512;&#33616;1G</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">export&#65306;#&#34920;&#31034;&#24320;&#21551;&#21487;&#23548;&#20986;&#21333;&#29420;&#30340;&#34920;&#20043;&#21518;&#20877;&#23548;&#20837;&#20854;&#20182;Mysql&#20013;</span>
<span style="color: #b22222;">--</span><span style="color: #b22222;">redo-only&#65306;#&#27492;&#36873;&#39033;&#22312;prepare base full backup&#65292;&#24448;&#20854;&#20013;&#21512;&#24182;&#22686;&#37327;&#22791;&#20221;&#26102;&#20505;&#20351;&#29992;&#65292;&#20294;&#19981;&#21253;&#25324;&#23545;&#26368;&#21518;&#19968;&#20010;&#22686;&#37327;&#22791;&#20221;&#30340;&#21512;&#24182;</span>
</pre>
</div>

<p>
<b>还原</b> ：
</p>

<div class="org-src-container">
<pre class="src src-sql">innobackupex <span style="color: #b22222;">--</span><span style="color: #b22222;">copy-back [&#36873;&#39033;] BACKUP-DIR</span>
innobackupex <span style="color: #b22222;">--</span><span style="color: #b22222;">move-back [&#36873;&#39033;] [--defaults-group=GROUP-NAME] BACKUP-DIR</span>
</pre>
</div>

<p>
选项说明：
</p>

<div class="org-src-container">
<pre class="src src-sh">--copy-back&#65306;#&#20570;&#25968;&#25454;&#24674;&#22797;&#26102;&#23558;&#22791;&#20221;&#25968;&#25454;&#25991;&#20214;&#25335;&#36125;&#21040;MySQL&#26381;&#21153;&#22120;&#30340;datadir
--move-back&#65306;#&#36825;&#20010;&#36873;&#39033;&#19982;--copy-back&#30456;&#20284;&#65292;&#21807;&#19968;&#30340;&#21306;&#21035;&#26159;&#23427;&#19981;&#25335;&#36125;&#25991;&#20214;&#65292;&#32780;&#26159;&#31227;&#21160;&#25991;&#20214;&#21040;&#30446;&#30340;&#22320;&#12290;&#36825;&#20010;&#36873;&#39033;&#31227;&#38500;backup&#25991;&#20214;&#65292;&#29992;&#26102;&#20505;&#24517;&#39035;&#23567;&#24515;&#12290;&#20351;&#29992;&#22330;&#26223;&#65306;&#27809;&#26377;&#36275;&#22815;&#30340;&#30913;&#30424;&#31354;&#38388;&#21516;&#20107;&#20445;&#30041;&#25968;&#25454;&#25991;&#20214;&#21644;Backup&#21103;&#26412;
--force-non-empty-directories <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#35813;&#21442;&#25968;&#26102;&#20505;&#65292;&#20351;&#24471;innobackupex --copy-back&#25110;--moveback&#36873;&#39033;&#36716;&#31227;&#25991;&#20214;&#21040;&#38750;&#31354;&#30446;&#24405;&#65292;&#24050;&#23384;&#22312;&#30340;&#25991;&#20214;&#19981;&#20250;&#34987;&#35206;&#30422;&#12290;&#22914;&#26524;--copy-back&#21644;--move-back&#25991;&#20214;&#38656;&#35201;&#20174;&#22791;&#20221;&#30446;&#24405;&#25335;&#36125;&#19968;&#20010;&#22312;datadir&#24050;&#32463;&#23384;&#22312;&#30340;&#25991;&#20214;&#65292;&#20250;&#25253;&#38169;&#22833;&#36133;</span>
</pre>
</div>

<p>
还原注意事项：
</p>

<ol class="org-ol">
<li>datadir 目录必须为空。除非指定innobackupex
&#x2013;force-non-empty-directorires选项指定，否则&#x2013;copy-back选项不会覆盖</li>

<li>在restore之前,必须shutdown
MySQL实例，不能将一个运行中的实例restore到datadir目录中</li>

<li>由于文件属性会被保留，大部分情况下需要在启动实例之前将文件的属主改
为mysql，这些文件将属于创建备份的用户,执行 <code>chown -R mysql:mysql
   /data/mysql</code> ，以上需要在用户调用innobackupex之前完成</li>
</ol>
</div>
</div>
<div id="outline-container-h:9fbca042-4fb9-4a6b-98c5-965efadaa90d" class="outline-4">
<h4 id="h:9fbca042-4fb9-4a6b-98c5-965efadaa90d">实战案例：利用xtrabackup实现完全备份及还原</h4>
<div class="outline-text-4" id="text-h:9fbca042-4fb9-4a6b-98c5-965efadaa90d">
<p>
注意：目前percona-xtrabackup-24-2.4.18-1.el8.x86_64.rpm不支持CentOS8上的mariadb-10.3版本
</p>

<p>
<b>案例1：新版xtrabackup完全备份及还原</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">1 &#23433;&#35013;xtrabackup&#21253;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20808;&#23433;&#35013;mysql</span>
yum -y install percona-xtrabackup-24-2.4.18-1.el8.x86_64.rpm

2 &#22312;&#21407;&#20027;&#26426;&#20570;&#23436;&#20840;&#22791;&#20221;&#21040;/backup
<span style="color: #b22222;">#</span><span style="color: #b22222;">/backup/base&#30446;&#24405;&#19981;&#38656;&#20107;&#20808;&#21019;&#24314;</span>
mkdir /backup
xtrabackup -uroot -pxxx --backup --target-dir=/backup/base

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#26631;&#20027;&#26426;&#26080;&#38656;&#21019;&#24314;/backup&#30446;&#24405;&#65292;&#30452;&#25509;&#30452;&#25509;&#22797;&#21046;&#30446;&#24405;&#26412;&#36523;</span>
scp -r /backup/ &#30446;&#26631;&#20027;&#26426;:/

3 &#22312;&#30446;&#26631;&#20027;&#26426;&#19978;&#36824;&#21407;
1&#65289;&#39044;&#20934;&#22791;&#65306;&#30830;&#20445;&#25968;&#25454;&#19968;&#33268;&#65292;&#25552;&#20132;&#23436;&#25104;&#30340;&#20107;&#21153;&#65292;&#22238;&#28378;&#26410;&#23436;&#25104;&#30340;&#20107;&#21153;
xtrabackup --prepare --target-dir=/backup/base
2&#65289;&#22797;&#21046;&#21040;&#25968;&#25454;&#24211;&#30446;&#24405;
&#27880;&#24847;&#65306;&#25968;&#25454;&#24211;&#30446;&#24405;&#24517;&#39035;&#20026;&#31354;&#65292;MySQL&#26381;&#21153;&#19981;&#33021;&#21551;&#21160;
xtrabackup --copy-back --target-dir=/backup/base
3&#65289;&#36824;&#21407;&#23646;&#24615;
chown -R mysql:mysql /var/lib/mysql
4&#65289;&#21551;&#21160;&#26381;&#21153;
systemctl start mariadb
</pre>
</div>

<p>
<b>案例2：旧版xtrabackup完全备份及还原</b>
</p>

<p>
2.3之前版本
</p>

<p>
1 在源主机备份
</p>

<div class="org-src-container">
<pre class="src src-sh">innobackupex --user=root /backup
scp -r /backup/2018-02-23_11-55-57/     &#30446;&#26631;&#20027;&#26426;:/data/
</pre>
</div>

<p>
2 在目标主机预准备并还原
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#39044;&#20934;&#22791;</span>
innobackupex --apply-log /data/2018-02-23_11-55-57/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36824;&#21407;&#36807;&#31243;</span>
systemctl stop mariadb
rm -rf /var/lib/mysql/*
innobackupex --copy-back /data/2018-02-23_11-55-57/
chown -R mysql.mysql /var/lib/mysql/
systemctl start mariadb
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8786f2f2-6407-4e69-b4ac-017248ffe81c" class="outline-4">
<h4 id="h:8786f2f2-6407-4e69-b4ac-017248ffe81c">实战案例：利用xtrabackup完全，增量备份及还原</h4>
<div class="outline-text-4" id="text-h:8786f2f2-6407-4e69-b4ac-017248ffe81c">
<p>
<b>案例1：新版xtrabackup完全，增量备份及还原</b>
</p>


<figure id="orgfbc4fc4">
<img src="./images/20200614203320210.png" alt="20200614203320210.png" width="60%">

</figure>

<div class="org-src-container">
<pre class="src src-sh">1 &#22791;&#20221;&#36807;&#31243;
1&#65289;&#23436;&#20840;&#22791;&#20221;&#65306;
mkdir /backup/
xtrabackup -uroot -pxxx --backup --target-dir=/backup/base
2&#65289;&#31532;&#19968;&#27425;&#20462;&#25913;&#25968;&#25454;
3&#65289;&#31532;&#19968;&#27425;&#22686;&#37327;&#22791;&#20221;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22686;&#37327;&#22791;&#20221;&#26159;&#22522;&#20110;&#21069;&#19968;&#20010;&#22791;&#20221;</span>
xtrabackup -uroot -pxxx --backup --target-dir=/backup/inc1 --incremental-basedir=/backup/base

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;xtrabackup&#30456;&#20851;&#25991;&#20214;</span>
cat /backup/inc1/xtrabackup_info
cat /backup/inc1/xtrabackup_checkpoints

4&#65289;&#31532;&#20108;&#27425;&#20462;&#25913;&#25968;&#25454;
5&#65289;&#31532;&#20108;&#27425;&#22686;&#37327;
xtrabackup -uroot -pxxx --backup --target-dir=/backup/inc2 --incremental-basedir=/backup/inc1
6&#65289;scp -r /backup/* &#30446;&#26631;&#20027;&#26426;:/backup/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#36807;&#31243;&#29983;&#25104;&#19977;&#20010;&#22791;&#20221;&#30446;&#24405;</span>
/backup/{base&#65292;inc1&#65292;inc2}

2&#36824;&#21407;&#36807;&#31243; &#65288;&#24819;&#35937;&#25104;&#25166;&#21475;&#34955;&#65289;
1&#65289;&#39044;&#20934;&#22791;&#23436;&#25104;&#22791;&#20221;&#65292;&#27492;&#36873;&#39033;--apply-log-only &#38459;&#27490;&#22238;&#28378;&#26410;&#23436;&#25104;&#30340;&#20107;&#21153;
xtrabackup --prepare --apply-log-only --target-dir=/backup/base
2&#65289;&#21512;&#24182;&#31532;1&#27425;&#22686;&#37327;&#22791;&#20221;&#21040;&#23436;&#20840;&#22791;&#20221;&#65292;
xtrabackup --prepare --apply-log-only --target-dir=/backup/base --incremental-dir=/backup/inc1
3&#65289;&#21512;&#24182;&#31532;2&#27425;&#22686;&#37327;&#22791;&#20221;&#21040;&#23436;&#20840;&#22791;&#20221;&#65306;&#26368;&#21518;&#19968;&#27425;&#36824;&#21407;&#19981;&#38656;&#35201;&#21152;&#36873;&#39033;--apply-log-only
xtrabackup --prepare --target-dir=/backup/base --incremental-dir=/backup/inc2

4&#65289;&#22797;&#21046;&#21040;&#25968;&#25454;&#24211;&#30446;&#24405;&#65292;&#27880;&#24847;&#25968;&#25454;&#24211;&#30446;&#24405;&#24517;&#39035;&#20026;&#31354;&#65292;MySQL&#26381;&#21153;&#19981;&#33021;&#21551;&#21160;
xtrabackup --copy-back --target-dir=/backup/base
5&#65289;&#36824;&#21407;&#23646;&#24615;&#65306;chown -R mysql:mysql /data/mysql
6&#65289;&#21551;&#21160;&#26381;&#21153;&#65306;systemctl start mariadb
</pre>
</div>

<p>
<b>案例2：旧版xtrabackup完全，增量备份及还原</b>
</p>

<p>
2.3之前的版本
</p>

<p>
1 在源主机备份
</p>

<div class="org-src-container">
<pre class="src src-sh">innobackupex /backup
mkdir /backup/inc{1,2}
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#25968;&#25454;&#24211;&#20869;&#23481;</span>
innobackupex --incremental /backup/inc1 --incremental-basedir=/backup/2018-02-23_14-21-42&#65288;&#23436;&#20840;&#22791;&#20221;&#29983;&#25104;&#30340;&#36335;&#24452;&#65289;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20877;&#27425;&#20462;&#25913;&#25968;&#25454;&#24211;&#20869;&#23481;</span>
innobackupex --incremental /backup/inc2 --incremental-basedir=/backup/inc1/2018-02-23_14-26-17 &#65288;&#19978;&#27425;&#22686;&#37327;&#22791;&#20221;&#29983;&#25104;&#30340;&#36335;&#24452;&#65289;
scp -r /backup/* &#30446;&#26631;&#20027;&#26426;:/data/
</pre>
</div>

<p>
2 在目标主机还原
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#39044;&#20934;&#22791;&#36807;&#31243;</span>
innobackupex --apply-log --redo-only /data/2018-02-23_14-21-42/
innobackupex --apply-log --redo-only /data/2018-02-23_14-21-42/ --incremental-dir=/data/inc1/2018-02-23_14-26-17
innobackupex --apply-log /data/2018-02-23_14-21-42/ --incremental-dir=/data/inc2/2018-02-23_14-28-29/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36824;&#21407;&#36807;&#31243;</span>
&#19981;&#21551;&#21160;mariadb
systemctl stop mariadb
rm -rf /var/lib/mysql/*
innobackupex --copy-back /data/2018-02-23_14-21-42/
chown -R mysql.mysql /var/lib/mysql/
systemctl start mariadb
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5d8831e8-cf5b-4c05-9303-3c8c3a18755c" class="outline-4">
<h4 id="h:5d8831e8-cf5b-4c05-9303-3c8c3a18755c">实战案例：xtrabackup单表导出和导入</h4>
<div class="outline-text-4" id="text-h:5d8831e8-cf5b-4c05-9303-3c8c3a18755c">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20986;</span>
1 &#21333;&#34920;&#22791;&#20221;
innobackupex -uroot -pxxx --include=<span style="color: #8b2252;">'hellodb.students'</span> /backup
2&#22791;&#20221;&#34920;&#32467;&#26500;
mysql -e <span style="color: #8b2252;">'show create table hellodb.students'</span> &gt; student.sql
3&#21024;&#38500;&#34920;
mysql -e <span style="color: #8b2252;">'drop table hellodb.students'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20986;</span>
4 innobackupex --apply-log --export /backups/2018-02-23_15-03-23/

5 &#21019;&#24314;&#34920;
    mysql&gt;CREATE TABLE <span style="color: #ff00ff;">`students`</span> (
        <span style="color: #ff00ff;">`StuID`</span> int(10) unsigned NOT NULL AUTO_INCREMENT,
        <span style="color: #ff00ff;">`Name`</span> varchar(50) NOT NULL,
        <span style="color: #ff00ff;">`Age`</span> tinyint(3) unsigned NOT NULL,
        <span style="color: #ff00ff;">`Gender`</span> enum(<span style="color: #8b2252;">'F'</span>,<span style="color: #8b2252;">'M'</span>) NOT NULL,
        <span style="color: #ff00ff;">`ClassID`</span> tinyint(3) unsigned DEFAULT NULL,
        <span style="color: #ff00ff;">`TeacherID`</span> int(10) unsigned DEFAULT NULL,
        PRIMARY KEY (<span style="color: #ff00ff;">`StuID`</span>)
) <span style="color: #a0522d;">ENGINE</span>=InnoDB <span style="color: #a0522d;">AUTO_INCREMENT</span>=26 DEFAULT <span style="color: #a0522d;">CHARSET</span>=utf8
6 &#21024;&#38500;&#34920;&#31354;&#38388;
alter table students discard tablespace;
7 cp /backups/2018-02-23_15-03-23/hellodb/students.{cfg,exp,ibd}
/var/lib/mysql/hellodb/
8 chown -R mysql.mysql /var/lib/mysql/hellodb/
9 mysql&gt;alter table students import tablespace;
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:15552be7-052b-4781-8129-4eba774d8564" class="outline-2">
<h2 id="h:15552be7-052b-4781-8129-4eba774d8564">MySQL 集群 Cluster</h2>
<div class="outline-text-2" id="text-h:15552be7-052b-4781-8129-4eba774d8564">
</div>
<div id="outline-container-h:1486d879-d01d-41b8-8ba1-2b1e4490767f" class="outline-3">
<h3 id="h:1486d879-d01d-41b8-8ba1-2b1e4490767f">MySQL主从复制</h3>
<div class="outline-text-3" id="text-h:1486d879-d01d-41b8-8ba1-2b1e4490767f">
<p>
服务性能扩展方式:
</p>
<ul class="org-ul">
<li>Scale Up，向上扩展，垂直扩展 （给予更好的配置）</li>
<li>Scale Out，向外扩展，横向扩展 （更多的服务器）</li>
</ul>
</div>
<div id="outline-container-h:dc2e32b0-3f12-4959-a99a-3527784d344e" class="outline-4">
<h4 id="h:dc2e32b0-3f12-4959-a99a-3527784d344e">主从复制架构和原理</h4>
<div class="outline-text-4" id="text-h:dc2e32b0-3f12-4959-a99a-3527784d344e">
</div>
<div id="outline-container-h:ca0fb76a-662c-4e33-a7bc-c19d54688784" class="outline-5">
<h5 id="h:ca0fb76a-662c-4e33-a7bc-c19d54688784">MySQL的主从复制</h5>
<div class="outline-text-5" id="text-h:ca0fb76a-662c-4e33-a7bc-c19d54688784">
<ul class="org-ul">
<li>读写分离</li>
<li>复制：每个节点都有相同的数据集，向外扩展，基于二进制日志的单向复制</li>
</ul>
</div>
</div>
<div id="outline-container-h:fe0aed3a-1860-496b-b35d-8e08ca68e4ab" class="outline-5">
<h5 id="h:fe0aed3a-1860-496b-b35d-8e08ca68e4ab">复制的功用</h5>
<div class="outline-text-5" id="text-h:fe0aed3a-1860-496b-b35d-8e08ca68e4ab">
<ul class="org-ul">
<li>负载均衡读操作</li>
<li>备份</li>
<li>高可用和故障切换</li>
<li>数据分布</li>
<li>MySQL升级测试</li>
</ul>
</div>
</div>
<div id="outline-container-h:226fca84-1b26-42d6-9028-bd9be49f1c2b" class="outline-5">
<h5 id="h:226fca84-1b26-42d6-9028-bd9be49f1c2b">复制架构</h5>
<div class="outline-text-5" id="text-h:226fca84-1b26-42d6-9028-bd9be49f1c2b">
<p>
<b>一主一从复制架构</b>
</p>


<figure id="org73c4f6f">
<img src="./images/Snipaste_2023-05-15_22-13-55.png" alt="Snipaste_2023-05-15_22-13-55.png" width="60%">

</figure>

<p>
<b>一主多从复制架构</b>
</p>


<figure id="org888cb12">
<img src="./images/Snipaste_2023-05-15_22-15-07.png" alt="Snipaste_2023-05-15_22-15-07.png" width="60%">

</figure>
</div>
</div>
<div id="outline-container-h:1be6945f-6e86-46dd-996b-832e93941f73" class="outline-5">
<h5 id="h:1be6945f-6e86-46dd-996b-832e93941f73">主从复制原理</h5>
<div class="outline-text-5" id="text-h:1be6945f-6e86-46dd-996b-832e93941f73">
<p>
面试常问
</p>


<figure id="org992eba4">
<img src="./images/20200704141756588.png" alt="20200704141756588.png" width="60%">

</figure>



<figure id="org1235237">
<img src="./images/Snipaste_2023-05-15_22-15-53.png" alt="Snipaste_2023-05-15_22-15-53.png" width="60%">

</figure>

<p>
<b>主从复制相关线程</b>
</p>

<ul class="org-ul">
<li><p>
主节点：必须开启二进制日志功能，数据更新后同时把更新内容写入二进制文件中
</p>

<p>
<b>dump Thread</b> ：为每个Slave的I/O Thread启动一个dump线程，用于向其发送binary log events
</p></li>

<li><p>
从节点：建议开启二进制日志功能，可以预防主服务器挂掉，上位
</p>

<p>
<b>I/O Thread</b> ：向Master请求二进制日志事件，并保存于中继日志relay log中
</p>

<p>
<b>SQL Thread</b> ：从中继日志中读取日志事件，在本地完成重放
</p></li>
</ul>

<p>
<b>跟复制功能相关的文件</b>:
</p>

<ul class="org-ul">
<li><b>master.info</b>: 用于保存slave连接至master时的相关信息，例如账号、密码、服务器地址等</li>
<li><b>relay-log.info</b>: 保存在当前slave节点上已经复制的当前二进制日志和本地relay log日志的对应关系</li>
</ul>

<p>
范例: 中继日志
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@slave ~]#file /var/lib/mysql/mariadb-relay-bin.000001
/var/lib/mysql/mariadb-relay-bin.000001: MySQL replication log, server id 18 MySQL V5+, server version 10.3.17-MariaDB-log

[root@slave ~]#mysqlbinlog /var/lib/mysql/mariadb-relay-bin.000001|head
/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/;
/*!40019 SET @@session.max_insert_delayed_threads=0*/;
/*!50003 SET @<span style="color: #a0522d;">OLD_COMPLETION_TYPE</span>=@@COMPLETION_TYPE,<span style="color: #a0522d;">COMPLETION_TYPE</span>=0*/;
DELIMITER /*!*/;
<span style="color: #b22222;"># </span><span style="color: #b22222;">at 4</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">200615 17:58:48 server id 18 end_log_pos 256 CRC32 0x7bd00c79 Start:</span>
binlog v 4, server v 10.3.17-MariaDB-log created 200615 17:58:48
BINLOG <span style="color: #8b2252;">'</span>
<span style="color: #8b2252;">WEbnXg8cAAAA/AAAAAABAAAAAAQAMTAuMy4xNy1NYXJpYURCLWxvZwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEzgNAAgAEgAEBAQEEgAA5AAEGggAAAAICAgCAAAACgoKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:aef021ab-8d3a-4f17-862b-77628f1019d9" class="outline-5">
<h5 id="h:aef021ab-8d3a-4f17-862b-77628f1019d9">主从复制特点</h5>
<div class="outline-text-5" id="text-h:aef021ab-8d3a-4f17-862b-77628f1019d9">
<ul class="org-ul">
<li>异步复制：客户端性能良好</li>
<li>主从数据不一致比较常见</li>
</ul>
</div>
</div>
<div id="outline-container-h:d3a6bad6-75dd-4e13-a777-fabeba439737" class="outline-5">
<h5 id="h:d3a6bad6-75dd-4e13-a777-fabeba439737">各种复制架构</h5>
<div class="outline-text-5" id="text-h:d3a6bad6-75dd-4e13-a777-fabeba439737">

<figure id="org1f9bf45">
<img src="./images/Snipaste_2023-05-15_22-26-33.png" alt="Snipaste_2023-05-15_22-26-33.png" width="60%">

</figure>

<ul class="org-ul">
<li>一Master/一Slave</li>
<li>一主多从</li>
<li>从服务器还可以再有从服务器（级联，复制延迟大）</li>
<li>Master/Master</li>
<li>一从多主:适用于多个不同数据库</li>
<li>环状复制</li>
</ul>

<p>
<b>复制需要考虑二进制日志事件记录格式</b>
</p>

<ul class="org-ul">
<li>STATEMENT（5.0之前），MariaDB5.5默认使用此格式。会造成主从数据不一致</li>
<li>ROW（5.1之后，推荐）,MySQL8.0默认使用此格式</li>
<li>MIXED：MariaDB10.3默认使用此格式</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:2fc749dc-0a2f-42d7-94c2-bd00df868ecf" class="outline-4">
<h4 id="h:2fc749dc-0a2f-42d7-94c2-bd00df868ecf">实现主从复制配置</h4>
<div class="outline-text-4" id="text-h:2fc749dc-0a2f-42d7-94c2-bd00df868ecf">
<p>
参考官网
</p>

<ul class="org-ul">
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/replication-configuration.html">https://dev.mysql.com/doc/refman/8.0/en/replication-configuration.html</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/replication-configuration.html">https://dev.mysql.com/doc/refman/5.7/en/replication-configuration.html</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.5/en/replication-configuration.html">https://dev.mysql.com/doc/refman/5.5/en/replication-configuration.html</a></li>
<li><a href="https://mariadb.com/kb/en/library/setting-up-replication/">https://mariadb.com/kb/en/library/setting-up-replication/</a></li>
</ul>

<p>
<b>主节点配置</b>:
</p>

<p>
(1) 启用二进制日志
</p>

<div class="org-src-container">
<pre class="src src-sh">[mysqld]
log_bin
</pre>
</div>

<p>
(2) 为当前节点设置一个全局惟一的ID号
</p>

<div class="org-src-container">
<pre class="src src-sh">[mysqld]
server-id=#
log-basename=master <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#36873;&#39033;&#65292;&#35774;&#32622;datadir&#20013;&#26085;&#24535;&#21517;&#31216;&#65292;&#30830;&#20445;&#19981;&#20381;&#36182;&#20027;&#26426;&#21517;</span>
</pre>
</div>

<p>
说明：
</p>
<div class="org-src-container">
<pre class="src src-sh">server-id&#30340;&#21462;&#20540;&#33539;&#22260;
1 to 4294967295 (&gt;= MariaDB 10.2.2)&#65292;&#40664;&#35748;&#20540;&#20026;1
0 to 4294967295 (&lt;= MariaDB10.2.1)&#65292;&#40664;&#35748;&#20540;&#20026;0&#65292;&#22914;&#26524;&#20174;&#33410;&#28857;&#20026;0&#65292;&#25152;&#26377;master&#37117;&#23558;&#25298;&#32477;&#27492;slave&#30340;&#36830;&#25509;
</pre>
</div>

<p>
(3) 查看从二进制日志的文件和位置开始进行复制
</p>

<div class="org-src-container">
<pre class="src src-sh">SHOW MASTER LOG;
</pre>
</div>

<p>
(4) 创建有复制权限的用户账号
</p>

<div class="org-src-container">
<pre class="src src-sh">GRANT REPLICATION SLAVE ON *.* TO <span style="color: #8b2252;">'repluser'</span>@<span style="color: #8b2252;">'HOST'</span> IDENTIFIED BY <span style="color: #8b2252;">'replpass'</span>;
</pre>
</div>

<p>
mysql8.0不能一条命令创建账号加授权，必须要分开写
</p>
<div class="org-src-container">
<pre class="src src-sh">create user xxx@<span style="color: #8b2252;">'10.0.0.%'</span> identified by <span style="color: #8b2252;">'replpass'</span>;
grant replication slave on *.* to <span style="color: #8b2252;">'xxx'</span>@<span style="color: #8b2252;">'10.0.0.%'</span>;
</pre>
</div>

<p>
<b>从节点配置</b>:
</p>

<p>
(1) 启动中继日志
</p>

<div class="org-src-container">
<pre class="src src-sh">[mysqld]
<span style="color: #a0522d;">server_id</span>=#                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#24403;&#21069;&#33410;&#28857;&#35774;&#32622;&#19968;&#20010;&#20840;&#23616;&#24799;&#30340;ID&#21495;</span>
log-bin
<span style="color: #a0522d;">read_only</span>=ON                    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#25968;&#25454;&#24211;&#21482;&#35835;&#65292;&#38024;&#23545;supper user&#26080;&#25928;&#12290;&#19981;&#26159;&#24378;&#21046;&#24615;&#30340;</span>
<span style="color: #a0522d;">relay_log</span>=relay-log             <span style="color: #b22222;">#</span><span style="color: #b22222;">relay log&#30340;&#25991;&#20214;&#36335;&#24452;&#65292;&#40664;&#35748;&#20540;hostname-relay-bin</span>
<span style="color: #a0522d;">relay_log_index</span>=relay-log.index <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#20540;hostname-relay-bin.index</span>
</pre>
</div>

<p>
(2) 使用有复制权限的用户账号连接至主服务器，并启动复制线程
</p>

<div class="org-src-container">
<pre class="src src-sh">CHANGE MASTER TO <span style="color: #a0522d;">MASTER_HOST</span>=<span style="color: #8b2252;">'masterhost'</span>,
<span style="color: #a0522d;">MASTER_USER</span>=<span style="color: #8b2252;">'repluser'</span>,
<span style="color: #a0522d;">MASTER_PASSWORD</span>=<span style="color: #8b2252;">'replpass'</span>,
<span style="color: #a0522d;">MASTER_LOG_FILE</span>=<span style="color: #8b2252;">'mariadb-bin.xxxxxx'</span>,
<span style="color: #a0522d;">MASTER_LOG_POS</span>=#;

START SLAVE [IO_THREAD|SQL_THREAD];  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;2&#20010;&#22797;&#21046;&#32447;&#31243;</span>
SHOW SLAVE STATUS;
</pre>
</div>

<p>
<b>范例：新建主从复制</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#33410;&#28857;</span>
[root@master ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
server-id=8
log-bin
[root@master ~]#systemctl restart mariadb
[root@master ~]#mysql
MariaDB [(none)]&gt; grant replication slave on *.* to repluser@<span style="color: #8b2252;">'192.168.8.%'</span>
identified by <span style="color: #8b2252;">'xxx'</span>;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20108;&#36827;&#21046;&#25991;&#20214;&#21644;&#20301;&#32622;</span>
MariaDB [(none)]&gt; show master logs;
+--------------------+-----------+
| Log_name           | File_size |
+--------------------+-----------+
| mariadb-bin.000001 |     28052 |
| mariadb-bin.000002 |       545 |
+--------------------+-----------+
2 rows<span style="color: #a020f0;"> in</span> set (0.001 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#33410;&#28857;</span>
[root@slave ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
server-id=18

[root@slave ~]#systemctl restart mariadb
[root@slave1 ~]#mysql
MariaDB [(none)]&gt; help change master to
MariaDB [(none)]&gt; CHANGE MASTER TO <span style="color: #a0522d;">MASTER_HOST</span>=<span style="color: #8b2252;">'192.168.8.8'</span>,
<span style="color: #a0522d;">MASTER_USER</span>=<span style="color: #8b2252;">'repluser'</span>, <span style="color: #a0522d;">MASTER_PASSWORD</span>=<span style="color: #8b2252;">'xxx'</span>, <span style="color: #a0522d;">MASTER_PORT</span>=3306,
<span style="color: #a0522d;">MASTER_LOG_FILE</span>=<span style="color: #8b2252;">'mariadb-bin.000002'</span>, <span style="color: #a0522d;">MASTER_LOG_POS</span>=545;

MariaDB [(none)]&gt; start slave;
Query OK, 0 rows affected, 1 warning (0.000 sec)
MariaDB [(none)]&gt; show slave status\G
************************* 1. row ***************************
                Slave_IO_State: Waiting for master to send event
                   Master_Host: 192.168.8.8
                   Master_User: repluser
                   Master_Port: 3306
                 Connect_Retry: 60
               Master_Log_File: mariadb-bin.000002
           Read_Master_Log_Pos: 26987890
                Relay_Log_File: mariadb-relay-bin.000002
                 Relay_Log_Pos: 26987902
         Relay_Master_Log_File: mariadb-bin.000002
              Slave_IO_Running: Yes
             Slave_SQL_Running: Yes
               Replicate_Do_DB:
           Replicate_Ignore_DB:
            Replicate_Do_Table:
        Replicate_Ignore_Table:
       Replicate_Wild_Do_Table:
   Replicate_Wild_Ignore_Table:
                    Last_Errno: 0
                    Last_Error:
                  Skip_Counter: 0
           Exec_Master_Log_Pos: 26987890
               Relay_Log_Space: 26988213
               Until_Condition: None
                Until_Log_File:
                 Until_Log_Pos: 0
            Master_SSL_Allowed: No
            Master_SSL_CA_File: 
            Master_SSL_CA_Path:
               Master_SSL_Cert:
             Master_SSL_Cipher:
                Master_SSL_Key:
         Seconds_Behind_Master: 0     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;&#30340;&#24310;&#36831;&#26102;&#38388;</span>
 Master_SSL_Verify_Server_Cert: No
                 Last_IO_Errno: 0
                 Last_IO_Error:
                Last_SQL_Errno: 0
                Last_SQL_Error:
   Replicate_Ignore_Server_Ids:
              Master_Server_Id: 8
                Master_SSL_Crl:
            Master_SSL_Crlpath:
                    Using_Gtid: No
                   Gtid_IO_Pos:
       Replicate_Do_Domain_Ids:
   Replicate_Ignore_Domain_Ids:
                 Parallel_Mode: conservative
                     SQL_Delay: 0
           SQL_Remaining_Delay: NULL
       Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it
              Slave_DDL_Groups: 34
Slave_Non_Transactional_Groups: 0
    Slave_Transactional_Groups: 100006
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)

&gt;show processlist; <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#26159;&#21542;&#26377;&#22797;&#21046;&#32447;&#31243;&#65292;&#22312;&#20027;&#19978;&#25191;&#34892;&#30475;&#26159;&#21542;&#26377; dump&#32447;&#31243;</span>
</pre>
</div>

<p>
<b>范例：主服务器非新建时,主服务器运行一段时间后，新增从节点服务器</b>
</p>

<p>
如果主节点已经运行了一段时间，且有大量数据时，如何配置并启动slave节点
</p>

<ul class="org-ul">
<li>通过备份恢复数据至从服务器</li>
<li>复制起始位置为备份时，二进制日志文件及其POS</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">&#20027;&#26381;&#21153;&#22120;&#65306;
<span style="color: #b22222;">#</span><span style="color: #b22222;">1. &#20027;&#33410;&#28857;&#37197;&#32622; server-id log-bin</span>
[root@centos8 ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
server-id=8
log-bin
<span style="color: #b22222;">#</span><span style="color: #b22222;">2. &#37325;&#21551;mysql</span>
[root@centos8 ~]#systemctl restart mariadb
[root@centos8 ~]#ll /var/lib/mysql/   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#20986;&#20004;&#20010;&#25991;&#20214;</span>
-rw-rw---- 1 mysql mysql      330 Jun 14 09:50 mariadb-bin.000001
-rw-rw---- 1 mysql mysql       21 Jun 14 09:50 mariadb-bin.index

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26085;&#24535;&#33410;&#28857;</span>
MariaDB [(none)]&gt; show master logs;   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20808;&#26597;&#30475;&#33410;&#28857;&#65292;&#20877;&#21019;&#24314;&#36134;&#25143;</span>
+--------------------+-----------+
| Log_name           | File_size |
+--------------------+-----------+
| mariadb-bin.000001 |       330 |
+--------------------+-----------+
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)


MariaDB [(none)]&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| hellodb            |
| information_schema |
| mysql              |
| performance_schema |
+--------------------+
4 rows<span style="color: #a020f0;"> in</span> set (0.000 sec)
<span style="color: #b22222;">#</span><span style="color: #b22222;">3. &#20840;&#37327;&#22791;&#20221;</span>
[root@centos8 ~]#mkdir /backup/
[root@centos8 ~]#mysqldump -A --single-transaction --master-data=1 -F &gt; /backup/all.sql
[root@centos8 ~]#ll /backup/all.sql
-rw-r--r-- 1 root root 487711 Jun 14 09:55 /backup/all.sql
[root@centos8 ~]#vim /backup/all.sql
CHANGE MASTER TO <span style="color: #a0522d;">MASTER_LOG_FILE</span>=<span style="color: #8b2252;">'mariadb-bin.000002'</span>, <span style="color: #a0522d;">MASTER_LOG_POS</span>=375; 

<span style="color: #b22222;">#</span><span style="color: #b22222;">4. &#20027;&#33410;&#28857;&#19978;&#35201;&#24314;&#31435;&#19968;&#20010;&#21442;&#19982;&#22797;&#21046;&#30340;&#36134;&#25143;</span>
MariaDB [(none)]&gt; grant replication slave on *.* to repluser@<span style="color: #8b2252;">'10.0.0.%'</span> identified by <span style="color: #8b2252;">'xxx'</span>;
<span style="color: #b22222;">#</span><span style="color: #b22222;">repluser&#26159;&#29992;&#25143;&#21517;&#65292;10.0.0.%&#20195;&#34920;&#21487;&#20197;&#20174;&#36825;&#20010;&#32593;&#27573;&#20013;&#20219;&#20309;&#19968;&#20010;&#20027;&#26426;&#36830;&#25509;&#65292;identified by &#25351;&#23450;&#23494;&#30721;</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">5. &#22797;&#21046;&#22791;&#20221;&#25968;&#25454;&#24211;&#21040;&#20174;&#33410;&#28857;</span>
[root@centos8 ~]#scp /backup/all.sql 10.0.0.18:/data


&#20174;&#26381;&#21153;&#22120;&#65306;
<span style="color: #b22222;">#</span><span style="color: #b22222;">6. &#20174;&#33410;&#28857;&#37197;&#32622;server-id read_only&#19981;&#24378;&#21046;&#65292;&#24314;&#35758;&#21152;&#19978;</span>
[root@centos8 ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
server-id=18
<span style="color: #b22222;">#</span><span style="color: #b22222;">7. &#37325;&#21551;mysql&#26381;&#21153;</span>
[root@centos8 ~]#systemctl start mariadb

<span style="color: #b22222;">#</span><span style="color: #b22222;">8. &#20027;&#20174;&#22797;&#21046;&#30340;&#37197;&#32622;</span>
&#26041;&#27861;&#19968;&#65306;&#25913;&#22791;&#20221;&#25991;&#20214;
[root@centos8 ~]#vim /data/all.sql
CHANGE MASTER TO
<span style="color: #a0522d;">MASTER_HOST</span>=<span style="color: #8b2252;">'10.0.0.8'</span>,
<span style="color: #a0522d;">MASTER_USER</span>=<span style="color: #8b2252;">'repluser'</span>,
<span style="color: #a0522d;">MASTER_PASSWORD</span>=<span style="color: #8b2252;">'xxx'</span>,
<span style="color: #a0522d;">MASTER_PORT</span>=3306,                                                         
<span style="color: #a0522d;">MASTER_LOG_FILE</span>=<span style="color: #8b2252;">'mariadb-bin.000002'</span>, <span style="color: #a0522d;">MASTER_LOG_POS</span>=375;

CREATE DATABASE /*!32312 IF NOT EXISTS*/ <span style="color: #ff00ff;">`hellodb`</span> /*!40100 DEFAULT CHARACTER SET utf8 */;

&#26041;&#27861;&#20108;&#65306;&#21629;&#20196;&#34892;
MariaDB [(none)]&gt; help change master to
MariaDB [(none)]&gt; CHANGE MASTER TO <span style="color: #a0522d;">MASTER_HOST</span>=<span style="color: #8b2252;">'10.0.0.8'</span>,
<span style="color: #a0522d;">MASTER_USER</span>=<span style="color: #8b2252;">'repluser'</span>, <span style="color: #a0522d;">MASTER_PASSWORD</span>=<span style="color: #8b2252;">'xxx'</span>, <span style="color: #a0522d;">MASTER_PORT</span>=3306,
<span style="color: #a0522d;">MASTER_LOG_FILE</span>=<span style="color: #8b2252;">'mariadb-bin.000002'</span>, <span style="color: #a0522d;">MASTER_LOG_POS</span>=375;

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20851;&#38381;2&#36827;&#21046;&#26085;&#24535;</span>
&gt; set <span style="color: #a0522d;">sql_log_bin</span>=0; <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20020;&#26102;&#20851;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">9. &#36824;&#21407;&#25968;&#25454;&#24211;&#21644;&#22797;&#21046;&#20449;&#24687;</span>
[root@centos8 ~]#mysql &lt; /data/all.sql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27492;&#26102;&#22797;&#21046;&#20449;&#24687;&#24050;&#32463;&#20934;&#22791;&#22909;&#20102;</span>
MariaDB [(none)]&gt; show slave status\G
************************* 1. row ***************************
                Slave_IO_State: 
                   Master_Host: 10.0.0.8
                   Master_User: repluser
                   Master_Port: 3306
                 Connect_Retry: 60
               Master_Log_File: mariadb-bin.000002
           Read_Master_Log_Pos: 375
                Relay_Log_File: mariadb-relay-bin.000001
                 Relay_Log_Pos: 4
         Relay_Master_Log_File: mariadb-bin.000002
              Slave_IO_Running: No         <span style="color: #b22222;">#</span><span style="color: #b22222;">I/O&#32447;&#31243;&#26410;&#21551;&#29992;</span>
             Slave_SQL_Running: No         <span style="color: #b22222;">#</span><span style="color: #b22222;">SQL&#32447;&#31243;&#26410;&#21551;&#29992;</span>
               Replicate_Do_DB: 
           Replicate_Ignore_DB: 
            Replicate_Do_Table: 
        Replicate_Ignore_Table: 
       Replicate_Wild_Do_Table: 
   Replicate_Wild_Ignore_Table: 
                    Last_Errno: 0
                    Last_Error: 
                  Skip_Counter: 0
           Exec_Master_Log_Pos: 375
               Relay_Log_Space: 256
               Until_Condition: None
                Until_Log_File: 
                 Until_Log_Pos: 0
            Master_SSL_Allowed: No
            Master_SSL_CA_File: 
            Master_SSL_CA_Path: 
               Master_SSL_Cert: 
             Master_SSL_Cipher: 
                Master_SSL_Key: 
         Seconds_Behind_Master: NULL  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;&#24310;&#26399;&#65292;&#20027;&#33410;&#28857;&#21644;&#20174;&#33410;&#28857;&#22797;&#21046;&#24046;&#20102;&#22810;&#38271;&#26102;&#38388;&#65292;&#27880;&#24847;&#35266;&#23519;&#65292;&#26368;&#22909;&#26159;0</span>
 Master_SSL_Verify_Server_Cert: No
                 Last_IO_Errno: 0
                 Last_IO_Error: 
                Last_SQL_Errno: 0
                Last_SQL_Error: 
   Replicate_Ignore_Server_Ids: 
              Master_Server_Id: 0
                Master_SSL_Crl: 
            Master_SSL_Crlpath: 
                    Using_Gtid: No
                   Gtid_IO_Pos: 
       Replicate_Do_Domain_Ids: 
   Replicate_Ignore_Domain_Ids: 
                 Parallel_Mode: conservative
                     SQL_Delay: 0
           SQL_Remaining_Delay: NULL
       Slave_SQL_Running_State: 
              Slave_DDL_Groups: 0
Slave_Non_Transactional_Groups: 0
    Slave_Transactional_Groups: 0
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26032;&#22686;&#21152;&#30340;&#25991;&#20214;</span>
[root@centos8 ~]#ll /var/lib/mysql/ -t
total 122952
-rw-rw---- 1 mysql mysql 50331648 Jun 14 10:31 ib_logfile0
-rw-rw---- 1 mysql mysql 12582912 Jun 14 10:31 ibdata1
drwx------ 2 mysql mysql     4096 Jun 14 10:31 mysql
drwx------ 2 mysql mysql      272 Jun 14 10:31 hellodb
-rw-rw---- 1 mysql mysql       56 Jun 14 10:31 relay-log.info  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20108;&#36827;&#21046;&#26085;&#24535;&#21644;&#20013;&#32487;&#26085;&#24535;&#30340;&#23545;&#24212;&#20851;&#31995;</span>
-rw-rw---- 1 mysql mysql      256 Jun 14 10:31 mariadb-relay-bin.000001
-rw-rw---- 1 mysql mysql       27 Jun 14 10:31 mariadb-relay-bin.index  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;&#19979;&#26469;&#30340;&#20013;&#32487;&#26085;&#24535;</span>
-rw-rw---- 1 mysql mysql      154 Jun 14 10:31 master.info  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#33410;&#28857;&#30340;&#20449;&#24687;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#20004;&#20010;&#32447;&#31243;</span>
MariaDB [(none)]&gt; show processlist;   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#26159;&#20174;&#33410;&#28857;&#21551;&#29992;&#21069;&#30340;&#36827;&#31243;</span>
+----+-------------+-----------+------+---------+------+--------------------------+------------------+----------+
| Id | User        | Host      | db   | Command | Time | State                    | Info             | Progress |
+----+-------------+-----------+------+---------+------+--------------------------+------------------+----------+
|  2 | system user |           | NULL | Daemon  | NULL | InnoDB purge worker      | NULL             |    0.000 |
|  1 | system user |           | NULL | Daemon  | NULL | InnoDB purge coordinator | NULL             |    0.000 |
|  3 | system user |           | NULL | Daemon  | NULL | InnoDB purge worker      | NULL             |    0.000 |
|  4 | system user |           | NULL | Daemon  | NULL | InnoDB purge worker      | NULL             |    0.000 |
|  5 | system user |           | NULL | Daemon  | NULL | InnoDB shutdown handler  | NULL             |    0.000 |
|  9 | root        | localhost | NULL | Query   |    0 | Init                     | show processlist |    0.000 |
+----+-------------+-----------+------+---------+------+--------------------------+------------------+----------+
6 rows<span style="color: #a020f0;"> in</span> set (0.000 sec)


<span style="color: #b22222;">#</span><span style="color: #b22222;">10. &#24320;&#21551;&#22797;&#21046;&#32447;&#31243;</span>
MariaDB [(none)]&gt; start slave;
Query OK, 0 rows affected (0.002 sec)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24674;&#22797;&#20108;&#36827;&#21046;&#26085;&#24535;</span>
&gt;set <span style="color: #a0522d;">sql_log_bin</span>=1; <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20020;&#26102;&#24320;&#65292;&#35760;&#24405;&#24403;&#21069;&#25805;&#20316;&#12290;</span>

MariaDB [(none)]&gt; show slave status\G
************************* 1. row ***************************
                Slave_IO_State: Waiting for master to send event
                   Master_Host: 10.0.0.8
                   Master_User: repluser
                   Master_Port: 3306
                 Connect_Retry: 60
               Master_Log_File: mariadb-bin.000002
           Read_Master_Log_Pos: 572
                Relay_Log_File: mariadb-relay-bin.000002
                 Relay_Log_Pos: 754
         Relay_Master_Log_File: mariadb-bin.000002
              Slave_IO_Running: Yes          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32447;&#31243;&#24050;&#24320;&#21551;</span>
             Slave_SQL_Running: Yes          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32447;&#31243;&#24050;&#24320;&#21551;</span>
         Seconds_Behind_Master: 0            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;&#24310;&#36831;&#20026;0&#65307;&#35828;&#26126;&#24050;&#32463;&#22797;&#21046;&#25104;&#21151;</span>
                           ...&#30465;&#30053;...

MariaDB [(none)]&gt; show processlist;   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#26159;&#20174;&#33410;&#28857;&#30340;&#36827;&#31243;</span>
+----+-------------+-----------+------+-----------+------+-----------------------------------------------------------------------------+------------------+----------+
| Id | User        | Host      | db   | Command   | Time | State                                                                       | Info             | Progress |
+----+-------------+-----------+------+-----------+------+-----------------------------------------------------------------------------+------------------+----------+
|  2 | system user |           | NULL | Daemon    | NULL | InnoDB purge worker                                                         | NULL             |    0.000 |
|  1 | system user |           | NULL | Daemon    | NULL | InnoDB purge coordinator                                                    | NULL             |    0.000 |
|  3 | system user |           | NULL | Daemon    | NULL | InnoDB purge worker                                                         | NULL             |    0.000 |
|  4 | system user |           | NULL | Daemon    | NULL | InnoDB purge worker                                                         | NULL             |    0.000 |
|  5 | system user |           | NULL | Daemon    | NULL | InnoDB shutdown handler                                                     | NULL             |    0.000 |
| 13 | system user |           | NULL | Slave_IO  |  143 | Waiting for master to send event                                            | NULL             |    0.000 |
| 14 | system user |           | NULL | Slave_SQL |  143 | Slave has read all relay log; waiting for the slave I/O thread to update it | NULL             |    0.000 |
| 15 | root        | localhost | NULL | Query     |    0 | Init                                                                        | show processlist |    0.000 |
+----+-------------+-----------+------+-----------+------+-----------------------------------------------------------------------------+------------------+----------+
8 rows<span style="color: #a020f0;"> in</span> set (0.000 sec)

MariaDB [(none)]&gt; show processlist;   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#33410;&#28857;&#21551;&#29992;&#21518;&#65292;&#20027;&#33410;&#28857;&#19978;&#30340;Dump&#32447;&#31243;&#21516;&#26102;&#21551;&#29992;</span>
+----+-------------+-----------------+------+-------------+------+-----------------------------------------------------------------------+------------------+----------+
| Id | User        | Host            | db   | Command     | Time | State                                                                 | Info             | Progress |
+----+-------------+-----------------+------+-------------+------+-----------------------------------------------------------------------+------------------+----------+
|  1 | system user |                 | NULL | Daemon      | NULL | InnoDB purge worker                                                   | NULL             |    0.000 |
|  2 | system user |                 | NULL | Daemon      | NULL | InnoDB purge coordinator                                              | NULL             |    0.000 |
|  3 | system user |                 | NULL | Daemon      | NULL | InnoDB purge worker                                                   | NULL             |    0.000 |
|  4 | system user |                 | NULL | Daemon      | NULL | InnoDB purge worker                                                   | NULL             |    0.000 |
|  5 | system user |                 | NULL | Daemon      | NULL | InnoDB shutdown handler                                               | NULL             |    0.000 |
| 11 | root        | localhost       | NULL | Query       |    0 | Init                                                                  | show processlist |    0.000 |
| 12 | repluser    | 10.0.0.18:55922 | NULL | Binlog Dump |  323 | Master has sent all binlog to slave; waiting for binlog to be updated | NULL             |    0.000 |
+----+-------------+-----------------+------+-------------+------+-----------------------------------------------------------------------+------------------+----------+
7 rows<span style="color: #a020f0;"> in</span> set (0.000 sec)

</pre>
</div>

<p>
简洁步骤：
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#22312;&#20027;&#26381;&#21153;&#22120;&#23436;&#20840;&#22791;&#20221;
[root@master ~]#mysqldump -A -F <span style="color: #b22222;">--</span><span style="color: #b22222;">single-transaction --master-data=1 &gt;</span>
/backup/fullbackup_`<span style="color: #228b22;">date</span> +%F_%T`.<span style="color: #a020f0;">sql</span>
[root@master ~]#ll /backup/
total 2988
-rw-r<span style="color: #b22222;">--</span><span style="color: #b22222;">r-- 1 root root 3055918 Nov 27 17:41 fullbackup_2019-11-27_17:41:17.sql</span>
[root@master ~]#scp /backup/fullbackup_2019-11-27_17\:41\:17.<span style="color: #a020f0;">sql</span> 192.168.8.11:/<span style="color: #a020f0;">data</span>/

#&#24314;&#35758;&#20248;&#21270;&#20027;&#21644;&#20174;&#33410;&#28857;&#26381;&#21153;&#22120;&#30340;&#24615;&#33021;
#<span style="color: #a020f0;">global</span> innodb_flush_log_at_trx_commit=2
#sync_binlog=0

MariaDB [hellodb]&gt; <span style="color: #a020f0;">set</span> <span style="color: #a020f0;">global</span> innodb_flush_log_at_trx_commit=2;
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.001 sec)

MariaDB [hellodb]&gt; show variables <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'sync_binlog'</span>;
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+-------+</span>
| Variable_name | <span style="color: #a020f0;">Value</span> |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+-------+</span>
| sync_binlog   | 0     |
+<span style="color: #b22222;">---------------</span><span style="color: #b22222;">+-------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

#&#23558;&#23436;&#20840;&#22791;&#20221;&#36824;&#21407;&#21040;&#26032;&#30340;&#20174;&#33410;&#28857;
[root@slave ~]#dnf -y install mariadb-server

[root@slave ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
server-id=11
<span style="color: #a020f0;">read</span>-<span style="color: #a020f0;">only</span>

[root@slave ~]#systemctl restart mariadb

#&#37197;&#32622;&#20174;&#33410;&#28857;&#65292;&#20174;&#23436;&#20840;&#22791;&#20221;&#30340;&#20301;&#32622;&#20043;&#21518;&#24320;&#22987;&#22797;&#21046;
[root@slave ~]#grep <span style="color: #8b2252;">'^CHANGE MASTER'</span> /<span style="color: #a020f0;">data</span>/fullbackup_2019-11-27_17\:41\:17.<span style="color: #a020f0;">sql</span>
CHANGE MASTER <span style="color: #a020f0;">TO</span> MASTER_LOG_FILE=<span style="color: #8b2252;">'mariadb-bin.000003'</span>, MASTER_LOG_POS=389;
[root@slave ~]#vim /<span style="color: #a020f0;">data</span>/fullbackup_2019-11-27_17\:41\:17.<span style="color: #a020f0;">sql</span>
CHANGE MASTER <span style="color: #a020f0;">TO</span>
MASTER_HOST=<span style="color: #8b2252;">'192.168.8.10'</span>,
MASTER_USER=<span style="color: #8b2252;">'repluser'</span>,
MASTER_PASSWORD=<span style="color: #8b2252;">'xxx'</span>,
MASTER_PORT=3306,
MASTER_LOG_FILE=<span style="color: #8b2252;">'mariadb-bin.000003'</span>, MASTER_LOG_POS=389;

[root@slave ~]#mysql &lt; /<span style="color: #a020f0;">data</span>/fullbackup_2019-11-27_17\:41\:17.<span style="color: #a020f0;">sql</span>
[root@slave ~]#mysql
Welcome <span style="color: #a020f0;">to</span> the MariaDB monitor. Commands <span style="color: #a020f0;">end</span> <span style="color: #a020f0;">with</span> ; <span style="color: #a020f0;">or</span> \g.
Your MariaDB <span style="color: #a020f0;">connection</span> id <span style="color: #a020f0;">is</span> 9
Server version: 10.3.11-MariaDB MariaDB Server
Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab <span style="color: #a020f0;">and</span> others.
<span style="color: #a020f0;">Type</span> <span style="color: #8b2252;">'help;'</span> <span style="color: #a020f0;">or</span> <span style="color: #8b2252;">'\h'</span> <span style="color: #a020f0;">for</span> help. <span style="color: #a020f0;">Type</span> <span style="color: #8b2252;">'\c'</span> <span style="color: #a020f0;">to</span> clear the <span style="color: #a020f0;">current</span> <span style="color: #a020f0;">input</span> <span style="color: #a020f0;">statement</span>.

MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; show slave status\G;
************************* 1. <span style="color: #228b22;">row</span> ***************************
               Slave_IO_State:
                   Master_Host: 192.168.8.10
                   Master_User: repluser
                   Master_Port: 3306
                 Connect_Retry: 60
               Master_Log_File: mariadb-bin.000003
           Read_Master_Log_Pos: 389
                Relay_Log_File: mariadb-relay-bin.000001
                 Relay_Log_Pos: 4
         Relay_Master_Log_File: mariadb-bin.000003
              Slave_IO_Running: <span style="color: #a020f0;">No</span>
             Slave_SQL_Running: <span style="color: #a020f0;">No</span>
               Replicate_Do_DB:
           Replicate_Ignore_DB:
            Replicate_Do_Table:
        Replicate_Ignore_Table:
       Replicate_Wild_Do_Table:
   Replicate_Wild_Ignore_Table:
                    Last_Errno: 0
                    Last_Error:
                  Skip_Counter: 0
           Exec_Master_Log_Pos: 389
               Relay_Log_Space: 256
               Until_Condition: <span style="color: #a020f0;">None</span>
                Until_Log_File:
                 Until_Log_Pos: 0
            Master_SSL_Allowed: <span style="color: #a020f0;">No</span>
            Master_SSL_CA_File:
            Master_SSL_CA_Path:
               Master_SSL_Cert:
             Master_SSL_Cipher: 
                Master_SSL_Key: 
         Seconds_Behind_Master: <span style="color: #a020f0;">NULL</span>
 Master_SSL_Verify_Server_Cert: <span style="color: #a020f0;">No</span>
                 Last_IO_Errno: 0
                 Last_IO_Error:
                Last_SQL_Errno: 0
                Last_SQL_Error:
   Replicate_Ignore_Server_Ids:
              Master_Server_Id: 0
                Master_SSL_Crl:
            Master_SSL_Crlpath:
                    Using_Gtid: <span style="color: #a020f0;">No</span>
                   Gtid_IO_Pos:
       Replicate_Do_Domain_Ids:
   Replicate_Ignore_Domain_Ids:
                 Parallel_Mode: conservative
                     SQL_Delay: 0
           SQL_Remaining_Delay: <span style="color: #a020f0;">NULL</span>
       Slave_SQL_Running_State:
              Slave_DDL_Groups: 0
Slave_Non_Transactional_Groups: 0
    Slave_Transactional_Groups: 0
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; <span style="color: #a020f0;">start</span> slave;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:77d1178c-c61f-4453-936b-f6938a3f2655" class="outline-4">
<h4 id="h:77d1178c-c61f-4453-936b-f6938a3f2655">主从复制相关</h4>
<div class="outline-text-4" id="text-h:77d1178c-c61f-4453-936b-f6938a3f2655">
</div>
<div id="outline-container-h:c3fa4477-f9df-46e4-9f70-aaec9261777d" class="outline-5">
<h5 id="h:c3fa4477-f9df-46e4-9f70-aaec9261777d">限制从服务器为只读</h5>
<div class="outline-text-5" id="text-h:c3fa4477-f9df-46e4-9f70-aaec9261777d">
<div class="org-src-container">
<pre class="src src-mysql">read_only=ON
#注意：此限制对拥有SUPER权限的用户均无效
</pre>
</div>

<p>
注意：以下命令会阻止所有用户, 包括主服务器复制的更新
</p>

<div class="org-src-container">
<pre class="src src-mysql">FLUSH TABLES WITH READ LOCK;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:10a909a1-6ca2-4ce6-a4e0-9994470d6652" class="outline-5">
<h5 id="h:10a909a1-6ca2-4ce6-a4e0-9994470d6652">在从节点清除信息</h5>
<div class="outline-text-5" id="text-h:10a909a1-6ca2-4ce6-a4e0-9994470d6652">
<p>
注意：以下都需要先 STOP SLAVE
</p>

<div class="org-src-container">
<pre class="src src-mysql">RESET SLAVE #从服务器清除master.info ，relay-log.info, relay log ，开始新的relay log
RESET SLAVE ALL #清除所有从服务器上设置的主服务器同步信息，如HOST，PORT, USER和PASSWORD 等
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0164501b-6112-4ef2-b451-ece373f8c9c7" class="outline-5">
<h5 id="h:0164501b-6112-4ef2-b451-ece373f8c9c7">复制错误解决方法</h5>
<div class="outline-text-5" id="text-h:0164501b-6112-4ef2-b451-ece373f8c9c7">
<p>
可以在从服务器忽略几个主服务器的复制事件，此为global变量，或指定跳过事件的ID
</p>

<div class="org-src-container">
<pre class="src src-mysql">#系统变量，指定跳过复制事件的个数
SET GLOBAL sql_slave_skip_counter = N

#服务器选项，只读系统变量，指定跳过事件的ID
[mysqld]
slave_skip_errors=1007|ALL
</pre>
</div>

<p>
案例：个人在slave上执行了插入数据操作导致主从复制阻塞
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">centos7&#19978;mariadb5.5 &#22312;slave&#21019;&#24314;&#24211;&#21644;&#34920;&#65292;&#20877;&#22312;master&#19978;&#21019;&#24314;&#21516;&#21517;&#30340;&#24211;&#21644;&#34920;&#65292;&#20250;&#20986;&#29616;&#22797;&#21046;&#20914;&#31361;&#65292;&#32780;&#22312;centos8&#19978;mariadb10.3&#19978;&#19981;&#20250;&#20914;&#31361;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#28155;&#21152;&#30456;&#21516;&#30340;&#20027;&#38190;&#35760;&#24405;&#37117;&#20250;&#20914;&#31361;</span>
&gt;show slave status\G
...
Laster_Error: &#20914;&#31361;&#21407;&#22240;
...

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#38381;&#20027;&#20174;&#22797;&#21046;</span>
&gt; stop slave;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#36339;&#36807;&#22797;&#21046;&#20107;&#20214;&#25968;</span>
&gt;SET GLOBAL sql_slave_skip_counter = 1;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#20027;&#20174;&#22797;&#21046;</span>
&gt; start slave;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2c146f37-99fa-4776-a394-f038f92b79ed" class="outline-5">
<h5 id="h:2c146f37-99fa-4776-a394-f038f92b79ed">START SLAVE 语句，指定执到特定的点</h5>
<div class="outline-text-5" id="text-h:2c146f37-99fa-4776-a394-f038f92b79ed">
<div class="org-src-container">
<pre class="src src-mysql">START SLAVE [thread_types]
START SLAVE [SQL_THREAD] UNTIL MASTER_LOG_FILE = 'log_name', MASTER_LOG_POS = log_pos
START SLAVE [SQL_THREAD] UNTIL RELAY_LOG_FILE = 'log_name', RELAY_LOG_POS = log_pos

thread_types:
   [thread_type [, thread_type] ... ]

thread_type: IO_THREAD | SQL_THREAD  
</pre>
</div>
</div>
</div>
<div id="outline-container-h:55189aa4-6984-4381-bc37-ce58f2c9b652" class="outline-5">
<h5 id="h:55189aa4-6984-4381-bc37-ce58f2c9b652">保证主从复制的事务安全</h5>
<div class="outline-text-5" id="text-h:55189aa4-6984-4381-bc37-ce58f2c9b652">
<p>
参看<a href="https://mariadb.com/kb/en/library/server-system-variables/">https://mariadb.com/kb/en/library/server-system-variables/</a>
</p>

<p>
在master节点启用参数：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">sync_binlog</span>=1                    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#27425;&#20889;&#21518;&#31435;&#21363;&#21516;&#27493;&#20108;&#36827;&#21046;&#26085;&#24535;&#21040;&#30913;&#30424;&#65292;&#24615;&#33021;&#24046;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#29992;&#21040;&#30340;&#20026;InnoDB&#23384;&#20648;&#24341;&#25806;&#65306;</span>
<span style="color: #a0522d;">innodb_flush_log_at_trx_commit</span>=1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#27425;&#20107;&#21153;&#25552;&#20132;&#31435;&#21363;&#21516;&#27493;&#26085;&#24535;&#20889;&#30913;&#30424;</span>
<span style="color: #a0522d;">sync_master_info</span>=#               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27425;&#20107;&#20214;&#21518;master.info&#21516;&#27493;&#21040;&#30913;&#30424;</span>
</pre>
</div>

<p>
在slave节点启用服务器选项：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25913;&#21040;&#37197;&#32622;&#25991;&#20214;&#20013;</span>
skip-slave-start=ON <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#33258;&#21160;&#21551;&#21160;slave&#12290;&#40664;&#35748;&#20174;&#33410;&#28857;&#21551;&#21160;&#65292;&#23601;&#26159;&#20250;&#31435;&#21363;&#24320;&#21551;&#22797;&#21046;&#32447;&#31243;</span>
</pre>
</div>

<p>
在slave节点启用参数：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">sync_relay_log</span>=#      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27425;&#20889;&#21518;&#21516;&#27493;relay log&#21040;&#30913;&#30424;</span>
<span style="color: #a0522d;">sync_relay_log_info</span>=# <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27425;&#20107;&#21153;&#21518;&#21516;&#27493;relay-log.info&#21040;&#30913;&#30424;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5f799f0f-282a-407b-bf84-dc2fa93ff0be" class="outline-5">
<h5 id="h:5f799f0f-282a-407b-bf84-dc2fa93ff0be">范例：将旧的mysql单机变成主从复制架构</h5>
<div class="outline-text-5" id="text-h:5f799f0f-282a-407b-bf84-dc2fa93ff0be">
<div class="org-src-container">
<pre class="src src-sh">&#20027;&#26381;&#21153;&#22120;&#65306;
<span style="color: #b22222;">#</span><span style="color: #b22222;">1. &#20027;&#33410;&#28857;&#37197;&#32622; server-id log-bin</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">2. &#37325;&#21551;mysql</span>
systemctl restart mysqld
<span style="color: #b22222;">#</span><span style="color: #b22222;">3. &#20840;&#37327;&#22791;&#20221;</span>
mysqldump -A --single-transaction --master-data=1 -F &gt; /backup/all.sql
<span style="color: #b22222;">#</span><span style="color: #b22222;">4. &#20027;&#33410;&#28857;&#19978;&#35201;&#24314;&#31435;&#19968;&#20010;&#21442;&#19982;&#22797;&#21046;&#30340;&#36134;&#25143;</span>
mysql -e <span style="color: #8b2252;">'create user repluser@"10.0.0.%" identified by '</span>123456<span style="color: #8b2252;">'; grant replication slave *.* to repluser@"10.0.0.%";'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">5. &#22797;&#21046;&#22791;&#20221;&#25968;&#25454;&#24211;&#21040;&#20174;&#33410;&#28857;</span>
scp /backup/all.sql &#20174;&#33410;&#28857;:/data

&#20174;&#26381;&#21153;&#22120;&#65306;
<span style="color: #b22222;">#</span><span style="color: #b22222;">6. &#20174;&#33410;&#28857;&#37197;&#32622;server-id read_only&#19981;&#24378;&#21046;&#65292;&#24314;&#35758;&#21152;&#19978;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">7. &#37325;&#21551;mysql&#26381;&#21153;</span>
systemctl start mysqld
<span style="color: #b22222;">#</span><span style="color: #b22222;">8. &#20027;&#20174;&#22797;&#21046;&#30340;&#37197;&#32622;</span>
&#26041;&#27861;&#19968;&#65306;&#25913;&#22791;&#20221;&#25991;&#20214;
[root@centos8 ~]#vim /data/all.sql
CHANGE MASTER TO
<span style="color: #a0522d;">MASTER_HOST</span>=<span style="color: #8b2252;">'10.0.0.8'</span>,
<span style="color: #a0522d;">MASTER_USER</span>=<span style="color: #8b2252;">'repluser'</span>,
<span style="color: #a0522d;">MASTER_PASSWORD</span>=<span style="color: #8b2252;">'xxx'</span>,
<span style="color: #a0522d;">MASTER_PORT</span>=3306,                                                         
<span style="color: #a0522d;">MASTER_LOG_FILE</span>=<span style="color: #8b2252;">'mysql-bin.000002'</span>, <span style="color: #a0522d;">MASTER_LOG_POS</span>=375;
&#26041;&#27861;&#20108;&#65306;&#21629;&#20196;&#34892;
MariaDB [(none)]&gt; CHANGE MASTER TO <span style="color: #a0522d;">MASTER_HOST</span>=<span style="color: #8b2252;">'10.0.0.8'</span>,
<span style="color: #a0522d;">MASTER_USER</span>=<span style="color: #8b2252;">'repluser'</span>, <span style="color: #a0522d;">MASTER_PASSWORD</span>=<span style="color: #8b2252;">'xxx'</span>, <span style="color: #a0522d;">MASTER_PORT</span>=3306,
<span style="color: #a0522d;">MASTER_LOG_FILE</span>=<span style="color: #8b2252;">'mysql-bin.000002'</span>, <span style="color: #a0522d;">MASTER_LOG_POS</span>=375;
<span style="color: #b22222;">#</span><span style="color: #b22222;">9. &#36824;&#21407;&#25968;&#25454;&#24211;&#21644;&#22797;&#21046;&#20449;&#24687;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20851;&#38381;2&#36827;&#21046;&#26085;&#24535;</span>
&gt; set <span style="color: #a0522d;">sql_log_bin</span>=0; <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20020;&#26102;&#20851;</span>
mysql &lt; /data/all.sql
<span style="color: #b22222;">#</span><span style="color: #b22222;">10. &#24320;&#21551;&#22797;&#21046;&#32447;&#31243;</span>
&gt; start slave;
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24674;&#22797;&#20108;&#36827;&#21046;&#26085;&#24535;</span>
&gt;set <span style="color: #a0522d;">sql_log_bin</span>=1; <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20020;&#26102;&#24320;&#65292;&#35760;&#24405;&#24403;&#21069;&#25805;&#20316;&#12290;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:414ba383-dd17-419f-bb77-7302e6f6e70c" class="outline-5">
<h5 id="h:414ba383-dd17-419f-bb77-7302e6f6e70c">范例：当master服务器宕机，提升一个slave成为新的master</h5>
<div class="outline-text-5" id="text-h:414ba383-dd17-419f-bb77-7302e6f6e70c">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25214;&#21040;&#21738;&#20010;&#20174;&#33410;&#28857;&#30340;&#25968;&#25454;&#24211;&#26159;&#26368;&#26032;&#65292;&#35753;&#23427;&#25104;&#20026;&#26032;master</span>
[root@centos8 ~]#cat /var/lib/mysql/relay-log.info
5
./mariadb-relay-bin.000002
1180
mysql-bin.000002
996
0
&#25110;&#32773; show slave status\G&#26597;&#30475;&#20027;&#33410;&#28857;&#20301;&#32622;&#65292;&#36234;&#22823;&#36234;&#20840;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26032;master&#20462;&#25913;&#37197;&#32622;&#25991;&#20214;&#65292;&#20851;&#38381;read-only&#37197;&#32622;</span>
[root@slave1 ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
server-id=18
read-only=OFF
log-bin=/data/mysql/logbin/mysql-bin

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#38500;&#26087;&#30340;master&#22797;&#21046;&#20449;&#24687;</span>
MariaDB [hellodb]&gt;set global <span style="color: #a0522d;">read_only</span>=off;
MariaDB [hellodb]&gt;stop slave;
MariaDB [hellodb]&gt;reset slave all;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#26032;master&#19978;&#23436;&#20840;&#22791;&#20221;</span>
[root@slave1 ~]#mysqldump -A --single-transaction --master-data=1 -F &gt; backup.sql
[root@slave1 ~]#scp backup.sql 10.0.0.28:
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#26512;&#26087;&#30340;master &#30340;&#20108;&#36827;&#21046;&#26085;&#24535;&#65292;&#23558;&#26410;&#21516;&#27493;&#21040;&#33267;&#26032;master&#30340;&#20108;&#36827;&#21046;&#26085;&#24535;&#23548;&#20986;&#26469;&#65292;&#24674;&#22797;&#21040;&#26032;master,&#23613;&#21487;&#33021;&#24674;&#22797;&#25968;&#25454;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20854;&#23427;&#25152;&#26377; slave &#37325;&#26032;&#36824;&#21407;&#25968;&#25454;&#24211;&#65292;&#25351;&#21521;&#26032;&#30340;master</span>
[root@slave2 ~]#vim backup.sql
CHANGE MASTER TO
    <span style="color: #a0522d;">MASTER_HOST</span>=<span style="color: #8b2252;">'10.0.0.18'</span>,
    <span style="color: #a0522d;">MASTER_USER</span>=<span style="color: #8b2252;">'repluser'</span>,
    <span style="color: #a0522d;">MASTER_PASSWORD</span>=<span style="color: #8b2252;">'centos'</span>,
    <span style="color: #a0522d;">MASTER_PORT</span>=3306,
<span style="color: #a0522d;">MASTER_LOG_FILE</span>=<span style="color: #8b2252;">'mysql-bin.000002'</span>, <span style="color: #a0522d;">MASTER_LOG_POS</span>=371;

MariaDB [hellodb]&gt;stop slave;
MariaDB [hellodb]&gt;reset slave all;
MariaDB [hellodb]&gt;set <span style="color: #a0522d;">sql_log_bin</span>=off;
MariaDB [hellodb]&gt;source backup.sql;
MariaDB [hellodb]&gt;set <span style="color: #a0522d;">sql_log_bin</span>=on;
MariaDB [hellodb]&gt;start slave;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ca568fc7-ad2e-4822-af4c-6e8d3379a32e" class="outline-4">
<h4 id="h:ca568fc7-ad2e-4822-af4c-6e8d3379a32e">实现级联复制</h4>
<div class="outline-text-4" id="text-h:ca568fc7-ad2e-4822-af4c-6e8d3379a32e">
<p>
需要在中间的从服务器启用以下配置，实现中间slave节点能将master的二进制
日志在本机进行数据库更新，并且也同时更新本机的二进制，从而实现级联复制
</p>

<div class="org-src-container">
<pre class="src src-sh">[mysqld]
server-id=18
log_bin
log_slave_updates <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32423;&#32852;&#22797;&#21046;&#20013;&#38388;&#33410;&#28857;&#30340;&#24517;&#36873;&#39033;&#65292;MySQL8.0&#27492;&#20026;&#40664;&#35748;&#20540;&#65292;&#21487;&#20197;&#19981;&#35201;&#20154;&#20026;&#28155;&#21152;</span>
read-only
</pre>
</div>

<p>
案例：三台主机实现级联复制
</p>


<figure id="org8737634">
<img src="./images/2020070414204355.png" alt="2020070414204355.png">

<figcaption><span class="figure-number">Figure 4: </span>在这里插入图片描述</figcaption>
</figure>



<figure id="orga226b16">
<img src="./images/Snipaste_2023-05-16_03-10-12.png" alt="Snipaste_2023-05-16_03-10-12.png" width="60%">

</figure>

<div class="org-src-container">
<pre class="src src-sql">#&#22312;10.0.0.8&#20805;&#24403;master
#&#22312;10.0.0.18&#20805;&#24403;&#32423;&#32852;slave
#&#22312;10.0.0.28&#20805;&#24403;slave

#&#22312;master&#23454;&#29616;
[root@centos8 ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
server-id=8
log-bin

[root@centos8 ~]#systemctl restart mariadb
[root@centos8 ~]#mysql
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; show master logs;  #&#20808;&#26597;&#30475;&#33410;&#28857;&#65292;&#20877;&#21019;&#24314;&#36134;&#25143;&#65292;&#36825;&#26679;&#22797;&#21046;&#36807;&#21435;&#30340;&#26085;&#24535;&#37324;&#23601;&#26377;&#21019;&#24314;&#36134;&#21495;&#30340;&#35760;&#24405;
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-----------+</span>
| Log_name           | File_size |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-----------+</span>
| mariadb-bin.000001 |     28198 |
| mariadb-bin.000002 |       541 |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-----------+</span>
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; <span style="color: #a020f0;">grant</span> replication slave <span style="color: #a020f0;">on</span> *.* <span style="color: #a020f0;">to</span> repluser@<span style="color: #8b2252;">'10.0.0.%'</span> identified <span style="color: #a020f0;">by</span> <span style="color: #8b2252;">'xxx'</span>;

[root@centos8 ~]#mysqldump -A -F <span style="color: #b22222;">--</span><span style="color: #b22222;">single-transaction --master-data=1 &gt; /data/all.sql</span>
[root@centos8 ~]#scp /<span style="color: #a020f0;">data</span>/<span style="color: #a020f0;">all</span>.<span style="color: #a020f0;">sql</span> 10.0.0.18:/<span style="color: #a020f0;">data</span>
[root@centos8 ~]#scp /<span style="color: #a020f0;">data</span>/<span style="color: #a020f0;">all</span>.<span style="color: #a020f0;">sql</span> 10.0.0.28:/<span style="color: #a020f0;">data</span>

#&#22312;&#20013;&#38388;&#32423;&#32852;slave&#23454;&#29616;
[root@centos8 ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
server-id=18
log-bin
<span style="color: #a020f0;">read</span>-<span style="color: #a020f0;">only</span>
log_slave_updates #&#32423;&#32852;&#22797;&#21046;&#20013;&#38388;&#33410;&#28857;&#30340;&#24517;&#36873;&#39033;
[root@centos8 ~]#systemctl restart mariadb

#&#36824;&#21407;&#25968;&#25454;&#24211;
[root@centos8 ~]#vim /<span style="color: #a020f0;">data</span>/<span style="color: #a020f0;">all</span>.<span style="color: #a020f0;">sql</span>
CHANGE MASTER <span style="color: #a020f0;">TO</span>
    MASTER_HOST=<span style="color: #8b2252;">'10.0.0.8'</span>,
    MASTER_USER=<span style="color: #8b2252;">'repluser'</span>,
    MASTER_PASSWORD=<span style="color: #8b2252;">'xxx'</span>,
    MASTER_PORT=3306,
    MASTER_LOG_FILE=<span style="color: #8b2252;">'mariadb-bin.000002'</span>,
    MASTER_LOG_POS=541;

[root@centos8 ~]#mysql
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; <span style="color: #a020f0;">set</span> sql_log_bin=0;
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; <span style="color: #a020f0;">source</span> /<span style="color: #a020f0;">data</span>/<span style="color: #a020f0;">all</span>.<span style="color: #a020f0;">sql</span>
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; show master logs; #&#35760;&#24405;&#20108;&#36827;&#21046;&#20301;&#32622;&#65292;&#32473;&#31532;&#19977;&#20010;&#33410;&#28857;&#20351;&#29992;
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-----------+</span>
| Log_name           | File_size |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-----------+</span>
| mariadb-bin.000001 |     28200 |
| mariadb-bin.000002 |       471 |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-----------+</span>
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; <span style="color: #a020f0;">set</span> sql_log_bin=0;
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; <span style="color: #a020f0;">start</span> slave;

#&#22312;&#31532;&#19977;&#20010;&#33410;&#28857;slave&#19978;&#23454;&#29616;
[root@centos8 ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
server-id=28
<span style="color: #a020f0;">read</span>-<span style="color: #a020f0;">only</span>

[root@centos8 ~]#systemctl restart mariadb

[root@centos8 ~]#vim /<span style="color: #a020f0;">data</span>/<span style="color: #a020f0;">all</span>.<span style="color: #a020f0;">sql</span>
CHANGE MASTER <span style="color: #a020f0;">TO</span>
MASTER_HOST=<span style="color: #8b2252;">'10.0.0.18'</span>,    #&#20013;&#38388;&#33410;&#28857;&#30340;IP
MASTER_USER=<span style="color: #8b2252;">'repluser'</span>,
MASTER_PASSWORD=<span style="color: #8b2252;">'xxx'</span>,
MASTER_PORT=3306,
MASTER_LOG_FILE=<span style="color: #8b2252;">'mariadb-bin.000002'</span>, MASTER_LOG_POS=471;

[root@centos8 ~]#mysql &lt; /<span style="color: #a020f0;">data</span>/<span style="color: #a020f0;">all</span>.<span style="color: #a020f0;">sql</span>
[root@centos8 ~]#mysql -e <span style="color: #8b2252;">'start slave;'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0e537cb8-9e82-4bd3-8632-51eb6290f8f6" class="outline-4">
<h4 id="h:0e537cb8-9e82-4bd3-8632-51eb6290f8f6">主主复制</h4>
<div class="outline-text-4" id="text-h:0e537cb8-9e82-4bd3-8632-51eb6290f8f6">
<p>
注意：统一版本，配置上时主主复制，实际当成一主一从，即可以考虑设置为一
读一写，这样在主服务器宕掉的情况下，从服务器可以迅速上位，两边配置基本
一样，只有读写不同
</p>

<p>
主主复制：两个节点，都可以更新数据，并且互为主从容易产生的问题：数据不
一致；因此慎用
</p>

<p>
考虑要点：自动增长id
</p>

<p>
配置一个节点使用奇数id
</p>

<div class="org-src-container">
<pre class="src src-mysql">auto_increment_offset=1     #开始点
auto_increment_increment=2  #增长幅度
</pre>
</div>

<p>
另一个节点使用偶数id
</p>

<div class="org-src-container">
<pre class="src src-mysql">auto_increment_offset=2
auto_increment_increment=2
</pre>
</div>

<p>
<b>主主复制的配置步骤</b> ：
</p>

<p>
(1) 各节点使用一个惟一server_id
(2) 都启动binary log和relay log
(3) 创建拥有复制权限的用户账号（*在复制数据之后，二进制日志里就记录了创建过程*）
(4) 定义自动增长id字段的数值范围各为奇偶
(5) 均把对方指定为主节点，并启动复制线程
</p>

<p>
范例：实现两个节点的主主复制模型
</p>


<figure id="orgbdab502">
<img src="./images/20200704142104570.png" alt="20200704142104570.png" width="60%">

</figure>

<div class="org-src-container">
<pre class="src src-sh">&#26816;&#26597;&#20004;&#20010;&#25968;&#25454;&#24211;&#26159;&#21542;&#37117;&#26159;&#26032;&#35013;&#65292;&#33509;&#26377;&#19968;&#20010;&#26377;&#25968;&#25454;&#65292;&#37027;&#23601;&#20808;&#22791;&#20221;
&#22791;&#20221;&#24314;&#35758;&#21152;&#26102;&#38388;
<span style="color: #483d8b;">help</span> change master to
&#20877;&#23548;&#20837;&#25968;&#25454;&#21069;&#20851;&#38381;&#20108;&#36827;&#21046;&#26085;&#24535;&#21151;&#33021;
&#24320;&#21551;&#32447;&#31243;

&#20108;&#36827;&#21046;&#26085;&#24535;&#27809;&#22686;&#38271;&#65292;&#25968;&#25454;&#21364;&#22797;&#21046;&#36807;&#26469;&#20102;&#65292;&#21407;&#22240;&#26159;&#65306;
&#20027;&#26381;&#21153;&#22120;&#65306;dump&#32447;&#31243;
&#20174;&#26381;&#21153;&#22120;&#65306;iothread&#32447;&#31243;&#12289;sqlthread&#32447;&#31243;
&#26412;&#26426;&#30340;&#20108;&#36827;&#21046;&#26085;&#24535;&#21482;&#35760;&#24405;&#26412;&#26426;&#25910;&#21040;&#30340;&#20108;&#36827;&#21046;&#20462;&#25913;&#65292;&#21035;&#30340;&#26426;&#22120;&#20256;&#26469;&#30340;&#19981;&#24433;&#21709;&#26412;&#26426;&#30340;&#20108;&#36827;&#21046;&#26085;&#24535;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#31532;&#19968;&#20010;master&#33410;&#28857;&#19978;&#23454;&#29616;</span>
[root@master1 ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
server-id=8                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;id</span>
log-bin                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#20108;&#36827;&#21046;&#26085;&#24535;</span>
<span style="color: #a0522d;">auto_increment_offset</span>=1     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#22987;&#28857;</span>
<span style="color: #a0522d;">auto_increment_increment</span>=2  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22686;&#38271;&#24133;&#24230;</span>

[root@master1 ~]#systemctl start mariadb
[root@master1 ~]#mysql
MariaDB [(none)]&gt;show master logs;    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35760;&#24405;&#20301;&#32622;</span>
+--------------------+-----------+
| Log_name           | File_size |
+--------------------+-----------+
| mariadb-bin.000001 |       330 |
+--------------------+-----------+
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24314;&#31435;&#22797;&#21046;&#36134;&#21495;&#65292;&#27492;&#25805;&#20316;&#26159;&#22312;&#35760;&#24405;&#20301;&#32622;&#20043;&#21518;&#21457;&#29983;&#30340;&#65292;&#25152;&#20197;&#36134;&#21495;&#23601;&#22797;&#21046;&#36807;&#21435;&#20102;&#65292;&#21478;&#19968;&#20010;&#26381;&#21153;&#22120;&#23601;&#19981;&#38656;&#35201;&#20877;&#21019;&#24314;&#65292;&#20004;&#36793;&#29992;&#21516;&#19968;&#20010;&#36134;&#21495;&#36827;&#34892;&#24444;&#27492;&#22797;&#21046;</span>
MariaDB [(none)]&gt; grant replication slave on *.* to repluser@<span style="color: #8b2252;">'10.0.0.%'</span> identified by <span style="color: #8b2252;">'xxx'</span>;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#31532;&#20108;&#20010;master&#33410;&#28857;&#19978;&#23454;&#29616;</span>
[rootmaster2 ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
server-id=18
log-bin
<span style="color: #a0522d;">auto_increment_offset</span>=2 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#22987;&#28857;</span>
<span style="color: #a0522d;">auto_increment_increment</span>=2 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22686;&#38271;&#24133;&#24230;</span>

[root@master2 ~]#systemctl start mariadb
[root@master2 ~]#mysql
MariaDB [(none)]&gt; CHANGE MASTER TO
    <span style="color: #a0522d;">MASTER_HOST</span>=<span style="color: #8b2252;">'10.0.0.8'</span>,
    <span style="color: #a0522d;">MASTER_USER</span>=<span style="color: #8b2252;">'repluser'</span>,
    <span style="color: #a0522d;">MASTER_PASSWORD</span>=<span style="color: #8b2252;">'xxx'</span>,
    <span style="color: #a0522d;">MASTER_PORT</span>=3306,
    <span style="color: #a0522d;">MASTER_LOG_FILE</span>=<span style="color: #8b2252;">'mariadb-bin.000001'</span>,
    <span style="color: #a0522d;">MASTER_LOG_POS</span>=330;
Query OK, 0 rows affected (0.019 sec)

MariaDB [(none)]&gt; start slave;   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#36827;&#31243;&#65292;&#23454;&#29616;&#20102;&#21333;&#21521;&#22797;&#21046;</span>
Query OK, 0 rows affected (0.003 sec)
MariaDB [(none)]&gt; show master logs; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20108;&#36827;&#21046;&#20301;&#32622;</span>
MariaDB [(none)]&gt; show master logs;
+--------------------+-----------+
| Log_name           | File_size |
+--------------------+-----------+
| mariadb-bin.000001 |       330 |
+--------------------+-----------+
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#31532;&#19968;&#20010;master&#33410;&#28857;&#19978;&#23454;&#29616;</span>
MariaDB [(none)]&gt; CHANGE MASTER TO
     <span style="color: #a0522d;">MASTER_HOST</span>=<span style="color: #8b2252;">'10.0.0.18'</span>,
     <span style="color: #a0522d;">MASTER_USER</span>=<span style="color: #8b2252;">'repluser'</span>,
     <span style="color: #a0522d;">MASTER_PASSWORD</span>=<span style="color: #8b2252;">'xxx'</span>,
     <span style="color: #a0522d;">MASTER_PORT</span>=3306,
     <span style="color: #a0522d;">MASTER_LOG_FILE</span>=<span style="color: #8b2252;">'mariadb-bin.000001'</span>,
     <span style="color: #a0522d;">MASTER_LOG_POS</span>=330;
Query OK, 0 rows affected (0.007 sec)
MariaDB [(none)]&gt; start slave;
Query OK, 0 rows affected (0.002 sec)

MariaDB [(none)]&gt; create database db1;
MariaDB [(none)]&gt; use db1
MariaDB [db1]&gt; create table t1(id int auto_increment primary key,name char(10));

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20004;&#20010;&#33410;&#28857;&#20998;&#21035;&#25554;&#20837;&#25968;&#25454;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#31532;&#19968;&#20010;&#33410;&#28857;&#19978;&#25191;&#34892;&#65292;&#22855;&#25968;&#22686;&#38271;&#65292;</span>
MariaDB [db1]&gt; create database db1;
MariaDB [db1]&gt; insert t1 (name) values(<span style="color: #8b2252;">'user1'</span>);
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#31532;&#20108;&#20010;&#33410;&#28857;&#19978;&#25191;&#34892;&#65292;&#20598;&#25968;&#22686;&#38271;</span>
MariaDB [db1]&gt; insert t1 (name) values(<span style="color: #8b2252;">'user2'</span>);

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20004;&#20010;&#33410;&#28857;&#21516;&#26102;&#25554;&#20837;&#25968;&#25454;</span>
MariaDB [db1]&gt; insert t1 (name) values(<span style="color: #8b2252;">'userX'</span>);
MariaDB [db1]&gt; select * from t1;
+----+-------+
| id |  name |
+----+-------+
| 1  | user1 |
| 2  | user2 |
| 3  | userX |
| 4  | userX |
+----+-------+
4 rows<span style="color: #a020f0;"> in</span> set (0.001 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20004;&#20010;&#33410;&#28857;&#21516;&#26102;&#21019;&#24314;&#25968;&#25454;&#24211;&#65292;&#21457;&#29983;&#22797;&#21046;&#20914;&#31361;</span>
MariaDB [db1]&gt; create database db2;
MariaDB [db1]&gt; show slave status\G
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3435e7c5-bdce-4b56-95cc-e19f5226d9a1" class="outline-4">
<h4 id="h:3435e7c5-bdce-4b56-95cc-e19f5226d9a1">半同步复制</h4>
<div class="outline-text-4" id="text-h:3435e7c5-bdce-4b56-95cc-e19f5226d9a1">
<p>
默认情况下，MySQL的复制功能是异步的（客户端更新数据，主服务器收到后立刻返回成功结果，但此时数据还并没有复制到从服务器上），异步复制可以提供最佳的性能，主库把binlog日志发送给从库即结束，并不验证从库是否接收完毕。这意味着当主服务器或从服务器端发生故障时，有可能从服务器没有接收到主服务器发送过来的binlog日志，这就会造成主服务器和从服务器的数据不一致，甚至在恢复时造成数据的丢失
</p>



<figure id="org67fef14">
<img src="./images/Snipaste_2023-05-16_03-42-04.png" alt="Snipaste_2023-05-16_03-42-04.png" width="60%">

</figure>

<p>
<b>半同步复制实现</b>
</p>

<p>
客户端发请求写操作发送给主服务器，主服务器在自己服务器上更新，找一个从节点复制且必须复制成功（也就是所有从节点中至少有一个成功），最后主服务器把成功结果返还给客户端
</p>

<p>
说明：半同步机制里，任何一个从节点超过10秒（默认）没复制成功，主服务器就告诉客户数据已经更新成功
</p>

<p>
官方文档：
</p>
<ul class="org-ul">
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/replication-semisync.html">https://dev.mysql.com/doc/refman/8.0/en/replication-semisync.html</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/replication-semisync.html">https://dev.mysql.com/doc/refman/5.7/en/replication-semisync.html</a></li>
<li><a href="https://mariadb.com/kb/en/library/semisynchronous-replication/">https://mariadb.com/kb/en/library/semisynchronous-replication/</a></li>
</ul>

<p>
范例：centos8 myslq8.0 实现半同步复制
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25554;&#20214;&#25991;&#20214;</span>
[12:31:41 root@master ~]#rpm -ql mysql-server | grep semisync
/usr/lib64/mysql/plugin/semisync_master.so
/usr/lib64/mysql/plugin/semisync_slave.so

<span style="color: #b22222;">#</span><span style="color: #b22222;">master&#26381;&#21153;&#22120;&#37197;&#32622;</span>
[14:03:27 root@master ~]#vim /etc/my.cnf.d/mysql-server.cnf
[mysqld]
server-id=8
log-bin
<span style="color: #a0522d;">rpl_semi_sync_master_enabled</span>=ON       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#27492;&#34892;,&#38656;&#35201;&#20808;&#23433;&#35013;semisync_master.so&#25554;&#20214;&#21518;,&#20877;&#37325;&#21551;,&#21542;&#21017;&#26080;&#27861;&#21551;&#21160;</span>
<span style="color: #a0522d;">rpl_semi_sync_master_timeout</span>=3000     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;3s&#20869;&#26080;&#27861;&#21516;&#27493;&#65292;&#20063;&#23558;&#36820;&#22238;&#25104;&#21151;&#20449;&#24687;&#32473;&#23458;&#25143;&#31471;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">slave1&#26381;&#21153;&#22120;&#37197;&#32622;</span>
[12:31:51 root@slave1 ~]#vim /etc/my.cnf.d/mysql-server.cnf
[mysqld]
server-id=18
<span style="color: #a0522d;">rpl_semi_sync_slave_enable</span>=ON    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#27492;&#34892;,&#38656;&#35201;&#20808;&#23433;&#35013;semisync_slave.so&#25554;&#20214;&#21518;,&#20877;&#37325;&#21551;,&#21542;&#21017;&#26080;&#27861;&#21551;&#21160;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">slave2&#26381;&#21153;&#22120;&#37197;&#32622;</span>
[14:10:57 root@slave2 ~]#vim /etc/my.cnf.d/mysql-server.cnf
[mysqld]
server-id=28
<span style="color: #a0522d;">rpl_semi_sync_slave_enabled</span>=ON

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#26381;&#21153;&#22120;&#37197;&#32622;:</span>
mysql&gt; install plugin rpl_semi_sync_master soname <span style="color: #8b2252;">'semisync_master.so'</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#25554;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">mysql&gt;UNINSTALL PLUGIN rpl_semi_sync_master ;    #&#21368;&#36733;</span>
mysql&gt; show plugins;                             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25554;&#20214;</span>
mysql&gt; set global <span style="color: #a0522d;">rpl_semi_sync_master_enabled</span>=1;      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20020;&#26102;&#20462;&#25913;&#21464;&#37327;</span>
mysql&gt; set global rpl_semi_sync_master_timeout = 3000; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36229;&#26102;&#38271;1s,&#40664;&#35748;&#20540;&#20026;10s</span>

mysql&gt; show global variables like <span style="color: #8b2252;">'%semi%'</span>;
+-------------------------------------------+------------+
| Variable_name                             | Value      |
+-------------------------------------------+------------+
| rpl_semi_sync_master_enabled              | ON         |
| rpl_semi_sync_master_timeout              | 3000       |
| rpl_semi_sync_master_trace_level          | 32         |
| rpl_semi_sync_master_wait_for_slave_count | 1          |
| rpl_semi_sync_master_wait_no_slave        | ON         |
| rpl_semi_sync_master_wait_point           | AFTER_SYNC |
+-------------------------------------------+------------+
mysql&gt; show global status like <span style="color: #8b2252;">'%semi%'</span>;
+--------------------------------------------+-------+
| Variable_name                              | Value |
+--------------------------------------------+-------+
| Rpl_semi_sync_master_clients               | 2     |     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#20010;&#23458;&#25143;&#31471;&#20010;&#25968;&#38656;&#35201;&#37197;&#32622;&#20174;&#26381;&#21153;&#22120;&#21518;&#26597;&#30475;</span>
| Rpl_semi_sync_master_net_avg_wait_time     | 0     |
| Rpl_semi_sync_master_net_wait_time         | 0     |
| Rpl_semi_sync_master_net_waits             | 0     |
| Rpl_semi_sync_master_no_times              | 0     |
| Rpl_semi_sync_master_no_tx                 | 0     |
| Rpl_semi_sync_master_status                | ON    |
| Rpl_semi_sync_master_timefunc_failures     | 0     |
| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |
| Rpl_semi_sync_master_tx_wait_time          | 0     |
| Rpl_semi_sync_master_tx_waits              | 0     |
| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |
| Rpl_semi_sync_master_wait_sessions         | 0     |
| Rpl_semi_sync_master_yes_tx                | 0     |
+--------------------------------------------+-------+
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20027;&#33410;&#28857;&#20301;&#32622;</span>
&gt; show master logs;
mysql-bin.000001 156

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#21516;&#27493;&#36134;&#21495;&#24182;&#25480;&#26435;</span>
&gt;create user repluser@<span style="color: #8b2252;">'10.0.0.%'</span> identified by <span style="color: #8b2252;">'123456'</span>;
&gt;grant replication slave on *.* to repluser@<span style="color: #8b2252;">'10.0.0.%'</span>;


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#26381;&#21153;&#22120;&#37197;&#32622;:</span>
mysql&gt; install plugin rpl_semi_sync_slave soname <span style="color: #8b2252;">'semisync_slave.so'</span>; <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;&#25554;&#20214;</span>
mysql&gt; set global <span style="color: #a0522d;">rpl_semi_sync_slave_enabled</span>=1;
mysql&gt; show global variables like <span style="color: #8b2252;">'%semi%'</span>;
+---------------------------------+-------+
| Variable_name                   | Value |
+---------------------------------+-------+
| rpl_semi_sync_slave_enabled     | ON    |
| rpl_semi_sync_slave_trace_level | 32    |
+---------------------------------+-------+

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;:&#22914;&#26524;&#24050;&#32463;&#23454;&#29616;&#20027;&#20174;&#22797;&#21046;,&#38656;&#35201;stop slave;start slave;</span>
mysql&gt; CHANGE MASTER TO
    -&gt;  <span style="color: #a0522d;">MASTER_HOST</span>=<span style="color: #8b2252;">'10.0.0.8'</span>,
    -&gt;  <span style="color: #a0522d;">MASTER_USER</span>=<span style="color: #8b2252;">'repluser'</span>,
    -&gt;  <span style="color: #a0522d;">MASTER_PASSWORD</span>=<span style="color: #8b2252;">'123456'</span>,
    -&gt;  <span style="color: #a0522d;">MASTER_PORT</span>=3306,
    -&gt;  <span style="color: #a0522d;">MASTER_LOG_FILE</span>=<span style="color: #8b2252;">'mysql-bin.000001'</span>,
    -&gt;  <span style="color: #a0522d;">MASTER_LOG_POS</span>=156;
mysql&gt; start slave;
mysql&gt; show global status like <span style="color: #8b2252;">'%semi%'</span>;
+----------------------------+-------+
| Variable_name              | Value |
+----------------------------+-------+
| Rpl_semi_sync_slave_status | ON    |
+----------------------------+-------+


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#21322;&#21516;&#27493;&#65292;&#21482;&#35201;&#26377;&#19968;&#20010;&#20174;&#33410;&#28857;&#22797;&#21046;&#25104;&#21151;&#65292;&#20027;&#20174;&#22797;&#21046;&#29366;&#24577;&#23601;&#19981;&#20250;&#21345;&#39039;</span>
&gt; stop slave; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#19978;&#65292;&#20572;&#19968;&#21488;slave</span>
&gt; create database db2; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#19978;&#65292;&#21019;&#24314;&#25968;&#25454;&#24211;</span>
&gt; show slave status\G
</pre>
</div>

<p>
范例：CentOS 8 在Mariadb-10.3.11上实现半同步复制
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;master&#23454;&#29616;&#65292;&#21551;&#29992;&#21322;&#21516;&#27493;&#21151;&#33021;</span>
[root@master ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
server-id=8
log-bin
plugin-load-add = semisync_master
<span style="color: #a0522d;">rpl_semi_sync_master_enabled</span>=ON
<span style="color: #a0522d;">rpl_semi_sync_master_timeout</span>=3000 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;3s&#20869;&#26080;&#27861;&#21516;&#27493;&#65292;&#20063;&#23558;&#36820;&#22238;&#25104;&#21151;&#20449;&#24687;&#32473;&#23458;&#25143;&#31471;</span>

[root@centos8 ~]#systemctl restart mariadb

MariaDB [(none)]&gt; SHOW GLOBAL VARIABLES LIKE <span style="color: #8b2252;">'%semi%'</span>;
+---------------------------------------+--------------+
| Variable_name                         | Value        |
+---------------------------------------+--------------+
| rpl_semi_sync_master_enabled          | ON           |
| rpl_semi_sync_master_timeout          | 3000         |
| rpl_semi_sync_master_trace_level      | 32           |
| rpl_semi_sync_master_wait_no_slave    | ON           |
| rpl_semi_sync_master_wait_point       | AFTER_COMMIT |
| rpl_semi_sync_slave_delay_master      | OFF          |
| rpl_semi_sync_slave_enabled           | OFF          |
| rpl_semi_sync_slave_kill_conn_timeout | 5            |
| rpl_semi_sync_slave_trace_level       | 32           |
+---------------------------------------+--------------+
9 rows<span style="color: #a020f0;"> in</span> set (0.002 sec)

MariaDB [(none)]&gt;  show global status like <span style="color: #8b2252;">'%semi%'</span>;
+--------------------------------------------+-------+
| Variable_name                              | Value |
+--------------------------------------------+-------+
| Rpl_semi_sync_master_clients               | 0     |
| Rpl_semi_sync_master_get_ack               | 0     |
| Rpl_semi_sync_master_net_avg_wait_time     | 0     |
| Rpl_semi_sync_master_net_wait_time         | 0     |
| Rpl_semi_sync_master_net_waits             | 0     |
| Rpl_semi_sync_master_no_times              | 0     |
| Rpl_semi_sync_master_no_tx                 | 0     |
| Rpl_semi_sync_master_request_ack           | 0     |
| Rpl_semi_sync_master_status                | ON    |
| Rpl_semi_sync_master_timefunc_failures     | 0     |
| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |
| Rpl_semi_sync_master_tx_wait_time          | 0     |
| Rpl_semi_sync_master_tx_waits              | 0     |
| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |
| Rpl_semi_sync_master_wait_sessions         | 0     |
| Rpl_semi_sync_master_yes_tx                | 0     |
| Rpl_semi_sync_slave_send_ack               | 1     |
| Rpl_semi_sync_slave_status                 | OFF   |
+--------------------------------------------+-------+
18 rows<span style="color: #a020f0;"> in</span> set (0.001 sec)


MariaDB [(none)]&gt; show master logs;
+--------------------+-----------+
| Log_name           | File_size |
+--------------------+-----------+
| mariadb-bin.000001 |     28198 |
| mariadb-bin.000002 |       344 |
+--------------------+-----------+
2 rows<span style="color: #a020f0;"> in</span> set (0.000 sec)

MariaDB [(none)]&gt; grant replication slave on *.* to repluser@<span style="color: #8b2252;">'10.0.0.%'</span> identified by <span style="color: #8b2252;">'xxx'</span>;
Query OK, 0 rows affected (3.001 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#20854;&#23427;&#25152;&#26377;slave&#33410;&#28857;&#19978;&#37117;&#23454;&#29616;&#65292;&#21551;&#29992;&#21322;&#21516;&#27493;&#21151;&#33021;</span>
[root@slave ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
server-id=18
plugin_load_add = semisync_slave
<span style="color: #a0522d;">rpl_semi_sync_slave_enabled</span>=ON

[root@slave ~]#systemctl restart mariadb
[root@slave ~]#mysql
MariaDB [(none)]&gt; show global variables like <span style="color: #8b2252;">'%semi%'</span>;
+---------------------------------------+--------------+
| Variable_name                         | Value        |
+---------------------------------------+--------------+
| rpl_semi_sync_master_enabled          | OFF          |
| rpl_semi_sync_master_timeout          | 10000        |
| rpl_semi_sync_master_trace_level      | 32           |
| rpl_semi_sync_master_wait_no_slave    | ON           |
| rpl_semi_sync_master_wait_point       | AFTER_COMMIT |
| rpl_semi_sync_slave_delay_master      | OFF          |
| rpl_semi_sync_slave_enabled           | ON           |
| rpl_semi_sync_slave_kill_conn_timeout | 5            |
| rpl_semi_sync_slave_trace_level       | 32           |
+---------------------------------------+--------------+
9 rows<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [(none)]&gt; SHOW GLOBAL STATUS LIKE <span style="color: #8b2252;">'%semi%'</span>;
+--------------------------------------------+-------+
| Variable_name                              | Value |
+--------------------------------------------+-------+
| Rpl_semi_sync_master_clients               | 0     |
| Rpl_semi_sync_master_get_ack               | 0     |
| Rpl_semi_sync_master_net_avg_wait_time     | 0     |
| Rpl_semi_sync_master_net_wait_time         | 0     |
| Rpl_semi_sync_master_net_waits             | 0     |
| Rpl_semi_sync_master_no_times              | 0     |
| Rpl_semi_sync_master_no_tx                 | 0     |
| Rpl_semi_sync_master_request_ack           | 0     |
| Rpl_semi_sync_master_status                | OFF   |
| Rpl_semi_sync_master_timefunc_failures     | 0     |
| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |
| Rpl_semi_sync_master_tx_wait_time          | 0     |
| Rpl_semi_sync_master_tx_waits              | 0     |
| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |
| Rpl_semi_sync_master_wait_sessions         | 0     |
| Rpl_semi_sync_master_yes_tx                | 0     |
| Rpl_semi_sync_slave_send_ack               | 1     |
| Rpl_semi_sync_slave_status                 | ON    |
+--------------------------------------------+-------+
18 rows<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [(none)]&gt; CHANGE MASTER TO
    -&gt;  <span style="color: #a0522d;">MASTER_HOST</span>=<span style="color: #8b2252;">'10.0.0.8'</span>,
    -&gt;  <span style="color: #a0522d;">MASTER_USER</span>=<span style="color: #8b2252;">'repluser'</span>,
    -&gt;  <span style="color: #a0522d;">MASTER_PASSWORD</span>=<span style="color: #8b2252;">'xxx'</span>,
    -&gt;  <span style="color: #a0522d;">MASTER_PORT</span>=3306,
    -&gt;  <span style="color: #a0522d;">MASTER_LOG_FILE</span>=<span style="color: #8b2252;">'mariadb-bin.000002'</span>,
    -&gt;  <span style="color: #a0522d;">MASTER_LOG_POS</span>=344;
Query OK, 0 rows affected (0.008 sec)

MariaDB [(none)]&gt; start slave;
Query OK, 0 rows affected (0.002 sec)

MariaDB [(none)]&gt; show slave status\G;
************************* 1. row ***************************
                Slave_IO_State: Waiting for master to send event
                   Master_Host: 10.0.0.8
                   Master_User: repluser
                   Master_Port: 3306
                 Connect_Retry: 60
               Master_Log_File: mariadb-bin.000002
           Read_Master_Log_Pos: 541
                Relay_Log_File: mariadb-relay-bin.000002
                 Relay_Log_Pos: 754
         Relay_Master_Log_File: mariadb-bin.000002
              Slave_IO_Running: Yes
             Slave_SQL_Running: Yes
               Replicate_Do_DB: 
           Replicate_Ignore_DB: 
            Replicate_Do_Table: 
        Replicate_Ignore_Table: 
       Replicate_Wild_Do_Table: 
   Replicate_Wild_Ignore_Table: 
                    Last_Errno: 0
                    Last_Error: 
                  Skip_Counter: 0
           Exec_Master_Log_Pos: 541
               Relay_Log_Space: 1065
               Until_Condition: None
                Until_Log_File: 
                 Until_Log_Pos: 0
            Master_SSL_Allowed: No
            Master_SSL_CA_File: 
            Master_SSL_CA_Path: 
               Master_SSL_Cert: 
             Master_SSL_Cipher: 
                Master_SSL_Key: 
         Seconds_Behind_Master: 0
 Master_SSL_Verify_Server_Cert: No
                 Last_IO_Errno: 0
                 Last_IO_Error: 
                Last_SQL_Errno: 0
                Last_SQL_Error: 
   Replicate_Ignore_Server_Ids: 
              Master_Server_Id: 8
                Master_SSL_Crl: 
            Master_SSL_Crlpath: 
                    Using_Gtid: No
                   Gtid_IO_Pos: 
       Replicate_Do_Domain_Ids: 
   Replicate_Ignore_Domain_Ids: 
                 Parallel_Mode: conservative
                     SQL_Delay: 0
           SQL_Remaining_Delay: NULL
       Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it
              Slave_DDL_Groups: 1
Slave_Non_Transactional_Groups: 0
    Slave_Transactional_Groups: 0
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;master&#19978;&#23454;&#29616;</span>
MariaDB [db1]&gt; SHOW GLOBAL STATUS LIKE <span style="color: #8b2252;">'%semi%'</span>;
+--------------------------------------------+-------+
| Variable_name                              | Value |
+--------------------------------------------+-------+
| Rpl_semi_sync_master_clients               | 2     |
| Rpl_semi_sync_master_get_ack               | 3     |
| Rpl_semi_sync_master_net_avg_wait_time     | 0     |
| Rpl_semi_sync_master_net_wait_time         | 0     |
| Rpl_semi_sync_master_net_waits             | 3     |
| Rpl_semi_sync_master_no_times              | 1     |
| Rpl_semi_sync_master_no_tx                 | 1     |
| Rpl_semi_sync_master_request_ack           | 2     |
| Rpl_semi_sync_master_status                | ON    |
| Rpl_semi_sync_master_timefunc_failures     | 0     |
| Rpl_semi_sync_master_tx_avg_wait_time      | 3495  |
| Rpl_semi_sync_master_tx_wait_time          | 3495  |
| Rpl_semi_sync_master_tx_waits              | 1     |
| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |
| Rpl_semi_sync_master_wait_sessions         | 0     |
| Rpl_semi_sync_master_yes_tx                | 1     |
| Rpl_semi_sync_slave_send_ack               | 0     |
| Rpl_semi_sync_slave_status                 | OFF   |
+--------------------------------------------+-------+
18 rows<span style="color: #a020f0;"> in</span> set (0.002 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;master&#23454;&#29616;&#65292;&#21019;&#24314;&#25968;&#25454;&#24211;&#65292;&#31435;&#21363;&#25104;&#21151;</span>
MariaDB [db1]&gt; create database db2;
Query OK, 1 row affected (0.004 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#25152;&#26377;slave&#33410;&#28857;&#23454;&#29616;&#65292;&#20572;&#27490;&#22797;&#21046;&#32447;&#31243;</span>
MariaDB [(none)]&gt; stop slave;
Query OK, 0 rows affected (0.011 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;master&#23454;&#29616;&#65292;&#21019;&#24314;&#25968;&#25454;&#24211;&#65292;&#31561;&#24453;3s&#25165;&#33021;&#25104;&#21151;</span>
MariaDB [db1]&gt; create database db3;
Query OK, 1 row affected (3.003 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#20219;&#24847;&#19968;&#20010;slave&#33410;&#28857;&#23454;&#29616;&#65292;&#24674;&#22797;&#22797;&#21046;&#32447;&#31243;</span>
MariaDB [(none)]&gt; start slave;
Query OK, 0 rows affected (0.006 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;master&#23454;&#29616;&#65292;&#21019;&#24314;&#25968;&#25454;&#24211;&#65292;&#31435;&#21363;&#25104;&#21151;</span>
MariaDB [db1]&gt; create database db4;
Query OK, 1 row affected (0.002 sec)
</pre>
</div>

<p>
范例：CentOS 7 实现MariaDB5.5.65半同步复制
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#26381;&#21153;&#22120;&#37197;&#32622;:</span>
INSTALL PLUGIN rpl_semi_sync_master SONAME <span style="color: #8b2252;">'semisync_master.so'</span>;
UNINSTALL PLUGIN rpl_semi_sync_master ;
SHOW PLUGINS; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25554;&#20214;</span>
SET GLOBAL <span style="color: #a0522d;">rpl_semi_sync_master_enabled</span>=1;
SET GLOBAL rpl_semi_sync_master_timeout = 1000; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36229;&#26102;&#38271;1s,&#40664;&#35748;&#20540;&#20026;10s</span>
SHOW GLOBAL VARIABLES LIKE <span style="color: #8b2252;">'%semi%'</span>;
SHOW GLOBAL STATUS LIKE <span style="color: #8b2252;">'%semi%'</span>;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#26381;&#21153;&#22120;&#37197;&#32622;:</span>
INSTALL PLUGIN rpl_semi_sync_slave SONAME <span style="color: #8b2252;">'semisync_slave.so'</span>;
SET GLOBAL <span style="color: #a0522d;">rpl_semi_sync_slave_enabled</span>=1;

<span style="color: #b22222;">#</span><span style="color: #b22222;">mariadb-10.3&#29256;&#20197;&#21518;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#26381;&#21153;&#22120;&#37197;&#32622;:</span>
[mysqld]
plugin_load_add = semisync_master

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#26381;&#21153;&#22120;&#37197;&#32622;:</span>
[mysqld]
plugin_load_add = semisync_slave
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4a6e2b30-49f5-4186-9110-e808c10a2d25" class="outline-4">
<h4 id="h:4a6e2b30-49f5-4186-9110-e808c10a2d25">复制过滤器</h4>
<div class="outline-text-4" id="text-h:4a6e2b30-49f5-4186-9110-e808c10a2d25">
<p>
让从节点仅复制指定的数据库，或指定数据库的指定表
</p>

<p>
<b>复制过滤器两种实现方式</b> ：
</p>

<p>
(1) 服务器选项：主服务器仅向二进制日志中记录与特定数据库相关的事件
</p>

<p>
缺点：基于二进制还原将无法实现；不建议使用
</p>

<p>
优点：只需要在主节点配置一次即可
</p>

<p>
注意：此项和binlog_format相关
</p>

<p>
参看：<a href="https://mariadb.com/kb/en/library/mysqld-options/#-binlog-ignore-db">https://mariadb.com/kb/en/library/mysqld-options/#-binlog-ignore-db</a>
</p>

<div class="org-src-container">
<pre class="src src-sql">vim /etc/my.cnf
binlog-do-db = db1    #&#25968;&#25454;&#24211;&#30333;&#21517;&#21333;&#21015;&#34920;&#65292;&#35760;&#24405;&#20108;&#36827;&#21046;&#26085;&#24535;&#12290;&#19981;&#25903;&#25345;&#21516;&#26102;&#25351;&#23450;&#22810;&#20010;&#20540;&#65292;&#22914;&#26524;&#24819;&#23454;&#29616;&#22810;&#20010;&#25968;&#25454;&#24211;&#38656;&#22810;&#34892;&#23454;&#29616;
binlog-do-db = db2 
binlog-<span style="color: #a020f0;">ignore</span>-db = #&#25968;&#25454;&#24211;&#40657;&#21517;&#21333;&#21015;&#34920;&#65292;&#19981;&#35760;&#24405;&#20108;&#36827;&#21046;
#&#20197;&#19978;&#20004;&#20010;&#37117;&#26159;&#26381;&#21153;&#22120;&#36873;&#39033;&#65292;&#21482;&#33021;&#25913;&#37197;&#32622;&#25991;&#20214;
</pre>
</div>

<p>
注意：
</p>
<pre class="example" id="orgd0e0af8">
This option will not work with cross-database updates with statement-based logging. See the Statement-Based Logging section for more information.
This option can not be set dynamically.
When setting it on the command-line or in a server option group in an option file, the option does not accept a comma-separated list. If you would like to specify multiple filters, then you need to specify the option multiple times.
</pre>

<p>
（2）从服务器SQL_THREAD在relay log中事件时，仅读取与特定数据库（特定表）相关的事件并应用于本地
</p>

<p>
缺点：会造成网络及磁盘IO浪费，在所有从节点都要配置
</p>

<p>
优点：不影响二进制备份还原
</p>

<p>
从服务器上的复制过滤器相关变量
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">replicate_do_db</span>=db1,db2,db3 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#22797;&#21046;&#24211;&#30340;&#30333;&#21517;&#21333;&#65292;&#21464;&#37327;&#21487;&#20197;&#25351;&#23450;&#36887;&#21495;&#20998;&#38548;&#30340;&#22810;&#20010;&#20540;&#65292;&#36873;&#39033;&#19981;&#25903;&#25345;&#22810;&#20540;,&#21482;&#33021;&#20998;&#21035;&#20889;&#22810;&#34892;&#23454;&#29616;</span>
<span style="color: #a0522d;">replicate_ignore_db</span>=    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#22797;&#21046;&#24211;&#40657;&#21517;&#21333;&#65292;&#26082;&#26159;&#26381;&#21153;&#22120;&#36873;&#39033;&#21448;&#26159;&#21464;&#37327;</span>
<span style="color: #a0522d;">replicate_do_table</span>=     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#22797;&#21046;&#34920;&#30340;&#30333;&#21517;&#21333;</span>
<span style="color: #a0522d;">replicate_ignore_table</span>= <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#22797;&#21046;&#34920;&#30340;&#40657;&#21517;&#21333;</span>
<span style="color: #a0522d;">replicate_wild_do_table</span>= foo%.bar% <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25903;&#25345;&#36890;&#37197;&#31526;</span>
<span style="color: #a0522d;">replicate_wild_ignore_tablemysql</span>=
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">When setting it dynamically with SET GLOBAL, the system variable accepts a comma-separated list of filters.
When setting it on the command-line or<span style="color: #a020f0;"> in</span> a server option group<span style="color: #a020f0;"> in</span> an option file, the system variable does not accept a comma-separated list. If you would like to specify multiple filters, then you need to specify the system variable multiple times.
</pre>
</div>

<p>
注意：跨库的更新将无法同步
</p>

<p>
范例：服务器配置过滤器
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#26381;&#21153;&#22120;&#20462;&#25913;&#37197;&#32622;&#25991;&#20214;&#65292;&#20462;&#25913;&#20026;&#21482;&#26377;hellodb&#21487;&#20197;&#35760;&#24405;&#20108;&#36827;&#21046;&#26085;&#24535;</span>
[mysqld]
binlog-do-db=db1

systemctl restart mysqld

MariaDB [(none)]&gt; show master status;
+--------------------+----------+--------------+------------------+
| File               | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+--------------------+----------+--------------+------------------+
| mariadb-bin.000003 |      344 | hellodb      |                  |
+--------------------+----------+--------------+------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.000 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#26381;&#21153;&#22120;&#19978;&#26597;&#30475;hellodb&#24211;&#20013;teachers&#34920;&#24182;&#25554;&#20837;&#26032;&#30340;&#19968;&#34892;</span>
MariaDB [hellodb]&gt; select * from teachers;
+-----+---------------+-----+--------+
| TID | Name          | Age | Gender |
+-----+---------------+-----+--------+
|   1 | Song Jiang    |  45 | M      |
|   2 | Zhang Sanfeng |  94 | M      |
|   3 | Miejue Shitai |  77 | F      |
|   4 | Lin Chaoying  |  93 | F      |
+-----+---------------+-----+--------+
4 rows<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [hellodb]&gt; insert teachers (name,age,gender)values(<span style="color: #8b2252;">'xxx'</span>,50,<span style="color: #8b2252;">'M'</span>);
Query OK, 1 row affected (0.003 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#26381;&#21153;&#22120;&#19978;&#33021;&#26597;&#30475;&#21040;&#26032;&#30340;&#19968;&#34892;</span>
MariaDB [hellodb]&gt; select * from teachers;
+-----+---------------+-----+--------+
| TID | Name          | Age | Gender |
+-----+---------------+-----+--------+
|   1 | Song Jiang    |  45 | M      |
|   2 | Zhang Sanfeng |  94 | M      |
|   3 | Miejue Shitai |  77 | F      |
|   4 | Lin Chaoying  |  93 | F      |
|   5 | mage          |  50 | M      |
+-----+---------------+-----+--------+
5 rows<span style="color: #a020f0;"> in</span> set (0.000 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#26381;&#21153;&#22120;&#19978;&#21019;&#24314;&#19968;&#20010;&#26032;&#34920;</span>
MariaDB [hellodb]&gt; create database db5;
Query OK, 1 row affected (0.000 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#26381;&#21153;&#22120;&#19978;&#26597;&#30475;&#19981;&#21040;</span>
MariaDB [hellodb]&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| db1                |
| db2                |
| db3                |
| db4                |
| hellodb            |
| information_schema |
| mysql              |
| performance_schema |
+--------------------+
8 rows<span style="color: #a020f0;"> in</span> set (0.001 sec)
</pre>
</div>



<p>
范例: 从服务器上的复制过滤器
</p>

<div class="org-src-container">
<pre class="src src-sql">[mysqld]
replicate_do_db=db1
replicate_do_db=db2
replicate_do_db=db3
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql">MariaDB [db1]&gt; <span style="color: #a020f0;">create</span> <span style="color: #a020f0;">table</span> db2.t1(id <span style="color: #228b22;">int</span>);
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.010 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1d03f0ef-3e0b-4979-b69a-5d8f08261958" class="outline-4">
<h4 id="h:1d03f0ef-3e0b-4979-b69a-5d8f08261958">主从复制加密</h4>
<div class="outline-text-4" id="text-h:1d03f0ef-3e0b-4979-b69a-5d8f08261958">

<figure id="org6a5393b">
<img src="./images/2020070414240366.png" alt="2020070414240366.png" width="60%">

</figure>

<p>
基于SSL复制：在默认的主从复制过程或远程连接到MySQL/MariaDB所有的链接通
信中的数据都是明文的，外网里访问数据或则复制，存在安全隐患。通过
SSL/TLS加密的方式进行复制的方法，来进一步提高数据的安全性
</p>

<p>
官网文档：<a href="https://mariadb.com/kb/en/library/replication-with-secure-connections/">https://mariadb.com/kb/en/library/replication-with-secure-connections/</a>
</p>



<figure id="org72da22e">
<img src="./images/20200704142414718.png" alt="20200704142414718.png" width="60%">

</figure>

<p>
<b>实现MySQL复制加密</b>
</p>

<ol class="org-ol">
<li>生成 CA 及 master 和 slave 的证书</li>
</ol>

<div class="org-src-container">
<pre class="src src-sh">[root@master ~]#mkdir /etc/my.cnf.d/ssl/
[root@master ~]#cat ca.sh 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>

<span style="color: #483d8b;">.</span> /etc/init.d/functions

<span style="color: #a0522d;">CERT_INFO</span>=([00]=<span style="color: #8b2252;">"/O=xxx/CN=ca.xxx.org"</span> <span style="color: #8b2252;">\</span>
           [01]=<span style="color: #8b2252;">"cakey.pem"</span> <span style="color: #8b2252;">\ </span>  
           [02]=<span style="color: #8b2252;">"cacert.pem"</span> <span style="color: #8b2252;">\</span>
           [03]=2048 <span style="color: #8b2252;">\</span>
           [04]=3650 <span style="color: #8b2252;">\</span>
           [05]=0    <span style="color: #8b2252;">\</span>
           [10]=<span style="color: #8b2252;">"/C=CN/ST=hubei/L=wuhan/O=xxx/CN=master.xxx.org"</span> <span style="color: #8b2252;">\</span>
           [11]=<span style="color: #8b2252;">"master.key"</span> <span style="color: #8b2252;">\</span>
           [12]=<span style="color: #8b2252;">"master.crt"</span> <span style="color: #8b2252;">\</span>
           [13]=2048 <span style="color: #8b2252;">\</span>
           [14]=365
           [15]=1 <span style="color: #8b2252;">\</span>
           [16]=<span style="color: #8b2252;">"master.csr"</span> <span style="color: #8b2252;">\</span>
           [20]=<span style="color: #8b2252;">"/C=CN/ST=hubei/L=wuhan/O=xxx/CN=slave.cuiqinghe.org"</span> <span style="color: #8b2252;">\</span>
           [21]=<span style="color: #8b2252;">"slave.key"</span> <span style="color: #8b2252;">\</span>
           [22]=<span style="color: #8b2252;">"slave.crt"</span> <span style="color: #8b2252;">\</span>
           [23]=2048 <span style="color: #8b2252;">\</span>
           [24]=365 <span style="color: #8b2252;">\</span>
           [25]=2 <span style="color: #8b2252;">\</span>
           [26]=<span style="color: #8b2252;">"slave.csr"</span>   )

<span style="color: #a0522d;">COLOR</span>=<span style="color: #8b2252;">"echo -e \\E[1;32m"</span>
<span style="color: #a0522d;">END</span>=<span style="color: #8b2252;">"\\E[0m"</span>
<span style="color: #a0522d;">DIR</span>=/data
<span style="color: #483d8b;">cd</span> $<span style="color: #a0522d;">DIR</span> 

<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> {0..2};<span style="color: #a020f0;">do</span>
    <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">i</span> -eq 0 ] ;<span style="color: #a020f0;">then</span>
        openssl req  -x509 -newkey rsa:${<span style="color: #a0522d;">CERT_INFO</span>[${<span style="color: #a0522d;">i</span>}3]} -subj ${<span style="color: #a0522d;">CERT_INFO</span>[${<span style="color: #a0522d;">i</span>}0]} <span style="color: #8b2252;">\</span>
            -set_serial ${<span style="color: #a0522d;">CERT_INFO</span>[${<span style="color: #a0522d;">i</span>}5]} -keyout ${<span style="color: #a0522d;">CERT_INFO</span>[${<span style="color: #a0522d;">i</span>}1]} -nodes -days ${<span style="color: #a0522d;">CERT_INFO</span>[${<span style="color: #a0522d;">i</span>}4]} <span style="color: #8b2252;">\</span>
            -out ${<span style="color: #a0522d;">CERT_INFO</span>[${<span style="color: #a0522d;">i</span>}2]} &amp;&gt;/dev/null

    <span style="color: #a020f0;">else</span> 
        openssl req -newkey rsa:${<span style="color: #a0522d;">CERT_INFO</span>[${<span style="color: #a0522d;">i</span>}3]} -nodes -subj ${<span style="color: #a0522d;">CERT_INFO</span>[${<span style="color: #a0522d;">i</span>}0]} <span style="color: #8b2252;">\</span>
            -keyout ${<span style="color: #a0522d;">CERT_INFO</span>[${<span style="color: #a0522d;">i</span>}1]}   -out ${<span style="color: #a0522d;">CERT_INFO</span>[${<span style="color: #a0522d;">i</span>}6]} &amp;&gt;/dev/null

        openssl x509 -req -in ${<span style="color: #a0522d;">CERT_INFO</span>[${<span style="color: #a0522d;">i</span>}6]}  -CA ${<span style="color: #a0522d;">CERT_INFO</span>[02]} -CAkey ${<span style="color: #a0522d;">CERT_INFO</span>[01]}  <span style="color: #8b2252;">\</span>
            -set_serial ${<span style="color: #a0522d;">CERT_INFO</span>[${<span style="color: #a0522d;">i</span>}5]}  -days ${<span style="color: #a0522d;">CERT_INFO</span>[${<span style="color: #a0522d;">i</span>}4]} -out ${<span style="color: #a0522d;">CERT_INFO</span>[${<span style="color: #a0522d;">i</span>}2]} &amp;&gt;/dev/null
    <span style="color: #a020f0;">fi</span>
    $<span style="color: #a0522d;">COLOR</span><span style="color: #8b2252;">"**************************************&#29983;&#25104;&#35777;&#20070;&#20449;&#24687;**************************************"</span>$<span style="color: #a0522d;">END</span>
    openssl x509 -in ${<span style="color: #a0522d;">CERT_INFO</span>[${<span style="color: #a0522d;">i</span>}2]} -noout -subject -dates -serial
    <span style="color: #483d8b;">echo</span> 
<span style="color: #a020f0;">done</span>
chmod 600 *.key
action <span style="color: #8b2252;">"&#35777;&#20070;&#29983;&#25104;&#23436;&#25104;"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;&#33050;&#26412;&#29983;&#25104;&#35777;&#20070;</span>
[root@master ~]#bash ca.sh
**************************************&#29983;&#25104;&#35777;&#20070;&#20449;&#24687;**************************************
<span style="color: #a0522d;">subject</span>=O = xxx, CN = ca.xxx.org
<span style="color: #a0522d;">notBefore</span>=Jun 16 07:27:05 2020 GMT
<span style="color: #a0522d;">notAfter</span>=Jun 14 07:27:05 2030 GMT
<span style="color: #a0522d;">serial</span>=00

**************************************&#29983;&#25104;&#35777;&#20070;&#20449;&#24687;**************************************
<span style="color: #a0522d;">subject</span>=C = CN, ST = hubei, L = wuhan, O = xxx, CN = master.xxx.org
<span style="color: #a0522d;">notBefore</span>=Jun 16 07:27:05 2020 GMT
<span style="color: #a0522d;">notAfter</span>=Jun 16 07:27:05 2021 GMT
<span style="color: #a0522d;">serial</span>=01

**************************************&#29983;&#25104;&#35777;&#20070;&#20449;&#24687;**************************************
<span style="color: #a0522d;">subject</span>=C = CN, ST = hubei, L = wuhan, O = xxx, CN = slave.cuiqinghe.org
<span style="color: #a0522d;">notBefore</span>=Jun 16 07:27:05 2020 GMT
<span style="color: #a0522d;">notAfter</span>=Jun 16 07:27:05 2021 GMT
<span style="color: #a0522d;">serial</span>=02

&#35777;&#20070;&#29983;&#25104;&#23436;&#25104;                                               [  OK  ]

[root@master ~]#tree /data/
/data/
&#9500;&#9472;&#9472; cacert.pem
&#9500;&#9472;&#9472; cakey.pem
&#9500;&#9472;&#9472; master.crt
&#9500;&#9472;&#9472; master.csr
&#9500;&#9472;&#9472; master.key
&#9500;&#9472;&#9472; slave.crt
&#9500;&#9472;&#9472; slave.csr
&#9492;&#9472;&#9472; slave.key

0 directories, 8 files

[root@master ~]#cp /data/* /etc/my.cnf.d/ssl/
[root@master ~]#cd /etc/my.cnf.d/ssl/
[root@master ssl]#ll
total 32
-rw-r--r-- 1 root root 1143 Jun 16 15:28 cacert.pem
-rw------- 1 root root 1704 Jun 16 15:28 cakey.pem
-rw-r--r-- 1 root root 1090 Jun 16 15:28 master.crt
-rw-r--r-- 1 root root  985 Jun 16 15:28 master.csr
-rw------- 1 root root 1704 Jun 16 15:28 master.key
-rw-r--r-- 1 root root 1090 Jun 16 15:28 slave.crt
-rw-r--r-- 1 root root  989 Jun 16 15:28 slave.csr
-rw------- 1 root root 1704 Jun 16 15:28 slave.key
[root@master ssl]#chown -R mysql.mysql /etc/my.cnf.d/ssl/
[root@master ssl]#ll
total 32
-rw-r--r-- 1 mysql mysql 1143 Jun 16 15:28 cacert.pem
-rw------- 1 mysql mysql 1704 Jun 16 15:28 cakey.pem
-rw-r--r-- 1 mysql mysql 1090 Jun 16 15:28 master.crt
-rw-r--r-- 1 mysql mysql  985 Jun 16 15:28 master.csr
-rw------- 1 mysql mysql 1704 Jun 16 15:28 master.key
-rw-r--r-- 1 mysql mysql 1090 Jun 16 15:28 slave.crt
-rw-r--r-- 1 mysql mysql  989 Jun 16 15:28 slave.csr
-rw------- 1 mysql mysql 1704 Jun 16 15:28 slave.key
</pre>
</div>

<ol class="org-ol">
<li>主服务器开启 SSL，配置证书和私钥路径</li>
</ol>

<div class="org-src-container">
<pre class="src src-sql">[mysqld]
log-bin
server_id=1
ssl
ssl-ca=/etc/my.cnf.d/ssl/cacert.pem
ssl-cert=/etc/my.cnf.d/ssl/master.crt
ssl-<span style="color: #a020f0;">key</span>=/etc/my.cnf.d/ssl/master.<span style="color: #a020f0;">key</span>

MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; show variables <span style="color: #a020f0;">like</span> <span style="color: #8b2252;">'%ssl%'</span>;
+<span style="color: #b22222;">---------------------</span><span style="color: #b22222;">+----------------------------------+</span>
| Variable_name       | <span style="color: #a020f0;">Value</span>                            |
+<span style="color: #b22222;">---------------------</span><span style="color: #b22222;">+----------------------------------+</span>
| have_openssl        | YES                              |
| have_ssl            | YES                              |
| ssl_ca              | /etc/my.cnf.d/ssl/cacert.pem     |
| ssl_capath          |                                  |
| ssl_cert            | /etc/my.cnf.d/ssl/master.crt     |
| ssl_cipher          |                                  |
| ssl_crl             |                                  |
| ssl_crlpath         |                                  |
| ssl_key             | /etc/my.cnf.d/ssl/master.<span style="color: #a020f0;">key</span>     |
| version_ssl_library | OpenSSL 1.1.1c FIPS  28 May 2019 |
+<span style="color: #b22222;">---------------------</span><span style="color: #b22222;">+----------------------------------+</span>
10 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)
</pre>
</div>

<ol class="org-ol">
<li>创建一个要求必须使用 SSL 连接的复制账号</li>
</ol>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">GRANT</span> REPLICATION SLAVE <span style="color: #a020f0;">ON</span> *.* <span style="color: #a020f0;">TO</span> <span style="color: #8b2252;">'repluser'</span>@<span style="color: #8b2252;">'10.0.0.%'</span> IDENTIFIED <span style="color: #a020f0;">BY</span> <span style="color: #8b2252;">'xxx'</span> REQUIRE SSL;
</pre>
</div>

<ol class="org-ol">
<li>从服务器slave上使用CHANGER MASTER TO 命令时指明ssl相关选项</li>
</ol>

<div class="org-src-container">
<pre class="src src-sql">[root@slave1 ~]#mysql -urepluser -pxxx -h10.0.0.8
ERROR 1045 (28000): Access denied <span style="color: #a020f0;">for</span> <span style="color: #483d8b;">user</span> <span style="color: #8b2252;">'repluser'</span>@<span style="color: #8b2252;">'10.0.0.18'</span> (<span style="color: #a020f0;">using</span> password: YES)
[root@centos8 ~]#mysql -urepluser -pxxx -h10.0.0.8 <span style="color: #b22222;">--</span><span style="color: #b22222;">ssl-ca=/etc/my.cnf.d/ssl/cacert.pem --ssl-cert=/etc/my.cnf.d/ssl/slave.crt --ssl-key=/etc/my.cnf.d/ssl/slave.key</span>
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt;
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; \s
<span style="color: #b22222;">--------------</span>
mysql  Ver 15.1 Distrib 10.3.17-MariaDB, <span style="color: #a020f0;">for</span> Linux (x86_64) <span style="color: #a020f0;">using</span> readline 5.1

<span style="color: #a020f0;">Connection</span> id:      53
<span style="color: #a020f0;">Current</span> database:   
<span style="color: #a020f0;">Current</span> <span style="color: #483d8b;">user</span>:       repluser@10.0.0.18
SSL:            Cipher <span style="color: #a020f0;">in</span> use <span style="color: #a020f0;">is</span> TLS_AES_256_GCM_SHA384   #&#24050;&#21152;&#23494;
<span style="color: #a020f0;">Current</span> pager:      stdout
<span style="color: #a020f0;">Using</span> outfile:      <span style="color: #8b2252;">''</span>
<span style="color: #a020f0;">Using</span> delimiter:    ;
Server:         MariaDB
Server version:     10.3.17-MariaDB-log MariaDB Server
Protocol version:   10
<span style="color: #a020f0;">Connection</span>:     10.0.0.8 via TCP/IP
Server characterset:    latin1
Db     characterset:    latin1
Client characterset:    utf8
Conn.  characterset:    utf8
TCP port:       3306
Uptime:         23 <span style="color: #483d8b;">min</span> 4 sec

Threads: 10  Questions: 11  Slow queries: 0  Opens: 17  Flush tables: 1  <span style="color: #a020f0;">Open</span> tables: 11  Queries per <span style="color: #a020f0;">second</span> <span style="color: #483d8b;">avg</span>: 0.007
<span style="color: #b22222;">--------------</span>

#&#20027;&#26381;&#21153;&#22120;&#19978;&#26597;&#30475;&#36827;&#31243;
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; show processlist;
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span>
| Id | <span style="color: #483d8b;">User</span>        | <span style="color: #a020f0;">Host</span>            | db   | Command | <span style="color: #228b22;">Time</span> | <span style="color: #a020f0;">State</span>                    | Info             | Progress |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span>
|  1 | <span style="color: #a020f0;">system</span> <span style="color: #483d8b;">user</span> |                 | <span style="color: #a020f0;">NULL</span> | Daemon  | <span style="color: #a020f0;">NULL</span> | InnoDB purge worker      | <span style="color: #a020f0;">NULL</span>             |    0.000 |
|  2 | <span style="color: #a020f0;">system</span> <span style="color: #483d8b;">user</span> |                 | <span style="color: #a020f0;">NULL</span> | Daemon  | <span style="color: #a020f0;">NULL</span> | InnoDB purge coordinator | <span style="color: #a020f0;">NULL</span>             |    0.000 |
|  3 | <span style="color: #a020f0;">system</span> <span style="color: #483d8b;">user</span> |                 | <span style="color: #a020f0;">NULL</span> | Daemon  | <span style="color: #a020f0;">NULL</span> | InnoDB purge worker      | <span style="color: #a020f0;">NULL</span>             |    0.000 |
|  4 | <span style="color: #a020f0;">system</span> <span style="color: #483d8b;">user</span> |                 | <span style="color: #a020f0;">NULL</span> | Daemon  | <span style="color: #a020f0;">NULL</span> | InnoDB purge worker      | <span style="color: #a020f0;">NULL</span>             |    0.000 |
|  5 | <span style="color: #a020f0;">system</span> <span style="color: #483d8b;">user</span> |                 | <span style="color: #a020f0;">NULL</span> | Daemon  | <span style="color: #a020f0;">NULL</span> | InnoDB shutdown handler  | <span style="color: #a020f0;">NULL</span>             |    0.000 |
|  9 | root        | localhost       | <span style="color: #a020f0;">NULL</span> | Query   |    0 | Init                     | show processlist |    0.000 |
| 53 | repluser    | 10.0.0.18:56006 | <span style="color: #a020f0;">NULL</span> | Sleep   |   35 |                          | <span style="color: #a020f0;">NULL</span>             |    0.000 |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------------+-----------------+------+---------+------+--------------------------+------------------+----------+</span>
7 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.001 sec)

[root@centos8 ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
server-id=2
#&#21487;&#36873;&#26041;&#24335;1
ssl
ssl-ca=/etc/my.cnf.d/ssl/cacert.pem
ssl-cert=/etc/my.cnf.d/ssl/slave.crt
ssl-<span style="color: #a020f0;">key</span>=/etc/my.cnf.d/ssl/slave.<span style="color: #a020f0;">key</span>

MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; CHANGE MASTER <span style="color: #a020f0;">TO</span>
MASTER_HOST=<span style="color: #8b2252;">'10.0.0.8'</span>,
MASTER_USER=<span style="color: #8b2252;">'repluser'</span>,
MASTER_PASSWORD=<span style="color: #8b2252;">'xxx'</span>,
MASTER_PORT=3306,
MASTER_LOG_FILE=<span style="color: #8b2252;">'mariadb-bin.000002'</span>,
MASTER_LOG_POS=344,
MASTER_SSL=1;

#&#21487;&#36873;&#26041;&#24335;2
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; CHANGE MASTER <span style="color: #a020f0;">TO</span>
MASTER_HOST=<span style="color: #8b2252;">'10.0.0.8'</span>,
MASTER_USER=<span style="color: #8b2252;">'repluser'</span>,
MASTER_PASSWORD=<span style="color: #8b2252;">'xxx'</span>,
MASTER_PORT=3306,
MASTER_LOG_FILE=<span style="color: #8b2252;">'mariadb-bin.000002'</span>,
MASTER_LOG_POS=344,
MASTER_SSL=1,
MASTER_SSL_CA = <span style="color: #8b2252;">'/etc/my.cnf.d/ssl/cacert.pem'</span>,
MASTER_SSL_CERT = <span style="color: #8b2252;">'/etc/my.cnf.d/ssl/slave.crt'</span>,
MASTER_SSL_KEY = <span style="color: #8b2252;">'/etc/my.cnf.d/ssl/slave.key'</span>;

MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; <span style="color: #a020f0;">start</span> slave;
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.001 sec)

MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; show slave status\G;
************************* 1. <span style="color: #228b22;">row</span> ***************************
                Slave_IO_State: Waiting <span style="color: #a020f0;">for</span> master <span style="color: #a020f0;">to</span> send event
                   Master_Host: 10.0.0.8
                   Master_User: repluser
                   Master_Port: 3306
                 Connect_Retry: 60
               Master_Log_File: mariadb-bin.000002
           Read_Master_Log_Pos: 682
                Relay_Log_File: mariadb-relay-bin.000002
                 Relay_Log_Pos: 895
         Relay_Master_Log_File: mariadb-bin.000002
              Slave_IO_Running: Yes
             Slave_SQL_Running: Yes
               Replicate_Do_DB: 
           Replicate_Ignore_DB: 
            Replicate_Do_Table: 
        Replicate_Ignore_Table: 
       Replicate_Wild_Do_Table: 
   Replicate_Wild_Ignore_Table: 
                    Last_Errno: 0
                    Last_Error: 
                  Skip_Counter: 0
           Exec_Master_Log_Pos: 682
               Relay_Log_Space: 1206
               Until_Condition: <span style="color: #a020f0;">None</span>
                Until_Log_File: 
                 Until_Log_Pos: 0
            Master_SSL_Allowed: Yes

1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a9de387c-6027-4df8-a78c-6b777402df2c" class="outline-4">
<h4 id="h:a9de387c-6027-4df8-a78c-6b777402df2c">GTID复制</h4>
<div class="outline-text-4" id="text-h:a9de387c-6027-4df8-a78c-6b777402df2c">
<p>
GTID复制：（Global Transaction ID 全局事务标识符） MySQL 5.6版本开始支
持，GTID复制不像传统的复制方式（异步复制、半同步复制）需要找到binlog文
件名和POS点，只需知道master的IP、端口、账号、密码即可。开启GTID后，执
行change master to master_auto_postion=1即可，它会自动寻找到相应的位置
开始同步
</p>

<p>
<b>GTID 架构</b>
</p>



<figure id="orgf9ccbf3">
<img src="./images/202007041424361.png" alt="202007041424361.png" width="60%">

</figure>

<p>
GTID = server_uuid:transaction_id，在一组复制中，全局唯一
server_uuid 来源于 /var/lib/mysql/auto.cnf
</p>

<p>
<b>GTID服务器相关选项</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">gtid_mode                #gtid&#27169;&#24335;
enforce_gtid_consistency #&#20445;&#35777;GTID&#23433;&#20840;&#30340;&#21442;&#25968;
</pre>
</div>

<p>
<b>GTID配置范例</b>
</p>

<ol class="org-ol">
<li>主服务器</li>
</ol>

<div class="org-src-container">
<pre class="src src-sql">vim /etc/my.cnf
server-id=1
log-bin=mysql-bin #&#21487;&#36873;
gtid_mode=<span style="color: #a020f0;">ON</span>
enforce_gtid_consistency

mysql&gt; <span style="color: #a020f0;">grant</span> replication slave <span style="color: #a020f0;">on</span> *.* <span style="color: #a020f0;">to</span> <span style="color: #8b2252;">'repluser'</span>@<span style="color: #8b2252;">'10.0.0.%'</span> identified <span style="color: #a020f0;">by</span> <span style="color: #8b2252;">'xxx'</span>;
</pre>
</div>

<ol class="org-ol">
<li>从服务器</li>
</ol>

<div class="org-src-container">
<pre class="src src-sql">vim /etc/my.cnf
server-id=2
gtid_mode=<span style="color: #a020f0;">ON</span>
enforce_gtid_consistency

mysql&gt;CHANGE MASTER <span style="color: #a020f0;">TO</span> MASTER_HOST=<span style="color: #8b2252;">'10.0.0.100'</span>,
    MASTER_USER=<span style="color: #8b2252;">'repluser'</span>,
    MASTER_PASSWORD=<span style="color: #8b2252;">'xxx'</span>,
    MASTER_PORT=3306,
    MASTER_AUTO_POSITION=1;
mysql&gt;<span style="color: #a020f0;">start</span> slave;

#&#20027;&#26381;&#21153;&#22120;&#19978;&#30340;&#26085;&#24535;&#33410;&#28857;
mysql&gt; show master logs;
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-----------+</span>
| Log_name           | File_size |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-----------+</span>
| centos8-bin.000001 |       177 |
| centos8-bin.000002 |       437 |
| centos8-bin.000003 |       448 |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-----------+</span>
3 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.00 sec)

#&#20174;&#26381;&#21153;&#22120;
mysql&gt; show slave status\G;
************************* 1. <span style="color: #228b22;">row</span> ***************************
               Slave_IO_State: Waiting <span style="color: #a020f0;">for</span> master <span style="color: #a020f0;">to</span> send event
                  Master_Host: 10.0.0.8
                  Master_User: repluser
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: centos8-bin.000003
          Read_Master_Log_Pos: 448
               Relay_Log_File: centos8-relay-bin.000002
                Relay_Log_Pos: 665
        Relay_Master_Log_File: centos8-bin.000003
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 448
              Relay_Log_Space: 874
              Until_Condition: <span style="color: #a020f0;">None</span>
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: <span style="color: #a020f0;">No</span>
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: <span style="color: #a020f0;">No</span>
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 1
                  Master_UUID: f61f784f-afbe-11ea-8710-000c2930800a
             Master_Info_File: /<span style="color: #a020f0;">data</span>/mysql/master.info
                    SQL_Delay: 0
          SQL_Remaining_Delay: <span style="color: #a020f0;">NULL</span>
      Slave_SQL_Running_State: Slave has <span style="color: #a020f0;">read</span> <span style="color: #a020f0;">all</span> relay log; waiting <span style="color: #a020f0;">for</span> <span style="color: #a020f0;">more</span> updates
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: f61f784f-afbe-11ea-8710-000c2930800a:1
            Executed_Gtid_Set: f61f784f-afbe-11ea-8710-000c2930800a:1
                Auto_Position: 1
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.01 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:99119b23-45e8-48ff-92e5-62c97ef7129d" class="outline-4">
<h4 id="h:99119b23-45e8-48ff-92e5-62c97ef7129d">复制的监控和维护</h4>
<div class="outline-text-4" id="text-h:99119b23-45e8-48ff-92e5-62c97ef7129d">
</div>
<div id="outline-container-h:8e9a5133-3f7e-404b-99d9-d43d00f56232" class="outline-5">
<h5 id="h:8e9a5133-3f7e-404b-99d9-d43d00f56232">清理日志</h5>
<div class="outline-text-5" id="text-h:8e9a5133-3f7e-404b-99d9-d43d00f56232">
<div class="org-src-container">
<pre class="src src-sql">PURGE { <span style="color: #228b22;">BINARY</span> | MASTER } LOGS { <span style="color: #a020f0;">TO</span> <span style="color: #8b2252;">'log_name'</span> | <span style="color: #a020f0;">BEFORE</span> datetime_expr }
RESET MASTER <span style="color: #a020f0;">TO</span> # #mysql &#19981;&#25903;&#25345;
RESET SLAVE [<span style="color: #a020f0;">ALL</span>]   #&#28165;&#29702;&#20108;&#36827;&#21046;&#26085;&#24535;&#22312;&#20174;&#33410;&#28857;&#19978;&#29983;&#25104;&#30340;&#20449;&#24687;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d2bb8fec-749e-449f-a157-bb041fbe3cea" class="outline-5">
<h5 id="h:d2bb8fec-749e-449f-a157-bb041fbe3cea">复制监控</h5>
<div class="outline-text-5" id="text-h:d2bb8fec-749e-449f-a157-bb041fbe3cea">
<div class="org-src-container">
<pre class="src src-sql">SHOW MASTER STATUS
SHOW <span style="color: #228b22;">BINARY</span> LOGS
SHOW BINLOG EVENTS
SHOW SLAVE STATUS
SHOW PROCESSLIST
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ff4591ee-9a69-484c-8cab-1d9e07d2cbfe" class="outline-5">
<h5 id="h:ff4591ee-9a69-484c-8cab-1d9e07d2cbfe">从服务器是否落后于主服务</h5>
<div class="outline-text-5" id="text-h:ff4591ee-9a69-484c-8cab-1d9e07d2cbfe">
<div class="org-src-container">
<pre class="src src-sh">Seconds_Behind_Master&#65306;0   <span style="color: #b22222;">#</span><span style="color: #b22222;">0&#20195;&#34920;&#20027;&#33410;&#28857;&#21644;&#20174;&#33410;&#28857;&#23436;&#20840;&#21516;&#27493;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2ef7a0f9-1029-435b-8439-6b9ef00a3794" class="outline-5">
<h5 id="h:2ef7a0f9-1029-435b-8439-6b9ef00a3794">如何确定主从节点数据是否一致</h5>
<div class="outline-text-5" id="text-h:2ef7a0f9-1029-435b-8439-6b9ef00a3794">
<p>
percona-toolkit 工具
</p>
</div>
</div>
<div id="outline-container-h:fd70a6dd-f8aa-49ca-b5c8-fae3dd4b1f4a" class="outline-5">
<h5 id="h:fd70a6dd-f8aa-49ca-b5c8-fae3dd4b1f4a">数据不一致如何修复</h5>
<div class="outline-text-5" id="text-h:fd70a6dd-f8aa-49ca-b5c8-fae3dd4b1f4a">
<p>
删除从数据库，重新复制
</p>
</div>
</div>
</div>
<div id="outline-container-h:d1d77357-557b-4865-ad89-658d9a702f55" class="outline-4">
<h4 id="h:d1d77357-557b-4865-ad89-658d9a702f55">复制的问题和解决方案</h4>
<div class="outline-text-4" id="text-h:d1d77357-557b-4865-ad89-658d9a702f55">
</div>
<div id="outline-container-h:c48dafb9-8de4-43d9-82d6-9903ca00a320" class="outline-5">
<h5 id="h:c48dafb9-8de4-43d9-82d6-9903ca00a320">数据损坏或丢失</h5>
<div class="outline-text-5" id="text-h:c48dafb9-8de4-43d9-82d6-9903ca00a320">
<ul class="org-ul">
<li>Master：MHA + semisync replication半同步</li>
<li>Slave： 重新复制</li>
</ul>
</div>
</div>
<div id="outline-container-h:e27fd0d8-a3a8-4466-a930-4c49fc83d227" class="outline-5">
<h5 id="h:e27fd0d8-a3a8-4466-a930-4c49fc83d227">不惟一的server id</h5>
<div class="outline-text-5" id="text-h:e27fd0d8-a3a8-4466-a930-4c49fc83d227">
<p>
重新复制
</p>
</div>
</div>
<div id="outline-container-h:2851788f-e1b2-4a1a-95a6-eee7901f2679" class="outline-5">
<h5 id="h:2851788f-e1b2-4a1a-95a6-eee7901f2679">复制延迟</h5>
<div class="outline-text-5" id="text-h:2851788f-e1b2-4a1a-95a6-eee7901f2679">
<ul class="org-ul">
<li>需要额外的监控工具的辅助</li>
<li>一从多主：mariadb10 版后支持</li>
<li>多线程复制：对多个数据库复制</li>
</ul>
</div>
</div>
<div id="outline-container-h:aeaebffb-219f-457f-a0a9-ebe08bcbc070" class="outline-5">
<h5 id="h:aeaebffb-219f-457f-a0a9-ebe08bcbc070">MySQL主从数据不一致</h5>
<div class="outline-text-5" id="text-h:aeaebffb-219f-457f-a0a9-ebe08bcbc070">
</div>
<ul class="org-ul">
<li><a id="h:167674e2-9b80-4de4-858a-4bdc5ad5db50"></a>造成主从不一致的原因<br>
<div class="outline-text-6" id="text-h:167674e2-9b80-4de4-858a-4bdc5ad5db50">
<ul class="org-ul">
<li>主库binlog格式为Statement，同步到从库执行后可能造成主从不一致。</li>
<li>主库执行更改前有执行set sql_log_bin=0，会使主库不记录binlog，从库也
无法变更这部分数据。</li>
<li>从节点未设置只读，误操作写入数据</li>
<li>主库或从库意外宕机，宕机可能会造成binlog或者relaylog文件出现损坏，导
致主从不一致</li>
<li>主从实例版本不一致，特别是高版本是主，低版本为从的情况下，主数据库上
面支持的功能，从数据库上面可能不支持该功能</li>
<li>MySQL自身bug导致</li>
</ul>
</div>
</li>
<li><a id="h:70c07a18-d34c-41d2-849c-5586cc48d1aa"></a>主从不一致修复方法<br>
<div class="outline-text-6" id="text-h:70c07a18-d34c-41d2-849c-5586cc48d1aa">
<ul class="org-ul">
<li><p>
将从库重新实现
</p>

<p>
虽然这也是一种解决方法，但是这个方案恢复时间比较慢，而且有时候从库也是承担一部分的查询操作的，不能贸然重建。
</p></li>

<li><p>
使用percona-toolkit工具辅助
</p>

<p>
PT工具包中包含pt-table-checksum和pt-table-sync两个工具，主要用于检测
主从是否一致以及修复数据不一致情况。这种方案优点是修复速度快，不需要
停止主从辅助，缺点是需要知识积累，需要时间去学习，去测试，特别是在生
产环境，还是要小心使用
</p>

<p>
关于使用方法，可以参考下面链接：<a href="https://www.cnblogs.com/feiren/p/7777218.html">https://www.cnblogs.com/feiren/p/7777218.html</a>
</p></li>

<li><p>
手动重建不一致的表
</p>

<p>
在从库发现某几张表与主库数据不一致，而这几张表数据量也比较大，手工比
对数据不现实，并且重做整个库也比较慢，这个时候可以只重做这几张表来修
复主从不一致这种方案缺点是在执行导入期间需要暂时停止从库复制，不过也
是可以接受的
</p></li>
</ul>

<p>
范例：A,B,C这三张表主从数据不一致
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">---t1 stop salve---t2 dump--t3 start slave--</span>

1&#12289;&#20174;&#24211;&#20572;&#27490;Slave&#22797;&#21046;
mysql&gt;stop slave;

2&#12289;&#22312;&#20027;&#24211;&#19978;dump&#36825;&#19977;&#24352;&#34920;&#65292;&#24182;&#35760;&#24405;&#19979;&#21516;&#27493;&#30340;binlog&#21644;POS&#28857;
mysqldump -uroot -pxxx -q --single-transaction --master-data=2 testdb A B C &gt;/backup/A_B_C.sql

3&#12289;&#26597;&#30475;A_B_C.sql&#25991;&#20214;&#65292;&#25214;&#20986;&#35760;&#24405;&#30340;binlog&#21644;POS&#28857;
head A_B_C.sql
&#20363;&#22914;:<span style="color: #a0522d;">MASTERLOGFILE</span>=<span style="color: #8b2252;">'mysql-bin.888888'</span>, <span style="color: #a0522d;">MASTERLOGPOS</span>=666666;

4&#12289;&#25226;A_B_C.sql&#25335;&#36125;&#21040;Slave&#26426;&#22120;&#19978;&#65292;&#24182;&#20570;&#25351;&#21521;&#26032;&#20301;&#32622;
mysql&gt;start slave until <span style="color: #a0522d;">MASTERLOGFILE</span>=<span style="color: #8b2252;">'mysql-bin.888888'</span>, <span style="color: #a0522d;">MASTERLOGPOS</span>=666666;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#19978;&#25351;&#20196;&#26159;&#20026;&#20102;&#20445;&#38556;&#20854;&#20182;&#34920;&#30340;&#25968;&#25454;&#19981;&#20002;&#22833;&#65292;&#19968;&#30452;&#21516;&#27493;&#65292;&#30452;&#21040;&#21516;&#27493;&#23436;&#37027;&#20010;&#28857;&#32467;&#26463;&#65292;A,B,C&#34920;&#30340;&#25968;&#25454;&#22312;&#20043;&#21069;&#30340;&#22791;&#20221;&#24050;&#32463;&#29983;&#25104;&#20102;&#19968;&#20221;&#24555;&#29031;&#65292;&#21482;&#38656;&#35201;&#23548;&#20837;&#36827;&#20837;&#65292;&#28982;&#21518;&#24320;&#21551;&#21516;&#27493;&#21363;&#21487;</span>

5&#12289;&#22312;Slave&#26426;&#22120;&#19978;&#23548;&#20837;A_B_C.sql
mysql -uroot -pxxx testdb
mysql&gt;set <span style="color: #a0522d;">sql_log_bin</span>=0;
mysql&gt;source /backup/A_B_C.sql
mysql&gt;set <span style="color: #a0522d;">sql_log_bin</span>=1;

6&#12289;&#23548;&#20837;&#23436;&#27605;&#21518;&#65292;&#20174;&#24211;&#24320;&#21551;&#21516;&#27493;&#21363;&#21487;&#12290;
mysql&gt;start slave;
</pre>
</div>
</div>
</li>
<li><a id="h:9aa0e190-62b3-4c8b-bb3c-e5def32a65cc"></a>如何避免主从不一致<br>
<div class="outline-text-6" id="text-h:9aa0e190-62b3-4c8b-bb3c-e5def32a65cc">
<ul class="org-ul">
<li>主库binlog采用ROW格式</li>
<li>主从实例数据库版本保持一致</li>
<li>主库做好账号权限把控，不可以执行set sql_log_bin=0</li>
<li>从库开启只读，不允许人为写入</li>
<li>定期进行主从一致性检验</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:9929b512-8098-4e62-9b02-a45d3c3298cd" class="outline-3">
<h3 id="h:9929b512-8098-4e62-9b02-a45d3c3298cd">MySQL 中间件代理服务器</h3>
<div class="outline-text-3" id="text-h:9929b512-8098-4e62-9b02-a45d3c3298cd">
</div>
<div id="outline-container-h:908a8f2f-6510-49dd-8edf-1e96e1e08960" class="outline-4">
<h4 id="h:908a8f2f-6510-49dd-8edf-1e96e1e08960">关系型数据库和 NoSQL 数据库</h4>
<div class="outline-text-4" id="text-h:908a8f2f-6510-49dd-8edf-1e96e1e08960">
<p>
数据库主要分为两大类：关系型数据库与 NoSQL 数据库。
</p>

<ul class="org-ul">
<li>关系型数据库，是建立在关系模型基础上的数据库，其借助于集合代数等数学
概念和方法来处理数据库中的数据。主流的MySQL、Oracle、MS SQL Server
和 DB2 都属于这类传统数据库。</li>

<li>NoSQL 数据库，全称为 Not Only SQL，意思就是适用关系型数据库的时候就
使用关系型数据库，不适用的时候也没有必要非使用关系型数据库不可，可以
考虑使用更加合适的数据存储。主要分为临时性键值存储（memcached、
Redis）、永久性键值存储（ROMA、Redis）、面向文档的数据库（MongoDB、
CouchDB）、面向列的数据库（Cassandra、HBase），每种NoSQL 都有其特有
的使用场景及优点。</li>
</ul>

<p>
Oracle，mysql 等传统的关系数据库非常成熟并且已大规模商用，为什么还要用
NoSQL数据库呢？主要是由于随着互联网发展，数据量越来越大，对性能要求越
来越高，传统数据库存在着先天性的缺陷，即单机（单库）性能瓶颈，并且扩展
困难。这样既有单机单库瓶颈，却又扩展困难，自然无法满足日益增长的海量数
据存储及其性能要求，所以才会出现了各种不同的NoSQL 产品，NoSQL根本性的
优势在于在云计算时代，简单、易于大规模分布式扩展，并且读写性能非常高
</p>

<p>
<b>RDBMS和NOSQL的特点及优缺点</b> ：
</p>


<figure id="orga7ef9ae">
<img src="./images/20200704142459473.png" alt="20200704142459473.png" width="60%">

</figure>
</div>
</div>
<div id="outline-container-h:6ee2ce35-6080-4fc9-818a-386fbe8d9a45" class="outline-4">
<h4 id="h:6ee2ce35-6080-4fc9-818a-386fbe8d9a45">数据切分</h4>
<div class="outline-text-4" id="text-h:6ee2ce35-6080-4fc9-818a-386fbe8d9a45">
<p>
简单来说，就是指通过某种特定的条件，将我们存放在同一个数据库中的数据分
散存放到多个数据库（主机）上面，以达到分散单台设备负载的效果。
</p>

<p>
数据的切分（Sharding）根据其切分规则的类型，可以分为两种切分模式。
</p>

<p>
一种是按照不同的表（或者Schema）来切分到不同的数据库（主机）之上，这种
切可以称之为数据的垂直（纵向）切分；另外一种则是根据表中的数据的逻辑关
系，将同一个表中的数据按照某种条件拆分到多台数据库（主机）上面，这种切
分称之为数据的水平（横向）切分。
</p>

<p>
垂直切分的最大特点就是规则简单，实施也更为方便，尤其适合各业务之间的耦
合度非常低，相互影响很小，业务逻辑非常清晰的系统。在这种系统中，可以很
容易做到将不同业务模块所使用的表分拆到不同的数据库中。根据不同的表来进
行拆分，对应用程序的影响也更小，拆分规则也会比较简单清晰。
</p>

<p>
水平切分于垂直切分相比，相对来说稍微复杂一些。因为要将同一个表中的不同
数据拆分到不同的数据对于应用程序来说，拆分规则本身就较根据表名来拆分更
为复杂，后期的数据维护也会更为复杂一些。
</p>
</div>
<div id="outline-container-h:a1caa0f5-14d9-4f9a-8ab6-034ab6ce6e02" class="outline-5">
<h5 id="h:a1caa0f5-14d9-4f9a-8ab6-034ab6ce6e02">垂直切分</h5>
<div class="outline-text-5" id="text-h:a1caa0f5-14d9-4f9a-8ab6-034ab6ce6e02">
<p>
表之间不能有连接关系
</p>


<figure id="orga5d542b">
<img src="./images/20200704142511247.png" alt="20200704142511247.png" width="60%">

</figure>


<p>
一个数据库由很多表的构成，每个表对应着不同的业务，垂直切分是指按照业务将表进行分类，分布到不同的数据库上面，这样也就将数据或者说压力分担到不同的库上面，如下图：
</p>


<figure id="org9da7e99">
<img src="./images/20200704142522732.png" alt="20200704142522732.png" width="60%">

</figure>



<figure id="org410de65">
<img src="./images/Snipaste_2023-05-16_22-55-47.jpg" alt="Snipaste_2023-05-16_22-55-47.jpg" width="60%">

</figure>

<p>
系统被切分成了，用户，订单交易，支付几个模块。一个架构设计较好的应用系
统，其总体功能肯定是由很多个功能模块所组成的，而每一个功能模块所需要的
数据对应到数据库中就是一个或者多个表。而在架构设计中，各个功能模块相互
之间的交互点越统一越少，系统的耦合度就越低，系统各个模块的维护性以及扩
展性也就越好。这样的系统，实现数据的垂直切分也就越容易。
</p>

<p>
但是往往系统之有些表难以做到完全独立，存在着跨库 join的情况，对于这类
表，就需要去做平衡，是数据库让步业务，共用一个数据源，还是分成多个库，
业务之间通过接口来做调用。在系统初期数据量比较少，或者资源有限的情况下，
会选择共用数据源，但是当数据发展到了一定的规模，负载很大的情况，就需要
必须去做分割。
</p>

<p>
一般来讲业务存在着复杂 join的场景是难以切分的，往往业务独立的易于切分。
如何切分，切分到何种程度是考验技术架构的一个难题。
</p>

<p>
<b>垂直切分的优缺点</b> ：
</p>

<p>
<b>优点</b> ：
</p>

<ul class="org-ul">
<li>拆分后业务清晰，拆分规则明确</li>
<li>系统之间整合或扩展容易</li>
<li>数据维护简</li>
</ul>

<p>
<b>缺点</b> ：
</p>

<ul class="org-ul">
<li>部分业务表无法 join，只能通过接口方式解决，提高了系统复杂度；</li>
<li>受每种业务不同的限制存在单库性能瓶颈，不易数据扩展跟性能提高</li>
<li>事务处理复杂</li>
</ul>

<p>
由于垂直切分是按照业务的分类将表分散到不同的库，所以有些业务表会过于庞
大，存在单库读写与存储瓶颈，所以就需要水平拆分来做解决。
</p>
</div>
</div>
<div id="outline-container-h:eb23a234-94fe-4522-8f39-a4da5f4a5c42" class="outline-5">
<h5 id="h:eb23a234-94fe-4522-8f39-a4da5f4a5c42">水平切分</h5>
<div class="outline-text-5" id="text-h:eb23a234-94fe-4522-8f39-a4da5f4a5c42">

<figure id="org9b90167">
<img src="./images/20200704142611584.png" alt="20200704142611584.png" width="60%">

</figure>

<p>
<b>对应shard中查询相关数据</b>
</p>


<figure id="org217aa78">
<img src="./images/20200704142620806.png" alt="20200704142620806.png" width="60%">

</figure>

<p>
相对于垂直拆分，水平拆分不是将表做分类，而是按照某个字段的某种规则来分
散到多个库之中，每个表中包含一部分数据。简单来说，我们可以将数据的水平
切分理解为是按照数据行的切分，就是将表中的某些行切分到一个数据库，而另
外的某些行又切分到其他的数据库中，如图：
</p>


<figure id="orgcea2464">
<img src="./images/20200704142630291.png" alt="20200704142630291.png" width="60%">

</figure>

<p>
拆分数据就需要定义分片规则。关系型数据库是行列的二维模型，拆分的第一原
则是找到拆分维度。比如：从会员的角度来分析，商户订单交易类系统中查询会
员某天某月某个订单，那么就需要按照会员结合日期来拆分，不同的数据按照会
员 ID 做分组，这样所有的数据查询 join都会在单库内解决；如果从商户的角
度来讲，要查询某个商家某天所有的订单数，就需要按照商户 ID做拆分；但是
如果系统既想按会员拆分，又想按商家数据，则会有一定的困难。如何找到合适
的分片规则需要综合考虑衡量。
</p>

<p>
几种典型的分片规则包括：
</p>

<ul class="org-ul">
<li>按照用户 ID求模，将数据分散到不同的数据库，具有相同数据用户的数据都被分散到一个库中</li>
<li>按照日期，将不同月甚至日的数据分散到不同的库中</li>
<li>按照某个特定的字段求摸，或者根据特定范围段分散到不同的库中</li>
</ul>

<p>
如图，切分原则都是根据业务找到适合的切分规则分散到不同的库，下面用用户ID 求模举例：
</p>


<figure id="orgd358139">
<img src="./images/20200704142638128.png" alt="20200704142638128.png" width="60%">

</figure>

<p>
既然数据做了拆分有优点也就优缺点。
</p>

<p>
<b>优点</b>:
</p>

<ul class="org-ul">
<li>拆分规则抽象好，join 操作基本可以数据库做</li>
<li>不存在单库大数据，高并发的性能瓶颈</li>
<li>应用端改造较少</li>
<li>提高了系统的稳定性跟负载能力</li>
</ul>

<p>
<b>缺点</b>:
</p>

<ul class="org-ul">
<li>拆分规则难以抽象</li>
<li>分片事务一致性难以解决</li>
<li>数据多次扩展难度跟维护量极大</li>
<li>跨库 join 性能较差</li>
</ul>

<p>
前面讲了垂直切分跟水平切分的不同跟优缺点，会发现每种切分方式都有缺点，但共同特点缺点有：
</p>

<ul class="org-ul">
<li>引入分布式事务的问题</li>
<li>跨节点 Join 的问题</li>
<li>跨节点合并排序分页问题</li>
<li>多数据源管理问题</li>
</ul>

<p>
针对数据源管理，目前主要有两种思路：
</p>

<p>
A.客户端模式，在每个应用程序模块中配置管理自己需要的一个（或者多个）数
据源，直接访问各个数据库，在模块内完成数据的整合
</p>

<p>
B.通过中间代理层来统一管理所有的数据源，后端数据库集群对前端应用程序透
明；可能90%以上的人在面对上面这两种解决思路的时候都会倾向于选择第二种，
尤其是系统不断变得庞大复杂的时候。确实，这是一个非常正确的选择，虽然短
期内需要付出的成本可能会相对更大一些，但是对整个系统的扩展性来说，是非
常有帮助的。
</p>

<p>
MySQL中间件服务器可以通过将数据切分解决传统数据库的缺陷，又有了 NoSQL
易于扩展的优点。通过中间代理层规避了多数据源的处理问题，对应用完全透明，
同时对数据切分后存在的问题，也做了解决方案。
</p>

<p>
由于数据切分后数据 Join 的难度在此也分享一下数据切分的经验：
</p>

<p>
第一原则：能不切分尽量不要切分
</p>

<p>
第二原则：如果要切分一定要选择合适的切分规则，提前规划好。
</p>

<p>
第三原则：数据切分尽量通过数据冗余或表分组（Table Group）来降低跨库 Join的可能
</p>

<p>
第四原则：由于数据库中间件对数据 Join实现的优劣难以把握，而且实现高性能难度极大，业务读取尽量 少使用多表Join。
</p>
</div>
</div>
</div>
<div id="outline-container-h:b23a49a8-6bc9-4f71-b311-5223b2ff8aa2" class="outline-4">
<h4 id="h:b23a49a8-6bc9-4f71-b311-5223b2ff8aa2">MySQL中间件各种应用</h4>
<div class="outline-text-4" id="text-h:b23a49a8-6bc9-4f71-b311-5223b2ff8aa2">

<figure id="orga7ac2b7">
<img src="./images/20200704142649914.png" alt="20200704142649914.png" width="60%">

</figure>

<ul class="org-ul">
<li>mysql-proxy：Oracle，<a href="https://downloads.mysql.com/archives/proxy/">https://downloads.mysql.com/archives/proxy/</a></li>
<li>Atlas：Qihoo，<a href="https://github.com/Qihoo360/Atlas/blob/master/README_ZH.md">https://github.com/Qihoo360/Atlas/blob/master/README_ZH.md</a></li>
<li>dbproxy：美团，<a href="https://github.com/Meituan-Dianping/DBProxy">https://github.com/Meituan-Dianping/DBProxy</a></li>
<li>Cetus：网易乐得，<a href="https://github.com/Lede-Inc/cetus">https://github.com/Lede-Inc/cetus</a></li>
<li>Amoeba：<a href="https://sourceforge.net/projects/amoeba/">https://sourceforge.net/projects/amoeba/</a></li>
<li>Cobar：阿里巴巴，Amoeba的升级版， <a href="https://github.com/alibaba/cobar">https://github.com/alibaba/cobar</a></li>
<li>Mycat：基于Cobar <a href="http://www.mycat.io/">http://www.mycat.io/</a> (原网站)</li>
<li><a href="http://www.mycat.org.cn/">http://www.mycat.org.cn/</a></li>
<li><a href="https://github.com/MyCATApache/Mycat-Server">https://github.com/MyCATApache/Mycat-Server</a></li>
<li>ProxySQL：<a href="https://proxysql.com/">https://proxysql.com/</a></li>
</ul>
</div>
</div>
<div id="outline-container-h:675285e4-bab1-406a-b953-d0dfe472424c" class="outline-4">
<h4 id="h:675285e4-bab1-406a-b953-d0dfe472424c">Mycat</h4>
<div class="outline-text-4" id="text-h:675285e4-bab1-406a-b953-d0dfe472424c">
</div>
<div id="outline-container-h:a93777d8-98cd-4116-807c-19da89718e31" class="outline-5">
<h5 id="h:a93777d8-98cd-4116-807c-19da89718e31">Mycat介绍</h5>
<div class="outline-text-5" id="text-h:a93777d8-98cd-4116-807c-19da89718e31">
<p>
在整个IT系统架构中，数据库是非常重要，通常又是访问压力较大的一个服务，
除了在程序开发的本身做优化，如：SQL语句优化、代码优化，数据库的处理本
身优化也是非常重要的。主从、热备、分表分库等都是系统发展迟早会遇到的技
术问题问题。Mycat是一个广受好评的数据库中间件，已经在很多产品上进行使
用了。
</p>

<p>
Mycat是一个开源的分布式数据库系统，是一个实现了MySQL协议的服务器，前端
用户可以把它看作是一个数据库代理（类似于MysqlProxy），用MySQL客户端工
具和命令行访问，而其后端可以用MySQL原生协议与多个MySQL服务器通信，也可
以用JDBC协议与大多数主流数据库服务器通信，其核心功能是分表分库，即将一
个大表水平分割为N个小表，存储在后端MySQL服务器里或者其他数据库里。
</p>

<p>
Mycat发展到目前的版本，已经不是一个单纯的MySQL代理了，它的后端可以支持
MySQL、SQLServer、Oracle、DB2、PostgreSQL等主流数据库，也支持MongoDB这
种新型NoSQL方式的存储，未来还会支持更多类型的存储。而在最终用户看来，
无论是那种存储方式，在MyCat里，都是一个传统的数据库表，支持标准的SQL语
句进行数据的操作，这样一来，对前端业务系统来说，可以大幅降低开发难度，
提升开发速度
</p>

<p>
Mycat可以简单概括为
</p>

<ul class="org-ul">
<li>一个彻底开源的，面向企业应用开发的大数据库集群</li>
<li>支持事务、ACID、可以替代MySQL的加强版数据库</li>
<li>一个可以视为MySQL集群的企业级数据库，用来替代昂贵的Oracle集群</li>
<li>一个融合内存缓存技术、NoSQL技术、HDFS大数据的新型SQL Server</li>
<li>结合传统数据库和新型分布式数据仓库的新一代企业级数据库产品</li>
<li>一个新颖的数据库中间件产品</li>
</ul>

<p>
<b>Mycat 官网</b> ：<a href="http://www.mycat.org.cn/">http://www.mycat.org.cn/</a>
</p>

<p>
<b>Mycat关键特性</b>
</p>

<ul class="org-ul">
<li>支持SQL92标准</li>
<li>遵守MySQL 原生协议，跨语言，跨平台，跨数据库的通用中间件代理</li>
<li>基于心跳的自动故障切换，支持读写分离，支持MySQL主从，以及galera cluster集群</li>
<li>支持Galera for MySQL集群，Percona Cluster或者MariaDB cluster</li>
<li>基于Nio实现，有效管理线程，高并发问题</li>
<li>支持数据的多片自动路由与聚合，支持sum,count,max等常用的聚合函数,支持跨库分页</li>
<li>支持单库内部任意join，支持跨库2表join，甚至基于caltlet的多表join</li>
<li>支持通过全局表，ER关系的分片策略，实现了高效的多表join查询</li>
<li>支持多租户方案</li>
<li>支持分布式事务（弱xa）</li>
<li>支持全局序列号，解决分布式下的主键生成问题</li>
<li>分片规则丰富，插件化开发，易于扩展</li>
<li>强大的web，命令行监控</li>
<li>支持前端作为mysq通用代理，后端JDBC方式支持Oracle、DB2、SQL Server 、mongodb 、巨杉</li>
<li>支持密码加密</li>
<li>支持服务降级</li>
<li>支持IP白名单</li>
<li>支持SQL黑名单、sql注入攻击拦截</li>
<li>支持分表（1.6）</li>
<li>集群基于ZooKeeper管理，在线升级，扩容，智能优化，大数据处理（2.0开发版）</li>
</ul>

<p>
<b>为什么要用MyCat</b>
</p>

<p>
这里要先搞清楚Mycat和MySQL的区别（Mycat的核心作用）。我们可以把上层看
作是对下层的抽象，例如操作系统是对各类计算机硬件的抽象。那么我们什么时
候需要抽象？假如只有一种硬件的时候，我们需要开发一个操作系统吗？再比如
一个项目只需要一个人完成的时候不需要leader，但是当需要几十人完成时，就
应该有一个管理者，发挥沟通协调等作用，而这个管理者对于他的上层来说就是
对项目组的抽象
</p>

<p>
同样的，当我们的应用只需要一台数据库服务器的时候我们并不需要Mycat，而
如果你需要分库甚至分表，这时候应用要面对很多个数据库的时候，这个时候就
需要对数据库层做一个抽象，来管理这些数据库，而最上面的应用只需要面对一
个数据库层的抽象或者说数据库中间件就好了，这就是Mycat的核心作用。所以
可以这样理解：数据库是对底层存储文件的抽象，而Mycat是对数据库的抽象
</p>


<p>
<b>Mycat工作原理</b>
</p>

<p>
<img src="./images/20200704142704226.png" alt="20200704142704226.png">
<img src="./images/Snipaste_2023-05-16_23-21-57.jpg" alt="Snipaste_2023-05-16_23-21-57.jpg">
</p>

<p>
Mycat外还有一层代理，是为了解决Mycat的单点失败问题，keeplaive可以解决两个服务器共享一个IP的功能，对外只有一个VIP（虚拟）
</p>

<p>
Mycat的原理中最重要的一个动词是“拦截”，它拦截了用户发送过来的SQL语句，首先对SQL语句做了一些特定的分析：如分片分析、路由分析、读写分离分析、缓存分析等，然后将此SQL发往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户
</p>

<p>
<b>Mycat应用场景</b>
</p>

<p>
Mycat适用的场景很丰富，以下是几个典型的应用场景
</p>

<ul class="org-ul">
<li>单纯的读写分离，此时配置最为简单，支持读写分离，主从切换</li>
<li>分表分库，对于超过1000万的表进行分片，最大支持1000亿的单表分片</li>
<li>多租户应用，每个应用一个库，但应用程序只连接Mycat，从而不改造程序本身，实现多租户化</li>
<li>报表系统，借助于Mycat的分表能力，处理大规模报表的统计</li>
<li>替代Hbase，分析大数据</li>
<li>作为海量数据实时查询的一种简单有效方案，比如100亿条频繁查询的记录需
要在3秒内查询出来结果，除了基于主键的查询，还可能存在范围查询或其他
属性查询，此时Mycat可能是最简单有效的选择</li>
<li>Mycat长期路线图</li>
<li>强化分布式数据库中间件的方面的功能，使之具备丰富的插件、强大的数据库
智能优化功能、全面的系统监控能力、以及方便的数据运维工具，实现在线数
据扩容、迁移等高级功能</li>
<li>进一步挺进大数据计算领域，深度结合Spark
Stream和Storm等分布式实时流引擎，能够完成快速的巨表关联、排序、分组聚合等
OLAP方向的能力，并集成一些热门常用的实时分析算法，让工程师以及DBA们更容易用Mycat实现一些高级数据分析处理功能</li>
<li>不断强化Mycat开源社区的技术水平，吸引更多的IT技术专家，使得Mycat社区
成为中国的Apache，并将Mycat推到Apache基金会，成为国内顶尖开源项目，
最终能够让一部分志愿者成为专职的Mycat开发者，荣耀跟实力一起提升</li>
</ul>

<p>
<b>Mycat不适合的应用场景</b>
</p>

<ul class="org-ul">
<li>设计使用Mycat时有非分片字段查询，请慎重使用Mycat，可以考虑放弃！</li>

<li>设计使用Mycat时有分页排序，请慎重使用Mycat，可以考虑放弃！</li>

<li>设计使用Mycat时如果要进行表JOIN操作，要确保两个表的关联字段具有相同的数据分布，否则请慎重使用Mycat，可以考虑放弃！</li>

<li>设计使用Mycat时如果有分布式事务，得先看是否得保证事务得强一致性，否则请慎重使用Mycat，可以考虑放弃！</li>
</ul>

<p>
<b>MyCat的高可用性</b> ：
</p>

<p>
需要注意: 在生产环境中, Mycat节点最好使用双节点, 即双机热备环境,
防止Mycat这一层出现单点故障。可以使用的高可用集群方式有:
</p>

<ul class="org-ul">
<li>Keepalived+Mycat+Mysql</li>
<li>Keepalived+LVS+Mycat+Mysql</li>
<li>Keepalived+Haproxy+Mycat+Mysql</li>
</ul>
</div>
</div>
<div id="outline-container-h:b0ea64ab-0095-4040-8b8c-38bbdd5bb793" class="outline-5">
<h5 id="h:b0ea64ab-0095-4040-8b8c-38bbdd5bb793">Mycat安装</h5>
<div class="outline-text-5" id="text-h:b0ea64ab-0095-4040-8b8c-38bbdd5bb793">
<p>
下载安装JDK
</p>

<div class="org-src-container">
<pre class="src src-sh">yum -y install java
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#35748;&#23433;&#35013;&#25104;&#21151;</span>
java -version
openjdk version <span style="color: #8b2252;">"1.8.0_201"</span>
OpenJDK Runtime Environment (build 1.8.0_201-b09)
OpenJDK 64-Bit Server VM (build 25.201-b09, mixed mode)
</pre>
</div>

<p>
下载安装mycat
</p>

<div class="org-src-container">
<pre class="src src-sh">wget http://dl.mycat.org.cn/1.6.7.4/Mycat-server-1.6.7.4-release/Mycat-server-1.6.7.4-release-20200105164103-linux.tar.gz

mkdir /app
tar xvf Mycat-server-1.6.7.4-release-20200105164103-linux.tar.gz -C /app

ls /app/mycat/
bin catlet conf lib logs version.txt
</pre>
</div>

<p>
mycat安装目录结构：
</p>

<ul class="org-ul">
<li>bin mycat命令，启动、重启、停止等</li>
<li>catlet catlet为Mycat的一个扩展功能</li>
<li>conf Mycat 配置信息,重点关注</li>
<li>lib Mycat引用的jar包，Mycat是java开发的</li>
<li>logs 日志文件，包括Mycat启动的日志和运行的日志</li>
<li>version.txt mycat版本说明</li>
</ul>

<p>
logs目录:
</p>

<ul class="org-ul">
<li>wrapper.log mycat启动日志</li>
<li>mycat.log mycat详细工作日志</li>
</ul>

<p>
Mycat的配置文件都在conf目录里面，这里介绍几个常用的文件：
</p>

<ul class="org-ul">
<li>server.xml Mycat软件本身相关的配置文件，设置账号、参数等</li>
<li>schema.xml
Mycat对应的物理数据库和数据库表的配置,读写分离、高可用、分布式策略定制、节点控制</li>
<li>rule.xml
Mycat分片（分库分表）规则配置文件,记录分片规则列表、使用方法等</li>
</ul>

<p>
启动和连接
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#29615;&#22659;&#21464;&#37327;</span>
vim /etc/profile.d/mycat.sh
<span style="color: #a0522d;">PATH</span>=/app/mycat/bin:$<span style="color: #a0522d;">PATH</span>
<span style="color: #483d8b;">source</span> /etc/profile.d/mycat.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;</span>
mycat start
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26085;&#24535;&#65292;&#30830;&#23450;&#25104;&#21151;</span>
cat /app/mycat/logs/wrapper.log
...&#30465;&#30053;...
INFO | jvm 1 | 2019/11/01 21:41:02 | MyCAT Server startup successfully. see logs<span style="color: #a020f0;"> in</span> logs/mycat.log

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;mycat&#65306;</span>
mysql -uroot -p123456 -h 127.0.0.1 -P8066
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5c9be5a8-69c9-4a67-8700-9bdc6250cf64" class="outline-5">
<h5 id="h:5c9be5a8-69c9-4a67-8700-9bdc6250cf64">Mycat 主要配置文件说明</h5>
<div class="outline-text-5" id="text-h:5c9be5a8-69c9-4a67-8700-9bdc6250cf64">
<p>
server.xml
</p>

<p>
存放Mycat软件本身相关的配置文件，比如：连接Mycat的用户，密码，数据库名称等
</p>

<p>
server.xml文件中配置的参数解释说明：
</p>

<div class="org-src-container">
<pre class="src src-sh">&#21442;&#25968; &#35828;&#26126;
user &#29992;&#25143;&#37197;&#32622;&#33410;&#28857;
name &#23458;&#25143;&#31471;&#30331;&#24405;MyCAT&#30340;&#29992;&#25143;&#21517;&#65292;&#20063;&#23601;&#26159;&#23458;&#25143;&#31471;&#29992;&#26469;&#36830;&#25509;Mycat&#30340;&#29992;&#25143;&#21517;&#12290;
password &#23458;&#25143;&#31471;&#30331;&#24405;MyCAT&#30340;&#23494;&#30721;
schemas &#25968;&#25454;&#24211;&#21517;&#65292;&#36825;&#37324;&#20250;&#21644;schema.xml&#20013;&#30340;&#37197;&#32622;&#20851;&#32852;&#65292;&#22810;&#20010;&#29992;&#36887;&#21495;&#20998;&#24320;&#65292;&#20363;&#22914;:db1,db2
privileges &#37197;&#32622;&#29992;&#25143;&#38024;&#23545;&#34920;&#30340;&#22686;&#21024;&#25913;&#26597;&#30340;&#26435;&#38480;
readOnly mycat&#36923;&#36753;&#24211;&#25152;&#20855;&#26377;&#30340;&#26435;&#38480;&#12290;true&#20026;&#21482;&#35835;&#65292;false&#20026;&#35835;&#20889;&#37117;&#26377;&#65292;&#40664;&#35748;&#20026;false
</pre>
</div>

<p>
注意：
</p>

<ul class="org-ul">
<li>server.xml文件里登录mycat的用户名和密码可以任意定义，这个账号和密码
是为客户机登录mycat时使用的账号信息</li>
<li>逻辑库名(如上面的TESTDB，也就是登录mycat后显示的库名，切换这个库之后，
显示的就是代理的真实mysql数据库的表)要在schema.xml里面也定义，否则会
导致mycat服务启动失败！</li>
<li>这里只定义了一个标签，所以把多余的都注释了。如果定义多个标签，即设置
多个连接mycat的用户名和密码，那么就需要在schema.xml文件中定义多个对
应的库！</li>
</ul>

<p>
<b>schema.xml</b>
</p>

<p>
是最主要的配置项，此文件关联mysql读写分离策略，读写分离、分库分表策略、
分片节点都是在此文件中配置的.MyCat作为中间件，它只是一个代理，本身并不
进行数据存储，需要连接后端的MySQL物理服务器，此文件就是用来连接MySQL服
务器的
</p>

<p>
<b>schema.xml文件中配置的参数解释说明</b> ：
</p>

<div class="org-src-container">
<pre class="src src-sh">&#21442;&#25968; &#35828;&#26126;
schema &#25968;&#25454;&#24211;&#35774;&#32622;&#65292;&#27492;&#25968;&#25454;&#24211;&#20026;&#36923;&#36753;&#25968;&#25454;&#24211;&#65292;name&#19982;server.xml&#20013;schema&#23545;&#24212;
dataNode &#20998;&#29255;&#20449;&#24687;&#65292;&#20063;&#23601;&#26159;&#20998;&#24211;&#30456;&#20851;&#37197;&#32622;
dataHost &#29289;&#29702;&#25968;&#25454;&#24211;&#65292;&#30495;&#27491;&#23384;&#20648;&#25968;&#25454;&#30340;&#25968;&#25454;&#24211;
</pre>
</div>

<p>
<b>配置说明</b>
</p>

<p>
name属性唯一标识dataHost标签，供上层的标签使用。
</p>

<p>
maxCon属性指定每个读写实例连接池的最大连接。也就是说，标签内嵌套的
writeHost、readHost标签都会使用这个属性的值来实例化出连接池的最大连接数
</p>

<p>
minCon属性指定每个读写实例连接池的最小连接，初始化连接池的大小
</p>

<p>
<b>每个节点的属性逐一说明</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">schema:
&#23646;&#24615; &#35828;&#26126;
name &#36923;&#36753;&#25968;&#25454;&#24211;&#21517;&#65292;&#19982;server.xml&#20013;&#30340;schema&#23545;&#24212;
checkSQLschema &#25968;&#25454;&#24211;&#21069;&#32512;&#30456;&#20851;&#35774;&#32622;&#65292;&#36825;&#37324;&#20026;false
sqlMaxLimit select &#26102;&#40664;&#35748;&#30340;limit&#65292;&#36991;&#20813;&#26597;&#35810;&#20840;&#34920;

table
&#23646;&#24615; &#35828;&#26126;
name &#34920;&#21517;&#65292;&#29289;&#29702;&#25968;&#25454;&#24211;&#20013;&#34920;&#21517;
dataNode &#34920;&#23384;&#20648;&#21040;&#21738;&#20123;&#33410;&#28857;&#65292;&#22810;&#20010;&#33410;&#28857;&#29992;&#36887;&#21495;&#20998;&#38548;&#12290;&#33410;&#28857;&#20026;&#19979;&#25991;dataNode&#35774;&#32622;&#30340;name
primaryKey &#20027;&#38190;&#23383;&#27573;&#21517;&#65292;&#33258;&#21160;&#29983;&#25104;&#20027;&#38190;&#26102;&#38656;&#35201;&#35774;&#32622;
autoIncrement &#26159;&#21542;&#33258;&#22686;
rule &#20998;&#29255;&#35268;&#21017;&#21517;&#65292;&#20855;&#20307;&#35268;&#21017;&#19979;&#25991;rule&#35814;&#32454;&#20171;&#32461;

dataNode
&#23646;&#24615; &#35828;&#26126;
name &#33410;&#28857;&#21517;&#65292;&#19982;table&#20013;dataNode&#23545;&#24212;
datahost &#29289;&#29702;&#25968;&#25454;&#24211;&#21517;&#65292;&#19982;datahost&#20013;name&#23545;&#24212;
database &#29289;&#29702;&#25968;&#25454;&#24211;&#20013;&#25968;&#25454;&#24211;&#21517;

dataHost
&#23646;&#24615; &#35828;&#26126;
name &#29289;&#29702;&#25968;&#25454;&#24211;&#21517;&#65292;&#19982;dataNode&#20013;dataHost&#23545;&#24212;
balance &#22343;&#34913;&#36127;&#36733;&#30340;&#26041;&#24335;
writeType &#20889;&#20837;&#26041;&#24335;
dbType &#25968;&#25454;&#24211;&#31867;&#22411;
heartbeat &#24515;&#36339;&#26816;&#27979;&#35821;&#21477;&#65292;&#27880;&#24847;&#35821;&#21477;&#32467;&#23614;&#30340;&#20998;&#21495;&#35201;&#21152;
</pre>
</div>

<p>
schema.xml文件中有三点需要注意：balance="1"，writeType="0"
,switchType="1"
</p>

<p>
schema.xml中的balance的取值决定了负载均衡对非事务内的读操作的处理。balance
属性负载均衡类型，目前的取值有 4 种：
</p>

<ol class="org-ol">
<li>balance="0"：不开启读写分离机制，所有读操作都发送到当前可用的
writeHost上,即读请求仅发送到writeHost上</li>
<li>balance="1"：一般用此模式，读请求随机分发到当前writeHost对应的
readHost和standby的writeHost上。即全部的readHost与stand by
writeHost 参与 select 语句的负载均衡，简单的说，当双主双从模式(M1
-&gt;S1 ， M2-&gt;S2，并且 M1 与 M2 互为主备)，正常情况下， M2,S1, S2都参
与 select语句的负载均衡</li>
<li>balance="2"：读请求随机分发到当前dataHost内所有的writeHost和
readHost上。即所有读操作都随机的在writeHost、readhost 上分发</li>
<li>balance="3"：读请求随机分发到当前writeHost对应的readHost上。即所有
读请求随机的分发到wiriterHost对应的 readhost 执行, writerHost 不负
担读压力，注意 balance=3 只在1.4 及其以后版本有，1.3 没有</li>
</ol>

<p>
<b>writeHost和readHost 标签</b>
</p>

<p>
这两个标签都指定后端数据库的相关配置给mycat，用于实例化后端连接池。
</p>

<p>
唯一不同的是：writeHost指定写实例、readHost指定读实例，组着这些读写实
例来满足系统的要求。
</p>

<p>
在一个dataHost内可以定义多个writeHost和readHost。但是，如果writeHost指
定的后端数据库宕机，那么这个writeHost绑定的所有readHost都将不可用。另
一方面，由于这个writeHost宕机系统会自动的检测到，并切换到备用的
writeHost上去
</p>

<p>
注意：
</p>

<p>
Mycat主从分离只是在读的时候做了处理，写入数据的时候，只会写入到
writehost，需要通过mycat的主从复制将数据复制到readhost
</p>
</div>
</div>
<div id="outline-container-h:ded17984-e30b-4dfe-820f-10aaa0061482" class="outline-5">
<h5 id="h:ded17984-e30b-4dfe-820f-10aaa0061482">实战案例：利用Mycat实现MySQL的读写分离</h5>
<div class="outline-text-5" id="text-h:ded17984-e30b-4dfe-820f-10aaa0061482">

<figure id="org5998b43">
<img src="./images/20200705114522661.png" alt="20200705114522661.png" width="60%">

</figure>


<p>
系统环境：
</p>

<div class="org-src-container">
<pre class="src src-sh">cat /etc/centos-release
CentOS Linux release 8.0.1905 (Core)
</pre>
</div>

<p>
服务器共三台
</p>

<div class="org-src-container">
<pre class="src src-sh">mycat-server 10.0.0.8   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#23384;&#24314;&#35758;2G&#20197;&#19978;</span>
mysql-master 10.0.0.18  Mysql8.0 &#25110;&#32773;Mariadb10.3.17
mysql-slave 10.0.0.28  Mysql8.0 &#25110;&#32773;Mariadb10.3.17
</pre>
</div>

<p>
关闭SELinux和防火墙
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl stop firewalld
setenforce 0
&#26102;&#38388;&#21516;&#27493;
</pre>
</div>

<p>
1、创建 MySQL 主从数据库
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum -y install mariadb-server
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;</span>
yum -y install mariadb-server
</pre>
</div>

<p>
<b>1) 修改master和slave上的配置文件</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">master&#19978;&#30340;my.cnf</span>
[root@centos8 ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
server-id = 1
log-bin

<span style="color: #b22222;">#</span><span style="color: #b22222;">slave&#19978;&#30340;my.cnf</span>
[mysqld]
server-id = 2

[root@centos8 ~]#systemctl start mariadb
</pre>
</div>

<p>
<b>2) Master上创建复制用户</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">[root@centos8 ~]#mysql -uroot -pxxx
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; show master logs;
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-----------+</span>
| Log_name           | File_size |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-----------+</span>
| mariadb-bin.000001 |       330 |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-----------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.000 sec)
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt;<span style="color: #a020f0;">GRANT</span> REPLICATION SLAVE <span style="color: #a020f0;">ON</span> *.* <span style="color: #a020f0;">TO</span> <span style="color: #8b2252;">'repluser'</span>@<span style="color: #8b2252;">'10.0.0.28'</span>
IDENTIFIED <span style="color: #a020f0;">BY</span> <span style="color: #8b2252;">'xxx'</span>;
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; FLUSH <span style="color: #a020f0;">PRIVILEGES</span>; #&#20445;&#35777;&#26435;&#38480;&#33021;&#29983;&#25928;
</pre>
</div>

<p>
<b>3) Slave上执行</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">[root@centos8 ~]#mysql -uroot -p
MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; CHANGE MASTER <span style="color: #a020f0;">TO</span>
-&gt; MASTER_HOST=<span style="color: #8b2252;">'10.0.0.18'</span>,
-&gt; MASTER_USER=<span style="color: #8b2252;">'repluser'</span>,
-&gt; MASTER_PASSWORD=<span style="color: #8b2252;">'xxx'</span>,
-&gt; MASTER_LOG_FILE=<span style="color: #8b2252;">'mariadb-bin.000001'</span>,
-&gt; MASTER_LOG_POS=330;

MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; <span style="color: #a020f0;">start</span> slave;
Query OK, 0 <span style="color: #a020f0;">rows</span> affected (0.00 sec)

MariaDB [(<span style="color: #a020f0;">none</span>)]&gt; show slave status\G
************************* 1. <span style="color: #228b22;">row</span> ***************************
                Slave_IO_State: Waiting <span style="color: #a020f0;">for</span> master <span style="color: #a020f0;">to</span> send event
                   Master_Host: 10.0.0.18
                   Master_User: repluser
                   Master_Port: 3306
                 Connect_Retry: 60
               Master_Log_File: mariadb-bin.000001
           Read_Master_Log_Pos: 527
                Relay_Log_File: mariadb-relay-bin.000002
                 Relay_Log_Pos: 754
         Relay_Master_Log_File: mariadb-bin.000001
              Slave_IO_Running: Yes
             Slave_SQL_Running: Yes
                            ...&#30465;&#30053;...
</pre>
</div>

<p>
<b>2、在10.0.0.8安装mycat并启动</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum -y install java mariadb
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#35748;&#23433;&#35013;&#25104;&#21151;</span>
[root@centos8 ~]#java -version
openjdk version <span style="color: #8b2252;">"1.8.0_252"</span>
OpenJDK Runtime Environment (build 1.8.0_252-b09)
OpenJDK 64-Bit Server VM (build 25.252-b09, mixed mode)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#36733;&#24182;&#23433;&#35013;</span>
[root@centos8 ~]#wget http://dl.mycat.org.cn/1.6.7.4/Mycat-server-1.6.7.4-release/Mycat-server-1.6.7.4-release-20200105164103-linux.tar.gz
[root@centos8 ~]#mkdir /apps
[root@centos8 ~]#tar xvf Mycat-server-1.6.7.4-release-20200105164103-linux.tar.gz -C /apps

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#29615;&#22659;&#21464;&#37327;</span>
[root@centos8 ~]#echo <span style="color: #8b2252;">'PATH=/apps/mycat/bin:$PATH'</span> &gt; /etc/profile.d/mycat.sh
[root@centos8 ~]#source /etc/profile.d/mycat.sh

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#31471;&#21475;</span>
[root@centos8 ~]#ss -ntl
State    Recv-Q    Send-Q        Local Address:Port         Peer Address:Port    
LISTEN   0         128                 0.0.0.0:111               0.0.0.0:*       
LISTEN   0         128                 0.0.0.0:22                0.0.0.0:*       
LISTEN   0         128                 0.0.0.0:5355              0.0.0.0:*       
LISTEN   0         128                    [::]:111                  [::]:*       
LISTEN   0         128                    [::]:22                   [::]:*       
LISTEN   0         80                        *:3306                    *:*       
LISTEN   0         128                    [::]:5355                 [::]:*  

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;mycat</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#65306;&#27492;&#27493;&#21551;&#21160;&#36739;&#24930;&#65292;&#38656;&#35201;&#31561;&#20250;&#20799;&#65292;&#21478;&#22806;&#22914;&#26524;&#20869;&#23384;&#22826;&#23567;&#65292;&#20250;&#23548;&#33268;&#26080;&#27861;&#21551;&#21160;</span>
[root@centos8 ~]#mycat start
Starting Mycat-server...

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#21040;&#25171;&#21360;&#22810;&#20010;&#31471;&#21475;&#65292;&#20854;&#20013;8066&#31471;&#21475;&#29992;&#20110;&#36830;&#25509;mycat</span>
[root@centos8 ~]#ss -ntlp
State    Recv-Q    Send-Q        Local Address:Port         Peer Address:Port                                                                                     
LISTEN   0         128                 0.0.0.0:111               0.0.0.0:*        users:((<span style="color: #8b2252;">"rpcbind"</span>,<span style="color: #a0522d;">pid</span>=738,<span style="color: #a0522d;">fd</span>=4),(<span style="color: #8b2252;">"systemd"</span>,<span style="color: #a0522d;">pid</span>=1,<span style="color: #a0522d;">fd</span>=71))                        
LISTEN   0         128                 0.0.0.0:22                0.0.0.0:*        users:((<span style="color: #8b2252;">"sshd"</span>,<span style="color: #a0522d;">pid</span>=810,<span style="color: #a0522d;">fd</span>=4))                                                   
LISTEN   0         1                 127.0.0.1:32000             0.0.0.0:*        users:((<span style="color: #8b2252;">"java"</span>,<span style="color: #a0522d;">pid</span>=4932,<span style="color: #a0522d;">fd</span>=4))                                                  
LISTEN   0         128                 0.0.0.0:5355              0.0.0.0:*        users:((<span style="color: #8b2252;">"systemd-resolve"</span>,<span style="color: #a0522d;">pid</span>=950,<span style="color: #a0522d;">fd</span>=13))                                       
LISTEN   0         128                    [::]:111                  [::]:*        users:((<span style="color: #8b2252;">"rpcbind"</span>,<span style="color: #a0522d;">pid</span>=738,<span style="color: #a0522d;">fd</span>=6),(<span style="color: #8b2252;">"systemd"</span>,<span style="color: #a0522d;">pid</span>=1,<span style="color: #a0522d;">fd</span>=73))                        
LISTEN   0         128                    [::]:22                   [::]:*        users:((<span style="color: #8b2252;">"sshd"</span>,<span style="color: #a0522d;">pid</span>=810,<span style="color: #a0522d;">fd</span>=6))                                                   
LISTEN   0         50                        *:36505                   *:*        users:((<span style="color: #8b2252;">"java"</span>,<span style="color: #a0522d;">pid</span>=4932,<span style="color: #a0522d;">fd</span>=65))                                                 
LISTEN   0         50                        *:1984                    *:*        users:((<span style="color: #8b2252;">"java"</span>,<span style="color: #a0522d;">pid</span>=4932,<span style="color: #a0522d;">fd</span>=64))                                                 
LISTEN   0         100                       *:8066                    *:*        users:((<span style="color: #8b2252;">"java"</span>,<span style="color: #a0522d;">pid</span>=4932,<span style="color: #a0522d;">fd</span>=85))                                                 
LISTEN   0         50                        *:46051                   *:*        users:((<span style="color: #8b2252;">"java"</span>,<span style="color: #a0522d;">pid</span>=4932,<span style="color: #a0522d;">fd</span>=63))                                                 
LISTEN   0         100                       *:9066                    *:*        users:((<span style="color: #8b2252;">"java"</span>,<span style="color: #a0522d;">pid</span>=4932,<span style="color: #a0522d;">fd</span>=81))                                                 
LISTEN   0         80                        *:3306                    *:*        users:((<span style="color: #8b2252;">"mysqld"</span>,<span style="color: #a0522d;">pid</span>=4254,<span style="color: #a0522d;">fd</span>=21))                                               
LISTEN   0         128                    [::]:5355                 [::]:*        users:((<span style="color: #8b2252;">"systemd-resolve"</span>,<span style="color: #a0522d;">pid</span>=950,<span style="color: #a0522d;">fd</span>=15)) 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26085;&#24535;&#65292;&#30830;&#23450;&#25104;&#21151;&#65292;&#21487;&#33021;&#38656;&#35201;&#31561;&#19968;&#20250;&#20799;&#25165;&#33021;&#30475;&#21040;&#25104;&#21151;&#30340;&#25552;&#31034;</span>
[root@centos8 ~]#tail /app/mycat/logs/wrapper.log
STATUS | wrapper  | 2020/06/16 22:45:41 | Launching a JVM...
ERROR  | wrapper  | 2020/06/16 22:46:10 | Startup failed: Timed out waiting for a signal from the JVM.
ERROR  | wrapper  | 2020/06/16 22:46:10 | JVM did not exit on request, terminated
INFO   | wrapper  | 2020/06/16 22:46:10 | JVM exited on its own while waiting to kill the application.
STATUS | wrapper  | 2020/06/16 22:46:10 | JVM exited<span style="color: #a020f0;"> in</span> response to signal SIGKILL (9)<span style="color: #483d8b;">.</span>
STATUS | wrapper  | 2020/06/16 22:46:15 | Launching a JVM...
INFO   | jvm 2    | 2020/06/16 22:46:15 | Wrapper (Version 3.2.3) http://wrapper.tanukisoftware.org
INFO   | jvm 2    | 2020/06/16 22:46:15 |   Copyright 1999-2006 Tanuki Software, Inc.  All Rights Reserved.
INFO   | jvm 2    | 2020/06/16 22:46:15 | 
INFO   | jvm 2    | 2020/06/16 22:46:18 | MyCAT Server startup successfully. see logs<span style="color: #a020f0;"> in</span> logs/mycat.log

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#40664;&#35748;&#23494;&#30721;123456&#26469;&#36830;&#25509;mycat</span>
[root@centos8 ~]#mysql -uroot -p123456 -h 10.0.0.8 -P8066
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 1
Server version: 5.6.29-mycat-1.6.7.4-release-20200105164103 MyCat Server (OpenCloudDB)

<span style="color: #0000ff;">Copyright</span> (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type <span style="color: #8b2252;">'help;'</span> or <span style="color: #8b2252;">'\h'</span> for help. Type <span style="color: #8b2252;">'\c'</span> to clear the current input statement.

MySQL [(none)]&gt; show databases;
+----------+
| DATABASE |
+----------+
| TESTDB   |
+----------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

MySQL [(none)]&gt; USE TESTDB
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MySQL [TESTDB]&gt; show tables;
+------------------+
| Tables<span style="color: #a020f0;"> in</span> TESTDB |
+------------------+
| address          |
| travelrecord     |
+------------------+
2 rows<span style="color: #a020f0;"> in</span> set (0.012 sec)

MySQL [TESTDB]&gt; select * from travelrecord ;
ERROR 1105 (HY000): backend connect: java.lang.IllegalArgumentException: Invalid DataSource:0
</pre>
</div>

<p>
<b>4、在mycat 服务器上修改server.xml文件配置Mycat的连接信息</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /app/mycat/conf/server.xml
...&#30465;&#30053;...
&lt;user <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"root"</span>&gt;                               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;Mycat&#30340;&#29992;&#25143;&#21517;</span>
    &lt;property <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"password"</span>&gt;xxx&lt;/property&gt;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;Mycat&#30340;&#23494;&#30721;</span>
    &lt;property <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"schemas"</span>&gt;TESTDB&lt;/property&gt;   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#21517;&#35201;&#21644;schema.xml&#30456;&#23545;&#24212;</span>
&lt;/user&gt;
&lt;/mycat:server&gt;
</pre>
</div>

<p>
这里使用的是root，密码为xxx,逻辑数据库为TESTDB，这些信息都可以自己随意定义,读写权限都有，没有针对表做任何特殊的权限。重点关注上面这段配置，其他默认即可。
</p>

<p>
<b>5、修改schema.xml实现读写分离策略</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /app/mycat/conf/schema.xml

&lt;?xml <span style="color: #a0522d;">version</span>=<span style="color: #8b2252;">"1.0"</span>?&gt;
&lt;!DOCTYPE mycat:schema SYSTEM <span style="color: #8b2252;">"schema.dtd"</span>&gt;
&lt;mycat:schema xmlns:<span style="color: #a0522d;">mycat</span>=<span style="color: #8b2252;">"http://io.mycat/"</span>&gt;    &lt;schema <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"TESTDB"</span> <span style="color: #a0522d;">checkSQLschema</span>=<span style="color: #8b2252;">"false"</span> <span style="color: #a0522d;">sqlMaxLimit</span>=<span style="color: #8b2252;">"100"</span> <span style="color: #a0522d;">dataNode</span>=<span style="color: #8b2252;">"dn1"</span>&gt;&lt;/schema&gt;
    &lt;dataNode <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"dn1"</span> <span style="color: #a0522d;">dataHost</span>=<span style="color: #8b2252;">"localhost1"</span> <span style="color: #a0522d;">database</span>=<span style="color: #8b2252;">"mycat"</span> /&gt;
    &lt;dataHost <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"localhost1"</span> <span style="color: #a0522d;">maxCon</span>=<span style="color: #8b2252;">"1000"</span> <span style="color: #a0522d;">minCon</span>=<span style="color: #8b2252;">"10"</span> <span style="color: #a0522d;">balance</span>=<span style="color: #8b2252;">"1"</span>            
              <span style="color: #a0522d;">writeType</span>=<span style="color: #8b2252;">"0"</span> <span style="color: #a0522d;">dbType</span>=<span style="color: #8b2252;">"mysql"</span> <span style="color: #a0522d;">dbDriver</span>=<span style="color: #8b2252;">"native"</span> <span style="color: #a0522d;">switchType</span>=<span style="color: #8b2252;">"1"</span>  <span style="color: #a0522d;">slaveThreshold</span>=<span style="color: #8b2252;">"100"</span>&gt;
        &lt;heartbeat&gt;select user()&lt;/heartbeat&gt;        
        &lt;writeHost <span style="color: #a0522d;">host</span>=<span style="color: #8b2252;">"host1"</span> <span style="color: #a0522d;">url</span>=<span style="color: #8b2252;">"10.0.0.18:3306"</span> <span style="color: #a0522d;">user</span>=<span style="color: #8b2252;">"root"</span> <span style="color: #a0522d;">password</span>=<span style="color: #8b2252;">"123456"</span>&gt;        
        &lt;readHost <span style="color: #a0522d;">host</span>=<span style="color: #8b2252;">"host2"</span> <span style="color: #a0522d;">url</span>=<span style="color: #8b2252;">"10.0.0.28:3306"</span> <span style="color: #a0522d;">user</span>=<span style="color: #8b2252;">"root"</span> <span style="color: #a0522d;">password</span>=<span style="color: #8b2252;">"123456"</span> /&gt;
        &lt;/writeHost&gt;
        &lt;/dataHost&gt;
&lt;/mycat:schema&gt;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#26032;&#21551;&#21160;mycat</span>
[root@centos8 ~]#mycat restart
</pre>
</div>

<p>
上面配置中，balance改为1，表示读写分离。以上配置达到的效果就是10.0.0.18为主库，10.0.0.28为从库
</p>

<p>
注意：要保证10.0.0.18和10.0.0.28机器能使用root/123456权限成功登录mysql数据库。同时，也一定要授权mycat机器能使用root/123456权限成功登录这两台机器的mysql数据库！！这很重要，否则会导致登录mycat后，对库和表操作失败！
</p>

<p>
范例：schema.xml
</p>


<figure id="org1838d61">
<img src="./images/20200704143115885.png" alt="20200704143115885.png" width="60%">

</figure>


<p>
<b>6、在后端主服务器创建用户并对mycat授权</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mysql -uroot -p
mysql&gt; create database mycat;
mysql&gt;GRANT ALL ON *.* TO <span style="color: #8b2252;">'root'</span>@<span style="color: #8b2252;">'10.0.0.%'</span> IDENTIFIED BY <span style="color: #8b2252;">'123456'</span> WITH GRANT OPTION;
mysql&gt;  privileges;
</pre>
</div>

<p>
<b>7、在Mycat服务器上连接并测试</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mysql -uroot -pxxx -h127.0.0.1 -P8066 -DTESTDB
mysql&gt; show databases;
+----------+
| DATABASE |
+----------+
| TESTDB   |    //&#21482;&#33021;&#30475;&#19968;&#20010;&#34394;&#25311;&#25968;&#25454;&#24211;
+----------+
MySQL [(none)]&gt; use TESTDB;
MySQL [TESTDB]&gt; create table t1(id int);
MySQL [TESTDB]&gt; select @@server_id;
MySQL [TESTDB]&gt; select @@hostname;
</pre>
</div>

<p>
<b>8、通过通用日志确认实现读写分离</b>
</p>

<p>
在mysql中查看通用日志
</p>

<div class="org-src-container">
<pre class="src src-sh">show variables like <span style="color: #8b2252;">'general_log'</span>;      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26085;&#24535;&#26159;&#21542;&#24320;&#21551;</span>
<span style="color: #483d8b;">set</span> global <span style="color: #a0522d;">general_log</span>=on;              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#26085;&#24535;&#21151;&#33021;</span>
show variables like <span style="color: #8b2252;">'general_log_file'</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26085;&#24535;&#25991;&#20214;&#20445;&#23384;&#20301;&#32622;</span>
<span style="color: #483d8b;">set</span> global <span style="color: #a0522d;">general_log_file</span>=<span style="color: #8b2252;">'tmp/general.log'</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26085;&#24535;&#25991;&#20214;&#20445;&#23384;&#20301;&#32622;</span>
</pre>
</div>

<p>
在主和从服务器分别启用通用日志，查看读写分离
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /etc/my.cnf.d/mariadb-server.cnf
[mysqld]
<span style="color: #a0522d;">general_log</span>=ON

[root@centos8 ~]#systemctl restart mariadb
[root@centos8 ~]#tail -f /var/lib/mysql/centos8.log
</pre>
</div>

<p>
<b>9、停止从节点，MyCAT自动调度读请求至主节点 （需要exit一次）</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@slave ~]#systemctl stop mariadb
[root@client ~]#mysql -uroot -pxxx -h10.0.0.8 -P8066
MySQL [(none)]&gt; select @@server_id;
+-------------+
| @@server_id |
+-------------+
| 1           |
+-------------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20572;&#27490;&#20027;&#33410;&#28857;&#65292;MyCAT&#19981;&#20250;&#33258;&#21160;&#35843;&#24230;&#35835;&#35831;&#27714;&#33267;&#20174;&#33410;&#28857;</span>
MySQL [TESTDB]&gt; insert teachers values(5,<span style="color: #8b2252;">'wang'</span>,30,<span style="color: #8b2252;">'M'</span>);
ERROR 1184 (HY000): java.net.ConnectException: Connection refused
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:f1d63e42-f699-45c3-8254-36c352290aba" class="outline-4">
<h4 id="h:f1d63e42-f699-45c3-8254-36c352290aba">ProxySQL</h4>
<div class="outline-text-4" id="text-h:f1d63e42-f699-45c3-8254-36c352290aba">
</div>
<div id="outline-container-h:33786871-b4ee-43c1-a0b9-8c3f58f9096a" class="outline-5">
<h5 id="h:33786871-b4ee-43c1-a0b9-8c3f58f9096a">ProxySQL 介绍</h5>
<div class="outline-text-5" id="text-h:33786871-b4ee-43c1-a0b9-8c3f58f9096a">
<p>
ProxySQL： MySQL中间件
</p>

<pre class="example" id="orgfedd197">
两个版本：官方版和percona版，percona版是基于官方版基础上修改
C++语言开发，轻量级但性能优异，支持处理千亿级数据
具有中间件所需的绝大多数功能，包括：
多种方式的读/写分离
定制基于用户、基于schema、基于语句的规则对SQL语句进行路由
缓存查询结果
后端节点监控
</pre>

<p>
官方站点：<a href="https://proxysql.com/">https://proxysql.com/</a><br>
官方手册：<a href="https://github.com/sysown/proxysql/wiki">https://github.com/sysown/proxysql/wiki</a>
</p>
</div>
</div>
<div id="outline-container-h:31d0b902-918c-45c9-92a8-cfb87c727a42" class="outline-5">
<h5 id="h:31d0b902-918c-45c9-92a8-cfb87c727a42">ProxySQL安装</h5>
<div class="outline-text-5" id="text-h:31d0b902-918c-45c9-92a8-cfb87c727a42">
<p>
<b>基于YUM仓库安装</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">cat &lt;&lt;EOF | tee /etc/yum.repos.d/proxysql.repo
<span style="color: #ffa54f;">[proxysql_repo]</span>
<span style="color: #ffa54f;">name= ProxySQL YUM repository</span>
<span style="color: #ffa54f;">baseurl=http://repo.proxysql.com/ProxySQL/proxysql-1.4.x/centos/$releasever</span>
<span style="color: #ffa54f;">gpgcheck=1</span>
<span style="color: #ffa54f;">gpgkey=http://repo.proxysql.com/ProxySQL/repo_pub_key</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
基于RPM下载安装：<a href="https://github.com/sysown/proxysql/releases">https://github.com/sysown/proxysql/releases</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">yum install proxysql
</pre>
</div>

<p>
<b>ProxySQL组成</b>
</p>

<ul class="org-ul">
<li>服务脚本：/etc/init.d/proxysql</li>
<li>配置文件：/etc/proxysql.cnf</li>
<li>主程序：/usr/bin/proxysql</li>
<li>基于SQLITE的数据库文件：/var/lib/proxysql/</li>
</ul>

<p>
<b>启动ProxySQL：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">service proxysql start
</pre>
</div>

<p>
启动后会监听两个默认端口
</p>

<ul class="org-ul">
<li>6032：ProxySQL的管理端口</li>
<li>6033：ProxySQL对外提供服务的端口</li>
</ul>

<p>
<b>连接ProxySQL的管理端口</b>
</p>

<p>
使用mysql客户端连接到ProxySQL的管理接口6032，默认管理员用户和密码都是admin：
</p>

<div class="org-src-container">
<pre class="src src-sh">mysql -uadmin -padmin -P6032 -h127.0.0.1
</pre>
</div>

<p>
<b>数据库说明：</b>
</p>

<ul class="org-ul">
<li>main
是默认的”数据库”名，表里存放后端db实例、用户验证、路由规则等信息。表名以
runtime开头的表示</li>
<li>proxysql当前运行的配置内容，不能通过dml语句修改，只能修改对应的不以
runtime_ 开头的（在内存）里的表，然后 LOAD 使其生效， SAVE
使其存到硬盘以供下次重启加载</li>
<li>disk 是持久化到硬盘的配置，sqlite数据文件</li>
<li>stats
是proxysql运行抓取的统计信息，包括到后端各命令的执行次数、流量、processlist、查询种类汇总/执行时间，等等</li>
<li>monitor 库存储 monitor 模块收集的信息，主要是对后端db的健康/延迟检查</li>
</ul>

<p>
<b>说明：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">&#22312;main&#21644;monitor&#25968;&#25454;&#24211;&#20013;&#30340;&#34920;&#65292; runtime&#24320;&#22836;&#30340;&#26159;&#36816;&#34892;&#26102;&#30340;&#37197;&#32622;&#65292;&#19981;&#33021;&#20462;&#25913;&#65292;&#21482;&#33021;&#20462;&#25913;&#38750;runtime&#34920;
&#20462;&#25913;&#21518;&#24517;&#39035;&#25191;&#34892;LOAD &#8230; TO RUNTIME&#25165;&#33021;&#21152;&#36733;&#21040;RUNTIME&#29983;&#25928;
&#25191;&#34892;save &#8230; to disk &#25165;&#23558;&#37197;&#32622;&#25345;&#20037;&#21270;&#20445;&#23384;&#21040;&#30913;&#30424;&#65292;&#21363;&#20445;&#23384;&#22312;proxysql.db&#25991;&#20214;&#20013;
global_variables &#26377;&#35768;&#22810;&#21464;&#37327;&#21487;&#20197;&#35774;&#32622;&#65292;&#20854;&#20013;&#23601;&#21253;&#25324;&#30417;&#21548;&#30340;&#31471;&#21475;&#12289;&#31649;&#29702;&#36134;&#21495;&#31561;
</pre>
</div>

<p>
参考: <a href="https://github.com/sysown/proxysql/wiki/Global-variables">https://github.com/sysown/proxysql/wiki/Global-variables</a>
</p>
</div>
</div>
<div id="outline-container-h:d8f9f4e2-dc92-40a5-a20d-346c2d687b6c" class="outline-5">
<h5 id="h:d8f9f4e2-dc92-40a5-a20d-346c2d687b6c">实战案例：利用ProxySQL实现读写分离</h5>
<div class="outline-text-5" id="text-h:d8f9f4e2-dc92-40a5-a20d-346c2d687b6c">
<ol class="org-ol">
<li>环境准备：<br>
准备三台主机，一台ProxySQL服务器:192.168.8.7，另外两台主机实现主从复制192.168.8.17,27<br>
注意：slave节点需要设置read_only=1</li>

<li><p>
安装ProxySQL，并向ProxySQL中添加MySQL节点，以下操作不需要use
main也可成功
</p>

<div class="org-src-container">
<pre class="src src-sql">MySQL&gt; show tables;
MySQL &gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> sqlite_master <span style="color: #a020f0;">where</span> <span style="color: #a020f0;">name</span>=<span style="color: #8b2252;">'mysql_servers'</span>\G
MySQL &gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> mysql_servers;
MySQL &gt; <span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> mysql_servers(hostgroup_id,hostname,port)
<span style="color: #a020f0;">values</span>(10,<span style="color: #8b2252;">'192.168.8.17'</span>,3306);
MySQL &gt; <span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> mysql_servers(hostgroup_id,hostname,port)
<span style="color: #a020f0;">values</span>(10,<span style="color: #8b2252;">'192.168.8.27'</span>,3306);
MySQL &gt; load mysql servers <span style="color: #a020f0;">to</span> runtime;
MySQL &gt; save mysql servers <span style="color: #a020f0;">to</span> disk;
</pre>
</div></li>

<li><p>
添加监控后端节点的用户，连接每个节点的read_only值来自动调整主从节点是属于读组还是写组
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#22312;master&#19978;&#25191;&#34892;
MySQL&gt; <span style="color: #a020f0;">grant</span> replication client <span style="color: #a020f0;">on</span> *.* <span style="color: #a020f0;">to</span> monitor@<span style="color: #8b2252;">'192.168.8.%'</span> identified <span style="color: #a020f0;">by</span> <span style="color: #8b2252;">'xxx'</span>;
#ProxySQL&#19978;&#37197;&#32622;&#30417;&#25511;
MySQL [(<span style="color: #a020f0;">none</span>)]&gt; <span style="color: #a020f0;">set</span> mysql-monitor_username=<span style="color: #8b2252;">'monitor'</span>;
MySQL [(<span style="color: #a020f0;">none</span>)]&gt; <span style="color: #a020f0;">set</span> mysql-monitor_password=<span style="color: #8b2252;">'xxx'</span>;
#&#21152;&#36733;&#21040;RUNTIME&#65292;&#24182;&#20445;&#23384;&#21040;disk
MySQL [(<span style="color: #a020f0;">none</span>)]&gt; load mysql variables <span style="color: #a020f0;">to</span> runtime;
MySQL [(<span style="color: #a020f0;">none</span>)]&gt; save mysql variables <span style="color: #a020f0;">to</span> disk;
</pre>
</div></li>

<li><p>
查看监控<br>
监控模块的指标保存在monitor库的log表中
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#26597;&#30475;&#30417;&#25511;&#36830;&#25509;&#26159;&#21542;&#27491;&#24120;&#30340; (&#23545;<span style="color: #a020f0;">connect</span>&#25351;&#26631;&#30340;&#30417;&#25511;&#65289;&#65292;&#22914;&#26524;connect_error&#30340;&#32467;&#26524;&#20026;<span style="color: #a020f0;">NULL</span>&#21017;&#34920;&#31034;&#27491;&#24120;
MySQL&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> mysql_server_connect_log;
#&#26597;&#30475;&#30417;&#25511;&#24515;&#36339;&#20449;&#24687; (&#23545;ping&#25351;&#26631;&#30340;&#30417;&#25511;)&#65306;
MySQL&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> mysql_server_ping_log;
</pre>
</div></li>

<li><p>
设置分组信息<br>
需要修改的是main库中的mysql_replication_hostgroups表，该表有3个字段：<br>
writer_hostgroup，reader_hostgroup，comment,
指定写组的id为10，读组的id为20
</p>

<div class="org-src-container">
<pre class="src src-sql">MySQL&gt; <span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> mysql_replication_hostgroups <span style="color: #a020f0;">values</span>(10,20,"test");
&#23558;mysql_replication_hostgroups&#34920;&#30340;&#20462;&#25913;&#21152;&#36733;&#21040;RUNTIME&#29983;&#25928;
MySQL&gt; load mysql servers <span style="color: #a020f0;">to</span> runtime;
MySQL&gt; save mysql servers <span style="color: #a020f0;">to</span> disk;
#Monitor&#27169;&#22359;&#30417;&#25511;&#21518;&#31471;&#30340;read_only&#20540;&#65292;&#25353;&#29031;read_only&#30340;&#20540;&#23558;&#33410;&#28857;&#33258;&#21160;&#31227;&#21160;&#21040;&#35835;/&#20889;&#32452;
MySQL&gt; <span style="color: #a020f0;">select</span> hostgroup_id,hostname,port,status,weight <span style="color: #a020f0;">from</span> mysql_servers;
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+--------------+------+--------+--------+</span>
| hostgroup_id | hostname     | port | status | weight |
+<span style="color: #b22222;">--------------</span><span style="color: #b22222;">+--------------+------+--------+--------+</span>
| 10           | 192.168.8.17 | 3306 | ONLINE | 1      |
| 20           | 192.168.8.27 | 3306 | ONLINE | 1      |
</pre>
</div></li>

<li><p>
配置访问数据库的SQL 用户
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#22312;master&#33410;&#28857;&#19978;&#21019;&#24314;&#35775;&#38382;&#29992;&#25143;
MySQL&gt; <span style="color: #a020f0;">grant</span> <span style="color: #a020f0;">all</span> <span style="color: #a020f0;">on</span> *.* <span style="color: #a020f0;">to</span> sqluser@<span style="color: #8b2252;">'192.168.8.%'</span> identified <span style="color: #a020f0;">by</span> <span style="color: #8b2252;">'xxx'</span>;
#&#22312;ProxySQL&#37197;&#32622;&#65292;&#23558;&#29992;&#25143;sqluser&#28155;&#21152;&#21040;mysql_users&#34920;&#20013;&#65292; default_hostgroup&#40664;&#35748;&#32452;&#35774;&#32622;
&#20026;&#20889;&#32452;10&#65292;&#24403;&#35835;&#20889;&#20998;&#31163;&#30340;&#36335;&#30001;&#35268;&#21017;&#19981;&#31526;&#21512;&#26102;&#65292;&#20250;&#35775;&#38382;&#40664;&#35748;&#32452;&#30340;&#25968;&#25454;&#24211;
MySQL&gt; <span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> mysql_users(username,password,default_hostgroup) <span style="color: #a020f0;">values</span>(<span style="color: #8b2252;">'sqluser'</span>,<span style="color: #8b2252;">'xxx'</span>,10);
MySQL&gt; load mysql users <span style="color: #a020f0;">to</span> runtime;
MySQL&gt; save mysql users <span style="color: #a020f0;">to</span> disk;
#&#20351;&#29992;sqluser&#29992;&#25143;&#27979;&#35797;&#26159;&#21542;&#33021;&#36335;&#30001;&#21040;&#40664;&#35748;&#30340;10&#20889;&#32452;&#23454;&#29616;&#35835;&#12289;&#20889;&#25968;&#25454;
mysql -usqluser -pxxx -P6033 -h127.0.0.1 -e <span style="color: #8b2252;">'select @@server_id'</span>
mysql -usqluser -pxxx -P6033 -h127.0.0.1 -e <span style="color: #8b2252;">'create database testdb'</span>
mysql -usqluser -pxxx testdb -P6033 -h127.0.0.1 -e <span style="color: #8b2252;">'create table t(id int)'</span>
</pre>
</div></li>

<li><p>
在proxysql上配置路由规则，实现读写分离
</p>

<p>
与规则有关的表：mysql_query_rules和mysql_query_rules_fast_routing，后者是前者的扩展表，1.4.7之后支持
</p>

<p>
插入路由规则：将select语句分离到20的读组，select语句中有一个特殊语句SELECT&#x2026;FOR
UPDATE它会申请写锁，应路由到10的写组
</p>

<div class="org-src-container">
<pre class="src src-sql">MySQL&gt; <span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> mysql_query_rules
(rule_id,active,match_digest,destination_hostgroup,apply)<span style="color: #a020f0;">VALUES</span>
(1,1,<span style="color: #8b2252;">'^SELECT.*FOR UPDATE$'</span>,10,1),(2,1,<span style="color: #8b2252;">'^SELECT'</span>,20,1);
MySQL&gt; load mysql query rules <span style="color: #a020f0;">to</span> runtime;
MySQL&gt; save mysql query rules <span style="color: #a020f0;">to</span> disk;
#&#27880;&#24847;&#65306;&#22240;ProxySQL&#26681;&#25454;rule_id&#39034;&#24207;&#36827;&#34892;&#35268;&#21017;&#21305;&#37197;&#65292;<span style="color: #a020f0;">select</span> ... <span style="color: #a020f0;">for</span> <span style="color: #a020f0;">update</span>&#35268;&#21017;&#30340;rule_id&#24517;&#39035;&#35201;&#23567;&#20110;&#26222;&#36890;&#30340;<span style="color: #a020f0;">select</span>&#35268;&#21017;&#30340;rule_id
</pre>
</div></li>

<li><p>
测试ProxySQL
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#35835;&#25805;&#20316;&#26159;&#21542;&#36335;&#30001;&#32473;20&#30340;&#35835;&#32452;
mysql -usqluser -pxxx -P6033 -h127.0.0.1 -e <span style="color: #8b2252;">'select @@server_id'</span>
#&#27979;&#35797;&#20889;&#25805;&#20316;&#65292;&#20197;&#20107;&#21153;&#26041;&#24335;&#36827;&#34892;&#27979;&#35797;
mysql -usqluser -pxxx -P6033 -h127.0.0.1 \
-e <span style="color: #8b2252;">'start transaction;select @@server_id;commit;select @@server_id'</span>
mysql -usqluser -pxxx -P6033 -h127.0.0.1 -e <span style="color: #8b2252;">'insert testdb.t values (1)'</span>
mysql -usqluser -pxxx -P6033 -h127.0.0.1 -e <span style="color: #8b2252;">'select id from testdb.t'</span>

#&#36335;&#30001;&#30340;&#20449;&#24687;&#65306;&#26597;&#35810;stats&#24211;&#20013;&#30340;stats_mysql_query_digest&#34920;
MySQL &gt; <span style="color: #a020f0;">SELECT</span> hostgroup hg,sum_time, count_star, digest_text <span style="color: #a020f0;">FROM</span> stats_mysql_query_digest <span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span> sum_time <span style="color: #a020f0;">DESC</span>;

#&#27979;&#35797;&#35835;&#25805;&#20316;&#26159;&#21542;&#36335;&#30001;&#32473;20&#30340;&#35835;&#32452;
mysql -usqluser -pxxx -P6033 -h127.0.0.1 -e <span style="color: #8b2252;">'select @@server_id'</span>
#&#27979;&#35797;&#20889;&#25805;&#20316;&#65292;&#20197;&#20107;&#21153;&#26041;&#24335;&#36827;&#34892;&#27979;&#35797;
mysql -usqluser -pxxx -P6033 -h127.0.0.1 \
-e <span style="color: #8b2252;">'start transaction;select @@server_id;commit;select @@server_id'</span>
mysql -usqluser -pxxx -P6033 -h127.0.0.1 -e <span style="color: #8b2252;">'insert testdb.t values (1)'</span>
mysql -usqluser -pxxx -P6033 -h127.0.0.1 -e <span style="color: #8b2252;">'select id from testdb.t'</span>
#&#36335;&#30001;&#30340;&#20449;&#24687;&#65306;&#26597;&#35810;stats&#24211;&#20013;&#30340;stats_mysql_query_digest&#34920;
MySQL &gt; <span style="color: #a020f0;">SELECT</span> hostgroup hg,sum_time, count_star, digest_text <span style="color: #a020f0;">FROM</span> stats_mysql_query_digest <span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span> sum_time <span style="color: #a020f0;">DESC</span>;
</pre>
</div></li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-h:83a17d25-ebaf-4b3a-ae01-de3823df15eb" class="outline-3">
<h3 id="h:83a17d25-ebaf-4b3a-ae01-de3823df15eb">MySQL高可用</h3>
<div class="outline-text-3" id="text-h:83a17d25-ebaf-4b3a-ae01-de3823df15eb">
</div>
<div id="outline-container-h:cb30b1df-b169-4e4b-b326-60038c05c3c9" class="outline-4">
<h4 id="h:cb30b1df-b169-4e4b-b326-60038c05c3c9">MySQL高可用解决方案</h4>
<div class="outline-text-4" id="text-h:cb30b1df-b169-4e4b-b326-60038c05c3c9">
<p>
MySQL官方和社区里推出了很多高可用的解决方案，大体如下，仅供参考（数据引用自Percona）
</p>


<figure id="org19afe5b">
<img src="./images/20200705114740139.png" alt="20200705114740139.png" width="60%">

</figure>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Method</th>
<th scope="col" class="org-right">Level of Availability for a year</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Simple replication</td>
<td class="org-right">98-99.9%</td>
</tr>

<tr>
<td class="org-left">Master-Master/MMM</td>
<td class="org-right">99%</td>
</tr>

<tr>
<td class="org-left">SAN</td>
<td class="org-right">99.5-99.9%</td>
</tr>

<tr>
<td class="org-left">DRBD,MHA,,Tungsten Replicator</td>
<td class="org-right">99.9%</td>
</tr>

<tr>
<td class="org-left">NDBCluster, Galera Cluster</td>
<td class="org-right">99.999%</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><p>
MMM（淘汰了）: Multi-Master Replication Manager for MySQL，Mysql主主
复制管理器是一套灵活的脚本程序，基于perl实现，用来对mysql
replication进行监控和故障迁移，并能管理mysql MasterMaster复制的配置
(同一时间只有一个节点是可写的)
</p>

<p>
官网： <a href="http://www.mysql-mmm.org">http://www.mysql-mmm.org</a>
</p>

<p>
<a href="https://code.google.com/archive/p/mysql-master-master/downloads">https://code.google.com/archive/p/mysql-master-master/downloads</a>
</p></li>

<li><p>
MHA：Master High Availability，对主节点进行监控，可实现自动故障转移
至其它从节点；通过提升某一从节点为新的主节点，基于主从复制实现，还需
要客户端配合实现，目前MHA主要支持一主多从的架构，要搭建MHA,要求一个
复制集群中必须最少有三台数据库服务器，一主二从，即一台充当master，一
台充当备用master，另外一台充当从库，出于机器成本的考虑，淘宝进行了改
造，目前淘宝TMHA已经支持一主一从
</p>

<p>
官方网站：<a href="https://code.google.com/archive/p/mysql-master-ha/">https://code.google.com/archive/p/mysql-master-ha/</a>
</p>

<p>
<a href="https://github.com/yoshinorim/mha4mysql-manager/wiki/Downloads">https://github.com/yoshinorim/mha4mysql-manager/wiki/Downloads</a>
</p></li>
<li>Galera Cluster：wsrep(MySQL extended with the Write Set Replication)
通过wsrep协议在全局实现复制；任何一节点都可读写，不需要主从复制，实
现多主读写</li>
<li>GR（Group Replication）：MySQL官方提供的组复制技术(MySQL5.7.17引入的
技术)，基于原生复制技术Paxos算法，实现了多主更新，复制组由多个server
成员构成，组中的每个server可独立地执行事务，但所有读写事务只在冲突检
测成功后才会提交</li>
</ul>



<figure id="orge064098">
<img src="./images/20200704143223707.png" alt="20200704143223707.png" width="60%">

</figure>

<p>
这3个节点互相通信，每当有事件发生，都会向其他节点传播该事件，然后协商，
如果大多数节点都同意这次的事件，那么该事件将通过，否则该事件将失败或回
滚。这些节点可以是单主模型的(single-primary)，也可以是多主模型的
(multi-primary)。单主模型只有一个主节点可以接受写操作，主节点故障时可
以自动选举主节点。多主模型下，所有节点都可以接受写操作，所以没有
master-slave的概念。
</p>
</div>
</div>
<div id="outline-container-h:d23a3908-636b-435a-9e0c-f0447ea4445f" class="outline-4">
<h4 id="h:d23a3908-636b-435a-9e0c-f0447ea4445f">MHA Master High Availability</h4>
<div class="outline-text-4" id="text-h:d23a3908-636b-435a-9e0c-f0447ea4445f">
</div>
<div id="outline-container-h:3a77991a-da90-435c-8e43-cebe3ff3aad3" class="outline-5">
<h5 id="h:3a77991a-da90-435c-8e43-cebe3ff3aad3">MHA 工作原理和架构</h5>
<div class="outline-text-5" id="text-h:3a77991a-da90-435c-8e43-cebe3ff3aad3">
<p>
<b>MHA集群架构</b>
</p>


<figure id="orgb1d27fc">
<img src="./images/20200704143237411.png" alt="20200704143237411.png" width="60%">

<figcaption><span class="figure-number">Figure 5: </span>在这里插入图片描述</figcaption>
</figure>


<p>
<b>MHA工作原理</b>
</p>



<figure id="org54a89a1">
<img src="./images/2020070414324520.png" alt="2020070414324520.png" width="60%">

</figure>


<ol class="org-ol">
<li>从宕机崩溃的master保存二进制日志事件（binlog events）</li>

<li>识别含有最新更新的slave</li>

<li>应用差异的中继日志（relay log）到其他的slave</li>

<li>应用从master保存的二进制日志事件（binlog events）</li>

<li>提升一个slave为新的master</li>

<li>使其他的slave连接新的master进行复制</li>
</ol>

<p>
<b>MHA软件</b>
MHA软件由两部分组成，Manager工具包和Node工具包
</p>

<p>
*Manager工具包主要包括以下几个工具*：
</p>

<ul class="org-ul">
<li>masterha_check_ssh 检查MHA的SSH配置状况</li>
<li>masterha_check_repl 检查MySQL复制状况</li>
<li>masterha_manger 启动MHA</li>
<li>masterha_check_status 检测当前MHA运行状态</li>
<li>masterha_master_monitor 检测master是否宕机</li>
<li>masterha_master_switch 故障转移（自动或手动）</li>
<li>masterha_conf_host 添加或删除配置的server信息</li>
</ul>

<p>
Node工具包：这些工具通常由MHA Manager的脚本触发，无需人为操作）主要包括以下几个工具：
</p>

<ul class="org-ul">
<li>save_binary_logs 保存和复制master的二进制日志</li>
<li>apply_diff_relay_logs
识别差异的中继日志事件并将其差异的事件应用于其他的slave</li>
<li>filter_mysqlbinlog 去除不必要的ROLLBACK事件（MHA已不再使用此工具）</li>
<li>purge_relay_logs 清除中继日志（不会阻塞SQL线程）</li>
</ul>

<p>
注意：为了尽可能的减少主库硬件损坏宕机造成的数据丢失，因此在配置MHA的同时建议配置成MySQL5.5的半同步复制
</p>

<p>
<b>MHA自定义扩展</b> ：
</p>

<ul class="org-ul">
<li>secondary_check_script： 通过多条网络路由检测master的可用性</li>
<li>master_ip_ailover_script： 更新Application使用的masterip</li>
<li>shutdown_script： 强制关闭master节点</li>
<li>report_script： 发送报告</li>
<li>init_conf_load_script： 加载初始配置参数</li>
<li>master_ip_online_change_script：更新master节点ip地址</li>
</ul>

<p>
<b>MHA配置文件</b> ：
</p>

<ul class="org-ul">
<li>global配置，为各application提供默认配置，默认文件路径/etc/masterha_default.cnf</li>
<li>application配置：为每个主从复制集群</li>
</ul>
</div>
</div>
<div id="outline-container-h:f8e0467b-6fdd-4224-842e-d842a42a2a55" class="outline-5">
<h5 id="h:f8e0467b-6fdd-4224-842e-d842a42a2a55">实现MHA实战案例</h5>
<div class="outline-text-5" id="text-h:f8e0467b-6fdd-4224-842e-d842a42a2a55">
<div class="org-src-container">
<pre class="src src-sh">&#29615;&#22659;&#65306;&#22235;&#21488;&#20027;&#26426;
1 10.0.0.7 CentOS7 MHA&#31649;&#29702;&#31471;&#65292;&#36719;&#20214;&#21482;&#25903;&#25345;centos7
2 10.0.0.8 CentOS8 Master
3 10.0.0.18 CentOS8 salve1
4 10.0.0.28 CentOS8 slave2
</pre>
</div>
</div>
<ul class="org-ul">
<li><a id="h:de12f1d2-2dfb-453e-845b-b00263e24d7c"></a>在管理节点上安装两个包<br>
<div class="outline-text-6" id="text-h:de12f1d2-2dfb-453e-845b-b00263e24d7c">
<p>
mha4mysql-manager和mha4mysql-node
</p>

<p>
说明：
</p>
<ul class="org-ul">
<li>mha4mysql-manager-0.56-0.el6.noarch.rpm 不支持CentOS 8，只支持CentOS7 以下版本</li>
<li>mha4mysql-manager-0.58-0.el7.centos.noarch.rpm 支持MySQL5.7和MySQL8.0 ,但和CentOS8版本上的Mariadb -10.3.17不兼容</li>
</ul>
</div>
</li>
<li><a id="h:d97218b2-d542-4055-82ee-aa07c5c4ada5"></a>安装：服务端先装node在装manager<br>
<div class="outline-text-6" id="text-h:d97218b2-d542-4055-82ee-aa07c5c4ada5">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20250;&#26377;&#20381;&#36182;&#20851;&#31995;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">mha4mysql-manager    #&#31649;&#29702;&#21253;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">mha4mysql-node       #&#33410;&#28857;&#21253;</span>
yum -y install mha*.rpm
</pre>
</div>
</div>
</li>
<li><a id="h:5294b060-51b2-41b4-92e8-d7272a88962c"></a>在被管理节点安装mha4mysql-node包<br>
<div class="outline-text-6" id="text-h:5294b060-51b2-41b4-92e8-d7272a88962c">
<p>
（支持CentOS 8，7，6）
</p>

<div class="org-src-container">
<pre class="src src-sh">yum install ./mha4mysql-node-0.58-0.el7.centos.noarch.rpm -y
</pre>
</div>
</div>
</li>
<li><a id="h:fca1c882-59ad-438f-a9cb-6c67d235f0e9"></a>在所有节点实现相互之间ssh key验证<br>
<div class="outline-text-6" id="text-h:fca1c882-59ad-438f-a9cb-6c67d235f0e9">
<p>
因为相互之间要复制日志。
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@mha-manager ~]#ssh-keygen
[root@mha-manager ~]#ssh-copy-id 10.0.0.7
[root@mha-manager ~]#rsync -av .ssh 10.0.0.8:/root/
[root@mha-manager ~]#rsync -av .ssh 10.0.0.18:/root/
[root@mha-manager ~]#rsync -av .ssh 10.0.0.28:/root/
</pre>
</div>
</div>
</li>
<li><a id="h:f50d259e-7308-4154-aac7-adfa6fc20061"></a>在管理节点建立配置文件<br>
<div class="outline-text-6" id="text-h:f50d259e-7308-4154-aac7-adfa6fc20061">
<p>
注意：此文件的行尾不要加空格等符号
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir /etc/mastermha/      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21517;&#31216;&#21487;&#20197;&#25913;</span>
vim /etc/mastermha/app1.cnf    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30417;&#25511;&#30340;&#19968;&#32452;&#26381;&#21153;&#22120;&#30340;&#38598;&#21512;&#65292;&#21487;&#20197;&#36824;&#26377;app2...&#21517;&#31216;&#21487;&#20197;&#25913;</span>
[server default]
<span style="color: #a0522d;">user</span>=mhauser             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;&#36828;&#31243;&#36830;&#25509;mysql&#25152;&#26377;&#33410;&#28857;&#30340;&#29992;&#25143;&#65292;&#38656;&#35201;&#20855;&#26377;&#19968;&#23450;&#30340;&#31649;&#29702;&#21592;&#26435;&#38480;</span>
<span style="color: #a0522d;">password</span>=xxx
<span style="color: #a0522d;">manager_workdir</span>=/data/mastermha/app1/   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24037;&#20316;&#30446;&#24405;&#65292;&#25351;&#23450;&#25991;&#20214;&#22841;&#21517;&#33258;&#21160;&#29983;&#25104;</span>
<span style="color: #a0522d;">manager_log</span>=/data/mastermha/app1/manager.log  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24456;&#37325;&#35201;&#65292;&#20102;&#35299;&#24037;&#20316;&#24773;&#20917;</span>
<span style="color: #a0522d;">remote_workdir</span>=/data/mastermha/app1/    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24037;&#20316;&#30446;&#24405;&#65292;&#25351;&#23450;&#25991;&#20214;&#22841;&#21517;&#33258;&#21160;&#29983;&#25104;</span>
<span style="color: #a0522d;">ssh_user</span>=root    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;&#23454;&#29616;&#36828;&#31243;ssh&#22522;&#20110;KEY&#30340;&#36830;&#25509;&#65288;&#19981;&#38656;&#35201;&#36755;&#23494;&#30721;&#65289;&#65292;&#26469;&#35775;&#38382;&#20108;&#36827;&#21046;&#26085;&#24535;&#65292;&#29992;&#26469;&#39044;&#38450;mysql&#23445;&#25481;&#65292;Linux&#36824;&#21487;&#20197;&#21033;&#29992;&#20108;&#36827;&#21046;&#26085;&#24535;&#24674;&#22797;</span>
<span style="color: #a0522d;">repl_user</span>=repluser    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#20174;&#22797;&#21046;&#30340;&#22797;&#21046;&#36134;&#25143;</span>
<span style="color: #a0522d;">repl_password</span>=xxx
<span style="color: #a0522d;">ping_interval</span>=1       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20581;&#24247;&#24615;&#26816;&#26597;&#30340;&#26102;&#38388;&#38388;&#38548;</span>
<span style="color: #a0522d;">master_ip_failover_script</span>=/usr/local/bin/master_ip_failover <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20999;&#25442;vip&#30340;per&#33050;&#26412;</span>
<span style="color: #a0522d;">report_script</span>=/usr/local/bin/sendmail.sh  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#25191;&#34892;&#25253;&#35686;&#33050;&#26412;</span>
<span style="color: #a0522d;">check_repl_delay</span>=0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#20540;&#20026;1&#65292;&#34920;&#31034;&#22914;&#26524;slave&#20013;&#20174;&#24211;&#33853;&#21518;&#20027;&#24211;relay log&#36229;&#36807;100M&#65292;&#20027;&#24211;&#19981;&#20250;&#36873;&#25321;&#36825;&#20010;&#20174;&#24211;&#20026;&#26032;&#30340;master&#65292;&#22240;&#20026;&#36825;&#20010;&#20174;&#24211;&#36827;&#34892;&#24674;&#22797;&#38656;&#35201;&#24456;&#38271;&#26102;&#38388;&#12290;&#36890;&#36807;&#35774;&#32622;&#21442;&#25968;check_repl_delay=0&#65292;mha&#35302;&#21457;&#20027;&#20174;&#20999;&#25442;&#26102;&#20250;&#24573;&#30053;&#22797;&#21046;&#30340;&#24310;&#26102;&#65292;&#23545;&#20110;&#35774;&#32622;candiate_master=1&#30340;&#20174;&#24211;&#38750;&#24120;&#26377;&#29992;&#65292;&#36825;&#26679;&#30830;&#20445;&#36825;&#20010;&#20174;&#24211;&#19968;&#23450;&#33021;&#25104;&#20026;&#26368;&#26032;&#30340;master</span>
<span style="color: #a0522d;">master_binlog_dir</span>=/data/mysql <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#20108;&#36827;&#21046;&#26085;&#24535;&#23384;&#25918;&#30340;&#30446;&#24405;&#65292;mha4mysql-manager-0.58&#24517;&#39035;&#25351;&#23450;&#65292;&#20043;&#21069;&#29256;&#26412;&#19981;&#38656;&#35201;&#25351;&#23450;</span>

[server1]
<span style="color: #a0522d;">hostname</span>=10.0.0.8
<span style="color: #a0522d;">candidate_master</span>=1    
[server2]
<span style="color: #a0522d;">hostname</span>=10.0.0.18
<span style="color: #a0522d;">candidate_master</span>=1    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26399;&#26395;&#35841;&#20248;&#20808;&#25104;&#20026;&#26032;&#30340;&#20027;&#33410;&#28857;Master&#65292;&#21363;&#20351;&#19981;&#26159;&#38598;&#32676;&#20013;&#20107;&#20214;&#26368;&#26032;&#30340;slave&#65292;&#20063;&#20250;&#20248;&#20808;&#24403;master</span>
[server3]
<span style="color: #a0522d;">hostname</span>=10.0.0.28
</pre>
</div>

<p>
说明: 主库宕机谁来接管新的master
</p>
<div class="org-src-container">
<pre class="src src-sh">1. &#25152;&#26377;&#20174;&#33410;&#28857;&#26085;&#24535;&#37117;&#26159;&#19968;&#33268;&#30340;&#65292;&#40664;&#35748;&#20250;&#20197;&#37197;&#32622;&#25991;&#20214;&#30340;&#39034;&#24207;&#21435;&#36873;&#25321;&#19968;&#20010;&#26032;&#20027;
2. &#20174;&#33410;&#28857;&#26085;&#24535;&#19981;&#19968;&#33268;&#65292;&#33258;&#21160;&#36873;&#25321;&#26368;&#25509;&#36817;&#20110;&#20027;&#24211;&#30340;&#20174;&#24211;&#20805;&#24403;&#26032;&#20027;
3. &#22914;&#26524;&#23545;&#20110;&#26576;&#33410;&#28857;&#35774;&#23450;&#20102;&#26435;&#37325;&#65288;<span style="color: #a0522d;">candidate_master</span>=1&#65289;&#65292;&#26435;&#37325;&#33410;&#28857;&#20250;&#20248;&#20808;&#36873;&#25321;&#12290;&#20294;&#26159;&#27492;&#33410;&#28857;&#26085;&#24535;&#37327;&#33853;&#21518;&#20027;&#24211;&#36229;&#36807;100M&#26085;&#24535;&#30340;&#35805;&#65292;&#20063;&#19981;&#20250;&#34987;&#36873;&#25321;&#12290;<span style="color: #a0522d;">&#21487;&#20197;&#37197;&#21512;check_repl_delay</span>=0&#65292;&#20851;&#38381;&#26085;&#24535;&#37327;&#30340;&#26816;&#26597;&#65292;&#24378;&#21046;&#36873;&#25321;&#20505;&#36873;&#33410;&#28857;
</pre>
</div>
</div>
</li>
<li><a id="h:b01d3f62-93cf-4ef3-baca-73a044f98797"></a>相关脚本<br>
<div class="outline-text-6" id="text-h:b01d3f62-93cf-4ef3-baca-73a044f98797">
<div class="org-src-container">
<pre class="src src-sh">vim /etc/mail.rc

[14:57:06 root@mha ~]#vim /usr/local/bin/sendmail.sh
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"MYSQL is down"</span> | mail -s <span style="color: #8b2252;">"MHA Warning"</span> 11x91400158@qq.com

[15:00:14 root@mha ~]#chmod +x /usr/local/bin/sendmail.sh
</pre>
</div>

<p>
master_ip_failover
</p>
<div class="org-src-container">
<pre class="src src-perl"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env perl</span>
<span style="color: #a020f0;">use</span> <span style="color: #008b8b;">strict</span>;
<span style="color: #a020f0;">use</span> <span style="color: #008b8b;">warnings</span> FATAL =&gt; <span style="color: #8b2252;">'all'</span>;
<span style="color: #a020f0;">use</span> <span style="color: #008b8b;">Getopt::Long</span>;
<span style="color: #a020f0;">my</span> (
$<span style="color: #a0522d;">command</span>, $<span style="color: #a0522d;">ssh_user</span>, $<span style="color: #a0522d;">orig_master_host</span>, $<span style="color: #a0522d;">orig_master_ip</span>,
$<span style="color: #a0522d;">orig_master_port</span>, $<span style="color: #a0522d;">new_master_host</span>, $<span style="color: #a0522d;">new_master_ip</span>, $<span style="color: #a0522d;">new_master_port</span>
);
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;&#26102;&#21024;&#38500;&#19979;&#38754;&#19977;&#34892;&#27880;&#37322;</span>
<span style="color: #a020f0;">my</span> $<span style="color: #a0522d;">vip</span> = <span style="color: #8b2252;">'10.0.0.100/24'</span>;<span style="color: #b22222;">#&#35774;&#32622;Virtual IP</span>
<span style="color: #a020f0;">my</span> $<span style="color: #a0522d;">gateway</span> = <span style="color: #8b2252;">'10.0.0.254'</span>;<span style="color: #b22222;">#&#32593;&#20851;Gateway IP</span>
<span style="color: #a020f0;">my</span> $<span style="color: #a0522d;">interface</span> = <span style="color: #8b2252;">'eth0'</span>;
<span style="color: #a020f0;">my</span> $<span style="color: #a0522d;">key</span> = <span style="color: #8b2252;">"1"</span>;
<span style="color: #a020f0;">my</span> $<span style="color: #a0522d;">ssh_start_vip</span> = <span style="color: #8b2252;">"/sbin/ifconfig $interface:$key $vip;/sbin/arping -I $interface -c 3 -s $vip $gateway &gt;/dev/null 2&gt;&amp;1"</span>;
<span style="color: #a020f0;">my</span> $<span style="color: #a0522d;">ssh_stop_vip</span> = <span style="color: #8b2252;">"/sbin/ifconfig $interface:$key down"</span>;
GetOptions(
<span style="color: #8b2252;">'command=s'</span> =&gt; \$<span style="color: #a0522d;">command</span>,
<span style="color: #8b2252;">'ssh_user=s'</span> =&gt; \$<span style="color: #a0522d;">ssh_user</span>,
<span style="color: #8b2252;">'orig_master_host=s'</span> =&gt; \$<span style="color: #a0522d;">orig_master_host</span>,
<span style="color: #8b2252;">'orig_master_ip=s'</span> =&gt; \$<span style="color: #a0522d;">orig_master_ip</span>,
<span style="color: #8b2252;">'orig_master_port=i'</span> =&gt; \$<span style="color: #a0522d;">orig_master_port</span>,
<span style="color: #8b2252;">'new_master_host=s'</span> =&gt; \$<span style="color: #a0522d;">new_master_host</span>,
<span style="color: #8b2252;">'new_master_ip=s'</span> =&gt; \$<span style="color: #a0522d;">new_master_ip</span>,
<span style="color: #8b2252;">'new_master_port=i'</span> =&gt; \$<span style="color: #a0522d;">new_master_port</span>,
);
<span style="color: #a020f0;">exit</span> &amp;<span style="color: #0000ff;">main</span>();
<span style="color: #a020f0;">sub</span> <span style="color: #0000ff;">main</span> {
print <span style="color: #8b2252;">"\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n"</span>;
<span style="color: #a020f0;">if</span> ( $<span style="color: #a0522d;">command</span> eq <span style="color: #8b2252;">"stop"</span> || $<span style="color: #a0522d;">command</span> eq <span style="color: #8b2252;">"stopssh"</span> ) {
<span style="color: #b22222;"># </span><span style="color: #b22222;">$orig_master_host, $orig_master_ip, $orig_master_port are passed.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">If you manage master ip address at global catalog database,</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">invalidate orig_master_ip here.</span>
<span style="color: #a020f0;">my</span> $<span style="color: #a0522d;">exit_code</span> = 1;
<span style="color: #a020f0;">eval</span> {
print <span style="color: #8b2252;">"Disabling the VIP on old master: $orig_master_host \n"</span>;
&amp;<span style="color: #0000ff;">stop_vip</span>();
$<span style="color: #a0522d;">exit_code</span> = 0;
};
<span style="color: #a020f0;">if</span> ($@) {
warn <span style="color: #8b2252;">"Got Error: $@\n"</span>;
<span style="color: #a020f0;">exit</span> $<span style="color: #a0522d;">exit_code</span>;
}
<span style="color: #a020f0;">exit</span> $<span style="color: #a0522d;">exit_code</span>;
}
<span style="color: #a020f0;">elsif</span> ( $<span style="color: #a0522d;">command</span> eq <span style="color: #8b2252;">"start"</span> ) {
<span style="color: #b22222;"># </span><span style="color: #b22222;">all arguments are passed.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">If you manage master ip address at global catalog database,</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">activate new_master_ip here.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">You can also grant write access (create user, set read_only=0, etc) here.</span>
<span style="color: #a020f0;">my</span> $<span style="color: #a0522d;">exit_code</span> = 10;
<span style="color: #a020f0;">eval</span> {
print <span style="color: #8b2252;">"Enabling the VIP - $vip on the new master - $new_master_host \n"</span>;
&amp;<span style="color: #0000ff;">start_vip</span>();
$<span style="color: #a0522d;">exit_code</span> = 0;
};
<span style="color: #a020f0;">if</span> ($@) {
warn $@;
<span style="color: #a020f0;">exit</span> $<span style="color: #a0522d;">exit_code</span>;
}
<span style="color: #a020f0;">exit</span> $<span style="color: #a0522d;">exit_code</span>;
}
<span style="color: #a020f0;">elsif</span> ( $<span style="color: #a0522d;">command</span> eq <span style="color: #8b2252;">"status"</span> ) {
print <span style="color: #8b2252;">"Checking the Status of the script.. OK \n"</span>;
<span style="color: #8b2252;">`ssh $ssh_user\@$orig_master_host \" $ssh_start_vip \"`</span>;
<span style="color: #a020f0;">exit</span> 0;
}
<span style="color: #a020f0;">else</span> {
&amp;<span style="color: #0000ff;">usage</span>();
<span style="color: #a020f0;">exit</span> 1;
}
}
<span style="color: #b22222;"># </span><span style="color: #b22222;">A simple system call that enable the VIP on the new master</span>
<span style="color: #a020f0;">sub</span> <span style="color: #0000ff;">start_vip</span>() {
<span style="color: #8b2252;">`ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`</span>;
}
<span style="color: #b22222;"># </span><span style="color: #b22222;">A simple system call that disable the VIP on the old_master</span>
<span style="color: #a020f0;">sub</span> <span style="color: #0000ff;">stop_vip</span>() {
<span style="color: #8b2252;">`ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"`</span>;
}
<span style="color: #a020f0;">sub</span> <span style="color: #0000ff;">usage</span> {
print
<span style="color: #8b2252;">"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n"</span>;
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">[15:01:44 root@mha ~]#cp master_ip_failover /usr/local/bin/
[15:02:06 root@mha ~]#chmod +x /usr/local/bin/master_ip_failover
</pre>
</div>
</div>
</li>
<li><a id="h:f3bafb1f-0971-401b-8fff-b7fa3f7bb6c3"></a>实现Master<br>
<div class="outline-text-6" id="text-h:f3bafb1f-0971-401b-8fff-b7fa3f7bb6c3">
<div class="org-src-container">
<pre class="src src-sh">mkdir /data/mysql
chown mysql.mysql /data/mysql
yum -y install mysql-server

vim /etc/my.cnf
[mysqld]
log-bin=/data/mysql/mysql-bin
<span style="color: #a0522d;">server_id</span>=1
<span style="color: #a0522d;">skip_name_resolve</span>=1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#27490;&#21453;&#21521;&#35299;&#26512;</span>
general_log <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35266;&#23519;&#32467;&#26524;&#65292;&#38750;&#24517;&#39035;&#39033;&#65292;&#29983;&#20135;&#38656;&#35201;&#21551;&#29992;</span>

systemctl enable --now mysqld

mysql&gt;show master logs

mysql&gt;create user repluser@<span style="color: #8b2252;">'10.0.0.%'</span> identified by <span style="color: #8b2252;">'xxx'</span>;
mysql&gt;grant replication slave on *.* to repluser@<span style="color: #8b2252;">'10.0.0.%'</span>;
mysql&gt;create user mhauser@<span style="color: #8b2252;">'10.0.0.%'</span> identified by <span style="color: #8b2252;">'xxx'</span>;
mysql&gt;grant all on *.* to mhauser@<span style="color: #8b2252;">'10.0.0.%'</span> ;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;VIP</span>
ifconfig eth0:1 192.168.10.100/24
</pre>
</div>
</div>
</li>
<li><a id="h:2237d1d4-6542-4473-8161-cb369a1e6f20"></a>实现slave<br>
<div class="outline-text-6" id="text-h:2237d1d4-6542-4473-8161-cb369a1e6f20">
<div class="org-src-container">
<pre class="src src-sh">mkdir /data/mysql
chown mysql.mysql /data/mysql

yum -y install mysql-server

vim /etc/my.cnf
[mysqld]
<span style="color: #a0522d;">server_id</span>=2         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#21516;&#33410;&#28857;&#27492;&#20540;&#21508;&#19981;&#30456;&#21516;</span>
log-bin=/data/mysql/mysql-bin             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24517;&#39035;&#21551;&#29992;,&#19975;&#19968;&#26410;&#26469;&#20250;&#24403;&#20027;&#33410;&#28857;</span>
read_only           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33509;&#20027;&#26381;&#21153;&#22120;&#25346;&#20102;,&#20174;&#26381;&#21153;&#22120;&#19978;&#20301;,mhauser&#20250;&#33258;&#21160;&#20462;&#25913;&#27492;&#39033;,&#20294;&#26159;&#20027;&#26381;&#21153;&#22120;&#23445;&#26426;&#21518;&#21035;&#24536;&#20102;&#20462;&#25913;&#24050;&#19978;&#20301;&#30340;&#20174;&#26381;&#21153;&#22120;&#30340;&#37197;&#32622;&#25991;&#20214;,&#19981;&#28982;&#37325;&#21551;&#26381;&#21153;&#21518;&#23601;&#20250;&#21464;&#25104;&#21482;&#35835;</span>
<span style="color: #a0522d;">relay_log_purge</span>=0   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#20250;&#33258;&#21160;&#28165;&#29702;&#20013;&#32487;&#26085;&#24535;&#65292;&#20013;&#32487;&#26085;&#24535;&#21487;&#20197;&#23454;&#29616;&#20108;&#36827;&#21046;&#22797;&#21046;</span>
<span style="color: #a0522d;">skip_name_resolve</span>=1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#27490;&#21453;&#21521;&#35299;&#26512;</span>
general_log <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35266;&#23519;&#32467;&#26524;&#65292;&#38750;&#24517;&#39035;&#39033;&#65292;&#29983;&#20135;&#38656;&#35201;&#21551;&#29992;</span>

systemctl enable --now mysqld

mysql&gt;CHANGE MASTER TO 
<span style="color: #a0522d;">MASTER_HOST</span>=<span style="color: #8b2252;">'MASTER_IP'</span>, 
<span style="color: #a0522d;">MASTER_USER</span>=<span style="color: #8b2252;">'repluser'</span>,
<span style="color: #a0522d;">MASTER_PASSWORD</span>=<span style="color: #8b2252;">'xxx'</span>, 
<span style="color: #a0522d;">MASTER_LOG_FILE</span>=<span style="color: #8b2252;">'mysql-bin.000001'</span>,
<span style="color: #a0522d;">MASTER_LOG_POS</span>=245;

mysql&gt;START SLAVE;
</pre>
</div>
</div>
</li>
<li><a id="h:2d86305e-9fe4-4b99-b72b-8cc5ff29245b"></a>检查Mha的环境<br>
<div class="outline-text-6" id="text-h:2d86305e-9fe4-4b99-b72b-8cc5ff29245b">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#29615;&#22659;</span>
masterha_check_ssh --conf=/etc/mastermha/app1.cnf
masterha_check_repl --conf=/etc/mastermha/app1.cnf
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@mha-manager ~]# masterha_check_ssh --conf=/etc/mastermha/app1.cnf
...
Thu Jun 18 17:47:15 2020 - [info] All SSH connection tests passed successfully.

[root@mha-manager ~]# masterha_check_repl --conf=/etc/mastermha/app1.cnf
...
MySQL Replication Health is OK.
</pre>
</div>
</div>
</li>
<li><a id="h:adf3c0b8-4343-44d5-9a5c-19f2b4ad50ec"></a>启动Mha<br>
<div class="outline-text-6" id="text-h:adf3c0b8-4343-44d5-9a5c-19f2b4ad50ec">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;MHA&#65292;&#40664;&#35748;&#26159;&#21069;&#21488;&#36816;&#34892;&#65288;&#21518;&#21488;&#36816;&#34892;&#20877;&#21152;&#19978;&#65289;&#21482;&#35201;&#20027;&#26381;&#21153;&#22120;&#19968;&#25346;&#65292;&#23427;&#23601;&#20250;&#25191;&#34892;</span>
nohup masterha_manager --conf=/etc/mastermha/app1.cnf &amp;&gt; /dev/null

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#29366;&#24577;</span>
masterha_check_status --conf=/etc/mastermha/app1.cnf
....
<span style="color: #0000ff;">app1</span> (pid:28968) is running(0:PING_OK), master:192.168.10.81
</pre>
</div>
</div>
</li>
<li><a id="h:84ee99b1-a3bb-4e6f-8a7b-f0614b8d92c8"></a>排错日志<br>
<div class="outline-text-6" id="text-h:84ee99b1-a3bb-4e6f-8a7b-f0614b8d92c8">
<div class="org-src-container">
<pre class="src src-sh">/data/mastermha/app1/manager.log
</pre>
</div>
</div>
</li>
<li><a id="h:c5f7b552-7d99-493c-b91f-24c36c79e373"></a>模拟故障<br>
<div class="outline-text-6" id="text-h:c5f7b552-7d99-493c-b91f-24c36c79e373">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403; master down&#26426;&#21518;,mha&#33258;&#21160;&#36864;&#20986;</span>
tail  /data/mastermha/app1/manager.log
The latest slave 192.168.10.82(192.168.10.82:3306) has all relay logs for recovery.
Selected 192.168.10.82(192.168.10.82:3306) as a new master.
<span style="color: #0000ff;">192.168.10.82</span>(192.168.10.82:3306): OK: Applying all logs succeeded.
<span style="color: #0000ff;">192.168.10.82</span>(192.168.10.82:3306): OK: Activated master IP address.
<span style="color: #0000ff;">192.168.10.83</span>(192.168.10.83:3306): This host has the latest relay log events.
Generating relay diff files from the latest slave succeeded.
<span style="color: #0000ff;">192.168.10.83</span>(192.168.10.83:3306): OK: Applying all logs succeeded. Slave started, replicating from 192.168.10.82(192.168.10.82:3306)
<span style="color: #0000ff;">192.168.10.82</span>(192.168.10.82:3306): Resetting slave info succeeded.
Master failover to 192.168.10.82(192.168.10.82:3306) completed successfully.
Sun Mar  7 15:30:28 2021 - [info] Sending mail..

[root@mha-manager ~]#masterha_manager --conf=/etc/mastermha/app1.cnf
app1 is stopped(2:NOT_RUNNING)<span style="color: #483d8b;">.</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;VIP&#28418;&#31227;&#33267;&#26032;&#30340;Master&#19978;</span>
[15:33:11 root@slave1 ~]#ifconfig eth0:1
eth0:1: <span style="color: #a0522d;">flags</span>=4163  mtu 1500
inet 192.168.10.100  netmask 255.255.255.0  broadcast 192.168.10.255
ether 00:0c:29:1a:4b:7f  txqueuelen 1000  (Ethernet)

MariaDB [(none)]&gt; select @@read_only;
+-------------+
| @@read_only |
+-------------+
|           0 |
+-------------+
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32780;&#19988;&#21478;&#19968;&#20010;&#20174;&#26381;&#21153;&#22120;10.0.0.28&#20063;&#25442;&#20102;&#26032;&#20027;&#20154;</span>
MariaDB [(none)]&gt; show slave status\G
************************* 1. row ***************************
            Slave_IO_State: Waiting for master to send event
               Master_Host: 10.0.0.18
               Master_User: repluser
               Master_Port: 3306
             Connect_Retry: 60
           Master_Log_File: mariadb-bin.000002
       Read_Master_Log_Pos: 344
            Relay_Log_File: mariadb-relay-bin.000002
             Relay_Log_Pos: 557
     Relay_Master_Log_File: mariadb-bin.000002
          Slave_IO_Running: Yes
         Slave_SQL_Running: Yes
</pre>
</div>
</div>
</li>
<li><a id="h:07d3af99-e93f-4b01-bdab-978151e4ba23"></a>收到报警邮件<br>
<div class="outline-text-6" id="text-h:07d3af99-e93f-4b01-bdab-978151e4ba23">
</div>
</li>
<li><a id="h:e44626d3-137d-48e7-80a4-60d5a31c0a4f"></a>如果再次运行MHA,需要先删除下面文件<br>
<div class="outline-text-6" id="text-h:e44626d3-137d-48e7-80a4-60d5a31c0a4f">
<div class="org-src-container">
<pre class="src src-sh">[15:36:49 root@mha ~]#rm -f /data/mastermha/app1/app1.failover.complete
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:3cd55e5d-2a3b-4c78-b4d0-781185a16897" class="outline-4">
<h4 id="h:3cd55e5d-2a3b-4c78-b4d0-781185a16897">Galera Cluster</h4>
<div class="outline-text-4" id="text-h:3cd55e5d-2a3b-4c78-b4d0-781185a16897">
</div>
<div id="outline-container-h:c370e826-3692-4782-aa25-5804b18be867" class="outline-5">
<h5 id="h:c370e826-3692-4782-aa25-5804b18be867">Galera Cluster介绍</h5>
<div class="outline-text-5" id="text-h:c370e826-3692-4782-aa25-5804b18be867">

<figure id="orgcead398">
<img src="./images/20200704143319104.png" alt="20200704143319104.png" width="60%">

</figure>

<p>
Galera Cluster：集成了Galera插件的MySQL集群，是一种新型的，数据不共享
的，高度冗余的高可方案，目前GaleraCluster有两个版本，分别是Percona
Xtradb Cluster及MariaDB Cluster，Galera本身是具有多主特性的，即采用
multi-master的集群架构，是一个既稳健，又在数据一致性、完整性及高性能方
面有出色表现的高可用解决方案
</p>

<p>
<b>Galera Cluster特点</b>
</p>

<ul class="org-ul">
<li>多主架构：真正的多点读写的集群，在任何时候读写数据，都是最新的</li>
<li>同步复制：集群不同节点之间数据同步，没有延迟，在数据库挂掉之后，数据不会丢失</li>
<li>并发复制：从节点APPLY数据时，支持并行执行，更好的性能</li>
<li>故障切换：在出现数据库故障时，因支持多点写入，切换容易</li>
<li>热插拔：在服务期间，如果数据库挂了，只要监控程序发现的够快，不可服务
时间就会非常少。在节点故障期间，节点本身对集群的影响非常小</li>
<li>自动节点克隆：在新增节点，或者停机维护时，增量数据或者基础数据不需要
人工手动备份提供，Galera Cluster会自动拉取在线节点数据，最终集群会变
为一致</li>
<li>对应用透明：集群的维护，对应用程序是透明的</li>
</ul>

<p>
<b>Galera Cluster 缺点</b>
</p>

<ul class="org-ul">
<li>由于DDL需全局验证通过，则集群性能由集群中最差性能节点决定（一般集群节点配置都是一样的）</li>
<li>新节点加入或延后较大的节点重新加入需全量拷贝数据(SST，State Snapshot
Transfer),作为donor( 贡献者，如：同步数据时的提供者)的节点在同步过程
中无法提供读写</li>
<li>只支持innodb存储引擎的表</li>
</ul>

<p>
<b>Galera Cluster工作过程</b>
</p>


<figure id="org428b493">
<img src="./images/20200704143340885.png" alt="20200704143340885.png" width="60%">

</figure>


<p>
<b>Galera Cluster官方文档</b> ：
</p>
<ul class="org-ul">
<li><a href="http://galeracluster.com/documentation-webpages/galera-documentation.pdf">http://galeracluster.com/documentation-webpages/galera-documentation.pdf</a></li>
<li><a href="http://galeracluster.com/documentation-webpages/index.html">http://galeracluster.com/documentation-webpages/index.html</a></li>
<li><a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/index.html">https://www.percona.com/doc/percona-xtradb-cluster/LATEST/index.html</a></li>
<li><a href="https://mariadb.com/kb/en/library/getting-started-with-mariadb-galera-cluster/">https://mariadb.com/kb/en/library/getting-started-with-mariadb-galera-cluster/</a></li>
</ul>

<p>
<b>Galera Cluster包括两个组件</b>
Galera replication library (galera-3)
WSREP：MySQL extended with the Write Set Replication
</p>

<p>
<b>WSREP复制实现</b>:
</p>

<ul class="org-ul">
<li>PXC：Percona XtraDB Cluster，是Percona对Galera的实现</li>
</ul>

<p>
参考仓库：<a href="https://mirrors.tuna.tsinghua.edu.cn/percona/release/$releasever/RPMS/$basearch">https://mirrors.tuna.tsinghua.edu.cn/percona/release/$releasever/RPMS/$basearch</a>
</p>

<ul class="org-ul">
<li>MariaDB Galera Cluster：</li>
</ul>

<p>
参考仓库：<a href="https://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadb-5.5.X/yum/centos7-amd64/">https://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadb-5.5.X/yum/centos7-amd64/</a>
</p>

<p>
注意：两者都需要至少三个节点，不能安装mysql server 或 mariadb-server*
</p>
</div>
</div>
<div id="outline-container-h:c122f355-bbeb-4d85-b851-a1a720e918f9" class="outline-5">
<h5 id="h:c122f355-bbeb-4d85-b851-a1a720e918f9">PXC 原理</h5>
<div class="outline-text-5" id="text-h:c122f355-bbeb-4d85-b851-a1a720e918f9">

<figure id="org3eef1a9">
<img src="./images/20200704143352699.png" alt="20200704143352699.png" width="60%">

</figure>


<figure id="orgf33b18d">
<img src="./images/20200704143401741.png" alt="20200704143401741.png" width="60%">

</figure>

<p>
<b>PXC最常使用如下4个端口号：</b>
</p>

<ul class="org-ul">
<li>3306：数据库对外服务的端口号</li>
<li>4444：请求SST的端口号</li>
<li>4567：组成员之间进行沟通的端口号</li>
<li>4568：用于传输IST的端口号</li>
</ul>

<p>
PXC中涉及到的重要概念和核心参数：
</p>

<p>
（1）集群中节点的数量：整个集群中节点数量应该控制在最少3个、最多8个的
范围内。最少3个节点是为了防止出现脑裂现象，因为只有在2个节点下才会出现
此现象。脑裂现象的标志就是输入任何命令，返回的结果都是unknown command。
节点在集群中，会因新节点的加入或故障、同步失效等原因发生状态的切换。
</p>

<p>
（2）节点状态的变化阶段：
</p>


<figure id="org56da168">
<img src="./images/20200704143412294.png" alt="20200704143412294.png" width="60%">

</figure>

<ul class="org-ul">
<li>open：节点启动成功，尝试连接到集群时的状态</li>
<li>primary：节点已处于集群中，在新节点加入并选取donor进行数据同步时的状态</li>
<li>joiner：节点处于等待接收同步文件时的状态</li>
<li>joined：节点完成数据同步工作，尝试保持和集群进度一致时的状态</li>
<li>synced：节点正常提供服务时的状态，表示已经同步完成并和集群进度保持一致</li>
<li>donor：节点处于为新加入的节点提供全量数据时的状态</li>
</ul>

<p>
备注：donor节点就是数据的贡献者，如果一个新节点加入集群，此时又需要大
量数据的SST数据传输，就有可能因此而拖垮整个集群的性能，所以在生产环境
中，如果数据量较小，还可以使用SST全量数据传输，但如果数据量很大就不建
议使用这种方式，可以考虑先建立主从关系，然后再加入集群。
</p>

<p>
（3）节点的数据传输方式：
</p>

<ul class="org-ul">
<li><b>SST：State Snapshot Transfer，全量数据传输</b></li>
<li><b>IST：Incremental State Transfer，增量数据传输</b></li>
</ul>

<p>
SST数据传输有xtrabackup、mysqldump和rsync三种方式，而增量数据传输就只
有一种方式xtrabackup，但生产环境中一般数据量较小时，可以使用SST全量数
据传输，但也只使用xtrabackup方法。
</p>

<p>
（4）GCache模块：在PXC中一个特别重要的模块，它的核心功能就是为每个节点
缓存当前最新的写集。如果有新节点加入进来，就可以把新数据的增量传递给新
节点，而不需要再使用SST传输方式，这样可以让节点更快地加入集群中，涉及
如下参数：
</p>

<ul class="org-ul">
<li>gcache.size：缓存写集增量信息的大小，它的默认大小是128MB，通过
wsrep_provider_options参数设置，建议调整为2GB~4GB范围，足够的空间便
于缓存更多的增量信息。</li>
<li>gcache.mem_size：GCache中内存缓存的大小，适度调大可以提高整个集群的性能</li>
<li>gcache.page_size：如果内存不够用（GCache不足），就直接将写集写入磁盘文件中</li>
</ul>
</div>
</div>
<div id="outline-container-h:469ca160-3ddf-4b5e-9ec1-72dc63a5a3b2" class="outline-5">
<h5 id="h:469ca160-3ddf-4b5e-9ec1-72dc63a5a3b2">实战案例：Percona XtraDB Cluster(PXC 5.7）</h5>
<div class="outline-text-5" id="text-h:469ca160-3ddf-4b5e-9ec1-72dc63a5a3b2">
<p>
<b>1 环境准备</b>
</p>

<p>
四台主机
</p>

<div class="org-src-container">
<pre class="src src-sh">pxc1:10.0.0.7
pxc1:10.0.0.17
pxc1:10.0.0.27
pxc4:10.0.0.37
</pre>
</div>

<p>
<b>OS 版本目前不支持CentOS 8</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@pxc1 ~]#cat /etc/redhat-release
CentOS Linux release 7.6.1810 (Core)
</pre>
</div>

<p>
关闭防火墙和SELinux，保证时间同步
</p>

<p>
注意：如果已经安装MySQL，必须卸载
</p>

<p>
<b>2 安装 Percona XtraDB Cluster 5.7</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27492;&#22788;&#20351;&#29992;&#28165;&#21326;&#22823;&#23398;yum&#28304;&#65292;&#23448;&#26041;&#28304;&#22826;&#24930;&#20102;</span>
[root@pxc1 ~]#vim /etc/yum.repos.d/pxc.repo
[percona]
<span style="color: #a0522d;">name</span>=percona_repo
baseurl = https://mirrors.tuna.tsinghua.edu.cn/percona/release/$<span style="color: #a0522d;">releasever</span>/RPMS/$<span style="color: #a0522d;">basearch</span>
enabled = 1
gpgcheck = 0

[root@pxc1 ~]#scp /etc/yum.repos.d/pxc.repo 10.0.0.17:/etc/yum.repos.d
[root@pxc1 ~]#scp /etc/yum.repos.d/pxc.repo 10.0.0.27:/etc/yum.repos.d

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#19977;&#20010;&#33410;&#28857;&#37117;&#23433;&#35013;&#22909;PXC 5.7</span>
[root@pxc1 ~]#yum install Percona-XtraDB-Cluster-57 -y
[root@pxc2 ~]#yum install Percona-XtraDB-Cluster-57 -y
[root@pxc3 ~]#yum install Percona-XtraDB-Cluster-57 -y
</pre>
</div>

<p>
<b>3 在各个节点上分别配置mysql及集群配置文件</b>
</p>

<p>
/etc/my.cnf为主配置文件，当前版本中，其余的配置文件都放在
/etc/percona-xtradb-cluster.conf.d目录里，包括mysqld.cnf，
mysqld_safe.cnf，wsrep.cnf三个文件
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#37197;&#32622;&#25991;&#20214;&#19981;&#38656;&#35201;&#20462;&#25913;</span>
[root@pxc1 ~]#cat /etc/my.cnf
<span style="color: #b22222;"># </span><span style="color: #b22222;">The Percona XtraDB Cluster 5.7 configuration file.</span>
...&#30465;&#30053;...
!includedir /etc/my.cnf.d/
!includedir /etc/percona-xtradb-cluster.conf.d/

[root@pxc1 ~]#ls /etc/my.cnf.d/
[root@pxc1 ~]#ls /etc/percona-xtradb-cluster.conf.d/
mysqld.cnf mysqld_safe.cnf wsrep.cnf

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#38754;&#37197;&#32622;&#25991;&#20214;&#19981;&#38656;&#35201;&#20462;&#25913;</span>
[root@pxc1 ~]#cat /etc/percona-xtradb-cluster.conf.d/mysqld.cnf
...&#30465;&#30053;...
[client]
<span style="color: #a0522d;">socket</span>=/var/lib/mysql/mysql.sock
[mysqld]
server-id=1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24314;&#35758;&#21508;&#20010;&#33410;&#28857;&#19981;&#21516;</span>
<span style="color: #a0522d;">datadir</span>=/var/lib/mysql
<span style="color: #a0522d;">socket</span>=/var/lib/mysql/mysql.sock
log-error=/var/log/mysqld.log
pid-file=/var/run/mysqld/mysqld.pid
log-bin <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24314;&#35758;&#21551;&#29992;&#65292;&#38750;&#24517;&#39035;&#39033;</span>
log_slave_updates
<span style="color: #a0522d;">expire_logs_days</span>=7

<span style="color: #b22222;"># </span><span style="color: #b22222;">Disabling symbolic-links is recommended to prevent assorted security risks</span>

symbolic-links=0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#38754;&#37197;&#32622;&#25991;&#20214;&#19981;&#38656;&#35201;&#20462;&#25913;</span>
[root@pxc1 ~]#cat /etc/percona-xtradb-cluster.conf.d/mysqld_safe.cnf
...&#30465;&#30053;...
[mysqld_safe]
pid-file = /var/run/mysqld/mysqld.pid
socket = /var/lib/mysql/mysql.sock
nice = 0

<span style="color: #b22222;">#</span><span style="color: #b22222;">PXC&#30340;&#37197;&#32622;&#25991;&#20214;&#24517;&#39035;&#20462;&#25913;</span>
[root@pxc1 ~]#vim /etc/percona-xtradb-cluster.conf.d/wsrep.cnf
[root@pxc1 ~]#grep -Ev <span style="color: #8b2252;">"^#|^$"</span> /etc/percona-xtradb-cluster.conf.d/wsrep.cnf
[mysqld]
<span style="color: #a0522d;">wsrep_provider</span>=/usr/lib64/galera3/libgalera_smm.so
<span style="color: #a0522d;">wsrep_cluster_address</span>=gcomm://10.0.0.7,10.0.0.17,10.0.0.27 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19977;&#20010;&#33410;&#28857;&#30340;IP</span>
<span style="color: #a0522d;">binlog_format</span>=ROW
<span style="color: #a0522d;">default_storage_engine</span>=InnoDB
<span style="color: #a0522d;">wsrep_slave_threads</span>= 8
wsrep_log_conflicts
<span style="color: #a0522d;">innodb_autoinc_lock_mode</span>=2
<span style="color: #a0522d;">wsrep_node_address</span>=10.0.0.7 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21508;&#20010;&#33410;&#28857;&#65292;&#25351;&#23450;&#33258;&#24050;&#30340;IP</span>
<span style="color: #a0522d;">wsrep_cluster_name</span>=pxc-cluster
<span style="color: #a0522d;">wsrep_node_name</span>=pxc-cluster-node-1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21508;&#20010;&#33410;&#28857;&#65292;&#25351;&#23450;&#33258;&#24050;&#33410;&#28857;&#21517;&#31216;</span>
<span style="color: #a0522d;">pxc_strict_mode</span>=ENFORCING
<span style="color: #a0522d;">wsrep_sst_method</span>=xtrabackup-v2
<span style="color: #a0522d;">wsrep_sst_auth</span>=<span style="color: #8b2252;">"sstuser:s3cretPass"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#28040;&#26412;&#34892;&#27880;&#37322;&#65292;&#21516;&#19968;&#38598;&#32676;&#20869;&#22810;&#20010;&#33410;&#28857;&#30340;&#39564;&#35777;&#29992;&#25143;&#21644;&#23494;&#30721;&#20449;&#24687;&#24517;&#39035;&#19968;&#33268;</span>

[root@pxc2 ~]#grep -Ev <span style="color: #8b2252;">"^#|^$"</span> /etc/percona-xtradb-cluster.conf.d/wsrep.cnf
[mysqld]
<span style="color: #a0522d;">wsrep_provider</span>=/usr/lib64/galera3/libgalera_smm.so
<span style="color: #a0522d;">wsrep_cluster_address</span>=gcomm://10.0.0.7,10.0.0.17,10.0.0.27
<span style="color: #a0522d;">binlog_format</span>=ROW
<span style="color: #a0522d;">default_storage_engine</span>=InnoDB
<span style="color: #a0522d;">wsrep_slave_threads</span>= 8
wsrep_log_conflicts
<span style="color: #a0522d;">innodb_autoinc_lock_mode</span>=2 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21508;&#20010;&#33410;&#28857;&#65292;&#25351;&#23450;&#33258;&#24050;&#30340;IP</span>
<span style="color: #a0522d;">wsrep_node_address</span>=10.0.0.17
<span style="color: #a0522d;">wsrep_cluster_name</span>=pxc-cluster
<span style="color: #a0522d;">wsrep_node_name</span>=pxc-cluster-node-2 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21508;&#20010;&#33410;&#28857;&#65292;&#25351;&#23450;&#33258;&#24050;&#33410;&#28857;&#21517;&#31216;</span>
<span style="color: #a0522d;">pxc_strict_mode</span>=ENFORCING
<span style="color: #a0522d;">wsrep_sst_method</span>=xtrabackup-v2
<span style="color: #a0522d;">wsrep_sst_auth</span>=<span style="color: #8b2252;">"sstuser:s3cretPass"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#28040;&#26412;&#34892;&#27880;&#37322;</span>

[root@pxc3 ~]#grep -Ev <span style="color: #8b2252;">"^#|^$"</span> /etc/percona-xtradb-cluster.conf.d/wsrep.cnf
[mysqld]
<span style="color: #a0522d;">wsrep_provider</span>=/usr/lib64/galera3/libgalera_smm.so
<span style="color: #a0522d;">wsrep_cluster_address</span>=gcomm://10.0.0.7,10.0.0.17,10.0.0.27
<span style="color: #a0522d;">binlog_format</span>=ROW
<span style="color: #a0522d;">default_storage_engine</span>=InnoDB
<span style="color: #a0522d;">wsrep_slave_threads</span>= 8
wsrep_log_conflicts
<span style="color: #a0522d;">innodb_autoinc_lock_mode</span>=2
<span style="color: #a0522d;">wsrep_node_address</span>=10.0.0.27 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21508;&#20010;&#33410;&#28857;&#65292;&#25351;&#23450;&#33258;&#24050;&#30340;IP</span>
<span style="color: #a0522d;">wsrep_cluster_name</span>=pxc-cluster
<span style="color: #a0522d;">wsrep_node_name</span>=pxc-cluster-node-3 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21508;&#20010;&#33410;&#28857;&#65292;&#25351;&#23450;&#33258;&#24050;&#30340;IP</span>
<span style="color: #a0522d;">pxc_strict_mode</span>=ENFORCING
<span style="color: #a0522d;">wsrep_sst_method</span>=xtrabackup-v2
<span style="color: #a0522d;">wsrep_sst_auth</span>=<span style="color: #8b2252;">"sstuser:s3cretPass"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#28040;&#26412;&#34892;&#27880;&#37322;</span>
</pre>
</div>

<p>
注意：尽管Galera Cluster不再需要通过binlog的形式进行同步，但还是建议在
配置文件中开启二进制日志功能，原因是后期如果有新节点需要加入，老节点通
过SST全量传输的方式向新节点传输数据，很可能会拖垮集群性能，所以让新节
点先通过binlog方式完成同步后再加入集群会是一种更好的选择
</p>

<p>
<b>配置文件各项配置意义</b>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">配置</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">wsrep_provider</td>
<td class="org-left">指定Galera库的路径</td>
</tr>

<tr>
<td class="org-left">wsrep_cluster_name</td>
<td class="org-left">Galera集群的名称</td>
</tr>

<tr>
<td class="org-left">wsrep_cluster_address</td>
<td class="org-left">Galera集群中各节点地址。地址使用组通信协议 gcomm://(group communication)</td>
</tr>

<tr>
<td class="org-left">wsrep_node_name</td>
<td class="org-left">本节点在Galera集群中的名称</td>
</tr>

<tr>
<td class="org-left">wsrep_node_address</td>
<td class="org-left">本节点在Galera集群中的通信地址</td>
</tr>

<tr>
<td class="org-left">wsrep_sst_method</td>
<td class="org-left">state_snapshot_transfer(SST)使用的传输方法，可用方法有 mysqldump、rsync和xtrabackup，前两者在传输时都需要对 Donor加全局只读锁(FLUSH TABLES WITH READ LOCK)， xtrabackup则不需要(它使用percona自己提供的backup lock)。 强烈建议采用xtrabackup</td>
</tr>

<tr>
<td class="org-left">wsrep_sst_auth</td>
<td class="org-left">在SST传输时需要用到的认证凭据，格式为："用户：密码"</td>
</tr>

<tr>
<td class="org-left">pxc_strict_mode</td>
<td class="org-left">是否限制PXC启用正在试用阶段的功能，ENFORCING是默认值， 表示不启用</td>
</tr>

<tr>
<td class="org-left">binlog_format</td>
<td class="org-left">二进制日志的格式。Galera只支持row格式的二进制日志</td>
</tr>

<tr>
<td class="org-left">default_storage_engine</td>
<td class="org-left">指定默认存储引擎。Galera的复制功能只支持InnoDB</td>
</tr>

<tr>
<td class="org-left">innodb_autoinc_lock_mode</td>
<td class="org-left">只能设置为2，设置为0或1时会无法正确处理死锁问题</td>
</tr>
</tbody>
</table>

<p>
<b>4 启动PXC集群中第一个节点</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@Centos7 ~]#ss -ntl
State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              
LISTEN      0      128           *:111                       *:*                  
LISTEN      0      128           *:22                        *:*                  
LISTEN      0      128        [::]:111                    [::]:*                  
LISTEN      0      128        [::]:22                     [::]:*                  
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#31532;&#19968;&#20010;&#33410;&#28857;</span>
[root@Centos7 ~]#systemctl start mysql@bootstrap.service
[root@Centos7 ~]#ss -ntl
State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              
LISTEN      0      128           *:111                       *:*                  
LISTEN      0      128           *:22                        *:*                  
LISTEN      0      128           *:4567                      *:*                  
LISTEN      0      80         [::]:3306                   [::]:*                  
LISTEN      0      128        [::]:111                    [::]:*                  
LISTEN      0      128        [::]:22                     [::]:*            
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;root&#23494;&#30721;</span>
[root@Centos7 ~]#grep <span style="color: #8b2252;">"temporary password"</span> /var/log/mysqld.log
2020-06-18T14:16:34.320363Z 1 [Note] A temporary password is generated for root@localhost: Wy4GgKwWB%,z

[root@Centos7 ~]#mysql -uroot -p<span style="color: #8b2252;">'Wy4GgKwWB%,z'</span>
mysql: [Warning] Using a password on the command line interface can be insecure.
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 11
Server version: 5.7.29-32-57-log

<span style="color: #0000ff;">Copyright</span> (c) 2009-2020 Percona LLC and/or its affiliates
<span style="color: #0000ff;">Copyright</span> (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type <span style="color: #8b2252;">'help;'</span> or <span style="color: #8b2252;">'\h'</span> for help. Type <span style="color: #8b2252;">'\c'</span> to clear the current input statement.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;root&#23494;&#30721;</span>
mysql&gt; alter user <span style="color: #8b2252;">'root'</span>@<span style="color: #8b2252;">'localhost'</span> identified by <span style="color: #8b2252;">'xxx'</span>;
Query OK, 0 rows affected (0.00 sec)
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#30456;&#20851;&#29992;&#25143;&#24182;&#25480;&#26435;</span>
mysql&gt; CREATE USER <span style="color: #8b2252;">'sstuser'</span>@<span style="color: #8b2252;">'localhost'</span> IDENTIFIED BY <span style="color: #8b2252;">'s3cretPass'</span>;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; GRANT RELOAD, LOCK TABLES, PROCESS, REPLICATION CLIENT ON *.* TO <span style="color: #8b2252;">'sstuser'</span>@<span style="color: #8b2252;">'localhost'</span>;
Query OK, 0 rows affected (0.01 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#30456;&#20851;&#21464;&#37327;</span>
mysql&gt; SHOW VARIABLES LIKE <span style="color: #8b2252;">'wsrep%'</span>\G

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#30456;&#20851;&#29366;&#24577;&#21464;&#37327;</span>
mysql&gt; SHOW STATUS LIKE <span style="color: #8b2252;">'wsrep%'</span>\G

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#28857;&#20851;&#27880;&#19979;&#38754;&#20869;&#23481;</span>
mysql&gt; show status like <span style="color: #8b2252;">'wsrep%'</span>;
+----------------------------+--------------------------------------+
| Variable_name              | Value                                |
+----------------------------+--------------------------------------+
| wsrep_local_state_uuid     | aad2c02e-131c-11ea-9294-b2e80a6c08c4 |
| ...                        | ...                                  |
| wsrep_local_state          | 4                                    |
| wsrep_local_state_comment  | Synced                               |
| ...                        | ...                                  |
| wsrep_cluster_size         | 1                                    |
| wsrep_cluster_status       | Primary                              |
| wsrep_connected            | ON                                   |
| ...                        | ...                                  |
| wsrep_ready                | ON                                   |
+----------------------------+--------------------------------------+
</pre>
</div>

<p>
说明：
wsrep_cluster_size表示，该Galera集群中只有一个节点
</p>

<p>
wsrep_local_state_comment 状态为Synced(4)，表示数据已同步完成(因为是第
一个引导节点，无数据需要同步)。如果状态是Joiner, 意味着 SST 没有完成，
只有所有节点状态是Synced，才可以加新节点
</p>

<p>
wsrep_cluster_status为Primary，且已经完全连接并准备好
</p>

<p>
<b>5 启动PXC集群中其它所有节点</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@Centos7 ~]#ss -ntl
State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              
LISTEN      0      128           *:22                        *:*                  
LISTEN      0      128           *:111                       *:*                  
LISTEN      0      128        [::]:22                     [::]:*                  
LISTEN      0      128        [::]:111                    [::]:*                  
[root@Centos7 ~]#systemctl start mysql
[root@Centos7 ~]#ss -ntl
State       Recv-Q Send-Q Local Address:Port               Peer Address:Port              
LISTEN      0      128           *:22                        *:*                  
LISTEN      0      128           *:4567                      *:*                  
LISTEN      0      128           *:111                       *:*                  
LISTEN      0      128        [::]:22                     [::]:*                  
LISTEN      0      80         [::]:3306                   [::]:*                  
LISTEN      0      128        [::]:111                    [::]:*
</pre>
</div>

<p>
<b>6 查看集群状态，验证集群是否成功</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#20219;&#24847;&#33410;&#28857;&#65292;&#26597;&#30475;&#38598;&#32676;&#29366;&#24577;</span>
[root@Centos7 ~]#mysql -uroot -pxxx
mysql&gt; SHOW VARIABLES LIKE <span style="color: #8b2252;">'wsrep_node_name'</span>;
+-----------------+---------------------------+
| Variable_name   | Value                     |
+-----------------+---------------------------+
| wsrep_node_name | pxc-cluster-xxx-node-1 |
+-----------------+---------------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; SHOW VARIABLES LIKE <span style="color: #8b2252;">'wsrep_node_address'</span>;
+--------------------+----------+
| Variable_name      | Value    |
+--------------------+----------+
| wsrep_node_address | 10.0.0.7 |
+--------------------+----------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; SHOW VARIABLES LIKE <span style="color: #8b2252;">'wsrep_on'</span>;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| wsrep_on      | ON    |
+---------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; SHOW STATUS LIKE <span style="color: #8b2252;">'wsrep_cluster_size'</span>;
+--------------------+-------+
| Variable_name      | Value |
+--------------------+-------+
| wsrep_cluster_size | 3     |
+--------------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#20219;&#24847;&#33410;&#28857;&#26597;&#30475;&#25968;&#25454;&#24211;</span>
mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
4 rows<span style="color: #a020f0;"> in</span> set (0.00 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#20219;&#24847;&#33410;&#28857;&#21019;&#24314;&#25968;&#25454;&#24211;</span>
mysql&gt; create database testdb1;
Query OK, 1 row affected (0.01 sec)

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| testdb1            |
+--------------------+
5 rows<span style="color: #a020f0;"> in</span> set (0.00 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#20219;&#24847;&#20854;&#23427;&#33410;&#28857;&#39564;&#35777;&#25968;&#25454;&#26159;&#21542;&#21516;&#27493;</span>
[root@pxc2 ~]#mysql -uroot -pxxx
mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| testdb1            |
+--------------------+
5 rows<span style="color: #a020f0;"> in</span> set (0.00 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21033;&#29992;Xshell&#36719;&#20214;&#65292;&#21516;&#26102;&#22312;&#19977;&#20010;&#33410;&#28857;&#25968;&#25454;&#24211;&#65292;&#22312;&#20854;&#20013;&#19968;&#20010;&#33410;&#28857;&#25104;&#21151;</span>
mysql&gt; create database testdb2;
Query OK, 1 row affected (0.01 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#20854;&#23427;&#33410;&#28857;&#37117;&#25552;&#31034;&#22833;&#36133;</span>
mysql&gt; create database testdb2;
ERROR 1007 (HY000): Can<span style="color: #8b2252;">'t create database '</span>testdb2<span style="color: #8b2252;">'; database exists</span>
</pre>
</div>

<p>
<b>7 在PXC集群中加入节点</b>
</p>

<p>
一个节点加入到Galera集群有两种情况：新节点加入集群、暂时离组的成员再次加入集群
</p>

<p>
<b>1）新节点加入Galera集群</b>
</p>

<p>
新节点加入集群时，需要从当前集群中选择一个Donor节点来同步数据，也就是
所谓的state_snapshot_tranfer(SST)过程。SST同步数据的方式由选项
wsrep_sst_method决定，一般选择的是xtrabackup。
</p>

<p>
必须注意，新节点加入Galera时，会删除新节点上所有已有数据，再通过
xtrabackup(假设使用的是该方式)从Donor处完整备份所有数据进行恢复。所以，
如果数据量很大，新节点加入过程会很慢。而且，在一个新节点成为Synced状态
之前，不要同时加入其它新节点，否则很容易将集群压垮。
</p>

<p>
如果是这种情况，可以考虑使用wsrep_sst_method=rsync来做增量同步，既然是
增量同步，最好保证新节点上已经有一部分数据基础，否则和全量同步没什么区
别，且这样会对Donor节点加上全局read only锁。
</p>

<p>
<b>2）旧节点加入Galera集群</b>
</p>

<p>
如果旧节点加入Galera集群，说明这个节点在之前已经在Galera集群中呆过，有
一部分数据基础，缺少的只是它离开集群时的数据。这时加入集群时，会采用
IST(incremental snapshot transfer)传输机制，即使用增量传输。
</p>

<p>
但注意，这部分增量传输的数据源是Donor上缓存在GCache文件中的，这个文件
有大小限制，如果缺失的数据范围超过已缓存的内容，则自动转为SST传输。如
果旧节点上的数据和Donor上的数据不匹配(例如这个节点离组后人为修改了一点
数据)，则自动转为SST传输。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;PXC&#38598;&#32676;&#20013;&#20877;&#21152;&#19968;&#21488;&#26032;&#30340;&#20027;&#26426;PXC4&#65306;10.0.0.37</span>
[root@pxc4 ~]#yum install Percona-XtraDB-Cluster-57 -y
[root@pxc4 ~]#vim /etc/percona-xtradb-cluster.conf.d/wsrep.cnf
[root@Centos7 ~]#grep -Ev <span style="color: #8b2252;">"^#|^$"</span> /etc/percona-xtradb-cluster.conf.d/wsrep.cnf
[mysqld]
<span style="color: #a0522d;">wsrep_provider</span>=/usr/lib64/galera3/libgalera_smm.so
<span style="color: #a0522d;">wsrep_cluster_address</span>=gcomm://10.0.0.7,10.0.0.17,10.0.0.27,10.0.0.37
<span style="color: #a0522d;">binlog_format</span>=ROW
<span style="color: #a0522d;">default_storage_engine</span>=InnoDB
<span style="color: #a0522d;">wsrep_slave_threads</span>= 8
wsrep_log_conflicts
<span style="color: #a0522d;">innodb_autoinc_lock_mode</span>=2
<span style="color: #a0522d;">wsrep_node_address</span>=10.0.0.37
<span style="color: #a0522d;">wsrep_cluster_name</span>=pxc-cluster-xxx
<span style="color: #a0522d;">wsrep_node_name</span>=pxc-cluster-xxx-node-4
<span style="color: #a0522d;">pxc_strict_mode</span>=ENFORCING
<span style="color: #a0522d;">wsrep_sst_method</span>=xtrabackup-v2
<span style="color: #a0522d;">wsrep_sst_auth</span>=<span style="color: #8b2252;">"sstuser:s3cretPass"</span>

[root@Centos7 ~]#systemctl start mysql
[root@Centos7 ~]#mysql -uroot -pxxx
mysql&gt; SHOW STATUS LIKE <span style="color: #8b2252;">'wsrep_cluster_size'</span>;
+--------------------+-------+
| Variable_name      | Value |
+--------------------+-------+
| wsrep_cluster_size | 4     |
+--------------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| db2                |
| mysql              |
| performance_schema |
| sys                |
| testdb1            |
+--------------------+
6 rows<span style="color: #a020f0;"> in</span> set (0.00 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#20854;&#23427;&#33410;&#28857;&#30340;&#37197;&#32622;&#25991;&#20214;&#21152;&#20197;&#20462;&#25913;</span>
[root@pxc1 ~]#vim /etc/percona-xtradb-cluster.conf.d/wsrep.cnf
<span style="color: #a0522d;">wsrep_cluster_address</span>=gcomm://10.0.0.7,10.0.0.17,10.0.0.27,10.0.0.37
[root@pxc2 ~]#vim /etc/percona-xtradb-cluster.conf.d/wsrep.cnf
[root@pxc3 ~]#vim /etc/percona-xtradb-cluster.conf.d/wsrep.cnf
</pre>
</div>

<p>
<b>8 在PXC集群中修复故障节点</b>
</p>

<div class="org-src-container">
<pre class="src src-sql">#&#22312;&#20219;&#24847;&#33410;&#28857;&#20572;&#27490;&#26381;&#21153;
[root@pxc4 ~]#systemctl stop mysql

#&#22312;&#20854;&#23427;&#20219;&#24847;&#33410;&#28857;&#26597;&#30475;wsrep_cluster_size&#21464;&#37327;&#23569;&#20102;&#19968;&#20010;&#33410;&#28857;
[root@pxc1 ~]#mysql -uroot -pxxx
Server version: 5.7.27-30-57-log Percona XtraDB Cluster (GPL), Release rel30,Revision
mysql&gt; SHOW STATUS <span style="color: #a020f0;">LIKE</span> <span style="color: #8b2252;">'wsrep_cluster_size'</span>;
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-------+</span>
| Variable_name      | <span style="color: #a020f0;">Value</span> |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-------+</span>
| wsrep_cluster_size | 3     |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.00 sec)

mysql&gt; <span style="color: #a020f0;">create</span> database testdb4;

  #&#22312;&#20854;&#23427;&#20219;&#24847;&#33410;&#28857;&#21487;&#30475;&#21040;&#25968;&#25454;&#24050;&#21516;&#27493;
mysql&gt; show databases;
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>
| Database           |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>
| information_schema |
| db2                |
| mysql              |
| performance_schema |
| sys                |
| testdb1            |
| testdb4            |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>
7 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.00 sec)

#&#24674;&#22797;&#26381;&#21153;&#65292;&#25968;&#25454;&#21516;&#27493;
[root@pxc4 ~]#systemctl <span style="color: #a020f0;">start</span> mysql
[root@pxc4 ~]#mysql -uroot -pxxx
mysql&gt; show databases;
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>
| Database           |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>
| information_schema |
| db2                |
| mysql              |
| performance_schema |
| sys                |
| testdb1            |
| testdb4            |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+</span>
7 <span style="color: #a020f0;">rows</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.00 sec)

mysql&gt; SHOW STATUS <span style="color: #a020f0;">LIKE</span> <span style="color: #8b2252;">'wsrep_cluster_size'</span>;
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-------+</span>
| Variable_name      | <span style="color: #a020f0;">Value</span> |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-------+</span>
| wsrep_cluster_size | 4     |
+<span style="color: #b22222;">--------------------</span><span style="color: #b22222;">+-------+</span>
1 <span style="color: #228b22;">row</span> <span style="color: #a020f0;">in</span> <span style="color: #a020f0;">set</span> (0.01 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4ad13043-2483-4f6d-8a0c-79ca90cb3542" class="outline-5">
<h5 id="h:4ad13043-2483-4f6d-8a0c-79ca90cb3542">实战案例：MariaDB Galera Cluster</h5>
<div class="outline-text-5" id="text-h:4ad13043-2483-4f6d-8a0c-79ca90cb3542">
<p>
范例：*在centos8 实现MariaDB Galera Cluster*
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#19977;&#20010;&#33410;&#28857;&#19978;&#37117;&#23454;&#29616;</span>
[root@centos8 ~]#dnf install mariadb-server-galera -y
[root@centos8 ~]#vim /etc/my.cnf.d/galera.cnf
<span style="color: #b22222;">#</span><span style="color: #b22222;">wsrep_cluster_address="dummy://"</span>
<span style="color: #a0522d;">wsrep_cluster_address</span>=<span style="color: #8b2252;">"gcomm://10.0.0.8,10.0.0.18,10.0.0.28"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#31532;&#19968;&#33410;&#28857;</span>
[root@centos8 ~]#galera_new_cluster

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20877;&#21551;&#21160;&#20854;&#23427;&#33410;&#28857;</span>
[root@centos8 ~]#systemctl start mariadb
[root@centos8 ~]#ss -ntul

[root@centos8 ~]#mysql

MariaDB [(none)]&gt; show status like <span style="color: #8b2252;">"wsrep_ready"</span>;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| wsrep_ready   | ON    |
+---------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [(none)]&gt; SHOW STATUS LIKE <span style="color: #8b2252;">'wsrep_cluster_size'</span>;
+--------------------+-------+
| Variable_name      | Value |
+--------------------+-------+
| wsrep_cluster_size | 3     |
+--------------------+-------+
1 row<span style="color: #a020f0;"> in</span> set (0.001 sec)

MariaDB [(none)]&gt; SHOW VARIABLES LIKE <span style="color: #8b2252;">'wsrep_%'</span>\G
MariaDB [(none)]&gt; SHOW STATUS LIKE <span style="color: #8b2252;">'wsrep_%'</span>;
</pre>
</div>

<p>
范例： <b>CentOS 7 实现 MariaDB Galera Cluster 5.5</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#32771;&#20179;&#24211;&#65306;https://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadb-5.5.X/yum/centos7-amd64/</span>
yum install MariaDB-Galera-server
vim /etc/my.cnf.d/server.cnf
[galera]
wsrep_provider = /usr/lib64/galera/libgalera_smm.so
<span style="color: #a0522d;">wsrep_cluster_address</span>=<span style="color: #8b2252;">"gcomm://10.0.0.7,10.0.0.17,10.0.0.27"</span>
<span style="color: #a0522d;">binlog_format</span>=row
<span style="color: #a0522d;">default_storage_engine</span>=InnoDB
<span style="color: #a0522d;">innodb_autoinc_lock_mode</span>=2
bind-address=0.0.0.0
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#38754;&#37197;&#32622;&#21487;&#36873;&#39033;</span>
wsrep_cluster_name = <span style="color: #8b2252;">'mycluster'</span> &#40664;&#35748;my_wsrep_cluster
wsrep_node_name = <span style="color: #8b2252;">'node1'</span>
wsrep_node_address = <span style="color: #8b2252;">'10.0.0.7'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39318;&#27425;&#21551;&#21160;&#26102;&#65292;&#38656;&#35201;&#21021;&#22987;&#21270;&#38598;&#32676;&#65292;&#22312;&#20854;&#20013;&#19968;&#20010;&#33410;&#28857;&#19978;&#25191;&#34892;&#21629;&#20196;</span>
/etc/init.d/mysql start --wsrep-new-cluster
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32780;&#21518;&#27491;&#24120;&#21551;&#21160;&#20854;&#23427;&#33410;&#28857;</span>
service mysql start
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#38598;&#32676;&#20013;&#30456;&#20851;&#31995;&#32479;&#21464;&#37327;&#21644;&#29366;&#24577;&#21464;&#37327;</span>
SHOW VARIABLES LIKE <span style="color: #8b2252;">'wsrep_%'</span>;
SHOW STATUS LIKE <span style="color: #8b2252;">'wsrep_%'</span>;
SHOW STATUS LIKE <span style="color: #8b2252;">'wsrep_cluster_size'</span>;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:5da7b53d-e331-4b3b-9fc0-56cfd2b86670" class="outline-4">
<h4 id="h:5da7b53d-e331-4b3b-9fc0-56cfd2b86670">TiDB概述</h4>
<div class="outline-text-4" id="text-h:5da7b53d-e331-4b3b-9fc0-56cfd2b86670">
<p>
TiDB 是 PingCAP 公司受 Google Spanner / F1 论文启发而设计的开源分布式
HTAP (Hybrid Transactional and Analytical Processing)数据库，结合了传
统的 RDBMS 和NoSQL 的最佳特性。
</p>

<p>
TiDB 兼容MySQL，支持无限的水平扩展，具备强一致性和高可用性。TiDB和
mysql几乎完全兼容
</p>

<p>
TiDB 是一个分布式 NewSQL 数据库。它支持水平弹性扩展、ACID 事务、标准
SQL、MySQL 语法和MySQL 协议，具有数据强一致的高可用特性，是一个不仅适
合OLTP 场景还适合 OLAP 场景的混合数据库。
</p>

<p>
TiDB 的目标是为 OLTP(Online Transactional Processing) 和 OLAP (Online
Analytical Processing) 场景提供一站式的解决方案。
</p>
</div>
<div id="outline-container-h:baec973e-904f-45c0-904b-d73c90a85ddb" class="outline-5">
<h5 id="h:baec973e-904f-45c0-904b-d73c90a85ddb">核心特点</h5>
<div class="outline-text-5" id="text-h:baec973e-904f-45c0-904b-d73c90a85ddb">
<ol class="org-ol">
<li>高度兼容 MySQL 大多数情况下，无需修改代码即可从 MySQL 轻松迁移至
TiDB，分库分表后的MySQL 集群亦可通过 TiDB 工具进行实时迁移</li>

<li>水平弹性扩展 通过简单地增加新节点即可实现 TiDB
的水平扩展，按需扩展吞吐或存储，轻松应对高并发、海量数据场景</li>

<li>分布式事务 TiDB 100% 支持标准的 ACID 事务</li>

<li>真正金融级高可用 相比于传统主从 (M-S) 复制方案，基于 Raft
的多数派选举协议可以提供金融级的 100%
数据强一致性保证，且在不丢失大多数副本的前提下，可实现故障的自动恢复
(autofailover)，无需人工介入</li>

<li>一站式 HTAP 解决方案 TiDB 作为典型的 OLTP 行存数据库，同时兼具强大的
OLAP 性能，配合TiSpark，可提供一站式
HTAP解决方案，一份存储同时处理OLTP &amp; OLAP(OLAP、OLTP的介绍和比较
)无需传统繁琐的 ETL 过程</li>

<li>云原生 SQL 数据库 TiDB 是为云而设计的数据库，同 Kubernetes
深度耦合，支持公有云、私有云和混合云，使部署、配置和维护变得十分简单。
TiDB 的设计目标是 100% 的 OLTP 场景和80% 的 OLAP 场景，更复杂的 OLAP
分析可以通过 TiSpark 项目来完成。 TiDB
对业务没有任何侵入性，能优雅的替换传统的数据库中间件、数据库分库分表等
Sharding 方案。同时它也让开发运维人员不用关注数据库 Scale
的细节问题，专注于业务开发，极大的提升研发的生产力</li>
</ol>
</div>
</div>
<div id="outline-container-h:526de852-4b26-48c4-9c7a-dd47f559f915" class="outline-5">
<h5 id="h:526de852-4b26-48c4-9c7a-dd47f559f915">TiDB整体架构</h5>
<div class="outline-text-5" id="text-h:526de852-4b26-48c4-9c7a-dd47f559f915">
<p width="60%">
<img src="./images/20200705115805463.png" alt="20200705115805463.png" width="60%">
<b>TiDB Server</b>
</p>

<p>
TiDB Server负责接收SQL请求，处理SQL相关的逻辑，并通过PD找到存储计算所
需数据的TiKV地址，与TiKV交互获取数据，最终返回结果。TiDB Server是无状
态的，其本身并不存储数据，只负责计算，可以无限水平扩展，可以通过负载均
衡组件（LVS、HAProxy或F5）对外提供统一的接入地址。
</p>

<p>
<b>PD Server</b>
</p>

<p>
Placement Driver（简称PD）是整个集群的管理模块，其主要工作有三个：一是
存储集群的元信息（某个Key存储在那个TiKV节点）；二是对TiKV集群进行调度
和负载均衡（如数据的迁移、Raft groupleader的迁移等）；三是分配全局唯一
且递增的事务ID
</p>

<p>
PD是一个集群，需要部署奇数个节点，一般线上推荐至少部署3个节点。PD在选
举的过程中无法对外提供服务，这个时间大约是3秒
</p>

<p>
<b>TiKV Server</b>
</p>

<p>
TiKV Server负责存储数据，从外部看TiKV是一个分布式的提供事务的Key-Value
存储引擎。存储数据的基本单位是Region，每个Region负责存储一个Key Range
（从StartKey到EndKey的左闭右开区间）的数据，每个TiKV节点会负责多个
Region。TiKV使用Raft协议做复制，保持数据的一致性和容灾。副本以Region为
单位进行管理，不同节点上的多个Region构成一个Raft Group，互为副本。数据
在多个TiKV之间的负载均衡由PD调度，这里也就是以Region为单位进行调度
</p>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:2095ad92-531c-43e6-ade8-c897a6933f13" class="outline-2">
<h2 id="h:2095ad92-531c-43e6-ade8-c897a6933f13">性能优化</h2>
<div class="outline-text-2" id="text-h:2095ad92-531c-43e6-ade8-c897a6933f13">
<p>
数据库服务衡量指标：
</p>

<ul class="org-ul">
<li>Qps：query per second</li>
<li>Tps：transaction per second</li>
</ul>
</div>
<div id="outline-container-h:b0c9cd34-5da5-4002-81e3-2e49b72252fc" class="outline-3">
<h3 id="h:b0c9cd34-5da5-4002-81e3-2e49b72252fc">压力测试工具</h3>
<div class="outline-text-3" id="text-h:b0c9cd34-5da5-4002-81e3-2e49b72252fc">
</div>
<div id="outline-container-h:bec493ed-c80c-4b98-97df-49db1a0bcbf7" class="outline-4">
<h4 id="h:bec493ed-c80c-4b98-97df-49db1a0bcbf7">常见MySQl压力测试工具</h4>
<div class="outline-text-4" id="text-h:bec493ed-c80c-4b98-97df-49db1a0bcbf7">
<ul class="org-ul">
<li>mysqlslap</li>
<li>Sysbench：功能强大，官网： <a href="https://github.com/akopytov/sysbench">https://github.com/akopytov/sysbench</a></li>
<li>tpcc-mysql</li>
<li>MySQL Benchmark Suite</li>
<li>MySQL super-smack</li>
<li>MyBench</li>
</ul>
</div>
</div>
<div id="outline-container-h:044ca7ee-78aa-4721-b1bd-7dfa88809954" class="outline-4">
<h4 id="h:044ca7ee-78aa-4721-b1bd-7dfa88809954">mysqlslap</h4>
<div class="outline-text-4" id="text-h:044ca7ee-78aa-4721-b1bd-7dfa88809954">
<p>
mysqlslap：来自于mariadb包，测试的过程默认生成一个mysqlslap的schema,生
成测试表t1，查询和插入测试数据，mysqlslap库自动生成，如果已经存在则先
删除。用&#x2013;only-print来打印实际的测试过程，整个测试完成后不会在数据库中
留下痕迹
</p>

<p>
使用格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">mysqlslap [options]
</pre>
</div>

<p>
*常用参数 [options] 说明*：
</p>

<div class="org-src-container">
<pre class="src src-sh">--auto-generate-sql, -a <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#21160;&#29983;&#25104;&#27979;&#35797;&#34920;&#21644;&#25968;&#25454;&#65292;&#34920;&#31034;&#29992;mysqlslap&#24037;&#20855;&#33258;&#24049;&#29983;&#25104;&#30340;SQL&#33050;&#26412;&#26469;&#27979;&#35797;&#24182;&#21457;&#21387;&#21147;</span>
--auto-generate-sql-load-type=type <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;&#35821;&#21477;&#30340;&#31867;&#22411;&#12290;&#20195;&#34920;&#35201;&#27979;&#35797;&#30340;&#29615;&#22659;&#26159;&#35835;&#25805;&#20316;&#36824;&#26159;&#20889;&#25805;&#20316;&#36824;&#26159;&#20004;&#32773;&#28151;&#21512;&#30340;&#12290;&#21462;&#20540;&#21253;&#25324;&#65306;read&#65292;key&#65292;write&#65292;update&#21644;mixed(&#40664;&#35748;)</span>
--auto-generate-sql-add-auto-increment <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20195;&#34920;&#23545;&#29983;&#25104;&#30340;&#34920;&#33258;&#21160;&#28155;&#21152;auto_increment&#21015;&#65292;&#20174;5.1.18&#29256;&#26412;&#24320;&#22987;&#25903;&#25345;</span>
--number-char-cols=N, -x N <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#21160;&#29983;&#25104;&#30340;&#27979;&#35797;&#34920;&#20013;&#21253;&#21547;&#22810;&#23569;&#20010;&#23383;&#31526;&#31867;&#22411;&#30340;&#21015;&#65292;&#40664;&#35748;1</span>
--number-int-cols=N, -y N <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#21160;&#29983;&#25104;&#30340;&#27979;&#35797;&#34920;&#20013;&#21253;&#21547;&#22810;&#23569;&#20010;&#25968;&#23383;&#31867;&#22411;&#30340;&#21015;&#65292;&#40664;&#35748;1</span>
--number-of-queries=N <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24635;&#30340;&#27979;&#35797;&#26597;&#35810;&#27425;&#25968;(&#24182;&#21457;&#23458;&#25143;&#25968;&#215;&#27599;&#23458;&#25143;&#26597;&#35810;&#27425;&#25968;)</span>
--query=name,-q <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#33258;&#23450;&#20041;&#33050;&#26412;&#25191;&#34892;&#27979;&#35797;&#65292;&#20363;&#22914;&#21487;&#20197;&#35843;&#29992;&#33258;&#23450;&#20041;&#30340;&#23384;&#20648;&#36807;&#31243;&#25110;&#32773;sql&#35821;&#21477;&#26469;&#25191;&#34892;&#27979;&#35797;</span>
--create-schema <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20195;&#34920;&#33258;&#23450;&#20041;&#30340;&#27979;&#35797;&#24211;&#21517;&#31216;&#65292;&#27979;&#35797;&#30340;schema</span>
--commint=N <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#23569;&#26465;DML&#21518;&#25552;&#20132;&#19968;&#27425;</span>
--compress, -C <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26381;&#21153;&#22120;&#21644;&#23458;&#25143;&#31471;&#37117;&#25903;&#25345;&#21387;&#32553;&#65292;&#21017;&#21387;&#32553;&#20449;&#24687;</span>
--concurrency=N, -c N <span style="color: #b22222;">#</span><span style="color: #b22222;">&#34920;&#31034;&#24182;&#21457;&#37327;&#65292;&#21363;&#27169;&#25311;&#22810;&#23569;&#20010;&#23458;&#25143;&#31471;&#21516;&#26102;&#25191;&#34892;select&#12290;&#21487;&#25351;&#23450;&#22810;&#20010;&#20540;&#65292;&#20197;&#36887;&#21495;&#25110;&#32773;--delimiter&#21442;&#25968;&#25351;&#23450;&#20540;&#20570;&#20026;&#20998;&#38548;&#31526;,&#22914;&#65306;--concurrency=100,200,500</span>
--engine=engine_name, -e engine_name <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20195;&#34920;&#35201;&#27979;&#35797;&#30340;&#24341;&#25806;&#65292;&#21487;&#20197;&#26377;&#22810;&#20010;&#65292;&#29992;&#20998;&#38548;&#31526;&#38548;&#24320;&#12290;&#20363;&#22914;&#65306;--engines=myisam,innodb</span>
--iterations=N, -i N <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;&#25191;&#34892;&#30340;&#36845;&#20195;&#27425;&#25968;&#65292;&#20195;&#34920;&#35201;&#22312;&#19981;&#21516;&#24182;&#21457;&#29615;&#22659;&#19979;&#65292;&#21508;&#33258;&#36816;&#34892;&#27979;&#35797;&#22810;&#23569;&#27425;</span>
--only-print <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#25171;&#21360;&#27979;&#35797;&#35821;&#21477;&#32780;&#19981;&#23454;&#38469;&#25191;&#34892;&#12290;</span>
--detach=N <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;N&#26465;&#35821;&#21477;&#21518;&#26029;&#24320;&#37325;&#36830;</span>
--debug-info, -T <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25171;&#21360;&#20869;&#23384;&#21644;CPU&#30340;&#30456;&#20851;&#20449;&#24687;</span>
</pre>
</div>

<p>
<b>mysqlslap示例</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21333;&#32447;&#31243;&#27979;&#35797;</span>
mysqlslap -a -uroot -pxxx
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#32447;&#31243;&#27979;&#35797;&#12290;&#20351;&#29992;--concurrency&#26469;&#27169;&#25311;&#24182;&#21457;&#36830;&#25509;</span>
mysqlslap -a -c 100 -uroot -pxxx
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36845;&#20195;&#27979;&#35797;&#12290;&#29992;&#20110;&#38656;&#35201;&#22810;&#27425;&#25191;&#34892;&#27979;&#35797;&#24471;&#21040;&#24179;&#22343;&#20540;</span>
mysqlslap -a -i 10 -uroot -pxxx
mysqlslap ---auto-generate-sql-add-autoincrement -a
mysqlslap -a --auto-generate-sql-load-type=read
mysqlslap -a --auto-generate-secondary-indexes=3
mysqlslap -a --auto-generate-sql-write-number=1000
mysqlslap --create-schema world -q <span style="color: #8b2252;">"select count(*) from City&#8221;</span>
<span style="color: #8b2252;">mysqlslap -a -e innodb -uroot -pxxx</span>
<span style="color: #8b2252;">mysqlslap -a --number-of-queries=10 -uroot -pxxx</span>
<span style="color: #8b2252;">#&#27979;&#35797;&#21516;&#26102;&#19981;&#21516;&#30340;&#23384;&#20648;&#24341;&#25806;&#30340;&#24615;&#33021;&#36827;&#34892;&#23545;&#27604;</span>
<span style="color: #8b2252;">mysqlslap -a --concurrency=50,100 --number-of-queries 1000 --iterations=5 --engine=myisam,innodb --debug-info -uroot -pxxx</span>
<span style="color: #8b2252;">#&#25191;&#34892;&#19968;&#27425;&#27979;&#35797;&#65292;&#20998;&#21035;50&#21644;100&#20010;&#24182;&#21457;&#65292;&#25191;&#34892;1000&#27425;&#24635;&#26597;&#35810;</span>
<span style="color: #8b2252;">mysqlslap -a --concurrency=50,100 --number-of-queries 1000 --debug-info -uroot -pxxx</span>
<span style="color: #8b2252;">#50&#21644;100&#20010;&#24182;&#21457;&#20998;&#21035;&#24471;&#21040;&#19968;&#27425;&#27979;&#35797;&#32467;&#26524;(Benchmark)&#65292;&#24182;&#21457;&#25968;&#36234;&#22810;&#65292;&#25191;&#34892;&#23436;&#25152;&#26377;&#26597;&#35810;&#30340;&#26102;&#38388;&#36234;&#38271;&#12290;&#20026;&#20102;&#20934;&#30830;&#36215;&#35265;&#65292;&#21487;&#20197;&#22810;&#36845;&#20195;&#27979;&#35797;&#20960;&#27425;</span>
<span style="color: #8b2252;">mysqlslap -a --concurrency=50,100 --number-of-queries 1000 --iterations=5 --debug-info -uroot -pxxx</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:306deea3-ed8c-4b0a-816e-35d8f4fd3c42" class="outline-3">
<h3 id="h:306deea3-ed8c-4b0a-816e-35d8f4fd3c42">生产环境 my.cnf 配置案例</h3>
<div class="outline-text-3" id="text-h:306deea3-ed8c-4b0a-816e-35d8f4fd3c42">
<p>
配置文件生成工具参考链接：<a href="https://imysql.com/my_cnf_generator">https://imysql.com/my_cnf_generator</a>
</p>

<p>
参考硬件：内存32G
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25171;&#24320;&#29420;&#31435;&#34920;&#31354;&#38388;</span>
innodb_file_per_table = 1
<span style="color: #b22222;">#</span><span style="color: #b22222;">MySQL &#26381;&#21153;&#25152;&#20801;&#35768;&#30340;&#21516;&#26102;&#20250;&#35805;&#25968;&#30340;&#19978;&#38480;&#65292;&#32463;&#24120;&#20986;&#29616;Too Many Connections&#30340;&#38169;&#35823;&#25552;&#31034;&#65292;&#21017;&#38656;&#35201;&#22686;&#22823;&#27492;&#20540;</span>
max_connections = 8000
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#32447;&#31243;&#25152;&#25171;&#24320;&#34920;&#30340;&#25968;&#37327;</span>
open_files_limit = 10240
<span style="color: #b22222;">#</span><span style="color: #b22222;">back_log &#26159;&#25805;&#20316;&#31995;&#32479;&#22312;&#30417;&#21548;&#38431;&#21015;&#20013;&#25152;&#33021;&#20445;&#25345;&#30340;&#36830;&#25509;&#25968;</span>
back_log = 300
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#20010;&#23458;&#25143;&#31471;&#36830;&#25509;&#26368;&#22823;&#30340;&#38169;&#35823;&#20801;&#35768;&#25968;&#37327;&#65292;&#24403;&#36229;&#36807;&#35813;&#27425;&#25968;&#65292;MYSQL&#26381;&#21153;&#22120;&#23558;&#31105;&#27490;&#27492;&#20027;&#26426;&#30340;&#36830;&#25509;&#35831;&#27714;&#65292;&#30452;&#21040;MYSQL&#26381;&#21153;&#22120;&#37325;&#21551;&#25110;&#36890;&#36807;flush hosts&#21629;&#20196;&#28165;&#31354;&#27492;&#20027;&#26426;&#30340;&#30456;&#20851;&#20449;&#24687;</span>
max_connect_errors = 1000
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#20010;&#36830;&#25509;&#20256;&#36755;&#25968;&#25454;&#22823;&#23567;.&#26368;&#22823;1G&#65292;&#39035;&#26159;1024&#30340;&#20493;&#25968;&#65292;&#19968;&#33324;&#35774;&#20026;&#26368;&#22823;&#30340;BLOB&#30340;&#20540;</span>
max_allowed_packet = 32M
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#19968;&#20010;&#35831;&#27714;&#30340;&#26368;&#22823;&#36830;&#25509;&#26102;&#38388;</span>
wait_timeout = 10
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25490;&#24207;&#32531;&#20914;&#34987;&#29992;&#26469;&#22788;&#29702;&#31867;&#20284;ORDER BY&#20197;&#21450;GROUP BY&#38431;&#21015;&#25152;&#24341;&#36215;&#30340;&#25490;&#24207;</span>
sort_buffer_size = 16M
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#24102;&#32034;&#24341;&#30340;&#20840;&#34920;&#25195;&#25551;.&#20351;&#29992;&#30340;buffer&#30340;&#26368;&#23567;&#20540;</span>
join_buffer_size = 16M
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#32531;&#20914;&#22823;&#23567;</span>
query_cache_size = 128M
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#21333;&#20010;&#26597;&#35810;&#33021;&#22815;&#20351;&#29992;&#30340;&#32531;&#20914;&#21306;&#22823;&#23567;&#65292;&#32570;&#30465;&#20026;1M</span>
query_cache_limit = 4M
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#23450;&#40664;&#35748;&#30340;&#20107;&#21153;&#38548;&#31163;&#32423;&#21035;</span>
transaction_isolation = REPEATABLE-READ
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32447;&#31243;&#20351;&#29992;&#30340;&#22534;&#22823;&#23567;. &#27492;&#20540;&#38480;&#21046;&#20869;&#23384;&#20013;&#33021;&#22788;&#29702;&#30340;&#23384;&#20648;&#36807;&#31243;&#30340;&#36882;&#24402;&#28145;&#24230;&#21644;SQL&#35821;&#21477;&#22797;&#26434;&#24615;&#65292;&#27492;&#23481;&#37327;&#30340;&#20869;&#23384;&#22312;&#27599;&#27425;&#36830;&#25509;&#26102;&#34987;&#39044;&#30041;.</span>
thread_stack = 512K
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20108;&#36827;&#21046;&#26085;&#24535;&#21151;&#33021;</span>
log-bin=/data/mysqlbinlogs/
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20108;&#36827;&#21046;&#26085;&#24535;&#26684;&#24335;</span>
<span style="color: #a0522d;">binlog_format</span>=row
<span style="color: #b22222;">#</span><span style="color: #b22222;">InnoDB&#20351;&#29992;&#19968;&#20010;&#32531;&#20914;&#27744;&#26469;&#20445;&#23384;&#32034;&#24341;&#21644;&#21407;&#22987;&#25968;&#25454;, &#21487;&#35774;&#32622;&#36825;&#20010;&#21464;&#37327;&#21040;&#29289;&#29702;&#20869;&#23384;&#22823;&#23567;&#30340;80%</span>
innodb_buffer_pool_size = 24G
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#26469;&#21516;&#27493;IO&#25805;&#20316;&#30340;IO&#32447;&#31243;&#30340;&#25968;&#37327;</span>
innodb_file_io_threads = 4
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;InnoDb&#26680;&#24515;&#20869;&#30340;&#20801;&#35768;&#32447;&#31243;&#25968;&#37327;&#65292;&#24314;&#35758;&#30340;&#35774;&#32622;&#26159;CPU&#25968;&#37327;&#21152;&#19978;&#30913;&#30424;&#25968;&#37327;&#30340;&#20004;&#20493;</span>
innodb_thread_concurrency = 16
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#26469;&#32531;&#20914;&#26085;&#24535;&#25968;&#25454;&#30340;&#32531;&#20914;&#21306;&#30340;&#22823;&#23567;</span>
innodb_log_buffer_size = 16M
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#26085;&#24535;&#32452;&#20013;&#27599;&#20010;&#26085;&#24535;&#25991;&#20214;&#30340;&#22823;&#23567;</span>
innodb_log_file_size = 512M
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#26085;&#24535;&#32452;&#20013;&#30340;&#25991;&#20214;&#24635;&#25968;</span>
innodb_log_files_in_group = 3
<span style="color: #b22222;">#</span><span style="color: #b22222;">SQL&#35821;&#21477;&#22312;&#34987;&#22238;&#28378;&#21069;,InnoDB&#20107;&#21153;&#31561;&#24453;InnoDB&#34892;&#38145;&#30340;&#26102;&#38388;</span>
innodb_lock_wait_timeout = 120
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24930;&#26597;&#35810;&#26102;&#38271;</span>
long_query_time = 2
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#27809;&#26377;&#20351;&#29992;&#32034;&#24341;&#30340;&#26597;&#35810;&#20063;&#35760;&#24405;&#19979;&#26469;</span>
log-queries-not-using-indexes
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1443fc58-3fba-48b3-a120-ebba311c3f5a" class="outline-3">
<h3 id="h:1443fc58-3fba-48b3-a120-ebba311c3f5a">MySQL配置最佳实践</h3>
<div class="outline-text-3" id="text-h:1443fc58-3fba-48b3-a120-ebba311c3f5a">
<p>
高并发大数据的互联网业务，架构设计思路是“解放数据库CPU，将计算转移到
服务层”，并发量大的情况下，这些功能很可能将数据库拖死，业务逻辑放到服
务层具备更好的扩展性，能够轻易实现“增机器就加性能”
</p>

<p>
参考资料：
</p>

<ul class="org-ul">
<li>阿里巴巴Java开发手册：<a href="https://developer.aliyun.com/topic/java2020">https://developer.aliyun.com/topic/java2020</a></li>
<li>58到家数据库30条军规解读：<a href="http://zhuanlan.51cto.com/art/201702/531364.htm">http://zhuanlan.51cto.com/art/201702/531364.htm</a></li>
</ul>

<p>
以下规范适用场景：并发量大、数据量大的互联网业务
</p>
</div>
<div id="outline-container-h:d701fdd6-7527-46da-81be-9d98bebd08a5" class="outline-4">
<h4 id="h:d701fdd6-7527-46da-81be-9d98bebd08a5">基础规范</h4>
<div class="outline-text-4" id="text-h:d701fdd6-7527-46da-81be-9d98bebd08a5">
<p>
(1)必须使用InnoDB存储引擎
</p>

<p>
解读：支持事务、行级锁、并发性能更好、CPU及内存缓存页优化使得资源利用率更高
</p>

<p>
(2)使用UTF8MB4字符集
</p>

<p>
解读：万国码，无需转码，无乱码风险，节省空间，支持表情包及生僻字
</p>

<p>
(3)数据表、数据字段必须加入中文注释
</p>

<p>
解读：N年后谁知道这个r1,r2,r3字段是干嘛的
</p>

<p>
(4)禁止使用存储过程、视图、触发器、Event
</p>

<p>
解读：高并发大数据的互联网业务，架构设计思路是“解放数据库CPU，将计算
转移到服务层”，并发量大的情况下，这些功能很可能将数据库拖死，业务逻辑
放到服务层具备更好的扩展性，能够轻易实现“增机器就加性能”。数据库擅长
存储与索引，CPU计算还是上移吧！
</p>

<p>
(5)禁止存储大文件或者大照片
</p>

<p>
解读：为何要让数据库做它不擅长的事情?大文件和照片存储在文件系统，数据库里存URI多好。
</p>
</div>
</div>
<div id="outline-container-h:b26a9d77-8d02-489f-b0ea-e2dca201d4eb" class="outline-4">
<h4 id="h:b26a9d77-8d02-489f-b0ea-e2dca201d4eb">命名规范</h4>
<div class="outline-text-4" id="text-h:b26a9d77-8d02-489f-b0ea-e2dca201d4eb">
<p>
(6)只允许使用内网域名，而不是ip连接数据库
</p>

<p>
(7)线上环境、开发环境、测试环境数据库内网域名遵循命名规范
</p>

<p>
业务名称：xxx
线上环境：xxx.db
开发环境：xxx.rdb
测试环境：xxx.tdb
从库在名称后加-s标识，备库在名称后加-ss标识
线上从库：xxx-s.db
线上备库：xxx-sss.db
</p>

<p>
(8)库名、表名、字段名：小写，下划线风格，不超过32个字符，必须见名知意，禁止拼音英文混用
</p>

<p>
(9)库名与应用名称尽量一致，表名:t_业务名称_表的作用，主键名:pk_xxx，非唯一索引名:idx_xxx，唯一键索引名:uk_xxx
</p>
</div>
</div>
<div id="outline-container-h:e8abfc26-77c9-44aa-8cf7-410bfab5bb25" class="outline-4">
<h4 id="h:e8abfc26-77c9-44aa-8cf7-410bfab5bb25">表设计规范</h4>
<div class="outline-text-4" id="text-h:e8abfc26-77c9-44aa-8cf7-410bfab5bb25">
<p>
(10)单实例表数目必须小于500
单表行数超过500万行或者单表容量超过2GB，才推荐进行分库分表。
</p>

<p>
说明：如果预计三年后的数据量根本达不到这个级别，请不要在创建表时就分库分表
</p>

<p>
(11)单表列数目必须小于30
</p>

<p>
(12)表必须有主键，例如自增主键
</p>

<p>
解读：
</p>

<p>
a)主键递增，数据行写入可以提高插入性能，可以避免page分裂，减少表碎片提升空间和内存的使用
</p>

<p>
b)主键要选择较短的数据类型，Innodb引擎普通索引都会保存主键的值，较短的
数据类型可以有效的减少索引的磁盘空间，提高索引的缓存效率
</p>

<p>
c) 无主键的表删除，在row模式的主从架构，会导致备库夯住
</p>

<p>
(13)禁止使用外键，如果有外键完整性约束，需要应用程序控制
</p>

<p>
解读：外键会导致表与表之间耦合，update与delete操作都会涉及相关联的表，十分影响sql
的性能，甚至会造成死锁。高并发情况下容易造成数据库性能，大数据高并发业务场景数据库使用以性能优先
</p>
</div>
</div>
<div id="outline-container-h:14b17690-5a59-41c0-aaf7-9892a52859eb" class="outline-4">
<h4 id="h:14b17690-5a59-41c0-aaf7-9892a52859eb">字段设计规范</h4>
<div class="outline-text-4" id="text-h:14b17690-5a59-41c0-aaf7-9892a52859eb">
<p>
(14)必须把字段定义为NOT NULL并且提供默认值
</p>

<p>
解读：
</p>

<p>
a)null的列使索引/索引统计/值比较都更加复杂，对MySQL来说更难优化
</p>

<p>
b)null
这种类型MySQL内部需要进行特殊处理，增加数据库处理记录的复杂性;同等条件下，表中有较多空字段的时候，数据库的处理性能会降低很多
</p>

<p>
c)null值需要更多的存储空，无论是表还是索引中每行中的null的列都需要额外的空间来标识
</p>

<p>
d)对null 的处理时候，只能采用is null或is not
null，而不能采用=、in、&lt;、&lt;&gt;、!=、not in这些操作符号。如：where
name!='shenjian'，如果存在name为null值的记录，查询结果就不会包含name为null值的记录
</p>

<p>
(15)禁止使用TEXT、BLOB类型
</p>

<p>
解读：会浪费更多的磁盘和内存空间，非必要的大量的大字段查询会淘汰掉热数据，导致内存命中率急剧降低，影响数据库性能
</p>

<p>
(16)禁止使用小数存储货币
</p>

<p>
解读：使用整数吧，小数容易导致钱对不上
</p>

<p>
(17)必须使用varchar(20)存储手机号
</p>

<p>
解读：
</p>

<p>
a)涉及到区号或者国家代号，可能出现±()
b)手机号会去做数学运算么?
c)varchar可以支持模糊查询，例如：like“138%”
</p>

<p>
(18)禁止使用ENUM，可使用TINYINT代替
</p>

<p>
解读：
</p>

<p>
a)增加新的ENUM值要做DDL操作
b)ENUM的内部实际存储就是整数，你以为自己定义的是字符串?
</p>
</div>
</div>
<div id="outline-container-h:63a6c8d5-b903-4b18-81c9-23e55ae1b98a" class="outline-4">
<h4 id="h:63a6c8d5-b903-4b18-81c9-23e55ae1b98a">索引设计规范</h4>
<div class="outline-text-4" id="text-h:63a6c8d5-b903-4b18-81c9-23e55ae1b98a">
<p>
(19)单表索引建议控制在5个以内
</p>

<p>
(20)单索引字段数不允许超过5个
</p>

<p>
解读：字段超过5个时，实际已经起不到有效过滤数据的作用了
</p>

<p>
(21)禁止在更新十分频繁、区分度不高的属性上建立索引
</p>

<p>
解读：
</p>

<p>
a)更新会变更B+树，更新频繁的字段建立索引会大大降低数据库性能
b)"性别"这种区分度不大的属性，建立索引是没有什么意义的，不能有效过滤数据，性能与全表扫描类似
</p>

<p>
(22)建立组合索引，必须把区分度高的字段放在前面
解读：能够更加有效的过滤数据
</p>
</div>
</div>
<div id="outline-container-h:bfb142a4-990b-4b4e-998a-4871bb204729" class="outline-4">
<h4 id="h:bfb142a4-990b-4b4e-998a-4871bb204729">SQL使用规范</h4>
<div class="outline-text-4" id="text-h:bfb142a4-990b-4b4e-998a-4871bb204729">
<p>
(23)禁止使用SELECT *，只获取必要的字段，需要显示说明列属性
</p>

<p>
解读：
</p>

<p>
a)读取不需要的列会增加CPU、IO、NET消耗
b)不能有效的利用覆盖索引
c)使用SELECT *容易在增加或者删除字段后出现程序BUG
</p>

<p>
(24)禁止使用INSERT INTO t_xxx VALUES(xxx)，必须显示指定插入的列属性
</p>

<p>
解读：容易在增加或者删除字段后出现程序BUG
</p>

<p>
(25)禁止使用属性隐式转换
</p>

<p>
解读：SELECT uid FROM t_user WHERE phone=13812345678
会导致全表扫描，而不能命中phone索引，猜猜为什么?(这个线上问题不止出现过一次)
</p>

<p>
(26)禁止在WHERE条件的属性上使用函数或者表达式
</p>

<p>
解读：SELECT uid FROM t_user WHERE
from_unixt/title:ime(day)&gt;='2017-02-15' 会导致全表扫描
正确的写法是：SELECT uid FROM t_user WHERE day&gt;=
unix_timestamp('2017-02-15 00:00:00')
</p>

<p>
(27)禁止负向查询，以及%开头的模糊查询
</p>

<p>
解读：
a)负向查询条件：NOT、!=、&lt;&gt;、!&lt;、!&gt;、NOT IN、NOT
LIKE等，会导致全表扫描
b)%开头的模糊查询，会导致全表扫描
</p>

<p>
(28)禁止大表使用JOIN查询，禁止大表使用子查询
</p>

<p>
解读：会产生临时表，消耗较多内存与CPU，极大影响数据库性能
</p>

<p>
(29)禁止使用OR条件，必须改为IN查询
</p>

<p>
解读：旧版本Mysql的OR查询是不能命中索引的，即使能命中索引，为何要让数据库耗费更多的CPU帮助实施查询优化呢?
</p>

<p>
(30)应用程序必须捕获SQL异常，并有相应处理
</p>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
