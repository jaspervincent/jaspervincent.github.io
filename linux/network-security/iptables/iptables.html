<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: Linux é˜²ç«å¢™</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/font.css"/>
<link rel="stylesheet" type="text/css" href="/static/drollery.e825b870.css"/>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
</head>
<body>
<header id="preamble" class="status">
<header class="{className}" data-astro-cid-3ef6ksr2>
  <div class=header-branding data-astro-cid-g2lrb5xm>
      <span class=header-text data-astro-cid-g2lrb5xm>
          <span class=dropcap data-astro-cid-g2lrb5xm aria-hidden=true>
              <span class=actual data-astro-cid-g2lrb5xm>J</span>
              <span class=rest data-astro-cid-g2lrb5xm>asper Hsu</span>
              <span class=period data-astro-cid-g2lrb5xm>.</span>
          </span>
          <span class=sr-only data-astro-cid-g2lrb5xm>Drollery</span>
      </span>
      <img alt="Medieval drollery of a knight on a horse" class=spring decoding=async height=250 loading=lazy src=/images/knight-horse.a96eee7d_Z1WCOYs.webp width=68 data-astro-cid-g2lrb5xm>
  </div>

  <nav data-astro-cid-pux6a34n>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/jcodelog.html class=nobracket data-astro-cid-pux6a34n>æŠ€æœ¯</a>
      <span class=flower2 data-astro-cid-pux6a34n>K</span>
      <a href=/reading/index.html class=nobracket data-astro-cid-pux6a34n>é˜…è¯»</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
      <a href=/lisp/jasper-emacs.html class=nobracket data-astro-cid-pux6a34n>æˆ‘çš„Emacsé…ç½®</a>
      <span class=flower2 data-astro-cid-pux6a34n>L</span>
      <a href=/link/index.html class=nobracket data-astro-cid-pux6a34n>å‹é“¾</a>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/about.html class=nobracket data-astro-cid-pux6a34n>å…³äº</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
  </nav>


  <div class="container" data-astro-cid-3ef6ksr2>
    <p class="info" data-astro-cid-3ef6ksr2>
              ğŸ† æ¬¢è¿æ¥åˆ°æœ¬ç«™ï¼š
              <a href="https://xuchangwei.com/">https://xuchangwei.com/</a>ã€‚
              <strong>å¸Œæœ›è¿™é‡Œæœ‰ä½ æ„Ÿå…´è¶£çš„å†…å®¹</strong>ã€‚
            </p>
  </div>
  <div id=borderArtWrapper class="tt1" data-astro-cid-5hce7sga data-turbo-permanent>
      <script>
          var man, shakeCount = 0, noSound = new Audio("/audio/effects/no.m4a"), screamSound = new Audio("/audio/effects/scream.m4a");
          function animateManShakeHandler() {
              man.removeEventListener("animationend", animateManShakeHandler, !1),
              shakeCount += 1,
              man.classList.remove("shakeMan")
          }
          function animateManFallHandler() {
              man.removeEventListener("animationend", animateManFallHandler, !1),
              man.classList.add("hide")
          }
          function animateMan() {
              man = man ?? document.getElementById("borderMan"),
              3 === shakeCount ? (man.classList.add("fallMan"),
              screamSound.play(),
              man.addEventListener("animationend", animateManFallHandler, !1)) : (man.classList.add("shakeMan"),
              noSound.play(),
              man.addEventListener("animationend", animateManShakeHandler, !1))
          }
      </script>
      <div class=borderArt data-astro-cid-5dda5nwp id=articleBorder>
          <img alt="flowery border with man falling" decoding=async height=620 loading=lazy src=/images/border-vines-no-man.b7d246cc_DRxSe.webp width=909 class=border data-astro-cid-5dda5nwp>
          <div class=fallWrapper data-astro-cid-5dda5nwp>
              <img alt="flowery border with man falling" decoding=async height=292 loading=lazy src=/images/man-no-vines.247a3187_Z2ioXNM.webp width=98 class=man data-astro-cid-5dda5nwp id=borderMan onclick=animateMan()>
          </div>
      </div>
  </div>
</header>
</header>
<main class="container" id="content" class="content">
<header>
<h1 class="title">Linux: Linux é˜²ç«å¢™</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:26e77df7-0c56-4c18-93d6-7db1dc4b7882">Linux é˜²ç«å¢™</a>
<ul>
<li><a href="#h:00efe72f-ad70-4dbc-8ce7-645a9bc3f95b">å®‰å…¨æŠ€æœ¯å’Œé˜²ç«å¢™</a>
<ul>
<li><a href="#h:0c3cecdb-2d5b-4582-acc7-a1c599f50107">å®‰å…¨æŠ€æœ¯</a></li>
<li><a href="#h:6e5c7b40-1aa0-4136-a950-c7bb56381c43">é˜²ç«å¢™çš„åˆ†ç±»</a></li>
<li><a href="#h:622ccea7-c4d7-4f76-b302-85ac37a20b78">ç½‘ç»œæ¶æ„</a></li>
</ul>
</li>
<li><a href="#h:97ff6f63-4903-43ea-bd03-de4aba5d6f22">Linux é˜²ç«å¢™çš„åŸºæœ¬è®¤è¯†</a>
<ul>
<li><a href="#h:d68a350b-e855-4f3b-ae18-8b22f9e4b144">Netfilter</a></li>
<li><a href="#h:e98d80b3-e2ed-4e4f-bc43-33ff1477f870">é˜²ç«å¢™å·¥å…·ä»‹ç»</a>
<ul>
<li><a href="#h:0624146d-38ef-484b-9310-46c8643c1914">iptables</a></li>
<li><a href="#h:01ace37b-9a1f-4884-8c7a-78a3781639f5">firewalld</a></li>
<li><a href="#h:44ff9cd2-8bf6-414a-9119-0762c76daf04">nftables</a></li>
</ul>
</li>
<li><a href="#h:ed0d5e05-318c-49d0-99d0-539dcc86a7aa">netfilter ä¸­äº”ä¸ªå‹¾å­å‡½æ•°å’ŒæŠ¥æ–‡æµå‘</a></li>
<li><a href="#h:9a27d671-a4bb-4725-b069-a5665c0ddb11">iptablesçš„ç»„æˆ</a></li>
<li><a href="#h:ba854ffd-e62b-43ea-aa16-d2776d97efde">netfilter å®Œæ•´æµç¨‹</a></li>
</ul>
</li>
<li><a href="#h:5cf074a6-01a4-4476-a874-15bfa8cae985">iptables</a>
<ul>
<li><a href="#h:4f5426ea-3c52-4b14-bade-f023d76d49e0">iptables è§„åˆ™è¯´æ˜</a>
<ul>
<li><a href="#h:22cceb12-4d75-4134-839a-015593974804">iptables è§„åˆ™ç»„æˆ</a></li>
<li><a href="#h:3b46b0e6-41f9-40fa-b852-9eb1f90be40e">iptablesè§„åˆ™æ·»åŠ æ—¶è€ƒé‡ç‚¹</a></li>
<li><a href="#h:666370a4-ba29-4025-8578-aa3b9199fdaf">ç¯å¢ƒå‡†å¤‡(ç¦ç”¨é»˜è®¤é˜²ç«å¢™è§„åˆ™)</a></li>
</ul>
</li>
<li><a href="#h:9db34b34-110e-46f7-9b2c-c2e6f8c0360c">iptables ç”¨æ³•è¯´æ˜</a></li>
<li><a href="#h:5c6336b9-30df-4c45-b1be-d8b90d83105e">iptables åŸºæœ¬åŒ¹é…æ¡ä»¶</a></li>
<li><a href="#h:499ad751-f61e-4bfa-a724-8a332d6949f6">iptables æ‰©å±•åŒ¹é…æ¡ä»¶</a>
<ul>
<li><a href="#h:2645cee0-4765-4cdb-94aa-56a69f3b4642">éšå¼æ‰©å±•</a></li>
<li><a href="#h:db740704-f14e-4018-943e-7b0820ca918b">æ˜¾å¼æ‰©å±•åŠç›¸å…³æ¨¡å—</a></li>
</ul>
</li>
<li><a href="#h:492bc41f-380a-477e-b662-1d16bc1bbf7e">Target</a></li>
<li><a href="#h:10f4bdee-c93a-48a2-83bd-26a34d37753e">è§„åˆ™ä¼˜åŒ–æœ€ä½³å®è·µ</a></li>
<li><a href="#h:26466bfc-e2d9-4a5b-a7d0-834436c081c9">iptablesè§„åˆ™ä¿å­˜</a></li>
<li><a href="#h:52fe8afa-e499-42b4-becc-7e55b77a174b">ç½‘ç»œé˜²ç«å¢™</a>
<ul>
<li><a href="#h:8b5c1a05-da52-41c1-94bc-a4ed9778fb98">FORWARD é“¾å®ç°å†…å¤–ç½‘ç»œçš„æµé‡æ§åˆ¶</a></li>
<li><a href="#h:c1c8996c-9870-46a8-be4b-3a87a518b585">NAT è¡¨</a></li>
<li><a href="#h:68e0209f-eb6d-4edc-ab92-0ac30fcff4de">SNAT</a></li>
<li><a href="#h:abb5c3ff-76b3-44e2-b789-5d14fc7a5ee9">DNAT</a></li>
<li><a href="#h:72073f97-3e2d-43c8-a08c-01d8ffdb2804">REDIRECT è½¬å‘(ç«¯å£è½¬å‘)</a></li>
</ul>
</li>
<li><a href="#h:732ceb41-99c3-4ce8-aa77-5056b0108851">å®æˆ˜æ¡ˆä¾‹ï¼š</a></li>
<li><a href="#h:e294b82d-64ce-41cf-9334-9ec02af8bab9">iptableså®ç°ä¸ƒå±‚è®¿é—®è¿‡æ»¤</a></li>
</ul>
</li>
<li><a href="#h:ed0b7ea4-d0af-463c-a5c6-0e23dfb136fc">firewalldæœåŠ¡</a>
<ul>
<li><a href="#h:39899c40-ec8b-42fd-933d-3c02d0956a6e">firewalld ä»‹ç»</a></li>
<li><a href="#h:fef90433-dfbb-44ec-982e-3e3332aeebae">firewall-cmd å‘½ä»¤</a></li>
<li><a href="#h:806ec87a-80e8-4ccf-8127-d250c7f75195">å…¶å®ƒè§„åˆ™</a>
<ul>
<li><a href="#h:78295a50-4b55-4296-b2f0-7acb14ba7f2b">ç®¡ç†richè§„åˆ™</a></li>
<li><a href="#h:c4dc736f-12ae-42ab-a428-09684a2a2216">richè§„åˆ™å®ç°</a></li>
<li><a href="#h:c704eaa6-81e0-495d-9d46-336dd68d08b2">ä¼ªè£…å’Œç«¯å£è½¬å‘</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:0a0b62a6-a444-4118-aaec-7df4fd02a865">nft</a>
<ul>
<li><a href="#h:a1a99e5f-96c5-4107-83a3-aba163a9360a">nft ä»‹ç»</a></li>
<li><a href="#h:b0f07a19-43b1-4f37-9b87-1b8d11589c6c">nft ç›¸å…³æ¦‚å¿µ</a></li>
<li><a href="#h:6264a49f-7034-4735-84ef-53c280186229">nft å¸¸è§ç”¨æ³•</a>
<ul>
<li><a href="#h:d8e57b03-a530-444a-ac56-44c785493f97">nft å‘½ä»¤æ ¼å¼</a></li>
<li><a href="#h:51a4e412-7377-4184-a4e6-874b2ddf6433">æŸ¥çœ‹</a></li>
<li><a href="#h:dd1fd1c3-d648-4d0b-b745-b7485d0e1f49">å¢åŠ </a></li>
<li><a href="#h:83e2bb90-cca5-4185-b2e4-7cbd1c951381">åˆ </a></li>
<li><a href="#h:334df536-c47f-4048-abc0-702f5433e147">æ”¹</a></li>
</ul>
</li>
<li><a href="#h:e25d4407-518a-4c42-a383-b6ce70adb185">nft å®æˆ˜æ¡ˆä¾‹</a>
<ul>
<li><a href="#h:c801d4c7-7697-4d86-8328-18b5e368bf8b">åˆ›å»ºè¡¨å’Œåˆ é™¤è¡¨</a></li>
<li><a href="#h:2af0f5cc-c874-4f48-a66f-00c90097506a">åˆ›å»ºé“¾</a></li>
<li><a href="#h:86b0ee29-5a01-43c5-a5a2-36c63b8534e1">åˆ›å»ºè§„åˆ™</a></li>
<li><a href="#h:8a13c384-417b-4e5e-b1be-350540dd5c24">æ’å…¥é“¾çš„æŒ‡å®šä½ç½®</a></li>
<li><a href="#h:99db9446-a0f5-4299-a812-1f1afa4ac59a">åˆ é™¤è§„åˆ™</a></li>
<li><a href="#h:31e908ce-837d-46d3-81a6-14275abc4e79">åˆ—å‡ºè§„åˆ™</a></li>
<li><a href="#h:ca7c831e-db03-4dc6-9a57-fdb2f1e3894c">å¤‡ä»½è¿˜åŸ</a></li>
<li><a href="#h:18748435-b5fb-4c0f-a14b-3cee735a1d09">è¿ç§»iptablesè§„åˆ™åˆ°nft</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../../index.html">Linux</a></li>
</ul>
<section id="outline-container-h:26e77df7-0c56-4c18-93d6-7db1dc4b7882" class="outline-2">
<h2 id="h:26e77df7-0c56-4c18-93d6-7db1dc4b7882">Linux é˜²ç«å¢™</h2>
<div class="outline-text-2" id="text-h:26e77df7-0c56-4c18-93d6-7db1dc4b7882">
<p>
æœ¬ç« å†…å®¹
</p>

<ul class="org-ul">
<li>é˜²ç«å¢™çš„æ¦‚å¿µ</li>
<li>iptablesçš„åŸºæœ¬è®¤è¯†</li>
<li>iptablesçš„ç»„æˆ</li>
<li>iptablesçš„åŸºæœ¬è¯­æ³•</li>
<li>iptablesä¹‹forwardçš„æ¦‚å¿µ</li>
<li>iptablesä¹‹åœ°å€è½¬æ¢æ³•åˆ™</li>
<li>SNATæºåœ°å€è½¬æ¢çš„å…·ä½“å®ç°</li>
<li>DNATç›®æ ‡åœ°å€è½¬æ¢çš„å…·ä½“å®ç°</li>
<li>firewalldä»‹ç»</li>
<li>firewalldé…ç½®</li>
<li>å‘½ä»¤richè§„åˆ™</li>
<li>nft åŸºæœ¬ç”¨æ³•</li>
</ul>
</div>
<div id="outline-container-h:00efe72f-ad70-4dbc-8ce7-645a9bc3f95b" class="outline-3">
<h3 id="h:00efe72f-ad70-4dbc-8ce7-645a9bc3f95b">å®‰å…¨æŠ€æœ¯å’Œé˜²ç«å¢™</h3>
<div class="outline-text-3" id="text-h:00efe72f-ad70-4dbc-8ce7-645a9bc3f95b">
</div>
<div id="outline-container-h:0c3cecdb-2d5b-4582-acc7-a1c599f50107" class="outline-4">
<h4 id="h:0c3cecdb-2d5b-4582-acc7-a1c599f50107">å®‰å…¨æŠ€æœ¯</h4>
<div class="outline-text-4" id="text-h:0c3cecdb-2d5b-4582-acc7-a1c599f50107">
<ul class="org-ul">
<li>å…¥ä¾µæ£€æµ‹ç³»ç»Ÿï¼ˆIntrusion Detection Systemsï¼‰ï¼šç‰¹ç‚¹æ˜¯ä¸é˜»æ–­ä»»ä½•ç½‘ç»œè®¿
é—®ï¼Œé‡åŒ–ã€å®šä½æ¥è‡ªå†…å¤–ç½‘ç»œçš„å¨èƒæƒ…å†µï¼Œä¸»è¦ä»¥æä¾›æŠ¥å‘Šå’Œäº‹åç›‘ç£ä¸ºä¸»ï¼Œ
æä¾›æœ‰é’ˆå¯¹æ€§çš„æŒ‡å¯¼æªæ–½å’Œå®‰å…¨å†³ç­–ä¾æ®ã€‚ä¸€èˆ¬é‡‡ç”¨æ—è·¯éƒ¨ç½²æ–¹å¼</li>

<li>å…¥ä¾µé˜²å¾¡ç³»ç»Ÿï¼ˆIntrusion Prevention Systemï¼‰ï¼šä»¥é€æ˜æ¨¡å¼å·¥ä½œï¼Œåˆ†ææ•°
æ®åŒ…çš„å†…å®¹å¦‚ï¼šæº¢å‡ºæ”»å‡»ã€æ‹’ç»æœåŠ¡æ”»å‡»ã€æœ¨é©¬ã€è •è™«ã€ç³»ç»Ÿæ¼æ´ç­‰è¿›è¡Œå‡†ç¡®
çš„åˆ†æåˆ¤æ–­ï¼Œåœ¨åˆ¤å®šä¸ºæ”»å‡»è¡Œä¸ºåç«‹å³äºˆä»¥é˜»æ–­ï¼Œä¸»åŠ¨è€Œæœ‰æ•ˆçš„ä¿æŠ¤ç½‘ç»œçš„å®‰
å…¨ï¼Œä¸€èˆ¬é‡‡ç”¨åœ¨çº¿éƒ¨ç½²æ–¹å¼</li>

<li>é˜²ç«å¢™ï¼ˆ FireWallï¼‰ï¼šéš”ç¦»åŠŸèƒ½ï¼Œå·¥ä½œåœ¨ç½‘ç»œæˆ–ä¸»æœºè¾¹ç¼˜ï¼Œå¯¹è¿›å‡ºç½‘ç»œæˆ–ä¸»
æœºçš„æ•°æ®åŒ…åŸºäºä¸€å®šçš„è§„åˆ™æ£€æŸ¥ï¼Œå¹¶åœ¨åŒ¹é…æŸè§„åˆ™æ—¶ç”±è§„åˆ™å®šä¹‰çš„è¡Œä¸ºè¿›è¡Œå¤„
ç†çš„ä¸€ç»„åŠŸèƒ½çš„ç»„ä»¶ï¼ŒåŸºæœ¬ä¸Šçš„å®ç°éƒ½æ˜¯é»˜è®¤æƒ…å†µä¸‹å…³é—­æ‰€æœ‰çš„é€šè¿‡å‹è®¿é—®ï¼Œ
åªå¼€æ”¾å…è®¸è®¿é—®çš„ç­–ç•¥</li>
</ul>

<blockquote>
<p>
é˜²æ°´å¢™
</p>

<p>
å¹¿æ³›æ„ä¹‰ä¸Šçš„é˜²æ°´å¢™ï¼šé˜²æ°´å¢™ï¼ˆWaterwallï¼‰ï¼Œä¸é˜²ç«å¢™ç›¸å¯¹ï¼Œæ˜¯ä¸€ç§é˜²æ­¢å†…éƒ¨ä¿¡æ¯æ³„æ¼çš„å®‰å…¨äº§å“ã€‚ç½‘ç»œã€å¤–è®¾æ¥å£ã€å­˜å‚¨ä»‹è´¨å’Œæ‰“å°æœºæ„æˆä¿¡æ¯æ³„æ¼çš„å…¨éƒ¨é€”å¾„ã€‚é˜²æ°´å¢™é’ˆå¯¹è¿™å››ç§æ³„å¯†é€”å¾„ï¼Œåœ¨äº‹å‰ã€äº‹ä¸­ã€äº‹åè¿›è¡Œå…¨é¢é˜²æŠ¤ã€‚å…¶ä¸é˜²ç—…æ¯’äº§å“ã€å¤–éƒ¨å®‰å…¨äº§å“ä¸€èµ·æ„æˆå®Œæ•´çš„ç½‘ç»œå®‰å…¨ä½“ç³»ã€‚
</p>
</blockquote>


<figure id="orgb41197f">
<img src="images/image-20210216193744488.png" alt="image-20210216193744488.png">

</figure>
</div>
</div>
<div id="outline-container-h:6e5c7b40-1aa0-4136-a950-c7bb56381c43" class="outline-4">
<h4 id="h:6e5c7b40-1aa0-4136-a950-c7bb56381c43">é˜²ç«å¢™çš„åˆ†ç±»</h4>
<div class="outline-text-4" id="text-h:6e5c7b40-1aa0-4136-a950-c7bb56381c43">

<figure id="orgeea0508">
<img src="images/image-20210216193805258.png" alt="image-20210216193805258.png">

</figure>

<p>
æŒ‰ä¿æŠ¤èŒƒå›´åˆ’åˆ†ï¼š
</p>

<ul class="org-ul">
<li>ä¸»æœºé˜²ç«å¢™ï¼šæœåŠ¡èŒƒå›´ä¸ºå½“å‰ä¸€å°ä¸»æœº</li>
<li>ç½‘ç»œé˜²ç«å¢™ï¼šæœåŠ¡èŒƒå›´ä¸ºé˜²ç«å¢™ä¸€ä¾§çš„å±€åŸŸç½‘</li>
</ul>

<p>
æŒ‰å®ç°æ–¹å¼åˆ’åˆ†:
</p>

<ul class="org-ul">
<li>ç¡¬ä»¶é˜²ç«å¢™ï¼šåœ¨ä¸“ç”¨ç¡¬ä»¶çº§åˆ«å®ç°éƒ¨åˆ†åŠŸèƒ½çš„é˜²ç«å¢™ï¼›å¦ä¸€ä¸ªéƒ¨åˆ†åŠŸèƒ½åŸºäºè½¯
ä»¶å®ç°ï¼Œå¦‚ï¼šåä¸ºï¼Œ360ï¼Œå¤©èä¿¡,å¯æ˜æ˜Ÿè¾°ï¼Œç»¿ç›Ÿï¼Œæ·±ä¿¡æœ, Checkpointï¼Œ
NetScreen(Juniper2004å¹´40äº¿ç¾å…ƒæ”¶è´­)ç­‰</li>
<li>è½¯ä»¶é˜²ç«å¢™ï¼šè¿è¡Œäºé€šç”¨ç¡¬ä»¶å¹³å°ä¹‹ä¸Šçš„é˜²ç«å¢™çš„åº”ç”¨è½¯ä»¶ï¼ŒWindowsé˜²ç«
å¢™,ISA &#x2013;&gt; Forefront TMG</li>
</ul>

<p>
æŒ‰ç½‘ç»œåè®®åˆ’åˆ†ï¼š
</p>

<ul class="org-ul">
<li>ç½‘ç»œå±‚é˜²ç«å¢™ï¼šOSIæ¨¡å‹ä¸‹å››å±‚ï¼Œåˆç§°ä¸ºåŒ…è¿‡æ»¤é˜²ç«å¢™</li>
<li>åº”ç”¨å±‚é˜²ç«å¢™/ä»£ç†æœåŠ¡å™¨ï¼šä»£ç†ç½‘å…³ï¼ŒOSIæ¨¡å‹ä¸ƒå±‚</li>
</ul>

<p>
<b>åŒ…è¿‡æ»¤é˜²ç«å¢™</b>
</p>


<figure id="orgab10796">
<img src="images/image-20210217100440033.png" alt="image-20210217100440033.png">

</figure>

<p>
ç½‘ç»œå±‚å¯¹æ•°æ®åŒ…è¿›è¡Œé€‰æ‹©ï¼Œé€‰æ‹©çš„ä¾æ®æ˜¯ç³»ç»Ÿå†…è®¾ç½®çš„è¿‡æ»¤é€»è¾‘ï¼Œè¢«ç§°ä¸ºè®¿é—®æ§
åˆ¶åˆ—è¡¨ï¼ˆACLï¼‰ï¼Œé€šè¿‡æ£€æŸ¥æ•°æ®æµä¸­æ¯ä¸ªæ•°æ®çš„æºåœ°å€ï¼Œç›®çš„åœ°å€ï¼Œæ‰€ç”¨ç«¯å£å·
å’Œåè®®çŠ¶æ€ç­‰å› ç´ ï¼Œæˆ–ä»–ä»¬çš„ç»„åˆæ¥ç¡®å®šæ˜¯å¦å…è®¸è¯¥æ•°æ®åŒ…é€šè¿‡
</p>

<p>
ä¼˜ç‚¹ï¼šå¯¹ç”¨æˆ·æ¥è¯´é€æ˜ï¼Œå¤„ç†é€Ÿåº¦å¿«ä¸”æ˜“äºç»´æŠ¤
</p>

<p>
ç¼ºç‚¹ï¼šæ— æ³•æ£€æŸ¥åº”ç”¨å±‚æ•°æ®ï¼Œå¦‚ç—…æ¯’ç­‰
</p>

<p>
<b>åº”ç”¨å±‚é˜²ç«å¢™</b>
</p>


<figure id="org6657186">
<img src="images/image-20210217100508051.png" alt="image-20210217100508051.png">

</figure>

<p>
åº”ç”¨å±‚é˜²ç«å¢™/ä»£ç†æœåŠ¡å‹é˜²ç«å¢™ï¼Œä¹Ÿç§°ä¸ºä»£ç†æœåŠ¡å™¨ï¼ˆProxy Server)
</p>

<p>
1å°†æ‰€æœ‰è·¨è¶Šé˜²ç«å¢™çš„ç½‘ç»œé€šä¿¡é“¾è·¯åˆ†ä¸ºä¸¤æ®µ
</p>

<p>
å†…å¤–ç½‘ç”¨æˆ·çš„è®¿é—®éƒ½æ˜¯é€šè¿‡ä»£ç†æœåŠ¡å™¨ä¸Šçš„â€œé“¾æ¥â€æ¥å®ç°
</p>

<p>
ä¼˜ç‚¹ï¼šåœ¨åº”ç”¨å±‚å¯¹æ•°æ®è¿›è¡Œæ£€æŸ¥ï¼Œæ¯”è¾ƒå®‰å…¨ ç¼ºç‚¹ï¼šå¢åŠ é˜²ç«å¢™çš„è´Ÿè½½
</p>

<p>
æç¤ºï¼šç°å®ç”Ÿäº§ç¯å¢ƒä¸­æ‰€ä½¿ç”¨çš„é˜²ç«å¢™ä¸€èˆ¬éƒ½æ˜¯äºŒè€…ç»“åˆä½“ï¼Œå³å…ˆæ£€æŸ¥ç½‘ç»œæ•°æ®ï¼Œ
é€šè¿‡ä¹‹åå†é€åˆ°åº”ç”¨å±‚å»æ£€æŸ¥
</p>
</div>
</div>
<div id="outline-container-h:622ccea7-c4d7-4f76-b302-85ac37a20b78" class="outline-4">
<h4 id="h:622ccea7-c4d7-4f76-b302-85ac37a20b78">ç½‘ç»œæ¶æ„</h4>
<div class="outline-text-4" id="text-h:622ccea7-c4d7-4f76-b302-85ac37a20b78">

<figure id="org188d5e4">
<img src="images/image-20210217100534446.png" alt="image-20210217100534446.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:97ff6f63-4903-43ea-bd03-de4aba5d6f22" class="outline-3">
<h3 id="h:97ff6f63-4903-43ea-bd03-de4aba5d6f22">Linux é˜²ç«å¢™çš„åŸºæœ¬è®¤è¯†</h3>
<div class="outline-text-3" id="text-h:97ff6f63-4903-43ea-bd03-de4aba5d6f22">
</div>
<div id="outline-container-h:d68a350b-e855-4f3b-ae18-8b22f9e4b144" class="outline-4">
<h4 id="h:d68a350b-e855-4f3b-ae18-8b22f9e4b144">Netfilter</h4>
<div class="outline-text-4" id="text-h:d68a350b-e855-4f3b-ae18-8b22f9e4b144">

<figure id="orgc6803fb">
<img src="images/image-20210217100548751.png" alt="image-20210217100548751.png">

<figcaption><span class="figure-number">Figure 1: </span>image-20210217100548751</figcaption>
</figure>

<p>
Linuxé˜²ç«å¢™æ˜¯ç”±Netfilterç»„ä»¶æä¾›çš„ï¼ŒNetfilterå·¥ä½œåœ¨å†…æ ¸ç©ºé—´ï¼Œé›†æˆåœ¨
linuxå†…æ ¸ä¸­
</p>

<p>
Netfilter æ˜¯Linux 2.4.xä¹‹åæ–°ä¸€ä»£çš„Linuxé˜²ç«å¢™æœºåˆ¶ï¼Œæ˜¯linuxå†…æ ¸çš„ä¸€ä¸ª
å­ç³»ç»Ÿã€‚Netfilteré‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå…·æœ‰è‰¯å¥½çš„å¯æ‰©å……æ€§ï¼Œæä¾›æ‰©å±•å„ç§ç½‘ç»œ
æœåŠ¡çš„ç»“æ„åŒ–åº•å±‚æ¡†æ¶ã€‚Netfilterä¸IPåè®®æ ˆæ˜¯æ— ç¼å¥‘åˆï¼Œå¹¶å…è®¸å¯¹æ•°æ®æŠ¥è¿›
è¡Œè¿‡æ»¤ã€åœ°å€è½¬æ¢ã€å¤„ç†ç­‰æ“ä½œ
</p>

<p>
Netfilterå®˜ç½‘æ–‡æ¡£ï¼š<a href="https://netfilter.org/documentation/">https://netfilter.org/documentation/</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#grep -m 10 NETFILTER /boot/config-4.18.0-193.el8.x86_64
<span style="color: #a0522d;">CONFIG_NETFILTER</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_ADVANCED</span>=y
<span style="color: #a0522d;">CONFIG_BRIDGE_NETFILTER</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_INGRESS</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_FAMILY_BRIDGE</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_FAMILY_ARP</span>=y
<span style="color: #b22222;"># </span><span style="color: #b22222;">CONFIG_NETFILTER_NETLINK_ACCT is not set</span>
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_QUEUE</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_LOG</span>=m
[root@centos7 ~]#grep -m 10 NETFILTER /boot/config-3.10.0-1127.el7.x86_64
<span style="color: #a0522d;">CONFIG_NETFILTER</span>=y
<span style="color: #b22222;"># </span><span style="color: #b22222;">CONFIG_NETFILTER_DEBUG is not set</span>
<span style="color: #a0522d;">CONFIG_NETFILTER_ADVANCED</span>=y
<span style="color: #a0522d;">CONFIG_BRIDGE_NETFILTER</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_ACCT</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_QUEUE</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_LOG</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_QUEUE_CT</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_SYNPROXY</span>=m
[root@centos6 ~]#grep -m 10 NETFILTER /boot/config-2.6.32-754.el6.x86_64
<span style="color: #a0522d;">CONFIG_NETFILTER</span>=y
<span style="color: #b22222;"># </span><span style="color: #b22222;">CONFIG_NETFILTER_DEBUG is not set</span>
<span style="color: #a0522d;">CONFIG_NETFILTER_ADVANCED</span>=y
<span style="color: #a0522d;">CONFIG_BRIDGE_NETFILTER</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_QUEUE</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_LOG</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_TPROXY</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_XTABLES</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_XT_TARGET_AUDIT</span>=m
[root@ubuntu2004 ~]#grep -m 10 NETFILTER /boot/config-5.4.0-33-generic
<span style="color: #a0522d;">CONFIG_NETFILTER</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_ADVANCED</span>=y
<span style="color: #a0522d;">CONFIG_BRIDGE_NETFILTER</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_INGRESS</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_FAMILY_BRIDGE</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_FAMILY_ARP</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_ACCT</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_QUEUE</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_LOG</span>=m
[root@ubuntu1804 ~]#grep -m 10 NETFILTER /boot/config-4.15.0-29-generic
<span style="color: #a0522d;">CONFIG_NETFILTER</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_ADVANCED</span>=y
<span style="color: #a0522d;">CONFIG_BRIDGE_NETFILTER</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_INGRESS</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_ACCT</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_QUEUE</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_LOG</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_GLUE_CT</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_SYNPROXY</span>=m
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e98d80b3-e2ed-4e4f-bc43-33ff1477f870" class="outline-4">
<h4 id="h:e98d80b3-e2ed-4e4f-bc43-33ff1477f870">é˜²ç«å¢™å·¥å…·ä»‹ç»</h4>
<div class="outline-text-4" id="text-h:e98d80b3-e2ed-4e4f-bc43-33ff1477f870">
</div>
<div id="outline-container-h:0624146d-38ef-484b-9310-46c8643c1914" class="outline-5">
<h5 id="h:0624146d-38ef-484b-9310-46c8643c1914">iptables</h5>
<div class="outline-text-5" id="text-h:0624146d-38ef-484b-9310-46c8643c1914">
<p>
ç”±è½¯ä»¶åŒ…iptablesæä¾›çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå·¥ä½œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œç”¨æ¥ç¼–å†™è§„åˆ™ï¼Œå†™å¥½çš„
è§„åˆ™è¢«é€å¾€netfilterï¼Œå‘Šè¯‰å†…æ ¸å¦‚ä½•å»å¤„ç†ä¿¡æ¯åŒ…
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -qi iptables
[root@centos8 ~]# iptables --version
iptables v1.8.2 (nf_tables)
[root@centos8 ~]#ll /usr/sbin/iptables
lrwxrwxrwx. 1 root root 17 May 11 &#160;2019 /usr/sbin/iptables -&gt; xtables-nft-multi

[root@centos7 ~]#ll /usr/sbin/iptables
lrwxrwxrwx. 1 root root 13 Dec &#160;9 &#160;2018 /usr/sbin/iptables -&gt; xtables-multi
[root@centos7 ~]# iptables --version
iptables v1.4.21

[root@centos6 ~]#iptables --version
iptables v1.4.7
[root@centos6 ~]#ll /sbin/iptables
lrwxrwxrwx. 1 root root 33 Dec 12 &#160;2018 /sbin/iptables -&gt;/etc/alternatives/iptables.x86_64
[root@centos6 ~]#ll /etc/alternatives/iptables.x86_64
lrwxrwxrwx. 1 root root 20 Dec 12 &#160;2018 /etc/alternatives/iptables.x86_64 -&gt;/sbin/iptables-1.4.7
[root@centos6 ~]#ll /sbin/iptables
lrwxrwxrwx. 1 root root 33 Dec 12 &#160;2018 /sbin/iptables -&gt;
/etc/alternatives/iptables.x86_64
</pre>
</div>

<p>
èŒƒä¾‹ï¼šå®‰è£…iptablesçš„serviceåŒ…
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dnf -y install iptables-services
[root@centos8 ~]#rpm -ql iptables-services
/etc/sysconfig/ip6tables
/etc/sysconfig/iptables
/usr/lib/systemd/system/ip6tables.service
/usr/lib/systemd/system/iptables.service
/usr/libexec/initscripts/legacy-actions/ip6tables
/usr/libexec/initscripts/legacy-actions/ip6tables/panic
/usr/libexec/initscripts/legacy-actions/ip6tables/save
/usr/libexec/initscripts/legacy-actions/iptables
/usr/libexec/initscripts/legacy-actions/iptables/panic
/usr/libexec/initscripts/legacy-actions/iptables/save
/usr/libexec/iptables
/usr/libexec/iptables/ip6tables.init
/usr/libexec/iptables/iptables.init
</pre>
</div>
</div>
</div>
<div id="outline-container-h:01ace37b-9a1f-4884-8c7a-78a3781639f5" class="outline-5">
<h5 id="h:01ace37b-9a1f-4884-8c7a-78a3781639f5">firewalld</h5>
<div class="outline-text-5" id="text-h:01ace37b-9a1f-4884-8c7a-78a3781639f5">
<p>
ä»CentOS 7 ç‰ˆå¼€å§‹å¼•å…¥äº†æ–°çš„å‰ç«¯ç®¡ç†å·¥å…· è½¯ä»¶åŒ…ï¼š
</p>

<ul class="org-ul">
<li>firewalld</li>
<li>firewalld-config(å›¾å½¢åŒ–)</li>
</ul>

<p>
ç®¡ç†å·¥å…·ï¼š
</p>

<ul class="org-ul">
<li>firewall-cmd å‘½ä»¤è¡Œå·¥å…·</li>
<li>firewall-config å›¾å½¢å·¥ä½œ</li>
</ul>
</div>
</div>
<div id="outline-container-h:44ff9cd2-8bf6-414a-9119-0762c76daf04" class="outline-5">
<h5 id="h:44ff9cd2-8bf6-414a-9119-0762c76daf04">nftables</h5>
<div class="outline-text-5" id="text-h:44ff9cd2-8bf6-414a-9119-0762c76daf04">
<p>
æ­¤è½¯ä»¶æ˜¯CentOS 8 æ–°ç‰¹æ€§,Nftablesæœ€åˆåœ¨æ³•å›½å·´é»çš„Netfilter Workshop
2008ä¸Šå‘è¡¨ï¼Œç„¶åç”±é•¿æœŸçš„netfilteræ ¸å¿ƒå›¢é˜Ÿæˆå‘˜å’Œé¡¹ç›®è´Ÿè´£äººPatrick
McHardyäº2009å¹´3æœˆå‘å¸ƒã€‚å®ƒåœ¨2013å¹´æœ«åˆå¹¶åˆ°Linuxå†…æ ¸ä¸­ï¼Œè‡ª2014å¹´ä»¥æ¥å·²
åœ¨å†…æ ¸3.13ä¸­å¯ç”¨ã€‚
</p>

<p>
å®ƒé‡ç”¨äº†netfilteræ¡†æ¶çš„è®¸å¤šéƒ¨åˆ†ï¼Œä¾‹å¦‚è¿æ¥è·Ÿè¸ªå’ŒNATåŠŸèƒ½ã€‚å®ƒè¿˜ä¿ç•™äº†å‘½å
æ³•å’ŒåŸºæœ¬iptablesè®¾è®¡çš„å‡ ä¸ªéƒ¨åˆ†ï¼Œä¾‹å¦‚è¡¨ï¼Œé“¾å’Œè§„åˆ™ã€‚å°±åƒiptablesä¸€æ ·ï¼Œè¡¨
å……å½“é“¾çš„å®¹å™¨ï¼Œå¹¶ä¸”é“¾åŒ…å«å•ç‹¬çš„è§„åˆ™ï¼Œè¿™äº›è§„åˆ™å¯ä»¥æ‰§è¡Œæ“ä½œï¼Œä¾‹å¦‚ä¸¢å¼ƒæ•°æ®
åŒ…ï¼Œç§»è‡³ä¸‹ä¸€ä¸ªè§„åˆ™æˆ–è·³è‡³æ–°é“¾ã€‚
</p>

<p>
ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œnftablesæ·»åŠ äº†ä¸€ä¸ªåä¸ºnftçš„æ–°å·¥å…·ï¼Œè¯¥å·¥å…·æ›¿ä»£äº†
iptablesï¼Œarptableså’Œebtablesä¸­çš„æ‰€æœ‰å…¶ä»–å·¥å…·ã€‚ä»ä½“ç³»ç»“æ„çš„è§’åº¦æ¥çœ‹ï¼Œ
å®ƒè¿˜æ›¿æ¢äº†å†…æ ¸ä¸­å¤„ç†æ•°æ®åŒ…è¿‡æ»¤è§„åˆ™é›†è¿è¡Œæ—¶è¯„ä¼°çš„é‚£äº›éƒ¨åˆ†ã€‚
</p>

<p>
èŒƒä¾‹ï¼šæŸ¥çœ‹è½¯ä»¶åŒ…
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -qi nftables
Name &#160;&#160;&#160;: nftables
Epoch &#160;&#160;&#160;: 1
Version &#160;&#160;: 0.9.0
Release &#160;&#160;: 8.el8
Architecture: x86_64
Install Date: Wed 25 Sep 2019 09:29:06 PM CST
Group &#160;&#160;&#160;: Unspecified
Size &#160;&#160;&#160;: 758622
License &#160;&#160;: GPLv2
Signature &#160;: RSA/SHA256, Tue 02 Jul 2019 08:19:09 AM CST, Key ID
05b555b38483c65d
Source RPM : nftables-0.9.0-8.el8.src.rpm
Build Date : Sat 11 May 2019 11:06:46 PM CST
Build Host : x86-01.mbox.centos.org
Relocations : (not relocatable)
Packager &#160;: CentOS Buildsys <a href="mailto:bugs%40centos.org">&lt;bugs@centos.org&gt;</a>
Vendor &#160;&#160;: CentOS
URL &#160;&#160;&#160;&#160;: http://netfilter.org/projects/nftables/
Summary &#160;&#160;: Netfilter Tables userspace utillites
Description :
Netfilter Tables userspace utilities.
</pre>
</div>

<p>
èŒƒä¾‹ï¼šCentOS 8 æ”¯æŒä¸‰ç§é˜²ç«å¢™æœåŠ¡
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#systemctl status iptables.service
[root@centos8 ~]#systemctl status firewalld.service
[root@centos8 ~]#systemctl status nftables.service
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ed0d5e05-318c-49d0-99d0-539dcc86a7aa" class="outline-4">
<h4 id="h:ed0d5e05-318c-49d0-99d0-539dcc86a7aa">netfilter ä¸­äº”ä¸ªå‹¾å­å‡½æ•°å’ŒæŠ¥æ–‡æµå‘</h4>
<div class="outline-text-4" id="text-h:ed0d5e05-318c-49d0-99d0-539dcc86a7aa">
<p>
Netfilteråœ¨å†…æ ¸ä¸­é€‰å–äº”ä¸ªä½ç½®æ”¾äº†äº”ä¸ªhook(å‹¾å­) function(INPUTã€OUTPUTã€
FORWARDã€PREROUTINGã€POSTROUTING)ï¼Œè€Œè¿™äº”ä¸ªhook functionå‘ç”¨æˆ·å¼€æ”¾ï¼Œç”¨
æˆ·å¯ä»¥é€šè¿‡ä¸€ä¸ªå‘½ä»¤å·¥å…·ï¼ˆiptablesï¼‰å‘å…¶å†™å…¥è§„åˆ™
</p>

<p>
ç”±ä¿¡æ¯è¿‡æ»¤è¡¨ï¼ˆtableï¼‰ç»„æˆï¼ŒåŒ…å«æ§åˆ¶IPåŒ…å¤„ç†çš„è§„åˆ™é›†ï¼ˆrulesï¼‰ï¼Œè§„åˆ™è¢«åˆ†
ç»„æ”¾åœ¨é“¾ï¼ˆchainï¼‰ä¸Š
</p>


<figure id="orgf86c7b6">
<img src="images/image-20210217100644679.png" alt="image-20210217100644679.png">

</figure>

<p>
æç¤ºï¼šä» Linux kernel 4.2 ç‰ˆä»¥åï¼ŒNetfilter åœ¨prerouting å‰åŠ äº†ä¸€ä¸ª
ingresså‹¾å­å‡½æ•°ã€‚å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–°çš„å…¥å£æŒ‚é’©æ¥è¿‡æ»¤æ¥è‡ªç¬¬2å±‚çš„æµé‡ï¼Œè¿™ä¸ªæ–°
æŒ‚é’©æ¯”é¢„è·¯ç”±è¦æ—©ï¼ŒåŸºæœ¬ä¸Šæ˜¯tc å‘½ä»¤ï¼ˆæµé‡æ§åˆ¶å·¥å…·ï¼‰çš„æ›¿ä»£å“
</p>

<p>
<b>ä¸‰ç§æŠ¥æ–‡æµå‘</b>
</p>

<ul class="org-ul">
<li>æµå…¥æœ¬æœºï¼šPREROUTING &#x2013;&gt; INPUT&#x2013;&gt;ç”¨æˆ·ç©ºé—´è¿›ç¨‹</li>
<li>æµå‡ºæœ¬æœºï¼šç”¨æˆ·ç©ºé—´è¿›ç¨‹ &#x2013;&gt;OUTPUT&#x2013;&gt; POSTROUTING</li>
<li>è½¬å‘ï¼šPREROUTING &#x2013;&gt; FORWARD &#x2013;&gt; POSTROUTING</li>
</ul>
</div>
</div>
<div id="outline-container-h:9a27d671-a4bb-4725-b069-a5665c0ddb11" class="outline-4">
<h4 id="h:9a27d671-a4bb-4725-b069-a5665c0ddb11">iptablesçš„ç»„æˆ</h4>
<div class="outline-text-4" id="text-h:9a27d671-a4bb-4725-b069-a5665c0ddb11">
<p>
iptablesç”±äº”ä¸ªè¡¨tableå’Œäº”ä¸ªé“¾chainä»¥åŠä¸€äº›è§„åˆ™ç»„æˆ
</p>


<figure id="org6cbf77e">
<img src="images/image-20210217100707156.png" alt="image-20210217100707156.png">

</figure>

<p>
<b>é“¾ chainï¼š</b>
</p>

<ul class="org-ul">
<li>å†…ç½®é“¾ï¼šæ¯ä¸ªå†…ç½®é“¾å¯¹åº”äºä¸€ä¸ªé’©å­å‡½æ•°</li>
<li>è‡ªå®šä¹‰é“¾ï¼šç”¨äºå¯¹å†…ç½®é“¾è¿›è¡Œæ‰©å±•æˆ–è¡¥å……ï¼Œå¯å®ç°æ›´çµæ´»çš„è§„åˆ™ç»„ç»‡ç®¡ç†æœºåˆ¶ï¼›åªæœ‰Hooké’©å­è°ƒç”¨è‡ªå®šä¹‰é“¾æ—¶ï¼Œæ‰ç”Ÿæ•ˆ</li>
</ul>

<p>
<b>äº”ä¸ªå†…ç½®é“¾chain:</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">INPUT,OUTPUT,FORWARD,PREROUTING,POSTROUTING
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#19981;&#21516;&#36890;&#20449;&#20301;&#32622;&#21152;&#20197;&#21306;&#21035;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">input&#25509;&#25910;&#12289;output&#26412;&#26426;&#21457;&#36865;&#12289;forward&#26412;&#26426;&#36716;&#21457;&#12289;prerouting&#36335;&#30001;&#20043;&#21069;&#12289;postrouting&#36335;&#30001;&#21457;&#29983;&#20043;&#21518;</span>
</pre>
</div>

<p>
<b>äº”ä¸ªè¡¨tableï¼š</b> filterã€natã€mangleã€rawã€security
</p>

<ul class="org-ul">
<li>filterè¡¨ï¼šè¿‡æ»¤è§„åˆ™è¡¨ï¼Œæ ¹æ®é¢„å®šä¹‰çš„è§„åˆ™è¿‡æ»¤ç¬¦åˆæ¡ä»¶çš„æ•°æ®åŒ…,é»˜è®¤è¡¨</li>
<li>natè¡¨ï¼šnetwork address translation åœ°å€è½¬æ¢è§„åˆ™è¡¨</li>
<li>mangleï¼šä¿®æ”¹æ•°æ®æ ‡è®°ä½è§„åˆ™è¡¨</li>
<li>rawï¼šå…³é—­å¯ç”¨çš„è¿æ¥è·Ÿè¸ªæœºåˆ¶ï¼ŒåŠ å¿«å°åŒ…ç©¿è¶Šé˜²ç«å¢™é€Ÿåº¦</li>
<li>securityï¼šç”¨äºå¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼ˆMACï¼‰ç½‘ç»œè§„åˆ™ï¼Œç”±Linuxå®‰å…¨æ¨¡å—ï¼ˆå¦‚SELinuxï¼‰å®ç°</li>
</ul>

<p>
<b>ä¼˜å…ˆçº§ç”±é«˜åˆ°ä½çš„é¡ºåºä¸ºï¼š</b>
</p>

<pre class="example" id="org2417155">
security --&gt;raw--&gt;mangle--&gt;nat--&gt;filter
</pre>

<p>
<b>è¡¨å’Œé“¾å¯¹åº”å…³ç³»</b>
</p>


<figure id="org4f46a1a">
<img src="images/image-20210217100732778.png" alt="image-20210217100732778.png">

</figure>

<pre class="example" id="orgbd0478e">
raw   ï¼šPREROUTINGï¼Œ OUTPUT
mangleï¼šPREROUTINGï¼ŒINPUTï¼ŒFORWARDï¼ŒOUTPUTï¼ŒPOSTROUTING
nat   ï¼šPREROUTINGï¼Œ[INPUTï¼Œ]OUTPUTï¼ŒPOSTROUTING  # centos6ä¸Šå°‘æ”¯æŒäº†INPUTé“¾ï¼Œè·Ÿç‰ˆæœ¬æœ‰å…³
filterï¼šINPUTï¼ŒFORWARDï¼ŒOUTPUT
</pre>

<p>
<b>æ•°æ®åŒ…è¿‡æ»¤åŒ¹é…æµç¨‹</b>
</p>


<figure id="org4388085">
<img src="images/image-20210217100756188.png" alt="image-20210217100756188.png">

</figure>

<p>
<b>å†…æ ¸ä¸­æ•°æ®åŒ…çš„ä¼ è¾“è¿‡ç¨‹</b>
</p>

<ul class="org-ul">
<li>å½“ä¸€ä¸ªæ•°æ®åŒ…è¿›å…¥ç½‘å¡æ—¶ï¼Œæ•°æ®åŒ…é¦–å…ˆè¿›å…¥PREROUTINGé“¾ï¼Œå†…æ ¸æ ¹æ®æ•°æ®åŒ…ç›®
çš„IPåˆ¤æ–­æ˜¯å¦éœ€è¦è½¬é€å‡ºå»</li>
<li>å¦‚æœæ•°æ®åŒ…æ˜¯è¿›å…¥æœ¬æœºçš„ï¼Œæ•°æ®åŒ…å°±ä¼šæ²¿ç€å›¾å‘ä¸‹ç§»åŠ¨ï¼Œåˆ°è¾¾INPUTé“¾ã€‚æ•°æ®
åŒ…åˆ°è¾¾INPUTé“¾åï¼Œä»»ä½•è¿›ç¨‹éƒ½ä¼šæ”¶åˆ°å®ƒã€‚æœ¬æœºä¸Šè¿è¡Œçš„ç¨‹åºå¯ä»¥å‘é€æ•°æ®åŒ…ï¼Œ
è¿™äº›æ•°æ®åŒ…ç»è¿‡OUTPUTé“¾ï¼Œç„¶ååˆ°è¾¾POSTROUTINGé“¾è¾“å‡º</li>
<li>å¦‚æœæ•°æ®åŒ…æ˜¯è¦è½¬å‘å‡ºå»çš„ï¼Œä¸”å†…æ ¸å…è®¸è½¬å‘ï¼Œæ•°æ®åŒ…å°±ä¼šå‘å³ç§»åŠ¨ï¼Œç»è¿‡
FORWARDé“¾ï¼Œç„¶ååˆ°è¾¾POSTROUTINGé“¾è¾“å‡º</li>
</ul>

<p>
èŒƒä¾‹ï¼šè¡¨å’Œé“¾å¯¹åº”å…³ç³»
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">filter&#34920;&#40664;&#35748;&#65292;&#25903;&#25345;INPUT&#65292;FORWARD&#65292;OUTPUT</span>
root@centos8 ~]#iptables -vnL -t filter 
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target &#160;&#160;prot opt<span style="color: #a020f0;"> in</span> &#160;&#160;out &#160;&#160;source &#160;&#160;&#160;&#160;&#160;&#160;&#160;destination

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target &#160;&#160;prot opt<span style="color: #a020f0;"> in</span> &#160;&#160;out &#160;&#160;source &#160;&#160;&#160;&#160;&#160;&#160;&#160;destination

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target &#160;&#160;prot opt<span style="color: #a020f0;"> in</span> &#160;&#160;out &#160;&#160;source &#160;&#160;&#160;&#160;&#160;&#160;&#160;destination

<span style="color: #b22222;"># </span><span style="color: #b22222;">nat&#34920;&#65292;&#25903;&#25345;PREROUTING&#65292;INPUT&#65292;OUTPUT&#65292;POSTROUTING</span>
[root@centos8 ~]#iptables -vnL -t nat 
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)

<span style="color: #b22222;"># </span><span style="color: #b22222;">mangle&#34920;&#65292;&#25903;&#25345;PREROUTING&#65292;INPUT&#65292;FORWARD&#65292;OUTPUT&#65292;POSTROUTING</span>
[root@centos8 ~]#iptables -vnL -t mangle
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)

<span style="color: #b22222;"># </span><span style="color: #b22222;">raw&#34920;&#65292;&#25903;&#25345;PREROUTING&#65292; OUTPUT</span>
[root@centos8 ~]#iptables -vnL -t raw
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)

<span style="color: #b22222;"># </span><span style="color: #b22222;">security&#34920;&#65292;&#25903;&#25345;IPUT, FORWARD, OUTPUT</span>
[root@centos8 ~]#iptables -vnL -t security
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)

<span style="color: #b22222;">#</span><span style="color: #b22222;">CentOS 6 nat&#34920;&#19981;&#25903;&#25345;INPUT&#38142;</span>
[root@centos6 ~]#iptables -vnL -t nat
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ba854ffd-e62b-43ea-aa16-d2776d97efde" class="outline-4">
<h4 id="h:ba854ffd-e62b-43ea-aa16-d2776d97efde">netfilter å®Œæ•´æµç¨‹</h4>
<div class="outline-text-4" id="text-h:ba854ffd-e62b-43ea-aa16-d2776d97efde">

<figure id="orge0f23de">
<img src="images/image-20210217100828725.png" alt="image-20210217100828725.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:5cf074a6-01a4-4476-a874-15bfa8cae985" class="outline-3">
<h3 id="h:5cf074a6-01a4-4476-a874-15bfa8cae985">iptables</h3>
<div class="outline-text-3" id="text-h:5cf074a6-01a4-4476-a874-15bfa8cae985">
</div>
<div id="outline-container-h:4f5426ea-3c52-4b14-bade-f023d76d49e0" class="outline-4">
<h4 id="h:4f5426ea-3c52-4b14-bade-f023d76d49e0">iptables è§„åˆ™è¯´æ˜</h4>
<div class="outline-text-4" id="text-h:4f5426ea-3c52-4b14-bade-f023d76d49e0">
</div>
<div id="outline-container-h:22cceb12-4d75-4134-839a-015593974804" class="outline-5">
<h5 id="h:22cceb12-4d75-4134-839a-015593974804">iptables è§„åˆ™ç»„æˆ</h5>
<div class="outline-text-5" id="text-h:22cceb12-4d75-4134-839a-015593974804">
<p>
è§„åˆ™ruleï¼šæ ¹æ®è§„åˆ™çš„åŒ¹é…æ¡ä»¶å°è¯•åŒ¹é…æŠ¥æ–‡ï¼Œå¯¹åŒ¹é…æˆåŠŸçš„æŠ¥æ–‡æ ¹æ®è§„åˆ™å®šä¹‰
çš„å¤„ç†åŠ¨ä½œä½œå‡ºå¤„ç†ï¼Œè§„åˆ™åœ¨é“¾æ¥ä¸Šçš„æ¬¡åºå³ä¸ºå…¶æ£€æŸ¥æ—¶çš„ç”Ÿæ•ˆæ¬¡åº
</p>

<p>
åŒ¹é…æ¡ä»¶ï¼šé»˜è®¤ä¸ºä¸æ¡ä»¶ï¼ŒåŒæ—¶æ»¡è¶³
</p>

<ul class="org-ul">
<li>åŸºæœ¬åŒ¹é…ï¼šIPï¼Œç«¯å£ï¼ŒTCPçš„Flagsï¼ˆSYN,ACKç­‰ï¼‰</li>

<li>æ‰©å±•åŒ¹é…ï¼šé€šè¿‡å¤æ‚é«˜çº§åŠŸèƒ½åŒ¹é…</li>
</ul>

<p>
å¤„ç†åŠ¨ä½œï¼šç§°ä¸ºtargetï¼Œè·³è½¬ç›®æ ‡
</p>

<ul class="org-ul">
<li>å†…å»ºå¤„ç†åŠ¨ä½œï¼šACCEPT,DROP,REJECT,SNAT,DNAT,MASQUERADE,MARK,LOG&#x2026;</li>
<li>è‡ªå®šä¹‰å¤„ç†åŠ¨ä½œï¼šè‡ªå®šä¹‰chainï¼Œåˆ©ç”¨åˆ†ç±»ç®¡ç†å¤æ‚æƒ…å½¢</li>
</ul>

<p>
è§„åˆ™è¦æ·»åŠ åœ¨é“¾ä¸Šï¼Œæ‰ç”Ÿæ•ˆï¼›æ·»åŠ åœ¨è‡ªå®šä¹‰é“¾ä¸Šä¸ä¼šè‡ªåŠ¨ç”Ÿæ•ˆ
</p>


<figure id="org416154f">
<img src="images/image-20210416153129204.png" alt="image-20210416153129204.png">

</figure>

<p>
èŒƒä¾‹ï¼šå¤„ç†åŠ¨ä½œ
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#20869;&#24314;&#22788;&#29702;&#21160;&#20316;</span>
ACCEPT    &#65306;&#20801;&#35768;&#25968;&#25454;&#21253;&#36890;&#36807;
DROP      &#65306;&#20002;&#24323;&#25968;&#25454;&#21253;
REJECT    &#65306;&#25298;&#32477;&#25968;&#25454;&#21253;&#65292;&#21516;&#26102;&#32473;&#21457;&#36865;&#32773;&#21457;&#36865;&#27809;&#26377;&#25509;&#21463;&#30340;&#36890;&#30693;
RETURN    &#65306;&#32467;&#26463;&#24403;&#21069;&#36820;&#22238;&#35843;&#29992;&#38142;&#65307;
REDIRECT  &#65306;&#31471;&#21475;&#37325;&#23450;&#21521;&#65307;
LOG       &#65306;&#35760;&#24405;&#26085;&#24535;&#65307;
MARK      &#65306;&#20570;&#38450;&#28779;&#22681;&#26631;&#35760;&#65307;
DNAT      &#65306;&#30446;&#26631;&#22320;&#22336;&#36716;&#25442;&#65307;
SNAT      &#65306;&#28304;&#22320;&#22336;&#36716;&#25442;&#65307;
MASQUERADE&#65306;&#22320;&#22336;&#20266;&#35013;&#65307;&#20851;&#38381;
&#33258;&#23450;&#20041;&#38142;   &#65306; -j WEB_CHAIN <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20851;&#32852;&#20869;&#32622;&#38142;&#20013;&#65292;&#33258;&#23450;&#20041;&#38142;&#25165;&#29983;&#25928;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3b46b0e6-41f9-40fa-b852-9eb1f90be40e" class="outline-5">
<h5 id="h:3b46b0e6-41f9-40fa-b852-9eb1f90be40e">iptablesè§„åˆ™æ·»åŠ æ—¶è€ƒé‡ç‚¹</h5>
<div class="outline-text-5" id="text-h:3b46b0e6-41f9-40fa-b852-9eb1f90be40e">
<ul class="org-ul">
<li>è¦å®ç°å“ªç§åŠŸèƒ½ï¼šåˆ¤æ–­æ·»åŠ åœ¨å“ªå¼ è¡¨ä¸Š</li>
<li>æŠ¥æ–‡æµç»çš„è·¯å¾„ï¼šåˆ¤æ–­æ·»åŠ åœ¨å“ªä¸ªé“¾ä¸Š</li>
<li>æŠ¥æ–‡çš„æµå‘ï¼šåˆ¤æ–­æºå’Œç›®çš„</li>
<li>åŒ¹é…è§„åˆ™ï¼šä¸šåŠ¡éœ€è¦</li>
</ul>
</div>
</div>
<div id="outline-container-h:666370a4-ba29-4025-8578-aa3b9199fdaf" class="outline-5">
<h5 id="h:666370a4-ba29-4025-8578-aa3b9199fdaf">ç¯å¢ƒå‡†å¤‡(ç¦ç”¨é»˜è®¤é˜²ç«å¢™è§„åˆ™)</h5>
<div class="outline-text-5" id="text-h:666370a4-ba29-4025-8578-aa3b9199fdaf">
<p>
é»˜è®¤é˜²ç«å¢™æœ‰å¾ˆå¤šè‡ªå®šä¹‰è§„åˆ™åˆæœŸä¸å¥½ç†è§£
</p>

<p>
Centos 7ï¼Œ8ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl stop firewalld.service
systemctl disable firewalld. service
&#25110;&#32773;
systemctl disable --now firewalld.service
</pre>
</div>

<p>
Centos6ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">service iptables stop
chkconfig iptables off
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:9db34b34-110e-46f7-9b2c-c2e6f8c0360c" class="outline-4">
<h4 id="h:9db34b34-110e-46f7-9b2c-c2e6f8c0360c">iptables ç”¨æ³•è¯´æ˜</h4>
<div class="outline-text-4" id="text-h:9db34b34-110e-46f7-9b2c-c2e6f8c0360c">
<p>
å¸®åŠ©ï¼šman 8 iptables æ ¼å¼ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables [-t table] {-A|-C|-D} chain rule-specification
iptables [-t table] -I chain [rulenum] rule-specification
iptables [-t table] -R chain rulenum rule-specification
iptables [-t table] -D chain rulenum
iptables [-t table] -S [chain [rulenum]]
iptables [-t table] {-F|-L|-Z} [chain [rulenum]] [options...]
iptables [-t table] -N chain
iptables [-t table] -X [chain]
iptables [-t table] -P chain target
iptables [-t table] -E old-chain-name new-chain-name
rule-specification = [matches...] [target]
match = -m matchname [per-match-options]
target = -j targetname [per-target-options]
</pre>
</div>

<p>
<b>èŒƒä¾‹ï¼šFilterè¡¨ä¸­INPUTè§„åˆ™</b>
</p>


<figure id="org252e6bf">
<img src="images/image-20210217100904154.png" alt="image-20210217100904154.png">

</figure>

<p>
<b>iptableså‘½ä»¤æ ¼å¼è¯¦è§£ï¼š</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables  [-t table] &#160;SUBCOMMAND &#160;chain &#160;[-m matchname [per-match-options]] -j targetname [per-target-options]
</pre>
</div>

<p>
<b>1ã€-t tableï¼šæŒ‡å®šè¡¨</b>
</p>

<p>
raw, mangle, nat, [filter]é»˜è®¤
</p>

<p>
<b>2ã€SUBCOMMANDï¼šå­å‘½ä»¤</b> <b>é“¾ç®¡ç†ç±»ï¼š</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">-N&#65306;new, &#33258;&#23450;&#20041;&#19968;&#26465;&#26032;&#30340;&#35268;&#21017;&#38142;
-E&#65306;&#37325;&#21629;&#21517;&#33258;&#23450;&#20041;&#38142;&#65307;&#24341;&#29992;&#35745;&#25968;&#19981;&#20026;0&#30340;&#33258;&#23450;&#20041;&#38142;&#19981;&#33021;&#22815;&#34987;&#37325;&#21629;&#21517;&#65292;&#20063;&#19981;&#33021;&#34987;&#21024;&#38500;
-X&#65306;delete&#65292;&#21024;&#38500;&#33258;&#23450;&#20041;&#30340;&#31354;&#30340;&#35268;&#21017;&#38142;

-P&#65306;Policy&#65292;&#35774;&#32622;&#40664;&#35748;&#31574;&#30053;&#65307;&#23545;filter&#34920;&#20013;&#30340;&#38142;&#32780;&#35328;&#65292;&#20854;&#40664;&#35748;&#31574;&#30053;&#26377;&#65306;ACCEPT&#65306;&#25509;&#21463;, DROP&#65306;&#20002;&#24323;&#12290;(&#19981;&#24314;&#35758;&#20462;&#25913;&#40664;&#35748;&#35268;&#21017;&#65292;&#21487;&#33021;&#40664;&#35748;&#25913;&#25104;DROP&#65292;iptables -F&#28165;&#31354;&#21518;&#26080;&#27861;&#20877;&#36830;&#25509;&#26381;&#21153;&#22120;)
</pre>
</div>

<p>
èŒƒä¾‹ï¼šåˆ›å»ºè‡ªå®šä¹‰é“¾å®ç°WEBçš„è®¿é—®æ§åˆ¶
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -N web_chain            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#33258;&#23450;&#20041;&#38142;&#65292;&#40664;&#35748;&#22312;filter&#34920;&#20013;</span>
[root@centos8 ~]#iptables -N web_chain -t nat     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;nat&#34920;&#20013;&#65292;&#21019;&#24314;&#33258;&#23450;&#20041;&#38142;</span>
[root@centos8 ~]#iptables -X web_chain -t nat     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;nat&#34920;&#20013;&#30340;web_chain&#38142;</span>
[root@centos8 ~]#iptables -E web_chain WEB_CHAIN  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;&#38142;&#21517;</span>
[root@centos8 ~]#iptables -A WEB_CHAIN -s 10.0.0.6 -p tcp -m multiport --dports 80,443 -j REJECT
[root@centos8 ~]#iptables -R WEB_CHAIN 1 -s 10.0.0.6 -p tcp -m multiport --dports 80,443,8080 -j REJECT

[root@centos8 ~]#iptables -vnL WEB_CHAIN
Chain WEB_CHAIN (1 references)
pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source        destination

  1   60 REJECT   tcp  -- *   *    10.0.0.6       0.0.0.0/0 
    multiport dports 80,443,8080 reject-with icmp-port-unreachable
[root@centos8 ~]#iptables -IINPUT 3 -s 10.0.0.0/24 -j WEB_CHAINN <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20851;&#32852;&#20869;&#32622;&#38142;&#20013;&#65292;&#33258;&#23450;&#20041;&#38142;&#25165;&#29983;&#25928;</span>
[root@centos8 ~]#iptables -IWEB_CHAIN 1 -s 10.0.0.6 -j RETURN    <span style="color: #b22222;"># </span><span style="color: #b22222;">-j RETURN &#22914;&#26524;&#28385;&#36275;&#36825;&#19968;&#26465;&#65292;&#19979;&#38754;&#30340;&#35268;&#21017;&#19981;&#25191;&#34892;&#20102;</span>
[root@centos6 ~]#curl 10.0.0.8
centos8 website
[root@centos6 ~]#curl 10.0.0.8
centos8 website
[root@centos6 ~]#ping -c1 10.0.0.8 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#33258;&#23450;&#20041;&#38142;&#65292;&#28165;&#31354;&#33258;&#23450;&#20041;&#38142;&#35268;&#21017;&#20877;&#21024;&#38500;&#21644;&#21019;&#24314;&#30340;&#39034;&#24207;&#30456;&#21453;</span>
[root@centos8 ~]#iptables -X WEB_CHAIN
iptables v1.8.2 (nf_tables): CHAIN_USER_DEL failed (Device or resource busy):chain WEB_CHAIN
[root@centos8 ~]#iptables -F WEB_CHAIN
[root@centos8 ~]#iptables -X WEB_CHAIN
iptables v1.8.2 (nf_tables): CHAIN_USER_DEL failed (Device or resource busy):
chain WEB_CHAIN
[root@centos8 ~]#iptables -D INPUT 1
[root@centos8 ~]#iptables -X WEB_CHAIN
</pre>
</div>

<p>
<b>æŸ¥çœ‹ç±»ï¼š</b>
</p>

<pre class="example" id="org38b76dc">
-Lï¼šlist, åˆ—å‡ºæŒ‡å®šé“¾ä¸Šçš„æ‰€æœ‰è§„åˆ™ï¼Œæœ¬é€‰é¡¹é¡»ç½®å
-nï¼šnumbericï¼Œä»¥æ•°å­—æ ¼å¼æ˜¾ç¤ºåœ°å€å’Œç«¯å£å·
-vï¼šverboseï¼Œè¯¦ç»†ä¿¡æ¯
-vv æ›´è¯¦ç»†
-xï¼šexactlyï¼Œæ˜¾ç¤ºè®¡æ•°å™¨ç»“æœçš„ç²¾ç¡®å€¼,è€Œéå•ä½è½¬æ¢åçš„æ˜“è¯»å€¼
--line-numbersï¼šæ˜¾ç¤ºè§„åˆ™çš„åºå·
-S selected,ä»¥iptables-save å‘½ä»¤æ ¼å¼æ˜¾ç¤ºé“¾ä¸Šè§„åˆ™
</pre>

<p>
<b>å¸¸ç”¨ç»„åˆï¼š</b>
</p>

<pre class="example" id="org2b7c5ab">
-vnL                   #è¯¦ç»†è¡¨çš„è§„åˆ™é“¾
-vvnxL --line-numbers  #æ˜¾ç¤ºè§„åˆ™ç¼–å·
</pre>

<p>
<b>è§„åˆ™ç®¡ç†ç±»ï¼š</b>
</p>

<pre class="example" id="orgf7eb408">
-Aï¼šappendï¼Œè¿½åŠ 
-Iï¼šinsert, æ’å…¥ï¼Œè¦æŒ‡æ˜æ’å…¥è‡³çš„è§„åˆ™ç¼–å·ï¼Œé»˜è®¤ä¸ºç¬¬ä¸€æ¡ã€‚å¦‚iptables -I INPUT 2 -s 10.0.0.6 ! -p icmp -j ACCEPT
-Dï¼šdeleteï¼Œåˆ é™¤
    (1) æŒ‡æ˜è§„åˆ™åºå· iptables -D 2
    (2) æŒ‡æ˜è§„åˆ™æœ¬èº«
-Rï¼šreplaceï¼Œæ›¿æ¢æŒ‡å®šé“¾ä¸Šçš„æŒ‡å®šè§„åˆ™ç¼–å·
-Fï¼šflushï¼Œæ¸…ç©ºæŒ‡å®šçš„è§„åˆ™é“¾ã€‚ä¸æŒ‡å®šé“¾åˆ™æ¸…ç†æ‰€æœ‰è§„åˆ™é“¾ã€‚æ³¨æ„é“¾çš„é»˜è®¤è§„åˆ™ä¸ä¼šæ¸…ç†ï¼Œä½¿ç”¨-Pä¿®æ”¹
-Zï¼šzeroï¼Œç½®é›¶
    iptablesçš„æ¯æ¡è§„åˆ™éƒ½æœ‰ä¸¤ä¸ªè®¡æ•°å™¨
    (1) åŒ¹é…åˆ°çš„æŠ¥æ–‡çš„ä¸ªæ•°
    (2) åŒ¹é…åˆ°çš„æ‰€æœ‰æŠ¥æ–‡çš„å¤§å°ä¹‹å’Œ
</pre>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -F OUTPUT

iptables -F  &#65306;&#28165;&#31354;&#25351;&#23450;&#30340;&#35268;&#21017;&#38142;&#12290;
iptables -X  &#65306;delete&#65292;&#21024;&#38500;&#33258;&#23450;&#20041;&#30340;&#31354;&#30340;&#35268;&#21017;&#38142;
iptables -Z  &#65306;&#32622;&#38646;,&#21253;&#20256;&#36755;&#32479;&#35745;&#28165;0,-vLn&#21487;&#30475;&#21040; 

iptables -R INPUT 2 -s 10.0.0.1 -j REJECT  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26367;&#25442;&#31532;2&#26465;&#35268;&#21017;</span>
</pre>
</div>

<p>
<b>3ã€chainï¼š</b>
</p>

<p>
PREROUTINGï¼ŒINPUTï¼ŒFORWARDï¼ŒOUTPUTï¼ŒPOSTROUTING
</p>

<p>
<b>4ã€åŒ¹é…æ¡ä»¶</b>
</p>

<ul class="org-ul">
<li>åŸºæœ¬ï¼šé€šç”¨çš„ï¼ŒPARAMETERS</li>
<li>æ‰©å±•ï¼šéœ€åŠ è½½æ¨¡å—ï¼ŒMATCH EXTENTIONS</li>
</ul>

<p>
<b>5ã€å¤„ç†åŠ¨ä½œï¼š</b>
</p>

<pre class="example" id="org058996e">
-j targetname [per-target-options]
</pre>

<p>
ç®€å•åŠ¨ä½œï¼š
</p>

<pre class="example" id="org615b30d">
ACCEPT    ï¼šå…è®¸æ•°æ®åŒ…é€šè¿‡
DROP      ï¼šä¸¢å¼ƒæ•°æ®åŒ…
</pre>

<p>
æ‰©å±•åŠ¨ä½œï¼š
</p>

<pre class="example" id="org2149a84">
REJECT    ï¼šæ‹’ç»æ•°æ®åŒ…ï¼ŒåŒæ—¶ç»™å‘é€è€…å‘é€æ²¡æœ‰æ¥å—çš„é€šçŸ¥ --reject-with:icmp-port-unreachableé»˜è®¤
RETURN    ï¼šç»“æŸå½“å‰è¿”å›è°ƒç”¨é“¾ï¼›
REDIRECT  ï¼šç«¯å£é‡å®šå‘ï¼›
LOG       ï¼šè®°å½•æ—¥å¿—ï¼›
MARK      ï¼šåšé˜²ç«å¢™æ ‡è®°ï¼›
DNAT      ï¼šç›®æ ‡åœ°å€è½¬æ¢ï¼›
SNAT      ï¼šæºåœ°å€è½¬æ¢ï¼›
MASQUERADEï¼šåœ°å€ä¼ªè£…ï¼›å…³é—­
è‡ªå®šä¹‰é“¾   ï¼š -j WEB_CHAIN # å…³è”å†…ç½®é“¾ä¸­ï¼Œè‡ªå®šä¹‰é“¾æ‰ç”Ÿæ•ˆ
</pre>
</div>
</div>
<div id="outline-container-h:5c6336b9-30df-4c45-b1be-d8b90d83105e" class="outline-4">
<h4 id="h:5c6336b9-30df-4c45-b1be-d8b90d83105e">iptables åŸºæœ¬åŒ¹é…æ¡ä»¶</h4>
<div class="outline-text-4" id="text-h:5c6336b9-30df-4c45-b1be-d8b90d83105e">
<p>
åŸºæœ¬åŒ¹é…æ¡ä»¶ï¼šæ— éœ€åŠ è½½æ¨¡å—ï¼Œç”±iptables/netfilterè‡ªè¡Œæä¾›
</p>

<div class="org-src-container">
<pre class="src src-sh">[!] -s, --source address[/mask][,...]&#65306;&#28304;IP&#22320;&#22336;&#25110;&#32773;&#19981;&#36830;&#32493;&#30340;IP&#22320;&#22336;&#65292;!&#24863;&#21497;&#21495;&#21462;&#21453;&#12290;
[!] -d, --destination address[/mask][,...]&#65306;&#30446;&#26631;IP&#22320;&#22336;&#25110;&#32773;&#19981;&#36830;&#32493;&#30340;IP&#22320;&#22336;
[!] -p, --protocol protocol&#65306;&#25351;&#23450;&#21327;&#35758;&#65292;&#21487;&#20351;&#29992;&#25968;&#23383;&#22914;0&#65288;all&#65289;
    protocol: tcp, udp, icmp, icmpv6, udplite,esp, ah, sctp, mh or&#8220;all&#8220; 
    &#21442;&#30475;&#65306;/etc/protocols
[!] -i, --in-interface name&#65306;&#25253;&#25991;&#27969;&#20837;&#30340;&#25509;&#21475;&#65307;&#21482;&#33021;&#24212;&#29992;&#20110;&#25968;&#25454;&#25253;&#25991;&#27969;&#20837;&#29615;&#33410;&#65292;&#21482;&#24212;&#29992;&#20110;INPUT&#12289;FORWARD&#12289;PREROUTING&#38142;
[!] -o, --out-interface name&#65306;&#25253;&#25991;&#27969;&#20986;&#30340;&#25509;&#21475;&#65307;&#21482;&#33021;&#24212;&#29992;&#20110;&#25968;&#25454;&#25253;&#25991;&#27969;&#20986;&#30340;&#29615;&#33410;&#65292;&#21482;&#24212;&#29992;&#20110;FORWARD&#12289;OUTPUT&#12289;POSTROUTING&#38142;
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -A INPUT -s 10.0.0.6,10.0.0.10 -j REJECT
[root@centos8 ~]#iptables -I INPUT -i lo -j ACCEPT <span style="color: #b22222;"># </span><span style="color: #b22222;">-I &#25554;&#20837;&#35268;&#21017; &#36825;&#37324;&#30465;&#30053;&#20102;1</span>
[root@centos8 ~]#curl 127.0.0.1
10.0.0.8
[root@centos8 ~]#curl 10.0.0.8
10.0.0.8

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#26159;icmp&#21327;&#35758;&#30340;&#35268;&#21017;&#20801;&#35768;&#36830;&#25509;</span>
[root@centos8 ~]#iptables -I INPUT 2 -s 10.0.0.6 ! -p icmp -j ACCEPT <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;&#31532;2&#26465;&#21069;&#38754;&#25554;&#20837;&#27530;&#26465;&#20214;&#35268;&#21017;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:499ad751-f61e-4bfa-a724-8a332d6949f6" class="outline-4">
<h4 id="h:499ad751-f61e-4bfa-a724-8a332d6949f6">iptables æ‰©å±•åŒ¹é…æ¡ä»¶</h4>
<div class="outline-text-4" id="text-h:499ad751-f61e-4bfa-a724-8a332d6949f6">
<p>
æ‰©å±•åŒ¹é…æ¡ä»¶ï¼šéœ€è¦åŠ è½½æ‰©å±•æ¨¡å—ï¼ˆ <code>/usr/lib64/xtables/*.so</code> ï¼‰ï¼Œæ–¹å¯ç”Ÿæ•ˆ
</p>

<p>
æ‰©å±•æ¨¡å—çš„æŸ¥çœ‹å¸®åŠ© ï¼šman iptables-extensions
</p>

<p>
æ‰©å±•åŒ¹é…æ¡ä»¶ï¼š
</p>

<ul class="org-ul">
<li>éšå¼æ‰©å±•</li>
<li>æ˜¾å¼æ‰©å±•</li>
</ul>
</div>
<div id="outline-container-h:2645cee0-4765-4cdb-94aa-56a69f3b4642" class="outline-5">
<h5 id="h:2645cee0-4765-4cdb-94aa-56a69f3b4642">éšå¼æ‰©å±•</h5>
<div class="outline-text-5" id="text-h:2645cee0-4765-4cdb-94aa-56a69f3b4642">
<p>
iptables
åœ¨ä½¿ç”¨ <code>-p</code> é€‰é¡¹æŒ‡æ˜äº†ç‰¹å®šçš„åè®®æ—¶ï¼Œæ— éœ€å†ç”¨-mé€‰é¡¹æŒ‡æ˜æ‰©å±•æ¨¡å—çš„æ‰©å±•æœºåˆ¶ï¼Œä¸éœ€è¦æ‰‹åŠ¨åŠ è½½æ‰©å±•æ¨¡å—
</p>

<p>
å¦‚ï¼š <code>-p tcp</code> çŸ¥é“æ˜¯tcpåè®®æ¨¡å—äº†å°±ä¸éœ€è¦æŒ‡æ˜ <code>-m tcp -p tcp</code> äº†
</p>

<p>
<b>tcp åè®®çš„æ‰©å±•é€‰é¡¹</b>
</p>

<pre class="example" id="orge75b0d3">
[!] --source-port, --sport port[:port]ï¼šåŒ¹é…æŠ¥æ–‡æºç«¯å£,å¯ä¸ºç«¯å£è¿ç»­èŒƒå›´
[!] --destination-port,--dport port[:port]ï¼šåŒ¹é…æŠ¥æ–‡ç›®æ ‡ç«¯å£,å¯ä¸ºè¿ç»­èŒƒå›´
[!] --tcp-flags mask comp
    mask éœ€æ£€æŸ¥çš„æ ‡å¿—ä½åˆ—è¡¨ï¼Œç”¨,åˆ†éš” , ä¾‹å¦‚ SYN,ACK,FIN,RST
    comp åœ¨maskåˆ—è¡¨ä¸­å¿…é¡»ä¸º1çš„æ ‡å¿—ä½åˆ—è¡¨ï¼Œæ— æŒ‡å®šåˆ™å¿…é¡»ä¸º0ï¼Œç”¨,åˆ†éš”tcpåè®®çš„æ‰©å±•é€‰é¡¹

[!] --synï¼šç”¨äºåŒ¹é…ç¬¬ä¸€æ¬¡æ¡æ‰‹, ç›¸å½“äºï¼š--tcp-flags SYN,ACK,FIN,RST SYN
</pre>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">--tcp-flags SYN,ACK,FIN,RST SYN     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#34920;&#31034;&#35201;&#26816;&#26597;&#30340;&#26631;&#24535;&#20301;&#20026;SYN,ACK,FIN,RST&#22235;&#20010;&#65292;&#20854;&#20013;SYN&#24517;&#39035;&#20026;1&#65292;&#20313;&#19979;&#30340;&#24517;&#39035;&#20026;0&#65292;&#31532;&#19968;&#27425;&#25569;&#25163;</span>
--tcp-flags SYN,ACK,FIN,RST SYN,ACK <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#20108;&#27425;&#25569;&#25163;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38169;&#35823;&#21253;</span>
--tcp-flags ALL ALL 
--tcp_flags ALL NONE
</pre>
</div>

<p>
<code>[!] --syn</code> ï¼šç”¨äºåŒ¹é…ç¬¬ä¸€æ¬¡æ¡æ‰‹, ç›¸å½“äºï¼š&#x2013;tcp-flags SYN,ACK,FIN,RST SYN
</p>

<p>
<b>udp åè®®çš„æ‰©å±•é€‰é¡¹</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[!] --source-port, --sport port[:port]&#65306;&#21305;&#37197;&#25253;&#25991;&#30340;&#28304;&#31471;&#21475;&#25110;&#31471;&#21475;&#33539;&#22260;
[!] --destination-port,--dport port[:port]&#65306;&#21305;&#37197;&#25253;&#25991;&#30340;&#30446;&#26631;&#31471;&#21475;&#25110;&#31471;&#21475;&#33539;&#22260;
</pre>
</div>

<p>
<b>icmp åè®®çš„æ‰©å±•é€‰é¡¹</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[!] --icmp-type {<span style="color: #483d8b;">type</span>[/code]|typename}
    type/code
    0/0 &#160;echo-reply icmp&#24212;&#31572;
    8/0 &#160;echo-request icmp&#35831;&#27714;
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -A INPUT -s 10.0.0.6 -p tcp --dport 21:23 -j REJECT
[root@centos8 ~]#ipn
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num  pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source       
destination    
1     1   60 REJECT   tcp  -- *   *    10.0.0.6      
0.0.0.0/0      tcp dpts:21:23 reject-with icmp-port-unreachable
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num  pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source       
destination    
Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
num  pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source       
destination
</pre>
</div>

<p>
èŒƒä¾‹ï¼šTCPç¬¬ä¸€æ¬¡æ¡æ‰‹æ‹’ç»
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -A INPUT -p tcp --syn -j REJECT
</pre>
</div>

<p>
èŒƒä¾‹ï¼š10.0.0.6çš„pingçš„è¯·æ±‚åŒ…æ‹’ç»
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -I INPUT -s 10.0.0.6 -p icmp --icmp-type 8 -j REJECT
</pre>
</div>
</div>
</div>
<div id="outline-container-h:db740704-f14e-4018-943e-7b0820ca918b" class="outline-5">
<h5 id="h:db740704-f14e-4018-943e-7b0820ca918b">æ˜¾å¼æ‰©å±•åŠç›¸å…³æ¨¡å—</h5>
<div class="outline-text-5" id="text-h:db740704-f14e-4018-943e-7b0820ca918b">
<p>
æ˜¾ç¤ºæ‰©å±•å³å¿…é¡»ä½¿ç”¨ <code>-m</code> é€‰é¡¹æŒ‡æ˜è¦è°ƒç”¨çš„æ‰©å±•æ¨¡å—åç§°ï¼Œéœ€è¦æ‰‹åŠ¨åŠ è½½æ‰©å±•æ¨¡å—
</p>

<pre class="example" id="org3c16296">
[-m matchname [per-match-options]]
</pre>

<p>
<b>æ‰©å±•æ¨¡å—çš„ä½¿ç”¨å¸®åŠ©ï¼š</b>
</p>

<ul class="org-ul">
<li>CentOS 7,8: man iptables-extensions</li>
<li>CentOS 6: man iptables</li>
</ul>
</div>
<ul class="org-ul">
<li><a id="h:1f6788cc-b719-479f-8b72-c83cfb65cde1"></a>multiportæ‰©å±•<br>
<div class="outline-text-6" id="text-h:1f6788cc-b719-479f-8b72-c83cfb65cde1">
<p>
ä»¥ç¦»æ•£æ–¹å¼å®šä¹‰å¤šç«¯å£åŒ¹é…,æœ€å¤šæŒ‡å®š15ä¸ªç«¯å£
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#22810;&#20010;&#28304;&#31471;&#21475;&#65292;&#36830;&#32493;&#31471;&#21475;:&#20882;&#21495;&#20998;&#38548;&#65292;&#19981;&#36830;&#32493;&#31471;&#21475;,&#36887;&#21495;&#20998;&#38548;</span>
[!] --source-ports,--sports port[,port|,port:port]...

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#22810;&#20010;&#30446;&#26631;&#31471;&#21475;</span>
[!] --destination-ports,--dports port[,port|,port:port]...

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#20010;&#28304;&#25110;&#30446;&#26631;&#31471;</span>
[!] --ports port[,port|,port:port]...
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -A INPUT -s 172.16.0.0/16 -d 172.16.100.10 -p tcp -m multiport --dports 20:22,80 -j ACCEPT

[root@centos8 ~]#iptables -A INPUT -s 10.0.0.6 -p tcp -m multiport --dports 445,139 -j REJECT
[root@centos8 ~]#ipn
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num &#160;pkts bytes target &#160;&#160;prot opt<span style="color: #a020f0;"> in</span> &#160;&#160;out &#160;&#160;source &#160;&#160;&#160;&#160;&#160;&#160;
destination &#160;&#160;&#160;
1 &#160;&#160;&#160;&#160;2 &#160;120 REJECT &#160;&#160;tcp &#160;-- * &#160;&#160;* &#160;&#160;&#160;10.0.0.6 &#160;&#160;&#160;&#160;&#160;
0.0.0.0/0 &#160;&#160;&#160;&#160;&#160;multiport dports 445,139 reject-with icmp-port-unreachable
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num &#160;pkts bytes target &#160;&#160;prot opt<span style="color: #a020f0;"> in</span> &#160;&#160;out &#160;&#160;source &#160;&#160;&#160;&#160;&#160;&#160;
destination &#160;&#160;&#160;
Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
num &#160;pkts bytes target &#160;&#160;prot opt<span style="color: #a020f0;"> in</span> &#160;&#160;out &#160;&#160;source &#160;&#160;&#160;&#160;&#160;&#160;
destination
</pre>
</div>
</div>
</li>
<li><a id="h:b26b41b3-9493-4018-b8a6-087a1d1090a7"></a>iprangeæ‰©å±•<br>
<div class="outline-text-6" id="text-h:b26b41b3-9493-4018-b8a6-087a1d1090a7">
<p>
æŒ‡æ˜è¿ç»­çš„ï¼ˆä½†ä¸€èˆ¬ä¸æ˜¯æ•´ä¸ªç½‘ç»œï¼‰ipåœ°å€èŒƒå›´
</p>

<div class="org-src-container">
<pre class="src src-sh">[!] --src-range from[-to] &#28304;IP&#22320;&#22336;&#33539;&#22260;
[!] --dst-range from[-to] &#30446;&#26631;IP&#22320;&#22336;&#33539;&#22260;
</pre>
</div>

<p>
èŒƒä¾‹ï¼šæºipä»172.16.1.5åˆ°172.16.1.10è®¿é—®80ç«¯å£æ‹’ç»
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -A INPUT -d 172.16.1.100 -p tcp --dport 80 -m iprange --src-range 172.16.1.5-172.16.1.10 -j DROP
</pre>
</div>
</div>
</li>
<li><a id="h:b71c4829-d07a-43c0-92e5-176a3056c6d1"></a>macæ‰©å±•<br>
<div class="outline-text-6" id="text-h:b71c4829-d07a-43c0-92e5-176a3056c6d1">
<p>
mac æ¨¡å—å¯ä»¥æŒ‡æ˜æºMACåœ°å€,ï¼Œé€‚ç”¨äºï¼šPREROUTING, FORWARDï¼ŒINPUT chains
</p>

<div class="org-src-container">
<pre class="src src-sh">[!] --mac-source XX:XX:XX:XX:XX:XX
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#30446;&#26631;&#22320;&#22336;mac&#22320;&#22336;&#19981;&#26159;&#33258;&#24049;&#23601;&#36830;&#19981;&#36827;&#26469;&#65292;&#25152;&#20197;&#27809;&#26377;&#30446;&#26631;mac&#22320;&#22336;&#36873;&#39033;</span>
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -A INPUT -s 172.16.0.100 -m mac &#160;--mac-source 00:50:56:12:34:56 -j ACCEPT
iptables -A INPUT -s 172.16.0.100 &#160;-j REJECT
</pre>
</div>
</div>
</li>
<li><a id="h:d5efe97c-50d3-44c0-951c-c7c3d0865fff"></a>stringæ‰©å±•<br>
<div class="outline-text-6" id="text-h:d5efe97c-50d3-44c0-951c-c7c3d0865fff">
<p>
å¯¹æŠ¥æ–‡ä¸­çš„åº”ç”¨å±‚æ•°æ®åšå­—ç¬¦ä¸²æ¨¡å¼åŒ¹é…æ£€æµ‹
</p>

<pre class="example" id="org5297800">
--algo {bm|kmp} å­—ç¬¦ä¸²åŒ¹é…æ£€æµ‹ç®—æ³•
    bmï¼šBoyer-Moore
    kmpï¼šKnuth-Pratt-Morris
--from offset å¼€å§‹åç§»
--to offset Â ç»“æŸåç§»
[!] --string pattern è¦æ£€æµ‹çš„å­—ç¬¦ä¸²æ¨¡å¼
[!] --hex-string patternè¦æ£€æµ‹å­—ç¬¦ä¸²æ¨¡å¼ï¼Œ16è¿›åˆ¶æ ¼å¼
</pre>

<p>
èŒƒä¾‹ï¼šå“åº”ç«¯ï¼Œåˆ†æè®¿é—®é¡µé¢ä¸­æœ‰googleå­—ç¬¦çš„æ‹’ç»è®¿é—®
</p>

<p>
ä»¥å¤ªç½‘MACå¸§æ ¼å¼
</p>


<figure id="org1b9080d">
<img src="images/image-20210416202826772.png" alt="image-20210416202826772.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">iptables -A OUTPUT -p tcp --sport 80 -m string --algo bm --from 62 &#160;--string  <span style="color: #8b2252;">"google"</span> -j REJECT <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21069;62&#20010;&#23383;&#33410;&#20026;&#22266;&#23450;&#39318;&#37096;&#20449;&#24687;</span>
</pre>
</div>
</div>
</li>
<li><a id="h:72af7ebf-66bf-4a47-9847-5874afc4c906"></a>timeæ‰©å±•<br>
<div class="outline-text-6" id="text-h:72af7ebf-66bf-4a47-9847-5874afc4c906">
<p>
<b>æ³¨æ„ï¼šCentOS 8 æ­¤æ¨¡å—æœ‰é—®é¢˜</b>
</p>

<p>
æ ¹æ®å°†æŠ¥æ–‡åˆ°è¾¾çš„æ—¶é—´ä¸æŒ‡å®šçš„æ—¶é—´èŒƒå›´è¿›è¡ŒåŒ¹é…
</p>

<pre class="example" id="orgbdd229f">
--datestart YYYY[-MM[-DD[Thh[:mm[:ss]]]]] æ—¥æœŸ
--datestop YYYY[-MM[-DD[Thh[:mm[:ss]]]]]
--timestart hh:mm[:ss]    æ—¶é—´
--timestop hh:mm[:ss]
[!] --monthdays day[,day...]  æ¯ä¸ªæœˆçš„å‡ å·
[!] --weekdays day[,day...]  æ˜ŸæœŸå‡ ï¼Œ1 â€“ 7 åˆ†åˆ«è¡¨ç¤ºæ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸæ—¥
--kerneltzï¼šå†…æ ¸æ—¶åŒºï¼ˆå½“åœ°æ—¶é—´ï¼‰ï¼Œä¸å»ºè®®ä½¿ç”¨ï¼›CentOS 7 ç³»ç»Ÿé»˜è®¤ä¸º UTC
æ³¨æ„ï¼š centos6 ä¸æ”¯æŒkerneltz ï¼Œ--localtzæŒ‡å®šæœ¬åœ°æ—¶åŒº(é»˜è®¤)
</pre>

<p>
èŒƒä¾‹: CentOS 8 çš„timeæ¨¡å—é—®é¢˜
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -ql iptables |grep time
/usr/lib64/xtables/libxt_time.so
[root@centos8 ~]#iptables -A INPUT -m time --timestart 12:30 --timestop 13:30 -j ACCEPT <span style="color: #b22222;"># </span><span style="color: #b22222;">UTC&#26684;&#26519;&#26102;&#38388;12&#65306;30&#21040;13&#65306;30&#65292;&#20013;&#22269;&#26102;&#38388;20:30&#21040;21&#65306;30</span>
iptables v1.8.4 (nf_tables): Couldn<span style="color: #8b2252;">'t load match `time'</span>:No such file or directory
</pre>
</div>

<p>
èŒƒä¾‹: å…³äº &#x2013;kerneltz é€‰é¡¹
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#man iptables-extensions
The caveat with the kernel timezone is that Linux distributions may ignore to
<span style="color: #483d8b;">set</span> the kernel timezone,and instead only set the system time. Even if a
particular distribution does set the timezone at boot,it is usually does not
keep the kernel timezone offset - which is what changes on DST - up to date.
ntpd will not touch the kernel timezone, so running it will not resolve the
issue. As such,one may &#160;&#160;&#160;encounter a timezone that is always +0000, or one
that is wrong half of the time of the year. As such,using --kerneltz is highly
discouraged.
</pre>
</div>

<p>
èŒƒä¾‹ï¼šå‘¨å…­å‘¨æ—¥14:30åˆ°18:30è®¿é—®172.16.100.10çš„80ç«¯å£çš„æ‹’ç»
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#iptables -A INPUT -s 172.16.0.0/16 -d 172.16.100.10 -p tcp --dport 80 -m time --timestart 14:30 --timestop 18:30 --weekdays Sat,Sun --kerneltz -j DROP <span style="color: #b22222;"># </span><span style="color: #b22222;">--kerneltz &#24403;&#22320;&#26102;&#38388;&#19981;&#25512;&#33616;&#20351;&#29992;</span>
</pre>
</div>
</div>
</li>
<li><a id="h:bb6d31a5-d0b7-4827-a6ad-501317998f66"></a>connlimitæ‰©å±•<br>
<div class="outline-text-6" id="text-h:bb6d31a5-d0b7-4827-a6ad-501317998f66">
<p>
æ ¹æ®æ¯å®¢æˆ·ç«¯IPåšå¹¶å‘è¿æ¥æ•°æ•°é‡åŒ¹é…
</p>

<p>
å¯é˜²æ­¢Dos(Denial of Serviceï¼Œæ‹’ç»æœåŠ¡)æ”»å‡»
</p>

<div class="org-src-container">
<pre class="src src-sh">--connlimit-upto N  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#30340;&#25968;&#37327;&#23567;&#20110;&#31561;&#20110;N&#26102;&#21305;&#37197;</span>
--connlimit-above N <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#30340;&#25968;&#37327;&#22823;&#20110;N&#26102;&#21305;&#37197;</span>
</pre>
</div>

<p>
èŒƒä¾‹ï¼šè®¿é—®22ç«¯å£è¿æ¥æ•°å¤§äº2ä¸ªæ—¶æ‹’ç»è¿æ¥
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1.&#21033;&#29992;connlimit&#27169;&#22359;&#23558;&#21333;IP&#30340;&#24182;&#21457;&#35774;&#32622;&#20026;2&#65307;&#20250;&#35823;&#26432;&#20351;&#29992;NAT&#19978;&#32593;&#30340;&#29992;&#25143;&#65292;&#21487;&#20197;&#26681;&#25454;&#23454;&#38469;&#24773;&#20917;&#22686;&#22823;&#35813;&#20540;</span>
iptables -A INPUT -d 172.16.100.10 -p tcp --dport 22 -m connlimit --connlimit-above 2 -j REJECT

<span style="color: #b22222;">#</span><span style="color: #b22222;">2.&#21033;&#29992;recent&#21644;state&#27169;&#22359;&#38480;&#21046;&#21333;IP&#22312;300s&#20869;&#21482;&#33021;&#19982;&#26412;&#26426;&#24314;&#31435;2&#20010;&#26032;&#36830;&#25509;&#12290;&#34987;&#38480;&#21046;&#20116;&#20998;&#38047;&#21518;&#21363;&#21487;&#24674;&#22797;&#35775;&#38382;&#12290;</span>
iptables -I INPUT  -p tcp --dport 22 -m state --state NEW -m recent --set --name SSH
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35760;&#24405;&#35775;&#38382;tcp 22&#31471;&#21475;&#30340;&#26032;&#36830;&#25509;&#65292;&#35760;&#24405;&#21517;&#31216;&#20026;SSH&#12290;--set &#35760;&#24405;&#25968;&#25454;&#21253;&#30340;&#26469;&#28304;IP&#65292;&#22914;&#26524;IP&#24050;&#32463;&#23384;&#22312;&#23558;&#26356;&#26032;&#24050;&#32463;&#23384;&#22312;&#30340;&#26465;&#30446;</span>

iptables -I INPUT  -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 300 --hitcount 3 --name SSH -j LOG --log-prefix <span style="color: #8b2252;">"SSH Attach: "</span>
iptables -I INPUT  -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 300 --hitcount 3 --name SSH -j DROP
<span style="color: #b22222;">#</span><span style="color: #b22222;">SSH&#35760;&#24405;&#20013;&#30340;IP&#65292;300s&#20869;&#21457;&#36215;&#36229;&#36807;3&#27425;&#36830;&#25509;&#21017;&#25298;&#32477;&#27492;IP&#30340;&#36830;&#25509;&#12290;</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">--update &#26159;&#25351;&#27599;&#27425;&#24314;&#31435;&#36830;&#25509;&#37117;&#26356;&#26032;&#21015;&#34920;&#65307;</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">--seconds&#24517;&#39035;&#19982;--rcheck&#25110;&#32773;--update&#21516;&#26102;&#20351;&#29992;</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">--hitcount&#24517;&#39035;&#19982;--rcheck&#25110;&#32773;--update&#21516;&#26102;&#20351;&#29992;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">3.iptables&#30340;&#35760;&#24405;&#65306;/proc/net/xt_recent/SSH</span>
</pre>
</div>
</div>
</li>
<li><a id="h:9be1db23-ce50-40a1-b1ca-cdd2300a8d5a"></a>limitæ‰©å±•<br>
<div class="outline-text-6" id="text-h:9be1db23-ce50-40a1-b1ca-cdd2300a8d5a">
<p>
åŸºäºæ”¶å‘æŠ¥æ–‡çš„é€Ÿç‡åšåŒ¹é… , ä»¤ç‰Œæ¡¶è¿‡æ»¤å™¨
</p>

<div class="org-src-container">
<pre class="src src-sh">--limit-burst number <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21069;&#22810;&#23569;&#20010;&#21253;&#19981;&#38480;&#21046;</span>
--limit <span style="color: #b22222;">#</span><span style="color: #b22222;">[/second|/minute|/hour|/day]</span>
</pre>
</div>

<p>
èŒƒä¾‹ï¼šä»ç¬¬å…­ä¸ªåŒ…å¼€å§‹é™åˆ¶ï¼Œæ¯åˆ†é’Ÿå…è®¸10ä¸ªåŒ…
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -I INPUT -d 172.16.100.10 -p icmp --icmp-type 8 -m limit --limit 10/minute --limit-burst 5 -j ACCEPT
iptables -I INPUT 2 -p icmp -j REJECT
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -A INPUT -p icmp -m limit --limit-burst 10 --limit 20/minute -j ACCEPT
[root@centos8 ~]#iptables -A INPUT -p icmp -j REJECT
[root@centos6 ~]#ping 10.0.0.8
PING 192.168.39.8 (192.168.39.8) 56(84) bytes of data.
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=1 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.779 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=2 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.436 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=3 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.774 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=4 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.391 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=5 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.441 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=6 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.356 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=7 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.553 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=8 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.458 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=9 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.459 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=10 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.479 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=11 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.450 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=12 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.471 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=13 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.531 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=14 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.444 ms
From 192.168.39.8 <span style="color: #a0522d;">icmp_seq</span>=15 Destination Port Unreachable
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=16 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.668 ms
From 192.168.39.8 <span style="color: #a0522d;">icmp_seq</span>=17 Destination Port Unreachable
From 192.168.39.8 <span style="color: #a0522d;">icmp_seq</span>=18 Destination Port Unreachable
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=19 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.692 ms
From 192.168.39.8 <span style="color: #a0522d;">icmp_seq</span>=20 Destination Port Unreachable
From 192.168.39.8 <span style="color: #a0522d;">icmp_seq</span>=21 Destination Port Unreachable
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=22 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.651 ms
</pre>
</div>
</div>
</li>
<li><a id="h:8e05749a-1fca-4467-85f4-241fe5393518"></a>stateæ‰©å±•<br>
<div class="outline-text-6" id="text-h:8e05749a-1fca-4467-85f4-241fe5393518">
<p>
state æ‰©å±•æ¨¡å—ï¼Œå¯ä»¥æ ¹æ®â€è¿æ¥è¿½è¸ªæœºåˆ¶â€œå»æ£€æŸ¥è¿æ¥çš„çŠ¶æ€ï¼Œè¾ƒè€—èµ„æº
</p>

<p>
conntrackæœºåˆ¶ï¼šè¿½è¸ªæœ¬æœºä¸Šçš„è¯·æ±‚å’Œå“åº”ä¹‹é—´çš„å…³ç³»
</p>

<p>
<b>çŠ¶æ€ç±»å‹ï¼š</b>
</p>

<ul class="org-ul">
<li>NEWï¼šæ–°å‘å‡ºè¯·æ±‚ï¼›è¿æ¥è¿½è¸ªä¿¡æ¯åº“ä¸­ä¸å­˜åœ¨æ­¤è¿æ¥çš„ç›¸å…³ä¿¡æ¯æ¡ç›®ï¼Œå› æ­¤ï¼Œå°†å…¶è¯†åˆ«ä¸ºç¬¬ä¸€æ¬¡å‘å‡ºçš„è¯·æ±‚</li>
<li>ESTABLISHEDï¼šNEWçŠ¶æ€ä¹‹åï¼Œè¿æ¥è¿½è¸ªä¿¡æ¯åº“ä¸­ä¸ºå…¶å»ºç«‹çš„æ¡ç›®å¤±æ•ˆä¹‹å‰æœŸé—´å†…æ‰€è¿›è¡Œçš„é€šä¿¡çŠ¶æ€</li>
<li>RELATEDï¼šæ–°å‘èµ·çš„ä½†ä¸å·²æœ‰è¿æ¥ç›¸å…³è”çš„è¿æ¥ï¼Œå¦‚ï¼šftpåè®®ä¸­çš„æ•°æ®è¿æ¥ä¸å‘½ä»¤è¿æ¥ä¹‹é—´çš„å…³ç³»</li>
<li>INVALIDï¼šæ— æ•ˆçš„è¿æ¥ï¼Œå¦‚flagæ ‡è®°ä¸æ­£ç¡®</li>
<li>UNTRACKEDï¼šæœªè¿›è¡Œè¿½è¸ªçš„è¿æ¥ï¼Œå¦‚ï¼šrawè¡¨ä¸­å…³é—­è¿½è¸ª</li>
</ul>

<p>
å·²ç»è¿½è¸ªåˆ°çš„å¹¶è®°å½•ä¸‹æ¥çš„è¿æ¥ä¿¡æ¯åº“
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /proc/net/nf_conntrack
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49900 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49900 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49886 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49886 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49892 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49892 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49904 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49904 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49890 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49890 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49888 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49888 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49896 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49896 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49898 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49898 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49894 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49894 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49902 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49902 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
</pre>
</div>

<p>
è°ƒæ•´è¿æ¥è¿½è¸ªåŠŸèƒ½æ‰€èƒ½å¤Ÿå®¹çº³çš„æœ€å¤§è¿æ¥æ•°é‡
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /proc/sys/net/netfilter/nf_conntrack_max
26624
[root@centos8 ~]#cat /proc/sys/net/nf_conntrack_max
26624
</pre>
</div>

<p>
æŸ¥çœ‹è¿æ¥è·Ÿè¸ªæœ‰å¤šå°‘æ¡ç›®
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /proc/sys/net/netfilter/nf_conntrack_count
10
</pre>
</div>

<p>
ä¸åŒçš„åè®®çš„è¿æ¥è¿½è¸ªæ—¶é•¿
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ll /proc/sys/net/netfilter/
total 0
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_acct
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_buckets
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_checksum
-r--r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_count
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_dccp_loose
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_dccp_timeout_closereq
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_dccp_timeout_closing
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_dccp_timeout_open
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_dccp_timeout_partopen
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_dccp_timeout_request
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_dccp_timeout_respond
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_dccp_timeout_timewait
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_events
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_expect_max
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_generic_timeout
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_helper
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_icmp_timeout
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_log_invalid
-rw-r--r-- 1 root root 0 Mar 19 18:13 nf_conntrack_max
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_sctp_timeout_closed
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_sctp_timeout_cookie_echoed
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_sctp_timeout_cookie_wait
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_sctp_timeout_established
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_sctp_timeout_heartbeat_acked
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_sctp_timeout_heartbeat_sent
-rw-r--r-- 1 root root 0 Mar 19 18:14
nf_conntrack_sctp_timeout_shutdown_ack_sent
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_sctp_timeout_shutdown_recd
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_sctp_timeout_shutdown_sent
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_be_liberal
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_loose
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_max_retrans
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_close
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_close_wait
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_established
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_fin_wait
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_last_ack
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_max_retrans
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_syn_recv
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_syn_sent
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_time_wait
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_unacknowledged
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_timestamp
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_udp_timeout
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_udp_timeout_stream
dr-xr-xr-x 1 root root 0 Mar 19 18:14 nf_log
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_log_all_netns
</pre>
</div>

<p>
è¯´æ˜ï¼š
</p>

<ul class="org-ul">
<li>è¿æ¥è·Ÿè¸ªï¼Œéœ€è¦åŠ è½½æ¨¡å—ï¼š modprobe nf_conntrack_ipv4</li>
<li>å½“æœåŠ¡å™¨è¿æ¥å¤šäºæœ€å¤§è¿æ¥æ•°æ—¶dmesg å¯ä»¥è§‚å¯Ÿåˆ° ï¼škernel: ip_conntrack:
table full, dropping packeté”™è¯¯,å¹¶ä¸”å¯¼è‡´å»ºç«‹TCPè¿æ¥å¾ˆæ…¢ã€‚</li>
<li>å„ç§çŠ¶æ€çš„è¶…æ—¶åï¼Œé“¾æ¥ä¼šä»è¡¨ä¸­åˆ é™¤</li>
</ul>

<p>
èŒƒä¾‹:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#echo 1 &gt; /proc/sys/net/netfilter/nf_conntrack_max
[root@centos8 ~]#tail /var/log/messages
Jul &#160;8 10:03:53 centos8 kernel: nf_conntrack: nf_conntrack: table full, dropping
packet
[root@centos6 ~]#tail /var/log/messages
Jul &#160;8 09:51:16 centos6 kernel: nf_conntrack: table full, dropping packet.
</pre>
</div>

<p>
è¿æ¥è¿‡å¤šçš„è§£å†³æ–¹æ³•ä¸¤ä¸ªï¼š
</p>

<ol class="org-ol">
<li><p>
åŠ å¤§nf_conntrack_max å€¼
</p>

<div class="org-src-container">
<pre class="src src-sh">vi /etc/sysctl.conf
net.nf_conntrack_max = 393216
net.netfilter.nf_conntrack_max = 393216
</pre>
</div></li>

<li><p>
é™ä½ nf_conntrack timeoutæ—¶é—´
</p>

<div class="org-src-container">
<pre class="src src-sh">vi /etc/sysctl.conf
net.netfilter.nf_conntrack_tcp_timeout_established = 300
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120
iptables -t nat -L -n
</pre>
</div></li>
</ol>

<p>
æ ¼å¼ï¼š
</p>

<pre class="example" id="org3996ba2">
[!] --state state
</pre>

<p>
èŒƒä¾‹: ä¸å…è®¸10.0.0.7 è®¿é—®æœ¬æœº,ä½†æœ¬æœºå¯ä»¥è®¿é—®10.0.0.7
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -S
-P INPUT ACCEPT
-P FORWARD ACCEPT
-P OUTPUT ACCEPT
-A INPUT -s 10.0.0.1/32 -j ACCEPT
-A INPUT ! -s 10.0.0.7/32 -m state --state NEW -j ACCEPT
-A INPUT -m state --state ESTABLISHED -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-port-unreachable
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -A INPUT -d 172.16.1.10 -p tcp -m multiport --dports 22,80 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -s 172.16.1.10 -p tcp -m multiport --sports 22,80 -m state --state ESTABLISHED -j ACCEPT

[root@centos8 ~]#iptables -A INPUT -m state --state ESTABLISHED -j ACCEPT
[root@centos8 ~]#iptables -A INPUT -m state --state NEW -j REJECT
</pre>
</div>

<p>
<b>æ¡ˆä¾‹ï¼šå¼€æ”¾è¢«åŠ¨æ¨¡å¼çš„ftpæœåŠ¡</b> <b>CentOS 8 æ­¤æ¨¡å—æœ‰bug</b>
</p>

<ol class="org-ol">
<li><p>
è£…è½½ftpè¿æ¥è¿½è¸ªçš„ä¸“ç”¨æ¨¡å—ï¼š
</p>

<p>
è·Ÿè¸ªæ¨¡å—è·¯å¾„ï¼š/lib/modules/kernelversion/kernel/net/netfilter
</p>

<div class="org-src-container">
<pre class="src src-sh">vim /etc/sysconfig/iptables-config
<span style="color: #a0522d;">IPTABLES_MODULES</span>=&#8220;nf_conntrack_ftp<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">modprobe nf_conntrack_ftp</span>
</pre>
</div></li>

<li><p>
æ”¾è¡Œè¯·æ±‚æŠ¥æ–‡ï¼š
</p>

<p>
å‘½ä»¤è¿æ¥ï¼šNEW, ESTABLISHED
</p>

<p>
æ•°æ®è¿æ¥ï¼šRELATED, ESTABLISHED
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -I INPUT -d LocalIP -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -d LocalIP -p tcp --dport 21 -m state --state NEW -j ACCEPT
</pre>
</div></li>

<li><p>
æ”¾è¡Œå“åº”æŠ¥æ–‡ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -I OUTPUT -s LocalIP -p tcp -m state --state ESTABLISHED -j ACCEPT
</pre>
</div></li>
</ol>

<p>
èŒƒä¾‹ï¼šå¼€æ”¾è¢«åŠ¨æ¨¡å¼çš„ftpæœåŠ¡ç¤ºä¾‹
</p>

<div class="org-src-container">
<pre class="src src-sh">yum install vsftpd
systemctl start vsftpd
modprobe nf_conntrack_ftp
iptables -F
iptables -A INPUT &#160;-m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p tcp --dport 21 -m state --state NEW -j ACCEPT
iptables -A OUTPUT &#160;-m state --state ESTABLISHED -j ACCEPT
iptables -P INPUT DROP
iptables -P OUTPUT DROP
iptables -vnL
</pre>
</div>
</div>
</li>
<li><a id="h:fa44073d-9e30-445d-bb64-a7f89d5a1d92"></a>macæ‰©å±•<br>
<div class="outline-text-6" id="text-h:fa44073d-9e30-445d-bb64-a7f89d5a1d92">
<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1&#12289;&#38459;&#27490;MAC&#22320;&#22336;&#20026;XX:XX:XX:XX:XX:XX&#20027;&#26426;&#30340;&#25152;&#26377;&#36890;&#20449;&#65306;</span>
iptables -A INPUT -m mac --mac-source XX:XX:XX:XX:XX:XX -j DROP
iptables -A INPUT -s 192.168.1.3/32 -m mac --mac-source ab:cd:ef:ab:cd:ef  -p tcp -m tcp --dport 80  -j ACCEPT

<span style="color: #b22222;">#</span><span style="color: #b22222;">2&#12289;&#20801;&#35768;MAC&#22320;&#22336;&#20026;XX:XX:XX:XX:XX:XX&#20027;&#26426;&#35775;&#38382;22&#31471;&#21475;&#65306;</span>
iptables -A INPUT -p tcp --destination-port 22 -m mac --mac-source XX:XX:XX:XX:XX:XX -j ACCEPT

<span style="color: #b22222;">#</span><span style="color: #b22222;">3&#12289;&#20801;&#35768;IP&#22320;&#22336;&#20026;192.168.1.21&#65292;MAC&#22320;&#22336;&#20026;XX:XX:XX:XX:XX:XX&#30340;&#20027;&#26426;&#36890;&#20449;&#65292;&#25298;&#32477;&#22810;&#26377;&#20854;&#20182;&#20027;&#26426;&#65306;</span>
iptables -A INPUT -s 192.168.1.21 -m mac --mac-source XX:XX:XX:XX:XX:XX -j ACCEPT
iptables -P INPUT DROP

<span style="color: #b22222;">#</span><span style="color: #b22222;">4&#12289;&#21487;&#20197;&#20889;&#33050;&#26412;&#38480;&#21046;MAC&#65306;</span>
iptables -P FORWARD DROP
<span style="color: #a020f0;">for</span> mac<span style="color: #a020f0;"> in</span> $(<span style="color: #ff00ff;">cat ipaddressfile</span>); <span style="color: #a020f0;">do</span>
    iptables -A FORWARD -m mac --mac-source $<span style="color: #a0522d;">mac</span> -j ACCEPT
<span style="color: #a020f0;">done</span>
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:492bc41f-380a-477e-b662-1d16bc1bbf7e" class="outline-4">
<h4 id="h:492bc41f-380a-477e-b662-1d16bc1bbf7e">Target</h4>
<div class="outline-text-4" id="text-h:492bc41f-380a-477e-b662-1d16bc1bbf7e">
<p>
target åŒ…æ‹¬ä»¥ä¸‹ç±»å‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">&#33258;&#23450;&#20041;&#38142;, ACCEPT&#65292; DROP&#65292; REJECT&#65292;RETURN,LOG&#65292;SNAT&#65292;DNAT&#65292;REDIRECT&#65292;MASQUERADE

ACCEPT    &#65306;&#20801;&#35768;&#25968;&#25454;&#21253;&#36890;&#36807;
DROP      &#65306;&#20002;&#24323;&#25968;&#25454;&#21253;
REJECT    &#65306;&#25298;&#32477;&#25968;&#25454;&#21253;&#65292;&#21516;&#26102;&#32473;&#21457;&#36865;&#32773;&#21457;&#36865;&#27809;&#26377;&#25509;&#21463;&#30340;&#36890;&#30693;
RETURN    &#65306;&#32467;&#26463;&#24403;&#21069;&#36820;&#22238;&#35843;&#29992;&#38142;&#65307;
REDIRECT  &#65306;&#31471;&#21475;&#37325;&#23450;&#21521;&#65307;
LOG       &#65306;&#38750;&#20013;&#26029;target,&#26412;&#36523;&#19981;&#25298;&#32477;&#21644;&#20801;&#35768;,&#25918;&#22312;&#25298;&#32477;&#21644;&#20801;&#35768;&#35268;&#21017;&#21069;&#65292;&#24182;&#23558;&#26085;&#24535;&#35760;&#24405;&#22312;/var/log/messages&#31995;&#32479;&#26085;&#24535;&#20013;
MARK      &#65306;&#20570;&#38450;&#28779;&#22681;&#26631;&#35760;&#65307;
DNAT      &#65306;&#30446;&#26631;&#22320;&#22336;&#36716;&#25442;&#65307;
SNAT      &#65306;&#28304;&#22320;&#22336;&#36716;&#25442;&#65307;
MASQUERADE&#65306;&#22320;&#22336;&#20266;&#35013;&#65307;&#20851;&#38381;
&#33258;&#23450;&#20041;&#38142;   &#65306;-j &#38142;&#21517; <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20851;&#32852;&#20869;&#32622;&#38142;&#20013;&#65292;&#33258;&#23450;&#20041;&#38142;&#25165;&#29983;&#25928;</span>

--log-level level &#160;&#32423;&#21035;&#65306; debug&#65292;info&#65292;notice, warning, error, crit, alert,emerg
--log-prefix prefix &#26085;&#24535;&#21069;&#32512;&#65292;&#29992;&#20110;&#21306;&#21035;&#19981;&#21516;&#30340;&#26085;&#24535;&#65292;&#26368;&#22810;29&#20010;&#23383;&#31526;
</pre>
</div>

<p>
èŒƒä¾‹ï¼šæ–°å‘èµ·çš„è¯·æ±‚ï¼Œè®°å½•iptables è§„åˆ™æ—¥å¿—
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -I INPUT -s 10.0.0.0/24 -p tcp -m multiport --dports 80,21,22,23 -m state --state NEW -j LOG --log-prefix <span style="color: #8b2252;">"new connections: "</span>

[root@centos8 ~]#tail -f /var/log/messages
Mar 19 18:41:07 centos8 kernel: iptables tcp connection: <span style="color: #a0522d;">IN</span>=eth0 <span style="color: #a0522d;">OUT</span>=
<span style="color: #a0522d;">MAC</span>=00:0c:29:f8:5d:b7:00:50:56:c0:00:08:08:00 <span style="color: #a0522d;">SRC</span>=10.0.0.1 <span style="color: #a0522d;">DST</span>=10.0.0.8 <span style="color: #a0522d;">LEN</span>=40
<span style="color: #a0522d;">TOS</span>=0x00 <span style="color: #a0522d;">PREC</span>=0x00 <span style="color: #a0522d;">TTL</span>=128 <span style="color: #a0522d;">ID</span>=43974 DF <span style="color: #a0522d;">PROTO</span>=TCP <span style="color: #a0522d;">SPT</span>=9844 <span style="color: #a0522d;">DPT</span>=22 <span style="color: #a0522d;">WINDOW</span>=4102
<span style="color: #a0522d;">RES</span>=0x00 ACK <span style="color: #a0522d;">URGP</span>=0
Mar 19 18:41:07 centos8 kernel: new connections: <span style="color: #a0522d;">IN</span>=eth0 <span style="color: #a0522d;">OUT</span>=
<span style="color: #a0522d;">MAC</span>=00:0c:29:f8:5d:b7:00:50:56:c0:00:08:08:00 <span style="color: #a0522d;">SRC</span>=10.0.0.1 <span style="color: #a0522d;">DST</span>=10.0.0.8 <span style="color: #a0522d;">LEN</span>=40
<span style="color: #a0522d;">TOS</span>=0x00 <span style="color: #a0522d;">PREC</span>=0x00 <span style="color: #a0522d;">TTL</span>=128 <span style="color: #a0522d;">ID</span>=43975 DF <span style="color: #a0522d;">PROTO</span>=TCP <span style="color: #a0522d;">SPT</span>=9844 <span style="color: #a0522d;">DPT</span>=22 <span style="color: #a0522d;">WINDOW</span>=4102
<span style="color: #a0522d;">RES</span>=0x00 ACK <span style="color: #a0522d;">URGP</span>=0
Mar 19 18:41:08 centos8 kernel: new connections: <span style="color: #a0522d;">IN</span>=eth0 <span style="color: #a0522d;">OUT</span>=
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -R INPUT 2 -p tcp --dport 21 -m state --state NEW -j LOG --log-prefix <span style="color: #8b2252;">"ftp new link: "</span>

[root@centos8 ~]#tail -f /var/log/messages
Dec 21 10:02:31 centos8 kernel: ftp new link: <span style="color: #a0522d;">IN</span>=eth0 <span style="color: #a0522d;">OUT</span>=
<span style="color: #a0522d;">MAC</span>=00:0c:29:f9:8d:90:00:0c:29:10:8a:b1:08:00 <span style="color: #a0522d;">SRC</span>=192.168.39.6 <span style="color: #a0522d;">DST</span>=192.168.39.8
<span style="color: #a0522d;">LEN</span>=60 <span style="color: #a0522d;">TOS</span>=0x00 <span style="color: #a0522d;">PREC</span>=0x00 <span style="color: #a0522d;">TTL</span>=64 <span style="color: #a0522d;">ID</span>=15556 DF <span style="color: #a0522d;">PROTO</span>=TCP <span style="color: #a0522d;">SPT</span>=53706 <span style="color: #a0522d;">DPT</span>=21
<span style="color: #a0522d;">WINDOW</span>=14600 <span style="color: #a0522d;">RES</span>=0x00 SYN <span style="color: #a0522d;">URGP</span>=0
</pre>
</div>
</div>
</div>
<div id="outline-container-h:10f4bdee-c93a-48a2-83bd-26a34d37753e" class="outline-4">
<h4 id="h:10f4bdee-c93a-48a2-83bd-26a34d37753e">è§„åˆ™ä¼˜åŒ–æœ€ä½³å®è·µ</h4>
<div class="outline-text-4" id="text-h:10f4bdee-c93a-48a2-83bd-26a34d37753e">
<ol class="org-ol">
<li>å®‰å…¨æ”¾è¡Œæ‰€æœ‰å…¥ç«™å’Œå‡ºç«™çš„çŠ¶æ€ä¸ºESTABLISHEDçŠ¶æ€è¿æ¥,å»ºè®®æ”¾åœ¨ç¬¬ä¸€æ¡ï¼Œæ•ˆç‡æ›´é«˜</li>

<li>è°¨æ…æ”¾è¡Œå…¥ç«™çš„æ–°è¯·æ±‚</li>

<li>æœ‰ç‰¹æ®Šç›®çš„é™åˆ¶è®¿é—®åŠŸèƒ½ï¼Œè¦åœ¨æ”¾è¡Œè§„åˆ™ä¹‹å‰åŠ ä»¥æ‹’ç»</li>

<li>åŒç±»è§„åˆ™ï¼ˆè®¿é—®åŒä¸€åº”ç”¨ï¼Œæ¯”å¦‚ï¼šhttpï¼‰ï¼ŒåŒ¹é…èŒƒå›´å°çš„æ”¾åœ¨å‰é¢ï¼Œç”¨äºç‰¹
æ®Šå¤„ç†</li>

<li><p>
ä¸åŒç±»çš„è§„åˆ™ï¼ˆè®¿é—®ä¸åŒåº”ç”¨ï¼Œä¸€ä¸ªæ˜¯httpï¼Œå¦ä¸€ä¸ªæ˜¯mysqlï¼‰ï¼ŒåŒ¹é…èŒƒå›´å¤§
çš„æ”¾åœ¨å‰é¢ï¼Œæ•ˆç‡æ›´é«˜
</p>

<div class="org-src-container">
<pre class="src src-sh">-s 10.0.0.6 -p tcp --dport 3306 -j REJECT
-s 172.16.0.0/16 -p tcp --dport 80 -j REJECT
</pre>
</div></li>

<li>åº”è¯¥å°†é‚£äº›å¯ç”±ä¸€æ¡è§„åˆ™èƒ½å¤Ÿæè¿°çš„å¤šä¸ªè§„åˆ™åˆå¹¶ä¸ºä¸€æ¡ï¼Œå‡å°‘è§„åˆ™æ•°é‡,æé«˜æ£€æŸ¥æ•ˆç‡</li>

<li>è®¾ç½®é»˜è®¤ç­–ç•¥ï¼Œå»ºè®®ç™½åå•ï¼ˆåªæ”¾è¡Œç‰¹å®šè¿æ¥ï¼‰

<ul class="org-ul">
<li>iptables -Pï¼Œä¸å»ºè®®ï¼Œå®¹æ˜“å‡ºç°â€œè‡ªæ€ç°è±¡â€</li>
<li>è§„åˆ™çš„æœ€åå®šä¹‰è§„åˆ™åšä¸ºé»˜è®¤ç­–ç•¥ï¼Œæ¨èä½¿ç”¨ï¼Œæ”¾åœ¨æœ€åä¸€æ¡</li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-h:26466bfc-e2d9-4a5b-a7d0-834436c081c9" class="outline-4">
<h4 id="h:26466bfc-e2d9-4a5b-a7d0-834436c081c9">iptablesè§„åˆ™ä¿å­˜</h4>
<div class="outline-text-4" id="text-h:26466bfc-e2d9-4a5b-a7d0-834436c081c9">
<p>
ä½¿ç”¨iptableså‘½ä»¤å®šä¹‰çš„è§„åˆ™ï¼Œæ‰‹åŠ¨åˆ é™¤ä¹‹å‰ï¼Œå…¶ç”Ÿæ•ˆæœŸé™ä¸ºkernelå­˜æ´»æœŸé™
<b>æŒä¹…ä¿å­˜è§„åˆ™ï¼š</b>
</p>

<p>
CentOS 7,8
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables-save &gt; /PATH/TO/SOME_RULES_FILE
</pre>
</div>

<p>
CentOS 6
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#35268;&#21017;&#35206;&#30422;&#20445;&#23384;&#33267;/etc/sysconfig/iptables&#25991;&#20214;&#20013;</span>
service iptables save
</pre>
</div>

<p>
<b>åŠ è½½è§„åˆ™</b>
</p>

<p>
CentOS 7,8 é‡æ–°è½½å…¥é¢„å­˜è§„åˆ™æ–‡ä»¶ä¸­è§„åˆ™ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables-restore &lt; /PATH/FROM/SOME_RULES_FILE
</pre>
</div>

<p>
iptables-restoreé€‰é¡¹
</p>

<pre class="example" id="org81663e9">
-n, --noflushï¼šä¸æ¸…é™¤åŸæœ‰è§„åˆ™
-t, --testï¼šä»…åˆ†æç”Ÿæˆè§„åˆ™é›†ï¼Œä½†ä¸æäº¤
</pre>

<p>
CentOS 6ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20250;&#33258;&#21160;&#20174;/etc/sysconfig/iptables &#37325;&#26032;&#36733;&#20837;&#35268;&#21017;</span>
service iptables &#160;restart
</pre>
</div>

<p>
<b>å¼€æœºè‡ªåŠ¨é‡è½½è§„åˆ™</b>
</p>

<ul class="org-ul">
<li><p>
ç”¨è„šæœ¬ä¿å­˜å„iptableså‘½ä»¤ï¼›è®©æ­¤è„šæœ¬å¼€æœºåè‡ªåŠ¨è¿è¡Œ
</p>

<p>
/etc/rc.d/rc.localæ–‡ä»¶ä¸­æ·»åŠ è„šæœ¬è·¯å¾„ /PATH/TO/SOME_SCRIPT_FILE
</p></li>

<li><p>
ç”¨è§„åˆ™æ–‡ä»¶ä¿å­˜å„è§„åˆ™ï¼Œå¼€æœºæ—¶è‡ªåŠ¨è½½å…¥æ­¤è§„åˆ™æ–‡ä»¶ä¸­çš„è§„åˆ™
</p>

<p>
åœ¨/etc/rc.d/rc.localæ–‡ä»¶æ·»åŠ 
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables-restore &lt; /PATH/FROM/IPTABLES_RULES_FILE
</pre>
</div>

<p>
å®šä¹‰Unit File, CentOS 7ï¼Œ8 å¯ä»¥å®‰è£… iptables-services å®ç°iptables.service
</p>

<p>
èŒƒä¾‹: CentOS 7ï¼Œ8 ä½¿ç”¨ iptables-services
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum -y install iptables-services <span style="color: #b22222;"># </span><span style="color: #b22222;">centos8&#19981;&#24314;&#35758;&#23433;&#35013;&#65292;&#21644;firewalld&#20914;&#31361;</span>
[root@centos8 ~]#cp /etc/sysconfig/iptables{,.bak}

&#8203;# &#20445;&#23384;&#29616;&#22312;&#30340;&#35268;&#21017;&#21040;&#25991;&#20214;&#20013;&#26041;&#27861;1
[root@centos8 ~]#/usr/libexec/iptables/iptables.init save

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20445;&#23384;&#29616;&#22312;&#30340;&#35268;&#21017;&#21040;&#25991;&#20214;&#20013;&#26041;&#27861;2</span>
[root@centos8 ~]#iptables-save &gt; /etc/sysconfig/iptables

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#26426;&#21551;&#21160;</span>
[root@centos8 ~]#systemctl enable iptables.service
[root@centos8 ~]#systemctl mask firewalld.service nftables.service
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-h:52fe8afa-e499-42b4-becc-7e55b77a174b" class="outline-4">
<h4 id="h:52fe8afa-e499-42b4-becc-7e55b77a174b">ç½‘ç»œé˜²ç«å¢™</h4>
<div class="outline-text-4" id="text-h:52fe8afa-e499-42b4-becc-7e55b77a174b">
<p>
iptables/netfilter åˆ©ç”¨filterè¡¨çš„FORWARDé“¾,å¯ä»¥å……å½“ç½‘ç»œé˜²ç«å¢™ï¼š
</p>

<p>
æ³¨æ„çš„é—®é¢˜ï¼š
</p>
<ol class="org-ol">
<li>è¯·æ±‚-å“åº”æŠ¥æ–‡å‡ä¼šç»ç”±FORWARDé“¾ï¼Œè¦æ³¨æ„è§„åˆ™çš„æ–¹å‘æ€§</li>
<li>å¦‚æœè¦å¯ç”¨conntrackæœºåˆ¶ï¼Œå»ºè®®å°†åŒæ–¹å‘çš„çŠ¶æ€ä¸ºESTABLISHEDçš„æŠ¥æ–‡ç›´æ¥æ”¾è¡Œ</li>
</ol>
</div>
<div id="outline-container-h:8b5c1a05-da52-41c1-94bc-a4ed9778fb98" class="outline-5">
<h5 id="h:8b5c1a05-da52-41c1-94bc-a4ed9778fb98">FORWARD é“¾å®ç°å†…å¤–ç½‘ç»œçš„æµé‡æ§åˆ¶</h5>
<div class="outline-text-5" id="text-h:8b5c1a05-da52-41c1-94bc-a4ed9778fb98">
<p>
èŒƒä¾‹: å®ç°å†…ç½‘è®¿é—®å¯ä»¥è®¿é—®å¤–ç½‘,åä¹‹ç¦æ­¢
</p>


<figure id="org45a1ffe">
<img src="./images/image-20210217101112651.png" alt="image-20210217101112651.png">

</figure>

<p>
é˜²ç«å¢™æœåŠ¡å™¨firewallï¼šeth0ç½‘å¡ NATç½‘ç»œ 10.0.0.8/24ï¼Œeth1ç½‘å¡ä»…ä¸»æœº 192.168.0.8/24
</p>

<p>
å…¬å¸å¤–éƒ¨æœåŠ¡å™¨internetï¼šeth0 ä»…ä¸»æœº 192.168.0.6/24 ç½‘å…³æŒ‡å®šé˜²ç«å¢™ 192.168.0.8
</p>

<p>
å…¬å¸å†…éƒ¨æœåŠ¡å™¨LanServer1ï¼šeth0 NATç½‘ç»œ 10.0.0.7/24 ç½‘å…³æŒ‡å®šé˜²ç«å¢™ 10.0.0.8
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1.&#29615;&#22659;&#20934;&#22791;&#65292;&#30830;&#20445;&#27809;&#26377;&#38450;&#28779;&#22681;&#35268;&#21017;&#26102;&#21487;&#20197;&#20114;&#36890;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">internet&#20462;&#25913;eth0&#32593;&#21345;&#37197;&#32622; 192.168.0.6/24 &#32593;&#20851;&#25351;&#23450;&#38450;&#28779;&#22681; 192.168.0.8</span>
[root@internet ~]#hostname -I
192.168.0.6
[root@internet ~]#route -n
0.0.0.0     192.168.0.8   0.0.0.0     UG   0    0     0 eth0

<span style="color: #b22222;"># </span><span style="color: #b22222;">firewall &#20462;&#25913;&#32593;&#21345;&#37197;&#32622; eth0&#32593;&#21345;10.0.0.8/24&#19981;&#38656;&#35201;&#37197;&#32622;&#32593;&#20851;DNS&#65292;eth1 192.168.0.8/24&#19981;&#38656;&#35201;&#37197;&#32622;&#32593;&#20851;DNS&#65292; &#24320;&#21551;&#36335;&#30001;&#36716;&#21457;</span>
[root@firewall ~]#hostname -I
10.0.0.8 192.168.0.8
[root@firewall ~]#vim /etc/sysctl.conf
net.ipv4.ip_forward=1
[root@firewall ~]#sysctl -p

<span style="color: #b22222;"># </span><span style="color: #b22222;">LanServer1 &#20462;&#25913;&#32593;&#21345;&#37197;&#32622; eth0 10.0.0.7/24 &#32593;&#20851;&#25351;&#23450;&#38450;&#28779;&#22681; 10.0.0.8</span>
[root@lanserver1 ~]#hostname -I
10.0.0.7
[root@lanserver1 ~]#route -n
0.0.0.0     10.0.0.8     0.0.0.0     UG   100   0     0 eth0

[root@lanserver2 ~]#hostname -I
10.0.0.17
[root@lanserver2 ~]#route -n
0.0.0.0     10.0.0.8     0.0.0.0     UG   100   0     0 eth0

<span style="color: #b22222;"># </span><span style="color: #b22222;">2.&#37197;&#32622;&#38450;&#28779;&#22681;&#35268;&#21017;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1 &#36890;&#36807;&#26631;&#20934;&#27169;&#22359;&#23454;&#29616;&#20869;&#32593;&#35775;&#38382;&#22806;&#32593;,&#21453;&#20043;&#31105;&#27490;</span>
[root@firewall ~]#iptables -AFORWARD -j REJECT
[root@firewall ~]#iptables -IFORWARD -s 10.0.0.0/24 -p tcp --dport 80 -j ACCEPT        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#37096;&#35775;&#38382;&#22806;&#37096;http&#26381;&#21153;</span>
[root@firewall ~]#iptables -IFORWARD -d 10.0.0.0/24 -p tcp --sport 80 -j ACCEPT        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22806;&#37096;http&#26381;&#21153;&#21709;&#24212;&#20869;&#37096;</span>
[root@firewall ~]#iptables -I FORWARD  -s 10.0.0.0/24 -p icmp --icmp-type 8 -j ACCEPT  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#37096;&#35831;&#27714;&#21253;</span>
[root@firewall ~]#iptables -I FORWARD  -d 10.0.0.0/24 -p icmp --icmp-type 0 -j ACCEPT  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22806;&#37096;&#21709;&#24212;&#21253;</span>
[root@firewall ~]#iptables -vnL --line-numbers


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2 &#21033;&#29992;state&#27169;&#22359;&#23454;&#29616;&#20869;&#32593;&#35775;&#38382;&#21487;&#20197;&#35775;&#38382;&#22806;&#32593;,&#21453;&#20043;&#31105;&#27490;</span>
[root@firewall ~]#iptables -AFORWARD -j REJECT
[root@firewall ~]#iptables -I FORWARD  -s 10.0.0.0/24 -p icmp --icmp-type 8 -j ACCEPT  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#37096;&#35831;&#27714;&#21253;</span>
[root@firewall ~]#iptables -IFORWARD -s 10.0.0.0/24 -p tcp --dport 80 -j ACCEPT        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#37096;&#35775;&#38382;&#22806;&#37096;http&#26381;&#21153;</span>
[root@firewall ~]#iptables -IFORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22806;&#37096;&#21709;&#24212;&#30340;&#21253;&#37117;&#26159;ESTABLISHED</span>
[root@firewall ~]#iptables -vnL --line-numbers
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;</span>
[root@lanserver1 ~]#ping 192.168.0.6 -c1
64 bytes from 192.168.0.6: <span style="color: #a0522d;">icmp_seq</span>=1 <span style="color: #a0522d;">ttl</span>=63 <span style="color: #a0522d;">time</span>=2.20 ms
[root@lanserver2 ~]#curl 192.168.0.6
internet
[root@internet ~]#ping 10.0.0.7 -c1
From 192.168.0.8 <span style="color: #a0522d;">icmp_seq</span>=1 Destination Port Unreachable
[root@internet ~]#curl 10.0.0.7
curl: (7) couldn<span style="color: #8b2252;">'t connect to host</span>

<span style="color: #8b2252;">#&#21033;&#29992;state&#27169;&#22359;&#23454;&#29616;&#20801;&#35768;&#20869;&#32593;&#21487;&#20197;&#35775;&#38382;&#22806;&#32593;&#25152;&#26377;&#36164;&#28304;</span>
<span style="color: #8b2252;">[root@firewall ~]#iptables -AFORWARD -j REJECT</span>
<span style="color: #8b2252;">[root@firewall ~]#iptables -IFORWARD 2 -s 10.0.0.0/24 -m state --state NEW -j ACCEPT   #&#20869;&#37096;&#35831;&#27714;&#21253;</span>
<span style="color: #8b2252;">[root@firewall ~]#iptables -IFORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT    #&#22806;&#37096;&#21709;&#24212;&#30340;&#21253;&#37117;&#26159;ESTABLISHED</span>
<span style="color: #8b2252;">[root@firewall ~]#iptables -vnL --line-numbers</span>
<span style="color: #8b2252;">#&#39564;&#35777;</span>
<span style="color: #8b2252;">[root@lanserver1 ~]#ping 192.168.0.6 -c1</span>
<span style="color: #8b2252;">64 bytes from 192.168.0.6: icmp_seq=1 ttl=63 time=2.26 ms</span>
<span style="color: #8b2252;">[root@lanserver2 ~]#curl 192.168.0.6</span>
<span style="color: #8b2252;">internet</span>
<span style="color: #8b2252;">[root@lanserver2 ~]#ssh 192.168.0.6</span>
<span style="color: #8b2252;">Are you sure you want to continue connecting (yes/no)?</span>
<span style="color: #8b2252;">[root@internet ~]#curl 10.0.0.7</span>
<span style="color: #8b2252;">curl: (7) couldn'</span>t connect to host
[root@internet ~]#ping 10.0.0.7 -c1
From 192.168.0.8 <span style="color: #a0522d;">icmp_seq</span>=1 Destination Port Unreachable
[root@internet ~]#ssh 10.0.0.7
ssh: connect to host 10.0.0.7 port 22: Connection refused

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20801;&#35768;&#20869;&#32593;&#25351;&#23450;&#20027;&#26426;&#34987;&#22806;&#32593;&#35775;&#38382;</span>
[root@firewall ~]#iptables -IFORWARD 3 -d 10.0.0.7 -p tcp --dport 80 -j ACCEPT
[root@firewall ~]#iptables -vnL --line-numbers
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;</span>
[root@internet ~]#curl 10.0.0.7
lanserver1
[root@internet ~]#ping 10.0.0.7 -c1
From 192.168.0.8 <span style="color: #a0522d;">icmp_seq</span>=1 Destination Port Unreachable
[root@internet ~]#curl 10.0.0.17
curl: (7) couldn<span style="color: #8b2252;">'t connect to host</span>
</pre>
</div>

<p>
èŒƒä¾‹ï¼šå†…éƒ¨å¯ä»¥è®¿é—®å¤–éƒ¨ï¼Œå¤–éƒ¨ç¦æ­¢è®¿é—®å†…éƒ¨
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@internet-host ~]#hostname -I
10.0.0.6
[root@internet-host ~]#route -n
Kernel IP routing table
Destination   Gateway     Genmask     Flags Metric Ref  Use Iface
10.0.0.0     0.0.0.0     255.255.255.0  U   1    0     0 eth0
0.0.0.0     10.0.0.8     0.0.0.0     UG   0    0     0 eth0

[root@firewall-host ~]#hostname -I
10.0.0.8 192.168.100.8

[root@lan-host ~]#hostname -I
192.168.100.7
[root@lan-host ~]#route -n
Kernel IP routing table
Destination   Gateway     Genmask     Flags Metric Ref  Use Iface
0.0.0.0     192.168.100.8  0.0.0.0     UG   100   0     0 eth0
192.168.100.0  0.0.0.0     255.255.255.0  U   100   0     0 eth0

[root@firewall-host ~]#vim /etc/sysctl.conf
net.ipv4.ip_forward=1
[root@firewall-host ~]#sysctl -p
[root@firewall-host ~]#iptables -A FORWARD -d 192.168.100.0/24 -m state --state NEW -j REJECT
</pre>
</div>

<p>
èŒƒä¾‹ï¼šé’ˆå¯¹å†…éƒ¨çš„ç‰¹å®šæœåŠ¡å¯ä»¥å…è®¸å¤–éƒ¨è®¿é—®ï¼Œå…¶å®ƒæœåŠ¡ç¦æ­¢è®¿é—®
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@firewall-host ~]#iptables -I FORWARD -d 192.168.100.0/24 -p tcp --dport 80 -j ACCEPT
[root@firewall-host ~]#iptables -vnL FORWARD --line-numbers
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num  pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source       
destination    
1     6  486 ACCEPT   tcp  -- *   *    0.0.0.0/0     
 192.168.100.0/24   tcp dpt:80
2     3  228 REJECT   all  -- *   *    0.0.0.0/0     
 192.168.100.0/24   state NEW reject-with icmp-port-unreachable
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c1c8996c-9870-46a8-be4b-3a87a518b585" class="outline-5">
<h5 id="h:c1c8996c-9870-46a8-be4b-3a87a518b585">NAT è¡¨</h5>
<div class="outline-text-5" id="text-h:c1c8996c-9870-46a8-be4b-3a87a518b585">
<p>
å¤–éƒ¨æœåŠ¡å™¨ç½‘å…³æ˜¯æŒ‡å‘è‡ªå·±çš„ç½‘å…³è€Œä¸æ˜¯é˜²ç«å¢™ï¼Œä¸”ä¼ä¸šå†…éƒ¨åœ°å€éƒ½æ˜¯ç§æœ‰åœ°å€ï¼Œå› ä¸ºæ²¡æœ‰åˆ°ç§æœ‰åœ°å€çš„è·¯ç”±ï¼Œå¤–éƒ¨æœåŠ¡å™¨æ— æ³•è®¿é—®å†…éƒ¨æœåŠ¡å™¨
</p>


<figure id="org9ad33d4">
<img src="images/image-20210217101157952.png" alt="image-20210217101157952.png">

</figure>

<p>
NAT: network address translationç½‘ç»œåœ°å€è½¬æ¢ï¼Œæ”¯æŒPREROUTINGï¼ŒINPUTï¼Œ
OUTPUTï¼ŒPOSTROUTINGå››ä¸ªé“¾
</p>

<p>
è¯·æ±‚æŠ¥æ–‡ï¼šä¿®æ”¹æº/ç›®æ ‡IPï¼Œç”±å®šä¹‰å¦‚ä½•ä¿®æ”¹
</p>

<p>
å“åº”æŠ¥æ–‡ï¼šä¿®æ”¹æº/ç›®æ ‡IPï¼Œæ ¹æ®è·Ÿè¸ªæœºåˆ¶è‡ªåŠ¨å®ç°
</p>

<p>
NATçš„å®ç°åˆ†ä¸ºä¸‹é¢ç±»å‹ï¼š
</p>

<ul class="org-ul">
<li>SNATï¼šsource NAT æºç½‘ç»œåœ°å€è½¬æ¢ï¼Œæ”¯æŒPOSTROUTING, INPUTï¼Œè®©æœ¬åœ°ç½‘ç»œ
ä¸­çš„ä¸»æœºé€šè¿‡æŸä¸€ç‰¹å®šåœ°å€è®¿é—®å¤–éƒ¨ç½‘ç»œï¼Œå®ç°åœ°å€ä¼ªè£…,è¯·æ±‚æŠ¥æ–‡ï¼šä¿®æ”¹æº
IP</li>
<li>DNATï¼šdestination NAT ç›®æ ‡ç½‘ç»œåœ°å€è½¬æ¢ æ”¯æŒPREROUTING , OUTPUTï¼ŒæŠŠæœ¬
åœ°ç½‘ç»œä¸­çš„ä¸»æœºä¸Šçš„æŸæœåŠ¡å¼€æ”¾ç»™å¤–éƒ¨ç½‘ç»œè®¿é—®(å‘å¸ƒæœåŠ¡å’Œç«¯å£æ˜ å°„)ï¼Œä½†éš
è—çœŸå®IP,è¯·æ±‚æŠ¥æ–‡ï¼šä¿®æ”¹ç›®æ ‡IP</li>
<li>PNAT: port natï¼Œç«¯å£å’ŒIPéƒ½è¿›è¡Œä¿®æ”¹</li>
</ul>

<p>
æ€è€ƒé¢˜:
</p>

<p>
åœ¨å•ä½å†…éƒ¨ä½¿ç”¨æœªç»ç”³è¯·çš„å…¬ç½‘åœ°å€,å¦‚:6.0.0.0/8ç½‘æ®µ,è¿›è¡Œå†…éƒ¨ç½‘ç»œé€šè®¯,å¹¶
åˆ©ç”¨SNATè¿æ¥Internet,æ˜¯å¦å¯ä»¥?
</p>
</div>
</div>
<div id="outline-container-h:68e0209f-eb6d-4edc-ab92-0ac30fcff4de" class="outline-5">
<h5 id="h:68e0209f-eb6d-4edc-ab92-0ac30fcff4de">SNAT</h5>
<div class="outline-text-5" id="text-h:68e0209f-eb6d-4edc-ab92-0ac30fcff4de">
<p>
SNATï¼šåŸºäºnatè¡¨çš„targetï¼Œé€‚ç”¨äºå›ºå®šçš„å…¬ç½‘IP SNATé€‰é¡¹ï¼š
</p>

<pre class="example" id="org8907d9e">
--to-source [ipaddr[-ipaddr]][:port[-port]]
--random
</pre>

<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -A POSTROUTING -s LocalNET ! -d LocalNet -j SNAT --to-source ExtIP
</pre>
</div>

<p>
<b>æ³¨æ„: éœ€è¦å¼€å¯ ip_forward</b>
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -A POSTROUTING -s 10.0.1.0/24 ! &#8211;d 10.0.1.0/24 -j SNAT --to-source 172.18.1.6-172.18.1.9
</pre>
</div>

<p>
MASQUERADEï¼šåŸºäºnatè¡¨çš„targetï¼Œé€‚ç”¨äºåŠ¨æ€çš„å…¬ç½‘IPï¼Œå¦‚ï¼šæ‹¨å·ç½‘ç»œ
</p>

<p>
MASQUERADEé€‰é¡¹ï¼š
</p>

<pre class="example" id="org1249018">
--to-ports port[-port]
--random
</pre>

<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -A POSTROUTING -s LocalNET ! -d LocalNet -j MASQUERADE
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -A POSTROUTING -s 10.0.1.0/24 ! &#8211;d 10.0.1.0/24 -j MASQUERADE
</pre>
</div>
</div>
<ul class="org-ul">
<li><a id="h:02d26416-32e1-482e-a652-3566853719d8"></a>æŸ¥çœ‹æœ¬åœ°ä¸»æœºè®¿é—®å…¬ç½‘æ—¶ä½¿ç”¨çš„IP<br>
<div class="outline-text-6" id="text-h:02d26416-32e1-482e-a652-3566853719d8">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#curl http://ip.sb
111.199.191.204
[root@centos8 ~]#curl http://ipinfo.io/ip/
111.199.191.204
[root@centos8 ~]#curl http://ifconfig.me
111.199.191.204
[root@centos8 ~]#curl -L http://tool.lu/ip
&#24403;&#21069;IP: 111.199.191.204
&#24402;&#23646;&#22320;: &#20013;&#22269; &#21271;&#20140; &#21271;&#20140;
[root@centos8 ~]#curl -sS --connect-timeout 10 -m 60
https://www.bt.cn/Api/getIpAddress
111.199.189.164[root@centos8 ~]#

[root@firewall ~]#curl cip.cc
IP : 39.164.140.134
&#22320;&#22336; : &#20013;&#22269; &#27827;&#21335; &#40548;&#22721;
&#36816;&#33829;&#21830; : &#31227;&#21160;
&#25968;&#25454;&#20108; : &#27827;&#21335;&#30465;&#37073;&#24030;&#24066; | &#31227;&#21160;
&#25968;&#25454;&#19977; :

URL : http://www.cip.cc/39.164.140.134
</pre>
</div>

<p>
èŒƒä¾‹: SNAT
</p>


<figure id="orgc6dd986">
<img src="images/image-20210217101236424.png" alt="image-20210217101236424.png">

</figure>

<p>
å¤–éƒ¨æœåŠ¡å™¨ç½‘å…³æ˜¯æŒ‡å‘è‡ªå·±çš„ç½‘å…³è€Œä¸æ˜¯é˜²ç«å¢™ï¼Œä¸”ä¼ä¸šå†…éƒ¨åœ°å€éƒ½æ˜¯ç§æœ‰åœ°å€ï¼Œå› ä¸ºæ²¡æœ‰åˆ°ç§æœ‰åœ°å€çš„è·¯ç”±ï¼Œå¤–éƒ¨æœåŠ¡å™¨æ— æ³•è®¿é—®å†…éƒ¨æœåŠ¡å™¨
</p>

<p>
é˜²ç«å¢™æœåŠ¡å™¨firewall ï¼šeth0ç½‘å¡ NATç½‘ç»œ 10.0.0.8/24ï¼Œeth1ç½‘å¡ä»…ä¸»æœº
192.168.0.8/24
</p>

<p>
å…¬å¸å¤–éƒ¨æœåŠ¡å™¨internet ï¼šeth0 ä»…ä¸»æœº 192.168.0.6/24ä¸éœ€è¦é…ç½®ç½‘å…³ï¼Œå’Œ
é˜²ç«å¢™å¤–ç½‘å¡æ˜¯å¯ä»¥é€šçš„
</p>

<p>
å…¬å¸å†…éƒ¨æœåŠ¡å™¨LanServer1ï¼šeth0 NATç½‘ç»œ 10.0.0.7/24 ç½‘å…³æŒ‡å®šé˜²ç«å¢™
10.0.0.8
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1.&#29615;&#22659;&#20934;&#22791;&#65292;&#30830;&#20445;&#27809;&#26377;&#38450;&#28779;&#22681;&#35268;&#21017;&#26102;&#22806;&#32593;&#26381;&#21153;&#22120;internet&#21487;&#20197;ping&#36890;&#38450;&#28779;&#22681;&#65292;&#20869;&#37096;&#26381;&#21153;&#22120;ping&#19981;&#36890;&#22806;&#32593;&#26381;&#21153;&#22120;interne</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22806;&#32593;&#26381;&#21153;&#22120;internet&#20462;&#25913;eth0&#32593;&#21345;&#37197;&#32622; 192.168.0.6/24 &#19981;&#38656;&#35201;&#37197;&#32622;&#32593;&#20851;&#65292;&#21644;&#38450;&#28779;&#22681;&#22806;&#32593;&#21345;&#26159;&#21487;&#20197;&#36890;&#30340;</span>
[root@internet ~]#ping 192.168.0.8

<span style="color: #b22222;"># </span><span style="color: #b22222;">firewall &#20462;&#25913;&#32593;&#21345;&#37197;&#32622; eth0&#32593;&#21345;10.0.0.8/24&#19981;&#38656;&#35201;&#37197;&#32622;&#32593;&#20851;DNS&#65292;eth1 192.168.0.8/24&#19981;&#38656;&#35201;&#37197;&#32622;&#32593;&#20851;DNS&#65292; &#24320;&#21551;&#36335;&#30001;&#36716;&#21457;</span>
[root@firewall ~]#vim /etc/sysctl.conf
net.ipv4.ip_forward=1
[root@firewall ~]#sysctl -p

<span style="color: #b22222;"># </span><span style="color: #b22222;">LanServer1 &#20462;&#25913;&#32593;&#21345;&#37197;&#32622; eth0 10.0.0.7/24 &#32593;&#20851;&#25351;&#23450;&#38450;&#28779;&#22681; 10.0.0.8</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">2.&#37197;&#32622;&#38450;&#28779;&#22681;&#35268;&#21017;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1&#65306;&#38024;&#23545;&#19987;&#32447;&#38745;&#24577;&#20844;&#20849;IP</span>
[root@firewall ~]#iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -j SNAT --to-source 192.168.0.8  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20986;&#21475;&#65292;&#28304;&#22320;&#22336;&#21464;&#20026;192.168.0.8</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2&#65306;&#38024;&#23545;&#25320;&#21495;&#32593;&#32476;&#21644;&#19987;&#32447;&#38745;&#24577;&#20844;&#20849;IP</span>
[root@firewall ~]#iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -j MASQUERADE                    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20986;&#21475;&#65292;&#21160;&#24577;&#25214;ip</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#30417;&#21548;&#31471;&#21475;</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#32593;&#21487;&#20197;&#35775;&#38382;&#22806;&#32593;</span>
[root@lanserver1 ~]#curl 192.168.0.6
internet

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22806;&#32593;&#19981;&#21487;&#20197;&#35775;&#38382;&#20869;&#32593;</span>
[root@internet ~]#curl 10.0.0.7
curl: (7) Failed to connect to 10.0.0.7: Network is unreachable

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#22806;&#32593;&#26381;&#21153;&#22120;&#26597;&#30475;&#21040;&#26159;firewalld&#30340;&#22320;&#22336;&#22312;&#35775;&#38382;</span>
[root@internet ~]#tail -f /var/log/httpd/access_log <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#65283;&#12288;&#35775;&#38382;&#26085;&#24535;&#20013;&#33021;&#30475;&#21040;firewalld&#30340;&#22320;&#22336;ip</span>
192.168.0.8 - - [08/Jul/2020:17:36:54 +0800] <span style="color: #8b2252;">"GET / HTTP/1.1"</span> 200 9 <span style="color: #8b2252;">"-"</span> <span style="color: #8b2252;">"curl/7.29.0"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#36716;&#25442;&#29366;&#24577;&#20449;&#24687;</span>
[root@firewall ~]#cat /proc/net/nf_conntrack
ipv4   2 tcp    6 112 TIME_WAIT <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=192.168.0.6 <span style="color: #a0522d;">sport</span>=58384
<span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=192.168.0.6 <span style="color: #a0522d;">dst</span>=192.168.0.8 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=58384 [ASSURED] <span style="color: #a0522d;">mark</span>=0
<span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:abb5c3ff-76b3-44e2-b789-5d14fc7a5ee9" class="outline-5">
<h5 id="h:abb5c3ff-76b3-44e2-b789-5d14fc7a5ee9">DNAT</h5>
<div class="outline-text-5" id="text-h:abb5c3ff-76b3-44e2-b789-5d14fc7a5ee9">
<p>
DNATï¼šnatè¡¨çš„targetï¼Œé€‚ç”¨äºç«¯å£æ˜ å°„ï¼Œå³å¯é‡å®šå‘åˆ°æœ¬æœºï¼Œä¹Ÿå¯ä»¥æ”¯æŒé‡å®š
å‘è‡³ä¸åŒä¸»æœºçš„ä¸åŒç«¯å£ï¼Œä½†ä¸æ”¯æŒå¤šç›®æ ‡ï¼Œå³ä¸æ”¯æŒè´Ÿè½½å‡è¡¡åŠŸèƒ½
</p>

<p>
DNATé€‰é¡¹ï¼š
</p>

<pre class="example" id="org0e759d5">
--to-destination [ipaddr[-ipaddr]][:port[-port]]
</pre>

<div class="org-src-container">
<pre class="src src-sh">[root@firewall-host ~]#man iptables-extensions
--to-destination [ipaddr[-ipaddr]][:port[-port]]
&#21487;&#20197;&#25351;&#23450;&#20869;&#37096;&#21333;&#19968;ip&#65292;&#21487;&#20197;&#26377;&#31471;&#21475;&#33539;&#22260;&#12290;&#22914;&#26524;&#24819;&#23454;&#29616;&#22810;&#20010;&#20869;&#37096;ip,&#38656;&#35201;&#20869;&#26680;&#29256;&#26412;&#23567;&#20110; 2.6.11&#12290;&#22823;&#20110;&#36825;&#20010;&#29256;&#26412;&#26377;&#26356;&#22909;&#30340;&#26041;&#26696;LVS
&#160;which can specify a single new destination IP address, an inclusive range
of IP addresses. Optionally a port range, if the rule also specifies one of the
following protocols: tcp, udp, dccp or sctp. If no port range is specified,
<span style="color: #a020f0;">then</span> the destination port will never be modi-fied. If no IP address is specified
<span style="color: #a020f0;">then</span> only the destination port will be modified. In Ker-nels up to &#160;2.6.10
you can add several --to-destination options. For those kernels, if you specify
more than one destination address, either via an address range or multiple &#160;--
to-des-tination options, a simple round-robin (one after another<span style="color: #a020f0;"> in</span> cycle)
load balancing takes place between these addresses. Later Kernels (&gt;= 2.6.11-
rc1) don<span style="color: #8b2252;">'t have the ability to NAT to multiple ranges anymore.</span>
</pre>
</div>

<p>
DNAT æ ¼å¼:
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -A PREROUTING -d ExtIP -p tcp|udp --dport PORT -j DNAT --to-destination InterSeverIP[:PORT]
</pre>
</div>

<p>
<b>æ³¨æ„: éœ€è¦å¼€å¯ ip_forward</b>
</p>

<p>
èŒƒä¾‹: DNAT
</p>


<figure id="org511ffb0">
<img src="images/image-20210217101313496.png" alt="image-20210217101313496.png">

</figure>

<p>
å¤–éƒ¨æœåŠ¡å™¨ç½‘å…³æ˜¯æŒ‡å‘è‡ªå·±çš„ç½‘å…³è€Œä¸æ˜¯é˜²ç«å¢™ï¼Œä¸”ä¼ä¸šå†…éƒ¨åœ°å€éƒ½æ˜¯ç§æœ‰åœ°å€ï¼Œ
å› ä¸ºæ²¡æœ‰åˆ°ç§æœ‰åœ°å€çš„è·¯ç”±ï¼Œå¤–éƒ¨æœåŠ¡å™¨æ— æ³•è®¿é—®å†…éƒ¨æœåŠ¡å™¨
</p>

<p>
é˜²ç«å¢™æœåŠ¡å™¨firewall ï¼šeth0ç½‘å¡ NATç½‘ç»œ 10.0.0.8/24ï¼Œeth1ç½‘å¡ä»…ä¸»æœº
192.168.0.8/24
</p>

<p>
å…¬å¸å¤–éƒ¨æœåŠ¡å™¨internet ï¼šeth0 ä»…ä¸»æœº 192.168.0.6/24ä¸éœ€è¦é…ç½®ç½‘å…³ï¼Œå’Œ
é˜²ç«å¢™å¤–ç½‘å¡æ˜¯å¯ä»¥é€šçš„
</p>

<p>
å…¬å¸å†…éƒ¨æœåŠ¡å™¨LanServer1ï¼šeth0 NATç½‘ç»œ 10.0.0.7/24 ç½‘å…³æŒ‡å®šé˜²ç«å¢™
10.0.0.8
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1.&#29615;&#22659;&#20934;&#22791;&#65292;&#30830;&#20445;&#27809;&#26377;&#38450;&#28779;&#22681;&#35268;&#21017;&#26102;&#22806;&#32593;&#26381;&#21153;&#22120;internet&#21487;&#20197;ping&#36890;&#38450;&#28779;&#22681;&#65292;&#20869;&#37096;&#26381;&#21153;&#22120;ping&#19981;&#36890;&#22806;&#32593;&#26381;&#21153;&#22120;interne</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22806;&#32593;&#26381;&#21153;&#22120;internet&#20462;&#25913;eth0&#32593;&#21345;&#37197;&#32622; 192.168.0.6/24 &#19981;&#38656;&#35201;&#37197;&#32622;&#32593;&#20851;&#65292;&#21644;&#38450;&#28779;&#22681;&#22806;&#32593;&#21345;&#26159;&#21487;&#20197;&#36890;&#30340;</span>
[root@internet ~]#ping 192.168.0.8

<span style="color: #b22222;"># </span><span style="color: #b22222;">firewall &#20462;&#25913;&#32593;&#21345;&#37197;&#32622; eth0&#32593;&#21345;10.0.0.8/24&#19981;&#38656;&#35201;&#37197;&#32622;&#32593;&#20851;DNS&#65292;eth1 192.168.0.8/24&#19981;&#38656;&#35201;&#37197;&#32622;&#32593;&#20851;DNS&#65292; &#24320;&#21551;&#36335;&#30001;&#36716;&#21457;</span>
[root@firewall ~]#vim /etc/sysctl.conf
net.ipv4.ip_forward=1
[root@firewall ~]#sysctl -p

<span style="color: #b22222;"># </span><span style="color: #b22222;">LanServer1 &#20462;&#25913;&#32593;&#21345;&#37197;&#32622; eth0 10.0.0.7/24 &#32593;&#20851;&#25351;&#23450;&#38450;&#28779;&#22681; 10.0.0.8</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">2.&#37197;&#32622;&#38450;&#28779;&#22681;&#35268;&#21017;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22806;&#37096;&#35775;&#38382;&#38450;&#28779;&#22681;&#30340;80&#31471;&#21475;&#36716;&#21457;&#21040;&#20869;&#37096;ip &#30340;8080&#31471;&#21475;</span>
[root@firewall ~]#iptables -t nat -A PREROUTING -d 192.168.0.8 -p tcp --dport 80 -j DNAT --to-destination 10.0.0.7:8080

[root@internet ~]#curl 192.168.0.8
lanserver1
[root@lanserver1 ~]#tail /var/log/httpd/access_log &#65283;&#12288;&#35775;&#38382;&#26085;&#24535;&#20013;&#33021;&#30475;&#21040;&#30495;&#27491;&#30340;&#23458;&#25143;ip
192.168.0.6 - - [08/Jul/2020:18:10:37 +0800] <span style="color: #8b2252;">"GET / HTTP/1.1"</span> 200 11 <span style="color: #8b2252;">"-"</span>
<span style="color: #8b2252;">"curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3</span>
<span style="color: #8b2252;">libidn/1.18 libssh2/1.4.2"</span>

[root@firewall ~]#cat /proc/net/nf_conntrack
ipv4   2 tcp    6 117 TIME_WAIT <span style="color: #a0522d;">src</span>=192.168.0.6 <span style="color: #a0522d;">dst</span>=192.168.0.8 <span style="color: #a0522d;">sport</span>=58170
<span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=192.168.0.6 <span style="color: #a0522d;">sport</span>=8080 <span style="color: #a0522d;">dport</span>=58170 [ASSURED] <span style="color: #a0522d;">mark</span>=0
<span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -A PREROUTING -s 0/0 -d 172.18.100.6 -p tcp --dport 22 -j DNAT --to-destination 10.0.1.22
iptables -t nat -A PREROUTING -s 0/0 -d 172.18.100.6 -p tcp --dport 80 -j DNAT --to-destination 10.0.1.22:8080
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@firewall-host ~]#iptables -t nat -A PREROUTING -d 10.0.0.8 -p tcp --dport 80 -j DNAT --to-destination 192.168.100.7
[root@firewall-host ~]#iptables -t nat -vnL PREROUTING
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source        destination

  0   0 DNAT    tcp  -- *   *    0.0.0.0/0       10.0.0.8  
    tcp dpt:80 to:192.168.100.7
[root@firewall-host ~]#ss -ntl
State    Recv-Q    Send-Q         Local Address:Port      
  Peer Address:Port    
LISTEN    0       128              0.0.0.0:22       
     0.0.0.0:*     
LISTEN    0       128               [::]:22       
[::]:*

[root@internet-host ~]#curl 10.0.0.8
lan server
[root@internet-host ~]#telnet 10.0.0.8
Trying 10.0.0.8...
telnet: connect to address 10.0.0.8: Connection refused

[root@lan-host ~]#tail -f /var/log/httpd/access_log
10.0.0.6 - - [21/Mar/2020:17:32:37 +0800] <span style="color: #8b2252;">"GET / HTTP/1.1"</span> 200 11 <span style="color: #8b2252;">"-"</span>
<span style="color: #8b2252;">"curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3</span>
<span style="color: #8b2252;">libidn/1.18 libssh2/1.4.2"</span>

[root@firewall-host ~]#tail -f /proc/net/nf_conntrack
ipv4   2 tcp    6 81 TIME_WAIT <span style="color: #a0522d;">src</span>=10.0.0.6 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=59426
<span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=192.168.100.7 <span style="color: #a0522d;">dst</span>=10.0.0.6 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=59426 [ASSURED] <span style="color: #a0522d;">mark</span>=0
<span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2

[root@lan-host ~]#vim /etc/httpd/conf/httpd.conf
listen 8000
[root@lan-host ~]#systemctl restart httpd
[root@lan-host ~]#ss -ntl
State   Recv-Q Send-Q     Local Address:Port            
Peer Address:Port       
LISTEN   0    100         127.0.0.1:25               
   *:*         
LISTEN   0    128             *:22               
   *:*         
LISTEN   0    128           [::]:23               
[::]:*
LISTEN   0    100           [::1]:25               
[::]:*
LISTEN   0    128           [::]:8000              
[::]:*
LISTEN   0    128           [::]:22               
[::]:*

[root@firewall-host ~]#iptables -t nat -R PREROUTING 1 -d 10.0.0.8 -p tcp --dport 80 -j DNAT --to-destination 192.168.100.7:8000
[root@firewall-host ~]#iptables -t nat -vnL
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source        destination

  0   0 DNAT    tcp  -- *   *    0.0.0.0/0       10.0.0.8  
    tcp dpt:80 to:192.168.100.7:8000
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source        destination

Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source        destination
</pre>
</div>

<p>
<b>ç»¼åˆæ¡ˆä¾‹: ä¸¤ä¸ªç§ç½‘çš„äº’é€š</b>
</p>


<figure id="org4347258">
<img src="images/image-20210217101332467.png" alt="image-20210217101332467.png">

</figure>

<p>
ä¸¤è¾¹éƒ½æ˜¯ç§ç½‘åœ°å€å®ç°ï¼Œå·¦è¾¹è®¿é—®å³è¾¹æ—¶ï¼Œå‰é¢é˜²ç«å¢™1 SNATï¼Œåé¢é˜²ç«å¢™ 2
DNATï¼›åè¿‡æ¥å³è¾¹å›åº”å·¦è¾¹ï¼Œå‰é¢é˜²ç«å¢™2 SNATï¼Œåé¢é˜²ç«å¢™1 DNATã€‚
</p>

<p>
VPNå®é™…ä¸Šç”¨çš„å°±æ˜¯è¿™ç§é€»è¾‘ï¼Œå®ƒè¿˜å¯ä»¥åŠ å¯†
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20844;&#32593;ip 10.0.0.8  10.0.0.18</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24038;&#36793;</span>
iptables -t nat -A PREROUTING  -d 10.0.0.8  -j DNAT --to-destination 192.168.0.8  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35775;&#38382;&#36827;&#26469;&#26102;&#65292;&#30446;&#26631;&#20844;&#32593;ip&#21464;&#20026;&#20869;&#37096;ip</span>
iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j SNAT --to-source 10.0.0.8     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35775;&#38382;&#20986;&#21475;&#26102;&#65292;&#30446;&#26631;&#20869;&#37096;ip&#21464;&#20026;&#20844;&#32593;ip</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21491;&#36793;</span>
iptables -t nat -A PREROUTING  -d 10.0.0.18  -j DNAT --to-destination 172.16.0.18  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35775;&#38382;&#36827;&#26469;&#26102;&#65292;&#30446;&#26631;&#20844;&#32593;ip&#21464;&#20026;&#20869;&#37096;ip</span>
iptables -t nat -A POSTROUTING -s 172.16.0.0/24 -j SNAT --to-source 10.0.0.18     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35775;&#38382;&#20986;&#21475;&#26102;&#65292;&#30446;&#26631;&#20869;&#37096;ip&#21464;&#20026;&#20844;&#32593;ip</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:72073f97-3e2d-43c8-a08c-01d8ffdb2804" class="outline-5">
<h5 id="h:72073f97-3e2d-43c8-a08c-01d8ffdb2804">REDIRECT è½¬å‘(ç«¯å£è½¬å‘)</h5>
<div class="outline-text-5" id="text-h:72073f97-3e2d-43c8-a08c-01d8ffdb2804">
<p>
REDIRECTï¼Œæ˜¯NATè¡¨çš„targetï¼Œé€šè¿‡æ”¹å˜ç›®æ ‡IPå’Œç«¯å£ï¼Œå°†æ¥å—çš„åŒ…è½¬å‘è‡³åŒä¸€
ä¸ªä¸»æœºçš„ä¸åŒç«¯å£ï¼Œå¯ç”¨äºPREROUTING OUTPUTé“¾ REDIRECTé€‰é¡¹ï¼š
</p>

<pre class="example" id="org0338e01">
--to-ports port[-port]
</pre>

<p>
<b>æ³¨æ„: æ— éœ€å¼€å¯ ip_forward</b>
</p>

<p>
èŒƒä¾‹ï¼šè®¿é—®æœ¬æœº172.16.100.10çš„80ç«¯å£ï¼Œè½¬å‘ä¸ºæœ¬æœº8080
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -A PREROUTING -d 172.16.100.10 -p tcp --dport 80 -j REDIRECT --to-ports 8080
</pre>
</div>

<p>
èŒƒä¾‹ï¼šè®¿é—®æœ¬æœº8000ç«¯å£ï¼Œè½¬å‘ä¸ºæœ¬æœº80
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@lan-host ~]#iptables -t nat -A PREROUTING -p tcp --dport 8000 -j REDIRECT --to-ports 80
[root@lan-host ~]#ss -ntl                     <span style="color: #b22222;"># </span><span style="color: #b22222;">iptable&#26159;&#20869;&#26680;&#32423;&#21151;&#33021;&#30340;&#65292;&#24212;&#29992;&#31243;&#24207;&#25165;&#30417;&#21548;&#31471;&#21475;</span>
[root@lan-host ~]#iptables -vnL -t nat
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:732ceb41-99c3-4ce8-aa77-5056b0108851" class="outline-4">
<h4 id="h:732ceb41-99c3-4ce8-aa77-5056b0108851">å®æˆ˜æ¡ˆä¾‹ï¼š</h4>
<div class="outline-text-4" id="text-h:732ceb41-99c3-4ce8-aa77-5056b0108851">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26657;&#21306;&#30340;&#38450;&#28779;&#22681;&#37197;&#32622;&#35774;&#32622;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Generated by iptables-save v1.4.7 on Wed May 18 09:22:34 2016</span>
*filter
:INPUT ACCEPT [85890:4530430]
:FORWARD ACCEPT [76814:55698470]
:OUTPUT ACCEPT [166620:238017546]
-A FORWARD -s 172.16.0.100/32 -j ACCEPT  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20248;&#20808;&#32769;&#24072;&#30340;&#26426;&#22120;&#21487;&#19978;&#32593;</span>
-A FORWARD -s 172.16.0.200/32 -j ACCEPT
-A FORWARD -s 172.16.0.67/32 -j ACCEPT
<span style="color: #b22222;">#</span><span style="color: #b22222;">WANG &#160;ADD NEXT LINE IN 20170627</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.16.0.0/16 -j ACCEPT</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">WANG &#160;ADD NEXT LINE IN 20170704</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.18.0.0/16 -j ACCEPT</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.18.0.0/16 -j REJECT</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.16.0.68/32 -j ACCEPT</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.16.0.69/32 -j ACCEPT</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.16.0.6/32 -j ACCEPT</span>
-A FORWARD -s 172.17.200.200/32 -j ACCEPT
-A FORWARD -s 172.17.136.136/32 -j ACCEPT
-A FORWARD -s 172.17.0.100/32 -j ACCEPT
-A FORWARD -s 172.18.100.1/32 -j ACCEPT
-A FORWARD -s 172.18.0.100/32 -j ACCEPT
-A FORWARD -s 172.18.200.2/32 -j ACCEPT
-A FORWARD -s 172.18.200.3/32 -j ACCEPT
-A FORWARD -s 172.18.211.211/32 -j ACCEPT
-A FORWARD -s 172.18.212.212/32 -j ACCEPT
-A FORWARD -m iprange --src-range 172.16.0.100-172.16.0.110 -j ACCEPT  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25945;&#23398;&#26426;&#22120;</span>
-A FORWARD -m iprange --src-range 172.17.0.100-172.17.0.110 -j ACCEPT
-A FORWARD -m iprange --src-range 172.18.0.100-172.18.0.110 -j ACCEPT
-A FORWARD -m iprange --src-range 172.17.100.6-172.17.100.16 -j ACCEPT
-A FORWARD -m iprange --src-range 172.18.100.61-172.18.100.70 -j ACCEPT
-A FORWARD -s 172.16.0.0/16 -m string --string <span style="color: #8b2252;">"verycd.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38480;&#21046;&#32593;&#31449;&#35775;&#38382;</span>
-A FORWARD -s 172.16.0.0/16 -m string --string <span style="color: #8b2252;">"tudou.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.16.0.0/16 -m string --string <span style="color: #8b2252;">"youku.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.16.0.0/16 -m string --string <span style="color: #8b2252;">"iqiyi.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.16.0.0/16 -m string --string <span style="color: #8b2252;">"pptv.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.16.0.0/16 -m string --string <span style="color: #8b2252;">"letv.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.16.0.0/16 -m string --string <span style="color: #8b2252;">"xunlei.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.18.0.0/16 -m string --string <span style="color: #8b2252;">"verycd.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.18.0.0/16 -m string --string <span style="color: #8b2252;">"tudou.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.18.0.0/16 -m string --string <span style="color: #8b2252;">"youku.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.18.0.0/16 -m string --string <span style="color: #8b2252;">"iqiyi.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.18.0.0/16 -m string --string <span style="color: #8b2252;">"pptv.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.18.0.0/16 -m string --string <span style="color: #8b2252;">"letv.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.18.0.0/16 -m string --string <span style="color: #8b2252;">"xunlei.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.18.0.0/16 -j REJECT</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.16.0.0/16 -j REJECT</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -i ppp0 -m string --string ".exe" --algo bm --to 65535 -j REJECT --reject-with icmp-port-unreachable</span>
-A FORWARD -s 172.18.0.0/16 -m time --timestart 08:50:00 --timestop 18:00:00 --weekdays Mon,Wed,Fri &#160;--datestop 2038-01-19T11:14:07 -j REJECT --reject-with icmp-port-unreachable <span style="color: #b22222;"># </span><span style="color: #b22222;">centos6&#30452;&#25509;&#29992;&#30340;&#24403;&#22320;&#26102;&#38388;&#65292;&#19981;&#38656;&#35201;-8&#23567;&#26102;&#12290;&#21608;1&#65292;3&#65292;5&#19981;&#33021;&#19978;&#32593;</span>
-A FORWARD -s 172.17.0.0/16 -m time --timestart 08:50:00 --timestop 18:00:00 --weekdays Mon,Wed,Fri &#160;--datestop 2038-01-19T11:14:07 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.16.0.0/16 -m time --timestart 08:50:00 --timestop 12:30:00 --weekdays Tue,Thu,Sat &#160;--datestop 2038-01-19T11:14:07 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.16.0.0/16 -m time --timestart 13:50:00 --timestop 18:00:00 --weekdays Tue,Thu,Sat &#160;--datestop 2038-01-19T11:14:07 -j REJECT --reject-with icmp-port-unreachable
<span style="color: #b22222;">#</span><span style="color: #b22222;">wang next 2 lines changed in 20170619</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.17.0.0/16 -m time --timestart 08:50:00 --timestop 12:30:00 --weekdays Mon,Wed,Fri --datestop 2038-01-19T11:14:07 -j REJECT --reject-with icmp-port-unreachable</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.17.0.0/16 -m time --timestart 13:30:00 --timestop 18:10:00 --weekdays Mon,Wed,Fri --datestop 2038-01-19T11:14:07 -j REJECT --reject-with icmp-port-unreachable</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.18.0.0/16 -m time --timestart 08:50:00 --timestop 18:10:00 --weekdays Mon,Wed,Fri --datestop 2038-01-19T11:14:07 -j REJECT --reject-with icmp-port-unreachable</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.18.0.0/16 -m time --timestart 08:50:00 --timestop 18:10:00 --weekdays Tue,Thu --datestop 2038-01-19T11:14:07 -j REJECT --reject-with icmp-port-unreachable</span>
COMMIT
<span style="color: #b22222;"># </span><span style="color: #b22222;">Completed on Wed May 18 09:22:34 2016</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Generated by iptables-save v1.4.7 on Wed May 18 09:22:34 2016</span>
*nat
:PREROUTING ACCEPT [1429833:65427211]
:POSTROUTING ACCEPT [850518:35452195]
:OUTPUT ACCEPT [120198:9146655]
-A POSTROUTING -s 172.16.0.100/32 -j MASQUERADE
-A POSTROUTING -s 172.18.0.100/32 -j MASQUERADE
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A POSTROUTING -s 172.16.0.200/32 -j MASQUERADE</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">wang add next 1 line in 20170619</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">wang add next 1 line in 20170704</span>
-A POSTROUTING -s 172.16.0.69/32 -j MASQUERADE
-A POSTROUTING -s 172.17.200.200/32 -j MASQUERADE
-A POSTROUTING -s 172.17.136.136/32 -j MASQUERADE
-A POSTROUTING -s 172.17.0.100/32 -j MASQUERADE
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A POSTROUTING -s 172.18.0.0/16 -j MASQUERADE</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A POSTROUTING -s 172.16.0.6/32 -j MASQUERADE</span>
-A POSTROUTING -m iprange --src-range 172.16.0.100-172.16.0.110 -j MASQUERADE
-A POSTROUTING -m iprange --src-range 172.17.0.100-172.17.0.110 -j MASQUERADE
-A POSTROUTING -m iprange --src-range 172.18.0.100-172.18.0.110 -j MASQUERADE
-A POSTROUTING -s 172.16.0.0/16 -p tcp -m multiport --dports 80,443,53,22,6666 -j MASQUERADE  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21482;&#33021;&#35775;&#38382;&#20844;&#32593;&#29305;&#23450;&#31471;&#21475;</span>
-A POSTROUTING -s 172.16.0.0/16 -p udp -m multiport --dports 22 -j MASQUERADE
-A POSTROUTING -s 172.17.0.0/16 -p tcp -m multiport --dports 80,443,53,22,6666 -j MASQUERADE
-A POSTROUTING -s 172.17.0.0/16 -p udp -m multiport --dports 22 -j MASQUERADE
-A POSTROUTING -s 172.18.0.0/16 -p tcp -m multiport --dports 80,443,53,22,6666,1206,5938,1949 -j MASQUERADE
-A POSTROUTING -s 172.18.0.0/16 -p udp -m multiport --dports 22,1206,5938,1949 -j MASQUERADE
COMMIT
<span style="color: #b22222;"># </span><span style="color: #b22222;">Completed on Wed May 18 09:22:34 2016</span>

<span style="color: #b22222;">#########</span><span style="color: #b22222;">&#20844;&#21496;</span>
[root@vpn-01 ~]# vim /etc/sysconfig/iptables

<span style="color: #b22222;"># </span><span style="color: #b22222;">Generated by iptables-save v1.4.21 on Tue Dec  4 15:23:47 2018</span>
*nat
:PREROUTING ACCEPT [1031964:60474614]
:INPUT ACCEPT [1030599:60368281]
:OUTPUT ACCEPT [39560:2705379]
:POSTROUTING ACCEPT [39701:2721808]
-A POSTROUTING -s 192.168.123.0/24 -j MASQUERADE
COMMIT
<span style="color: #b22222;"># </span><span style="color: #b22222;">Completed on Tue Dec  4 15:23:47 2018</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Generated by iptables-save v1.4.21 on Tue Dec  4 15:23:47 2018</span>
*filter
:INPUT ACCEPT [102:6792]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [86:6259]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -s 172.16.0.0/16 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 10022 -j ACCEPT
-A INPUT -p udp --dport 10086 -j ACCEPT
-A INPUT -p tcp --dport 9000:9010 -j ACCEPT
-A INPUT -p tcp --dport 11223 -j ACCEPT
-A INPUT -m state --state INVALID,NEW -j DROP

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31616;&#21333;&#35828;&#65292;&#20801;&#35768;&#25968;&#25454;&#20174;&#23458;&#25143;&#31471;&#21040;&#21518;&#31471;server</span>
-A FORWARD -i tun0 -s 192.168.123.0/24 -j ACCEPT
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20801;&#35768;&#25968;&#25454;&#20174;&#21518;&#31471;server&#21040;&#23458;&#25143;&#31471;</span>
-A FORWARD -i eth0 -d 192.168.123.0/24 -j ACCEPT
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
<span style="color: #b22222;"># </span><span style="color: #b22222;">Completed on Tue Dec  4 15:23:47 2018</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e294b82d-64ce-41cf-9334-9ec02af8bab9" class="outline-4">
<h4 id="h:e294b82d-64ce-41cf-9334-9ec02af8bab9">iptableså®ç°ä¸ƒå±‚è®¿é—®è¿‡æ»¤</h4>
<div class="outline-text-4" id="text-h:e294b82d-64ce-41cf-9334-9ec02af8bab9">
<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1&#12289;&#33719;&#21462;&#24182;&#32534;&#35793;&#20869;&#26680;</span>
useradd mockbuild
rpm -ivh kernel-2.6.32-431.5.1.x86_64.el6.src.rpm
<span style="color: #483d8b;">cd</span> rpmbuild/SOURCES
tar linux-2.6.32-*.tar.gz -C /usr/src
<span style="color: #483d8b;">cd</span> /usr/src
ln -sv 

<span style="color: #b22222;">#</span><span style="color: #b22222;">2&#12289;&#32473;&#20869;&#26680;&#25171;&#34917;&#19969;</span>
tar xf netfilter-layer7-v2.23.tar.bz2
<span style="color: #483d8b;">cd</span> /usr/src/linux
patch -p1 &lt; /root/netfilter-layer7-v2.23/kernel-2.6.32-layer7-2.23.patch
cp /boot/config-*  .config
make menuconfig

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25353;&#22914;&#19979;&#27493;&#39588;&#21551;&#29992;layer7&#27169;&#22359;        </span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">Networking support &#8594; Networking Options &#8594;Network packet filtering framework &#8594; Core Netfilter Configuration</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&lt;M&gt;  &#8220;layer7&#8221; match support</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">3&#12289;&#32534;&#35793;&#24182;&#23433;&#35013;&#20869;&#26680;</span>
make -j <span style="color: #b22222;">#</span>
make modules_install
make install
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#31034;&#65306;xt_layer7.ko&#20381;&#36182;&#20110;nf_conntrack.ko&#27169;&#22359;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">4&#12289;&#37325;&#21551;&#31995;&#32479;&#65292;&#21551;&#29992;&#26032;&#20869;&#26680;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">5&#12289;&#32534;&#35793;iptables</span>
tar xf iptables-1.4.20.tar.gz
cp /root/netfilter-layer7-v2.23/iptables-1.4.3forward-for-kernel-2.6.20forward/* /root/iptables-1.4.20/extensions/
cp /etc/rc.d/init.d/iptales /root
cp /etc/sysconfig/iptables-config /root
rpm -e iptables iptables-ipv6 --nodeps
./configure  --prefix=/usr  --with-ksource=/usr/src/linux
make &amp;&amp; make install

cp /root/iptables /etc/rc.d/init.d
cp /root/iptables-config /etc/sysconfig

<span style="color: #b22222;">#</span><span style="color: #b22222;">6&#12289;&#20026;layer7&#27169;&#22359;&#25552;&#20379;&#20854;&#25152;&#35782;&#21035;&#30340;&#21327;&#35758;&#30340;&#29305;&#24449;&#30721;</span>
tar zxvf l7-protocols-2009-05-28.tar.gz
<span style="color: #483d8b;">cd</span> l7-protocols-2009-05-28
make install        

7&#12289;&#22914;&#20309;&#20351;&#29992;layer7&#27169;&#22359;
<span style="color: #b22222;">#</span><span style="color: #b22222;">ACCT&#30340;&#21151;&#33021;&#24050;&#32463;&#21487;&#20197;&#22312;&#20869;&#26680;&#21442;&#25968;&#20013;&#25353;&#38656;&#21551;&#29992;&#25110;&#31105;&#29992;&#12290;&#27492;&#21442;&#25968;&#38656;&#35201;&#35013;&#36733;nf_conntrack&#27169;&#22359;&#21518;&#26041;&#33021;&#29983;&#25928;&#12290;</span>
net.netfilter.nf_conntrack_acct = 1

<span style="color: #b22222;">#</span><span style="color: #b22222;">l7-filter uses the standard iptables extension syntax </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">iptables [specify table &amp; chain] -m layer7 --l7proto [protocol name] -j [action] </span>
iptables -A FORWARD -m layer7 --l7proto qq -j REJECT
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ed0b7ea4-d0af-463c-a5c6-0e23dfb136fc" class="outline-3">
<h3 id="h:ed0b7ea4-d0af-463c-a5c6-0e23dfb136fc">firewalldæœåŠ¡</h3>
<div class="outline-text-3" id="text-h:ed0b7ea4-d0af-463c-a5c6-0e23dfb136fc">
</div>
<div id="outline-container-h:39899c40-ec8b-42fd-933d-3c02d0956a6e" class="outline-4">
<h4 id="h:39899c40-ec8b-42fd-933d-3c02d0956a6e">firewalld ä»‹ç»</h4>
<div class="outline-text-4" id="text-h:39899c40-ec8b-42fd-933d-3c02d0956a6e">
<p>
è¿‡æ¸¡è½¯ä»¶ï¼Œäº†è§£å°±è¡Œï¼Œæ¨èä½¿ç”¨nftables
</p>

<p>
firewalldæ˜¯CentOS 7.0æ–°æ¨å‡ºçš„ç®¡ç†netfilterçš„ç”¨æˆ·ç©ºé—´è½¯ä»¶å·¥å…·
</p>

<p>
firewalldæ˜¯é…ç½®å’Œç›‘æ§é˜²ç«å¢™è§„åˆ™çš„ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹ã€‚å¯ä»¥å®iptables,ip6tables,ebtablesçš„åŠŸèƒ½
</p>

<p>
firewalldæœåŠ¡ç”±firewalldåŒ…æä¾›
</p>

<p>
firewalldæ”¯æŒåˆ’åˆ†åŒºåŸŸzone,æ¯ä¸ªzoneå¯ä»¥è®¾ç½®ç‹¬ç«‹çš„é˜²ç«å¢™è§„åˆ™
</p>

<p>
<b>å½’å…¥zoneé¡ºåºï¼š</b>
</p>

<ul class="org-ul">
<li>å…ˆæ ¹æ®æ•°æ®åŒ…ä¸­æºåœ°å€ï¼Œå°†å…¶çº³ä¸ºæŸä¸ªzone</li>
<li>çº³ä¸ºç½‘ç»œæ¥å£æ‰€å±zone</li>
<li>çº³å…¥é»˜è®¤zoneï¼Œé»˜è®¤ä¸ºpublic zone,ç®¡ç†å‘˜å¯ä»¥æ”¹ä¸ºå…¶å®ƒzone</li>
<li>ç½‘å¡é»˜è®¤å±äºpublic zone,loç½‘ç»œæ¥å£å±äºtrusted zone</li>
</ul>

<p>
<b>firewalld zone åˆ†ç±»</b>
</p>

<pre class="example" id="orgee99c18">
zoneåç§°  é»˜è®¤é…ç½®
trusted  ï¼šå…è®¸æ‰€æœ‰æµé‡
home     ï¼šæ‹’ç»é™¤å’Œä¼ å‡ºæµé‡ç›¸å…³çš„ï¼Œä»¥åŠssh,mdsn,ipp-client,samba-client,dhcpv6-clienté¢„å®šä¹‰æœåŠ¡ä¹‹å¤–å…¶å®ƒæ‰€æœ‰ä¼ å…¥æµé‡
internal ï¼šå’Œhomeç›¸åŒ
work     ï¼šæ‹’ç»é™¤å’Œä¼ å‡ºæµé‡ç›¸å…³çš„ï¼Œä»¥åŠssh,ipp-client,dhcpv6-clienté¢„å®šä¹‰æœåŠ¡ä¹‹å¤–çš„å…¶å®ƒæ‰€æœ‰ä¼ å…¥æµé‡
public   ï¼šæ‹’ç»é™¤å’Œä¼ å‡ºæµé‡ç›¸å…³çš„ï¼Œä»¥åŠssh,dhcpv6-clienté¢„å®šä¹‰æœåŠ¡ä¹‹å¤–çš„å…¶å®ƒæ‰€æœ‰ä¼ å…¥æµé‡ï¼Œæ–°åŠ çš„ç½‘å¡é»˜è®¤å±äºpublic zone
external ï¼šæ‹’ç»é™¤å’Œä¼ å‡ºæµé‡ç›¸å…³çš„ï¼Œä»¥åŠsshé¢„å®šä¹‰æœåŠ¡ä¹‹å¤–çš„å…¶å®ƒæ‰€æœ‰ä¼ å…¥æµé‡ï¼Œå±äºexternal zoneçš„ä¼ å‡ºipv4æµé‡çš„æºåœ°å€å°†è¢«ä¼ªè£…ä¸ºä¼ å‡ºç½‘å¡çš„åœ°å€ã€‚
dmz      ï¼šæ‹’ç»é™¤å’Œä¼ å‡ºæµé‡ç›¸å…³çš„ï¼Œä»¥åŠsshé¢„å®šä¹‰æœåŠ¡ä¹‹å¤–çš„å…¶å®ƒæ‰€æœ‰ä¼ å…¥æµé‡
block    ï¼šæ‹’ç»é™¤å’Œä¼ å‡ºæµé‡ç›¸å…³çš„æ‰€æœ‰ä¼ å…¥æµé‡
drop     ï¼šæ‹’ç»é™¤å’Œä¼ å‡ºæµé‡ç›¸å…³çš„æ‰€æœ‰ä¼ å…¥æµé‡ï¼ˆç”šè‡³ä¸ä»¥ICMPé”™è¯¯è¿›è¡Œå›åº”ï¼‰
</pre>

<p>
<b>é¢„å®šä¹‰æœåŠ¡</b>
</p>

<pre class="example" id="org12e23ba">
æœåŠ¡åç§°  é…ç½®
ssh           : Local SSH server. Traffic to 22/tcp
dhcpv6-client : Local DHCPv6 client. Traffic to 546/udp on the fe80::/64 IPv6 network
ipp-client    : Local IPP printing. Traffic to 631/udp.
samba-client  : Local Windows file and print sharing client. Traffic to 137/udp and 138/udp.
mdns          : Multicast DNS (mDNS) local-link name resolution. Traffic to 5353/udp to the 224.0.0.251 (IPv4) or ff02::fb (IPv6) multicast addresses.
</pre>

<p>
firewalldé¢„å®šä¹‰æœåŠ¡é…ç½®
</p>

<ul class="org-ul">
<li>firewall-cmd &#x2013;get-services æŸ¥çœ‹é¢„å®šä¹‰æœåŠ¡åˆ—è¡¨</li>
<li>/usr/lib/firewalld/services/*.xmlé¢„å®šä¹‰æœåŠ¡çš„é…ç½®</li>
</ul>

<p>
firewalld ä¸‰ç§é…ç½®æ–¹æ³•
</p>

<ul class="org-ul">
<li>firewall-config å›¾å½¢å·¥å…·: éœ€å®‰è£… firewall-configåŒ…</li>
<li>firewall-cmd å‘½ä»¤è¡Œå·¥å…·: firewalldåŒ…,é»˜è®¤å®‰è£…</li>
<li>/etc/firewalld/é…ç½®æ–‡ä»¶ï¼Œä¸€èˆ¬ä¸å»ºè®®,å¦‚:/etc/firewalld/zones/public.xml</li>
</ul>
</div>
</div>
<div id="outline-container-h:fef90433-dfbb-44ec-982e-3e3332aeebae" class="outline-4">
<h4 id="h:fef90433-dfbb-44ec-982e-3e3332aeebae">firewall-cmd å‘½ä»¤</h4>
<div class="outline-text-4" id="text-h:fef90433-dfbb-44ec-982e-3e3332aeebae">
<p>
firewall-cmd æ ¼å¼
</p>

<pre class="example" id="org05f633b">
Usage: firewall-cmd [OPTIONS...]
</pre>

<p>
å¸¸è§é€‰é¡¹
</p>

<pre class="example" id="orgc8305a2">
--get-service æŸ¥çœ‹æœ‰å“ªäº›æœåŠ¡
--get-zones åˆ—å‡ºæ‰€æœ‰å¯ç”¨åŒºåŸŸ
--get-default-zone æŸ¥è¯¢é»˜è®¤åŒºåŸŸ
--set-default-zone=&lt;ZONE&gt; è®¾ç½®é»˜è®¤åŒºåŸŸ
--get-active-zones åˆ—å‡ºå½“å‰æ­£ä½¿ç”¨çš„åŒºåŸŸ
--add-source=&lt;CIDR&gt;[--zone=&lt;ZONE&gt;] æ·»åŠ æºåœ°å€çš„æµé‡åˆ°æŒ‡å®šåŒºåŸŸï¼Œå¦‚æœæ— --zone= é€‰é¡¹ï¼Œä½¿ç”¨é»˜è®¤åŒºåŸŸ
--remove-source=&lt;CIDR&gt; [--zone=&lt;ZONE&gt;] ä»æŒ‡å®šåŒºåŸŸåˆ é™¤æºåœ°å€çš„æµé‡ï¼Œå¦‚æ— --zone= é€‰é¡¹ï¼Œä½¿ç”¨é»˜è®¤åŒºåŸŸ
--add-interface=&lt;INTERFACE&gt;[--zone=&lt;ZONE&gt;] æ·»åŠ æ¥è‡ªäºæŒ‡å®šæ¥å£çš„æµé‡åˆ°ç‰¹å®šåŒºåŸŸï¼Œå¦‚æœæ— --zone= é€‰é¡¹ï¼Œä½¿ç”¨é»˜è®¤åŒºåŸŸ
--change-interface=&lt;INTERFACE&gt;[--zone=&lt;ZONE&gt;] æ”¹å˜æŒ‡å®šæ¥å£è‡³æ–°çš„åŒºåŸŸï¼Œå¦‚æœæ— --zone=é€‰é¡¹ï¼Œä½¿ç”¨é»˜è®¤åŒºåŸŸ
--add-service=&lt;SERVICE&gt; [--zone=&lt;ZONE&gt;] å…è®¸æœåŠ¡çš„æµé‡é€šè¿‡ï¼Œå¦‚æœæ— --zone= é€‰é¡¹ï¼Œä½¿ç”¨é»˜è®¤åŒºåŸŸ
--add-port=&lt;PORT/PROTOCOL&gt;[--zone=&lt;ZONE&gt;] å…è®¸æŒ‡å®šç«¯å£å’Œåè®®çš„æµé‡ï¼Œå¦‚æœæ— --zone= é€‰é¡¹ï¼Œä½¿ç”¨é»˜è®¤åŒºåŸŸ
--remove-service=&lt;SERVICE&gt; [--zone=&lt;ZONE&gt;] ä»åŒºåŸŸä¸­åˆ é™¤æŒ‡å®šæœåŠ¡ï¼Œç¦æ­¢è¯¥æœåŠ¡æµé‡ï¼Œå¦‚æœæ— --zone= é€‰é¡¹ï¼Œä½¿ç”¨é»˜è®¤åŒºåŸŸ
--remove-port=&lt;PORT/PROTOCOL&gt;[--zone=&lt;ZONE&gt;] ä»åŒºåŸŸä¸­åˆ é™¤æŒ‡å®šç«¯å£å’Œåè®®ï¼Œç¦æ­¢è¯¥ç«¯å£çš„æµé‡ï¼Œå¦‚æœæ— --zone= é€‰é¡¹ï¼Œä½¿ç”¨é»˜è®¤åŒºåŸŸ
--reload åˆ é™¤å½“å‰è¿è¡Œæ—¶é…ç½®ï¼Œåº”ç”¨åŠ è½½æ°¸ä¹…é…ç½®
--list-services æŸ¥çœ‹å¼€æ”¾çš„æœåŠ¡
--list-ports Â æŸ¥çœ‹å¼€æ”¾çš„ç«¯å£
--list-all [--zone=&lt;ZONE&gt;] åˆ—å‡ºæŒ‡å®šåŒºåŸŸçš„æ‰€æœ‰é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¥å£ï¼Œæºåœ°å€ï¼Œç«¯å£ï¼ŒæœåŠ¡ç­‰ï¼Œå¦‚æœæ— --zone= é€‰é¡¹ï¼Œä½¿ç”¨é»˜è®¤åŒºåŸŸ
</pre>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#40664;&#35748;zone</span>
firewall-cmd --get-default-zone
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;zone&#35774;&#20026;dmz</span>
firewall-cmd --set-default-zone=dmz
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;internal zone&#20013;&#22686;&#21152;&#28304;&#22320;&#22336;192.168.0.0/24&#30340;&#27704;&#20037;&#35268;&#21017;</span>
firewall-cmd --permanent --zone=internal &#160;--add-source=192.168.0.0/24
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;internal zone&#20013;&#22686;&#21152;&#21327;&#35758;mysql&#30340;&#27704;&#20037;&#35268;&#21017;</span>
firewall-cmd --permanent --zone=internal &#160;--add-service=mysql
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#36733;&#26032;&#35268;&#21017;&#20197;&#29983;&#25928;</span>
firewall-cmd &#160;--reload

[root@centos8 ~]#firewall-cmd --get-zones
block dmz drop external home internal public trusted work
[root@centos7 ~]#firewall-cmd --get-service
RH-Satellite-6 amanda-client amanda-k5-client amqp amqps apcupsd audit bacula
bacula-client bgp bitcoin bitcoin-rpc bitcoin-testnet bitcoin-testnet-rpc ceph
ceph-mon cfengine condor-collector ctdb dhcp dhcpv6 dhcpv6-client distcc dns
docker-registry docker-swarm dropbox-lansync elasticsearch etcd-client etcd-
server finger freeipa-ldap freeipa-ldaps freeipa-replication freeipa-trust ftp
ganglia-client ganglia-master git gre high-availability http https imap imaps
ipp ipp-client ipsec irc ircs iscsi-target isns jenkins kadmin kerberos kibana
klogin kpasswd kprop kshell ldap ldaps libvirt libvirt-tls lightning-network
llmnr managesieve matrix mdns minidlna mongodb mosh mountd mqtt mqtt-tls ms-wbt
mssql murmur mysql nfs nfs3 nmea-0183 nrpe ntp nut openvpn ovirt-imageio ovirt-
storageconsole ovirt-vmconsole plex pmcd pmproxy pmwebapi pmwebapis pop3 pop3s
postgresql privoxy proxy-dhcp ptp pulseaudio puppetmaster quassel radius redis
rpc-bind rsh rsyncd rtsp salt-master samba samba-client samba-dc sane sip sips
slp smtp smtp-submission smtps snmp snmptrap spideroak-lansync squid ssh steam-
streaming svdrp svn syncthing syncthing-gui synergy syslog syslog-tls telnet
tftp tftp-client tinc tor-socks transmission-client upnp-client vdsm vnc-server
wbem-http wbem-https wsman wsmans xdmcp xmpp-bosh xmpp-client xmpp-local xmpp-
server zabbix-agent zabbix-server
</pre>
</div>

<p>
èŒƒä¾‹ï¼šé…ç½®firewalld
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl mask iptables
systemctl mask ip6tables
systemctl status firewalld
systemctl enable firewalld
systemctl start firewalld
firewall-cmd  --get-default-zone
firewall-cmd  --set-default-zone=public
firewall-cmd  --permanent  --zone=public  --list-all
firewall-cmd  --permanent  --zone=public  --add-port  8080/tcp
firewall-cmd  ---reload
</pre>
</div>
</div>
</div>
<div id="outline-container-h:806ec87a-80e8-4ccf-8127-d250c7f75195" class="outline-4">
<h4 id="h:806ec87a-80e8-4ccf-8127-d250c7f75195">å…¶å®ƒè§„åˆ™</h4>
<div class="outline-text-4" id="text-h:806ec87a-80e8-4ccf-8127-d250c7f75195">
<p>
å½“åŸºæœ¬firewalldè¯­æ³•è§„åˆ™ä¸èƒ½æ»¡è¶³è¦æ±‚æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ›´å¤æ‚çš„è§„åˆ™
</p>

<ul class="org-ul">
<li>rich-rules å¯Œè§„åˆ™ï¼ŒåŠŸèƒ½å¼º,è¡¨è¾¾æ€§è¯­è¨€</li>
<li>Direct configuration rules ç›´æ¥è§„åˆ™ï¼Œçµæ´»æ€§å·®, å¸®åŠ©ï¼šman 5
firewalld.direct</li>
</ul>
</div>
<div id="outline-container-h:78295a50-4b55-4296-b2f0-7acb14ba7f2b" class="outline-5">
<h5 id="h:78295a50-4b55-4296-b2f0-7acb14ba7f2b">ç®¡ç†richè§„åˆ™</h5>
<div class="outline-text-5" id="text-h:78295a50-4b55-4296-b2f0-7acb14ba7f2b">
<p>
richè§„åˆ™æ¯”åŸºæœ¬çš„firewalldè¯­æ³•å®ç°æ›´å¼ºçš„åŠŸèƒ½ï¼Œä¸ä»…å®ç°å…è®¸/æ‹’ç»ï¼Œè¿˜å¯ä»¥
å®ç°æ—¥å¿—syslogå’Œauditdï¼Œä¹Ÿå¯ä»¥å®ç°ç«¯å£è½¬å‘ï¼Œä¼ªè£…å’Œé™åˆ¶é€Ÿç‡
</p>

<p>
è§„åˆ™å®æ–½é¡ºåºï¼š
</p>

<ul class="org-ul">
<li>è¯¥åŒºåŸŸçš„ç«¯å£è½¬å‘ï¼Œä¼ªè£…è§„åˆ™</li>
<li>è¯¥åŒºåŸŸçš„æ—¥å¿—è§„åˆ™</li>
<li>è¯¥åŒºåŸŸçš„å…è®¸è§„åˆ™</li>
<li>è¯¥åŒºåŸŸçš„æ‹’ç»è§„åˆ™</li>
</ul>

<p>
æ¯ä¸ªåŒ¹é…çš„è§„åˆ™ç”Ÿæ•ˆï¼Œæ‰€æœ‰è§„åˆ™éƒ½ä¸åŒ¹é…ï¼Œè¯¥åŒºåŸŸé»˜è®¤è§„åˆ™ç”Ÿæ•ˆ
</p>

<p>
richè¯­æ³•ï¼š
</p>

<pre class="example" id="org3d8431e">
rule
    [source]
    [destination]
    service|port|protocol|icmp-block|masquerade|forward-port
    [log]
    [audit]
    [accept|reject|drop]
</pre>

<p>
man 5 firewalld.richlanguage richè§„åˆ™é€‰é¡¹
</p>

<div class="org-src-container">
<pre class="src src-sh">&#36873;&#39033; &#25551;&#36848;
--add-rich-rule=<span style="color: #8b2252;">''</span>     : Add to the specified zone, or the default zone if no zone is specified.
--remove-rich-rule=<span style="color: #8b2252;">''</span>  :  Remove to the specified zone, or the default zone if no zone is specified.
--query-rich-rule=<span style="color: #8b2252;">''</span>   :  Query if has been added to the specified zone, or the default zone if no zone is specified. Returns 0 if the rule is present, otherwise 1.
--list-rich-rules      :  Outputs all rich rules for the specified zone, or the default zone if no zone is specified.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c4dc736f-12ae-42ab-a428-09684a2a2216" class="outline-5">
<h5 id="h:c4dc736f-12ae-42ab-a428-09684a2a2216">richè§„åˆ™å®ç°</h5>
<div class="outline-text-5" id="text-h:c4dc736f-12ae-42ab-a428-09684a2a2216">
<p>
æ‹’ç»ä»192.168.0.100çš„æ‰€æœ‰æµé‡ï¼Œå½“address é€‰é¡¹ä½¿ç”¨source æˆ–destination
æ—¶ï¼Œå¿…é¡»ç”¨family=ipv4|ipv6
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --permanent --zone=public --add-rich-rule=<span style="color: #8b2252;">'rule &#160;family=ipv4 source address=192.168.0.100/32 reject'</span>
</pre>
</div>

<p>
é™åˆ¶æ¯åˆ†é’Ÿåªæœ‰ä¸¤ä¸ªè¿æ¥åˆ°ftpæœåŠ¡
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --add-rich-rule=<span style="color: #8b2252;">'rule service name=ftp limit value=2/m accept'</span>
</pre>
</div>

<p>
æŠ›å¼ƒespï¼ˆ IPsec ä½“ç³»ä¸­çš„ä¸€ç§ä¸»è¦åè®®ï¼‰åè®®çš„æ‰€æœ‰æ•°æ®åŒ…
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --permanent --add-rich-rule=<span style="color: #8b2252;">'rule protocol value=esp drop'</span>
</pre>
</div>

<p>
æ¥å—æ‰€æœ‰192.168.1.0/24å­ç½‘ç«¯å£5900-5905èŒƒå›´çš„TCPæµé‡
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --permanent --zone=vnc --add-rich-rule=<span style="color: #8b2252;">'rule family=ipv4 source address=192.168.1.0/24 port port=5900-5905 protocol=tcp accept'</span>
</pre>
</div>

<p>
<b>richæ—¥å¿—è§„åˆ™</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">log [<span style="color: #a0522d;">prefix</span>=<span style="color: #8b2252;">"&lt;PREFIX TEXT&gt;"</span> [<span style="color: #a0522d;">level</span>=&lt;LOGLEVEL&gt;] [limit <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"&lt;RATE/DURATION&gt;"</span>]

&lt;LOGLEVEL&gt; &#21487;&#20197;&#26159;emerg,alert, crit, error, warning, notice, info, debug.
&lt;DURATION&gt; s&#65306;&#31186;, m&#65306;&#20998;&#38047;, h&#65306;&#23567;&#26102;, d&#65306;&#22825;
audit [limit <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"&lt;RATE/DURATION&gt;"</span>]
</pre>
</div>

<p>
èŒƒä¾‹
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25509;&#21463;ssh&#26032;&#36830;&#25509;&#65292;&#35760;&#24405;&#26085;&#24535;&#21040;syslog&#30340;notice&#32423;&#21035;&#65292;&#27599;&#20998;&#38047;&#26368;&#22810;&#19977;&#26465;&#20449;&#24687;</span>
firewall-cmd --permanent --zone=work --add-rich-rule=<span style="color: #8b2252;">'rule service name="ssh" log prefix="ssh " level="notice" limit value="3/m" accept</span>

<span style="color: #8b2252;">#&#20174;2001:db8::/64&#23376;&#32593;&#30340;DNS&#36830;&#25509;&#22312;5&#20998;&#38047;&#20869;&#34987;&#25298;&#32477;&#65292;&#24182;&#35760;&#24405;&#21040;&#26085;&#24535;&#21040;audit,&#27599;&#23567;&#26102;&#26368;&#22823;&#35760;&#24405;&#19968;&#26465;&#20449;&#24687;</span>
<span style="color: #8b2252;">firewall-cmd --add-rich-rule='</span>rule <span style="color: #a0522d;">family</span>=ipv6 source <span style="color: #a0522d;">address</span>=<span style="color: #8b2252;">"2001:db8::/64"</span> service <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"dns"</span> audit limit <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"1/h"</span> reject<span style="color: #8b2252;">' --timeout=300</span>

<span style="color: #8b2252;">firewall-cmd --permanent --add-rich-rule='</span>rule <span style="color: #a0522d;">family</span>=ipv4 source <span style="color: #a0522d;">address</span>=172.25.X.10/32 service <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"http"</span> log <span style="color: #a0522d;">level</span>=notice <span style="color: #a0522d;">prefix</span>=<span style="color: #8b2252;">"NEW HTTP "</span> limit <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"3/s"</span> accept<span style="color: #8b2252;">'</span>

<span style="color: #8b2252;">firewall-cmd --reload</span>
<span style="color: #8b2252;">tail -f /var/log/messages</span>
<span style="color: #8b2252;">curl http://serverX.example.com</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c704eaa6-81e0-495d-9d46-336dd68d08b2" class="outline-5">
<h5 id="h:c704eaa6-81e0-495d-9d46-336dd68d08b2">ä¼ªè£…å’Œç«¯å£è½¬å‘</h5>
<div class="outline-text-5" id="text-h:c704eaa6-81e0-495d-9d46-336dd68d08b2">
<p>
NATç½‘ç»œåœ°å€è½¬æ¢ï¼Œfirewalldæ”¯æŒä¼ªè£…å’Œç«¯å£è½¬å‘ä¸¤ç§NATæ–¹å¼ <b>ä¼ªè£…NAT</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --permanent --zone=&lt;ZONE&gt; --add-masquerade
firewall-cmd --query-masquerade  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#26159;&#21542;&#20801;&#35768;&#20266;&#35013;</span>
firewall-cmd --add-masquerade  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20801;&#35768;&#38450;&#28779;&#22681;&#20266;&#35013;IP</span>
firewall-cmd --remove-masquerade <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#27490;&#38450;&#28779;&#22681;&#20266;&#35013;IP</span>
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --add-rich-rule=<span style="color: #8b2252;">'rule family=ipv4 source address=192.168.0.0/24 masquerade'</span>
</pre>
</div>

<p>
<b>ç«¯å£è½¬å‘</b>
</p>

<p>
ç«¯å£è½¬å‘ï¼šå°†å‘å¾€æœ¬æœºçš„ç‰¹å®šç«¯å£çš„æµé‡è½¬å‘åˆ°æœ¬æœºæˆ–ä¸åŒæœºå™¨çš„å¦ä¸€ä¸ªç«¯å£ã€‚
é€šå¸¸è¦é…åˆåœ°å€ä¼ªè£…æ‰èƒ½å®ç°
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --permanent --zone=&lt;ZONE&gt; --add-forward-port=<span style="color: #a0522d;">port</span>=&lt;PORTNUMBER&gt;:<span style="color: #a0522d;">proto</span>=&lt;PROTOCOL&gt;[:<span style="color: #a0522d;">toport</span>=&lt;PORTNUMBER&gt;][:<span style="color: #a0522d;">toaddr</span>=]
</pre>
</div>

<p>
è¯´æ˜ï¼štoport= å’Œtoaddr= è‡³å°‘è¦æŒ‡å®šä¸€ä¸ª
</p>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36716;&#21457;&#20256;&#20837;&#30340;&#36830;&#25509;9527/TCP&#65292;&#21040;&#38450;&#28779;&#22681;&#30340;80/TCP&#21040;public zone &#30340;192.168.0.254</span>
firewall-cmd --add-masquerade &#21551;&#29992;&#20266;&#35013;
firewall-cmd --zone=public --add-forward-
<span style="color: #a0522d;">port</span>=<span style="color: #a0522d;">port</span>=9527:<span style="color: #a0522d;">proto</span>=tcp:<span style="color: #a0522d;">toport</span>=80:<span style="color: #a0522d;">toaddr</span>=192.168.0.254
</pre>
</div>

<p>
richè§„åˆ™çš„portè½¬å‘è¯­æ³•ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">forward-port <span style="color: #a0522d;">port</span>=&lt;PORTNUM&gt; <span style="color: #a0522d;">protocol</span>=tcp|udp [to-port=&lt;PORTNUM&gt;] [to-addr=&lt;ADDRESS&gt;]
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36716;&#21457;&#20174;192.168.0.0/24&#26469;&#30340;&#65292;&#21457;&#24448;80/TCP&#30340;&#27969;&#37327;&#21040;&#38450;&#28779;&#22681;&#30340;&#31471;&#21475;8080/TCP</span>
firewall-cmd --zone=work --add-rich-rule=<span style="color: #8b2252;">'rule family=ipv4 source address=192.168.0.0/24 forward-port port=80 protocol=tcp to-port=8080'</span>

firewall-cmd --permanent --add-rich-rule <span style="color: #8b2252;">'rule family=ipv4 source address=172.25.X.10/32 forward-port port=443 protocol=tcp to-port=22'</span>

firewall-cmd --reload
ssh -p 443 serverX.example.com
</pre>
</div>

<p>
èŒƒä¾‹ï¼šé™åˆ¶sshæœåŠ¡éæ ‡å‡†ç«¯å£è®¿é—®
</p>

<div class="org-src-container">
<pre class="src src-sh">cp /usr/lib/firewalld/services/ssh.xml /etc/firewalld/services/ssh.xml
vim /etc/firewalld/services/ssh.xml
&lt;port <span style="color: #a0522d;">protocol</span>=<span style="color: #8b2252;">"tcp"</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">"999"</span>/&gt;
systemctl restart sshd.service
systemctl status -l sshd.service
sealert -a /var/log/audit/audit.log
semanage port -a -t ssh_port_t -p tcp 999
systemctl restart sshd.service
ss -tulpn | grep sshd
firewall-cmd --permanent --zone=work --add-source=172.25.X.0/24
firewall-cmd --permanent --zone=work --add-port=999/tcp
firewall-cmd --reload
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:0a0b62a6-a444-4118-aaec-7df4fd02a865" class="outline-3">
<h3 id="h:0a0b62a6-a444-4118-aaec-7df4fd02a865">nft</h3>
<div class="outline-text-3" id="text-h:0a0b62a6-a444-4118-aaec-7df4fd02a865">
</div>
<div id="outline-container-h:a1a99e5f-96c5-4107-83a3-aba163a9360a" class="outline-4">
<h4 id="h:a1a99e5f-96c5-4107-83a3-aba163a9360a">nft ä»‹ç»</h4>
<div class="outline-text-4" id="text-h:a1a99e5f-96c5-4107-83a3-aba163a9360a">
<p>
nftables æ˜¯ä¸€ä¸ª netfilter é¡¹ç›®ï¼Œæ—¨åœ¨æ›¿æ¢ç°æœ‰çš„ {ip,ip6,arp,eb}tablesæ¡†
æ¶ï¼Œä¸º {ip,ip6}tablesæä¾›ä¸€ä¸ªæ–°çš„åŒ…è¿‡æ»¤æ¡†æ¶ã€ä¸€ä¸ªæ–°çš„ç”¨æˆ·ç©ºé—´å®ç”¨ç¨‹åº
ï¼ˆnftï¼‰å’Œä¸€ä¸ªå…¼å®¹å±‚ã€‚å®ƒä½¿ç”¨ç°æœ‰çš„é’©å­ã€é“¾æ¥è·Ÿè¸ªç³»ç»Ÿã€ç”¨æˆ·ç©ºé—´æ’é˜Ÿç»„ä»¶
å’Œnetfilter æ—¥å¿—å­ç³»ç»Ÿã€‚
</p>

<p>
nftables ä¸»è¦ç”±ä¸‰ä¸ªç»„ä»¶ç»„æˆï¼šå†…æ ¸å®ç°ã€libnl netlink é€šä¿¡å’Œ nftablesç”¨
æˆ·ç©ºé—´ã€‚ å…¶ä¸­å†…æ ¸æä¾›äº†ä¸€ä¸ª netlinké…ç½®æ¥å£ä»¥åŠè¿è¡Œæ—¶è§„åˆ™é›†è¯„ä¼°ï¼Œlibnl
åŒ…å«äº†ä¸å†…æ ¸é€šä¿¡çš„åŸºæœ¬å‡½æ•°ï¼Œç”¨æˆ·ç©ºé—´å¯ä»¥é€šè¿‡nft å’Œç”¨æˆ·è¿›è¡Œäº¤äº’ã€‚
</p>

<p>
åœ¨ Linux å†…æ ¸ç‰ˆæœ¬é«˜äº 3.13 æ—¶å¯ç”¨ã€‚æä¾›ä¸€ä¸ªæ–°çš„å‘½ä»¤è¡Œå·¥å…· nft è¯­æ³•ä¸iptables ä¸åŒã€‚
</p>

<p>
å®˜æ–¹Wikiï¼š<a href="https://wiki.nftables.org">https://wiki.nftables.org</a>
</p>

<p>
å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://www.netfilter.org/projects/nftables/manpage.html">https://www.netfilter.org/projects/nftables/manpage.html</a>
</p>

<p>
å‚è€ƒæ–‡æ¡£ï¼š<a href="https://www.mankier.com/8/nft">https://www.mankier.com/8/nft</a>
</p>
</div>
</div>
<div id="outline-container-h:b0f07a19-43b1-4f37-9b87-1b8d11589c6c" class="outline-4">
<h4 id="h:b0f07a19-43b1-4f37-9b87-1b8d11589c6c">nft ç›¸å…³æ¦‚å¿µ</h4>
<div class="outline-text-4" id="text-h:b0f07a19-43b1-4f37-9b87-1b8d11589c6c">
<p>
nftables å’Œ iptablesä¸€æ ·ï¼Œç”±è¡¨ï¼ˆtableï¼‰ã€é“¾ï¼ˆchainï¼‰å’Œè§„åˆ™ï¼ˆruleï¼‰ç»„æˆï¼Œ
å…¶ä¸­è¡¨åŒ…å«é“¾ï¼Œé“¾åŒ…å«è§„åˆ™ï¼Œè§„åˆ™æ˜¯çœŸæ­£çš„actionï¼Œè§„åˆ™ç”±åœ°å€ï¼Œæ¥å£ï¼Œç«¯å£æˆ–
åŒ…å«å½“å‰å¤„ç†æ•°æ®åŒ…ä¸­çš„å…¶ä»–æ•°æ®ç­‰è¡¨è¾¾å¼ä»¥åŠè¯¸å¦‚drop, queue, continueç­‰
å£°æ˜ç»„æˆã€‚
</p>

<p>
ä¸ iptables ç›¸æ¯”ï¼Œnftables ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªå˜åŒ–ï¼š
</p>

<ul class="org-ul">
<li>iptables è§„åˆ™çš„å¸ƒå±€æ˜¯åŸºäºè¿ç»­çš„å¤§å—å†…å­˜çš„ï¼Œå³æ•°ç»„å¼å¸ƒå±€ï¼›è€Œ nftables
çš„è§„åˆ™é‡‡ç”¨é“¾å¼å¸ƒå±€ï¼Œå³æ•°ç»„å’Œé“¾è¡¨çš„åŒºåˆ«</li>
<li>iptableså¤§éƒ¨åˆ†å·¥ä½œåœ¨å†…æ ¸æ€å®Œæˆï¼Œå¦‚æœè¦æ·»åŠ æ–°åŠŸèƒ½ï¼Œåªèƒ½é‡æ–°ç¼–è¯‘å†…æ ¸ï¼›
è€Œnftablesçš„å¤§éƒ¨åˆ†å·¥ä½œæ˜¯åœ¨ç”¨æˆ·æ€å®Œæˆçš„ï¼Œæ·»åŠ æ–°åŠŸèƒ½æ›´åŠ å®¹æ˜“ï¼Œä¸éœ€è¦æ”¹
å†…æ ¸</li>
<li>nftablesä¸åŒ…å«ä»»ä½•å†…ç½®è¡¨å’Œé“¾</li>
<li>æ‹¥æœ‰ä½¿ç”¨é¢å¤–è„šæœ¬çš„èƒ½åŠ›,æ‹¥æœ‰ä¸€äº›é«˜çº§çš„ç±»ä¼¼ç¼–ç¨‹è¯­è¨€çš„èƒ½åŠ›ï¼Œä¾‹å¦‚å®šä¹‰å˜
é‡å’ŒåŒ…å«å¤–éƒ¨æ–‡ä»¶</li>
<li>iptables æœ‰å†…ç½®çš„é“¾ï¼Œå³ä½¿åªéœ€è¦ä¸€æ¡é“¾ï¼Œå…¶ä»–çš„é“¾ä¹Ÿä¼šè·Ÿç€æ³¨å†Œï¼›è€Œ
nftables ä¸å­˜åœ¨å†…ç½®çš„é“¾ï¼Œå¯ä»¥æŒ‰éœ€æ³¨å†Œã€‚ç”±äº iptableså†…ç½®äº†ä¸€ä¸ªæ•°æ®åŒ…
è®¡æ•°å™¨ï¼Œæ‰€ä»¥å³ä½¿è¿™äº›å†…ç½®çš„é“¾æ˜¯ç©ºçš„ï¼Œä¹Ÿä¼šå¸¦æ¥æ€§èƒ½æŸè€—</li>
<li>ç®€åŒ–äº† IPv4/IPv6 åŒæ ˆç®¡ç†</li>
<li>åŸç”Ÿæ”¯æŒé›†åˆã€å­—å…¸å’Œæ˜ å°„</li>
</ul>

<p>
nftablesçš„æ¯ä¸ªè¡¨åªæœ‰ä¸€ä¸ªåœ°å€ç°‡ï¼Œå¹¶ä¸”åªé€‚ç”¨äºè¯¥ç°‡çš„æ•°æ®åŒ…ã€‚è¡¨å¯ä»¥æŒ‡å®šäº”
ä¸ªç°‡ä¸­çš„ä¸€ä¸ªï¼š
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">nftablesç°‡</td>
<td class="org-left">iptableså‘½ä»¤è¡Œå·¥å…·</td>
</tr>

<tr>
<td class="org-left">ip (IPv4åœ°å€)</td>
<td class="org-left">iptables é»˜è®¤</td>
</tr>

<tr>
<td class="org-left">ip6 (IPv6 åœ°å€)</td>
<td class="org-left">ip6tables</td>
</tr>

<tr>
<td class="org-left">inet (IPv4 å’Œ IPv6 åœ°å€)</td>
<td class="org-left">iptableså’Œip6tables</td>
</tr>

<tr>
<td class="org-left">arp åœ°å€è§£æåè®®(ARP)åœ°å€</td>
<td class="org-left">arptables</td>
</tr>

<tr>
<td class="org-left">bridge å¤„ç†æ¡¥æ¥æ•°æ®åŒ…</td>
<td class="org-left">ebtables</td>
</tr>
</tbody>
</table>

<p>
<code>inet</code> åŒæ—¶é€‚ç”¨äº IPv4 å’Œ IPv6 çš„æ•°æ®åŒ…ï¼Œå³ç»Ÿä¸€äº† ip å’Œ ip6ç°‡ï¼Œå¯ä»¥æ›´
å®¹æ˜“åœ°å®šä¹‰è§„åˆ™ï¼Œæ³¨ï¼šå½“æ²¡æœ‰æŒ‡å®šåœ°å€ç°‡æ—¶ï¼Œé»˜è®¤ä¸ºip
</p>

<p>
IPv4/IPv6/Inet address family hooks é’©å­å‡½æ•°
</p>

<pre class="example" id="orga55b51e">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Hook    â”‚ Description             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚prerouting â”‚ All packets entering the system are â”‚
â”‚      â”‚ processed by the prerouting hook. It â”‚
â”‚      â”‚ is invoked  before  the  routing â”‚
â”‚      â”‚ process and is used for early fil- â”‚
â”‚      â”‚ tering or changing packet attributes â”‚
â”‚      â”‚ that affect routing.         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚input    â”‚ Packets delivered to the local sys- â”‚
â”‚      â”‚ tem are processed by the input hook. â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚forward   â”‚ Packets forwarded to a different â”‚
â”‚      â”‚ host are processed by the forward â”‚
â”‚      â”‚ hook.                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚output   â”‚ Packets sent by local processes are â”‚
â”‚      â”‚ processed by the output hook.    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚postrouting â”‚ All packets leaving the system are â”‚
â”‚      â”‚ processed by the postrouting hook.
</pre>

<p>
é“¾æ˜¯ç”¨æ¥ä¿å­˜è§„åˆ™çš„ï¼Œå’Œè¡¨ä¸€æ ·ï¼Œé“¾ä¹Ÿéœ€è¦è¢«æ˜¾ç¤ºåˆ›å»ºï¼Œå› ä¸º nftablesæ²¡æœ‰å†…
ç½®çš„é“¾ã€‚é“¾æœ‰ä»¥ä¸‹ä¸¤ç§ç±»å‹ï¼š
</p>

<ul class="org-ul">
<li><b>åŸºæœ¬é“¾</b> :æ•°æ®åŒ…çš„å…¥å£ç‚¹ï¼Œéœ€è¦æŒ‡å®šé’©å­ç±»å‹å’Œä¼˜å…ˆçº§ï¼Œç›¸å½“äºå†…ç½®é“¾ã€‚é»˜
è®¤æ²¡æœ‰ï¼Œè¦è‡ªå·±åˆ›å»ºå’Œé’©å­å‡½æ•°å…³è”</li>
<li><b>å¸¸è§„é“¾</b> :ä¸éœ€è¦æŒ‡å®šé’©å­ç±»å‹å’Œä¼˜å…ˆçº§ï¼Œå¯ä»¥ç”¨æ¥åšè·³è½¬ï¼Œä»é€»è¾‘ä¸Šå¯¹è§„åˆ™
è¿›è¡Œåˆ†ç±»ï¼Œç±»ä¼¼äºè‡ªå®šä¹‰é“¾</li>
</ul>

<p>
èŒƒä¾‹: CentOS 8.2 nftables åŒ…
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -qi nftables
Name    : nftables
Version   : 0.9.3
Release   : 12.el8

[root@centos8 ~]#rpm -ql nftables
/etc/nftables
/etc/nftables/main.nft
/etc/nftables/nat.nft
/etc/nftables/osf
etc/nftables/osf/pf.os
/etc/nftables/router.nft
/etc/sysconfig/nftables.conf
/usr/lib/.build-id
/usr/lib/.build-id/77
/usr/lib/.build-id/77/9a947d234d9faf842b8016c7eb449d3a4c8ac0
/usr/lib/.build-id/9d
/usr/lib/.build-id/9d/fc589c6496ba18fad71d3121539c225fbb346d
/usr/lib/systemd/system/nftables.service
/usr/lib64/libnftables.so.1
/usr/lib64/libnftables.so.1.0.0
/usr/sbin/nft
/usr/share/doc/nftables/examples/ct_helpers.nft
/usr/share/doc/nftables/examples/load_balancing.nft
/usr/share/doc/nftables/examples/secmark.nft
/usr/share/doc/nftables/examples/sets_and_maps.nft
/usr/share/licenses/nftables
/usr/share/licenses/nftables/COPYING
/usr/share/man/man5/libnftables-json.5.gz
/usr/share/man/man8/nft.8.gz

[root@centos8 ~]#cat /etc/sysconfig/nftables.conf
<span style="color: #b22222;"># </span><span style="color: #b22222;">Uncomment the include statement here to load the default config sample</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">in /etc/nftables for nftables service.</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">include "/etc/nftables/main.nft"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">To customize, either edit the samples in /etc/nftables, append further</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">commands to the end of this file or overwrite it after first service</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">start by calling: 'nft list ruleset &gt;/etc/sysconfig/nftables.conf'.</span>

[root@centos8 ~]#systemctl start nftables
</pre>
</div>

<p>
èŒƒä¾‹ï¼šCentOS 8.1 nftables åŒ…
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]# rpm -qi nftables
Name    : nftables
Epoch    : 1
Version   : 0.9.0
Release   : 14.el8

[root@centos8 ~]#rpm -ql nftables
/etc/nftables
/etc/nftables/all-in-one.nft
/etc/nftables/arp-filter.nft
/etc/nftables/bridge-filter.nft
/etc/nftables/inet-filter.nft
/etc/nftables/ipv4-filter.nft
/etc/nftables/ipv4-mangle.nft
/etc/nftables/ipv4-nat.nft
/etc/nftables/ipv4-raw.nft
/etc/nftables/ipv6-filter.nft
/etc/nftables/ipv6-mangle.nft
/etc/nftables/ipv6-nat.nft
/etc/nftables/ipv6-raw.nft
/etc/nftables/netdev-ingress.nft
/etc/sysconfig/nftables.conf
/usr/lib/.build-id
/usr/lib/.build-id/68
/usr/lib/.build-id/68/8ad5e5fdc5ba8d10bf227ba50d77fd99040c1c
/usr/lib/.build-id/cc
/usr/lib/.build-id/cc/43827ec42d27875c99ce6bd0f0537614e0129a
/usr/lib/systemd/system/nftables.service
/usr/lib64/libnftables.so.0
/usr/lib64/libnftables.so.0.0.0
/usr/sbin/nft
/usr/share/licenses/nftables
/usr/share/licenses/nftables/COPYING
/usr/share/man/man8/nft.8.gz

[root@centos8 ~]#cat /etc/sysconfig/nftables.conf
<span style="color: #b22222;">#</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">This this will contain your nftables rules and</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">is read by the systemd service when restarting</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">These provide an iptables like set of filters</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">(uncomment to include)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">include "/etc/nftables/bridge-filter.nft"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">include "/etc/nftables/inet-filter.nft"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">include "/etc/nftables/ipv4-filter.nft"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">include "/etc/nftables/ipv4-mangle.nft"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">include "/etc/nftables/ipv4-nat.nft"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">include "/etc/nftables/ipv6-filter.nft"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">include "/etc/nftables/ipv6-mangle.nft"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">include "/etc/nftables/ipv6-nat.nft</span>

[root@centos8 ~]#systemctl start nftables
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6264a49f-7034-4735-84ef-53c280186229" class="outline-4">
<h4 id="h:6264a49f-7034-4735-84ef-53c280186229">nft å¸¸è§ç”¨æ³•</h4>
<div class="outline-text-4" id="text-h:6264a49f-7034-4735-84ef-53c280186229">
</div>
<div id="outline-container-h:d8e57b03-a530-444a-ac56-44c785493f97" class="outline-5">
<h5 id="h:d8e57b03-a530-444a-ac56-44c785493f97">nft å‘½ä»¤æ ¼å¼</h5>
<div class="outline-text-5" id="text-h:d8e57b03-a530-444a-ac56-44c785493f97">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft --help
Usage: nft [ options ] [ cmds... ]
&#36873;&#39033;&#35828;&#26126;
-h, --help &#26174;&#31034;&#24110;&#20070;
-v, --version &#26174;&#31034;&#29256;&#26412;&#20449;&#24687;
-c, --check &#26816;&#26597;&#21629;&#20196;&#30340;&#26377;&#25928;&#24615;&#65292;&#32780;&#19981;&#23454;&#38469;&#24212;&#29992;&#26356;&#25913;&#12290;
-f, --file &lt;filename&gt; &#21253;&#21547;&#25991;&#20214;&#20869;&#23481;&lt;filename&gt;
-i, --interactive &#20174;&#21629;&#20196;&#34892;&#35835;&#21462;&#36755;&#20837;
-j, --json &#20197;JSON&#26684;&#24335;&#21270;&#36755;&#20986;
-n, --numeric &#25351;&#23450;&#19968;&#27425;&#21518;&#65292;&#20197;&#25968;&#23383;&#26041;&#24335;&#26174;&#31034;&#32593;&#32476;&#22320;&#22336;&#65288;&#40664;&#35748;&#34892;&#20026;&#65289;&#12290;&#25351;&#23450;&#20004;&#27425;&#20197;&#25968;&#23383;&#26041;&#24335;&#26174;&#31034;Internet&#26381;&#21153;&#65288;&#31471;&#21475;&#21495;&#65289;&#12290;&#25351;&#23450;&#19977;&#27425;&#20197;&#25968;&#23383;&#26041;&#24335;&#26174;&#31034;&#21327;&#35758;&#65292;&#29992;&#25143;ID&#21644;&#32452;ID&#12290;
-s, --stateless &#30465;&#30053;&#35268;&#21017;&#38598;&#30340;&#26377;&#29366;&#24577;&#20449;&#24687;
-N &#23558;IP&#22320;&#22336;&#36716;&#25442;&#20026;&#21517;&#31216;&#12290;
-a, --handle &#26174;&#31034;&#35268;&#21017;&#21477;&#26564;handle
-e, --echo Echo what has been added, inserted or replaced.
-I, --includepath &lt;directory&gt; &#28155;&#21152;&lt;directory&gt;&#30446;&#24405;&#21040;&#21253;&#21547;&#25991;&#20214;&#30340;&#25628;&#32034;&#36335;&#24452;&#20013;&#12290;&#40664;&#35748;&#20026;: /etc
--debug &lt;level [,level...]&gt; &#28155;&#21152;&#35843;&#35797;,&#22312;level&#22788;(scanner, parser, eval, netlink,mnl, proto-ctx, segtree, all)
</pre>
</div>

<p>
<b>nft å‘½ä»¤åŸºæœ¬æ ¼å¼</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">nft &#25805;&#20316;&#31526; &#25805;&#20316;&#30446;&#26631; &#25805;&#20316;&#20869;&#23481;

1 &#25805;&#20316;&#31526;: &#22686;,&#21024;,&#25913;,&#26597;,&#28165;&#38500;,&#25554;&#20837;,&#21019;&#24314;
&#34920;&#25805;&#20316;&#65306;add,delete,list,flush
&#38142;&#25805;&#20316;&#65306;add,delete,rename,list,flush,create
&#35268;&#21017;&#65306;add,delete,insert

2 &#25805;&#20316;&#30446;&#26631;: &#31751;,&#34920;,&#38142;,&#35268;&#21017;
&#38142;&#31867;&#22411;&#65306;filter,route,nat
&#38142;&#38057;&#23376;&#65306;hook

3 &#25805;&#20316;&#20869;&#23481;&#65306;...
</pre>
</div>

<p>
<b>è§„åˆ™é€‰é¡¹</b>
</p>

<p>
ç±»ä¼¼äºiptableçš„ target
</p>

<table>


<colgroup>
<col  class="org-right">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">1</th>
<th scope="col" class="org-left">accept</th>
<th scope="col" class="org-left">æ¥å—</th>
<th scope="col" class="org-left">æ¥å— åŒ…</th>
<th scope="col" class="org-left">åœæ­¢å¤„ç†</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2</td>
<td class="org-left">drop</td>
<td class="org-left">ä¸¢å¼ƒ</td>
<td class="org-left">ä¸¢å¼ƒåŒ…</td>
<td class="org-left">åœæ­¢å¤„ç†</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">reject</td>
<td class="org-left">æ‹’ç»</td>
<td class="org-left">é©³å›åŒ…</td>
<td class="org-left">åœæ­¢å¤„ç†</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">queue</td>
<td class="org-left">é˜Ÿåˆ—</td>
<td class="org-left">å‘é€åŒ…åˆ°ç”¨æˆ·ç©ºé—´ç¨‹åº</td>
<td class="org-left">åœæ­¢å¤„ç†</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">continue</td>
<td class="org-left">ç»§ç»­</td>
<td class="org-left">ç»§ç»­å¤„ç†åŒ…</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">return</td>
<td class="org-left">è¿”å›</td>
<td class="org-left">å‘é€åˆ°è°ƒç”¨çš„è§„åˆ™é“¾è¿›è¡Œå¤„ç†</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">jump</td>
<td class="org-left">è·³è·ƒ</td>
<td class="org-left">å‘é€åˆ°æŒ‡å®šçš„è§„åˆ™é“¾è¿›è¡Œå¤„ç†</td>
<td class="org-left">å½“å®Œæˆæ—¶æˆ–æ‰§è¡Œäº†è¿”å›çš„å£°æ˜ï¼Œè¿”å›åˆ°è°ƒç”¨çš„è§„åˆ™é“¾</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">goto</td>
<td class="org-left">è½¬åˆ°</td>
<td class="org-left">å‘é€åˆ°æŒ‡å®šçš„è§„åˆ™é“¾è¿›è¡Œå¤„ç†</td>
<td class="org-left">ä¸è¿”å›åˆ°è°ƒç”¨çš„è§„åˆ™é“¾</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-left">limit</td>
<td class="org-left">limit</td>
<td class="org-left">è¾¾åˆ°æ¥æ”¶åŒ…çš„åŒ¹é…é™åˆ¶ï¼Œ</td>
<td class="org-left">åˆ™æ ¹æ®è§„åˆ™å¤„ç†åŒ…</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left">log</td>
<td class="org-left">log</td>
<td class="org-left">æ—¥å¿—è®°å½•åŒ…</td>
<td class="org-left">ç»§ç»­å¤„ç†</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:51a4e412-7377-4184-a4e6-874b2ddf6433" class="outline-5">
<h5 id="h:51a4e412-7377-4184-a4e6-874b2ddf6433">æŸ¥çœ‹</h5>
<div class="outline-text-5" id="text-h:51a4e412-7377-4184-a4e6-874b2ddf6433">
<div class="org-src-container">
<pre class="src src-sh">nft list ruleset            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;&#35268;&#21017;</span>
nft list tables             <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;&#34920;</span>
nft list table filter       <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21015;&#20986;ip&#31751;&#30340;filter&#34920;</span>
nft list table inet filter  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21015;&#20986;inet&#31751;&#30340;filter&#34920;</span>
nft list chain filter INPUT <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21015;&#20986;filter&#34920;input&#38142;</span>
&#20197;&#19978;&#21629;&#20196;&#21518;&#38754;&#20063;&#21487;&#20197;&#21152; -nn &#29992;&#20110;&#19981;&#35299;&#26512;ip&#22320;&#22336;&#21644;&#31471;&#21475;
&#21152; -a &#29992;&#20110;&#26174;&#31034; handles
</pre>
</div>

<p>
èŒƒä¾‹ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft list tables
[root@centos8 ~]#vim /etc/sysconfig/nftables.conf
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#27492;&#34892;&#21069;&#30340;&#27880;&#37322;</span>
include <span style="color: #8b2252;">"/etc/nftables/inet-filter.nft"</span> 

[root@centos8 ~]#systemctl restart nftables.service
[root@centos8 ~]#nft list tables
table inet filter

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#20026;ip&#31751;&#65292;&#26080;&#35268;&#21017;</span>
[root@centos8 ~]#nft list table filter
Error: Could not process rule: No such file or directory
list table filter
     ^^^^^^

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;inet&#31751;&#25165;&#26377;&#35268;&#21017;</span>
[root@centos8 ~]#nft list table inet filter
table inet filter {
chain input {
<span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
}
chain forward {
<span style="color: #483d8b;">type</span> filter hook forward priority 0; policy accept;
}
chain output {
<span style="color: #483d8b;">type</span> filter hook output priority 0; policy accept;
}
}
[root@centos8 ~]#nft list ruleset
table inet filter {
chain input {
<span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
}
chain forward {
<span style="color: #483d8b;">type</span> filter hook forward priority 0; policy accept;
}
chain output {
<span style="color: #483d8b;">type</span> filter hook output priority 0; policy accept;
}
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:dd1fd1c3-d648-4d0b-b745-b7485d0e1f49" class="outline-5">
<h5 id="h:dd1fd1c3-d648-4d0b-b745-b7485d0e1f49">å¢åŠ </h5>
<div class="outline-text-5" id="text-h:dd1fd1c3-d648-4d0b-b745-b7485d0e1f49">
<pre class="example" id="orga22a829">
å¢åŠ è¡¨ï¼šnft add table fillter
å¢åŠ é“¾ï¼šnft add chain filter input { type filter hook input priority 0 \; } # è¦å’Œhookï¼ˆé’©å­ï¼‰ç›¸å…³è¿
å¢åŠ è§„åˆ™ï¼šnft add rule filter input tcp dport 22 accept
</pre>
</div>
</div>
<div id="outline-container-h:83e2bb90-cca5-4185-b2e4-7cbd1c951381" class="outline-5">
<h5 id="h:83e2bb90-cca5-4185-b2e4-7cbd1c951381">åˆ </h5>
<div class="outline-text-5" id="text-h:83e2bb90-cca5-4185-b2e4-7cbd1c951381">
<p>
åªéœ€è¦æŠŠä¸Šé¢çš„ add æ”¹ä¸º delete å³å¯
</p>
</div>
</div>
<div id="outline-container-h:334df536-c47f-4048-abc0-702f5433e147" class="outline-5">
<h5 id="h:334df536-c47f-4048-abc0-702f5433e147">æ”¹</h5>
<div class="outline-text-5" id="text-h:334df536-c47f-4048-abc0-702f5433e147">
<p>
æ›´æ”¹é“¾åç”¨rename æ›´æ”¹è§„åˆ™ç”¨replace
</p>
</div>
</div>
</div>
<div id="outline-container-h:e25d4407-518a-4c42-a383-b6ce70adb185" class="outline-4">
<h4 id="h:e25d4407-518a-4c42-a383-b6ce70adb185">nft å®æˆ˜æ¡ˆä¾‹</h4>
<div class="outline-text-4" id="text-h:e25d4407-518a-4c42-a383-b6ce70adb185">
</div>
<div id="outline-container-h:c801d4c7-7697-4d86-8328-18b5e368bf8b" class="outline-5">
<h5 id="h:c801d4c7-7697-4d86-8328-18b5e368bf8b">åˆ›å»ºè¡¨å’Œåˆ é™¤è¡¨</h5>
<div class="outline-text-5" id="text-h:c801d4c7-7697-4d86-8328-18b5e368bf8b">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft add table inet test_table    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#33258;&#23450;&#20041;&#34920;</span>
[root@centos8 ~]#nft list tables
table inet filter
table inet test_table

[root@centos8 ~]#nft delete table inet test_table <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#33258;&#23450;&#20041;&#34920;</span>
[root@centos8 ~]#nft list tables
table inet filter
[root@centos8 ~]#nft add table inet test_table
</pre>
</div>

<p>
<b>åˆ—å‡ºæ‰€æœ‰çš„è§„åˆ™ï¼š</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft list ruleset
table inet filter {
    chain input {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
    }
    chain forward {
        <span style="color: #483d8b;">type</span> filter hook forward priority 0; policy accept;
    }
    chain output {
        <span style="color: #483d8b;">type</span> filter hook output priority 0; policy accept;
    }
}
table inet test_table {
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2af0f5cc-c874-4f48-a66f-00c90097506a" class="outline-5">
<h5 id="h:2af0f5cc-c874-4f48-a66f-00c90097506a">åˆ›å»ºé“¾</h5>
<div class="outline-text-5" id="text-h:2af0f5cc-c874-4f48-a66f-00c90097506a">
<p>
ç°åœ¨è¡¨ä¸­è¿˜æ²¡æœ‰ä»»ä½•è§„åˆ™ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªé“¾æ¥ä¿å­˜è§„åˆ™
</p>

<p>
<b>åˆ›å»ºåŸºæœ¬é“¾ï¼š</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft add chain inet test_table test_filter_input_chain { <span style="color: #483d8b;">type</span> filter hook input priority 0 <span style="color: #8b2252;">\;</span> }
</pre>
</div>

<ul class="org-ul">
<li>åæ–œçº¿ï¼ˆ <code>\</code> ï¼‰ç”¨æ¥è½¬ä¹‰ï¼Œè¿™æ · shell å°±ä¸ä¼šå°†åˆ†å·è§£é‡Šä¸ºå‘½ä»¤çš„ç»“å°¾ã€‚</li>
<li>priority é‡‡ç”¨æ•´æ•°å€¼ï¼Œå¯ä»¥æ˜¯è´Ÿæ•°ï¼Œå€¼è¾ƒå°çš„é“¾ä¼˜å…ˆå¤„ç†</li>
</ul>

<p>
<b>åˆ›å»ºå¸¸è§„é“¾ï¼š</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft add chain inet test_table test_chain
</pre>
</div>

<p>
<b>åˆ—å‡ºé“¾ï¼š</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft list table inet test_table
table inet test_table {
  chain test_filter_input_chain {
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
  }

  chain test_chain {
  }
}

[root@centos8 ~]#nft list chain inet test_table test_filter_input_chain
table inet test_table {
  chain test_filter_input_chain {
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
  }
}

[root@centos8 ~]#nft list chain inet test_table test_chain
table inet test_table {
  chain test_chain {
  }
}

[root@centos8 ~]#nft list ruleset
</pre>
</div>
</div>
</div>
<div id="outline-container-h:86b0ee29-5a01-43c5-a5a2-36c63b8534e1" class="outline-5">
<h5 id="h:86b0ee29-5a01-43c5-a5a2-36c63b8534e1">åˆ›å»ºè§„åˆ™</h5>
<div class="outline-text-5" id="text-h:86b0ee29-5a01-43c5-a5a2-36c63b8534e1">
</div>
<ul class="org-ul">
<li><a id="h:853c2b7c-0a4e-484b-908c-c69b96724140"></a>åˆ›å»ºå¸¸è§„é“¾è§„åˆ™<br>
<div class="outline-text-6" id="text-h:853c2b7c-0a4e-484b-908c-c69b96724140">
<p>
æœ‰äº†è¡¨å’Œé“¾ä¹‹åï¼Œå°±å¯ä»¥åˆ›å»ºè§„åˆ™äº†ï¼Œè§„åˆ™ç”±è¯­å¥æˆ–è¡¨è¾¾å¼æ„æˆï¼ŒåŒ…å«åœ¨é“¾ä¸­
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#24120;&#35268;&#38142;&#30340;&#35268;&#21017;</span>
[root@centos8 ~]#nft add rule inet test_table test_chain tcp dport http reject <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25298;&#32477;http&#26381;&#21153;&#35775;&#38382;</span>
[root@centos8 ~]#nft add rule inet test_table test_chain tcp dport 443 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25298;&#32477;http&#26381;&#21153;&#35775;&#38382;</span>
[root@centos8 ~]#nft list chain inet test_table test_chain
table inet test_table {
  chain test_chain {
    tcp dport 80 reject
    tcp dport 443 reject
  }
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24120;&#35268;&#38142;&#35268;&#21017;&#40664;&#35748;&#19981;&#29983;&#25928;&#65292;&#24517;&#39035;&#20851;&#32852;&#21040;&#38057;&#23376;&#20989;&#25968;&#19978;</span>
[root@centos7 ~]#curl 10.0.0.8
rft Http Server
</pre>
</div>

<p>
insertæ’å…¥è§„åˆ™è¡¨ç¤ºå°†è§„åˆ™æ·»åŠ åˆ°é“¾çš„å¼€å¤´ï¼Œç›¸å½“äº <code>iptables -I</code> ã€‚addè¡¨ç¤º
å°†è§„åˆ™æ·»åŠ åˆ°é“¾çš„æœ«å°¾ã€‚
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]# nft insert rule inet test_table test_chain tcp dport mysql reject
</pre>
</div>

<p>
åˆ—å‡ºè§„åˆ™ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft list chain inet test_table test_chain
table inet test_table {
  chain test_chain {
    tcp dport 3306 reject
    tcp dport 80 reject
    tcp dport 443 reject
  }
}

[root@centos8 ~]#nft list table inet test_table
table inet test_table {
chain test_chain {
tcp dport mysql reject
tcp dport http reject
}
chain test_filter_input_chain {
<span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
}
}
</pre>
</div>
</div>
</li>
<li><a id="h:1e8e3afc-5579-44b4-8d12-9b552aa87383"></a>åˆ›å»ºåŸºæœ¬é“¾è§„åˆ™<br>
<div class="outline-text-6" id="text-h:1e8e3afc-5579-44b4-8d12-9b552aa87383">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft add rule inet test_table test_filter_input_chain tcp dport http reject
[root@centos8 ~]#nft add rule inet test_table test_filter_input_chain ip&#160;saddr 10.0.0.6 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28304;&#22320;&#22336; 10.0.0.6&#25298;&#32477;</span>

[root@centos8 ~]#nft list chain inet test_table test_filter_input_chain
table inet test_table {
  chain test_filter_input_chain {
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 80 reject
    ip saddr 10.0.0.6 reject
  }
}

[root@centos7 ~]#curl 10.0.0.8  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20851;&#32852;&#38057;&#23376;&#20989;&#25968;&#30340;&#35268;&#21017;&#25165;&#29983;&#25928;</span>
curl: (7) Failed connect to 10.0.0.8:80; Connection refused
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:8a13c384-417b-4e5e-b1be-350540dd5c24" class="outline-5">
<h5 id="h:8a13c384-417b-4e5e-b1be-350540dd5c24">æ’å…¥é“¾çš„æŒ‡å®šä½ç½®</h5>
<div class="outline-text-5" id="text-h:8a13c384-417b-4e5e-b1be-350540dd5c24">
<p>
å°†è§„åˆ™æ’å…¥åˆ°é“¾çš„æŒ‡å®šä½ç½®ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š
</p>
</div>
<ul class="org-ul">
<li><a id="h:228a781e-7ae5-4d8e-a48f-5c5d4b342cf5"></a>ä½¿ç”¨ index æ¥æŒ‡å®šè§„åˆ™çš„ç´¢å¼•<br>
<div class="outline-text-6" id="text-h:228a781e-7ae5-4d8e-a48f-5c5d4b342cf5">
<p>
index ç±»ä¼¼äº iptables çš„ <code>-I</code> é€‰é¡¹ï¼Œ index çš„å€¼æ˜¯ä» 0 å¼€å§‹çš„
</p>

<p>
indexå¿…é¡»æŒ‡å‘ä¸€ä¸ªå­˜åœ¨çš„è§„åˆ™ï¼Œæ¯”å¦‚ <code>nft insert rule â€¦ index 0</code> å°±æ˜¯é
æ³•çš„ã€‚
</p>

<p>
<code>add</code> è¡¨ç¤ºæ–°è§„åˆ™æ·»åŠ åœ¨ç´¢å¼•ä½ç½®çš„è§„åˆ™åé¢
</p>

<p>
<code>insert</code> è¡¨ç¤ºæ–°è§„åˆ™æ·»åŠ åœ¨ç´¢å¼•ä½ç½®çš„è§„åˆ™å‰é¢
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft insert rule inet test_table test_filter_input_chain index 0 tcp dport mysql reject
[root@centos8 ~]#nft list chain inet test_table test_filter_input_chain
table inet test_table {
  chain test_filter_input_chain {
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 3306 reject
    tcp dport 80 reject
    ip saddr 10.0.0.6 reject
  }
}

[root@centos8 ~]#nft insert rule inet test_table test_filter_input_chain index 1 udp dport 123 accept
[root@centos8 ~]#nft list chain inet test_table test_filter_input_chain
table inet test_table {
  chain test_filter_input_chain {
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 3306 reject
    udp dport 123 accept
    tcp dport 80 reject
    ip saddr 10.0.0.6 reject
  }
}
</pre>
</div>
</div>
</li>
<li><a id="h:cdcff77d-e0a7-4ece-a139-b30bf25fe3af"></a>ä½¿ç”¨ handle æ¥æŒ‡å®šè§„åˆ™çš„å¥æŸ„<br>
<div class="outline-text-6" id="text-h:cdcff77d-e0a7-4ece-a139-b30bf25fe3af">
<p>
åœ¨ nftablesä¸­ï¼Œå¥æŸ„å€¼æ˜¯å›ºå®šä¸å˜çš„ï¼Œé™¤éè§„åˆ™è¢«åˆ é™¤ï¼Œè¿™å°±ä¸ºè§„åˆ™æä¾›äº†ç¨³
å®šçš„ç´¢å¼•ã€‚è€Œindex çš„å€¼æ˜¯å¯å˜çš„ï¼Œåªè¦æœ‰æ–°è§„åˆ™æ’å…¥ï¼Œå°±æœ‰å¯èƒ½å‘ç”Ÿå˜åŒ–ã€‚ä¸€
èˆ¬å»ºè®®ä½¿ç”¨ handle æ¥æ’å…¥æ–°è§„åˆ™ã€‚
</p>

<p>
<code>add</code> è¡¨ç¤ºæ–°è§„åˆ™æ·»åŠ åœ¨ç´¢å¼•ä½ç½®çš„è§„åˆ™åé¢ï¼Œ insert
è¡¨ç¤ºæ–°è§„åˆ™æ·»åŠ åœ¨ç´¢å¼•ä½ç½®çš„è§„åˆ™å‰é¢ã€‚
</p>

<p>
<code>handle</code> çš„å€¼å¯ä»¥é€šè¿‡å‚æ•° <code>--handle</code> æˆ–è€… <code>-a</code> è·å–
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft -a list chain inet test_table test_filter_input_chain <span style="color: #b22222;"># </span><span style="color: #b22222;">-a &#33719;&#21462;handle&#20301;&#32622;</span>
table inet test_table {
  chain test_filter_input_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 1</span>
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 9</span>
    udp dport 123 accept <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 10</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 7</span>
    ip saddr 10.0.0.6 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 8</span>
  }
}

[root@centos8 ~]#nft add rule inet test_table test_filter_input_chain handle 7 tcp dport ftp reject <span style="color: #b22222;"># </span><span style="color: #b22222;">add 7&#21518;&#38754;&#21152;&#26032;&#35268;&#21017;</span>
[root@centos8 ~]#nft -a list chain inet test_table test_filter_input_chain
table inet test_table {
  chain test_filter_input_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 1</span>
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 9</span>
    udp dport 123 accept <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 10</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 7</span>
    tcp dport 21 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 11</span>
    ip saddr 10.0.0.6 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 8</span>
  }
}

[root@centos8 ~]#nft insert rule inet test_table test_filter_input_chain handle 8 udp dport 8080 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">insert &#31532;8&#20010;&#21069;&#38754;&#21152;</span>
[root@centos8 ~]#nft -a list chain inet test_table test_filter_input_chain
table inet test_table {
  chain test_filter_input_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 1</span>
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 9</span>
    udp dport 123 accept <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 10</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 7</span>
    tcp dport 21 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 11</span>
    udp dport 8080 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 12</span>
    ip saddr 10.0.0.6 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 8</span>
  }
}

[root@centos8 ~]#nft -a -nn list ruleset
... ...
table inet test_table { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 2</span>
  chain test_filter_input_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 1</span>
    <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 9</span>
    udp dport 123 accept <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 10</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 7</span>
    tcp dport 21 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 11</span>
    udp dport 8080 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 12</span>
    ip saddr 10.0.0.6 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 8</span>
  }

  chain test_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 2</span>
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 6</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 4</span>
    tcp dport 443 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 5</span>
  }
}
</pre>
</div>

<p>
å¯ä»¥åœ¨åˆ›å»ºè§„åˆ™æ—¶å°±è·å–åˆ°è§„åˆ™çš„å¥æŸ„å€¼ï¼Œåœ¨åˆ›å»ºè§„åˆ™æ—¶åŒæ—¶åŠ ä¸Šå‚æ•°
<code>--echo</code> æˆ–è€… <code>-e</code> å’Œ <code>--handle</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft -a -e add rule inet test_table test_filter_input_chain tcp dport 6379 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">-e &#25552;&#31034;&#21019;&#24314;&#26102;&#33719;&#21462;&#21040;&#35268;&#21017;&#30340;&#21477;&#26564;&#20540;</span>
add rule inet test_table test_filter_input_chain tcp dport 6379 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 13</span>

[root@centos8 ~]#nft -a list chain inet test_table test_filter_input_chain
table inet test_table {
  chain test_filter_input_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 1</span>
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 9</span>
    udp dport 123 accept <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 10</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 7</span>
    tcp dport 21 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 11</span>
    udp dport 8080 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 12</span>
    ip saddr 10.0.0.6 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 8</span>
    tcp dport 6379 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 13</span>
  }
}
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:99db9446-a0f5-4299-a812-1f1afa4ac59a" class="outline-5">
<h5 id="h:99db9446-a0f5-4299-a812-1f1afa4ac59a">åˆ é™¤è§„åˆ™</h5>
<div class="outline-text-5" id="text-h:99db9446-a0f5-4299-a812-1f1afa4ac59a">
</div>
<ul class="org-ul">
<li><a id="h:79874442-14ec-4725-ad9c-baafa0447d53"></a>åˆ é™¤å•ä¸ªè§„åˆ™<br>
<div class="outline-text-6" id="text-h:79874442-14ec-4725-ad9c-baafa0447d53">
<p>
åˆ é™¤æ–¹æ³•ï¼šæŒ‡å®šè§„åˆ™å†…å®¹æˆ–handleå·
</p>

<p>
å•ä¸ªè§„åˆ™åªèƒ½é€šè¿‡å…¶å¥æŸ„åˆ é™¤ï¼Œé¦–å…ˆéœ€è¦æ‰¾åˆ°æƒ³åˆ é™¤çš„è§„åˆ™å¥æŸ„
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft --handle list ruleset
table inet test_table { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 2</span>
  chain test_filter_input_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 1</span>
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 9</span>
    udp dport 123 accept <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 10</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 7</span>
    tcp dport 21 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 11</span>
    udp dport 8080 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 12</span>
    ip saddr 10.0.0.6 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 8</span>
    tcp dport 6379 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 13</span>
  }

  chain test_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 2</span>
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 6</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 4</span>
    tcp dport 443 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 5</span>
  }
}

$ nft --handle list ruleset
</pre>
</div>

<p>
ç„¶åä½¿ç”¨å¥æŸ„å€¼æ¥åˆ é™¤è¯¥è§„åˆ™ï¼š
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft delete rule inet test_table test_filter_input_chain handle 8 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;handle &#21495;&#21024;&#38500;</span>
[root@centos8 ~]#nft list chain inet test_table test_filter_input_chain
table inet test_table {
  chain test_filter_input_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 1</span>
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 9</span>
    udp dport 123 accept <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 10</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 7</span>
    tcp dport 21 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 11</span>
    udp dport 8080 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 12</span>
    tcp dport 6379 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 13</span>
  }
}
</pre>
</div>
</div>
</li>
<li><a id="h:a9898b27-2ced-40db-a483-ba19ed792548"></a>åˆ é™¤æ‰€æœ‰è§„åˆ™<br>
<div class="outline-text-6" id="text-h:a9898b27-2ced-40db-a483-ba19ed792548">
<p>
è¡¨ã€é“¾ã€è§„åˆ™å…¨æ¸…ç†äº†
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft flush ruleset
[root@centos8 ~]#nft list
Error: syntax error, unexpected newline
list
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:31e908ce-837d-46d3-81a6-14275abc4e79" class="outline-5">
<h5 id="h:31e908ce-837d-46d3-81a6-14275abc4e79">åˆ—å‡ºè§„åˆ™</h5>
<div class="outline-text-5" id="text-h:31e908ce-837d-46d3-81a6-14275abc4e79">
<p>
å¯ä»¥åˆ—å‡ºæ‰€æœ‰è§„åˆ™ï¼Œä¹Ÿå¯ä»¥åˆ—å‡ºè§„åˆ™çš„ä¸€éƒ¨åˆ†
</p>
</div>
<ul class="org-ul">
<li><a id="h:4782c4ae-3d47-4ccd-950c-5391a947820e"></a>åˆ—å‡ºæ‰€æœ‰è§„åˆ™<br>
<div class="outline-text-6" id="text-h:4782c4ae-3d47-4ccd-950c-5391a947820e">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft list ruleset
table inet filter {
    chain input {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
    }
    chain forward {
        <span style="color: #483d8b;">type</span> filter hook forward priority 0; policy accept;
    }
    chain output {
        <span style="color: #483d8b;">type</span> filter hook output priority 0; policy accept;
    }
}
table inet test_table {
    chain test_chain {
        tcp dport mysql reject
        tcp dport http reject
    }
    chain test_filter_input_chain {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
        tcp dport mysql reject
        tcp dport ftp reject
        udp dport http-alt reject
        tcp dport http reject
        tcp dport 6379 reject
    }
}
</pre>
</div>
</div>
</li>
<li><a id="h:80b57d89-1c8c-46c9-abad-7da542cca1d1"></a>åˆ—å‡ºæŒ‡å®šè¡¨ä¸­çš„æ‰€æœ‰è§„åˆ™<br>
<div class="outline-text-6" id="text-h:80b57d89-1c8c-46c9-abad-7da542cca1d1">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft list table inet test_table
table inet test_table {
    chain test_chain {
        tcp dport mysql reject
        tcp dport http reject
    }
    chain test_filter_input_chain {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
        tcp dport mysql reject
        tcp dport ftp reject
        udp dport http-alt reject
        tcp dport http reject
        tcp dport 6379 reject
    }
}
</pre>
</div>
</div>
</li>
<li><a id="h:928d0861-ad12-4c74-85ee-4128f7034e43"></a>åˆ—å‡ºæŒ‡å®šé“¾ä¸­çš„æ‰€æœ‰è§„åˆ™<br>
<div class="outline-text-6" id="text-h:928d0861-ad12-4c74-85ee-4128f7034e43">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft list chain inet test_table test_filter_input_chain
table inet test_table {
    chain test_filter_input_chain {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
        tcp dport mysql reject
        tcp dport ftp reject
        udp dport http-alt reject
        tcp dport http reject
        tcp dport 6379 reject
    }
}
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:ca7c831e-db03-4dc6-9a57-fdb2f1e3894c" class="outline-5">
<h5 id="h:ca7c831e-db03-4dc6-9a57-fdb2f1e3894c">å¤‡ä»½è¿˜åŸ</h5>
<div class="outline-text-5" id="text-h:ca7c831e-db03-4dc6-9a57-fdb2f1e3894c">
<p>
è§„åˆ™éƒ½æ˜¯ä¸´æ—¶çš„ï¼Œè¦æƒ³æ°¸ä¹…ç”Ÿæ•ˆï¼Œå¯ä»¥å°†è§„åˆ™å¤‡ä»½ï¼Œé‡å¯åè‡ªåŠ¨åŠ è½½æ¢å¤
</p>

<p>
æŸ¥çœ‹serviceæ–‡ä»¶
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /lib/systemd/system/nftables.service
[Unit]
<span style="color: #a0522d;">Description</span>=Netfilter Tables
<span style="color: #a0522d;">Documentation</span>=man:nft(8)
<span style="color: #a0522d;">Wants</span>=network-pre.target
<span style="color: #a0522d;">Before</span>=network-pre.target
[Service]
<span style="color: #a0522d;">Type</span>=oneshot
<span style="color: #a0522d;">ProtectSystem</span>=full
<span style="color: #a0522d;">ProtectHome</span>=true
<span style="color: #a0522d;">ExecStart</span>=/sbin/nft -f /etc/sysconfig/nftables.conf  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22791;&#20221;&#25991;&#20214;&#20301;&#32622;</span>
<span style="color: #a0522d;">ExecReload</span>=/sbin/nft <span style="color: #8b2252;">'flush ruleset; include "/etc/sysconfig/nftables.conf";'</span>
<span style="color: #a0522d;">ExecStop</span>=/sbin/nft flush ruleset
<span style="color: #a0522d;">RemainAfterExit</span>=yes
[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target
</pre>
</div>

<p>
<b>å¤‡ä»½é…ç½®å¹¶è¿˜åŸ</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#33267;&#25991;&#20214;&#20013;</span>
[root@centos8 ~]#nft list ruleset
table inet filter {
    chain input {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
    }
    chain forward {
        <span style="color: #483d8b;">type</span> filter hook forward priority 0; policy accept;
    }
    chain output {
        <span style="color: #483d8b;">type</span> filter hook output priority 0; policy accept;
    }
}
table inet test_table {
    chain test_chain {
        tcp dport mysql reject
        tcp dport http reject
    }
    chain test_filter_input_chain {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
        tcp dport mysql reject
        tcp dport ftp reject
        udp dport http-alt reject
        tcp dport http reject
        tcp dport 6379 reject
    }
}

[root@centos8 ~]#nft list ruleset &gt; /etc/sysconfig/nftables.conf <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35268;&#21017;&#20445;&#23384;&#21040;&#25991;&#20214;&#20013; &#25110;&#32773;&#25991;&#20214;&#20013;&#25351;&#23450;include&#21152;&#36733;&#35268;&#21017;&#33258;&#23450;&#20041;&#25991;&#20214;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#25152;&#26377;&#35268;&#21017;</span>
[root@centos8 ~]#nft flush ruleset
[root@centos8 ~]#nft list ruleset

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#26032;&#21551;&#21160;&#21518;&#20840;&#37096;&#36824;&#21407;</span>
[root@centos8 ~]#systemctl restart nftables.service
[root@centos8 ~]#nft list ruleset
table inet filter {
    chain input {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
    }
    chain forward {
        <span style="color: #483d8b;">type</span> filter hook forward priority 0; policy accept;
    }
    chain output {
        <span style="color: #483d8b;">type</span> filter hook output priority 0; policy accept;
    }
}
table inet test_table {
    chain test_chain {
        tcp dport mysql reject
        tcp dport http reject
    }
    chain test_filter_input_chain {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
        tcp dport mysql reject
        tcp dport ftp reject
        udp dport http-alt reject
        tcp dport http reject
        tcp dport 6379 reject
    }
}
</pre>
</div>

<p>
<b>å¯ç”¨æŒ‡å®šçš„é…ç½®æ–‡ä»¶</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat nftables2.conf
table inet test2_table {
    chain test2_filter_input_chain {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
        ip saddr { 10.0.0.1, 10.0.0.10 } accept
        tcp dport { http, nfs,ssh } reject
    }
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">-f &#25351;&#23450;&#35268;&#21017;&#37197;&#32622;&#25991;&#20214;&#65292;&#22914;&#26524;&#24050;&#32463;&#26377;&#35268;&#21017;&#65292;&#26159;&#36861;&#21152;&#33267;&#29616;&#26377;&#35268;&#21017;&#21518;</span>
[root@centos8 ~]#nft -f nftables2.conf
[root@centos8 ~]#nft list ruleset
table inet test2_table {
    chain test2_filter_input_chain {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
        ip saddr { 10.0.0.1, 10.0.0.10 } accept
        tcp dport { ssh, http, nfs } reject
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:18748435-b5fb-4c0f-a14b-3cee735a1d09" class="outline-5">
<h5 id="h:18748435-b5fb-4c0f-a14b-3cee735a1d09">è¿ç§»iptablesè§„åˆ™åˆ°nft</h5>
<div class="outline-text-5" id="text-h:18748435-b5fb-4c0f-a14b-3cee735a1d09">
<ol class="org-ol">
<li><p>
To save the existing rules to a file, run below command:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">iptables-save &gt; rules.iptables</span>
</pre>
</div></li>

<li>Move the step1 file to CentOS/RHEL 8 Server via scp or ftp. You can
use vi editor as well to copy the content from CentOS/RHEL 6 or 7
machine.</li>

<li><p>
Run the below command to generate the nft rules file on CentOS/RHEL 8
with iptables rules file.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">iptables-restore-translate -f rules.iptables &gt; rules.nft # &#36716;&#25442;</span>
</pre>
</div></li>

<li><p>
Load the rules in CentOS/RHEL 8 machine, make sure nftables service
is running on the system.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">nft -f rules.nft &#160;&#160;### load the rule via nft to nftables.</span>
</pre>
</div></li>

<li><p>
To Display rule in CentOS/RHEL 8 Server .
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">nft list ruleset</span>
</pre>
</div></li>
</ol>

<p>
You can see the rules have been migrated from CentOS/RHEL 6 or 7 to
CentOS/RHEL 8 server now and can test them as well
</p>

<p>
<b>åŠ¨åŠ¨æ‰‹</b>
</p>

<p>
è¯´æ˜ï¼šä»¥ä¸‹ç»ƒä¹ INPUTå’ŒOUTPUTé»˜è®¤ç­–ç•¥å‡ä¸ºDROP
</p>

<ol class="org-ol">
<li>é™åˆ¶æœ¬åœ°ä¸»æœºçš„webæœåŠ¡å™¨åœ¨å‘¨ä¸€ä¸å…è®¸è®¿é—®ï¼›æ–°è¯·æ±‚çš„é€Ÿç‡ä¸èƒ½è¶…è¿‡100ä¸ªæ¯ç§’ï¼›webæœåŠ¡å™¨åŒ…å«äº†adminå­—ç¬¦ä¸²çš„é¡µé¢ä¸å…è®¸è®¿é—®ï¼›webæœåŠ¡å™¨ä»…å…è®¸å“åº”æŠ¥æ–‡ç¦»å¼€æœ¬æœº</li>

<li>åœ¨å·¥ä½œæ—¶é—´ï¼Œå³å‘¨ä¸€åˆ°å‘¨äº”çš„8:30-18:00ï¼Œå¼€æ”¾æœ¬æœºçš„ftpæœåŠ¡ç»™172.16.0.0ç½‘ç»œä¸­çš„ä¸»æœºè®¿é—®ï¼›æ•°æ®ä¸‹è½½è¯·æ±‚çš„æ¬¡æ•°æ¯åˆ†é’Ÿä¸å¾—è¶…è¿‡5ä¸ª</li>

<li>å¼€æ”¾æœ¬æœºçš„sshæœåŠ¡ç»™172.16.x.1-172.16.x.100ä¸­çš„ä¸»æœºï¼Œxä¸ºä½ çš„å­¦å·ï¼Œæ–°è¯·æ±‚å»ºç«‹çš„é€Ÿç‡ä¸€åˆ†é’Ÿä¸å¾—è¶…è¿‡2ä¸ªï¼›ä»…å…è®¸å“åº”æŠ¥æ–‡é€šè¿‡å…¶æœåŠ¡ç«¯å£ç¦»å¼€æœ¬æœº</li>

<li>æ‹’ç»TCPæ ‡å¿—ä½å…¨éƒ¨ä¸º1åŠå…¨éƒ¨ä¸º0çš„æŠ¥æ–‡è®¿é—®æœ¬æœº</li>

<li>å…è®¸æœ¬æœºpingåˆ«çš„ä¸»æœºï¼›ä½†ä¸å¼€æ”¾åˆ«çš„ä¸»æœºpingæœ¬æœº</li>

<li><p>
åˆ¤æ–­ä¸‹è¿°è§„åˆ™çš„æ„ä¹‰
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -N clean_in
iptables -A clean_in -d 255.255.255.255 -p icmp -j DROP
iptables -A clean_in -d 172.16.255.255 -p icmp -j DROP
iptables -A clean_in -p tcp ! --syn -m state --state NEW -j DROP
iptables -A clean_in -p tcp --tcp-flags ALL ALL -j DROP
iptables -A clean_in -p tcp --tcp-flags ALL NONE -j DROP
iptables -A clean_in -d 172.16.100.7 -j RETURN
iptables -A INPUT -d 172.16.100.7 -j clean_in
iptables -A INPUT &#160;-i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT
iptables -A INPUT &#160;-i eth0 -m multiport -p tcp --dports 53,873,135,137,139,445 -j DROP
iptables -A INPUT &#160;-i eth0 -m multiport -p udp --dports 53,873,135,137,139,445 -j DROP
iptables -A INPUT &#160;-i eth0 -m multiport -p tcp --dports 1433,3389 -j DROP
iptables -A INPUT &#160;-p icmp -m limit --limit 10/second -j ACCEPT
</pre>
</div></li>

<li><p>
å®ç°ä¸»æœºé˜²ç«å¢™
</p>

<pre class="example" id="orgc32df9b">
æ”¾è¡Œtelnet, ftp, webæœåŠ¡
æ”¾è¡ŒsambaæœåŠ¡
æ”¾è¡ŒdnsæœåŠ¡(æŸ¥è¯¢å’ŒåŒºåŸŸä¼ é€)
</pre></li>

<li><p>
å®ç°ç½‘ç»œé˜²ç«å¢™
</p>

<pre class="example" id="orga59341b">
æ”¾è¡Œtelnet, ftp, webæœåŠ¡
æ”¾è¡ŒsambaæœåŠ¡
æ”¾è¡ŒdnsæœåŠ¡(æŸ¥è¯¢å’ŒåŒºåŸŸä¼ é€)
</pre></li>
</ol>
</div>
</div>
</div>
</div>
</section>
</main class="container">
<footer id="postamble" class="status">
<footer data-astro-cid-sz7xmlte data-turbo-permanent id=rootFooter>
    <script>
        const shuffle = e => e.map((e => ({
            v: e,
            sort: Math.random()
        }))).sort(( (e, o) => e.sort - o.sort)).map(( ({v: e}) => e));
        var songList = ["barbie-girl--stantough", "blue-da-ba-dee--cornelius-link", "hips-dont-lie--stantough", "i-want-it-that-way--stantough", "seven-nation-army--stantough", "smooth-criminal--stantough"]
          , songOrder = songOrder ?? shuffle(songList).map((e => `/audio/music/${e}.opus`))
          , song = new Audio(songOrder[0])
          , nextSong = new Audio(songOrder[1])
          , songIndex = 2
          , musicWrapper = void 0
          , arrow = void 0
          , notes = void 0;
        song.addEventListener("ended", next);
        const toggle = () => song.paused ? play() : pause();
        function play() {
            song.play(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.add("shakeManHorse"),
            notes.classList.remove("hideNotes")
        }
        function pause() {
            song.pause(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.remove("shakeManHorse"),
            notes.classList.add("hideNotes")
        }
        function next() {
            song = nextSong,
            play(),
            songIndex === songOrder.length && (songIndex = 0),
            nextSong = new Audio(songOrder[songIndex]),
            songIndex += 1
        }
        function skip() {
            pause(),
            (arrow = arrow || document.getElementById("musicArrow")).classList.add("shootArrow");
            new Audio("/audio/effects/ohno.m4a").play(),
            arrow.addEventListener("animationend", arrowShootHandler, !1)
        }
        function arrowShootHandler() {
            arrow.removeEventListener("animationend", arrowShootHandler, !1),
            arrow.classList.remove("shootArrow");
            new Audio("/audio/effects/heythathurt.m4a").play(),
            next()
        }
    </script>
    <div id=musicPlayer data-astro-cid-q7a5pyro>
        <button class=skip data-astro-cid-q7a5pyro onclick=skip() title="Skip song">
            <div id=skipWrapper data-astro-cid-q7a5pyro>
                <img alt="Medieval drollery of a man/snail/bat/monkey shooting an arrow" class=archer decoding=async height=334 loading=lazy src=/images/archer-no-arrow.448ccd8b_Z1KfRYq.webp width=226 data-astro-cid-q7a5pyro>
                <img alt="Arrow for archer" class="arrow complete" decoding=async height=23 loading=lazy src=/images/no-archer-full-arrow.87aa9971_Z2qL2KO.webp width=141 data-astro-cid-q7a5pyro id=musicArrow>
            </div>
        </button>
        <button class=playPause data-astro-cid-q7a5pyro onclick=toggle() title="Play/pause song">
            <div id=musicWrapper data-astro-cid-q7a5pyro>
                <div class=hideNotes id=notesWrapper data-astro-cid-q7a5pyro>
                    <div class=lyreNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                    <div class=fluteNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                </div>
                <img alt="Medieval drollery of a man/horse playing a lyre and a horn" class=manHorse decoding=async height=665 loading=lazy src=/images/man-horse-band.e3a2efcf_q8FCa.webp width=531 data-astro-cid-q7a5pyro>
            </div>
        </button>
    </div>
    <hr data-astro-cid-sz7xmlte>
    <div class=salutation data-astro-cid-gdmrbrho>
        <p data-astro-cid-gdmrbrho>
            <span class=flower2 data-astro-cid-gdmrbrho>A</span>
            <span class=smallcap data-astro-cid-gdmrbrho>pax vobiscum</span>
            <span class="flower2 wiggle" data-astro-cid-gdmrbrho id=leaf>a</span>
        </p>
    </div>
    <script>
        function animateLeafBlownHandler() {
            leaf.removeEventListener("animationend", animateLeafBlownHandler, !1),
            leaf.classList.remove("blownAway"),
            leaf.classList.add("wiggle")
        }
        function animateLeaf() {
            leaf = leaf ?? document.getElementById("leaf"),
            leaf.classList.remove("wiggle"),
            leaf.classList.add("blownAway"),
            leaf.addEventListener("animationend", animateLeafBlownHandler, !1)
        }
        document.getElementById("leaf").onclick = animateLeaf
    </script>


    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>æ‰“èµ</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Â© 2024 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
</footer>
</footer>
</body>
</html>
