<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: Linux 防火墙</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/font.css"/>
<link rel="stylesheet" type="text/css" href="/static/drollery.e825b870.css"/>
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
</head>
<body>
<header id="preamble" class="status">
<header class="{className}" data-astro-cid-3ef6ksr2>
  <div class=header-branding data-astro-cid-g2lrb5xm>
      <span class=header-text data-astro-cid-g2lrb5xm>
          <span class=dropcap data-astro-cid-g2lrb5xm aria-hidden=true>
              <span class=actual data-astro-cid-g2lrb5xm>J</span>
              <span class=rest data-astro-cid-g2lrb5xm>asper Hsu</span>
              <span class=period data-astro-cid-g2lrb5xm>.</span>
          </span>
          <span class=sr-only data-astro-cid-g2lrb5xm>Drollery</span>
      </span>
      <img alt="Medieval drollery of a knight on a horse" class=spring decoding=async height=250 loading=lazy src=/images/knight-horse.a96eee7d_Z1WCOYs.webp width=68 data-astro-cid-g2lrb5xm>
  </div>

  <nav data-astro-cid-pux6a34n>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/jcodelog.html class=nobracket data-astro-cid-pux6a34n>技术</a>
      <span class=flower2 data-astro-cid-pux6a34n>K</span>
      <a href=/reading/index.html class=nobracket data-astro-cid-pux6a34n>阅读</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
      <a href=/lisp/jasper-emacs.html class=nobracket data-astro-cid-pux6a34n>我的Emacs配置</a>
      <span class=flower2 data-astro-cid-pux6a34n>L</span>
      <a href=/link/index.html class=nobracket data-astro-cid-pux6a34n>友链</a>
      <span class=flower2 data-astro-cid-pux6a34n>M</span>
      <a href=/about.html class=nobracket data-astro-cid-pux6a34n>关于</a>
      <span class=flower2 data-astro-cid-pux6a34n>J</span>
  </nav>


  <div class="container" data-astro-cid-3ef6ksr2>
    <p class="info" data-astro-cid-3ef6ksr2>
              🏆 欢迎来到本站：
              <a href="https://xuchangwei.com/">https://xuchangwei.com/</a>。
              <strong>希望这里有你感兴趣的内容</strong>。
            </p>
  </div>
  <div id=borderArtWrapper class="tt1" data-astro-cid-5hce7sga data-turbo-permanent>
      <script>
          var man, shakeCount = 0, noSound = new Audio("/audio/effects/no.m4a"), screamSound = new Audio("/audio/effects/scream.m4a");
          function animateManShakeHandler() {
              man.removeEventListener("animationend", animateManShakeHandler, !1),
              shakeCount += 1,
              man.classList.remove("shakeMan")
          }
          function animateManFallHandler() {
              man.removeEventListener("animationend", animateManFallHandler, !1),
              man.classList.add("hide")
          }
          function animateMan() {
              man = man ?? document.getElementById("borderMan"),
              3 === shakeCount ? (man.classList.add("fallMan"),
              screamSound.play(),
              man.addEventListener("animationend", animateManFallHandler, !1)) : (man.classList.add("shakeMan"),
              noSound.play(),
              man.addEventListener("animationend", animateManShakeHandler, !1))
          }
      </script>
      <div class=borderArt data-astro-cid-5dda5nwp id=articleBorder>
          <img alt="flowery border with man falling" decoding=async height=620 loading=lazy src=/images/border-vines-no-man.b7d246cc_DRxSe.webp width=909 class=border data-astro-cid-5dda5nwp>
          <div class=fallWrapper data-astro-cid-5dda5nwp>
              <img alt="flowery border with man falling" decoding=async height=292 loading=lazy src=/images/man-no-vines.247a3187_Z2ioXNM.webp width=98 class=man data-astro-cid-5dda5nwp id=borderMan onclick=animateMan()>
          </div>
      </div>
  </div>
</header>
</header>
<main class="container" id="content" class="content">
<header>
<h1 class="title">Linux: Linux 防火墙</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:26e77df7-0c56-4c18-93d6-7db1dc4b7882">Linux 防火墙</a>
<ul>
<li><a href="#h:00efe72f-ad70-4dbc-8ce7-645a9bc3f95b">安全技术和防火墙</a>
<ul>
<li><a href="#h:0c3cecdb-2d5b-4582-acc7-a1c599f50107">安全技术</a></li>
<li><a href="#h:6e5c7b40-1aa0-4136-a950-c7bb56381c43">防火墙的分类</a></li>
<li><a href="#h:622ccea7-c4d7-4f76-b302-85ac37a20b78">网络架构</a></li>
</ul>
</li>
<li><a href="#h:97ff6f63-4903-43ea-bd03-de4aba5d6f22">Linux 防火墙的基本认识</a>
<ul>
<li><a href="#h:d68a350b-e855-4f3b-ae18-8b22f9e4b144">Netfilter</a></li>
<li><a href="#h:e98d80b3-e2ed-4e4f-bc43-33ff1477f870">防火墙工具介绍</a>
<ul>
<li><a href="#h:0624146d-38ef-484b-9310-46c8643c1914">iptables</a></li>
<li><a href="#h:01ace37b-9a1f-4884-8c7a-78a3781639f5">firewalld</a></li>
<li><a href="#h:44ff9cd2-8bf6-414a-9119-0762c76daf04">nftables</a></li>
</ul>
</li>
<li><a href="#h:ed0d5e05-318c-49d0-99d0-539dcc86a7aa">netfilter 中五个勾子函数和报文流向</a></li>
<li><a href="#h:9a27d671-a4bb-4725-b069-a5665c0ddb11">iptables的组成</a></li>
<li><a href="#h:ba854ffd-e62b-43ea-aa16-d2776d97efde">netfilter 完整流程</a></li>
</ul>
</li>
<li><a href="#h:5cf074a6-01a4-4476-a874-15bfa8cae985">iptables</a>
<ul>
<li><a href="#h:4f5426ea-3c52-4b14-bade-f023d76d49e0">iptables 规则说明</a>
<ul>
<li><a href="#h:22cceb12-4d75-4134-839a-015593974804">iptables 规则组成</a></li>
<li><a href="#h:3b46b0e6-41f9-40fa-b852-9eb1f90be40e">iptables规则添加时考量点</a></li>
<li><a href="#h:666370a4-ba29-4025-8578-aa3b9199fdaf">环境准备(禁用默认防火墙规则)</a></li>
</ul>
</li>
<li><a href="#h:9db34b34-110e-46f7-9b2c-c2e6f8c0360c">iptables 用法说明</a></li>
<li><a href="#h:5c6336b9-30df-4c45-b1be-d8b90d83105e">iptables 基本匹配条件</a></li>
<li><a href="#h:499ad751-f61e-4bfa-a724-8a332d6949f6">iptables 扩展匹配条件</a>
<ul>
<li><a href="#h:2645cee0-4765-4cdb-94aa-56a69f3b4642">隐式扩展</a></li>
<li><a href="#h:db740704-f14e-4018-943e-7b0820ca918b">显式扩展及相关模块</a></li>
</ul>
</li>
<li><a href="#h:492bc41f-380a-477e-b662-1d16bc1bbf7e">Target</a></li>
<li><a href="#h:10f4bdee-c93a-48a2-83bd-26a34d37753e">规则优化最佳实践</a></li>
<li><a href="#h:26466bfc-e2d9-4a5b-a7d0-834436c081c9">iptables规则保存</a></li>
<li><a href="#h:52fe8afa-e499-42b4-becc-7e55b77a174b">网络防火墙</a>
<ul>
<li><a href="#h:8b5c1a05-da52-41c1-94bc-a4ed9778fb98">FORWARD 链实现内外网络的流量控制</a></li>
<li><a href="#h:c1c8996c-9870-46a8-be4b-3a87a518b585">NAT 表</a></li>
<li><a href="#h:68e0209f-eb6d-4edc-ab92-0ac30fcff4de">SNAT</a></li>
<li><a href="#h:abb5c3ff-76b3-44e2-b789-5d14fc7a5ee9">DNAT</a></li>
<li><a href="#h:72073f97-3e2d-43c8-a08c-01d8ffdb2804">REDIRECT 转发(端口转发)</a></li>
</ul>
</li>
<li><a href="#h:732ceb41-99c3-4ce8-aa77-5056b0108851">实战案例：</a></li>
<li><a href="#h:e294b82d-64ce-41cf-9334-9ec02af8bab9">iptables实现七层访问过滤</a></li>
</ul>
</li>
<li><a href="#h:ed0b7ea4-d0af-463c-a5c6-0e23dfb136fc">firewalld服务</a>
<ul>
<li><a href="#h:39899c40-ec8b-42fd-933d-3c02d0956a6e">firewalld 介绍</a></li>
<li><a href="#h:fef90433-dfbb-44ec-982e-3e3332aeebae">firewall-cmd 命令</a></li>
<li><a href="#h:806ec87a-80e8-4ccf-8127-d250c7f75195">其它规则</a>
<ul>
<li><a href="#h:78295a50-4b55-4296-b2f0-7acb14ba7f2b">管理rich规则</a></li>
<li><a href="#h:c4dc736f-12ae-42ab-a428-09684a2a2216">rich规则实现</a></li>
<li><a href="#h:c704eaa6-81e0-495d-9d46-336dd68d08b2">伪装和端口转发</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:0a0b62a6-a444-4118-aaec-7df4fd02a865">nft</a>
<ul>
<li><a href="#h:a1a99e5f-96c5-4107-83a3-aba163a9360a">nft 介绍</a></li>
<li><a href="#h:b0f07a19-43b1-4f37-9b87-1b8d11589c6c">nft 相关概念</a></li>
<li><a href="#h:6264a49f-7034-4735-84ef-53c280186229">nft 常见用法</a>
<ul>
<li><a href="#h:d8e57b03-a530-444a-ac56-44c785493f97">nft 命令格式</a></li>
<li><a href="#h:51a4e412-7377-4184-a4e6-874b2ddf6433">查看</a></li>
<li><a href="#h:dd1fd1c3-d648-4d0b-b745-b7485d0e1f49">增加</a></li>
<li><a href="#h:83e2bb90-cca5-4185-b2e4-7cbd1c951381">删</a></li>
<li><a href="#h:334df536-c47f-4048-abc0-702f5433e147">改</a></li>
</ul>
</li>
<li><a href="#h:e25d4407-518a-4c42-a383-b6ce70adb185">nft 实战案例</a>
<ul>
<li><a href="#h:c801d4c7-7697-4d86-8328-18b5e368bf8b">创建表和删除表</a></li>
<li><a href="#h:2af0f5cc-c874-4f48-a66f-00c90097506a">创建链</a></li>
<li><a href="#h:86b0ee29-5a01-43c5-a5a2-36c63b8534e1">创建规则</a></li>
<li><a href="#h:8a13c384-417b-4e5e-b1be-350540dd5c24">插入链的指定位置</a></li>
<li><a href="#h:99db9446-a0f5-4299-a812-1f1afa4ac59a">删除规则</a></li>
<li><a href="#h:31e908ce-837d-46d3-81a6-14275abc4e79">列出规则</a></li>
<li><a href="#h:ca7c831e-db03-4dc6-9a57-fdb2f1e3894c">备份还原</a></li>
<li><a href="#h:18748435-b5fb-4c0f-a14b-3cee735a1d09">迁移iptables规则到nft</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../../index.html">Linux</a></li>
</ul>
<section id="outline-container-h:26e77df7-0c56-4c18-93d6-7db1dc4b7882" class="outline-2">
<h2 id="h:26e77df7-0c56-4c18-93d6-7db1dc4b7882">Linux 防火墙</h2>
<div class="outline-text-2" id="text-h:26e77df7-0c56-4c18-93d6-7db1dc4b7882">
<p>
本章内容
</p>

<ul class="org-ul">
<li>防火墙的概念</li>
<li>iptables的基本认识</li>
<li>iptables的组成</li>
<li>iptables的基本语法</li>
<li>iptables之forward的概念</li>
<li>iptables之地址转换法则</li>
<li>SNAT源地址转换的具体实现</li>
<li>DNAT目标地址转换的具体实现</li>
<li>firewalld介绍</li>
<li>firewalld配置</li>
<li>命令rich规则</li>
<li>nft 基本用法</li>
</ul>
</div>
<div id="outline-container-h:00efe72f-ad70-4dbc-8ce7-645a9bc3f95b" class="outline-3">
<h3 id="h:00efe72f-ad70-4dbc-8ce7-645a9bc3f95b">安全技术和防火墙</h3>
<div class="outline-text-3" id="text-h:00efe72f-ad70-4dbc-8ce7-645a9bc3f95b">
</div>
<div id="outline-container-h:0c3cecdb-2d5b-4582-acc7-a1c599f50107" class="outline-4">
<h4 id="h:0c3cecdb-2d5b-4582-acc7-a1c599f50107">安全技术</h4>
<div class="outline-text-4" id="text-h:0c3cecdb-2d5b-4582-acc7-a1c599f50107">
<ul class="org-ul">
<li>入侵检测系统（Intrusion Detection Systems）：特点是不阻断任何网络访
问，量化、定位来自内外网络的威胁情况，主要以提供报告和事后监督为主，
提供有针对性的指导措施和安全决策依据。一般采用旁路部署方式</li>

<li>入侵防御系统（Intrusion Prevention System）：以透明模式工作，分析数
据包的内容如：溢出攻击、拒绝服务攻击、木马、蠕虫、系统漏洞等进行准确
的分析判断，在判定为攻击行为后立即予以阻断，主动而有效的保护网络的安
全，一般采用在线部署方式</li>

<li>防火墙（ FireWall）：隔离功能，工作在网络或主机边缘，对进出网络或主
机的数据包基于一定的规则检查，并在匹配某规则时由规则定义的行为进行处
理的一组功能的组件，基本上的实现都是默认情况下关闭所有的通过型访问，
只开放允许访问的策略</li>
</ul>

<blockquote>
<p>
防水墙
</p>

<p>
广泛意义上的防水墙：防水墙（Waterwall），与防火墙相对，是一种防止内部信息泄漏的安全产品。网络、外设接口、存储介质和打印机构成信息泄漏的全部途径。防水墙针对这四种泄密途径，在事前、事中、事后进行全面防护。其与防病毒产品、外部安全产品一起构成完整的网络安全体系。
</p>
</blockquote>


<figure id="orgb41197f">
<img src="images/image-20210216193744488.png" alt="image-20210216193744488.png">

</figure>
</div>
</div>
<div id="outline-container-h:6e5c7b40-1aa0-4136-a950-c7bb56381c43" class="outline-4">
<h4 id="h:6e5c7b40-1aa0-4136-a950-c7bb56381c43">防火墙的分类</h4>
<div class="outline-text-4" id="text-h:6e5c7b40-1aa0-4136-a950-c7bb56381c43">

<figure id="orgeea0508">
<img src="images/image-20210216193805258.png" alt="image-20210216193805258.png">

</figure>

<p>
按保护范围划分：
</p>

<ul class="org-ul">
<li>主机防火墙：服务范围为当前一台主机</li>
<li>网络防火墙：服务范围为防火墙一侧的局域网</li>
</ul>

<p>
按实现方式划分:
</p>

<ul class="org-ul">
<li>硬件防火墙：在专用硬件级别实现部分功能的防火墙；另一个部分功能基于软
件实现，如：华为，360，天融信,启明星辰，绿盟，深信服, Checkpoint，
NetScreen(Juniper2004年40亿美元收购)等</li>
<li>软件防火墙：运行于通用硬件平台之上的防火墙的应用软件，Windows防火
墙,ISA &#x2013;&gt; Forefront TMG</li>
</ul>

<p>
按网络协议划分：
</p>

<ul class="org-ul">
<li>网络层防火墙：OSI模型下四层，又称为包过滤防火墙</li>
<li>应用层防火墙/代理服务器：代理网关，OSI模型七层</li>
</ul>

<p>
<b>包过滤防火墙</b>
</p>


<figure id="orgab10796">
<img src="images/image-20210217100440033.png" alt="image-20210217100440033.png">

</figure>

<p>
网络层对数据包进行选择，选择的依据是系统内设置的过滤逻辑，被称为访问控
制列表（ACL），通过检查数据流中每个数据的源地址，目的地址，所用端口号
和协议状态等因素，或他们的组合来确定是否允许该数据包通过
</p>

<p>
优点：对用户来说透明，处理速度快且易于维护
</p>

<p>
缺点：无法检查应用层数据，如病毒等
</p>

<p>
<b>应用层防火墙</b>
</p>


<figure id="org6657186">
<img src="images/image-20210217100508051.png" alt="image-20210217100508051.png">

</figure>

<p>
应用层防火墙/代理服务型防火墙，也称为代理服务器（Proxy Server)
</p>

<p>
1将所有跨越防火墙的网络通信链路分为两段
</p>

<p>
内外网用户的访问都是通过代理服务器上的“链接”来实现
</p>

<p>
优点：在应用层对数据进行检查，比较安全 缺点：增加防火墙的负载
</p>

<p>
提示：现实生产环境中所使用的防火墙一般都是二者结合体，即先检查网络数据，
通过之后再送到应用层去检查
</p>
</div>
</div>
<div id="outline-container-h:622ccea7-c4d7-4f76-b302-85ac37a20b78" class="outline-4">
<h4 id="h:622ccea7-c4d7-4f76-b302-85ac37a20b78">网络架构</h4>
<div class="outline-text-4" id="text-h:622ccea7-c4d7-4f76-b302-85ac37a20b78">

<figure id="org188d5e4">
<img src="images/image-20210217100534446.png" alt="image-20210217100534446.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:97ff6f63-4903-43ea-bd03-de4aba5d6f22" class="outline-3">
<h3 id="h:97ff6f63-4903-43ea-bd03-de4aba5d6f22">Linux 防火墙的基本认识</h3>
<div class="outline-text-3" id="text-h:97ff6f63-4903-43ea-bd03-de4aba5d6f22">
</div>
<div id="outline-container-h:d68a350b-e855-4f3b-ae18-8b22f9e4b144" class="outline-4">
<h4 id="h:d68a350b-e855-4f3b-ae18-8b22f9e4b144">Netfilter</h4>
<div class="outline-text-4" id="text-h:d68a350b-e855-4f3b-ae18-8b22f9e4b144">

<figure id="orgc6803fb">
<img src="images/image-20210217100548751.png" alt="image-20210217100548751.png">

<figcaption><span class="figure-number">Figure 1: </span>image-20210217100548751</figcaption>
</figure>

<p>
Linux防火墙是由Netfilter组件提供的，Netfilter工作在内核空间，集成在
linux内核中
</p>

<p>
Netfilter 是Linux 2.4.x之后新一代的Linux防火墙机制，是linux内核的一个
子系统。Netfilter采用模块化设计，具有良好的可扩充性，提供扩展各种网络
服务的结构化底层框架。Netfilter与IP协议栈是无缝契合，并允许对数据报进
行过滤、地址转换、处理等操作
</p>

<p>
Netfilter官网文档：<a href="https://netfilter.org/documentation/">https://netfilter.org/documentation/</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#grep -m 10 NETFILTER /boot/config-4.18.0-193.el8.x86_64
<span style="color: #a0522d;">CONFIG_NETFILTER</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_ADVANCED</span>=y
<span style="color: #a0522d;">CONFIG_BRIDGE_NETFILTER</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_INGRESS</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_FAMILY_BRIDGE</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_FAMILY_ARP</span>=y
<span style="color: #b22222;"># </span><span style="color: #b22222;">CONFIG_NETFILTER_NETLINK_ACCT is not set</span>
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_QUEUE</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_LOG</span>=m
[root@centos7 ~]#grep -m 10 NETFILTER /boot/config-3.10.0-1127.el7.x86_64
<span style="color: #a0522d;">CONFIG_NETFILTER</span>=y
<span style="color: #b22222;"># </span><span style="color: #b22222;">CONFIG_NETFILTER_DEBUG is not set</span>
<span style="color: #a0522d;">CONFIG_NETFILTER_ADVANCED</span>=y
<span style="color: #a0522d;">CONFIG_BRIDGE_NETFILTER</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_ACCT</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_QUEUE</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_LOG</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_QUEUE_CT</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_SYNPROXY</span>=m
[root@centos6 ~]#grep -m 10 NETFILTER /boot/config-2.6.32-754.el6.x86_64
<span style="color: #a0522d;">CONFIG_NETFILTER</span>=y
<span style="color: #b22222;"># </span><span style="color: #b22222;">CONFIG_NETFILTER_DEBUG is not set</span>
<span style="color: #a0522d;">CONFIG_NETFILTER_ADVANCED</span>=y
<span style="color: #a0522d;">CONFIG_BRIDGE_NETFILTER</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_QUEUE</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_LOG</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_TPROXY</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_XTABLES</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_XT_TARGET_AUDIT</span>=m
[root@ubuntu2004 ~]#grep -m 10 NETFILTER /boot/config-5.4.0-33-generic
<span style="color: #a0522d;">CONFIG_NETFILTER</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_ADVANCED</span>=y
<span style="color: #a0522d;">CONFIG_BRIDGE_NETFILTER</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_INGRESS</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_FAMILY_BRIDGE</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_FAMILY_ARP</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_ACCT</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_QUEUE</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_LOG</span>=m
[root@ubuntu1804 ~]#grep -m 10 NETFILTER /boot/config-4.15.0-29-generic
<span style="color: #a0522d;">CONFIG_NETFILTER</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_ADVANCED</span>=y
<span style="color: #a0522d;">CONFIG_BRIDGE_NETFILTER</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_INGRESS</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_ACCT</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_QUEUE</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_LOG</span>=m
<span style="color: #a0522d;">CONFIG_NETFILTER_NETLINK_GLUE_CT</span>=y
<span style="color: #a0522d;">CONFIG_NETFILTER_SYNPROXY</span>=m
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e98d80b3-e2ed-4e4f-bc43-33ff1477f870" class="outline-4">
<h4 id="h:e98d80b3-e2ed-4e4f-bc43-33ff1477f870">防火墙工具介绍</h4>
<div class="outline-text-4" id="text-h:e98d80b3-e2ed-4e4f-bc43-33ff1477f870">
</div>
<div id="outline-container-h:0624146d-38ef-484b-9310-46c8643c1914" class="outline-5">
<h5 id="h:0624146d-38ef-484b-9310-46c8643c1914">iptables</h5>
<div class="outline-text-5" id="text-h:0624146d-38ef-484b-9310-46c8643c1914">
<p>
由软件包iptables提供的命令行工具，工作在用户空间，用来编写规则，写好的
规则被送往netfilter，告诉内核如何去处理信息包
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -qi iptables
[root@centos8 ~]# iptables --version
iptables v1.8.2 (nf_tables)
[root@centos8 ~]#ll /usr/sbin/iptables
lrwxrwxrwx. 1 root root 17 May 11 &#160;2019 /usr/sbin/iptables -&gt; xtables-nft-multi

[root@centos7 ~]#ll /usr/sbin/iptables
lrwxrwxrwx. 1 root root 13 Dec &#160;9 &#160;2018 /usr/sbin/iptables -&gt; xtables-multi
[root@centos7 ~]# iptables --version
iptables v1.4.21

[root@centos6 ~]#iptables --version
iptables v1.4.7
[root@centos6 ~]#ll /sbin/iptables
lrwxrwxrwx. 1 root root 33 Dec 12 &#160;2018 /sbin/iptables -&gt;/etc/alternatives/iptables.x86_64
[root@centos6 ~]#ll /etc/alternatives/iptables.x86_64
lrwxrwxrwx. 1 root root 20 Dec 12 &#160;2018 /etc/alternatives/iptables.x86_64 -&gt;/sbin/iptables-1.4.7
[root@centos6 ~]#ll /sbin/iptables
lrwxrwxrwx. 1 root root 33 Dec 12 &#160;2018 /sbin/iptables -&gt;
/etc/alternatives/iptables.x86_64
</pre>
</div>

<p>
范例：安装iptables的service包
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dnf -y install iptables-services
[root@centos8 ~]#rpm -ql iptables-services
/etc/sysconfig/ip6tables
/etc/sysconfig/iptables
/usr/lib/systemd/system/ip6tables.service
/usr/lib/systemd/system/iptables.service
/usr/libexec/initscripts/legacy-actions/ip6tables
/usr/libexec/initscripts/legacy-actions/ip6tables/panic
/usr/libexec/initscripts/legacy-actions/ip6tables/save
/usr/libexec/initscripts/legacy-actions/iptables
/usr/libexec/initscripts/legacy-actions/iptables/panic
/usr/libexec/initscripts/legacy-actions/iptables/save
/usr/libexec/iptables
/usr/libexec/iptables/ip6tables.init
/usr/libexec/iptables/iptables.init
</pre>
</div>
</div>
</div>
<div id="outline-container-h:01ace37b-9a1f-4884-8c7a-78a3781639f5" class="outline-5">
<h5 id="h:01ace37b-9a1f-4884-8c7a-78a3781639f5">firewalld</h5>
<div class="outline-text-5" id="text-h:01ace37b-9a1f-4884-8c7a-78a3781639f5">
<p>
从CentOS 7 版开始引入了新的前端管理工具 软件包：
</p>

<ul class="org-ul">
<li>firewalld</li>
<li>firewalld-config(图形化)</li>
</ul>

<p>
管理工具：
</p>

<ul class="org-ul">
<li>firewall-cmd 命令行工具</li>
<li>firewall-config 图形工作</li>
</ul>
</div>
</div>
<div id="outline-container-h:44ff9cd2-8bf6-414a-9119-0762c76daf04" class="outline-5">
<h5 id="h:44ff9cd2-8bf6-414a-9119-0762c76daf04">nftables</h5>
<div class="outline-text-5" id="text-h:44ff9cd2-8bf6-414a-9119-0762c76daf04">
<p>
此软件是CentOS 8 新特性,Nftables最初在法国巴黎的Netfilter Workshop
2008上发表，然后由长期的netfilter核心团队成员和项目负责人Patrick
McHardy于2009年3月发布。它在2013年末合并到Linux内核中，自2014年以来已
在内核3.13中可用。
</p>

<p>
它重用了netfilter框架的许多部分，例如连接跟踪和NAT功能。它还保留了命名
法和基本iptables设计的几个部分，例如表，链和规则。就像iptables一样，表
充当链的容器，并且链包含单独的规则，这些规则可以执行操作，例如丢弃数据
包，移至下一个规则或跳至新链。
</p>

<p>
从用户的角度来看，nftables添加了一个名为nft的新工具，该工具替代了
iptables，arptables和ebtables中的所有其他工具。从体系结构的角度来看，
它还替换了内核中处理数据包过滤规则集运行时评估的那些部分。
</p>

<p>
范例：查看软件包
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -qi nftables
Name &#160;&#160;&#160;: nftables
Epoch &#160;&#160;&#160;: 1
Version &#160;&#160;: 0.9.0
Release &#160;&#160;: 8.el8
Architecture: x86_64
Install Date: Wed 25 Sep 2019 09:29:06 PM CST
Group &#160;&#160;&#160;: Unspecified
Size &#160;&#160;&#160;: 758622
License &#160;&#160;: GPLv2
Signature &#160;: RSA/SHA256, Tue 02 Jul 2019 08:19:09 AM CST, Key ID
05b555b38483c65d
Source RPM : nftables-0.9.0-8.el8.src.rpm
Build Date : Sat 11 May 2019 11:06:46 PM CST
Build Host : x86-01.mbox.centos.org
Relocations : (not relocatable)
Packager &#160;: CentOS Buildsys <a href="mailto:bugs%40centos.org">&lt;bugs@centos.org&gt;</a>
Vendor &#160;&#160;: CentOS
URL &#160;&#160;&#160;&#160;: http://netfilter.org/projects/nftables/
Summary &#160;&#160;: Netfilter Tables userspace utillites
Description :
Netfilter Tables userspace utilities.
</pre>
</div>

<p>
范例：CentOS 8 支持三种防火墙服务
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#systemctl status iptables.service
[root@centos8 ~]#systemctl status firewalld.service
[root@centos8 ~]#systemctl status nftables.service
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ed0d5e05-318c-49d0-99d0-539dcc86a7aa" class="outline-4">
<h4 id="h:ed0d5e05-318c-49d0-99d0-539dcc86a7aa">netfilter 中五个勾子函数和报文流向</h4>
<div class="outline-text-4" id="text-h:ed0d5e05-318c-49d0-99d0-539dcc86a7aa">
<p>
Netfilter在内核中选取五个位置放了五个hook(勾子) function(INPUT、OUTPUT、
FORWARD、PREROUTING、POSTROUTING)，而这五个hook function向用户开放，用
户可以通过一个命令工具（iptables）向其写入规则
</p>

<p>
由信息过滤表（table）组成，包含控制IP包处理的规则集（rules），规则被分
组放在链（chain）上
</p>


<figure id="orgf86c7b6">
<img src="images/image-20210217100644679.png" alt="image-20210217100644679.png">

</figure>

<p>
提示：从 Linux kernel 4.2 版以后，Netfilter 在prerouting 前加了一个
ingress勾子函数。可以使用这个新的入口挂钩来过滤来自第2层的流量，这个新
挂钩比预路由要早，基本上是tc 命令（流量控制工具）的替代品
</p>

<p>
<b>三种报文流向</b>
</p>

<ul class="org-ul">
<li>流入本机：PREROUTING &#x2013;&gt; INPUT&#x2013;&gt;用户空间进程</li>
<li>流出本机：用户空间进程 &#x2013;&gt;OUTPUT&#x2013;&gt; POSTROUTING</li>
<li>转发：PREROUTING &#x2013;&gt; FORWARD &#x2013;&gt; POSTROUTING</li>
</ul>
</div>
</div>
<div id="outline-container-h:9a27d671-a4bb-4725-b069-a5665c0ddb11" class="outline-4">
<h4 id="h:9a27d671-a4bb-4725-b069-a5665c0ddb11">iptables的组成</h4>
<div class="outline-text-4" id="text-h:9a27d671-a4bb-4725-b069-a5665c0ddb11">
<p>
iptables由五个表table和五个链chain以及一些规则组成
</p>


<figure id="org6cbf77e">
<img src="images/image-20210217100707156.png" alt="image-20210217100707156.png">

</figure>

<p>
<b>链 chain：</b>
</p>

<ul class="org-ul">
<li>内置链：每个内置链对应于一个钩子函数</li>
<li>自定义链：用于对内置链进行扩展或补充，可实现更灵活的规则组织管理机制；只有Hook钩子调用自定义链时，才生效</li>
</ul>

<p>
<b>五个内置链chain:</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">INPUT,OUTPUT,FORWARD,PREROUTING,POSTROUTING
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#19981;&#21516;&#36890;&#20449;&#20301;&#32622;&#21152;&#20197;&#21306;&#21035;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">input&#25509;&#25910;&#12289;output&#26412;&#26426;&#21457;&#36865;&#12289;forward&#26412;&#26426;&#36716;&#21457;&#12289;prerouting&#36335;&#30001;&#20043;&#21069;&#12289;postrouting&#36335;&#30001;&#21457;&#29983;&#20043;&#21518;</span>
</pre>
</div>

<p>
<b>五个表table：</b> filter、nat、mangle、raw、security
</p>

<ul class="org-ul">
<li>filter表：过滤规则表，根据预定义的规则过滤符合条件的数据包,默认表</li>
<li>nat表：network address translation 地址转换规则表</li>
<li>mangle：修改数据标记位规则表</li>
<li>raw：关闭启用的连接跟踪机制，加快封包穿越防火墙速度</li>
<li>security：用于强制访问控制（MAC）网络规则，由Linux安全模块（如SELinux）实现</li>
</ul>

<p>
<b>优先级由高到低的顺序为：</b>
</p>

<pre class="example" id="org2417155">
security --&gt;raw--&gt;mangle--&gt;nat--&gt;filter
</pre>

<p>
<b>表和链对应关系</b>
</p>


<figure id="org4f46a1a">
<img src="images/image-20210217100732778.png" alt="image-20210217100732778.png">

</figure>

<pre class="example" id="orgbd0478e">
raw   ：PREROUTING， OUTPUT
mangle：PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING
nat   ：PREROUTING，[INPUT，]OUTPUT，POSTROUTING  # centos6上少支持了INPUT链，跟版本有关
filter：INPUT，FORWARD，OUTPUT
</pre>

<p>
<b>数据包过滤匹配流程</b>
</p>


<figure id="org4388085">
<img src="images/image-20210217100756188.png" alt="image-20210217100756188.png">

</figure>

<p>
<b>内核中数据包的传输过程</b>
</p>

<ul class="org-ul">
<li>当一个数据包进入网卡时，数据包首先进入PREROUTING链，内核根据数据包目
的IP判断是否需要转送出去</li>
<li>如果数据包是进入本机的，数据包就会沿着图向下移动，到达INPUT链。数据
包到达INPUT链后，任何进程都会收到它。本机上运行的程序可以发送数据包，
这些数据包经过OUTPUT链，然后到达POSTROUTING链输出</li>
<li>如果数据包是要转发出去的，且内核允许转发，数据包就会向右移动，经过
FORWARD链，然后到达POSTROUTING链输出</li>
</ul>

<p>
范例：表和链对应关系
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">filter&#34920;&#40664;&#35748;&#65292;&#25903;&#25345;INPUT&#65292;FORWARD&#65292;OUTPUT</span>
root@centos8 ~]#iptables -vnL -t filter 
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target &#160;&#160;prot opt<span style="color: #a020f0;"> in</span> &#160;&#160;out &#160;&#160;source &#160;&#160;&#160;&#160;&#160;&#160;&#160;destination

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target &#160;&#160;prot opt<span style="color: #a020f0;"> in</span> &#160;&#160;out &#160;&#160;source &#160;&#160;&#160;&#160;&#160;&#160;&#160;destination

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target &#160;&#160;prot opt<span style="color: #a020f0;"> in</span> &#160;&#160;out &#160;&#160;source &#160;&#160;&#160;&#160;&#160;&#160;&#160;destination

<span style="color: #b22222;"># </span><span style="color: #b22222;">nat&#34920;&#65292;&#25903;&#25345;PREROUTING&#65292;INPUT&#65292;OUTPUT&#65292;POSTROUTING</span>
[root@centos8 ~]#iptables -vnL -t nat 
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)

<span style="color: #b22222;"># </span><span style="color: #b22222;">mangle&#34920;&#65292;&#25903;&#25345;PREROUTING&#65292;INPUT&#65292;FORWARD&#65292;OUTPUT&#65292;POSTROUTING</span>
[root@centos8 ~]#iptables -vnL -t mangle
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)

<span style="color: #b22222;"># </span><span style="color: #b22222;">raw&#34920;&#65292;&#25903;&#25345;PREROUTING&#65292; OUTPUT</span>
[root@centos8 ~]#iptables -vnL -t raw
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)

<span style="color: #b22222;"># </span><span style="color: #b22222;">security&#34920;&#65292;&#25903;&#25345;IPUT, FORWARD, OUTPUT</span>
[root@centos8 ~]#iptables -vnL -t security
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)

<span style="color: #b22222;">#</span><span style="color: #b22222;">CentOS 6 nat&#34920;&#19981;&#25903;&#25345;INPUT&#38142;</span>
[root@centos6 ~]#iptables -vnL -t nat
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ba854ffd-e62b-43ea-aa16-d2776d97efde" class="outline-4">
<h4 id="h:ba854ffd-e62b-43ea-aa16-d2776d97efde">netfilter 完整流程</h4>
<div class="outline-text-4" id="text-h:ba854ffd-e62b-43ea-aa16-d2776d97efde">

<figure id="orge0f23de">
<img src="images/image-20210217100828725.png" alt="image-20210217100828725.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:5cf074a6-01a4-4476-a874-15bfa8cae985" class="outline-3">
<h3 id="h:5cf074a6-01a4-4476-a874-15bfa8cae985">iptables</h3>
<div class="outline-text-3" id="text-h:5cf074a6-01a4-4476-a874-15bfa8cae985">
</div>
<div id="outline-container-h:4f5426ea-3c52-4b14-bade-f023d76d49e0" class="outline-4">
<h4 id="h:4f5426ea-3c52-4b14-bade-f023d76d49e0">iptables 规则说明</h4>
<div class="outline-text-4" id="text-h:4f5426ea-3c52-4b14-bade-f023d76d49e0">
</div>
<div id="outline-container-h:22cceb12-4d75-4134-839a-015593974804" class="outline-5">
<h5 id="h:22cceb12-4d75-4134-839a-015593974804">iptables 规则组成</h5>
<div class="outline-text-5" id="text-h:22cceb12-4d75-4134-839a-015593974804">
<p>
规则rule：根据规则的匹配条件尝试匹配报文，对匹配成功的报文根据规则定义
的处理动作作出处理，规则在链接上的次序即为其检查时的生效次序
</p>

<p>
匹配条件：默认为与条件，同时满足
</p>

<ul class="org-ul">
<li>基本匹配：IP，端口，TCP的Flags（SYN,ACK等）</li>

<li>扩展匹配：通过复杂高级功能匹配</li>
</ul>

<p>
处理动作：称为target，跳转目标
</p>

<ul class="org-ul">
<li>内建处理动作：ACCEPT,DROP,REJECT,SNAT,DNAT,MASQUERADE,MARK,LOG&#x2026;</li>
<li>自定义处理动作：自定义chain，利用分类管理复杂情形</li>
</ul>

<p>
规则要添加在链上，才生效；添加在自定义链上不会自动生效
</p>


<figure id="org416154f">
<img src="images/image-20210416153129204.png" alt="image-20210416153129204.png">

</figure>

<p>
范例：处理动作
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#20869;&#24314;&#22788;&#29702;&#21160;&#20316;</span>
ACCEPT    &#65306;&#20801;&#35768;&#25968;&#25454;&#21253;&#36890;&#36807;
DROP      &#65306;&#20002;&#24323;&#25968;&#25454;&#21253;
REJECT    &#65306;&#25298;&#32477;&#25968;&#25454;&#21253;&#65292;&#21516;&#26102;&#32473;&#21457;&#36865;&#32773;&#21457;&#36865;&#27809;&#26377;&#25509;&#21463;&#30340;&#36890;&#30693;
RETURN    &#65306;&#32467;&#26463;&#24403;&#21069;&#36820;&#22238;&#35843;&#29992;&#38142;&#65307;
REDIRECT  &#65306;&#31471;&#21475;&#37325;&#23450;&#21521;&#65307;
LOG       &#65306;&#35760;&#24405;&#26085;&#24535;&#65307;
MARK      &#65306;&#20570;&#38450;&#28779;&#22681;&#26631;&#35760;&#65307;
DNAT      &#65306;&#30446;&#26631;&#22320;&#22336;&#36716;&#25442;&#65307;
SNAT      &#65306;&#28304;&#22320;&#22336;&#36716;&#25442;&#65307;
MASQUERADE&#65306;&#22320;&#22336;&#20266;&#35013;&#65307;&#20851;&#38381;
&#33258;&#23450;&#20041;&#38142;   &#65306; -j WEB_CHAIN <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20851;&#32852;&#20869;&#32622;&#38142;&#20013;&#65292;&#33258;&#23450;&#20041;&#38142;&#25165;&#29983;&#25928;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3b46b0e6-41f9-40fa-b852-9eb1f90be40e" class="outline-5">
<h5 id="h:3b46b0e6-41f9-40fa-b852-9eb1f90be40e">iptables规则添加时考量点</h5>
<div class="outline-text-5" id="text-h:3b46b0e6-41f9-40fa-b852-9eb1f90be40e">
<ul class="org-ul">
<li>要实现哪种功能：判断添加在哪张表上</li>
<li>报文流经的路径：判断添加在哪个链上</li>
<li>报文的流向：判断源和目的</li>
<li>匹配规则：业务需要</li>
</ul>
</div>
</div>
<div id="outline-container-h:666370a4-ba29-4025-8578-aa3b9199fdaf" class="outline-5">
<h5 id="h:666370a4-ba29-4025-8578-aa3b9199fdaf">环境准备(禁用默认防火墙规则)</h5>
<div class="outline-text-5" id="text-h:666370a4-ba29-4025-8578-aa3b9199fdaf">
<p>
默认防火墙有很多自定义规则初期不好理解
</p>

<p>
Centos 7，8：
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl stop firewalld.service
systemctl disable firewalld. service
&#25110;&#32773;
systemctl disable --now firewalld.service
</pre>
</div>

<p>
Centos6：
</p>

<div class="org-src-container">
<pre class="src src-sh">service iptables stop
chkconfig iptables off
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:9db34b34-110e-46f7-9b2c-c2e6f8c0360c" class="outline-4">
<h4 id="h:9db34b34-110e-46f7-9b2c-c2e6f8c0360c">iptables 用法说明</h4>
<div class="outline-text-4" id="text-h:9db34b34-110e-46f7-9b2c-c2e6f8c0360c">
<p>
帮助：man 8 iptables 格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables [-t table] {-A|-C|-D} chain rule-specification
iptables [-t table] -I chain [rulenum] rule-specification
iptables [-t table] -R chain rulenum rule-specification
iptables [-t table] -D chain rulenum
iptables [-t table] -S [chain [rulenum]]
iptables [-t table] {-F|-L|-Z} [chain [rulenum]] [options...]
iptables [-t table] -N chain
iptables [-t table] -X [chain]
iptables [-t table] -P chain target
iptables [-t table] -E old-chain-name new-chain-name
rule-specification = [matches...] [target]
match = -m matchname [per-match-options]
target = -j targetname [per-target-options]
</pre>
</div>

<p>
<b>范例：Filter表中INPUT规则</b>
</p>


<figure id="org252e6bf">
<img src="images/image-20210217100904154.png" alt="image-20210217100904154.png">

</figure>

<p>
<b>iptables命令格式详解：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables  [-t table] &#160;SUBCOMMAND &#160;chain &#160;[-m matchname [per-match-options]] -j targetname [per-target-options]
</pre>
</div>

<p>
<b>1、-t table：指定表</b>
</p>

<p>
raw, mangle, nat, [filter]默认
</p>

<p>
<b>2、SUBCOMMAND：子命令</b> <b>链管理类：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">-N&#65306;new, &#33258;&#23450;&#20041;&#19968;&#26465;&#26032;&#30340;&#35268;&#21017;&#38142;
-E&#65306;&#37325;&#21629;&#21517;&#33258;&#23450;&#20041;&#38142;&#65307;&#24341;&#29992;&#35745;&#25968;&#19981;&#20026;0&#30340;&#33258;&#23450;&#20041;&#38142;&#19981;&#33021;&#22815;&#34987;&#37325;&#21629;&#21517;&#65292;&#20063;&#19981;&#33021;&#34987;&#21024;&#38500;
-X&#65306;delete&#65292;&#21024;&#38500;&#33258;&#23450;&#20041;&#30340;&#31354;&#30340;&#35268;&#21017;&#38142;

-P&#65306;Policy&#65292;&#35774;&#32622;&#40664;&#35748;&#31574;&#30053;&#65307;&#23545;filter&#34920;&#20013;&#30340;&#38142;&#32780;&#35328;&#65292;&#20854;&#40664;&#35748;&#31574;&#30053;&#26377;&#65306;ACCEPT&#65306;&#25509;&#21463;, DROP&#65306;&#20002;&#24323;&#12290;(&#19981;&#24314;&#35758;&#20462;&#25913;&#40664;&#35748;&#35268;&#21017;&#65292;&#21487;&#33021;&#40664;&#35748;&#25913;&#25104;DROP&#65292;iptables -F&#28165;&#31354;&#21518;&#26080;&#27861;&#20877;&#36830;&#25509;&#26381;&#21153;&#22120;)
</pre>
</div>

<p>
范例：创建自定义链实现WEB的访问控制
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -N web_chain            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#33258;&#23450;&#20041;&#38142;&#65292;&#40664;&#35748;&#22312;filter&#34920;&#20013;</span>
[root@centos8 ~]#iptables -N web_chain -t nat     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;nat&#34920;&#20013;&#65292;&#21019;&#24314;&#33258;&#23450;&#20041;&#38142;</span>
[root@centos8 ~]#iptables -X web_chain -t nat     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;nat&#34920;&#20013;&#30340;web_chain&#38142;</span>
[root@centos8 ~]#iptables -E web_chain WEB_CHAIN  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;&#38142;&#21517;</span>
[root@centos8 ~]#iptables -A WEB_CHAIN -s 10.0.0.6 -p tcp -m multiport --dports 80,443 -j REJECT
[root@centos8 ~]#iptables -R WEB_CHAIN 1 -s 10.0.0.6 -p tcp -m multiport --dports 80,443,8080 -j REJECT

[root@centos8 ~]#iptables -vnL WEB_CHAIN
Chain WEB_CHAIN (1 references)
pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source        destination

  1   60 REJECT   tcp  -- *   *    10.0.0.6       0.0.0.0/0 
    multiport dports 80,443,8080 reject-with icmp-port-unreachable
[root@centos8 ~]#iptables -IINPUT 3 -s 10.0.0.0/24 -j WEB_CHAINN <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20851;&#32852;&#20869;&#32622;&#38142;&#20013;&#65292;&#33258;&#23450;&#20041;&#38142;&#25165;&#29983;&#25928;</span>
[root@centos8 ~]#iptables -IWEB_CHAIN 1 -s 10.0.0.6 -j RETURN    <span style="color: #b22222;"># </span><span style="color: #b22222;">-j RETURN &#22914;&#26524;&#28385;&#36275;&#36825;&#19968;&#26465;&#65292;&#19979;&#38754;&#30340;&#35268;&#21017;&#19981;&#25191;&#34892;&#20102;</span>
[root@centos6 ~]#curl 10.0.0.8
centos8 website
[root@centos6 ~]#curl 10.0.0.8
centos8 website
[root@centos6 ~]#ping -c1 10.0.0.8 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#33258;&#23450;&#20041;&#38142;&#65292;&#28165;&#31354;&#33258;&#23450;&#20041;&#38142;&#35268;&#21017;&#20877;&#21024;&#38500;&#21644;&#21019;&#24314;&#30340;&#39034;&#24207;&#30456;&#21453;</span>
[root@centos8 ~]#iptables -X WEB_CHAIN
iptables v1.8.2 (nf_tables): CHAIN_USER_DEL failed (Device or resource busy):chain WEB_CHAIN
[root@centos8 ~]#iptables -F WEB_CHAIN
[root@centos8 ~]#iptables -X WEB_CHAIN
iptables v1.8.2 (nf_tables): CHAIN_USER_DEL failed (Device or resource busy):
chain WEB_CHAIN
[root@centos8 ~]#iptables -D INPUT 1
[root@centos8 ~]#iptables -X WEB_CHAIN
</pre>
</div>

<p>
<b>查看类：</b>
</p>

<pre class="example" id="org38b76dc">
-L：list, 列出指定链上的所有规则，本选项须置后
-n：numberic，以数字格式显示地址和端口号
-v：verbose，详细信息
-vv 更详细
-x：exactly，显示计数器结果的精确值,而非单位转换后的易读值
--line-numbers：显示规则的序号
-S selected,以iptables-save 命令格式显示链上规则
</pre>

<p>
<b>常用组合：</b>
</p>

<pre class="example" id="org2b7c5ab">
-vnL                   #详细表的规则链
-vvnxL --line-numbers  #显示规则编号
</pre>

<p>
<b>规则管理类：</b>
</p>

<pre class="example" id="orgf7eb408">
-A：append，追加
-I：insert, 插入，要指明插入至的规则编号，默认为第一条。如iptables -I INPUT 2 -s 10.0.0.6 ! -p icmp -j ACCEPT
-D：delete，删除
    (1) 指明规则序号 iptables -D 2
    (2) 指明规则本身
-R：replace，替换指定链上的指定规则编号
-F：flush，清空指定的规则链。不指定链则清理所有规则链。注意链的默认规则不会清理，使用-P修改
-Z：zero，置零
    iptables的每条规则都有两个计数器
    (1) 匹配到的报文的个数
    (2) 匹配到的所有报文的大小之和
</pre>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -F OUTPUT

iptables -F  &#65306;&#28165;&#31354;&#25351;&#23450;&#30340;&#35268;&#21017;&#38142;&#12290;
iptables -X  &#65306;delete&#65292;&#21024;&#38500;&#33258;&#23450;&#20041;&#30340;&#31354;&#30340;&#35268;&#21017;&#38142;
iptables -Z  &#65306;&#32622;&#38646;,&#21253;&#20256;&#36755;&#32479;&#35745;&#28165;0,-vLn&#21487;&#30475;&#21040; 

iptables -R INPUT 2 -s 10.0.0.1 -j REJECT  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26367;&#25442;&#31532;2&#26465;&#35268;&#21017;</span>
</pre>
</div>

<p>
<b>3、chain：</b>
</p>

<p>
PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING
</p>

<p>
<b>4、匹配条件</b>
</p>

<ul class="org-ul">
<li>基本：通用的，PARAMETERS</li>
<li>扩展：需加载模块，MATCH EXTENTIONS</li>
</ul>

<p>
<b>5、处理动作：</b>
</p>

<pre class="example" id="org058996e">
-j targetname [per-target-options]
</pre>

<p>
简单动作：
</p>

<pre class="example" id="org615b30d">
ACCEPT    ：允许数据包通过
DROP      ：丢弃数据包
</pre>

<p>
扩展动作：
</p>

<pre class="example" id="org2149a84">
REJECT    ：拒绝数据包，同时给发送者发送没有接受的通知 --reject-with:icmp-port-unreachable默认
RETURN    ：结束当前返回调用链；
REDIRECT  ：端口重定向；
LOG       ：记录日志；
MARK      ：做防火墙标记；
DNAT      ：目标地址转换；
SNAT      ：源地址转换；
MASQUERADE：地址伪装；关闭
自定义链   ： -j WEB_CHAIN # 关联内置链中，自定义链才生效
</pre>
</div>
</div>
<div id="outline-container-h:5c6336b9-30df-4c45-b1be-d8b90d83105e" class="outline-4">
<h4 id="h:5c6336b9-30df-4c45-b1be-d8b90d83105e">iptables 基本匹配条件</h4>
<div class="outline-text-4" id="text-h:5c6336b9-30df-4c45-b1be-d8b90d83105e">
<p>
基本匹配条件：无需加载模块，由iptables/netfilter自行提供
</p>

<div class="org-src-container">
<pre class="src src-sh">[!] -s, --source address[/mask][,...]&#65306;&#28304;IP&#22320;&#22336;&#25110;&#32773;&#19981;&#36830;&#32493;&#30340;IP&#22320;&#22336;&#65292;!&#24863;&#21497;&#21495;&#21462;&#21453;&#12290;
[!] -d, --destination address[/mask][,...]&#65306;&#30446;&#26631;IP&#22320;&#22336;&#25110;&#32773;&#19981;&#36830;&#32493;&#30340;IP&#22320;&#22336;
[!] -p, --protocol protocol&#65306;&#25351;&#23450;&#21327;&#35758;&#65292;&#21487;&#20351;&#29992;&#25968;&#23383;&#22914;0&#65288;all&#65289;
    protocol: tcp, udp, icmp, icmpv6, udplite,esp, ah, sctp, mh or&#8220;all&#8220; 
    &#21442;&#30475;&#65306;/etc/protocols
[!] -i, --in-interface name&#65306;&#25253;&#25991;&#27969;&#20837;&#30340;&#25509;&#21475;&#65307;&#21482;&#33021;&#24212;&#29992;&#20110;&#25968;&#25454;&#25253;&#25991;&#27969;&#20837;&#29615;&#33410;&#65292;&#21482;&#24212;&#29992;&#20110;INPUT&#12289;FORWARD&#12289;PREROUTING&#38142;
[!] -o, --out-interface name&#65306;&#25253;&#25991;&#27969;&#20986;&#30340;&#25509;&#21475;&#65307;&#21482;&#33021;&#24212;&#29992;&#20110;&#25968;&#25454;&#25253;&#25991;&#27969;&#20986;&#30340;&#29615;&#33410;&#65292;&#21482;&#24212;&#29992;&#20110;FORWARD&#12289;OUTPUT&#12289;POSTROUTING&#38142;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -A INPUT -s 10.0.0.6,10.0.0.10 -j REJECT
[root@centos8 ~]#iptables -I INPUT -i lo -j ACCEPT <span style="color: #b22222;"># </span><span style="color: #b22222;">-I &#25554;&#20837;&#35268;&#21017; &#36825;&#37324;&#30465;&#30053;&#20102;1</span>
[root@centos8 ~]#curl 127.0.0.1
10.0.0.8
[root@centos8 ~]#curl 10.0.0.8
10.0.0.8

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#26159;icmp&#21327;&#35758;&#30340;&#35268;&#21017;&#20801;&#35768;&#36830;&#25509;</span>
[root@centos8 ~]#iptables -I INPUT 2 -s 10.0.0.6 ! -p icmp -j ACCEPT <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;&#31532;2&#26465;&#21069;&#38754;&#25554;&#20837;&#27530;&#26465;&#20214;&#35268;&#21017;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:499ad751-f61e-4bfa-a724-8a332d6949f6" class="outline-4">
<h4 id="h:499ad751-f61e-4bfa-a724-8a332d6949f6">iptables 扩展匹配条件</h4>
<div class="outline-text-4" id="text-h:499ad751-f61e-4bfa-a724-8a332d6949f6">
<p>
扩展匹配条件：需要加载扩展模块（ <code>/usr/lib64/xtables/*.so</code> ），方可生效
</p>

<p>
扩展模块的查看帮助 ：man iptables-extensions
</p>

<p>
扩展匹配条件：
</p>

<ul class="org-ul">
<li>隐式扩展</li>
<li>显式扩展</li>
</ul>
</div>
<div id="outline-container-h:2645cee0-4765-4cdb-94aa-56a69f3b4642" class="outline-5">
<h5 id="h:2645cee0-4765-4cdb-94aa-56a69f3b4642">隐式扩展</h5>
<div class="outline-text-5" id="text-h:2645cee0-4765-4cdb-94aa-56a69f3b4642">
<p>
iptables
在使用 <code>-p</code> 选项指明了特定的协议时，无需再用-m选项指明扩展模块的扩展机制，不需要手动加载扩展模块
</p>

<p>
如： <code>-p tcp</code> 知道是tcp协议模块了就不需要指明 <code>-m tcp -p tcp</code> 了
</p>

<p>
<b>tcp 协议的扩展选项</b>
</p>

<pre class="example" id="orge75b0d3">
[!] --source-port, --sport port[:port]：匹配报文源端口,可为端口连续范围
[!] --destination-port,--dport port[:port]：匹配报文目标端口,可为连续范围
[!] --tcp-flags mask comp
    mask 需检查的标志位列表，用,分隔 , 例如 SYN,ACK,FIN,RST
    comp 在mask列表中必须为1的标志位列表，无指定则必须为0，用,分隔tcp协议的扩展选项

[!] --syn：用于匹配第一次握手, 相当于：--tcp-flags SYN,ACK,FIN,RST SYN
</pre>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">--tcp-flags SYN,ACK,FIN,RST SYN     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#34920;&#31034;&#35201;&#26816;&#26597;&#30340;&#26631;&#24535;&#20301;&#20026;SYN,ACK,FIN,RST&#22235;&#20010;&#65292;&#20854;&#20013;SYN&#24517;&#39035;&#20026;1&#65292;&#20313;&#19979;&#30340;&#24517;&#39035;&#20026;0&#65292;&#31532;&#19968;&#27425;&#25569;&#25163;</span>
--tcp-flags SYN,ACK,FIN,RST SYN,ACK <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#20108;&#27425;&#25569;&#25163;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38169;&#35823;&#21253;</span>
--tcp-flags ALL ALL 
--tcp_flags ALL NONE
</pre>
</div>

<p>
<code>[!] --syn</code> ：用于匹配第一次握手, 相当于：&#x2013;tcp-flags SYN,ACK,FIN,RST SYN
</p>

<p>
<b>udp 协议的扩展选项</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[!] --source-port, --sport port[:port]&#65306;&#21305;&#37197;&#25253;&#25991;&#30340;&#28304;&#31471;&#21475;&#25110;&#31471;&#21475;&#33539;&#22260;
[!] --destination-port,--dport port[:port]&#65306;&#21305;&#37197;&#25253;&#25991;&#30340;&#30446;&#26631;&#31471;&#21475;&#25110;&#31471;&#21475;&#33539;&#22260;
</pre>
</div>

<p>
<b>icmp 协议的扩展选项</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[!] --icmp-type {<span style="color: #483d8b;">type</span>[/code]|typename}
    type/code
    0/0 &#160;echo-reply icmp&#24212;&#31572;
    8/0 &#160;echo-request icmp&#35831;&#27714;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -A INPUT -s 10.0.0.6 -p tcp --dport 21:23 -j REJECT
[root@centos8 ~]#ipn
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num  pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source       
destination    
1     1   60 REJECT   tcp  -- *   *    10.0.0.6      
0.0.0.0/0      tcp dpts:21:23 reject-with icmp-port-unreachable
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num  pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source       
destination    
Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
num  pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source       
destination
</pre>
</div>

<p>
范例：TCP第一次握手拒绝
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -A INPUT -p tcp --syn -j REJECT
</pre>
</div>

<p>
范例：10.0.0.6的ping的请求包拒绝
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -I INPUT -s 10.0.0.6 -p icmp --icmp-type 8 -j REJECT
</pre>
</div>
</div>
</div>
<div id="outline-container-h:db740704-f14e-4018-943e-7b0820ca918b" class="outline-5">
<h5 id="h:db740704-f14e-4018-943e-7b0820ca918b">显式扩展及相关模块</h5>
<div class="outline-text-5" id="text-h:db740704-f14e-4018-943e-7b0820ca918b">
<p>
显示扩展即必须使用 <code>-m</code> 选项指明要调用的扩展模块名称，需要手动加载扩展模块
</p>

<pre class="example" id="org3c16296">
[-m matchname [per-match-options]]
</pre>

<p>
<b>扩展模块的使用帮助：</b>
</p>

<ul class="org-ul">
<li>CentOS 7,8: man iptables-extensions</li>
<li>CentOS 6: man iptables</li>
</ul>
</div>
<ul class="org-ul">
<li><a id="h:1f6788cc-b719-479f-8b72-c83cfb65cde1"></a>multiport扩展<br>
<div class="outline-text-6" id="text-h:1f6788cc-b719-479f-8b72-c83cfb65cde1">
<p>
以离散方式定义多端口匹配,最多指定15个端口
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#22810;&#20010;&#28304;&#31471;&#21475;&#65292;&#36830;&#32493;&#31471;&#21475;:&#20882;&#21495;&#20998;&#38548;&#65292;&#19981;&#36830;&#32493;&#31471;&#21475;,&#36887;&#21495;&#20998;&#38548;</span>
[!] --source-ports,--sports port[,port|,port:port]...

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#22810;&#20010;&#30446;&#26631;&#31471;&#21475;</span>
[!] --destination-ports,--dports port[,port|,port:port]...

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#20010;&#28304;&#25110;&#30446;&#26631;&#31471;</span>
[!] --ports port[,port|,port:port]...
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -A INPUT -s 172.16.0.0/16 -d 172.16.100.10 -p tcp -m multiport --dports 20:22,80 -j ACCEPT

[root@centos8 ~]#iptables -A INPUT -s 10.0.0.6 -p tcp -m multiport --dports 445,139 -j REJECT
[root@centos8 ~]#ipn
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num &#160;pkts bytes target &#160;&#160;prot opt<span style="color: #a020f0;"> in</span> &#160;&#160;out &#160;&#160;source &#160;&#160;&#160;&#160;&#160;&#160;
destination &#160;&#160;&#160;
1 &#160;&#160;&#160;&#160;2 &#160;120 REJECT &#160;&#160;tcp &#160;-- * &#160;&#160;* &#160;&#160;&#160;10.0.0.6 &#160;&#160;&#160;&#160;&#160;
0.0.0.0/0 &#160;&#160;&#160;&#160;&#160;multiport dports 445,139 reject-with icmp-port-unreachable
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num &#160;pkts bytes target &#160;&#160;prot opt<span style="color: #a020f0;"> in</span> &#160;&#160;out &#160;&#160;source &#160;&#160;&#160;&#160;&#160;&#160;
destination &#160;&#160;&#160;
Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
num &#160;pkts bytes target &#160;&#160;prot opt<span style="color: #a020f0;"> in</span> &#160;&#160;out &#160;&#160;source &#160;&#160;&#160;&#160;&#160;&#160;
destination
</pre>
</div>
</div>
</li>
<li><a id="h:b26b41b3-9493-4018-b8a6-087a1d1090a7"></a>iprange扩展<br>
<div class="outline-text-6" id="text-h:b26b41b3-9493-4018-b8a6-087a1d1090a7">
<p>
指明连续的（但一般不是整个网络）ip地址范围
</p>

<div class="org-src-container">
<pre class="src src-sh">[!] --src-range from[-to] &#28304;IP&#22320;&#22336;&#33539;&#22260;
[!] --dst-range from[-to] &#30446;&#26631;IP&#22320;&#22336;&#33539;&#22260;
</pre>
</div>

<p>
范例：源ip从172.16.1.5到172.16.1.10访问80端口拒绝
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -A INPUT -d 172.16.1.100 -p tcp --dport 80 -m iprange --src-range 172.16.1.5-172.16.1.10 -j DROP
</pre>
</div>
</div>
</li>
<li><a id="h:b71c4829-d07a-43c0-92e5-176a3056c6d1"></a>mac扩展<br>
<div class="outline-text-6" id="text-h:b71c4829-d07a-43c0-92e5-176a3056c6d1">
<p>
mac 模块可以指明源MAC地址,，适用于：PREROUTING, FORWARD，INPUT chains
</p>

<div class="org-src-container">
<pre class="src src-sh">[!] --mac-source XX:XX:XX:XX:XX:XX
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#30446;&#26631;&#22320;&#22336;mac&#22320;&#22336;&#19981;&#26159;&#33258;&#24049;&#23601;&#36830;&#19981;&#36827;&#26469;&#65292;&#25152;&#20197;&#27809;&#26377;&#30446;&#26631;mac&#22320;&#22336;&#36873;&#39033;</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -A INPUT -s 172.16.0.100 -m mac &#160;--mac-source 00:50:56:12:34:56 -j ACCEPT
iptables -A INPUT -s 172.16.0.100 &#160;-j REJECT
</pre>
</div>
</div>
</li>
<li><a id="h:d5efe97c-50d3-44c0-951c-c7c3d0865fff"></a>string扩展<br>
<div class="outline-text-6" id="text-h:d5efe97c-50d3-44c0-951c-c7c3d0865fff">
<p>
对报文中的应用层数据做字符串模式匹配检测
</p>

<pre class="example" id="org5297800">
--algo {bm|kmp} 字符串匹配检测算法
    bm：Boyer-Moore
    kmp：Knuth-Pratt-Morris
--from offset 开始偏移
--to offset  结束偏移
[!] --string pattern 要检测的字符串模式
[!] --hex-string pattern要检测字符串模式，16进制格式
</pre>

<p>
范例：响应端，分析访问页面中有google字符的拒绝访问
</p>

<p>
以太网MAC帧格式
</p>


<figure id="org1b9080d">
<img src="images/image-20210416202826772.png" alt="image-20210416202826772.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">iptables -A OUTPUT -p tcp --sport 80 -m string --algo bm --from 62 &#160;--string  <span style="color: #8b2252;">"google"</span> -j REJECT <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21069;62&#20010;&#23383;&#33410;&#20026;&#22266;&#23450;&#39318;&#37096;&#20449;&#24687;</span>
</pre>
</div>
</div>
</li>
<li><a id="h:72af7ebf-66bf-4a47-9847-5874afc4c906"></a>time扩展<br>
<div class="outline-text-6" id="text-h:72af7ebf-66bf-4a47-9847-5874afc4c906">
<p>
<b>注意：CentOS 8 此模块有问题</b>
</p>

<p>
根据将报文到达的时间与指定的时间范围进行匹配
</p>

<pre class="example" id="orgbdd229f">
--datestart YYYY[-MM[-DD[Thh[:mm[:ss]]]]] 日期
--datestop YYYY[-MM[-DD[Thh[:mm[:ss]]]]]
--timestart hh:mm[:ss]    时间
--timestop hh:mm[:ss]
[!] --monthdays day[,day...]  每个月的几号
[!] --weekdays day[,day...]  星期几，1 – 7 分别表示星期一到星期日
--kerneltz：内核时区（当地时间），不建议使用；CentOS 7 系统默认为 UTC
注意： centos6 不支持kerneltz ，--localtz指定本地时区(默认)
</pre>

<p>
范例: CentOS 8 的time模块问题
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -ql iptables |grep time
/usr/lib64/xtables/libxt_time.so
[root@centos8 ~]#iptables -A INPUT -m time --timestart 12:30 --timestop 13:30 -j ACCEPT <span style="color: #b22222;"># </span><span style="color: #b22222;">UTC&#26684;&#26519;&#26102;&#38388;12&#65306;30&#21040;13&#65306;30&#65292;&#20013;&#22269;&#26102;&#38388;20:30&#21040;21&#65306;30</span>
iptables v1.8.4 (nf_tables): Couldn<span style="color: #8b2252;">'t load match `time'</span>:No such file or directory
</pre>
</div>

<p>
范例: 关于 &#x2013;kerneltz 选项
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#man iptables-extensions
The caveat with the kernel timezone is that Linux distributions may ignore to
<span style="color: #483d8b;">set</span> the kernel timezone,and instead only set the system time. Even if a
particular distribution does set the timezone at boot,it is usually does not
keep the kernel timezone offset - which is what changes on DST - up to date.
ntpd will not touch the kernel timezone, so running it will not resolve the
issue. As such,one may &#160;&#160;&#160;encounter a timezone that is always +0000, or one
that is wrong half of the time of the year. As such,using --kerneltz is highly
discouraged.
</pre>
</div>

<p>
范例：周六周日14:30到18:30访问172.16.100.10的80端口的拒绝
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#iptables -A INPUT -s 172.16.0.0/16 -d 172.16.100.10 -p tcp --dport 80 -m time --timestart 14:30 --timestop 18:30 --weekdays Sat,Sun --kerneltz -j DROP <span style="color: #b22222;"># </span><span style="color: #b22222;">--kerneltz &#24403;&#22320;&#26102;&#38388;&#19981;&#25512;&#33616;&#20351;&#29992;</span>
</pre>
</div>
</div>
</li>
<li><a id="h:bb6d31a5-d0b7-4827-a6ad-501317998f66"></a>connlimit扩展<br>
<div class="outline-text-6" id="text-h:bb6d31a5-d0b7-4827-a6ad-501317998f66">
<p>
根据每客户端IP做并发连接数数量匹配
</p>

<p>
可防止Dos(Denial of Service，拒绝服务)攻击
</p>

<div class="org-src-container">
<pre class="src src-sh">--connlimit-upto N  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#30340;&#25968;&#37327;&#23567;&#20110;&#31561;&#20110;N&#26102;&#21305;&#37197;</span>
--connlimit-above N <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#30340;&#25968;&#37327;&#22823;&#20110;N&#26102;&#21305;&#37197;</span>
</pre>
</div>

<p>
范例：访问22端口连接数大于2个时拒绝连接
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1.&#21033;&#29992;connlimit&#27169;&#22359;&#23558;&#21333;IP&#30340;&#24182;&#21457;&#35774;&#32622;&#20026;2&#65307;&#20250;&#35823;&#26432;&#20351;&#29992;NAT&#19978;&#32593;&#30340;&#29992;&#25143;&#65292;&#21487;&#20197;&#26681;&#25454;&#23454;&#38469;&#24773;&#20917;&#22686;&#22823;&#35813;&#20540;</span>
iptables -A INPUT -d 172.16.100.10 -p tcp --dport 22 -m connlimit --connlimit-above 2 -j REJECT

<span style="color: #b22222;">#</span><span style="color: #b22222;">2.&#21033;&#29992;recent&#21644;state&#27169;&#22359;&#38480;&#21046;&#21333;IP&#22312;300s&#20869;&#21482;&#33021;&#19982;&#26412;&#26426;&#24314;&#31435;2&#20010;&#26032;&#36830;&#25509;&#12290;&#34987;&#38480;&#21046;&#20116;&#20998;&#38047;&#21518;&#21363;&#21487;&#24674;&#22797;&#35775;&#38382;&#12290;</span>
iptables -I INPUT  -p tcp --dport 22 -m state --state NEW -m recent --set --name SSH
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35760;&#24405;&#35775;&#38382;tcp 22&#31471;&#21475;&#30340;&#26032;&#36830;&#25509;&#65292;&#35760;&#24405;&#21517;&#31216;&#20026;SSH&#12290;--set &#35760;&#24405;&#25968;&#25454;&#21253;&#30340;&#26469;&#28304;IP&#65292;&#22914;&#26524;IP&#24050;&#32463;&#23384;&#22312;&#23558;&#26356;&#26032;&#24050;&#32463;&#23384;&#22312;&#30340;&#26465;&#30446;</span>

iptables -I INPUT  -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 300 --hitcount 3 --name SSH -j LOG --log-prefix <span style="color: #8b2252;">"SSH Attach: "</span>
iptables -I INPUT  -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 300 --hitcount 3 --name SSH -j DROP
<span style="color: #b22222;">#</span><span style="color: #b22222;">SSH&#35760;&#24405;&#20013;&#30340;IP&#65292;300s&#20869;&#21457;&#36215;&#36229;&#36807;3&#27425;&#36830;&#25509;&#21017;&#25298;&#32477;&#27492;IP&#30340;&#36830;&#25509;&#12290;</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">--update &#26159;&#25351;&#27599;&#27425;&#24314;&#31435;&#36830;&#25509;&#37117;&#26356;&#26032;&#21015;&#34920;&#65307;</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">--seconds&#24517;&#39035;&#19982;--rcheck&#25110;&#32773;--update&#21516;&#26102;&#20351;&#29992;</span>
<span style="color: #b22222;">#    </span><span style="color: #b22222;">--hitcount&#24517;&#39035;&#19982;--rcheck&#25110;&#32773;--update&#21516;&#26102;&#20351;&#29992;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">3.iptables&#30340;&#35760;&#24405;&#65306;/proc/net/xt_recent/SSH</span>
</pre>
</div>
</div>
</li>
<li><a id="h:9be1db23-ce50-40a1-b1ca-cdd2300a8d5a"></a>limit扩展<br>
<div class="outline-text-6" id="text-h:9be1db23-ce50-40a1-b1ca-cdd2300a8d5a">
<p>
基于收发报文的速率做匹配 , 令牌桶过滤器
</p>

<div class="org-src-container">
<pre class="src src-sh">--limit-burst number <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21069;&#22810;&#23569;&#20010;&#21253;&#19981;&#38480;&#21046;</span>
--limit <span style="color: #b22222;">#</span><span style="color: #b22222;">[/second|/minute|/hour|/day]</span>
</pre>
</div>

<p>
范例：从第六个包开始限制，每分钟允许10个包
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -I INPUT -d 172.16.100.10 -p icmp --icmp-type 8 -m limit --limit 10/minute --limit-burst 5 -j ACCEPT
iptables -I INPUT 2 -p icmp -j REJECT
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -A INPUT -p icmp -m limit --limit-burst 10 --limit 20/minute -j ACCEPT
[root@centos8 ~]#iptables -A INPUT -p icmp -j REJECT
[root@centos6 ~]#ping 10.0.0.8
PING 192.168.39.8 (192.168.39.8) 56(84) bytes of data.
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=1 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.779 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=2 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.436 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=3 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.774 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=4 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.391 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=5 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.441 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=6 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.356 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=7 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.553 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=8 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.458 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=9 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.459 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=10 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.479 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=11 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.450 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=12 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.471 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=13 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.531 ms
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=14 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.444 ms
From 192.168.39.8 <span style="color: #a0522d;">icmp_seq</span>=15 Destination Port Unreachable
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=16 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.668 ms
From 192.168.39.8 <span style="color: #a0522d;">icmp_seq</span>=17 Destination Port Unreachable
From 192.168.39.8 <span style="color: #a0522d;">icmp_seq</span>=18 Destination Port Unreachable
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=19 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.692 ms
From 192.168.39.8 <span style="color: #a0522d;">icmp_seq</span>=20 Destination Port Unreachable
From 192.168.39.8 <span style="color: #a0522d;">icmp_seq</span>=21 Destination Port Unreachable
64 bytes from 192.168.39.8: <span style="color: #a0522d;">icmp_seq</span>=22 <span style="color: #a0522d;">ttl</span>=64 <span style="color: #a0522d;">time</span>=0.651 ms
</pre>
</div>
</div>
</li>
<li><a id="h:8e05749a-1fca-4467-85f4-241fe5393518"></a>state扩展<br>
<div class="outline-text-6" id="text-h:8e05749a-1fca-4467-85f4-241fe5393518">
<p>
state 扩展模块，可以根据”连接追踪机制“去检查连接的状态，较耗资源
</p>

<p>
conntrack机制：追踪本机上的请求和响应之间的关系
</p>

<p>
<b>状态类型：</b>
</p>

<ul class="org-ul">
<li>NEW：新发出请求；连接追踪信息库中不存在此连接的相关信息条目，因此，将其识别为第一次发出的请求</li>
<li>ESTABLISHED：NEW状态之后，连接追踪信息库中为其建立的条目失效之前期间内所进行的通信状态</li>
<li>RELATED：新发起的但与已有连接相关联的连接，如：ftp协议中的数据连接与命令连接之间的关系</li>
<li>INVALID：无效的连接，如flag标记不正确</li>
<li>UNTRACKED：未进行追踪的连接，如：raw表中关闭追踪</li>
</ul>

<p>
已经追踪到的并记录下来的连接信息库
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /proc/net/nf_conntrack
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49900 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49900 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49886 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49886 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49892 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49892 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49904 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49904 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49890 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49890 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49888 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49888 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49896 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49896 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49898 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49898 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49894 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49894 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
ipv4   2 tcp    6 431325 ESTABLISHED <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=49902 <span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.8 <span style="color: #a0522d;">dst</span>=10.0.0.7 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=49902 [ASSURED] <span style="color: #a0522d;">mark</span>=0 <span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
</pre>
</div>

<p>
调整连接追踪功能所能够容纳的最大连接数量
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /proc/sys/net/netfilter/nf_conntrack_max
26624
[root@centos8 ~]#cat /proc/sys/net/nf_conntrack_max
26624
</pre>
</div>

<p>
查看连接跟踪有多少条目
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /proc/sys/net/netfilter/nf_conntrack_count
10
</pre>
</div>

<p>
不同的协议的连接追踪时长
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ll /proc/sys/net/netfilter/
total 0
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_acct
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_buckets
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_checksum
-r--r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_count
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_dccp_loose
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_dccp_timeout_closereq
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_dccp_timeout_closing
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_dccp_timeout_open
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_dccp_timeout_partopen
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_dccp_timeout_request
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_dccp_timeout_respond
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_dccp_timeout_timewait
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_events
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_expect_max
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_generic_timeout
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_helper
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_icmp_timeout
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_log_invalid
-rw-r--r-- 1 root root 0 Mar 19 18:13 nf_conntrack_max
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_sctp_timeout_closed
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_sctp_timeout_cookie_echoed
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_sctp_timeout_cookie_wait
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_sctp_timeout_established
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_sctp_timeout_heartbeat_acked
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_sctp_timeout_heartbeat_sent
-rw-r--r-- 1 root root 0 Mar 19 18:14
nf_conntrack_sctp_timeout_shutdown_ack_sent
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_sctp_timeout_shutdown_recd
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_sctp_timeout_shutdown_sent
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_be_liberal
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_loose
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_max_retrans
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_close
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_close_wait
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_established
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_fin_wait
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_last_ack
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_max_retrans
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_syn_recv
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_syn_sent
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_time_wait
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_tcp_timeout_unacknowledged
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_timestamp
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_udp_timeout
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_conntrack_udp_timeout_stream
dr-xr-xr-x 1 root root 0 Mar 19 18:14 nf_log
-rw-r--r-- 1 root root 0 Mar 19 18:14 nf_log_all_netns
</pre>
</div>

<p>
说明：
</p>

<ul class="org-ul">
<li>连接跟踪，需要加载模块： modprobe nf_conntrack_ipv4</li>
<li>当服务器连接多于最大连接数时dmesg 可以观察到 ：kernel: ip_conntrack:
table full, dropping packet错误,并且导致建立TCP连接很慢。</li>
<li>各种状态的超时后，链接会从表中删除</li>
</ul>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#echo 1 &gt; /proc/sys/net/netfilter/nf_conntrack_max
[root@centos8 ~]#tail /var/log/messages
Jul &#160;8 10:03:53 centos8 kernel: nf_conntrack: nf_conntrack: table full, dropping
packet
[root@centos6 ~]#tail /var/log/messages
Jul &#160;8 09:51:16 centos6 kernel: nf_conntrack: table full, dropping packet.
</pre>
</div>

<p>
连接过多的解决方法两个：
</p>

<ol class="org-ol">
<li><p>
加大nf_conntrack_max 值
</p>

<div class="org-src-container">
<pre class="src src-sh">vi /etc/sysctl.conf
net.nf_conntrack_max = 393216
net.netfilter.nf_conntrack_max = 393216
</pre>
</div></li>

<li><p>
降低 nf_conntrack timeout时间
</p>

<div class="org-src-container">
<pre class="src src-sh">vi /etc/sysctl.conf
net.netfilter.nf_conntrack_tcp_timeout_established = 300
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120
iptables -t nat -L -n
</pre>
</div></li>
</ol>

<p>
格式：
</p>

<pre class="example" id="org3996ba2">
[!] --state state
</pre>

<p>
范例: 不允许10.0.0.7 访问本机,但本机可以访问10.0.0.7
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -S
-P INPUT ACCEPT
-P FORWARD ACCEPT
-P OUTPUT ACCEPT
-A INPUT -s 10.0.0.1/32 -j ACCEPT
-A INPUT ! -s 10.0.0.7/32 -m state --state NEW -j ACCEPT
-A INPUT -m state --state ESTABLISHED -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-port-unreachable
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -A INPUT -d 172.16.1.10 -p tcp -m multiport --dports 22,80 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -s 172.16.1.10 -p tcp -m multiport --sports 22,80 -m state --state ESTABLISHED -j ACCEPT

[root@centos8 ~]#iptables -A INPUT -m state --state ESTABLISHED -j ACCEPT
[root@centos8 ~]#iptables -A INPUT -m state --state NEW -j REJECT
</pre>
</div>

<p>
<b>案例：开放被动模式的ftp服务</b> <b>CentOS 8 此模块有bug</b>
</p>

<ol class="org-ol">
<li><p>
装载ftp连接追踪的专用模块：
</p>

<p>
跟踪模块路径：/lib/modules/kernelversion/kernel/net/netfilter
</p>

<div class="org-src-container">
<pre class="src src-sh">vim /etc/sysconfig/iptables-config
<span style="color: #a0522d;">IPTABLES_MODULES</span>=&#8220;nf_conntrack_ftp<span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">modprobe nf_conntrack_ftp</span>
</pre>
</div></li>

<li><p>
放行请求报文：
</p>

<p>
命令连接：NEW, ESTABLISHED
</p>

<p>
数据连接：RELATED, ESTABLISHED
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -I INPUT -d LocalIP -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -d LocalIP -p tcp --dport 21 -m state --state NEW -j ACCEPT
</pre>
</div></li>

<li><p>
放行响应报文：
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -I OUTPUT -s LocalIP -p tcp -m state --state ESTABLISHED -j ACCEPT
</pre>
</div></li>
</ol>

<p>
范例：开放被动模式的ftp服务示例
</p>

<div class="org-src-container">
<pre class="src src-sh">yum install vsftpd
systemctl start vsftpd
modprobe nf_conntrack_ftp
iptables -F
iptables -A INPUT &#160;-m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p tcp --dport 21 -m state --state NEW -j ACCEPT
iptables -A OUTPUT &#160;-m state --state ESTABLISHED -j ACCEPT
iptables -P INPUT DROP
iptables -P OUTPUT DROP
iptables -vnL
</pre>
</div>
</div>
</li>
<li><a id="h:fa44073d-9e30-445d-bb64-a7f89d5a1d92"></a>mac扩展<br>
<div class="outline-text-6" id="text-h:fa44073d-9e30-445d-bb64-a7f89d5a1d92">
<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1&#12289;&#38459;&#27490;MAC&#22320;&#22336;&#20026;XX:XX:XX:XX:XX:XX&#20027;&#26426;&#30340;&#25152;&#26377;&#36890;&#20449;&#65306;</span>
iptables -A INPUT -m mac --mac-source XX:XX:XX:XX:XX:XX -j DROP
iptables -A INPUT -s 192.168.1.3/32 -m mac --mac-source ab:cd:ef:ab:cd:ef  -p tcp -m tcp --dport 80  -j ACCEPT

<span style="color: #b22222;">#</span><span style="color: #b22222;">2&#12289;&#20801;&#35768;MAC&#22320;&#22336;&#20026;XX:XX:XX:XX:XX:XX&#20027;&#26426;&#35775;&#38382;22&#31471;&#21475;&#65306;</span>
iptables -A INPUT -p tcp --destination-port 22 -m mac --mac-source XX:XX:XX:XX:XX:XX -j ACCEPT

<span style="color: #b22222;">#</span><span style="color: #b22222;">3&#12289;&#20801;&#35768;IP&#22320;&#22336;&#20026;192.168.1.21&#65292;MAC&#22320;&#22336;&#20026;XX:XX:XX:XX:XX:XX&#30340;&#20027;&#26426;&#36890;&#20449;&#65292;&#25298;&#32477;&#22810;&#26377;&#20854;&#20182;&#20027;&#26426;&#65306;</span>
iptables -A INPUT -s 192.168.1.21 -m mac --mac-source XX:XX:XX:XX:XX:XX -j ACCEPT
iptables -P INPUT DROP

<span style="color: #b22222;">#</span><span style="color: #b22222;">4&#12289;&#21487;&#20197;&#20889;&#33050;&#26412;&#38480;&#21046;MAC&#65306;</span>
iptables -P FORWARD DROP
<span style="color: #a020f0;">for</span> mac<span style="color: #a020f0;"> in</span> $(<span style="color: #ff00ff;">cat ipaddressfile</span>); <span style="color: #a020f0;">do</span>
    iptables -A FORWARD -m mac --mac-source $<span style="color: #a0522d;">mac</span> -j ACCEPT
<span style="color: #a020f0;">done</span>
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:492bc41f-380a-477e-b662-1d16bc1bbf7e" class="outline-4">
<h4 id="h:492bc41f-380a-477e-b662-1d16bc1bbf7e">Target</h4>
<div class="outline-text-4" id="text-h:492bc41f-380a-477e-b662-1d16bc1bbf7e">
<p>
target 包括以下类型：
</p>

<div class="org-src-container">
<pre class="src src-sh">&#33258;&#23450;&#20041;&#38142;, ACCEPT&#65292; DROP&#65292; REJECT&#65292;RETURN,LOG&#65292;SNAT&#65292;DNAT&#65292;REDIRECT&#65292;MASQUERADE

ACCEPT    &#65306;&#20801;&#35768;&#25968;&#25454;&#21253;&#36890;&#36807;
DROP      &#65306;&#20002;&#24323;&#25968;&#25454;&#21253;
REJECT    &#65306;&#25298;&#32477;&#25968;&#25454;&#21253;&#65292;&#21516;&#26102;&#32473;&#21457;&#36865;&#32773;&#21457;&#36865;&#27809;&#26377;&#25509;&#21463;&#30340;&#36890;&#30693;
RETURN    &#65306;&#32467;&#26463;&#24403;&#21069;&#36820;&#22238;&#35843;&#29992;&#38142;&#65307;
REDIRECT  &#65306;&#31471;&#21475;&#37325;&#23450;&#21521;&#65307;
LOG       &#65306;&#38750;&#20013;&#26029;target,&#26412;&#36523;&#19981;&#25298;&#32477;&#21644;&#20801;&#35768;,&#25918;&#22312;&#25298;&#32477;&#21644;&#20801;&#35768;&#35268;&#21017;&#21069;&#65292;&#24182;&#23558;&#26085;&#24535;&#35760;&#24405;&#22312;/var/log/messages&#31995;&#32479;&#26085;&#24535;&#20013;
MARK      &#65306;&#20570;&#38450;&#28779;&#22681;&#26631;&#35760;&#65307;
DNAT      &#65306;&#30446;&#26631;&#22320;&#22336;&#36716;&#25442;&#65307;
SNAT      &#65306;&#28304;&#22320;&#22336;&#36716;&#25442;&#65307;
MASQUERADE&#65306;&#22320;&#22336;&#20266;&#35013;&#65307;&#20851;&#38381;
&#33258;&#23450;&#20041;&#38142;   &#65306;-j &#38142;&#21517; <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20851;&#32852;&#20869;&#32622;&#38142;&#20013;&#65292;&#33258;&#23450;&#20041;&#38142;&#25165;&#29983;&#25928;</span>

--log-level level &#160;&#32423;&#21035;&#65306; debug&#65292;info&#65292;notice, warning, error, crit, alert,emerg
--log-prefix prefix &#26085;&#24535;&#21069;&#32512;&#65292;&#29992;&#20110;&#21306;&#21035;&#19981;&#21516;&#30340;&#26085;&#24535;&#65292;&#26368;&#22810;29&#20010;&#23383;&#31526;
</pre>
</div>

<p>
范例：新发起的请求，记录iptables 规则日志
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -I INPUT -s 10.0.0.0/24 -p tcp -m multiport --dports 80,21,22,23 -m state --state NEW -j LOG --log-prefix <span style="color: #8b2252;">"new connections: "</span>

[root@centos8 ~]#tail -f /var/log/messages
Mar 19 18:41:07 centos8 kernel: iptables tcp connection: <span style="color: #a0522d;">IN</span>=eth0 <span style="color: #a0522d;">OUT</span>=
<span style="color: #a0522d;">MAC</span>=00:0c:29:f8:5d:b7:00:50:56:c0:00:08:08:00 <span style="color: #a0522d;">SRC</span>=10.0.0.1 <span style="color: #a0522d;">DST</span>=10.0.0.8 <span style="color: #a0522d;">LEN</span>=40
<span style="color: #a0522d;">TOS</span>=0x00 <span style="color: #a0522d;">PREC</span>=0x00 <span style="color: #a0522d;">TTL</span>=128 <span style="color: #a0522d;">ID</span>=43974 DF <span style="color: #a0522d;">PROTO</span>=TCP <span style="color: #a0522d;">SPT</span>=9844 <span style="color: #a0522d;">DPT</span>=22 <span style="color: #a0522d;">WINDOW</span>=4102
<span style="color: #a0522d;">RES</span>=0x00 ACK <span style="color: #a0522d;">URGP</span>=0
Mar 19 18:41:07 centos8 kernel: new connections: <span style="color: #a0522d;">IN</span>=eth0 <span style="color: #a0522d;">OUT</span>=
<span style="color: #a0522d;">MAC</span>=00:0c:29:f8:5d:b7:00:50:56:c0:00:08:08:00 <span style="color: #a0522d;">SRC</span>=10.0.0.1 <span style="color: #a0522d;">DST</span>=10.0.0.8 <span style="color: #a0522d;">LEN</span>=40
<span style="color: #a0522d;">TOS</span>=0x00 <span style="color: #a0522d;">PREC</span>=0x00 <span style="color: #a0522d;">TTL</span>=128 <span style="color: #a0522d;">ID</span>=43975 DF <span style="color: #a0522d;">PROTO</span>=TCP <span style="color: #a0522d;">SPT</span>=9844 <span style="color: #a0522d;">DPT</span>=22 <span style="color: #a0522d;">WINDOW</span>=4102
<span style="color: #a0522d;">RES</span>=0x00 ACK <span style="color: #a0522d;">URGP</span>=0
Mar 19 18:41:08 centos8 kernel: new connections: <span style="color: #a0522d;">IN</span>=eth0 <span style="color: #a0522d;">OUT</span>=
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#iptables -R INPUT 2 -p tcp --dport 21 -m state --state NEW -j LOG --log-prefix <span style="color: #8b2252;">"ftp new link: "</span>

[root@centos8 ~]#tail -f /var/log/messages
Dec 21 10:02:31 centos8 kernel: ftp new link: <span style="color: #a0522d;">IN</span>=eth0 <span style="color: #a0522d;">OUT</span>=
<span style="color: #a0522d;">MAC</span>=00:0c:29:f9:8d:90:00:0c:29:10:8a:b1:08:00 <span style="color: #a0522d;">SRC</span>=192.168.39.6 <span style="color: #a0522d;">DST</span>=192.168.39.8
<span style="color: #a0522d;">LEN</span>=60 <span style="color: #a0522d;">TOS</span>=0x00 <span style="color: #a0522d;">PREC</span>=0x00 <span style="color: #a0522d;">TTL</span>=64 <span style="color: #a0522d;">ID</span>=15556 DF <span style="color: #a0522d;">PROTO</span>=TCP <span style="color: #a0522d;">SPT</span>=53706 <span style="color: #a0522d;">DPT</span>=21
<span style="color: #a0522d;">WINDOW</span>=14600 <span style="color: #a0522d;">RES</span>=0x00 SYN <span style="color: #a0522d;">URGP</span>=0
</pre>
</div>
</div>
</div>
<div id="outline-container-h:10f4bdee-c93a-48a2-83bd-26a34d37753e" class="outline-4">
<h4 id="h:10f4bdee-c93a-48a2-83bd-26a34d37753e">规则优化最佳实践</h4>
<div class="outline-text-4" id="text-h:10f4bdee-c93a-48a2-83bd-26a34d37753e">
<ol class="org-ol">
<li>安全放行所有入站和出站的状态为ESTABLISHED状态连接,建议放在第一条，效率更高</li>

<li>谨慎放行入站的新请求</li>

<li>有特殊目的限制访问功能，要在放行规则之前加以拒绝</li>

<li>同类规则（访问同一应用，比如：http），匹配范围小的放在前面，用于特
殊处理</li>

<li><p>
不同类的规则（访问不同应用，一个是http，另一个是mysql），匹配范围大
的放在前面，效率更高
</p>

<div class="org-src-container">
<pre class="src src-sh">-s 10.0.0.6 -p tcp --dport 3306 -j REJECT
-s 172.16.0.0/16 -p tcp --dport 80 -j REJECT
</pre>
</div></li>

<li>应该将那些可由一条规则能够描述的多个规则合并为一条，减少规则数量,提高检查效率</li>

<li>设置默认策略，建议白名单（只放行特定连接）

<ul class="org-ul">
<li>iptables -P，不建议，容易出现“自杀现象”</li>
<li>规则的最后定义规则做为默认策略，推荐使用，放在最后一条</li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-h:26466bfc-e2d9-4a5b-a7d0-834436c081c9" class="outline-4">
<h4 id="h:26466bfc-e2d9-4a5b-a7d0-834436c081c9">iptables规则保存</h4>
<div class="outline-text-4" id="text-h:26466bfc-e2d9-4a5b-a7d0-834436c081c9">
<p>
使用iptables命令定义的规则，手动删除之前，其生效期限为kernel存活期限
<b>持久保存规则：</b>
</p>

<p>
CentOS 7,8
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables-save &gt; /PATH/TO/SOME_RULES_FILE
</pre>
</div>

<p>
CentOS 6
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#35268;&#21017;&#35206;&#30422;&#20445;&#23384;&#33267;/etc/sysconfig/iptables&#25991;&#20214;&#20013;</span>
service iptables save
</pre>
</div>

<p>
<b>加载规则</b>
</p>

<p>
CentOS 7,8 重新载入预存规则文件中规则：
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables-restore &lt; /PATH/FROM/SOME_RULES_FILE
</pre>
</div>

<p>
iptables-restore选项
</p>

<pre class="example" id="org81663e9">
-n, --noflush：不清除原有规则
-t, --test：仅分析生成规则集，但不提交
</pre>

<p>
CentOS 6：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20250;&#33258;&#21160;&#20174;/etc/sysconfig/iptables &#37325;&#26032;&#36733;&#20837;&#35268;&#21017;</span>
service iptables &#160;restart
</pre>
</div>

<p>
<b>开机自动重载规则</b>
</p>

<ul class="org-ul">
<li><p>
用脚本保存各iptables命令；让此脚本开机后自动运行
</p>

<p>
/etc/rc.d/rc.local文件中添加脚本路径 /PATH/TO/SOME_SCRIPT_FILE
</p></li>

<li><p>
用规则文件保存各规则，开机时自动载入此规则文件中的规则
</p>

<p>
在/etc/rc.d/rc.local文件添加
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables-restore &lt; /PATH/FROM/IPTABLES_RULES_FILE
</pre>
</div>

<p>
定义Unit File, CentOS 7，8 可以安装 iptables-services 实现iptables.service
</p>

<p>
范例: CentOS 7，8 使用 iptables-services
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum -y install iptables-services <span style="color: #b22222;"># </span><span style="color: #b22222;">centos8&#19981;&#24314;&#35758;&#23433;&#35013;&#65292;&#21644;firewalld&#20914;&#31361;</span>
[root@centos8 ~]#cp /etc/sysconfig/iptables{,.bak}

&#8203;# &#20445;&#23384;&#29616;&#22312;&#30340;&#35268;&#21017;&#21040;&#25991;&#20214;&#20013;&#26041;&#27861;1
[root@centos8 ~]#/usr/libexec/iptables/iptables.init save

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20445;&#23384;&#29616;&#22312;&#30340;&#35268;&#21017;&#21040;&#25991;&#20214;&#20013;&#26041;&#27861;2</span>
[root@centos8 ~]#iptables-save &gt; /etc/sysconfig/iptables

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#26426;&#21551;&#21160;</span>
[root@centos8 ~]#systemctl enable iptables.service
[root@centos8 ~]#systemctl mask firewalld.service nftables.service
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-h:52fe8afa-e499-42b4-becc-7e55b77a174b" class="outline-4">
<h4 id="h:52fe8afa-e499-42b4-becc-7e55b77a174b">网络防火墙</h4>
<div class="outline-text-4" id="text-h:52fe8afa-e499-42b4-becc-7e55b77a174b">
<p>
iptables/netfilter 利用filter表的FORWARD链,可以充当网络防火墙：
</p>

<p>
注意的问题：
</p>
<ol class="org-ol">
<li>请求-响应报文均会经由FORWARD链，要注意规则的方向性</li>
<li>如果要启用conntrack机制，建议将双方向的状态为ESTABLISHED的报文直接放行</li>
</ol>
</div>
<div id="outline-container-h:8b5c1a05-da52-41c1-94bc-a4ed9778fb98" class="outline-5">
<h5 id="h:8b5c1a05-da52-41c1-94bc-a4ed9778fb98">FORWARD 链实现内外网络的流量控制</h5>
<div class="outline-text-5" id="text-h:8b5c1a05-da52-41c1-94bc-a4ed9778fb98">
<p>
范例: 实现内网访问可以访问外网,反之禁止
</p>


<figure id="org45a1ffe">
<img src="./images/image-20210217101112651.png" alt="image-20210217101112651.png">

</figure>

<p>
防火墙服务器firewall：eth0网卡 NAT网络 10.0.0.8/24，eth1网卡仅主机 192.168.0.8/24
</p>

<p>
公司外部服务器internet：eth0 仅主机 192.168.0.6/24 网关指定防火墙 192.168.0.8
</p>

<p>
公司内部服务器LanServer1：eth0 NAT网络 10.0.0.7/24 网关指定防火墙 10.0.0.8
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1.&#29615;&#22659;&#20934;&#22791;&#65292;&#30830;&#20445;&#27809;&#26377;&#38450;&#28779;&#22681;&#35268;&#21017;&#26102;&#21487;&#20197;&#20114;&#36890;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">internet&#20462;&#25913;eth0&#32593;&#21345;&#37197;&#32622; 192.168.0.6/24 &#32593;&#20851;&#25351;&#23450;&#38450;&#28779;&#22681; 192.168.0.8</span>
[root@internet ~]#hostname -I
192.168.0.6
[root@internet ~]#route -n
0.0.0.0     192.168.0.8   0.0.0.0     UG   0    0     0 eth0

<span style="color: #b22222;"># </span><span style="color: #b22222;">firewall &#20462;&#25913;&#32593;&#21345;&#37197;&#32622; eth0&#32593;&#21345;10.0.0.8/24&#19981;&#38656;&#35201;&#37197;&#32622;&#32593;&#20851;DNS&#65292;eth1 192.168.0.8/24&#19981;&#38656;&#35201;&#37197;&#32622;&#32593;&#20851;DNS&#65292; &#24320;&#21551;&#36335;&#30001;&#36716;&#21457;</span>
[root@firewall ~]#hostname -I
10.0.0.8 192.168.0.8
[root@firewall ~]#vim /etc/sysctl.conf
net.ipv4.ip_forward=1
[root@firewall ~]#sysctl -p

<span style="color: #b22222;"># </span><span style="color: #b22222;">LanServer1 &#20462;&#25913;&#32593;&#21345;&#37197;&#32622; eth0 10.0.0.7/24 &#32593;&#20851;&#25351;&#23450;&#38450;&#28779;&#22681; 10.0.0.8</span>
[root@lanserver1 ~]#hostname -I
10.0.0.7
[root@lanserver1 ~]#route -n
0.0.0.0     10.0.0.8     0.0.0.0     UG   100   0     0 eth0

[root@lanserver2 ~]#hostname -I
10.0.0.17
[root@lanserver2 ~]#route -n
0.0.0.0     10.0.0.8     0.0.0.0     UG   100   0     0 eth0

<span style="color: #b22222;"># </span><span style="color: #b22222;">2.&#37197;&#32622;&#38450;&#28779;&#22681;&#35268;&#21017;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1 &#36890;&#36807;&#26631;&#20934;&#27169;&#22359;&#23454;&#29616;&#20869;&#32593;&#35775;&#38382;&#22806;&#32593;,&#21453;&#20043;&#31105;&#27490;</span>
[root@firewall ~]#iptables -AFORWARD -j REJECT
[root@firewall ~]#iptables -IFORWARD -s 10.0.0.0/24 -p tcp --dport 80 -j ACCEPT        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#37096;&#35775;&#38382;&#22806;&#37096;http&#26381;&#21153;</span>
[root@firewall ~]#iptables -IFORWARD -d 10.0.0.0/24 -p tcp --sport 80 -j ACCEPT        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22806;&#37096;http&#26381;&#21153;&#21709;&#24212;&#20869;&#37096;</span>
[root@firewall ~]#iptables -I FORWARD  -s 10.0.0.0/24 -p icmp --icmp-type 8 -j ACCEPT  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#37096;&#35831;&#27714;&#21253;</span>
[root@firewall ~]#iptables -I FORWARD  -d 10.0.0.0/24 -p icmp --icmp-type 0 -j ACCEPT  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22806;&#37096;&#21709;&#24212;&#21253;</span>
[root@firewall ~]#iptables -vnL --line-numbers


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2 &#21033;&#29992;state&#27169;&#22359;&#23454;&#29616;&#20869;&#32593;&#35775;&#38382;&#21487;&#20197;&#35775;&#38382;&#22806;&#32593;,&#21453;&#20043;&#31105;&#27490;</span>
[root@firewall ~]#iptables -AFORWARD -j REJECT
[root@firewall ~]#iptables -I FORWARD  -s 10.0.0.0/24 -p icmp --icmp-type 8 -j ACCEPT  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#37096;&#35831;&#27714;&#21253;</span>
[root@firewall ~]#iptables -IFORWARD -s 10.0.0.0/24 -p tcp --dport 80 -j ACCEPT        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#37096;&#35775;&#38382;&#22806;&#37096;http&#26381;&#21153;</span>
[root@firewall ~]#iptables -IFORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22806;&#37096;&#21709;&#24212;&#30340;&#21253;&#37117;&#26159;ESTABLISHED</span>
[root@firewall ~]#iptables -vnL --line-numbers
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;</span>
[root@lanserver1 ~]#ping 192.168.0.6 -c1
64 bytes from 192.168.0.6: <span style="color: #a0522d;">icmp_seq</span>=1 <span style="color: #a0522d;">ttl</span>=63 <span style="color: #a0522d;">time</span>=2.20 ms
[root@lanserver2 ~]#curl 192.168.0.6
internet
[root@internet ~]#ping 10.0.0.7 -c1
From 192.168.0.8 <span style="color: #a0522d;">icmp_seq</span>=1 Destination Port Unreachable
[root@internet ~]#curl 10.0.0.7
curl: (7) couldn<span style="color: #8b2252;">'t connect to host</span>

<span style="color: #8b2252;">#&#21033;&#29992;state&#27169;&#22359;&#23454;&#29616;&#20801;&#35768;&#20869;&#32593;&#21487;&#20197;&#35775;&#38382;&#22806;&#32593;&#25152;&#26377;&#36164;&#28304;</span>
<span style="color: #8b2252;">[root@firewall ~]#iptables -AFORWARD -j REJECT</span>
<span style="color: #8b2252;">[root@firewall ~]#iptables -IFORWARD 2 -s 10.0.0.0/24 -m state --state NEW -j ACCEPT   #&#20869;&#37096;&#35831;&#27714;&#21253;</span>
<span style="color: #8b2252;">[root@firewall ~]#iptables -IFORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT    #&#22806;&#37096;&#21709;&#24212;&#30340;&#21253;&#37117;&#26159;ESTABLISHED</span>
<span style="color: #8b2252;">[root@firewall ~]#iptables -vnL --line-numbers</span>
<span style="color: #8b2252;">#&#39564;&#35777;</span>
<span style="color: #8b2252;">[root@lanserver1 ~]#ping 192.168.0.6 -c1</span>
<span style="color: #8b2252;">64 bytes from 192.168.0.6: icmp_seq=1 ttl=63 time=2.26 ms</span>
<span style="color: #8b2252;">[root@lanserver2 ~]#curl 192.168.0.6</span>
<span style="color: #8b2252;">internet</span>
<span style="color: #8b2252;">[root@lanserver2 ~]#ssh 192.168.0.6</span>
<span style="color: #8b2252;">Are you sure you want to continue connecting (yes/no)?</span>
<span style="color: #8b2252;">[root@internet ~]#curl 10.0.0.7</span>
<span style="color: #8b2252;">curl: (7) couldn'</span>t connect to host
[root@internet ~]#ping 10.0.0.7 -c1
From 192.168.0.8 <span style="color: #a0522d;">icmp_seq</span>=1 Destination Port Unreachable
[root@internet ~]#ssh 10.0.0.7
ssh: connect to host 10.0.0.7 port 22: Connection refused

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20801;&#35768;&#20869;&#32593;&#25351;&#23450;&#20027;&#26426;&#34987;&#22806;&#32593;&#35775;&#38382;</span>
[root@firewall ~]#iptables -IFORWARD 3 -d 10.0.0.7 -p tcp --dport 80 -j ACCEPT
[root@firewall ~]#iptables -vnL --line-numbers
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;</span>
[root@internet ~]#curl 10.0.0.7
lanserver1
[root@internet ~]#ping 10.0.0.7 -c1
From 192.168.0.8 <span style="color: #a0522d;">icmp_seq</span>=1 Destination Port Unreachable
[root@internet ~]#curl 10.0.0.17
curl: (7) couldn<span style="color: #8b2252;">'t connect to host</span>
</pre>
</div>

<p>
范例：内部可以访问外部，外部禁止访问内部
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@internet-host ~]#hostname -I
10.0.0.6
[root@internet-host ~]#route -n
Kernel IP routing table
Destination   Gateway     Genmask     Flags Metric Ref  Use Iface
10.0.0.0     0.0.0.0     255.255.255.0  U   1    0     0 eth0
0.0.0.0     10.0.0.8     0.0.0.0     UG   0    0     0 eth0

[root@firewall-host ~]#hostname -I
10.0.0.8 192.168.100.8

[root@lan-host ~]#hostname -I
192.168.100.7
[root@lan-host ~]#route -n
Kernel IP routing table
Destination   Gateway     Genmask     Flags Metric Ref  Use Iface
0.0.0.0     192.168.100.8  0.0.0.0     UG   100   0     0 eth0
192.168.100.0  0.0.0.0     255.255.255.0  U   100   0     0 eth0

[root@firewall-host ~]#vim /etc/sysctl.conf
net.ipv4.ip_forward=1
[root@firewall-host ~]#sysctl -p
[root@firewall-host ~]#iptables -A FORWARD -d 192.168.100.0/24 -m state --state NEW -j REJECT
</pre>
</div>

<p>
范例：针对内部的特定服务可以允许外部访问，其它服务禁止访问
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@firewall-host ~]#iptables -I FORWARD -d 192.168.100.0/24 -p tcp --dport 80 -j ACCEPT
[root@firewall-host ~]#iptables -vnL FORWARD --line-numbers
Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num  pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source       
destination    
1     6  486 ACCEPT   tcp  -- *   *    0.0.0.0/0     
 192.168.100.0/24   tcp dpt:80
2     3  228 REJECT   all  -- *   *    0.0.0.0/0     
 192.168.100.0/24   state NEW reject-with icmp-port-unreachable
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c1c8996c-9870-46a8-be4b-3a87a518b585" class="outline-5">
<h5 id="h:c1c8996c-9870-46a8-be4b-3a87a518b585">NAT 表</h5>
<div class="outline-text-5" id="text-h:c1c8996c-9870-46a8-be4b-3a87a518b585">
<p>
外部服务器网关是指向自己的网关而不是防火墙，且企业内部地址都是私有地址，因为没有到私有地址的路由，外部服务器无法访问内部服务器
</p>


<figure id="org9ad33d4">
<img src="images/image-20210217101157952.png" alt="image-20210217101157952.png">

</figure>

<p>
NAT: network address translation网络地址转换，支持PREROUTING，INPUT，
OUTPUT，POSTROUTING四个链
</p>

<p>
请求报文：修改源/目标IP，由定义如何修改
</p>

<p>
响应报文：修改源/目标IP，根据跟踪机制自动实现
</p>

<p>
NAT的实现分为下面类型：
</p>

<ul class="org-ul">
<li>SNAT：source NAT 源网络地址转换，支持POSTROUTING, INPUT，让本地网络
中的主机通过某一特定地址访问外部网络，实现地址伪装,请求报文：修改源
IP</li>
<li>DNAT：destination NAT 目标网络地址转换 支持PREROUTING , OUTPUT，把本
地网络中的主机上的某服务开放给外部网络访问(发布服务和端口映射)，但隐
藏真实IP,请求报文：修改目标IP</li>
<li>PNAT: port nat，端口和IP都进行修改</li>
</ul>

<p>
思考题:
</p>

<p>
在单位内部使用未经申请的公网地址,如:6.0.0.0/8网段,进行内部网络通讯,并
利用SNAT连接Internet,是否可以?
</p>
</div>
</div>
<div id="outline-container-h:68e0209f-eb6d-4edc-ab92-0ac30fcff4de" class="outline-5">
<h5 id="h:68e0209f-eb6d-4edc-ab92-0ac30fcff4de">SNAT</h5>
<div class="outline-text-5" id="text-h:68e0209f-eb6d-4edc-ab92-0ac30fcff4de">
<p>
SNAT：基于nat表的target，适用于固定的公网IP SNAT选项：
</p>

<pre class="example" id="org8907d9e">
--to-source [ipaddr[-ipaddr]][:port[-port]]
--random
</pre>

<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -A POSTROUTING -s LocalNET ! -d LocalNet -j SNAT --to-source ExtIP
</pre>
</div>

<p>
<b>注意: 需要开启 ip_forward</b>
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -A POSTROUTING -s 10.0.1.0/24 ! &#8211;d 10.0.1.0/24 -j SNAT --to-source 172.18.1.6-172.18.1.9
</pre>
</div>

<p>
MASQUERADE：基于nat表的target，适用于动态的公网IP，如：拨号网络
</p>

<p>
MASQUERADE选项：
</p>

<pre class="example" id="org1249018">
--to-ports port[-port]
--random
</pre>

<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -A POSTROUTING -s LocalNET ! -d LocalNet -j MASQUERADE
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -A POSTROUTING -s 10.0.1.0/24 ! &#8211;d 10.0.1.0/24 -j MASQUERADE
</pre>
</div>
</div>
<ul class="org-ul">
<li><a id="h:02d26416-32e1-482e-a652-3566853719d8"></a>查看本地主机访问公网时使用的IP<br>
<div class="outline-text-6" id="text-h:02d26416-32e1-482e-a652-3566853719d8">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#curl http://ip.sb
111.199.191.204
[root@centos8 ~]#curl http://ipinfo.io/ip/
111.199.191.204
[root@centos8 ~]#curl http://ifconfig.me
111.199.191.204
[root@centos8 ~]#curl -L http://tool.lu/ip
&#24403;&#21069;IP: 111.199.191.204
&#24402;&#23646;&#22320;: &#20013;&#22269; &#21271;&#20140; &#21271;&#20140;
[root@centos8 ~]#curl -sS --connect-timeout 10 -m 60
https://www.bt.cn/Api/getIpAddress
111.199.189.164[root@centos8 ~]#

[root@firewall ~]#curl cip.cc
IP : 39.164.140.134
&#22320;&#22336; : &#20013;&#22269; &#27827;&#21335; &#40548;&#22721;
&#36816;&#33829;&#21830; : &#31227;&#21160;
&#25968;&#25454;&#20108; : &#27827;&#21335;&#30465;&#37073;&#24030;&#24066; | &#31227;&#21160;
&#25968;&#25454;&#19977; :

URL : http://www.cip.cc/39.164.140.134
</pre>
</div>

<p>
范例: SNAT
</p>


<figure id="orgc6dd986">
<img src="images/image-20210217101236424.png" alt="image-20210217101236424.png">

</figure>

<p>
外部服务器网关是指向自己的网关而不是防火墙，且企业内部地址都是私有地址，因为没有到私有地址的路由，外部服务器无法访问内部服务器
</p>

<p>
防火墙服务器firewall ：eth0网卡 NAT网络 10.0.0.8/24，eth1网卡仅主机
192.168.0.8/24
</p>

<p>
公司外部服务器internet ：eth0 仅主机 192.168.0.6/24不需要配置网关，和
防火墙外网卡是可以通的
</p>

<p>
公司内部服务器LanServer1：eth0 NAT网络 10.0.0.7/24 网关指定防火墙
10.0.0.8
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1.&#29615;&#22659;&#20934;&#22791;&#65292;&#30830;&#20445;&#27809;&#26377;&#38450;&#28779;&#22681;&#35268;&#21017;&#26102;&#22806;&#32593;&#26381;&#21153;&#22120;internet&#21487;&#20197;ping&#36890;&#38450;&#28779;&#22681;&#65292;&#20869;&#37096;&#26381;&#21153;&#22120;ping&#19981;&#36890;&#22806;&#32593;&#26381;&#21153;&#22120;interne</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22806;&#32593;&#26381;&#21153;&#22120;internet&#20462;&#25913;eth0&#32593;&#21345;&#37197;&#32622; 192.168.0.6/24 &#19981;&#38656;&#35201;&#37197;&#32622;&#32593;&#20851;&#65292;&#21644;&#38450;&#28779;&#22681;&#22806;&#32593;&#21345;&#26159;&#21487;&#20197;&#36890;&#30340;</span>
[root@internet ~]#ping 192.168.0.8

<span style="color: #b22222;"># </span><span style="color: #b22222;">firewall &#20462;&#25913;&#32593;&#21345;&#37197;&#32622; eth0&#32593;&#21345;10.0.0.8/24&#19981;&#38656;&#35201;&#37197;&#32622;&#32593;&#20851;DNS&#65292;eth1 192.168.0.8/24&#19981;&#38656;&#35201;&#37197;&#32622;&#32593;&#20851;DNS&#65292; &#24320;&#21551;&#36335;&#30001;&#36716;&#21457;</span>
[root@firewall ~]#vim /etc/sysctl.conf
net.ipv4.ip_forward=1
[root@firewall ~]#sysctl -p

<span style="color: #b22222;"># </span><span style="color: #b22222;">LanServer1 &#20462;&#25913;&#32593;&#21345;&#37197;&#32622; eth0 10.0.0.7/24 &#32593;&#20851;&#25351;&#23450;&#38450;&#28779;&#22681; 10.0.0.8</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">2.&#37197;&#32622;&#38450;&#28779;&#22681;&#35268;&#21017;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1&#65306;&#38024;&#23545;&#19987;&#32447;&#38745;&#24577;&#20844;&#20849;IP</span>
[root@firewall ~]#iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -j SNAT --to-source 192.168.0.8  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20986;&#21475;&#65292;&#28304;&#22320;&#22336;&#21464;&#20026;192.168.0.8</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2&#65306;&#38024;&#23545;&#25320;&#21495;&#32593;&#32476;&#21644;&#19987;&#32447;&#38745;&#24577;&#20844;&#20849;IP</span>
[root@firewall ~]#iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -j MASQUERADE                    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20986;&#21475;&#65292;&#21160;&#24577;&#25214;ip</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#30417;&#21548;&#31471;&#21475;</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#32593;&#21487;&#20197;&#35775;&#38382;&#22806;&#32593;</span>
[root@lanserver1 ~]#curl 192.168.0.6
internet

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22806;&#32593;&#19981;&#21487;&#20197;&#35775;&#38382;&#20869;&#32593;</span>
[root@internet ~]#curl 10.0.0.7
curl: (7) Failed to connect to 10.0.0.7: Network is unreachable

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#22806;&#32593;&#26381;&#21153;&#22120;&#26597;&#30475;&#21040;&#26159;firewalld&#30340;&#22320;&#22336;&#22312;&#35775;&#38382;</span>
[root@internet ~]#tail -f /var/log/httpd/access_log <span style="color: #b22222;">#  </span><span style="color: #b22222;">&#65283;&#12288;&#35775;&#38382;&#26085;&#24535;&#20013;&#33021;&#30475;&#21040;firewalld&#30340;&#22320;&#22336;ip</span>
192.168.0.8 - - [08/Jul/2020:17:36:54 +0800] <span style="color: #8b2252;">"GET / HTTP/1.1"</span> 200 9 <span style="color: #8b2252;">"-"</span> <span style="color: #8b2252;">"curl/7.29.0"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#36716;&#25442;&#29366;&#24577;&#20449;&#24687;</span>
[root@firewall ~]#cat /proc/net/nf_conntrack
ipv4   2 tcp    6 112 TIME_WAIT <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=192.168.0.6 <span style="color: #a0522d;">sport</span>=58384
<span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=192.168.0.6 <span style="color: #a0522d;">dst</span>=192.168.0.8 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=58384 [ASSURED] <span style="color: #a0522d;">mark</span>=0
<span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:abb5c3ff-76b3-44e2-b789-5d14fc7a5ee9" class="outline-5">
<h5 id="h:abb5c3ff-76b3-44e2-b789-5d14fc7a5ee9">DNAT</h5>
<div class="outline-text-5" id="text-h:abb5c3ff-76b3-44e2-b789-5d14fc7a5ee9">
<p>
DNAT：nat表的target，适用于端口映射，即可重定向到本机，也可以支持重定
向至不同主机的不同端口，但不支持多目标，即不支持负载均衡功能
</p>

<p>
DNAT选项：
</p>

<pre class="example" id="org0e759d5">
--to-destination [ipaddr[-ipaddr]][:port[-port]]
</pre>

<div class="org-src-container">
<pre class="src src-sh">[root@firewall-host ~]#man iptables-extensions
--to-destination [ipaddr[-ipaddr]][:port[-port]]
&#21487;&#20197;&#25351;&#23450;&#20869;&#37096;&#21333;&#19968;ip&#65292;&#21487;&#20197;&#26377;&#31471;&#21475;&#33539;&#22260;&#12290;&#22914;&#26524;&#24819;&#23454;&#29616;&#22810;&#20010;&#20869;&#37096;ip,&#38656;&#35201;&#20869;&#26680;&#29256;&#26412;&#23567;&#20110; 2.6.11&#12290;&#22823;&#20110;&#36825;&#20010;&#29256;&#26412;&#26377;&#26356;&#22909;&#30340;&#26041;&#26696;LVS
&#160;which can specify a single new destination IP address, an inclusive range
of IP addresses. Optionally a port range, if the rule also specifies one of the
following protocols: tcp, udp, dccp or sctp. If no port range is specified,
<span style="color: #a020f0;">then</span> the destination port will never be modi-fied. If no IP address is specified
<span style="color: #a020f0;">then</span> only the destination port will be modified. In Ker-nels up to &#160;2.6.10
you can add several --to-destination options. For those kernels, if you specify
more than one destination address, either via an address range or multiple &#160;--
to-des-tination options, a simple round-robin (one after another<span style="color: #a020f0;"> in</span> cycle)
load balancing takes place between these addresses. Later Kernels (&gt;= 2.6.11-
rc1) don<span style="color: #8b2252;">'t have the ability to NAT to multiple ranges anymore.</span>
</pre>
</div>

<p>
DNAT 格式:
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -A PREROUTING -d ExtIP -p tcp|udp --dport PORT -j DNAT --to-destination InterSeverIP[:PORT]
</pre>
</div>

<p>
<b>注意: 需要开启 ip_forward</b>
</p>

<p>
范例: DNAT
</p>


<figure id="org511ffb0">
<img src="images/image-20210217101313496.png" alt="image-20210217101313496.png">

</figure>

<p>
外部服务器网关是指向自己的网关而不是防火墙，且企业内部地址都是私有地址，
因为没有到私有地址的路由，外部服务器无法访问内部服务器
</p>

<p>
防火墙服务器firewall ：eth0网卡 NAT网络 10.0.0.8/24，eth1网卡仅主机
192.168.0.8/24
</p>

<p>
公司外部服务器internet ：eth0 仅主机 192.168.0.6/24不需要配置网关，和
防火墙外网卡是可以通的
</p>

<p>
公司内部服务器LanServer1：eth0 NAT网络 10.0.0.7/24 网关指定防火墙
10.0.0.8
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1.&#29615;&#22659;&#20934;&#22791;&#65292;&#30830;&#20445;&#27809;&#26377;&#38450;&#28779;&#22681;&#35268;&#21017;&#26102;&#22806;&#32593;&#26381;&#21153;&#22120;internet&#21487;&#20197;ping&#36890;&#38450;&#28779;&#22681;&#65292;&#20869;&#37096;&#26381;&#21153;&#22120;ping&#19981;&#36890;&#22806;&#32593;&#26381;&#21153;&#22120;interne</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22806;&#32593;&#26381;&#21153;&#22120;internet&#20462;&#25913;eth0&#32593;&#21345;&#37197;&#32622; 192.168.0.6/24 &#19981;&#38656;&#35201;&#37197;&#32622;&#32593;&#20851;&#65292;&#21644;&#38450;&#28779;&#22681;&#22806;&#32593;&#21345;&#26159;&#21487;&#20197;&#36890;&#30340;</span>
[root@internet ~]#ping 192.168.0.8

<span style="color: #b22222;"># </span><span style="color: #b22222;">firewall &#20462;&#25913;&#32593;&#21345;&#37197;&#32622; eth0&#32593;&#21345;10.0.0.8/24&#19981;&#38656;&#35201;&#37197;&#32622;&#32593;&#20851;DNS&#65292;eth1 192.168.0.8/24&#19981;&#38656;&#35201;&#37197;&#32622;&#32593;&#20851;DNS&#65292; &#24320;&#21551;&#36335;&#30001;&#36716;&#21457;</span>
[root@firewall ~]#vim /etc/sysctl.conf
net.ipv4.ip_forward=1
[root@firewall ~]#sysctl -p

<span style="color: #b22222;"># </span><span style="color: #b22222;">LanServer1 &#20462;&#25913;&#32593;&#21345;&#37197;&#32622; eth0 10.0.0.7/24 &#32593;&#20851;&#25351;&#23450;&#38450;&#28779;&#22681; 10.0.0.8</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">2.&#37197;&#32622;&#38450;&#28779;&#22681;&#35268;&#21017;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22806;&#37096;&#35775;&#38382;&#38450;&#28779;&#22681;&#30340;80&#31471;&#21475;&#36716;&#21457;&#21040;&#20869;&#37096;ip &#30340;8080&#31471;&#21475;</span>
[root@firewall ~]#iptables -t nat -A PREROUTING -d 192.168.0.8 -p tcp --dport 80 -j DNAT --to-destination 10.0.0.7:8080

[root@internet ~]#curl 192.168.0.8
lanserver1
[root@lanserver1 ~]#tail /var/log/httpd/access_log &#65283;&#12288;&#35775;&#38382;&#26085;&#24535;&#20013;&#33021;&#30475;&#21040;&#30495;&#27491;&#30340;&#23458;&#25143;ip
192.168.0.6 - - [08/Jul/2020:18:10:37 +0800] <span style="color: #8b2252;">"GET / HTTP/1.1"</span> 200 11 <span style="color: #8b2252;">"-"</span>
<span style="color: #8b2252;">"curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3</span>
<span style="color: #8b2252;">libidn/1.18 libssh2/1.4.2"</span>

[root@firewall ~]#cat /proc/net/nf_conntrack
ipv4   2 tcp    6 117 TIME_WAIT <span style="color: #a0522d;">src</span>=192.168.0.6 <span style="color: #a0522d;">dst</span>=192.168.0.8 <span style="color: #a0522d;">sport</span>=58170
<span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=10.0.0.7 <span style="color: #a0522d;">dst</span>=192.168.0.6 <span style="color: #a0522d;">sport</span>=8080 <span style="color: #a0522d;">dport</span>=58170 [ASSURED] <span style="color: #a0522d;">mark</span>=0
<span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -A PREROUTING -s 0/0 -d 172.18.100.6 -p tcp --dport 22 -j DNAT --to-destination 10.0.1.22
iptables -t nat -A PREROUTING -s 0/0 -d 172.18.100.6 -p tcp --dport 80 -j DNAT --to-destination 10.0.1.22:8080
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@firewall-host ~]#iptables -t nat -A PREROUTING -d 10.0.0.8 -p tcp --dport 80 -j DNAT --to-destination 192.168.100.7
[root@firewall-host ~]#iptables -t nat -vnL PREROUTING
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source        destination

  0   0 DNAT    tcp  -- *   *    0.0.0.0/0       10.0.0.8  
    tcp dpt:80 to:192.168.100.7
[root@firewall-host ~]#ss -ntl
State    Recv-Q    Send-Q         Local Address:Port      
  Peer Address:Port    
LISTEN    0       128              0.0.0.0:22       
     0.0.0.0:*     
LISTEN    0       128               [::]:22       
[::]:*

[root@internet-host ~]#curl 10.0.0.8
lan server
[root@internet-host ~]#telnet 10.0.0.8
Trying 10.0.0.8...
telnet: connect to address 10.0.0.8: Connection refused

[root@lan-host ~]#tail -f /var/log/httpd/access_log
10.0.0.6 - - [21/Mar/2020:17:32:37 +0800] <span style="color: #8b2252;">"GET / HTTP/1.1"</span> 200 11 <span style="color: #8b2252;">"-"</span>
<span style="color: #8b2252;">"curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.27.1 zlib/1.2.3</span>
<span style="color: #8b2252;">libidn/1.18 libssh2/1.4.2"</span>

[root@firewall-host ~]#tail -f /proc/net/nf_conntrack
ipv4   2 tcp    6 81 TIME_WAIT <span style="color: #a0522d;">src</span>=10.0.0.6 <span style="color: #a0522d;">dst</span>=10.0.0.8 <span style="color: #a0522d;">sport</span>=59426
<span style="color: #a0522d;">dport</span>=80 <span style="color: #a0522d;">src</span>=192.168.100.7 <span style="color: #a0522d;">dst</span>=10.0.0.6 <span style="color: #a0522d;">sport</span>=80 <span style="color: #a0522d;">dport</span>=59426 [ASSURED] <span style="color: #a0522d;">mark</span>=0
<span style="color: #a0522d;">zone</span>=0 <span style="color: #a0522d;">use</span>=2

[root@lan-host ~]#vim /etc/httpd/conf/httpd.conf
listen 8000
[root@lan-host ~]#systemctl restart httpd
[root@lan-host ~]#ss -ntl
State   Recv-Q Send-Q     Local Address:Port            
Peer Address:Port       
LISTEN   0    100         127.0.0.1:25               
   *:*         
LISTEN   0    128             *:22               
   *:*         
LISTEN   0    128           [::]:23               
[::]:*
LISTEN   0    100           [::1]:25               
[::]:*
LISTEN   0    128           [::]:8000              
[::]:*
LISTEN   0    128           [::]:22               
[::]:*

[root@firewall-host ~]#iptables -t nat -R PREROUTING 1 -d 10.0.0.8 -p tcp --dport 80 -j DNAT --to-destination 192.168.100.7:8000
[root@firewall-host ~]#iptables -t nat -vnL
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source        destination

  0   0 DNAT    tcp  -- *   *    0.0.0.0/0       10.0.0.8  
    tcp dpt:80 to:192.168.100.7:8000
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source        destination

Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target   prot opt<span style="color: #a020f0;"> in</span>   out   source        destination
</pre>
</div>

<p>
<b>综合案例: 两个私网的互通</b>
</p>


<figure id="org4347258">
<img src="images/image-20210217101332467.png" alt="image-20210217101332467.png">

</figure>

<p>
两边都是私网地址实现，左边访问右边时，前面防火墙1 SNAT，后面防火墙 2
DNAT；反过来右边回应左边，前面防火墙2 SNAT，后面防火墙1 DNAT。
</p>

<p>
VPN实际上用的就是这种逻辑，它还可以加密
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20844;&#32593;ip 10.0.0.8  10.0.0.18</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24038;&#36793;</span>
iptables -t nat -A PREROUTING  -d 10.0.0.8  -j DNAT --to-destination 192.168.0.8  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35775;&#38382;&#36827;&#26469;&#26102;&#65292;&#30446;&#26631;&#20844;&#32593;ip&#21464;&#20026;&#20869;&#37096;ip</span>
iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j SNAT --to-source 10.0.0.8     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35775;&#38382;&#20986;&#21475;&#26102;&#65292;&#30446;&#26631;&#20869;&#37096;ip&#21464;&#20026;&#20844;&#32593;ip</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21491;&#36793;</span>
iptables -t nat -A PREROUTING  -d 10.0.0.18  -j DNAT --to-destination 172.16.0.18  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35775;&#38382;&#36827;&#26469;&#26102;&#65292;&#30446;&#26631;&#20844;&#32593;ip&#21464;&#20026;&#20869;&#37096;ip</span>
iptables -t nat -A POSTROUTING -s 172.16.0.0/24 -j SNAT --to-source 10.0.0.18     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35775;&#38382;&#20986;&#21475;&#26102;&#65292;&#30446;&#26631;&#20869;&#37096;ip&#21464;&#20026;&#20844;&#32593;ip</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:72073f97-3e2d-43c8-a08c-01d8ffdb2804" class="outline-5">
<h5 id="h:72073f97-3e2d-43c8-a08c-01d8ffdb2804">REDIRECT 转发(端口转发)</h5>
<div class="outline-text-5" id="text-h:72073f97-3e2d-43c8-a08c-01d8ffdb2804">
<p>
REDIRECT，是NAT表的target，通过改变目标IP和端口，将接受的包转发至同一
个主机的不同端口，可用于PREROUTING OUTPUT链 REDIRECT选项：
</p>

<pre class="example" id="org0338e01">
--to-ports port[-port]
</pre>

<p>
<b>注意: 无需开启 ip_forward</b>
</p>

<p>
范例：访问本机172.16.100.10的80端口，转发为本机8080
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -t nat -A PREROUTING -d 172.16.100.10 -p tcp --dport 80 -j REDIRECT --to-ports 8080
</pre>
</div>

<p>
范例：访问本机8000端口，转发为本机80
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@lan-host ~]#iptables -t nat -A PREROUTING -p tcp --dport 8000 -j REDIRECT --to-ports 80
[root@lan-host ~]#ss -ntl                     <span style="color: #b22222;"># </span><span style="color: #b22222;">iptable&#26159;&#20869;&#26680;&#32423;&#21151;&#33021;&#30340;&#65292;&#24212;&#29992;&#31243;&#24207;&#25165;&#30417;&#21548;&#31471;&#21475;</span>
[root@lan-host ~]#iptables -vnL -t nat
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:732ceb41-99c3-4ce8-aa77-5056b0108851" class="outline-4">
<h4 id="h:732ceb41-99c3-4ce8-aa77-5056b0108851">实战案例：</h4>
<div class="outline-text-4" id="text-h:732ceb41-99c3-4ce8-aa77-5056b0108851">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26657;&#21306;&#30340;&#38450;&#28779;&#22681;&#37197;&#32622;&#35774;&#32622;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Generated by iptables-save v1.4.7 on Wed May 18 09:22:34 2016</span>
*filter
:INPUT ACCEPT [85890:4530430]
:FORWARD ACCEPT [76814:55698470]
:OUTPUT ACCEPT [166620:238017546]
-A FORWARD -s 172.16.0.100/32 -j ACCEPT  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20248;&#20808;&#32769;&#24072;&#30340;&#26426;&#22120;&#21487;&#19978;&#32593;</span>
-A FORWARD -s 172.16.0.200/32 -j ACCEPT
-A FORWARD -s 172.16.0.67/32 -j ACCEPT
<span style="color: #b22222;">#</span><span style="color: #b22222;">WANG &#160;ADD NEXT LINE IN 20170627</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.16.0.0/16 -j ACCEPT</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">WANG &#160;ADD NEXT LINE IN 20170704</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.18.0.0/16 -j ACCEPT</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.18.0.0/16 -j REJECT</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.16.0.68/32 -j ACCEPT</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.16.0.69/32 -j ACCEPT</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.16.0.6/32 -j ACCEPT</span>
-A FORWARD -s 172.17.200.200/32 -j ACCEPT
-A FORWARD -s 172.17.136.136/32 -j ACCEPT
-A FORWARD -s 172.17.0.100/32 -j ACCEPT
-A FORWARD -s 172.18.100.1/32 -j ACCEPT
-A FORWARD -s 172.18.0.100/32 -j ACCEPT
-A FORWARD -s 172.18.200.2/32 -j ACCEPT
-A FORWARD -s 172.18.200.3/32 -j ACCEPT
-A FORWARD -s 172.18.211.211/32 -j ACCEPT
-A FORWARD -s 172.18.212.212/32 -j ACCEPT
-A FORWARD -m iprange --src-range 172.16.0.100-172.16.0.110 -j ACCEPT  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25945;&#23398;&#26426;&#22120;</span>
-A FORWARD -m iprange --src-range 172.17.0.100-172.17.0.110 -j ACCEPT
-A FORWARD -m iprange --src-range 172.18.0.100-172.18.0.110 -j ACCEPT
-A FORWARD -m iprange --src-range 172.17.100.6-172.17.100.16 -j ACCEPT
-A FORWARD -m iprange --src-range 172.18.100.61-172.18.100.70 -j ACCEPT
-A FORWARD -s 172.16.0.0/16 -m string --string <span style="color: #8b2252;">"verycd.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38480;&#21046;&#32593;&#31449;&#35775;&#38382;</span>
-A FORWARD -s 172.16.0.0/16 -m string --string <span style="color: #8b2252;">"tudou.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.16.0.0/16 -m string --string <span style="color: #8b2252;">"youku.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.16.0.0/16 -m string --string <span style="color: #8b2252;">"iqiyi.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.16.0.0/16 -m string --string <span style="color: #8b2252;">"pptv.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.16.0.0/16 -m string --string <span style="color: #8b2252;">"letv.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.16.0.0/16 -m string --string <span style="color: #8b2252;">"xunlei.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.18.0.0/16 -m string --string <span style="color: #8b2252;">"verycd.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.18.0.0/16 -m string --string <span style="color: #8b2252;">"tudou.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.18.0.0/16 -m string --string <span style="color: #8b2252;">"youku.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.18.0.0/16 -m string --string <span style="color: #8b2252;">"iqiyi.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.18.0.0/16 -m string --string <span style="color: #8b2252;">"pptv.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.18.0.0/16 -m string --string <span style="color: #8b2252;">"letv.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.18.0.0/16 -m string --string <span style="color: #8b2252;">"xunlei.com"</span> --algo kmp --to 65535 -j REJECT --reject-with icmp-port-unreachable
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.18.0.0/16 -j REJECT</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.16.0.0/16 -j REJECT</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -i ppp0 -m string --string ".exe" --algo bm --to 65535 -j REJECT --reject-with icmp-port-unreachable</span>
-A FORWARD -s 172.18.0.0/16 -m time --timestart 08:50:00 --timestop 18:00:00 --weekdays Mon,Wed,Fri &#160;--datestop 2038-01-19T11:14:07 -j REJECT --reject-with icmp-port-unreachable <span style="color: #b22222;"># </span><span style="color: #b22222;">centos6&#30452;&#25509;&#29992;&#30340;&#24403;&#22320;&#26102;&#38388;&#65292;&#19981;&#38656;&#35201;-8&#23567;&#26102;&#12290;&#21608;1&#65292;3&#65292;5&#19981;&#33021;&#19978;&#32593;</span>
-A FORWARD -s 172.17.0.0/16 -m time --timestart 08:50:00 --timestop 18:00:00 --weekdays Mon,Wed,Fri &#160;--datestop 2038-01-19T11:14:07 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.16.0.0/16 -m time --timestart 08:50:00 --timestop 12:30:00 --weekdays Tue,Thu,Sat &#160;--datestop 2038-01-19T11:14:07 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -s 172.16.0.0/16 -m time --timestart 13:50:00 --timestop 18:00:00 --weekdays Tue,Thu,Sat &#160;--datestop 2038-01-19T11:14:07 -j REJECT --reject-with icmp-port-unreachable
<span style="color: #b22222;">#</span><span style="color: #b22222;">wang next 2 lines changed in 20170619</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.17.0.0/16 -m time --timestart 08:50:00 --timestop 12:30:00 --weekdays Mon,Wed,Fri --datestop 2038-01-19T11:14:07 -j REJECT --reject-with icmp-port-unreachable</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.17.0.0/16 -m time --timestart 13:30:00 --timestop 18:10:00 --weekdays Mon,Wed,Fri --datestop 2038-01-19T11:14:07 -j REJECT --reject-with icmp-port-unreachable</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.18.0.0/16 -m time --timestart 08:50:00 --timestop 18:10:00 --weekdays Mon,Wed,Fri --datestop 2038-01-19T11:14:07 -j REJECT --reject-with icmp-port-unreachable</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A FORWARD -s 172.18.0.0/16 -m time --timestart 08:50:00 --timestop 18:10:00 --weekdays Tue,Thu --datestop 2038-01-19T11:14:07 -j REJECT --reject-with icmp-port-unreachable</span>
COMMIT
<span style="color: #b22222;"># </span><span style="color: #b22222;">Completed on Wed May 18 09:22:34 2016</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Generated by iptables-save v1.4.7 on Wed May 18 09:22:34 2016</span>
*nat
:PREROUTING ACCEPT [1429833:65427211]
:POSTROUTING ACCEPT [850518:35452195]
:OUTPUT ACCEPT [120198:9146655]
-A POSTROUTING -s 172.16.0.100/32 -j MASQUERADE
-A POSTROUTING -s 172.18.0.100/32 -j MASQUERADE
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A POSTROUTING -s 172.16.0.200/32 -j MASQUERADE</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">wang add next 1 line in 20170619</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">wang add next 1 line in 20170704</span>
-A POSTROUTING -s 172.16.0.69/32 -j MASQUERADE
-A POSTROUTING -s 172.17.200.200/32 -j MASQUERADE
-A POSTROUTING -s 172.17.136.136/32 -j MASQUERADE
-A POSTROUTING -s 172.17.0.100/32 -j MASQUERADE
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A POSTROUTING -s 172.18.0.0/16 -j MASQUERADE</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-A POSTROUTING -s 172.16.0.6/32 -j MASQUERADE</span>
-A POSTROUTING -m iprange --src-range 172.16.0.100-172.16.0.110 -j MASQUERADE
-A POSTROUTING -m iprange --src-range 172.17.0.100-172.17.0.110 -j MASQUERADE
-A POSTROUTING -m iprange --src-range 172.18.0.100-172.18.0.110 -j MASQUERADE
-A POSTROUTING -s 172.16.0.0/16 -p tcp -m multiport --dports 80,443,53,22,6666 -j MASQUERADE  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21482;&#33021;&#35775;&#38382;&#20844;&#32593;&#29305;&#23450;&#31471;&#21475;</span>
-A POSTROUTING -s 172.16.0.0/16 -p udp -m multiport --dports 22 -j MASQUERADE
-A POSTROUTING -s 172.17.0.0/16 -p tcp -m multiport --dports 80,443,53,22,6666 -j MASQUERADE
-A POSTROUTING -s 172.17.0.0/16 -p udp -m multiport --dports 22 -j MASQUERADE
-A POSTROUTING -s 172.18.0.0/16 -p tcp -m multiport --dports 80,443,53,22,6666,1206,5938,1949 -j MASQUERADE
-A POSTROUTING -s 172.18.0.0/16 -p udp -m multiport --dports 22,1206,5938,1949 -j MASQUERADE
COMMIT
<span style="color: #b22222;"># </span><span style="color: #b22222;">Completed on Wed May 18 09:22:34 2016</span>

<span style="color: #b22222;">#########</span><span style="color: #b22222;">&#20844;&#21496;</span>
[root@vpn-01 ~]# vim /etc/sysconfig/iptables

<span style="color: #b22222;"># </span><span style="color: #b22222;">Generated by iptables-save v1.4.21 on Tue Dec  4 15:23:47 2018</span>
*nat
:PREROUTING ACCEPT [1031964:60474614]
:INPUT ACCEPT [1030599:60368281]
:OUTPUT ACCEPT [39560:2705379]
:POSTROUTING ACCEPT [39701:2721808]
-A POSTROUTING -s 192.168.123.0/24 -j MASQUERADE
COMMIT
<span style="color: #b22222;"># </span><span style="color: #b22222;">Completed on Tue Dec  4 15:23:47 2018</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Generated by iptables-save v1.4.21 on Tue Dec  4 15:23:47 2018</span>
*filter
:INPUT ACCEPT [102:6792]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [86:6259]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -s 172.16.0.0/16 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 10022 -j ACCEPT
-A INPUT -p udp --dport 10086 -j ACCEPT
-A INPUT -p tcp --dport 9000:9010 -j ACCEPT
-A INPUT -p tcp --dport 11223 -j ACCEPT
-A INPUT -m state --state INVALID,NEW -j DROP

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31616;&#21333;&#35828;&#65292;&#20801;&#35768;&#25968;&#25454;&#20174;&#23458;&#25143;&#31471;&#21040;&#21518;&#31471;server</span>
-A FORWARD -i tun0 -s 192.168.123.0/24 -j ACCEPT
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20801;&#35768;&#25968;&#25454;&#20174;&#21518;&#31471;server&#21040;&#23458;&#25143;&#31471;</span>
-A FORWARD -i eth0 -d 192.168.123.0/24 -j ACCEPT
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
<span style="color: #b22222;"># </span><span style="color: #b22222;">Completed on Tue Dec  4 15:23:47 2018</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e294b82d-64ce-41cf-9334-9ec02af8bab9" class="outline-4">
<h4 id="h:e294b82d-64ce-41cf-9334-9ec02af8bab9">iptables实现七层访问过滤</h4>
<div class="outline-text-4" id="text-h:e294b82d-64ce-41cf-9334-9ec02af8bab9">
<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1&#12289;&#33719;&#21462;&#24182;&#32534;&#35793;&#20869;&#26680;</span>
useradd mockbuild
rpm -ivh kernel-2.6.32-431.5.1.x86_64.el6.src.rpm
<span style="color: #483d8b;">cd</span> rpmbuild/SOURCES
tar linux-2.6.32-*.tar.gz -C /usr/src
<span style="color: #483d8b;">cd</span> /usr/src
ln -sv 

<span style="color: #b22222;">#</span><span style="color: #b22222;">2&#12289;&#32473;&#20869;&#26680;&#25171;&#34917;&#19969;</span>
tar xf netfilter-layer7-v2.23.tar.bz2
<span style="color: #483d8b;">cd</span> /usr/src/linux
patch -p1 &lt; /root/netfilter-layer7-v2.23/kernel-2.6.32-layer7-2.23.patch
cp /boot/config-*  .config
make menuconfig

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25353;&#22914;&#19979;&#27493;&#39588;&#21551;&#29992;layer7&#27169;&#22359;        </span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">Networking support &#8594; Networking Options &#8594;Network packet filtering framework &#8594; Core Netfilter Configuration</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&lt;M&gt;  &#8220;layer7&#8221; match support</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">3&#12289;&#32534;&#35793;&#24182;&#23433;&#35013;&#20869;&#26680;</span>
make -j <span style="color: #b22222;">#</span>
make modules_install
make install
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#31034;&#65306;xt_layer7.ko&#20381;&#36182;&#20110;nf_conntrack.ko&#27169;&#22359;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">4&#12289;&#37325;&#21551;&#31995;&#32479;&#65292;&#21551;&#29992;&#26032;&#20869;&#26680;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">5&#12289;&#32534;&#35793;iptables</span>
tar xf iptables-1.4.20.tar.gz
cp /root/netfilter-layer7-v2.23/iptables-1.4.3forward-for-kernel-2.6.20forward/* /root/iptables-1.4.20/extensions/
cp /etc/rc.d/init.d/iptales /root
cp /etc/sysconfig/iptables-config /root
rpm -e iptables iptables-ipv6 --nodeps
./configure  --prefix=/usr  --with-ksource=/usr/src/linux
make &amp;&amp; make install

cp /root/iptables /etc/rc.d/init.d
cp /root/iptables-config /etc/sysconfig

<span style="color: #b22222;">#</span><span style="color: #b22222;">6&#12289;&#20026;layer7&#27169;&#22359;&#25552;&#20379;&#20854;&#25152;&#35782;&#21035;&#30340;&#21327;&#35758;&#30340;&#29305;&#24449;&#30721;</span>
tar zxvf l7-protocols-2009-05-28.tar.gz
<span style="color: #483d8b;">cd</span> l7-protocols-2009-05-28
make install        

7&#12289;&#22914;&#20309;&#20351;&#29992;layer7&#27169;&#22359;
<span style="color: #b22222;">#</span><span style="color: #b22222;">ACCT&#30340;&#21151;&#33021;&#24050;&#32463;&#21487;&#20197;&#22312;&#20869;&#26680;&#21442;&#25968;&#20013;&#25353;&#38656;&#21551;&#29992;&#25110;&#31105;&#29992;&#12290;&#27492;&#21442;&#25968;&#38656;&#35201;&#35013;&#36733;nf_conntrack&#27169;&#22359;&#21518;&#26041;&#33021;&#29983;&#25928;&#12290;</span>
net.netfilter.nf_conntrack_acct = 1

<span style="color: #b22222;">#</span><span style="color: #b22222;">l7-filter uses the standard iptables extension syntax </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">iptables [specify table &amp; chain] -m layer7 --l7proto [protocol name] -j [action] </span>
iptables -A FORWARD -m layer7 --l7proto qq -j REJECT
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ed0b7ea4-d0af-463c-a5c6-0e23dfb136fc" class="outline-3">
<h3 id="h:ed0b7ea4-d0af-463c-a5c6-0e23dfb136fc">firewalld服务</h3>
<div class="outline-text-3" id="text-h:ed0b7ea4-d0af-463c-a5c6-0e23dfb136fc">
</div>
<div id="outline-container-h:39899c40-ec8b-42fd-933d-3c02d0956a6e" class="outline-4">
<h4 id="h:39899c40-ec8b-42fd-933d-3c02d0956a6e">firewalld 介绍</h4>
<div class="outline-text-4" id="text-h:39899c40-ec8b-42fd-933d-3c02d0956a6e">
<p>
过渡软件，了解就行，推荐使用nftables
</p>

<p>
firewalld是CentOS 7.0新推出的管理netfilter的用户空间软件工具
</p>

<p>
firewalld是配置和监控防火墙规则的系统守护进程。可以实iptables,ip6tables,ebtables的功能
</p>

<p>
firewalld服务由firewalld包提供
</p>

<p>
firewalld支持划分区域zone,每个zone可以设置独立的防火墙规则
</p>

<p>
<b>归入zone顺序：</b>
</p>

<ul class="org-ul">
<li>先根据数据包中源地址，将其纳为某个zone</li>
<li>纳为网络接口所属zone</li>
<li>纳入默认zone，默认为public zone,管理员可以改为其它zone</li>
<li>网卡默认属于public zone,lo网络接口属于trusted zone</li>
</ul>

<p>
<b>firewalld zone 分类</b>
</p>

<pre class="example" id="orgee99c18">
zone名称  默认配置
trusted  ：允许所有流量
home     ：拒绝除和传出流量相关的，以及ssh,mdsn,ipp-client,samba-client,dhcpv6-client预定义服务之外其它所有传入流量
internal ：和home相同
work     ：拒绝除和传出流量相关的，以及ssh,ipp-client,dhcpv6-client预定义服务之外的其它所有传入流量
public   ：拒绝除和传出流量相关的，以及ssh,dhcpv6-client预定义服务之外的其它所有传入流量，新加的网卡默认属于public zone
external ：拒绝除和传出流量相关的，以及ssh预定义服务之外的其它所有传入流量，属于external zone的传出ipv4流量的源地址将被伪装为传出网卡的地址。
dmz      ：拒绝除和传出流量相关的，以及ssh预定义服务之外的其它所有传入流量
block    ：拒绝除和传出流量相关的所有传入流量
drop     ：拒绝除和传出流量相关的所有传入流量（甚至不以ICMP错误进行回应）
</pre>

<p>
<b>预定义服务</b>
</p>

<pre class="example" id="org12e23ba">
服务名称  配置
ssh           : Local SSH server. Traffic to 22/tcp
dhcpv6-client : Local DHCPv6 client. Traffic to 546/udp on the fe80::/64 IPv6 network
ipp-client    : Local IPP printing. Traffic to 631/udp.
samba-client  : Local Windows file and print sharing client. Traffic to 137/udp and 138/udp.
mdns          : Multicast DNS (mDNS) local-link name resolution. Traffic to 5353/udp to the 224.0.0.251 (IPv4) or ff02::fb (IPv6) multicast addresses.
</pre>

<p>
firewalld预定义服务配置
</p>

<ul class="org-ul">
<li>firewall-cmd &#x2013;get-services 查看预定义服务列表</li>
<li>/usr/lib/firewalld/services/*.xml预定义服务的配置</li>
</ul>

<p>
firewalld 三种配置方法
</p>

<ul class="org-ul">
<li>firewall-config 图形工具: 需安装 firewall-config包</li>
<li>firewall-cmd 命令行工具: firewalld包,默认安装</li>
<li>/etc/firewalld/配置文件，一般不建议,如:/etc/firewalld/zones/public.xml</li>
</ul>
</div>
</div>
<div id="outline-container-h:fef90433-dfbb-44ec-982e-3e3332aeebae" class="outline-4">
<h4 id="h:fef90433-dfbb-44ec-982e-3e3332aeebae">firewall-cmd 命令</h4>
<div class="outline-text-4" id="text-h:fef90433-dfbb-44ec-982e-3e3332aeebae">
<p>
firewall-cmd 格式
</p>

<pre class="example" id="org05f633b">
Usage: firewall-cmd [OPTIONS...]
</pre>

<p>
常见选项
</p>

<pre class="example" id="orgc8305a2">
--get-service 查看有哪些服务
--get-zones 列出所有可用区域
--get-default-zone 查询默认区域
--set-default-zone=&lt;ZONE&gt; 设置默认区域
--get-active-zones 列出当前正使用的区域
--add-source=&lt;CIDR&gt;[--zone=&lt;ZONE&gt;] 添加源地址的流量到指定区域，如果无--zone= 选项，使用默认区域
--remove-source=&lt;CIDR&gt; [--zone=&lt;ZONE&gt;] 从指定区域删除源地址的流量，如无--zone= 选项，使用默认区域
--add-interface=&lt;INTERFACE&gt;[--zone=&lt;ZONE&gt;] 添加来自于指定接口的流量到特定区域，如果无--zone= 选项，使用默认区域
--change-interface=&lt;INTERFACE&gt;[--zone=&lt;ZONE&gt;] 改变指定接口至新的区域，如果无--zone=选项，使用默认区域
--add-service=&lt;SERVICE&gt; [--zone=&lt;ZONE&gt;] 允许服务的流量通过，如果无--zone= 选项，使用默认区域
--add-port=&lt;PORT/PROTOCOL&gt;[--zone=&lt;ZONE&gt;] 允许指定端口和协议的流量，如果无--zone= 选项，使用默认区域
--remove-service=&lt;SERVICE&gt; [--zone=&lt;ZONE&gt;] 从区域中删除指定服务，禁止该服务流量，如果无--zone= 选项，使用默认区域
--remove-port=&lt;PORT/PROTOCOL&gt;[--zone=&lt;ZONE&gt;] 从区域中删除指定端口和协议，禁止该端口的流量，如果无--zone= 选项，使用默认区域
--reload 删除当前运行时配置，应用加载永久配置
--list-services 查看开放的服务
--list-ports  查看开放的端口
--list-all [--zone=&lt;ZONE&gt;] 列出指定区域的所有配置信息，包括接口，源地址，端口，服务等，如果无--zone= 选项，使用默认区域
</pre>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#40664;&#35748;zone</span>
firewall-cmd --get-default-zone
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;zone&#35774;&#20026;dmz</span>
firewall-cmd --set-default-zone=dmz
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;internal zone&#20013;&#22686;&#21152;&#28304;&#22320;&#22336;192.168.0.0/24&#30340;&#27704;&#20037;&#35268;&#21017;</span>
firewall-cmd --permanent --zone=internal &#160;--add-source=192.168.0.0/24
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;internal zone&#20013;&#22686;&#21152;&#21327;&#35758;mysql&#30340;&#27704;&#20037;&#35268;&#21017;</span>
firewall-cmd --permanent --zone=internal &#160;--add-service=mysql
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#36733;&#26032;&#35268;&#21017;&#20197;&#29983;&#25928;</span>
firewall-cmd &#160;--reload

[root@centos8 ~]#firewall-cmd --get-zones
block dmz drop external home internal public trusted work
[root@centos7 ~]#firewall-cmd --get-service
RH-Satellite-6 amanda-client amanda-k5-client amqp amqps apcupsd audit bacula
bacula-client bgp bitcoin bitcoin-rpc bitcoin-testnet bitcoin-testnet-rpc ceph
ceph-mon cfengine condor-collector ctdb dhcp dhcpv6 dhcpv6-client distcc dns
docker-registry docker-swarm dropbox-lansync elasticsearch etcd-client etcd-
server finger freeipa-ldap freeipa-ldaps freeipa-replication freeipa-trust ftp
ganglia-client ganglia-master git gre high-availability http https imap imaps
ipp ipp-client ipsec irc ircs iscsi-target isns jenkins kadmin kerberos kibana
klogin kpasswd kprop kshell ldap ldaps libvirt libvirt-tls lightning-network
llmnr managesieve matrix mdns minidlna mongodb mosh mountd mqtt mqtt-tls ms-wbt
mssql murmur mysql nfs nfs3 nmea-0183 nrpe ntp nut openvpn ovirt-imageio ovirt-
storageconsole ovirt-vmconsole plex pmcd pmproxy pmwebapi pmwebapis pop3 pop3s
postgresql privoxy proxy-dhcp ptp pulseaudio puppetmaster quassel radius redis
rpc-bind rsh rsyncd rtsp salt-master samba samba-client samba-dc sane sip sips
slp smtp smtp-submission smtps snmp snmptrap spideroak-lansync squid ssh steam-
streaming svdrp svn syncthing syncthing-gui synergy syslog syslog-tls telnet
tftp tftp-client tinc tor-socks transmission-client upnp-client vdsm vnc-server
wbem-http wbem-https wsman wsmans xdmcp xmpp-bosh xmpp-client xmpp-local xmpp-
server zabbix-agent zabbix-server
</pre>
</div>

<p>
范例：配置firewalld
</p>

<div class="org-src-container">
<pre class="src src-sh">systemctl mask iptables
systemctl mask ip6tables
systemctl status firewalld
systemctl enable firewalld
systemctl start firewalld
firewall-cmd  --get-default-zone
firewall-cmd  --set-default-zone=public
firewall-cmd  --permanent  --zone=public  --list-all
firewall-cmd  --permanent  --zone=public  --add-port  8080/tcp
firewall-cmd  ---reload
</pre>
</div>
</div>
</div>
<div id="outline-container-h:806ec87a-80e8-4ccf-8127-d250c7f75195" class="outline-4">
<h4 id="h:806ec87a-80e8-4ccf-8127-d250c7f75195">其它规则</h4>
<div class="outline-text-4" id="text-h:806ec87a-80e8-4ccf-8127-d250c7f75195">
<p>
当基本firewalld语法规则不能满足要求时，可以使用以下更复杂的规则
</p>

<ul class="org-ul">
<li>rich-rules 富规则，功能强,表达性语言</li>
<li>Direct configuration rules 直接规则，灵活性差, 帮助：man 5
firewalld.direct</li>
</ul>
</div>
<div id="outline-container-h:78295a50-4b55-4296-b2f0-7acb14ba7f2b" class="outline-5">
<h5 id="h:78295a50-4b55-4296-b2f0-7acb14ba7f2b">管理rich规则</h5>
<div class="outline-text-5" id="text-h:78295a50-4b55-4296-b2f0-7acb14ba7f2b">
<p>
rich规则比基本的firewalld语法实现更强的功能，不仅实现允许/拒绝，还可以
实现日志syslog和auditd，也可以实现端口转发，伪装和限制速率
</p>

<p>
规则实施顺序：
</p>

<ul class="org-ul">
<li>该区域的端口转发，伪装规则</li>
<li>该区域的日志规则</li>
<li>该区域的允许规则</li>
<li>该区域的拒绝规则</li>
</ul>

<p>
每个匹配的规则生效，所有规则都不匹配，该区域默认规则生效
</p>

<p>
rich语法：
</p>

<pre class="example" id="org3d8431e">
rule
    [source]
    [destination]
    service|port|protocol|icmp-block|masquerade|forward-port
    [log]
    [audit]
    [accept|reject|drop]
</pre>

<p>
man 5 firewalld.richlanguage rich规则选项
</p>

<div class="org-src-container">
<pre class="src src-sh">&#36873;&#39033; &#25551;&#36848;
--add-rich-rule=<span style="color: #8b2252;">''</span>     : Add to the specified zone, or the default zone if no zone is specified.
--remove-rich-rule=<span style="color: #8b2252;">''</span>  :  Remove to the specified zone, or the default zone if no zone is specified.
--query-rich-rule=<span style="color: #8b2252;">''</span>   :  Query if has been added to the specified zone, or the default zone if no zone is specified. Returns 0 if the rule is present, otherwise 1.
--list-rich-rules      :  Outputs all rich rules for the specified zone, or the default zone if no zone is specified.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c4dc736f-12ae-42ab-a428-09684a2a2216" class="outline-5">
<h5 id="h:c4dc736f-12ae-42ab-a428-09684a2a2216">rich规则实现</h5>
<div class="outline-text-5" id="text-h:c4dc736f-12ae-42ab-a428-09684a2a2216">
<p>
拒绝从192.168.0.100的所有流量，当address 选项使用source 或destination
时，必须用family=ipv4|ipv6
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --permanent --zone=public --add-rich-rule=<span style="color: #8b2252;">'rule &#160;family=ipv4 source address=192.168.0.100/32 reject'</span>
</pre>
</div>

<p>
限制每分钟只有两个连接到ftp服务
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --add-rich-rule=<span style="color: #8b2252;">'rule service name=ftp limit value=2/m accept'</span>
</pre>
</div>

<p>
抛弃esp（ IPsec 体系中的一种主要协议）协议的所有数据包
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --permanent --add-rich-rule=<span style="color: #8b2252;">'rule protocol value=esp drop'</span>
</pre>
</div>

<p>
接受所有192.168.1.0/24子网端口5900-5905范围的TCP流量
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --permanent --zone=vnc --add-rich-rule=<span style="color: #8b2252;">'rule family=ipv4 source address=192.168.1.0/24 port port=5900-5905 protocol=tcp accept'</span>
</pre>
</div>

<p>
<b>rich日志规则</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">log [<span style="color: #a0522d;">prefix</span>=<span style="color: #8b2252;">"&lt;PREFIX TEXT&gt;"</span> [<span style="color: #a0522d;">level</span>=&lt;LOGLEVEL&gt;] [limit <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"&lt;RATE/DURATION&gt;"</span>]

&lt;LOGLEVEL&gt; &#21487;&#20197;&#26159;emerg,alert, crit, error, warning, notice, info, debug.
&lt;DURATION&gt; s&#65306;&#31186;, m&#65306;&#20998;&#38047;, h&#65306;&#23567;&#26102;, d&#65306;&#22825;
audit [limit <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"&lt;RATE/DURATION&gt;"</span>]
</pre>
</div>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25509;&#21463;ssh&#26032;&#36830;&#25509;&#65292;&#35760;&#24405;&#26085;&#24535;&#21040;syslog&#30340;notice&#32423;&#21035;&#65292;&#27599;&#20998;&#38047;&#26368;&#22810;&#19977;&#26465;&#20449;&#24687;</span>
firewall-cmd --permanent --zone=work --add-rich-rule=<span style="color: #8b2252;">'rule service name="ssh" log prefix="ssh " level="notice" limit value="3/m" accept</span>

<span style="color: #8b2252;">#&#20174;2001:db8::/64&#23376;&#32593;&#30340;DNS&#36830;&#25509;&#22312;5&#20998;&#38047;&#20869;&#34987;&#25298;&#32477;&#65292;&#24182;&#35760;&#24405;&#21040;&#26085;&#24535;&#21040;audit,&#27599;&#23567;&#26102;&#26368;&#22823;&#35760;&#24405;&#19968;&#26465;&#20449;&#24687;</span>
<span style="color: #8b2252;">firewall-cmd --add-rich-rule='</span>rule <span style="color: #a0522d;">family</span>=ipv6 source <span style="color: #a0522d;">address</span>=<span style="color: #8b2252;">"2001:db8::/64"</span> service <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"dns"</span> audit limit <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"1/h"</span> reject<span style="color: #8b2252;">' --timeout=300</span>

<span style="color: #8b2252;">firewall-cmd --permanent --add-rich-rule='</span>rule <span style="color: #a0522d;">family</span>=ipv4 source <span style="color: #a0522d;">address</span>=172.25.X.10/32 service <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">"http"</span> log <span style="color: #a0522d;">level</span>=notice <span style="color: #a0522d;">prefix</span>=<span style="color: #8b2252;">"NEW HTTP "</span> limit <span style="color: #a0522d;">value</span>=<span style="color: #8b2252;">"3/s"</span> accept<span style="color: #8b2252;">'</span>

<span style="color: #8b2252;">firewall-cmd --reload</span>
<span style="color: #8b2252;">tail -f /var/log/messages</span>
<span style="color: #8b2252;">curl http://serverX.example.com</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c704eaa6-81e0-495d-9d46-336dd68d08b2" class="outline-5">
<h5 id="h:c704eaa6-81e0-495d-9d46-336dd68d08b2">伪装和端口转发</h5>
<div class="outline-text-5" id="text-h:c704eaa6-81e0-495d-9d46-336dd68d08b2">
<p>
NAT网络地址转换，firewalld支持伪装和端口转发两种NAT方式 <b>伪装NAT</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --permanent --zone=&lt;ZONE&gt; --add-masquerade
firewall-cmd --query-masquerade  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#26159;&#21542;&#20801;&#35768;&#20266;&#35013;</span>
firewall-cmd --add-masquerade  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20801;&#35768;&#38450;&#28779;&#22681;&#20266;&#35013;IP</span>
firewall-cmd --remove-masquerade <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#27490;&#38450;&#28779;&#22681;&#20266;&#35013;IP</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --add-rich-rule=<span style="color: #8b2252;">'rule family=ipv4 source address=192.168.0.0/24 masquerade'</span>
</pre>
</div>

<p>
<b>端口转发</b>
</p>

<p>
端口转发：将发往本机的特定端口的流量转发到本机或不同机器的另一个端口。
通常要配合地址伪装才能实现
</p>

<div class="org-src-container">
<pre class="src src-sh">firewall-cmd --permanent --zone=&lt;ZONE&gt; --add-forward-port=<span style="color: #a0522d;">port</span>=&lt;PORTNUMBER&gt;:<span style="color: #a0522d;">proto</span>=&lt;PROTOCOL&gt;[:<span style="color: #a0522d;">toport</span>=&lt;PORTNUMBER&gt;][:<span style="color: #a0522d;">toaddr</span>=]
</pre>
</div>

<p>
说明：toport= 和toaddr= 至少要指定一个
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36716;&#21457;&#20256;&#20837;&#30340;&#36830;&#25509;9527/TCP&#65292;&#21040;&#38450;&#28779;&#22681;&#30340;80/TCP&#21040;public zone &#30340;192.168.0.254</span>
firewall-cmd --add-masquerade &#21551;&#29992;&#20266;&#35013;
firewall-cmd --zone=public --add-forward-
<span style="color: #a0522d;">port</span>=<span style="color: #a0522d;">port</span>=9527:<span style="color: #a0522d;">proto</span>=tcp:<span style="color: #a0522d;">toport</span>=80:<span style="color: #a0522d;">toaddr</span>=192.168.0.254
</pre>
</div>

<p>
rich规则的port转发语法：
</p>

<div class="org-src-container">
<pre class="src src-sh">forward-port <span style="color: #a0522d;">port</span>=&lt;PORTNUM&gt; <span style="color: #a0522d;">protocol</span>=tcp|udp [to-port=&lt;PORTNUM&gt;] [to-addr=&lt;ADDRESS&gt;]
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36716;&#21457;&#20174;192.168.0.0/24&#26469;&#30340;&#65292;&#21457;&#24448;80/TCP&#30340;&#27969;&#37327;&#21040;&#38450;&#28779;&#22681;&#30340;&#31471;&#21475;8080/TCP</span>
firewall-cmd --zone=work --add-rich-rule=<span style="color: #8b2252;">'rule family=ipv4 source address=192.168.0.0/24 forward-port port=80 protocol=tcp to-port=8080'</span>

firewall-cmd --permanent --add-rich-rule <span style="color: #8b2252;">'rule family=ipv4 source address=172.25.X.10/32 forward-port port=443 protocol=tcp to-port=22'</span>

firewall-cmd --reload
ssh -p 443 serverX.example.com
</pre>
</div>

<p>
范例：限制ssh服务非标准端口访问
</p>

<div class="org-src-container">
<pre class="src src-sh">cp /usr/lib/firewalld/services/ssh.xml /etc/firewalld/services/ssh.xml
vim /etc/firewalld/services/ssh.xml
&lt;port <span style="color: #a0522d;">protocol</span>=<span style="color: #8b2252;">"tcp"</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">"999"</span>/&gt;
systemctl restart sshd.service
systemctl status -l sshd.service
sealert -a /var/log/audit/audit.log
semanage port -a -t ssh_port_t -p tcp 999
systemctl restart sshd.service
ss -tulpn | grep sshd
firewall-cmd --permanent --zone=work --add-source=172.25.X.0/24
firewall-cmd --permanent --zone=work --add-port=999/tcp
firewall-cmd --reload
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:0a0b62a6-a444-4118-aaec-7df4fd02a865" class="outline-3">
<h3 id="h:0a0b62a6-a444-4118-aaec-7df4fd02a865">nft</h3>
<div class="outline-text-3" id="text-h:0a0b62a6-a444-4118-aaec-7df4fd02a865">
</div>
<div id="outline-container-h:a1a99e5f-96c5-4107-83a3-aba163a9360a" class="outline-4">
<h4 id="h:a1a99e5f-96c5-4107-83a3-aba163a9360a">nft 介绍</h4>
<div class="outline-text-4" id="text-h:a1a99e5f-96c5-4107-83a3-aba163a9360a">
<p>
nftables 是一个 netfilter 项目，旨在替换现有的 {ip,ip6,arp,eb}tables框
架，为 {ip,ip6}tables提供一个新的包过滤框架、一个新的用户空间实用程序
（nft）和一个兼容层。它使用现有的钩子、链接跟踪系统、用户空间排队组件
和netfilter 日志子系统。
</p>

<p>
nftables 主要由三个组件组成：内核实现、libnl netlink 通信和 nftables用
户空间。 其中内核提供了一个 netlink配置接口以及运行时规则集评估，libnl
包含了与内核通信的基本函数，用户空间可以通过nft 和用户进行交互。
</p>

<p>
在 Linux 内核版本高于 3.13 时可用。提供一个新的命令行工具 nft 语法与iptables 不同。
</p>

<p>
官方Wiki：<a href="https://wiki.nftables.org">https://wiki.nftables.org</a>
</p>

<p>
官方文档：<a href="https://www.netfilter.org/projects/nftables/manpage.html">https://www.netfilter.org/projects/nftables/manpage.html</a>
</p>

<p>
参考文档：<a href="https://www.mankier.com/8/nft">https://www.mankier.com/8/nft</a>
</p>
</div>
</div>
<div id="outline-container-h:b0f07a19-43b1-4f37-9b87-1b8d11589c6c" class="outline-4">
<h4 id="h:b0f07a19-43b1-4f37-9b87-1b8d11589c6c">nft 相关概念</h4>
<div class="outline-text-4" id="text-h:b0f07a19-43b1-4f37-9b87-1b8d11589c6c">
<p>
nftables 和 iptables一样，由表（table）、链（chain）和规则（rule）组成，
其中表包含链，链包含规则，规则是真正的action，规则由地址，接口，端口或
包含当前处理数据包中的其他数据等表达式以及诸如drop, queue, continue等
声明组成。
</p>

<p>
与 iptables 相比，nftables 主要有以下几个变化：
</p>

<ul class="org-ul">
<li>iptables 规则的布局是基于连续的大块内存的，即数组式布局；而 nftables
的规则采用链式布局，即数组和链表的区别</li>
<li>iptables大部分工作在内核态完成，如果要添加新功能，只能重新编译内核；
而nftables的大部分工作是在用户态完成的，添加新功能更加容易，不需要改
内核</li>
<li>nftables不包含任何内置表和链</li>
<li>拥有使用额外脚本的能力,拥有一些高级的类似编程语言的能力，例如定义变
量和包含外部文件</li>
<li>iptables 有内置的链，即使只需要一条链，其他的链也会跟着注册；而
nftables 不存在内置的链，可以按需注册。由于 iptables内置了一个数据包
计数器，所以即使这些内置的链是空的，也会带来性能损耗</li>
<li>简化了 IPv4/IPv6 双栈管理</li>
<li>原生支持集合、字典和映射</li>
</ul>

<p>
nftables的每个表只有一个地址簇，并且只适用于该簇的数据包。表可以指定五
个簇中的一个：
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">nftables簇</td>
<td class="org-left">iptables命令行工具</td>
</tr>

<tr>
<td class="org-left">ip (IPv4地址)</td>
<td class="org-left">iptables 默认</td>
</tr>

<tr>
<td class="org-left">ip6 (IPv6 地址)</td>
<td class="org-left">ip6tables</td>
</tr>

<tr>
<td class="org-left">inet (IPv4 和 IPv6 地址)</td>
<td class="org-left">iptables和ip6tables</td>
</tr>

<tr>
<td class="org-left">arp 地址解析协议(ARP)地址</td>
<td class="org-left">arptables</td>
</tr>

<tr>
<td class="org-left">bridge 处理桥接数据包</td>
<td class="org-left">ebtables</td>
</tr>
</tbody>
</table>

<p>
<code>inet</code> 同时适用于 IPv4 和 IPv6 的数据包，即统一了 ip 和 ip6簇，可以更
容易地定义规则，注：当没有指定地址簇时，默认为ip
</p>

<p>
IPv4/IPv6/Inet address family hooks 钩子函数
</p>

<pre class="example" id="orga55b51e">
┌────────────┬──────────────────────────────────────┐
│Hook    │ Description             │
├────────────┼──────────────────────────────────────┤
│prerouting │ All packets entering the system are │
│      │ processed by the prerouting hook. It │
│      │ is invoked  before  the  routing │
│      │ process and is used for early fil- │
│      │ tering or changing packet attributes │
│      │ that affect routing.         │
├────────────┼──────────────────────────────────────┤
│input    │ Packets delivered to the local sys- │
│      │ tem are processed by the input hook. │
├────────────┼──────────────────────────────────────┤
│forward   │ Packets forwarded to a different │
│      │ host are processed by the forward │
│      │ hook.                │
├────────────┼──────────────────────────────────────┤
│output   │ Packets sent by local processes are │
│      │ processed by the output hook.    │
├────────────┼──────────────────────────────────────┤
│postrouting │ All packets leaving the system are │
│      │ processed by the postrouting hook.
</pre>

<p>
链是用来保存规则的，和表一样，链也需要被显示创建，因为 nftables没有内
置的链。链有以下两种类型：
</p>

<ul class="org-ul">
<li><b>基本链</b> :数据包的入口点，需要指定钩子类型和优先级，相当于内置链。默
认没有，要自己创建和钩子函数关联</li>
<li><b>常规链</b> :不需要指定钩子类型和优先级，可以用来做跳转，从逻辑上对规则
进行分类，类似于自定义链</li>
</ul>

<p>
范例: CentOS 8.2 nftables 包
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -qi nftables
Name    : nftables
Version   : 0.9.3
Release   : 12.el8

[root@centos8 ~]#rpm -ql nftables
/etc/nftables
/etc/nftables/main.nft
/etc/nftables/nat.nft
/etc/nftables/osf
etc/nftables/osf/pf.os
/etc/nftables/router.nft
/etc/sysconfig/nftables.conf
/usr/lib/.build-id
/usr/lib/.build-id/77
/usr/lib/.build-id/77/9a947d234d9faf842b8016c7eb449d3a4c8ac0
/usr/lib/.build-id/9d
/usr/lib/.build-id/9d/fc589c6496ba18fad71d3121539c225fbb346d
/usr/lib/systemd/system/nftables.service
/usr/lib64/libnftables.so.1
/usr/lib64/libnftables.so.1.0.0
/usr/sbin/nft
/usr/share/doc/nftables/examples/ct_helpers.nft
/usr/share/doc/nftables/examples/load_balancing.nft
/usr/share/doc/nftables/examples/secmark.nft
/usr/share/doc/nftables/examples/sets_and_maps.nft
/usr/share/licenses/nftables
/usr/share/licenses/nftables/COPYING
/usr/share/man/man5/libnftables-json.5.gz
/usr/share/man/man8/nft.8.gz

[root@centos8 ~]#cat /etc/sysconfig/nftables.conf
<span style="color: #b22222;"># </span><span style="color: #b22222;">Uncomment the include statement here to load the default config sample</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">in /etc/nftables for nftables service.</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">include "/etc/nftables/main.nft"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">To customize, either edit the samples in /etc/nftables, append further</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">commands to the end of this file or overwrite it after first service</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">start by calling: 'nft list ruleset &gt;/etc/sysconfig/nftables.conf'.</span>

[root@centos8 ~]#systemctl start nftables
</pre>
</div>

<p>
范例：CentOS 8.1 nftables 包
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]# rpm -qi nftables
Name    : nftables
Epoch    : 1
Version   : 0.9.0
Release   : 14.el8

[root@centos8 ~]#rpm -ql nftables
/etc/nftables
/etc/nftables/all-in-one.nft
/etc/nftables/arp-filter.nft
/etc/nftables/bridge-filter.nft
/etc/nftables/inet-filter.nft
/etc/nftables/ipv4-filter.nft
/etc/nftables/ipv4-mangle.nft
/etc/nftables/ipv4-nat.nft
/etc/nftables/ipv4-raw.nft
/etc/nftables/ipv6-filter.nft
/etc/nftables/ipv6-mangle.nft
/etc/nftables/ipv6-nat.nft
/etc/nftables/ipv6-raw.nft
/etc/nftables/netdev-ingress.nft
/etc/sysconfig/nftables.conf
/usr/lib/.build-id
/usr/lib/.build-id/68
/usr/lib/.build-id/68/8ad5e5fdc5ba8d10bf227ba50d77fd99040c1c
/usr/lib/.build-id/cc
/usr/lib/.build-id/cc/43827ec42d27875c99ce6bd0f0537614e0129a
/usr/lib/systemd/system/nftables.service
/usr/lib64/libnftables.so.0
/usr/lib64/libnftables.so.0.0.0
/usr/sbin/nft
/usr/share/licenses/nftables
/usr/share/licenses/nftables/COPYING
/usr/share/man/man8/nft.8.gz

[root@centos8 ~]#cat /etc/sysconfig/nftables.conf
<span style="color: #b22222;">#</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">This this will contain your nftables rules and</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">is read by the systemd service when restarting</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">These provide an iptables like set of filters</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">(uncomment to include)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">include "/etc/nftables/bridge-filter.nft"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">include "/etc/nftables/inet-filter.nft"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">include "/etc/nftables/ipv4-filter.nft"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">include "/etc/nftables/ipv4-mangle.nft"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">include "/etc/nftables/ipv4-nat.nft"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">include "/etc/nftables/ipv6-filter.nft"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">include "/etc/nftables/ipv6-mangle.nft"</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">include "/etc/nftables/ipv6-nat.nft</span>

[root@centos8 ~]#systemctl start nftables
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6264a49f-7034-4735-84ef-53c280186229" class="outline-4">
<h4 id="h:6264a49f-7034-4735-84ef-53c280186229">nft 常见用法</h4>
<div class="outline-text-4" id="text-h:6264a49f-7034-4735-84ef-53c280186229">
</div>
<div id="outline-container-h:d8e57b03-a530-444a-ac56-44c785493f97" class="outline-5">
<h5 id="h:d8e57b03-a530-444a-ac56-44c785493f97">nft 命令格式</h5>
<div class="outline-text-5" id="text-h:d8e57b03-a530-444a-ac56-44c785493f97">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft --help
Usage: nft [ options ] [ cmds... ]
&#36873;&#39033;&#35828;&#26126;
-h, --help &#26174;&#31034;&#24110;&#20070;
-v, --version &#26174;&#31034;&#29256;&#26412;&#20449;&#24687;
-c, --check &#26816;&#26597;&#21629;&#20196;&#30340;&#26377;&#25928;&#24615;&#65292;&#32780;&#19981;&#23454;&#38469;&#24212;&#29992;&#26356;&#25913;&#12290;
-f, --file &lt;filename&gt; &#21253;&#21547;&#25991;&#20214;&#20869;&#23481;&lt;filename&gt;
-i, --interactive &#20174;&#21629;&#20196;&#34892;&#35835;&#21462;&#36755;&#20837;
-j, --json &#20197;JSON&#26684;&#24335;&#21270;&#36755;&#20986;
-n, --numeric &#25351;&#23450;&#19968;&#27425;&#21518;&#65292;&#20197;&#25968;&#23383;&#26041;&#24335;&#26174;&#31034;&#32593;&#32476;&#22320;&#22336;&#65288;&#40664;&#35748;&#34892;&#20026;&#65289;&#12290;&#25351;&#23450;&#20004;&#27425;&#20197;&#25968;&#23383;&#26041;&#24335;&#26174;&#31034;Internet&#26381;&#21153;&#65288;&#31471;&#21475;&#21495;&#65289;&#12290;&#25351;&#23450;&#19977;&#27425;&#20197;&#25968;&#23383;&#26041;&#24335;&#26174;&#31034;&#21327;&#35758;&#65292;&#29992;&#25143;ID&#21644;&#32452;ID&#12290;
-s, --stateless &#30465;&#30053;&#35268;&#21017;&#38598;&#30340;&#26377;&#29366;&#24577;&#20449;&#24687;
-N &#23558;IP&#22320;&#22336;&#36716;&#25442;&#20026;&#21517;&#31216;&#12290;
-a, --handle &#26174;&#31034;&#35268;&#21017;&#21477;&#26564;handle
-e, --echo Echo what has been added, inserted or replaced.
-I, --includepath &lt;directory&gt; &#28155;&#21152;&lt;directory&gt;&#30446;&#24405;&#21040;&#21253;&#21547;&#25991;&#20214;&#30340;&#25628;&#32034;&#36335;&#24452;&#20013;&#12290;&#40664;&#35748;&#20026;: /etc
--debug &lt;level [,level...]&gt; &#28155;&#21152;&#35843;&#35797;,&#22312;level&#22788;(scanner, parser, eval, netlink,mnl, proto-ctx, segtree, all)
</pre>
</div>

<p>
<b>nft 命令基本格式</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">nft &#25805;&#20316;&#31526; &#25805;&#20316;&#30446;&#26631; &#25805;&#20316;&#20869;&#23481;

1 &#25805;&#20316;&#31526;: &#22686;,&#21024;,&#25913;,&#26597;,&#28165;&#38500;,&#25554;&#20837;,&#21019;&#24314;
&#34920;&#25805;&#20316;&#65306;add,delete,list,flush
&#38142;&#25805;&#20316;&#65306;add,delete,rename,list,flush,create
&#35268;&#21017;&#65306;add,delete,insert

2 &#25805;&#20316;&#30446;&#26631;: &#31751;,&#34920;,&#38142;,&#35268;&#21017;
&#38142;&#31867;&#22411;&#65306;filter,route,nat
&#38142;&#38057;&#23376;&#65306;hook

3 &#25805;&#20316;&#20869;&#23481;&#65306;...
</pre>
</div>

<p>
<b>规则选项</b>
</p>

<p>
类似于iptable的 target
</p>

<table>


<colgroup>
<col  class="org-right">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">1</th>
<th scope="col" class="org-left">accept</th>
<th scope="col" class="org-left">接受</th>
<th scope="col" class="org-left">接受 包</th>
<th scope="col" class="org-left">停止处理</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2</td>
<td class="org-left">drop</td>
<td class="org-left">丢弃</td>
<td class="org-left">丢弃包</td>
<td class="org-left">停止处理</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">reject</td>
<td class="org-left">拒绝</td>
<td class="org-left">驳回包</td>
<td class="org-left">停止处理</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">queue</td>
<td class="org-left">队列</td>
<td class="org-left">发送包到用户空间程序</td>
<td class="org-left">停止处理</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">continue</td>
<td class="org-left">继续</td>
<td class="org-left">继续处理包</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">return</td>
<td class="org-left">返回</td>
<td class="org-left">发送到调用的规则链进行处理</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">jump</td>
<td class="org-left">跳跃</td>
<td class="org-left">发送到指定的规则链进行处理</td>
<td class="org-left">当完成时或执行了返回的声明，返回到调用的规则链</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">goto</td>
<td class="org-left">转到</td>
<td class="org-left">发送到指定的规则链进行处理</td>
<td class="org-left">不返回到调用的规则链</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-left">limit</td>
<td class="org-left">limit</td>
<td class="org-left">达到接收包的匹配限制，</td>
<td class="org-left">则根据规则处理包</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left">log</td>
<td class="org-left">log</td>
<td class="org-left">日志记录包</td>
<td class="org-left">继续处理</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:51a4e412-7377-4184-a4e6-874b2ddf6433" class="outline-5">
<h5 id="h:51a4e412-7377-4184-a4e6-874b2ddf6433">查看</h5>
<div class="outline-text-5" id="text-h:51a4e412-7377-4184-a4e6-874b2ddf6433">
<div class="org-src-container">
<pre class="src src-sh">nft list ruleset            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;&#35268;&#21017;</span>
nft list tables             <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;&#34920;</span>
nft list table filter       <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21015;&#20986;ip&#31751;&#30340;filter&#34920;</span>
nft list table inet filter  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21015;&#20986;inet&#31751;&#30340;filter&#34920;</span>
nft list chain filter INPUT <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21015;&#20986;filter&#34920;input&#38142;</span>
&#20197;&#19978;&#21629;&#20196;&#21518;&#38754;&#20063;&#21487;&#20197;&#21152; -nn &#29992;&#20110;&#19981;&#35299;&#26512;ip&#22320;&#22336;&#21644;&#31471;&#21475;
&#21152; -a &#29992;&#20110;&#26174;&#31034; handles
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft list tables
[root@centos8 ~]#vim /etc/sysconfig/nftables.conf
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#27492;&#34892;&#21069;&#30340;&#27880;&#37322;</span>
include <span style="color: #8b2252;">"/etc/nftables/inet-filter.nft"</span> 

[root@centos8 ~]#systemctl restart nftables.service
[root@centos8 ~]#nft list tables
table inet filter

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#20026;ip&#31751;&#65292;&#26080;&#35268;&#21017;</span>
[root@centos8 ~]#nft list table filter
Error: Could not process rule: No such file or directory
list table filter
     ^^^^^^

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;inet&#31751;&#25165;&#26377;&#35268;&#21017;</span>
[root@centos8 ~]#nft list table inet filter
table inet filter {
chain input {
<span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
}
chain forward {
<span style="color: #483d8b;">type</span> filter hook forward priority 0; policy accept;
}
chain output {
<span style="color: #483d8b;">type</span> filter hook output priority 0; policy accept;
}
}
[root@centos8 ~]#nft list ruleset
table inet filter {
chain input {
<span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
}
chain forward {
<span style="color: #483d8b;">type</span> filter hook forward priority 0; policy accept;
}
chain output {
<span style="color: #483d8b;">type</span> filter hook output priority 0; policy accept;
}
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:dd1fd1c3-d648-4d0b-b745-b7485d0e1f49" class="outline-5">
<h5 id="h:dd1fd1c3-d648-4d0b-b745-b7485d0e1f49">增加</h5>
<div class="outline-text-5" id="text-h:dd1fd1c3-d648-4d0b-b745-b7485d0e1f49">
<pre class="example" id="orga22a829">
增加表：nft add table fillter
增加链：nft add chain filter input { type filter hook input priority 0 \; } # 要和hook（钩子）相关连
增加规则：nft add rule filter input tcp dport 22 accept
</pre>
</div>
</div>
<div id="outline-container-h:83e2bb90-cca5-4185-b2e4-7cbd1c951381" class="outline-5">
<h5 id="h:83e2bb90-cca5-4185-b2e4-7cbd1c951381">删</h5>
<div class="outline-text-5" id="text-h:83e2bb90-cca5-4185-b2e4-7cbd1c951381">
<p>
只需要把上面的 add 改为 delete 即可
</p>
</div>
</div>
<div id="outline-container-h:334df536-c47f-4048-abc0-702f5433e147" class="outline-5">
<h5 id="h:334df536-c47f-4048-abc0-702f5433e147">改</h5>
<div class="outline-text-5" id="text-h:334df536-c47f-4048-abc0-702f5433e147">
<p>
更改链名用rename 更改规则用replace
</p>
</div>
</div>
</div>
<div id="outline-container-h:e25d4407-518a-4c42-a383-b6ce70adb185" class="outline-4">
<h4 id="h:e25d4407-518a-4c42-a383-b6ce70adb185">nft 实战案例</h4>
<div class="outline-text-4" id="text-h:e25d4407-518a-4c42-a383-b6ce70adb185">
</div>
<div id="outline-container-h:c801d4c7-7697-4d86-8328-18b5e368bf8b" class="outline-5">
<h5 id="h:c801d4c7-7697-4d86-8328-18b5e368bf8b">创建表和删除表</h5>
<div class="outline-text-5" id="text-h:c801d4c7-7697-4d86-8328-18b5e368bf8b">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft add table inet test_table    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#33258;&#23450;&#20041;&#34920;</span>
[root@centos8 ~]#nft list tables
table inet filter
table inet test_table

[root@centos8 ~]#nft delete table inet test_table <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#33258;&#23450;&#20041;&#34920;</span>
[root@centos8 ~]#nft list tables
table inet filter
[root@centos8 ~]#nft add table inet test_table
</pre>
</div>

<p>
<b>列出所有的规则：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft list ruleset
table inet filter {
    chain input {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
    }
    chain forward {
        <span style="color: #483d8b;">type</span> filter hook forward priority 0; policy accept;
    }
    chain output {
        <span style="color: #483d8b;">type</span> filter hook output priority 0; policy accept;
    }
}
table inet test_table {
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2af0f5cc-c874-4f48-a66f-00c90097506a" class="outline-5">
<h5 id="h:2af0f5cc-c874-4f48-a66f-00c90097506a">创建链</h5>
<div class="outline-text-5" id="text-h:2af0f5cc-c874-4f48-a66f-00c90097506a">
<p>
现在表中还没有任何规则，需要创建一个链来保存规则
</p>

<p>
<b>创建基本链：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft add chain inet test_table test_filter_input_chain { <span style="color: #483d8b;">type</span> filter hook input priority 0 <span style="color: #8b2252;">\;</span> }
</pre>
</div>

<ul class="org-ul">
<li>反斜线（ <code>\</code> ）用来转义，这样 shell 就不会将分号解释为命令的结尾。</li>
<li>priority 采用整数值，可以是负数，值较小的链优先处理</li>
</ul>

<p>
<b>创建常规链：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft add chain inet test_table test_chain
</pre>
</div>

<p>
<b>列出链：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft list table inet test_table
table inet test_table {
  chain test_filter_input_chain {
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
  }

  chain test_chain {
  }
}

[root@centos8 ~]#nft list chain inet test_table test_filter_input_chain
table inet test_table {
  chain test_filter_input_chain {
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
  }
}

[root@centos8 ~]#nft list chain inet test_table test_chain
table inet test_table {
  chain test_chain {
  }
}

[root@centos8 ~]#nft list ruleset
</pre>
</div>
</div>
</div>
<div id="outline-container-h:86b0ee29-5a01-43c5-a5a2-36c63b8534e1" class="outline-5">
<h5 id="h:86b0ee29-5a01-43c5-a5a2-36c63b8534e1">创建规则</h5>
<div class="outline-text-5" id="text-h:86b0ee29-5a01-43c5-a5a2-36c63b8534e1">
</div>
<ul class="org-ul">
<li><a id="h:853c2b7c-0a4e-484b-908c-c69b96724140"></a>创建常规链规则<br>
<div class="outline-text-6" id="text-h:853c2b7c-0a4e-484b-908c-c69b96724140">
<p>
有了表和链之后，就可以创建规则了，规则由语句或表达式构成，包含在链中
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#24120;&#35268;&#38142;&#30340;&#35268;&#21017;</span>
[root@centos8 ~]#nft add rule inet test_table test_chain tcp dport http reject <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25298;&#32477;http&#26381;&#21153;&#35775;&#38382;</span>
[root@centos8 ~]#nft add rule inet test_table test_chain tcp dport 443 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25298;&#32477;http&#26381;&#21153;&#35775;&#38382;</span>
[root@centos8 ~]#nft list chain inet test_table test_chain
table inet test_table {
  chain test_chain {
    tcp dport 80 reject
    tcp dport 443 reject
  }
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24120;&#35268;&#38142;&#35268;&#21017;&#40664;&#35748;&#19981;&#29983;&#25928;&#65292;&#24517;&#39035;&#20851;&#32852;&#21040;&#38057;&#23376;&#20989;&#25968;&#19978;</span>
[root@centos7 ~]#curl 10.0.0.8
rft Http Server
</pre>
</div>

<p>
insert插入规则表示将规则添加到链的开头，相当于 <code>iptables -I</code> 。add表示
将规则添加到链的末尾。
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]# nft insert rule inet test_table test_chain tcp dport mysql reject
</pre>
</div>

<p>
列出规则：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft list chain inet test_table test_chain
table inet test_table {
  chain test_chain {
    tcp dport 3306 reject
    tcp dport 80 reject
    tcp dport 443 reject
  }
}

[root@centos8 ~]#nft list table inet test_table
table inet test_table {
chain test_chain {
tcp dport mysql reject
tcp dport http reject
}
chain test_filter_input_chain {
<span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
}
}
</pre>
</div>
</div>
</li>
<li><a id="h:1e8e3afc-5579-44b4-8d12-9b552aa87383"></a>创建基本链规则<br>
<div class="outline-text-6" id="text-h:1e8e3afc-5579-44b4-8d12-9b552aa87383">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft add rule inet test_table test_filter_input_chain tcp dport http reject
[root@centos8 ~]#nft add rule inet test_table test_filter_input_chain ip&#160;saddr 10.0.0.6 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28304;&#22320;&#22336; 10.0.0.6&#25298;&#32477;</span>

[root@centos8 ~]#nft list chain inet test_table test_filter_input_chain
table inet test_table {
  chain test_filter_input_chain {
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 80 reject
    ip saddr 10.0.0.6 reject
  }
}

[root@centos7 ~]#curl 10.0.0.8  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20851;&#32852;&#38057;&#23376;&#20989;&#25968;&#30340;&#35268;&#21017;&#25165;&#29983;&#25928;</span>
curl: (7) Failed connect to 10.0.0.8:80; Connection refused
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:8a13c384-417b-4e5e-b1be-350540dd5c24" class="outline-5">
<h5 id="h:8a13c384-417b-4e5e-b1be-350540dd5c24">插入链的指定位置</h5>
<div class="outline-text-5" id="text-h:8a13c384-417b-4e5e-b1be-350540dd5c24">
<p>
将规则插入到链的指定位置，有两种方法：
</p>
</div>
<ul class="org-ul">
<li><a id="h:228a781e-7ae5-4d8e-a48f-5c5d4b342cf5"></a>使用 index 来指定规则的索引<br>
<div class="outline-text-6" id="text-h:228a781e-7ae5-4d8e-a48f-5c5d4b342cf5">
<p>
index 类似于 iptables 的 <code>-I</code> 选项， index 的值是从 0 开始的
</p>

<p>
index必须指向一个存在的规则，比如 <code>nft insert rule … index 0</code> 就是非
法的。
</p>

<p>
<code>add</code> 表示新规则添加在索引位置的规则后面
</p>

<p>
<code>insert</code> 表示新规则添加在索引位置的规则前面
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft insert rule inet test_table test_filter_input_chain index 0 tcp dport mysql reject
[root@centos8 ~]#nft list chain inet test_table test_filter_input_chain
table inet test_table {
  chain test_filter_input_chain {
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 3306 reject
    tcp dport 80 reject
    ip saddr 10.0.0.6 reject
  }
}

[root@centos8 ~]#nft insert rule inet test_table test_filter_input_chain index 1 udp dport 123 accept
[root@centos8 ~]#nft list chain inet test_table test_filter_input_chain
table inet test_table {
  chain test_filter_input_chain {
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 3306 reject
    udp dport 123 accept
    tcp dport 80 reject
    ip saddr 10.0.0.6 reject
  }
}
</pre>
</div>
</div>
</li>
<li><a id="h:cdcff77d-e0a7-4ece-a139-b30bf25fe3af"></a>使用 handle 来指定规则的句柄<br>
<div class="outline-text-6" id="text-h:cdcff77d-e0a7-4ece-a139-b30bf25fe3af">
<p>
在 nftables中，句柄值是固定不变的，除非规则被删除，这就为规则提供了稳
定的索引。而index 的值是可变的，只要有新规则插入，就有可能发生变化。一
般建议使用 handle 来插入新规则。
</p>

<p>
<code>add</code> 表示新规则添加在索引位置的规则后面， insert
表示新规则添加在索引位置的规则前面。
</p>

<p>
<code>handle</code> 的值可以通过参数 <code>--handle</code> 或者 <code>-a</code> 获取
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft -a list chain inet test_table test_filter_input_chain <span style="color: #b22222;"># </span><span style="color: #b22222;">-a &#33719;&#21462;handle&#20301;&#32622;</span>
table inet test_table {
  chain test_filter_input_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 1</span>
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 9</span>
    udp dport 123 accept <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 10</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 7</span>
    ip saddr 10.0.0.6 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 8</span>
  }
}

[root@centos8 ~]#nft add rule inet test_table test_filter_input_chain handle 7 tcp dport ftp reject <span style="color: #b22222;"># </span><span style="color: #b22222;">add 7&#21518;&#38754;&#21152;&#26032;&#35268;&#21017;</span>
[root@centos8 ~]#nft -a list chain inet test_table test_filter_input_chain
table inet test_table {
  chain test_filter_input_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 1</span>
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 9</span>
    udp dport 123 accept <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 10</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 7</span>
    tcp dport 21 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 11</span>
    ip saddr 10.0.0.6 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 8</span>
  }
}

[root@centos8 ~]#nft insert rule inet test_table test_filter_input_chain handle 8 udp dport 8080 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">insert &#31532;8&#20010;&#21069;&#38754;&#21152;</span>
[root@centos8 ~]#nft -a list chain inet test_table test_filter_input_chain
table inet test_table {
  chain test_filter_input_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 1</span>
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 9</span>
    udp dport 123 accept <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 10</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 7</span>
    tcp dport 21 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 11</span>
    udp dport 8080 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 12</span>
    ip saddr 10.0.0.6 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 8</span>
  }
}

[root@centos8 ~]#nft -a -nn list ruleset
... ...
table inet test_table { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 2</span>
  chain test_filter_input_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 1</span>
    <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 9</span>
    udp dport 123 accept <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 10</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 7</span>
    tcp dport 21 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 11</span>
    udp dport 8080 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 12</span>
    ip saddr 10.0.0.6 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 8</span>
  }

  chain test_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 2</span>
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 6</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 4</span>
    tcp dport 443 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 5</span>
  }
}
</pre>
</div>

<p>
可以在创建规则时就获取到规则的句柄值，在创建规则时同时加上参数
<code>--echo</code> 或者 <code>-e</code> 和 <code>--handle</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft -a -e add rule inet test_table test_filter_input_chain tcp dport 6379 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">-e &#25552;&#31034;&#21019;&#24314;&#26102;&#33719;&#21462;&#21040;&#35268;&#21017;&#30340;&#21477;&#26564;&#20540;</span>
add rule inet test_table test_filter_input_chain tcp dport 6379 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 13</span>

[root@centos8 ~]#nft -a list chain inet test_table test_filter_input_chain
table inet test_table {
  chain test_filter_input_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 1</span>
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 9</span>
    udp dport 123 accept <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 10</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 7</span>
    tcp dport 21 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 11</span>
    udp dport 8080 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 12</span>
    ip saddr 10.0.0.6 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 8</span>
    tcp dport 6379 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 13</span>
  }
}
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:99db9446-a0f5-4299-a812-1f1afa4ac59a" class="outline-5">
<h5 id="h:99db9446-a0f5-4299-a812-1f1afa4ac59a">删除规则</h5>
<div class="outline-text-5" id="text-h:99db9446-a0f5-4299-a812-1f1afa4ac59a">
</div>
<ul class="org-ul">
<li><a id="h:79874442-14ec-4725-ad9c-baafa0447d53"></a>删除单个规则<br>
<div class="outline-text-6" id="text-h:79874442-14ec-4725-ad9c-baafa0447d53">
<p>
删除方法：指定规则内容或handle号
</p>

<p>
单个规则只能通过其句柄删除，首先需要找到想删除的规则句柄
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft --handle list ruleset
table inet test_table { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 2</span>
  chain test_filter_input_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 1</span>
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 9</span>
    udp dport 123 accept <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 10</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 7</span>
    tcp dport 21 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 11</span>
    udp dport 8080 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 12</span>
    ip saddr 10.0.0.6 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 8</span>
    tcp dport 6379 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 13</span>
  }

  chain test_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 2</span>
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 6</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 4</span>
    tcp dport 443 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 5</span>
  }
}

$ nft --handle list ruleset
</pre>
</div>

<p>
然后使用句柄值来删除该规则：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft delete rule inet test_table test_filter_input_chain handle 8 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;handle &#21495;&#21024;&#38500;</span>
[root@centos8 ~]#nft list chain inet test_table test_filter_input_chain
table inet test_table {
  chain test_filter_input_chain { <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 1</span>
    <span style="color: #483d8b;">type</span> filter hook input priority filter; policy accept;
    tcp dport 3306 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 9</span>
    udp dport 123 accept <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 10</span>
    tcp dport 80 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 7</span>
    tcp dport 21 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 11</span>
    udp dport 8080 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 12</span>
    tcp dport 6379 reject <span style="color: #b22222;"># </span><span style="color: #b22222;">handle 13</span>
  }
}
</pre>
</div>
</div>
</li>
<li><a id="h:a9898b27-2ced-40db-a483-ba19ed792548"></a>删除所有规则<br>
<div class="outline-text-6" id="text-h:a9898b27-2ced-40db-a483-ba19ed792548">
<p>
表、链、规则全清理了
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft flush ruleset
[root@centos8 ~]#nft list
Error: syntax error, unexpected newline
list
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:31e908ce-837d-46d3-81a6-14275abc4e79" class="outline-5">
<h5 id="h:31e908ce-837d-46d3-81a6-14275abc4e79">列出规则</h5>
<div class="outline-text-5" id="text-h:31e908ce-837d-46d3-81a6-14275abc4e79">
<p>
可以列出所有规则，也可以列出规则的一部分
</p>
</div>
<ul class="org-ul">
<li><a id="h:4782c4ae-3d47-4ccd-950c-5391a947820e"></a>列出所有规则<br>
<div class="outline-text-6" id="text-h:4782c4ae-3d47-4ccd-950c-5391a947820e">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft list ruleset
table inet filter {
    chain input {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
    }
    chain forward {
        <span style="color: #483d8b;">type</span> filter hook forward priority 0; policy accept;
    }
    chain output {
        <span style="color: #483d8b;">type</span> filter hook output priority 0; policy accept;
    }
}
table inet test_table {
    chain test_chain {
        tcp dport mysql reject
        tcp dport http reject
    }
    chain test_filter_input_chain {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
        tcp dport mysql reject
        tcp dport ftp reject
        udp dport http-alt reject
        tcp dport http reject
        tcp dport 6379 reject
    }
}
</pre>
</div>
</div>
</li>
<li><a id="h:80b57d89-1c8c-46c9-abad-7da542cca1d1"></a>列出指定表中的所有规则<br>
<div class="outline-text-6" id="text-h:80b57d89-1c8c-46c9-abad-7da542cca1d1">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft list table inet test_table
table inet test_table {
    chain test_chain {
        tcp dport mysql reject
        tcp dport http reject
    }
    chain test_filter_input_chain {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
        tcp dport mysql reject
        tcp dport ftp reject
        udp dport http-alt reject
        tcp dport http reject
        tcp dport 6379 reject
    }
}
</pre>
</div>
</div>
</li>
<li><a id="h:928d0861-ad12-4c74-85ee-4128f7034e43"></a>列出指定链中的所有规则<br>
<div class="outline-text-6" id="text-h:928d0861-ad12-4c74-85ee-4128f7034e43">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nft list chain inet test_table test_filter_input_chain
table inet test_table {
    chain test_filter_input_chain {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
        tcp dport mysql reject
        tcp dport ftp reject
        udp dport http-alt reject
        tcp dport http reject
        tcp dport 6379 reject
    }
}
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:ca7c831e-db03-4dc6-9a57-fdb2f1e3894c" class="outline-5">
<h5 id="h:ca7c831e-db03-4dc6-9a57-fdb2f1e3894c">备份还原</h5>
<div class="outline-text-5" id="text-h:ca7c831e-db03-4dc6-9a57-fdb2f1e3894c">
<p>
规则都是临时的，要想永久生效，可以将规则备份，重启后自动加载恢复
</p>

<p>
查看service文件
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /lib/systemd/system/nftables.service
[Unit]
<span style="color: #a0522d;">Description</span>=Netfilter Tables
<span style="color: #a0522d;">Documentation</span>=man:nft(8)
<span style="color: #a0522d;">Wants</span>=network-pre.target
<span style="color: #a0522d;">Before</span>=network-pre.target
[Service]
<span style="color: #a0522d;">Type</span>=oneshot
<span style="color: #a0522d;">ProtectSystem</span>=full
<span style="color: #a0522d;">ProtectHome</span>=true
<span style="color: #a0522d;">ExecStart</span>=/sbin/nft -f /etc/sysconfig/nftables.conf  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22791;&#20221;&#25991;&#20214;&#20301;&#32622;</span>
<span style="color: #a0522d;">ExecReload</span>=/sbin/nft <span style="color: #8b2252;">'flush ruleset; include "/etc/sysconfig/nftables.conf";'</span>
<span style="color: #a0522d;">ExecStop</span>=/sbin/nft flush ruleset
<span style="color: #a0522d;">RemainAfterExit</span>=yes
[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target
</pre>
</div>

<p>
<b>备份配置并还原</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#33267;&#25991;&#20214;&#20013;</span>
[root@centos8 ~]#nft list ruleset
table inet filter {
    chain input {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
    }
    chain forward {
        <span style="color: #483d8b;">type</span> filter hook forward priority 0; policy accept;
    }
    chain output {
        <span style="color: #483d8b;">type</span> filter hook output priority 0; policy accept;
    }
}
table inet test_table {
    chain test_chain {
        tcp dport mysql reject
        tcp dport http reject
    }
    chain test_filter_input_chain {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
        tcp dport mysql reject
        tcp dport ftp reject
        udp dport http-alt reject
        tcp dport http reject
        tcp dport 6379 reject
    }
}

[root@centos8 ~]#nft list ruleset &gt; /etc/sysconfig/nftables.conf <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35268;&#21017;&#20445;&#23384;&#21040;&#25991;&#20214;&#20013; &#25110;&#32773;&#25991;&#20214;&#20013;&#25351;&#23450;include&#21152;&#36733;&#35268;&#21017;&#33258;&#23450;&#20041;&#25991;&#20214;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#25152;&#26377;&#35268;&#21017;</span>
[root@centos8 ~]#nft flush ruleset
[root@centos8 ~]#nft list ruleset

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#26032;&#21551;&#21160;&#21518;&#20840;&#37096;&#36824;&#21407;</span>
[root@centos8 ~]#systemctl restart nftables.service
[root@centos8 ~]#nft list ruleset
table inet filter {
    chain input {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
    }
    chain forward {
        <span style="color: #483d8b;">type</span> filter hook forward priority 0; policy accept;
    }
    chain output {
        <span style="color: #483d8b;">type</span> filter hook output priority 0; policy accept;
    }
}
table inet test_table {
    chain test_chain {
        tcp dport mysql reject
        tcp dport http reject
    }
    chain test_filter_input_chain {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
        tcp dport mysql reject
        tcp dport ftp reject
        udp dport http-alt reject
        tcp dport http reject
        tcp dport 6379 reject
    }
}
</pre>
</div>

<p>
<b>启用指定的配置文件</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat nftables2.conf
table inet test2_table {
    chain test2_filter_input_chain {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
        ip saddr { 10.0.0.1, 10.0.0.10 } accept
        tcp dport { http, nfs,ssh } reject
    }
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">-f &#25351;&#23450;&#35268;&#21017;&#37197;&#32622;&#25991;&#20214;&#65292;&#22914;&#26524;&#24050;&#32463;&#26377;&#35268;&#21017;&#65292;&#26159;&#36861;&#21152;&#33267;&#29616;&#26377;&#35268;&#21017;&#21518;</span>
[root@centos8 ~]#nft -f nftables2.conf
[root@centos8 ~]#nft list ruleset
table inet test2_table {
    chain test2_filter_input_chain {
        <span style="color: #483d8b;">type</span> filter hook input priority 0; policy accept;
        ip saddr { 10.0.0.1, 10.0.0.10 } accept
        tcp dport { ssh, http, nfs } reject
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:18748435-b5fb-4c0f-a14b-3cee735a1d09" class="outline-5">
<h5 id="h:18748435-b5fb-4c0f-a14b-3cee735a1d09">迁移iptables规则到nft</h5>
<div class="outline-text-5" id="text-h:18748435-b5fb-4c0f-a14b-3cee735a1d09">
<ol class="org-ol">
<li><p>
To save the existing rules to a file, run below command:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">iptables-save &gt; rules.iptables</span>
</pre>
</div></li>

<li>Move the step1 file to CentOS/RHEL 8 Server via scp or ftp. You can
use vi editor as well to copy the content from CentOS/RHEL 6 or 7
machine.</li>

<li><p>
Run the below command to generate the nft rules file on CentOS/RHEL 8
with iptables rules file.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">iptables-restore-translate -f rules.iptables &gt; rules.nft # &#36716;&#25442;</span>
</pre>
</div></li>

<li><p>
Load the rules in CentOS/RHEL 8 machine, make sure nftables service
is running on the system.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">nft -f rules.nft &#160;&#160;### load the rule via nft to nftables.</span>
</pre>
</div></li>

<li><p>
To Display rule in CentOS/RHEL 8 Server .
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">nft list ruleset</span>
</pre>
</div></li>
</ol>

<p>
You can see the rules have been migrated from CentOS/RHEL 6 or 7 to
CentOS/RHEL 8 server now and can test them as well
</p>

<p>
<b>动动手</b>
</p>

<p>
说明：以下练习INPUT和OUTPUT默认策略均为DROP
</p>

<ol class="org-ol">
<li>限制本地主机的web服务器在周一不允许访问；新请求的速率不能超过100个每秒；web服务器包含了admin字符串的页面不允许访问；web服务器仅允许响应报文离开本机</li>

<li>在工作时间，即周一到周五的8:30-18:00，开放本机的ftp服务给172.16.0.0网络中的主机访问；数据下载请求的次数每分钟不得超过5个</li>

<li>开放本机的ssh服务给172.16.x.1-172.16.x.100中的主机，x为你的学号，新请求建立的速率一分钟不得超过2个；仅允许响应报文通过其服务端口离开本机</li>

<li>拒绝TCP标志位全部为1及全部为0的报文访问本机</li>

<li>允许本机ping别的主机；但不开放别的主机ping本机</li>

<li><p>
判断下述规则的意义
</p>

<div class="org-src-container">
<pre class="src src-sh">iptables -N clean_in
iptables -A clean_in -d 255.255.255.255 -p icmp -j DROP
iptables -A clean_in -d 172.16.255.255 -p icmp -j DROP
iptables -A clean_in -p tcp ! --syn -m state --state NEW -j DROP
iptables -A clean_in -p tcp --tcp-flags ALL ALL -j DROP
iptables -A clean_in -p tcp --tcp-flags ALL NONE -j DROP
iptables -A clean_in -d 172.16.100.7 -j RETURN
iptables -A INPUT -d 172.16.100.7 -j clean_in
iptables -A INPUT &#160;-i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT
iptables -A INPUT &#160;-i eth0 -m multiport -p tcp --dports 53,873,135,137,139,445 -j DROP
iptables -A INPUT &#160;-i eth0 -m multiport -p udp --dports 53,873,135,137,139,445 -j DROP
iptables -A INPUT &#160;-i eth0 -m multiport -p tcp --dports 1433,3389 -j DROP
iptables -A INPUT &#160;-p icmp -m limit --limit 10/second -j ACCEPT
</pre>
</div></li>

<li><p>
实现主机防火墙
</p>

<pre class="example" id="orgc32df9b">
放行telnet, ftp, web服务
放行samba服务
放行dns服务(查询和区域传送)
</pre></li>

<li><p>
实现网络防火墙
</p>

<pre class="example" id="orga59341b">
放行telnet, ftp, web服务
放行samba服务
放行dns服务(查询和区域传送)
</pre></li>
</ol>
</div>
</div>
</div>
</div>
</section>
</main class="container">
<footer id="postamble" class="status">
<footer data-astro-cid-sz7xmlte data-turbo-permanent id=rootFooter>
    <script>
        const shuffle = e => e.map((e => ({
            v: e,
            sort: Math.random()
        }))).sort(( (e, o) => e.sort - o.sort)).map(( ({v: e}) => e));
        var songList = ["barbie-girl--stantough", "blue-da-ba-dee--cornelius-link", "hips-dont-lie--stantough", "i-want-it-that-way--stantough", "seven-nation-army--stantough", "smooth-criminal--stantough"]
          , songOrder = songOrder ?? shuffle(songList).map((e => `/audio/music/${e}.opus`))
          , song = new Audio(songOrder[0])
          , nextSong = new Audio(songOrder[1])
          , songIndex = 2
          , musicWrapper = void 0
          , arrow = void 0
          , notes = void 0;
        song.addEventListener("ended", next);
        const toggle = () => song.paused ? play() : pause();
        function play() {
            song.play(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.add("shakeManHorse"),
            notes.classList.remove("hideNotes")
        }
        function pause() {
            song.pause(),
            musicWrapper = musicWrapper || document.getElementById("musicWrapper"),
            notes = notes || document.getElementById("notesWrapper"),
            musicWrapper.classList.remove("shakeManHorse"),
            notes.classList.add("hideNotes")
        }
        function next() {
            song = nextSong,
            play(),
            songIndex === songOrder.length && (songIndex = 0),
            nextSong = new Audio(songOrder[songIndex]),
            songIndex += 1
        }
        function skip() {
            pause(),
            (arrow = arrow || document.getElementById("musicArrow")).classList.add("shootArrow");
            new Audio("/audio/effects/ohno.m4a").play(),
            arrow.addEventListener("animationend", arrowShootHandler, !1)
        }
        function arrowShootHandler() {
            arrow.removeEventListener("animationend", arrowShootHandler, !1),
            arrow.classList.remove("shootArrow");
            new Audio("/audio/effects/heythathurt.m4a").play(),
            next()
        }
    </script>
    <div id=musicPlayer data-astro-cid-q7a5pyro>
        <button class=skip data-astro-cid-q7a5pyro onclick=skip() title="Skip song">
            <div id=skipWrapper data-astro-cid-q7a5pyro>
                <img alt="Medieval drollery of a man/snail/bat/monkey shooting an arrow" class=archer decoding=async height=334 loading=lazy src=/images/archer-no-arrow.448ccd8b_Z1KfRYq.webp width=226 data-astro-cid-q7a5pyro>
                <img alt="Arrow for archer" class="arrow complete" decoding=async height=23 loading=lazy src=/images/no-archer-full-arrow.87aa9971_Z2qL2KO.webp width=141 data-astro-cid-q7a5pyro id=musicArrow>
            </div>
        </button>
        <button class=playPause data-astro-cid-q7a5pyro onclick=toggle() title="Play/pause song">
            <div id=musicWrapper data-astro-cid-q7a5pyro>
                <div class=hideNotes id=notesWrapper data-astro-cid-q7a5pyro>
                    <div class=lyreNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                    <div class=fluteNotes data-astro-cid-6gcrueho>
                        <div class=note1 data-astro-cid-6gcrueho>&#9835;&#9833;</div>
                        <div class=note2 data-astro-cid-6gcrueho>&#9833;</div>
                        <div class=note3 data-astro-cid-6gcrueho>&#9839;&#9834;</div>
                        <div class=note4 data-astro-cid-6gcrueho>&#9834;</div>
                    </div>
                </div>
                <img alt="Medieval drollery of a man/horse playing a lyre and a horn" class=manHorse decoding=async height=665 loading=lazy src=/images/man-horse-band.e3a2efcf_q8FCa.webp width=531 data-astro-cid-q7a5pyro>
            </div>
        </button>
    </div>
    <hr data-astro-cid-sz7xmlte>
    <div class=salutation data-astro-cid-gdmrbrho>
        <p data-astro-cid-gdmrbrho>
            <span class=flower2 data-astro-cid-gdmrbrho>A</span>
            <span class=smallcap data-astro-cid-gdmrbrho>pax vobiscum</span>
            <span class="flower2 wiggle" data-astro-cid-gdmrbrho id=leaf>a</span>
        </p>
    </div>
    <script>
        function animateLeafBlownHandler() {
            leaf.removeEventListener("animationend", animateLeafBlownHandler, !1),
            leaf.classList.remove("blownAway"),
            leaf.classList.add("wiggle")
        }
        function animateLeaf() {
            leaf = leaf ?? document.getElementById("leaf"),
            leaf.classList.remove("wiggle"),
            leaf.classList.add("blownAway"),
            leaf.addEventListener("animationend", animateLeafBlownHandler, !1)
        }
        document.getElementById("leaf").onclick = animateLeaf
    </script>


    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2024 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
</footer>
</footer>
</body>
</html>
