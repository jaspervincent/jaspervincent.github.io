<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: 企业级 VPN 服务 OpenVPN</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux: 企业级 VPN 服务 OpenVPN</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:f3fdf06c-619e-45df-bdbd-a86028985014">企业级VPN服务OpenVPN</a>
<ul>
<li><a href="#h:75f201e8-2878-4c3d-bc8c-e5d0df56506b">1 OpenVPN简介</a>
<ul>
<li><a href="#h:52f14136-552e-4b4f-bf5d-171ec7c655e8">1.1 VPN 介绍</a></li>
<li><a href="#h:a4397dd4-0a9d-4d98-b292-355aa822a503">1.2 OpenVPN</a></li>
</ul>
</li>
<li><a href="#h:fe48c419-abd2-43da-8583-7a73aa2bc911">2 OpenVPN 部署</a>
<ul>
<li><a href="#h:35391b86-c459-41e7-ab05-9adfc844cb38">2.1 准备 OpenVPN 部署环境</a>
<ul>
<li><a href="#h:0dca5a8a-af01-475f-8e10-a028790095ce">2.1.1 环境1: 阿里云OpenVPN 实战环境</a></li>
<li><a href="#h:3a955b9b-5093-45eb-94f2-8ac88bce514b">2.1.2 环境2: 局域网 OpenVPN 实战环境</a></li>
</ul>
</li>
<li><a href="#h:afd88d4e-db42-4dff-87c6-32c98839d1f8">2.2 安装OpenVPN软件包</a>
<ul>
<li><a href="#h:7796c98b-9c4c-40a1-90b1-262c77bf4341">2.1.1 查看版本</a></li>
<li><a href="#h:9f74fd24-ccab-4356-a583-65ad44e6b92f">2.1.2 安装OpenVPN</a></li>
<li><a href="#h:4ff95179-a14f-4c60-a884-161a2783f6d3">2.1.3 查看包中相关文件</a></li>
<li><a href="#h:15f4a2ff-7e82-418f-8600-66d9a3d09b87">2.2.2 准备相关配置文件</a></li>
</ul>
</li>
<li><a href="#h:bd5e5386-ecf1-4e1a-8fc7-bb92097d3112">2.3 准备证书相关文件</a>
<ul>
<li><a href="#h:f05753c8-6e2b-490f-b88b-a6a6887b0164">2.3.1 初始化PKI和CA签发机构环境</a></li>
<li><a href="#h:2529657a-b8dc-43a2-9520-bd26a3b39df7">2.3.2 创建CA机构</a></li>
<li><a href="#h:eb24643a-16fa-419e-81df-e64d2543f9a2">2.3.3 创建服务端证书申请</a></li>
<li><a href="#h:149f9b29-7914-4357-9522-2057ec63072e">2.3.4 签发服务端证书</a></li>
<li><a href="#h:80a41a46-c76f-4fdd-8fc4-7ada9432a471">2.3.5 创建Diifie-Hellman密钥</a></li>
<li><a href="#h:df383671-1126-40d8-9323-28f7be5e8f52">2.3.6 准备客户端证书环境</a></li>
<li><a href="#h:0479397a-31de-4e6f-bbce-5d06c8db4b29">2.3.7 创建客户端证书申请</a></li>
<li><a href="#h:68762176-7a9d-40af-86d6-bc502da524a5">2.3.8 签发客户端证书</a></li>
<li><a href="#h:0071d4c1-6f4d-402b-87f3-2bb8d6c05182">2.3.9 将CA和服务器证书相关文件复制到服务器相应的目录</a></li>
<li><a href="#h:2da86924-c043-4fcd-a952-ccaa0747357b">2.3.10 将客户端私钥与证书相关文件复制到服务器相关的目录</a></li>
</ul>
</li>
<li><a href="#h:b5da11a4-e665-4179-bdfe-33c6cafd56b3">2.4 准备 OpenVPN 服务器配置文件</a>
<ul>
<li><a href="#h:f24b4b61-b4cb-4bc0-9f0f-edab119cf542">2.4.1 服务器端配置文件说明</a></li>
<li><a href="#h:42ce7630-7692-41ac-b2d4-eb9669565dea">2.4.2 修改服务器端配置文件</a></li>
</ul>
</li>
<li><a href="#h:b0eab57e-5097-4ba1-a773-9ba73dbe114d">2.5 准备iptables规则和内核参数</a></li>
<li><a href="#h:89ded5b1-bd41-4f72-ad64-e40de1373a3a">2.6 启动OpenVPN服务</a>
<ul>
<li><a href="#h:7957b04b-176c-47d6-a21d-bdf79c0449da">2.6.1 启动 OpenVPN 服务</a></li>
<li><a href="#h:d9876eb8-ec14-48f2-87e9-7124ba447f75">2.6.2 查看服务状态</a></li>
</ul>
</li>
<li><a href="#h:bbe27959-0b4c-4172-9615-29f4bc323331">2.7 准备OpenVPN客户端配置文件</a>
<ul>
<li><a href="#h:1abfbefb-9a99-4dd8-9521-3bca988cb43c">2.7.1 客户端默认范例配置文件说明</a></li>
<li><a href="#h:29a8f18d-a398-47cd-8933-b8b62512ef1b">2.7.2 生成客户端用户的配置文件</a></li>
</ul>
</li>
<li><a href="#h:3434b1f9-de3c-4d5f-9eaa-8be8b0468822">2.8 Windows 配置部署 OpenVPN 客户端</a>
<ul>
<li><a href="#h:efe2439f-044a-40ce-be1f-ca1dca872c77">2.8.1 Windows 安装 OpenVPN 客户端</a></li>
<li><a href="#h:e36b646d-17df-48ac-b38c-1444c76b78c8">2.8.2 Windows客户端配置准备</a></li>
<li><a href="#h:cd413baf-3c3b-41c9-9b47-fedfa8c41b76">2.8.4 Windows客户端验证通信</a></li>
</ul>
</li>
<li><a href="#h:129adf76-5f04-43d7-90ed-4b68e64185d7">2.9 Mac OS 配置部署OpenVPN 客户端</a></li>
</ul>
</li>
<li><a href="#h:897b7df7-e2a7-4d13-a2f7-43abd2aefedf">3 故障排错</a>
<ul>
<li><a href="#h:49838d2d-1e9d-410b-a105-d6eb947d2fdd">3.1 在tcp模式下开启explicit-exit-notify 导致无法启动</a></li>
<li><a href="#h:7f6c822d-e7ef-4b6b-bc48-7aafb80c3778">3.2 压缩算法错误导致连接失败</a></li>
<li><a href="#h:3d0a32df-f2fa-4156-a7bb-ecc9a10e0ba2">3.3 工作模式错误</a></li>
</ul>
</li>
<li><a href="#h:4dd0f841-87d9-4a36-ac8c-6e8befc58edc">4 OpenVPN 高级功能</a>
<ul>
<li><a href="#h:12e96174-9deb-4789-ae14-6e3cd287fe4a">4.1 启用安全增强功能</a></li>
<li><a href="#h:c2528db0-7338-48ab-a40e-3dbcd0378005">4.2 设置客户端的私钥密码增强安全性</a>
<ul>
<li><a href="#h:a16c0d4f-5bff-468e-92bf-f84a78775ce6">4.2.1 创建新用户,生成对应的有密码的私钥和证书申请</a></li>
<li><a href="#h:69b61b84-d5e9-4fbd-aa16-d772c98ffff4">4.2.2 导入用户证书申请并颁发证书</a></li>
<li><a href="#h:c4450466-863e-48c3-be3f-03c2dc5e5110">4.2.3 将用户的证书相关文件放在指定的目录中</a></li>
<li><a href="#h:58286093-8c0f-43c0-ba90-4babc6b57435">4.2.4 将相关文件传给客户端主机相应目录</a></li>
<li><a href="#h:a1627628-fe62-4bd4-a159-44505bedaf16">4.2.5 Windows 客户端重新连接</a></li>
</ul>
</li>
<li><a href="#h:b6271759-8360-4f4c-8c0e-d0284f2f164f">4.3 账户证书管理</a>
<ul>
<li><a href="#h:f81fb728-b163-4d5f-9f29-0e3eedad6ee0">4.3.1 证书自动过期</a></li>
<li><a href="#h:45a98bdb-a793-4fac-b020-bd49cda445de">4.3.2 证书手动注销</a></li>
<li><a href="#h:b8308f8c-2f5a-4c22-851f-58a1e0e386b8">4.3.3 账户重名证书签发</a></li>
</ul>
</li>
<li><a href="#h:13a1ca04-cdbe-4f5a-89bd-ba552e816c81">4.4 生产推荐配置文件</a>
<ul>
<li><a href="#h:40445c56-da42-4f16-8bf1-1bf48b0fa934">4.4.1 server 端配置</a></li>
<li><a href="#h:9b6ae1dd-ebc9-44dd-8ce6-df6ee4b2ac6e">4.4.2 client 端配置</a></li>
</ul>
</li>
<li><a href="#h:ef0e6c0e-2c46-4cdf-ada2-01cb59cb4d5e">4.5 插件</a>
<ul>
<li><a href="#h:fd56f202-7162-4ac3-966f-a7ec9cf9af8e">4.5.1 脚本插件</a></li>
<li><a href="#h:93d0012d-5580-4b38-9d7b-caef61460085">4.5.2 mysql插件</a></li>
<li><a href="#h:f41d8bee-6865-441a-816e-6c43816c254a">4.5.3 ldap插件</a></li>
<li><a href="#h:18f951c9-afd9-4349-b35c-c4e12566632e">4.5.4 GoogleAuthenticator认证插件</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:f865de00-3365-4a90-9f5f-b5bda45f98da">5 扩展知识</a>
<ul>
<li><a href="#h:969a8d5e-80d0-44d8-b754-74801e0d4827">5.1 OpenVPN Access Server</a></li>
<li><a href="#h:812bbaaa-4a70-440a-b89e-cd04356eba83">5.2 docker 运行OpenVPN Access Server</a></li>
<li><a href="#h:a82b986c-3cb8-4ecb-aa57-e9d317900e40">5.3 一键安装</a></li>
<li><a href="#h:67967982-c846-4ae9-a1d8-67d1e4e63be6">5.4 监控</a>
<ul>
<li><a href="#h:87f35709-48be-423e-aaeb-44ae1bc646c2">openvpn-monitor</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../../index.html">Linux</a></li>
</ul>


<p>
本章内容
</p>

<ul class="org-ul">
<li>OpenVPN 简介</li>
<li>OpenVPN 部署</li>
<li>OpenVPN 故障排错</li>
<li>OpenVPN 高级功能</li>
<li>扩展知识</li>
</ul>
<section id="outline-container-h:f3fdf06c-619e-45df-bdbd-a86028985014" class="outline-2">
<h2 id="h:f3fdf06c-619e-45df-bdbd-a86028985014">企业级VPN服务OpenVPN</h2>
<div class="outline-text-2" id="text-h:f3fdf06c-619e-45df-bdbd-a86028985014">
</div>
<div id="outline-container-h:75f201e8-2878-4c3d-bc8c-e5d0df56506b" class="outline-3">
<h3 id="h:75f201e8-2878-4c3d-bc8c-e5d0df56506b">1 OpenVPN简介</h3>
<div class="outline-text-3" id="text-h:75f201e8-2878-4c3d-bc8c-e5d0df56506b">
</div>
<div id="outline-container-h:52f14136-552e-4b4f-bf5d-171ec7c655e8" class="outline-4">
<h4 id="h:52f14136-552e-4b4f-bf5d-171ec7c655e8">1.1 VPN 介绍</h4>
<div class="outline-text-4" id="text-h:52f14136-552e-4b4f-bf5d-171ec7c655e8">
<p>
专用网：专用网就是在两个网络（例如，北京和广州）之间架设一条专用线路，
但是它并不需要真正地去铺设光缆之类的物理线路。虽然没有亲自去铺设，但是
需要向电信运营商申请租用专线，在这条专用的线路上只传输自己的信息,所以
安全稳定,同时也费用高昂
</p>

<p>
VPN：Virtual Private Network，虚拟私有网络，又称为虚拟专用网络，用于在
不安全的线路上安全的传输数据。
</p>


<figure id="org07c3bd1">
<img src="images/image-20210219171804828.png" alt="image-20210219171804828.png">

</figure>
</div>
</div>
<div id="outline-container-h:a4397dd4-0a9d-4d98-b292-355aa822a503" class="outline-4">
<h4 id="h:a4397dd4-0a9d-4d98-b292-355aa822a503">1.2 OpenVPN</h4>
<div class="outline-text-4" id="text-h:a4397dd4-0a9d-4d98-b292-355aa822a503">
<p>
OpenVPN：一个实现VPN的开源软件，OpenVPN 是一个健壮的、高度灵活的 VPN守
护进程。它支持SSL/TLS 安全、Ethernet bridging、经由代理的 TCP 或 UDP隧
道和 NAT。另外，它也支持动态 IP地址以及DHCP，可伸缩性足以支持数百或数
千用户的使用场景，同时可移植至大多数主流操作系统平台上。
</p>

<p>
官网：<a href="https://openvpn.net">https://openvpn.net</a>
</p>

<p>
GitHub地址：<a href="https://github.com/OpenVPN/openvpn">https://github.com/OpenVPN/openvpn</a>
</p>

<p>
<b>OpenVPN 示意图</b>
</p>


<figure id="orgbd5b0ed">
<img src="images/image-20210219171821781.png" alt="image-20210219171821781.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:fe48c419-abd2-43da-8583-7a73aa2bc911" class="outline-3">
<h3 id="h:fe48c419-abd2-43da-8583-7a73aa2bc911">2 OpenVPN 部署</h3>
<div class="outline-text-3" id="text-h:fe48c419-abd2-43da-8583-7a73aa2bc911">
</div>
<div id="outline-container-h:35391b86-c459-41e7-ab05-9adfc844cb38" class="outline-4">
<h4 id="h:35391b86-c459-41e7-ab05-9adfc844cb38">2.1 准备 OpenVPN 部署环境</h4>
<div class="outline-text-4" id="text-h:35391b86-c459-41e7-ab05-9adfc844cb38">
<p>
官文文档: <a href="https://openvpn.net/community-resources/how-to/">https://openvpn.net/community-resources/how-to/</a>
</p>


<figure id="orgfb24b73">
<img src="images/image-20210219171839266.png" alt="image-20210219171839266.png">

</figure>

<p>
<b>可选择以下两套环境之一实现OpenVPN</b>
</p>
</div>
<div id="outline-container-h:0dca5a8a-af01-475f-8e10-a028790095ce" class="outline-5">
<h5 id="h:0dca5a8a-af01-475f-8e10-a028790095ce">2.1.1 环境1: 阿里云OpenVPN 实战环境</h5>
<div class="outline-text-5" id="text-h:0dca5a8a-af01-475f-8e10-a028790095ce">
<p>
<b>准备阿里云网络实验环境</b>
</p>

<pre class="example" id="org7302434">
1 阿里云创建专有网络
指定城市和可用区
网段名称net1和地址段172.16.0.0/12
交换机名称net1-sw1 可用区A IPv4地址段172.30.0.0/24
阿里云设置安全组规则允许所有ip能连接1194端口
安全组开放22端口
2 创建openvpn服务器有公网IP的实例1个
3 创建局域网的服务器无公网IP的实例2个
4 重设所有实例密码
5 修改安全组打开 1194/tcp/udp端口
</pre>

<p>
<b>准备完成的实例环境</b>
</p>


<figure id="orgcb6649f">
<img src="images/image-20210425153147854.png" alt="image-20210425153147854.png">

</figure>

<p>
俩台内网web服务器可以不设置网关
</p>

<p>
<b>防火墙规则配置</b>
</p>


<figure id="orgb5bba3f">
<img src="images/image-20210425153230134.png" alt="image-20210425153230134.png">

</figure>
</div>
</div>
<div id="outline-container-h:3a955b9b-5093-45eb-94f2-8ac88bce514b" class="outline-5">
<h5 id="h:3a955b9b-5093-45eb-94f2-8ac88bce514b">2.1.2 环境2: 局域网 OpenVPN 实战环境</h5>
<div class="outline-text-5" id="text-h:3a955b9b-5093-45eb-94f2-8ac88bce514b">
<pre class="example" id="org2aa0651">
共四台主机
1 openvpn server：
CentOS 8.2
eth0:10.0.0.8/24 NAT模式,模拟公网IP
eth1:172.30.0.1/24 仅主机模式,私网IP
2 内网主机两台
第一台主机
eth0:172.30.0.100/24 仅主机模式,私网IP，无需网关
第二台主机
eth0:172.30.0.200/24 仅主机模式,私网IP，无需网关
3 Windows 客户端
Windows 10
</pre>
</div>
</div>
</div>
<div id="outline-container-h:afd88d4e-db42-4dff-87c6-32c98839d1f8" class="outline-4">
<h4 id="h:afd88d4e-db42-4dff-87c6-32c98839d1f8">2.2 安装OpenVPN软件包</h4>
<div class="outline-text-4" id="text-h:afd88d4e-db42-4dff-87c6-32c98839d1f8">
</div>
<div id="outline-container-h:7796c98b-9c4c-40a1-90b1-262c77bf4341" class="outline-5">
<h5 id="h:7796c98b-9c4c-40a1-90b1-262c77bf4341">2.1.1 查看版本</h5>
<div class="outline-text-5" id="text-h:7796c98b-9c4c-40a1-90b1-262c77bf4341">
<p>
<b>查看官网的OpenVPN的版本</b>
</p>

<p>
访问官网：<a href="https://openvpn.net">https://openvpn.net</a>
</p>


<figure id="org280234f">
<img src="images/image-20210219172601252.png" alt="image-20210219172601252.png">

</figure>


<figure id="org363c0a4">
<img src="images/image-20210219172609909.png" alt="image-20210219172609909.png">

</figure>

<p>
<b>在不同OS上查看OpenVPN版本</b>
</p>

<p>
CentOS系统上的EPEL源OpenVPN版本比Ubuntu的仓库中版本更新,以下选择在
CentOS8上部署OpenVPN
</p>

<p>
范例: CentOS 查看OpenVPN版本
</p>

<div class="org-src-container">
<pre class="src src-sh">[11:58:01 root@openvpn-server ~]#yum list openvpn
openvpn.x86_64                                    2.4.10-1.el8                                     epel
[12:03:21 root@openvpn-server ~]#yum list easy-rsa
easy-rsa.noarch                                    3.0.8-1.el8                                     epel
</pre>
</div>

<p>
范例: Ubuntu1804 查看OpenVPN版本
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu1804 ~]#apt list openvpn
openvpn/bionic-proposed 2.4.4-2ubuntu1.4 amd64
N: There are 2 additional versions. Please use the <span style="color: #8b2252;">'-a'</span> switch to see the
[root@ubuntu1804 ~]#apt-cache madison openvpn
[root@ubuntu1804 ~]#apt-cache madison easy-rsa
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9f74fd24-ccab-4356-a583-65ad44e6b92f" class="outline-5">
<h5 id="h:9f74fd24-ccab-4356-a583-65ad44e6b92f">2.1.2 安装OpenVPN</h5>
<div class="outline-text-5" id="text-h:9f74fd24-ccab-4356-a583-65ad44e6b92f">

<figure id="orgcced695">
<img src="images/image-20210425172940972.png" alt="image-20210425172940972.png">

</figure>

<p>
安装OpenVPN和证书工具
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">OpenVPN&#26381;&#21153;&#22120;&#31471;</span>
[12:03:52 root@openvpn-server ~]#yum install -y openvpn
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35777;&#20070;&#31649;&#29702;&#24037;&#20855;,&#31614;&#21457;&#26381;&#21153;&#31471;&#21644;&#23458;&#25143;&#31471;&#35777;&#20070;</span>
[12:05:19 root@openvpn-server ~]#yum install -y easy-rsa
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4ff95179-a14f-4c60-a884-161a2783f6d3" class="outline-5">
<h5 id="h:4ff95179-a14f-4c60-a884-161a2783f6d3">2.1.3 查看包中相关文件</h5>
<div class="outline-text-5" id="text-h:4ff95179-a14f-4c60-a884-161a2783f6d3">
<div class="org-src-container">
<pre class="src src-sh">[12:06:00 root@openvpn-server ~]#rpm -ql openvpn
/etc/openvpn/client  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#37197;&#32622;&#25991;&#20214;</span>
/etc/openvpn/server  <span style="color: #b22222;"># </span><span style="color: #b22222;">server&#37197;&#32622;&#25991;&#20214;</span>
/usr/lib/systemd/system/openvpn-client@.service
/usr/lib/systemd/system/openvpn-server@.service     <span style="color: #b22222;"># </span><span style="color: #b22222;">server&#21551;&#21160;&#33050;&#26412; </span>
/usr/sbin/openvpn
/usr/share/doc/openvpn/sample/sample-config-files/client.conf  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27169;&#26495;&#65292;&#23458;&#25143;&#31471;&#37197;&#32622;</span>
/usr/share/doc/openvpn/sample/sample-config-files/server.conf  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27169;&#26495;&#65292;&#26381;&#21153;&#31471;&#37197;&#32622;</span>
/var/lib/openvpn

[12:06:08 root@openvpn-server ~]#rpm -ql easy-rsa
/usr/share/doc/easy-rsa/vars.example         <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21464;&#37327;&#37197;&#32622;&#25991;&#20214;&#65292;&#29992;&#20110;&#37197;&#32622;&#35777;&#20070;&#26377;&#25928;&#24615;</span>
/usr/share/easy-rsa/3
/usr/share/easy-rsa/3.0.8/easyrsa            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31614;&#21457;&#35777;&#20070;&#30340;&#31243;&#24207;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:15f4a2ff-7e82-418f-8600-66d9a3d09b87" class="outline-5">
<h5 id="h:15f4a2ff-7e82-418f-8600-66d9a3d09b87">2.2.2 准备相关配置文件</h5>
<div class="outline-text-5" id="text-h:15f4a2ff-7e82-418f-8600-66d9a3d09b87">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#26381;&#21153;&#22120;&#37197;&#32622;&#25991;&#20214;</span>
cp /usr/share/doc/openvpn/sample/sample-config-files/server.conf /etc/openvpn/
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20934;&#22791;&#35777;&#20070;&#31614;&#21457;&#30456;&#20851;&#25991;&#20214;</span>
cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-server
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20934;&#22791;&#31614;&#21457;&#35777;&#20070;&#30456;&#20851;&#21464;&#37327;&#30340;&#37197;&#32622;&#25991;&#20214;</span>
cp /usr/share/doc/easy-rsa/vars.example /etc/openvpn/easy-rsa-server/3/vars    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25991;&#20214;&#21517;vars</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24314;&#35758;&#20462;&#25913;&#32473;CA&#21644;OpenVPN&#26381;&#21153;&#22120;&#39041;&#21457;&#30340;&#35777;&#20070;&#30340;&#26377;&#25928;&#26399;,&#21487;&#36866;&#24403;&#21152;&#38271;</span>
[root@openvpn-server ~]#vim /etc/openvpn/easy-rsa-server/3/vars
<span style="color: #b22222;">#</span><span style="color: #b22222;">CA&#30340;&#35777;&#20070;&#26377;&#25928;&#26399;&#40664;&#20026;&#20026;10&#24180;,&#21487;&#20197;&#36866;&#24403;&#24310;&#38271;,&#27604;&#22914;:100&#24180;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">set_var EASYRSA_CA_EXPIRE  3650</span>
set_var EASYRSA_CA_EXPIRE   36500
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#35777;&#20070;&#40664;&#20026;&#20026;825&#22825;,&#21487;&#36866;&#24403;&#21152;&#38271;,&#27604;&#22914;:3650&#22825;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">set_var EASYRSA_CERT_EXPIRE    825</span>
set_var EASYRSA_CERT_EXPIRE 3650

[root@openvpn-server ~]#tree /etc/openvpn/
/etc/openvpn/
&#9500;&#9472;&#9472; client
&#9500;&#9472;&#9472; easy-rsa-server
&#9474;   &#9500;&#9472;&#9472; 3 -&gt; 3.0.8
&#9474;   &#9500;&#9472;&#9472; 3.0 -&gt; 3.0.8
&#9474;   &#9492;&#9472;&#9472; 3.0.8
&#9474;       &#9500;&#9472;&#9472; easyrsa
&#9474;       &#9500;&#9472;&#9472; openssl-easyrsa.cnf
&#9474;       &#9500;&#9472;&#9472; vars
&#9474;       &#9492;&#9472;&#9472; x509-types
&#9474;           &#9500;&#9472;&#9472; ca
&#9474;           &#9500;&#9472;&#9472; client
&#9474;           &#9500;&#9472;&#9472; code-signing
&#9474;           &#9500;&#9472;&#9472; COMMON
&#9474;           &#9500;&#9472;&#9472; email
&#9474;           &#9500;&#9472;&#9472; kdc
&#9474;           &#9500;&#9472;&#9472; server
&#9474;           &#9492;&#9472;&#9472; serverClient
&#9500;&#9472;&#9472; server
&#9492;&#9472;&#9472; server.conf
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:bd5e5386-ecf1-4e1a-8fc7-bb92097d3112" class="outline-4">
<h4 id="h:bd5e5386-ecf1-4e1a-8fc7-bb92097d3112">2.3 准备证书相关文件</h4>
<div class="outline-text-4" id="text-h:bd5e5386-ecf1-4e1a-8fc7-bb92097d3112">
</div>
<div id="outline-container-h:f05753c8-6e2b-490f-b88b-a6a6887b0164" class="outline-5">
<h5 id="h:f05753c8-6e2b-490f-b88b-a6a6887b0164">2.3.1 初始化PKI和CA签发机构环境</h5>
<div class="outline-text-5" id="text-h:f05753c8-6e2b-490f-b88b-a6a6887b0164">
</div>
<ul class="org-ul">
<li><a id="h:a07327bd-4225-4296-8b7b-cc9e39e2da16"></a>2.1.4 脚本easyrsa帮助用法<br>
<div class="outline-text-6" id="text-h:a07327bd-4225-4296-8b7b-cc9e39e2da16">
<div class="org-src-container">
<pre class="src src-sh">[root@openvpn-server ~]#cd /etc/openvpn/easy-rsa-server/3
[root@openvpn-server 3]#file ./easyrsa
./easyrsa: POSIX shell script, ASCII text executable
[root@openvpn-server 3]#./easyrsa
USAGE: easyrsa [options] COMMAND [command-options]

A list of commands is shown below. To get detailed usage and help for a
<span style="color: #483d8b;">command</span>, run:
  ./easyrsa help COMMAND

For a listing of options that can be supplied before the command, use:
  ./easyrsa help options

Here is the list of commands available with a short syntax reminder. Use the
<span style="color: #8b2252;">'help'</span> command above to get full usage details.
  init-pki                                         <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#25968;&#25454;,&#22312;&#24403;&#21069;&#30446;&#24405;&#19979;&#29983;&#25104;pki&#30446;&#24405;&#21450;&#30456;&#20851;&#25991;&#20214;,&#21516;&#26102;&#20250;&#35835;&#21462;&#24403;&#21069;&#30446;&#24405;&#30340;vars&#25991;&#20214;</span>
  build-ca [ cmd-opts ]                            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;CA&#35777;&#20070;  &#19981;&#20351;&#29992;&#23494;&#30721;&#28155;&#21152; nopass &#21442;&#25968;</span>
  gen-dh                                           <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;Diifie-Hellman&#23494;&#38053;</span>
  gen-req &lt;filename_base&gt; [ cmd-opts ]             <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#35777;&#20070;</span>
  sign-req &lt;type&gt; &lt;filename_base&gt;                  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#39041;&#21457;&#35777;&#20070;</span>
  build-client-full &lt;filename_base&gt; [ cmd-opts ]
  build-server-full &lt;filename_base&gt; [ cmd-opts ]
  revoke &lt;filename_base&gt; [cmd-opts]
  renew &lt;filename_base&gt; [cmd-opts]
  build-serverClient-full &lt;filename_base&gt; [ cmd-opts ]
  gen-crl
  update-db
  show-req &lt;filename_base&gt; [ cmd-opts ]
  show-cert &lt;filename_base&gt; [ cmd-opts ]
  show-ca [ cmd-opts ]
  import-req &lt;request_file_path&gt; &lt;short_basename&gt;  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23548;&#20837;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;</span>
  export-p7 &lt;filename_base&gt; [ cmd-opts ]
  export-p8 &lt;filename_base&gt; [ cmd-opts ]
  export-p12 &lt;filename_base&gt; [ cmd-opts ]
  set-rsa-pass &lt;filename_base&gt; [ cmd-opts ]
  set-ec-pass &lt;filename_base&gt; [ cmd-opts ]
  upgrade &lt;type&gt;

./easyrsa init-pki         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#25968;&#25454;,&#22312;&#24403;&#21069;&#30446;&#24405;&#19979;&#29983;&#25104;pki&#30446;&#24405;&#21450;&#30456;&#20851;&#25991;&#20214;,&#21516;&#26102;&#20250;&#35835;&#21462;&#24403;&#21069;&#30446;&#24405;&#30340;vars&#25991;&#20214;</span>
./easyrsa build-ca nopass  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;CA&#35777;&#20070;&#65292;&#19981;&#24102;&#23494;&#30721;&#65292;&#19968;&#36335;&#22238;&#36710;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">/etc/openvpn/easy-rsa-server/3/pki/ca.crt </span>

./easyrsa gen-req server nopass  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#26381;&#21153;&#31471;&#35777;&#20070;&#65292;&#19981;&#20351;&#29992;&#23494;&#30721;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">req: /etc/openvpn/easy-rsa-server/3/pki/reqs/server.req     #&#29983;&#25104;&#30340;&#30003;&#35831;&#25991;&#20214;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">key: /etc/openvpn/easy-rsa-server/3/pki/private/server.key  #&#29983;&#25104;&#30340;&#31169;&#38053;&#25991;&#20214;</span>

./easyrsa gen-req client-x nopass <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#23458;&#25143;&#31471;&#35777;&#20070;&#65292;&#19981;&#20351;&#29992;&#23494;&#30721;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">req: /etc/openvpn/easy-rsa-client/3/pki/reqs/client-x.req       #&#30003;&#35831;&#35777;&#20070;&#25991;&#20214;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">key: /etc/openvpn/easy-rsa-client/3/pki/private/client-x.key    #&#31169;&#38053;&#25991;&#20214;</span>

./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/client-x.req client-x <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23548;&#20837;&#23458;&#25143;&#31471;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;&#21040;CA&#30340;&#24037;&#20316;&#30446;&#24405;&#65292;&#35753;CA&#33021;&#35782;&#21035;&#21040;&#36825;&#20010;&#35831;&#27714;&#25991;&#20214;</span>
./easyrsa sign server server <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31614;&#21457;&#26381;&#21153;&#31471;&#35777;&#20070;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">/etc/openvpn/easy-rsa-server/3/pki/issued/server.crt</span>
./easyrsa sign client client-x <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31614;&#21457;&#23458;&#25143;&#31471;&#35777;&#20070;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">/etc/openvpn/easy-rsa-server/3/pki/issued/client-x.crt</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;Diffie-Hellman&#23494;&#38053;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1</span>
./easyrsa gen-dh
    <span style="color: #b22222;">#</span><span style="color: #b22222;">/etc/openvpn/easy-rsa-server/3/pki/dh.pem</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2</span>
openssl dhparam -out /root/dh2048.pem 2048
</pre>
</div>
</div>
</li>
<li><a id="h:fde3ab03-cc6b-4d9f-bfff-f3047c5229bf"></a>初始化PKI生成PKI相关目录和文件<br>
<div class="outline-text-6" id="text-h:fde3ab03-cc6b-4d9f-bfff-f3047c5229bf">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /etc/openvpn/easy-rsa-server/3
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#25968;&#25454;,&#22312;&#24403;&#21069;&#30446;&#24405;&#19979;&#29983;&#25104;pki&#30446;&#24405;&#21450;&#30456;&#20851;&#25991;&#20214;,&#21516;&#26102;&#20250;&#35835;&#21462;&#24403;&#21069;&#30446;&#24405;&#30340;vars&#25991;&#20214;</span>
./easyrsa init-pki


[root@openvpn-server 3]#tree -F
<span style="color: #483d8b;">.</span>
&#9500;&#9472;&#9472; easyrsa*
&#9500;&#9472;&#9472; openssl-easyrsa.cnf
&#9500;&#9472;&#9472; pki/
&#9474;&#160;&#160; &#9500;&#9472;&#9472; openssl-easyrsa.cnf
&#9474;&#160;&#160; &#9500;&#9472;&#9472; private/            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31169;&#38053;&#23384;&#20648;&#20301;&#32622;</span>
&#9474;&#160;&#160; &#9500;&#9472;&#9472; reqs/               <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35831;&#27714;&#25991;&#20214;&#23384;&#20648;&#20301;&#32622;</span>
&#9474;&#160;&#160; &#9492;&#9472;&#9472; safessl-easyrsa.cnf
&#9500;&#9472;&#9472; vars
&#9492;&#9472;&#9472; x509-types/
    &#9500;&#9472;&#9472; ca
    &#9500;&#9472;&#9472; client
    &#9500;&#9472;&#9472; code-signing
    &#9500;&#9472;&#9472; COMMON
    &#9500;&#9472;&#9472; email
    &#9500;&#9472;&#9472; kdc
    &#9500;&#9472;&#9472; server
    &#9492;&#9472;&#9472; serverClient
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:2529657a-b8dc-43a2-9520-bd26a3b39df7" class="outline-5">
<h5 id="h:2529657a-b8dc-43a2-9520-bd26a3b39df7">2.3.2 创建CA机构</h5>
<div class="outline-text-5" id="text-h:2529657a-b8dc-43a2-9520-bd26a3b39df7">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /etc/openvpn/easy-rsa-server/3

[root@openvpn-server 3]#./easyrsa build-ca nopass  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;CA&#35777;&#20070;&#65292;&#19981;&#24102;&#23494;&#30721;&#65292;&#19968;&#36335;&#22238;&#36710; &#12290;&#21152; --batch &#19981;&#38656;&#35201;&#22238;&#36710;</span>

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars
Using SSL: openssl OpenSSL 1.1.1g FIPS  21 Apr 2020
Generating RSA private key, 2048 bit long modulus (2 primes)
...................................................................................................................................................................................................+++++
....................................................................+++++
e is 65537 (0x010001)
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span style="color: #8b2252;">'.'</span>, the field will be left blank.
-----------------------------------------------

Common Name (eg: your user, host, or server name) [Easy-RSA CA]:  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25509;&#21463;&#40664;&#35748;&#20540;&#65292;&#30452;&#25509;&#22238;&#36710;</span>

CA creation complete and you may now import and sign cert requests.
Your new CA certificate file for publishing is at:
/etc/openvpn/easy-rsa-server/3/pki/ca.crt    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#33258;&#31614;&#21517;&#30340;&#35777;&#20070;&#25991;&#20214;</span>

[root@openvpn-server 3]#tree pki/
pki/
&#9500;&#9472;&#9472; ca.crt              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#33258;&#31614;&#21517;&#30340;&#35777;&#20070;&#25991;&#20214;</span>
&#9500;&#9472;&#9472; certs_by_serial
&#9500;&#9472;&#9472; index.txt
&#9500;&#9472;&#9472; index.txt.attr
&#9500;&#9472;&#9472; issued
&#9500;&#9472;&#9472; openssl-easyrsa.cnf
&#9500;&#9472;&#9472; private
&#9474;   &#9492;&#9472;&#9472; ca.key         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#31169;&#38053;&#25991;&#20214;</span>
&#9500;&#9472;&#9472; renewed
&#9474;   &#9500;&#9472;&#9472; certs_by_serial
&#9474;   &#9500;&#9472;&#9472; private_by_serial
&#9474;   &#9492;&#9472;&#9472; reqs_by_serial
&#9500;&#9472;&#9472; reqs
&#9500;&#9472;&#9472; revoked
&#9474;   &#9500;&#9472;&#9472; certs_by_serial
&#9474;   &#9500;&#9472;&#9472; private_by_serial
&#9474;   &#9492;&#9472;&#9472; reqs_by_serial
&#9500;&#9472;&#9472; safessl-easyrsa.cnf
&#9492;&#9472;&#9472; serial

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#19968;&#19979;&#29983;&#25104;CA&#30456;&#20851;&#30340;&#25991;&#20214;</span>
[root@openvpn-server 3]#cat pki/serial
01
[root@openvpn-server 3]#ll pki/index.txt
-rw------- 1 root root 0 Jan 26 12:17 pki/index.txt
[root@openvpn-server 3]#ll pki/ca.crt pki/private/ca.key
-rw------- 1 root root 1204 Jan 26 12:17 pki/ca.crt
-rw------- 1 root root 1679 Jan 26 12:17 pki/private/ca.key
[root@openvpn-server 3]#cat pki/ca.crt
[root@openvpn-server 3]#openssl x509 -in pki/ca.crt -noout -text
</pre>
</div>
</div>
</div>
<div id="outline-container-h:eb24643a-16fa-419e-81df-e64d2543f9a2" class="outline-5">
<h5 id="h:eb24643a-16fa-419e-81df-e64d2543f9a2">2.3.3 创建服务端证书申请</h5>
<div class="outline-text-5" id="text-h:eb24643a-16fa-419e-81df-e64d2543f9a2">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#26381;&#21153;&#22120;&#35777;&#20070;&#30003;&#35831;&#25991;&#20214;&#65292;&#20854;&#20013;server&#26159;&#25991;&#20214;&#21069;&#32512;</span>
<span style="color: #483d8b;">cd</span> /etc/openvpn/easy-rsa-server/3
[root@openvpn-server 3]#./easyrsa gen-req server nopass  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29983;&#25104;&#26381;&#21153;&#31471;&#35777;&#20070;&#65292;&#19981;&#20351;&#29992;&#23494;&#30721;</span>

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars
Using SSL: openssl OpenSSL 1.1.1g FIPS  21 Apr 2020
Generating a RSA private key
writing new private key to <span style="color: #8b2252;">'/etc/openvpn/easy-rsa-server/3/pki/easy-rsa-11496.syBWUN/tmp.KB9HvC'</span>
------------------------------------------------------------------------------------------------

You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span style="color: #8b2252;">'.'</span>, the field will be left blank.
-----------------------------------------------

Common Name (eg: your user, host, or server name) [server]:   &#25509;&#21463;Common Name&#65292;&#21487;&#20197;&#20351;&#29992;&#40664;&#35748;

Keypair and certificate request completed. Your files are:
req: /etc/openvpn/easy-rsa-server/3/pki/reqs/server.req     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#30340;&#30003;&#35831;&#25991;&#20214;</span>
key: /etc/openvpn/easy-rsa-server/3/pki/private/server.key  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#30340;&#31169;&#38053;&#25991;&#20214;</span>

[12:29:17 root@openvpn-server 3]#tree pki/
pki/
&#9500;&#9472;&#9472; ca.crt
&#9500;&#9472;&#9472; certs_by_serial
&#9500;&#9472;&#9472; index.txt
&#9500;&#9472;&#9472; index.txt.attr
&#9500;&#9472;&#9472; issued
&#9500;&#9472;&#9472; openssl-easyrsa.cnf
&#9500;&#9472;&#9472; private
&#9474;   &#9500;&#9472;&#9472; ca.key
&#9474;   &#9492;&#9472;&#9472; server.key   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31169;&#38053;&#25991;&#20214;</span>
&#9500;&#9472;&#9472; renewed
&#9474;   &#9500;&#9472;&#9472; certs_by_serial
&#9474;   &#9500;&#9472;&#9472; private_by_serial
&#9474;   &#9492;&#9472;&#9472; reqs_by_serial
&#9500;&#9472;&#9472; reqs
&#9474;   &#9492;&#9472;&#9472; server.req  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30003;&#35831;&#25991;&#20214;</span>
&#9500;&#9472;&#9472; revoked
&#9474;   &#9500;&#9472;&#9472; certs_by_serial
&#9474;   &#9500;&#9472;&#9472; private_by_serial
&#9474;   &#9492;&#9472;&#9472; reqs_by_serial
&#9500;&#9472;&#9472; safessl-easyrsa.cnf
&#9492;&#9472;&#9472; serial
</pre>
</div>
</div>
</div>
<div id="outline-container-h:149f9b29-7914-4357-9522-2057ec63072e" class="outline-5">
<h5 id="h:149f9b29-7914-4357-9522-2057ec63072e">2.3.4 签发服务端证书</h5>
<div class="outline-text-5" id="text-h:149f9b29-7914-4357-9522-2057ec63072e">
<p>
<b>查看颁发证书命令用法</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /etc/openvpn/easy-rsa-server/3
[root@openvpn-server 3]#./easyrsa help sign

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars

sign-req  
Sign a certificate request of the defined type.  must be a known
<span style="color: #483d8b;">type</span> such as <span style="color: #8b2252;">'client'</span>, <span style="color: #8b2252;">'server'</span>, <span style="color: #8b2252;">'serverClient'</span>, or <span style="color: #8b2252;">'ca'</span> (or a user-added type.)

This request file must exist<span style="color: #a020f0;"> in</span> the reqs/ dir and have a .req file
extension. See import-req below for importing reqs from other sources.
</pre>
</div>

<p>
<b>颁发服务端证书</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#19978;&#38754;server.req&#30340;&#30003;&#35831;,&#39041;&#21457;server&#31867;&#22411;&#30340;&#35777;&#20070;</span>
<span style="color: #483d8b;">cd</span> /etc/openvpn/easy-rsa-server/3
[root@openvpn-server 3]#./easyrsa sign server server <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31614;&#21457;&#26381;&#21153;&#31471;&#35777;&#20070;</span>

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars
Using SSL: openssl OpenSSL 1.1.1g FIPS  21 Apr 2020

You are about to sign the following certificate.
Please check over the details shown below for accuracy. Note that this request
has not been cryptographically verified. Please be sure it came from a trusted
<span style="color: #483d8b;">source</span> or that you have verified the request checksum with the sender.

Request subject, to be signed as a server certificate for 3650 days: <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#21040;vars&#25991;&#20214;&#25351;&#23450;&#30340;&#26377;&#25928;&#26399;</span>

<span style="color: #a0522d;">subject</span>=
commonName                = server

Type the word <span style="color: #8b2252;">'yes'</span> to continue, or any other input to abort.
Confirm request details: yes  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20837;yes&#22238;&#36710;</span>
Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-11533.UjZ9m9/tmp.xGm4NL
Check that the request matches the signature
Signature ok
The Subject<span style="color: #8b2252;">'s Distinguished Name is as follows</span>
<span style="color: #8b2252;">commonName            :ASN.1 12:'</span>server<span style="color: #8b2252;">'</span>
<span style="color: #8b2252;">Certificate is to be certified until Jan 24 04:31:32 2031 GMT (3650 days)</span>

<span style="color: #8b2252;">Write out database with 1 new entries</span>
<span style="color: #8b2252;">Data Base Updated</span>

<span style="color: #8b2252;">Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt</span>
<span style="color: #8b2252;">#&#29983;&#25104;&#26381;&#21153;&#22120;&#35777;&#20070;&#25991;&#20214;</span>
</pre>
</div>

<p>
<b>验证结果</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@openvpn-server 3]#cd /etc/openvpn/easy-rsa-server/3
[root@openvpn-server 3]#tree pki/
pki/
&#9500;&#9472;&#9472; ca.crt
&#9500;&#9472;&#9472; certs_by_serial
&#9474;   &#9492;&#9472;&#9472; 5D3B930AA9D6B0AF69E65FA76C6251C4.pem   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#35777;&#20070;&#25991;&#20214;</span>
&#9500;&#9472;&#9472; index.txt
&#9500;&#9472;&#9472; index.txt.attr
&#9500;&#9472;&#9472; index.txt.attr.old
&#9500;&#9472;&#9472; index.txt.old
&#9500;&#9472;&#9472; issued
&#9474;   &#9492;&#9472;&#9472; server.crt          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#35777;&#20070;&#25991;&#20214;</span>
&#9500;&#9472;&#9472; openssl-easyrsa.cnf
&#9500;&#9472;&#9472; private
&#9474;   &#9500;&#9472;&#9472; ca.key
&#9474;   &#9492;&#9472;&#9472; server.key
&#9500;&#9472;&#9472; renewed
&#9474;   &#9500;&#9472;&#9472; certs_by_serial
&#9474;   &#9500;&#9472;&#9472; private_by_serial
&#9474;   &#9492;&#9472;&#9472; reqs_by_serial
&#9500;&#9472;&#9472; reqs
&#9474;   &#9492;&#9472;&#9472; server.req
&#9500;&#9472;&#9472; revoked
&#9474;   &#9500;&#9472;&#9472; certs_by_serial
&#9474;   &#9500;&#9472;&#9472; private_by_serial
&#9474;   &#9492;&#9472;&#9472; reqs_by_serial
&#9500;&#9472;&#9472; safessl-easyrsa.cnf
&#9500;&#9472;&#9472; serial
&#9492;&#9472;&#9472; serial.old

[root@openvpn-server 3]#diff pki/certs_by_serial/5D3B930AA9D6B0AF69E65FA76C6251C4.pem pki/issued/server.crt
[root@openvpn-server 3]#ll !*
ll pki/certs_by_serial/5D3B930AA9D6B0AF69E65FA76C6251C4.pem pki/issued/server.crt
-rw------- 1 root root 4608 Jan 26 12:31 pki/certs_by_serial/5D3B930AA9D6B0AF69E65FA76C6251C4.pem
-rw------- 1 root root 4608 Jan 26 12:31 pki/issued/server.crt

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35777;&#20070;&#30456;&#20851;&#25991;&#20214;</span>
[root@openvpn-server 3]#cat pki/serial
5D3B930AA9D6B0AF69E65FA76C6251C5
[12:35:09 root@openvpn-server 3]#cat pki/index.txt
V   310124043132Z       5D3B930AA9D6B0AF69E65FA76C6251C4    unknown /CN=server
[root@openvpn-server 3]#cat pki/serial.old
5d3b930aa9d6b0af69e65fa76c6251c4
</pre>
</div>
</div>
</div>
<div id="outline-container-h:80a41a46-c76f-4fdd-8fc4-7ada9432a471" class="outline-5">
<h5 id="h:80a41a46-c76f-4fdd-8fc4-7ada9432a471">2.3.5 创建Diifie-Hellman密钥</h5>
<div class="outline-text-5" id="text-h:80a41a46-c76f-4fdd-8fc4-7ada9432a471">
<p>
<b>Diffie-Hellman 算法</b>
</p>

<blockquote>
<p>
Diffie-Hellman 密钥交换方法，由惠特菲尔德·迪菲（Bailey Whitfield Diffie）、马丁·赫尔曼（Martin Edward Hellman）于1976年发表。它是一种安全协议，让双方在完全没有对方任何预先信息的条件下通过不安全信道建立起一个密钥，这个密钥一般作为“对称加密”的密钥而被双方在后续数据传输中使用。DH数学原理是base离散对数问题。做类似功能的还有非对称加密类算法，如：RSA。其应用非常广泛，在SSH、VPN、Https等都有应用。
</p>

<p>
wiki参考链接: <a href="https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange">https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange</a>
</p>
</blockquote>

<p>
<b>创建Diffie-Hellman密钥</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /etc/openvpn/easy-rsa-server/3

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;Diffie-Hellman&#23494;&#38053;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1</span>
[root@openvpn-server 3]#./easyrsa gen-dh

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars
Using SSL: openssl OpenSSL 1.1.1g FIPS  21 Apr 2020
Generating DH parameters, 2048 bit long safe prime, generator 2
This is going to take a long time
...................+  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38656;&#35201;&#31561;&#19968;&#20250;</span>
DH parameters of size 2048 created at /etc/openvpn/easy-rsa-server/3/pki/dh.pem
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#29983;&#25104;&#30340;&#25991;&#20214;</span>
[root@openvpn-server 3]#ll pki/dh.pem
-rw------- 1 root root 424 Jan 26 12:37 pki/dh.pem
[root@openvpn-server 3]#cat pki/dh.pem
-----BEGIN DH PARAMETERS-----
MIIBCAKCAQEAypLcHbOieMk67cANDM+IBDD0w6SP3vJ9vY4Bz58SX017qLI9qLSD
CCRWIF7Y57zVHkqrXHsVJpSXZPBGTWPKg6LsMYrSrQctxajikAzkA2xqlezJquFz
oGkhR9P1xkA7Kbj0+w0/0lOxkPuVq6WbqSa2JBNaYmOzXRz1I4BZnR0CCKoI/WMB
WZ2cTeQcVI1AYqN9prOwWZwXZks420RUmnDXAL7BtvfElyKtgiZXPzQpiF4Psjhb
gNAwBnHJiV1vj1dTLg6CtU9e+yuk7nuz+74OhF3y2jfF3odg+7ZGWNlkoMP1wq6Z
<span style="color: #a0522d;">eONjJO9n3cxLInPXDhJ4NfbwTh6LOKQ6YwIBAg</span>==
-----END DH PARAMETERS-----
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2</span>
[root@openvpn-server 3]#openssl dhparam -out /root/dh2048.pem 2048
</pre>
</div>
</div>
</div>
<div id="outline-container-h:df383671-1126-40d8-9323-28f7be5e8f52" class="outline-5">
<h5 id="h:df383671-1126-40d8-9323-28f7be5e8f52">2.3.6 准备客户端证书环境</h5>
<div class="outline-text-5" id="text-h:df383671-1126-40d8-9323-28f7be5e8f52">
<p>
上面服务端证书配置完成，下面是配置客户端证书。方便管理才分开位置，不分也可以的。
</p>
<div class="org-src-container">
<pre class="src src-sh">cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-client

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#36873;</span>
cp /usr/share/doc/easy-rsa/vars.example /etc/openvpn/easy-rsa-client/3/vars

<span style="color: #483d8b;">cd</span> /etc/openvpn/easy-rsa-client/3

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#25968;&#25454;,&#22312;&#24403;&#21069;&#30446;&#24405;&#19979;&#29983;&#25104;pki&#30446;&#24405;&#21450;&#30456;&#20851;&#25991;&#20214;,&#21516;&#26102;&#20250;&#35835;&#21462;&#24403;&#21069;&#30446;&#24405;&#30340;vars&#25991;&#20214;</span>
./easyrsa init-pki
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#35777;&#20070;&#30003;&#35831;&#25152;&#38656;&#30446;&#24405;pki&#21644;&#25991;&#20214;</span>
[root@openvpn-server 3]#tree
<span style="color: #483d8b;">.</span>
&#9500;&#9472;&#9472; easyrsa
&#9500;&#9472;&#9472; openssl-easyrsa.cnf
&#9500;&#9472;&#9472; pki
&#9474;   &#9500;&#9472;&#9472; openssl-easyrsa.cnf
&#9474;   &#9500;&#9472;&#9472; private
&#9474;   &#9500;&#9472;&#9472; reqs
&#9474;   &#9492;&#9472;&#9472; safessl-easyrsa.cnf
&#9500;&#9472;&#9472; vars
&#9492;&#9472;&#9472; x509-types
&#9500;&#9472;&#9472; ca
&#9500;&#9472;&#9472; client
&#9500;&#9472;&#9472; code-signing
&#9500;&#9472;&#9472; COMMON
&#9500;&#9472;&#9472; email
&#9500;&#9472;&#9472; kdc
&#9500;&#9472;&#9472; server
&#9492;&#9472;&#9472; serverClient

4 directories, 13 files
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0479397a-31de-4e6f-bbce-5d06c8db4b29" class="outline-5">
<h5 id="h:0479397a-31de-4e6f-bbce-5d06c8db4b29">2.3.7 创建客户端证书申请</h5>
<div class="outline-text-5" id="text-h:0479397a-31de-4e6f-bbce-5d06c8db4b29">
<div class="org-src-container">
<pre class="src src-sh">[root@openvpn-server 3]#cd /etc/openvpn/easy-rsa-client/3
[root@openvpn-server 3]#pwd
/etc/openvpn/easy-rsa-client/3

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#23458;&#25143;&#31471;&#29992;&#25143;&#30340;&#35777;&#20070;&#30003;&#35831;</span>
[root@openvpn-server 3]#./easyrsa gen-req client-x nopass

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.8/vars
Using SSL: openssl OpenSSL 1.1.1g FIPS  21 Apr 2020
Generating a RSA private key
....+++++
......+++++
writing new private key to <span style="color: #8b2252;">'/etc/openvpn/easy-rsa-client/3/pki/easy-rsa-11853.FRpJUj/tmp.Jr13E6'</span>
------------------------------------------------------------------------------------------------

You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span style="color: #8b2252;">'.'</span>, the field will be left blank.
-----------------------------------------------

Common Name (eg: your user, host, or server name) [client-x]:  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25509;&#21463;&#40664;&#35748;&#22238;&#36710;</span>

Keypair and certificate request completed. Your files are:
req: /etc/openvpn/easy-rsa-client/3/pki/reqs/client-x.req       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30003;&#35831;&#35777;&#20070;&#25991;&#20214;</span>
key: /etc/openvpn/easy-rsa-client/3/pki/private/client-x.key    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31169;&#38053;&#25991;&#20214;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#20004;&#20010;&#26032;&#25991;&#20214;</span>
[root@openvpn-server 3]#tree
<span style="color: #483d8b;">.</span>
&#9500;&#9472;&#9472; easyrsa
&#9500;&#9472;&#9472; openssl-easyrsa.cnf
&#9500;&#9472;&#9472; pki
&#9474;   &#9500;&#9472;&#9472; openssl-easyrsa.cnf
&#9474;   &#9500;&#9472;&#9472; private
&#9474;   &#9474;   &#9492;&#9472;&#9472; client-x.key
&#9474;   &#9500;&#9472;&#9472; reqs
&#9474;   &#9474;   &#9492;&#9472;&#9472; client-x.req
&#9474;   &#9492;&#9472;&#9472; safessl-easyrsa.cnf
&#9500;&#9472;&#9472; vars
&#9492;&#9472;&#9472; x509-types
&#9500;&#9472;&#9472; ca
&#9500;&#9472;&#9472; client
&#9500;&#9472;&#9472; code-signing
&#9500;&#9472;&#9472; COMMON
&#9500;&#9472;&#9472; email
&#9500;&#9472;&#9472; kdc
&#9500;&#9472;&#9472; server
&#9492;&#9472;&#9472; serverClient
</pre>
</div>
</div>
</div>
<div id="outline-container-h:68762176-7a9d-40af-86d6-bc502da524a5" class="outline-5">
<h5 id="h:68762176-7a9d-40af-86d6-bc502da524a5">2.3.8 签发客户端证书</h5>
<div class="outline-text-5" id="text-h:68762176-7a9d-40af-86d6-bc502da524a5">
<div class="org-src-container">
<pre class="src src-sh">[root@openvpn-server 3]#cd /etc/openvpn/easy-rsa-server/3
[root@openvpn-server 3]#pwd
/etc/openvpn/easy-rsa-server/3

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20837;&#23458;&#25143;&#31471;&#35777;&#20070;&#35831;&#27714;&#25991;&#20214;&#21040;CA&#30340;&#24037;&#20316;&#30446;&#24405;&#65292;&#35753;CA&#33021;&#35782;&#21035;&#21040;&#36825;&#20010;&#35831;&#27714;&#25991;&#20214;</span>
[root@openvpn-server 3]#./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/client-x.req client-x

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars
Using SSL: openssl OpenSSL 1.1.1g FIPS  21 Apr 2020

The request has been successfully imported with a short name of: client-x
You may now use this name to perform signing operations on this request.

[root@openvpn-server 3]#tree pki/
pki/
&#9500;&#9472;&#9472; ca.crt
&#9500;&#9472;&#9472; certs_by_serial
&#9474;   &#9492;&#9472;&#9472; 5D3B930AA9D6B0AF69E65FA76C6251C4.pem
&#9500;&#9472;&#9472; dh.pem
&#9500;&#9472;&#9472; index.txt
&#9500;&#9472;&#9472; index.txt.attr
&#9500;&#9472;&#9472; index.txt.attr.old
&#9500;&#9472;&#9472; index.txt.old
&#9500;&#9472;&#9472; issued
&#9474;   &#9492;&#9472;&#9472; server.crt
&#9500;&#9472;&#9472; openssl-easyrsa.cnf
&#9500;&#9472;&#9472; private
&#9474;   &#9500;&#9472;&#9472; ca.key
&#9474;   &#9492;&#9472;&#9472; server.key
&#9500;&#9472;&#9472; renewed
&#9474;   &#9500;&#9472;&#9472; certs_by_serial
&#9474;   &#9500;&#9472;&#9472; private_by_serial
&#9474;   &#9492;&#9472;&#9472; reqs_by_serial
&#9500;&#9472;&#9472; reqs
&#9474;   &#9500;&#9472;&#9472; server.req
&#9474;   &#9492;&#9472;&#9472; client-x.req    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20837;&#30340;&#25991;&#20214;</span>
&#9500;&#9472;&#9472; revoked
&#9474;   &#9500;&#9472;&#9472; certs_by_serial
&#9474;   &#9500;&#9472;&#9472; private_by_serial
&#9474;   &#9492;&#9472;&#9472; reqs_by_serial
&#9500;&#9472;&#9472; safessl-easyrsa.cnf
&#9500;&#9472;&#9472; serial
&#9492;&#9472;&#9472; serial.old

[root@openvpn-server 3]#ll pki/reqs/client-x.req /etc/openvpn/easy-rsa-client/3/pki/reqs/client-x.req
-rw------- 1 root root 891 Jan 26 13:53 /etc/openvpn/easy-rsa-client/3/pki/reqs/client-x.req
-rw------- 1 root root 891 Jan 26 13:55 pki/reqs/client-x.req

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#32473;&#23458;&#25143;&#31471;&#39041;&#21457;&#30340;&#35777;&#20070;&#30340;&#26377;&#25928;&#26399;</span>
[root@openvpn-server 3]#vim vars
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24314;&#35758;&#20462;&#25913;&#32473;&#23458;&#25143;&#31471;&#39041;&#21457;&#35777;&#20070;&#30340;&#26377;&#25928;&#26399;,&#21487;&#36866;&#24403;&#20943;&#23569;,&#27604;&#22914;:90&#22825;</span>
set_var EASYRSA_CERT_EXPIRE 180    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#20043;&#21069;&#30340;3650&#20026;180</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31614;&#21457;&#23458;&#25143;&#31471;&#35777;&#20070;</span>
[root@openvpn-server 3]#./easyrsa sign client client-x

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars
Using SSL: openssl OpenSSL 1.1.1g FIPS  21 Apr 2020

You are about to sign the following certificate.
Please check over the details shown below for accuracy. Note that this request
has not been cryptographically verified. Please be sure it came from a trusted
<span style="color: #483d8b;">source</span> or that you have verified the request checksum with the sender.

Request subject, to be signed as a client certificate for 180 days:

<span style="color: #a0522d;">subject</span>=
commonName                = client-x

Type the word <span style="color: #8b2252;">'yes'</span> to continue, or any other input to abort.
Confirm request details: yes    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20837;yes&#21518;&#22238;&#36710;</span>
Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-11993.LhxZXn/tmp.Fl00WC
Check that the request matches the signature
Signature ok
The Subject<span style="color: #8b2252;">'s Distinguished Name is as follows</span>
<span style="color: #8b2252;">commonName            :ASN.1 12:'</span>client-x<span style="color: #8b2252;">'</span>
<span style="color: #8b2252;">Certificate is to be certified until Jul 25 05:59:46 2021 GMT (180 days)</span>

<span style="color: #8b2252;">Write out database with 1 new entries</span>
<span style="color: #8b2252;">Data Base Updated</span>

<span style="color: #8b2252;">Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/client-x.crt</span>
<span style="color: #8b2252;">#&#35777;&#20070;&#25991;&#20214;</span>

<span style="color: #8b2252;">[root@openvpn-server 3]#tree pki/</span>
<span style="color: #8b2252;">pki/</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; ca.crt</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; certs_by_serial</span>
<span style="color: #8b2252;">&#9474;   &#9500;&#9472;&#9472; 5D3B930AA9D6B0AF69E65FA76C6251C4.pem</span>
<span style="color: #8b2252;">&#9474;   &#9492;&#9472;&#9472; 8EB7E418B1FE1715BCBB73A513498893.pem</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; dh.pem</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; index.txt</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; index.txt.attr</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; index.txt.attr.old</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; index.txt.old</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; issued</span>
<span style="color: #8b2252;">&#9474;   &#9500;&#9472;&#9472; server.crt</span>
<span style="color: #8b2252;">&#9474;   &#9492;&#9472;&#9472; client-x.crt     #&#29983;&#25104;&#23458;&#25143;&#31471;&#35777;&#20070;</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; openssl-easyrsa.cnf</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; private</span>
<span style="color: #8b2252;">&#9474;   &#9500;&#9472;&#9472; ca.key</span>
<span style="color: #8b2252;">&#9474;   &#9492;&#9472;&#9472; server.key</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; renewed</span>
<span style="color: #8b2252;">&#9474;   &#9500;&#9472;&#9472; certs_by_serial</span>
<span style="color: #8b2252;">&#9474;   &#9500;&#9472;&#9472; private_by_serial</span>
<span style="color: #8b2252;">&#9474;   &#9492;&#9472;&#9472; reqs_by_serial</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; reqs</span>
<span style="color: #8b2252;">&#9474;   &#9500;&#9472;&#9472; server.req</span>
<span style="color: #8b2252;">&#9474;   &#9492;&#9472;&#9472; client-x.req</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; revoked</span>
<span style="color: #8b2252;">&#9474;   &#9500;&#9472;&#9472; certs_by_serial</span>
<span style="color: #8b2252;">&#9474;   &#9500;&#9472;&#9472; private_by_serial</span>
<span style="color: #8b2252;">&#9474;   &#9492;&#9472;&#9472; reqs_by_serial</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; safessl-easyrsa.cnf</span>
<span style="color: #8b2252;">&#9500;&#9472;&#9472; serial</span>
<span style="color: #8b2252;">&#9492;&#9472;&#9472; serial.old</span>

<span style="color: #8b2252;">[root@openvpn-server 3]#cat pki/index.txt</span>
<span style="color: #8b2252;">V   310124043132Z       5D3B930AA9D6B0AF69E65FA76C6251C4    unknown /CN=server</span>
<span style="color: #8b2252;">V   210725055946Z       8EB7E418B1FE1715BCBB73A513498893    unknown /CN=client-x</span>
<span style="color: #8b2252;">[root@openvpn-server 3]#ll pki/issued/</span>
<span style="color: #8b2252;">total 16</span>
<span style="color: #8b2252;">-rw------- 1 root root 4608 Jan 26 12:31 server.crt</span>
<span style="color: #8b2252;">-rw------- 1 root root 4499 Jan 26 13:59 client-x.crt</span>
<span style="color: #8b2252;">[root@openvpn-server 3]#ll pki/certs_by_serial/</span>
<span style="color: #8b2252;">total 16</span>
<span style="color: #8b2252;">-rw------- 1 root root 4608 Jan 26 12:31 5D3B930AA9D6B0AF69E65FA76C6251C4.pem</span>
<span style="color: #8b2252;">-rw------- 1 root root 4499 Jan 26 13:59 8EB7E418B1FE1715BCBB73A513498893.pem</span>
</pre>
</div>

<p>
如果需要颁发的客户端证书较多,可以使用下面脚本实现客户端证书的批量颁发
</p>

<p>
<b>客户端证书自动颁发脚本</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat openvpn-user-crt.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>

<span style="color: #483d8b;">read</span> -p <span style="color: #8b2252;">"&#35831;&#36755;&#20837;&#29992;&#25143;&#30340;&#22995;&#21517;&#25340;&#38899;(&#22914;:${NAME}): "</span> NAME
<span style="color: #483d8b;">cd</span> /etc/openvpn/easy-rsa-client/3
./easyrsa gen-req ${<span style="color: #a0522d;">NAME</span>} nopass &lt;&lt;EOF
<span style="color: #ffa54f;">EOF</span>
<span style="color: #483d8b;">cd</span> /etc/openvpn/easy-rsa-server/3
./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/${<span style="color: #a0522d;">NAME</span>}.req ${<span style="color: #a0522d;">NAME</span>}
./easyrsa sign client ${<span style="color: #a0522d;">NAME</span>} &lt;&lt;EOF
<span style="color: #ffa54f;">yes</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0071d4c1-6f4d-402b-87f3-2bb8d6c05182" class="outline-5">
<h5 id="h:0071d4c1-6f4d-402b-87f3-2bb8d6c05182">2.3.9 将CA和服务器证书相关文件复制到服务器相应的目录</h5>
<div class="outline-text-5" id="text-h:0071d4c1-6f4d-402b-87f3-2bb8d6c05182">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#25991;&#20214;&#24402;&#31867;&#65292;&#25918;&#21040;&#32479;&#19968;&#30446;&#24405;&#26041;&#20415;&#20351;&#29992;</span>
mkdir /etc/openvpn/certs
cp /etc/openvpn/easy-rsa-server/3/pki/ca.crt /etc/openvpn/certs/
cp /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt /etc/openvpn/certs/
cp /etc/openvpn/easy-rsa-server/3/pki/private/server.key /etc/openvpn/certs/
cp /etc/openvpn/easy-rsa-server/3/pki/dh.pem /etc/openvpn/certs/

[root@openvpn-server ~]#ll /etc/openvpn/certs/
-rw------- 1 root root 1204 Jan 26 14:03 ca.crt
-rw------- 1 root root  424 Jan 26 14:04 dh.pem
-rw------- 1 root root 4608 Jan 26 14:04 server.crt
-rw------- 1 root root 1704 Jan 26 14:04 server.key
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2da86924-c043-4fcd-a952-ccaa0747357b" class="outline-5">
<h5 id="h:2da86924-c043-4fcd-a952-ccaa0747357b">2.3.10 将客户端私钥与证书相关文件复制到服务器相关的目录</h5>
<div class="outline-text-5" id="text-h:2da86924-c043-4fcd-a952-ccaa0747357b">
<div class="org-src-container">
<pre class="src src-sh">[root@openvpn-server ~]#mkdir /etc/openvpn/client/client-x
[root@openvpn-server ~]#find /etc/openvpn/ -name <span style="color: #8b2252;">"client-x.key"</span> -o -name <span style="color: #8b2252;">"client-x.crt"</span> -o -name <span style="color: #8b2252;">"ca.crt"</span>
/etc/openvpn/easy-rsa-server/3.0.8/pki/issued/client-x.crt
/etc/openvpn/easy-rsa-server/3.0.8/pki/ca.crt
/etc/openvpn/easy-rsa-client/3.0.8/pki/private/client-x.key
/etc/openvpn/certs/ca.crt

[root@openvpn-server ~]#find /etc/openvpn/ <span style="color: #8b2252;">\(</span> -name <span style="color: #8b2252;">"client-x.key"</span> -o -name <span style="color: #8b2252;">"client-x.crt"</span> -o -name <span style="color: #8b2252;">"ca.crt"</span> <span style="color: #8b2252;">\)</span> -exec cp {} /etc/openvpn/client/client-x <span style="color: #8b2252;">\;</span>
[14:09:08 root@openvpn-server ~]#ll /etc/openvpn/client/client-x/
total 16
-rw------- 1 root root 1204 Jan 26 14:09 ca.crt
-rw------- 1 root root 4499 Jan 26 14:09 client-x.crt
-rw------- 1 root root 1704 Jan 26 14:09 client-x.key
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:b5da11a4-e665-4179-bdfe-33c6cafd56b3" class="outline-4">
<h4 id="h:b5da11a4-e665-4179-bdfe-33c6cafd56b3">2.4 准备 OpenVPN 服务器配置文件</h4>
<div class="outline-text-4" id="text-h:b5da11a4-e665-4179-bdfe-33c6cafd56b3">
</div>
<div id="outline-container-h:f24b4b61-b4cb-4bc0-9f0f-edab119cf542" class="outline-5">
<h5 id="h:f24b4b61-b4cb-4bc0-9f0f-edab119cf542">2.4.1 服务器端配置文件说明</h5>
<div class="outline-text-5" id="text-h:f24b4b61-b4cb-4bc0-9f0f-edab119cf542">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">server.conf&#25991;&#20214;&#20013;&#20197;#&#25110;;&#24320;&#22836;&#30340;&#34892;&#37117;&#20026;&#27880;&#37322;</span>

[root@centos8 ~]#grep -Ev <span style="color: #8b2252;">"^#|^$"</span> /etc/openvpn/server.conf
;<span style="color: #483d8b;">local</span> a.b.c.d                            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26412;&#26426;&#30417;&#21548;IP,&#40664;&#35748;&#27880;&#37322;&#30417;&#21548;&#26412;&#26426;&#25152;&#26377;IP&#65292;&#20063;&#21487;local 0.0.0.0</span>
port 1194                                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31471;&#21475;</span>
;proto tcp                                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21327;&#35758;,&#29983;&#20135;&#25512;&#33616;&#20351;&#29992;TCP</span>
proto udp                                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#21327;&#35758;&#65292;&#36895;&#24230;&#24555;&#65292;&#25968;&#25454;&#21253;&#19981;&#20570;&#26657;&#39564;</span>
;dev tap                                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#19968;&#20010;&#20197;&#22826;&#32593;&#38567;&#36947;&#65292;&#20197;&#22826;&#32593;&#20351;&#29992;tap,&#19968;&#20010;tap&#35774;&#22791;&#20801;&#35768;&#23436;&#25972;&#30340;&#20197;&#22826;&#32593;&#24103;&#36890;&#36807;Openvpn&#38567;&#36947;&#65292;</span>
                                              &#21487;&#25552;&#20379;&#38750;ip&#21327;&#35758;&#30340;&#25903;&#25345;&#65292;&#27604;&#22914;IPX&#21327;&#35758;&#21644;AppleTalk&#21327;&#35758;,tap&#31561;&#21516;&#20110;&#19968;&#20010;&#20197;&#22826;&#32593;&#35774;&#22791;&#65292;&#23427;&#25805;&#20316;&#31532;&#20108;&#23618;&#25968;&#25454;&#21253;&#22914;&#20197;&#22826;&#32593;&#25968;&#25454;&#24103;&#12290;
dev tun                                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#19968;&#20010;&#36335;&#30001;IP&#38567;&#36947;&#65292;&#29983;&#20135;&#25512;&#23384;&#20351;&#29992;tun.&#20114;&#32852;&#32593;&#20351;&#29992;tun,&#19968;&#20010;tun&#35774;&#22791;&#22823;&#22810;&#26102;&#20505;&#65292;</span>
                                              &#34987;&#29992;&#20110;&#22522;&#20110;IP&#21327;&#35758;&#30340;&#36890;&#35759;&#12290;tun&#27169;&#25311;&#20102;&#32593;&#32476;&#23618;&#35774;&#22791;&#65292;&#25805;&#20316;&#31532;&#19977;&#23618;&#25968;&#25454;&#21253;&#27604;&#22914;IP&#25968;&#25454;&#23553;&#21253;&#12290;
;dev-node MyTap                           <span style="color: #b22222;">#</span><span style="color: #b22222;">TAP-Win32&#36866;&#37197;&#22120;&#12290;&#38750;windows&#19981;&#38656;&#35201;&#37197;&#32622;</span>
ca ca.crt                                 <span style="color: #b22222;">#</span><span style="color: #b22222;">ca&#35777;&#20070;&#25991;&#20214;</span>
cert server.crt                           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#35777;&#20070;&#25991;&#20214;</span>
key server.key                            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#31169;&#38053;&#25991;&#20214;</span>
dh dh2048.pem                             <span style="color: #b22222;">#</span><span style="color: #b22222;">dh&#21442;&#25968;&#25991;&#20214;&#65292;&#22914;&#26524;dh none&#20195;&#34920;&#19981;&#38656;&#35201;dh&#25991;&#20214;</span>
;topology subnet                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#30693;&#23376;&#32593;&#25299;&#25169;&#65292;&#19981;&#38656;&#35201;&#37197;&#32622;</span>
server 10.8.0.0 255.255.255.0             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#36830;&#25509;&#21518;&#20998;&#37197;IP&#30340;&#22320;&#22336;&#27744;&#65292;&#26381;&#21153;&#22120;&#40664;&#35748;&#20250;&#21344;&#29992;&#31532;&#19968;&#20010;IP10.8.0.1&#23558;&#20570;&#20026;&#23458;&#25143;&#31471;&#30340;&#32593;&#20851;</span>
ifconfig-pool-persist ipp.txt             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#23458;&#25143;&#31471;&#20998;&#37197;&#22266;&#23450;IP&#65292;&#19981;&#38656;&#35201;&#37197;&#32622;,&#24314;&#35758;&#27880;&#37322;&#12290;&#22914;&#26377;&#23601;&#22312;&#25991;&#20214;&#20013;&#20889;&#22266;&#23450;ip</span>
;server-bridge 10.8.0.4 255.255.255.0 10.8.0.50 10.8.0.100  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#32593;&#26725;&#27169;&#24335;&#65292;&#19981;&#38656;&#35201;&#37197;&#32622;,&#24314;&#35758;&#27880;&#37322;</span>
;server-bridge
;push <span style="color: #8b2252;">"route 192.168.10.0 255.255.255.0"</span>  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32473;&#23458;&#25143;&#31471;&#29983;&#25104;&#30340;&#21040;&#36798;&#26381;&#21153;&#22120;&#21518;&#38754;&#32593;&#27573;&#30340;&#38745;&#24577;&#36335;&#30001;&#65292;&#19979;&#19968;&#36339;&#20026;openvpn&#26381;&#21153;&#22120;&#30340;10.8.0.1&#12290;windows&#36755;&#20837;route PRINT</span>
;push <span style="color: #8b2252;">"route 192.168.20.0 255.255.255.0"</span>  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25512;&#36865;&#36335;&#30001;&#20449;&#24687;&#21040;&#23458;&#25143;&#31471;&#65292;&#20197;&#20801;&#35768;&#23458;&#25143;&#31471;&#33021;&#22815;&#36830;&#25509;&#21040;&#26381;&#21153;&#22120;&#32972;&#21518;&#30340;&#20854;&#23427;&#31169;&#26377;&#23376;&#32593;&#12290;&#35201;&#25552;&#21069;&#32771;&#34385;&#22810;&#26426;&#25151;&#22320;&#22336;&#19981;&#20914;&#31361;</span>
;client-config-dir ccd                    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#25351;&#23450;&#30340;&#23458;&#25143;&#31471;&#28155;&#21152;&#36335;&#30001;&#65292;&#27492;&#36335;&#30001;&#36890;&#24120;&#26159;&#23458;&#25143;&#31471;&#21518;&#38754;&#30340;&#20869;&#32593;&#32593;&#27573;&#32780;&#19981;&#26159;&#26381;&#21153;&#31471;&#30340;&#65292;&#20063;&#19981;&#38656;&#35201;&#35774;&#32622;&#65292;&#26080;&#27861;&#20445;&#35777;&#23458;&#25143;&#31471;&#32593;&#32476;&#19981;&#20914;&#31361;</span>
;route 192.168.40.128 255.255.255.248     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#19978;&#65292;&#19981;&#38656;&#35201;&#35774;&#32622;</span>
;client-config-dir ccd
;route 10.9.0.0 255.255.255.252
;learn-address ./script                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36816;&#34892;&#22806;&#37096;&#33050;&#26412;&#65292;&#21019;&#24314;&#19981;&#21516;&#32452;&#30340;iptables&#35268;&#21017;&#65292;&#26080;&#38656;&#37197;&#32622;</span>
;push <span style="color: #8b2252;">"redirect-gateway def1 bypass-dhcp"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#21518;&#65292;&#23458;&#25143;&#31471;&#25152;&#26377;&#27969;&#37327;&#37117;&#23558;&#36890;&#36807;VPN&#26381;&#21153;&#22120;&#65292;&#22240;&#27492;&#29983;&#20135;&#19968;&#33324;&#26080;&#38656;&#37197;&#32622;&#27492;&#39033;</span>
;push <span style="color: #8b2252;">"dhcp-option DNS 208.67.222.222"</span>    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25512;&#36865;DNS&#26381;&#21153;&#22120;&#65292;&#19981;&#38656;&#35201;&#37197;&#32622;</span>
;push <span style="color: #8b2252;">"dhcp-option DNS 208.67.220.220"</span>
;client-to-client                         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20801;&#35768;&#19981;&#21516;&#30340;client&#30452;&#25509;&#36890;&#20449;,&#19981;&#23433;&#20840;,&#29983;&#20135;&#29615;&#22659;&#19968;&#33324;&#26080;&#38656;&#35201;&#37197;&#32622;</span>
;duplicate-cn                             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#20010;&#29992;&#25143;&#20849;&#29992;&#19968;&#20010;&#35777;&#20070;&#65292;&#19968;&#33324;&#29992;&#20110;&#27979;&#35797;&#29615;&#22659;&#65292;&#29983;&#20135;&#29615;&#22659;&#37117;&#26159;&#19968;&#20010;&#29992;&#25143;&#19968;&#20010;&#35777;&#20070;,&#26080;&#38656;&#24320;&#21551;</span>
keepalive 10 120                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26381;&#21153;&#31471;&#26816;&#27979;&#30340;&#38388;&#38548;&#21644;&#36229;&#26102;&#26102;&#38388;&#65292;&#40664;&#35748;&#20026;&#27599;10&#31186;ping&#19968;&#27425;&#65292;&#22914;&#26524; 120&#31186;&#27809;&#26377;&#22238;&#24212;&#21017;&#35748;&#20026;&#23545;&#26041;&#24050;&#32463;down</span>
tls-auth ta.key 0                         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#27490;DoS&#31561;&#25915;&#20987;&#30340;&#23433;&#20840;&#22686;&#24378;&#37197;&#32622;,&#21487;&#20197;&#20351;&#29992;&#20197;&#19979;&#21629;&#20196;&#26469;&#29983;&#25104;&#65306;openvpn --genkey --secret ta.key </span>
                                              &#26381;&#21153;&#22120;&#21644;&#27599;&#20010;&#23458;&#25143;&#31471;&#37117;&#38656;&#35201;&#25317;&#26377;&#35813;&#23494;&#38053;&#30340;&#19968;&#20010;&#25335;&#36125;&#12290;&#31532;&#20108;&#20010;&#21442;&#25968;&#22312;&#26381;&#21153;&#22120;&#31471;&#24212;&#35813;&#20026;&#8217;0&#8217;&#65292;&#22312;&#23458;&#25143;&#31471;&#24212;&#35813;&#20026;&#8217;1&#8217;
cipher AES-256-CBC                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#23494;&#31639;&#27861;</span>
;compress lz4-v2                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;Openvpn2.4.X&#26032;&#29256;&#21387;&#32553;&#31639;&#27861;</span>
;push <span style="color: #8b2252;">"compress lz4-v2"</span>                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25512;&#36865;&#23458;&#25143;&#31471;&#20351;&#29992;&#26032;&#29256;&#21387;&#32553;&#31639;&#27861;,&#21644;&#19979;&#38754;&#30340;comp-lzo&#19981;&#35201;&#21516;&#26102;&#20351;&#29992;</span>
;comp-lzo                                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26087;&#25143;&#31471;&#20860;&#23481;&#30340;&#21387;&#32553;&#37197;&#32622;&#65292;&#38656;&#35201;&#23458;&#25143;&#31471;&#37197;&#32622;&#24320;&#21551;&#21387;&#32553;,openvpn2.4.X&#31561;&#26032;&#29256;&#21487;&#20197;&#19981;&#29992;&#24320;&#21551;</span>
;max-clients 100                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#22823;&#23458;&#25143;&#31471;&#25968;</span>
;user nobody                              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36816;&#34892;openvpn&#26381;&#21153;&#30340;&#29992;&#25143;&#21644;&#32452;</span>
;group nobody
persist-key                               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;VPN&#26381;&#21153;&#26102;&#40664;&#35748;&#20250;&#37325;&#26032;&#35835;&#21462;key&#25991;&#20214;&#65292;&#24320;&#21551;&#27492;&#37197;&#32622;&#21518;&#20445;&#30041;&#20351;&#29992;&#31532;&#19968;&#27425;&#30340;key&#25991;&#20214;,&#29983;&#20135;&#29615;&#22659;&#26080;&#38656;&#24320;&#21551;</span>
persist-tun                               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#27492;&#37197;&#32622;&#21518;,&#24403;&#37325;&#21551;vpn&#26381;&#21153;&#26102;&#65292;&#19968;&#30452;&#20445;&#25345;tun&#25110;&#32773;tap&#35774;&#22791;&#26159;up&#30340;&#65292;&#21542;&#21017;&#20250;&#20808;down&#28982;&#21518;&#20877;up,&#29983;&#20135;&#29615;&#22659;&#26080;&#38656;&#24320;&#21551;</span>
status openvpn-status.log                 <span style="color: #b22222;">#</span><span style="color: #b22222;">openVPN&#29366;&#24577;&#35760;&#24405;&#25991;&#20214;&#65292;&#27599;&#20998;&#38047;&#20250;&#35760;&#24405;&#19968;&#27425;</span>
;log         openvpn.log                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#19968;&#31181;&#26085;&#24535;&#35760;&#24405;&#26041;&#24335;,&#24182;&#25351;&#23450;&#26085;&#24535;&#36335;&#24452;&#65292;log&#20250;&#22312;openvpn&#21551;&#21160;&#30340;&#26102;&#20505;&#28165;&#31354;&#26085;&#24535;&#25991;&#20214;,&#19981;&#24314;&#35758;&#20351;&#29992;</span>
;log-append openvpn.log                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#20108;&#31181;&#26085;&#24535;&#35760;&#24405;&#26041;&#24335;,&#24182;&#25351;&#23450;&#26085;&#24535;&#36335;&#24452;&#65292;&#37325;&#21551;openvpn&#21518;&#22312;&#20043;&#21069;&#30340;&#26085;&#24535;&#21518;&#38754;&#36861;&#21152;&#26032;&#30340;&#26085;&#24535;,&#29983;&#20135;&#29615;&#22659;&#24314;&#35758;&#20351;&#29992;</span>
verb 3                                    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26085;&#24535;&#32423;&#21035;&#65292;0-9&#65292;&#32423;&#21035;&#36234;&#39640;&#35760;&#24405;&#30340;&#20869;&#23481;&#36234;&#35814;&#32454;,0 &#34920;&#31034;&#38745;&#40664;&#36816;&#34892;&#65292;&#21482;&#35760;&#24405;&#33268;&#21629;&#38169;&#35823;,4 &#34920;&#31034;&#21512;&#29702;&#30340;&#24120;&#35268;&#29992;&#27861;,</span>
                                              5 &#21644; 6 &#21487;&#20197;&#24110;&#21161;&#35843;&#35797;&#36830;&#25509;&#38169;&#35823;&#12290;9 &#34920;&#31034;&#26497;&#24230;&#20887;&#20313;&#65292;&#36755;&#20986;&#38750;&#24120;&#35814;&#32454;&#30340;&#26085;&#24535;&#20449;&#24687;
;mute 20                                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#21516;&#31867;&#21035;&#30340;&#20449;&#24687;&#21482;&#26377;&#21069;20&#26465;&#20250;&#36755;&#20986;&#21040;&#26085;&#24535;&#25991;&#20214;&#20013;</span>
explicit-exit-notify 1                    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#30693;&#23458;&#25143;&#31471;&#65292;&#22312;&#26381;&#21153;&#31471;&#37325;&#21551;&#21518;&#33258;&#21160;&#37325;&#26032;&#36830;&#25509;&#65292;&#20165;&#33021;&#29992;&#20110;udp&#27169;&#24335;&#65292;tcp&#27169;&#24335;&#19981;&#38656;&#35201;&#37197;&#32622;&#21363;&#21487;&#23454;&#29616;&#26029;&#24320;&#37325;&#26032;&#36830;&#25509;,</span>
                                              &#19988;&#24320;&#21551;&#27492;&#39033;&#21518;tcp&#37197;&#32622;&#21518;&#23558;&#23548;&#33268;openvpn&#26381;&#21153;&#26080;&#27861;&#21551;&#21160;,&#25152;&#20197;tcp&#26102;&#24517;&#39035;&#19981;&#33021;&#24320;&#21551;&#27492;&#39033;
;crl-verify /etc/openvpn/easy-rsa-server/3/pki/crl.pem <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#19968;&#27425;&#21514;&#38144;&#35777;&#26102;&#38656;&#35201;&#32534;&#36753;&#37197;&#32622;&#25991;&#20214;&#35843;&#29992;&#21514;&#38144;&#35777;&#20070;&#30340;&#25991;&#20214;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:42ce7630-7692-41ac-b2d4-eb9669565dea" class="outline-5">
<h5 id="h:42ce7630-7692-41ac-b2d4-eb9669565dea">2.4.2 修改服务器端配置文件</h5>
<div class="outline-text-5" id="text-h:42ce7630-7692-41ac-b2d4-eb9669565dea">
<div class="org-src-container">
<pre class="src src-sh">[root@openvpn-server ~]#vim /etc/openvpn/server.conf
port 1194                                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#31471;&#21475;</span>
proto tcp                                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#30340;&#21327;&#35758;&#36824;&#21487;&#20197;&#20351;&#29992;udp</span>
dev tun                                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#19968;&#20010;&#36335;&#30001;IP&#38567;&#36947;</span>
ca /etc/openvpn/certs/ca.crt                <span style="color: #b22222;">#</span><span style="color: #b22222;">ca&#35777;&#20070;&#25991;&#20214;&#20301;&#32622;</span>
cert /etc/openvpn/certs/server.crt          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#35777;&#20070;&#25991;&#20214;&#20301;&#32622;</span>
key /etc/openvpn/certs/server.key           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#31169;&#38053;&#25991;&#20214;&#20301;&#32622;</span>
dh /etc/openvpn/certs/dh.pem                <span style="color: #b22222;">#</span><span style="color: #b22222;">dh&#21442;&#25968;&#25991;&#20214;&#65292;&#20063;&#23601;&#26159;&#23494;&#38053;&#20132;&#25442;&#31639;&#27861;&#25991;&#20214;</span>
server 10.0.0.0 255.255.255.0               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#36830;&#25509;&#21518;&#20998;&#37197;IP&#30340;&#22320;&#22336;&#27744;</span>

push <span style="color: #8b2252;">"route 172.30.0.0 255.255.255.0"</span>       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32473;&#23458;&#25143;&#31471;&#29983;&#25104;&#30340;&#21040;&#36798;&#26381;&#21153;&#22120;&#21518;&#38754;&#32593;&#27573;&#30340;&#38745;&#24577;&#36335;&#30001;</span>

keepalive 10 120                            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26381;&#21153;&#31471;&#26816;&#27979;&#30340;&#38388;&#38548;&#21644;&#36229;&#26102;&#26102;&#38388;</span>
cipher AES-256-CBC                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#23494;&#31639;&#27861;</span>
compress lz4-v2                             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;Openvpn2.4.X&#26032;&#29256;&#21387;&#32553;&#31639;&#27861;</span>
push <span style="color: #8b2252;">"compress lz4-v2"</span>                      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25512;&#36865;&#23458;&#25143;&#31471;&#20351;&#29992;&#26032;&#29256;&#21387;&#32553;&#31639;&#27861;</span>
max-clients 2048                            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#22823;&#23458;&#25143;&#31471;&#25968;</span>
user openvpn                                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36816;&#34892;openvpn&#26381;&#21153;&#30340;&#29992;&#25143;&#21644;&#32452;</span>
group openvpn
status /var/log/openvpn/openvpn-status.log  <span style="color: #b22222;">#</span><span style="color: #b22222;">openVPN&#29366;&#24577;&#35760;&#24405;&#25991;&#20214;&#65292;&#27599;&#20998;&#38047;&#20250;&#35760;&#24405;&#19968;&#27425;</span>
log-append /var/log/openvpn/openvpn.log     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#20108;&#31181;&#26085;&#24535;&#35760;&#24405;&#26041;&#24335;</span>
verb 3                                      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26085;&#24535;&#32423;&#21035;</span>
mute 20                                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#21516;&#31867;&#21035;&#30340;&#20449;&#24687;&#21482;&#26377;&#21069;20&#26465;&#20250;&#36755;&#20986;&#21040;&#26085;&#24535;&#25991;&#20214;&#20013;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20934;&#22791;&#30446;&#24535;&#30456;&#20851;&#30446;&#24405;</span>
getent passwd openvpn
mkdir /var/log/openvpn
chown openvpn: /var/log/openvpn

[root@openvpn-server ~]#ll -d /var/log/openvpn/
drwxr-xr-x 2 openvpn openvpn 6 Jan 26 14:23 /var/log/openvpn/
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:b0eab57e-5097-4ba1-a773-9ba73dbe114d" class="outline-4">
<h4 id="h:b0eab57e-5097-4ba1-a773-9ba73dbe114d">2.5 准备iptables规则和内核参数</h4>
<div class="outline-text-4" id="text-h:b0eab57e-5097-4ba1-a773-9ba73dbe114d">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#26381;&#21153;&#22120;&#24320;&#21551;ip_forward&#36716;&#21457;&#21151;&#33021;</span>
<span style="color: #483d8b;">echo</span> net.ipv4.ip_forward = 1 &gt;&gt;/etc/sysctl.conf
<span style="color: #b22222;">#</span><span style="color: #b22222;">sysctl -p</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;SNAT&#35268;&#21017;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"iptables -t nat -APOSTROUTING -s 10.8.0.0/24 -j MASQUERADE"</span> &gt;&gt;/etc/rc.d/rc.local       <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22320;&#22336;&#20266;&#35013;</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"iptables -A INPUT -i eth0 -p tcp --dport 1194 -j ACCEPT"</span> &gt;&gt;/etc/rc.d/rc.local          <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20801;&#35768;&#35775;&#38382;1194</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"iptables -A INPUT -m state --stat ESTABLISHED,RELATED -j ACCEPT"</span> &gt;&gt;/etc/rc.d/rc.local  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21709;&#24212;&#36830;&#25509;&#20801;&#35768;</span>
chmod +x /etc/rc.d/rc.local
/etc/rc.d/rc.local

<span style="color: #b22222;">#</span>
[root@openvpn-server ~]#iptables -t nat -vnL
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target     prot opt<span style="color: #a020f0;"> in</span>     out     source               destination

Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target     prot opt<span style="color: #a020f0;"> in</span>     out     source               destination

Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target     prot opt<span style="color: #a020f0;"> in</span>     out     source               destination
0     0 MASQUERADE  all  --  *      *       10.0.0.0/24          0.0.0.0/0

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target     prot opt<span style="color: #a020f0;"> in</span>     out     source               destination
</pre>
</div>
</div>
</div>
<div id="outline-container-h:89ded5b1-bd41-4f72-ad64-e40de1373a3a" class="outline-4">
<h4 id="h:89ded5b1-bd41-4f72-ad64-e40de1373a3a">2.6 启动OpenVPN服务</h4>
<div class="outline-text-4" id="text-h:89ded5b1-bd41-4f72-ad64-e40de1373a3a">
</div>
<div id="outline-container-h:7957b04b-176c-47d6-a21d-bdf79c0449da" class="outline-5">
<h5 id="h:7957b04b-176c-47d6-a21d-bdf79c0449da">2.6.1 启动 OpenVPN 服务</h5>
<div class="outline-text-5" id="text-h:7957b04b-176c-47d6-a21d-bdf79c0449da">
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#rpm -ql openvpn | grep systemd
/usr/lib/systemd/system/openvpn-client@.service
/usr/lib/systemd/system/openvpn-server@.service
/usr/lib/systemd/system/openvpn@.service
/usr/share/doc/openvpn-2.4.10/README.systemd

<span style="color: #b22222;">#</span><span style="color: #b22222;">centos8&#32570;&#22833;unit&#25991;&#20214;&#65292;&#20174;Centos7&#22797;&#21046;&#25991;&#20214;</span>
[root@openvpn-server ~]#rpm -ql openvpn | grep systemd
/usr/lib/systemd/system/openvpn-client@.service
/usr/lib/systemd/system/openvpn-server@.service
/usr/share/doc/openvpn/README.systemd

[root@centos7 ~]#cat /usr/lib/systemd/system/openvpn@.service
[Unit]
<span style="color: #a0522d;">Description</span>=OpenVPN Robust And Highly Flexible Tunneling Application On %I
<span style="color: #a0522d;">After</span>=network.target

[Service]
<span style="color: #a0522d;">Type</span>=notify
<span style="color: #a0522d;">PrivateTmp</span>=true
<span style="color: #a0522d;">ExecStart</span>=/usr/sbin/openvpn --cd /etc/openvpn/ --config %i.conf

[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target
[root@centos7 ~]#scp /lib/systemd/system/openvpn@.service 39.98.146.209:/lib/systemd/system/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;OpenVPN&#26381;&#21153;,&#27880;&#24847;service&#21517;&#31216;&#21644;&#25991;&#20214;&#21517;&#19981;&#19968;&#33268;</span>
[root@openvpn-server ~]#systemctl daemon-reload
[root@openvpn-server ~]#systemctl enable --now openvpn@server
Created symlink /etc/systemd/system/multi-user.target.wants/openvpn@server.service &#8594; /usr/lib/systemd/system/openvpn@.service.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d9876eb8-ec14-48f2-87e9-7124ba447f75" class="outline-5">
<h5 id="h:d9876eb8-ec14-48f2-87e9-7124ba447f75">2.6.2 查看服务状态</h5>
<div class="outline-text-5" id="text-h:d9876eb8-ec14-48f2-87e9-7124ba447f75">
<div class="org-src-container">
<pre class="src src-sh">[root@openvpn-server ~]#systemctl status openvpn@server
&#9679; openvpn@server.service - OpenVPN Robust And Highly Flexible Tunneling Application On server
Loaded: loaded (/usr/lib/systemd/system/openvpn@.service; enabled; vendor preset: disabled)
Active: active (running) since Tue 2021-01-26 14:54:42 CST; 29s ago
Main PID: 13647 (openvpn)
Status: <span style="color: #8b2252;">"Initialization Sequence Completed"</span>
Tasks: 1 (limit: 22788)
Memory: 1.3M
CGroup: /system.slice/system-openvpn.slice/openvpn@server.service
&#9492;&#9472;13647 /usr/sbin/openvpn --cd /etc/openvpn/ --config server.conf

Jan 26 14:54:42 openvpn-server systemd[1]: Starting OpenVPN Robust And Highly Flexible Tunneling Applicati&gt;
Jan 26 14:54:42 openvpn-server systemd[1]: Started OpenVPN Robust And Highly Flexible Tunneling Applicatio&gt;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#31471;&#21475;&#21495;</span>
[root@openvpn-server ~]#ss -ntlp
State   Recv-Q  Send-Q   Local Address:Port   Peer Address:Port
LISTEN  0       32             0.0.0.0:1194        0.0.0.0:*     users:((<span style="color: #8b2252;">"openvpn"</span>,<span style="color: #a0522d;">pid</span>=13647,<span style="color: #a0522d;">fd</span>=7))
LISTEN  0       128            0.0.0.0:5355        0.0.0.0:*     users:((<span style="color: #8b2252;">"systemd-resolve"</span>,<span style="color: #a0522d;">pid</span>=963,<span style="color: #a0522d;">fd</span>=13))
LISTEN  0       128            0.0.0.0:111         0.0.0.0:*     users:((<span style="color: #8b2252;">"systemd"</span>,<span style="color: #a0522d;">pid</span>=1,<span style="color: #a0522d;">fd</span>=59))
LISTEN  0       128            0.0.0.0:22          0.0.0.0:*     users:((<span style="color: #8b2252;">"sshd"</span>,<span style="color: #a0522d;">pid</span>=1009,<span style="color: #a0522d;">fd</span>=5))
LISTEN  0       128               [::]:5355           [::]:*     users:((<span style="color: #8b2252;">"systemd-resolve"</span>,<span style="color: #a0522d;">pid</span>=963,<span style="color: #a0522d;">fd</span>=15))
LISTEN  0       128               [::]:111            [::]:*     users:((<span style="color: #8b2252;">"systemd"</span>,<span style="color: #a0522d;">pid</span>=1,<span style="color: #a0522d;">fd</span>=66))

[root@openvpn-server ~]#cat /var/log/openvpn/openvpn.log

[root@openvpn-server ~]#ip a
4: tun0:  mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 100
inet 10.8.0.1 peer 10.8.0.2/32 scope global tun0


[root@openvpn-server ~]#route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         172.30.0.253    0.0.0.0         UG    100    0        0 eth0
10.8.0.0        10.8.0.2        255.255.255.0   UG    0      0        0 tun0
10.8.0.2        0.0.0.0         255.255.255.255 UH    0      0        0 tun0
172.30.0.0      0.0.0.0         255.255.255.0   U     100    0        0 eth0
</pre>
</div>

<p>
验证tun网卡设备
</p>


<figure id="orgda9a17f">
<img src="images/image-20210426165448088.png" alt="image-20210426165448088.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:bbe27959-0b4c-4172-9615-29f4bc323331" class="outline-4">
<h4 id="h:bbe27959-0b4c-4172-9615-29f4bc323331">2.7 准备OpenVPN客户端配置文件</h4>
<div class="outline-text-4" id="text-h:bbe27959-0b4c-4172-9615-29f4bc323331">
</div>
<div id="outline-container-h:1abfbefb-9a99-4dd8-9521-3bca988cb43c" class="outline-5">
<h5 id="h:1abfbefb-9a99-4dd8-9521-3bca988cb43c">2.7.1 客户端默认范例配置文件说明</h5>
<div class="outline-text-5" id="text-h:1abfbefb-9a99-4dd8-9521-3bca988cb43c">
<div class="org-src-container">
<pre class="src src-sh">[root@openvpn-server ~]#grep -Ev <span style="color: #8b2252;">"^(#|;)|^$"</span> /usr/share/doc/openvpn/sample/sample-config-files/client.conf
client                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22768;&#26126;&#33258;&#24049;&#26159;&#20010;&#23458;&#25143;&#31471;</span>
dev tun                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25509;&#21475;&#31867;&#22411;&#65292;&#24517;&#39035;&#21644;&#26381;&#21153;&#31471;&#20445;&#25345;&#19968;&#33268;</span>
proto udp               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21327;&#35758;&#31867;&#22411;&#65292;&#24517;&#39035;&#21644;&#26381;&#21153;&#31471;&#20445;&#25345;&#19968;&#33268;</span>
remote my-server-1 1194 <span style="color: #b22222;">#</span><span style="color: #b22222;">server&#31471;&#30340;ip&#21644;&#31471;&#21475;&#65292;&#21487;&#20197;&#20889;&#22495;&#21517;&#20294;&#26159;&#38656;&#35201;&#21487;&#20197;&#35299;&#26512;&#25104;IP</span>
resolv-retry infinite   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#26159;&#20889;&#30340;server&#31471;&#30340;&#22495;&#21517;&#65292;&#37027;&#20040;&#23601;&#22987;&#32456;&#35299;&#26512;&#65292;&#22914;&#26524;&#22495;&#21517;&#21457;&#29983;&#21464;&#21270;&#65292;&#20250;&#37325;&#26032;&#36830;&#25509;&#21040;&#26032;&#30340;&#22495;&#21517;&#23545;&#24212;&#30340;IP</span>
nobind                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26412;&#26426;&#19981;&#32465;&#23450;&#30417;&#21548;&#31471;&#21475;&#65292;&#23458;&#25143;&#31471;&#26159;&#38543;&#26426;&#25171;&#24320;&#31471;&#21475;&#36830;&#25509;&#21040;&#26381;&#21153;&#31471;&#30340;1194</span>
persist-key
persist-tun
ca ca.crt
cert client.crt
key client.key
remote-cert-tls server   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#37319;&#29992;&#26381;&#21153;&#22120;&#35777;&#20070;&#26657;&#39564;&#26041;&#24335;</span>
tls-auth ta.key 1
cipher AES-256-CBC
verb 3
</pre>
</div>
</div>
</div>
<div id="outline-container-h:29a8f18d-a398-47cd-8933-b8b62512ef1b" class="outline-5">
<h5 id="h:29a8f18d-a398-47cd-8933-b8b62512ef1b">2.7.2 生成客户端用户的配置文件</h5>
<div class="outline-text-5" id="text-h:29a8f18d-a398-47cd-8933-b8b62512ef1b">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#23458;&#25143;&#31471;&#25991;&#20214;,&#25991;&#20214;&#21518;&#32512;&#24517;&#39035;&#20026;.ovpn</span>
[root@openvpn-server ~]#grep -Ev <span style="color: #8b2252;">"^(#|;)|^$"</span> /usr/share/doc/openvpn/sample/sample-config-files/client.conf &gt;/etc/openvpn/client/client-x/client.ovpn

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;&#25991;&#20214;,&#20869;&#23481;&#22914;&#19979;</span>
[root@openvpn-server ~]#vim /etc/openvpn/client/client-x/client.ovpn
[root@openvpn-server ~]#cat /etc/openvpn/client/client-x/client.ovpn
client
dev tun
proto tcp
remote 39.98.146.209 1194    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#20135;&#20013;&#20026;OpenVPN&#20844;&#32593;IP</span>
resolv-retry infinite
nobind
<span style="color: #b22222;">#</span><span style="color: #b22222;">persist-key</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">persist-tun</span>
ca ca.crt
cert client-x.crt
key client-x.key
remote-cert-tls server
<span style="color: #b22222;">#</span><span style="color: #b22222;">tls-auth ta.key 1</span>
cipher AES-256-CBC
verb 3                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27492;&#20540;&#19981;&#33021;&#38543;&#24847;&#25351;&#23450;&#65292;&#21542;&#21017;&#26080;&#27861;&#36890;&#20449;</span>
compress lz4-v2        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27492;&#39033;&#22312;OpenVPN2.4.X&#29256;&#26412;&#20351;&#29992;&#65292;&#38656;&#35201;&#21644;&#26381;&#21153;&#22120;&#31471;&#20445;&#25345;&#19968;&#33268;&#65292;&#19981;&#25351;&#23450;&#40664;&#35748;comp-lz&#21387;&#32553;</span>
</pre>
</div>

<p>
mac客户端使用开源软件Tunnelblick
</p>

<p>
官网：<a href="https://code.google.com/p/tunnelblick/">https://code.google.com/p/tunnelblick/</a> <a href="https://tunnelblick.net/">https://tunnelblick.net/</a>
</p>
</div>
</div>
</div>
<div id="outline-container-h:3434b1f9-de3c-4d5f-9eaa-8be8b0468822" class="outline-4">
<h4 id="h:3434b1f9-de3c-4d5f-9eaa-8be8b0468822">2.8 Windows 配置部署 OpenVPN 客户端</h4>
<div class="outline-text-4" id="text-h:3434b1f9-de3c-4d5f-9eaa-8be8b0468822">
</div>
<div id="outline-container-h:efe2439f-044a-40ce-be1f-ca1dca872c77" class="outline-5">
<h5 id="h:efe2439f-044a-40ce-be1f-ca1dca872c77">2.8.1 Windows 安装 OpenVPN 客户端</h5>
<div class="outline-text-5" id="text-h:efe2439f-044a-40ce-be1f-ca1dca872c77">
<p>
官方客户端下载地址：
</p>

<p>
<a href="https://openvpn.net/community-downloads/">https://openvpn.net/community-downloads/</a>
</p>

<p>
下载安装就可以了
</p>
</div>
</div>
<div id="outline-container-h:e36b646d-17df-48ac-b38c-1444c76b78c8" class="outline-5">
<h5 id="h:e36b646d-17df-48ac-b38c-1444c76b78c8">2.8.2 Windows客户端配置准备</h5>
<div class="outline-text-5" id="text-h:e36b646d-17df-48ac-b38c-1444c76b78c8">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#26381;&#21153;&#22120;&#25171;&#21253;&#35777;&#20070;&#24182;&#19979;&#36733;&#21457;&#36865;&#32473;windows&#23458;&#25143;&#31471;</span>
[root@openvpn-server ~]#cd /etc/openvpn/client/client-x/
[root@openvpn-server client-x]#pwd
/etc/openvpn/client/client-x
[root@openvpn-server client-x]#tar cf client-x.tar ./
tar: ./client-x.tar: file is the archive; not dumped
[root@openvpn-server client-x]#ll
total 40
-rw------- 1 root root  1204 Jan 26 14:09 ca.crt
-rw-r--r-- 1 root root   237 Jan 26 15:04 client.ovpn
-rw------- 1 root root  4499 Jan 26 14:09 client-x.crt
-rw------- 1 root root  1704 Jan 26 14:09 client-x.key
-rw-r--r-- 1 root root 20480 Jan 26 15:09 client-x.tar

[root@openvpn-server client-x]#tar -tf client-x.tar
./
./client-x.crt
./ca.crt
./client-x.key
./client.ovpn
</pre>
</div>

<p>
放置到windows客户端的 C:\Program Files\OpenVPN\config 目录下
</p>

<p>
开打OpenVPN GUI
</p>

<p>
进行连接
</p>


<figure id="orgfdc53c2">
<img src="images/image-20210426165925095.png" alt="image-20210426165925095.png">

</figure>

<p>
绿色之后就表示连接正常
</p>
</div>
</div>
<div id="outline-container-h:cd413baf-3c3b-41c9-9b47-fedfa8c41b76" class="outline-5">
<h5 id="h:cd413baf-3c3b-41c9-9b47-fedfa8c41b76">2.8.4 Windows客户端验证通信</h5>
<div class="outline-text-5" id="text-h:cd413baf-3c3b-41c9-9b47-fedfa8c41b76">
</div>
<ul class="org-ul">
<li><a id="h:1619aa68-d241-4a07-bc0e-4d4b315c006a"></a>2.8.4.1 在Windows 客户端测试访问OpenVPN后端服务器<br>
<div class="outline-text-6" id="text-h:1619aa68-d241-4a07-bc0e-4d4b315c006a">
<p>
后端服务器显示是来自于OpenVPN服务器的连接
</p>

<pre class="example" id="org981f3db">
&gt;ping 172.30.0.100
&gt;ssh root@172.30.0.100
</pre>
</div>
</li>
<li><a id="h:98aaaeb5-724c-4a34-a597-07aac4eac682"></a>2.8.4.2 观察OpenVPN服务器日志<br>
<div class="outline-text-6" id="text-h:98aaaeb5-724c-4a34-a597-07aac4eac682">
<div class="org-src-container">
<pre class="src src-sh">[root@openvpn-server client-x]#tail /var/log/openvpn/openvpn.log -f -n0
Tue Jan 26 15:18:57 2021 TCP connection established with [AF_INET]110.17.5.83:20328
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 TLS: Initial packet from [AF_INET]110.17.5.83:20328, <span style="color: #a0522d;">sid</span>=0f61dc6f b6fc7583
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 VERIFY OK: <span style="color: #a0522d;">depth</span>=1, <span style="color: #a0522d;">CN</span>=Easy-RSA CA
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 VERIFY OK: <span style="color: #a0522d;">depth</span>=0, <span style="color: #a0522d;">CN</span>=client-x
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 peer info: <span style="color: #a0522d;">IV_VER</span>=2.4.10
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 peer info: <span style="color: #a0522d;">IV_PLAT</span>=win
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 peer info: <span style="color: #a0522d;">IV_PROTO</span>=2
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 peer info: <span style="color: #a0522d;">IV_NCP</span>=2
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 peer info: <span style="color: #a0522d;">IV_CIPHERS</span>=AES-256-GCM:AES-128-GCM:AES-256-CBC
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 peer info: <span style="color: #a0522d;">IV_LZ4</span>=1
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 peer info: <span style="color: #a0522d;">IV_LZ4v2</span>=1
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 peer info: <span style="color: #a0522d;">IV_LZO</span>=1
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 peer info: <span style="color: #a0522d;">IV_COMP_STUB</span>=1
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 peer info: <span style="color: #a0522d;">IV_COMP_STUBv2</span>=1
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 peer info: <span style="color: #a0522d;">IV_TCPNL</span>=1
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 peer info: <span style="color: #a0522d;">IV_GUI_VER</span>=OpenVPN_GUI_11
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 Control Channel: TLSv1.3, cipher TLSv1.3 TLS_AES_256_GCM_SHA384, 2048 bit RSA
Tue Jan 26 15:18:58 2021 110.17.5.83:20328 [client-x] Peer Connection Initiated with [AF_INET]110.17.5.83:20328
Tue Jan 26 15:18:58 2021 client-x/110.17.5.83:20328 MULTI_sva: pool returned <span style="color: #a0522d;">IPv4</span>=10.8.0.6, <span style="color: #a0522d;">IPv6</span>=(Not enabled)
Tue Jan 26 15:18:58 2021 client-x/110.17.5.83:20328 MULTI: Learn: 10.8.0.6 -&gt; client-x/110.17.5.83:20328
Tue Jan 26 15:18:58 2021 client-x/110.17.5.83:20328 MULTI: primary virtual IP for client-x/110.17.5.83:20328: 10.8.0.6
Tue Jan 26 15:18:59 2021 client-x/110.17.5.83:20328 PUSH: Received control message: <span style="color: #8b2252;">'PUSH_REQUEST'</span>
Tue Jan 26 15:18:59 2021 client-x/110.17.5.83:20328 SENT CONTROL [client-x]: <span style="color: #8b2252;">'PUSH_REPLY,route 172.30.0.0 255.255.255.0,compress lz4-v2,route 10.8.0.1,topology net30,ping 10,ping-restart 120,ifconfig 10.8.0.6 10.8.0.5,peer-id 0,cipher AES-256-GCM'</span> (<span style="color: #a0522d;">status</span>=1)
Tue Jan 26 15:18:59 2021 client-x/110.17.5.83:20328 Data Channel: using negotiated cipher <span style="color: #8b2252;">'AES-256-GCM'</span>
Tue Jan 26 15:18:59 2021 client-x/110.17.5.83:20328 Outgoing Data Channel: Cipher <span style="color: #8b2252;">'AES-256-GCM'</span> initialized with 256 bit key
Tue Jan 26 15:18:59 2021 client-x/110.17.5.83:20328 Incoming Data Channel: Cipher <span style="color: #8b2252;">'AES-256-GCM'</span> initialized with 256 bit key
</pre>
</div>
</div>
</li>
<li><a id="h:88e972f5-868b-49b1-9fd4-dc2e4a131a4e"></a>2.8.4.3 验证OpenVPN服务器连接状态<br>
<div class="outline-text-6" id="text-h:88e972f5-868b-49b1-9fd4-dc2e4a131a4e">
<div class="org-src-container">
<pre class="src src-sh">[root@openvpn-server client-x]#ss -nt
State       Recv-Q        Send-Q               Local Address:Port                 Peer Address:Port
ESTAB       0             36                      172.30.0.1:22                    110.17.5.83:20645  <span style="color: #b22222;"># </span>
ESTAB       0             0                       172.30.0.1:1194                  110.17.5.83:20328  <span style="color: #b22222;">#</span>
ESTAB       0             0                       172.30.0.1:47816               100.100.30.26:80
</pre>
</div>
</div>
</li>
<li><a id="h:302bc757-5be5-4d88-94ed-6cd63189fdab"></a>2.8.4.4 验证 Windows 客户端的 IP地址<br>
<div class="outline-text-6" id="text-h:302bc757-5be5-4d88-94ed-6cd63189fdab">

<figure id="orgd649446">
<img src="images/image-20210427141512158.png" alt="image-20210427141512158.png">

<figcaption><span class="figure-number">Figure 1: </span>image-20210427141512158</figcaption>
</figure>
</div>
</li>
<li><a id="h:7968def4-4519-4f34-9234-1f87fbdbfaf2"></a>2.8.4.5 验证Windows 客户端的路由表<br>
<div class="outline-text-6" id="text-h:7968def4-4519-4f34-9234-1f87fbdbfaf2">

<figure id="orgb1f8e85">
<img src="images/image-20210427153408404.png" alt="image-20210427153408404.png">

<figcaption><span class="figure-number">Figure 2: </span>image-20210427153408404</figcaption>
</figure>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:129adf76-5f04-43d7-90ed-4b68e64185d7" class="outline-4">
<h4 id="h:129adf76-5f04-43d7-90ed-4b68e64185d7">2.9 Mac OS 配置部署OpenVPN 客户端</h4>
<div class="outline-text-4" id="text-h:129adf76-5f04-43d7-90ed-4b68e64185d7">
<p>
官方没有提供基于Mac OS的OpenVPN的客户端
</p>

<p>
第三方OpenVPN 客户端参考链接: <a href="https://tunnelblick.net/downloads.html">https://tunnelblick.net/downloads.html</a>
</p>

<p>
需要科学访问
</p>


<figure id="org2d23f40">
<img src="images/image-20210219195234483.png" alt="image-20210219195234483.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:897b7df7-e2a7-4d13-a2f7-43abd2aefedf" class="outline-3">
<h3 id="h:897b7df7-e2a7-4d13-a2f7-43abd2aefedf">3 故障排错</h3>
<div class="outline-text-3" id="text-h:897b7df7-e2a7-4d13-a2f7-43abd2aefedf">
</div>
<div id="outline-container-h:49838d2d-1e9d-410b-a105-d6eb947d2fdd" class="outline-4">
<h4 id="h:49838d2d-1e9d-410b-a105-d6eb947d2fdd">3.1 在tcp模式下开启explicit-exit-notify 导致无法启动</h4>
<div class="outline-text-4" id="text-h:49838d2d-1e9d-410b-a105-d6eb947d2fdd">
<p>
explicit-exit-notify可以支持在UDP协议时,OpenVPN重启后,客户端自动重新连
接
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@openvpn-server client-x]#vim /etc/openvpn/server.conf
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;tcp&#27169;&#24335;&#19979;&#24320;&#21551;&#36890;&#30693;</span>
proto tcp
pexplicit-exit-notify 1

[root@openvpn-server client-x]#systemctl restart openvpn@server
Job for openvpn@server.service failed because the control process exited with error code.
See <span style="color: #8b2252;">"systemctl status openvpn@server.service"</span> and <span style="color: #8b2252;">"journalctl -xe"</span> for details.

[root@centos8 ~]#tail /var/log/openvpn/openvpn.log -f -n0
</pre>
</div>

<p>
这个参数只能是UDP协议使用TCP不能使用，如要使用客户端配置文件proto需改为udp
</p>

<p>
修改配置,选择UDP协议
</p>

<p>
注意: 需要在防火墙或安全组中开启1194/UDP端口
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /etc/openvpn/server.conf
proto udp
explicit-exit-notify 1
[root@centos8 ~]#systemctl restart openvpn@server.service
</pre>
</div>

<p>
客户端也需要修改为UDP协议,否则会显示下面
</p>


<figure id="org43993ec">
<img src="images/image-20210219195530786.png" alt="image-20210219195530786.png">

</figure>

<p>
修改客户端配置文件
</p>


<figure id="orge307a8d">
<img src="images/image-20210219195552800.png" alt="image-20210219195552800.png">

</figure>

<p>
重新连接成功
</p>


<figure id="org21b6e97">
<img src="images/image-20210219195610681.png" alt="image-20210219195610681.png">

</figure>


<figure id="org76c536e">
<img src="images/image-20210219195624959.png" alt="image-20210219195624959.png">

</figure>
</div>
</div>
<div id="outline-container-h:7f6c822d-e7ef-4b6b-bc48-7aafb80c3778" class="outline-4">
<h4 id="h:7f6c822d-e7ef-4b6b-bc48-7aafb80c3778">3.2 压缩算法错误导致连接失败</h4>
<div class="outline-text-4" id="text-h:7f6c822d-e7ef-4b6b-bc48-7aafb80c3778">
<p>
<b>OpenVPN 2.4.x 客户端支持更新的压缩算法lz4-v2,而comp-lzo是为老版本兼容
使用,两者不要在一起混用,否则可能会导致连接失败</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#20860;&#23481;&#30340;&#21387;&#32553;&#21151;&#33021;</span>
[root@openvpn-server client-x]#vim /etc/openvpn/server.conf
compress lz4-v2
push <span style="color: #8b2252;">"compress lz4-v2"</span>
comp-lzo     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#27492;&#34892;</span>
[root@openvpn-server client-x]#systemctl restart openvpn@server

<span style="color: #b22222;">#</span><span style="color: #b22222;">windows&#23458;&#25143;&#31471;&#36830;&#25509;&#21518;,&#26381;&#21153;&#22120;&#21487;&#20197;&#30475;&#21040;&#19979;&#38754;&#26085;&#24535;&#25552;&#31034;</span>
[root@openvpn-server client-x]#tail /var/log/openvpn/openvpn.log -f -n0
Tue Jan 26 15:32:42 2021 client-x/110.17.5.83:20997 Bad LZO decompression header byte: 96
Tue Jan 26 15:32:42 2021 client-x/110.17.5.83:20997 Bad LZO decompression header byte: 96
Tue Jan 26 15:32:42 2021 client-x/110.17.5.83:20997 Bad LZO decompression header byte: 80
Tue Jan 26 15:32:43 2021 client-x/110.17.5.83:20997 Bad LZO decompression header byte: 80
Tue Jan 26 15:32:43 2021 client-x/110.17.5.83:20997 Bad LZO decompression header byte: 80
Tue Jan 26 15:32:43 2021 client-x/110.17.5.83:20997 Bad LZO decompression header byte: 96
Tue Jan 26 15:32:43 2021 client-x/110.17.5.83:20997 Bad LZO decompression header byte: 96
</pre>
</div>

<p>
在客户端可以看到下面提示
</p>


<figure id="orgb2486c3">
<img src="images/image-20210219195707867.png" alt="image-20210219195707867.png">

</figure>

<p>
客户端无法访问后端服务器， ping IP地址超时
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#38381;&#20860;&#23481;&#30340;&#21387;&#32553;&#21151;&#33021;</span>
[root@centos8 ~]#vim /etc/openvpn/server.conf
;comp-lzo
[root@centos8 ~]#systemctl restart openvpn@server.service
</pre>
</div>

<p>
客户端重新连接,访问后端服务器成功
</p>


<figure id="org8f242aa">
<img src="images/image-20210219195738449.png" alt="image-20210219195738449.png">

</figure>
</div>
</div>
<div id="outline-container-h:3d0a32df-f2fa-4156-a7bb-ecc9a10e0ba2" class="outline-4">
<h4 id="h:3d0a32df-f2fa-4156-a7bb-ecc9a10e0ba2">3.3 工作模式错误</h4>
<div class="outline-text-4" id="text-h:3d0a32df-f2fa-4156-a7bb-ecc9a10e0ba2">
<p>
OpenVPN两种工作模式:TUN和TAP,都可以支持TCP和UDP协议,但如果服务器和客户
工作模式不同,比如服务器为TAP,客户端为TUN,会导致连接失败
</p>

<p>
客户端和服务端的配置文件必须相同不然会提示连接失败
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /etc/openvpn/server.conf
dev tap
;dev tun

[root@centos8 ~]#systemctl restart openvpn@server.service
[root@centos8 ~]#ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group
default qlen 1000
 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
 inet 127.0.0.1/8 scope host lo
   valid_lft forever preferred_lft forever
 inet6 ::1/128 scope host
   valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP
group default qlen 1000
 link/ether 00:0c:29:8a:51:21 brd ff:ff:ff:ff:ff:ff
 inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0
   valid_lft forever preferred_lft forever
3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP
group default qlen 1000
 link/ether 00:0c:29:8a:51:2b brd ff:ff:ff:ff:ff:ff
 inet 172.30.0.1/24 brd 172.30.0.255 scope global noprefixroute eth1
   valid_lft forever preferred_lft forever
 inet6 fe80::20c:29ff:fe8a:512b/64 scope link
   valid_lft forever preferred_lft forever
15: tap0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state
UNKNOWN group default qlen 100
 link/ether 6a:5c:7d:7a:0d:6e brd ff:ff:ff:ff:ff:ff
 inet 10.8.0.1/24 brd 10.8.0.255 scope global tap0
   valid_lft forever preferred_lft forever
 inet6 fe80::685c:7dff:fe7a:d6e/64 scope link
   valid_lft forever preferred_lft forever
[root@centos8 ~]#tail -n 20 /var/log/openvpn/openvpn.log
[root@centos8 ~]#route -n
</pre>
</div>

<p>
因为客户端为TUN模式,导致连接失败
</p>


<figure id="orga8105f8">
<img src="images/image-20210219195849060.png" alt="image-20210219195849060.png">

</figure>

<p>
修改客户端也为TAP模式
</p>


<figure id="orgd2443ce">
<img src="images/image-20210219195901406.png" alt="image-20210219195901406.png">

</figure>

<p>
再次连接成功
</p>


<figure id="org9c76235">
<img src="images/image-20210219195923050.png" alt="image-20210219195923050.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:4dd0f841-87d9-4a36-ac8c-6e8befc58edc" class="outline-3">
<h3 id="h:4dd0f841-87d9-4a36-ac8c-6e8befc58edc">4 OpenVPN 高级功能</h3>
<div class="outline-text-3" id="text-h:4dd0f841-87d9-4a36-ac8c-6e8befc58edc">
<p>
本节介绍OpenVPN的高级功能,主要关于安全加强及客户端的管理功能,比如:员工入职、离职涉及到的创建账户与吊销账户证书。
</p>
</div>
<div id="outline-container-h:12e96174-9deb-4789-ae14-6e3cd287fe4a" class="outline-4">
<h4 id="h:12e96174-9deb-4789-ae14-6e3cd287fe4a">4.1 启用安全增强功能</h4>
<div class="outline-text-4" id="text-h:12e96174-9deb-4789-ae14-6e3cd287fe4a">
<p>
<b>启用防止DoS攻击的安全增强配置</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@openvpn-server ~]#openvpn --genkey --secret /etc/openvpn/certs/ta.key
[root@openvpn-server ~]#cat /etc/openvpn/certs/ta.key
<span style="color: #b22222;">#</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">2048 bit OpenVPN static key</span>

<span style="color: #b22222;">#</span>
-----BEGIN OpenVPN Static key V1-----
98f2e8b46308ad6c40fdbcb53cbafce6
e3f7970ddae64849f4c160047fc88866
f717dab259981ea836eeb7ef31a778d9
1cc8b20962c79cb3d2fda168819bc8c6
bc8386f0de5264712d8ebb358c8c8f2a
dcd5a1e15a3e3f76346e84496ba12052
2c53a5f055486c9200ef0855d2df9e9e
ecc71a8c4dd8bec1ff15ac20e44aec77
52c289b343a20979c3b52ea466585073
c14752e40e6b8ce5ef5d0f8ed894a82e
ff8c6f784c7ec9b87f51cdaad9ee06b2
ea22307d87c1e6b31292819e0d8ddcf7
dc324b5a7e968ae1b3334f61af6a4b6e
91a2992a580edbd4b8c584bfbe7fa8f4
1a22ca55777827c49b237157d03d1d68
75fc0d4eb632da7e61d258594ade093b
-----END OpenVPN Static key V1-----
[root@openvpn-server ~]#ll /etc/openvpn/certs/
total 24
-rw------- 1 root root 1204 Jan 26 14:03 ca.crt
-rw------- 1 root root  424 Jan 26 14:04 dh.pem
-rw------- 1 root root 4608 Jan 26 14:04 server.crt
-rw------- 1 root root 1704 Jan 26 14:04 server.key
-rw------- 1 root root  636 Jan 26 15:38 ta.key
[root@openvpn-server ~]#vim /etc/openvpn/server.conf
tls-auth /etc/openvpn/certs/ta.key 0    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#31471;&#20026;0&#65292;&#23458;&#25143;&#31471;&#20026;1</span>

[root@centos8 ~]#systemctl restart openvpn@server.service
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26085;&#24535;&#25552;&#31034;&#20986;&#38169;</span>
root@centos8 ~]#tail -n 20 /var/log/openvpn/openvpn.log -f
Tue Aug &#160;4 15:56:30 2020 TLS Error: cannot locate HMAC<span style="color: #a020f0;"> in</span> incoming packet from
[AF_INET]10.0.0.1:59743
Tue Aug &#160;4 15:56:39 2020 TLS Error: cannot locate HMAC<span style="color: #a020f0;"> in</span> incoming packet from
[AF_INET]10.0.0.1:59743
Tue Aug &#160;4 15:56:45 2020 TLS Error: cannot locate HMAC<span style="color: #a020f0;"> in</span> incoming packet from
[AF_INET]10.0.0.1:59073
</pre>
</div>

<p>
客户端无法直接连接
</p>


<figure id="orgf71dd98">
<img src="images/image-20210219200205054.png" alt="image-20210219200205054.png">

</figure>

<p>
将ta.key 传到客户端相关目录下
</p>


<figure id="orgb20d544">
<img src="images/image-20210219200219373.png" alt="image-20210219200219373.png">

</figure>

<p>
修改客户端配置文件clent.ovpn,添加一行
</p>


<figure id="org7b40079">
<img src="images/image-20210219200245255.png" alt="image-20210219200245255.png">

</figure>

<p>
客户端重新连接成功
</p>


<figure id="org6bdee86">
<img src="images/image-20210219200259278.png" alt="image-20210219200259278.png">

</figure>

<p>
<b>客户端配置文件需要添加tls-auth ta.key 1,并把key文件放到客户端中</b>
</p>
</div>
</div>
<div id="outline-container-h:c2528db0-7338-48ab-a40e-3dbcd0378005" class="outline-4">
<h4 id="h:c2528db0-7338-48ab-a40e-3dbcd0378005">4.2 设置客户端的私钥密码增强安全性</h4>
<div class="outline-text-4" id="text-h:c2528db0-7338-48ab-a40e-3dbcd0378005">
<p>
新建一个账户cy，并且设置证书密码，提高证书及登录VPN的安全性。
</p>
</div>
<div id="outline-container-h:a16c0d4f-5bff-468e-92bf-f84a78775ce6" class="outline-5">
<h5 id="h:a16c0d4f-5bff-468e-92bf-f84a78775ce6">4.2.1 创建新用户,生成对应的有密码的私钥和证书申请</h5>
<div class="outline-text-5" id="text-h:a16c0d4f-5bff-468e-92bf-f84a78775ce6">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /etc/openvpn/easy-rsa-client/3
<span style="color: #b22222;">#</span><span style="color: #b22222;">./easyrsa gen-req cy  nopass # &#19981;&#24102;&#23494;&#30721;&#30340;&#35777;&#20070;</span>
./easyrsa gen-req cy         <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24102;&#23494;&#30721;&#30340;&#35777;&#20070; 123456</span>
[root@openvpn-server 3]#./easyrsa gen-req cy  

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.8/vars
Using SSL: openssl OpenSSL 1.1.1g FIPS  21 Apr 2020
Generating a RSA private key
..............+++++
....................+++++
writing new private key to <span style="color: #8b2252;">'/etc/openvpn/easy-rsa-client/3/pki/easy-rsa-14457.v8A2IC/tmp.k97esu'</span>
Enter PEM pass phrase:              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20837;2&#36941;&#23494;&#30721;</span>
Verifying - Enter PEM pass phrase:
----------------------------------

You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span style="color: #8b2252;">'.'</span>, the field will be left blank.
-----------------------------------------------

Common Name (eg: your user, host, or server name) [cy]:   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#30830;&#35748;</span>

Keypair and certificate request completed. Your files are:
req: /etc/openvpn/easy-rsa-client/3/pki/reqs/cy.req
key: /etc/openvpn/easy-rsa-client/3/pki/private/cy.key
</pre>
</div>
</div>
</div>
<div id="outline-container-h:69b61b84-d5e9-4fbd-aa16-d772c98ffff4" class="outline-5">
<h5 id="h:69b61b84-d5e9-4fbd-aa16-d772c98ffff4">4.2.2 导入用户证书申请并颁发证书</h5>
<div class="outline-text-5" id="text-h:69b61b84-d5e9-4fbd-aa16-d772c98ffff4">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">cd /etc/openvpn/easy-rsa-server/3</span>
./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/cy.req cy
ll /etc/openvpn/easy-rsa-server/3/pki/reqs/cy.req

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#20445;&#35777;&#20070;&#26377;&#25928;&#26399;&#26159;&#21512;&#29702;&#20540;</span>
[root@centos8 3]#grep EASYRSA_CERT_EXPIRE vars
set_var EASYRSA_CERT_EXPIRE 90

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39041;&#21457;&#35777;&#20070;</span>
[root@openvpn-server 3]#./easyrsa sign client cy
Confirm request details: yes
Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/cy.crt
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c4450466-863e-48c3-be3f-03c2dc5e5110" class="outline-5">
<h5 id="h:c4450466-863e-48c3-be3f-03c2dc5e5110">4.2.3 将用户的证书相关文件放在指定的目录中</h5>
<div class="outline-text-5" id="text-h:c4450466-863e-48c3-be3f-03c2dc5e5110">
<div class="org-src-container">
<pre class="src src-sh">mkdir /etc/openvpn/client/cy
cp /etc/openvpn/easy-rsa-server/3/pki/issued/cy.crt /etc/openvpn/client/cy
cp /etc/openvpn/easy-rsa-server/3/pki/private/cy.key /etc/openvpn/client/cy
cp /etc/openvpn/certs/{ca.crt,dh.pem,ta.key} /etc/openvpn/client/cy
cp /etc/openvpn/client/client-x/client.ovpn /etc/openvpn/client/cy

[root@openvpn-server 3]#ll /etc/openvpn/client/cy/
total 28
-rw------- 1 root root 1204 Jan 26 15:55 ca.crt
-rw-r--r-- 1 root root  255 Jan 26 15:56 client.ovpn
-rw------- 1 root root 4484 Jan 26 15:53 cy.crt
-rw------- 1 root root 1854 Jan 26 16:00 cy.key
-rw------- 1 root root  424 Jan 26 15:55 dh.pem
-rw------- 1 root root  636 Jan 26 15:55 ta.key

[root@openvpn-server 3]#cd /etc/openvpn/client/cy/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26681;&#25454;&#26381;&#21153;&#22120;&#31471;&#20462;&#25913;&#19979;&#38754;&#37197;&#32622;,&#38656;&#35201;&#21644;&#26381;&#21153;&#22120;&#21516;&#27493;</span>
[root@openvpn-server cy]#vim client.ovpn
client
dev tun
proto tcp
remote 39.98.146.209 1194
resolv-retry infinite
nobind
<span style="color: #b22222;">#</span><span style="color: #b22222;">persist-key</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">persist-tun</span>
ca ca.crt
cert cy.crt
key cy.key
remote-cert-tls server
<span style="color: #b22222;">#</span><span style="color: #b22222;">tls-auth ta.key 1</span>
cipher AES-256-CBC
verb 3
compress lz4-v2
tls-auth ta.key 1

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24402;&#26723;&#21387;&#32553;</span>
tar cf cy.tar.gz ./
</pre>
</div>
</div>
</div>
<div id="outline-container-h:58286093-8c0f-43c0-ba90-4babc6b57435" class="outline-5">
<h5 id="h:58286093-8c0f-43c0-ba90-4babc6b57435">4.2.4 将相关文件传给客户端主机相应目录</h5>
<div class="outline-text-5" id="text-h:58286093-8c0f-43c0-ba90-4babc6b57435">
<p>
放置到windows客户端的 C:\Program Files\OpenVPN\config 目录下
</p>
</div>
</div>
<div id="outline-container-h:a1627628-fe62-4bd4-a159-44505bedaf16" class="outline-5">
<h5 id="h:a1627628-fe62-4bd4-a159-44505bedaf16">4.2.5 Windows 客户端重新连接</h5>
<div class="outline-text-5" id="text-h:a1627628-fe62-4bd4-a159-44505bedaf16">
<p>
查看日志
</p>
</div>
</div>
</div>
<div id="outline-container-h:b6271759-8360-4f4c-8c0e-d0284f2f164f" class="outline-4">
<h4 id="h:b6271759-8360-4f4c-8c0e-d0284f2f164f">4.3 账户证书管理</h4>
<div class="outline-text-4" id="text-h:b6271759-8360-4f4c-8c0e-d0284f2f164f">
<p>
主要是证书的创建和吊销，对应的员工的入职和离职
</p>
</div>
<div id="outline-container-h:f81fb728-b163-4d5f-9f29-0e3eedad6ee0" class="outline-5">
<h5 id="h:f81fb728-b163-4d5f-9f29-0e3eedad6ee0">4.3.1 证书自动过期</h5>
<div class="outline-text-5" id="text-h:f81fb728-b163-4d5f-9f29-0e3eedad6ee0">
<p>
过期时间以服务器时间为准，如果过期,需要重新颁发证书
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36807;&#26399;&#26102;&#38388;&#30001;&#20197;&#19979;&#35774;&#32622;&#20915;&#23450;</span>
[root@centos8 ~]#grep EASYRSA_CERT_EXPIRE /etc/openvpn/easy-rsa-server/3/vars
set_var EASYRSA_CERT_EXPIRE 90
</pre>
</div>

<p>
如果证书过期,在服务器端可以看到以下日志
</p>

<pre class="example" id="org8faa3bb">
#让服务器时间改为2年后时间
[root@openvpn-server cy]#date -s '2 year'
Thu Jan 26 16:08:26 CST 2023

#服务器端日志中会显示用户证书过期
[root@openvpn-server cy]#tail -f /var/log/openvpn/openvpn.log -n0
Thu Jan 26 16:10:16 2023 TCP connection established with [AF_INET]110.17.5.83:20296
Thu Jan 26 16:10:16 2023 110.17.5.83:20296 TLS: Initial packet from [AF_INET]110.17.5.83:20296, sid=5b28249e 72485450
Thu Jan 26 16:10:17 2023 110.17.5.83:20296 VERIFY OK: depth=1, CN=Easy-RSA CA
Thu Jan 26 16:10:17 2023 110.17.5.83:20296 VERIFY ERROR: depth=0, error=certificate has expired: CN=cy, serial=311680221580796027677648559459392328591
Thu Jan 26 16:10:17 2023 110.17.5.83:20296 OpenSSL: error:1417C086:SSL routines:tls_process_client_certificate:certificate verify failed
Thu Jan 26 16:10:17 2023 110.17.5.83:20296 TLS_ERROR: BIO read tls_read_plaintext error
Thu Jan 26 16:10:17 2023 110.17.5.83:20296 TLS Error: TLS object -&gt; incoming plaintext read error
Thu Jan 26 16:10:17 2023 110.17.5.83:20296 TLS Error: TLS handshake failed
Thu Jan 26 16:10:17 2023 110.17.5.83:20296 Fatal TLS error (check_tls_errors_co), restarting
Thu Jan 26 16:10:17 2023 110.17.5.83:20296 SIGUSR1[soft,tls-error] received, client-instance restarting
</pre>
</div>
</div>
<div id="outline-container-h:45a98bdb-a793-4fac-b020-bd49cda445de" class="outline-5">
<h5 id="h:45a98bdb-a793-4fac-b020-bd49cda445de">4.3.2 证书手动注销</h5>
<div class="outline-text-5" id="text-h:45a98bdb-a793-4fac-b020-bd49cda445de">
</div>
<ul class="org-ul">
<li><a id="h:32f05fb0-dbf4-44b0-b509-13cc68adecc9"></a>4.3.2.1 查看当前证书的有效性,有效为V,无效为R<br>
<div class="outline-text-6" id="text-h:32f05fb0-dbf4-44b0-b509-13cc68adecc9">
<pre class="example" id="org566f663">
[16:11:54 root@openvpn-server ~]#cat /etc/openvpn/easy-rsa-server/3/pki/index.txt
V   310124043132Z       5D3B930AA9D6B0AF69E65FA76C6251C4    unknown /CN=server
V   210725055946Z       8EB7E418B1FE1715BCBB73A513498893    unknown /CN=client-x
V   210725075159Z       EA7B6D5BC57A40FD5959D1740320938F    unknown /CN=cy
</pre>
</div>
</li>
<li><a id="h:3fb71c41-7370-4914-9e8f-f6b542dd2fd5"></a>4.3.2.2 吊销指定的用户的证书<br>
<div class="outline-text-6" id="text-h:3fb71c41-7370-4914-9e8f-f6b542dd2fd5">
<div class="org-src-container">
<pre class="src src-sh">[root@openvpn-server ~]#cd /etc/openvpn/easy-rsa-server/3
[root@openvpn-server 3]#./easyrsa revoke cy

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars
Using SSL: openssl OpenSSL 1.1.1g FIPS  21 Apr 2020

Please confirm you wish to revoke the certificate with the following subject:

<span style="color: #a0522d;">subject</span>=
commonName                = cy

Type the word <span style="color: #8b2252;">'yes'</span> to continue, or any other input to abort.
Continue with revocation: yes
Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-14869.nncxHf/tmp.36WIhl
Revoking Certificate EA7B6D5BC57A40FD5959D1740320938F.
Data Base Updated

IMPORTANT!!!

Revocation was successful. You must run gen-crl and upload a CRL to your
infrastructure<span style="color: #a020f0;"> in</span> order to prevent the revoked cert from being accepted.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#35777;&#20070;&#30340;&#26377;&#25928;&#24615;,&#26377;&#25928;&#20026;V,&#26080;&#25928;&#20026;R</span>
[root@centos8 3]#cat /etc/openvpn/easy-rsa-server/3/pki/index.txt
V   310124043132Z       5D3B930AA9D6B0AF69E65FA76C6251C4    unknown /CN=server
V   210725055946Z       8EB7E418B1FE1715BCBB73A513498893    unknown /CN=client-x
R   210725075159Z       EA7B6D5BC57A40FD5959D1740320938F    unknown /CN=cy
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#26029;&#24320;&#23458;&#25143;&#31471;&#36830;&#25509;,me&#29992;&#25143;&#20173;&#28982;&#33021;&#36830;&#25509;&#25104;&#21151;</span>
</pre>
</div>
</div>
</li>
<li><a id="h:a249c067-8c2a-4aa9-a8d9-e663b8d36b79"></a>4.3.2.3 生成证书吊销列表<br>
<div class="outline-text-6" id="text-h:a249c067-8c2a-4aa9-a8d9-e663b8d36b79">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#27425;&#21514;&#38144;&#35777;&#20070;&#21518;&#37117;&#38656;&#35201;&#26356;&#26032;&#35777;&#20070;&#21514;&#38144;&#21015;&#34920;&#25991;&#20214;,&#24182;&#19988;&#38656;&#35201;&#37325;&#21551;OpenVPN&#26381;&#21153;</span>
[root@openvpn-server 3]#./easyrsa gen-crl

Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars
Using SSL: openssl OpenSSL 1.1.1g FIPS  21 Apr 2020
Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-14912.pXdWC2/tmp.JqsCVv

An updated CRL has been created.
CRL file: /etc/openvpn/easy-rsa-server/3/pki/crl.pem

[root@openvpn-server 3]#cat pki/crl.pem
-----BEGIN X509 CRL-----
MIIB3DCBxQIBATANBgkqhkiG9w0BAQsFADAWMRQwEgYDVQQDDAtFYXN5LVJTQSBD
QRcNMjEwMTI2MDgxNDQzWhcNMjEwNzI1MDgxNDQzWjAkMCICEQDqe21bxXpA/VlZ
0XQDIJOPFw0yMTAxMjYwODEzMDhaoFUwUzBRBgNVHSMESjBIgBQoyNfaufa2jaEC
RtJ+9ve4X5qANKEapBgwFjEUMBIGA1UEAwwLRWFzeS1SU0EgQ0GCFBB9VrzPLTr+
IL6acSTyhMQ3Yac4MA0GCSqGSIb3DQEBCwUAA4IBAQDALTvWucW3kSW5Dt14uENQ
yF1ad+FkcXxXa3Y3PKR8eQOmc9vL9vTsctR4SvuIT70UmNVZhkGAk+Ioi5SBIKJa
CgMxpZe6u9Slwl5kNy4IVuQYzu59e3azUOb6v4B0rpEI2WxW5Van/niGLKOg/wJt
Nft5IJCrTQF6NBjDugqV9/EIrBa9Pks2qQsShGCj/+VYapGgY7UJxL/1H5STt+Sd
t2CDqj4kFe+yXAgo8CwM2zzPtWkc1pg4U1BwHkVDYZvCoklZshh4a17KfdubXTPQ
NLLMuDu3J0R/Ld2IumxbBl11ys5AOoUG1xVoNQjqV+YJkDDOZOV88FVoloGX/gJo
-----END X509 CRL-----
</pre>
</div>
</div>
</li>
<li><a id="h:ef38e737-92e1-41ba-9384-7643ee28a0c0"></a>4.3.2.4 将吊销列表文件发布<br>
<div class="outline-text-6" id="text-h:ef38e737-92e1-41ba-9384-7643ee28a0c0">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#19968;&#27425;&#21514;&#38144;&#35777;&#26102;&#38656;&#35201;&#32534;&#36753;&#37197;&#32622;&#25991;&#20214;&#35843;&#29992;&#21514;&#38144;&#35777;&#20070;&#30340;&#25991;&#20214;,&#21518;&#32493;&#21514;&#38144;&#26080;&#38656;&#27492;&#27493;</span>
[root@openvpn-server 3]#vim /etc/openvpn/server.conf
crl-verify /etc/openvpn/easy-rsa-server/3/pki/crl.pem

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#27425;&#21514;&#38144;&#35777;&#20070;&#21518;,&#37117;&#38656;&#35201;&#37325;&#26032;&#21551;&#21160;&#25165;&#33021;&#29983;&#25928; ,&#25913;&#25104;&#25903;&#25345;reload&#37325;&#35835;&#37197;&#32622;&#25991;&#20214;&#27604;&#36739;&#22909;</span>
[root@openvpn-server 3]#systemctl restart openvpn@server
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:b8308f8c-2f5a-4c22-851f-58a1e0e386b8" class="outline-5">
<h5 id="h:b8308f8c-2f5a-4c22-851f-58a1e0e386b8">4.3.3 账户重名证书签发</h5>
<div class="outline-text-5" id="text-h:b8308f8c-2f5a-4c22-851f-58a1e0e386b8">
<p>
假如公司已有员工叫me已经离职,且证书已被吊销，现在又新来一个员工仍叫me，那么一般的区分办法是在用户名后面加数字，如:me1、me2等，假如还想使用me这个账户名签发证书的话，那么需要删除服务器之前me的账户，并删除签发记录和证书，否则新用户的证书无法导入，并重新颁发证书
</p>
</div>
<ul class="org-ul">
<li><a id="h:6588a30c-6d35-42eb-a28c-63ca084b4db6"></a>4.3.3.1 手动重新颁发证书<br>
<div class="outline-text-6" id="text-h:6588a30c-6d35-42eb-a28c-63ca084b4db6">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#24050;&#31163;&#32844;&#22791;&#25764;&#38144;&#30340;&#36134;&#25143;&#35777;&#20070;</span>
<span style="color: #483d8b;">cd</span> /etc/openvpn/easy-rsa-client/3/
rm -f pki/private/me.key
rm -f pki/reqs/me.req
rm -rf /etc/openvpn/client/me/*
rm -f /etc/openvpn/easy-rsa-server/3/pki/reqs/me.req
rm -f /etc/openvpn/easy-rsa-server/3/pki/issued/me.crt
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#20043;&#21069;&#30340;&#24102;R&#30340;&#21514;&#38144;&#35760;&#24405;,&#27492;&#20026;&#21487;&#36873;&#39033;</span>
[root@centos8 3]#vim /etc/openvpn/easy-rsa-server/3/pki/index.txt

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#26032;&#29983;&#25104;&#26032;&#30340;&#36134;&#25143;&#35777;&#20070;&#30003;&#35831;&#21644;&#31169;&#38053;</span>
[root@centos8 3]#cd /etc/openvpn//easy-rsa-client/3
[root@centos8 3]#./easyrsa gen-req me
Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars
Using SSL: openssl OpenSSL 1.1.1c FIPS     28 May 2019
Generating a RSA private key
..................................+++++
.........+++++
writing new private key to <span style="color: #8b2252;">'/etc/openvpn/easy-rsa-client/3/pki/easy-rsa-</span>
<span style="color: #8b2252;">26582.hrORzD/tmp.bTOf5p'</span>
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span style="color: #8b2252;">'.'</span>, the field will be left blank.
-----
Common Name (eg: your user, host, or server name) [me]:#&#30452;&#25509;&#22238;&#36710;
Keypair and certificate request completed. Your files are:
req: /etc/openvpn/easy-rsa-client/3/pki/reqs/me.req
key: /etc/openvpn/easy-rsa-client/3/pki/private/me.key

<span style="color: #b22222;">#</span><span style="color: #b22222;">CA&#23548;&#20837;&#35777;&#20070;&#24182;&#31614;&#21457;</span>
[root@centos8 3]#cd /etc/openvpn/easy-rsa-server/3
[root@centos8 3]#./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/me.req me
[root@centos8 3]#./easyrsa sign client me
......
Confirm request details: yes     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20837;yes</span>
......
Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/me.crt

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#30456;&#20851;&#25991;&#20214;</span>
cp /etc/openvpn/easy-rsa-server/3/pki/issued/me.crt /etc/openvpn/client/me/
cp /etc/openvpn/easy-rsa-client/3/pki/private/me.key /etc/openvpn/client/me/
cp /etc/openvpn/certs/{ca.crt,dh.pem,ta.key} /etc/openvpn/client/me/
cp /etc/openvpn/client/zcici/client.ovpn /etc/openvpn/client/me/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#23458;&#25143;&#31471;&#37197;&#32622;&#25991;&#20214;</span>
[root@centos8 3]#vim /etc/openvpn/client/me/client.ovpn
client
dev tun
proto tcp
remote 10.0.0.8 1194
resolv-retry infinite
nobind
<span style="color: #b22222;">#</span><span style="color: #b22222;">persist-key</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">persist-tun</span>
ca ca.crt
cert me.crt
key me.key
remote-cert-tls server
tls-auth ta.key 1
cipher AES-256-CBC
verb 3
compress lz4-v2

[root@centos8 ~]#tree /etc/openvpn/client/me
/etc/openvpn/client/me
&#9500;&#9472;&#9472; ca.crt
&#9500;&#9472;&#9472; client.ovpn
&#9500;&#9472;&#9472; dh.pem
&#9500;&#9472;&#9472; me.crt
&#9500;&#9472;&#9472; me.key
&#9492;&#9472;&#9472; ta.key

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;/etc/openvpn/client/me&#25152;&#26377;&#25991;&#20214;&#25171;&#21253;&#20256;&#21040;&#23458;&#25143;&#31471;&#29992;</span>
</pre>
</div>
</div>
</li>
<li><a id="h:ce018f8b-f2a7-4699-8409-7dfe44a7bece"></a>4.3.3.2 自动化的证书颁发脚本<br>
<div class="outline-text-6" id="text-h:ce018f8b-f2a7-4699-8409-7dfe44a7bece">
<p>
通过脚本实现自动化的证书颁发
</p>

<pre class="example" id="org2890857">
1.在easy-rsa-client证书环境生成req和key文件
2.在easy-rsa-server导入req文件
3.在easy-rsa-server签发证书
4.证书整理
5.自动生成密码记录密码，打包客户端证书
</pre>

<p>
脚本内容
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat openvpn-user-crt.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #b22222;">#</span>
<span style="color: #483d8b;">.</span> /etc/init.d/functions
<span style="color: #a0522d;">OPENVPN_SERVER</span>=&lt;OpenVPN Server &#20844;&#32593;IP&gt;
<span style="color: #a0522d;">PASS</span>=123456
<span style="color: #0000ff;">remove_cert</span> () {
        rm -rf /etc/openvpn/client/${<span style="color: #a0522d;">NAME</span>}
        find /etc/openvpn/ -name <span style="color: #8b2252;">"$NAME.*"</span> -delete
}
<span style="color: #0000ff;">create_cert</span> () {
        <span style="color: #483d8b;">cd</span> /etc/openvpn/easy-rsa-client/3
    ./easyrsa gen-req ${<span style="color: #a0522d;">NAME</span>} nopass &lt;&lt;EOF
<span style="color: #ffa54f;">EOF</span>
        <span style="color: #483d8b;">cd</span> /etc/openvpn/easy-rsa-server/3
    ./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/${<span style="color: #a0522d;">NAME</span>}.req
${<span style="color: #a0522d;">NAME</span>}
    ./easyrsa sign client ${<span style="color: #a0522d;">NAME</span>} &lt;&lt;EOF
<span style="color: #ffa54f;">yes</span>
<span style="color: #ffa54f;">EOF</span>

        mkdir /etc/openvpn/client/${<span style="color: #a0522d;">NAME</span>}
        cp /etc/openvpn/easy-rsa-server/3/pki/issued/${<span style="color: #a0522d;">NAME</span>}.crt /etc/openvpn/client/${<span style="color: #a0522d;">NAME</span>}
        cp /etc/openvpn/easy-rsa-client/3/pki/private/${<span style="color: #a0522d;">NAME</span>}.key /etc/openvpn/client/${<span style="color: #a0522d;">NAME</span>}
        cp /etc/openvpn/certs/{ca.crt,dh.pem,ta.key} /etc/openvpn/client/${<span style="color: #a0522d;">NAME</span>}
        cat &gt; /etc/openvpn/client/${<span style="color: #a0522d;">NAME</span>}/client.ovpn &lt;&lt;EOF
<span style="color: #ffa54f;">client</span>
<span style="color: #ffa54f;">dev tun</span>
<span style="color: #ffa54f;">proto tcp</span>
<span style="color: #ffa54f;">remote 10.0.0.8 1194</span>
<span style="color: #ffa54f;">resolv-retry infinite</span>
<span style="color: #ffa54f;">nobind</span>
<span style="color: #ffa54f;">#persist-key</span>
<span style="color: #ffa54f;">#persist-tun</span>
<span style="color: #ffa54f;">ca ca.crt</span>
<span style="color: #ffa54f;">cert $NAME.crt</span>
<span style="color: #ffa54f;">key $NAME.key</span>
<span style="color: #ffa54f;">remote-cert-tls server</span>
<span style="color: #ffa54f;">tls-auth ta.key 1</span>
<span style="color: #ffa54f;">cipher AES-256-CBC</span>
<span style="color: #ffa54f;">verb 3</span>
<span style="color: #ffa54f;">compress lz4-v2</span>
<span style="color: #ffa54f;">EOF</span>
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&#35777;&#20070;&#23384;&#25918;&#36335;&#24452;:/etc/openvpn/client/${NAME},&#35777;&#20070;&#25991;&#20214;&#22914;&#19979;:"</span>
        <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\E[1;32m******************************************************************\E[0m"</span>
        ls -l /etc/openvpn/client/${<span style="color: #a0522d;">NAME</span>}
        <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"\E[1;32m******************************************************************\E[0m"</span>
        <span style="color: #483d8b;">cd</span> /etc/openvpn/client/${<span style="color: #a0522d;">NAME</span>}
    zip -qP <span style="color: #8b2252;">"$PASS"</span> /root/${<span style="color: #a0522d;">NAME</span>}.zip *
    action     <span style="color: #8b2252;">"&#35777;&#20070;&#30340;&#25171;&#21253;&#25991;&#20214;&#24050;&#29983;&#25104;: /root/${NAME}.zip"</span>
}
<span style="color: #483d8b;">read</span> -p <span style="color: #8b2252;">"&#35831;&#36755;&#20837;&#29992;&#25143;&#30340;&#22995;&#21517;&#25340;&#38899;(&#22914;:zcici): "</span> NAME
remove_cert
create_cert
</pre>
</div>

<p>
执行脚本
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#bash openvpn-user-crt.sh
<span style="color: #0000ff;">&#35831;&#36755;&#20837;&#29992;&#25143;&#30340;&#22995;&#21517;&#25340;&#38899;</span>(&#22914;:): me
Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-client/3.0.7/vars
Using SSL: openssl OpenSSL 1.1.1c FIPS     28 May 2019
Generating a RSA private key
................................................................................
................................................................................
............................+++++
............................................................................++++
+
writing new private key to <span style="color: #8b2252;">'/etc/openvpn/easy-rsa-client/3/pki/easy-rsa-</span>
<span style="color: #8b2252;">13504.eqdKk5/tmp.kowkjQ'</span>
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span style="color: #8b2252;">'.'</span>, the field will be left blank.
-----
Common Name (eg: your user, host, or server name) [me]:
Keypair and certificate request completed. Your files are:
req: /etc/openvpn/easy-rsa-client/3/pki/reqs/me.req
key: /etc/openvpn/easy-rsa-client/3/pki/private/me.key
Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars
Using SSL: openssl OpenSSL 1.1.1c FIPS     28 May 2019
The request has been successfully imported with a short name of: me
You may now use this name to perform signing operations on this request.
Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.7/vars
Using SSL: openssl OpenSSL 1.1.1c FIPS     28 May 2019
You are about to sign the following certificate.
Please check over the details shown below for accuracy. Note that this request
has not been cryptographically verified. Please be sure it came from a trusted
<span style="color: #483d8b;">source</span> or that you have verified the request checksum with the sender.
Request subject, to be signed as a client certificate for 90 days:
<span style="color: #a0522d;">subject</span>=
    commonName                                 = me
Type the word <span style="color: #8b2252;">'yes'</span> to continue, or any other input to abort.
Confirm request details: Using configuration from /etc/openvpn/easy-rsa-
server/3/pki/easy-rsa-13552.TvELex/tmp.Gx7dds
Check that the request matches the signature
Signature ok
The Subject<span style="color: #8b2252;">'s Distinguished Name is as follows</span>
<span style="color: #8b2252;">commonName                     :ASN.1 12:'</span>me<span style="color: #8b2252;">'</span>
<span style="color: #8b2252;">Certificate is to be certified until Nov     3 13:50:50 2020 GMT (90 days)</span>
<span style="color: #8b2252;">Write out database with 1 new entries</span>
<span style="color: #8b2252;">Data Base Updated</span>
<span style="color: #8b2252;">Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/me.crt</span>
<span style="color: #8b2252;">&#35777;&#20070;&#23384;&#25918;&#36335;&#24452;:/etc/openvpn/client/me,&#35777;&#20070;&#25991;&#20214;&#22914;&#19979;:</span>
<span style="color: #8b2252;">******************************************************************</span>
<span style="color: #8b2252;">total 28</span>
<span style="color: #8b2252;">-rw------- 1 root root 1204 Aug     5 21:50 ca.crt</span>
<span style="color: #8b2252;">-rw-r--r-- 1 root root     225 Aug     5 21:50 client.ovpn</span>
<span style="color: #8b2252;">-rw------- 1 root root     424 Aug     5 21:50 dh.pem</span>
<span style="color: #8b2252;">-rw------- 1 root root 4492 Aug     5 21:50 me.crt</span>
<span style="color: #8b2252;">-rw------- 1 root root 1704 Aug     5 21:50 me.key</span>
<span style="color: #8b2252;">-rw------- 1 root root     636 Aug     5 21:50 ta.key</span>
<span style="color: #8b2252;">******************************************************************</span>
<span style="color: #8b2252;">&#35777;&#20070;&#30340;&#25171;&#21253;&#25991;&#20214;&#24050;&#29983;&#25104;: /root/me.zip                                 [ OK ]</span>
</pre>
</div>
</div>
</li>
<li><a id="h:d8bab5f1-cdcf-4102-b0e4-d97812a4f8ac"></a>4.3.3.3 在Windows客户端用新证书连接登录<br>
<div class="outline-text-6" id="text-h:d8bab5f1-cdcf-4102-b0e4-d97812a4f8ac">

<figure id="org5522ae7">
<img src="images/image-20210219201049239.png" alt="image-20210219201049239.png">

<figcaption><span class="figure-number">Figure 3: </span>image-20210219201049239</figcaption>
</figure>


<figure id="org8b1ab34">
<img src="images/image-20210219201055887.png" alt="image-20210219201055887.png">

<figcaption><span class="figure-number">Figure 4: </span>image-20210219201055887</figcaption>
</figure>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:13a1ca04-cdbe-4f5a-89bd-ba552e816c81" class="outline-4">
<h4 id="h:13a1ca04-cdbe-4f5a-89bd-ba552e816c81">4.4 生产推荐配置文件</h4>
<div class="outline-text-4" id="text-h:13a1ca04-cdbe-4f5a-89bd-ba552e816c81">
<p>
server端和client端的生产推荐配置文件分别如下
</p>
</div>
<div id="outline-container-h:40445c56-da42-4f16-8bf1-1bf48b0fa934" class="outline-5">
<h5 id="h:40445c56-da42-4f16-8bf1-1bf48b0fa934">4.4.1 server 端配置</h5>
<div class="outline-text-5" id="text-h:40445c56-da42-4f16-8bf1-1bf48b0fa934">
<div class="org-src-container">
<pre class="src src-sh">[root@openvpn-server ~]# cat /etc/openvpn/server.conf
port 1194
proto tcp
<span style="color: #b22222;">#</span><span style="color: #b22222;">pexplicit-exit-notify 1</span>
dev tun
ca /etc/openvpn/certs/ca.crt
cert /etc/openvpn/certs/server.crt
key /etc/openvpn/certs/server.key
dh /etc/openvpn/certs/dh.pem
server 10.0.0.0 255.255.255.0
push <span style="color: #8b2252;">"route 172.30.0.0 255.255.255.0"</span>
keepalive 10 120
cipher AES-256-CBC
compress lz4-v2
push <span style="color: #8b2252;">"compress lz4-v2"</span>
;comp-lzo
max-clients 2048
user openvpn
group openvpn
status /var/log/openvpn/openvpn-status.log
log-append /var/log/openvpn/openvpn.log
verb 3
mute 200
tls-auth /etc/openvpn/certs/ta.key 0
crl-verify /etc/openvpn/easy-rsa-server/3/pki/crl.pem <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#19968;&#27425;&#21514;&#38144;&#35777;&#26102;&#38656;&#35201;&#32534;&#36753;&#37197;&#32622;&#25991;&#20214;&#35843;&#29992;&#21514;&#38144;&#35777;&#20070;&#30340;&#25991;&#20214;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9b6ae1dd-ebc9-44dd-8ce6-df6ee4b2ac6e" class="outline-5">
<h5 id="h:9b6ae1dd-ebc9-44dd-8ce6-df6ee4b2ac6e">4.4.2 client 端配置</h5>
<div class="outline-text-5" id="text-h:9b6ae1dd-ebc9-44dd-8ce6-df6ee4b2ac6e">
<div class="org-src-container">
<pre class="src src-sh">[root@openvpn-server ~]# cat /etc/openvpn/client-file/client.ovpn
client
dev tun
proto tcp
remote 39.98.146.209 1194
resolv-retry infinite
nobind
<span style="color: #b22222;">#</span><span style="color: #b22222;">persist-key</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">persist-tun</span>
ca ca.crt
cert client.crt
key client.key
remote-cert-tls server
<span style="color: #b22222;">#</span><span style="color: #b22222;">tls-auth ta.key 1</span>
cipher AES-256-CBC
verb 3
compress lz4-v2
tls-auth ta.key 1
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ef0e6c0e-2c46-4cdf-ada2-01cb59cb4d5e" class="outline-4">
<h4 id="h:ef0e6c0e-2c46-4cdf-ada2-01cb59cb4d5e">4.5 插件</h4>
<div class="outline-text-4" id="text-h:ef0e6c0e-2c46-4cdf-ada2-01cb59cb4d5e">
</div>
<div id="outline-container-h:fd56f202-7162-4ac3-966f-a7ec9cf9af8e" class="outline-5">
<h5 id="h:fd56f202-7162-4ac3-966f-a7ec9cf9af8e">4.5.1 脚本插件</h5>
<div class="outline-text-5" id="text-h:fd56f202-7162-4ac3-966f-a7ec9cf9af8e">
<p>
脚本插件可以通过在服务器端配置文件中添加 auth-user-pass-verify
指令来使用
</p>

<div class="org-src-container">
<pre class="src src-sh">auth-user-pass-verify auth-pam.pl via-file
</pre>
</div>

<p>
范例：基于用户名密码登录
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1.&#39318;&#20808;&#25105;&#20204;&#38656;&#35201;&#32534;&#20889;&#19968;&#20010;&#29992;&#25143;&#35748;&#35777;&#30340;&#33050;&#26412; (&#33050;&#26412;&#26159;&#30001;openvpn&#23448;&#32593;&#25552;&#20379;&#30340;)</span>
cat &lt;&lt;\EOF &gt;&gt; /etc/openvpn/checkpsw.sh 
<span style="color: #ffa54f;">#!/bin/sh</span>
<span style="color: #ffa54f;">###########################################################</span>
<span style="color: #ffa54f;"># checkpsw.sh (C) 2004 Mathias Sundman </span>
<span style="color: #ffa54f;">#</span>
<span style="color: #ffa54f;"># This script will authenticate OpenVPN users against</span>
<span style="color: #ffa54f;"># a plain text file. The passfile should simply contain</span>
<span style="color: #ffa54f;"># one row per user with the username first followed by</span>
<span style="color: #ffa54f;"># one or more space(s) or tab(s) and then the password.</span>

<span style="color: #ffa54f;">PASSFILE="/etc/openvpn/psw-file"</span>
<span style="color: #ffa54f;">LOG_FILE="/etc/openvpn/openvpn-password.log"</span>
<span style="color: #ffa54f;">TIME_STAMP=`date "+%Y-%m-%d %T"`</span>

<span style="color: #ffa54f;">###########################################################</span>

<span style="color: #ffa54f;">if [ ! -r "${PASSFILE}" ]; then</span>
<span style="color: #ffa54f;">  echo "${TIME_STAMP}: Could not open password file \"${PASSFILE}\" for reading." &gt;&gt; ${LOG_FILE}</span>
<span style="color: #ffa54f;">  exit 1</span>
<span style="color: #ffa54f;">fi</span>

<span style="color: #ffa54f;">CORRECT_PASSWORD=`awk '!/^;/&amp;&amp;!/^#/&amp;&amp;$1=="'${username}'"{print $2;exit}' ${PASSFILE}`</span>

<span style="color: #ffa54f;">if [ "${CORRECT_PASSWORD}" = "" ]; then </span>
<span style="color: #ffa54f;">  echo "${TIME_STAMP}: User does not exist: username=\"${username}\", password=\"${password}\"." &gt;&gt; ${LOG_FILE}</span>
<span style="color: #ffa54f;">  exit 1</span>
<span style="color: #ffa54f;">fi</span>

<span style="color: #ffa54f;">if [ "${password}" = "${CORRECT_PASSWORD}" ]; then </span>
<span style="color: #ffa54f;">  echo "${TIME_STAMP}: Successful authentication: username=\"${username}\"." &gt;&gt; ${LOG_FILE}</span>
<span style="color: #ffa54f;">  exit 0</span>
<span style="color: #ffa54f;">fi</span>

<span style="color: #ffa54f;">echo "${TIME_STAMP}: Incorrect password: username=\"${username}\", password=\"${password}\"." &gt;&gt; ${LOG_FILE}</span>
<span style="color: #ffa54f;">exit 1</span>
<span style="color: #ffa54f;">EOF</span>

chmod 755 /etc/openvpn/checkpsw.sh <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33050;&#26412;&#21152;&#25191;&#34892;&#26435;&#38480;</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">2.&#29616;&#22312;&#25105;&#20204;&#37197;&#32622;&#29992;&#25143;&#23494;&#30721;&#25991;&#20214;</span>
cat /etc/openvpn/psw-file 
abcdocker 123456
abc 123456
<span style="color: #483d8b;">test</span> test
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21069;&#38754;&#20026;&#29992;&#25143;&#21517;&#65292;&#21518;&#38754;&#20026;&#23494;&#30721;&#12290; &#20013;&#38388;&#20351;&#29992;&#31354;&#26684;&#20998;&#24320;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">3.&#37197;&#32622;openvpn&#30340;server.conf</span>
cat &gt;&gt;/etc/openvpn/server.conf&lt;&lt;EOF
<span style="color: #ffa54f;">script-security 3 system             #&#20801;&#35768;&#36890;&#36807;&#29615;&#22659;&#21464;&#37327;&#23558;&#23494;&#30721;&#20256;&#36882;&#32473;&#33050;&#26412;   </span>
<span style="color: #ffa54f;">auth-user-pass-verify /etc/openvpn/checkpsw.sh via-env    #&#25351;&#23450;&#29992;&#25143;&#35748;&#35777;&#33050;&#26412;</span>
<span style="color: #ffa54f;">client-cert-not-required             #&#19981;&#20351;&#29992;&#23458;&#25143;&#31471;&#35777;&#20070;&#65292;&#20351;&#29992;&#23494;&#30721;&#23545;</span>
<span style="color: #ffa54f;">username-as-common-name              #&#20351;&#29992;&#35748;&#35777;&#29992;&#25143;&#21517;&#65292;&#19981;&#20351;&#29992;&#35777;&#20070;&#30340;common name</span>
<span style="color: #ffa54f;">EOF</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;service.conf&#26368;&#21518;&#19968;&#34892;&#28155;&#21152;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">4.&#20462;&#25913;client.ovpn</span>
client
dev tun
proto tcp
remote 192.168.0.11 1194
resolv-retry infinite
nobind
persist-key
persist-tun
ca ca.crt
;cert cyh.crt      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#37322;</span>
;key cyh.key       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#37322;</span>
tls-auth ta.key 1
cipher AES-256-CBC
comp-lzo
verb 3
auth-user-pass              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#29992;&#25143;&#21517;&#23494;&#30721;&#30331;&#24405;openvpn&#26381;&#21153;&#22120;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#35201;&#26159;&#27880;&#37322;crt&#21644;key&#36335;&#24452;&#65292;&#20197;&#21450;&#28155;&#21152;&#19968;&#34892;auth-user-pass</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">5.&#37325;&#21551;openvpn</span>
systemctl restart openvpn@server
</pre>
</div>


<figure id="org3eacee8">
<img src="images/image-20210429150819395.png" alt="image-20210429150819395.png">

</figure>
</div>
</div>
<div id="outline-container-h:93d0012d-5580-4b38-9d7b-caef61460085" class="outline-5">
<h5 id="h:93d0012d-5580-4b38-9d7b-caef61460085">4.5.2 mysql插件</h5>
<div class="outline-text-5" id="text-h:93d0012d-5580-4b38-9d7b-caef61460085">
<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1.&#21019;&#24314;mysql&#24211;&#34920;</span>
mysql&gt; create database openvpn;
mysql&gt; use openvpn;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#29992;&#25143;&#34920;</span>
mysql&gt; create table vpnuser (
   name         char (100) not null,
   password     char (255) default null,
   active       int (10) not null default 1,
   primary key  (name)
   );
mysql&gt; desc vpnuser;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#30331;&#24405;&#34920;</span>
mysql&gt; create table logtable (
   msg     char (254),
   user    char (100),
   pid     char (100),
   host    char (100),
   rhost   char (100),
   <span style="color: #a020f0;">time</span>    char (100)
   );
mysql&gt; desc logtable;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25554;&#20837;&#19968;&#26465;&#29992;&#25143;&#25968;&#25454;&#65292;&#29992;&#25143;&#21517;test1 &#23494;&#30721;test1</span>
mysql&gt; insert into vpnuser (name,password) values (<span style="color: #8b2252;">'test1'</span>,password(<span style="color: #8b2252;">'test1'</span>));
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#24211;&#25480;&#26435;&#36830;&#25509;&#36134;&#21495;</span>
mysql&gt; grant all on openvpn.* to vpn@<span style="color: #8b2252;">'localhost'</span> identified by <span style="color: #8b2252;">'vpn'</span>;
mysql&gt; flush privileges;

<span style="color: #b22222;">#</span><span style="color: #b22222;">2.&#23433;&#35013;pam_mysql&#27169;&#22359;</span>
yum install pam_mysql -y
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;pam_mysql&#27169;&#22359;</span>
vim /etc/pam.d/openvpn
auth sufficient pam_mysql.so <span style="color: #a0522d;">user</span>=vpn <span style="color: #a0522d;">passwd</span>=vpn <span style="color: #a0522d;">host</span>=localhost <span style="color: #a0522d;">db</span>=openvpn <span style="color: #a0522d;">table</span>=vpnuser <span style="color: #a0522d;">usercolumn</span>=name <span style="color: #a0522d;">passwdcolumn</span>=password [<span style="color: #a0522d;">where</span>=vpnuser.active=1] <span style="color: #a0522d;">sqllog</span>=0 <span style="color: #a0522d;">crypt</span>=2 <span style="color: #a0522d;">sqllog</span>=true <span style="color: #a0522d;">logtable</span>=logtable <span style="color: #a0522d;">logmsgcolumn</span>=msg <span style="color: #a0522d;">logusercolumn</span>=user <span style="color: #a0522d;">logpidcolumn</span>=pid <span style="color: #a0522d;">loghostcolumn</span>=host <span style="color: #a0522d;">logrhostcolumn</span>=rhost <span style="color: #a0522d;">logtimecolumn</span>=time
account required pam_mysql.so <span style="color: #a0522d;">user</span>=vpn <span style="color: #a0522d;">passwd</span>=vpn <span style="color: #a0522d;">host</span>=localhost <span style="color: #a0522d;">db</span>=openvpn <span style="color: #a0522d;">table</span>=vpnuser <span style="color: #a0522d;">usercolumn</span>=name <span style="color: #a0522d;">passwdcolumn</span>=password [<span style="color: #a0522d;">where</span>=vpnuser.active=1] <span style="color: #a0522d;">sqllog</span>=0 <span style="color: #a0522d;">crypt</span>=2 <span style="color: #a0522d;">sqllog</span>=true <span style="color: #a0522d;">logtable</span>=logtable <span style="color: #a0522d;">logmsgcolumn</span>=msg <span style="color: #a0522d;">logusercolumn</span>=user <span style="color: #a0522d;">logpidcolumn</span>=pid <span style="color: #a0522d;">loghostcolumn</span>=host <span style="color: #a0522d;">logrhostcolumn</span>=rhost <span style="color: #a0522d;">logtimecolumn</span>=time
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;testsaslauthd&#39564;&#35777;&#30331;&#24405;&#24773;&#20917;&#65292;&#22914;&#26524;&#20986;&#29616;&#19979;&#38754;&#30340;&#24773;&#20917;&#65292;&#35828;&#26126;&#25105;&#20204;&#30340;&#37197;&#32622;&#26159;&#27491;&#30830;&#30340;</span>
[root@iosvpn ~]# saslauthd -a pam
[root@iosvpn ~]# testsaslauthd -u test1 -p test1 -s openvpn
0: OK <span style="color: #8b2252;">"Success."</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">3.&#23433;&#35013;Openvpn&#26381;&#21153;&#22120;auth-pam&#25554;&#20214;</span>
yum install pam_devel -y
wget http://pkgs.fedoraproject.org/repo/pkgs/openvpn/openvpn-2.0.7.tar.gz/93528233f1f6d02fc18e2c00f82e0aca/openvpn-2.0.7.tar.gz 
tar xf openvpn-2.0.7.tar.gz 
<span style="color: #483d8b;">cd</span> openvpn-2.0.7/plugin/auth-pam/
make

cp openvpn-auth-pam.so /etc/openvpn/

<span style="color: #b22222;">#</span><span style="color: #b22222;">4.&#37197;&#32622;openvpn&#30340;server.conf</span>
cat &gt;&gt;/etc/openvpn/server.conf&lt;&lt;EOF
<span style="color: #ffa54f;">script-security 3 system             #&#20801;&#35768;&#36890;&#36807;&#29615;&#22659;&#21464;&#37327;&#23558;&#23494;&#30721;&#20256;&#36882;&#32473;&#33050;&#26412;   </span>
<span style="color: #ffa54f;">plugin /etc/openvpn/openvpn-auth-pam.so openvpn  #&#25351;&#23450;&#29992;&#25143;&#35748;&#35777;&#33050;&#26412;</span>
<span style="color: #ffa54f;">client-cert-not-required             #&#19981;&#20351;&#29992;&#23458;&#25143;&#31471;&#35777;&#20070;&#65292;&#20351;&#29992;&#23494;&#30721;&#23545;</span>
<span style="color: #ffa54f;">username-as-common-name              #&#20351;&#29992;&#35748;&#35777;&#29992;&#25143;&#21517;&#65292;&#19981;&#20351;&#29992;&#35777;&#20070;&#30340;common name</span>
<span style="color: #ffa54f;">EOF</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;service.conf&#26368;&#21518;&#19968;&#34892;&#28155;&#21152;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">5.&#23458;&#25143;&#31471;&#37197;&#32622;&#25991;&#20214;client.ovpn</span>
client
dev tun
proto tcp
remote 192.168.0.11 1194
resolv-retry infinite
nobind
persist-key
persist-tun
ca ca.crt
;cert cyh.crt      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#37322;</span>
;key cyh.key       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#37322;</span>
tls-auth ta.key 1
cipher AES-256-CBC
comp-lzo
verb 3
auth-user-pass              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#29992;&#25143;&#21517;&#23494;&#30721;&#30331;&#24405;openvpn&#26381;&#21153;&#22120;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#35201;&#26159;&#27880;&#37322;crt&#21644;key&#36335;&#24452;&#65292;&#20197;&#21450;&#28155;&#21152;&#19968;&#34892;auth-user-pass</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">6.&#37325;&#21551;openvpn</span>
systemctl restart openvpn@server

<span style="color: #b22222;">#</span><span style="color: #b22222;">7.&#30331;&#24405;&#39564;&#35777;</span>
&#26597;&#30475;vpn&#29992;&#25143;&#30331;&#24405;&#34920;
<span style="color: #a020f0;">select</span> from * logtable;

<span style="color: #b22222;">#</span><span style="color: #b22222;">8.&#31105;&#29992;&#26576;&#20010;&#29992;&#25143;&#30331;&#24405;</span>
&#21482;&#35201;&#25226;&#29992;&#25143;&#34920;&#37324;&#38754;&#30340;&#23545;&#24212;&#29992;&#25143;&#30340;active&#25913;&#20026;0&#65292;&#29992;&#25143;&#23601;&#26080;&#27861;&#30331;&#24405;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f41d8bee-6865-441a-816e-6c43816c254a" class="outline-5">
<h5 id="h:f41d8bee-6865-441a-816e-6c43816c254a">4.5.3 ldap插件</h5>
<div class="outline-text-5" id="text-h:f41d8bee-6865-441a-816e-6c43816c254a">
<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1.&#23433;&#35013;openvpn-auth-ldap</span>
yum install openvpn-auth-ldap -y

<span style="color: #b22222;">#</span><span style="color: #b22222;">2.&#20462;&#25913;ldap.conf&#35748;&#35777;&#37197;&#32622;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36827;&#20837;openvpn&#26381;&#21153;&#22120;&#35748;&#35777;&#37197;&#32622;&#25991;&#20214;&#22841;</span>
<span style="color: #483d8b;">cd</span> /etc/openvpn/auth/
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22791;&#20221;&#40664;&#35748;&#37197;&#32622;&#25991;&#20214;</span>
cp ldap.conf  ldap.conf.bak
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24320;&#22987;&#20462;&#25913;&#37197;&#32622;&#65292;&#28165;&#31354;&#20869;&#23481;&#36827;&#34892;&#32534;&#36753;</span>
<span style="color: #483d8b;">echo</span> &gt; ldap.conf
cat &lt;&lt;\EOF &gt;/etc/openvpn/auth/ldap.conf
<span style="color: #ffa54f;">&lt;LDAP&gt;</span>
<span style="color: #ffa54f;"> URL ldap://10.16.202.178:389</span>
<span style="color: #ffa54f;"> BindDN "cn=admin,dc=ienglsh,dc=cn"</span>
<span style="color: #ffa54f;"> Password  Ta9FIjsrlMXcWo</span>
<span style="color: #ffa54f;"> Timeout 15</span>
<span style="color: #ffa54f;"> TLSEnable no</span>
<span style="color: #ffa54f;"> FollowReferrals no</span>
<span style="color: #ffa54f;">&lt;/LDAP&gt;</span>
<span style="color: #ffa54f;">&lt;LDAP&gt;</span>
<span style="color: #ffa54f;">    # AD&#26381;&#21153;&#22120;&#22320;&#22336;</span>
<span style="color: #ffa54f;">    URL        ldap://192.168.xxx.xxx:389</span>
<span style="color: #ffa54f;">    # &#31649;&#29702;&#21592;DN</span>
<span style="color: #ffa54f;">    BindDN  CN=Administrator,CN=Users,DC=XXX,DC=com</span>
<span style="color: #ffa54f;">    # &#31649;&#29702;&#21592;&#23494;&#30721;</span>
<span style="color: #ffa54f;">    Password    Y%G@$%^F^#UGH</span>
<span style="color: #ffa54f;">    # &#36229;&#26102;&#26102;&#38388;</span>
<span style="color: #ffa54f;">    Timeout        15</span>
<span style="color: #ffa54f;">    # &#26159;&#21542;&#20801;&#35768;&#21551;&#29992;TLS</span>
<span style="color: #ffa54f;">    TLSEnable    no</span>
<span style="color: #ffa54f;">    # &#26159;&#21542;&#20801;&#35768;&#21311;&#21517;</span>
<span style="color: #ffa54f;">    FollowReferrals no</span>

<span style="color: #ffa54f;">    ##&#24320;&#21551;TLS</span>
<span style="color: #ffa54f;">    #TLSEnable    yes</span>
<span style="color: #ffa54f;">    ## TLS CA&#35777;&#20070;&#25991;&#20214;</span>
<span style="color: #ffa54f;">    #TLSCACertFile    /usr/local/etc/ssl/ca.pem</span>
<span style="color: #ffa54f;">    ## TLS CA&#35777;&#20070;&#30446;&#24405;</span>
<span style="color: #ffa54f;">    #TLSCACertDir    /etc/ssl/certs</span>
<span style="color: #ffa54f;">    ## &#23458;&#25143;&#35777;&#20070;&#21644;&#23494;&#38053;</span>
<span style="color: #ffa54f;">    ## &#22914;&#26524;&#38656;&#35201;TLS&#23458;&#25143;&#31471;&#36523;&#20221;&#39564;&#35777;</span>
<span style="color: #ffa54f;">    #TLSCertFile    /usr/local/etc/ssl/client-cert.pem</span>
<span style="color: #ffa54f;">    #TLSKeyFile    /usr/local/etc/ssl/client-key.pem</span>
<span style="color: #ffa54f;">    ## &#23494;&#30721;&#22871;&#20214;&#65292;&#40664;&#35748;&#23601;&#22909;</span>
<span style="color: #ffa54f;">    ## TLSCipherSuite    ALL:!ADH:@STRENGTH</span>
<span style="color: #ffa54f;">&lt;/LDAP&gt;</span>

<span style="color: #ffa54f;">&lt;Authorization&gt;</span>
<span style="color: #ffa54f;">    # &#22522;&#30784;DN</span>
<span style="color: #ffa54f;">    BaseDN        "OU=xxxx,DC=going-link,DC=com"</span>
<span style="color: #ffa54f;">    # &#29992;&#25143;&#25628;&#32034;&#36807;&#28388;&#26465;&#20214; &#25105;&#20204;&#29992;uid&#24182;&#19988;&#26377;vpn&#23646;&#24615;&#20316;&#20026;AD&#29992;&#25143;&#30331;&#24405;&#21517;</span>
<span style="color: #ffa54f;">    SearchFilter "(&amp;(uid=%u)(ou=vpn)"</span>
<span style="color: #ffa54f;">    # &#38656;&#35201;&#32452;&#25104;&#21592;&#36523;&#20221;</span>
<span style="color: #ffa54f;">    RequireGroup    false</span>
<span style="color: #ffa54f;">    # &#23558;&#38750;&#32452;&#25104;&#21592;&#28155;&#21152;&#21040;PF&#34920;&#65288;&#31105;&#29992;&#65289;</span>
<span style="color: #ffa54f;">    ##PFTable    ips_***_users</span>
<span style="color: #ffa54f;">    #&lt;Group&gt;</span>
<span style="color: #ffa54f;">    #    BaseDN        "ou=Groups,dc=example,dc=com"</span>
<span style="color: #ffa54f;">    #    SearchFilter    "(|(cn=ops)(cn=artists))"</span>
<span style="color: #ffa54f;">    #    MemberAttribute    uniqueMember</span>
<span style="color: #ffa54f;">    ##   Add group members to a PF table (disabled)</span>
<span style="color: #ffa54f;">    ##   PFTable    ips_***_eng</span>
<span style="color: #ffa54f;">    #&lt;/Group&gt;</span>
<span style="color: #ffa54f;">&lt;/Authorization&gt;</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">3.&#37197;&#32622;openvpn&#30340;server.conf</span>
cat &gt;&gt;/etc/openvpn/server.conf&lt;&lt;EOF
<span style="color: #ffa54f;">plugin /usr/lib64/openvpn/plugin/lib/openvpn-auth-ldap.so "/etc/openvpn/auth/ldap.conf cn=%u"</span>
<span style="color: #ffa54f;">client-cert-not-required             #&#19981;&#20351;&#29992;&#23458;&#25143;&#31471;&#35777;&#20070;&#65292;&#20351;&#29992;&#23494;&#30721;&#23545;</span>
<span style="color: #ffa54f;">username-as-common-name              #&#20351;&#29992;&#35748;&#35777;&#29992;&#25143;&#21517;&#65292;&#19981;&#20351;&#29992;&#35777;&#20070;&#30340;common name</span>
<span style="color: #ffa54f;">EOF</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;service.conf&#26368;&#21518;&#19968;&#34892;&#28155;&#21152;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">4.&#23458;&#25143;&#31471;&#37197;&#32622;&#25991;&#20214;client.ovpn</span>
client
dev tun
proto tcp
remote 192.168.0.11 1194
resolv-retry infinite
nobind
persist-key
persist-tun
ca ca.crt
;cert cyh.crt      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#37322;</span>
;key cyh.key       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#37322;</span>
tls-auth ta.key 1
cipher AES-256-CBC
comp-lzo
verb 3
auth-user-pass              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#29992;&#25143;&#21517;&#23494;&#30721;&#30331;&#24405;openvpn&#26381;&#21153;&#22120;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#35201;&#26159;&#27880;&#37322;crt&#21644;key&#36335;&#24452;&#65292;&#20197;&#21450;&#28155;&#21152;&#19968;&#34892;auth-user-pass</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">5.&#37325;&#21551;openvpn</span>
systemctl restart openvpn@server

<span style="color: #b22222;">#</span><span style="color: #b22222;">6.&#30331;&#24405;&#39564;&#35777;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;&#36830;&#25509;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013; openldap-clients</span>
yum install -y openldap-clients
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25628;&#32034;&#23454;&#39564; &#24182;&#36755;&#20837;&#23494;&#30721;</span>
ldapsearch -x -W -D <span style="color: #8b2252;">"CN=Administrator,CN=Users,DC=GOING-LINK,DC=com"</span> -b <span style="color: #8b2252;">"DC=GOING-LINK,DC=com"</span> -h 192.168.1.62 -s one dn -LLL
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20837;&#23494;&#30721;&#65292;&#33021;&#30475;&#21040;&#22495;&#20869;&#19968;&#20123;OU&#32452;&#32455;&#21017;&#25104;&#21151;</span>
ldapsearch -x -W -D <span style="color: #8b2252;">"CN=Administrator,CN=Users,DC=GOING-LINK,DC=com"</span> -b <span style="color: #8b2252;">"DC=going-link,DC=com"</span> -h 192.168.1.62 
ldapsearch -x -W -D <span style="color: #8b2252;">"CN=Administrator,CN=Users,DC=GOING-LINK,DC=com"</span> -b <span style="color: #8b2252;">"OU=disabled,DC=going-link,DC=com"</span> -h 192.168.1.62
</pre>
</div>
</div>
</div>
<div id="outline-container-h:18f951c9-afd9-4349-b35c-c4e12566632e" class="outline-5">
<h5 id="h:18f951c9-afd9-4349-b35c-c4e12566632e">4.5.4 GoogleAuthenticator认证插件</h5>
<div class="outline-text-5" id="text-h:18f951c9-afd9-4349-b35c-c4e12566632e">
<p>
范例：LDAP+GoogleAuthenticator认证
</p>

<p>
插件下载地址： <a href="https://github.com/threerings/openvpn-auth-ldap">https://github.com/threerings/openvpn-auth-ldap</a>
<a href="https://github.com/evgeny-gridasov/openvpn-otp">https://github.com/evgeny-gridasov/openvpn-otp</a>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1.&#23433;&#35013;LDAP+GoogleAuthenticator</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;LDAP&#25554;&#20214;</span>
git clone https://github.com/threerings/openvpn-auth-ldap
<span style="color: #483d8b;">cd</span> openvpn-auth-ldap
yum install re2c libtool openldap openldap-devel openvpn-devel gcc-objc -y <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#20381;&#36182;</span>
./regen.sh 
./configure --with-openldap=/usr/ --with-openvpn=/usr/ <span style="color: #a0522d;">CFLAGS</span>=<span style="color: #8b2252;">"-fPIC"</span> <span style="color: #a0522d;">OBJCFLAGS</span>=<span style="color: #8b2252;">"-std=gnu11"</span>
make 
make install

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;OTP&#25554;&#20214;</span>
git clone https://github.com/evgeny-gridasov/openvpn-otp
<span style="color: #483d8b;">cd</span> openvpn-otp
yum install autoconf automake libtool* -y
./autogen.sh
./configure 
make
make install

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25554;&#20214;&#20301;&#32622;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">/usr/local/lib/openvpn-auth-ldap.so</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">/usr/local/lib/openvpn/openvpn-otp.so</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">2.&#20462;&#25913;ldap.conf&#35748;&#35777;&#37197;&#32622;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36827;&#20837;openvpn&#26381;&#21153;&#22120;&#35748;&#35777;&#37197;&#32622;&#25991;&#20214;&#22841;</span>
<span style="color: #483d8b;">cd</span> /etc/openvpn/auth/
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22791;&#20221;&#40664;&#35748;&#37197;&#32622;&#25991;&#20214;</span>
cp ldap.conf  ldap.conf.bak
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24320;&#22987;&#20462;&#25913;&#37197;&#32622;&#65292;&#28165;&#31354;&#20869;&#23481;&#36827;&#34892;&#32534;&#36753;</span>
<span style="color: #483d8b;">echo</span> &gt; ldap.conf
cat &lt;&lt;\EOF &gt;/etc/openvpn/auth/ldap.conf
<span style="color: #ffa54f;">&lt;LDAP&gt;</span>
<span style="color: #ffa54f;"> URL ldap://10.16.202.178:389</span>
<span style="color: #ffa54f;"> BindDN "cn=admin,dc=ienglish,dc=cn"</span>
<span style="color: #ffa54f;"> Password  Ta9FIjsrlMXcWo</span>
<span style="color: #ffa54f;"> Timeout 15</span>
<span style="color: #ffa54f;"> TLSEnable no</span>
<span style="color: #ffa54f;"> FollowReferrals no</span>
<span style="color: #ffa54f;">&lt;/LDAP&gt;</span>
<span style="color: #ffa54f;">&lt;LDAP&gt;</span>
<span style="color: #ffa54f;">    URL        ldap://192.168.xxx.xxx:389</span>
<span style="color: #ffa54f;">    BindDN  CN=Administrator,CN=Users,DC=XXX,DC=com</span>
<span style="color: #ffa54f;">    Password    Y%G@$%^F^#UGH</span>
<span style="color: #ffa54f;">    Timeout        15</span>
<span style="color: #ffa54f;">    TLSEnable    no</span>
<span style="color: #ffa54f;">    FollowReferrals no</span>
<span style="color: #ffa54f;">&lt;/LDAP&gt;</span>

<span style="color: #ffa54f;">&lt;Authorization&gt;</span>
<span style="color: #ffa54f;">    BaseDN        "OU=xxxx,DC=going-link,DC=com"</span>
<span style="color: #ffa54f;">    SearchFilter "(&amp;(uid=%u)(ou=vpn)"</span>
<span style="color: #ffa54f;">    RequireGroup    false</span>

<span style="color: #ffa54f;">    PasswordIsCR   true  </span>

<span style="color: #ffa54f;">    #&lt;Group&gt;</span>
<span style="color: #ffa54f;">    #    BaseDN        "ou=Groups,dc=example,dc=com"</span>
<span style="color: #ffa54f;">    #    SearchFilter    "(|(cn=ops)(cn=artists))"</span>
<span style="color: #ffa54f;">    #    MemberAttribute    uniqueMember</span>
<span style="color: #ffa54f;">    #&lt;/Group&gt;</span>
<span style="color: #ffa54f;">&lt;/Authorization&gt;</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">3.&#37197;&#32622;openvpn&#30340;server.conf</span>
cat &gt;&gt;/etc/openvpn/server.conf&lt;&lt;EOF
<span style="color: #ffa54f;">plugin /usr/local/lib/openvpn-auth-ldap.so  "/etc/openvpn/auth/ldap.conf cn=%u"</span>
<span style="color: #ffa54f;">plugin /usr/local/lib/openvpn/openvpn-otp.so "password_is_cr=1 otp_secrets=/etc/openvpn/auth/otp-secrets"</span>
<span style="color: #ffa54f;">client-cert-not-required             #&#19981;&#20351;&#29992;&#23458;&#25143;&#31471;&#35777;&#20070;&#65292;&#20351;&#29992;&#23494;&#30721;&#23545;</span>
<span style="color: #ffa54f;">username-as-common-name              #&#20351;&#29992;&#35748;&#35777;&#29992;&#25143;&#21517;&#65292;&#19981;&#20351;&#29992;&#35777;&#20070;&#30340;common name</span>
<span style="color: #ffa54f;">#&#35843;&#29992;&#39564;&#35777;&#33050;&#26412;&#65292;&#29983;&#25104;OTP&#20849;&#20139;&#23494;&#38053;</span>
<span style="color: #ffa54f;">script-security 2</span>
<span style="color: #ffa54f;">auth-user-pass-verify /etc/openvpn/scripts/check_cn_on_connect.sh via-env</span>
<span style="color: #ffa54f;">#&#26381;&#21153;&#22120;&#31471;&#20250;&#23450;&#26399;&#26816;&#26597;&#35748;&#35777;&#24773;&#20917;&#65292;&#40664;&#35748;3600&#31186;&#19968;&#23567;&#26102;&#65292;&#20351;&#29992;OTP&#30340;&#35805;&#23613;&#37327;&#26102;&#38388;&#38271;&#19968;&#20123;&#65292;&#21542;&#21017;&#23458;&#25143;&#31471;&#38656;&#35201;&#37325;&#26032;&#36755;&#20837;&#29992;&#25143;&#21517;&#23494;&#30721;&#21644;OTP&#19968;&#27425;&#24615;&#23494;&#30721;&#12290;</span>
<span style="color: #ffa54f;">reneg-sec 0</span>
<span style="color: #ffa54f;">EOF</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;service.conf&#26368;&#21518;&#19968;&#34892;&#28155;&#21152;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">4.&#37197;&#32622;OTP&#30456;&#20851;&#20869;&#23481;/etc/openvpn/auth/otp-secrets</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26684;&#24335;&#65306;bob otp totp:sha1:base32:LJYHR64TUI7IL3RD::xxx *</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20013;&#38388;&#37027;&#20018;LJYHR64TUI7IL3RD&#23601;&#26159;&#23494;&#38053;&#65292;&#29087;&#24713;GoogleAuthenticator&#21407;&#29702;&#30340;&#65292;&#21487;&#20197;&#30452;&#25509;&#29983;&#25104;&#19987;&#29992;&#23383;&#31526;&#20018;&#21644;&#20108;&#32500;&#30721;&#12290;&#29992;&#25163;&#26426;&#31471;&#25195;&#19968;&#19979;&#23601;&#21487;&#20197;&#29992;&#20102;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">4.&#23458;&#25143;&#31471;&#37197;&#32622;&#25991;&#20214;client.ovpn</span>
client
dev tun
proto tcp
remote 192.168.0.11 1194
resolv-retry infinite
nobind
persist-key
persist-tun
ca ca.crt
;cert cyh.crt      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#37322;</span>
;key cyh.key       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#37322;</span>
tls-auth ta.key 1
cipher AES-256-CBC
comp-lzo
verb 3
auth-user-pass              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#29992;&#25143;&#21517;&#23494;&#30721;&#30331;&#24405;openvpn&#26381;&#21153;&#22120;</span>
auth-nocache
static-challenge <span style="color: #8b2252;">"Enter Google Authenticator Token"</span> 1
<span style="color: #b22222;">#</span><span style="color: #b22222;">@&#24377;&#20986;&#39564;&#35777;&#26694;&#65292;1&#34920;&#31034;&#26126;&#25991;&#26174;&#31034;&#65292;0&#34920;&#31034;&#23494;&#25991;&#26174;&#31034;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">5.&#37325;&#21551;openvpn</span>
systemctl restart openvpn@server
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:f865de00-3365-4a90-9f5f-b5bda45f98da" class="outline-3">
<h3 id="h:f865de00-3365-4a90-9f5f-b5bda45f98da">5 扩展知识</h3>
<div class="outline-text-3" id="text-h:f865de00-3365-4a90-9f5f-b5bda45f98da">
</div>
<div id="outline-container-h:969a8d5e-80d0-44d8-b754-74801e0d4827" class="outline-4">
<h4 id="h:969a8d5e-80d0-44d8-b754-74801e0d4827">5.1 OpenVPN Access Server</h4>
<div class="outline-text-4" id="text-h:969a8d5e-80d0-44d8-b754-74801e0d4827">
<p>
VPN Access Server 归属于 OpenVPN Solution，是官方推荐的VPN服务，它介于
可收费与免费之间。
</p>

<p>
其实这个就是把Openvpn Community开源版做成了更方便，更稳定，优化过了的
商业版。商业版有后台有基于Web的管理面板，也没有各种复杂和编译，而且只
提供2个免费测试的USER，如果需要更多则需要购买许可证5美元/用户。适合个
人自用，不适合多人用。
</p>

<p>
参考文档:
<a href="https://openvpn.net/vpn-server-resources/finishing-configuration-of-access-server/">https://openvpn.net/vpn-server-resources/finishing-configuration-of-access-server/</a>
</p>

<p>
<b>安装 OpenVpn Access Server</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;:CentOS8 &#19981;&#25903;&#25345;&#19979;&#38754;&#21253;</span>
[root@centos7 ~]#ll openvpn-as-*
-rw-r--r-- 1 root root     32742864 Apr 28 20:04 openvpn-as-2.8.3_f28d2eae-
CentOS7.x86_64.rpm
-rw-r--r-- 1 root root 130562200 Apr 28 20:03 openvpn-as-bundled-clients-8.rpm
[root@centos7 ~]#yum -y install openvpn-as-2.8.3_f28d2eae-CentOS7.x86_64.rpm
openvpn-as-bundled-clients-8.rpm
To reconfigure manually, use the /usr/local/openvpn_as/bin/ovpn-init tool.
+++++++++++++++++++++++++++++++++++++++++++++++
Access Server 2.8.3 has been successfully installed<span style="color: #a020f0;"> in</span> /usr/local/openvpn_as
Configuration log file has been written to /usr/local/openvpn_as/init.log
Access Server Web UIs are available here:
Admin UI: https://10.0.0.17:943/admin
Client UI: https://10.0.0.17:943/
+++++++++++++++++++++++++++++++++++++++++++++++
Verifying : openvpn-as-2.8.3_f28d2eae-CentOS7.x86_64                                             
                                                                        1/4
Verifying : MySQL-python-1.2.5-1.el7.x86_64                                                                 
                                                                        2/4
Verifying : openvpn-as-bundled-clients-8-1.noarch                                                     
                                                                        3/4
Verifying : cyrus-sasl-2.1.26-23.el7.x86_64                                                                 
                                                                        4/4
Installed:
openvpn-as.x86_64 0:2.8.3_f28d2eae-CentOS7                                     openvpn-as-
bundled-clients.noarch 0:8-1                                 
Dependency Installed:
MySQL-python.x86_64 0:1.2.5-1.el7                                                 cyrus-sasl.x86_64
0:2.1.26-23.el7                                             
Complete!
[root@centos7 ~]#getent passwd openvpn
openvpn:x:1002:1002::/home/openvpn:/sbin/nologin
[root@centos7 ~]#passwd openvpn
Changing password for user openvpn.
New password:
BAD PASSWORD: The password is shorter than 8 characters
Retype new password:
passwd: all authentication tokens updated successfully.
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#21253;&#21518;openvpnas.service &#33258;&#21160;&#21551;&#21160;</span>
[root@centos7 ~]#systemctl status openvpnas.service


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25171;&#24320;&#30340;&#30456;&#20851;&#31471;&#21475;</span>
[root@centos7 ~]#ss -ntlp
State         Recv-Q Send-Q                         Local Address:Port             Peer Address:Port

LISTEN         0             50 127.0.0.1:909                     *:*                                     users:
((<span style="color: #8b2252;">"python2"</span>,<span style="color: #a0522d;">pid</span>=1427,<span style="color: #a0522d;">fd</span>=15))
LISTEN         0             50                 *:943                     *:*                                     users:
((<span style="color: #8b2252;">"python2"</span>,<span style="color: #a0522d;">pid</span>=1427,<span style="color: #a0522d;">fd</span>=8))
LISTEN         0             128             *:22                     *:*                                     users:
((<span style="color: #8b2252;">"sshd"</span>,<span style="color: #a0522d;">pid</span>=827,<span style="color: #a0522d;">fd</span>=3))
LISTEN         0             100127.0.0.1:25                     *:*                                     users:
((<span style="color: #8b2252;">"master"</span>,<span style="color: #a0522d;">pid</span>=962,<span style="color: #a0522d;">fd</span>=13))
LISTEN         0             1                 *:443                     *:*                                     users:
((<span style="color: #8b2252;">"openvpn-openssl"</span>,<span style="color: #a0522d;">pid</span>=1481,<span style="color: #a0522d;">fd</span>=5))
LISTEN         0             50 127.0.0.1:904                     *:*                                     users:
((<span style="color: #8b2252;">"python2"</span>,<span style="color: #a0522d;">pid</span>=1427,<span style="color: #a0522d;">fd</span>=10))
LISTEN         0             50 127.0.0.1:905                     *:*                                     users:
((<span style="color: #8b2252;">"python2"</span>,<span style="color: #a0522d;">pid</span>=1427,<span style="color: #a0522d;">fd</span>=11))
LISTEN         0             50 127.0.0.1:906                     *:*                                     users:
((<span style="color: #8b2252;">"python2"</span>,<span style="color: #a0522d;">pid</span>=1427,<span style="color: #a0522d;">fd</span>=12))
LISTEN         0             50 127.0.0.1:907                     *:*                                     users:
((<span style="color: #8b2252;">"python2"</span>,<span style="color: #a0522d;">pid</span>=1427,<span style="color: #a0522d;">fd</span>=13))
LISTEN         0             50 127.0.0.1:908                     *:*                                     users:
((<span style="color: #8b2252;">"python2"</span>,<span style="color: #a0522d;">pid</span>=1427,<span style="color: #a0522d;">fd</span>=14))
LISTEN         0             128         [::]:22                 [::]:*                                     users:
((<span style="color: #8b2252;">"sshd"</span>,<span style="color: #a0522d;">pid</span>=827,<span style="color: #a0522d;">fd</span>=4))
LISTEN         0             100     [::1]:25                 [::]:*                                     users:
((<span style="color: #8b2252;">"master"</span>,<span style="color: #a0522d;">pid</span>=962,<span style="color: #a0522d;">fd</span>=14))
</pre>
</div>

<p>
<b>登录服务器Admin UI 进行管理</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">https://openvpn-server:943/admin
</pre>
</div>


<figure id="org0528a43">
<img src="images/image-20210219201723411.png" alt="image-20210219201723411.png">

</figure>

<p>
输入用户openvpn和上面设置的密码可以登录
</p>


<figure id="org2c381a4">
<img src="images/image-20210219201738918.png" alt="image-20210219201738918.png">

</figure>


<figure id="org44be0e7">
<img src="images/image-20210219201749155.png" alt="image-20210219201749155.png">

</figure>

<p>
登录成功
</p>


<figure id="org1ed5709">
<img src="images/image-20210219201807578.png" alt="image-20210219201807578.png">

</figure>

<p>
<b>从 Client UI登录客户端连接地址下载相关文件</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">https://openvpn-server:943/
</pre>
</div>


<figure id="orga4aedd4">
<img src="images/image-20210219201818159.png" alt="image-20210219201818159.png">

</figure>

<p>
选择下载相应的软件版本安装
</p>


<figure id="org737a27e">
<img src="images/image-20210219201832325.png" alt="image-20210219201832325.png">

</figure>

<p>
下载软件完成
</p>


<figure id="orgbac521d">
<img src="images/image-20210219201857661.png" alt="image-20210219201857661.png">

</figure>

<p>
<b>安装客户端软件</b>
</p>

<p>
安装完成
</p>


<figure id="orgf87dad0">
<img src="images/image-20210219201913762.png" alt="image-20210219201913762.png">

</figure>

<p>
<b>5.1.5 运行软件并登录</b>
</p>


<figure id="orgf8d8d10">
<img src="images/image-20210219201925538.png" alt="image-20210219201925538.png">

</figure>


<figure id="org069bbd5">
<img src="images/image-20210219201934054.png" alt="image-20210219201934054.png">

</figure>


<figure id="org7537818">
<img src="images/image-20210219201944919.png" alt="image-20210219201944919.png">

</figure>


<figure id="org4841fb9">
<img src="images/image-20210219201952400.png" alt="image-20210219201952400.png">

</figure>


<figure id="org1475368">
<img src="images/image-20210219202000174.png" alt="image-20210219202000174.png">

</figure>


<figure id="orgddbcdb1">
<img src="images/image-20210219202009792.png" alt="image-20210219202009792.png">

</figure>


<figure id="org2731059">
<img src="images/image-20210219202025166.png" alt="image-20210219202025166.png">

</figure>


<figure id="orgf1dd060">
<img src="images/image-20210219202033990.png" alt="image-20210219202033990.png">

</figure>


<figure id="org6282f1a">
<img src="images/image-20210219202042452.png" alt="image-20210219202042452.png">

</figure>

<p>
<b>验证登录</b>
</p>

<p>
客户端查看登录
</p>


<figure id="orgded612d">
<img src="images/image-20210219202056522.png" alt="image-20210219202056522.png">

<figcaption><span class="figure-number">Figure 5: </span>image-20210219202056522</figcaption>
</figure>

<p>
服务器查看日志
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#tail /var/log/openvpnas.log -f
</pre>
</div>
</div>
</div>
<div id="outline-container-h:812bbaaa-4a70-440a-b89e-cd04356eba83" class="outline-4">
<h4 id="h:812bbaaa-4a70-440a-b89e-cd04356eba83">5.2 docker 运行OpenVPN Access Server</h4>
<div class="outline-text-4" id="text-h:812bbaaa-4a70-440a-b89e-cd04356eba83">
<p>
参考链接 <a href="https://hub.docker.com/r/linuxserver/openvpn-as">https://hub.docker.com/r/linuxserver/openvpn-as</a>
</p>
</div>
</div>
<div id="outline-container-h:a82b986c-3cb8-4ecb-aa57-e9d317900e40" class="outline-4">
<h4 id="h:a82b986c-3cb8-4ecb-aa57-e9d317900e40">5.3 一键安装</h4>
<div class="outline-text-4" id="text-h:a82b986c-3cb8-4ecb-aa57-e9d317900e40">
<p>
安装openvpn和ldap认证
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1.&#23433;&#35013;openvpn&#21644;ldap&#35748;&#35777;</span>
curl -O https://raw.githubusercontent.com/angristan/openvpn-install/master/openvpn-install.sh
chmod +x openvpn-install.sh
<span style="color: #a0522d;">AUTO_INSTALL</span>=y ./openvpn-install.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#36807;&#31243;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#23450;&#26381;&#21153;&#22120; IP &#21518;&#25353; Enter</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992; IPv6 ? &#22635; n (&#21542;) &#21518;&#25353; Enter</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">OpenVPN port &#65292;&#36873; 1) default 1194 &#21518;&#25353; Enter</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20256;&#36755;&#21327;&#23450;&#31867; UDP / TCP&#65292;&#36873; 1 UDP &#21518;&#25353; Enter</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36873; DNS &#26381;&#21153;&#22120;&#65292;&#19968;&#33324;&#37117;&#20250;&#36873; 3.CloudFalre &#25110;&#32773;9. Google&#65292;&#36873;&#23436;&#21518;&#25353; Enter</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#32447;&#25968;&#25454;&#21387;&#32553;&#65292;&#19981;&#24314;&#35758;&#20351;&#29992;&#65292;&#22635; n &#21518;&#25353; Enter</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#23450;&#21152;&#23494;&#26041;&#24335;&#65292;&#22914;&#26524;&#19981;&#26159;&#39640;&#25163;&#65292;&#23601;&#22635; n &#21518;&#25353; Enter&#65292;&#39640;&#25163;&#30340;&#35805;&#21487;&#20197;&#33258;&#24049;&#36873; AES &#21152;&#23494;&#38271;&#24230;&#21450;&#26041;&#24335;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">Press any key to countinue &#8230; &#25353; Enter&#21518;&#24320;&#22987;&#23433;&#35013;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36816;&#34892;&#23436;&#25104;&#21518;&#20250;&#35201;&#27714;&#20320;&#21152;&#20837;&#31532;&#19968;&#20010;&#29992;&#25143; ( Client name: )&#65292;&#21482;&#21487;&#20197;&#22635;&#33521;&#25991;&#23383;&#20018;&#65292;&#22914; edwardclient&#22635;&#23436;&#21518;&#25353; Enter</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#29992;&#23494;&#30721;&#21152;&#23494;&#37329;&#38053; ? &#19968;&#33324;&#25105;&#20250;&#36873; 2 &#65292;&#33258;&#24049;&#36755;&#20837;&#23494;&#30721;&#65292;&#22635;&#23436;&#25972;&#20010;&#23433;&#35013;&#36807;&#31243;&#23601;&#23436;&#25104;&#20102;&#12290;</span>

yum install openvpn-auth-ldap -y

<span style="color: #b22222;">#</span><span style="color: #b22222;">2.&#37197;&#32622;ldap&#21644;openvpn&#26381;&#21153;&#31471;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;ldap</span>
<span style="color: #483d8b;">cd</span> /etc/openvpn/auth/
cp ldap.conf ldap.conf.old
cat &lt;&lt;\EOF &gt; /etc/openvpn/auth/ldap.conf
<span style="color: #ffa54f;">&lt;LDAP&gt;</span>
<span style="color: #ffa54f;"> URL ldap://10.16.202.178:389</span>
<span style="color: #ffa54f;"> BindDN "cn=admin,dc=ienglish,dc=cn"</span>
<span style="color: #ffa54f;"> Password  Ta9FIjsrlMXcWo</span>
<span style="color: #ffa54f;"> Timeout 15</span>
<span style="color: #ffa54f;"> TLSEnable no</span>
<span style="color: #ffa54f;"> FollowReferrals no</span>
<span style="color: #ffa54f;">&lt;/LDAP&gt;</span>


<span style="color: #ffa54f;">&lt;Authorization&gt;</span>
<span style="color: #ffa54f;">  BaseDN "ou=user,dc=iXX,dc=cn"</span>
<span style="color: #ffa54f;">  SearchFilter "(&amp;(uid=%u)(ou=vpn))"</span>
<span style="color: #ffa54f;">  RequireGroup false </span>
<span style="color: #ffa54f;">#  RequireGroup true </span>
<span style="color: #ffa54f;">#  &lt;Group&gt;</span>
<span style="color: #ffa54f;">#    BaseDN "ou=group,dc=iXX,dc=cn"</span>
<span style="color: #ffa54f;">#    SearchFilter    "cn=ops"</span>
<span style="color: #ffa54f;">#    MemberAttribute member</span>
<span style="color: #ffa54f;">#  &lt;/Group&gt;</span>
<span style="color: #ffa54f;">&lt;/Authorization&gt;</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;openvpn&#26381;&#21153;&#31471;</span>
cat &lt;&lt;\EOF&gt; /etc/openvpn/server.conf 
<span style="color: #ffa54f;">port 1194</span>
<span style="color: #ffa54f;">proto tcp</span>
<span style="color: #ffa54f;">dev tun</span>
<span style="color: #ffa54f;">user nobody</span>
<span style="color: #ffa54f;">group nobody</span>
<span style="color: #ffa54f;">keepalive 10 120</span>
<span style="color: #ffa54f;">topology subnet</span>
<span style="color: #ffa54f;">server 10.251.254.0 255.255.255.0</span>
<span style="color: #ffa54f;">push "dhcp-option DNS 114.114.114.114"</span>
<span style="color: #ffa54f;">push "dhcp-option DNS 223.5.5.5"</span>
<span style="color: #ffa54f;">#push "redirect-gateway def1 bypass-dhcp"   #&#21551;&#29992;&#21518;&#65292;&#23458;&#25143;&#31471;&#25152;&#26377;&#27969;&#37327;&#37117;&#23558;&#36890;&#36807;VPN&#26381;&#21153;&#22120;</span>
<span style="color: #ffa54f;">push "route 10.64.0.0 255.255.0.0"          #&#32473;&#23458;&#25143;&#31471;&#29983;&#25104;&#30340;&#21040;&#36798;&#26381;&#21153;&#22120;&#21518;&#38754;&#32593;&#27573;&#30340;&#38745;&#24577;&#36335;&#30001;&#65292;&#19979;&#19968;&#36339;&#20026;openvpn&#26381;&#21153;&#22120;&#30340;10.251.254.1</span>
<span style="color: #ffa54f;">push "route 172.28.0.0 255.255.0.0"</span>
<span style="color: #ffa54f;">push "route 172.17.0.0 255.255.0.0"</span>
<span style="color: #ffa54f;">push "route 10.16.0.0 255.255.0.0"</span>
<span style="color: #ffa54f;">push "route 10.0.0.0 255.255.0.0"</span>
<span style="color: #ffa54f;">dh none</span>
<span style="color: #ffa54f;">ecdh-curve prime256v1</span>
<span style="color: #ffa54f;">tls-crypt tls-crypt.key 0</span>
<span style="color: #ffa54f;">crl-verify crl.pem</span>
<span style="color: #ffa54f;">ca ca.crt</span>
<span style="color: #ffa54f;">cert server_toHbMLW61cV2DLVL.crt</span>
<span style="color: #ffa54f;">key server_toHbMLW61cV2DLVL.key</span>
<span style="color: #ffa54f;">auth SHA256</span>
<span style="color: #ffa54f;">cipher AES-128-GCM</span>
<span style="color: #ffa54f;">ncp-ciphers AES-128-GCM</span>
<span style="color: #ffa54f;">tls-server</span>
<span style="color: #ffa54f;">tls-version-min 1.2</span>
<span style="color: #ffa54f;">tls-cipher TLS-ECDHE-ECDSA-WITH-AES-128-GCM-SHA256</span>
<span style="color: #ffa54f;">status /var/log/openvpn/status.log</span>
<span style="color: #ffa54f;">verb 3</span>
<span style="color: #ffa54f;">log-append  /var/log/openvpn.log</span>
<span style="color: #ffa54f;">log /var/log/openvpn.log</span>
<span style="color: #ffa54f;">plugin /usr/lib64/openvpn/plugin/lib/openvpn-auth-ldap.so "/etc/openvpn/auth/ldap.conf cn=%u"</span>
<span style="color: #ffa54f;">verify-client-cert</span>
<span style="color: #ffa54f;">#client-cert-not-required</span>
<span style="color: #ffa54f;">reneg-sec 0                # &#20851;&#38381;&#40664;&#35748;&#30340; 3600s &#23458;&#25143;&#31471;&#36830;&#25509;&#26029;&#24320;&#26102;&#38388;</span>
<span style="color: #ffa54f;">duplicate-cn               # &#20801;&#35768;&#22810;&#29992;&#25143;&#30331;&#24405;</span>
<span style="color: #ffa54f;">management 127.0.0.1 5555  #&#26412;&#22320;&#31649;&#29702;</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">3.&#21551;&#21160;&#26381;&#21153;</span>
systemctl restart openvpn@server

<span style="color: #b22222;">#</span><span style="color: #b22222;">4. &#23458;&#25143;&#31471;&#37197;&#32622;</span>
cat &lt;&lt; \EOF &gt;clientVPN.ovpn
<span style="color: #ffa54f;">client</span>
<span style="color: #ffa54f;">proto tcp</span>
<span style="color: #ffa54f;">remote ovpn.ops.ienglish.cn 1194</span>
<span style="color: #ffa54f;">dev tun</span>
<span style="color: #ffa54f;">resolv-retry infinite</span>
<span style="color: #ffa54f;">nobind</span>
<span style="color: #ffa54f;">persist-key</span>
<span style="color: #ffa54f;">persist-tun</span>
<span style="color: #ffa54f;">remote-cert-tls server</span>
<span style="color: #ffa54f;">verify-x509-name server_toHbMLW61cV2DLVL name</span>
<span style="color: #ffa54f;">auth SHA256</span>
<span style="color: #ffa54f;">auth-nocache</span>
<span style="color: #ffa54f;">cipher AES-128-GCM</span>
<span style="color: #ffa54f;">tls-client</span>
<span style="color: #ffa54f;">tls-version-min 1.2</span>
<span style="color: #ffa54f;">tls-cipher TLS-ECDHE-ECDSA-WITH-AES-128-GCM-SHA256</span>
<span style="color: #ffa54f;">verb 3</span>
<span style="color: #ffa54f;">reneg-sec 0</span>
<span style="color: #ffa54f;">auth-user-pass</span>
<span style="color: #ffa54f;">&lt;ca&gt;</span>
<span style="color: #ffa54f;">-----BEGIN CERTIFICATE-----</span>
<span style="color: #ffa54f;">MIIBwDCCAWegAwIBAgIJAIYfesO4nOfkMAoGCCqGSM49BAMCMB4xHDAaBgNVBAMM</span>
<span style="color: #ffa54f;">E2NuX3pna3ZxMjRPaEw3cnlNNVAwHhcNMjAwNDA5MDUxMDE0WhcNMzAwNDA3MDUx</span>
<span style="color: #ffa54f;">MDE0WjAeMRwwGgYDVQQDDBNjbl96Z2t2cTI0T2hMN3J5TTVQMFkwEwYHKoZIzj0C</span>
<span style="color: #ffa54f;">AQYIKoZIzj0DAQcDQgAEfwBtwu30mVlfohUIZieE5wweha06xhRENKZj4fubzXK0</span>
<span style="color: #ffa54f;">naowO/3RnDOQ65uprrLy4YgcqRoKjawDChkPkjKfBKOBjTCBijAdBgNVHQ4EFgQU</span>
<span style="color: #ffa54f;">FK7Drlw6CT95EJrEdOJWPok3r+IwTgYDVR0jBEcwRYAUFK7Drlw6CT95EJrEdOJW</span>
<span style="color: #ffa54f;">Pok3r+KhIqQgMB4xHDAaBgNVBAMME2NuX3pna3ZxMjRPaEw3cnlNNVCCCQCGH3rD</span>
<span style="color: #ffa54f;">uJzn5DAMBgNVHRMEBTADAQH/MAsGA1UdDwQEAwIBBjAKBggqhkjOPQQDAgNHADBE</span>
<span style="color: #ffa54f;">AiBBQSIdcKeRqTSZY1MN+gE9vv5+WquTh+7rQl3YcTrGNgIgNs5qOrZLEtzPNbIv</span>
<span style="color: #ffa54f;">Fp4Vmm4tBjxiUWLoo0RvSy9IEN8=</span>
<span style="color: #ffa54f;">-----END CERTIFICATE-----</span>
<span style="color: #ffa54f;">&lt;/ca&gt;</span>
<span style="color: #ffa54f;">&lt;cert&gt;</span>
<span style="color: #ffa54f;">-----BEGIN CERTIFICATE-----</span>
<span style="color: #ffa54f;">MIIBzTCCAXSgAwIBAgIRAIT/nyBpr3W0bCxec3ulPwYwCgYIKoZIzj0EAwIwHjEc</span>
<span style="color: #ffa54f;">MBoGA1UEAwwTY25femdrdnEyNE9oTDdyeU01UDAeFw0yMDA0MDkwNTEwMTVaFw0y</span>
<span style="color: #ffa54f;">MzAzMjUwNTEwMTVaMBExDzANBgNVBAMMBmNsaWVudDBZMBMGByqGSM49AgEGCCqG</span>
<span style="color: #ffa54f;">SM49AwEHA0IABI/r4PhlmQ1vxatAdnutCajU3LSj/xykVt1AK1H2Ngt0njqQnEE8</span>
<span style="color: #ffa54f;">V/Qt2b9hu9PmfAWOD/XZhib2HFUtS+tU3vGjgZ8wgZwwCQYDVR0TBAIwADAdBgNV</span>
<span style="color: #ffa54f;">HQ4EFgQUZxuE70ggpYIW/Ljshtt/H8UNZ9IwTgYDVR0jBEcwRYAUFK7Drlw6CT95</span>
<span style="color: #ffa54f;">EJrEdOJWPok3r+KhIqQgMB4xHDAaBgNVBAMME2NuX3pna3ZxMjRPaEw3cnlNNVCC</span>
<span style="color: #ffa54f;">CQCGH3rDuJzn5DATBgNVHSUEDDAKBggrBgEFBQcDAjALBgNVHQ8EBAMCB4AwCgYI</span>
<span style="color: #ffa54f;">KoZIzj0EAwIDRwAwRAIgV++5cHLwZDVif7xn3+x4kbuj5MP5T58Zl2c1gC5mZcMC</span>
<span style="color: #ffa54f;">IHQ5P4QwuN8hWhSn9jcHnSYCGgCBVP5UOuhBc/M6k18o</span>
<span style="color: #ffa54f;">-----END CERTIFICATE-----</span>
<span style="color: #ffa54f;">&lt;/cert&gt;</span>
<span style="color: #ffa54f;">&lt;key&gt;</span>
<span style="color: #ffa54f;">-----BEGIN PRIVATE KEY-----</span>
<span style="color: #ffa54f;">MIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQg8o7s/two90o8jSJt</span>
<span style="color: #ffa54f;">sKTxji0iCIN6wtPbRkdPLH3FgC+hRANCAASP6+D4ZZkNb8WrQHZ7rQmo1Ny0o/8c</span>
<span style="color: #ffa54f;">pFbdQCtR9jYLdJ46kJxBPFf0Ldm/YbvT5nwFjg/12YYm9hxVLUvrVN7x</span>
<span style="color: #ffa54f;">-----END PRIVATE KEY-----</span>
<span style="color: #ffa54f;">&lt;/key&gt;</span>
<span style="color: #ffa54f;">&lt;tls-crypt&gt;</span>
<span style="color: #ffa54f;">#</span>
<span style="color: #ffa54f;"># 2048 bit OpenVPN static key</span>
<span style="color: #ffa54f;">#</span>
<span style="color: #ffa54f;">-----BEGIN OpenVPN Static key V1-----</span>
<span style="color: #ffa54f;">fb00ed6e53ba1f408edfa674bab0e919</span>
<span style="color: #ffa54f;">2018051046e9e6c1e84af92200b81d81</span>
<span style="color: #ffa54f;">54f3a59ce9e8a4c5d4bca63b9272ceaa</span>
<span style="color: #ffa54f;">c256452e668384b918608bb553d2c37e</span>
<span style="color: #ffa54f;">575327ca3d4cab43ad28cd51ff31faa7</span>
<span style="color: #ffa54f;">476d205dd524002d3a26192f5cb1f428</span>
<span style="color: #ffa54f;">e8ba7e63ae775d1276ff8b0d36d0d385</span>
<span style="color: #ffa54f;">9c1e6ce97ffefceb5dd90187c380eb46</span>
<span style="color: #ffa54f;">3ff455a10cb4c4269a3bda593f065357</span>
<span style="color: #ffa54f;">20a8df152efc030aa39e134f753c8071</span>
<span style="color: #ffa54f;">ca40a332fd4d8a0e9c18b62ef39b7d08</span>
<span style="color: #ffa54f;">93815058eb7132131ac5a65ab7b1bbd3</span>
<span style="color: #ffa54f;">252b7cd7e705fb08e09388a157610632</span>
<span style="color: #ffa54f;">7e045f666ee707ffacd043b468b96523</span>
<span style="color: #ffa54f;">4eeb4a8bf3c9d1ca0e32b123e893431e</span>
<span style="color: #ffa54f;">3cd6d4df92a400eb8376078d8dd2b089</span>
<span style="color: #ffa54f;">-----END OpenVPN Static key V1-----</span>
<span style="color: #ffa54f;">&lt;/tls-crypt&gt;</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;</span>
ldapsearch   -x -D <span style="color: #8b2252;">"cn=admin,dc=iXX,dc=cn"</span>  -w Ta9FIjsrlMXcWo -b <span style="color: #8b2252;">"ou=user,dc=iXX,dc=cn"</span> <span style="color: #a0522d;">ou</span>=vpn |grep uid


iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE
iptables -A INPUT -i tun0 -j ACCEPT
iptables -A FORWARD -i eth0 -o tun0 -j ACCEPT
iptables -A FORWARD -i tun0 -o eth0 -j ACCEPT
iptables -A INPUT -i eth0 -p udp --dport 1194 -j ACCEPT
</pre>
</div>
</div>
</div>
<div id="outline-container-h:67967982-c846-4ae9-a1d8-67d1e4e63be6" class="outline-4">
<h4 id="h:67967982-c846-4ae9-a1d8-67d1e4e63be6">5.4 监控</h4>
<div class="outline-text-4" id="text-h:67967982-c846-4ae9-a1d8-67d1e4e63be6">
</div>
<div id="outline-container-h:87f35709-48be-423e-aaeb-44ae1bc646c2" class="outline-5">
<h5 id="h:87f35709-48be-423e-aaeb-44ae1bc646c2">openvpn-monitor</h5>
<div class="outline-text-5" id="text-h:87f35709-48be-423e-aaeb-44ae1bc646c2">
<p>
openvpn-monitor是一个简单的python程序，用于生成html，显示OpenVPN服务器的状态，包括所有当前连接。
</p>

<p>
Gitis当前可用的源代码：
</p>

<p>
<a href="https://github.com/furlongm/openvpn-monitor">https://github.com/furlongm/openvpn-monitor</a>
</p>

<p>
安装
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">1.&#23433;&#35013;&#30417;&#25511;&#24037;&#20855;</span>
yum install -y epel-release
virtualenv + pip + gunicorn
<span style="color: #b22222;"># </span><span style="color: #b22222;">apt-get install python-virtualenv geoip-database-extra geoipupdate      # (debian/ubuntu)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">yum install python-virtualenv GeoIP-update geolite2-city python2-geoip2 # (centos/rhel)</span>
mkdir /data/openvpn-monitor
<span style="color: #483d8b;">cd</span> /data/openvpn-monitor
virtualenv .
<span style="color: #483d8b;">.</span> bin/activate
pip install --upgrade pip
pip install openvpn-monitor gunicorn
gunicorn openvpn-monitor -b 0.0.0.0:80


<span style="color: #b22222;"># </span><span style="color: #b22222;">cat /data/openvpn-monitor/openvpn-monitor.conf </span>
[openvpn-monitor]
<span style="color: #a0522d;">site</span>=Top_Learning
<span style="color: #b22222;">#</span><span style="color: #b22222;">logo=logo.jpg</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">latitude=40.72</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">longitude=-74</span>
<span style="color: #a0522d;">maps</span>=False
<span style="color: #b22222;">#</span><span style="color: #b22222;">geoip_data=/var/lib/GeoIP/GeoLite2-City.mmdb</span>
<span style="color: #a0522d;">geoip_data</span>=/data/openvpn-monitor/GeoIP/GeoLite2-City.mmdb
<span style="color: #a0522d;">datetime_format</span>=%d/%m/%Y %H:%M:%S

[VPN1]
<span style="color: #a0522d;">host</span>=localhost
<span style="color: #a0522d;">port</span>=5555
<span style="color: #a0522d;">name</span>=TOPE-VPN
<span style="color: #a0522d;">show_disconnect</span>=False

<span style="color: #b22222;">#</span><span style="color: #b22222;">2.&#37197;&#32622;openvpn&#30340;server.conf</span>
cat &gt;&gt;/etc/openvpn/server.conf&lt;&lt;EOF
<span style="color: #ffa54f;">management 127.0.0.1 5555  #&#26412;&#22320;&#31649;&#29702;</span>
<span style="color: #ffa54f;">EOF</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;service.conf&#26368;&#21518;&#19968;&#34892;&#28155;&#21152;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">3.&#37325;&#21551;openvpn</span>
systemctl restart openvpn@server
</pre>
</div>

<p>
访问对应80端口
</p>


<figure id="org3061ce5">
<img src="images/image-20210430073911406.png" alt="image-20210430073911406.png">

</figure>
</div>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
