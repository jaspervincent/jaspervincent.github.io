<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: 日志服务管理</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux: 日志服务管理</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:654d9375-44c4-4a93-9037-162e938b3c80">系统日志管理</a>
<ul>
<li><a href="#h:3437e58f-528b-43f2-b8db-aeaf6d5a28df">系统日志介绍</a>
<ul>
<li><a href="#h:59e4e02d-4465-40cb-9e06-15091bd14f8d">sysklogd 系统日志服务</a></li>
<li><a href="#h:36f18c7e-45ce-4b03-8d98-26aa0618a1d7">rsyslog 系统日志服务</a></li>
<li><a href="#h:34730cca-0deb-46ab-a921-03bffced0d53">ELK</a></li>
</ul>
</li>
<li><a href="#h:534ed293-e712-496b-b0d6-9b48dc7bee4e">rsyslog 管理</a>
<ul>
<li><a href="#h:cdf8783b-aaca-4eb5-893e-84f586929b2c">系统日志术语</a></li>
<li><a href="#h:93898ca7-9fdf-43ab-ba74-3f0c33dd3979">rsyslog 相关文件</a></li>
<li><a href="#h:c734ec52-572a-41d2-b8da-eb409d03e9cb">rsyslog配置文件</a>
<ul>
<li><a href="#org2f5af24">RULES配置格式</a></li>
</ul>
</li>
<li><a href="#h:246da8d2-4357-4131-8825-5b53e5110910">启用网络日志服务</a></li>
<li><a href="#h:2cc68133-2f80-47f9-adb9-1674f2f69f1a">常见日志文件</a></li>
</ul>
</li>
<li><a href="#h:34386797-ff07-48a8-a392-582762cd7c43">日志管理工具 journalctl</a></li>
</ul>
</li>
<li><a href="#h:96a0d666-b4dc-484d-95c5-ce786464309e">实战案例</a>
<ul>
<li><a href="#h:275d5379-1bda-44c2-99d7-e3dd280a819a">实战案例1：利用mysql存储日志信息</a>
<ul>
<li><a href="#h:741864e0-804f-4dfc-a173-5dcb293cd69c">实现步骤</a></li>
</ul>
</li>
<li><a href="#h:ed4fcb46-13b8-4d9c-b810-834cd547933f">实战案例2：通过 loganalyzer 展示数据库中的日志</a>
<ul>
<li><a href="#h:2b3a590f-ec87-4b8c-936f-40205b9dda52">步骤</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:0cef3668-37be-479c-b26e-1aa715f681c7">logrotate日志转储</a>
<ul>
<li><a href="#h:374e5178-d231-443d-a182-14652be10f4b">logrotate 介绍</a></li>
<li><a href="#h:9e1a793f-57a1-44dc-abdf-eae93a4b8f0d">logrotate 配置</a></li>
<li><a href="#h:371516e6-c8e5-4f0e-8ec9-87ce60212adc">logroate 配置范例</a>
<ul>
<li><a href="#h:39934c3b-e211-4d69-9fad-715cfa9b4ee2">范例： 设置nginx的日志转储</a></li>
<li><a href="#h:338e211d-f357-4e93-bada-cbd97fc8d601">范例：对指定日志手动执行日志转储</a></li>
<li><a href="#h:d4e7b3d3-d103-4b21-bfc3-181b24172faa">范例： 其它配置</a></li>
</ul>
</li>
<li><a href="#h:5517551d-1ea8-499d-8ad1-0972e93c9c1b">为什么生成日志的时间是凌晨四五点？</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../../index.html">Linux</a></li>
</ul>

<p>
日志服务管理
</p>

<p>
本章内容
</p>
<ul class="org-ul">
<li>日志介绍</li>
<li>日志管理</li>
<li>日志管理工具 journalctl</li>
<li>基于MYSQL的日志</li>
<li>loganalyzer展示日志</li>
<li>logrotate日志存储</li>
</ul>
<section id="outline-container-h:654d9375-44c4-4a93-9037-162e938b3c80" class="outline-2">
<h2 id="h:654d9375-44c4-4a93-9037-162e938b3c80">系统日志管理</h2>
<div class="outline-text-2" id="text-h:654d9375-44c4-4a93-9037-162e938b3c80">
</div>
<div id="outline-container-h:3437e58f-528b-43f2-b8db-aeaf6d5a28df" class="outline-3">
<h3 id="h:3437e58f-528b-43f2-b8db-aeaf6d5a28df">系统日志介绍</h3>
<div class="outline-text-3" id="text-h:3437e58f-528b-43f2-b8db-aeaf6d5a28df">
<p>
将系统和应用发生的事件记录至日志中，以助于排错和分析使用：
</p>

<p>
日志记录的内容包括：
</p>

<ul class="org-ul">
<li>历史事件：时间，地点，人物，事件</li>
<li>日志级别：事件的关键性程度，Loglevel</li>
</ul>

<p>
事件：系统引导启动、应用程序启动、应用程序尤其是服务类应用程序运行 过程中的一些事件；
</p>
</div>
<div id="outline-container-h:59e4e02d-4465-40cb-9e06-15091bd14f8d" class="outline-4">
<h4 id="h:59e4e02d-4465-40cb-9e06-15091bd14f8d">sysklogd 系统日志服务</h4>
<div class="outline-text-4" id="text-h:59e4e02d-4465-40cb-9e06-15091bd14f8d">
<p>
CentOS 5 之前版本采用的日志管理系统服务
</p>

<ul class="org-ul">
<li>syslogd: system application 记录应用日志</li>
<li>klogd: linux kernel 记录内核日志</li>
</ul>

<p>
事件记录格式：
</p>
<ul class="org-ul">
<li>日期时间 主机 进程[pid]: 事件内容</li>
</ul>

<p>
C/S架构：通过TCP或UDP协议的服务完成日志记录传送，将分布在不同主机的日志实现集中管理
</p>
</div>
</div>
<div id="outline-container-h:36f18c7e-45ce-4b03-8d98-26aa0618a1d7" class="outline-4">
<h4 id="h:36f18c7e-45ce-4b03-8d98-26aa0618a1d7">rsyslog 系统日志服务</h4>
<div class="outline-text-4" id="text-h:36f18c7e-45ce-4b03-8d98-26aa0618a1d7">
<p>
CentOS 6 以后版本的系统管理服务
</p>

<p>
rsyslog 特性
</p>

<ul class="org-ul">
<li>多线程</li>
<li>UDP, TCP, SSL, TLS, RELP</li>
<li>MySQL, PGSQL, Oracle实现日志存储</li>
<li>强大的过滤器，可实现过滤记录日志信息中任意部分</li>
<li>自定义输出格式</li>
<li>适用于企业级中继链</li>
</ul>



<figure id="org8685a1e">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/network-serivce/logos/images/img_20241021_003903.png" alt="img_20241021_003903.png" width="80%">

</figure>
</div>
</div>
<div id="outline-container-h:34730cca-0deb-46ab-a921-03bffced0d53" class="outline-4">
<h4 id="h:34730cca-0deb-46ab-a921-03bffced0d53">ELK</h4>
<div class="outline-text-4" id="text-h:34730cca-0deb-46ab-a921-03bffced0d53">
<p>
ELK：由Elasticsearch, Logstash, Kibana三个软件组成
</p>
<ul class="org-ul">
<li>非关系型分布式数据库</li>
<li>基于apache软件基金会jakarta项目组的项目lucene</li>
<li>Elasticsearch是个开源分布式搜索引擎，可以处理大规模日志数据，比如：Nginx、Tomcat、系</li>
<li>统日志等功能</li>
<li>Logstash对日志进行收集、分析，过滤，并将其存储供以后使用</li>
<li>Kibana 可以提供的日志分析友好的 Web 界面</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:534ed293-e712-496b-b0d6-9b48dc7bee4e" class="outline-3">
<h3 id="h:534ed293-e712-496b-b0d6-9b48dc7bee4e">rsyslog 管理</h3>
<div class="outline-text-3" id="text-h:534ed293-e712-496b-b0d6-9b48dc7bee4e">
</div>
<div id="outline-container-h:cdf8783b-aaca-4eb5-893e-84f586929b2c" class="outline-4">
<h4 id="h:cdf8783b-aaca-4eb5-893e-84f586929b2c">系统日志术语</h4>
<div class="outline-text-4" id="text-h:cdf8783b-aaca-4eb5-893e-84f586929b2c">
<ul class="org-ul">
<li>facility：设施，从功能或程序上对日志进行归类</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#32622;&#31867;</span>
auth, authpriv, cron, daemon,ftp,kern, lpr, mail, news, security(auth),user, uucp, syslog
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#23450;&#35758;&#30340;&#20998;&#31867;</span>
local0-local7
</pre>
</div>

<pre class="example" id="org8394f34">
auth 各应用程序认证功能相关
authpriv 各应用与授权相关
cron 与crontable相关
daemon 和守护进程相关
kern 和内核相关
lpr 和打印系统相关
mail 和邮件系统相关
mark 和防火墙标记相关
news 和新闻组相关
security 和安全相关
user 和用户相关
uucp unix to unix copy,unix系统间复制协议相关
local0-local7 8个可自定义使用分类模式
syslog 其他，不便于归类的全都记录在此处
</pre>

<ul class="org-ul">
<li>Priority 优先级别，从低到高排序</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">debug, info, notice, warn(warning), err(error), crit(critical), alert,emerg(panic)
</pre>
</div>


<ul class="org-ul">
<li>参看帮助： man 3 syslog，man logger</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum -y install man-pages
[root@centos8 ~]#man 3 syslog
</pre>
</div>
</div>
</div>
<div id="outline-container-h:93898ca7-9fdf-43ab-ba74-3f0c33dd3979" class="outline-4">
<h4 id="h:93898ca7-9fdf-43ab-ba74-3f0c33dd3979">rsyslog 相关文件</h4>
<div class="outline-text-4" id="text-h:93898ca7-9fdf-43ab-ba74-3f0c33dd3979">
<ul class="org-ul">
<li>程序包：rsyslog</li>
<li>主程序：/usr/sbin/rsyslogd</li>
<li>CentOS 6：/etc/rc.d/init.d/rsyslog {start|stop|restart|status}</li>
<li>CentOS 7,8：/usr/lib/systemd/system/rsyslog.service</li>
<li>配置文件： /etc/rsyslog.conf，/etc/rsyslog.d/*.conf</li>
<li>库文件： /lib64/rsyslog/*.so</li>
</ul>
</div>
</div>
<div id="outline-container-h:c734ec52-572a-41d2-b8da-eb409d03e9cb" class="outline-4">
<h4 id="h:c734ec52-572a-41d2-b8da-eb409d03e9cb">rsyslog配置文件</h4>
<div class="outline-text-4" id="text-h:c734ec52-572a-41d2-b8da-eb409d03e9cb">
<p>
/etc/rsyslog.conf 配置文件格式：由三部分组成
</p>
<ul class="org-ul">
<li>MODULES：相关模块配置</li>
<li>GLOBAL DIRECTIVES：全局配置</li>
<li>RULES：日志记录相关的规则配置</li>
</ul>
</div>
<div id="outline-container-org2f5af24" class="outline-5">
<h5 id="org2f5af24">RULES配置格式</h5>
<div class="outline-text-5" id="text-org2f5af24">
<div class="org-src-container">
<pre class="src src-sh">facility.priority; facility.priority&#8230;   target


<span style="color: #b22222;">#</span><span style="color: #b22222;">facility&#26684;&#24335;&#65306;</span>
*                                    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#30340;facility </span>
facility1,facility2,facility3,...    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#30340;facility&#21015;&#34920;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">priority&#26684;&#24335;&#65306;</span>
*                                    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#32423;&#21035;</span>
none                                 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27809;&#26377;&#32423;&#21035;&#65292;&#21363;&#19981;&#35760;&#24405;</span>
PRIORITY                             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#32423;&#21035;&#65288;&#21547;&#65289;&#20197;&#19978;&#30340;&#25152;&#26377;&#32423;&#21035;</span>
=PRIORITY                            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20165;&#35760;&#24405;&#25351;&#23450;&#32423;&#21035;&#30340;&#26085;&#24535;&#20449;&#24687;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">target&#26684;&#24335;&#65306;</span>
&#25991;&#20214;&#36335;&#24452;&#65306;&#36890;&#24120;&#22312;/var/log/&#65292;&#25991;&#20214;&#36335;&#24452;&#21069;&#30340; - &#34920;&#31034;&#24322;&#27493;&#20889;&#20837;
&#29992;&#25143;&#65306;&#23558;&#26085;&#24535;&#20107;&#20214;&#36890;&#30693;&#32473;&#25351;&#23450;&#30340;&#29992;&#25143;&#65292;* &#34920;&#31034;&#30331;&#24405;&#30340;&#25152;&#26377;&#29992;&#25143;
&#26085;&#24535;&#26381;&#21153;&#22120;&#65306;@host&#65292;&#25226;&#26085;&#24535;&#36865;&#24448;&#33267;&#25351;&#23450;&#30340;&#36828;&#31243;UDP&#26085;&#24535;&#26381;&#21153;&#22120;, @@host &#23558;&#26085;&#24535;&#21457;&#36865;&#21040;&#36828;&#31243;TCP&#26085;&#24535;&#26381;&#21153;&#22120;
&#31649;&#36947;&#65306; | COMMAND&#65292;&#36716;&#21457;&#32473;&#20854;&#23427;&#21629;&#20196;&#22788;&#29702;
</pre>
</div>



<p>
<b>通常的日志文件的格式：</b>
</p>

<p>
日志文件有很多，如：/var/log/messages,cron,secure等，基本格式都是类似的。格式如下
</p>

<pre class="example" id="orgeb367ec">
事件产生的日期时间 主机 进程(pid)：事件内容
</pre>

<p>
范例：日志文件格式
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#tail /var/log/messages
Nov 12 08:34:18 centos8 dnf[14114]: Metadata cache created.
Nov 12 08:34:18 centos8 systemd[1]: Started dnf makecache.
Nov 12 09:35:14 centos8 systemd[1]: Starting dnf makecache...
Nov 12 09:35:14 centos8 dnf[14249]: Metadata cache refreshed recently.
Nov 12 09:35:14 centos8 systemd[1]: Started dnf makecache.
Nov 12 10:21:22 centos8 systemd[1]: Starting man-db-cache-update.service...
Nov 12 10:21:22 centos8 systemd[1]: Reloading.
Nov 12 10:21:22 centos8 systemd[1]: Started man-db-cache-update.service.

[root@centos8 ~]#tail /var/log/secure
Nov 11 18:27:12 centos8 groupadd[11940]: group added to /etc/group: <span style="color: #a0522d;">name</span>=dhcpd,<span style="color: #a0522d;">GID</span>=177
Nov 11 18:27:12 centos8 groupadd[11940]: group added to /etc/gshadow: <span style="color: #a0522d;">name</span>=dhcpd
Nov 11 18:27:12 centos8 groupadd[11940]: new group: <span style="color: #a0522d;">name</span>=dhcpd, <span style="color: #a0522d;">GID</span>=177
Nov 11 18:27:12 centos8 useradd[11948]: new user: <span style="color: #a0522d;">name</span>=dhcpd, <span style="color: #a0522d;">UID</span>=177, <span style="color: #a0522d;">GID</span>=177,<span style="color: #a0522d;">home</span>=/, <span style="color: #a0522d;">shell</span>=/sbin/nologin
</pre>
</div>

<p>
范例：CentOS/Rocky与Ubuntu中的rsyslog配置比较
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">CentOS</span>
*.info;mail.none;authpriv.none;cron.none                /var/log/messages
authpriv.*                                              /var/log/secure

<span style="color: #b22222;">#</span><span style="color: #b22222;">Ubuntu /etc/rsyslog.d/50-default.conf</span>
*.*;auth,authpriv.none      -/var/log/syslog <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31867;&#20284;CentOS&#20013;message&#20869;&#23481;</span>
<span style="color: #b22222;">#   </span><span style="color: #b22222;">mail,news.none      -/var/log/messages</span>
auth,authpriv.*         /var/log/auth.log    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31867;&#20284;CentOS&#20013;secure&#20869;&#23481;</span>
</pre>
</div>

<p>
范例：将ssh服务的日志记录至自定义的local的日志设备
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;sshd&#26381;&#21153;&#30340;&#37197;&#32622;</span>
vim /etc/ssh/sshd_config
syslogFacility local2

systemctl restart sshd

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;rsyslog&#30340;&#37197;&#32622;</span>
vim /etc/rsyslog.conf
local2.* /var/log/sshd.log

systemctl     restart rsyslog

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;</span>
ssh&#30331;&#24405;&#21518;&#65292;&#26597;&#30475;/var/log/sshd.log&#26377;&#35760;&#24405;

<span style="color: #b22222;">#</span><span style="color: #b22222;">logger&#27979;&#35797;</span>
logger -p local2.info <span style="color: #8b2252;">"hello sshd"</span>
tail /var/log/sshd.log&#26377;&#35760;&#24405;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:246da8d2-4357-4131-8825-5b53e5110910" class="outline-4">
<h4 id="h:246da8d2-4357-4131-8825-5b53e5110910">启用网络日志服务</h4>
<div class="outline-text-4" id="text-h:246da8d2-4357-4131-8825-5b53e5110910">
<p>
启用网络日志服务功能，可以将多个远程主机的日志，发送到集中的日志服务器，方便统一管理。
</p>

<p>
范例：CentOS 8 启用网络日志功能
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /etc/rsyslog.conf
<span style="color: #b22222;">#### </span><span style="color: #b22222;">MODULES ####</span>
...&#30465;&#30053;...
<span style="color: #b22222;"># </span><span style="color: #b22222;">Provides UDP syslog reception</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">for parameters see http://www.rsyslog.com/doc/imudp.html</span>
<span style="color: #0000ff;">module</span>(<span style="color: #a0522d;">load</span>=<span style="color: #8b2252;">"imudp"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">needs to be done just once</span>
<span style="color: #0000ff;">input</span>(<span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"imudp"</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">"514"</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">Provides TCP syslog reception</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">for parameters see http://www.rsyslog.com/doc/imtcp.html</span>
<span style="color: #0000ff;">module</span>(<span style="color: #a0522d;">load</span>=<span style="color: #8b2252;">"imtcp"</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">needs to be done just once</span>
<span style="color: #0000ff;">input</span>(<span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"imtcp"</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">"514"</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#23458;&#25143;&#31471;&#25351;&#23450;&#23558;&#26085;&#24535;&#21457;&#36865;&#21040;&#36828;&#31243;&#30340;TCP&#12289;UDP&#30340;&#26085;&#24535;&#26381;&#21153;&#22120;</span>
[root@centos7 ~]#vim /etc/rsyslog.conf
*.info;mail.none;authpriv.none;cron.none                             /var/log/messages
*.info;mail.none;authpriv.none;cron.none                             @@10.0.0.18
*.info;mail.none;authpriv.none;cron.none                             @10.0.0.18
</pre>
</div>

<p>
范例：CentOS 7 和6 启用网络日志功能
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">####</span><span style="color: #b22222;">MODULES####</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Provides UDP syslog reception</span>
$<span style="color: #a0522d;">ModLoad</span> imudp
$<span style="color: #a0522d;">UDPServerRun</span> 514

<span style="color: #b22222;"># </span><span style="color: #b22222;">Provides TCP syslog reception</span>
$<span style="color: #a0522d;">ModLoad</span> imtcp
$<span style="color: #a0522d;">InputTCPServerRun</span> 514
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2cc68133-2f80-47f9-adb9-1674f2f69f1a" class="outline-4">
<h4 id="h:2cc68133-2f80-47f9-adb9-1674f2f69f1a">常见日志文件</h4>
<div class="outline-text-4" id="text-h:2cc68133-2f80-47f9-adb9-1674f2f69f1a">
<ul class="org-ul">
<li>/var/log/secure：系统安全日志，文本格式，应周期性分析</li>
<li>/var/log/btmp：当前系统上，用户的失败尝试登录相关的日志信息，二进制格式，lastb命令进行查看</li>
<li>/var/log/wtmp：当前系统上，用户正常登录系统的相关日志信息，二进制格式，last命令可以查看</li>
<li>/var/log/lastlog:每一个用户最近一次的登录信息，二进制格式，lastlog命令可以查看</li>
<li>/var/log/dmesg：CentOS7之前版本系统引导过程中的日志信息，文本格式，开机后的硬件变化将不再记录
<ul class="org-ul">
<li>专用命令dmesg查看，可持续记录硬件变化的情况</li>
</ul></li>
<li>/var/log/boot.log 系统服务启动的相关信息，文本格式</li>
<li>/var/log/messages ：系统中大部分的信息</li>
<li>/var/log/anaconda : anaconda的日志, centos才有。记录系统安装情况</li>
</ul>

<p>
范例：找到失败登录的IP
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#awk <span style="color: #8b2252;">'/Failed password/{print $(</span><span style="color: #ff00ff;">NF-3</span><span style="color: #8b2252;">)}'</span> /var/log/secure
192.168.39.7
192.168.39.18
192.168.39.18
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25214;&#20986;&#22833;&#36133;&#30331;&#24405;&#27425;&#25968;&#26368;&#22810;&#30340;&#21069;10&#20010;IP</span>
[root@centos8 ~]#lastb -f btmp-test1 | awk <span style="color: #8b2252;">'{print $3}'</span>|sort | uniq -c|sort -nr|head
    8374 112.64.33.38
    7041 221.125.235.4
    6502 183.247.184.220
    5970 203.190.163.125
    5297 202.89.0.27
    3062 119.163.122.32
    2961 124.126.248.6
    2921 92.222.1.40
    2896 112.65.170.186
    1955 118.97.213.118

[root@centos8 ~]#lastb -f btmp-test2 | awk <span style="color: #8b2252;">'{ip[$3]++}END{for(i in ip){print ip[i],i}}'</span>|sort -nr|head
86294 58.218.92.37
43148 58.218.92.26
18036 112.85.42.201
10501 111.26.195.101
10501 111.231.235.49
10501 111.204.186.207
10501 111.11.29.199
10499 118.26.23.225
6288 42.7.26.142
4236 58.218.92.30

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27491;&#24120;&#30331;&#24405;</span>
last 

<span style="color: #b22222;">#</span><span style="color: #b22222;">root&#36134;&#21495;&#26368;&#21518;&#19968;&#27425;&#30331;&#24405;&#24773;&#20917;</span>
ls /var/log/lastlog
lastlog
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:34386797-ff07-48a8-a392-582762cd7c43" class="outline-3">
<h3 id="h:34386797-ff07-48a8-a392-582762cd7c43">日志管理工具 journalctl</h3>
<div class="outline-text-3" id="text-h:34386797-ff07-48a8-a392-582762cd7c43">
<p>
CentOS 7 以后版，利用Systemd 统一管理所有 Unit的启动日志。带来的好处就
是，可以只用journalctl一个命令，查看所有日志（内核日志和应用日志）。
</p>

<p>
<b>日志的配置文件：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/systemd/journald.conf
</pre>
</div>

<p>
<b>journalctl命令格式</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">journalctl [OPTIONS...] [MATCHES...]
</pre>
</div>

<p>
<b>选项说明：</b>
</p>

<pre class="example" id="org896a897">
--no-full, --full, -l
    如果字段内容超长则以省略号(...)截断以适应列宽。
    默认显示完整的字段内容(超长的部分换行显示或者被分页工具截断)。

    老旧的 -l/--full 选项 仅用于撤销已有的 --no-full 选项，除此之外没有其他用处。
-a, --all
    完整显示所有字段内容， 即使其中包含不可打印字符或者字段内容超长。
-f, --follow
    只显示最新的日志项，并且不断显示新生成的日志项。 此选项隐含了 -n 选项。
-e, --pager-end
    在分页工具内立即跳转到日志的尾部。 此选项隐含了 -n1000
    以确保分页工具不必缓存太多的日志行。 不过这个隐含的行数可以被明确设置的 -n
    选项覆盖。 注意，此选项仅可用于 less(1) 分页器。
-n, --lines=
    限制显示最新的日志行数。 --pager-end 与 --follow 隐含了此选项。
    此选项的参数：若为正整数则表示最大行数； 若为 "all" 则表示不限制行数；
    若不设参数则表示默认值10行。
--no-tail
    显示所有日志行， 也就是用于撤销已有的 --lines= 选项(即使与 -f 连用)。
-r, --reverse
    反转日志行的输出顺序， 也就是最先显示最新的日志。
-o, --output=
    控制日志的输出格式。 可以使用如下选项：
    short
            这是默认值， 其输出格式与传统的 syslog[1] 文件的格式相似， 每条日志一行。
    short-iso
            与 short 类似，只是将时间戳字段以 ISO 8601 格式显示。
    short-precise
            与 short 类似，只是将时间戳字段的秒数精确到微秒级别。
    short-monotonic
            与 short 类似，只是将时间戳字段的零值从内核启动时开始计算。
    short-unix
            与 short 类似，只是将时间戳字段显示为从"UNIX时间原点"(1970-1-1 00:00:00
            UTC)以来的秒数。 精确到微秒级别。
    verbose
            以结构化的格式显示每条日志的所有字段。
        export
            将日志序列化为二进制字节流(大部分依然是文本) 以适用于备份与网络传输(详见
             Journal Export Format[2] 文档)。
    json
            将日志项按照JSON数据结构格式化， 每条日志一行(详见 Journal JSON Format[3]
            文档)。
    json-pretty
            将日志项按照JSON数据结构格式化， 但是每个字段一行， 以便于人类阅读。
    json-sse
            将日志项按照JSON数据结构格式化，每条日志一行，但是用大括号包围， 以适应
            Server-Sent Events[4] 的要求。
        cat
            仅显示日志的实际内容， 而不显示与此日志相关的任何元数据(包括时间戳)。
--utc
    以世界统一时间(UTC)表示时间
--no-hostname
    不显示来源于本机的日志消息的主机名字段。 此选项仅对 short
    系列输出格式(见上文)有效。
-x, --catalog
    在日志的输出中增加一些解释性的短文本， 以帮助进一步说明日志的含义、
    问题的解决方案、支持论坛、 开发文档、以及其他任何内容。
    并非所有日志都有这些额外的帮助文本， 详见 Message Catalog Developer
    Documentation[5] 文档。
    注意，如果要将日志输出用于bug报告， 请不要使用此选项。
-q, --quiet
    当以普通用户身份运行时， 不显示任何警告信息与提示信息。 例如："-- Logs begin at
    ...", "-- Reboot --"
-m, --merge
    混合显示包括远程日志在内的所有可见日志。
-b [ID][±offset], --boot=[ID][±offset]
    显示特定于某次启动的日志， 这相当于添加了一个 "_BOOT_ID=" 匹配条件。
    如果参数为空(也就是 ID 与 ±offset 都未指定)， 则表示仅显示本次启动的日志。
    如果省略了 ID ， 那么当 ±offset 是正数的时候， 将从日志头开始正向查找，
    否则(也就是为负数或零)将从日志尾开始反响查找。 举例来说， "-b
        1"表示按时间顺序排列最早的那次启动， "-b 2"则表示在时间上第二早的那次启动； "-b
        -0"表示最后一次启动， "-b -1"表示在时间上第二近的那次启动， 以此类推。 如果
    ±offset 也省略了， 那么相当于"-b -0"， 除非本次启动不是最后一次启动(例如用
        --directory 指定了另外一台主机上的日志目录)。
    如果指定了32字符的 ID ， 那么表示以此 ID 所代表的那次启动为基准
    计算偏移量(±offset)， 计算方法同上。 换句话说， 省略 ID 表示以本次启动为基准
    计算偏移量(±offset)。
--list-boots
    列出每次启动的 序号(也就是相对于本次启动的偏移量)、32字符的ID、
    第一条日志的时间戳、最后一条日志的时间戳。
-k, --dmesg
    仅显示内核日志。隐含了 -b 选项以及 "_TRANSPORT=kernel" 匹配项。
-t, --identifier=SYSLOG_IDENTIFIER
    仅显示 syslog[1] 识别符为 SYSLOG_IDENTIFIER 的日志项。
    可以多次使用该选项以指定多个识别符。
-u, --unit=UNIT|PATTERN
    仅显示属于特定单元的日志。 也就是单元名称正好等于 UNIT 或者符合 PATTERN
    模式的单元。 这相当于添加了一个 "_SYSTEMD_UNIT=UNIT" 匹配项(对于 UNIT 来说)，
    或一组匹配项(对于 PATTERN 来说)。
    可以多次使用此选项以添加多个并列的匹配条件(相当于用"OR"逻辑连接)。
--user-unit=
    仅显示属于特定用户会话单元的日志。 相当于同时添加了 "_SYSTEMD_USER_UNIT=" 与
        "_UID=" 两个匹配条件。
    可以多次使用此选项以添加多个并列的匹配条件(相当于用"OR"逻辑连接)。
-p, --priority=
    根据日志等级(包括等级范围)过滤输出结果。 日志等级数字与其名称之间的对应关系如下
    (参见 syslog(3))： "emerg" (0), "alert" (1), "crit" (2), "err" (3),
        "warning" (4), "notice" (5), "info" (6), "debug" (7) 。
    若设为一个单独的数字或日志等级名称， 则表示仅显示小于或等于此等级的日志
    (也就是重要程度等于或高于此等级的日志)。 若使用 FROM..TO.. 设置一个范围，
    则表示仅显示指定的等级范围内(含两端)的日志。 此选项相当于添加了 "PRIORITY="
    匹配条件。
-c, --cursor=
    从指定的游标(cursor)开始显示日志。
    [提示]每条日志都有一个"__CURSOR"字段，类似于该条日志的指纹。
--after-cursor=
    从指定的游标(cursor)之后开始显示日志。 如果使用了 --show-cursor 选项，
    则也会显示游标本身。
--show-cursor
    在最后一条日志之后显示游标， 类似下面这样，以"--"开头：
                -- cursor: s=0639...
    游标的具体格式是私有的(也就是没有公开的规范)， 并且会变化。
-S, --since=, -U, --until=
    显示晚于指定时间(--since=)的日志、显示早于指定时间(--until=)的日志。
    参数的格式类似 "2012-10-30 18:17:16" 这样。 如果省略了"时:分:秒"部分，
    则相当于设为 "00:00:00" 。 如果仅省略了"秒"的部分则相当于设为 ":00" 。
    如果省略了"年-月-日"部分， 则相当于设为当前日期。 除了"年-月-日 时:分:秒"格式，
    参数还可以进行如下设置： (1)设为 "yesterday", "today", "tomorrow"
    以表示那一天的零点(00:00:00)。 (2)设为 "now" 以表示当前时间。
    (3)可以在"年-月-日 时:分:秒"前加上 "-"(前移) 或 "+"(后移)
    前缀以表示相对于当前时间的偏移。 关于时间与日期的详细规范， 参见
    systemd.time(7)
-F, --field=
    显示所有日志中某个字段的所有可能值。 [译者注]类似于SQL语句："SELECT DISTINCT
     某字段 FROM 全部日志"
-N, --fields
    输出所有日志字段的名称
--system, --user
    仅显示系统服务与内核的日志(--system)、 仅显示当前用户的日志(--user)。
    如果两个选项都未指定，则显示当前用户的所有可见日志。
-M, --machine=
    显示来自于正在运行的、特定名称的本地容器的日志。 参数必须是一个本地容器的名称。
-D DIR, --directory=DIR
    仅显示来自于特定目录中的日志， 而不是默认的运行时和系统日志目录中的日志。
--file=GLOB
    GLOB 是一个可以包含"?"与"*"的文件路径匹配模式。 表示仅显示来自与指定的 GLOB
    模式匹配的文件中的日志， 而不是默认的运行时和系统日志目录中的日志。
    可以多次使用此选项以指定多个匹配模式(多个模式之间用"OR"逻辑连接)。
--root=ROOT
    在对日志进行操作时， 将 ROOT 视为系统的根目录。 例如 --update-catalog 将会创建
    ROOT/var/lib/systemd/catalog/database
--new-id128
    此选项并不用于显示日志内容， 而是用于重新生成一个标识日志分类的 128-bit ID 。
    此选项的目的在于 帮助开发者生成易于辨别的日志消息， 以方便调试。
--header
    此选项并不用于显示日志内容， 而是用于显示日志文件内部的头信息(类似于元数据)。
--disk-usage
    此选项并不用于显示日志内容，
    而是用于显示所有日志文件(归档文件与活动文件)的磁盘占用总量。
--vacuum-size=, --vacuum-time=, --vacuum-files=
    这些选项并不用于显示日志内容，
    而是用于清理日志归档文件(并不清理活动的日志文件)， 以释放磁盘空间。
    --vacuum-size= 可用于限制归档文件的最大磁盘使用量 (可以使用 "K", "M", "G", "T"
    后缀)； --vacuum-time= 可用于清除指定时间之前的归档 (可以使用 "s", "m", "h",
    "days", "weeks", "months", "years" 后缀)； --vacuum-files=
    可用于限制日志归档文件的最大数量。 注意，--vacuum-size= 对 --disk-usage
    的输出仅有间接效果， 因为 --disk-usage 输出的是归档日志与活动日志的总量。
    同样，--vacuum-files= 也未必一定会减少日志文件的总数，
    因为它同样仅作用于归档文件而不会删除活动的日志文件。
    此三个选项可以同时使用，以同时从三个维度去限制归档文件。
    若将某选项设为零，则表示取消此选项的限制。
--list-catalog [128-bit-ID...]
    简要列出日志分类信息， 其中包括对分类信息的简要描述。
    如果明确指定了分类ID(128-bit-ID)， 那么仅显示指定的分类。
--dump-catalog [128-bit-ID...]
    详细列出日志分类信息 (格式与 .catalog 文件相同)。
    如果明确指定了分类ID(128-bit-ID)， 那么仅显示指定的分类。
--update-catalog
    更新日志分类索引二进制文件。
    每当安装、删除、更新了分类文件，都需要执行一次此动作。
--setup-keys
    此选项并不用于显示日志内容， 而是用于生成一个新的FSS(Forward Secure
    Sealing)密钥对。 此密钥对包含一个"sealing key"与一个"verification key"。
    "sealing key"保存在本地日志目录中， 而"verification key"则必须保存在其他地方。
    详见 journald.conf(5) 中的 Seal= 选项。
--force
    与 --setup-keys 连用， 表示即使已经配置了FSS(Forward Secure Sealing)密钥对，
    也要强制重新生成。
--interval=
    与 --setup-keys 连用，指定"sealing key"的变化间隔。
    较短的时间间隔会导致占用更多的CPU资源， 但是能够减少未检测的日志变化时间。
    默认值是 15min
--verify
    检查日志文件的内在一致性。 如果日志文件在生成时开启了FSS特性， 并且使用
        --verify-key= 指定了FSS的"verification key"，
    那么，同时还将验证日志文件的真实性。
--verify-key=
    与 --verify 选项连用， 指定FSS的"verification key"
--sync
    要求日志守护进程将所有未写入磁盘的日志数据刷写到磁盘上，
    并且一直阻塞到刷写操作实际完成之后才返回。 因此该命令可以保证当它返回的时候，
    所有在调用此命令的时间点之前的日志， 已经全部安全的刷写到了磁盘中。
--flush
    要求日志守护进程 将 /run/log/journal 中的日志数据 刷写到 /var/log/journal 中
    (如果持久存储设备当前可用的话)。 此操作会一直阻塞到操作完成之后才会返回，
    因此可以确保在该命令返回时， 数据转移确实已经完成。
    注意，此命令仅执行一个单独的、一次性的转移动作， 若没有数据需要转移，
    则此命令什么也不做， 并且也会返回一个表示操作已正确完成的返回值。
--rotate
    要求日志守护进程滚动日志文件。 此命令会一直阻塞到滚动完成之后才会返回。
-h, --help
    显示简短的帮助信息并退出。
--version
    显示简短的版本信息并退出。
--no-pager
    不将程序的输出内容管道(pipe)给分页程序
</pre>

<p>
<b>范例：journalctl用法</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25152;&#26377;&#26085;&#24535;&#65288;&#40664;&#35748;&#24773;&#20917;&#19979; &#65292;&#21482;&#20445;&#23384;&#26412;&#27425;&#21551;&#21160;&#30340;&#26085;&#24535;&#65289;</span>
journalctl

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20869;&#26680;&#26085;&#24535;&#65288;&#19981;&#26174;&#31034;&#24212;&#29992;&#26085;&#24535;&#65289;</span>
journalctl -k

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#31995;&#32479;&#26412;&#27425;&#21551;&#21160;&#30340;&#26085;&#24535;</span>
journalctl -b
journalctl -b -0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#19978;&#19968;&#27425;&#21551;&#21160;&#30340;&#26085;&#24535;&#65288;&#38656;&#26356;&#25913;&#35774;&#32622;&#65289;</span>
journalctl -b -1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#26102;&#38388;&#30340;&#26085;&#24535;</span>
journalctl --since=<span style="color: #8b2252;">"2017-10-30 18:10:30"</span>
journalctl --since <span style="color: #8b2252;">"20 min ago"</span>
journalctl --since yesterday
journalctl --since <span style="color: #8b2252;">"2017-01-10"</span> --until <span style="color: #8b2252;">"2017-01-11 03:00"</span>
journalctl --since 09:00 --until <span style="color: #8b2252;">"1 hour ago"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#23614;&#37096;&#30340;&#26368;&#26032;10&#34892;&#26085;&#24535;</span>
journalctl -n

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#23614;&#37096;&#25351;&#23450;&#34892;&#25968;&#30340;&#26085;&#24535;</span>
journalctl -n 20

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23454;&#26102;&#28378;&#21160;&#26174;&#31034;&#26368;&#26032;&#26085;&#24535;</span>
journalctl -f

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#26381;&#21153;&#30340;&#26085;&#24535;</span>
journalctl /usr/lib/systemd/systemd

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#36827;&#31243;&#30340;&#26085;&#24535;</span>
journalctl <span style="color: #a0522d;">_PID</span>=1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26576;&#20010;&#36335;&#24452;&#30340;&#33050;&#26412;&#30340;&#26085;&#24535;</span>
journalctl /usr/bin/bash

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#29992;&#25143;&#30340;&#26085;&#24535;</span>
journalctl <span style="color: #a0522d;">_UID</span>=33 --since today

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26576;&#20010; Unit &#30340;&#26085;&#24535;</span>
journalctl -u nginx.service
journalctl -u nginx.service --since today

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23454;&#26102;&#28378;&#21160;&#26174;&#31034;&#26576;&#20010; Unit &#30340;&#26368;&#26032;&#26085;&#24535;</span>
journalctl -u nginx.service -f

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21512;&#24182;&#26174;&#31034;&#22810;&#20010; Unit &#30340;&#26085;&#24535;</span>
journalctl -u nginx.service -u php-fpm.service --since today

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#20248;&#20808;&#32423;&#65288;&#21450;&#20854;&#20197;&#19978;&#32423;&#21035;&#65289;&#30340;&#26085;&#24535;&#65292;&#20849;&#26377;8&#32423;</span>
0: emerg
1: alert
2: crit
3: err
4: warning
5: notice
6: info
7: debug
journalctl -p err -b

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26085;&#24535;&#40664;&#35748;&#20998;&#39029;&#36755;&#20986;&#65292;--no-pager &#25913;&#20026;&#27491;&#24120;&#30340;&#26631;&#20934;&#36755;&#20986;</span>
journalctl --no-pager

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26085;&#24535;&#31649;&#29702;journalctl</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197; JSON &#26684;&#24335;&#65288;&#21333;&#34892;&#65289;&#36755;&#20986;</span>
journalctl -b -u nginx.service -o json

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197; JSON &#26684;&#24335;&#65288;&#22810;&#34892;&#65289;&#36755;&#20986;&#65292;&#21487;&#35835;&#24615;&#26356;&#22909;</span>
journalctl -b -u nginx.serviceqq -o json-pretty

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#26085;&#24535;&#21344;&#25454;&#30340;&#30828;&#30424;&#31354;&#38388;</span>
journalctl --disk-usage

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#26085;&#24535;&#25991;&#20214;&#21344;&#25454;&#30340;&#26368;&#22823;&#31354;&#38388;</span>
journalctl --vacuum-size=1G

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#26085;&#24535;&#25991;&#20214;&#20445;&#23384;&#22810;&#20037;</span>
journalctl --vacuum-time=1years
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:96a0d666-b4dc-484d-95c5-ce786464309e" class="outline-2">
<h2 id="h:96a0d666-b4dc-484d-95c5-ce786464309e">实战案例</h2>
<div class="outline-text-2" id="text-h:96a0d666-b4dc-484d-95c5-ce786464309e">
</div>
<div id="outline-container-h:275d5379-1bda-44c2-99d7-e3dd280a819a" class="outline-3">
<h3 id="h:275d5379-1bda-44c2-99d7-e3dd280a819a">实战案例1：利用mysql存储日志信息</h3>
<div class="outline-text-3" id="text-h:275d5379-1bda-44c2-99d7-e3dd280a819a">

<figure id="org6058b46">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/network-serivce/logos/images/image-20210218173451717.png" alt="image-20210218173451717.png">

</figure>

<p>
目标: 利用rsyslog日志服务，将收集的日志记录于MySQL中
</p>

<p>
环境准备:
</p>

<pre class="example" id="orgcecd7ac">
两台主机

一台：rsyslog日志服务器，IP：10.0.0.8

一台：mariadb数据库服务器，IP：10.0.0.18
</pre>
</div>
<div id="outline-container-h:741864e0-804f-4dfc-a173-5dcb293cd69c" class="outline-4">
<h4 id="h:741864e0-804f-4dfc-a173-5dcb293cd69c">实现步骤</h4>
<div class="outline-text-4" id="text-h:741864e0-804f-4dfc-a173-5dcb293cd69c">
<p>
<b>在rsyslog服务器上安装连接mysql模块相关的程序包</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum install rsyslog-mysql
[root@centos8 ~]#rpm -ql rsyslog-mysql
/usr/lib/.build-id
/usr/lib/.build-id/d7
/usr/lib/.build-id/d7/77fc839aa07e92f0a8858cf3f122996436c7df
/usr/lib64/rsyslog/ommysql.so
/usr/share/doc/rsyslog/mysql-createDB.sql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;sql&#33050;&#26412;&#25991;&#20214;&#20869;&#23481;</span>
[root@centos8 ~]#cat /usr/share/doc/rsyslog/mysql-createDB.sql
CREATE DATABASE Syslog;
USE Syslog;
CREATE TABLE SystemEvents
(
            ID int unsigned not null auto_increment primary key,
            CustomerID bigint,
            ReceivedAt datetime NULL,
            DeviceReportedTime datetime NULL,
            Facility smallint NULL,
            Priority smallint NULL,
            FromHost varchar(60) NULL,
            Message text,
            NTSeverity int NULL,
            Importance int NULL,
            EventSource varchar(60),
            EventUser varchar(60) NULL,
            EventCategory int NULL,
            EventID int NULL,
            EventBinaryData text NULL,
            MaxAvailable int NULL,
            CurrUsage int NULL,
            MinUsage int NULL,
            MaxUsage int NULL,
            InfoUnitID int NULL ,
            SysLogTag varchar(60),
            EventLogType varchar(60),
            GenericFileName VarChar(60),
            SystemID int NULL
);
CREATE TABLE SystemEventsProperties
(
            ID int unsigned not null auto_increment primary key,
            SystemEventID int NULL ,
            ParamName varchar(255) NULL ,
            ParamValue text NULL
);
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;sql&#33050;&#26412;&#22797;&#21046;&#21040;&#25968;&#25454;&#24211;&#26381;&#24211;&#19978;</span>
[root@centos8 ~]#scp /usr/share/doc/rsyslog/mysql-createDB.sql 10.0.0.18:/data
</pre>
</div>

<p>
<b>准备MySQL Server</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum install mariadb-server
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;mariadb&#25968;&#25454;&#24211;&#26381;&#21153;&#22120;&#19978;&#21019;&#24314;&#30456;&#20851;&#25968;&#25454;&#24211;&#21644;&#34920;&#65292;&#24182;&#25480;&#26435;rsyslog&#33021;&#36830;&#25509;&#33267;&#24403;&#21069;&#26381;&#21153;&#22120;</span>
[root@centos8 ~]#mysql -u
[root@centos8 ~]#mysql&gt;source /data/mysql-createDB.sql
[root@centos8 ~]#mysql&gt;GRANT ALL ON Syslog.* TO <span style="color: #8b2252;">'rsyslog'</span>@<span style="color: #8b2252;">'10.0.0.%'</span> IDENTIFIED BY <span style="color: #8b2252;">'me'</span>;
</pre>
</div>

<p>
<b>配置日志服务器将日志发送至指定数据库</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;rsyslog&#23558;&#26085;&#24535;&#20445;&#23384;&#21040;mysql&#20013;</span>
[root@centos8 ~]#vim /etc/rsyslog.conf
<span style="color: #b22222;">#</span>
<span style="color: #b22222;">####</span><span style="color: #b22222;">MODULES####</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312; MODULES &#35821;&#35328;&#19979;&#38754;&#65292;&#22914;&#26524;&#26159; CentOS 8 &#21152;&#19979;&#38754;&#34892;</span>
<span style="color: #0000ff;">module</span>(<span style="color: #a0522d;">load</span>=<span style="color: #8b2252;">"ommysql"</span>)
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312; MODULES &#35821;&#35328;&#19979;&#38754;&#65292;&#22914;&#26524;&#26159; CentOS 7&#65292;6 &#21152;&#19979;&#38754;&#34892;</span>
$<span style="color: #a0522d;">ModLoad</span> ommysql
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;RULES&#35821;&#21477;&#22359;&#21152;&#19979;&#38754;&#34892;&#30340;&#26684;&#24335;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">facility.priority     :ommysql:DBHOST,DBNAME,DBUSER, PASSWORD</span>
*.info :ommysql:10.0.0.18,Syslog,rsyslog,me

[root@centos8 ~]#systemctl restart rsyslog.service
</pre>
</div>

<p>
<b>测试</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#26085;&#24535;&#26381;&#21153;&#22120;&#19978;&#29983;&#25104;&#26085;&#24535;</span>
[root@centos8 ~]#logger <span style="color: #8b2252;">"this is a test log"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#25968;&#25454;&#24211;&#19978;&#26597;&#35810;&#21040;&#19978;&#38754;&#30340;&#27979;&#35797;&#26085;&#24535;</span>
mysql&gt;SELECT COUNT(*) FROM SystemEvents;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ed4fcb46-13b8-4d9c-b810-834cd547933f" class="outline-3">
<h3 id="h:ed4fcb46-13b8-4d9c-b810-834cd547933f">实战案例2：通过 loganalyzer 展示数据库中的日志</h3>
<div class="outline-text-3" id="text-h:ed4fcb46-13b8-4d9c-b810-834cd547933f">
<p>
loganalyzer是用 php
语言实现的日志管理系统，可将MySQL数据库的日志用丰富的WEB方式进行展示
</p>

<p>
官网：<a href="https://loganalyzer.adiscon.com">https://loganalyzer.adiscon.com</a>
</p>

<p>
目标: 通过 loganalyzer 展示数据库中的日志
</p>


<figure id="org0ccfc7a">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/network-serivce/logos/images/image-20210218173514177.png" alt="image-20210218173514177.png">

</figure>

<p>
环境准备:
</p>

<p>
三台主机
</p>
<ul class="org-ul">
<li>一台日志服务器，利用上一个案例实现，IP：10.0.0.8，</li>
<li>一台数据库服务器，利用上一个案例实现，IP：10.0.0.18</li>
<li>一台当httpd+php 服务器，并安装loganalyzer展示web图形，IP：10.0.0.28</li>
</ul>
</div>
<div id="outline-container-h:2b3a590f-ec87-4b8c-936f-40205b9dda52" class="outline-4">
<h4 id="h:2b3a590f-ec87-4b8c-936f-40205b9dda52">步骤</h4>
<div class="outline-text-4" id="text-h:2b3a590f-ec87-4b8c-936f-40205b9dda52">
<p>
<b>安装 php和相关软件包</b>
</p>

<p>
在192.168.8.102主机上安装php和相关软件包
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum -y install httpd php-fpm php-mysqlnd php-gd
[root@centos8 ~]#systemctl restart httpd php-fpm
</pre>
</div>

<p>
<b>安装 LogAnalyzer</b>
</p>

<p>
在192.168.8.102主机上安装LogAnalyzer
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;http://loganalyzer.adiscon.com/downloads/ &#19979;&#36733;loganalyzer-4.1.10.tar.gz</span>
[root@centos8 ~]#tar xvf loganalyzer-4.1.10.tar.gz
[root@centos8 ~]#mv loganalyzer-4.1.10/src/ /var/www/html/log
[root@centos8 ~]#touch /var/www/html/log/config.php
[root@centos8 ~]#chmod 666 /var/www/html/log/config.php
</pre>
</div>

<p>
<b>基于 web 页面初始化</b>
</p>

<p>
访问<a href="http://10.0.0.28/log">http://10.0.0.28/log</a>
</p>

<p>
实现初始化 选择：MySQL Native, Syslog Fields, Monitorware
</p>


<figure id="orgc191e1a">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/network-serivce/logos/images/image-20210218173541534.png" alt="image-20210218173541534.png">

</figure>


<figure id="org7942643">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/network-serivce/logos/images/image-20210218173549814.png" alt="image-20210218173549814.png">

</figure>


<figure id="org6a1b149">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/network-serivce/logos/images/image-20210218173609771.png" alt="image-20210218173609771.png">

</figure>

<p>
如果没有安装php-gd包，会如下错误
</p>


<figure id="org8243521">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/network-serivce/logos/images/image-20210218173621944.png" alt="image-20210218173621944.png">

</figure>

<p>
<b>安全加强</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#chmod 644 /var/www/html/log/config.php
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:0cef3668-37be-479c-b26e-1aa715f681c7" class="outline-2">
<h2 id="h:0cef3668-37be-479c-b26e-1aa715f681c7">logrotate日志转储</h2>
<div class="outline-text-2" id="text-h:0cef3668-37be-479c-b26e-1aa715f681c7">
</div>
<div id="outline-container-h:374e5178-d231-443d-a182-14652be10f4b" class="outline-3">
<h3 id="h:374e5178-d231-443d-a182-14652be10f4b">logrotate 介绍</h3>
<div class="outline-text-3" id="text-h:374e5178-d231-443d-a182-14652be10f4b">
<p>
logrotate程序是一个日志文件管理工具。用来把旧的日志文件删除，并创建新
的日志文件，称为日志转储或滚动。可以根据日志文件的大小，也可以根据其天
数来转储，这个过程一般通过cron 程序来执行
</p>
</div>
</div>
<div id="outline-container-h:9e1a793f-57a1-44dc-abdf-eae93a4b8f0d" class="outline-3">
<h3 id="h:9e1a793f-57a1-44dc-abdf-eae93a4b8f0d">logrotate 配置</h3>
<div class="outline-text-3" id="text-h:9e1a793f-57a1-44dc-abdf-eae93a4b8f0d">
<p>
软件包：logrotate
</p>

<p>
<b>相关文件</b>
</p>
<ul class="org-ul">
<li>计划任务：/etc/cron.daily/logrotate</li>
<li>程序文件：/usr/sbin/logrotate</li>
<li>配置文件： /etc/logrotate.conf</li>
<li>日志文件：/var/lib/logrotate/logrotate.status</li>
</ul>

<p>
<b>配置文件主要参数如下</b> ：
</p>
<ul class="org-ul">
<li>指定转储周期manthly: 日志文件将按月轮循。其它可用值为‘daily’，‘weekly’或者‘yearly’。</li>
<li><b>compress</b> : 在轮循任务完成后，已轮循的归档将使用gzip进行压缩。
<ul class="org-ul">
<li>nocompress: 不压缩</li>
</ul></li>
<li><b>copytruncate</b> : 用于还在打开中的日志文件，把当前日志备份并截断
<ul class="org-ul">
<li>nocopytruncate: 备份日志文件但是不截断</li>
</ul></li>
<li>create mode ownergroup:  转储文件，使用指定的权限，所有者，所属组创建新的日志文件。如 <code>create 644 root root</code>
<ul class="org-ul">
<li>nocreate: 不建立新的日志文件</li>
</ul></li>
<li><b>delaycompress</b> : 和 compress 一起使用时，转储的日志文件到下一次转储时才压缩
<ul class="org-ul">
<li>nodelaycompress: 覆盖 delaycompress 选项，转储同时压缩</li>
</ul></li>
<li>errors address: 专储时的错误信息发送到指定的 Email 地址</li>
<li>ifempty: 即使是空文件也转储，此为默认选项
<ul class="org-ul">
<li><b>notifempty</b> : 如果是空文件的话，不转储</li>
</ul></li>
<li>mail address : 把转储的日志文件发送到指定的 E-mail 地址
<ul class="org-ul">
<li>nomail: 转储时不发送日志文件</li>
</ul></li>
<li>olddir directory : 转储后的日志文件放入指定目录，必须和当前日志文件在同一个文件系统
<ul class="org-ul">
<li>noolddir: 转储后的日志文件和当前日志文件放在同一个目录下</li>
</ul></li>
<li><b>prerotate/endscript</b> : 在转储以前需要执行的命令，这两个关键字必须单独成行</li>
<li>postrotate/endscript: 在转储以后需要执行的命令，这两个关键字必须单独成行</li>
<li><b>rotate count</b> :  用来控制保存多少日志文件。以个数为单位的，0 指没有备份，5 指保留 5 个备份</li>
<li>maxage N : 用来控制保存多少日志文件。以天数为单位的</li>
<li>tabooext [+] list : 让logrotate不转储指定扩展名的文件，缺省的扩展名是：.rpm-orig, .rpmsave, v, 和 ~</li>
<li>size size： 当日志文件到达指定的大小时才转储，bytes(缺省)及KB或MB。如 size=50M</li>
<li><b>dateext</b> : 让旧日志文件以创建日期命名，默认为 文件名-%Y%m%d</li>
<li>dateformat 配合dateext使用可以为切割后的日志加上YYYYMMDD格式的日期</li>
<li><p>
<b>sharedscripts</b> ： 在所有的日志文件都轮转完毕后统一执行一次脚本。如果没有配置这条指令，那么每个日志文件轮转完毕后都会执行一次脚本。
</p>

<p>
默认，对每个转储日志运行prerotate和postrotate脚本，
日志文件的绝对路径作为第一个参数传递给脚本。 这意味着单个脚本可以针
对与多个文件匹配的日志文件条目多次运行（例如/ var / log / news
/*.example）。 如果指定此项sharedscripts，则无论有多少个日志与通配符
模式匹配，脚本都只会运行一次
</p>

<ul class="org-ul">
<li>nosharedscripts: 针对每一个转储的日志文件，都执行一次prerotate 和 postrotate脚本，此为默认值</li>
</ul></li>
<li><b>missingok</b> : 如果日志不存在，不提示错误，继续处理下一个
<ul class="org-ul">
<li>nomissingok: 如果日志不存在，提示错误，此为默认值</li>
</ul></li>
</ul>

<p>
<b>命令行</b> ：
</p>
<div class="org-src-container">
<pre class="src src-sh">logrotate -f /etc/logrotate.d/nginx   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#25191;&#34892;</span>
logrotate -d -f /etc/logrotate.d/nginx   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#20570;&#35843;&#35797;&#29992;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:371516e6-c8e5-4f0e-8ec9-87ce60212adc" class="outline-3">
<h3 id="h:371516e6-c8e5-4f0e-8ec9-87ce60212adc">logroate 配置范例</h3>
<div class="outline-text-3" id="text-h:371516e6-c8e5-4f0e-8ec9-87ce60212adc">
</div>
<div id="outline-container-h:39934c3b-e211-4d69-9fad-715cfa9b4ee2" class="outline-4">
<h4 id="h:39934c3b-e211-4d69-9fad-715cfa9b4ee2">范例： 设置nginx的日志转储</h4>
<div class="outline-text-4" id="text-h:39934c3b-e211-4d69-9fad-715cfa9b4ee2">
<div class="org-src-container">
<pre class="src src-sh">cat /etc/logrotate.d/nginx
/var/log/nginx/*.log {
    <span style="color: #b22222;">#</span><span style="color: #b22222;">su root root</span>
    daily
    rotate 5
    missingok
    compress
    <span style="color: #b22222;">#</span><span style="color: #b22222;">size 1M</span>
    delaycompress
    notifempty
    <span style="color: #b22222;">#</span><span style="color: #b22222;">create 644 ngnix nginx</span>
    dateext
    <span style="color: #b22222;">#</span><span style="color: #b22222;">dateformat -%Y%m%d</span>
    copytruncate
    sharedscripts
    postrotate
            <span style="color: #a020f0;">if</span> [ -f /usr/local/nginx/logs/nginx.pid ]; <span style="color: #a020f0;">then</span>
                    <span style="color: #483d8b;">kill</span> -USR1 <span style="color: #ff00ff;">`cat /usr/local/nginx/logs/nginx.pid`</span>
            <span style="color: #a020f0;">fi</span>
    endscript
}
</pre>
</div>

<p>
解释
</p>
<div class="org-src-container">
<pre class="src src-sh">cat &lt;&lt;\EOF &gt;/etc/logrotate.d/nginx
<span style="color: #ffa54f;">/var/log/nginx/*.log {</span>
<span style="color: #ffa54f;">    #su root root</span>
<span style="color: #ffa54f;">    daily                     #&#26085;&#24535;&#25991;&#20214;&#23558;&#25353;&#26085;&#36718;&#24490;</span>
<span style="color: #ffa54f;">    rotate 5                  #&#20445;&#23384;&#25991;&#20214;&#25968;&#65292;0 &#25351;&#27809;&#26377;&#22791;&#20221;</span>
<span style="color: #ffa54f;">    missingok                 #&#22914;&#26524;&#26085;&#24535;&#19981;&#23384;&#22312;&#65292;&#19981;&#25552;&#31034;&#38169;&#35823;&#65292;&#32487;&#32493;&#22788;&#29702;&#19979;&#19968;&#20010;</span>
<span style="color: #ffa54f;">    compress                  #&#22312;&#36718;&#24490;&#20219;&#21153;&#23436;&#25104;&#21518;&#65292;&#24050;&#36718;&#24490;&#30340;&#24402;&#26723;&#23558;&#20351;&#29992;gzip&#36827;&#34892;&#21387;&#32553;</span>
<span style="color: #ffa54f;">    #size 1M                  #&#25991;&#20214;&#21040;&#36798;&#25351;&#23450;&#30340;&#22823;&#23567;&#26102;&#25165;&#36716;&#20648;</span>
<span style="color: #ffa54f;">    delaycompress             #&#21644; compress &#19968;&#36215;&#20351;&#29992;&#26102;&#65292;&#36716;&#20648;&#30340;&#26085;&#24535;&#25991;&#20214;&#21040;&#19979;&#19968;&#27425;&#36716;&#20648;&#26102;&#25165;&#21387;&#32553;</span>
<span style="color: #ffa54f;">    notifempty                # &#22914;&#26524;&#26159;&#31354;&#25991;&#20214;&#30340;&#35805;&#65292;&#19981;&#36716;&#20648;</span>
<span style="color: #ffa54f;">    #create 644 ngnix nginx   #&#36716;&#20648;&#25991;&#20214;&#65292;&#20351;&#29992;&#25351;&#23450;&#30340;&#26435;&#38480;</span>
<span style="color: #ffa54f;">    dateext                   #&#35753;&#26087;&#26085;&#24535;&#25991;&#20214;&#20197;&#21019;&#24314;&#26085;&#26399;&#21629;&#21517;&#65292;&#40664;&#35748;&#20026; &#25991;&#20214;&#21517;-%Y%m%d</span>
<span style="color: #ffa54f;">    #dateformat -%Y%m%d       #&#37197;&#21512;dateext&#20351;&#29992;</span>
<span style="color: #ffa54f;">    copytruncate              #&#29992;&#20110;&#36824;&#22312;&#25171;&#24320;&#20013;&#30340;&#26085;&#24535;&#25991;&#20214;&#65292;&#25226;&#24403;&#21069;&#26085;&#24535;&#22791;&#20221;&#24182;&#25130;&#26029;&#65292;&#25130;&#26029;&#21518;&#25991;&#20214;&#20869;&#23481;&#20026;&#31354;</span>
<span style="color: #ffa54f;">    sharedscripts             #&#22312;&#25152;&#26377;&#30340;&#26085;&#24535;&#25991;&#20214;&#37117;&#36718;&#36716;&#23436;&#27605;&#21518;&#32479;&#19968;&#25191;&#34892;&#19968;&#27425;&#33050;&#26412;&#12290;&#22914;&#26524;&#27809;&#26377;&#37197;&#32622;&#36825;&#26465;&#25351;&#20196;&#65292;&#37027;&#20040;&#27599;&#20010;&#26085;&#24535;&#25991;&#20214;&#36718;&#36716;&#23436;&#27605;&#21518;&#37117;&#20250;&#25191;&#34892;&#19968;&#27425;&#33050;&#26412;</span>
<span style="color: #ffa54f;">    postrotate                #&#22312;&#36716;&#20648;&#20197;&#21518;&#38656;&#35201;&#25191;&#34892;&#30340;&#21629;&#20196;</span>
<span style="color: #ffa54f;">            if [ -f /usr/local/nginx/logs/nginx.pid ]; then</span>
<span style="color: #ffa54f;">                    kill -USR1 `cat /usr/local/nginx/logs/nginx.pid`</span>
<span style="color: #ffa54f;">            fi</span>
<span style="color: #ffa54f;">    endscript</span>
<span style="color: #ffa54f;">}</span>
</pre>
</div>

<p>
报错：
</p>
<pre class="example" id="org8cb8c2f">
It's world writable or writable by group which is not "root
解决：
添加“su root xx”到/etc/logrotate.d/nginx文件中即可
</pre>
</div>
</div>
<div id="outline-container-h:338e211d-f357-4e93-bada-cbd97fc8d601" class="outline-4">
<h4 id="h:338e211d-f357-4e93-bada-cbd97fc8d601">范例：对指定日志手动执行日志转储</h4>
<div class="outline-text-4" id="text-h:338e211d-f357-4e93-bada-cbd97fc8d601">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#27979;&#35797;&#26085;&#24535;</span>
[root@centos8 ~]#dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=/var/log/test1.log <span style="color: #a0522d;">bs</span>=2M <span style="color: #a0522d;">count</span>=1
1+0 records<span style="color: #a020f0;"> in</span>
1+0 records out
2097152 bytes (2.1 MB, 2.0 MiB) copied, 0.00291879 s, 719 MB/s
[root@centos8 ~]#dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=/var/log/test2.log <span style="color: #a0522d;">bs</span>=2M <span style="color: #a0522d;">count</span>=1
1+0 records<span style="color: #a020f0;"> in</span>
1+0 records out
2097152 bytes (2.1 MB, 2.0 MiB) copied, 0.00200561 s, 1.0 GB/s

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38024;&#23545;&#19981;&#21516;&#30340;&#26085;&#24535;&#21019;&#24314;&#36716;&#20648;&#37197;&#32622;&#25991;&#20214;</span>
[root@centos8 ~]#cat /etc/logrotate.d/test1
/var/log/test1.log {
    daily
    rotate 5
    compress
    delaycompress
    missingok
    size 1M
    notifempty
    create 640 bin nobody
    postrotate
<span style="color: #483d8b;">echo</span> <span style="color: #ff00ff;">`date +%F_%T`</span> &gt;&gt; /data/test1.log
    endscript
}
[root@centos8 ~]#cat /etc/logrotate.d/test2
/var/log/test2.log {
    daily
    rotate 5
    compress
    delaycompress
    missingok
    size 1M
    notifempty
    create 644 root root
    postrotate
<span style="color: #483d8b;">echo</span> <span style="color: #ff00ff;">`date +%F_%T`</span> &gt;&gt; /data/test2.log
    endscript
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38024;&#23545;&#19968;&#20010;&#27979;&#35797;&#26085;&#24535;&#65292;&#25163;&#21160;&#25191;&#34892;&#26085;&#24535;&#36716;&#20648;</span>
[root@centos8 ~]#logrotate     /etc/logrotate.d/test1     
[root@centos8 ~]#ll /var/log/test*
-rw-r----- 1 root root             0 Dec 14 16:38 /var/log/test1.log
-rw-r--r-- 1 root root 2097152 Dec 14 16:35 /var/log/test1.log.1
-rw-r--r-- 1 root root 2097152 Dec 14 16:36 /var/log/test2.log
[root@centos8 ~]#ls /data
test1.log
[root@centos8 ~]#cat /data/test1.log
2019-11-12_14:00:14
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#25152;&#26377;&#26085;&#24535;&#36827;&#34892;&#25163;&#21160;&#36716;&#20648;</span>
[root@centos8 ~]#logrotate     /etc/logrotate.conf
[root@centos8 ~]#ll /var/log/test*
-rw-r--r-- 1 bin nobody             0 Nov 12 14:00 /var/log/test1.log
-rw-r--r-- 1 root root 2097152 Nov 12 13:59 /var/log/test1.log.1
-rw-r--r-- 1 root root             0 Nov 12 14:01 /var/log/test2.log
-rw-r--r-- 1 root root 2097152 Nov 12 13:59 /var/log/test2.log-20191112
[root@centos8 ~]#ls /data
test1.log test2.log
[root@centos8 ~]#cat /data/test1.log
2019-11-12_14:01:51
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d4e7b3d3-d103-4b21-bfc3-181b24172faa" class="outline-4">
<h4 id="h:d4e7b3d3-d103-4b21-bfc3-181b24172faa">范例： 其它配置</h4>
<div class="outline-text-4" id="text-h:d4e7b3d3-d103-4b21-bfc3-181b24172faa">
<p>
/etc/logrotate_php_nginx.conf
</p>
<pre class="example" id="orgeae284e">
cat /etc/logrotate_php_nginx.conf
 /opt/log/php-fpm/php_errors.log
/opt/log/php-fpm/php-fpm.log
/opt/log/php-fpm/www.log.slow
/opt/log/nginx/nginx_error.log
{
    size 0
    missingok
    rotate 4
    nocompress
    dateext
    dateformat -%Y%m%d
    copytruncate
}

/opt/log/nginx/xxxxx.xxxxxxm
/opt/log/nginx/xxx.xxxx.com
/opt/log/nginx/xxxx.xxx.com
/opt/log/nginx/xxxxxx.xxxxxxxxxx.com
/opt/log/nginx/xxxx.xxxxxxx.com
/opt/log/nginx/xxxxx.xxxxxx.com
/opt/log/nginx/x.xxxxxx.com
/opt/log/nginx/xxxxxx.xxxxxxx.com
{
    size 0
    missingok
    rotate 4
    nocompress
    dateext
    dateformat -%Y%m%d
    copytruncate
}

# 每天23:59执行一次特定的logrorate操作
59 23 * * * root sh /usr/sbin/logrotate /etc/logrotate_php_nginx.conf &gt; /dev/null 2&gt;&amp;1
</pre>

<p>
rabbitmq
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@zhk-iot-rabbitmq002 rabbitmq]# cat  /etc/logrotate.d/rabbitmq-server
/var/log/rabbitmq/*.log {
        weekly
        missingok
        rotate 20
        compress
        notifempty
}
/data/log/rabbitmq/*.log
{
        su root public
        daily
        missingok
        rotate 20
        compress
        notifempty
        dateext
        copytruncate
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;&#65306;</span>
[root@zhk-iot-rabbitmq002 rabbitmq]# /usr/sbin/logrotate -f /etc/logrotate.d/rabbitmq-server
</pre>
</div>


<p>
httpd
</p>
<div class="org-src-container">
<pre class="src src-nil">/alidata/logs/httpd/*.log
/var/log/httpd/*log {
    daily
    missingok
    compress
    delaycompress
    rotate 5
    notifempty
    dateext
    copytruncate
    sharedscripts
    postrotate
        /sbin/service httpd reload &gt; /dev/null 2&gt;/dev/null || true
    endscript
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:5517551d-1ea8-499d-8ad1-0972e93c9c1b" class="outline-3">
<h3 id="h:5517551d-1ea8-499d-8ad1-0972e93c9c1b">为什么生成日志的时间是凌晨四五点？</h3>
<div class="outline-text-3" id="text-h:5517551d-1ea8-499d-8ad1-0972e93c9c1b">
<p>
Logrotate是基于CRON运行的，所以这个时间是由CRON控制的，具体可以查询CRON的配置文件/etc/anacrontab，过往的老版本的文件为（/etc/crontab），可以手动改成如23:59等时间执行：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">cat /etc/anacrontab </span>
<span style="color: #a0522d;">SHELL</span>=/bin/sh
<span style="color: #a0522d;">PATH</span>=/sbin:/bin:/usr/sbin:/usr/bin
<span style="color: #a0522d;">MAILTO</span>=root
<span style="color: #b22222;"># </span><span style="color: #b22222;">the maximal random delay added to the base delay of the jobs</span>
<span style="color: #a0522d;">RANDOM_DELAY</span>=45
<span style="color: #b22222;"># </span><span style="color: #b22222;">the jobs will be started during the following hours only</span>
<span style="color: #a0522d;">START_HOURS_RANGE</span>=3-22

<span style="color: #b22222;">#</span><span style="color: #b22222;">period in days   delay in minutes   job-identifier   command</span>
1       5       cron.daily              nice run-parts /etc/cron.daily
7       25      cron.weekly             nice run-parts /etc/cron.weekly
@monthly 45     cron.monthly            nice run-parts /etc/cron.monthly


mv /etc/anacrontab /etc/anacrontab.bak          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#28040;&#26085;&#24535;&#33258;&#21160;&#36718;&#36716;&#30340;&#35774;&#32622;</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;crontab&#26469;&#20316;&#20026;&#26085;&#24535;&#36718;&#36716;&#30340;&#35302;&#21457;&#23481;&#22120;&#26469;&#20462;&#25913;Logrotate&#40664;&#35748;&#25191;&#34892;&#26102;&#38388;</span>

vi /etc/crontab
<span style="color: #a0522d;">SHELL</span>=/bin/bash
<span style="color: #a0522d;">PATH</span>=/sbin:/bin:/usr/sbin:/usr/bin
<span style="color: #a0522d;">MAILTO</span>=root
<span style="color: #a0522d;">HOME</span>=/

<span style="color: #b22222;"># </span><span style="color: #b22222;">run-parts</span>
01 * * * * root run-parts /etc/cron.hourly
59 23 * * * root run-parts /etc/cron.daily
22 4 * * 0 root run-parts /etc/cron.weekly
42 4 1 * * root run-parts /etc/cron.monthly
</pre>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
