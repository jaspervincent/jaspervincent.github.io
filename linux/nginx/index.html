<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: 企业级高性能 WEB 服务 Nginx</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux: 企业级高性能 WEB 服务 Nginx</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:ab290402-91c0-43d2-8cae-642710cda001">Web服务基础介绍：</a>
<ul>
<li><a href="#h:22faf0fb-c8c8-40c2-ab77-428b767919ab">Web服务介绍：</a>
<ul>
<li><a href="#h:e7c2c058-440f-4ed9-8d74-51c449faae72">互联网发展历程回顾：</a></li>
<li><a href="#h:1c58fa66-b584-44ac-abc2-ea56b414fcc8">web服务介绍：</a>
<ul>
<li><a href="#h:856efdff-33be-4a38-9d28-66c65713da8d">Apace-早期的web服务端：</a></li>
</ul>
</li>
<li><a href="#h:24d3b39f-1e16-430e-a4ab-e8a4ee0123c0">Nginx-高性能的web服务端</a></li>
<li><a href="#h:91811374-e2f5-409a-b82a-5ad62c221998">用户访问体验统计</a></li>
<li><a href="#h:eebd27fd-f0f9-46bc-8e21-91c1b0d8e5ed">影响用户体验的几个因素：</a>
<ul>
<li><a href="#h:4245714e-0e5f-4f84-9ca3-3d3681aa9d4f">应用程序工作模式：</a></li>
</ul>
</li>
<li><a href="#h:9a428450-f85b-42e1-ab4c-e41ab38950b3">服务端I/O：</a>
<ul>
<li><a href="#h:d16b7474-f628-422a-a147-0190fae96070">磁盘 I/O</a></li>
<li><a href="#h:020f0a86-2032-4f59-8384-37d017db8cff">网络 I/O</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:6c99be19-efe9-424a-af42-1d36aa15eafd">系统 I/O 模型：</a>
<ul>
<li><a href="#h:ed251700-316a-456c-a7c0-040fa97138a6">I/O 模型相关概念</a>
<ul>
<li><a href="#h:f91c4b62-9c5d-40cd-93b0-52e9a7aa0729">同步/ 异步</a></li>
<li><a href="#h:739651ef-5c28-4e27-84cf-a2397ff77e24">阻塞 / 非阻塞：</a></li>
</ul>
</li>
<li><a href="#h:f2692b63-acce-4c0c-a724-f13712933ca9">系统IO模型组合（面试题）</a></li>
</ul>
</li>
<li><a href="#h:206e9739-5fd4-4c27-b3af-660baecadd80">网络I/O模型（了解）</a>
<ul>
<li><a href="#h:acc4fa8d-12d8-43c3-938b-0704d1831a04">同步阻塞型IO模型（blocking IO）：</a></li>
<li><a href="#h:e69a4ef2-a5eb-432a-8fbe-7f0b5067ed3d">非阻塞型I/O模型(nonblocking IO)：</a></li>
<li><a href="#h:b4d434e4-2b9f-4dfc-94d7-76e5a0d20104">IO多路复用型(IO multiplexing)：</a></li>
<li><a href="#h:ae1fb3c8-5c5d-4be5-9b52-39d515391a9a">信号驱动式IO(signal-driven IO):</a></li>
<li><a href="#h:0a078895-85e9-4e2f-82d1-a308ebf3fc6e">异步(非阻塞) IO(asynchronous IO)：</a></li>
<li><a href="#h:acf6f993-8cdc-4949-95a1-e9023e910dcd">IO对比：</a></li>
<li><a href="#h:728d2f79-97aa-4b95-946d-8429963fc168">实现方式：</a></li>
<li><a href="#h:226230f1-20f9-4e66-9275-7ee7c75cca71">常用模型通知对比</a></li>
</ul>
</li>
<li><a href="#h:e25745a6-8894-44e0-a3f1-43090998bb5f">零拷贝</a>
<ul>
<li><a href="#h:dfab4a36-bb7d-4b43-9560-88032d5d4ae3">零拷贝介绍</a></li>
<li><a href="#h:9eb1abb0-e776-4aed-a7af-0d64a61f65ce">MMAP：</a></li>
<li><a href="#h:5ccefeb7-0f30-4bf7-ab25-fbd17dc0e873">SENDFILE</a></li>
<li><a href="#h:24ac749d-1da5-499f-a53e-4a3925a402f8">DMA 辅助的 SENDFILE</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:045436e1-b9db-47d7-a8e5-efa2eb1cc339">Nginx基础</a>
<ul>
<li><a href="#h:15f64e4e-ea44-47ed-a0c5-5bdaf88304f6">Nginx功能介绍</a>
<ul>
<li><a href="#h:6997f367-9948-44ee-a910-c512c55ed9de">基础特性</a></li>
<li><a href="#h:01321bc6-f37a-4412-a037-dbaa4db62764">和web服务相关的功能</a></li>
</ul>
</li>
<li><a href="#h:65ae0145-e6bb-4cf5-a07e-f15d3dbdd023">Nginx组织结构</a>
<ul>
<li><a href="#h:037abfc5-1800-410a-b5cb-ea657cd93763">进程间通信：</a></li>
</ul>
</li>
<li><a href="#h:85ab7b14-c266-409a-b55f-4a40aa2c0fb8">Nginx模块介绍：</a></li>
<li><a href="#h:dad3dc98-59bd-4a9f-86a3-24a35d0e5c91">Nginx安装</a>
<ul>
<li><a href="#h:874d6252-cb06-4c86-b8ab-beec87ebd5e9">Nginx yum安装</a>
<ul>
<li><a href="#h:4348e83b-6f45-4230-a140-02421c6eb306">检查安装：</a></li>
<li><a href="#h:592a5e1d-0928-4e7c-862a-ee4043b2f124">查看帮助</a></li>
<li><a href="#h:8f5bfe66-cb1e-48fe-922d-502ca8efcfb5">验证Nginx</a></li>
<li><a href="#h:3e9fdb79-0feb-40fd-b240-dee746cb890a">Nginx启动脚本</a></li>
<li><a href="#h:81b67c9b-00cc-4a88-be3e-19aea8063665">Nginx 配置文件</a></li>
<li><a href="#h:53d46186-e8aa-4c0a-9712-47868950341d">启动Nginx</a></li>
</ul>
</li>
<li><a href="#h:cad80b4e-83ca-4970-9b71-26431b69b9d1">Nginx 编译安装</a>
<ul>
<li><a href="#h:08af95d0-26dd-4425-9a38-eeee42f06426">验证版本及编译参数</a></li>
<li><a href="#h:5993c581-5c8a-45b7-a4bb-a4dfe2c041ad">访问编译安装的nginx web界面</a></li>
<li><a href="#h:a50c6295-fbab-482f-9940-34f606a104bc">创建Nginx自启动脚本</a></li>
<li><a href="#h:434b6c07-65fa-4747-9cec-ed957f806132">验证Nginx自启动脚本</a></li>
</ul>
</li>
<li><a href="#h:4a1fd69f-6a41-4f8e-bfb5-5c84f5a58887">logrotate日志切割</a></li>
<li><a href="#h:fda12d25-e2f2-4fc8-a2be-1377dab1b4a1">Nginx 动态编译</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:eecb8e93-7543-4b00-a10c-afbfb79aa71c">Nginx 核心配置详解</a>
<ul>
<li><a href="#h:d3ded40a-84f9-4a29-911b-63589c0e3fa1">配置文件说明</a></li>
<li><a href="#h:84ddb0d5-3449-48f8-bd22-7606f9c0b252">main 全局配置</a></li>
<li><a href="#h:6918de9f-25ec-450a-9471-aa97ecf1f85b">http配置块</a>
<ul>
<li><a href="#h:47c4b0a6-be8e-4f24-acce-bfa7b2c186a3">MIME</a></li>
<li><a href="#h:e6be0cdf-8f39-41ff-bc2c-9eb0b67e7132">指定响应报文server首部</a></li>
</ul>
</li>
<li><a href="#h:7ee84902-f6f7-4721-ba10-bfaa9efaac92">核心配置示例</a>
<ul>
<li><a href="#h:e5de5f0c-a9a8-4186-ae73-f03ac3657f01">新建一个PC web站点</a></li>
<li><a href="#h:8cdfd448-b932-46fa-932c-50808f74bc3a">新建一个Mobile web站点</a></li>
<li><a href="#h:e770b4d8-1c49-4eb8-946f-e0df620e7550">root与alias：</a></li>
<li><a href="#h:81216047-8fdf-48a3-94d7-896f474e8a86">location的详细使用：</a>
<ul>
<li><a href="#h:f4f13b2c-446f-4e70-a6b2-21bbe93df21e">匹配案例-精确匹配：</a></li>
<li><a href="#h:03a6b529-be32-4c9f-9c53-522ae08150d4">匹配案例-区分大小写：</a></li>
<li><a href="#h:3ff927a8-1e49-4003-a9c7-a0334e817bf9">匹配案例-不区分大小写：</a></li>
<li><a href="#h:68b25332-b977-4c70-9626-630ea3c1c4d8">匹配案例-URI开始</a></li>
<li><a href="#h:634c1c09-7e61-4e51-8d63-8007007d10fb">匹配案例-文件名后缀</a></li>
<li><a href="#h:df02baf6-22d4-430b-a190-f097a226eb17">匹配案例-优先级</a></li>
<li><a href="#h:d1eee309-eaa0-4fc9-bddb-51bcf7cf75b9">生产使用案例</a></li>
</ul>
</li>
<li><a href="#h:85ae72af-c184-41a6-a542-36760c7bc63d">Nginx 四层访问控制：</a></li>
<li><a href="#h:b72ad7d0-12f4-4fb3-920b-190031cec85e">Nginx账户认证功能</a></li>
<li><a href="#h:476ab1eb-266f-44c0-95e2-19b7831a7efa">自定义错误页面</a></li>
<li><a href="#h:9404cb96-5761-4608-be5c-3e18df5d7e25">自定义错误日志</a></li>
<li><a href="#h:c2671a5e-5c5a-4fe4-a581-7316afadfcbb">检测文件是否存在：</a></li>
<li><a href="#h:b1082614-98f2-4459-9fdf-31d3b1f1e1d7">长连接配置：</a></li>
<li><a href="#h:4ae9f87a-770e-4e79-ba79-9feb9134cd69">作为下载服务器配置</a></li>
<li><a href="#h:df8ca21d-5327-405e-8859-fb1051420240">作为上传服务器</a></li>
<li><a href="#h:119fe662-2f6f-445b-acb4-294696f38859">其他配置</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:cae735c8-333b-4098-a3c2-a77af313330b">Nginx 高级配置</a>
<ul>
<li><a href="#h:ac259e01-e4c4-44d4-ba08-8864a3b9151b">Nginx 状态页</a></li>
<li><a href="#h:0895e0f5-fe94-4556-b42b-85768aa1af04">Nginx 第三方模块：</a></li>
<li><a href="#h:fb610378-0a6a-4528-9c13-e37f856fa943">Nginx 变量使用</a>
<ul>
<li><a href="#h:98e9b92c-23e1-4424-891e-30c030a6c9b3">内置变量</a>
<ul>
<li><a href="#h:1841cebc-beea-4229-87c9-b31221bd360d">常用内置变量</a></li>
</ul>
</li>
<li><a href="#h:64d56e6b-c96b-4076-9420-e6157de11940">自定义变量：</a></li>
</ul>
</li>
<li><a href="#h:4d903945-ed04-4c51-b494-260b307b5370">Nginx 自定义访问日志</a>
<ul>
<li><a href="#h:814aa8ea-80ac-4331-8e51-b6cda6d89951">自定义默认格式日志</a></li>
<li><a href="#h:897b8797-79a3-4d4d-8ea4-f03e1ef62c3c">自定义json格式日志</a></li>
<li><a href="#h:34870be8-ad59-4fa2-b430-7f135a04fb0b">json格式的日志访问统计</a></li>
</ul>
</li>
<li><a href="#h:ff9c3600-5118-44d7-99fe-b62481ebed8a">Nginx 压缩功能</a>
<ul>
<li><a href="#h:89caca11-9eed-4f50-be65-93483ef24b6c">浏览器解压 Content-Encoding: gzip 的原理</a></li>
<li><a href="#h:f146237b-9afa-4664-85f5-44a4bfdc897e">http_gzip_static_module 预压缩</a></li>
</ul>
</li>
<li><a href="#h:112ce992-2335-4d44-b54f-ca3af13868ed">https 功能</a>
<ul>
<li><a href="#h:19764159-9cb5-46c8-b5b1-40d0cf4b3520">https 配置参数：</a></li>
<li><a href="#h:12b17bc1-9fd4-40a5-9b7c-7c62c28b3de1">自签名证书</a></li>
<li><a href="#h:196780e6-be8d-4b5d-a292-3ad60f8d98b6">https 配置</a></li>
<li><a href="#h:158b808e-b617-4586-9a97-58805cb8ced0">实现多域名HTTPS</a></li>
</ul>
</li>
<li><a href="#h:36c7a269-e84b-4ef0-95a1-8d4138fee973">关于favicon.ico：</a></li>
<li><a href="#h:eb961f52-d3d3-4d9c-8e7f-23cdc715f9b3">安全选项</a>
<ul>
<li><a href="#h:18227715-bea2-40e9-9637-5042de3e4578">隐藏Nginx版本号</a></li>
<li><a href="#h:95532596-c4df-4d85-ae29-0581ae4cc4fb">升级OpenSSL版本</a></li>
<li><a href="#h:7e6a39bf-4b76-4ff8-b265-bb62f22e9716">实现 HSTS</a></li>
</ul>
</li>
<li><a href="#h:3fd5310e-4208-402d-aef2-338f1c9de841">其他</a>
<ul>
<li><a href="#h:c195092a-26f3-4cda-a2ef-02c83489920b">自动刷新 Dns 缓存</a></li>
<li><a href="#h:d32f7d0c-4494-4dca-85f0-fce109502f1d">nginx开启IPV6支持配置</a></li>
<li><a href="#h:20d0a987-a3d7-4323-905c-6f94327c8367">nginx添加自定义header</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:5d66ab35-95d5-4805-89da-2aab8fd24a6a">Nginx Rewrite相关功能：</a>
<ul>
<li><a href="#h:c714cf32-8cb2-4ff2-8567-6b40d815dc20">ngx_http_rewrite_module模块指令</a>
<ul>
<li><a href="#h:7597d831-4612-4090-8546-07937a148f21">if指令</a></li>
<li><a href="#h:2a488004-5f90-401b-8770-7afd4dd839bd">set指令</a></li>
<li><a href="#h:350e9919-503e-4cff-8f4c-c9f317a76b35">break 指令：</a></li>
<li><a href="#h:5c65a8b8-788e-4de8-bc62-7886a95b20c2">return 指令</a></li>
<li><a href="#h:1da87f2c-b0f5-4634-b13d-f43d036552ae">rewrite_log 指令：</a></li>
</ul>
</li>
<li><a href="#h:ac2f0694-206b-4681-9aea-0f85d4af23f9">rewrite 指令：</a>
<ul>
<li><a href="#h:b62a6305-cd9b-4475-a974-b7fc8bfc461f">rewrite flag使用介绍</a></li>
<li><a href="#h:e4691f27-d431-4884-9c69-4806f03c357c">rewrite案例-域名永久与临时重定向</a>
<ul>
<li><a href="#h:bb381b92-7c7a-4592-9f02-a43c0a564e67">永久重定向301</a></li>
<li><a href="#h:c82b48ec-b14f-43a0-b45b-df668ea41e2b">临时重定向302</a></li>
</ul>
</li>
<li><a href="#h:c7b6d77f-bc95-4382-9ba9-dadcf3785017">rewrite案例 break 与 last</a>
<ul>
<li><a href="#h:4838a0ae-87c3-4966-b225-c3e4c41a8c64">break案例</a></li>
<li><a href="#h:eae3dd9a-97b6-413b-a4c7-23ed8690456b">last案例</a></li>
</ul>
</li>
<li><a href="#h:bdbd6f1b-2c7d-481b-9fb9-2f1ecf6083a0">rewrite案例-自动跳转https</a></li>
<li><a href="#h:a6401ec0-ac7e-4f38-a558-4a0a1e4b6d9a">rewrite案例-判断文件是否存在</a></li>
<li><a href="#h:1e52a22e-8000-4fb8-8a5b-9b65afca8a58">其他案例</a></li>
</ul>
</li>
<li><a href="#h:6088b6db-9acf-4e56-800d-35689b7af3af">Nginx防盗链</a>
<ul>
<li><a href="#h:b92d4da8-5b89-4beb-b1f6-2252ad07a35b">实现 web 盗链：</a></li>
<li><a href="#h:fa70fad4-639e-4a1d-b918-24a8d32af77f">实现防盗链：</a></li>
</ul>
</li>
<li><a href="#h:6c67cdd3-4059-48cd-a6d5-7c1cbd6370f4">map</a>
<ul>
<li><a href="#h:3e1cd333-5b32-4fb4-89ca-1aa776503f6f">流量切分</a></li>
</ul>
</li>
<li><a href="#h:3d090a91-90c4-4eb1-bddd-f18ca75f580f">限制</a>
<ul>
<li><a href="#h:05ae535f-d1ab-4cd0-af62-991d232d8e10">限制连接数ngx_http_limit_conn_module模块</a></li>
<li><a href="#h:1e6fdd99-552f-46bd-b651-659e72828ecb">限制请求数ngx_http_limit_req_module模块</a></li>
</ul>
</li>
<li><a href="#h:2398cc33-50cd-4173-b559-b94b63e1a12b">GeoIP2</a></li>
</ul>
</li>
<li><a href="#h:85299e20-35b4-4bd7-b6d4-1e9bb2b82d66">Nginx 反向代理功能</a>
<ul>
<li><a href="#h:1e475581-9550-4dc5-abee-3e39e7140037">实现 http 反向代理</a>
<ul>
<li><a href="#h:eac25681-d925-43d5-bbf5-1c040bae9088">部署后端 Apache服务器</a></li>
<li><a href="#h:8dcefee1-d244-4eda-b855-ab05d6c34986">Nginx http 反向代理入门</a>
<ul>
<li><a href="#h:f9d81907-bb3b-487e-91de-7256ce9c6d76">反向代理配置参数</a></li>
<li><a href="#h:7da7d488-a5d8-4098-9059-be556d099d43">反向代理单台web服务器</a></li>
<li><a href="#h:de02006d-69f2-4ad8-bcd1-6e693ca36169">反向代理示例&#x2013;指定location</a></li>
<li><a href="#h:383aaa36-a3e1-42f2-a2d2-7157b914a44a">反向代理示例-缓存功能</a></li>
<li><a href="#h:8774330c-81f3-4655-be18-63809e6bc779">添加头部报文信息</a></li>
</ul>
</li>
<li><a href="#h:7a2a0dbb-a6bd-485d-89a7-180ee2629933">Nginx http 反向代理高级应用</a>
<ul>
<li><a href="#h:69f3d6c6-d03d-4ec9-a932-305b2e2ee1a9">http upstream配置参数</a></li>
<li><a href="#h:781653bd-f432-4f02-885c-155555928dd3">反向代理示例-多台web服务器</a></li>
<li><a href="#h:b6a1d65e-dca7-4b69-8399-4a88fc24be7a">反向代理示例 - 客户端 IP 透传</a></li>
<li><a href="#h:a8cea549-4e34-4925-addd-23d9cf963c3c">实战案例: 基于Cookie 实现会话绑定</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:6e6a0587-1333-4931-984e-c9c56b0f4334">实现Nginx tcp负载均衡</a>
<ul>
<li><a href="#h:70762eb1-dfce-442f-95a5-de9a50b25b5e">tcp负载均衡配置参数</a></li>
<li><a href="#h:d1427c5a-5692-4338-b6b2-d842556ec475">负载均衡实例-Redis</a></li>
<li><a href="#h:0f9244c4-1dec-4b58-8ca7-4e012d9d5fa1">负载均衡实例：MySQL</a></li>
</ul>
</li>
<li><a href="#h:f1471e84-326c-496b-8825-cf548cc60593">实现FastCGI</a>
<ul>
<li><a href="#h:bc4620bb-4d0e-4257-a757-30c4e20138bc">FastCGI 配置指令</a></li>
<li><a href="#h:28e793f3-6cc6-48a6-b57a-d37bf3ef7ceb">FastCGI示例&#x2013;Nginx与php-fpm在同一服务器</a>
<ul>
<li><a href="#h:6f23ca40-b118-4ef7-bf3b-193b5e27ccb5">php环境准备</a></li>
<li><a href="#h:274650b3-3111-4c33-a562-30c7ff618bfe">php相关配置优化</a></li>
<li><a href="#h:c7b7c1b4-6c7a-4aba-b07f-6554ef7197c1">准备php测试页面</a></li>
<li><a href="#h:b5b4e5d2-c4bb-4aba-a278-6aef8b8072dc">Nginx配置转发</a></li>
<li><a href="#h:207314d5-6b88-4447-af19-98a31e29be63">访问验证php测试页</a></li>
<li><a href="#h:1515df1d-63e0-4b13-b917-98d9be8e38da">php-fpm 的运行状态页面</a></li>
</ul>
</li>
<li><a href="#h:2117b09c-df2a-4d80-9df7-6addd73d622b">FastCGI示例&#x2013;Nginx与php不在同一个服务器</a>
<ul>
<li><a href="#h:5c765d92-8180-4b98-8658-772a97c940e6">yum安装较新版本php-fpm</a></li>
<li><a href="#h:67f2b7d3-e423-415a-b514-3b4c8d6b3cb9">修改php-fpm监听配置</a></li>
<li><a href="#h:ec429cb7-92ea-4b34-92ce-2a982d0fd336">准备php测试页面</a></li>
<li><a href="#h:fc12ec5a-b4ec-4c0d-81af-31b9f3aaa6c1">启动并验证php-fpm</a></li>
<li><a href="#h:79251e84-ccf1-45ea-9270-74f9ff7b862b">Nginx配置转发</a></li>
<li><a href="#h:e00a769b-25f1-478d-be07-d878f0fcf0be">访问验证php测试页面：</a></li>
</ul>
</li>
<li><a href="#h:9e593c84-bd1a-4d6b-9855-cae40d477a7c">http 499 问题</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:2c2e09a8-34c6-4049-85d7-9fd1871e3b17">nginx 二次开发版本</a>
<ul>
<li><a href="#h:84d041c9-6d19-4144-8150-eba4e7d49cdc">Tengine</a>
<ul>
<li><a href="#h:38443cb0-6929-4713-b5ca-ee07cc91dc85">动态模块</a></li>
<li><a href="#h:a8af020d-67bb-4a39-8c81-b27ad2500534">concat模块使用：</a></li>
<li><a href="#h:8d1d8882-e696-4f35-92cc-73458cdad99f">tengine配置文件：</a></li>
<li><a href="#h:c6f9bfee-967f-4ae2-b8b5-c9a5e57ba5fe">基于tengine的wordpress站点：</a></li>
</ul>
</li>
<li><a href="#h:dc6abc4d-3218-4d4b-aeec-d225452fbe31">openresty</a></li>
</ul>
</li>
<li><a href="#h:83fa6e46-73b0-441d-b602-8b13a50ebc21">系统参数优化</a>
<ul>
<li><a href="#h:f0a8a954-351a-46c4-a462-fac12e4b95e7">系统参数优化</a>
<ul>
<li><a href="#h:7797ab78-8e94-4db6-aee3-767396b3804e">优化内核参数</a></li>
<li><a href="#h:a57d4036-383e-4c29-962f-0cd2dc2871d7">PAM 资源限制优化</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:6896d5f9-97e9-4b64-86e6-a9da0a008eb9">LNMP项目实战-WordPress站点搭建</a>
<ul>
<li><a href="#h:67f7d4e1-4767-4806-bd44-a16c00e7895c">部署数据库</a>
<ul>
<li><a href="#h:2dcdb361-6a38-47b1-a7a9-14af5aba799a">二进制部署MySQL数据库</a></li>
<li><a href="#h:919ad4ec-4562-44ed-ad52-fd909361a423">创建wordpress数据库和用户并授权</a></li>
<li><a href="#h:769ccb60-b242-4c96-b24e-260a434de0e9">验证MySQL账户权限</a></li>
</ul>
</li>
<li><a href="#h:34c31985-d1a7-405e-aa7f-b07a3846445b">部署PHP</a>
<ul>
<li><a href="#h:d2c33054-64dc-41ff-b906-268ef2f77066">编译安装 php</a></li>
<li><a href="#h:a4f06cc2-eead-4bc6-a478-95388f89a392">准备PHP配置文件</a></li>
<li><a href="#h:1a7f8271-3e08-4247-9de9-82da796a7319">启动并验证 php-fpm服务</a></li>
</ul>
</li>
<li><a href="#h:b67b15ba-2005-4dbf-8685-c5bede3e14a7">部署 Nginx</a>
<ul>
<li><a href="#h:69b737df-51aa-4eb1-bfed-0713e6c80863">编译安装 nginx</a></li>
<li><a href="#h:dc4e8643-f0d8-4d56-a58c-ce9a34623894">准备服务文件并启动 nginx</a></li>
<li><a href="#h:e368bcf7-5962-448e-91f0-f7e624df87ea">配置 Nginx 支持 fastcgi</a></li>
<li><a href="#h:bf87e09e-96c2-4b12-b2d1-ae28a009a33c">准备 php 测试页</a></li>
</ul>
</li>
<li><a href="#h:12c826a7-31d7-4e69-8e09-3864d5f77f51">部署 WordPress</a>
<ul>
<li><a href="#h:40328399-4acd-4293-a0d3-2c2384548fba">准备 WordPress 文件</a></li>
<li><a href="#h:329b81d3-01a2-4c51-904d-c955d5801ddb">web页面</a></li>
<li><a href="#h:75e61be1-6e58-44e8-8680-4ccd78f7a6c7">配置允许上传大文件</a></li>
<li><a href="#h:c663a750-ecd3-4683-95f5-8f262abe9dee">安全加固</a></li>
<li><a href="#h:30736de7-f4f3-41ae-8e8e-b8d72affd233">配置 php 开启 opcache 加速</a></li>
</ul>
</li>
<li><a href="#h:4aa9f61f-02e4-44e9-9859-7b5b5f46e3c6">PHP 扩展session模块支持redis</a>
<ul>
<li><a href="#h:09a22fc5-fa1b-4b74-a941-ff93066d2f60">编译安装PHP redis</a></li>
<li><a href="#h:b48b5976-24c4-45f9-a315-6ad365e57308">编辑php配置文件支持redis</a></li>
<li><a href="#h:fc2c7db4-fb8e-4477-bb44-298627bf2a8f">安装和配置 redis 服务</a></li>
<li><a href="#h:988ec383-69a5-43b8-af57-8aacf16f864c">配置 php 支持 redis 保存 session</a></li>
<li><a href="#h:5fa46e0b-4f4b-4965-be2a-9f42f01d1510">准备 php实现 session 的测试页面</a></li>
<li><a href="#h:c5f3a4d4-2ed2-472d-89fe-7de824de83ae">redis 主机验证 session 数据</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../index.html">Linux</a></li>
</ul>
<section id="outline-container-h:ab290402-91c0-43d2-8cae-642710cda001" class="outline-2">
<h2 id="h:ab290402-91c0-43d2-8cae-642710cda001">Web服务基础介绍：</h2>
<div class="outline-text-2" id="text-h:ab290402-91c0-43d2-8cae-642710cda001">
</div>
<div id="outline-container-h:22faf0fb-c8c8-40c2-ab77-428b767919ab" class="outline-3">
<h3 id="h:22faf0fb-c8c8-40c2-ab77-428b767919ab">Web服务介绍：</h3>
<div class="outline-text-3" id="text-h:22faf0fb-c8c8-40c2-ab77-428b767919ab">
</div>
<div id="outline-container-h:e7c2c058-440f-4ed9-8d74-51c449faae72" class="outline-4">
<h4 id="h:e7c2c058-440f-4ed9-8d74-51c449faae72">互联网发展历程回顾：</h4>
<div class="outline-text-4" id="text-h:e7c2c058-440f-4ed9-8d74-51c449faae72">
<p>
1993年3月2日，中国科学院高能物理研究所租用AT&amp;T公司(美国电话电报公司)的国际卫星信道建立的接入美国SLAC国家实验室的64K专线正式开通，成为我国连入Internet的第一根专线。
</p>

<p>
参考链接: <a href="http://www.ihep.cas.cn/kxcb/kpcg/jsywl/201407/t20140714_4156699.html">http://www.ihep.cas.cn/kxcb/kpcg/jsywl/201407/t20140714_4156699.html</a>
</p>

<p>
1995年马云开始创业并推出了一个web网站 <b>中国黄页</b>
</p>

<p>
1999年创建阿里巴巴 <a href="https://www.alibabagroup.com">https://www.alibabagroup.com</a>
</p>

<p>
2003年5月10日创立淘宝网
</p>

<p>
2004年12月，马云创立第三方网上支付平台支付宝（蚂蚁金服旗下，共有蚂蚁金服支付宝、余额宝、招财宝、蚂蚁聚宝、网商银行、蚂蚁花呗、芝麻信用等子业务板块。）
</p>

<p>
2009年开始举办双十一购物狂欢节，以下是历年交易成交额：
</p>

<pre class="example" id="org47bd4aa">
2009年双十一：5000万元；
2010年双十一：9.36亿元；
2011年双十一：33.6亿元；
2012年双十一：191亿元；
2013年双十一：350亿元；
2014年双十一：571亿元；
2015年双十一：912.17亿元；
2016年双十一：1207亿元元；
2017年双十一：1682.69亿元；
2018年双十一：2135亿元；
2019年双十一：2684亿；
。。。。。
</pre>

<p>
2012年1月11日淘宝商城正式更名为“天猫”。
</p>

<p>
2014年9月19日里巴巴集团于纽约证券交易所正式挂牌上市。
</p>
</div>
</div>
<div id="outline-container-h:1c58fa66-b584-44ac-abc2-ea56b414fcc8" class="outline-4">
<h4 id="h:1c58fa66-b584-44ac-abc2-ea56b414fcc8">web服务介绍：</h4>
<div class="outline-text-4" id="text-h:1c58fa66-b584-44ac-abc2-ea56b414fcc8">
<p>
Netcraft公司于1994年底在英国成立，多年来一直致力于互联网市场以及在线安
全方面的咨询服务，其中在国际上最具影响力的当属其针对网站服务器，域名解
析/主机提供商，以及SSL市场所做的客观严谨的分析研究。
</p>

<p>
<a href="https://news.netcraft.com/">https://news.netcraft.com/</a>
</p>
</div>
<div id="outline-container-h:856efdff-33be-4a38-9d28-66c65713da8d" class="outline-5">
<h5 id="h:856efdff-33be-4a38-9d28-66c65713da8d">Apace-早期的web服务端：</h5>
<div class="outline-text-5" id="text-h:856efdff-33be-4a38-9d28-66c65713da8d">
<p>
Apache 起初由美国的伊利诺伊大学香槟分校的国家超级计算机应用中心开发，
目前经历了两大版本分别是1.X和2.X，其可以通过编译安装实现特定的功能，官
方网站 <a href="http://www.apache.org">http://www.apache.org</a>。
</p>

<p>
<b>Apache prefork模型</b> ：
</p>

<p>
预派生模式，有一个主控制进程，然后生成多个子进程，使用select模型，最大
并发1024，每个子进程有一个独立的线程响应用户请求，相对比较占用内存，但
是比较稳定，可以设置最大和最小进程数，是最古老的一种模式，也是最稳定的
模式，适用于访问量不是很大的场景。
</p>

<p>
优点：稳定
</p>

<p>
缺点：大量用户访问慢，占用资源，1024个进程不适用于高并发场景
</p>


<p>
<b>Apache woker 模型</b> ：
</p>

<p>
一种多进程和多线程混合的模型，有一个控制进程，启动多个子进程，每个子进程里面包含固定的线程，使用线程程来处理请求，当线程不够使用的时候会再启动一个新的子进程，然后在进程里面再启动线程处理请求，由于其使用了线程处理请求，因此可以承受更高的并发。
</p>

<p>
优点：相比prefork 占用的内存较少，可以同时处理更多的请求
</p>

<p>
缺点：使用keepalive的长连接方式， <b>某个线程会一直被占据，即使没有传输数据，也需要一直等待到超时才会被释放</b> 。如果过多的线程，被这样占据，也会导致在高并发场景下的无服务线程可用。（该问题在prefork模式下，同样会发生）
</p>


<p>
<b>Apache event模型</b>
</p>

<p>
Apache中最新的模式，2012年发布的apache 2.4.X系列正式支持event模型，属
于事件驱动模型(epoll)，每个进程响应多个请求，在现在版本里的已经是稳定
可用的模式。它和worker模式很像，最大的区别在于，它解决了keepalive场景
下，长期被占用的线程的资源浪费问题（某些线程因为被keepalive，空挂在哪
里等待，中间几乎没有请求过来，甚至等到超时）。event MPM中，会有一个专
门的线程来管理这些keepalive类型的线程，当有真实请求过来的时候，将请求
传递给服务线程，执行完毕后，又允许它释放。这样增强了高并发场景下的请求
处理能力。
</p>

<p>
优点：单线程响应多请求，占据更少的内存，高并发下表现更优秀， <b>会有一个
专门的线程来管理keep-alive类型的线程</b> ，当有真实请求过来的时候，将请求
传递给服务线程，执行完毕后，又允许它释放
</p>

<p>
缺点：没有线程安全控制
</p>
</div>
</div>
</div>
<div id="outline-container-h:24d3b39f-1e16-430e-a4ab-e8a4ee0123c0" class="outline-4">
<h4 id="h:24d3b39f-1e16-430e-a4ab-e8a4ee0123c0">Nginx-高性能的web服务端</h4>
<div class="outline-text-4" id="text-h:24d3b39f-1e16-430e-a4ab-e8a4ee0123c0">
<p>
Nginx是由1994年毕业于俄罗斯国立莫斯科鲍曼科技大学的同学为俄罗斯
rambler.ru公司开发的，开发工作最早从2002年开始，第一次公开发布时间是
2004年10月4日，版本号是0.1.0，官网地址 <a href="https://nginx.org">https://nginx.org</a>
</p>

<p>
Nginx历经十几年的迭代更新（<a href="https://nginx.org/en/CHANGES">https://nginx.org/en/CHANGES</a>），目前功能已
经非常完善且运行稳定，另外Nginx的版本分为开发版、稳定版和过期版，Nginx
以功能丰富著称，即可以作为http服务器，也可以作为反向代理服务器或者邮件
服务器，能够快速的响应静态网页的请求，支持FastCGI/SSL/Virtual Host/URL
Rwrite/Gzip/HTTP Basic Auth/http或者TCP的负载均衡(1.9版本以上且开启
stream模块)等功能，并且支持第三方的功能扩展。
</p>

<p>
为什么使用Nginx：
</p>

<p>
天猫 淘宝 小米 163 京东新浪等一线互联网公司都在用Nginx或者进行二次开发
</p>

<p>
说明：nginx会根据请求的类型进行动静分离，静态的请求交给存储服务器，动态请求交给MySQL
</p>
</div>
</div>
<div id="outline-container-h:91811374-e2f5-409a-b82a-5ad62c221998" class="outline-4">
<h4 id="h:91811374-e2f5-409a-b82a-5ad62c221998">用户访问体验统计</h4>
<div class="outline-text-4" id="text-h:91811374-e2f5-409a-b82a-5ad62c221998">
<p>
互联网存在用户速度体验的1-3-10原则，即1秒最优，1-3秒较优，3~10秒比较慢，
10秒以上用户无法接受。用户放弃一个产品的代价很低，只是换一个URL而已。
</p>

<div class="org-src-container">
<pre class="src src-sh">http://baijiahao.baidu.com/s?<span style="color: #a0522d;">id</span>=1643187950686234006&amp;<span style="color: #a0522d;">wfr</span>=spider&amp;<span style="color: #a0522d;">for</span>=pc <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#25143;&#20307;&#39564;&#30340;&#37325;&#35201;&#24615;</span>
http://www.sohu.com/a/218426004_573333
</pre>
</div>

<p>
全球最大搜索引擎 Google：慢500ms = 20% 将放弃访问。
</p>

<p>
全球最大的电商零售网站 亚马逊：慢100ms = 1% 将放弃交易
</p>

<p>
有很多研究都表明，性能对用户的行为有很大的影响：
</p>

<p>
79%的用户表示不太可能再次打开一个缓慢的网站
</p>

<p>
47%的用户期望网页能在2秒钟以内加载
</p>

<p>
40%的用户表示如果加载时间超过三秒钟，就会放弃这个网站
</p>

<p>
页面加载时间延迟一秒可能导致转换损失7%，页面浏览量减少11%
</p>

<p>
8秒定律：用户访问一个网站时，如果等待网页打开的时间超过8秒，会有超过30%的用户放弃等待
</p>
</div>
</div>
<div id="outline-container-h:eebd27fd-f0f9-46bc-8e21-91c1b0d8e5ed" class="outline-4">
<h4 id="h:eebd27fd-f0f9-46bc-8e21-91c1b0d8e5ed">影响用户体验的几个因素：</h4>
<div class="outline-text-4" id="text-h:eebd27fd-f0f9-46bc-8e21-91c1b0d8e5ed">
<p>
据说马云在刚开始创业在给客户演示时，打开一个网站花了两个多小时。
</p>

<p>
影响用户体验的因素:
</p>

<p>
客户端原因：
</p>

<ul class="org-ul">
<li>客户端硬件配置</li>
<li>客户端网络速率</li>
<li>客户端与服务端距离</li>
</ul>

<p>
服务端原因：
</p>

<ul class="org-ul">
<li>服务端网络速率</li>
<li>服务端硬件配置</li>
<li>服务端架构设计</li>
<li>服务端应用程序工作模式</li>
<li>服务端并发数量</li>
<li>服务端响应文件大小及数量</li>
<li>服务端I/O压力</li>
</ul>
</div>
<div id="outline-container-h:4245714e-0e5f-4f84-9ca3-3d3681aa9d4f" class="outline-5">
<h5 id="h:4245714e-0e5f-4f84-9ca3-3d3681aa9d4f">应用程序工作模式：</h5>
<div class="outline-text-5" id="text-h:4245714e-0e5f-4f84-9ca3-3d3681aa9d4f">
<p>
httpd MPM（Multi-Processing Module，多进程处理模块）模式：
</p>

<ul class="org-ul">
<li>prefork：进程模型，两级结构，主进程master负责生成子进程，每个子进程负责响应一个请求</li>
<li>worker：线程模型，三级结构，主进程master负责生成子进程，每个子进程负责生成多个线程，每个线程响应一个请求</li>
<li>event：线程模型，三级结构,主进程master负责生成子进程，每个子进程生成多个线程，每个线程响应一个请求，但是增加了一个监听线程，用于解决在设置了keep-alived场景下线程的空等待问题。</li>
</ul>

<p>
*Nginx（Master+Worker）模式*：
</p>

<ul class="org-ul">
<li>主进程</li>
<li>工作进程 #直接处理客户的请求</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">Centos 7.x&#30446;&#21069;&#40664;&#35748;&#20026;prefork&#27169;&#24335;&#65292;ubuntu 18.04&#24050;&#32463;&#20351;&#29992;event&#27169;&#24335;</span>
Apache&#32447;&#31243;&#39564;&#35777;&#26041;&#24335;&#65306;
[root@localhost ~]# httpd -V <span style="color: #b22222;">#</span><span style="color: #b22222;">Centos&#31995;&#32479;</span>
AH00558: httpd: Could not reliably determine the server<span style="color: #8b2252;">'s fully qualified domain name,using localhost.localdomain. Set the '</span>ServerName<span style="color: #8b2252;">' directive globally to suppress thismessage</span>
<span style="color: #8b2252;">Server version: Apache/2.4.6 (CentOS)</span>
<span style="color: #8b2252;">Server built:   Aug 8 2019 11:41:18</span>
<span style="color: #8b2252;">Server'</span>s Module Magic Number: 20120211:24
Server loaded:  APR 1.4.8, APR-UTIL 1.5.2
Compiled using: APR 1.4.8, APR-UTIL 1.5.2
Architecture:   64-bit
Server MPM:     prefork <span style="color: #b22222;">#</span><span style="color: #b22222;">MPM&#27169;&#24335;&#20026;prefork</span>
threaded:       no

<span style="color: #b22222;"># </span><span style="color: #b22222;">ps -ef | grep httpd</span>
root   2757 1    0 04:03 ? 00:00:00 /usr/sbin/httpd -DFOREGROUND
apache 2758 2757 0 04:03 ? 00:00:00 /usr/sbin/httpd -DFOREGROUND
apache 2759 2757 0 04:03 ? 00:00:00 /usr/sbin/httpd -DFOREGROUND
apache 2760 2757 0 04:03 ? 00:00:00 /usr/sbin/httpd -DFOREGROUND
apache 2761 2757 0 04:03 ? 00:00:00 /usr/sbin/httpd -DFOREGROUND
apache 2762 2757 0 04:03 ? 00:00:00 /usr/sbin/httpd -DFOREGROUND
root   2786 2369 0 04:13 pts/0 00:00:00 grep --color=auto httpd

<span style="color: #b22222;"># </span><span style="color: #b22222;">cat /proc/2760/status</span>
Name: httpd
State: S (sleeping)
..............
Threads: 1
..............

<span style="color: #b22222;">#</span><span style="color: #b22222;">Ubuntu 18.04.3&#31995;&#32479;&#65306;</span>
root@mq-node1:~# apachectl -V
Server version: Apache/2.4.29 (Ubuntu)
Server built:   2019-09-16T12:58:48
Server<span style="color: #8b2252;">'s Module Magic Number: 20120211:68</span>
<span style="color: #8b2252;">Server loaded:  APR 1.6.3, APR-UTIL 1.6.1</span>
<span style="color: #8b2252;">Compiled using: APR 1.6.3, APR-UTIL 1.6.1</span>
<span style="color: #8b2252;">Architecture:   64-bit</span>
<span style="color: #8b2252;">Server MPM:     event #MPM&#27169;&#24335;&#20026;event</span>
<span style="color: #8b2252;">threaded:       yes (fixed thread count)</span>
<span style="color: #8b2252;">forked:         yes (variable process count)</span>

<span style="color: #8b2252;"># ps -ef | grep apache2</span>
<span style="color: #8b2252;">root     918    1    0 20:08 ?     00:00:00 /usr/sbin/apache2 -k start</span>
<span style="color: #8b2252;">www-data 919    918  0 20:08 ?     00:00:00 /usr/sbin/apache2 -k start</span>
<span style="color: #8b2252;">www-data 920    918  0 20:08 ?     00:00:00 /usr/sbin/apache2 -k start</span>
<span style="color: #8b2252;">root     1202   1172 0 20:12 pts/0 00:00:00 grep --color=auto apache2</span>

<span style="color: #8b2252;"># cat /proc/919/status</span>
<span style="color: #8b2252;">Name: apache2</span>
<span style="color: #8b2252;">Umask: 0022</span>
<span style="color: #8b2252;">State: S (sleeping)</span>
<span style="color: #8b2252;">..............</span>
<span style="color: #8b2252;">Threads: 27</span>
<span style="color: #8b2252;">..............</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:9a428450-f85b-42e1-ab4c-e41ab38950b3" class="outline-4">
<h4 id="h:9a428450-f85b-42e1-ab4c-e41ab38950b3">服务端I/O：</h4>
<div class="outline-text-4" id="text-h:9a428450-f85b-42e1-ab4c-e41ab38950b3">
<p>
I/O在计算机中指Input/Output， IOPS (Input/Output Per Second)即每秒的输
入输出量(或读写次数)，是衡量磁盘性能的主要指标之一。IOPS是指的是在单位
时间内系统能处理的I/O请求数量，一般以每秒处理的I/O请求数量为单位，I/O
请求通常为读或写数据操作请求。
</p>


<p>
一次完整的I/O是 <b>用户空间的进程数据与内核空间的内核数据的报文的完整交
换过程</b> ，但是由于内核空间与用户空间是严格隔离的，所以其数据交换过程中
不能由用户空间的进程直接调用内核空间的内存数据，而是需要经历一次从内核
空间中的内存数据copy到用户空间的进程内存当中，所以简单说 <b>一次 I/O就是
把数据从内核空间中的内存数据复制到用户空间中进程的内存当中的整个过程</b>
。
</p>

<p>
Linux 的 I/O
</p>
<ul class="org-ul">
<li>磁盘 I/O</li>
<li>网络 I/O： 一切皆文件，本质为对 socket 文件的读写</li>
</ul>
</div>
<div id="outline-container-h:d16b7474-f628-422a-a147-0190fae96070" class="outline-5">
<h5 id="h:d16b7474-f628-422a-a147-0190fae96070">磁盘 I/O</h5>
<div class="outline-text-5" id="text-h:d16b7474-f628-422a-a147-0190fae96070">
<p>
磁盘I/O是进程向内核发起系统调用，请求磁盘上的某个资源比如是文件或者是
图片，然后内核通过相应的驱动程序将目标图片加载到内核的内存空间，加载完
成之后把数据从内核内存再复制给进程内存，如果是比较大的数据也需要等待时
间。
</p>

<p>
机械磁盘的寻道时间、旋转延迟和数据传输时间：
</p>

<ul class="org-ul">
<li>寻道时间：是指磁头移动到正确的磁道上所花费的时间，寻道时间越短则I/O
处理就越快，目前磁盘的寻道时间一般在3-15毫秒左右。</li>
<li>旋转延迟：是指将磁盘片旋转到数据所在的扇区到磁头下面所花费的时间，旋
转延迟取决于磁盘的转速，通常使用磁盘旋转一周所需要时间的1/2之一表示，
比如7200转的磁盘平均训传延迟大约为60*1000/7200/2=4.17毫秒，公式的意
思为（每分钟60秒*1000毫秒每秒/7200转每分钟/2），如果是15000转的则为
60*1000/15000/2=2毫秒。</li>
<li>数据传输时间：指的是读取到数据后传输数据的时间，主要取决于传输速率，
这个值等于数据大小除以传输速率，目前的磁盘接口每秒的传输速度可以达到
600MB，因此可以忽略不计。</li>
</ul>

<p>
注意：web服务器千万不要用7200转的机械盘，最低用10000的
</p>

<p>
范例：
</p>

<pre class="example" id="orgeeef058">
常见的机械磁盘平均寻道时间值：
7200转/分的磁盘平均物理寻道时间：9毫秒
10000转/分的磁盘平均物理寻道时间：6毫秒
15000转/分的磁盘平均物理寻道时间：4毫秒

常见磁盘的平均延迟时间：
7200转的机械盘平均延迟：60\*1000/7200/2 = 4.17ms
10000转的机械盘平均延迟：60\*1000/10000/2 = 3ms
15000转的机械盘平均延迟：60\*1000/15000/2 = 2ms

每秒最大IOPS的计算方法：
7200转的磁盘IOPS计算方式：1000毫秒/(9毫秒的寻道时间+4.17毫秒的平均旋转延迟时间)=1000/13.13=75.9 IOPS
10000转的磁盘的IOPS计算方式：1000毫秒/(6毫秒的寻道时间+3毫秒的平均旋转延迟时间)=1000/9=111 IOPS
15000转的磁盘的IOPS计算方式：15000毫秒/(4毫秒的寻道时间+2毫秒的平均旋转延迟时间)=1000/6=166.6 IOPS
</pre>
</div>
</div>
<div id="outline-container-h:020f0a86-2032-4f59-8384-37d017db8cff" class="outline-5">
<h5 id="h:020f0a86-2032-4f59-8384-37d017db8cff">网络 I/O</h5>
<div class="outline-text-5" id="text-h:020f0a86-2032-4f59-8384-37d017db8cff">
<p>
网络通信就是从网络协议栈到用户空间进程的IO，也就是网络IO。
</p>


<figure id="org9e70a91">
<img src="./images/img_20240229_040611.png" alt="img_20240229_040611.png" width="80%">

</figure>


<p>
网络I/O处理过程
</p>
<pre class="example" id="org6aa89c6">
获取请求数据，客户端与服务器建立连接发出请求，服务器接受请求（1-3）
构建响应，当服务器接收完请求，并在用户空间处理客户端的请求，直到构建响应完成（4）
返回数据，服务器将已构建好的响应再通过内核空间的网络 I/O 发还给客户端（5-7）
</pre>

<p>
不论磁盘和网络 I/O:
</p>
<pre class="example" id="orge74539f">
每次IO，都要经由两个阶段：
第一步：将数据从磁盘文件先加载至内核内存空间（缓冲区），此步骤需要等待数据准备完成，时间较长
第二步：将数据从内核缓冲区复制到用户空间的进程的内存中，时间较短
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:6c99be19-efe9-424a-af42-1d36aa15eafd" class="outline-3">
<h3 id="h:6c99be19-efe9-424a-af42-1d36aa15eafd">系统 I/O 模型：</h3>
<div class="outline-text-3" id="text-h:6c99be19-efe9-424a-af42-1d36aa15eafd">
</div>
<div id="outline-container-h:ed251700-316a-456c-a7c0-040fa97138a6" class="outline-4">
<h4 id="h:ed251700-316a-456c-a7c0-040fa97138a6">I/O 模型相关概念</h4>
<div class="outline-text-4" id="text-h:ed251700-316a-456c-a7c0-040fa97138a6">
</div>
<div id="outline-container-h:f91c4b62-9c5d-40cd-93b0-52e9a7aa0729" class="outline-5">
<h5 id="h:f91c4b62-9c5d-40cd-93b0-52e9a7aa0729">同步/ 异步</h5>
<div class="outline-text-5" id="text-h:f91c4b62-9c5d-40cd-93b0-52e9a7aa0729">
<p>
同步/异步：关 注的是事件处理的消息通信机制，即在等待一件事情的处理结果时，被调用者是否提供完成通知。
</p>

<ul class="org-ul">
<li>同步：synchronous，调用者等待被调用者返回消息后才能继续执行，如果被
调用者不提供消息返回则为同步，同步需要调用者主动询问事情是否处理完成。</li>

<li>异步：asynchronous，被调用者通过状态、通知或回调机制主动通知调用者，
即异步会主动返回被调用者的状态给调用者。</li>
</ul>

<p>
说明：被调用者通常是内核，调用者就是web服务（Nginx、PHP）
</p>

<ul class="org-ul">
<li>同步：进程发出请求调用后，内核不提供通知机制，即文件IO处理完成后不通
知进程，需要进程自己去问内核是否处理完成。</li>
<li>异步：进程发出请求调用后，内核会在调用处理完成后返回调用结果给进程,Nginx是异步的。</li>
</ul>


<figure id="org7b7972c">
<img src="./images/img_20240229_040634.png" alt="img_20240229_040634.png" width="80%">

</figure>
</div>
</div>
<div id="outline-container-h:739651ef-5c28-4e27-84cf-a2397ff77e24" class="outline-5">
<h5 id="h:739651ef-5c28-4e27-84cf-a2397ff77e24">阻塞 / 非阻塞：</h5>
<div class="outline-text-5" id="text-h:739651ef-5c28-4e27-84cf-a2397ff77e24">
<p>
阻塞/非阻塞：关注调用者在等待结果返回之前所处的状态
</p>

<ul class="org-ul">
<li>阻塞：blocking，指IO操作需要彻底完成后才返回到用户空间，调用结果返回
之前，调用者被挂起，干不了别的事情。</li>
<li>非阻塞：nonblocking，指IO操作被调用后立即返回给用户一个状态值，无需
等到IO操作彻底完成，最终的调用结果返回之前，调用者不会被挂起，可以去
做别的事情。</li>
</ul>


<figure id="org437c012">
<img src="./images/img_20240229_040652.png" alt="img_20240229_040652.png" width="80%">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:f2692b63-acce-4c0c-a724-f13712933ca9" class="outline-4">
<h4 id="h:f2692b63-acce-4c0c-a724-f13712933ca9">系统IO模型组合（面试题）</h4>
<div class="outline-text-4" id="text-h:f2692b63-acce-4c0c-a724-f13712933ca9">
<p>
以我去吃饭为例：我点了10个包子
</p>

<ul class="org-ul">
<li><p>
同步与异步：
</p>

<p>
我点包子之后厨师是否告诉我：
</p>

<ul class="org-ul">
<li>同步：厨师做好包子后会放到指定位置，但是做好包子之前需要自己一次次去看包子做好没有，厨师不会在包子做好之后通知我。</li>
<li>异步：厨师做好包子后告诉我包子做好放哪了。</li>
</ul></li>

<li><p>
阻塞与非阻塞：：
</p>

<p>
我点包子后的状态：
</p>

<ul class="org-ul">
<li>阻塞：在厨师做包子期间一直在包子盘子前面等着，不能干别的事情。</li>
<li>非阻塞：点完包子就可以去干别的事情，比如去逛逛街或者买买买。</li>
</ul></li>

<li>IO模型组合：

<ul class="org-ul">
<li>同步阻塞：我点完包子后不能去做别的事情，而且不知道包子有没有做好，需要自己一直等着并一次次的问厨师做好没有。</li>
<li>同步非阻塞：点完包子后可以去做别的事情，但是不能长时间做别的事情，因为我还是不知道包子有没有做好，也要自己一直等着并一次次的问厨师做好没有，只能抽空做点别的。</li>
<li>异步阻塞：我点完包子后不能去走做别的事情，但是厨师在做好包子后会告诉我，也就是我不用再一次次为厨师包子有没有做好了。</li>
<li>异步非阻塞：我点完包子后可以做别的事情，而且可以一直在做别的去事情，因为厨师在做好包子后会告诉我。</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:206e9739-5fd4-4c27-b3af-660baecadd80" class="outline-3">
<h3 id="h:206e9739-5fd4-4c27-b3af-660baecadd80">网络I/O模型（了解）</h3>
<div class="outline-text-3" id="text-h:206e9739-5fd4-4c27-b3af-660baecadd80">
<p>
阻塞型、非阻塞型、复用型、信号驱动型、异步
</p>
</div>
<div id="outline-container-h:acc4fa8d-12d8-43c3-938b-0704d1831a04" class="outline-4">
<h4 id="h:acc4fa8d-12d8-43c3-938b-0704d1831a04">同步阻塞型IO模型（blocking IO）：</h4>
<div class="outline-text-4" id="text-h:acc4fa8d-12d8-43c3-938b-0704d1831a04">
<p>
阻塞IO模型是最简单的IO模型，用户线程在内核进行IO操作时被阻塞
</p>

<ul class="org-ul">
<li>用户请求到达系统服务进程，然后进程通过系统调用read向内核发起IO读操作，
即将用户请求由用户空间转到内核空间，内核接收到IO请求后开始从磁盘读取
文件到内核内存，即在等用户请求的文件从磁盘到达内核内存后，然后将接收
的数据拷贝到用户空间，然后完成read操作。</li>

<li>用户请求需要等待内核将数据读取到进程内存后，处理用户的进程才可以继续
处理该请求，整个IO请求的过程中，请求进程是被阻塞的，这导致进程在发起
IO请求时，不能做任何事情，而且对CPU的资源利用率不够。</li>
</ul>

<p>
优点：程序简单，在阻塞等待数据期间进程挂起，基本不会占用 CPU 资源
</p>

<p>
缺点：每个连接需要独立的进程单独处理，当并发请求量大时为了维护程序，内存、进程切换开销较大，apache的preforck使用的是这种模式。
</p>

<p>
<b>同步阻塞</b> ：程序向内核发送IO请求后一直等待内核响应，如果内核处理请求的IO操作不能立即返回,则进程将一直等待并不再接受新的请求，并由进程轮训查看IO是否完成，完成后进程将IO结果返回给Client，在IO没有返回期间进程不能接受其他客户的请求，而且是有进程自己去查看IO是否完成，这种方式简单，但是比较慢，用的比较少。
</p>


<figure id="orgb231ff3">
<img src="./images/img_20240229_040714.png" alt="img_20240229_040714.png" width="80%">

</figure>
</div>
</div>
<div id="outline-container-h:e69a4ef2-a5eb-432a-8fbe-7f0b5067ed3d" class="outline-4">
<h4 id="h:e69a4ef2-a5eb-432a-8fbe-7f0b5067ed3d">非阻塞型I/O模型(nonblocking IO)：</h4>
<div class="outline-text-4" id="text-h:e69a4ef2-a5eb-432a-8fbe-7f0b5067ed3d">
<p>
用户请求进程向内核发起IO请求时立即返回，但并未读取到任何数据，进程需要
不断地发起IO请求，直到数据到达进程空间的内存后，才真正读取到数据并继续
执行，即前期需要一次次"轮询"去查看请求是否数据是否准备报，但是此机制存
在两个问题：
</p>

<ol class="org-ol">
<li>如果有大量文件描述符都要等，那么就得一个一个的read，这会带来大量的
Context Switch（read是系统调用，每调用一次就得在用户态和核心态切换
一次）</li>
<li>轮询的时间不好把握。这里是要猜多久之后数据才能到，等待时间设的太长，
程序响应延迟就过大，但是设的太短，就会造成过于频繁的重试，干耗CPU而
已，所以是比较浪费CPU的方式，因此一般很少直接使用这种模型，而是在
其他IO模型中使用非阻塞IO这一特性。</li>
</ol>

<p>
<b>非阻塞</b> ：应用进程向内核发送请IO求后一直等待内核响应，如果内核处理请求的IO操作不能立即返回IO结果，进程将不再等待，而且继续处理其他请求，但是仍然需要进程隔一段时间就要查看内核IO是否完成。
</p>


<figure id="org8ce3186">
<img src="./images/img_20240229_040734.png" alt="img_20240229_040734.png" width="80%">

</figure>
</div>
</div>
<div id="outline-container-h:b4d434e4-2b9f-4dfc-94d7-76e5a0d20104" class="outline-4">
<h4 id="h:b4d434e4-2b9f-4dfc-94d7-76e5a0d20104">IO多路复用型(IO multiplexing)：</h4>
<div class="outline-text-4" id="text-h:b4d434e4-2b9f-4dfc-94d7-76e5a0d20104">
<p>
IO multiplexing就是我们说的select，poll，epoll，有些地方也称这种IO方式
为event driven IO(事件驱动IO)，select/poll/epoll的好处就在于单个
process就可以同时处理多个网络连接的IO。它的基本原理就是select，poll，
epoll这个function会不断的轮询所负责的所有socket，当某个socket有数据到
达了，就通知用户进程。
</p>

<p>
当用户进程调用了select，那么整个进程会被block，而同时，kernel会“监视”所
有select负责的socket，当任何一个socket中的数据准备好了，select就会返回，
这个时候用户进程再调用read操作，将数据从kernel拷贝到用户进程。
</p>

<p>
<b>Apache prefork是此模式的主进程+多进程/单线程+select，work是主进程+多
进程/多线程+poll模式</b>
</p>

<pre class="example" id="org86ee455">
IO多路复用（IO Multiplexing) ：是一种机制，程序注册一组socket文件描述
符给操作系统，表示“我 要监视这些fd是否有IO事件发生，有了就告诉程序处
理”

IO多路复用一般和NIO一起使用的。NIO和IO多路复用是相对独立的。NIO仅仅是
指IO API总是能立刻返回，不会被Blocking;而IO多路复用仅仅是操作系统提供
的一种便利的通知机制。操作系统并不会强制这俩必须得一起用，可以只用IO多
路复用 + BIO，这时还是当前线程被卡住。IO多路复用和NIO是要配合一起使用
才有实际意义


IO多路复用是指内核一旦发现进程指定的一个或者多个IO条件准备读取，就通知该进程

多个连接共用一个等待机制，本模型会阻塞进程，但是进程是阻塞在select或者
poll这两个系统调用上，而不是阻塞在真正的IO操作上

用户首先将需要进行IO操作添加到select中，同时等待select系统调用返回。当
数据到达时，IO被激活，select函数返回。用户线程正式发起read请求，读取数
据并继续执行

从流程上来看，使用select函数进行IO请求和同步阻塞模型没有太大的区别，甚
至还多了添加监视IO，以及调用select函数的额外操作，效率更差。并且阻塞了
两次，但是第一次阻塞在select上时，select可以监控多个IO上是否已有IO操作
准备就绪，即可达到在同一个线程内同时处理多个IO请求的目的。而不像阻塞IO
那种，一次只能监控一个IO

虽然上述方式允许单线程内处理多个IO请求，但是每个IO请求的过程还是阻塞的
（在select函数上阻塞），平均时间甚至比同步阻塞IO模型还要长。如果用户线
程只是注册自己需要的IO请求，然后去做自己的事情，等到数据到来时再进行处
理，则可以提高CPU的利用率

IO多路复用是最常使用的IO模型，但是其异步程度还不够“彻底”，因它使用了
会阻塞线程的select系统调用。因此IO多路复用只能称为异步阻塞IO模型，而非
真正的异步IO
</pre>

<p>
优缺点
</p>
<ul class="org-ul">
<li>优点：可以基于一个阻塞对象，同时在多个描述符上等待就绪，而不是使用多
个线程(每个文件描述符一个线程)，这样可以大大节省系统资源</li>

<li>缺点：当连接数较少时效率相比多线程+阻塞 I/O 模型效率较低，可能延迟更
大，因为单个连接处j理需要 2 次系统调用，占用时间会有增加</li>
</ul>

<p>
IO多路复用适用如下场合：
</p>
<ul class="org-ul">
<li>当客户端处理多个描述符时（一般是交互式输入和网络套接口），必须使用I/O复用</li>
<li>当一个客户端同时处理多个套接字时，此情况可能的但很少出现</li>
<li>当一个服务器既要处理监听套接字，又要处理已连接套接字，一般也要用到I/O复用</li>
<li>当一个服务器即要处理TCP，又要处理UDP，一般要使用I/O复用</li>
<li>当一个服务器要处理多个服务或多个协议，一般要使用I/O复用</li>
</ul>


<figure id="org5e33f11">
<img src="./images/img_20240229_040756.png" alt="img_20240229_040756.png" width="80%">

</figure>
</div>
</div>
<div id="outline-container-h:ae1fb3c8-5c5d-4be5-9b52-39d515391a9a" class="outline-4">
<h4 id="h:ae1fb3c8-5c5d-4be5-9b52-39d515391a9a">信号驱动式IO(signal-driven IO):</h4>
<div class="outline-text-4" id="text-h:ae1fb3c8-5c5d-4be5-9b52-39d515391a9a">
<p>
信号驱动IO：signal-driven I/O
</p>

<p>
信号驱动I/O的意思就是我们现在不用傻等着了，也不用去轮询。而是让内核在
数据就绪时，发送信号通知我们。
</p>

<p>
调用步骤是，通过系统调用 sigaction ，并注册一个信号处理的回调函数，该
调用会立即返回，然后主程序可以继续向下执行，当有I/O操作准备就绪,即内核
数据就绪时，内核会为该进程产生一个SIGIO 信号，并回调注册的信号回调函数，
这样就可以在信号回调函数中系统调用 recvfrom 获取数据,将用户进程所需要
的数据从内核空间拷贝到用户空间
</p>

<p>
此模型的优势在于等待数据报到达期间进程不被阻塞。用户主程序可以继续执行，
只要等待来自信号处理函数的通知。
</p>

<p>
在信号驱动式 I/O 模型中，应用程序使用套接口进行信号驱动 I/O，并安装一
个信号处理函数，进程继续运行并不阻塞
</p>

<p>
当数据准备好时，进程会收到一个 SIGIO 信号，可以在信号处理函数中调用 I/O 操作函数处理数据。
</p>

<p>
优点：进程没有在等待数据时被阻塞，内核直接返回调用接收信号，不影响进程
继续处理其他请求因此可以提高资源的利用率
</p>

<p>
缺点：信号 I/O 在大量 IO 操作时可能会因为信号队列溢出导致没法通知
</p>

<p>
<b>异步阻塞</b> ：程序进程向内核发送IO调用后，不用等待内核响应，可以继续接
受其他请求，内核收到进程请求后进行的IO如果不能立即返回，就由内核等待结
果，直到IO完成后内核再通知进程，apache event是此模式。
</p>


<figure id="orgeabf377">
<img src="./images/img_20240229_040830.png" alt="img_20240229_040830.png" width="80%">

</figure>
</div>
</div>
<div id="outline-container-h:0a078895-85e9-4e2f-82d1-a308ebf3fc6e" class="outline-4">
<h4 id="h:0a078895-85e9-4e2f-82d1-a308ebf3fc6e">异步(非阻塞) IO(asynchronous IO)：</h4>
<div class="outline-text-4" id="text-h:0a078895-85e9-4e2f-82d1-a308ebf3fc6e">
<p>
异步I/O 与 信号驱动I/O最大区别在于，信号驱动是内核通知我们何时开始一个
I/O操作，而异步I/O是由内核通知我们I/O操作何时完成，两者有本质区别,相当
于不用去饭店场吃饭，直接点个外卖，把等待上菜的时间也给省了
</p>

<p>
相对于同步IO，异步IO不是顺序执行，用户进程进行aio_read系统调用之后，无
论内核数据是否准备好，都会直接返回给用户进程，然后用户态进程可以去做别
的事情，等到socket数据准备好了，内核直接复制数据给进程，然后从内核向进
程发送通知，异步非阻塞IO的两个阶段，进程都是非阻塞的。
</p>

<p>
异步IO与信号驱动IO最主要的区别是信号驱动IO是由内核通知应用程序何时可以
进行IO操作，而异步IO则是由内核告诉用户线程IO操作何时完成。信号驱动IO当
内核通知触发信号处理程序时，信号处理程序还需要阻塞在从内核空间缓冲区拷
贝数据到用户空间缓冲区这个阶段，而异步IO直接是在第二个阶段完成后，内核
直接通知用户线程可以进行后续操作了
</p>

<p>
优点：异步 I/O 能够充分利用 DMA 特性，让 I/O 操作与计算重叠
</p>

<p>
缺点：要实现真正的异步 I/O，操作系统需要做大量的工作。目前 Windows 下
通过 IOCP 实现了真正的异步 I/O，在 Linux 系统下，Linux 2.6才引入，目前
AIO 并不完善，因此在 Linux 下实现高并发网络编程时以 IO 复用模型模式+多
线程任务的架构基本可以满足需求
</p>

<p>
Linux提供了AIO库函数实现异步，但是用的很少，目前有很多开源的异步IO库，
例如libevent、libev、libuv等，异步过程如下图所示：
</p>

<p>
<b>异步非阻塞</b> ：程序进程向内核发送IO调用后，不用等待内核响应，可以继续接受其他请求，内核调用的IO如果不能立即返回，内核会继续处理其他事物，直到IO完成后将结果通知给内核，内核在将IO完成的结果返回给进程，期间进程可以接受新的请求，内核也可以处理新的事物，因此相互不影响，可以实现较大的同时并实现较高的IO复用，因此异步非阻塞使用最多的一种通信方式，nginx就是是异步非阻塞模型
</p>


<figure id="org7998b72">
<img src="./images/img_20240229_040849.png" alt="img_20240229_040849.png" width="80%">

</figure>
</div>
</div>
<div id="outline-container-h:acf6f993-8cdc-4949-95a1-e9023e910dcd" class="outline-4">
<h4 id="h:acf6f993-8cdc-4949-95a1-e9023e910dcd">IO对比：</h4>
<div class="outline-text-4" id="text-h:acf6f993-8cdc-4949-95a1-e9023e910dcd">
<p>
这五种网络 I/O模型中，越往后，阻塞越少，理论上效率也是最优前四种属于同
步I/O，因为其中真正的 I/O 操作(recvfrom)将阻塞进程/线程，只有异步 I/O
模型才与 POSIX 定义的异步 I/O 相匹配。
</p>


<figure id="org43d69fb">
<img src="./images/img_20240229_040902.png" alt="img_20240229_040902.png" width="80%">

</figure>
</div>
</div>
<div id="outline-container-h:728d2f79-97aa-4b95-946d-8429963fc168" class="outline-4">
<h4 id="h:728d2f79-97aa-4b95-946d-8429963fc168">实现方式：</h4>
<div class="outline-text-4" id="text-h:728d2f79-97aa-4b95-946d-8429963fc168">
<p>
Nginx支持在多种不同的操作系统实现不同的事件驱动模型，但是其在不同的操
作系统甚至是不同的系统版本上面的实现方式不尽相同，主要有以下实现方式：
</p>

<ol class="org-ol">
<li><p>
select：（用的较少）
</p>

<p>
select库是在linux和windows平台都基本支持的事件驱动模型库，并且在接
口的定义也基本相同，只是部分参数的含义略有差异，最大并发限制1024，
是最早期的事件驱动模型。
</p></li>

<li><p>
poll :（不推荐使用，降低性能）
</p>

<p>
在Linux的基本驱动模型，windows不支持此驱动模型，是select的升级版，
取消了最大的并发限制，在编译nginx的时候可以使
用&#x2013;with-poll_module和&#x2013;without-poll_module这两个指定是否编译select
库。
</p></li>

<li><p>
epoll：
</p>

<p>
epoll是库是Nginx服务器支持的最高性能的事件驱动库之一，是公认的非常
优秀的事件驱动模型，它和select和poll有很大的区别，epoll是poll的升级
版，但是与poll的效率有很大的区别.
</p>

<p>
epoll的处理方式是创建一个待处理的事件列表，然后把这个列表发给内核，
返回的时候在去轮训检查这个表，以判断事件是否发生，epoll支持一个进程
打开的最大事件描述符的上限是系统可以打开的文件的最大数，同时*epoll
库的IO效率不随描述符数目增加而线性下降*，因为它只会对内核上报的“活
跃”的描述符进行操作。
</p></li>

<li><p>
rtsig：
</p>

<p>
不是一个常用事件驱动，最大队列1024，不是很常用
</p></li>

<li><p>
kqueue
</p>

<p>
用于支持BSD系列平台的高效事件驱动模型，主要用在FreeBSD 4.1及以上版
本、OpenBSD 2.0级以上版本，NetBSD级以上版本及Mac OS X平台上，该模型
也是poll库的变种，因此和epoll没有本质上的区别，都是通过避免轮训操作
提供效率。
</p></li>

<li><p>
/dev/poll:
</p>

<p>
用于支持unix衍生平台的高效事件驱动模型，主要在Solaris平台、HP/UX，
该模型是sun公司在开发Solaris系列
</p>

<p>
平台的时候提出的用于完成事件驱动机制的方案，它使用了虚拟的/dev/poll
设备，开发人员将要见识的文件描述符加入这个设备，然后通过ioctl()调用
来获取事件通知，因此运行在以上系列平台的时候请使用/dev/poll事件驱动
机制。
</p></li>

<li><p>
eventport：
</p>

<p>
该方案也是sun公司在开发Solaris的时候提出的事件驱动库，只是Solaris
10以上的版本，该驱动库看防止内核崩溃等情况的发生。
</p></li>

<li><p>
Iocp：
</p>

<p>
Windows系统上的实现方式，对应第5种（异步I/O）模型。
</p></li>
</ol>
</div>
</div>
<div id="outline-container-h:226230f1-20f9-4e66-9275-7ee7c75cca71" class="outline-4">
<h4 id="h:226230f1-20f9-4e66-9275-7ee7c75cca71">常用模型通知对比</h4>
<div class="outline-text-4" id="text-h:226230f1-20f9-4e66-9275-7ee7c75cca71">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">select</td>
<td class="org-left">poll</td>
<td class="org-left">epoll</td>
</tr>

<tr>
<td class="org-left">操作方式</td>
<td class="org-left">遍历</td>
<td class="org-left">遍历</td>
<td class="org-left">回调</td>
</tr>

<tr>
<td class="org-left">底层实现</td>
<td class="org-left">数组</td>
<td class="org-left">链表</td>
<td class="org-left">哈希表</td>
</tr>

<tr>
<td class="org-left">IO效率</td>
<td class="org-left">每次调用都进行线性遍历，时间复杂度为O(n)</td>
<td class="org-left">同左</td>
<td class="org-left">时间通知方式，每当fd就绪。系统注册的回调函数就会被调用，将就绪fd放到rdllist里面，时间复杂度为O(1)</td>
</tr>

<tr>
<td class="org-left">最大连接数</td>
<td class="org-left">1024(x86)或2048(x64)</td>
<td class="org-left">无上限无上限</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">fd拷贝</td>
<td class="org-left">每次调用select，都需要把fd集合从用户态拷贝到内核态</td>
<td class="org-left">每次调用poll，都需要把fd集合从用户态拷贝到内核态</td>
<td class="org-left">调用epoll_ctl时拷贝进内核并保存，之后每次epoll_wait不拷贝</td>
</tr>
</tbody>
</table>

<p>
说明：
</p>
<ul class="org-ul">
<li>O(1)：表示算法的运行时间为常量，即无论是1000个还是10000个，耗费时间一样</li>
<li>O(n): 表示该算法是线性算法</li>
<li>fd: 表示事件描述符</li>
</ul>


<p>
水平触发&#x2013;多次通知，需要关心数据是否取完，即数据取走之后即不再通知进程，
以避免重复多次无效通知，通知效率较低。
</p>

<p>
边缘触发&#x2013;一次通知，需要关心数据是否取走，即只通知一次怎么保证数据被进
程成功取走了，以避免数据丢失，通知效率较高。
</p>


<p>
<b>Select</b> ：
</p>

<p>
POSIX所规定，目前几乎在所有的平台上支持，其良好跨平台支持也是它的一个
优点，本质上是通过设置或者检查存放fd标志位的数据结构来进行下一步处理
</p>

<p>
缺点
</p>
<ul class="org-ul">
<li>单个进程能够监视的文件描述符的数量存在最大限制，在Linux上一般为1024，
可以通过修改宏定义FD_SETSIZE，再重新编译内核实现，但是这样也会造成效
率的降低。</li>
<li>单个进程可监视的fd数量被限制，默认是1024，修改此值需要重新编译内核。</li>
<li>对socket是线性扫描，即采用轮询的方法，效率较低。</li>
<li>select 采取了内存拷贝方法来实现内核将 FD消息通知给用户空间，这样一个
用来存放大量fd的数据结构，这样会使得用户空间和内核空间在传递该结构时
复制开销大。</li>
</ul>

<p>
<b>poll</b> ：
</p>

<ul class="org-ul">
<li>本质上和select没有区别，它将用户传入的数组拷贝到内核空间，然后查询每个fd对应的设备状态。</li>
<li>其没有最大连接数的限制，原因是它是基于链表来存储的。</li>
<li>大量的fd的数组被整体复制于用户态和内核地址空间之间，而不管这样的复制是不是有意义。</li>
<li>poll特点是“水平触发”，如果报告了fd后，没有被处理，那么下次poll时会再次报告该fd。</li>
</ul>

<p>
<b>epoll</b> ：
</p>

<p>
在Linux 2.6内核中提出的select和poll的增强版本。
</p>

<p>
支持水平触发LT和边缘触发ET，最大的特点在于边缘触发，它只告诉进程哪些fd刚刚变为就需态，并且只会通知一次
</p>

<p>
使用“事件”的就绪通知方式，通过epoll_ctl注册fd，一旦该fd就绪，内核就会采用类似callback的回调机制来激活该fd，epoll_wait便可以收到通知
。
</p>

<p>
优点:
</p>

<ul class="org-ul">
<li>没有最大并发连接的限制：能打开的FD的上限远大于1024(1G的内存能监听约
10万个端口)，具体查看/proc/sys/fs/file-max，此值和系统内存大小相关</li>
<li>效率提升：非轮询的方式，不会随着FD数目的增加而效率下降；只有活跃可用的FD才会调用callback函数，即epoll</li>
<li>最大的优点就在于它只管理“活跃”的连接，而跟连接总数无关</li>
<li>内存拷贝，利用mmap(Memory
Mapping)加速与内核空间的消息传递；即epoll使用mmap减少复制开销</li>
</ul>

<p>
范例： 最大并发连接数
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#23384;1G</span>
[root@centos8 ~]#free -h
[root@centos8 ~]#cat /proc/sys/fs/file-max
92953

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#23384;2G</span>
[root@centos8 ~]#free -h
[root@centos8 ~]#cat /proc/sys/fs/file-max
195920
</pre>
</div>

<p>
范例：内核限制
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#grep -R FD_SETSIZE linux-5.8/*
linux-5.8/Documentation/userspace-api/media/v4l/func-select.rst:
&#160;<span style="color: #ff00ff;">``</span>FD_SETSIZE<span style="color: #ff00ff;">``</span><span style="color: #483d8b;">.</span>
linux-5.8/include/uapi/linux/posix_types.h:#undef __FD_SETSIZE
linux-5.8/include/uapi/linux/posix_types.h:#define __FD_SETSIZE 1024 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21333;&#20010;&#36827;&#31243;&#33021;</span>
&#22815;&#30417;&#35270;&#30340;&#25991;&#20214;&#25551;&#36848;&#31526;&#30340;&#25991;&#20214;&#26368;&#22823;&#25968;&#37327;
</pre>
</div>

<p>
范例： select 和epoll 帮助
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#whatis epoll
<span style="color: #0000ff;">epoll</span> (7)       - I/O event notification facility
[root@centos8 ~]#whatis select
<span style="color: #a020f0;">select</span> (2)      - synchronous I/O multiplexing
<span style="color: #a020f0;">select</span> (3)      - synchronous I/O multiplexing
<span style="color: #a020f0;">select</span> (3p)      - synchronous I/O multiplexing
[root@centos8 ~]#whatis poll
<span style="color: #0000ff;">poll</span> (2)       - wait for some event on a file descriptor
<span style="color: #0000ff;">poll</span> (3p)       - input/output multiplexing
[root@centos8 ~]#man 2 select
<span style="color: #0000ff;">SELECT</span>(2)                        Linux Programmer<span style="color: #8b2252;">'s</span>
<span style="color: #8b2252;">Manual                        SELECT(2)</span>
<span style="color: #8b2252;">NAME</span>
<span style="color: #8b2252;">   select, pselect, FD_CLR, FD_ISSET, FD_SET, FD_ZERO - synchronous I/O</span>
<span style="color: #8b2252;">multiplexing</span>
<span style="color: #8b2252;">[root@centos8 ~]#man 2 poll</span>
<span style="color: #8b2252;">POLL(2)                         Linux Programmer'</span>s
Manual                         POLL(2)
NAME
   poll, ppoll - wait for some event on a file descriptor
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:e25745a6-8894-44e0-a3f1-43090998bb5f" class="outline-3">
<h3 id="h:e25745a6-8894-44e0-a3f1-43090998bb5f">零拷贝</h3>
<div class="outline-text-3" id="text-h:e25745a6-8894-44e0-a3f1-43090998bb5f">
</div>
<div id="outline-container-h:dfab4a36-bb7d-4b43-9560-88032d5d4ae3" class="outline-4">
<h4 id="h:dfab4a36-bb7d-4b43-9560-88032d5d4ae3">零拷贝介绍</h4>
<div class="outline-text-4" id="text-h:dfab4a36-bb7d-4b43-9560-88032d5d4ae3">
<p>
<b>传统 Linux中 I/O 的问题</b>
</p>


<figure id="org159b103">
<img src="./images/img_20240227_175838.png" alt="img_20240227_175838.png" width="80%">

</figure>

<p>
传统的 Linux 系统的标准 I/O 接口（read、write）是基于数据拷贝的，也就
是数据都是 copy_to_user或者 copy_from_user，这样做的好处是，通过中间缓
存的机制，减少磁盘 I/O 的操作，但是坏处也很明显，大量数据的拷贝，用户
态和内核态的频繁切换，会消耗大量的 CPU 资源，严重影响数据传输的性能，
统计表明，在Linux协议栈中，数据包在内核态和用户态之间的拷贝所用的时间
甚至占到了数据包整个处理流程时间的57.1%
</p>


<p>
<b>什么是零拷贝</b>
</p>

<p>
零拷贝就是上述问题的一个解决方案，通过尽量避免拷贝操作来缓解 CPU 的压
力。零拷贝并没有真正做到“0”拷贝，它更多是一种思想，很多的零拷贝技术
都是基于这个思想去做的优化
</p>

<p>
<b>零拷页相关技术</b>
</p>

<ul class="org-ul">
<li>MMAP ( Memory Mapping )</li>
<li>SENDFILE</li>
<li>DMA 辅助的 SENDFILE</li>
</ul>
</div>
</div>
<div id="outline-container-h:9eb1abb0-e776-4aed-a7af-0d64a61f65ce" class="outline-4">
<h4 id="h:9eb1abb0-e776-4aed-a7af-0d64a61f65ce">MMAP：</h4>
<div class="outline-text-4" id="text-h:9eb1abb0-e776-4aed-a7af-0d64a61f65ce">

<figure id="orgf7ca67e">
<img src="./images/img_20240227_175811.png" alt="img_20240227_175811.png" width="80%">

</figure>

<p>
mmap(memory mapping)系统调用使得进程之间通过映射同一个普通文件实现共享
内存，普通文件被映射到进程地址空间后，进程可以像访问普通内存一样对文件
进行访问。
</p>

<p>
mmap是一种内存映射文件的方法，即将一个文件或者其它对象映射到进程的地址
空间，实现文件磁盘地址和进程虚拟地址空间中一段虚拟地址的一一对映关系。
</p>

<p>
实现这样的映射关系后，进程就可以采用指针的方式读写操作这一段内存，而系
统会自动回写脏页面到对应的文件磁盘上，即完成了对文件的操作而不必再调用
read,write等系统调用函数。相反，内核空间对这段区域的修改也直接反映用户
空间，从而可以实现不同进程间的文件共享。
</p>

<p>
内存映射减少数据在用户空间和内核空间之间的拷贝操作,适合大量数据传输
</p>
</div>
</div>
<div id="outline-container-h:5ccefeb7-0f30-4bf7-ab25-fbd17dc0e873" class="outline-4">
<h4 id="h:5ccefeb7-0f30-4bf7-ab25-fbd17dc0e873">SENDFILE</h4>
<div class="outline-text-4" id="text-h:5ccefeb7-0f30-4bf7-ab25-fbd17dc0e873">

<figure id="orgd6416ee">
<img src="./images/img_20240227_175653.png" alt="img_20240227_175653.png" width="80%">

</figure>
</div>
</div>
<div id="outline-container-h:24ac749d-1da5-499f-a53e-4a3925a402f8" class="outline-4">
<h4 id="h:24ac749d-1da5-499f-a53e-4a3925a402f8">DMA 辅助的 SENDFILE</h4>
<div class="outline-text-4" id="text-h:24ac749d-1da5-499f-a53e-4a3925a402f8">

<figure id="orgb0bacf8">
<img src="./images/img_20240227_175722.png" alt="img_20240227_175722.png" width="80%">

</figure>
</div>
</div>
</div>
</section>
<section id="outline-container-h:045436e1-b9db-47d7-a8e5-efa2eb1cc339" class="outline-2">
<h2 id="h:045436e1-b9db-47d7-a8e5-efa2eb1cc339">Nginx基础</h2>
<div class="outline-text-2" id="text-h:045436e1-b9db-47d7-a8e5-efa2eb1cc339">
<p>
Nginx：engine X ，2002年开发，分为社区版和商业版(nginx plus )
</p>

<p>
2019年3月11日 F5 Networks 6.7亿美元的价格收购
</p>

<p>
Nginx是免费的、开源的、高性能的HTTP和反向代理服务器、邮件代理服务器、
以及TCP/UDP代理服务器
</p>

<p>
解决C10K问题（10K Connections）
</p>

<p>
解决C1000K问题参考链接: <a href="http://www.ideawu.net/blog/archives/740.html">http://www.ideawu.net/blog/archives/740.html</a>
</p>

<p>
Nginx官网：<a href="https://nginx.org">https://nginx.org</a>
</p>

<p>
nginx的其它的二次发行版：
</p>

<ul class="org-ul">
<li>Tengine：由淘宝网发起的Web服务器项目。它在Nginx的基础上，针对大访问
量网站的需求，添加了很多高级功能和特性，Tengine的性能和稳定性已经在
大型的网站如淘宝网，天猫商城等得到了很好的检验，它的最终目标是打造一
个高效、稳定、安全、易用的Web平台，从2011年12月开始，Tengine成为一个
开源项目，官网<a href="http://tengine.taobao.org/">http://tengine.taobao.org/</a></li>
<li>OpenResty：基于 Nginx 与 Lua 语言的高性能 Web 平台，章亦春团队开发，
官网：<a href="http://openresty.org/cn/">http://openresty.org/cn/</a></li>
</ul>
</div>
<div id="outline-container-h:15f64e4e-ea44-47ed-a0c5-5bdaf88304f6" class="outline-3">
<h3 id="h:15f64e4e-ea44-47ed-a0c5-5bdaf88304f6">Nginx功能介绍</h3>
<div class="outline-text-3" id="text-h:15f64e4e-ea44-47ed-a0c5-5bdaf88304f6">
<ul class="org-ul">
<li>静态的web资源服务器html，图片，js，css，txt等静态资源</li>

<li>结合FastCGI/uWSGI/SCGI等协议反向代理动态资源请求</li>

<li>http/https协议的反向代理</li>

<li>imap4/pop3协议的反向代理</li>

<li>tcp/udp协议的请求转发（反向代理）</li>
</ul>
</div>
<div id="outline-container-h:6997f367-9948-44ee-a910-c512c55ed9de" class="outline-4">
<h4 id="h:6997f367-9948-44ee-a910-c512c55ed9de">基础特性</h4>
<div class="outline-text-4" id="text-h:6997f367-9948-44ee-a910-c512c55ed9de">
<p>
<b>特性</b> ：
</p>
<ul class="org-ul">
<li>模块化设计，较好的扩展性</li>
<li>高可靠性（很少宕机）</li>
<li>支持热部署：不停机更新配置文件，升级版本，更换日志文件</li>
<li>低内存消耗： <b>10000个keep-alive连接模式下的非活动连接，仅需2.5M内存</b></li>
<li>event-driven,aio,mmap，sendfile</li>
</ul>

<p>
<b>基本功能</b> ：
</p>

<ul class="org-ul">
<li>静态资源的web服务器</li>
<li>http协议反向代理服务器</li>
<li>pop3/imap4协议反向代理服务器</li>
<li>FastCGI(LNMP),uWSGI(python)等协议</li>
<li>模块化（非DSO），如zip，SSL模块</li>
</ul>
</div>
</div>
<div id="outline-container-h:01321bc6-f37a-4412-a037-dbaa4db62764" class="outline-4">
<h4 id="h:01321bc6-f37a-4412-a037-dbaa4db62764">和web服务相关的功能</h4>
<div class="outline-text-4" id="text-h:01321bc6-f37a-4412-a037-dbaa4db62764">
<ul class="org-ul">
<li>虚拟主机（server）</li>
<li>支持 keep-alive 和管道连接(利用一个连接做多次请求)</li>
<li>访问日志（支持基于日志缓冲提高其性能）</li>
<li>url rewirte</li>
<li>路径别名</li>
<li>基于IP及用户的访问控制</li>
<li>支持速率限制及并发数限制</li>
<li>重新配置和在线升级而无须中断客户的工作进程</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:65ae0145-e6bb-4cf5-a07e-f15d3dbdd023" class="outline-3">
<h3 id="h:65ae0145-e6bb-4cf5-a07e-f15d3dbdd023">Nginx组织结构</h3>
<div class="outline-text-3" id="text-h:65ae0145-e6bb-4cf5-a07e-f15d3dbdd023">
<p>
web请求处理机制：
</p>

<ol class="org-ol">
<li><b>多进程方式</b> ：服务器每接收到一个客户端请求就有服务器的主进程生成一
个子进程响应客户端，直到用户关闭连接，这样的优势是处理速度快，各子
进程之间相互独立，但是如果访问过大会导致服务器资源耗尽而无法提供请
求。</li>

<li><b>多线程方式</b> ：与多进程方式类似，但是每收到一个客户端请求会有服务进
程派生出一个线程来个客户方进行交互，一个线程的开销远远小于一个进程，
因此多线程方式在很大程度减轻了web服务器对系统资源的要求，但是多线程
也有自己的缺点，即当多个线程位于同一个进程内工作的时候，可以相互访
问同样的内存地址空间，所以他们相互影响，另外一旦主进程挂掉则所有子
线程都不能工作了，IIS服务器使用了多线程的方1式，需要间隔一段时间就
重启一次才能稳定。</li>
</ol>

<p>
<b>Nginx是多进程组织模型，而且是一个由Master主进程和Worker工作进程组成。</b>
</p>

<p>
主进程(master process)的功能：
</p>
<ul class="org-ul">
<li>读取Nginx 配置文件并验证其有效性和正确性</li>
<li>建立、绑定和关闭socket连接</li>
<li>按照配置生成、管理和结束工作进程</li>
<li>接受外界指令，比如重启、升级及退出服务器等指令</li>
<li>不中断服务，实现平滑升级，重启服务并应用新的配置</li>
<li>开启日志文件，获取文件描述符</li>
<li>不中断服务，实现平滑升级，升级失败进行回滚处理</li>
<li>编译和处理perl脚本</li>
</ul>

<p>
工作进程（woker process）的功能：
</p>

<ul class="org-ul">
<li>接受处理客户的请求</li>
<li>将请求依次送入各个功能模块进行处理</li>
<li>IO调用，获取响应数据</li>
<li>与后端服务器通信，接收后端服务器的处理结果</li>
<li>缓存数据，访问缓存索引，查询和调用缓存数据</li>
<li>发送请求结果，响应客户的请求</li>
<li>接收主程序指令，比如重启、升级和退出等</li>
</ul>
</div>
<div id="outline-container-h:037abfc5-1800-410a-b5cb-ea657cd93763" class="outline-4">
<h4 id="h:037abfc5-1800-410a-b5cb-ea657cd93763">进程间通信：</h4>
<div class="outline-text-4" id="text-h:037abfc5-1800-410a-b5cb-ea657cd93763">
<p>
工作进程是有主进程生成的，主进程使用fork()函数，在Nginx服务器启动过程
中主进程根据配置文件决定启动工作进程的数量，然后建立一张全局的工作表用
于存放当前未退出的所有的工作进程，主进程生成工作进程后会将新生成的工作
进程加入到工作进程表中，并建立一个单向的管道并将其传递给工作进程，该管
道与普通的管道不同，它是由主进程指向工作进程的单向通道，包含了主进程向
工作进程发出的指令、工作进程ID、工作进程在工作进程表中的索引和必要的文
件描述符等信息。
</p>

<p>
主进程与外界通过信号机制进行通信，当接收到需要处理的信号时，它通过管道
向相关的工作进程发送正确的指令，每个工作进程都有能力捕获管道中的可读事
件，当管道中有可读事件的时候，工作进程就会从管道中读取并解析指令，然后
采取相应的执行动作，这样就完成了主进程与工作进程的交互。
</p>

<p>
说明：
</p>

<ol class="org-ol">
<li>工作进程之间的通信原理基本上和主进程与工作进程之间的通信是一样的，
只要工作进程之间能够取得彼此的信息，建立管道即可通信，但是由于工作
进程之间是完全隔离的，因此一个进程想要知道另外一个进程的状态信息就
只能通过主进程来设置了。</li>
<li>为了实现工作进程之间的交互，主进程在生成工作进程之后，在工作进程表
中进行遍历，将该新进程的ID以及针对该进程建立的管道句柄传递给工作进
程中的其他进程，为工作进程之间的通信做准备，当工作进程1向工作进程2
发送指令的时候，首先在主进程给它的其他工作进程工作信息中找到2的进程
ID，然后将正确的指令写入指向进程2的管道，工作进程2捕获到管道中的事
件后，解析指令并进行相关操作，这样就完成了工作进程之间的通信。</li>
</ol>


<figure id="org8394973">
<img src="./images/img_20240229_041107.png" alt="img_20240229_041107.png" width="80%">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:85ab7b14-c266-409a-b55f-4a40aa2c0fb8" class="outline-3">
<h3 id="h:85ab7b14-c266-409a-b55f-4a40aa2c0fb8">Nginx模块介绍：</h3>
<div class="outline-text-3" id="text-h:85ab7b14-c266-409a-b55f-4a40aa2c0fb8">
<ol class="org-ol">
<li>核心模块 ：是 Nginx 服务器正常运行 必不可少 的模块，提供
错误日志记录 、 配置文件解析 、 事件驱动机制 、进程管理 等核心功能</li>

<li>标准HTTP模块：提供 HTTP 协议解析相关的功能，比如： 端口配置 、
网页编码设置 、 HTTP响应头设置 等等</li>

<li>可选HTTP模块：主要用于扩展标准的 HTTP 功能，让 Nginx
能处理一些特殊的服务，比如： Flash 多媒体传输 、解析 GeoIP 请求、
网络传输压缩 、 安全协议 SSL 支持等</li>

<li>邮件服务模块：主要用于支持 Nginx 的 邮件服务 ，包括对 POP3 协议、
IMAP 协议和 SMTP协议的支持 （基本用不上）</li>

<li>第三方模块：是为了扩展 Nginx 服务器应用，完成开发者自定义功能，比如：
Json 支持、 Lua 支持等</li>
</ol>

<p>
nginx高度模块化，但其模块早期不支持DSO机制；*1.9.11版本支持动态装载和卸载*
</p>

<p>
模块分类：
</p>

<div class="org-src-container">
<pre class="src src-sh">&#26680;&#24515;&#27169;&#22359;&#65306;core module
&#26631;&#20934;&#27169;&#22359;&#65306;
HTTP &#27169;&#22359;&#65306; ngx_http_*
    HTTP Core modules &#40664;&#35748;&#21151;&#33021;
    HTTP Optional modules &#38656;&#32534;&#35793;&#26102;&#25351;&#23450;
Mail &#27169;&#22359; ngx_mail_*
Stream &#27169;&#22359; ngx_stream_*
&#31532;&#19977;&#26041;&#27169;&#22359;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:dad3dc98-59bd-4a9f-86a3-24a35d0e5c91" class="outline-3">
<h3 id="h:dad3dc98-59bd-4a9f-86a3-24a35d0e5c91">Nginx安装</h3>
<div class="outline-text-3" id="text-h:dad3dc98-59bd-4a9f-86a3-24a35d0e5c91">
<p>
Nginx的安装版本分为Mainline version(主要开发版本，其实就是还处于开发版)、
Stable version(当前最新稳定版)和Legacy versions(旧的稳定版)
</p>

<p>
Nginx安装可以使用yum或源码安装，但是推荐使用源码，
</p>
<ul class="org-ul">
<li>是yum的版本比较旧</li>
<li>编译安装可以更方便自定义相关路径</li>
<li>是使用源码编译可以自定义相关功能，更方便业务的上的使用</li>
</ul>

<p>
源码安装需要提前准备标准的编译器，GCC的全称是（GNU Compiler
collection），其有GNU开发，并以GPL即LGPL许可，是自由的类UNIX即苹果电脑
Mac OS X操作系统的标准编译器，因为GCC原本只能处理C语言，所以原名为GNU
C语言编译器，后来得到快速发展，可以处理C++,Fortran，pascal，
objective-C，java以及Ada等其他语言，此外还需要Automake工具，以完成自动
创建Makefile的工作，Nginx的一些模块需要依赖第三方库，比如pcre（支持
rewrite），zlib（支持gzip模块）和openssl（支持ssl模块）等。
</p>
</div>
<div id="outline-container-h:874d6252-cb06-4c86-b8ab-beec87ebd5e9" class="outline-4">
<h4 id="h:874d6252-cb06-4c86-b8ab-beec87ebd5e9">Nginx yum安装</h4>
<div class="outline-text-4" id="text-h:874d6252-cb06-4c86-b8ab-beec87ebd5e9">
<p>
系统和EPEL源的中nignx版本较旧,可以安装官方源的最新版本
</p>

<p>
官方包链接: <a href="http://nginx.org/en/linux_packages.html">http://nginx.org/en/linux_packages.html</a>
</p>

<p>
官方提供的仓库：<a href="http://nginx.org/en/linux_packages.html#RHEL-CentOS">http://nginx.org/en/linux_packages.html#RHEL-CentOS</a>
</p>

<p>
范例: 通过官方 yum 源安装nginx
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@Centos7 ~]#vim /etc/yum.repos.d/nginx.repo
[nginx-stable]
<span style="color: #a0522d;">name</span>=nginx stable repo
<span style="color: #a0522d;">baseurl</span>=http://nginx.org/packages/centos/$<span style="color: #a0522d;">releasever</span>/$<span style="color: #a0522d;">basearch</span>/
<span style="color: #a0522d;">gpgcheck</span>=1
<span style="color: #a0522d;">enabled</span>=1
<span style="color: #a0522d;">gpgkey</span>=https://nginx.org/keys/nginx_signing.key
<span style="color: #a0522d;">module_hotfixes</span>=true

[nginx-mainline]
<span style="color: #a0522d;">name</span>=nginx mainline repo
<span style="color: #a0522d;">baseurl</span>=http://nginx.org/packages/mainline/centos/$<span style="color: #a0522d;">releasever</span>/$<span style="color: #a0522d;">basearch</span>/
<span style="color: #a0522d;">gpgcheck</span>=1
<span style="color: #a0522d;">enabled</span>=0
<span style="color: #a0522d;">gpgkey</span>=https://nginx.org/keys/nginx_signing.key
<span style="color: #a0522d;">module_hotfixes</span>=true

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;&#29256;&#26412;</span>
[root@centos8 ~]#yum list nginx --showduplicates

[root@Centos7 ~]# yum install -y nginx
[root@Centos7 ~]# rpm -ql nginx
/etc/logrotate.d/nginx
/etc/nginx/fastcgi.conf
/etc/nginx/fastcgi.conf.default
/etc/nginx/fastcgi_params
/etc/nginx/fastcgi_params.default
/etc/nginx/koi-utf
/etc/nginx/koi-win
/etc/nginx/mime.types
/etc/nginx/mime.types.default
/etc/nginx/nginx.conf
/etc/nginx/nginx.conf.default
/etc/nginx/scgi_params
/etc/nginx/scgi_params.default
/etc/nginx/uwsgi_params
/etc/nginx/uwsgi_params.default
/etc/nginx/win-utf
/usr/bin/nginx-upgrade
/usr/lib/systemd/system/nginx.service
/usr/lib64/nginx/modules
/usr/sbin/nginx
/usr/share/doc/nginx-1.18.0
.................
/var/lib/nginx
/var/lib/nginx/tmp
/var/log/nginx

[root@Centos7 ~]# which nginx
/usr/sbin/nginx
</pre>
</div>
</div>
<div id="outline-container-h:4348e83b-6f45-4230-a140-02421c6eb306" class="outline-5">
<h5 id="h:4348e83b-6f45-4230-a140-02421c6eb306">检查安装：</h5>
<div class="outline-text-5" id="text-h:4348e83b-6f45-4230-a140-02421c6eb306">
<p>
查看nginx安装包信息
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@Centos7 ~]#rpm -qi nginx
Name        : nginx
Epoch       : 1
Version     : 1.16.1
Release     : 1.el7
Architecture: x86_64
Install Date: Mon 13 Jul 2020 10:37:26 PM CST
Group       : Unspecified
Size        : 1689960
License     : BSD
Signature   : RSA/SHA256, Fri 04 Oct 2019 06:38:33 AM CST, Key ID 6a2faea2352c64e5
Source RPM  : nginx-1.16.1-1.el7.src.rpm
Build Date  : Thu 03 Oct 2019 01:15:40 PM CST
Build Host  : buildvm-13.phx2.fedoraproject.org
Relocations : (not relocatable)
Packager    : Fedora Project
Vendor      : Fedora Project
URL         : http://nginx.org/
Bug URL     : https://bugz.fedoraproject.org/nginx
Summary     : A high performance web server and reverse proxy server
Description :
Nginx is a web server and a reverse proxy server for HTTP, SMTP, POP3 and IMAP protocols, with a strong focus on high concurrency, performance and low memory usage.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:592a5e1d-0928-4e7c-862a-ee4043b2f124" class="outline-5">
<h5 id="h:592a5e1d-0928-4e7c-862a-ee4043b2f124">查看帮助</h5>
<div class="outline-text-5" id="text-h:592a5e1d-0928-4e7c-862a-ee4043b2f124">
<p>
使用安装完成的二进制文件nginx
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@Centos7 ~]# nginx -h
nginx version: nginx/1.16.1
Usage: nginx [-?hvVtTq] [-s signal] [-c filename] [-p prefix] [-g directives]
Options:
 -?,-h : this help
 -v            : show version and exit
 -V            : show version and configure options then exit <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#29256;&#26412;&#21644;&#32534;&#35793;&#21442;&#25968;</span>
 -t            : test configuration and exit <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;&#37197;&#32622;&#25991;&#20214;&#26159;&#21542;&#24322;&#24120;</span>
 -T            : test configuration, dump it and exit <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;&#24182;&#25171;&#21360;</span>
 -q            : suppress non-error messages during configuration testing <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38745;&#40664;&#27169;&#24335;</span>
 -s signal     : send signal to a master process: stop, quit, reopen, reload <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21457;&#36865;&#20449;&#21495;</span>
 -p prefix     : set prefix path (default: /usr/share/nginx/) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;Nginx &#30446;&#24405;</span>
 -c filename   : set configuration file (default: /etc/nginx/nginx.conf) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#25991;&#20214;&#36335;&#24452;</span>
 -g directives : set global directives out of configuration file <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#20840;&#23616;&#25351;&#20196;</span>
</pre>
</div>

<p>
范例: nginx 命令使用
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nginx -g <span style="color: #8b2252;">"worker_processes 6;"</span>
nginx: [emerg] <span style="color: #8b2252;">"worker_processes"</span> directive is duplicate<span style="color: #a020f0;"> in</span>
/apps/nginx/conf/nginx.conf:3
[root@centos8 ~]#vim /apps/nginx/conf/nginx.conf

<span style="color: #b22222;">#</span><span style="color: #b22222;">worker_processes 1;</span>
[root@centos8 ~]#nginx -g <span style="color: #8b2252;">"worker_processes 6;"</span>
[root@centos8 ~]#ps aux|grep nginx


[root@centos8 ~]#nginx -s quit
[root@centos8 ~]#ps aux|grep nginx

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21069;&#21488;&#36816;&#34892;</span>
[root@centos8 ~]#nginx -g <span style="color: #8b2252;">'daemon off;'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8f5bfe66-cb1e-48fe-922d-502ca8efcfb5" class="outline-5">
<h5 id="h:8f5bfe66-cb1e-48fe-922d-502ca8efcfb5">验证Nginx</h5>
<div class="outline-text-5" id="text-h:8f5bfe66-cb1e-48fe-922d-502ca8efcfb5">
<div class="org-src-container">
<pre class="src src-sh">[root@Centos7 ~]#nginx -t
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
[root@Centos7 ~]#nginx -V
nginx version: nginx/1.16.1
built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC)
built with OpenSSL 1.0.2k-fips  26 Jan 2017
TLS SNI support enabled
configure arguments: --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-file-aio --with-ipv6 --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-stream_ssl_preread_module --with-http_addition_module --with-http_xslt_module=dynamic --with-http_image_filter_module=dynamic --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_slice_module --with-http_stub_status_module --with-http_perl_module=dynamic --with-http_auth_request_module --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-google_perftools_module --with-debug --with-cc-opt=<span style="color: #8b2252;">'-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic'</span> --with-ld-opt=<span style="color: #8b2252;">'-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3e9fdb79-0feb-40fd-b240-dee746cb890a" class="outline-5">
<h5 id="h:3e9fdb79-0feb-40fd-b240-dee746cb890a">Nginx启动脚本</h5>
<div class="outline-text-5" id="text-h:3e9fdb79-0feb-40fd-b240-dee746cb890a">
<div class="org-src-container">
<pre class="src src-sh">[root@s1 ~]# cat /usr/lib/systemd/system/nginx.service
[Unit]
<span style="color: #a0522d;">Description</span>=The nginx HTTP and reverse proxy server
<span style="color: #a0522d;">After</span>=network.target remote-fs.target nss-lookup.target

[Service]
<span style="color: #a0522d;">Type</span>=forking
<span style="color: #a0522d;">PIDFile</span>=/run/nginx.pid
<span style="color: #b22222;"># </span><span style="color: #b22222;">Nginx will fail to start if /run/nginx.pid already exists but has the wrong</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">SELinux context. This might happen when running `nginx -t` from the cmdline.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">https://bugzilla.redhat.com/show_bug.cgi?id=1268621</span>
<span style="color: #a0522d;">ExecStartPre</span>=/usr/bin/rm -f /run/nginx.pid
<span style="color: #a0522d;">ExecStartPre</span>=/usr/sbin/nginx -t
<span style="color: #a0522d;">ExecStart</span>=/usr/sbin/nginx
<span style="color: #a0522d;">ExecReload</span>=/bin/kill -s HUP $<span style="color: #a0522d;">MAINPID</span>
<span style="color: #a0522d;">KillSignal</span>=SIGQUIT
<span style="color: #a0522d;">TimeoutStopSec</span>=5
<span style="color: #a0522d;">KillMode</span>=process
<span style="color: #a0522d;">PrivateTmp</span>=true

[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target
</pre>
</div>
</div>
</div>
<div id="outline-container-h:81b67c9b-00cc-4a88-be3e-19aea8063665" class="outline-5">
<h5 id="h:81b67c9b-00cc-4a88-be3e-19aea8063665">Nginx 配置文件</h5>
<div class="outline-text-5" id="text-h:81b67c9b-00cc-4a88-be3e-19aea8063665">
<p>
范例: 查看配置文件列表
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -qc nginx
/etc/logrotate.d/nginx
/etc/nginx/conf.d/default.conf
/etc/nginx/fastcgi_params
/etc/nginx/koi-utf
/etc/nginx/koi-win
/etc/nginx/mime.types
/etc/nginx/nginx.conf
/etc/nginx/scgi_params
/etc/nginx/uwsgi_params
/etc/nginx/win-utf
/etc/sysconfig/nginx
/etc/sysconfig/nginx-debug

[root@centos8 ~]#cat /etc/sysconfig/nginx
<span style="color: #b22222;"># </span><span style="color: #b22222;">Configuration file for the nginx service.</span>
<span style="color: #a0522d;">NGINX</span>=/usr/sbin/nginx
<span style="color: #a0522d;">CONFFILE</span>=/etc/nginx/nginx.conf

[root@centos8 ~]#tree /etc/nginx/
/etc/nginx/
&#9500;&#9472;&#9472; conf.d
&#9474;&#160;&#160;&#9492;&#9472;&#9472; default.conf
&#9500;&#9472;&#9472; fastcgi_params
&#9500;&#9472;&#9472; koi-utf
&#9500;&#9472;&#9472; koi-win
&#9500;&#9472;&#9472; mime.types
&#9500;&#9472;&#9472; modules -&gt; ../../usr/lib64/nginx/modules
&#9500;&#9472;&#9472; nginx.conf
&#9500;&#9472;&#9472; scgi_params
&#9500;&#9472;&#9472; uwsgi_params
&#9492;&#9472;&#9472; win-utf
2 directories, 9 files
</pre>
</div>

<p>
范例: 配置文件/etc/nginx/nginx.conf 默认配置
</p>
<div class="org-src-container">
<pre class="src src-sh">user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;
include /usr/share/nginx/modules/*.conf;
events {
    worker_connections 1024;
}
http {
    log_format  main  <span style="color: #8b2252;">'$remote_addr - $remote_user [$time_local] "$request" '</span>
                      <span style="color: #8b2252;">'$status $body_bytes_sent "$http_referer" '</span>
                      <span style="color: #8b2252;">'"$http_user_agent" "$http_x_forwarded_for"'</span>;
    access_log  /var/log/nginx/access.log  main;
    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;
    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;
    include /etc/nginx/conf.d/*.conf;
    server {
        listen       80 default_server;
        listen       [::]:80 default_server;
        server_name  _;
        root         /usr/share/nginx/html;
        include /etc/nginx/default.d/*.conf;
        location / {
        }
        error_page 404 /404.html;
            location = /40x.html {
        }
        error_page 500 502 503 504 /50x.html;
            location = /50x.html {
        }
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:53d46186-e8aa-4c0a-9712-47868950341d" class="outline-5">
<h5 id="h:53d46186-e8aa-4c0a-9712-47868950341d">启动Nginx</h5>
<div class="outline-text-5" id="text-h:53d46186-e8aa-4c0a-9712-47868950341d">
<div class="org-src-container">
<pre class="src src-sh">[root@Centos7 ~]#systemctl start nginx
[root@Centos7 ~]#systemctl status nginx
&#9679; nginx.service - The nginx HTTP and reverse proxy server
   Loaded: loaded (/usr/lib/systemd/system/nginx.service; disabled; vendor preset: disabled)
   Active: active (running) since Mon 2020-07-13 22:43:52 CST; 8s ago
  Process: 3141 <span style="color: #a0522d;">ExecStart</span>=/usr/sbin/nginx (<span style="color: #a0522d;">code</span>=exited, <span style="color: #a0522d;">status</span>=0/SUCCESS)
  Process: 3138 <span style="color: #a0522d;">ExecStartPre</span>=/usr/sbin/nginx -t (<span style="color: #a0522d;">code</span>=exited, <span style="color: #a0522d;">status</span>=0/SUCCESS)
  Process: 3136 <span style="color: #a0522d;">ExecStartPre</span>=/usr/bin/rm -f /run/nginx.pid (<span style="color: #a0522d;">code</span>=exited, <span style="color: #a0522d;">status</span>=0/SUCCESS)
 Main PID: 3143 (nginx)
   CGroup: /system.slice/nginx.service
           &#9500;&#9472;3143 nginx: master process /usr/sbin/nginx
           &#9500;&#9472;3144 nginx: worker process
           &#9492;&#9472;3145 nginx: worker process

Jul 13 22:43:52 Centos7.8 systemd[1]: Starting The nginx HTTP and reverse proxy server...
Jul 13 22:43:52 Centos7.8 nginx[3138]: nginx: the configuration file /etc/nginx/nginx.conf ... ok
Jul 13 22:43:52 Centos7.8 nginx[3138]: nginx: configuration file /etc/nginx/nginx.conf test...ful
Jul 13 22:43:52 Centos7.8 systemd[1]: Started The nginx HTTP and reverse proxy server.
Hint: Some lines were ellipsized, use -l to show<span style="color: #a020f0;"> in</span> full.

[root@Centos7 ~]#ps -ef | grep nginx
root       3143      1  0 22:43 ?        00:00:00 nginx: master process /usr/sbin/nginx
nginx      3144   3143  0 22:43 ?        00:00:00 nginx: worker process
nginx      3145   3143  0 22:43 ?        00:00:00 nginx: worker process
root       3149   3006  0 22:44 pts/1    00:00:00 grep --color=auto nginx
</pre>
</div>

<p>
访问nginx
</p>
</div>
</div>
</div>
<div id="outline-container-h:cad80b4e-83ca-4970-9b71-26431b69b9d1" class="outline-4">
<h4 id="h:cad80b4e-83ca-4970-9b71-26431b69b9d1">Nginx 编译安装</h4>
<div class="outline-text-4" id="text-h:cad80b4e-83ca-4970-9b71-26431b69b9d1">
<p>
官方源码包下载地址：<a href="https://nginx.org/en/download.html">https://nginx.org/en/download.html</a>
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum -y install gcc pcre-devel openssl-devel zlib-devel
[root@centos8 ~]#useradd -s /sbin/nologin nginx

[root@centos8 ~]#cd /usr/local/src/
[root@centos8 src]#wget http://nginx.org/download/nginx-1.18.0.tar.gz
[root@centos8 src]#tar xf nginx-1.18.0.tar.gz
[root@centos8 src]#cd nginx-1.18.0/
[root@centos8 nginx-1.18.0]#./configure --prefix=/apps/nginx <span style="color: #8b2252;">\</span>
--user=nginx <span style="color: #8b2252;">\</span>
--group=nginx <span style="color: #8b2252;">\</span>
--with-http_ssl_module <span style="color: #8b2252;">\</span>
--with-http_v2_module <span style="color: #8b2252;">\</span>
--with-http_realip_module <span style="color: #8b2252;">\</span>
--with-http_stub_status_module <span style="color: #8b2252;">\</span>
--with-http_gzip_static_module <span style="color: #8b2252;">\</span>
--with-pcre <span style="color: #8b2252;">\</span>
--with-stream <span style="color: #8b2252;">\</span>
--with-stream_ssl_module <span style="color: #8b2252;">\</span>
--with-stream_realip_module

[root@centos8 nginx-1.18.0]#make &amp;&amp; make install

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#26435;&#38480;</span>
[root@centos8 nginx-1.18.0]#chown -R nginx.nginx /apps/nginx
</pre>
</div>

<p>
nginx完成安装以后，有四个主要的目录
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#30446;&#24405;</span>
[root@centos8 nginx-1.18.0]#ll /apps/nginx/
total 0
drwxr-xr-x 2 root root 333 Sep 22 12:49 conf
drwxr-xr-x 2 root root &#160;40 Sep 22 12:49 html
drwxr-xr-x 2 root root &#160;6 Sep 22 12:49 logs
drwxr-xr-x 2 root root &#160;19 Sep 22 12:49 sbin
</pre>
</div>

<ul class="org-ul">
<li>conf：保存nginx所有的配置文件，其中nginx.conf是nginx服务器的最核心最
主 要的配置文件，其他的.conf则是用来配置nginx相关的功能的，例如
fastcgi功 能使用的是fastcgi.conf和fastcgi_params两个文件，配置文件一
般都有个样板 配置文件，是文件名.default结尾，使用的使用将其复制为并
将default去掉即 可。</li>

<li>html目录中保存了nginx服务器的web文件，但是可以更改为其他目录保存web文件,另外还有一个50x的web文件是默认的错误页面提示页面。</li>

<li>logs：用来保存nginx服务器的访问日志错误日志等日志，logs目录可以放在其他路径，比如/var/logs/nginx里面。</li>

<li>sbin：保存nginx二进制启动脚本，可以接受不同的参数以实现不同的功能。</li>
</ul>
</div>
<div id="outline-container-h:08af95d0-26dd-4425-9a38-eeee42f06426" class="outline-5">
<h5 id="h:08af95d0-26dd-4425-9a38-eeee42f06426">验证版本及编译参数</h5>
<div class="outline-text-5" id="text-h:08af95d0-26dd-4425-9a38-eeee42f06426">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 nginx-1.18.0]#ls /apps/nginx/sbin/
nginx
[root@centos8 nginx-1.18.0]#ln -s /apps/nginx/sbin/nginx /usr/sbin/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#29256;&#26412;</span>
[root@centos8 ~]#nginx -v
nginx version: nginx/1.18.0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#32534;&#35793;&#21442;&#25968;</span>
[root@centos8 ~]#nginx -V
nginx version: nginx/1.18.0
built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC)
built with OpenSSL 1.0.2k-fips 26 Jan 2017
TLS SNI support enabled
configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --withhttp_ssl_module --with-http_v2_module --with-http_realip_module --withhttp_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5993c581-5c8a-45b7-a4bb-a4dfe2c041ad" class="outline-5">
<h5 id="h:5993c581-5c8a-45b7-a4bb-a4dfe2c041ad">访问编译安装的nginx web界面</h5>
<div class="outline-text-5" id="text-h:5993c581-5c8a-45b7-a4bb-a4dfe2c041ad">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;nginx</span>
[root@centos8 ~]#nginx
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27983;&#35272;&#22120;&#21487;&#20197;&#35775;&#38382;&#30475;&#21040;&#19979;&#38754;&#22270;&#31034;</span>
[root@centos8 ~]#ss -ntl

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#38381;nginx</span>
[root@centos8 ~]#nginx -s stop
[root@centos8 ~]#ss -ntl
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a50c6295-fbab-482f-9940-34f606a104bc" class="outline-5">
<h5 id="h:a50c6295-fbab-482f-9940-34f606a104bc">创建Nginx自启动脚本</h5>
<div class="outline-text-5" id="text-h:a50c6295-fbab-482f-9940-34f606a104bc">
<p>
<b>Nginx 1.16.1</b> ：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@Centos7 ~]# cat /usr/lib/systemd/system/nginx.service
[Unit]
<span style="color: #a0522d;">Description</span>=The nginx HTTP and reverse proxy server
<span style="color: #a0522d;">After</span>=network.target remote-fs.target nss-lookup.target

[Service]
<span style="color: #a0522d;">Type</span>=forking
<span style="color: #a0522d;">PIDFile</span>=/run/nginx.pid
<span style="color: #b22222;"># </span><span style="color: #b22222;">Nginx will fail to start if /run/nginx.pid already exists but has the wrong</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">SELinux context. This might happen when running `nginx -t` from the cmdline.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">https://bugzilla.redhat.com/show_bug.cgi?id=1268621</span>
<span style="color: #a0522d;">ExecStartPre</span>=/usr/bin/rm -f /run/nginx.pid
<span style="color: #a0522d;">ExecStartPre</span>=/apps/nginx/sbin/nginx -t
<span style="color: #a0522d;">ExecStart</span>=/apps/nginx/sbin/nginx
<span style="color: #a0522d;">ExecReload</span>=/bin/kill -s HUP $<span style="color: #a0522d;">MAINPID</span>
<span style="color: #a0522d;">KillSignal</span>=SIGQUIT
<span style="color: #a0522d;">TimeoutStopSec</span>=5
<span style="color: #a0522d;">KillMode</span>=process
<span style="color: #a0522d;">PrivateTmp</span>=true

[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target
</pre>
</div>

<p>
<b>Nginx 1.18.0</b> ：
</p>

<div class="org-src-container">
<pre class="src src-sh">cat &lt;&lt;\EOF&gt; /lib/systemd/system/nginx.service
<span style="color: #ffa54f;">[Unit]</span>
<span style="color: #ffa54f;">Description=The NGINX HTTP and reverse proxy server</span>
<span style="color: #ffa54f;">Documentation=http://nginx.org/en/docs/</span>
<span style="color: #ffa54f;">After=network-online.target remote-fs.target nss-lookup.target</span>
<span style="color: #ffa54f;">Wants=network-online.target</span>

<span style="color: #ffa54f;">[Service]</span>
<span style="color: #ffa54f;">Type=forking</span>
<span style="color: #ffa54f;">PIDFile=/apps/nginx/run/nginx.pid</span>
<span style="color: #ffa54f;">ExecStartPre=/apps/nginx/sbin/nginx -t</span>
<span style="color: #ffa54f;">ExecStart=/apps/nginx/sbin/nginx</span>
<span style="color: #ffa54f;">#ExecStart=/apps/nginx/sbin/nginx -c /apps/nginx/conf/nginx.conf</span>
<span style="color: #ffa54f;">ExecReload=/apps/nginx/sbin/nginx -s reload</span>
<span style="color: #ffa54f;">#ExecReload=/bin/kill -s HUP $MAINPID</span>
<span style="color: #ffa54f;">ExecStop=/bin/kill -s QUIT $MAINPID</span>
<span style="color: #ffa54f;">PrivateTmp=true</span>
<span style="color: #ffa54f;">LimitNOFILE=infinity</span>

<span style="color: #ffa54f;">[Install]</span>
<span style="color: #ffa54f;">WantedBy=multi-user.target</span>
<span style="color: #ffa54f;">EOF</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#26102;&#20063;&#35201;&#20462;&#25913;nginx&#30340;&#40664;&#35748;&#37197;&#32622;&#25991;&#20214;</span>
[root@Centos7 ~]#vim /apps/nginx/conf/nginx.conf
pid        /apps/nginx/run/nginx.pid;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;pid&#23384;&#25918;&#30446;&#24405;</span>
[root@Centos7 ~]#mkdir /apps/nginx/run/ -p
</pre>
</div>
</div>
</div>
<div id="outline-container-h:434b6c07-65fa-4747-9cec-ed957f806132" class="outline-5">
<h5 id="h:434b6c07-65fa-4747-9cec-ed957f806132">验证Nginx自启动脚本</h5>
<div class="outline-text-5" id="text-h:434b6c07-65fa-4747-9cec-ed957f806132">
<div class="org-src-container">
<pre class="src src-sh">[root@Centos7 nginx-1.18.0]# systemctl daemon-reload
[root@Centos7 nginx-1.18.0]# systemctl start nginx
[root@Centos7 nginx-1.18.0]# systemctl enable nginx
Created symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to
/usr/lib/systemd/system/nginx.service.

[root@Centos7 nginx-1.18.0]# systemctl status nginx
&#9679; nginx.service - nginx - high performance web server
   Loaded: loaded (/usr/lib/systemd/system/nginx.service; disabled; vendor preset: disabled)
   Active: active (running) since Tue 2020-07-14 15:20:35 CST; 32s ago
     Docs: http://nginx.org/en/docs/
  Process: 5048 <span style="color: #a0522d;">ExecStart</span>=/apps/nginx/sbin/nginx -c /apps/nginx/conf/nginx.conf (<span style="color: #a0522d;">code</span>=exited, <span style="color: #a0522d;">status</span>=0/SUCCESS)
 Main PID: 5049 (nginx)
   CGroup: /system.slice/nginx.service
           &#9500;&#9472;5049 nginx: master process /apps/nginx/sbin/nginx -c /apps/nginx/conf/nginx.conf
           &#9492;&#9472;5050 nginx: worker process

Jul 14 15:20:35 Centos7.8 systemd[1]: Starting nginx - high performance web server...
Jul 14 15:20:35 Centos7.8 systemd[1]: Started nginx - high performance web server.
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:4a1fd69f-6a41-4f8e-bfb5-5c84f5a58887" class="outline-4">
<h4 id="h:4a1fd69f-6a41-4f8e-bfb5-5c84f5a58887">logrotate日志切割</h4>
<div class="outline-text-4" id="text-h:4a1fd69f-6a41-4f8e-bfb5-5c84f5a58887">
<div class="org-src-container">
<pre class="src src-sh">cat &lt;&lt;\EOF &gt;/etc/logrotate.d/nginx
<span style="color: #ffa54f;">/var/log/nginx/*.log {</span>
<span style="color: #ffa54f;">    #su root root</span>
<span style="color: #ffa54f;">    daily</span>
<span style="color: #ffa54f;">    rotate 5</span>
<span style="color: #ffa54f;">    missingok</span>
<span style="color: #ffa54f;">    compress</span>
<span style="color: #ffa54f;">    #size 1M</span>
<span style="color: #ffa54f;">    delaycompress</span>
<span style="color: #ffa54f;">    notifempty</span>
<span style="color: #ffa54f;">    #create 644 ngnix nginx</span>
<span style="color: #ffa54f;">    dateext</span>
<span style="color: #ffa54f;">    #dateformat -%Y%m%d</span>
<span style="color: #ffa54f;">    copytruncate</span>
<span style="color: #ffa54f;">    sharedscripts</span>
<span style="color: #ffa54f;">    postrotate</span>
<span style="color: #ffa54f;">            if [ -f /usr/local/nginx/logs/nginx.pid ]; then</span>
<span style="color: #ffa54f;">                    kill -USR1 `cat /usr/local/nginx/logs/nginx.pid`</span>
<span style="color: #ffa54f;">            fi</span>
<span style="color: #ffa54f;">    endscript</span>
<span style="color: #ffa54f;">}</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fda12d25-e2f2-4fc8-a2be-1377dab1b4a1" class="outline-4">
<h4 id="h:fda12d25-e2f2-4fc8-a2be-1377dab1b4a1">Nginx 动态编译</h4>
<div class="outline-text-4" id="text-h:fda12d25-e2f2-4fc8-a2be-1377dab1b4a1">
<p>
参考：本章 <a href="#h:2398cc33-50cd-4173-b559-b94b63e1a12b">GeoIP2</a>
</p>
</div>
</div>
</div>
</section>
<section id="outline-container-h:eecb8e93-7543-4b00-a10c-afbfb79aa71c" class="outline-2">
<h2 id="h:eecb8e93-7543-4b00-a10c-afbfb79aa71c">Nginx 核心配置详解</h2>
<div class="outline-text-2" id="text-h:eecb8e93-7543-4b00-a10c-afbfb79aa71c">
</div>
<div id="outline-container-h:d3ded40a-84f9-4a29-911b-63589c0e3fa1" class="outline-3">
<h3 id="h:d3ded40a-84f9-4a29-911b-63589c0e3fa1">配置文件说明</h3>
<div class="outline-text-3" id="text-h:d3ded40a-84f9-4a29-911b-63589c0e3fa1">
<p>
nginx 官方帮助文档: <a href="http://nginx.org/en/docs/">http://nginx.org/en/docs/</a>
</p>

<p>
tengine 帮助文档: <a href="http://tengine.taobao.org/nginx_docs/cn/docs/">http://tengine.taobao.org/nginx_docs/cn/docs/</a>
</p>

<p>
Nginx的配置文件的组成部分：
</p>

<ul class="org-ul">
<li>主配置文件：nginx.conf</li>
<li>子配置文件 include conf.d/*.conf</li>
<li>fastcgi， uwsgi，scgi等协议相关的配置文件</li>
<li><p>
mime.types：支持的mime类型，MIME(Multipurpose Internet Mail
Extensions)多用途互联网邮件扩展类型，MIME消息能包含文本、图像、音频、
视频以及其他应用程序专用的数据，是设定某种扩展名的文件用一种应用程序
来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应
用程序来打开。多用于指定一些客户端自定义的文件名，以及一些媒体文件打
开方式。
</p>

<p>
MIME参考文档：<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types</a>
</p></li>
</ul>


<p>
Nginx主配置文件的配置指令方式：
</p>

<pre class="example" id="org34c6b6c">
directive value [value2 ...];

注意：
(1) 指令必须以分号结尾
(2) 支持使用配置变量
    内建变量：由Nginx模块引入，可直接引用
    自定义变量：由用户使用set命令定义，格式
               set variable_name value;
    引用变量：$variable_name
</pre>

<p>
主配置文件结构： 四部分
</p>

<ul class="org-ul">
<li>main 主配置段，即全局配置段，对http,mail都有效</li>
<li>event 事件驱动相关的配置</li>
<li>http : http/https 协议相关配置段</li>
<li>mail : mail 协议相关配置段</li>
<li>stream : 4层端口服务配置段</li>
</ul>

<pre class="example" id="org7b309a8">
main block：主配置段，即全局配置段，对http,mail都有效

#事件驱动相关的配置
event {
      ...
}

#http/https 协议相关配置段
http {
   ...
   server {
       ...
       server_name
       root
       alias
       location /uri/ {

       }
       ...
   server {
       ...
   }
}

#默认配置文件不包括下面两个块
#mail 协议相关配置段
mail {
     ...
}

#stream 服务器相关配置段
stream {
       ...
}
</pre>

<p>
<b>默认的 nginx.conf 配置文件格式说明</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@Centos7 ~]# grep -v <span style="color: #8b2252;">"#"</span> /apps/nginx/conf/nginx.conf | grep -v <span style="color: #8b2252;">"^$"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20840;&#23616;&#37197;&#32622;&#31471;&#65292;&#23545;&#20840;&#23616;&#29983;&#25928;&#65292;&#20027;&#35201;&#35774;&#32622;nginx&#30340;&#21551;&#21160;&#29992;&#25143;/&#32452;&#65292;&#21551;&#21160;&#30340;&#24037;&#20316;&#36827;&#31243;&#25968;&#37327;&#65292;&#24037;&#20316;&#27169;&#24335;&#65292;Nginx&#30340;PID&#36335;&#24452;&#65292;&#26085;&#24535;&#36335;&#24452;&#31561;&#12290;</span>
user nginx nginx;   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#29992;&#25143;&#21644;&#32452;&#26469;&#21551;&#21160;nginx</span>
worker_processes 1; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#24037;&#20316;&#36827;&#31243;&#25968;&#25968;&#37327;&#65292;&#25512;&#33616;&#21644;CPU&#25968;&#37327;&#20445;&#25345;&#19968;&#33268;</span>
events { <span style="color: #b22222;">#</span><span style="color: #b22222;">events&#35774;&#32622;&#24555;&#65292;&#20027;&#35201;&#24433;&#21709;nginx&#26381;&#21153;&#22120;&#19982;&#29992;&#25143;&#30340;&#32593;&#32476;&#36830;&#25509;&#65292;&#27604;&#22914;&#26159;&#21542;&#20801;&#35768;&#21516;&#26102;&#25509;&#21463;&#22810;&#20010;&#32593;&#32476;&#36830;&#25509;&#65292;&#20351;&#29992;&#21738;&#31181;&#20107;&#20214;&#39537;&#21160;&#27169;&#22411;&#22788;&#29702;&#35831;&#27714;&#65292;&#27599;&#20010;&#24037;&#20316;&#36827;&#31243;&#21487;&#20197;&#21516;&#26102;&#25903;&#25345;&#30340;&#26368;&#22823;&#36830;&#25509;&#25968;&#65292;&#26159;&#21542;&#24320;&#21551;&#23545;&#22810;&#24037;&#20316;&#36827;&#31243;&#19979;&#30340;&#32593;&#32476;&#36830;&#25509;&#36827;&#34892;&#24207;&#21015;&#21270;&#31561;&#12290;</span>
    worker_connections 1024; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#21333;&#20010;nginx&#24037;&#20316;&#36827;&#31243;&#21487;&#20197;&#25509;&#21463;&#30340;&#26368;&#22823;&#24182;&#21457;&#65292;&#20316;&#20026;web&#26381;&#21153;&#22120;&#30340;&#26102;&#20505;&#26368;&#22823;&#24182;&#21457;&#25968;&#20026;worker_connections * worker_processes&#65292;&#20316;&#20026;&#21453;&#21521;&#20195;&#29702;&#30340;&#26102;&#20505;&#20026;(worker_connections * worker_processes)/2</span>
}
http { <span style="color: #b22222;">#</span><span style="color: #b22222;">http&#22359;&#26159;Nginx&#26381;&#21153;&#22120;&#37197;&#32622;&#20013;&#30340;&#37325;&#35201;&#37096;&#20998;&#65292;&#32531;&#23384;&#12289;&#20195;&#29702;&#21644;&#26085;&#24535;&#26684;&#24335;&#23450;&#20041;&#31561;&#32477;&#22823;&#22810;&#25968;&#21151;&#33021;&#21644;&#31532;&#19977;&#26041;&#27169;&#22359;&#37117;&#21487;&#20197;&#22312;&#36825;&#35774;&#32622;&#65292;http&#22359;&#21487;&#20197;&#21253;&#21547;&#22810;&#20010;server&#22359;&#65292;&#32780;&#19968;&#20010;server&#22359;&#20013;&#21448;&#21487;&#20197;&#21253;&#21547;&#22810;&#20010;location&#22359;&#65292;server&#22359;&#21487;&#20197;&#37197;&#32622;&#25991;&#20214;&#24341;&#20837;&#12289;MIME-Type&#23450;&#20041;&#12289;&#26085;&#24535;&#33258;&#23450;&#20041;&#12289;&#26159;&#21542;&#21551;&#29992;sendfile&#12289;&#36830;&#25509;&#36229;&#26102;&#26102;&#38388;&#21644;&#21333;&#20010;&#38142;&#25509;&#30340;&#35831;&#27714;&#19978;&#38480;&#31561;&#12290;</span>
    include mime.types;
    default_type application/octet-stream;
    sendfile on; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20316;&#20026;web&#26381;&#21153;&#22120;&#30340;&#26102;&#20505;&#25171;&#24320;sendfile&#21152;&#24555;&#38745;&#24577;&#25991;&#20214;&#20256;&#36755;&#65292;&#25351;&#23450;&#26159;&#21542;&#20351;&#29992;sendfile&#31995;&#32479;&#35843;&#29992;&#26469;&#20256;&#36755;&#25991;&#20214;,sendfile&#31995;&#32479;&#35843;&#29992;&#22312;&#20004;&#20010;&#25991;&#20214;&#25551;&#36848;&#31526;&#20043;&#38388;&#30452;&#25509;&#20256;&#36882;&#25968;&#25454;(&#23436;&#20840;&#22312;&#20869;&#26680;&#20013;&#25805;&#20316;)&#65292;&#20174;&#32780;&#36991;&#20813;&#20102;&#25968;&#25454;&#22312;&#20869;&#26680;&#32531;&#20914;&#21306;&#21644;&#29992;&#25143;&#32531;&#20914;&#21306;&#20043;&#38388;&#30340;&#25335;&#36125;&#65292;&#25805;&#20316;&#25928;&#29575;&#24456;&#39640;&#65292;&#34987;&#31216;&#20043;&#20026;&#38646;&#25335;&#36125;&#65292;&#30828;&#30424; &gt;&gt; kernel buffer (&#24555;&#36895;&#25335;&#36125;&#21040;kernelsocket buffer) &gt;&gt;&#21327;&#35758;&#26632;&#12290;</span>
    keepalive_timeout 65; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38271;&#36830;&#25509;&#36229;&#26102;&#26102;&#38388;&#65292;&#21333;&#20301;&#26159;&#31186;</span>
    server { <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#19968;&#20010;&#34394;&#25311;&#26426;&#20027;&#26426;&#65292;&#21487;&#20197;&#21253;&#21547;&#33258;&#24049;&#30340;&#20840;&#23616;&#24555;&#65292;&#21516;&#26102;&#20063;&#21487;&#20197;&#21253;&#21547;&#22810;&#20010;location&#27169;&#22359;&#12290;&#27604;&#22914;&#26412;&#34394;&#25311;&#26426;&#30417;&#21548;&#30340;&#31471;&#21475;&#12289;&#26412;&#34394;&#25311;&#26426;&#30340;&#21517;&#31216;&#21644;IP&#37197;&#32622;&#65292;&#22810;&#20010;server &#21487;&#20197;&#20351;&#29992;&#19968;&#20010;&#31471;&#21475;&#65292;&#27604;&#22914;&#37117;&#20351;&#29992;80&#31471;&#21475;&#25552;&#20379;web&#26381;&#21153;&#12289;</span>
        listen 80; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;server&#30417;&#21548;&#30340;&#31471;&#21475;</span>
        server_name localhost;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26412;server&#30340;&#21517;&#31216;&#65292;&#24403;&#35775;&#38382;&#27492;&#21517;&#31216;&#30340;&#26102;&#20505;nginx&#20250;&#35843;&#29992;&#24403;&#21069;serevr&#20869;&#37096;&#30340;&#37197;&#32622;&#36827;&#31243;&#21305;&#37197;&#12290;</span>
        location / { <span style="color: #b22222;">#</span><span style="color: #b22222;">location&#20854;&#23454;&#26159;server&#30340;&#19968;&#20010;&#25351;&#20196;&#65292;&#20026;nginx&#26381;&#21153;&#22120;&#25552;&#20379;&#27604;&#36739;&#22810;&#32780;&#19988;&#28789;&#27963;&#30340;&#25351;&#20196;&#65292;&#37117;&#26159;&#22312;location&#20013;&#20307;&#29616;&#30340;&#65292;&#20027;&#35201;&#26159;&#22522;&#20110;nginx&#25509;&#21463;&#21040;&#30340;&#35831;&#27714;&#23383;&#31526;&#20018;&#65292;&#23545;&#29992;&#25143;&#35831;&#27714;&#30340;UIL&#36827;&#34892;&#21305;&#37197;&#65292;&#24182;&#23545;&#29305;&#23450;&#30340;&#25351;&#20196;&#36827;&#34892;&#22788;&#29702;&#65292;&#21253;&#25324;&#22320;&#22336;&#37325;&#23450;&#21521;&#12289;&#25968;&#25454;&#32531;&#23384;&#21644;&#24212;&#31572;&#25511;&#21046;&#31561;&#21151;&#33021;&#37117;&#26159;&#22312;&#36825;&#37096;&#20998;&#23454;&#29616;&#65292;&#21478;&#22806;&#24456;&#22810;&#31532;&#19977;&#26041;&#27169;&#22359;&#30340;&#37197;&#32622;&#20063;&#26159;&#22312;location&#27169;&#22359;&#20013;&#37197;&#32622;&#12290;</span>
            root html; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#24403;&#20110;&#40664;&#35748;&#39029;&#38754;&#30340;&#30446;&#24405;&#21517;&#31216;&#65292;&#40664;&#35748;&#26159;&#30456;&#23545;&#36335;&#24452;&#65292;&#21487;&#20197;&#20351;&#29992;&#32477;&#23545;&#36335;&#24452;&#37197;&#32622;&#12290;</span>
            index index.html index.htm; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#30340;&#39029;&#38754;&#25991;&#20214;&#21517;&#31216;</span>
        }
        error_page 500 502 503 504 /50x.html; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38169;&#35823;&#39029;&#38754;&#30340;&#25991;&#20214;&#21517;&#31216;</span>
        location = /50x.html { <span style="color: #b22222;">#</span><span style="color: #b22222;">location&#22788;&#29702;&#23545;&#24212;&#30340;&#19981;&#21516;&#38169;&#35823;&#30721;&#30340;&#39029;&#38754;&#23450;&#20041;&#21040;/50x.html&#65292;&#36825;&#20010;&#36319;&#23545;&#24212;&#20854;server&#20013;&#23450;&#20041;&#30340;&#30446;&#24405;&#19979;&#12290;</span>
            root   html; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#40664;&#35748;&#39029;&#38754;&#25152;&#22312;&#30340;&#30446;&#24405;</span>
        }
    }

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21644;&#37038;&#20214;&#30456;&#20851;&#30340;&#37197;&#32622;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">mail {</span>
<span style="color: #b22222;">#           </span><span style="color: #b22222;">...</span>
<span style="color: #b22222;">#         </span><span style="color: #b22222;">}         mail &#21327;&#35758;&#30456;&#20851;&#37197;&#32622;&#27573;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">tcp&#20195;&#29702;&#37197;&#32622;&#65292;1.9&#29256;&#26412;&#20197;&#19978;&#25903;&#25345;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">stream {</span>
<span style="color: #b22222;">#           </span><span style="color: #b22222;">...</span>
<span style="color: #b22222;">#        </span><span style="color: #b22222;">}          stream &#26381;&#21153;&#22120;&#30456;&#20851;&#37197;&#32622;&#27573;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20837;&#20854;&#20182;&#36335;&#24452;&#30340;&#37197;&#32622;&#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">include /apps/nginx/conf.d/*.conf</span>
}
</pre>
</div>

<p>
说明：
</p>

<p>
web服务器的总链接=工作进程数*单个工作进程最大并发值
</p>

<p>
七层反向代理服务器= ( 工作进程数*单个工作进程最大并发值 ) /2
</p>
</div>
</div>
<div id="outline-container-h:84ddb0d5-3449-48f8-bd22-7606f9c0b252" class="outline-3">
<h3 id="h:84ddb0d5-3449-48f8-bd22-7606f9c0b252">main 全局配置</h3>
<div class="outline-text-3" id="text-h:84ddb0d5-3449-48f8-bd22-7606f9c0b252">
<p>
Main 全局配置段常见的配置指令分类
</p>
<ul class="org-ul">
<li>正常运行必备的配置</li>
<li>优化性能相关的配置</li>
<li>用于调试及定位问题相关的配置</li>
<li>事件驱动相关的配置</li>
</ul>


<p>
全局配置说明：
</p>
<div class="org-src-container">
<pre class="src src-sh">user nginx nginx; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;Nginx&#24037;&#20316;&#36827;&#31243;&#30340;&#29992;&#25143;&#21644;&#32452;</span>
worker_processes [number | auto]; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;Nginx&#24037;&#20316;&#36827;&#31243;&#30340;&#25968;&#37327;</span>
worker_cpu_affinity 00000001 00000010 00000100 00001000; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;Nginx&#24037;&#20316;&#36827;&#31243;&#32465;&#23450;&#21040;&#25351;&#23450;&#30340;CPU&#26680;&#24515;&#65292;&#40664;&#35748;Nginx&#26159;&#19981;&#36827;&#34892;&#36827;&#31243;&#32465;&#23450;&#30340;&#65292;&#32465;&#23450;&#24182;&#19981;&#26159;&#24847;&#21619;&#30528;&#24403;&#21069;nginx&#36827;&#31243;&#29420;&#21344;&#20197;&#19968;&#26680;&#24515;CPU&#65292;&#20294;&#26159;&#21487;&#20197;&#20445;&#35777;&#27492;&#36827;&#31243;&#19981;&#20250;&#36816;&#34892;&#22312;&#20854;&#20182;&#26680;&#24515;&#19978;&#65292;&#36825;&#23601;&#26497;&#22823;&#20943;&#23569;&#20102;nginx&#30340;&#24037;&#20316;&#36827;&#31243;&#22312;&#19981;&#21516;&#30340;cpu&#26680;&#24515;&#19978;&#30340;&#26469;&#22238;&#36339;&#36716;&#65292;&#20943;&#23569;&#20102;CPU&#23545;&#36827;&#31243;&#30340;&#36164;&#28304;&#20998;&#37197;&#19982;&#22238;&#25910;&#20197;&#21450;&#20869;&#23384;&#31649;&#29702;&#31561;&#65292;&#22240;&#27492;&#21487;&#20197;&#26377;&#25928;&#30340;&#25552;&#21319;nginx&#26381;&#21153;&#22120;&#30340;&#24615;&#33021;&#12290;</span>
CPU MASK: 00000001&#65306;0&#21495;CPU
          00000010&#65306;1&#21495;CPU
          10000000&#65306;7&#21495;CPU

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;:</span>
worker_cpu_affinity 0001 0010 0100 1000;&#31532;0&#21495;---&#31532;3&#21495;CPU
worker_cpu_affinity 0101 1010;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;</span>
worker_processes  4;
worker_cpu_affinity 00000010 00001000 00100000 10000000;
[root@centos8 ~]# ps axo pid,cmd,psr | grep nginx

[root@Centos7 ~]#ps axo pid,cmd,psr,user | grep nginx
4106 nginx: master process /apps   1 root
4181 nginx: worker process         0 nginx
4182 nginx: worker process         1 nginx
4184 grep --color=auto nginx       0 root

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38169;&#35823;&#26085;&#24535;&#35760;&#24405;&#37197;&#32622;&#65292;&#35821;&#27861;&#65306;error_log file [debug | info | notice | warn | error | crit |alert | emerg]</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">error_log logs/error.log;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">error_log logs/error.log notice;</span>
error_log /apps/nginx/logs/error.log error;

<span style="color: #b22222;">#</span><span style="color: #b22222;">pid&#25991;&#20214;&#20445;&#23384;&#36335;&#24452;</span>
pid     /apps/nginx/logs/nginx.pid;

worker_priority 0; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24037;&#20316;&#36827;&#31243;nice&#20540;&#65292;-20~19</span>
worker_rlimit_nofile 65536; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#20010;&#25968;&#23383;&#21253;&#25324;Nginx&#30340;&#25152;&#26377;&#36830;&#25509;&#65288;&#20363;&#22914;&#19982;&#20195;&#29702;&#26381;&#21153;&#22120;&#30340;&#36830;&#25509;&#31561;&#65289;&#65292;&#32780;&#19981;&#20165;&#20165;&#26159;&#19982;&#23458;&#25143;&#31471;&#30340;&#36830;&#25509;,&#21478;&#19968;&#20010;&#32771;&#34385;&#22240;&#32032;&#26159;&#23454;&#38469;&#30340;&#24182;&#21457;&#36830;&#25509;&#25968;&#19981;&#33021;&#36229;&#36807;&#31995;&#32479;&#32423;&#21035;&#30340;&#26368;&#22823;&#25171;&#24320;&#25991;&#20214;&#25968;&#30340;&#38480;&#21046;.</span>

[root@Centos7 ~]# watch -n1 <span style="color: #8b2252;">'ps -axo pid,cmd,nice | grep nginx'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#36827;&#31243;&#20248;&#20808;&#32423;</span>

daemon off; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21069;&#21488;&#36816;&#34892;Nginx&#26381;&#21153;&#29992;&#20110;&#27979;&#35797;&#12289;docker&#31561;&#29615;&#22659;&#12290;</span>
master_process off|on; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#24320;&#21551;Nginx&#30340;master-woker&#24037;&#20316;&#27169;&#24335;&#65292;&#20165;&#29992;&#20110;&#24320;&#21457;&#35843;&#35797;&#22330;&#26223;&#12290;</span>

events { <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20107;&#20214;&#27169;&#22411;&#37197;&#32622;&#21442;&#25968;</span>
    worker_connections 65536; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#21333;&#20010;&#24037;&#20316;&#36827;&#31243;&#30340;&#26368;&#22823;&#24182;&#21457;&#36830;&#25509;&#25968;</span>
    use epoll; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;epoll&#20107;&#20214;&#39537;&#21160;&#65292;Nginx&#25903;&#25345;&#20247;&#22810;&#30340;&#20107;&#20214;&#39537;&#21160;&#65292;&#27604;&#22914;select&#12289;poll&#12289;epoll&#65292;&#21482;&#33021;&#35774;&#32622;&#22312;events&#27169;&#22359;&#20013;&#35774;&#32622;&#12290;</span>
    accept_mutex on; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20248;&#21270;&#21516;&#19968;&#26102;&#21051;&#21482;&#26377;&#19968;&#20010;&#35831;&#27714;&#32780;&#36991;&#20813;&#22810;&#20010;&#30561;&#30496;&#36827;&#31243;&#34987;&#21796;&#37266;&#30340;&#35774;&#32622;&#65292;on&#20026;&#38450;&#27490;&#34987;&#21516;&#26102;&#21796;&#37266;&#65292;&#40664;&#35748;&#20026;off&#65292;&#20840;&#37096;&#21796;&#37266;&#30340;&#36807;&#31243;&#20063;&#25104;&#20026;"&#24778;&#32676;"&#65292;&#22240;&#27492;nginx&#21018;&#23433;&#35013;&#23436;&#20197;&#21518;&#35201;&#36827;&#34892;&#36866;&#24403;&#30340;&#20248;&#21270;&#12290;</span>
    multi_accept on; <span style="color: #b22222;">#</span><span style="color: #b22222;">Nginx&#26381;&#21153;&#22120;&#30340;&#27599;&#20010;&#24037;&#20316;&#36827;&#31243;&#21487;&#20197;&#21516;&#26102;&#25509;&#21463;&#22810;&#20010;&#26032;&#30340;&#32593;&#32476;&#36830;&#25509;&#65292;&#20294;&#26159;&#38656;&#35201;&#22312;&#37197;&#32622;&#25991;&#20214;&#20013;&#37197;&#32622;&#65292;&#27492;&#25351;&#20196;&#40664;&#35748;&#20026;&#20851;&#38381;&#65292;&#21363;&#40664;&#35748;&#20026;&#19968;&#20010;&#24037;&#20316;&#36827;&#31243;&#21482;&#33021;&#19968;&#27425;&#25509;&#21463;&#19968;&#20010;&#26032;&#30340;&#32593;&#32476;&#36830;&#25509;&#65292;&#25171;&#24320;&#21518;&#20960;&#20010;&#21516;&#26102;&#25509;&#21463;&#22810;&#20010;&#12290;&#24314;&#35758;&#35774;&#32622;&#20026;on</span>
}
</pre>
</div>

<p>
范例: 实现 nginx 的高并发配置
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#ulimit -n 102400
[root@centos7 ~]#while true;<span style="color: #a020f0;">do</span> ab -c 5000 -n 10000 http://10.0.0.8/;sleep 0.5;<span style="color: #a020f0;">done</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#37197;&#32622;&#19981;&#25903;&#25345;&#39640;&#24182;&#21457;,&#20250;&#20986;&#29616;&#20197;&#19979;&#38169;&#35823;&#26085;&#24535;</span>
[root@centos8 conf]#tail /apps/nginx/logs/error.log

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;</span>
[root@centos8 ~]#vim /etc/security/limits.conf
*  - nproc 100000

[root@centos8 ~]#vim /apps/nginx/conf/nginx.conf
worker_rlimit_nofile 100000;
[root@centos8 ~]#systemctl restart nginx
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6918de9f-25ec-450a-9471-aa97ecf1f85b" class="outline-3">
<h3 id="h:6918de9f-25ec-450a-9471-aa97ecf1f85b">http配置块</h3>
<div class="outline-text-3" id="text-h:6918de9f-25ec-450a-9471-aa97ecf1f85b">
<pre class="example" id="org5c93c7a">
http {
     ...
     ...  #各server的公共配置
     server {   #每个server用于定义一个虚拟主机,第一个server为默认虚拟服务器
            ...
     }
     server {
            ...
            server_name  #虚拟主机名
            root   #主目录
            alias   #路径别名
            location [OPERATOR] URL {   #指定URL的特性
                     ...
                     if CONDITION {
                        ...
                     }
            }
     }
}
</pre>

<p>
http 协议配置说明
</p>
<div class="org-src-container">
<pre class="src src-sh">http {
    include       mime.types;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20837;&#25903;&#25345;&#30340;&#25991;&#20214;&#31867;&#22411;</span>
    default_type  application/octet-stream; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#40664;&#35748;&#30340;&#31867;&#22411;&#65292;&#20250;&#25552;&#31034;&#19979;&#36733;&#19981;&#21305;&#37197;&#30340;&#31867;&#22411;&#25991;&#20214;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26085;&#24535;&#37197;&#32622;&#37096;&#20998;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span>
    <span style="color: #b22222;">#                  </span><span style="color: #b22222;">'$status $body_bytes_sent "$http_referer" '</span>
    <span style="color: #b22222;">#                  </span><span style="color: #b22222;">'"$http_user_agent" "$http_x_forwarded_for"';</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">access_log  logs/access.log  main;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#23450;&#20041;&#20248;&#21270;&#21442;&#25968;</span>
    sendfile        on; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23454;&#29616;&#25991;&#20214;&#38646;&#25335;&#36125;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">tcp_nopush     on; #&#22312;&#24320;&#21551;&#20102;sendfile&#30340;&#24773;&#20917;&#19979;&#65292;&#21512;&#24182;&#35831;&#27714;&#21518;&#32479;&#19968;&#21457;&#36865;&#32473;&#23458;&#25143;&#31471;&#12290;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">tcp_nodelay   off; #&#22312;&#24320;&#21551;&#20102;keepalived&#27169;&#24335;&#19979;&#30340;&#36830;&#25509;&#26159;&#21542;&#21551;&#29992;TCP_NODELAY&#36873;&#39033;&#65292;&#24403;&#20026;off&#26102;&#65292;&#24310;&#36831;0.2s&#21457;&#36865;&#65292;&#40664;&#35748;On&#26102;&#65292;&#19981;&#24310;&#36831;&#21457;&#36865;&#65292;&#31435;&#21363;&#21457;&#36865;&#29992;&#25143;&#30456;&#24212;&#25253;&#25991;&#12290;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">keepalive_timeout  0;</span>
    keepalive_timeout  65;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#20250;&#35805;&#20445;&#25345;&#26102;&#38388;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">gzip  on; #&#24320;&#21551;&#25991;&#20214;&#21387;&#32553;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#19968;&#20010;&#34394;&#25311;&#20027;&#26426;</span>
    server {
        listen       80; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#30417;&#21548;&#22320;&#22336;&#21644;&#31471;&#21475;</span>
        server_name  localhost; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;server name&#65292;&#21487;&#20197;&#20197;&#31354;&#26684;&#38548;&#24320;&#20889;&#22810;&#20010;&#24182;&#25903;&#25345;&#27491;&#21017;&#34920;&#36798;&#24335;&#65292;&#22914;*.cici.com www.cici.* www.(site\d+)\.cici\.com$ default_server</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">charset koi8-r; #&#35774;&#32622;&#32534;&#30721;&#26684;&#24335;&#65292;&#40664;&#35748;&#26159;&#20420;&#35821;&#26684;&#24335;&#65292;&#21487;&#20197;&#25913;&#20026;utf-8</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">access_log  logs/host.access.log  main;</span>
        location / {
            root   html;
            index  index.html index.htm;
        }

        <span style="color: #b22222;">#</span><span style="color: #b22222;">error_page  404              /404.html;</span>

        <span style="color: #b22222;"># </span><span style="color: #b22222;">redirect server error pages to the static page /50x.html</span>
        <span style="color: #b22222;">#</span>
        error_page   500 502 503 504  /50x.html; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#38169;&#35823;&#39029;&#38754;</span>
        location = /50x.html {
            root   html;
        }

        <span style="color: #b22222;"># </span><span style="color: #b22222;">proxy the PHP scripts to Apache listening on 127.0.0.1:80</span>
        <span style="color: #b22222;">#</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">location ~ \.php$ {  #&#20197;http&#30340;&#26041;&#24335;&#36716;&#21457;php&#35831;&#27714;&#21040;&#25351;&#23450;web&#26381;&#21153;&#22120;</span>
        <span style="color: #b22222;">#    </span><span style="color: #b22222;">proxy_pass   http://127.0.0.1;</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">}</span>

        <span style="color: #b22222;"># </span><span style="color: #b22222;">pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span>
        <span style="color: #b22222;">#</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">location ~ \.php$ {  #&#20197;fastcgi&#30340;&#26041;&#24335;&#36716;&#21457;php&#35831;&#27714;&#21040;php&#22788;&#29702;</span>
        <span style="color: #b22222;">#    </span><span style="color: #b22222;">root           html;</span>
        <span style="color: #b22222;">#    </span><span style="color: #b22222;">fastcgi_pass   127.0.0.1:9000;</span>
        <span style="color: #b22222;">#    </span><span style="color: #b22222;">fastcgi_index  index.php;</span>
        <span style="color: #b22222;">#    </span><span style="color: #b22222;">fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span>
        <span style="color: #b22222;">#    </span><span style="color: #b22222;">include        fastcgi_params;</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">}</span>

        <span style="color: #b22222;"># </span><span style="color: #b22222;">deny access to .htaccess files, if Apache's document root</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">concurs with nginx's one</span>
        <span style="color: #b22222;">#</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">location ~ /\.ht {  #&#25298;&#32477;web&#24418;&#24335;&#35775;&#38382;&#25351;&#23450;&#25991;&#20214;&#65292;&#22914;&#24456;&#22810;&#30340;&#32593;&#31449;&#37117;&#26159;&#36890;&#36807;.htaccess&#25991;&#20214;&#26469;&#25913;&#21464;&#33258;&#24049;&#30340;&#37325;&#23450;&#21521;&#31561;&#21151;&#33021;&#12290;</span>
        <span style="color: #b22222;">#    </span><span style="color: #b22222;">deny  all;</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">}</span>
        location ~ /passwd.html {
            deny all;
        }
    }


    <span style="color: #b22222;"># </span><span style="color: #b22222;">another virtual host using mix of IP-, name-, and port-based configuration</span>
    <span style="color: #b22222;">#</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">server {  #&#33258;&#23450;&#20041;&#34394;&#25311;server</span>
    <span style="color: #b22222;">#    </span><span style="color: #b22222;">listen       8000;</span>
    <span style="color: #b22222;">#    </span><span style="color: #b22222;">listen       somename:8080;</span>
    <span style="color: #b22222;">#    </span><span style="color: #b22222;">server_name  somename  alias  another.alias;</span>

    <span style="color: #b22222;">#    </span><span style="color: #b22222;">location / {</span>
    <span style="color: #b22222;">#        </span><span style="color: #b22222;">root   html;</span>
    <span style="color: #b22222;">#        </span><span style="color: #b22222;">index  index.html index.htm; #&#25351;&#23450;&#40664;&#35748;&#32593;&#39029;&#25991;&#20214;&#65292;&#27492;&#25351;&#20196;&#30001;ngx_http_index_module&#27169;&#22359;&#25552;&#20379;</span>
    <span style="color: #b22222;">#    </span><span style="color: #b22222;">}</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">}</span>


    <span style="color: #b22222;"># </span><span style="color: #b22222;">HTTPS server</span>
    <span style="color: #b22222;">#</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">server {  #https&#26381;&#21153;&#22120;&#37197;&#32622;</span>
    <span style="color: #b22222;">#    </span><span style="color: #b22222;">listen       443 ssl;</span>
    <span style="color: #b22222;">#    </span><span style="color: #b22222;">server_name  localhost;</span>

    <span style="color: #b22222;">#    </span><span style="color: #b22222;">ssl_certificate      cert.pem;</span>
    <span style="color: #b22222;">#    </span><span style="color: #b22222;">ssl_certificate_key  cert.key;</span>

    <span style="color: #b22222;">#    </span><span style="color: #b22222;">ssl_session_cache    shared:SSL:1m;</span>
    <span style="color: #b22222;">#    </span><span style="color: #b22222;">ssl_session_timeout  5m;</span>

    <span style="color: #b22222;">#    </span><span style="color: #b22222;">ssl_ciphers  HIGH:!aNULL:!MD5;</span>
    <span style="color: #b22222;">#    </span><span style="color: #b22222;">ssl_prefer_server_ciphers  on;</span>

    <span style="color: #b22222;">#    </span><span style="color: #b22222;">location / {</span>
    <span style="color: #b22222;">#        </span><span style="color: #b22222;">root   html;</span>
    <span style="color: #b22222;">#        </span><span style="color: #b22222;">index  index.html index.htm;</span>
    <span style="color: #b22222;">#    </span><span style="color: #b22222;">}</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">}</span>
}
</pre>
</div>
</div>
<div id="outline-container-h:47c4b0a6-be8e-4f24-acce-bfa7b2c186a3" class="outline-4">
<h4 id="h:47c4b0a6-be8e-4f24-acce-bfa7b2c186a3">MIME</h4>
<div class="outline-text-4" id="text-h:47c4b0a6-be8e-4f24-acce-bfa7b2c186a3">
<pre class="example" id="org4a72319">
#在响应报文中将指定的文件扩展名映射至MIME对应的类型
include      /etc/nginx/mime.types;
default_type   application/octet-stream;#除mime.types中的类型外，指定其它文件的默认MIME类型，浏览器一般会提示下载
types {
 text/html html;
 image/gif gif;
 image/jpeg jpg;
}

</pre>

<p>
MIME参考文档：
<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types</a>
</p>

<p>
范例: 识别php文件为text/html
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /apps/nginx/html/test.php
&lt;?php
<span style="color: #0000ff;">phpinfo</span>();
?&gt;

[root@centos7 ~]#curl 10.0.0.8/test.php -I
HTTP/1.1 200 OK
Server: nginx/1.18.0
Date: Thu, 24 Sep 2020 13:54:39 GMT
Content-Type: application/octet-stream
Content-Length: 20
Last-Modified: Thu, 24 Sep 2020 13:53:26 GMT
Connection: keep-alive
ETag: <span style="color: #8b2252;">"5f6ca4d6-14"</span>
Accept-Ranges: bytes

[root@centos8 ~]#vim /apps/nginx/conf/nginx.conf
http {
 include    mime.types;
 default_type text/html;
......
[root@centos8 ~]#nginx -s reload

[root@centos7 ~]#curl 10.0.0.8/index.html -I
HTTP/1.1 200 OK
Server: nginx/1.18.0
Date: Thu, 24 Sep 2020 13:56:26 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Thu, 24 Sep 2020 12:13:03 GMT
Connection: keep-alive
ETag: <span style="color: #8b2252;">"5f6c8d4f-264"</span>
Accept-Ranges: bytes
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e6be0cdf-8f39-41ff-bc2c-9eb0b67e7132" class="outline-4">
<h4 id="h:e6be0cdf-8f39-41ff-bc2c-9eb0b67e7132">指定响应报文server首部</h4>
<div class="outline-text-4" id="text-h:e6be0cdf-8f39-41ff-bc2c-9eb0b67e7132">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#22312;&#21709;&#24212;&#25253;&#25991;&#20013;&#30340;Content-Type&#26174;&#31034;&#25351;&#23450;&#30340;&#23383;&#31526;&#38598;&#65292;&#40664;&#35748;off&#19981;&#26174;&#31034;</span>
charset charset | off;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;</span>
charset utf-8;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#22312;&#21709;&#24212;&#25253;&#25991;&#30340;Server&#39318;&#37096;&#26174;&#31034;nginx&#29256;&#26412;</span>
server_tokens on | off | build | string;
</pre>
</div>

<p>
范例: 修改server字段
</p>
<div class="org-src-container">
<pre class="src src-sh">&#22914;&#26524;&#24819;&#33258;&#23450;&#20041;&#21709;&#24212;&#25253;&#25991;&#30340;nginx&#29256;&#26412;&#20449;&#24687;&#65292;&#38656;&#35201;&#20462;&#25913;&#28304;&#30721;&#25991;&#20214;&#65292;&#37325;&#26032;&#32534;&#35793;
&#22914;&#26524;server_tokens on&#65292;&#20462;&#25913; src/core/nginx.h &#20462;&#25913;&#31532;13-14&#34892;&#65292;&#22914;&#19979;&#31034;&#20363;
<span style="color: #b22222;">#</span><span style="color: #b22222;">define NGINX_VERSION   "1.68.9"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">define NGINX_VER     "cicinginx/" NGINX_VERSION</span>

&#22914;&#26524;server_tokens off&#65292;&#20462;&#25913; src/http/ngx_http_header_filter_module.c
&#31532;49&#34892;&#65292;&#22914;&#19979;&#31034;&#20363;&#65306;
static char ngx_http_server_string[] = <span style="color: #8b2252;">"Server: nginx"</span> CRLF;
&#25226;&#20854;&#20013;&#30340;nginx&#25913;&#20026;&#33258;&#24049;&#24819;&#35201;&#30340;&#25991;&#23383;&#21363;&#21487;,&#22914;&#65306;cicinginx
</pre>
</div>

<p>
范例: 修改 Server 头部信息
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /usr/local/src/nginx-1.18.0/src/core/nginx.h
<span style="color: #b22222;">#</span><span style="color: #b22222;">define NGINX_VERSION   "1.68.9"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">define NGINX_VER     "cicinginx/" NGINX_VERSION</span>

[root@centos8 ~]#vim nginx-1.18.0/src/http/ngx_http_header_filter_module.c
static u_char ngx_http_server_string[] = <span style="color: #8b2252;">"Server: cici-nginx"</span> CRLF;

[root@centos7 ~]#curl -I www.cici.org
HTTP/1.1 200 OK
Server: ciciginx/1.68.9
Date: Thu, 24 Sep 2020 07:44:05 GMT
Content-Type: text/html
Content-Length: 8
Last-Modified: Wed, 23 Sep 2020 14:39:21 GMT
Connection: keep-alive
ETag: <span style="color: #8b2252;">"5f6b5e19-8"</span>
Accept-Ranges: bytes

[root@centos8 ~]#vim /apps/nginx/conf/conf.d/pc.conf
server {
  ......
  server_tokens off;
  ......

[root@centos7 ~]#curl -I www.cici.org
HTTP/1.1 200 OK
Server: cici-nginx
Date: Thu, 24 Sep 2020 07:44:59 GMT
Content-Type: text/html
Content-Length: 8
Last-Modified: Wed, 23 Sep 2020 14:39:21 GMT
Connection: keep-alive
ETag: <span style="color: #8b2252;">"5f6b5e19-8"</span>
Accept-Ranges: bytes
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:7ee84902-f6f7-4721-ba10-bfaa9efaac92" class="outline-3">
<h3 id="h:7ee84902-f6f7-4721-ba10-bfaa9efaac92">核心配置示例</h3>
<div class="outline-text-3" id="text-h:7ee84902-f6f7-4721-ba10-bfaa9efaac92">
<p>
基于不同的IP、不同的端口以及不用得域名实现不同的虚拟主机，依赖于核心模块ngx_http_core_module实现。
</p>
</div>
<div id="outline-container-h:e5de5f0c-a9a8-4186-ae73-f03ac3657f01" class="outline-4">
<h4 id="h:e5de5f0c-a9a8-4186-ae73-f03ac3657f01">新建一个PC web站点</h4>
<div class="outline-text-4" id="text-h:e5de5f0c-a9a8-4186-ae73-f03ac3657f01">
<div class="org-src-container">
<pre class="src src-sh">[root@s2 ~]# mkdir /apps/nginx/conf/conf.d
[root@s2 ~]# vim /apps/nginx/conf/nginx.conf
http {
    ......
    include /apps/nginx/conf/conf.d/*.conf; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#37197;&#32622;&#25991;&#20214;&#30340;&#26368;&#21518;&#38754;&#28155;&#21152;&#27492;&#34892;</span>
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;PC&#32593;&#31449;&#37197;&#32622;</span>
[root@s2 ~]# cat /apps/nginx/conf/conf.d/pc.conf
server {
  listen 80;
  server_name www.cici.net;
  location / {
    root /data/nginx/html/pc;
  }
}

[root@s2 ~]# mkdir /data/nginx/html/pc -p
[root@s2 ~]# echo <span style="color: #8b2252;">"pc web"</span> &gt; /data/nginx/html/pc/index.html

[root@s2 ~]# systemctl reload nginx
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#27979;&#35797;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8cdfd448-b932-46fa-932c-50808f74bc3a" class="outline-4">
<h4 id="h:8cdfd448-b932-46fa-932c-50808f74bc3a">新建一个Mobile web站点</h4>
<div class="outline-text-4" id="text-h:8cdfd448-b932-46fa-932c-50808f74bc3a">
<div class="org-src-container">
<pre class="src src-sh">[root@s2 ~]# cat /apps/nginx/conf/conf.d/mobile.conf
server {
  listen 80;
  server_name mobile.cici.net;
  location / {
    root /data/nginx/html/mobile;
  }
}

[root@s2 ~]# mkdir /data/nginx/html/mobile -p
[root@s2 ~]# echo <span style="color: #8b2252;">"mobile web"</span> &gt;&gt; /data/nginx/html/mobile/index.html

[root@s2 ~]# systemctl reload nginx
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e770b4d8-1c49-4eb8-946f-e0df620e7550" class="outline-4">
<h4 id="h:e770b4d8-1c49-4eb8-946f-e0df620e7550">root与alias：</h4>
<div class="outline-text-4" id="text-h:e770b4d8-1c49-4eb8-946f-e0df620e7550">
<p>
root：指定web的家目录，在定义location的时候，文件的绝对路径等于
root+location
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">server {
  listen 80;
  server_name www.cici.net;
  location / {
    root /data/nginx/html/pc;
  }

  location /about {
    root /data/nginx/html/pc; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24517;&#39035;&#35201;&#22312;html&#30446;&#24405;&#20013;&#21019;&#24314;&#19968;&#20010;about&#30446;&#24405;&#25165;&#21487;&#20197;&#35775;&#38382;&#65292;&#21542;&#21017;&#25253;&#38169;&#12290;</span>
    index index.html;
  }
}

[root@s2 ~]# mkdir /data/nginx/html/pc/about
[root@s2 ~]# echo about &gt; /data/nginx/html/pc/about/index.html

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#27979;&#35797;</span>
</pre>
</div>

<p>
alias：定义路径别名，会把访问的路径重新定义到其指定的路径,文档映射的另一种机制;仅能用于
location上下文,此指令使用较少
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">server {
  listen 80;
  server_name www.cici.net;
  location / {
    root /data/nginx/html/pc;
  }

  location /about { <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;alias&#30340;&#26102;&#20505;uri&#21518;&#38754;&#22914;&#26524;&#21152;&#20102;&#26012;&#26464;&#21017;&#19979;&#38754;&#30340;&#36335;&#24452;&#37197;&#32622;&#24517;&#39035;&#21152;&#26012;&#26464;&#65292;&#21542;&#21017;403</span>
    <span style="color: #483d8b;">alias</span> /data/nginx/html/pc; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#35775;&#38382;about&#30340;&#26102;&#20505;&#65292;&#20250;&#26174;&#31034;alias&#23450;&#20041;&#30340;/data/nginx/html/pc&#37324;&#38754;&#30340;&#20869;&#23481;&#12290;</span>
    index index.html;
  }
}

&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#27979;&#35797;
http://www.cici.net/about/index.html <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#25351;&#23450;&#25991;&#20214;&#36164;&#28304;</span>
</pre>
</div>

<p>
注意：location中使用root指令和alias指令的意义不同
</p>
<pre class="example" id="orge0926a3">
root，给定的路径对应于location中的/uri 左侧的/
alias，给定的路径对应于location中的/uri 的完整路径
</pre>
</div>
</div>
<div id="outline-container-h:81216047-8fdf-48a3-94d7-896f474e8a86" class="outline-4">
<h4 id="h:81216047-8fdf-48a3-94d7-896f474e8a86">location的详细使用：</h4>
<div class="outline-text-4" id="text-h:81216047-8fdf-48a3-94d7-896f474e8a86">
<p>
在一个server中location配置段可存在多个，用于实现从uri到文件系统的路径
映射；ngnix会根据用户请求的URI来检查定义的所有location，按一定的优化级
找出一个最佳匹配，而后应用其配置
</p>

<p>
在没有使用正则表达式的时候，nginx会先在server中的多个location选取匹配
度最高的一个uri，uri是用户请求的字符串，即域名后面的web文件路径，然后
使用该location模块中的正则url和字符串，如果匹配成功就结束搜索，并使用
此location处理此请求。
</p>

<p>
location 官方帮助: <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#location">http://nginx.org/en/docs/http/ngx_http_core_module.html#location</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">&#35821;&#27861;&#35268;&#21017;&#65306;
location [=|~|~*|^~] /uri/ { &#8230; }

=   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;&#26631;&#20934;uri&#21069;&#65292;&#38656;&#35201;&#35831;&#27714;&#23383;&#20018;&#19982;uri&#31934;&#30830;&#21305;&#37197;&#65292;&#22914;&#26524;&#21305;&#37197;&#25104;&#21151;&#23601;&#20572;&#27490;&#21521;&#19979;&#21305;&#37197;&#24182;&#31435;&#21363;&#22788;&#29702;&#35831;&#27714;&#12290;</span>
~   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;&#26631;&#20934;uri&#21069;&#65292;&#34920;&#31034;&#21253;&#21547;&#27491;&#21017;&#34920;&#36798;&#24335;&#24182;&#19988;&#21306;&#20998;&#22823;&#23567;&#20889;&#65292;&#24182;&#19988;&#21305;&#37197;</span>
!~  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;&#26631;&#20934;uri&#21069;&#65292;&#34920;&#31034;&#21253;&#21547;&#27491;&#21017;&#34920;&#36798;&#24335;&#24182;&#19988;&#21306;&#20998;&#22823;&#23567;&#20889;&#65292;&#24182;&#19988;&#19981;&#21305;&#37197;</span>

~*  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;&#26631;&#20934;uri&#21069;&#65292;&#34920;&#31034;&#21253;&#21547;&#27491;&#21017;&#34920;&#36798;&#24335;&#24182;&#19988;&#19981;&#21306;&#20998;&#22823;&#20889;&#65292;&#24182;&#19988;&#21305;&#37197;</span>
!~* <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;&#26631;&#20934;uri&#21069;&#65292;&#34920;&#31034;&#21253;&#21547;&#27491;&#21017;&#34920;&#36798;&#24335;&#24182;&#19988;&#19981;&#21306;&#20998;&#22823;&#23567;&#20889;,&#24182;&#19988;&#19981;&#21305;&#37197;</span>

^~  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;&#26631;&#20934;uri&#21069;&#65292;&#34920;&#31034;&#21253;&#21547;&#27491;&#21017;&#34920;&#36798;&#24335;&#24182;&#19988;&#21305;&#37197;&#20197;&#20160;&#20040;&#24320;&#22836;</span>
$   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;&#26631;&#20934;uri&#21069;&#65292;&#34920;&#31034;&#21253;&#21547;&#27491;&#21017;&#34920;&#36798;&#24335;&#24182;&#19988;&#21305;&#37197;&#20197;&#20160;&#20040;&#32467;&#23614;</span>
<span style="color: #8b2252;">\ </span>  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;&#26631;&#20934;uri&#21069;&#65292;&#34920;&#31034;&#21253;&#21547;&#27491;&#21017;&#34920;&#36798;&#24335;&#24182;&#19988;&#36716;&#20041;&#23383;&#31526;&#12290;&#21487;&#20197;&#36716;. * ?&#31561;</span>
*   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;&#26631;&#20934;uri&#21069;&#65292;&#34920;&#31034;&#21253;&#21547;&#27491;&#21017;&#34920;&#36798;&#24335;&#24182;&#19988;&#20195;&#34920;&#20219;&#24847;&#38271;&#24230;&#30340;&#20219;&#24847;&#23383;&#31526;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#20248;&#20808;&#32423;&#20174;&#39640;&#21040;&#20302;&#65306;</span>
=, ^~, ~/~*, &#19981;&#24102;&#31526;&#21495;
</pre>
</div>
</div>
<div id="outline-container-h:f4f13b2c-446f-4e70-a6b2-21bbe93df21e" class="outline-5">
<h5 id="h:f4f13b2c-446f-4e70-a6b2-21bbe93df21e">匹配案例-精确匹配：</h5>
<div class="outline-text-5" id="text-h:f4f13b2c-446f-4e70-a6b2-21bbe93df21e">
<p>
<code>=</code>
</p>

<p>
在server部分使用location配置一个web界面，要求：当访问nginx
服务器的 /logo.jpg 的时候要显示指定html文件的内容：
</p>

<p>
精确匹配一般用于匹配组织的logo等相对固定的URL,匹配优先级最高
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@s2 ~]# cat /apps/nginx/conf/conf.d/pc.conf
server {
  listen 80;
  server_name www.cici.net;
  location / {
    root /data/nginx/html/pc;
  }
  location = /1ogo.jpg {
    root /var/www/nginx/images;
    index index.html;
  }
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#20256;&#22270;&#29255;&#21040;/var/www/nginx/images&#65292;&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#27979;&#35797;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#27979;&#35797;&#65306;http://www.cici.net/1ogo.jpg</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:03a6b529-be32-4c9f-9c53-522ae08150d4" class="outline-5">
<h5 id="h:03a6b529-be32-4c9f-9c53-522ae08150d4">匹配案例-区分大小写：</h5>
<div class="outline-text-5" id="text-h:03a6b529-be32-4c9f-9c53-522ae08150d4">
<p>
<code>~</code>
</p>

<p>
如果uri中包含大写字母，则以下location匹配Ax.jpg条件不成功，因为~为区分
大小写，那么当用户的请求被执行匹配时发现location中定义的是大写的A，则
匹配失败，即要么继续往下匹配其他的location（如果有），要么报错给客户端。
</p>

<div class="org-src-container">
<pre class="src src-sh">location ~ /A.?<span style="color: #8b2252;">\.</span>jpg { <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#23383;&#27597;A&#24320;&#22836;&#30340;&#22270;&#29255;&#65292;&#21518;&#38754;&#65311;&#34920;&#31034;A&#21518;&#38754;&#38646;&#27425;&#25110;&#19968;&#20010;&#23383;&#31526;</span>
  index index.html;
  root /opt/nginx/html/image;
}

&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#27979;&#35797;
&#23558;&#21482;&#33021;&#35775;&#38382;&#20197;&#23567;&#20889;&#23383;&#31526;&#30340;AX.jpg&#22270;&#29255;&#65292;&#19981;&#33021;&#35782;&#21035;&#22823;&#20889;&#30340;JPG&#32467;&#23614;&#30340;&#22270;&#29255;
&#35775;&#38382;&#27979;&#35797;&#65306;http://www.cici.net/Aa.jpg <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#35775;&#38382;&#36164;&#28304;&#21517;&#31216;&#21363;&#21487;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3ff927a8-1e49-4003-a9c7-a0334e817bf9" class="outline-5">
<h5 id="h:3ff927a8-1e49-4003-a9c7-a0334e817bf9">匹配案例-不区分大小写：</h5>
<div class="outline-text-5" id="text-h:3ff927a8-1e49-4003-a9c7-a0334e817bf9">
<p>
<code>~*</code>
</p>

<p>
用来对用户请求的uri做模糊匹配，uri中无论都是大写、都是小写或者大小写混
合，此模式也都会匹配，通常使用此模式匹配用户request中的静态资源并继续
做下一步操作，此方式使用较多
</p>

<p>
注意: 此方式中,对于Linux文件系统上的文件仍然是区分大小写的,如果磁盘文件不存在,仍会提示404
</p>

<div class="org-src-container">
<pre class="src src-sh">&#27491;&#21017;&#34920;&#36798;&#24335;&#21305;&#37197;&#65306;
  location ~* /A.?<span style="color: #8b2252;">\.</span>jpg {
    index index.html;
    root /opt/nginx/html/image;
  }

&#35775;&#38382;&#27979;&#35797;&#65306;http://www.cici.net/aA.jpg <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#35775;&#38382;&#36164;&#28304;&#21517;&#31216;&#21363;&#21487;</span>
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
&#31934;&#30830;&#21305;&#37197;&#25351;&#23450;&#21517;&#31216;&#65306;
<span style="color: #b22222;"># </span><span style="color: #b22222;">location ~ /aa.jpg {</span>
<span style="color: #b22222;">#   </span><span style="color: #b22222;">index index.html;</span>
<span style="color: #b22222;">#   </span><span style="color: #b22222;">root /opt/nginx/html/image;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">}</span>

  location ~* /aa.jpg {
    index index.html;
    root /opt/nginx/html/image;
  }

&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#27979;&#35797;
</pre>
</div>

<p>
说明：对于不区分大小写的location，则可以访问任意大小写结尾的图片文件,如区分大小写则只能访问aa.jpg，不区分大小写则可以访问aa.jpg以外的资源比如Aa.JPG、aA.jPG这样的混合名称文件，但是要求nginx服务器的资源目录有相应的文件，比如有Aa.JPG有aA.jPG。
</p>
</div>
</div>
<div id="outline-container-h:68b25332-b977-4c70-9626-630ea3c1c4d8" class="outline-5">
<h5 id="h:68b25332-b977-4c70-9626-630ea3c1c4d8">匹配案例-URI开始</h5>
<div class="outline-text-5" id="text-h:68b25332-b977-4c70-9626-630ea3c1c4d8">
<p>
用的相对较少
</p>

<div class="org-src-container">
<pre class="src src-sh">location ^~ /images {
  root /data/nginx;
  index index.html;
}

location /images1 {
  <span style="color: #483d8b;">alias</span> /data/nginx/html/pc;
  index index.html;
}

&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#27979;&#35797;&#65292;&#23454;&#29616;&#25928;&#26524;&#26159;&#35775;&#38382;images&#21644;images1&#36820;&#22238;&#19981;&#21516;&#30340;&#32467;&#26524;
[root@s2 images]# curl http://www.cici.net/images/
images
[root@s2 images]# curl http://www.cici.net/images1/
pc web
</pre>
</div>
</div>
</div>
<div id="outline-container-h:634c1c09-7e61-4e51-8d63-8007007d10fb" class="outline-5">
<h5 id="h:634c1c09-7e61-4e51-8d63-8007007d10fb">匹配案例-文件名后缀</h5>
<div class="outline-text-5" id="text-h:634c1c09-7e61-4e51-8d63-8007007d10fb">
<p>
用的比较多
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@s2 ~]# mkdir /data/nginx/images1
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#20256;&#19968;&#20010;&#21644;images&#30446;&#24405;&#19981;&#19968;&#26679;&#20869;&#23481;&#30340;&#30340;&#22270;&#29255;1.j&#21040;/data/nginx/images1</span>

location ~* <span style="color: #8b2252;">\.</span>(gif|jpg|jpeg|bmp|png|tiff|tif|ico|wmf|js)$ {
  root /data/nginx/images1;
  index index.html;
}
&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#27979;&#35797;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:df02baf6-22d4-430b-a190-f097a226eb17" class="outline-5">
<h5 id="h:df02baf6-22d4-430b-a190-f097a226eb17">匹配案例-优先级</h5>
<div class="outline-text-5" id="text-h:df02baf6-22d4-430b-a190-f097a226eb17">
<div class="org-src-container">
<pre class="src src-sh">location = /1.jpg {
  root /data/nginx/static1;
  index index.html;
}
location /1.jpg {
  root /data/nginx/static2;
  index index.html;
}
location ~* <span style="color: #8b2252;">\.</span>(gif|jpg|jpeg|bmp|png|tiff|tif|ico|wmf|js)$ {
  root /data/nginx/static3;
  index index.html;
}
[root@centos8 ~]# mkdir -p /data/nginx/static{1,2,3}
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#20256;&#22270;&#29255;&#21040; /data/nginx/static{1,2,3} &#24182;&#37325;&#21551;nginx&#35775;&#38382;&#27979;&#35797;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#20248;&#20808;&#32423;&#65306;=, ^~, &#65374;/&#65374;*&#65292;/</span>
location&#20248;&#20808;&#32423;&#65306;(location =) &gt; (location ^~ &#36335;&#24452;) &gt; (location ~,~* &#27491;&#21017;&#39034;&#24207;) &gt;(location &#23436;&#25972;&#36335;&#24452;) &gt; (location &#37096;&#20998;&#36215;&#22987;&#36335;&#24452;) &gt; (/)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d1eee309-eaa0-4fc9-bddb-51bcf7cf75b9" class="outline-5">
<h5 id="h:d1eee309-eaa0-4fc9-bddb-51bcf7cf75b9">生产使用案例</h5>
<div class="outline-text-5" id="text-h:d1eee309-eaa0-4fc9-bddb-51bcf7cf75b9">
<div class="org-src-container">
<pre class="src src-sh">&#30452;&#25509;&#21305;&#37197;&#32593;&#31449;&#26681;&#20250;&#21152;&#36895;Nginx&#35775;&#38382;&#22788;&#29702;:
location = /index.html {
   ......;
}
location / {
   ......;
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38745;&#24577;&#36164;&#28304;&#37197;&#32622;&#65306;</span>
location ^~ /static/ {
   ......;
}
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25110;&#32773;&#19979;&#38754;&#20889;&#27861; &#65288;&#29992;&#30340;&#26356;&#22810;&#65289;</span>
location ~* <span style="color: #8b2252;">\.</span>(gif|jpg|jpeg|png|css|js|ico)$ {
   ......;
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#24212;&#29992;&#37197;&#32622;</span>
location ~* /app1 {
   ......;
}
location ~* /app2 {
   ......;
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:85ae72af-c184-41a6-a542-36760c7bc63d" class="outline-4">
<h4 id="h:85ae72af-c184-41a6-a542-36760c7bc63d">Nginx 四层访问控制：</h4>
<div class="outline-text-4" id="text-h:85ae72af-c184-41a6-a542-36760c7bc63d">
<p>
访问控制基于模块ngx_http_access_module实现，可以通过匹配客户端源IP地址进行限制。
</p>

<p>
官方帮助： <a href="http://nginx.org/en/docs/http/ngx_http_access_module.html">http://nginx.org/en/docs/http/ngx_http_access_module.html</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">location /about {
    <span style="color: #483d8b;">alias</span> /data/nginx/html/pc;
    index index.html;
    deny 192.168.1.1;
    allow 192.168.1.0/24;
    allow 10.1.1.0/16;
    allow 2001:0db8::/32;
    deny all; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20808;&#20801;&#35768;&#23567;&#37096;&#20998;&#65292;&#20877;&#25298;&#32477;&#22823;&#37096;&#20998;</span>
}
</pre>
</div>

<p>
注意：在防火墙上拒绝效果最好
</p>
</div>
</div>
<div id="outline-container-h:b72ad7d0-12f4-4fb3-920b-190031cec85e" class="outline-4">
<h4 id="h:b72ad7d0-12f4-4fb3-920b-190031cec85e">Nginx账户认证功能</h4>
<div class="outline-text-4" id="text-h:b72ad7d0-12f4-4fb3-920b-190031cec85e">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">CentOS&#23433;&#35013;&#21253;</span>
[root@centos8 ~]#yum -y install httpd-tools
<span style="color: #b22222;">#</span><span style="color: #b22222;">Ubuntu&#23433;&#35013;&#21253;</span>
[root@Ubuntu ~]#apt -y install apache2-utils

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#29992;&#25143;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">-b &#38750;&#20132;&#20114;&#24335;&#26041;&#24335;&#25552;&#20132;&#23494;&#30721;</span>
[root@s2 ~]# htpasswd -cbm /apps/nginx/conf/.htpasswd user1 123456
Adding password for user user1
[root@s2 ~]# htpasswd -bm /apps/nginx/conf/.htpasswd user2 123456
Adding password for user user2
[root@s2 ~]# tail /apps/nginx/conf/.htpasswd
user1:$<span style="color: #a0522d;">apr1</span>$<span style="color: #a0522d;">Rjm0u2Kr</span>$<span style="color: #a0522d;">VHvkAIc5OYg</span>.3ZoaGwaGq/
user2:$<span style="color: #a0522d;">apr1</span>$<span style="color: #a0522d;">nIqnxoJB</span>$<span style="color: #a0522d;">LR9W1DTJT</span>.viDJhXa6wHv.

[root@s2 ~]# vim /apps/nginx/conf/conf.d/pc.conf
  location = /login/ {
    root /data/nginx/html/pc;
    index index.html;
    auth_basic          <span style="color: #8b2252;">"login password"</span>;
    auth_basic_user_file /apps/nginx/conf/.htpasswd;
  }

&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#27979;&#35797;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:476ab1eb-266f-44c0-95e2-19b7831a7efa" class="outline-4">
<h4 id="h:476ab1eb-266f-44c0-95e2-19b7831a7efa">自定义错误页面</h4>
<div class="outline-text-4" id="text-h:476ab1eb-266f-44c0-95e2-19b7831a7efa">
<p>
定义错误页，以指定的响应状态码进行响应, 可用位置：http, server, location, if in location
</p>

<pre class="example" id="org1572ce3">
error_page code ... [=[response]] uri;
</pre>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">listen 80;
server_name www.cici.net;
error_page 500 502 503 504 404 /error.html;
location = /error.html {
  root html;
}
&#37325;&#21551;nginx&#24182;&#35775;&#38382;&#19981;&#23384;&#22312;&#30340;&#39029;&#38754;&#36827;&#34892;&#27979;&#35797;
</pre>
</div>

<p>
范例：
</p>
<pre class="example" id="org5724524">
error_page 404 /40x.html;
location = /40x.html {
    root /data/html/ ;
}
</pre>

<p>
范例： 404 转为 302
</p>
<pre class="example" id="orgb52fe37">
error_page  404  =302 /index.html;
error_page 500 502 503 504 /50x.html;
  location = /50x.html {
}
</pre>
</div>
</div>
<div id="outline-container-h:9404cb96-5761-4608-be5c-3e18df5d7e25" class="outline-4">
<h4 id="h:9404cb96-5761-4608-be5c-3e18df5d7e25">自定义错误日志</h4>
<div class="outline-text-4" id="text-h:9404cb96-5761-4608-be5c-3e18df5d7e25">
<pre class="example" id="org234485a">
Syntax: error_log file [level];
Default:
error_log logs/error.log error;
Context: main, http, mail, stream, server, location
level: debug, info, notice, warn, error, crit, alert, emerg
</pre>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@s2 ~]# mkdir /data/nginx/logs
  listen 80;
  server_name www.cici.net;
  error_page 500 502 503 504 404 /error.html; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#30446;&#24405;&#19979;&#38754;&#21019;&#24314;error.html&#39029;&#38754;</span>
  access_log /data/nginx/logs/www-cici-net_access.log;
  error_log /data/nginx/logs/www-cici-net_error.log;
  location = /error.html {
    root html;
  }
&#37325;&#21551;nginx&#24182;&#35775;&#38382;&#19981;&#23384;&#22312;&#30340;&#39029;&#38754;&#36827;&#34892;&#27979;&#35797;&#24182;&#39564;&#35777;&#26159;&#22312;&#25351;&#23450;&#30446;&#24405;&#29983;&#25104;&#26032;&#30340;&#26085;&#24535;&#25991;&#20214;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c2671a5e-5c5a-4fe4-a581-7316afadfcbb" class="outline-4">
<h4 id="h:c2671a5e-5c5a-4fe4-a581-7316afadfcbb">检测文件是否存在：</h4>
<div class="outline-text-4" id="text-h:c2671a5e-5c5a-4fe4-a581-7316afadfcbb">
<p>
try_files会按顺序检查文件是否存在，返回第一个找到的文件或文件夹（结尾加斜线表示为文件夹），如果所有文件或文件夹都找不到，会进行一个内部重定向到最后一个参数。只有最后一个参数可以引起一个内部重定向，之前的参数只设置内部URI的指向。最后一个参数是回退URI且必须存在，否则会出现内部500错误。
语法
</p>
<pre class="example" id="org606d03b">
Syntax: try_files file ... uri;
try_files file ... =code;
Default: —
Context: server, location
</pre>

<p>
范例: 如果不存在页面, 就转到default.html页面
</p>
<div class="org-src-container">
<pre class="src src-sh">location /about {
  root /data/nginx/html/pc;
  <span style="color: #b22222;">#</span><span style="color: #b22222;">alias /data/nginx/html/pc;</span>
  index index.html;
  <span style="color: #b22222;">#</span><span style="color: #b22222;">try_files $uri /about/default.html;</span>
  <span style="color: #b22222;">#</span><span style="color: #b22222;">try_files $uri $uri/index.html $uri.html /about/default.html;</span>
  try_files $<span style="color: #a0522d;">uri</span> $<span style="color: #a0522d;">uri</span>/index.html $<span style="color: #a0522d;">uri</span>.html =489;
}

[root@s2 ~]# echo <span style="color: #8b2252;">"default"</span> &gt;&gt; /data/nginx/html/pc/about/default.html

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;nginx&#24182;&#27979;&#35797;&#65292;&#24403;&#35775;&#38382;&#21040;http://www.cici.net/about/xx.html&#31561;&#19981;&#23384;&#22312;&#30340;uri&#20250;&#26174;&#31034;default&#65292;&#22914;&#26524;&#26159;&#33258;&#23450;&#20041;&#30340;&#29366;&#24577;&#30721;&#21017;&#20250;&#26174;&#31034;&#22312;&#36820;&#22238;&#25968;&#25454;&#30340;&#29366;&#24577;&#30721;&#20013;&#65292;&#22914;&#65306;</span>
[root@s2 about]# curl --head http://www.cici.net/about/xx.html
HTTP/1.1 489 <span style="color: #b22222;">#</span><span style="color: #b22222;">489&#23601;&#26159;&#33258;&#23450;&#20041;&#30340;&#29366;&#24577;&#36820;&#22238;&#30721;</span>
Server: nginx
Date: Thu, 21 Feb 2019 00:11:40 GMT
Content-Length: 0
Connection: keep-alive
Keep-Alive: <span style="color: #a0522d;">timeout</span>=65
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b1082614-98f2-4459-9fdf-31d3b1f1e1d7" class="outline-4">
<h4 id="h:b1082614-98f2-4459-9fdf-31d3b1f1e1d7">长连接配置：</h4>
<div class="outline-text-4" id="text-h:b1082614-98f2-4459-9fdf-31d3b1f1e1d7">
<div class="org-src-container">
<pre class="src src-sh">keepalive_timeout timeout [header_timeout];  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#23450;&#20445;&#25345;&#36830;&#25509;&#36229;&#26102;&#26102;&#38271;&#65292;0&#34920;&#31034;&#31105;&#27490;&#38271;&#36830;&#25509;&#65292;&#40664;&#35748;&#20026;75s&#65292;&#36890;&#24120;&#37197;&#32622;&#22312;http&#23383;&#27573;&#20316;&#20026;&#31449;&#28857;&#20840;&#23616;&#37197;&#32622;</span>

keepalive_requests number;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#19968;&#27425;&#38271;&#36830;&#25509;&#19978;&#25152;&#20801;&#35768;&#35831;&#27714;&#30340;&#36164;&#28304;&#30340;&#26368;&#22823;&#25968;&#37327;&#65292;&#40664;&#35748;&#20026;100&#27425;,&#24314;&#35758;&#36866;&#24403;&#35843;&#22823;,&#27604;&#22914;:500</span>
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">keepalive_requests 3;
keepalive_timeout 65 65; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#38271;&#36830;&#25509;&#21518;&#65292;&#36820;&#22238;&#23458;&#25143;&#31471;&#30340;&#20250;&#35805;&#20445;&#25345;&#26102;&#38388;&#20026;60s&#65292;&#21333;&#27425;&#38271;&#36830;&#25509;&#32047;&#35745;&#35831;&#27714;&#36798;&#21040;&#25351;&#23450;&#27425;&#25968;&#35831;&#27714;&#25110;65&#31186;&#23601;&#20250;&#34987;&#26029;&#24320;&#65292;&#21518;&#38754;&#30340;60&#20026;&#21457;&#36865;&#32473;&#23458;&#25143;&#31471;&#24212;&#31572;&#25253;&#25991;&#22836;&#37096;&#20013;&#26174;&#31034;&#30340;&#36229;&#26102;&#26102;&#38388;&#35774;&#32622;&#20026;60s&#65306;&#22914;&#19981;&#35774;&#32622;&#23458;&#25143;&#31471;&#23558;&#19981;&#26174;&#31034;&#36229;&#26102;&#26102;&#38388;&#12290;</span>
Keep-Alive:<span style="color: #a0522d;">timeout</span>=60 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27983;&#35272;&#22120;&#25910;&#21040;&#30340;&#26381;&#21153;&#22120;&#36820;&#22238;&#30340;&#25253;&#25991;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#35774;&#32622;&#20026;0&#34920;&#31034;&#20851;&#38381;&#20250;&#35805;&#20445;&#25345;&#21151;&#33021;&#65292;&#23558;&#22914;&#19979;&#26174;&#31034;&#65306;</span>
Connection:close <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27983;&#35272;&#22120;&#25910;&#21040;&#30340;&#26381;&#21153;&#22120;&#36820;&#22238;&#30340;&#25253;&#25991;</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#21629;&#20196;&#27979;&#35797;&#65306;</span>
[root@s3 apps]# telnet www.cici.net 80
Trying 172.18.200.102...
Connected to www.cici.net.
Escape character is <span style="color: #8b2252;">'^]'</span>.
GET / HTTP/1.1
HOST: www.cici.net

<span style="color: #b22222;">#</span><span style="color: #b22222;">Response Headers(&#21709;&#24212;&#22836;&#20449;&#24687;)&#65306;</span>
HTTP/1.1 200 OK
Server: nginx/1.14.2
Date: Thu, 14 Mar 2019 17:23:46 GMT
Content-Type: text/html
Content-Length: 7
Last-Modified: Thu, 14 Mar 2019 14:54:50 GMT
Connection: keep-alive
Keep-Alive: <span style="color: #a0522d;">timeout</span>=60
ETag: <span style="color: #8b2252;">"5c8a6b3a-7"</span>
Accept-Ranges: bytes

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39029;&#38754;&#20869;&#23481;</span>
pc web
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4ae9f87a-770e-4e79-ba79-9feb9134cd69" class="outline-4">
<h4 id="h:4ae9f87a-770e-4e79-ba79-9feb9134cd69">作为下载服务器配置</h4>
<div class="outline-text-4" id="text-h:4ae9f87a-770e-4e79-ba79-9feb9134cd69">
<p>
ngx_http_autoindex_module 模块处理以斜杠字符 "/" 结尾的请求，并生成目
录列表,可以做为下载服务配置使用
</p>

<p>
官方文档： <a href="http://nginx.org/en/docs/http/ngx_http_autoindex_module.html">http://nginx.org/en/docs/http/ngx_http_autoindex_module.html</a>
</p>

<p>
相关指令：
</p>
<div class="org-src-container">
<pre class="src src-sh">autoindex on | off;<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#21160;&#25991;&#20214;&#32034;&#24341;&#21151;&#33021;&#65292;&#40664;&#20026;off</span>
autoindex_exact_size on | off;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35745;&#31639;&#25991;&#20214;&#30830;&#20999;&#22823;&#23567;&#65288;&#21333;&#20301;bytes&#65289;&#65292;off &#26174;&#31034;&#22823;&#27010;&#22823;&#23567;&#65288;&#21333;&#20301;K&#12289;M)&#65292;&#40664;&#35748;on</span>
autoindex_localtime on | off ; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#26412;&#26426;&#26102;&#38388;&#32780;&#38750;GMT(&#26684;&#26519;&#23041;&#27835;)&#26102;&#38388;&#65292;&#40664;&#35748;off</span>
autoindex_format html | xml | json | jsonp; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#32034;&#24341;&#30340;&#39029;&#38754;&#25991;&#20214;&#39118;&#26684;&#65292;&#40664;&#35748;html</span>
limit_rate rate; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38480;&#21046;&#21709;&#24212;&#23458;&#25143;&#31471;&#20256;&#36755;&#36895;&#29575;(&#38500;GET&#21644;HEAD&#20197;&#22806;&#30340;&#25152;&#26377;&#26041;&#27861;)&#65292;&#21333;&#20301;B/s,&#21363;bytes/second&#65292;&#40664;&#35748;&#20540;0,&#34920;&#31034;&#26080;&#38480;&#21046;,&#27492;&#25351;&#20196;&#30001;ngx_http_core_module&#25552;&#20379;</span>
</pre>
</div>

<p>
范例: 实现下载站点
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;:download&#19981;&#38656;&#35201;index.html&#25991;&#20214;</span>
[root@s2 about]# mkdir /data/nginx/html/pc/download

[root@s2 about]# vim /apps/nginx/conf/conf.d/pc.conf
  location /download {
    autoindex on;            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#21160;&#32034;&#24341;&#21151;&#33021;</span>
    autoindex_exact_size on; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35745;&#31639;&#25991;&#20214;&#30830;&#20999;&#22823;&#23567;&#65288;&#21333;&#20301;bytes&#65289;&#65292;off&#21482;&#26174;&#31034;&#22823;&#27010;&#22823;&#23567;&#65288;&#21333;&#20301;kb&#12289;mb&#12289;gb&#65289;</span>
    autoindex_localtime on;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#26412;&#26426;&#26102;&#38388;&#32780;&#38750;GMT(&#26684;&#26519;&#23041;&#27835;)&#26102;&#38388;</span>
    limit_rate 1024k;
    root /data/nginx/html/pc;
  }

[root@s2 pc]# cp /root/anaconda-ks.cfg /data/nginx/html/pc/download/
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#27979;&#35797;&#19979;&#36733;&#39029;&#38754;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26356;&#26032;&#26102;&#38388;</span>
ntpdate time1.aliyun.com
</pre>
</div>

<p>
为了备忘，最后将apache下的配置方法也记录一下！实现效果和上面一样！
</p>
<div class="org-src-container">
<pre class="src src-sh">Alias / &#8221;/data/www/file&#8221;   
       &lt; Directory  &#8221;/data/www/file&#8221; &gt;   
        Options Indexes                                               //&#24320;&#21551;&#30446;&#24405;&#21015;&#34920;&#32034;&#24341;&#27169;&#24335;   
        Order allow,deny   
        IndexOptions  NameWidth = 25   Charset = UTF -8     //&#35774;&#23450;&#25991;&#20214;&#21517;&#26174;&#31034;&#38271;&#24230;&#65292;&#25991;&#23383;&#23383;&#31526;&#32534;&#30721;   
        Allow from all   
     &lt;/ Directory &gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:df8ca21d-5327-405e-8859-fb1051420240" class="outline-4">
<h4 id="h:df8ca21d-5327-405e-8859-fb1051420240">作为上传服务器</h4>
<div class="outline-text-4" id="text-h:df8ca21d-5327-405e-8859-fb1051420240">
<p>
以下指令控制上传数据
</p>
<div class="org-src-container">
<pre class="src src-sh">client_max_body_size 1m&#65307; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#20801;&#35768;&#23458;&#25143;&#31471;&#19978;&#20256;&#21333;&#20010;&#25991;&#20214;&#30340;&#26368;&#22823;&#20540;&#65292;&#40664;&#35748;&#20540;&#20026;1m</span>
client_body_buffer_size size; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;&#25509;&#25910;&#27599;&#20010;&#23458;&#25143;&#31471;&#35831;&#27714;&#25253;&#25991;&#30340;body&#37096;&#20998;&#30340;&#32531;&#20914;&#21306;&#22823;&#23567;&#65307;&#40664;&#35748;16k&#65307;&#36229;&#20986;&#27492;&#22823;&#23567;&#26102;&#65292;&#20854;&#23558;&#34987;&#26242;&#23384;&#21040;&#30913;&#30424;&#19978;&#30340;&#30001;&#19979;&#38754;client_body_temp_path&#25351;&#20196;&#25152;&#23450;&#20041;&#30340;&#20301;&#32622;</span>
client_body_temp_path path [level1 [level2 [level3]]];
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#23450;&#23384;&#20648;&#23458;&#25143;&#31471;&#35831;&#27714;&#25253;&#25991;&#30340;body&#37096;&#20998;&#30340;&#20020;&#26102;&#23384;&#20648;&#36335;&#24452;&#21450;&#23376;&#30446;&#24405;&#32467;&#26500;&#21644;&#25968;&#37327;&#65292;&#30446;&#24405;&#21517;&#20026;16&#36827;&#21046;&#30340;&#25968;&#23383;&#65292;&#20351;&#29992;hash&#20043;&#21518;&#30340;&#20540;&#20174;&#21518;&#24448;&#21069;&#25130;&#21462;1&#20301;&#12289;2&#20301;&#12289;2&#20301;&#20316;&#20026;&#25991;&#20214;&#21517;&#65306;</span>

[root@s3 ~]# md5sum /data/nginx/html/pc/index.html
95f6f65f498c74938064851b1bb 96 3d 4 /data/nginx/html/pc/index.html

1&#32423;&#30446;&#24405;&#21344;1&#20301;16&#36827;&#21046;&#65292;&#21363;2^<span style="color: #a0522d;">4</span>=16&#20010;&#30446;&#24405; 0-f
2&#32423;&#30446;&#24405;&#21344;2&#20301;16&#36827;&#21046;&#65292;&#21363;2^<span style="color: #a0522d;">8</span>=256&#20010;&#30446;&#24405; 00-ff
3&#32423;&#30446;&#24405;&#21344;2&#20301;16&#36827;&#21046;&#65292;&#21363;2^<span style="color: #a0522d;">8</span>=256&#20010;&#30446;&#24405; 00-ff

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#31034;&#20363;&#65306;</span>
    client_max_body_size 100m&#65307; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#22826;&#22823;&#65292;&#19978;&#20256;&#26102;&#20250;&#20986;&#29616;&#19979;&#22270;&#30340;413&#38169;&#35823;,&#27880;&#24847;:&#22914;&#26524;php&#19978;&#20256;,&#36824;&#38656;&#35201;&#20462;&#25913;php.ini&#30340;&#30456;&#20851;&#37197;&#32622;</span>
    client_body_buffer_size 1024k;
    client_body_temp_path /apps/nginx/temp 1 2 2; <span style="color: #b22222;">#</span><span style="color: #b22222;">reload Nginx&#20250;&#33258;&#21160;&#21019;&#24314;temp&#30446;&#24405;</span>
</pre>
</div>

<p>
上传超过nginx指定client_max_body_size值会出413错误
</p>
</div>
</div>
<div id="outline-container-h:119fe662-2f6f-445b-acb4-294696f38859" class="outline-4">
<h4 id="h:119fe662-2f6f-445b-acb4-294696f38859">其他配置</h4>
<div class="outline-text-4" id="text-h:119fe662-2f6f-445b-acb4-294696f38859">
<div class="org-src-container">
<pre class="src src-sh">keepalive_disable none | browser ...;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#21738;&#31181;&#27983;&#35272;&#22120;&#31105;&#29992;&#38271;&#36830;&#25509;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">limit_except method ... { ... }&#65292;&#20165;&#29992;&#20110;location
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38480;&#21046;&#23458;&#25143;&#31471;&#20351;&#29992;&#38500;&#20102;&#25351;&#23450;&#30340;&#35831;&#27714;&#26041;&#27861;&#20043;&#22806;&#30340;&#20854;&#23427;&#26041;&#27861;</span>
method:GET, HEAD, POST, PUT, DELETE&#65292;MKCOL, COPY, MOVE, OPTIONS, PROPFIND,PROPPATCH, LOCK, UNLOCK, PATCH
limit_except GET {
    allow 192.168.0.0/24;
    allow 192.168.7.101;
    deny all;
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38500;&#20102;GET&#21644;HEAD &#20043;&#22806;&#20854;&#23427;&#26041;&#27861;&#20165;&#20801;&#35768;192.168.1.0/24&#32593;&#27573;&#20027;&#26426;&#20351;&#29992;</span>
[root@s2 about]# mkdir /data/nginx/html/pc/upload
[root@s2 about]# echo <span style="color: #8b2252;">"upload"</span> &gt; /data/nginx/html/pc/upload/index.html
[root@s2 about]# vim /apps/nginx/conf/conf.d/pc.conf
  location /upload {
    root /data/cici/pc;
    index index.html;
    limit_except GET {
      allow 172.18.200.101;
      deny all;
    }
  }

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;Nginx&#24182;&#36827;&#34892;&#27979;&#35797;&#19978;&#20256;&#25991;&#20214;</span>
[root@s2 pc]# systemctl restart nginx
[root@s2 pc]#
[root@s2 pc]# curl -XPUT /etc/issue http://www.cici.net/about
curl: (3) &lt;url&gt; malformed
&lt;html&gt;
&lt;head&gt;&lt;title&gt;405 Not Allowed&lt;/title&gt;&lt;/head&gt; <span style="color: #b22222;">#</span><span style="color: #b22222;">Nginx&#24050;&#32463;&#20801;&#35768;&#20294;&#26159;&#31243;&#24207;&#26410;&#25903;&#25345;&#19978;&#20256;&#21151;&#33021;</span>
&lt;body <span style="color: #a0522d;">bgcolor</span>=<span style="color: #8b2252;">"white"</span>&gt;
&lt;center&gt;&lt;h1&gt;405 Not Allowed&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
[root@s1 ~]# curl -XPUT /etc/issue http://www.cici.net/upload
curl: (3) &lt;url&gt; malformed
&lt;html&gt;
&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt; <span style="color: #b22222;">#</span><span style="color: #b22222;">Nginx&#25298;&#32477;&#19978;&#20256;</span>
&lt;body <span style="color: #a0522d;">bgcolor</span>=<span style="color: #8b2252;">"white"</span>&gt;
&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">aio on | off <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#21551;&#29992;asynchronous file I/O(AIO)&#21151;&#33021;&#65292;&#38656;&#35201;&#32534;&#35793;&#24320;&#21551;</span>
linux 2.6&#20197;&#19978;&#20869;&#26680;&#25552;&#20379;&#20197;&#19979;&#20960;&#20010;&#31995;&#32479;&#35843;&#29992;&#26469;&#25903;&#25345;aio&#65306;
1&#12289;SYS_io_setup&#65306;&#24314;&#31435;aio &#30340;context
2&#12289;SYS_io_submit: &#25552;&#20132;I/O&#25805;&#20316;&#35831;&#27714;
3&#12289;SYS_io_getevents&#65306;&#33719;&#21462;&#24050;&#23436;&#25104;&#30340;I/O&#20107;&#20214;
4&#12289;SYS_io_cancel&#65306;&#21462;&#28040;I/O&#25805;&#20316;&#35831;&#27714;
5&#12289;SYS_io_destroy&#65306;&#27585;&#38144;aio&#30340;context
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">directio size | off; <span style="color: #b22222;">#</span><span style="color: #b22222;">directio&#26159;&#30452;&#25509;&#35835;&#20889;&#25991;&#20214;&#21040;&#30913;&#30424;&#65292;&#21551;&#29992;&#30452;&#25509;I/O&#65292;&#40664;&#35748;&#20026;&#20851;&#38381;&#65292;&#24403;&#25991;&#20214;&#22823;&#20110;&#31561;&#20110;&#32473;&#23450;&#22823;&#23567;&#26102;&#65292;&#20363;&#22914;directio 4m&#65292;&#21487;&#20197;&#21644;sebdfile&#32467;&#21512;&#20351;&#29992;&#65292;&#27604;&#22914;&#24403;&#22823;&#20110;&#27492;&#20540;&#20351;&#29992;AIO&#65292;&#24403;&#23567;&#20110;&#27492;&#20540;&#20351;&#29992;sendfile&#12290;</span>

open_file_cache off; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#32531;&#23384;&#25171;&#24320;&#36807;&#30340;&#25991;&#20214;&#20449;&#24687;&#65292;&#19968;&#33324;&#21152;&#21040;&#20027;&#37197;&#32622;&#25991;&#20214;</span>
open_file_cache <span style="color: #a0522d;">max</span>=N [<span style="color: #a0522d;">inactive</span>=time];
    nginx&#21487;&#20197;&#32531;&#23384;&#20197;&#19979;&#19977;&#31181;&#20449;&#24687;&#65306;
    (1) &#25991;&#20214;&#20803;&#25968;&#25454;&#65306;&#25991;&#20214;&#30340;&#25551;&#36848;&#31526;&#12289;&#25991;&#20214;&#22823;&#23567;&#21644;&#26368;&#36817;&#19968;&#27425;&#30340;&#20462;&#25913;&#26102;&#38388;
    (2) &#25171;&#24320;&#30340;&#30446;&#24405;&#32467;&#26500;
    (3) &#27809;&#26377;&#25214;&#21040;&#30340;&#25110;&#32773;&#27809;&#26377;&#26435;&#38480;&#35775;&#38382;&#30340;&#25991;&#20214;&#30340;&#30456;&#20851;&#20449;&#24687;
    <span style="color: #a0522d;">max</span>=N&#65306;&#21487;&#32531;&#23384;&#30340;&#32531;&#23384;&#39033;&#19978;&#38480;&#25968;&#37327;&#65307;&#36798;&#21040;&#19978;&#38480;&#21518;&#20250;&#20351;&#29992;LRU(Least recently used&#65292;&#26368;&#36817;&#26368;&#23569;&#20351;&#29992;)&#31639;&#27861;&#23454;&#29616;&#31649;&#29702;
    <span style="color: #a0522d;">inactive</span>=time&#65306;&#32531;&#23384;&#39033;&#30340;&#38750;&#27963;&#21160;&#26102;&#38271;&#65292;&#22312;&#27492;&#22788;&#25351;&#23450;&#30340;&#26102;&#38271;&#20869;&#26410;&#34987;&#21629;&#20013;&#30340;&#25110;&#21629;&#20013;&#30340;&#27425;&#25968;&#23569;&#20110;open_file_cache_min_uses&#25351;&#20196;&#25152;&#25351;&#23450;&#30340;&#27425;&#25968;&#30340;&#32531;&#23384;&#39033;&#21363;&#20026;&#38750;&#27963;&#21160;&#39033;&#65292;&#23558;&#34987;&#21024;&#38500;

open_file_cache_errors on | off;
    &#26159;&#21542;&#32531;&#23384;&#26597;&#25214;&#26102;&#21457;&#29983;&#38169;&#35823;&#30340;&#25991;&#20214;&#19968;&#31867;&#30340;&#20449;&#24687;
    &#40664;&#35748;&#20540;&#20026;off

open_file_cache_min_uses number;
    open_file_cache&#25351;&#20196;&#30340;inactive&#21442;&#25968;&#25351;&#23450;&#30340;&#26102;&#38271;&#20869;&#65292;&#33267;&#23569;&#34987;&#21629;&#20013;&#27492;&#22788;&#25351;&#23450;&#30340;&#27425;&#25968;&#26041;&#21487;&#34987;&#24402;&#31867;&#20026;&#27963;&#21160;&#39033;&#40664;&#35748;&#20540;&#20026;1

open_file_cache_valid time;
    &#32531;&#23384;&#39033;&#26377;&#25928;&#24615;&#30340;&#26816;&#26597;&#39564;&#35777;&#39057;&#29575;&#65292;&#40664;&#35748;&#20540;&#20026;60s

open_file_cache <span style="color: #a0522d;">max</span>=10000 <span style="color: #a0522d;">inactive</span>=60s; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#22823;&#32531;&#23384;10000&#20010;&#25991;&#20214;&#65292;&#38750;&#27963;&#21160;&#25968;&#25454;&#36229;&#26102;&#26102;&#38271;60s</span>
open_file_cache_valid 60s;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#38388;&#38548;60s&#26816;&#26597;&#19968;&#19979;&#32531;&#23384;&#25968;&#25454;&#26377;&#25928;&#24615;</span>
open_file_cache_min_uses 5; <span style="color: #b22222;">#</span><span style="color: #b22222;">60&#31186;&#20869;&#33267;&#23569;&#34987;&#21629;&#20013;&#35775;&#38382;5&#27425;&#25165;&#34987;&#26631;&#35760;&#20026;&#27963;&#21160;&#25968;&#25454;</span>
open_file_cache_errors on;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32531;&#23384;&#38169;&#35823;&#20449;&#24687;</span>

server_tokens off; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38544;&#34255;Nginx server&#29256;&#26412;&#12290;</span>
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">open_file_cache <span style="color: #a0522d;">max</span>=10000 <span style="color: #a0522d;">inactive</span>=60s; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#22823;&#32531;&#23384;10000&#20010;&#25991;&#20214;&#65292;&#38750;&#27963;&#21160;&#25968;&#25454;&#36229;&#26102;&#26102;&#38271;60s</span>
open_file_cache_valid &#160;60s;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#38388;&#38548;60s&#26816;&#26597;&#19968;&#19979;&#32531;&#23384;&#25968;&#25454;&#26377;&#25928;&#24615;</span>
open_file_cache_min_uses 5; <span style="color: #b22222;">#</span><span style="color: #b22222;">60&#31186;&#20869;&#33267;&#23569;&#34987;&#21629;&#20013;&#35775;&#38382;5&#27425;&#25165;&#34987;&#26631;&#35760;&#20026;&#27963;&#21160;&#25968;&#25454;</span>
open_file_cache_errors &#160;on; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32531;&#23384;&#38169;&#35823;&#20449;&#24687;</span>
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:cae735c8-333b-4098-a3c2-a77af313330b" class="outline-2">
<h2 id="h:cae735c8-333b-4098-a3c2-a77af313330b">Nginx 高级配置</h2>
<div class="outline-text-2" id="text-h:cae735c8-333b-4098-a3c2-a77af313330b">
</div>
<div id="outline-container-h:ac259e01-e4c4-44d4-ba08-8864a3b9151b" class="outline-3">
<h3 id="h:ac259e01-e4c4-44d4-ba08-8864a3b9151b">Nginx 状态页</h3>
<div class="outline-text-3" id="text-h:ac259e01-e4c4-44d4-ba08-8864a3b9151b">
<p>
基于nginx模块ngx_http_stub_status_module实现，在编译安装nginx的时候需要添加编译参数&#x2013;with-http_stub_status_module，否则配置完成之后监测会是提示语法错误。
</p>

<p>
注意: 状态页显示的是整个服务器的状态,而非虚拟主机的状态
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#31034;&#20363;&#65306;</span>
location /nginx_status {
    stub_status;
    allow 192.168.0.0/16;
    allow 127.0.0.1;
    deny all;
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29366;&#24577;&#39029;&#29992;&#20110;&#36755;&#20986;nginx&#30340;&#22522;&#26412;&#29366;&#24577;&#20449;&#24687;&#65306;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#20449;&#24687;&#31034;&#20363;&#65306;</span>
Active connections: 291
server accepts handled requests
    16630948 16630948 31070465
    &#19978;&#38754;&#19977;&#20010;&#25968;&#23383;&#20998;&#21035;&#23545;&#24212;accepts,handled,requests&#19977;&#20010;&#20540;
Reading: 6 Writing: 179 Waiting: 106

Active connections&#65306; &#24403;&#21069;&#22788;&#20110;&#27963;&#21160;&#29366;&#24577;&#30340;&#23458;&#25143;&#31471;&#36830;&#25509;&#25968;&#65292;&#21253;&#25324;&#36830;&#25509;&#31561;&#24453;&#31354;&#38386;&#36830;&#25509;&#25968;&#12290;
accepts&#65306;&#32479;&#35745;&#24635;&#20540;&#65292;Nginx&#33258;&#21551;&#21160;&#21518;&#24050;&#32463;&#25509;&#21463;&#30340;&#23458;&#25143;&#31471;&#35831;&#27714;&#30340;&#24635;&#25968;&#12290;
handled&#65306;&#32479;&#35745;&#24635;&#20540;&#65292;Nginx&#33258;&#21551;&#21160;&#21518;&#24050;&#32463;&#22788;&#29702;&#23436;&#25104;&#30340;&#23458;&#25143;&#31471;&#35831;&#27714;&#30340;&#24635;&#25968;&#65292;&#36890;&#24120;&#31561;&#20110;accepts&#65292;&#38500;&#38750;&#26377;&#22240;&#20026;worker_connections&#38480;&#21046;&#31561;&#34987;&#25298;&#32477;&#30340;&#36830;&#25509;&#12290;
requests&#65306;&#32479;&#35745;&#24635;&#20540;&#65292;Nginx&#33258;&#21551;&#21160;&#21518;&#23458;&#25143;&#31471;&#21457;&#26469;&#30340;&#24635;&#30340;&#35831;&#27714;&#25968;&#12290;
Reading&#65306;&#24403;&#21069;&#29366;&#24577;&#65292;&#27491;&#22312;&#35835;&#21462;&#23458;&#25143;&#31471;&#35831;&#27714;&#25253;&#25991;&#39318;&#37096;&#30340;&#36830;&#25509;&#30340;&#36830;&#25509;&#25968;&#12290;&#36234;&#23567;&#36234;&#22909;
Writing&#65306;&#24403;&#21069;&#29366;&#24577;&#65292;&#27491;&#22312;&#21521;&#23458;&#25143;&#31471;&#21457;&#36865;&#21709;&#24212;&#25253;&#25991;&#36807;&#31243;&#20013;&#30340;&#36830;&#25509;&#25968;&#12290;&#36234;&#23567;&#36234;&#22909;
Waiting&#65306;&#24403;&#21069;&#29366;&#24577;&#65292;&#27491;&#22312;&#31561;&#24453;&#23458;&#25143;&#31471;&#21457;&#20986;&#35831;&#27714;&#30340;&#31354;&#38386;&#36830;&#25509;&#25968;&#65292;&#24320;&#21551; keep-alive&#30340;&#24773;&#20917;&#19979;,&#36825;&#20010;&#20540;&#31561;&#20110; active &#8211; (reading+writing),
</pre>
</div>

<p>
说明：Active connections，Reading，Writing，Waiting这几个值很重要！
</p>

<p>
范例：分析网站当前访问量
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#curl http://www.cici.com/nginx_status 2&gt; /dev/null |awk <span style="color: #8b2252;">'/Reading/{print $2,$4,$6}'</span>
0 1 1
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0895e0f5-fe94-4556-b42b-85768aa1af04" class="outline-3">
<h3 id="h:0895e0f5-fe94-4556-b42b-85768aa1af04">Nginx 第三方模块：</h3>
<div class="outline-text-3" id="text-h:0895e0f5-fe94-4556-b42b-85768aa1af04">
<p>
第三模块是对nginx 的功能扩展，第三方模块需要在编译安装Nginx
的时候使用参数&#x2013;add-module=PATH指定路径添加，有的模块是由公司的开发人员针对业务需求定制开发的，有的模块是开源爱好者开发好之后上传到github进行开源的模块，nginx支持第三方模块需要从源码重新编译支持，比如开源的echo模块
<a href="https://github.com/openresty/echo-nginx-module">https://github.com/openresty/echo-nginx-module</a>：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@s2 pc]# systemctl stop nginx
[root@s2 pc]# vim /apps/nginx/conf/conf.d/pc.conf
location /main {
    index index.html;
    default_type text/html;
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"hello world,main--&gt;"</span>;
    echo_reset_timer;
    echo_location /sub1;
    echo_location /sub2;
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"took $echo_timer_elapsed sec for total."</span>;
}
location /sub1 {
    echo_sleep 1;
    <span style="color: #483d8b;">echo</span> sub1;
}
location /sub2 {
    echo_sleep 1;
    <span style="color: #483d8b;">echo</span> sub2;
}

[root@s2 pc]# /apps/nginx/sbin/nginx -t
nginx: [emerg] unknown directive <span style="color: #8b2252;">"echo_reset_timer"</span><span style="color: #a020f0;"> in</span>
/apps/nginx/conf/conf.d/pc.conf:86
nginx: configuration file /apps/nginx/conf/nginx.conf test failed

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35299;&#20915;&#20197;&#19978;&#25253;&#38169;&#38382;&#39064;</span>
[root@s2 src]# yum install git -y
[root@s2 src]# git clone https://github.com/openresty/echo-nginx-module.git
[root@s2 src]# cd nginx-1.12.2/
[root@s2 src]# ./configure <span style="color: #8b2252;">\</span>
--prefix=/apps/nginx <span style="color: #8b2252;">\</span>
--user=nginx --group=nginx <span style="color: #8b2252;">\</span>
--with-http_ssl_module <span style="color: #8b2252;">\</span>
--with-http_v2_module <span style="color: #8b2252;">\</span>
--with-http_realip_module <span style="color: #8b2252;">\</span>
--with-http_stub_status_module <span style="color: #8b2252;">\</span>
--with-http_gzip_static_module <span style="color: #8b2252;">\</span>
--with-pcre <span style="color: #8b2252;">\</span>
--with-stream <span style="color: #8b2252;">\</span>
--with-stream_ssl_module <span style="color: #8b2252;">\</span>
--with-stream_realip_module <span style="color: #8b2252;">\</span>
--with-http_perl_module <span style="color: #8b2252;">\</span>
--add-module=/usr/local/src/echo-nginx-module
[root@s2 src]# make &amp;&amp; make install

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#35748;&#35821;&#27861;&#26816;&#27979;&#36890;&#36807;</span>
[root@s2 pc]# /apps/nginx/sbin/nginx -t
nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok
nginx: configuration file /apps/nginx/conf/nginx.conf test is successful

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;nginx&#35775;&#38382;&#27979;&#35797;&#65306;</span>
[root@s2 pc]# systemctl restart nginx
[root@s2 pc]# curl http://www.cici.net/main
hello world,main--&gt;
sub1
sub2
took 2.010 sec for total.

</pre>
</div>
</div>
</div>
<div id="outline-container-h:fb610378-0a6a-4528-9c13-e37f856fa943" class="outline-3">
<h3 id="h:fb610378-0a6a-4528-9c13-e37f856fa943">Nginx 变量使用</h3>
<div class="outline-text-3" id="text-h:fb610378-0a6a-4528-9c13-e37f856fa943">
<p>
nginx的变量可以在配置文件中引用，作为功能判断或者日志等场景使用，变量可以分为内置变量和自定义变量，内置变量是由nginx模块自带，通过变量可以获取到众多的与客户端访问相关的值。
</p>
</div>
<div id="outline-container-h:98e9b92c-23e1-4424-891e-30c030a6c9b3" class="outline-4">
<h4 id="h:98e9b92c-23e1-4424-891e-30c030a6c9b3">内置变量</h4>
<div class="outline-text-4" id="text-h:98e9b92c-23e1-4424-891e-30c030a6c9b3">
<p>
官方文档: <a href="http://nginx.org/en/docs/varindex.html">http://nginx.org/en/docs/varindex.html</a>
</p>
</div>
<div id="outline-container-h:1841cebc-beea-4229-87c9-b31221bd360d" class="outline-5">
<h5 id="h:1841cebc-beea-4229-87c9-b31221bd360d">常用内置变量</h5>
<div class="outline-text-5" id="text-h:1841cebc-beea-4229-87c9-b31221bd360d">
<p>
<b>日志配置常用变量：</b>
</p>

<p>
log_format用来设置日志格式，也就是日志文件中每条日志的格式，具体如下：
</p>

<pre class="example" id="org3f62afb">
log_format name(格式名称) type(格式样式)
</pre>

<p>
举例说明如下：
</p>
<pre class="example" id="org749332e">
log_format  main  '$server_name remote_addr $remote_user [$time_local] "$request" '
'$status $uptream_status $body_bytes_sent "$http_referer" '
'"$http_user_agent" "$http_x_forwarded_for" $ssl_protocol $ssl_cipher $upstream_addr $request_time $upstream_response_time';
</pre>

<ul class="org-ul">
<li><code>$server_name</code> : 请求的服务器的主机名。</li>

<li><p>
<code>$remote_addr</code> : 存放了客户端的地址，注意是客户端的公网IP。
</p>

<p>
变量值为 "-"时，表示空白，历史原因导致还存在
</p></li>

<li><code>$remote_user</code> : 已经经过Auth Basic Module验证的用户名。</li>

<li><code>$time_local</code> : 访问的时间与时区，比如18/Jul/2012:17:00:01 +0800，时
间信息最后的"+0800"表示服务器所处时区位于UTC之后的8小时。</li>

<li><code>$time_iso8601</code> : 2017-03-30T14:23:21+08:00</li>

<li><code>$request</code> ：请求的URI和HTTP协议，这是整个PV日志记录中最有用的信息，记录服务器收到一个什么样的请求</li>

<li><code>$status</code> ：记录请求返回的http状态码，比如成功是200</li>
<li><code>$uptream_status</code> ：upstream状态，比如成功是200</li>
<li><code>$body_bytes_sent</code> ：发送给客户端的文件主体内容的大小，比如899，可以将日志每条记录中的这个值累加起来以粗略估计服务器吞吐量。</li>
<li><code>$http_referer</code> ：记录从哪个页面链接访问过来的。</li>
<li><code>$http_user_agent</code> : 客户端浏览器的详细信息</li>
<li><p>
<code>$proxy_add_x_forwarded_for</code> : 此变量表示将客户端IP追加请求报文中
X-Forwarded-For首部字段,多个IP之间用逗号分隔,如果请求中没有
X-Forwarded-For,就使用$remote_addr
</p>

<pre class="example" id="orgf5bb6eb">
the “X-Forwarded-For” client request header field with the
$remote_addr variable appended to it, separated by a comma. If the
“X-Forwarded-For” field is not present in the client request header,
the $proxy_add_x_forwarded_for variable is equal to the $remote_addr
variable
</pre></li>

<li><code>$ssl_protocol</code> ：SSL协议版本，比如TLSv1。</li>
<li><code>$ssl_cipher</code> ： 交换数据中的算法，比如RC4-SHA</li>
<li><code>$upstream_addr</code> ： <b>upstream 的地址，即真正提供服务的主机地址</b> 。</li>
<li><code>$request_time</code> ：整个请求的总时间。</li>
<li><code>$request_body</code> : <b>即可打出post的数据</b></li>
<li><code>$upstream_response_time</code> ：请求过程中，upstream的响应时间。</li>
</ul>

<p>
<b>其他常用变量</b> ：
</p>

<ul class="org-ul">
<li><p>
<code>$args</code> : 变量中存放了URL中的指令
</p>

<p>
例如<a href="http://www.cici.net/main/index.do?id=20190221&amp;partner=search">http://www.cici.net/main/index.do?id=20190221&amp;partner=search</a>中的id=20190221&amp;partner=search
</p></li>

<li><code>$document_root</code> : 保存了针对当前资源的请求的系统根目录，如/apps/nginx/html。</li>
<li><p>
<code>$document_uri</code> : 保存了当前请求中不包含指令的URI，注意是不包含请求的指令
</p>

<p>
比如 <a href="http://www.cici.net/main/index.do?id=20190221&amp;partner=search">http://www.cici.net/main/index.do?id=20190221&amp;partner=search</a>会被定义为/main/index.do 。
返回结果为:/main/index.do
</p></li>
<li><code>$host</code> : 存放了请求的host名称</li>
<li><p>
<code>$limit_rate</code> :
</p>

<pre class="example" id="org678ee6f">
limit_rate 10240;
echo $limit_rate;
</pre>
<p>
如果nginx服务器使用limit_rate配置了显示网络速率，则会显示，如果没有设置， 则显示0。
</p></li>
<li><code>$remote_port</code> : 客户端请求Nginx服务器时随机打开的端口，这是每个客户端自己的端口。</li>
<li><code>request_body_file</code> : 做反向代理时发给后端服务器的本地资源的名称。</li>
<li><code>$request_method</code> : 请求资源的方式，GET/PUT/DELETE等</li>
<li><code>$request_filename</code> : 当前请求的资源文件的路径名称，由root或alias指
令与URI请求生成的文件绝对路径，如/apps/nginx/html/main/index.html</li>
<li><code>$request_uri</code> : 包含请求参数的原始URI，不包含主机名，相当
于:$document_uri?$args，例如：
/main/index.do?id=20190221&amp;partner=searc</li>
<li><code>$scheme</code> : 请求的协议，如ftp，https，http等。</li>
<li><code>$server_protocol</code> : 保存了客户端请求资源使用的协议的版本，如HTTP/1.0，HTTP/1.1，HTTP/2.0等。</li>
<li><code>$server_addr</code> : 保存了服务器的IP地址。</li>

<li><code>$server_port</code> : 请求的服务器的端口号。</li>
<li><p>
<code>$http_&lt;name&gt;</code> : name为任意请求报文首部字段,表示记录请求报文的首部字段
</p>

<p>
arbitrary request header field; the last part of a variable name is the field
name converted to lower case with dashes replaced by underscores #用下划线代替横线
</p>

<p>
示例: echo $http_User_Agent;
</p></li>
<li><code>$http_cookie</code> : 客户端的cookie信息。</li>
<li><code>$cookie_&lt;name&gt;</code> : name为任意请求报文首部字部cookie的key名</li>
</ul>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 conf.d]#vim www.conf
.....
location /echo {
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">request</span>;
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">proxy_add_x_forwarded_for</span>;
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">args</span>;
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">document_uri</span>;
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">request_uri</span>;
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">document_root</span>;
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">host</span>;
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">request_method</span>;
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">request_filename</span>;
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">scheme</span>;
    <span style="color: #483d8b;">set</span>  $<span style="color: #a0522d;">test</span> $<span style="color: #a0522d;">http_host</span>;
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">test</span>;
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">http_User_Agent</span>;
    <span style="color: #483d8b;">echo</span>  $<span style="color: #a0522d;">http_cookie</span>;
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">cookie_key1</span>;
 }
}

[root@centos7 ~]#curl -b <span style="color: #8b2252;">'key1=v1;key2=v2'</span> <span style="color: #8b2252;">"http://www.cici.org/echo/index.html?id=123456&amp;partner=search"</span>
GET /echo/index.html?<span style="color: #a0522d;">id</span>=123456&amp;<span style="color: #a0522d;">partner</span>=search HTTP/1.1
10.0.0.7
<span style="color: #a0522d;">id</span>=123456&amp;<span style="color: #a0522d;">partner</span>=search
/echo/index.html
/echo/index.html?<span style="color: #a0522d;">id</span>=123456&amp;<span style="color: #a0522d;">partner</span>=search
/data/nginx/html/pc
www.cici.org
GET
/data/nginx/html/pc/echo/index.html
http
www.cici.org
curl/7.29.0
<span style="color: #a0522d;">key1</span>=v1;<span style="color: #a0522d;">key2</span>=v2
v1
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:64d56e6b-c96b-4076-9420-e6157de11940" class="outline-4">
<h4 id="h:64d56e6b-c96b-4076-9420-e6157de11940">自定义变量：</h4>
<div class="outline-text-4" id="text-h:64d56e6b-c96b-4076-9420-e6157de11940">
<p>
假如需要自定义变量名称和值，使用指令 <code>set $variable value;</code> ，则方法如下：
</p>

<pre class="example" id="org547dbcc">
Syntax: set $variable value;
Default: —
Context: server, location, if
</pre>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">set</span> $<span style="color: #a0522d;">name</span> cici;
<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">name</span>;
<span style="color: #483d8b;">set</span> $<span style="color: #a0522d;">my_port</span> $<span style="color: #a0522d;">server_port</span>;
<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">my_port</span>;
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$server_name:$server_port"</span>;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:4d903945-ed04-4c51-b494-260b307b5370" class="outline-3">
<h3 id="h:4d903945-ed04-4c51-b494-260b307b5370">Nginx 自定义访问日志</h3>
<div class="outline-text-3" id="text-h:4d903945-ed04-4c51-b494-260b307b5370">
<p>
访问日志是记录客户端即用户的具体请求内容信息，全局配置模块中的error_log是记录nginx服务器运行时的日志保存路径和记录日志的level，因此有着本质的区别，而且Nginx的错误日志一般只有一个，但是访问日志可以在不同server中定义多个，定义一个日志需要使用access_log指定日志的保存路径，使用log_format指定日志的格式，格式中定义要保存的具体日志内容。
</p>

<p>
访问日志由 ngx_http_log_module 模块实现
</p>

<p>
语法格式：
</p>
<pre class="example" id="org5973672">
Syntax: access_log path [format [buffer=size] [gzip[=level]] [flush=time]
[if=condition]];
access_log off;
Default:
access_log logs/access.log combined;
Context: http, server, location, if in location, limit_except
</pre>
</div>
<div id="outline-container-h:814aa8ea-80ac-4331-8e51-b6cda6d89951" class="outline-4">
<h4 id="h:814aa8ea-80ac-4331-8e51-b6cda6d89951">自定义默认格式日志</h4>
<div class="outline-text-4" id="text-h:814aa8ea-80ac-4331-8e51-b6cda6d89951">
<p>
如果是要保留日志的源格式，只是添加相应的日志内容，则配置如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">log_format nginx_format1 <span style="color: #8b2252;">'$remote_addr - $remote_user [$time_local] "$request" '</span>
<span style="color: #8b2252;">'$status $body_bytes_sent "$http_referer" '</span>
<span style="color: #8b2252;">'"$http_user_agent" "$http_x_forwarded_for"'</span>
<span style="color: #8b2252;">'$server_name:$server_port'</span>;

access_log logs/access.log nginx_format1;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;nginx&#24182;&#35775;&#38382;&#27979;&#35797;&#26085;&#24535;&#26684;&#24335;</span>
==&gt; /apps/nginx/logs/access.log &lt;==
192.168.0.1 - - [22/Feb/2019:08:44:14 +0800] <span style="color: #8b2252;">"GET /favicon.ico HTTP/1.1"</span> 404 162 <span style="color: #8b2252;">"-"</span> <span style="color: #8b2252;">"Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0"</span> <span style="color: #8b2252;">"-"</span>www.cici.net:80
</pre>
</div>
</div>
</div>
<div id="outline-container-h:897b8797-79a3-4d4d-8ea4-f03e1ef62c3c" class="outline-4">
<h4 id="h:897b8797-79a3-4d4d-8ea4-f03e1ef62c3c">自定义json格式日志</h4>
<div class="outline-text-4" id="text-h:897b8797-79a3-4d4d-8ea4-f03e1ef62c3c">
<p>
Nginx的默认访问日志记录内容相对比较单一，默认的格式也不方便后期做日志
统计分析，生产环境中通常将nginx日志转换为json日志，然后配合使用ELK做日
志收集-统计-分析。
</p>

<div class="org-src-container">
<pre class="src src-sh">log_format access_json <span style="color: #8b2252;">'{"@timestamp":"$time_iso8601",'</span>
    <span style="color: #8b2252;">'"host":"$server_addr",'</span>
    <span style="color: #8b2252;">'"clientip":"$remote_addr",'</span>
    <span style="color: #8b2252;">'"size":$body_bytes_sent,'</span>
    <span style="color: #8b2252;">'"responsetime":$request_time,'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24635;&#30340;&#22788;&#29702;&#26102;&#38388;</span>
    <span style="color: #8b2252;">'"upstreamtime":"$upstream_response_time",'</span>
    <span style="color: #8b2252;">'"upstreamhost":"$upstream_addr",'</span>  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#31471;&#24212;&#29992;&#26381;&#21153;&#22120;&#22788;&#29702;&#26102;&#38388;</span>
    <span style="color: #8b2252;">'"http_host":"$host",'</span>
    <span style="color: #8b2252;">'"uri":"$uri",'</span>
    <span style="color: #8b2252;">'"domain":"$host",'</span>
    <span style="color: #8b2252;">'"xff":"$http_x_forwarded_for",'</span>
    <span style="color: #8b2252;">'"referer":"$http_referer",'</span>
    <span style="color: #8b2252;">'"tcp_xff":"$proxy_protocol_addr",'</span>
    <span style="color: #8b2252;">'"http_user_agent":"$http_user_agent",'</span>
    <span style="color: #8b2252;">'"status":"$status"}'</span>;
access_log /apps/nginx/logs/access_json.log access_json;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#27979;&#35797;&#26085;&#24535;&#26684;&#24335;</span>
{<span style="color: #8b2252;">"@timestamp"</span>:<span style="color: #8b2252;">"2019-02-22T08:55:32+08:00"</span>,<span style="color: #8b2252;">"host"</span>:<span style="color: #8b2252;">"192.168.7.102"</span>,<span style="color: #8b2252;">"clientip"</span>:<span style="color: #8b2252;">"192.168.0.1"</span>,<span style="color: #8b2252;">"size"</span>:162,<span style="color: #8b2252;">"response time"</span>:0.000,<span style="color: #8b2252;">"upstreamtime"</span>:<span style="color: #8b2252;">"-"</span>,<span style="color: #8b2252;">"upstreamhost"</span>:<span style="color: #8b2252;">"-</span>
<span style="color: #8b2252;">"</span>,<span style="color: #8b2252;">"http_host"</span>:<span style="color: #8b2252;">"www.cici.net"</span>,<span style="color: #8b2252;">"uri"</span>:<span style="color: #8b2252;">"/favicon.ico"</span>,<span style="color: #8b2252;">"domain"</span>:<span style="color: #8b2252;">"www.cici.net"</span>,<span style="color: #8b2252;">"xff"</span>:<span style="color: #8b2252;">"-"</span>,<span style="color: #8b2252;">"referer"</span>:<span style="color: #8b2252;">"-"</span>,<span style="color: #8b2252;">"tcp_xff"</span>:<span style="color: #8b2252;">""</span>,<span style="color: #8b2252;">"http_user_agent"</span>:<span style="color: #8b2252;">"Mozilla/5.0 (Windows NT 6.1; Win64;</span>
<span style="color: #8b2252;">x64; rv:65.0) Gecko/20100101 Firefox/65.0"</span>,<span style="color: #8b2252;">"status"</span>:<span style="color: #8b2252;">"404"</span>}
</pre>
</div>

<p>
其他
</p>
<div class="org-src-container">
<pre class="src src-sh">log_format json <span style="color: #a0522d;">escape</span>=json
    <span style="color: #8b2252;">'{"client_ip":"$remote_addr",'</span>
    <span style="color: #8b2252;">'"client_user":"$remote_user",'</span>
    <span style="color: #8b2252;">'"@timestamp": "$time_iso8601",'</span>
    <span style="color: #8b2252;">'"request_uri":"$request_uri",'</span>
    <span style="color: #8b2252;">'"status":"$status",'</span>
    <span style="color: #8b2252;">'"body_bytes_sent":"$body_bytes_sent",'</span>
    <span style="color: #8b2252;">'"http_referer":"$http_referer",'</span>
    <span style="color: #8b2252;">'"http_user_agent":"$http_user_agent",'</span>
    <span style="color: #8b2252;">'"http_x_forwarded_for":"$http_x_forwarded_for",'</span>
    <span style="color: #8b2252;">'"client_port":"$remote_port",'</span>
    <span style="color: #8b2252;">'"host":"$host",'</span>
    <span style="color: #8b2252;">'"http_host":"$http_host",'</span>
    <span style="color: #8b2252;">'"tcp_xff":"$proxy_protocol_addr",'</span>
    <span style="color: #8b2252;">'"request_length":"$request_length",'</span>
    <span style="color: #8b2252;">'"request_method":"$request_method",'</span>
    <span style="color: #8b2252;">'"request_time":"$request_time",'</span>
    <span style="color: #8b2252;">'"request_body":"$request_body",'</span>
    <span style="color: #8b2252;">'"scheme":"$scheme",'</span>
    <span style="color: #8b2252;">'"server_protocol":"$server_protocol",'</span>
    <span style="color: #8b2252;">'"ssl_cipher":"$ssl_cipher",'</span>
    <span style="color: #8b2252;">'"ssl_protocol":"$ssl_protocol",'</span>
    <span style="color: #8b2252;">'"time_local":"$time_local",'</span>
    <span style="color: #8b2252;">'"upstream_addr":"$upstream_addr",'</span>
    <span style="color: #8b2252;">'"upstream_response_time":"$upstream_response_time",'</span>
    <span style="color: #8b2252;">'"upstream_status":"$upstream_status",'</span>
    <span style="color: #8b2252;">'"url":"$scheme://$host$request_uri"}'</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:34870be8-ad59-4fa2-b430-7f135a04fb0b" class="outline-4">
<h4 id="h:34870be8-ad59-4fa2-b430-7f135a04fb0b">json格式的日志访问统计</h4>
<div class="outline-text-4" id="text-h:34870be8-ad59-4fa2-b430-7f135a04fb0b">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/</span><span style="color: #a020f0;">env</span><span style="color: #b22222;"> python</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">coding:utf-8</span>

<span style="color: #a0522d;">status_200</span>= []
<span style="color: #a0522d;">status_404</span>= []
with open(<span style="color: #8b2252;">"access_json.log"</span>) as f:
    <span style="color: #a020f0;">for</span> line<span style="color: #a020f0;"> in</span> f.readlines():
        line = eval(line)
        <span style="color: #a020f0;">if</span> line.get(<span style="color: #8b2252;">"status"</span>) == <span style="color: #8b2252;">"200"</span>:
            status_200.append(line.get)
        <span style="color: #a020f0;">elif</span> line.get(<span style="color: #8b2252;">"status"</span>) == <span style="color: #8b2252;">"404"</span>:
            status_404.append(line.get)
        <span style="color: #a020f0;">else</span>:
            print(<span style="color: #8b2252;">"&#29366;&#24577;&#30721; ERROR"</span>)
<span style="color: #0000ff;">f.close</span>()

print <span style="color: #8b2252;">"&#29366;&#24577;&#30721;200&#30340;&#26377;--:"</span>,len(status_200)
print <span style="color: #8b2252;">"&#29366;&#24577;&#30721;404&#30340;&#26377;--:"</span>,len(status_404)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20445;&#23384;&#26085;&#24535;&#25991;&#20214;&#21040;&#25351;&#23450;&#36335;&#24452;&#24182;&#36827;&#27979;&#35797;&#65306;</span>
[root@s2 ~]# python nginx_json.py
&#29366;&#24577;&#30721;200&#30340;&#26377;--: 1910
&#29366;&#24577;&#30721;404&#30340;&#26377;--: 13
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ff9c3600-5118-44d7-99fe-b62481ebed8a" class="outline-3">
<h3 id="h:ff9c3600-5118-44d7-99fe-b62481ebed8a">Nginx 压缩功能</h3>
<div class="outline-text-3" id="text-h:ff9c3600-5118-44d7-99fe-b62481ebed8a">
<p>
Nginx支持对指定类型的文件进行压缩然后再传输给客户端，而且压缩还可以设置压缩比例，压缩后的文件大小将比源文件显著变小，这样有助于降低出口带宽的利用率，降低企业的IT支出，不过会占用相应的CPU资源。
</p>

<p>
Nginx对文件的压缩功能是依赖于模块ngx_http_gzip_module
</p>

<p>
官方文档：<a href="https://nginx.org/en/docs/http/ngx_http_gzip_module.html">https://nginx.org/en/docs/http/ngx_http_gzip_module.html</a>，
</p>

<p>
配置指令如下：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#25110;&#31105;&#29992;gzip&#21387;&#32553;&#65292;&#40664;&#35748;&#20851;&#38381;</span>
gzip on | off;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21387;&#32553;&#27604;&#30001;&#20302;&#21040;&#39640;&#20174;1&#21040;9&#65292;&#40664;&#35748;&#20026;1</span>
gzip_comp_level level;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#29992;IE6 gzip&#21151;&#33021;</span>
gzip_disable <span style="color: #8b2252;">"MSIE [1-6]\."</span>;

<span style="color: #b22222;">#</span><span style="color: #b22222;">gzip&#21387;&#32553;&#30340;&#26368;&#23567;&#25991;&#20214;&#65292;&#23567;&#20110;&#35774;&#32622;&#20540;&#30340;&#25991;&#20214;&#23558;&#19981;&#20250;&#21387;&#32553;</span>
gzip_min_length 1k;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#29992;&#21387;&#32553;&#21151;&#33021;&#26102;&#65292;&#21327;&#35758;&#30340;&#26368;&#23567;&#29256;&#26412;&#65292;&#40664;&#35748;HTTP/1.1</span>
gzip_http_version 1.0 | 1.1;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;Nginx&#26381;&#21153;&#38656;&#35201;&#21521;&#26381;&#21153;&#22120;&#30003;&#35831;&#30340;&#32531;&#23384;&#31354;&#38388;&#30340;&#20010;&#25968;*&#22823;&#23567;&#65292;&#40664;&#35748;32 4k|16 8k;</span>
gzip_buffers number size;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#26126;&#20165;&#23545;&#21738;&#20123;&#31867;&#22411;&#30340;&#36164;&#28304;&#25191;&#34892;&#21387;&#32553;&#25805;&#20316;&#65307;&#40664;&#35748;&#20026;gzip_types text/html&#65292;&#19981;&#29992;&#26174;&#31034;&#25351;&#23450;&#65292;&#21542;&#21017;&#20986;&#38169;</span>
gzip_types mime-type ...;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#21551;&#29992;&#21387;&#32553;&#65292;&#26159;&#21542;&#22312;&#21709;&#24212;&#25253;&#25991;&#39318;&#37096;&#25554;&#20837;&#8220;Vary: Accept-Encoding&#8221;</span>
gzip_vary on | off;
</pre>
</div>

<p>
范例：开启json压缩
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;nginx&#24182;&#36827;&#34892;&#35775;&#38382;&#27979;&#35797;&#21387;&#32553;&#21151;&#33021;</span>
[root@s2 pc]# cp /apps/nginx/logs/access.log /data/nginx/html/pc/test.html
[root@s2 pc]# echo <span style="color: #8b2252;">"test1"</span> &gt; /data/nginx/html/pc/test1.html <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23567;&#20110;1k&#30340;&#25991;&#20214;&#27979;&#35797;&#26159;&#21542;&#20250;&#21387;&#32553;</span>
[root@s2 pc]# vim /apps/nginx/conf/nginx.conf
    gzip  on;
    gzip_min_length 1k;
    gzip_buffers 64 16k;
    gzip_comp_level 9;
    gzip_types text/xml text/plain text/css application/javascript application/x-javascript application/rss+xml application/atom+xml application/xml application/json text/event-stream;
    gzip_vary on;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#27979;&#35797;&#65306;</span>
[root@s2 pc]# curl --head --compressed http://www.cici.net
HTTP/1.1 200 OK
Server: nginx
Date: Thu, 21 Feb 2019 13:06:18 GMT
Content-Type: text/html
Content-Length: 7
Last-Modified: Tue, 19 Feb 2019 04:09:32 GMT
Connection: keep-alive
Keep-Alive: <span style="color: #a0522d;">timeout</span>=65
ETag: <span style="color: #8b2252;">"5c6b817c-7"</span>
Accept-Ranges: bytes

[root@s2 ~]# curl --head --compressed http://www.cici.net/test.html
HTTP/1.1 200 OK
Server: nginx
Date: Fri, 22 Feb 2019 01:52:23 GMT
Content-Type: text/html
Last-Modified: Thu, 21 Feb 2019 10:31:18 GMT
Connection: keep-alive
Keep-Alive: <span style="color: #a0522d;">timeout</span>=65
Vary: Accept-Encoding
ETag: W/<span style="color: #8b2252;">"5c6e7df6-171109"</span>
Content-Encoding: gzip <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21387;&#32553;&#20256;&#36755;</span>
</pre>
</div>

<p>
浏览器 f12 访问前后对比验证不压缩与压缩访问的文件大小。
</p>

<p>
参考：
</p>
<ul class="org-ul">
<li><a href="https://help.aliyun.com/zh/slb/application-load-balancer/user-guide/add-an-https-listener">阿里云ALB数据压缩</a></li>
</ul>
</div>
<div id="outline-container-h:89caca11-9eed-4f50-be65-93483ef24b6c" class="outline-4">
<h4 id="h:89caca11-9eed-4f50-be65-93483ef24b6c">浏览器解压 Content-Encoding: gzip 的原理</h4>
<div class="outline-text-4" id="text-h:89caca11-9eed-4f50-be65-93483ef24b6c">
<p>
整个过程是 HTTP 协议内容协商和压缩技术的一个典型应用，其核心目的是为了节省网络带宽、加快页面加载速度。
</p>

<p>
基本原理概述
当浏览器（客户端）向服务器请求一个资源（如 HTML、CSS、JS 文件）时，它会在请求头中告知服务器自己支持哪些压缩算法。如果服务器也支持其中一种算法，就会选择该算法对响应 body 进行压缩，并在响应头中声明使用了哪种压缩算法。浏览器收到响应后，会根据响应头的指示，用对应的解压算法将数据还原，然后再进行后续处理（如解析 HTML、执行 JS）。
</p>

<p>
步骤分解
</p>

<p>
1.请求：客户端(浏览器)声明支持压缩 (Request)
</p>

<div class="org-src-container">
<pre class="src src-sh">GET /index.html HTTP/1.1
Host: www.example.com
Accept-Encoding: gzip, deflate, br, zstd
User-Agent: Mozilla/5.0...
</pre>
</div>

<p>
#gzip: GNU zip 格式，是目前最广泛支持的压缩格式。
#deflate: 另一种压缩格式（注意：它通常指 zlib 封装，而非原始的 deflate 流）。
#br: Brotli，一种由 Google 开发的现代压缩算法，比 GZIP 有更高的压缩率。
</p>

<p>
2.响应：服务器压缩并声明 (Response)
</p>

<p>
服务器收到请求后，会执行以下逻辑：
</p>
<ul class="org-ul">
<li>检查 Accept-Encoding：查看浏览器支持哪些压缩格式。</li>
<li>选择算法：服务器根据自己的配置和支持情况，选择一种压缩算法（例如，选择 gzip）。通常服务器会有一个压缩优先级列表（如优先用 br，然后 gzip）。</li>
<li>压缩内容：服务器读取原始的、未压缩的资源文件（如 index.html），使用选定的算法（如 GZIP）在内存中对其进行实时压缩。注意：对于静态文件（如 .js, .css），服务器通常会预先压缩好（如生成一个 script.js.gz 文件）并缓存起来，以节省每次请求时的 CPU 开销。</li>
<li>设置响应头：服务器在返回响应时，必须添加 Content-Encoding: gzip 头，明确告知浏览器 body 的压缩格式。同时，它还会包含 Vary: Accept-Encoding 头，这指示缓存系统（如 CDN、浏览器缓存）根据不同的 Accept-Encoding 来分别缓存压缩和未压缩的版本，避免向不支持 gzip 的客户端误发压缩内容。</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">HTTP/1.1 200 OK
Content-Type: text/html; <span style="color: #a0522d;">charset</span>=utf-8
Content-Encoding: gzip <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21578;&#30693;&#27983;&#35272;&#22120; body &#30340;&#21387;&#32553;&#26684;&#24335;</span>
Vary: Accept-Encoding  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#36873;</span>
Content-Length: 1024 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21387;&#32553;&#21518;&#30340;&#25968;&#25454;&#22823;&#23567;</span>
...
</pre>
</div>

<p>
响应 Body 此时已经是压缩后的二进制数据流，而不是可读的文本。
</p>

<p>
3.解压：浏览器识别并处理 (Processing)
</p>

<p>
浏览器收到响应后：
</p>
<ul class="org-ul">
<li>检查响应头：浏览器解析响应头，发现 Content-Encoding: gzip。</li>
<li>启动对应解压器：浏览器内核（如 Chrome 的 Blink、Firefox 的 Gecko）中的网络栈会自动识别这个头，并启动内置的 GZIP 解压算法。</li>
<li>透明解压：解压器读取压缩的二进制 Body 数据流，将其解压还原为原始的、未压缩的格式（纯文本的 HTML、CSS 等）。这个过程对开发者是完全透明的，你无法在 JavaScript 中直接接触到压缩后的数据。</li>
</ul>

<p>
4.交付：将解压后的内容交给渲染引擎 (Delivery)
解压完成后，浏览器会将解压得到的原始文本内容交给相应的处理器：
</p>

<ul class="org-ul">
<li>如果是 text/html，则交给 HTML 解析器构建 DOM 树。</li>
<li>如果是 application/javascript，则交给 JavaScript 引擎执行。</li>
<li>如果是 text/css，则交给 CSS 解析器构建 CSSOM。</li>
</ul>

<p>
范例：Nginx
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1.&#23558;JSON&#25991;&#20214;&#21387;&#32553;&#20026;gzip&#26684;&#24335;</span>
gzip -9 -k data.json <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21387;&#32553;&#24182;&#20445;&#30041;&#21407;&#25991;&#20214;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">2&#21387;&#32553;&#21518;&#30340;.json.gz&#25991;&#20214;&#19978;&#20256;&#21040;Nginx&#30340;Web&#30446;&#24405;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">3&#37197;&#32622;nginx&#65292;&#27983;&#35272;&#35775;&#38382;gzip&#26684;&#24335;&#25991;&#20214;&#65292;&#33258;&#21160;&#35299;&#21387;&#24182;&#20197;json&#26041;&#24335;&#23637;&#31034;</span>
    location  ~* <span style="color: #8b2252;">\.</span>json<span style="color: #8b2252;">\.</span>gz$ {
            add_header Content-Type application/json; <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21578;&#30693;&#27983;&#35272;&#22120;body&#31867;&#22411;&#65292;&#27983;&#35272;&#22120;&#21487;&#20197;&#20351;&#29992;&#23545;&#24212;&#31867;&#22411;&#35299;&#26512;&#22120;</span>
            add_header Content-Encoding gzip; <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21578;&#30693;&#27983;&#35272;body&#30340;&#21387;&#32553;&#26684;&#24335;</span>
            root /usr/local/nginx/html/;
    }
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f146237b-9afa-4664-85f5-44a4bfdc897e" class="outline-4">
<h4 id="h:f146237b-9afa-4664-85f5-44a4bfdc897e">http_gzip_static_module 预压缩</h4>
<div class="outline-text-4" id="text-h:f146237b-9afa-4664-85f5-44a4bfdc897e">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">特性</th>
<th scope="col" class="org-left">http_gzip_module (动态压缩)</th>
<th scope="col" class="org-left">http_gzip_static_module (预压缩)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">CPU 使用率</td>
<td class="org-left">高（每次请求都压缩）</td>
<td class="org-left">极低（直接发送现成文件）</td>
</tr>

<tr>
<td class="org-left">响应速度</td>
<td class="org-left">较快（有压缩时间开销）</td>
<td class="org-left">极快（无压缩开销，纯磁盘读取）</td>
</tr>

<tr>
<td class="org-left">压缩比</td>
<td class="org-left">一般（为性能平衡，级别较低）</td>
<td class="org-left">可最大化（可离线用最高级别压缩）</td>
</tr>

<tr>
<td class="org-left">适用场景</td>
<td class="org-left">所有内容（静态+动态）</td>
<td class="org-left">仅限静态文件（如 .js, .css, .html, .txt）</td>
</tr>

<tr>
<td class="org-left">配置难度</td>
<td class="org-left">简单（默认）</td>
<td class="org-left">需额外启用模块和配置</td>
</tr>

<tr>
<td class="org-left">文件管理</td>
<td class="org-left">无需管理</td>
<td class="org-left">需预生成并维护 .gz 文件</td>
</tr>
</tbody>
</table>

<p>
这个模块需要单独启用，它采用了一种“预编译”的思路来优化性能。
</p>
<ul class="org-ul">
<li>需要编译时增加 <code>--with-http_gzip_static_module</code></li>
</ul>

<p>
工作原理：
</p>

<ul class="org-ul">
<li>你提前使用命令行工具（如 gzip）将静态文件（如 style.css）压缩好，生成一个对应的 .gz 文件（style.css.gz），并放在原始文件所在的同一目录下。</li>
<li>当客户端请求 style.css 时，Nginx 会先检查客户端是否支持 Gzip（通过 Accept-Encoding 头）。</li>
<li>如果支持，Nginx 不会去读 style.css，而是直接去寻找磁盘上是否已经存在 style.css.gz 这个预压缩文件。</li>
<li>如果找到，则直接发送这个 .gz 文件给客户端，并添加 Content-Encoding: gzip 头。</li>
</ul>

<p>
优点：
</p>
<ul class="org-ul">
<li>极致性能，接近零 CPU 开销：省去了实时压缩的计算过程，大大降低了服务器 CPU 负载。Nginx 只需要进行简单的磁盘 I/O 读取并发送即可，这是它的强项。</li>
<li>最佳压缩比：你可以使用最高级别（最慢）的压缩算法（如 gzip -9）在离线时压缩文件，从而得到比 Nginx 默认常规压缩级别（通常为 gzip_comp_level 6）更小的文件体积，而完全不影响服务器运行时性能。</li>
<li>避免坏请求：如果客户端不支持 Gzip（请求头中没有 Accept-Encoding: gzip），Nginx 会自动回退到发送原始的 .css 文件。行为与动态压缩完全一致。</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">&#21477;&#27861;&#65306; gzip_static on | off | always;
&#40664;&#35748;&#65306; gzip_static off;
&#35821;&#22659;&#65306; http,server,&#8203;location

<span style="color: #8b2252;">'on'</span>&#65306;&#20248;&#20808;&#20351;&#29992;&#39044;&#21387;&#32553;&#25991;&#20214;(.gz)&#65292;&#22914;&#26524;&#19981;&#23384;&#22312;&#19988;&#23458;&#25143;&#31471;&#25903;&#25345;gzip&#65292;&#21017;&#21487;&#33021;&#36827;&#34892;&#21160;&#24577;&#21387;&#32553;&#65288;&#29256;&#26412;&#20381;&#36182;&#65289;
</pre>
</div>

<p>
范例：json文件的gzip压缩文件展示
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">1.&#23558;JSON&#25991;&#20214;&#21387;&#32553;&#20026;gzip&#26684;&#24335;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">2&#21387;&#32553;&#21518;&#30340;.json.gz&#25991;&#20214;&#19978;&#20256;&#21040;Nginx&#30340;Web&#30446;&#24405;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">3&#37197;&#32622;nginx</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#29992;&#21160;&#24577;gzip&#21387;&#32553; (&#20316;&#20026;&#22238;&#36864;&#26041;&#26696;)</span>
    gzip on;

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#21160;&#24577;&#21387;&#32553;&#30340;&#26368;&#23567;&#25991;&#20214;&#22823;&#23567;&#65292;&#23567;&#20110;&#35813;&#20540;&#30340;&#25991;&#20214;&#19981;&#21387;&#32553;&#65288;&#21333;&#20301;&#23383;&#33410;&#65289;</span>
    gzip_min_length 1024;

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#21160;&#24577;&#21387;&#32553;&#30340;&#21387;&#32553;&#32423;&#21035;&#65288;1-9&#65289;&#12290;&#32423;&#21035;&#36234;&#39640;&#21387;&#32553;&#27604;&#36234;&#22909;&#65292;&#20294;CPU&#28040;&#32791;&#36234;&#22823;&#12290;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#24847;&#65306;&#27492;&#35774;&#32622;&#19981;&#24433;&#21709;&#39044;&#21387;&#32553;&#25991;&#20214;&#65292;&#39044;&#21387;&#32553;&#25991;&#20214;&#30340;&#32423;&#21035;&#22312;&#29983;&#25104;&#26102;&#30830;&#23450;&#12290;</span>
    gzip_comp_level 6;

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35774;&#32622;&#21738;&#20123;MIME&#31867;&#22411;&#30340;&#25991;&#20214;&#38656;&#35201;&#34987;&#21387;&#32553;&#65288;&#21160;&#24577;&#21644;&#38745;&#24577;&#37117;&#21442;&#32771;&#27492;&#20540;&#65289;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23545;&#20110;&#39044;&#21387;&#32553;&#27169;&#22359;&#65292;&#22914;&#26524;&#35831;&#27714;&#30340;&#25991;&#20214;&#31867;&#22411;&#19981;&#22312;&#27492;&#21015;&#34920;&#65292;&#21363;&#20351;&#26377;.gz&#25991;&#20214;&#20063;&#19981;&#20250;&#21457;&#36865;&#12290;</span>
    gzip_types text/plain text/css text/xml text/javascript 
               application/javascript application/xml+rss 
               application/json application/xml application/xhtml+xml 
               image/svg+xml;

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#37197;&#32622;&#20195;&#29702;&#35831;&#27714;&#30340;&#21387;&#32553;&#34892;&#20026;&#12290;&#24314;&#35758;&#35774;&#32622;&#20026;&#8220;&#20219;&#20309;&#8221;</span>
    gzip_proxied any;

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31105;&#29992;&#23545;IE6&#31561;&#21476;&#32769;&#27983;&#35272;&#22120;&#30340;gzip&#21387;&#32553;&#65288;&#23427;&#20204;&#23545;Gzip&#25903;&#25345;&#24456;&#24046;&#65289;</span>
    gzip_disable <span style="color: #8b2252;">"msie6"</span>;

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24314;&#35758;&#28155;&#21152;&#65306;&#21578;&#30693;&#20195;&#29702;&#26381;&#21153;&#22120;&#26681;&#25454;Accept-Encoding&#22836;&#32531;&#23384;&#19981;&#21516;&#29256;&#26412;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36991;&#20813;&#23558;gzip&#29256;&#26412;&#32531;&#23384;&#21518;&#21457;&#32473;&#19981;&#25903;&#25345;gzip&#30340;&#23458;&#25143;&#31471;</span>
    gzip_vary on;

    location  ~* <span style="color: #8b2252;">\.</span>json$ {
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#29992; gzip_static &#27169;&#22359;&#12290;&#25512;&#33616;&#20351;&#29992; 'on'</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">'on'&#65306;&#20248;&#20808;&#20351;&#29992;&#39044;&#21387;&#32553;&#25991;&#20214;(.gz)&#65292;&#22914;&#26524;&#19981;&#23384;&#22312;&#19988;&#23458;&#25143;&#31471;&#25903;&#25345;gzip&#65292;&#21017;&#21487;&#33021;&#36827;&#34892;&#21160;&#24577;&#21387;&#32553;&#65288;&#29256;&#26412;&#20381;&#36182;&#65289;</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">'always'&#65306;&#26080;&#35770;&#23458;&#25143;&#31471;&#26159;&#21542;&#25903;&#25345;gzip&#65292;&#37117;&#21482;&#21457;&#36865;.gz&#25991;&#20214;&#65288;&#39118;&#38505;&#39640;&#65292;&#19981;&#25512;&#33616;&#65289;</span>
        gzip_static on;

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21578;&#30693;&#23458;&#25143;&#31471;(&#27983;&#35272;&#22120;)&#35299;&#26512;&#31867;&#22411;</span>
        add_header Content-Type application/json;
        root /usr/local/nginx/html/;
    }
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21487;&#36873;&#65292;&#25903;&#25345;&#21387;&#32553;&#25991;&#20214;&#30452;&#25509;&#23637;&#31034;</span>
    location  ~* <span style="color: #8b2252;">\.</span>json<span style="color: #8b2252;">\.</span>gz$ {
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21578;&#30693;&#23458;&#25143;&#31471;(&#27983;&#35272;&#22120;)&#35299;&#26512;&#31867;&#22411;&#65292;&#21450;gzip&#21387;&#32553;&#31639;&#27861;</span>
        add_header Content-Type application/json;
        add_header Content-Encoding gzip;
        root /usr/local/nginx/html/;

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31227;&#38500;.gz&#25193;&#23637;&#21517;&#20197;&#20415;&#27983;&#35272;&#22120;&#27491;&#30830;&#20445;&#23384;&#25991;&#20214;</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">if ($request_uri ~ ^/(.*)\.gz$) {</span>
        <span style="color: #b22222;">#    </span><span style="color: #b22222;">add_header Content-Disposition "inline; filename=$1";</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">}</span>
    }
</pre>
</div>
<p>
访问 <a href="https://xxx.com/data.json">https://xxx.com/data.json</a>, 会优先使用预压缩文件data.json.gz，如果不存在，则使用动态压缩。
</p>
</div>
</div>
</div>
<div id="outline-container-h:112ce992-2335-4d44-b54f-ca3af13868ed" class="outline-3">
<h3 id="h:112ce992-2335-4d44-b54f-ca3af13868ed">https 功能</h3>
<div class="outline-text-3" id="text-h:112ce992-2335-4d44-b54f-ca3af13868ed">
<p>
Web网站的登录页面都是使用https加密传输的，加密数据以保障数据的安全，
HTTPS能够加密信息，以免敏感信息被第三方获取，所以很多银行网站或电子邮
箱等等安全级别较高的服务都会采用HTTPS协议，HTTPS其实是有两部分组成：
<code>HTTP + SSL / TLS</code> ，也就是在HTTP上又加了一层处理加密信息的模块。服务
端和客户端的信息传输都会通过TLS进行加密，所以传输的数据都是加密后的数
据。
</p>


<p>
https 实现过程如下：
</p>

<ol class="org-ol">
<li><p>
客户端发起HTTPS请求：
</p>

<p>
客户端访问某个web端的https地址，一般都是443端口
</p></li>

<li><p>
服务端的配置：
</p>

<p>
采用https协议的服务器必须要有一套证书，可以通过一些组织申请，也可以
自己制作，目前国内很多网站都自己做的，当你访问一个网站的时候提示证
书不可信任就表示证书是自己做的，证书就是一个公钥和私钥匙，就像一把
锁和钥匙，正常情况下只有你的钥匙可以打开你的锁，你可以把这个送给别
人让他锁住一个箱子，里面放满了钱或秘密，别人不知道里面放了什么而且
别人也打不开，只有你的钥匙是可以打开的。
</p></li>

<li><p>
传送证书：
</p>

<p>
服务端给客户端传递证书，其实就是公钥，里面包含了很多信息，例如证书得到颁发机构、过期时间等等。
</p></li>

<li><p>
客户端解析证书：
</p>

<p>
这部分工作是有客户端完成的，首先回验证公钥的有效性，比如颁发机构、
过期时间等等，如果发现异常则会弹出一个警告框提示证书可能存在问题，
如果证书没有问题就生成一个随机值，然后用证书对该随机值进行加密，就
像2步骤所说把随机值锁起来，不让别人看到。
</p></li>

<li><p>
传送4步骤的加密数据：
</p>

<p>
就是将用证书加密后的随机值传递给服务器，目的就是为了让服务器得到这
个随机值，以后客户端和服务端的通信就可以通过这个随机值进行加密解密
了。
</p></li>

<li><p>
服务端解密信息：
</p>

<p>
服务端用私钥解密5步骤加密后的随机值之后，得到了客户端传过来的随机值
(私钥)，然后把内容通过该值进行对称加密，对称加密就是将信息和私钥通
过算法混合在一起，这样除非你知道私钥，不然是无法获取其内部的内容，
而正好客户端和服务端都知道这个私钥，所以只要机密算法够复杂就可以保
证数据的安全性。
</p></li>

<li><p>
传输加密后的信息:
</p>

<p>
服务端将用私钥加密后的数据传递给客户端，在客户端可以被还原出原数据内容。
</p></li>

<li><p>
客户端解密信息：
</p>

<p>
客户端用之前生成的私钥获解密服务端传递过来的数据，由于数据一直是加密的，因此即使第三方获取到数据也无法知道其详细内容。
</p></li>
</ol>
</div>
<div id="outline-container-h:19764159-9cb5-46c8-b5b1-40d0cf4b3520" class="outline-4">
<h4 id="h:19764159-9cb5-46c8-b5b1-40d0cf4b3520">https 配置参数：</h4>
<div class="outline-text-4" id="text-h:19764159-9cb5-46c8-b5b1-40d0cf4b3520">
<p>
nginx 的https
功能基于模块ngx_http_ssl_module实现，因此如果是编译安装的nginx要使用参数ngx_http_ssl_module开启ssl功能，但是作为nginx的核心功能，yum安装的nginx默认就是开启的，编译安装nginx需要指定编译参数&#x2013;with-http_ssl_module开启
</p>

<p>
官方文档：<a href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html">https://nginx.org/en/docs/http/ngx_http_ssl_module.html</a>
</p>

<p>
配置参数如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">ssl on | off;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#25351;&#23450;&#30340;&#34394;&#25311;&#20027;&#26426;&#37197;&#32622;&#26159;&#21542;&#21551;&#29992;ssl&#21151;&#33021;&#65292;&#27492;&#21151;&#33021;&#22312;1.15.0&#24223;&#24323;&#65292;&#20351;&#29992;listen [ssl]&#26367;&#20195;&#12290;</span>

ssl_certificate /path/to/file;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#34394;&#25311;&#20027;&#26426;&#20351;&#29992;&#20351;&#29992;&#30340;&#20844;&#38053;&#25991;&#20214;&#65292;&#19968;&#33324;&#26159;crt&#25991;&#20214;</span>

ssl_certificate_key /path/to/file;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#34394;&#25311;&#20027;&#26426;&#20351;&#29992;&#30340;&#31169;&#38053;&#25991;&#20214;&#65292;&#19968;&#33324;&#26159;key&#25991;&#20214;</span>

ssl_protocols [SSLv2] [SSLv3] [TLSv1] [TLSv1.1] [TLSv1.2];
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25903;&#25345;ssl&#21327;&#35758;&#29256;&#26412;&#65292;&#26089;&#26399;&#20026;ssl,&#29616;&#22312;&#26159;TSL&#65292;&#40664;&#35748;&#20026;&#21518;&#19977;&#20010;</span>

ssl_session_cache off | none | [builtin[:size]] [shared:name:size];
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;ssl&#32531;&#23384;</span>
    off&#65306; &#20851;&#38381;&#32531;&#23384;
    none: &#36890;&#30693;&#23458;&#25143;&#31471;&#25903;&#25345;ssl session cache&#65292;&#20294;&#23454;&#38469;&#19981;&#25903;&#25345;
    <span style="color: #483d8b;">builtin</span>[:size]&#65306;&#20351;&#29992;OpenSSL&#20869;&#24314;&#32531;&#23384;&#65292;&#20026;&#27599;worker&#36827;&#31243;&#31169;&#26377;
    [shared:name:size]&#65306;&#22312;&#21508;worker&#20043;&#38388;&#20351;&#29992;&#19968;&#20010;&#20849;&#20139;&#30340;&#32531;&#23384;&#65292;&#38656;&#35201;&#23450;&#20041;&#19968;&#20010;&#32531;&#23384;&#21517;&#31216;&#21644;&#32531;&#23384;&#31354;&#38388;&#22823;&#23567;&#65292;&#19968;&#20806;&#21487;&#20197;&#23384;&#20648;4000&#20010;&#20250;&#35805;&#20449;&#24687;&#65292;&#22810;&#20010;&#34394;&#25311;&#20027;&#26426;&#21487;&#20197;&#20351;&#29992;&#30456;&#21516;&#30340;&#32531;&#23384;&#21517;&#31216;&#12290;

ssl_session_timeout time;<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#36830;&#25509;&#21487;&#20197;&#22797;&#29992;ssl session cache&#20013;&#32531;&#23384;&#30340;&#26377;&#25928;&#26102;&#38271;&#65292;&#40664;&#35748;5m</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:12b17bc1-9fd4-40a5-9b7c-7c62c28b3de1" class="outline-4">
<h4 id="h:12b17bc1-9fd4-40a5-9b7c-7c62c28b3de1">自签名证书</h4>
<div class="outline-text-4" id="text-h:12b17bc1-9fd4-40a5-9b7c-7c62c28b3de1">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#31614;&#21517;CA&#35777;&#20070;</span>
[root@s2 ~]# cd /apps/nginx/
[root@s2 nginx]# mkdir certs
[root@s2 nginx]# cd certs/
[root@s2 nginx]# openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 3650 -out ca.crt <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#31614;&#21517;CA&#35777;&#20070;</span>
Generating a 4096 bit RSA private key
.................++
.....
Country Name (2 letter code) [XX]:CN <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22269;&#23478;&#20195;&#30721;,https://country-code.cl/</span>
State or Province Name (full name) []:BeiJing <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30465;&#20221;</span>
Locality Name (eg, city) [Default City]:Beijing <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22478;&#24066;&#21517;&#31216;</span>
Organization Name (eg, company) [Default Company Ltd]:cici.Ltd <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20844;&#21496;&#21517;&#31216;</span>
Organizational Unit Name (eg, section) []:cici <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37096;&#38376;</span>
Common Name (eg, your name or your server<span style="color: #8b2252;">'s hostname) []:cici.ca #&#36890;&#29992;&#21517;&#31216;</span>
<span style="color: #8b2252;">Email Address []:2973707860@qq.com #&#37038;&#31665;</span>
<span style="color: #8b2252;">[root@s2 certs]# ll ca.crt</span>
<span style="color: #8b2252;">-rw-r--r-- 1 root root 2118 Feb 22 12:10 ca.crt</span>

<span style="color: #8b2252;">#&#33258;&#21046;key&#21644;csr&#25991;&#20214;</span>
<span style="color: #8b2252;">[root@s2 certs]# openssl req -newkey rsa:4096 -nodes -sha256 -keyout www.cici.net.key -out www.cici.net.csr</span>
<span style="color: #8b2252;">Generating a 4096 bit RSA private key</span>
<span style="color: #8b2252;">........................................................................++......</span>
<span style="color: #8b2252;">Country Name (2 letter code) [XX]:CN</span>
<span style="color: #8b2252;">State or Province Name (full name) []:BeiJing</span>
<span style="color: #8b2252;">Locality Name (eg, city) [Default City]:BeiJing</span>
<span style="color: #8b2252;">Organization Name (eg, company) [Default Company Ltd]:cici.net</span>
<span style="color: #8b2252;">Organizational Unit Name (eg, section) []:cici.net</span>
<span style="color: #8b2252;">Common Name (eg, your name or your server'</span>s hostname) []:www.cici.net
Email Address []:2973707860@qq.com

Please enter the following <span style="color: #8b2252;">'extra'</span> attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
[root@s2 certs]# ll
total 16
-rw-r--r-- 1 root root 2118 Feb 22 12:10 ca.crt
-rw-r--r-- 1 root root 3272 Feb 22 12:10 ca.key
-rw-r--r-- 1 root root 1760 Feb 22 12:18 www.cici.net.csr
-rw-r--r-- 1 root root 3272 Feb 22 12:18 www.cici.net.key

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31614;&#21457;&#35777;&#20070;</span>
[root@s2 certs]# openssl x509 -req -days 3650 -in www.cici.net.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out www.cici.net.crt
Signature ok
<span style="color: #a0522d;">subject</span>=/C=CN/ST=BeiJing/L=BeiJing/O=cici.net/OU=cici.net/CN=www.cici.net/emailAd
<span style="color: #a0522d;">dress</span>=2973707860@qq.com
Getting CA Private Key

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#35777;&#20070;&#20869;&#23481;</span>
[root@s2 certs]# openssl x509 -in www.cici.net.crt -noout -text
Certificate:
    Data:
        Version: 1 (0x0)
        Serial Number:
            bb:76:ea:fe:f4:04:ac:06
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: <span style="color: #a0522d;">C</span>=CN, <span style="color: #a0522d;">ST</span>=BeiJing, <span style="color: #a0522d;">L</span>=Beijing, <span style="color: #a0522d;">O</span>=cici.Ltd, <span style="color: #a0522d;">OU</span>=cici,
<span style="color: #a0522d;">CN</span>=cici.ca/emailAddress=2973707860@qq.com
        Validity
            Not Before: Feb 22 06:14:03 2019 GMT
            Not After : Feb 22 06:14:03 2020 GMT
        Subject: <span style="color: #a0522d;">C</span>=CN, <span style="color: #a0522d;">ST</span>=BeiJing, <span style="color: #a0522d;">L</span>=BeiJing, <span style="color: #a0522d;">O</span>=cici.net, <span style="color: #a0522d;">OU</span>=cici.net,
<span style="color: #a0522d;">CN</span>=www.cici.net/emailAddress=2973707860@qq.com
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (4096 bit)

</pre>
</div>
</div>
</div>
<div id="outline-container-h:196780e6-be8d-4b5d-a292-3ad60f8d98b6" class="outline-4">
<h4 id="h:196780e6-be8d-4b5d-a292-3ad60f8d98b6">https 配置</h4>
<div class="outline-text-4" id="text-h:196780e6-be8d-4b5d-a292-3ad60f8d98b6">
<div class="org-src-container">
<pre class="src src-sh">listen 80;
listen 443 ssl;
ssl_certificate /apps/nginx/certs/www.cici.net.crt;
ssl_certificate_key /apps/nginx/certs/www.cici.net.key;
ssl_session_cache shared:sslcache:20m;
ssl_session_timeout 10m;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#39564;&#35777;</span>
</pre>
</div>

<p>
访问
</p>
</div>
</div>
<div id="outline-container-h:158b808e-b617-4586-9a97-58805cb8ced0" class="outline-4">
<h4 id="h:158b808e-b617-4586-9a97-58805cb8ced0">实现多域名HTTPS</h4>
<div class="outline-text-4" id="text-h:158b808e-b617-4586-9a97-58805cb8ced0">
<p>
Nginx支持基于单个IP实现多域名的功能，并且还支持单IP多域名的基础之上实
现HTTPS，其实是基于Nginx的SNI（Server Name Indication）功能实现，SNI是
为了解决一个Nginx服务器内使用一个IP绑定多个域名和证书的功能，其具体功
能是客户端在连接到服务器建立SSL链接之前先发送要访问站点的域名
（Hostname），这样服务器再根据这个域名返回给客户端一个合适的证书。
</p>

<p>
范例: SNI功能
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#nginx -V
nginx version: nginx/1.18.0
built by gcc 8.3.1 20191121 (Red Hat 8.3.1-5) (GCC)
built with OpenSSL 1.1.1c FIPS &#160;28 May 2019
TLS SNI support enabled
configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-
http_ssl_module --with-http_v2_module --with-http_realip_module --with-
http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream
--with-stream_ssl_module --with-stream_realip_module --add-module=../echo-nginx-
module/
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21046;&#20316;key&#21644;csr&#25991;&#20214;</span>
[root@s2 certs]# openssl req -newkey rsa:4096 -nodes -sha256 -keyout mobile.cici.net.key -out mobile.cici.net.csr
Generating a 4096 bit RSA private key
..........
Country Name (2 letter code) [XX]:CN
State or Province Name (full name) []:BeiJing
Locality Name (eg, city) [Default City]:BeiJing
Organization Name (eg, company) [Default Company Ltd]:cici
Organizational Unit Name (eg, section) []:cici
Common Name (eg, your name or your server<span style="color: #8b2252;">'s hostname) []:mobile.cici.net</span>
<span style="color: #8b2252;">Email Address []:2973707860@qq.com</span>
<span style="color: #8b2252;">Please enter the following '</span>extra<span style="color: #8b2252;">' attributes</span>
<span style="color: #8b2252;">to be sent with your certificate request</span>
<span style="color: #8b2252;">A challenge password []:</span>
<span style="color: #8b2252;">An optional company name []:</span>

<span style="color: #8b2252;">#&#31614;&#21517;&#35777;&#20070;</span>
<span style="color: #8b2252;">[root@s2 certs]# openssl x509 -req -days 3650 -in mobile.cici.net.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out mobile.cici.net.crt</span>

<span style="color: #8b2252;">Signature ok</span>
<span style="color: #8b2252;">subject=/C=CN/ST=BeiJing/L=BeiJing/O=cici/OU=cici/CN=mobile.cici.net/emailAddress</span>
<span style="color: #8b2252;">=2973707860@qq.com</span>
<span style="color: #8b2252;">Getting CA Private Key</span>

<span style="color: #8b2252;">#&#39564;&#35777;&#35777;&#20070;&#20869;&#23481;</span>
<span style="color: #8b2252;">[root@s2 certs]# openssl x509 -in mobile.cici.net.crt -noout -text</span>
<span style="color: #8b2252;">Certificate:</span>
<span style="color: #8b2252;">Data:</span>
<span style="color: #8b2252;">Version: 1 (0x0)</span>
<span style="color: #8b2252;">Serial Number:</span>
<span style="color: #8b2252;">bb:76:ea:fe:f4:04:ac:07</span>
<span style="color: #8b2252;">Signature Algorithm: sha256WithRSAEncryption</span>
<span style="color: #8b2252;">Issuer: C=CN, ST=BeiJing, L=Beijing, O=cici.Ltd, OU=cici,</span>
<span style="color: #8b2252;">CN=cici.ca/emailAddress=2973707860@qq.com</span>
<span style="color: #8b2252;">Validity</span>
<span style="color: #8b2252;">Not Before: Feb 22 13:50:43 2019 GMT</span>
<span style="color: #8b2252;">Not After : Feb 19 13:50:43 2029 GMT</span>
<span style="color: #8b2252;">Subject: C=CN, ST=BeiJing, L=BeiJing, O=cici, OU=cici,</span>
<span style="color: #8b2252;">CN=mobile.cici.net/emailAddress=2973707860@qq.com</span>
<span style="color: #8b2252;">Subject Public Key Info:</span>
<span style="color: #8b2252;">Public Key Algorithm: rsaEncryption</span>
<span style="color: #8b2252;">Public-Key: (4096 bit)</span>
<span style="color: #8b2252;">..............</span>

<span style="color: #8b2252;">#&#21512;&#24182;&#35777;&#20070;&#25991;&#20214;</span>
<span style="color: #8b2252;">[root@centos8 certs]#cat mobile.cici.net.crt ca.crt &gt; mobile.cici.net.pem</span>

<span style="color: #8b2252;">#Nginx &#37197;&#32622;</span>
<span style="color: #8b2252;">[root@s2 certs]# cat /apps/nginx/conf/conf.d/mobile.conf</span>
<span style="color: #8b2252;">server {</span>
<span style="color: #8b2252;">listen 80;</span>
<span style="color: #8b2252;">server_name mobile.cici.net;</span>
<span style="color: #8b2252;">location / {</span>
<span style="color: #8b2252;">root html;</span>
<span style="color: #8b2252;">index index.html index.htm;</span>
<span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">location /linux38 {</span>
<span style="color: #8b2252;">root /data/nginx/mobile/html;</span>
<span style="color: #8b2252;">index index.html index.htm;</span>
<span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">location /python {</span>
<span style="color: #8b2252;">root /data/nginx/mobile/html;</span>
<span style="color: #8b2252;">index index.html index.htm;</span>
<span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">server {</span>
<span style="color: #8b2252;">listen 443 ssl;</span>
<span style="color: #8b2252;">server_name mobile.cici.net;</span>
<span style="color: #8b2252;">ssl_certificate /apps/nginx/certs/mobile.cici.net.pem;</span>
<span style="color: #8b2252;">ssl_certificate_key /apps/nginx/certs/mobile.cici.net.key;</span>
<span style="color: #8b2252;">ssl_session_cache shared:sslcache:20m;</span>
<span style="color: #8b2252;">ssl_session_timeout 10m;</span>
<span style="color: #8b2252;">location / {</span>
<span style="color: #8b2252;">root html;</span>
<span style="color: #8b2252;">index index.html index.htm;</span>
<span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:36c7a269-e84b-4ef0-95a1-8d4138fee973" class="outline-3">
<h3 id="h:36c7a269-e84b-4ef0-95a1-8d4138fee973">关于favicon.ico：</h3>
<div class="outline-text-3" id="text-h:36c7a269-e84b-4ef0-95a1-8d4138fee973">
<p>
favicon.ico
文件是浏览器收藏网址时显示的图标，当客户端使用浏览器问页面时，浏览器会自己主动发起请求获取页面的favicon.ico文件，但是当浏览器请求的favicon.ico文件不存在时，服务器会记录404日志，而且浏览器也会显示404报错。
</p>

<p>
解决办法：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#65306;&#26381;&#21153;&#22120;&#19981;&#35760;&#24405;&#35775;&#38382;&#26085;&#24535;&#65306;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">location = /favicon.ico {</span>
      <span style="color: #b22222;">#</span><span style="color: #b22222;">log_not_found off;</span>
      <span style="color: #b22222;">#</span><span style="color: #b22222;">access_log off;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">}</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20108;&#65306;&#23558;&#22270;&#26631;&#20445;&#23384;&#21040;&#25351;&#23450;&#30446;&#24405;&#35775;&#38382;&#65306;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">location ~ ^/favicon\.ico$ {</span>
    location = /favicon.ico {
      root /data/nginx/html/pc/images;
      expires 90d; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#25991;&#20214;&#36807;&#26399;&#26102;&#38388;</span>
    }
</pre>
</div>
</div>
</div>
<div id="outline-container-h:eb961f52-d3d3-4d9c-8e7f-23cdc715f9b3" class="outline-3">
<h3 id="h:eb961f52-d3d3-4d9c-8e7f-23cdc715f9b3">安全选项</h3>
<div class="outline-text-3" id="text-h:eb961f52-d3d3-4d9c-8e7f-23cdc715f9b3">
</div>
<div id="outline-container-h:18227715-bea2-40e9-9637-5042de3e4578" class="outline-4">
<h4 id="h:18227715-bea2-40e9-9637-5042de3e4578">隐藏Nginx版本号</h4>
<div class="outline-text-4" id="text-h:18227715-bea2-40e9-9637-5042de3e4578">
<p>
更改nginx源码信息并重新编译Nginx
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">vim src/http/ngx_http_header_filter_module.c</span>
49 static u_char ngx_http_server_string[] = <span style="color: #8b2252;">"Server: linux38"</span> CRLF; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#21709;&#24212;&#25253;&#25991;&#20013;&#30340;server&#23383;&#27573;&#20449;&#24687;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:95532596-c4df-4d85-ae29-0581ae4cc4fb" class="outline-4">
<h4 id="h:95532596-c4df-4d85-ae29-0581ae4cc4fb">升级OpenSSL版本</h4>
<div class="outline-text-4" id="text-h:95532596-c4df-4d85-ae29-0581ae4cc4fb">
<p>
心脏出血（英语：Heartbleed），也简称为心血漏洞，是一个出现在加密程序库
OpenSSL的安全漏洞，该程序库广泛用于实现互联网的传输层安全（TLS）协议。
它于2012年被引入了软件中，2014年4月首次向公众披露。只要使用的是存在缺
陷的OpenSSL实例，无论是服务器还是客户端，都可能因此而受到攻击。此问题
的原因是在实现TLS的心跳扩展时没有对输入进行适当验证（缺少边界检查），
因此漏洞的名称来源于“心跳”（heartbeat）。该程序错误属于缓冲区过读，
即可以读取的数据比应该允许读取的还多。
</p>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20934;&#22791;OpenSSL&#28304;&#30721;&#21253;&#65306;</span>

<span style="color: #483d8b;">cd</span> /usr/local/src
wget https://www.openssl.org/source/openssl-1.1.1h.tar.gz
tar xvf openssl-1.1.1h.tar.gz


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#35793;&#23433;&#35013;Nginx&#24182;&#21046;&#23450;&#26032;&#29256;&#26412;OpenSSL&#36335;&#24452;&#65306;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">cd /usr/local/src/nginx-1.16.1/</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">./configure --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --withhttp_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --withstream_realip_module --with-select_module --with-file-aio --addmodule=/usr/local/src/echo-nginx-module --with-openssl=/usr/local/src/openssl-1.1.1h</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">make &amp;&amp; make install</span>

&#39564;&#35777;&#24182;&#21551;&#21160;Nginx&#65306;
<span style="color: #b22222;"># </span><span style="color: #b22222;">/apps/nginx/sbin/nginx -t</span>
nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok
nginx: configuration file /apps/nginx/conf/nginx.conf test is successful
<span style="color: #b22222;">#</span><span style="color: #b22222;">systemctl restart nginx</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">nginx -V</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7e6a39bf-4b76-4ff8-b265-bb62f22e9716" class="outline-4">
<h4 id="h:7e6a39bf-4b76-4ff8-b265-bb62f22e9716">实现 HSTS</h4>
<div class="outline-text-4" id="text-h:7e6a39bf-4b76-4ff8-b265-bb62f22e9716">
<p>
官方文档： <a href="https://www.nginx.com/blog/http-strict-transport-security-hsts-and-nginx/">https://www.nginx.com/blog/http-strict-transport-security-hsts-and-nginx/</a>
</p>

<p>
注意: 配置rewrite才能实现http跳转到https
</p>

<div class="org-src-container">
<pre class="src src-sh">server {
 listen 443 ssl;
 server_name www.cici.org;
 add_header Strict-Transport-Security <span style="color: #8b2252;">"max-age=31536000; includeSubDomains"</span> always;
 location / {
   <span style="color: #a020f0;">if</span> ( $<span style="color: #a0522d;">scheme</span> = http ) {
    rewrite ^/(<span style="color: #483d8b;">.</span>*)$ https://www.cici.org/$<span style="color: #a0522d;">1</span> redirect;

   }
 .....
 }
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:3fd5310e-4208-402d-aef2-338f1c9de841" class="outline-3">
<h3 id="h:3fd5310e-4208-402d-aef2-338f1c9de841">其他</h3>
<div class="outline-text-3" id="text-h:3fd5310e-4208-402d-aef2-338f1c9de841">
</div>
<div id="outline-container-h:c195092a-26f3-4cda-a2ef-02c83489920b" class="outline-4">
<h4 id="h:c195092a-26f3-4cda-a2ef-02c83489920b">自动刷新 Dns 缓存</h4>
<div class="outline-text-4" id="text-h:c195092a-26f3-4cda-a2ef-02c83489920b">
<p>
nginx 中 proxy_pass 使用的是域名，域名解析的 ip 会被固定到 nginx 内部，一但发生解析记录变化就访问不了，这里添加 resover 来解决此问题。
</p>

<pre class="example" id="org88b96f0">
server {
  listen 8080;
  server_name localhost;
  resolver 114.114.114.114 223.5.5.5 valid=3600s;
  resolver_timeout 3s;
  
  location / {
    proxy_pass http://mydomain.com;
  }
}
</pre>
</div>
</div>
<div id="outline-container-h:d32f7d0c-4494-4dca-85f0-fce109502f1d" class="outline-4">
<h4 id="h:d32f7d0c-4494-4dca-85f0-fce109502f1d">nginx开启IPV6支持配置</h4>
<div class="outline-text-4" id="text-h:d32f7d0c-4494-4dca-85f0-fce109502f1d">
<p>
IPV4日益稀缺，ipv6已经慢慢走上日程，待ipv6在国内普及，使用nginx配置ipv6那是肯定的，看看如何让nginx支持ipv6以及配置.
</p>

<p>
查看nginx是否支持ipv6
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">/usr/local/nginx-1.7.0/sbin/nginx -V</span>
nginx version: nginx/1.7.0
built by gcc 4.4.7 20120313 (Red Hat 4.4.7-3) (GCC)
configure arguments: --prefix=/usr/local/nginx-1.7.0 --with-http_stub_status_module
</pre>
</div>

<p>
没有出现&#x2013;with-ipv6,说明当前的nginx不支持ipv6，所以我们需要重新编译nginx，配置里面增加&#x2013;with-ipv6，具体怎么安装，我不在啰嗦了。
</p>

<p>
同时监听IPV4和IPV6
</p>
<pre class="example" id="org47823cb">
server {
....
listen [::]:80;
...
}
</pre>

<p>
只监听IPV6
</p>
<pre class="example" id="orgcccfe46">
server {
....
listen [::]:80 default ipv6only=on;
...
}
</pre>

<p>
监听指定IPV6地址
</p>
<pre class="example" id="org2682b93">
server {
....
listen [3608:f0f0:3002:31::1]:80;
...
}
</pre>

<p>
重启nginx
</p>
<div class="org-src-container">
<pre class="src src-sh">/usr/local/nginx-1.7.0/sbin/nginx -s reload
</pre>
</div>
</div>
</div>
<div id="outline-container-h:20d0a987-a3d7-4323-905c-6f94327c8367" class="outline-4">
<h4 id="h:20d0a987-a3d7-4323-905c-6f94327c8367">nginx添加自定义header</h4>
<div class="outline-text-4" id="text-h:20d0a987-a3d7-4323-905c-6f94327c8367">
<pre class="example" id="org198aed2">
location / {
        add_header  X-UA-Compatible 'IE=Edge,chrome=1'; # 这里是自定义头
            root   www/htdocs;
            index  index.php index.html index.htm;
        }
</pre>

<p>
其中，X-UA-Compatible是名称，IE=Edge,chrome=1是值，可以随意自定义。在html的&lt;head&gt;&lt;/head&gt;标签中可以添加http请求：
&lt;meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"&gt;
</p>

<p>
添加完之后重启nginx和浏览器，然后打开添加了自定义head的页面查看效果
</p>

<p>
nginx 日志 打印自定 header 头
</p>

<p>
在nginx.conf 中的格式化日志时在 自已的header 名字前加 http_ 如，以 mac 为自定义的 header 需要在配置文件中写成 http_mac
</p>
</div>
</div>
</div>
</section>
<section id="outline-container-h:5d66ab35-95d5-4805-89da-2aab8fd24a6a" class="outline-2">
<h2 id="h:5d66ab35-95d5-4805-89da-2aab8fd24a6a">Nginx Rewrite相关功能：</h2>
<div class="outline-text-2" id="text-h:5d66ab35-95d5-4805-89da-2aab8fd24a6a">
<p>
Nginx服务器利用ngx_http_rewrite_module模块解析和处理rewrite请求，此功
能依靠 PCRE(perl compatible regularex pression)，因此编译之前要安装
PCRE库，rewrite是nginx服务器的重要功能之一，用于实现URL的重写，URL的重
写是非常有用的功能，比如它可以在我们改变网站结构之后，不需要客户端修改
原来的书签，也无需其他网站修改我们的链接，就可以设置为访问，另外还可以
在一定程度上提高网站的安全性。
</p>
</div>
<div id="outline-container-h:c714cf32-8cb2-4ff2-8567-6b40d815dc20" class="outline-3">
<h3 id="h:c714cf32-8cb2-4ff2-8567-6b40d815dc20">ngx_http_rewrite_module模块指令</h3>
<div class="outline-text-3" id="text-h:c714cf32-8cb2-4ff2-8567-6b40d815dc20">
<p>
<a href="https://nginx.org/en/docs/http/ngx_http_rewrite_module.html">https://nginx.org/en/docs/http/ngx_http_rewrite_module.html</a>
</p>
</div>
<div id="outline-container-h:7597d831-4612-4090-8546-07937a148f21" class="outline-4">
<h4 id="h:7597d831-4612-4090-8546-07937a148f21">if指令</h4>
<div class="outline-text-4" id="text-h:7597d831-4612-4090-8546-07937a148f21">
<p>
用于条件匹配判断，并根据条件判断结果选择不同的Nginx配置，可以配置在
server或location块中进行配置，Nginx的if语法仅能使用if做单次判断，不支
持使用if else或者if elif这样的多重判断，用法如下：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a020f0;">if</span> &#65288;&#26465;&#20214;&#21305;&#37197;&#65289; {
    action
}
</pre>
</div>

<p>
使用正则表达式对变量进行匹配，匹配成功时if指令认为条件为true，否则认为false，变量与表达式之间使用以下符号链接：
</p>

<div class="org-src-container">
<pre class="src src-sh">=&#65306; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27604;&#36739;&#21464;&#37327;&#21644;&#23383;&#31526;&#20018;&#26159;&#21542;&#30456;&#31561;&#65292;&#30456;&#31561;&#26102;if&#25351;&#20196;&#35748;&#20026;&#35813;&#26465;&#20214;&#20026;true&#65292;&#21453;&#20043;&#20026;false&#12290;</span>
!=: <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27604;&#36739;&#21464;&#37327;&#21644;&#23383;&#31526;&#20018;&#26159;&#21542;&#19981;&#30456;&#31561;&#65292;&#19981;&#30456;&#31561;&#26102;if&#25351;&#20196;&#35748;&#20026;&#26465;&#20214;&#20026;true&#65292;&#21453;&#20043;&#20026;false&#12290;</span>
~&#65306; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#34920;&#31034;&#22312;&#21305;&#37197;&#36807;&#31243;&#20013;&#21306;&#20998;&#22823;&#23567;&#20889;&#23383;&#31526;&#65292;&#65288;&#21487;&#20197;&#36890;&#36807;&#27491;&#21017;&#34920;&#36798;&#24335;&#21305;&#37197;&#65289;&#65292;&#28385;&#36275;&#21305;&#37197;&#26465;&#20214;&#20026;&#30495;&#65292;&#19981;&#28385;&#36275;&#20026;&#20551;&#12290;</span>
!~&#65306;#&#20026;&#21306;&#20998;&#22823;&#23567;&#20889;&#23383;&#31526;&#19988;&#21305;&#37197;&#32467;&#26524;&#19981;&#21305;&#37197;&#65292;&#19981;&#28385;&#36275;&#20026;&#30495;&#65292;&#28385;&#36275;&#20026;&#20551;&#12290;
~*: <span style="color: #b22222;">#</span><span style="color: #b22222;">&#34920;&#31034;&#22312;&#21305;&#37197;&#36807;&#31243;&#20013;&#19981;&#21306;&#20998;&#22823;&#23567;&#20889;&#23383;&#31526;&#65292;&#65288;&#21487;&#20197;&#36890;&#36807;&#27491;&#21017;&#34920;&#36798;&#24335;&#21305;&#37197;&#65289;&#65292;&#28385;&#36275;&#21305;&#37197;&#26465;&#20214;&#20026;&#30495;&#65292;&#19981;&#28385;&#36275;&#20026;&#20551;&#12290;</span>
!~*: <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#19981;&#21306;&#20998;&#22823;&#23567;&#23383;&#31526;&#19988;&#21305;&#37197;&#32467;&#26524;&#19981;&#21305;&#37197;&#65292;&#28385;&#36275;&#20026;&#20551;&#65292;&#19981;&#28385;&#36275;&#20026;&#30495;&#12290;</span>

-f &#21644; ! -f: <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21028;&#26029;&#35831;&#27714;&#30340;&#25991;&#20214;&#26159;&#21542;&#23384;&#22312;&#21644;&#26159;&#21542;&#19981;&#23384;&#22312;</span>
-d &#21644; ! -d: <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21028;&#26029;&#35831;&#27714;&#30340;&#30446;&#24405;&#26159;&#21542;&#23384;&#22312;&#21644;&#26159;&#21542;&#19981;&#23384;&#22312;&#12290;</span>
-x &#21644; ! -x: <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21028;&#26029;&#25991;&#20214;&#26159;&#21542;&#21487;&#25191;&#34892;&#21644;&#26159;&#21542;&#19981;&#21487;&#25191;&#34892;&#12290;</span>
-e &#21644; ! -e: <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21028;&#26029;&#35831;&#27714;&#30340;&#25991;&#20214;&#25110;&#30446;&#24405;&#26159;&#21542;&#23384;&#22312;&#21644;&#26159;&#21542;&#19981;&#23384;&#22312;(&#21253;&#25324;&#25991;&#20214;&#65292;&#30446;&#24405;&#65292;&#36719;&#38142;&#25509;)&#12290;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#65306;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;$&#21464;&#37327;&#30340;&#20540;&#20026;&#31354;&#23383;&#31526;&#20018;&#25110;0&#65292;&#21017;if&#25351;&#20196;&#35748;&#20026;&#35813;&#26465;&#20214;&#20026;false&#65292;&#20854;&#20182;&#26465;&#20214;&#20026;true&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">nginx 1.0.1&#20043;&#21069;$&#21464;&#37327;&#30340;&#20540;&#22914;&#26524;&#20197;0&#24320;&#22836;&#30340;&#20219;&#24847;&#23383;&#31526;&#20018;&#20250;&#36820;&#22238;false</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23454;&#20363;-1&#65306;</span>
location /main {
    index index.html;
    default_type text/html;
    <span style="color: #a020f0;">if</span> ( $<span style="color: #a0522d;">scheme</span> = http ){
      <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"if-----&gt; $scheme"</span>;
    }
    <span style="color: #a020f0;">if</span> ( $<span style="color: #a0522d;">scheme</span> = https ){
      <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"if ----&gt; $scheme"</span>;
    }

    <span style="color: #b22222;">#</span><span style="color: #b22222;">if (-f $request_filename) {</span>
    <span style="color: #b22222;">#   </span><span style="color: #b22222;">echo "file is exist";</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">}</span>
    <span style="color: #a020f0;">if</span> (!-f $<span style="color: #a0522d;">request_filename</span>) {
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"file is not exist"</span>;
        <span style="color: #b22222;">#</span><span style="color: #b22222;">return 409;</span>
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2a488004-5f90-401b-8770-7afd4dd839bd" class="outline-4">
<h4 id="h:2a488004-5f90-401b-8770-7afd4dd839bd">set指令</h4>
<div class="outline-text-4" id="text-h:2a488004-5f90-401b-8770-7afd4dd839bd">
<p>
指定key并给其定义一个变量，变量可以调用Nginx内置变量赋值给key，另外set
定义格式为set $key value，value可以是text, variables和两者的组合。
</p>

<div class="org-src-container">
<pre class="src src-sh">location /main {
  root /data/nginx/html/pc;
  index index.html;
  default_type text/html;
  <span style="color: #483d8b;">set</span> $<span style="color: #a0522d;">name</span> cici;
  <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">name</span>;
  <span style="color: #483d8b;">set</span> $<span style="color: #a0522d;">my_port</span> $<span style="color: #a0522d;">server_port</span>;
  <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">my_port</span>;
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:350e9919-503e-4cff-8f4c-c9f317a76b35" class="outline-4">
<h4 id="h:350e9919-503e-4cff-8f4c-c9f317a76b35">break 指令：</h4>
<div class="outline-text-4" id="text-h:350e9919-503e-4cff-8f4c-c9f317a76b35">
<p>
用于中断当前相同作用域(location)中的其他Nginx配置，与该指令处于同一作
用域的Nginx配置中，位于它前面的配置生效，位于后面的
ngx_http_rewrite_module 模块中指令就不再执行，Nginx服务器在根据配置处
理请求的过程中遇到该指令的时候，回到上一层作用域继续向下读取配置，该指
令可以在server块和locationif块中使用
</p>

<p>
注意: 如果break指令在location块中后续指令还会继续执行,只是不执行
ngx_http_rewrite_module 模块的指令,其它指令还会执行
</p>

<p>
使用语法如下：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a020f0;">if</span> ($<span style="color: #a0522d;">slow</span>) {
 limit_rate 10k;
 <span style="color: #a020f0;">break</span>;
}
location /main {
 root /data/nginx/html/pc;
 index index.html;
 default_type text/html;
 <span style="color: #483d8b;">set</span> $<span style="color: #a0522d;">name</span> cici;
 <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">name</span>;
 <span style="color: #a020f0;">break</span>;  <span style="color: #b22222;">#</span><span style="color: #b22222;">location&#22359;&#20013;break&#21518;&#38754;&#25351;&#20196;&#36824;&#20250;&#25191;&#34892;</span>
 <span style="color: #483d8b;">set</span> $<span style="color: #a0522d;">my_port</span> $<span style="color: #a0522d;">server_port</span>;
 <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">my_port</span>;
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5c65a8b8-788e-4de8-bc62-7886a95b20c2" class="outline-4">
<h4 id="h:5c65a8b8-788e-4de8-bc62-7886a95b20c2">return 指令</h4>
<div class="outline-text-4" id="text-h:5c65a8b8-788e-4de8-bc62-7886a95b20c2">
<p>
return用于完成对请求的处理，并直接向客户端返回响应状态码，比如:可以指
定重定向URL(对于特殊重定向状态码，301/302等) 或者是指定提示文本内容(对
于特殊状态码403/500等)，处于此指令后的所有配置都将不被执行，return可以
在server、if 和 location块进行配置
</p>

<p>
语法格式：
</p>
<pre class="example" id="orga1f5191">
return code; #返回给客户端指定的HTTP状态码
return code [text]; #返回给客户端的状态码及响应报文的实体内容，可以调用变量,其中text如果有空格,需要用单或双引号
return code URL; #返回给客户端的URL地址
</pre>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">location /main {
  root /data/nginx/html/pc;
  default_type text/html;
  index index.html;
    <span style="color: #a020f0;">if</span> ( $<span style="color: #a0522d;">scheme</span> = http ){
      <span style="color: #b22222;">#</span><span style="color: #b22222;">return 666;</span>
      <span style="color: #b22222;">#</span><span style="color: #b22222;">return 666 "not allow http";</span>
      <span style="color: #b22222;">#</span><span style="color: #b22222;">return 301 http://www.baidu.com;</span>
      <span style="color: #a020f0;">return</span> 500 <span style="color: #8b2252;">"service error"</span>;
      <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"if-----&gt; $scheme"</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">return&#21518;&#38754;&#30340;&#23558;&#19981;&#20877;&#25191;&#34892;</span>
    }
    <span style="color: #a020f0;">if</span> ( $<span style="color: #a0522d;">scheme</span> = https ){
      <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"if ----&gt; $scheme"</span>;
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1da87f2c-b0f5-4634-b13d-f43d036552ae" class="outline-4">
<h4 id="h:1da87f2c-b0f5-4634-b13d-f43d036552ae">rewrite_log 指令：</h4>
<div class="outline-text-4" id="text-h:1da87f2c-b0f5-4634-b13d-f43d036552ae">
<p>
设置是否开启记录ngx_http_rewrite_module模块日志记录到error_log日志文件当中，可以配置在http、server、location或if当中，需要日志级别为notice
。
</p>

<div class="org-src-container">
<pre class="src src-sh">location /main {
    index index.html;
    default_type text/html;
    <span style="color: #483d8b;">set</span> $<span style="color: #a0522d;">name</span> cici;
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">name</span>;
    rewrite_log on;
    <span style="color: #a020f0;">break</span>;
    <span style="color: #483d8b;">set</span> $<span style="color: #a0522d;">my_port</span> $<span style="color: #a0522d;">server_port</span>;
    <span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">my_port</span>;
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;nginx&#65292;&#35775;&#38382;&#24182;&#39564;&#35777;error_log&#65306;</span>
[root@s2 ~]# tail -f /apps/nginx/logs/error.log
2019/02/27 15:10:02 [warn] 5815#0: *3 using uninitialized <span style="color: #8b2252;">"my_port"</span> variable, client:192.168.0.1, server: www.cici.net, request: <span style="color: #8b2252;">"GET /main HTTP/1.1"</span>, host:<span style="color: #8b2252;">"www.cici.net"</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ac2f0694-206b-4681-9aea-0f85d4af23f9" class="outline-3">
<h3 id="h:ac2f0694-206b-4681-9aea-0f85d4af23f9">rewrite 指令：</h3>
<div class="outline-text-3" id="text-h:ac2f0694-206b-4681-9aea-0f85d4af23f9">
<p>
通过正则表达式的匹配来改变URI，可以同时存在一个或多个指令，按照顺序依次对URI进行匹配，rewrite主要是针对用户请求的URL或者是URI做具体处理
</p>

<p>
官方文档： <a href="https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite">https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite</a>
</p>

<p>
rewrite可以配置在 server、location、if
</p>

<p>
语法格式 ：
</p>
<pre class="example" id="org6b1dfba">
rewrite regex replacement [flag];
</pre>

<p>
rewrite将用户请求的URI基于regex所描述的模式进行检查，匹配到时将其替换为表达式指定的新的URI
</p>


<p>
以下是URL和URI的具体介绍：
</p>

<ul class="org-ul">
<li>URI(universal resource identifier)：通用资源标识符，标识一个资源的路
径，可以不带协议。</li>

<li><p>
URL(uniform resource location):统一资源定位符，是用于在Internet中描
述资源的字符串，是URI的子集，主要包括传输协议(scheme)、主机(IP、端口
号或者域名)和资源具体地址(目录和文件名)等三部分
</p>

<p>
一般格式为scheme://主机名[:端口号][/资源路径],如：
<a href="http://www.a.com:8080/path/file/index.html">http://www.a.com:8080/path/file/index.html</a>就是一个URL路径，URL必须带
访问协议。
</p>

<p>
每个URL都是一个URI，但是URI不都是URL。
</p></li>
</ul>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">http://example.org:8080/path/to/resource.txt <span style="color: #b22222;">#</span><span style="color: #b22222;">URI/URL</span>
ftp://example.org/resource.txt <span style="color: #b22222;">#</span><span style="color: #b22222;">URI/URL</span>
/absolute/path/to/resource.txt <span style="color: #b22222;">#</span><span style="color: #b22222;">URI</span>
</pre>
</div>

<p>
注意：如果在同一级配置块中存在多个rewrite规则，那么会自上而下逐个检查;
被某条件规则替换完成后，会重新一轮的替换检查，隐含有循环机制,但不超过
10次;如果超过，提示500响应码，[flag]所表示的标志位用于控制此循环机制
</p>

<p>
如果替换后的URL是以<a href="http://">http://</a>或<a href="https://">https://</a>开头，则替换结果会直接以重定向
返回给客户端, 即永久重定向 301
</p>

<p>
正则表达式格式
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">.</span>       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#38500;&#25442;&#34892;&#31526;&#20197;&#22806;&#30340;&#20219;&#24847;&#23383;&#31526;</span>
\w      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#23383;&#27597;&#25110;&#25968;&#23383;&#25110;&#19979;&#21010;&#32447;&#25110;&#27721;&#23383;</span>
\s      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#20219;&#24847;&#30340;&#31354;&#30333;&#31526;</span>
\d      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#25968;&#23383;</span>
\b      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#21333;&#35789;&#30340;&#24320;&#22987;&#25110;&#32467;&#26463;</span>
^       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#23383;&#20184;&#20018;&#30340;&#24320;&#22987;</span>
$       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#23383;&#31526;&#20018;&#30340;&#32467;&#26463;</span>
*      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#37325;&#22797;&#38646;&#27425;&#25110;&#26356;&#22810;&#27425;</span>
+       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#37325;&#22797;&#19968;&#27425;&#25110;&#26356;&#22810;&#27425;</span>
?       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#37325;&#22797;&#38646;&#27425;&#25110;&#19968;&#27425;</span>
(n)     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#37325;&#22797;n&#27425;</span>
{n,}    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#37325;&#22797;n&#27425;&#25110;&#26356;&#22810;&#27425;</span>
{n,m}   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#37325;&#22797;n&#21040;m&#27425;</span>
*?     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#37325;&#22797;&#20219;&#24847;&#27425;&#65292;&#20294;&#23613;&#21487;&#33021;&#23569;&#37325;&#22797;</span>
+?      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#37325;&#22797;1&#27425;&#25110;&#26356;&#22810;&#27425;&#65292;&#20294;&#23613;&#21487;&#33021;&#23569;&#37325;&#22797;</span>
??      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#37325;&#22797;0&#27425;&#25110;1&#27425;&#65292;&#20294;&#23613;&#21487;&#33021;&#23569;&#37325;&#22797;</span>
{n,m}?  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#37325;&#22797;n&#21040;m&#27425;&#65292;&#20294;&#23613;&#21487;&#33021;&#23569;&#37325;&#22797;</span>
{n,}?   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#37325;&#22797;n&#27425;&#20197;&#19978;&#65292;&#20294;&#23613;&#21487;&#33021;&#23569;&#37325;&#22797;</span>
\W      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#20219;&#24847;&#19981;&#26159;&#23383;&#27597;&#65292;&#25968;&#23383;&#65292;&#19979;&#21010;&#32447;&#65292;&#27721;&#23383;&#30340;&#23383;&#31526;</span>
\S      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#20219;&#24847;&#19981;&#26159;&#31354;&#30333;&#31526;&#30340;&#23383;&#31526;</span>
\D      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#20219;&#24847;&#38750;&#25968;&#23383;&#30340;&#23383;&#31526;</span>
\B      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#19981;&#26159;&#21333;&#35789;&#24320;&#22836;&#25110;&#32467;&#26463;&#30340;&#20301;&#32622;</span>
[^x]    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#38500;&#20102;x&#20197;&#22806;&#30340;&#20219;&#24847;&#23383;&#31526;</span>
[^cici] <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#38500;&#20102;cici &#36825;&#20960;&#20010;&#23383;&#27597;&#20197;&#22806;&#30340;&#20219;&#24847;&#23383;&#31526;</span>
</pre>
</div>
</div>
<div id="outline-container-h:b62a6305-cd9b-4475-a974-b7fc8bfc461f" class="outline-4">
<h4 id="h:b62a6305-cd9b-4475-a974-b7fc8bfc461f">rewrite flag使用介绍</h4>
<div class="outline-text-4" id="text-h:b62a6305-cd9b-4475-a974-b7fc8bfc461f">
<p>
利用nginx的rewrite的指令，可以实现url的重新跳转，rewrtie有四种不同的
flag，分别是redirect(临时重定向302)、permanent(永久重定向301)、break和
last。其中前两种是跳转型的flag，后两种是代理型
</p>

<ul class="org-ul">
<li>跳转型指由客户端浏览器重新对新地址进行请求</li>
<li>代理型是在WEB服务器内部实现跳转</li>
</ul>

<p>
rewrite 格式
</p>
<div class="org-src-container">
<pre class="src src-text">Syntax: rewrite regex replacement [flag]; #&#36890;&#36807;&#27491;&#21017;&#34920;&#36798;&#24335;&#22788;&#29702;&#29992;&#25143;&#35831;&#27714;&#24182;&#36820;&#22238;&#26367;&#25442;&#21518;&#30340;&#25968;&#25454;&#21253;&#12290;
Default: &#8212;
Context: server, location, if
</pre>
</div>


<p>
flag说明
</p>
<ul class="org-ul">
<li>redirect;
<ul class="org-ul">
<li>临时重定向，重写完成后以临时重定向方式直接返回重写后生成的新URL给客户端，由客户端重新发起请求;</li>
<li>使用相对路径,或者 <code>http://</code> 或 <code>https://</code> 开头，状态码：302</li>
</ul></li>

<li>permanent;
<ul class="org-ul">
<li>重写完成后以永久重定向方式直接返回重写后生成的新URL给客户端，由客户端重新发起请求，状态码：301</li>
</ul></li>

<li>break;
<ul class="org-ul">
<li>重写完成后,停止对当前URL在当前location中后续的其它重写操作，而后直接跳转至重写规则配置块之后的其它配置;结束循环</li>
<li>建议在location中使用</li>
<li>适用于一个URL一次重写</li>
</ul></li>

<li>last;
<ul class="org-ul">
<li>重写完成后,停止对当前URI在当前location中后续的其它重写操作，而后对新的URL启动新一轮重写检查</li>
<li>不建议在location中使用</li>
<li>适用于一个URL多次重写，要注意避免出现超过十次以及URL重写后返回错误的给用户</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:e4691f27-d431-4884-9c69-4806f03c357c" class="outline-4">
<h4 id="h:e4691f27-d431-4884-9c69-4806f03c357c">rewrite案例-域名永久与临时重定向</h4>
<div class="outline-text-4" id="text-h:e4691f27-d431-4884-9c69-4806f03c357c">
<p>
要求：因业务需要，将访问源域名 www.cici.net的请求永久重定向到
www.cici.com 。
</p>

<p>
临时重定向不会缓存域名解析记录(A记录)，但是永久重定向会缓存。
</p>

<div class="org-src-container">
<pre class="src src-sh">location / {
  root /data/nginx/html/pc;
  index index.html;
  rewrite / http://www.cici.com permanent;
  <span style="color: #b22222;">#</span><span style="color: #b22222;">rewrite / http://www.cici.com redirect;</span>
}
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#22495;&#21517;www.cici.net&#36827;&#34892;&#27979;&#35797;</span>
</pre>
</div>
</div>
<div id="outline-container-h:bb381b92-7c7a-4592-9f02-a43c0a564e67" class="outline-5">
<h5 id="h:bb381b92-7c7a-4592-9f02-a43c0a564e67">永久重定向301</h5>
<div class="outline-text-5" id="text-h:bb381b92-7c7a-4592-9f02-a43c0a564e67">
<p>
域名永久重定向，京东早期的域名 www.360buy.com由于与360公司类似，于是后
期永久重定向到了 www.jd.com，永久重定向会缓存DNS解析记录。
</p>
</div>
</div>
<div id="outline-container-h:c82b48ec-b14f-43a0-b45b-df668ea41e2b" class="outline-5">
<h5 id="h:c82b48ec-b14f-43a0-b45b-df668ea41e2b">临时重定向302</h5>
<div class="outline-text-5" id="text-h:c82b48ec-b14f-43a0-b45b-df668ea41e2b">
<p>
域名临时重定向，告诉浏览器域名不是固定重定向到当前目标域名，后期可能随
时会更改，因此浏览器不会缓存当前域名的解析记录，而浏览器会缓存永久重定
向的DNS解析记录，这也是临时重定向与永久重定向最大的本质区别。
</p>
</div>
</div>
</div>
<div id="outline-container-h:c7b6d77f-bc95-4382-9ba9-dadcf3785017" class="outline-4">
<h4 id="h:c7b6d77f-bc95-4382-9ba9-dadcf3785017">rewrite案例 break 与 last</h4>
<div class="outline-text-4" id="text-h:c7b6d77f-bc95-4382-9ba9-dadcf3785017">
<p>
大部分场合下，break单次重写就足够了
</p>

<p>
要求：访问about的请求被转发至images，而访问images传递请求再次被转发至images1，以此测试last和break分别有什么区别：
</p>
</div>
<div id="outline-container-h:4838a0ae-87c3-4966-b225-c3e4c41a8c64" class="outline-5">
<h5 id="h:4838a0ae-87c3-4966-b225-c3e4c41a8c64">break案例</h5>
<div class="outline-text-5" id="text-h:4838a0ae-87c3-4966-b225-c3e4c41a8c64">
<p>
break测试案例：
</p>
<ul class="org-ul">
<li>当客户端访问break的时候，测试通过rewrite将URL重写为test1，然后再通过rewrite将test1重写为test2，测试两条write规则最终哪一条生效，并且测试重写后的URL会不会到其他 location重新匹配。</li>
</ul>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">Nginx&#37197;&#32622;&#65306;</span>
    location /break {
      <span style="color: #b22222;">#</span><span style="color: #b22222;">return 666 "break";</span>
      root /data/nginx;
      index index.html;
      rewrite ^/break/(<span style="color: #483d8b;">.</span>*) /test1/$<span style="color: #a0522d;">1</span> break; <span style="color: #b22222;">#</span><span style="color: #b22222;">break&#21305;&#37197;&#25104;&#21151;&#21518;&#19981;&#20877;&#21521;&#19979;&#21305;&#37197;&#65292;&#20063;&#19981;&#20250;&#36339;&#36716;&#21040;&#20854;&#20182;&#30340;location&#65292;&#21363;&#30452;&#25509;&#32467;&#26463;&#21305;&#37197;&#24182;&#32473;&#23458;&#25143;&#31471;&#36820;&#22238;&#32467;&#26524;&#25968;&#25454;&#12290;</span>
      rewrite ^/test1/(<span style="color: #483d8b;">.</span>*) /test2/$<span style="color: #a0522d;">1</span> break; <span style="color: #b22222;">#</span><span style="color: #b22222;">break&#19981;&#20250;&#21305;&#37197;&#21518;&#38754;&#30340;rewrite&#35268;&#21017;&#20063;&#19981;&#21305;&#37197;&#20854;&#20182;location</span>
    }

    location = /test1 {
      <span style="color: #a020f0;">return</span> 999 <span style="color: #8b2252;">"new test1"</span>;
      <span style="color: #b22222;">#</span><span style="color: #b22222;">index index.html;</span>
      <span style="color: #b22222;">#</span><span style="color: #b22222;">root /data/nginx;</span>
    }

    location = /test2 {
      <span style="color: #a020f0;">return</span> 666 <span style="color: #8b2252;">"new test2"</span>;
      <span style="color: #b22222;">#</span><span style="color: #b22222;">root /opt/nginx;</span>
      <span style="color: #b22222;">#</span><span style="color: #b22222;">index index.html;</span>
    }

&#21019;&#24314;&#36164;&#28304;&#36335;&#24452;&#65306;
<span style="color: #b22222;"># </span><span style="color: #b22222;">mkdir /data/nginx/break</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">mkdir /data/nginx/test1</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">mkdir /data/nginx/test2</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">cat /data/nginx/break/index.html</span>
<span style="color: #a020f0;">break</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">cat /data/nginx/test1/index.html</span>
test1
<span style="color: #b22222;"># </span><span style="color: #b22222;">cat /data/nginx/test2/index.html</span>
test2

<span style="color: #b22222;"># </span><span style="color: #b22222;">/apps/nginx/sbin/nginx -t</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">/apps/nginx/sbin/nginx -s reload</span>

<span style="color: #a020f0;">break</span>&#35775;&#38382;&#27979;&#35797;&#65306;
[root@s3 ~]# curl -L http://www.cici.net/break/index.html
test1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#32456;&#30340;&#32467;&#26524;&#19981;&#20250;&#36229;&#20986;break&#30340;location&#32780;&#19988;&#19981;&#20250;&#32487;&#32493;&#21305;&#37197;&#24403;&#21069;location&#21518;&#32493;&#30340;write&#35268;&#21017;&#65292;&#32780;&#19988;&#30452;&#25509;&#36820;&#22238;&#25968;&#25454;&#32473;&#23458;&#25143;&#31471;&#12290;</span>
</pre>
</div>

<p>
break适用于不改变客户端访问方式，但是要将访问的目的URL做单次重写的场景，比如有V1/V2两个版本的网站前端页面并存，旧版本的网站数据已经保存到了statics不能丢失，但是要将访问新版本的资源重写到新的静态资源路径到新的目录static：
</p>
<div class="org-src-container">
<pre class="src src-sh">    location /statics {
      root /data/nginx;
      index index.html;
      rewrite ^/statics/(<span style="color: #483d8b;">.</span>*) /static/$<span style="color: #a0522d;">1</span> break;
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:eae3dd9a-97b6-413b-a4c7-23ed8690456b" class="outline-5">
<h5 id="h:eae3dd9a-97b6-413b-a4c7-23ed8690456b">last案例</h5>
<div class="outline-text-5" id="text-h:eae3dd9a-97b6-413b-a4c7-23ed8690456b">
<p>
last：对某个location的URL匹配成功后会停止当前location的后续rewrite规则，并结束当前location，然后将匹配生成的新URL跳转至其他location继续匹配，直到没有location可匹配后将最后一次location的数据返回给客户端。
</p>

<p>
last适用于要不改变客户端访方式但是需做多次目的URL重写的场景，场景不是很多。
</p>
<div class="org-src-container">
<pre class="src src-sh">    location /test1 {
      <span style="color: #b22222;">#</span><span style="color: #b22222;">return 999 "new test1";</span>
      index index.html;
      root /data/nginx;
      rewrite ^/test1/(<span style="color: #483d8b;">.</span>*) /test2/$<span style="color: #a0522d;">1</span> last;
    }

    location /test2 {
      <span style="color: #a020f0;">return</span> 666 <span style="color: #8b2252;">"new test2"</span>;
      <span style="color: #b22222;">#</span><span style="color: #b22222;">root /opt/nginx;</span>
      <span style="color: #b22222;">#</span><span style="color: #b22222;">index index.html;</span>
    }

    location /last {
      root /data/nginx;
      index index.html;
      rewrite ^/last/(<span style="color: #483d8b;">.</span>*) /test1/$<span style="color: #a0522d;">1</span> last;
      <span style="color: #b22222;">#</span><span style="color: #b22222;">rewrite ^/test1/(.*) /test2/$1 last; #&#22914;&#26524;&#31532;&#19968;&#26465;rewrite&#35268;&#21017;&#21305;&#37197;&#25104;&#21151;&#21017;&#19981;&#25191;&#34892;&#26412;&#26465;&#65292;&#21542;&#21017;&#25191;&#34892;&#26412;&#26465;rewrite&#35268;&#21017;&#12290;</span>
    }

last&#35775;&#38382;&#27979;&#35797;&#65306;
[root@s3 ~]# curl -L http://www.cici.net/last/index.html
new test2 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20250;&#21305;&#37197;&#22810;&#20010;location&#65292;&#30452;&#21040;&#26368;&#32456;&#20840;&#37096;&#21305;&#37197;&#23436;&#25104;&#65292;&#36820;&#22238;&#26368;&#21518;&#19968;&#20010;location&#30340;&#21305;&#37197;&#32467;&#26524;&#32473;&#23458;&#25143;&#31471;&#12290;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:bdbd6f1b-2c7d-481b-9fb9-2f1ecf6083a0" class="outline-4">
<h4 id="h:bdbd6f1b-2c7d-481b-9fb9-2f1ecf6083a0">rewrite案例-自动跳转https</h4>
<div class="outline-text-4" id="text-h:bdbd6f1b-2c7d-481b-9fb9-2f1ecf6083a0">
<p>
要求：基于通信安全考虑公司网站要求全站https，因此要求将在不影响用户请求的情况下将http请求全部自动跳转至https，另外也可以实现部分location跳转
</p>

<div class="org-src-container">
<pre class="src src-sh">server {
  listen 443 ssl;
  listen 80;
  ssl_certificate /apps/nginx/certs/www.cici.net.crt;
  ssl_certificate_key /apps/nginx/certs/www.cici.net.key;
  ssl_session_cache shared:sslcache:20m;
  ssl_session_timeout 10m;
  server_name www.cici.net;
  location / {
    root /data/nginx/html/pc;
    index index.html;
    <span style="color: #a020f0;">if</span> ($<span style="color: #a0522d;">scheme</span> = http ){     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26410;&#21152;&#26465;&#20214;&#21028;&#26029;&#65292;&#20250;&#23548;&#33268;&#27515;&#24490;&#29615;</span>
      rewrite / https://www.cici.net permanent;
    }
  }
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#27979;&#35797;</span>
[root@s3 ~]# curl -L -k -i https://www.cici.net/
HTTP/1.1 200 OK
Server: nginx
Date: Fri, 15 Mar 2019 19:53:07 GMT
Content-Type: text/html
Content-Length: 7
Last-Modified: Thu, 14 Mar 2019 14:54:50 GMT
Connection: keep-alive
Keep-Alive: <span style="color: #a0522d;">timeout</span>=60
ETag: <span style="color: #8b2252;">"5c8a6b3a-7"</span>
Accept-Ranges: bytes

pc web
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a6401ec0-ac7e-4f38-a558-4a0a1e4b6d9a" class="outline-4">
<h4 id="h:a6401ec0-ac7e-4f38-a558-4a0a1e4b6d9a">rewrite案例-判断文件是否存在</h4>
<div class="outline-text-4" id="text-h:a6401ec0-ac7e-4f38-a558-4a0a1e4b6d9a">
<p>
要求：当用户访问到公司网站的时输入了一个错误的URL，可以将用户重定向至官网首页。
</p>

<div class="org-src-container">
<pre class="src src-sh">location / {
  root /data/nginx/html/pc;
  index index.html;
  <span style="color: #a020f0;">if</span> (!-e $<span style="color: #a0522d;">request_filename</span>) {
    <span style="color: #b22222;">#</span><span style="color: #b22222;">return 404 "linux35";</span>
    rewrite (<span style="color: #483d8b;">.</span>*) http://www.cici.net/index.html; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23454;&#29616;&#23458;&#25143;&#31471;&#27983;&#35272;&#22120;&#30340;302&#36339;&#36716;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">rewrite .* /index.html; #web&#26381;&#21153;&#22120;&#20869;&#37096;&#36339;&#36716;</span>
  }
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#27979;&#35797;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1e52a22e-8000-4fb8-8a5b-9b65afca8a58" class="outline-4">
<h4 id="h:1e52a22e-8000-4fb8-8a5b-9b65afca8a58">其他案例</h4>
<div class="outline-text-4" id="text-h:1e52a22e-8000-4fb8-8a5b-9b65afca8a58">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26696;&#20363;1:&#22914;&#26524;&#23458;&#25143;&#31471;&#27983;&#35272;&#22120;&#21253;&#21547;MSIE&#65292;&#21017;rewrite&#23458;&#25143;&#31471;&#35831;&#27714;&#21040;/msie&#30446;&#24405;&#19979;</span>
<span style="color: #a020f0;">if</span> ( $<span style="color: #a0522d;">http_user_agent</span> ~ MSIE){
rewrite ^(<span style="color: #483d8b;">.</span>*)$ /msie/$<span style="color: #a0522d;">1</span> break;
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26696;&#20363;2: &#26356;&#25442;&#30446;&#24405;&#35775;&#38382;&#26041;&#24335;,&#30446;&#24405;&#36716;&#25442;&#20026;&#23545;&#35937;&#23384;&#20648;&#24418;&#24335;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35201;&#27714;:</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">/20200106/static -&gt;/static?id=20200106</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">/20200123/image -&gt;/image?id=20200123</span>
rewrite ^/(\d+)/(<span style="color: #483d8b;">.</span>+)/ /$<span style="color: #a0522d;">2</span>?<span style="color: #a0522d;">id</span>=$<span style="color: #a0522d;">l</span> last;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26696;&#20363;3:&#22810;&#30446;&#24405;&#36716;&#25442;&#35775;&#38382;&#26041;&#24335;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35201;&#27714;: www.cici.com/images/20200106/1.jpg =&gt; www.cici.com/index.do?name=images&amp;dir=20200106=&amp;file=1.jpg</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35268;&#21017;&#37197;&#32622;:</span>
<span style="color: #a020f0;">if</span> ($<span style="color: #a0522d;">host</span> ~* (<span style="color: #483d8b;">.</span>*)<span style="color: #8b2252;">\.</span>cici<span style="color: #8b2252;">\.</span>com) {
rewrite ^/(<span style="color: #483d8b;">.</span>*)/(\d+)/(<span style="color: #483d8b;">.</span>*)$ /index.do?<span style="color: #a0522d;">name</span>=$<span style="color: #a0522d;">1</span>&amp;<span style="color: #a0522d;">dir</span>=$<span style="color: #a0522d;">2</span>&amp;<span style="color: #a0522d;">file</span>=$<span style="color: #a0522d;">3</span> last;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:6088b6db-9acf-4e56-800d-35689b7af3af" class="outline-3">
<h3 id="h:6088b6db-9acf-4e56-800d-35689b7af3af">Nginx防盗链</h3>
<div class="outline-text-3" id="text-h:6088b6db-9acf-4e56-800d-35689b7af3af">
<p>
防盗链基于客户端携带的referer实现，referer是记录打开一个页面之前记录是从哪个页面跳转过来的标记信息，如果别人只链接了自己网站图片或某个单独的资源，而不是打开了网站的整个页面，这就是盗链。
</p>

<p>
referer就是之前的那个网站域名，正常的referer信息有以下几种：
</p>
<ul class="org-ul">
<li>none：请求报文首部没有referer首部，比如用户直接在浏览器输入域名访问web网站，就没有referer信息。</li>
<li>blocked：请求报文有referer首部，但无有效值，比如为空。</li>
<li>server_names：referer首部中包含本主机名及即nginx 监听的server_name。</li>
<li>arbitrary_string：自定义指定字符串，但可使用*作通配符。</li>
<li>regular expression：被指定的正则表达式模式匹配到的字符串,要使用~开头，例如： ~.*\.cici\.com。</li>
</ul>

<p>
正常通过搜索引擎搜索web 网站并访问该网站的referer信息如下：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;&#25628;&#32034;&#24341;&#25806;&#35775;&#38382;web&#32593;&#31449;&#30340;referer&#20449;&#24687;&#65306;</span>
==&gt; /apps/nginx/logs/access_json.log &lt;==
{<span style="color: #8b2252;">"@timestamp"</span>:<span style="color: #8b2252;">"2019-02-28T13:58:46+08:00"</span>,<span style="color: #8b2252;">"host"</span>:<span style="color: #8b2252;">"192.168.7.102"</span>,<span style="color: #8b2252;">"clientip"</span>:<span style="color: #8b2252;">"192.168.0.1"</span>,<span style="color: #8b2252;">"siz</span>
<span style="color: #8b2252;">e"</span>:0,<span style="color: #8b2252;">"responsetime"</span>:0.000,<span style="color: #8b2252;">"upstreamtime"</span>:<span style="color: #8b2252;">"-"</span>,<span style="color: #8b2252;">"upstreamhost"</span>:<span style="color: #8b2252;">"-"</span>,<span style="color: #8b2252;">"http_host"</span>:<span style="color: #8b2252;">"www.cici.net"</span>,<span style="color: #8b2252;">"uri"</span>:<span style="color: #8b2252;">"/index.html"</span>,<span style="color: #8b2252;">"domain"</span>:<span style="color: #8b2252;">"www.cici.net"</span>,<span style="color: #8b2252;">"xff"</span>:<span style="color: #8b2252;">"-"</span>,<span style="color: #8b2252;">"referer"</span>:<span style="color: #8b2252;">"https://www.baidu.com/s?ie=utf-</span>
<span style="color: #8b2252;">8&amp;f=8&amp;rsv_bp=1&amp;rsv_idx=1&amp;tn=baidu&amp;wd=www.cici.net&amp;oq=www.ncici.net&amp;rsv_pq=d63060680002eb69&amp;rsv_t=de01TWnmyTdcJqph7SfI1hXgXLJxSSfUPcQ3QkWdJk%2FLNrN95ih3XOhbRs4&amp;rqlang=cn&amp;rsv_enter=1&amp;inputT=321&amp;rsv_sug3=41&amp;rsv_sug2=0&amp;rsv_sug4=1626"</span>,<span style="color: #8b2252;">"tcp_xff"</span>:<span style="color: #8b2252;">""</span>,<span style="color: #8b2252;">"http_user_agent"</span>:<span style="color: #8b2252;">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.119 Safari/537.36"</span>,<span style="color: #8b2252;">"status"</span>:<span style="color: #8b2252;">"304"</span>}
</pre>
</div>
</div>
<div id="outline-container-h:b92d4da8-5b89-4beb-b1f6-2252ad07a35b" class="outline-4">
<h4 id="h:b92d4da8-5b89-4beb-b1f6-2252ad07a35b">实现 web 盗链：</h4>
<div class="outline-text-4" id="text-h:b92d4da8-5b89-4beb-b1f6-2252ad07a35b">
<p>
在一个web 站点盗链另一个站点的资源信息，比如图片、视频等。
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@s2 conf.d]# pwd
/apps/nginx/conf/conf.d

[root@s2 conf.d]# cat ncici.net.conf
server {
  listen 80;
  server_name www.ncici.net;

  location / {
    index index.html;
    root <span style="color: #8b2252;">"/data/nginx/html/ncici"</span>;
    access_log /apps/nginx/logs/www.ncici.net.log access_json;
  }
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20934;&#22791;&#30423;&#38142;web&#39029;&#38754;&#65306;</span>
[root@s2 conf.d]# mkdir /data/nginx/html/ncici
[root@s2 conf.d]# cat /data/nginx/html/ncici/index.html
&lt;!DOCTYPE html&gt;
&lt;html <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
&lt;head&gt;
    &lt;meta <span style="color: #a0522d;">charset</span>=<span style="color: #8b2252;">"UTF-8"</span>&gt;
    &lt;title&gt;&#30423;&#38142;&#39029;&#38754;&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;a <span style="color: #a0522d;">href</span>=<span style="color: #8b2252;">"http://www.cici.net"</span>&gt;&#27979;&#35797;&#30423;&#38142;&lt;/a&gt;
&lt;img <span style="color: #a0522d;">src</span>=<span style="color: #8b2252;">"http://www.cici.net/images/1.jpg"</span>&gt;
&lt;/body&gt;
&lt;/html&gt;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;Nginx&#24182;&#35775;&#38382;http://www.ncici.net/&#27979;&#35797;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#20004;&#20010;&#22495;&#21517;&#30340;&#26085;&#24535;&#65292;&#26159;&#21542;&#20250;&#22312;&#34987;&#30423;&#36830;&#30340;web&#31449;&#28857;&#30340;&#26085;&#24535;&#20013;&#20986;&#29616;&#20197;&#19979;&#30423;&#38142;&#26085;&#24535;&#20449;&#24687;&#65306;</span>
==&gt; /apps/nginx/logs/access_json.log &lt;==
{<span style="color: #8b2252;">"@timestamp"</span>:<span style="color: #8b2252;">"2019-02-28T13:27:37+08:00"</span>,<span style="color: #8b2252;">"host"</span>:<span style="color: #8b2252;">"192.168.7.102"</span>,<span style="color: #8b2252;">"clientip"</span>:<span style="color: #8b2252;">"192.168.0.1"</span>,<span style="color: #8b2252;">"size"</span>:0,<span style="color: #8b2252;">"responsetime"</span>:0.000,<span style="color: #8b2252;">"upstreamtime"</span>:<span style="color: #8b2252;">"-"</span>,<span style="color: #8b2252;">"upstreamhost"</span>:<span style="color: #8b2252;">"-"</span>,<span style="color: #8b2252;">"http_host"</span>:<span style="color: #8b2252;">"www.cici.net"</span>,<span style="color: #8b2252;">"uri"</span>:<span style="color: #8b2252;">"/images/1.jpg"</span>,<span style="color: #8b2252;">"domain"</span>:<span style="color: #8b2252;">"www.cici.net"</span>,<span style="color: #8b2252;">"xff"</span>:<span style="color: #8b2252;">"-"</span>,<span style="color: #8b2252;">"referer"</span>:<span style="color: #8b2252;">"http://www.ncici.net/"</span>,<span style="color: #8b2252;">"tcp_xff"</span>:<span style="color: #8b2252;">""</span>,<span style="color: #8b2252;">"http_user_agent"</span>:<span style="color: #8b2252;">"Mozilla/5.0(Windows NT 6.1; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0"</span>,<span style="color: #8b2252;">"status"</span>:<span style="color: #8b2252;">"304"</span>}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fa70fad4-639e-4a1d-b918-24a8d32af77f" class="outline-4">
<h4 id="h:fa70fad4-639e-4a1d-b918-24a8d32af77f">实现防盗链：</h4>
<div class="outline-text-4" id="text-h:fa70fad4-639e-4a1d-b918-24a8d32af77f">
<p>
基于访问安全考虑，nginx支持通过ungx_http_referer_module模块，检查访问请求的referer信息是否有效实现防盗链功能
</p>

<p>
官方文档: <a href="https://nginx.org/en/docs/http/ngx_http_referer_module.html">https://nginx.org/en/docs/http/ngx_http_referer_module.html</a>
</p>

<p>
定义方式如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@s2 ~]# vim /apps/nginx/conf/conf.d/pc.conf
location /images {
  root /data/nginx/html/pc;
  index index.html;
  valid_referers none blocked server_names
    *.example.com example.* www.example.org/galleries/
    ~<span style="color: #8b2252;">\.</span>google<span style="color: #8b2252;">\.</span>;

  <span style="color: #a020f0;">if</span> ($<span style="color: #a0522d;">invalid_referer</span>) {
    <span style="color: #a020f0;">return</span> 403;
  }
}
</pre>
</div>

<p>
范例：定义防盗链：
</p>

<div class="org-src-container">
<pre class="src src-sh">location ^~ /images {
  root /data/nginx;
  index index.html;
  valid_referers none blocked server_names *.cici.com www.cici.* api.online.test/v1/hostlist ~<span style="color: #8b2252;">\.</span>google<span style="color: #8b2252;">\.</span> ~<span style="color: #8b2252;">\.</span>baidu<span style="color: #8b2252;">\.</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#26377;&#25928;&#30340;referer</span>
  <span style="color: #a020f0;">if</span> ($<span style="color: #a0522d;">invalid_referer</span>) { <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20551;&#22914;&#26159;&#20351;&#29992;&#20854;&#20182;&#30340;&#26080;&#25928;&#30340;referer&#35775;&#38382;&#65306;</span>
    <span style="color: #a020f0;">return</span> 403; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#29366;&#24577;&#30721;403</span>
  }
}
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#27979;&#35797;</span>
</pre>
</div>

<p>
使用浏览器访问盗链网站 www.ncici.net， 验证是否提前状态码403：
</p>
</div>
</div>
</div>
<div id="outline-container-h:6c67cdd3-4059-48cd-a6d5-7c1cbd6370f4" class="outline-3">
<h3 id="h:6c67cdd3-4059-48cd-a6d5-7c1cbd6370f4">map</h3>
<div class="outline-text-3" id="text-h:6c67cdd3-4059-48cd-a6d5-7c1cbd6370f4">
<p>
<a href="https://nginx.org/en/docs/http/ngx_http_map_module.html">https://nginx.org/en/docs/http/ngx_http_map_module.html</a>
</p>


<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#19968;&#20010;&#26032;&#21464;&#37327;&#65292;&#20854;&#20540;&#21462;&#20915;&#20110;&#31532;&#19968;&#20010;&#21442;&#25968;&#20013;&#25351;&#23450;&#30340;&#19968;&#20010;&#25110;&#22810;&#20010;&#28304;&#21464;&#37327;&#30340;&#20540;&#12290;</span>
Syntax:    map string $<span style="color: #a0522d;">variable</span> { ... }
Default:    &#8212;
Context:    http
</pre>
</div>

<p>
匹配模式类型：
</p>
<ul class="org-ul">
<li>"精确字符串"	完全匹配字符串（大小写敏感）</li>
<li>~ 开头，表示这个正则表达式对大小写敏感。</li>
<li>~* 开头，表示这个正则表达式对大小写不敏感</li>
</ul>


<p>
还支持以下特殊参数：
</p>
<ul class="org-ul">
<li>default value 如果源值与任何指定的变体都不匹配，则设置结果值。如果default未指定，则默认结果值为空字符串。</li>
<li>include file 包含一个带有值的文件。</li>
</ul>


<p>
基本语法
</p>
<div class="org-src-container">
<pre class="src src-sh">http {
    map $<span style="color: #a0522d;">&#28304;&#21464;&#37327;</span> $<span style="color: #a0522d;">&#30446;&#26631;&#21464;&#37327;</span> {
        &#21305;&#37197;&#27169;&#24335;1  &#32467;&#26524;&#20540;1;
        &#21305;&#37197;&#27169;&#24335;2  &#32467;&#26524;&#20540;2;
        ...
        default     &#40664;&#35748;&#20540;;
    }
}
</pre>
</div>

<p>
注意事项
</p>
<ul class="org-ul">
<li>性能优化：将高频匹配项放在顶部，减少无效匹配。</li>
<li>默认值：务必设置 default 防止空值。</li>
<li>作用域：map 块在 http{} 内全局有效。</li>
<li>变量依赖：目标变量未被使用时，映射不会执行。</li>
</ul>

<p>
map 指令是 Nginx 中强大的变量处理工具，适用于：
</p>
<ul class="org-ul">
<li>简化复杂的 if 条件判断</li>
<li>动态路由（如根据域名、路径分配后端）</li>
<li>请求头/URI 内容处理</li>
<li>配置逻辑抽象化</li>
</ul>

<p>
示例：根据 User-Agent 设置变量
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#23458;&#25143;&#31471;&#20026;&#31227;&#21160;&#35774;&#22791;&#26102;&#65292;&#37325;&#23450;&#21521;&#21040;&#31227;&#21160;&#29256;&#39029;&#38754;&#12290;</span>
http {
    map $<span style="color: #a0522d;">http_user_agent</span> $<span style="color: #a0522d;">is_mobile</span> {
        default         0;
        <span style="color: #8b2252;">"~*android"</span>     1;  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21305;&#37197; Android</span>
        <span style="color: #8b2252;">"~*iphone|ipod"</span> 1;  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21305;&#37197; iPhone/iPod</span>
    }

    server {
        location / {
            <span style="color: #a020f0;">if</span> ($<span style="color: #a0522d;">is_mobile</span>) {
                rewrite ^ /mobile redirect;
            }
            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20854;&#20182;&#37197;&#32622;...</span>
        }
    }
}
</pre>
</div>

<p>
示例：使用正则捕获组
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35831;&#27714; /image.png &#8594; $file_extension = "png"</span>
http {
    map $<span style="color: #a0522d;">uri</span> $<span style="color: #a0522d;">file_extension</span> {
        ~*<span style="color: #8b2252;">\.</span>(?&lt;ext&gt;\w+)$ $<span style="color: #a0522d;">ext</span>;  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25552;&#21462; URI &#20013;&#30340;&#25193;&#23637;&#21517;</span>
        default <span style="color: #8b2252;">""</span>;
    }
}
</pre>
</div>

<p>
示例：域名到后端服务的映射
</p>
<div class="org-src-container">
<pre class="src src-sh">http {
    map $<span style="color: #a0522d;">host</span> $<span style="color: #a0522d;">backend</span> {
        hostnames;  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#29992;&#36890;&#37197;&#31526;&#21305;&#37197;</span>
        api.example.com    api_server;
        *.example.com     web_server;
        default           default_backend;
    }

    upstream api_server { ... }
    upstream web_server { ... }

    server {
        location / {
            proxy_pass http://$<span style="color: #a0522d;">backend</span>;
        }
    }
}
</pre>
</div>


<p>
示例：嵌套映射（通过多次调用）
</p>
<div class="org-src-container">
<pre class="src src-sh">map $<span style="color: #a0522d;">status_code</span> $<span style="color: #a0522d;">error_type</span> {
    404   <span style="color: #8b2252;">"Not Found"</span>;
    500   <span style="color: #8b2252;">"Server Error"</span>;
}

map $<span style="color: #a0522d;">error_type</span> $<span style="color: #a0522d;">log_level</span> {
    <span style="color: #8b2252;">"Not Found"</span>     <span style="color: #8b2252;">"warn"</span>;
    <span style="color: #8b2252;">"Server Error"</span>  <span style="color: #8b2252;">"error"</span>;
}
</pre>
</div>
</div>
<div id="outline-container-h:3e1cd333-5b32-4fb4-89ca-1aa776503f6f" class="outline-4">
<h4 id="h:3e1cd333-5b32-4fb4-89ca-1aa776503f6f">流量切分</h4>
<div class="outline-text-4" id="text-h:3e1cd333-5b32-4fb4-89ca-1aa776503f6f">
<div class="org-src-container">
<pre class="src src-sh">
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:3d090a91-90c4-4eb1-bddd-f18ca75f580f" class="outline-3">
<h3 id="h:3d090a91-90c4-4eb1-bddd-f18ca75f580f">限制</h3>
<div class="outline-text-3" id="text-h:3d090a91-90c4-4eb1-bddd-f18ca75f580f">
</div>
<div id="outline-container-h:05ae535f-d1ab-4cd0-af62-991d232d8e10" class="outline-4">
<h4 id="h:05ae535f-d1ab-4cd0-af62-991d232d8e10">限制连接数ngx_http_limit_conn_module模块</h4>
<div class="outline-text-4" id="text-h:05ae535f-d1ab-4cd0-af62-991d232d8e10">
<p>
<a href="https://nginx.org/en/docs/http/ngx_http_limit_conn_module.html">https://nginx.org/en/docs/http/ngx_http_limit_conn_module.html</a>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#20849;&#20139;&#20869;&#23384;&#21306;&#22495;&#20197;&#21450;&#25351;&#23450;&#38190;&#20540;&#30340;&#26368;&#22823;&#20801;&#35768;&#36830;&#25509;&#25968;</span>
Syntax:    limit_conn zone number;
Default:    &#8212;
Context:    http, server, location
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#20849;&#20139;&#20869;&#23384;&#21306;&#22495;&#30340;&#21442;&#25968;&#65292;&#35813;&#21306;&#22495;&#23558;&#20445;&#23384;&#21508;&#31181;&#38190;&#30340;&#29366;&#24577;</span>
Syntax:    limit_conn_zone key <span style="color: #a0522d;">zone</span>=name:size;
Default:    &#8212;
Context:    http
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#21709;&#24212;&#34987;&#25298;&#32477;&#30340;&#35831;&#27714;&#32780;&#36820;&#22238;&#30340;&#29366;&#24577;&#20195;&#30721;</span>
Syntax:    limit_conn_status code;
Default:   limit_conn_status 503;
Context:   http, server, location
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#20849;&#20139;&#20869;&#23384;&#21306;&#22495;&#20197;&#21450;&#25351;&#23450;&#38190;&#20540;&#30340;&#26368;&#22823;&#20801;&#35768;&#36830;&#25509;&#25968;&#12290;&#24403;&#36229;&#20986;&#27492;&#38480;&#21046;&#26102;&#65292;&#26381;&#21153;&#22120;&#23558;&#36820;&#22238; &#38169;&#35823; &#20197;&#21709;&#24212;&#35831;&#27714;&#12290;</span>
limit_conn_zone $<span style="color: #a0522d;">binary_remote_addr</span> <span style="color: #a0522d;">zone</span>=perip:10m;
limit_conn_zone $<span style="color: #a0522d;">server_name</span> <span style="color: #a0522d;">zone</span>=perserver:10m;

server {
    ...
    limit_conn perip 10;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#20010; IP &#22320;&#22336;&#27599;&#27425;&#21482;&#20801;&#35768;10&#20010;&#36830;&#25509;</span>
    limit_conn perserver 100; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#26102;&#38480;&#21046;&#21040;&#34394;&#25311;&#26381;&#21153;&#22120;&#30340;&#24635;&#36830;&#25509;&#25968;</span>
}
</pre>
</div>

<p>
范例：针对爬虫限速
</p>
<div class="org-src-container">
<pre class="src src-sh">
http {
map $<span style="color: #a0522d;">http_user_agent</span> $<span style="color: #a0522d;">agent</span> {
  default <span style="color: #8b2252;">""</span>;
  ~curl $<span style="color: #a0522d;">http_user_agent</span>;
  ~*apachebench $<span style="color: #a0522d;">http_user_agent</span>;
  ~*spider $<span style="color: #a0522d;">http_user_agent</span>;
  ~*bot  $<span style="color: #a0522d;">http_user_agent</span>;
  ~*slurp $<span style="color: #a0522d;">http_user_agent</span>;
}
limit_conn_zone $<span style="color: #a0522d;">agent</span> <span style="color: #a0522d;">zone</span>=conn_xxx_com:10m;
limit_req_zone $<span style="color: #a0522d;">agent</span> <span style="color: #a0522d;">zone</span>=req_xxx_com:10m <span style="color: #a0522d;">rate</span>=1r/s;

server {
    listen 8080;
    server_name  test.xxx.com;
    root /data/webroot/www.xxx.com/

    location   / {
        limit_req <span style="color: #a0522d;">zone</span>=conn_xxx_com <span style="color: #a0522d;">burst</span>=5;
        limit_conn req_xxx_com 1;
    }
}
}
</pre>
</div>

<p>
范例：限速白名单
</p>
<div class="org-src-container">
<pre class="src src-sh">http {
geo $<span style="color: #a0522d;">whiteiplist</span>  {
default 1;
127.0.0.1 0;
10.0.0.0/8 0;
121.207.242.0/24 0;
}

map $<span style="color: #a0522d;">whiteiplist</span>  $<span style="color: #a0522d;">limit</span> {
1 $<span style="color: #a0522d;">binary_remote_addr</span>;
0 <span style="color: #8b2252;">""</span>;
}

limit_conn_zone $<span style="color: #a0522d;">limit</span> <span style="color: #a0522d;">zone</span>=limit:10m;

server {
    listen       8080;
    server_name  test.xxx.com;

    location ^~ /xxx.com/ {
            limit_conn limit 4;
            limit_rate 200k;
            <span style="color: #483d8b;">alias</span> /data/www.xxx.com/data/download/;
    }
}

</pre>
</div>
<p>
说明
</p>
<ol class="org-ol">
<li>geo指令定义一个白名单$whiteiplist, 默认值为1, 所有都受限制。 如果客户端IP与白名单列出的IP相匹配，则$whiteiplist值为0也就是不受限制。</li>
<li>map指令是将$whiteiplist值为1的，也就是受限制的IP，映射为客户端IP。将$whiteiplist值为0的，也就是白名单IP，映射为空的字符串。</li>
<li>limit_conn_zone和limit_req_zone指令对于键为空值的将会被忽略，从而实现对于列出来的IP不做限制。</li>
</ol>

<p>
测试方法：
</p>
<div class="org-src-container">
<pre class="src src-sh">ab -c 100 -n 300 http://test.xxx.com:8080/xxx.com/docs/pdf/nginx_guide.pdf
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1e6fdd99-552f-46bd-b651-659e72828ecb" class="outline-4">
<h4 id="h:1e6fdd99-552f-46bd-b651-659e72828ecb">限制请求数ngx_http_limit_req_module模块</h4>
<div class="outline-text-4" id="text-h:1e6fdd99-552f-46bd-b651-659e72828ecb">
<p>
<a href="https://nginx.org/en/docs/http/ngx_http_limit_req_module.html">https://nginx.org/en/docs/http/ngx_http_limit_req_module.html</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">Syntax: limit_req <span style="color: #a0522d;">zone</span>=name [<span style="color: #a0522d;">burst</span>=number] [nodelay | <span style="color: #a0522d;">delay</span>=number];
Default:        &#8212;
Context:        http, server, location

limit_req <span style="color: #a0522d;">zone</span>=one <span style="color: #a0522d;">burst</span>=5 nodelay;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#23792;&#20540;burst=5&#20197;&#20869;&#30340;&#24182;&#21457;&#35831;&#27714;&#65292;&#20250;&#34987;&#25346;&#36215;&#65292;&#24310;&#36831;&#22788;&#29702;&#12290;&#36229;&#36807;5&#20010;&#30452;&#25509;&#36820;&#22238;503</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#19981;&#24076;&#26395;&#22312;&#38480;&#21046;&#35831;&#27714;&#30340;&#21516;&#26102;&#24310;&#36831;&#36807;&#22810;&#30340;&#35831;&#27714;&#65292;nodelay</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">Syntax: limit_req_zone key <span style="color: #a0522d;">zone</span>=name:size <span style="color: #a0522d;">rate</span>=rate [sync];
Default:        &#8212;
Context:        http

limit_req_zone $<span style="color: #a0522d;">binary_remote_addr</span> <span style="color: #a0522d;">zone</span>=one:10m <span style="color: #a0522d;">rate</span>=1r/s;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29366;&#24577;&#34987;&#20445;&#23384;&#22312;&#19968;&#20010;10MB&#30340;&#21306;&#22495;one&#20013;&#65292;&#24179;&#22343;&#35831;&#27714;&#22788;&#29702;&#29575;&#19981;&#33021;&#36229;&#36807;&#27599;&#31186;1&#20010;&#35831;&#27714;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">1 &#20806;&#23383;&#33410;&#30340;&#21306;&#22495;&#21487;&#20197;&#20445;&#23384;&#22823;&#32422; 16,000 &#20010;IP</span>
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#31181;&#38480;&#21046;&#65292;&#22495;&#21517;server_name&#12289;&#21333;&#20010; IP &#22320;&#22336;&#30340;&#35831;&#27714;&#22788;&#29702;&#36895;&#29575;</span>
http {
  limit_req_status 555;
    limit_req_zone $<span style="color: #a0522d;">server_name</span> <span style="color: #a0522d;">zone</span>=abcserver:10m <span style="color: #a0522d;">rate</span>=2000r/s;
    limit_req_zone $<span style="color: #a0522d;">server_name</span> <span style="color: #a0522d;">zone</span>=defserver:10m <span style="color: #a0522d;">rate</span>=1500r/s;
    limit_req_zone $<span style="color: #a0522d;">binary_remote_addr</span> <span style="color: #a0522d;">zone</span>=abc:10m <span style="color: #a0522d;">rate</span>=1r/s;
    limit_req_zone $<span style="color: #a0522d;">binary_remote_addr</span>$<span style="color: #a0522d;">uri</span> <span style="color: #a0522d;">zone</span>=abc_uri:10m <span style="color: #a0522d;">rate</span>=1r/s;
    limit_req_zone $<span style="color: #a0522d;">binary_remote_addr</span> <span style="color: #a0522d;">zone</span>=def:10m <span style="color: #a0522d;">rate</span>=1r/s;

server {
  ... ...
  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36895;&#29575;qps=1&#65292;&#24310;&#36831;&#35831;&#27714;, &#36229;&#36807;&#36820;&#22238;453</span>
  location /cdp/distributor/api/batch_data {
    proxy_read_timeout 60;
    limit_req_status 453;
    limit_req <span style="color: #a0522d;">zone</span>=abc_uri nodelay;
    proxy_pass http://xxx;
  }
}
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:2398cc33-50cd-4173-b559-b94b63e1a12b" class="outline-3">
<h3 id="h:2398cc33-50cd-4173-b559-b94b63e1a12b">GeoIP2</h3>
<div class="outline-text-3" id="text-h:2398cc33-50cd-4173-b559-b94b63e1a12b">
<p>
Nginx需要安装GeoIP2模块才能使用MaxMind的数据库
</p>

<p>
1、获取MaxMind GeoIP2数据库
</p>

<ul class="org-ul">
<li>官方：需要提前注册，进入下载页 <a href="https://dev.maxmind.com/geoip/geolite2-free-geolocation-data/">https://dev.maxmind.com/geoip/geolite2-free-geolocation-data/</a>，下载 GeoLite2-Country.mmdb 文件</li>
<li>第三方免费文件: <a href="https://github.com/P3TERX/GeoLite.mmdb">https://github.com/P3TERX/GeoLite.mmdb</a></li>
</ul>


<p>
2、安装Nginx GeoIP2模块
</p>

<p>
安装依赖
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">sudo apt-get install libmaxminddb0 libmaxminddb-dev mmdb-bin</span>

yum install -y libmaxminddb libmaxminddb-devel
</pre>
</div>

<p>
手动查询ip归属
</p>
<div class="org-src-container">
<pre class="src src-sh">]# mmdblookup --file GeoLite2-City.mmdb --ip 103.121.182.139

  {
    <span style="color: #8b2252;">"city"</span>: 
      {
        <span style="color: #8b2252;">"geoname_id"</span>: 
          1642911 &lt;uint32&gt;
        <span style="color: #8b2252;">"names"</span>: 
          {
            <span style="color: #8b2252;">"de"</span>: 
              <span style="color: #8b2252;">"Jakarta"</span> &lt;utf8_string&gt;
            <span style="color: #8b2252;">"en"</span>: 
              <span style="color: #8b2252;">"Jakarta"</span> &lt;utf8_string&gt;
......
            <span style="color: #8b2252;">"zh-CN"</span>: 
              <span style="color: #8b2252;">"&#38597;&#21152;&#36798;"</span> &lt;utf8_string&gt;
          }
      }
    <span style="color: #8b2252;">"continent"</span>: 
      {
        <span style="color: #8b2252;">"code"</span>: 
          <span style="color: #8b2252;">"AS"</span> &lt;utf8_string&gt;
        <span style="color: #8b2252;">"geoname_id"</span>: 
          6255147 &lt;uint32&gt;
        <span style="color: #8b2252;">"names"</span>: 
          {
            <span style="color: #8b2252;">"de"</span>: 
              <span style="color: #8b2252;">"Asien"</span> &lt;utf8_string&gt;
            <span style="color: #8b2252;">"en"</span>: 
              <span style="color: #8b2252;">"Asia"</span> &lt;utf8_string&gt;
.....
            <span style="color: #8b2252;">"ru"</span>: 
              <span style="color: #8b2252;">"&#1040;&#1079;&#1080;&#1103;"</span> &lt;utf8_string&gt;
            <span style="color: #8b2252;">"zh-CN"</span>: 
              <span style="color: #8b2252;">"&#20122;&#27954;"</span> &lt;utf8_string&gt;
          }
      }
    <span style="color: #8b2252;">"country"</span>: 
      {
        <span style="color: #8b2252;">"geoname_id"</span>: 
          1643084 &lt;uint32&gt;
        <span style="color: #8b2252;">"iso_code"</span>: 
          <span style="color: #8b2252;">"ID"</span> &lt;utf8_string&gt;
        <span style="color: #8b2252;">"names"</span>: 
          {
            <span style="color: #8b2252;">"de"</span>: 
              <span style="color: #8b2252;">"Indonesien"</span> &lt;utf8_string&gt;
            <span style="color: #8b2252;">"en"</span>: 
              <span style="color: #8b2252;">"Indonesia"</span> &lt;utf8_string&gt;
......
            <span style="color: #8b2252;">"zh-CN"</span>: 
              <span style="color: #8b2252;">"&#21360;&#24230;&#23612;&#35199;&#20122;"</span> &lt;utf8_string&gt;
          }
      }
    <span style="color: #8b2252;">"location"</span>: 
      {
        <span style="color: #8b2252;">"accuracy_radius"</span>: 
          20 &lt;uint16&gt;
        <span style="color: #8b2252;">"latitude"</span>: 
          -6.211400 &lt;double&gt;
        <span style="color: #8b2252;">"longitude"</span>: 
          106.844600 &lt;double&gt;
        <span style="color: #8b2252;">"time_zone"</span>: 
          <span style="color: #8b2252;">"Asia/Jakarta"</span> &lt;utf8_string&gt;
      }
    <span style="color: #8b2252;">"postal"</span>: 
      {
        <span style="color: #8b2252;">"code"</span>: 
          <span style="color: #8b2252;">"11730"</span> &lt;utf8_string&gt;
      }
    <span style="color: #8b2252;">"registered_country"</span>: 
      {
        <span style="color: #8b2252;">"geoname_id"</span>: 
          1643084 &lt;uint32&gt;
        <span style="color: #8b2252;">"iso_code"</span>: 
          <span style="color: #8b2252;">"ID"</span> &lt;utf8_string&gt;
        <span style="color: #8b2252;">"names"</span>: 
          {
            <span style="color: #8b2252;">"de"</span>: 
              <span style="color: #8b2252;">"Indonesien"</span> &lt;utf8_string&gt;
            <span style="color: #8b2252;">"en"</span>: 
              <span style="color: #8b2252;">"Indonesia"</span> &lt;utf8_string&gt;
......
            <span style="color: #8b2252;">"zh-CN"</span>: 
              <span style="color: #8b2252;">"&#21360;&#24230;&#23612;&#35199;&#20122;"</span> &lt;utf8_string&gt;
          }
      }
    <span style="color: #8b2252;">"subdivisions"</span>: 
      [
        {
          <span style="color: #8b2252;">"geoname_id"</span>: 
            1642907 &lt;uint32&gt;
          <span style="color: #8b2252;">"iso_code"</span>: 
            <span style="color: #8b2252;">"JK"</span> &lt;utf8_string&gt;
          <span style="color: #8b2252;">"names"</span>: 
            {
              <span style="color: #8b2252;">"en"</span>: 
                <span style="color: #8b2252;">"Jakarta"</span> &lt;utf8_string&gt;
            }
        }
      ]
  }

GeoIP]# mmdblookup --file GeoLite2-City.mmdb --ip 103.121.182.139 country names zh-CN

  <span style="color: #8b2252;">"&#21360;&#24230;&#23612;&#35199;&#20122;"</span> &lt;utf8_string&gt;

GeoIP]# mmdblookup --file GeoLite2-City.mmdb --ip 103.121.182.139 city names zh-CN

  <span style="color: #8b2252;">"&#38597;&#21152;&#36798;"</span> &lt;utf8_string&gt;
</pre>
</div>


<p>
下载GeoIP2模块
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /usr/local/src/
git clone https://github.com/leev/ngx_http_geoip2_module.git

&#21160;&#24577;&#32534;&#35793;Nginx with GeoIP2&#27169;&#22359;
wget https://nginx.org/download/nginx-1.27.3.tar.gz
tar -xzf nginx-1.27.3.tar.gz
<span style="color: #483d8b;">cd</span> nginx-1.27.3

./configure --prefix=/usr/local/nginx-1.27.3 <span style="color: #8b2252;">\</span>
            --with-compat --add-dynamic-module=/usr/local/src/ngx_http_geoip2_module <span style="color: #8b2252;">\</span>
            --with-http_ssl_module <span style="color: #8b2252;">\</span>
            --with-stream <span style="color: #8b2252;">\</span>
            --with-http_realip_module <span style="color: #8b2252;">\</span>
            --add-module=/usr/local/src/echo-nginx-module-master
make
<span style="color: #b22222;">#</span><span style="color: #b22222;">make install #&#24050;&#23433;&#35013;nginx&#23601;&#19981;&#35201;&#35206;&#30422;&#65292;&#40664;&#35748;&#20250;&#25226;geoip&#25991;&#20214;&#25918;&#22312; /usr/local/nginx-1.27.3/modules &#30446;&#24405;&#20013;. ngx_http_geoip2_module.so  ngx_stream_geoip2_module.so</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ln -svf /usr/local/nginx-1.27.3 /usr/local/nginx</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ln -svf /usr/local/nginx/sbin/nginx /usr/bin/nginx</span>
mkdir -p /usr/local/nginx/modules
\cp  objs/nginx /usr/local/nginx/sbin <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26356;&#26032;nginx&#20108;&#36827;&#21046;&#25991;&#20214;</span>
\cp  objs/{ngx_http_geoip2_module,ngx_http_geoip_module,ngx_stream_geoip2_module,ngx_stream_geoip_module}.so  /usr/local/nginx/modules/
</pre>
</div>


<p>
配置nginx，加载模块
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /usr/local/nginx/conf
sed -ri <span style="color: #8b2252;">'/events/i\include modules.conf;'</span> nginx.conf
cat &gt; modules.conf &lt;&lt;eof
<span style="color: #ffa54f;">load_module modules/ngx_http_geoip2_module.so;</span>
<span style="color: #ffa54f;">#load_module modules/ngx_http_geoip_module.so;</span>
<span style="color: #ffa54f;">load_module modules/ngx_stream_geoip2_module.so;</span>
<span style="color: #ffa54f;">#load_module modules/ngx_stream_geoip_module.so;</span>
<span style="color: #ffa54f;">eof</span>
nginx -s reload
</pre>
</div>


<p>
3、配置Nginx使用GeoIP2数据库
</p>


<p>
编辑Nginx配置文件，加载GeoIP2数据库
</p>
<ul class="org-ul">
<li>http 块中添加以下内容</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312; http &#22359;&#20013;&#28155;&#21152;&#20197;&#19979;&#20869;&#23481;</span>
    <span style="color: #b22222;">## </span><span style="color: #b22222;">&#21152;&#36733;GeoIP2&#25968;&#25454;&#24211;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">geoip2 /usr/local/nginx/conf/GeoLite2-Country.mmdb {</span>
    <span style="color: #b22222;">#    </span><span style="color: #b22222;">$geoip2_data_country_code source=$http_x_forwarded_for country iso_code;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">}</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">geoip2&#27169;&#22359;&#21152;&#36733;ip&#25968;&#25454;&#24211;  </span>
    geoip2 /usr/local/nginx/conf/GeoLite2-Country.mmdb {
         $<span style="color: #a0522d;">geoip2_data_country_code</span> <span style="color: #a0522d;">source</span>=$<span style="color: #a0522d;">http_x_forwarded_for</span> country iso_code;
         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22269;&#23478;&#33521;&#25991;&#21517;</span>
         $<span style="color: #a0522d;">geoip2_data_country_name_en</span> <span style="color: #a0522d;">source</span>=$<span style="color: #a0522d;">http_x_forwarded_for</span> country names en;
         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22269;&#23478;&#20013;&#25991;&#21517;</span>
         $<span style="color: #a0522d;">geoip2_data_country_name_cn</span> <span style="color: #a0522d;">source</span>=$<span style="color: #a0522d;">http_x_forwarded_for</span> country names zh-CN;
    }
    geoip2 /usr/local/nginx/conf/GeoLite2-City.mmdb {
         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22478;&#24066;&#33521;&#25991;&#21517;&#65292;&#22823;&#22810;&#26159;&#25340;&#38899;&#65292;&#26377;&#37325;&#22797;&#24773;&#20917;</span>
         $<span style="color: #a0522d;">geoip2_data_city_name_en</span> <span style="color: #a0522d;">source</span>=$<span style="color: #a0522d;">http_x_forwarded_for</span> city names en;
         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22478;&#24066;&#20013;&#25991;&#21517;&#65292;&#37096;&#20998;&#22478;&#24066;&#27809;&#26377;&#20013;&#25991;&#21517;</span>
         $<span style="color: #a0522d;">geoip2_data_city_name_cn</span> <span style="color: #a0522d;">source</span>=$<span style="color: #a0522d;">http_x_forwarded_for</span> city names zh-CN;
         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32463;&#24230;&#65292;longitude</span>
         $<span style="color: #a0522d;">geoip2_longitude</span> <span style="color: #a0522d;">source</span>=$<span style="color: #a0522d;">http_x_forwarded_for</span> location longitude ;
         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32500;&#24230;&#65292;latitude</span>
         $<span style="color: #a0522d;">geoip2_latitude</span> <span style="color: #a0522d;">source</span>=$<span style="color: #a0522d;">http_x_forwarded_for</span> location latitude ;
    }

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#21464;&#37327;&#65306;&#22914;&#26524;IP&#26469;&#33258;&#20013;&#22269;&#65292;&#21017;&#35774;&#32622;&#20026;1</span>
    map $<span style="color: #a0522d;">geoip2_data_country_code</span> $<span style="color: #a0522d;">is_china</span> {
        default 0;
        CN      1;  <span style="color: #b22222;"># </span><span style="color: #b22222;">CN&#26159;&#20013;&#22269;&#30340;&#22269;&#23478;&#20195;&#30721;</span>
    }
</pre>
</div>


<p>
设置屏蔽规则：
</p>
<ul class="org-ul">
<li>在 server 块中添加以下内容：</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">server {
    listen 80;
    server_name yourdomain.com;

    access_log  /var/log/nginx/geoip.access.log  json;

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;IP&#26469;&#33258;&#20013;&#22269;&#65292;&#36820;&#22238;688</span>
    charset  utf8;
    <span style="color: #b22222;">#</span><span style="color: #b22222;">default_type text/plain;</span>
    <span style="color: #a020f0;">if</span> ($<span style="color: #a0522d;">is_china</span> = 1) {
        <span style="color: #b22222;">#</span><span style="color: #b22222;">return 688 "$http_x_forwarded_for $is_china $geoip2_data_country_name_en $geoip2_data_city_name_en $geoip2_data_city_name_cn | $geoip2_data_city_name_en $geoip2_longitude,$geoip2_latitude";</span>
        <span style="color: #a020f0;">return</span> 688;
    }

    location / {
        root /usr/local/nginx/html;
        index index.html;
    }
}

&#37325;&#21551;Nginx
sudo /usr/local/nginx/sbin/nginx -t  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27979;&#35797;&#37197;&#32622;&#25991;&#20214;</span>
sudo /usr/local/nginx/sbin/nginx -s reload  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#37325;&#21551;Nginx</span>
</pre>
</div>


<p>
日志格式化
</p>

<div class="org-src-container">
<pre class="src src-sh">log_format json <span style="color: #a0522d;">escape</span>=json
    <span style="color: #8b2252;">'{"client_ip":"$remote_addr",'</span>
    <span style="color: #8b2252;">'"client_user":"$remote_user",'</span>
    <span style="color: #8b2252;">'"@timestamp": "$time_iso8601",'</span>
    <span style="color: #8b2252;">'"request_uri":"$request_uri",'</span>
    <span style="color: #8b2252;">'"status":"$status",'</span>
    <span style="color: #8b2252;">'"body_bytes_sent":"$body_bytes_sent",'</span>
    <span style="color: #8b2252;">'"http_referer":"$http_referer",'</span>
    <span style="color: #8b2252;">'"http_user_agent":"$http_user_agent",'</span>
    <span style="color: #8b2252;">'"http_x_forwarded_for":"$http_x_forwarded_for",'</span>
    <span style="color: #8b2252;">'"client_port":"$remote_port",'</span>
    <span style="color: #8b2252;">'"host":"$host",'</span>
    <span style="color: #8b2252;">'"http_host":"$http_host",'</span>
    <span style="color: #8b2252;">'"tcp_xff":"$proxy_protocol_addr",'</span>
    <span style="color: #8b2252;">'"request_length":"$request_length",'</span>
    <span style="color: #8b2252;">'"request_method":"$request_method",'</span>
    <span style="color: #8b2252;">'"request_time":"$request_time",'</span>
    <span style="color: #8b2252;">'"request_body":"$request_body",'</span>
    <span style="color: #8b2252;">'"scheme":"$scheme",'</span>
    <span style="color: #8b2252;">'"server_protocol":"$server_protocol",'</span>
    <span style="color: #8b2252;">'"ssl_cipher":"$ssl_cipher",'</span>
    <span style="color: #8b2252;">'"ssl_protocol":"$ssl_protocol",'</span>
    <span style="color: #8b2252;">'"time_local":"$time_local",'</span>
    <span style="color: #8b2252;">'"upstream_addr":"$upstream_addr",'</span>
    <span style="color: #8b2252;">'"upstream_response_time":"$upstream_response_time",'</span>
    <span style="color: #8b2252;">'"upstream_status":"$upstream_status",'</span>
    <span style="color: #8b2252;">'"url":"$scheme://$host$request_uri",'</span>
    <span style="color: #8b2252;">'"client_country_name":"$geoip2_data_country_name_cn | $geoip2_data_country_name_en",'</span>
    <span style="color: #8b2252;">'"client_city_name":"$geoip2_data_city_name_cn | $geoip2_data_city_name_en",'</span>
    <span style="color: #8b2252;">'"longitude_latitude":"$geoip2_longitude,$geoip2_latitude"}'</span>;
</pre>
</div>

<p>
参考：<a href="https://www.cnblogs.com/suyanhj/articles/15891947.html">nginx动态加载模块</a>
</p>
</div>
</div>
</section>
<section id="outline-container-h:85299e20-35b4-4bd7-b6d4-1e9bb2b82d66" class="outline-2">
<h2 id="h:85299e20-35b4-4bd7-b6d4-1e9bb2b82d66">Nginx 反向代理功能</h2>
<div class="outline-text-2" id="text-h:85299e20-35b4-4bd7-b6d4-1e9bb2b82d66">
<p>
反向代理：反向代理也叫reverse proxy，指的是代理外网用户的请求到内部的
指定web服务器，并将数据返回给用户的一种方式，这是用的比较多的一种方式。
</p>

<p>
Nginx除了可以在企业提供高性能的web服务之外，另外还可以将本身不具备的请
求通过某种预定义的协议转发至其它服务器处理，不同的协议就是Nginx服务器
与其他服务器进行通信的一种规范，主要在不同的场景使用以下模块实现不同的
功能
</p>

<p>
逻辑调用关系：
</p>

<div class="org-src-container">
<pre class="src src-sh">ngx_http_proxy_module&#65306; &#23558;&#23458;&#25143;&#31471;&#30340;&#35831;&#27714;&#20197;http&#21327;&#35758;&#36716;&#21457;&#33267;&#25351;&#23450;&#26381;&#21153;&#22120;&#36827;&#34892;&#22788;&#29702;&#12290;
ngx_stream_proxy_module&#65306;&#23558;&#23458;&#25143;&#31471;&#30340;&#35831;&#27714;&#20197;tcp&#21327;&#35758;&#36716;&#21457;&#33267;&#25351;&#23450;&#26381;&#21153;&#22120;&#22788;&#29702;&#12290;
ngx_http_fastcgi_module&#65306;&#23558;&#23458;&#25143;&#31471;&#23545;php&#30340;&#35831;&#27714;&#20197;fastcgi&#21327;&#35758;&#36716;&#21457;&#33267;&#25351;&#23450;&#26381;&#21153;&#22120;&#21161;&#29702;&#12290;
ngx_http_uwsgi_module&#65306;&#23558;&#23458;&#25143;&#31471;&#23545;Python&#30340;&#35831;&#27714;&#20197;uwsgi&#21327;&#35758;&#36716;&#21457;&#33267;&#25351;&#23450;&#26381;&#21153;&#22120;&#22788;&#29702;&#12290;
</pre>
</div>
</div>
<div id="outline-container-h:1e475581-9550-4dc5-abee-3e39e7140037" class="outline-3">
<h3 id="h:1e475581-9550-4dc5-abee-3e39e7140037">实现 http 反向代理</h3>
<div class="outline-text-3" id="text-h:1e475581-9550-4dc5-abee-3e39e7140037">
<p>
要求：将用户对域 www.nagedu.net 的请求转发值后端服务器处理，
</p>

<p>
官方文档：<a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html">https://nginx.org/en/docs/http/ngx_http_proxy_module.html</a>
</p>

<p>
环境准备：
</p>

<div class="org-src-container">
<pre class="src src-sh">192.168.7.102 <span style="color: #b22222;">#</span><span style="color: #b22222;">Nginx &#20195;&#29702;&#26381;&#21153;&#22120;</span>
192.168.7.103 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#31471;web A&#65292;Apache&#37096;&#32626;</span>
192.168.7.104 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#31471;web B&#65292;Apache&#37096;&#32626;</span>
</pre>
</div>

<p>
访问逻辑图：
</p>
</div>
<div id="outline-container-h:eac25681-d925-43d5-bbf5-1c040bae9088" class="outline-4">
<h4 id="h:eac25681-d925-43d5-bbf5-1c040bae9088">部署后端 Apache服务器</h4>
<div class="outline-text-4" id="text-h:eac25681-d925-43d5-bbf5-1c040bae9088">
<div class="org-src-container">
<pre class="src src-sh">[root@s3 ~]# yum install httpd -y
[root@s3 ~]# echo <span style="color: #8b2252;">"web1 192.168.7.103"</span> &gt; /var/www/html/index.html
[root@s3 ~]# systemctl start httpd &amp;&amp; systemctl enable httpd

[root@s4 ~]# yum install httpd -y
[root@s4 ~]# echo <span style="color: #8b2252;">"web2 192.168.7.104"</span> &gt;&gt; /var/www/html/index.html
[root@s4 ~]# systemctl start httpd &amp;&amp; systemctl enable httpd

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#27979;&#35797;</span>
[root@s4 ~]# curl http://192.168.7.103
web1 192.168.7.103
[root@s3 ~]# curl http://192.168.7.104
web2 192.168.7.104
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8dcefee1-d244-4eda-b855-ab05d6c34986" class="outline-4">
<h4 id="h:8dcefee1-d244-4eda-b855-ab05d6c34986">Nginx http 反向代理入门</h4>
<div class="outline-text-4" id="text-h:8dcefee1-d244-4eda-b855-ab05d6c34986">
<p>
官方文档：<a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass">https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass</a>
</p>
</div>
<div id="outline-container-h:f9d81907-bb3b-487e-91de-7256ce9c6d76" class="outline-5">
<h5 id="h:f9d81907-bb3b-487e-91de-7256ce9c6d76">反向代理配置参数</h5>
<div class="outline-text-5" id="text-h:f9d81907-bb3b-487e-91de-7256ce9c6d76">
<div class="org-src-container">
<pre class="src src-sh">proxy_pass&#65307;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#26469;&#35774;&#32622;&#23558;&#23458;&#25143;&#31471;&#35831;&#27714;&#36716;&#21457;&#32473;&#30340;&#21518;&#31471;&#26381;&#21153;&#22120;&#30340;&#20027;&#26426;&#65292;&#21487;&#20197;&#26159;&#20027;&#26426;&#21517;&#12289;IP&#22320;&#22336;&#65306;&#31471;&#21475;&#30340;&#26041;&#24335;&#65292;&#20063;&#21487;&#20197;&#20195;&#29702;&#21040;&#39044;&#20808;&#35774;&#32622;&#30340;&#20027;&#26426;&#32676;&#32452;&#65292;&#38656;&#35201;&#27169;&#22359;gx_http_upstream_module&#25903;&#25345;&#12290;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;</span>
  location /web {
    index index.html;
    proxy_pass http://192.168.7.103:80;
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#24102;&#26012;&#32447;&#23558;&#35775;&#38382;&#30340;/web,&#31561;&#20110;&#35775;&#38382;&#21518;&#31471;&#26381;&#21153;&#22120; http://192.168.7.103:80/web/index.html&#65292;&#21363;&#21518;&#31471;&#26381;&#21153;&#22120;&#37197;&#32622;&#30340;&#31449;&#28857;&#26681;&#30446;&#24405;&#35201;&#26377;web&#30446;&#24405;&#25165;&#21487;&#20197;&#34987;&#35775;&#38382;&#65292;&#36825;&#26159;&#19968;&#20010;&#36861;&#21152;/web&#21040;&#21518;&#31471;&#26381;&#21153;&#22120;http://servername:port/WEB/INDEX.HTML&#30340;&#25805;&#20316;</span>

    proxy_pass http://192.168.7.103:80/;
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24102;&#26012;&#32447;&#65292;&#31561;&#20110;&#35775;&#38382;&#21518;&#31471;&#26381;&#21153;&#22120;&#30340;http://192.168.7.103:80/index.html &#20869;&#23481;&#36820;&#22238;&#32473;&#23458;&#25143;&#31471;</span>
  }

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;Nginx&#27979;&#35797;&#35775;&#38382;&#25928;&#26524;&#65306;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">curl -L http://www.cici.net/web/index.html</span>

proxy_hide_header field;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;nginx&#20316;&#20026;&#21453;&#21521;&#20195;&#29702;&#30340;&#26102;&#20505;&#65292;&#22312;&#36820;&#22238;&#32473;&#23458;&#25143;&#31471;http&#21709;&#24212;&#30340;&#26102;&#20505;&#65292;&#38544;&#34255;&#21518;&#31471;&#26381;&#21153;&#29256;&#26412;&#30456;&#24212;&#22836;&#37096;&#30340;&#20449;&#24687;&#65292;&#21487;&#20197;&#35774;&#32622;&#22312;http/server&#25110;location&#22359;&#65292;</span>
  location /web {
    index index.html;
    proxy_pass http://192.168.7.103:80/;
    proxy_hide_header ETag;
  }

proxy_pass_header field;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;nginx&#22312;&#21709;&#24212;&#25253;&#25991;&#20013;&#19981;&#20256;&#36882;&#21518;&#31471;&#26381;&#21153;&#22120;&#30340;&#39318;&#37096;&#23383;&#27573;Date, Server, X-Pad, X-Accel&#31561;&#21442;&#25968;&#65292;&#22914;&#26524;&#35201;&#20256;&#36882;&#30340;&#35805;&#21017;&#35201;&#20351;&#29992; proxy_pass_header field&#22768;&#26126;&#23558;&#21518;&#31471;&#26381;&#21153;&#22120;&#36820;&#22238;&#30340;&#20540;&#20256;&#36882;&#32473;&#23458;&#25143;&#31471;&#12290;</span>

proxy_pass_request_body on | off&#65307;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#21521;&#21518;&#31471;&#26381;&#21153;&#22120;&#21457;&#36865;HTTP&#21253;&#20307;&#37096;&#20998;,&#21487;&#20197;&#35774;&#32622;&#22312;http/server&#25110;location&#22359;&#65292;&#40664;&#35748;&#21363;&#20026;&#24320;&#21551;</span>

proxy_pass_request_headers on | off&#65307;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#23558;&#23458;&#25143;&#31471;&#30340;&#35831;&#27714;&#22836;&#37096;&#36716;&#21457;&#32473;&#21518;&#31471;&#26381;&#21153;&#22120;&#65292;&#21487;&#20197;&#35774;&#32622;&#22312;http/server&#25110;location&#22359;&#65292;&#40664;&#35748;&#21363;&#20026;&#24320;&#21551;</span>

proxy_set_header&#65307;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#26356;&#25913;&#25110;&#28155;&#21152;&#23458;&#25143;&#31471;&#30340;&#35831;&#27714;&#22836;&#37096;&#20449;&#24687;&#20869;&#23481;&#24182;&#36716;&#21457;&#33267;&#21518;&#31471;&#26381;&#21153;&#22120;&#65292;&#27604;&#22914;&#22312;&#21518;&#31471;&#26381;&#21153;&#22120;&#24819;&#35201;&#33719;&#21462;&#23458;&#25143;&#31471;&#30340;&#30495;&#23454;IP&#30340;&#26102;&#20505;&#65292;&#23601;&#35201;&#26356;&#25913;&#27599;&#19968;&#20010;&#25253;&#25991;&#30340;&#22836;&#37096;&#65292;&#22914;&#19979;&#65306;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span>
proxy_set_header X-Forwarded-For $<span style="color: #a0522d;">remote_addr</span>;
proxy_set_header X-Real-IP  $<span style="color: #a0522d;">remote_addr</span>;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;HOST&#21040;&#25253;&#25991;&#22836;&#37096;&#65292;&#22914;&#26524;&#23458;&#25143;&#31471;&#20026;NAT&#19978;&#32593;&#37027;&#20040;&#20854;&#20540;&#20026;&#23458;&#25143;&#31471;&#30340;&#20849;&#29992;&#30340;&#20844;&#32593;IP&#22320;&#22336;&#65292;&#24120;&#29992;&#20110;&#22312;&#26085;&#20043;&#20013;&#35760;&#24405;&#23458;&#25143;&#31471;&#30340;&#30495;&#23454;IP&#22320;&#22336;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#21518;&#31471;httpd&#26381;&#21153;&#22120;&#20462;&#25913;&#37197;&#32622;,&#28155;&#21152;&#26085;&#24535;&#35760;&#24405;X-Forwarded-For&#23383;&#27573;</span>
LogFormat <span style="color: #8b2252;">"%h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\" \"%{X-</span>
<span style="color: #8b2252;">Real-IP}i\""</span> combined

proxy_connect_timeout time&#65307;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;nginx&#26381;&#21153;&#22120;&#19982;&#21518;&#31471;&#26381;&#21153;&#22120;&#23581;&#35797;&#24314;&#31435;&#36830;&#25509;&#30340;&#36229;&#26102;&#26102;&#38388;&#65292;&#40664;&#35748;&#20026;60&#31186;&#65292;&#29992;&#27861;&#22914;&#19979;&#65306;</span>
proxy_connect_timeout 60s&#65307;
<span style="color: #b22222;">#</span><span style="color: #b22222;">60s&#20026;&#33258;&#23450;&#20041;nginx&#19982;&#21518;&#31471;&#26381;&#21153;&#22120;&#24314;&#31435;&#36830;&#25509;&#30340;&#36229;&#26102;&#26102;&#38388;</span>

proxy_read_time time&#65307;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;nginx&#26381;&#21153;&#22120;&#21521;&#21518;&#31471;&#26381;&#21153;&#22120;&#25110;&#26381;&#21153;&#22120;&#32452;&#21457;&#36215;read&#35831;&#27714;&#21518;&#65292;&#31561;&#24453;&#30340;&#36229;&#26102;&#26102;&#38388;&#65292;&#40664;&#35748;60s</span>
proxy_send_time time&#65307;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;nginx&#39033;&#21518;&#31471;&#26381;&#21153;&#22120;&#25110;&#26381;&#21153;&#22120;&#32452;&#21457;&#36215;write&#35831;&#27714;&#21518;&#65292;&#31561;&#24453;&#30340;&#36229;&#26102;&#26102;&#38388;&#65292;&#40664;&#35748;60s</span>

proxy_http_version 1.0&#65307;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;&#35774;&#32622;nginx&#25552;&#20379;&#20195;&#29702;&#26381;&#21153;&#30340;HTTP&#21327;&#35758;&#30340;&#29256;&#26412;&#65292;&#40664;&#35748;http 1.0</span>

proxy_ignore_client_abort off&#65307;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#23458;&#25143;&#31471;&#32593;&#32476;&#20013;&#26029;&#35831;&#27714;&#26102;&#65292;nginx&#26381;&#21153;&#22120;&#20013;&#26029;&#20854;&#23545;&#21518;&#31471;&#26381;&#21153;&#22120;&#30340;&#35831;&#27714;&#12290;&#21363;&#22914;&#26524;&#27492;&#39033;&#35774;&#32622;&#20026;on&#24320;&#21551;&#65292;&#21017;&#26381;&#21153;&#22120;&#20250;&#24573;&#30053;&#23458;&#25143;&#31471;&#20013;&#26029;&#24182;&#19968;&#30452;&#31561;&#30528;&#20195;&#29702;&#26381;&#21153;&#25191;&#34892;&#36820;&#22238;&#65292;&#22914;&#26524;&#35774;&#32622;&#20026;off&#65292;&#21017;&#23458;&#25143;&#31471;&#20013;&#26029;&#21518;Nginx&#20063;&#20250;&#20013;&#26029;&#23458;&#25143;&#31471;&#35831;&#27714;&#24182;&#31435;&#21363;&#35760;&#24405;499&#26085;&#24535;&#65292;&#40664;&#35748;&#20026;off&#12290;</span>

proxy_headers_hash_bucket_size 128&#65307;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#37197;&#32622;&#20102; proxy_hide_header&#21644;proxy_set_header&#30340;&#26102;&#20505;&#65292;&#29992;&#20110;&#35774;&#32622;nginx&#20445;&#23384;HTTP&#25253;&#25991;&#22836;&#30340;hash&#34920;&#30340;&#19978;&#38480;&#12290;</span>
proxy_headers_hash_max_size 512&#65307;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;proxy_headers_hash_bucket_size&#30340;&#26368;&#22823;&#21487;&#29992;&#31354;&#38388;</span>

server_names_hash_bucket_size 512;
<span style="color: #b22222;">#</span><span style="color: #b22222;">server_name hash&#34920;&#30003;&#35831;&#31354;&#38388;&#22823;&#23567;</span>
server_names_hash_max_szie 512;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26381;&#21153;&#22120;&#21517;&#31216;hash&#34920;&#30340;&#19978;&#38480;&#22823;&#23567;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7da7d488-a5d8-4098-9059-be556d099d43" class="outline-5">
<h5 id="h:7da7d488-a5d8-4098-9059-be556d099d43">反向代理单台web服务器</h5>
<div class="outline-text-5" id="text-h:7da7d488-a5d8-4098-9059-be556d099d43">
<div class="org-src-container">
<pre class="src src-sh">[root@s2 conf.d]# mv pc.conf pc.conf.bak0304
[root@s2 conf.d]# cp mobile.conf pc.conf
[root@s2 conf.d]# cat pc.conf
server {
  listen 80;
  server_name www.cici.net;
  location / {
    proxy_pass http://192.168.7.103:80/;
  }
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;Nginx &#24182;&#35775;&#38382;&#27979;&#35797;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:de02006d-69f2-4ad8-bcd1-6e693ca36169" class="outline-5">
<h5 id="h:de02006d-69f2-4ad8-bcd1-6e693ca36169">反向代理示例&#x2013;指定location</h5>
<div class="outline-text-5" id="text-h:de02006d-69f2-4ad8-bcd1-6e693ca36169">
<div class="org-src-container">
<pre class="src src-sh">server {
  listen 80;
  server_name www.cici.net;
  location / {
    index index.html index.php;
    root /data/nginx/html/pc;
  }

  location /web {
    <span style="color: #b22222;">#</span><span style="color: #b22222;">proxy_pass http://192.168.7.103:80/; #&#27880;&#24847;&#26377;&#21518;&#38754;&#30340;/&#65292;</span>
    proxy_pass http://192.168.7.104:80/;
  }
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#31471;web&#26381;&#21153;&#22120;&#24517;&#39035;&#35201;&#26377;&#30456;&#23545;&#20110;&#30340;&#35775;&#38382;URL</span>
[root@s3 ~]# mkdir /var/www/html/web
[root@s3 ~]# echo <span style="color: #8b2252;">"web1 page for apache"</span> &gt; /var/www/html/web/index.html
[root@s4 ~]# mkdir /var/www/html/web
[root@s4 ~]# echo <span style="color: #8b2252;">"web2 page for apache"</span> &gt; /var/www/html/web/index.html

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;Nginx&#24182;&#35775;&#38382;&#27979;&#35797;&#65306;</span>
[root@s2 ~]# curl -L http://www.cici.net/
pc web
[root@s2 ~]# curl -L http://www.cici.net/web
web2 page for apache

<span style="color: #b22222;">#</span><span style="color: #b22222;">Apache&#30340;&#35775;&#38382;&#26085;&#24535;&#65306;</span>
[root@s4 ~]# tail -f /var/log/httpd/access_log
192.168.7.102 - - [04/Mar/2019:18:52:00 +0800] <span style="color: #8b2252;">"GET /web/ HTTP/1.1"</span> 200 21 <span style="color: #8b2252;">"-""curl/7.29.0"</span>
192.168.7.102 - - [04/Mar/2019:18:52:00 +0800] <span style="color: #8b2252;">"GET /web HTTP/1.0"</span> 301 233 <span style="color: #8b2252;">"-""curl/7.29.0"</span>
192.168.7.102 - - [04/Mar/2019:18:52:00 +0800] <span style="color: #8b2252;">"GET /web/ HTTP/1.1"</span> 200 21 <span style="color: #8b2252;">"-""curl/7.29.0"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:383aaa36-a3e1-42f2-a2d2-7157b914a44a" class="outline-5">
<h5 id="h:383aaa36-a3e1-42f2-a2d2-7157b914a44a">反向代理示例-缓存功能</h5>
<div class="outline-text-5" id="text-h:383aaa36-a3e1-42f2-a2d2-7157b914a44a">
<p>
缓存功能默认关闭状态
</p>

<div class="org-src-container">
<pre class="src src-sh">proxy_cache zone | off; &#40664;&#35748;off
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#26126;&#35843;&#29992;&#30340;&#32531;&#23384;&#65292;&#25110;&#20851;&#38381;&#32531;&#23384;&#26426;&#21046;&#65307;Context:http, server, location</span>

proxy_cache_key string;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32531;&#23384;&#20013;&#29992;&#20110;&#8220;&#38190;&#8221;&#30340;&#20869;&#23481;&#65292;&#40664;&#35748;&#20540;&#65306;proxy_cache_key $scheme$proxy_host$request_uri;</span>

proxy_cache_valid [code ...] time;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#23545;&#29305;&#23450;&#21709;&#24212;&#30721;&#30340;&#21709;&#24212;&#20869;&#23481;&#30340;&#32531;&#23384;&#26102;&#38271;&#65292;&#23450;&#20041;&#22312;http{...}&#20013;</span>
    &#31034;&#20363;:
    proxy_cache_valid 200 302 10m;
    proxy_cache_valid 404 1m;

proxy_cache_path;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#21487;&#29992;&#20110;proxy&#21151;&#33021;&#30340;&#32531;&#23384;&#65307;Context:http</span>
proxy_cache_path path [<span style="color: #a0522d;">levels</span>=levels] [<span style="color: #a0522d;">use_temp_path</span>=on|off] <span style="color: #a0522d;">keys_zone</span>=name:size [<span style="color: #a0522d;">inactive</span>=time] [<span style="color: #a0522d;">max_size</span>=size][<span style="color: #a0522d;">manager_files</span>=number] [<span style="color: #a0522d;">manager_sleep</span>=time]
[<span style="color: #a0522d;">manager_threshold</span>=time] [<span style="color: #a0522d;">loader_files</span>=number] [<span style="color: #a0522d;">loader_sleep</span>=time]
[<span style="color: #a0522d;">loader_threshold</span>=time] [<span style="color: #a0522d;">purger</span>=on|off] [<span style="color: #a0522d;">purger_files</span>=number] [<span style="color: #a0522d;">purger_sleep</span>=time]
[<span style="color: #a0522d;">purger_threshold</span>=time];

&#31034;&#20363;&#65306;&#22312;http&#37197;&#32622;&#23450;&#20041;&#32531;&#23384;&#20449;&#24687;
proxy_cache_path /var/cache/nginx/proxy_cache <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#32531;&#23384;&#20445;&#23384;&#36335;&#24452;&#65292;proxy_cache&#20250;&#33258;&#21160;&#21019;&#24314;</span>
<span style="color: #a0522d;">levels</span>=1:2:2 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#32531;&#23384;&#30446;&#24405;&#32467;&#26500;&#23618;&#27425;&#65292;1:2:2&#21487;&#20197;&#29983;&#25104;2^4x2^8x2^8=1048576&#20010;&#30446;&#24405;</span>
<span style="color: #a0522d;">keys_zone</span>=proxycache:20m <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#20869;&#23384;&#20013;&#32531;&#23384;&#30340;&#22823;&#23567;&#65292;&#20027;&#35201;&#29992;&#20110;&#23384;&#25918;key&#21644;metadata&#65288;&#22914;&#65306;&#20351;&#29992;&#27425;&#25968;&#65289;</span>
<span style="color: #a0522d;">inactive</span>=120s&#65307; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32531;&#23384;&#26377;&#25928;&#26102;&#38388;</span>
<span style="color: #a0522d;">max_size</span>=1g; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#22823;&#30913;&#30424;&#21344;&#29992;&#31354;&#38388;&#65292;&#30913;&#30424;&#23384;&#20837;&#25991;&#20214;&#20869;&#23481;&#30340;&#32531;&#23384;&#31354;&#38388;&#26368;&#22823;&#20540;</span>


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35843;&#29992;&#32531;&#23384;&#21151;&#33021;&#65292;&#38656;&#35201;&#23450;&#20041;&#22312;&#30456;&#24212;&#30340;&#37197;&#32622;&#27573;&#65292;&#22914;server{...}&#65307;&#25110;&#32773;location&#31561;</span>
proxy_cache proxycache;
proxy_cache_key $<span style="color: #a0522d;">request_uri</span>;
proxy_cache_valid 200 302 301 10m; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#30340;&#29366;&#24577;&#30721;&#36820;&#22238;&#30340;&#25968;&#25454;&#32531;&#23384;&#22810;&#38271;&#26102;&#38388;</span>
proxy_cache_valid any 1m;


proxy_cache_use_stale error http_502 http_503;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#34987;&#20195;&#29702;&#30340;&#21518;&#31471;&#26381;&#21153;&#22120;&#20986;&#29616;&#21738;&#31181;&#24773;&#20917;&#19979;&#65292;&#21487;&#30452;&#25509;&#20351;&#29992;&#36807;&#26399;&#30340;&#32531;&#23384;&#21709;&#24212;&#23458;&#25143;&#31471;&#65292;</span>
proxy_cache_use_stale error | timeout | invalid_header | updating | http_500 | http_502 | http_503 | http_504 | http_403 | http_404 | off ; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#26159;off</span>


proxy_cache_methods GET | HEAD | POST ...;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#21738;&#20123;&#23458;&#25143;&#31471;&#35831;&#27714;&#26041;&#27861;&#23545;&#24212;&#30340;&#21709;&#24212;&#36827;&#34892;&#32531;&#23384;&#65292;GET&#21644;HEAD&#26041;&#27861;&#24635;&#26159;&#34987;&#32531;&#23384;</span>
</pre>
</div>

<p>
<b>非缓存场景压测</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@s3 app1]# pwd
/var/www/html/app1
[root@s3 app1]# cp /var/log/messages ./log.html <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20934;&#22791;&#27979;&#35797;&#39029;&#38754;</span>
[root@s2 pc]# ab -n 2000 -c200 http://www.cici.net/web/log.html
    Total transferred:      3059318000 bytes
    HTML transferred:       3058760000 bytes
    Requests per second:    155.14 [#/sec] (mean)
    Time per request:       1289.166 [ms] (mean)
    Time per request:       6.446 [ms] (mean, across all concurrent requests)
    Transfer rate:          231747.94 [Kbytes/sec] received
</pre>
</div>

<p>
<b>准备缓存配置</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@s2 pc]# vim /apps/nginx/conf/nginx.conf
proxy_cache_path /data/nginx/proxycache <span style="color: #a0522d;">levels</span>=1:1:1 <span style="color: #a0522d;">keys_zone</span>=proxycache:20m <span style="color: #a0522d;">inactive</span>=120s <span style="color: #a0522d;">max_size</span>=1g; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#22312;nginx.conf http&#37197;&#32622;&#27573;</span>

[root@s2 pc]# vim /apps/nginx/conf/conf.d/pc.conf
location /web { <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35201;&#32531;&#23384;&#30340;URL &#25110;&#32773;&#25918;&#22312;server&#37197;&#32622;&#39033;&#23545;&#25152;&#26377;URL&#37117;&#36827;&#34892;&#32531;&#23384;</span>
    proxy_pass http://192.168.7.104:80/;
    proxy_set_header clientip $<span style="color: #a0522d;">remote_addr</span>;
    proxy_cache proxycache;
    proxy_cache_key $<span style="color: #a0522d;">request_uri</span>;
    proxy_cache_valid 200 302 301 1h;
    proxy_cache_valid any 1m;
}

[root@s2 pc]# /apps/nginx/sbin/nginx -t
nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok
nginx: configuration file /apps/nginx/conf/nginx.conf test is successful
[root@s2 pc]# systemctl start nginx
</pre>
</div>

<p>
<b>访问并验证缓存文件</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;web&#24182;&#39564;&#35777;&#32531;&#23384;&#30446;&#24405;</span>
[root@s2 pc]# curl http://www.cici.net/web/log.html
[root@s2 pc]# ab -n 2000 -c200 http://www.cici.net/web/log.html
    Total transferred:      3059318000 bytes
    HTML transferred:       3058760000 bytes
    Requests per second:    1922.78 [#/sec] (mean)
    Time per request:       104.016 [ms] (mean)
    Time per request:       0.520 [ms] (mean, across all concurrent requests)
    Transfer rate:          2872259.55 [Kbytes/sec] received

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#32531;&#23384;&#30446;&#24405;&#32467;&#26500;&#21450;&#25991;&#20214;&#22823;&#23567;</span>
[root@s2 pc]# tree /data/nginx/proxycache/
/data/nginx/proxycache/
&#9492;&#9472;&#9472; f
    &#9492;&#9472;&#9472; 0
        &#9492;&#9472;&#9472; 6
            &#9492;&#9472;&#9472; 50b643197ae7d66aaaa5e7e1961b060f
3 directories, 1 file
[root@s2 pc]# ll -h /data/nginx/proxycache/f/0/6/50b643197ae7d66aaaa5e7e1961b060f
-rw------- 1 nginx nginx 1.5M Mar 7 14:30 /data/nginx/proxycache/f/0/6/50b643197ae7d66aaaa5e7e1961b060f

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#25991;&#20214;&#20869;&#23481;&#65306;</span>
[root@s2 pc]# head -n100 /data/nginx/proxycache/f/0/6/50b643197ae7d66aaaa5e7e1961b060f
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20250;&#22312;&#25991;&#20214;&#39318;&#37096;&#28155;&#21152;&#30456;&#24212;&#30721;</span>
HTTP/1.1 200 OK
Date: Thu, 07 Mar 2019 18:35:37 GMT
Server: Apache/2.4.6 (CentOS)
Last-Modified: Thu, 07 Mar 2019 14:14:47 GMT
ETag: <span style="color: #8b2252;">"175624-58381ba95ac05"</span>
Accept-Ranges: bytes
Content-Length: 1529380
Connection: close
Content-Type: text/html; <span style="color: #a0522d;">charset</span>=UTF-8

192.168.0.1 - - [18/Feb/2019:10:26:33 +0800] <span style="color: #8b2252;">"GET / HTTP/1.1"</span> 200 612
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8774330c-81f3-4655-be18-63809e6bc779" class="outline-5">
<h5 id="h:8774330c-81f3-4655-be18-63809e6bc779">添加头部报文信息</h5>
<div class="outline-text-5" id="text-h:8774330c-81f3-4655-be18-63809e6bc779">
<p>
nginx基于模块ngx_http_headers_module可以实现对头部报文添加指定的key与值，
<a href="https://nginx.org/en/docs/http/ngx_http_headers_module.html">https://nginx.org/en/docs/http/ngx_http_headers_module.html</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">Syntax: add_header name value [always];
Default: &#8212;
Context: http, server, location, if<span style="color: #a020f0;"> in</span> location

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#33258;&#23450;&#20041;&#39318;&#37096;&#65292;&#22914;&#19979;&#65306;</span>
add_header name value [always];

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;</span>
add_header X-Via &#160;$<span style="color: #a0522d;">server_addr</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;nginx&#20027;&#26426;&#30340;IP</span>
add_header X-Cache $<span style="color: #a0522d;">upstream_cache_status</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#32531;&#23384;&#21629;&#20013;</span>
add_header X-Accel $<span style="color: #a0522d;">server_name</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#35775;&#38382;&#30340;FQDN</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#33258;&#23450;&#20041;&#21709;&#24212;&#20449;&#24687;&#30340;&#23614;&#37096;&#65292; 1.13.2&#29256;&#21518;&#25903;&#25345;</span>
add_trailer name value [always];
</pre>
</div>

<p>
<b>Nginx配置</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">location /web {
  proxy_pass http://192.168.7.103:80/;
  proxy_set_header clientip $<span style="color: #a0522d;">remote_addr</span>;
  proxy_cache proxycache;
  proxy_cache_key $<span style="color: #a0522d;">request_uri</span>;
  proxy_cache_valid 200 302 301 1h;
  proxy_cache_valid any 1m;
  add_header X-Via $<span style="color: #a0522d;">server_addr</span>;
  add_header X-Cache $<span style="color: #a0522d;">upstream_cache_status</span>;
  add_header X-Accel $<span style="color: #a0522d;">server_name</span>;
}
</pre>
</div>

<p>
<b>验证头部信息</b> ：
</p>
</div>
</div>
</div>
<div id="outline-container-h:7a2a0dbb-a6bd-485d-89a7-180ee2629933" class="outline-4">
<h4 id="h:7a2a0dbb-a6bd-485d-89a7-180ee2629933">Nginx http 反向代理高级应用</h4>
<div class="outline-text-4" id="text-h:7a2a0dbb-a6bd-485d-89a7-180ee2629933">
<p>
在上一个章节中Nginx可以将客户端的请求转发至单台后端服务器但是无法转发至特定的一组的服务器，而且不能对后端服务器提供相应的服务器状态监测，但是Nginx可以基于ngx_http_upstream_module模块提供服务器分组转发、权重分配、状态监测、调度算法等高级功能
</p>

<p>
官方文档：<a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html">https://nginx.org/en/docs/http/ngx_http_upstream_module.html</a>
</p>
</div>
<div id="outline-container-h:69f3d6c6-d03d-4ec9-a932-305b2e2ee1a9" class="outline-5">
<h5 id="h:69f3d6c6-d03d-4ec9-a932-305b2e2ee1a9">http upstream配置参数</h5>
<div class="outline-text-5" id="text-h:69f3d6c6-d03d-4ec9-a932-305b2e2ee1a9">
<div class="org-src-container">
<pre class="src src-sh">upstream name {
server .....
......
}
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;</span>
upstream backend {
 server backend1.example.com <span style="color: #a0522d;">weight</span>=5;
 server 127.0.0.1:8080    <span style="color: #a0522d;">max_fails</span>=3 <span style="color: #a0522d;">fail_timeout</span>=30s;
 server unix:/tmp/backend3;
 server backup1.example.com backup;
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">upstream name {
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#23450;&#20041;&#19968;&#32452;&#26381;&#21153;&#22120;&#65292;&#37197;&#32622;&#22312;http&#20869;</span>
server address [parameters];
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#19968;&#20010;&#21518;&#31471;web&#26381;&#21153;&#22120;&#65292;&#37197;&#32622;&#22312;upstream&#20869;&#65292;&#33267;&#23569;&#35201;&#26377;&#19968;&#20010;server&#26381;&#21153;&#22120;&#37197;&#32622;&#12290;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">server&#25903;&#25345;&#30340;parameters&#22914;&#19979;&#65306;</span>
<span style="color: #a0522d;">weight</span>=number <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#26435;&#37325;&#65292;&#40664;&#35748;&#20026;1&#12290;</span>
<span style="color: #a0522d;">max_conns</span>=number <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32473;&#24403;&#21069;server&#35774;&#32622;&#26368;&#22823;&#27963;&#21160;&#38142;&#25509;&#25968;&#65292;&#40664;&#35748;&#20026;0&#34920;&#31034;&#27809;&#26377;&#38480;&#21046;&#12290;</span>
<span style="color: #a0522d;">fail_timeout</span>=time <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#21518;&#31471;&#26381;&#21153;&#22120;&#30340;&#21333;&#27425;&#30417;&#27979;&#36229;&#26102;&#26102;&#38388;&#65292;&#40664;&#35748;&#20026;10&#31186;&#12290;</span>
<span style="color: #a0522d;">max_fails</span>=number <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;fail_timeout&#26102;&#38388;&#23545;&#21518;&#31471;&#26381;&#21153;&#22120;&#36830;&#32493;&#30417;&#27979;&#22833;&#36133;&#22810;&#23569;&#27425;&#23601;&#26631;&#35760;&#20026;&#19981;&#21487;&#29992;&#12290;</span>
backup <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#20026;&#22791;&#20221;&#26381;&#21153;&#22120;&#65292;&#24403;&#25152;&#26377;&#26381;&#21153;&#22120;&#19981;&#21487;&#29992;&#26102;&#23558;&#37325;&#26032;&#21551;&#29992;&#27425;&#26381;&#21153;&#22120;&#12290;</span>
down <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26631;&#35760;&#20026;down&#29366;&#24577;&#12290;</span>
resolve <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;server&#23450;&#20041;&#30340;&#26159;&#20027;&#26426;&#21517;&#30340;&#26102;&#20505;&#65292;&#24403;A&#35760;&#24405;&#21457;&#29983;&#21464;&#21270;&#20250;&#33258;&#21160;&#24212;&#29992;&#26032;IP&#32780;&#19981;&#29992;&#37325;&#21551;Nginx&#12290;</span>


<span style="color: #483d8b;">hash</span> KEY consistent&#65307;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110;&#25351;&#23450;key&#20570;hash&#35745;&#31639;&#65292;&#20351;&#29992;consistent&#21442;&#25968;&#65292;&#23558;&#20351;&#29992;ketama&#19968;&#33268;&#24615;hash&#31639;&#27861;&#65292;&#36866;&#29992;&#20110;&#21518;&#31471;&#26159;Cache&#26381;&#21153;&#22120;&#65288;&#22914;varnish&#65289;&#26102;&#20351;&#29992;&#65292;consistent&#23450;&#20041;&#20351;&#29992;&#19968;&#33268;&#24615;hash&#36816;&#31639;&#65292;&#19968;&#33268;&#24615;hash&#22522;&#20110;&#21462;&#27169;&#36816;&#31639;&#12290;</span>

<span style="color: #483d8b;">hash</span> $<span style="color: #a0522d;">request_uri</span> consistent; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110;&#29992;&#25143;&#35831;&#27714;&#30340;uri&#20570;hash</span>
<span style="color: #483d8b;">hash</span> $<span style="color: #a0522d;">cookie_sessionid</span> &#160;#&#22522;&#20110;cookie&#20013;&#30340;sessionid&#36825;&#20010;key&#36827;&#34892;hash&#35843;&#24230;,&#23454;&#29616;&#20250;&#35805;&#32465;&#23450;

ip_hash&#65307;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28304;&#22320;&#22336;hash&#35843;&#24230;&#26041;&#27861;&#65292;&#22522;&#20110;&#30340;&#23458;&#25143;&#31471;&#30340;remote_addr(&#28304;&#22320;&#22336;)&#20570;hash&#35745;&#31639;&#65292;&#20197;&#23454;&#29616;&#20250;&#35805;&#20445;&#25345;&#65292;</span>


least_conn;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#23569;&#36830;&#25509;&#35843;&#24230;&#31639;&#27861;&#65292;&#20248;&#20808;&#23558;&#23458;&#25143;&#31471;&#35831;&#27714;&#35843;&#24230;&#21040;&#24403;&#21069;&#36830;&#25509;&#26368;&#23569;&#30340;&#21518;&#31471;&#26381;&#21153;&#22120;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:781653bd-f432-4f02-885c-155555928dd3" class="outline-5">
<h5 id="h:781653bd-f432-4f02-885c-155555928dd3">反向代理示例-多台web服务器</h5>
<div class="outline-text-5" id="text-h:781653bd-f432-4f02-885c-155555928dd3">
<div class="org-src-container">
<pre class="src src-sh">upstream webserver {
  <span style="color: #b22222;">#</span><span style="color: #b22222;">hash $request_uri consistent;</span>
  <span style="color: #b22222;">#</span><span style="color: #b22222;">ip_hash&#65307;</span>
  <span style="color: #b22222;">#</span><span style="color: #b22222;">least_conn;</span>
  server 192.168.7.103:80 <span style="color: #a0522d;">weight</span>=1 <span style="color: #a0522d;">fail_timeout</span>=15s <span style="color: #a0522d;">max_fails</span>=3; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#31471;&#26381;&#21153;&#22120;&#29366;&#24577;&#30417;&#27979;</span>
  server 192.168.7.104:80 <span style="color: #a0522d;">weight</span>=1 <span style="color: #a0522d;">fail_timeout</span>=15s <span style="color: #a0522d;">max_fails</span>=3;
  server 192.168.7.101:80 <span style="color: #a0522d;">weight</span>=1 <span style="color: #a0522d;">fail_timeout</span>=15s <span style="color: #a0522d;">max_fails</span>=3 backup;
}

server {
  listen 80;
  server_name www.cici.net;
  location / {
    index index.html index.php;
    root /data/nginx/html/pc;
  }

  location /web {
    index index.html;
    proxy_pass http://webserver/;
  }
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;Nginx &#24182;&#35775;&#38382;&#27979;&#35797;</span>
[root@s2 ~]# curl http://www.cici.net/web
web1 192.168.7.103
[root@s2 ~]# curl http://www.cici.net/web
web2 192.168.7.104
</pre>
</div>

<p>
关闭192.168.7.103和192.168.7.104，测试nginx backup服务器可用性：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@s4 ~]# while true;<span style="color: #a020f0;">do</span> curl http://www.cici.net/web;sleep 1;<span style="color: #a020f0;">done</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b6a1d65e-dca7-4b69-8399-4a88fc24be7a" class="outline-5">
<h5 id="h:b6a1d65e-dca7-4b69-8399-4a88fc24be7a">反向代理示例 - 客户端 IP 透传</h5>
<div class="outline-text-5" id="text-h:b6a1d65e-dca7-4b69-8399-4a88fc24be7a">
<div class="org-src-container">
<pre class="src src-sh">[root@s2 conf.d]# cat pc.conf
upstream webserver {
  <span style="color: #b22222;">#</span><span style="color: #b22222;">hash $request_uri consistent; #consistent &#19968;&#33268;&#24615;hash&#31639;&#27861;</span>
  <span style="color: #b22222;">#</span><span style="color: #b22222;">server 192.168.7.103:80 weight=1 fail_timeout=5s max_fails=3;</span>
  server 192.168.7.104:80 <span style="color: #a0522d;">weight</span>=1 <span style="color: #a0522d;">fail_timeout</span>=5s <span style="color: #a0522d;">max_fails</span>=3;
  server 192.168.7.101:80 <span style="color: #a0522d;">weight</span>=1 <span style="color: #a0522d;">fail_timeout</span>=5s <span style="color: #a0522d;">max_fails</span>=3 backup;
}

server {
  listen 80;
  server_name www.cici.net;
  location / {
    index index.html index.php;
    root /data/nginx/html/pc;
  }

  location /web {
    index index.html;
    proxy_pass http://webserver/;
    proxy_set_header X-Forwarded-For $<span style="color: #a0522d;">proxy_add_x_forwarded_for</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#23458;&#25143;&#31471;IP&#21040;&#25253;&#25991;&#22836;&#37096;</span>
  }
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;nginx</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#31471;web&#26381;&#21153;&#22120;&#37197;&#32622;</span>
1&#12289;Apache&#65306;
[root@s4 ~]# vim /etc/httpd/conf/httpd.conf
LogFormat <span style="color: #8b2252;">"%{X-Forwarded-For}i %h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{UserAgent}i\""</span> combined

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;apache&#35775;&#38382;web&#30028;&#38754;&#24182;&#39564;&#35777;apache&#26085;&#24535;&#65306;</span>
192.168.7.104 192.168.7.102 - - [05/Mar/2019:00:36:03 +0800] <span style="color: #8b2252;">"GET / HTTP/1.0"</span> 200 19 <span style="color: #8b2252;">"-"</span> <span style="color: #8b2252;">"curl/7.29.0"</span>
192.168.0.1 192.168.7.102 - - [05/Mar/2019:00:40:46 +0800] <span style="color: #8b2252;">"GET / HTTP/1.0"</span> 200 19 <span style="color: #8b2252;">"-"</span> <span style="color: #8b2252;">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.119 Safari/537.36"</span>

2&#12289;Nginx&#65306;
[root@s1 conf.d]# cat /apps/nginx/conf/nginx.conf
<span style="color: #8b2252;">"$http_x_forwarded_for"' #&#40664;&#35748;&#26085;&#24535;&#26684;&#24335;&#23601;&#26377;&#27492;&#37197;&#32622;</span>

<span style="color: #8b2252;">&#37325;&#21551;nginx&#35775;&#38382;web&#30028;&#38754;&#24182;&#39564;&#35777;&#26085;&#24535;&#26684;&#24335;&#65306;</span>
<span style="color: #8b2252;">192.168.7.102 - - [04/Mar/2019:16:33:24 +0800] "GET // HTTP/1.0" 200 24 "-" "curl/7.29.0" "192.168.7.104"</span>
<span style="color: #8b2252;">192.168.7.102 - - [04/Mar/2019:16:40:51 +0800] "GET / HTTP/1.0" 200 24 "-" "Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.119 Safari/537.36" "192.168.0.1"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a8cea549-4e34-4925-addd-23d9cf963c3c" class="outline-5">
<h5 id="h:a8cea549-4e34-4925-addd-23d9cf963c3c">实战案例: 基于Cookie 实现会话绑定</h5>
<div class="outline-text-5" id="text-h:a8cea549-4e34-4925-addd-23d9cf963c3c">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /apps/nginx/conf/nginx.conf
http {
upstream websrvs {
<span style="color: #483d8b;">hash</span> $<span style="color: #a0522d;">cookie_hello</span>;  <span style="color: #b22222;">#</span><span style="color: #b22222;">hello&#26159;cookie&#30340;key&#30340;&#21517;&#31216;</span>
server 10.0.0.101:80 <span style="color: #a0522d;">weight</span>=2;
server 10.0.0.102:80 weight-1;
}
}
[root@centos8 ~]# vim /apps/nginx/conf/conf.d/pc.conf
server {
 location /{
<span style="color: #b22222;">#</span><span style="color: #b22222;">proxy_cache mycache;</span>
proxy_pass http://websrvs;
 }
}
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:6e6a0587-1333-4931-984e-c9c56b0f4334" class="outline-3">
<h3 id="h:6e6a0587-1333-4931-984e-c9c56b0f4334">实现Nginx tcp负载均衡</h3>
<div class="outline-text-3" id="text-h:6e6a0587-1333-4931-984e-c9c56b0f4334">
<p>
支持的时间太晚，导致目前用的较少
</p>

<p>
Nginx在1.9.0版本开始支持tcp模式的负载均衡，在1.9.13版本开始支持udp协议
的负载，udp主要用于DNS的域名解析，其配置方式和指令和http代理类似，其基
于ngx_stream_proxy_module模块实现tcp负载，另外基于模块
ngx_stream_upstream_module实现后端服务器分组转发、权重分配、状态监测、
调度算法等高级功能。
</p>

<p>
官方文档：
</p>

<p>
<a href="https://nginx.org/en/docs/stream/ngx_stream_proxy_module.html">https://nginx.org/en/docs/stream/ngx_stream_proxy_module.html</a>
</p>

<p>
<a href="http://nginx.org/en/docs/stream/ngx_stream_upstream_module.html">http://nginx.org/en/docs/stream/ngx_stream_upstream_module.html</a>
</p>
</div>
<div id="outline-container-h:70762eb1-dfce-442f-95a5-de9a50b25b5e" class="outline-4">
<h4 id="h:70762eb1-dfce-442f-95a5-de9a50b25b5e">tcp负载均衡配置参数</h4>
<div class="outline-text-4" id="text-h:70762eb1-dfce-442f-95a5-de9a50b25b5e">
<div class="org-src-container">
<pre class="src src-sh">stream { <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;stream</span>
  upstream backend { <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#21518;&#31471;&#26381;&#21153;&#22120;</span>
    <span style="color: #483d8b;">hash</span> $<span style="color: #a0522d;">remote_addr</span> consistent; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#35843;&#24230;&#31639;&#27861;</span>

    server backend1.example.com:12345 <span style="color: #a0522d;">weight</span>=5; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#20855;&#20307;server</span>
    server 127.0.0.1:12345 <span style="color: #a0522d;">max_fails</span>=3 <span style="color: #a0522d;">fail_timeout</span>=30s;
    server unix:/tmp/backend3;
  }

  upstream dns { <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#21518;&#31471;&#26381;&#21153;&#22120;</span>
    server 192.168.0.1:53535; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#20855;&#20307;server</span>
    server dns.example.com:53;
  }

  server { <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;server</span>
    listen 12345; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30417;&#21548;IP:PORT</span>
    proxy_connect_timeout 1s; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#36229;&#26102;&#26102;&#38388;</span>
    proxy_timeout 3s; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36716;&#21457;&#36229;&#26102;&#26102;&#38388;</span>
    proxy_pass backend; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36716;&#21457;&#21040;&#20855;&#20307;&#26381;&#21153;&#22120;&#32452;</span>
  }

  server {
    listen 127.0.0.1:53 udp reuseport;
    proxy_timeout 20s;
    proxy_pass dns;
  }

  server {
    listen [::1]:12345;
    proxy_pass unix:/tmp/stream.socket;
  }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d1427c5a-5692-4338-b6b2-d842556ec475" class="outline-4">
<h4 id="h:d1427c5a-5692-4338-b6b2-d842556ec475">负载均衡实例-Redis</h4>
<div class="outline-text-4" id="text-h:d1427c5a-5692-4338-b6b2-d842556ec475">
<p>
服务器安装redis
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@s4 ~]# yum install redis -y
[root@s4 ~]# vim /etc/redis.conf
<span style="color: #483d8b;">bind</span> 0.0.0.0
......
[root@s4 ~]# systemctl start redis
[root@s4 ~]# systemctl enable redis
[root@s4 ~]# ss -tnl | grep 6379
LISTEN  0   128     *:6379      *:*
</pre>
</div>

<p>
nginx配置：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@s2 ~]# mkdir /apps/nginx/conf/tcp
[root@s2 ~]# cat /apps/nginx/conf/tcp/tcp.conf
stream {
  upstream redis_server {
    <span style="color: #b22222;">#</span><span style="color: #b22222;">hash $remote_addr consistent;</span>
    server 192.168.7.104:6379 <span style="color: #a0522d;">max_fails</span>=3 <span style="color: #a0522d;">fail_timeout</span>=30s;
  }

  server {
    listen 192.168.7.102:6379;
    proxy_connect_timeout 3s;
    proxy_timeout 3s;
    proxy_pass redis_server;
  }
}

[root@s2 ~]# vim /apps/nginx/conf/nginx.conf
21 include /apps/nginx/conf/tcp/tcp.conf; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#27492;&#22788;&#30340;include&#19982;http&#27169;&#22359;&#24179;&#32423;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;nginx&#24182;&#35775;&#38382;&#27979;&#35797;</span>
[root@s2 ~]# systemctl restart nginx
[root@s2 ~]# ss -tnl | grep 6379
LISTEN  0   128     192.168.7.102:6379  *:*

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;&#36890;&#36807;nginx &#36127;&#36733;&#36830;&#25509;redis&#65306;</span>
[root@s4 ~]# redis-cli -h 192.168.7.102
192.168.7.102:6379&gt; set name jack
OK
192.168.7.102:6379&gt; get name
<span style="color: #8b2252;">"jack"</span>
192.168.7.102:6379&gt;

</pre>
</div>
</div>
</div>
<div id="outline-container-h:0f9244c4-1dec-4b58-8ca7-4e012d9d5fa1" class="outline-4">
<h4 id="h:0f9244c4-1dec-4b58-8ca7-4e012d9d5fa1">负载均衡实例：MySQL</h4>
<div class="outline-text-4" id="text-h:0f9244c4-1dec-4b58-8ca7-4e012d9d5fa1">
<p>
服务器安装MySQL:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@s4 ~]# yum install mariadb mariadb-server -y
[root@s4 ~]# systemctl start mariadb
[root@s4 ~]# mysql_secure_installation <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#20840;&#21021;&#22987;&#21270;</span>
[root@s4 ~]# systemctl enable mariadb
[root@s4 ~]# mysql -uroot -p123456
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON *.* TO <span style="color: #8b2252;">'root'</span>@<span style="color: #8b2252;">'%'</span> IDENTIFIED BY <span style="color: #8b2252;">'123456'</span> WITH GRANT OPTION;
MariaDB [(none)]&gt; FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.00 sec)
MariaDB [(none)]&gt; exit
</pre>
</div>

<p>
nginx配置：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@s2 ~]# cat /apps/nginx/conf/tcp/tcp.conf
stream {
  upstream redis_server {
    server 192.168.7.104:6379 <span style="color: #a0522d;">max_fails</span>=3 <span style="color: #a0522d;">fail_timeout</span>=30s;
  }

  upstream mysql_server {
    least_conn;
    server 192.168.7.104:3306 <span style="color: #a0522d;">max_fails</span>=3 <span style="color: #a0522d;">fail_timeout</span>=30s;
  }
<span style="color: #b22222;">###################################################################</span>
  server {
    listen 192.168.7.102:3306;
    proxy_connect_timeout 6s;
    proxy_timeout 15s;
    proxy_pass mysql_server;
  }

  server {
    listen 192.168.7.102:6379;
    proxy_connect_timeout 3s;
    proxy_timeout 3s;
    proxy_pass redis_server;
  }
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;nginx&#24182;&#35775;&#38382;&#27979;&#35797;&#65306;</span>
[root@s2 ~]# systemctl restart nginx

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;&#36890;&#36807;nginx&#36127;&#36733;&#36830;&#25509;MySQL&#65306;</span>
[root@s4 ~]# mysql -uroot -p123456 -h 192.168.7.102
Welcome to the MariaDB monitor. Commands end with ; or \g.
Your MariaDB connection id is 32
Server version: 5.5.60-MariaDB MariaDB Server

<span style="color: #0000ff;">Copyright</span> (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.
Type <span style="color: #8b2252;">'help;'</span> or <span style="color: #8b2252;">'\h'</span> for help. Type <span style="color: #8b2252;">'\c'</span> to clear the current input statement.

MariaDB [(none)]&gt; create database linux34;
Query OK, 1 row affected (0.00 sec)

MariaDB [(none)]&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| linux34            |
| mysql              |
| performance_schema |
+--------------------+
4 rows<span style="color: #a020f0;"> in</span> set (0.01 sec)

MariaDB [(none)]&gt;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:f1471e84-326c-496b-8825-cf548cc60593" class="outline-3">
<h3 id="h:f1471e84-326c-496b-8825-cf548cc60593">实现FastCGI</h3>
<div class="outline-text-3" id="text-h:f1471e84-326c-496b-8825-cf548cc60593">
<p>
CGI的由来：
</p>

<p>
最早的Web服务器只能简单地响应浏览器发来的HTTP请求，并将存储在服务器上
的HTML文件返回给浏览器，也就是静态html文件，但是后期随着网站功能增多网
站开发也越来越复杂，以至于出现动态技术，比如像php(1995年)、java(1995)、
python(1991)语言开发的网站，但是nginx/apache服务器并不能直接运行 php、
java这样的文件，apache实现的方式是打补丁，但是nginx缺通过与第三方基于
协议实现，即通过某种特定协议将客户端请求转发给第三方服务处理，第三方服
务器会新建新的进程处理用户的请求，处理完成后返回数据给Nginx并回收进程，
最后nginx在返回给客户端，那这个约定就是通用网关接口(common gateway
interface，简称CGI)，CGI（协议） 是web服务器和外部应用程序之间的接口标
准，是cgi程序和web服务器之间传递信息的标准化接口。
</p>




<p>
为什么会有FastCGI？
</p>

<p>
CGI协议虽然解决了语言解析器和 Web Server 之间通讯的问题，但是它的效率
很低，因为 Web Server每收到一个请求都会创建一个CGI进程，PHP解析器都会
解析php.ini文件，初始化环境，请求结束的时候再关闭进程，对于每一个创建
的CGI进程都会执行这些操作，所以效率很低，而FastCGI是用来提高CGI性能的，
FastCGI每次处理完请求之后不会关闭掉进程，而是保留这个进程，使这个进程
可以处理多个请求。这样的话每个请求都不用再重新创建一个进程了，大大提升
了处理效率。
</p>



<p>
什么是PHP-FPM？
</p>

<p>
PHP-FPM(FastCGI Process Manager：FastCGI进程管理器)是一个实现了Fastcgi
的管理程序，并且提供进程管理的功能，进程包括master进程和worker进程，
master进程只有一个，负责监听端口，接受来自web server的请求。worker进程
一般会有多个，每个进程中会嵌入一个PHP解析器，进行PHP代码的处理。
</p>
</div>
<div id="outline-container-h:bc4620bb-4d0e-4257-a757-30c4e20138bc" class="outline-4">
<h4 id="h:bc4620bb-4d0e-4257-a757-30c4e20138bc">FastCGI 配置指令</h4>
<div class="outline-text-4" id="text-h:bc4620bb-4d0e-4257-a757-30c4e20138bc">
<p>
Nginx基于模块ngx_http_fastcgi_module实现通过fastcgi协议将指定的客户端请求转发至php-fpm处理，其配置指令如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">fastcgi_pass address;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36716;&#21457;&#35831;&#27714;&#21040;&#21518;&#31471;&#26381;&#21153;&#22120;&#65292;address&#20026;&#21518;&#31471;&#30340;fastcgi server&#30340;&#22320;&#22336;&#65292;&#21487;&#29992;&#20301;&#32622;&#65306;location, if in location</span>

fastcgi_index name;
<span style="color: #b22222;">#</span><span style="color: #b22222;">fastcgi&#40664;&#35748;&#30340;&#20027;&#39029;&#36164;&#28304;&#65292;&#31034;&#20363;&#65306;fastcgi_index index.php;</span>

fastcgi_param parameter value [if_not_empty];
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#20256;&#36882;&#32473;FastCGI&#26381;&#21153;&#22120;&#30340;&#21442;&#25968;&#20540;&#65292;&#21487;&#20197;&#26159;&#25991;&#26412;&#65292;&#21464;&#37327;&#25110;&#32452;&#21512;&#65292;&#21487;&#29992;&#20110;&#23558;Nginx&#30340;&#20869;&#32622;&#21464;&#37327;&#36171;&#20540;&#32473;&#33258;&#23450;&#20041;key</span>
fastcgi_param REMOTE_ADDR $<span style="color: #a0522d;">remote_addr</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#28304;IP</span>
fastcgi_param REMOTE_PORT $<span style="color: #a0522d;">remote_port</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#28304;&#31471;&#21475;</span>
fastcgi_param SERVER_ADDR $<span style="color: #a0522d;">server_addr</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35831;&#27714;&#30340;&#26381;&#21153;&#22120;IP&#22320;&#22336;</span>
fastcgi_param SERVER_PORT $<span style="color: #a0522d;">server_port</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35831;&#27714;&#30340;&#26381;&#21153;&#22120;&#31471;&#21475;</span>
fastcgi_param SERVER_NAME $<span style="color: #a0522d;">server_name</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35831;&#27714;&#30340;server name</span>

Nginx&#40664;&#35748;&#37197;&#32622;&#31034;&#20363;&#65306;
location ~ <span style="color: #8b2252;">\.</span>php$ {
  root html;
  fastcgi_pass 127.0.0.1:9000;
  fastcgi_index index.php;
  fastcgi_param SCRIPT_FILENAME /scripts$<span style="color: #a0522d;">fastcgi_script_name</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#33050;&#26412;&#36335;&#24452;</span>
  include fastcgi_params;
}
</pre>
</div>

<p>
缓存定义指令: 注意使用fastcgi缓存, 可能会导致源代码更新失败,生产慎用
</p>

<div class="org-src-container">
<pre class="src src-sh">fastcgi_cache_path path [<span style="color: #a0522d;">levels</span>=levels] [<span style="color: #a0522d;">use_temp_path</span>=on|off] <span style="color: #a0522d;">keys_zone</span>=name:size [<span style="color: #a0522d;">inactive</span>=time] [<span style="color: #a0522d;">max_size</span>=size] [<span style="color: #a0522d;">manager_files</span>=number] [<span style="color: #a0522d;">manager_sleep</span>=time] [<span style="color: #a0522d;">manager_threshold</span>=time] [<span style="color: #a0522d;">loader_files</span>=number] [<span style="color: #a0522d;">loader_sleep</span>=time] [<span style="color: #a0522d;">loader_threshold</span>=time] [<span style="color: #a0522d;">purger</span>=on|off] [<span style="color: #a0522d;">purger_files</span>=number] [<span style="color: #a0522d;">purger_sleep</span>=time] [<span style="color: #a0522d;">purger_threshold</span>=time];

&#23450;&#20041;fastcgi&#30340;&#32531;&#23384;&#65307;
    path <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32531;&#23384;&#20301;&#32622;&#20026;&#30913;&#30424;&#19978;&#30340;&#25991;&#20214;&#31995;&#32479;&#36335;&#24452;</span>
    <span style="color: #a0522d;">max_size</span>=size <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30913;&#30424;path&#36335;&#24452;&#20013;&#29992;&#20110;&#32531;&#23384;&#25968;&#25454;&#30340;&#32531;&#23384;&#31354;&#38388;&#19978;&#38480;</span>
    <span style="color: #a0522d;">levels</span>=levels&#65306;#&#21313;&#20845;&#36827;&#21046;&#30340;&#32531;&#23384;&#30446;&#24405;&#30340;&#23618;&#32423;&#25968;&#37327;&#65292;&#20197;&#21450;&#27599;&#19968;&#32423;&#30340;&#30446;&#24405;&#25968;&#37327;&#65292;<span style="color: #a0522d;">levels</span>=ONE:TWO:THREE&#65292;&#31034;&#20363;&#65306;<span style="color: #a0522d;">leves</span>=1:2:2
    <span style="color: #a0522d;">keys_zone</span>=name:size <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#32531;&#23384;&#21517;&#31216;&#21450;k/v&#26144;&#23556;&#30340;&#20869;&#23384;&#31354;&#38388;&#30340;&#21517;&#31216;&#21450;&#22823;&#23567;</span>
    <span style="color: #a0522d;">inactive</span>=time <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32531;&#23384;&#26377;&#25928;&#26102;&#38388;&#65292;&#40664;&#35748;10&#20998;&#38047;&#65292;&#38656;&#35201;&#22312;&#25351;&#23450;&#26102;&#38388;&#28385;&#36275;fastcgi_cache_min_uses &#27425;&#25968;&#34987;&#35270;&#20026;&#27963;&#21160;&#32531;&#23384;&#12290;</span>
</pre>
</div>

<p>
缓存调用指令：
</p>

<div class="org-src-container">
<pre class="src src-sh">fastcgi_cache zone | off;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35843;&#29992;&#25351;&#23450;&#30340;&#32531;&#23384;&#31354;&#38388;&#26469;&#32531;&#23384;&#25968;&#25454;&#65292;&#21487;&#29992;&#20301;&#32622;&#65306;http, server, location</span>

fastcgi_cache_key string;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#29992;&#20316;&#32531;&#23384;&#39033;&#30340;key&#30340;&#23383;&#31526;&#20018;&#65292;&#31034;&#20363;&#65306;fastcgi_cache_key $request_uri;</span>

fastcgi_cache_methods GET | HEAD | POST ...;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#21738;&#20123;&#35831;&#27714;&#26041;&#27861;&#20351;&#29992;&#32531;&#23384;</span>

fastcgi_cache_min_uses number;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32531;&#23384;&#31354;&#38388;&#20013;&#30340;&#32531;&#23384;&#39033;&#22312;inactive&#23450;&#20041;&#30340;&#38750;&#27963;&#21160;&#26102;&#38388;&#20869;&#33267;&#23569;&#35201;&#34987;&#35775;&#38382;&#21040;&#27492;&#22788;&#25152;&#25351;&#23450;&#30340;&#27425;&#25968;&#26041;&#21487;&#34987;&#35748;&#20316;&#27963;&#21160;&#39033;</span>

fastcgi_keep_conn on | off;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25910;&#21040;&#21518;&#31471;&#26381;&#21153;&#22120;&#21709;&#24212;&#21518;&#65292;fastcgi&#26381;&#21153;&#22120;&#26159;&#21542;&#20851;&#38381;&#36830;&#25509;&#65292;&#24314;&#35758;&#21551;&#29992;&#38271;&#36830;&#25509;</span>

fastcgi_cache_valid [code ...] time;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#21516;&#30340;&#21709;&#24212;&#30721;&#21508;&#33258;&#30340;&#32531;&#23384;&#26102;&#38271;</span>

fastcgi_hide_header field; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38544;&#34255;&#21709;&#24212;&#22836;&#25351;&#23450;&#20449;&#24687;</span>
fastcgi_pass_header field; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#21709;&#24212;&#22836;&#25351;&#23450;&#20449;&#24687;&#65292;&#40664;&#35748;&#19981;&#20250;&#23558;Status&#12289;X-Accel-...&#36820;&#22238;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:28e793f3-6cc6-48a6-b57a-d37bf3ef7ceb" class="outline-4">
<h4 id="h:28e793f3-6cc6-48a6-b57a-d37bf3ef7ceb">FastCGI示例&#x2013;Nginx与php-fpm在同一服务器</h4>
<div class="outline-text-4" id="text-h:28e793f3-6cc6-48a6-b57a-d37bf3ef7ceb">
<p>
php安装可以通过yum或者编译安装，使用yum安装相对比较简单，编译安装更方便自定义参数或选项。
</p>

<p>
说明：服务器压力不大时，nginx通常与php-fpm在同一服务器
</p>
</div>
<div id="outline-container-h:6f23ca40-b118-4ef7-bf3b-193b5e27ccb5" class="outline-5">
<h5 id="h:6f23ca40-b118-4ef7-bf3b-193b5e27ccb5">php环境准备</h5>
<div class="outline-text-5" id="text-h:6f23ca40-b118-4ef7-bf3b-193b5e27ccb5">
<p>
使用base源自带的php版本，<a href="https://www.php.net/docs.php">https://www.php.net/docs.php</a>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">yum&#23433;&#35013;&#40664;&#35748;&#29256;&#26412;php</span>
[root@s2 ~]# yum install php-fpm php-mysql -y <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#29256;&#26412;</span>
[root@s2 ~]# systemctl start php-fpm &amp;&amp; systemctl enable php-fpm
[root@s2 ~]# ps -ef | grep php-fpm
root   4925    1 0 17:13 ? 00:00:00 php-fpm: master process (/etc/phpfpm.conf)
apache 4927 4925 0 17:13 ? 00:00:00 php-fpm: pool www
apache 4928 4925 0 17:13 ? 00:00:00 php-fpm: pool www
apache 4929 4925 0 17:13 ? 00:00:00 php-fpm: pool www
apache 4930 4925 0 17:13 ? 00:00:00 php-fpm: pool www
apache 4931 4925 0 17:13 ? 00:00:00 php-fpm: pool www
root   4933 3235 0 17:13 pts/0 00:00:00 grep --color=auto php-fpm
</pre>
</div>
</div>
</div>
<div id="outline-container-h:274650b3-3111-4c33-a562-30c7ff618bfe" class="outline-5">
<h5 id="h:274650b3-3111-4c33-a562-30c7ff618bfe">php相关配置优化</h5>
<div class="outline-text-5" id="text-h:274650b3-3111-4c33-a562-30c7ff618bfe">
<div class="org-src-container">
<pre class="src src-sh">[root@s2 ~]# grep <span style="color: #8b2252;">"^[a-Z]"</span> /etc/php-fpm.conf
<span style="color: #a0522d;">include</span>=/etc/php-fpm.d/*.conf
pid = /run/php-fpm/php-fpm.pid
error_log = /var/log/php-fpm/error.log
daemonize = yes <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#21518;&#21488;&#21551;&#21160;</span>

[root@s2 ~]# cat /etc/php-fpm.d/www.conf
[www]
listen = 127.0.0.1:9000 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30417;&#21548;&#22320;&#22336;&#21450;IP</span>
listen.allowed_clients = 127.0.0.1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20801;&#35768;&#23458;&#25143;&#31471;&#20174;&#21738;&#20010;&#28304;IP&#22320;&#22336;&#35775;&#38382;&#65292;&#35201;&#20801;&#35768;&#25152;&#26377;&#34892;&#39318;&#21152; ;&#27880;&#37322;&#21363;&#21487;</span>
user = nginx <span style="color: #b22222;">#</span><span style="color: #b22222;">php-fpm&#21551;&#21160;&#30340;&#29992;&#25143;&#21644;&#32452;&#65292;&#20250;&#28041;&#21450;&#21040;&#21518;&#26399;&#25991;&#20214;&#30340;&#26435;&#38480;&#38382;&#39064;</span>
group = nginx
pm = dynamic <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21160;&#24577;&#27169;&#24335;&#36827;&#31243;&#31649;&#29702;</span>
pm.max_children = 500 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38745;&#24577;&#26041;&#24335;&#19979;&#24320;&#21551;&#30340;php-fpm&#36827;&#31243;&#25968;&#37327;&#65292;&#22312;&#21160;&#24577;&#26041;&#24335;&#19979;&#20182;&#38480;&#23450;php-fpm&#30340;&#26368;&#22823;&#36827;&#31243;&#25968;</span>
pm.start_servers = 100 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21160;&#24577;&#27169;&#24335;&#19979;&#21021;&#22987;&#36827;&#31243;&#25968;&#65292;&#24517;&#39035;&#22823;&#20110;&#31561;&#20110;pm.min_spare_servers&#21644;&#23567;&#20110;&#31561;&#20110;</span>
pm.max_children&#30340;&#20540;&#12290;
pm.min_spare_servers = 100 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#23567;&#31354;&#38386;&#36827;&#31243;&#25968;</span>
pm.max_spare_servers = 200 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#22823;&#31354;&#38386;&#36827;&#31243;&#25968;</span>
pm.max_requests = 500000 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36827;&#31243;&#32047;&#35745;&#35831;&#27714;&#22238;&#25910;&#20540;&#65292;&#20250;&#22238;&#25910;&#24182;&#37325;&#26032;&#29983;&#25104;&#26032;&#30340;&#23376;&#36827;&#31243;</span>
pm.status_path = /pm_status <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29366;&#24577;&#35775;&#38382;URL</span>
ping.path = /ping <span style="color: #b22222;">#</span><span style="color: #b22222;">ping&#35775;&#38382;&#21160;&#22320;&#22336;</span>
ping.response = ping-pong <span style="color: #b22222;">#</span><span style="color: #b22222;">ping&#36820;&#22238;&#20540;</span>
slowlog = /var/log/php-fpm/www-slow.log <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24930;&#26085;&#24535;&#36335;&#24452;</span>
php_admin_value[error_log] = /var/log/php-fpm/www-error.log <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38169;&#35823;&#26085;&#24535;</span>
php_admin_flag[log_errors] = on
php_value[session.save_handler] = files <span style="color: #b22222;">#</span><span style="color: #b22222;">phpsession&#20445;&#23384;&#26041;&#24335;&#21450;&#36335;&#24452;</span>
php_value[session.save_path] = /var/lib/php/session <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#26102;&#20351;&#29992;file&#20445;&#23384;session&#30340;&#25991;&#20214;&#36335;&#24452;</span>
</pre>
</div>

<p>
修改配置文件后记得重启php-fpm
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@s2 ~]# systemctl restart php-fpm
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c7b7c1b4-6c7a-4aba-b07f-6554ef7197c1" class="outline-5">
<h5 id="h:c7b7c1b4-6c7a-4aba-b07f-6554ef7197c1">准备php测试页面</h5>
<div class="outline-text-5" id="text-h:c7b7c1b4-6c7a-4aba-b07f-6554ef7197c1">
<div class="org-src-container">
<pre class="src src-sh">[root@s2 ~]# mkdir /data/nginx/php
[root@s2 ~]# cat /data/nginx/php/index.php <span style="color: #b22222;">#</span><span style="color: #b22222;">php&#27979;&#35797;&#39029;&#38754;</span>
&lt;?php
  phpinfo();
?&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b5b4e5d2-c4bb-4aba-a278-6aef8b8072dc" class="outline-5">
<h5 id="h:b5b4e5d2-c4bb-4aba-a278-6aef8b8072dc">Nginx配置转发</h5>
<div class="outline-text-5" id="text-h:b5b4e5d2-c4bb-4aba-a278-6aef8b8072dc">
<p>
Nginx安装完成之后默认生成了与fastcgi的相关配置文件，一般保存在nginx的安装路径的conf目录当中，比如/apps/nginx/conf/fastcgi.conf、/apps/nginx/conf/fastcgi_params。
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@s2 ~]# vim /apps/nginx/conf/conf.d/pc.conf <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#25351;&#23450;&#25991;&#20214;&#37197;&#32622;fastcgi</span>
location ~ <span style="color: #8b2252;">\.</span>php$ {
  root          /data/nginx/php; <span style="color: #b22222;">#</span><span style="color: #b22222;">$document_root&#35843;&#29992;root&#30446;&#24405;</span>
  fastcgi_pass  127.0.0.1:9000;
  fastcgi_index index.php;
  <span style="color: #b22222;">#</span><span style="color: #b22222;">fastcgi_param SCRIPT_FILENAME /data/nginx/php$fastcgi_script_name;</span>
  fastcgi_param SCRIPT_FILENAME $<span style="color: #a0522d;">document_root</span>$<span style="color: #a0522d;">fastcgi_script_name</span>;
  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;SCRIPT_FILENAME&#26159;&#32477;&#23545;&#36335;&#24452;&#21017;&#21487;&#20197;&#30465;&#30053;root /data/nginx/php;</span>
  include fastcgi_params;
}
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;Nginx&#24182;&#35775;&#38382;web&#27979;&#35797;</span>
systemctl restart nginx
</pre>
</div>
</div>
</div>
<div id="outline-container-h:207314d5-6b88-4447-af19-98a31e29be63" class="outline-5">
<h5 id="h:207314d5-6b88-4447-af19-98a31e29be63">访问验证php测试页</h5>
<div class="outline-text-5" id="text-h:207314d5-6b88-4447-af19-98a31e29be63">
<p>
浏览器访问
</p>

<div class="org-src-container">
<pre class="src src-sh">fastcgi_pass&#24120;&#35265;&#30340;&#38169;&#35823;&#65306;
File not found. <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36335;&#24452;&#19981;&#23545;</span>
502&#65306; php-fpm&#22788;&#29702;&#36229;&#26102;&#12289;&#26381;&#21153;&#20572;&#27490;&#36816;&#34892;&#31561;&#21407;&#22240;&#23548;&#33268;&#30340;&#26080;&#27861;&#36830;&#25509;&#25110;&#35831;&#27714;&#36229;&#26102;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1515df1d-63e0-4b13-b917-98d9be8e38da" class="outline-5">
<h5 id="h:1515df1d-63e0-4b13-b917-98d9be8e38da">php-fpm 的运行状态页面</h5>
<div class="outline-text-5" id="text-h:1515df1d-63e0-4b13-b917-98d9be8e38da">
<p>
访问配置文件里面指定的路径，会返回php-fpm的当前运行状态。
</p>

<p>
Nginx配置：
</p>

<div class="org-src-container">
<pre class="src src-sh">location ~ ^/(pm_status|ping)$ {
  <span style="color: #b22222;">#</span><span style="color: #b22222;">access_log off;</span>
  <span style="color: #b22222;">#</span><span style="color: #b22222;">allow 127.0.0.1;</span>
  <span style="color: #b22222;">#</span><span style="color: #b22222;">deny all;</span>
  include fastcgi_params;
  fastcgi_pass 127.0.0.1:9000;
  fastcgi_param PATH_TRANSLATED $<span style="color: #a0522d;">document_root</span>$<span style="color: #a0522d;">fastcgi_script_name</span>;
}
</pre>
</div>

<p>
重启Nginx并测试：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@Centos7 ~]#curl http://www.cici.net/pm_status
pool:                 www
process manager:      dynamic
start time:           21/Jul/2020:16:58:35 +0800
start since:          42
accepted conn:        2
listen queue:         0
max listen queue:     0
listen queue len:     128
idle processes:       4
active processes:     1
total processes:      5
max active processes: 1
max children reached: 0
slow requests:        0
[root@Centos7 ~]#curl http://www.cici.net/ping
pong
[root@Centos7 ~]#curl http://www.cici.net/pm_status?full
pool:                 www
process manager:      dynamic
start time:           21/Jul/2020:16:58:35 +0800
start since:          85
accepted conn:        4
listen queue:         0
max listen queue:     0
listen queue len:     128
idle processes:       4
active processes:     1
total processes:      5
max active processes: 1
max children reached: 0
slow requests:        0

************************
pid:                  2099
state:                Idle
start time:           21/Jul/2020:16:58:35 +0800
start since:          85
requests:             1
request duration:     393
request method:       GET
request URI:          /pm_status
content length:       0
user:                 -
script:               -
last request cpu:     0.00
last request memory:  262144

************************
pid:                  2100
state:                Idle
start time:           21/Jul/2020:16:58:35 +0800
start since:          85
requests:             0
request duration:     0
request method:       -
request URI:          -
content length:       0
user:                 -
script:               -
last request cpu:     0.00
last request memory:  0

************************
pid:                  2101
state:                Idle
start time:           21/Jul/2020:16:58:35 +0800
start since:          85
requests:             1
request duration:     301
request method:       GET
request URI:          /pm_status
content length:       0
user:                 -
script:               -
last request cpu:     0.00
last request memory:  262144

************************
pid:                  2102
state:                Running
start time:           21/Jul/2020:16:58:35 +0800
start since:          85
requests:             1
request duration:     477
request method:       GET
request URI:          /pm_status?full
content length:       0
user:                 -
script:               -
last request cpu:     0.00
last request memory:  0

************************
pid:                  2103
state:                Idle
start time:           21/Jul/2020:16:58:35 +0800
start since:          85
requests:             1
request duration:     242
request method:       GET
request URI:          /ping
content length:       0
user:                 -
script:               -
last request cpu:     0.00
last request memory:  262144

[root@Centos7 ~]#curl http://www.cici.net/pm_status?html
&lt;!DOCTYPE html PUBLIC <span style="color: #8b2252;">"-//W3C//DTD XHTML 1.0 Strict//EN"</span> <span style="color: #8b2252;">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"</span>&gt;
&lt;html <span style="color: #a0522d;">xmlns</span>=<span style="color: #8b2252;">"http://www.w3.org/1999/xhtml"</span> xml:<span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span> <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
&lt;head&gt;&lt;title&gt;PHP-FPM Status Page&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;table&gt;
&lt;tr&gt;&lt;th&gt;pool&lt;/th&gt;&lt;td&gt;www&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;th&gt;process manager&lt;/th&gt;&lt;td&gt;dynamic&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;th&gt;start time&lt;/th&gt;&lt;td&gt;21/Jul/2020:16:58:35 +0800&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;th&gt;start since&lt;/th&gt;&lt;td&gt;116&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;th&gt;accepted conn&lt;/th&gt;&lt;td&gt;5&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;th&gt;listen queue&lt;/th&gt;&lt;td&gt;0&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;th&gt;max listen queue&lt;/th&gt;&lt;td&gt;0&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;th&gt;listen queue len&lt;/th&gt;&lt;td&gt;128&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;th&gt;idle processes&lt;/th&gt;&lt;td&gt;4&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;th&gt;active processes&lt;/th&gt;&lt;td&gt;1&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;th&gt;total processes&lt;/th&gt;&lt;td&gt;5&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;th&gt;max active processes&lt;/th&gt;&lt;td&gt;1&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;th&gt;max children reached&lt;/th&gt;&lt;td&gt;0&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;th&gt;slow requests&lt;/th&gt;&lt;td&gt;0&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;
&lt;/body&gt;&lt;/html&gt;

[root@Centos7 ~]#curl http://www.cici.net/pm_status?json
{<span style="color: #8b2252;">"pool"</span>:<span style="color: #8b2252;">"www"</span>,<span style="color: #8b2252;">"process manager"</span>:<span style="color: #8b2252;">"dynamic"</span>,<span style="color: #8b2252;">"start time"</span>:1595321915,<span style="color: #8b2252;">"start since"</span>:147,<span style="color: #8b2252;">"accepted conn"</span>:6,<span style="color: #8b2252;">"listen queue"</span>:0,<span style="color: #8b2252;">"max listen queue"</span>:0,<span style="color: #8b2252;">"listen queue len"</span>:128,<span style="color: #8b2252;">"idle processes"</span>:4,<span style="color: #8b2252;">"active processes"</span>:1,<span style="color: #8b2252;">"total processes"</span>:5,<span style="color: #8b2252;">"max active processes"</span>:1,<span style="color: #8b2252;">"max children reached"</span>:0,<span style="color: #8b2252;">"slow requests"</span>:0}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:2117b09c-df2a-4d80-9df7-6addd73d622b" class="outline-4">
<h4 id="h:2117b09c-df2a-4d80-9df7-6addd73d622b">FastCGI示例&#x2013;Nginx与php不在同一个服务器</h4>
<div class="outline-text-4" id="text-h:2117b09c-df2a-4d80-9df7-6addd73d622b">
<p>
nginx会处理静态请求，但是会转发动态请求到后端指定的php-fpm服务器，因此代码也需要放在后端的php-fpm服务器，即静态页面放在Nginx上而动态页面放在后端php-fpm服务器，正常情况下，一般都是采用6.3.2的部署方式。
</p>
</div>
<div id="outline-container-h:5c765d92-8180-4b98-8658-772a97c940e6" class="outline-5">
<h5 id="h:5c765d92-8180-4b98-8658-772a97c940e6">yum安装较新版本php-fpm</h5>
<div class="outline-text-5" id="text-h:5c765d92-8180-4b98-8658-772a97c940e6">
<div class="org-src-container">
<pre class="src src-sh">[root@s4 ~]# rpm -ivh https://mirrors.tuna.tsinghua.edu.cn/remi/enterprise/remi-release-7.rpm
[root@nginx-web2 ~]#yum install https://mirrors.tuna.tsinghua.edu.cn/remi/enterprise/remi-release-7.rpm
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21253;&#21547;&#36739;&#26032;&#30340;PHP&#31561;&#36719;&#20214;&#21253;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">[root@s4 ~]# yum install php56-php-fpm php56-php-mysql -y #&#23433;&#35013;&#25351;&#23450;&#29256;&#26412;&#30340;php</span>
[root@nginx-web2 ~]#yum install php72-php-fpm php72-php-mysql -y
&#39564;&#35777;&#23433;&#35013;&#36335;&#24452;&#65306;
[root@nginx-web2 ~]#rpm -ql php72-php-fpm
/etc/logrotate.d/php72-php-fpm
/etc/opt/remi/php72/php-fpm.conf
/etc/opt/remi/php72/php-fpm.d
/etc/opt/remi/php72/php-fpm.d/www.conf
/etc/opt/remi/php72/sysconfig/php-fpm
/etc/systemd/system/php72-php-fpm.service.d
/opt/remi/php72/root/usr/sbin/php-fpm
......
/var/opt/remi/php72/run/php-fpm

&#29983;&#25104;php72&#37197;&#32622;&#25991;&#20214;&#65306;
[root@s4 ~]# cp /opt/remi/php72/root/usr/share/doc/php72-php-common-7.2.24/php.iniproduction /opt/remi/php72/root/usr/etc/php.ini

[root@s4 ~]# cp /opt/remi/php72/root/usr/share/doc/php72-php-fpm-7.2.24/phpfpm.conf.default /opt/remi/php72/root/usr/etc//php-fpm.conf
</pre>
</div>
</div>
</div>
<div id="outline-container-h:67f2b7d3-e423-415a-b514-3b4c8d6b3cb9" class="outline-5">
<h5 id="h:67f2b7d3-e423-415a-b514-3b4c8d6b3cb9">修改php-fpm监听配置</h5>
<div class="outline-text-5" id="text-h:67f2b7d3-e423-415a-b514-3b4c8d6b3cb9">
<p>
php-fpm默认监听在127.0.0.1的9000端口，也就是无法远程连接，因此要做相应的修改。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">php56&#20462;&#25913;&#30417;&#21548;&#37197;&#32622;</span>
[root@s4 ~]# vim /opt/remi/php56/root/etc/php-fpm.d/www.conf
listen = 10.0.0.27:9000 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#30417;&#21548;IP</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">listen.allowed_clients = 127.0.0.1 #&#27880;&#37322;&#36816;&#34892;&#30340;&#23458;&#25143;&#31471;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">php72&#20462;&#25913;&#30417;&#21548;&#37197;&#32622;</span>
[root@nginx-web2 ~]#vim /etc/opt/remi/php72/php-fpm.d/www.conf
user = nginx
group = nginx
listen = 10.0.0.27:9000
; listen.allowed_clients = 127.0.0.1
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ec429cb7-92ea-4b34-92ce-2a982d0fd336" class="outline-5">
<h5 id="h:ec429cb7-92ea-4b34-92ce-2a982d0fd336">准备php测试页面</h5>
<div class="outline-text-5" id="text-h:ec429cb7-92ea-4b34-92ce-2a982d0fd336">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20934;&#22791;php&#25968;&#25454;&#30446;&#24405;</span>
[root@s4 ~]# mkdir /data/nginx/php -p
[root@s4 ~]# vim /data/nginx/php/index.php
&lt;?php
  phpinfo();
?&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fc12ec5a-b4ec-4c0d-81af-31b9f3aaa6c1" class="outline-5">
<h5 id="h:fc12ec5a-b4ec-4c0d-81af-31b9f3aaa6c1">启动并验证php-fpm</h5>
<div class="outline-text-5" id="text-h:fc12ec5a-b4ec-4c0d-81af-31b9f3aaa6c1">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;php-fpm56</span>
[root@s4 ~]# systemctl start php56-php-fpm
[root@s4 ~]# systemctl enable php56-php-fpm
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;php-fpm72</span>
[root@s4 ~]# systemctl start php72-php-fpm
[root@s4 ~]# systemctl enable php56-php-fpm
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;php-fpm&#36827;&#31243;&#21450;&#31471;&#21475;&#65306;</span>
[root@s4 ~]# ps -ef | grep php-fpm
[root@nginx-web2 ~]#ps -ef |grep php
root       1910      1  0 20:24 ?        00:00:00 php-fpm: master process (/etc/opt/remi/php72/php-fpm.conf)
nginx      1911   1910  0 20:24 ?        00:00:00 php-fpm: pool www
nginx      1912   1910  0 20:24 ?        00:00:00 php-fpm: pool www
nginx      1913   1910  0 20:24 ?        00:00:00 php-fpm: pool www
nginx      1914   1910  0 20:24 ?        00:00:00 php-fpm: pool www
nginx      1915   1910  0 20:24 ?        00:00:00 php-fpm: pool www
root       1917   1009  0 20:24 pts/0    00:00:00 grep --color=auto php
[root@s4 ~]# ss -tnl | grep 9000
LISTEN 0 128 127.0.0.1:9000 *:*
[root@s4 ~]# netstat -tuanlp | grep 9000
tcp 0 0 127.0.0.1:9000 0.0.0.0:* LISTEN 5339/php-fpm: maste
</pre>
</div>
</div>
</div>
<div id="outline-container-h:79251e84-ccf1-45ea-9270-74f9ff7b862b" class="outline-5">
<h5 id="h:79251e84-ccf1-45ea-9270-74f9ff7b862b">Nginx配置转发</h5>
<div class="outline-text-5" id="text-h:79251e84-ccf1-45ea-9270-74f9ff7b862b">
<div class="org-src-container">
<pre class="src src-sh">location ~ <span style="color: #8b2252;">\.</span>php$ {
  root /data/nginx/php;
  fastcgi_pass 10.0.0.27:9000;
  fastcgi_index index.php;
  <span style="color: #b22222;">#</span><span style="color: #b22222;">fastcgi_param SCRIPT_FILENAME /data/php$fastcgi_script_name;</span>
  fastcgi_param SCRIPT_FILENAME $<span style="color: #a0522d;">document_root</span>$<span style="color: #a0522d;">fastcgi_script_name</span>;
  include fastcgi_params;
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;nginx</span>
[root@s2 ~]# systemctl restart nginx
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e00a769b-25f1-478d-be07-d878f0fcf0be" class="outline-5">
<h5 id="h:e00a769b-25f1-478d-be07-d878f0fcf0be">访问验证php测试页面：</h5>
<div class="outline-text-5" id="text-h:e00a769b-25f1-478d-be07-d878f0fcf0be">
<p>
php 56:
</p>


<p>
php72:
</p>
</div>
</div>
</div>
<div id="outline-container-h:9e593c84-bd1a-4d6b-9855-cae40d477a7c" class="outline-4">
<h4 id="h:9e593c84-bd1a-4d6b-9855-cae40d477a7c">http 499 问题</h4>
<div class="outline-text-4" id="text-h:9e593c84-bd1a-4d6b-9855-cae40d477a7c">
<p>
查看 <a href="https://datatracker.ietf.org/doc/html/rfc7231#section-8.2.3">HTTP status code</a> 并没有发现 499 定义。
</p>

<p>
在 <a href="https://github.com/nginx/nginx">nginx</a> 源代码 <code>src/http/ngx_http_special_response.c</code> 文件中对 499 状态码进行了定义：
</p>

<pre class="example" id="orgdc04cc4">
#define NGX_HTTP_OFF_5XX   (NGX_HTTP_LAST_4XX - 400 + NGX_HTTP_OFF_4XX)

    ngx_string(ngx_http_error_494_page), /* 494, request header too large */
    ngx_string(ngx_http_error_495_page), /* 495, https certificate error */
    ngx_string(ngx_http_error_496_page), /* 496, https no certificate */
    ngx_string(ngx_http_error_497_page), /* 497, http to https */
    ngx_string(ngx_http_error_404_page), /* 498, canceled */
    ngx_null_string,                     /* 499, client has closed connection */
</pre>

<p>
看到 499 表示 <code>客户端主动断开连接</code> 。
</p>

<p>
而在实际业务中，当出现 HTTP 499 状态码时，大部分都是由于服务端请求时间过长，导致客户端等待超时，因此断开了连接。
</p>

<ul class="org-ul">
<li><p>
服务端接口请求超时
</p>

<p>
如请求接口时 sql 全表扫描，客户端超时等待。
</p>

<p>
解决：优化接口
</p></li>

<li><p>
nginx 主动断开连接
</p>

<p>
如 nginx 认为过快的 post 请求不安全，主动断开连接。
</p>

<p>
解决： 配置文件追加 <code>proxy_ignore_client_abort   on;</code> 。意思是 proxy 忽略客户端的中断，一直等待着代理服务器的返回，如果没有执行错误，则记录的日志是 200 日志，如果执行超时，记录的日志是 504 日志。缺点：当客户端断开连接之后，服务器仍然会继续执行，存在着拖垮服务器的风险。所以线上业务要根据情况合理使用。
</p></li>

<li><p>
固定时间出现 499 问题
</p>

<p>
可能某一资源被拖垮的连锁反应。排查 crontab 脚本、服务器、数据库、error.lg、SQL slow.log
</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-h:2c2e09a8-34c6-4049-85d7-9fd1871e3b17" class="outline-2">
<h2 id="h:2c2e09a8-34c6-4049-85d7-9fd1871e3b17">nginx 二次开发版本</h2>
<div class="outline-text-2" id="text-h:2c2e09a8-34c6-4049-85d7-9fd1871e3b17">
</div>
<div id="outline-container-h:84d041c9-6d19-4144-8150-eba4e7d49cdc" class="outline-3">
<h3 id="h:84d041c9-6d19-4144-8150-eba4e7d49cdc">Tengine</h3>
<div class="outline-text-3" id="text-h:84d041c9-6d19-4144-8150-eba4e7d49cdc">
<p>
官网：<a href="http://tengine.taobao.org/">http://tengine.taobao.org/</a>
</p>

<pre class="example" id="orgda4fc70">
继承Nginx-1.16.0的所有特性，兼容nginx的配置
支持HTTP的CONNECT方法，可用于正向代理场景
支持异步OpenSSL，可使用硬件如:QAT进行HTTPS的加速与卸载
增强相关运维、监控能力,比如异步打印日志及回滚,本地DNS缓存,内存监控等
Stream模块支持server_name指令
更加强大的负载均衡能力，包括一致性hash模块、会话保持模块，还可以对后端的服务器进行主动健康检查，
根据服务器状态自动上线下线，以及动态解析upstream中出现的域名
输入过滤器机制支持。通过使用这种机制Web应用防火墙的编写更为方便
支持设置proxy、memcached、fastcgi、scgi、uwsgi在后端失败时的重试次数
动态脚本语言Lua支持。扩展功能非常高效简单
支持按指定关键字(域名，url等)收集Tengine运行状态
组合多个CSS、JavaScript文件的访问请求变成一个请求
自动去除空白字符和注释从而减小页面的体积
自动根据CPU数目设置进程个数和绑定CPU亲缘性;
监控系统的负载和资源占用从而对系统进行保护
显示对运维人员更友好的出错信息，便于定位出错机器
更强大的防攻击（访问速度限制）模块
更方便的命令行参数，如列出编译的模块列表、支持的指令等
可以根据访问文件类型设置过期时间
</pre>
</div>
<div id="outline-container-h:38443cb0-6929-4713-b5ca-ee07cc91dc85" class="outline-4">
<h4 id="h:38443cb0-6929-4713-b5ca-ee07cc91dc85">动态模块</h4>
<div class="outline-text-4" id="text-h:38443cb0-6929-4713-b5ca-ee07cc91dc85">
<p>
<a href="http://tengine.taobao.org/document_cn/dso_cn.html">http://tengine.taobao.org/document_cn/dso_cn.html</a>
</p>

<p>
这个模块主要是用来运行时动态加载模块，而不用每次都要重新编译Tengine.
</p>

<p>
如果你想要编译官方模块为动态模块，你需要在configure的时候加上类似这样
的指令(&#x2013;withhttp_xxx_module),./configure &#x2013;help可以看到更多的细节.
</p>

<p>
如果只想要安装官方模块为动态模块(不安装Nginx)，那么就只需要configure之
后，执行make dso_install命令.动态加载模块的个数限制为128个.
</p>

<p>
如果已经加载的动态模块有修改，那么必须重起Tengine才会生效.
</p>

<p>
只支持HTTP模块.
</p>

<p>
模块 在Linux/FreeeBSD/MacOS下测试成功.
</p>

<p>
编译安装 tengine-2.1.2 注意: 不支持CentOS8
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#yum -y install gcc pcre-devel openssl-devel
[root@centos7 ~]#useradd -r nginx
[root@centos7 ~]#cd /usr/local/src
[root@centos7 src]#wget http://tengine.taobao.org/download/tengine-2.1.2.tar.gz
[root@centos7 src]#tar xf tengine-2.1.2.tar.gz
[root@centos7 src]#cd tengine-2.1.2/
[root@nginx-web1 tengine-2.1.2]#./configure --prefix=/apps/tengine-2.1.2 --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre  --add-module=/usr/local/src/echo-nginx-module


<span style="color: #b22222;"># </span><span style="color: #b22222;">make &amp;&amp; make install</span>
</pre>
</div>

<p>
在tengine-2.1.2中添加 lua 动态模块
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">yum install lua lua-devel</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">./configure --help | grep shared</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">./configure --prefix=/apps/tengine-2.1.2 --user=nginx --group=nginx --withhttp_ssl_module --with-http_v2_module --with-http_realip_module --withhttp_stub_status_module --with-http_gzip_static_module --with-pcre --withhttp_lua_module=shared</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">make dso_install</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">ll /apps/tengine-2.1.2/modules/ngx_http_lua_module.so</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">vim /apps/tengine-2.1.2/conf/nginx.conf</span>
worker_processes 1;

dso {
  load ngx_http_lua_module.so;
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">/apps/tengine-2.1.2/sbin/nginx -t</span>
the configuration file /apps/tengine-2.1.2/conf/nginx.conf syntax is ok
configuration file /apps/tengine-2.1.2/conf/nginx.conf test is successful
</pre>
</div>

<p>
编译安装 tengine-2.3.2  centos8
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">wget http://tengine.taobao.org/download/tengine-2.3.2.tar.gz</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">tar xvf tengine-2.3.2.tar.gz</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">cd tengine-2.3.2/</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">/apps/nginx/sbin/nginx -V #&#22914;&#26524;&#38656;&#35201;&#20860;&#23481;Nginx&#21017;&#20351;&#29992;&#20043;&#21069;Nginx&#30340;&#32534;&#35793;&#21442;&#25968;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">./configure --prefix=/apps/tengine-2.3.2 --user=nginx --group=nginx --withhttp_ssl_module --with-http_v2_module --with-http_realip_module --withhttp_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">make</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">make install</span>

[root@centos8 tengine-2.3.2]#ln -s /apps/tengine-2.3.2/sbin/* /usr/sbin/
[root@centos8 tengine-2.3.2]#nginx -v
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a8af020d-67bb-4a39-8c81-b27ad2500534" class="outline-4">
<h4 id="h:a8af020d-67bb-4a39-8c81-b27ad2500534">concat模块使用：</h4>
<div class="outline-text-4" id="text-h:a8af020d-67bb-4a39-8c81-b27ad2500534">
<p>
网站中的css、js等文件都是小文件，单个文件大小几k甚至几个字节，所以文件的特点是小而多，会造成网站加载时http请求较多，且网络传输时间比较短，甚至有时候请求时间比传输时间还长，当公司网站中的这类小文件很多时，大量的http请求就会造成传输效率低，影响网站的访问速度和客户端体验，这时合并http请求就非常有必要了，concat模块就提供了合并文件http请求的功能，这个模块由淘宝开发，功能和apache的mod_concat模块类似。
</p>

<p>
Tengine-2.1.2 concat模块使用： <a href="https://tengine.taobao.org/document_cn/http_concat_cn.html">https://tengine.taobao.org/document_cn/http_concat_cn.html</a>
</p>

<p>
访问方式
</p>
<pre class="example" id="orgfa28836">
请求参数需要用两个问号（'??'）例如：
http://example.com/??style1.css,style2.css,foo/style3.css

参数中某位置只包含一个‘?’，则'?'后表示文件的版本，例如：
http://example.com/??style1.css,style2.css,foo/style3.css?v=102234
</pre>

<p>
编译安装 concat 模块
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">tengine-2.1.2&#26377;&#27492;&#27169;&#22359;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">./configure --help |grep http_concat</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">./configure --prefix=/apps/tengine --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-file-aio --with-http_concat_module=shared --withhttp_lua_module=shared</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">make dso_install</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;&#21160;&#24577;&#27169;&#22359;&#23454;&#29616;concat&#21151;&#33021;&#65306;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">vim /apps/tenginx/conf/nginx.conf</span>
worker_processes 1;
<span style="color: #b22222;">#</span><span style="color: #b22222;">error_log logs/error.log info;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">pid logs/nginx.pid;</span>

dso {
    load ngx_http_lua_module.so;
    load ngx_http_concat_module.so;
}

<span style="color: #b22222;">#</span><span style="color: #b22222;">/apps/tengine/sbin/nginx -t</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">/apps/tengine/sbin/nginx -s reload</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;&#37325;&#26032;&#32534;&#35793;tengine&#23454;&#29616;concat&#21151;&#33021;&#65306;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#32534;&#35793;&#33267;tengine</span>
--with-http_concat_module
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8d1d8882-e696-4f35-92cc-73458cdad99f" class="outline-4">
<h4 id="h:8d1d8882-e696-4f35-92cc-73458cdad99f">tengine配置文件：</h4>
<div class="outline-text-4" id="text-h:8d1d8882-e696-4f35-92cc-73458cdad99f">
<p>
兼容Nginx指定版本的配置参数
</p>

<div class="org-src-container">
<pre class="src src-sh">pc.conf&#37197;&#32622;&#25991;&#20214;&#65306;
<span style="color: #b22222;"># </span><span style="color: #b22222;">cat /apps/tenginx/conf/conf.d/pc.conf</span>
server {
  listen 80;
  server_name www.cici.net *.www.cici.net pc.cici.net;
  aio on;
  location / {
    concat on;
    root html;
    index index.html index.htm;
  }

  location ~ <span style="color: #8b2252;">\.</span>php$ {
    root /data/nginx/php;
    fastcgi_pass 172.18.0.202:9000;
    fastcgi_index index.php;
    <span style="color: #b22222;">#</span><span style="color: #b22222;">fastcgi_param SCRIPT_FILENAME /data/nginx/php$fastcgi_script_name;</span>
    fastcgi_param SCRIPT_FILENAME $<span style="color: #a0522d;">document_root</span>$<span style="color: #a0522d;">fastcgi_script_name</span>;
    include fastcgi_params;
  }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c6f9bfee-967f-4ae2-b8b5-c9a5e57ba5fe" class="outline-4">
<h4 id="h:c6f9bfee-967f-4ae2-b8b5-c9a5e57ba5fe">基于tengine的wordpress站点：</h4>
<div class="outline-text-4" id="text-h:c6f9bfee-967f-4ae2-b8b5-c9a5e57ba5fe">
</div>
</div>
</div>
<div id="outline-container-h:dc6abc4d-3218-4d4b-aeec-d225452fbe31" class="outline-3">
<h3 id="h:dc6abc4d-3218-4d4b-aeec-d225452fbe31">openresty</h3>
<div class="outline-text-3" id="text-h:dc6abc4d-3218-4d4b-aeec-d225452fbe31">
<p>
<a href="http://openresty.org/cn/">http://openresty.org/cn/</a>
</p>

<p>
Nginx 是俄罗斯人发明的， Lua 是巴西几个教授发明的，中国人章亦春把
LuaJIT VM 嵌入到 Nginx中，实现了 OpenResty 这个高性能服务端解决方案
</p>

<p>
OpenResty® 是一个基于 Nginx 与 Lua 的高性能 Web平台，其内部集成了大量
精良的 Lua库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高
并发、扩展性极高的动态Web 应用、Web 服务和动态网关。
</p>

<p>
OpenResty® 通过汇聚各种设计精良的 Nginx 模块（主要由 OpenResty团队自主
开发），从而将 Nginx 有效地变成一个强大的通用 Web应用平台。这样，Web
开发人员和系统工程师可以使用 Lua 脚本语言调动 Nginx支持的各种 C 以及
Lua 模块，快速构造出足以胜任 10K 乃至 1000K以上单机并发连接的高性能
Web 应用系统。
</p>

<p>
OpenResty® 的目标是让你的Web服务直接跑在 Nginx 服务内部，充分利用
Nginx的非阻塞 I/O 模型，不仅仅对HTTP 客户端请求,甚至于对远程后端诸如
MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致的高性能响应。
</p>

<p>
编译安装 openresty
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dnf -yq install gcc pcre-devel openssl-devel
[root@centos8 ~]#useradd -r -s /sbin/nologin nginx

<span style="color: #b22222;"># </span><span style="color: #b22222;">cd /usr/local/src</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">wget https://openresty.org/download/openresty-1.15.8.2.tar.gz</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">tar xf openresty-1.15.8.2.tar.gz</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">cd openresty-1.15.8.2/</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">./configure --prefix=/apps/openresty --user=nginx --group=nginx --withhttp_ssl_module --with-http_v2_module --with-http_realip_module --withhttp_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">make &amp;&amp; make install</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">ll /apps/openresty/</span>
total 280
drwxr-xr-x 8 root root 4096 Jan 8 08:44 ./
drwxr-xr-x 5 root root 4096 Jan 8 08:44 ../
drwxr-xr-x 2 root root 4096 Jan 8 08:44 bin/
-rw-r--r-- 1 root root 22924 Jan 8 08:44 COPYRIGHT
drwxr-xr-x 6 root root 4096 Jan 8 08:44 luajit/
drwxr-xr-x 6 root root 4096 Jan 8 08:44 lualib/
drwxr-xr-x 6 root root 4096 Jan 8 08:44 nginx/
drwxr-xr-x 47 root root 4096 Jan 8 08:44 pod/
-rw-r--r-- 1 root root 226755 Jan 8 08:44 resty.index
drwxr-xr-x 5 root root 4096 Jan 8 08:44 site/

<span style="color: #b22222;"># </span><span style="color: #b22222;">/apps/openresty/bin/openresty</span>
</pre>
</div>

<p>
如果编译时，有 <code>undefined reference to `SSL_get_client_random'</code> 报错，通过如下方法解决
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#36733;openssl&#28304;&#30721;&#21040; /path &#30446;&#24405;&#19979;</span>
./configure --with-openssl=/path/openssl-3.0.15
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:83fa6e46-73b0-441d-b602-8b13a50ebc21" class="outline-2">
<h2 id="h:83fa6e46-73b0-441d-b602-8b13a50ebc21">系统参数优化</h2>
<div class="outline-text-2" id="text-h:83fa6e46-73b0-441d-b602-8b13a50ebc21">
</div>
<div id="outline-container-h:f0a8a954-351a-46c4-a462-fac12e4b95e7" class="outline-3">
<h3 id="h:f0a8a954-351a-46c4-a462-fac12e4b95e7">系统参数优化</h3>
<div class="outline-text-3" id="text-h:f0a8a954-351a-46c4-a462-fac12e4b95e7">
<p>
默认的Linux内核参数考虑的是最通用场景，不符合用于支持高并发访问的Web服务器的定义，根据业务特点来进行调整，当Nginx作为静态web内容服务器、反向代理或者提供压缩服务器的服务器时，内核参数的调整都是不同的，此处针对最通用的、使Nginx支持更多并发请求的TCP网络参数做简单的配置
</p>
</div>
<div id="outline-container-h:7797ab78-8e94-4db6-aee3-767396b3804e" class="outline-4">
<h4 id="h:7797ab78-8e94-4db6-aee3-767396b3804e">优化内核参数</h4>
<div class="outline-text-4" id="text-h:7797ab78-8e94-4db6-aee3-767396b3804e">
<p>
修改/etc/sysctl.conf
</p>
<div class="org-src-container">
<pre class="src src-sh">fs.file-max = 1000000
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#34920;&#31034;&#21333;&#20010;&#36827;&#31243;&#36739;&#22823;&#21487;&#20197;&#25171;&#24320;&#30340;&#21477;&#26564;&#25968;</span>

net.ipv4.tcp_tw_reuse = 1
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#25968;&#35774;&#32622;&#20026; 1 &#65292;&#34920;&#31034;&#20801;&#35768;&#23558;TIME_WAIT&#29366;&#24577;&#30340;socket&#37325;&#26032;&#29992;&#20110;&#26032;&#30340;TCP&#38142;&#25509;&#65292;&#36825;&#23545;&#20110;&#26381;&#21153;&#22120;&#26469;&#35828;&#24847;&#20041;&#37325;&#22823;&#65292;&#22240;&#20026;&#24635;&#26377;&#22823;&#37327;TIME_WAIT&#29366;&#24577;&#30340;&#38142;&#25509;&#23384;&#22312;</span>

net.ipv4.tcp_keepalive_time = 600
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;keepalive&#21551;&#21160;&#26102;&#65292;TCP&#21457;&#36865;keepalive&#28040;&#24687;&#30340;&#39057;&#24230;;&#40664;&#35748;&#26159;2&#23567;&#26102;&#65292;&#23558;&#20854;&#35774;&#32622;&#20026;10&#20998;&#38047;&#65292;&#21487;&#26356;&#24555;&#30340;&#28165;&#29702;&#26080;&#25928;&#38142;&#25509;</span>

net.ipv4.tcp_fin_timeout = 30
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#26381;&#21153;&#22120;&#20027;&#21160;&#20851;&#38381;&#38142;&#25509;&#26102;&#65292;socket&#20445;&#25345;&#22312;FIN_WAIT_2&#29366;&#24577;&#30340;&#36739;&#22823;&#26102;&#38388;</span>

net.ipv4.tcp_max_tw_buckets = 5000
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#34920;&#31034;&#25805;&#20316;&#31995;&#32479;&#20801;&#35768;TIME_WAIT&#22871;&#25509;&#23383;&#25968;&#37327;&#30340;&#36739;&#22823;&#20540;&#65292;&#22914;&#36229;&#36807;&#27492;&#20540;&#65292;TIME_WAIT&#22871;&#25509;&#23383;&#23558;&#31435;&#21051;&#34987;&#28165;&#38500;&#24182;&#25171;&#21360;&#35686;&#21578;&#20449;&#24687;,&#40664;&#35748;&#20026;8000&#65292;&#36807;&#22810;&#30340;TIME_WAIT&#22871;&#25509;&#23383;&#20250;&#20351;Web&#26381;&#21153;&#22120;&#21464;&#24930;</span>

net.ipv4.ip_local_port_range = 1024 65000
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;UDP&#21644;TCP&#38142;&#25509;&#30340;&#26412;&#22320;&#31471;&#21475;&#30340;&#21462;&#20540;&#33539;&#22260;</span>

net.ipv4.tcp_rmem = 10240 87380 12582912
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#20102;TCP&#25509;&#21463;&#32531;&#23384;&#30340;&#26368;&#23567;&#20540;&#12289;&#40664;&#35748;&#20540;&#12289;&#36739;&#22823;&#20540;</span>

net.ipv4.tcp_wmem = 10240 87380 12582912
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;TCP&#21457;&#36865;&#32531;&#23384;&#30340;&#26368;&#23567;&#20540;&#12289;&#40664;&#35748;&#20540;&#12289;&#36739;&#22823;&#20540;</span>

net.core.netdev_max_backlog = 8096
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#32593;&#21345;&#25509;&#25910;&#25968;&#25454;&#21253;&#30340;&#36895;&#24230;&#22823;&#20110;&#20869;&#26680;&#22788;&#29702;&#36895;&#24230;&#26102;&#65292;&#20250;&#26377;&#19968;&#20010;&#21015;&#38431;&#20445;&#23384;&#36825;&#20123;&#25968;&#25454;&#21253;&#12290;&#36825;&#20010;&#21442;&#25968;&#34920;&#31034;&#35813;&#21015;&#38431;&#30340;&#36739;&#22823;&#20540;</span>

net.core.rmem_default = 6291456
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#34920;&#31034;&#20869;&#26680;&#22871;&#25509;&#23383;&#25509;&#21463;&#32531;&#23384;&#21306;&#40664;&#35748;&#22823;&#23567;</span>

net.core.wmem_default = 6291456
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#34920;&#31034;&#20869;&#26680;&#22871;&#25509;&#23383;&#21457;&#36865;&#32531;&#23384;&#21306;&#40664;&#35748;&#22823;&#23567;</span>

net.core.rmem_max = 12582912
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#34920;&#31034;&#20869;&#26680;&#22871;&#25509;&#23383;&#25509;&#21463;&#32531;&#23384;&#21306;&#36739;&#22823;&#22823;&#23567;</span>

net.core.wmem_max = 12582912
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#34920;&#31034;&#20869;&#26680;&#22871;&#25509;&#23383;&#21457;&#36865;&#32531;&#23384;&#21306;&#36739;&#22823;&#22823;&#23567;</span>

&#27880;&#24847;&#65306;&#20197;&#19978;&#30340;&#22235;&#20010;&#21442;&#25968;&#65292;&#38656;&#35201;&#26681;&#25454;&#19994;&#21153;&#36923;&#36753;&#21644;&#23454;&#38469;&#30340;&#30828;&#20214;&#25104;&#26412;&#26469;&#32508;&#21512;&#32771;&#34385;

net.ipv4.tcp_syncookies = 1
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19982;&#24615;&#33021;&#26080;&#20851;&#12290;&#29992;&#20110;&#35299;&#20915;TCP&#30340;SYN&#25915;&#20987;</span>

net.ipv4.tcp_max_syn_backlog = 8192
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#20010;&#21442;&#25968;&#34920;&#31034;TCP&#19977;&#27425;&#25569;&#25163;&#24314;&#31435;&#38454;&#27573;&#25509;&#21463;SYN&#35831;&#27714;&#21015;&#38431;&#30340;&#36739;&#22823;&#38271;&#24230;&#65292;&#40664;&#35748;1024&#65292;&#23558;&#20854;&#35774;&#32622;&#30340;&#22823;&#19968;&#20123;&#21487;&#20351;&#20986;&#29616;Nginx&#32321;&#24537;&#26469;&#19981;&#21450;accept&#26032;&#36830;&#25509;&#26102;&#65292;Linux&#19981;&#33267;&#20110;&#20002;&#22833;&#23458;&#25143;&#31471;&#21457;&#36215;&#30340;&#38142;&#25509;&#35831;&#27714;</span>

net.ipv4.tcp_tw_recycle = 1
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#20010;&#21442;&#25968;&#29992;&#20110;&#35774;&#32622;&#21551;&#29992;timewait&#24555;&#36895;&#22238;&#25910;</span>

net.core.somaxconn=262114
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36873;&#39033;&#40664;&#35748;&#20540;&#26159;128&#65292;&#36825;&#20010;&#21442;&#25968;&#29992;&#20110;&#35843;&#33410;&#31995;&#32479;&#21516;&#26102;&#21457;&#36215;&#30340;TCP&#36830;&#25509;&#25968;&#65292;&#22312;&#39640;&#24182;&#21457;&#30340;&#35831;&#27714;&#20013;&#65292;&#40664;&#35748;&#30340;&#20540;&#21487;&#33021;&#20250;&#23548;&#33268;&#38142;&#25509;&#36229;&#26102;&#25110;&#32773;&#37325;&#20256;&#65292;&#22240;&#27492;&#38656;&#35201;&#32467;&#21512;&#39640;&#24182;&#21457;&#35831;&#27714;&#25968;&#26469;&#35843;&#33410;&#27492;&#20540;&#12290;</span>

net.ipv4.tcp_max_orphans=262114
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36873;&#39033;&#29992;&#20110;&#35774;&#23450;&#31995;&#32479;&#20013;&#26368;&#22810;&#26377;&#22810;&#23569;&#20010;TCP&#22871;&#25509;&#23383;&#19981;&#34987;&#20851;&#32852;&#21040;&#20219;&#20309;&#19968;&#20010;&#29992;&#25143;&#25991;&#20214;&#21477;&#26564;&#19978;&#12290;&#22914;&#26524;&#36229;&#36807;&#36825;&#20010;&#25968;&#23383;&#65292;&#23396;&#31435;&#38142;&#25509;&#23558;&#31435;&#21363;&#34987;&#22797;&#20301;&#24182;&#36755;&#20986;&#35686;&#21578;&#20449;&#24687;&#12290;&#36825;&#20010;&#38480;&#21046;&#25351;&#31034;&#20026;&#20102;&#38450;&#27490;&#31616;&#21333;&#30340;DOS&#25915;&#20987;&#65292;&#19981;&#29992;&#36807;&#20998;&#20381;&#38752;&#36825;&#20010;&#38480;&#21046;&#29978;&#33267;&#35748;&#20026;&#30340;&#20943;&#23567;&#36825;&#20010;&#20540;&#65292;&#26356;&#22810;&#30340;&#24773;&#20917;&#26159;&#22686;&#21152;&#36825;&#20010;&#20540;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a57d4036-383e-4c29-962f-0cd2dc2871d7" class="outline-4">
<h4 id="h:a57d4036-383e-4c29-962f-0cd2dc2871d7">PAM 资源限制优化</h4>
<div class="outline-text-4" id="text-h:a57d4036-383e-4c29-962f-0cd2dc2871d7">
<p>
在/etc/security/limits.conf 最后增加：
</p>

<div class="org-src-container">
<pre class="src src-sh">* soft nofile 65535
* hard nofile 65535
* soft nproc 65535
* hard nproc 65535
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:6896d5f9-97e9-4b64-86e6-a9da0a008eb9" class="outline-2">
<h2 id="h:6896d5f9-97e9-4b64-86e6-a9da0a008eb9">LNMP项目实战-WordPress站点搭建</h2>
<div class="outline-text-2" id="text-h:6896d5f9-97e9-4b64-86e6-a9da0a008eb9">
<p>
LNMP项目实战环境说明
</p>
<div class="org-src-container">
<pre class="src src-sh">L&#65306;Linux&#65288;CentOS7&#65289;https://mirrors.aliyun.com/centos/7/isos/x86_64/
N&#65306;Nginx&#65288;1.18.0&#65289; https://nginx.org/en/download.html
M&#65306;MySQL&#65288;8.0.19&#65289; https://dev.mysql.com/downloads/mysql/
P&#65306;PHP&#65288;7.4.10&#65289; http://php.net/downloads.php
Wordpress&#65288;5.4.2&#65289;&#65306;https://cn.wordpress.org/download/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37096;&#32626;&#35268;&#21010;&#65306;</span>
10.0.0.7&#65306;Nginx php-fpm &#36816;&#34892;web&#26381;&#21153;
10.0.0.17&#65306;&#36816;&#34892;MySQL&#25968;&#25454;&#24211;,Redis&#26381;&#21153;
</pre>
</div>
</div>
<div id="outline-container-h:67f7d4e1-4767-4806-bd44-a16c00e7895c" class="outline-3">
<h3 id="h:67f7d4e1-4767-4806-bd44-a16c00e7895c">部署数据库</h3>
<div class="outline-text-3" id="text-h:67f7d4e1-4767-4806-bd44-a16c00e7895c">
<p>
在10.0.0.17主机部署MySQL服务
</p>
</div>
<div id="outline-container-h:2dcdb361-6a38-47b1-a7a9-14af5aba799a" class="outline-4">
<h4 id="h:2dcdb361-6a38-47b1-a7a9-14af5aba799a">二进制部署MySQL数据库</h4>
<div class="outline-text-4" id="text-h:2dcdb361-6a38-47b1-a7a9-14af5aba799a">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#38190;&#23433;&#35013;&#33050;&#26412;</span>
[root@centos7 ~]#cat install_mysql5.7or8.0_for_centos.sh
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">MySQL Download URL: https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.29-linux-glibc2.12-x86_64.tar.gz</span>

<span style="color: #483d8b;">.</span> /etc/init.d/functions
<span style="color: #a0522d;">SRC_DIR</span>=<span style="color: #ff00ff;">`pwd`</span>
<span style="color: #a0522d;">MYSQL</span>=<span style="color: #8b2252;">'mysql-8.0.19-linux-glibc2.12-x86_64.tar.xz'</span>
<span style="color: #a0522d;">COLOR</span>=<span style="color: #8b2252;">'echo -e \E[01;31m'</span>
<span style="color: #a0522d;">END</span>=<span style="color: #8b2252;">'\E[0m'</span>
<span style="color: #a0522d;">MYSQL_ROOT_PASSWORD</span>=cici

<span style="color: #0000ff;">check</span> (){
<span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">UID</span> -ne 0 ]; <span style="color: #a020f0;">then</span>
action <span style="color: #8b2252;">"&#24403;&#21069;&#29992;&#25143;&#19981;&#26159;root,&#23433;&#35013;&#22833;&#36133;"</span> false
 <span style="color: #a020f0;">exit</span> 1
<span style="color: #a020f0;">fi</span>

<span style="color: #483d8b;">cd</span>  $<span style="color: #a0522d;">SRC_DIR</span>
<span style="color: #a020f0;">if</span> [ !  -e $<span style="color: #a0522d;">MYSQL</span> ];<span style="color: #a020f0;">then</span>
    $<span style="color: #a0522d;">COLOR</span><span style="color: #8b2252;">"&#32570;&#23569;${MYSQL}&#25991;&#20214;"</span>$<span style="color: #a0522d;">END</span>
$<span style="color: #a0522d;">COLOR</span><span style="color: #8b2252;">"&#35831;&#23558;&#30456;&#20851;&#36719;&#20214;&#25918;&#22312;${SRC_DIR}&#30446;&#24405;&#19979;"</span>$<span style="color: #a0522d;">END</span>
    <span style="color: #a020f0;">exit</span>
<span style="color: #a020f0;">elif</span> [ -e /usr/local/mysql ];<span style="color: #a020f0;">then</span>
   action <span style="color: #8b2252;">"&#25968;&#25454;&#24211;&#24050;&#23384;&#22312;&#65292;&#23433;&#35013;&#22833;&#36133;"</span> false
    <span style="color: #a020f0;">exit</span>
<span style="color: #a020f0;">else</span>
<span style="color: #a020f0;">return</span>
<span style="color: #a020f0;">fi</span>
}

<span style="color: #0000ff;">install_mysql</span>(){
  $<span style="color: #a0522d;">COLOR</span><span style="color: #8b2252;">"&#24320;&#22987;&#23433;&#35013;MySQL&#25968;&#25454;&#24211;..."</span>$<span style="color: #a0522d;">END</span>

  yum  -y -q install libaio numactl-libs  libaio &amp;&gt; /dev/null
  <span style="color: #483d8b;">cd</span> $<span style="color: #a0522d;">SRC_DIR</span>
  tar xf $<span style="color: #a0522d;">MYSQL</span> -C /usr/local/
  <span style="color: #a0522d;">MYSQL_DIR</span>=<span style="color: #ff00ff;">`echo $MYSQL| sed -nr 's/^(.*[0-9]).*/\1/p'`</span>
  ln -s /usr/local/$<span style="color: #a0522d;">MYSQL_DIR</span> /usr/local/mysql
  chown -R root.root /usr/local/mysql/
  id mysql &amp;&gt; /dev/null || { useradd -s /sbin/nologin -r mysql ; action <span style="color: #8b2252;">"&#21019;&#24314;mysql&#29992;&#25143;"</span>; }

  <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'PATH=/usr/local/mysql/bin/:$PATH'</span> &gt; /etc/profile.d/mysql.sh
  <span style="color: #483d8b;">.</span> /etc/profile.d/mysql.sh
  ln -s /usr/local/mysql/bin/* /usr/bin/
  cat &gt; /etc/my.cnf &lt;&lt;-EOF
<span style="color: #ffa54f;">[mysqld]</span>
<span style="color: #ffa54f;">server-id=`hostname -I|cut -d. -f4`</span>
<span style="color: #ffa54f;">log-bin</span>
<span style="color: #ffa54f;">datadir=/data/mysql</span>
<span style="color: #ffa54f;">socket=/data/mysql/mysql.sock</span>

<span style="color: #ffa54f;">log-error=/data/mysql/mysql.log</span>
<span style="color: #ffa54f;">pid-file=/data/mysql/mysql.pid</span>
<span style="color: #ffa54f;">[client]</span>
<span style="color: #ffa54f;">socket=/data/mysql/mysql.sock</span>
<span style="color: #ffa54f;">EOF</span>

  mysqld --initialize --user=mysql --datadir=/data/mysql
  cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld
  chkconfig --add mysqld
  chkconfig mysqld on
  service mysqld start
  [ $<span style="color: #a0522d;">?</span> -ne 0 ] &amp;&amp; { $<span style="color: #a0522d;">COLOR</span><span style="color: #8b2252;">"&#25968;&#25454;&#24211;&#21551;&#21160;&#22833;&#36133;&#65292;&#36864;&#20986;!"</span>$<span style="color: #a0522d;">END</span>;<span style="color: #a020f0;">exit</span>; }
  <span style="color: #a0522d;">MYSQL_OLDPASSWORD</span>=<span style="color: #ff00ff;">`awk '/A temporary password/{print $NF}' /data/mysql/mysql.log`</span>
  mysqladmin  -uroot -p$<span style="color: #a0522d;">MYSQL_OLDPASSWORD</span> password $<span style="color: #a0522d;">MYSQL_ROOT_PASSWORD</span> &amp;&gt;/dev/null
 action <span style="color: #8b2252;">"&#25968;&#25454;&#24211;&#23433;&#35013;&#23436;&#25104;"</span>
}

check
install_mysql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36816;&#34892;&#33050;&#26412;&#23433;&#35013;&#25968;&#25454;&#24211;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:919ad4ec-4562-44ed-ad52-fd909361a423" class="outline-4">
<h4 id="h:919ad4ec-4562-44ed-ad52-fd909361a423">创建wordpress数据库和用户并授权</h4>
<div class="outline-text-4" id="text-h:919ad4ec-4562-44ed-ad52-fd909361a423">
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#mysql -uroot -pcici
mysql&gt; create database wordpress;
Query OK, 1 row affected (0.01 sec)
mysql&gt; create user wordpress@<span style="color: #8b2252;">'10.0.0.%'</span> identified by <span style="color: #8b2252;">'123456'</span>;
Query OK, 0 rows affected (0.01 sec)
mysql&gt; grant all on wordpress.* to wordpress@<span style="color: #8b2252;">'10.0.0.%'</span>;
Query OK, 0 rows affected (0.01 sec)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:769ccb60-b242-4c96-b24e-260a434de0e9" class="outline-4">
<h4 id="h:769ccb60-b242-4c96-b24e-260a434de0e9">验证MySQL账户权限</h4>
<div class="outline-text-4" id="text-h:769ccb60-b242-4c96-b24e-260a434de0e9">
<p>
在WordPress服务器使用授权的MySQL账户远程登录测试权限
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#mysql -uwordpress -p123456 -h10.0.0.17
mysql&gt; show databases;
+--------------------+
| Database &#160;&#160;&#160;&#160;&#160;|
+--------------------+
| information_schema |
| wordpress &#160;&#160;&#160;&#160;|
+--------------------+
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:34c31985-d1a7-405e-aa7f-b07a3846445b" class="outline-3">
<h3 id="h:34c31985-d1a7-405e-aa7f-b07a3846445b">部署PHP</h3>
<div class="outline-text-3" id="text-h:34c31985-d1a7-405e-aa7f-b07a3846445b">
<p>
在10.0.0.7主机部署php-fpm服务
</p>
</div>
<div id="outline-container-h:d2c33054-64dc-41ff-b906-268ef2f77066" class="outline-4">
<h4 id="h:d2c33054-64dc-41ff-b906-268ef2f77066">编译安装 php</h4>
<div class="outline-text-4" id="text-h:d2c33054-64dc-41ff-b906-268ef2f77066">
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#yum -y install gcc openssl-devel libxml2-devel bzip2-devel libmcrypt-devel sqlite-devel oniguruma-devel
[root@centos7 ~]#cd /usr/local/src

[root@centos7 php-7.4.11]#./configure --prefix=/apps/php74 --enable-mysqlnd --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --with-openssl &#160;--with-zlib --with-config-file-path=/etc --with-config-file-scan-dir=/etc/php.d --enable-mbstring --enable-xml --enable-sockets --enable-fpm --enable-maintainer-zts --disable-fileinfo

[root@centos7 php-7.4.11]#make -j 8 &amp;&amp; make install
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a4f06cc2-eead-4bc6-a478-95388f89a392" class="outline-4">
<h4 id="h:a4f06cc2-eead-4bc6-a478-95388f89a392">准备PHP配置文件</h4>
<div class="outline-text-4" id="text-h:a4f06cc2-eead-4bc6-a478-95388f89a392">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#37197;&#32622;&#25991;&#20214;</span>
[root@centos7 php-7.4.11]#cp /usr/local/src/php-7.4.11/php.ini-production /etc/php.ini

[root@centos7 php-7.4.11]#cd /apps/php74/etc
[root@centos7 etc]#cp php-fpm.conf.default php-fpm.conf
[root@centos7 php-7.4.11]#cd php-fpm.d/
[root@centos7 php-fpm.d]#cp www.conf.default www.conf

[root@centos7 php-fpm.d]#vim www.conf
[root@centos7 php-fpm.d]#grep <span style="color: #8b2252;">'^[^;]'</span> www.conf
[www]
user = www
group = www
listen = 127.0.0.1:9000
pm = dynamic
pm.max_children = 5
pm.start_servers = 2
pm.min_spare_servers = 1
pm.max_spare_servers = 3
pm.status_path = /pm_status
ping.path = /ping
access.log = log/$<span style="color: #a0522d;">pool</span>.access.log
slowlog = log/$<span style="color: #a0522d;">pool</span>.log.slow

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#29992;&#25143;</span>
[root@centos7 php-fpm.d]#useradd -r -s /sbin/nologin www

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#35775;&#38382;&#26085;&#24535;&#25991;&#20214;&#36335;&#24452;</span>
[root@centos7 php-fpm.d]#mkdir /apps/php74/log
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1a7f8271-3e08-4247-9de9-82da796a7319" class="outline-4">
<h4 id="h:1a7f8271-3e08-4247-9de9-82da796a7319">启动并验证 php-fpm服务</h4>
<div class="outline-text-4" id="text-h:1a7f8271-3e08-4247-9de9-82da796a7319">
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#/apps/php74/sbin/php-fpm -t
[22-Oct-2020 10:55:19] NOTICE: configuration file /apps/php74/etc/php-fpm.conf
<span style="color: #483d8b;">test</span> is successful

[root@centos7 ~]#cp /usr/local/src/php-7.4.11/sapi/fpm/php-fpm.service /usr/lib/systemd/system/

[root@centos7 ~]#systemctl daemon-reload
[root@centos7 ~]#systemctl enable --now php-fpm

[root@centos7 php-7.4.11]#ss -ntl

[root@centos7 ~]#pstree -p |grep php

[root@centos7 ~]#ps -ef |grep php
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:b67b15ba-2005-4dbf-8685-c5bede3e14a7" class="outline-3">
<h3 id="h:b67b15ba-2005-4dbf-8685-c5bede3e14a7">部署 Nginx</h3>
<div class="outline-text-3" id="text-h:b67b15ba-2005-4dbf-8685-c5bede3e14a7">
<p>
在10.0.0.7主机部署nginx服务
</p>
</div>
<div id="outline-container-h:69b737df-51aa-4eb1-bfed-0713e6c80863" class="outline-4">
<h4 id="h:69b737df-51aa-4eb1-bfed-0713e6c80863">编译安装 nginx</h4>
<div class="outline-text-4" id="text-h:69b737df-51aa-4eb1-bfed-0713e6c80863">
<div class="org-src-container">
<pre class="src src-sh">root@centos7 ~]#yum -y install gcc pcre-devel openssl-devel zlib-devel
[root@centos7 ~]#cd /usr/local/src/
[root@centos7 src]#wget http://nginx.org/download/nginx-1.18.0.tar.gz
[root@centos7 src]#tar xf nginx-1.18.0.tar.gz
[root@centos7 src]#cd nginx-1.18.0/
[root@centos7 nginx-1.18.0]#./configure --prefix=/apps/nginx <span style="color: #8b2252;">\</span>
--user=www <span style="color: #8b2252;">\</span>
--group=www <span style="color: #8b2252;">\</span>
--with-http_ssl_module <span style="color: #8b2252;">\</span>
--with-http_v2_module <span style="color: #8b2252;">\</span>
--with-http_realip_module <span style="color: #8b2252;">\</span>
--with-http_stub_status_module <span style="color: #8b2252;">\</span>
--with-http_gzip_static_module <span style="color: #8b2252;">\</span>
--with-pcre <span style="color: #8b2252;">\</span>
--with-stream <span style="color: #8b2252;">\</span>
--with-stream_ssl_module <span style="color: #8b2252;">\</span>
--with-stream_realip_module

[root@centos7 nginx-1.18.0]#make &amp;&amp; make install
</pre>
</div>
</div>
</div>
<div id="outline-container-h:dc4e8643-f0d8-4d56-a58c-ce9a34623894" class="outline-4">
<h4 id="h:dc4e8643-f0d8-4d56-a58c-ce9a34623894">准备服务文件并启动 nginx</h4>
<div class="outline-text-4" id="text-h:dc4e8643-f0d8-4d56-a58c-ce9a34623894">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /usr/lib/systemd/system/nginx.service
[Unit]
<span style="color: #a0522d;">Description</span>=nginx - high performance web server
<span style="color: #a0522d;">Documentation</span>=http://nginx.org/en/docs/
<span style="color: #a0522d;">After</span>=network-online.target remote-fs.target nss-lookup.target
<span style="color: #a0522d;">Wants</span>=network-online.target

[Service]
<span style="color: #a0522d;">Type</span>=forking
<span style="color: #a0522d;">PIDFile</span>=/apps/nginx/run/nginx.pid
<span style="color: #a0522d;">ExecStart</span>=/apps/nginx/sbin/nginx -c /apps/nginx/conf/nginx.conf
<span style="color: #a0522d;">ExecReload</span>=/bin/kill -s HUP $<span style="color: #a0522d;">MAINPID</span>
<span style="color: #a0522d;">ExecStop</span>=/bin/kill -s TERM $<span style="color: #a0522d;">MAINPID</span>

[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#30446;&#24405;</span>
[root@centos8 ~]#mkdir /apps/nginx/run/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;&#25991;&#20214;</span>
[root@centos8 ~]#vim /apps/nginx/conf/nginx.conf
pid  /apps/nginx/run/nginx.pid;

[root@centos7 ~]#systemctl daemon-reload
[root@centos7 ~]#systemctl enable --now nginx

[root@centos7 ~]#ss -ntl
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e368bcf7-5962-448e-91f0-f7e624df87ea" class="outline-4">
<h4 id="h:e368bcf7-5962-448e-91f0-f7e624df87ea">配置 Nginx 支持 fastcgi</h4>
<div class="outline-text-4" id="text-h:e368bcf7-5962-448e-91f0-f7e624df87ea">
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#vim /apps/nginx/conf/nginx.conf
[root@centos7 ~]#grep -Ev <span style="color: #8b2252;">'#|^$'</span> /apps/nginx/conf/nginx.conf
worker_processes  1;
pid    /apps/nginx/run/nginx.pid;
events {
  worker_connections  1024;
}
http {
    include    mime.types;
    default_type application/octet-stream;
    sendfile    on;
    keepalive_timeout  65;
    server {
        listen    80;
        server_name www.cici.org;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#20027;&#26426;&#21517;</span>
        location / {
            root  /data/nginx/wordpress;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#30446;&#24405;</span>
            index index.php index.html index.htm;      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#40664;&#35748;&#20027;&#39029;</span>
        }
        error_page  500 502 503 504 /50x.html;
        location = /50x.html {
            root  html;
        }
        location ~ <span style="color: #8b2252;">\.</span>php$ {             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23454;&#29616;php-fpm</span>
            root      /data/nginx/wordpress;
            fastcgi_pass  127.0.0.1:9000;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME  $<span style="color: #a0522d;">document_root</span>$<span style="color: #a0522d;">fastcgi_script_name</span>;
            include    fastcgi_params;
        }
        location ~ ^/(ping|pm_status)$ {       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23454;&#29616;&#29366;&#24577;&#39029;</span>
            include fastcgi_params;
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_param PATH_TRANSLATED $<span style="color: #a0522d;">document_root</span>$<span style="color: #a0522d;">fastcgi_script_name</span>;
        }
    }
}

[root@centos7 ~]# /apps/nginx/sbin/nginx -t
[root@centos7 ~]#systemctl reload nginx
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bf87e09e-96c2-4b12-b2d1-ae28a009a33c" class="outline-4">
<h4 id="h:bf87e09e-96c2-4b12-b2d1-ae28a009a33c">准备 php 测试页</h4>
<div class="outline-text-4" id="text-h:bf87e09e-96c2-4b12-b2d1-ae28a009a33c">
<p>
准备测试页
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#mkdir -p /data/nginx/wordpress
[root@centos7 ~]#vim /data/nginx/wordpress/test.php
[root@centos7 ~]#cat /data/nginx/wordpress/test.php
&lt;?php
<span style="color: #0000ff;">phpinfo</span>();
?&gt;
</pre>
</div>


<p>
访问验证 php 测试页
</p>
</div>
</div>
</div>
<div id="outline-container-h:12c826a7-31d7-4e69-8e09-3864d5f77f51" class="outline-3">
<h3 id="h:12c826a7-31d7-4e69-8e09-3864d5f77f51">部署 WordPress</h3>
<div class="outline-text-3" id="text-h:12c826a7-31d7-4e69-8e09-3864d5f77f51">
<p>
在10.0.0.7主机部署 wordpress
</p>
</div>
<div id="outline-container-h:40328399-4acd-4293-a0d3-2c2384548fba" class="outline-4">
<h4 id="h:40328399-4acd-4293-a0d3-2c2384548fba">准备 WordPress 文件</h4>
<div class="outline-text-4" id="text-h:40328399-4acd-4293-a0d3-2c2384548fba">
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#tar xf wordpress-5.4.2-zh_CN.tar.gz
[root@centos7 ~]#cp -r wordpress/* /data/nginx/wordpress
[root@centos7 ~]#chown -R www.www /data/nginx/wordpress/
</pre>
</div>
</div>
</div>
<div id="outline-container-h:329b81d3-01a2-4c51-904d-c955d5801ddb" class="outline-4">
<h4 id="h:329b81d3-01a2-4c51-904d-c955d5801ddb">web页面</h4>
<div class="outline-text-4" id="text-h:329b81d3-01a2-4c51-904d-c955d5801ddb">
<ul class="org-ul">
<li>初始化web页面</li>
<li>打开浏览器访问</li>
<li>登录后台管理界面并发表文章</li>
<li><p>
验证发表的文章
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#21040;&#19978;&#20256;&#30340;&#22270;&#29255;</span>
[root@centos7 ~]#tree /data/nginx/wordpress/wp-content/uploads/
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-h:75e61be1-6e58-44e8-8680-4ccd78f7a6c7" class="outline-4">
<h4 id="h:75e61be1-6e58-44e8-8680-4ccd78f7a6c7">配置允许上传大文件</h4>
<div class="outline-text-4" id="text-h:75e61be1-6e58-44e8-8680-4ccd78f7a6c7">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;:&#40664;&#35748;&#21482;&#25903;&#25345;1M&#20197;&#19979;&#25991;&#20214;&#19978;&#20256;,&#35201;&#19978;&#20256;&#22823;&#22270;&#29255;,&#38656;&#35201;&#20462;&#25913;&#19979;&#38754;&#19977;&#39033;&#37197;&#32622;,&#26368;&#22823;&#19978;&#20256;&#30001;&#19977;&#39033;&#20540;&#30340;&#26368;&#23567;&#20540;&#20915;&#23450;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#19978;&#20256;&#22823;&#20110;1M&#25991;&#20214;,&#20250;&#20986;&#29616;&#19979;&#38754;413&#38169;&#35823;</span>
[root@centos7 ~]#tail -f /apps/nginx/logs/access.log
10.0.0.1 - - [27/Nov/2020:12:21:16 +0800] <span style="color: #8b2252;">"POST /wp-admin/async-upload.php</span>
<span style="color: #8b2252;">HTTP/1.1"</span> 413 585 <span style="color: #8b2252;">"http://10.0.0.7/wp-admin/upload.php"</span> <span style="color: #8b2252;">"Mozilla/5.0 (Windows NT</span>
<span style="color: #8b2252;">10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.67</span>
<span style="color: #8b2252;">Safari/537.36 Edg/87.0.664.47"</span>

[root@centos7 ~]#vim /apps/nginx/conf/nginx.conf
server {
   client_max_body_size 10m; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#20540;&#20026;1M</span>
.....

[root@centos7 ~]#vim /etc/php.ini
post_max_size = 30M  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#20540;&#20026;8M</span>
upload_max_filesize = 20M  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#20540;&#20026;2M</span>

[root@centos7 ~]#systemctl restart nginx php-fpm
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c663a750-ecd3-4683-95f5-8f262abe9dee" class="outline-4">
<h4 id="h:c663a750-ecd3-4683-95f5-8f262abe9dee">安全加固</h4>
<div class="outline-text-4" id="text-h:c663a750-ecd3-4683-95f5-8f262abe9dee">
<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#vim /apps/nginx/conf/nginx.conf
[root@centos7 ~]#grep -Ev <span style="color: #8b2252;">'#|^$'</span> /apps/nginx/conf/nginx.conf
worker_processes  1;
pid    /apps/nginx/run/nginx.pid;
events {
 worker_connections  1024;
}

http {
 include    mime.types;
 default_type application/octet-stream;
 sendfile    on;
 keepalive_timeout  65;
 server {
     listen    80;
     server_name www.cici.org;
     server_tokens off; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#27492;&#34892;</span>
     location / {
         root  /data/nginx/wordpress;
         index index.php index.html index.htm;
     }
     error_page  500 502 503 504 /50x.html;
     location = /50x.html {
         root  html;
     }
     location ~ <span style="color: #8b2252;">\.</span>php$ {
         root      /data/nginx/wordpress;
         fastcgi_pass  127.0.0.1:9000;
         fastcgi_index index.php;
         fastcgi_param SCRIPT_FILENAME  $<span style="color: #a0522d;">document_root</span>$<span style="color: #a0522d;">fastcgi_script_name</span>;
         include    fastcgi_params;
         fastcgi_hide_header X-Powered-By;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#27492;&#34892;</span>
     }
     location ~ ^/(ping|pm_status)$ {
         include fastcgi_params;
         fastcgi_pass 127.0.0.1:9000;
         fastcgi_param PATH_TRANSLATED $<span style="color: #a0522d;">document_root</span>$<span style="color: #a0522d;">fastcgi_script_name</span>;
     }
 }
}
[root@centos7 ~]#systemctl reload nginx
</pre>
</div>
</div>
</div>
<div id="outline-container-h:30736de7-f4f3-41ae-8e8e-b8d72affd233" class="outline-4">
<h4 id="h:30736de7-f4f3-41ae-8e8e-b8d72affd233">配置 php 开启 opcache 加速</h4>
<div class="outline-text-4" id="text-h:30736de7-f4f3-41ae-8e8e-b8d72affd233">
<p>
在10.0.0.7主机进行以下修改配置
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#36753;php.ini&#37197;&#32622;&#25991;&#20214;</span>
[root@centos7 ~]#vim /etc/php.ini
[opcache]
; Determines if Zend OPCache is enabled
<span style="color: #a0522d;">zend_extension</span>=opcache.so
              opcache.enable=1
.....
[root@centos7 ~]#systemctl restart php-fpm

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#27979;&#35797;&#39029;&#30830;&#35748;&#24320;&#21551;opcache&#21152;&#36895;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:4aa9f61f-02e4-44e9-9859-7b5b5f46e3c6" class="outline-3">
<h3 id="h:4aa9f61f-02e4-44e9-9859-7b5b5f46e3c6">PHP 扩展session模块支持redis</h3>
<div class="outline-text-3" id="text-h:4aa9f61f-02e4-44e9-9859-7b5b5f46e3c6">
<p>
PECL是 PHP 扩展的存储库，提供用于下载和开发 PHP 扩展的所有已知扩展和托管功能的目录
</p>

<p>
官方链接: <a href="http://pecl.php.net/package-stats.php">http://pecl.php.net/package-stats.php</a>
</p>

<p>
github: <a href="https://github.com/phpredis/phpredis">https://github.com/phpredis/phpredis</a>
</p>

<p>
github安装文档: <a href="https://github.com/phpredis/phpredis/blob/develop/INSTALL.markdown">https://github.com/phpredis/phpredis/blob/develop/INSTALL.markdown</a>
</p>

<p>
开始在 PHP 中使用 Redis 前， 需要确保已经安装了 redis 服务及 PHP redis 驱动
</p>

<p>
PHP redis 驱动下载地址为:<a href="https://github.com/phpredis/phpredis/releases">https://github.com/phpredis/phpredis/releases</a>
</p>
</div>
<div id="outline-container-h:09a22fc5-fa1b-4b74-a941-ff93066d2f60" class="outline-4">
<h4 id="h:09a22fc5-fa1b-4b74-a941-ff93066d2f60">编译安装PHP redis</h4>
<div class="outline-text-4" id="text-h:09a22fc5-fa1b-4b74-a941-ff93066d2f60">
<p>
在10.0.0.7主机进行以下编译安装
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#cd /usr/local/src
[root@centos7 src]#ls
[root@centos7 src]#wget http://pecl.php.net/get/redis-5.3.1.tgz
[root@centos7 src]#tar xf redis-5.3.1.tgz
[root@centos7 src]#cd redis-5.3.1/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#26159;yum&#23433;&#35013;php,&#38656;&#35201;&#25191;&#34892;yum -y install php-cli php-devel</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#19979;&#20026;&#32534;&#35793;&#23433;&#35013;php&#30340;&#23545;&#24212;&#26041;&#24335;</span>
[root@centos7 redis-5.3.1]#/apps/php74/bin/phpize
Configuring for:
PHP Api Version:     20190902
Zend Module Api No:    20190902
Zend Extension Api No:  320190902
Cannot find autoconf. Please check your autoconf installation and the <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25253;&#38169;&#25552;&#31034;</span>
$<span style="color: #a0522d;">PHP_AUTOCONF</span> environment variable. Then, rerun this script.

[root@centos7 redis-5.3.1]#yum -y install autoconf
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#26032;&#25191;&#34892;&#25104;&#21151;</span>
[root@centos7 redis-5.3.1]#/apps/php74/bin/phpize
Configuring for:
PHP Api Version:     20190902
Zend Module Api No:    20190902
Zend Extension Api No:  320190902

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#29983;&#25104;configure&#33050;&#26412;</span>
[root@centos7 redis-5.3.1]#ls

<span style="color: #b22222;">#</span><span style="color: #b22222;">yum&#23433;&#35013;php,&#26080;&#38656;&#25351;&#23450;--with-php-config</span>
[root@centos7 redis-5.3.1]#./configure --with-php-config=/apps/php74/bin/php-config
[root@centos7 redis-5.3.1]#make -j 8 &amp;&amp; make install
.....
See any operating system documentation about shared libraries for
more information, such as the ld(1) and ld.so(8) manual pages.
----------------------------------------------------------------------
Build complete.
Don<span style="color: #8b2252;">'t forget to run '</span>make test<span style="color: #8b2252;">'.</span>
<span style="color: #8b2252;">Installing shared extensions:   /apps/php74/lib/php/extensions/no-debug-zts-</span>
<span style="color: #8b2252;">20190902/</span>

<span style="color: #8b2252;">#&#39564;&#35777;redis&#27169;&#22359;</span>
<span style="color: #8b2252;">#yum&#23433;&#35013;php,&#27169;&#22359;&#25991;&#20214;&#40664;&#35748;&#23384;&#25918;&#22312; /usr/lib64/php/modules/redis.so</span>
<span style="color: #8b2252;">[root@centos7 redis-5.3.1]#ll /apps/php74/lib/php/extensions/no-debug-zts-20190902/</span>
<span style="color: #8b2252;">total 9584</span>
<span style="color: #8b2252;">-rwxr-xr-x 1 root root 4647668 Oct 22 10:44 opcache.a</span>
<span style="color: #8b2252;">-rwxr-xr-x 1 root root 2509416 Oct 22 10:44 opcache.so</span>
<span style="color: #8b2252;">-rwxr-xr-x 1 root root 2651320 Oct 22 12:10 redis.so</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b48b5976-24c4-45f9-a315-6ad365e57308" class="outline-4">
<h4 id="h:b48b5976-24c4-45f9-a315-6ad365e57308">编辑php配置文件支持redis</h4>
<div class="outline-text-4" id="text-h:b48b5976-24c4-45f9-a315-6ad365e57308">
<p>
在10.0.0.7主机进行以下修改配置
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#36753;php.ini&#37197;&#32622;&#25991;&#20214;&#65292;&#25193;&#23637;redis.so&#27169;&#22359;</span>
[root@centos7 ~]#vim /etc/php.ini
.....
<span style="color: #b22222;">#</span><span style="color: #b22222;">extension=/apps/php74/lib/php/extensions/no-debug-zts-20190902/redis.so</span>
<span style="color: #a0522d;">extension</span>=redis.so   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25991;&#20214;&#26368;&#21518;&#19968;&#34892;&#28155;&#21152;&#27492;&#34892;,&#36335;&#24452;&#21487;&#30465;&#30053;</span>

[root@centos7 ~]#systemctl restart php-fpm
</pre>
</div>

<p>
验证加载 redis 模块
</p>


<p>
访问测试页确认redis模块开启
</p>
</div>
</div>
<div id="outline-container-h:fc2c7db4-fb8e-4477-bb44-298627bf2a8f" class="outline-4">
<h4 id="h:fc2c7db4-fb8e-4477-bb44-298627bf2a8f">安装和配置 redis 服务</h4>
<div class="outline-text-4" id="text-h:fc2c7db4-fb8e-4477-bb44-298627bf2a8f">
<p>
在10.0.0.17主机进行安装redis 服务
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;10.0.0.17&#20027;&#26426;&#23433;&#35013;redis&#26381;&#21153;</span>
[root@centos7 ~]#yum -y install redis
[root@centos7 ~]#vim /etc/redis.conf
<span style="color: #483d8b;">bind</span> 0.0.0.0
requirepass 123456
[root@centos7 ~]#systemctl enable --now redis
[root@centos7 ~]#ss -tnl
</pre>
</div>
</div>
</div>
<div id="outline-container-h:988ec383-69a5-43b8-af57-8aacf16f864c" class="outline-4">
<h4 id="h:988ec383-69a5-43b8-af57-8aacf16f864c">配置 php 支持 redis 保存 session</h4>
<div class="outline-text-4" id="text-h:988ec383-69a5-43b8-af57-8aacf16f864c">
<p>
在10.0.0.7 主机进行以下配置
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;10.0.0.7&#20027;&#26426;&#37197;&#32622;php&#30340;session&#20445;&#23384;&#22312;redis&#26381;&#21153;</span>
[root@centos7 ~]#vim /etc/php.ini
[Session]
; Handler used to store/retrieve data.
; http://php.net/session.save-handler
session.save_handler = redis
session.save_path = <span style="color: #8b2252;">"tcp://10.0.0.17:6379?auth=123456"</span>

[root@centos7 ~]#systemctl restart php-fpm
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5fa46e0b-4f4b-4965-be2a-9f42f01d1510" class="outline-4">
<h4 id="h:5fa46e0b-4f4b-4965-be2a-9f42f01d1510">准备 php实现 session 的测试页面</h4>
<div class="outline-text-4" id="text-h:5fa46e0b-4f4b-4965-be2a-9f42f01d1510">
<p>
在10.0.0.7主机进行准备相关文件
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#cat /data/nginx/wordpress/session.php
&lt;?php
<span style="color: #0000ff;">session_start</span>();
//redis&#29992;session_id&#20316;&#20026;key &#24182;&#19988;&#26159;&#20197;string&#30340;&#24418;&#24335;&#23384;&#20648;
$<span style="color: #a0522d;">redisKey</span> = <span style="color: #8b2252;">'PHPREDIS_SESSION:'</span> . session_id();
// SESSION &#36171;&#20540;&#27979;&#35797;
$<span style="color: #a0522d;">_SESSION</span>[<span style="color: #8b2252;">'message'</span>] = <span style="color: #8b2252;">"Hello, I'm in redis"</span>;
$<span style="color: #a0522d;">_SESSION</span>[<span style="color: #8b2252;">'arr'</span>] = [1, 2, 3, 4, 5, 6];
<span style="color: #483d8b;">echo</span> $<span style="color: #a0522d;">_SESSION</span>[<span style="color: #8b2252;">"message"</span>] , <span style="color: #8b2252;">"&lt;br/&gt;"</span>;
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"Redis key = &#160;"</span> . $<span style="color: #a0522d;">redisKey</span> . <span style="color: #8b2252;">"&lt;br/&gt;"</span>;
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"&#20197;&#19979;&#26159;&#20174;Redis&#33719;&#21462;&#30340;&#25968;&#25454;"</span>, <span style="color: #8b2252;">"&lt;br/&gt;"</span>;
// &#21462;&#25968;&#25454;<span style="color: #8b2252;">'</span>
<span style="color: #8b2252;">$redis = new Redis();</span>
<span style="color: #8b2252;">$redis-&gt;connect('</span>10.0.0.17<span style="color: #8b2252;">', 6379);</span>
<span style="color: #8b2252;">$redis-&gt;auth('</span>123456<span style="color: #8b2252;">');</span>
<span style="color: #8b2252;">echo $redis-&gt;get($redisKey);</span>
<span style="color: #8b2252;">?&gt;</span>
</pre>
</div>

<p>
访问 web 页面测试实现session保存在redis服务
</p>
</div>
</div>
<div id="outline-container-h:c5f3a4d4-2ed2-472d-89fe-7de824de83ae" class="outline-4">
<h4 id="h:c5f3a4d4-2ed2-472d-89fe-7de824de83ae">redis 主机验证 session 数据</h4>
<div class="outline-text-4" id="text-h:c5f3a4d4-2ed2-472d-89fe-7de824de83ae">
<p>
在10.0.0.17主机进行验证
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#redis-cli -h 10.0.0.17 -a 123456
10.0.0.17:6379&gt; keys *
1) <span style="color: #8b2252;">"PHPREDIS_SESSION:ad3nujfqfvcltkg2ml4snsf72h"</span>
10.0.0.17:6379&gt; get PHPREDIS_SESSION:ad3nujfqfvcltkg2ml4snsf72h
<span style="color: #8b2252;">"message|s:19:\"Hello, I'm in redis\";arr|a:6:</span>
<span style="color: #8b2252;">{i:0;i:1;i:1;i:2;i:2;i:3;i:3;i:4;i:4;i:5;i:5;i:6;}"</span>
</pre>
</div>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
