<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: Redis</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux: Redis</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:a6af2d15-a522-4411-b818-1c060f0fcf33">缓存技术</a>
<ul>
<li><a href="#h:dea987b0-be05-4ad5-bdbc-9d052e29c337">缓存 cache</a>
<ul>
<li><a href="#h:a51407d6-79c3-47c7-9b3c-09d094cd7a8c">buffer与cache</a></li>
<li><a href="#h:b225b13b-401b-479a-a90a-102d48807d3a">缓存保存位置及分层结构</a></li>
<li><a href="#h:e52c2a59-3498-40f3-8a1a-db3497728bea">cache 的特性</a></li>
</ul>
</li>
<li><a href="#h:857dec0d-3f75-44f4-b5bb-63c35304a6b5">用户层缓存</a>
<ul>
<li><a href="#h:d2850b77-2dde-4b89-a54c-485ca77488ec">DNS缓存</a></li>
<li><a href="#h:d344b27f-fcd6-488d-9053-b0a61afdbb6b">火狐浏览器缓存</a></li>
<li><a href="#h:fd85012b-5102-4c5f-8968-ee12fa2ac5d1">前端技术 dns-prefetch</a></li>
<li><a href="#h:b859e203-78a1-471a-a4aa-f77a2ca13611">浏览器缓存过期机制</a>
<ul>
<li><a href="#h:c319538a-a592-4401-b880-3629b7721871">最后修改时间 last-modified</a></li>
<li><a href="#h:ec8c00a0-cd18-41e1-a6d2-bacef3cb87bf">Etag标记</a></li>
<li><a href="#h:9774284f-16b7-4943-ab2d-752de4f21bca">过期时间 expires</a></li>
<li><a href="#h:1cdfe44f-4aea-43ca-b951-054f384a7cae">混合使用和缓存刷新</a></li>
</ul>
</li>
<li><a href="#h:65a37038-8b42-443e-b5a1-741da54c4060">cookie 和 session</a></li>
</ul>
</li>
<li><a href="#h:60a7cf67-3e71-4e39-b95c-2c490d63f72e">CDN 缓存</a>
<ul>
<li><a href="#h:8d6b7b8e-5ad9-4313-8fd5-e9c1cf85f2fa">什么是CDN</a></li>
<li><a href="#h:8cecffbe-cbad-42e5-a0f8-8b087e576ed4">用户请求CDN流程</a></li>
<li><a href="#h:11d2c43f-bce4-466d-b162-804b6a77ec26">利用 302 实现转发请求重定向至最优服务器集群</a></li>
<li><a href="#h:64d61030-6fac-4b93-8ee5-1474e14b4c4f">CDN 分层缓存</a></li>
<li><a href="#h:56d49769-08a4-4f79-9557-e7f3b1ba5cb6">CDN主要优势</a></li>
</ul>
</li>
<li><a href="#h:ed589014-f8ae-4c10-8efd-6cbe80556899">应用层缓存</a></li>
<li><a href="#h:1946c073-4163-43fb-a5ed-ed5654cd94be">数据层缓存</a></li>
<li><a href="#h:e31cf0eb-f64d-4b50-a39c-00834472ae62">硬件缓存</a>
<ul>
<li><a href="#h:39a78bab-4f3a-4345-a196-1dc1c09fc594">CPU缓存</a></li>
<li><a href="#h:bf34e737-93ef-4b3d-a634-28c8d916d01b">磁盘相关缓存</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:ea072d51-d060-48c8-8b4b-f3c504963016">redis 部署与使用</a>
<ul>
<li><a href="#h:b97d1623-d86e-4474-bd07-e124cfaa7bde">redis 基础</a>
<ul>
<li><a href="#h:4eba9e5b-e84d-4e60-9717-ffa6c065f889">NoSQL 数据库</a></li>
<li><a href="#h:87391e80-a760-4ddc-adb8-df082920a12a">redis 简介</a></li>
<li><a href="#h:4c2a4291-ea8f-4a72-a19c-12e13cd6c0ee">Redis 特性</a></li>
<li><a href="#h:0257c2eb-82c0-4e04-9155-734273b19c79">单线程</a></li>
<li><a href="#h:c2abbc50-d45a-40aa-b7e6-0f2493d0c0d2">redis 对比 memcached</a></li>
<li><a href="#h:4b006933-2b03-4ffa-a5f5-2d965760efe5">redis 典型应用场景</a></li>
<li><a href="#h:8f64f30f-161d-43f3-8a6b-f12bb230618f">缓存的实现流程</a></li>
</ul>
</li>
<li><a href="#h:f0839697-0c07-4683-b987-83f3bb13f771">Redis 安装及连接</a>
<ul>
<li><a href="#h:80c4953d-a99a-429b-8e30-67e7596f079a">yum安装redis</a>
<ul>
<li><a href="#h:92d06f46-907f-41b1-8471-06dcd419f4fb">查看yum仓库redis版本</a></li>
<li><a href="#h:41e6461a-995a-40f4-8f2c-1a5a4978029c">yum安装 redis</a></li>
</ul>
</li>
<li><a href="#h:9335c2fd-53ea-4b61-afd9-4dd865ef6332">编译安装 redis</a>
<ul>
<li><a href="#h:c17f962f-f65e-4629-9afe-e8f67223c747">编译安装</a></li>
<li><a href="#h:64a3dfaf-4424-426d-a066-d61799376201">前台启动 redis</a></li>
<li><a href="#h:1bd634b1-3738-48b8-a336-1777f1944299">解决启动时的三个警告提示</a></li>
<li><a href="#h:77c2b79d-cdaa-4f68-881a-bbc175fe1fc5">创建 redis 用户和设置数据目录权限</a></li>
<li><a href="#h:f772cdba-67a2-4e4a-904d-cf0935972bad">创建 redis 服务Service文件</a></li>
<li><a href="#h:e1d4d122-ca60-4029-aa18-ebbd62ec5e55">Redis通过Service方式启动</a></li>
<li><a href="#h:570f43eb-302d-406a-b6cb-6a94a43303dc">使用客户端连接 redis</a></li>
<li><a href="#h:f6ce9cc5-30c8-4b67-ac40-e5b76d32b93f">创建命令软链接</a></li>
<li><a href="#h:00e99a8f-197f-4b0d-8200-54a7dca1f27f">实战案例：一键编译安装Redis脚本</a></li>
</ul>
</li>
<li><a href="#h:fa21ac9d-8545-4ada-b6f3-bde3904e4853">redis 的多实例</a></li>
<li><a href="#h:8180d7e3-08b3-4012-b3b3-82f29546d43b">Redis相关工具和客户端链接</a>
<ul>
<li><a href="#h:ab8796b2-93a7-42ba-9ae4-f20098196ff8">安装后的相关程序介绍</a></li>
<li><a href="#h:08631eec-6423-46bb-8170-bc99a50aaf03">客户端连接 redis</a></li>
<li><a href="#h:33b26990-4555-4685-a102-466dee75b951">程序连接 Redis</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:159b05b6-5435-42bf-a757-c5044f0b0834">redis 配置管理</a>
<ul>
<li><a href="#h:244a1dfa-2acb-4d08-aa06-37522ceb45ae">redis 配置文件说明</a></li>
<li><a href="#h:c4bf4831-aabb-46b2-8261-c8db2ccb34e2">config 动态修改配置</a>
<ul>
<li><a href="#h:573f8d47-dec4-4731-9312-fbe8db968070">设置连接密码</a></li>
<li><a href="#h:7349f010-b4ad-40ac-8033-f191e2326d6e">获取当前配置</a></li>
<li><a href="#h:2fc3c18d-7ae2-420f-9d71-1a6a14344ff1">更改最大内存</a></li>
</ul>
</li>
<li><a href="#h:a980e636-5e44-43a1-a674-18c39bb4ca75">慢查询</a></li>
<li><a href="#h:6e8377e2-a62f-433e-9de4-f9d58d982b26">redis持久化</a>
<ul>
<li><a href="#h:731a3db5-15a5-4022-9c1f-c5304e399c0f">RDB 模式</a>
<ul>
<li><a href="#h:2e538282-72b3-479c-a84f-3316084a0949">RDB 模式工作原理</a></li>
<li><a href="#h:19801d1e-f047-49cb-b26a-460e67a1de6b">RDB 相关配置</a></li>
<li><a href="#h:ffce5007-2e92-4672-aa55-51d5a265f02b">实现RDB方式</a></li>
<li><a href="#h:58d3485d-aff2-466e-868c-03c22c2febd6">RDB 模式的优缺点</a></li>
</ul>
</li>
<li><a href="#h:779d3676-7ed0-44af-a969-1b619a1722e3">AOF 模式(完全数据+增量变化)</a>
<ul>
<li><a href="#h:6fbf0696-8c55-4886-93ab-74d70d096906">AOF 模式工作原理</a></li>
<li><a href="#h:0840198e-2c1c-4269-98d2-b40594e9f2c6">AOF 相关配置</a></li>
<li><a href="#h:e2bb9c90-55e3-4abe-b611-f740efb8d2a8">AOF rewrite 重写</a></li>
<li><a href="#h:af9cf730-1ab1-4337-9d3f-cc82c19345a7">手动执行AOF重写 BGREWRITEAOF 命令</a></li>
<li><a href="#h:8700b7f1-c86a-4d00-9691-e62a2dc0a627">AOF 模式优缺点</a></li>
</ul>
</li>
<li><a href="#h:750974de-2177-48f1-9c28-91fa2f996a2a">RDB和AOF 的选择</a></li>
</ul>
</li>
<li><a href="#h:8461587c-5dc0-412d-a7da-16ad6525bc33">Redis 常用命令</a>
<ul>
<li><a href="#h:1bd12177-fb09-4484-bbaf-11a7cf59d7a3">命令帮助</a></li>
<li><a href="#h:da6f1cc2-957d-4cff-b71a-b82b179c87c9">INFO</a></li>
<li><a href="#h:64114f97-7313-4be7-ae69-7293c114872f">SELECT</a></li>
<li><a href="#h:251c83a6-319f-4385-887b-5c4ae70c1938">KEYS</a></li>
<li><a href="#h:aa46e25b-10c6-4615-bfc1-e46e54e8aca7">SCAN</a></li>
<li><a href="#h:abe35a61-5f47-4c7a-9286-9b6fb4e6a0a2">BGSAVE</a></li>
<li><a href="#h:30d05e12-d9f1-42d7-9100-19bd73f81f8f">DBSIZE</a></li>
<li><a href="#h:783a4845-4094-4997-9606-bfe466e28858">FLUSHDB</a></li>
<li><a href="#h:772ad497-64b6-4838-924b-8154bbdf098f">FLUSHALL</a></li>
<li><a href="#h:704e13d5-dbf5-4b1d-9136-fda3fb11b2be">SHUTDOWN</a></li>
<li><a href="#h:83440a30-629c-433a-a1b5-becc88acbb4a">CLIENT LIST</a></li>
</ul>
</li>
<li><a href="#h:66748bf2-21ca-4144-a3f9-60ba873ca96d">redis 数据类型</a>
<ul>
<li><a href="#h:abf1e907-f26b-4b27-9ed0-526a075d2860">字符串 string</a>
<ul>
<li><a href="#h:79218a7e-fe97-4dea-b59c-b06077177733">添加一个key</a></li>
<li><a href="#h:30c750d0-3ef6-4cfd-886a-77a5d6223ac1">获取一个key的内容</a></li>
<li><a href="#h:61a14572-e433-409d-85a3-010dec172093">删除一个和多个key</a></li>
<li><a href="#h:fd8c70c2-afc5-4de3-b2ad-a7fa9be58bd3">批量设置多个key</a></li>
<li><a href="#h:7b4e6021-5ff4-49d3-9d53-f0b1320f98c3">批量获取多个key</a></li>
<li><a href="#h:810aa21a-f2cb-4c9a-ae0e-27460681e4ed">追加数据</a></li>
<li><a href="#h:ab51e4ce-1683-4d3d-b797-bfe01d06d674">设置新值并返回旧值</a></li>
<li><a href="#h:186d5506-77c6-431a-ae54-46ae680a24b2">返回字符串 key 对应值的字节数</a></li>
<li><a href="#h:129ecbb8-0be5-4bd8-a5d4-a32505342247">判断 key 是否存在</a></li>
<li><a href="#h:0794307b-4724-47e0-a8b4-4b0964939527">查看 key 的过期时间</a></li>
<li><a href="#h:8e82b373-afed-4117-af97-e955793ab021">重新设置key的过期时间</a></li>
<li><a href="#h:dc6abbea-6aa7-4a65-ae14-9f507f14b563">取消key的过期时间</a></li>
<li><a href="#h:f6eb90aa-4c7b-40e3-9d70-dd87856376f4">数值递增</a></li>
<li><a href="#h:2c1fb181-0deb-4c50-9eb4-c576204001d1">数值递减</a></li>
<li><a href="#h:4f4950d2-9c4b-4fb6-b254-444b4e7a9dec">数值增加</a></li>
<li><a href="#h:880d9462-d598-4cdf-92db-3b28622d5798">数据减少</a></li>
<li><a href="#h:5c287183-1e6b-4f0f-b9f9-8ce63f6dfa03">其他</a></li>
</ul>
</li>
<li><a href="#h:b6048900-90e3-4ffd-b755-368548205d64">列表 list</a>
<ul>
<li><a href="#h:1761b0d8-2a8c-4e1a-9c6c-117638fc782e">生成列表并插入数据</a></li>
<li><a href="#h:189f22ea-4fc7-47e1-a4b1-c980de04183f">向列表追加数据</a></li>
<li><a href="#h:8e5cf94c-0be1-4936-8a61-f7c38813723e">获取列表长度(元素个数)</a></li>
<li><a href="#h:3f03c2ef-dbda-497e-be22-aa687587de5f">获取列表指定位置数据</a></li>
<li><a href="#h:b13186bd-24e5-4130-9e73-32ed30fb92d1">修改列表指定索引值</a></li>
<li><a href="#h:72ffedc3-cc8d-40b3-9209-1a16ed7cbdd3">移除列表数据</a></li>
</ul>
</li>
<li><a href="#h:da24f22f-8890-49da-84a5-ea3261cbb4a8">集合 set</a>
<ul>
<li><a href="#h:0a852c43-393b-4513-bf72-c3b610132a36">生成集合key</a></li>
<li><a href="#h:e32451c0-93c6-4444-b0d1-6b48069aee61">追加数值</a></li>
<li><a href="#h:60d1d78c-46a2-493a-967a-9feff06cdf39">查看集合的所有数据</a></li>
<li><a href="#h:4a617feb-d8ba-4320-a49d-3bfdc3e4ccba">删除集合中的元素</a></li>
<li><a href="#h:60ba95bb-0fa3-4e1a-86b4-39e0654792bc">获取集合的交集</a></li>
<li><a href="#h:5e730d5a-63a9-4de4-9737-cfb2374631e0">获取集合的并集</a></li>
<li><a href="#h:801bf88b-24da-402b-83e6-13c2a0a32ff8">获取集合的差集</a></li>
</ul>
</li>
<li><a href="#h:7f8481ff-0ab1-4d1c-9d95-219b6e2bf04a">有序集合 sorted set</a>
<ul>
<li><a href="#h:8c7261c7-30bc-46a2-a0ce-b5773d3cfe27">生成有序集合</a></li>
<li><a href="#h:39ac203a-1a72-4a85-a896-82f54152cac8">有序集合实现排行榜</a></li>
<li><a href="#h:ee3c5aec-4409-494a-961a-d2fafd4c70ea">获取集合的个数</a></li>
<li><a href="#h:2ffa94f0-f80e-4aab-a0d7-5bd0c5690d59">基于索引返回数值</a></li>
<li><a href="#h:c73173ea-1c3e-4547-abee-4ac3f0886de1">返回某个数值的索引(排名)</a></li>
<li><a href="#h:8d08dedb-a72b-4624-a953-78bdf434cd90">获取分数</a></li>
<li><a href="#h:3f5837ca-b849-412c-9f83-0d742b36c290">删除元素</a></li>
</ul>
</li>
<li><a href="#h:6947339f-4ea1-4095-bd97-03e71e2362dd">哈希 hash</a>
<ul>
<li><a href="#h:04fb2815-7ab7-4b12-bbac-e222e01f12ef">生成 hash key</a></li>
<li><a href="#h:910a4c70-7c5e-4855-95e5-29429775db68">获取hash key的对应字段的值</a></li>
<li><a href="#h:c1cda36e-0d91-4695-8963-eaa7f302bd25">删除一个hash key 的对应字段</a></li>
<li><a href="#h:025b0adb-b8b1-44d9-a37b-8e92ead535b9">批量设置hash key的多个field和value</a></li>
<li><a href="#h:c622abf9-8ec8-410a-904b-25a6232b19c7">获取hash中指定字段的值</a></li>
<li><a href="#h:5ef55fde-cdb5-4e18-96da-c03dbe30ee92">获取hash中的所有字段名field</a></li>
<li><a href="#h:23831255-4e21-4f29-9136-10049cd20941">获取hash key对应所有field的value</a></li>
<li><a href="#h:a147ea57-372f-40ce-afa6-9547818f9545">获取指定hash key 的所有field及value</a></li>
<li><a href="#h:ebb88f9e-c57f-4b67-8253-20bf2085da60">删除 hash</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:483f5a95-1e22-4b62-8e95-aaaf8f1bb2c6">消息队列</a>
<ul>
<li><a href="#h:1ff21188-db73-4e9b-b789-23494c752177">生产者消费者模式</a>
<ul>
<li><a href="#h:f8f76eda-73c5-488d-9a4c-1adc16f2e92b">模式介绍</a></li>
<li><a href="#h:0cd89e11-5dac-4821-aacf-74cd35e73e5a">队列介绍</a></li>
<li><a href="#h:223586fb-576b-4fc8-b203-ff77abb723dc">生产者发布消息</a></li>
<li><a href="#h:47e03db1-7f5f-4b22-8170-c5863f031731">查看队列所有消息</a></li>
<li><a href="#h:634f139e-e964-4f1e-a080-e7051bbefea9">消费者消费消息</a></li>
<li><a href="#h:90b12e57-ef87-4d8c-be42-d8e5e1584428">再次验证队列消息</a></li>
</ul>
</li>
<li><a href="#h:ddd7f6b5-2e22-42db-b8db-702ced268059">发布者订阅模式</a>
<ul>
<li><a href="#h:3ffb7a1b-abb1-4a97-884d-e57ab33f41d6">模式简介</a></li>
<li><a href="#h:2b51f196-25b6-49e1-88f0-67ede54f25b6">订阅者监听频道</a></li>
<li><a href="#h:c6f81158-ab98-4281-b20b-eb4c80c13e9f">发布者发布消息</a></li>
<li><a href="#h:7966b69c-6e16-44de-9174-f0d2742f1b25">各个订阅者都能收到消息</a></li>
<li><a href="#h:93605942-6985-4786-bd77-f0eb24ca1bce">订阅多个频道</a></li>
<li><a href="#h:e36e5298-1225-4e1f-8fad-cc5395547a37">订阅所有频道</a></li>
<li><a href="#h:a335910e-368d-4aff-9b4c-c3b7a3af6f31">订阅匹配的频道</a></li>
<li><a href="#h:79376cd4-58ec-405f-a2d8-03d80663092f">取消订阅</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:c4e00568-007a-47a1-af09-bf7700f5d691">redis 集群与高可用</a>
<ul>
<li><a href="#h:dd906b8e-1f34-43bb-98bc-31576ef114b4">redis 主从复制</a>
<ul>
<li><a href="#h:a55e0464-ba6f-4623-b271-658fd040b37d">redis 主从复制架构</a></li>
<li><a href="#h:944dae69-007a-4324-9c52-ff6a6f1d1439">主从复制实现</a>
<ul>
<li><a href="#h:ce776bbd-4920-4231-b840-7225962bf7ee">命令行配置</a></li>
<li><a href="#h:8fda0922-026a-4f55-8f69-e3162a74fcda">同步日志</a></li>
<li><a href="#h:c2a7d9cc-ffa9-4832-9bbb-13ed22f47f3d">修改slave节点配置文件</a></li>
<li><a href="#h:7c19ab9e-df2a-485d-bec5-5e0f321383f5">master和slave查看状态</a></li>
<li><a href="#h:d6b7184e-2bf9-40a6-805d-19ceb5a329e0">slave 观察日志</a></li>
<li><a href="#h:9bf1651e-e2f4-42ab-9e7d-4a3ce319ed37">Master日志</a></li>
<li><a href="#h:263939dc-a0d6-4a63-832f-56d92b142fb8">slave 状态只读无法写入数据</a></li>
</ul>
</li>
<li><a href="#h:635fbe2a-b2c9-48f3-9e67-d47b42d958d6">主从复制故障恢复</a>
<ul>
<li><a href="#h:500f39b8-95bf-44e3-8564-32fe85f66d1f">主从复制故障恢复过程介绍</a></li>
<li><a href="#h:6a9342ae-aa37-4475-88bf-e8e479d95bf8">主从复制故障恢复实现</a></li>
</ul>
</li>
<li><a href="#h:56fbfcdb-5e53-4e0a-a745-09a7a8f43551">实现redis的级联复制</a></li>
<li><a href="#h:01c8702a-be1e-42b6-a662-fbcd643d979e">主从复制优化</a>
<ul>
<li><a href="#h:a5b1c702-6cec-489f-8ee5-14d33392b547">主从复制过程</a></li>
<li><a href="#h:d5fd8446-c069-44c0-bf4a-3622aa6ecc14">主从同步优化配置</a></li>
</ul>
</li>
<li><a href="#h:ac8a8d5b-68bf-4939-a6ca-e54e98d2dfb7">常见主从复制故障汇总</a>
<ul>
<li><a href="#h:155997e8-da25-47a2-8e8b-43b09d0f8ebf">配置不一致</a></li>
<li><a href="#h:d0f69643-ff38-40fc-a2a0-13776c0452c2">master密码不对</a></li>
<li><a href="#h:12f86fe0-c013-493d-9aff-884ffbbf5b3c">Redis版本不一致</a></li>
<li><a href="#h:6ee576d2-1ca6-49db-90c4-64dd291ad029">安全模式下无法远程连接</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:c93384a6-29aa-4905-b38b-2708f78a09e8">redis 哨兵(Sentinel)</a>
<ul>
<li><a href="#h:3c4bc08b-9769-4155-a362-031c57b9c9c7">redis 集群介绍</a></li>
<li><a href="#h:d74f3acb-4baf-4c95-9986-27b6c63158e9">哨兵 (Sentinel) 工作原理</a>
<ul>
<li><a href="#h:dfdc84c7-ce42-4562-a0ba-623e62614548">sentinel 架构和故障转移</a></li>
<li><a href="#h:47b76296-163b-41f1-8417-be352ed81d52">sentinel中的三个定时任务</a></li>
</ul>
</li>
<li><a href="#h:9bc146fd-4352-43b8-b735-f25c8449979d">实现哨兵</a>
<ul>
<li><a href="#h:d05ccf1f-4043-4a25-83d2-95b2d2f2f76d">哨兵的准备实现主从复制架构</a></li>
<li><a href="#h:30e8c863-7413-4838-9375-cbd1fd822dfd">编辑哨兵的配置文件</a></li>
<li><a href="#h:5dc5ed5d-2b4a-4a67-a34c-4679ae4e569b">启动哨兵</a></li>
<li><a href="#h:d968452a-ebcd-47fc-b7af-f34349b248bd">验证哨兵端口</a></li>
<li><a href="#h:8d087b23-a870-4f0a-8311-7d6440fb2d7e">查看哨兵日志</a></li>
<li><a href="#h:13c10c4d-0ed2-4e34-a8ed-013d0b42f67f">当前sentinel状态</a></li>
<li><a href="#h:78509e60-87d1-4d60-9134-223db8106977">停止Redis Master测试故障转移</a></li>
<li><a href="#h:499e043a-a485-40e3-9c18-e3db4da7febb">故障转移后的redis配置文件会被自动修改</a></li>
<li><a href="#h:60a9c99d-5e35-4fe5-be88-80b9754061fd">当前 redis状态</a></li>
<li><a href="#h:262555ee-f79f-494b-9c6d-b894dca510c8">恢复故障的原master重新加入redis集群</a></li>
</ul>
</li>
<li><a href="#h:97f47d06-aa66-47be-b55d-324792a4a0cf">sentinel 运维</a></li>
<li><a href="#h:d99c127b-9854-4705-bd43-436df7bc2579">应用程序如何连接 redis</a>
<ul>
<li><a href="#h:a95bf4fc-4f0e-43a3-8709-dcb7d97079ea">客户端连接 sentinel 工作原理</a></li>
<li><a href="#h:fe739214-75a8-404d-9da4-9b2b61dc95a8">java 连接Sentinel哨兵</a></li>
<li><a href="#h:5d76808c-43f0-4dcf-af9a-3aaac1345855">python 连接Sentinel哨兵</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:5fece8ea-3233-4abf-acca-a7e7853c9428">Redis Cluster</a>
<ul>
<li><a href="#h:2af434c2-c671-4dd0-9a03-e41ef09d8d9d">RedisCluster介绍</a></li>
<li><a href="#h:38114e18-9c29-4e51-9476-b4fd5c1cc48d">Redis cluster 架构</a>
<ul>
<li><a href="#h:95075901-04cd-4cd8-8f9f-bea25862b814">Redis cluster 架构</a></li>
<li><a href="#h:7636f6f4-cc3a-4602-9de0-02f35c4196f5">Redis cluster 的工作原理</a></li>
<li><a href="#h:bb0d7cc9-4a7c-4097-9b83-e732054c23d9">Redis Cluster 部署架构说明</a></li>
<li><a href="#h:dcea6b2e-7b9a-4b95-8b8a-c69003bbe4ef">部署方式介绍</a></li>
</ul>
</li>
<li><a href="#h:cdba74cb-9b97-41f8-8680-9d2ae0a74729">实战案例：基于Redis 5 的 redis cluster 部署</a>
<ul>
<li><a href="#h:d723f827-eb6f-47c5-84c8-46aaad49088e">创建 redis cluster集群的环境准备</a></li>
<li><a href="#h:d9895ddf-c4b9-4b80-9387-ef0cdfacce36">启用redis cluster 配置</a></li>
<li><a href="#h:92abd892-07b9-4a71-9e8b-6cb264731a64">创建集群</a></li>
<li><a href="#h:3f86e4a6-38f6-4d0e-a673-d3e7989fe19f">查看主从状态</a></li>
<li><a href="#h:cca53490-8353-405f-892f-dec1611a63a1">验证集群状态</a></li>
<li><a href="#h:a0dfaddd-893b-4d75-acfe-f7942568a49a">查看集群node对应关系</a></li>
<li><a href="#h:983b1fce-2d78-4c26-87f1-8f0d6b87831a">验证集群写入key</a></li>
<li><a href="#h:8f8b958a-2ca5-46fc-bb32-417ea5718ed4">python脚本实现RedisCluster集群写入</a></li>
<li><a href="#h:e9697094-501a-464c-86b1-94ae39369dc1">模拟master故障，对应的slave节点自动提升为新master</a></li>
</ul>
</li>
<li><a href="#h:287bcdf6-3cc2-49be-96f9-9119d2e9926b">原生命令手动部署</a>
<ul>
<li><a href="#h:dba39647-8e95-4b49-92f0-10995a629775">原生命令手动部署过程</a></li>
<li><a href="#h:11ea6c08-8576-4a32-9e49-3ed712dde9a4">实战案例: 利用原生命令手动部署redis cluster</a></li>
</ul>
</li>
<li><a href="#h:96d52a33-80da-4f8e-a1fe-da290f020183">实战案例：基于Redis 4 的 redis cluster 部署</a>
<ul>
<li><a href="#h:bd9a847e-b1ee-4b25-a0d5-a14f5eb1896c">准备redis Cluster 基本配置</a></li>
<li><a href="#h:3c7868d5-9a61-46dc-941b-771c2eb0c8a6">准备redis-trib.rb工具</a></li>
<li><a href="#h:c08b0801-08c4-4643-90f4-3552a7a0d32d">redis-trib.rb 命令用法</a></li>
<li><a href="#h:a5508c19-c6a3-43cd-a46f-1d08a8b38bad">修改 redis 登陆密码</a></li>
<li><a href="#h:6a434284-0f37-4ae9-b4e4-bd0d6dacaf7c">创建redis cluster集群</a></li>
<li><a href="#h:5916ef86-9099-48a7-ac08-6d60aea11296">查看 redis cluster 集群状态</a></li>
<li><a href="#h:b1406401-5efc-424e-b9f5-69e947d316c7">python脚本实现RedisCluster集群写入</a></li>
<li><a href="#h:aeec1c31-beb4-4def-bf49-c10e1e86326b">模拟 master 故障，对应的slave节点自动提升为新master</a></li>
</ul>
</li>
<li><a href="#h:ce4e414c-dba8-48c8-96d5-c1914b812a7c">Redis cluster管理</a>
<ul>
<li><a href="#h:e55d516d-5d50-4a43-b5c7-7d3619dbd05a">集群扩容</a></li>
<li><a href="#h:2a559576-d17e-40b2-944f-12990d673d4f">集群维护之动态缩容</a></li>
<li><a href="#h:ab5e7a88-bcfb-4f2f-99d2-371217d26996">集群维护之导入现有Redis数据至集群</a></li>
<li><a href="#h:f40a6764-c5cd-46aa-8d62-e1d56e1050d2">集群偏斜</a></li>
</ul>
</li>
<li><a href="#h:07b6abe2-e024-480b-8ae0-819379899ef6">redis cluster 的局限性</a>
<ul>
<li><a href="#h:16ff895a-7880-4771-b6c1-1a6b069a6794">集群的读写分离</a></li>
<li><a href="#h:ad4c89f9-bf54-400b-8501-17c4e4294df4">单机，哨兵和集群的选择</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:81bc8d2b-5167-4c6a-8628-feb49c6020aa">redis 扩展集群方案</a>
<ul>
<li><a href="#h:fac73ae2-1f3c-4664-80b5-df182feeb152">codis</a></li>
<li><a href="#h:650dbd99-c8ef-40a5-9472-3b65305c724b">twemproxy</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:3f464827-82ca-4da6-9afa-9fae572b29cf">常见面试题</a></li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../../index.html">Linux</a></li>
</ul>
<section id="outline-container-h:a6af2d15-a522-4411-b818-1c060f0fcf33" class="outline-2">
<h2 id="h:a6af2d15-a522-4411-b818-1c060f0fcf33">缓存技术</h2>
<div class="outline-text-2" id="text-h:a6af2d15-a522-4411-b818-1c060f0fcf33">
<p>
缓存cache是为了调节速度不一致的两个或多个不同的物质的速度，置于中间,可
以实现速度较快的一方加速访问速度较慢的一方的作用，比如CPU的一级、二级
缓存是保存了CPU最近经常访问的数据，内存是保存CPU经常访问硬盘的数据，而
且硬盘也有大小不一的缓存，甚至是物理服务器的raid卡有也缓存，都是为了起
到加速CPU访问硬盘数据的目的，因为CPU的速度太快了，CPU需要的数据由于硬
盘往往不能在短时间内满足CPU的需求，因此CPU缓存、内存、Raid卡缓存以及硬
盘缓存就在一定程度上满足了CPU的数据需求，即CPU从缓存读取数据,从而可以
大幅提高CPU的工作效率。
</p>


<figure id="org580e6a4">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021085418749.png" alt="20201021085418749.png">

</figure>

<p>
参考资料：<a href="http://www.sohu.com/a/246498483_468626">http://www.sohu.com/a/246498483_468626</a>
</p>
</div>
<div id="outline-container-h:dea987b0-be05-4ad5-bdbc-9d052e29c337" class="outline-3">
<h3 id="h:dea987b0-be05-4ad5-bdbc-9d052e29c337">缓存 cache</h3>
<div class="outline-text-3" id="text-h:dea987b0-be05-4ad5-bdbc-9d052e29c337">
</div>
<div id="outline-container-h:a51407d6-79c3-47c7-9b3c-09d094cd7a8c" class="outline-4">
<h4 id="h:a51407d6-79c3-47c7-9b3c-09d094cd7a8c">buffer与cache</h4>
<div class="outline-text-4" id="text-h:a51407d6-79c3-47c7-9b3c-09d094cd7a8c">
<p>
buffer：缓冲,也叫写缓冲，一般用于写操作，可以将数据先写入内存在写入磁
盘，buffer一般用于写缓冲，用于解决不同介质的速度不一致的缓冲，先将数据
临时写入到里自己最近的地方，以提高写入速度，CPU会把数据先写到内存的磁
盘缓冲区，然后应用就认为数据已经写入完成，然后由内核在后续的时间再写入
磁盘，所以服务器突然断电会丢失内存中的部分数据。
</p>

<p>
cache：缓存,也叫读缓存，一般用于读操作，CPU读文件从内存读，如果内存没
有,就先从硬盘读到内存再读到CPU，将需要频繁读取的数据放在里自己最近的缓
存区域，下次读取的时候即可快速读取。
</p>

<p>
向 /proc/sys/vm/drop_caches写入相应的修改值，会清理缓存。建议先执行
sync（sync命令将所有未写的系统缓冲区写到磁盘中，包含已修改的 i-node、
已延迟的块I/O 和读写映射文件）。执行echo 1、2、3 至
/proc/sys/vm/drop_caches,达到不同的清理目的
</p>

<p>
如果因为是应用有像内存泄露、溢出的问题时，从swap的使用情况是可以比较快
速可以判断的，但通过执行free反而比较难查看。但核心并不会因为内存泄露等
问题并没有快速清空buffer或cache（默认值是0），生产也不应该随便去改变此
值。
</p>

<p>
一般情况下，应用在系统上稳定运行了，free值也会保持在一个稳定值的。当发
生内存不足、应用获取不到可用内存、OOM错误等问题时，还是更应该去分析应
用方面的原因，否则，清空buffer，强制腾出free的大小，可能只是把问题给暂
时屏蔽了。
</p>

<p>
排除内存不足的情况外，除非是在软件开发阶段，需要临时清掉buffer，以判断
应用的内存使用情况；或应用已经不再提供支持，即使应用对内存的时候确实有
问题，而且无法避免的情况下，才考虑定时清空buffer。
</p>

<p>
范例：man proc
</p>

<div class="org-src-container">
<pre class="src src-sh">...&#30465;&#30053;...
To free pagecache, use:
<span style="color: #483d8b;">echo</span> 1 &gt; /proc/sys/vm/drop_caches

To free dentries and inodes, use:
<span style="color: #483d8b;">echo</span> 2 &gt; /proc/sys/vm/drop_caches

To free pagecache, dentries and inodes, use:
<span style="color: #483d8b;">echo</span> 3 &gt; /proc/sys/vm/drop_caches

Because writing to this file is a nondestructive operation and dirty objects
are not freeable, the user should run sync(1) first.
</pre>
</div>

<p>
范例：清理缓存
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /proc/sys/vm/drop_caches 
0
[root@centos8 ~]#free -h
              total        used        free      shared  buff/cache   available
Mem:          798Mi       198Mi        60Mi       0.0Ki       538Mi       468Mi
Swap:         2.0Gi       9.0Mi       2.0Gi
[root@centos8 ~]#echo 3 &gt; /proc/sys/vm/drop_caches 
[root@centos8 ~]#free -h
              total        used        free      shared  buff/cache   available
Mem:          798Mi       247Mi       408Mi       1.0Mi       142Mi       426Mi
Swap:         2.0Gi       9.0Mi       2.0Gi
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b225b13b-401b-479a-a90a-102d48807d3a" class="outline-4">
<h4 id="h:b225b13b-401b-479a-a90a-102d48807d3a">缓存保存位置及分层结构</h4>
<div class="outline-text-4" id="text-h:b225b13b-401b-479a-a90a-102d48807d3a">
<p>
互联网应用领域，提到缓存为王
</p>

<ul class="org-ul">
<li>用户层: 浏览器DNS缓存,应用程序DNS缓存,操作系统DNS缓存客户端</li>
<li>代理层: CDN,反向代理缓存</li>
<li>Web层: 解释器Opcache,Web服务器缓存</li>
<li>应用层: 页面静态化</li>
<li>数据层: 分布式缓存,数据库</li>
<li>系统层: 操作系统cache</li>
<li>物理层: 磁盘cache, Raid Cache</li>
</ul>
</div>
</div>
<div id="outline-container-h:e52c2a59-3498-40f3-8a1a-db3497728bea" class="outline-4">
<h4 id="h:e52c2a59-3498-40f3-8a1a-db3497728bea">cache 的特性</h4>
<div class="outline-text-4" id="text-h:e52c2a59-3498-40f3-8a1a-db3497728bea">
<p>
自动过期：给缓存的数据加上有效时间，超出时间后自动过期删除
</p>

<p>
强制过期：源网站更新图片后CDN是不会更新的，需要强制图片缓存过期，通过
CDN管理后台实现
</p>

<p>
命中率：即缓存的读取命中率
</p>
</div>
</div>
</div>
<div id="outline-container-h:857dec0d-3f75-44f4-b5bb-63c35304a6b5" class="outline-3">
<h3 id="h:857dec0d-3f75-44f4-b5bb-63c35304a6b5">用户层缓存</h3>
<div class="outline-text-3" id="text-h:857dec0d-3f75-44f4-b5bb-63c35304a6b5">
</div>
<div id="outline-container-h:d2850b77-2dde-4b89-a54c-485ca77488ec" class="outline-4">
<h4 id="h:d2850b77-2dde-4b89-a54c-485ca77488ec">DNS缓存</h4>
<div class="outline-text-4" id="text-h:d2850b77-2dde-4b89-a54c-485ca77488ec">
<p>
浏览器的DNS缓存默认为60秒，即60秒之内在访问同一个域名就不再进行DNS解析
</p>

<p>
范例：查看chrome浏览器的DNS缓存
</p>

<p>
注意：此方式新版的chrome 基于安全原因不再显示缓存信息
</p>

<p>
在浏览器的地址栏上输入：
</p>

<p>
chrome://net-internals/#dns
</p>


<figure id="org6ebc29b">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021193400207.png" alt="20201021193400207.png">

</figure>
</div>
</div>
<div id="outline-container-h:d344b27f-fcd6-488d-9053-b0a61afdbb6b" class="outline-4">
<h4 id="h:d344b27f-fcd6-488d-9053-b0a61afdbb6b">火狐浏览器缓存</h4>
<div class="outline-text-4" id="text-h:d344b27f-fcd6-488d-9053-b0a61afdbb6b">
<p>
地址栏输入下面指令可以查看Firefox的缓存信息
</p>

<div class="org-src-container">
<pre class="src src-sh">about:cache 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fd85012b-5102-4c5f-8968-ee12fa2ac5d1" class="outline-4">
<h4 id="h:fd85012b-5102-4c5f-8968-ee12fa2ac5d1">前端技术 dns-prefetch</h4>
<div class="outline-text-4" id="text-h:fd85012b-5102-4c5f-8968-ee12fa2ac5d1">
<p>
HTML5的新特性, 可以在html文件中进行DNS的 Prefetch
</p>


<figure id="orgef136aa">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021193854330.png" alt="20201021193854330.png">

</figure>
</div>
</div>
<div id="outline-container-h:b859e203-78a1-471a-a4aa-f77a2ca13611" class="outline-4">
<h4 id="h:b859e203-78a1-471a-a4aa-f77a2ca13611">浏览器缓存过期机制</h4>
<div class="outline-text-4" id="text-h:b859e203-78a1-471a-a4aa-f77a2ca13611">
</div>
<div id="outline-container-h:c319538a-a592-4401-b880-3629b7721871" class="outline-5">
<h5 id="h:c319538a-a592-4401-b880-3629b7721871">最后修改时间 last-modified</h5>
<div class="outline-text-5" id="text-h:c319538a-a592-4401-b880-3629b7721871">
<p>
Last-Modified 是 HttpHeader 中的资源的最后修改时间，如果带有
Last-Modified ，下一次发送 Http请求时，将会发生带 If-modified-since 的
HttpHeader 。如果没有过期，将会收到 304 的响应，从缓存中读取。
</p>

<p>
浏览器请求文件时,会先获取服务器的文件的最后修改时间，再和本地浏览器缓
存中的文件时间相比，如果没有发生变化就返回给浏览器304的状态码，表示没
有发生变化，然后浏览器就使用的本地的缓存展示资源,如果变化,则重新再一次
向服务器请求资源
</p>

<p>
此方式也需要向服务器发送请求才可以使用缓存
</p>


<figure id="org7674403">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021195323596.png" alt="20201021195323596.png">

</figure>
</div>
</div>
<div id="outline-container-h:ec8c00a0-cd18-41e1-a6d2-bacef3cb87bf" class="outline-5">
<h5 id="h:ec8c00a0-cd18-41e1-a6d2-bacef3cb87bf">Etag标记</h5>
<div class="outline-text-5" id="text-h:ec8c00a0-cd18-41e1-a6d2-bacef3cb87bf">
<p>
Etag 是 HttpHeader 中代表资源的标签，在服务器端生成。如果带有 Etag，下
一次发送带 Etag 的请求，如果 Etag 没有变化将收到 304的响应，从缓存中读
取。
</p>

<p>
基于Etag标记是否一致做判断页面是否发生过变化，比如基于Nginx 的etag
on来实现。
</p>

<p>
Etag 在使用时要注意相同资源多台 Web 服务器的 Etag 的一致性
</p>

<p>
此方式也需要向服务器发送请求才可以使用缓存
</p>
</div>
</div>
<div id="outline-container-h:9774284f-16b7-4943-ab2d-752de4f21bca" class="outline-5">
<h5 id="h:9774284f-16b7-4943-ab2d-752de4f21bca">过期时间 expires</h5>
<div class="outline-text-5" id="text-h:9774284f-16b7-4943-ab2d-752de4f21bca">
<p>
以上两种都需要发送请求，即不管资源是否过期都要发送请求进行协商，这样会消耗不必要的时间，因此有了缓存的过期时间
</p>

<p>
Expire 是 HttpHeader 中代表资源的过期时间，由服务器端设置。如果带有
Expire ，则在 Expire 过期前不会发生 Http请求，直接从缓存中读取。用户强
制 F5 例外
</p>

<p>
第一次请求资源时,响应报文带有资源的过期时间，默认为30天，当前此方式使
用的比较多，但是无法保证客户的时间都是准确并且一致的，因此会加入一个最
大生存周期，使用用户本地的时间计算缓存数据是否超过多少天，下面的过期时
间Expires:为2028年，但是缓存的最大生存周期Cache-Control: max-age=315360000，计算为天等于3650天即10年
</p>


<figure id="org7317637">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021195431792.png" alt="20201021195431792.png">

</figure>
</div>
</div>
<div id="outline-container-h:1cdfe44f-4aea-43ca-b951-054f384a7cae" class="outline-5">
<h5 id="h:1cdfe44f-4aea-43ca-b951-054f384a7cae">混合使用和缓存刷新</h5>
<div class="outline-text-5" id="text-h:1cdfe44f-4aea-43ca-b951-054f384a7cae">
<p>
通常 Last-Modified,Etag,Expire 是一起混合使用的
</p>

<ul class="org-ul">
<li>特别是 Last-Modified 和 Expire 经常一起使用，因为 Expire可以让浏览器
完全不发起 Http 请求，而当浏览器强制 F5 的时候又有Last-Modified ，这
样就很好的达到了浏览器段缓存的效果。</li>
<li>Etag 和 Expire 一起使用时，先判断 Expire ，如果已经过期，再发起 Http
请求，如果 Etag 变化了，则返回 200 响应。如果 Etag 没有变化,则返回
304响应。</li>
<li>Last-Modified,Etag,Expires 三个同时使用时。先判断 Expire ，然后发送
Http 请求，服务器先判断 last-modified ，再判断 Etag，必须都没有过期，
才能返回 304 响应。</li>
</ul>

<p>
缓存刷新
</p>

<ul class="org-ul">
<li>第一次访问,获取最新数据,返回 200响应码</li>
<li>鼠标点击二次访问(Cache),输入地址后回车,浏览器对所有没有过期的内容直
接使用本地缓存。</li>
<li>F5或点刷新按钮,会向服务器发送请求缓存协商信息,last-modified和etag会
有影响,但expires本地过期时间不受影响,无变化返回304</li>
<li>按Ctrl+F5强制刷新,所有缓存不再使用,直接连接服务器,获取最新数据,返回200响应码</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:65a37038-8b42-443e-b5a1-741da54c4060" class="outline-4">
<h4 id="h:65a37038-8b42-443e-b5a1-741da54c4060">cookie 和 session</h4>
<div class="outline-text-4" id="text-h:65a37038-8b42-443e-b5a1-741da54c4060">
<p>
Cookie是访问某些网站以后在本地存储的一些网站相关的信息，下次再访问的时候减少一些步骤,比如加密后的账户名密码等信息
</p>

<p>
Cookies是服务器在客户端浏览器上存储的小段文本并随每一个请求发送至同一个服务器，是一种实现客户端保持状态的方案。
</p>

<p>
session称为会话信息，位于web服务器上，主要负责访问者与网站之间的交互，当浏览器请求http地址时，可以基于之前的session实现会话保持、session共享等。
</p>
</div>
</div>
</div>
<div id="outline-container-h:60a7cf67-3e71-4e39-b95c-2c490d63f72e" class="outline-3">
<h3 id="h:60a7cf67-3e71-4e39-b95c-2c490d63f72e">CDN 缓存</h3>
<div class="outline-text-3" id="text-h:60a7cf67-3e71-4e39-b95c-2c490d63f72e">
</div>
<div id="outline-container-h:8d6b7b8e-5ad9-4313-8fd5-e9c1cf85f2fa" class="outline-4">
<h4 id="h:8d6b7b8e-5ad9-4313-8fd5-e9c1cf85f2fa">什么是CDN</h4>
<div class="outline-text-4" id="text-h:8d6b7b8e-5ad9-4313-8fd5-e9c1cf85f2fa">

<figure id="org77a9bf6">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021200737183.png" alt="20201021200737183.png">

</figure>


<figure id="org28bd1c5">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021200826610.png" alt="20201021200826610.png">

</figure>

<p>
内容分发网络（Content Delivery Network，CDN）是建立并覆盖在承载网上，
由不同区域的服务器组成的分布式网络。将源站资源缓存到全国各地的边缘服务
器，利用全球调度系统使用户能够就近获取，有效降低访问延迟，降低源站压力,提
升服务可用性。
</p>

<p>
<b>常见的CDN服务商</b>
</p>
<ul class="org-ul">
<li>百度CDN：<a href="https://cloud.baidu.com/product/cdn.html">https://cloud.baidu.com/product/cdn.html</a></li>
<li>阿里CDN：<a href="https://www.aliyun.com/product/cdn?spm=5176.8269123.416540.50.728y8n">https://www.aliyun.com/product/cdn?spm=5176.8269123.416540.50.728y8n</a></li>
<li>腾讯CDN：<a href="https://www.qcloud.com/product/cdn">https://www.qcloud.com/product/cdn</a></li>
<li>腾讯云CDN收费介绍：<a href="https://cloud.tencent.com/document/product/228/2949">https://cloud.tencent.com/document/product/228/2949</a></li>
</ul>
</div>
</div>
<div id="outline-container-h:8cecffbe-cbad-42e5-a0f8-8b087e576ed4" class="outline-4">
<h4 id="h:8cecffbe-cbad-42e5-a0f8-8b087e576ed4">用户请求CDN流程</h4>
<div class="outline-text-4" id="text-h:8cecffbe-cbad-42e5-a0f8-8b087e576ed4">
<p>
假设您的业务源站域名为 www.test.com ，域名接入 CDN开始使用加速服务后，
当您的用户发起HTTP请求时，实际的处理流程如下图所示
</p>


<figure id="org7be4003">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021201219292.png" alt="20201021201219292.png">

</figure>

<p>
<b>详细说明如下：</b>
</p>

<ol class="org-ol">
<li>用户向 www.test.com 下的某图片资源（如：1.jpg）发起请求，会先向
Local DNS 发起域名解析请求。</li>
<li>当 Local DNS 解析 www.test.com 时，会发现已经配置了 CNAME
www.test.com.cdn.dnsv1.com ，解析请求会发送至 Tencent DNS（GSLB），
GSLB 为腾讯云自主研发的调度体系，会为请求分配最佳节点IP。</li>
<li>Local DNS 获取 Tencent DNS 返回的解析 IP。</li>
<li>用户获取解析 IP。</li>
<li>用户向获取的 IP 发起对资源 1.jpg 的访问请求。</li>
<li><p>
若该 IP 对应的节点缓存有1.jpg，则会将数据直接返回给用户（10），此时
请求结束。若该节点未缓存1.jpg，则节点会向业务源站发起对 1.jpg的请求
（6、7、8），获取资源后，结合用户自定义配置的缓存策略，将资源缓存至
节点（9），并返回给用户（10），此时请求结束。
</p>


<figure id="org0e08011">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/2020102120153645.png" alt="2020102120153645.png">

</figure></li>
</ol>
</div>
</div>
<div id="outline-container-h:11d2c43f-bce4-466d-b162-804b6a77ec26" class="outline-4">
<h4 id="h:11d2c43f-bce4-466d-b162-804b6a77ec26">利用 302 实现转发请求重定向至最优服务器集群</h4>
<div class="outline-text-4" id="text-h:11d2c43f-bce4-466d-b162-804b6a77ec26">
<p>
因为中国网络较为复杂，依赖DNS就近解析的调度，仍然会存在部分请求调度失效、调度生效慢等问题。
</p>

<p>
比如:腾讯云利用在全国部署的302重定向服务器集群，能够为每一个请求实时决
策最优的服务器资源，精准解决小运营商的调度问题，提升用户访问质量,能最
快地把用户引导到最优的服务器节点上，避开性能差或者异常的节点。
</p>


<figure id="orgd1af8dd">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/202010212018559.png" alt="202010212018559.png">

</figure>
</div>
</div>
<div id="outline-container-h:64d61030-6fac-4b93-8ee5-1474e14b4c4f" class="outline-4">
<h4 id="h:64d61030-6fac-4b93-8ee5-1474e14b4c4f">CDN 分层缓存</h4>
<div class="outline-text-4" id="text-h:64d61030-6fac-4b93-8ee5-1474e14b4c4f">
<p>
提前对静态内容进行预缓存，避免大量的请求回源，导致主站网络带宽被打满而
导致数据无法更新，另外CDN可以将数据根据访问的热度不同而进行不同级别的
缓存，例如:访问量最高的资源访问CDN边缘节点的内存，其次的放在SSD或者
SATA，再其次的放在云存储，这样兼顾了速度与成本。
</p>

<p>
比如:腾讯云CDN节点，根据用户的数据冷热不同，动态的进行识别，按照cache
层次进行数据的存储，在访问频率到40%-90%的数据，首先放在OC边缘节点内存
cache中，提供8G-64G的数据空间存储;在访问频率到30%-50%的数据，放在OC节
点SSD/SATA硬盘cache中，提供1T-15T的数据空间存猪，其他的比较冷的数据，
放在云存储中，采用回源拉取的方式进行处理。这样在成本和效率中计算出最优
平衡点，为客户提供服务。
</p>


<figure id="org77a58b9">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021202027851.png" alt="20201021202027851.png">

</figure>
</div>
</div>
<div id="outline-container-h:56d49769-08a4-4f79-9557-e7f3b1ba5cb6" class="outline-4">
<h4 id="h:56d49769-08a4-4f79-9557-e7f3b1ba5cb6">CDN主要优势</h4>
<div class="outline-text-4" id="text-h:56d49769-08a4-4f79-9557-e7f3b1ba5cb6">
<p>
CDN 有效地解决了目前互联网业务中网络层面的以下问题：
</p>

<ul class="org-ul">
<li>用户与业务服务器地域间物理距离较远，需要进行多次网络转发，传输延时较高且不稳定。</li>
<li>用户使用运营商与业务服务器所在运营商不同，请求需要运营商之间进行互联转发。</li>
<li>业务服务器网络带宽、处理能力有限，当接收到海量用户请求时，会导致响应速度降低、可用性降低。</li>
<li>利用CDN防止和抵御DDos等攻击,实现安全保护</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:ed589014-f8ae-4c10-8efd-6cbe80556899" class="outline-3">
<h3 id="h:ed589014-f8ae-4c10-8efd-6cbe80556899">应用层缓存</h3>
<div class="outline-text-3" id="text-h:ed589014-f8ae-4c10-8efd-6cbe80556899">
<p>
Nginx、PHP等web服务可以设置应用缓存以加速响应用户请求，另外有些解释性
语言，比如：PHP/Python/Java不能直接运行，需要先编译成字节码，但字节码
需要解释器解释为机器码之后才能执行，因此字节码也是一种缓存，有时候还会
出现程序代码上线后字节码没有更新的现象。所以一般上线新版前,需要先将应
用缓存清理,再上线新版
</p>

<p>
另外可以利用动态页面静态化技术,加速访问,比如:将访问数据库的数据的动态
页面,提前用程序生成静态页面文件html.电商网站的商品介绍,评论信息非实时
数据等皆可利用此技术实现
</p>
</div>
</div>
<div id="outline-container-h:1946c073-4163-43fb-a5ed-ed5654cd94be" class="outline-3">
<h3 id="h:1946c073-4163-43fb-a5ed-ed5654cd94be">数据层缓存</h3>
<div class="outline-text-3" id="text-h:1946c073-4163-43fb-a5ed-ed5654cd94be">
<p>
分布式缓存服务
</p>

<ul class="org-ul">
<li>Redis</li>
<li>Memcached</li>
</ul>

<p>
数据库
</p>

<ul class="org-ul">
<li>MySQL 查询缓存</li>
<li>innodb缓存、MyISAM缓存</li>
</ul>
</div>
</div>
<div id="outline-container-h:e31cf0eb-f64d-4b50-a39c-00834472ae62" class="outline-3">
<h3 id="h:e31cf0eb-f64d-4b50-a39c-00834472ae62">硬件缓存</h3>
<div class="outline-text-3" id="text-h:e31cf0eb-f64d-4b50-a39c-00834472ae62">
</div>
<div id="outline-container-h:39a78bab-4f3a-4345-a196-1dc1c09fc594" class="outline-4">
<h4 id="h:39a78bab-4f3a-4345-a196-1dc1c09fc594">CPU缓存</h4>
<div class="outline-text-4" id="text-h:39a78bab-4f3a-4345-a196-1dc1c09fc594">
<p>
CPU缓存(L1的数据缓存和L1的指令缓存)、二级缓存、三级缓存
</p>


<figure id="org35a81a1">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021210113579.png" alt="20201021210113579.png">

</figure>


<figure id="org643d41a">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021210230689.png" alt="20201021210230689.png">

</figure>
</div>
</div>
<div id="outline-container-h:bf34e737-93ef-4b3d-a634-28c8d916d01b" class="outline-4">
<h4 id="h:bf34e737-93ef-4b3d-a634-28c8d916d01b">磁盘相关缓存</h4>
<div class="outline-text-4" id="text-h:bf34e737-93ef-4b3d-a634-28c8d916d01b">
<ul class="org-ul">
<li>磁盘缓存：Disk Cache</li>
<li>磁盘阵列缓存：Raid Cache，可使用电池防止断电丢失数据</li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-h:ea072d51-d060-48c8-8b4b-f3c504963016" class="outline-2">
<h2 id="h:ea072d51-d060-48c8-8b4b-f3c504963016">redis 部署与使用</h2>
<div class="outline-text-2" id="text-h:ea072d51-d060-48c8-8b4b-f3c504963016">
</div>
<div id="outline-container-h:b97d1623-d86e-4474-bd07-e124cfaa7bde" class="outline-3">
<h3 id="h:b97d1623-d86e-4474-bd07-e124cfaa7bde">redis 基础</h3>
<div class="outline-text-3" id="text-h:b97d1623-d86e-4474-bd07-e124cfaa7bde">
</div>
<div id="outline-container-h:4eba9e5b-e84d-4e60-9717-ffa6c065f889" class="outline-4">
<h4 id="h:4eba9e5b-e84d-4e60-9717-ffa6c065f889">NoSQL 数据库</h4>
<div class="outline-text-4" id="text-h:4eba9e5b-e84d-4e60-9717-ffa6c065f889">
<p>
<b>什么是NOSQL</b>
</p>

<p>
数据库主要分为两大类:关系型数据库与NoSQL数据库。
</p>

<p>
关系型数据库，是建立在关系模型基础上的数据库，其借助于集合代数等数学概念和方法来处理数据库中的数据。主流的MySQL、Oracle、MSSQL Server和DB2都属于这类传统数据库。
</p>

<p>
NoSQL数据库，全称为Not OnlySQ，意思就是适用关系型数据库的时候就使用关系型数据库，不适用的时候可以考虑使用更加合适的数据存储。NoSQL是对不同于传统的关系型数据库的数据库管理系统的统称。
</p>

<p>
NoSQL用于超大规模数据的存储。(例如谷歌或Facebook每天为他们的月用户收集万亿比特的数据)。这些类型的数据存储不需要固定的模式，无需多余操作就可以横向扩展。
</p>

<p>
<b>NoSQL起源</b>
</p>

<p>
NoSQL一词最早出现于1998年，是Carlo Strozzi开发的一个轻量、开源、不提供SQL功能的关系数据库。
</p>

<p>
2009年，Last.fm的Johan Oskarsson发起了一次关于分布式开源数据库的讨论，来自Rackspace的Eric Evans再次提出了NoSQL的概念，这时的NoSQL主要指非关系型、分布式、不提供ACID的数据库设计模式。
</p>

<p>
2009年在亚特兰大举行的"no:sql(east)"讨论会是一个里程碑，其口号是"select fun, profit from real_world where relational=false;"。因此，对NoSQL最普遍的解释是"非关联型的"，强调Key-Value Stores和文档数据库的优点，而不是单纯的反对RDBMS。
</p>

<p>
<b>为什么使用NoSQL</b>
</p>

<p>
Oracle，MySQL等传统的关系数据库非常成熟并且已大规模商用，为什么还要用NoSQL数据库呢?
</p>

<p>
主要是由于随着互联网发展，数据量越来越大，对性能要求越来越高，传统数据库存在着先天性的缺陷，即单机(单库)性能瓶颈，并且扩展困难。这样既有单机单库瓶颈，却又扩展困难，自然无法满足日益增长的海量数据布存储及其性能要求，所以才会出现了各种不同的NoSQL产品，NoSQL根本性的优势在于在云计算时代，简单、易于大规模分布式扩展，并且读写性能非常高。
</p>

<p>
通过第三方平台(如:Google，Facebook等)可以很容易的访问问和抓取数据。用户的个人信息，社交网络，地理位置，用户生成的数据和用户操作日志已经成倍的增加。如果要对这些用户数据进行挖掘，那SQL数据库已经不适合这些应用了，NoSQL数据库的发展却能很好的处理这些大的数据。
</p>

<p>
<b>RDBMS和NOSQL对比</b>
</p>

<p>
RDBMS
</p>
<ul class="org-ul">
<li>高度组织化结构化数据</li>
<li>结构化查询语言(SQL)</li>
<li>数据和关系都存储在单独的表中。</li>
<li>数据操纵语言，数据定义语言</li>
<li>严格的一致性</li>
<li>基础事务</li>
</ul>

<p>
NOSQL
</p>
<ul class="org-ul">
<li>代表着不仅仅是SQL，没有声明性查询语言</li>
<li>没有预定义的模式</li>
<li>最终一致性，而非ACID属性</li>
<li>非结构化和不可预知的数据</li>
<li>CAP定理</li>
<li>高性能，高可用性和可伸缩性</li>
</ul>

<p>
<b>RDBMS和NOSQL的特点及优缺点：</b>
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">关系型数据库</th>
<th scope="col" class="org-left">NoSQL数据库</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">特点</td>
<td class="org-left">数据关系模型基于关系模型,结构化存储,完整性约束</td>
<td class="org-left">非结构化的存储</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">基于二维表及其之间的联系,需要连接、并、交、差、除等数据操作</td>
<td class="org-left">基于多维关系模型</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">采用结构化的查询语言(SQL)做数据读写</td>
<td class="org-left">具有特有的使用场景</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">操作需要数据的一致性，需要事务甚至是强一致性</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">优点</td>
<td class="org-left">保持数据的一致性(事务处理)</td>
<td class="org-left">保持数据的一致性(事务处理)</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">可以进行join等复杂查询</td>
<td class="org-left">基本支持分布式,易于扩展,可伸缩</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">通用化,技术成熟</td>
<td class="org-left">简单，弱结构化存储</td>
</tr>

<tr>
<td class="org-left">缺点</td>
<td class="org-left">数据读写必须经过sql解析,大量数据、高并发下读写性能不足</td>
<td class="org-left">join等复杂操作能力较弱</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">对数据做读写,或修改数据结构时需要加锁，影响并发操作</td>
<td class="org-left">事务支持较弱</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">无法适应非结构化存储</td>
<td class="org-left">通用性差</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">通用性差</td>
<td class="org-left">无完整约束复杂业务场景支持较差</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">昂贵、复杂</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
<b>CAP定理(CAP theorem)</b>
</p>

<p>
在计算机科学中，CAP定理(CAP theorem)，又被称为布鲁尔定理(Brewer's theorem)，它指出对于一个分布式计算系统来说，不可能同时满足以下三点:
</p>
<ul class="org-ul">
<li><b>一致性(Consistency)</b>: 所有节点在同一时间具有相同的数据</li>
<li><b>可用性(Availability)</b>: 保证每个请求不管成功或者失败都有响应</li>
<li><b>分区容忍(Partition tolerance)</b>: 系统中任意信息的丢失或失败不会影响系统的继续运作</li>
</ul>

<p>
CAP理论的核心是:一个分布式系统不可能同时很好的满足一致性，可用性和分区容错性这三个需求，最多只能同时较好的满足两个。
</p>

<p>
因此，根据CAP原理将NoSQL数据库分成了满足CA原则、满足CCP原则和满足AP原则三大类:
</p>
<ul class="org-ul">
<li>CA-单点集群，满足一致性，可用性的系统，通常在可扩展性上不太强大。</li>
<li>CP-满足一致性，分区容忍性的系统，通常性能不是特别高。</li>
<li>AP-满足可用性，分区容忍性的系统，通常可能对一致性要求低一些。</li>
</ul>



<figure id="orga5097e5">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/img_20250815_174227.png" alt="img_20250815_174227.png" width="50%">

</figure>

<p>
<b>NoSQL数据库分类</b>
</p>

<ul class="org-ul">
<li>列存储
<ul class="org-ul">
<li>顾名思义，是按列存储数据的。最大的特点是方便存储结构化和半结构化数据，方便做数据压缩，对针对某一列或者某几列的查询有非常大的lo优势。|</li>
<li>HbaseCassandraHypertable</li>
</ul></li>

<li>文档存储
<ul class="org-ul">
<li>文档存储一般用类似json的格式存储，存储的内容是文档型的。这样也就有机会对某些字段建立索引，实现关系数据库的某些功能。</li>
<li>MongoDB CouchDB</li>
</ul></li>

<li>key-value存储
<ul class="org-ul">
<li>可以通过key快速查询到其value。一般来说，存储不管value的格式，照单全收。(Redis包含了其他功能)</li>
<li>Tokyo Cabinet / TyrantBerkeley</li>
<li>Memcache, Redis</li>
</ul></li>

<li>图存储
<ul class="org-ul">
<li>图形关系的最佳存储。使用传统关系数据库来解决的话性能低下，而且设计使用不方便。</li>
<li>Neo4JFlockDB</li>
</ul></li>

<li>对象存储
<ul class="org-ul">
<li>通过类似面向对象语言的语法操作数据库，通过对象的方式存取数据。</li>
<li>db4oVersant</li>
</ul></li>

<li>xml数据库
<ul class="org-ul">
<li>高效的存储XML数据，并支持XML的内部查询语法，比如XQuery，Xpaath</li>
<li>Berkeley DB XMLBaseX</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:87391e80-a760-4ddc-adb8-df082920a12a" class="outline-4">
<h4 id="h:87391e80-a760-4ddc-adb8-df082920a12a">redis 简介</h4>
<div class="outline-text-4" id="text-h:87391e80-a760-4ddc-adb8-df082920a12a">
<p>
Redis (Remote Dictionary Server远程字典服务)是一个遵循BSD MIT开源协议的高性能的NoSQL.Redis基于ANShC语言语言)编写的key-value数据库，是意大利的 Salvatore Sanfilippo在2009年发布，从2010年3月15日起，Redis的开发工作由VMware主持。从2013年5月开始，Redis的开发由Pivota公司赞助。目前国内外使用的公司众多，比如:阿里，腾讯，百度，京东，新浪微博，GitHub，Twitter等。
</p>

<p>
Redis的出现，很大程度补偿了memcached这类key/value存储的不足，在部分场合可以对关系数据库起到很好的补充作用。它提供了Java， C/C++， Go， C#，PHP，JavaScript，Perl， Object-C，Python，Ruby，Erlang等客户端
</p>

<p>
Redis在高并发、低延迟环境要求比较高的环境使用量非常广泛，目前redis在
DB-Engine月排行榜<a href="https://db-engines.com/en/ranking">https://db-engines.com/en/ranking</a>中一直比较靠前，而且
一直是键值型存储类的首位
</p>


<figure id="orgb687dc3">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/2020102121142667.png" alt="2020102121142667.png">

</figure>

<p>
官网地址：<a href="https://redis.io/">https://redis.io/</a>
</p>
</div>
</div>
<div id="outline-container-h:4c2a4291-ea8f-4a72-a19c-12e13cd6c0ee" class="outline-4">
<h4 id="h:4c2a4291-ea8f-4a72-a19c-12e13cd6c0ee">Redis 特性</h4>
<div class="outline-text-4" id="text-h:4c2a4291-ea8f-4a72-a19c-12e13cd6c0ee">
<ul class="org-ul">
<li>速度快: 10W QPS,基于内存,C语言实现</li>
<li>单线程</li>
<li>持久化</li>
<li>支持多种数据结构</li>
<li>支持多种编程语言</li>
<li>功能丰富: 支持Lua脚本,发布订阅,事务,pipeline等功能</li>
<li>简单:
代码短小精悍(单机核心代码只有23000行左右),单线程开发容易,不依赖外部库,使用简单</li>
<li>主从复制</li>
<li>支持高可用和分布式</li>
</ul>
</div>
</div>
<div id="outline-container-h:0257c2eb-82c0-4e04-9155-734273b19c79" class="outline-4">
<h4 id="h:0257c2eb-82c0-4e04-9155-734273b19c79">单线程</h4>
<div class="outline-text-4" id="text-h:0257c2eb-82c0-4e04-9155-734273b19c79">
<p>
Redis 6.0版本前一直是单线程方式处理用户的请求
</p>


<figure id="org0c105e7">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021211715305.png" alt="20201021211715305.png">

</figure>

<p>
单线程为何如此快?
</p>

<ul class="org-ul">
<li>纯内存</li>
<li>非阻塞</li>
<li><p>
避免线程切换和竞态消耗
</p>


<figure id="orga645093">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021211808140.png" alt="20201021211808140.png">

</figure></li>
</ul>

<p>
注意事项:
</p>
<ul class="org-ul">
<li>一次只运行一条命令</li>
<li>拒绝长(慢)命令:keys *, flushall, flushdb, slow lua script, mutil/exec, operate big value(collection)</li>
<li>其实不是单线程: 早期版本是单进程单线程,3版本后实际还有其它的线程,
fysnc file descriptor,close file descriptor</li>
</ul>
</div>
</div>
<div id="outline-container-h:c2abbc50-d45a-40aa-b7e6-0f2493d0c0d2" class="outline-4">
<h4 id="h:c2abbc50-d45a-40aa-b7e6-0f2493d0c0d2">redis 对比 memcached</h4>
<div class="outline-text-4" id="text-h:c2abbc50-d45a-40aa-b7e6-0f2493d0c0d2">
<ul class="org-ul">
<li>支持数据的持久化：可以将内存中的数据保持在磁盘中，重启redis服务或者服务器之后可以从备份文件中恢复数据到内存继续使用</li>
<li>支持更多的数据类型：支持string(字符串)、hash(哈希数据)、list(列表)、set(集合)、zset(有序集合)</li>
<li>支持数据的备份：可以实现类似于数据的master-slave模式的数据备份，另外也支持使用快照+AOF</li>
<li>支持更大的value数据：memcache单个key
value最大只支持1MB，而redis最大支持512MB(生产不建议超过2M,性能受影响)</li>
<li>在Redis6版本前,Redis
是单线程，而memcached是多线程，所以单机情况下没有memcached
并发高,性能更好,但redis
支持分布式集群以实现更高的并发，单Redis实例可以实现数万并发</li>
<li>支持集群横向扩展：基于redis
cluster的横向扩展，可以实现分布式集群，大幅提升性能和数据安全性</li>
<li>都是基于 C 语言开发</li>
</ul>
</div>
</div>
<div id="outline-container-h:4b006933-2b03-4ffa-a5f5-2d965760efe5" class="outline-4">
<h4 id="h:4b006933-2b03-4ffa-a5f5-2d965760efe5">redis 典型应用场景</h4>
<div class="outline-text-4" id="text-h:4b006933-2b03-4ffa-a5f5-2d965760efe5">
<ul class="org-ul">
<li>Session 共享：常见于web集群中的Tomcat或者PHP中多web服务器session共享</li>
<li>缓存：数据查询、电商网站商品信息、新闻内容</li>
<li>计数器：访问排行榜、商品浏览数等和次数相关的数值统计场景</li>
<li>微博/微信社交场合：共同好友,粉丝数,关注,点赞评论等</li>
<li>消息队列：ELK的日志缓存、部分业务的订阅发布系统</li>
<li>地理位置: 基于GEO(地理信息定位),实现摇一摇,附近的人,外卖等功能</li>
</ul>



<figure id="orgf1bcd49">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021212822349.png" alt="20201021212822349.png">

</figure>


<figure id="orgef209cd">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021212857281.png" alt="20201021212857281.png">

</figure>


<figure id="org4ad7dd3">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/2020102121290676.png" alt="2020102121290676.png">

</figure>


<figure id="org6e11f35">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021212923183.png" alt="20201021212923183.png">

</figure>
</div>
</div>
<div id="outline-container-h:8f64f30f-161d-43f3-8a6b-f12bb230618f" class="outline-4">
<h4 id="h:8f64f30f-161d-43f3-8a6b-f12bb230618f">缓存的实现流程</h4>
<div class="outline-text-4" id="text-h:8f64f30f-161d-43f3-8a6b-f12bb230618f">
<p>
<b>数据更新操作流程：</b>
</p>


<figure id="orge2b6e64">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021212643960.png" alt="20201021212643960.png">

</figure>

<p>
<b>数据读操作流程：</b>
</p>


<figure id="orgecca8d2">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021212729993.png" alt="20201021212729993.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:f0839697-0c07-4683-b987-83f3bb13f771" class="outline-3">
<h3 id="h:f0839697-0c07-4683-b987-83f3bb13f771">Redis 安装及连接</h3>
<div class="outline-text-3" id="text-h:f0839697-0c07-4683-b987-83f3bb13f771">
<p>
官方下载地址：<a href="http://download.redis.io/releases/">http://download.redis.io/releases/</a>
</p>
</div>
<div id="outline-container-h:80c4953d-a99a-429b-8e30-67e7596f079a" class="outline-4">
<h4 id="h:80c4953d-a99a-429b-8e30-67e7596f079a">yum安装redis</h4>
<div class="outline-text-4" id="text-h:80c4953d-a99a-429b-8e30-67e7596f079a">
<p>
在centos系统上需要安装epel源
</p>
</div>
<div id="outline-container-h:92d06f46-907f-41b1-8471-06dcd419f4fb" class="outline-5">
<h5 id="h:92d06f46-907f-41b1-8471-06dcd419f4fb">查看yum仓库redis版本</h5>
<div class="outline-text-5" id="text-h:92d06f46-907f-41b1-8471-06dcd419f4fb">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">CentOS 8 &#30001;&#31995;&#32479;&#28304;&#25552;&#20379;</span>
[root@centos8 ~]#yum info redis
Installed Packages
Name         : redis
Version      : 5.0.3
Release      : 1.module_el8.0.0+6+ab019c03
Arch         : x86_64
Size         : 3.3 M
Source       : redis-5.0.3-1.module_el8.0.0+6+ab019c03.src.rpm
Repo         : @System
From repo    : AppStream
Summary      : A persistent key-value database
URL          : http://redis.io
License      : BSD and MIT
Description  : Redis is an advanced key-value store. It is often referred to as a data
             : structure server since keys can contain strings, hashes, lists, sets and
             : sorted sets.
             : 
             : You can run atomic operations on these types, like appending to a string;
             : incrementing the value<span style="color: #a020f0;"> in</span> a hash; pushing to a list; computing set
             : intersection, union and difference; or getting the member with highest
             : ranking<span style="color: #a020f0;"> in</span> a sorted set.
             : 
             : In order to achieve its outstanding performance, Redis works with an
             : in-memory dataset. Depending on your use case, you can persist it either
             : by dumping the dataset to disk every once<span style="color: #a020f0;"> in</span> a while, or by appending
             : each command to a log.
             : 
             : Redis also supports trivial-to-setup master-slave replication, with very
             : fast non-blocking first synchronization, auto-reconnection on net split
             : and so forth.
             : 
             : Other features include Transactions, Pub/Sub, Lua scripting, Keys with a
             : limited time-to-live, and configuration settings to make Redis behave like
             : a cache.
             : 
             : You can use Redis from most programming languages also.

<span style="color: #b22222;">#</span><span style="color: #b22222;">CentOS 7 &#30001;epel&#28304;&#25552;&#20379;</span>
[root@node7 ~]# yum info redis
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirrors.aliyun.com
 * epel: mirrors.aliyun.com
 * extras: mirrors.aliyun.com
Available Packages
Name        : redis
Arch        : x86_64
Version     : 3.2.12
Release     : 2.el7
Size        : 544 k
Repo        : epel/7/x86_64
Summary     : A persistent key-value database
URL         : http://redis.io
License     : BSD
Description : Redis is an advanced key-value store. It is often referred to as a data
            : structure server since keys can contain strings, hashes, lists, sets and
            : sorted sets.
            : 
            : You can run atomic operations on these types, like appending to a string;
            : incrementing the value<span style="color: #a020f0;"> in</span> a hash; pushing to a list; computing set
            : intersection, union and difference; or getting the member with highest
            : ranking<span style="color: #a020f0;"> in</span> a sorted set.
            : 
            : In order to achieve its outstanding performance, Redis works with an
            : in-memory dataset. Depending on your use case, you can persist it either
            : by dumping the dataset to disk every once<span style="color: #a020f0;"> in</span> a while, or by appending
            : each command to a log.
            : 
            : Redis also supports trivial-to-setup master-slave replication, with very
            : fast non-blocking first synchronization, auto-reconnection on net split
            : and so forth.
            : 
            : Other features include Transactions, Pub/Sub, Lua scripting, Keys with a
            : limited time-to-live, and configuration settings to make Redis behave like
            : a cache.
            : 
            : You can use Redis from most programming languages also.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:41e6461a-995a-40f4-8f2c-1a5a4978029c" class="outline-5">
<h5 id="h:41e6461a-995a-40f4-8f2c-1a5a4978029c">yum安装 redis</h5>
<div class="outline-text-5" id="text-h:41e6461a-995a-40f4-8f2c-1a5a4978029c">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dnf -y install redis
[root@centos8 ~]#systemctl enable --now redis

[root@centos8 ~]#ss -ntl
State       Recv-Q       Send-Q               Local Address:Port               Peer Address:Port       
LISTEN      0            128                        0.0.0.0:22                      0.0.0.0:*          
LISTEN      0            128                      127.0.0.1:6379                    0.0.0.0:*          
LISTEN      0            128                           [::]:22                         [::]:*

[root@centos8 ~]#pstree -p | grep redis
           |-redis-server(16812)-+-{redis-server}(16813)
           |                     |-{redis-server}(16814)


apt install redis -y
&#9492;&#9472;# dpkg -L redis            
/.
/usr
/usr/share
/usr/share/doc
/usr/share/doc/redis
/usr/share/doc/redis/changelog.Debian.gz
/usr/share/doc/redis/changelog.gz
/usr/share/doc/redis/copyright
/usr/share/doc/redis/00-RELEASENOTES.gz

&#9484;&#9472;&#9472;(root&#12927;kali)-[~]
&#9492;&#9472;# dpkg -L redis-server
/.
/etc
/etc/default
/etc/default/redis-server
/etc/init.d
/etc/init.d/redis-server
/etc/logrotate.d
/etc/logrotate.d/redis-server
/etc/redis
/etc/redis/redis.conf
/usr
/usr/bin
/usr/lib
/usr/lib/systemd
/usr/lib/systemd/system
/usr/lib/systemd/system/redis-server.service
/usr/lib/systemd/system/redis-server@.service
/usr/share
/usr/share/doc
/usr/share/doc/redis-server

&#9492;&#9472;# cat /usr/lib/systemd/system/redis-server.service
[Unit]
<span style="color: #a0522d;">Description</span>=Advanced key-value store
<span style="color: #a0522d;">After</span>=network.target
<span style="color: #a0522d;">Documentation</span>=http://redis.io/documentation, man:redis-server(1)

[Service]
<span style="color: #a0522d;">Type</span>=notify
<span style="color: #a0522d;">ExecStart</span>=/usr/bin/redis-server /etc/redis/redis.conf --supervised systemd --daemonize no
<span style="color: #a0522d;">PIDFile</span>=/run/redis/redis-server.pid
<span style="color: #a0522d;">TimeoutStopSec</span>=0
<span style="color: #a0522d;">Restart</span>=always
<span style="color: #a0522d;">User</span>=redis
<span style="color: #a0522d;">Group</span>=redis
<span style="color: #a0522d;">RuntimeDirectory</span>=redis
<span style="color: #a0522d;">RuntimeDirectoryMode</span>=2755

<span style="color: #a0522d;">UMask</span>=007
<span style="color: #a0522d;">PrivateTmp</span>=true
<span style="color: #a0522d;">LimitNOFILE</span>=65535
<span style="color: #a0522d;">PrivateDevices</span>=true
<span style="color: #a0522d;">ProtectHome</span>=true
<span style="color: #a0522d;">ProtectSystem</span>=stri
....

systemctl start redis-server

[root@centos8 ~]#redis-cli 
127.0.0.1:6379&gt; ping
PONG
127.0.0.1:6379&gt; info
<span style="color: #b22222;"># </span><span style="color: #b22222;">Server</span>
redis_version:5.0.3
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:8c0bf22bfba82c8f
redis_mode:standalone
os:Linux 4.18.0-80.el8.x86_64 x86_64
arch_bits:64
multiplexing_api:epoll
atomicvar_api:atomic-builtin
gcc_version:8.2.1
process_id:16812
run_id:2af1a9195554cb7d268b5e782b58e3a23135c418
tcp_port:6379
uptime_in_seconds:89
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:9451885
executable:/usr/bin/redis-server
config_file:/etc/redis.conf

<span style="color: #b22222;"># </span><span style="color: #b22222;">Clients</span>
connected_clients:1
client_recent_max_input_buffer:2
client_recent_max_output_buffer:0
blocked_clients:0

<span style="color: #b22222;"># </span><span style="color: #b22222;">Memory</span>
used_memory:853896
used_memory_human:833.88K
used_memory_rss:13012992
used_memory_rss_human:12.41M
used_memory_peak:853896
used_memory_peak_human:833.88K
used_memory_peak_perc:100.12%
used_memory_overhead:840694
used_memory_startup:791000
used_memory_dataset:13202
used_memory_dataset_perc:20.99%
allocator_allocated:1477016
allocator_active:1806336
allocator_resident:8712192
total_system_memory:836886528
total_system_memory_human:798.12M
used_memory_lua:37888
used_memory_lua_human:37.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:1.22
allocator_frag_bytes:329320
allocator_rss_ratio:4.82
allocator_rss_bytes:6905856
rss_overhead_ratio:1.49
rss_overhead_bytes:4300800
mem_fragmentation_ratio:16.03
mem_fragmentation_bytes:12201096
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:49694
mem_aof_buffer:0
mem_allocator:jemalloc-5.1.0
active_defrag_running:0
lazyfree_pending_objects:0

<span style="color: #b22222;"># </span><span style="color: #b22222;">Persistence</span>
loading:0
rdb_changes_since_last_save:0
rdb_bgsave_in_progress:0
rdb_last_save_time:1603287316
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:-1
rdb_current_bgsave_time_sec:-1
rdb_last_cow_size:0
aof_enabled:0
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok
aof_last_cow_size:0

<span style="color: #b22222;"># </span><span style="color: #b22222;">Stats</span>
total_connections_received:1
total_commands_processed:2
instantaneous_ops_per_sec:0
total_net_input_bytes:45
total_net_output_bytes:11475
instantaneous_input_kbps:0.00
instantaneous_output_kbps:0.00
rejected_connections:0
sync_full:0
sync_partial_ok:0
sync_partial_err:0
expired_keys:0
expired_stale_perc:0.00
expired_time_cap_reached_count:0
evicted_keys:0
keyspace_hits:0
keyspace_misses:0
pubsub_channels:0
pubsub_patterns:0
latest_fork_usec:0
migrate_cached_sockets:0
slave_expires_tracked_keys:0
active_defrag_hits:0
active_defrag_misses:0
active_defrag_key_hits:0
active_defrag_key_misses:0

<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:0
master_replid:cc6c17d57ae2848acfa6c93c116b3fb7e9bc305b
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0

<span style="color: #b22222;"># </span><span style="color: #b22222;">CPU</span>
used_cpu_sys:0.113862
used_cpu_user:0.015991
used_cpu_sys_children:0.000000
used_cpu_user_children:0.000000

<span style="color: #b22222;"># </span><span style="color: #b22222;">Cluster</span>
cluster_enabled:0

<span style="color: #b22222;"># </span><span style="color: #b22222;">Keyspace</span>
127.0.0.1:6379&gt;quit 
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:9335c2fd-53ea-4b61-afd9-4dd865ef6332" class="outline-4">
<h4 id="h:9335c2fd-53ea-4b61-afd9-4dd865ef6332">编译安装 redis</h4>
<div class="outline-text-4" id="text-h:9335c2fd-53ea-4b61-afd9-4dd865ef6332">
<p>
下载当前最新release版本 redis 源码包
</p>

<p>
网站：<a href="http://download.redis.io/releases/">http://download.redis.io/releases/</a>
</p>


<figure id="org48d99be">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201021214018736.png" alt="20201021214018736.png">

</figure>
</div>
<div id="outline-container-h:c17f962f-f65e-4629-9afe-e8f67223c747" class="outline-5">
<h5 id="h:c17f962f-f65e-4629-9afe-e8f67223c747">编译安装</h5>
<div class="outline-text-5" id="text-h:c17f962f-f65e-4629-9afe-e8f67223c747">
<p>
官方的安装方法：
</p>

<div class="org-src-container">
<pre class="src src-sh">https://redis.io/download
</pre>
</div>

<p>
范例：编译安装过程
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#20381;&#36182;&#21253;, redis&#20381;&#36182;jemalloc&#36827;&#34892;&#20869;&#23384;&#20998;&#37197;</span>
[root@centos8 ~]#yum -y install make gcc jemalloc-devel

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#25903;&#25345;systemd&#38656;&#35201;&#23433;&#35013;&#19979;&#38754;&#20381;&#36182;</span>
yum -y install gcc jemalloc-devel systemd-devel
apt -y install make gcc libjemalloc-dev libsystemd-dev

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#36733;&#28304;&#30721;&#21253;</span>
wget http://download.redis.io/releases/redis-5.0.9.tar.gz
tar xf redis-5.0.9.tar.gz

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#35793;&#23433;&#35013;</span>
<span style="color: #483d8b;">cd</span> redis-5.0.9/
make -j 2 <span style="color: #a0522d;">PREFIX</span>=/apps/redis install
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25903;&#25345;systemd</span>
make -j 2 <span style="color: #a0522d;">USE_SYSTEMD</span>=yes <span style="color: #a0522d;">PREFIX</span>=/apps/redis install

&#37197;&#32622;&#21464;&#37327;
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"PATH=/apps/redis/bin:$PATH"</span> &gt; /etc/profile.d/redis.sh
<span style="color: #483d8b;">.</span> /etc/profile.d/redis.sh

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#24405;&#32467;&#26500;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">tree /apps/redis/</span>
/apps/redis/
&#9492;&#9472;&#9472; bin
    &#9500;&#9472;&#9472; redis-benchmark
    &#9500;&#9472;&#9472; redis-check-aof
    &#9500;&#9472;&#9472; redis-check-rdb
    &#9500;&#9472;&#9472; redis-cli
    &#9500;&#9472;&#9472; redis-sentinel -&gt; redis-server
    &#9492;&#9472;&#9472; redis-server

1 directory, 6 files

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20934;&#22791;&#30456;&#20851;&#30446;&#24405;&#21644;&#25991;&#20214;</span>
mkdir /apps/redis/{etc,log,data,run}
cp redis.conf /apps/redis/etc/
grep -Ev  <span style="color: #8b2252;">"^#|^$"</span> /apps/redis/etc/redis.conf
</pre>
</div>
</div>
</div>
<div id="outline-container-h:64a3dfaf-4424-426d-a066-d61799376201" class="outline-5">
<h5 id="h:64a3dfaf-4424-426d-a066-d61799376201">前台启动 redis</h5>
<div class="outline-text-5" id="text-h:64a3dfaf-4424-426d-a066-d61799376201">
<p>
redis-server 是redis 服务器程序
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#redis-server --help
Usage: ./redis-server [/path/to/redis.conf] [options]
       ./redis-server - (<span style="color: #483d8b;">read</span> config from stdin)
       ./redis-server -v or --version
       ./redis-server -h or --help
       ./redis-server --test-memory &lt;megabytes&gt;

Examples:
       ./redis-server (run the server with default conf)
       ./redis-server /etc/redis/6379.conf
       ./redis-server --port 7777
       ./redis-server --port 7777 --replicaof 127.0.0.1 8888
       ./redis-server /etc/myredis.conf --loglevel verbose

Sentinel mode:
       ./redis-server /etc/sentinel.conf --sentinel
</pre>
</div>

<p>
前台启动 redis
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#redis-server /apps/redis/etc/redis.conf 
16418:C 22 Oct 2020 10:43:29.813 <span style="color: #b22222;"># </span><span style="color: #b22222;">oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span>
16418:C 22 Oct 2020 10:43:29.813 <span style="color: #b22222;"># </span><span style="color: #b22222;">Redis version=5.0.9, bits=64, commit=00000000, modified=0, pid=16418, just started</span>
16418:C 22 Oct 2020 10:43:29.813 <span style="color: #b22222;"># </span><span style="color: #b22222;">Configuration loaded</span>
16418:M 22 Oct 2020 10:43:29.814 * Increased maximum number of open files to 10032 (it was originally set to 1024)<span style="color: #483d8b;">.</span>
                _._                                                  
           _.-<span style="color: #ff00ff;">``</span>__ <span style="color: #8b2252;">''</span>-._                                             
      _.-<span style="color: #ff00ff;">``</span>    <span style="color: #ff00ff;">`.  `</span>_.  <span style="color: #8b2252;">''</span>-._           Redis 5.0.9 (00000000/0) 64 bit
  .-<span style="color: #ff00ff;">``</span> .-<span style="color: #ff00ff;">```.  ```</span><span style="color: #8b2252;">\/</span>    _.,_ <span style="color: #8b2252;">''</span>-._                                   
 (    <span style="color: #8b2252;">'      ,       .-`  | `,    )     Running in standalone mode</span>
<span style="color: #8b2252;"> |`-._`-...-` __...-.``-._|'</span><span style="color: #ff00ff;">` _.-'|     Port: 6379</span>
<span style="color: #ff00ff;"> |    `</span>-._   <span style="color: #ff00ff;">`._    /     _.-'    |     PID: 16418</span>
<span style="color: #ff00ff;">  `</span>-._    <span style="color: #ff00ff;">`-._  `</span>-./  _.-<span style="color: #8b2252;">'    _.-'</span>                                   
 |<span style="color: #ff00ff;">`-._`</span>-._    <span style="color: #ff00ff;">`-.__.-'    _.-'_.-'|                                  </span>
<span style="color: #ff00ff;"> |    `</span>-._<span style="color: #ff00ff;">`-._        _.-'_.-'    |           http://redis.io        </span>
<span style="color: #ff00ff;">  `</span>-._    <span style="color: #ff00ff;">`-._`</span>-.__.-<span style="color: #8b2252;">'_.-'</span>    _.-<span style="color: #8b2252;">'                                   </span>
<span style="color: #8b2252;"> |`-._`-._    `-.__.-'</span>    _.-<span style="color: #8b2252;">'_.-'</span>|                                  
 |    <span style="color: #ff00ff;">`-._`</span>-._        _.-<span style="color: #8b2252;">'_.-'</span>    |                                  
  <span style="color: #ff00ff;">`-._    `</span>-._<span style="color: #ff00ff;">`-.__.-'_.-'    _.-'                                   </span>
<span style="color: #ff00ff;">      `</span>-._    <span style="color: #ff00ff;">`-.__.-'    _.-'                                       </span>
<span style="color: #ff00ff;">          `</span>-._        _.-<span style="color: #8b2252;">'                                           </span>
<span style="color: #8b2252;">              `-.__.-'</span>                                               

16418:M 22 Oct 2020 10:43:29.815 <span style="color: #b22222;"># </span><span style="color: #b22222;">WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span>
16418:M 22 Oct 2020 10:43:29.815 <span style="color: #b22222;"># </span><span style="color: #b22222;">Server initialized</span>
16418:M 22 Oct 2020 10:43:29.815 <span style="color: #b22222;"># </span><span style="color: #b22222;">WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.</span>
16418:M 22 Oct 2020 10:43:29.815 <span style="color: #b22222;"># </span><span style="color: #b22222;">WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo madvise &gt; /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled (set to 'madvise' or 'never').</span>
16418:M 22 Oct 2020 10:43:29.815 * Loading RDB produced by version 6.0.8
16418:M 22 Oct 2020 10:43:29.815 * RDB age 603 seconds
16418:M 22 Oct 2020 10:43:29.815 * RDB memory usage when created 0.77 Mb
16418:M 22 Oct 2020 10:43:29.815 * DB loaded from disk: 0.000 seconds
16418:M 22 Oct 2020 10:43:29.815 * Ready to accept connections

[root@centos8 ~]#ss -ntl
State       Recv-Q       Send-Q               Local Address:Port               Peer Address:Port       
LISTEN      0            128                        0.0.0.0:22                      0.0.0.0:*          
LISTEN      0            128                      127.0.0.1:6379                    0.0.0.0:*          
LISTEN      0            128                           [::]:22                         [::]:*
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1bd634b1-3738-48b8-a336-1777f1944299" class="outline-5">
<h5 id="h:1bd634b1-3738-48b8-a336-1777f1944299">解决启动时的三个警告提示</h5>
<div class="outline-text-5" id="text-h:1bd634b1-3738-48b8-a336-1777f1944299">
</div>
<ul class="org-ul">
<li><a id="h:57338d59-e4ff-46e6-81e7-71e53e7aa112"></a>tcp-backlog<br>
<div class="outline-text-6" id="text-h:57338d59-e4ff-46e6-81e7-71e53e7aa112">
<p>
警告提示如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">17191:M 22 Oct 2020 11:17:28.355 <span style="color: #b22222;"># </span><span style="color: #b22222;">WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span>
</pre>
</div>

<p>
backlog参数控制的是三次握手的时候server端收到client.ack确认号之后的队列值，即全连接队列
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#20854;&#20540;&#25913;&#22823;</span>
[root@centos8 ~]#echo <span style="color: #8b2252;">"net.core.somaxconn = 1024"</span> &gt;&gt; /etc/sysctl.conf
[root@centos8 ~]#sysctl -p
net.core.somaxconn = 1024
</pre>
</div>
</div>
</li>
<li><a id="h:a9c16c2b-c735-4fe0-8ee3-69723cb8d833"></a>vm.overcommit_memory<br>
<div class="outline-text-6" id="text-h:a9c16c2b-c735-4fe0-8ee3-69723cb8d833">
<p>
警告提示如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">17191:M 22 Oct 2020 11:17:28.355 <span style="color: #b22222;"># </span><span style="color: #b22222;">WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.</span>
</pre>
</div>

<p>
查看警告信息有提示，建议将其值改为1
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#echo <span style="color: #8b2252;">"vm.overcommit_memory=1"</span> &gt;&gt; /etc/sysctl.conf 
[root@centos8 ~]#sysctl -p
net.core.somaxconn = 1024
vm.overcommit_memory = 1
</pre>
</div>

<p>
内核参数说明：
</p>

<div class="org-src-container">
<pre class="src src-sh">0 &#34920;&#31034;&#20869;&#26680;&#23558;&#26816;&#26597;&#26159;&#21542;&#26377;&#36275;&#22815;&#30340;&#21487;&#29992;&#20869;&#23384;&#20379;&#24212;&#29992;&#36827;&#31243;&#20351;&#29992;&#65307;&#22914;&#26524;&#26377;&#36275;&#22815;&#30340;&#21487;&#29992;&#20869;&#23384;&#65292;&#20869;&#23384;&#30003;&#35831;&#20801;&#35768;&#65307;&#21542;&#21017;&#65292;&#20869;&#23384;&#30003;&#35831;&#22833;&#36133;&#65292;&#24182;&#25226;&#38169;&#35823;&#36820;&#22238;&#32473;&#24212;&#29992;&#36827;&#31243;&#12290;
1 &#34920;&#31034;&#20869;&#26680;&#20801;&#35768;&#20998;&#37197;&#25152;&#26377;&#30340;&#29289;&#29702;&#20869;&#23384;&#65292;&#32780;&#19981;&#31649;&#24403;&#21069;&#30340;&#20869;&#23384;&#29366;&#24577;&#22914;&#20309;
2 &#34920;&#31034;&#20869;&#26680;&#20801;&#35768;&#20998;&#37197;&#36229;&#36807;&#25152;&#26377;&#29289;&#29702;&#20869;&#23384;&#21644;&#20132;&#25442;&#31354;&#38388;&#24635;&#21644;&#30340;&#20869;&#23384;
</pre>
</div>
</div>
</li>
<li><a id="h:3ed1e4ed-c1dc-4ec7-ba35-4e07e9a08cf9"></a>transparent huge pages<br>
<div class="outline-text-6" id="text-h:3ed1e4ed-c1dc-4ec7-ba35-4e07e9a08cf9">
<p>
警告提示信息如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">17191:M 22 Oct 2020 11:17:28.355 <span style="color: #b22222;"># </span><span style="color: #b22222;">WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo madvise &gt; /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled (set to 'madvise' or 'never').</span>

&#35686;&#21578;&#65306;&#24744;&#22312;&#20869;&#26680;&#20013;&#21551;&#29992;&#20102;&#36879;&#26126;&#22823;&#39029;&#38754;&#65288;THP,&#19981;&#21516;&#20110;&#19968;&#33324;&#20869;&#23384;&#39029;&#30340;4k&#20026;2M&#65289;&#25903;&#25345;&#12290; &#36825;&#23558;&#22312;Redis&#20013;&#36896;&#25104;&#24310;&#36831;&#21644;&#20869;&#23384;&#20351;&#29992;&#38382;&#39064;&#12290; &#35201;&#35299;&#20915;&#27492;&#38382;&#39064;&#65292;&#35831;&#20197;root &#29992;&#25143;&#36523;&#20221;&#36816;&#34892;&#21629;&#20196;&#8220;echo never&gt; /sys/kernel/mm/transparent_hugepage/enabled&#8221;&#65292;&#24182;&#23558;&#20854;&#28155;&#21152;&#21040;&#24744;&#30340;/etc/rc.local&#20013;&#65292;&#20197;&#20415;&#22312;&#37325;&#21551;&#21518;&#20445;&#30041;&#35774;&#32622;&#12290;&#31105;&#29992;THP&#21518;&#65292;&#24517;&#39035;&#37325;&#26032;&#21551;&#21160;Redis&#12290;
</pre>
</div>

<p>
解决方法：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled
[root@centos8 ~]#echo <span style="color: #8b2252;">"echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled"</span> &gt;&gt; /etc/rc.d/rc.local [root@centos8 ~]#cat /etc/rc.d/rc.local 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">It is highly advisable to create own systemd services or udev rules</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">to run scripts during boot instead of using this file.</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">In contrast to previous versions due to parallel execution during boot</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">this script will NOT be run after all other services.</span>
<span style="color: #b22222;">#</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Please note that you must run 'chmod +x /etc/rc.d/rc.local' to ensure</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">that this script will be executed during boot.</span>

touch /var/lock/subsys/local

<span style="color: #483d8b;">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled
[root@centos8 ~]#chmod +x /etc/rc.d/rc.local 
</pre>
</div>
</div>
</li>
<li><a id="h:212fa2b0-af04-4821-855c-fa03d27e7b09"></a>再次前端启动 redis<br>
<div class="outline-text-6" id="text-h:212fa2b0-af04-4821-855c-fa03d27e7b09">
<p>
建议在其它redis服务器上做以上配置
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#redis-server --port 6379
17436:C 22 Oct 2020 11:46:17.793 <span style="color: #b22222;"># </span><span style="color: #b22222;">oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span>
17436:C 22 Oct 2020 11:46:17.793 <span style="color: #b22222;"># </span><span style="color: #b22222;">Redis version=5.0.9, bits=64, commit=00000000, modified=0, pid=17436, just started</span>
17436:C 22 Oct 2020 11:46:17.793 <span style="color: #b22222;"># </span><span style="color: #b22222;">Configuration loaded</span>
17436:M 22 Oct 2020 11:46:17.794 * Increased maximum number of open files to 10032 (it was originally set to 1024)<span style="color: #483d8b;">.</span>
                _._                                                  
           _.-<span style="color: #ff00ff;">``</span>__ <span style="color: #8b2252;">''</span>-._                                             
      _.-<span style="color: #ff00ff;">``</span>    <span style="color: #ff00ff;">`.  `</span>_.  <span style="color: #8b2252;">''</span>-._           Redis 5.0.9 (00000000/0) 64 bit
  .-<span style="color: #ff00ff;">``</span> .-<span style="color: #ff00ff;">```.  ```</span><span style="color: #8b2252;">\/</span>    _.,_ <span style="color: #8b2252;">''</span>-._                                   
 (    <span style="color: #8b2252;">'      ,       .-`  | `,    )     Running in standalone mode</span>
<span style="color: #8b2252;"> |`-._`-...-` __...-.``-._|'</span><span style="color: #ff00ff;">` _.-'|     Port: 6380</span>
<span style="color: #ff00ff;"> |    `</span>-._   <span style="color: #ff00ff;">`._    /     _.-'    |     PID: 17436</span>
<span style="color: #ff00ff;">  `</span>-._    <span style="color: #ff00ff;">`-._  `</span>-./  _.-<span style="color: #8b2252;">'    _.-'</span>                                   
 |<span style="color: #ff00ff;">`-._`</span>-._    <span style="color: #ff00ff;">`-.__.-'    _.-'_.-'|                                  </span>
<span style="color: #ff00ff;"> |    `</span>-._<span style="color: #ff00ff;">`-._        _.-'_.-'    |           http://redis.io        </span>
<span style="color: #ff00ff;">  `</span>-._    <span style="color: #ff00ff;">`-._`</span>-.__.-<span style="color: #8b2252;">'_.-'</span>    _.-<span style="color: #8b2252;">'                                   </span>
<span style="color: #8b2252;"> |`-._`-._    `-.__.-'</span>    _.-<span style="color: #8b2252;">'_.-'</span>|                                  
 |    <span style="color: #ff00ff;">`-._`</span>-._        _.-<span style="color: #8b2252;">'_.-'</span>    |                                  
  <span style="color: #ff00ff;">`-._    `</span>-._<span style="color: #ff00ff;">`-.__.-'_.-'    _.-'                                   </span>
<span style="color: #ff00ff;">      `</span>-._    <span style="color: #ff00ff;">`-.__.-'    _.-'                                       </span>
<span style="color: #ff00ff;">          `</span>-._        _.-<span style="color: #8b2252;">'                                           </span>
<span style="color: #8b2252;">              `-.__.-'</span>                                               

17436:M 22 Oct 2020 11:46:17.795 <span style="color: #b22222;"># </span><span style="color: #b22222;">Server initialized</span>
17436:M 22 Oct 2020 11:46:17.795 * Loading RDB produced by version 6.0.8
17436:M 22 Oct 2020 11:46:17.795 * RDB age 3455 seconds
17436:M 22 Oct 2020 11:46:17.795 * RDB memory usage when created 0.77 Mb
17436:M 22 Oct 2020 11:46:17.795 * DB loaded from disk: 0.000 seconds
17436:M 22 Oct 2020 11:46:17.795 * Ready to accept connections
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:77c2b79d-cdaa-4f68-881a-bbc175fe1fc5" class="outline-5">
<h5 id="h:77c2b79d-cdaa-4f68-881a-bbc175fe1fc5">创建 redis 用户和设置数据目录权限</h5>
<div class="outline-text-5" id="text-h:77c2b79d-cdaa-4f68-881a-bbc175fe1fc5">
<div class="org-src-container">
<pre class="src src-sh">useradd -r -s /sbin/nologin redis
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#30446;&#24405;&#26435;&#38480;</span>
chown -R redis:redis /apps/redis/
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f772cdba-67a2-4e4a-904d-cf0935972bad" class="outline-5">
<h5 id="h:f772cdba-67a2-4e4a-904d-cf0935972bad">创建 redis 服务Service文件</h5>
<div class="outline-text-5" id="text-h:f772cdba-67a2-4e4a-904d-cf0935972bad">
<div class="org-src-container">
<pre class="src src-sh">cat &lt;&lt;\EOF&gt; /lib/systemd/system/redis.service 
<span style="color: #ffa54f;">[Unit]</span>
<span style="color: #ffa54f;">Description=Redis persistent key-value database</span>
<span style="color: #ffa54f;">After=network.target</span>

<span style="color: #ffa54f;">[Service]</span>
<span style="color: #ffa54f;">ExecStart=/apps/redis/bin/redis-server /apps/redis/etc/redis.conf --supervised systemd</span>
<span style="color: #ffa54f;">ExecStop=/bin/kill -s QUIT $MAINPID </span>
<span style="color: #ffa54f;">Type=notify</span>
<span style="color: #ffa54f;">User=redis</span>
<span style="color: #ffa54f;">Group=redis</span>
<span style="color: #ffa54f;">RuntimeDirectory=redis</span>
<span style="color: #ffa54f;">RuntimeDirectoryMode=0755</span>
<span style="color: #ffa54f;">LimitNOFILE=10000032</span>

<span style="color: #ffa54f;">[Install]</span>
<span style="color: #ffa54f;">WantedBy=multi-user.target</span>
<span style="color: #ffa54f;">EOF</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e1d4d122-ca60-4029-aa18-ebbd62ec5e55" class="outline-5">
<h5 id="h:e1d4d122-ca60-4029-aa18-ebbd62ec5e55">Redis通过Service方式启动</h5>
<div class="outline-text-5" id="text-h:e1d4d122-ca60-4029-aa18-ebbd62ec5e55">
<div class="org-src-container">
<pre class="src src-sh">systemctl daemon-reload
systemctl enable --now redis

[root@centos8 ~]#ss -ntl
State       Recv-Q       Send-Q               Local Address:Port               Peer Address:Port       
LISTEN      0            128                        0.0.0.0:22                      0.0.0.0:*          
LISTEN      0            511                      127.0.0.1:6379                    0.0.0.0:*          
LISTEN      0            128                           [::]:22                         [::]:* 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:570f43eb-302d-406a-b6cb-6a94a43303dc" class="outline-5">
<h5 id="h:570f43eb-302d-406a-b6cb-6a94a43303dc">使用客户端连接 redis</h5>
<div class="outline-text-5" id="text-h:570f43eb-302d-406a-b6cb-6a94a43303dc">

<figure id="orgbdab630">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022134103586.png" alt="20201022134103586.png">

</figure>

<p>
格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">redis-cli -h IP/HOSTNAME -p PORT -a PASSWORD
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#redis-cli 
127.0.0.1:6379&gt; info
<span style="color: #b22222;"># </span><span style="color: #b22222;">Server</span>
127.0.0.1:6379&gt; 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f6ce9cc5-30c8-4b67-ac40-e5b76d32b93f" class="outline-5">
<h5 id="h:f6ce9cc5-30c8-4b67-ac40-e5b76d32b93f">创建命令软链接</h5>
<div class="outline-text-5" id="text-h:f6ce9cc5-30c8-4b67-ac40-e5b76d32b93f">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ln -s /apps/redis/bin/ /usr/bin/
</pre>
</div>
</div>
</div>
<div id="outline-container-h:00e99a8f-197f-4b0d-8200-54a7dca1f27f" class="outline-5">
<h5 id="h:00e99a8f-197f-4b0d-8200-54a7dca1f27f">实战案例：一键编译安装Redis脚本</h5>
<div class="outline-text-5" id="text-h:00e99a8f-197f-4b0d-8200-54a7dca1f27f">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat install_general_redis.sh 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #483d8b;">.</span> /etc/init.d/functions
<span style="color: #a0522d;">VERSION</span>=redis-5.0.9
<span style="color: #a0522d;">DIR1</span>=/apps/redis
<span style="color: #a0522d;">PASSWORD</span>=centos

<span style="color: #0000ff;">install</span>() {
yum -y install make gcc tcl &amp;&gt; /dev/null || { action <span style="color: #8b2252;">"&#23433;&#35013;&#25152;&#38656;&#21253;&#22833;&#36133;&#65292;&#35831;&#26816;&#27979;&#21253;&#25110;&#32593;&#32476;&#37197;&#32622;"</span> false;<span style="color: #a020f0;">exit</span>;}
wget http://download.redis.io/releases/${<span style="color: #a0522d;">VERSION</span>}.tar.gz &amp;&gt; /dev/null || { action <span style="color: #8b2252;">"Redis &#28304;&#30721;&#19979;&#36733;&#22833;&#36133;"</span> false; <span style="color: #a020f0;">exit</span>; }
tar xf $<span style="color: #a0522d;">VERSION</span>.tar.gz
<span style="color: #483d8b;">cd</span> $<span style="color: #a0522d;">VERSION</span>/
make -j 2 &amp;&gt; /dev/null &amp;&amp; make <span style="color: #a0522d;">PREFIX</span>=${<span style="color: #a0522d;">DIR1</span>} install &amp;&gt; /dev/null &amp;&amp; action <span style="color: #8b2252;">"Redis &#32534;&#35793;&#23433;&#35013;&#25104;&#21151;"</span> || { action <span style="color: #8b2252;">"Redis &#32534;&#35793;&#23433;&#35013;&#22833;&#36133;"</span> false;<span style="color: #a020f0;">exit</span>; }
ln -s ${<span style="color: #a0522d;">DIR1</span>}/bin/* /usr/bin/
mkdir -p ${<span style="color: #a0522d;">DIR1</span>}/{etc,data,log,run}
<span style="color: #483d8b;">cd</span>
cp $<span style="color: #a0522d;">VERSION</span>/redis.conf $<span style="color: #a0522d;">DIR1</span>/etc

sed -i -e <span style="color: #8b2252;">"s/bind 127.0.0.1/bind 0.0.0.0/"</span> -e <span style="color: #8b2252;">"/# requirepass/a requirepass ${PASSWORD}"</span> -e <span style="color: #8b2252;">"/^dir .*/c dir ${DIR1}/data/"</span> -e <span style="color: #8b2252;">"/logfile .*/c logfile ${DIR1}/log/redis_6379.log"</span> -e <span style="color: #8b2252;">"/^pidfile .*/c pidfile ${DIR1}/run/redis_6379.pid"</span> ${<span style="color: #a0522d;">DIR1</span>}/etc/redis.conf

<span style="color: #a020f0;">if</span> id redis &amp;&gt; /dev/null;<span style="color: #a020f0;">then</span>
    action <span style="color: #8b2252;">"redis &#29992;&#25143;&#24050;&#32463;&#23384;&#22312;"</span> false
<span style="color: #a020f0;">else</span>
    useradd -r -s /sbin/nologin redis
    action <span style="color: #8b2252;">"redis &#29992;&#25143;&#21019;&#24314;&#25104;&#21151;"</span>
<span style="color: #a020f0;">fi</span>

chown -R redis.redis ${<span style="color: #a0522d;">DIR1</span>}

cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF
<span style="color: #ffa54f;">net.core.somaxconn = 1024</span>
<span style="color: #ffa54f;">vm.overcommit_memory = 1</span>
<span style="color: #ffa54f;">EOF</span>
sysctl -p

<span style="color: #483d8b;">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled"</span> &gt;&gt; /etc/rc.d/rc.local
chmod +x /etc/rc.d/rc.local
/etc/rc.d/rc.local

cat &gt; /lib/systemd/system/redis.service &lt;&lt;EOF
<span style="color: #ffa54f;">[Unit]</span>
<span style="color: #ffa54f;">Description=Redis persistent key-value database</span>
<span style="color: #ffa54f;">After=network.target</span>

<span style="color: #ffa54f;">[Service]</span>
<span style="color: #ffa54f;">ExecStart=${DIR1}/bin/redis-server ${DIR1}/etc/redis.conf --supervised systemd</span>
<span style="color: #ffa54f;">ExecStop=/bin/kill -s QUIT \$MAINPID</span>
<span style="color: #ffa54f;">Type=notify</span>
<span style="color: #ffa54f;">User=redis</span>
<span style="color: #ffa54f;">Group=redis</span>
<span style="color: #ffa54f;">RuntimeDirectory=redis</span>
<span style="color: #ffa54f;">RuntimeDirectoryMode=0755</span>

<span style="color: #ffa54f;">[Install]</span>
<span style="color: #ffa54f;">WantedBy=multi-user.target</span>
<span style="color: #ffa54f;">EOF</span>
systemctl daemon-reload
systemctl enable --now redis &amp;&gt; /dev/null &amp;&amp; action <span style="color: #8b2252;">"redis &#26381;&#21153;&#21551;&#21160;&#25104;&#21151;"</span> || { action <span style="color: #8b2252;">"redis &#26381;&#21153;&#21551;&#21160;&#22833;&#36133;"</span> false;<span style="color: #a020f0;">exit</span>; }
}

install
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:fa21ac9d-8545-4ada-b6f3-bde3904e4853" class="outline-4">
<h4 id="h:fa21ac9d-8545-4ada-b6f3-bde3904e4853">redis 的多实例</h4>
<div class="outline-text-4" id="text-h:fa21ac9d-8545-4ada-b6f3-bde3904e4853">
<p>
测试环境中经常使用多实例，需要指定不同实例的相应的端口，配置文件，日志文件等相关配置
</p>

<p>
范例：以编译安装为例实现 redis 多实例
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#21069;&#38754;&#32534;&#35793;&#23433;&#35013;&#22909;&#30340;&#22522;&#30784;&#19978;&#36827;&#34892;&#37197;&#32622;&#20462;&#25913;</span>
<span style="color: #483d8b;">cd</span> /apps/redis/etc
mv redis.conf 6379.conf

<span style="color: #b22222;">#</span><span style="color: #b22222;">vim etc/redis_6379.conf</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#20197;&#19979;&#20869;&#23481;</span>
port 6379
pidfile /apps/redis/run/redis_6379.pid
logfile /apps/redis/log/redis_6379.log
dbfilename dump_6379.rdb
appendfilename <span style="color: #8b2252;">"appendonly_6379.aof"</span>


sed <span style="color: #8b2252;">'s/6379/6380/'</span> 6379.conf &gt; 6380.conf

mv /lib/systemd/system/redis.service /lib/systemd/system/redis6379.service
vim /lib/systemd/system/redis_6379.service
<span style="color: #a0522d;">ExecStart</span>=/apps/redis/bin/redis-server /apps/redis/etc/6379.conf --supervised systemd

cp /lib/systemd/system/redis6379.service /lib/systemd/system/redis6380.service
sed -i <span style="color: #8b2252;">"s/6379/6380/g"</span> /lib/systemd/system/redis_6380.service


systemctl daemon-reload 
systemctl enable --now redis_6379.service
systemctl enable --now redis_6380.service

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#31471;&#21475;</span>
[root@centos8 redis]#ss -ntl
State       Recv-Q       Send-Q               Local Address:Port               Peer Address:Port       
LISTEN      0            128                        0.0.0.0:6379                    0.0.0.0:*          
LISTEN      0            128                        0.0.0.0:6380                    0.0.0.0:*          
[root@centos8 ~]#tree /apps/redis/
/apps/redis/
&#9500;&#9472;&#9472; bin
&#9474;   &#9500;&#9472;&#9472; redis-benchmark
&#9474;   &#9500;&#9472;&#9472; redis-check-aof
&#9474;   &#9500;&#9472;&#9472; redis-check-rdb
&#9474;   &#9500;&#9472;&#9472; redis-cli
&#9474;   &#9500;&#9472;&#9472; redis-sentinel -&gt; redis-server
&#9474;   &#9492;&#9472;&#9472; redis-server
&#9500;&#9472;&#9472; data
&#9474;   &#9500;&#9472;&#9472; dump_6379.rdb
&#9474;   &#9500;&#9472;&#9472; dump_6380.rdb
&#9474;   &#9492;&#9472;&#9472; dump_6381.rdb
&#9500;&#9472;&#9472; etc
&#9474;   &#9500;&#9472;&#9472; 6379.conf
&#9474;   &#9500;&#9472;&#9472; 6380.conf
&#9474;   &#9492;&#9472;&#9472; 6381.conf
&#9500;&#9472;&#9472; log
&#9474;   &#9500;&#9472;&#9472; redis_6379.log
&#9474;   &#9500;&#9472;&#9472; redis_6380.log
&#9474;   &#9492;&#9472;&#9472; redis_6381.log
&#9492;&#9472;&#9472; run
    &#9500;&#9472;&#9472; redis_6379.pid
    &#9500;&#9472;&#9472; redis_6380.pid
    &#9492;&#9472;&#9472; redis_6381.pid

</pre>
</div>
</div>
</div>
<div id="outline-container-h:8180d7e3-08b3-4012-b3b3-82f29546d43b" class="outline-4">
<h4 id="h:8180d7e3-08b3-4012-b3b3-82f29546d43b">Redis相关工具和客户端链接</h4>
<div class="outline-text-4" id="text-h:8180d7e3-08b3-4012-b3b3-82f29546d43b">
</div>
<div id="outline-container-h:ab8796b2-93a7-42ba-9ae4-f20098196ff8" class="outline-5">
<h5 id="h:ab8796b2-93a7-42ba-9ae4-f20098196ff8">安装后的相关程序介绍</h5>
<div class="outline-text-5" id="text-h:ab8796b2-93a7-42ba-9ae4-f20098196ff8">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ll /apps/redis/bin/
total 42516
-rwxr-xr-x 1 redis redis  5943976 Oct 22 13:54 redis-benchmark  <span style="color: #b22222;">#</span><span style="color: #b22222;">redis &#24615;&#33021;&#27979;&#35797;&#24037;&#20855;</span>
-rwxr-xr-x 1 redis redis 10372464 Oct 22 13:54 redis-check-aof  <span style="color: #b22222;">#</span><span style="color: #b22222;">AOF&#25991;&#20214;&#26816;&#26597;&#24037;&#20855;</span>
-rwxr-xr-x 1 redis redis 10372464 Oct 22 13:54 redis-check-rdb  <span style="color: #b22222;">#</span><span style="color: #b22222;">RDB&#25991;&#20214;&#26816;&#26597;&#24037;&#20855;</span>
-rwxr-xr-x 1 redis redis  6461216 Oct 22 13:54 redis-cli        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#24037;&#20855;</span>
lrwxrwxrwx 1 redis redis       12 Oct 22 13:54 redis-sentinel -&gt; redis-server       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21736;&#20853;&#65292;&#36719;&#38142;&#25509;&#21040;server</span>
-rwxr-xr-x 1 redis redis 10372464 Oct 22 13:54 redis-server     <span style="color: #b22222;">#</span><span style="color: #b22222;">redis &#26381;&#21153;&#21551;&#21160;&#21629;&#20196;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:08631eec-6423-46bb-8170-bc99a50aaf03" class="outline-5">
<h5 id="h:08631eec-6423-46bb-8170-bc99a50aaf03">客户端连接 redis</h5>
<div class="outline-text-5" id="text-h:08631eec-6423-46bb-8170-bc99a50aaf03">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26412;&#26426;&#26080;&#23494;&#30721;&#36830;&#25509;</span>
redis-cli 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36328;&#20027;&#26426;&#26080;&#23494;&#30721;&#36830;&#25509;</span>
redis-cli -h &lt;redis&#26381;&#21153;&#22120;ip&gt; -p PORT -a &lt;PASSWORD&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:33b26990-4555-4685-a102-466dee75b951" class="outline-5">
<h5 id="h:33b26990-4555-4685-a102-466dee75b951">程序连接 Redis</h5>
<div class="outline-text-5" id="text-h:33b26990-4555-4685-a102-466dee75b951">
<p>
redis 支持多种开发语言访问
</p>

<p>
<a href="https://redis.io/docs/latest/develop/clients/">https://redis.io/docs/latest/develop/clients/</a>
</p>


<figure id="org2c93d43">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022155359117.png" alt="20201022155359117.png">

</figure>
</div>
<ul class="org-ul">
<li><a id="h:d359fa9a-422c-4df5-8afb-e35d702688ad"></a>shell 脚本写入数据到 Redis<br>
<div class="outline-text-6" id="text-h:d359fa9a-422c-4df5-8afb-e35d702688ad">
<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat redis_test.sh 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #a0522d;">NUM</span>=100
<span style="color: #a0522d;">PASS</span>=centos
<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> <span style="color: #ff00ff;">`seq $NUM`</span>;<span style="color: #a020f0;">do</span>
    redis-cli -h 127.0.0.1 -a <span style="color: #8b2252;">"$PASS"</span> --no-auth-warning set key${<span style="color: #a0522d;">i</span>} value${<span style="color: #a0522d;">i</span>}
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"key${i} value${i} &#20889;&#20837;&#23436;&#25104;"</span>
<span style="color: #a020f0;">done</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$NUM&#20010;key&#20889;&#20837;&#21040;Redis&#23436;&#25104;"</span>
</pre>
</div>
</div>
</li>
<li><a id="h:7991f1ac-743d-4e10-9d00-2c3a87869f87"></a>python 连接方式<br>
<div class="outline-text-6" id="text-h:7991f1ac-743d-4e10-9d00-2c3a87869f87">
<p>
python 多种开发库,可以支持连接redis
</p>


<figure id="orgfb3cc79">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022155905365.png" alt="20201022155905365.png">

</figure>

<p>
使用redis-py 连接 redis
</p>

<p>
官方github : <a href="https://github.com/andymccurdy/redis-py">https://github.com/andymccurdy/redis-py</a>
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum info python3-redis
Last metadata expiration check: 0:21:56 ago on Thu 22 Oct 2020 03:38:53 PM CST.
Available Packages
Name         : python3-redis
Version      : 3.3.8
Release      : 1.el8
Arch         : noarch
Size         : 131 k
Source       : python-redis-3.3.8-1.el8.src.rpm
Repo         : epel
Summary      : Python 3 interface to the Redis key-value store
URL          : https://github.com/andymccurdy/redis-py
License      : MIT
Description  : This is a Python 3 interface to the Redis key-value store.

[root@centos8 ~]#yum -y install python3 python3-redis

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#25991;&#20214;&#21517;&#19981;&#35201;&#20026;redis,&#20250;&#21644;redis&#27169;&#22359;&#21517;&#31216;&#20914;&#31361;</span>
[root@centos8 ~]#cat redis_test.py 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/env python3</span>
import redis
<span style="color: #b22222;">#</span><span style="color: #b22222;">import time</span>
pool = redis.ConnectionPool(<span style="color: #a0522d;">host</span>=<span style="color: #8b2252;">"127.0.0.1"</span>,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">password</span>=<span style="color: #8b2252;">"centos"</span>)
r = redis.Redis(<span style="color: #a0522d;">connection_pool</span>=pool)
<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> range(100):
    r.set(<span style="color: #8b2252;">"k%d"</span> % i,<span style="color: #8b2252;">"v%d"</span> % i)
<span style="color: #b22222;"># </span><span style="color: #b22222;">time.sleep(1)</span>
    <span style="color: #a0522d;">data</span>=r.get(<span style="color: #8b2252;">"k%d"</span> % i)
    print(data)

[root@centos8 ~]#python3 redis_test.py
...&#30465;&#30053;...
b<span style="color: #8b2252;">'v93'</span>
b<span style="color: #8b2252;">'v94'</span>
b<span style="color: #8b2252;">'v95'</span>
b<span style="color: #8b2252;">'v96'</span>
b<span style="color: #8b2252;">'v97'</span>
b<span style="color: #8b2252;">'v98'</span>
b<span style="color: #8b2252;">'v99'</span>
[root@centos8 ~]#redis-cli -a centos --no-auth-warning
127.0.0.1:6379&gt; get k88
<span style="color: #8b2252;">"v88"</span>
127.0.0.1:6379&gt;
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-h:159b05b6-5435-42bf-a757-c5044f0b0834" class="outline-2">
<h2 id="h:159b05b6-5435-42bf-a757-c5044f0b0834">redis 配置管理</h2>
<div class="outline-text-2" id="text-h:159b05b6-5435-42bf-a757-c5044f0b0834">
</div>
<div id="outline-container-h:244a1dfa-2acb-4d08-aa06-37522ceb45ae" class="outline-3">
<h3 id="h:244a1dfa-2acb-4d08-aa06-37522ceb45ae">redis 配置文件说明</h3>
<div class="outline-text-3" id="text-h:244a1dfa-2acb-4d08-aa06-37522ceb45ae">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">bind</span> 0.0.0.0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30417;&#21548;&#22320;&#22336;&#65292;&#21487;&#20197;&#29992;&#31354;&#26684;&#38548;&#24320;&#21518;&#22810;&#20010;&#30417;&#21548;IP</span>

protected-mode yes <span style="color: #b22222;">#</span><span style="color: #b22222;">redis3.2&#20043;&#21518;&#21152;&#20837;&#30340;&#26032;&#29305;&#24615;&#65292;&#22312;&#27809;&#26377;&#35774;&#32622;bind IP&#21644;&#23494;&#30721;&#30340;&#26102;&#20505;,redis&#21482;&#20801;&#35768;&#35775;&#38382;127.0.0.1:6379&#65292;&#21487;&#20197;&#36828;&#31243;&#36830;&#25509;&#65292;&#20294;&#24403;&#35775;&#38382;&#23558;&#25552;&#31034;&#35686;&#21578;&#20449;&#24687;&#24182;&#25298;&#32477;&#36828;&#31243;&#35775;&#38382;</span>

port 6379 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30417;&#21548;&#31471;&#21475;,&#40664;&#35748;6379/tcp</span>

tcp-backlog 511 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19977;&#27425;&#25569;&#25163;&#30340;&#26102;&#20505;server&#31471;&#25910;&#21040;client ack&#30830;&#35748;&#21495;&#20043;&#21518;&#30340;&#38431;&#21015;&#20540;&#65292;&#21363;&#20840;&#36830;&#25509;&#38431;&#21015;&#38271;&#24230;</span>

timeout 0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23458;&#25143;&#31471;&#21644;Redis&#26381;&#21153;&#31471;&#30340;&#36830;&#25509;&#36229;&#26102;&#26102;&#38388;&#65292;&#40664;&#35748;&#26159;0&#65292;&#34920;&#31034;&#27704;&#19981;&#36229;&#26102;</span>

tcp-keepalive 300 <span style="color: #b22222;">#</span><span style="color: #b22222;">tcp &#20250;&#35805;&#20445;&#25345;&#26102;&#38388;300s</span>

daemonize no <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;no,&#21363;&#30452;&#25509;&#36816;&#34892;redis-server&#31243;&#24207;&#26102;,&#19981;&#20316;&#20026;&#23432;&#25252;&#36827;&#31243;&#36816;&#34892;&#65292;&#32780;&#26159;&#20197;&#21069;&#21488;&#26041;&#24335;&#36816;&#34892;&#65292;</span>
            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#24819;&#22312;&#21518;&#21488;&#36816;&#34892;&#38656;&#25913;&#25104;yes,&#24403;redis&#20316;&#20026;&#23432;&#25252;&#36827;&#31243;&#36816;&#34892;&#30340;&#26102;&#20505;&#65292;&#23427;&#20250;&#20889;&#19968;&#20010; pid &#21040;/var/run/redis.pid &#25991;&#20214;</span>

supervised no <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21644;OS&#30456;&#20851;&#21442;&#25968;&#65292;&#21487;&#35774;&#32622;&#36890;&#36807;upstart&#21644;systemd&#31649;&#29702;Redis&#23432;&#25252;&#36827;&#31243;&#65292;centos7&#21518;&#37117;&#20351;&#29992;systemd</span>

pidfile /var/run/redis_6379.pid <span style="color: #b22222;">#</span><span style="color: #b22222;">pid&#25991;&#20214;&#36335;&#24452;,&#21487;&#20197;&#20462;&#25913;&#20026;/apps/redis/run/redis_6379.pid</span>

loglevel notice <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26085;&#24535;&#32423;&#21035;</span>

logfile <span style="color: #8b2252;">"/path/redis.log"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26085;&#24535;&#36335;&#24452;,&#31034;&#20363;:logfile "/apps/redis/log/redis_6379.log"</span>

databases 16 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#25968;&#25454;&#24211;&#25968;&#37327;&#65292;&#40664;&#35748;&#65306;0-15&#65292;&#20849;16&#20010;&#24211;</span>

always-show-logo yes <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#21551;&#21160;redis &#26102;&#26159;&#21542;&#26174;&#31034;&#25110;&#22312;&#26085;&#24535;&#20013;&#35760;&#24405;&#35760;&#24405;redis&#30340;logo</span>

save 900 1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;900&#31186;&#20869;&#26377;1&#20010;key&#20869;&#23481;&#21457;&#29983;&#26356;&#25913;,&#23601;&#25191;&#34892;&#24555;&#29031;&#26426;&#21046;</span>
save 300 10 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;300&#31186;&#20869;&#26377;10&#20010;key&#20869;&#23481;&#21457;&#29983;&#26356;&#25913;,&#23601;&#25191;&#34892;&#24555;&#29031;&#26426;&#21046;</span>
save 60 10000 <span style="color: #b22222;">#</span><span style="color: #b22222;">60&#31186;&#20869;&#22914;&#26524;&#26377;10000&#20010;key&#20197;&#19978;&#30340;&#21464;&#21270;&#65292;&#23601;&#33258;&#21160;&#24555;&#29031;&#22791;&#20221;</span>

stop-writes-on-bgsave-error yes <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#20026;yes&#26102;,&#21487;&#33021;&#20250;&#22240;&#31354;&#38388;&#28385;&#31561;&#21407;&#22240;&#24555;&#29031;&#26080;&#27861;&#20445;&#23384;&#20986;&#38169;&#26102;&#65292;&#20250;&#31105;&#27490;redis&#20889;&#20837;&#25805;&#20316;&#65292;&#29983;&#20135;&#24314;&#35758;&#20026;no #&#27492;&#39033;&#21482;&#38024;&#23545;&#37197;&#32622;&#25991;&#20214;&#20013;&#30340;&#33258;&#21160;save&#26377;&#25928;</span>

rdbcompression yes <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25345;&#20037;&#21270;&#21040;RDB&#25991;&#20214;&#26102;&#65292;&#26159;&#21542;&#21387;&#32553;&#65292;"yes"&#20026;&#21387;&#32553;&#65292;"no"&#21017;&#21453;&#20043;</span>

rdbchecksum yes <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#23545;&#22791;&#20221;&#25991;&#20214;&#24320;&#21551;RC64&#26657;&#39564;&#65292;&#40664;&#35748;&#26159;&#24320;&#21551;</span>

dbfilename dump.rdb <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24555;&#29031;&#25991;&#20214;&#21517;</span>

dir ./ <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24555;&#29031;&#25991;&#20214;&#20445;&#23384;&#36335;&#24452;&#65292;&#31034;&#20363;&#65306;dir "/apps/redis/data"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#20174;&#22797;&#21046;&#30456;&#20851;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">replicaof &lt;masterip&gt; &lt;masterport&gt; #&#25351;&#23450;&#22797;&#21046;&#30340;master&#20027;&#26426;&#22320;&#22336;&#21644;&#31471;&#21475;&#65292;5.0&#29256;&#20043;&#21069;&#30340;&#25351;&#20196;&#20026;</span>
slaveof
<span style="color: #b22222;"># </span><span style="color: #b22222;">masterauth &lt;master-password&gt; #&#25351;&#23450;&#22797;&#21046;&#30340;master&#20027;&#26426;&#30340;&#23494;&#30721;</span>

replica-serve-stale-data yes <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#20174;&#24211;&#21516;&#20027;&#24211;&#22833;&#21435;&#36830;&#25509;&#25110;&#32773;&#22797;&#21046;&#27491;&#22312;&#36827;&#34892;&#65292;&#20174;&#26426;&#24211;&#26377;&#20004;&#31181;&#36816;&#34892;&#26041;&#24335;&#65306;</span>
1&#12289;&#35774;&#32622;&#20026;yes(&#40664;&#35748;&#35774;&#32622;)&#65292;&#20174;&#24211;&#20250;&#32487;&#32493;&#21709;&#24212;&#23458;&#25143;&#31471;&#30340;&#35835;&#35831;&#27714;&#65292;&#27492;&#20026;&#24314;&#35758;&#20540;
2&#12289;&#35774;&#32622;&#20026;no&#65292;&#38500;&#21435;&#29305;&#23450;&#21629;&#20196;&#22806;&#30340;&#20219;&#20309;&#35831;&#27714;&#37117;&#20250;&#36820;&#22238;&#19968;&#20010;&#38169;&#35823;<span style="color: #8b2252;">"SYNC with master in progress"</span>&#12290;

replica-read-only yes <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#35774;&#32622;&#20174;&#24211;&#21482;&#35835;&#65292;&#24314;&#35758;&#20540;&#20026;yes,&#21542;&#21017;&#20027;&#24211;&#21516;&#27493;&#20174;&#24211;&#26102;&#21487;&#33021;&#20250;&#35206;&#30422;&#25968;&#25454;&#65292;&#36896;&#25104;&#25968;&#25454;&#20002;&#22833;</span>

repl-diskless-sync no <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#20351;&#29992;socket&#26041;&#24335;&#22797;&#21046;&#25968;&#25454;(&#26080;&#30424;&#21516;&#27493;)&#65292;&#26032;slave&#31532;&#19968;&#27425;&#36830;&#25509;master&#26102;&#38656;&#35201;&#20570;&#25968;&#25454;&#30340;&#20840;&#37327;&#21516;&#27493;&#65292;redis server&#23601;&#35201;&#20174;&#20869;&#23384;dump&#20986;&#26032;&#30340;RDB&#25991;&#20214;&#65292;&#28982;&#21518;&#20174;master&#20256;&#21040;slave&#65292;&#26377;&#20004;&#31181;&#26041;&#24335;&#25226;RDB&#25991;&#20214;&#20256;&#36755;&#32473;&#23458;&#25143;&#31471;&#65306;</span>
1&#12289;&#22522;&#20110;&#30828;&#30424;&#65288;disk-backed&#65289;&#65306;&#20026;no&#26102;&#65292;master&#21019;&#24314;&#19968;&#20010;&#26032;&#36827;&#31243;dump&#29983;&#25104;RDB&#30913;&#30424;&#25991;&#20214;&#65292;RDB&#23436;&#25104;&#20043;&#21518;&#30001;
&#29238;&#36827;&#31243;&#65288;&#21363;&#20027;&#36827;&#31243;&#65289;&#23558;RDB&#25991;&#20214;&#21457;&#36865;&#32473;slaves&#65292;&#27492;&#20026;&#40664;&#35748;&#20540;
2&#12289;&#22522;&#20110;socket&#65288;diskless&#65289;&#65306;master&#21019;&#24314;&#19968;&#20010;&#26032;&#36827;&#31243;&#30452;&#25509;dump RDB&#33267;slave&#30340;&#32593;&#32476;socket&#65292;&#19981;&#32463;&#36807;&#20027;&#36827;&#31243;&#21644;&#30828;&#30424;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25512;&#33616;&#20351;&#29992;&#22522;&#20110;&#30828;&#30424;&#65288;&#20026;no&#65289;&#65292;&#26159;&#22240;&#20026;RDB&#25991;&#20214;&#21019;&#24314;&#21518;&#65292;&#21487;&#20197;&#21516;&#26102;&#20256;&#36755;&#32473;&#26356;&#22810;&#30340;slave&#65292;&#20294;&#26159;&#22522;&#20110;socket(&#20026;yes)&#65292; &#26032;slave&#36830;&#25509;&#21040;master&#20043;&#21518;&#24471;&#36880;&#20010;&#21516;&#27493;&#25968;&#25454;&#12290;&#21482;&#26377;&#24403;&#30913;&#30424;I/O&#36739;&#24930;&#19988;&#32593;&#32476;&#36739;&#24555;&#26102;&#65292;&#21487;&#29992;diskless(yes),&#21542;&#21017;&#19968;&#33324;&#24314;&#35758;&#20351;&#29992;&#30913;&#30424;(no)</span>

repl-diskless-sync-delay 5 <span style="color: #b22222;">#</span><span style="color: #b22222;">diskless&#26102;&#22797;&#21046;&#30340;&#26381;&#21153;&#22120;&#31561;&#24453;&#30340;&#24310;&#36831;&#26102;&#38388;&#65292;&#35774;&#32622;0&#20026;&#20851;&#38381;&#65292;&#22312;&#24310;&#36831;&#26102;&#38388;&#20869;&#21040;&#36798;&#30340;&#23458;&#25143;&#31471;&#65292;&#20250;&#19968;&#36215;&#36890;&#36807;diskless&#26041;&#24335;&#21516;&#27493;&#25968;&#25454;&#65292;&#20294;&#26159;&#19968;&#26086;&#22797;&#21046;&#24320;&#22987;&#65292;master&#33410;&#28857;&#19981;&#20250;&#20877;&#25509;&#25910;&#26032;slave&#30340;&#22797;&#21046;&#35831;&#27714;&#65292;&#30452;&#21040;&#19979;&#19968;&#27425;&#21516;&#27493;&#24320;&#22987;&#25165;&#20877;&#25509;&#25910;&#26032;&#35831;&#27714;&#12290;&#21363;&#26080;&#27861;&#20026;&#24310;&#36831;&#26102;&#38388;&#21518;&#21040;&#36798;&#30340;&#26032;&#21103;&#26412;&#25552;&#20379;&#26381;&#21153;&#65292;&#26032;&#21103;&#26412;&#23558;&#25490;&#38431;&#31561;&#24453;&#19979;&#19968;&#27425;RDB&#20256;&#36755;&#65292;&#22240;&#27492;&#26381;&#21153;&#22120;&#20250;&#31561;&#24453;&#19968;&#27573;&#26102;&#38388;&#25165;&#33021;&#35753;&#26356;&#22810;&#21103;&#26412;&#21040;&#36798;&#12290;&#25512;&#33616;&#20540;&#65306;30-60</span>

repl-ping-replica-period 10 <span style="color: #b22222;">#</span><span style="color: #b22222;">slave&#26681;&#25454;master&#25351;&#23450;&#30340;&#26102;&#38388;&#36827;&#34892;&#21608;&#26399;&#24615;&#30340;PING master,&#29992;&#20110;&#30417;&#27979;master&#29366;&#24577;,&#40664;&#35748;10s</span>

repl-timeout 60 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;&#36830;&#25509;&#30340;&#36229;&#26102;&#26102;&#38388;&#65292;&#38656;&#35201;&#22823;&#20110;repl-ping-slave-period&#65292;&#21542;&#21017;&#20250;&#32463;&#24120;&#25253;&#36229;&#26102;</span>

repl-disable-tcp-nodelay no <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#22312;slave&#22871;&#25509;&#23383;&#21457;&#36865;SYNC&#20043;&#21518;&#31105;&#29992; TCP_NODELAY&#65292;&#22914;&#26524;&#36873;&#25321;"yes"&#65292;Redis&#23558;&#21512;&#24182;&#22810;&#20010;&#25253;&#25991;&#20026;&#19968;&#20010;&#22823;&#30340;&#25253;&#25991;&#65292;&#20174;&#32780;&#20351;&#29992;&#26356;&#23569;&#25968;&#37327;&#30340;&#21253;&#21521;slaves&#21457;&#36865;&#25968;&#25454;&#65292;&#20294;&#26159;&#23558;&#20351;&#25968;&#25454;&#20256;&#36755;&#21040;slave&#19978;&#26377;&#24310;&#36831;&#65292;Linux&#20869;&#26680;&#30340;&#40664;&#35748;&#37197;&#32622;&#20250;&#36798;&#21040;40&#27627;&#31186;&#65292;&#22914;&#26524; "no" &#65292;&#25968;&#25454;&#20256;&#36755;&#21040;slave&#30340;&#24310;&#36831;&#23558;&#20250;&#20943;&#23569;&#65292;&#20294;&#35201;&#20351;&#29992;&#26356;&#22810;&#30340;&#24102;&#23485;</span>

repl-backlog-size 512mb <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;&#32531;&#20914;&#21306;&#20869;&#23384;&#22823;&#23567;&#65292;&#24403;slave&#26029;&#24320;&#36830;&#25509;&#19968;&#27573;&#26102;&#38388;&#21518;&#65292;&#35813;&#32531;&#20914;&#21306;&#20250;&#32047;&#31215;&#22797;&#21046;&#21103;&#26412;&#25968;&#25454;&#65292;&#22240;&#27492;&#24403;slave &#37325;&#26032;&#36830;&#25509;&#26102;&#65292;&#36890;&#24120;&#19981;&#38656;&#35201;&#23436;&#20840;&#37325;&#26032;&#21516;&#27493;&#65292;&#21482;&#38656;&#20256;&#36882;&#22312;&#21103;&#26412;&#20013;&#30340;&#26029;&#24320;&#36830;&#25509;&#21518;&#27809;&#26377;&#21516;&#27493;&#30340;&#37096;&#20998;&#25968;&#25454;&#21363;&#21487;&#12290;&#21482;&#26377;&#22312;&#33267;&#23569;&#26377;&#19968;&#20010;slave&#36830;&#25509;&#20043;&#21518;&#25165;&#20998;&#37197;&#27492;&#20869;&#23384;&#31354;&#38388;,&#24314;&#35758;&#24314;&#31435;&#20027;&#20174;&#26102;&#27492;&#20540;&#35201;&#35843;&#22823;&#19968;&#20123;&#25110;&#22312;&#20302;&#23792;&#26399;&#37197;&#32622;,&#21542;&#21017;&#20250;&#23548;&#33268;&#21516;&#27493;&#21040;slave&#22833;&#36133;</span>

repl-backlog-ttl 3600 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#38271;&#26102;&#38388;&#20869;master&#27809;&#26377;slave&#36830;&#25509;&#65292;&#23601;&#28165;&#31354;backlog&#32531;&#20914;&#21306;</span>

replica-priority 100 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;master&#19981;&#21487;&#29992;&#65292;&#21736;&#20853;Sentinel&#20250;&#26681;&#25454;slave&#30340;&#20248;&#20808;&#32423;&#36873;&#20030;&#19968;&#20010;master&#65292;&#27492;&#20540;&#26368;&#20302;&#30340;slave&#20250;&#24403;&#36873;master&#65292;&#32780;&#37197;&#32622;&#25104;0&#65292;&#27704;&#36828;&#19981;&#20250;&#34987;&#36873;&#20030;&#65292;&#19968;&#33324;&#22810;&#20010;slave&#37117;&#35774;&#20026;&#19968;&#26679;&#30340;&#20540;&#65292;&#35753;&#20854;&#33258;&#21160;&#36873;&#25321;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">min-replicas-to-write 3 #&#33267;&#23569;&#26377;3&#20010;&#21487;&#36830;&#25509;&#30340;slave&#65292;mater&#25165;&#25509;&#21463;&#20889;&#25805;&#20316;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">min-replicas-max-lag 10 #&#21644;&#19978;&#38754;&#33267;&#23569;3&#20010;slave&#30340;ping&#24310;&#36831;&#19981;&#33021;&#36229;&#36807;10&#31186;&#65292;&#21542;&#21017;master&#20063;&#23558;&#20572;&#27490;&#20889;&#25805;&#20316;</span>

requirepass foobared <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;redis&#36830;&#25509;&#23494;&#30721;&#65292;&#20043;&#21518;&#38656;&#35201;AUTH pass,&#22914;&#26524;&#26377;&#29305;&#27530;&#31526;&#21495;&#65292;&#29992;" "&#24341;&#36215;&#26469;,&#29983;&#20135;&#24314;&#35758;&#35774;&#32622;</span>

rename-command <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21629;&#21517;&#19968;&#20123;&#39640;&#21361;&#21629;&#20196;&#65292;&#31034;&#20363;&#65306;rename-command FLUSHALL "" &#31105;&#29992;&#21629;&#20196;</span>
               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;: rename-command del magedu</span>

maxclients 10000 <span style="color: #b22222;">#</span><span style="color: #b22222;">Redis&#26368;&#22823;&#36830;&#25509;&#23458;&#25143;&#31471;</span>

maxmemory &lt;bytes&gt; <span style="color: #b22222;">#</span><span style="color: #b22222;">redis&#20351;&#29992;&#30340;&#26368;&#22823;&#20869;&#23384;&#65292;&#21333;&#20301;&#20026;bytes&#23383;&#33410;&#65292;0&#20026;&#19981;&#38480;&#21046;&#65292;&#24314;&#35758;&#35774;&#20026;&#29289;&#29702;&#20869;&#23384;&#19968;&#21322;&#65292;8G&#20869;&#23384;&#30340;&#35745;&#31639;&#26041;&#24335;8(G)*1024(MB)1024(KB)*1024(Kbyte)&#65292;&#38656;&#35201;&#27880;&#24847;&#30340;&#26159;&#32531;&#20914;&#21306;&#26159;&#19981;&#35745;&#31639;&#22312;maxmemory&#20869;,&#29983;&#20135;&#20013;&#22914;&#26524;&#19981;&#35774;&#32622;&#27492;&#39033;,&#21487;&#33021;&#20250;&#23548;&#33268;OOM</span>

appendonly no <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#24320;&#21551;AOF&#26085;&#24535;&#35760;&#24405;&#65292;&#40664;&#35748;redis&#20351;&#29992;&#30340;&#26159;rdb&#26041;&#24335;&#25345;&#20037;&#21270;&#65292;&#36825;&#31181;&#26041;&#24335;&#22312;&#35768;&#22810;&#24212;&#29992;&#20013;&#24050;&#32463;&#36275;&#22815;&#29992;&#20102;&#65292;&#20294;&#26159;redis&#22914;&#26524;&#20013;&#36884;&#23445;&#26426;&#65292;&#20250;&#23548;&#33268;&#21487;&#33021;&#26377;&#20960;&#20998;&#38047;&#30340;&#25968;&#25454;&#20002;&#22833;(&#21462;&#20915;&#20110;dump&#25968;&#25454;&#30340;&#38388;&#38548;&#26102;&#38388;)&#65292;&#26681;&#25454;save&#26469;&#31574;&#30053;&#36827;&#34892;&#25345;&#20037;&#21270;&#65292;Append Only File&#26159;&#21478;&#19968;&#31181;&#25345;&#20037;&#21270;&#26041;&#24335;&#65292;&#21487;&#20197;&#25552;&#20379;&#26356;&#22909;&#30340;&#25345;&#20037;&#21270;&#29305;&#24615;&#65292;Redis</span>
&#20250;&#25226;&#27599;&#27425;&#20889;&#20837;&#30340;&#25968;&#25454;&#22312;&#25509;&#25910;&#21518;&#37117;&#20889;&#20837; appendonly.aof &#25991;&#20214;&#65292;&#27599;&#27425;&#21551;&#21160;&#26102;Redis&#37117;&#20250;&#20808;&#25226;&#36825;&#20010;&#25991;&#20214;&#30340;&#25968;&#25454;&#35835;&#20837;&#20869;&#23384;&#37324;&#65292;&#20808;&#24573;&#30053;RDB&#25991;&#20214;&#12290;&#40664;&#35748;&#19981;&#21551;&#29992;&#27492;&#21151;&#33021;

appendfilename <span style="color: #8b2252;">"appendonly.aof"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25991;&#26412;&#25991;&#20214;AOF&#30340;&#25991;&#20214;&#21517;&#65292;&#23384;&#25918;&#22312;dir&#25351;&#20196;&#25351;&#23450;&#30340;&#30446;&#24405;&#20013;</span>

appendfsync everysec <span style="color: #b22222;">#</span><span style="color: #b22222;">aof&#25345;&#20037;&#21270;&#31574;&#30053;&#30340;&#37197;&#32622;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">no&#34920;&#31034;&#30001;&#25805;&#20316;&#31995;&#32479;&#20445;&#35777;&#25968;&#25454;&#21516;&#27493;&#21040;&#30913;&#30424;,Linux&#30340;&#40664;&#35748;fsync&#31574;&#30053;&#26159;30&#31186;&#65292;&#26368;&#22810;&#20250;&#20002;&#22833;30s&#30340;&#25968;&#25454;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">always&#34920;&#31034;&#27599;&#27425;&#20889;&#20837;&#37117;&#25191;&#34892;fsync&#65292;&#20197;&#20445;&#35777;&#25968;&#25454;&#21516;&#27493;&#21040;&#30913;&#30424;,&#23433;&#20840;&#24615;&#39640;,&#24615;&#33021;&#36739;&#24046;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">everysec&#34920;&#31034;&#27599;&#31186;&#25191;&#34892;&#19968;&#27425;fsync&#65292;&#21487;&#33021;&#20250;&#23548;&#33268;&#20002;&#22833;&#36825;1s&#25968;&#25454;,&#27492;&#20026;&#40664;&#35748;&#20540;,&#20063;&#29983;&#20135;&#24314;&#35758;&#20540;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#26102;&#22312;&#25191;&#34892;bgrewriteaof&#25805;&#20316;&#21644;&#20027;&#36827;&#31243;&#20889;aof&#25991;&#20214;&#30340;&#25805;&#20316;&#65292;&#20004;&#32773;&#37117;&#20250;&#25805;&#20316;&#30913;&#30424;&#65292;&#32780;bgrewriteaof&#24448;&#24448;&#20250;&#28041;&#21450;&#22823;&#37327;&#30913;&#30424;&#25805;&#20316;&#65292;&#36825;&#26679;&#23601;&#20250;&#36896;&#25104;&#20027;&#36827;&#31243;&#22312;&#20889;aof&#25991;&#20214;&#30340;&#26102;&#20505;&#20986;&#29616;&#38459;&#22622;&#30340;&#24773;&#24418;,&#20197;&#19979;&#21442;&#25968;&#23454;&#29616;&#25511;&#21046;</span>
no-appendfsync-on-rewrite no <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;aof rewrite&#26399;&#38388;,&#26159;&#21542;&#23545;aof&#26032;&#35760;&#24405;&#30340;append&#26242;&#32531;&#20351;&#29992;&#25991;&#20214;&#21516;&#27493;&#31574;&#30053;,&#20027;&#35201;&#32771;&#34385;&#30913;&#30424;IO&#24320;&#25903;&#21644;&#35831;&#27714;&#38459;&#22622;&#26102;&#38388;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#20026;no,&#34920;&#31034;"&#19981;&#26242;&#32531;",&#26032;&#30340;aof&#35760;&#24405;&#20173;&#28982;&#20250;&#34987;&#31435;&#21363;&#21516;&#27493;&#21040;&#30913;&#30424;&#65292;&#26159;&#26368;&#23433;&#20840;&#30340;&#26041;&#24335;&#65292;&#19981;&#20250;&#20002;&#22833;&#25968;&#25454;&#65292;&#20294;&#26159;&#35201;&#24525;&#21463;&#38459;&#22622;&#30340;&#38382;&#39064;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;yes,&#30456;&#24403;&#20110;&#23558;appendfsync&#35774;&#32622;&#20026;no&#65292;&#36825;&#35828;&#26126;&#24182;&#27809;&#26377;&#25191;&#34892;&#30913;&#30424;&#25805;&#20316;&#65292;&#21482;&#26159;&#20889;&#20837;&#20102;&#32531;&#20914;&#21306;&#65292;&#22240;&#27492;&#36825;&#26679;&#24182;&#19981;&#20250;&#36896;&#25104;&#38459;&#22622;&#65288;&#22240;&#20026;&#27809;&#26377;&#31454;&#20105;&#30913;&#30424;&#65289;&#65292;&#20294;&#26159;&#22914;&#26524;&#36825;&#20010;&#26102;&#20505;redis&#25346;&#25481;&#65292;&#23601;&#20250;&#20002;&#22833;&#25968;&#25454;&#12290;&#20002;&#22833;&#22810;&#23569;&#25968;&#25454;&#21602;&#65311;Linux&#30340;&#40664;&#35748;fsync&#31574;&#30053;&#26159;30&#31186;&#65292;&#26368;&#22810;&#20250;&#20002;&#22833;30s&#30340;&#25968;&#25454;,&#20294;&#30001;&#20110;yes&#24615;&#33021;&#36739;&#22909;&#32780;&#19988;&#20250;&#36991;&#20813;&#20986;&#29616;&#38459;&#22622;&#22240;&#27492;&#27604;&#36739;&#25512;&#33616;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">rewrite &#21363;&#23545;aof&#25991;&#20214;&#36827;&#34892;&#25972;&#29702;,&#23558;&#31354;&#38386;&#31354;&#38388;&#22238;&#25910;,&#20174;&#32780;&#21487;&#20197;&#20943;&#23569;&#24674;&#22797;&#25968;&#25454;&#26102;&#38388;</span>

auto-aof-rewrite-percentage 100 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;Aof log&#22686;&#38271;&#36229;&#36807;&#25351;&#23450;&#30334;&#20998;&#27604;&#20363;&#26102;&#65292;&#37325;&#20889;AOF&#25991;&#20214;&#65292;&#35774;&#32622;&#20026;0&#34920;&#31034;&#19981;&#33258;&#21160;&#37325;&#20889;Aof&#26085;&#24535;&#65292;&#37325;&#20889;&#26159;&#20026;&#20102;&#20351;aof&#20307;&#31215;&#20445;&#25345;&#26368;&#23567;&#65292;&#20294;&#26159;&#36824;&#21487;&#20197;&#30830;&#20445;&#20445;&#23384;&#26368;&#23436;&#25972;&#30340;&#25968;&#25454;</span>

auto-aof-rewrite-min-size 64mb <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35302;&#21457;aof rewrite&#30340;&#26368;&#23567;&#25991;&#20214;&#22823;&#23567;</span>

aof-load-truncated yes <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#21152;&#36733;&#30001;&#20110;&#26576;&#20123;&#21407;&#22240;&#23548;&#33268;&#30340;&#26411;&#23614;&#24322;&#24120;&#30340;AOF&#25991;&#20214;(&#20027;&#36827;&#31243;&#34987;kill/&#26029;&#30005;&#31561;)&#65292;&#24314;&#35758;yes</span>

aof-use-rdb-preamble no <span style="color: #b22222;">#</span><span style="color: #b22222;">redis4.0&#26032;&#22686;RDB-AOF&#28151;&#21512;&#25345;&#20037;&#21270;&#26684;&#24335;&#65292;&#22312;&#24320;&#21551;&#20102;&#36825;&#20010;&#21151;&#33021;&#20043;&#21518;&#65292;AOF&#37325;&#20889;&#20135;&#29983;&#30340;&#25991;&#20214;&#23558;&#21516;&#26102;&#21253;&#21547;RDB&#26684;&#24335;&#30340;&#20869;&#23481;&#21644;AOF&#26684;&#24335;&#30340;&#20869;&#23481;&#65292;&#20854;&#20013;RDB&#26684;&#24335;&#30340;&#20869;&#23481;&#29992;&#20110;&#35760;&#24405;&#24050;&#26377;&#30340;&#25968;&#25454;&#65292;&#32780;AOF&#26684;&#24335;&#30340;&#20869;&#23481;&#21017;&#29992;&#20110;&#35760;&#24405;&#26368;&#36817;&#21457;&#29983;&#20102;&#21464;&#21270;&#30340;&#25968;&#25454;&#65292;&#36825;&#26679;Redis&#23601;&#21487;&#20197;&#21516;&#26102;&#20860;&#26377;RDB&#25345;&#20037;&#21270;&#21644;AOF&#25345;&#20037;&#21270;&#30340;&#20248;&#28857;&#65288;&#26082;&#33021;&#22815;&#24555;&#36895;&#22320;&#29983;&#25104;&#37325;&#20889;&#25991;&#20214;&#65292;&#20063;&#33021;&#22815;&#22312;&#20986;&#29616;&#38382;&#39064;&#26102;&#65292;&#24555;&#36895;&#22320;&#36733;&#20837;&#25968;&#25454;&#65289;,&#40664;&#35748;&#20026;no,&#21363;&#19981;&#21551;&#29992;&#27492;&#21151;&#33021;</span>

lua-time-limit 5000 <span style="color: #b22222;">#</span><span style="color: #b22222;">lua&#33050;&#26412;&#30340;&#26368;&#22823;&#25191;&#34892;&#26102;&#38388;&#65292;&#21333;&#20301;&#20026;&#27627;&#31186;</span>

cluster-enabled yes <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#24320;&#21551;&#38598;&#32676;&#27169;&#24335;&#65292;&#40664;&#35748;&#19981;&#24320;&#21551;,&#21363;&#21333;&#26426;&#27169;&#24335;</span>

cluster-config-file nodes-6379.conf <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30001;node&#33410;&#28857;&#33258;&#21160;&#29983;&#25104;&#30340;&#38598;&#32676;&#37197;&#32622;&#25991;&#20214;&#21517;&#31216;</span>

cluster-node-timeout 15000 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38598;&#32676;&#20013;node&#33410;&#28857;&#36830;&#25509;&#36229;&#26102;&#26102;&#38388;&#65292;&#21333;&#20301;ms,&#36229;&#36807;&#27492;&#26102;&#38388;&#65292;&#20250;&#36386;&#20986;&#38598;&#32676;</span>

cluster-replica-validity-factor 10 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21333;&#20301;&#20026;&#27425;,&#22312;&#25191;&#34892;&#25925;&#38556;&#36716;&#31227;&#30340;&#26102;&#20505;&#21487;&#33021;&#26377;&#20123;&#33410;&#28857;&#21644;master&#26029;&#24320;&#19968;&#27573;&#26102;&#38388;&#23548;&#33268;&#25968;&#25454;&#27604;&#36739;&#26087;&#65292;&#36825;&#20123;&#33410;&#28857;&#23601;&#19981;&#36866;&#29992;&#20110;&#36873;&#20030;&#20026;master&#65292;&#36229;&#36807;&#36825;&#20010;&#26102;&#38388;&#30340;&#23601;&#19981;&#20250;&#34987;&#36827;&#34892;&#25925;&#38556;&#36716;&#31227;,&#19981;&#33021;&#24403;&#36873;master&#65292;&#35745;&#31639;&#20844;&#24335;&#65306;(node-timeout * replica-validity-factor) + repl-pingreplica-period</span>

cluster-migration-barrier 1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38598;&#32676;&#36801;&#31227;&#23631;&#38556;&#65292;&#19968;&#20010;&#20027;&#33410;&#28857;&#33267;&#23569;&#25317;&#26377;1&#20010;&#27491;&#24120;&#24037;&#20316;&#30340;&#20174;&#33410;&#28857;&#65292;&#21363;&#22914;&#26524;&#20027;&#33410;&#28857;&#30340;slave&#33410;&#28857;&#25925;&#38556;&#21518;&#20250;&#23558;&#22810;&#20313;&#30340;&#20174;&#33410;&#28857;&#20998;&#37197;&#21040;&#24403;&#21069;&#20027;&#33410;&#28857;&#25104;&#20026;&#20854;&#26032;&#30340;&#20174;&#33410;&#28857;&#12290;</span>

cluster-require-full-coverage yes <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38598;&#32676;&#35831;&#27714;&#27133;&#20301;&#20840;&#37096;&#35206;&#30422;&#65292;&#22914;&#26524;&#19968;&#20010;&#20027;&#24211;&#23445;&#26426;&#19988;&#27809;&#26377;&#22791;&#24211;&#23601;&#20250;&#20986;&#29616;&#38598;&#32676;&#27133;&#20301;&#19981;&#20840;&#65292;&#37027;&#20040;yes&#26102;redis&#38598;&#32676;&#27133;&#20301;&#39564;&#35777;&#19981;&#20840;,&#23601;&#19981;&#20877;&#23545;&#22806;&#25552;&#20379;&#26381;&#21153;(&#23545;key&#36171;&#20540;&#26102;,&#20250;&#20986;&#29616;CLUSTERDOWN The cluster is down&#30340;&#31034;,cluster_state:fail,&#20294;ping &#20173;PONG)&#65292;&#32780;no&#21017;&#21487;&#20197;&#32487;&#32493;&#20351;&#29992;,&#20294;&#26159;&#20250;&#20986;&#29616;&#26597;&#35810;&#25968;&#25454;&#26597;&#19981;&#21040;&#30340;&#24773;&#20917;(&#22240;&#20026;&#26377;&#25968;&#25454;&#20002;&#22833;)&#12290;&#29983;&#20135;&#24314;&#35758;&#20026;no </span>

cluster-replica-no-failover no <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#20026;yes,&#27492;&#36873;&#39033;&#38459;&#27490;&#22312;&#20027;&#26381;&#21153;&#22120;&#21457;&#29983;&#25925;&#38556;&#26102;&#23581;&#35797;&#23545;&#20854;&#20027;&#26381;&#21153;&#22120;&#36827;&#34892;&#25925;&#38556;&#36716;&#31227;&#12290; &#20294;&#26159;&#65292;&#20027;&#26381;&#21153;&#22120;&#20173;&#28982;&#21487;&#20197;&#25191;&#34892;&#25163;&#21160;&#24378;&#21046;&#25925;&#38556;&#36716;&#31227;&#65292;&#19968;&#33324;&#20026;no</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">Slow log &#26159; Redis &#29992;&#26469;&#35760;&#24405;&#36229;&#36807;&#25351;&#23450;&#25191;&#34892;&#26102;&#38388;&#30340;&#26085;&#24535;&#31995;&#32479;&#65292;&#25191;&#34892;&#26102;&#38388;&#19981;&#21253;&#25324;&#19982;&#23458;&#25143;&#31471;&#20132;&#35848;&#65292;&#21457;&#36865;&#22238;&#22797;&#31561;I/O&#25805;&#20316;&#65292;&#32780;&#26159;&#23454;&#38469;&#25191;&#34892;&#21629;&#20196;&#25152;&#38656;&#30340;&#26102;&#38388;&#65288;&#22312;&#35813;&#38454;&#27573;&#32447;&#31243;&#34987;&#38459;&#22622;&#24182;&#19988;&#19981;&#33021;&#21516;&#26102;&#20026;&#20854;&#23427;&#35831;&#27714;&#25552;&#20379;&#26381;&#21153;&#65289;,&#30001;&#20110;slow log &#20445;&#23384;&#22312;&#20869;&#23384;&#37324;&#38754;&#65292;&#35835;&#20889;&#36895;&#24230;&#38750;&#24120;&#24555;&#65292;&#22240;&#27492;&#21487;&#25918;&#24515;&#22320;&#20351;&#29992;&#65292;&#19981;&#24517;&#25285;&#24515;&#22240;&#20026;&#24320;&#21551; slow log &#32780;&#24433;&#21709;Redis &#30340;&#36895;&#24230;</span>

slowlog-log-slower-than 10000 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#24494;&#31186;&#20026;&#21333;&#20301;&#30340;&#24930;&#26085;&#24535;&#35760;&#24405;&#65292;&#20026;&#36127;&#25968;&#20250;&#31105;&#29992;&#24930;&#26085;&#24535;&#65292;&#20026;0&#20250;&#35760;&#24405;&#27599;&#20010;&#21629;&#20196;&#25805;&#20316;&#12290;&#40664;&#35748;&#20540;&#20026;10ms,&#19968;&#33324;&#19968;&#26465;&#21629;&#20196;&#25191;&#34892;&#37117;&#22312;&#24494;&#31186;&#32423;,&#29983;&#20135;&#24314;&#35758;&#35774;&#20026;1ms</span>

slowlog-max-len 128 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#22810;&#35760;&#24405;&#22810;&#23569;&#26465;&#24930;&#26085;&#24535;&#30340;&#20445;&#23384;&#38431;&#21015;&#38271;&#24230;&#65292;&#36798;&#21040;&#27492;&#38271;&#24230;&#21518;&#65292;&#35760;&#24405;&#26032;&#21629;&#20196;&#20250;&#23558;&#26368;&#26087;&#30340;&#21629;&#20196;&#20174;&#21629;&#20196;&#38431;&#21015;&#20013;&#21024;&#38500;&#65292;&#20197;&#27492;&#28378;&#21160;&#21024;&#38500;,&#21363;,&#20808;&#36827;&#20808;&#20986;,&#38431;&#21015;&#22266;&#23450;&#38271;&#24230;,&#40664;&#35748;128,&#20540;&#20559;&#23567;,&#29983;&#20135;&#24314;&#35758;&#35774;&#20026;1000&#20197;&#19978;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c4bf4831-aabb-46b2-8261-c8db2ccb34e2" class="outline-3">
<h3 id="h:c4bf4831-aabb-46b2-8261-c8db2ccb34e2">config 动态修改配置</h3>
<div class="outline-text-3" id="text-h:c4bf4831-aabb-46b2-8261-c8db2ccb34e2">
<p>
config
命令用于查看当前redis配置、以及不重启redis服务实现动态更改redis配置等
</p>

<p>
<b>注意：不是所有配置都可以动态修改,且此方式无法持久保存</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">CONFIG SET parameter value
&#26102;&#38388;&#22797;&#26434;&#24230;&#65306;O(1)
CONFIG SET &#21629;&#20196;&#21487;&#20197;&#21160;&#24577;&#22320;&#35843;&#25972; Redis &#26381;&#21153;&#22120;&#30340;&#37197;&#32622;(configuration)&#32780;&#26080;&#39035;&#37325;&#21551;&#12290;

&#20320;&#21487;&#20197;&#20351;&#29992;&#23427;&#20462;&#25913;&#37197;&#32622;&#21442;&#25968;&#65292;&#25110;&#32773;&#25913;&#21464; Redis &#30340;&#25345;&#20037;&#21270;(Persistence)&#26041;&#24335;&#12290;
CONFIG SET &#21487;&#20197;&#20462;&#25913;&#30340;&#37197;&#32622;&#21442;&#25968;&#21487;&#20197;&#20351;&#29992;&#21629;&#20196; CONFIG GET * &#26469;&#21015;&#20986;&#65292;&#25152;&#26377;&#34987; CONFIG SET &#20462;&#25913;&#30340;&#37197;&#32622;&#21442;&#25968;&#37117;&#20250;&#31435;&#21363;&#29983;&#25928;&#12290;

CONFIG GET parameter
&#26102;&#38388;&#22797;&#26434;&#24230;&#65306; O(N)&#65292;&#20854;&#20013; N &#20026;&#21629;&#20196;&#36820;&#22238;&#30340;&#37197;&#32622;&#36873;&#39033;&#25968;&#37327;&#12290;
CONFIG GET &#21629;&#20196;&#29992;&#20110;&#21462;&#24471;&#36816;&#34892;&#20013;&#30340; Redis &#26381;&#21153;&#22120;&#30340;&#37197;&#32622;&#21442;&#25968;(configuration parameters)&#65292;&#22312;Redis 2.4 &#29256;&#26412;&#20013;&#65292; &#26377;&#37096;&#20998;&#21442;&#25968;&#27809;&#26377;&#21150;&#27861;&#29992; CONFIG GET &#35775;&#38382;&#65292;&#20294;&#26159;&#22312;&#26368;&#26032;&#30340; Redis 2.6 &#29256;&#26412;&#20013;&#65292;&#25152;&#26377;&#37197;&#32622;&#21442;&#25968;&#37117;&#24050;&#32463;&#21487;&#20197;&#29992; CONFIG GET &#35775;&#38382;&#20102;&#12290;

CONFIG GET &#25509;&#21463;&#21333;&#20010;&#21442;&#25968; parameter &#20316;&#20026;&#25628;&#32034;&#20851;&#38190;&#23383;&#65292;&#26597;&#25214;&#25152;&#26377;&#21305;&#37197;&#30340;&#37197;&#32622;&#21442;&#25968;&#65292;&#20854;&#20013;&#21442;&#25968;&#21644;&#20540;&#20197;&#8220;&#38190;-&#20540;&#23545;&#8221;(key-value pairs)&#30340;&#26041;&#24335;&#25490;&#21015;&#12290;
&#27604;&#22914;&#25191;&#34892; CONFIG GET s* &#21629;&#20196;&#65292;&#26381;&#21153;&#22120;&#23601;&#20250;&#36820;&#22238;&#25152;&#26377;&#20197; s &#24320;&#22836;&#30340;&#37197;&#32622;&#21442;&#25968;&#21450;&#21442;&#25968;&#30340;&#20540;
</pre>
</div>
</div>
<div id="outline-container-h:573f8d47-dec4-4731-9312-fbe8db968070" class="outline-4">
<h4 id="h:573f8d47-dec4-4731-9312-fbe8db968070">设置连接密码</h4>
<div class="outline-text-4" id="text-h:573f8d47-dec4-4731-9312-fbe8db968070">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#36830;&#25509;&#23494;&#30721;</span>
127.0.0.1:6379&gt; CONFIG SET requirepass centos
OK

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#36830;&#25509;&#23494;&#30721;</span>
127.0.0.1:6379&gt; CONFIG GET requirepass
1) <span style="color: #8b2252;">"requirepass"</span>
2) <span style="color: #8b2252;">"centos"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7349f010-b4ad-40ac-8033-f191e2326d6e" class="outline-4">
<h4 id="h:7349f010-b4ad-40ac-8033-f191e2326d6e">获取当前配置</h4>
<div class="outline-text-4" id="text-h:7349f010-b4ad-40ac-8033-f191e2326d6e">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22855;&#25968;&#34892;&#20026;&#38190;&#65292;&#20598;&#25968;&#34892;&#20026;&#20540;</span>
127.0.0.1:6379&gt; CONFIG GET *
  1) <span style="color: #8b2252;">"dbfilename"</span>
  2) <span style="color: #8b2252;">"dump_6379.rdb"</span>
  3) <span style="color: #8b2252;">"requirepass"</span>
  4) <span style="color: #8b2252;">"centos"</span>
  5) <span style="color: #8b2252;">"masterauth"</span>
  6) <span style="color: #8b2252;">""</span>
  7) <span style="color: #8b2252;">"cluster-announce-ip"</span>
  8) <span style="color: #8b2252;">""</span>
  9) <span style="color: #8b2252;">"unixsocket"</span>
 10) <span style="color: #8b2252;">""</span>
...&#30465;&#30053;...

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;bind</span>
127.0.0.1:6379&gt; CONFIG GET bind
1) <span style="color: #8b2252;">"bind"</span>
2) <span style="color: #8b2252;">"0.0.0.0"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26377;&#20123;&#35774;&#32622;&#26080;&#27861;&#20462;&#25913;</span>
127.0.0.1:6379&gt; CONFIG SET bind 127.0.0.1
(error) ERR Unsupported CONFIG parameter: bind
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2fc3c18d-7ae2-420f-9d71-1a6a14344ff1" class="outline-4">
<h4 id="h:2fc3c18d-7ae2-420f-9d71-1a6a14344ff1">更改最大内存</h4>
<div class="outline-text-4" id="text-h:2fc3c18d-7ae2-420f-9d71-1a6a14344ff1">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#33324;&#35774;&#32622;&#29289;&#29702;&#20869;&#23384;&#30340;&#19968;&#21322;</span>
127.0.0.1:6379&gt; CONFIG SET maxmemory 8589934592
OK
127.0.0.1:6379&gt; CONFIG GET maxmemory
1) <span style="color: #8b2252;">"maxmemory"</span>
2) <span style="color: #8b2252;">"8589934592"</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:a980e636-5e44-43a1-a674-18c39bb4ca75" class="outline-3">
<h3 id="h:a980e636-5e44-43a1-a674-18c39bb4ca75">慢查询</h3>
<div class="outline-text-3" id="text-h:a980e636-5e44-43a1-a674-18c39bb4ca75">
<p>
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022183723350.png" alt="20201022183723350.png">
范例：SLOW LOG慢查询
</p>

<div class="org-src-container">
<pre class="src src-sh">&#9492;&#9472;$ grep slowlog /apps/redis/etc/redis.conf 
slowlog-log-slower-than 10000  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36229;&#36807;&#35760;&#24405;&#20026;&#24930;&#26085;&#24535;&#65292;&#21333;&#20301;&#24494;&#31186;</span>
slowlog-max-len 128 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#35760;&#24405;&#26368;&#36817;&#22810;&#20010;&#24930;&#35760;&#24405;</span>

[root@centos8 ~]#vim /etc/redis.conf 
slowlog-log-slower-than 1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#36229;&#36807;1us&#21363;&#20026;&#24930;&#30340;&#25351;&#20196;&#65292;&#40664;&#35748;&#20540;10000us</span>
slowlog-max-len 1024 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#21482;&#20445;&#23384;&#26368;&#36817;1024&#26465;&#24930;&#35760;&#24405;&#65292;&#40664;&#35748;&#20540;128</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24930;&#26085;&#24535;&#30340;&#35760;&#24405;&#26465;&#25968;</span>
127.0.0.1:6379&gt; SLOWLOG len
(integer) 8

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24930;&#26085;&#24535;&#30340;n&#26465;&#35760;&#24405;</span>
127.0.0.1:6379&gt; SLOWLOG get 
1) 1) (integer) 8
   2) (integer) 1603363724
   3) (integer) 2 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33457;&#36153;&#26102;&#38388; 2us</span>
   4) 1) <span style="color: #8b2252;">"SLOWLOG"</span>
      2) <span style="color: #8b2252;">"len"</span>
   5) <span style="color: #8b2252;">"127.0.0.1:55098"</span>
   6) <span style="color: #8b2252;">""</span>
2) 1) (integer) 7
   2) (integer) 1603363716
   3) (integer) 10
   4) 1) <span style="color: #8b2252;">"SLOWLOG"</span>
      2) <span style="color: #8b2252;">"get"</span>
      3) <span style="color: #8b2252;">"4"</span>
   5) <span style="color: #8b2252;">"127.0.0.1:55098"</span>
   6) <span style="color: #8b2252;">""</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#31354;&#24930;&#26085;&#24535;   </span>
127.0.0.1:6379&gt; SLOWLOG reset
OK 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6e8377e2-a62f-433e-9de4-f9d58d982b26" class="outline-3">
<h3 id="h:6e8377e2-a62f-433e-9de4-f9d58d982b26">redis持久化</h3>
<div class="outline-text-3" id="text-h:6e8377e2-a62f-433e-9de4-f9d58d982b26">
<p>
Redis 虽然是一个内存级别的缓存程序，也就是redis是使用内存进行数据的缓
存的，但是其可以将内存的数据按照一定的策略保存到硬盘上，从而实现数据持
久保存的目的
</p>

<p>
目前redis支持两种不同方式的数据持久化保存机制，分别是RDB和AOF
</p>
<ul class="org-ul">
<li>RDB: Redis DataBase</li>
<li>AOF: AppendOnlyFile</li>
</ul>


<figure id="org889d6f7">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022190137437.png" alt="20201022190137437.png">

</figure>
</div>
<div id="outline-container-h:731a3db5-15a5-4022-9c1f-c5304e399c0f" class="outline-4">
<h4 id="h:731a3db5-15a5-4022-9c1f-c5304e399c0f">RDB 模式</h4>
<div class="outline-text-4" id="text-h:731a3db5-15a5-4022-9c1f-c5304e399c0f">
</div>
<div id="outline-container-h:2e538282-72b3-479c-a84f-3316084a0949" class="outline-5">
<h5 id="h:2e538282-72b3-479c-a84f-3316084a0949">RDB 模式工作原理</h5>
<div class="outline-text-5" id="text-h:2e538282-72b3-479c-a84f-3316084a0949">

<figure id="org2495245">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022190253355.png" alt="20201022190253355.png">

</figure>

<p>
RDB(Redis DataBase)：基于时间的快照，其默认只保留当前最新的一次快照，
特点是执行速度比较快，缺点是可能会丢失从上次快照到当前时间点之间未做快
照的数据
</p>

<p>
<b>RDB bgsave 实现快照的具体过程:</b>
</p>


<figure id="orgf05ff1f">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022190423703.png" alt="20201022190423703.png">

</figure>

<p>
Redis从master主进程先fork出一个子进程，使用写时复制机制，子进程将内存的数据保存为一个临时文件，比如:temp-&lt;子进程pid&gt;.rdb，当数据保存完成之后再将上一次保存的RDB文件替换掉，然后关闭子进程，这样可以保证每一次做RDB快照保存的数据都是完整的
</p>

<p>
因为直接替换RDB文件的时候，可能会出现突然断电等问题，而导致RDB文件还没有保存完整就因为突然关机停止保存，而导致数据丢失的情况。后续可以手动将每次生成的RDB文件进行备份，这样可以最大化保存历史数据
</p>


<figure id="org8dfa66f">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022191648929.png" alt="20201022191648929.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">save&#22312;&#20445;&#23384;&#26102;&#20250;&#38459;&#27490;&#29992;&#25143;&#26597;&#35810;</span>
redis-cli -a 123456 save &amp;
pstree -p |grep reids ; ll /apps/redis/data
</pre>
</div>
</div>
</div>
<div id="outline-container-h:19801d1e-f047-49cb-b26a-460e67a1de6b" class="outline-5">
<h5 id="h:19801d1e-f047-49cb-b26a-460e67a1de6b">RDB 相关配置</h5>
<div class="outline-text-5" id="text-h:19801d1e-f047-49cb-b26a-460e67a1de6b">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#37197;&#32622;&#25991;&#20214;&#20013;&#30340;save &#36873;&#39033;&#35774;&#32622;&#22810;&#20010;&#20445;&#23384;&#26465;&#20214;&#65292;&#21482;&#26377;&#20219;&#20309;&#19968;&#20010;&#26465;&#20214;&#28385;&#36275;&#65292;&#26381;&#21153;&#22120;&#37117;&#20250;&#33258;&#21160;&#25191;&#34892;BGSAVE &#21629;&#20196;</span>
save 900 1      <span style="color: #b22222;">#</span><span style="color: #b22222;">900s&#20869;&#20462;&#25913;&#20102;1&#20010;key&#21363;&#35302;&#21457;&#20445;&#23384;RDB</span>
save 300 10     <span style="color: #b22222;">#</span><span style="color: #b22222;">300s&#20869;&#20462;&#25913;&#20102;10&#20010;key&#21363;&#35302;&#21457;&#20445;&#23384;RDB</span>
save 60 100000  <span style="color: #b22222;">#</span><span style="color: #b22222;">60s&#20869;&#20462;&#25913;&#20102;10000&#20010;key&#21363;&#35302;&#21457;&#20445;&#23384;RDB</span>
dbfilename dump.rdb
dir ./          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#27901;&#32534;&#35793;&#23433;&#35013;&#26102;&#40664;&#35748;RDB&#25991;&#20214;&#23384;&#25918;&#22312;Redis&#30340;&#24037;&#20316;&#30446;&#24405;&#65292;&#27492;&#37197;&#32622;&#21487;&#21487;&#25351;&#23450;&#20445;&#23384;&#30340;&#25968;&#25454;&#30446;&#24405;</span>
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sh">redis-cli config get save
1) <span style="color: #8b2252;">"save"</span>
2) <span style="color: #8b2252;">"900 1 300 100 60 10000"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ffce5007-2e92-4672-aa55-51d5a265f02b" class="outline-5">
<h5 id="h:ffce5007-2e92-4672-aa55-51d5a265f02b">实现RDB方式</h5>
<div class="outline-text-5" id="text-h:ffce5007-2e92-4672-aa55-51d5a265f02b">
<ul class="org-ul">
<li>save：同步，不推荐使用，使用主进程完成快照，因此会阻塞其它命令执行。</li>
<li>bgsave：异步后台执行，不影响其它命令的执行，会开启独立的子进程，因此不会阻塞其它命令执行。rdb_bgsave_in_progress为0时，执行完毕。</li>
<li>配置文件实现自动保存: 制定规则,自动执行</li>
</ul>
</div>
</div>
<div id="outline-container-h:58d3485d-aff2-466e-868c-03c22c2febd6" class="outline-5">
<h5 id="h:58d3485d-aff2-466e-868c-03c22c2febd6">RDB 模式的优缺点</h5>
<div class="outline-text-5" id="text-h:58d3485d-aff2-466e-868c-03c22c2febd6">
<p>
RDB 模式优点
</p>
<ul class="org-ul">
<li>RDB快照保存了某个时间点的数据，恢复的时候直接加载到内存即可，不用再做其他处理，这种文件适合用于做灾备处理。可以通过自定义时间执行redis指令bgsave或者save保存快照，实现多个版本的备份。
<ul class="org-ul">
<li>比如: 可以在最近的24小时内，每小时备份一次RDB文件，并且在每个月的每一天，也备份一个ROB文件。这样的话，即使遇上问题，也可以随时将数据集还原到不同的版本。</li>
</ul></li>
<li>RDB在大量数据时恢复的速度比AOF的快</li>
</ul>

<p>
RDB 模式缺点
</p>
<ul class="org-ul">
<li><p>
不能实时保存数据，可能会丢失自上一次执行RDB备份到当前的内存数据
</p>

<p>
如果你需要尽量避免在服务器故障时丢失数据，那么RDB不适合你。虽然Redis
允许你设置不同的保存点（save point）来控制保存RDB文件的频率，但是，
因为RDB文件需要保存整个数据集的状态，所以它并不是一个轻松的操作。因
此你可能会至少5分钟才保存一次RDB文件。在这种情况下，一旦发生故障停机，
你就可能会丢失好几分钟的数据。
</p></li>

<li><p>
当数据量非常大的时候，从父进程fork子进程进行保存至RDB文件时需要一点时间，可能是毫秒或者秒，取决于磁盘IO性能
</p>

<p>
在数据集比较庞大时，fork()可能会非常耗时，造成服务器在一定时间内停止
处理客户端; 如果数据集非常巨大，并且CPU时间非常紧张的话，那么这种停
止时间甚至可能会长达整整一秒或更久。虽然AOF重写也需要进行fork()，但
无论AOF重写的执行间隔有多长，数据的持久性都不会有任何损失。
</p></li>
</ul>

<p>
范例：手动备份RDB文件的脚本
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /apps/redis/etc/redis_6379.conf
save <span style="color: #8b2252;">""</span>
dbfilename dump_6379.rdb
dir /apps/redis/data/
appendonly no

[root@centos8 ~]#cat redis_backup_rdb.sh 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #b22222;">#</span>

<span style="color: #a0522d;">BACKUP</span>=/data/redis-rdb
<span style="color: #a0522d;">DIR</span>=/apps/redis
<span style="color: #a0522d;">FILE</span>=dump_6379.rdb
<span style="color: #a0522d;">HOST</span>=127.0.0.1
<span style="color: #a0522d;">PASS</span>=centos
<span style="color: #a0522d;">DATE</span>=<span style="color: #ff00ff;">`date +%F_%T`</span>

<span style="color: #0000ff;">color</span> () {
    <span style="color: #a0522d;">RES_COL</span>=60
    <span style="color: #a0522d;">MOVE_TO_COL</span>=<span style="color: #8b2252;">"echo -en \\033[${RES_COL}G"</span>
    <span style="color: #a0522d;">SETCOLOR_SUCCESS</span>=<span style="color: #8b2252;">"echo -en \\033[1;32m"</span>
    <span style="color: #a0522d;">SETCOLOR_FAILURE</span>=<span style="color: #8b2252;">"echo -en \\033[1;31m"</span>
    <span style="color: #a0522d;">SETCOLOR_WARNING</span>=<span style="color: #8b2252;">"echo -en \\033[1;33m"</span>
    <span style="color: #a0522d;">SETCOLOR_NORMAL</span>=<span style="color: #8b2252;">"echo -en \E[0m"</span>
    <span style="color: #483d8b;">echo</span> -n <span style="color: #8b2252;">"$1"</span> &amp;&amp; $<span style="color: #a0522d;">MOVE_TO_COL</span>
    <span style="color: #483d8b;">echo</span> -n <span style="color: #8b2252;">"["</span>
    <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">2</span> = <span style="color: #8b2252;">"success"</span> -o $<span style="color: #a0522d;">2</span> = <span style="color: #8b2252;">'0'</span> ];<span style="color: #a020f0;">then</span>
        ${<span style="color: #a0522d;">SETCOLOR_SUCCESS</span>}
        <span style="color: #483d8b;">echo</span> -n $<span style="color: #8b2252;">"  OK  "</span>
    <span style="color: #a020f0;">elif</span> [  $<span style="color: #a0522d;">2</span> = <span style="color: #8b2252;">"failure"</span> -o $<span style="color: #a0522d;">2</span> = <span style="color: #8b2252;">"1"</span> ]; <span style="color: #a020f0;">then</span>
        ${<span style="color: #a0522d;">SETCOLOR_FAILURE</span>}
        <span style="color: #483d8b;">echo</span> -n $<span style="color: #8b2252;">"FAILED"</span>
    <span style="color: #a020f0;">else</span>
        ${<span style="color: #a0522d;">SETCOLOR_WARNING</span>}
        <span style="color: #483d8b;">echo</span> -n $<span style="color: #8b2252;">"WARING"</span>
    <span style="color: #a020f0;">fi</span>
    ${<span style="color: #a0522d;">SETCOLOR_NORMAL</span>}
    <span style="color: #483d8b;">echo</span> -n <span style="color: #8b2252;">"]"</span>
    <span style="color: #483d8b;">echo</span>
}

redis-cli -h ${<span style="color: #a0522d;">HOST</span>} -a ${<span style="color: #a0522d;">PASS</span>} --no-auth-warning bgsave
<span style="color: #a0522d;">result</span>=<span style="color: #ff00ff;">`redis-cli -h ${HOST} -a ${PASS} --no-auth-warning info | grep "rdb_bgsave_in_progress" | sed -nr 's/.*:([0-9]+).*/\1/p'`</span>
<span style="color: #a020f0;">until</span> [ ${<span style="color: #a0522d;">result</span>} -eq 0 ];<span style="color: #a020f0;">do</span>
    sleep 1
    <span style="color: #a0522d;">result</span>=<span style="color: #ff00ff;">`redis-cli -h ${HOST} -a ${PASS} --no-auth-warning info | grep "rdb_bgsave_in_progress" | sed -nr 's/.*:([0-9]+).*/\1/p'`</span>
<span style="color: #a020f0;">done</span>
[ -d ${<span style="color: #a0522d;">BACKUP</span>} ] || { mkdir -p ${<span style="color: #a0522d;">BACKUP</span>} ; chown -R redis:redis $<span style="color: #a0522d;">BACKUP</span>; }
cp ${<span style="color: #a0522d;">DIR</span>}/data/${<span style="color: #a0522d;">FILE</span>} ${<span style="color: #a0522d;">BACKUP</span>}/dump_6379-${<span style="color: #a0522d;">DATE</span>}.rdb

color <span style="color: #8b2252;">"Backup redis rdb successfullily"</span> 0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;</span>
[root@centos8 ~]#bash redis_backup_rdb.sh 
Background saving started
Backup redis rdb successfullily                            [  OK  ]

[root@centos8 ~]#ll -h /data/redis-rdb/
total 532K
-rw-r--r-- 1 redis redis 529K Oct 22 20:09 dump_6379-2020-10-22_20:09:58.rdb
</pre>
</div>

<p>
范例: 观察save 和 bgsave的执行过程
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#38459;&#22622;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#20020;&#26102;&#25991;&#20214;</span>
(redis-cli -a 123456 save &amp;) ; <span style="color: #483d8b;">echo</span> save is finished; redis-cli -a 123456 get class
</pre>
</div>

<p>
范例: 自动保存
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#vim /apps/redis/etc/redis_6379.conf
save 60 3

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;60s&#20869;&#20462;&#25913;3&#20010;key&#65292;&#39564;&#35777;&#26159;&#21542;&#29983;&#25104;RDB&#25991;&#20214;</span>
[root@centos8 ~]#cat redis_test.sh 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #a0522d;">NUM</span>=100000
<span style="color: #a0522d;">PASS</span>=centos
<span style="color: #a0522d;">PORT</span>=6379

<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> <span style="color: #ff00ff;">`seq $NUM`</span>;<span style="color: #a020f0;">do</span>
    redis-cli -h 127.0.0.1 -a <span style="color: #8b2252;">"$PASS"</span> -p $<span style="color: #a0522d;">PORT</span>  --no-auth-warning  set key${<span style="color: #a0522d;">i</span>} value${<span style="color: #a0522d;">i</span>}
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"key${i} value${i} &#20889;&#20837;&#23436;&#25104;"</span>
<span style="color: #a020f0;">done</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$NUM&#20010;key&#20889;&#20837;&#21040;Redis&#23436;&#25104;"</span>

[root@centos8 ~]#bash redis_test.sh 
[root@centos8 ~]#ll /apps/redis/data/
total 532
-rw-r--r-- 1 redis redis 541340 Oct 22 20:16 dump_6379.rdb
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:779d3676-7ed0-44af-a969-1b619a1722e3" class="outline-4">
<h4 id="h:779d3676-7ed0-44af-a969-1b619a1722e3">AOF 模式(完全数据+增量变化)</h4>
<div class="outline-text-4" id="text-h:779d3676-7ed0-44af-a969-1b619a1722e3">
</div>
<div id="outline-container-h:6fbf0696-8c55-4886-93ab-74d70d096906" class="outline-5">
<h5 id="h:6fbf0696-8c55-4886-93ab-74d70d096906">AOF 模式工作原理</h5>
<div class="outline-text-5" id="text-h:6fbf0696-8c55-4886-93ab-74d70d096906">

<figure id="org4c8699a">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022202322217.png" alt="20201022202322217.png">

</figure>

<p>
AOF：AppendOnylFile，按照操作顺序依次将操作追加到指定的日志文件末尾
</p>

<p>
AOF 和 RDB 一样使用了COW(写时复制)机制，AOF默认为每秒钟fsync一次，即将执行
的命令保存到AOF文件当中，这样即使redis服务器发生故障的话最多只丢失1秒
钟之内的数据，也可以设置不同的fsync策略always，即设置每次执行命令的时
候执行fsync，fsync会在后台执行线程，所以主线程可以继续处理用户的正常请
求而不受到写入AOF文件的I/O影响
</p>

<p>
在第一次启用AOF功能时，会做一次完全备份，后续做增量备份，相当于完成数据+增量变化
</p>

<p>
同时启用RDB和AOF,进行恢复时,默认AOF文件优先级高于RDB文件,即会使用AOF文件进行恢复
</p>

<p>
<b>注意: AOF
模式默认是关闭的,第一次开启AOF后,并重启服务生效后,会因为AOF的优先级高于RDB,而AOF默认没有文件存在,从而导致所有数据丢失</b>
</p>

<p>
范例: 启用AOF功能的正确方式
</p>
<ul class="org-ul">
<li>AOF比RDB文件优化级高，所以先动态改再改配置文件</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ll /var/lib/redis/
total 2032
-rw-r--r-- 1 redis redis 2077946 Oct 22 20:38 dump.rdb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21160;&#24577;&#24320;&#21551;</span>
127.0.0.1:6379&gt; CONFIG GET appendonly
1) <span style="color: #8b2252;">"appendonly"</span>
2) <span style="color: #8b2252;">"no"</span>
redis-cli CONFIG SET appendonly yes

[root@centos8 ~]#ll /var/lib/redis/
total 4064
-rw-r--r-- 1 redis redis 2077946 Oct 22 20:40 appendonly.aof
-rw-r--r-- 1 redis redis 2077946 Oct 22 20:38 dump.rdb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20877;&#25913;&#37197;&#32622;&#25991;&#20214;</span>
[root@centos8 ~]#vim /etc/redis.conf
appendonly yes

systemctl restart redis
</pre>
</div>


<figure id="org4d9493b">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022204730724.png" alt="20201022204730724.png">

</figure>
</div>
</div>
<div id="outline-container-h:0840198e-2c1c-4269-98d2-b40594e9f2c6" class="outline-5">
<h5 id="h:0840198e-2c1c-4269-98d2-b40594e9f2c6">AOF 相关配置</h5>
<div class="outline-text-5" id="text-h:0840198e-2c1c-4269-98d2-b40594e9f2c6">
<div class="org-src-container">
<pre class="src src-sh">appendonly no <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#24320;&#21551;AOF&#26085;&#24535;&#35760;&#24405;&#65292;&#40664;&#35748;redis&#20351;&#29992;&#30340;&#26159;rdb&#26041;&#24335;&#25345;&#20037;&#21270;&#65292;&#36825;&#31181;&#26041;&#24335;&#22312;&#35768;&#22810;&#24212;&#29992;&#20013;&#24050;&#32463;&#36275;&#22815;&#29992;&#20102;&#65292;</span>
             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20294;&#26159;redis&#22914;&#26524;&#20013;&#36884;&#23445;&#26426;&#65292;&#20250;&#23548;&#33268;&#21487;&#33021;&#26377;&#20960;&#20998;&#38047;&#30340;&#25968;&#25454;&#20002;&#22833;(&#21462;&#20915;&#20110;dump&#25968;&#25454;&#30340;&#38388;&#38548;&#26102;&#38388;)&#65292;&#26681;&#25454;save&#26469;&#31574;&#30053;&#36827;&#34892;&#25345;&#20037;&#21270;&#65292;</span>
             <span style="color: #b22222;">#</span><span style="color: #b22222;">Append onlyFile&#26159;&#21478;&#19968;&#31181;&#25345;&#20037;&#21270;&#26041;&#24335;&#65292;&#21487;&#20197;&#25552;&#20379;&#26356;&#22909;&#30340;&#25345;&#20037;&#21270;&#29305;&#24615;&#65292;Redis&#20250;&#25226;&#27599;&#27425;&#20889;&#20837;&#30340;&#25968;&#25454;&#22312;&#25509;&#25910;&#21518;&#37117;&#20889;&#20837;appendonly.aof&#25991;&#20214;&#65292;</span>
             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#27425;&#21551;&#21160;&#26102;Redis&#37117;&#20250;&#20808;&#25226;&#36825;&#20010;&#25991;&#20214;&#30340;&#25968;&#25454;&#35835;&#20837;&#20869;&#23384;&#37324;&#65292;&#20808;&#24573;&#30053;RDB&#25991;&#20214;&#12290;&#40664;&#35748;&#19981;&#21551;&#29992;&#27492;&#21151;&#33021;</span>

appendfilepame <span style="color: #8b2252;">"appendonly.aof"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25991;&#26412;&#25991;&#20214;AOF&#30340;&#25991;&#20214;&#21517;&#65292;&#22312;&#36825;&#25351;&#23450;&#30340;&#30446;&#24405;&#20013;</span>

appendfsync everysec            <span style="color: #b22222;">#</span><span style="color: #b22222;">aof&#25345;&#20037;&#21270;&#31574;&#30053;&#30340;&#37197;&#32622;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">no&#34920;&#31034;&#30001;&#25805;&#20316;&#31995;&#32479;&#20445;&#35777;&#25968;&#25454;&#21516;&#27493;&#21040;&#30913;&#30424;&#65292;Linux&#30340;&#40664;&#35748;fsync&#31574;&#30053;&#26159;30&#31186;&#65292;&#26368;&#22810;&#20250;&#20002;&#22833;30s&#30340;&#25968;&#25454;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">always&#34920;&#31034;&#27599;&#27425;&#20889;&#20837;&#37117;&#25191;&#34892;fsync&#65292;&#20197;&#20445;&#35777;&#25968;&#25454;&#21516;&#27493;&#21040;&#30913;&#30424;&#65292;&#23433;&#20840;&#24615;&#39640;&#65292;&#24615;&#33021;&#36739;&#24046;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">everysec&#34920;&#31034;&#27599;&#31186;&#25191;&#34892;&#19968;&#27425;fsync&#65292;&#21487;&#33021;&#20250;&#23548;&#33268;&#20002;&#22833;&#36825;1s&#25968;&#25454;&#65292;&#27492;&#20026;&#40664;&#35748;&#20540;&#65292;&#20063;&#29983;&#20135;&#24314;&#35758;&#20540;</span>
dir /path

<span style="color: #b22222;">#</span><span style="color: #b22222;">rewrite&#30456;&#20851;</span>
no-appendfsync-on-rewrite yes
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
</pre>
</div>

<p>
范例: 动态修改配置自动生成appendonly.aof文件
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; CONFIG SET appendonly yes
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e2bb9c90-55e3-4abe-b611-f740efb8d2a8" class="outline-5">
<h5 id="h:e2bb9c90-55e3-4abe-b611-f740efb8d2a8">AOF rewrite 重写</h5>
<div class="outline-text-5" id="text-h:e2bb9c90-55e3-4abe-b611-f740efb8d2a8">
<p>
将一些重复的，可以合并的，过期的数据重新写入一个新的AOF文件，从而节约AOF备份占用的硬盘空间,也能加速恢复过程
</p>

<p>
可以手动执行bgrewriteaof 触发AOF，或定义自动rewrite 策略
</p>

<p>
<b>AOF rewrite 过程</b>
</p>


<figure id="orgaff3f22">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022202824390.png" alt="20201022202824390.png">

</figure>

<p>
AOF rewrite重写相关配置
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#26102;&#22312;&#25191;&#34892;bgrewriteaof&#25805;&#24615;&#21644;&#20027;&#36827;&#31243;&#20889;aof&#25991;&#20214;&#30340;&#25805;&#20316;&#65292;&#20004;&#32773;&#37117;&#20250;&#25805;&#20316;&#30913;&#30424;&#65292;&#32780;bgrewriteaof&#24448;&#24448;&#20250;&#28041;&#21450;&#22823;&#37327;&#30913;&#30424;&#25805;&#20316;&#65292;&#36825;&#26679;&#23601;&#20250;&#36896;&#25104;&#20027;&#36827;&#31243;&#22312;&#20889;aof&#25991;&#20214;&#30340;&#26102;&#20505;&#20986;&#29616;&#38459;&#22622;&#30340;&#24773;&#24418;&#65292;&#20197;&#19979;&#21442;&#25968;&#23454;&#29616;&#25511;&#21046;</span>
no-appendfsync-on-rewrite no <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;aof rewrite&#26399;&#38388;&#65292;&#26159;&#21542;&#23545;aof&#26032;&#35760;&#24405;&#30340;append&#26242;&#32531;&#20351;&#29992;&#25991;&#20214;&#21516;&#27493;&#31574;&#30053;&#65292;&#20027;&#35201;&#32771;&#34385;&#30913;&#30424;I0&#24320;&#25903;&#21644;&#35831;&#27714;&#38459;&#22622;&#26102;&#38388;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#20026;no&#65292;&#34920;&#31034;"&#19981;&#26242;&#32531;"&#65292;&#26032;&#30340;aof&#35760;&#24405;&#20173;&#28982;&#20250;&#34987;&#31435;&#21363;&#21516;&#27493;&#21040;&#30913;&#30424;&#65292;&#26159;&#26368;&#23433;&#20840;&#30340;&#26041;&#24335;&#65292;&#19981;&#20250;&#20002;&#22833;&#25968;&#25454;&#65292;&#20294;&#26159;&#35201;&#24525;&#21463;&#38459;&#22622;&#30340;&#38382;&#39064;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;yes&#65292;&#30456;&#24403;&#20110;&#23558;appendfsync&#35774;&#32622;&#20026;no&#65292;&#36825;&#35828;&#26126;&#24182;&#27809;&#26377;&#25191;&#34892;&#30913;&#30424;&#25805;&#20316;&#65292;&#21482;&#26159;&#20889;&#20837;&#20102;&#32531;&#20914;&#21306;&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22240;&#27492;&#36825;&#26679;&#24182;&#19981;&#20250;&#36896;&#25104;&#38459;&#22622;(&#22240;&#20026;&#27809;&#26377;&#31454;&#20105;&#30913;&#30424;)&#65292;&#20294;&#26159;&#22914;&#26524;&#36825;&#20010;&#26102;&#20505;redis&#25346;&#25481;&#65292;&#23601;&#20250;&#20002;&#22833;&#25968;&#25454;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20002;&#22833;&#22810;&#23569;&#25968;&#25454;&#21602;?Linux&#30340;&#40664;&#35748;fsync&#31574;&#30053;&#26159;30&#31186;&#65292;&#26368;&#22810;&#20250;&#20002;&#22833;30s&#30340;&#25968;&#25454;&#65292;&#20294;&#30001;&#20110;yes&#24615;&#33021;&#36739;&#22909;&#32780;&#19988;&#20250;&#36991;&#20813;&#20986;&#29616;&#38459;&#22622;&#22240;&#27492;&#27604;&#36739;&#25512;&#25512;&#33616;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">rewrite&#21363;&#23545;aof&#25991;&#20214;&#36827;&#34892;&#25972;&#29702;&#65292;&#23558;&#31354;&#38386;&#31354;&#38388;&#22238;&#25910;&#65292;&#20174;&#32780;&#21487;&#20197;&#20943;&#23569;&#24674;&#22797;&#25968;&#25454;&#26102;&#38388;</span>
auto-aof-rewrite-percentage 100 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;Aof log&#22686;&#38271;&#36229;&#36807;&#25351;&#23450;&#30334;&#20998;&#27604;&#20363;&#26102;&#65292;&#37325;&#20889;AOF&#25991;&#20214;&#65292;&#35774;&#32622;&#20026;0&#34920;&#31034;&#19981;&#33258;&#21160;&#37325;&#20889;Aof&#26085;&#24535;&#65292;</span>
                                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#20889;&#26159;&#20026;&#20102;&#20351;aof&#20307;&#31215;&#20445;&#25345;&#26368;&#23567;&#65292;&#20294;&#26159;&#36824;&#21487;&#20197;&#30830;&#20445;&#20445;&#23384;&#26368;&#23436;&#25972;&#30340;&#25968;&#25454;</span>

auto-aof-rewrite-min-size 64mb <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35302;&#21457;aof rewrite&#30340;&#26368;&#23567;&#23567;&#25991;&#20214;&#22823;&#23567;</span>

aof-load-truncated yes <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#21152;&#36733;&#30001;&#20110;&#26576;&#20123;&#21407;&#22240;&#23548;&#33268;&#30340;&#26411;&#23614;&#24322;&#24120;&#30340;AOF&#25991;&#20214;(&#20027;&#36827;&#31243;&#34987;ki11/&#26029;&#30005;&#31561;)&#65292;&#24314;&#35758;yes</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:af9cf730-1ab1-4337-9d3f-cc82c19345a7" class="outline-5">
<h5 id="h:af9cf730-1ab1-4337-9d3f-cc82c19345a7">手动执行AOF重写 BGREWRITEAOF 命令</h5>
<div class="outline-text-5" id="text-h:af9cf730-1ab1-4337-9d3f-cc82c19345a7">
<div class="org-src-container">
<pre class="src src-sh">BGREWRITEAOF
&#26102;&#38388;&#22797;&#26434;&#24230;&#65306; O(N)&#65292; N &#20026;&#35201;&#36861;&#21152;&#21040; AOF &#25991;&#20214;&#20013;&#30340;&#25968;&#25454;&#25968;&#37327;&#12290;
&#25191;&#34892;&#19968;&#20010; AOF&#25991;&#20214; &#37325;&#20889;&#25805;&#20316;&#12290;&#37325;&#20889;&#20250;&#21019;&#24314;&#19968;&#20010;&#24403;&#21069; AOF &#25991;&#20214;&#30340;&#20307;&#31215;&#20248;&#21270;&#29256;&#26412;&#12290;

&#21363;&#20351; BGREWRITEAOF &#25191;&#34892;&#22833;&#36133;&#65292;&#20063;&#19981;&#20250;&#26377;&#20219;&#20309;&#25968;&#25454;&#20002;&#22833;&#65292;&#22240;&#20026;&#26087;&#30340; AOF &#25991;&#20214;&#22312; BGREWRITEAOF &#25104;&#21151;&#20043;&#21069;&#19981;&#20250;&#34987;&#20462;&#25913;&#12290;

&#37325;&#20889;&#25805;&#20316;&#21482;&#20250;&#22312;&#27809;&#26377;&#20854;&#20182;&#25345;&#20037;&#21270;&#24037;&#20316;&#22312;&#21518;&#21488;&#25191;&#34892;&#26102;&#34987;&#35302;&#21457;&#65292;&#20063;&#23601;&#26159;&#35828;&#65306;
&#22914;&#26524; Redis &#30340;&#23376;&#36827;&#31243;&#27491;&#22312;&#25191;&#34892;&#24555;&#29031;&#30340;&#20445;&#23384;&#24037;&#20316;&#65292;&#37027;&#20040; AOF &#37325;&#20889;&#30340;&#25805;&#20316;&#20250;&#34987;&#39044;&#23450;(scheduled)&#65292;
&#31561;&#21040;&#20445;&#23384;&#24037;&#20316;&#23436;&#25104;&#20043;&#21518;&#20877;&#25191;&#34892; AOF &#37325;&#20889;&#12290;&#22312;&#36825;&#31181;&#24773;&#20917;&#19979;&#65292; BGREWRITEAOF &#30340;&#36820;&#22238;&#20540;&#20173;&#28982;&#26159; OK &#65292;
&#20294;&#36824;&#20250;&#21152;&#19978;&#19968;&#26465;&#39069;&#22806;&#30340;&#20449;&#24687;&#65292;&#35828;&#26126; BGREWRITEAOF &#35201;&#31561;&#21040;&#20445;&#23384;&#25805;&#20316;&#23436;&#25104;&#20043;&#21518;&#25165;&#33021;&#25191;&#34892;&#12290;
&#22312; Redis 2.6 &#25110;&#20197;&#19978;&#30340;&#29256;&#26412;&#65292;&#21487;&#20197;&#20351;&#29992; INFO [section] &#21629;&#20196;&#26597;&#30475; BGREWRITEAOF &#26159;&#21542;&#34987;&#39044;&#23450;&#12290;

&#22914;&#26524;&#24050;&#32463;&#26377;&#21035;&#30340; AOF &#25991;&#20214;&#37325;&#20889;&#22312;&#25191;&#34892;&#65292;&#37027;&#20040; BGREWRITEAOF &#36820;&#22238;&#19968;&#20010;&#38169;&#35823;&#65292;&#24182;&#19988;&#36825;&#20010;&#26032;&#30340;BGREWRITEAOF &#35831;&#27714;&#20063;&#19981;&#20250;&#34987;&#39044;&#23450;&#21040;&#19979;&#27425;&#25191;&#34892;&#12290;

&#20174; Redis 2.4 &#24320;&#22987;&#65292; AOF &#37325;&#20889;&#30001; Redis &#33258;&#34892;&#35302;&#21457;&#65292; BGREWRITEAOF &#20165;&#20165;&#29992;&#20110;&#25163;&#21160;&#35302;&#21457;&#37325;&#20889;&#25805;&#20316;&#12290;
</pre>
</div>

<p>
范例: 手动bgrewriteaof
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; BGREWRITEAOF
Background append only file rewriting started

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#26102;&#21487;&#20197;&#35266;&#23519;&#21040;&#19979;&#38754;&#26174;&#31034;</span>
[root@centos8 ~]#pstree -p | grep redis; ll /var/lib/redis/
           |-redis-server(42039)-+-{redis-server}(42040)
           |                     |-{redis-server}(42041)
           |                     <span style="color: #ff00ff;">`-{redis-server}(42042)</span>
<span style="color: #ff00ff;">           |           `</span>-sshd(12816)---sshd(12818)---bash(12819)---redis-cli(42058)
total 4064
-rw-r--r-- 1 redis redis 2077946 Oct 22 21:05 appendonly.aof
-rw-r--r-- 1 redis redis 2077946 Oct 22 20:46 dump.rdb
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8700b7f1-c86a-4d00-9691-e62a2dc0a627" class="outline-5">
<h5 id="h:8700b7f1-c86a-4d00-9691-e62a2dc0a627">AOF 模式优缺点</h5>
<div class="outline-text-5" id="text-h:8700b7f1-c86a-4d00-9691-e62a2dc0a627">
<p>
AOF 模式优点
</p>
<ul class="org-ul">
<li>数据安全性相对较高，根据所使用的fsync策略(fsync是同步内存中redis所有
已经修改的文件到存储设备)，默认是appendfsync everysec，即每秒执行一
次 fsync,在这种配置下，Redis仍然可以保持良好的性能，并且就算发生故障
停机，也最多只会丢失一秒钟的数据( fsync会在后台线程执行，所以主线程
可以继续努力地处理命令请求)</li>
<li>由于该机制对日志文件的写入操作采用的是append模式，因此在写入过程中不
需要seek,即使出现宕机现象，也不会破坏日志文件中已经存在的内容。然而
如果本次操作只是写入了一半数据就出现了系统崩溃问题，不用担心，在
Redis下一次启动之前，可以通过redis-check-aof 工具来解决数据一致性的
问题</li>
<li>Redis可以在AOF文件体积变得过大时，自动地在后台对AOF进行重写,重写后的
新AOF文件包含了恢复当前数据集所需的最小命令集合。整个重写操作是绝对
安全的，因为Redis在创建新AOF文件的过程中，append模式不断的将修改数据
追加到现有的AOF文件里面，即使重写过程中发生停机，现有的AOF文件也不会
丢失。而一旦新AOF文件创建完毕，Redis就会从旧AOF文件切换到新AOF文件，
并开始对新AOF文件进行追加操作。</li>
<li><p>
AOF包含一个格式清晰、易于理解的日志文件用于记录所有的修改操作。事实
上，也可以通过该文件完成数据的重建
</p>

<p>
AOF文件有序地保存了对数据库执行的所有写入操作，这些写入操作以Redis协
议的格式保存，因此AOF文件的内容非常容易被人读懂，对文件进行分析
(parse)也很轻松。导出（export)AOF文件也非常简单:举个例子，如果你不小
心执行了FLUSHALL.命令，但只要AOF文件未被重写，那么只要停止服务器，移
除AOF文件末尾的FLUSHAL命令，并重启Redis ,就可以将数据集恢复到
FLUSHALL执行之前的状态。
</p></li>
</ul>

<p>
AOF 模式缺点
</p>
<ul class="org-ul">
<li>即使有些操作是重复的也会全部记录，AOF 的文件大小要大于 RDB 格式的文件</li>
<li>AOF 在恢复大数据集时的速度比 RDB 的恢复速度要慢</li>
<li>如果fsync策略是appendfsync no，,AOF速度甚至可能会慢于RDB</li>
<li>bug 出现的可能性更多</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:750974de-2177-48f1-9c28-91fa2f996a2a" class="outline-4">
<h4 id="h:750974de-2177-48f1-9c28-91fa2f996a2a">RDB和AOF 的选择</h4>
<div class="outline-text-4" id="text-h:750974de-2177-48f1-9c28-91fa2f996a2a">
<p>
如果主要充当缓存功能,或者可以承受数分钟数据的丢失,
通常生产环境一般只需启用RDB即可,此也是默认值
</p>

<p>
如果数据需要持久保存,一点不能丢失,可以选择同时开启RDB和AOF
</p>

<p>
一般不建议只开启AOF
</p>
</div>
</div>
</div>
<div id="outline-container-h:8461587c-5dc0-412d-a7da-16ad6525bc33" class="outline-3">
<h3 id="h:8461587c-5dc0-412d-a7da-16ad6525bc33">Redis 常用命令</h3>
<div class="outline-text-3" id="text-h:8461587c-5dc0-412d-a7da-16ad6525bc33">
<p>
官方文档：<a href="https://redis.io/commands">https://redis.io/commands</a>
</p>

<p>
参考链接: <a href="http://redisdoc.com/">http://redisdoc.com/</a>
</p>
</div>
<div id="outline-container-h:1bd12177-fb09-4484-bbaf-11a7cf59d7a3" class="outline-4">
<h4 id="h:1bd12177-fb09-4484-bbaf-11a7cf59d7a3">命令帮助</h4>
<div class="outline-text-4" id="text-h:1bd12177-fb09-4484-bbaf-11a7cf59d7a3">
<div class="org-src-container">
<pre class="src src-sh">&gt; Help &#26597;&#30475;&#24110;&#21161;
&gt; Help &lt;tab&gt; &#20351;&#29992;tab&#24314;&#20999;&#25442;&#24110;&#21161;
&gt; Help set &#26597;&#30475;set&#21629;&#20196;&#24110;&#21161;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; help
redis-cli 8.2.0
To get help about Redis commands type:
      <span style="color: #8b2252;">"help @&lt;group&gt;"</span> to get a list of commands<span style="color: #a020f0;"> in</span> &lt;group&gt;
      <span style="color: #8b2252;">"help &lt;command&gt;"</span> for help on &lt;command&gt;
      <span style="color: #8b2252;">"help &lt;tab&gt;"</span> to get a list of possible help topics
      <span style="color: #8b2252;">"quit"</span> to exit

To set redis-cli preferences:
      <span style="color: #8b2252;">":set hints"</span> enable online hints
      <span style="color: #8b2252;">":set nohints"</span> disable online hints

<span style="color: #b22222;"># </span><span style="color: #b22222;">string&#31867;&#22411;&#21629;&#20196;</span>
127.0.0.1:6379&gt; help @string
<span style="color: #b22222;"># </span><span style="color: #b22222;">list&#21015;&#34920;&#30456;&#20851;&#30340;&#21629;&#20196;</span>
127.0.0.1:6379&gt; help @list
</pre>
</div>
</div>
</div>
<div id="outline-container-h:da6f1cc2-957d-4cff-b71a-b82b179c87c9" class="outline-4">
<h4 id="h:da6f1cc2-957d-4cff-b71a-b82b179c87c9">INFO</h4>
<div class="outline-text-4" id="text-h:da6f1cc2-957d-4cff-b71a-b82b179c87c9">
<p>
显示当前节点redis运行状态信息
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; INFO
<span style="color: #b22222;"># </span><span style="color: #b22222;">Server</span>
redis_version:5.0.9
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:572b40848ddebfec
redis_mode:standalone
os:Linux 4.18.0-80.el8.x86_64 x86_64
arch_bits:64
multiplexing_api:epoll
atomicvar_api:atomic-builtin
...&#30465;&#30053;...

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#35835;&#20854;&#37096;&#20998;</span>
127.0.0.1:6379&gt; info server
127.0.0.1:6379&gt; info cluster
<span style="color: #b22222;"># </span><span style="color: #b22222;">Cluster</span>
cluster_enabled:0
</pre>
</div>
</div>
</div>
<div id="outline-container-h:64114f97-7313-4be7-ae69-7293c114872f" class="outline-4">
<h4 id="h:64114f97-7313-4be7-ae69-7293c114872f">SELECT</h4>
<div class="outline-text-4" id="text-h:64114f97-7313-4be7-ae69-7293c114872f">
<p>
切换数据库，相当于在MySQL的 USE DBNAME 指令
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#redis-cli -a centos --no-auth-warning
127.0.0.1:6379&gt; SELECT 0
OK
127.0.0.1:6379&gt; SELECT 15
OK
127.0.0.1:6379[15]&gt; SELECT 16
(error) ERR DB index is out of range
127.0.0.1:6379[15]&gt; 
</pre>
</div>

<p>
注意: 在 redis cluster 模式下不支持多个数据库,会出现下面错误
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#redis-cli
127.0.0.1:6379&gt; info cluster
<span style="color: #b22222;"># </span><span style="color: #b22222;">Cluster</span>
cluster_enabled:1
127.0.0.1:6379&gt; select 0
OK
127.0.0.1:6379&gt; select 1
(error) ERR SELECT is not allowed<span style="color: #a020f0;"> in</span> cluster mode
</pre>
</div>
</div>
</div>
<div id="outline-container-h:251c83a6-319f-4385-887b-5c4ae70c1938" class="outline-4">
<h4 id="h:251c83a6-319f-4385-887b-5c4ae70c1938">KEYS</h4>
<div class="outline-text-4" id="text-h:251c83a6-319f-4385-887b-5c4ae70c1938">
<p>
<b>查看当前库下的所有key，此命令慎用！</b>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">命令</th>
<th scope="col" class="org-left">时间复杂度</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">keys</td>
<td class="org-left">O(n)</td>
</tr>

<tr>
<td class="org-left">dbsize</td>
<td class="org-left">O(1)</td>
</tr>

<tr>
<td class="org-left">del</td>
<td class="org-left">O(1)</td>
</tr>

<tr>
<td class="org-left">exits</td>
<td class="org-left">O(1)</td>
</tr>

<tr>
<td class="org-left">expire</td>
<td class="org-left">O(1)</td>
</tr>

<tr>
<td class="org-left">type</td>
<td class="org-left">O(1)</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379[1]&gt; SELECT 0
OK
127.0.0.1:6379&gt; KEYS *  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#25968;&#25454;&#24211;&#20869;&#25152;&#26377;key  CPU&#21319;&#39640;</span>
1) <span style="color: #8b2252;">"port1"</span>
2) <span style="color: #8b2252;">"name"</span>
3) <span style="color: #8b2252;">"port2"</span>
4) <span style="color: #8b2252;">"port"</span>
127.0.0.1:6379&gt; SELECT 1
OK
127.0.0.1:6379[1]&gt; KEYS *
(empty list or set)
127.0.0.1:6379[1]&gt;

127.0.0.1:6379&gt; SELECT 1
OK
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#27425;&#35774;&#32622;4&#20010;key</span>
127.0.0.1:6379[1]&gt; MSET one 1 two 2 three 3 four 4
OK
127.0.0.1:6379[1]&gt; KEYS *o*
1) <span style="color: #8b2252;">"two"</span>
2) <span style="color: #8b2252;">"one"</span>
3) <span style="color: #8b2252;">"four"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:aa46e25b-10c6-4615-bfc1-e46e54e8aca7" class="outline-4">
<h4 id="h:aa46e25b-10c6-4615-bfc1-e46e54e8aca7">SCAN</h4>
<div class="outline-text-4" id="text-h:aa46e25b-10c6-4615-bfc1-e46e54e8aca7">
<p>
在 SCAN 出现之前，如果想获取所有匹配的键，我们通常会使用 KEYS 命令，例如 KEYS user:*。然而，KEYS 命令有一个致命的缺点：它会阻塞 Redis 服务器。
</p>

<p>
因为 Redis 是单线程的，如果在一个包含数百万键的数据库上执行 KEYS *，服务器会遍历整个键空间，导致在此期间无法处理任何其他请求，从而导致服务短暂不可用。
</p>

<p>
SCAN 命令就是为了解决这个问题而生的。它通过游标迭代的方式，分批地、非阻塞地遍历整个数据库，每次只返回一小部分元素，从而避免长时间阻塞。
</p>

<p>
SCAN 命令是一个游标迭代器，其基本语法如下：
</p>
<div class="org-src-container">
<pre class="src src-sh">SCAN cursor [MATCH pattern] [COUNT count] [TYPE type]

<span style="color: #b22222;">#</span><span style="color: #b22222;">cursor&#65306; &#28216;&#26631;&#65292;&#36845;&#20195;&#30340;&#36215;&#28857;&#12290;&#31532;&#19968;&#27425;&#36845;&#20195;&#26102;&#20256;&#20837; 0&#65292;&#20043;&#21518;&#27599;&#27425;&#36845;&#20195;&#37117;&#20351;&#29992;&#19978;&#19968;&#27425;&#35843;&#29992;&#36820;&#22238;&#30340;&#26032;&#28216;&#26631;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">MATCH pattern&#65306; &#65288;&#21487;&#36873;&#65289;&#21305;&#37197;&#27169;&#24335;&#65292;&#31867;&#20284;&#20110; KEYS &#21629;&#20196;&#20013;&#30340;&#27169;&#24335;&#65292;&#20351;&#29992;&#36890;&#37197;&#31526;&#39118;&#26684;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">COUNT count&#65306; &#65288;&#21487;&#36873;&#65289;&#24314;&#35758;&#20540;&#65292;&#25351;&#31034;&#26381;&#21153;&#22120;&#27599;&#27425;&#36845;&#20195;&#22823;&#33268;&#36820;&#22238;&#22810;&#23569;&#20803;&#32032;&#12290;&#40664;&#35748;&#20540;&#36890;&#24120;&#26159; 10&#12290;&#35831;&#27880;&#24847;&#65306;&#36825;&#21482;&#26159;&#19968;&#20010;&#25552;&#31034;&#65292;&#36820;&#22238;&#30340;&#25968;&#37327;&#21487;&#33021;&#27604; COUNT &#22810;&#25110;&#23569;&#65292;&#24182;&#38750;&#20005;&#26684;&#20445;&#35777;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">TYPE type&#65306; &#65288;&#21487;&#36873;&#65289;Redis 6.0 &#21450;&#20197;&#19978;&#29256;&#26412;&#21487;&#29992;&#12290;&#20801;&#35768;&#20320;&#26681;&#25454;&#38190;&#30340;&#31867;&#22411;&#65288;&#22914; string, hash, list, set, zset, stream &#31561;&#65289;&#36827;&#34892;&#36807;&#28388;&#12290;</span>
</pre>
</div>

<p>
除了基础的 SCAN，还有用于特定数据结构的迭代命令：
</p>
<ul class="org-ul">
<li>SSCAN： 用于迭代集合（Set）中的元素。</li>
<li>HSCAN： 用于迭代哈希（Hash）中的字段和值。</li>
<li>ZSCAN： 用于迭代有序集合（Sorted Set）中的成员和分值。</li>
</ul>

<p>
SCAN 命令的特点和工作原理
</p>
<ul class="org-ul">
<li>非阻塞： 每次调用只获取少量元素，不会长时间阻塞服务器。</li>
<li>可能重复： 在整个迭代过程中，如果数据库发生了修改（增、删、改），同一个元素可能会被返回多次。需要应用程序自己处理重复的情况（例如，将结果放入一个 Set 中去重）。</li>
<li>可能遗漏： 在整个迭代过程中，如果某个元素一直被修改，它有可能不会被返回。这是为了性能而做的权衡。</li>
<li>游标 0： 当命令返回的游标为 0 时，表示迭代已经完成。</li>
<li>返回结果： 命令返回一个包含两个元素的数组：</li>
<li>第一个元素是 next_cursor，一个整数值，用于下一次迭代。</li>
<li>第二个元素是一个列表，包含本次迭代返回的键。</li>
</ul>

<p>
1.基本迭代
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#19968;&#27425;&#35843;&#29992;&#65292;&#20174;&#28216;&#26631; 0 &#24320;&#22987;</span>
127.0.0.1:6379&gt; SCAN 0
1) <span style="color: #8b2252;">"17"</span>            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19979;&#19968;&#27425;&#36845;&#20195;&#35201;&#20351;&#29992;&#30340;&#26032;&#28216;&#26631;</span>
2)  1) <span style="color: #8b2252;">"key:1"</span>     <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26412;&#27425;&#36845;&#20195;&#36820;&#22238;&#30340;&#38190;&#21015;&#34920;</span>
    2) <span style="color: #8b2252;">"key:age"</span>
    3) <span style="color: #8b2252;">"key:2"</span>
    4) <span style="color: #8b2252;">"mykey"</span>
    5) <span style="color: #8b2252;">"user:1000"</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20351;&#29992;&#19978;&#19968;&#27425;&#36820;&#22238;&#30340;&#28216;&#26631; 17 &#36827;&#34892;&#19979;&#19968;&#27425;&#35843;&#29992;</span>
127.0.0.1:6379&gt; SCAN 17
1) <span style="color: #8b2252;">"0"</span>             <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28216;&#26631;&#36820;&#22238; 0&#65292;&#34920;&#31034;&#36845;&#20195;&#24050;&#32467;&#26463;</span>
2) 1) <span style="color: #8b2252;">"foo"</span>
    2) <span style="color: #8b2252;">"key:name"</span>
    3) <span style="color: #8b2252;">"bar"</span>
</pre>
</div>

<p>
2.使用 MATCH 模式
</p>
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; SCAN 0 MATCH user:*
1) <span style="color: #8b2252;">"42"</span>
2) 1) <span style="color: #8b2252;">"user:1000"</span>
   2) <span style="color: #8b2252;">"user:2001"</span>
   3) <span style="color: #8b2252;">"user:1001"</span>

127.0.0.1:6379&gt; SCAN 42 MATCH user:*
1) <span style="color: #8b2252;">"0"</span>
2) 1) <span style="color: #8b2252;">"user:abc"</span>
   2) <span style="color: #8b2252;">"user:3000"</span>
</pre>
</div>

<p>
3.使用 COUNT 参数
</p>
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; SCAN 0 COUNT 5
1) <span style="color: #8b2252;">"10"</span>
2) 1) <span style="color: #8b2252;">"a"</span>
   2) <span style="color: #8b2252;">"b"</span>
   3) <span style="color: #8b2252;">"c"</span>
   4) <span style="color: #8b2252;">"d"</span>
   5) <span style="color: #8b2252;">"e"</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#27425;&#27491;&#22909;&#36820;&#22238;&#20102; 5 &#20010;</span>

127.0.0.1:6379&gt; SCAN 10 COUNT 5
1) <span style="color: #8b2252;">"20"</span>
2) 1) <span style="color: #8b2252;">"f"</span>
   2) <span style="color: #8b2252;">"g"</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#27425;&#21482;&#36820;&#22238;&#20102; 2 &#20010;&#65292;COUNT &#21482;&#26159;&#24314;&#35758;&#20540;</span>
</pre>
</div>

<p>
4.使用 TYPE 过滤器 (Redis 6.0+)
</p>
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; SCAN 0 TYPE list
1) <span style="color: #8b2252;">"0"</span>
2) 1) <span style="color: #8b2252;">"mylist"</span>
   2) <span style="color: #8b2252;">"queue:jobs"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">SCAN 0 MATCH <span style="color: #8b2252;">"UA:ACCESS_TOKEN_CACHE:*"</span> COUNT 1000
</pre>
</div>
</div>
</div>
<div id="outline-container-h:abe35a61-5f47-4c7a-9286-9b6fb4e6a0a2" class="outline-4">
<h4 id="h:abe35a61-5f47-4c7a-9286-9b6fb4e6a0a2">BGSAVE</h4>
<div class="outline-text-4" id="text-h:abe35a61-5f47-4c7a-9286-9b6fb4e6a0a2">
<p>
手动在后台执行RDB持久化操作
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20132;&#20114;&#24335;&#25191;&#34892;</span>
127.0.0.1:6379[1]&gt; BGSAVE
Background saving started

[root@centos8 ~]#ll /apps/redis/data/
total 664
-rw-r--r-- 1 redis redis    204 Oct 22 21:30 dump_6379.rdb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38750;&#20132;&#20114;&#24335;&#25191;&#34892;</span>
[root@centos8 ~]#redis-cli -a centos --no-auth-warning bgsave
Background saving started
[root@centos8 ~]#ll /apps/redis/data/
total 664
-rw-r--r-- 1 redis redis    204 Oct 22 21:32 dump_6379.rdb
</pre>
</div>
</div>
</div>
<div id="outline-container-h:30d05e12-d9f1-42d7-9100-19bd73f81f8f" class="outline-4">
<h4 id="h:30d05e12-d9f1-42d7-9100-19bd73f81f8f">DBSIZE</h4>
<div class="outline-text-4" id="text-h:30d05e12-d9f1-42d7-9100-19bd73f81f8f">
<p>
返回当前库下的所有key 数量
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; DBSIZE
(integer) 8
127.0.0.1:6379&gt; SELECT 1
OK
127.0.0.1:6379[1]&gt; DBSIZE
(integer) 4
127.0.0.1:6379[1]&gt; SELECT 2
OK
127.0.0.1:6379[2]&gt; DBSIZE
(integer) 0
</pre>
</div>
</div>
</div>
<div id="outline-container-h:783a4845-4094-4997-9606-bfe466e28858" class="outline-4">
<h4 id="h:783a4845-4094-4997-9606-bfe466e28858">FLUSHDB</h4>
<div class="outline-text-4" id="text-h:783a4845-4094-4997-9606-bfe466e28858">
<p>
<b>强制清空当前库中的所有key，此命令慎用！</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379[2]&gt; SELECT 1
OK
127.0.0.1:6379[1]&gt; DBSIZE
(integer) 4
127.0.0.1:6379[1]&gt; FLUSHDB
OK
127.0.0.1:6379[1]&gt; DBSIZE
(integer) 0
</pre>
</div>
</div>
</div>
<div id="outline-container-h:772ad497-64b6-4838-924b-8154bbdf098f" class="outline-4">
<h4 id="h:772ad497-64b6-4838-924b-8154bbdf098f">FLUSHALL</h4>
<div class="outline-text-4" id="text-h:772ad497-64b6-4838-924b-8154bbdf098f">
<p>
<b>强制清空当前redis服务器所有数据库中的所有key，即删除所有数据，此命令慎用！</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; FLUSHALL
OK

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#20135;&#24314;&#35758;&#20462;&#25913;&#37197;&#32622; /etc/redis.conf&#65292;&#31105;&#29992;&#25110;&#25913;&#20026;&#21035;&#21517;</span>
rename-command FLUSHALL <span style="color: #8b2252;">""</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:704e13d5-dbf5-4b1d-9136-fda3fb11b2be" class="outline-4">
<h4 id="h:704e13d5-dbf5-4b1d-9136-fda3fb11b2be">SHUTDOWN</h4>
<div class="outline-text-4" id="text-h:704e13d5-dbf5-4b1d-9136-fda3fb11b2be">
<div class="org-src-container">
<pre class="src src-sh">&#21487;&#29992;&#29256;&#26412;&#65306; &gt;= 1.0.0
&#26102;&#38388;&#22797;&#26434;&#24230;&#65306; O(N)&#65292;&#20854;&#20013; N &#20026;&#20851;&#26426;&#26102;&#38656;&#35201;&#20445;&#23384;&#30340;&#25968;&#25454;&#24211;&#38190;&#25968;&#37327;&#12290;
SHUTDOWN &#21629;&#20196;&#25191;&#34892;&#20197;&#19979;&#25805;&#20316;&#65306;

&#20851;&#38381;&#26381;&#21153;

&#22914;&#26524;&#26377;&#33267;&#23569;&#19968;&#20010;&#20445;&#23384;&#28857;&#22312;&#31561;&#24453;&#65292;&#25191;&#34892; SAVE &#21629;&#20196;

&#22914;&#26524; AOF &#36873;&#39033;&#34987;&#25171;&#24320;&#65292;&#26356;&#26032; AOF &#25991;&#20214;

&#20851;&#38381; redis &#26381;&#21153;&#22120;(server)

&#22914;&#26524;&#25345;&#20037;&#21270;&#34987;&#25171;&#24320;&#30340;&#35805;&#65292; SHUTDOWN &#21629;&#20196;&#20250;&#20445;&#35777;&#26381;&#21153;&#22120;&#27491;&#24120;&#20851;&#38381;&#32780;&#19981;&#20002;&#22833;&#20219;&#20309;&#25968;&#25454;&#12290;

&#21478;&#19968;&#26041;&#38754;&#65292;&#20551;&#22914;&#21482;&#26159;&#21333;&#32431;&#22320;&#25191;&#34892; SAVE &#21629;&#20196;&#65292;&#28982;&#21518;&#20877;&#25191;&#34892; QUIT &#21629;&#20196;&#65292;&#21017;&#27809;&#26377;&#36825;&#19968;&#20445;&#35777; &#8212;&#8212; &#22240;&#20026;&#22312;&#25191;&#34892;SAVE &#20043;&#21518;&#12289;&#25191;&#34892; QUIT &#20043;&#21069;&#30340;&#36825;&#27573;&#26102;&#38388;&#20013;&#38388;&#65292;&#20854;&#20182;&#23458;&#25143;&#31471;&#21487;&#33021;&#27491;&#22312;&#21644;&#26381;&#21153;&#22120;&#36827;&#34892;&#36890;&#35759;&#65292;&#36825;&#26102;&#22914;&#26524;&#25191;&#34892;QUIT &#23601;&#20250;&#36896;&#25104;&#25968;&#25454;&#20002;&#22833;&#12290;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:83440a30-629c-433a-a1b5-becc88acbb4a" class="outline-4">
<h4 id="h:83440a30-629c-433a-a1b5-becc88acbb4a">CLIENT LIST</h4>
<div class="outline-text-4" id="text-h:83440a30-629c-433a-a1b5-becc88acbb4a">
<p>
查看当前连接
</p>
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379[8]&gt; info clients
<span style="color: #b22222;"># </span><span style="color: #b22222;">Clients</span>
connected_clients:2
cluster_connections:0


127.0.0.1:6379[8]&gt; client list
<span style="color: #a0522d;">id</span>=4 <span style="color: #a0522d;">addr</span>=127.0.0.1:52970 <span style="color: #a0522d;">laddr</span>=127.0.0.1:6379 <span style="color: #a0522d;">fd</span>=11 <span style="color: #a0522d;">name</span>= <span style="color: #a0522d;">age</span>=
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:66748bf2-21ca-4144-a3f9-60ba873ca96d" class="outline-3">
<h3 id="h:66748bf2-21ca-4144-a3f9-60ba873ca96d">redis 数据类型</h3>
<div class="outline-text-3" id="text-h:66748bf2-21ca-4144-a3f9-60ba873ca96d">
<p>
参考资料：<a href="https://redis.io/docs/latest/develop/data-types/">https://redis.io/docs/latest/develop/data-types/</a>
</p>

<p>
相关命令参考: <a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a>
</p>


<figure id="org0b594b3">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/2020102221402987.png" alt="2020102221402987.png">

</figure>


<figure id="org16816a2">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022214102425.png" alt="20201022214102425.png">

</figure>
</div>
<div id="outline-container-h:abf1e907-f26b-4b27-9ed0-526a075d2860" class="outline-4">
<h4 id="h:abf1e907-f26b-4b27-9ed0-526a075d2860">字符串 string</h4>
<div class="outline-text-4" id="text-h:abf1e907-f26b-4b27-9ed0-526a075d2860">
<p>
字符串是所有编程语言中最常见的和最常用的数据类型，而且也是redis最基本
的数据类型之一，而且redis中所有的 key 的类型都是字符串。常用于保存
Session信息场景，此数据类型比较常用
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">命令</th>
<th scope="col" class="org-left">含义</th>
<th scope="col" class="org-left">复杂度</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">set key value</td>
<td class="org-left">设置key-value</td>
<td class="org-left">o(1)</td>
</tr>

<tr>
<td class="org-left">get key</td>
<td class="org-left">获取key-value</td>
<td class="org-left">o(1)</td>
</tr>

<tr>
<td class="org-left">del key</td>
<td class="org-left">删除key-value</td>
<td class="org-left">o(1)</td>
</tr>

<tr>
<td class="org-left">setnx setxx</td>
<td class="org-left">根据key是否存在设置key-value</td>
<td class="org-left">o(1)</td>
</tr>

<tr>
<td class="org-left">Incr decr</td>
<td class="org-left">计数</td>
<td class="org-left">o(1)</td>
</tr>

<tr>
<td class="org-left">mget mset</td>
<td class="org-left">批量操作key-value</td>
<td class="org-left">o(1)</td>
</tr>
</tbody>
</table>
</div>
<div id="outline-container-h:79218a7e-fe97-4dea-b59c-b06077177733" class="outline-5">
<h5 id="h:79218a7e-fe97-4dea-b59c-b06077177733">添加一个key</h5>
<div class="outline-text-5" id="text-h:79218a7e-fe97-4dea-b59c-b06077177733">
<p>
set 指令可以创建一个key 并赋值, 使用格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">SET key value [EX seconds] [PX milliseconds] [NX|XX]
&#26102;&#38388;&#22797;&#26434;&#24230;&#65306; O(1)
&#23558;&#23383;&#31526;&#20018;&#20540; value &#20851;&#32852;&#21040; key &#12290;

&#22914;&#26524; key &#24050;&#32463;&#25345;&#26377;&#20854;&#20182;&#20540;&#65292; SET &#23601;&#35206;&#20889;&#26087;&#20540;&#65292; &#26080;&#35270;&#31867;&#22411;&#12290;
&#24403; SET &#21629;&#20196;&#23545;&#19968;&#20010;&#24102;&#26377;&#29983;&#23384;&#26102;&#38388;&#65288;TTL&#65289;&#30340;&#38190;&#36827;&#34892;&#35774;&#32622;&#20043;&#21518;&#65292; &#35813;&#38190;&#21407;&#26377;&#30340; TTL &#23558;&#34987;&#28165;&#38500;&#12290;

&#20174; Redis 2.6.12 &#29256;&#26412;&#24320;&#22987;&#65292; SET &#21629;&#20196;&#30340;&#34892;&#20026;&#21487;&#20197;&#36890;&#36807;&#19968;&#31995;&#21015;&#21442;&#25968;&#26469;&#20462;&#25913;&#65306;
EX seconds &#65306; &#23558;&#38190;&#30340;&#36807;&#26399;&#26102;&#38388;&#35774;&#32622;&#20026; seconds &#31186;&#12290; &#25191;&#34892; SET key value EX seconds &#30340;&#25928;&#26524;&#31561;&#21516;&#20110;&#25191;&#34892; SETEX key seconds value &#12290;
PX milliseconds &#65306; &#23558;&#38190;&#30340;&#36807;&#26399;&#26102;&#38388;&#35774;&#32622;&#20026; milliseconds &#27627;&#31186;&#12290; &#25191;&#34892; SET key value PX milliseconds &#30340;&#25928;&#26524;&#31561;&#21516;&#20110;&#25191;&#34892; PSETEX key milliseconds value &#12290;
NX &#65306; &#21482;&#22312;&#38190;&#19981;&#23384;&#22312;&#26102;&#65292; &#25165;&#23545;&#38190;&#36827;&#34892;&#35774;&#32622;&#25805;&#20316;&#12290; &#25191;&#34892; SET key value NX &#30340;&#25928;&#26524;&#31561;&#21516;&#20110;&#25191;&#34892; SETNX key value &#12290;
XX &#65306; &#21482;&#22312;&#38190;&#24050;&#32463;&#23384;&#22312;&#26102;&#65292; &#25165;&#23545;&#38190;&#36827;&#34892;&#35774;&#32622;&#25805;&#20316;&#12290;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; set key1 value1
OK
127.0.0.1:6379&gt; get key1
<span style="color: #8b2252;">"value1"</span>
127.0.0.1:6379&gt; type key1
string
127.0.0.1:6379&gt; set title ceo ex 5  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#33258;&#21160;&#36807;&#26399;&#26102;&#38388;&#20026;5&#31186;</span>
OK
127.0.0.1:6379&gt; get title
<span style="color: #8b2252;">"ceo"</span>
127.0.0.1:6379&gt; get title
(nil)

<span style="color: #b22222;">#</span><span style="color: #b22222;">key&#22823;&#23567;&#20889;&#25935;&#24863;</span>
127.0.0.1:6379&gt; set NAME KOBE
OK
127.0.0.1:6379&gt; get NAME
<span style="color: #8b2252;">"KOBE"</span>
127.0.0.1:6379&gt; get name
(nil)
127.0.0.1:6379&gt; set name brynat
OK
127.0.0.1:6379&gt; get name
<span style="color: #8b2252;">"brynat"</span>
127.0.0.1:6379&gt; get NAME
<span style="color: #8b2252;">"KOBE"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">key&#19981;&#23384;&#22312;&#25165;&#35774;&#32622;&#65292;&#30456;&#24403;&#20110;add</span>
127.0.0.1:6379&gt; get name
<span style="color: #8b2252;">"brynat"</span>
127.0.0.1:6379&gt; setnx  name ceo <span style="color: #b22222;">#</span><span style="color: #b22222;">set key value nx</span>
(integer) 0
127.0.0.1:6379&gt; get name
<span style="color: #8b2252;">"brynat"</span>



<span style="color: #b22222;">#</span><span style="color: #b22222;">key&#23384;&#22312;&#25165;&#35774;&#32622;&#65292;&#30456;&#24403;&#20110;update</span>
127.0.0.1:6379&gt; get name
<span style="color: #8b2252;">"brynat"</span>
127.0.0.1:6379&gt; set name tao xx
OK
127.0.0.1:6379&gt; get name
<span style="color: #8b2252;">"tao"</span>
127.0.0.1:6379&gt; get age
(nil)
127.0.0.1:6379&gt; set age 23 xx
(nil)
127.0.0.1:6379&gt; get age
(nil)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:30c750d0-3ef6-4cfd-886a-77a5d6223ac1" class="outline-5">
<h5 id="h:30c750d0-3ef6-4cfd-886a-77a5d6223ac1">获取一个key的内容</h5>
<div class="outline-text-5" id="text-h:30c750d0-3ef6-4cfd-886a-77a5d6223ac1">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; get NAME
<span style="color: #8b2252;">"KOBE"</span>
127.0.0.1:6379&gt; get name age
(error) ERR wrong number of arguments for <span style="color: #8b2252;">'get'</span> command
</pre>
</div>
</div>
</div>
<div id="outline-container-h:61a14572-e433-409d-85a3-010dec172093" class="outline-5">
<h5 id="h:61a14572-e433-409d-85a3-010dec172093">删除一个和多个key</h5>
<div class="outline-text-5" id="text-h:61a14572-e433-409d-85a3-010dec172093">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; del name
(integer) 1

127.0.0.1:6379&gt; del age NAME
(integer) 2
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fd8c70c2-afc5-4de3-b2ad-a7fa9be58bd3" class="outline-5">
<h5 id="h:fd8c70c2-afc5-4de3-b2ad-a7fa9be58bd3">批量设置多个key</h5>
<div class="outline-text-5" id="text-h:fd8c70c2-afc5-4de3-b2ad-a7fa9be58bd3">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; mset k1 v1 k2 v2 k3 v3
OK
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7b4e6021-5ff4-49d3-9d53-f0b1320f98c3" class="outline-5">
<h5 id="h:7b4e6021-5ff4-49d3-9d53-f0b1320f98c3">批量获取多个key</h5>
<div class="outline-text-5" id="text-h:7b4e6021-5ff4-49d3-9d53-f0b1320f98c3">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; mget k1 k2
1) <span style="color: #8b2252;">"v1"</span>
2) <span style="color: #8b2252;">"v2"</span>
127.0.0.1:6379&gt; KEYS *
1) <span style="color: #8b2252;">"k1"</span>
2) <span style="color: #8b2252;">"k2"</span>
3) <span style="color: #8b2252;">"k3"</span>
4) <span style="color: #8b2252;">"myset"</span>
127.0.0.1:6379&gt; keys k*
1) <span style="color: #8b2252;">"k1"</span>
2) <span style="color: #8b2252;">"k2"</span>
3) <span style="color: #8b2252;">"k3"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:810aa21a-f2cb-4c9a-ae0e-27460681e4ed" class="outline-5">
<h5 id="h:810aa21a-f2cb-4c9a-ae0e-27460681e4ed">追加数据</h5>
<div class="outline-text-5" id="text-h:810aa21a-f2cb-4c9a-ae0e-27460681e4ed">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; append k2 <span style="color: #8b2252;">" append new value"</span>
(integer) 19
127.0.0.1:6379&gt; get k2
<span style="color: #8b2252;">"v2 append new value"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ab51e4ce-1683-4d3d-b797-bfe01d06d674" class="outline-5">
<h5 id="h:ab51e4ce-1683-4d3d-b797-bfe01d06d674">设置新值并返回旧值</h5>
<div class="outline-text-5" id="text-h:ab51e4ce-1683-4d3d-b797-bfe01d06d674">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; set name kobe
OK
127.0.0.1:6379&gt; getset name bryant
<span style="color: #8b2252;">"kobe"</span>
127.0.0.1:6379&gt; get name
<span style="color: #8b2252;">"bryant"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:186d5506-77c6-431a-ae54-46ae680a24b2" class="outline-5">
<h5 id="h:186d5506-77c6-431a-ae54-46ae680a24b2">返回字符串 key 对应值的字节数</h5>
<div class="outline-text-5" id="text-h:186d5506-77c6-431a-ae54-46ae680a24b2">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; set name kobe
OK
127.0.0.1:6379&gt; STRLEN name <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#23383;&#33410;&#25968;</span>
(integer) 4
127.0.0.1:6379&gt; append name <span style="color: #8b2252;">" bryant"</span>
(integer) 11
127.0.0.1:6379&gt; get name
<span style="color: #8b2252;">"kobe bryant"</span>
127.0.0.1:6379&gt; STRLEN name
(integer) 11

127.0.0.1:6379&gt; set name &#22909;&#22909;&#23398;&#20064;
OK
127.0.0.1:6379&gt; get name
<span style="color: #8b2252;">"\xe5\xa5\xbd\xe5\xa5\xbd\xe5\xad\xa6\xe4\xb9\xa0"</span>
127.0.0.1:6379&gt; STRLEN name
(integer) 12
</pre>
</div>
</div>
</div>
<div id="outline-container-h:129ecbb8-0be5-4bd8-a5d4-a32505342247" class="outline-5">
<h5 id="h:129ecbb8-0be5-4bd8-a5d4-a32505342247">判断 key 是否存在</h5>
<div class="outline-text-5" id="text-h:129ecbb8-0be5-4bd8-a5d4-a32505342247">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; set name kobe ex 5
OK
127.0.0.1:6379&gt; exists name <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#20540;&#20026;1&#34920;&#31034;&#23384;&#22312;&#65292;0&#34920;&#31034;&#19981;&#23384;&#22312;</span>
(integer) 1
127.0.0.1:6379&gt; exists name
(integer) 0
127.0.0.1:6379&gt; set name kobe ex 10
OK
127.0.0.1:6379&gt; exists name age
(integer) 2
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0794307b-4724-47e0-a8b4-4b0964939527" class="outline-5">
<h5 id="h:0794307b-4724-47e0-a8b4-4b0964939527">查看 key 的过期时间</h5>
<div class="outline-text-5" id="text-h:0794307b-4724-47e0-a8b4-4b0964939527">
<div class="org-src-container">
<pre class="src src-sh">ttl key <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;key&#30340;&#21097;&#20313;&#29983;&#23384;&#26102;&#38388;,&#22914;&#26524;key&#36807;&#26399;&#21518;,&#20250;&#33258;&#21160;&#21024;&#38500;</span>

-1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#20540;&#34920;&#31034;&#27704;&#19981;&#36807;&#26399;&#65292;&#40664;&#35748;&#21019;&#24314;&#30340;key&#26159;&#27704;&#19981;&#36807;&#26399;&#65292;&#37325;&#26032;&#23545;key&#36171;&#20540;&#65292;&#20063;&#20250;&#20174;&#26377;&#21097;&#20313;&#29983;&#21629;&#21608;&#26399;&#21464;&#25104;&#27704;&#19981;&#36807;&#26399;</span>
-2 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#20540;&#34920;&#31034;&#27809;&#26377;&#27492;key</span>
num <span style="color: #b22222;">#</span><span style="color: #b22222;">key&#30340;&#21097;&#20313;&#26377;&#25928;&#26399;</span>

127.0.0.1:6379&gt; TTL age
(integer) -1
127.0.0.1:6379&gt; set name kobe ex 20
OK
127.0.0.1:6379&gt; ttl name
(integer) 16
127.0.0.1:6379&gt; ttl name
(integer) 14
127.0.0.1:6379&gt; ttl name
(integer) -2
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8e82b373-afed-4117-af97-e955793ab021" class="outline-5">
<h5 id="h:8e82b373-afed-4117-af97-e955793ab021">重新设置key的过期时间</h5>
<div class="outline-text-5" id="text-h:8e82b373-afed-4117-af97-e955793ab021">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; set name kobe ex 20
OK
127.0.0.1:6379&gt; EXPIRE name 30
(integer) 1
127.0.0.1:6379&gt; ttl name
(integer) 25
</pre>
</div>
</div>
</div>
<div id="outline-container-h:dc6abbea-6aa7-4a65-ae14-9f507f14b563" class="outline-5">
<h5 id="h:dc6abbea-6aa7-4a65-ae14-9f507f14b563">取消key的过期时间</h5>
<div class="outline-text-5" id="text-h:dc6abbea-6aa7-4a65-ae14-9f507f14b563">
<p>
即永不过期
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; ttl name
(integer) 26
127.0.0.1:6379&gt; PERSIST name
(integer) 1
127.0.0.1:6379&gt; ttl name
(integer) -1
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f6eb90aa-4c7b-40e3-9d70-dd87856376f4" class="outline-5">
<h5 id="h:f6eb90aa-4c7b-40e3-9d70-dd87856376f4">数值递增</h5>
<div class="outline-text-5" id="text-h:f6eb90aa-4c7b-40e3-9d70-dd87856376f4">
<p>
利用INCR命令簇（INCR, DECR,
[INCRBY],DECRBY）来把字符串当作原子计数器使用。
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; set num 21
OK
127.0.0.1:6379&gt; INCR num
(integer) 22
127.0.0.1:6379&gt; get num
<span style="color: #8b2252;">"22"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2c1fb181-0deb-4c50-9eb4-c576204001d1" class="outline-5">
<h5 id="h:2c1fb181-0deb-4c50-9eb4-c576204001d1">数值递减</h5>
<div class="outline-text-5" id="text-h:2c1fb181-0deb-4c50-9eb4-c576204001d1">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; set num 21
OK
127.0.0.1:6379&gt; DECR num
(integer) 20
127.0.0.1:6379&gt; get num
<span style="color: #8b2252;">"20"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4f4950d2-9c4b-4fb6-b254-444b4e7a9dec" class="outline-5">
<h5 id="h:4f4950d2-9c4b-4fb6-b254-444b4e7a9dec">数值增加</h5>
<div class="outline-text-5" id="text-h:4f4950d2-9c4b-4fb6-b254-444b4e7a9dec">
<p>
将key对应的数字加decrement(可以是负数)。如果key不存在，操作之前，key就会被置为0。如果key的value类型错误或者是个不能表示成数字的字符串，就返回错误。这个操作最多支持64位有符号的正型数字。
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; set num 30 
OK
127.0.0.1:6379&gt; INCRBY num 20
(integer) 50
127.0.0.1:6379&gt; get num
<span style="color: #8b2252;">"50"</span>
127.0.0.1:6379&gt; INCRBY num -20
(integer) 30
127.0.0.1:6379&gt; get num
<span style="color: #8b2252;">"30"</span>

127.0.0.1:6379&gt; get num1
(nil)
127.0.0.1:6379&gt; INCRBY num1 5
(integer) 5
127.0.0.1:6379&gt; get num1
<span style="color: #8b2252;">"5"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:880d9462-d598-4cdf-92db-3b28622d5798" class="outline-5">
<h5 id="h:880d9462-d598-4cdf-92db-3b28622d5798">数据减少</h5>
<div class="outline-text-5" id="text-h:880d9462-d598-4cdf-92db-3b28622d5798">
<p>
decrby 可以减小数值(也可以增加)
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; set num 30 
OK
127.0.0.1:6379&gt; DECRBY num 20
(integer) 10
127.0.0.1:6379&gt; get num
<span style="color: #8b2252;">"10"</span>
127.0.0.1:6379&gt; DECRBY num -20
(integer) 30
127.0.0.1:6379&gt; get num
<span style="color: #8b2252;">"30"</span>

127.0.0.1:6379&gt; get num1
(nil)
127.0.0.1:6379&gt; DECRBY num1 10
(integer) -10
127.0.0.1:6379&gt; get num1
<span style="color: #8b2252;">"-10"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5c287183-1e6b-4f0f-b9f9-8ce63f6dfa03" class="outline-5">
<h5 id="h:5c287183-1e6b-4f0f-b9f9-8ce63f6dfa03">其他</h5>
<div class="outline-text-5" id="text-h:5c287183-1e6b-4f0f-b9f9-8ce63f6dfa03">
<p>
追加字符串
</p>
<ul class="org-ul">
<li>APPEND key value      追加字符串。如果键存在就追加；如果不存在就等同于    SET key value</li>
</ul>

<p>
获取子字符串
</p>
<ul class="org-ul">
<li>GETRANGE key start end    索引值从0开始，支持负索引，-1表示最后一个字符。范围是[start,end],start必须在end的左边，否则返回空串</li>
</ul>

<p>
覆盖字符串
</p>
<ul class="org-ul">
<li>SETRANGE key offset value    从指定索引处开始覆盖字符串，返回覆盖后字符串长度。key不存在会创建新的。</li>
</ul>

<p>
练习
</p>
<div class="org-src-container">
<pre class="src src-sh">
127.0.0.1:6379&gt; select 1
OK
127.0.0.1:6379[1]&gt; keys *
(empty list or set)
127.0.0.1:6379[1]&gt; append s2 abc
(integer) 3
127.0.0.1:6379[1]&gt; get s2
<span style="color: #8b2252;">"abc"</span>
127.0.0.1:6379[1]&gt; append s2 efg
(integer) 6
127.0.0.1:6379[1]&gt; get s2
<span style="color: #8b2252;">"abcefg"</span>
127.0.0.1:6379[1]&gt; getrange s2 1 3
<span style="color: #8b2252;">"bce"</span>
127.0.0.1:6379[1]&gt; getrange s2 0 -1
<span style="color: #8b2252;">"abcefg"</span>
127.0.0.1:6379[1]&gt; setrange s2 3 12
(integer) 6
127.0.0.1:6379[1]&gt; get s2
<span style="color: #8b2252;">"abc12g"</span>
127.0.0.1:6379[1]&gt; setrange s2 -1 123456
(error) ERR offset is out of range
127.0.0.1:6379[1]&gt; get s2
<span style="color: #8b2252;">"abc12g"</span>
127.0.0.1:6379[1]&gt; setrange s2 3 123456789
(integer) 12
127.0.0.1:6379[1]&gt; get s2
<span style="color: #8b2252;">"abc123456789"</span>
127.0.0.1:6379[1]&gt; setrange s7 3 abc
(integer) 6
127.0.0.1:6379[1]&gt; get s7
<span style="color: #8b2252;">"\x00\x00\x00abc"</span>
127.0.0.1:6379[1]&gt;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:b6048900-90e3-4ffd-b755-368548205d64" class="outline-4">
<h4 id="h:b6048900-90e3-4ffd-b755-368548205d64">列表 list</h4>
<div class="outline-text-4" id="text-h:b6048900-90e3-4ffd-b755-368548205d64">

<figure id="org3975178">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022222527455.png" alt="20201022222527455.png">

</figure>

<p>
列表是一个双向可读写的管道，其头部是左侧，尾部是右侧，一个列表最多可以
包含2^32-1（4294967295）个元素，下标0 表示列表的第一个元素，以 1 表示
列表的第二个元素，以此类推。
</p>

<p>
也可以使用负数下标，以 -1 表示列表的最后一个元素， -2表示列表的倒数第
二个元素，元素值可以重复，常用于存入日志等场景，此数据类型比较常用
</p>

<p>
列表特点：
</p>

<ul class="org-ul">
<li>有序</li>
<li>可重复</li>
<li>左右都可以操作</li>
</ul>
</div>
<div id="outline-container-h:1761b0d8-2a8c-4e1a-9c6c-117638fc782e" class="outline-5">
<h5 id="h:1761b0d8-2a8c-4e1a-9c6c-117638fc782e">生成列表并插入数据</h5>
<div class="outline-text-5" id="text-h:1761b0d8-2a8c-4e1a-9c6c-117638fc782e">

<figure id="org827d41a">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022222626279.png" alt="20201022222626279.png">

</figure>

<p>
LPUSH和RPUSH都可以插入列表
</p>

<div class="org-src-container">
<pre class="src src-sh">LPUSH key value [value &#8230;]
&#26102;&#38388;&#22797;&#26434;&#24230;&#65306; O(1)
&#23558;&#19968;&#20010;&#25110;&#22810;&#20010;&#20540; value &#25554;&#20837;&#21040;&#21015;&#34920; key &#30340;&#34920;&#22836;

&#22914;&#26524;&#26377;&#22810;&#20010; value &#20540;&#65292;&#37027;&#20040;&#21508;&#20010; value &#20540;&#25353;&#20174;&#24038;&#21040;&#21491;&#30340;&#39034;&#24207;&#20381;&#27425;&#25554;&#20837;&#21040;&#34920;&#22836;&#65306; &#27604;&#22914;&#35828;&#65292;&#23545;&#31354;&#21015;&#34920;mylist &#25191;&#34892;&#21629;&#20196; LPUSH mylist a b c &#65292;&#21015;&#34920;&#30340;&#20540;&#23558;&#26159; c b a &#65292;&#36825;&#31561;&#21516;&#20110;&#21407;&#23376;&#24615;&#22320;&#25191;&#34892; LPUSH
mylist a &#12289; LPUSH mylist b &#21644; LPUSH mylist c &#19977;&#20010;&#21629;&#20196;&#12290;

&#22914;&#26524; key &#19981;&#23384;&#22312;&#65292;&#19968;&#20010;&#31354;&#21015;&#34920;&#20250;&#34987;&#21019;&#24314;&#24182;&#25191;&#34892; LPUSH &#25805;&#20316;&#12290;
&#24403; key &#23384;&#22312;&#20294;&#19981;&#26159;&#21015;&#34920;&#31867;&#22411;&#26102;&#65292;&#36820;&#22238;&#19968;&#20010;&#38169;&#35823;&#12290;

RPUSH key value [value &#8230;]
&#26102;&#38388;&#22797;&#26434;&#24230;&#65306; O(1)
&#23558;&#19968;&#20010;&#25110;&#22810;&#20010;&#20540; value &#25554;&#20837;&#21040;&#21015;&#34920; key &#30340;&#34920;&#23614;(&#26368;&#21491;&#36793;)&#12290;

&#22914;&#26524;&#26377;&#22810;&#20010; value &#20540;&#65292;&#37027;&#20040;&#21508;&#20010; value &#20540;&#25353;&#20174;&#24038;&#21040;&#21491;&#30340;&#39034;&#24207;&#20381;&#27425;&#25554;&#20837;&#21040;&#34920;&#23614;&#65306;&#27604;&#22914;&#23545;&#19968;&#20010;&#31354;&#21015;&#34920;mylist &#25191;&#34892; RPUSH mylist a b c &#65292;&#24471;&#20986;&#30340;&#32467;&#26524;&#21015;&#34920;&#20026; a b c &#65292;&#31561;&#21516;&#20110;&#25191;&#34892;&#21629;&#20196; RPUSH mylist
a &#12289; RPUSH mylist b &#12289; RPUSH mylist c &#12290;

&#22914;&#26524; key &#19981;&#23384;&#22312;&#65292;&#19968;&#20010;&#31354;&#21015;&#34920;&#20250;&#34987;&#21019;&#24314;&#24182;&#25191;&#34892; RPUSH &#25805;&#20316;&#12290;
&#24403; key &#23384;&#22312;&#20294;&#19981;&#26159;&#21015;&#34920;&#31867;&#22411;&#26102;&#65292;&#36820;&#22238;&#19968;&#20010;&#38169;&#35823;&#12290;
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#24038;&#36793;&#28155;&#21152;&#25968;&#25454;&#65292;&#24050;&#28155;&#21152;&#30340;&#38656;&#21521;&#21491;&#31227;</span>
127.0.0.1:6379&gt; LPUSH name kobe bryant rose <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26681;&#25454;&#39034;&#24207;&#36880;&#20010;&#20889;&#20837;name&#65292;&#26368;&#21518;&#30340;rose&#20250;&#22312;&#21015;&#34920;&#30340;&#26368;&#21491;&#20391;</span>
(integer) 3
127.0.0.1:6379&gt; TYPE name
list

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#21491;&#36793;&#28155;&#21152;&#25968;&#25454;</span>
127.0.0.1:6379&gt; RPUSH course linux python go
(integer) 3
127.0.0.1:6379&gt; TYPE course
list
</pre>
</div>
</div>
</div>
<div id="outline-container-h:189f22ea-4fc7-47e1-a4b1-c980de04183f" class="outline-5">
<h5 id="h:189f22ea-4fc7-47e1-a4b1-c980de04183f">向列表追加数据</h5>
<div class="outline-text-5" id="text-h:189f22ea-4fc7-47e1-a4b1-c980de04183f">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; LPUSH name bob
(integer) 4
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#21491;&#36793;&#28155;&#21152;&#25968;&#25454;&#65292;&#24050;&#28155;&#21152;&#30340;&#21521;&#24038;&#31227;</span>
127.0.0.1:6379&gt; RPUSH name tom
(integer) 5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8e5cf94c-0be1-4936-8a61-f7c38813723e" class="outline-5">
<h5 id="h:8e5cf94c-0be1-4936-8a61-f7c38813723e">获取列表长度(元素个数)</h5>
<div class="outline-text-5" id="text-h:8e5cf94c-0be1-4936-8a61-f7c38813723e">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; LLEN name
(integer) 5
127.0.0.1:6379&gt; LLEN course
(integer) 3
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3f03c2ef-dbda-497e-be22-aa687587de5f" class="outline-5">
<h5 id="h:3f03c2ef-dbda-497e-be22-aa687587de5f">获取列表指定位置数据</h5>
<div class="outline-text-5" id="text-h:3f03c2ef-dbda-497e-be22-aa687587de5f">

<figure id="orge8fe7f1">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/202010222236314.png" alt="202010222236314.png">

</figure>


<figure id="org046f9d6">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022223657812.png" alt="20201022223657812.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; LPUSH list1 a b c d
(integer) 4
127.0.0.1:6379&gt; LINDEX list1 0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;0&#32534;&#21495;&#30340;&#20803;&#32032;</span>
<span style="color: #8b2252;">"d"</span>
127.0.0.1:6379&gt; LINDEX list1 3 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;3&#32534;&#21495;&#30340;&#20803;&#32032;</span>
<span style="color: #8b2252;">"a"</span>
127.0.0.1:6379&gt; LINDEX list1 -1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#26368;&#21518;&#19968;&#20010;&#30340;&#20803;&#32032;</span>
<span style="color: #8b2252;">"a"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20803;&#32032;&#20174;0&#24320;&#22987;&#32534;&#21495;</span>
127.0.0.1:6379&gt; LPUSH list1 a b c d
(integer) 4
127.0.0.1:6379&gt; LRANGE list1 1 2
1) <span style="color: #8b2252;">"c"</span>
2) <span style="color: #8b2252;">"b"</span>
127.0.0.1:6379&gt; LRANGE list1 0 3 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#20803;&#32032;</span>
1) <span style="color: #8b2252;">"d"</span>
2) <span style="color: #8b2252;">"c"</span>
3) <span style="color: #8b2252;">"b"</span>
4) <span style="color: #8b2252;">"a"</span>
127.0.0.1:6379&gt; LRANGE list1 0 -1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#20803;&#32032;</span>
1) <span style="color: #8b2252;">"d"</span>
2) <span style="color: #8b2252;">"c"</span>
3) <span style="color: #8b2252;">"b"</span>
4) <span style="color: #8b2252;">"a"</span>

127.0.0.1:6379&gt; RPUSH list2 zhang wang li zhao
(integer) 4
127.0.0.1:6379&gt; LRANGE list2 1 2 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#33539;&#22260;</span>
1) <span style="color: #8b2252;">"wang"</span>
2) <span style="color: #8b2252;">"li"</span>
127.0.0.1:6379&gt; LRANGE list2 2 2 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#20301;&#32622;</span>
1) <span style="color: #8b2252;">"li"</span>
127.0.0.1:6379&gt; LRANGE list2 0 -1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#20803;&#32032;</span>
1) <span style="color: #8b2252;">"zhang"</span>
2) <span style="color: #8b2252;">"wang"</span>
3) <span style="color: #8b2252;">"li"</span>
4) <span style="color: #8b2252;">"zhao"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b13186bd-24e5-4130-9e73-32ed30fb92d1" class="outline-5">
<h5 id="h:b13186bd-24e5-4130-9e73-32ed30fb92d1">修改列表指定索引值</h5>
<div class="outline-text-5" id="text-h:b13186bd-24e5-4130-9e73-32ed30fb92d1">

<figure id="org77fe583">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022224144215.png" alt="20201022224144215.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; RPUSH listkey a b c d e f
(integer) 6
127.0.0.1:6379&gt; lrange listkey 0 -1
1) <span style="color: #8b2252;">"a"</span>
2) <span style="color: #8b2252;">"b"</span>
3) <span style="color: #8b2252;">"c"</span>
4) <span style="color: #8b2252;">"d"</span>
5) <span style="color: #8b2252;">"e"</span>
6) <span style="color: #8b2252;">"f"</span>
127.0.0.1:6379&gt; lset listkey 2 java
OK
127.0.0.1:6379&gt; lrange listkey 0 -1
1) <span style="color: #8b2252;">"a"</span>
2) <span style="color: #8b2252;">"b"</span>
3) <span style="color: #8b2252;">"java"</span>
4) <span style="color: #8b2252;">"d"</span>
5) <span style="color: #8b2252;">"e"</span>
6) <span style="color: #8b2252;">"f"</span>
127.0.0.1:6379&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:72ffedc3-cc8d-40b3-9209-1a16ed7cbdd3" class="outline-5">
<h5 id="h:72ffedc3-cc8d-40b3-9209-1a16ed7cbdd3">移除列表数据</h5>
<div class="outline-text-5" id="text-h:72ffedc3-cc8d-40b3-9209-1a16ed7cbdd3">

<figure id="org08c31b0">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022224247365.png" alt="20201022224247365.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; LPUSH list1 a b c d
(integer) 4
127.0.0.1:6379&gt; LRANGE list1 0 3
1) <span style="color: #8b2252;">"d"</span>
2) <span style="color: #8b2252;">"c"</span>
3) <span style="color: #8b2252;">"b"</span>
4) <span style="color: #8b2252;">"a"</span>
127.0.0.1:6379&gt; LPOP list1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24377;&#20986;&#24038;&#36793;&#31532;&#19968;&#20010;&#20803;&#32032;&#65292;&#21363;&#21024;&#38500;&#31532;&#19968;&#20010;</span>
<span style="color: #8b2252;">"d"</span>
127.0.0.1:6379&gt; LLEN list1
(integer) 3
127.0.0.1:6379&gt; LRANGE list1 0 2
1) <span style="color: #8b2252;">"c"</span>
2) <span style="color: #8b2252;">"b"</span>
3) <span style="color: #8b2252;">"a"</span>
127.0.0.1:6379&gt; RPOP list1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24377;&#20986;&#21491;&#36793;&#31532;&#19968;&#20010;&#20803;&#32032;&#65292;&#21363;&#21024;&#38500;&#26368;&#21518;&#19968;&#20010;</span>
<span style="color: #8b2252;">"a"</span>
127.0.0.1:6379&gt; LLEN list1
(integer) 2
127.0.0.1:6379&gt; LRANGE list1 0 1
1) <span style="color: #8b2252;">"c"</span>
2) <span style="color: #8b2252;">"b"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">LTRIM &#23545;&#19968;&#20010;&#21015;&#34920;&#36827;&#34892;&#20462;&#21098;(trim)&#65292;&#35753;&#21015;&#34920;&#21482;&#20445;&#30041;&#25351;&#23450;&#21306;&#38388;&#20869;&#30340;&#20803;&#32032;&#65292;&#19981;&#22312;&#25351;&#23450;&#21306;&#38388;&#20043;&#20869;&#30340;&#20803;&#32032;&#37117;&#23558;&#34987;&#21024;&#38500;</span>
127.0.0.1:6379&gt; LLEN list1
(integer) 4
127.0.0.1:6379&gt; LRANGE list1 0 3
1) <span style="color: #8b2252;">"d"</span>
2) <span style="color: #8b2252;">"c"</span>
3) <span style="color: #8b2252;">"b"</span>
4) <span style="color: #8b2252;">"a"</span>
127.0.0.1:6379&gt; LTRIM list1 1 2 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#20445;&#30041;1&#65292;2&#21495;&#20803;&#32032;</span>
OK
127.0.0.1:6379&gt; LLEN list1
(integer) 2
127.0.0.1:6379&gt; LRANGE list1 0 1
1) <span style="color: #8b2252;">"c"</span>
2) <span style="color: #8b2252;">"b"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;list</span>
127.0.0.1:6379&gt; DEL list1
(integer) 1
127.0.0.1:6379&gt; EXISTS list1
(integer) 0
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:da24f22f-8890-49da-84a5-ea3261cbb4a8" class="outline-4">
<h4 id="h:da24f22f-8890-49da-84a5-ea3261cbb4a8">集合 set</h4>
<div class="outline-text-4" id="text-h:da24f22f-8890-49da-84a5-ea3261cbb4a8">

<figure id="org94f27b6">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201022224557922.png" alt="20201022224557922.png">

</figure>

<p>
Set 是 String类型的无序集合，集合中的成员是唯一的，这就意味着集合中不
能出现重复的数据，可以在两个不同的集合中对数据进行对比并取值，常用于取
值判断，统计，交集等场景
</p>

<p>
集合特点：
</p>

<ul class="org-ul">
<li>无序</li>
<li>无重复</li>
<li>集合间操作</li>
</ul>
</div>
<div id="outline-container-h:0a852c43-393b-4513-bf72-c3b610132a36" class="outline-5">
<h5 id="h:0a852c43-393b-4513-bf72-c3b610132a36">生成集合key</h5>
<div class="outline-text-5" id="text-h:0a852c43-393b-4513-bf72-c3b610132a36">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; SADD set1 v1
(integer) 1
127.0.0.1:6379&gt; SADD set2 v2 v3
(integer) 2
127.0.0.1:6379&gt; TYPE set1
<span style="color: #483d8b;">set</span>
127.0.0.1:6379&gt; TYPE set2
<span style="color: #483d8b;">set</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e32451c0-93c6-4444-b0d1-6b48069aee61" class="outline-5">
<h5 id="h:e32451c0-93c6-4444-b0d1-6b48069aee61">追加数值</h5>
<div class="outline-text-5" id="text-h:e32451c0-93c6-4444-b0d1-6b48069aee61">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36861;&#21152;&#26102;&#65292;&#21482;&#33021;&#36861;&#21152;&#19981;&#23384;&#22312;&#30340;&#25968;&#25454;&#65292;&#19981;&#33021;&#36861;&#21152;&#24050;&#32463;&#23384;&#22312;&#30340;&#25968;&#25454;</span>
127.0.0.1:6379&gt; SADD set1 v1    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24050;&#23384;&#22312;&#30340;&#20540;&#65292;&#26080;&#27861;&#20877;&#27425;&#28155;&#21152;</span>
(integer) 0
127.0.0.1:6379&gt; SADD set1 v3 v4 v5
(integer) 3
</pre>
</div>
</div>
</div>
<div id="outline-container-h:60d1d78c-46a2-493a-967a-9feff06cdf39" class="outline-5">
<h5 id="h:60d1d78c-46a2-493a-967a-9feff06cdf39">查看集合的所有数据</h5>
<div class="outline-text-5" id="text-h:60d1d78c-46a2-493a-967a-9feff06cdf39">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; SMEMBERS set1
1) <span style="color: #8b2252;">"v4"</span>
2) <span style="color: #8b2252;">"v3"</span>
3) <span style="color: #8b2252;">"v1"</span>
4) <span style="color: #8b2252;">"v2"</span>
5) <span style="color: #8b2252;">"v5"</span>
127.0.0.1:6379&gt; SMEMBERS set2
1) <span style="color: #8b2252;">"v3"</span>
2) <span style="color: #8b2252;">"v2"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4a617feb-d8ba-4320-a49d-3bfdc3e4ccba" class="outline-5">
<h5 id="h:4a617feb-d8ba-4320-a49d-3bfdc3e4ccba">删除集合中的元素</h5>
<div class="outline-text-5" id="text-h:4a617feb-d8ba-4320-a49d-3bfdc3e4ccba">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; SADD goods mobile car laptop
(integer) 3
127.0.0.1:6379&gt; SREM goods car
(integer) 1
127.0.0.1:6379&gt; SMEMBERS goods
1) <span style="color: #8b2252;">"laptop"</span>
2) <span style="color: #8b2252;">"mobile"</span>
</pre>
</div>

<p>
<b>集合见操作</b>
</p>


<figure id="orgc10946a">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201023202652854.png" alt="20201023202652854.png">

</figure>
</div>
</div>
<div id="outline-container-h:60ba95bb-0fa3-4e1a-86b4-39e0654792bc" class="outline-5">
<h5 id="h:60ba95bb-0fa3-4e1a-86b4-39e0654792bc">获取集合的交集</h5>
<div class="outline-text-5" id="text-h:60ba95bb-0fa3-4e1a-86b4-39e0654792bc">
<p>
交集：已属于A且属于B的元素称为A与B的交集
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; SMEMBERS set1
1) <span style="color: #8b2252;">"v4"</span>
2) <span style="color: #8b2252;">"v2"</span>
3) <span style="color: #8b2252;">"v5"</span>
4) <span style="color: #8b2252;">"v3"</span>
127.0.0.1:6379&gt; SMEMBERS set2
1) <span style="color: #8b2252;">"v6"</span>
2) <span style="color: #8b2252;">"v3"</span>
3) <span style="color: #8b2252;">"v2"</span>
127.0.0.1:6379&gt; SINTER set1 set2
1) <span style="color: #8b2252;">"v3"</span>
2) <span style="color: #8b2252;">"v2"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5e730d5a-63a9-4de4-9737-cfb2374631e0" class="outline-5">
<h5 id="h:5e730d5a-63a9-4de4-9737-cfb2374631e0">获取集合的并集</h5>
<div class="outline-text-5" id="text-h:5e730d5a-63a9-4de4-9737-cfb2374631e0">
<p>
并集：已属于A或属于B的元素称为A与B的并集
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; SMEMBERS set1
1) <span style="color: #8b2252;">"v4"</span>
2) <span style="color: #8b2252;">"v2"</span>
3) <span style="color: #8b2252;">"v5"</span>
4) <span style="color: #8b2252;">"v3"</span>
127.0.0.1:6379&gt; SMEMBERS set2
1) <span style="color: #8b2252;">"v6"</span>
2) <span style="color: #8b2252;">"v3"</span>
3) <span style="color: #8b2252;">"v2"</span>
127.0.0.1:6379&gt; SUNION set1 set2
1) <span style="color: #8b2252;">"v5"</span>
2) <span style="color: #8b2252;">"v4"</span>
3) <span style="color: #8b2252;">"v2"</span>
4) <span style="color: #8b2252;">"v3"</span>
5) <span style="color: #8b2252;">"v6"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:801bf88b-24da-402b-83e6-13c2a0a32ff8" class="outline-5">
<h5 id="h:801bf88b-24da-402b-83e6-13c2a0a32ff8">获取集合的差集</h5>
<div class="outline-text-5" id="text-h:801bf88b-24da-402b-83e6-13c2a0a32ff8">
<p>
差集：已属于A而不属于B的元素称为A与B的差（集）
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; SMEMBERS set1
1) <span style="color: #8b2252;">"v4"</span>
2) <span style="color: #8b2252;">"v2"</span>
3) <span style="color: #8b2252;">"v5"</span>
4) <span style="color: #8b2252;">"v3"</span>
127.0.0.1:6379&gt; SMEMBERS set2
1) <span style="color: #8b2252;">"v6"</span>
2) <span style="color: #8b2252;">"v3"</span>
3) <span style="color: #8b2252;">"v2"</span>
127.0.0.1:6379&gt; SDIFF set1 set2
1) <span style="color: #8b2252;">"v4"</span>
2) <span style="color: #8b2252;">"v5"</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:7f8481ff-0ab1-4d1c-9d95-219b6e2bf04a" class="outline-4">
<h4 id="h:7f8481ff-0ab1-4d1c-9d95-219b6e2bf04a">有序集合 sorted set</h4>
<div class="outline-text-4" id="text-h:7f8481ff-0ab1-4d1c-9d95-219b6e2bf04a">
<p>
Redis有序集合和集合一样也是string类型元素的集合,且不允许重复的成员，不
同的是每个元素都会关联一个double(双精度浮点型)类型的分数，redis正是通
过该分数来为集合中的成员进行从小到大的排序，有序集合的成员是唯一的,但
分数(score)却可以重复，集合是通过哈希表实现的，所以添加，删除，查找的
复杂度都是O(1)，集合中最大的成员数为 2^32 - 1 (4294967295,每个集合可存
储40多亿个成员)，经常用于排行榜的场景
</p>


<figure id="orge7b7122">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201023220813648.png" alt="20201023220813648.png">

</figure>

<p>
有序集合特点：
</p>

<ul class="org-ul">
<li>有序</li>
<li>无重复元素</li>
<li>每个元素是由score和value组成</li>
<li>score 可以重复</li>
<li>value 不可以重复</li>
</ul>
</div>
<div id="outline-container-h:8c7261c7-30bc-46a2-a0ce-b5773d3cfe27" class="outline-5">
<h5 id="h:8c7261c7-30bc-46a2-a0ce-b5773d3cfe27">生成有序集合</h5>
<div class="outline-text-5" id="text-h:8c7261c7-30bc-46a2-a0ce-b5773d3cfe27">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; ZADD zset1 1 v1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#25968;&#20026;1</span>
(integer) 1
127.0.0.1:6379&gt; ZADD zset1 2 v2
(integer) 1
127.0.0.1:6379&gt; ZADD zset1 2 v3 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#25968;&#21487;&#37325;&#22797;&#65292;&#20803;&#32032;&#20540;&#19981;&#21487;&#20197;&#37325;&#22797;</span>
(integer) 1
127.0.0.1:6379&gt; ZADD zset1 3 v4
(integer) 1
127.0.0.1:6379&gt; TYPE zset1
zset
127.0.0.1:6379&gt; TYPE zset2
zset

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#27425;&#29983;&#25104;&#22810;&#20010;&#25968;&#25454;&#65306;</span>
127.0.0.1:6379&gt; ZADD zset2 1 v1 2 v2 3 v3 4 v4 5 v5
(integer) 5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:39ac203a-1a72-4a85-a896-82f54152cac8" class="outline-5">
<h5 id="h:39ac203a-1a72-4a85-a896-82f54152cac8">有序集合实现排行榜</h5>
<div class="outline-text-5" id="text-h:39ac203a-1a72-4a85-a896-82f54152cac8">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; ZADD paihangbang 90 nezha 99 zhanlang 60 zhuluoji 30 gangtiexia
(integer) 4
127.0.0.1:6379&gt; ZRANGE panghangbang 0 -1
(empty list or set)
127.0.0.1:6379&gt; ZRANGE paihangbang 0 -1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27491;&#24207;&#25490;&#24207;&#21518;&#26174;&#31034;&#38598;&#21512;&#20869;&#25152;&#26377;&#30340;key&#65292;score&#20174;&#23567;&#21040;&#22823;&#26174;&#31034;</span>
1) <span style="color: #8b2252;">"gangtiexia"</span>
2) <span style="color: #8b2252;">"zhuluoji"</span>
3) <span style="color: #8b2252;">"nezha"</span>
4) <span style="color: #8b2252;">"zhanlang"</span>
127.0.0.1:6379&gt; ZREVRANGE paihangbang 0 -1  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20498;&#21465;&#25490;&#24207;&#21518;&#26174;&#31034;&#38598;&#21512;&#20869;&#25152;&#26377;&#30340;key&#65292;score&#20174;&#22823;&#21040;&#23567;&#26174;&#31034;</span>
1) <span style="color: #8b2252;">"zhanlang"</span>
2) <span style="color: #8b2252;">"nezha"</span>
3) <span style="color: #8b2252;">"zhuluoji"</span>
4) <span style="color: #8b2252;">"gangtiexia"</span>
127.0.0.1:6379&gt; ZRANGE paihangbang 0 -1 withscores  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27491;&#24207;&#26174;&#31034;&#25351;&#23450;&#38598;&#21512;&#20869;&#25152;&#26377;key&#21644;&#24471;&#20998;&#24773;&#20917;</span>
1) <span style="color: #8b2252;">"gangtiexia"</span>
2) <span style="color: #8b2252;">"30"</span>
3) <span style="color: #8b2252;">"zhuluoji"</span>
4) <span style="color: #8b2252;">"60"</span>
5) <span style="color: #8b2252;">"nezha"</span>
6) <span style="color: #8b2252;">"90"</span>
7) <span style="color: #8b2252;">"zhanlang"</span>
8) <span style="color: #8b2252;">"99"</span>
127.0.0.1:6379&gt; ZREVRANGE paihangbang 0 -1 withscores   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20498;&#21465;&#26174;&#31034;&#25351;&#23450;&#38598;&#21512;&#20869;&#25152;&#26377;key&#21644;&#24471;&#20998;&#24773;&#20917;</span>
1) <span style="color: #8b2252;">"zhanlang"</span>
2) <span style="color: #8b2252;">"99"</span>
3) <span style="color: #8b2252;">"nezha"</span>
4) <span style="color: #8b2252;">"90"</span>
5) <span style="color: #8b2252;">"zhuluoji"</span>
6) <span style="color: #8b2252;">"60"</span>
7) <span style="color: #8b2252;">"gangtiexia"</span>
8) <span style="color: #8b2252;">"30"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ee3c5aec-4409-494a-961a-d2fafd4c70ea" class="outline-5">
<h5 id="h:ee3c5aec-4409-494a-961a-d2fafd4c70ea">获取集合的个数</h5>
<div class="outline-text-5" id="text-h:ee3c5aec-4409-494a-961a-d2fafd4c70ea">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; ZCARD paihangbang
(integer) 4
127.0.0.1:6379&gt; ZCARD zset
(integer) 4
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2ffa94f0-f80e-4aab-a0d7-5bd0c5690d59" class="outline-5">
<h5 id="h:2ffa94f0-f80e-4aab-a0d7-5bd0c5690d59">基于索引返回数值</h5>
<div class="outline-text-5" id="text-h:2ffa94f0-f80e-4aab-a0d7-5bd0c5690d59">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; ZRANGE paihangbang 0 2
1) <span style="color: #8b2252;">"gangtiexia"</span>
2) <span style="color: #8b2252;">"zhuluoji"</span>
3) <span style="color: #8b2252;">"nezha"</span>
127.0.0.1:6379&gt; ZRANGE paihangbang 0 10 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36229;&#20986;&#33539;&#22260;&#19981;&#25253;&#38169;</span>
1) <span style="color: #8b2252;">"gangtiexia"</span>
2) <span style="color: #8b2252;">"zhuluoji"</span>
3) <span style="color: #8b2252;">"nezha"</span>
4) <span style="color: #8b2252;">"zhanlang"</span>
127.0.0.1:6379&gt; ZRANGE zset 1 3
1) <span style="color: #8b2252;">"v2"</span>
2) <span style="color: #8b2252;">"v3"</span>
3) <span style="color: #8b2252;">"v4"</span>
127.0.0.1:6379&gt; ZRANGE zset 0 2
1) <span style="color: #8b2252;">"v1"</span>
2) <span style="color: #8b2252;">"v2"</span>
3) <span style="color: #8b2252;">"v3"</span>
127.0.0.1:6379&gt; ZRANGE zset 2 2
1) <span style="color: #8b2252;">"v3"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c73173ea-1c3e-4547-abee-4ac3f0886de1" class="outline-5">
<h5 id="h:c73173ea-1c3e-4547-abee-4ac3f0886de1">返回某个数值的索引(排名)</h5>
<div class="outline-text-5" id="text-h:c73173ea-1c3e-4547-abee-4ac3f0886de1">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; ZADD paihangbang 90 nezha 99 zhanlang 60 zhuluoji 30 gangtiexia
(integer) 4
127.0.0.1:6379&gt; ZRANGE paihangbang 0 -1
1) <span style="color: #8b2252;">"gangtiexia"</span>
2) <span style="color: #8b2252;">"zhuluoji"</span>
3) <span style="color: #8b2252;">"nezha"</span>
4) <span style="color: #8b2252;">"zhanlang"</span>
127.0.0.1:6379&gt; ZRANK paihangbang zhanlang
(integer) 3 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#31532;4&#20010;</span>
127.0.0.1:6379&gt; ZRANK paihangbang zhuluoji
(integer) 1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#31532;2&#20010;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8d08dedb-a72b-4624-a953-78bdf434cd90" class="outline-5">
<h5 id="h:8d08dedb-a72b-4624-a953-78bdf434cd90">获取分数</h5>
<div class="outline-text-5" id="text-h:8d08dedb-a72b-4624-a953-78bdf434cd90">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; ZSCORE paihangbang zhuluoji
<span style="color: #8b2252;">"60"</span>
127.0.0.1:6379&gt; ZSCORE paihangbang nezha
<span style="color: #8b2252;">"90"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3f5837ca-b849-412c-9f83-0d742b36c290" class="outline-5">
<h5 id="h:3f5837ca-b849-412c-9f83-0d742b36c290">删除元素</h5>
<div class="outline-text-5" id="text-h:3f5837ca-b849-412c-9f83-0d742b36c290">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; ZADD paihangbang 90 nezha 199 zhanlang 60 zhuluoji 30 gangtiexia
(integer) 4
127.0.0.1:6379&gt; ZRANGE paihangbang 0 -1
1) <span style="color: #8b2252;">"gangtiexia"</span>
2) <span style="color: #8b2252;">"zhuluoji"</span>
3) <span style="color: #8b2252;">"nezha"</span>
4) <span style="color: #8b2252;">"zhanlang"</span>
127.0.0.1:6379&gt; ZREM paihangbang zhuluoji nezha
(integer) 2
127.0.0.1:6379&gt; ZRANGE paihangbang 0 -1
1) <span style="color: #8b2252;">"gangtiexia"</span>
2) <span style="color: #8b2252;">"zhanlang"</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:6947339f-4ea1-4095-bd97-03e71e2362dd" class="outline-4">
<h4 id="h:6947339f-4ea1-4095-bd97-03e71e2362dd">哈希 hash</h4>
<div class="outline-text-4" id="text-h:6947339f-4ea1-4095-bd97-03e71e2362dd">
<p>
hash 是一个string类型的字段(field)和值(value)的映射表，Redis 中每个
hash可以存储 2^32 -1 键值对，类似于字典，存放了多个k/v对，hash特别适合
用于存储对象场景
</p>


<figure id="orgd2f44b2">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024092247296.png" alt="20201024092247296.png">

</figure>


<figure id="orga5d0401">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024092318913.png" alt="20201024092318913.png">

</figure>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">命令</th>
<th scope="col" class="org-left">复杂度</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">hget hset hdel</td>
<td class="org-left">o(1)</td>
</tr>

<tr>
<td class="org-left">hexists</td>
<td class="org-left">o(1)</td>
</tr>

<tr>
<td class="org-left">hincrby</td>
<td class="org-left">o(1)</td>
</tr>

<tr>
<td class="org-left">hgetall hvals hkeys</td>
<td class="org-left">o(n)</td>
</tr>

<tr>
<td class="org-left">hmget hmset</td>
<td class="org-left">o(n)</td>
</tr>
</tbody>
</table>
</div>
<div id="outline-container-h:04fb2815-7ab7-4b12-bbac-e222e01f12ef" class="outline-5">
<h5 id="h:04fb2815-7ab7-4b12-bbac-e222e01f12ef">生成 hash key</h5>
<div class="outline-text-5" id="text-h:04fb2815-7ab7-4b12-bbac-e222e01f12ef">
<p>
格式：
</p>

<div class="org-src-container">
<pre class="src src-sh">HSET hash field value
&#26102;&#38388;&#22797;&#26434;&#24230;&#65306; O(1)
&#23558;&#21704;&#24076;&#34920; hash &#20013;&#22495; field &#30340;&#20540;&#35774;&#32622;&#20026; value &#12290;

&#22914;&#26524;&#32473;&#23450;&#30340;&#21704;&#24076;&#34920;&#24182;&#19981;&#23384;&#22312;&#65292; &#37027;&#20040;&#19968;&#20010;&#26032;&#30340;&#21704;&#24076;&#34920;&#23558;&#34987;&#21019;&#24314;&#24182;&#25191;&#34892; HSET &#25805;&#20316;&#12290;
&#22914;&#26524;&#22495; field &#24050;&#32463;&#23384;&#22312;&#20110;&#21704;&#24076;&#34920;&#20013;&#65292; &#37027;&#20040;&#23427;&#30340;&#26087;&#20540;&#23558;&#34987;&#26032;&#20540; value &#35206;&#30422;&#12290;
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; HSET 9527 name zhouxingxing age 20
(integer) 2
127.0.0.1:6379&gt; type 9527
<span style="color: #483d8b;">hash</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25152;&#26377;&#23383;&#27573;&#30340;&#20540;</span>
127.0.0.1:6379&gt; HGETALL 9527
1) <span style="color: #8b2252;">"name"</span>
2) <span style="color: #8b2252;">"zhouxingxing"</span>
3) <span style="color: #8b2252;">"age"</span>
4) <span style="color: #8b2252;">"20"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22686;&#21152;&#23383;&#27573;</span>
127.0.0.1:6379&gt; HSET 9527 gender male
(integer) 1
127.0.0.1:6379&gt; HGETALL 9527
1) <span style="color: #8b2252;">"name"</span>
2) <span style="color: #8b2252;">"zhouxingxing"</span>
3) <span style="color: #8b2252;">"age"</span>
4) <span style="color: #8b2252;">"20"</span>
5) <span style="color: #8b2252;">"gender"</span>
6) <span style="color: #8b2252;">"male"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:910a4c70-7c5e-4855-95e5-29429775db68" class="outline-5">
<h5 id="h:910a4c70-7c5e-4855-95e5-29429775db68">获取hash key的对应字段的值</h5>
<div class="outline-text-5" id="text-h:910a4c70-7c5e-4855-95e5-29429775db68">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; HGET 9527 name
<span style="color: #8b2252;">"zhouxingxing"</span>
127.0.0.1:6379&gt; HGET 9527 age
<span style="color: #8b2252;">"20"</span>

127.0.0.1:6379&gt; HMGET 9527 age gender   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#22810;&#20010;&#20540;</span>
1) <span style="color: #8b2252;">"20"</span>
2) <span style="color: #8b2252;">"male"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c1cda36e-0d91-4695-8963-eaa7f302bd25" class="outline-5">
<h5 id="h:c1cda36e-0d91-4695-8963-eaa7f302bd25">删除一个hash key 的对应字段</h5>
<div class="outline-text-5" id="text-h:c1cda36e-0d91-4695-8963-eaa7f302bd25">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; HDEL 9527 age
(integer) 1
127.0.0.1:6379&gt; HGET 9527 age
(nil)

127.0.0.1:6379&gt; HGETALL 9527
1) <span style="color: #8b2252;">"name"</span>
2) <span style="color: #8b2252;">"zhouxingxing"</span>
3) <span style="color: #8b2252;">"gender"</span>
4) <span style="color: #8b2252;">"male"</span>

127.0.0.1:6379&gt; HGET 9527 name
<span style="color: #8b2252;">"zhouxingxing"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:025b0adb-b8b1-44d9-a37b-8e92ead535b9" class="outline-5">
<h5 id="h:025b0adb-b8b1-44d9-a37b-8e92ead535b9">批量设置hash key的多个field和value</h5>
<div class="outline-text-5" id="text-h:025b0adb-b8b1-44d9-a37b-8e92ead535b9">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; HMSET 1024 name chenglong age 60 city hongkong
OK
127.0.0.1:6379&gt; HGETALL 1024
1) <span style="color: #8b2252;">"name"</span>
2) <span style="color: #8b2252;">"chenglong"</span>
3) <span style="color: #8b2252;">"age"</span>
4) <span style="color: #8b2252;">"60"</span>
5) <span style="color: #8b2252;">"city"</span>
6) <span style="color: #8b2252;">"hongkong"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c622abf9-8ec8-410a-904b-25a6232b19c7" class="outline-5">
<h5 id="h:c622abf9-8ec8-410a-904b-25a6232b19c7">获取hash中指定字段的值</h5>
<div class="outline-text-5" id="text-h:c622abf9-8ec8-410a-904b-25a6232b19c7">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; HMSET 1024 name chenglong age 60 city hongkong
OK
127.0.0.1:6379&gt; HMGET 1024 name city
1) <span style="color: #8b2252;">"chenglong"</span>
2) <span style="color: #8b2252;">"hongkong"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5ef55fde-cdb5-4e18-96da-c03dbe30ee92" class="outline-5">
<h5 id="h:5ef55fde-cdb5-4e18-96da-c03dbe30ee92">获取hash中的所有字段名field</h5>
<div class="outline-text-5" id="text-h:5ef55fde-cdb5-4e18-96da-c03dbe30ee92">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; HMSET 1024 name chenglong age 60 city hongkong
OK
127.0.0.1:6379&gt; HKEYS 1024
1) <span style="color: #8b2252;">"name"</span>
2) <span style="color: #8b2252;">"age"</span>
3) <span style="color: #8b2252;">"city"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:23831255-4e21-4f29-9136-10049cd20941" class="outline-5">
<h5 id="h:23831255-4e21-4f29-9136-10049cd20941">获取hash key对应所有field的value</h5>
<div class="outline-text-5" id="text-h:23831255-4e21-4f29-9136-10049cd20941">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; HMSET 1024 name chenglong age 60 city hongkong
OK
127.0.0.1:6379&gt; HVALS 1024
1) <span style="color: #8b2252;">"chenglong"</span>
2) <span style="color: #8b2252;">"60"</span>
3) <span style="color: #8b2252;">"hongkong"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a147ea57-372f-40ce-afa6-9547818f9545" class="outline-5">
<h5 id="h:a147ea57-372f-40ce-afa6-9547818f9545">获取指定hash key 的所有field及value</h5>
<div class="outline-text-5" id="text-h:a147ea57-372f-40ce-afa6-9547818f9545">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; HGETALL 1024
1) <span style="color: #8b2252;">"name"</span>
2) <span style="color: #8b2252;">"chenglong"</span>
3) <span style="color: #8b2252;">"age"</span>
4) <span style="color: #8b2252;">"60"</span>
5) <span style="color: #8b2252;">"city"</span>
6) <span style="color: #8b2252;">"hongkong"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ebb88f9e-c57f-4b67-8253-20bf2085da60" class="outline-5">
<h5 id="h:ebb88f9e-c57f-4b67-8253-20bf2085da60">删除 hash</h5>
<div class="outline-text-5" id="text-h:ebb88f9e-c57f-4b67-8253-20bf2085da60">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; DEL 1024
(integer) 1
127.0.0.1:6379&gt; HMGET 1024 name age
1) (nil)
2) (nil)
127.0.0.1:6379&gt; EXISTS 1024
(integer) 0
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:483f5a95-1e22-4b62-8e95-aaaf8f1bb2c6" class="outline-3">
<h3 id="h:483f5a95-1e22-4b62-8e95-aaaf8f1bb2c6">消息队列</h3>
<div class="outline-text-3" id="text-h:483f5a95-1e22-4b62-8e95-aaaf8f1bb2c6">
<p>
消息队列: 把要传输的数据放在队列中
</p>

<p>
功能: 可以实现多个系统之间的解耦,异步,削峰/限流等
</p>

<p>
常用的消息队列应用: kafka,rabbitMQ,redis
</p>


<figure id="org5396718">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024095116132.png" alt="20201024095116132.png">

</figure>

<p>
消息队列主要分为两种,这两种模式Redis都支持
</p>

<ul class="org-ul">
<li>生产者/消费者模式</li>
<li>发布者/订阅者模式</li>
</ul>
</div>
<div id="outline-container-h:1ff21188-db73-4e9b-b789-23494c752177" class="outline-4">
<h4 id="h:1ff21188-db73-4e9b-b789-23494c752177">生产者消费者模式</h4>
<div class="outline-text-4" id="text-h:1ff21188-db73-4e9b-b789-23494c752177">
<p>
在生产者/消费者(Producer/Consumer)模式下，上层应用接收到的外部请求后开
始处理其当前步骤的操作，在执行完成后将已经完成的操作发送至指定的频道
(channel,逻辑队列)当中，并由其下层的应用监听该频道并继续下一步的操作，
如果其处理完成后没有下一步的操作就直接返回数据给外部请求，如果还有下一
步的操作就再将任务发布到另外一个频道，由另外一个消费者继续监听和处理。
此模式应用广泛
</p>
</div>
<div id="outline-container-h:f8f76eda-73c5-488d-9a4c-1adc16f2e92b" class="outline-5">
<h5 id="h:f8f76eda-73c5-488d-9a4c-1adc16f2e92b">模式介绍</h5>
<div class="outline-text-5" id="text-h:f8f76eda-73c5-488d-9a4c-1adc16f2e92b">
<p>
生产者消费者模式下，多个消费者同时监听一个队列，但是一个消息只能被最先
抢到消息的消费者消费，即消息任务是一次性读取和处理，此模式在分布式业务
架构中很常用，比较常用的消息队列软件还有RabbitMQ、Kafka、RocketMQ、
ActiveMQ等。
</p>


<figure id="org48c8cc4">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024095538243.png" alt="20201024095538243.png">

</figure>
</div>
</div>
<div id="outline-container-h:0cd89e11-5dac-4821-aacf-74cd35e73e5a" class="outline-5">
<h5 id="h:0cd89e11-5dac-4821-aacf-74cd35e73e5a">队列介绍</h5>
<div class="outline-text-5" id="text-h:0cd89e11-5dac-4821-aacf-74cd35e73e5a">
<p>
队列当中的消息由不同的生产者写入，也会有不同的消费者取出进行消费处理，但是一个消息一定是只能被取出一次也就是被消费一次。
</p>


<figure id="org500d14f">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024095739209.png" alt="20201024095739209.png">

</figure>


<figure id="org7cf72b9">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024095751755.png" alt="20201024095751755.png">

</figure>


<figure id="orgca99eba">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024095802499.png" alt="20201024095802499.png">

</figure>
</div>
</div>
<div id="outline-container-h:223586fb-576b-4fc8-b203-ff77abb723dc" class="outline-5">
<h5 id="h:223586fb-576b-4fc8-b203-ff77abb723dc">生产者发布消息</h5>
<div class="outline-text-5" id="text-h:223586fb-576b-4fc8-b203-ff77abb723dc">
<p>
基于列表实现
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@redis ~]# redis-cli
127.0.0.1:6379&gt; AUTH 123456
OK
127.0.0.1:6379&gt; LPUSH channel1 msg1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#31649;&#36947;&#30340;&#24038;&#20391;&#20889;&#20837;</span>
(integer) 1
127.0.0.1:6379&gt; LPUSH channel1 msg2
(integer) 2
127.0.0.1:6379&gt; LPUSH channel1 msg3
(integer) 3
127.0.0.1:6379&gt; LPUSH channel1 msg4
(integer) 4
127.0.0.1:6379&gt; LPUSH channel1 msg5
(integer) 5
</pre>
</div>
</div>
</div>
<div id="outline-container-h:47e03db1-7f5f-4b22-8170-c5863f031731" class="outline-5">
<h5 id="h:47e03db1-7f5f-4b22-8170-c5863f031731">查看队列所有消息</h5>
<div class="outline-text-5" id="text-h:47e03db1-7f5f-4b22-8170-c5863f031731">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; LRANGE channel1 0 -1
1) <span style="color: #8b2252;">"msg5"</span>
2) <span style="color: #8b2252;">"msg4"</span>
3) <span style="color: #8b2252;">"msg3"</span>
4) <span style="color: #8b2252;">"msg2"</span>
5) <span style="color: #8b2252;">"msg1"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:634f139e-e964-4f1e-a080-e7051bbefea9" class="outline-5">
<h5 id="h:634f139e-e964-4f1e-a080-e7051bbefea9">消费者消费消息</h5>
<div class="outline-text-5" id="text-h:634f139e-e964-4f1e-a080-e7051bbefea9">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; RPOP channel1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#31649;&#36947;&#30340;&#21491;&#20391;&#28040;&#36153;&#65292;&#29992;&#20110;&#28040;&#24687;&#30340;&#20808;&#36827;&#20808;&#20986;</span>
<span style="color: #8b2252;">"msg1"</span>
127.0.0.1:6379&gt; RPOP channel1
<span style="color: #8b2252;">"msg2"</span>
127.0.0.1:6379&gt; RPOP channel1
<span style="color: #8b2252;">"msg3"</span>
127.0.0.1:6379&gt; RPOP channel1
<span style="color: #8b2252;">"msg4"</span>
127.0.0.1:6379&gt; RPOP channel1
<span style="color: #8b2252;">"msg5"</span>
127.0.0.1:6379&gt; RPOP channel1
(nil)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:90b12e57-ef87-4d8c-be42-d8e5e1584428" class="outline-5">
<h5 id="h:90b12e57-ef87-4d8c-be42-d8e5e1584428">再次验证队列消息</h5>
<div class="outline-text-5" id="text-h:90b12e57-ef87-4d8c-be42-d8e5e1584428">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; LRANGE channel1 0 -1
(empty list or set)     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38431;&#21015;&#20013;&#30340;&#28040;&#24687;&#24050;&#32463;&#34987;&#24050;&#20840;&#37096;&#28040;&#36153;&#23436;&#27605;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ddd7f6b5-2e22-42db-b8db-702ced268059" class="outline-4">
<h4 id="h:ddd7f6b5-2e22-42db-b8db-702ced268059">发布者订阅模式</h4>
<div class="outline-text-4" id="text-h:ddd7f6b5-2e22-42db-b8db-702ced268059">
</div>
<div id="outline-container-h:3ffb7a1b-abb1-4a97-884d-e57ab33f41d6" class="outline-5">
<h5 id="h:3ffb7a1b-abb1-4a97-884d-e57ab33f41d6">模式简介</h5>
<div class="outline-text-5" id="text-h:3ffb7a1b-abb1-4a97-884d-e57ab33f41d6">
<p>
在发布者订阅者模式下，发布者将消息发布到指定的channel里面，凡是监听该
channel的消费者都会收到同样的一份消息，这种模式类似于是收音机的广播模
式，即凡是收听某个频道的听众都会收到主持人发布的相同的消息内容。此模式
常用于群聊天、群通知、群公告等场景
</p>

<ul class="org-ul">
<li>Publisher：发布者</li>
<li>Subscriber：订阅者</li>
<li>Channel：频道</li>
</ul>


<figure id="orgec4102c">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/2020102410043543.png" alt="2020102410043543.png">

</figure>


<figure id="orgb302d35">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024100446786.png" alt="20201024100446786.png">

</figure>
</div>
</div>
<div id="outline-container-h:2b51f196-25b6-49e1-88f0-67ede54f25b6" class="outline-5">
<h5 id="h:2b51f196-25b6-49e1-88f0-67ede54f25b6">订阅者监听频道</h5>
<div class="outline-text-5" id="text-h:2b51f196-25b6-49e1-88f0-67ede54f25b6">
<div class="org-src-container">
<pre class="src src-sh">[root@redis ~]# redis-cli
127.0.0.1:6379&gt; AUTH 123456
OK
127.0.0.1:6379&gt; SUBSCRIBE channel1      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35746;&#38405;&#32773;&#20107;&#20808;&#35746;&#38405;&#25351;&#23450;&#30340;&#39057;&#36947;&#65292;&#20043;&#21518;&#21457;&#24067;&#30340;&#28040;&#24687;&#25165;&#33021;&#25910;&#21040;</span>
Reading messages... (press Ctrl-C to quit)
1) <span style="color: #8b2252;">"subscribe"</span>
2) <span style="color: #8b2252;">"channel1"</span>
3) (integer) 1
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c6f81158-ab98-4281-b20b-eb4c80c13e9f" class="outline-5">
<h5 id="h:c6f81158-ab98-4281-b20b-eb4c80c13e9f">发布者发布消息</h5>
<div class="outline-text-5" id="text-h:c6f81158-ab98-4281-b20b-eb4c80c13e9f">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; PUBLISH channel1 test1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21457;&#24067;&#32773;&#21457;&#24067;&#28040;&#24687;</span>
(integer) 2     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35746;&#38405;&#32773;&#20010;&#25968;</span>
127.0.0.1:6379&gt; PUBLISH channel1 test2
(integer) 2
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7966b69c-6e16-44de-9174-f0d2742f1b25" class="outline-5">
<h5 id="h:7966b69c-6e16-44de-9174-f0d2742f1b25">各个订阅者都能收到消息</h5>
<div class="outline-text-5" id="text-h:7966b69c-6e16-44de-9174-f0d2742f1b25">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; del channel1
(integer) 1
127.0.0.1:6379&gt; SUBSCRIBE channel1 
1) <span style="color: #8b2252;">"subscribe"</span>
2) <span style="color: #8b2252;">"channel1"</span>
3) (integer) 1
1) <span style="color: #8b2252;">"message"</span>
2) <span style="color: #8b2252;">"channel1"</span>
3) <span style="color: #8b2252;">"test1"</span>
1) <span style="color: #8b2252;">"message"</span>
2) <span style="color: #8b2252;">"channel1"</span>
3) <span style="color: #8b2252;">"test2"</span>
</pre>
</div>

<figure id="orgc6a2d5c">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024100948122.png" alt="20201024100948122.png">

</figure>
</div>
</div>
<div id="outline-container-h:93605942-6985-4786-bd77-f0eb24ca1bce" class="outline-5">
<h5 id="h:93605942-6985-4786-bd77-f0eb24ca1bce">订阅多个频道</h5>
<div class="outline-text-5" id="text-h:93605942-6985-4786-bd77-f0eb24ca1bce">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35746;&#38405;&#25351;&#23450;&#30340;&#22810;&#20010;&#39057;&#36947;</span>
127.0.0.1:6379&gt; SUBSCRIBE channel1 channel2
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e36e5298-1225-4e1f-8fad-cc5395547a37" class="outline-5">
<h5 id="h:e36e5298-1225-4e1f-8fad-cc5395547a37">订阅所有频道</h5>
<div class="outline-text-5" id="text-h:e36e5298-1225-4e1f-8fad-cc5395547a37">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; PSUBSCRIBE *    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25903;&#25345;&#36890;&#37197;&#31526;*</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a335910e-368d-4aff-9b4c-c3b7a3af6f31" class="outline-5">
<h5 id="h:a335910e-368d-4aff-9b4c-c3b7a3af6f31">订阅匹配的频道</h5>
<div class="outline-text-5" id="text-h:a335910e-368d-4aff-9b4c-c3b7a3af6f31">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; PSUBSCRIBE chann*   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21305;&#37197;&#35746;&#38405;&#22810;&#20010;&#39057;&#36947;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:79376cd4-58ec-405f-a2d8-03d80663092f" class="outline-5">
<h5 id="h:79376cd4-58ec-405f-a2d8-03d80663092f">取消订阅</h5>
<div class="outline-text-5" id="text-h:79376cd4-58ec-405f-a2d8-03d80663092f">
<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; unsubscribe channel1
1) <span style="color: #8b2252;">"unsubscribe"</span>
2) <span style="color: #8b2252;">"channel1"</span>
3) (integer) 0
</pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:c4e00568-007a-47a1-af09-bf7700f5d691" class="outline-2">
<h2 id="h:c4e00568-007a-47a1-af09-bf7700f5d691">redis 集群与高可用</h2>
<div class="outline-text-2" id="text-h:c4e00568-007a-47a1-af09-bf7700f5d691">
<p>
虽然Redis可以实现单机的数据持久化，但无论是RDB也好或者AOF也好，都解决
不了单点宕机问题，即一旦单台redis服务器本身出现系统故障、硬件故障等问
题后，就会直接造成数据的丢失
</p>

<p>
此外,单机的性能也是有极限的,因此需要使用另外的技术来解决单点故障和性能扩展的问题。
</p>


<figure id="org40ffa89">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/img_20250819_112939.png" alt="img_20250819_112939.png" width="50%">

</figure>
</div>
<div id="outline-container-h:dd906b8e-1f34-43bb-98bc-31576ef114b4" class="outline-3">
<h3 id="h:dd906b8e-1f34-43bb-98bc-31576ef114b4">redis 主从复制</h3>
<div class="outline-text-3" id="text-h:dd906b8e-1f34-43bb-98bc-31576ef114b4">

<figure id="orgd901c17">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024102000326.png" alt="20201024102000326.png">

</figure>
</div>
<div id="outline-container-h:a55e0464-ba6f-4623-b271-658fd040b37d" class="outline-4">
<h4 id="h:a55e0464-ba6f-4623-b271-658fd040b37d">redis 主从复制架构</h4>
<div class="outline-text-4" id="text-h:a55e0464-ba6f-4623-b271-658fd040b37d">
<p>
主从模式（master/slave），可以实现Redis数据的跨主机备份。
</p>

<p>
程序端连接到高可用负载的VIP，然后连接到负载服务器设置的Redis后端real
server，此模式不需要在程序里面配置Redis服务器的真实IP地址，当后期Redis
服务器IP地址发生变更只需要更改redis相应的后端real server即可， 可避免
更改程序中的IP地址设置。
</p>


<figure id="org253a5b0">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024102049656.png" alt="20201024102049656.png">

</figure>

<p>
<b>主从复制特点:</b>
</p>

<ul class="org-ul">
<li>一个master可以有多个slave</li>
<li>一个slave只能有一个master</li>
<li>数据流向是单向的，master到slave</li>
<li>master可读可写</li>
<li>slave 只读</li>
</ul>
</div>
</div>
<div id="outline-container-h:944dae69-007a-4324-9c52-ff6a6f1d1439" class="outline-4">
<h4 id="h:944dae69-007a-4324-9c52-ff6a6f1d1439">主从复制实现</h4>
<div class="outline-text-4" id="text-h:944dae69-007a-4324-9c52-ff6a6f1d1439">
<p>
Redis Slave
也要开启持久化并设置和master同样的连接密码，因为后期slave会有提升为master的可能,Slave
端切换master同步后会丢失之前的所有数据,而通过持久化可以恢复数据
</p>

<p>
一旦某个Slave成为一个master的slave，Redis
Slave服务会清空当前redis服务器上的所有数据并将master的数据导入到自己的内存，但是如果只是断开同步关系后,则不会删除当前已经同步过的数据。
</p>


<figure id="orgdc9d64b">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024113413808.png" alt="20201024113413808.png">

</figure>

<p>
当配置Redis复制功能时， <b>强烈建议打开主服务器的持久化功能</b> 。否则的话，由于延迟等问题，部署的服务应该要避免自动启动。
</p>

<p>
参考案例: 导致主从服务器数据全部丢失
</p>

<div class="org-src-container">
<pre class="src src-sh">1.&#20551;&#35774;&#33410;&#28857;A&#20026;&#20027;&#26381;&#21153;&#22120;&#65292;&#24182;&#19988;&#20851;&#38381;&#20102;&#25345;&#20037;&#21270;&#12290;&#24182;&#19988;&#33410;&#28857;B&#21644;&#33410;&#28857;c&#20174;&#33410;&#28857;A&#22797;&#21046;&#25968;&#25454;
2.&#33410;&#28857;A&#23849;&#28291;&#65292;&#28982;&#21518;&#30001;&#33258;&#21160;&#25289;&#36215;&#26381;&#21153;&#37325;&#21551;&#20102;&#33410;&#28857;A.&#30001;&#20110;&#33410;&#28857;A&#30340;&#25345;&#20037;&#21270;&#34987;&#20851;&#38381;&#20102;&#65292;&#25152;&#20197;&#37325;&#21551;&#20043;&#21518;&#27809;&#26377;&#20219;&#20309;&#25968;&#25454;
3.&#33410;&#28857;B&#21644;&#33410;&#28857;c&#23558;&#20174;&#33410;&#28857;A&#22797;&#21046;&#25968;&#25454;&#65292;&#20294;&#26159;A&#30340;&#25968;&#25454;&#26159;&#31354;&#30340;&#65292;&#20110;&#26159;&#23601;&#25226;&#33258;&#36523;&#20445;&#23384;&#30340;&#25968;&#25454;&#21103;&#26412;&#21024;&#38500;&#12290;
</pre>
</div>

<p>
在关闭主服务器上的持久化，并同时开启自动拉起进程的情况下，即便使用
Sentinel来实现Redis的高可用性，也是非常危险的。因为主服务器可能拉起得
非常快，以至于Sentinel在配置的心跳时间间隔内没有检测到主服务器已被重启，
然后还是会执行上面的数据丢失的流程。无论何时，数据安全都是极其重要的，
所以应该禁止主服务器关闭持久化的同时自动启动。
</p>
</div>
<div id="outline-container-h:ce776bbd-4920-4231-b840-7225962bf7ee" class="outline-5">
<h5 id="h:ce776bbd-4920-4231-b840-7225962bf7ee">命令行配置</h5>
<div class="outline-text-5" id="text-h:ce776bbd-4920-4231-b840-7225962bf7ee">
</div>
<ul class="org-ul">
<li><a id="h:0097d037-f80e-4e38-8283-5e3f4c9de4ab"></a>启用主从同步<br>
<div class="outline-text-6" id="text-h:0097d037-f80e-4e38-8283-5e3f4c9de4ab">
<p>
redis server默认状态为master，如果要配置从节点需要指定master服务的IP，端口及连接密码
</p>

<p>
在从节点执行 <code>REPLICAOF MASTER_IP PORT</code> 指令可以启用主从复制功能，早期版本使用SLAVOF指令。
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; REPLICAOF MASTER_IP PORT <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26032;&#29256;&#26412;</span>
127.0.0.1:6379&gt; SLAVEOF MASTER_IP PORT <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26087;&#29256;&#26412;&#20351;&#29992;</span>
127.0.0.1:6379&gt; CONFIG SET masterauth &lt;masterpass&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;master&#19978;&#35774;&#32622;key1</span>
[root@master ~]#redis-cli -a centos
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
127.0.0.1:6379&gt; info replication        
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:0
127.0.0.1:6379&gt; set key1 v1-master
OK
127.0.0.1:6379&gt; KEYS *
1) <span style="color: #8b2252;">"key1"</span>
127.0.0.1:6379&gt; get key1
<span style="color: #8b2252;">"v1-master"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#19979;&#37117;&#22312;slave&#19978;&#25191;&#34892;&#65292;&#30331;&#24405;&#65292;&#35774;&#32622;key1</span>
[root@slave1 ~]#redis-cli -a centos
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
127.0.0.1:6379&gt; info replication        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#35282;&#33394;&#40664;&#35748;&#20026;master</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:0
master_replid:37583883b0a8c62bb8ee56d9ea720e286224f56d
127.0.0.1:6379&gt; set key1 v1-slave1-18
OK
127.0.0.1:6379&gt; keys *
1) <span style="color: #8b2252;">"key1"</span>
127.0.0.1:6379&gt; get key1
<span style="color: #8b2252;">"v1-slave1-18"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#31532;&#20108;&#20010;slave2&#19978;&#65292;&#20063;&#35774;&#32622;&#30456;&#21516;&#30340;key1&#65292;&#20294;&#20540;&#19981;&#21516;</span>
[root@slave2 ~]#redis-cli -a centos
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:0
master_replid:437af181fb73ed38b3be9995c00d23012d196de6
127.0.0.1:6379&gt; set key1 v1-slave2-28
OK
127.0.0.1:6379&gt; keys *
1) <span style="color: #8b2252;">"key1"</span>
127.0.0.1:6379&gt; get key1
<span style="color: #8b2252;">"v1-slave2-28"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#25152;&#26377;&#30340;slave&#19978;&#35774;&#32622;master&#30340;IP&#21644;&#31471;&#21475;&#65292;4.0&#29256;&#26412;&#20043;&#21069;&#30340;&#25351;&#20196;&#20026;slaveof</span>
1)&#22312;slave1&#19978;
127.0.0.1:6379&gt; replicaof 10.0.0.8 6379 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20173;&#21487;&#20351;&#29992;SLAVEOF MasterIP Port</span>
OK
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;slave&#19978;&#35774;&#32622;master&#30340;&#23494;&#30721;&#65292;&#25165;&#21487;&#20197;&#21516;&#27493;</span>
127.0.0.1:6379&gt; config set masterauth centos
OK
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35282;&#33394;&#21464;&#20026;slave</span>
master_host:10.0.0.8    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#21521;master</span>
master_port:6379
master_link_status:up
master_last_io_seconds_ago:4
master_sync_in_progress:0 <span style="color: #b22222;">#</span><span style="color: #b22222;">0 &#34920;&#31034;&#21516;&#27493;&#23436;&#25104;</span>
slave_repl_offset:14
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:f68659a5c6e8381dbbdd6841f5b89d1a60157af8

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25968;&#25454;&#26159;&#21542;&#21516;&#27493;&#25104;&#21151;</span>
127.0.0.1:6379&gt; get key1
<span style="color: #8b2252;">"v1-master"</span>
2)&#22312;slave2&#19978;
127.0.0.1:6379&gt; replicaof 10.0.0.8 6379
OK
127.0.0.1:6379&gt; config set masterauth centos
OK
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.8
master_port:6379
master_link_status:up
master_last_io_seconds_ago:9
master_sync_in_progress:0
slave_repl_offset:560
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:f68659a5c6e8381dbbdd6841f5b89d1a60157af8
127.0.0.1:6379&gt; get key1
<span style="color: #8b2252;">"v1-master"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;master&#19978;&#21487;&#20197;&#30475;&#21040;&#25152;&#26377;slave&#30340;&#20449;&#24687;</span>
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:2
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.18,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=672,<span style="color: #a0522d;">lag</span>=1
slave1:<span style="color: #a0522d;">ip</span>=10.0.0.28,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=672,<span style="color: #a0522d;">lag</span>=1
master_replid:f68659a5c6e8381dbbdd6841f5b89d1a60157af8
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:672
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:672
</pre>
</div>
</div>
</li>
<li><a id="h:8f98e552-a1aa-400f-b780-d4a53c3af0cb"></a>删除主从同步<br>
<div class="outline-text-6" id="text-h:8f98e552-a1aa-400f-b780-d4a53c3af0cb">
<p>
REPLICAOF NO ONE 指令可以取消主从复制
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#28040;&#22797;&#21046;&#65292;&#22312;slave&#19978;&#25191;&#34892;REPLICAOF NO ONE&#65292;&#20250;&#26029;&#24320;&#21644;master&#30340;&#36830;&#25509;&#19981;&#20877;&#20027;&#20174;&#22797;&#21046;&#65292;&#20294;&#19981;&#20250;&#28165;&#38500;slave&#19978;&#24050;&#26377;&#30340;&#25968;&#25454;</span>
1)&#22312;slave1&#19978;
127.0.0.1:6379&gt; replicaof no one
OK
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35282;&#33394;&#21464;&#22238;&#20102;master</span>
connected_slaves:0
master_replid:9507932f3addde3a76b51c5d6ecbb5daac398caa
master_replid2:f68659a5c6e8381dbbdd6841f5b89d1a60157af8
master_repl_offset:1064
second_repl_offset:1065
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:1064

2)&#22312;master&#19978;
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:1  slave&#25968;&#37327;&#20943;&#23569;
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.28,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=1260,<span style="color: #a0522d;">lag</span>=0
master_replid:f68659a5c6e8381dbbdd6841f5b89d1a60157af8
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:1260
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:1260
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:8fda0922-026a-4f55-8f69-e3162a74fcda" class="outline-5">
<h5 id="h:8fda0922-026a-4f55-8f69-e3162a74fcda">同步日志</h5>
<div class="outline-text-5" id="text-h:8fda0922-026a-4f55-8f69-e3162a74fcda">
</div>
<ul class="org-ul">
<li><a id="h:3ddd2224-6e51-4e6c-a030-a17c2b16d626"></a>在 master 上观察日志<br>
<div class="outline-text-6" id="text-h:3ddd2224-6e51-4e6c-a030-a17c2b16d626">
<div class="org-src-container">
<pre class="src src-sh">[root@master ~]#tail /var/log/redis/redis.log 
2259:M 24 Oct 2020 12:19:25.773 * Synchronization with replica 10.0.0.18:6379 succeeded
2259:M 24 Oct 2020 12:25:57.637 * Replica 10.0.0.28:6379 asks for synchronization
2259:M 24 Oct 2020 12:25:57.637 * Full resync requested by replica 10.0.0.28:6379
2259:M 24 Oct 2020 12:25:57.637 * Starting BGSAVE for SYNC with target: disk
2259:M 24 Oct 2020 12:25:57.638 * Background saving started by pid 2379
2379:C 24 Oct 2020 12:25:57.639 * DB saved on disk
2379:C 24 Oct 2020 12:25:57.639 * RDB: 0 MB of memory used by copy-on-write
2259:M 24 Oct 2020 12:25:57.717 * Background saving terminated with success
2259:M 24 Oct 2020 12:25:57.718 * Synchronization with replica 10.0.0.28:6379 succeeded
2259:M 24 Oct 2020 12:32:10.884 <span style="color: #b22222;"># </span><span style="color: #b22222;">Connection with replica 10.0.0.18:6379 lost.</span>
</pre>
</div>
</div>
</li>
<li><a id="h:6a932bd2-155d-475b-9c12-684ebed0fd2c"></a>在 slave 节点观察日志<br>
<div class="outline-text-6" id="text-h:6a932bd2-155d-475b-9c12-684ebed0fd2c">
<div class="org-src-container">
<pre class="src src-sh">1)&#22312;slave2&#19978;
[root@slave2 ~]#tail /var/log/redis/redis.log
7318:S 24 Oct 2020 12:25:57.633 * Connecting to MASTER 10.0.0.8:6379
7318:S 24 Oct 2020 12:25:57.633 * MASTER &lt;-&gt; REPLICA sync started
7318:S 24 Oct 2020 12:25:57.634 * Non blocking connect for SYNC fired the event.
7318:S 24 Oct 2020 12:25:57.634 * Master replied to PING, replication can continue...
7318:S 24 Oct 2020 12:25:57.637 * Partial resynchronization not possible (no cached master)
7318:S 24 Oct 2020 12:25:57.638 * Full resync from master: f68659a5c6e8381dbbdd6841f5b89d1a60157af8:546
7318:S 24 Oct 2020 12:25:57.718 * MASTER &lt;-&gt; REPLICA sync: receiving 197 bytes from master
7318:S 24 Oct 2020 12:25:57.719 * MASTER &lt;-&gt; REPLICA sync: Flushing old data
7318:S 24 Oct 2020 12:25:57.719 * MASTER &lt;-&gt; REPLICA sync: Loading DB<span style="color: #a020f0;"> in</span> memory
7318:S 24 Oct 2020 12:25:57.719 * MASTER &lt;-&gt; REPLICA sync: Finished with success
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:c2a7d9cc-ffa9-4832-9bbb-13ed22f47f3d" class="outline-5">
<h5 id="h:c2a7d9cc-ffa9-4832-9bbb-13ed22f47f3d">修改slave节点配置文件</h5>
<div class="outline-text-5" id="text-h:c2a7d9cc-ffa9-4832-9bbb-13ed22f47f3d">
<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">vim /etc/redis.conf 
<span style="color: #b22222;"># </span><span style="color: #b22222;">replicaof &lt;masterip&gt; &lt;masterport&gt;</span>
replicaof 10.0.0.8 6379 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;master&#30340;IP&#21644;&#31471;&#21475;&#21495;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">masterauth &lt;master-password&gt;</span>
masterauth centos   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#23494;&#30721;</span>

[root@slave1 ~]#systemctl restart redis
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7c19ab9e-df2a-485d-bec5-5e0f321383f5" class="outline-5">
<h5 id="h:7c19ab9e-df2a-485d-bec5-5e0f321383f5">master和slave查看状态</h5>
<div class="outline-text-5" id="text-h:7c19ab9e-df2a-485d-bec5-5e0f321383f5">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;master&#19978;&#26597;&#30475;&#29366;&#24577;</span>
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:2
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.18,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=2520,<span style="color: #a0522d;">lag</span>=1
slave1:<span style="color: #a0522d;">ip</span>=10.0.0.28,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=2520,<span style="color: #a0522d;">lag</span>=0
master_replid:f68659a5c6e8381dbbdd6841f5b89d1a60157af8
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:2520
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:2520

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;slave&#19978;&#26597;&#30475;&#29366;&#24577;&#21644;&#25968;&#25454;</span>
1)&#22312;slave1&#19978;
127.0.0.1:6379&gt; get key1    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#27493;&#25104;&#21151;&#21518;&#65292;slave&#19978;&#30340;key&#20449;&#24687;&#20002;&#22833;&#65292;&#20174;master&#22797;&#21046;&#36807;&#26469;&#26032;&#30340;&#20540;</span>
<span style="color: #8b2252;">"v1-master"</span>
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.8
master_port:6379
master_link_status:up
master_last_io_seconds_ago:1
master_sync_in_progress:0
slave_repl_offset:2660
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:f68659a5c6e8381dbbdd6841f5b89d1a60157af8
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:2660
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:2283
repl_backlog_histlen:378
2)&#22312;slave2&#19978;
127.0.0.1:6379&gt; get key1
<span style="color: #8b2252;">"v1-master"</span>
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.8
master_port:6379
master_link_status:up
master_last_io_seconds_ago:10
master_sync_in_progress:0
slave_repl_offset:2786
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:f68659a5c6e8381dbbdd6841f5b89d1a60157af8
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:2786
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:2493
repl_backlog_histlen:294

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20572;&#27490;master&#30340;redis&#26381;&#21153;&#65306;systemctl stop redis&#65292;&#22312;slave&#19978;&#21487;&#20197;&#30475;&#21040;&#20197;&#19979;&#29616;&#35937;</span>
[root@master ~]#systemctl stop redis
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;slave1&#19978;&#65292;&#21516;&#26679;&#22312;islave2&#19978;&#20063;&#26159;</span>
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.8
master_port:6379
master_link_status:down <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;down&#65292;&#34920;&#31034;&#26080;&#27861;&#36830;&#25509;master</span>
master_last_io_seconds_ago:-1
master_sync_in_progress:0
slave_repl_offset:2926
master_link_down_since_seconds:28
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:f68659a5c6e8381dbbdd6841f5b89d1a60157af8
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:2926
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:2283
repl_backlog_histlen:644
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d6b7184e-2bf9-40a6-805d-19ceb5a329e0" class="outline-5">
<h5 id="h:d6b7184e-2bf9-40a6-805d-19ceb5a329e0">slave 观察日志</h5>
<div class="outline-text-5" id="text-h:d6b7184e-2bf9-40a6-805d-19ceb5a329e0">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;slave1&#20026;&#20363;</span>
7530:S 24 Oct 2020 12:46:47.815 * Connecting to MASTER 10.0.0.8:6379
7530:S 24 Oct 2020 12:46:47.816 * MASTER &lt;-&gt; REPLICA sync started
7530:S 24 Oct 2020 12:46:47.816 * Non blocking connect for SYNC fired the event.
7530:S 24 Oct 2020 12:46:47.831 * Master replied to PING, replication can continue...
7530:S 24 Oct 2020 12:46:47.832 * Trying a partial resynchronization (request 9507932f3addde3a76b51c5d6ecbb5daac398caa:1065)<span style="color: #483d8b;">.</span>
7530:S 24 Oct 2020 12:46:47.848 * Full resync from master: f68659a5c6e8381dbbdd6841f5b89d1a60157af8:2282
7530:S 24 Oct 2020 12:46:47.848 * Discarding previously cached master state.
7530:S 24 Oct 2020 12:46:47.897 * MASTER &lt;-&gt; REPLICA sync: receiving 197 bytes from master
7530:S 24 Oct 2020 12:46:47.898 * MASTER &lt;-&gt; REPLICA sync: Flushing old data
7530:S 24 Oct 2020 12:46:47.898 * MASTER &lt;-&gt; REPLICA sync: Loading DB<span style="color: #a020f0;"> in</span> memory
7530:S 24 Oct 2020 12:46:47.898 * MASTER &lt;-&gt; REPLICA sync: Finished with success
7530:S 24 Oct 2020 12:54:37.563 <span style="color: #b22222;"># </span><span style="color: #b22222;">Connection with master lost.</span>
7530:S 24 Oct 2020 12:54:37.563 * Caching the disconnected master state.
7530:S 24 Oct 2020 12:54:38.117 * Connecting to MASTER 10.0.0.8:6379
7530:S 24 Oct 2020 12:54:38.118 * MASTER &lt;-&gt; REPLICA sync started
7530:S 24 Oct 2020 12:54:38.118 <span style="color: #b22222;"># </span><span style="color: #b22222;">Error condition on socket for SYNC: Connection refused</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9bf1651e-e2f4-42ab-9e7d-4a3ce319ed37" class="outline-5">
<h5 id="h:9bf1651e-e2f4-42ab-9e7d-4a3ce319ed37">Master日志</h5>
<div class="outline-text-5" id="text-h:9bf1651e-e2f4-42ab-9e7d-4a3ce319ed37">
<div class="org-src-container">
<pre class="src src-sh">[root@master ~]#tail -f /var/log/redis/redis.log
2259:M 24 Oct 2020 11:48:48.987 * DB loaded from disk: 0.000 seconds
2259:M 24 Oct 2020 11:48:48.987 * Ready to accept connections
2259:M 24 Oct 2020 12:19:25.718 * Replica 10.0.0.18:6379 asks for synchronization
2259:M 24 Oct 2020 12:19:25.719 * Full resync requested by replica 10.0.0.18:6379
2259:M 24 Oct 2020 12:19:25.719 * Starting BGSAVE for SYNC with target: disk
2259:M 24 Oct 2020 12:19:25.719 * Background saving started by pid 2366
2366:C 24 Oct 2020 12:19:25.721 * DB saved on disk
2366:C 24 Oct 2020 12:19:25.721 * RDB: 0 MB of memory used by copy-on-write
2259:M 24 Oct 2020 12:19:25.772 * Background saving terminated with success
2259:M 24 Oct 2020 12:19:25.773 * Synchronization with replica 10.0.0.18:6379 succeeded
2259:M 24 Oct 2020 12:25:57.637 * Replica 10.0.0.28:6379 asks for synchronization
2259:M 24 Oct 2020 12:25:57.637 * Full resync requested by replica 10.0.0.28:6379
2259:M 24 Oct 2020 12:25:57.637 * Starting BGSAVE for SYNC with target: disk
2259:M 24 Oct 2020 12:25:57.638 * Background saving started by pid 2379
2379:C 24 Oct 2020 12:25:57.639 * DB saved on disk
2379:C 24 Oct 2020 12:25:57.639 * RDB: 0 MB of memory used by copy-on-write
2259:M 24 Oct 2020 12:25:57.717 * Background saving terminated with success
2259:M 24 Oct 2020 12:25:57.718 * Synchronization with replica 10.0.0.28:6379 succeeded
2259:M 24 Oct 2020 12:32:10.884 <span style="color: #b22222;"># </span><span style="color: #b22222;">Connection with replica 10.0.0.18:6379 lost.</span>
2259:M 24 Oct 2020 12:46:47.832 * Replica 10.0.0.18:6379 asks for synchronization
2259:M 24 Oct 2020 12:46:47.833 * Partial resynchronization not accepted: Replication ID mismatch (Replica asked for <span style="color: #8b2252;">'9507932f3addde3a76b51c5d6ecbb5daac398caa'</span>, my replication IDs are <span style="color: #8b2252;">'f68659a5c6e8381dbbdd6841f5b89d1a60157af8'</span> and <span style="color: #8b2252;">'0000000000000000000000000000000000000000'</span>)
2259:M 24 Oct 2020 12:46:47.833 * Starting BGSAVE for SYNC with target: disk
2259:M 24 Oct 2020 12:46:47.847 * Background saving started by pid 2466
2466:C 24 Oct 2020 12:46:47.850 * DB saved on disk
2466:C 24 Oct 2020 12:46:47.850 * RDB: 0 MB of memory used by copy-on-write
2259:M 24 Oct 2020 12:46:47.897 * Background saving terminated with success
2259:M 24 Oct 2020 12:46:47.897 * Synchronization with replica 10.0.0.18:6379 succeeded
2259:M 24 Oct 2020 12:49:17.963 <span style="color: #b22222;"># </span><span style="color: #b22222;">Connection with replica 10.0.0.28:6379 lost.</span>
2259:M 24 Oct 2020 12:49:17.997 * Replica 10.0.0.28:6379 asks for synchronization
2259:M 24 Oct 2020 12:49:17.997 * Partial resynchronization request from 10.0.0.28:6379 accepted. Sending 0 bytes of backlog starting from offset 2493.
2259:M 24 Oct 2020 12:54:37.562 <span style="color: #b22222;"># </span><span style="color: #b22222;">User requested shutdown...</span>
2259:M 24 Oct 2020 12:54:37.562 * Saving the final RDB snapshot before exiting.
2259:M 24 Oct 2020 12:54:37.563 * DB saved on disk
2259:M 24 Oct 2020 12:54:37.563 * Removing the pid file.
2259:M 24 Oct 2020 12:54:37.563 <span style="color: #b22222;"># </span><span style="color: #b22222;">Redis is now ready to exit, bye bye...</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:263939dc-a0d6-4a63-832f-56d92b142fb8" class="outline-5">
<h5 id="h:263939dc-a0d6-4a63-832f-56d92b142fb8">slave 状态只读无法写入数据</h5>
<div class="outline-text-5" id="text-h:263939dc-a0d6-4a63-832f-56d92b142fb8">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#37324;&#20197;slave1&#20026;&#20363;</span>
127.0.0.1:6379&gt; set key1 v1-slave1-18
(error) READONLY You can<span style="color: #8b2252;">'t write against a read only replica.</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:635fbe2a-b2c9-48f3-9e67-d47b42d958d6" class="outline-4">
<h4 id="h:635fbe2a-b2c9-48f3-9e67-d47b42d958d6">主从复制故障恢复</h4>
<div class="outline-text-4" id="text-h:635fbe2a-b2c9-48f3-9e67-d47b42d958d6">
</div>
<div id="outline-container-h:500f39b8-95bf-44e3-8564-32fe85f66d1f" class="outline-5">
<h5 id="h:500f39b8-95bf-44e3-8564-32fe85f66d1f">主从复制故障恢复过程介绍</h5>
<div class="outline-text-5" id="text-h:500f39b8-95bf-44e3-8564-32fe85f66d1f">
</div>
<ul class="org-ul">
<li><a id="h:6c22913a-920c-467b-828f-44a8fe1727c0"></a>slave 节点故障和恢复<br>
<div class="outline-text-6" id="text-h:6c22913a-920c-467b-828f-44a8fe1727c0">
<p>
client指向另一个从节点即可，并及时修复故障从节点
</p>


<figure id="org31fef32">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024135839149.png" alt="20201024135839149.png">

</figure>
</div>
</li>
<li><a id="h:5e9bcef9-d649-4bd4-903a-9161614b799f"></a>master 节点故障和恢复<br>
<div class="outline-text-6" id="text-h:5e9bcef9-d649-4bd4-903a-9161614b799f">
<p>
需要提升slave为新的master
</p>


<figure id="orgc496208">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024135943112.png" alt="20201024135943112.png">

</figure>


<figure id="orgfc03988">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024140051440.png" alt="20201024140051440.png">

</figure>

<p>
master故障后，只能手动提升一个slave为新master，不支持自动切换。master的切换会导致master_replid发生变化，slave之前的master_replid就和当前master不一致从而会引发所有slave的全量同步
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:6a9342ae-aa37-4475-88bf-e8e479d95bf8" class="outline-5">
<h5 id="h:6a9342ae-aa37-4475-88bf-e8e479d95bf8">主从复制故障恢复实现</h5>
<div class="outline-text-5" id="text-h:6a9342ae-aa37-4475-88bf-e8e479d95bf8">
<p>
假设当前主节点10.0.0.8故障，提升10.0.0.18为新的master
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@master ~]#systemctl stop redis
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;10.0.0.18&#33410;&#28857;&#30340;&#29366;&#24577;&#20026;slave&#65292;master&#25351;&#21521;10.0.0.8</span>
[root@slave1 ~]#redis-cli -a centos
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.8
master_port:6379
master_link_status:down <span style="color: #b22222;">#</span><span style="color: #b22222;">master&#24050;&#23445;&#25481;</span>
master_last_io_seconds_ago:-1
master_sync_in_progress:0
slave_repl_offset:2590
master_link_down_since_seconds:75
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:bdef83063c2c60b20a3ebc4d3794f0d8f95a4e44
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:2590
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:2590
</pre>
</div>

<p>
停止slave1(10.0.0.18)同步并提升为新的master
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#21319;&#20026;&#26032;&#30340;master</span>
127.0.0.1:6379&gt; replicaof no one    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26087;&#29256;&#20351;&#29992;SLAVEOF no one</span>
OK
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:0
master_replid:37b3bdf32bb1ce3442a4b2d05dcb3a1ada2af352
master_replid2:bdef83063c2c60b20a3ebc4d3794f0d8f95a4e44
master_repl_offset:2590
second_repl_offset:2591
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:2590

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;&#33021;&#21542;&#20889;&#20837;&#25968;&#25454;&#65306;</span>
127.0.0.1:6379&gt; set keytest1 vtest1
OK
</pre>
</div>

<p>
修改所有的slave指向新的master节点
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;10.0.0.28&#33410;&#28857;&#25351;&#21521;&#26032;&#30340;master&#33410;&#28857;10.0.0.18</span>
127.0.0.1:6379&gt; replicaof 10.0.0.18 6379
OK
127.0.0.1:6379&gt; config set masterauth centos
OK
127.0.0.1:6379&gt; set key100 v100
(error) READONLY You can<span style="color: #8b2252;">'t write against a read only replica.</span>
<span style="color: #8b2252;">127.0.0.1:6379&gt; info replication</span>
<span style="color: #8b2252;"># Replication</span>
<span style="color: #8b2252;">role:slave</span>
<span style="color: #8b2252;">master_host:10.0.0.18</span>
<span style="color: #8b2252;">master_port:6379</span>
<span style="color: #8b2252;">master_link_status:up</span>
<span style="color: #8b2252;">master_last_io_seconds_ago:10</span>
<span style="color: #8b2252;">master_sync_in_progress:0</span>
<span style="color: #8b2252;">slave_repl_offset:2736</span>
<span style="color: #8b2252;">slave_priority:100</span>
<span style="color: #8b2252;">slave_read_only:1</span>
<span style="color: #8b2252;">connected_slaves:0</span>
<span style="color: #8b2252;">master_replid:37b3bdf32bb1ce3442a4b2d05dcb3a1ada2af352</span>
<span style="color: #8b2252;">master_replid2:bdef83063c2c60b20a3ebc4d3794f0d8f95a4e44</span>
<span style="color: #8b2252;">master_repl_offset:2736</span>
<span style="color: #8b2252;">second_repl_offset:2591</span>
<span style="color: #8b2252;">repl_backlog_active:1</span>
<span style="color: #8b2252;">repl_backlog_size:1048576</span>
<span style="color: #8b2252;">repl_backlog_first_byte_offset:1</span>
<span style="color: #8b2252;">repl_backlog_histlen:2736</span>

<span style="color: #8b2252;">#&#26597;&#30475;&#26085;&#24535;</span>
<span style="color: #8b2252;">7511:S 24 Oct 2020 14:25:12.275 * REPLICAOF 10.0.0.18:6379 enabled (user request from '</span><span style="color: #a0522d;">id</span>=6 <span style="color: #a0522d;">addr</span>=127.0.0.1:51148 <span style="color: #a0522d;">fd</span>=7 <span style="color: #a0522d;">name</span>= <span style="color: #a0522d;">age</span>=277 <span style="color: #a0522d;">idle</span>=0 <span style="color: #a0522d;">flags</span>=N <span style="color: #a0522d;">db</span>=0 <span style="color: #a0522d;">sub</span>=0 <span style="color: #a0522d;">psub</span>=0 <span style="color: #a0522d;">multi</span>=-1 <span style="color: #a0522d;">qbuf</span>=44 qbuf-free=32724 <span style="color: #a0522d;">obl</span>=0 <span style="color: #a0522d;">oll</span>=0 <span style="color: #a0522d;">omem</span>=0 <span style="color: #a0522d;">events</span>=r <span style="color: #a0522d;">cmd</span>=replicaof<span style="color: #8b2252;">')</span>
<span style="color: #8b2252;">7511:S 24 Oct 2020 14:25:12.492 * Connecting to MASTER 10.0.0.18:6379</span>
<span style="color: #8b2252;">7511:S 24 Oct 2020 14:25:12.492 * MASTER &lt;-&gt; REPLICA sync started</span>
<span style="color: #8b2252;">7511:S 24 Oct 2020 14:25:12.493 * Non blocking connect for SYNC fired the event.</span>
<span style="color: #8b2252;">7511:S 24 Oct 2020 14:25:12.494 * Master replied to PING, replication can continue...</span>
<span style="color: #8b2252;">7511:S 24 Oct 2020 14:25:12.497 * Trying a partial resynchronization (request 96542a696e2a90ac4197412fd2cc5a5c87d5d522:2891).</span>
<span style="color: #8b2252;">7511:S 24 Oct 2020 14:25:12.498 * Full resync from master: 37b3bdf32bb1ce3442a4b2d05dcb3a1ada2af352:2890</span>
<span style="color: #8b2252;">7511:S 24 Oct 2020 14:25:12.498 * Discarding previously cached master state.</span>
<span style="color: #8b2252;">7511:S 24 Oct 2020 14:25:12.539 * MASTER &lt;-&gt; REPLICA sync: receiving 214 bytes from master</span>
<span style="color: #8b2252;">7511:S 24 Oct 2020 14:25:12.539 * MASTER &lt;-&gt; REPLICA sync: Flushing old data</span>
<span style="color: #8b2252;">7511:S 24 Oct 2020 14:25:12.539 * MASTER &lt;-&gt; REPLICA sync: Loading DB in memory</span>
<span style="color: #8b2252;">7511:S 24 Oct 2020 14:25:12.539 * MASTER &lt;-&gt; REPLICA sync: Finished with success</span>
</pre>
</div>

<p>
在新master10.0.0.18上可看到slave
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:1
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.28,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=3002,<span style="color: #a0522d;">lag</span>=0
master_replid:37b3bdf32bb1ce3442a4b2d05dcb3a1ada2af352
master_replid2:bdef83063c2c60b20a3ebc4d3794f0d8f95a4e44
master_repl_offset:3002
second_repl_offset:2591
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:3002
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:56fbfcdb-5e53-4e0a-a745-09a7a8f43551" class="outline-4">
<h4 id="h:56fbfcdb-5e53-4e0a-a745-09a7a8f43551">实现redis的级联复制</h4>
<div class="outline-text-4" id="text-h:56fbfcdb-5e53-4e0a-a745-09a7a8f43551">

<figure id="org03afa8f">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024142924280.png" alt="20201024142924280.png">

</figure>

<p>
在前面搭建好的一主一从架构中，master和slave1节点无需修改，只需要修改slave2及slave3指向slave1作为master即可
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;slave2&#21644;slave3&#19978;&#25191;&#34892;&#19979;&#38754;&#25351;&#20196;</span>
1)&#22312;slave2&#19978;
[root@slave2 ~]#redis-cli -a centos
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
127.0.0.1:6379&gt; replicaof 10.0.0.18 6379
OK
127.0.0.1:6379&gt; config set masterauth centos
OK
127.0.0.1:6379&gt; INFO replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.18
master_port:6379
master_link_status:up
master_last_io_seconds_ago:1
master_sync_in_progress:0
slave_repl_offset:196
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:fcfd3bd0ac7d97d717f9a04a055f153fa8ec7715
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:196
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:196
2)&#22312;slave2&#19978;
127.0.0.1:6379&gt; replicaof 10.0.0.18 6379
OK
127.0.0.1:6379&gt; config set masterauth centos
OK
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.18
master_port:6379
master_link_status:up
master_last_io_seconds_ago:2
master_sync_in_progress:0
slave_repl_offset:2464
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:fcfd3bd0ac7d97d717f9a04a055f153fa8ec7715
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:2464
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:2423
repl_backlog_histlen:42
</pre>
</div>

<p>
在master上设置key，观察是否同步
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;master&#19978;&#26032;&#24314;key</span>
[root@master ~]#redis-cli -a centos
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
127.0.0.1:6379&gt; set name kobe
OK
127.0.0.1:6379&gt; get name
<span style="color: #8b2252;">"kobe"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;slave1&#65292;slave2&#21644;slave3&#19978;&#39564;&#35777;key</span>
127.0.0.1:6379&gt; get name
<span style="color: #8b2252;">"kobe"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;slave1&#21644;slave2&#20197;&#21450;slave3&#19978;&#37117;&#26080;&#27861;&#26032;&#24314;key</span>
127.0.0.1:6379&gt; set age 42
(error) READONLY You can<span style="color: #8b2252;">'t write against a read only replica.</span>
</pre>
</div>

<p>
在中间那个slave(即级联salve1 10.0.0.18)上查看状态
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.8
master_port:6379
master_link_status:up
master_last_io_seconds_ago:2    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#36817;&#19968;&#27425;&#19982;master&#36890;&#20449;&#24050;&#32463;&#36807;&#21435;&#22810;&#23569;&#31186;</span>
master_sync_in_progress:0   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#27491;&#22312;&#19982;master&#36890;&#20449;</span>
slave_repl_offset:3573  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#21516;&#27493;&#30340;&#20559;&#31227;&#37327;</span>
slave_priority:100  <span style="color: #b22222;">#</span><span style="color: #b22222;">slave&#20248;&#20808;&#32423;&#65292;master&#25925;&#38556;&#21518;&#20248;&#20808;&#32423;&#20540;&#36234;&#23567;&#36234;&#20248;&#20808;&#21516;&#27493;</span>
slave_read_only:1
connected_slaves:2
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.28,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=3573,<span style="color: #a0522d;">lag</span>=0    <span style="color: #b22222;">#</span><span style="color: #b22222;">slave&#30340;salve&#33410;&#28857;</span>
slave1:<span style="color: #a0522d;">ip</span>=10.0.0.38,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=3573,<span style="color: #a0522d;">lag</span>=0
master_replid:fcfd3bd0ac7d97d717f9a04a055f153fa8ec7715
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:3573
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:3573
</pre>
</div>
</div>
</div>
<div id="outline-container-h:01c8702a-be1e-42b6-a662-fbcd643d979e" class="outline-4">
<h4 id="h:01c8702a-be1e-42b6-a662-fbcd643d979e">主从复制优化</h4>
<div class="outline-text-4" id="text-h:01c8702a-be1e-42b6-a662-fbcd643d979e">
</div>
<div id="outline-container-h:a5b1c702-6cec-489f-8ee5-14d33392b547" class="outline-5">
<h5 id="h:a5b1c702-6cec-489f-8ee5-14d33392b547">主从复制过程</h5>
<div class="outline-text-5" id="text-h:a5b1c702-6cec-489f-8ee5-14d33392b547">
<p>
Redis主从复制分为全量同步和增量同步
</p>
</div>
<ul class="org-ul">
<li><a id="h:3e6122a1-b04e-4be1-ae2f-fad0fe5bf3e0"></a>全量复制过程<br>
<div class="outline-text-6" id="text-h:3e6122a1-b04e-4be1-ae2f-fad0fe5bf3e0">

<figure id="org6edd3b9">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024152028855.png" alt="20201024152028855.png">

</figure>


<ol class="org-ol">
<li>主从节点建立连接，验证身份后，从节点向主节点发送PSYNC(2.8)版本之前是SYNC)命令</li>
<li>主节点向从节点发送FULLRESYNC命令，包括runlD和offset</li>
<li>从节点保存主节点信息</li>
<li>主节点执行BGSAVE保存RDB文件，同时记录新的记录到buffer中</li>
<li>主节点发送RDB文件给从节点</li>
<li>主节点将新收到buffer中的记录发送至从节点</li>
<li>从节点删除本机的旧数据</li>
<li>从节点加载RDB</li>
<li>从节点同步主节点的buffer信息</li>
</ol>

<p>
Redis全量复制一般发生在Slave首次初始化阶段，这时Slave需要将Master上的所有数据都复制一份。
</p>
</div>
</li>
<li><a id="h:76ed86b3-aa34-43a5-b96c-afcfe983b322"></a>增量复制过程<br>
<div class="outline-text-6" id="text-h:76ed86b3-aa34-43a5-b96c-afcfe983b322">

<figure id="org9a8c11f">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024152635174.png" alt="20201024152635174.png">

</figure>

<ol class="org-ol">
<li>如果他们之间连接发生了抖动，相当于他们的连接断开了。</li>
<li>master节点会写命令的时候，它会写一份放在复制缓冲区</li>
<li>抖动结束，slave再次连接master</li>
<li>slave节点发送一个pysnc命令，把自己当前的run_id和偏移量传送过去</li>
<li>如果master发现偏移量在传输范围内的，它会返回CONTINE</li>
<li>master节点发送偏移量之后的数据给slave</li>
</ol>

<p>
全量同步之后再次需要同步时,从服务器只要发送当前的offset位置(等同于MySQL的binlog的位置)给主服务器，然后主服务器根据相应的位置将之后的数据(包括写在缓冲区的积压数据)发送给从服务器,其再次保存到其内存即可。
</p>
</div>
</li>
<li><a id="h:600955da-9dca-4b77-b3f7-ffd05502ef74"></a>主从同步完整过程<br>
<div class="outline-text-6" id="text-h:600955da-9dca-4b77-b3f7-ffd05502ef74">
<p>
具体主从同步过程如下：
</p>
<ol class="org-ol">
<li>slave发起连接master，验证通过后，发送PSYNC命令</li>
<li>master接收到PSYNC命令后，执行BGSAVE命令将全部数据保存至RDB文件中，并将后续发生的写操作记录至buffer中</li>
<li>master向所有slave发送RDB文件</li>
<li>master向所有slave发送后续记录在buffer中写操作</li>
<li>slave收到快照文件后丢弃所有旧数据</li>
<li>slave加载收到的RDB到内存</li>
<li>slave执行来自master接收到的buffer写操作</li>
<li>当slave完成全量复制后，后续master只会先发送slave_repl_offset信息</li>
<li>以后slave比较自身和master的差异，只会进行增量复制的数据即可</li>
</ol>



<figure id="org37fe7aa">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024153952813.png" alt="20201024153952813.png">

</figure>


<figure id="org5835f28">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024154114535.png" alt="20201024154114535.png">

</figure>


<p>
复制缓冲区(环形队列)配置参数：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">master&#30340;&#20889;&#20837;&#25968;&#25454;&#32531;&#20914;&#21306;&#65292;&#29992;&#20110;&#35760;&#24405;&#33258;&#19978;&#19968;&#27425;&#21516;&#27493;&#21518;&#21040;&#19979;&#19968;&#27425;&#21516;&#27493;&#36807;&#31243;&#20013;&#38388;&#30340;&#20889;&#20837;&#21629;&#20196;&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35745;&#31639;&#20844;&#24335;:repl-backlog-size=&#20801;&#35768;&#20174;&#33410;&#28857;&#26368;&#22823;&#20013;&#26029;&#26102;&#38271; * &#20027;&#23454;&#20363;offset&#27599;&#31186;&#20889;&#20837;&#37327;&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27604;&#22914;:master&#27599;&#31186;&#26368;&#22823;&#20889;&#20837;64mb&#65292;&#26368;&#22823;&#20801;&#35768;60&#31186;&#65292;&#37027;&#20040;&#23601;&#35201;&#35201;&#35774;&#32622;&#20026;64mb*60&#31186;=3840MB(3.8G)&#65292;&#24314;&#35758;&#27492;&#20540;&#26159;&#35774;&#32622;&#30340;&#36275;&#22815;&#22823;</span>
repl-backlog-size 1mb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#19968;&#27573;&#26102;&#38388;&#21518;&#27809;&#26377;slave&#36830;&#25509;&#21040;master&#65292;&#21017;backlogsize&#30340;&#20869;&#20869;&#23384;&#23558;&#20250;&#34987;&#37322;&#25918;&#12290;&#22914;&#26524;&#20540;&#20026;0&#21017;&#34920;&#31034;&#27704;&#36828;&#19981;&#37322;&#25918;&#36825;&#37096;&#20221;&#20869;&#23384;&#12290;</span>
repl-backlog-ttl 3600
</pre>
</div>

<figure id="org870d372">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024154303470.png" alt="20201024154303470.png">

</figure>
</div>
</li>
<li><a id="h:6c9842fe-7a95-4a7b-bc46-2fff57d01a17"></a>避免全量复制<br>
<div class="outline-text-6" id="text-h:6c9842fe-7a95-4a7b-bc46-2fff57d01a17">
<ul class="org-ul">
<li>第一次全量复制不可避免,后续的全量复制可以利用小主节点(内存小),业务低峰时进行全量</li>
<li>节点运行 run-id
不匹配:主节点重启会导致RUNID变化,可能会触发全量复制,可以利用故障转移，例如哨兵或集群,而从节点重新启动,不会导致全量复制</li>
<li>复制积压缓冲区不足:
当主节点生成的新数据大于缓冲区大小,从节点恢复和主节点连接后,会导致全量复制.解决方法将repl-backlog-size
调大</li>
</ul>
</div>
</li>
<li><a id="h:6ec7f6c0-648e-4c7f-9bd0-cf97bc3072b9"></a>避免复制风暴<br>
<div class="outline-text-6" id="text-h:6ec7f6c0-648e-4c7f-9bd0-cf97bc3072b9">
<ul class="org-ul">
<li><p>
单节点复制风暴
</p>

<p>
当主节点重启，多从节点复制
</p>

<p>
解决方法：更换复制拓扑
</p>


<figure id="org9fa7757">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024155352930.png" alt="20201024155352930.png">

</figure></li>

<li><p>
单机器复制风暴
</p>

<p>
机器宕机后，大量全量复制
</p>

<p>
解决方法：主节点分散多机器
</p>


<figure id="org559aab4">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024155633838.png" alt="20201024155633838.png">

</figure></li>
</ul>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:d5fd8446-c069-44c0-bf4a-3622aa6ecc14" class="outline-5">
<h5 id="h:d5fd8446-c069-44c0-bf4a-3622aa6ecc14">主从同步优化配置</h5>
<div class="outline-text-5" id="text-h:d5fd8446-c069-44c0-bf4a-3622aa6ecc14">
<p>
Redis在2.8版本之前没有提供增量部分复制的功能，当网络闪断或者slave
Redis重启之后会导致主从之间的全量同步，即从2.8版本开始增加了部分复制的功能。
</p>

<p>
<b>性能相关配置</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">repl-diskless-sync no <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#20351;&#29992;&#26080;&#30424;&#26041;&#24335;&#36827;&#34892;&#21516;&#27493;RDB&#25991;&#20214;&#65292;&#40664;&#35748;&#20026;no&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">no&#34920;&#31034;&#19981;&#20351;&#29992;&#26080;&#30424;&#65292;&#38656;&#35201;&#23558;RDB&#25991;&#20214;&#20445;&#23384;&#21040;&#30913;&#30424;&#21518;&#20877;&#21457;&#36865;&#32473;slave;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">yes&#34920;&#31034;&#20351;&#29992;&#26080;&#30424;&#65292;&#21363;RDB&#25991;&#20214;&#19981;&#38656;&#35201;&#20445;&#23384;&#33267;&#26412;&#22320;&#30913;&#30424;&#65292;&#32780;&#19988;&#30452;&#25509;&#36890;&#36807;&#32593;&#32476;&#21457;&#36865;&#32473;slave</span>

repl-diskless-sync-delay 5 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26080;&#30424;&#26102;&#22797;&#21046;&#30340;&#26381;&#21153;&#22120;&#31561;&#24453;&#30340;&#24310;&#36831;&#26102;&#38388;</span>

repl-ping-slave-period 10  <span style="color: #b22222;">#</span><span style="color: #b22222;">slave@master&#21457;&#36865;ping&#25645;&#20919;&#30340;&#26102;&#38388;&#38388;&#38548;&#65292;&#40664;&#35748;&#20026;10s</span>

repl-timeout 60            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;ping&#36830;&#25509;&#36229;&#26102;&#26102;&#38388;&#65292;&#36229;&#36807;&#27492;&#20540;&#26080;&#27861;&#36830;&#25509;&#65292;master_link_status&#26174;&#31034;&#20026;down&#29366;&#24577;&#65292;&#24182;&#35760;&#24405;&#38169;&#35823;&#26085;&#24535;</span>

repl-disable-tcp-nodelay no <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#21542;&#21551;&#29992;TCP_NODELAY</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#25104;yes&#65292;&#21017;redis&#20250;&#21512;&#24182;&#22810;&#20010;&#23567;&#30340;TCP&#21253;&#25104;&#19968;&#20010;&#22823;&#21253;&#20877;&#21457;&#36865;&#65292;&#27492;&#26041;&#24335;&#21487;&#20197;&#33410;&#30465;&#24102;&#23485;&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20294;&#20250;&#36896;&#25104;&#21516;&#27493;&#24310;&#36831;&#26102;&#38271;&#30340;&#22686;&#21152;&#65292;&#23548;&#33268;master&#19982;slave&#25968;&#25454;&#30701;&#26399;&#20869;&#19981;&#19968;&#33268;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#25104;no&#65292;&#21017;master&#20250;&#31435;&#21363;&#21516;&#27493;&#25968;&#25454;</span>

repl-backlog-size 1mb <span style="color: #b22222;">#</span><span style="color: #b22222;">master&#30340;&#20889;&#20837;&#25968;&#25454;&#32447;&#20914;&#21306;&#65292;&#29992;&#20110;&#35760;&#24405;&#33258;&#19978;&#19968;&#27425;&#21516;&#27493;&#21518;&#21040;&#19979;&#19968;&#27425;&#21516;&#27493;&#21069;&#26399;&#38388;&#30340;&#20889;&#20837;&#21629;&#20196;&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35745;&#31639;&#20844;&#24335;:repl-backlog-size=&#20801;&#35768;s1ave&#26368;&#22823;&#20013;&#26029;&#26102;&#38271; * master&#33410;&#28857;offset&#27599;&#31186;&#20889;&#20837;&#37327;&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;:master&#27599;&#31186;&#26368;&#22823;&#20889;&#20837;&#37327;&#20026;32MB&#65292;&#26368;&#38271;&#20801;&#35768;&#20013;&#26029;60&#31186;&#65292;&#23601;&#35201;&#33267;&#23569;&#35774;&#32622;&#20026;32*60=1920MB&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24314;&#35758;&#27492;&#20540;&#26159;&#35774;&#32622;&#30340;&#36275;&#22815;&#22823;&#65292;&#22914;&#26524;&#27492;&#20540;&#22826;&#23567;&#65292;&#20250;&#36896;&#25104;&#20840;&#37327;&#22797;&#21046;</span>

repl-backlog-ttl 3600 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#22810;&#38271;&#26102;&#38388;&#21518;&#22914;&#26524;&#27809;&#26377;slave&#36830;&#25509;&#21040;master&#65292;&#21017;backlog&#30340;&#20869;&#23384;&#25968;&#25454;&#23558;&#20250;&#36807;&#26399;&#12290;&#20026;0&#34920;&#31034;&#27704;&#36828;&#19981;&#36807;&#26399;&#12290;</span>

slave-priority 100   <span style="color: #b22222;">#</span><span style="color: #b22222;">slave&#21442;&#19982;&#36873;&#20030;&#26032;&#30340;master&#30340;&#20248;&#20808;&#32423;&#65292;&#27492;&#25972;&#25968;&#20540;&#36234;&#23567;&#21017;&#20248;&#20808;&#32423;&#36234;&#39640;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;master&#25925;&#38556;&#26102;&#23558;&#20250;&#25353;&#29031;&#20248;&#20808;&#32423;&#26469;&#36873;&#25321;s1ave&#31471;&#36827;&#34892;&#36873;&#20030;&#26032;&#30340;master&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#20540;&#35774;&#32622;&#20026;0&#65292;&#21017;&#34920;&#31034;&#35813;slave&#33410;&#28857;&#27704;&#36828;&#19981;&#20250;&#34987;&#36873;&#20026;master&#33410;&#28857;&#12290;</span>

min-replicas-to-write 1 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;master&#30340;&#21487;&#29992;slave&#19981;&#33021;&#23569;&#20110;&#20010;&#25968;&#65292;&#22914;&#26524;&#23569;&#20110;&#27492;&#20540;&#65292;master&#23558;&#26080;&#27861;&#25191;&#34892;&#20889;&#25805;&#20316;&#65292;&#40664;&#35748;&#20026;0&#65292;&#29983;&#20135;&#24314;&#35758;&#35774;&#20026;1</span>

min-slaves-max-laq 20   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#33267;&#23569;&#26377;min-replicas-to-write&#25968;&#37327;&#30340;slave&#24310;&#36831;&#26102;&#38388;&#37117;&#22823;&#20110;&#27492;&#31186;&#25968;&#26102;&#65292;master&#23558;&#19981;&#19981;&#33021;&#25191;&#34892;&#20889;&#25805;&#20316;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ac8a8d5b-68bf-4939-a6ca-e54e98d2dfb7" class="outline-4">
<h4 id="h:ac8a8d5b-68bf-4939-a6ca-e54e98d2dfb7">常见主从复制故障汇总</h4>
<div class="outline-text-4" id="text-h:ac8a8d5b-68bf-4939-a6ca-e54e98d2dfb7">
</div>
<div id="outline-container-h:155997e8-da25-47a2-8e8b-43b09d0f8ebf" class="outline-5">
<h5 id="h:155997e8-da25-47a2-8e8b-43b09d0f8ebf">配置不一致</h5>
<div class="outline-text-5" id="text-h:155997e8-da25-47a2-8e8b-43b09d0f8ebf">
<p>
主从节点的maxmemory不一致，主节点内存大于从节点内存，主从复制可能丢失数据
</p>

<p>
rename-command命令不一致，如在主节点定义了fushall，flushdb从节点没定义，结果执行flushdb不同步
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">master&#26377;&#19968;&#20010;rename-command flushdb "kobe"&#65292;&#32780;slave&#27809;&#26377;&#36825;&#20010;&#37197;&#32622;&#65292;&#21017;&#21516;&#27493;&#26102;&#20174;&#33410;&#28857;&#21487;&#20197;&#30475;&#21040;&#20197;&#19979;&#21516;&#27493;&#38169;&#35823;</span>
3181:S 21 Oct 2020 17:34:50.581 <span style="color: #b22222;"># </span><span style="color: #b22222;">== CRITICAL == This replica is sending an</span>
error to its master: <span style="color: #8b2252;">'unknown command `kobe`, with args beginning with: '</span>
after processing the command <span style="color: #8b2252;">'&lt;unknown&gt;'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d0f69643-ff38-40fc-a2a0-13776c0452c2" class="outline-5">
<h5 id="h:d0f69643-ff38-40fc-a2a0-13776c0452c2">master密码不对</h5>
<div class="outline-text-5" id="text-h:d0f69643-ff38-40fc-a2a0-13776c0452c2">
<p>
即配置的master密码不对，导致验证不通过而无法建立主从同步关系。
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#tail -f /var/log/redis/redis.log
3939:S 24 Oct 2020 16:13:57.552 <span style="color: #b22222;"># </span><span style="color: #b22222;">Server initialized</span>
3939:S 24 Oct 2020 16:13:57.552 * DB loaded from disk: 0.000 seconds
3939:S 24 Oct 2020 16:13:57.552 * Ready to accept connections
3939:S 24 Oct 2020 16:13:57.554 * Connecting to MASTER 10.0.0.18:6379
3939:S 24 Oct 2020 16:13:57.554 * MASTER &lt;-&gt; REPLICA sync started
3939:S 24 Oct 2020 16:13:57.556 * Non blocking connect for SYNC fired the event.
3939:S 24 Oct 2020 16:13:57.558 * Master replied to PING, replication can continue...
3939:S 24 Oct 2020 16:13:57.559 <span style="color: #b22222;"># </span><span style="color: #b22222;">Unable to AUTH to MASTER: -ERR invalid password</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:12f86fe0-c013-493d-9aff-884ffbbf5b3c" class="outline-5">
<h5 id="h:12f86fe0-c013-493d-9aff-884ffbbf5b3c">Redis版本不一致</h5>
<div class="outline-text-5" id="text-h:12f86fe0-c013-493d-9aff-884ffbbf5b3c">
<p>
不同的redis
大版本之间存在兼容性问题，比如：3和4，4和5之间，因此各master和slave之间必须保持版本一致
</p>


<figure id="org07c48df">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024162045288.png" alt="20201024162045288.png">

</figure>
</div>
</div>
<div id="outline-container-h:6ee576d2-1ca6-49db-90c4-64dd291ad029" class="outline-5">
<h5 id="h:6ee576d2-1ca6-49db-90c4-64dd291ad029">安全模式下无法远程连接</h5>
<div class="outline-text-5" id="text-h:6ee576d2-1ca6-49db-90c4-64dd291ad029">
<p>
在开启了安全模式情况下，没有设置bind地址或者密码，会导致无法远程连接。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;bind 127.0.0.1&#27880;&#37322;&#25481;&#20197;&#21450;&#27809;&#26377;&#35774;&#32622;&#23494;&#30721;</span>
[root@master ~]#sed -ri <span style="color: #8b2252;">"s/^(bind.*)/#\1/"</span> /etc/redis.conf
[root@master ~]#systemctl restart redis
[root@master ~]#ss -ntl
State       Recv-Q       Send-Q               Local Address:Port               Peer Address:Port       
LISTEN      0            128                        0.0.0.0:22                      0.0.0.0:*          
LISTEN      0            100                      127.0.0.1:25                      0.0.0.0:*          
LISTEN      0            511                        0.0.0.0:6379                    0.0.0.0:*          
LISTEN      0            128                           [::]:22                         [::]:*          
LISTEN      0            100                          [::1]:25                         [::]:*

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#20854;&#23427;&#23458;&#25143;&#31471;&#36830;&#25509;10.0.0.8</span>
[root@slave1 ~]#redis-cli -h 10.0.0.8 
10.0.0.8:6379&gt; KEYS *
(error) DENIED Redis is running<span style="color: #a020f0;"> in</span> protected mode because protected mode is enabled, no bind address was specified, no authentication password is requested to clients. In this mode connections are only accepted from the loopback interface. If you want to connect from external computers to Redis you may adopt one of the following solutions: 1) Just disable protected mode sending the command <span style="color: #8b2252;">'CONFIG SET protected-mode no'</span> from the loopback interface by connecting to Redis from the same host the server is running, however MAKE SURE Redis is not publicly accessible from internet if you<span style="color: #a020f0;"> do</span> so. Use CONFIG REWRITE to make this change permanent. 2) Alternatively you can just disable the protected mode by editing the Redis configuration file, and setting the protected mode option to <span style="color: #8b2252;">'no'</span>, and then restarting the server. 3) If you started the server manually just for testing, restart it with the <span style="color: #8b2252;">'--protected-mode no'</span> option. 4) Setup a bind address or an authentication password. NOTE: You only need to<span style="color: #a020f0;"> do</span> one of the above things<span style="color: #a020f0;"> in</span> order for the server to start accepting connections from the outside.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26412;&#26426;&#30331;&#24405;</span>
[root@master ~]#redis-cli 
127.0.0.1:6379&gt; KEYS *
1) <span style="color: #8b2252;">"key2"</span>
2) <span style="color: #8b2252;">"name"</span>
3) <span style="color: #8b2252;">"key1"</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:c93384a6-29aa-4905-b38b-2708f78a09e8" class="outline-3">
<h3 id="h:c93384a6-29aa-4905-b38b-2708f78a09e8">redis 哨兵(Sentinel)</h3>
<div class="outline-text-3" id="text-h:c93384a6-29aa-4905-b38b-2708f78a09e8">

<figure id="org5648fec">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024171608245.png" alt="20201024171608245.png">

</figure>
</div>
<div id="outline-container-h:3c4bc08b-9769-4155-a362-031c57b9c9c7" class="outline-4">
<h4 id="h:3c4bc08b-9769-4155-a362-031c57b9c9c7">redis 集群介绍</h4>
<div class="outline-text-4" id="text-h:3c4bc08b-9769-4155-a362-031c57b9c9c7">
<p>
主从架构和MySQL的主从复制一样，无法实现master和slave角色的自动切换，即当master出现故障时，不能实现自动的将一个slave节点提升为新的master节点。即主从复制无法实现自动的故障转移功能，如果想实现转移，则需要手动修改文配置，才能将slave服务器提升新的master节点.此外只有一个主节点支持写操作，所以业务最很大时会导致Redis服务性能达到瓶颈
</p>

<p>
需要解决的主从复制的存在以下弊端
</p>
<ul class="org-ul">
<li>master和slave角色的自动切换，且不能影响业务</li>
<li>提升Redis服务整体性能，支持更高并发访问</li>
</ul>
</div>
</div>
<div id="outline-container-h:d74f3acb-4baf-4c95-9986-27b6c63158e9" class="outline-4">
<h4 id="h:d74f3acb-4baf-4c95-9986-27b6c63158e9">哨兵 (Sentinel) 工作原理</h4>
<div class="outline-text-4" id="text-h:d74f3acb-4baf-4c95-9986-27b6c63158e9">
<p>
哨兵Sentinel从Redis 2.8版本开始引用，Redis 2.8版本之后稳定可用，生产环境如果需要使用此功能建议使用2.8版本以版本。
</p>
</div>
<div id="outline-container-h:dfdc84c7-ce42-4562-a0ba-623e62614548" class="outline-5">
<h5 id="h:dfdc84c7-ce42-4562-a0ba-623e62614548">sentinel 架构和故障转移</h5>
<div class="outline-text-5" id="text-h:dfdc84c7-ce42-4562-a0ba-623e62614548">

<figure id="orgc020552">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024172537720.png" alt="20201024172537720.png">

</figure>


<figure id="org73cac94">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024172731596.png" alt="20201024172731596.png">

</figure>

<p>
专门的Sentinel服务进程是用于监控redis集群中Master工作的状态，当Master主服务器发生故障的时候，可以实现Master和Slave的角色的自动切换，从而实现系统的高可用性
</p>

<p>
Sentinel是一个分布式系统，即需要在多个节点上各自同时运行一个seentinel进程，Sentienl 进程通过流言协议(gossip protocols)来接收关于Master是否下线状态，并使用投票协议(Agreement Protocols)来决定是否执行自动故障转多，并选择合适的Slave作为新的Master
</p>

<p>
每个Sentinel进程会向其它Sentinel、Master、Slave定时发送消息，来确认对方是否存活，如果发现某个节点在指定配置时间内未得到响应，则会认为此节点已离线，即为主观宕机Subjective Down，简称为SDOWN
</p>

<p>
如果哨兵集群中的多数Sentinel进程认为Master存在SDOWN，共同利用is-master-down-by-addr命令互相通知后，则认为客观宕机Objectively Down，简称ODOWN
</p>

<p>
接下来利用 <b>投票算法</b> ，从所有slave节点中，选一台合适的slave将之提升为新Master节点，然后自动修改其它slave相关配置，指向新的nnaster节点，最终实现故障转移failover
</p>

<p>
Redis Sentinel中的Sentinel节点个数应该为大于等于3且最好为奇数
</p>

<p>
客户端初始化时连接的是Sentinel节点集合，不再是具体的Reedis节点，即Sentinel只是配置中心不是代理
</p>

<p>
Redis Sentinel节点与普通Redis没有区别，要实现读写分离体衣赖于客户端程序
</p>

<p>
Sentinel机制类似于MySQL中的MHA功能，只解决master和slave角色的自动故障转移问题，但单个Master的性能瓶颈问题并没有解决
</p>

<p>
Redis 3.0之前版本中，生产环境一般使用哨兵模式较多，Redis 3.0后推出Rediscluster功能，可以支持更大规模的高并发环境
</p>
</div>
</div>
<div id="outline-container-h:47b76296-163b-41f1-8417-be352ed81d52" class="outline-5">
<h5 id="h:47b76296-163b-41f1-8417-be352ed81d52">sentinel中的三个定时任务</h5>
<div class="outline-text-5" id="text-h:47b76296-163b-41f1-8417-be352ed81d52">
<ul class="org-ul">
<li><p>
每10秒每个sentinel对master和slave执行info
</p>

<p>
发现slave节点
</p>

<p>
确认主从关系
</p></li>

<li><p>
每2秒每个sentinel通过master节点的channel交换信(pub/sub)
</p>

<p>
通过sentinel_hello频道交互
</p>

<p>
交互对节点的“看法”和自身信息
</p></li>

<li>每1秒每个sentinel对其他sentinel和redis执行ping</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:9bc146fd-4352-43b8-b735-f25c8449979d" class="outline-4">
<h4 id="h:9bc146fd-4352-43b8-b735-f25c8449979d">实现哨兵</h4>
<div class="outline-text-4" id="text-h:9bc146fd-4352-43b8-b735-f25c8449979d">
<p>
以下案例实现一主两从的基于哨兵的高可用Redis架构
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201024175122142.png" alt="20201024175122142.png">
</p>
</div>
<div id="outline-container-h:d05ccf1f-4043-4a25-83d2-95b2d2f2f76d" class="outline-5">
<h5 id="h:d05ccf1f-4043-4a25-83d2-95b2d2f2f76d">哨兵的准备实现主从复制架构</h5>
<div class="outline-text-5" id="text-h:d05ccf1f-4043-4a25-83d2-95b2d2f2f76d">
<p>
哨兵的前提是已经实现了一个redis的主从复制的运行环境，从而实现一个一主两从基于哨兵的高可用redis架构
</p>

<p>
注意: master 的配置文件中masterauth 和slave 都必须相同
</p>

<p>
<b>所有主从节点的redis.conf中关健配置</b>
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#25152;&#26377;&#20027;&#20174;&#33410;&#28857;&#25191;&#34892;&#65292;&#36825;&#37324;&#20197;master&#20026;&#20363;</span>
[root@master ~]#yum -y install redis
[root@master ~]#systemctl enable --now redis
[root@master ~]#vim /etc/redis.conf
<span style="color: #483d8b;">bind</span> 0.0.0.0
masterauth <span style="color: #8b2252;">"123456"</span>
requirepass <span style="color: #8b2252;">"123456"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#38750;&#20132;&#20114;&#25191;&#34892;&#65292;&#36825;&#37324;&#20197;master&#20026;&#20363;</span>
[root@master ~]#sed -i -e <span style="color: #8b2252;">'s/bind 127.0.0.1/bind 0.0.0.0/'</span> -e <span style="color: #8b2252;">'s/^# masterauth.*/masterauth centos/'</span> -e <span style="color: #8b2252;">'s/^# requirepass .*/requirepass centos/'</span> /etc/redis.conf

[root@master ~]#echo -e <span style="color: #8b2252;">"net.core.somaxconn = 1024\nvm.overcommit_memory = 1"</span> &gt;&gt; /etc/sysctl.conf 
[root@master ~]#sysctl -p
net.core.somaxconn = 1024
vm.overcommit_memory = 1
[root@master ~]#echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled
[root@master ~]#echo <span style="color: #8b2252;">"echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled"</span> &gt;&gt; /etc/rc.d/rc.local 
[root@master ~]#chmod +x /etc/rc.d/rc.local 
[root@master ~]#systemctl restart redis

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#25152;&#26377;&#20174;&#33410;&#28857;&#25191;&#34892;&#65292;&#36825;&#37324;&#20197;salve1&#20026;&#20363;</span>
[root@slave1 ~]#sed -ri <span style="color: #8b2252;">"s/^# (replicaof).*/\1 10.0.0.8 6379/"</span> /etc/redis.conf
[root@slave1 ~]#systemctl restart redis
</pre>
</div>

<p>
<b>master服务器状态</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@master ~]#redis-cli -a centos
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:2
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.18,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=112,<span style="color: #a0522d;">lag</span>=0
slave1:<span style="color: #a0522d;">ip</span>=10.0.0.28,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=112,<span style="color: #a0522d;">lag</span>=0
master_replid:4f93708e2b1ab6f3a47233db68cd99fc3db28409
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:112
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:112
</pre>
</div>

<p>
<b>查看slave1和slave2</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">1)&#22312;slave1&#19978;
[root@slave1 ~]#redis-cli -a centos
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.8
master_port:6379
master_link_status:up
master_last_io_seconds_ago:7
master_sync_in_progress:0
slave_repl_offset:350
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:4f93708e2b1ab6f3a47233db68cd99fc3db28409
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:350
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:350
2)&#22312;slave2&#19978;
[root@slave2 ~]#redis-cli -a centos
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.8
master_port:6379
master_link_status:up
master_last_io_seconds_ago:7
master_sync_in_progress:0
slave_repl_offset:434
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:4f93708e2b1ab6f3a47233db68cd99fc3db28409
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:434
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:85
repl_backlog_histlen:350
</pre>
</div>
</div>
</div>
<div id="outline-container-h:30e8c863-7413-4838-9375-cbd1fd822dfd" class="outline-5">
<h5 id="h:30e8c863-7413-4838-9375-cbd1fd822dfd">编辑哨兵的配置文件</h5>
<div class="outline-text-5" id="text-h:30e8c863-7413-4838-9375-cbd1fd822dfd">
<p>
<b>sentinel配置</b>
</p>

<p>
Sentinel实际上是一个特殊的redis服务器,有些redis指令支持,但很多指令并不支持.默认监听在26379/tcp端口.
</p>

<p>
哨兵可以不和Redis服务器部署在一起，但一般部署在一起，所有redis节点使用相同的以下示例的配置文件
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#26159;&#32534;&#35793;&#23433;&#35013;&#65292;&#22312;&#28304;&#30721;&#30446;&#24405;&#26377;sentinel.conf&#65292;&#22797;&#21046;&#21040;&#23433;&#35013;&#30446;&#24405;&#21363;&#21487;&#65292;&#22914;:/apps/redis/etc/sentinel.conf</span>
[root@master ~]#vim /etc/redis-sentinel.conf 
port 26379
daemonize yes <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#21488;</span>
pidfile /var/run/redis-sentinel.pid
logfile <span style="color: #8b2252;">""</span>
dir /tmp    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24037;&#20316;&#30446;&#24405;</span>

sentinel monitor mymaster 10.0.0.8 6379 2 
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#24403;&#21069;mymaster&#38598;&#32676;&#20013;master&#26381;&#21153;&#22120;&#30340;&#22320;&#22336;&#21644;&#31471;&#21475;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">2&#20026;&#27861;&#23450;&#20154;&#25968;&#38480;&#21046;(quorum)&#65292;&#21363;&#26377;&#20960;&#20010;sentinel&#35748;&#20026;master down&#20102;&#23601;&#36827;&#34892;&#25925;&#38556;&#36716;&#31227;&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#33324;&#27492;&#20540;&#26159;&#25152;&#26377;sentinel&#33410;&#28857;(&#19968;&#33324;&#24635;&#25968;&#26159;&gt;=3&#30340; &#22855;&#25968;,&#22914;:3,5,7&#31561;)&#30340;&#19968;&#21322;&#20197;&#19978;&#30340;&#25972;&#25968;&#20540;&#65292;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27604;&#22914;&#65292;&#24635;&#25968;&#26159;3&#65292;&#21363;3/2=1.5&#65292;&#21462;&#25972;&#20026;2,&#26159;master&#30340;ODOWN&#23458;&#35266;&#19979;&#32447;&#30340;&#20381;&#25454;</span>

sentinel auth-pass mymaster 123456
<span style="color: #b22222;">#</span><span style="color: #b22222;">mymaster&#38598;&#32676;&#20013;master&#30340;&#23494;&#30721;&#65292;&#27880;&#24847;&#27492;&#34892;&#35201;&#22312;&#19978;&#38754;&#34892;&#30340;&#19979;&#38754;</span>

sentinel down-after-milliseconds mymaster 30000
<span style="color: #b22222;">#</span><span style="color: #b22222;">(SDOWN)&#21028;&#26029;mymaster&#38598;&#32676;&#20013;&#25152;&#26377;&#33410;&#28857;&#30340;&#20027;&#35266;&#19979;&#32447;&#30340;&#26102;&#38388;&#65292;&#21333;&#20301;&#65306;&#27627;&#31186;&#65292;&#24314;&#35758;3000</span>

sentinel parallel-syncs mymaster 1      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21457;&#29983;&#25925;&#38556;&#36716;&#31227;&#21518;&#65292;&#21516;&#26102;&#21521;&#26032;master&#21516;&#27493;&#25968;&#25454;&#30340;slave&#25968;&#37327;&#65292;&#25968;&#23383;&#36234;&#23567;&#24635;&#21516;&#27493;&#26102;&#38388;&#36234;&#38271;&#65292;&#20294;&#21487;&#20197;&#20943;&#36731;&#26032;master&#30340;&#36127;&#36733;&#21387;&#21147;</span>

sentinel failover-timeout mymaster 180000
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;slaves&#25351;&#21521;&#26032;&#30340;master&#25152;&#38656;&#30340;&#36229;&#26102;&#26102;&#38388;&#65292;&#21333;&#20301;&#65306;&#27627;&#31186;</span>

sentinel deny-scripts-reconfig yes  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#27490;&#20462;&#25913;&#33050;&#26412;</span>

logfile /var/log/redis/sentinel.log
</pre>
</div>


<p>
<b>三个哨兵服务器的配置都如下，以master为例：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">cp /usr/local/src/redis-8.0.0/sentinel.conf /apps/redis/etc/
chown -R redis:redis /apps/redis/

[root@master ~]#vim /etc/redis-sentinel.conf
<span style="color: #483d8b;">bind</span> 0.0.0.0
port 26379
daemonize no
pidfile /var/run/redis-sentinel.pid
dir /tmp
sentinel monitor mymaster 10.0.0.8 6379 2       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#21518;&#30340;&#20869;&#23481;</span>
sentinel auth-pass mymaster centos      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22686;&#21152;&#21518;&#30340;&#20869;&#23481;</span>
sentinel down-after-milliseconds mymaster 3000      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#21518;&#30340;&#20869;&#23481;</span>
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000
sentinel deny-scripts-reconfig yes
logfile /var/log/redis/sentinel.log

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#27492;&#34892;&#33258;&#21160;&#29983;&#25104;&#24517;&#39035;&#21807;&#19968;&#65292;&#19968;&#33324;&#19981;&#38656;&#35201;&#20462;&#25913;&#65292;&#22914;&#26524;&#30456;&#21516;&#21017;&#20462;&#25913;&#27492;&#20540;&#38656;&#37325;&#21551;redis&#21644;sentinel&#26381;&#21153;</span>
sentinel myid 50547f34ed71fd48c197924969937e738a39975b
... ..
<span style="color: #b22222;"># </span><span style="color: #b22222;">Generated by CONFIG REWRITE</span>
protected-mode no
supervised systemd
sentinel leader-epoch mymaster 0
sentinel known-replica mymaster 10.0.0.28 6379
sentinel known-replica mymaster 10.0.0.18 6379
sentinel current-epoch 0
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5dc5ed5d-2b4a-4a67-a34c-4679ae4e569b" class="outline-5">
<h5 id="h:5dc5ed5d-2b4a-4a67-a34c-4679ae4e569b">启动哨兵</h5>
<div class="outline-text-5" id="text-h:5dc5ed5d-2b4a-4a67-a34c-4679ae4e569b">
<p>
三台哨兵服务器都要启动
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#20445;&#27599;&#20010;&#21736;&#20853;&#20027;&#26426;myid&#19981;&#21516;</span>
[root@master ~]#grep myid /etc/redis-sentinel.conf 
sentinel myid 78af3e3a3edda463b4562c483bc5306ebdbba2fa
[root@slave1 ~]#grep myid /etc/redis-sentinel.conf 
sentinel myid 03c56cc82c32d74c473caaec5422be9ed803035c
[root@slave2 ~]#grep myid /etc/redis-sentinel.conf 
sentinel myid db9f04d90b5bc5fcb83f409592ce4273014c51dd

[root@master ~]#systemctl enable --now redis-sentinel
[root@slave1 ~]#systemctl enable --now redis-sentinel
[root@slave2 ~]#systemctl enable --now redis-sentinel
</pre>
</div>

<p>
如果是编译安装,在所有哨兵服务器执行下面操作启动哨兵
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">vim /apps/redis/etc/sentinel.conf</span>
<span style="color: #483d8b;">bind</span> 0.0.0.0
port 26379
daemonize yes
pidfile <span style="color: #8b2252;">"redis-sentinel.pid"</span>
Logfile <span style="color: #8b2252;">"sentinel_26379.log"</span>
dir <span style="color: #8b2252;">"/apps/redis/data"</span>
sentinel monitor mymaster 10.0.0.8 6379 2
sentinel auth-pass mymaster 123456
sentinel down-after-milliseconds mymaster 15000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000
sentinel deny-scripts-reconfig yes

<span style="color: #b22222;">#</span><span style="color: #b22222;">/apps/redis/bin/redis-sentinel /apps/redis/etc/sentinel.conf</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#26159;&#32534;&#35793;&#23433;&#35013;&#65292;&#21487;&#20197;&#22312;&#25152;&#26377;&#33410;&#28857;&#29983;&#25104;&#26032;&#30340;service&#25991;&#20214;</span>
[root@redis-master ~]#cat /lib/systemd/system/redis-sentinel.service
[Unit]
<span style="color: #a0522d;">Description</span>=Redis Sentinel
<span style="color: #a0522d;">After</span>=network.target

[Service]
<span style="color: #a0522d;">ExecStart</span>=/apps/redis/bin/redis-sentinel /apps/redis/etc/sentinel.conf --supervised systemd
<span style="color: #a0522d;">ExecStop</span>=/bin/kill -s QUIT $<span style="color: #a0522d;">MAINPID</span>
<span style="color: #a0522d;">User</span>=redis
<span style="color: #a0522d;">Group</span>=redis
<span style="color: #a0522d;">RuntimeDirectory</span>=redis
<span style="color: #a0522d;">RuntimeDirectoryMode</span>=0755

[Install]
<span style="color: #a0522d;">WantedBy</span>=multi-user.target

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#25152;&#26377;&#33410;&#28857;&#30340;&#30446;&#24405;&#26435;&#38480;,&#21542;&#21017;&#26080;&#27861;&#21551;&#21160;&#26381;&#21153;</span>
[root@redis-master ~]#chown -R redis.redis /apps/redis
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d968452a-ebcd-47fc-b7af-f34349b248bd" class="outline-5">
<h5 id="h:d968452a-ebcd-47fc-b7af-f34349b248bd">验证哨兵端口</h5>
<div class="outline-text-5" id="text-h:d968452a-ebcd-47fc-b7af-f34349b248bd">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#25152;&#26377;&#33410;&#28857;&#19978;&#39564;&#35777;&#21736;&#20853;&#31471;&#21475;&#65292;&#20197;master&#20026;&#20363;</span>
[root@master ~]#ss -ntl
State       Recv-Q       Send-Q              Local Address:Port                Peer Address:Port       
LISTEN      0            128                       0.0.0.0:22                       0.0.0.0:*          
LISTEN      0            100                     127.0.0.1:25                       0.0.0.0:*          
LISTEN      0            511                       0.0.0.0:6379                     0.0.0.0:*          
LISTEN      0            511                       0.0.0.0:26379                    0.0.0.0:*          
LISTEN      0            128                          [::]:22                          [::]:*          
LISTEN      0            100                         [::1]:25                          [::]:*          
LISTEN      0            511                          [::]:26379                       [::]:*
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8d087b23-a870-4f0a-8311-7d6440fb2d7e" class="outline-5">
<h5 id="h:8d087b23-a870-4f0a-8311-7d6440fb2d7e">查看哨兵日志</h5>
<div class="outline-text-5" id="text-h:8d087b23-a870-4f0a-8311-7d6440fb2d7e">
<p>
<b>master的哨兵日志</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@master ~]#cat /var/log/redis/sentinel.log 
2074:X 24 Oct 2020 21:52:04.694 <span style="color: #b22222;"># </span><span style="color: #b22222;">oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span>
2074:X 24 Oct 2020 21:52:04.694 <span style="color: #b22222;"># </span><span style="color: #b22222;">Redis version=5.0.3, bits=64, commit=00000000, modified=0, pid=2074, just started</span>
2074:X 24 Oct 2020 21:52:04.694 <span style="color: #b22222;"># </span><span style="color: #b22222;">Configuration loaded</span>
2074:X 24 Oct 2020 21:52:04.694 * supervised by systemd, will signal readiness
2074:X 24 Oct 2020 21:52:04.697 * Running <span style="color: #a0522d;">mode</span>=sentinel, <span style="color: #a0522d;">port</span>=26379.
2074:X 24 Oct 2020 21:52:04.699 <span style="color: #b22222;"># </span><span style="color: #b22222;">Sentinel ID is c5325dd8405cf58245cc4febf1bbbcd6ea87e056</span>
2074:X 24 Oct 2020 21:52:04.699 <span style="color: #b22222;"># </span><span style="color: #b22222;">+monitor master mymaster 10.0.0.8 6379 quorum 2</span>
2074:X 24 Oct 2020 21:52:04.701 * +slave slave 10.0.0.18:6379 10.0.0.18 6379 @ mymaster 10.0.0.8 6379
2074:X 24 Oct 2020 21:52:04.703 * +slave slave 10.0.0.28:6379 10.0.0.28 6379 @ mymaster 10.0.0.8 6379
2074:X 24 Oct 2020 21:52:06.730 * +sentinel sentinel 56416b867d4e8dc45405261397b9b77d53bcefec 10.0.0.28 26379 @ mymaster 10.0.0.8 6379
2074:X 24 Oct 2020 21:52:06.778 * +sentinel sentinel 1fe5ef1c56e0cc263d594edae28f5321c33482b9 10.0.0.18 26379 @ mymaster 10.0.0.8 6379
</pre>
</div>

<p>
<b>slave的哨兵日志</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;slave1&#20026;&#20363;</span>
[root@slave1 ~]#cat /var/log/redis/sentinel.log
7723:X 24 Oct 2020 21:12:28.455 * Removing the pid file.
7723:X 24 Oct 2020 21:12:28.455 <span style="color: #b22222;"># </span><span style="color: #b22222;">Sentinel is now ready to exit, bye bye...</span>
7814:X 24 Oct 2020 21:12:28.537 <span style="color: #b22222;"># </span><span style="color: #b22222;">oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span>
7814:X 24 Oct 2020 21:12:28.538 <span style="color: #b22222;"># </span><span style="color: #b22222;">Redis version=5.0.3, bits=64, commit=00000000, modified=0, pid=7814, just started</span>
7814:X 24 Oct 2020 21:12:28.538 <span style="color: #b22222;"># </span><span style="color: #b22222;">Configuration loaded</span>
7814:X 24 Oct 2020 21:12:28.538 * supervised by systemd, will signal readiness
7814:X 24 Oct 2020 21:12:28.539 * Running <span style="color: #a0522d;">mode</span>=sentinel, <span style="color: #a0522d;">port</span>=26379.
7814:X 24 Oct 2020 21:12:28.539 <span style="color: #b22222;"># </span><span style="color: #b22222;">Sentinel ID is 03c56cc82c32d74c473caaec5422be9ed803035c</span>
7814:X 24 Oct 2020 21:12:28.539 <span style="color: #b22222;"># </span><span style="color: #b22222;">+monitor master mymaster 10.0.0.8 6379 quorum 2</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:13c10c4d-0ed2-4e34-a8ed-013d0b42f67f" class="outline-5">
<h5 id="h:13c10c4d-0ed2-4e34-a8ed-013d0b42f67f">当前sentinel状态</h5>
<div class="outline-text-5" id="text-h:13c10c4d-0ed2-4e34-a8ed-013d0b42f67f">
<p>
在sentinel状态中尤其是最后一行，涉及到masterIP是多少，有几个slave，有几个sentinels，必须是符合全部服务器数量
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@master ~]#redis-cli -p 26379
127.0.0.1:26379&gt; info sentinel
<span style="color: #b22222;"># </span><span style="color: #b22222;">Sentinel</span>
sentinel_masters:1
sentinel_tilt:0
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:<span style="color: #a0522d;">name</span>=mymaster,<span style="color: #a0522d;">status</span>=ok,<span style="color: #a0522d;">address</span>=10.0.0.8:6379,<span style="color: #a0522d;">slaves</span>=2,<span style="color: #a0522d;">sentinels</span>=3      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20004;&#20010;slave&#65292;&#19977;&#20010;sentinel&#26381;&#21153;&#22120;&#65292;&#22914;&#26524;sentinels&#20540;&#19981;&#31526;&#21512;&#65292;&#26816;&#26597;myid&#21487;&#33021;&#20914;&#31361;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:78509e60-87d1-4d60-9134-223db8106977" class="outline-5">
<h5 id="h:78509e60-87d1-4d60-9134-223db8106977">停止Redis Master测试故障转移</h5>
<div class="outline-text-5" id="text-h:78509e60-87d1-4d60-9134-223db8106977">
<div class="org-src-container">
<pre class="src src-sh">[root@redis-master ~]#killall redis-server
</pre>
</div>

<p>
查看各节点上哨兵信息：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@master ~]#redis-cli -a centos -p 26379
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
127.0.0.1:26379&gt; info sentinel
<span style="color: #b22222;"># </span><span style="color: #b22222;">Sentinel</span>
sentinel_masters:1
sentinel_tilt:0
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:<span style="color: #a0522d;">name</span>=mymaster,<span style="color: #a0522d;">status</span>=ok,<span style="color: #a0522d;">address</span>=10.0.0.18:6379,<span style="color: #a0522d;">slaves</span>=2,<span style="color: #a0522d;">sentinels</span>=3
</pre>
</div>

<p>
故障转移时sentinel的信息：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@master ~]#cat /var/log/redis/sentinel.log
2490:X 24 Oct 2020 22:18:30.025 <span style="color: #b22222;"># </span><span style="color: #b22222;">+sdown slave 10.0.0.28:6379 10.0.0.28 6379 @ mymaster 10.0.0.8 6379</span>
2490:X 24 Oct 2020 22:18:36.154 <span style="color: #b22222;"># </span><span style="color: #b22222;">-sdown sentinel 56416b867d4e8dc45405261397b9b77d53bcefec 10.0.0.28 26379 @ mymaster 10.0.0.8 6379</span>
2490:X 24 Oct 2020 22:18:36.464 <span style="color: #b22222;"># </span><span style="color: #b22222;">-sdown slave 10.0.0.28:6379 10.0.0.28 6379 @ mymaster 10.0.0.8 6379</span>
2490:X 24 Oct 2020 22:18:59.384 <span style="color: #b22222;"># </span><span style="color: #b22222;">+sdown master mymaster 10.0.0.8 6379</span>
2490:X 24 Oct 2020 22:18:59.485 <span style="color: #b22222;"># </span><span style="color: #b22222;">+odown master mymaster 10.0.0.8 6379 #quorum 2/2</span>
2490:X 24 Oct 2020 22:18:59.485 <span style="color: #b22222;"># </span><span style="color: #b22222;">+new-epoch 9</span>
2490:X 24 Oct 2020 22:18:59.485 <span style="color: #b22222;"># </span><span style="color: #b22222;">+try-failover master mymaster 10.0.0.8 6379</span>
2490:X 24 Oct 2020 22:18:59.486 <span style="color: #b22222;"># </span><span style="color: #b22222;">+vote-for-leader c5325dd8405cf58245cc4febf1bbbcd6ea87e056 9</span>
2490:X 24 Oct 2020 22:18:59.489 <span style="color: #b22222;"># </span><span style="color: #b22222;">1fe5ef1c56e0cc263d594edae28f5321c33482b9 voted for c5325dd8405cf58245cc4febf1bbbcd6ea87e056 9</span>
2490:X 24 Oct 2020 22:18:59.490 <span style="color: #b22222;"># </span><span style="color: #b22222;">56416b867d4e8dc45405261397b9b77d53bcefec voted for c5325dd8405cf58245cc4febf1bbbcd6ea87e056 9</span>
2490:X 24 Oct 2020 22:18:59.577 <span style="color: #b22222;"># </span><span style="color: #b22222;">+elected-leader master mymaster 10.0.0.8 6379</span>
2490:X 24 Oct 2020 22:18:59.577 <span style="color: #b22222;"># </span><span style="color: #b22222;">+failover-state-select-slave master mymaster 10.0.0.8 6379</span>
2490:X 24 Oct 2020 22:18:59.660 <span style="color: #b22222;"># </span><span style="color: #b22222;">+selected-slave slave 10.0.0.18:6379 10.0.0.18 6379 @ mymaster 10.0.0.8 6379</span>
2490:X 24 Oct 2020 22:18:59.660 * +failover-state-send-slaveof-noone slave 10.0.0.18:6379 10.0.0.18 6379 @ mymaster 10.0.0.8 6379
2490:X 24 Oct 2020 22:18:59.718 * +failover-state-wait-promotion slave 10.0.0.18:6379 10.0.0.18 6379 @ mymaster 10.0.0.8 6379
2490:X 24 Oct 2020 22:19:00.190 <span style="color: #b22222;"># </span><span style="color: #b22222;">+promoted-slave slave 10.0.0.18:6379 10.0.0.18 6379 @ mymaster 10.0.0.8 6379</span>
2490:X 24 Oct 2020 22:19:00.190 <span style="color: #b22222;"># </span><span style="color: #b22222;">+failover-state-reconf-slaves master mymaster 10.0.0.8 6379</span>
2490:X 24 Oct 2020 22:19:00.272 * +slave-reconf-sent slave 10.0.0.28:6379 10.0.0.28 6379 @ mymaster 10.0.0.8 6379
2490:X 24 Oct 2020 22:19:00.608 <span style="color: #b22222;"># </span><span style="color: #b22222;">-odown master mymaster 10.0.0.8 6379</span>
2490:X 24 Oct 2020 22:19:00.609 * +slave-reconf-inprog slave 10.0.0.28:6379 10.0.0.28 6379 @ mymaster 10.0.0.8 6379
2490:X 24 Oct 2020 22:19:01.614 * +slave-reconf-done slave 10.0.0.28:6379 10.0.0.28 6379 @ mymaster 10.0.0.8 6379
2490:X 24 Oct 2020 22:19:01.665 <span style="color: #b22222;"># </span><span style="color: #b22222;">+failover-end master mymaster 10.0.0.8 6379</span>
2490:X 24 Oct 2020 22:19:01.665 <span style="color: #b22222;"># </span><span style="color: #b22222;">+switch-master mymaster 10.0.0.8 6379 10.0.0.18 6379</span>
2490:X 24 Oct 2020 22:19:01.666 * +slave slave 10.0.0.28:6379 10.0.0.28 6379 @ mymaster 10.0.0.18 6379
2490:X 24 Oct 2020 22:19:01.666 * +slave slave 10.0.0.8:6379 10.0.0.8 6379 @ mymaster 10.0.0.18 6379
2490:X 24 Oct 2020 22:19:04.687 <span style="color: #b22222;"># </span><span style="color: #b22222;">+sdown slave 10.0.0.8:6379 10.0.0.8 6379 @ mymaster 10.0.0.18 6379</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:499e043a-a485-40e3-9c18-e3db4da7febb" class="outline-5">
<h5 id="h:499e043a-a485-40e3-9c18-e3db4da7febb">故障转移后的redis配置文件会被自动修改</h5>
<div class="outline-text-5" id="text-h:499e043a-a485-40e3-9c18-e3db4da7febb">
<p>
故障转移后其它从节点redis.conf中的replicaof行的master IP会被修改
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@slave2 ~]#grep <span style="color: #8b2252;">"^replicaof"</span> /etc/redis.conf
replicaof 10.0.0.18 6379
</pre>
</div>

<p>
哨兵配置文件的sentinel monitor IP 同样也会被修改
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@master ~]#grep <span style="color: #8b2252;">"^[a-Z]"</span> /etc/redis-sentinel.conf
port 26379
daemonize no
pidfile <span style="color: #8b2252;">"/var/run/redis-sentinel.pid"</span>
dir <span style="color: #8b2252;">"/tmp"</span>
sentinel myid c5325dd8405cf58245cc4febf1bbbcd6ea87e056
sentinel deny-scripts-reconfig yes
sentinel monitor mymaster 10.0.0.18 6379 2
sentinel down-after-milliseconds mymaster 3000
sentinel auth-pass mymaster centos
sentinel config-epoch mymaster 9
logfile <span style="color: #8b2252;">"/var/log/redis/sentinel.log"</span>
protected-mode no
supervised systemd
sentinel leader-epoch mymaster 9
sentinel known-replica mymaster 10.0.0.28 6379
sentinel known-replica mymaster 10.0.0.8 6379
sentinel known-sentinel mymaster 10.0.0.18 26379 1fe5ef1c56e0cc263d594edae28f5321c33482b9
sentinel known-sentinel mymaster 10.0.0.28 26379 56416b867d4e8dc45405261397b9b77d53bcefec
sentinel current-epoch 9

[root@slave1 ~]#grep <span style="color: #8b2252;">"^[a-Z]"</span> /etc/redis-sentinel.conf
port 26379
daemonize no
pidfile <span style="color: #8b2252;">"/var/run/redis-sentinel.pid"</span>
dir <span style="color: #8b2252;">"/tmp"</span>
sentinel myid 1fe5ef1c56e0cc263d594edae28f5321c33482b9
sentinel deny-scripts-reconfig yes
sentinel monitor mymaster 10.0.0.18 6379 2
sentinel down-after-milliseconds mymaster 3000
sentinel auth-pass mymaster centos
sentinel config-epoch mymaster 9
logfile <span style="color: #8b2252;">"/var/log/redis/sentinel.log"</span>
protected-mode no
supervised systemd
sentinel leader-epoch mymaster 9
sentinel known-replica mymaster 10.0.0.8 6379
sentinel known-replica mymaster 10.0.0.28 6379
sentinel known-sentinel mymaster 10.0.0.8 26379 c5325dd8405cf58245cc4febf1bbbcd6ea87e056
sentinel known-sentinel mymaster 10.0.0.28 26379 56416b867d4e8dc45405261397b9b77d53bcefec
sentinel current-epoch 9

[root@slave2 ~]#grep <span style="color: #8b2252;">"^[a-Z]"</span> /etc/redis-sentinel.conf
port 26379
daemonize no
pidfile <span style="color: #8b2252;">"/var/run/redis-sentinel.pid"</span>
dir <span style="color: #8b2252;">"/tmp"</span>
sentinel myid 56416b867d4e8dc45405261397b9b77d53bcefec
sentinel deny-scripts-reconfig yes
sentinel monitor mymaster 10.0.0.18 6379 2
sentinel down-after-milliseconds mymaster 3000
sentinel auth-pass mymaster centos
sentinel config-epoch mymaster 9
logfile <span style="color: #8b2252;">"/var/log/redis/sentinel.log"</span>
protected-mode no
supervised systemd
sentinel leader-epoch mymaster 9
sentinel known-replica mymaster 10.0.0.28 6379
sentinel known-replica mymaster 10.0.0.8 6379
sentinel known-sentinel mymaster 10.0.0.18 26379 1fe5ef1c56e0cc263d594edae28f5321c33482b9
sentinel known-sentinel mymaster 10.0.0.8 26379 c5325dd8405cf58245cc4febf1bbbcd6ea87e056
sentinel current-epoch 9
</pre>
</div>
</div>
</div>
<div id="outline-container-h:60a9c99d-5e35-4fe5-be88-80b9754061fd" class="outline-5">
<h5 id="h:60a9c99d-5e35-4fe5-be88-80b9754061fd">当前 redis状态</h5>
<div class="outline-text-5" id="text-h:60a9c99d-5e35-4fe5-be88-80b9754061fd">
<p>
新的master 状态
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@slave1 ~]#redis-cli -a centos 
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#21319;&#20026;master</span>
connected_slaves:1
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.28,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=162015,<span style="color: #a0522d;">lag</span>=0
master_replid:d0986944509eefec498f58c3eef54240d373ce31
master_replid2:71aa5e09a5f6c2034a5e8f853e3ec0975d9d0ff3
master_repl_offset:162015
second_repl_offset:8732
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:162015
</pre>
</div>

<p>
另一个slave指向新的master
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@slave2 ~]#redis-cli -a centos
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.18   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#21521;&#26032;&#30340;master</span>
master_port:6379
master_link_status:up
master_last_io_seconds_ago:1
master_sync_in_progress:0
slave_repl_offset:196879
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:d0986944509eefec498f58c3eef54240d373ce31
master_replid2:71aa5e09a5f6c2034a5e8f853e3ec0975d9d0ff3
master_repl_offset:196879
second_repl_offset:8732
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:6851
repl_backlog_histlen:190029
</pre>
</div>
</div>
</div>
<div id="outline-container-h:262555ee-f79f-494b-9c6d-b894dca510c8" class="outline-5">
<h5 id="h:262555ee-f79f-494b-9c6d-b894dca510c8">恢复故障的原master重新加入redis集群</h5>
<div class="outline-text-5" id="text-h:262555ee-f79f-494b-9c6d-b894dca510c8">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35753;&#21407;master&#24674;&#22797;</span>
[root@master ~]#systemctl start redis
<span style="color: #b22222;">#</span><span style="color: #b22222;">sentinel&#20250;&#33258;&#21160;&#20462;&#25913;&#19979;&#38754;&#34892;&#25351;&#21521;&#26032;&#30340;master</span>
[root@master ~]#grep <span style="color: #8b2252;">"^replicaof"</span> /etc/redis.conf 
replicaof 10.0.0.18 6379
</pre>
</div>

<p>
在原 master上观察状态
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@master ~]#redis-cli -a centos
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.18
master_port:6379
master_link_status:up
master_last_io_seconds_ago:1
master_sync_in_progress:0
slave_repl_offset:241800
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:d0986944509eefec498f58c3eef54240d373ce31
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:241800
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:216787
repl_backlog_histlen:25014

[root@master ~]#redis-cli -a centos -p 26379
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
127.0.0.1:26379&gt; info replication
127.0.0.1:26379&gt; info sentinel
<span style="color: #b22222;"># </span><span style="color: #b22222;">Sentinel</span>
sentinel_masters:1
sentinel_tilt:0
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:<span style="color: #a0522d;">name</span>=mymaster,<span style="color: #a0522d;">status</span>=ok,<span style="color: #a0522d;">address</span>=10.0.0.18:6379,<span style="color: #a0522d;">slaves</span>=2,<span style="color: #a0522d;">sentinels</span>=3
</pre>
</div>

<p>
观察新master上状态和日志
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@slave1 ~]#redis-cli -a centos 
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
127.0.0.1:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:2
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.28,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=261044,<span style="color: #a0522d;">lag</span>=1
slave1:<span style="color: #a0522d;">ip</span>=10.0.0.8,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=261044,<span style="color: #a0522d;">lag</span>=1
master_replid:d0986944509eefec498f58c3eef54240d373ce31
master_replid2:71aa5e09a5f6c2034a5e8f853e3ec0975d9d0ff3
master_repl_offset:261309
second_repl_offset:8732
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:261309

[root@slave1 ~]#cat /var/log/redis/sentinel.log
7529:X 24 Oct 2020 22:19:03.307 <span style="color: #b22222;"># </span><span style="color: #b22222;">+sdown slave 10.0.0.8:6379 10.0.0.8 6379 @ mymaster 10.0.0.18 6379</span>
7529:X 24 Oct 2020 22:36:27.173 <span style="color: #b22222;"># </span><span style="color: #b22222;">-sdown slave 10.0.0.8:6379 10.0.0.8 6379 @ mymaster 10.0.0.18 6379</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:97f47d06-aa66-47be-b55d-324792a4a0cf" class="outline-4">
<h4 id="h:97f47d06-aa66-47be-b55d-324792a4a0cf">sentinel 运维</h4>
<div class="outline-text-4" id="text-h:97f47d06-aa66-47be-b55d-324792a4a0cf">
<p>
手动让主节点下线
</p>

<div class="org-src-container">
<pre class="src src-sh">sentinel failover &lt;masterName&gt;
</pre>
</div>

<p>
范例: 手动故障转移
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@master ~]#sed -ri <span style="color: #8b2252;">"s/^(replica-priority).*/\1 10/"</span> /etc/redis.conf
[root@master ~]#grep replica-priority /etc/redis.conf 
replica-priority 10 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#20248;&#20808;&#32423;,&#20540;&#36234;&#23567;sentinel&#20250;&#20248;&#20808;&#23558;&#20043;&#36873;&#20026;&#26032;&#30340;master,&#40664;&#20026;&#20540;&#20026;100   </span>

[root@master ~]#redis-cli -a centos -p 26379
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
127.0.0.1:26379&gt; sentinel failover mymaster
OK
127.0.0.1:26379&gt; info sentinel
<span style="color: #b22222;"># </span><span style="color: #b22222;">Sentinel</span>
sentinel_masters:1
sentinel_tilt:0
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:<span style="color: #a0522d;">name</span>=mymaster,<span style="color: #a0522d;">status</span>=ok,<span style="color: #a0522d;">address</span>=10.0.0.8:6379,<span style="color: #a0522d;">slaves</span>=2,<span style="color: #a0522d;">sentinels</span>=3
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d99c127b-9854-4705-bd43-436df7bc2579" class="outline-4">
<h4 id="h:d99c127b-9854-4705-bd43-436df7bc2579">应用程序如何连接 redis</h4>
<div class="outline-text-4" id="text-h:d99c127b-9854-4705-bd43-436df7bc2579">
<p>
Redis 官方客户端：<a href="https://redis.io/clients">https://redis.io/clients</a>
</p>
</div>
<div id="outline-container-h:a95bf4fc-4f0e-43a3-8709-dcb7d97079ea" class="outline-5">
<h5 id="h:a95bf4fc-4f0e-43a3-8709-dcb7d97079ea">客户端连接 sentinel 工作原理</h5>
<div class="outline-text-5" id="text-h:a95bf4fc-4f0e-43a3-8709-dcb7d97079ea">
<p>
1 客户端获取Sentinel节点集合，选举出一个sentinel
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201025094606508.png" alt="20201025094606508.png">
</p>

<p>
2 由这个sentinel 通过masterName 获取master节点信息。客户端通过 setinel get-master-addr-by-name master-name这个api来获取对应主节点信息
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201025094930906.png" alt="20201025094930906.png">
</p>

<p>
3 客户端发送role指令确认master的信息，验证当前获取的主节点是直接的主节点，这样的目的是为了防止故障转移期间主节点的变化
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201025095045158.png" alt="20201025095045158.png">
</p>

<p>
4 客户端保持和sentinel节点集合的联系，即订阅sentinel的相关频道，时刻获取新的master 信息变化，并自动连接新的master
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201025095239477.png" alt="20201025095239477.png">
</p>
</div>
</div>
<div id="outline-container-h:fe739214-75a8-404d-9da4-9b2b61dc95a8" class="outline-5">
<h5 id="h:fe739214-75a8-404d-9da4-9b2b61dc95a8">java 连接Sentinel哨兵</h5>
<div class="outline-text-5" id="text-h:fe739214-75a8-404d-9da4-9b2b61dc95a8">
<p>
java
客户端连接Redis：<a href="https://github.com/xetorthio/jedis/blob/master/pom.xml">https://github.com/xetorthio/jedis/blob/master/pom.xml</a>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">jedis/pom.xml &#37197;&#32622;&#36830;&#25509;redis</span>
&lt;properties&gt;
        &lt;redishosts&gt;localhost:6379,localhost:6380,localhost:6381,localhost:6382,localhost:6383,localhost:6384,localhost:6385&lt;/redis-hosts&gt;
        &lt;sentinelhosts&gt;localhost:26379,localhost:26380,localhost:26381&lt;/sentinel-hosts&gt;
        &lt;clusterhosts&gt;localhost:7379,localhost:7380,localhost:7381,localhost:7382,localhost:7383,localhost:7384,localhost:7385&lt;/cluster-hosts&gt;
        &lt;github.global.server&gt;github&lt;/github.global.server&gt;
&lt;/properties&gt;
</pre>
</div>

<p>
java客户端连接单机的redis是通过Jedis来实现的，java代码用的时候只要创建
Jedis对象就可以建多个Jedis连接池来连接redis，应用程序再直接调用连接池
即可连接Redis。而Redis为了保障高可用,服务一般都是Sentinel部署方式，当
Redis服务中的主服务挂掉之后,会仲裁出另外一台Slaves服务充当Master。这个
时候,我们的应用即使使用了Jedis连接池,如果Master服务挂了,应用将还是无法
连接新的Master服务，为了解决这个问题, Jedis也提供了相应的Sentinel实现,
能够在Redis Sentinel主从切换时候,通知应用,把应用连接到新的Master服务。
</p>

<p>
Redis Sentinel的使用也是十分简单的,只是在JedisPool中添加了Sentinel和
MasterName参数，JRedis Sentinel底层基于Redis订阅实现Redis主从服务的切
换通知，当Reids发生主从切换时，Sentinel会发送通知主动通知Jedis进行连接
的切换，JedisSentinelPool在每次从连接池中获取链接对象的时候,都要对<br>
连接对象进行检测,如果此链接和Sentinel的Master服务连接参数不一致,则会关
闭此连接,重新获取新的Jedis连接对象。
</p>
</div>
</div>
<div id="outline-container-h:5d76808c-43f0-4dcf-af9a-3aaac1345855" class="outline-5">
<h5 id="h:5d76808c-43f0-4dcf-af9a-3aaac1345855">python 连接Sentinel哨兵</h5>
<div class="outline-text-5" id="text-h:5d76808c-43f0-4dcf-af9a-3aaac1345855">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum -y install python3 python3-redis

[root@centos8 ~]#cat sentinel_test.py 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/python3</span>
import redis
from redis.sentinel import Sentinel

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#21736;&#20853;&#26381;&#21153;&#22120;(&#20027;&#26426;&#21517;&#20063;&#21487;&#20197;&#29992;&#22495;&#21517;)</span>
sentinel = Sentinel([(<span style="color: #8b2252;">'10.0.0.8'</span>, 26379),
             (<span style="color: #8b2252;">'10.0.0.18'</span>, 26379),
                     (<span style="color: #8b2252;">'10.0.0.28'</span>, 26379)],
                    <span style="color: #a0522d;">socket_timeout</span>=0.5)

redis_auth_pass = <span style="color: #8b2252;">'centos'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">mymaster &#26159;&#37197;&#32622;&#21736;&#20853;&#27169;&#24335;&#30340;redis&#38598;&#32676;&#21517;&#31216;&#65292;&#27492;&#20026;&#40664;&#35748;&#20540;,&#23454;&#38469;&#21517;&#31216;&#25353;&#29031;&#20010;&#20154;&#37096;&#32626;&#26696;&#20363;&#26469;&#22635;&#20889;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#20027;&#26381;&#21153;&#22120;&#22320;&#22336;</span>
master = sentinel.discover_master(<span style="color: #8b2252;">'mymaster'</span>)
<span style="color: #0000ff;">print</span>(master)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#20174;&#26381;&#21153;&#22120;&#22320;&#22336;</span>
slave = sentinel.discover_slaves(<span style="color: #8b2252;">'mymaster'</span>)
<span style="color: #0000ff;">print</span>(slave)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#20027;&#26381;&#21153;&#22120;&#36827;&#34892;&#20889;&#20837;</span>
master = sentinel.master_for(<span style="color: #8b2252;">'mymaster'</span>, <span style="color: #a0522d;">socket_timeout</span>=0.5,
<span style="color: #a0522d;">password</span>=redis_auth_pass, <span style="color: #a0522d;">db</span>=0)
w_ret = master.set(<span style="color: #8b2252;">'name'</span>, <span style="color: #8b2252;">'kobe'</span>)
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#65306;True</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#21462;&#20174;&#26381;&#21153;&#22120;&#36827;&#34892;&#35835;&#21462;&#65288;&#40664;&#35748;&#26159;round-roubin&#65289;</span>
slave = sentinel.slave_for(<span style="color: #8b2252;">'mymaster'</span>, <span style="color: #a0522d;">socket_timeout</span>=0.5,
<span style="color: #a0522d;">password</span>=redis_auth_pass, <span style="color: #a0522d;">db</span>=0)
r_ret = slave.get(<span style="color: #8b2252;">'name'</span>)
<span style="color: #0000ff;">print</span>(r_ret)
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#65306;kobe</span>

[root@centos8 ~]#chmod +x sentinel_test.py 
[root@centos8 ~]#./sentinel_test.py 
(<span style="color: #8b2252;">'10.0.0.8'</span>, 6379)
[(<span style="color: #8b2252;">'10.0.0.18'</span>, 6379), (<span style="color: #8b2252;">'10.0.0.28'</span>, 6379)]
b<span style="color: #8b2252;">'kobe'</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:5fece8ea-3233-4abf-acca-a7e7853c9428" class="outline-3">
<h3 id="h:5fece8ea-3233-4abf-acca-a7e7853c9428">Redis Cluster</h3>
<div class="outline-text-3" id="text-h:5fece8ea-3233-4abf-acca-a7e7853c9428">

<figure id="orgdc09af2">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201025100651174.png" alt="20201025100651174.png">

</figure>
</div>
<div id="outline-container-h:2af434c2-c671-4dd0-9a03-e41ef09d8d9d" class="outline-4">
<h4 id="h:2af434c2-c671-4dd0-9a03-e41ef09d8d9d">RedisCluster介绍</h4>
<div class="outline-text-4" id="text-h:2af434c2-c671-4dd0-9a03-e41ef09d8d9d">
<p>
使用哨兵sentinel只能解决Redis高可用问题，实现Redis的自动故障转移，但仍然无法解决Redis Master单节点的性能预问题
</p>

<p>
为了解决单机性能的瓶颈，提高Redis服务整体性能，可以使用分布式集美群的解决方案
</p>

<p>
早期Redis分布式集群部署方案:
</p>
<ul class="org-ul">
<li>客户端分区: 由客户端程序自己实现写入分配、高可用管理和故障转移等，对客户端的开发实现较为复杂</li>
<li>代理服务: 客户端不直接连接Redis，而先连接到代理服务，由代理报务实现相应读写分配，当前代理服务都是第三方实现.此方案中客户端实现无需特殊开发，实现容易，但是代理服务节点仍存有单点故障和性能瓶颈问题。</li>
</ul>

<p>
Redis3.0版本之后推出无中心架构的RedisCluster，支持多个master节点并行写入和故障的自动转移动能.
</p>

<p>
<b>Redis Cluster特点如下：</b>
</p>

<ol class="org-ol">
<li>所有Redis节点使用(PING机制)互联</li>
<li>集群中某个节点的是否失效，是由整个集群中超过半数的节点监测都失效，才能算真正的失效</li>
<li>客户端不需要proxy即可直接连接redis，应用程序中需要配置有全部的redis服务器IP</li>
<li>redis cluster把所有的redis node 平均映射到0-16383个槽位(slot)上，读
写需要到指定的redis node上进行操作，因此有多少个redis node相当于
redis并发扩展了多少倍，每个redis node 承担16384/N个槽位</li>
<li>Redis cluster预先分配16384个(slot)槽位，当需要在redis集群中写入一个
key -value的时候，会使用CRC16(key) mod 16384之后的值，决定将key写入
值哪一个槽位从而决定写入哪一个Redis节点上，从而有效解决单机瓶颈。</li>
</ol>

<p>
从节点即不能读也不能写，只是用来替换为主节点用。
</p>
</div>
</div>
<div id="outline-container-h:38114e18-9c29-4e51-9476-b4fd5c1cc48d" class="outline-4">
<h4 id="h:38114e18-9c29-4e51-9476-b4fd5c1cc48d">Redis cluster 架构</h4>
<div class="outline-text-4" id="text-h:38114e18-9c29-4e51-9476-b4fd5c1cc48d">
</div>
<div id="outline-container-h:95075901-04cd-4cd8-8f9f-bea25862b814" class="outline-5">
<h5 id="h:95075901-04cd-4cd8-8f9f-bea25862b814">Redis cluster 架构</h5>
<div class="outline-text-5" id="text-h:95075901-04cd-4cd8-8f9f-bea25862b814">

<figure id="orga9096d1">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201025102725294.png" alt="20201025102725294.png">

</figure>

<p>
Redis cluster需要至少3个master节点才能实现，slave节点数量不限，当然一般每个master都至少对应的有一个slave节点
</p>

<p>
如果有三个主节点采用哈希槽hash slot的方式来分配16384个槽位 slot
</p>

<p>
此三个节点分别承担的slot区间可以是如以下方式分配
</p>
<div class="org-src-container">
<pre class="src src-sh">&#33410;&#28857;M1: 0-5460
&#33410;&#28857;M2: 5461-10922
&#33410;&#28857;M3: 10923-16383
</pre>
</div>


<figure id="org8b70a32">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201025101743606.png" alt="20201025101743606.png">

</figure>


<figure id="org2f28812">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201025102255298.png" alt="20201025102255298.png">

</figure>
</div>
</div>
<div id="outline-container-h:7636f6f4-cc3a-4602-9de0-02f35c4196f5" class="outline-5">
<h5 id="h:7636f6f4-cc3a-4602-9de0-02f35c4196f5">Redis cluster 的工作原理</h5>
<div class="outline-text-5" id="text-h:7636f6f4-cc3a-4602-9de0-02f35c4196f5">

<figure id="org809aad8">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/img_20250819_174535.png" alt="img_20250819_174535.png" width="50%">

</figure>
</div>
<ul class="org-ul">
<li><a id="h:5e1b8695-6339-46f9-9b02-2f5ef717e226"></a>数据分区<br>
<div class="outline-text-6" id="text-h:5e1b8695-6339-46f9-9b02-2f5ef717e226">
<p>
如果是单机存储的话，直接将数据存放在单机redis就行了。但是如果是集群存储，就需要考虑到数据分区了。
</p>

<figure id="orgd01ac31">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/img_20250819_174404.png" alt="img_20250819_174404.png" width="50%">

</figure>


<p>
数据分区通常采取顺序分布和hash分布。
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">分布方式</th>
<th scope="col" class="org-left">顺序分布</th>
<th scope="col" class="org-left">哈希分布</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">数据分散度</td>
<td class="org-left">分布倾斜</td>
<td class="org-left">分布散列</td>
</tr>

<tr>
<td class="org-left">顺序访问</td>
<td class="org-left">支持</td>
<td class="org-left">不支持</td>
</tr>
</tbody>
</table>

<p>
顺序分布保障了数据的有序性，但是离散性低，可能导致某个分区的数据热度高，其他分区数据的热度低，分区访问不均衡。
</p>

<p>
哈希分布也分为多种分布方式，比如区域哈希分区，一致性哈希分区等。而redis cluster采用的是虚拟槽分区的方式。
</p>

<p>
<b>虚拟槽分区</b>
</p>

<p>
redis cluster设置有0~16383的槽，每个槽映射一个数据子集，通过hash函数，将数据存放在不同的槽位中，每个集群的节点保存一部分的槽。
</p>

<p>
每个key存储时，先经过哈希函数CRC16(key)得到一个整数，然后整数与16384取余，得到槽的数值，然后找到对应的节点，将数据存放入对应的槽中
</p>


<figure id="orgceb1c35">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/img_20250819_174819.png" alt="img_20250819_174819.png" width="50%">

</figure>

<p>
<b>集群通信</b>
</p>

<p>
但是寻找槽的过程并不是一次就命中的，比如上图key将要存放在14396槽中，但是并不是一下就锁定了node3节点，可能先去询问node1，然后才访问node3。
</p>

<p>
而集群中节点之间的通信，保证了最多两次就能命中对应槽所在的节点。因为在每个节点中，都保存了其他节点的信息，知道哪个槽由哪个节点负责。这样即使第一次访问没有命中槽，但是会通知客户端，该槽在哪个节点，这样访问对应节点就能精准命中。
</p>


<figure id="orgb7d1408">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/img_20250819_175129.png" alt="img_20250819_175129.png" width="50%">

</figure>
<ol class="org-ol">
<li>节点A对节点B发送一个meet操作，B返回后表示A和B之间能够进行沟通。</li>
<li>节点A对节点C发送meet操作，C返回后，A和C之间也能进行沟通。</li>
<li>然后B根据对A的了解，就能找到C，B和C之间也建立了联系。</li>
<li>直到所有节点都能建立联系。</li>
</ol>

<p>
这样每个节点都能互相知道对方负责哪些槽。
</p>
</div>
</li>
<li><a id="h:1f18c465-57ce-4f30-9e30-b9d5e45a4eb2"></a>集群伸缩<br>
<div class="outline-text-6" id="text-h:1f18c465-57ce-4f30-9e30-b9d5e45a4eb2">
<p>
集群并不是建立之后，节点数就固定不变的，也会有新的节点加入集群或者集群中的节点下线，这就是集群的扩容和缩容。但是由于集群节点和槽息息相关，所以集群的伸缩也对应了槽和数据的迁移
</p>


<figure id="org6892f53">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/img_20250819_175422.png" alt="img_20250819_175422.png" width="50%">

</figure>

<p>
<b>集群扩容</b>
</p>

<p>
当有新的节点准备好加入集群时，这个新的节点还是孤立节点，加入有两种方式。一个是通过集群节点执行命令来和孤立节点握手，另一个则是使用脚本来添加节点。
</p>

<ul class="org-ul">
<li>cluster_node_ip:port: cluster meet ip port new_node_ip:port</li>
<li>redis-trib.rb add-node new_node_ip:port cluster_node_ip:port</li>
</ul>

<p>
通常这个新的节点有两种身份，要么作为主节点，要么作为从节点：
</p>

<ul class="org-ul">
<li>主节点：分摊槽和数据</li>
<li>从节点：作故障转移备份</li>
</ul>


<figure id="org0fd39b3">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/1479036033.png" alt="1479036033.png" width="50%">

</figure>

<p>
其中槽的迁移有以下步骤：
</p>


<figure id="org57849b2">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/img_20250819_180312.png" alt="img_20250819_180312.png" width="50%">

</figure>

<p>
<b>集群缩容</b>
</p>


<figure id="org5d4ea54">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/img_20250819_180500.png" alt="img_20250819_180500.png" width="50%">

</figure>

<p>
<b>下线节点的流程如下</b>:
</p>
<ol class="org-ol">
<li>判断该节点是否持有槽，如果未持有槽就跳转到下一步，持有槽则先迁移槽到其他节点</li>
<li>通知其他节点（cluster forget）忘记该下线节点</li>
<li>关闭下线节点的服务</li>
</ol>

<p>
需要注意的是如果先下线主节点，再下线从节点，会进行故障转移，所以要先下线从节点。
</p>
</div>
</li>
<li><a id="h:f2de396c-0df6-4a96-a89e-e6bbebad4e1f"></a>故障转移<br>
<div class="outline-text-6" id="text-h:f2de396c-0df6-4a96-a89e-e6bbebad4e1f">
<p>
<b>除了手动下线节点外，也会面对突发故障</b> 。下面提到的主要是主节点的故障，因为从节点的故障并不影响主节点工作，对应的主节点只会记住自己哪个从节点下线了，并将信息发送给其他节点。故障的从节点重连后，继续官复原职，复制主节点的数据。
</p>

<p>
只有主节点才需要进行故障转移。在之前学习主从复制时，我们需要使用redis sentinel来实现故障转移。而redis cluster则不需要redis sentinel，其自身就具备了故障转移功能。根据前面我们了解到，节点之间是会进行通信的，节点之间通过ping/pong交互消息，所以借此就能发现故障。集群节点发现故障同样是有主观下线和客观下线的
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:bb0d7cc9-4a7c-4097-9b83-e732054c23d9" class="outline-5">
<h5 id="h:bb0d7cc9-4a7c-4097-9b83-e732054c23d9">Redis Cluster 部署架构说明</h5>
<div class="outline-text-5" id="text-h:bb0d7cc9-4a7c-4097-9b83-e732054c23d9">
<p>
测试环境：3台服务器，每台服务器启动6379和6380两个redis
服务实例，适用于测试环境
</p>


<figure id="org24f48b0">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201025102700695.png" alt="20201025102700695.png">

</figure>

<p>
生产环境：6台服务器，分别是三组master/slave
</p>



<figure id="org2e8102a">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201025103523291.png" alt="20201025103523291.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#38598;&#32676;&#33410;&#28857;</span>
10.0.0.8
10.0.0.18
10.0.0.28
10.0.0.38
10.0.0.48
10.0.0.58
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39044;&#30041;&#26381;&#21153;&#22120;&#25193;&#23637;&#20351;&#29992;</span>
10.0.0.68
10.0.0.78
</pre>
</div>

<p>
<b>说明：Redis 5.X
和之前版本相比有很多变化，以下分别介绍两个版本5.X和4.X的配置</b>
</p>
</div>
</div>
<div id="outline-container-h:dcea6b2e-7b9a-4b95-8b8a-c69003bbe4ef" class="outline-5">
<h5 id="h:dcea6b2e-7b9a-4b95-8b8a-c69003bbe4ef">部署方式介绍</h5>
<div class="outline-text-5" id="text-h:dcea6b2e-7b9a-4b95-8b8a-c69003bbe4ef">
<p>
redis cluster 有多种部署方法
</p>

<ul class="org-ul">
<li>原生命令安装
<ul class="org-ul">
<li>理解Redis Cluster架构</li>
<li>生产环境不使用</li>
</ul></li>
<li>官方工具安装
<ul class="org-ul">
<li>高效、准确</li>
<li>生产环境可以使用</li>
</ul></li>
<li>自主研发
<ul class="org-ul">
<li>可以实现可视化的自动化部署</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:cdba74cb-9b97-41f8-8680-9d2ae0a74729" class="outline-4">
<h4 id="h:cdba74cb-9b97-41f8-8680-9d2ae0a74729">实战案例：基于Redis 5 的 redis cluster 部署</h4>
<div class="outline-text-4" id="text-h:cdba74cb-9b97-41f8-8680-9d2ae0a74729">
<p>
官方文档：<a href="https://redis.io/topics/cluster-tutorial">https://redis.io/topics/cluster-tutorial</a>
</p>

<p>
<b>redis cluster 相关命令</b>
</p>

<p>
范例：查看 &#x2013;cluster 选项帮助
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#redis-cli --cluster help
Cluster Manager Commands:
  create         host1:port1 ... hostN:portN
                 --cluster-replicas &lt;arg&gt;
  check          host:port
                 --cluster-search-multiple-owners
  info           host:port
  fix            host:port
                 --cluster-search-multiple-owners
  reshard        host:port
                 --cluster-from &lt;arg&gt;
                 --cluster-to &lt;arg&gt;
                 --cluster-slots &lt;arg&gt;
                 --cluster-yes
                 --cluster-timeout &lt;arg&gt;
                 --cluster-pipeline &lt;arg&gt;
                 --cluster-replace
  rebalance      host:port
                 --cluster-weight &lt;<span style="color: #a0522d;">node1</span>=w1...nodeN=wN&gt;
                 --cluster-use-empty-masters
                 --cluster-timeout &lt;arg&gt;
                 --cluster-simulate
                 --cluster-pipeline &lt;arg&gt;
                 --cluster-threshold &lt;arg&gt;
                 --cluster-replace
  add-node       new_host:new_port existing_host:existing_port
                 --cluster-slave
                 --cluster-master-id &lt;arg&gt;
  del-node       host:port node_id
  call           host:port command arg arg .. arg
  set-timeout    host:port milliseconds
  import         host:port
                 --cluster-from &lt;arg&gt;
                 --cluster-copy
                 --cluster-replace
  <span style="color: #483d8b;">help</span>           

For check, fix, reshard, del-node, set-timeout you can specify the host and port of any working node<span style="color: #a020f0;"> in</span> the cluster.
</pre>
</div>

<p>
范例: 查看CLUSTER 指令的帮助
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#redis-cli -a centos --no-auth-warning cluster help
 1) CLUSTER &lt;subcommand&gt; arg arg ... arg. Subcommands are:
 2) ADDSLOTS &lt;slot&gt; [slot ...] -- Assign slots to current node.
 3) BUMPEPOCH -- Advance the cluster config epoch.
 4) COUNT-failure-reports &lt;node-id&gt; -- Return number of failure reports for &lt;node-id&gt;.
 5) COUNTKEYSINSLOT &lt;slot&gt; - Return the number of keys<span style="color: #a020f0;"> in</span> &lt;slot&gt;.
 6) DELSLOTS &lt;slot&gt; [slot ...] -- Delete slots information from current node.
 7) FAILOVER [force|takeover] -- Promote current replica node to being a master.
 8) FORGET &lt;node-id&gt; -- Remove a node from the cluster.
 9) GETKEYSINSLOT &lt;slot&gt; &lt;count&gt; -- Return key names stored by current node<span style="color: #a020f0;"> in</span> a slot.
10) FLUSHSLOTS -- Delete current node own slots information.
11) INFO - Return onformation about the cluster.
12) KEYSLOT &lt;key&gt; -- Return the hash slot for &lt;key&gt;.
13) MEET &lt;ip&gt; &lt;port&gt; [bus-port] -- Connect nodes into a working cluster.
14) MYID -- Return the node id.
15) NODES -- Return cluster configuration seen by node. Output format:
16)     &lt;id&gt; &lt;ip:port&gt; &lt;flags&gt; &lt;master&gt; &lt;pings&gt; &lt;pongs&gt; &lt;epoch&gt; &lt;link&gt; &lt;slot&gt; ... &lt;slot&gt;
17) REPLICATE &lt;node-id&gt; -- Configure current node as replica to &lt;node-id&gt;.
18) RESET [hard|soft] -- Reset current node (default: soft)<span style="color: #483d8b;">.</span>
19) SET-config-epoch &lt;epoch&gt; - Set config epoch of current node.
20) SETSLOT &lt;slot&gt; (importing|migrating|stable|node &lt;node-id&gt;) -- Set slot state.
21) REPLICAS &lt;node-id&gt; -- Return &lt;node-id&gt; replicas.
22) SLOTS -- Return information about slots range mappings. Each range is made of:
23)     start, end, master and replicas IP addresses, ports and ids
</pre>
</div>
</div>
<div id="outline-container-h:d723f827-eb6f-47c5-84c8-46aaad49088e" class="outline-5">
<h5 id="h:d723f827-eb6f-47c5-84c8-46aaad49088e">创建 redis cluster集群的环境准备</h5>
<div class="outline-text-5" id="text-h:d723f827-eb6f-47c5-84c8-46aaad49088e">
<ol class="org-ol">
<li>每个redis 节点采用相同的硬件配置、相同的密码、相同的redis版本</li>
<li>所有redis服务器必须没有任何数据</li>
<li>准备6台主机，地址如下：</li>
</ol>

<div class="org-src-container">
<pre class="src src-sh">10.0.0.8
10.0.0.18
10.0.0.28
10.0.0.38
10.0.0.48
10.0.0.58
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d9895ddf-c4b9-4b80-9387-ef0cdfacce36" class="outline-5">
<h5 id="h:d9895ddf-c4b9-4b80-9387-ef0cdfacce36">启用redis cluster 配置</h5>
<div class="outline-text-5" id="text-h:d9895ddf-c4b9-4b80-9387-ef0cdfacce36">
<p>
所有6台主机都执行以下配置
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25152;&#26377;&#20027;&#26426;&#33050;&#26412;&#32534;&#35793;&#23433;&#35013;</span>
<span style="color: #a0522d;">REDIS_VERSION</span>=redis-6.2.7
<span style="color: #b22222;">#</span><span style="color: #b22222;">REDIS_VERSION=redis-4.0.14</span>
<span style="color: #a0522d;">PASSWORD</span>=123456
<span style="color: #a0522d;">INSTALL_DIR</span>=/apps/redis
<span style="color: #a0522d;">CPUS</span>=<span style="color: #ff00ff;">`lscpu |awk '/^CPU\(s\)/{print $2}'`</span>

<span style="color: #483d8b;">.</span> /etc/os-release

<span style="color: #0000ff;">color</span> () {
    <span style="color: #a0522d;">RES_COL</span>=60
    <span style="color: #a0522d;">MOVE_TO_COL</span>=<span style="color: #8b2252;">"echo -en \\033[${RES_COL}G"</span>
    <span style="color: #a0522d;">SETCOLOR_SUCCESS</span>=<span style="color: #8b2252;">"echo -en \\033[1;32m"</span>
    <span style="color: #a0522d;">SETCOLOR_FAILURE</span>=<span style="color: #8b2252;">"echo -en \\033[1;31m"</span>
    <span style="color: #a0522d;">SETCOLOR_WARNING</span>=<span style="color: #8b2252;">"echo -en \\033[1;33m"</span>
    <span style="color: #a0522d;">SETCOLOR_NORMAL</span>=<span style="color: #8b2252;">"echo -en \E[0m"</span>
    <span style="color: #483d8b;">echo</span> -n <span style="color: #8b2252;">"$1"</span> &amp;&amp; $<span style="color: #a0522d;">MOVE_TO_COL</span>
    <span style="color: #483d8b;">echo</span> -n <span style="color: #8b2252;">"["</span>
    <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">2</span> = <span style="color: #8b2252;">"success"</span> -o $<span style="color: #a0522d;">2</span> = <span style="color: #8b2252;">"0"</span> ] ;<span style="color: #a020f0;">then</span>
        ${<span style="color: #a0522d;">SETCOLOR_SUCCESS</span>}
        <span style="color: #483d8b;">echo</span> -n $<span style="color: #8b2252;">"  OK  "</span>    
    <span style="color: #a020f0;">elif</span> [ $<span style="color: #a0522d;">2</span> = <span style="color: #8b2252;">"failure"</span> -o $<span style="color: #a0522d;">2</span> = <span style="color: #8b2252;">"1"</span>  ] ;<span style="color: #a020f0;">then</span> 
        ${<span style="color: #a0522d;">SETCOLOR_FAILURE</span>}
        <span style="color: #483d8b;">echo</span> -n $<span style="color: #8b2252;">"FAILED"</span>
    <span style="color: #a020f0;">else</span>
        ${<span style="color: #a0522d;">SETCOLOR_WARNING</span>}
        <span style="color: #483d8b;">echo</span> -n $<span style="color: #8b2252;">"WARNING"</span>
    <span style="color: #a020f0;">fi</span>
    ${<span style="color: #a0522d;">SETCOLOR_NORMAL</span>}
    <span style="color: #483d8b;">echo</span> -n <span style="color: #8b2252;">"]"</span>
    <span style="color: #483d8b;">echo</span> 
}


<span style="color: #0000ff;">prepare</span>(){
    <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">ID</span> = <span style="color: #8b2252;">"centos"</span> -o $<span style="color: #a0522d;">ID</span> = <span style="color: #8b2252;">"rocky"</span> ];<span style="color: #a020f0;">then</span>
        yum  -y install gcc make jemalloc-devel systemd-devel
    <span style="color: #a020f0;">else</span>
            apt update 
            apt -y install  gcc make libjemalloc-dev libsystemd-dev
    <span style="color: #a020f0;">fi</span>
    <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">?</span> -eq 0 ];<span style="color: #a020f0;">then</span>
        color <span style="color: #8b2252;">"&#23433;&#35013;&#36719;&#20214;&#21253;&#25104;&#21151;"</span>  0
    <span style="color: #a020f0;">else</span>
        color <span style="color: #8b2252;">"&#23433;&#35013;&#36719;&#20214;&#21253;&#22833;&#36133;&#65292;&#35831;&#26816;&#26597;&#32593;&#32476;&#37197;&#32622;"</span> 1
        <span style="color: #a020f0;">exit</span>
    <span style="color: #a020f0;">fi</span>
}
<span style="color: #0000ff;">install</span>() {   
    <span style="color: #a020f0;">if</span> [ ! -f ${<span style="color: #a0522d;">REDIS_VERSION</span>}.tar.gz ];<span style="color: #a020f0;">then</span>
        wget http://download.redis.io/releases/${<span style="color: #a0522d;">REDIS_VERSION</span>}.tar.gz || { color <span style="color: #8b2252;">"Redis &#28304;&#30721;&#19979;&#36733;&#22833;&#36133;"</span> 1 ; <span style="color: #a020f0;">exit</span>; }
    <span style="color: #a020f0;">fi</span>
    tar xf ${<span style="color: #a0522d;">REDIS_VERSION</span>}.tar.gz -C /usr/local/src
    <span style="color: #483d8b;">cd</span> /usr/local/src/${<span style="color: #a0522d;">REDIS_VERSION</span>}
    make -j $<span style="color: #a0522d;">CUPS</span> <span style="color: #a0522d;">USE_SYSTEMD</span>=yes <span style="color: #a0522d;">PREFIX</span>=${<span style="color: #a0522d;">INSTALL_DIR</span>} install &amp;&amp; color <span style="color: #8b2252;">"Redis &#32534;&#35793;&#23433;&#35013;&#23436;&#25104;"</span> 0 || { color <span style="color: #8b2252;">"Redis &#32534;&#35793;&#23433;&#35013;&#22833;&#36133;"</span> 1 ;<span style="color: #a020f0;">exit</span> ; }

    ln -s ${<span style="color: #a0522d;">INSTALL_DIR</span>}/bin/redis-*  /usr/bin/

    mkdir -p ${<span style="color: #a0522d;">INSTALL_DIR</span>}/{etc,log,data,run}

    cp redis.conf  ${<span style="color: #a0522d;">INSTALL_DIR</span>}/etc/

    sed -i -e <span style="color: #8b2252;">'s/bind 127.0.0.1/bind 0.0.0.0/'</span>  -e <span style="color: #8b2252;">"/# requirepass/a requirepass $PASSWORD"</span>  -e <span style="color: #8b2252;">"/^dir .*/c dir ${INSTALL_DIR}/data/"</span>  -e <span style="color: #8b2252;">"/logfile .*/c logfile ${INSTALL_DIR}/log/redis-6379.log"</span>  -e  <span style="color: #8b2252;">"/^pidfile .*/c  pidfile ${INSTALL_DIR}/run/redis_6379.pid"</span> ${<span style="color: #a0522d;">INSTALL_DIR</span>}/etc/redis.conf


    <span style="color: #a020f0;">if</span> id redis &amp;&gt; /dev/null ;<span style="color: #a020f0;">then</span> 
         color <span style="color: #8b2252;">"Redis &#29992;&#25143;&#24050;&#23384;&#22312;"</span> 1 
    <span style="color: #a020f0;">else</span>
         useradd -r -s /sbin/nologin redis
         color <span style="color: #8b2252;">"Redis &#29992;&#25143;&#21019;&#24314;&#25104;&#21151;"</span> 0
    <span style="color: #a020f0;">fi</span>

    chown -R redis.redis ${<span style="color: #a0522d;">INSTALL_DIR</span>}

    cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF
<span style="color: #ffa54f;">net.core.somaxconn = 1024</span>
<span style="color: #ffa54f;">vm.overcommit_memory = 1</span>
<span style="color: #ffa54f;">EOF</span>
    sysctl -p 
    <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">ID</span> = <span style="color: #8b2252;">"centos"</span> -o $<span style="color: #a0522d;">ID</span> = <span style="color: #8b2252;">"rocky"</span> ];<span style="color: #a020f0;">then</span>
        <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled'</span> &gt;&gt; /etc/rc.d/rc.local
        chmod +x /etc/rc.d/rc.local
        /etc/rc.d/rc.local 
    <span style="color: #a020f0;">else</span> 
        <span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">'#!/bin/bash\necho never &gt; /sys/kernel/mm/transparent_hugepage/enabled'</span> &gt;&gt; /etc/rc.local
        chmod +x /etc/rc.local
        /etc/rc.local
    <span style="color: #a020f0;">fi</span>


cat &gt; /lib/systemd/system/redis.service &lt;&lt;EOF
<span style="color: #ffa54f;">[Unit]</span>
<span style="color: #ffa54f;">Description=Redis persistent key-value database</span>
<span style="color: #ffa54f;">After=network.target</span>

<span style="color: #ffa54f;">[Service]</span>
<span style="color: #ffa54f;">ExecStart=${INSTALL_DIR}/bin/redis-server ${INSTALL_DIR}/etc/redis.conf --supervised systemd</span>
<span style="color: #ffa54f;">ExecStop=/bin/kill -s QUIT \$MAINPID</span>
<span style="color: #ffa54f;">Type=notify</span>
<span style="color: #ffa54f;">User=redis</span>
<span style="color: #ffa54f;">Group=redis</span>
<span style="color: #ffa54f;">RuntimeDirectory=redis</span>
<span style="color: #ffa54f;">RuntimeDirectoryMode=0755</span>
<span style="color: #ffa54f;">LimitNOFILE=1000000</span>

<span style="color: #ffa54f;">[Install]</span>
<span style="color: #ffa54f;">WantedBy=multi-user.target</span>

<span style="color: #ffa54f;">EOF</span>
     systemctl daemon-reload 
     systemctl enable --now  redis &amp;&gt; /dev/null 
     <span style="color: #a020f0;">if</span> [ $<span style="color: #a0522d;">?</span> -eq 0 ];<span style="color: #a020f0;">then</span>
         color <span style="color: #8b2252;">"Redis &#26381;&#21153;&#21551;&#21160;&#25104;&#21151;,Redis&#20449;&#24687;&#22914;&#19979;:"</span>  0 
     <span style="color: #a020f0;">else</span>
         color <span style="color: #8b2252;">"Redis &#21551;&#21160;&#22833;&#36133;"</span> 1 
         <span style="color: #a020f0;">exit</span>
     <span style="color: #a020f0;">fi</span>
     sleep 2
     redis-cli -a $<span style="color: #a0522d;">PASSWORD</span> INFO Server 2&gt; /dev/null
}

prepare 
install
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]#yum -y install redis
</pre>
</div>

<p>
每个节点修改redis配置，必须开启cluster功能的参数
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25163;&#21160;&#20462;&#25913;&#37197;&#32622;&#25991;&#20214;</span>
[root@redis-node1 ~]vim /etc/redis.conf
<span style="color: #483d8b;">bind</span> 0.0.0.0
masterauth 123456 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24314;&#35758;&#37197;&#32622;&#65292;&#21542;&#21017;&#21518;&#26399;&#30340;master&#21644;slave&#20027;&#20174;&#22797;&#21046;&#26080;&#27861;&#25104;&#21151;&#65292;&#36824;&#38656;&#20877;&#37197;&#32622;</span>
requirepass 123456
cluster-enabled yes <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#28040;&#27492;&#34892;&#27880;&#37322;,&#24517;&#39035;&#24320;&#21551;&#38598;&#32676;&#65292;&#24320;&#21551;&#21518; redis &#36827;&#31243;&#20250;&#26377;cluster&#26631;&#35782;</span>
cluster-config-file nodes-6379.conf <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#28040;&#27492;&#34892;&#27880;&#37322;,&#27492;&#20026;&#38598;&#32676;&#29366;&#24577;&#25968;&#25454;&#25991;&#20214;,&#35760;&#24405;&#20027;&#20174;&#20851;&#31995;&#21450;slot&#33539;&#22260;&#20449;&#24687;,&#30001;redis cluster &#38598;&#32676;&#33258;&#21160;&#21019;&#24314;&#21644;&#32500;&#25252;</span>
cluster-require-full-coverage no <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#20540;&#20026;yes,&#35774;&#20026;no&#21487;&#20197;&#38450;&#27490;&#19968;&#20010;&#33410;&#28857;&#19981;&#21487;&#29992;&#23548;&#33268;&#25972;&#20010;cluster&#19981;&#21487;&#29992;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#26159;&#32534;&#35793;&#23433;&#35013;&#21487;&#20197;&#25191;&#34892;&#19979;&#38754;&#25805;&#20316;</span>
[root@Rocky_60 ~]#sed -i.bak -e <span style="color: #8b2252;">'/masterauth/a masterauth 123456'</span> -e <span style="color: #8b2252;">'/# cluster-enabled yes/a cluster-enabled yes'</span> -e <span style="color: #8b2252;">'/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf'</span> -e <span style="color: #8b2252;">'/# cluster-require-full-coverage/c cluster-require-full-coverage no'</span> /apps/redis/etc/redis.conf

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26159;&#21542;&#37197;&#32622;&#25104;&#21151;</span>
[root@Rocky_60 ~]#grep -E <span style="color: #8b2252;">'^(bind|masterauth|requirepass|cluster-enabled|cluster-config-file|cluster-require-full-coverage)'</span> /apps/redis/etc/redis.conf
<span style="color: #483d8b;">bind</span> 0.0.0.0 -::1
masterauth 123456
requirepass 123456
cluster-enabled yes
cluster-config-file nodes-6379.conf
cluster-require-full-coverage no

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25335;&#36125;&#37197;&#32622;&#22909;&#30340;redis.conf&#21040;&#20854;&#20182;&#20027;&#26426;&#19978;</span>
[root@Rocky_61 ~]#scp 192.168.100.60:/apps/redis/etc/redis.conf /apps/redis/etc/redis.conf
[root@Rocky_62 ~]#scp 192.168.100.60:/apps/redis/etc/redis.conf /apps/redis/etc/redis.conf
[root@Rocky_63 ~]#scp 192.168.100.60:/apps/redis/etc/redis.conf /apps/redis/etc/redis.conf
[root@Rocky_64 ~]#scp 192.168.100.60:/apps/redis/etc/redis.conf /apps/redis/etc/redis.conf
[root@Rocky_65 ~]#scp 192.168.100.60:/apps/redis/etc/redis.conf /apps/redis/etc/redis.conf

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#38598;&#32676;&#27169;&#24335;&#19979;&#65292;&#19981;&#33021;&#26377;rdb&#25991;&#20214;&#29983;&#25104;&#65292;&#21542;&#21017;&#26080;&#27861;&#21551;&#21160;redis&#26381;&#21153;</span>
[root@Rocky_60 ~]#systemctl enable --now redis
[root@Rocky_61 ~]#systemctl enable --now redis
[root@Rocky_62 ~]#systemctl enable --now redis
[root@Rocky_63 ~]#systemctl enable --now redis
[root@Rocky_64 ~]#systemctl enable --now redis
[root@Rocky_65 ~]#systemctl enable --now redis
[root@Rocky_66 ~]#systemctl enable --now redis
</pre>
</div>


<p>
验证当前Redis服务状态：以redis-node1为例
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#20102;16379&#30340;cluster&#30340;&#31471;&#21475;,&#23454;&#38469;&#30340;&#31471;&#21475;=redis port + 10000</span>
[root@Rocky_60 ~]#ss -ntl
State                   Recv-Q                  Send-Q                                     Local Address:Port     
LISTEN                  0                       511                                              0.0.0.0:6379     
LISTEN                  0                       128                                              0.0.0.0:22       
LISTEN                  0                       511                                              0.0.0.0:16379    
LISTEN                  0                       511                                                [::1]:6379     
LISTEN                  0                       128                                                 [::]:22       
LISTEN                  0                       511                                                [::1]:16379

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#36827;&#31243;&#26377;[cluster]&#29366;&#24577;</span>
[root@Rocky_60 ~]#ps -ef|grep redis
redis      34590       1  0 22:21 ?        00:00:01 /apps/redis/bin/redis-server 0.0.0.0:6379 [cluster]
root       34677   34383  0 22:42 pts/1    00:00:00 grep --color=auto redis
</pre>
</div>
</div>
</div>
<div id="outline-container-h:92abd892-07b9-4a71-9e8b-6cb264731a64" class="outline-5">
<h5 id="h:92abd892-07b9-4a71-9e8b-6cb264731a64">创建集群</h5>
<div class="outline-text-5" id="text-h:92abd892-07b9-4a71-9e8b-6cb264731a64">
<div class="org-src-container">
<pre class="src src-sh">
<span style="color: #b22222;"># </span><span style="color: #b22222;">redis-cli --cluster-replicas 1 &#34920;&#31034;&#27599;&#20010;master&#23545;&#24212;&#19968;&#20010;slave&#33410;&#28857;</span>
[root@redis-node1 ~]#redis-cli -a centos --no-auth-warning --cluster create 10.0.0.8:6379 10.0.0.18:6379 10.0.0.28:6379 10.0.0.38:6379 10.0.0.48:6379 10.0.0.58:6379 --cluster-replicas 1
&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...
Master[0] -&gt; Slots 0 - 5460
Master[1] -&gt; Slots 5461 - 10922
Master[2] -&gt; Slots 10923 - 16383
Adding replica 10.0.0.38:6379 to 10.0.0.8:6379
Adding replica 10.0.0.48:6379 to 10.0.0.18:6379
Adding replica 10.0.0.58:6379 to 10.0.0.28:6379
M: c5fd06610cd05c760e3fcfb60ad3b4351ce6b309 10.0.0.8:6379 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24102;M&#30340;&#20026;master</span>
   slots:[0-5460] (5461 slots) master                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;master&#30340;&#27133;&#20301;&#36215;&#22987;&#21644;&#32467;&#26463;</span>
M: 1cd30e11cc46cffa0e441c456a2ecf2645a72771 10.0.0.18:6379
   slots:[5461-10922] (5462 slots) master
M: 79643546e59ba0e88477e1678dda30c29113dc56 10.0.0.28:6379
   slots:[10923-16383] (5461 slots) master
S: cbb5606890cf491d23379e426c61f62fc3a0732e 10.0.0.38:6379  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24102;S&#30340;&#20026;slave</span>
   replicates c5fd06610cd05c760e3fcfb60ad3b4351ce6b309
S: e1cb57392effcc88a76060104d131044224a8285 10.0.0.48:6379
   replicates 1cd30e11cc46cffa0e441c456a2ecf2645a72771
S: 4e42a7dacf7642810aa398817388e1f120649ba7 10.0.0.58:6379
   replicates 79643546e59ba0e88477e1678dda30c29113dc56
Can I set the above configuration? (<span style="color: #483d8b;">type</span> <span style="color: #8b2252;">'yes'</span> to accept): yes <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20837;yes&#33258;&#21160;&#21019;&#24314;&#38598;&#32676;</span>
&gt;&gt;&gt; Nodes configuration updated
&gt;&gt;&gt; Assign a different config epoch to each node
&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join
...
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.8:6379)
M: c5fd06610cd05c760e3fcfb60ad3b4351ce6b309 10.0.0.8:6379
   slots:[0-5460] (5461 slots) master   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24050;&#20998;&#37197;&#30340;&#27133;&#20301;</span>
   1 additional replica(s) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#37197;&#20102;&#19968;&#20010;slave</span>
S: cbb5606890cf491d23379e426c61f62fc3a0732e 10.0.0.38:6379
   slots: (0 slots) slave <span style="color: #b22222;">#</span><span style="color: #b22222;">slave&#27809;&#26377;&#20998;&#37197;&#27133;&#20301;</span>
   replicates c5fd06610cd05c760e3fcfb60ad3b4351ce6b309 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#24212;&#30340;master&#30340;ID</span>
M: 1cd30e11cc46cffa0e441c456a2ecf2645a72771 10.0.0.18:6379
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
S: 4e42a7dacf7642810aa398817388e1f120649ba7 10.0.0.58:6379
   slots: (0 slots) slave
   replicates 79643546e59ba0e88477e1678dda30c29113dc56
M: 79643546e59ba0e88477e1678dda30c29113dc56 10.0.0.28:6379
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
S: e1cb57392effcc88a76060104d131044224a8285 10.0.0.48:6379
   slots: (0 slots) slave
   replicates 1cd30e11cc46cffa0e441c456a2ecf2645a72771
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35266;&#23519;&#20197;&#19978;&#32467;&#26524;&#65292;&#21487;&#20197;&#30475;&#21040;3&#32452;master/slave</span>
master:10.0.0.8---slave:10.0.0.38
master:10.0.0.18---slave:10.0.0.48
master:10.0.0.28---slave:10.0.0.58
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3f86e4a6-38f6-4d0e-a673-d3e7989fe19f" class="outline-5">
<h5 id="h:3f86e4a6-38f6-4d0e-a673-d3e7989fe19f">查看主从状态</h5>
<div class="outline-text-5" id="text-h:3f86e4a6-38f6-4d0e-a673-d3e7989fe19f">
<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning -c info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:1
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.38,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=448,<span style="color: #a0522d;">lag</span>=1
master_replid:b357337835511dc0a4a8c39af088ede2366a898f
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:448
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:448

[root@redis-node2 ~]#redis-cli -h 10.0.0.18 -a centos --no-auth-warning info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:1
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.48,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=574,<span style="color: #a0522d;">lag</span>=0
master_replid:9cacaf57dddd73cfcd71b79e8d1c14202f11991c
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:574
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:574

[root@redis-node3 ~]#redis-cli -h 10.0.0.28 -a centos --no-auth-warning info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:1
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.58,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=644,<span style="color: #a0522d;">lag</span>=0
master_replid:b1f5dda97b2f7fe4bb07ffe61272bdb71e1d2cfa
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:644
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:644    

[root@redis-node4 ~]#redis-cli -h 10.0.0.38 -a centos --no-auth-warning info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.8
master_port:6379
master_link_status:up
master_last_io_seconds_ago:1
master_sync_in_progress:0
slave_repl_offset:728
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:b357337835511dc0a4a8c39af088ede2366a898f
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:728
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:728

[root@redis-node5 ~]#redis-cli -h 10.0.0.48 -a centos --no-auth-warning info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.18
master_port:6379
master_link_status:up
master_last_io_seconds_ago:1
master_sync_in_progress:0
slave_repl_offset:784
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:9cacaf57dddd73cfcd71b79e8d1c14202f11991c
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:784
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:784

[root@redis-node6 ~]#redis-cli -h 10.0.0.58 -a centos --no-auth-warning info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.28
master_port:6379
master_link_status:up
master_last_io_seconds_ago:10
master_sync_in_progress:0
slave_repl_offset:812
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:b1f5dda97b2f7fe4bb07ffe61272bdb71e1d2cfa
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:812
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:812
</pre>
</div>

<p>
范例: 查看指定master节点的slave节点信息
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]#redis-cli -a centos cluster nodes
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
cbb5606890cf491d23379e426c61f62fc3a0732e 10.0.0.38:6379@16379 slave c5fd06610cd05c760e3fcfb60ad3b4351ce6b309 0 1603610101333 4 connected
1cd30e11cc46cffa0e441c456a2ecf2645a72771 10.0.0.18:6379@16379 master - 0 1603610100000 2 connected 5461-10922
4e42a7dacf7642810aa398817388e1f120649ba7 10.0.0.58:6379@16379 slave 79643546e59ba0e88477e1678dda30c29113dc56 0 1603610100325 6 connected
79643546e59ba0e88477e1678dda30c29113dc56 10.0.0.28:6379@16379 master - 0 1603610099000 3 connected 10923-16383
e1cb57392effcc88a76060104d131044224a8285 10.0.0.48:6379@16379 slave 1cd30e11cc46cffa0e441c456a2ecf2645a72771 0 1603610099316 5 connected
c5fd06610cd05c760e3fcfb60ad3b4351ce6b309 10.0.0.8:6379@16379 myself,master - 0 1603610099000 1 connected 0-5460

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#19979;&#21629;&#20196;&#26597;&#30475;&#25351;&#23450;master&#33410;&#28857;&#30340;slave&#33410;&#28857;&#20449;&#24687;,&#20854;&#20013;79643546e59ba0e88477e1678dda30c29113dc56 &#20026;master&#20013;redis-node3&#33410;&#28857;&#30340;ID</span>
[root@redis-node1 ~]#redis-cli -a centos --no-auth-warning cluster slaves 79643546e59ba0e88477e1678dda30c29113dc56
1) <span style="color: #8b2252;">"4e42a7dacf7642810aa398817388e1f120649ba7 10.0.0.58:6379@16379 slave 79643546e59ba0e88477e1678dda30c29113dc56 0 1603610299010 6 connected"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cca53490-8353-405f-892f-dec1611a63a1" class="outline-5">
<h5 id="h:cca53490-8353-405f-892f-dec1611a63a1">验证集群状态</h5>
<div class="outline-text-5" id="text-h:cca53490-8353-405f-892f-dec1611a63a1">
<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]#redis-cli -a centos --no-auth-warning cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33410;&#28857;&#25968;</span>
cluster_size:3      <span style="color: #b22222;">#</span><span style="color: #b22222;">3&#20010;&#38598;&#32676;</span>
cluster_current_epoch:6
cluster_my_epoch:1
cluster_stats_messages_ping_sent:1003
cluster_stats_messages_pong_sent:1042
cluster_stats_messages_sent:2045
cluster_stats_messages_ping_received:1037
cluster_stats_messages_pong_received:1003
cluster_stats_messages_meet_received:5
cluster_stats_messages_received:2045

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20219;&#24847;&#33410;&#28857;&#30340;&#38598;&#32676;&#29366;&#24577;</span>
[root@redis-node1 ~]#redis-cli -a centos --no-auth-warning --cluster info 10.0.0.18:6379
10.0.0.18:6379 (1cd30e11...) -&gt; 0 keys | 5462 slots | 1 slaves.
10.0.0.28:6379 (79643546...) -&gt; 0 keys | 5461 slots | 1 slaves.
10.0.0.8:6379 (c5fd0661...) -&gt; 0 keys | 5461 slots | 1 slaves.
[OK] 0 keys<span style="color: #a020f0;"> in</span> 3 masters.
0.00 keys per slot on average.
[root@redis-node1 ~]#redis-cli -a centos --no-auth-warning --cluster info 10.0.0.48:6379
10.0.0.8:6379 (c5fd0661...) -&gt; 0 keys | 5461 slots | 1 slaves.
10.0.0.28:6379 (79643546...) -&gt; 0 keys | 5461 slots | 1 slaves.
10.0.0.18:6379 (1cd30e11...) -&gt; 0 keys | 5462 slots | 1 slaves.
[OK] 0 keys<span style="color: #a020f0;"> in</span> 3 masters.
0.00 keys per slot on average.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a0dfaddd-893b-4d75-acfe-f7942568a49a" class="outline-5">
<h5 id="h:a0dfaddd-893b-4d75-acfe-f7942568a49a">查看集群node对应关系</h5>
<div class="outline-text-5" id="text-h:a0dfaddd-893b-4d75-acfe-f7942568a49a">
<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]#redis-cli -a centos --no-auth-warning cluster nodes
cbb5606890cf491d23379e426c61f62fc3a0732e 10.0.0.38:6379@16379 slave c5fd06610cd05c760e3fcfb60ad3b4351ce6b309 0 1603610918394 4 connected
1cd30e11cc46cffa0e441c456a2ecf2645a72771 10.0.0.18:6379@16379 master - 0 1603610920412 2 connected 5461-10922
4e42a7dacf7642810aa398817388e1f120649ba7 10.0.0.58:6379@16379 slave 79643546e59ba0e88477e1678dda30c29113dc56 0 1603610919403 6 connected
79643546e59ba0e88477e1678dda30c29113dc56 10.0.0.28:6379@16379 master - 0 1603610920000 3 connected 10923-16383
e1cb57392effcc88a76060104d131044224a8285 10.0.0.48:6379@16379 slave 1cd30e11cc46cffa0e441c456a2ecf2645a72771 0 1603610918000 5 connected
c5fd06610cd05c760e3fcfb60ad3b4351ce6b309 10.0.0.8:6379@16379 myself,master - 0 1603610918000 1 connected 0-5460

[root@redis-node1 ~]#redis-cli -a centos --no-auth-warning --cluster check 10.0.0.38:6379
10.0.0.18:6379 (1cd30e11...) -&gt; 0 keys | 5462 slots | 1 slaves.
10.0.0.8:6379 (c5fd0661...) -&gt; 0 keys | 5461 slots | 1 slaves.
10.0.0.28:6379 (79643546...) -&gt; 0 keys | 5461 slots | 1 slaves.
[OK] 0 keys<span style="color: #a020f0;"> in</span> 3 masters.
0.00 keys per slot on average.
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.38:6379)
S: cbb5606890cf491d23379e426c61f62fc3a0732e 10.0.0.38:6379
   slots: (0 slots) slave
   replicates c5fd06610cd05c760e3fcfb60ad3b4351ce6b309
M: 1cd30e11cc46cffa0e441c456a2ecf2645a72771 10.0.0.18:6379
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
S: 4e42a7dacf7642810aa398817388e1f120649ba7 10.0.0.58:6379
   slots: (0 slots) slave
   replicates 79643546e59ba0e88477e1678dda30c29113dc56
M: c5fd06610cd05c760e3fcfb60ad3b4351ce6b309 10.0.0.8:6379
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
M: 79643546e59ba0e88477e1678dda30c29113dc56 10.0.0.28:6379
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
S: e1cb57392effcc88a76060104d131044224a8285 10.0.0.48:6379
   slots: (0 slots) slave
   replicates 1cd30e11cc46cffa0e441c456a2ecf2645a72771
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:983b1fce-2d78-4c26-87f1-8f0d6b87831a" class="outline-5">
<h5 id="h:983b1fce-2d78-4c26-87f1-8f0d6b87831a">验证集群写入key</h5>
<div class="outline-text-5" id="text-h:983b1fce-2d78-4c26-87f1-8f0d6b87831a">

<figure id="org3d3fc9f">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201025153148481.png" alt="20201025153148481.png">

</figure>
</div>
<ul class="org-ul">
<li><a id="h:b8da393d-1b2e-46c7-9807-3de2d9e9a049"></a>redis cluster 写入key<br>
<div class="outline-text-6" id="text-h:b8da393d-1b2e-46c7-9807-3de2d9e9a049">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#32463;&#36807;&#31639;&#27861;&#35745;&#31639;&#65292;&#24403;&#21069;key&#30340;&#27133;&#20301;&#38656;&#35201;&#20889;&#20837;&#25351;&#23450;&#30340;node</span>
[root@redis-node1 ~]#redis-cli -h 10.0.0.18 -a centos --no-auth-warning set title kobe
(error) MOVED 2217 10.0.0.8:6379    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27133;&#20301;&#19981;&#22312;&#24403;&#21069;node&#25152;&#20197;&#26080;&#27861;&#20889;&#20837;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;node&#21487;&#20889;&#20837;</span>
[root@redis-node1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning set title kobe
OK
[root@redis-node1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning get title 
<span style="color: #8b2252;">"kobe"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#24212;&#30340;slave&#33410;&#28857;&#21487;&#20197;KEYS *,&#20294;GET title&#22833;&#36133;,&#21487;&#20197;&#21040;master&#19978;&#25191;&#34892;GET title</span>
[root@redis-node1 ~]#redis-cli -h 10.0.0.38 -a centos --no-auth-warning keys <span style="color: #8b2252;">"*"</span> 
1) <span style="color: #8b2252;">"title"</span>
[root@redis-node1 ~]#redis-cli -h 10.0.0.38 -a centos --no-auth-warning get title 
(error) MOVED 2217 10.0.0.8:6379

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22686;&#21152;-c &#38598;&#32676;&#27169;&#24335;&#36873;&#39033;&#65292;&#33258;&#21160;&#36830;&#25509;&#21040;&#25351;&#23450;&#30340;&#33410;&#28857;&#20889;&#20837;&#25968;&#25454;</span>
</pre>
</div>
</div>
</li>
<li><a id="h:941dcbf8-2940-4002-a4b7-256887a36827"></a>redis cluster 计算key所属的slot<br>
<div class="outline-text-6" id="text-h:941dcbf8-2940-4002-a4b7-256887a36827">
<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]#redis-cli -a centos --no-auth-warning cluster nodes
cbb5606890cf491d23379e426c61f62fc3a0732e 10.0.0.38:6379@16379 slave c5fd06610cd05c760e3fcfb60ad3b4351ce6b309 0 1603611726494 4 connected
1cd30e11cc46cffa0e441c456a2ecf2645a72771 10.0.0.18:6379@16379 master - 0 1603611725485 2 connected 5461-10922
4e42a7dacf7642810aa398817388e1f120649ba7 10.0.0.58:6379@16379 slave 79643546e59ba0e88477e1678dda30c29113dc56 0 1603611724476 6 connected
79643546e59ba0e88477e1678dda30c29113dc56 10.0.0.28:6379@16379 master - 0 1603611725000 3 connected 10923-16383
e1cb57392effcc88a76060104d131044224a8285 10.0.0.48:6379@16379 slave 1cd30e11cc46cffa0e441c456a2ecf2645a72771 0 1603611724000 5 connected
c5fd06610cd05c760e3fcfb60ad3b4351ce6b309 10.0.0.8:6379@16379 myself,master - 0 1603611724000 1 connected 0-5460

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35745;&#31639;&#24471;&#21040;intel&#23545;&#24212;&#30340;slot</span>
[root@redis-node1 ~]#redis-cli -h 10.0.0.18 -a centos --no-auth-warning cluster keyslot intel
(integer) 5909
[root@redis-node1 ~]#redis-cli -h 10.0.0.18 -a centos --no-auth-warning set intel dell
OK
[root@redis-node1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster keyslot iphone
(integer) 13585
[root@redis-node1 ~]#redis-cli -h 10.0.0.28 -a centos --no-auth-warning set iphone easy
OK
[root@redis-node1 ~]#redis-cli -h 10.0.0.28 -a centos --no-auth-warning get iphone 
<span style="color: #8b2252;">"easy"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#36873;&#39033; -c &#20197;&#38598;&#32676;&#27169;&#24335;&#36830;&#25509;</span>
[root@redis-node1 ~]#redis-cli -c -h 10.0.0.58 -a centos --no-auth-warning 
10.0.0.58:6379&gt; cluster keyslot age
(integer) 741
10.0.0.58:6379&gt; set age 24
-&gt; Redirected to slot [741] located at 10.0.0.8:6379
OK
10.0.0.8:6379&gt; get age
<span style="color: #8b2252;">"24"</span>
10.0.0.8:6379&gt; exit
[root@redis-node1 ~]#redis-cli -c -h 10.0.0.28 -a centos --no-auth-warning get age
<span style="color: #8b2252;">"24"</span>
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:8f8b958a-2ca5-46fc-bb32-417ea5718ed4" class="outline-5">
<h5 id="h:8f8b958a-2ca5-46fc-bb32-417ea5718ed4">python脚本实现RedisCluster集群写入</h5>
<div class="outline-text-5" id="text-h:8f8b958a-2ca5-46fc-bb32-417ea5718ed4">
<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]#yum -y install python3
[root@redis-node1 ~]#pip3 install redis-py-cluster
[root@redis-node1 ~]#cat redis_cluster_test.py 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python3</span>
from rediscluster  import RedisCluster
startup_nodes = [
    {<span style="color: #8b2252;">"host"</span>:<span style="color: #8b2252;">"10.0.0.8"</span>, <span style="color: #8b2252;">"port"</span>:6379},
    {<span style="color: #8b2252;">"host"</span>:<span style="color: #8b2252;">"10.0.0.18"</span>, <span style="color: #8b2252;">"port"</span>:6379},
    {<span style="color: #8b2252;">"host"</span>:<span style="color: #8b2252;">"10.0.0.28"</span>, <span style="color: #8b2252;">"port"</span>:6379},
    {<span style="color: #8b2252;">"host"</span>:<span style="color: #8b2252;">"10.0.0.38"</span>, <span style="color: #8b2252;">"port"</span>:6379},
    {<span style="color: #8b2252;">"host"</span>:<span style="color: #8b2252;">"10.0.0.48"</span>, <span style="color: #8b2252;">"port"</span>:6379},
    {<span style="color: #8b2252;">"host"</span>:<span style="color: #8b2252;">"10.0.0.58"</span>, <span style="color: #8b2252;">"port"</span>:6379}
]
<span style="color: #a0522d;">redis_conn</span>= RedisCluster(<span style="color: #a0522d;">startup_nodes</span>=startup_nodes,<span style="color: #a0522d;">password</span>=<span style="color: #8b2252;">'centos'</span>, <span style="color: #a0522d;">decode_responses</span>=True)

<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> range(0, 10000):
    redis_conn.set(<span style="color: #8b2252;">'key'</span>+str(i),<span style="color: #8b2252;">'value'</span>+str(i))
    print(<span style="color: #8b2252;">'key'</span>+str(i)+<span style="color: #8b2252;">':'</span>,redis_conn.get(<span style="color: #8b2252;">'key'</span>+str(i)))

[root@redis-node1 ~]#chmod +x redis_cluster_test.py
[root@redis-node1 ~]#./redis_cluster_test.py
...&#30465;&#30053;...
key9994: value9994
key9995: value9995
key9996: value9996
key9997: value9997
key9998: value9998
key9999: value9999

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24179;&#22343;&#27599;&#20010;&#33410;&#28857;3000&#22810;</span>
[root@redis-node1 ~]#redis-cli -a centos -h 10.0.0.8
127.0.0.1:6379&gt; DBSIZE
(integer) 3333
127.0.0.1:6379&gt; get key1
(error) MOVED 9189 10.0.0.18:6379
127.0.0.1:6379&gt; get key2
<span style="color: #8b2252;">"value2"</span>
127.0.0.1:6379&gt; get key3
<span style="color: #8b2252;">"value3"</span>
127.0.0.1:6379&gt; KEYS *
...&#30465;&#30053;...
3330) <span style="color: #8b2252;">"key8339"</span>
3331) <span style="color: #8b2252;">"key6248"</span>
3332) <span style="color: #8b2252;">"key5454"</span>
3333) <span style="color: #8b2252;">"key3664"</span>

[root@redis-node1 ~]#redis-cli -a centos --no-auth-warning -h 10.0.0.18 dbsize
(integer) 3341
[root@redis-node1 ~]#redis-cli -a centos --no-auth-warning -h 10.0.0.18 get key1
<span style="color: #8b2252;">"value1"</span>
[root@redis-node1 ~]#redis-cli -a centos --no-auth-warning -h 10.0.0.28 dbsize
(integer) 3330
[root@redis-node1 ~]#redis-cli -a centos --no-auth-warning -h 10.0.0.28 get key4
<span style="color: #8b2252;">"value4"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e9697094-501a-464c-86b1-94ae39369dc1" class="outline-5">
<h5 id="h:e9697094-501a-464c-86b1-94ae39369dc1">模拟master故障，对应的slave节点自动提升为新master</h5>
<div class="outline-text-5" id="text-h:e9697094-501a-464c-86b1-94ae39369dc1">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27169;&#25311;node3&#33410;&#28857;&#20986;&#25925;&#38556;,&#38656;&#35201;&#30456;&#24212;&#30340;&#25968;&#31186;&#25925;&#38556;&#36716;&#31227;&#26102;&#38388;</span>
[root@redis-node3 ~]#tail -f /var/log/redis/redis.log 
[root@redis-node3 ~]#redis-cli -a centos --no-auth-warning
127.0.0.1:6379&gt; shutdown
not connected&gt; exit
[root@redis-node3 ~]#ss -ntl
State       Recv-Q       Send-Q               Local Address:Port               Peer Address:Port       
LISTEN      0            128                        0.0.0.0:22                      0.0.0.0:*          
LISTEN      0            128                           [::]:22                         [::]:*

[root@redis-node3 ~]#redis-cli -a centos --no-auth-warning --cluster info 10.0.0.8:6379
Could not connect to Redis at 10.0.0.28:6379: Connection refused
10.0.0.8:6379 (c5fd0661...) -&gt; 3333 keys | 5461 slots | 1 slaves.
10.0.0.18:6379 (1cd30e11...) -&gt; 3341 keys | 5462 slots | 1 slaves.
10.0.0.58:6379 (4e42a7da...) -&gt; 3330 keys | 5461 slots | 0 slaves.      <span style="color: #b22222;">#</span><span style="color: #b22222;">10.0.0.58&#20026;&#26032;&#30340;master</span>
[OK] 10004 keys<span style="color: #a020f0;"> in</span> 3 masters.
0.61 keys per slot on average.

[root@redis-node3 ~]#redis-cli -a centos --no-auth-warning --cluster check 10.0.0.8:6379
Could not connect to Redis at 10.0.0.28:6379: Connection refused
10.0.0.8:6379 (c5fd0661...) -&gt; 3333 keys | 5461 slots | 1 slaves.
10.0.0.18:6379 (1cd30e11...) -&gt; 3341 keys | 5462 slots | 1 slaves.
10.0.0.58:6379 (4e42a7da...) -&gt; 3330 keys | 5461 slots | 0 slaves.
[OK] 10004 keys<span style="color: #a020f0;"> in</span> 3 masters.
0.61 keys per slot on average.
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.8:6379)
M: c5fd06610cd05c760e3fcfb60ad3b4351ce6b309 10.0.0.8:6379
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
S: cbb5606890cf491d23379e426c61f62fc3a0732e 10.0.0.38:6379
   slots: (0 slots) slave
   replicates c5fd06610cd05c760e3fcfb60ad3b4351ce6b309
M: 1cd30e11cc46cffa0e441c456a2ecf2645a72771 10.0.0.18:6379
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
M: 4e42a7dacf7642810aa398817388e1f120649ba7 10.0.0.58:6379
   slots:[10923-16383] (5461 slots) master
S: e1cb57392effcc88a76060104d131044224a8285 10.0.0.48:6379
   slots: (0 slots) slave
   replicates 1cd30e11cc46cffa0e441c456a2ecf2645a72771
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.

[root@redis-node3 ~]#redis-cli -a centos --no-auth-warning -h 10.0.0.58
10.0.0.58:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:0
master_replid:f24aaee34b6062bcef89618129a13cdea0f37f04
master_replid2:b1f5dda97b2f7fe4bb07ffe61272bdb71e1d2cfa
master_repl_offset:141005
second_repl_offset:141006
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:141005

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24674;&#22797;&#25925;&#38556;&#33410;&#28857;node3</span>
[root@redis-node3 ~]#systemctl start redis

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#33258;&#21160;&#29983;&#25104;&#30340;&#37197;&#32622;&#25991;&#20214;&#65292;&#21487;&#20197;&#26597;&#30475;node3&#33258;&#21160;&#29983;&#25104;slave&#33410;&#28857;</span>
[root@redis-node3 ~]#cat /var/lib/redis/nodes-6379.conf 
79643546e59ba0e88477e1678dda30c29113dc56 10.0.0.28:6379@16379 myself,slave 4e42a7dacf7642810aa398817388e1f120649ba7 0 1603613511309 3 connected
e1cb57392effcc88a76060104d131044224a8285 10.0.0.48:6379@16379 slave 1cd30e11cc46cffa0e441c456a2ecf2645a72771 0 1603613511329 5 connected
4e42a7dacf7642810aa398817388e1f120649ba7 10.0.0.58:6379@16379 master - 0 1603613511329 7 connected 10923-16383
c5fd06610cd05c760e3fcfb60ad3b4351ce6b309 10.0.0.8:6379@16379 master - 0 1603613511330 1 connected 0-5460
1cd30e11cc46cffa0e441c456a2ecf2645a72771 10.0.0.18:6379@16379 master - 0 1603613511330 2 connected 5461-10922
cbb5606890cf491d23379e426c61f62fc3a0732e 10.0.0.38:6379@16379 slave c5fd06610cd05c760e3fcfb60ad3b4351ce6b309 0 1603613511330 4 connected
vars currentEpoch 7 lastVoteEpoch 0

[root@redis-node3 ~]#redis-cli -a centos --no-auth-warning -h 10.0.0.58
10.0.0.58:6379&gt; info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:1
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.28,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=142559,<span style="color: #a0522d;">lag</span>=1
master_replid:f24aaee34b6062bcef89618129a13cdea0f37f04
master_replid2:b1f5dda97b2f7fe4bb07ffe61272bdb71e1d2cfa
master_repl_offset:142559
second_repl_offset:141006
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:142559
10.0.0.58:6379&gt; 
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:287bcdf6-3cc2-49be-96f9-9119d2e9926b" class="outline-4">
<h4 id="h:287bcdf6-3cc2-49be-96f9-9119d2e9926b">原生命令手动部署</h4>
<div class="outline-text-4" id="text-h:287bcdf6-3cc2-49be-96f9-9119d2e9926b">
</div>
<div id="outline-container-h:dba39647-8e95-4b49-92f0-10995a629775" class="outline-5">
<h5 id="h:dba39647-8e95-4b49-92f0-10995a629775">原生命令手动部署过程</h5>
<div class="outline-text-5" id="text-h:dba39647-8e95-4b49-92f0-10995a629775">
<ul class="org-ul">
<li>在所有节点安装redis,并配置开启cluster功能</li>
<li>各个节点执行meet,实现所有节点的相互通信</li>
<li>为各个master 节点指派槽位范围</li>
<li>指定各个节点的主从关系</li>
</ul>
</div>
</div>
<div id="outline-container-h:11ea6c08-8576-4a32-9e49-3ed712dde9a4" class="outline-5">
<h5 id="h:11ea6c08-8576-4a32-9e49-3ed712dde9a4">实战案例: 利用原生命令手动部署redis cluster</h5>
<div class="outline-text-5" id="text-h:11ea6c08-8576-4a32-9e49-3ed712dde9a4">
</div>
<ul class="org-ul">
<li><a id="h:7fe665d7-1844-4c02-b221-fdb08ed27cf7"></a>在所有节点安装redis并启动cluster功能<br>
<div class="outline-text-6" id="text-h:7fe665d7-1844-4c02-b221-fdb08ed27cf7">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#25152;&#26377;6&#20010;&#33410;&#28857;&#19978;&#20998;&#21035;&#25191;&#34892;&#19979;&#38754;&#30456;&#21516;&#30340;&#25805;&#20316;&#65292;&#20197;master1&#20026;&#20363;</span>
[root@master1 ~]#dnf -y install redis

[root@master1 ~]#cat init.sh 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
sed -i -e <span style="color: #8b2252;">"s/bind 127.0.0.1/bind 0.0.0.0/"</span> -e <span style="color: #8b2252;">"s/^# masterauth.*/masterauth centos/"</span> -e <span style="color: #8b2252;">"s/^# requirepass .*/requirepass centos/"</span> -e <span style="color: #8b2252;">"/# cluster-enabled yes/a cluster-enabled yes"</span> -e <span style="color: #8b2252;">"/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf"</span> -e <span style="color: #8b2252;">"/# cluster-require-full-coverage yes/c cluster-require-full-coverage no"</span> /etc/redis.conf

<span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">"net.core.somaxconn = 1024\nvm.overcommit_memory = 1"</span> &gt;&gt; /etc/sysctl.conf 
sysctl -p
<span style="color: #483d8b;">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled"</span> &gt;&gt; /etc/rc.d/rc.local 
chmod +x /etc/rc.d/rc.local 
systemctl enable --now redis

[root@master1 ~]#bash init.sh 
net.core.somaxconn = 1024
vm.overcommit_memory = 1
Created symlink /etc/systemd/system/multi-user.target.wants/redis.service &#8594; /usr/lib/systemd/system/redis.service.
</pre>
</div>
</div>
</li>
<li><a id="h:ea8d6058-8852-45ea-bb20-003214286c64"></a>执行 meet 操作实现相互通信<br>
<div class="outline-text-6" id="text-h:ea8d6058-8852-45ea-bb20-003214286c64">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#20219;&#24847;&#19968;&#33410;&#28857;&#19978;&#21644;&#20854;&#23427;&#25152;&#26377;&#33410;&#28857;&#36827;&#34892;meet&#36890;&#20449;&#65292;&#20197;master1&#20026;&#20363;</span>
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster meet 10.0.0.18 6379
OK
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster meet 10.0.0.28 6379
OK
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster meet 10.0.0.38 6379
OK
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster meet 10.0.0.48 6379
OK
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster meet 10.0.0.58 6379
OK

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#21040;&#25152;&#26377;&#33410;&#28857;&#20043;&#38388;&#21487;&#20197;&#30456;&#20114;&#36830;&#25509;&#36890;&#20449;&#65292;&#20197;master2&#20026;&#20363;</span>
[root@master2 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster nodes
1cfaebb336bc8f8381675bcf13bac143f54bba98 10.0.0.8:6379@16379 myself,master - 0 1603596093000 1 connected
6c346914678b603922c40ac338e376f1d47a273a 10.0.0.28:6379@16379 master - 0 1603596093933 2 connected
b8de597cc5447a02bf94d30bf5ad2be3f8ad3e98 10.0.0.18:6379@16379 master - 0 1603596094940 5 connected
d8e84b667c744b062819ae173ec501f64792e259 10.0.0.58:6379@16379 master - 0 1603596092923 0 connected
7b165b3b14f93030460a488588b7b73cf00170e1 10.0.0.38:6379@16379 master - 0 1603596092000 3 connected
b192b184753d3956df1eda83110f4a2b8456d3f4 10.0.0.48:6379@16379 master - 0 1603596094000 4 connected

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30001;&#20110;&#27809;&#26377;&#20998;&#37197;&#27133;&#20301;&#65292;&#26080;&#27861;&#21019;&#24314;key&#65292;&#20197;master1&#20026;&#20363;</span>
[root@master1 ~]#redis-cli -a centos --no-auth-warning set name kobe
(error) CLUSTERDOWN Hash slot not served

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#29366;&#24577;&#65292;&#20197;master1&#20026;&#20363;</span>
[root@master1 ~]#redis-cli -a centos --no-auth-warning cluster info
cluster_state:fail
cluster_slots_assigned:0
cluster_slots_ok:0
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:0
cluster_current_epoch:5
cluster_my_epoch:1
cluster_stats_messages_ping_sent:996
cluster_stats_messages_pong_sent:904
cluster_stats_messages_meet_sent:5
cluster_stats_messages_sent:1905
cluster_stats_messages_ping_received:904
cluster_stats_messages_pong_received:1001
cluster_stats_messages_received:1905
</pre>
</div>
</div>
</li>
<li><a id="h:10553470-405d-4340-aa49-579a1fb757f7"></a>为每个master 节点指派槽位范围<br>
<div class="outline-text-6" id="text-h:10553470-405d-4340-aa49-579a1fb757f7">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#28155;&#21152;&#27133;&#20301;&#30340;&#33050;&#26412;</span>
[root@master1 ~]#cat addslots.sh 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>
<span style="color: #a0522d;">HOST</span>=$<span style="color: #a0522d;">1</span>
<span style="color: #a0522d;">PORT</span>=$<span style="color: #a0522d;">2</span>
<span style="color: #a0522d;">START</span>=$<span style="color: #a0522d;">3</span>
<span style="color: #a0522d;">END</span>=$<span style="color: #a0522d;">4</span>
<span style="color: #a0522d;">PASS</span>=centos

<span style="color: #a020f0;">for</span> slot<span style="color: #a020f0;"> in</span> <span style="color: #ff00ff;">`seq ${START} ${END}`</span>;<span style="color: #a020f0;">do</span>
    <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"slot: ${slot}"</span>
    redis-cli -h ${<span style="color: #a0522d;">HOST</span>} -p ${<span style="color: #a0522d;">PORT</span>} -a ${<span style="color: #a0522d;">PASS</span>} --no-auth-warning cluster addslots ${<span style="color: #a0522d;">slot</span>}
<span style="color: #a020f0;">done</span>    

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#19977;&#20010;master&#20998;&#37197;&#27133;&#20301;&#65292;&#20849;16364/3=5461.33333&#65292;&#24179;&#22343;&#27599;&#20010;master&#20998;&#37197;5461&#20010;&#27133;&#20301;</span>
[root@master1 ~]#bash addslots.sh 10.0.0.8 6379 0 5461
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;master1&#20998;&#37197;&#23436;&#27133;&#20301;&#21518;&#65292;&#21487;&#20197;&#30475;&#21040;&#19979;&#38754;&#20449;&#24687;</span>
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster info
cluster_state:ok
cluster_slots_assigned:5462
cluster_slots_ok:5462
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:1
cluster_current_epoch:5
cluster_my_epoch:3
cluster_stats_messages_ping_sent:462
cluster_stats_messages_pong_sent:437
cluster_stats_messages_meet_sent:5
cluster_stats_messages_sent:904
cluster_stats_messages_ping_received:437
cluster_stats_messages_pong_received:467
cluster_stats_messages_received:904
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster nodes
dbae66fb89395bb02525c0846a75a9eefbc52e24 10.0.0.38:6379@16379 master - 0 1603604525407 0 connected
a38268c05385eda78b7422f18316457124b6b547 10.0.0.58:6379@16379 master - 0 1603604524000 5 connected
b5b1e13fc2677ce738cb3a6389ca3a5b062f436d 10.0.0.8:6379@16379 myself,master - 0 1603604524000 3 connected 0-5461
7a58e458d6277faffa70ca3344b518f9bfd42ac8 10.0.0.18:6379@16379 master - 0 1603604524398 1 connected
2fd6acebfcccb33ad2fc252164d37971275ae3de 10.0.0.48:6379@16379 master - 0 1603604523000 4 connected
3621fe94c4a121280fc8f2b7de2dcd8c0ec8bca8 10.0.0.28:6379@16379 master - 0 1603604523390 2 connected

[root@master1 ~]#bash addslots.sh 10.0.0.8 6379 5462 10922
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster info
cluster_state:ok
cluster_slots_assigned:10923
cluster_slots_ok:10923
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:2
cluster_current_epoch:5
cluster_my_epoch:3
cluster_stats_messages_ping_sent:806
cluster_stats_messages_pong_sent:760
cluster_stats_messages_meet_sent:5
cluster_stats_messages_sent:1571
cluster_stats_messages_ping_received:760
cluster_stats_messages_pong_received:811
cluster_stats_messages_received:1571
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster nodes
dbae66fb89395bb02525c0846a75a9eefbc52e24 10.0.0.38:6379@16379 master - 0 1603604907785 0 connected
a38268c05385eda78b7422f18316457124b6b547 10.0.0.58:6379@16379 master - 0 1603604909000 5 connected
b5b1e13fc2677ce738cb3a6389ca3a5b062f436d 10.0.0.8:6379@16379 myself,master - 0 1603604908000 3 connected 0-5461
7a58e458d6277faffa70ca3344b518f9bfd42ac8 10.0.0.18:6379@16379 master - 0 1603604910807 1 connected 5462-10922
2fd6acebfcccb33ad2fc252164d37971275ae3de 10.0.0.48:6379@16379 master - 0 1603604909800 4 connected
3621fe94c4a121280fc8f2b7de2dcd8c0ec8bca8 10.0.0.28:6379@16379 master - 0 1603604909000 2 connected

[root@master1 ~]#bash addslots.sh 10.0.0.28 6379 10923 16383
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:5
cluster_my_epoch:3
cluster_stats_messages_ping_sent:963
cluster_stats_messages_pong_sent:909
cluster_stats_messages_meet_sent:5
cluster_stats_messages_sent:1877
cluster_stats_messages_ping_received:909
cluster_stats_messages_pong_received:968
cluster_stats_messages_received:1877
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster nodes
dbae66fb89395bb02525c0846a75a9eefbc52e24 10.0.0.38:6379@16379 master - 0 1603605019774 0 connected
a38268c05385eda78b7422f18316457124b6b547 10.0.0.58:6379@16379 master - 0 1603605020782 5 connected
b5b1e13fc2677ce738cb3a6389ca3a5b062f436d 10.0.0.8:6379@16379 myself,master - 0 1603605020000 3 connected 0-5461
7a58e458d6277faffa70ca3344b518f9bfd42ac8 10.0.0.18:6379@16379 master - 0 1603605018766 1 connected 5462-10922
2fd6acebfcccb33ad2fc252164d37971275ae3de 10.0.0.48:6379@16379 master - 0 1603605018000 4 connected
3621fe94c4a121280fc8f2b7de2dcd8c0ec8bca8 10.0.0.28:6379@16379 master - 0 1603605019000 2 connected 10923-16383

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#37197;&#27133;&#20301;&#21518;&#21487;&#20197;&#21019;&#24314;key</span>
[root@master1 ~]#redis-cli -a centos --no-auth-warning set name kobe
(error) MOVED 5798 10.0.0.18:6379
[root@master1 ~]#redis-cli -h 10.0.0.18 -a centos --no-auth-warning set name kobe
OK
[root@master1 ~]#redis-cli -h 10.0.0.18 -a centos --no-auth-warning get name 
<span style="color: #8b2252;">"kobe"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#25152;&#26377;&#30340;&#19977;&#20010;master&#20998;&#37197;&#23436;&#27133;&#20301;&#21518;&#65292;&#21487;&#20197;&#30475;&#21040;&#22914;&#19979;&#20449;&#24687;&#65292;&#20197;master1&#20026;&#20363;&#65292;&#22312;&#20854;&#23427;&#20027;&#26426;&#30475;&#21040;&#30340;&#20449;&#24687;&#19968;&#26679;</span>
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:5
cluster_my_epoch:3
cluster_stats_messages_ping_sent:1240
cluster_stats_messages_pong_sent:1174
cluster_stats_messages_meet_sent:5
cluster_stats_messages_sent:2419
cluster_stats_messages_ping_received:1174
cluster_stats_messages_pong_received:1245
cluster_stats_messages_received:2419
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster nodes
dbae66fb89395bb02525c0846a75a9eefbc52e24 10.0.0.38:6379@16379 master - 0 1603605292213 0 connected
a38268c05385eda78b7422f18316457124b6b547 10.0.0.58:6379@16379 master - 0 1603605292000 5 connected
b5b1e13fc2677ce738cb3a6389ca3a5b062f436d 10.0.0.8:6379@16379 myself,master - 0 1603605289000 3 connected 0-5461
7a58e458d6277faffa70ca3344b518f9bfd42ac8 10.0.0.18:6379@16379 master - 0 1603605291000 1 connected 5462-10922
2fd6acebfcccb33ad2fc252164d37971275ae3de 10.0.0.48:6379@16379 master - 0 1603605293221 4 connected
3621fe94c4a121280fc8f2b7de2dcd8c0ec8bca8 10.0.0.28:6379@16379 master - 0 1603605291205 2 connected 10923-16383
</pre>
</div>
</div>
</li>
<li><a id="h:47a171aa-65e9-43fd-bc83-40078548b1a4"></a>指定各个节点的主从关系<br>
<div class="outline-text-6" id="text-h:47a171aa-65e9-43fd-bc83-40078548b1a4">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;&#19978;&#38754;&#30340;cluster nodes &#26597;&#30475;master&#30340;ID&#20449;&#24687;&#65292;&#25191;&#34892;&#19979;&#38754;&#25805;&#20316;&#65292;&#23558;&#23545;&#24212;&#30340;slave &#25351;&#23450;&#30456;&#24212;&#30340;master&#33410;&#28857;&#65292;&#23454;&#29616;&#19977;&#23545;&#20027;&#20174;&#33410;&#28857;</span>
[root@master1 ~]#redis-cli -h 10.0.0.38 -a centos --no-auth-warning cluster replicate b5b1e13fc2677ce738cb3a6389ca3a5b062f436d
OK
[root@master1 ~]#redis-cli -h 10.0.0.48 -a centos --no-auth-warning cluster replicate 7a58e458d6277faffa70ca3344b518f9bfd42ac8
OK
[root@master1 ~]#redis-cli -h 10.0.0.58 -a centos --no-auth-warning cluster replicate 3621fe94c4a121280fc8f2b7de2dcd8c0ec8bca8
OK

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#31532;&#19968;&#32452;master1/slave1&#20027;&#20174;&#33410;&#28857;&#21019;&#24314;&#25104;&#21151;&#21518;&#65292;&#21487;&#20197;&#30475;&#21040;&#19979;&#38754;&#20449;&#24687;</span>
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:1
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.38,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=644,<span style="color: #a0522d;">lag</span>=0
master_replid:5c8b4df45cfd7f6b224b918ca8b25677a6a614bc
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:644
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:644
[root@master1 ~]#redis-cli -h 10.0.0.38 -a centos --no-auth-warning info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.8
master_port:6379
master_link_status:up
master_last_io_seconds_ago:4
master_sync_in_progress:0
slave_repl_offset:938
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:5c8b4df45cfd7f6b224b918ca8b25677a6a614bc
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:938
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:938

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#19977;&#32452;&#20027;&#20174;&#33410;&#28857;&#21019;&#24314;&#25104;&#21151;&#21518;&#65292;&#21487;&#20197;&#30475;&#21040;&#19979;&#38754;&#20449;&#24687;</span>
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster nodes
dbae66fb89395bb02525c0846a75a9eefbc52e24 10.0.0.38:6379@16379 slave b5b1e13fc2677ce738cb3a6389ca3a5b062f436d 0 1603606378692 3 connected
a38268c05385eda78b7422f18316457124b6b547 10.0.0.58:6379@16379 slave 3621fe94c4a121280fc8f2b7de2dcd8c0ec8bca8 0 1603606377680 5 connected
b5b1e13fc2677ce738cb3a6389ca3a5b062f436d 10.0.0.8:6379@16379 myself,master - 0 1603606377000 3 connected 0-5461
7a58e458d6277faffa70ca3344b518f9bfd42ac8 10.0.0.18:6379@16379 master - 0 1603606375000 1 connected 5462-10922
2fd6acebfcccb33ad2fc252164d37971275ae3de 10.0.0.48:6379@16379 slave 7a58e458d6277faffa70ca3344b518f9bfd42ac8 0 1603606378000 4 connected
3621fe94c4a121280fc8f2b7de2dcd8c0ec8bca8 10.0.0.28:6379@16379 master - 0 1603606375664 2 connected 10923-16383
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:5
cluster_my_epoch:3
cluster_stats_messages_ping_sent:2349
cluster_stats_messages_pong_sent:2199
cluster_stats_messages_meet_sent:5
cluster_stats_messages_sent:4553
cluster_stats_messages_ping_received:2199
cluster_stats_messages_pong_received:2354
cluster_stats_messages_received:4553
[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:1
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.38,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=1078,<span style="color: #a0522d;">lag</span>=1
master_replid:5c8b4df45cfd7f6b224b918ca8b25677a6a614bc
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:1078
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:1078
[root@master1 ~]#redis-cli -h 10.0.0.18 -a centos --no-auth-warning info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:1
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.48,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=882,<span style="color: #a0522d;">lag</span>=1
master_replid:20a78d626054724fd2603dd9898dbeae04f35b17
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:882
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:882
[root@master1 ~]#redis-cli -h 10.0.0.28 -a centos --no-auth-warning info replication
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:1
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.58,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=784,<span style="color: #a0522d;">lag</span>=1
master_replid:cb2c0f7b539e527518bc523ec1c1735edf73aa66
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:784
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:784

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20027;&#20174;&#33410;&#28857;&#20851;&#31995;&#21450;&#27133;&#20301;&#20449;&#24687;</span>
[root@master1 ~]#redis-cli -h 10.0.0.18 -a centos --no-auth-warning cluster slots
1) 1) (integer) 0
   2) (integer) 5461
   3) 1) <span style="color: #8b2252;">"10.0.0.8"</span>
      2) (integer) 6379
      3) <span style="color: #8b2252;">"b5b1e13fc2677ce738cb3a6389ca3a5b062f436d"</span>
   4) 1) <span style="color: #8b2252;">"10.0.0.38"</span>
      2) (integer) 6379
      3) <span style="color: #8b2252;">"dbae66fb89395bb02525c0846a75a9eefbc52e24"</span>
2) 1) (integer) 10923
   2) (integer) 16383
   3) 1) <span style="color: #8b2252;">"10.0.0.28"</span>
      2) (integer) 6379
      3) <span style="color: #8b2252;">"3621fe94c4a121280fc8f2b7de2dcd8c0ec8bca8"</span>
   4) 1) <span style="color: #8b2252;">"10.0.0.58"</span>
      2) (integer) 6379
      3) <span style="color: #8b2252;">"a38268c05385eda78b7422f18316457124b6b547"</span>
3) 1) (integer) 5462
   2) (integer) 10922
   3) 1) <span style="color: #8b2252;">"10.0.0.18"</span>
      2) (integer) 6379
      3) <span style="color: #8b2252;">"7a58e458d6277faffa70ca3344b518f9bfd42ac8"</span>
   4) 1) <span style="color: #8b2252;">"10.0.0.48"</span>
      2) (integer) 6379
      3) <span style="color: #8b2252;">"2fd6acebfcccb33ad2fc252164d37971275ae3de"</span>
</pre>
</div>
</div>
</li>
<li><a id="h:bbb524fe-a794-47d1-af88-d6f70e91bddc"></a>验证 redis cluster 访问<br>
<div class="outline-text-6" id="text-h:bbb524fe-a794-47d1-af88-d6f70e91bddc">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">-c &#34920;&#31034;&#20197;&#38598;&#32676;&#26041;&#24335;&#36830;&#25509;</span>
[root@master1 ~]#redis-cli -c -h 10.0.0.8 -a centos --no-auth-warning set web kobe
OK
[root@master1 ~]#redis-cli -c -h 10.0.0.8 -a centos --no-auth-warning get web
<span style="color: #8b2252;">"kobe"</span>

[root@master1 ~]#redis-cli -h 10.0.0.8 -a centos --no-auth-warning get web
(error) MOVED 9635 10.0.0.18:6379
[root@master1 ~]#redis-cli -h 10.0.0.18 -a centos --no-auth-warning get web
<span style="color: #8b2252;">"kobe"</span>
[root@master1 ~]#redis-cli -h 10.0.0.28 -a centos --no-auth-warning get web
(error) MOVED 9635 10.0.0.18:6379
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:96d52a33-80da-4f8e-a1fe-da290f020183" class="outline-4">
<h4 id="h:96d52a33-80da-4f8e-a1fe-da290f020183">实战案例：基于Redis 4 的 redis cluster 部署</h4>
<div class="outline-text-4" id="text-h:96d52a33-80da-4f8e-a1fe-da290f020183">
</div>
<div id="outline-container-h:bd9a847e-b1ee-4b25-a0d5-a14f5eb1896c" class="outline-5">
<h5 id="h:bd9a847e-b1ee-4b25-a0d5-a14f5eb1896c">准备redis Cluster 基本配置</h5>
<div class="outline-text-5" id="text-h:bd9a847e-b1ee-4b25-a0d5-a14f5eb1896c">
<ol class="org-ol">
<li>每个redis 节点采用相同的硬件配置、相同的密码、相同的redis版本</li>

<li>所有redis服务器必须没有任何数据</li>

<li><p>
准备3台CentOS 7
主机，以编译安装好redis，各启动两个redis实例，分别使用6379和6380端口，从而模拟实现6台redis实例
</p>

<div class="org-src-container">
<pre class="src src-sh">10.0.0.7:6379|6380
10.0.0.17:6379|6380
10.0.0.27:6379|6380
</pre>
</div></li>
</ol>

<p>
范例：6个物理节点环境的基于脚本安装后批量修改配置
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos7 ~]#sed -i -e <span style="color: #8b2252;">'/^# masterauth/a masterauth 123456'</span> -e <span style="color: #8b2252;">'/# clusterenabled</span>
<span style="color: #8b2252;">yes/a cluster-enabled yes'</span> -e <span style="color: #8b2252;">'/# cluster-config-file nodes-6379.conf/a</span>
<span style="color: #8b2252;">cluster-config-file nodes-6379.conf'</span> -e <span style="color: #8b2252;">'/cluster-require-full-coverage yes/c</span>
<span style="color: #8b2252;">cluster-require-full-coverage no'</span> /apps/redis/etc/redis.conf

[root@centos7 ~]#grep <span style="color: #8b2252;">'^[^#]'</span> /apps/redis/etc/redis.conf
<span style="color: #483d8b;">bind</span> 0.0.0.0
protected-mode yes
port 6379
tcp-backlog 511
timeout 0
tcp-keepalive 300
daemonize no
supervised no
pidfile /apps/redis/run/redis_6379.pid
loglevel notice
logfile /apps/redis/log/redis-6379.log
databases 16
always-show-logo yes
save 900 1
save 300 10
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /apps/redis/data/
masterauth 123456
slave-serve-stale-data yes
slave-read-only yes
repl-diskless-sync no
repl-diskless-sync-delay 5
repl-disable-tcp-nodelay no
slave-priority 100
requirepass 123456
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
slave-lazy-flush no
appendonly no
appendfilename <span style="color: #8b2252;">"appendonly.aof"</span>
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble no
lua-time-limit 5000
cluster-enabled yes
cluster-config-file nodes-6379.conf
cluster-require-full-coverage no
slowlog-log-slower-than 10000
slowlog-max-len 128
latency-monitor-threshold 0
notify-keyspace-events <span style="color: #8b2252;">""</span>
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000
activerehashing yes
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit slave 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60
hz 10
aof-rewrite-incremental-fsync yes
</pre>
</div>

<p>
<b>准备6个实例：在三个主机上重复下面的操作</b>
</p>

<p>
范例：3个节点实现6个实例
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#19977;&#21488;&#20027;&#26426;&#19978;&#37117;&#32534;&#35793;&#23433;&#35013;redis&#65292;&#20197;node1&#20026;&#20363;</span>
[root@redis-node1 ~]# yum -y install gcc jemalloc-devel
[root@redis-node1 ~]# cd /usr/local/src/
[root@redis-node1 src]# wget http://download.redis.io/releases/redis-4.0.14.tar.gz
[root@redis-node1 src]# tar xf redis-4.0.14.tar.gz
[root@redis-node1 src]# cd redis-4.0.14
[root@redis-node1 redis-4.0.14]# make <span style="color: #a0522d;">PREFIX</span>=/apps/redis install

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20934;&#22791;&#30456;&#20851;&#25991;&#20214;&#21644;&#30446;&#24405;</span>
[root@redis-node1 redis-4.0.14]# ln -s /apps/redis/bin/* /usr/bin/
[root@redis-node1 redis-4.0.14]# mkdir -p /apps/redis/{etc,log,run,data}
[root@redis-node1 redis-4.0.14]# cp redis.conf /apps/redis/etc/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20934;&#22791;&#29992;&#25143;</span>
[root@redis-node1 redis-4.0.14]# cd
[root@redis-node1 ~]# useradd -r -s /sbin/nologin redis

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#26435;&#38480;&#21644;&#30456;&#20851;&#20248;&#21270;&#37197;&#32622;</span>
[root@redis-node1 ~]# chown -R redis.redis /apps/redis
[root@redis-node1 ~]# cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF
<span style="color: #ffa54f;">&gt; net.core.somaxconn = 1024</span>
<span style="color: #ffa54f;">&gt; vm.overcommit_memory = 1</span>
<span style="color: #ffa54f;">&gt; EOF</span>
<span style="color: #ffa54f;">[root@redis-node1 ~]# sysctl -p</span>
<span style="color: #ffa54f;">[root@redis-node1 ~]# echo 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled' &gt;&gt; /etc/rc.d/rc.local</span>
<span style="color: #ffa54f;">[root@redis-node1 ~]# chmod +x /etc/rc.d/rc.local</span>
<span style="color: #ffa54f;">[root@redis-node1 ~]# /etc/rc.d/rc.local</span>

<span style="color: #ffa54f;">#&#20934;&#22791;service&#25991;&#20214;</span>
<span style="color: #ffa54f;">[root@redis-node1 ~]# cat &gt; /usr/lib/systemd/system/redis.service &lt;&lt;EOF</span>
<span style="color: #ffa54f;">&gt; [Unit]</span>
<span style="color: #ffa54f;">&gt; Description=Redis persistent key-value database</span>
<span style="color: #ffa54f;">&gt; After=network.target</span>
<span style="color: #ffa54f;">&gt; </span>
<span style="color: #ffa54f;">&gt; [Service]</span>
<span style="color: #ffa54f;">&gt; ExecStart=/apps/redis/bin/redis-server /apps/redis/etc/redis.conf --supervised systemd</span>
<span style="color: #ffa54f;">&gt; ExecStop=/bin/kill -s QUIT \$MAINPID</span>
<span style="color: #ffa54f;">&gt; Type=notify</span>
<span style="color: #ffa54f;">&gt; User=redis</span>
<span style="color: #ffa54f;">&gt; Group=redis</span>
<span style="color: #ffa54f;">&gt; RuntimeDirectory=redis</span>
<span style="color: #ffa54f;">&gt; RuntimeDirectoryMode=0755</span>
<span style="color: #ffa54f;">&gt; </span>
<span style="color: #ffa54f;">&gt; [Install]</span>
<span style="color: #ffa54f;">&gt; WantedBy=multi-user.target</span>
<span style="color: #ffa54f;">&gt; EOF</span>

<span style="color: #ffa54f;">[root@redis-node1 ~]# systemctl daemon-reload</span>
<span style="color: #ffa54f;">[root@redis-node1 ~]# systemctl enable --now redis</span>

<span style="color: #ffa54f;">#&#20934;&#22791;6379&#30340;&#23454;&#20363;&#37197;&#32622;&#25991;&#20214;</span>
<span style="color: #ffa54f;">[root@redis-node1 ~]# systemctl stop redis</span>
<span style="color: #ffa54f;">[root@redis-node1 ~]# cd /apps/redis/etc</span>
<span style="color: #ffa54f;">[root@redis-node1 etc]# sed -i.bak -e 's/bind 127.0.0.1/bind 0.0.0.0/' -e '/^# masterauth/a masterauth 123456' -e '/# requirepass/a requirepass 123456' -e '/# cluster-enabled yes/a cluster-enabled yes' -e '/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf' -e 's/^dir .*/dir \/apps\/redis\/data/' -e '/appendonly no/c appendonly yes' -e '/logfile ""/c logfile "/apps/redis/log/redis-6379.log"' -e '/^pidfile .*/c pidfile /apps/redis/run/redis_6379.pid' /apps/redis/etc/redis.conf</span>

<span style="color: #ffa54f;">#&#20934;&#22791;6380&#31471;&#21475;&#30340;&#23454;&#20363;&#30340;&#37197;&#32622;&#25991;&#20214;</span>
<span style="color: #ffa54f;">[root@redis-node1 etc]# cp -a redis.conf redis6380.conf</span>
<span style="color: #ffa54f;">[root@redis-node1 etc]# sed -i.bak -e 's/6379/6380/' -e 's/dbfilename dump\.rdb/dbfilename dump6380.rdb/' -e 's/appendfilename "appendonly\.aof"/appendfilename "appendonly6380.aof"/' /apps/redis/etc/redis6380.conf</span>

<span style="color: #ffa54f;">#&#20934;&#22791;&#26381;&#21153;&#25991;&#20214;</span>
<span style="color: #ffa54f;">[root@redis-node1 etc]# cp /lib/systemd/system/redis.service /lib/systemd/system/redis6380.service</span>
<span style="color: #ffa54f;">[root@redis-node1 etc]# sed -i 's/redis.conf/redis6380.conf/' /lib/systemd/system/redis6380.service</span>

<span style="color: #ffa54f;">#&#21551;&#21160;&#26381;&#21153;&#65292;&#26597;&#30475;&#21040;&#31471;&#21475;&#37117;&#25171;&#24320;</span>
<span style="color: #ffa54f;">[root@redis-node1 etc]# systemctl daemon-reload</span>
<span style="color: #ffa54f;">[root@redis-node1 etc]# systemctl enable --now redis redis6380</span>
<span style="color: #ffa54f;">Created symlink from /etc/systemd/system/multi-user.target.wants/redis6380.service to /usr/lib/systemd/system/redis6380.service.</span>
<span style="color: #ffa54f;">[root@redis-node1 etc]# ss -ntl</span>
<span style="color: #ffa54f;">State       Recv-Q Send-Q      Local Address:Port                     Peer Address:Port              </span>
<span style="color: #ffa54f;">LISTEN      0      100             127.0.0.1:25                                  *:*                  </span>
<span style="color: #ffa54f;">LISTEN      0      511                     *:16379                               *:*                  </span>
<span style="color: #ffa54f;">LISTEN      0      511                     *:16380                               *:*                  </span>
<span style="color: #ffa54f;">LISTEN      0      511                     *:6379                                *:*                  </span>
<span style="color: #ffa54f;">LISTEN      0      511                     *:6380                                *:*                  </span>
<span style="color: #ffa54f;">LISTEN      0      128                     *:22                                  *:*                  </span>
<span style="color: #ffa54f;">LISTEN      0      100                 [::1]:25                               [::]:*                  </span>
<span style="color: #ffa54f;">LISTEN      0      128                  [::]:22                               [::]:* </span>

<span style="color: #ffa54f;">[root@redis-node1 etc]# ps -aux | grep redis</span>
<span style="color: #ffa54f;">redis      4681  0.0  0.3 145416  3024 ?        Ssl  17:25   0:00 /apps/redis/bin/redis-server 0.0.0.0:6379 [cluster]</span>
<span style="color: #ffa54f;">redis      4682  0.0  0.3 145416  3024 ?        Ssl  17:25   0:00 /apps/redis/bin/redis-server 0.0.0.0:6380 [cluster]</span>
<span style="color: #ffa54f;">root       4901  0.0  0.0 112812   972 pts/0    S+   17:27   0:00 grep --color=auto redis</span>

<span style="color: #ffa54f;">[root@redis-node1 ~]# tree /apps/redis</span>
<span style="color: #ffa54f;">/apps/redis</span>
<span style="color: #ffa54f;">&#9500;&#9472;&#9472; bin</span>
<span style="color: #ffa54f;">&#9474;   &#9500;&#9472;&#9472; redis-benchmark</span>
<span style="color: #ffa54f;">&#9474;   &#9500;&#9472;&#9472; redis-check-aof</span>
<span style="color: #ffa54f;">&#9474;   &#9500;&#9472;&#9472; redis-check-rdb</span>
<span style="color: #ffa54f;">&#9474;   &#9500;&#9472;&#9472; redis-cli</span>
<span style="color: #ffa54f;">&#9474;   &#9500;&#9472;&#9472; redis-sentinel -&gt; redis-server</span>
<span style="color: #ffa54f;">&#9474;   &#9492;&#9472;&#9472; redis-server</span>
<span style="color: #ffa54f;">&#9500;&#9472;&#9472; data</span>
<span style="color: #ffa54f;">&#9474;   &#9500;&#9472;&#9472; appendonly6380.aof</span>
<span style="color: #ffa54f;">&#9474;   &#9500;&#9472;&#9472; appendonly.aof</span>
<span style="color: #ffa54f;">&#9474;   &#9500;&#9472;&#9472; nodes-6379.conf</span>
<span style="color: #ffa54f;">&#9474;   &#9492;&#9472;&#9472; nodes-6380.conf</span>
<span style="color: #ffa54f;">&#9500;&#9472;&#9472; etc</span>
<span style="color: #ffa54f;">&#9474;   &#9500;&#9472;&#9472; redis6380.conf</span>
<span style="color: #ffa54f;">&#9474;   &#9500;&#9472;&#9472; redis6380.conf.bak</span>
<span style="color: #ffa54f;">&#9474;   &#9500;&#9472;&#9472; redis.conf</span>
<span style="color: #ffa54f;">&#9474;   &#9492;&#9472;&#9472; redis.conf.bak</span>
<span style="color: #ffa54f;">&#9500;&#9472;&#9472; log</span>
<span style="color: #ffa54f;">&#9474;   &#9500;&#9472;&#9472; redis-6379.log</span>
<span style="color: #ffa54f;">&#9474;   &#9492;&#9472;&#9472; redis-6380.log</span>
<span style="color: #ffa54f;">&#9492;&#9472;&#9472; run</span>
<span style="color: #ffa54f;">    &#9500;&#9472;&#9472; redis_6379.pid</span>
<span style="color: #ffa54f;">    &#9492;&#9472;&#9472; redis_6380.pid</span>

<span style="color: #ffa54f;">5 directories, 18 files</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3c7868d5-9a61-46dc-941b-771c2eb0c8a6" class="outline-5">
<h5 id="h:3c7868d5-9a61-46dc-941b-771c2eb0c8a6">准备redis-trib.rb工具</h5>
<div class="outline-text-5" id="text-h:3c7868d5-9a61-46dc-941b-771c2eb0c8a6">
<p>
Redis 3和
4版本需要使用到集群管理工具redis-trib.rb，这个工具是redis官方推出的管理redis集群的工具，集成在redis的源码src目录下，是基于redis提供的集群命令封装成简单、便捷、实用的操作工具，redis-trib.rb是redis作者用ruby开发完成的，centos
7 系统yum安装的ruby存在版本较低问题，如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]# find / -name redis-trib.rb 
/usr/local/src/redis-4.0.14/src/redis-trib.rb
[root@redis-node1 ~]# cp /usr/local/src/redis-4.0.14/src/redis-trib.rb /usr/bin/
[root@redis-node1 ~]# redis-trib.rb     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32570;&#23569;ruby&#29615;&#22659;&#26080;&#27861;&#36816;&#34892;rb&#33050;&#26412;</span>
/usr/bin/env: ruby: No such file or directory

<span style="color: #b22222;">#</span><span style="color: #b22222;">CentOS 7&#24102;&#30340;ruby&#29256;&#26412;&#36807;&#20302;,&#26080;&#27861;&#36816;&#34892;&#19978;&#38754;ruby&#33050;&#26412;,&#38656;&#35201;&#23433;&#35013;2.3&#20197;&#19978;&#29256;&#26412;,&#23433;&#35013;rubygems&#20381;&#36182;ruby&#33258;&#21160;&#23433;&#35013;</span>
[root@redis-node1 ~]# yum -y install rubygems
[root@redis-node1 ~]# gem install redis <span style="color: #b22222;">#</span><span style="color: #b22222;">gem&#30456;&#24403;&#20110;python&#30340;pip&#21644;linux&#30340;yum</span>
Fetching: redis-4.2.2.gem (100%)
ERROR:  Error installing redis:
    redis requires Ruby version &gt;= 2.3.0.
</pre>
</div>

<p>
<b>解决ruby版本较低问题：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]# yum -y install gcc openssl-devel zlib-devel
[root@redis-node1 ~]# wget https://cache.ruby-lang.org/pub/ruby/2.5/ruby-2.5.5.tar.gz
[root@redis-node1 ~]# tar xf ruby-2.5.5.tar.gz
[root@redis-node1 ~]# cd ruby-2.5.5
[root@redis-node1 ruby-2.5.5]#./configure
[root@redis-node1 ruby-2.5.5]# make -j 2 &amp;&amp; make install
[root@redis-node1 ruby-2.5.5]# which ruby
/usr/local/bin/ruby
[root@redis-node1 ruby-2.5.5]# ruby -v
ruby 2.5.5p157 (2019-03-15 revision 67260) [x86_64-linux]
[root@redis-node1 ruby-2.5.5]# exit <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#38656;&#35201;&#37325;&#26032;&#30331;&#24405;&#65292;&#21542;&#21017;&#26080;&#27861;&#36816;&#34892;</span>
</pre>
</div>

<p>
<b>redis-trib.rb仍无法运行 报错</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]# redis-trib.rb -h
<span style="color: #0000ff;">Traceback</span> (most recent call last):
    2: from /usr/bin/redis-trib.rb:25:in <span style="color: #ff00ff;">`&lt;main&gt;'</span>
<span style="color: #ff00ff;">    1: from /usr/local/lib/ruby/2.5.0/rubygems/core_ext/kernel_require.rb:59:in `</span>require<span style="color: #8b2252;">'</span>
<span style="color: #8b2252;">/usr/local/lib/ruby/2.5.0/rubygems/core_ext/kernel_require.rb:59:in `require'</span>: cannot load such file -- redis (LoadError)
</pre>
</div>

<p>
<b>解决上述错误：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]# gem install redis -v 4.1.3    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#38656;&#35201;&#37325;&#26032;&#30331;&#24405;&#22312;&#25191;&#34892;&#65292;&#21542;&#21017;&#26080;&#27861;&#35782;&#21035;&#21040;&#26032;ruby&#29256;&#26412;</span>
Fetching: redis-4.1.3.gem (100%)
Successfully installed redis-4.1.3
Parsing documentation for redis-4.1.3
Installing ri documentation for redis-4.1.3
Done installing documentation for redis after 1 seconds
1 gem installed
[root@redis-node1 ~]# exit

<span style="color: #b22222;">#</span><span style="color: #b22222;">gem uninstall redis &#21487;&#20197;&#21368;&#36733;&#24050;&#23433;&#35013;&#22909;&#30340;redis&#27169;&#22359;</span>
</pre>
</div>

<p>
如果无法在线安装，可以下载redis模块安装包离线安装
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">https://rubygems.org/gems/redis #&#20808;&#19979;&#36733;redis&#27169;&#22359;&#23433;&#35013;&#21253;</span>
[root@redis-node1 ~]#gem install -l redis-4.1.3.gem <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;redis&#27169;&#22359;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c08b0801-08c4-4643-90f4-3552a7a0d32d" class="outline-5">
<h5 id="h:c08b0801-08c4-4643-90f4-3552a7a0d32d">redis-trib.rb 命令用法</h5>
<div class="outline-text-5" id="text-h:c08b0801-08c4-4643-90f4-3552a7a0d32d">
<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]# redis-trib.rb
Usage: redis-trib &lt;command&gt; &lt;options&gt; &lt;arguments ...&gt;

  create          host1:port1 ... hostN:portN   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#38598;&#32676;</span>
                  --replicas &lt;arg&gt;  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#27599;&#20010;master&#30340;&#21103;&#26412;&#25968;&#37327;,&#21363;&#23545;&#24212;slave&#25968;&#37327;,&#19968;&#33324;&#20026;1</span>
  check           host:port <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#38598;&#32676;&#20449;&#24687;</span>
  info            host:port <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#38598;&#32676;&#20027;&#26426;&#20449;&#24687;</span>
  fix             host:port <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#22797;&#38598;&#32676;</span>
                  --timeout &lt;arg&gt;
  reshard         host:port <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#32447;&#28909;&#36801;&#31227;&#38598;&#32676;&#25351;&#23450;&#20027;&#26426;&#30340;slots&#25968;&#25454;</span>
                  --from &lt;arg&gt;
                  --to &lt;arg&gt;
                  --slots &lt;arg&gt;
                  --yes
                  --timeout &lt;arg&gt;
                  --pipeline &lt;arg&gt;
  rebalance       host:port <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24179;&#34913;&#38598;&#32676;&#20013;&#21508;&#20027;&#26426;&#30340;slot&#25968;&#37327;</span>
                  --weight &lt;arg&gt;
                  --auto-weights
                  --use-empty-masters
                  --timeout &lt;arg&gt;
                  --simulate
                  --pipeline &lt;arg&gt;
                  --threshold &lt;arg&gt;
  add-node        new_host:new_port existing_host:existing_port <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#20027;&#26426;&#21040;&#38598;&#32676;</span>
                  --slave
                  --master-id &lt;arg&gt;
  del-node        host:port node_id <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#20027;&#26426;</span>
  set-timeout     host:port milliseconds    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#33410;&#28857;&#30340;&#36229;&#26102;&#26102;&#38388;</span>
  call            host:port command arg arg .. arg  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#38598;&#32676;&#19978;&#30340;&#25152;&#26377;&#33410;&#28857;&#19978;&#25191;&#34892;&#21629;&#20196;</span>
  import          host:port <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20837;&#22806;&#37096;redis&#26381;&#21153;&#22120;&#30340;&#25968;&#25454;&#21040;&#24403;&#21069;&#38598;&#32676;</span>
                  --from &lt;arg&gt;
                  --copy
                  --replace
  <span style="color: #483d8b;">help</span>            (show this help)

For check, fix, reshard, del-node, set-timeout you can specify the host and port of any working node<span style="color: #a020f0;"> in</span> the cluster.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a5508c19-c6a3-43cd-a46f-1d08a8b38bad" class="outline-5">
<h5 id="h:a5508c19-c6a3-43cd-a46f-1d08a8b38bad">修改 redis 登陆密码</h5>
<div class="outline-text-5" id="text-h:a5508c19-c6a3-43cd-a46f-1d08a8b38bad">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;redis-trib.rb&#36830;&#25509;redis&#30340;&#23494;&#30721;</span>
[root@redis-node1 ~]# vim /usr/local/lib/ruby/gems/2.5.0/gems/redis-4.1.3/lib/redis/client.rb
</pre>
</div>


<figure id="org14461ea">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201025190231289.png" alt="20201025190231289.png">

</figure>
</div>
</div>
<div id="outline-container-h:6a434284-0f37-4ae9-b4e4-bd0d6dacaf7c" class="outline-5">
<h5 id="h:6a434284-0f37-4ae9-b4e4-bd0d6dacaf7c">创建redis cluster集群</h5>
<div class="outline-text-5" id="text-h:6a434284-0f37-4ae9-b4e4-bd0d6dacaf7c">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#20445;3&#21488;&#20027;&#26426;6&#20010;&#23454;&#20363;&#37117;&#21551;&#21160;&#29366;&#24577;</span>
[root@redis-node1 ~]# systemctl is-active redis redis6380
active
active
[root@redis-node2 ~]# systemctl is-active redis redis6380
active
active
[root@redis-node3 ~]# systemctl is-active redis redis6380
active
active

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#31532;&#19968;&#20010;&#20027;&#26426;&#19978;node1&#19978;&#25191;&#34892;&#19979;&#38754;&#25805;&#20316;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">--replicas 1 &#34920;&#31034;&#27599;&#20010;master &#20998;&#37197;&#19968;&#20010; slave &#33410;&#28857;&#65292;&#21069;3&#20010;&#33410;&#28857;&#33258;&#21160;&#21010;&#20998;&#20026;master&#65292;&#21518;&#38754;&#37117;&#20026;slave&#33410;&#28857;</span>
[root@redis-node1 ~]# redis-trib.rb create --replicas 1 10.0.0.7:6379 10.0.0.17:6379 10.0.0.27:6379 10.0.0.7:6380 10.0.0.17:6380 10.0.0.27:6380
&gt;&gt;&gt; Creating cluster
&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...
Using 3 masters:
10.0.0.7:6379
10.0.0.17:6379
10.0.0.27:6379
Adding replica 10.0.0.17:6380 to 10.0.0.7:6379
Adding replica 10.0.0.27:6380 to 10.0.0.17:6379
Adding replica 10.0.0.7:6380 to 10.0.0.27:6379
M: 05d5695bdc82b2d461187ad1949def1ca402f58e 10.0.0.7:6379
   slots:0-5460 (5461 slots) master
M: ebe1c9d8ae6bfdbc07f94d3c1b51f60f9097e592 10.0.0.17:6379
   slots:5461-10922 (5462 slots) master
M: ce0a9bbcdb5e2a5e0f0d08e86b38cd63152b4c94 10.0.0.27:6379
   slots:10923-16383 (5461 slots) master
S: e09ff1ee128352c3fa912c2ce865ffcb6b9a3e69 10.0.0.7:6380
   replicates ce0a9bbcdb5e2a5e0f0d08e86b38cd63152b4c94
S: 581851395649571f780989f6738a5d423f961228 10.0.0.17:6380
   replicates 05d5695bdc82b2d461187ad1949def1ca402f58e
S: 6e2b44ae14bee63df6d14637dc25f7873df6c5c3 10.0.0.27:6380
   replicates ebe1c9d8ae6bfdbc07f94d3c1b51f60f9097e592
Can I set the above configuration? (<span style="color: #483d8b;">type</span> <span style="color: #8b2252;">'yes'</span> to accept): yes
&gt;&gt;&gt; Nodes configuration updated
&gt;&gt;&gt; Assign a different config epoch to each node
&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join...
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.7:6379)
M: 05d5695bdc82b2d461187ad1949def1ca402f58e 10.0.0.7:6379
   slots:0-5460 (5461 slots) master
   1 additional replica(s)
S: 6e2b44ae14bee63df6d14637dc25f7873df6c5c3 10.0.0.27:6380
   slots: (0 slots) slave
   replicates ebe1c9d8ae6bfdbc07f94d3c1b51f60f9097e592
M: ebe1c9d8ae6bfdbc07f94d3c1b51f60f9097e592 10.0.0.17:6379
   slots:5461-10922 (5462 slots) master
   1 additional replica(s)
S: 581851395649571f780989f6738a5d423f961228 10.0.0.17:6380
   slots: (0 slots) slave
   replicates 05d5695bdc82b2d461187ad1949def1ca402f58e
M: ce0a9bbcdb5e2a5e0f0d08e86b38cd63152b4c94 10.0.0.27:6379
   slots:10923-16383 (5461 slots) master
   1 additional replica(s)
S: e09ff1ee128352c3fa912c2ce865ffcb6b9a3e69 10.0.0.7:6380
   slots: (0 slots) slave
   replicates ce0a9bbcdb5e2a5e0f0d08e86b38cd63152b4c94
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
</pre>
</div>

<p>
如果有之前的操作导致Redis集群创建报错，则执行清空数据和集群命令
</p>

<div class="org-src-container">
<pre class="src src-sh">127.0.0.1:6379&gt; FLUSHALL
OK
127.0.0.1:6379&gt; cluster reset
OK
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5916ef86-9099-48a7-ac08-6d60aea11296" class="outline-5">
<h5 id="h:5916ef86-9099-48a7-ac08-6d60aea11296">查看 redis cluster 集群状态</h5>
<div class="outline-text-5" id="text-h:5916ef86-9099-48a7-ac08-6d60aea11296">
<p>
自动生成配置文件记录master/slave对应关系
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]# cat /apps/redis/data/nodes-6379.conf 
6e2b44ae14bee63df6d14637dc25f7873df6c5c3 10.0.0.27:6380@16380 slave ebe1c9d8ae6bfdbc07f94d3c1b51f60f9097e592 0 1603623843000 6 connected
ebe1c9d8ae6bfdbc07f94d3c1b51f60f9097e592 10.0.0.17:6379@16379 master - 0 1603623842109 2 connected 5461-10922
581851395649571f780989f6738a5d423f961228 10.0.0.17:6380@16380 slave 05d5695bdc82b2d461187ad1949def1ca402f58e 0 1603623844124 5 connected
05d5695bdc82b2d461187ad1949def1ca402f58e 10.0.0.7:6379@16379 myself,master - 0 1603623840000 1 connected 0-5460
ce0a9bbcdb5e2a5e0f0d08e86b38cd63152b4c94 10.0.0.27:6379@16379 master - 0 1603623843115 3 connected 10923-16383
e09ff1ee128352c3fa912c2ce865ffcb6b9a3e69 10.0.0.7:6380@16380 slave ce0a9bbcdb5e2a5e0f0d08e86b38cd63152b4c94 0 1603623842000 4 connected
vars currentEpoch 6 lastVoteEpoch 0
</pre>
</div>

<p>
查看状态
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]# redis-trib.rb info 10.0.0.7:6379
10.0.0.7:6379 (05d5695b...) -&gt; 0 keys | 5461 slots | 1 slaves.
10.0.0.17:6379 (ebe1c9d8...) -&gt; 0 keys | 5462 slots | 1 slaves.
10.0.0.27:6379 (ce0a9bbc...) -&gt; 0 keys | 5461 slots | 1 slaves.
[OK] 0 keys<span style="color: #a020f0;"> in</span> 3 masters.
0.00 keys per slot on average.

[root@redis-node1 ~]# redis-trib.rb info 10.0.0.7:6379
10.0.0.7:6379 (05d5695b...) -&gt; 0 keys | 5461 slots | 1 slaves.
10.0.0.17:6379 (ebe1c9d8...) -&gt; 0 keys | 5462 slots | 1 slaves.
10.0.0.27:6379 (ce0a9bbc...) -&gt; 0 keys | 5461 slots | 1 slaves.
[OK] 0 keys<span style="color: #a020f0;"> in</span> 3 masters.
0.00 keys per slot on average.
[root@redis-node1 ~]# redis-trib.rb check 10.0.0.7:6379
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.7:6379)
M: 05d5695bdc82b2d461187ad1949def1ca402f58e 10.0.0.7:6379
   slots:0-5460 (5461 slots) master
   1 additional replica(s)
S: 6e2b44ae14bee63df6d14637dc25f7873df6c5c3 10.0.0.27:6380
   slots: (0 slots) slave
   replicates ebe1c9d8ae6bfdbc07f94d3c1b51f60f9097e592
M: ebe1c9d8ae6bfdbc07f94d3c1b51f60f9097e592 10.0.0.17:6379
   slots:5461-10922 (5462 slots) master
   1 additional replica(s)
S: 581851395649571f780989f6738a5d423f961228 10.0.0.17:6380
   slots: (0 slots) slave
   replicates 05d5695bdc82b2d461187ad1949def1ca402f58e
M: ce0a9bbcdb5e2a5e0f0d08e86b38cd63152b4c94 10.0.0.27:6379
   slots:10923-16383 (5461 slots) master
   1 additional replica(s)
S: e09ff1ee128352c3fa912c2ce865ffcb6b9a3e69 10.0.0.7:6380
   slots: (0 slots) slave
   replicates ce0a9bbcdb5e2a5e0f0d08e86b38cd63152b4c94
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.

[root@redis-node1 ~]# redis-cli -a 123456 
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> option on the command line interface may not be safe.
127.0.0.1:6379&gt; cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:6
cluster_my_epoch:1
cluster_stats_messages_ping_sent:491
cluster_stats_messages_pong_sent:521
cluster_stats_messages_sent:1012
cluster_stats_messages_ping_received:516
cluster_stats_messages_pong_received:491
cluster_stats_messages_meet_received:5
cluster_stats_messages_received:1012

[root@redis-node1 ~]# redis-cli -a 123456 -p 6379 cluster nodes
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> option on the command line interface may not be safe.
6e2b44ae14bee63df6d14637dc25f7873df6c5c3 10.0.0.27:6380@16380 slave ebe1c9d8ae6bfdbc07f94d3c1b51f60f9097e592 0 1603624406489 6 connected
ebe1c9d8ae6bfdbc07f94d3c1b51f60f9097e592 10.0.0.17:6379@16379 master - 0 1603624405479 2 connected 5461-10922
581851395649571f780989f6738a5d423f961228 10.0.0.17:6380@16380 slave 05d5695bdc82b2d461187ad1949def1ca402f58e 0 1603624404000 5 connected
05d5695bdc82b2d461187ad1949def1ca402f58e 10.0.0.7:6379@16379 myself,master - 0 1603624405000 1 connected 0-5460
ce0a9bbcdb5e2a5e0f0d08e86b38cd63152b4c94 10.0.0.27:6379@16379 master - 0 1603624404474 3 connected 10923-16383
e09ff1ee128352c3fa912c2ce865ffcb6b9a3e69 10.0.0.7:6380@16380 slave ce0a9bbcdb5e2a5e0f0d08e86b38cd63152b4c94 0 1603624405000 4 connected

[root@redis-node1 ~]# redis-cli -a 123456 -p 6379 info replication
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> option on the command line interface may not be safe.
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:1
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.17,<span style="color: #a0522d;">port</span>=6380,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=854,<span style="color: #a0522d;">lag</span>=0
master_replid:c4576364f25c85892c92feabca39bd8a9b779172
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:854
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:854

[root@redis-node1 ~]# redis-cli -a 123456 -p 6380 info replication
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> option on the command line interface may not be safe.
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:slave
master_host:10.0.0.27
master_port:6379
master_link_status:up
master_last_io_seconds_ago:6
master_sync_in_progress:0
slave_repl_offset:924
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:433df0468e1deb202ba93040743ab4ff7e38cf21
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:924
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:924
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b1406401-5efc-424e-b9f5-69e947d316c7" class="outline-5">
<h5 id="h:b1406401-5efc-424e-b9f5-69e947d316c7">python脚本实现RedisCluster集群写入</h5>
<div class="outline-text-5" id="text-h:b1406401-5efc-424e-b9f5-69e947d316c7">
<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]# yum -y install python3
[root@redis-node1 ~]# pip3 install redis-py-cluster
[root@redis-node1 ~]# cat redis_cluster_test.py 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/env python3</span>
from rediscluster  import RedisCluster
startup_nodes = [
    {<span style="color: #8b2252;">"host"</span>:<span style="color: #8b2252;">"10.0.0.7"</span>, <span style="color: #8b2252;">"port"</span>:6379},
    {<span style="color: #8b2252;">"host"</span>:<span style="color: #8b2252;">"10.0.0.17"</span>, <span style="color: #8b2252;">"port"</span>:6379},
    {<span style="color: #8b2252;">"host"</span>:<span style="color: #8b2252;">"10.0.0.27"</span>, <span style="color: #8b2252;">"port"</span>:6379},
    {<span style="color: #8b2252;">"host"</span>:<span style="color: #8b2252;">"10.0.0.37"</span>, <span style="color: #8b2252;">"port"</span>:6379},
    {<span style="color: #8b2252;">"host"</span>:<span style="color: #8b2252;">"10.0.0.47"</span>, <span style="color: #8b2252;">"port"</span>:6379},
    {<span style="color: #8b2252;">"host"</span>:<span style="color: #8b2252;">"10.0.0.57"</span>, <span style="color: #8b2252;">"port"</span>:6379}
]
<span style="color: #a0522d;">redis_conn</span>= RedisCluster(<span style="color: #a0522d;">startup_nodes</span>=startup_nodes,<span style="color: #a0522d;">password</span>=<span style="color: #8b2252;">'123456'</span>, <span style="color: #a0522d;">decode_responses</span>=True)

<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> range(0, 10000):
    redis_conn.set(<span style="color: #8b2252;">'key'</span>+str(i),<span style="color: #8b2252;">'value'</span>+str(i))
    print(<span style="color: #8b2252;">'key'</span>+str(i)+<span style="color: #8b2252;">':'</span>,redis_conn.get(<span style="color: #8b2252;">'key'</span>+str(i)))

[root@redis-node1 ~]# chmod +x redis_cluster_test.py 
[root@redis-node1 ~]# ./redis_cluster_test.py
...&#30465;&#30053;...
key9997: value9997
key9998: value9998
key9999: value9999
</pre>
</div>

<p>
<b>验证脚本写入的状态</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]# redis-cli -a 123456 -h 10.0.0.7 dbsize
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> option on the command line interface may not be safe.
(integer) 3331
[root@redis-node1 ~]# redis-cli -a 123456 -h 10.0.0.17 dbsize
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> option on the command line interface may not be safe.
(integer) 3340
[root@redis-node1 ~]# redis-cli -a 123456 -h 10.0.0.27 dbsize
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> option on the command line interface may not be safe.
(integer) 3329
[root@redis-node1 ~]# redis-cli -a 123456 get key1
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> option on the command line interface may not be safe.
(error) MOVED 9189 10.0.0.17:6379
[root@redis-node1 ~]# redis-cli -a 123456 get key2
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> option on the command line interface may not be safe.
<span style="color: #8b2252;">"value2"</span>
[root@redis-node1 ~]# redis-cli -h 10.0.0.17 -a 123456 get key1
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> option on the command line interface may not be safe.
<span style="color: #8b2252;">"value1"</span>

[root@redis-node1 ~]# redis-trib.rb info 10.0.0.7:6379
10.0.0.7:6379 (05d5695b...) -&gt; 3331 keys | 5461 slots | 1 slaves.
10.0.0.17:6379 (ebe1c9d8...) -&gt; 3340 keys | 5462 slots | 1 slaves.
10.0.0.27:6379 (ce0a9bbc...) -&gt; 3329 keys | 5461 slots | 1 slaves.
[OK] 10000 keys<span style="color: #a020f0;"> in</span> 3 masters.
0.61 keys per slot on average.
</pre>
</div>
</div>
</div>
<div id="outline-container-h:aeec1c31-beb4-4def-bf49-c10e1e86326b" class="outline-5">
<h5 id="h:aeec1c31-beb4-4def-bf49-c10e1e86326b">模拟 master 故障，对应的slave节点自动提升为新master</h5>
<div class="outline-text-5" id="text-h:aeec1c31-beb4-4def-bf49-c10e1e86326b">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35753;node2&#33410;&#28857;&#23445;&#26426;</span>
[root@redis-node2 ~]# systemctl stop redis

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#20250;&#31435;&#21363;&#25552;&#21319;,&#38656;&#35201;&#31245;&#31561;&#19968;&#20250;&#20799;&#20877;&#35266;&#23519;&#19979;&#38754;&#32467;&#26524;</span>
[root@redis-node2 ~]# redis-trib.rb check 10.0.0.7:6379
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.7:6379)
M: 05d5695bdc82b2d461187ad1949def1ca402f58e 10.0.0.7:6379
   slots:0-5460 (5461 slots) master
   1 additional replica(s)
M: 6e2b44ae14bee63df6d14637dc25f7873df6c5c3 10.0.0.27:6380
   slots:5461-10922 (5462 slots) master
   0 additional replica(s)
S: 581851395649571f780989f6738a5d423f961228 10.0.0.17:6380
   slots: (0 slots) slave
   replicates 05d5695bdc82b2d461187ad1949def1ca402f58e
M: ce0a9bbcdb5e2a5e0f0d08e86b38cd63152b4c94 10.0.0.27:6379
   slots:10923-16383 (5461 slots) master
   1 additional replica(s)
S: e09ff1ee128352c3fa912c2ce865ffcb6b9a3e69 10.0.0.7:6380
   slots: (0 slots) slave
   replicates ce0a9bbcdb5e2a5e0f0d08e86b38cd63152b4c94
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#26032;&#30340;master(&#21363;node3)&#19978;&#26597;&#30475;&#26085;&#24535;</span>
[root@redis-node3 ~]# tail /apps/redis/log/redis-6380.log 
4846:S 25 Oct 19:24:48.209 <span style="color: #b22222;"># </span><span style="color: #b22222;">Currently unable to failover: Waiting the delay before I can start a new failover.</span>
4846:S 25 Oct 19:24:48.512 * Connecting to MASTER 10.0.0.17:6379
4846:S 25 Oct 19:24:48.512 * MASTER &lt;-&gt; SLAVE sync started
4846:S 25 Oct 19:24:48.513 <span style="color: #b22222;"># </span><span style="color: #b22222;">Error condition on socket for SYNC: Connection refused</span>
4846:S 25 Oct 19:24:48.814 <span style="color: #b22222;"># </span><span style="color: #b22222;">Starting a failover election for epoch 8.</span>
4846:S 25 Oct 19:24:48.817 <span style="color: #b22222;"># </span><span style="color: #b22222;">Failover election won: I'm the new master.</span>
4846:S 25 Oct 19:24:48.817 <span style="color: #b22222;"># </span><span style="color: #b22222;">configEpoch set to 8 after successful failover</span>
4846:M 25 Oct 19:24:48.817 <span style="color: #b22222;"># </span><span style="color: #b22222;">Setting secondary replication ID to a9f0e20eb3affe694fe48802259f69b5aa550a33, valid up to offset: 137842. New replication ID is 730ab9b1b311facf78112a78fd7e97011b188242</span>
4846:M 25 Oct 19:24:48.817 * Discarding previously cached master state.
4846:M 25 Oct 19:24:48.817 <span style="color: #b22222;"># </span><span style="color: #b22222;">Cluster state changed: ok</span>

[root@redis-node3 ~]# redis-trib.rb info 10.0.0.7:6379
10.0.0.7:6379 (05d5695b...) -&gt; 3331 keys | 5461 slots | 1 slaves.
10.0.0.27:6380 (6e2b44ae...) -&gt; 3340 keys | 5462 slots | 0 slaves.
10.0.0.27:6379 (ce0a9bbc...) -&gt; 3329 keys | 5461 slots | 1 slaves.
[OK] 10000 keys<span style="color: #a020f0;"> in</span> 3 masters.
0.61 keys per slot on average.
</pre>
</div>

<p>
<b>将故障的master恢复后，该节点自动加入集群成为新的slave</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis-node2 ~]# systemctl start redis
[root@redis-node2 ~]# redis-trib.rb check 10.0.0.7:6379
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.7:6379)
M: 05d5695bdc82b2d461187ad1949def1ca402f58e 10.0.0.7:6379
   slots:0-5460 (5461 slots) master
   1 additional replica(s)
M: 6e2b44ae14bee63df6d14637dc25f7873df6c5c3 10.0.0.27:6380
   slots:5461-10922 (5462 slots) master
   1 additional replica(s)
S: ebe1c9d8ae6bfdbc07f94d3c1b51f60f9097e592 10.0.0.17:6379
   slots: (0 slots) slave
   replicates 6e2b44ae14bee63df6d14637dc25f7873df6c5c3
S: 581851395649571f780989f6738a5d423f961228 10.0.0.17:6380
   slots: (0 slots) slave
   replicates 05d5695bdc82b2d461187ad1949def1ca402f58e
M: ce0a9bbcdb5e2a5e0f0d08e86b38cd63152b4c94 10.0.0.27:6379
   slots:10923-16383 (5461 slots) master
   1 additional replica(s)
S: e09ff1ee128352c3fa912c2ce865ffcb6b9a3e69 10.0.0.7:6380
   slots: (0 slots) slave
   replicates ce0a9bbcdb5e2a5e0f0d08e86b38cd63152b4c94
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:ce4e414c-dba8-48c8-96d5-c1914b812a7c" class="outline-4">
<h4 id="h:ce4e414c-dba8-48c8-96d5-c1914b812a7c">Redis cluster管理</h4>
<div class="outline-text-4" id="text-h:ce4e414c-dba8-48c8-96d5-c1914b812a7c">
</div>
<div id="outline-container-h:e55d516d-5d50-4a43-b5c7-7d3619dbd05a" class="outline-5">
<h5 id="h:e55d516d-5d50-4a43-b5c7-7d3619dbd05a">集群扩容</h5>
<div class="outline-text-5" id="text-h:e55d516d-5d50-4a43-b5c7-7d3619dbd05a">
<p>
<b>扩容适用场景</b>:
</p>

<p>
当前客户量激增，现有的Redis cluster架构已经无法满足越来越高的并发访问请求，为解决此问题,新购置两台服务器，要求将其动态添加到现有集群，但不能影响业务的正常访问。
</p>

<p>
注意: 生产环境一般建议master节点为奇数个,比如:3,5,7,以防止脑裂现象
</p>


<figure id="org34d75e4">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/1479036033.png" alt="1479036033.png" width="50%">

</figure>

<p>
其中槽的迁移有以下步骤：
</p>


<figure id="org312f065">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/img_20250819_180312.png" alt="img_20250819_180312.png" width="50%">

</figure>
</div>
<ul class="org-ul">
<li><a id="h:5d5bb671-5f19-4f1e-a01c-5aa66a1cdc27"></a>添加节点准备<br>
<div class="outline-text-6" id="text-h:5d5bb671-5f19-4f1e-a01c-5aa66a1cdc27">
<p>
增加Redis node节点，需要与之前的Redis
node版本相同、配置一致，然后分别再启动两台Redis node，应为一主一从。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;node7&#33410;&#28857;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#35793;&#23433;&#35013;redis</span>
[root@redis-node7 ~]# sed -i.bak -e <span style="color: #8b2252;">'s/bind 127.0.0.1/bind 0.0.0.0/'</span> -e<span style="color: #8b2252;">'/masterauth/a masterauth 123456'</span> -e <span style="color: #8b2252;">'/# requirepass/a requirepass 123456'</span> -e <span style="color: #8b2252;">'/# cluster-enabled yes/a cluster-enabled yes'</span> -e <span style="color: #8b2252;">'/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf'</span> -e <span style="color: #8b2252;">'/cluster-require-fullcoverage yes/c cluster-require-full-coverage no'</span> /etc/redis.conf
[root@redis-node7 ~]# systemctl enable --now redis

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;node8&#33410;&#28857;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32534;&#35793;&#23433;&#35013;redis</span>
[root@redis-node8 ~]# sed -i.bak -e <span style="color: #8b2252;">'s/bind 127.0.0.1/bind 0.0.0.0/'</span> -e<span style="color: #8b2252;">'/masterauth/a masterauth 123456'</span> -e <span style="color: #8b2252;">'/# requirepass/a requirepass 123456'</span> -e <span style="color: #8b2252;">'/# cluster-enabled yes/a cluster-enabled yes'</span> -e <span style="color: #8b2252;">'/# cluster-config-file nodes-6379.conf/a cluster-config-file nodes-6379.conf'</span> -e <span style="color: #8b2252;">'/cluster-require-fullcoverage yes/c cluster-require-full-coverage no'</span> /etc/redis.conf
[root@redis-node8 ~]# systemctl enable --now redis
</pre>
</div>
</div>
</li>
<li><a id="h:3cbaddf8-db35-4c9c-8ace-4bc9b65317fa"></a>添加新的master节点到集群<br>
<div class="outline-text-6" id="text-h:3cbaddf8-db35-4c9c-8ace-4bc9b65317fa">
<p>
使用以下命令添加新节点，要添加的新redis节点IP和端口添加到的已有的集群中任意节点的IP:端口
</p>

<div class="org-src-container">
<pre class="src src-sh">add-node new_host:new_port existing_host:existing_port [--slave --master-id &lt;arg&gt;]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35828;&#26126;&#65306;</span>
new_host:new_port <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#26032;&#28155;&#21152;&#30340;&#20027;&#26426;&#30340;IP&#21644;&#31471;&#21475;</span>
existing_host:existing_port <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#24050;&#26377;&#30340;&#38598;&#32676;&#20013;&#20219;&#24847;&#33410;&#28857;&#30340;IP&#21644;&#31471;&#21475;</span>
</pre>
</div>

<p>
<b>Redis 3/4 添加方式：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25226;&#26032;&#30340;Redis &#33410;&#28857;10.0.0.37&#28155;&#21152;&#21040;&#24403;&#21069;Redis&#38598;&#32676;&#24403;&#20013;&#12290;</span>
[root@redis-node1 ~]# redis-trib.rb add-node 10.0.0.37:6379 
[root@redis-node1 ~]#redis-trib.rb info 10.0.0.7:6379
10.0.0.7:6379 (29a83275...) -&gt; 3331 keys | 5461 slots | 1 slaves.
10.0.0.37:6379 (12ca273a...) -&gt; 0 keys | 0 slots | 0 slaves.
10.0.0.27:6379 (90b20613...) -&gt; 3329 keys | 5461 slots | 1 slaves.
10.0.0.17:6379 (fb34c3a7...) -&gt; 3340 keys | 5462 slots | 1 slaves.
[OK] 10000 keys<span style="color: #a020f0;"> in</span> 4 masters.
0.61 keys per slot on average.
</pre>
</div>

<p>
<b>Redis 5 添加方式：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#19968;&#21488;&#26032;&#30340;&#20027;&#26426;10.0.0.68&#21152;&#20837;&#38598;&#32676;,&#20197;&#19979;&#31034;&#20363;&#20013;10.0.0.58&#21487;&#20197;&#26159;&#20219;&#24847;&#23384;&#22312;&#30340;&#38598;&#32676;&#33410;&#28857;</span>
[root@redis-node1 ~]#redis-cli -a centos --cluster add-node 10.0.0.68:6379 10.0.0.58:6379 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&lt;&#24403;&#21069;&#20219;&#24847;&#38598;&#32676;&#33410;&#28857;&gt;:6379</span>
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface
may not be safe.
&gt;&gt;&gt; Adding node 10.0.0.68:6379 to cluster 10.0.0.58:6379
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.58:6379)
S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379
slots: (0 slots) slave
replicates d34da8666a6f587283a1c2fca5d13691407f9462
M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379
slots:[5461-10922] (5462 slots) master
1 additional replica(s)
M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379
slots:[10923-16383] (5461 slots) master
1 additional replica(s)
S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379
slots: (0 slots) slave
replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057
S: f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379
slots: (0 slots) slave
replicates cb028b83f9dc463d732f6e76ca6bbcd469d948a7
M: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379
slots:[0-5460] (5461 slots) master
1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
&gt;&gt;&gt; Send CLUSTER MEET to node 10.0.0.68:6379 to make it join the cluster.
[OK] New node added correctly.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35266;&#23519;&#21040;&#35813;&#33410;&#28857;&#24050;&#32463;&#21152;&#20837;&#25104;&#21151;&#65292;&#20294;&#27492;&#33410;&#28857;&#19978;&#27809;&#26377;slot&#20301;,&#20063;&#26080;&#20174;&#33410;&#28857;&#65292;&#32780;&#19988;&#26032;&#30340;&#33410;&#28857;&#26159;master</span>
[root@redis-node1 ~]#redis-cli -a centos --cluster info 10.0.0.8:6379
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface
may not be safe.
10.0.0.8:6379 (cb028b83...) -&gt; 6672 keys | 5461 slots | 1 slaves.
10.0.0.68:6379 (d6e2eca6...) -&gt; 0 keys | 0 slots | 0 slaves.
10.0.0.48:6379 (d04e524d...) -&gt; 6679 keys | 5462 slots | 1 slaves.
10.0.0.28:6379 (d34da866...) -&gt; 6649 keys | 5461 slots | 1 slaves.
[OK] 20000 keys<span style="color: #a020f0;"> in</span> 5 masters.
1.22 keys per slot on average.

[root@redis-node1 ~]#redis-cli -a centos --cluster check 10.0.0.8:6379
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface
may not be safe.
10.0.0.8:6379 (cb028b83...) -&gt; 6672 keys | 5461 slots | 1 slaves.
10.0.0.68:6379 (d6e2eca6...) -&gt; 0 keys | 0 slots | 0 slaves.
10.0.0.48:6379 (d04e524d...) -&gt; 6679 keys | 5462 slots | 1 slaves.
10.0.0.28:6379 (d34da866...) -&gt; 6649 keys | 5461 slots | 1 slaves.
[OK] 20000 keys<span style="color: #a020f0;"> in</span> 5 masters.
1.22 keys per slot on average.
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.8:6379)
M: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379
    slots:[0-5460] (5461 slots) master
    1 additional replica(s)
M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379
    slots: (0 slots) master
S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379
    slots: (0 slots) slave
    replicates d34da8666a6f587283a1c2fca5d13691407f9462
S: f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379
    slots: (0 slots) slave
    replicates cb028b83f9dc463d732f6e76ca6bbcd469d948a7
M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379
    slots:[5461-10922] (5462 slots) master
    1 additional replica(s)
S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379
    slots: (0 slots) slave
    replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057
M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379
    slots:[10923-16383] (5461 slots) master
    1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.

[root@redis-node1 ~]#cat /var/lib/redis/nodes-6379.conf
d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379@16379 master - 0
1582356107260 8 connected
9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379@16379 slave
d34da8666a6f587283a1c2fca5d13691407f9462 0 1582356110286 6 connected
f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379@16379 slave
cb028b83f9dc463d732f6e76ca6bbcd469d948a7 0 1582356108268 4 connected
d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379@16379 master - 0
1582356105000 7 connected 5461-10922
99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379@16379 slave
d04e524daec4d8e22bdada7f21a9487c2d3e1057 0 1582356108000 7 connected
d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379@16379 master - 0
1582356107000 3 connected 10923-16383
cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379@16379 myself,master - 0
1582356106000 1 connected 0-5460
vars currentEpoch 8 lastVoteEpoch 7

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21644;&#19978;&#38754;&#26174;&#31034;&#32467;&#26524;&#19968;&#26679;</span>
[root@redis-node1 ~]#redis-cli -a centos CLUSTER NODES
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface
may not be safe.
d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379@16379 master - 0
1582356313200 8 connected
9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379@16379 slave
d34da8666a6f587283a1c2fca5d13691407f9462 0 1582356311000 6 connected
f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379@16379 slave
cb028b83f9dc463d732f6e76ca6bbcd469d948a7 0 1582356314208 4 connected
d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379@16379 master - 0
1582356311182 7 connected 5461-10922
99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379@16379 slave
d04e524daec4d8e22bdada7f21a9487c2d3e1057 0 1582356312000 7 connected
d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379@16379 master - 0
1582356312190 3 connected 10923-16383
cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379@16379 myself,master - 0
1582356310000 1 connected 0-5460

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#38598;&#32676;&#29366;&#24577;</span>
[root@redis-node1 ~]#redis-cli -a centos CLUSTER INFO
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface
may not be safe.
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:7
cluster_size:3
cluster_current_epoch:8
cluster_my_epoch:1
cluster_stats_messages_ping_sent:17442
cluster_stats_messages_pong_sent:13318
cluster_stats_messages_fail_sent:4
cluster_stats_messages_auth-ack_sent:1
cluster_stats_messages_sent:30765
cluster_stats_messages_ping_received:13311
cluster_stats_messages_pong_received:13367
cluster_stats_messages_meet_received:7
cluster_stats_messages_fail_received:1
cluster_stats_messages_auth-req_received:1
cluster_stats_messages_received:26687
</pre>
</div>
</div>
</li>
<li><a id="h:b4c955c3-0ae9-4dba-97b4-60c95d6eefcf"></a>在新的master上重新分配槽位<br>
<div class="outline-text-6" id="text-h:b4c955c3-0ae9-4dba-97b4-60c95d6eefcf">
<p>
新的node节点加到集群之后,默认是master节点，但是没有slots，需要重新分配。否则没有槽位将无法访问。
</p>

<p>
<b>注意: 重新分配槽位需要清空数据,所以需要先备份数据,扩展后再恢复数据</b>
</p>

<p>
<b>Redis 3/4:</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]# redis-trib.rb check 10.0.0.67:6379 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#29366;&#24577;</span>
[root@redis-node1 ~]# redis-trib.rb reshard &lt;&#20219;&#24847;&#33410;&#28857;&gt;:6379 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#26032;&#20998;&#29255;</span>
[root@redis-node1 ~]# redis-trib.rb fix 10.0.0.67:6379 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#36801;&#31227;&#22833;&#36133;&#20351;&#29992;&#27492;&#21629;&#20196;&#20462;&#22797;&#38598;&#32676;</span>
</pre>
</div>

<p>
<b>Redis 5：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]#redis-cli -a 123456 --cluster reshard &lt;&#24403;&#21069;&#20219;&#24847;&#38598;&#32676;&#33410;&#28857;&gt;:6379
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface
may not be safe.
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.68:6379)
M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379
    slots: (0 slots) master
M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379
    slots:[10923-16383] (5461 slots) master
    1 additional replica(s)
M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379
    slots:[5461-10922] (5462 slots) master
    1 additional replica(s)
M: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379
    slots:[0-5460] (5461 slots) master
    1 additional replica(s)
S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379
    slots: (0 slots) slave
    replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057
M: f67f1c02c742cd48d3f48d8c362f9f1b9aa31549 10.0.0.78:6379
    slots: (0 slots) master
S: f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379
    slots: (0 slots) slave
    replicates cb028b83f9dc463d732f6e76ca6bbcd469d948a7
S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379
    slots: (0 slots) slave
    replicates d34da8666a6f587283a1c2fca5d13691407f9462
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
How many slots<span style="color: #a020f0;"> do</span> you want to move (from 1 to 16384)?4096 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26032;&#20998;&#37197;&#22810;&#23569;&#20010;&#27133;&#20301;=16384/master&#20010;&#25968;</span>
What is the receiving node ID? d6e2eca6b338b717923f64866bd31d42e52edc98 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26032;&#30340;master&#30340;ID</span>
Please enter all the source node IDs.
    Type <span style="color: #8b2252;">'all'</span> to use all the nodes as source nodes for the hash slots.
    Type <span style="color: #8b2252;">'done'</span> once you entered all the source nodes IDs.
Source node <span style="color: #b22222;">#</span><span style="color: #b22222;">1: all #&#23558;&#21738;&#20123;&#28304;&#20027;&#26426;&#30340;&#27133;&#20301;&#20998;&#37197;&#32473;&#26032;&#30340;&#33410;&#28857;&#65292;all&#26159;&#33258;&#21160;&#22312;&#25152;&#26377;&#30340;redis node&#36873;&#25321;&#21010;&#20998;&#65292;&#22914;&#26524;&#26159;&#20174;redis cluster&#21024;&#38500;&#26576;&#20010;&#20027;&#26426;&#21487;&#20197;&#20351;&#29992;&#27492;&#26041;&#24335;&#23558;&#25351;&#23450;&#20027;&#26426;&#19978;&#30340;&#27133;&#20301;&#20840;&#37096;&#31227;&#21160;&#21040;&#21035;&#30340;redis&#20027;&#26426;</span>
......
Do you want to proceed with the proposed reshard plan (yes/no)? yes <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#35748;&#20998;&#37197;</span>
......
Moving slot 12280 from 10.0.0.28:6379 to 10.0.0.68:6379: .
Moving slot 12281 from 10.0.0.28:6379 to 10.0.0.68:6379: .
Moving slot 12282 from 10.0.0.28:6379 to 10.0.0.68:6379:
Moving slot 12283 from 10.0.0.28:6379 to 10.0.0.68:6379: ..
Moving slot 12284 from 10.0.0.28:6379 to 10.0.0.68:6379:
Moving slot 12285 from 10.0.0.28:6379 to 10.0.0.68:6379: .
Moving slot 12286 from 10.0.0.28:6379 to 10.0.0.68:6379:
Moving slot 12287 from 10.0.0.28:6379 to 10.0.0.68:6379: ..

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#23450;slot&#20998;&#37197;&#25104;&#21151;</span>
[root@redis-node1 ~]#redis-cli -a 123456 --cluster check 10.0.0.8:6379
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface
may not be safe.
10.0.0.8:6379 (cb028b83...) -&gt; 5019 keys | 4096 slots | 1 slaves.
10.0.0.68:6379 (d6e2eca6...) -&gt; 4948 keys | 4096 slots | 0 slaves.
10.0.0.48:6379 (d04e524d...) -&gt; 5033 keys | 4096 slots | 1 slaves.
10.0.0.28:6379 (d34da866...) -&gt; 5000 keys | 4096 slots | 1 slaves.
[OK] 20000 keys<span style="color: #a020f0;"> in</span> 5 masters.
1.22 keys per slot on average.
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.8:6379)
M: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379
    slots:[1365-5460] (4096 slots) master
    1 additional replica(s)
M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379
    slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#30475;&#21040;4096&#20010;slots</span>
S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379
    slots: (0 slots) slave
    replicates d34da8666a6f587283a1c2fca5d13691407f9462
S: f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379
    slots: (0 slots) slave
    replicates cb028b83f9dc463d732f6e76ca6bbcd469d948a7
M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379
    slots:[6827-10922] (4096 slots) master
    1 additional replica(s)
S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379
    slots: (0 slots) slave
    replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057
M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379
    slots:[12288-16383] (4096 slots) master
    1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
</pre>
</div>
</div>
</li>
<li><a id="h:c790ca17-7b15-4733-8769-5103c361d44b"></a>为新的master添加新的slave节点<br>
<div class="outline-text-6" id="text-h:c790ca17-7b15-4733-8769-5103c361d44b">
<p>
需要再向当前的Redis集群中添加一个Redis单机服务器10.0.0.78，用于解决当前10.0.0.68单机的潜在宕机问题，即实现响应的高可用功能，有两种方式：
</p>

<p>
<b>方法1：在新加节点到集群时，直接将之设置为slave</b>
</p>

<p>
<b>Redis 3/4 添加方式：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">redis-trib.rb add-node --slave --master-id
750cab050bc81f2655ed53900fd43d2e64423333 10.0.0.77:6379 &lt;&#20219;&#24847;&#38598;&#32676;&#33410;&#28857;&gt;:6379
</pre>
</div>

<p>
<b>Redis 5 添加方式：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">redis-cli -a centos --cluster add-node 10.0.0.78:6379 &lt;&#20219;&#24847;&#38598;&#32676;&#33410;&#28857;&gt;:6379 --cluster-slave --cluster-master-id d6e2eca6b338b717923f64866bd31d42e52edc98
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#29366;&#24577;</span>
[root@redis-node1 ~]#redis-cli -a centos --cluster check 10.0.0.8:6379
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface
may not be safe.
10.0.0.8:6379 (cb028b83...) -&gt; 5019 keys | 4096 slots | 1 slaves.
10.0.0.68:6379 (d6e2eca6...) -&gt; 4948 keys | 4096 slots | 0 slaves.
10.0.0.48:6379 (d04e524d...) -&gt; 5033 keys | 4096 slots | 1 slaves.
10.0.0.28:6379 (d34da866...) -&gt; 5000 keys | 4096 slots | 1 slaves.
[OK] 20000 keys<span style="color: #a020f0;"> in</span> 4 masters.
1.22 keys per slot on average.
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.8:6379)
M: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379
    slots:[1365-5460] (4096 slots) master
    1 additional replica(s)
M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379
    slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379
    slots: (0 slots) slave
    replicates d34da8666a6f587283a1c2fca5d13691407f9462
S: f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379
    slots: (0 slots) slave
    replicates cb028b83f9dc463d732f6e76ca6bbcd469d948a7
M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379
    slots:[6827-10922] (4096 slots) master
    1 additional replica(s)
S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379
    slots: (0 slots) slave
    replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057
M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379
    slots:[12288-16383] (4096 slots) master
    1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#21152;&#20026;slave&#33410;&#28857;</span>
[root@redis-node1 ~]#redis-cli -a centos --cluster add-node 10.0.0.78:6379 10.0.0.8:6379 --cluster-slave --cluster-master-id d6e2eca6b338b717923f64866bd31d42e52edc98
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#26159;&#21542;&#25104;&#21151;</span>
[root@redis-node1 ~]#redis-cli -a centos --cluster check 10.0.0.8:6379
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface
may not be safe.
10.0.0.8:6379 (cb028b83...) -&gt; 5019 keys | 4096 slots | 1 slaves.
10.0.0.68:6379 (d6e2eca6...) -&gt; 4948 keys | 4096 slots | 1 slaves.
10.0.0.48:6379 (d04e524d...) -&gt; 5033 keys | 4096 slots | 1 slaves.
10.0.0.28:6379 (d34da866...) -&gt; 5000 keys | 4096 slots | 1 slaves.
[OK] 20000 keys<span style="color: #a020f0;"> in</span> 4 masters.
1.22 keys per slot on average.
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.8:6379)
M: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379
    slots:[1365-5460] (4096 slots) master
    1 additional replica(s)
M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379
    slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
    1 additional replica(s)
S: 36840d7eea5835ba540d9b64ec018aa3f8de6747 10.0.0.78:6379
    slots: (0 slots) slave
    replicates d6e2eca6b338b717923f64866bd31d42e52edc98
S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379
    slots: (0 slots) slave
    replicates d34da8666a6f587283a1c2fca5d13691407f9462
S: f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379
    slots: (0 slots) slave
    replicates cb028b83f9dc463d732f6e76ca6bbcd469d948a7
M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379
    slots:[6827-10922] (4096 slots) master
    1 additional replica(s)
S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379
    slots: (0 slots) slave
    replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057
M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379
    slots:[12288-16383] (4096 slots) master
    1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.

[root@redis-node1 ~]#redis-cli -a centos -h 10.0.0.8 --no-auth-warning cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:8 <span style="color: #b22222;">#</span><span style="color: #b22222;">8&#20010;&#33410;&#28857;</span>
cluster_size:4 <span style="color: #b22222;">#</span><span style="color: #b22222;">4&#32452;&#20027;&#20174;</span>
cluster_current_epoch:11
cluster_my_epoch:10
cluster_stats_messages_ping_sent:1810
cluster_stats_messages_pong_sent:1423
cluster_stats_messages_auth-req_sent:5
cluster_stats_messages_update_sent:14
cluster_stats_messages_sent:3252
cluster_stats_messages_ping_received:1417
cluster_stats_messages_pong_received:1368
cluster_stats_messages_meet_received:2
cluster_stats_messages_fail_received:2
cluster_stats_messages_auth-ack_received:2
cluster_stats_messages_update_received:4
cluster_stats_messages_received:2795
</pre>
</div>

<p>
<b>方法2：先将新节点加入集群，再修改为slave</b>
</p>

<p>
<b>为新的master添加slave节点</b>
</p>

<p>
<b>Redis 3/4 版本：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]#redis-trib.rb add-node 10.0.0.77:6379 10.0.0.8:6379
</pre>
</div>

<p>
<b>Redis 5 版本：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25226;10.0.0.78:6379&#28155;&#21152;&#21040;&#38598;&#32676;&#20013;&#65306;</span>
[root@redis-node1 ~]#redis-cli -a centos --cluster add-node 10.0.0.78:6379 10.0.0.8:6379
</pre>
</div>

<p>
<b>更改新节点更改状态为slave：</b>
</p>

<p>
需要手动将其指定为某个master的slave，否则其默认角色为master。
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]#redis-cli -h 10.0.0.78 -p 6379 -a centos <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30331;&#24405;&#21040;&#26032;&#28155;&#21152;&#33410;&#28857;</span>
10.0.0.78:6380&gt; CLUSTER NODES <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#38598;&#32676;&#33410;&#28857;&#65292;&#25214;&#21040;&#30446;&#26631;master &#30340;ID</span>
10.0.0.78:6380&gt; CLUSTER REPLICATE 886338acd50c3015be68a760502b239f4509881c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#20854;</span>
&#35774;&#32622;slave&#65292;&#21629;&#20196;&#26684;&#24335;&#20026;cluster replicate MASTERID

10.0.0.78:6380&gt; CLUSTER NODES <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20877;&#27425;&#26597;&#30475;&#38598;&#32676;&#33410;&#28857;&#29366;&#24577;&#65292;&#39564;&#35777;&#33410;&#28857;&#26159;&#21542;&#24050;&#32463;&#26356;&#25913;&#20026;&#25351;&#23450;master &#30340;slave</span>
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:2a559576-d17e-40b2-944f-12990d673d4f" class="outline-5">
<h5 id="h:2a559576-d17e-40b2-944f-12990d673d4f">集群维护之动态缩容</h5>
<div class="outline-text-5" id="text-h:2a559576-d17e-40b2-944f-12990d673d4f">
<p>
<b>缩容适用场景</b>:
</p>

<p>
随着业务萎缩用户量下降明显，和领导商量决定将现有Redis集群的8台主机中下线两台主机挪做它用，缩容后性能仍能满足当前业务需求
</p>

<p>
<b>删除节点过程</b>:
</p>

<p>
扩容时是先添加node到集群，然后再分配槽位，而缩容时的操作相反，是先将被要删除的node上的槽位迁移到集群中的其他node上，然后 才能再将其从集群中删除，如果一个node上的槽位没有被完全迁移空，删除该node时也会提示有数据出错导致无法删除。
</p>
</div>
<ul class="org-ul">
<li><a id="h:ce703e9d-36b1-44ca-965c-e51edb0bb8f8"></a>迁移master 的槽位至其他master<br>
<div class="outline-text-6" id="text-h:ce703e9d-36b1-44ca-965c-e51edb0bb8f8">
<p>
<b>注意: 被迁移Redis master源服务器必须保证没有数据，否则迁移报错并会被强制中断。</b>
</p>

<p>
<b>Redis 3/4 版本</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]# redis-trib.rb reshard 10.0.0.8:6379
[root@redis-node1 ~]# redis-trib.rb fix 10.0.0.8:6379 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#36801;&#31227;&#22833;&#36133;&#20351;&#29992;&#27492;&#21629;&#20196;&#20462;&#22797;&#38598;&#32676;</span>
</pre>
</div>

<p>
<b>Redis 5版本</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#29366;&#24577;</span>
[root@redis-node1 ~]#redis-cli -a centos --cluster check 10.0.0.8:6379
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface
may not be safe.
10.0.0.8:6379 (cb028b83...) -&gt; 5019 keys | 4096 slots | 1 slaves.
10.0.0.68:6379 (d6e2eca6...) -&gt; 4948 keys | 4096 slots | 1 slaves.
10.0.0.48:6379 (d04e524d...) -&gt; 5033 keys | 4096 slots | 1 slaves.
10.0.0.28:6379 (d34da866...) -&gt; 5000 keys | 4096 slots | 1 slaves.
[OK] 20000 keys<span style="color: #a020f0;"> in</span> 4 masters.
1.22 keys per slot on average.
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.8:6379)
M: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379
    slots:[1365-5460] (4096 slots) master
    1 additional replica(s)
M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379
    slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
    1 additional replica(s)
S: 36840d7eea5835ba540d9b64ec018aa3f8de6747 10.0.0.78:6379
    slots: (0 slots) slave
    replicates d6e2eca6b338b717923f64866bd31d42e52edc98
S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379
    slots: (0 slots) slave
    replicates d34da8666a6f587283a1c2fca5d13691407f9462
S: f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379
    slots: (0 slots) slave
    replicates cb028b83f9dc463d732f6e76ca6bbcd469d948a7
M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379
    slots:[6827-10922] (4096 slots) master
    1 additional replica(s)
S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379
    slots: (0 slots) slave
    replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057
M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379
    slots:[12288-16383] (4096 slots) master
    1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#21040;&#20219;&#24847;&#38598;&#32676;&#33410;&#28857;&#65292;#&#26368;&#21518;1365&#20010;slot&#20174;10.0.0.8&#31227;&#21160;&#21040;&#31532;&#19968;&#20010;master&#33410;&#28857;10.0.0.28&#19978;</span>
[root@redis-node1 ~]#redis-cli -a centos --cluster reshard 10.0.0.18:6379
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface
may not be safe.
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.18:6379)
S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379
    slots: (0 slots) slave
    replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057
S: f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379
    slots: (0 slots) slave
    replicates cb028b83f9dc463d732f6e76ca6bbcd469d948a7
S: 36840d7eea5835ba540d9b64ec018aa3f8de6747 10.0.0.78:6379
    slots: (0 slots) slave
    replicates d6e2eca6b338b717923f64866bd31d42e52edc98
M: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379
    slots:[1365-5460] (4096 slots) master
    1 additional replica(s)
M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379
    slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
    1 additional replica(s)
S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379
    slots: (0 slots) slave
    replicates d34da8666a6f587283a1c2fca5d13691407f9462
M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379
    slots:[6827-10922] (4096 slots) master
    1 additional replica(s)
M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379
    slots:[12288-16383] (4096 slots) master
    1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
How many slots<span style="color: #a020f0;"> do</span> you want to move (from 1 to 16384)? 1365 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20849;4096/3&#20998;&#21035;&#32473;&#20854;&#23427;&#19977;&#20010;master&#33410;&#28857;</span>
What is the receiving node ID? d34da8666a6f587283a1c2fca5d13691407f9462 <span style="color: #b22222;">#</span><span style="color: #b22222;">master</span>
10.0.0.28
Please enter all the source node IDs.
    Type <span style="color: #8b2252;">'all'</span> to use all the nodes as source nodes for the hash slots.
    Type <span style="color: #8b2252;">'done'</span> once you entered all the source nodes IDs.
Source node <span style="color: #b22222;">#</span><span style="color: #b22222;">1: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 #&#36755;&#20837;&#35201;&#21024;&#38500;10.0.0.8&#33410;&#28857;ID</span>
Source node <span style="color: #b22222;">#</span><span style="color: #b22222;">2: done</span>

Ready to move 1356 slots.
  Source nodes:
    M: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379
        slots:[1365-5460] (4096 slots) master
        1 additional replica(s)
  Destination node:
    M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379
        slots:[12288-16383] (4096 slots) master
        1 additional replica(s)
Resharding plan:
  Moving slot 1365 from
cb028b83f9dc463d732f6e76ca6bbcd469d948a7
......
    Moving slot 2719 from cb028b83f9dc463d732f6e76ca6bbcd469d948a7
    Moving slot 2720 from cb028b83f9dc463d732f6e76ca6bbcd469d948a7
Do you want to proceed with the proposed reshard plan (yes/no)? yes <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#23450;</span>
......
Moving slot 2718 from 10.0.0.8:6379 to 10.0.0.28:6379: ..
Moving slot 2719 from 10.0.0.8:6379 to 10.0.0.28:6379: .
Moving slot 2720 from 10.0.0.8:6379 to 10.0.0.28:6379: ..

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38750;&#20132;&#20114;&#24335;&#26041;&#24335;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20877;&#23558;1365&#20010;slot&#20174;10.0.0.8&#31227;&#21160;&#21040;&#31532;&#20108;&#20010;master&#33410;&#28857;10.0.0.48&#19978;</span>
[root@redis-node1 ~]#redis-cli -a centos --cluster reshard 10.0.0.18:6379 --cluster-slots 1365 --cluster-from cb028b83f9dc463d732f6e76ca6bbcd469d948a7 --cluster-to d04e524daec4d8e22bdada7f21a9487c2d3e1057 --cluster-yes

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#21518;&#30340;slot&#20174;10.0.0.8&#31227;&#21160;&#21040;&#31532;&#19977;&#20010;master&#33410;&#28857;10.0.0.68&#19978;</span>
[root@redis-node1 ~]#redis-cli -a 123456 --cluster reshard 10.0.0.18:6379 --cluster-slots 1375 --cluster-from cb028b83f9dc463d732f6e76ca6bbcd469d948a7 --cluster-to d6e2eca6b338b717923f64866bd31d42e52edc98 --cluster-yes

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#35748;10.0.0.8&#30340;&#25152;&#26377;slot&#37117;&#31227;&#36208;&#20102;&#65292;&#19978;&#38754;&#30340;slave&#20063;&#33258;&#21160;&#21024;&#38500;&#65292;&#25104;&#20026;&#20854;&#23427;master&#30340;slave</span>
[root@redis-node1 ~]#redis-cli -a 123456 --cluster check 10.0.0.8:6379
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface
may not be safe.
10.0.0.8:6379 (cb028b83...) -&gt; 0 keys | 0 slots | 0 slaves.
10.0.0.68:6379 (d6e2eca6...) -&gt; 6631 keys | 5471 slots | 2 slaves.
10.0.0.48:6379 (d04e524d...) -&gt; 6694 keys | 5461 slots | 1 slaves.
10.0.0.28:6379 (d34da866...) -&gt; 6675 keys | 5452 slots | 1 slaves.
[OK] 20000 keys<span style="color: #a020f0;"> in</span> 4 masters.
1.22 keys per slot on average.
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.8:6379)
M: cb028b83f9dc463d732f6e76ca6bbcd469d948a7 10.0.0.8:6379
    slots: (0 slots) master
M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379
    slots:[0-1364],[4086-6826],[10923-12287] (5471 slots) master
    2 additional replica(s)
S: 36840d7eea5835ba540d9b64ec018aa3f8de6747 10.0.0.78:6379
    slots: (0 slots) slave
    replicates d6e2eca6b338b717923f64866bd31d42e52edc98
S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379
    slots: (0 slots) slave
    replicates d34da8666a6f587283a1c2fca5d13691407f9462
S: f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379
    slots: (0 slots) slave
    replicates d6e2eca6b338b717923f64866bd31d42e52edc98
M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379
    slots:[2721-4085],[6827-10922] (5461 slots) master
    1 additional replica(s)
S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379
    slots: (0 slots) slave
    replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057
M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379
    slots:[1365-2720],[12288-16383] (5452 slots) master
    1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21407;&#26377;&#30340;10.0.0.38&#33258;&#21160;&#25104;&#20026;10.0.0.68&#30340;slave</span>
[root@redis-node1 ~]#redis-cli -a centos -h 10.0.0.68 INFO replication
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface
may not be safe.
<span style="color: #b22222;"># </span><span style="color: #b22222;">Replication</span>
role:master
connected_slaves:2
slave0:<span style="color: #a0522d;">ip</span>=10.0.0.78,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=129390,<span style="color: #a0522d;">lag</span>=0
slave1:<span style="color: #a0522d;">ip</span>=10.0.0.38,<span style="color: #a0522d;">port</span>=6379,<span style="color: #a0522d;">state</span>=online,<span style="color: #a0522d;">offset</span>=129390,<span style="color: #a0522d;">lag</span>=0
master_replid:43e3e107a0acb1fd5a97240fc4b2bd8fc85b113f
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:129404
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:129404

[root@centos8 ~]#redis-cli -a centos -h 10.0.0.8 --no-auth-warning cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:8       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38598;&#32676;&#20013;8&#20010;&#33410;&#28857;</span>
cluster_size:3      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23569;&#20102;&#19968;&#20010;&#20027;&#20174;&#30340;slot</span>
cluster_current_epoch:16
cluster_my_epoch:13
cluster_stats_messages_ping_sent:3165
cluster_stats_messages_pong_sent:2489
cluster_stats_messages_fail_sent:6
cluster_stats_messages_auth-req_sent:5
cluster_stats_messages_auth-ack_sent:1
cluster_stats_messages_update_sent:27
cluster_stats_messages_sent:5693
cluster_stats_messages_ping_received:2483
cluster_stats_messages_pong_received:2400
cluster_stats_messages_meet_received:2
cluster_stats_messages_fail_received:2
cluster_stats_messages_auth-req_received:1
cluster_stats_messages_auth-ack_received:2
cluster_stats_messages_update_received:4
cluster_stats_messages_received:4894
</pre>
</div>
</div>
</li>
<li><a id="h:4c32a7d4-389b-482e-856b-8d3de9708ab8"></a>从集群删除服务器<br>
<div class="outline-text-6" id="text-h:4c32a7d4-389b-482e-856b-8d3de9708ab8">
<p>
虽然槽位已经迁移完成，但是服务器IP信息还在集群当中，因此还需要将IP信息从集群删除
</p>

<p>
<b>注意: 删除服务器前,必须清除主机上面的槽位,否则会删除主机失败</b>
</p>

<p>
<b>Redis 3/4：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@s~]#redis-trib.rb del-node 10.0.0.8:6379
dfffc371085859f2858730e1f350e9167e287073
&gt;&gt;&gt; Removing node dfffc371085859f2858730e1f350e9167e287073 from cluster 10.0.0.8:6379
&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...
&gt;&gt;&gt; SHUTDOWN the node.
</pre>
</div>

<p>
<b>Redis 5：</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis-node1 ~]#redis-cli -a centos --cluster del-node 10.0.0.8:6379 cb028b83f9dc463d732f6e76ca6bbcd469d948a7
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the
<span style="color: #483d8b;">command</span> line interface may not be safe.
&gt;&gt;&gt; Removing node
cb028b83f9dc463d732f6e76ca6bbcd469d948a7 from cluster
10.0.0.8:6379
&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...
&gt;&gt;&gt; SHUTDOWN the node.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#33410;&#28857;&#21518;,redis&#36827;&#31243;&#33258;&#21160;&#20851;&#38381;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#33410;&#28857;&#20449;&#24687;</span>
[root@redis-node1 ~]#rm -f /var/lib/redis/nodes-6379.conf
</pre>
</div>
</div>
</li>
<li><a id="h:54ff56c7-0cc4-484b-9d54-04b7a4d2e224"></a>删除多余的slave节点验证结果<br>
<div class="outline-text-6" id="text-h:54ff56c7-0cc4-484b-9d54-04b7a4d2e224">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#21024;&#38500;&#25104;&#21151;</span>
[root@redis-node1 ~]# ss -ntl
State       Recv-Q Send-Q      Local Address:Port                     Peer Address:Port              
LISTEN      0      100             127.0.0.1:25                                  *:*                  
LISTEN      0      128                     *:22                                  *:*                  
LISTEN      0      100                 [::1]:25                               [::]:*                  
LISTEN      0      128                  [::]:22                               [::]:*  

[root@redis-node1 ~]#redis-cli -a centos --cluster check 10.0.0.18:6379
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
10.0.0.68:6379 (d6e2eca6...) -&gt; 6631 keys | 5471 slots | 2 slaves.
10.0.0.48:6379 (d04e524d...) -&gt; 6694 keys | 5461 slots | 1 slaves.
10.0.0.28:6379 (d34da866...) -&gt; 6675 keys | 5452 slots | 1 slaves.
[OK] 20000 keys<span style="color: #a020f0;"> in</span> 3 masters.
1.22 keys per slot on average.
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.18:6379)
S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379
    slots: (0 slots) slave
    replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057
S: f9adcfb8f5a037b257af35fa548a26ffbadc852d 10.0.0.38:6379
    slots: (0 slots) slave
    replicates d6e2eca6b338b717923f64866bd31d42e52edc98
S: 36840d7eea5835ba540d9b64ec018aa3f8de6747 10.0.0.78:6379
    slots: (0 slots) slave
    replicates d6e2eca6b338b717923f64866bd31d42e52edc98
M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379
    slots:[0-1364],[4086-6826],[10923-12287] (5471 slots) master
    2 additional replica(s)
S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379
    slots: (0 slots) slave
    replicates d34da8666a6f587283a1c2fca5d13691407f9462
M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379
    slots:[2721-4085],[6827-10922] (5461 slots) master
    1 additional replica(s)
M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379
    slots:[1365-2720],[12288-16383] (5452 slots) master
    1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#22810;&#20313;&#30340;slave&#20174;&#33410;&#28857;</span>
[root@redis-node1 ~]#redis-cli -a centos --cluster del-node 10.0.0.18:6379 f9adcfb8f5a037b257af35fa548a26ffbadc852d
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
&gt;&gt;&gt; Removing node
f9adcfb8f5a037b257af35fa548a26ffbadc852d from cluster
10.0.0.18:6379
&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...
&gt;&gt;&gt; SHUTDOWN the node.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#38598;&#32676;&#25991;&#20214;</span>
[root@redis-node4 ~]#rm -f /var/lib/redis/nodes-6379.conf

[root@redis-node1 ~]#redis-cli -a centos --cluster check 10.0.0.18:6379
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
10.0.0.68:6379 (d6e2eca6...) -&gt; 6631 keys | 5471 slots | 1 slaves.
10.0.0.48:6379 (d04e524d...) -&gt; 6694 keys | 5461 slots | 1 slaves.
10.0.0.28:6379 (d34da866...) -&gt; 6675 keys | 5452 slots | 1 slaves.
[OK] 20000 keys<span style="color: #a020f0;"> in</span> 3 masters.
1.22 keys per slot on average.
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.18:6379)
S: 99720241248ff0e4c6fa65c2385e92468b3b5993 10.0.0.18:6379
    slots: (0 slots) slave
    replicates d04e524daec4d8e22bdada7f21a9487c2d3e1057
S: 36840d7eea5835ba540d9b64ec018aa3f8de6747 10.0.0.78:6379
    slots: (0 slots) slave
    replicates d6e2eca6b338b717923f64866bd31d42e52edc98
M: d6e2eca6b338b717923f64866bd31d42e52edc98 10.0.0.68:6379
    slots:[0-1364],[4086-6826],[10923-12287] (5471 slots) master
    1 additional replica(s)
S: 9875b50925b4e4f29598e6072e5937f90df9fc71 10.0.0.58:6379
    slots: (0 slots) slave
    replicates d34da8666a6f587283a1c2fca5d13691407f9462
M: d04e524daec4d8e22bdada7f21a9487c2d3e1057 10.0.0.48:6379
    slots:[2721-4085],[6827-10922] (5461 slots) master
    1 additional replica(s)
M: d34da8666a6f587283a1c2fca5d13691407f9462 10.0.0.28:6379
    slots:[1365-2720],[12288-16383] (5452 slots) master
    1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.

[root@redis-node1 ~]#redis-cli -a centos --cluster info 10.0.0.18:6379
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
10.0.0.68:6379 (d6e2eca6...) -&gt; 6631 keys | 5471 slots | 1 slaves.
10.0.0.48:6379 (d04e524d...) -&gt; 6694 keys | 5461 slots | 1 slaves.
10.0.0.28:6379 (d34da866...) -&gt; 6675 keys | 5452 slots | 1 slaves.
[OK] 20000 keys<span style="color: #a020f0;"> in</span> 3 masters.
1.22 keys per slot on average.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#38598;&#32676;&#20449;&#24687;</span>
[root@redis-node1 ~]#redis-cli -a centos -h 10.0.0.18 CLUSTER INFO
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#26377;6&#20010;&#33410;&#28857;</span>
cluster_size:3
cluster_current_epoch:11
cluster_my_epoch:10
cluster_stats_messages_ping_sent:12147
cluster_stats_messages_pong_sent:12274
cluster_stats_messages_update_sent:14
cluster_stats_messages_sent:24435
cluster_stats_messages_ping_received:12271
cluster_stats_messages_pong_received:12147
cluster_stats_messages_meet_received:3
cluster_stats_messages_update_received:28
cluster_stats_messages_received:24449
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:ab5e7a88-bcfb-4f2f-99d2-371217d26996" class="outline-5">
<h5 id="h:ab5e7a88-bcfb-4f2f-99d2-371217d26996">集群维护之导入现有Redis数据至集群</h5>
<div class="outline-text-5" id="text-h:ab5e7a88-bcfb-4f2f-99d2-371217d26996">
<p>
官方提供了离线迁移数据到集群的工具,有些公司开发了离线迁移工具
</p>

<ul class="org-ul">
<li>官方工具: redis-cli &#x2013;cluster import</li>
<li>第三方在线迁移工具: 模拟slave 节点实现, 比如: 唯品会redis-migrate-tool , 豌豆荚 redis-port</li>
</ul>

<p>
<b>导入适用场景</b>:
</p>

<p>
业务数据初始是放在单一节点的主机上，随着业务量上升，建立了redis集群，需要将之前旧数据导入到新建的redis cluster中。
</p>

<p>
注意: 导入数据需要redis cluster不能与被导入的数据有重复的key名称，否则导入不成功或中断。
</p>
</div>
<ul class="org-ul">
<li><a id="h:b3b37a2b-64b8-4535-ae34-9526a9df472f"></a>基础环境准备<br>
<div class="outline-text-6" id="text-h:b3b37a2b-64b8-4535-ae34-9526a9df472f">
<p>
因为导入时不能指定验证密码，所以导入数据之前需要关闭所有redis节点的密码。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#25152;&#26377;&#33410;&#28857;&#21253;&#25324;master&#21644;slave&#33410;&#28857;&#19978;&#20851;&#38381;&#21508;Redis&#23494;&#30721;&#35748;&#35777;</span>
[root@redis ~]# redis-cli -h 10.0.0.18 -p 6379 -a centos --no-auth-warning CONFIG SET requirepass <span style="color: #8b2252;">""</span>
OK
</pre>
</div>
</div>
</li>
<li><a id="h:3fd05ed0-d65d-466c-b438-956f6e156d70"></a>执行数据导入<br>
<div class="outline-text-6" id="text-h:3fd05ed0-d65d-466c-b438-956f6e156d70">
<p>
将源Redis server的数据直接导入之 redis cluster,此方式慎用!，建议让开发人员做
</p>

<p>
Redis 3/4：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis ~]# redis-trib.rb import --from &lt;&#22806;&#37096;Redis node-IP:PORT&gt; --replace &lt;&#38598;&#32676;&#26381;&#21153;&#22120;IP:PORT&gt;
</pre>
</div>

<p>
Redis 5以上版本命令：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@redis ~]#redis-cli --cluster import &lt;&#38598;&#32676;&#26381;&#21153;&#22120;IP:PORT&gt; --cluster-from &lt;&#22806;&#37096;Redis node-IP:PORT&gt; --cluster-copy --cluster-replace

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#20351;&#29992;cluster-copy&#65292;&#21017;&#35201;&#23548;&#20837;&#38598;&#32676;&#20013;&#30340;key&#19981;&#33021;&#23384;&#22312;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#38598;&#32676;&#20013;&#24050;&#26377;&#21516;&#26679;&#30340;key&#65292;&#22914;&#26524;&#38656;&#35201;&#26367;&#25442;&#65292;&#21487;&#20197;cluster-copy&#21644;cluster-replace&#32852;&#21512;&#20351;&#29992;&#65292;&#36825;&#26679;&#38598;&#32676;&#20013;&#30340;key&#23601;&#20250;&#34987;&#26367;&#25442;&#20026;&#22806;&#37096;&#25968;&#25454;</span>
</pre>
</div>

<p>
范例：将非集群节点的数据导入redis cluster
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#38750;&#38598;&#32676;&#33410;&#28857;10.0.0.78&#29983;&#25104;&#25968;&#25454;</span>
[root@centos8 ~]#hostname -I
10.0.0.78
[root@redis-node1 ~]# cat redis_test.sh 
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash</span>

<span style="color: #a0522d;">NUM</span>=10
<span style="color: #a0522d;">PASS</span>=centos
<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> <span style="color: #ff00ff;">`seq $NUM`</span>;<span style="color: #a020f0;">do</span>
  redis-cli -h 127.0.0.1 -a <span style="color: #8b2252;">"$PASS"</span> --no-auth-warning set testkey${<span style="color: #a0522d;">i</span>} testvalue${<span style="color: #a0522d;">i</span>}
  <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"testkey${i} testvalue${i} &#20889;&#20837;&#23436;&#25104;"</span>
<span style="color: #a020f0;">done</span>
<span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">"$NUM&#20010;key&#20889;&#20837;&#21040;Redis&#23436;&#25104;"</span>

[root@centos8 ~]#bash redis_test.sh
OK
testkey1 testvalue1 &#20889;&#20837;&#23436;&#25104;
OK
testkey2 testvalue2 &#20889;&#20837;&#23436;&#25104;
OK
testkey3 testvalue3 &#20889;&#20837;&#23436;&#25104;
OK
testkey4 testvalue4 &#20889;&#20837;&#23436;&#25104;
OK
testkey5 testvalue5 &#20889;&#20837;&#23436;&#25104;
OK
testkey6 testvalue6 &#20889;&#20837;&#23436;&#25104;
OK
testkey7 testvalue7 &#20889;&#20837;&#23436;&#25104;
OK
testkey8 testvalue8 &#20889;&#20837;&#23436;&#25104;
OK
testkey9 testvalue9 &#20889;&#20837;&#23436;&#25104;
OK
testkey10 testvalue10 &#20889;&#20837;&#23436;&#25104;
10&#20010;key&#20889;&#20837;&#21040;Redis&#23436;&#25104;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#28040;&#38656;&#35201;&#23548;&#20837;&#30340;&#20027;&#26426;&#30340;&#23494;&#30721;</span>
[root@centos8 ~]#redis-cli -h 10.0.0.78 -p 6379 -a centos --no-auth-warning
CONFIG SET requirepass <span style="color: #8b2252;">""</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#28040;&#25152;&#26377;&#38598;&#32676;&#26381;&#21153;&#22120;&#30340;&#23494;&#30721;</span>
[root@centos8 ~]#redis-cli -h 10.0.0.8 -p 6379 -a centos --no-auth-warning CONFIG SET requirepass <span style="color: #8b2252;">""</span>
[root@centos8 ~]#redis-cli -h 10.0.0.18 -p 6379 -a centos --no-auth-warning CONFIG SET requirepass <span style="color: #8b2252;">""</span>
[root@centos8 ~]#redis-cli -h 10.0.0.28 -p 6379 -a centos --no-auth-warning CONFIG SET requirepass <span style="color: #8b2252;">""</span>
[root@centos8 ~]#redis-cli -h 10.0.0.38 -p 6379 -a centos --no-auth-warning CONFIG SET requirepass <span style="color: #8b2252;">""</span>
[root@centos8 ~]#redis-cli -h 10.0.0.48 -p 6379 -a centos --no-auth-warning CONFIG SET requirepass <span style="color: #8b2252;">""</span>
[root@centos8 ~]#redis-cli -h 10.0.0.58 -p 6379 -a centos --no-auth-warning CONFIG SET requirepass <span style="color: #8b2252;">""</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20837;&#25968;&#25454;&#33267;&#38598;&#32676;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;:Redis6.2.4&#29256;&#26412;&#22312;cluster&#38598;&#32676;&#30340;&#20219;&#24847;&#33410;&#28857;&#25110;&#38750;&#38598;&#32676;&#33410;&#28857;&#25191;&#34892;&#19979;&#38754;&#25805;&#20316;&#23548;&#20837;&#22823;&#37327;&#25968;&#25454;&#26102;&#37117;&#20250;&#20986;&#29616;"Segmentation fault"&#30340;&#38169;&#35823;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">Redis6.2.4&#29256;&#26412;&#30340;&#38598;&#32676;&#23548;&#20837;&#22823;&#37327;&#25968;&#25454;&#26102;&#65292;&#22914;&#26524;&#26159;&#22312;&#38750;&#38598;&#32676;&#30340;&#22806;&#37096;&#33410;&#28857;Redis5&#25191;&#34892;&#19979;&#38754;&#25805;&#20316;&#21364;&#21487;&#20197;&#25104;&#21151;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;Centos8&#19978;&#30340;Redis5&#29256;&#26412;&#38598;&#32676;&#21017;&#27809;&#26377;&#27492;&#38382;&#39064;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20837;&#25968;&#25454;&#33267;&#38598;&#32676;</span>
[root@centos8 ~]#redis-cli --cluster import 10.0.0.8:6379 --cluster-from 10.0.0.78:6379 --cluster-copy --cluster-replace
&gt;&gt;&gt; Importing data from 10.0.0.78:6379 to cluster 10.0.0.8:6379
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.8:6379)
M: a177c5cbc2407ebb6230ea7e2a7de914bf8c2dab 10.0.0.8:6379
    slots:[0-5461] (5462 slots) master
    1 additional replica(s)
M: 4f146b1ac51549469036a272c60ea97f065ef832 10.0.0.28:6379
    slots:[10923-16383] (5461 slots) master
    1 additional replica(s)
S: 779a24884dbe1ceb848a685c669ec5326e6c8944 10.0.0.48:6379
    slots: (0 slots) slave
    replicates 97c5dcc3f33c2fc75c7fdded25d05d2930a312c0
M: 97c5dcc3f33c2fc75c7fdded25d05d2930a312c0 10.0.0.18:6379
    slots:[5462-10922] (5461 slots) master
    1 additional replica(s)
S: 07231a50043d010426c83f3b0788e6b92e62050f 10.0.0.58:6379
    slots: (0 slots) slave
    replicates 4f146b1ac51549469036a272c60ea97f065ef832
S: cb20d58870fe05de8462787cf9947239f4bc5629 10.0.0.38:6379
    slots: (0 slots) slave
    replicates a177c5cbc2407ebb6230ea7e2a7de914bf8c2dab
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.

Importing 10 keys from DB 0
Migrating testkey4 to 10.0.0.18:6379: OK
Migrating testkey8 to 10.0.0.18:6379: OK
Migrating testkey6 to 10.0.0.28:6379: OK
Migrating testkey1 to 10.0.0.8:6379: OK
Migrating testkey5 to 10.0.0.8:6379: OK
Migrating testkey10 to 10.0.0.28:6379: OK
Migrating testkey7 to 10.0.0.18:6379: OK
Migrating testkey9 to 10.0.0.8:6379: OK
Migrating testkey2 to 10.0.0.28:6379: OK
Migrating testkey3 to 10.0.0.18:6379: OK

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#25968;&#25454;</span>
[root@centos8 ~]#redis-cli -h 10.0.0.8 keys <span style="color: #8b2252;">'*'</span>
1) <span style="color: #8b2252;">"testkey5"</span>
2) <span style="color: #8b2252;">"testkey1"</span>
3) <span style="color: #8b2252;">"testkey9"</span>
[root@centos8 ~]#redis-cli -h 10.0.0.18 keys <span style="color: #8b2252;">'*'</span>
1) <span style="color: #8b2252;">"testkey8"</span>
2) <span style="color: #8b2252;">"testkey4"</span>
3) <span style="color: #8b2252;">"testkey3"</span>
4) <span style="color: #8b2252;">"testkey7"</span>
[root@centos8 ~]#redis-cli -h 10.0.0.28 keys <span style="color: #8b2252;">'*'</span>
1) <span style="color: #8b2252;">"testkey6"</span>
2) <span style="color: #8b2252;">"testkey10"</span>
3) <span style="color: #8b2252;">"testkey2"</span>
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:f40a6764-c5cd-46aa-8d62-e1d56e1050d2" class="outline-5">
<h5 id="h:f40a6764-c5cd-46aa-8d62-e1d56e1050d2">集群偏斜</h5>
<div class="outline-text-5" id="text-h:f40a6764-c5cd-46aa-8d62-e1d56e1050d2">
<p>
redis cluster 多个节点运行一段时间后,可能会出现倾斜现象,某个节点数据偏多,内存消耗更大,或者接受用户请求访问更多
</p>

<p>
发生倾斜的原因可能如下:
</p>

<ul class="org-ul">
<li>节点和槽分配不均</li>
<li>不同槽对应键值数量差异较大</li>
<li>包含bigkey,建议少用</li>
<li>内存相关配置不一致</li>
<li>热点数据不均衡 : 一致性不高时,可以使用本地缓存和MQ</li>
</ul>

<p>
获取指定槽位中对应键key值的个数
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">redis-cli cluster countkeysinslot {slot&#30340;&#20540;}</span>
</pre>
</div>

<p>
范例: 获取指定slot对应的key个数
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#redis-cli -a centos cluster countkeysinslot 1
(integer) 0
[root@centos8 ~]#redis-cli -a centos cluster countkeysinslot 2
(integer) 0
[root@centos8 ~]#redis-cli -a centos cluster countkeysinslot 3
(integer) 1
</pre>
</div>

<p>
执行自动的槽位重新平衡分布,但会影响客户端的访问,此方法慎用
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">redis-cli --cluster rebalance &lt;&#38598;&#32676;&#33410;&#28857;IP:PORT&gt;</span>
</pre>
</div>

<p>
范例: 执行自动的槽位重新平衡分布
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#redis-cli -a centos --cluster rebalance 10.0.0.8:6379
&gt;&gt;&gt; Performing Cluster Check (using node 10.0.0.8:6379)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
*** No rebalancing needed! All nodes are within the 2.00% threshold.
:PROPERTIES:
:CUSTOM_ID: h:b5777d34-a667-43b0-ac82-e5108d82737a
:END:
</pre>
</div>

<p>
获取bigkey ,建议在slave节点执行
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">redis-cli --bigkeys</span>
</pre>
</div>

<p>
范例: 查找 bigkey
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#redis-cli -a centos --bigkeys
<span style="color: #b22222;"># </span><span style="color: #b22222;">Scanning the entire keyspace to find biggest keys as well as</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">average sizes per key type. You can use -i 0.1 to sleep 0.1 sec</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">per 100 SCAN commands (not usually needed).</span>

[00.00%] Biggest string found so far <span style="color: #8b2252;">'key8811'</span> with 9 bytes
[26.42%] Biggest string found so far <span style="color: #8b2252;">'testkey1'</span> with 10 bytes

-------- summary -------

Sampled 3335 keys<span style="color: #a020f0;"> in</span> the keyspace!
Total key length<span style="color: #a020f0;"> in</span> bytes is 22979 (avg len 6.89)

Biggest string found <span style="color: #8b2252;">'testkey1'</span> has 10 bytes

3335 strings with 29649 bytes (100.00% of keys, avg size 8.89)
0 lists with 0 items (00.00% of keys, avg size 0.00)
0 sets with 0 members (00.00% of keys, avg size 0.00)
0 hashs with 0 fields (00.00% of keys, avg size 0.00)
0 zsets with 0 members (00.00% of keys, avg size 0.00)
0 streams with 0 entries (00.00% of keys, avg size 0.00)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:07b6abe2-e024-480b-8ae0-819379899ef6" class="outline-4">
<h4 id="h:07b6abe2-e024-480b-8ae0-819379899ef6">redis cluster 的局限性</h4>
<div class="outline-text-4" id="text-h:07b6abe2-e024-480b-8ae0-819379899ef6">
</div>
<div id="outline-container-h:16ff895a-7880-4771-b6c1-1a6b069a6794" class="outline-5">
<h5 id="h:16ff895a-7880-4771-b6c1-1a6b069a6794">集群的读写分离</h5>
<div class="outline-text-5" id="text-h:16ff895a-7880-4771-b6c1-1a6b069a6794">
<p>
在集群模式下的从节点是只读连接的，也就是说集群模式中的从节点是拒绝任何读写请求的。当有命令尝试从slave节点获取数据时，slave节点会重定向命令到负责该数据所在槽的节点。
</p>

<p>
为什么说是只读连接呢?因为slave可以执行命令:readonly，这样从节点就能读取请求，但是这只是在这次连接中生效。也就是说，当客户端断开连接重启后，再次请求又变成重定向了。
</p>

<p>
集群模式下的读写分离更加复杂，需要维护不同主节点的从节点和对于槽的关系。
</p>

<p>
通常是不建议在集群模式下构建读写分离，而是添加节点来解决需求。不过考虑到节点之间信息交流带来的带宽问题，官方建议节点数不超过1000个。
</p>
</div>
</div>
<div id="outline-container-h:ad4c89f9-bf54-400b-8501-17c4e4294df4" class="outline-5">
<h5 id="h:ad4c89f9-bf54-400b-8501-17c4e4294df4">单机，哨兵和集群的选择</h5>
<div class="outline-text-5" id="text-h:ad4c89f9-bf54-400b-8501-17c4e4294df4">
<ul class="org-ul">
<li>大多数时客户端性能会"降低"</li>
<li>命令无法跨节点使用:mget、keys、scan、flush、sinter等</li>
<li>客户端维护更复杂:SDK和应用本身消耗(例如更多的连接池)</li>
<li>不支持多个数据库:集群模式下只有一个db 0</li>
<li>复制只支持一层:不支持树形复制结构，不支持级联复制</li>
<li>Key事务和Lua支持有限:操作的key必须在一个节点，Lua和事务无法跨节点使用</li>
</ul>

<p>
所以集群搭建还要考虑单机redis是否已经不能满足业务的并发量，在redis sentinel同样能够满足高可用，且并发并未饱和的前提下，搭建集群反而是画蛇添足了。
</p>

<p>
范例: 跨slot的局限性
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#redis-cli -a centos mget key1 key2 key3
Warning: Using a password with <span style="color: #8b2252;">'-a'</span> or <span style="color: #8b2252;">'-u'</span> option on the command line interface may not be safe.
(error) CROSSSLOT Keys<span style="color: #a020f0;"> in</span> request don<span style="color: #8b2252;">'t hash to the same slot</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:81bc8d2b-5167-4c6a-8628-feb49c6020aa" class="outline-3">
<h3 id="h:81bc8d2b-5167-4c6a-8628-feb49c6020aa">redis 扩展集群方案</h3>
<div class="outline-text-3" id="text-h:81bc8d2b-5167-4c6a-8628-feb49c6020aa">
<p>
在Redis 官方自带的Redis
cluster集群功能出来之前，有一些开源的集群解决方案可被参考使用
</p>
</div>
<div id="outline-container-h:fac73ae2-1f3c-4664-80b5-df182feeb152" class="outline-4">
<h4 id="h:fac73ae2-1f3c-4664-80b5-df182feeb152">codis</h4>
<div class="outline-text-4" id="text-h:fac73ae2-1f3c-4664-80b5-df182feeb152">

<figure id="org519630b">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201025215035267.png" alt="20201025215035267.png">

</figure>

<p>
Codis 是一个豌豆荚开发基于go实现的分布式 Redis 解决方案,对于上层的应用
来说, 连接到 Codis Proxy 和连接原生的 Redis Server没有显著区别 (不支持
的命令列表), 上层应用可以像使用单机的Redis 一样使用, Codis 底层会处理
请求的转发, 不停机的数据迁移等工作, 所有后边的一切事情,对于前面的客户
端来说是透明的, 可以简单的认为后边连接的是一个内存无限大的Redis 服务
</p>

<p>
codis-proxy相当于redis，即连接codis-proxy和连接redis是没有任何区别的，
codis-proxy无状态，不负责记录是否在哪保存，数据在zookeeper记录，即
codis proxy向zookeeper查询key的记录位置，proxy将请求转发到一个组进行处
理，一个组里面有一个master和一个或者多个slave组成，默认有1024个槽位，
而redis cluster 默认有16384个槽位，其把不同的槽位的内容放在不同的group
</p>

<p>
Github 地址：<a href="https://github.com/CodisLabs/codis/">https://github.com/CodisLabs/codis/</a>
</p>


<figure id="orgdea3b60">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/2020102521512977.png" alt="2020102521512977.png">

</figure>
</div>
</div>
<div id="outline-container-h:650dbd99-c8ef-40a5-9472-3b65305c724b" class="outline-4">
<h4 id="h:650dbd99-c8ef-40a5-9472-3b65305c724b">twemproxy</h4>
<div class="outline-text-4" id="text-h:650dbd99-c8ef-40a5-9472-3b65305c724b">

<figure id="orgd69fe29">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201025215143707.png" alt="20201025215143707.png">

</figure>

<p>
Twemproxy是一种代理分片机制，由Twitter开源。Twemproxy作为代理，可接受
来自多个程序的访问，按照proxy配置的算法，转发给后台的各个Redis服务器，
再原路返回。解决了单个Redis实例承载能力的问题。Twemproxy本身也是单点，
需要用Keepalived做高可用方案。通过Twemproxy可以使用多台服务器来水平扩
张redis服务，可以有效的避免单点故障问题。虽然使用Twemproxy需要更多的硬
件资源和在redis性能有一定的损失（twitter测试约20%），也不支持数据迁移。
但是能够提高整个系统的HA,另外twemproxy实现了memcached协议
</p>

<p>
Github 地址：<a href="https://github.com/twitter/twemproxy">https://github.com/twitter/twemproxy</a>
</p>


<figure id="org5725e12">
<img src="https://raw.githubusercontent.com/jaspervincent/webimage/master/linux/nosql-cache/redis/images/20201025215217483.png" alt="20201025215217483.png">

</figure>
</div>
</div>
</div>
</section>
<section id="outline-container-h:3f464827-82ca-4da6-9afa-9fae572b29cf" class="outline-2">
<h2 id="h:3f464827-82ca-4da6-9afa-9fae572b29cf">常见面试题</h2>
<div class="outline-text-2" id="text-h:3f464827-82ca-4da6-9afa-9fae572b29cf">
<ul class="org-ul">
<li>Redis做什么的,即在哪些场景下使用</li>
<li>如果监控Redis是否出现故障  ping pong</li>
<li>Zabbix监控 Redis哪些监控项</li>
<li>RDB和AOF持久化区别</li>
<li>docker拉取一个Redis如何实现数据持久化保存</li>
<li>redis支持哪些数据类型</li>
<li>消息队列</li>
<li>主从复制工作原理</li>
<li>Redis如何实现高可用</li>
<li>哨兵工作原理</li>
<li>Redis集群的工作原理</li>
<li>Redis集群如果避免脑裂</li>
<li>Redis集群最少几个节点为什么?</li>
<li>Redis的集群槽位多少个</li>
<li>Redis集群中某个节点缺少一个槽位是否能使用</li>
<li>Redis数据写入的时候是怎么在各个节点槽位分配数据的</li>
<li>Redis的数据存储是以什么样的方式存储</li>
<li>Redis集群的各槽位和总槽位之间什么关系</li>
</ul>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
