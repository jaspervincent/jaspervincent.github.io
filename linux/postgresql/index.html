<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: PostgreSQL</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux: PostgreSQL</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:9564f086-f540-4896-b877-a02f1f06c15a">PostgreSQL 介绍和特性</a>
<ul>
<li><a href="#postgresql-介绍">PostgreSQL 介绍</a></li>
<li><a href="#数据库排名">数据库排名</a></li>
<li><a href="#h:7b187971-6170-4e10-9393-dd9f4f078ba4">PostgreSQL与MySQL对比</a></li>
<li><a href="#各种数据库性能比较">各种数据库性能比较</a></li>
<li><a href="#h:5fa2147b-e991-49d5-8d9f-19fde19ef56d">PostgreSQL各版本的特性矩阵</a></li>
</ul>
</li>
<li><a href="#postgresql-安装">PostgreSQL 安装</a>
<ul>
<li><a href="#二进制包安装">二进制包安装</a>
<ul>
<li><a href="#rhelcentosrocky安装-postgresql">RHEL/CentOS/Rocky安装 PostgreSQL</a></li>
<li><a href="#ubuntu-安装-postgresql">Ubuntu 安装 PostgreSQL</a></li>
</ul>
</li>
<li><a href="#源码编译安装">源码编译安装</a>
<ul>
<li><a href="#编译安装过程说明">编译安装过程说明</a></li>
<li><a href="#h:59b4da69-9386-478a-a3a9-fe30dd2f1db5">系统初始化和优化配置</a></li>
<li><a href="#h:bd49280c-7b6a-4903-a2b6-e307c04a10d8">安装依赖包</a></li>
<li><a href="#h:b7677d9d-b9b0-450c-9765-f7ec97f8bb2b">源码编译安装</a></li>
<li><a href="#h:92afb878-2173-4dee-8559-d787e7340ac7">创建数据库用户和组</a></li>
<li><a href="#h:47ab6842-8e72-4f6a-9a1c-225162c4da90">创建数据目录并授权</a></li>
<li><a href="#h:f2054ef0-4caf-4526-bac1-fa6e6e12405d">设置环境变量</a></li>
<li><a href="#h:ebf408b4-29b4-4178-8a06-d24bb6e7945b">初始化数据库</a></li>
<li><a href="#h:40bb07ea-2178-43c7-95db-f531a75c5f8b">启动和关闭服务</a></li>
<li><a href="#查看编译和相关信息">查看编译和相关信息</a></li>
</ul>
</li>
<li><a href="#h:199da93e-9605-40bb-82c5-9ef9cae297ae">pg_ctl 命令管理PostgreSQL</a>
<ul>
<li><a href="#初始化实例">初始化实例</a></li>
<li><a href="#服务管理">服务管理</a>
<ul>
<li><a href="#查看服务状态">查看服务状态</a></li>
<li><a href="#启动服务">启动服务</a></li>
<li><a href="#停止服务">停止服务</a></li>
<li><a href="#重启服务">重启服务</a></li>
<li><a href="#加载配置">加载配置</a></li>
</ul>
</li>
<li><a href="#promote-模式">promote 模式</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#postgresql-管理">PostgreSQL 管理</a>
<ul>
<li><a href="#配置文件介绍">配置文件介绍</a></li>
<li><a href="#数据库相关概念">数据库相关概念</a>
<ul>
<li><a href="#数据库的结构组织">数据库的结构组织</a></li>
<li><a href="#h:6391ee54-ebd3-4e22-b726-68acecbb8c7f">PostgreSQL中的术语</a></li>
<li><a href="#h:f292435d-b97b-48e4-8a86-d983986b8322">模版数据库template0 和template1</a></li>
<li><a href="#h:1fc19b87-d753-400a-ab39-d76be716a167">模式 schema</a></li>
<li><a href="#h:88d7dc17-4387-45b2-ae43-83cdaa27eeb2">psql 工具介绍和基本用法</a></li>
</ul>
</li>
<li><a href="#连接管理">连接管理</a>
<ul>
<li><a href="#访问控制配置文件介绍">访问控制配置文件介绍</a></li>
<li><a href="#打开远程连接">打开远程连接</a></li>
</ul>
</li>
<li><a href="#常用操作">常用操作</a>
<ul>
<li><a href="#h:20a0e6cf-1c7b-4644-a3c8-3bdd49945907">查看psql帮助</a></li>
<li><a href="#设置显示信息的格式">设置显示信息的格式</a></li>
<li><a href="#数据库的创建和删除">数据库的创建和删除</a></li>
<li><a href="#管理和查看模式">管理和查看模式</a></li>
<li><a href="#查看和连接数据库">查看和连接数据库</a></li>
<li><a href="#管理表">管理表</a></li>
<li><a href="#查看表和表信息">查看表和表信息</a></li>
<li><a href="#系统表system-catalogs">系统表(system catalogs)</a></li>
<li><a href="#h:cc94eea9-20f5-468a-998c-6829a325f96f">表的CRUD</a></li>
<li><a href="#索引管理">索引管理</a></li>
<li><a href="#表空间">表空间</a></li>
<li><a href="#查看系统信息">查看系统信息</a></li>
<li><a href="#查看用户和权限">查看用户和权限</a></li>
<li><a href="#h:93e4a4bc-7a51-4a93-9ffe-df26603e446d">事务管理和锁</a></li>
<li><a href="#常用的系统函数">常用的系统函数</a></li>
</ul>
</li>
<li><a href="#用户和角色">用户和角色</a>
<ul>
<li><a href="#创建用户和角色">创建用户和角色</a></li>
<li><a href="#用户管理案例">用户管理案例</a></li>
<li><a href="#权限管理">权限管理</a></li>
<li><a href="#权限案例">权限案例</a></li>
</ul>
</li>
<li><a href="#h:09f09497-fd2f-479e-a9d8-d13ac3ac3d57">安装使用图形化工具pgadmin</a>
<ul>
<li><a href="#pgadmin-介绍">pgadmin 介绍</a></li>
<li><a href="#h:d6381977-ce96-46dd-9f42-c801f467c812">安装pgadmin</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:429caa18-a567-471c-871b-8124f76d0450">PostgreSQL 体系架构</a>
<ul>
<li><a href="#体系架构概览">体系架构概览</a></li>
<li><a href="#进程和内存结构">进程和内存结构</a>
<ul>
<li><a href="#进程">进程</a></li>
<li><a href="#内存结构">内存结构</a></li>
</ul>
</li>
<li><a href="#数据更新过程">数据更新过程</a></li>
<li><a href="#数据库目录结构">数据库目录结构</a>
<ul>
<li><a href="#数据库目录介绍">数据库目录介绍</a></li>
<li><a href="#postgresql.conf-配置项">postgresql.conf 配置项</a></li>
<li><a href="#pg_ident.conf">pg_ident.conf</a></li>
<li><a href="#数据文件">数据文件</a></li>
<li><a href="#控制文件">控制文件</a></li>
<li><a href="#日志文件">日志文件(重点)</a>
<ul>
<li><a href="#日志种类">日志种类</a></li>
<li><a href="#运行日志">运行日志</a></li>
<li><a href="#h:391dffc6-1380-4396-99ec-de21487c1124">在线WAL日志</a></li>
<li><a href="#h:aeecc827-eff0-4bd7-a3e4-69f135d34bf1">归档WAL日志</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:1b94a09a-e70a-4966-bea4-3a6d89702db8">PostgreSQL 备份恢复</a>
<ul>
<li><a href="#备份说明">备份说明</a></li>
<li><a href="#逻辑备份">逻辑备份</a>
<ul>
<li><a href="#pg_dump和pg_dumpall">pg_dump和pg_dumpall</a></li>
<li><a href="#h:0e1a59cc-31e0-4714-a120-176f1758632c">COPY命令实现备份还原</a></li>
</ul>
</li>
<li><a href="#物理备份">物理备份</a></li>
<li><a href="#pitrpoint-in-time-recovery介绍">PITR（Point-in-Time Recovery）介绍</a></li>
<li><a href="#h:2f7e2e13-8c7f-4378-b181-d716c2cab478">pg_basebackup实现完全备份和还原</a>
<ul>
<li><a href="#h:7468e000-7722-4ab4-8c20-811761f3caa9">pg_basebackup的命令行参数</a></li>
<li><a href="#完全备份">完全备份</a></li>
<li><a href="#h:43e5df15-87e3-46b4-a700-1f15dd7bea5d">利用完全备份实现恢复</a></li>
</ul>
</li>
<li><a href="#h:d15dbee4-01b0-4385-870b-40595c6484a5">利用PITR实现误删除的实战案例</a>
<ul>
<li><a href="#场景说明">场景说明</a></li>
<li><a href="#故障恢复过程">故障恢复过程</a>
<ul>
<li><a href="#备份">备份</a></li>
<li><a href="#h:17329bff-9844-401b-b9f3-85ad06e9c4d3">故障还原</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:a9da6f21-94a8-40e3-9d7e-c5ed6623e7c3">PostgreSQL 高可用</a>
<ul>
<li><a href="#流复制介绍">流复制介绍</a>
<ul>
<li><a href="#什么是流复制">什么是流复制</a></li>
<li><a href="#流复制发展历史">流复制发展历史</a></li>
<li><a href="#流复制原理">流复制原理</a></li>
<li><a href="#流复制按照同步方式分类">流复制按照同步方式分类</a></li>
<li><a href="#流复制特点">流复制特点</a></li>
</ul>
</li>
<li><a href="#实现流复制">实现流复制</a>
<ul>
<li><a href="#基础环境准备">基础环境准备</a></li>
<li><a href="#h:a6c07540-f121-41a1-ab94-f7f9bd3713f2">Master节点配置</a></li>
<li><a href="#h:9fc311df-7aa9-420f-88e8-31acadb61fdf">Standby节点配置</a></li>
<li><a href="#监控同步状态">监控同步状态</a>
<ul>
<li><a href="#在主库查看状态">在主库查看状态</a></li>
<li><a href="#h:6a7eac79-7082-42a5-9e2e-44ebc0072167">在从库查看状态</a></li>
</ul>
</li>
<li><a href="#切换主从">切换主从</a>
<ul>
<li><a href="#h:1afc3ecc-ce2e-498f-b0d2-dca858b95bb3">将从库切换为主库</a></li>
<li><a href="#h:d1388299-40e9-4590-9c77-f5e348b72f0a">原主库切换为从库</a></li>
<li><a href="#h:cf76daa0-2685-4185-9eeb-2ff5640b4b09">重新验证同步状态</a></li>
</ul>
</li>
<li><a href="#实现同步的流复制">实现同步的流复制</a>
<ul>
<li><a href="#配置同步的流复制">配置同步的流复制</a></li>
<li><a href="#h:9ea98232-3516-4929-8cab-4e2a90e88be9">验证同步状态</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="../index.html">Linux</a></li>
</ul>

<p>
<b>本章内容</b>
</p>

<ul class="org-ul">
<li>PostgreSQL 介绍</li>
<li>PostgreSQL 安装</li>
<li>PostgreSQL 管理</li>
<li>PostgreSQL 体系架构</li>
<li>PostgreSQL 备份还原</li>
<li>PostgreSQL 高可用</li>
</ul>
<section id="outline-container-h:9564f086-f540-4896-b877-a02f1f06c15a" class="outline-2">
<h2 id="h:9564f086-f540-4896-b877-a02f1f06c15a">PostgreSQL 介绍和特性</h2>
<div class="outline-text-2" id="text-h:9564f086-f540-4896-b877-a02f1f06c15a">
</div>
<div id="outline-container-postgresql-介绍" class="outline-3">
<h3 id="postgresql-介绍">PostgreSQL 介绍</h3>
<div class="outline-text-3" id="text-postgresql-介绍">
<p>
PostgreSQL是当前功能最强大的开源的关系型数据库系统,支持跨平台的多种操作系统,基于C语言开发。通常简称为PG或PGSQL。
</p>

<p>
PostgreSQL宣称是世界上最先进的开源数据库。PostgreSQL的狂热者认为它的性能缺Oracle不分上下，而且没有高成本的负担。
</p>

<p>
PostgreSQL拥有看悠久的历史，可以追搠到1985年的加州大学伯克利分校的项目
POSTGRES，是1977年的由数据库科学家Michael Stonebraker领导的Ingres项目
的衍生品,为了专注于数据库理论的研究,在版本4.2时伯克利正式终止了
POSTGRES项目。
</p>

<p>
1994年，来自中国香港的两名伯克利的研究生Andrew Yu和 JollyChen向 POSTGRES中增加了现在SQL语言的解释器，将Postgres改名为Postgres95，并将其源代码发布到互联网上，成为一个开源的数据库管理系统。
</p>

<p>
1996年，Postgres95名称已经不合时宜,被更改为PostgreSQL，表示它支持查询语言标准，同时版本号也重新从6.0开始。自从版本6.0之后，出现了很多后续发行版本。
</p>

<p>
PostgreSQL是100%社区驱动的开源项自，由全球范围内千人以上的社区责献者共同维护。PostgreSQL提供了一个完整功能的瓶本，而不像MySQL那样提供多个不同的瓶本，如社区版、商业版及企业版。
</p>

<p>
PostgreSQL的开源协议采用自由的BSD,MTT类型，这种开源协议允许任何人在保留版权声明的情况下使用,戛制，修改或者分享代码。
</p>

<p>
可靠性是PostgreSQL最优先关注的特性。普遍认为PostgreSQL坚如磐石并且设计
精密，能够支持事务处理和关键任务应用。PostgreSQL提供一流的文档服务，包
括全面的免费在线手册,以及旧版本手册的存档。社区的支持非常出色,并且有独
立厂商提供商业支持。
</p>

<p>
数据一致性和完整性也是PostgeSQL的高度优先事项。PostgreSQL是完全符合
ACID原则(原子性、一致性、隔离性，持久性)的数据库:PostgreSQL对数据库访
问提供强大的安全控制,不仅能够利用企业安全工具,如: Kerberos和OpenSSL等,
还可以根据自己的业务规则自定义核对方法,以确保数据的质量。数据库管理员
最喜欢的功能是时间点恢复(point-in-time recovery简称PITR)期能，它具有灵
活性，高可用性特征，能够打造快速故障的热备份服务器,以及快照和恢复到特
定时间点等。但这还不是全部.该项目提供了很多方法来管理PostgreSQL，使
PostgreSQL具有高可用性、负载均衡和同步功能，因此可以利用这些功能来满足
特定需求
</p>

<p>
官网: <a href="http://www.postgresql.org/">www.postgresql.org</a>
</p>

<p>
中文社区: <a href="http://www.postgres.cn">http://www.postgres.cn</a>
</p>

<p>
中文手册: <a href="http://www.postgres.cn/docs/12/index.html">http://www.postgres.cn/docs/12/index.html</a>
</p>

<p>
参考网站:
</p>
<ul class="org-ul">
<li><a href="https://www.runoob.com/postgresql/postgresql-tutorial.html">https://www.runoob.com/postgresql/postgresql-tutorial.html</a></li>
<li><a href="https://www.runoob.com/manual/PostgreSQL/index.html">https://www.runoob.com/manual/PostgreSQL/index.html</a></li>
</ul>

<p>
<b>PostgreSQL 开源许可( PostgreSQL Licence)</b>
</p>
<ul class="org-ul">
<li><a href="https://www.postgresql.org/about/licence/">https://www.postgresql.org/about/licence/</a></li>
</ul>

<p>
完全免费，二次开发无需担心会产生小课堂。
</p>


<p>
<b>MySQL 开源许可(GPLv2 with exceptions and LGPLv2 and BSD)</b>
</p>

<pre class="example" id="org0548c40">
MySQL's soure code is available under terms of the GNU General Public
License, which also fits the Free Software and OpenSource definitions
and conforms to the Debian Free Software Guidelines (but not to the
Copyfree Standard). lt is also available under a proprietary license
agreement, which is typically intended for use by those who wish to
release software incorporatin:MySQL code without having to release the
source code for the entire application. In practical terms, this means
that MySQL can be distributed with or without source code, as can
PostgreSQL, but to distribute without source code in the case of MySQL
requires paying Oracle for a MySQL Commercial License.
</pre>
</div>
</div>
<div id="outline-container-数据库排名" class="outline-3">
<h3 id="数据库排名">数据库排名</h3>
<div class="outline-text-3" id="text-数据库排名">
<p>
<a href="https://db-engines.com/en/ranking">https://db-engines.com/en/ranking</a>
</p>

<p>
发展趋势：<a href="https://db-engines.com/en/ranking_trend/system/PostgreSQL">https://db-engines.com/en/ranking_trend/system/PostgreSQL</a>
</p>
</div>
</div>
<div id="outline-container-h:7b187971-6170-4e10-9393-dd9f4f078ba4" class="outline-3">
<h3 id="h:7b187971-6170-4e10-9393-dd9f4f078ba4">PostgreSQL与MySQL对比</h3>
<div class="outline-text-3" id="text-h:7b187971-6170-4e10-9393-dd9f4f078ba4">
<p>
<a href="http://bbs.chinaunix.net/thread-1688208-1-1.html">http://bbs.chinaunix.net/thread-1688208-1-1.html</a>
</p>


<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">特性</th>
<th scope="col" class="org-left">MySQL</th>
<th scope="col" class="org-left">PostgreSQL</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">实例</td>
<td class="org-left">通过执行 MySQL 命令（mysqld）启动实例。一个实例可以管理一个或多个数据库。一台服务器可以运行多个 mysqld 实例。一个实例管理器可以监视 mysqld 的各个实 例。</td>
<td class="org-left">通过执行 Postmaster 进程（pg_ctl）启动实例。一个实例可以管理一个或多个数据库，这些数据库组成一个集群。集群是磁盘上的一个区 域，这个区域在安装时初始化并由一个目录组成，所有数据都存储在这个目录中。使用 initdb创建第一个数据库。一台机器上可以启动多个实例。</td>
</tr>

<tr>
<td class="org-left">数据库</td>
<td class="org-left">数据库是命名的对象集合，是与实例中的其他数据库分离的实体。一个 MySQL 实例中的所有数据库共享同一个系统编目。</td>
<td class="org-left">数据库是命名的对象集合，每个数据库是与其他数据库分离的实体。每个数据库有自己的系统编目，但是所有数据库共享 pg_databases。</td>
</tr>

<tr>
<td class="org-left">数据缓冲区</td>
<td class="org-left">通过 innodb_buffer_pool_size 配置参数设置数据缓冲区。这个参数是内存缓冲区的字节数，InnoDB 使用这个缓冲区来缓存表的数据和索引。在专用的数据库服务器上，这个参数最高可以设置为机器物理内存量的 80%。</td>
<td class="org-left">Shared_buffers 缓存。在默认情况下分配 64个缓冲区。默认的块大小是 8K。可以通过设置 postgresql.conf 文件中的 shared_buffers 参数来更新缓冲区缓存。</td>
</tr>

<tr>
<td class="org-left">数据库连接</td>
<td class="org-left">客户机使用 CONNECT 或 USE 语句连接数据库，这时要指定数据库名，还可以指定用户 id 和密码。使用角色管理数据库中的用户和用户组。</td>
<td class="org-left">客户机使用 connect 语句连接数据库，这时要指定数据库名，还可以指定用户 id 和密码。使用角色管理数据库中的用户和用户组。</td>
</tr>

<tr>
<td class="org-left">身份验证</td>
<td class="org-left">MySQL 在数据库级管理身份验证。基本只支持密码认证。</td>
<td class="org-left">PostgreSQL 支持丰富的认证方法：信任认证、口令认证、Kerberos 认证、基于 Ident 的认 证、LDAP 认证、PAM 认证</td>
</tr>

<tr>
<td class="org-left">加密</td>
<td class="org-left">可以在表级指定密码来对数据进行加密。还可以使用 AES_ENCRYPT和 AES_DECRYPT 函数对列数据进行加密和解密。可以通过 SSL 连接实现网络加密。</td>
<td class="org-left">可以使用 pgcrypto 库中的函数对列进行加密/解密。可以通过 SSL 连接实现网络加密。</td>
</tr>

<tr>
<td class="org-left">审计</td>
<td class="org-left">可以对 querylog 执行 grep。</td>
<td class="org-left">可以在表上使用 PL/pgSQL 触发器来进行审计。</td>
</tr>

<tr>
<td class="org-left">查询解释</td>
<td class="org-left">使用 EXPLAIN 命令查看查询的解释计划。</td>
<td class="org-left">使用 EXPLAIN 命令查看查询的解释计划。</td>
</tr>

<tr>
<td class="org-left">备 份、恢复和日志</td>
<td class="org-left">InnoDB 使用写前（write-ahead）日志记录。支持在线和离线完全备份以及崩溃和事务恢复。需要第三方软件才能支持热备份。</td>
<td class="org-left">在数据目录的一个子目录中维护写前日志。支持在线和离线完全备份以及崩溃、时间点和事务恢复。 可以支持热备份。</td>
</tr>

<tr>
<td class="org-left">JDBC驱动程序</td>
<td class="org-left">可以从 <span class="underline">参考资料</span> 下载 JDBC 驱动程序。</td>
<td class="org-left">可以从 <span class="underline">参考资料</span> 下载 JDBC 驱动程序。</td>
</tr>

<tr>
<td class="org-left">表类型</td>
<td class="org-left">取决于存储引擎。例如，NDB 存储引擎支持分区表，内存引擎支持内存表。</td>
<td class="org-left">支持临时表、常规表以及范围和列表类型的分区表。不支持哈希分区表。 由于PostgreSQL的表分区是通过表继承和规则系统完成了，所以可以实现更复杂的分区方式。</td>
</tr>

<tr>
<td class="org-left">索引类型</td>
<td class="org-left">取决于存储引擎。MyISAM： BTREE，InnoDB：BTREE。</td>
<td class="org-left">支持 B-树、哈希、R-树和 Gist 索引。</td>
</tr>

<tr>
<td class="org-left">约束</td>
<td class="org-left">支持主键、外键、惟一和非空约 束。对检查约束进行解析，但是不强制实施。</td>
<td class="org-left">支持主键、外键、惟一、非空和检查约束。</td>
</tr>

<tr>
<td class="org-left">存储过程和用户定义函数</td>
<td class="org-left">支持 CREATE PROCEDURE 和 CREATE FUNCTION 语句。存储过程可以用 SQL 和 C++ 编写。用户定义函数可以用 SQL、C 和 C++ 编写。</td>
<td class="org-left">没有单独的存储过程，都是通过函数实现的。用户定义函数可以用 PL/pgSQL（专用的过程语言）、PL/Tcl、PL/Perl、PL/Python 、SQL 和 C 编写</td>
</tr>

<tr>
<td class="org-left">触发器</td>
<td class="org-left">支持行前触发器、行后触发器和语句触发器，触发器语句用过程语言复合语句编写。</td>
<td class="org-left">支持行前触发器、行后触发器和语句触发器，触发器过程用 C 编写。</td>
</tr>

<tr>
<td class="org-left">系统配置文件</td>
<td class="org-left">my.conf</td>
<td class="org-left">Postgresql.conf</td>
</tr>

<tr>
<td class="org-left">数据库配置</td>
<td class="org-left">my.conf</td>
<td class="org-left">Postgresql.conf</td>
</tr>

<tr>
<td class="org-left">客户机连接文件</td>
<td class="org-left">my.conf</td>
<td class="org-left">pg_hba.conf</td>
</tr>

<tr>
<td class="org-left">XML 支持</td>
<td class="org-left">有限的 XML 支持。</td>
<td class="org-left">有限的 XML 支持。</td>
</tr>

<tr>
<td class="org-left">数据访问和管理服务器</td>
<td class="org-left">OPTIMIZE TABLE -&#x2013;&#x2014; 回收未使用的空间并消除数据文件的碎片 myisamchk -analyze -&#x2013;&#x2014; 更新查询优化器所使用的统计数据 . （MyISAM 存储引擎） mysql -&#x2013;&#x2014; 命令行工具 MySQL  Administrator -&#x2013;&#x2014; 客户机 GUI工具</td>
<td class="org-left">Vacuum -&#x2013;&#x2014; 回收未使用的空间 Analyze -&#x2013;&#x2014;更新查询优化器所使用的统计数据 psql -&#x2013;&#x2014; 命令行工具 pgAdmin -&#x2013;&#x2014; 客户机 GUI 工具</td>
</tr>

<tr>
<td class="org-left">并发控制</td>
<td class="org-left">支持表级和行级锁。InnoDB 存储引擎支持 READ_COMMITTED、 READ_UNCOMMITTED、 REPEATABLE_READ 和 SERIALIZABLE。使用 SET TRANSACTION ISOLATION LEVEL语句在事务级设置隔离级别。</td>
<td class="org-left">支持表级和行级锁。支持的 ANSI 隔离级别是 Read Committed（默认 -&#x2013;&#x2014; 能看到查询启动时数据库的快照）和 Serialization（与 Repeatable Read 相似 -&#x2013;&#x2014; 只能看到在事务启动之前提交的结果）。使用 SET TRANSACTION语句在事务级设置隔离级别。使用 SET SESSION在会话级进行设置。</td>
</tr>
</tbody>
</table>

<p>
<b>MySQL相对于PostgreSQL的劣势</b>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">MySQL</th>
<th scope="col" class="org-left">PostgreSQL</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">最重要的引擎InnoDB很早就由Oracle公司控制。目前整个MySQL数据库都由Oracle控 制。</td>
<td class="org-left">BSD协议，没有被大公司垄断。</td>
</tr>

<tr>
<td class="org-left">对复杂查询的处理较弱，查询优化器不够成熟</td>
<td class="org-left">很强大的查询优化器，支持很复杂的查询处理。</td>
</tr>

<tr>
<td class="org-left">只有一种表连接类型:嵌套循环连接(nested- loop),不支持排序-合并连接(sort-merge join)与散列连接(hash join)。</td>
<td class="org-left">都支持</td>
</tr>

<tr>
<td class="org-left">性能优化工具与度量信息不足</td>
<td class="org-left">提供了一些性能视图，可以方便的看到发生在一个表和索引上的select、delete、update、 insert统计信息，也可以看到cache命中率。网上有一个开源的pgstatspack工具。</td>
</tr>

<tr>
<td class="org-left">InnoDB的表和索引都是按相同的方式存储。也就是说表都是索引组织表。这一般要求主键不能太长而且插入时的主键最好是按顺序递 增，否则对性能有很大影响。</td>
<td class="org-left">不存在这个问题。</td>
</tr>

<tr>
<td class="org-left">大部分查询只能使用表上的单一索引;在某些情况下，会存在使用多个索引的查询,但是查询优化器通常会低估其成本,它们常常比表扫描还要慢。</td>
<td class="org-left">不存在这个问题</td>
</tr>

<tr>
<td class="org-left">表增加列，基本上是重建表和索引，会花很长时间。</td>
<td class="org-left">表增加列，只是在数据字典中增加表定义，不会重建表</td>
</tr>

<tr>
<td class="org-left">存储过程与触发器的功能有限。可用来编写存储过程、触发器、计划事件以及存储函数的语言功能较弱</td>
<td class="org-left">除支持pl/pgsql写存储过程，还支持perl、 python、Tcl类型的存储过程：pl/perl， pl/python，pl/tcl。 也支持用C语言写存储过程。</td>
</tr>

<tr>
<td class="org-left">不支持Sequence。</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">不支持函数索引，只能在创建基于具体列的索引。 不支持物化视图。</td>
<td class="org-left">支持函数索引，同时还支持部分数据索引，通过规则系统可以实现物化视图的功能。</td>
</tr>

<tr>
<td class="org-left">执行计划并不是全局共享的, 仅仅在连接内部是共享的。</td>
<td class="org-left">执行计划共享</td>
</tr>

<tr>
<td class="org-left">MySQL支持的SQL语法(ANSI SQL标准)的很小一部分。不支持递归查询、通用表表达式 （Oracle的with 语句）或者窗口函数（分析函数）。</td>
<td class="org-left">都 支持</td>
</tr>

<tr>
<td class="org-left">不支持用户自定义类型或域(domain)</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">对于时间、日期、间隔等时间类型没有秒以下级别的存储类型</td>
<td class="org-left">可以精确到秒以下。</td>
</tr>

<tr>
<td class="org-left">身份验证功能是完全内置的，不支持操作系统认证、PAM认证，不支持LDAP以及其它类似的外部身份验证功能。</td>
<td class="org-left">支持OS认证、 Kerberos 认证 、 Ident 的认证、 LDAP 认证、PAM认证</td>
</tr>

<tr>
<td class="org-left">不支持database link。有一种叫做Federated的存储引擎可以作为一个中转将查询语句传递到远程服务器的一个表上,不过,它功能很粗糙并且漏洞很多</td>
<td class="org-left">有dblink，同时还有一个dbi-link的东西，可以连接到 oracle和mysql上。</td>
</tr>

<tr>
<td class="org-left">Mysql Cluster可能与你的想象有较大差异。开源的cluster软件较少。 复制(Replication)功能是异步的,并且有很大的局限性.例如,它是单线程的 (single-threaded),因此一个处理能力更强的Slave的恢复速度也很难跟上处理能力相对较慢的Master.</td>
<td class="org-left">有丰富的开源 cluster软件支持。</td>
</tr>

<tr>
<td class="org-left">explain看执行计划的结果简单。</td>
<td class="org-left">explain返回丰富的信息。</td>
</tr>

<tr>
<td class="org-left">类似于ALTER TABLE或CREATE TABLE一类的操作都是非事务性的.它们会提交未提交的事务，并且不能回滚也不能做灾难恢复</td>
<td class="org-left">DDL也是有事务的。</td>
</tr>
</tbody>
</table>

<p>
PostgreSQL主要优势：
</p>

<pre class="example" id="orgb289543">
1. PostgreSQL完全免费，而且是BSD协议，如果你把PostgreSQL改一改，然后再
   拿去卖钱，也没有人管你，这一点很重要，这表明了PostgreSQL数据库不会
   被其它公司控制。oracle数据库不用说了，是商业数据库，不开放。而MySQL
   数据库虽然是开源的，但现在随着SUN被oracle公司收购，现在基本上被
   oracle公司控制，其实在SUN被收购之前，MySQL中最重要的InnoDB引擎也是
   被oracle公司控制的，而在MySQL中很多重要的数据都是放在InnoDB引擎中的，
   反正我们公司都是这样的。所以如果MySQL的市场范围与oracle数据库的市场
   范围冲突时，oracle公司必定会牺牲MySQL，这是毫无疑问的。

2. 与PostgreSQl配合的开源软件很多，有很多分布式集群软件，如pgpool、
   pgcluster、slony、plploxy等等，很容易做读写分离、负载均衡、数据水平
   拆分等方案，而这在MySQL下则比较困难。

3. PostgreSQL源代码写的很清晰，易读性比MySQL强太多了，怀疑MySQL的源代
   码被混淆过。所以很多公司都是基本PostgreSQL做二次开发的。

4. PostgreSQL在很多方面都比MySQL强，如复杂SQL的执行、存储过程、触发器、
   索引。同时PostgreSQL是多进程的，而MySQL是线程的，虽然并发不高时，
   MySQL处理速度快，但当并发高的时候，对于现在多核的单台机器上，MySQL
   的总体处理性能不如PostgreSQL，原因是MySQL的线程无法充分利用CPU的能
   力。
</pre>

<p>
新闻评价
</p>

<p>
<a href="https://www.theregister.com/2021/12/06/mysql_a_pretty_poor_database/">https://www.theregister.com/2021/12/06/mysql_a_pretty_poor_database/</a>
</p>

<pre class="example" id="orgd695c46">
With the caveat that his reasons for leaving were complex, he went on
to say: "MySQL is a pretty poor database, and you should strongly
consider using Postgres instead.
</pre>

<p>
<a href="https://blog.csdn.net/dqcfkyqdxym3f8rb0/article/details/121804125">https://blog.csdn.net/dqcfkyqdxym3f8rb0/article/details/121804125</a>
</p>
</div>
</div>
<div id="outline-container-各种数据库性能比较" class="outline-3">
<h3 id="各种数据库性能比较">各种数据库性能比较</h3>
<div class="outline-text-3" id="text-各种数据库性能比较">
<p>
<a href="https://github.com/digoal/blog">阿里周正中,德哥</a>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">数据库</th>
<th scope="col" class="org-left">硬件</th>
<th scope="col" class="org-left">TPS</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Oracle</td>
<td class="org-left">DELL R910 CPU : Intel(R) Xeon(R) CPU E7530 @ 1.87GHz 四路48线程 MEM : 32* 4G 128G 存储 : FusionIO 640G MLC</td>
<td class="org-left">稳定值2000,峰值2600</td>
</tr>

<tr>
<td class="org-left">MySQL Percona 5.1.60-13.1 修改版</td>
<td class="org-left">DELL R910 CPU : Intel(R) Xeon(R) CPU E7530 @ 1.87GHz 四路 48线程 MEM : 32* 4G 128G 存储 : FusionIO 640G MLC</td>
<td class="org-left">峰值 1200*4，谷值0， 均值950*4</td>
</tr>

<tr>
<td class="org-left">PostgreSQL 9.3.1</td>
<td class="org-left">IBM x3850 X5 CPU : Intel(R) Xeon(R) CPU X7560 @ 2.27GHz 四路32线程 内存 : 8 * 8GB 64G 存储：OCZ RevoDrive3X2 480GB</td>
<td class="org-left">稳定值 24487</td>
</tr>

<tr>
<td class="org-left">PostgreSQL 9.3.1</td>
<td class="org-left">DELL R610 CPU : Intel(R) Xeon(R) CPU E5504 @ 2.00GHz 2路  8线程 (电源功率不够降频到1.6GHZ) 内存 : 12 * 8GB 96G 存储：OCZ RevoDrive3 240GB</td>
<td class="org-left">稳定值 15151</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:5fa2147b-e991-49d5-8d9f-19fde19ef56d" class="outline-3">
<h3 id="h:5fa2147b-e991-49d5-8d9f-19fde19ef56d">PostgreSQL各版本的特性矩阵</h3>
<div class="outline-text-3" id="text-h:5fa2147b-e991-49d5-8d9f-19fde19ef56d">
<ul class="org-ul">
<li><a href="https://www.postgresql.org/about/featurematrix/#backend">https://www.postgresql.org/about/featurematrix/#backend</a></li>
</ul>

<p>
<b>PostgreSQL的优势</b>
</p>

<ul class="org-ul">
<li>PostgreSQL数据库是目前功能最强大的开源数据库，它是最接近工业标准SQL92的查询语言，并且正在实现新的功能以兼容最新的SQL标准SQL2003。</li>
<li>稳定可靠: PostgreSQL是唯一能做到数据零丢失的开源数据库。有报道称国外的部分银行也在使用PostgreSQL数据库。</li>
<li>开源免费: PostgreSQL数据库是开源的、免费的，而且是BSD协议，在使用和二次开发上基本没有限制。</li>
<li>支持广泛:PostgreSQL数据库支持大量的主流开发语言，包括C、C++、Perl、Python、Java、Tcl，PHP等。</li>
<li>PostgreSQL社区活跃:PostgreSQL基本上每三个月推出一个补丁版本，这意味着已知的BUG很快会被修复，有应用场景的需求也会及时得到响应。</li>
</ul>
</div>
</div>
</section>
<section id="outline-container-postgresql-安装" class="outline-2">
<h2 id="postgresql-安装">PostgreSQL 安装</h2>
<div class="outline-text-2" id="text-postgresql-安装">
<p>
安装方法分为两种:
</p>

<ul class="org-ul">
<li><p>
二进制安装包进行安装
</p>

<p>
各个Linux的发行版本中，很多都内置了PostgreSQL的二进制安装包，但内置
的版本可能较旧。对于二进制包安装的方法是通过不同发行版本的Linux下的
包管理器进行的，如在RHEL系统相关版本下用yum 命令，在Debian或Ubuntu下
使用 apt 命令
</p></li>

<li><p>
源码编译安装
</p>

<p>
使用源码编译安装相对更灵活，用户可以有更多的选择，可以选择较新的版本、
配置不同的编译选项,编译出用户需要的功能。
</p></li>
</ul>

<p>
官方安装文档: <a href="https://www.postgresql.org/download/">https://www.postgresql.org/download/</a>
</p>
</div>
<div id="outline-container-二进制包安装" class="outline-3">
<h3 id="二进制包安装">二进制包安装</h3>
<div class="outline-text-3" id="text-二进制包安装">
<p>
PostgreSQL 支持各种操作系统,并提供相关二进制包包的安装方法
</p>
<ul class="org-ul">
<li><a href="https://www.postgresql.org/download/linux/redhat/">https://www.postgresql.org/download/linux/redhat/</a></li>
<li><a href="https://www.postgresql.org/download/linux/ubuntu/">https://www.postgresql.org/download/linux/ubuntu/</a></li>
</ul>
</div>
<div id="outline-container-rhelcentosrocky安装-postgresql" class="outline-4">
<h4 id="rhelcentosrocky安装-postgresql">RHEL/CentOS/Rocky安装 PostgreSQL</h4>
<div class="outline-text-4" id="text-rhelcentosrocky安装-postgresql">
<p>
范例: Rocky9 利用官方源安装 PostgreSQL-17
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-x86_64/pgdg-redhat-repo-latest.noarch.rpm

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31105;&#29992;&#20869;&#32622;&#30340;postgresql
</span>sudo dnf -qy module disable postgresql
sudo dnf install -y postgresql17-server

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;
</span>sudo /usr/pgsql-17/bin/postgresql-17-setup initdb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#26381;&#21153;
</span>systemctl enable --now postgresql-17

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#25104;&#21151;
</span>[root@rocky9 ~]#sudo -u postgres psql -c <span style="color: #8b2252;">"SELECT version();"</span>
PostgreSQL 17.0 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 11.4.1 20231218 (Red Hat 11.4.1-3), 64-bit

[root@rocky9 ~]#su - postgres
[postgres@rocky9~]$ psql
<span style="color: #0000ff;">psql</span> (17.1)
Type <span style="color: #8b2252;">"help"</span> for help.

<span style="color: #a0522d;">postgres</span>=# help
\copyright for distribution terms
\h for help with SQL commands
<span style="color: #8b2252;">\?</span> for help with psql commands
\g or terminate with semicolon to execute query
\q to quit

</pre>
</div>

<p>
范例: Rocky8 利用系统源安装 PostgreSQL-10
</p>

<div class="org-src-container">
<pre class="src src-shell">[root@rocky8 ~]#yum -y install postgresql-server

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#26080;&#27861;&#21551;&#21160;
</span>[root@rocky8 ~]#systemctl start postgresql.service

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26085;&#24535;&#25552;&#31034;&#20570;&#21021;&#22987;&#21270;
</span>[root@rocky8 ~]#tail /var/log/messages Dec 23 12:01:41 rocky8

[root@rocky8 ~]#ls /var/lib/pgsql/data

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;
</span>[root@rocky8 ~]#/usr/bin/postgresql-setup --initdb
[root@rocky8 ~]#ls /var/lib/pgsql/data

[root@rocky8 ~]#systemctl enable --now postgresql.service

[root@rocky8 ~]#su - postgres
[postgres@rocky8 ~]$ psql psql (10.17)

<span style="color: #a0522d;">postgres</span>=#
</pre>
</div>
</div>
</div>
<div id="outline-container-ubuntu-安装-postgresql" class="outline-4">
<h4 id="ubuntu-安装-postgresql">Ubuntu 安装 PostgreSQL</h4>
<div class="outline-text-4" id="text-ubuntu-安装-postgresql">
<p>
范例: Ubuntu利用官方源安装 PostgreSQL-17
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20837;&#23384;&#20648;&#24211;&#31614;&#21517;&#23494;&#38053;
</span>sudo apt install curl ca-certificates
sudo install -d /usr/share/postgresql-common/pgdg
sudo curl -o /usr/share/postgresql-common/pgdg/apt.postgresql.org.asc --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#23384;&#20648;&#24211;&#37197;&#32622;&#25991;&#20214;
</span>sudo sh -c <span style="color: #8b2252;">'echo "deb [signed-by=/usr/share/postgresql-common/pgdg/apt.postgresql.org.asc] https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" &gt; /etc/apt/sources.list.d/pgdg.list'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26356;&#26032;&#23384;&#20648;&#24182;&#23433;&#35013;&#26368;&#26032;&#29256;&#26412;&#65292; &#21487;&#20197;&#25351;&#23450;&#29256;&#26412;&#65292;&#22914;postgresql-16&#20195;&#26367;postgresql
</span>sudo apt update
sudo apt -y install postgresql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#29256;&#26412;&#65292; 5432&#31471;&#21475;
</span>root@debian:~/.jasper# sudo -u postgres psql -c <span style="color: #8b2252;">"SELECT version();"</span>
                                                       version                                                       
---------------------------------------------------------------------------------------------------------------------
 PostgreSQL 17.0 (Debian 17.0-1.pgdg120+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 12.2.0-14) 12.2.0, 64-bit
(1 row)
root@debian:~/.jasper# su - postgres
postgres@debian:~$ psql
<span style="color: #0000ff;">psql</span> (17.0 (Debian 17.0-1.pgdg120+1))
Type <span style="color: #8b2252;">"help"</span> for help.

<span style="color: #a0522d;">postgres</span>=# 


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;12&#29256;&#26412;&#26102;&#65292;ubuntu&#38656;&#35201;&#21021;&#22987;&#21270;&#25165;&#33021;&#21551;&#21160;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#24182;&#21551;&#21160;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1
</span>[root@ubuntu2004 ~]#pg_createcluster 12 main --start

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2
</span>[root@ubuntu2004 ~]#su - postgres
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#21021;&#22987;&#21270;
</span>postgres@ubuntu2004:~$/usr/lib/postgresql/12/bin/initdb -D /var/lib/postgresql/data
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#26381;&#21153;
</span>postgres@ubuntu2004:~$ /usr/lib/postgresql/12/bin/pg_ctl -D /var/lib/postgresql/data -l logfile start
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;
</span>postgres@ubuntu2004:~$ vim /var/lib/postgresql/data/postgresql.conf
<span style="color: #a0522d;">listen_addresses</span> = <span style="color: #8b2252;">'*'</span>

postgres@ubuntu2004:~$ vim /var/lib/postgresql/data/pg_hba.conf
<span style="color: #b22222;"># </span><span style="color: #b22222;">IPv4 local connections:
</span>
host all all 127.0.0.1/32 trust
host all all 0.0.0.0/0   md5

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;&#26381;&#21153;
</span>postgres@ubuntu2004:~$ /usr/lib/postgresql/12/bin/pg_ctl -D /var/lib/postgresql/data -l logfile restart

postgres@ubuntu2004:~$ psql
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#23494;&#30721;
</span><span style="color: #a0522d;">postgres</span>=# ALTER USER postgres WITH ENCRYPTED PASSWORD <span style="color: #8b2252;">'123456'</span>;
ALTER ROLE

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36828;&#31243;&#30331;&#24405;
</span>[root@rocky8 ~]#psql -U postgres -h 10.0.0.200
Type <span style="color: #8b2252;">"help"</span> for help.
</pre>
</div>

<p>
范例: Ubuntu20.04利用系统源安装 PostgreSQL-12
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 ~]#apt update
[root@ubuntu2004 ~]#apt -y install postgresql
[root@ubuntu2004 ~]#su -postgres

postgres@ubuntu2004:~$ /usr/lib/postgresql/12/bin/pg_ctl init -D /var/lib/postgresql/12/main
Success. You can now start the database server using:

/usr/lib/postgresql/12/bin/pg_ctl -D /var/lib/postgresql/12/main -l logfile start

postgres@ubuntu2004:~$ /usr/lib/postgresql/12/bin/pg_ctl -D /var/lib/postgresql/12/main -l logfile start
postgres@ubuntu2004:~$ psql
<span style="color: #a0522d;">postgres</span>=# exit
</pre>
</div>

<p>
范例: Ubuntu18.04 利用系统源安装 PostgreSQL-10
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu1804 ~]#apt update
[root@ubuntu1804 ~]#apt -y install postgresql
[root@ubuntu1804 ~]#su - postgres

postgres@ubuntu1804:~$ psql
<span style="color: #a0522d;">postgres</span>=# help
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-源码编译安装" class="outline-3">
<h3 id="源码编译安装">源码编译安装</h3>
<div class="outline-text-3" id="text-源码编译安装">
</div>
<div id="outline-container-编译安装过程说明" class="outline-4">
<h4 id="编译安装过程说明">编译安装过程说明</h4>
<div class="outline-text-4" id="text-编译安装过程说明">
<p>
官方帮助
</p>
<ul class="org-ul">
<li><a href="https://www.postgresql.org/docs/current/installation.html">https://www.postgresql.org/docs/current/installation.html</a>
<ul class="org-ul">
<li><a href="https://www.postgresql.org/docs/current/install-make.html#INSTALL-PROCEDURE-MAKE">https://www.postgresql.org/docs/current/install-make.html#INSTALL-PROCEDURE-MAKE</a></li>
</ul></li>
<li><a href="http://www.postgres.cn/v2/download">http://www.postgres.cn/v2/download</a></li>
</ul>


<p>
第一步:下载源代码 <a href="https://www.postgresql.org/ftp/source/">https://www.postgresql.org/ftp/source/</a>
</p>

<p>
第二步:编译安装。过程与Linux下其他软件的编译安装过程相同
</p>

<div class="org-src-container">
<pre class="src src-sh">./configure
make
make install
</pre>
</div>

<p>
第三步:编译安装完成后执行如下步骤
</p>

<ul class="org-ul">
<li>使用initdb命令初使用化数据库</li>
<li>启动数据库实例</li>
</ul>
</div>
</div>
<div id="outline-container-h:59b4da69-9386-478a-a3a9-fe30dd2f1db5" class="outline-4">
<h4 id="h:59b4da69-9386-478a-a3a9-fe30dd2f1db5">系统初始化和优化配置</h4>
<div class="outline-text-4" id="text-h:59b4da69-9386-478a-a3a9-fe30dd2f1db5">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#38381;&#38450;&#28779;&#22681;&#21644;SELinux&#31561;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20869;&#26680;&#21442;&#25968;&#20248;&#21270;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">vi /etc/sysctl.conf
</span>kernel.shmmax = 68719476736 &#65288;CentOS6&#20197;&#21069;&#29256;&#26412;&#40664;&#35748;&#20540;&#65292;CentOS7&#40664;&#35748;&#20026;18446744073692774399&#65289;
kernel.shmall = 4294967296 &#65288;CentOS6&#20197;&#21069;&#29256;&#26412;&#40664;&#35748;&#20540;&#65292;CentOS7&#40664;&#35748;&#20026;18446744073692774399&#65289;
kernel.shmmni = 4096
kernel.sem = 50100 64128000 50100 1280
fs.file-max = 7672460
net.ipv4.ip_local_port_range = 9000 65000
net.core.rmem_default = 1048576
net.core.rmem_max = 4194304
net.core.wmem_default = 262144
net.core.wmem_max = 1048576

<span style="color: #b22222;"># </span><span style="color: #b22222;">sysctl -p
</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">vi /etc/security/limits.conf
</span>&#8203;* - nofile 100000
&#8203;* - nproc 100000
&#8203;* - memlock 60000
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bd49280c-7b6a-4903-a2b6-e307c04a10d8" class="outline-4">
<h4 id="h:bd49280c-7b6a-4903-a2b6-e307c04a10d8">安装依赖包</h4>
<div class="outline-text-4" id="text-h:bd49280c-7b6a-4903-a2b6-e307c04a10d8">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">RHEL&#31995;&#32479;
</span>yum install -y gcc make readline-devel zlib-devel

<span style="color: #b22222;">#</span><span style="color: #b22222;">Ubuntu
</span>apt update
apt install -y gcc make libreadline-dev zlib1g-dev
apt install -y libicu-dev pkg-config bison flex
apt install -y build-essential zlib1g-dev libssl-dev libreadline-dev libpam0g-dev libdb-dev
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b7677d9d-b9b0-450c-9765-f7ec97f8bb2b" class="outline-4">
<h4 id="h:b7677d9d-b9b0-450c-9765-f7ec97f8bb2b">源码编译安装</h4>
<div class="outline-text-4" id="text-h:b7677d9d-b9b0-450c-9765-f7ec97f8bb2b">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#36733;&#35299;&#21387;&#32553;
</span>wget https://ftp.postgresql.org/pub/source/v12.9/postgresql-12.9.tar.gz
tar xf postgresql-12.9.tar.gz
<span style="color: #483d8b;">cd</span> postgresql-12.9

wget https://ftp.postgresql.org/pub/source/v17.0/postgresql-17.0.tar.gz
tar xf postgresql-17.0.tar.gz
<span style="color: #483d8b;">cd</span> postgresql-17.0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#23433;&#35013;&#35828;&#26126;
</span>cat postgresql-12.9/INSTALL

./configure
make
su
make install
adduser postgres
mkdir /usr/local/pgsql/data
chown postgres /usr/local/pgsql/data
su - postgres
/usr/local/pgsql/bin/initdb -D /usr/local/pgsql/data
/usr/local/pgsql/bin/pg_ctl -D /usr/local/pgsql/data -l logfile start
/usr/local/pgsql/bin/createdb test
/usr/local/pgsql/bin/psql test

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#32534;&#35793;&#36873;&#39033;(&#21487;&#36873;)
</span>pg_config --configure

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#22987;&#32534;&#35793;&#19977;&#27493;&#26354;,&#40664;&#35748;&#23433;&#35013;&#22312;/usr/local/pgsql
</span>mkdir buid_dir
<span style="color: #483d8b;">cd</span> buid_dir
../configure --prefix=/apps/pgsql --with-pgport=5432
make -j 2 world <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748; make &#19981;&#21253;&#25324;&#25991;&#26723;&#21644;&#20854;&#23427;&#27169;&#22359;,2&#34920;&#31034;&#24403;&#20135;&#20027;&#26426;&#30340;CPU&#26680;&#24515;&#25968;
</span>make install-world <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748; make install &#19981;&#21253;&#25324;&#23433;&#35013;&#25991;&#26723;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:92afb878-2173-4dee-8559-d787e7340ac7" class="outline-4">
<h4 id="h:92afb878-2173-4dee-8559-d787e7340ac7">创建数据库用户和组</h4>
<div class="outline-text-4" id="text-h:92afb878-2173-4dee-8559-d787e7340ac7">
<p>
PostgreSQL默认不支持 以root身份启动服务,虽然也可修改源码实现root启动,但基于安全考虑不建议，因此必须创建一个用于启动PostgrepSQL的普通用户
</p>

<div class="org-src-container">
<pre class="src src-sh">root@debian:~/postgresql-17.0/buid_dir# useradd test
root@debian:~/postgresql-17.0/buid_dir# getent passwd test
test:x:1001:1001::/home/test:/bin/sh

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#25968;&#25454;&#24211;&#29992;&#25143;&#21644;&#32452;,&#27880;&#24847;&#27492;&#29992;&#25143;&#38656;&#35201;&#21487;&#20197;&#20132;&#20114;&#30331;&#24405;
</span>useradd -s /bin/bash -m -d /home/postgres postgres

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;postgres&#23494;&#30721;
</span><span style="color: #483d8b;">echo</span> -e <span style="color: #8b2252;">'123456\n123456'</span> | passwd postgres
<span style="color: #483d8b;">echo</span> postgres:123456|chpasswd
</pre>
</div>
</div>
</div>
<div id="outline-container-h:47ab6842-8e72-4f6a-9a1c-225162c4da90" class="outline-4">
<h4 id="h:47ab6842-8e72-4f6a-9a1c-225162c4da90">创建数据目录并授权</h4>
<div class="outline-text-4" id="text-h:47ab6842-8e72-4f6a-9a1c-225162c4da90">
<div class="org-src-container">
<pre class="src src-sh">mkdir -pv /pgsql/data/

chown postgres.postgres /pgsql/data/
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f2054ef0-4caf-4526-bac1-fa6e6e12405d" class="outline-4">
<h4 id="h:f2054ef0-4caf-4526-bac1-fa6e6e12405d">设置环境变量</h4>
<div class="outline-text-4" id="text-h:f2054ef0-4caf-4526-bac1-fa6e6e12405d">
<div class="org-src-container">
<pre class="src src-sh">vim /etc/profile.d/pgsql.sh
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">PGHOME</span>=/apps/pgsql
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">PATH</span>=$<span style="color: #a0522d;">PGHOME</span>/bin/:$<span style="color: #a0522d;">PATH</span>
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">PGDATA</span>=/pgsql/data
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">PGUSER</span>=postgres
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">MANPATH</span>=/apps/pgsql/share/man:$<span style="color: #a0522d;">MANPATH</span>

su - postgres <span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;
</span>psql --version
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ebf408b4-29b4-4178-8a06-d24bb6e7945b" class="outline-4">
<h4 id="h:ebf408b4-29b4-4178-8a06-d24bb6e7945b">初始化数据库</h4>
<div class="outline-text-4" id="text-h:ebf408b4-29b4-4178-8a06-d24bb6e7945b">
<div class="org-src-container">
<pre class="src src-sh">su - postgres

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21021;&#22987;&#21270;
</span>initdb
initdb -D $<span style="color: #a0522d;">PGDATA</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;&#36873;&#39033; -D &lt;datadir&gt; ,&#25353;&#29615;&#22659;&#21464;&#37327;$PGDATA&#25351;&#23450;&#30340;&#36335;&#24452;&#36827;&#34892;&#21021;&#22987;&#21270;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#20135;&#24314;&#35758;&#21021;&#22987;&#21270;&#26041;&#24335;
</span>initdb -A md5 -D $<span style="color: #a0522d;">PGDATA</span> -E utf8 --locale=C -U postgres -W

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36873;&#39033;
</span>-A <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;local connections&#40664;&#35748;&#30340;&#36523;&#20221;&#39564;&#35777;&#26041;&#27861;
</span>-D <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#30446;&#24405;
</span>-E <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#23383;&#31526;&#38598;
</span>--locale=C <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#35821;&#35328;&#29615;&#22659;
</span>-U <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#24211;superuser&#29992;&#25143;&#21517;
</span>-W <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#24211;superuser&#30340;&#29992;&#25143;&#23494;&#30721;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:40bb07ea-2178-43c7-95db-f531a75c5f8b" class="outline-4">
<h4 id="h:40bb07ea-2178-43c7-95db-f531a75c5f8b">启动和关闭服务</h4>
<div class="outline-text-4" id="text-h:40bb07ea-2178-43c7-95db-f531a75c5f8b">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;
</span>pg_ctl -D /pgsql/data -l logfile start
postgres -D /pgsql/data &amp;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20572;&#27490;&#25968;&#25454;&#24211;&#30340;&#21629;&#20196;&#22914;&#19979;:
</span>pg_ctl stop -D $<span style="color: #a0522d;">PGDATA</span> [-m SHUTDOWN-MODE]
&#20854;&#20013;-m&#26159;&#25351;&#23450;&#25968;&#25454;&#24211;&#30340;&#20572;&#27490;&#26041;&#27861;&#65292;&#26377;&#20197;&#19979;&#19977;&#31181;:
smart: &#31561;&#25152;&#26377;&#30340;&#36830;&#25509;&#20013;&#27490;&#21518;&#65292;&#20851;&#38381;&#25968;&#25454;&#24211;&#12290;&#22914;&#26524;&#23458;&#25143;&#31471;&#36830;&#25509;&#19981;&#32456;&#27490;&#65292;&#21017;&#26080;&#27861;&#20851;&#38381;&#25968;&#25454;&#24211;&#12290;
fast: &#24555;&#36895;&#20851;&#38381;&#25968;&#25454;&#24211;&#65292;&#26029;&#24320;&#23458;&#25143;&#31471;&#30340;&#36830;&#25509;&#65292;&#35753;&#24050;&#26377;&#30340;&#20107;&#21153;&#22238;&#28378;&#65292;&#28982;&#21518;&#27491;&#24120;&#20851;&#38381;&#25968;&#25454;&#24211;&#12290;&#30456;&#24403;&#20110;Oracle&#25968;&#25454;&#24211;&#20851;&#38381;&#26102;&#30340;immediate&#27169;&#24335;&#12290;&#27492;&#20026;&#40664;&#35748;&#20540;,&#24314;&#35758;&#20351;&#29992;
immediate: &#31435;&#21363;&#20851;&#38381;&#25968;&#25454;&#24211;&#65292;&#30456;&#24403;&#20110;&#25968;&#25454;&#24211;&#36827;&#31243;&#31435;&#21363;&#20572;&#27490;&#65292;&#30452;&#25509;&#36864;&#20986;&#65292;&#19979;&#27425;&#21551;&#21160;&#25968;&#25454;&#24211;&#38656;&#35201;&#36827;&#34892;&#24674;&#22797;&#12290;&#30456;&#24403;&#20110;Oracle&#25968;&#25454;&#24211;&#20851;&#38381;&#26102;&#30340; abort&#27169;&#24335;

<span style="color: #b22222;">#</span><span style="color: #b22222;">smart&#20851;&#38381;
</span>pg_ctl stop -D /pgsql/data/ -ms
<span style="color: #b22222;">#</span><span style="color: #b22222;">fast&#20851;&#38381;,&#25512;&#33616;&#20351;&#29992;,&#20063;&#26159;&#40664;&#35748;&#27169;&#24335;
</span>pg_ctl stop -D /pgsql/data/ -mf
<span style="color: #b22222;">#</span><span style="color: #b22222;">immediate &#30456;&#24403;&#20110;kill -9
</span>pg_ctl stop -D /pgsql/data/  -mi

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#21457;&#36865;&#20449;&#21495;,&#30452;&#25509;&#21521;&#25968;&#25454;&#24211;&#20027;&#36827;&#31243;&#21457;&#36865;&#30340;signal &#20449;&#21495;&#26377;&#20197;&#19979;&#19977;&#31181;&#12290;
</span>SIGTERM: &#21457;&#36865;&#27492;&#20449;&#21495;&#20026;Smart Shutdown&#20851;&#26426;&#27169;&#24335;&#12290;
SIGINT: &#21457;&#36865;&#27492;&#20449;&#21495;&#20026;Fast Shutdown&#20851;&#26426;&#27169;&#24335;&#12290;
SIGQUIT: &#21457;&#36865;&#27492;&#20449;&#21495;&#20026;Immediate Shutdown&#20851;&#26426;&#27169;&#24335;&#12290;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;
</span>pg_ctl restart -mf

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28304;&#30721;&#30446;&#24405;&#20013;&#20869;&#32622;PostgreSQL&#30340;&#21551;&#21160;&#33050;&#26412;
</span>postgresql-12.9/contrib/start-scripts/linux
</pre>
</div>

<p>
范例：Ubuntu 启动脚本实现开机自动PostgreSQL
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 ~]#cat /etc/rc.local
<span style="color: #b22222;">#</span><span style="color: #b22222;">!/bin/bash
</span>su - postgres -c <span style="color: #8b2252;">"/apps/pgsql/bin/pg_ctl -l logfile start"</span>

&#8203;#/etc/init.d/postgresql start
</pre>
</div>

<p>
范例: CentOS创建PosgreSQL启动脚本
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@rocky8 ~]#cp postgresql-12.9/contrib/start-scripts/linux /etc/init.d/postgresql

[root@rocky8 ~]#chmod +x /etc/init.d/postgresql
[root@rocky8 ~]#chkconfig --add postgresql

[root@rocky8 ~]#vim /etc/init.d/postgresql
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#19979;&#38754;&#20004;&#34892;
</span><span style="color: #a0522d;">prefix</span>=/apps/pgsql
<span style="color: #a0522d;">PGDATA</span>=<span style="color: #8b2252;">"/pgsql/data"</span>

[root@rocky8 ~]#service postgresql start
</pre>
</div>

<p>
范例: 创建 service 文件
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#26032;&#30340;service&#25991;&#20214;
</span>[root@ubuntu2004 ~]#cat &gt; /lib/systemd/system/postgresql.service &lt;&lt;EOF<span style="color: #ffa54f;">
[Unit]
Description=PostgreSQL database server
After=network.target

[Service]
User=postgres
Group=postgres

ExecStart=/apps/pgsql/bin/postgres -D /pgsql/data
ExecReload=/bin/kill -HUP

[Install]
WantedBy=multi-user.target
EOF
</span>
[root@ubuntu2004 ~]#systemctl daemon-reload

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#35748;&#25991;&#20214;&#20869;&#23481;, &#24182;&#24320;&#26426;&#21551;&#21160;
</span>systemctl cat postgresql.service
systemctl enable --now postgresql
</pre>
</div>
</div>
</div>
<div id="outline-container-查看编译和相关信息" class="outline-4">
<h4 id="查看编译和相关信息">查看编译和相关信息</h4>
<div class="outline-text-4" id="text-查看编译和相关信息">
<div class="org-src-container">
<pre class="src src-sh">[postgres@postgresql ~]$<span style="color: #a0522d;">pg_config</span>
<span style="color: #a0522d;">BINDIR</span> = /apps/pgsql/bin
<span style="color: #a0522d;">DOCDIR</span> = /apps/pgsql/share/doc
<span style="color: #a0522d;">HTMLDIR</span> = /apps/pgsql/share/doc
<span style="color: #a0522d;">INCLUDEDIR</span> = /apps/pgsql/include
<span style="color: #a0522d;">PKGINCLUDEDIR</span> = /apps/pgsql/include
INCLUDEDIR-SERVER = /apps/pgsql/include/server
<span style="color: #a0522d;">LIBDIR</span> = /apps/pgsql/lib
<span style="color: #a0522d;">PKGLIBDIR</span> = /apps/pgsql/lib
<span style="color: #a0522d;">LOCALEDIR</span> = /apps/pgsql/share/locale
<span style="color: #a0522d;">MANDIR</span> = /apps/pgsql/share/man
<span style="color: #a0522d;">SHAREDIR</span> = /apps/pgsql/share
<span style="color: #a0522d;">SYSCONFDIR</span> = /apps/pgsql/etc
<span style="color: #a0522d;">PGXS</span> = /apps/pgsql/lib/pgxs/src/makefiles/pgxs.mk
<span style="color: #a0522d;">CONFIGURE</span> = <span style="color: #8b2252;">'--prefix=/apps/pgsql'</span>
<span style="color: #a0522d;">CC</span> = gcc
<span style="color: #a0522d;">CPPFLAGS</span> = -D_GNU_SOURCE
<span style="color: #a0522d;">CFLAGS</span> = -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-
statement -Werror=vla -Wendif-labels -Wmissing-format-attribute
-Wformat- security -fno-strict-aliasing -fwrapv
-fexcess-precision=standard -Wno-format- truncation
-Wno-stringop-truncation -O2

<span style="color: #a0522d;">CFLAGS_SL</span> = -fPIC
<span style="color: #a0522d;">LDFLAGS</span> = -Wl,--as-needed -Wl,-rpath,<span style="color: #8b2252;">'/apps/pgsql/lib'</span>,--enable-new-dtags <span style="color: #a0522d;">LDFLAGS_EX</span> =
<span style="color: #a0522d;">LDFLAGS_SL</span> =
<span style="color: #a0522d;">LIBS</span> = -lpgcommon -lpgport -lpthread -lz -lreadline -lrt -lcrypt -ldl -lm
<span style="color: #a0522d;">VERSION</span> = PostgreSQL 12.9
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:199da93e-9605-40bb-82c5-9ef9cae297ae" class="outline-3">
<h3 id="h:199da93e-9605-40bb-82c5-9ef9cae297ae">pg_ctl 命令管理PostgreSQL</h3>
<div class="outline-text-3" id="text-h:199da93e-9605-40bb-82c5-9ef9cae297ae">
<p>
pg_ctl 是一个实用的命令行工具，有以下常见功能:
</p>

<ul class="org-ul">
<li>初始化 PostgreSQL 数据库实例</li>
<li>启动、终止或重启 PostgreSQL 数据库服务。</li>
<li>查看 PostgreSQL数据库服务的状态</li>
<li>让数据库实例重新读取配置文件。允许给一个指定的PostgreSQL进程发送信号</li>
<li>控制 standby 服务器为可读写</li>
<li>在Windows平台下允许为数据库实例注册或取消一个系统服务</li>
</ul>

<p>
pc_ctl 命令格式
</p>

<div class="org-src-container">
<pre class="src src-sh">postgres@debian:~$ pg_ctl --help
pg_ctl is a utility to initialize, start, stop, or control a PostgreSQL server.

Usage:
  pg_ctl init[db]   [-D DATADIR] [-s] [-o OPTIONS]
  pg_ctl start      [-D DATADIR] [-l FILENAME] [-W] [-t SECS] [-s]
                    [-o OPTIONS] [-p PATH] [-c]
  pg_ctl stop       [-D DATADIR] [-m SHUTDOWN-MODE] [-W] [-t SECS] [-s]
  pg_ctl restart    [-D DATADIR] [-m SHUTDOWN-MODE] [-W] [-t SECS] [-s]
                    [-o OPTIONS] [-c]
  pg_ctl reload     [-D DATADIR] [-s]
  pg_ctl status     [-D DATADIR]
  pg_ctl promote    [-D DATADIR] [-W] [-t SECS] [-s]
  pg_ctl logrotate  [-D DATADIR] [-s]
  pg_ctl kill       SIGNALNAME PID

Common options:
  -D, --pgdata=DATADIR   location of the database storage area
  -s, --silent           only print errors, no informational messages
  -t, --timeout=SECS     seconds to wait when using -w option
  -V, --version          output version information, then exit
  -w, --wait             wait until operation completes (default)
  -W, --no-wait         <span style="color: #a020f0;"> do</span> not wait until operation completes
  -?, --help             show this help, then exit
If the -D option is omitted, the environment variable PGDATA is used.

Options for start or restart:
  -c, --core-files       allow postgres to produce core files
  -l, --log=FILENAME     write (or append) server log to FILENAME
  -o, --options=OPTIONS  command line options to pass to postgres
                         (PostgreSQL server executable) or initdb
  -p PATH-TO-POSTGRES    normally not necessary

Options for stop or restart:
  -m, --mode=MODE        MODE can be <span style="color: #8b2252;">"smart"</span>, <span style="color: #8b2252;">"fast"</span>, or <span style="color: #8b2252;">"immediate"</span>

Shutdown modes are:
  smart       quit after all clients have disconnected
  fast        quit directly, with proper shutdown (default)
  immediate   quit without complete shutdown; will lead to recovery on restart

Allowed signal names for kill:
  ABRT HUP INT KILL QUIT TERM USR1 USR2

Report bugs to <a href="mailto:pgsql-bugs%40lists.postgresql.org">&lt;pgsql-bugs@lists.postgresql.org&gt;</a>.
PostgreSQL home page: <a href="https://www.postgresql.org/">&lt;https://www.postgresql.org/&gt;</a>
</pre>
</div>

<p>
范例：别名
</p>
<div class="org-src-container">
<pre class="src src-sh">cat &lt;&lt;\EOF&gt;&gt; ~/.bash_profile <span style="color: #ffa54f;">
alias ll='ls -alF'
alias gprestart='pg_ctl -D /pgsql/data restart'
alias gprestatus='pg_ctl -D /pgsql/data status'
alias gpstart='pg_ctl -D /pgsql/data start'
alias gpstop='pg_ctl -D /pgsql/data stop'
EOF</span>
</pre>
</div>
</div>
<div id="outline-container-初始化实例" class="outline-4">
<h4 id="初始化实例">初始化实例</h4>
<div class="outline-text-4" id="text-初始化实例">
<p>
初始化PostgreSQL数据库实例的命令如下:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20808;&#20999;&#25442;&#29992;&#25143;
</span>su - postgres

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;
</span>initdb [DATADIR]
pg_ctl init[db] [-s] [-D DATADIR] [-o options]

<span style="color: #b22222;">#</span><span style="color: #b22222;">pg_ctl&#21629;&#20196;&#35843;&#29992;initdb&#21629;&#20196;&#21019;&#24314;&#20102;&#19968;&#20010;&#26032;&#30340;PostgreSQL&#25968;&#25454;&#24211;&#23454;&#20363;,&#21442;&#25968;&#35828;&#26126;&#22914;&#19979;&#12290;
</span>
-s <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#25171;&#21360;&#38169;&#35823;&#21644;&#35686;&#21578;&#20449;&#24687;&#65292;&#19981;&#25171;&#21360;&#25552;&#31034;&#24615;&#20449;&#24687;&#12290;
</span>-D DATADIR  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#24211;&#23454;&#20363;&#30340;&#25968;&#25454;&#30446;&#24405;&#12290;&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;DATADIR,&#20351;&#29992;&#29615;&#22659;&#21464;&#37327;PGDATA&#25351;&#23450;&#30340;&#36335;&#24452;
</span>-o options <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#30452;&#25509;&#20256;&#36882;&#32473;initdb&#21629;&#20196;&#30340;&#21442;&#25968;</span>
</pre>
</div>

<p>
范例: 创建新的数据库实例数据
</p>

<div class="org-src-container">
<pre class="src src-sh">chown postgres: /pgsql/
su - postgres

postgres@debian:~$ pg_ctl  init -D /pgsql/data2
Success. You can now start the database server using:

    /apps/pgsql/bin/pg_ctl -D /pgsql/data2 -l logfile start

postgres@debian:~$ ls /pgsql/data2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#31471;&#21475;&#65292;&#21551;&#21160;&#23454;&#20363;
</span>postgres@debian:~$ grep 5432 /pgsql/data2/postgresql.conf 
<span style="color: #b22222;">#</span><span style="color: #b22222;">port = 5432                            # (change requires restart)
</span>postgres@debian:~$ echo <span style="color: #a0522d;">port</span> = 5433 &gt;&gt; /pgsql/data2/postgresql.conf
postgres@debian:~$ /apps/pgsql/bin/pg_ctl -D /pgsql/data2 -l logfile start

pg_ctl -D /pgsql/data2 stop
</pre>
</div>
</div>
</div>
<div id="outline-container-服务管理" class="outline-4">
<h4 id="服务管理">服务管理</h4>
<div class="outline-text-4" id="text-服务管理">
</div>
<div id="outline-container-查看服务状态" class="outline-5">
<h5 id="查看服务状态">查看服务状态</h5>
<div class="outline-text-5" id="text-查看服务状态">
<p>
查询数据库实例状态的命令如下:
</p>
<pre class="example" id="org42768ee">
pg_ctl status [-D datadir]
</pre>

<p>
范例:
</p>
<div class="org-src-container">
<pre class="src src-sh">postgres@ubuntu2004:~$ pg_ctl status -D /pgsql/data2
pg_ctl: server is running (PID: 23320)
/apps/pgsql/bin/postgres <span style="color: #8b2252;">"-D"</span> <span style="color: #8b2252;">"/pgsql/data2"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-启动服务" class="outline-5">
<h5 id="启动服务">启动服务</h5>
<div class="outline-text-5" id="text-启动服务">
<p>
启动PostgreSQL服务的命令:
</p>
<div class="org-src-container">
<pre class="src src-sh">pg_ctl start [-w] [-t seconds] [-s] [-D datadir] [-l filename] [-o options] [-p path] [-c]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#25968;&#35828;&#26126;&#22914;&#19979;&#12290;
</span>start <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#25968;&#25454;&#24211;&#23454;&#20363;
</span>-w <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31561;&#24453;&#21551;&#21160;&#23436;&#25104;
</span>-t <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31561;&#24453;&#21551;&#21160;&#23436;&#25104;&#30340;&#31561;&#24453;&#31186;&#25968;&#65292;&#40664;&#35748;&#20026;60&#31186;
</span>-s <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#25171;&#21360;&#38169;&#35823;&#21644;&#35686;&#21578;&#20449;&#24687;,&#19981;&#25171;&#21360;&#25552;&#31034;&#24615;&#20449;&#24687;
</span>-D datadir <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#24211;&#23454;&#20363;&#30340;&#25968;&#25454;&#30446;&#24405;
</span>-l <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#26085;&#24535;&#36755;&#20986;&#38468;&#21152;&#22312;&#8220;filename&#8221;&#25991;&#20214;&#19978;&#65292;&#22914;&#26524;&#35813;&#25991;&#20214;&#19981;&#23384;&#22312;&#21017;&#21019;&#24314;&#23427;
</span>-o options <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22768;&#26126;&#35201;&#30452;&#25509;&#20256;&#36882;&#32473;postgres &#30340;&#36873;&#39033;&#65292;&#20855;&#20307;&#21487;&#35265;postgres&#21629;&#20196;&#30340;&#24110;&#21161;
</span>-p path <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;postgres&#21487;&#25191;&#34892;&#25991;&#20214;&#30340;&#20301;&#32622;&#12290;&#40664;&#35748;&#24773;&#20917;&#19979;postgres&#21487;&#25191;&#34892;&#25991;&#20214;&#26469;&#33258;&#21644;pg_ctl&#30456;&#21516;&#30340;&#30446;&#24405;&#65292;
</span>             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#24517;&#20351;&#29992;&#35813;&#36873;&#39033;&#12290;&#38500;&#38750;&#35201;&#36827;&#34892;&#19968;&#20123;&#19981;&#21516;&#23547;&#24120;&#30340;&#25805;&#20316;&#65292;&#25110;&#32773;&#20135;&#29983;&#20102;postgres&#25191;&#34892;&#25991;&#20214;&#25214;&#19981;&#21040;&#30340;&#38169;&#35823;
</span>
-c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#39640;&#26381;&#21153;&#22120;&#30340;&#36719;&#38480;&#21046;(ulimit -c)&#65292;&#23581;&#35797;&#20801;&#35768;&#25968;&#25454;&#24211;&#23454;&#20363;&#22312;&#26377;&#24322;&#24120;&#26102;&#20135;&#29983;&#19968;&#20010;coredump&#25991;&#20214;,&#20197;&#20415;&#20110;&#38382;&#39064;&#23450;&#20301;&#21644;&#25925;&#38556;&#20998;&#26512;</span>
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">postgres@ubuntu2004:~$ pg_ctl start -D /pgsql/data2
postgres@ubuntu2004:~$ pg_ctl status -D /pgsql/data2
pg_ctl: server is running (PID: 23027)
/apps/pgsql/bin/postgres <span style="color: #8b2252;">"-D"</span> <span style="color: #8b2252;">"/pgsql/data2"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-停止服务" class="outline-5">
<h5 id="停止服务">停止服务</h5>
<div class="outline-text-5" id="text-停止服务">
<p>
停止PostgreSQL 数据库的命令如下:
</p>
<div class="org-src-container">
<pre class="src src-sh">pg_ctl stop [-w] [-t seconds] [-s] [-D datadir] [-m s[mart] l f[ast] | i [mmediate] ]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#25968;&#35828;&#26126;&#22914;&#19979;&#12290;
</span>-W <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#31561;&#24453;&#25968;&#25454;&#24211;&#20572;&#19979;&#26469;&#65292;&#21629;&#20196;&#23601;&#36820;&#22238;&#12290;
</span>-m <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#20572;&#27490;&#30340;&#27169;&#24335;&#12290;&#21069;&#38754;&#24050;&#21465;&#36848;&#36807;&#20572;&#27490;&#30340;&#20960;&#31181;&#27169;&#24335;&#20102;&#12290;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20854;&#23427;&#26410;&#35828;&#26126;&#30340;&#21442;&#25968;,&#20854;&#21547;&#20041;&#19982;&#21551;&#21160;&#25968;&#25454;&#24211;&#21629;&#20196;&#20013;&#30340;&#21442;&#25968;&#30456;&#21516;&#12290;</span>
</pre>
</div>

<p>
范例:
</p>
<div class="org-src-container">
<pre class="src src-sh">postgres@ubuntu2004:~$ pg_ctl stop -D /pgsql/data2
server stopped

postgres@ubuntu2004:~$ pg_ctl status -D /pgsql/data2
pg_ctl: no server running
</pre>
</div>
</div>
</div>
<div id="outline-container-重启服务" class="outline-5">
<h5 id="重启服务">重启服务</h5>
<div class="outline-text-5" id="text-重启服务">
<p>
重启PostgreSQL 数据库的命令如下:
</p>

<div class="org-src-container">
<pre class="src src-sh">pg_ctl restart [-w] [-t seconds][-s] [-D datadir] [-c] [-m s[mart] | f[ast] | i[mmediate] ] [-o <span style="color: #8b2252;">"options ]

#&#27492;&#21629;&#20196;&#20013;&#30340;&#21442;&#25968;&#19982;&#21551;&#21160;&#25110;&#20572;&#27490;&#21629;&#20196;&#20013;&#30340;&#21442;&#25968;&#21547;&#20041;&#30456;&#21516;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-加载配置" class="outline-5">
<h5 id="加载配置">加载配置</h5>
<div class="outline-text-5" id="text-加载配置">
<p>
在配置文件中改变参数后，需要使用上面这条命令使参数生效
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;&#25991;&#20214; postgresql.conf&#21518;&#65292;&#35753;&#20462;&#25913;&#29983;&#25928;&#30340;&#26041;&#27861;&#26377;&#20004;&#31181;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;&#19968;:&#22312;&#25805;&#20316;&#31995;&#32479;&#20351;&#29992;&#19979;&#38754;&#21629;&#20196;
</span>pg_ctl reload [-s] [-D datadir]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;&#20108;:&#22312; psql &#20013;&#20351;&#29992;&#22914;&#19979;&#21629;&#20196;
</span><span style="color: #a0522d;">postgres</span>=# select pg_reload_conf();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;:&#21152;&#36733;&#37197;&#32622;&#25805;&#20316;&#21482;&#38024;&#23545;&#19968;&#20123;&#37197;&#32622;&#30340;&#20462;&#25913;&#29983;&#25928;,&#26377;&#20123;&#37197;&#32622;&#38656;&#35201;&#37325;&#26032;&#21551;&#21160;&#26381;&#21153;&#25165;&#33021;&#29983;&#25928;</span>
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">postgres@ubuntu2004:~$ pg_ctl reload -D /pgsql/data2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;:&#20462;&#25913;&#31471;&#21475;&#19981;&#25903;&#25345;reload,&#21482;&#33021;restart
</span>postgres@ubuntu2004:~$ vim /pgsql/data2/postgresql.conf
<span style="color: #a0522d;">listen_addresses</span> = <span style="color: #8b2252;">'*'</span>

postgres@ubuntu2004:~$ pg_ctl reload -D /pgsql/data2

postgres@ubuntu2004:~$ pg_ctl restart -D /pgsql/data2

postgres@ubuntu2004:~$ ss -ntl|grep 5432
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-promote-模式" class="outline-4">
<h4 id="promote-模式">promote 模式</h4>
<div class="outline-text-4" id="text-promote-模式">
<p>
在流复制架构中,在standby主机执行promote提升操作,恢复正常的读写操作
</p>

<pre class="example" id="org67bcc7b">
pg_ctl promote [-D DATADIR] [-W] [-t SECS] [-s]
</pre>

<p>
备用服务器在指定数据目录中运行提升模式命令,结束备用模式并开始读写操作
</p>
</div>
</div>
</div>
</section>
<section id="outline-container-postgresql-管理" class="outline-2">
<h2 id="postgresql-管理">PostgreSQL 管理</h2>
<div class="outline-text-2" id="text-postgresql-管理">
</div>
<div id="outline-container-配置文件介绍" class="outline-3">
<h3 id="配置文件介绍">配置文件介绍</h3>
<div class="outline-text-3" id="text-配置文件介绍">
<p>
PostgreSQL使用环境变量PGDATA指向的目录做为数据存放的目录。这个目录是在
安装时指定的，所以在安装时需要指定一个合适的目录作为数据目录的根目录，
而且，每一个PG数据库实例都需要有这样的一个目录。此数据目录的初始化是使
用命令initdb来完成的。
</p>

<p>
初始化完成后，PGDATA数据目录下就会生成三个配置文件。
</p>



<div class="org-src-container">
<pre class="src src-sh">postgresql.conf <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#23454;&#20363;&#30340;&#20027;&#37197;&#32622;&#25991;&#20214;&#65292;&#22522;&#26412;&#19978;&#25152;&#26377;&#30340;&#37197;&#32622;&#21442;&#25968;&#37117;&#22312;&#27492;&#25991;&#20214;&#20013;&#12290;
</span>pg_hba.conf <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35748;&#35777;&#37197;&#32622;&#25991;&#20214;&#65292;&#37197;&#32622;&#20102;&#20801;&#35768;&#21738;&#20123;IP&#30340;&#20027;&#26426;&#35775;&#38382;&#25968;&#25454;&#24211;&#65292;&#35748;&#35777;&#30340;&#26041;&#27861;&#26159;&#20160;&#20040;&#31561;&#20449;&#24687;&#12290;
</span>pg_ident.conf <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35748;&#35777;&#26041;&#24335;ident&#30340;&#29992;&#25143;&#26144;&#23556;&#25991;&#20214;&#12290;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-数据库相关概念" class="outline-3">
<h3 id="数据库相关概念">数据库相关概念</h3>
<div class="outline-text-3" id="text-数据库相关概念">
</div>
<div id="outline-container-数据库的结构组织" class="outline-4">
<h4 id="数据库的结构组织">数据库的结构组织</h4>
<div class="outline-text-4" id="text-数据库的结构组织">

<figure id="orgc056d33">
<img src="./images/img_20241106_161617.png" alt="img_20241106_161617.png" width="100%">

</figure>


<p>
在一个PostgreSQL 数据库系统中，数据的组织结构可以分为以下五层:
</p>
<ul class="org-ul">
<li>实例: 一个PostgreSQL对应一个安装的数据目录$PGDATA,即一个instance实例</li>
<li><p>
数据库:一个PostgreSQL数据库服务下可以管理多个数据库，当应用连接到一个数据库时，一般只能访问这个数据库中的数据，而不能访问其他数据库中的内容
</p>

<p>
默认情况下初始实例只有三个数据库： postgres、template0、template1
</p></li>

<li>模式: 一个数据库可以创建多个不同的名称空间即Schema,用于分隔不同的业务数据</li>
<li>表和索引：一个数据库可以有多个表和索引。在PostgreSQL中表的术语称为Relation，而在其他数据库中通常叫Table</li>
<li>行和列:每张表中有很多列和行数据。在PostgreSQL 中行的术语一般为“Tuple”，而在其他数据库中则叫“Row”。</li>
</ul>
</div>
</div>
<div id="outline-container-h:6391ee54-ebd3-4e22-b726-68acecbb8c7f" class="outline-4">
<h4 id="h:6391ee54-ebd3-4e22-b726-68acecbb8c7f">PostgreSQL中的术语</h4>
<div class="outline-text-4" id="text-h:6391ee54-ebd3-4e22-b726-68acecbb8c7f">
<p>
PostgreSQL有一些术语与其他数据库中不一样，了解了这些术语的意思，就能更好地看懂PostgreSQL中的文档。
</p>


<p>
与其他数据库不同的术语如下。
</p>
<ul class="org-ul">
<li>Relation:表示表table或索引index，具体表示的是Table还是Index需要看具体情况</li>
<li>Tuple:表示表中的行，在其他数据库中使用Row来表示</li>
<li>Segment:每个表和索引都单独对应一个文件,,即为segment,如果文件大小超过1GB,会创建多个相同名称但后缀不同的文件</li>
<li>Page:表示在磁盘中的数据块。在文件中以块为单位存放数据, 默认值为8KB,最大可以为32KB</li>
<li>Buffer:表示在内存中的数据块。</li>
</ul>

<p>
范例: 编译时可以指定segment大小
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 postgresql-12.9]#./configure --help |grep segment
--with-segsize=SEGSIZE set table segment size<span style="color: #a020f0;"> in</span> GB [1]
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f292435d-b97b-48e4-8a86-d983986b8322" class="outline-4">
<h4 id="h:f292435d-b97b-48e4-8a86-d983986b8322">模版数据库template0 和template1</h4>
<div class="outline-text-4" id="text-h:f292435d-b97b-48e4-8a86-d983986b8322">
<p>
template1和template0是PostgreSQL的模板数据库。所谓模板数据库就是创建新database时，PostgreSQL会基于模板数据库制作一份副本，其中会包含所有的数据库设置和数据文件。
</p>

<p>
PostgreSQL安装好以后会默认附带两个模板数据库： 默认模板库为template1和template1。
</p>

<p>
默认模板库为 template1,也可以指定template0
</p>

<p>
比如:create database db1 template template0
</p>

<p>
不要对template0模板数据库进行任何修改，因为这是原始的干净模板如果其它模板数据库被搞坏了，基于这个数据库做一个副本就可以了。
</p>

<p>
如果希望定制自己的模板数据库，那么请基于template1进行修改，或者自己另外创建一个模板数据库再修改。
</p>

<p>
template1和template0的区别主要有两点：
</p>
<ol class="org-ol">
<li>template1 可以连接，template0 不可以连接。</li>
<li>使用 template1 模板库建库时不可指定新的encoding 和locale，而template0可以。</li>
</ol>

<p>
注意：template0和template1都不能被删除。
</p>
</div>
</div>
<div id="outline-container-h:1fc19b87-d753-400a-ab39-d76be716a167" class="outline-4">
<h4 id="h:1fc19b87-d753-400a-ab39-d76be716a167">模式 schema</h4>
<div class="outline-text-4" id="text-h:1fc19b87-d753-400a-ab39-d76be716a167">
<p>
模式schema是数据库中的一个概念，可以将其理解为一个命名空间。不同的模式
下可以有相同名称的表、函数等对象且互相不冲突。提出模式的概念是为了便于
管理，只要有权限，每个模式(schema）的对象可以互相调用。
</p>

<p>
在 PostgreSQL中，一个数据库包含一个或多个模式，一个模式中又包含了表、函数及操作符等数据库对象。
</p>

<p>
在PostgreSQL中，不能同时访问不同数据库中的对象，当要访问另一个数据库中
的表或其他对象时，需要重新连接到这个新的数据库，而模式没有此限制。一个
用户在连接到一个数据库后，就可以同时访问这个数据库中多个模式的对象。
</p>

<p>
通常情况下，创建和访问表的时候都不用指定模式，实际上这时访问的都是
public模式。每当我们创建一个新的数据库时，PostgreSQL都会自动创建一个名
为public的模式。当登录到该数据库时，如果没有特殊的指定，都是以该模式
public操作各种数据对象的。
</p>

<p>
我们需要使用模式有以下几个主要原因:
</p>
<ul class="org-ul">
<li>允许多个用户在使用同一个数据库时彼此互不干扰。</li>
<li>把数据库对象放在不同的模式下，然后组织成逻辑组，让它们更便于管理。</li>
<li>第三方的应用可以放在不同的模式中，这样就不会和其他对象的名字冲突了。</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#27169;&#24335;
</span>create schema schema_name;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#27169;&#24335;
</span>drop schema schema_name;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#27169;&#24335;
</span>\dn
</pre>
</div>

<p>
要访问指定模式中的对象，需要先指定一个包含模式名及表名的名字，模式和表之间用一个“点”分开，如下:
</p>

<pre class="example" id="org1dbb42b">
schema_name.table_name
</pre>
</div>
</div>
<div id="outline-container-h:88d7dc17-4387-45b2-ae43-83cdaa27eeb2" class="outline-4">
<h4 id="h:88d7dc17-4387-45b2-ae43-83cdaa27eeb2">psql 工具介绍和基本用法</h4>
<div class="outline-text-4" id="text-h:88d7dc17-4387-45b2-ae43-83cdaa27eeb2">
<p>
psql是PostgreSQL中的一个命令行交互式客户端工具，类似MySQL的mysql和
Oracle中的命令行工具sqlplus，它允许你交互地输入SQL或命令，然后把它们发
出给PostgreSQL服务器，再显示SQL或命令的结果。而且，输入的内容还可以来
自于一个文件。此外，它还提供了一些命令和多种类似shell的特性来实现书写
脚本，从而实现对大量任务的自动化工作。
</p>

<p>
虽然也可以使用PostgreSQL中图形化的客户端工具(如pgadmin)来实现上述功能。
但如果掌握了psql的使用方法，将会体会到它的方便之处。因为psql是一个字符
界面的工具，没有图形化工具使用上的一些限制。psql与 pgAdminIII之间的关
系类似于vi与某些图形化工具的关系。
</p>

<p>
<b>psql 的历史命令与补全的功能</b>
</p>
<ul class="org-ul">
<li>可以使用上下键把以前使用过的命令或SQL语句调出来</li>
<li>连续按两个tab键表示把命令补全或给出提示输入</li>
</ul>

<p>
<b>psql 命令格式</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">psql -h &lt;hostname or ip&gt; -p&lt;&#31471;&#21475;&gt; [&#25968;&#25454;&#24211;&#21517;&#31216;] -U [&#29992;&#25143;&#21517;&#31216;]

-h <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#35201;&#36830;&#25509;&#30340;&#25968;&#25454;&#24211;&#20027;&#26426;&#21517;&#25110;IP&#22320;&#22336;,&#40664;&#35748;local socket&#30331;&#24405;(&#30001;&#37197;&#32622;&#39033;unix_socket_directories&#25351;&#23450;)
</span>-p <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#36830;&#25509;&#30340;&#25968;&#25454;&#24211;&#31471;&#21475;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#21518;&#20004;&#20010;&#21442;&#25968;&#26159;&#25968;&#25454;&#24211;&#21517;&#21644;&#29992;&#25143;&#21517;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#20123;&#36830;&#25509;&#21442;&#25968;&#20063;&#21487;&#20197;&#29992;&#29615;&#22659;&#21464;&#37327;&#25351;&#23450;&#65292;&#27604;&#22914;:
</span><span style="color: #483d8b;">export</span> <span style="color: #a0522d;">PGDATABASE</span>=testdb
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">PGHOST</span>=10.0.0.200
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">PGPORT</span>=5432
<span style="color: #483d8b;">export</span> <span style="color: #a0522d;">PGUSER</span>=postgres

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28982;&#21518;&#36816;&#34892;psql&#21363;&#21487;&#65292;&#20854;&#25928;&#26524;&#19982;&#36816;&#34892;psql -h 10.0.0.200 -p 5432 testdb postgres&#30456;&#21516;&#12290;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#36890;&#36807;&#19979;&#38754;&#21629;&#20196;&#26597;&#30475;&#35814;&#32454;&#24110;&#21161;:man /apps/pgsql/share/man/man1/psql.1</span>
</pre>
</div>

<p>
范例：psql 本地登录PGSQL
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1
</span>[root@rocky8 ~]#psql -d postgres -U postgres

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2
</span>[root@rocky8 ~]#su - postgres
[postgres@rocky8 ~]$<span style="color: #a0522d;">psql</span>
</pre>
</div>

<p>
范例：远程登录
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;:&#40664;&#35748;PostgreSQL&#19981;&#25903;&#25345;&#36828;&#31243;&#30331;&#24405;,&#38656;&#35201;&#20462;&#25913;&#37197;&#32622;&#21644;&#25480;&#26435;&#25165;&#21487;&#20197;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#19981;&#25351;&#23450;hellodb&#25968;&#25454;&#24211;,&#40664;&#35748;&#36830;&#25509;&#21644;&#29992;&#25143;&#21517;&#21516;&#21517;&#30340;&#25968;&#25454;&#24211;
</span>
[root@rocky8 ~]#psql -h 10.0.0.200 -p 5432 hellodb postgres
Password for user postgres:
<span style="color: #0000ff;">psql</span> (12.9)
Type <span style="color: #8b2252;">"help"</span> for help.

<span style="color: #a0522d;">hellodb</span>=#
</pre>
</div>

<p>
范例：psql 命令中直接执行 SQL
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@rocky8 ~]#psql -U postgres -h 10.0.0.200 -p 5432 -d postgres -c <span style="color: #8b2252;">"select current_time"</span>
Password for user postgres: current_time
04:43:48.508999+00
(1 row)
</pre>
</div>

<p>
范例：psql 命令中执行文件中的 SQL
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@rocky8 ~]#cat test.sql
<span style="color: #a020f0;">select</span> current_time
\du

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1
</span>[root@rocky8 ~]#psql -U postgres -h 10.0.0.200 -p 5432 -d postgres -f test.sql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2
</span>\i &lt;&#25991;&#20214;&#21517;&gt; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25191;&#34892;&#23384;&#20648;&#22312;&#22806;&#37096;&#25991;&#20214;&#20013;&#30340;sql&#35821;&#21477;&#25110;&#21629;&#20196;
</span>[postgres@rocky8 ~]$<span style="color: #a0522d;">psql</span>
<span style="color: #a0522d;">postgres</span>=# \i hellodb.sql
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">postgres</span>=# create database db1;
CREATE DATABASE
<span style="color: #a0522d;">postgres</span>=# \c db1
You are now connected to database <span style="color: #8b2252;">"db1"</span> as user <span style="color: #8b2252;">"postgres"</span>.
<span style="color: #a0522d;">db1</span>=# create table t1(id int);
CREATE TABLE
<span style="color: #a0522d;">db1</span>=# \dt
 public | t1   | table | postgres


postgres@debian:~$ cat test.sql 
\c db1
create table t2(id int);
<span style="color: #a020f0;">select</span> * from t2;

postgres@debian:~$ psql -f test.sql 
You are now connected to database <span style="color: #8b2252;">"db1"</span> as user <span style="color: #8b2252;">"postgres"</span>.
CREATE TABLE
 id 
----
(0 rows)
</pre>
</div>

<p>
范例：psql客户端命令
</p>
<div class="org-src-container">
<pre class="src src-sh">\c <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#24403;&#21069;&#36830;&#25509;&#30340;&#25968;&#25454;&#24211;
</span>\c &#24211;&#21517; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#25968;&#25454;&#24211;
</span>\dn <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;schema
</span>\l <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#25968;&#25454;&#24211;
</span>\du <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#26435;&#38480;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-连接管理" class="outline-3">
<h3 id="连接管理">连接管理</h3>
<div class="outline-text-3" id="text-连接管理">
</div>
<div id="outline-container-访问控制配置文件介绍" class="outline-4">
<h4 id="访问控制配置文件介绍">访问控制配置文件介绍</h4>
<div class="outline-text-4" id="text-访问控制配置文件介绍">
<p>
在PostgreSQL中，带有一个网络防火墙的功能的文件pg_hba.conf,可以控制允许设置哪些IP的机器访问数据库服务器。
</p>

<p>
HBA的意思是host-based authentication，也就是基于主机的认证,即实现PostgreSQL 防火墙功能
</p>

<p>
initdb初始化数据目录时，会生成一个默认的pg_hba.conf文件。
</p>

<p>
pg_hba.conf文件的格式由很多记录组成，每条记录占一行。
</p>

<p>
以#开头的行为注释及空白行会被忽略。
</p>

<p>
一条记录由若干个空格或由制表符分隔的字段组成，如果字段用引号包围，那么它可以包含空白。
</p>

<p>
每条记录声明一种连接类型、一个客户端IP地址范围(如果和连接类型相关)、一个数据库名、一个用户名字，以及对匹配这些参数的连接所使用的认证方法。
</p>

<p>
第一条匹配连接类型、客户端地址、连接请求的数据库名和用户名的记录将用于
执行认证。如果选择了一条记录而且认证失败，那么将不再考虑后面的记录;如
果没有匹配的记录,访问将被拒绝。即从上向下匹配，一旦匹配则不会再向下检查
</p>

<p>
每条记录可以是下面七种格式之一:
</p>

<pre class="example" id="org8b49e35">
1) local &lt;dbname&gt; &lt;user&gt; &lt;auth-method&gt;[auth-options]
2) host &lt;dbname&gt; &lt;user&gt; &lt;ip/masklen&gt; &lt;auth-method&gt;auth-options]
3) hostssl &lt;dbname&gt;&lt;user&gt; &lt;ip/masklen&gt; &lt;auth-method&gt;[auth-options]
4) hostnossl &lt;dbname&gt; &lt;user&gt; &lt;ip/masklen&gt; &lt;auth-method&gt;[auth-options]
5) host &lt;dbname&gt; &lt;user&gt; &lt;ip&gt;&lt;mask&gt; &lt;auth-method&gt; [auth-options]
6) hostssl &lt;dbname&gt; &lt;user&gt; &lt;ip&gt; &lt;mask&gt; &lt;auth-method&gt;[ auth-options]
7) hostnossl &lt;dbname&gt;&lt;user&gt;&lt;ip&gt;&lt;mask&gt; &lt;auth-method&gt;[auth-options]
</pre>

<p>
pg_hba.conf文件为pg实例的防火墙配置文件。配置文件格式分为5部分:
</p>

<pre class="example" id="org7e5be21">
TYPE DATABASE USER ADDRESS METHOD
</pre>

<ul class="org-ul">
<li>第1个字段只能是下面的取值.
<ul class="org-ul">
<li>local: 这条记录匹配通过UNIX域套接字的连接认证。没有这种类型的记录，
就不允许有UNIX域套接字的连接。当psql后面不指定主机名或IP地址时，即
用UNIX域套接字的方式连接数据库。</li>

<li>host:这条记录匹配通过TCP/IP进行的连接。包括了SSL和非SS的连接。</li>
<li>hostssl:这条记录匹配使用TCP/IP的SSL连接。必须是使用SSL加密的连接，且要使用这个选项,编译服务器时必须打开SSL支持，启动服务器时必须打开SSL配置选项。</li>
<li>hostnossl: 这条记录与hostssI相反，它只匹配那些在TCP/IP上不使用SSL 的连接请求。</li>
</ul></li>

<li>第2个字段用于设置一个数据库名称，如果设置为all，表示可以匹配任何数据
库,注意:如果设置为replication时比较特殊,表示允许流复制连接，而不是允
许连接到一个名为“replication”的数据库上。</li>

<li>第3个字段用于设置一个用户的名称，如果设置为all，表示可以匹配任何用户。</li>

<li>第4个字段&lt;ip/masklen&gt;表示允许哪些IP地址来访问此服务器，如
192.168.1.10/32表示只允许192.168.1.10这台主机访问数据
库,192.168.1.0/24表示IP地址前缀为192.168.1.X的主机都允许访问数据库服
务器。</li>

<li>第5个字段表示验证方法，PostgreSQL支持的认证配置方式很多，最常用的认证方法是trust、reject、md5和 ident方法。</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">METHOD&#26377;&#22914;&#19979;&#20540;&#21487;&#36873;
</span>md5&#65306;&#25191;&#34892;SCRAM-SHA-256&#25110;MD5&#36523;&#20221;&#39564;&#35777;&#21152;&#23494;&#23494;&#30721;&#26469;&#39564;&#35777;,&#26159;&#25512;&#33616;&#20351;&#29992;&#30340;&#23433;&#20840;&#39564;&#35777;&#30340;&#26041;&#27861;
peer&#65306;&#20174;&#25805;&#20316;&#31995;&#32479;&#33719;&#21462;&#23458;&#25143;&#31471;&#30340;&#25805;&#20316;&#31995;&#32479;&#29992;&#25143;&#21517;&#65292;&#24182;&#26816;&#26597;&#23427;&#26159;&#21542;&#19982;&#35831;&#27714;&#30340;&#25968;&#25454;&#24211;&#29992;&#25143;&#21517;&#21305;&#37197;&#12290;&#36825;&#20165;&#36866;&#29992;&#20110;&#26412;&#22320;socket&#36830;&#25509;&#12290;
trust&#65306;&#20801;&#35768;&#26080;&#26465;&#20214;&#36830;&#25509;&#65292;&#20801;&#35768;&#20219;&#20309;PostgreSQL&#29992;&#25143;&#36523;&#20221;&#30331;&#24405;&#65292;&#32780;&#26080;&#38656;&#23494;&#30721;&#25110;&#20219;&#20309;&#20854;&#20182;&#36523;&#20221;&#39564;&#35777;&#12290;
reject&#65306;&#25298;&#32477;&#20219;&#20309;&#26465;&#20214;&#36830;&#25509;&#65292;&#36825;&#23545;&#20110;&#20174;&#32452;&#20013;&#8220;&#36807;&#28388;&#25481;&#8221;&#26576;&#20123;&#20027;&#26426;&#38750;&#24120;&#26377;&#29992;&#12290;
scram-sha-256&#65306;&#25191;&#34892;SCRAM-SHA-256&#36523;&#20221;&#39564;&#35777;&#20197;&#39564;&#35777;&#29992;&#25143;&#30340;&#23494;&#30721;&#12290;
password&#65306;&#35201;&#25552;&#20379;&#26410;&#21152;&#23494;&#30340;&#23494;&#30721;&#20197;&#36827;&#34892;&#36523;&#20221;&#39564;&#35777;&#12290;&#30001;&#20110;&#23494;&#30721;&#26159;&#36890;&#36807;&#32593;&#32476;&#20197;&#26126;&#25991;&#24418;&#24335;&#21457;&#36865;&#30340;&#65292;&#22240;&#27492;&#19981;&#24314;&#35758;&#20351;&#29992;
gss&#65306;&#20351;&#29992;GSSAPI&#23545;&#29992;&#25143;&#36827;&#34892;&#36523;&#20221;&#39564;&#35777;&#65292;&#36825;&#20165;&#36866;&#29992;&#20110;TCP / IP&#36830;&#25509;&#12290;
sspi&#65306;&#20351;&#29992;SSPI&#23545;&#29992;&#25143;&#36827;&#34892;&#36523;&#20221;&#39564;&#35777;&#65292;&#36825;&#20165;&#36866;&#29992;&#20110;Windows&#12290;

ident&#65306;&#20801;&#35768;&#23458;&#25143;&#31471;&#19978;&#30340;&#29305;&#23450;&#25805;&#20316;&#31995;&#32479;&#29992;&#25143;&#36830;&#25509;&#21040;&#25968;&#25454;&#24211;&#12290;&#36825;&#31181;&#35748;&#35777;&#26041;&#24335;&#30340;&#20351;&#29992;
&#22330;&#26223;&#26159;&#65292;&#23458;&#25143;&#31471;&#26159;&#20027;&#26426;&#19978;&#30340;&#26576;&#20010;&#25805;&#20316;&#31995;&#32479;&#29992;&#25143;&#65292;&#24050;&#32463;&#36890;&#36807;&#20102;&#25805;&#20316;&#31995;&#32479;&#30340;&#36523;&#20221;&#35748;&#35777;&#65292;
&#26159;&#25968;&#25454;&#24211;&#26381;&#21153;&#22120;&#21487;&#20197;&#20449;&#20219;&#30340;&#29992;&#25143;&#65292;&#19981;&#38656;&#35201;&#22312;&#25968;&#25454;&#24211;&#23618;&#38754;&#20877;&#27425;&#26816;&#27979;&#36523;&#20221;&#12290;&#27604;&#22914;&#65292;&#22914;
<span style="color: #0000ff;">&#26524;&#37197;&#32622;&#20102;&#36825;&#31181;&#35748;&#35777;&#26041;&#24335;</span>(&#37197;&#32622;&#20013;&#20801;&#35768;&#30340;&#29992;&#25143;&#21517;&#20026;dba)&#12289;&#36825;&#26102;&#22312;&#25805;&#20316;&#31995;&#32479;&#29992;&#25143;dba&#19979;&#65292;
&#23601;&#33021;&#20197;&#25968;&#25454;&#24211;&#29992;&#25143;dba&#30340;&#36523;&#20221;&#36830;&#25509;&#21040;&#25968;&#25454;&#24211;&#12290;&#26381;&#21153;&#22120;&#20026;&#20102;&#30830;&#23450;&#25509;&#25910;&#21040;&#30340;&#36830;&#25509;&#35831;&#27714;
&#30830;&#23454;&#26159;&#23458;&#25143;&#31471;&#26426;&#22120;&#19978;&#30340;dba&#29992;&#25143;&#21457;&#36215;&#30340;&#65292;&#32780;&#19981;&#26159;&#36825;&#21488;&#26426;&#22120;&#19978;&#20854;&#20182;&#29992;&#25143;&#21457;&#36215;&#30340;&#20551;&#20882;
&#35831;&#27714;&#65292;&#20250;&#21521;&#23458;&#25143;&#31471;&#26426;&#22120;&#19978;&#30340;ident&#26381;&#21153;&#21457;&#36215;&#35831;&#27714;&#65292;&#35753;ident&#26381;&#21153;&#26597;&#30475;&#27492;TCP&#36830;&#25509;&#26159;
&#21542;&#26159;dba&#29992;&#25143;&#21457;&#36215;&#30340;&#65292;&#22914;&#26524;&#19981;&#26159;&#65292;&#35828;&#26126;&#26159;&#20551;&#20882;&#65292;&#21017;&#35748;&#35777;&#22833;&#36133;&#12290;&#22914;&#26524;&#23458;&#25143;&#31471;&#36890;&#36807;&#26412;
&#22320;&#36830;&#25509;&#21040;&#26381;&#21153;&#22120;&#65292;&#22240;&#20026;&#23458;&#25143;&#31471;&#19982;&#26381;&#21153;&#22120;&#22312;&#19968;&#21488;&#26426;&#22120;&#19978;&#65292;&#25968;&#25454;&#24211;&#26381;&#21153;&#22120;&#21487;&#20197;&#30452;&#25509;&#26816;
&#26597;&#23458;&#25143;&#31471;&#29992;&#25143;&#30340;&#25805;&#20316;&#31995;&#32479;&#29992;&#25143;&#36523;&#20221;&#65292;&#23601;&#19981;&#38656;&#35201;&#21521;ident&#26381;&#21153;&#21457;&#36865;&#35831;&#27714;&#36827;&#34892;&#21028;&#26029;&#20102;&#12290;

ldap&#65306;&#20351;&#29992;LDAP&#26381;&#21153;&#22120;&#36827;&#34892;&#36523;&#20221;&#39564;&#35777;&#12290;
radius&#65306;&#20351;&#29992;RADIUS&#26381;&#21153;&#22120;&#36827;&#34892;&#36523;&#20221;&#39564;&#35777;&#12290;
cert&#65306;&#20351;&#29992;SSL&#23458;&#25143;&#31471;&#35777;&#20070;&#36827;&#34892;&#36523;&#20221;&#39564;&#35777;&#12290;
pam&#65306;&#20351;&#29992;&#25805;&#20316;&#31995;&#32479;&#25552;&#20379;&#30340;&#21487;&#25554;&#20837;&#36523;&#20221;&#39564;&#35777;&#27169;&#22359;&#65288;PAM&#65289;&#26381;&#21153;&#36827;&#34892;&#36523;&#20221;&#39564;&#35777;&#12290;
bsd&#65306;&#20351;&#29992;&#25805;&#20316;&#31995;&#32479;&#25552;&#20379;&#30340;BSD&#36523;&#20221;&#39564;&#35777;&#26381;&#21153;&#36827;&#34892;&#36523;&#20221;&#39564;&#35777;&#12290;
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#19968;&#21488;&#26426;&#22120;&#21482;&#32473;&#25968;&#25454;&#24211;&#20351;&#29992;&#65292;&#32780;&#27809;&#26377;&#20854;&#20182;&#29992;&#36884;&#65292;&#21017;&#21487;&#20197;&#22312;pg_hba.conf&#20013;&#21152;&#19978;&#19979;&#38754;&#19968;&#34892;&#37197;&#32622;:
</span><span style="color: #483d8b;">local</span> all all trust
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35813;&#37197;&#32622;&#34920;&#31034;&#22312;&#36825;&#21488;&#26426;&#22120;&#19978;&#65292;&#20219;&#20309;&#25805;&#20316;&#31995;&#32479;&#30340;&#29992;&#25143;&#37117;&#21487;&#20197;&#20351;&#29992;&#20219;&#20309;&#25968;&#25454;&#24211;&#29992;&#25143;&#65288;&#21253;&#25324;&#25968;&#25454;&#24211;&#36229;&#32423;&#29992;&#25143;&#65289;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#21040;&#25968;&#25454;&#24211;&#32780;&#19981;&#38656;&#35201;&#20219;&#20309;&#23494;&#30721;&#12290;&#22240;&#20026;&#36825;&#21488;&#20027;&#26426;&#21482;&#20379;&#25968;&#25454;&#24211;&#20351;&#29992;&#65292;&#21487;&#20197;&#25226;&#19981;&#29992;&#30340;&#25805;&#20316;&#31995;&#32479;&#29992;&#25143;&#37117;&#31105;&#27490;&#25481;,&#20197;&#20445;&#35777;&#23433;&#20840;&#24615;&#12290;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#25968;&#25454;&#24211;&#20013;&#26377;&#19968;&#20010;&#29992;&#25143;&#8220;dba&#8221;&#65292;&#25805;&#20316;&#31995;&#32479;&#20013;&#20063;&#26377;&#19968;&#20010;&#29992;&#25143;&#8220;dba&#8221;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#25805;&#20316;&#31995;&#32479;"dba&#8221;&#29992;&#25143;&#19979;&#36830;&#25509;&#25968;&#25454;&#24211;&#19981;&#38656;&#35201;&#23494;&#30721;&#39564;&#35777;&#30340;&#35774;&#32622;&#26041;&#27861;:
</span><span style="color: #483d8b;">local</span> all dba ident

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#24819;&#22312;&#25968;&#25454;&#24211;&#20027;&#26426;&#19978;&#20351;&#29992;&#23494;&#30721;&#39564;&#35777;&#65292;&#21487;&#20197;&#20351;&#29992;&#19979;&#38754;&#30340;&#37197;&#32622;&#39033;:
</span><span style="color: #483d8b;">local</span> all all md5

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#24819;&#35753;&#20854;&#20182;&#20027;&#26426;&#30340;&#36830;&#25509;&#37117;&#20351;&#29992;md5&#23494;&#30721;&#39564;&#35777;&#65292;&#21017;&#20351;&#29992;&#22914;&#19979;&#37197;&#32622;:
</span>host all all 0.0.0.0/0 md5

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20801;&#35768;&#29992;&#25143;&#36890;&#36807;10.0.0.0/24&#30340;&#36828;&#31243;&#20027;&#26426;&#36827;&#34892;md5&#39564;&#35777;&#30331;&#24405;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">TYPE   DATABASE  USER   ADDRESS      METHOD
</span>host    all       all    10.0.0.0/24  md5

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20801;&#35768;&#29992;&#25143;wang&#36890;&#36807;&#20219;&#24847;&#36828;&#31243;&#20027;&#26426;&#36827;&#34892;md5&#39564;&#35777;&#30331;&#24405;test&#25968;&#25454;&#24211;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">TYPE   DATABASE  USER   ADDRESS      METHOD
</span>host    test       wang    0.0.0.0/0  md5
</pre>
</div>
</div>
</div>
<div id="outline-container-打开远程连接" class="outline-4">
<h4 id="打开远程连接">打开远程连接</h4>
<div class="outline-text-4" id="text-打开远程连接">
<p>
默认安装完的PG只监听1ocal。如果要远程连接，需要监听对外提供服务的IP地址。
</p>

<p>
范例: 实现远程连接
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#29992;&#25143;postgres&#23494;&#30721;
</span>[root@rocky8 ~]#psql
<span style="color: #a0522d;">postgres</span>=# ALTER USER postgres with password <span style="color: #8b2252;">'123456'</span>;
ALTER ROLE

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#30417;&#21548;&#22320;&#22336;&#21644;&#31471;&#21475;,&#40664;&#35748;&#20026;127.0.0.1:5432
</span>[root@rocky8 ~]#ss -ntl

[root@rocky8 ~]#vim /pgsql/data/postgresql.conf
<span style="color: #a0522d;">listen_addresses</span> = <span style="color: #8b2252;">'*'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#27492;&#34892;&#20013;&#30340;localhost&#20026; *
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">listen_addresses = '0.0.0.0' #&#25110;&#32773;&#20462;&#25913;&#20026;0.0.0.0
</span>
[root@rocky8 ~]#vim /pgsql/data/pg_hba.conf
host all all ::1/128 trust
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#38754;&#34892;&#30340;&#21518;&#38754;&#21152;&#19968;&#34892;
</span>host all all 0.0.0.0/0 md5

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;&#26381;&#21153;&#29983;&#25928;
</span>[postgres@rocky8 ~]$<span style="color: #a0522d;">pg_ctl</span> restart -mf

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#30417;&#21548;&#22320;&#22336;&#21644;&#31471;&#21475;
</span>[root@rocky8 ~]#ss -ntl

<span style="color: #b22222;">#</span><span style="color: #b22222;">psql
</span>Usage:
  psql [OPTION]... [DBNAME [USERNAME]]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;&#36828;&#31243;&#30331;&#24405;
</span>[root@rocky8 ~]#psql -d postgres -h PostgreSQL&#20027;&#26426;IP -p 5432 -U postgres

$ psql  -h 10.0.0.131 db1 postgres
Password for user postgres: 
<span style="color: #0000ff;">psql</span> (17.0)
Type <span style="color: #8b2252;">"help"</span> for help.

<span style="color: #a0522d;">db1</span>=# 
</pre>
</div>

<p>
范例: 利用.pgpass文件实现免密码连接远程posgresql
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@rocky8 ~]#vim .pgpass
<span style="color: #b22222;">#</span><span style="color: #b22222;">hostname:port:database:username:password
</span>10.0.0.200:5432:testdb:postgres:123456

[root@rocky8 ~]#chmod 600 .pgpass

[root@rocky8 ~]#ll .pgpass
-rw------- 1 root root 81 Dec 30 10:04 .pgpass

<span style="color: #b22222;">#</span><span style="color: #b22222;">psql&#40664;&#35748;&#36830;&#25509;&#26412;&#26426;&#65292;&#38656;&#35201;&#25351;&#23450;&#21644;.pgpass&#25991;&#20214;&#20869;&#23481;&#30456;&#21305;&#37197;&#20449;&#24687;&#25165;&#21487;&#20197;&#20351;&#29992;.pgpass&#25991;&#20214;&#36830;&#25509;
</span>[root@rocky8 ~]#psql -U postgres -h 10.0.0.200 -d testdb -w
<span style="color: #a0522d;">testdb</span>=# \c
You are now connected to database <span style="color: #8b2252;">"testdb"</span> as user <span style="color: #8b2252;">"postgres"</span>.
<span style="color: #a0522d;">testdb</span>=#
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-常用操作" class="outline-3">
<h3 id="常用操作">常用操作</h3>
<div class="outline-text-3" id="text-常用操作">
</div>
<div id="outline-container-h:20a0e6cf-1c7b-4644-a3c8-3bdd49945907" class="outline-4">
<h4 id="h:20a0e6cf-1c7b-4644-a3c8-3bdd49945907">查看psql帮助</h4>
<div class="outline-text-4" id="text-h:20a0e6cf-1c7b-4644-a3c8-3bdd49945907">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;psql&#24110;&#21161;&#29992;&#27861;
</span>help

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#20197;\&#24320;&#22836;&#30340;&#21629;&#20196;,&#21363;psql&#30340;&#21629;&#20196;
</span><span style="color: #8b2252;">\?</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;SQL&#21629;&#20196;&#30340;&#24110;&#21161;&#65292;&#27880;&#24847;&#65306;SQL&#35821;&#21477;&#24517;&#39035;&#20197; ; &#32467;&#26463;
</span>\h

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;SQL&#30340;&#24110;&#21161;
</span>\h create database
\help create user
</pre>
</div>

<p>
范例:
</p>
<ul class="org-ul">
<li><a href="https://www.postgresql.org/docs/17/sql-createuser.html">https://www.postgresql.org/docs/17/sql-createuser.html</a></li>
</ul>
</div>
</div>
<div id="outline-container-设置显示信息的格式" class="outline-4">
<h4 id="设置显示信息的格式">设置显示信息的格式</h4>
<div class="outline-text-4" id="text-设置显示信息的格式">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21518;&#32493;&#26597;&#35810;&#23558;&#22362;&#30528;&#26174;&#31034;,&#31867;&#20284;&#20110;MySQL&#20013;&#30340;\G
</span>\x

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#21629;&#20196;&#25191;&#34892;&#26102;&#38271;&#25552;&#31034;
</span>\timing on

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#35814;&#32454;&#30340;&#20449;&#24687;,&#21487;&#20197;&#25171;&#21360;&#20986;&#25253;&#20986;&#38382;&#39064;&#30340;&#28304;&#20195;&#30721;&#20301;&#32622;
</span>\set VERBOSITY verbose
</pre>
</div>

<p>
范例: 竖着显示
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">postgres</span>=# \x  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#31446;&#30528;&#26174;&#31034;
</span>Expanded display is on

<span style="color: #a0522d;">postgres</span>=# \l  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25968;&#25454;&#24211;&#20449;&#24687;&#12290;&#21487;&#20197;&#30475;&#21040;&#26159;&#31446;&#30528;&#26174;&#31034;&#30340;
</span><span style="color: #a0522d;">db1</span>=# \l
List of databases
-[ RECORD 1 ]-----+----------------------
Name              | db1
Owner             | postgres
Encoding          | UTF8
Locale Provider   | libc
Collate           | en_US.UTF-8
Ctype             | en_US.UTF-8
Locale            | 
ICU Rules         | 
Access privileges | 


<span style="color: #a0522d;">postgres</span>=# select pg_sleep(3);
pg_sleep
(1 row)
</pre>
</div>

<p>
范例：开启执行时长显示
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">testdb</span>=# \timing on
Timing is on.

<span style="color: #a0522d;">testdb</span>=# select pg_sleep(3);
Time: 3003.928 ms (00:03.004)

<span style="color: #a0522d;">testdb</span>=# \timing off
Timing is off.

<span style="color: #a0522d;">testdb</span>=# select pg_sleep(3);
<span style="color: #a0522d;">testdb</span>=#
</pre>
</div>

<p>
范例: 查看出错对应的源代码位置
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 ~]#su - postgres
postgres@ubuntu2004:~$ psql
<span style="color: #a0522d;">postgres</span>=# \set VERBOSITY verbose
<span style="color: #a0522d;">postgres</span>=# select wang;
ERROR: 42703: column <span style="color: #8b2252;">"wang"</span> does not exist LINE 1: select wang;
LOCATION: errorMissingColumn, parse_relation.c:3349
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35828;&#26126;:&#38169;&#35823;&#23545;&#24212;&#30340;&#26159;parse_relation.c&#25991;&#20214;&#20013;&#30340;3349&#34892;&#20013;errorMissingColumn&#20989;&#25968;
</span>
[root@ubuntu2004 ~]#find -name parse_relation.c
./postgresql-12.9/src/backend/parser/parse_relation.c

[root@ubuntu2004 ~]#vim +3349 <span style="color: #ff00ff;">`find -name parse_relation.c`</span>

<span style="color: #0000ff;">errorMissingColumn</span>(ParseState *pstate,
                   const char *relname, const char *colname, int location)

{

    FuzzyAttrMatchState *state; 
    char *<span style="color: #a0522d;">closestfirst</span> = NULL;

    <span style="color: #a0522d;">state</span> = searchRangeTableForCol(pstate, relname, colname, location);

    <span style="color: #a020f0;">if</span> (state-&gt;rfirst &amp;&amp; AttributeNumberIsValid(state-&gt;first)) 
        <span style="color: #a0522d;">closestfirst</span> = strVal(list_nth(state-&gt;rfirst-&gt;eref-&gt;colnames,
                                      state-&gt;first - 1));
    <span style="color: #a020f0;">if</span> (!state-&gt;rsecond)

</pre>
</div>
</div>
</div>
<div id="outline-container-数据库的创建和删除" class="outline-4">
<h4 id="数据库的创建和删除">数据库的创建和删除</h4>
<div class="outline-text-4" id="text-数据库的创建和删除">
<p>
创建数据库可以使用SQL语句create database 实现,也可以利用createdb命令创建数据库
</p>

<p>
createdb 是一个 SQL 命令 CREATE DATABASE 的封装。
</p>

<p>
createdb 命令语法格式如下：
</p>

<div class="org-src-container">
<pre class="src src-sh">createdb [option...] [dbname [description]]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#25968;&#35828;&#26126;&#65306;
</span>options&#65306;&#21442;&#25968;&#21487;&#36873;&#39033;&#65292;&#21487;&#20197;&#26159;&#20197;&#19979;&#20540;&#65306;
-D tablespace&#25351;&#23450;&#25968;&#25454;&#24211;&#40664;&#35748;&#34920;&#31354;&#38388;&#12290;
-e &#23558;createdb &#29983;&#25104;&#30340;&#21629;&#20196;&#21457;&#36865;&#21040;&#26381;&#21153;&#31471;&#12290;
-E encoding&#25351;&#23450;&#25968;&#25454;&#24211;&#30340;&#32534;&#30721;&#12290;
-l locale&#25351;&#23450;&#25968;&#25454;&#24211;&#30340;&#35821;&#35328;&#29615;&#22659;&#12290;
-T template&#25351;&#23450;&#21019;&#24314;&#27492;&#25968;&#25454;&#24211;&#30340;&#27169;&#26495;&#12290;
--help&#26174;&#31034; createdb &#21629;&#20196;&#30340;&#24110;&#21161;&#20449;&#24687;&#12290;
-h host&#25351;&#23450;&#26381;&#21153;&#22120;&#30340;&#20027;&#26426;&#21517;&#12290;
-p port&#25351;&#23450;&#26381;&#21153;&#22120;&#30417;&#21548;&#30340;&#31471;&#21475;&#65292;&#25110;&#32773; socket &#25991;&#20214;&#12290;
-U username&#36830;&#25509;&#25968;&#25454;&#24211;&#30340;&#29992;&#25143;&#21517;&#12290;
-w&#24573;&#30053;&#36755;&#20837;&#23494;&#30721;&#12290;
-W&#36830;&#25509;&#26102;&#24378;&#21046;&#35201;&#27714;&#36755;&#20837;&#23494;&#30721;

dbname&#65306;&#35201;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#12290;
description&#65306;&#20851;&#20110;&#26032;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#30456;&#20851;&#30340;&#35828;&#26126;&#12290;
</pre>
</div>

<p>
删除数据库可以使用SQL语句drop database实现
</p>

<p>
范例: 创建数据库
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1
</span>[root@ubuntu2004 ~]#createdb -h 10.0.0.200 -p 5432 -U postgres testdb
Password:

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2
</span>postgres@ubuntu2004:~$ psql
<span style="color: #a0522d;">postgres</span>=# create database testdb;
</pre>
</div>

<p>
范例: 删除数据库
</p>

<div class="org-src-container">
<pre class="src src-sh">postgres@ubuntu2004:~$ psql
<span style="color: #a0522d;">postgres</span>=# drop database testdb; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#30528;&#36825;&#20010;&#24211;&#26102;&#26080;&#27861;&#21024;&#38500;&#65292;&#20808;&#20999;&#21040;&#21035;&#30340;&#24211;&#20877;&#21024;&#38500;</span>
</pre>
</div>

<p>
范例: 查看数据库存放目录的路径
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">postgres</span>=# select oid,datname from pg_database;
  oid  |  datname  
-------+-----------
     5 | postgres
 24580 | db1
     1 | template1
     4 | template0
 24587 | db2
(5 rows)

postgres@debian:~$ ls /pgsql/data/base/
1  24580  24587  4  5
</pre>
</div>
</div>
</div>
<div id="outline-container-管理和查看模式" class="outline-4">
<h4 id="管理和查看模式">管理和查看模式</h4>
<div class="outline-text-4" id="text-管理和查看模式">
<p>
一个数据库包含一个或多个已命名的模式，模式又包含表。模式还可以包含其它
对象，包括数据类型、函数、操作符等。同一个对象名可以在不同的模式里使用
而不会导致冲突；比如，schema1和schema2都可以包含一个名为test的表
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#27169;&#24335;
</span>create schema schema_name;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#27169;&#24335;
</span>drop schema schema_name;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;schema
</span><span style="color: #a0522d;">postgres</span>=# \dn
</pre>
</div>

<p>
范例
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">postgres</span>=# \c db1
You are now connected to database <span style="color: #8b2252;">"db1"</span> as user <span style="color: #8b2252;">"postgres"</span>.

<span style="color: #a0522d;">db1</span>=# create schema m48_sch;
CREATE SCHEMA
<span style="color: #a0522d;">db1</span>=# create schema m47_sch;
CREATE SCHEMA
<span style="color: #a0522d;">db1</span>=# \dn
 m47_sch | postgres
 m48_sch | postgres
 public  | pg_database_owner

<span style="color: #a0522d;">db1</span>=# create table m48_sch.t1(id int);
CREATE TABLE
<span style="color: #a0522d;">db1</span>=# create table m47_sch.t1(id int);
CREATE TABLE
<span style="color: #a0522d;">db1</span>=# \dt
 public | t1   | table | postgres
 public | t2   | table | postgres

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;
</span><span style="color: #a0522d;">db1</span>=# \dt m48_sch.t1
 m48_sch | t1   | table | postgres

<span style="color: #a0522d;">db1</span>=# \dt m48_sch.*
 m48_sch | t1   | table | postgres

<span style="color: #a0522d;">db1</span>=# \dt m47_sch.*
 m47_sch | t1   | table | postgres
</pre>
</div>
</div>
</div>
<div id="outline-container-查看和连接数据库" class="outline-4">
<h4 id="查看和连接数据库">查看和连接数据库</h4>
<div class="outline-text-4" id="text-查看和连接数据库">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;&#25968;&#25454;&#24211;&#21517;,&#30456;&#24403;&#20110;MySQL&#20013;&#30340;show databases;
</span><span style="color: #a0522d;">postgres</span>=# \l

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#25968;&#25454;&#24211;&#35814;&#32454;&#20449;&#24687;,&#27604;&#22914;&#22823;&#23567;
</span>testdb-# \l+


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#36830;&#25509;&#20449;&#24687;
</span><span style="color: #a0522d;">postgres</span>=# \c
You are now connected to database <span style="color: #8b2252;">"postgres"</span> as user <span style="color: #8b2252;">"postgres"</span>.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#36830;&#25509;&#35814;&#32454;&#20449;&#24687;
</span><span style="color: #a0522d;">postgres</span>=# \conninfo
You are connected to database <span style="color: #8b2252;">"postgres"</span> as user <span style="color: #8b2252;">"postgres"</span> via socket<span style="color: #a020f0;"> in</span> <span style="color: #8b2252;">"/tmp"</span> at port <span style="color: #8b2252;">"5432"</span>.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#25968;&#25454;&#24211;,&#30456;&#24403;&#20110;use
</span><span style="color: #a0522d;">postgres</span>=# \c hellodb
You are now connected to database <span style="color: #8b2252;">"hellodb"</span> as user <span style="color: #8b2252;">"postgres"</span>.
<span style="color: #a0522d;">hellodb</span>=#
</pre>
</div>
</div>
</div>
<div id="outline-container-管理表" class="outline-4">
<h4 id="管理表">管理表</h4>
<div class="outline-text-4" id="text-管理表">
<p>
PostgreSQL 支持多种数据类型实现表结构的创建范例: 查看支持数据类型
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">postgres</span>=# select typname from pg_type;

typname
--------------
bool
bytea
char
name
int8
int2
int2vector
int4
regproc
text
oid
tid
xid
cid
oidvector
pg_type
pg_attribute
pg_proc
pg_class
json
xml
</pre>
</div>

<p>
范例: 管理表
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">postgres</span>=# \c testdb
<span style="color: #a0522d;">testdb</span>=# create table tb1 (id serial primary key,name text);
CREATE TABLE

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;9&#27425;&#38543;&#26426;&#25968;&#25554;&#20837;&#21040;name&#20013;
</span><span style="color: #a0522d;">testdb</span>=# insert into tb1 (name) <span style="color: #a020f0;">select</span> (md5(random()::text)) from generate_series (2,10);
INSERT 0 9
Time: 0.816 ms

<span style="color: #a0522d;">testdb</span>=# select * from tb1;
 id |               name               
----+----------------------------------
  1 | b57de43d05a691dac86ae85b9191583e
  2 | 2543f7146cfa18cfb3d5842dcd6a4304
  3 | da0ea56dc318ce616f00b8750210cdec
  4 | 7185258c81c16cca69591c7aaae11df4
  5 | e49acadbce73bf718da4f037c45aee3b
  6 | 3ffeac879d5e22202806b3c3354fb47c
  7 | d8f1526f8f7bb636e2339729764af096
  8 | cd2a34be663b47b0751d467df0f3128d
  9 | b85b403e135688aca61b5f770e3c0562


<span style="color: #b22222;">#</span><span style="color: #b22222;">PostgreSQL&#20013;&#25554;&#20837;100&#19975;&#26465;&#35760;&#24405;&#21482;&#38656;&#35201;&#33457;2s
</span><span style="color: #a0522d;">testdb</span>=# \timing on
<span style="color: #a0522d;">testdb</span>=# insert into tb1 (name) <span style="color: #a020f0;">select</span> (md5(random()::text)) from generate_series (1,1000000);
INSERT 0 1000000
Time: 2111.662 ms (00:02.112)
<span style="color: #a0522d;">testdb</span>=# select count(*) from tb1;
  count  
---------
 1000000
(1 row)


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;&#34920;&#32467;&#26500;&#65292;&#19981;&#22797;&#21046;&#25968;&#25454;
</span><span style="color: #a0522d;">testdb</span>=# create table tb2 ( like tb1 );
CREATE TABLE
<span style="color: #a0522d;">testdb</span>=# \d tb2
<span style="color: #a0522d;">testdb</span>=# select * from tb2;
<span style="color: #a0522d;">testdb</span>=# drop table tb2;
</pre>
</div>
</div>
</div>
<div id="outline-container-查看表和表信息" class="outline-4">
<h4 id="查看表和表信息">查看表和表信息</h4>
<div class="outline-text-4" id="text-查看表和表信息">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;&#34920;,&#35270;&#22270;,&#24207;&#21015;
</span>\d

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;public&#30340;schema&#20013;&#25152;&#26377;&#30340;&#34920;&#21517;,&#30456;&#24403;&#20110;show tables;
</span>\dt

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;t1&#30340;&#34920;&#20449;&#24687;
</span>\dt t1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25903;&#25345;&#36890;&#37197;&#31526;*&#21644;&#65311;&#65292;&#20197;&#19979;&#26174;&#31034;&#25152;&#26377;t&#24320;&#22836;&#30340;&#34920;
</span>\dt t*

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;myschema&#27169;&#24335;&#30340;&#34920;&#32467;&#26500;
</span>\dt myschema.*

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;t1&#30340;&#34920;&#32467;&#26500;,&#30456;&#24403;&#20110;desc
</span>\d t1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;&#34920;&#20449;&#24687;,&#21253;&#25324;&#22823;&#23567;
</span>hellodb-# \dt+

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#34920;&#20449;&#24687;
</span><span style="color: #a0522d;">hellodb</span>=# \dt students

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#34920;&#20449;&#24687;&#30340;&#22823;&#23567;&#20449;&#24687;
</span><span style="color: #a0522d;">hellodb</span>=# \dt+ students


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25152;&#26377;&#34920;
</span><span style="color: #a0522d;">postgres</span>=# select * from pg_tables;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#31995;&#32479;&#34920;
</span><span style="color: #a0522d;">db1</span>=# \dt  pg_catalog.*


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#34920;&#22823;&#23567;
</span><span style="color: #a0522d;">testdb</span>=# select pg_total_relation_size(<span style="color: #8b2252;">'tb1'</span>);

<span style="color: #a0522d;">testdb</span>=# select pg_total_relation_size(<span style="color: #8b2252;">'tb1'</span>)/1024/1024||<span style="color: #8b2252;">'MB'</span>;
</pre>
</div>

<p>
范例： 查看表对应的文件径
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">db1</span>=# select oid,datname from pg_database where <span style="color: #a0522d;">datname</span> = <span style="color: #8b2252;">'db1'</span>;
16385

<span style="color: #a0522d;">db1</span>=# select relid from pg_stat_all_tables where <span style="color: #a0522d;">relname</span>=<span style="color: #8b2252;">'tb2'</span>;
16413

[root@ubuntu2004 ~]#ll /pgsql/data/base/16385/16413
-rw------- 1 postgres postgres 0 Feb 14 07:21 /pgsql/data/base/16385/16413
</pre>
</div>

<p>
范例: 查看当前库中的所有表的统计信息
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">postgres</span>=# select * from pg_stat_all_tables;
<span style="color: #a0522d;">postgres</span>=# \c testdb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#34920;t1&#30340;&#20449;&#24687;
</span><span style="color: #a0522d;">testdb</span>=# select * from pg_stat_all_tables where <span style="color: #a0522d;">relname</span>=<span style="color: #8b2252;">'t1'</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-系统表system-catalogs" class="outline-4">
<h4 id="系统表system-catalogs">系统表(system catalogs)</h4>
<div class="outline-text-4" id="text-系统表system-catalogs">
<p>
官方文档
</p>
<ul class="org-ul">
<li><a href="https://www.postgresql.org/docs/current/catalogs.html">https://www.postgresql.org/docs/current/catalogs.html</a></li>
<li><a href="http://www.postgres.cn/docs/12/catalogs.html">http://www.postgres.cn/docs/12/catalogs.html</a></li>
</ul>

<p>
<b>系统表的定义</b>
</p>

<p>
系统表也称为系统目录(system catalogs),是关系型数据库存放模式元数据的地
方，比如表和列的信息，以及内部统计信息等。PostgreSQL的系统表也就是普通
表。虽然可以删除并重建这些表、增加列、插入和更新数值，但会导致系统损坏。
通常情况下，不应该手工修改系统目录，通过相关SQL命令去实现。例如:当执行
CREATE DATABASE 时会向系统表pg_database中插入一行记录,并且实际上在磁盘
上创建该数据库。
</p>

<p>
系统表包括存放系统信息的普通表或者视图,系统视图建立在系统表之上
</p>

<p>
<b>系统表的创建</b>
</p>

<p>
pg的每一个数据库中都有一套自己的系统表，其中大多数系统表都是在数据库创建时从模板数据库中拷贝过来的
</p>

<p>
<b>系统表的维护</b>
</p>

<p>
系统表中的信息由相的SQL命令关联至系统表自动维护
</p>

<p>
<b>系统表的存储方式</b>
</p>

<p>
和数据库相关的系统表保存在$PGDATA/base目录下相应数据库的文件夹下,文件
夹命名为pg_database里记录的数据库oid(Object identifiers),系统表都有一
个列名为对象标识符oid,用于标识postgres里各个对象,如表、序列、索引等,以
前版本是隐藏的
</p>

<p>
所有数据库共享的系统表，如pg_database，保存在$PGDATA/global下
</p>

<p>
范例: 查看系统表
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#31995;&#32479;&#34920;
</span><span style="color: #a0522d;">postgres</span>=# \dS
<span style="color: #a0522d;">postgres</span>=# \dS+

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;pg&#24320;&#22836;&#30340;&#31995;&#32479;&#34920;
</span><span style="color: #a0522d;">postgres</span>=# \dt pg_*

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;pg&#24320;&#22836;&#30340;&#31995;&#32479;&#35270;&#22270;
</span><span style="color: #a0522d;">postgres</span>=# \dv pg_*

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#31995;&#32479;&#34920;pg_database&#30340;&#32467;&#26500;
</span><span style="color: #a0522d;">postgres</span>=# \d pg_database
               Table <span style="color: #8b2252;">"pg_catalog.pg_database"</span>
     Column     |   Type    | Collation | Nullable | Default 
----------------+-----------+-----------+----------+---------
 oid            | oid       |           | not null | 
 datname        | name      |           | not null | 
 datdba         | oid       |           | not null | 
 encoding       | <span style="color: #483d8b;">integer</span>   |           | not null | 
 datlocprovider | <span style="color: #8b2252;">"char"</span>    |           | not null | 
 datistemplate  | boolean   |           | not null | 
 datallowconn   | boolean   |           | not null | 
 dathasloginevt | boolean   |           | not null | 
 datconnlimit   | <span style="color: #483d8b;">integer</span>   |           | not null | 
 datfrozenxid   | xid       |           | not null | 
 datminmxid     | xid       |           | not null | 
 dattablespace  | oid       |           | not null | 
 datcollate     | text      | C         | not null | 
 datctype       | text      | C         | not null | 
 datlocale      | text      | C         |          | 
 daticurules    | text      | C         |          | 
 datcollversion | text      | C         |          | 
 datacl         | aclitem[] |           |          | 

<span style="color: #a0522d;">postgres</span>=# \d pg_tables;
              View <span style="color: #8b2252;">"pg_catalog.pg_tables"</span>
   Column    |  Type   | Collation | Nullable | Default 
-------------+---------+-----------+----------+---------
 schemaname  | name    |           |          | 
 tablename   | name    |           |          | 
 tableowner  | name    |           |          | 
 tablespace  | name    |           |          | 
 hasindexes  | boolean |           |          | 
 hasrules    | boolean |           |          | 
 hastriggers | boolean |           |          | 
 rowsecurity | boolean |           |          | 
</pre>
</div>

<p>
范例: 查看指定表对应的文件
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">testdb</span>=# select * from pg_relation_filepath(<span style="color: #8b2252;">'t1'</span>);  <span style="color: #b22222;">#</span><span style="color: #b22222;">pg_relation_filepath&#31995;&#32479;&#20989;&#25968;
</span>pg_relation_filepath
base/16408/16409

[root@ubuntu2004 ~]#ll /pgsql/data/base/16408/16409
-rw------- 1 postgres postgres 76562432 Jan 16 03:44 /pgsql/data/base/16408/16409
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cc94eea9-20f5-468a-998c-6829a325f96f" class="outline-4">
<h4 id="h:cc94eea9-20f5-468a-998c-6829a325f96f">表的CRUD</h4>
<div class="outline-text-4" id="text-h:cc94eea9-20f5-468a-998c-6829a325f96f">
<p>
SQL的CRUD，即 Insert,update,delete,select 四条语句范例:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">db1</span>=# create database testdb;
<span style="color: #a0522d;">db1</span>=# \c testdb

<span style="color: #a0522d;">testdb</span>=# create table tb1 (id serial,name varchar(10));
CREATE TABLE

<span style="color: #a0522d;">testdb</span>=# \d tb1;
                                   Table <span style="color: #8b2252;">"public.tb1"</span>
 Column |         Type          | Collation | Nullable |             Default             
--------+-----------------------+-----------+----------+---------------------------------
 id     | <span style="color: #483d8b;">integer</span>               |           | not null | nextval(<span style="color: #8b2252;">'tb1_id_seq'</span>::regclass)
 name   | character varying(10) |           |          | 

<span style="color: #a0522d;">testdb</span>=# insert into tb1 (name)values(<span style="color: #8b2252;">'wang'</span>);
INSERT 0 1
<span style="color: #a0522d;">testdb</span>=# insert into tb1 (name)values(<span style="color: #8b2252;">'li'</span>);
INSERT 0 1
<span style="color: #a0522d;">testdb</span>=# select * from tb1;

<span style="color: #a0522d;">testdb</span>=# update tb1 set <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'zhao'</span> where <span style="color: #a0522d;">id</span>=2;
UPDATE 1
<span style="color: #a0522d;">testdb</span>=# select * from tb1;

<span style="color: #a0522d;">testdb</span>=# delete from tb1 where <span style="color: #a0522d;">id</span>=2;
DELETE 1
<span style="color: #a0522d;">testdb</span>=# select * from tb1; 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#31354;&#34920;
</span><span style="color: #a0522d;">testdb</span>=# truncate tb1;
<span style="color: #a0522d;">testdb</span>=# truncate table tb1;
TRUNCATE TABLE
<span style="color: #a0522d;">testdb</span>=# select * from tb1;
</pre>
</div>

<p>
范例: 查看表的列信息及大小
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">hellodb</span>=# \d students;
<span style="color: #a0522d;">hellodb</span>=# select pg_column_size(name),name from students;
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">testdb</span>=# select generate_series(3,6);
3
4
5
6

<span style="color: #a0522d;">testdb</span>=#
</pre>
</div>
</div>
</div>
<div id="outline-container-索引管理" class="outline-4">
<h4 id="索引管理">索引管理</h4>
<div class="outline-text-4" id="text-索引管理">
<p>
范例：创建和删除索引
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">testdb</span>=# create table tb1(id int,info text,crt_time timestamp);
CREATE TABLE

<span style="color: #a0522d;">testdb</span>=# insert into tb1 select generate_series(1,100000),md5(random()::text),clock_timestamp();
INSERT 0 100000

<span style="color: #a0522d;">testdb</span>=# select * from tb1 limit 3;
1 | 4d801e211aca0b2787ecbd489eb91460 | 2020-03-18 03:06:55.279125
2 | c798c226fcf884c0d892de5f6bed0355 | 2020-03-18 03:06:55.279367
3 | 268445645ff62f6c7cbbad98a74704b8 | 2020-03-18 03:06:55.279369

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#32034;&#24341;
</span><span style="color: #a0522d;">testdb</span>=# create index idx_tb1_id on tb1(id); <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32034;&#24341;&#21517;&#65292; idx_&#34920;&#21517;_&#21015;&#21517;
</span>CREATE INDEX
<span style="color: #a0522d;">testdb</span>=# \d tb1
                           Table <span style="color: #8b2252;">"public.tb1"</span>
  Column  |            Type             | Collation | Nullable | Default 
----------+-----------------------------+-----------+----------+---------
 id       | <span style="color: #483d8b;">integer</span>                     |           |          | 
 info     | text                        |           |          | 
 crt_time | timestamp without time zone |           |          | 
Indexes:
    <span style="color: #8b2252;">"idx_tb1_id"</span> btree (id)


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#32034;&#24341;
</span><span style="color: #a0522d;">testdb</span>=# drop index idx_tb1_id ;
DROP INDEX
<span style="color: #a0522d;">testdb</span>=# \d tb1
<span style="color: #a0522d;">testdb</span>=#
</pre>
</div>

<p>
范例: 使用索引
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25171;&#24320;&#26102;&#38388;
</span><span style="color: #a0522d;">testdb</span>=#\timing on

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#26465;&#20214;&#26159;&#32034;&#24341;&#21015;
</span><span style="color: #a0522d;">testdb</span>=# explain analyze select * from tb1 where <span style="color: #a0522d;">id</span> = 99999;
                                                   QUERY PLAN                                                    
-----------------------------------------------------------------------------------------------------------------
 Index Scan using idx_tb1_id on tb1  (<span style="color: #a0522d;">cost</span>=0.29..8.31 <span style="color: #a0522d;">rows</span>=1 <span style="color: #a0522d;">width</span>=45) (actual <span style="color: #a0522d;">time</span>=0.112..0.114 <span style="color: #a0522d;">rows</span>=1 <span style="color: #a0522d;">loops</span>=1) <span style="color: #b22222;">#</span><span style="color: #b22222;">Index Scan &#32034;&#24341;&#26597;&#35810;
</span>   Index Cond: (<span style="color: #a0522d;">id</span> = 99999)
 Planning Time: 0.473 ms
 Execution Time: 0.136 ms


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#26465;&#20214;&#19981;&#26159;&#32034;&#24341;&#21015;
</span><span style="color: #a0522d;">testdb</span>=# explain analyze select * from tb1 where <span style="color: #a0522d;">info</span> =<span style="color: #8b2252;">'f522a254fa2314150c574160bf1e7139'</span>;
                                            QUERY PLAN                                            
--------------------------------------------------------------------------------------------------
 Seq Scan on tb1  (<span style="color: #a0522d;">cost</span>=0.00..2185.00 <span style="color: #a0522d;">rows</span>=1 <span style="color: #a0522d;">width</span>=45) (actual <span style="color: #a0522d;">time</span>=0.014..12.195 <span style="color: #a0522d;">rows</span>=1 <span style="color: #a0522d;">loops</span>=1) <span style="color: #b22222;">#</span><span style="color: #b22222;">Seq Scan &#19981;&#26159;&#32034;&#24341;
</span>   Filter: (<span style="color: #a0522d;">info</span> = <span style="color: #8b2252;">'f522a254fa2314150c574160bf1e7139'</span>::text)
   Rows Removed by Filter: 99999
 Planning Time: 0.052 ms
 Execution Time: 12.211 ms
(5 rows)


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#38381;&#32034;&#24341;
</span><span style="color: #a0522d;">testdb</span>=# set <span style="color: #a0522d;">enable_indexscan</span>=off;
<span style="color: #a0522d;">testdb</span>=# set <span style="color: #a0522d;">enable_bitmapscan</span>=off;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20877;&#27425;&#26597;&#35810;&#20840;&#34920;&#25195;&#25551;
</span><span style="color: #a0522d;">testdb</span>=# explain analyze select * from tb1 where <span style="color: #a0522d;">id</span> = 99999;
<span style="color: #a0522d;">testdb</span>=# explain (analyze,verbose,costs,buffers,timing) <span style="color: #a020f0;">select</span> * from tb1 where <span style="color: #a0522d;">id</span> = 99999;
</pre>
</div>
</div>
</div>
<div id="outline-container-表空间" class="outline-4">
<h4 id="表空间">表空间</h4>
<div class="outline-text-4" id="text-表空间">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;&#34920;&#31354;&#38388;,&#23454;&#38469;&#19978;PostgresQL&#20013;&#30340;&#34920;&#31354;&#38388;&#23601;&#26159;&#23545;&#24212;&#19968;&#20010;&#30446;&#24405;&#65292;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25918;&#22312;&#36825;&#20010;&#34920;&#31354;&#38388;&#30340;&#34920;&#65292;&#23601;&#26159;&#25226;&#34920;&#30340;&#25968;&#25454;&#25991;&#20214;&#25918;&#21040;&#36825;&#20010;&#34920;&#31354;&#38388;&#19979;&#12290;
</span><span style="color: #a0522d;">postgres</span>=# \db
       List of tablespaces
    Name    |  Owner   | Location 
------------+----------+----------
 pg_default | postgres | 
 pg_global  | postgres | 
(2 rows)
<span style="color: #a0522d;">testdb</span>=# \db+  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#34920;&#31354;&#38388;&#30340;&#22823;&#23567;
</span>                                  List of tablespaces
    Name    |  Owner   | Location | Access privileges | Options |  Size  | Description 
------------+----------+----------+-------------------+---------+--------+-------------
 pg_default | postgres |          |                   |         | 138 MB | 
 pg_global  | postgres |          |                   |         | 565 kB | 
(2 rows)


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;&#34920;&#21040;&#25991;&#20214;&#20013;
</span><span style="color: #a0522d;">testdb</span>=# select * from t1;
<span style="color: #a0522d;">testdb</span>=# copy t1 to <span style="color: #8b2252;">'/tmp/t1.txt'</span>;
COPY 2

[root@ubuntu2004 ~]#cat /tmp/t1.txt
1
2
</pre>
</div>

<p>
范例：表空间pg_tblspc目录
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 ~]#su - postgres
postgres@ubuntu2004:~$ mkdir ts1

postgres@ubuntu2004:~$ psql testdb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#34920;&#31354;&#38388;
</span><span style="color: #a0522d;">postgres</span>=# create tablespace ts1 location <span style="color: #8b2252;">'/home/postgres/ts1/'</span>;
CREATE TABLESPACE

<span style="color: #a0522d;">postgres</span>=# \db
            List of tablespaces
    Name    |  Owner   |      Location      
------------+----------+--------------------
 pg_default | postgres | 
 pg_global  | postgres | 
 ts1        | postgres | /home/postgres/ts1
(3 rows)

postgres@ubuntu2004:~$ readlink /pgsql/data/pg_tblspc/16442
/home/postgres/ts1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#34920;&#31354;&#38388;&#65292;&#25552;&#21069;&#28165;&#31354;&#34920;&#31354;&#38388;&#20013;&#30340;&#34920;
</span><span style="color: #a0522d;">testdb</span>=# drop tablespace ts1;
DROP TABLESPACE
</pre>
</div>

<p>
范例: 查看表空间对应的文件
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 ~]#ls /pgsql/data/pg_tblspc
[root@ubuntu2004 ~]#su -postgres
postgres@ubuntu2004:~$ mkdir /tmp/tbs1

postgres@ubuntu2004:~$ psql
<span style="color: #a0522d;">testdb</span>=# create tablespace tbs1 location <span style="color: #8b2252;">'/tmp/tbs1'</span> ;
<span style="color: #a0522d;">testdb</span>=# create table tb1(id int) tablespace tbs1;
<span style="color: #a0522d;">testdb</span>=# select * from pg_relation_filepath(<span style="color: #8b2252;">'tb1'</span>);


postgres@ubuntu2004:~$ tree /pgsql/data/pg_tblspc/
postgres@ubuntu2004:~$ tree /tmp/tbs1/
</pre>
</div>
</div>
</div>
<div id="outline-container-查看系统信息" class="outline-4">
<h4 id="查看系统信息">查看系统信息</h4>
<div class="outline-text-4" id="text-查看系统信息">
<p>
可以通过系统函数查看系统信息,也可以通过show/set 查看和修改配置
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#29256;&#26412;&#20449;&#24687;
</span><span style="color: #a0522d;">postgres</span>=# select version();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25968;&#25454;&#24211;&#21551;&#21160;&#26102;&#38388;
</span><span style="color: #a0522d;">postgres</span>=# select pg_postmaster_start_time();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#21152;&#36733;&#37197;&#32622;&#25991;&#20214;&#26102;&#38388;
</span>postgres@ubuntu2004:~$ pg_ctl reload
<span style="color: #a0522d;">postgres</span>=# select pg_conf_load_time();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26102;&#21306;&#21644;&#26102;&#38388;
</span><span style="color: #a0522d;">postgres</span>=# show timezone;
<span style="color: #0000ff;">Etc/UTC</span> (1 row)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20020;&#26102;&#20462;&#25913;
</span><span style="color: #a0522d;">postgres</span>=# set <span style="color: #a0522d;">timezone</span>=<span style="color: #8b2252;">'Asia/Shanghai'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27704;&#20037;&#20462;&#25913;&#26102;&#21306;
</span>postgres@ubuntu2004:~$ vim /pgsql/data/postgresql.conf
<span style="color: #a0522d;">timezone</span> = <span style="color: #8b2252;">'Asia/Shanghai'</span>

postgres@ubuntu2004:~$ pg_ctl reload
<span style="color: #a0522d;">postgres</span>=# select now();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#29992;&#25143;
</span><span style="color: #a0522d;">postgres</span>=# select user;
<span style="color: #a0522d;">postgres</span>=# select current_user;
<span style="color: #a0522d;">postgres</span>=# select session_user;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#25968;&#25454;&#24211;
</span><span style="color: #a0522d;">postgres</span>=# \c
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#25968;&#25454;&#24211;
</span><span style="color: #a0522d;">postgres</span>=# \c testdb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;session&#25152;&#22312;&#30340;&#23458;&#25143;&#31471;IP&#21644;&#31471;&#21475;
</span>[root@rocky8 ~]#psql -h 10.0.0.200 -U postgres
<span style="color: #a0522d;">postgres</span>=# select inet_client_addr(),inet_client_port();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;session&#25152;&#36830;&#25509;&#30340;&#25968;&#25454;&#24211;&#26381;&#21153;&#22120;&#30340;IP&#21644;&#31471;&#21475;
</span><span style="color: #a0522d;">postgres</span>=# select inet_server_addr(),inet_server_port();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#24403;&#21069;session&#23545;&#24212;&#30340;&#21518;&#21488;&#26381;&#21153;&#26102;&#31243;pid
</span><span style="color: #a0522d;">postgres</span>=# select pg_backend_pid();

ps auxf |grep postgres

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#20869;&#32622;&#21464;&#37327;
</span><span style="color: #a0522d;">postgres</span>=&gt; \set

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#25351;&#23450;&#37197;&#32622;
</span><span style="color: #a0522d;">postgres</span>=# show max_connections;
<span style="color: #a0522d;">postgres</span>=# select current_setting(<span style="color: #8b2252;">'max_connections'</span>);
<span style="color: #a0522d;">postgres</span>=# select current_setting(<span style="color: #8b2252;">'listen_addresses'</span>);

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#31995;&#32479;&#20989;&#25968;
</span><span style="color: #a0522d;">postgres</span>=# \dfS+

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#36830;&#25509;&#25968;
</span><span style="color: #a0522d;">postgres</span>=# select count(*) from pg_stat_activity;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#26368;&#22823;&#30340;&#36830;&#25509;&#25968;
</span><span style="color: #a0522d;">postgres</span>=# select setting from pg_settings where <span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">'max_connections'</span>;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25152;&#26377;&#35774;&#32622;&#21517;&#31216;
</span><span style="color: #a0522d;">postgres</span>=# select name from pg_settings;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#35774;&#32622;&#21517;&#21644;&#20540;
</span><span style="color: #a0522d;">postgres</span>=# select name,setting from pg_settings;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#30340;&#24403;&#21069;&#30340;&#21442;&#25968;&#35774;&#32622;
</span><span style="color: #a0522d;">postgres</span>=# show port;
<span style="color: #a0522d;">postgres</span>=# show archive_mode;
 archive_mode 
--------------
 off

</pre>
</div>


<p>
范例: show 和 set 查看和修改配置
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#21442;&#25968;
</span>SHOW name;
SHOW ALL;

<span style="color: #a0522d;">postgres</span>=# show all;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;
</span>SET [ SESSION | LOCAL ] configuration_parameter { TO | = } { value |<span style="color: #8b2252;">'value'</span> | DEFAULT }
SET [ SESSION | LOCAL ] TIME ZONE { timezone | LOCAL | DEFAULT }

<span style="color: #a0522d;">postgres</span>=# show maintenance_work_mem ;
<span style="color: #a0522d;">postgres</span>=# set maintenance_work_mem to <span style="color: #8b2252;">'128MB'</span>;
<span style="color: #a0522d;">testdb</span>=# set <span style="color: #a0522d;">maintenance_work_mem</span>=<span style="color: #8b2252;">'128MB'</span>; <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20889;&#27861;2
</span>SET
<span style="color: #a0522d;">postgres</span>=# show maintenance_work_mem ;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;:&#19981;&#26159;&#25152;&#26377;&#37197;&#32622;&#37117;&#21487;&#20197;&#30452;&#25509;&#20462;&#25913;&#30340;
</span><span style="color: #a0522d;">postgres</span>=# set max_connections to <span style="color: #8b2252;">'200'</span>;
ERROR: parameter <span style="color: #8b2252;">"max_connections"</span> cannot be changed without restarting the server

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25968;&#25454;&#24211;&#30340;&#22823;&#23567;,pg_size_pretty&#20989;&#25968;&#20250;&#25226;&#25968;&#23383;&#20197;MB,GB&#31561;&#26131;&#35835;&#26684;&#24335;&#26174;&#31034;
</span><span style="color: #a0522d;">postgres</span>=# select pg_database_size(<span style="color: #8b2252;">'hellodb'</span>),pg_size_pretty(pg_database_size(<span style="color: #8b2252;">'hellodb'</span>));
pg_database_size | pg_size_pretty
 8029039 | 7841 kB
</pre>
</div>


<p>
范例: explain可以查看SQL的执行计划
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">explain&#21487;&#20197;&#26597;&#30475;SQL&#30340;&#25191;&#34892;&#35745;&#21010;
</span><span style="color: #a0522d;">hellodb</span>=# explain select * from students;
<span style="color: #a0522d;">hellodb</span>=# explain analyze select * from students;
<span style="color: #a0522d;">hellodb</span>=# explain analyze verbose select * from students;
</pre>
</div>
</div>
</div>
<div id="outline-container-查看用户和权限" class="outline-4">
<h4 id="查看用户和权限">查看用户和权限</h4>
<div class="outline-text-4" id="text-查看用户和权限">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25152;&#26377;&#29992;&#25143;\du&#25110;\dg
</span><span style="color: #a0522d;">postgres</span>=# \du
                             List of roles
 Role name |                         Attributes                         
-----------+------------------------------------------------------------
 postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#29992;&#25143;
</span><span style="color: #a0522d;">postgres</span>=# select user ;
<span style="color: #a0522d;">postgres</span>=# select current_user;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#34920;,&#35270;&#22270;,&#24207;&#21015;&#30340;&#26435;&#38480;&#20998;&#37197;&#24773;&#20917;
</span><span style="color: #a0522d;">postgres</span>=# \z
<span style="color: #a0522d;">postgres</span>=# \z t1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21644;\z&#21151;&#33021;&#30456;&#21516;
</span><span style="color: #a0522d;">postgres</span>=# \dp
</pre>
</div>
</div>
</div>
<div id="outline-container-h:93e4a4bc-7a51-4a93-9ffe-df26603e446d" class="outline-4">
<h4 id="h:93e4a4bc-7a51-4a93-9ffe-df26603e446d">事务管理和锁</h4>
<div class="outline-text-4" id="text-h:93e4a4bc-7a51-4a93-9ffe-df26603e446d">
<p>
PGSQL的事务中支持DML,DDL(除了create database,create tablespace),DCL
</p>

<p>
在psql中事务是自动提交的。和MySQL相同，执行完一条delete或update语句后，事务就自动提交了如果不想自动提交，方法有两种。
</p>

<p>
方法一:运行begin;命令，然后执行DML,DDL,DCL等语句，最后再执行commit或rollback语句。
</p>

<p>
方法二:直接使用psql中的命令关闭自动提交的功能。\set AUTOCOMMIT off,注意，命令中的
AUTOCOMMIT是大写的，不能使用小写，如果使用小写、虽然不会报错，但会导致关闭自动提交的操作不起作用。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#22987;&#20107;&#21153;
</span>BEGIN [ISOLATION LEVEL { SERIALIZABLE | REPEATABLE READ | READ COMMITTED &#8203;| READ UNCOMMITTED }]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#20132;&#21644;&#21462;&#28040;&#20107;&#21153;
</span>COMMIT|END
ROLLBACK

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#38381;&#33258;&#21160;&#25552;&#20132;,&#21487;&#20197;&#29992;rollback&#21462;&#28040;DML&#35821;&#21477;
</span>\set AUTOCOMMIT off  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;commit; &#26469;&#25552;&#20132;
</span>\set AUTOCOMMIT on

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;AUTOCOMMIT&#29366;&#24577;
</span>\echo :AUTOCOMMIT

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20107;&#21153;ID
</span><span style="color: #a020f0;">select</span> txid_current();
</pre>
</div>

<p>
范例:
</p>
<div class="org-src-container">
<pre class="src src-sh">postgres@ubuntu2004:~$ psql
<span style="color: #a0522d;">postgres</span>=# \c testdb

<span style="color: #a0522d;">testdb</span>=# begin;
BEGIN
<span style="color: #a0522d;">testdb</span>=# create table tb1 (id int);
<span style="color: #a0522d;">testdb</span>=# insert into tb1 values (1);
<span style="color: #a0522d;">testdb</span>=# select * from tb1;
1

<span style="color: #a0522d;">testdb</span>=# rollback;
ROLLBACK
<span style="color: #a0522d;">testdb</span>=# \d
Did not find any relations.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20107;&#21153;ID
</span><span style="color: #a0522d;">postgres</span>=# select txid_current();
543

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20107;&#21153;&#22359;&#20013;&#19981;&#25903;&#25345;create database
</span><span style="color: #a0522d;">testdb</span>=# begin;
BEGIN
<span style="color: #a0522d;">testdb</span>=# create database db1;
2022-01-18 01:54:36.823 UTC [14674] ERROR: CREATE DATABASE cannot run inside a transaction block
2022-01-18 01:54:36.823 UTC [14674] STATEMENT: create database db1;
ERROR: CREATE DATABASE cannot run inside a transaction block

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;ctid(&#25968;&#25454;&#25152;&#22312;&#30340;&#25968;&#25454;&#22359;&#30340;&#32534;&#21495;&#21450;&#20301;&#31227;),xmin(&#25554;&#20837;&#20107;&#21153;XID),xmax(&#21024;&#38500;&#35760;&#24405;&#30340;&#20107;&#21153;XID)
</span><span style="color: #a0522d;">testdb</span>=# select ctid,xmin,xmax,* from tb1;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#38145;&#20449;&#24687;
</span><span style="color: #a0522d;">testdb</span>=# select relation::regclass,* from pg_locks;
</pre>
</div>
</div>
</div>
<div id="outline-container-常用的系统函数" class="outline-4">
<h4 id="常用的系统函数">常用的系统函数</h4>
<div class="outline-text-4" id="text-常用的系统函数">
<p>
官方内置系统函数帮助
-<a href="http://postgres.cn/docs/current/functions-info.html">http://postgres.cn/docs/current/functions-info.html</a>
</p>
<ul class="org-ul">
<li><a href="http://postgres.cn/docs/current/functions-admin.html">http://postgres.cn/docs/current/functions-admin.html</a></li>
</ul>

<p>
常用系统函数
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#26085;&#24535;&#25991;&#20214;lsn&#20301;&#32622;;
</span><span style="color: #a020f0;">select</span> pg_current_wal_lsn();
<span style="color: #a020f0;">select</span> pg_current_xlog_location();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;xlog buffer&#20013;&#30340;insert&#20301;&#32622;&#65292;&#27880;&#24847;&#21644;&#19978;&#38754;pg_current_xlog_location()&#30340;&#21306;&#21035;:
</span>SELECT pg_current_wal_insert_lsn();
<span style="color: #a020f0;">select</span> pg_current_xlog_insert_location();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26576;&#20010;1sn&#23545;&#24212;&#30340;&#26085;&#24535;&#21517;:
</span><span style="color: #a020f0;">select</span> pg_walfile_name(lsn) ;
<span style="color: #a020f0;">select</span> pg_xlogfile_name(1sn);

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#26576;&#20010;1sn&#22312;&#26085;&#24535;&#20013;&#30340;&#20559;&#31227;&#37327;:
</span><span style="color: #a020f0;">select</span> pg_walfile_name_offset(<span style="color: #8b2252;">'lsn&#21495;'</span>);
<span style="color: #a020f0;">select</span> pg_xlogfile_name_offset(<span style="color: #8b2252;">'lsn&#21495;'</span>);

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#20004;&#20010;lsn&#20301;&#32622;&#30340;&#24046;&#36317;;
</span><span style="color: #a020f0;">select</span> pg_wa1_1sn_diff(<span style="color: #8b2252;">'lsn&#21495;'</span>,<span style="color: #8b2252;">'lsn&#21495;'</span>);
<span style="color: #a020f0;">select</span> pg_xlog_1ocation_diff(<span style="color: #8b2252;">'lsn&#21495;'</span>,<span style="color: #8b2252;">'lsn&#21495;'</span>);

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#22791;&#24211;&#25509;&#25910;&#21040;&#30340;1sn&#20301;&#32622;:
</span><span style="color: #a020f0;">select</span> pg_last_wal_receive_lsn();
<span style="color: #a020f0;">select</span> pg_last_xlog_receive_location();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#22791;&#24211;&#22238;&#25918;&#30340;lsn&#20301;&#32622;:
</span><span style="color: #a020f0;">select</span> pg_last_xact_replay_timestamp();
<span style="color: #a020f0;">select</span> pg_last_xlog_relay_location();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#36824;&#21407;&#28857;:
</span><span style="color: #a020f0;">select</span> pg_create_restore_point(now()::text);

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#34920;&#30340;&#25968;&#25454;&#25991;&#20214;&#36335;&#24452;&#65292;filenode:
</span><span style="color: #a020f0;">select</span> pg_relation_filenode( <span style="color: #8b2252;">'&#34920;&#21517;'</span>);

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#34920;students&#30340;oid:
</span><span style="color: #a020f0;">select</span> <span style="color: #8b2252;">'students'</span>::regclass::oid;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#20250;&#35805;pid:
</span><span style="color: #a020f0;">select</span> pg_backend_pid();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#24207;&#21015;:
</span><span style="color: #a020f0;">select</span> generate_series (1,8,2);

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;uuid (pg13&#26032;&#29305;&#24615;):
</span>se1ect gen_random_uuid();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#36733;&#37197;&#32622;&#25991;&#20214;&#20449;&#24687;:
</span><span style="color: #a020f0;">select</span> pg_reload_conf();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25968;&#25454;&#24211;&#21551;&#21160;&#26102;&#38388;:
</span><span style="color: #a020f0;">select</span> pg_postmaster_start_time();
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-用户和角色" class="outline-3">
<h3 id="用户和角色">用户和角色</h3>
<div class="outline-text-3" id="text-用户和角色">
<p>
PostgreSQL使用角色role的概念来管理数据库访问权限。角色是一系列相关权限
的集合。为了管理方便，通常会把一系列相关的数据库权限赋给一个角色，如果
哪个用户需要这些权限，就把角色赋给相应的用户。由于用户也拥有一系列的相
关权限，为了简化管理，在PostgreSQL中，角色与用户是没有区别的，一个用户
也是一个角色，因此可以把一个用户的权限赋给另一个用户。
</p>

<p>
用户和角色在整个数据库实例中都是全局的,即在同一个实例中的不同数据库中,看到的用户也都是相同的。
</p>

<p>
在初始化数据库实例时，会创建一个预定义的超级用户，这个用户的名称与初始
化该数据库实例的操作系统用户名相同。比如:如果数据库实例是建立在操作系
统用户dba (通常使用 postgres用户)下的，这个数据库超级用户的名称也会叫
dba。可以用这个超级用户连接数据库，注意：dba默认会连接同名的数据库dba，
而默认dba不存在，所以需要登录时指定连接数据库postgres进行登录,然后再创
建其它的用户
</p>
</div>
<div id="outline-container-创建用户和角色" class="outline-4">
<h4 id="创建用户和角色">创建用户和角色</h4>
<div class="outline-text-4" id="text-创建用户和角色">
<p>
在PostgreSQL中，用户与角色是没有区别的。
</p>

<p>
用户和角色可以用来实现以下功能:
</p>
<ul class="org-ul">
<li>用来登录数据库实例</li>
<li>管理数据库对象</li>
</ul>

<p>
创建用户与角色的语法如下:
</p>

<div class="org-src-container">
<pre class="src src-sh">CREATE USER name [[WITH] option [ ...]] CREATE ROLE name [[WITH] option [ ...]]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#38754;&#20004;&#20010;&#21629;&#20196;&#37117;&#21487;&#20197;&#21019;&#24314;&#29992;&#25143;,&#19981;&#21516;&#30340;&#26159;CREATE USER&#21019;&#24314;&#30340;&#29992;&#25143;&#40664;&#35748;&#21487;&#20197;&#30331;&#24405;,&#32780;CREATE ROLE&#19981;&#21487;&#20197;&#30331;&#24405;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#38500;&#20102;CREATE USER &#40664;&#35748;&#21019;&#24314;&#20986;&#26469;&#30340;&#29992;&#25143;&#26377;LOGIN &#30340;&#26435;&#38480;&#65292;&#32780;CREATE ROLE
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#20986;&#26469;&#30340;&#29992;&#25143;&#27809;&#26377;&#8220;LOGIN"&#30340;&#26435;&#38480;&#20043;&#22806;&#65292;CREATE RULE &#19982; CREATE USER&#27809;&#26377;&#20854;&#20182;&#20219;&#20309;&#30340;&#21306;&#21035;&#12290;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#38754;&#35821;&#27861;&#20013;&#30340;&#8220;option&#8221;&#21487;&#20197;&#26159;&#22914;&#19979;&#20869;&#23481;&#12290;
</span>
SUPERUSER | NOSUPERUSER:&#34920;&#31034;&#21019;&#24314;&#20986;&#26469;&#30340;&#29992;&#25143;&#26159;&#21542;&#20026;&#36229;&#32423;&#29992;&#25143;&#12290;&#21482;&#26377;&#36229;&#32423;&#29992;&#25143;&#25165;&#33021;&#21019;&#24314;&#36229;&#32423;&#29992;&#25143;&#12290;
CREATEDB /NOCREATEDB:&#25351;&#23450;&#21019;&#24314;&#20986;&#26469;&#30340;&#29992;&#25143;&#26159;&#21542;&#26377;&#25191;&#34892;<span style="color: #8b2252;">'CREATE DATABASE'</span>&#30340;&#26435;&#38480;&#12290;
CREATEROLE NOCREATEROLE:&#25351;&#23450;&#21019;&#24314;&#20986;&#26469;&#30340;&#29992;&#25143;&#26159;&#21542;&#26377;&#21019;&#24314;&#20854;&#20182;&#35282;&#33394;&#30340;&#26435;&#38480;&#12290;
CREATEUSER NOCREATEUSER:&#25351;&#23450;&#21019;&#24314;&#20986;&#26469;&#30340;&#29992;&#25143;&#26159;&#21542;&#26377;&#21019;&#24314;&#20854;&#20182;&#29992;&#25143;&#30340;&#26435;&#38480;&#12290;
INHERIT &#8203;|NOINHERIT:&#22914;&#26524;&#21019;&#24314;&#30340;&#19968;&#20010;&#29992;&#25143;&#25317;&#26377;&#26576;&#19968;&#20010;&#25110;&#26576;&#20960;&#20010;&#35282;&#33394;&#65292;&#36825;&#26102;&#33509;&#25351;&#23450;INHERIT&#65292;
&#21017;&#34920;&#31034;&#29992;&#25143;&#33258;&#21160;&#25317;&#26377;&#30456;&#24212;&#35282;&#33394;&#30340;&#26435;&#38480;&#65292;&#21542;&#21017;&#36825;&#20010;&#29992;&#25143;&#27809;&#26377;&#35813;&#35282;&#33394;&#30340;&#26435;&#38480;&#12290;

LOGIN | NOLOGIN:&#25351;&#23450;&#21019;&#24314;&#20986;&#26469;&#30340;&#29992;&#25143;&#26159;&#21542;&#26377;&#8220;LOGIN&#8221;&#30340;&#26435;&#38480;&#65292;&#21487;&#20197;&#20020;&#26102;&#22320;&#31105;
&#27490;&#19968;&#20010;&#29992;&#25143;&#30340;&#8220;LOGIN&#8221;&#26435;&#38480;&#65292;&#36825;&#26102;&#27492;&#29992;&#25143;&#23601;&#19981;&#33021;&#36830;&#25509;&#21040;&#25968;&#25454;&#24211;

CONNECTION LIMIT connlimit:&#25351;&#23450;&#35813;&#29992;&#25143;&#21487;&#20197;&#20351;&#29992;&#30340;&#24182;&#21457;&#36830;&#25509;&#25968;&#37327;&#12290;&#40664;&#35748;&#20540;&#26159;-1&#65292;&#34920;&#31034;&#27809;&#26377;&#38480;&#21046;&#12290;
[ENCRYPTED | UNENCRYPTED ] PASSWORD<span style="color: #8b2252;">'password'</span> : &#29992;&#20110;&#25511;&#21046;&#23384;&#20648;&#22312;&#31995;&#32479;&#34920;&#37324;&#38754;&#30340;&#21475;&#20196;&#26159;&#21542;&#21152;&#23494;&#12290;

VALID UNTIL <span style="color: #8b2252;">'timestamp'</span>:&#23494;&#30721;&#22833;&#25928;&#26102;&#38388;&#65292;&#22914;&#26524;&#19981;&#25351;&#23450;&#36825;&#20010;&#23376;&#21477;&#65292;&#37027;&#20040;&#21475;&#20196;&#23558;&#27704;&#36828;&#26377;&#25928;&#12290;

INROLE role name [,...]:&#25351;&#23450;&#29992;&#25143;&#25104;&#20026;&#21738;&#20123;&#35282;&#33394;&#30340;&#25104;&#21592;&#65292;&#35831;&#27880;&#24847;&#27809;&#26377;&#20219;&#20309;&#36873;&#39033;&#21487;&#20197;&#25226;&#26032;&#35282;&#33394;&#28155;
&#21152;&#20026;&#31649;&#29702;&#21592;&#65292;&#24517;&#39035;&#20351;&#29992;&#29420;&#31435;&#30340;GRANT&#21629;&#20196;&#26469;&#20570;&#36825;&#20214;&#20107;&#24773;&#12290;

IN GROUP role_name [,...]:&#19982;IN ROLE&#30456;&#21516;&#65292;&#26159;&#24050;&#36807;&#26102;&#30340;&#35821;&#27861;&#12290;
ROLE role_name [,...]: role_name&#23558;&#25104;&#20026;&#36825;&#20010;&#26032;&#24314;&#30340;&#35282;&#33394;&#30340;&#25104;&#21592;&#12290;
ADMIN role_name [,...]: role_name&#23558;&#26377;&#36825;&#20010;&#26032;&#24314;&#35282;&#33394;&#30340;WITH ADMIN OPTION&#26435;&#38480;&#12290;
USER role_name[,....]:&#19982;ROLE&#23376;&#21477;&#30456;&#21516;&#65292;&#20294;&#24050;&#36807;&#26102;&#12290;
SYSID uid:&#27492;&#23376;&#21477;&#20027;&#35201;&#26159;&#20026;&#20102;SQL&#21521;&#19979;&#20860;&#23481;&#65292;&#23454;&#38469;&#27809;&#26377;&#20160;&#20040;&#29992;&#22788;&#12290;
</pre>
</div>
</div>
</div>
<div id="outline-container-用户管理案例" class="outline-4">
<h4 id="用户管理案例">用户管理案例</h4>
<div class="outline-text-4" id="text-用户管理案例">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24110;&#21161;
</span>\h create user
\h alter user
\h drop user
\h create role
\h alter role
\h drop role

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#19979;&#20004;&#20010;&#21629;&#20196;&#29992;&#27861;&#30456;&#20284;
</span>create user <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#30340;&#29992;&#25143;&#40664;&#35748;&#21487;&#20197;&#36830;&#25509; create role #&#21019;&#24314;&#30340;&#29992;&#25143;&#40664;&#35748;&#26080;&#27861;&#36830;&#25509;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#29992;&#25143;
</span>alter user

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#29992;&#25143;
</span>drop user

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#20986;&#25152;&#26377;&#29992;&#25143;&#21644;&#35282;&#33394;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">\du&#21644;\dg&#21629;&#20196;&#31561;&#20215;&#12290;&#21407;&#22240;&#26159;&#22312;PostgreSQL&#25968;&#25454;&#24211;&#20013;&#29992;&#25143;&#21644;&#35282;&#33394;&#19981;&#20998;&#30340;&#12290;
</span>\du
\dg
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#21487;&#20197;&#30331;&#24405;&#30340;&#29992;&#25143;&#21644;&#23494;&#30721;
</span>CREATE USER wang WITH PASSWORD <span style="color: #8b2252;">'123456'</span>;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#19981;&#21487;&#30331;&#24405;&#29992;&#25143;
</span>create role zhao WITH PASSWORD <span style="color: #8b2252;">'123456'</span>;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#21487;&#20197;&#36830;&#25509;&#30340;&#29992;&#25143;
</span>CREATE ROLE li WITH LOGIN PASSWORD <span style="color: #8b2252;">'123456'</span> VALID UNTIL <span style="color: #8b2252;">'2020-07-01'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#31649;&#29702;&#21592;
</span>CREATE ROLE admin WITH SUPERUSER LOGIN PASSWORD <span style="color: #8b2252;">'123456'</span> ;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#22797;&#21046;&#29992;&#25143;
</span>CREATE USER repl REPLICATION LOGIN ENCRYPTED PASSWORD <span style="color: #8b2252;">'123456'</span>;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#23494;&#30721;
</span>ALTER USER admin with password <span style="color: #8b2252;">'654321'</span>;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#26435;&#38480;&#21644;&#23494;&#30721;
</span>alter user wang with nologin password <span style="color: #8b2252;">'123'</span>;
alter user zhao with login;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#29992;&#25143;
</span>DROP USER song;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#29992;&#25143;&#20449;&#24687;
</span>\du

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#29992;&#25143;&#20449;&#24687;
</span>\du wang
</pre>
</div>

<p>
范例：修改 postgres用户密码
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;postgres&#29992;&#25143;&#30331;&#24405;&#65288;PostgresSQL&#23433;&#35013;&#21518;&#20250;&#33258;&#21160;&#21019;&#24314;postgres&#29992;&#25143;&#65289;
</span>[root@rocky8 ~]#su - postgres

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30331;&#24405;postgresql&#25968;&#25454;&#24211;
</span>[root@rocky8 ~]# psql -U postgres
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#20840;&#36215;&#35265;,&#20462;&#25913;&#25968;&#25454;&#24211;&#31649;&#29702;&#21592;postgres&#29992;&#25143;&#30340;&#23494;&#30721;
</span><span style="color: #a0522d;">postgres</span>=# ALTER USER postgres WITH ENCRYPTED PASSWORD <span style="color: #8b2252;">'123456'</span>;
ALTER ROLE
</pre>
</div>
</div>
</div>
<div id="outline-container-权限管理" class="outline-4">
<h4 id="权限管理">权限管理</h4>
<div class="outline-text-4" id="text-权限管理">
<p>
在PostgreSQL数据库中，每个数据库的对象（包括数据库)都有一个所有者,也就
是说任何数据库对象都是属于某个用户的，所有者默认就拥有所有权限。所以不
需要把对象的权限再赋给所有者。自己创建的数据库对象，自己当然有全部的权
限。当然，所有者出于安全考虑也可以选择废弃一些自己的权限。在
PostsgreSQL数据库中，删除一个对象及任意修改它的权利是所有者固有的,不能
被赋予或撤销。所有者也隐含地拥有把操作该对象的权限赋给别人的权利。
</p>

<p>
一个用户的权限分为两类，一类是在创建用户时就指定的权限，这些权限如下:
</p>
<ul class="org-ul">
<li>超级用户的权限</li>
<li>创建数据库的权限</li>
<li>是否允许LOGIN的权限</li>
</ul>

<p>
以上这些权限是创建用户时指定的，后续可使用ALTER ROLE命令来修改。
</p>

<p>
还有一类权限，是由命令GRANT和 REVOKE来管理的，这些权限如下:
</p>
<ul class="org-ul">
<li>在数据库中创建模式(SCHEMA)</li>
<li>允许在指定的数据库中创建临时表连接某个数据库</li>
<li>在模式中创建数据库对象，如创建表、视图函数等</li>
<li>在一些表中做SELECT、UPDATE、INSERRDELETE等操作等</li>
</ul>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">GRANT&#21629;&#20196;&#26377;&#20004;&#20010;&#20316;&#29992;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">1.&#35753;&#26576;&#20010;&#29992;&#25143;&#25104;&#20026;&#26576;&#20010;&#35282;&#33394;&#30340;&#25104;&#21592;&#65292;&#20174;&#32780;&#20351;&#20854;&#25317;&#26377;&#35282;&#33394;&#30340;&#26435;&#38480;:
</span>GRANT role_name [, ...] T0 role_name [, ...] [ WITH ADMIN OPTION ];

<span style="color: #b22222;">#</span><span style="color: #b22222;">2.&#25226;&#26576;&#20123;&#25968;&#25454;&#24211;&#36923;&#36753;&#32467;&#26500;&#23545;&#35937;&#30340;&#25805;&#20316;&#26435;&#38480;&#36171;&#20104;&#26576;&#20010;&#29992;&#25143;(&#25110;&#35282;&#33394;)&#65292;&#21629;&#20196;&#30340;&#26684;&#24335;&#22914;&#19979;:
</span>GRANT some privileqes ON database_object_type object_name TO role_name;

&#20854;&#20013;&#65292;&#8220;some privileges&#8221;&#34920;&#31034;&#22312;&#36825;&#20010;&#25968;&#25454;&#24211;&#23545;&#35937;&#20013;&#30340;&#26435;&#38480;,&#8220;database_object_type&#8221;&#26159;&#25968;&#25454;&#24211;&#23545;&#35937;&#30340;&#31867;&#22411;,
&#22914;&#8220;TABLE&#8221;&#12289;&#8220;SEQUENCE&#8221;&#12289;&#8220;SCHEMA&#8221;&#65292;&#31561;&#12290;
</pre>
</div>

<p>
<b>PostgreSQL中的权限是按以下几个层次进行管理的</b>:
</p>
<ul class="org-ul">
<li>cluster权限:实例权限通过pg_hba.conf配置</li>
<li>管理赋在用户特殊属性上的权限，如超级用户的权限、创建数据库的权限、创建用户的权限、Login权限等</li>
<li>在数据库中创建模式的权限</li>
<li>表空间权限:通过grant/revoke控制权限操作表,物化视图,索引等</li>
<li>在模式中创建数据库对象的权限，如创建表、创建索引，等等</li>
<li>查询表、往表中插入数据、更新表、删除表中数据的权限</li>
<li>操作表中某些字段的权限</li>
</ul>
</div>
</div>
<div id="outline-container-权限案例" class="outline-4">
<h4 id="权限案例">权限案例</h4>
<div class="outline-text-4" id="text-权限案例">
<p>
范例:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25480;&#26435;&#21019;&#24314;&#26032;&#25968;&#25454;&#24211;
</span><span style="color: #a0522d;">postgres</span>=# alter user wang with CREATEDB;

<span style="color: #b22222;">#</span><span style="color: #b22222;">database&#26435;&#38480;&#35774;&#32622;
</span>GRANT create ON DATABASE testdb TO wang;

<span style="color: #b22222;">#</span><span style="color: #b22222;">schema&#26435;&#38480;
</span>ALTER SCHEMA wang OWNER to wang;
GRANT select,insert,update,delete ON ALL TABLES IN SCHEMA wang TO wang;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;test&#30340;schema&#25351;&#23450;&#25152;&#26377;&#32773;&#20026;joe
</span>CREATE SCHEMA IF NOT EXISTS test AUTHORIZATION joe;

<span style="color: #b22222;">#</span><span style="color: #b22222;">object&#26435;&#38480;
</span>GRANT select,insert,update,delete ON testdb.t1 TO wang;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#25968;&#25454;&#24211;&#24182;&#25351;&#23450;&#25152;&#26377;&#32773;&#30340;&#29992;&#25143;
</span>create user wang with password <span style="color: #8b2252;">'123456'</span>;
CREATE DATABASE zabbix OWNER wang;
</pre>
</div>

<p>
范例: 创建业务用户和授权
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">postgres</span>=# create database pinxixi;
<span style="color: #a0522d;">postgres</span>=#\c pinxixi
<span style="color: #a0522d;">pinxixi</span>=#create user wanrentuan with password <span style="color: #8b2252;">'123456'</span>;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1
</span><span style="color: #a0522d;">pinxixi</span>=#create schema wanrentuan;
<span style="color: #a0522d;">pinxixi</span>=#ALTER SCHEMA wanrentuan OWNER to wanrentuan;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2
</span><span style="color: #a0522d;">pinxixi</span>=#CREATE SCHEMA AUTHORIZATION wanrentuan;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;3
</span><span style="color: #a0522d;">pinxixi</span>=#GRANT select, insert,update,delete oN ALL TABLES IN SCHEMA wanrentuan to wanrentuan;
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#21019;&#24314;&#19968;&#20010;&#21517;&#20026;&#8220;readonly&#8221;&#30340;&#29992;&#25143;
</span>CREATE USER readonly with password <span style="color: #8b2252;">'123456'</span>;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25226;&#22312;public&#30340;schema&#19979;&#29616;&#26377;&#30340;&#25152;&#26377;&#34920;&#30340;SELECT &#26435;&#38480;&#36171;&#32473;&#29992;&#25143;readonly
</span>GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:09f09497-fd2f-479e-a9d8-d13ac3ac3d57" class="outline-3">
<h3 id="h:09f09497-fd2f-479e-a9d8-d13ac3ac3d57">安装使用图形化工具pgadmin</h3>
<div class="outline-text-3" id="text-h:09f09497-fd2f-479e-a9d8-d13ac3ac3d57">
</div>
<div id="outline-container-pgadmin-介绍" class="outline-4">
<h4 id="pgadmin-介绍">pgadmin 介绍</h4>
<div class="outline-text-4" id="text-pgadmin-介绍">
<p>
pgAdmin是一个免费的开源图形数据库管理工具，用于管理PostgreSQL和衍生的
关系数据库，如EnterpriseDB的EDB Advanced Server。pgAdmin可以以两种模式
安装：服务器模式和桌面模式。服务器模式下的pgAdmin可以部署在不同的Web服
务器中，如:Apache，Nginx等
</p>

<p>
pgAdmin 是一个在PostgreSQL许可下发布的免费软件项目。该软件可从
PostgreSQL镜像网络以源代码和二进制格式获得。因为从源代码编译比较繁琐，
建议尽可能使用安装二进制包。
</p>

<p>
pgAdmin 4 是对 pgAdmin 的完全重写，使用 Python 和 Javascript/jQuery构建
</p>

<p>
官网：<a href="https://www.pgadmin.org/">https://www.pgadmin.org/</a>
</p>

<p>
下载: <a href="https://www.pgadmin.org/download/">https://www.pgadmin.org/download/</a>
</p>
<ul class="org-ul">
<li>容器版本 <a href="https://www.pgadmin.org/download/pgadmin-4-container/">https://www.pgadmin.org/download/pgadmin-4-container/</a></li>
<li>windows版本 <a href="https://www.pgadmin.org/download/pgadmin-4-windows/">https://www.pgadmin.org/download/pgadmin-4-windows/</a></li>
</ul>
</div>
</div>
<div id="outline-container-h:d6381977-ce96-46dd-9f42-c801f467c812" class="outline-4">
<h4 id="h:d6381977-ce96-46dd-9f42-c801f467c812">安装pgadmin</h4>
<div class="outline-text-4" id="text-h:d6381977-ce96-46dd-9f42-c801f467c812">
<p>
范例: 安装Windows版本的pgadmin
</p>
<ul class="org-ul">
<li>修改语言环境 Prefernces &#x2013;&gt;Miscellaneous&#x2013;&gt;User language</li>
<li>关闭并重新打开pgadmin才能看到显示已汉化</li>
</ul>

<p>
范例: Ubuntu20.04 安装 pgadmin
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 ~]#apt install pgadmin4 -y
[root@ubuntu2004 ~]#pgadmin4
</pre>
</div>

<p>
范例： 基于docker 安装 pgadmin
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@rocky8 ~]#docker run -e <span style="color: #a0522d;">PGADMIN_DEFAULT_EMAIL</span>=tmpuser@163.com <span style="color: #8b2252;">\</span>
               -e <span style="color: #a0522d;">PGADMIN_DEFAULT_PASSWORD</span>=123456 -d --name pgadmin -p 80:80 <span style="color: #8b2252;">\</span>
               dpage/pgadmin4
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:429caa18-a567-471c-871b-8124f76d0450" class="outline-2">
<h2 id="h:429caa18-a567-471c-871b-8124f76d0450">PostgreSQL 体系架构</h2>
<div class="outline-text-2" id="text-h:429caa18-a567-471c-871b-8124f76d0450">
</div>
<div id="outline-container-体系架构概览" class="outline-3">
<h3 id="体系架构概览">体系架构概览</h3>
<div class="outline-text-3" id="text-体系架构概览">
<p>
PostgreSQL和MySQL相似,也采用典型的C/S模型。
</p>

<p>
PostgreSQL体系结构分两部分
</p>
<ul class="org-ul">
<li>实例 instance</li>
<li>磁盘存储</li>
</ul>

<p>
实例 instance 包括
</p>
<ul class="org-ul">
<li>进程</li>
<li>内存存储结构</li>
</ul>



<figure id="orga6a653a">
<img src="./images/img_20241112_101753.png" alt="img_20241112_101753.png" width="90%">

</figure>
</div>
</div>
<div id="outline-container-进程和内存结构" class="outline-3">
<h3 id="进程和内存结构">进程和内存结构</h3>
<div class="outline-text-3" id="text-进程和内存结构">
<p>
PostgreSQL是进程架构模型，MySQL是线程架构模型。
</p>


<p>
下图来自《POSTGRESQL修炼之道从小工到专家》
</p>


<figure id="orgcb64ea7">
<img src="./images/img_20241107_113805.png" alt="img_20241107_113805.png" width="90%">

</figure>
</div>
<div id="outline-container-进程" class="outline-4">
<h4 id="进程">进程</h4>
<div class="outline-text-4" id="text-进程">
<ul class="org-ul">
<li>Postmaster 主进程
<ul class="org-ul">
<li>它是整个数据库实例的主控制进程，负责启动和关闭该数据库实例。</li>
<li>实际上,使用pg ctl来启动数据库时，pg_ctl也是通过运行postgres来启动数据库的，只是它做了一些包装,更容易启动数据库。</li>
<li>它是第一个PostgreSQL进程，此主进程还会fork出其他子进程，并管理它们。</li>
<li>当用户和PostgreSQL建立连接时，首先是和Postmaster进程建立连接。首先，客户端会发出身份验证的信息给Postmaster进程，Postmaster进程根据消息中的信息进行身份验证判断，如果验证通过，它会fork出一个会话子进程为这个连接服务。</li>
<li>当某个服务进程出现错误的时候，Postmaster主进程会自动完成系统的恢复。恢复过程中会停掉所有的服务进程,然后进行数据库数据的一致性恢复,等恢复完成后，数据库又可以接受新的连接。</li>
<li>验证功能是通过配置文件pg_hba.conf和用户验证模块来提供。</li>
<li><p>
postmaster 程序是指向postgres的软链接
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 ~]#ll /apps/pgsql/bin/postmaster
lrwxrwxrwx 1 root root 8 Dec 28 01:19 /apps/pgsql/bin/postmaster -&gt;postgres*
</pre>
</div></li>
</ul></li>

<li>BgWriter 后台写进程
<ul class="org-ul">
<li>为了提高插入、删除和更新数据的性能，当往数据库中插入或者更新数据时，并不会马上把数据持久化到数据文件中,而是先写入Buffer中</li>
<li>该辅助进程可以周期性的把内存中的脏数据刷新到磁盘中</li>
</ul></li>

<li>WalWriter 预写式日志进程
<ul class="org-ul">
<li>WAL是write ahead log的缩写，WAL log旧版中称为xlog，相当于MySQL中Redo log预写式日志是在修改数据之前，必须把这些修改操作记录到磁盘中，这样后面更新实际数据时，就不需要实时的把数据持久化到文件中了。即使机器突然宕机或者数据库异常退出，导致一部分内存中的脏数据没有及时的刷新到文件中，在数据库重启后，通过读取WAL日志，并把最后一部分WAL日志重新执行一遍，就能恢复到宕机时的状态了</li>
<li>WAL日志保存在pg_wal目录(早期版本为pg_xlog)下。每个xlog文件默认是16MB,为了满足恢复要求，在pg_wal目录下会产生多个WAL日志，这样就可保证在宕机后，未持久化的数据都可以通过WAL日志来恢复，那些不需要的WAL日志将会被自动覆盖</li>
</ul></li>

<li>Checkpointer 检查点进程
<ul class="org-ul">
<li>检查点(Checkpoints)是事务序列中的点,保证在该点之前的所有日志信息都更新到数据文件中。</li>
<li>在检查点时，所有脏数据页都冲刷到磁盘并且向日志文件中写入一条特殊的检查点记录。在发生崩溃的时候，恢复器就知道应该从日志中的哪个点（称做redo 记录）开始做 REDO操作，因为在该记录前的对数据文件的任何修改都已经在磁盘上了。在完成检查点处理之后，任何在redo记录之前写的日志段都不再需要，因此可以循环使用或者删除。在进行 WAL归档的时 候，这些日志在循环利用或者删除之前应该必须先归档保存</li>
<li>检查点进程 (CKPT)在特定时间自动执行一个检查点,通过向数据库写入进程 (BgWriter)传递消息来启动检查点请求</li>
</ul></li>

<li>AutoVacuum 自动清理进程
<ul class="org-ul">
<li>执行delete操作时，旧的数据并不会立即被删除，在更新数据时，也不会在旧的数据上做更新，而是新生成一行数据。旧的数据只是被标识为删除状态，在没有并发的其他事务读到这些旧数据时，它们才会被清除掉</li>
<li>autovacuum lanucher负责回收垃圾数据的master进程,如果开启了autovacuum的话,那么postmaster会fork这个进程</li>
<li>autovacuum worker负责回收垃圾数据的worker进程,是lanucher进程fork出来的</li>
</ul></li>

<li>PgStat 统计数据收集进程
<ul class="org-ul">
<li>此进程主要做数据的统计收集工作</li>
<li>收集的信息主要用于查询优化时的代价估算。统计的数据包括对一个表或索引进行的插入、删除、更新操作，磁盘块读写的次数以及行的读次数等。</li>
<li>系统表pg_statistic中存储了PgStat收集的各类统计信息</li>
</ul></li>

<li>PgArch 归档进程
<ul class="org-ul">
<li>默认没有此进程,开启归档功能后才会启动archiver进程</li>
<li>WAL日志文件会被循环使用，也就是说WAL日志会被覆盖,利用PgArch进程会在覆盖前把WAL日志备份出来,类似于binlog,可用于备份功能</li>
<li>PostgreSQL 从8.X版本开始提供了PITR (Point-In-Time-Recovery)技术，即就是在对数据厍进行过一次全量备份后，该技术将备份时间点后面的WAL日志通过归档进行备份，将来可以使用数据库的全量备份再加上后面产生的WAL日志，即可把数据库向前恢复到全量备份后的任意一个时间点的状态</li>
</ul></li>

<li>SysLogger 系统日志进程
<ul class="org-ul">
<li>默认没有此进程,配置文件 postgresql.conf设置参数logging_collect设置为“on”时，主进程才会启动SysLogger辅助进程</li>
<li>它从Postmaster主进程、所有的服务进程以及其他辅助进程收集所有的stderr输出，并将这些输出写入到日志文件中</li>
</ul></li>

<li>startup 启动进程
<ul class="org-ul">
<li>用于数据库恢复的进程</li>
</ul></li>

<li>Session 会话进程
<ul class="org-ul">
<li>每一个用户发起连接后，一旦验证成功,postmaster进程就会fork&#x2014;个新的子进程负责连接此用户。</li>
<li>通常表现为进程形式： postgres postgres [local] idle</li>
</ul></li>
</ul>

<p>
案例: 查看进程
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 ~]#ps auxf|grep ^postgres
</pre>
</div>

<p>
范例: 开启归档后再查看进程
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 ~]#ps auxf|grep ^postgres
</pre>
</div>
</div>
</div>
<div id="outline-container-内存结构" class="outline-4">
<h4 id="内存结构">内存结构</h4>
<div class="outline-text-4" id="text-内存结构">
<p>
PostgreSQL的内存空间包括共享内存和本地内存两部分
</p>
<ul class="org-ul">
<li>共享内存
<ul class="org-ul">
<li>PostgreSQL启动后，会生成一块共享内存，共享内存主要用做数据块的缓冲区，以便提高读写性能。WAL日志缓冲区和CLOG(Commit log)缓冲区也存在于共享内存中。除此以外，一些全局信息也保存在共享内存中，如进程信息、锁的信息、全局统计信息等。</li>
<li>PostgreSQL9.3之前的版本与Oracle数据库一样，都是使用“SystemV”类型的共享内存，但到PostgreSQL9.3之后，PostgreSQL使用mmap()方式共享内存,好处能使用较大的共享内存。</li>
<li>可以通过配置postgresql.conf文件中shared_buffers指定，默认128M，建议是内存的50%</li>
</ul></li>
</ul>



<figure id="org49e9fd6">
<img src="./images/img_20241112_111405.png" alt="img_20241112_111405.png" width="90%">

</figure>


<ul class="org-ul">
<li><p>
本地内存
</p>

<p>
后台服务进程除访问共享内存外，还会申请分配一些本地内存，以便暂存一些不需要全局存储的数据。
</p>

<p>
都可以通过在配置postgresql.conf文件中指定
</p>

<p>
这些内存缓冲区主要有以下几类：
</p>
<ul class="org-ul">
<li>temp_buffers:用于访问临时表的本地缓冲区，默认为8M</li>
<li>work_mem:内部排序操作和Hash表在使用临时磁盘文件之前使用的内存缓冲区,默认为4M</li>
<li>maintenance_work_mem:在维护性操作(比如VACUUM、CREATE INDEX和ALTERTABLE ADD FOREIGN KEY 等）中使用的内存缓冲区，默认为64M</li>
</ul></li>
</ul>

<p>
范例：查看内存空间
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">postgres</span>=# show shared_buffers;
128MB
<span style="color: #a0522d;">postgres</span>=# show maintenance_work_mem;
64MB

<span style="color: #a0522d;">postgres</span>=# show work_mem;
4MB
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-数据更新过程" class="outline-3">
<h3 id="数据更新过程">数据更新过程</h3>
<div class="outline-text-3" id="text-数据更新过程">

<figure id="org03e087c">
<img src="./images/img_20241107_115019.png" alt="img_20241107_115019.png" width="90%">

</figure>


<ul class="org-ul">
<li>先将数据库文件中的更改的数据加载至内存</li>
<li>在内存更新数据</li>
<li>将日志写入内存WAL的缓存区</li>
<li>将日志提交，将日志写入操作系统 cache</li>
<li>同步日志到磁盘</li>
<li>后台写数据库的更新后的数据到操作系统 cache</li>
<li>写完数据后，更新检查点checkpoint</li>
<li>同步数据到磁盘</li>
</ul>
</div>
</div>
<div id="outline-container-数据库目录结构" class="outline-3">
<h3 id="数据库目录结构">数据库目录结构</h3>
<div class="outline-text-3" id="text-数据库目录结构">
</div>
<div id="outline-container-数据库目录介绍" class="outline-4">
<h4 id="数据库目录介绍">数据库目录介绍</h4>
<div class="outline-text-4" id="text-数据库目录介绍">
<p>
数据库数据存放在环境变量PGDATA指向数据目录。这个目录是在安装时指定的，
所以在安装时需要指定一个合适的目录作为数据目录的根目录，而且，每一个数
据库实例都要有一个对应的目录。目录的初始化是使用initdb来完成的。
</p>
<div class="org-src-container">
<pre class="src src-sh">PGDATA
- File segment, Tablespace, Control file, Online WAL log, ARCH WAL log, Log file
</pre>
</div>

<p>
初始化完成后，PGDATA数据目录下就会生成三个配置文件。
</p>

<div class="org-src-container">
<pre class="src src-sh">postgresql.conf <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#23454;&#20363;&#30340;&#20027;&#37197;&#32622;&#25991;&#20214;&#65292;&#22522;&#26412;&#19978;&#25152;&#26377;&#30340;&#37197;&#32622;&#21442;&#25968;&#37117;&#22312;&#27492;&#25991;&#20214;&#20013;&#12290;
</span>pg_hba.conf   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35748;&#35777;&#37197;&#32622;&#25991;&#20214;&#65292;&#37197;&#32622;&#20102;&#20801;&#35768;&#21738;&#20123;IP&#30340;&#20027;&#26426;&#35775;&#38382;&#25968;&#25454;&#24211;&#65292;&#35748;&#35777;&#30340;&#26041;&#27861;&#26159;&#20160;&#20040;&#31561;&#20449;&#24687;&#12290;
</span>pg_ident.conf <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35748;&#35777;&#26041;&#24335;ident&#30340;&#29992;&#25143;&#26144;&#23556;&#25991;&#20214;&#12290;</span>
</pre>
</div>

<p>
此外在PGDATA目录下还会生成如下一些子目录
</p>

<div class="org-src-container">
<pre class="src src-sh">base            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#34920;&#31354;&#38388;&#30340;&#30446;&#24405;,&#27599;&#20010;&#25968;&#25454;&#24211;&#37117;&#23545;&#24212;&#19968;&#20010;base&#30446;&#24405;&#19979;&#30340;&#23376;&#30446;&#24405;,&#27599;&#20010;&#34920;&#21644;&#32034;&#24341;&#23545;&#24212;&#19968;&#20010;&#29420;&#31435;&#25991;&#20214;
</span>global          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#20010;&#30446;&#24405;&#23545;&#24212;pg_global&#34920;&#31354;&#38388;,&#23384;&#25918;&#23454;&#20363;&#20013;&#30340;&#20849;&#20139;&#23545;&#35937;
</span>pg_clog         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23384;&#20648;&#20107;&#21153;&#25552;&#20132;&#29366;&#24577;&#25968;&#25454;
</span>pg_bba.conf     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#35775;&#38382;&#25511;&#21046;&#25991;&#20214;
</span>pg_log          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#31995;&#32479;&#26085;&#24535;&#30446;&#24405;&#65292;&#22312;&#26597;&#35810;&#19968;&#20123;&#31995;&#32479;&#38169;&#35823;&#26102;&#23601;&#21487;&#26597;&#30475;&#27492;&#30446;&#24405;&#19979;&#26085;&#24535;&#25991;&#20214;&#12290;(&#26681;&#25454;&#37197;&#32622;&#23450;&#20041;,&#21487;&#33021;&#27809;&#26377;&#36825;&#20010;&#30446;&#24405;)
</span>pg_xact         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#20132;&#26085;&#24535;commit log&#30340;&#30446;&#24405;,pg 9&#20043;&#21069;&#21483;pg_clog
</span>pg_multixact&#8203;    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20849;&#20139;&#34892;&#38145;&#30340;&#20107;&#21153;&#29366;&#24577;&#25968;&#25454;
</span>pg_notify       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24322;&#27493;&#28040;&#24687;&#30456;&#20851;&#30340;&#29366;&#24577;&#25968;&#25454;
</span>pg_serial       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20018;&#34892;&#38548;&#31163;&#32423;&#21035;&#30340;&#20107;&#21153;&#29366;&#24577;&#25968;&#25454;
</span>pg_snapshots    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23384;&#20648;&#25191;&#34892;&#20102;&#20107;&#21153;snapshot&#23548;&#20986;&#30340;&#29366;&#24577;&#25968;&#25454;
</span>pg_stat_tmp     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32479;&#35745;&#20449;&#24687;&#30340;&#20020;&#26102;&#25991;&#20214;
</span>pg_subtrans     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23376;&#20107;&#21153;&#29366;&#24577;&#25968;&#25454;
</span>pg_stat         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32479;&#35745;&#20449;&#24687;&#30340;&#23384;&#20648;&#30446;&#24405;&#12290;&#20851;&#38381;&#26381;&#21153;&#26102;,&#23558;pg_stat_tmp&#30446;&#24405;&#20013;&#30340;&#20869;&#23481;&#31227;&#21160;&#33267;&#27492;&#30446;&#24405;&#23454;&#29616;&#20445;&#23384;
</span>pg_stat_tmp     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32479;&#35745;&#20449;&#24687;&#30340;&#20020;&#26102;&#23384;&#20648;&#30446;&#24405;&#12290;&#24320;&#21551;&#25968;&#25454;&#24211;&#26102;&#23384;&#25918;&#32479;&#35745;&#20449;&#24687;
</span>pg_tblsp        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23384;&#20648;&#20102;&#25351;&#21521;&#21508;&#20010;&#29992;&#25143;&#33258;&#24314;&#34920;&#31354;&#38388;&#23454;&#38469;&#30446;&#24405;&#30340;&#38142;&#25509;&#25991;&#20214;
</span>pg_twophase     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;&#20004;&#38454;&#27573;&#25552;&#20132;&#21151;&#33021;&#26102;&#20998;&#24067;&#24335;&#20107;&#21153;&#30340;&#23384;&#20648;&#30446;&#24405;
</span>pg_wal          <span style="color: #b22222;">#</span><span style="color: #b22222;">WAL&#26085;&#24535;&#30340;&#30446;&#24405;,&#26089;&#26399;&#29256;&#19968;&#26412;&#30446;&#24405;&#20026;pg_xlog
</span>PG_VERSION      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#29256;&#26412;
</span>postmaster.opts <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35760;&#24405;&#25968;&#25454;&#24211;&#21551;&#21160;&#26102;&#30340;&#21629;&#20196;&#34892;&#36873;&#39033;
</span>postmaster.pid  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#21551;&#21160;&#30340;&#20027;&#36827;&#31243;&#20449;&#24687;&#25991;&#20214;&#65292;&#21253;&#25324;PID&#65292;SPGDATA&#30446;&#24405;,
</span>                &#25968;&#25454;&#24211;&#21551;&#21160;&#26102;&#38388;&#65292;&#30417;&#21548;&#31471;&#21475;&#65292;socket&#25991;&#20214;&#36335;&#24452;&#65292;&#20020;&#21548;&#22320;&#22336;,&#20849;&#20139;&#20869;&#23384;&#30340;&#22320;&#22336;&#20449;
                &#24687;(ipsc&#21487;&#26597;&#30475;),&#20027;&#36827;&#31243;&#29366;&#24577;
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 ~]#ll $<span style="color: #a0522d;">PGDATA</span>
</pre>
</div>

<p>
范例:
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 ~]#ls /pgsql/data
[root@ubuntu2004 ~]#cat /pgsql/data/PG_VERSION 14
[root@ubuntu2004 ~]#cat /pgsql/data/postgresql.auto.conf
<span style="color: #b22222;"># </span><span style="color: #b22222;">Do not edit this file manually!
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">It will be overwritten by the ALTER SYSTEM command.
</span>
[root@ubuntu2004 ~]#cat /pgsql/data/postmaster.opts
/apps/pgsql/bin/postgres <span style="color: #8b2252;">"-D"</span> <span style="color: #8b2252;">"/pgsql/data"</span>

postgres@ubuntu2004:~$ cat /pgsql/data/postmaster.pid
892
/pgsql/data
1579156864
5432
/tmp/
*
   5432001 0
ready

[root@ubuntu2004 ~]#find /tmp -type s -ls
</pre>
</div>
</div>
</div>
<div id="outline-container-postgresql.conf-配置项" class="outline-4">
<h4 id="postgresql.conf-配置项">postgresql.conf 配置项</h4>
<div class="outline-text-4" id="text-postgresql.conf-配置项">
<p>
PostgreSQL 的配置参数是在postgresql.conf文件中集中管理的，这个文件位于数据库实例的目录下$PGDATA
</p>

<ul class="org-ul">
<li>此文件中的每个参数配置项的格式都是“参数名=参数值”</li>
</ul>
<p>
-配置文件中可以使用“#”注释。
</p>
<ul class="org-ul">
<li>所有配置项的参数名都是大小写不敏感的</li>
<li>参数值有以下五种类型。
<ul class="org-ul">
<li>布尔:布尔值都是大小写无关的，可以是on、off、true,false、yes、no、1、0。</li>
<li>整数:数值可以指定单位。如一些内存配置的参数可以指定KB、MB、GB等单位。</li>
<li>另外还支持浮点数,字符串,枚举</li>
</ul></li>

<li>postgresql.conf文件中可以使用include指令包含其他文件中的配置内容，如:include filenamejj,如果指定被包含的文件名不是绝对路径，那么就相对于当前配置文件所在目录的相对路径。此外，包含还可以被嵌套。</li>
<li>所有的配置参数都在系统视图pg_settings中</li>
<li>$PGDATA目录下如果含有postgresql.conf和postgresql.auto.conf,而
postgresql.auto.conf的优先级高于postgresql.conf，即如果一个参数同时
存在postgresql.auto.conf和postgresql.conf里面，系统会先读
postgresql.auto.conf的参数配置</li>
</ul>



<p>
常用配置说明
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">listen_addresses</span>=<span style="color: #8b2252;">'*'</span>    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30417;&#21548;&#23458;&#25143;&#31471;&#30340;&#22320;&#22336;&#65292;&#40664;&#35748;&#26159;&#26412;&#22320;&#30340;&#65292;&#38656;&#35201;&#20462;&#25913;&#20026;*&#25110;&#32773;0.0.0.0
</span><span style="color: #a0522d;">port</span> = 5432             <span style="color: #b22222;">#</span><span style="color: #b22222;">pg&#31471;&#21475;&#65292;&#40664;&#35748;&#26159;5432
</span><span style="color: #a0522d;">max_connections</span> = 2000  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26368;&#22823;&#36830;&#25509;&#25968;&#65292;&#40664;&#35748;100
</span>unix_socket_directories <span style="color: #b22222;">#</span><span style="color: #b22222;">socket&#25991;&#20214;&#30340;&#20301;&#32622;&#65292;&#40664;&#35748;&#22312;/tmp&#19979;&#38754;
</span>shared_buffers          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#32531;&#23384;&#21306;&#65292;&#24314;&#35758;&#20540;1/4--1/2&#20027;&#26426;&#20869;&#23384;&#65292;&#21644;Oracle&#30340;buffer cache&#31867;&#20284;
</span>maintenance_work_mem    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32500;&#25252;&#24037;&#20316;&#20869;&#23384;&#65292;&#29992;&#20110;vacuum,create index,reindex&#31561;&#12290;&#24314;&#35758;&#20540;(1/4&#20027;&#26426;&#20869;&#23384;)/autovacuum_max_workers
</span>max_worker_processes    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24635;worker&#25968;
</span>max_parallel_workers_per_gather <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21333;&#26465;QUERY&#20013;&#65292;&#27599;&#20010;node&#26368;&#22810;&#20801;&#35768;&#24320;&#21551;&#30340;&#24182;&#34892;&#35745;&#31639;WORKER&#25968;
</span>wal_level               <span style="color: #b22222;">#</span><span style="color: #b22222;">wal&#32423;&#21035;&#65292;&#29256;&#26412;11+&#40664;&#35748;&#26159;replica
</span>wal_buffers             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31867;&#20284;Oracle&#30340;log buffer
</span>checkpoint_timeout      <span style="color: #b22222;">#</span><span style="color: #b22222;">checkpoint&#26102;&#38388;&#38388;&#38548;
</span>max_wal_size            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25511;&#21046;wal&#30340;&#26368;&#22823;&#25968;&#37327;
</span>min_wal_size            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25511;&#21046;wal&#30340;&#26368;&#23567;&#25968;&#37327;
</span>archive_command         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#24402;&#26723;&#21629;&#20196;&#65292;&#31034;&#20363;&#65306;'test ! -f /arch/%f &amp;&amp; cp %p /arch/%f'
</span>autovacuum              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#33258;&#21160;vacuum</span>
</pre>
</div>

<p>
范例: 查看系统配置
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">postgres</span>=# \d pg_settings;
               View <span style="color: #8b2252;">"pg_catalog.pg_settings"</span>
     Column      |  Type   | Collation | Nullable | Default 
-----------------+---------+-----------+----------+---------
 name            | text    |           |          | 
 setting         | text    |           |          | 
 unit            | text    |           |          | 
 category        | text    |           |          | 
 short_desc      | text    |           |          | 
 extra_desc      | text    |           |          | 
 context         | text    |           |          | 
 vartype         | text    |           |          | 
 <span style="color: #483d8b;">source</span>          | text    |           |          | 
 min_val         | text    |           |          | 
 max_val         | text    |           |          | 
 enumvals        | text[]  |           |          | 
 boot_val        | text    |           |          | 
 reset_val       | text    |           |          | 
 sourcefile      | text    |           |          | 
 sourceline      | <span style="color: #483d8b;">integer</span> |           |          | 
 pending_restart | boolean |           |          

<span style="color: #a0522d;">postgres</span>=# select name,short_desc,setting from pg_settings where name like <span style="color: #8b2252;">'listen_addresses'</span>;
       name       |                     short_desc                     | setting 
------------------+----------------------------------------------------+---------
 listen_addresses | Sets the host name or IP address(es) to listen to. | 0.0.0.0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#36816;&#34892;&#26102;&#21442;&#25968;
</span><span style="color: #a0522d;">postgres</span>=# show listen_addresses;
0.0.0.0
</pre>
</div>

<p>
范例：查看和修改配置
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">postgres</span>=# show timezone;
<span style="color: #0000ff;">Etc/UTC</span> (1 row)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21160;&#24577;&#20462;&#25913;&#37197;&#32622;
</span><span style="color: #a0522d;">postgres</span>=# set <span style="color: #a0522d;">timezone</span>=<span style="color: #8b2252;">"Asia/Shanghai"</span>;
<span style="color: #a0522d;">postgres</span>=# show timezone;
<span style="color: #0000ff;">Asia/Shanghai</span> (1 row)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26377;&#20123;&#21442;&#25968;&#19981;&#25903;&#25345;&#21160;&#24577;&#20462;&#25913;
</span><span style="color: #a0522d;">postgres</span>=# set <span style="color: #a0522d;">port</span>=1234;
ERROR: parameter <span style="color: #8b2252;">"port"</span> cannot be changed without restarting the server
</pre>
</div>

<p>
范例：postgresql.auto.conf 文件优先于postgresql.conf
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 ~]#vim /pgsql/data/postgresql.auto.conf
<span style="color: #b22222;"># </span><span style="color: #b22222;">Do not edit this file manually!
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">It will be overwritten by the ALTER SYSTEM command.
</span><span style="color: #a0522d;">port</span> = 1234

[root@ubuntu2004 ~]#vim /pgsql/data/postgresql.conf
<span style="color: #a0522d;">port</span> = 4321

[root@ubuntu2004 ~]#systemctl restart postgresql.service

[root@ubuntu2004 ~]#ss -ntlp|grep postmaster


postgres@ubuntu2004:~$ psql -p1234
<span style="color: #a0522d;">postgres</span>=# show port;
1234
</pre>
</div>
</div>
</div>
<div id="outline-container-pg_ident.conf" class="outline-4">
<h4 id="pg_ident.conf">pg_ident.conf</h4>
<div class="outline-text-4" id="text-pg_ident.conf">
<p>
pg_ident.conf是用户映射配置文件。结合pg_hba.conf文件，method为ident可以用特定的操作系统用户以指定的数据库用户身份登录数据库。
</p>

<p>
这个文件记录着与操作系统用户匹配的数据库用户，如果某操作系统用户在本文
件中没有映射用户，则默认的映射数据库用户与操作系统用户同名。比如，服务
器上有名为user1的操作系统用户，同时数据库上也有同名的数据库用户user1，
user1登录操作系统后可以直接输入psql，以user1数据库用户身份登录数据库且
不需密码
</p>

<p>
如果操作系统用户和数据库用户不同名,可以用下面格式进行映射
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">pg_ident.conf&#22914;&#19979;&#23454;&#29616;&#25805;&#20316;&#31995;&#32479;test&#29992;&#25143;&#26144;&#23556;&#20026;&#25968;&#25454;&#24211;&#29992;&#25143;dba
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">MAPNAME SYSTEM-USERNAME PG-USERNAME
</span>map1     test     dba

<span style="color: #b22222;">#</span><span style="color: #b22222;">pg_hba.conf&#22914;&#19979;:
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">TYPE DATABASE USER CIDR-ADDRESS METHOD
</span><span style="color: #483d8b;">local</span> all all ident <span style="color: #a0522d;">map</span>=map1
</pre>
</div>

<p>
范例: 操作系统用户和数据库用户同名
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 ~]#useradd -s /bin/bash -m dba
[root@ubuntu2004 ~]#su - postgres

postgres@ubuntu2004:~$ psql
<span style="color: #a0522d;">postgres</span>=# create user dba WITH PASSWORD <span style="color: #8b2252;">'123456'</span>;

[root@ubuntu2004 ~]#vim /pgsql/data/pg_hba.conf
<span style="color: #483d8b;">local</span> all all ident <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#26412;&#22320;&#25805;&#20316;&#31995;&#32479;&#36134;&#21495;&#21644;&#25968;&#25454;&#24211;&#36134;&#21495;&#21516;&#21517;&#65292;&#23601;&#21487;&#20197;&#33258;&#21160;&#20851;&#32852;&#30331;&#24405;
</span>
[root@ubuntu2004 ~]#pg_ctl -D /pgsql/data restart

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;&#36830;&#25509;
</span>[root@ubuntu2004 ~]#su - dba
dba@ubuntu2004:~$ psql postgres
<span style="color: #a0522d;">postgres</span>=&gt;
</pre>
</div>

<p>
范例: 操作系统用户和数据库用户不同名
</p>
<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 ~]#su - postgres
postgres@ubuntu2004:~$ psql
<span style="color: #a0522d;">postgres</span>=# create user dba WITH PASSWORD <span style="color: #8b2252;">'123456'</span>;

[root@ubuntu2004 ~]#useradd -s /bin/bash -m test

[root@ubuntu2004 ~]#vim /pgsql/data/pg_ident.conf
<span style="color: #b22222;"># </span><span style="color: #b22222;">MAPNAME SYSTEM-USERNAME PG-USERNAME
</span>map1 test dba

[root@ubuntu2004 ~]#vim /pgsql/data/pg_hba.conf
<span style="color: #483d8b;">local</span> all   all   ident <span style="color: #a0522d;">map</span>=map1
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#8203;&#22312;&#27492;&#34892;&#19978;&#38754;&#21152;&#19978;&#38754;&#34892;
</span><span style="color: #483d8b;">local</span> all   all  trust

[root@ubuntu2004 ~]#pg_ctl -D /pgsql/data restart

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27979;&#35797;&#36830;&#25509;
</span>[root@ubuntu2004 ~]#su - test

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#30331;&#24405;&#22833;&#36133;
</span>test@ubuntu2004:~$ psql
psql: error: connection to server on socket <span style="color: #8b2252;">"/tmp/.s.PGSQL.5432"</span> failed:
FATAL: Peer authentication failed for user <span style="color: #8b2252;">"test"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38656;&#35201;&#25351;&#23450;&#26144;&#23556;&#30340;&#25968;&#25454;&#24211;&#30340;&#29992;&#25143;&#21644;&#25968;&#25454;&#24211;
</span>test@ubuntu2004:~$ psql -Udba postgres
<span style="color: #a0522d;">postgres</span>=&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-数据文件" class="outline-4">
<h4 id="数据文件">数据文件</h4>
<div class="outline-text-4" id="text-数据文件">
<p>
PostgreSQL中的每个索引和表都是一个单独的文件，称为Segment。默认是每个大于1G的Segment会被分割pg_class.efilenode.1这样的文件。
Segment的大小可以在initdb时通过选项&#x2014;with-segsize=SEGSIZE指定
</p>

<p>
注意：truncate表之后relfilenode会变。对应的物理文件名字也会变。
</p>

<p>
Segment 物理位置
</p>
<pre class="example" id="org38cf647">
$PGDATA/BASE/DATABASE_OID/PG_CLASS.RELFILENODE
</pre>

<p>
范例: 数据文件路径
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 postgresql-14.2]#./configure --help|grep size
--with-blocksize=BLOCKSIZE
   <span style="color: #483d8b;">set</span> table block size<span style="color: #a020f0;"> in</span> kB [8]
--with-segsize=SEGSIZE
   <span style="color: #483d8b;">set</span> table segment size<span style="color: #a020f0;"> in</span> GB [1]
--with-wal-blocksize=BLOCKSIZE
   <span style="color: #483d8b;">set</span> WAL block size<span style="color: #a020f0;"> in</span> kB [8]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25968;&#25454;&#30446;&#24405;&#36335;&#24452;
</span><span style="color: #a0522d;">testdb</span>=# show data_directory;
/pgsql/data

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25968;&#25454;&#24211;&#30340;OID
</span><span style="color: #a0522d;">testdb</span>=# select oid,datname from pg_database;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#34920;&#30340;node
</span><span style="color: #a0522d;">testdb</span>=# select relfilenode from pg_class where <span style="color: #a0522d;">relname</span>=<span style="color: #8b2252;">'tb1'</span>;
relfilenode
16397

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#34920;&#30340;&#30446;&#24405;&#36335;&#24452;
</span><span style="color: #a0522d;">testdb</span>=# select pg_relation_filepath(<span style="color: #8b2252;">'tb1'</span>);
base/16384/16397

postgres@ubuntu2004:~$ ls -l $<span style="color: #a0522d;">PGDATA</span>/base/16384/16397
-rw------- 1 postgres postgres 8192 May 16 14:26 /pgsql/data/base/16384/16397
</pre>
</div>
</div>
</div>
<div id="outline-container-控制文件" class="outline-4">
<h4 id="控制文件">控制文件</h4>
<div class="outline-text-4" id="text-控制文件">
<p>
控制文件存放了数据库当前的状态，存放在PGDATA/global/pg_control
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">PG14&#29256;&#30340;&#25511;&#21046;&#25991;&#20214;
</span>postgres@ubuntu2004:~$ file /pgsql/data/global/pg_control
/pgsql/data/global/pg_control: PGP Secret Sub-key -

<span style="color: #b22222;">#</span><span style="color: #b22222;">PG12&#29256;&#30340;&#25511;&#21046;&#25991;&#20214;
</span>postgres@ubuntu2004:~$ file /pgsql/data/global/pg_control
/pgsql/data/global/pg_control: data


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25511;&#21046;&#25991;&#20214;&#20869;&#23481;
</span>postgres@ubuntu2004:~$ pg_controldata $<span style="color: #a0522d;">PGDATA</span>
pg_control version number:            1700
Catalog version number:               202406281
Database system identifier:           7434814718768345198
Database cluster state:              <span style="color: #a020f0;"> in</span> production <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#24403;&#21069;&#29366;&#24577;
</span>pg_control last modified:             Mon 11 Nov 2024 09:07:11 PM EST
Latest checkpoint location:           0/D173AF8
Latest checkpoint<span style="color: #8b2252;">'s REDO location:    0/D173AF8
Latest checkpoint'</span>s REDO WAL file:    00000001000000000000000D  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#39044;&#20889;&#26085;&#24535;
</span>Latest checkpoint<span style="color: #8b2252;">'s TimeLineID:       1
Latest checkpoint'</span>s PrevTimeLineID:   1
Latest checkpoint<span style="color: #8b2252;">'s full_page_writes: on
Latest checkpoint'</span>s NextXID:          0:802
Latest checkpoint<span style="color: #8b2252;">'s NextOID:          32827
Latest checkpoint'</span>s NextMultiXactId:  1
Latest checkpoint<span style="color: #8b2252;">'s NextMultiOffset:  0
Latest checkpoint'</span>s oldestXID:        730
Latest checkpoint<span style="color: #8b2252;">'s oldestXID'</span>s DB:   1
Latest checkpoint<span style="color: #8b2252;">'s oldestActiveXID:  0
Latest checkpoint'</span>s oldestMultiXid:   1
Latest checkpoint<span style="color: #8b2252;">'s oldestMulti'</span>s DB: 1
Latest checkpoint<span style="color: #8b2252;">'s oldestCommitTsXid:0
Latest checkpoint'</span>s newestCommitTsXid:0
Time of latest checkpoint:            Mon 11 Nov 2024 09:07:11 PM EST
Fake LSN counter for unlogged rels:   0/3E8
Minimum recovery ending location:     0/0
Min recovery ending loc<span style="color: #8b2252;">'s timeline:   0
Backup start location:                0/0
Backup end location:                  0/0
End-of-backup record required:        no
wal_level setting:                    replica
wal_log_hints setting:                off
max_connections setting:              1000
max_worker_processes setting:         8
max_wal_senders setting:              10
max_prepared_xacts setting:           0
max_locks_per_xact setting:           64
track_commit_timestamp setting:       off
Maximum data alignment:               8
Database block size:                  8192
Blocks per segment of large relation: 131072
WAL block size:                       8192
Bytes per WAL segment:                16777216
Maximum length of identifiers:        64
Maximum columns in an index:          32
Maximum size of a TOAST chunk:        1996
Size of a large-object chunk:         2048
Date/time type storage:               64-bit integers
Float8 argument passing:              by value
Data page checksum version:           0
Mock authentication nonce:            c8438a61af4513aba125b7c2e39f2cf9cea0545b5eaf729c7b0f6d8afb7cf31b</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-日志文件" class="outline-4">
<h4 id="日志文件">日志文件(重点)</h4>
<div class="outline-text-4" id="text-日志文件">
</div>
<div id="outline-container-日志种类" class="outline-5">
<h5 id="日志种类">日志种类</h5>
<div class="outline-text-5" id="text-日志种类">
<ul class="org-ul">
<li>运行日志： $PGDATA/log(pg10之前为$PGDATA/pg_log),默认不存在，需要开启配置项 logging_collector</li>
<li>在线重做日志：$PGDATA/pg_wal(pg10之前为$PGDATA/pg_xlog)</li>
<li>事务提交日志：$PGDATA/pg_xact (pg10之前为$PGDATA/pg_clog)</li>
<li>服务器日志：可以在启动的时候指定:pg_ctl start -l ./logfile</li>
</ul>
</div>
</div>
<div id="outline-container-运行日志" class="outline-5">
<h5 id="运行日志">运行日志</h5>
<div class="outline-text-5" id="text-运行日志">
</div>
<ul class="org-ul">
<li><a id="运行日志配置项"></a>运行日志配置项<br>
<div class="outline-text-6" id="text-运行日志配置项">
<div class="org-src-container">
<pre class="src src-sh">logging_collector:&#36825;&#20010;&#21442;&#25968;&#21551;&#29992;&#26085;&#24535;&#25910;&#38598;&#22120;&#65292;&#23427;&#26159;&#19968;&#20010;&#25429;&#25417;&#34987;&#21457;&#36865;&#21040;stderr&#30340;&#26085;&#24535;&#28040;&#24687;&#30340;&#21518;&#21488;&#36827;&#31243;&#65292;&#24182;&#19988;&#23427;&#20250;&#23558;&#36825;&#20123;&#28040;&#24687;&#37325;&#23450;&#21521;&#21040;&#26085;&#24535;&#25991;&#20214;&#20013;&#65307;&#40664;&#35748;&#26159;OFF&#65292;&#20462;&#25913;&#21442;&#25968;&#38656;&#35201;&#37325;&#21551;&#12290;

log_destination:&#26377;&#19977;&#31181;&#36755;&#20986;&#26041;&#27861;&#65292;stderr,csvlog,syslog&#65307;&#22312;windows&#19978;&#36824;&#25903;&#25345;eventlog&#12290;&#40664;&#35748;&#26159;stderr&#65292;&#22914;&#26524;&#20351;&#29992;csvlog&#30340;&#35805;&#65292;logging_collector&#24517;&#39035;&#24320;&#21551;&#12290;&#20063;&#21487;&#20197;&#21516;&#26102;&#20351;&#29992;csvlog&#21644;stderr&#65292;&#20250;&#35760;&#24405;&#20004;&#31181;&#26684;&#24335;&#30340;&#26085;&#24535;&#12290;

log_directory:&#25351;&#23450;&#26085;&#24535;&#30340;&#23384;&#25918;&#20301;&#32622;&#65292;&#40664;&#35748;&#26159;$<span style="color: #a0522d;">PGDATA</span>/log

log_filename:&#26085;&#24535;&#30340;&#21629;&#21517;&#26684;&#24335;&#65292;&#40664;&#35748;&#26159;postgresql-%Y-%m-%d_%H%M%S.log&#12290;&#25903;&#25345;strftime&#26684;&#24335;

log_file_mode:&#24403;logging_collector&#34987;&#21551;&#29992;&#26102;&#65292;&#36825;&#20010;&#21442;&#25968;&#35774;&#32622;&#26085;&#24535;&#25991;&#20214;&#30340;&#26435;&#38480;&#65288;&#22312;Windows&#19978;&#36825;&#20010;&#21442;&#25968;&#23558;&#34987;&#24573;&#30053;&#65289;&#12290;&#36825;&#20010;&#21442;&#25968;&#20540;&#24212;&#24403;&#26159;&#19968;&#20010;&#25968;&#23383;&#24418;&#24335;&#30340;&#27169;&#24335;&#65292;&#23427;&#21487;&#20197;&#34987;chmod&#21644;umask&#31995;&#32479;&#35843;&#29992;&#25509;&#21463;&#65288;&#35201;&#20351;&#29992;&#36890;&#24120;&#30340;&#21313;&#36827;&#21046;&#26684;&#24335;&#65292;&#35813;&#25968;&#23383;&#24517;&#39035;&#20197;&#19968;&#20010;0&#65288;&#38646;&#65289;&#24320;&#22987;&#65289;&#12290;&#40664;&#35748;&#30340;&#26435;&#38480;&#26159;0600&#65292;&#34920;&#31034;&#21482;&#26377;&#26381;&#21153;&#22120;&#25317;&#26377;&#32773;&#25165;&#33021;&#35835;&#21462;&#25110;&#20889;&#20837;&#26085;&#24535;&#25991;&#20214;&#12290;&#20854;&#20182;&#24120;&#29992;&#30340;&#35774;&#32622;&#26159;0640&#65292;&#23427;&#20801;&#35768;&#25317;&#26377;&#32773;&#30340;&#32452;&#25104;&#21592;&#35835;&#21462;&#25991;&#20214;&#12290;&#19981;&#36807;&#35201;&#27880;&#24847;&#20320;&#38656;&#35201;&#20462;&#25913;

log_directory&#20026;&#23558;&#25991;&#20214;&#23384;&#20648;&#22312;&#38598;&#31751;&#25968;&#25454;&#30446;&#24405;&#20043;&#22806;&#30340;&#26576;&#20010;&#20301;&#32622;&#65292;&#25165;&#33021;&#21033;&#29992;&#36825;&#20010;&#35774;&#32622;&#12290;

log_rotation_age:&#24403;logging_collector&#34987;&#21551;&#29992;&#26102;&#65292;&#36825;&#20010;&#21442;&#25968;&#20915;&#23450;&#19968;&#20010;&#20010;&#20307;&#26085;&#24535;&#25991;&#20214;&#30340;&#26368;&#38271;&#29983;&#21629;&#26399;&#12290;&#24403;&#36825;&#20123;&#20998;&#38047;&#36807;&#21435;&#21518;&#65292;&#19968;&#20010;&#26032;&#30340;&#26085;&#24535;&#25991;&#20214;&#23558;&#34987;&#21019;&#24314;&#12290;&#23558;&#36825;&#20010;&#21442;&#25968;&#35774;&#32622;&#20026;&#38646;&#23558;&#31105;&#29992;&#22522;&#20110;&#26102;&#38388;&#30340;&#26032;&#26085;&#24535;&#25991;&#20214;&#21019;&#24314;&#12290;

log_rotation_size:&#24403;logging_collector&#34987;&#21551;&#29992;&#26102;&#65292;&#36825;&#20010;&#21442;&#25968;&#20915;&#23450;&#19968;&#20010;&#20010;&#20307;&#26085;&#24535;&#25991;&#20214;&#30340;&#26368;&#22823;&#23610;&#23544;&#12290;&#24403;&#36825;&#20040;&#22810;&#21315;&#23383;&#33410;&#34987;&#21457;&#36865;&#21040;&#19968;&#20010;&#26085;&#24535;&#25991;&#20214;&#21518;&#65292;&#23558;&#21019;&#24314;&#19968;&#20010;&#26032;&#30340;&#26085;&#24535;&#25991;&#20214;&#12290;&#23558;&#36825;&#20010;&#21442;&#25968;&#35774;&#32622;&#20026;&#38646;&#23558;&#31105;&#29992;&#22522;&#20110;&#23610;&#23544;&#30340;&#26032;&#26085;&#24535;&#25991;&#20214;&#21019;&#24314;&#12290;

log_truncate_on_rotation:&#40664;&#35748;&#20026;off&#65292;&#35774;&#32622;&#20026;on&#30340;&#35805;&#65292;&#22914;&#26524;&#26032;&#24314;&#20102;&#19968;&#20010;&#21516;&#21517;&#30340;&#26085;&#24535;&#25991;&#20214;&#65292;&#21017;&#20250;&#28165;&#31354;&#21407;&#26469;&#30340;&#25991;&#20214;&#65292;&#20877;&#20889;&#20837;&#26085;&#24535;&#65292;&#32780;&#19981;&#26159;&#22312;&#21518;&#38754;&#36861;&#21152;&#12290;

log_min_messages:&#25511;&#21046;&#21738;&#20123;&#28040;&#24687;&#32423;&#21035;&#34987;&#20889;&#20837;&#21040;&#26381;&#21153;&#22120;&#26085;&#24535;&#12290;&#26377;&#25928;&#20540;&#26159;DEBUG5&#12289;DEBUG4&#12289; DEBUG3&#12289; DEBUG2&#12289;DEBUG1&#12289;INFO&#12289;NOTICE&#12289;WARNING&#12289; ERROR&#12289;LOG&#12289;FATAL&#21644; PANIC&#12290;&#27599;&#20010;&#32423;&#21035;&#37117;&#21253;&#25324;&#20197;&#21518;&#30340;&#25152;&#26377;&#32423;&#21035;&#12290;&#32423;&#21035;&#36234;&#38752;&#21518;&#65292;&#34987;&#21457;&#36865;&#30340;&#28040;&#24687;&#36234;&#23569;&#12290;&#40664;&#35748;&#20540;&#26159;WARNING&#12290;

log_min_error_statement:&#25511;&#21046;&#21738;&#20123;&#23548;&#33268;&#38169;&#35823;&#24773;&#20917;&#30340; SQL&#35821;&#21477;&#34987;&#35760;&#24405;&#22312;&#26381;&#21153;&#22120;&#26085;&#24535;&#20013;&#12290;&#12290;&#40664;&#35748;&#20540;&#26159;ERROR&#65292;&#35201;&#26377;&#25928;&#22320;&#20851;&#38381;&#35760;&#24405;&#38169;&#35823;&#35821;&#21477;&#65292;&#23558;&#36825;&#20010;&#21442;&#25968;&#35774;&#32622;&#20026;PANIC&#12290;

log_min_duration_statement:&#30456;&#24403;&#20110;mysql&#30340;long_query_time&#65292;&#35760;&#24405;&#24930;SQL&#65292;&#36229;&#36807;&#36825;&#20010;&#26102;&#38388;&#30340;SQL&#23558;&#20250;&#34987;&#35760;&#24405;&#21040;&#26085;&#24535;&#37324;&#12290;&#20197;ms&#20026;&#21333;&#20301;

log_checkpoints:&#23548;&#33268;&#26816;&#26597;&#28857;&#21644;&#37325;&#21551;&#28857;&#34987;&#35760;&#24405;&#22312;&#26381;&#21153;&#22120;&#26085;&#24535;&#20013;&#12290;&#19968;&#20123;&#32479;&#35745;&#20449;&#24687;&#20063;&#34987;&#21253;&#25324;&#22312;&#26085;&#24535;&#28040;&#24687;&#20013;&#65292;&#21253;&#25324;&#20889;&#20837;&#32531;&#20914;&#21306;&#30340;&#25968;&#25454;&#21644;&#20889;&#23427;&#20204;&#25152;&#33457;&#30340;&#26102;&#38388;&#12290;

log_connections:&#23548;&#33268;&#27599;&#19968;&#27425;&#23581;&#35797;&#23545;&#26381;&#21153;&#22120;&#30340;&#36830;&#25509;&#34987;&#35760;&#24405;&#65292;&#23458;&#25143;&#31471;&#35748;&#35777;&#30340;&#25104;&#21151;&#23436;&#25104;&#20063;&#20250;&#34987;&#35760;&#24405;&#12290;&#21482;&#26377;&#36229;&#32423;&#29992;&#25143;&#33021;&#22312;&#20250;&#35805;&#24320;&#22987;&#26102;&#26356;&#25913;&#36825;&#20010;&#21442;&#25968;&#65292;&#22312;&#20250;&#35805;&#20013;&#23427;&#19981;&#33021;&#34987;&#26356;&#25913;&#12290;&#40664;&#35748;&#20026;off&#12290;

log_disconnections:&#23548;&#33268;&#20250;&#35805;&#32456;&#27490;&#20063;&#20250;&#34987;&#35760;&#24405;&#12290;&#26085;&#24535;&#36755;&#20986;&#25552;&#20379;&#30340;&#20449;&#24687;&#31867;&#20284;&#20110;log_connections&#65292;&#19981;&#36807;&#36824;&#22806;&#21152;&#20250;&#35805;&#30340;&#25345;&#32493;&#26102;&#38388;&#12290;&#21482;&#26377;&#36229;&#32423;&#29992;&#25143;&#33021;&#22312;&#20250;&#35805;&#24320;&#22987;&#26102;&#26356;&#25913;&#36825;&#20010;&#21442;&#25968;&#65292;&#22312;&#20250;&#35805;&#20013;&#23427;&#19981;&#33021;&#34987;&#26356;&#25913;&#12290;&#40664;&#35748; &#20026;off&#12290;

log_duration:&#23548;&#33268;&#27599;&#19968;&#20010;&#23436;&#25104;&#30340;&#35821;&#21477;&#30340;&#25345;&#32493;&#26102;&#38388;&#34987;&#35760;&#24405;&#12290;&#40664;&#35748;&#20540;&#26159;off&#12290;&#22914;&#26524;log_duration&#20026;on&#24182;&#19988;log_min_duration_statement&#20026;&#27491;&#20540;&#65292;&#25152;&#26377;&#25345;&#32493;&#26102;&#38388;&#37117;&#23558;&#34987;&#35760;&#24405;&#65292;&#20294;&#26159;&#21482;&#26377;&#36229;&#36807;&#38408;&#20540;&#30340;&#35821;&#21477;&#25165;&#20250;&#34987;&#35760;&#24405;&#26597;&#35810;&#25991;&#26412;&#12290;&#36825;&#31181;&#34892;&#20026;&#26377;&#21161;&#20110;&#22312;&#39640;&#36127;&#36733;&#23433;&#35013;&#20013;&#25910;&#38598;&#32479;&#35745;&#20449;&#24687;&#12290;

log_error_verbosity:&#26377;&#25928;&#20540;&#26159;TERSE&#12289;DEFAULT&#21644;VERBOSE&#65292;&#40664;&#35748;&#20540;&#26159;default&#65292;&#25511;&#21046;&#27599;&#26465;&#26085;&#24535;&#20449;&#24687;&#30340;&#35814;&#32454;&#31243;&#24230;&#65292;VERBOSE&#36755;&#20986;&#21253;&#25324;SQLSTATE&#38169;&#35823;&#30721;&#65292;&#20197;&#21450;&#20135;&#29983;&#38169;&#35823;&#30340;&#28304;&#20195;&#30721;&#25991;&#20214;&#21517;&#12289;&#20989;&#25968;&#21517;&#21644;&#34892;&#21495;

log_hostname:&#40664;&#35748;&#24773;&#20917;&#19979;&#65292;&#36830;&#25509;&#26085;&#24535;&#28040;&#24687;&#21482;&#26174;&#31034;&#36830;&#25509;&#20027;&#26426;&#30340; IP&#22320;&#22336;&#12290;&#25171;&#24320;&#36825;&#20010;&#21442;&#25968;&#23558;&#23548;&#33268;&#20063;&#35760;&#24405;&#20027;&#26426;&#21517;&#12290;&#27880;&#24847;&#26681;&#25454;&#20320;&#30340;&#20027;&#26426;&#21517;&#35299;&#26512;&#35774;&#32622;&#65292;&#36825;&#21487;&#33021;&#20250;&#23548;&#33268;&#24456;&#24494;&#23567;&#30340;&#24615;&#33021;&#25439;&#22833;&#12290;

log_line_prefix:&#35774;&#32622;&#26085;&#24535;&#36755;&#20986;&#26684;&#24335;&#65288;&#33021;&#22815;&#35760;&#24405;&#26102;&#38388;&#65292;&#29992;&#25143;&#21517;&#31216;&#65292;&#25968;&#25454;&#24211;&#21517;&#31216;&#65292;&#23458;&#25143;&#31471;IP&#21644;&#31471;&#21475;&#65292;&#26041;&#20415;&#23450;&#20301;&#38382;&#39064;&#65289;&#40664;&#35748;&#20540;&#26159;<span style="color: #8b2252;">'%m [%p] '</span>&#65292;&#23427;&#35760;&#24405;&#26102;&#38388;&#25139;&#21644;&#36827;&#31243;ID&#12290;

log_lock_waits:&#25511;&#21046;&#24403;&#19968;&#20010;&#20250;&#35805;&#20026;&#33719;&#24471;&#19968;&#20010;&#38145;&#31561;&#21040;&#36229;&#36807;deadlock_timeout&#26102;&#65292;&#26159;&#21542;&#35201;&#20135;&#29983;&#19968;&#20010;&#26085;&#24535;&#28040;&#24687;&#12290;&#36825;&#26377;&#21161;&#20110;&#20915;&#23450;&#26159;&#21542;&#38145;&#31561;&#24453;&#36896;&#25104;&#20102;&#24615;&#33021;&#20302;&#19979;&#12290;&#40664;&#35748;&#20540;&#26159;off

log_statement:&#25511;&#21046;&#21738;&#20123; SQL &#35821;&#21477;&#34987;&#35760;&#24405;&#12290;&#26377;&#25928;&#20540;&#26159; none (off)&#12289;ddl&#12289;mod&#21644;all&#65288;&#25152;&#26377;&#35821;&#21477;&#65289;&#12290;&#40664;&#35748;&#20540;&#26159;none

log_replication_commands:&#27599;&#19968;&#20010;&#22797;&#21046;&#21629;&#20196;&#37117;&#34987;&#35760;&#24405;&#22312;&#26381;&#21153;&#22120;&#26085;&#24535;&#20013;&#12290;

log_temp_files:&#25511;&#21046;&#35760;&#24405;&#20020;&#26102;&#25991;&#20214;&#21517;&#21644;&#23610;&#23544;&#12290;&#20020;&#26102;&#25991;&#20214;&#21487;&#20197;&#34987;&#21019;&#24314;&#29992;&#26469;&#25490;&#24207;&#12289;&#21704;&#24076;&#21644;&#23384;&#20648;&#20020;&#26102;&#26597;&#35810;&#32467;&#26524;&#12290;&#19968;&#20010;&#38646;&#20540;&#35760;&#24405;&#25152;&#26377;&#20020;&#26102;&#25991;&#20214;&#20449;&#24687;&#65292;&#32780;&#27491;&#20540;&#21482;&#35760;&#24405;&#23610;&#23544;&#22823;&#20110;&#25110;&#31561;&#20110;&#25351;&#23450;&#21315;&#23383;&#33410;&#25968;&#30340;&#25991;&#20214;&#12290;&#40664;&#35748;&#35774;&#32622;&#20026;-1&#65292;&#23427;&#31105;&#29992;&#36825;&#31181;&#35760;&#24405;&#12290;

log_timezone:&#35774;&#32622;&#22312;&#26381;&#21153;&#22120;&#26085;&#24535;&#20013;&#20889;&#20837;&#30340;&#26102;&#38388;&#25139;&#30340;&#26102;&#21306;&#12290;&#40664;&#35748;&#20540;&#26159;GMT&#12290;
</pre>
</div>
</div>
</li>
<li><a id="将csv格式运行日志存储至数据库"></a>将csv格式运行日志存储至数据库<br>
<div class="outline-text-6" id="text-将csv格式运行日志存储至数据库">
<div class="org-src-container">
<pre class="src src-sh">postgres@ubuntu2004:~$ vim /pgsql/data/postgresql.conf
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#19979;&#38754;&#20004;&#34892;
</span><span style="color: #a0522d;">log_destination</span> = <span style="color: #8b2252;">'csvlog'</span>
<span style="color: #a0522d;">logging_collector</span> = on

postgres@ubuntu2004:~$ pg_ctl restart

postgres@ubuntu2004:~$ psql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20808;&#21019;&#24314;&#23545;&#24212;&#30340;&#34920;&#32467;&#26500;&#65292;&#21482;&#36866;&#29992;&#20110;PG12
</span><span style="color: #a0522d;">testdb</span>=#CREATE TABLE pg_log(
log_time timestamp(3) with time zone,
user_name text,
database_name text,
process_id integer,
connection_from text,
session_id text,
session_line_num bigint,
command_tag text,
session_start_time timestamp with time zone,
virtual_transaction_id text,
transaction_id bigint,
error_severity text,
sq1_state_code text,
message text,
detail text,
hint text,
interna7_query text,
interna7_query_pos integer,
context text,
query text,
query_pos integer,
location text,
application_name text,
PRIMARY KEY (session_id,session_line_num)
);

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;csv&#25991;&#20214;&#20013;&#30340;&#26085;&#24535;&#23548;&#20837;&#21040;&#34920;&#20013;
</span><span style="color: #a0522d;">testdb</span>=# copy pg_log from <span style="color: #8b2252;">'/pgsql/data/log/postgresql-2020-10-07_090454.csv'</span> with csv;
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:391dffc6-1380-4396-99ec-de21487c1124" class="outline-5">
<h5 id="h:391dffc6-1380-4396-99ec-de21487c1124">在线WAL日志</h5>
<div class="outline-text-5" id="text-h:391dffc6-1380-4396-99ec-de21487c1124">
<p>
Online WAL(WRITE-AHEAD LOG)日志功能是为了保证崩溃后的安全，如果系统崩溃，可以"重放"从最后一次检查点以来的日志项来恢复数据库的一致性。但是也存在日志膨胀的问题,相当于MySQL的事务日志redolog
</p>

<p>
参考文档: <a href="https://www.postgresql.org/docs/17/runtime-config-wal.html">https://www.postgresql.org/docs/17/runtime-config-wal.html</a>
</p>

<p>
<b>Online WAL 日志文件位置</b>
</p>

<pre class="example" id="org9451a53">
wal文件存放在$PGDATA/pg_wal下。PG10之前为pg_xlog
</pre>


<p>
<b>设置Online WAL日志的大小</b>
</p>


<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#23454;&#20363;&#26102;&#65292;&#21487;&#20197;&#25351;&#23450;&#21333;&#20010;WAL&#25991;&#20214;&#30340;&#22823;&#23567;&#65292;&#40664;&#35748;16M
</span>initdb  --wal-segsize=SIZE

<span style="color: #b22222;">#</span><span style="color: #b22222;">WAL&#26085;&#24535;&#24635;&#30340;&#22823;&#23567;&#40664;&#35748;&#20540;
</span><span style="color: #a0522d;">max_wal_size</span> = 1GB
<span style="color: #a0522d;">min_wal_size</span> = 80MB

<span style="color: #0000ff;">max_wal_size</span> (<span style="color: #483d8b;">integer</span>)
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#33258;&#21160;WAL&#26816;&#26597;&#28857;&#20043;&#38388;&#20801;&#35768;WAL&#22686;&#38271;&#21040;&#30340;&#26368;&#22823;&#23610;&#23544;&#12290;&#36825;&#26159;&#19968;&#20010;&#36719;&#38480;&#21046;&#65292;&#22312;&#29305;&#27530;&#30340;&#24773;&#20917;&#19979;WAL&#23610;&#23544;&#21487;&#33021;&#20250;&#36229;&#36807;
</span>max_wal_size&#65292;&#20363;&#22914;&#22312;&#37325;&#24230;&#36127;&#33655;&#19979;&#12289; archive_command&#22833;&#36133;&#25110;&#32773;&#39640;&#30340;wal
keep_segments&#35774;&#32622;&#12290;&#22914;&#26524;&#25351;&#23450;&#20540;&#26102;&#27809;&#26377;&#21333;&#20301;&#65292;&#21017;&#20197;&#20806;&#23383;&#33410;&#20026;&#21333;&#20301;&#12290;&#40664;&#35748;&#20026;1GB&#12290;&#22686;&#21152;&#36825;&#20010;&#21442;&#25968;&#21487;&#33021;&#23548;&#33268;&#23849;&#28291;
&#24674;&#22797;&#25152;&#38656;&#30340;&#26102;&#38388;&#12290;&#36825;&#20010;&#21442;&#25968;&#21482;&#33021;&#22312;postgresql.conf&#25110;&#32773;&#26381;&#21153;&#22120;&#21629;&#20196;&#34892;&#20013;&#35774;&#32622;&#12290;

<span style="color: #0000ff;">min_wal_size</span> (<span style="color: #483d8b;">integer</span>)
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#35201;WAL&#30913;&#30424;&#29992;&#37327;&#20445;&#25345;&#22312;&#36825;&#20010;&#35774;&#32622;&#20043;&#19979;&#65292;&#22312;&#26816;&#26597;&#28857;&#26102;&#26087;&#30340;WAL&#25991;&#20214;&#24635;&#26159;&#34987;&#22238;&#25910;&#20197;&#20415;&#26410;&#26469;&#20351;&#29992;&#65292;&#32780;&#19981;&#26159;&#30452;&#25509;&#34987;
</span>&#21024;&#38500;&#12290;&#36825;&#21487;&#20197;&#34987;&#29992;&#26469;&#30830;&#20445;&#26377;&#36275;&#22815;&#30340;WAL&#31354;&#38388;&#34987;&#20445;&#30041;&#26469;&#24212;&#20184;WAL&#20351;&#29992;&#30340;&#39640;&#23792;&#65292;&#20363;&#22914;&#36816;&#34892;&#22823;&#22411;&#30340;&#25209;&#22788;&#29702;&#20219;&#21153;&#12290;
&#22914;&#26524;&#25351;&#23450;&#20540;&#26102;&#27809;&#26377;&#21333;&#20301;&#65292;&#21017;&#20197;&#20806;&#23383;&#33410;&#20026;&#21333;&#20301;&#12290;&#40664;&#35748;&#26159;80MB&#12290;&#36825;&#20010;&#21442;&#25968;&#21482;&#33021;&#22312;postgresql.conf
&#25110;&#32773;&#26381;&#21153;&#22120;&#21629;&#20196;&#34892;&#20013;&#35774;&#32622;&#12290;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;:PG9.4&#20043;&#21069;&#29256;&#26412;&#20013;&#30340;checkout_segments&#21487;&#20197;&#25351;&#23450;&#22312;&#33258;&#21160;&#30340;WAL&#26816;&#26597;&#28857;&#20043;&#38388;&#30340;&#26085;&#24535;&#25991;&#20214;&#27573;&#30340;&#26368;&#22823;&#25968;&#37327;
</span>(&#36890;&#24120;&#27599;&#20010;&#27573;16&#20806;&#23383;&#33410;)&#12290;&#32570;&#30465;&#26159;3&#12290;&#20174;PG9.5&#24320;&#22987;&#28120;&#27760;&#27492;&#37197;&#32622;&#39033;,&#29992;max_wal_size&#21644;min_wal_size&#20195;&#26367;
</pre>
</div>

<p>
范例：创建一个表，10万条记录
</p>
<div class="org-src-container">
<pre class="src src-sh">\c hellodb
create table emp(id int, name char(10), age int);

create or replace <span style="color: #a020f0;">function</span> <span style="color: #0000ff;">for_loop</span>()
returns void as $<span style="color: #a0522d;">$</span>
begin
    <span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> 1..100000 loop
         INSERT INTO emp(<span style="color: #8b2252;">"id"</span>, <span style="color: #8b2252;">"name"</span>, <span style="color: #8b2252;">"age"</span>) VALUES (i, <span style="color: #8b2252;">'user1'</span>, 20);
    end loop;
end;

$<span style="color: #a0522d;">$</span> language plpgsql;
<span style="color: #a020f0;">select</span> for_loop();
<span style="color: #a020f0;">select</span> count(*) from emp;


<span style="color: #b22222;">#</span><span style="color: #b22222;">WAL&#26085;&#24535;&#24635;&#30340;&#22823;&#23567;&#40664;&#35748;&#20540;
</span><span style="color: #a0522d;">hellodb</span>=# show max_wal_size;
 1GB

<span style="color: #a0522d;">hellodb</span>=# show min_wal_size;
 80MB
</pre>
</div>

<p>
<b>LSN和Online WAL文件命名格式</b>
</p>

<p>
LSN: Log Sequence Number 用于记录WAL文件当前的位置，这是WAL日志唯一的、全局的标识。
</p>

<p>
WAL日志中写入是有顺序的，所以必须得记录WAL日志的写入顺序。而LSN就是负责给每条产生的WAL日志记录唯一的编号
</p>

<p>
WAL 日志LSN编号规则:
</p>

<pre class="example" id="org038f97c">
高32位/低32位
</pre>

<p>
WAL 文件名称为16进制的24个字符组成，每8个字符一组
</p>

<p>
每组的意义如下:
</p>

<pre class="example" id="org8c1dc32">
00000001 00000000 00000001
时间线 逻辑id 物理id
其中前8位:00000001表示timeline
中间8位：00000000表示logid，即LSN高32位
最后8位：00000001表示logseg,即LSN低32位/（2**24）的值，即低32位中最高8位,16进制的高2位
</pre>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;LSN
</span><span style="color: #a0522d;">postgres</span>=# select pg_current_wal_lsn();
0/610001C0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;LSN&#23545;&#24212;&#30340;WAL&#26085;&#24535;&#25991;&#20214;
</span><span style="color: #a0522d;">postgres</span>=# select pg_walfile_name(pg_current_wal_lsn());
000000010000000000000061
</pre>
</div>


<p>
<b>查看LSN和WAL文件对应关系</b>
</p>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#20107;&#21153;ID
</span><span style="color: #a0522d;">postgres</span>=# select txid_current();
txid_current | 610

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;LSN&#21495;
</span><span style="color: #a0522d;">postgres</span>=# select pg_current_wal_lsn();
pg_current_wal_lsn | 0/610001C0  <span style="color: #b22222;">#</span><span style="color: #b22222;">61&#20195;&#29702;&#25991;&#20214;&#21517;&#65292;0001C0&#20026;&#20107;&#20214;&#21495;16&#36827;&#21046;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;LSN&#23545;&#24212;&#30340;WAL&#26085;&#24535;&#25991;&#20214;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">WAL&#26085;&#24535;&#25991;&#20214;&#20013;&#30340;&#26368;&#21518;8&#20301;&#30340;logseg&#21069;6&#20301;&#22987;&#32456;&#26159;0&#65292;&#26368;&#21518;&#20004;&#20301;&#26159;LSN&#30340;&#20302;32&#20301;&#30340;&#21069;&#20004;&#20301;&#12290;&#22914;&#19978;&#20363;&#20013;logseg&#26368;&#21518;&#20004;&#20301;&#26159;61&#65292;LSN&#20302;32&#20301;&#30340;&#21069;&#20004;&#20301;&#20063;&#26159;61&#12290;
</span><span style="color: #a0522d;">postgres</span>=# select pg_walfile_name(pg_current_wal_lsn());
pg_walfile_name | 000000010000000000000061

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;WAL&#26085;&#24535;&#20559;&#31227;&#37327;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">LSN&#22312;WAL&#26085;&#24535;&#25991;&#20214;&#20013;&#30340;&#20559;&#31227;&#37327;&#21363;LSN&#20302;32&#20301;&#20013;&#21518;24&#20301;&#23545;&#24212;&#30340;&#21313;&#36827;&#21046;&#20540;&#12290;&#22914;&#19978;&#38754;0001C0&#23545;&#24212;&#21313;&#36827;&#21046;&#21363;&#19979;&#38754;&#30340;448
</span><span style="color: #a0522d;">postgres</span>=# select pg_walfile_NAME_OFFSET(pg_current_wal_lsn());
pg_walfile_name_offset | (000000010000000000000061,448)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20107;&#20214;&#21495;16&#36827;&#21046;&#36716;&#25442; 
</span>postgres@debian:/pgsql/data$ echo <span style="color: #8b2252;">'obase=16; 448'</span> |bc
1C0


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25353;&#26102;&#38388;&#25490;&#24207;&#26174;&#31034;WAL&#25991;&#20214;&#21517;
</span><span style="color: #a0522d;">postgres</span>=#select * from pg_ls_waldir() order by modification asc;
</pre>
</div>

<p>
<b>切换WAL日志</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;WAL&#25991;&#20214;&#36798;&#21040;16M&#65292;&#33258;&#21160;&#20999;&#25442;&#21478;&#19968;&#20010;WAL
</span><span style="color: #a0522d;">postgres</span>=# select pg_switch_wal();

<span style="color: #b22222;">#</span><span style="color: #b22222;">PG10&#29256;&#26412;&#21069;&#29992;&#19979;&#38754;&#21629;&#20196;
</span><span style="color: #a0522d;">postgres</span>=# select pg_switch_xlog();
</pre>
</div>


<p>
<b>查看WAL文件内容</b>
</p>

<p>
命令pg_waldump可以查看WAL日志的具体内容
</p>

<p>
注意: pg_waldump执行结果中tx:后面的数字是txid,即事务ID，WAL中同一个事务的记录此值是相同的
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu2004 ~]#pg_waldump /pgsql/data/pg_wal/000000010000000000000022
</pre>
</div>

<p>
<b>创建恢复点</b>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20107;&#20808;&#21019;&#24314;&#24674;&#22797;&#28857;,&#23558;&#26469;&#21487;&#29992;&#23427;&#36827;&#34892;&#36824;&#21407;,&#30456;&#24403;&#20110;&#24555;&#29031;
</span><span style="color: #a0522d;">postgres</span>=# select pg_create_restore_point( <span style="color: #8b2252;">'test-restore-point'</span>);
</pre>
</div>
</div>
</div>
<div id="outline-container-h:aeecc827-eff0-4bd7-a3e4-69f135d34bf1" class="outline-5">
<h5 id="h:aeecc827-eff0-4bd7-a3e4-69f135d34bf1">归档WAL日志</h5>
<div class="outline-text-5" id="text-h:aeecc827-eff0-4bd7-a3e4-69f135d34bf1">
<p>
归档日志记录的是checkpoint前的WAL日志,即数据的历史日志,即把pg_wal里面的在线日志备份出来，功能上归档日志相当于MySQL的二进制日志
</p>

<p>
生产环境中为了保证数据高可用性，通常需要开启归档，当系统故障后可以通过归档的日志文件对数据进行恢复
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#24402;&#26723;&#38656;&#35201;&#24320;&#21551;&#22914;&#19979;&#21442;&#25968;:
</span><span style="color: #a0522d;">wal_level</span> = replica

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35813;&#21442;&#25968;&#30340;&#21487;&#36873;&#30340;&#20540;&#26377;minimal&#65292;replica&#21644;logical&#65292;wal&#30340;&#32423;&#21035;&#20381;&#27425;&#22686;&#39640;&#65292;&#22312;wal&#30340;&#20449;&#24687;&#20063;&#36234;&#22810;&#12290;&#30001;&#20110;
</span>minimal&#36825;&#19968;&#32423;&#21035;&#30340;wal&#19981;&#21253;&#21547;&#20174;&#22522;&#30784;&#30340;&#22791;&#20221;&#21644;wal&#26085;&#24535;&#37325;&#24314;&#25968;&#25454;&#30340;&#36275;&#22815;&#20449;&#24687;&#65292;&#22312;&#35813;&#27169;&#24335;&#19979;&#65292;&#26080;&#27861;&#24320;&#21551;wal&#26085;&#24535;&#24402;&#26723;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;PostgreSQL10&#24320;&#22987;&#65292;&#40664;&#35748;&#20351;&#29992;&#30340;replica&#27492;&#32423;&#21035;,&#20063;&#24314;&#35758;&#20351;&#29992;&#27492;&#32423;&#21035;,&#20043;&#21069;&#29256;&#26412;&#40664;&#35748;&#26159;&#26368;&#23567;&#32423;&#21035;minimal
</span>
<span style="color: #a0522d;">archive_mode</span> = on
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#36848;&#21442;&#25968;&#20026;on&#65292;&#34920;&#31034;&#25171;&#24320;&#24402;&#26723;&#22791;&#20221;,&#21487;&#36873;&#30340;&#21442;&#25968;&#20026;on,off,always &#40664;&#35748;&#20540;&#20026;off&#65292;&#25152;&#20197;&#35201;&#25163;&#21160;&#25171;&#24320;&#65292;&#38656;&#35201;&#37325;&#21551;&#26381;&#21153;&#29983;&#25928;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312; PostgreSQL&#20013;&#37197;&#32622;&#24402;&#26723;&#30340;&#26041;&#27861;&#26159;&#37197;&#32622;&#21442;&#25968;archive_command&#65292;&#21442;&#25968;&#30340;&#37197;&#32622;&#20540;&#21487;&#20197;&#26159;&#19968;&#20010;Unix&#21629;&#20196;&#65292;&#27492;&#21629;&#20196;&#25226;WAL&#26085;&#24535;&#25991;&#26723;&#25335;&#36125;&#21040;&#20854;&#20182;&#22320;&#26041;
</span><span style="color: #a0522d;">archive_command</span> = <span style="color: #8b2252;">'[ ! -f /archive/%f ] &amp;&amp; cp %p /archive/%f'</span>
<span style="color: #a0522d;">archive_command</span> = <span style="color: #8b2252;">'DIR=/archive/`date +%%F`;[ -d $DIR ] || mkdir -p $DIR;cp %p $DIR/%f'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35813;&#21442;&#25968;&#30340;&#40664;&#35748;&#20540;&#26159;&#19968;&#20010;&#31354;&#23383;&#31526;&#20018;&#65292;&#20540;&#21487;&#20197;&#26159;&#19968;&#26465;shell&#21629;&#20196;&#25110;&#32773;&#19968;&#20010;&#22797;&#26434;&#30340;shell&#33050;&#26412;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;"%p"&#34920;&#31034;&#23558;&#35201;&#24402;&#26723;&#30340;wal&#25991;&#20214;&#21253;&#21547;&#23436;&#25972;&#36335;&#24452;&#30340;&#20449;&#24687;&#30340;&#25991;&#20214;&#21517;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;"%f"&#20195;&#34920;&#19981;&#21253;&#21547;&#36335;&#24452;&#20449;&#24687;&#30340;wal&#25991;&#20214;&#30340;&#25991;&#20214;&#21517;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;:wal_level&#21644;archive_mode&#21442;&#25968;&#20462;&#25913;&#37117;&#38656;&#35201;&#37325;&#26032;&#21551;&#21160;&#25968;&#25454;&#24211;&#25165;&#21487;&#20197;&#29983;&#25928;&#12290;&#32780;&#20462;&#25913;archive_command&#21017;&#19981;&#38656;&#35201;&#12290;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26080;&#35770;&#24403;&#26102;&#26159;&#21542;&#38656;&#35201;&#24402;&#26723;&#65292;&#36825;&#35201;&#24314;&#35758;&#23558;&#19978;&#38754;&#20004;&#20010;&#21442;&#25968;&#24320;&#21551;</span>
</pre>
</div>

<p>
示例：本地归档备份
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">archive_mode</span> = on
<span style="color: #a0522d;">archive_command</span> = <span style="color: #8b2252;">'cp %p /pgsql/backup/%f'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#38754;&#30340;&#21629;&#20196;&#20013;&#8220;archive_mode = on&#8221;&#34920;&#31034;&#25171;&#24320;&#24402;&#26723;&#22791;&#20221;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#25968;archive_command&#30340;&#37197;&#32622;&#20540;&#26159;&#19968;&#20010;Unix&#30340;cp&#21629;&#20196;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21629;&#20196;&#20013;&#30340;%p&#34920;&#31034;&#22312;&#32447;WAL&#26085;&#24535;&#25991;&#20214;&#30340;&#20840;&#36335;&#24452;&#21517;&#31216;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">%f&#34920;&#31034;&#19981;&#21253;&#25324;&#36335;&#24452;&#30340;WAL&#26085;&#24535;&#25991;&#20214;&#21517;&#12290;</span>
</pre>
</div>

<p>
在实际执行时备份时，PostgreSQL会把%p替换成实际在线WAL日志文件的全路径名，并把%f替换成不包括路径的WAL日志名。
</p>

<p>
使用操作系统命令 scp还可以把WAL日志拷贝到其他机器上，从而实现对归档日志进行远程备份
</p>

<p>
示例： 远程归档备份
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">archive_mode</span> =on
<span style="color: #a0522d;">archive_command</span> = <span style="color: #8b2252;">'scp %p postgres@10.0.0.200:/pgsql/backup/%f'</span>
</pre>
</div>

<p>
使用上面拷贝WAL文件的方式来同步主、备数据库之间数据时，备库会落后主库
一个WAL日志文件，具体落后多长时间取决于主库上生成一个完整的WAL文件所需
要的时间。
</p>

<p>
范例: 启用归档
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#21442;&#25968;
</span>vim /pgsql/data/postgresql.conf
<span style="color: #a0522d;">wal_level</span> = replica <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27492;&#20026;&#40664;&#35748;&#20540;&#21487;&#20197;&#19981;&#20570;&#20462;&#25913; #- Archiving -
</span><span style="color: #a0522d;">archive_mode</span> = on
<span style="color: #b22222;">#</span><span style="color: #b22222;">archive_command = 'DIR=/archive/`date +%F`;[ -d $DIR ] || mkdir -p $DIR;cp %p $DIR/%f'
</span><span style="color: #a0522d;">archive_command</span> = <span style="color: #8b2252;">'DIR=/archive/`date +%%F`;[ -d $DIR ] || mkdir -p $DIR;cp %p $DIR/%f'</span>

mkdir /archive
chown -R postgres. /archive

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#21551;&#25968;&#25454;&#24211;
</span>pg_ctl restart -mf

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25554;&#20837;&#25968;&#25454;&#65292;&#26597;&#30475;&#24402;&#26723;
</span>\c testdb
create table t1 (id int);
insert into t1 values (generate_series(1,100000));
<span style="color: #a020f0;">select</span> ctid,* from t1;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35828;&#26126;:ctid&#34920;&#31034;&#25968;&#25454;&#25152;&#22312;&#30340;&#25968;&#25454;&#22359;&#30340;&#32534;&#21495;&#21450;&#20301;&#31227;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27604;&#22914;(0,1) &#34920;&#31034;&#31532;0&#20010;&#22359;&#20013;&#30340;&#31532;&#19968;&#26465;&#35760;&#24405;,&#22359;&#20174;0&#24320;&#22987;&#32534;&#21495;,&#35760;&#24405;&#20174;1&#24320;&#22987;&#32534;&#21495;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35302;&#21457;&#26816;&#26597;&#28857; checkpoint
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20999;&#25442;&#26085;&#24535;,&#21363;&#20351;&#24403;&#21069;&#26085;&#24535;&#25991;&#20214;&#19981;&#20877;&#20351;&#29992;,&#32780;&#20999;&#25442;&#20351;&#29992;&#19979;&#19968;&#20010;&#26085;&#24535;&#25991;&#20214;,&#22914;&#26524;&#24320;&#21551;&#24402;&#26723;,&#20250;&#33258;&#21160;&#35302;&#21457;&#23545;&#24403;&#21069;&#26085;&#24535;&#25991;&#20214;&#30340;&#24402;&#26723;
</span><span style="color: #a020f0;">select</span> pg_switch_wal();
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;
</span><span style="color: #a020f0;">select</span> pg_walfile_NAME_OFFSET(pg_current_wal_lsn());

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#24402;&#26723;
</span>
tree /archive/
/archive/
&#9492;&#9472;&#9472; 2020-07-18
&#9492;&#9472;&#9472; 000000010000000000000001
</pre>
</div>

<p>
范例: 远程归档
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;10.0.0.200&#30340;&#22791;&#20221;&#26381;&#21153;&#22120;&#19978;&#21019;&#24314;&#30446;&#24405;
</span>postgres@ubuntu2004:~$ mkdir /pgsql/backup/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;postgreSQL&#26381;&#21153;&#22120;&#19978;&#23454;&#29616;&#21040;10.0.0.200&#22791;&#20221;&#26381;&#21153;&#22120;&#19978;&#30340;key&#39564;&#35777;
</span>postgres@ubuntu2004:~$ ssh-keygen
postgres@ubuntu2004:~$ ssh-copy-id 10.0.0.200

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;postgreSQL&#26381;&#21153;&#22120;&#19978;&#20462;&#25913;&#37197;&#32622;
</span>postgres@ubuntu2004:~$ vim /pgsql/data/postgresql.conf
<span style="color: #b22222;"># </span><span style="color: #b22222;">- Archiving -
</span><span style="color: #a0522d;">archive_mode</span> = on
<span style="color: #a0522d;">archive_command</span> = <span style="color: #8b2252;">'scp %p 10.0.0.200:/pgsql/backup/%f'</span>

postgres@ubuntu2004:~$ pg_ctl -D /pgsql/data restart

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;postgreSQL&#26381;&#21153;&#22120;&#19978;&#25191;&#34892;&#22823;&#37327;&#25968;&#25454;&#26356;&#26032;
</span>postgres@ubuntu2004:~$ cat for_loop.sql
\c hellodb
create table emp(id int,name char(10),age int);

create or replace <span style="color: #a020f0;">function</span> <span style="color: #0000ff;">for_loop</span>()
returns void as $<span style="color: #a0522d;">$</span>
begin
<span style="color: #a020f0;">for</span> i<span style="color: #a020f0;"> in</span> 1..1000000 loop
INSERT INTO emp(<span style="color: #8b2252;">"id"</span>,<span style="color: #8b2252;">"name"</span>, <span style="color: #8b2252;">"age"</span>) VALUES (i,<span style="color: #8b2252;">'wang'</span>,20);
end loop;
end;

$<span style="color: #a0522d;">$</span> language plpgsql;
<span style="color: #a020f0;">select</span> for_loop();
<span style="color: #a020f0;">select</span> count(*) from emp;

postgres@ubuntu2004:~$ psql -f for_loop.sql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;10.0.0.200&#30340;&#22791;&#20221;&#26381;&#21153;&#22120;&#19978;&#21487;&#30475;&#21040;&#26085;&#24535;&#30340;&#22791;&#20221;&#20986;&#29616; postgres@ubuntu2004:~$
</span>ls /pgsql/backup/
000000010000000000000001   000000010000000000000003   000000010000000000000005  
000000010000000000000007   000000010000000000000009   000000010000000000000002  
000000010000000000000004   000000010000000000000006   000000010000000000000008  
00000001000000000000000A
</pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:1b94a09a-e70a-4966-bea4-3a6d89702db8" class="outline-2">
<h2 id="h:1b94a09a-e70a-4966-bea4-3a6d89702db8">PostgreSQL 备份恢复</h2>
<div class="outline-text-2" id="text-h:1b94a09a-e70a-4966-bea4-3a6d89702db8">
</div>
<div id="outline-container-备份说明" class="outline-3">
<h3 id="备份说明">备份说明</h3>
<div class="outline-text-3" id="text-备份说明">
<p>
防止数据丢失的最重要方法就是备份。这些数据丢失有的是因硬件损坏导致的，有的是因人为原因（如误操作）而导致的，也有因为应用程序的bug而误删数据等情况。
</p>

<p>
备份的内容包括:
</p>
<ul class="org-ul">
<li>数据(配置文件)</li>
<li>归档WAL日志</li>
<li>表空间目录</li>
</ul>

<p>
数据库备份方式
</p>
<ul class="org-ul">
<li>逻辑备份: 适用于跨版本和跨平台的备份恢. 类似于mysqldump</li>
<li>物理备份: 适用于小版本的恢复,但不支持跨平台和大版本. 磁盘文件</li>
</ul>
</div>
</div>
<div id="outline-container-逻辑备份" class="outline-3">
<h3 id="逻辑备份">逻辑备份</h3>
<div class="outline-text-3" id="text-逻辑备份">
<p>
PostgreSQL提供了pg_dump、pg_dumpall 命令进行数据库的逻辑备份。
</p>

<p>
两者的功能差不多，只是pg_dumpall是将一个PostgreSQL数据库集群全部转储到一个脚本文件中，而pg_dump命令可以选择一个数据库或部分表进行备份。
</p>

<p>
另外利用COPY命令也能对表和SQL子集进行备份,实现表的还原
</p>
</div>
<div id="outline-container-pg_dump和pg_dumpall" class="outline-4">
<h4 id="pg_dump和pg_dumpall">pg_dump和pg_dumpall</h4>
<div class="outline-text-4" id="text-pg_dump和pg_dumpall">
<p>
pg_dump是PostgreSQL提供的一个非常有用的数据库备份工具。它甚至可以在数据库正在使用的时候进行完整一致的备份。pg_dump工具执行时，可以将数据库备份成一个文本文件或归档文件，该文件中实际上包含了多个CREATE和INSERT语句，使用这些语句可以重新创建表和插入数据。
</p>

<p>
pg_dumpall工具可以存储一个数据库集群里的所有数据库到一个脚本文件。本质上pg_dumpall是通过对数据库集群里的每个数据库调用pg_dump实现这个功能。
</p>

<p>
pg_dumpall还可以备份出所有数据库公用的全局元数据对象。这些信息包括:数据库用户和组,密码以及适用于整个数据库的访问权限。而pg_dump并不保存这些对象。
</p>

<p>
pg_dump可生成归档格式的备份文件，然后与pg_restore配合使用，从而提供一种灵活的备份和恢复机制。
</p>

<p>
pg_dump可以将整个数据库备份到一个归档格式的备份文件中，而pg_restore则可从这个归档格式的备份文件中选择性地恢复部分表或数据库对象。归档格式的备份文件又分为两种，最灵活的输出文件格式是“custom”自定义格式（使用命令项参数-Fc来指定)，它允许对归档元素进行选取和重新排列，并且默认时是压缩的;另一种格式是tar格式(使用命令项参数-Ft来指定)，这种格式的文件不是压缩的，并且加载时不能重排列，但是它也很灵活，可以用标准UNIX下的 tar工具进行处理。
</p>

<p>
pg_dumpall只支持文本格式 pg_dump 的具体使用语法如下:
</p>

<div class="org-src-container">
<pre class="src src-sh">pg_dump [connection-option...] [option...] [dbname]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#36873;&#39033;&#21644;psql&#22522;&#26412;&#30456;&#21516;,pg_dump&#36830;&#25509;&#36873;&#39033;&#30340;&#21442;&#25968;&#22914;&#19979;
</span>-h host&#25110;--host=host <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#36816;&#34892;&#26381;&#21153;&#22120;&#30340;&#20027;&#26426;&#21517;&#12290;&#22914;&#26524;&#20197;&#26012;&#26464;&#24320;&#22836;&#65292;&#21017;&#34987;&#29992;&#20316;&#21040;UNIX&#22495;&#22871;&#25509;&#23383;&#30340;&#36335;&#24452;&#12290;&#40664;&#35748;&#24773;&#20917;&#19979;&#65292;&#22914;&#26524;&#35774;&#32622;&#20102;SPGHOST
</span>&#29615;&#22659;&#21464;&#37327;&#65292;&#21017;&#20174;&#27492;&#29615;&#22659;&#21464;&#37327;&#20013;&#33719;&#21462;&#65292;&#21542;&#21017;&#23581;&#35797;&#19968;&#20010;UNIX&#22495;&#22871;&#25509;&#23383;&#36830;&#25509;&#12290;

-p port&#25110;--port=port  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#26381;&#21153;&#22120;&#27491;&#22312;&#20390;&#21548;&#30340;TCP&#31471;&#21475;&#25110;&#26412;&#22320;UNIX&#22495;&#22871;&#25509;&#23383;&#25991;&#20214;&#30340;&#25193;&#23637;&#12290;
</span>&#40664;&#35748;&#24773;&#20917;&#19979;&#65292;&#22914;&#26524;&#35774;&#32622;&#20102;$<span style="color: #a0522d;">PGPORT&#29615;&#22659;&#21464;&#37327;</span>&#65292;&#21017;&#20174;&#27492;&#29615;&#22659;&#21464;&#37327;&#20013;&#33719;&#21462;&#65292;&#21542;&#21017;&#21462;&#20540;&#20026;&#40664;&#35748;&#31471;&#21475;5432(&#32534;&#35793;&#26102;&#21487;&#20197;&#25913;&#21464;&#36825;&#20010;&#40664;&#35748;&#31471;&#21475;)&#12290;

-U username&#25110;--username=username&#25351;&#23450;&#35201;&#36830;&#25509;&#30340;&#29992;&#25143;&#21517;&#12290;

-w&#25110;--no-password <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#19981;&#25552;&#31034;&#23494;&#30721;&#12290;&#23494;&#30721;&#21487;&#20197;&#36890;&#36807;&#20854;&#20182;&#26041;&#24335;&#22914;~/.pgpass&#25991;&#20214;&#33719;&#21462;
</span>
dbname <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#36830;&#25509;&#30340;&#25968;&#25454;&#24211;&#21517;&#65292;&#23454;&#38469;&#19978;&#20063;&#26159;&#35201;&#22791;&#20221;&#30340;&#25968;&#25454;&#24211;&#21517;&#12290;&#22914;&#26524;&#27809;&#26377;&#20351;&#29992;&#36825;&#20010;&#21442;&#25968;&#65292;&#21017;&#20351;&#29992;&#29615;&#22659;&#21464;&#37327;
</span>SPGDATABASE&#12290;&#22914;&#26524;SPGDATABASE &#20063;&#27809;&#22768;&#26126;&#65292;&#37027;&#20040;&#21487;&#20351;&#29992;&#21457;&#36215;&#36830;&#25509;&#30340;&#29992;&#25143;&#21517;&#12290;

<span style="color: #b22222;">#</span><span style="color: #b22222;">pg_dump&#19987;&#29992;&#36873;&#39033;
</span>-a&#25110;--data-only <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#20010;&#36873;&#39033;&#21482;&#26159;&#23545;&#32431;&#25991;&#26412;&#26684;&#24335;&#26377;&#24847;&#20041;&#12290;&#21482;&#36755;&#20986;&#25968;&#25454;&#65292;&#19981;&#36755;&#20986;&#25968;&#25454;&#23450;&#20041;&#30340;SQL&#35821;&#21477;&#12290;
</span>-b&#25110;--blobs <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#36716;&#20648;&#20013;&#26159;&#21542;&#21253;&#21547;&#22823;&#23545;&#35937;&#12290;&#38500;&#38750;&#25351;&#23450;&#20102;&#36873;&#25321;&#24615;&#36716;&#20648;&#30340;&#36873;&#39033;--schema&#12289;--table&#12289;--schema-only&#24320;&#20851;&#65292;
</span>&#21542;&#21017;&#40664;&#35748;&#20250;&#36716;&#20648;&#22823;&#23545;&#35937;&#12290;&#27492;&#36873;&#39033;&#20165;&#29992;&#20110;&#36873;&#25321;&#24615;&#36716;&#20648;&#26102;&#25511;&#21046;&#26159;&#21542;&#36716;&#20648;&#22823;&#23545;&#35937;&#12290;

-c&#25110;&#19968;clean <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#20010;&#36873;&#39033;&#21482;&#23545;&#32431;&#25991;&#26412;&#26684;&#24335;&#26377;&#24847;&#20041;&#12290;&#25351;&#23450;&#36755;&#20986;&#30340;&#33050;&#26412;&#20013;&#26159;&#21542;&#29983;&#25104;&#28165;&#29702;&#35813;&#25968;&#25454;&#24211;&#23545;&#35937;&#35821;&#21477;(&#22914;drop table&#21629;&#20196;)&#12290;
</span>
-C&#25110;--create <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#20010;&#36873;&#39033;&#21482;&#23545;&#32431;&#25991;&#26412;&#26684;&#24335;&#26377;&#24847;&#20041;&#12290;&#25351;&#23450;&#33050;&#26412;&#20013;&#26159;&#21542;&#36755;&#20986;&#19968;&#26465;create
</span>database&#35821;&#21477;&#21644;&#36830;&#25509;&#21040;&#35813;&#25968;&#25454;&#24211;&#30340;&#35821;&#21477;&#12290;&#19968;&#33324;&#22312;&#22791;&#20221;&#30340;&#28304;&#25968;&#25454;&#24211;&#19982;&#24674;&#22797;&#30340;&#30446;&#26631;&#25968;&#25454;&#24211;&#30340;&#21517;&#31216;&#19968;&#33268;&#26102;&#65292;&#25165;&#25351;&#23450;&#36825;&#20010;&#21442;&#25968;&#12290;

-E encoding&#25110;--encoding=encoding <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#25351;&#23450;&#30340;&#23383;&#31526;&#38598;&#32534;&#30721;&#21019;&#24314;&#36716;&#20648;&#12290;&#40664;&#35748;&#36716;&#20648;&#26159;&#20381;&#25454;&#25968;&#25454;&#24211;&#32534;&#30721;&#21019;&#24314;&#30340;&#12290;
</span>&#22914;&#26524;&#19981;&#25351;&#23450;&#27492;&#21442;&#25968;&#65292;&#21487;&#20197;&#36890;&#36807;&#35774;&#32622;&#29615;&#22659;&#21464;&#37327;SPGCLIENTENCODING&#36798;&#21040;&#30456;&#21516;&#30340;&#30446;&#30340;

-f file --file=file <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#21040;&#25351;&#23450;&#30340;&#25991;&#20214;&#20013;&#12290;&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;&#27492;&#21442;&#25968;,&#21017;&#36755;&#20986;&#21040;&#26631;&#20934;&#36755;&#20986;&#20013;&#12290;
</span>
-F format&#25110;--format=format <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36873;&#25321;&#36755;&#20986;&#30340;&#26684;&#24335;&#12290;format&#21487;&#20197;&#26159;p&#12289;c&#25110;t&#12290;
</span>p&#26159;plain &#30340;&#24847;&#24605;&#65292;&#20026;&#32431;&#25991;&#26412;SQL &#33050;&#26412;&#25991;&#20214;&#30340;&#26684;&#24335;&#65292;&#36825;&#26159;&#40664;&#35748;&#20540;&#12290;&#22823;&#24211;&#19981;&#33616;
c&#26159;custom&#30340;&#24847;&#24605;&#65292;&#20197;&#19968;&#20010;&#36866;&#21512;pg_restore&#20351;&#29992;&#30340;&#33258;&#23450;&#20041;&#20108;&#36827;&#21046;&#26684;&#24335;&#36755;&#20986;&#24182;&#24402;&#26723;&#12290;&#36825;&#26159;&#26368;&#28789;&#27963;&#30340;&#36755;&#20986;&#26684;&#24335;&#65292;&#22312;&#35813;&#26684;&#24335;&#20013;&#20801;&#35768;&#25163;&#21160;&#26597;&#35810;&#24182;&#19988;&#21487;&#20197;&#22312;pg
restore&#24674;&#22797;&#26102;&#37325;&#25490;&#24402;&#26723;&#39033;&#30340;&#39034;&#24207;&#12290;&#35813;&#26684;&#24335;&#40664;&#35748;&#26159;&#21387;&#32553;&#30340;&#12290;
t&#26159;tar&#30340;&#24847;&#24605;&#65292;&#20197;&#19968;&#20010;&#36866;&#21512;&#36755;&#20154;pg_restore&#30340;
tar&#26684;&#24335;&#36755;&#20986;&#24182;&#24402;&#26723;&#12290;&#35813;&#36755;&#20986;&#26684;&#24335;&#20801;&#35768;&#25163;&#21160;&#36873;&#25321;&#24182;&#19988;&#22312;&#24674;&#22797;&#26102;&#37325;&#25490;&#24402;&#26723;&#39033;&#30340;&#39034;&#24207;&#65292;&#20294;&#26159;&#36825;&#20010;&#37325;&#25490;&#24207;&#26159;&#26377;&#38480;&#21046;&#30340;&#65292;&#27604;&#22914;&#65292;&#34920;&#25968;&#25454;&#39033;&#30340;&#30456;&#20851;&#39034;&#24207;&#22312;&#24674;&#22797;&#26102;&#19981;&#33021;&#26356;&#25913;&#12290;&#21516;&#26102;&#65292;
tar&#26684;&#24335;&#19981;&#25903;&#25345;&#21387;&#32553;&#65292;&#24182;&#19988;&#23545;&#29420;&#31435;&#34920;&#30340;&#22823;&#23567;&#38480;&#21046;&#20026;8GB&#12290;

-n schema&#25110;--schema=schema <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#36716;&#20648;&#21305;&#37197;schema&#30340;&#27169;&#24335;&#20869;&#23481;&#65292;&#21253;&#25324;&#27169;&#24335;&#26412;&#36523;&#20197;&#21450;&#20854;&#20013;&#21253;&#21547;&#30340;&#23545;&#35937;&#12290;
</span>&#22914;&#26524;&#27809;&#26377;&#22768;&#26126;&#36825;&#20010;&#36873;&#39033;&#65292;&#25152;&#26377;&#30446;&#26631;&#25968;&#25454;&#24211;&#20013;&#30340;&#38750;&#31995;&#32479;&#27169;&#24335;&#37117;&#20250;&#34987;&#36716;&#20648;&#20986;&#26469;&#12290;&#21487;&#20197;&#20351;&#29992;&#22810;&#20010;-n&#36873;&#39033;&#25351;&#23450;&#22810;&#20010;&#27169;&#24335;&#12290;

-t table&#25110;--table=table <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#36716;&#20648;&#20986;&#21305;&#37197;table&#30340;&#34920;&#12289;&#35270;&#22270;&#12289;&#24207;&#21015;&#12290;&#21487;&#20197;&#20351;&#29992;&#22810;&#20010;-t&#36873;&#39033;&#21305;&#37197;&#22810;&#20010;&#34920;&#12290;&#21516;&#26679;table&#21442;&#25968;&#23558;&#25353;&#29031;psql
</span>&#30340;\d&#21629;&#20196;&#30340;&#35268;&#21017;&#34987;&#35299;&#37322;&#20026;&#21305;&#37197;&#27169;&#24335;&#65292;&#22240;&#27492;&#21487;&#20197;&#20351;&#29992;&#36890;&#37197;&#31526;&#21305;&#37197;&#22810;&#20010;&#27169;&#24335;&#12290;&#22312;&#20351;&#29992;&#36890;&#37197;&#31526;&#26102;&#65292;&#26368;&#22909;&#29992;&#24341;&#21495;&#36827;&#34892;&#30028;&#23450;&#65292;&#20197;&#38450;&#27490;shell&#23558;&#36890;&#37197;&#31526;&#36827;&#34892;&#25193;&#23637;&#12290;

-T table&#25110;--exclude-table=table <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#36716;&#20648;&#20219;&#20309;&#21305;&#37197;table&#27169;&#24335;&#30340;&#34920;&#12290;&#27169;&#24335;&#21305;&#37197;&#35268;&#21017;&#19982;t&#23436;&#20840;&#30456;&#21516;&#12290;
</span>&#21487;&#20197;&#25351;&#23450;&#22810;&#20010;-T&#20197;&#25490;&#38500;&#22810;&#31181;&#21305;&#37197;&#30340;&#34920;&#12290;&#22914;&#26524;&#21516;&#26102;&#25351;&#23450;&#20102;-t&#21644;-T&#65292;&#37027;&#20040;&#23558;&#21482;&#36716;&#20648;&#21305;&#37197;-t&#20294;&#19981;&#21305;&#37197;-T&#30340;&#34920;&#12290;&#22914;&#26524;&#20986;&#29616;&#20102;-T&#32780;&#26410;&#20986;&#29616;-t&#65292;&#37027;&#20040;&#21305;&#37197;-T&#30340;&#34920;&#19981;&#20250;&#34987;&#36716;&#20648;&#12290;
</pre>
</div>

<p>
使用pg_dump 的自定义备份或tar类型的备份需要使用pg_restore工具来恢复。
</p>

<p>
pg_restore命令的格式如下:
</p>
<div class="org-src-container">
<pre class="src src-sh">pg_restore [connection-option...] [option...] [filename]

pg_restore &#30340;&#36830;&#25509;&#21442;&#25968;&#19982;pg_dump&#22522;&#26412;&#30456;&#21516;&#65292;&#22914;&#19979;
-h host&#25110;--host=host
-p port&#25110;--port=port
-U username&#25110;--username=username-w&#25110;--no-password
-W&#25110;--password
-d dbname&#25110;--dbname=dbname <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#21516;&#20043;&#22788;&#22312;&#20110;&#65292;pg_restore&#20351;&#29992;-d&#30340;&#21442;&#25968;&#26469;&#36830;&#25509;&#25351;&#23450;&#30340;&#25968;&#25454;&#24211;&#24182;&#24674;&#22797;&#25968;&#25454;&#33267;&#27492;&#25968;&#25454;&#24211;
</span>filename <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35201;&#24674;&#22797;&#30340;&#22791;&#20221;&#25991;&#20214;&#30340;&#20301;&#32622;&#12290;&#22914;&#26524;&#27809;&#26377;&#22768;&#26126;&#65292;&#21017;&#20351;&#29992;&#26631;&#20934;&#36755;&#20837;&#12290;
</span>-a&#25110;--data-only <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#24674;&#22797;&#25968;&#25454;&#65292;&#32780;&#19981;&#24674;&#22797;&#34920;&#27169;&#24335;&#65288;&#25968;&#25454;&#23450;&#20041;)&#12290;
</span>-c&#25110;--clean <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#25968;&#25454;&#24211;&#23545;&#35937;&#21069;&#20808;&#28165;&#29702;&#65288;&#21024;&#38500;&#65289;&#23427;&#20204;&#12290;
</span>-C&#25110;--create <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#24674;&#22797;&#25968;&#25454;&#24211;&#20043;&#21069;&#20808;&#21019;&#24314;&#23427;&#12290;&#22914;&#26524;&#20986;&#29616;&#20102;&#36825;&#20010;&#36873;&#39033;&#65292;&#21644;-d&#22312;&#19968;&#36215;&#30340;&#25968;&#25454;&#24211;&#21517;&#21482;&#26159;&#29992;&#20110;&#21457;&#20986;&#26368;&#21021;&#30340;CREATE
</span>DATABASE&#21629;&#20196;&#65292;&#25152;&#26377;&#25968;&#25454;&#37117;&#24674;&#22797;&#21040;&#21517;&#23383;&#20986;&#29616;&#22312;&#24402;&#26723;&#20013;&#30340;&#25968;&#25454;&#24211;&#20013;&#12290;

-F format &#25110;--format=format <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#22791;&#20221;&#25991;&#20214;&#30340;&#26684;&#24335;&#12290;pg_restore&#21487;&#33258;&#21160;&#21028;&#26029;&#26684;&#24335;&#65292;&#22914;&#26524;&#19968;&#23450;&#35201;&#25351;&#23450;,&#23427;&#21487;&#20197;&#26159;t&#25110;c&#20043;&#19968;&#12290;
</span>t&#34920;&#31034; tar&#65292;&#25351;&#22791;&#20221;&#25991;&#20214;&#26159;&#19968;&#20010;tar&#25991;&#20214;&#12290;
c&#34920;&#31034;custom&#65292;&#22791;&#20221;&#30340;&#26684;&#24335;&#26159;&#26469;&#33258;pg_dump&#30340;&#33258;&#23450;&#20041;&#26684;&#24335;,&#36825;&#26159;&#26368;&#28789;&#27963;&#30340;&#26684;&#24335;&#65292;&#22240;&#20026;&#23427;&#20801;&#35768;&#23545;&#25968;&#25454;&#37325;&#26032;&#25490;&#24207;&#65292;&#20063;&#20801;&#35768;&#37325;&#36733;&#34920;&#27169;&#24335;&#20803;&#32032;&#65292;&#40664;&#35748;&#36825;&#20010;&#26684;&#24335;&#26159;&#21387;&#32553;&#30340;&#12290;

-n namespace&#25110;--schema=schema <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#24674;&#22797;&#25351;&#23450;&#21517;&#23383;&#30340;&#27169;&#24335;&#37324;&#30340;&#23450;&#20041;&#21644;/&#25110;&#25968;&#25454;&#12290;&#36825;&#20010;&#36873;&#39033;&#21487;&#20197;&#21644;-t&#36873;&#39033;&#19968;&#36215;&#20351;&#29992;&#65292;&#21482;&#24674;&#22797;&#19968;&#20010;&#34920;&#30340;&#25968;&#25454;&#12290;
</span>
-t table&#25110;--table=table <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#24674;&#22797;&#25351;&#23450;&#30340;&#34920;&#30340;&#23450;&#20041;&#21644;/&#25110;&#25968;&#25454;&#12290;&#21487;&#20197;&#19982;-n&#21442;&#25968;&#65288;&#25351;&#23450;schema)&#32852;&#21512;&#20351;&#29992;&#12290;</span>
</pre>
</div>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#21333;&#20010;&#25968;&#25454;&#24211;test&#20013;&#30340;&#25152;&#26377;&#34920;&#21040;&#25351;&#23450;&#30446;&#24405;,  &#27880;&#24847;&#65292;&#36825;&#26679;&#20889;&#27809;&#26377;&#21019;&#24314;&#24211;&#30340;SQL
</span>pg_dump -U postgres -f /backup/test_backup test

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;test&#25968;&#25454;&#24211;&#20013;&#30340;t1&#34920;&#21644;t2&#34920;&#8758;
</span>pg_dump -U postgres -t t1 -t t2 -f /backup/test_backup_t1_t2 test
</pre>
</div>

<p>
范例
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#25351;&#23450;&#25968;&#25454;&#24211;&#65292;&#27880;&#24847;&#65292;&#27809;&#26377;&#21019;&#24314;&#24211;&#30340;SQL
</span>pg_dump -d testdb &gt; /backup/testdb.sql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24674;&#22797;&#36807;&#31243;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;:&#20107;&#20808;&#38656;&#35201;&#23384;&#22312;&#25968;&#25454;&#24211;,&#19988;&#21024;&#38500;&#25152;&#26377;&#34920;&#21518;&#25165;&#33021;&#24674;&#22797;
</span>psql -d testdb &lt; /backup/testdb.sql
</pre>
</div>

<p>
范例：使用pg_dumpall备份所有的数据库，其操作和pg_dump类似
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#20840;&#37096;&#25968;&#25454;&#24211;&#65292;&#27599;&#20010;&#25968;&#25454;&#24211;&#37117;&#38656;&#35201;&#36755;&#20837;&#23494;&#30721;&#65292;&#26377;N&#20010;&#25968;&#25454;&#24211;&#65292;&#23601;&#38656;&#35201;&#36755;&#20837;N&#27425;&#23494;&#30721;
</span>pg_dumpall -U postgres -f full_backup.sql
gp_dumpall &gt; full_backup.sql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24674;&#22797;
</span>psql &lt; full_backup.sql
</pre>
</div>

<p>
范例: 使用pg_dump 和pg_restore备份还原
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#36830;&#25509;&#30340;&#26159;&#19968;&#20010;&#26412;&#22320;&#25968;&#25454;&#24211;&#65292;&#24182;&#19981;&#38656;&#35201;&#23494;&#30721;&#26102;&#65292;&#35201;&#23545;&#25968;&#25454;&#24211;hellodb&#36827;&#34892;&#22791;&#20221;&#65292;&#22791;&#20221;&#25991;&#20214;&#30340;&#26684;&#24335;&#26159;&#33050;&#26412;&#25991;&#20214;&#26684;&#24335;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26377;&#21019;&#24314;&#24211;&#30340;SQL
</span>pg_dump -C hellodb &gt; hellodb.sql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;pg_dump&#20063;&#21487;&#20197;&#22791;&#20221;&#19968;&#20010;&#36828;&#31243;&#30340;&#25968;&#25454;&#24211;&#65292;&#22914;&#19979;&#38754;&#30340;&#21629;&#20196;&#22791;&#20221;10.0.0.200&#26426;&#22120;&#19978;&#30340;hellodb&#25968;&#25454;&#24211;
</span>pg_dump -h 10.0.0.200 -U postgres -C hellodb &gt; hellodb.sql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#24819;&#29983;&#25104;&#30340;&#22791;&#20221;&#25991;&#20214;&#26684;&#24335;&#20026;&#33258;&#23450;&#20041;&#26684;&#24335;&#65292;&#21487;&#20197;&#20351;&#29992;&#19979;&#38754;&#30340;&#21629;&#20196;:
</span>pg_dump -Fc -h 10.0.0.200 -Upostgres hellodb &gt; hellodb.dump

file hellodb.dump
hellodb.dump: PostgreSQL custom database dump - v1.14-0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#21046;&#30340;&#26684;&#24335;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#22791;&#20221;&#30340;&#39033;&#30446;
</span>pg_restore -l hellodb.dump
[root@rocky8 ~]#pg_restore -l /backup/hellodb.dump
;
; Archive created at 2022-02-16 15:21:03 CST
; dbname: hellodb
; TOC Entries: 34
; Compression: -1
; Dump Version: 1.14-0
; Format: CUSTOM
; Integer: 4 bytes
; Offset: 8 bytes
; Dumped from database version: 14.2
; Dumped by pg_dump version: 14.2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25226;&#19978;&#36848;&#22791;&#20221;&#25991;&#20214;&#24674;&#22797;&#21040;&#21478;&#19968;&#20010;&#25968;&#25454;&#24211;hellodb2&#20013;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20808;&#21019;&#24314;&#25968;&#25454;&#24211;&#25165;&#33021;&#24674;&#22797;
</span>psql -U postgres -h 10.0.0.200 -c <span style="color: #8b2252;">"create database hellodb2"</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36824;&#21407;
</span>pg_restore -h 10.0.0.200 -U postgres -d hellodb2 hellodb.dump

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#22791;&#20221;&#25968;&#25454;&#24211;hellodb&#20013;&#30340;&#34920;students
</span>pg_dump -h 10.0.0.200 -Upostgres -t students hellodb &gt; students.sql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;schema1&#27169;&#24335;&#20013;&#25152;&#26377;&#20197;job&#24320;&#22836;&#30340;&#34920;&#65292;&#20294;&#26159;&#19981;&#21253;&#25324;job_log&#34920;
</span>pg_dump -t <span style="color: #8b2252;">'schema1.job*'</span> -T schema1.job_log hellodb &gt; schema1.emp.sql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#25152;&#26377;&#25968;&#25454;&#24211;&#23545;&#35937;&#65292;&#20294;&#26159;&#19981;&#21253;&#25324;&#21517;&#23383;&#20197;_log&#32467;&#23614;&#30340;&#34920;
</span>pg_dump -T <span style="color: #8b2252;">'*log'</span> hellodb &gt; log.sql

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20808;&#20174;10.0.0.200&#22791;&#20221;&#25968;&#25454;&#24211;hellodb&#65292;&#28982;&#21518;&#24674;&#22797;&#21040;10.0.0.100&#26426;&#22120;&#19978;
</span>pg_dump -h 10.0.0.200 -U postgres hellodb -Fc &gt; hellodb.dump
pg_restore -h 10.0.0.100 -U postgres -C -d postgres hellodb.dump
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;pg_restore&#21629;&#20196;&#20013;&#65292;-d&#20013;&#25351;&#23450;&#30340;&#25968;&#25454;&#24211;&#21487;&#20197;&#26159;10.0.0.200&#26426;&#22120;&#19978;&#23454;&#20363;&#20013;&#30340;&#20219;&#24847;&#25968;&#25454;&#24211;,pg_restore&#20165;&#29992;&#35813;&#25968;&#25454;&#24211;&#21517;&#31216;&#36827;&#34892;&#36830;&#25509;&#65292;
</span>-C &#34920;&#31034;&#20808;&#25191;&#34892;CREATE DATABASE&#21629;&#20196;&#21019;&#24314;hellodb&#25968;&#25454;&#24211;&#65292;&#28982;&#21518;&#20877;&#37325;&#26032;&#36830;&#25509;&#21040;
hellodb&#25968;&#25454;&#24211;&#65292;&#26368;&#21518;&#25226;&#22791;&#20221;&#30340;&#34920;&#21644;&#20854;&#20182;&#23545;&#35937;&#24314;&#21040;hellodb&#25968;&#25454;&#24211;&#20013;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#22791;&#20221;&#20986;&#26469;&#30340;&#25968;&#25454;&#37325;&#26032;&#21152;&#36733;&#21040;&#19968;&#20010;&#26032;&#24314;&#30340;&#19981;&#21516;&#21517;&#31216;&#30340;&#25968;&#25454;&#24211;hellodb2&#20013;
</span>createdb -T template0 hellodb2
pg_restore -d hellodb2 hellodb.dump
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#65292;&#19978;&#38754;&#30340;&#21629;&#20196;&#20174;template0&#32780;&#19981;&#26159;template1&#21019;&#24314;&#26032;&#25968;&#25454;&#24211;&#65292;&#30830;&#20445;&#24178;&#20928;&#12290;&#36825;&#37324;&#27809;&#26377;&#20351;&#29992;-C&#36873;&#39033;,&#32780;&#26159;&#30452;&#25509;&#36830;&#25509;&#21040;&#23558;&#35201;&#24674;&#22797;&#30340;&#25968;&#25454;&#24211;&#19978;&#12290;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0e1a59cc-31e0-4714-a120-176f1758632c" class="outline-4">
<h4 id="h:0e1a59cc-31e0-4714-a120-176f1758632c">COPY命令实现备份还原</h4>
<div class="outline-text-4" id="text-h:0e1a59cc-31e0-4714-a120-176f1758632c">
<p>
帮助文档 <a href="http://www.postgres.cn/docs/12/sql-copy.html">http://www.postgres.cn/docs/12/sql-copy.html</a>
</p>


<p>
COPY命令支持在PostgreSQL表和文件之间交换数据。
</p>

<p>
COPY TO把一个表的所有内容都拷贝到一个文件，而COPY FROM从一个文件里拷贝数据到一个表里(把数据附加到表中已经存在的内容里)。COPY TO还能拷贝SELECT查询的结果。
</p>

<p>
如果声明了一个字段列表，COPY将只在文件和表之间拷贝已声明字段的数据。如果表中有任何不在字段列表里的字段，那么COPY FROM将为那些字段插入缺省值。
</p>

<p>
带文件名的COPY指示PostgreSQL服务器直接从文件中读写数据。
如果声明了文件名，那么服务器必须可以访问该文件，而且文件名必须从服务器的角度声明。
如果使用了PROGRAM选项，则服务器会从指定的这个程序进行输入或是写入该程序作为输出。
如果使用了STDIN或STDOUT选项，那么数据将通过客户端和服务器之间的连接来传输。
</p>

<p>
命令：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20986;
</span>COPY { table_name [ ( column_name [, ...] ) ] | ( query ) }
       TO { <span style="color: #8b2252;">'filename'</span> | PROGRAM <span style="color: #8b2252;">'command'</span> | STDOUT } [ [ WITH ] ( option [, ...] ) ]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20837;&#65306;
</span>COPY table_name [ ( column_name [, ...] ) ]
        FROM { <span style="color: #8b2252;">'filename'</span> | PROGRAM <span style="color: #8b2252;">'command'</span> | STDIN } [ [ WITH ] ( option [,...] ) ]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24120;&#29992;&#21442;&#25968;&#35828;&#26126;&#65306;
</span>table_name &#29616;&#23384;&#34920;&#30340;&#21517;&#23383;(&#21487;&#20197;&#26377;&#27169;&#24335;&#20462;&#39280;)
column_name &#21487;&#36873;&#30340;&#24453;&#25335;&#36125;&#23383;&#27573;&#21015;&#34920;&#12290;&#22914;&#26524;&#27809;&#26377;&#22768;&#26126;&#23383;&#27573;&#21015;&#34920;&#65292;&#37027;&#20040;&#23558;&#20351;&#29992;&#25152;&#26377;&#23383;&#27573;
query &#19968;&#20010;&#24517;&#39035;&#29992;&#22278;&#25324;&#24359;&#21253;&#22260;&#30340;SELECT&#25110;VALUES&#21629;&#20196;&#65292;&#20854;&#32467;&#26524;&#23558;&#34987;&#25335;&#36125;
filename &#36755;&#20837;&#25110;&#36755;&#20986;&#25991;&#20214;&#30340;&#36335;&#24452;&#21517;&#12290;&#36755;&#20837;&#25991;&#20214;&#21517;&#21487;&#20197;&#26159;&#32477;&#23545;&#25110;&#26159;&#30456;&#23545;&#30340;&#36335;&#24452;&#65292;&#20294;&#36755;&#20986;&#25991;&#20214;&#21517;&#24517;&#39035;&#26159;&#32477;&#23545;&#36335;&#24452;&#12290;
Windows&#29992;&#25143;&#21487;&#33021;&#38656;&#35201;&#20351;&#29992;E&#8221;&#23383;&#31526;&#20018;&#21644;&#21452;&#21453;&#26012;&#32447;&#20316;&#20026;&#36335;&#24452;&#21517;&#31216;
PROGRAM &#38656;&#25191;&#34892;&#30340;&#31243;&#24207;&#21517;&#12290;&#22312;COPY
FROM&#21629;&#20196;&#20013;&#65292;&#36755;&#20837;&#26159;&#20174;&#31243;&#24207;&#30340;&#26631;&#20934;&#36755;&#20986;&#20013;&#35835;&#21462;&#65292;&#32780;&#22312;COPY
TO&#20013;&#65292;&#21629;&#20196;&#30340;&#36755;&#20986;&#20250;&#20316;&#20026;&#31243;&#24207;&#30340;&#26631;&#20934;&#36755;&#20837;&#12290;

&#27880;&#24847;&#65292;&#31243;&#24207;&#19968;&#33324;&#26159;&#22312;&#21629;&#20196;&#34892;&#30028;&#38754;&#19979;&#25191;&#34892;&#65292;&#24403;&#29992;&#25143;&#38656;&#35201;&#20256;&#36882;&#19968;&#20123;&#21464;&#37327;&#32473;&#31243;&#24207;&#26102;&#65292;&#22914;&#26524;&#36825;&#20123;&#21464;&#37327;&#30340;&#26469;&#28304;&#19981;&#26159;&#21487;&#38752;
&#30340;&#65292;&#29992;&#25143;&#24517;&#39035;&#23567;&#24515;&#36807;&#28388;&#22788;&#29702;&#37027;&#20123;&#23545;&#21629;&#20196;&#34892;&#30028;&#38754;&#26469;&#35828;&#26159;&#26377;&#29305;&#27530;&#24847;&#20041;&#30340;&#23383;&#31526;&#12290;
&#22522;&#20110;&#23433;&#20840;&#30340;&#21407;&#22240;&#65292;&#26368;&#22909;&#26159;&#20351;&#29992;&#22266;&#23450;&#30340;&#21629;&#20196;&#23383;&#31526;&#20018;&#65292;&#25110;&#32773;&#33267;&#23569;&#26159;&#24212;&#36991;&#20813;&#30452;&#25509;&#20351;&#29992;&#29992;&#25143;&#36755;&#20837;&#65288;&#24212;&#20808;&#36807;&#28388;&#29305;&#27530;&#23383;&#31526;&#65289;
STDOUT &#22768;&#26126;&#36755;&#20837;&#23558;&#20889;&#20837;&#23458;&#25143;&#31471;&#24212;&#29992;
FORMAT &#36873;&#25321;&#34987;&#35835;&#25110;&#32773;&#20889;&#30340;&#25968;&#25454;&#26684;&#24335;&#65306;text&#12289;csv&#65288;&#36887;&#21495;&#20998;&#38548;&#20540;&#65289;&#65292;&#25110;&#32773;binary&#12290;&#40664;&#35748;&#26159;text

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;:
</span>copy&#21629;&#20196;&#24517;&#39035;&#22312;psql&#21629;&#20196;&#34892;&#25191;&#34892;&#65292;&#25191;&#34892;&#29992;&#25143;&#24517;&#39035;&#20026;superuser&#65292;&#21542;&#21017;&#20250;&#25552;&#31034;&#38169;&#35823;&#22914;&#26524;
&#29992;&#26222;&#36890;&#29992;&#25143;&#36827;&#34892;&#25191;&#34892;&#65292;&#38656;&#35201;&#22312;copy&#21069;&#38754;&#21152;&#20837;&#8220;<span style="color: #8b2252;">\&#8221;</span>&#65292;&#21363; \copy&#21363;&#21487;
</pre>
</div>

<p>
范例: 导出
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#31034;&#20363;&#65306;
</span>COPY students TO <span style="color: #8b2252;">'/tmp/students.csv'</span> WITH csv;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#23548;&#20986;&#25351;&#23450;&#30340;&#23646;&#24615;&#65306;
</span>COPY students(stuid,name) TO <span style="color: #8b2252;">'/tmp/students.csv'</span> WITH csv;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#20351;&#29992;select &#35821;&#21477;&#65306;
</span><span style="color: #0000ff;">COPY</span> (<span style="color: #a020f0;">select</span> * from students) TO <span style="color: #8b2252;">'/tmp/students.csv'</span> WITH csv;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#25351;&#23450;&#35201;&#23548;&#20986;&#21738;&#20123;&#23383;&#27573;&#24182;&#24102;&#26377;&#21015;&#21517;&#65306;
</span><span style="color: #0000ff;">COPY</span> (<span style="color: #a020f0;">select</span> stuid,name,age from students) TO <span style="color: #8b2252;">'/tmp/students.csv'</span> WITH csv header;
</pre>
</div>

<p>
范例：导入
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20837;&#21629;&#20196;&#22522;&#26412;&#19982;&#23548;&#20986;&#19968;&#26679;&#65292;&#21482;&#26159;&#23558;TO &#25913;&#20026; FROM
</span>create table students2 (likestudents);
COPY students2 FROM <span style="color: #8b2252;">'/tmp/students.csv'</span> WITH csv;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#23548;&#20986;&#30340;&#26102;&#20505;&#65292;&#25351;&#23450;&#20102;header&#23646;&#24615;&#65292;&#37027;&#20040;&#22312;&#23548;&#20837;&#30340;&#26102;&#20505;&#65292;&#20063;&#38656;&#35201;&#25351;&#23450;&#65306;
</span>COPY students(stuid,name,age,gender) TO <span style="color: #8b2252;">'/tmp/students.csv'</span> WITH csv header;
COPY students2(stuid, name,age,gender) FROM <span style="color: #8b2252;">'/tmp/students.csv'</span> WITH csv header;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-物理备份" class="outline-3">
<h3 id="物理备份">物理备份</h3>
<div class="outline-text-3" id="text-物理备份">
<p>
生产用的较多
</p>

<p>
物理备份分为冷备份和热备份
</p>
<ul class="org-ul">
<li><p>
冷备份:最简单的物理备份就是冷备份，也就是把数据库停止，然后把数据库的PGDATA目录拷贝出来即可。
</p>

<p>
由于PostgreSQL把与数据库实例有关的配置文件和数据文件都放在$PGDATA目录下，所以PostgreSQL做冷备份很简单
</p></li>

<li>热备份:不停止数据库的数据库备份，称之为热备份或在线备份。在PostgreSQL中通常的热备份方法有两种。
<ul class="org-ul">
<li>第一种方法:使用数据库的PITR方法利用pg_basebackup工具进行热备份</li>

<li>第二种方法:使用文件系统或块设备级别的快照功能完成备份。因为使用了快照，所以也能让备份出来的数据库与原数据库一致。</li>
</ul></li>
</ul>

<p>
热备份流程
</p>
<ul class="org-ul">
<li>以数据库超级用户身份连接到数据库，发出命令: SELECT pgstart_backup ( 'label'); pg_start_backup()主要做了以下两个工作:
<ul class="org-ul">
<li>设置写日志标志为:XLogCtl-&gt;Insert.forcePageWrites =true，也就是把这个标志设置为true后，数据库会把变化的整个数据块都记录到数据库中，而不仅仅是块中记录的变化。</li>
<li>强制发生一次checkpoint点。</li>
</ul></li>
<li>执行备份。使用任何方便的文件系统工具比如tar，或直接把数据目录复制下来。这些操作过程中既不需要关闭数据库，也不需要停止数据库的任何操作。</li>
<li>再次以数据库超级用户身份连接数据库，然后发出命令:SELECT pg_stop_backup();</li>
</ul>

<p>
这将中止备份模式并自动切换到下一个WAL段。自动切换是为了让在备份间隔中写人的最后一个WAL段文件可以立即为下次备份做好准备。
</p>
<ul class="org-ul">
<li>拷贝备份过程中产生的归档WAL日志文件</li>
</ul>


<p>
范例：冷备份还原
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#65292;&#20808;&#20572;&#26381;&#21153;
</span>pg_ctl stop
mkdir /backup
cp -a $<span style="color: #a0522d;">PGDATA</span>/ /backup/pgdata-<span style="color: #ff00ff;">`date +%F`</span>
pg_ctl start

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36824;&#21407;
</span>pg_ctl stop
rm -rf $<span style="color: #a0522d;">PGDATA</span>/*
cp -a /backup/pgdata-2022-02-16/* $<span style="color: #a0522d;">PGDATA</span>/
pg_ctl start
</pre>
</div>

<p>
范例: 热备份和还原
</p>

<div class="org-src-container">
<pre class="src src-sh">psql -c <span style="color: #8b2252;">"select pg_start_backup(now()::text);"</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#24403;&#21069;&#26102;&#38388;&#20570;&#20026;&#26631;&#31614;
</span>tar -cf /backup/full_<span style="color: #ff00ff;">`date +%F`</span>.tar /pgsql/data/
psql -c <span style="color: #8b2252;">"select pg_stop_backup();"</span>
tar -rf /backup/full_<span style="color: #ff00ff;">`date +%F`</span>.tar /archive/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36824;&#21407;
</span>pg_ctl stop -D $<span style="color: #a0522d;">PGDATA</span>
rm -rf $<span style="color: #a0522d;">PGDATA</span>
tar xf /backup/full_<span style="color: #ff00ff;">`date +%F`</span>.tar -C /pgsql/data/
pg_ctl start -D $<span style="color: #a0522d;">PGDATA</span>
</pre>
</div>

<p>
范例: 利用LVM快照做备份
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;PGDATA&#26159;&#22522;&#20110;LVM&#23384;&#25918;&#30340;&#65292;&#21487;&#20197;&#25191;&#34892;&#22522;&#20110;&#36923;&#36753;&#21367;&#24555;&#29031;&#22791;&#20221;
</span>[root@ubuntu2004 ~]#systemctl stop postgresql ;lvcreate -n pgdata_snapshot -s - L 1G /dev/mapper/ubuntu--vg-ubuntu--lv; systemctl start postgresql

[root@ubuntu2004 ~]#mount /dev/ubuntu-vg/pgdata_snapshot /mnt
[root@ubuntu2004 ~]#cp -a /mnt/pgsql/data/ /backup/pgdata-<span style="color: #ff00ff;">`date +%F`</span>
[root@ubuntu2004 ~]#lvremove /dev/ubuntu-vg/pgdata_snapshot
</pre>
</div>
</div>
</div>
<div id="outline-container-pitrpoint-in-time-recovery介绍" class="outline-3">
<h3 id="pitrpoint-in-time-recovery介绍">PITR（Point-in-Time Recovery）介绍</h3>
<div class="outline-text-3" id="text-pitrpoint-in-time-recovery介绍">
<p>
PostgreSQL支持类似于MySQL的主从复制的架构，一个Master 服务器database同步数据到多个 Standby Server
</p>

<p>
PostgreSQL的主从同步是基于WAL(write ahead log预写式日志)日志实现的
</p>

<p>
PostgreSQL在数据目录的$PGDATA/pg_wal 重做日志目录中始终维护着一个WAL日志文件。这个日志文件用于记录数据库数据文件的每次改变。当初设计这个日志文件的主要目的是为了在数据库异常崩溃后，能够通过重放最后一次checkpoint点之后的日志文件，把数据库推到一致状态。
</p>

<p>
事实上，这种日志文件机制，也提供了一种数据库热备份方案:在把数据库使用文件系统的方式备份出来的同时把相应的在线WAL日志也备份出来。虽然直接拷贝数据库数据文件会导致拷贝出来的文件不一致
(比如拷贝的多个数据文件不是同一个时间点文件;拷贝一个8KB的数据块时，也存在不一致的情况:假设刚拷贝完前4KB的块，数据库又写了后4KB的块内容,那么所拷贝的块就不是一个完整的数据块)，但因为有了WAL日志，即使备份出来的数据块不一致，也可以重放备份开始后的
WAL日志，把备份的内容推到一致状态。
</p>

<p>
由此可见，有了WAL日志之后，备份数据库时不再需要完美的一致性备份了，备份中任何数据的非一致性都会被重放WAL日志文件进行纠正，所以在备份数据库时可以通过简单的cp命令或tar等拷贝、备份文件来实现数据库的在线备份。
</p>

<p>
不停地重放WAL日志就可以把数据推到备份结束后的任意一个时间点，这就是基于时间点的备份Point-in-Time Recovery，缩写为PITR。
</p>

<p>
使用简单的cp命令或其他命令把数据库给在线拷贝出来的备份，被称为基础备份。后续WAL日志的备份与此基础备份构成一个完整备份。把基础备份恢复到另一台主机，然后不停地从原始数据库机器上接收
WAL日志，在新机器上持续重放WAL日志，这样就可以在任何时间内在另一台机器上打开新产生的数据库。它拥有当前数据最新的数据状态。此新主机上的数据库称为Standby
数据库，当前的主数据库出现问现故障无法正常提供服务时，可以把Standby数据库打开提供服务，从而实现高可用。
</p>

<p>
把WAL日志传送到另一台机器上的方法有两种，一种是通过归档WAL日志实现，一种是被称为流复制的方法
</p>
</div>
</div>
<div id="outline-container-h:2f7e2e13-8c7f-4378-b181-d716c2cab478" class="outline-3">
<h3 id="h:2f7e2e13-8c7f-4378-b181-d716c2cab478">pg_basebackup实现完全备份和还原</h3>
<div class="outline-text-3" id="text-h:2f7e2e13-8c7f-4378-b181-d716c2cab478">
<p>
pg_basebackup是基于流复制协议可以实现完全备份，并支持热备份
</p>

<p>
这个工具会把整个数据库实例的数据都拷贝出来,而不只是把实例中的部分（如某个数据库或某些表)单独备份出。
</p>

<p>
该工具使用replication协议连接到数据库实例上，所以主数据库中的pg_hba.conf必须允许replication连接,也就是在pg_hba.conf中必须有类似下面的内容:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">local</span> replication  dba  trust

host replication  dba 0.0.0.0/0 md5
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#38754;&#30340;dba&#20026;&#22791;&#20221;&#30340;&#29992;&#25143;&#21517;,&#22914;&#26524;&#25351;&#20196;all,&#21363;&#25152;&#26377;&#29992;&#25143;</span>
</pre>
</div>
</div>
<div id="outline-container-h:7468e000-7722-4ab4-8c20-811761f3caa9" class="outline-4">
<h4 id="h:7468e000-7722-4ab4-8c20-811761f3caa9">pg_basebackup的命令行参数</h4>
<div class="outline-text-4" id="text-h:7468e000-7722-4ab4-8c20-811761f3caa9">
<p>
pg_basebackup命令的使用方法如下:
</p>
<div class="org-src-container">
<pre class="src src-sh">pg_basebackup [option.. .]
&#27492;&#21629;&#20196;&#21518;&#21487;&#20197;&#36319;&#22810;&#20010;&#36873;&#39033;&#65292;&#36873;&#39033;&#30340;&#20855;&#20307;&#35828;&#26126;&#22914;&#19979;&#12290;

-D directory&#25110;--pgdata=directory
:&#25351;&#23450;&#25226;&#22791;&#20221;&#20889;&#21040;&#21738;&#20010;&#30446;&#24405;&#12290;&#22914;&#26524;&#36825;&#20010;&#30446;&#24405;&#25110;&#36825;&#20010;&#30446;&#24405;&#36335;&#24452;&#20013;&#30340;&#21508;&#32423;&#29238;&#30446;&#24405;&#19981;&#23384;&#22312;&#65292;&#21017;pg_basebackup&#23601;&#20250;&#33258;&#21160;&#21019;&#24314;&#36825;&#20010;&#30446;&#24405;&#12290;

-F format&#25110;--format=format:
&#25351;&#23450;&#36755;&#20986;&#30340;&#26684;&#24335;&#12290;&#8220;format&#8221;&#25351;&#19968;&#31181;&#26684;&#24335;&#65292;&#23427;&#30446;&#21069;&#21448;&#25903;&#25345;&#20004;&#31181;&#26684;&#24335;&#65292;&#19968;&#31181;&#26159;&#21407;&#26679;&#36755;&#20986;&#65292;&#21363;&#25226;&#20027;&#25968;&#25454;&#24211;&#20013;&#30340;&#21508;&#20010;&#25968;&#25454;&#25991;&#20214;&#12289;
&#37197;&#32622;&#25991;&#20214;&#12289;&#30446;&#24405;&#32467;&#26500;&#37117;&#23436;&#20840;&#19968;&#26679;&#22320;&#20889;&#21040;&#22791;&#20221;&#30446;&#24405;&#65292;&#36825;&#31181;&#24773;&#20917;
&#19979;&#8220;format&#8221;&#25351;&#23450;&#20026;&#8220;p&#8221;&#25110;&#8220;plain&#8221;;&#21478;&#19968;&#31181;&#26159;tar&#26684;&#24335;&#65292;&#30456;&#24403;&#20110;&#25226;&#36755;&#20986;&#30340;&#22791;&#20221;&#25991;&#20214;&#25171;&#21253;&#21040;&#19968;&#20010;tar&#25991;&#20214;&#20013;&#65292;&#36825;&#31181;&#24773;&#20917;&#19979;&#8220;format&#8221;&#24212;&#20026;&#8220;t&#8221;&#25110;&#8220;tar&#8221;&#12290;

-x&#25110;--xlog:
&#22791;&#20221;&#26102;&#20250;&#25226;&#22791;&#20221;&#20013;&#20135;&#29983;&#30340;xlog&#25991;&#20214;&#20063;&#33258;&#21160;&#22791;&#20221;&#20986;&#26469;&#65292;&#36825;&#26679;&#25165;&#33021;&#22312;&#24674;&#22797;&#25968;&#25454;&#24211;&#26102;&#65292;&#24212;&#29992;&#36825;&#20123;xlog&#25991;&#20214;&#25226;&#25968;&#25454;&#24211;&#25512;&#21040;
&#19968;&#20010;&#19968;&#33268;&#28857;&#65292;&#28982;&#21518;&#30495;&#27491;&#25171;&#24320;&#36825;&#20010;&#22791;&#20221;&#30340;&#25968;&#25454;&#24211;&#12290;&#36825;&#20010;&#36873;&#39033;&#19982;&#36873;&#39033;&#8220;-X
fetch&#8221;&#26159;&#23436;&#20840;&#19968;&#26679;&#30340;&#12290;&#20351;&#29992;&#36825;&#20010;&#36873;&#39033;&#65292;&#38656;&#35201;&#35774;&#32622;&#8220;wal_keep_segments&#8221;&#21442;&#25968;&#65292;&#20197;&#20445;&#35777;&#22312;&#22791;&#20221;&#36807;&#31243;&#20013;&#65292;&#38656;&#35201;&#30340;WAL&#26085;&#24535;&#25991;&#20214;&#19981;&#20250;&#34987;&#35206;&#30422;&#12290;

-X method&#25110;--xlog-method=method :
<span style="color: #8b2252;">" method&#8221;&#21487;&#20197;&#21462;&#30340;&#20540;&#20026;&#8220;f&#8221;&#12289;&#8220; fetch&#8221;&#12289;&#8220;s&#8221;.&#8220;stream"</span>&#65292;&#20854;&#20013;&#8220;f&#8221;&#19982;&#8220;fetch&#30456;&#21516;&#65292;&#20854;&#24847;&#20041;&#19982;&#8220;-x&#8221;&#21442;&#25968;&#26159;&#19968;&#26679;&#30340;&#12290;&#8220;s&#8221;&#19982;&#8220;stream&#8221;&#34920;&#31034;&#30340;&#24847;&#24605;&#20063;&#30456;&#21516;&#65292;
&#34920;&#31034;&#22791;&#20221;&#24320;&#22987;&#21518;&#65292;&#21551;&#21160;&#21478;&#19968;&#20010;&#27969;&#22797;&#21046;&#36830;&#25509;&#20174;&#20027;&#24211;&#25509;&#25910;WAL&#26085;&#24535;&#12290;&#36825;&#31181;&#26041;&#24335;&#36991;&#20813;&#20102;&#20351;&#29992;&#8220;-X f&#8221;&#26102;&#65292;
&#20027;&#24211;&#19978;&#30340;WAL&#26085;&#24535;&#26377;&#21487;&#33021;&#34987;&#35206;&#30422;&#32780;&#23548;&#33268;&#22833;&#36133;&#30340;&#38382;&#39064;&#12290;&#20294;&#36825;&#31181;&#26041;&#24335;&#38656;&#35201;&#19982;&#20027;&#24211;&#24314;&#20004;&#20010;&#36830;&#25509;&#65292;
&#22240;&#27492;&#20351;&#29992;&#36825;&#31181;&#26041;&#24335;&#26102;&#65292;&#20027;&#24211;&#30340;&#8220;max_wal_senders&#8221;&#21442;&#25968;&#33267;&#23569;&#35201;&#35774;&#32622;&#20026;2&#25110;&#22823;&#20110;2&#30340;&#20540;&#12290;&#26032;&#29256;&#21462;&#28040;&#27492;&#36873;&#39033;

-z&#25110;--gzip:
&#20165;&#33021;&#19982;tar&#36755;&#20986;&#27169;&#24335;&#37197;&#21512;&#20351;&#29992;&#65292;&#34920;&#26126;&#36755;&#20986;&#30340;tar&#22791;&#20221;&#21253;&#26159;&#32463;&#36807;gzip&#21387;&#32553;&#30340;&#65292;&#30456;&#24403;&#20110;&#29983;&#25104;&#20102;&#19968;&#20010;&#8203;*.tar.gz&#30340;&#22791;&#20221;&#21253;&#12290;

-Z level&#25110;--compress=level:
&#25351;&#23450;gzip&#30340;&#21387;&#32553;&#32423;&#21035;,&#21487;&#20197;&#36873;1~9&#30340;&#25968;&#23383;&#65292;&#19982;gzip&#21629;&#20196;&#20013;&#30340;&#21387;&#32553;&#32423;&#21035;&#26159;&#19968;&#26679;&#30340;,9&#34920;&#31034;&#26368;&#39640;&#21387;&#32553;&#29575;,&#20294;&#20063;&#26368;&#32791;CPU&#12290;

-R, --write-recovery-conf <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#22797;&#21046;&#30340;&#37197;&#32622;&#20449;&#24687;&#20445;&#23384;,&#29983;&#25104;standby.signal
</span>
-c fast/spread&#25110;--checkpoint=fast|spread:&#35774;&#32622;checkpoint&#30340;&#27169;&#24335;&#26159;fast&#36824;&#26159;spread&#12290;

-l label&#25110;--label=label:
&#25351;&#23450;&#22791;&#20221;&#30340;&#19968;&#20010;&#26631;&#35782;&#65292;&#22791;&#20221;&#30340;&#26631;&#35782;&#26159;&#19968;&#20010;&#20219;&#24847;&#23383;&#31526;&#20018;&#65292;&#20415;&#20110;&#20170;&#21518;&#32500;&#25252;&#20154;&#21592;&#35782;&#21035;&#36825;&#20010;&#22791;&#20221;&#65292;&#35813;&#26631;&#35782;&#23601;&#26159;&#25163;&#24037;&#20570;&#22522;&#30784;&#22791;&#20221;&#26102;&#36816;&#34892;&#8220;
<span style="color: #a020f0;">select</span> pg_start_backup(&#8216;label<span style="color: #8b2252;">')&#8221;&#20256;&#36882;&#32473;pg_start_backup&#20989;&#25968;&#30340;&#21442;&#25968;&#12290;&#22312;&#22791;&#20221;&#38598;&#20013;&#26377;&#19968;&#20010;&#25991;&#20214;&#21483;&#8220;backup
label&#8221;&#65292;&#36825;&#37324;&#38754;&#38500;&#20102;&#35760;&#24405;&#24320;&#22987;&#22791;&#20221;&#26102; WAL&#26085;&#24535;&#30340;&#36215;&#22987;&#20301;&#32622;&#12289;Checkpoint
&#30340;WAL&#26085;&#24535;&#20301;&#32622;&#12289;&#22791;&#20221;&#30340;&#24320;&#22987;&#26102;&#38388;&#22806;&#65292;&#20063;&#35760;&#24405;&#20102;&#36825;&#20010;&#26631;&#35782;&#20018;&#30340;&#20449;&#24687;&#12290;

-P&#25110;--progress
:&#20801;&#35768;&#22312;&#22791;&#20221;&#36807;&#31243;&#20013;&#23454;&#26102;&#22320;&#25171;&#21360;&#22791;&#20221;&#30340;&#36827;&#24230;&#12290;&#24403;&#28982;&#36825;&#20010;&#25171;&#21360;&#30340;&#36827;&#24230;&#19981;&#26159;&#30334;&#20998;&#20043;&#30334;&#31934;&#30830;&#30340;&#65292;&#22240;&#20026;&#22312;&#22791;&#20221;&#36807;&#31243;&#20013;&#65292;
&#25968;&#25454;&#24211;&#30340;&#25968;&#25454;&#36824;&#20250;&#21457;&#29983;&#21464;&#21270;,&#36824;&#20250;&#19981;&#26029;&#20135;&#29983;&#19968;&#20123;WAL&#26085;&#24535;&#12290;

-v&#25110;--verbose:&#35814;&#32454;&#27169;&#24335;&#65292;&#20351;&#29992;&#20102;-P&#21442;&#25968;&#21518;&#65292;&#36824;&#20250;&#25171;&#21360;&#20986;&#27491;&#22312;&#22791;&#20221;&#30340;&#20855;&#20307;&#25991;&#20214;&#30340;&#20449;&#24687;&#12290;

-V&#25110;--version:&#25171;&#21360;pg_basebackup&#30340;&#29256;&#26412;&#21518;&#36864;&#20986;&#12290;

-?&#25110;--help:&#26174;&#31034;&#24110;&#21161;&#20449;&#24687;&#21518;&#36864;&#20986;&#12290;&#25511;&#21046;&#36830;&#25509;&#25968;&#25454;&#24211;&#30340;&#21442;&#25968;&#12290;

-h host&#25110;--host=host:&#25351;&#23450;&#36830;&#25509;&#30340;&#25968;&#25454;&#24211;&#30340;&#20027;&#26426;&#21517;&#25110;IP&#22320;&#22336;&#12290;

-p port&#25110;--port=port:&#25351;&#23450;&#36830;&#25509;&#30340;&#31471;&#21475;&#12290;

-s interval&#25110;--status-interval=interval
:&#25351;&#23450;&#21521;&#26381;&#21153;&#22120;&#31471;&#21608;&#26399;&#21453;&#39304;&#29366;&#24577;&#30340;&#31186;&#25968;,&#22914;&#26524;&#26381;&#21153;&#22120;&#19978;&#37197;&#32622;&#20102;&#27969;&#22797;&#21046;&#30340;&#36229;&#26102;&#65292;&#22312;&#20351;&#29992;--xlog=stream&#36873;&#39033;&#26102;&#65292;
&#21017;&#38656;&#35201;&#35774;&#32622;&#36825;&#20010;&#21442;&#25968;&#65292;&#40664;&#35748;&#20540;&#20026;10&#31186;&#12290;&#22914;&#26524;&#35774;&#32622;&#20026;0&#65292;&#34920;&#31034;&#19981;&#21521;&#26381;&#21153;&#22120;&#21453;&#39304;&#29366;&#24577;&#12290;

-U username&#25110;--username=username:&#25351;&#23450;&#36830;&#25509;&#30340;&#29992;&#25143;&#21517;&#12290;

-w&#25110;--no-password:&#25351;&#23450;&#20174;&#26469;&#19981;&#25552;&#31034;&#36755;&#20837;&#23494;&#30721;&#12290;

-W&#25110;--password:&#24378;&#21046;&#35753;pg _basebackup&#20986;&#29616;&#36755;&#20837;&#23494;&#30721;&#30340;&#25552;&#31034;&#12290;

-R write configuration for replication</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-完全备份" class="outline-4">
<h4 id="完全备份">完全备份</h4>
<div class="outline-text-4" id="text-完全备份">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;postgreSQL&#26381;&#21153;&#22120;&#20808;&#25480;&#26435;
</span>[postgres@gpserver ~]$<span style="color: #a0522d;">vi</span> /pgsql/data/pg_hba.conf
host replication all 10.0.0.0/24 md5

[postgres@gpserver ~]$<span style="color: #a0522d;">pg_ctl</span> restart -D $<span style="color: #a0522d;">PGDATA</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#22791;&#20221;&#26381;&#21153;&#22120;&#25191;&#34892;&#19979;&#38754;&#25805;&#20316;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;:&#22791;&#20221;&#30446;&#24405;/pgsql/backup/&#24517;&#39035;&#20026;&#31354;
</span>[postgres@gpserver ~]mkdir -p /pgsql/backup/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;, -Ft&#22791;&#20221;&#25104;tar&#21253;&#65292; -R &#24517;&#39035;&#35201;&#21152;
</span>[postgres@gpserver ~]$<span style="color: #a0522d;">pg_basebackup</span> -D /pgsql/backup/ -Ft -Pv -Upostgres -h 10.0.0.200 -p 5432 -R

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#21160;&#22312;$PGDATA&#30446;&#24405;&#19979;&#29983;&#25104;&#22791;&#20221;&#35760;&#24405;&#25991;&#20214;
</span>[postgres@gpserver ~]$<span style="color: #a0522d;">cat</span> /pgsql/data/backup_label.old
START WAL LOCATION: 0/45000028 (file 000000010000000000000045)
CHECKPOINT LOCATION: 0/45000060
BACKUP METHOD: streamed BACKUP FROM: master
START TIME: 2020-05-11 10:38:49 UTC
LABEL: pg_basebackup base backup START TIMELINE: 1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#22791;&#20221;&#29983;&#25104;&#30340;&#25991;&#20214;
</span>[postgres@gpserver ~]$ 1s /pgsql/backup/
base.tar pg_wal.tar backup_manifest
</pre>
</div>
</div>
</div>
<div id="outline-container-h:43e5df15-87e3-46b4-a700-1f15dd7bea5d" class="outline-4">
<h4 id="h:43e5df15-87e3-46b4-a700-1f15dd7bea5d">利用完全备份实现恢复</h4>
<div class="outline-text-4" id="text-h:43e5df15-87e3-46b4-a700-1f15dd7bea5d">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#22791;&#20221;&#26381;&#21153;&#22120;&#19978;&#25191;&#34892;&#19979;&#38754;&#25805;&#20316;&#36827;&#34892;&#36824;&#21407;
</span>[root@@gpserver ~]#mkdir /archive/
[root@@gpserver ~]#chown postgres.postgres /archive/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30830;&#35748;&#22791;&#20221;&#25991;&#20214;&#23384;&#22312;
</span>[postgres@gpserver ~]$ 1s /pgsql/backup/
base.tar pg_wal.tar

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27169;&#25311;&#25925;&#38556;
</span>[postgres@gpserver ~]$<span style="color: #a0522d;">echo</span> $<span style="color: #a0522d;">PGDATA</span>
/pgsql/data
[postgres@gpserver ~]$ pg_ctl -D $<span style="color: #a0522d;">PGDATA</span> stop
[postgres@gpserver ~]$ rm -rf $<span style="color: #a0522d;">PGDATA</span>/*
[postgres@gpserver ~]$ rm -rf /archive/*

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36827;&#34892;&#36824;&#21407;
</span>[postgres@gpserver ~]$ tar xf /pgsql/backup/base.tar -C $<span style="color: #a0522d;">PGDATA</span>/
[postgres@gpserver ~]$ tar xf /pgsql/backup/pg_wal.tar -C /archive

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;
</span>[postgres@gpserver ~]$ vim $<span style="color: #a0522d;">PGDATA</span>/postgresql.conf
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#19979;&#38754;&#34892;
</span><span style="color: #a0522d;">restore_command</span> = <span style="color: #8b2252;">'cp /archive/%f %p'</span>
<span style="color: #a0522d;">recovery_target</span> = <span style="color: #8b2252;">'immediate'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;pg_basebackup&#25191;&#34892;&#26102;&#28155;&#21152;-R&#36873;&#39033;,&#21487;&#20197;&#19981;&#25191;&#34892;&#19979;&#38754;,&#21542;&#21017;&#20250;&#26080;&#27861;&#21551;&#21160;&#26381;&#21153;,&#25191;&#34892;&#19979;&#38754;&#25351;&#20196;&#21019;&#24314;&#25991;&#20214;&#21518;&#25165;&#33021;&#21551;&#21160;
</span>[postgres@gpserver ~]$<span style="color: #a0522d;">touch</span> /pgsql/data/recovery.signal
[postgres@gpserver ~]$<span style="color: #a0522d;">pg_ctl</span> start -D $<span style="color: #a0522d;">PGDATA</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20572;&#27490;&#24674;&#22797;&#36807;&#31243;,&#21542;&#21017;&#20026;&#21482;&#35835;
</span><span style="color: #a0522d;">postgres</span>=# select pg_wal_replay_resume();
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:d15dbee4-01b0-4385-870b-40595c6484a5" class="outline-3">
<h3 id="h:d15dbee4-01b0-4385-870b-40595c6484a5">利用PITR实现误删除的实战案例</h3>
<div class="outline-text-3" id="text-h:d15dbee4-01b0-4385-870b-40595c6484a5">
</div>
<div id="outline-container-场景说明" class="outline-4">
<h4 id="场景说明">场景说明</h4>
<div class="outline-text-4" id="text-场景说明">
<p>
每天2:00备份,第二天10:00误删除数据库,如何恢复?
</p>
</div>
</div>
<div id="outline-container-故障恢复过程" class="outline-4">
<h4 id="故障恢复过程">故障恢复过程</h4>
<div class="outline-text-4" id="text-故障恢复过程">
<p>
备份数据和归档
</p>

<p>
还原流程
</p>
<ul class="org-ul">
<li>还原完全备份</li>
<li>归档日志恢复:
<ul class="org-ul">
<li>备份中的归档</li>
<li>恢复2:00到10:00之间的归档</li>
<li>恢复在线redo</li>
</ul></li>
</ul>
</div>
<div id="outline-container-备份" class="outline-5">
<h5 id="备份">备份</h5>
<div class="outline-text-5" id="text-备份">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;PG&#26381;&#21153;&#22120;&#24320;&#21551;&#24402;&#26723;
</span>[postgres@pgserver ~]$ vim /pgsql/data/postgresql.conf
<span style="color: #a0522d;">archive_mode</span> = on
<span style="color: #a0522d;">archive_command</span> = <span style="color: #8b2252;">'test ! -f /archive/%f &amp;&amp;cp %p /archive/%f'</span>
[postgres@gpserver ~]$<span style="color: #a0522d;">pg_ctl</span> restart -D $<span style="color: #a0522d;">PGDATA</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;PG&#26381;&#21153;&#22120;&#19978;&#21019;&#24314;&#27979;&#35797;&#25968;&#25454;
</span><span style="color: #a0522d;">postgres</span>=#create database testdb;
<span style="color: #a0522d;">postgres</span>=#\c testdb
<span style="color: #a0522d;">testdb</span>=# create table t1(id int);
<span style="color: #a0522d;">testdb</span>=# insert into t1 values(1);

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#22791;&#20221;&#26381;&#21153;&#22120;&#23545;PG&#25968;&#25454;&#24211;&#36827;&#34892;&#36828;&#31243;&#23436;&#20840;&#22791;&#20221;
</span>[postgres@backup ~]$<span style="color: #a0522d;">pg_basebackup</span> -D /pgsql/backup/ -Ft -Pv -Upostgres -h 10.0.0.200 -p 5432 -R

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;PG&#26381;&#21153;&#22120;&#19978;&#32487;&#32493;&#29983;&#25104;&#27979;&#35797;&#25968;&#25454;
</span><span style="color: #a0522d;">testdb</span>=# insert into t1 values(2);

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27169;&#25311;&#25968;&#25454;&#24211;&#21024;&#38500;
</span><span style="color: #a0522d;">postgres</span>=# drop database testdb;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21457;&#29616;&#25925;&#38556;&#65292;&#20572;&#27490;&#29992;&#25143;&#35775;&#38382;
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#26085;&#24535;&#25991;&#20214;
</span><span style="color: #a0522d;">postgres</span>=# select pg_walfile_name(pg_current_wal_lsn());
-[ RECORD 1 ] +
pg_walfile_name | 000000020000000000000020

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#20107;&#21153;ID
</span><span style="color: #a0522d;">postgres</span>=# select txid_current();
521
</pre>
</div>
</div>
</div>
<div id="outline-container-h:17329bff-9844-401b-b9f3-85ad06e9c4d3" class="outline-5">
<h5 id="h:17329bff-9844-401b-b9f3-85ad06e9c4d3">故障还原</h5>
<div class="outline-text-5" id="text-h:17329bff-9844-401b-b9f3-85ad06e9c4d3">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;PG&#26381;&#21153;&#22120;&#19978;&#20999;&#25442;&#24402;&#26723;&#26085;&#24535;
</span><span style="color: #a0522d;">postgres</span>=#select pg_switch_wal();

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#35201;&#36824;&#21407;&#30340;&#26381;&#21153;&#22120;&#20572;&#27490;&#26381;&#21153;,&#20934;&#22791;&#36824;&#21407;
</span>[postgres@pgserver ~]$<span style="color: #a0522d;">pg_ctl</span> stop -D $<span style="color: #a0522d;">PGDATA</span>
[postgres@pgserver ~]$<span style="color: #a0522d;">rm</span> -rf /pgsql/data/*

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#27979;&#35797;&#30340;&#36824;&#21407;&#26381;&#21153;&#22120;&#36827;&#34892;&#36824;&#21407;
</span>[postgres@backup ~]$<span style="color: #a0522d;">tar</span> xf /pgsql/backup/base.tar -C /pgsql/data/
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27492;&#27493;&#21487;&#20197;&#19981;&#25191;&#34892;
</span>[postgres@backup ~]$<span style="color: #a0522d;">tar</span> xf /pgsql/backup/pg_wal.tar -C /archive/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;PG&#26381;&#21153;&#22120;&#30340;&#24402;&#26723;&#26085;&#24535;&#21040;&#36824;&#21407;&#30340;&#27979;&#35797;&#26381;&#21153;&#22120;
</span>[postgres@pgserver ~]$<span style="color: #a0522d;">rsync</span> -a 10.0.0.200:/archive/ /archive/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25925;&#38556;&#28857;&#20107;&#21153;ID
</span>[postgres@backup ~]$<span style="color: #a0522d;">pg_waldump</span> /archive/000000020000000000000020 |grep -B 10 <span style="color: #8b2252;">"DROP dir"</span>
rmgr: Database len (rec/tot): 34/ 34, tx: 521, lsn: 0/3D000828, prev
0/3D0007B0, desc: DROP dir 1663/16445
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#27492;&#25351;&#20196;&#30340;&#20107;&#21153;ID&#20026;521,&#21069;&#19968;&#20010;&#20107;&#21153;&#20026;520
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;&#25991;&#20214;postgresql.conf,&#25110;&#32773;postgresql.auto.conf&#25991;&#20214;&#20063;&#21487;&#20197;
</span>[postgres@backup ~]$<span style="color: #a0522d;">vi</span> /pgsql/data/postgresql.conf
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#19979;&#38754;&#20004;&#34892;
</span><span style="color: #a0522d;">restore_command</span> = <span style="color: #8b2252;">'cp /archive/%f %p'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#36824;&#21407;&#33267;&#19978;&#38754;&#26597;&#21040;&#30340;&#20107;&#21153;ID
</span><span style="color: #a0522d;">recovery_target_xid</span> = <span style="color: #8b2252;">'520'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20063;&#21487;&#20197;&#36890;&#36807;&#19979;&#38754;&#26041;&#24335;&#25351;&#23450;&#36824;&#21407;&#33267;&#30340;&#20301;&#32622;
</span><span style="color: #a0522d;">recovery_target_name</span> = <span style="color: #8b2252;">'restore_point'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#36824;&#21407;&#28857;&#21517;&#31216;
</span><span style="color: #a0522d;">recovery_target_time</span> = <span style="color: #8b2252;">'2021-01-17 16:26:12'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#36824;&#21407;&#33267;&#26102;&#38388;&#28857;
</span><span style="color: #a0522d;">recovery_target_lsn</span> = <span style="color: #8b2252;">'0/3E000148'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#36824;&#21407;&#21040;LSN&#21495;&#30340;&#20301;&#32622;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#26381;&#21153;
</span>[postgres@backup ~]$<span style="color: #a0522d;">pg_ctl</span> start -D $<span style="color: #a0522d;">PGDATA</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#25968;&#25454;
</span>[postgres@backup ~]$<span style="color: #a0522d;">psql</span>
<span style="color: #a0522d;">postgres</span>=# \c testdb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#39564;&#35777;&#25968;&#25454;&#26159;&#21542;&#36824;&#21407;&#65292;&#24674;&#22797;&#21518;&#35835;&#21462;&#27491;&#24120;
</span><span style="color: #a0522d;">testdb</span>=# select * from t1;
id
1
2
3

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#26080;&#27861;&#20889;&#20837;
</span><span style="color: #a0522d;">testdb</span>=# insert into t1 values(4);
ERROR: cannot execute INSERT<span style="color: #a020f0;"> in</span> a read-only transaction

[postgres@pgserver ~]$<span style="color: #a0522d;">pg_controldata</span>
pg_control version number:            1700
Catalog version number:               202406281
Database system identifier:           7434814718768345198
Database cluster state:              <span style="color: #a020f0;"> in</span> archive recovery  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#29366;&#24577;&#19981;&#23545;
</span>...

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24674;&#22797;&#27491;&#24120;&#27169;&#24335;
</span><span style="color: #a0522d;">postgres</span>=# select pg_wal_replay_resume();

[postgres@pgserver ~]$<span style="color: #a0522d;">pg_controldata</span>
pg_control version number:            1700
Catalog version number:               202406281
Database system identifier:           7434814718768345198
Database cluster state:              <span style="color: #a020f0;"> in</span> production  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#29366;&#24577;&#27491;&#24120;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24674;&#22797;&#27491;&#24120;&#20889;&#20837;
</span><span style="color: #a0522d;">testdb</span>=# insert into t1 values(4);
</pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:a9da6f21-94a8-40e3-9d7e-c5ed6623e7c3" class="outline-2">
<h2 id="h:a9da6f21-94a8-40e3-9d7e-c5ed6623e7c3">PostgreSQL 高可用</h2>
<div class="outline-text-2" id="text-h:a9da6f21-94a8-40e3-9d7e-c5ed6623e7c3">
</div>
<div id="outline-container-流复制介绍" class="outline-3">
<h3 id="流复制介绍">流复制介绍</h3>
<div class="outline-text-3" id="text-流复制介绍">
<p>
流复制 streaming replication 是实现PostgreSQL的高可用的常见技术.
</p>

<p>
PostgreSQL流复制相当于MySQL的主从复制,可以实现数据同步和数据备份
</p>

<p>
官方文档:<a href="http://postgres.cn/docs/12/warm-standby.html#STREAMING-REPLICATION">http://postgres.cn/docs/12/warm-standby.html#STREAMING-REPLICATION</a>
</p>
</div>
<div id="outline-container-什么是流复制" class="outline-4">
<h4 id="什么是流复制">什么是流复制</h4>
<div class="outline-text-4" id="text-什么是流复制">
<p>
PostgreSQL通过 WAL 日志来传送的方式有两种：基于文件的日志传送和流复制。
</p>

<p>
不同于基于文件的日志传送，流复制的关键在于“流”，所谓流就是没有界限的一串数据，类似于河里的水流，是连成一片的。
</p>

<p>
流复制比使用基于文件方式的日志传送更能使一台后备服务器保持最新的状态。后备服务器连接到主服务器，主服务器则在
WAL 记录产生时即将它们以流式传送给后备服务器而不必等到 WAL 文件被填充。
</p>

<p>
比如有一个大文件要从本地主机发送到远程主机，如果是按照“流”接收到的话，我们可以一边接收，一边将文本流存入文件系统。这样，等到“流”接收完了，硬盘写入操作也已经完成。
</p>
</div>
</div>
<div id="outline-container-流复制发展历史" class="outline-4">
<h4 id="流复制发展历史">流复制发展历史</h4>
<div class="outline-text-4" id="text-流复制发展历史">
<p>
PostgreSQL在流复制出现之前，使用的就是基于文件的日志传送：对WAL日志进行拷贝，因此从库始终落后主库一个日志文件，并且还需要使用rsync工具同步数据目录。
</p>

<p>
而流复制出现是从2010年推出的PostgreSQL9.0开始的，其历史大致为：
</p>
<ul class="org-ul">
<li>起源：PostgreSQL9.0开始支持流式物理复制，用户可以通过流式复制，构建只读备库(主备物理复制，块级别一致)。流式物理复制可以做到极低的延迟(通常在1毫秒以内)。</li>
<li>同步流复制：PostgreSQL9.1开始支持同步复制，但是当时只支持一个同步流复制备节点(例如配置了3个备，只有一个是同步模式的，其他都是异步模式)。同步流复制的出现，保证了数据的0丢失。</li>
<li>级联流复制：PostgreSQL9.2支持级联流复制。即备库还可以再连备库。</li>
<li>流式虚拟备库：PostgreSQL9.2还支持虚拟备库，即就是只有WAL，没有数据文件的备库。</li>
<li>逻辑复制：PostgreSQL9.4开始可以实现逻辑复制，逻辑复制可以做到对主库的部分复制，例如表级复制，而不是整个集群的块级一致复制。</li>
<li>增加多种同步级别：PostgreSQL9.6版本开始可以通过synchronous_commit参数，来配置事务的同步级别。</li>
</ul>
</div>
</div>
<div id="outline-container-流复制原理" class="outline-4">
<h4 id="流复制原理">流复制原理</h4>
<div class="outline-text-4" id="text-流复制原理">
<p>
备库不断的从主库同步相应的数据，并在备库apply每个WAL record，这里的流复制每次传输单位是 WAL日志的record。
</p>


<figure id="orgcaf6f1f">
<img src="./images/img_20241107_163731.png" alt="img_20241107_163731.png" width="90%">

</figure>
</div>
</div>
<div id="outline-container-流复制按照同步方式分类" class="outline-4">
<h4 id="流复制按照同步方式分类">流复制按照同步方式分类</h4>
<div class="outline-text-4" id="text-流复制按照同步方式分类">
<p>
流复制类似于MySQL的的同步机制,支持以下两种同步机制
</p>
<ul class="org-ul">
<li>异步复制</li>
<li>同步流复制</li>
</ul>

<p>
在实际生产环境中，建议需要根据环境的实际情况来选择同步或异步模式，同步
模式需要等待备库的写盘才能返回成功，如此一来，在主备库复制正常的情况下，
能够保证备库的数据不会丢失，但是带来的一个负面问题，一旦备库宕机，主库
就会挂起而无法进行正常操作，即在同步模式中，备库对主库的有很大的影响，
而异步模式就不会。因此，在生产环境中，大多会选择异步复制模式,而非同步
模式.
</p>
</div>
</div>
<div id="outline-container-流复制特点" class="outline-4">
<h4 id="流复制特点">流复制特点</h4>
<div class="outline-text-4" id="text-流复制特点">
<ul class="org-ul">
<li>延迟极低，不怕大事务</li>
<li>支持断点续传</li>
<li>支持多副本</li>
<li>配置简单</li>
<li>备库与主库物理完全一致，并支持只读</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-实现流复制" class="outline-3">
<h3 id="实现流复制">实现流复制</h3>
<div class="outline-text-3" id="text-实现流复制">
</div>
<div id="outline-container-基础环境准备" class="outline-4">
<h4 id="基础环境准备">基础环境准备</h4>
<div class="outline-text-4" id="text-基础环境准备">
<p>
两个主机节点
</p>
<pre class="example" id="org194d16e">
10.0.0.101 Master
10.0.0.102 Standby
</pre>
</div>
</div>
<div id="outline-container-h:a6c07540-f121-41a1-ab94-f7f9bd3713f2" class="outline-4">
<h4 id="h:a6c07540-f121-41a1-ab94-f7f9bd3713f2">Master节点配置</h4>
<div class="outline-text-4" id="text-h:a6c07540-f121-41a1-ab94-f7f9bd3713f2">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#22797;&#21046;&#30340;&#29992;&#25143;&#24182;&#25480;&#26435;
</span>[postgres@master ~]$ psql
<span style="color: #a0522d;">postgres</span>=#create role repluser with replication login password <span style="color: #8b2252;">'123456'</span>;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;pg_hba.conf&#36827;&#34892;&#25480;&#26435;
</span>[postgres@master ~]$<span style="color: #a0522d;">vi</span> /pgsql/data/pg_hba.conf
host replication repluser 0.0.0.0/0 md5

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;(&#21487;&#36873;):
</span>[postgres@master ~]$<span style="color: #a0522d;">vi</span> /pgsql/data/postgresql.conf
<span style="color: #a0522d;">synchronous_standby_names</span> = <span style="color: #8b2252;">'*'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#27492;&#39033;,&#34920;&#31034;&#21516;&#27493;&#26041;&#24335;,&#38656;&#35201;&#21516;&#26102;&#25171;&#24320;synchronous_commit = on,&#27492;&#20026;&#40664;&#35748;&#20540;,&#40664;&#35748;&#26159;&#24322;&#27493;&#26041;&#24335;
</span><span style="color: #a0522d;">synchronous_commit</span> = on <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#21516;&#27493;&#27169;&#24335;
</span><span style="color: #a0522d;">archive_mode</span> = on <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24314;&#35758;&#25171;&#24320;&#24402;&#26723;&#27169;&#24335;,&#38450;&#27490;&#38271;&#26102;&#38388;&#26080;&#27861;&#21516;&#27493;,WAL&#34987;&#35206;&#30422;&#36896;&#25104;&#25968;&#25454;&#20002;&#22833;
</span><span style="color: #a0522d;">archive_command</span> = <span style="color: #8b2252;">'[ ! -f /archive/%f ] &amp;&amp; cp %p /archive/%f'</span>
<span style="color: #a0522d;">wa1_level</span> = replica <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;wal&#30340;&#32423;&#21035;
</span><span style="color: #a0522d;">max_wal_senders</span> = 5 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#20010;&#35774;&#32622;&#21487;&#20197;&#26368;&#22810;&#26377;&#20960;&#20010;&#27969;&#22797;&#21046;&#36830;&#25509;&#65292;&#19968;&#33324;&#26377;&#20960;&#20010;&#20174;&#33410;&#28857;&#23601;&#35774;&#32622;&#20960;&#20010;
</span><span style="color: #a0522d;">wal_keep_segments</span> = 128 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#27969;&#22797;&#21046;&#20445;&#30041;&#30340;&#26368;&#22810;&#30340;WAL&#25991;&#20214;&#25968;&#30446;
</span><span style="color: #a0522d;">wal_sender_timeout</span> = 60s <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#27969;&#22797;&#21046;&#20027;&#26426;&#21457;&#36865;&#25968;&#25454;&#30340;&#36229;&#26102;&#26102;&#38388;
</span><span style="color: #a0522d;">max_connections</span> = 200 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19968;&#33324;&#26597;&#22810;&#20110;&#20889;&#30340;&#24212;&#29992;&#20174;&#24211;&#30340;&#26368;&#22823;&#36830;&#25509;&#25968;&#35201;&#27604;&#36739;&#22823;
</span><span style="color: #a0522d;">hot_standby</span> = on <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#20027;&#24211;&#26080;&#24433;&#21709;,&#29992;&#20110;&#23558;&#26469;&#21487;&#33021;&#20250;&#25104;&#20026;&#20174;&#24211;,&#36825;&#21488;&#26426;&#22120;&#19981;&#20165;&#20165;&#26159;&#29992;&#20110;&#25968;&#25454;&#24402;&#26723;&#65292;&#20063;&#29992;&#20110;&#25968;&#25454;&#26597;&#35810;,&#22312;&#20174;&#24211;&#19978;&#37197;&#32622;&#27492;&#39033;&#21518;&#20026;&#21482;&#35835;
</span><span style="color: #a0522d;">max_standby_streaming_delay</span> = 30s <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#27969;&#22791;&#20221;&#30340;&#26368;&#22823;&#24310;&#36831;&#26102;&#38388;
</span><span style="color: #a0522d;">wal_receiver_status_interval</span> = 10s <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#20037;&#21521;&#20027;&#25253;&#21578;&#19968;&#27425;&#20174;&#30340;&#29366;&#24577;&#65292;&#24403;&#28982;&#20174;&#27599;&#27425;&#25968;&#25454;&#22797;&#21046;&#37117;&#20250;&#21521;&#20027;&#25253;&#21578;&#29366;&#24577;&#65292;&#21482;&#26159;&#35774;&#32622;&#26368;&#38271;&#30340;&#38388;&#38548;&#26102;&#38388;
</span><span style="color: #a0522d;">hot_standby_feedback</span> = on <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#26377;&#38169;&#35823;&#30340;&#25968;&#25454;&#22797;&#21046;&#65292;&#26159;&#21542;&#21521;&#20027;&#36827;&#34892;&#21453;&#39304;
</span><span style="color: #a0522d;">wal_log_hints</span> = on <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#38750;&#20851;&#38190;&#26356;&#26032;&#36827;&#34892;&#25972;&#39029;&#20889;&#20837;
</span>
[postgres@master ~]$<span style="color: #a0522d;">pg_ctl</span> restart -D /pgsql/data
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9fc311df-7aa9-420f-88e8-31acadb61fdf" class="outline-4">
<h4 id="h:9fc311df-7aa9-420f-88e8-31acadb61fdf">Standby节点配置</h4>
<div class="outline-text-4" id="text-h:9fc311df-7aa9-420f-88e8-31acadb61fdf">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#31354;&#25968;&#25454;&#21644;&#24402;&#26723;
</span>[postgres@standby ~]$ pg_ctl stop -D $<span style="color: #a0522d;">PGDATA</span>
[postgres@standby ~]$ rm -rf /pgsql/data/*
[postgres@standby ~]$ rm -rf /archive/*
[postgres@standby ~]$ rm -rf /pgsql/backup/*

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22791;&#20221;&#20027;&#24211;&#25968;&#25454;&#21040;&#22791;&#24211;
</span>[postgres@standby ~]$ pg_basebackup -D /pgsql/backup/ -Ft -Pv -Urepluser -h 10.0.0.101 -p 5432 -R

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36824;&#21407;&#22791;&#20221;&#30340;&#25968;&#25454;,&#23454;&#29616;&#21021;&#22987;&#30340;&#20027;&#20174;&#25968;&#25454;&#21516;&#27493;
</span>[postgres@standby ~]$ tar xf /pgsql/backup/base.tar -C /pgsql/data
[postgres@standby ~]$ tar xf /pgsql/backup/pg_wal.tar -C /archive/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;postgresql.conf&#25991;&#20214;
</span>[postgres@standby ~]$ vi /pgsql/data/postgresql.conf
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#19979;&#38754;&#20004;&#34892;
</span><span style="color: #a0522d;">primary_conninfo</span> = <span style="color: #8b2252;">'host=10.0.0.101 port=5432 user=repluser password=123456'</span>
<span style="color: #a0522d;">restore_command</span> = <span style="color: #8b2252;">'cp /archive/%f %p'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27492;&#39033;&#21487;&#19981;&#37197;&#32622;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#37197;&#32622;(&#21487;&#36873;):
</span><span style="color: #a0522d;">hot_standby</span> = on <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#27492;&#39033;,&#27492;&#26159;&#40664;&#35748;&#39033;
</span><span style="color: #a0522d;">recovery_target_timeline</span> = latest <span style="color: #b22222;"># </span><span style="color: #b22222;">&#40664;&#35748;
</span><span style="color: #a0522d;">max_connections</span> = 120 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22823;&#20110;&#31561;&#20110;&#20027;&#33410;&#28857;&#65292;&#27491;&#24335;&#29615;&#22659;&#24212;&#24403;&#37325;&#26032;&#32771;&#34385;&#27492;&#20540;&#30340;&#22823;&#23567;
</span><span style="color: #a0522d;">max_standby_streaming_delay</span> = 30s
<span style="color: #a0522d;">wal_receiver_status_interval</span> = 10
<span style="color: #a0522d;">shot_standby_feedback</span> = on
<span style="color: #a0522d;">max_wal_senders</span> = 15
<span style="color: #a0522d;">logging_co1lector</span> = on
<span style="color: #a0522d;">log_directory</span> = <span style="color: #8b2252;">'pg_log'</span>
<span style="color: #a0522d;">log_filename</span> = <span style="color: #8b2252;">'postgresql-%Y-%m-%d_%H%M%S.log'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2
</span><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;postgresql.auto.conf
</span>[postgres@standby ~]$ vi /pgsql/data/postgresql.auto.conf
<span style="color: #a0522d;">primary_conninfo</span> = <span style="color: #8b2252;">'host=10.0.0.101 port=54321 user=repluser password=123456 sslmode=disable sslcompression=0 gssencmode=disable krbsrvname=post_session_attrs=any'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27492;&#34892;&#33258;&#21160;&#29983;&#25104;,&#21482;&#20462;&#25913;&#29992;&#25143;&#21517;&#21363;&#21487;
</span><span style="color: #a0522d;">restore_command</span> = <span style="color: #8b2252;">'cp /archive/%f %p'</span>

[postgres@standby ~]$ pg_ctl -D /pgsql/data start
</pre>
</div>
</div>
</div>
<div id="outline-container-监控同步状态" class="outline-4">
<h4 id="监控同步状态">监控同步状态</h4>
<div class="outline-text-4" id="text-监控同步状态">
</div>
<div id="outline-container-在主库查看状态" class="outline-5">
<h5 id="在主库查看状态">在主库查看状态</h5>
<div class="outline-text-5" id="text-在主库查看状态">
<div class="org-src-container">
<pre class="src src-sh">[root@master ~]#pg_controldata
pg_control version number:   1201
Catalog version number:       201909212
Database system identifier:    7051752604814091288
Database cluster state:       <span style="color: #a020f0;"> in</span> production <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#24211;&#29366;&#24577;
</span>......

<span style="color: #a0522d;">postgres</span>=#select pid,state,client_addr,sync_priority,sync_state from pg_stat_replication;
pid | state | client_addr | sync_priority | sync_state
21373 | streaming | 10.0.0.102 | 0 | async

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#38754;&#21482;&#22312;&#20027;&#33410;&#28857;&#26597;&#30475;&#21516;&#27493;&#27169;&#24335;,&#27880;&#24847;:&#22914;&#26524;&#26080;&#20174;&#33410;&#28857;&#36830;&#25509;,&#23558;&#26080;&#20219;&#20309;&#26174;&#31034;&#20449;&#24687;
</span><span style="color: #a0522d;">postgres</span>=# SELECT pg_current_wal_insert_lsn(),* from pg_stat_replication;
-[ RECORD 1 ] +
pg_current_wal_insert_lsn | 0/5B002988 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;lsn&#21495; pid | 33479
</span>usesysid | 16452
usename | repluser
application_name | walreceiver
client_addr | 10.0.0.8
client_hostname |
client_port | 56742
backend_start | 2020-05-18 11:50:21.970079+00
backend_xmin |
state | streaming
sent_lsn | 0/5B002988
write_lsn | 0/5B002988 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#27493;&#30340;lsn&#21495;,&#21644;&#19978;&#38754;&#19968;&#33268;,&#35828;&#26126;&#21516;&#27493;,&#26377;&#24046;&#34920;&#31034;&#26377;&#21516;&#27493;&#24310;&#36831;
</span>flush_lsn | 0/5B002988
replay_lsn | 0/5B002988
write_lag |
flush_lag |
replay_lag |
sync_priority | 1
sync_state | async <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#26159;&#24322;&#27493;,&#21516;&#27493;&#26174;&#31034;&#20026;sync
</span>reply_time | 2020-05-18 12:00:20.851292+00

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26381;&#21153;&#22120;&#26597;&#30475;&#25968;&#25454;&#24211;&#26159;&#21542;&#20026;&#22791;&#24211;&#65292;f&#34920;&#20027;&#24211; t&#34920;&#31034;&#20026;&#22791;&#24211;
</span><span style="color: #a0522d;">postgres</span>=# select * from pg_is_in_recovery();
<span style="color: #a0522d;">postgres</span>=# select application_name,client_addr,sync_state from pg_stat_replication;
application_name | client_addr | sync_state
walreceiver | 10.0.0.200 | async (1 row)

[root@master ~]#ps aux |grep walsender
postgres 1295 0.0 0.3 160748 6448 ? Ss 08:47 0:00 postgres: walsender
repluser 10.0.0.8(39850) streaming 0/4F912580 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21457;&#36865;WAL&#26085;&#24535;&#36827;&#31243;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6a7eac79-7082-42a5-9e2e-44ebc0072167" class="outline-5">
<h5 id="h:6a7eac79-7082-42a5-9e2e-44ebc0072167">在从库查看状态</h5>
<div class="outline-text-5" id="text-h:6a7eac79-7082-42a5-9e2e-44ebc0072167">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#33410;&#28857;&#21487;&#20197;&#35835;
</span><span style="color: #a0522d;">hellodb</span>=# select * from teachers;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#33410;&#28857;&#19981;&#25903;&#25345;&#20889;
</span><span style="color: #a0522d;">hellodb</span>=# delete from teachers where <span style="color: #a0522d;">tid</span>=4;
ERROR: cannot execute DELETE<span style="color: #a020f0;"> in</span> a read-only transaction

<span style="color: #a0522d;">postgres</span>=# select * from pg_is_in_recovery();
pg_is_in_recovery | t

<span style="color: #a0522d;">postgres</span>=# \x
Expanded display is on.

<span style="color: #a0522d;">postgres</span>=# SELECT * FROM pg_stat_wal_receiver;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#36827;&#31243;
</span>[root@standby ~]#ps aux|grep postgres
walreceiver streaming 0/4F912580 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25509;&#25910;WAL&#26085;&#24535;&#36827;&#31243;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-切换主从" class="outline-4">
<h4 id="切换主从">切换主从</h4>
<div class="outline-text-4" id="text-切换主从">
</div>
<div id="outline-container-h:1afc3ecc-ce2e-498f-b0d2-dca858b95bb3" class="outline-5">
<h5 id="h:1afc3ecc-ce2e-498f-b0d2-dca858b95bb3">将从库切换为主库</h5>
<div class="outline-text-5" id="text-h:1afc3ecc-ce2e-498f-b0d2-dca858b95bb3">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#24211;&#20999;&#20026;&#20027;&#65292;&#33021;&#20889;&#20837;
</span>[postgres@slave ~]$ pg_ctl promote
[postgres@slave ~]$ pg_controldata

pg_ctl restart
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24674;&#22797;&#27491;&#24120;&#27169;&#24335;
</span><span style="color: #a0522d;">postgres</span>=# select pg_wal_replay_resume();
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d1388299-40e9-4590-9c77-f5e348b72f0a" class="outline-5">
<h5 id="h:d1388299-40e9-4590-9c77-f5e348b72f0a">原主库切换为从库</h5>
<div class="outline-text-5" id="text-h:d1388299-40e9-4590-9c77-f5e348b72f0a">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#21407;&#20027;&#24211;&#20462;&#22797;&#25925;&#38556;&#21518;,&#22312;&#20027;&#24211;&#26381;&#21153;&#22120;&#37325;&#22797;&#19978;&#38754;Standby&#33410;&#28857;&#37197;&#32622;&#30340;&#27493;&#39588;
</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#21407;&#20027;&#24211;&#26381;&#21153;&#22120;&#21019;&#24314;standby.signal&#25991;&#20214;
</span>[postgres@master ~]$<span style="color: #a0522d;">touch</span> $<span style="color: #a0522d;">PGDATA</span>/standby.signal

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#21407;&#20027;&#24211;&#26381;&#21153;&#22120;&#21551;&#21160;&#26381;&#21153;
</span>[postgres@master ~]$<span style="color: #a0522d;">pg_ctl</span> -D /pgsql/data restart

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#21407;&#20027;&#24211;&#26381;&#21153;&#22120;&#26597;&#30475;&#29366;&#24577;
</span>[postgres@master ~]$/pgsql/data$ pg_controldata
pg_control version number: 1201
Catalog version number: 201909212
Database system identifier: 7051752604814091288
Database cluster state:<span style="color: #a020f0;"> in</span> archive recovery
pg_control last modified: Thu Jan 20 10:23:03 2022
Latest checkpoint location: 0/5E000060

<span style="color: #a0522d;">hellodb</span>=# select * from pg_is_in_recovery();
t
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cf76daa0-2685-4185-9eeb-2ff5640b4b09" class="outline-5">
<h5 id="h:cf76daa0-2685-4185-9eeb-2ff5640b4b09">重新验证同步状态</h5>
<div class="outline-text-5" id="text-h:cf76daa0-2685-4185-9eeb-2ff5640b4b09">
<p>
在新主库创建数据,验证是否能同步至原主库
</p>
</div>
</div>
</div>
<div id="outline-container-实现同步的流复制" class="outline-4">
<h4 id="实现同步的流复制">实现同步的流复制</h4>
<div class="outline-text-4" id="text-实现同步的流复制">
</div>
<div id="outline-container-配置同步的流复制" class="outline-5">
<h5 id="配置同步的流复制">配置同步的流复制</h5>
<div class="outline-text-5" id="text-配置同步的流复制">
<p>
主节点需要特殊的如下配置，从节点配置再执行
</p>

<div class="org-src-container">
<pre class="src src-sh">[postgres@master ~]$<span style="color: #a0522d;">vi</span> /pgsql/data/postgresql.conf
<span style="color: #a0522d;">synchronous_standby_names</span> = <span style="color: #8b2252;">'*'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#27492;&#39033;,&#34920;&#31034;&#21516;&#27493;&#26041;&#24335;,&#40664;&#35748;&#26159;&#24322;&#27493;&#26041;&#24335;
</span><span style="color: #a0522d;">synchronous_commit</span> = on <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#21516;&#27493;&#27169;&#24335;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9ea98232-3516-4929-8cab-4e2a90e88be9" class="outline-5">
<h5 id="h:9ea98232-3516-4929-8cab-4e2a90e88be9">验证同步状态</h5>
<div class="outline-text-5" id="text-h:9ea98232-3516-4929-8cab-4e2a90e88be9">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#20027;&#33410;&#28857;&#26597;&#30475;sync&#29366;&#24577;
</span><span style="color: #a0522d;">postgres</span>=# select pid,state,client_addr,sync_priority,sync_state from pg_stat_replication;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#33410;&#28857;&#20572;&#27490;&#26381;&#21153;
</span>postgres@slave:~$ pg_ctl stop

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#33410;&#28857;&#21482;&#25903;&#25345;&#35835;&#65292;&#20294;&#20889;&#20837;&#26102;&#20250;&#22788;&#20110;&#21345;&#39039;&#29366;&#24577;&#65292;&#30452;&#33267;&#20174;&#33410;&#28857;&#24674;&#22797;&#27491;&#24120;&#21516;&#27493;
</span><span style="color: #a0522d;">hellodb</span>=# delete from teachers where <span style="color: #a0522d;">tid</span>=4;
......
</pre>
</div>
</div>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
