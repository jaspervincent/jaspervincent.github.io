<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux: 虚拟化技术KVM</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux: 虚拟化技术KVM</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:6456b86f-61e3-4db6-8a3a-720f5cfbe6c7">虚拟化基础</a>
<ul>
<li><a href="#h:9b5417b1-2263-4982-815b-9c98b4c8a510">传统的物理机部署方案</a></li>
<li><a href="#h:2eaded6c-7621-4d5d-9a78-d75530896379">虚拟化和虚拟机</a>
<ul>
<li><a href="#h:5e02a1c0-61e1-400d-b567-46b0814203cd">虚拟化</a></li>
<li><a href="#h:d8003d98-6043-4699-9ee4-cfb169135cec">什么是虚拟化</a></li>
<li><a href="#h:99609888-e0f0-43a8-bf99-749db948ca17">虚拟化优势</a></li>
<li><a href="#h:341e99a3-ef69-474c-8947-3227a4f64199">虚拟化的发展史</a></li>
<li><a href="#h:d4bc18ee-f702-4044-bb47-9cd17bcdae9c">虚拟机</a>
<ul>
<li><a href="#h:125b88a8-1512-463c-9f0b-bed2a6a70ec1">虚拟机</a></li>
<li><a href="#h:96553a7f-3d50-4e0d-99d3-030d9ac69add">虚拟机的主要特性</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:6a999e4f-b07a-424a-beb4-bdd39a43099d">虚拟化类型</a>
<ul>
<li><a href="#h:fa93879e-409f-4648-ab9a-db5275d27b97">服务器虚拟化</a></li>
<li><a href="#h:ad81747c-fe51-41c8-aad0-6c90b948b19d">网络虚拟化</a></li>
<li><a href="#h:befa3dd4-8e64-47f4-9a7d-cfb909824e51">桌面虚拟化</a></li>
<li><a href="#h:8530d4c2-d8bc-445a-82e1-e6269eca52d9">应用虚拟化</a></li>
<li><a href="#h:89a57b72-cc0c-4f3f-8ffb-be92772e9da0">存储虚拟化</a></li>
<li><a href="#h:acc986b8-4b1b-42b8-934a-33c93362a600">库虚拟化</a></li>
<li><a href="#h:7030d161-6750-43b1-9319-e112a6b68f3f">容器虚技术</a></li>
</ul>
</li>
<li><a href="#h:f640b20c-c3d2-4a0c-8ee3-ea541347f05d">Hypervisor类型</a>
<ul>
<li><a href="#h:7306b542-cbfa-4804-bf6f-c7bdfe7a806d">Hypervisor 介绍</a></li>
<li><a href="#h:b5136fcd-5c5c-40bb-8599-02e4aec724a4">Hypervisor 分类</a>
<ul>
<li><a href="#h:9ac171cb-cea2-4f8f-86a2-e1e9807d3999">类型 I : 裸金属型</a></li>
<li><a href="#h:0b355978-db9e-4a36-80e4-53c1780ecadf">类型 II : 宿主型</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:02671c9e-a2d2-4a24-b0d1-dd17c8d21ba4">虚拟化技术分类</a>
<ul>
<li><a href="#h:0df2a556-342e-43a7-aef7-435dcc0d6eec">模拟器/软件仿真</a></li>
<li><a href="#h:3fd871f2-297f-4159-985d-dd7bf8c96af9">全虚拟机化 full virtualization / 本地虚拟化 native virtualization</a>
<ul>
<li><a href="#h:aef80cd3-9748-41ec-be36-b0d0c0547c65">软件辅助的全虚拟化</a></li>
<li><a href="#h:a842d224-2811-4260-9ad2-1120249ec58d">硬件辅助的全虚拟化 HVM(Hardware Virtual Machine)</a></li>
</ul>
</li>
<li><a href="#h:20afd2c7-b2d0-4c48-ba2f-6a47146b64f1">半虚拟化 para virtualization</a></li>
<li><a href="#h:5f9e7be0-f626-450e-a10f-2ae3d6d4bdb3">各虚拟化技术性能对比</a></li>
</ul>
</li>
<li><a href="#h:0637b710-7004-4841-a4b9-207e805ee311">虚拟化技术厂商</a>
<ul>
<li><a href="#h:cbfd92c7-3896-43b5-93c3-18e3b105ae9a">软件技术厂商</a></li>
<li><a href="#h:023a92a3-8f99-4589-9b4e-20481ba13ba9">硬件技术厂商</a>
<ul>
<li><a href="#h:18f721b1-b456-4d96-9e0d-adbaf89e43d9">Intel VT-x</a></li>
<li><a href="#h:5e7491d9-58ed-43a3-ad49-969712c1f7d8">Intel VT-d</a></li>
<li><a href="#h:1c807f9f-bea6-459d-ad74-4e545ba3d532">Intel VT-c</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:c6d53d29-8a74-4411-9692-7217cb7786a3">云计算</a>
<ul>
<li><a href="#h:9bc14a23-7e04-4e59-b369-f63bc82fab2d">什么是云计算</a></li>
<li><a href="#h:e0bafe16-d96c-4681-908e-ed582c59f218">云计算分类</a></li>
<li><a href="#h:914460e2-a7e3-4cdb-bd5e-44c2b37e0811">云计算分层</a></li>
<li><a href="#h:f07789bf-6122-4347-b5a4-e37426e93347">云计算和虚拟化</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:051433f3-b58d-4698-963d-5299a453a981">虚拟化技术之KVM架构和部署</a>
<ul>
<li><a href="#h:7986157e-4a20-46be-9e10-ffc6e67362bb">KVM 概述</a>
<ul>
<li><a href="#h:30ee8639-ee3b-4a00-8c27-70581f3fa40b">KVM 介绍</a></li>
<li><a href="#h:ab7af2ae-e1f5-4fe0-b664-607d5e65b9a8">KVM架构</a>
<ul>
<li><a href="#h:88b7594e-6f69-43f8-b9fd-a21d183ad1ae">KVM 体系结构</a></li>
<li><a href="#h:b1feb9a1-d112-4810-b663-94d3f3088de3">KVM 模块载入后的系统的运行模式</a></li>
<li><a href="#h:be4c938d-6ad4-40b5-8d9e-9b94e746e55c">KVM 的组件</a></li>
<li><a href="#h:123fd020-b1ed-4e83-83d3-682af42de90b">KVM 功能</a></li>
<li><a href="#h:a50ad1f3-7eb7-4207-9ef7-a8354e90b26e">QEMU</a></li>
<li><a href="#h:dd7a6b17-97b9-4be1-89b4-f983dce263ba">KVM 局限性</a></li>
</ul>
</li>
<li><a href="#h:11c7ecf7-3ded-4c1e-ab68-7f3b5bb9db61">比较 KVM 和 Xen</a></li>
<li><a href="#h:d8be2dd6-e1e8-4db3-b667-fae7a93cd7f3">RHEL(CentOS)对虚拟设备三种工作模式</a>
<ul>
<li><a href="#h:bec03876-c083-43d1-becc-dabf22bcea82">虚拟和仿真设备</a></li>
<li><a href="#h:536c4957-a39f-444d-a1ba-5a9235eb2b4e">半虚拟化设备</a></li>
<li><a href="#h:d59c89da-ee55-4e75-aaf9-f7333f75bef6">透传物理主机设备</a></li>
</ul>
</li>
<li><a href="#h:337ab43c-6938-49d5-bd35-ce37e0ca56f0">KVM 集中管理与控制</a></li>
</ul>
</li>
<li><a href="#h:40878fbd-bd50-459d-b6f1-6a554e637103">宿主机环境准备</a>
<ul>
<li><a href="#h:b3724adb-ec3b-437b-8d7a-53027c489619">CPU开启虚拟化</a></li>
<li><a href="#h:25d3b317-65a4-4461-9d07-2908de0b68f2">验证开启虚拟化</a></li>
</ul>
</li>
<li><a href="#h:5bdbbdbc-8e93-4a60-be21-80cc111cdb6d">安装KVM工具包</a>
<ul>
<li><a href="#h:8aa9478b-eb64-49b8-a931-5b990dede0ca">KVM 相关工具包介绍</a></li>
<li><a href="#h:94b300a9-fc63-40c6-b5c8-2c1bdec94b3d">libvirt 包功能</a>
<ul>
<li><a href="#h:a0f1d9ee-cadf-4e93-85e3-97a657247929">libvirt 介绍</a></li>
<li><a href="#h:5cbc72f3-1d4d-4f04-b33d-29378fa471d3">libvirt 结构图</a></li>
</ul>
</li>
<li><a href="#h:db08008d-e2e5-4809-b016-44bf36d89b3b">安装KVM相关包</a>
<ul>
<li><a href="#h:e521c28a-37ff-4ab5-95d7-70d8767760a3">CentOS 安装 KVM</a></li>
<li><a href="#h:fe8e887d-8f70-4c02-9cdc-90fb25b817a9">Ubuntu 安装 KVM</a></li>
</ul>
</li>
<li><a href="#h:2e3b2598-8d4e-48c7-a2f2-f4e792cbd435">图形化工具 virt-manager</a></li>
<li><a href="#h:a8efbaab-8ed9-4ecd-8a76-d7aaa99267f6">默认网络配置</a></li>
</ul>
</li>
<li><a href="#h:c4d2833c-096f-4202-aa72-5649254e5760">准备安装系统的ISO相关文件</a></li>
<li><a href="#h:3ddf663b-e0bf-410c-8942-f79e8f71b618">AMD CPU 创建虚拟机时的故障排错</a>
<ul>
<li><a href="#h:dc71a9ba-a964-4085-9879-59b0e22a6637">AMD CPU 使用virt-manager创建虚拟机出错提示</a></li>
<li><a href="#h:e1ceaf62-349e-4e83-a04a-581bc749fd55">AMD CPU 使用virt-install创建虚拟机出错提示</a></li>
<li><a href="#h:d5e54f46-f761-4bbf-a2c2-db18811b4f3f">AMD CPU 创建虚拟机故障修复方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:3501a7ea-6ce6-4332-ad1a-6591be3b0686">创建虚拟机</a>
<ul>
<li><a href="#h:34aeaab3-8fa1-44e1-b574-f28e46bb8ff5">使用 virt-manager 创建虚拟机</a></li>
<li><a href="#h:dd83b8fc-8884-4355-9571-5f8a5243c41f">使用 virt-install 创建虚拟机</a>
<ul>
<li><a href="#h:642308e9-e526-45a0-bf1f-f1ef7696d8d6">virt-install 使用说明</a></li>
<li><a href="#h:631de974-8aae-4692-bb17-d2d8ae78f3d5">virt-install 命令创建虚拟机</a>
<ul>
<li><a href="#h:89318a0f-3f2f-4310-919a-c9467c2ee3ce">利用 qemu-img命令创建虚拟磁盘</a></li>
<li><a href="#h:51771da1-cd33-4adb-9cd3-f1f380f293eb">利用 osinfo-query命令查看支持的OS版本</a></li>
<li><a href="#h:413905b1-475c-41be-bdd2-8981f529f8f3">创建虚拟机光盘启动并手动安装</a></li>
<li><a href="#h:bbb77910-196d-4544-b897-c2f2a39ea4d3">创建虚拟机从光盘启动并利用kickstart自动安装系统</a></li>
<li><a href="#h:289a7825-14eb-4277-b92d-1436b1ee9488">验证宿主机进程</a></li>
<li><a href="#h:5bcfac68-b29b-4c16-8f30-4ef84f3b3cb5">vnc 连接虚拟机</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:095e8ce7-d3d3-4514-8c3f-c71b15bf804e">基于现有虚拟机磁盘为模版创建新的虚拟机</a>
<ul>
<li><a href="#h:240126ea-a307-4103-89a4-302a02fb4511">利用virt-manager实现</a></li>
<li><a href="#h:110ddafd-6afe-482a-b402-e0c11488000f">利用virt-install实现</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:662ebb1c-c864-45cc-9c05-80f5a79e6493">管理虚拟机</a>
<ul>
<li><a href="#h:95e75989-1d52-4e97-9b95-c222a3989af5">使用半虚拟化驱动 virtio</a>
<ul>
<li><a href="#h:a6a84222-7e29-498b-acc3-8b907da6a0cf">半虚拟化驱动virtio的工作原理</a></li>
<li><a href="#h:f12d5d85-ce39-4ba1-a889-b47534daab63">半虚拟化设备统一接口virtio</a></li>
<li><a href="#h:a0c91521-a9ab-46cb-ab4b-eefd0dc5eb1a">驱动获取</a>
<ul>
<li><a href="#h:d1a63b54-9563-4399-8ca7-08e3cd9dac89">Linux 的 VirtIO 驱动</a></li>
<li><a href="#h:d763c6a7-c4f3-45bc-a285-5aadfa4ee4c0">Windows 操作系统需要额外安装 virtio 的驱动</a></li>
</ul>
</li>
<li><a href="#h:2fd0011b-0668-4a2f-b637-79167e4d49f3">Linux 测试安装virtio驱动前后的虚拟机性能变化</a></li>
<li><a href="#h:7a051568-943d-44b9-8383-99109a99fed4">安装 Windows Server 虚拟机</a>
<ul>
<li><a href="#h:fcb847ab-c36f-44df-91cd-2db18521b4a0">下载并准备相关文件</a></li>
<li><a href="#h:71674e6f-a83b-4c2e-8d20-05839b739f4e">创建 Windows Server 2008 虚拟机</a></li>
<li><a href="#h:e0e6b349-fd5a-4131-a2b4-ca9fe3ff2cec">安装 Windows Server 2008</a></li>
<li><a href="#h:7b0ecf9a-229c-492b-9dd2-da104360a099">验证 Windows virtio 驱动</a></li>
<li><a href="#h:54393c48-720a-4be6-8efe-94d2f9d4572b">安装PCI 内存管理驱动</a></li>
<li><a href="#h:aadfd777-d051-451c-aa28-66090a5fddf3">生成Windows Server 2008 镜像模版</a></li>
</ul>
</li>
<li><a href="#h:fca7b042-d3ff-4c85-9eda-9181a5ad8e6b">安装 Windows 10 虚拟机</a></li>
</ul>
</li>
<li><a href="#h:52988609-dd56-40bd-99b3-cd946de4659b">安装与配置 QEMU guest agent</a>
<ul>
<li>
<ul>
<li><a href="#h:35839c50-395b-4e69-8fe9-6ea98d9cdb2b">QEMU guest agent 功能</a></li>
</ul>
</li>
<li><a href="#h:4a942fdc-fd05-4c21-8ae4-b52377ecb3d3">安装 QEMU guest agent 安装方法</a>
<ul>
<li><a href="#h:730ba572-1985-463b-9d83-48f8b51e2fe8">在 Linux 安装</a></li>
<li><a href="#h:1c786e50-5a5a-4bd6-8f20-d88388c14a0e">在 Windows 安装 QEMU guest agent</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:7983997d-f6a3-4dac-af8f-2d274bf1a60b">安装和配置 SPICE agent</a></li>
</ul>
</li>
<li><a href="#h:3366e32f-8f1b-4833-bf23-ba652053a291">libvirt 管理虚拟机</a>
<ul>
<li><a href="#h:ca81dad1-c445-430f-af32-3f50b8afd910">libvirt 架构</a></li>
<li><a href="#h:80d0a578-20cf-4a75-819d-c2b38427d7d5">virt-manager 管理虚拟机</a>
<ul>
<li><a href="#h:931b57fd-2918-487b-84a4-e5e636680a29">启动菜单</a></li>
<li><a href="#h:8c34d563-cf03-4eaa-b451-77d5bc5119b5">使用USB设备</a>
<ul>
<li><a href="#h:6740b4b5-3564-43c0-9ce1-9827eb384fa3">添加USB设备</a></li>
<li><a href="#h:721f57b0-dcee-4a75-b929-fee53f6c45a1">重定向USB设备</a></li>
</ul>
</li>
<li><a href="#h:e8533738-a11e-48df-ad51-c55f6d0da90a">远程管理KVM宿主机</a></li>
<li><a href="#h:1e2ae9c7-7d81-4c5a-994e-a776c0a70a8e">虚拟机的性能监控</a></li>
</ul>
</li>
<li><a href="#h:8dca3264-759e-4d8e-9e0e-4a1aa50c0199">virsh 命令行工具</a>
<ul>
<li><a href="#h:ea40cd39-ea90-44c5-b0e9-c69e8354d131">virsh 命令说明</a>
<ul>
<li><a href="#h:7d707e42-8aef-4dd0-9e10-49644f83eed8">两种工作模式</a></li>
<li><a href="#h:99a1ee5f-e688-4170-a299-e9d4af6da05c">virsh 主要功能</a></li>
<li><a href="#h:9e7eb122-bfe6-45dd-a366-f2cd1c1408b7">virsh 命令格式</a></li>
<li><a href="#h:b215852b-d1cc-4d4d-b9de-2a795304c7d1">virsh 子命令说明</a></li>
<li><a href="#h:3469bb04-53d0-43cb-93c2-4b4b1dd10fc6">查看子命令帮助</a></li>
</ul>
</li>
<li><a href="#h:f223016a-1e7a-4f68-84c1-785dd44261b4">启动和关闭虚拟机</a></li>
<li><a href="#h:024c32aa-0a15-42b3-9a57-a745e6a2335c">暂停和恢复虚拟机</a></li>
<li><a href="#h:da5677b5-63f7-4fbf-85b7-43014878e1c8">配置虚拟机开机自动启动</a></li>
<li><a href="#h:bf32584e-870c-4e2c-aa1a-f489d6a21bef">查看虚拟机配置</a></li>
<li><a href="#h:59f69fc5-9426-4365-a334-01219cd6fa6b">删除虚拟机配置</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:94ea0620-9987-4aed-ae41-f32e4e8503da">存储管理</a>
<ul>
<li><a href="#h:efcd2e8f-3b8e-469b-aa1a-eb26dddc6d73">KVM存储模式</a></li>
<li><a href="#h:40850f61-e207-4964-b80e-6851063fe8be">虚拟磁盘类型</a></li>
<li><a href="#h:3fb57b9f-7fc0-4e82-9cdd-90bc7100492c">虚拟镜像文件格式</a></li>
<li><a href="#h:2b765b23-a127-49ec-8ab4-a88d3f8c6ef0">使用qemu-img管理虚拟磁盘文件</a>
<ul>
<li><a href="#h:0f57c7a6-7701-48ec-97f6-2ad12eb34b18">qemu-img 概述</a></li>
<li><a href="#h:21653ec0-5afa-4b9d-8b7f-fec903f1e7a6">创建虚拟磁盘文件</a>
<ul>
<li><a href="#h:9273245b-ccf6-4a43-ad11-bf7af548f345">创建默认配置的磁盘</a></li>
<li><a href="#h:770109ae-4f84-48ec-834e-719b93bc4c1d">查看不同磁盘文件格式支持选项</a></li>
<li><a href="#h:58e190c3-6658-4055-8d6a-a55594319f3d">qcow2 格式选项</a></li>
<li><a href="#h:59cd6391-3ae9-46ae-b2ae-6f5141a1ca6d">创建raw格式非稀疏文件</a></li>
<li><a href="#h:f3acf851-83fc-4605-b0ea-572e2c484996">创建raw格式稀疏文件</a></li>
<li><a href="#h:07ac06bd-eeee-4955-b8d9-6f51cf1dab64">raw文件复制的格式控制</a></li>
</ul>
</li>
<li><a href="#h:36441d5d-0558-491d-851e-b3ab6ab7cc5a">检查虚拟磁盘</a></li>
<li><a href="#h:5342b435-789f-4d24-8281-66864cf493c5">磁盘预分配策略</a></li>
<li><a href="#h:d085fcf6-5c34-46ca-a4ef-89a9b91131bc">后备差异虚拟磁盘</a>
<ul>
<li><a href="#h:6fc20f16-cf29-4202-92a5-8b148e1d5b03">后备差异虚拟磁盘介绍</a></li>
<li><a href="#h:a622a71a-4ce9-4465-aa18-5859853871c6">创建后备差异虚拟磁盘并用virt-install启动虚拟机</a></li>
<li><a href="#h:f0f62e28-fc2a-4def-9e8a-833a22c1e51d">创建后备差异虚拟磁盘并用virt-manager启动虚拟机</a></li>
<li><a href="#h:e1e724fd-04f3-4dc7-8621-57d008963fd6">后备差异虚拟磁盘依赖关系</a></li>
</ul>
</li>
<li><a href="#h:a3049c6b-f5eb-48bb-bfa2-19950364289a">虚拟磁盘格式转换</a></li>
<li><a href="#h:83cf5dc9-2e4a-4b37-8472-012fa4ce02c1">调整虚拟磁盘大小</a></li>
</ul>
</li>
<li><a href="#h:a6d5bcf0-622d-411e-b969-d36c7f857151">磁盘快照管理</a>
<ul>
<li><a href="#h:088b2715-f200-4aa9-9beb-b795cc4f93d3">快照Snapshot介绍</a>
<ul>
<li><a href="#h:17d430d8-8cfa-49c7-84bb-036a974ff3d1">快照分类</a></li>
<li><a href="#h:0bf55b4d-e16b-4ffc-9a98-8c51983dba99">磁盘快照分类</a></li>
</ul>
</li>
<li><a href="#h:db4556d4-62ce-4467-959e-5480b63a39d7">qemu-img 管理磁盘快照</a></li>
<li><a href="#h:77fa070a-4364-415e-83c0-25b6514edbd5">管理虚拟机快照</a></li>
<li><a href="#h:f17bc8eb-43c4-494a-984e-bbe755e762ad">virt-manager 管理快照</a></li>
</ul>
</li>
<li><a href="#h:68708900-2cd3-4c45-81b2-df80eceaaa98">存储池管理</a>
<ul>
<li><a href="#h:6ab50a9e-ec15-4e9a-9962-d7e5361bda00">存储池介绍</a>
<ul>
<li><a href="#h:a0fed8b8-1769-46f0-adc9-55c71f7a38bd">存储池基本概念</a></li>
<li><a href="#h:7ef8490a-4c6b-49df-8d78-b98c6a47247d">virsh中的存储池相关命令</a></li>
</ul>
</li>
<li><a href="#h:8ae34dc9-c931-48ae-a312-fc20a5757bec">显示存储池信息</a></li>
<li><a href="#h:914513ef-5754-41d4-be63-ada77e407074">基于目录的存储池</a>
<ul>
<li><a href="#h:8399f77b-95aa-4bf9-9b57-fefadddeb11a">创建存储池</a></li>
<li><a href="#h:66261193-dd68-482e-be2d-68f701dbeb0b">删除存储池</a></li>
</ul>
</li>
<li><a href="#h:89f175a7-a59e-4007-8fc8-933d1429c2a0">基于文件系统的存储池</a>
<ul>
<li><a href="#h:2df018c4-755d-4b2b-bb64-d851395ecf14">实现基于文件系统的存储池过程</a></li>
<li><a href="#h:046e07c8-0c69-4a7e-8499-ffba4b686050">管理基于分区的存储池</a></li>
<li><a href="#h:18f90cc9-c7fa-462b-9885-718f08a404f1">删除基于分区的存储池</a></li>
</ul>
</li>
<li><a href="#h:2c49737e-483b-41b7-aba4-cf00dc67ae9f">基于磁盘的存储池</a></li>
<li><a href="#h:0d3e7027-6d78-4c08-a90f-c5e6de084845">基于LVM的存储池</a>
<ul>
<li><a href="#h:5deec363-64f8-4d05-a899-1211f222cc8e">无存在的卷组直接创建存储池</a></li>
<li><a href="#h:4a483419-b885-4b50-bc9f-1741098b7361">利用已有的卷组创建存储池</a></li>
<li><a href="#h:f10c4370-a93c-49a6-b504-5e7596a953b2">virt-manager 利用已有的卷组创建存储池</a></li>
</ul>
</li>
<li><a href="#h:3bfb4c2b-a523-43c8-816d-f931ed8541f6">基于NFS的存储池</a>
<ul>
<li><a href="#h:b4645252-9962-48b8-ad95-b73c1d0d3184">创建NFS共享</a></li>
<li><a href="#h:4054f836-1998-43d0-af94-c6fc9153365c">创建基于NFS服务的存储池</a></li>
<li><a href="#h:74731716-1366-417b-97b9-bc1fff8ba6a6">删除存储池</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:6599b96f-49cf-4ccb-87f0-733d3b973d2f">存储卷管理</a>
<ul>
<li><a href="#h:c6df8ac5-4943-46e3-8351-2f43aedfc8be">存储卷概述</a>
<ul>
<li><a href="#h:d5556989-d31c-434f-9e06-c06c06a60538">存储卷介绍</a></li>
<li><a href="#h:c975c5c8-0619-4066-8481-22dfbcf898c3">存储卷管理相关命令</a></li>
</ul>
</li>
<li><a href="#h:62d7ee3a-9520-4d25-945d-48ba394070b1">基于目录的存储池的存储卷管理</a>
<ul>
<li><a href="#h:07607382-9121-4f17-a0e6-761e48f55e6b">创建基于目录的存储池</a></li>
<li><a href="#h:ca4c4740-577a-4cb6-a97f-d7efadbaf02f">创建基于目录的存储池的存储卷</a></li>
<li><a href="#h:d9732f78-0a42-4da6-923e-bc74ea026eaf">删除基于目录的存储池的存储卷</a></li>
</ul>
</li>
<li><a href="#h:3ba6d77a-a9e8-4478-a070-22ac0b068ec0">基于LVM的存储池的存储卷管理</a>
<ul>
<li><a href="#h:171d7241-d944-4323-bcc0-e44d7d1c33a7">创建基于LVM的存储池</a></li>
<li><a href="#h:7b07c854-9567-43c2-a0c9-b969719b5ea7">创建基于LVM的存储池的存储卷</a></li>
<li><a href="#h:5dcb00e8-adc8-4722-b67e-3deb94fc3c2a">利用存储卷创建虚拟机</a></li>
<li><a href="#h:98718fd0-0393-4ad6-9ec4-b1507c754082">删除基于LVM的存储池的存储卷</a></li>
</ul>
</li>
<li><a href="#h:9aa76f77-bef6-41cc-bfbe-8b68179566f7">克隆存储卷</a>
<ul>
<li><a href="#h:dc4eca6f-e239-459c-8d25-eafa5dd2cd3f">克隆基于文件的存储卷</a></li>
<li><a href="#h:e2a6b09e-fb78-43b2-8408-12e3bac6c9fb">克隆基于LVM的存储卷</a></li>
</ul>
</li>
<li><a href="#h:d066392f-4586-4989-aa40-b5621c2791d8">向虚拟机添加存储卷</a>
<ul>
<li><a href="#h:faf2c601-997b-4abd-9c9c-04606bbb1550">attach-device 通过XML文件给已有虚拟机添加存储卷</a></li>
<li><a href="#h:d6d632ad-88f2-4175-a7a1-9e5d8a80b699">attach-disk 给已有虚拟机添加存储卷</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:5a1e12f7-d0b9-4fa3-ae26-e4d257713ae9">离线工具</a>
<ul>
<li><a href="#h:a6a1d1af-9d7c-455f-ab81-6cbb81f86cbb">离线工具应用</a></li>
<li><a href="#h:74a80aaf-855d-4f33-a10c-72170a445070">guestfs 工具</a>
<ul>
<li><a href="#h:5c435168-1ef4-4f34-ac4b-59d2f22c03a0">安装和使用guestfs</a></li>
<li><a href="#h:465478e3-eb5d-4e12-8600-cb91431fad52">guestfs 自动挂载文件系统</a></li>
<li><a href="#h:a29dd0a8-c610-4850-b733-d37c7938c030">guestfs 离线修改虚拟磁盘内的文件</a></li>
</ul>
</li>
<li><a href="#h:b717cebe-87b2-4cef-aa81-069c899cbc6d">其它离线工具</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:4e0ca775-b0fe-41a8-8657-47b2ba66ad95">网络管理(重要)</a>
<ul>
<li><a href="#h:ccbf294c-eb94-42ed-a4dc-dfa50aa667ed">Linux 网桥实现</a></li>
<li><a href="#h:29937bc9-a882-41ce-a51d-36987c94782c">qemu-kvm支持的网络</a></li>
<li><a href="#h:7493232c-2a3c-4666-b24e-82cc02980d14">默认的网络配置NAT模式</a>
<ul>
<li><a href="#h:02043572-2c5f-404a-8621-9c208fdd4287">默认网络连接的架构图</a></li>
<li><a href="#h:9096afd4-f6df-4bf6-9313-ca619ae09fd9">宿主机默认网络相关服务和信息</a></li>
<li><a href="#h:cb2a2078-d85c-4f01-9bbf-12e385905a2e">虚拟机网卡默认设置</a></li>
<li><a href="#h:24b3f7a1-6d31-4f10-9cb5-fce61298f67e">virsh 查看虚拟机网络配置</a></li>
<li><a href="#h:78866714-be05-4882-96f9-486ef36cf613">向虚拟机添加虚拟网络连接</a></li>
</ul>
</li>
<li><a href="#h:564d25d8-1444-4f09-8cf2-fff05fc08f61">配置虚拟机网卡桥接到宿主机的物理网卡</a></li>
<li><a href="#h:e14a4be5-540c-4825-96eb-6d52a6cdc55d">基于自定义网桥的虚拟网络</a>
<ul>
<li><a href="#h:ffa56881-a5f9-4a97-8cc5-21169a306cea">自定义网桥架构</a></li>
<li><a href="#h:a26f882c-e9f5-439e-987e-b175ce92cea1">创建虚拟机PXE启动并利用kickstart自动安装系统</a>
<ul>
<li><a href="#h:728f5ad7-abfa-40da-846d-82a9761fc030">在宿主机准备PXE环境</a></li>
<li><a href="#h:9a6118d0-2072-4fa3-a1cc-c32da20e926e">在宿主机创建网桥</a></li>
<li><a href="#h:d308aa30-e122-4a95-9476-cc0ed57bfb53">创建桥接自定网桥的虚拟机基于PXE启动并利用kickstart自动安装系统</a></li>
<li><a href="#h:f172a457-7ed0-41a1-a613-d866bd46066d">虚拟机安装过程</a></li>
<li><a href="#h:10eed35d-332f-4d02-b24a-a5b8d744b9c4">验证虚拟机设置</a></li>
<li><a href="#h:3eab527e-8a21-41a7-ac82-4bca1b894573">从外部主机连接虚拟机</a></li>
<li><a href="#h:0ebd4bf3-6a08-497c-a49a-441f9ec53c75">虚拟机手动克隆</a></li>
<li><a href="#h:51500a6b-4c1e-4afd-bb67-b138078b3398">基于现有虚拟机镜像批量创建新虚拟机</a></li>
<li><a href="#h:f1251437-b13e-4ff8-b801-22745f5ff951">查看新虚拟机设置</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:563fa87e-ce35-44a6-a9d5-7454e3199fe3">用户自定义的隔离的虚拟网络</a>
<ul>
<li><a href="#h:028486b2-0dff-4e6d-88cc-2023a57b080d">用户自定义的隔离的虚拟网络架构</a></li>
<li><a href="#h:88f17274-062d-4e9e-89b3-b86f0c7cb0ed">创建用户自定义的隔离的虚拟网络</a></li>
<li><a href="#h:2ffb0e63-e58c-41f5-9ea5-ce3c78a0efa8">修改虚拟机的网卡使用创建的隔离网络</a></li>
<li><a href="#h:b3a90096-a6bf-4dc8-a66e-8d1f28ee36a9">验证自定义的隔离网络主机之间通信</a></li>
<li><a href="#h:f78c3316-1fa9-4bd4-8ef9-e3ef2b447cdf">宿主机查看桥接关系</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:77178b2b-0fe6-4b17-8d13-0e18dbb45408">实战案例</a>
<ul>
<li><a href="#h:631a18aa-8bff-426e-b286-edba79fa3ed5">连接NAS共享存储实现虚拟机实时迁移</a>
<ul>
<li><a href="#h:cae5450a-663e-4b71-acf8-a82ba04445fc">先实现NFS服务</a></li>
<li><a href="#h:b2f10ae9-9b9b-4c8d-ab66-1c37793e1ba4">在宿主机的磁盘文件从目录中移到临时目录</a></li>
<li><a href="#h:aedf63b9-7799-49a5-885d-2d4db93decab">在两台宿主机都实现存储</a>
<ul>
<li><a href="#h:8efb8a6c-3fd1-47cf-bea9-0783f8fc837a">在第一台宿主机实现</a></li>
<li><a href="#h:c40d3881-afa8-4f5d-9c5e-3dc232eec33d">在第二台宿主机实现</a></li>
</ul>
</li>
<li><a href="#h:ca291b7b-9a51-4f62-ab2a-340b692365ab">将原有磁盘文件从临时目录移回原目录</a></li>
<li><a href="#h:e5b81db0-1c80-4c2b-8c8e-e13155731b37">在第一台宿主机连接到第二台宿主机</a></li>
<li><a href="#h:5acbfd2a-d3d4-48c2-9b70-fa4e48a7fc6c">进行迁移</a></li>
<li><a href="#h:7029a20b-4691-4872-adaa-8f60d98f282e">再迁移回来</a></li>
</ul>
</li>
<li><a href="#h:f0c6c6c8-0fbc-4c05-af33-fb845b90caae">内外网络隔离综合案例</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
TAGS: <a href="../../index.html">Linux</a>
</p>


<p>
内容概述
</p>

<ul class="org-ul">
<li>虚拟化基础</li>
<li>虚拟化KVM</li>
<li>创建虚拟机</li>
<li>管理虚拟机</li>
<li>存储管理</li>
<li>网络管理</li>
<li>综合实战案例</li>
</ul>
<section id="outline-container-h:6456b86f-61e3-4db6-8a3a-720f5cfbe6c7" class="outline-2">
<h2 id="h:6456b86f-61e3-4db6-8a3a-720f5cfbe6c7">虚拟化基础</h2>
<div class="outline-text-2" id="text-h:6456b86f-61e3-4db6-8a3a-720f5cfbe6c7">
</div>
<div id="outline-container-h:9b5417b1-2263-4982-815b-9c98b4c8a510" class="outline-3">
<h3 id="h:9b5417b1-2263-4982-815b-9c98b4c8a510">传统的物理机部署方案</h3>
<div class="outline-text-3" id="text-h:9b5417b1-2263-4982-815b-9c98b4c8a510">
<ul class="org-ul">
<li>IDC选择,如:联通,电信,世纪互联,鹏博士等</li>
<li>服务器选型及采购</li>
<li>服务器系统选择、系统安装、上架</li>
<li>应用规划及部署</li>
<li>域名选择及注册</li>
<li>DNS配置映射</li>
<li>测试外网访问</li>
</ul>


<figure id="orgff4173a">
<img src="images/image-20210223105827586.png" alt="image-20210223105827586.png">

</figure>


<figure id="org28b3047">
<img src="images/image-20210223105837765.png" alt="image-20210223105837765.png">

</figure>


<figure id="org591aa04">
<img src="images/image-20210223105849111.png" alt="image-20210223105849111.png">

</figure>


<figure id="orga18089d">
<img src="images/image-20210223105858831.png" alt="image-20210223105858831.png">

</figure>

<p>
<b>传统数据中心面临的问题：</b>
</p>

<ul class="org-ul">
<li><p>
服务器和网络设备资源利用率过低，并且无法共享,导致资源浪费
</p>

<p>
据统计大部分数据中心中的服务器和网络设备的利用率仅在24%～30%之间，有的CPU利用率、硬盘利用率都在10%以下
</p></li>

<li><p>
资源分配后进行调整困难
</p>

<p>
资源分配不合理也是传统网络架构存在的问题，因为资源不能动态调配，分配出去的资源是固定的，不能随意添加或删除。
</p></li>

<li><p>
难以实现自动化
</p>

<p>
初始化成本高,服务器迁移和升级很繁琐，无法实现自动化
</p></li>

<li><p>
成本高昂
</p>

<p>
集群环境需要大量的服务器主机,硬件投入和后期维护管理成本巨大
</p></li>
</ul>
</div>
</div>
<div id="outline-container-h:2eaded6c-7621-4d5d-9a78-d75530896379" class="outline-3">
<h3 id="h:2eaded6c-7621-4d5d-9a78-d75530896379">虚拟化和虚拟机</h3>
<div class="outline-text-3" id="text-h:2eaded6c-7621-4d5d-9a78-d75530896379">
</div>
<div id="outline-container-h:5e02a1c0-61e1-400d-b567-46b0814203cd" class="outline-4">
<h4 id="h:5e02a1c0-61e1-400d-b567-46b0814203cd">虚拟化</h4>
<div class="outline-text-4" id="text-h:5e02a1c0-61e1-400d-b567-46b0814203cd">
<p>
参考资料: <a href="https://www.vmware.com/cn/solutions/virtualization.html">https://www.vmware.com/cn/solutions/virtualization.html</a>
</p>
</div>
</div>
<div id="outline-container-h:d8003d98-6043-4699-9ee4-cfb169135cec" class="outline-4">
<h4 id="h:d8003d98-6043-4699-9ee4-cfb169135cec">什么是虚拟化</h4>
<div class="outline-text-4" id="text-h:d8003d98-6043-4699-9ee4-cfb169135cec">
<p>
在计算机技术中，虚拟化（Virtualization）是一种资源管理技术，是将计算机
的各种实体资源（CPU、内存、磁盘空间、网络适配器等），予以抽象、转换后
呈现出来并可供分割、组合为一个或多个计算机配置环境，并重新分割、重新组
合，以达到最大化合理利用物理资源的目的。
</p>
</div>
</div>
<div id="outline-container-h:99609888-e0f0-43a8-bf99-749db948ca17" class="outline-4">
<h4 id="h:99609888-e0f0-43a8-bf99-749db948ca17">虚拟化优势</h4>
<div class="outline-text-4" id="text-h:99609888-e0f0-43a8-bf99-749db948ca17">
<p>
虚拟化可以提高 IT敏捷性、灵活性和可扩展性，同时大幅节约成本。更高的工
作负载移动性、更高的性能和资源可用性、自动化运维 -这些都是虚拟化的优势，
虚拟化技术可以使 IT部门更轻松地进行管理以及降低拥有成本和运维成本。
</p>

<p>
其优势包括：
</p>

<ul class="org-ul">
<li>资源超分,如物理内存128G,可以给虚拟机分配200G内存</li>
<li>降低资金成本和运维成本</li>
<li>最大限度减少或消除停机</li>
<li>提高 IT 部门的工作效率、效益、敏捷性和响应能力</li>
<li>加快应用和资源的调配速度</li>
<li>提高业务连续性和灾难恢复能力</li>
<li>简化数据中心管理</li>
<li>真正的 Software-Defined Data Center 的可用性</li>
<li>减少端口的冲突</li>
</ul>
</div>
</div>
<div id="outline-container-h:341e99a3-ef69-474c-8947-3227a4f64199" class="outline-4">
<h4 id="h:341e99a3-ef69-474c-8947-3227a4f64199">虚拟化的发展史</h4>
<div class="outline-text-4" id="text-h:341e99a3-ef69-474c-8947-3227a4f64199">

<figure id="org088a71e">
<img src="images/image-20210223105921694.png" alt="image-20210223105921694.png">

</figure>

<pre class="example" id="orgec8fd6f">
1959年，计算机科学家Christopher Strachey发表了一篇名为《大型高速计算机中的时间共享》（Time Sharing in Large Fast Computers）的学术报告，他在文中首次提出了虚拟化的基本概念，被认为是虚拟化技术的最早论述

1964年，IBM推出了专为 System/360 Mainframe 量身订造的操作系统 CP-40，首次实现了虚拟内存和虚拟机。

1967年，第一个管理程序(hypervisor)诞生，5年之后，IBM 发布用于创建灵活大型主机的虚拟机(VM)技术，该技术可根据动态的需求快速而有效地使用各种资源。从此，虚拟化这一词汇正式被引入了IT的现实世界。

20世纪70年代的 System 370 系列中通过虚拟机监控器（Virtual Machine Monitor，VMM）的程序在物理硬件之上生成多个可以独立运行操作系统软件的虚拟机实例

20世纪 90 年代 Windows 的广泛使用以及 Linux 作为服务器系统的出现奠定了 x86 服务器的行业标准地位。

1998年VMware公司在美国成立，1999年VMware发布了它的第一款产品VMware Workstation、 2001年发布VMware GSX Server和VMware ESXI Server宣布进入服务器虚拟化市场， 2003年VMware推出了VMware Virtual Center， 2004年推出了64位支持版本，同年被EMC收购，2013年收入52.1亿美元。2015年10月12日，戴尔与数据存储公司EMC的并购宣布完成，最终戴尔以670亿美元收购了EMC

2003年，Xen实现半虚拟化
2005年，HVM硬件辅助的虚拟化，Intel VT-x，AMD-V
2005年，openVZ出现，在linux平台上的容器化技术实现
2006年，QEMU
2007年，KVM（Kernel-based Virtual Machine）基于内核Linux 2.6.20
2007年8月21日，思杰宣布5亿美元收购XenSource公司，并推出服务器虚拟化XenServer、桌面虚拟化XenDesktop和应用虚拟化XenApp，2013年收入29亿美元。
2008年，LXC发布
2008年3月13日微软在北京发布Windows Server 2008，内置虚拟化技术hyper-v。
2008年9月，红帽以1.07亿美元的价格收购KVM的以色列母公司Qumranet，并推出企业级虚拟化解决方案RHEV，目前最新版本3.3，2013年收入超过13亿美元
2013年，docker发布
2017年11月全球最大公有云厂商AWS宣布了全新的C5实例，该实例完全基于新的虚拟机监控程序（Hypervisor）：KVM。在之前的11年里，AWS的所有虚拟化实例都是基于XEN技术实现的。也就是说AWS也开始转向了KVM之路而不再坚持使用从其诞生之日起一直使用的XEN技术,事实上国内的阿里云早在2015年就开始从XEN切换到KVM
</pre>

<p>
查看虚拟机中使用的虚拟化技术
</p>
<div class="org-src-container">
<pre class="src src-sh">~]# lscpu
Hypervisor vendor:     Xen  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20122;&#39532;&#36874;</span>
Hypervisor vendor:     KVM <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38463;&#37324;&#20113;&#12289;&#33150;&#35759;&#20113;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d4bc18ee-f702-4044-bb47-9cd17bcdae9c" class="outline-4">
<h4 id="h:d4bc18ee-f702-4044-bb47-9cd17bcdae9c">虚拟机</h4>
<div class="outline-text-4" id="text-h:d4bc18ee-f702-4044-bb47-9cd17bcdae9c">
</div>
<div id="outline-container-h:125b88a8-1512-463c-9f0b-bed2a6a70ec1" class="outline-5">
<h5 id="h:125b88a8-1512-463c-9f0b-bed2a6a70ec1">虚拟机</h5>
<div class="outline-text-5" id="text-h:125b88a8-1512-463c-9f0b-bed2a6a70ec1">
<p>
虚拟计算机称为”虚拟机”(VM,Virtual Machine)，它是一种严密隔离且内含操
作系统和应用的软件容器。每个虚拟机都是完全独立的。通过将多台虚拟机放置
在一台物理计算机上，可仅在一台物理服务器或”主机”上运行多个操作系统和
应用，名为”hypervisor”的精简软件层可将虚拟机与主机分离开来，并根据需
要为每个虚拟机动态分配计算资源。
</p>
</div>
</div>
<div id="outline-container-h:96553a7f-3d50-4e0d-99d3-030d9ac69add" class="outline-5">
<h5 id="h:96553a7f-3d50-4e0d-99d3-030d9ac69add">虚拟机的主要特性</h5>
<div class="outline-text-5" id="text-h:96553a7f-3d50-4e0d-99d3-030d9ac69add">
<p>
虚拟机具有以下特征，这些特征可提供多项优势
</p>

<p>
<b>分区</b> 可在一台物理机上运行多个操作系统 可在虚拟机之间分配系统资源。
</p>

<p>
<b>隔离</b> 可在硬件级别进行故障和安全隔离。 可利用高级资源控制功能保持性能
</p>

<p>
<b>封装</b> 可将虚拟机的完整状态保存到文件中。
移动和复制虚拟机就像移动和复制文件一样轻松
</p>

<p>
<b>独立于硬件</b> 可将任意虚拟机调配或迁移到任意物理服务器上
安装系统不会受硬件兼容性的影响
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-h:6a999e4f-b07a-424a-beb4-bdd39a43099d" class="outline-3">
<h3 id="h:6a999e4f-b07a-424a-beb4-bdd39a43099d">虚拟化类型</h3>
<div class="outline-text-3" id="text-h:6a999e4f-b07a-424a-beb4-bdd39a43099d">
</div>
<div id="outline-container-h:fa93879e-409f-4648-ab9a-db5275d27b97" class="outline-4">
<h4 id="h:fa93879e-409f-4648-ab9a-db5275d27b97">服务器虚拟化</h4>
<div class="outline-text-4" id="text-h:fa93879e-409f-4648-ab9a-db5275d27b97">
<p>
服务器虚拟化支持将多个操作系统作为高效的虚拟机在单个物理服务器上运行。主要优势包括：
</p>

<ul class="org-ul">
<li>提升 IT 效率</li>
<li>降低运维成本</li>
<li>更快地部署工作负载</li>
<li>提高应用性能</li>
<li>提高服务器可用性</li>
<li>消除服务器数量剧增情况和复杂性</li>
</ul>
</div>
</div>
<div id="outline-container-h:ad81747c-fe51-41c8-aad0-6c90b948b19d" class="outline-4">
<h4 id="h:ad81747c-fe51-41c8-aad0-6c90b948b19d">网络虚拟化</h4>
<div class="outline-text-4" id="text-h:ad81747c-fe51-41c8-aad0-6c90b948b19d">
<p>
通过软件定义网络(Software Defined Network，SDN)，即网络的创建不再依赖
于物理设备，如公有云厂商允许用户自己创建新的网络，在kubernetes、
openstack中都会使用到网络虚拟化。
</p>
</div>
</div>
<div id="outline-container-h:befa3dd4-8e64-47f4-9a7d-cfb909824e51" class="outline-4">
<h4 id="h:befa3dd4-8e64-47f4-9a7d-cfb909824e51">桌面虚拟化</h4>
<div class="outline-text-4" id="text-h:befa3dd4-8e64-47f4-9a7d-cfb909824e51">
<p>
将桌面部署为代管服务,使 IT组织能够更快地响应不断变化的工作场所需求和新
出现的机会。还可以将虚拟化桌面和应用快速、轻松地交付给分支机构、外包和
离岸员工以及使用iPad 和 Android 平板电脑的移动员工。
</p>

<p>
Citrix思杰公司在云计算虚拟化、虚拟桌面和远程接入技术领域的处于优势地位
</p>
</div>
</div>
<div id="outline-container-h:8530d4c2-d8bc-445a-82e1-e6269eca52d9" class="outline-4">
<h4 id="h:8530d4c2-d8bc-445a-82e1-e6269eca52d9">应用虚拟化</h4>
<div class="outline-text-4" id="text-h:8530d4c2-d8bc-445a-82e1-e6269eca52d9">
<p>
将软件虚拟化，比如 office 365,钉钉,企业微信
</p>
</div>
</div>
<div id="outline-container-h:89a57b72-cc0c-4f3f-8ffb-be92772e9da0" class="outline-4">
<h4 id="h:89a57b72-cc0c-4f3f-8ffb-be92772e9da0">存储虚拟化</h4>
<div class="outline-text-4" id="text-h:89a57b72-cc0c-4f3f-8ffb-be92772e9da0">
<p>
SAN(基于磁盘)/NAS(NFS/Samba)/GlusterFS/ceph等
</p>
</div>
</div>
<div id="outline-container-h:acc986b8-4b1b-42b8-934a-33c93362a600" class="outline-4">
<h4 id="h:acc986b8-4b1b-42b8-934a-33c93362a600">库虚拟化</h4>
<div class="outline-text-4" id="text-h:acc986b8-4b1b-42b8-934a-33c93362a600">
<p>
在linux上运行windows 程序使用wine，在mac系统运行windows程序使用
CrossOver等
</p>
</div>
</div>
<div id="outline-container-h:7030d161-6750-43b1-9319-e112a6b68f3f" class="outline-4">
<h4 id="h:7030d161-6750-43b1-9319-e112a6b68f3f">容器虚技术</h4>
<div class="outline-text-4" id="text-h:7030d161-6750-43b1-9319-e112a6b68f3f">
<p>
被称为下一代虚拟化技术，典型代表: Docker、Podman、Linux Container(LXC)、
Pouch
</p>
</div>
</div>
</div>
<div id="outline-container-h:f640b20c-c3d2-4a0c-8ee3-ea541347f05d" class="outline-3">
<h3 id="h:f640b20c-c3d2-4a0c-8ee3-ea541347f05d">Hypervisor类型</h3>
<div class="outline-text-3" id="text-h:f640b20c-c3d2-4a0c-8ee3-ea541347f05d">
</div>
<div id="outline-container-h:7306b542-cbfa-4804-bf6f-c7bdfe7a806d" class="outline-4">
<h4 id="h:7306b542-cbfa-4804-bf6f-c7bdfe7a806d">Hypervisor 介绍</h4>
<div class="outline-text-4" id="text-h:7306b542-cbfa-4804-bf6f-c7bdfe7a806d">

<figure id="org3663b60">
<img src="images/image-20210223110011986.png" alt="image-20210223110011986.png">

</figure>

<ul class="org-ul">
<li>Hypervisor是一种运行在基础物理服务器和操作系统之间的中间软件层，其可以允许多个操作系统和应用共享底层的内存、CPU、磁盘等物理硬件，也可叫做VMM（
virtual machine monitor），即虚拟机监视器。</li>

<li>Hypervisor是所有虚拟化技术的核心，非中断地支持多工作负载迁移的能力是Hypervisor的基本功能，当服务器启动并执行Hypervisor时，它会给每一台虚拟机分配适量的内存、CPU、网络和磁盘，并加载所有虚拟机的客户操作系统。</li>

<li>多数的虚拟化而采用虚拟机管理程序Hypervisor</li>

<li>允许多种操作系统在相同的物理系统中运行</li>

<li>控制硬件并向来宾操作系统提供访问底层硬件的途径</li>

<li>向来宾操作系统提供虚拟化的硬件</li>
</ul>

<p>
<b>X86 CPU 的保护环</b>
</p>


<figure id="org85ce2f8">
<img src="images/image-20210223110031575.png" alt="image-20210223110031575.png">

</figure>

<p>
<b>注意</b> ：CPU为了保证程序代码执行的安全性、多用户的独立性、保护OS的正常
运行，提出了CPU执行状态的概念。这样能够限制不同程序之间的访问能力，避
免一个程序获取另一个程序的内存数据造成数据混乱，同时也避免了程序错误的
操作物理硬件。一般CPU都会划分为用户态 和内核态 ，x86的CPU架构更是细分
为了Ring3~0四种状态。
</p>


<figure id="orgba6b15c">
<img src="images/image-20210223110047514.png" alt="image-20210223110047514.png">

</figure>

<p>
<b>Ring3 用户态(User Mode)</b> ：运行在用户态的程序代码需要受到CPU的检查，
用户态程序代码只能访问内存页表项中规定能被用户态程序代码访问的页面虚拟
地址(受限的内存访问)，而且还只能访问任务描述符TSS中的I/O Permission
Bitmap中规定能被用户态程序代码访问的端口。甚至不能直接访问外围硬件设备、
不能抢占CPU。所有的应用程序都运行在用户态上。当运行在用户态的
Application需要调用只能被核心态代码直接访问的硬件设备时，CPU会通过特别
的接口去调用核心态的代码，以此来实现Application对硬件设备的调用。如果
用户态的Application直接调用硬件设备时，就会被Host OS捕捉到并触发异常，
弹出警告窗口。
</p>

<p>
<b>Ring0 核心态(Kernel Mode)</b> ：是Host OS Kernel运行的模式，运行在核心态
的代码可以无限制的对系统内存、设备驱动程序、网卡接口、显卡接口等外围硬
件设备进行访问。只有Host OS能够无限制的访问磁盘、键盘等外围硬件设备的
数据，但是首先需要在Host OS上安装驱动程序
</p>
</div>
</div>
<div id="outline-container-h:b5136fcd-5c5c-40bb-8599-02e4aec724a4" class="outline-4">
<h4 id="h:b5136fcd-5c5c-40bb-8599-02e4aec724a4">Hypervisor 分类</h4>
<div class="outline-text-4" id="text-h:b5136fcd-5c5c-40bb-8599-02e4aec724a4">

<figure id="org3d5e913">
<img src="images/image-20210223110109375.png" alt="image-20210223110109375.png">

</figure>

<p>
1974年Gerald J.Popek和Robert P.Goldberg的文章”Formal Requirements
forVirtualizable Third Generation Architectures” 将Hypervisor分为两类:
</p>
</div>
<div id="outline-container-h:9ac171cb-cea2-4f8f-86a2-e1e9807d3999" class="outline-5">
<h5 id="h:9ac171cb-cea2-4f8f-86a2-e1e9807d3999">类型 I : 裸金属型</h5>
<div class="outline-text-5" id="text-h:9ac171cb-cea2-4f8f-86a2-e1e9807d3999">
<p>
直接运行到物理机的Hypervisor上，这种架构搭建的虚拟化环境称为裸机虚拟化环境(Bare-Metal
Hardware
</p>

<ul class="org-ul">
<li>KVM</li>
<li>XEN</li>
<li>vmware esxi</li>
<li>rhev hypervisor</li>
<li>Hyper-v Server</li>
</ul>

<p>
Redhat将KVM划分到类型I即裸机型：
<a href="https://www.redhat.com/zh/topics/virtualization/what-is-KVM">https://www.redhat.com/zh/topics/virtualization/what-is-KVM</a>
</p>
</div>
</div>
<div id="outline-container-h:0b355978-db9e-4a36-80e4-53c1780ecadf" class="outline-5">
<h5 id="h:0b355978-db9e-4a36-80e4-53c1780ecadf">类型 II : 宿主型</h5>
<div class="outline-text-5" id="text-h:0b355978-db9e-4a36-80e4-53c1780ecadf">
<p>
即需要运行在具有虚拟化功能的操作系统上的Hypervisor，构建的是主机虚拟化
环境(Hosted Virtualization)
</p>

<ul class="org-ul">
<li>vmware workstation</li>
<li>Microsoft Hyper-V</li>
<li>VirtualBox</li>
<li>paralles desktop #Mac系统最强虚拟机技术</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-h:02671c9e-a2d2-4a24-b0d1-dd17c8d21ba4" class="outline-3">
<h3 id="h:02671c9e-a2d2-4a24-b0d1-dd17c8d21ba4">虚拟化技术分类</h3>
<div class="outline-text-3" id="text-h:02671c9e-a2d2-4a24-b0d1-dd17c8d21ba4">
</div>
<div id="outline-container-h:0df2a556-342e-43a7-aef7-435dcc0d6eec" class="outline-4">
<h4 id="h:0df2a556-342e-43a7-aef7-435dcc0d6eec">模拟器/软件仿真</h4>
<div class="outline-text-4" id="text-h:0df2a556-342e-43a7-aef7-435dcc0d6eec">

<figure id="org6ba7305">
<img src="images/image-20210223110131017.png" alt="image-20210223110131017.png">

</figure>

<ul class="org-ul">
<li>简介：通过软件模拟完整的硬件环境来虚拟化来宾平台。可以模拟X86、ARM 、PowerPC等多种CPU</li>
<li>优点：Guest OS无需修改，而且非常适合用于操作系统开发，也利于进行固件和硬件的协作开发；</li>
<li>缺点：效率比较低, 速度非常慢，有时速度比物理情况慢100倍以上；</li>
<li>产品或方案:QEMU、Bochs、PearPC</li>
</ul>

<blockquote>
<ol class="org-ol">
<li>模拟：</li>
</ol>
<p>
emulation模拟: 纯软件实现，性能不好。如果物理架构和虚拟架构不一致，如物理x86架构上虚拟ppc架构，则虚拟架构上的非特权指令和特权指令都需要转换，
才可以运行在物理CPU上，故需模拟虚拟机内核的环0、1、2、3；
</p>

<p>
固然可以使上层模拟的环境很灵活，但也意味着上层环境的主机如果执行某一架构指令的话，它就不得不将其转换成底层架构的指令。所以其性能一般是非常差的。
</p>
</blockquote>
</div>
</div>
<div id="outline-container-h:3fd871f2-297f-4159-985d-dd7bf8c96af9" class="outline-4">
<h4 id="h:3fd871f2-297f-4159-985d-dd7bf8c96af9">全虚拟机化 full virtualization / 本地虚拟化 native virtualization</h4>
<div class="outline-text-4" id="text-h:3fd871f2-297f-4159-985d-dd7bf8c96af9">
<p>
<b>不需要对GuestOS操作系统软件的源代码做任何的修改，就可以运行在这样的VMM中</b>
</p>

<p>
在全虚拟化的虚拟平台中，GuestOS并不知道自己是一台虚拟机，它会认为自己
就是运行在计算机物理硬件设备上的HostOS。全虚拟化的GuestOS具有完全的物
理机特性。因为全虚拟化的VMM会将一个OS所能够操作的CPU、内存、外设等物理
设备逻辑抽象成为虚拟CPU、虚拟内存、虚拟外设等虚拟设备后，再交由GuestOS
来操作使用。这样的GuestOS会将底层硬件平台视为自己所有的，但是实际上，
这些都是VMM为GuestOS制造了这种假象。
</p>

<p>
全虚拟化/本地虚拟化不做CPU和内存模拟，只对CPU和内存做相应的分配等操作
</p>

<p>
全虚拟化又分为： <b>软件辅助的全虚拟化  硬件辅助的全虚拟化</b>
</p>
</div>
<div id="outline-container-h:aef80cd3-9748-41ec-be36-b0d0c0547c65" class="outline-5">
<h5 id="h:aef80cd3-9748-41ec-be36-b0d0c0547c65">软件辅助的全虚拟化</h5>
<div class="outline-text-5" id="text-h:aef80cd3-9748-41ec-be36-b0d0c0547c65">

<figure id="orgc16f1f8">
<img src="images/image-20210223110147152.png" alt="image-20210223110147152.png">

</figure>

<p>
在Intel等CPU厂商还没有发布x86
CPU虚拟化技术之前，完全虚拟化都是通过软件辅助的方式来实现的。
</p>

<p>
代表技术: Vmware Workstation,QEMU,Virtual PC
</p>

<p>
当使用GuestOS的时候，不可避免的会调用GuestOS中的虚拟设备驱动程序和核心
调度程序来操作硬件设备。与HostOS的不同在于，HostOS运行在CPU的核心态中，
这就表示HostOS可以直接对硬件设备进行操作。但GuestOS作为一个运行在CPU用
户态中应用程序，不能够直接的操作硬件设备。为了解决这个问题，VMM引用了
两个机制-&#x2013;&#x2014; <b>特权解除和陷入模拟</b> 。
</p>

<p>
软件辅助的全虚拟化主要是应用了两种机制：
</p>

<ul class="org-ul">
<li><b>特权解除</b> ：VMM、GuestOS、GuestApplications都是运行在Ring 1-3用户态
中的应用程序代码.当GuestOS需要调用运行在核心态的指令时，VMM就会动态
的将核心态指令捕获并调用若干运行在非核心态的指令来模拟出期望得到的效
果(GuestOS和VMM是运行在用户态上的应用程序)，从而将核心态的特权解除。
解除了核心态的特权后，就能够在GuestOS中执行大部分的核心态指令了。但
是，这仍然不能完美的解决问题。因为在一个OS的指令集中还存在着一种敏感
指令(可能是内核态，也可能是用户态)。此时就需要陷入模拟的实现。</li>

<li><b>陷入模拟</b> ：无论是HostOS还是GuestOS，只要是一个OS都必然会存在有敏感
指令(reboot、shutdown等)。试想如果我们希望将GuestOS重启，并在GuestOS
中执行了 <code>reboot</code> 指令，但是却将HostOS给重启了，这将会非常糟糕。VMM的陷
入模拟机制就是为了解决这个问题。在GuestOS中执行了敏感指令 reboot 时，
VMM首先会将敏感指令 <code>reboot</code> 捕获、检测并判定其为敏感指令。此时VMM就会
陷入模拟，将敏感指令 reboot模拟成一个只针对GuestOS进行操作的、非敏感
的、并且运行在非核心态上的"reboot" 指令，最后CPU执行虚拟机的重启操作</li>
</ul>

<p>
简而言之，软件辅助虚拟化能够成功的将所有在GuestOS中执行的系统内核特权指令进行捕获、翻译，使之成为只能对GuestOS生效的虚拟特权指令。之所以需要这么做的前提是因为CPU并不能准确的去判断一个特权指令到底是由GuestOS发出的还是由HostOS发出的，这样也就无法针对一个正确的OS去将这一个特权指令执行。
</p>

<p>
由于全虚拟化VMM会频繁的捕获这些核心态的和敏感的指令，将这些指令进行转换之后，再交给CPU执行。所以经过了转换，导致其效率低，但全虚拟化VMM应用程序的好处在于其不需要对GuestOS的核心源码做修改，所以全虚拟化的VMM可以安装绝大部分的OS(暂时来说只有已Linux、open
soralis、BSD等几种OS开源了内核代码)。
</p>

<p>
直到后来CPU厂商们发布了能够判断特权指令归属的标准x86
CPU之后，迎来了硬件辅助全虚拟化。
</p>
</div>
</div>
<div id="outline-container-h:a842d224-2811-4260-9ad2-1120249ec58d" class="outline-5">
<h5 id="h:a842d224-2811-4260-9ad2-1120249ec58d">硬件辅助的全虚拟化 HVM(Hardware Virtual Machine)</h5>
<div class="outline-text-5" id="text-h:a842d224-2811-4260-9ad2-1120249ec58d">

<figure id="orgbe7e121">
<img src="images/image-20210223110159599.png" alt="image-20210223110159599.png">

</figure>

<p>
2005年Intel提出并开发了由CPU直接支持的虚拟化技术。这种虚拟化技术引入新
的CPU运行模式和新的指令集，使得VMM和GuestOS运行于不同的模式下(VMM=Root
Mode;GuestOS=Non-Root Mode)，GuestOS运行于受控模式，原来的一些敏感指令
在受控模式下会全部陷入VMM，由VMM来实现模拟，这样就解决了部分非内核态敏
感指令的陷入-&#x2013;&#x2014;模拟难题，而且模式切换时上下文的保存恢复由硬件来完成，
这样就大大提高了陷入-&#x2013;&#x2014;模拟时上下文切换的效率。该技术的引入使x86
CPU可以很容易地实现完全虚拟化。故皆被几乎所有之前分歧的各大流派所采用，
包括KVM-x86，VMWare ESX Server 3，Xen 3.0 。
</p>

<p>
虚拟化CPU形成了新的CPU执行状态 Non-Root Mode 和 Root Mode .GuestOS运行
在Non-Root Mode的Ring 0核心态中，这意味着GuestOS能够直接执行特权指令,
而不再需要特权解除和陷入模拟机制。并且在硬件层上面紧接的就是虚拟化层的
VMM，而不需要HostOS。这是因为在硬件辅助全虚拟化的VMM会以一种更具协作性
的方式来实现虚拟化-&#x2013;&#x2014;将虚拟化模块加载到HostOS的内核中，例如：KVM，
KVM通过在HostOS内核中加载*KVM Kernel Module*来将HostOS转换成为一个VMM。
所以此时VMM可以看作是HostOS，反之亦然。
</p>

<p>
硬件辅助全虚拟化主要使用了支持虚拟化功能的CPU进行支撑，CPU可以明确的分辨出来自GuestOS的特权指令，并针对GuestOS进行特权操作，而不会影响到HostOS。
</p>

<p>
硬件辅助全虚拟化需要物理硬件的支持，比如需要CPU必须支持并且打开虚拟化功能，例如Intel
的Intel VT-X/EPT，AMD的AMD-V/RVI，以在CPU
层面支持虚拟化功能和内存虚拟化技术
</p>

<p>
全虚拟化软件(硬件辅助全虚拟化)：
</p>
<ul class="org-ul">
<li>vmware esxi</li>
<li>Xen3.0</li>
<li>KVM</li>
<li>Microsoft Hyper-V</li>
<li><p>
vmware workstation <a href="https://www.vmware.com/cn/products/workstation-pro.html">https://www.vmware.com/cn/products/workstation-pro.html</a>
</p>

<p>
打开硬件虚拟化：虚拟机设置&#x2013;硬件&#x2013;处理器&#x2013;虚拟化引擎，勾选“虚拟化Intel VT-x/EPT或 AMD-V/RVI(V)”
</p></li>

<li>VirtualBox</li>
<li>paralles desktop</li>
</ul>

<p>
<b>KVM 是硬件辅助的虚拟化技术</b> ，主要负责比较繁琐的 CPU 和内存虚拟化，而
Qemu 则负责 I/O 虚拟化，两者合作各自发挥自身的优势
</p>


<figure id="orgb9452bf">
<img src="images/image-20210223110214136.png" alt="image-20210223110214136.png">

</figure>

<p>
发展历史： 早期全虚拟化，纯软件模拟性能很差；后来变成半虚拟化，需要修改内核；目前变成硬件辅助的虚拟化
</p>
</div>
</div>
</div>
<div id="outline-container-h:20afd2c7-b2d0-4c48-ba2f-6a47146b64f1" class="outline-4">
<h4 id="h:20afd2c7-b2d0-4c48-ba2f-6a47146b64f1">半虚拟化 para virtualization</h4>
<div class="outline-text-4" id="text-h:20afd2c7-b2d0-4c48-ba2f-6a47146b64f1">

<figure id="org51d2e96">
<img src="images/image-20210223110232479.png" alt="image-20210223110232479.png">

</figure>

<p>
半虚拟化是需要GuestOS协助的虚拟化。因为在半虚拟化VMM中运行的GuestOS，都需要将其内核源码进行都进过了特别的修改。
</p>

<p>
通过修改客户操作系统代码，将原来在物理机上执行的一些特权指令(主要是修
改GuestOS指令集中的敏感指令和核心态指令)，修改成可以和VMM直接交互的方
式，实现操作系统的定制化。这样，就不会有捕获异常、翻译和模拟的过程，性
能损耗比较少。
</p>

<p>
半虚拟化VMM在处理敏感指令和内核态指令的流程上相对更简单一些。让HostOS
在捕抓到GuestOS内核态指令或敏感指令时，HostOS也能够准确的判断出该指令
是否属于GuestOS(GuestOS知道自己是虚拟机)。这样就可以高效的避免了上述问
题。典型的半虚拟化软件有-&#x2013;&#x2014;Xen、KVM-PowerPC(简易指令集)
</p>

<p>
半虚拟化除了修改内核外还有另外一种实现方法-&#x2013;&#x2014;在每一个GuestOS中安装半虚拟化软件，如:VMTools、RHEVTools。
</p>

<p>
<b>注意</b> ：若使用KVM运行Windows时，一定要安装半虚拟化驱动Tools，否则无法
工作。现在主流的半虚拟化驱动是由IBM和redhat联合开发一个通用半虚拟机驱
动virtio。
</p>

<p>
半虚拟化要求guest OS 的内核是知道自己运行在虚拟化环境当中的，因此guest
OS的系统架构必须和宿主机的系统架构相同，并且要求对guest
OS的内核做相应的修改，因此半虚拟化只支持开源内核的系统，不支持闭源的系统，比较常见的半虚拟化就是早期版本的XEN，但是Xen
从其3.0
版本开始，可以支持利用硬件辅助虚拟化技术(<a href="http://www-archive.xenproject.org/files/xen_3.0_datasheet.pdf">http://www-archive.xenproject.org/files/xen_3.0_datasheet.pdf</a>)，实现了完全虚拟化，可以在其平台上不加修改的直接运行如Linux/Windows
等系列的操作系统，使得系统具备了更好的兼容性。
</p>

<p>
<b>xen 的半虚拟化相关技术</b>:
</p>


<figure id="orgbcd4463">
<img src="images/image-20210223110250504.png" alt="image-20210223110250504.png">

</figure>

<ul class="org-ul">
<li>Domain 0：Domain 0 是一个修改过的 Linux kernel，是唯一运行在 Xen
Hypervisor 之上的虚拟机，它拥有访问物理 I/O资源的权限，同时和系统上
运行的其他虚拟机进行交互。Domain 0 需要在其它Domain 启动 之前启动。</li>

<li>Domain U：运行在 Xen Hypervisor上的所有半虚拟化（paravirtualized）虚
拟机被称为”Domain U PV Guests”，其 上运行着被修改过内核的操作系统，
如 Linux、Solaris、FreeBSD等其它 UNIX 操作系统。所有的全虚拟化虚拟
机被称为”Domain U HVM Guests”，其上运行着不用修改内核的操作系统，
如 Windows 等。</li>
</ul>
</div>
</div>
<div id="outline-container-h:5f9e7be0-f626-450e-a10f-2ae3d6d4bdb3" class="outline-4">
<h4 id="h:5f9e7be0-f626-450e-a10f-2ae3d6d4bdb3">各虚拟化技术性能对比</h4>
<div class="outline-text-4" id="text-h:5f9e7be0-f626-450e-a10f-2ae3d6d4bdb3">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">虚拟机名称</th>
<th scope="col" class="org-left">开发厂商及其简介</th>
<th scope="col" class="org-left">虚拟类型</th>
<th scope="col" class="org-left">执行效率</th>
<th scope="col" class="org-left">GuestOS是否可以跨平台</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Xen</td>
<td class="org-left"><a href="http://www.xensource.com/">http://www.xensource.com/</a></td>
<td class="org-left">半虚拟化、完全虚拟化</td>
<td class="org-left">非常高</td>
<td class="org-left">可以</td>
</tr>

<tr>
<td class="org-left">Vmware</td>
<td class="org-left"><a href="http://www.vmware.com/">http://www.vmware.com/</a></td>
<td class="org-left">完全虚拟化</td>
<td class="org-left">较高</td>
<td class="org-left">可以</td>
</tr>

<tr>
<td class="org-left">KVM</td>
<td class="org-left"><a href="http://www.linux-kvm.org/page/Main_Page">http://www.linux-kvm.org/page/Main_Page</a></td>
<td class="org-left">完全虚拟化</td>
<td class="org-left">较高</td>
<td class="org-left">可以</td>
</tr>

<tr>
<td class="org-left">QEMU</td>
<td class="org-left"><a href="http://www.qemu.com/">http://www.qemu.com/</a></td>
<td class="org-left">模拟</td>
<td class="org-left">较低</td>
<td class="org-left">可以</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-h:0637b710-7004-4841-a4b9-207e805ee311" class="outline-3">
<h3 id="h:0637b710-7004-4841-a4b9-207e805ee311">虚拟化技术厂商</h3>
<div class="outline-text-3" id="text-h:0637b710-7004-4841-a4b9-207e805ee311">
</div>
<div id="outline-container-h:cbfd92c7-3896-43b5-93c3-18e3b105ae9a" class="outline-4">
<h4 id="h:cbfd92c7-3896-43b5-93c3-18e3b105ae9a">软件技术厂商</h4>
<div class="outline-text-4" id="text-h:cbfd92c7-3896-43b5-93c3-18e3b105ae9a">

<figure id="org3642523">
<img src="images/image-20210223110321113.png" alt="image-20210223110321113.png">

</figure>
</div>
</div>
<div id="outline-container-h:023a92a3-8f99-4589-9b4e-20481ba13ba9" class="outline-4">
<h4 id="h:023a92a3-8f99-4589-9b4e-20481ba13ba9">硬件技术厂商</h4>
<div class="outline-text-4" id="text-h:023a92a3-8f99-4589-9b4e-20481ba13ba9">
<p>
英特尔® 虚拟化技术（英特尔® VT）
<a href="https://www.intel.cn/content/www/cn/zh/virtualization/virtualization-technology/intel-virtualization-technology.html">https://www.intel.cn/content/www/cn/zh/virtualization/virtualization-technology/intel-virtualization-technology.html</a>
</p>

<p>
Intel从2005年开始支持在CPU中加入硬件虚拟化的支持，intel virtualazation
tochnology，简称intelVT，IntelVT虚拟化技术包括分别针对CPU的增强虚拟化
技术Intel VT-x、I/O虚拟化的Intel VT-d、网络虚拟化的Intel VT-c 技术
</p>
</div>
<div id="outline-container-h:18f721b1-b456-4d96-9e0d-adbaf89e43d9" class="outline-5">
<h5 id="h:18f721b1-b456-4d96-9e0d-adbaf89e43d9">Intel VT-x</h5>
<div class="outline-text-5" id="text-h:18f721b1-b456-4d96-9e0d-adbaf89e43d9">
<p>
Intel VT-x可以让一个CPU工作起来像多个CPU在并行运行，从而使得在一台物理
服务器内可以同时运行多个操作系统，能够降低（甚至消除）多个虚拟机操作系
统之间的资源争夺和限制，从硬件上极大地改善虚拟机的安全性和性能，有助于
提高基于软件的虚拟化解决方案的灵活性与稳定性，此外，Intel VT-x具备的虚
拟机迁移特性还可为IT投资提供有力保护，并进一步提高故障切换、负载均衡、
灾难恢复和维护的灵活性。
</p>

<pre class="example" id="org524d54d">
Intel VT Flex Priority（灵活优先级）：当处理器执行任务时，往往会收到其它设备或应用发出的请求或"中断"命令。为了最大程度减少对性能的影响，处理器内的一个寄存器专用来监控任务优先级，只有优先级高于当前运行任务的请求或"中断"才被及时处理。

Intel VT Flex Migration（灵活迁移）：虚拟化能够在无需停机的情况下，将运行中的虚拟机在物理服务器之间进行迁移，借助此项技术，管理程序能够在迁移池内的所有服务器中建立一套一致的指令，实现工作负载的无缝迁移

Intel VT Extended Page Tables（EPT，扩展页表）：为了降低实现内存虚拟化的难度和提升内存虚拟化的性能，Extended Page Tables直接在硬件上支持虚拟机内存的逻辑地址-&gt;虚拟机内存的物理地址-&gt;物理服务器内存的物理地址的两次转换。
</pre>
</div>
</div>
<div id="outline-container-h:5e7491d9-58ed-43a3-ad49-969712c1f7d8" class="outline-5">
<h5 id="h:5e7491d9-58ed-43a3-ad49-969712c1f7d8">Intel VT-d</h5>
<div class="outline-text-5" id="text-h:5e7491d9-58ed-43a3-ad49-969712c1f7d8">
<p>
Intel VT-d技术支持直接I/O访问，虚拟机创建好之后，数据即可直接在虚拟机
与为其分配的I/O设备之间进行传输，这样就加快了I/O的流动，减少VMM活动及
服务器处理器的负载。
</p>
</div>
</div>
<div id="outline-container-h:1c807f9f-bea6-459d-ad74-4e545ba3d532" class="outline-5">
<h5 id="h:1c807f9f-bea6-459d-ad74-4e545ba3d532">Intel VT-c</h5>
<div class="outline-text-5" id="text-h:1c807f9f-bea6-459d-ad74-4e545ba3d532">
<p>
Intel VT-c技术：支持网络连接的Intel虚拟化技术，包括:
</p>

<pre class="example" id="orgaf7f938">
虚拟机设备队列（VMDq）、虚拟机直接互连（VMDc）。

虚拟机设备队列（VMDq），最大限度提高I/O吞吐率，IntelVT-c可将网络I/O吞吐量提高一倍以上，使虚拟化应用达到接近物理服务器的吞吐率

虚拟机直接互连（VMDc）：大幅提升虚拟化性能。VMDc支持虚拟机直接访问网络I/O硬件，从而显著提升虚
拟机性能，这些通信链路直接绕过了VMM交换机，进一步提升了I/O性能并减少服务器处理器的负载。
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:c6d53d29-8a74-4411-9692-7217cb7786a3" class="outline-3">
<h3 id="h:c6d53d29-8a74-4411-9692-7217cb7786a3">云计算</h3>
<div class="outline-text-3" id="text-h:c6d53d29-8a74-4411-9692-7217cb7786a3">

<figure id="org5aff20b">
<img src="images/image-20210223110336654.png" alt="image-20210223110336654.png">

</figure>
</div>
<div id="outline-container-h:9bc14a23-7e04-4e59-b369-f63bc82fab2d" class="outline-4">
<h4 id="h:9bc14a23-7e04-4e59-b369-f63bc82fab2d">什么是云计算</h4>
<div class="outline-text-4" id="text-h:9bc14a23-7e04-4e59-b369-f63bc82fab2d">

<figure id="orgf4bd0cd">
<img src="images/image-20210223110352502.png" alt="image-20210223110352502.png">

</figure>

<p>
以前电脑被发明的时候，还没有网络，每个电脑，就是一个单机。用户在单机上，
安装操作系统和应用软件，完成自己的工作.后来，有了网络，单机与单机之间，
可以交换信息，协同工作.再后来，单机性能越来越强，就有了服务器。人们发
现，可以把一些服务器集中起来，放在机房里，然后让用户通过网络，去访问和
使用机房里的计算机资源.再再后来，小型网络变成了大型网络，就有了互联网
（Internet）。小型机房变成了大型机房，就有了IDC（Internet Data Center，
互联网数据中心）当越来越多的计算机资源和应用服务被集中起来，就变成
了-&#x2013;&#x2014;"云计算（Cloud Computing）"。无数的大型机房，就成了”云端”
</p>

<p>
云计算(Cloud Computing)是概念最早是由Google 前首席执行官埃里克•施密特
（EricSchmidt）在2006 年8 月9日的搜索引擎大会上首次提出的一种构想，而”云
计算”就是这种构想的代名词，云计算以虚拟化为基础，以网络为中心，为用户
提供安全、快速、便捷的数据存储和网络计算服务，包括所需要的硬件、平台、
软件及服务等资源，而提供资源的网络就被称为”云”。
</p>

<p>
<b>美国国家标准与技术研究院（NIST）定义：云计算是一种按使用量付费的模式，这种模式提供可用的、便捷的、按需的网络访问，
进入可配置的计算资源共享池（资源包括网络，服务器，存储，应用软件，服务），这些资源能够被快速提供，只需投入很少的管理工作，或与服务供应商进行很少的交互</b>
</p>

<p>
云计算是指服务的交付和使用模式，指通过网络以按需、易扩展的方式获得所需
的资源（可以是IT和软件、互联网相关的，也可以使任意其他的服务）。提供资
源的网络被称为”云”。"云"中的资源在使用者看来是可以无限扩展的，并且可
以随时获取，按需使用，随时扩展，按使用付费。意味着计算能力也可以作为一
种商品进行流通，就像煤气、水电一样，取用方便，费用低廉。最大的不同在于，
它是通过网络进行传输的.
</p>

<p>
云是网络、互联网的一种比喻说法。过去在画图时往往用云来表示电信网，后来也用来表示互联网和底层基础设施的抽象
</p>
</div>
</div>
<div id="outline-container-h:e0bafe16-d96c-4681-908e-ed582c59f218" class="outline-4">
<h4 id="h:e0bafe16-d96c-4681-908e-ed582c59f218">云计算分类</h4>
<div class="outline-text-4" id="text-h:e0bafe16-d96c-4681-908e-ed582c59f218">

<figure id="orgdcfec5e">
<img src="images/image-20210223110410870.png" alt="image-20210223110410870.png">

</figure>

<ul class="org-ul">
<li><p>
公有云：Public Cloud，通常指第三方提供商为用户提供的能够通过互联网来
使用的云主机，所有入驻的用户都称为租户。公有云本质上是一种共享资源服
务，最大的特点是成本低，扩展性非常好，对于对安全要求不高的中小型企业
或是个人站长来说是非常好的选择。缺点是对于云端的资源缺乏控制、保密数
据的安全性、网络性能和匹配性问题
</p>

<p>
代表：阿里云、亚马逊、腾讯云、华为云等
</p></li>

<li>私有云：Private Cloud，是为使用者单独使用而构建的，是企业的专有资源，
对数据保密、数据安全、服务质量都能有效控制。特点是安全性与私有化，是
订制化解决方案的根本，可保证企业的数据安全与稳定</li>

<li>混合云： Hybird Cloud，是一种混合了私有云和公有云的新型解决方案，集
公有云的方便便捷与私有云的安全稳定为一体，是近年来云计算的主要模式和
发展方向。企业出于安全考虑，会将敏感数据或是运行关键性的工作负载放在
私有云上面，同时又希望能使用公有云的免费资源，达到安全又省钱的目的。</li>
</ul>

<p>
<b>公有云和私有云的对比</b>
</p>


<figure id="orgbdbd05f">
<img src="images/image-20210223110430312.png" alt="image-20210223110430312.png">

</figure>

<pre class="example" id="orgfbf842f">
公有云：比如阿里云/aws、azure、金山云、腾讯云等都属于公有云，每个人都可以付费使用，不需要自己关心底层硬件，但是数据安全需要考虚

私有云：在自己公司内部或IDC自建Openstack、VMware等环境

混合云：既要使用公有云，又要使用私有云，即自己的私有云的部分业务和公有云有交接，这部分称为混合云
</pre>

<p>
下图为截止到2018年底，全球主要云计算厂商的营收对比：
</p>


<figure id="org2d5b723">
<img src="images/image-20210223110447734.png" alt="image-20210223110447734.png">

</figure>
</div>
</div>
<div id="outline-container-h:914460e2-a7e3-4cdb-bd5e-44c2b37e0811" class="outline-4">
<h4 id="h:914460e2-a7e3-4cdb-bd5e-44c2b37e0811">云计算分层</h4>
<div class="outline-text-4" id="text-h:914460e2-a7e3-4cdb-bd5e-44c2b37e0811">

<figure id="org63e7635">
<img src="images/image-20210223110501935.png" alt="image-20210223110501935.png">

</figure>


<figure id="org730ecec">
<img src="images/image-20210223110515103.png" alt="image-20210223110515103.png">

</figure>

<p>
传统IDC：直接在物理机运行服务，不能快速对业务横向扩容。
</p>

<p>
把计算机资源放在云端，如何提供给用户，又分为三种层次：
</p>

<ul class="org-ul">
<li><p>
第一层次，是最底层的硬件资源，主要包括CPU（计算资源），硬盘（存储资源），还有网卡（网络资源）等，即为IAAS
</p>

<p>
IaaS：Infrastructure as a service,基础设施即服务自建基础服务(openstack)、阿里云ECS。
</p></li>

<li><p>
第二层次，更高级些，用户不直接使用CPU、硬盘、网卡，而是希望把操作系统，数据库软件等安装好，用户再来使用，即为PAAS
</p>

<p>
PaaS：Platform-as-a-service 平台即服务， 如:公有云的RDS云数据库
（Relational DatabaseService）、docker、Redis、SLB(Server Load
Balancer)等服务。
</p></li>

<li><p>
第三层次，更进一步，用户期望不但要装好操作系统等服务，还要把具体的应用软件装好，例如:邮件、OA系统等，用户可以直接使用服务，即为SAAS
</p>

<p>
SaaS：Software-as-a-service 软件即服务，如:企业邮箱、OA系统、云盘、云音乐等
</p></li>
</ul>
</div>
</div>
<div id="outline-container-h:f07789bf-6122-4347-b5a4-e37426e93347" class="outline-4">
<h4 id="h:f07789bf-6122-4347-b5a4-e37426e93347">云计算和虚拟化</h4>
<div class="outline-text-4" id="text-h:f07789bf-6122-4347-b5a4-e37426e93347">
<p>
面对这么多样化多层次的云计算服务，需要对资源进行调用和管理.如果人工对
物理资源进行管理效率太低，需要各种软件和平台，负责对资源进行调用和管理，
即所谓自动化运维管理要对物理资源进行灵活和动态的弹性管理，就需要实现”
虚拟化”
</p>

<p>
通俗的说，虚拟化就是把物理资源转变为逻辑上可以管理的资源，以打破物理结
构间的壁垒，计算元件运行在虚拟的基础上而不是真实的基础上，可以扩大硬件
的容量，简化软件的重新配置过程。
</p>

<p>
虚拟化是云计算的基础。常见的虚拟化就是在一台物理服务器上，运行多台”虚
拟服务器”,也叫虚拟机（VM，Virtual Machine）,从表面来看，这些虚拟机都
是独立的服务器，但实际上，它们共享物理服务器的CPU、内存、硬件、网卡等
资源
</p>

<p>
<b>云计算是一种服务模式，虚拟化是一种技术</b>
</p>

<p>
虚拟化是云计算的重要支撑技术。云计算是基于互联网的相关服务的增加、使用
和交付模式，通常涉及通过互联网来提供动态易扩展且经常是虚拟化的资源。通
过虚拟化，可以将应用程序和数据在不同层次以不同的方式展现给客户，为云计
算的使用者和开发者提供便利。云计算的虚拟化过程为组织带来了灵活性，从而
改善IT运维和减少成本支出.
</p>

<p>
虚拟化和云计算并不是相互捆绑的，而是可以优势互补为用户提供更优质的服务。
在云计算的部署方案中，虚拟化技术可以使其IT资源应用更加灵活。而在虚拟化
的应用过程中，云计算也提供了按需所取的资源和服务。在一些特定场景中，云
计算和虚拟化无法剥离，只有相互搭配才能更好地解决客户需求
</p>

<p>
<b>虚拟化和云的区别</b> 参考链接:
<a href="https://www.redhat.com/zh/topics/cloud-computing/cloud-vs-virtualization">https://www.redhat.com/zh/topics/cloud-computing/cloud-vs-virtualization</a>
</p>

<pre class="example" id="orgd330f32">
由于两者的核心理念都是从硬件中分离资源，以创建可用的环境，所以很容易被混为一谈。虚拟化有助于创建云，但它并非实现云计算的决定性技术。你可以这样理解：
虚拟化是一种将功能与硬件分离的技术
云计算远非只是依赖于这种分离的解决方案

美国国家标准与技术协会这样描述云计算的 5 种功能：一个网络、池化资源、一个用户界面、置备功能、自动化资源控制/分配。虽然虚拟化可以创建网络和池化资源，但还需要其他管理和操作系统软件来创建用户界面、部署虚拟机、控制/分配资源
</pre>

<p>
<b>虚拟化和云计算的对比：</b>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><b>项目</b></td>
<td class="org-left"><b>虚拟化</b></td>
<td class="org-left"><b>云</b></td>
</tr>

<tr>
<td class="org-left">定义</td>
<td class="org-left">技术</td>
<td class="org-left">方法</td>
</tr>

<tr>
<td class="org-left">目的</td>
<td class="org-left">从 1 个物理硬件系统创建多个模拟环境</td>
<td class="org-left">汇聚并自动化分配虚拟资源以供按需使用</td>
</tr>

<tr>
<td class="org-left">用途</td>
<td class="org-left">针对具体用途为特定用户提供打包资源</td>
<td class="org-left">针对多种用途为用户群组提供不同资源</td>
</tr>

<tr>
<td class="org-left">​配置</td>
<td class="org-left">基于镜像</td>
<td class="org-left">基于模板</td>
</tr>

<tr>
<td class="org-left">成本</td>
<td class="org-left">资本性支出（CAPEX）高、运营支出(OPEX)低</td>
<td class="org-left">私有云：CAPEX 高、OPEX低  公共云： CAPEX 低</td>
</tr>

<tr>
<td class="org-left">可扩展性</td>
<td class="org-left">纵向扩展</td>
<td class="org-left">横向扩展</td>
</tr>

<tr>
<td class="org-left">使用场景</td>
<td class="org-left">少量服务器的环境</td>
<td class="org-left">众多服务器的大环境</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="outline-container-h:051433f3-b58d-4698-963d-5299a453a981" class="outline-2">
<h2 id="h:051433f3-b58d-4698-963d-5299a453a981">虚拟化技术之KVM架构和部署</h2>
<div class="outline-text-2" id="text-h:051433f3-b58d-4698-963d-5299a453a981">
</div>
<div id="outline-container-h:7986157e-4a20-46be-9e10-ffc6e67362bb" class="outline-3">
<h3 id="h:7986157e-4a20-46be-9e10-ffc6e67362bb">KVM 概述</h3>
<div class="outline-text-3" id="text-h:7986157e-4a20-46be-9e10-ffc6e67362bb">
</div>
<div id="outline-container-h:30ee8639-ee3b-4a00-8c27-70581f3fa40b" class="outline-4">
<h4 id="h:30ee8639-ee3b-4a00-8c27-70581f3fa40b">KVM 介绍</h4>
<div class="outline-text-4" id="text-h:30ee8639-ee3b-4a00-8c27-70581f3fa40b">

<figure id="orgf912e80">
<img src="images/image-20210223110539718.png" alt="image-20210223110539718.png">

</figure>

<p>
KVM（ Kernel-based Virtual Machine）是一个完整的虚拟化解决方案，适用于
包含虚拟化扩展（IntelVT或AMD-V）的x86硬件上的Linux。目前也支持ARM等其
它硬件平台. 它由可加载的内核模块kvm.ko组成，它提供核心虚拟化基础架构和
处理器特定模块，kvm-intel.ko或kvm-amd.ko，KVM的用户空间组件包含在
QEMU1.3后续版本中,KVM目前已成为学术界的主流VMM (virtual machine
monitor，虚拟机监视器，也称为 hypervisor)之一
</p>

<p>
KVM是开源软件，可运行多个运行未修改的Linux或Windows映像的虚拟机
</p>

<p>
依赖于HVM；Intel VT-x, AMD AMD-V
</p>

<p>
官网： <a href="https://www.linux-kvm.org">https://www.linux-kvm.org</a>
</p>

<p>
2006年10月，以色列 Qumranet 公司发布 KVM,早期开发者 Avi Kivity
</p>

<p>
2007年2月，KVM内核组件收录至Linux 2.6.20及后续版本中
</p>

<p>
2008年9月，Redhat 1.7亿美元收购
</p>

<p>
2009年9月, RHEL5.4 中在集成XEN的同时,也将KVM添加进来
</p>

<p>
2011年11月，RHEL6使用KVM代替XEN
</p>


<figure id="org928f2f1">
<img src="images/image-20210223110603064.png" alt="image-20210223110603064.png">

</figure>

<p>
红帽 kvm 介绍
<a href="https://www.redhat.com/zh/topics/virtualization/what-is-KVM">https://www.redhat.com/zh/topics/virtualization/what-is-KVM</a>
</p>

<p>
RedHat虚拟化指南
<a href="https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/virtualization_getting_started_guide/index">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/virtualization_getting_started_guide/index</a>
</p>

<p>
RedHat创建虚拟机数量限制：
<a href="https://access.redhat.com/articles/rhel-kvm-limits">https://access.redhat.com/articles/rhel-kvm-limits</a>
</p>


<figure id="org3874ed1">
<img src="images/image-20210223110625549.png" alt="image-20210223110625549.png">

</figure>
</div>
</div>
<div id="outline-container-h:ab7af2ae-e1f5-4fe0-b664-607d5e65b9a8" class="outline-4">
<h4 id="h:ab7af2ae-e1f5-4fe0-b664-607d5e65b9a8">KVM架构</h4>
<div class="outline-text-4" id="text-h:ab7af2ae-e1f5-4fe0-b664-607d5e65b9a8">
<p>
KVM 是基于虚拟化扩展（Intel VT 或者 AMD-V）的 X86 硬件的开源的 Linux
原生的全虚拟化解决方案。KVM 中，虚拟机被实现为常规的 Linux 进程，由标准
Linux 调度程序进行调度；虚机的每个虚拟CPU 被实现为一个常规的 Linux
进程。这使得 KVM 能够使用 Linux 内核的已有功能。
</p>

<p>
但是，KVM 本身不执行任何硬件模拟，需要客户空间程序通过 /dev/kvm接口设
置一个客户机虚拟服务器的地址空间，向它提供模拟的I/O，并将它的视频显示
映射回宿主的显示屏。目前这个应用程序是QEMU。
</p>
</div>
<div id="outline-container-h:88b7594e-6f69-43f8-b9fd-a21d183ad1ae" class="outline-5">
<h5 id="h:88b7594e-6f69-43f8-b9fd-a21d183ad1ae">KVM 体系结构</h5>
<div class="outline-text-5" id="text-h:88b7594e-6f69-43f8-b9fd-a21d183ad1ae">

<figure id="org11af03e">
<img src="images/image-20210223110647920.png" alt="image-20210223110647920.png">

</figure>

<ul class="org-ul">
<li>KVM： 初始化CPU硬件,打开虚拟机模式,负责CPU,内存,中断控制器,时钟. 由
内核模块kvm_xxx.ko实现，工作于hypervisor，设备/dev/kvm，是一个字符设
备，在用户空间可通过ioctl()系统调用来完成VM创建、启动，为VM分配内存、
读写VCPU的寄存器、向VCPU注入中断、时钟等管理功能</li>

<li>QEMU进程：工作于用户空间，主要用于实现模拟IO设备,如显卡，网卡，硬盘等，
qemu-kvm进程：工作于用户空间，用于实现一个虚拟机实例</li>

<li>Libvirt：提供统一API，守护进程libvirtd和相关工具，如:virsh，virt-manager等</li>
</ul>
</div>
</div>
<div id="outline-container-h:b1feb9a1-d112-4810-b663-94d3f3088de3" class="outline-5">
<h5 id="h:b1feb9a1-d112-4810-b663-94d3f3088de3">KVM 模块载入后的系统的运行模式</h5>
<div class="outline-text-5" id="text-h:b1feb9a1-d112-4810-b663-94d3f3088de3">

<figure id="org29b73ea">
<img src="images/image-20210223110658953.png" alt="image-20210223110658953.png">

</figure>

<ul class="org-ul">
<li>内核模式：GuestOS执行I/O类操作，或其它的特殊指令的操作；称作”来宾-内核”模式</li>
<li>用户模式：代表GuestOS请求I/O类操作</li>
<li>来宾模式：GuestOS的非I/O类操作；它被称作”来宾-用户”模式,称作虚拟机的用户模式更贴切.</li>
</ul>
</div>
</div>
<div id="outline-container-h:be4c938d-6ad4-40b5-8d9e-9b94e746e55c" class="outline-5">
<h5 id="h:be4c938d-6ad4-40b5-8d9e-9b94e746e55c">KVM 的组件</h5>
<div class="outline-text-5" id="text-h:be4c938d-6ad4-40b5-8d9e-9b94e746e55c">

<figure id="orgdabcb41">
<img src="images/image-20210223110708982.png" alt="image-20210223110708982.png">

</figure>

<p>
KVM：运行在内核空间，提供 CPU 和内存的虚级化，以及客户机的
I/O拦截，Guest的部分I/O被KVM拦截后，交给QEMU处理。
</p>

<p>
两类组件：
</p>

<ul class="org-ul">
<li>(kvm.ko)/dev/kvm：工作为hypervisor，在用户空间可通过系统调用ioctl()
与内核中的kvm模块交互，从而完成虚拟机的创建、启动、停止、删除等各种
管理功能，可虚拟CPU和内存</li>

<li>qemu-kvm进程：工作于用户空间，用于实现IO设备模拟；也用于实现一个虚拟机实例</li>
</ul>
</div>
</div>
<div id="outline-container-h:123fd020-b1ed-4e83-83d3-682af42de90b" class="outline-5">
<h5 id="h:123fd020-b1ed-4e83-83d3-682af42de90b">KVM 功能</h5>
<div class="outline-text-5" id="text-h:123fd020-b1ed-4e83-83d3-682af42de90b">
<p>
KVM 所支持的功能包括：
</p>

<ul class="org-ul">
<li>支持CPU 和 memory 超分（Overcommit）</li>
<li>支持半虚拟化I/O （virtio）</li>
<li>支持热插拔 （cpu，块设备、网络设备等）</li>
<li>支持对称多处理（Symmetric Multi-Processing，缩写为 SMP ）</li>
<li>支持实时迁移（Live Migration）</li>
<li>支持 PCI 设备直接分配和 单根I/O 虚拟化 （SR-IOV）</li>
<li>支持内核同页合并 （KSM ）</li>
<li>支持NUMA （Non-Uniform Memory Access，非一致存储访问结构 ）</li>
</ul>
</div>
</div>
<div id="outline-container-h:a50ad1f3-7eb7-4207-9ef7-a8354e90b26e" class="outline-5">
<h5 id="h:a50ad1f3-7eb7-4207-9ef7-a8354e90b26e">QEMU</h5>
<div class="outline-text-5" id="text-h:a50ad1f3-7eb7-4207-9ef7-a8354e90b26e">
<p>
QEMU是一个广泛使用的开源计算机仿真器和虚拟机。当作为仿真器时，可在一种
架构(如PC机)下运行另一种架构(如ARM)下的操作系统和程序。而通过动态转化，
其可以获得很高的运行效率。当作为一个虚拟机时，qemu可以通过直接使用物理
机的系统资源，让虚拟系统能够获得接近于物理机的性能表现。qemu支持xen或
者kvm模式下的虚拟化。当用kvm时，qemu可以虚拟x86、服务器和嵌入式powerpc，
以及s390的系统
</p>

<p>
QEMU 当运行与主机架构相同的目标架构时可以使用KVM。例如，当在一个x86兼
容处理器上运行qemu-system-x86 时，可以利用 KVM加速-&#x2013;&#x2014;为宿主机和客户
机提供更好的性能
</p>

<p>
Qemu是纯软件实现的虚拟化模拟器，几乎可以模拟任何硬件设备，最熟悉的就是
能够模拟一台能够独立运行操作系统的虚拟机，虚拟机认为自己和硬件打交道，
但其实是和Qemu 模拟出来的硬件打交道，Qemu 将这些指令转译给真正的硬件，
正因为 Qemu是纯软件实现的，所有的指令都要经Qemu，性能非常低，所以，在
生产环境中，大多数的做法都是配合KVM来完成虚拟化工作，KVM完成复杂及要求
比较高的设备虚拟化，而Qemu完成像鼠标、键盘等设备的虚拟化。
</p>

<p>
如果没有kvm模拟cpu，QEMU也可以模拟CPU
</p>

<p>
QEMU有如下几个部分组成：
</p>

<ul class="org-ul">
<li>处理器模拟器(x86、PowerPC和Sparc)</li>
<li>仿真设备(显卡、网卡、硬盘、鼠标等)</li>
<li>用于将仿真设备连接至主机设备(真实设备)的通用设备，实现透传</li>
<li>模拟机的描述信息</li>
<li>调试器</li>
<li>与模拟器交互的用户接口</li>
</ul>
</div>
</div>
<div id="outline-container-h:dd7a6b17-97b9-4be1-89b4-f983dce263ba" class="outline-5">
<h5 id="h:dd7a6b17-97b9-4be1-89b4-f983dce263ba">KVM 局限性</h5>
<div class="outline-text-5" id="text-h:dd7a6b17-97b9-4be1-89b4-f983dce263ba">
<ul class="org-ul">
<li>CPU overcommit：过载使用，性能下降</li>
<li>时间记录难以精确，依赖于时间同步机制，如NTP</li>
<li>VM量特别大时，MAC地址存在冲突的可能性</li>
<li>实时迁移：共享存储，CPU架构，版本等</li>
<li>性能局限性</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:11c7ecf7-3ded-4c1e-ab68-7f3b5bb9db61" class="outline-4">
<h4 id="h:11c7ecf7-3ded-4c1e-ab68-7f3b5bb9db61">比较 KVM 和 Xen</h4>
<div class="outline-text-4" id="text-h:11c7ecf7-3ded-4c1e-ab68-7f3b5bb9db61">
<p>
KVM与XEN对比 
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">XEN</td>
<td class="org-left">KVM</td>
</tr>

<tr>
<td class="org-left">问世时间</td>
<td class="org-left">2003年</td>
<td class="org-left">2007年</td>
</tr>

<tr>
<td class="org-left">支持企业</td>
<td class="org-left">Citrix、Novell、Oracle、Sun、Ret Hat（RHEL5）和 Virtual Iron​</td>
<td class="org-left">Redhat、Ubuntu等</td>
</tr>

<tr>
<td class="org-left">支持的虚、拟化技术</td>
<td class="org-left">全虚拟化、半虚拟化</td>
<td class="org-left">全虚拟化</td>
</tr>

<tr>
<td class="org-left">支持架构</td>
<td class="org-left">x86、IA64和AMD、Fujitsu、IBM、Sun等公司的ARM，以及 x86/64 CPU商家和Intel嵌入式的支持</td>
<td class="org-left">支持虚拟化的CPU</td>
</tr>

<tr>
<td class="org-left">支持操作系统</td>
<td class="org-left">UNIX、Linux和Microsoft Windows</td>
<td class="org-left">UNIX、Linux和Microsoft Windows</td>
</tr>

<tr>
<td class="org-left">动态迁移</td>
<td class="org-left">支持</td>
<td class="org-left">支持（以前不支持）</td>
</tr>

<tr>
<td class="org-left">内核支持</td>
<td class="org-left">需要对内核打补丁</td>
<td class="org-left">内置在内核中</td>
</tr>
</tbody>
</table>

<p>
IBM文档 <a href="http://www.ibm.com/developerworks/cn/linux/l-using-kvm/">http://www.ibm.com/developerworks/cn/linux/l-using-kvm/</a>
</p>

<pre class="example" id="orgf6ff0c4">
Xen 虚拟化环境在传统上提供了 Linux 系统上性能最高的开源虚拟化技术。Xen 使用一个虚拟机管理程序来管理虚拟机和相关的资源，还支持半虚拟化，这可在 "知道" 自己已实现虚拟化的虚拟机中提供更高的性能。Xen 提供了一个专门执行资源和虚拟管理与计划的开源虚拟机管理程序。在裸机物理硬件上引导系统时，Xen 虚拟机管理程序启动一个称为 Domain0 或管理域的主虚拟机，该虚拟机提供了对所有在该物理主机上运行的其他虚拟机（称为 Domain1 到 DomainN，或者简单地称为 Xen Guest）的中央虚拟机管理功能。

不同于 Xen，KVM 虚拟化使用 Linux 内核作为它的虚拟机管理程序。对 KVM 虚拟化的支持自 2.6.20版开始已成为主流 Linux 内核的默认部分。使用 Linux 内核作为虚拟机管理程序是 KVM 受到批评的一个主要方面，因为（在默认情况下）Linux 内核并不符合 Type 1 虚拟机管理程序的传统定义—"一个小操作系统"。尽管大多数 Linux 发行版所提供的默认内核的确如此，但可以轻松地配置 Linux 内核来减少它的编译大小，以便它仅提供作为 Type 1 虚拟机管理程序运行所需的功能和驱动程序。Red Hat 自己的Enterprise Virtualization 产品仅依靠这样一种特殊配置的、相对轻量型的 Linux 内核来运行。但更重要的是，"小"只是一个相对的词汇，如今具有数 GB 内存的 64 位服务器可轻松地提供现代 Linux 内核所需的几 MB 空间。

KVM 超越 Xen 成为大多数企业环境首选的开源裸机虚拟化技术，这有多个原因：

KVM 支持自 2.6.20 版开始已自动包含在每个 Linux 内核中。在 Linux 内核 3.0 版之前，将 Xen支持集成到 Linux 内核中需要应用大量的补丁，但这仍然无法保证每个可能硬件设备的每个驱动程序都能在Xen 环境中正确工作。

Xen 支持所需的内核源代码补丁仅提供给特定的内核版本，这阻止了 Xen 虚拟化环境利用仅在其他内核版本中可用的新驱动程序、子系统及内核修复和增强。KVM 在 Linux 内核中的集成使它能够自动利用新 Linux内核版本中的任何改进。

Xen 要求在物理虚拟机服务器上运行一个特殊配置的 Linux 内核，以用作在该服务器上运行的所有虚拟机的管理域。KVM 可在物理服务器上使用在该物理系统上运行的 Linux VM 中使用的相同内核。
Xen 的虚拟机管理程序是一段单独的源代码，它自己的潜在缺陷与它所托管的操作系统中的缺陷无关。因为KVM 是 Linux 内核的一个集成部分，所以只有内核缺陷能够影响它作为 KVM 虚拟机管理程序的用途。
尽管 Xen 仍可提供比 KVM 性能更高的裸机虚拟化，但这些性能改进的价值常常比不上 KVM 虚拟化的简单性和易用性价值。
</pre>

<p>
目前在各大公有云厂商新购买的虚拟机基本运行在KVM环境下，就连早期一直使用Xen的AWS也在2017年开始逐渐转换到KVM环境，以下是AWS基于KVM技术提供的最新示例部分性能。
</p>


<figure id="orgbbe3c7a">
<img src="images/image-20210223110956911.png" alt="image-20210223110956911.png">

</figure>

<p>
KVM的虚拟化需要硬件支持（如Intel VT技术或者AMD V技术)，是基于硬件的完
全虚拟化，而Xen早期则是基于软件模拟的半虚拟化，新版本则是支持基于硬件
支持的完全虚拟化，但Xen本身有自己的进程调度器，存储管理模块等，所以代
码较为庞大.
</p>

<p>
广为流传的商业系统虚拟化软件VMware ESXI系列是Full-Virtualization
</p>
</div>
</div>
<div id="outline-container-h:d8be2dd6-e1e8-4db3-b667-fae7a93cd7f3" class="outline-4">
<h4 id="h:d8be2dd6-e1e8-4db3-b667-fae7a93cd7f3">RHEL(CentOS)对虚拟设备三种工作模式</h4>
<div class="outline-text-4" id="text-h:d8be2dd6-e1e8-4db3-b667-fae7a93cd7f3">
<pre class="example" id="org36c81f2">
Red Hat Enterprise Linux 7 的虚拟化功能为虚拟机提供了三种不同形式的系统设备。这些硬件设备都
被显示为物理连接到虚拟机，但设备的驱动以不同方式工作。这三种形式包括：
虚拟和仿真设备
半虚拟化设备
物理共享设备
</pre>
</div>
<div id="outline-container-h:bec03876-c083-43d1-becc-dabf22bcea82" class="outline-5">
<h5 id="h:bec03876-c083-43d1-becc-dabf22bcea82">虚拟和仿真设备</h5>
<div class="outline-text-5" id="text-h:bec03876-c083-43d1-becc-dabf22bcea82">
<p>
KVM
实现了虚拟机的多个核心设备。这些仿真硬件设备对虚拟化操作系统至关重要。仿真设备即完全使用软件实现的虚拟化设备
</p>

<p>
仿真驱动可能使用物理设备，或虚拟化软件设备。仿真驱动是虚拟机和 Linux内
核（管理源设备）间的”翻译层”。设备层的指示会由 KVM虚拟机监控程序进行
完全转换。任何可以被 Linux内核识别的同类设备（储存、网络、键盘和鼠标），
都可以作为仿真驱动的后端源设备
</p>

<pre class="example" id="orgd756d57">
虚拟化 CPU （vCPU）：无论主机 CPU 的数量有多少，主机系统都可以为客机提供多达 160 个虚拟化CPU （vCPU）

仿真图形设备：有两种仿真图形设备可供选择。这类设备可以使用 SPICE （Simple Protocol forIndependent Computing Environments）协议或 VNC 进行连接：
    Cirrus CLGD 5446 PCI VGA 卡（使用 cirrus 设备）
    标准 VGA 图形卡，带有 Bochs VESA 扩展程序（硬件等级，包括所有非标准模式）

仿真系统组件：仿真以下核心系统组件来提供基本系统功能：
    Intel i440FX 主机 PCI 网桥，PIIX3 PCI 到 ISA 的网桥，PS/2 鼠标和键盘，EvTouch USB
图形平板设备，PCI UHCI USB 控制器与虚拟化 USB 集线器，仿真串口，EHCI 控制器，虚拟化 USB 存储和 USB 鼠标，USB 3.0 xHCI 主机控制器

仿真声音设备
仿真监视器设备：提供了两种仿真监视器设备。监视器可以在虚拟机超载或未响应时，自动重启虚拟机。
watchdog 程序包务必安装在客机上
两种可供选择的设备为：
i6300esb，仿真 Intel 6300 ESB PCI 监视器设备。为推荐使用设备
ib700，仿真 iBase 700 ISA 监视器设备

仿真网络设备
两种仿真网络设备可供选择：
e1000 设备仿真了 Intel E1000 网络适配器（Intel 82540EM、82573L、82544GC）
rtl8139 设备仿真了 Realtek 8139 网络适配器。

仿真储存驱动：储存驱动与储存池可以使用这些仿真设备，将储存设备与虚拟机相连。客机使用仿真储存驱动可访问储存池
注意，同所有虚拟设备一样，储存驱动不是储存设备。对于虚拟机器，该驱动作为备用储存设备、文件或储存池容量进行使用。备用储存设备可为任何支持的储存设备、文件、或储存池容量形式

仿真 IDE 驱动：KVM 提供两种仿真 PCI IDE 接口。仿真 IDE 驱动可以用于将多达四个虚拟化 IDE 硬盘或虚拟化 IDE 光盘驱动组合与每台虚拟机相连接。仿真 IDE 驱动同样可用于虚拟化 CDROM和 DVD-ROM驱动

仿真软盘驱动：仿真软盘驱动用于创造虚拟化软驱

仿真 AHCI 控制器：仿真 Advanced Host Controller Interface（AHCI）是 IDE 的一种替代产品
</pre>
</div>
</div>
<div id="outline-container-h:536c4957-a39f-444d-a1ba-5a9235eb2b4e" class="outline-5">
<h5 id="h:536c4957-a39f-444d-a1ba-5a9235eb2b4e">半虚拟化设备</h5>
<div class="outline-text-5" id="text-h:536c4957-a39f-444d-a1ba-5a9235eb2b4e">
<p>
半虚拟化设备：半虚拟化为客机使用主机上的设备提供了快速且高效的通讯方式。
KVM为虚拟机提供准虚拟化设备，它使用Virtio API作为虚拟机监控程序和客机
的中间层
</p>

<p>
一些半虚拟化设备可以减少 I/O 的延迟，并把 I/O的吞吐量提高至近裸机水平，
而其它准虚拟化设备可以把本来无法使用的功能添加到虚拟机上。当虚拟机运行
大小需要密集I/O 操作的应用程序时，推荐使用半虚拟化设备，而不是使用仿真
设备
</p>

<p>
所有 virtio设备都有两部分：主机设备和客机驱动。半虚拟化设备驱动允许客
机操作系统访问主机系统上的物理设备
</p>

<p>
半虚拟化设备的驱动必须安装在客机操作系统上。半虚拟化设备驱动须在
Windows客机上手动安装
</p>

<pre class="example" id="org8c1a637">
半虚拟化网络设备（virtio-net）：半虚拟化网络设备是虚拟化网络设备，它为虚拟机提供了网络访问能力，并可以提供网络性能及减少网络延迟。

半虚拟化块设备（virtio-blk）：半虚拟化块设备是高性能虚拟化储存设备，它可以为虚拟机提供高性能、低延迟的 I/O 存储。半虚拟化块设备由虚拟机监控程序支持，与虚拟机相连（软盘驱动除外，它只能被仿真）

半虚拟化控制器设备（virtio-scsi）：半虚拟化 SCSI 控制器设备是一种更为灵活且可扩展的 virtio-blk 替代品。virtio-scsi 客机能继承目标设备的各种特征，并且能操作几百个设备，相比之下，virtio-blk 仅能处理 28

半虚拟化时钟：使用时间戳计数器（TSC，Time Stamp Counter）作为时钟源的客机可能会出现与时间相关的问题。KVM 在主机外围工作，这些主机在向客机提供半虚拟化时间时没有固定的 TSC。此外，半虚拟化时钟会在客机运行 S3 或挂起 RAM 时帮助调整所需时间。半虚拟化时钟不支持 Windows 客机

半虚拟化串口设备 (virtio-serial)：半虚拟化串口设备是面向比特流的字符流设备，它为主机用户空间与客机用户空间之间提供了一个简单的交流接口

气球设备（virtio-balloon）：气球（ballon）设备可以指定虚拟机的部分内存为没有被使用（这个过程被称为气球"充气 " —inflation），从而使这部分内存可以被主机（或主机上的其它虚拟机）使用。当虚拟
机这部分内存时，气球可以进行"放气 "（deflated），主机就会把这部分内存重新分配给虚拟机

半虚拟化随机数字生成器 （virtio-rng：半虚拟化随机数字生成器使虚拟机可以直接从主机收集熵或随意值来使用，以进行数据加密和安全。因为典型的输入数据（如硬件使用情况）不可用，虚拟机常常急需熵。取得熵很耗时；virtiorng通过直接把熵从主机注入客机虚拟机从而使这个过程加快

半虚拟化图形卡（QXL）：半虚拟化图形卡与 QXL 驱动一同提供了一个有效地显示来自远程主机的虚拟机图形界面。SPICE需要 QXL 驱动
</pre>
</div>
</div>
<div id="outline-container-h:d59c89da-ee55-4e75-aaf9-f7333f75bef6" class="outline-5">
<h5 id="h:d59c89da-ee55-4e75-aaf9-f7333f75bef6">透传物理主机设备</h5>
<div class="outline-text-5" id="text-h:d59c89da-ee55-4e75-aaf9-f7333f75bef6">
<p>
物理主机设备：特定硬件平台允许虚拟机直接访问多种硬件设备及组件。在虚拟
化中，此操作被称为”设备分配"（device assignment）。设备分配又被称作"
传递 “（passthrough）
</p>

<pre class="example" id="orgebf56e4">
VFIO 设备分配：虚拟功能 I/O（VFIO）是 RHEL 7 中一个新的内核驱动，它为虚拟机提供了高性能的访问物理硬件。VFIO 把主机系统上的 PCI 设备与虚拟机直接相连，允许客机在执行特定任务时有独自访问PCI 设备的权限。这就象 PCI 设备物理地连接到客机虚拟机上一样。通过把设备分配从 KVM 虚拟机监控系统中移出，并在内核级中强制进行设备隔离，VFIO 比以前的PCI 设备分配有很大改进。VFIO 安全性更高。VFIO 也支持对NVIDIA GPU 的分配

USB 传递：KVM hyperviso 支持把主机系统上的 USB 设备连接到虚拟机。USB 设备分配允许客机拥有在执行特定任务时有专有访问 USB 设备的权利。这就象 USB 设备物理地连接到虚拟机上一样

SR-IOV：SR-IOV （Single Root I/O Virtualization）是一个 PCI 快捷标准，把单一物理 PCI功能扩展到同分散的虚拟化功能（VF）一样共享 PCI 资源。通过 PCI 设备分配，每个功能可以被不同虚拟机使用。支持 SR-IOV 的 PCI-e 设备提供一个单一根功能（如单一以太网接口），并把多个各自分离的虚拟设备作为独特 PCI 设备功能。每个虚拟化设备都可能有自身独特的 PCI 配置空间、内存映射的寄存器以及单独的基于 MSI 的中断系统

NPIV：N_Port ID Virtualization（NPIV）是对光纤通道设备有效的功能。NPIV 共享单一物理

N_Port 作为多个 N_Port ID。NPIV 为 HBA（光纤通道主机总线适配器，Fibre Channel Host BusAdapter）提供和 SR-IOV 为 PCIe 接口提供的功能相似的功能。有了 NPIV，可以为 SAN（存储区域网络，Storage Area Network）提供带有虚拟光纤通道发起程序的虚拟机。NPIV 可以提供带有企业级存储解决方案的高密度虚拟环境
</pre>
</div>
</div>
</div>
<div id="outline-container-h:337ab43c-6938-49d5-bd35-ce37e0ca56f0" class="outline-4">
<h4 id="h:337ab43c-6938-49d5-bd35-ce37e0ca56f0">KVM 集中管理与控制</h4>
<div class="outline-text-4" id="text-h:337ab43c-6938-49d5-bd35-ce37e0ca56f0">
<p>
<a href="http://www.linux-kvm.org/page/Management_Tools">http://www.linux-kvm.org/page/Management_Tools</a>
</p>


<figure id="org533c425">
<img src="images/image-20210223111538183.png" alt="image-20210223111538183.png">

</figure>

<ul class="org-ul">
<li><p>
oVirt 功能强大，是Redhat虚拟化管理平台RHEV的开源版本。
</p>

<p>
<a href="http://www.ovirt.org/">http://www.ovirt.org/</a>
</p></li>

<li><p>
WebVirtMgr
</p>

<p>
<a href="https://www.webvirtmgr.net">https://www.webvirtmgr.net</a>
</p>

<p>
virt-manager的Web模式的替代品
</p>


<figure id="org3e5da1c">
<img src="images/image-20210223193330498.png" alt="image-20210223193330498.png">

</figure></li>

<li><p>
OpenStack
</p>

<p>
最主流的开源虚拟化管理平台
</p></li>

<li><p>
Proxmox virtualization environment
</p>

<p>
简称PVE，是一个开源免费的基于linux的企业级虚拟化方案，功能不输专业收
费的VMware。是一个完整的企业虚拟化开源平台。借助内置的Web界面，您可
以轻松管理VM和容器，软件定义的存储和网络，高可用性集群以及单个解决方
案上的多个开箱即用工具。
</p></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:40878fbd-bd50-459d-b6f1-6a554e637103" class="outline-3">
<h3 id="h:40878fbd-bd50-459d-b6f1-6a554e637103">宿主机环境准备</h3>
<div class="outline-text-3" id="text-h:40878fbd-bd50-459d-b6f1-6a554e637103">
<p>
KVM需要宿主机CPU必须支持虚拟化功能，因此如果是在vmware
workstation上使用虚拟机做宿主机，那么必须要在虚拟机配置界面的处理器选项中开启虚拟机化功能。
</p>
</div>
<div id="outline-container-h:b3724adb-ec3b-437b-8d7a-53027c489619" class="outline-4">
<h4 id="h:b3724adb-ec3b-437b-8d7a-53027c489619">CPU开启虚拟化</h4>
<div class="outline-text-4" id="text-h:b3724adb-ec3b-437b-8d7a-53027c489619">
<p>
vmware workstation
</p>

<ul class="org-ul">
<li>打开硬件虚拟化：虚拟机设置&#x2013;硬件&#x2013;处理器&#x2013;虚拟化引擎，勾选“虚拟化Intel VT-x/EPT或 AMD-V/RVI(V)”</li>
</ul>


<figure id="org9f2eb35">
<img src="images/image-20210223111553576.png" alt="image-20210223111553576.png">

</figure>
</div>
</div>
<div id="outline-container-h:25d3b317-65a4-4461-9d07-2908de0b68f2" class="outline-4">
<h4 id="h:25d3b317-65a4-4461-9d07-2908de0b68f2">验证开启虚拟化</h4>
<div class="outline-text-4" id="text-h:25d3b317-65a4-4461-9d07-2908de0b68f2">
<p>
查看硬件支持虚拟化信息
</p>
<div class="org-src-container">
<pre class="src src-sh">grep -Em 1     <span style="color: #8b2252;">"vmx|svm"</span> /proc/cpuinfo

<span style="color: #b22222;">#</span><span style="color: #b22222;">Intel CPU &#23545;&#24212; vmx</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">AMD CPU &#23545;&#24212; svm</span>
[root@centos8 ~]#gr
</pre>
</div>

<p>
范例: 验证是否开启虚拟化支持
</p>

<div class="org-src-container">
<pre class="src src-sh">grep -Em 1 <span style="color: #8b2252;">"vmx|svm"</span> /proc/cpuinfo
flags : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat
pse36 clflush mmx fxsr sse sse2 syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm
constant_tsc rep_good nopl tsc_reliable nonstop_tsc cpuid extd_apicid pni
pclmulqdq ssse3 fma cx16 sse4_1 sse4_2 x2apic movbe popcnt aes xsave avx f16c
rdrand hypervisor lahf_lm svm extapic cr8_legacy abm sse4a misalignsse
3dnowprefetch osvw ssbd ibpb vmmcall fsgsbase bmi1 avx2 smep bmi2 rdseed adx
smap clflushopt clwb sha_ni xsaveopt xsavec xsaves clzero arat npt svm_lock
nrip_save vmcb_clean flushbyasid decodeassists overflow_recov succor
</pre>
</div>


<figure id="org35079bb">
<img src="images/image-20210223111617390.png" alt="image-20210223111617390.png">

</figure>

<p>
范例: 查看AMD主机的内核模块
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#lscpu|grep svm
Flags:                             fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca
cmov pat pse36 clflush mmx fxsr sse sse2 syscall nx mmxext fxsr_opt pdpe1gb
rdtscp lm constant_tsc rep_good nopl tsc_reliable nonstop_tsc cpuid extd_apicid
pni pclmulqdq ssse3 fma cx16 sse4_1 sse4_2 x2apic movbe popcnt aes xsave avx
f16c rdrand hypervisor lahf_lm svm extapic cr8_legacy abm sse4a misalignsse
3dnowprefetch osvw ssbd ibpb vmmcall fsgsbase bmi1 avx2 smep bmi2 rdseed adx
smap clflushopt clwb sha_ni xsaveopt xsavec xsaves clzero arat npt svm_lock
nrip_save vmcb_clean flushbyasid decodeassists overflow_recov succor

[root@centos8 ~]#lsmod |grep kvm
kvm_amd                             110592     0
ccp                                         98304     1 kvm_amd
kvm                                     786432     1 kvm_amd
irqbypass                             16384     1 kvm

~]# modinfo kvm_amd

[root@centos8 ~]#ll /dev/kvm
crw-rw-rw- 1 root kvm 10, 232 Sep 13 21:21 /dev/kvm
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:5bdbbdbc-8e93-4a60-be21-80cc111cdb6d" class="outline-3">
<h3 id="h:5bdbbdbc-8e93-4a60-be21-80cc111cdb6d">安装KVM工具包</h3>
<div class="outline-text-3" id="text-h:5bdbbdbc-8e93-4a60-be21-80cc111cdb6d">
</div>
<div id="outline-container-h:8aa9478b-eb64-49b8-a931-5b990dede0ca" class="outline-4">
<h4 id="h:8aa9478b-eb64-49b8-a931-5b990dede0ca">KVM 相关工具包介绍</h4>
<div class="outline-text-4" id="text-h:8aa9478b-eb64-49b8-a931-5b990dede0ca">
<ul class="org-ul">
<li>qemu-kvm: 为kvm提供底层仿真支持</li>
<li>libvirt-daemon: libvirtd守护进程，管理虚拟机</li>
<li>libvirt-client: 用户端软件，提供客户端管理命令</li>
<li>libvirt-daemon-driver-qemu: libvirtd连接qemu的驱动</li>
<li>libvirt:
使用最多的KVM虚拟化管理工具和应用程序接口，即通过libvirt调用KVM创建虚拟机，</li>
<li>libvirt是KVM通用的访问API，其不但能管理KVM，还能管理VMware、Xen、Hyper-V、virtualBox等虚拟化方案。</li>
<li>virt-manager: 图形界面管理工具,其底层也是调用libvirt
API来完成对虚拟机的操作，包括虚拟机的创建、删除、启动、停止以及一些简单的监控功能等。</li>
<li>virt-install: 虚拟机命令行安装工具</li>
<li>virsh: 命令行工具是基于 libvirt API
创建的命令行工具，它可以作为图形化的 virt-manager
应用的备选工具。virsh
命令可以被用来创建虚拟化任务管理脚本，如安装、启动和停止虚拟机</li>
<li>virt-viewer: 通过 VNC 和 SPICE
协议显示虚拟机器图形控制台的最小工具。该工具在其同名软件包中：virtviewer</li>
<li>cockpit: CentOS8 专门提供的基于Web的虚拟机管理界面</li>
</ul>
</div>
</div>
<div id="outline-container-h:94b300a9-fc63-40c6-b5c8-2c1bdec94b3d" class="outline-4">
<h4 id="h:94b300a9-fc63-40c6-b5c8-2c1bdec94b3d">libvirt 包功能</h4>
<div class="outline-text-4" id="text-h:94b300a9-fc63-40c6-b5c8-2c1bdec94b3d">
</div>
<div id="outline-container-h:a0f1d9ee-cadf-4e93-85e3-97a657247929" class="outline-5">
<h5 id="h:a0f1d9ee-cadf-4e93-85e3-97a657247929">libvirt 介绍</h5>
<div class="outline-text-5" id="text-h:a0f1d9ee-cadf-4e93-85e3-97a657247929">

<figure id="orgc4bbb56">
<img src="images/image-20210223111640845.png" alt="image-20210223111640845.png">

</figure>

<p>
libvirt
程序包是一个与虚拟机监控程序相独立的虚拟化应用程序接口，它可以与操作系统的一系列虚拟化性能进行交互
</p>

<p>
libvirt 程序包提供：
</p>

<ul class="org-ul">
<li>一个稳定的通用层来安全地管理主机上的虚拟机。</li>
<li>一个管理本地系统和连网主机的通用接口。</li>
</ul>

<p>
在虚拟机监控程序支持的情况下，部署、创建、修改、监测、控制、迁移以及停止虚拟机操作都需要这些API。尽管
libvirt 可同时访问多个主机，但 API 只限于单节点操作
</p>

<p>
libvirt 程序包被设计为用来构建高级管理工具和应用程序，例如 virt-manager
与 virsh 命令行管理工具。libvirt 主要的功能是管理单节点主机，并提供 API
来列举、监测和使用管理节点上的可用资源，其中包括CPU、内存、储存、网络和非一致性内存访问（NUMA）分区。管理工具可以位于独立于主机的物理机上，并通过安全协议和主机进行交流
</p>
</div>
</div>
<div id="outline-container-h:5cbc72f3-1d4d-4f04-b33d-29378fa471d3" class="outline-5">
<h5 id="h:5cbc72f3-1d4d-4f04-b33d-29378fa471d3">libvirt 结构图</h5>
<div class="outline-text-5" id="text-h:5cbc72f3-1d4d-4f04-b33d-29378fa471d3">

<figure id="orgd602f8e">
<img src="images/image-20210223111652991.png" alt="image-20210223111652991.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:db08008d-e2e5-4809-b016-44bf36d89b3b" class="outline-4">
<h4 id="h:db08008d-e2e5-4809-b016-44bf36d89b3b">安装KVM相关包</h4>
<div class="outline-text-4" id="text-h:db08008d-e2e5-4809-b016-44bf36d89b3b">
</div>
<div id="outline-container-h:e521c28a-37ff-4ab5-95d7-70d8767760a3" class="outline-5">
<h5 id="h:e521c28a-37ff-4ab5-95d7-70d8767760a3">CentOS 安装 KVM</h5>
<div class="outline-text-5" id="text-h:e521c28a-37ff-4ab5-95d7-70d8767760a3">
<p>
使用虚拟化，需要至少 qemu-kvm 和 qemu-img(安装qemu-kvm会自动安装) 软件包
</p>

<p>
建议安装：yum install qemu-kvm libvirt virt-manager virt-install
</p>

<p>
范例: CentOS 8 安装 KVM相关工具
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum -y install qemu-kvm libvirt    virt-manager virt-install virt-viewer
[root@centos8 ~]#systemctl start --now libvirtd
</pre>
</div>

<p>
范例: CentOS 8 还提供基于Web的虚拟机管理方式
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum -y install cockpit
[root@centos8 ~]#systemctl enable --now cockpit.socket
Created symlink /etc/systemd/system/sockets.target.wants/cockpit.socket &#8594;/usr/lib/systemd/system/cockpit.socket.
[root@centos8 ~]#dnf -y install cockpit

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25171;&#24320;&#27983;&#35272;&#22120;&#65292;&#35775;&#38382;&#20197;&#19979;&#22320;&#22336;&#65306;</span>
https://centos8&#20027;&#26426;:9090
</pre>
</div>


<figure id="orgedac451">
<img src="images/image-20210223111716313.png" alt="image-20210223111716313.png">

</figure>
</div>
</div>
<div id="outline-container-h:fe8e887d-8f70-4c02-9cdc-90fb25b817a9" class="outline-5">
<h5 id="h:fe8e887d-8f70-4c02-9cdc-90fb25b817a9">Ubuntu 安装 KVM</h5>
<div class="outline-text-5" id="text-h:fe8e887d-8f70-4c02-9cdc-90fb25b817a9">
<p>
Ubuntu 18.04： 官方文档:
<a href="https://ubuntu.com/server/docs/virtualization-libvirt">https://ubuntu.com/server/docs/virtualization-libvirt</a>
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">apt install qemu-kvm virt-manager libvirt-daemon-system</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">kvm-ok #&#39564;&#35777;&#26159;&#21542;&#25903;&#25345;kvm,&#21482;&#26377;Ubuntu&#25903;&#25345;,CentOS &#19981;&#25903;&#25345;</span>
INFO: /dev/kvm exists
KVM acceleration can be used
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu1804 ~]#apt -y install qemu-kvm virt-manager libvirt-daemon-system
[root@ubuntu1804 ~]#ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group
default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
            valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
            valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP
group default qlen 1000
    link/ether 00:0c:29:40:27:06 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.100/24 brd 10.0.0.255 scope global eth0
            valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe40:2706/64 scope link
            valid_lft forever preferred_lft forever
3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN
group default qlen 1000
    link/ether 52:54:00:8d:a6:fe brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
            valid_lft forever preferred_lft forever
4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state
DOWN group default qlen 1000
    link/ether 52:54:00:8d:a6:fe brd ff:ff:ff:ff:ff:ff

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#27809;&#26377;&#24320;&#21551;CPU&#34394;&#25311;&#21270;&#21151;&#33021;&#20250;&#25552;&#31034;&#20197;&#19979;&#20449;&#24687;</span>
[root@ubuntu1804 ~]#kvm-ok
INFO: Your CPU does not support KVM extensions
KVM acceleration can NOT be used

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;CPU&#30340;&#34394;&#25311;&#21270;&#25903;&#25345;&#20877;&#25191;&#34892;</span>
[root@ubuntu1804 ~]#kvm-ok
INFO: /dev/kvm exists
KVM acceleration can be used
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:2e3b2598-8d4e-48c7-a2f2-f4e792cbd435" class="outline-4">
<h4 id="h:2e3b2598-8d4e-48c7-a2f2-f4e792cbd435">图形化工具 virt-manager</h4>
<div class="outline-text-4" id="text-h:2e3b2598-8d4e-48c7-a2f2-f4e792cbd435">
<p>
范例: CentOS 上管理工具 virt-manager
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#export <span style="color: #a0522d;">DISPLAY</span>=10.0.0.1:0.0
[root@centos8 ~]#virt-manager
[root@centos8 ~]#libGL error: No matching fbConfigs or visuals found
libGL error: failed to load driver: swrast
</pre>
</div>


<figure id="orgce97b07">
<img src="images/image-20210223111741885.png" alt="image-20210223111741885.png">

</figure>

<p>
范例: Ubuntu 上管理工具 virt-manager
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu1804 ~]#virt-manager
</pre>
</div>


<figure id="org964e3c1">
<img src="images/image-20210223111755646.png" alt="image-20210223111755646.png">

</figure>
</div>
</div>
<div id="outline-container-h:a8efbaab-8ed9-4ecd-8a76-d7aaa99267f6" class="outline-4">
<h4 id="h:a8efbaab-8ed9-4ecd-8a76-d7aaa99267f6">默认网络配置</h4>
<div class="outline-text-4" id="text-h:a8efbaab-8ed9-4ecd-8a76-d7aaa99267f6">
<p>
安装完虚拟工具后,会自动生成一个 virbr0 网卡,类似于Vmware workstation
生成的VMnet8 网卡,充当虚拟机的 NAT 网卡
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group
default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
            valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
            valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP
group default qlen 1000
    link/ether 00:0c:29:8a:51:21 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0
            valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe8a:5121/64 scope link
            valid_lft forever preferred_lft forever
3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN
group default qlen 1000
    link/ether 52:54:00:97:eb:e3 brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
            valid_lft forever preferred_lft forever
4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state
DOWN group default qlen 1000
    link/ether 52:54:00:97:eb:e3 brd ff:ff:ff:ff:ff:ff

[root@centos8 ~]#grep -R 192.168.122.1 /etc/libvirt/*
/etc/libvirt/qemu/networks/autostart/default.xml: &lt;ip <span style="color: #a0522d;">address</span>=<span style="color: #8b2252;">'192.168.122.1'</span>
<span style="color: #a0522d;">netmask</span>=<span style="color: #8b2252;">'255.255.255.0'</span>&gt;
/etc/libvirt/qemu/networks/default.xml: &lt;ip <span style="color: #a0522d;">address</span>=<span style="color: #8b2252;">'192.168.122.1'</span>
<span style="color: #a0522d;">netmask</span>=<span style="color: #8b2252;">'255.255.255.0'</span>&gt;root@centos8 ~]#ip a show virbr0
3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN
group default qlen 1000
    link/ether 52:54:00:97:eb:e3 brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
            valid_lft forever preferred_lft forever

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32593;&#26725;&#20449;&#24687;</span>
[root@centos8 ~]#cat /etc/libvirt/qemu/networks/default.xml
&lt;!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
virsh net-edit default
or other application using the libvirt API.
--&gt;
&lt;network&gt;
&lt;name&gt;default&lt;/name&gt;
&lt;uuid&gt;1ebc4504-5da9-4b7e-b367-90b8cb20029b&lt;/uuid&gt;
&lt;forward <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">'nat'</span>/&gt;
&lt;bridge <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'virbr0'</span> <span style="color: #a0522d;">stp</span>=<span style="color: #8b2252;">'on'</span> <span style="color: #a0522d;">delay</span>=<span style="color: #8b2252;">'0'</span>/&gt;
&lt;mac <span style="color: #a0522d;">address</span>=<span style="color: #8b2252;">'52:54:00:97:eb:e3'</span>/&gt;
&lt;ip <span style="color: #a0522d;">address</span>=<span style="color: #8b2252;">'192.168.122.1'</span> <span style="color: #a0522d;">netmask</span>=<span style="color: #8b2252;">'255.255.255.0'</span>&gt;
    &lt;dhcp&gt;
        &lt;range <span style="color: #a0522d;">start</span>=<span style="color: #8b2252;">'192.168.122.2'</span> <span style="color: #a0522d;">end</span>=<span style="color: #8b2252;">'192.168.122.254'</span>/&gt;
    &lt;/dhcp&gt;
&lt;/ip&gt;
&lt;/network&gt;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#32593;&#26725;&#20449;&#24687;</span>
[root@centos8 ~]#nmcli connection show virbr0
connection.id:                                                 virbr0
connection.uuid:                                             54c671c1-28be-4ce7-8a0e-30ee0ecdca64
connection.stable-id:                                     --
connection.type:                                             bridge
connection.interface-name:                         virbr0
connection.autoconnect:                                 no
connection.autoconnect-priority:                 0
connection.autoconnect-retries:                 -1 (default)
connection.multi-connect:                             0 (default)
connection.auth-retries:                                 -1
connection.timestamp:                                     1596945412
connection.read-only:                                     no
connection.permissions:                                 --
connection.zone:                                                 --
connection.master:                                             --
connection.slave-type:                                     --
connection.autoconnect-slaves:                     -1 (default)
connection.secondaries:                                 --
connection.gateway-ping-timeout:                 0
connection.metered:                                         unknown
connection.lldp:                                             default
connection.mdns:                                                 -1 (default)
connection.llmnr:                                             -1 (default)
connection.wait-device-timeout:                 -1
ipv4.method:                                                     manual
ipv4.dns:                                                             --
ipv4.dns-search:                                                 --
ipv4.dns-options:                                             --
ipv4.dns-priority:                                             100
ipv4.addresses:                                                 192.168.122.1/24
ipv4.gateway:                                                     --
ipv4.routes:                                                         --
ipv4.route-metric:                                             -1
ipv4.route-table:                                             0 (unspec)
ipv4.routing-rules:                                         --
ipv4.ignore-auto-routes:                             no
ipv4.ignore-auto-dns:                                     no
ipv4.dhcp-client-id:                                         --
ipv4.dhcp-iaid:                                                 --
ipv4.dhcp-timeout:                                             0 (default)
ipv4.dhcp-send-hostname:                                 yes
ipv4.dhcp-hostname:                                         --
ipv4.dhcp-fqdn:                                                 --
ipv4.dhcp-hostname-flags:                             0x0 (none)
ipv4.never-default:                                         no
ipv4.may-fail:                                                     yes
ipv4.dad-timeout:                                             -1 (default)
ipv6.method:                                                     ignore
ipv6.dns:                                                             --
ipv6.dns-search:                                                 --
ipv6.dns-options:                                             --
ipv6.dns-priority:                                             100
ipv6.addresses:                                                 --
ipv6.gateway:                                                     --
ipv6.routes:                                                         --
ipv6.route-metric:                                             -1
ipv6.route-table:                                             0 (unspec)
ipv6.routing-rules:                                         --
ipv6.ignore-auto-routes:                             no
ipv6.ignore-auto-dns:                                     no
ipv6.never-default:                                         no
ipv6.may-fail:                                                     yes
ipv6.ip6-privacy:                                             -1 (unknown)
ipv6.addr-gen-mode:                                         stable-privacy
ipv6.ra-timeout:                                                 0 (default)
ipv6.dhcp-duid:                                                 --
ipv6.dhcp-iaid:                                                 --
ipv6.dhcp-timeout:                                             0 (default)
ipv6.dhcp-send-hostname:                                 yes
ipv6.dhcp-hostname:                                         --
ipv6.dhcp-hostname-flags:                             0x0 (none)
ipv6.token:                                                         --
bridge.mac-address:                                         --
bridge.stp:                                                         yes
bridge.priority:                                                 32768
bridge.forward-delay:                                     2
bridge.hello-time:                                             2
bridge.max-age:                                                 20
bridge.ageing-time:                                         300
bridge.group-forward-mask:                             0
bridge.multicast-snooping:                             yes
bridge.vlan-filtering:                                 no
bridge.vlan-default-pvid:                             1
bridge.vlans:                                                     --
proxy.method:                                                     none
proxy.browser-only:                                         no
proxy.pac-url:                                                     --
proxy.pac-script:                                             --
GENERAL.NAME:                                                     virbr0
GENERAL.UUID:                                                     54c671c1-28be-4ce7-8a0e-30ee0ecdca64
GENERAL.DEVICES:                                             virbr0
GENERAL.IP-IFACE:                                             virbr0
GENERAL.STATE:                                                 activated
GENERAL.DEFAULT:                                             no
GENERAL.DEFAULT6:                                             no
GENERAL.SPEC-OBJECT:                                         --
GENERAL.VPN:                                                     no
GENERAL.DBUS-PATH:                                     
/org/freedesktop/NetworkManager/ActiveConnection/3
GENERAL.CON-PATH:                                         
/org/freedesktop/NetworkManager/Settings/2
GENERAL.ZONE:                                                     --
GENERAL.MASTER-PATH:                                         --
IP4.ADDRESS[1]:                                                 192.168.122.1/24
IP4.GATEWAY:                                                         --
IP4.ROUTE[1]:                                                     dst = 192.168.122.0/24, nh = 0.0.0.0, mt
= 0
IP6.GATEWAY:                                                         --
[root@centos8 ~]#
</pre>
</div>

<p>
范例: Ubuntu 网络配置
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@ubuntu1804 ~]#ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group
default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
            valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
            valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP
group default qlen 1000
    link/ether 00:0c:29:40:27:06 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.100/24 brd 10.0.0.255 scope global eth0
            valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe40:2706/64 scope link
            valid_lft forever preferred_lft forever
3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN
group default qlen 1000
    link/ether 52:54:00:8d:a6:fe brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
            valid_lft forever preferred_lft forever
4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state
DOWN group default qlen 1000
    link/ether 52:54:00:8d:a6:fe brd ff:ff:ff:ff:ff:ff
[root@ubuntu1804 ~]#brctl show
bridge name bridge id STP enabled interfaces
virbr0 8000.5254008da6fe yes virbr0-nic

[root@ubuntu1804 ~]#cat /etc/libvirt/qemu/networks/default.xml
&lt;!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
virsh net-edit default
or other application using the libvirt API.
--&gt;
&lt;network&gt;
&lt;name&gt;default&lt;/name&gt;
&lt;uuid&gt;a3235b68-6dc0-4951-8a35-7a60a567f1a7&lt;/uuid&gt;
&lt;forward <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">'nat'</span>/&gt;
&lt;bridge <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'virbr0'</span> <span style="color: #a0522d;">stp</span>=<span style="color: #8b2252;">'on'</span> <span style="color: #a0522d;">delay</span>=<span style="color: #8b2252;">'0'</span>/&gt;
&lt;mac <span style="color: #a0522d;">address</span>=<span style="color: #8b2252;">'52:54:00:8d:a6:fe'</span>/&gt;
&lt;ip <span style="color: #a0522d;">address</span>=<span style="color: #8b2252;">'192.168.122.1'</span> <span style="color: #a0522d;">netmask</span>=<span style="color: #8b2252;">'255.255.255.0'</span>&gt;
    &lt;dhcp&gt;
        &lt;range <span style="color: #a0522d;">start</span>=<span style="color: #8b2252;">'192.168.122.2'</span> <span style="color: #a0522d;">end</span>=<span style="color: #8b2252;">'192.168.122.254'</span>/&gt;
    &lt;/dhcp&gt;
&lt;/ip&gt;
&lt;/network&gt;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:c4d2833c-096f-4202-aa72-5649254e5760" class="outline-3">
<h3 id="h:c4d2833c-096f-4202-aa72-5649254e5760">准备安装系统的ISO相关文件</h3>
<div class="outline-text-3" id="text-h:c4d2833c-096f-4202-aa72-5649254e5760">
<p>
将需要安装的系统的ISO文件上传到宿主机
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mkdir -pv /data/isos/
[root@centos8 ~]#ls /data/isos/
CentOS-7-x86_64-Minimal-2003.iso
CentOS-8.2.2004-x86_64-minimal.iso
cn_windows_server_2008_r2_standard_enterprise_datacenter_and_web_with_sp1_vl_bui
ld_x64_dvd_617396.iso
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3ddf663b-e0bf-410c-8942-f79e8f71b618" class="outline-3">
<h3 id="h:3ddf663b-e0bf-410c-8942-f79e8f71b618">AMD CPU 创建虚拟机时的故障排错</h3>
<div class="outline-text-3" id="text-h:3ddf663b-e0bf-410c-8942-f79e8f71b618">
<p>
AMD CPU 使用virt-manager 或 virt-install
在创建虚拟机可能会出错,用下面方法解决
</p>
</div>
<div id="outline-container-h:dc71a9ba-a964-4085-9879-59b0e22a6637" class="outline-4">
<h4 id="h:dc71a9ba-a964-4085-9879-59b0e22a6637">AMD CPU 使用virt-manager创建虚拟机出错提示</h4>
<div class="outline-text-4" id="text-h:dc71a9ba-a964-4085-9879-59b0e22a6637">

<figure id="org9360f83">
<img src="images/image-20210223111821352.png" alt="image-20210223111821352.png">

</figure>
</div>
</div>
<div id="outline-container-h:e1ceaf62-349e-4e83-a04a-581bc749fd55" class="outline-4">
<h4 id="h:e1ceaf62-349e-4e83-a04a-581bc749fd55">AMD CPU 使用virt-install创建虚拟机出错提示</h4>
<div class="outline-text-4" id="text-h:e1ceaf62-349e-4e83-a04a-581bc749fd55">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virt-install --virt-type kvm --name centos7 --ram 1024 --vcpus
2 --cdrom=/data/isos/CentOS-7-x86_64-Minimal-2003.iso --disk
<span style="color: #a0522d;">path</span>=/var/lib/libvirt/images/centos7.qcow2 --network <span style="color: #a0522d;">network</span>=default --graphics
vnc,<span style="color: #a0522d;">listen</span>=0.0.0.0 --noautoconsole
WARNING No operating system detected, VM performance may suffer. Specify an OS
with --os-variant for optimal results.
Starting install...
ERROR     internal error: qemu unexpectedly closed the monitor: 2020-08-
09T15:57:08.872365Z qemu-kvm: error: failed to set MSR 0xe1 to 0x0
qemu-kvm: /builddir/build/BUILD/qemu-2.12.0/target/i386/kvm.c:2119:
kvm_buf_set_msrs: Assertion <span style="color: #ff00ff;">`ret == cpu-&gt;kvm_msr_buf-&gt;nmsrs' failed.</span>
<span style="color: #ff00ff;">Domain installation does not appear to have been successful.</span>
<span style="color: #ff00ff;">If it was, you can restart your domain by running:</span>
<span style="color: #ff00ff;">virsh --connect qemu:///system start centos7</span>
<span style="color: #ff00ff;">otherwise, please restart your installation.</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d5e54f46-f761-4bbf-a2c2-db18811b4f3f" class="outline-4">
<h4 id="h:d5e54f46-f761-4bbf-a2c2-db18811b4f3f">AMD CPU 创建虚拟机故障修复方法</h4>
<div class="outline-text-4" id="text-h:d5e54f46-f761-4bbf-a2c2-db18811b4f3f">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#22797;&#20197;&#19978;&#25925;&#38556;</span>
[root@centos8 ~]# tee /etc/modprobe.d/qemu-system-x86.conf &lt;&lt; EOF
<span style="color: #ffa54f;">options kvm ignore_msrs=1</span>
<span style="color: #ffa54f;">EOF</span>

options kvm <span style="color: #a0522d;">ignore_msrs</span>=1
[root@centos8 ~]#reboot
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:3501a7ea-6ce6-4332-ad1a-6591be3b0686" class="outline-2">
<h2 id="h:3501a7ea-6ce6-4332-ad1a-6591be3b0686">创建虚拟机</h2>
<div class="outline-text-2" id="text-h:3501a7ea-6ce6-4332-ad1a-6591be3b0686">
</div>
<div id="outline-container-h:34aeaab3-8fa1-44e1-b574-f28e46bb8ff5" class="outline-3">
<h3 id="h:34aeaab3-8fa1-44e1-b574-f28e46bb8ff5">使用 virt-manager 创建虚拟机</h3>
<div class="outline-text-3" id="text-h:34aeaab3-8fa1-44e1-b574-f28e46bb8ff5">
<p>
virt-manager 是一个图形化虚拟机管理工具,方便管理和查看虚拟机
</p>

<p>
缺点：交互式操作繁琐，不能批量安装。
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#export <span style="color: #a0522d;">DISPLAY</span>=10.0.0.1:0.0
[root@centos8 ~]#virt-manager
[root@centos8 ~]#libGL error: No matching fbConfigs or visuals found
libGL error: failed to load driver: swrast
</pre>
</div>


<figure id="org70fc568">
<img src="images/image-20210223111902896.png" alt="image-20210223111902896.png">

</figure>


<figure id="orgd4bb36f">
<img src="images/image-20210223111934347.png" alt="image-20210223111934347.png">

</figure>


<figure id="org8472b94">
<img src="images/image-20210223111946311.png" alt="image-20210223111946311.png">

</figure>


<figure id="orgbfd729a">
<img src="images/image-20210223111956110.png" alt="image-20210223111956110.png">

</figure>


<figure id="orgf89d05b">
<img src="images/image-20210223112005749.png" alt="image-20210223112005749.png">

</figure>


<figure id="org1ace3cc">
<img src="images/image-20210223112015990.png" alt="image-20210223112015990.png">

</figure>


<figure id="orgb91bee8">
<img src="images/image-20210223112026486.png" alt="image-20210223112026486.png">

</figure>


<figure id="orgd357628">
<img src="images/image-20210223112107150.png" alt="image-20210223112107150.png">

</figure>


<figure id="orgac2b543">
<img src="images/image-20210223112116630.png" alt="image-20210223112116630.png">

</figure>


<figure id="org7034ec8">
<img src="images/image-20210223112128776.png" alt="image-20210223112128776.png">

</figure>


<figure id="orgc85ccd1">
<img src="images/image-20210223112143710.png" alt="image-20210223112143710.png">

</figure>


<figure id="org5c73b08">
<img src="images/image-20210223112155151.png" alt="image-20210223112155151.png">

</figure>


<figure id="orga76ea60">
<img src="images/image-20210223112208978.png" alt="image-20210223112208978.png">

</figure>


<figure id="orged1dc2e">
<img src="images/image-20210223112229868.png" alt="image-20210223112229868.png">

</figure>


<figure id="orgf1152fe">
<img src="images/image-20210223112245088.png" alt="image-20210223112245088.png">

</figure>

<p>
虚拟机磁盘文件位置
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">virt-manager&#21019;&#24314;&#30340;&#30913;&#30424;&#65292;&#20998;&#22810;&#22823;&#23454;&#38469;&#21344;&#29992;&#22810;&#22823;</span>
[root@centos8 ~]#ll /var/lib/libvirt/images/centos8.qcow2 -h
-rw------- 1 qemu qemu 21G Sep 13 20:08 /var/lib/libvirt/images/centos8.qcow2
</pre>
</div>
</div>
</div>
<div id="outline-container-h:dd83b8fc-8884-4355-9571-5f8a5243c41f" class="outline-3">
<h3 id="h:dd83b8fc-8884-4355-9571-5f8a5243c41f">使用 virt-install 创建虚拟机</h3>
<div class="outline-text-3" id="text-h:dd83b8fc-8884-4355-9571-5f8a5243c41f">
<p>
虽然使用virt-manager可以方便的管理虚拟机,但如果需要批量进行虚拟机的创
建管理,命令行工具virt-install更加适合
</p>
</div>
<div id="outline-container-h:642308e9-e526-45a0-bf1f-f1ef7696d8d6" class="outline-4">
<h4 id="h:642308e9-e526-45a0-bf1f-f1ef7696d8d6">virt-install 使用说明</h4>
<div class="outline-text-4" id="text-h:642308e9-e526-45a0-bf1f-f1ef7696d8d6">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">virt-install --help</span>
usage: virt-install --name NAME --ram RAM STORAGE INSTALL [options]
&#20351;&#29992; <span style="color: #8b2252;">'--option=?'</span> &#25110;&#32773; <span style="color: #8b2252;">'--option help'</span> &#26597;&#30475;&#21487;&#29992;&#23376;&#36873;&#39033;
&#26377;&#20851;&#31034;&#20363;&#21450;&#23436;&#25972;&#36873;&#39033;&#35821;&#27861;&#65292;&#35831;&#26597;&#30475; man page&#12290;
&#20351;&#29992;&#25351;&#23450;&#23433;&#35013;&#20171;&#36136;&#26032;&#24314;&#34394;&#25311;&#26426;
optional arguments:
-h, --help show this help message and exit
--version show program<span style="color: #8b2252;">'s version number and exit</span>
<span style="color: #8b2252;">--connect URI &#20351;&#29992; libvirt URI &#36830;&#25509;&#21040; hypervisor</span>
<span style="color: #8b2252;">&#36890;&#29992;&#36873;&#39033;:</span>
<span style="color: #8b2252;">-n NAME, --name NAME &#23458;&#25143;&#31471;&#34394;&#25311;&#26426;&#30340;&#21517;&#31216;</span>
<span style="color: #8b2252;">--memory MEMORY &#37197;&#32622;&#34394;&#25311;&#26426;&#20869;&#23384;&#20998;&#37197;</span>
<span style="color: #8b2252;">&#20363;&#22914;&#65306;</span>
<span style="color: #8b2252;">--memory 1024 (in MiB)</span>
<span style="color: #8b2252;">--memory 512,maxmemory=1024</span>

<span style="color: #8b2252;">--vcpus VCPUS &#20026;&#34394;&#25311;&#26426;&#37197;&#32622;&#30340; vcpus &#25968;&#12290;</span>
<span style="color: #8b2252;">&#20363;&#22914;&#65306;</span>
<span style="color: #8b2252;">--vcpus 5</span>
<span style="color: #8b2252;">--vcpus 5,maxcpus=10,cpuset=1-4,6,8</span>
<span style="color: #8b2252;">--vcpus sockets=2,cores=4,threads=2</span>

<span style="color: #8b2252;">--cpu CPU CPU &#22411;&#21495;&#21450;&#21151;&#33021;&#12290;</span>
<span style="color: #8b2252;">&#20363;&#22914;&#65306;</span>
<span style="color: #8b2252;">--cpu coreduo,+x2apic</span>
<span style="color: #8b2252;">--cpu host</span>

<span style="color: #8b2252;">--metadata METADATA &#37197;&#32622;&#34394;&#25311;&#26426;&#20803;&#25968;&#25454;</span>
<span style="color: #8b2252;">&#20363;&#22914;&#65306;</span>
<span style="color: #8b2252;">--metadata name=foo,title="My pretty title",uuid=...</span>
<span style="color: #8b2252;">--metadata description="My nice long description"</span>

<span style="color: #8b2252;">&#23433;&#35013;&#26041;&#27861;&#36873;&#39033;:</span>
<span style="color: #8b2252;">--cdrom CDROM &#20809;&#39537;&#23433;&#35013;&#20171;&#36136;</span>
<span style="color: #8b2252;">-l LOCATION, --location LOCATION &#23433;&#35013;&#28304;</span>
<span style="color: #8b2252;">&#20363;&#22914;&#65306;</span>
<span style="color: #8b2252;">nfs:host:/path</span>
<span style="color: #8b2252;">http://host/path</span>
<span style="color: #8b2252;">ftp://host/path</span>

<span style="color: #8b2252;">--pxe &#20351;&#29992; PXE &#21327;&#35758;&#20174;&#32593;&#32476;&#24341;&#23548;</span>
<span style="color: #8b2252;">--import &#22312;&#30913;&#30424;&#26144;&#20687;&#20013;&#26500;&#24314;&#34394;&#25311;&#26426;</span>
<span style="color: #8b2252;">--livecd &#23558;&#20809;&#39537;&#20171;&#36136;&#35270;&#20026; Live CD</span>
<span style="color: #8b2252;">-x EXTRA_ARGS, --extra-args EXTRA_ARGS &#38468;&#21152;&#21040;&#20351;&#29992; --location &#24341;&#23548;&#30340;&#20869;&#26680;&#30340;&#21442;&#25968;</span>
<span style="color: #8b2252;">--initrd-inject INITRD_INJECT &#20351;&#29992; --location &#20026; initrd &#30340; root &#28155;&#21152;&#32473;&#23450;&#25991;&#20214;</span>
<span style="color: #8b2252;">--os-variant DISTRO_VARIANT &#22312;&#20854;&#20013;&#23433;&#35013; OS &#21464;&#20307;&#30340;&#34394;&#25311;&#26426;,&#27604;</span>
<span style="color: #8b2252;">&#22914;:'</span>fedora18<span style="color: #8b2252;">'&#12289;'</span>rhel6<span style="color: #8b2252;">'&#12289;'</span>winxp<span style="color: #8b2252;">' &#31561;&#31561;</span>

<span style="color: #8b2252;">--boot BOOT &#37197;&#32622;&#34394;&#25311;&#26426;&#24341;&#23548;&#35774;&#32622;&#12290;</span>
<span style="color: #8b2252;">&#20363;&#22914;&#65306;</span>
<span style="color: #8b2252;">--boot hd,cdrom,menu=on</span>
<span style="color: #8b2252;">--boot init=/sbin/init (for containers)</span>

<span style="color: #8b2252;">--idmap IDMAP &#20026; LXC &#23481;&#22120;&#21551;&#29992;&#29992;&#25143;&#21517;&#31216;&#31354;&#38388;&#12290;</span>
<span style="color: #8b2252;">&#20363;&#22914;&#65306;</span>
<span style="color: #8b2252;">--idmap uid_start=0,uid_target=1000,uid_count=10</span>

<span style="color: #8b2252;">&#35774;&#22791;&#36873;&#39033;:</span>
<span style="color: #8b2252;">--disk DISK &#20351;&#29992;&#19981;&#21516;&#36873;&#39033;&#25351;&#23450;&#23384;&#20648;&#12290;&#20363;&#22914;&#65306;</span>
<span style="color: #8b2252;">--disk size=10 (new 10GiB image in default location)</span>
<span style="color: #8b2252;">--disk /my/existing/disk,cache=none</span>
<span style="color: #8b2252;">--disk device=cdrom,bus=scsi</span>
<span style="color: #8b2252;">--disk=?</span>
<span style="color: #8b2252;">-w NETWORK, --network NETWORK &#37197;&#32622;&#34394;&#25311;&#26426;&#32593;&#32476;&#25509;&#21475;&#12290;</span>
<span style="color: #8b2252;">&#20363;&#22914;&#65306;</span>
<span style="color: #8b2252;">--network bridge=mybr0</span>
<span style="color: #8b2252;">--network network=my_libvirt_virtual_net</span>
<span style="color: #8b2252;">--network network=mynet,model=virtio,mac=00:11...</span>
<span style="color: #8b2252;">--network none</span>
<span style="color: #8b2252;">--network help</span>

<span style="color: #8b2252;">--graphics GRAPHICS &#37197;&#32622;&#34394;&#25311;&#26426;&#26174;&#31034;&#35774;&#32622;&#12290;</span>
<span style="color: #8b2252;">&#20363;&#22914;&#65306;</span>
<span style="color: #8b2252;">--graphics vnc</span>
<span style="color: #8b2252;">--graphics spice,port=5901,tlsport=5902</span>
<span style="color: #8b2252;">--graphics none</span>
<span style="color: #8b2252;">--graphics vnc,password=foobar,port=5910,keymap=ja</span>

<span style="color: #8b2252;">--controller CONTROLLER &#37197;&#32622;&#34394;&#25311;&#26426;&#25511;&#21046;&#31243;&#24207;&#35774;&#22791;&#12290;</span>
<span style="color: #8b2252;">&#20363;&#22914;&#65306;</span>
<span style="color: #8b2252;">--controller type=usb,model=ich9-ehci1</span>

<span style="color: #8b2252;">--input INPUT &#37197;&#32622;&#34394;&#25311;&#26426;&#36755;&#20837;&#35774;&#22791;&#12290;</span>
<span style="color: #8b2252;">&#20363;&#22914;&#65306;</span>
<span style="color: #8b2252;">--input tablet</span>
<span style="color: #8b2252;">--input keyboard,bus=usb</span>

<span style="color: #8b2252;">--serial SERIAL &#37197;&#32622;&#34394;&#25311;&#26426;&#20018;&#21475;&#35774;&#22791;</span>
<span style="color: #8b2252;">--parallel PARALLEL &#37197;&#32622;&#34394;&#25311;&#26426;&#24182;&#21475;&#35774;&#22791;</span>
<span style="color: #8b2252;">--channel CHANNEL &#37197;&#32622;&#34394;&#25311;&#26426;&#27807;&#36890;&#39057;&#36947;</span>
<span style="color: #8b2252;">--console CONSOLE &#37197;&#32622;&#34394;&#25311;&#26426;&#19982;&#20027;&#26426;&#20043;&#38388;&#30340;&#25991;&#26412;&#25511;&#21046;&#21488;&#36830;&#25509;</span>
<span style="color: #8b2252;">--hostdev HOSTDEV &#23558;&#29289;&#29702; USB/PCI/etc &#20027;&#26426;&#35774;&#22791;&#37197;&#32622;&#20026;&#19982;&#34394;&#25311;&#26426;&#20849;&#20139;</span>
<span style="color: #8b2252;">--filesystem FILESYSTEM &#23558;&#20027;&#26426;&#30446;&#24405;&#20256;&#36882;&#32473;&#34394;&#25311;&#26426;&#12290;</span>
<span style="color: #8b2252;">&#20363;&#22914;&#65306;</span>
<span style="color: #8b2252;">--filesystem /my/source/dir,/dir/in/guest</span>
<span style="color: #8b2252;">--filesystem template_name,/,type=template</span>

<span style="color: #8b2252;">--sound [SOUND] &#37197;&#32622;&#34394;&#25311;&#26426;&#22768;&#38899;&#35774;&#22791;&#27169;&#25311;</span>
<span style="color: #8b2252;">--watchdog WATCHDOG &#37197;&#32622;&#34394;&#25311;&#26426; watchdog &#35774;&#22791;</span>
<span style="color: #8b2252;">--video VIDEO &#37197;&#32622;&#34394;&#25311;&#26426;&#35270;&#39057;&#30828;&#20214;&#12290;</span>
<span style="color: #8b2252;">--smartcard SMARTCARD &#37197;&#32622;&#34394;&#25311;&#26426;&#26234;&#33021;&#21345;&#35774;&#22791;&#12290;&#20363;&#22914;&#65306;--smartcard mode=passthrough</span>

<span style="color: #8b2252;">--redirdev REDIRDEV &#37197;&#32622;&#34394;&#25311;&#26426;&#37325;&#23450;&#21521;&#35774;&#22791;&#12290;&#20363;&#22914;&#65306;--redirdev usb,type=tcp,server=192.168.1.1:4000</span>
<span style="color: #8b2252;">--memballoon MEMBALLOON &#37197;&#32622;&#34394;&#25311;&#26426; memballoon &#35774;&#22791;&#12290;&#20363;&#22914;&#65306;--memballoon model=virtio</span>
<span style="color: #8b2252;">--tpm TPM &#37197;&#32622;&#34394;&#25311;&#26426; TPM &#35774;&#22791;&#12290;&#20363;&#22914;&#65306;--tpm /dev/tpm</span>
<span style="color: #8b2252;">--rng RNG &#37197;&#32622;&#34394;&#25311;&#26426; RNG &#35774;&#22791;&#12290;&#20363;&#22914;&#65306;--rng /dev/random</span>
<span style="color: #8b2252;">--panic PANIC &#37197;&#32622;&#34394;&#25311;&#26426; panic &#35774;&#22791;&#12290;&#20363;&#22914;&#65306;--panic default</span>

<span style="color: #8b2252;">&#34394;&#25311;&#26426;&#37197;&#32622;&#36873;&#39033;:</span>
<span style="color: #8b2252;">--security SECURITY &#35774;&#23450;&#22495;&#23433;&#20840;&#39537;&#21160;&#22120;&#37197;&#32622;&#12290;</span>
<span style="color: #8b2252;">--numatune NUMATUNE &#20026;&#22495;&#36827;&#31243;&#35843;&#25972; NUMA &#31574;&#30053;&#12290;</span>
<span style="color: #8b2252;">--memtune MEMTUNE &#20026;&#22495;&#36827;&#31243;&#35843;&#25972;&#20869;&#31895;&#31574;&#30053;&#12290;</span>
<span style="color: #8b2252;">--blkiotune BLKIOTUNE&#20026;&#22495;&#36827;&#31243;&#35843;&#25972; blkio &#31574;&#30053;&#12290;</span>
<span style="color: #8b2252;">--memorybacking MEMORYBACKING &#20026;&#22495;&#36827;&#31243;&#35774;&#32622;&#20869;&#23384;&#21518;&#22791;&#31574;&#30053;&#12290;&#20363;&#22914;&#65306;</span>
<span style="color: #8b2252;">--memorybacking hugepages=on</span>
<span style="color: #8b2252;">--features FEATURES &#35774;&#32622;&#22495; &lt;features&gt; XML&#12290;</span>
<span style="color: #8b2252;">&#20363;&#22914;&#65306;</span>
<span style="color: #8b2252;">--features acpi=off</span>
<span style="color: #8b2252;">--features apic=on,eoi=on</span>

<span style="color: #8b2252;">--clock CLOCK &#35774;&#32622;&#22495; &lt;clock&gt; XML&#12290;&#20363;&#22914;&#65306;--clock</span>
<span style="color: #8b2252;">offset=localtime,rtc_tickpolicy=catchup</span>
<span style="color: #8b2252;">--pm PM &#37197;&#32622; VM &#30005;&#28304;&#31649;&#29702;&#21151;&#33021;</span>
<span style="color: #8b2252;">--events EVENTS &#37197;&#32622; VM &#29983;&#21629;&#21608;&#26399;&#31649;&#29702;&#31574;&#30053;</span>
<span style="color: #8b2252;">--resource RESOURCE &#37197;&#32622; VM &#36164;&#28304;&#20998;&#21306;&#65288;cgroups&#65289;</span>

<span style="color: #8b2252;">&#34394;&#25311;&#21270;&#24179;&#21488;&#36873;&#39033;:</span>
<span style="color: #8b2252;">-v, --hvm &#23458;&#25143;&#31471;&#24212;&#35813;&#26159;&#19968;&#20010;&#20840;&#34394;&#25311;&#23458;&#25143;&#31471;</span>
<span style="color: #8b2252;">-p, --paravirt &#36825;&#20010;&#23458;&#25143;&#31471;&#19968;&#20010;&#26159;&#19968;&#20010;&#21322;&#34394;&#25311;&#23458;&#25143;&#31471;</span>
<span style="color: #8b2252;">--container &#36825;&#21488;&#34394;&#25311;&#26426;&#38656;&#35201;&#19968;&#20010;&#23481;&#22120;&#23458;&#25143;&#31471;</span>
<span style="color: #8b2252;">--virt-type HV_TYPE &#35201;&#20351;&#29992;&#30340;&#31649;&#29702;&#31243;&#24207;&#21517;&#31216;(kvm&#12289;qemu&#12289;xen&#31561;&#31561;)</span>
<span style="color: #8b2252;">--arch ARCH &#27169;&#25311;&#30340; CPU &#26500;&#26550;</span>
<span style="color: #8b2252;">--machine MACHINE &#35201;&#27169;&#25311;&#30340;&#26426;&#22120;&#31867;&#22411;</span>

<span style="color: #8b2252;">&#20854;&#23427;&#36873;&#39033;:</span>
<span style="color: #8b2252;">--autostart &#24341;&#23548;&#20027;&#26426;&#26102;&#33258;&#21160;&#21551;&#21160;&#22495;&#12290;</span>
<span style="color: #8b2252;">--wait WAIT &#31561;&#24453;&#23433;&#35013;&#23436;&#25104;&#30340;&#20998;&#38047;&#25968;&#12290;</span>
<span style="color: #8b2252;">--noautoconsole &#19981;&#35201;&#33258;&#21160;&#23581;&#35797;&#36830;&#25509;&#21040;&#23458;&#25143;&#31471;&#25511;&#21046;&#21488;</span>
<span style="color: #8b2252;">--noreboot &#23436;&#25104;&#23433;&#35013;&#21518;&#19981;&#35201;&#24341;&#23548;&#34394;&#25311;&#26426;&#12290;</span>
<span style="color: #8b2252;">--print-xml [XMLONLY] &#36755;&#20986;&#25152;&#29983;&#25104;&#22495; XML&#65292;&#32780;&#19981;&#26159;&#21019;&#24314;&#34394;&#25311;&#26426;&#12290;</span>
<span style="color: #8b2252;">--dry-run &#23436;&#25104;&#23433;&#35013;&#27493;&#39588;&#65292;&#20294;&#19981;&#35201;&#21019;&#24314;&#35774;&#22791;&#25110;&#32773;&#23450;&#20041;&#34394;&#25311;&#26426;&#12290;</span>
<span style="color: #8b2252;">--check CHECK &#21551;&#29992;&#25110;&#31105;&#29992;&#39564;&#35777;&#26816;&#26597;&#12290;&#20363;&#22914;&#65306;</span>
<span style="color: #8b2252;">--check path_in_use=off</span>
<span style="color: #8b2252;">--check all=off</span>
<span style="color: #8b2252;">-q, --quiet &#31105;&#27490;&#26080;&#38169;&#35823;&#36755;&#20986;</span>
<span style="color: #8b2252;">-d, --debug &#36755;&#20837;&#25925;&#38556;&#25490;&#38500;&#20449;&#24687;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:631de974-8aae-4692-bb17-d2d8ae78f3d5" class="outline-4">
<h4 id="h:631de974-8aae-4692-bb17-d2d8ae78f3d5">virt-install 命令创建虚拟机</h4>
<div class="outline-text-4" id="text-h:631de974-8aae-4692-bb17-d2d8ae78f3d5">
</div>
<div id="outline-container-h:89318a0f-3f2f-4310-919a-c9467c2ee3ce" class="outline-5">
<h5 id="h:89318a0f-3f2f-4310-919a-c9467c2ee3ce">利用 qemu-img命令创建虚拟磁盘</h5>
<div class="outline-text-5" id="text-h:89318a0f-3f2f-4310-919a-c9467c2ee3ce">
<p>
<b>注意: qemu-img create一定要确认对应路径下没有此文件,如果存在将覆盖原文件</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#qemu-img create -f qcow2 /var/lib/libvirt/images/centos7.qcow2 20G
Formatting <span style="color: #8b2252;">'/var/lib/libvirt/images/centos7.qcow2'</span>, <span style="color: #a0522d;">fmt</span>=qcow2 <span style="color: #a0522d;">size</span>=21474836480
<span style="color: #a0522d;">cluster_size</span>=65536 <span style="color: #a0522d;">lazy_refcounts</span>=off <span style="color: #a0522d;">refcount_bits</span>=16

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35266;&#23519;&#25991;&#20214;&#34394;&#25311;&#30913;&#30424;&#22823;&#23567;, &#34394;&#20998;&#37197;&#31354;&#38388;</span>
[root@centos8 ~]#ll -h /var/lib/libvirt/images/centos7.qcow2
-rw-r--r-- 1 root root 193K Sep 13 21:25 /var/lib/libvirt/images/centos7.qcow2
</pre>
</div>
</div>
</div>
<div id="outline-container-h:51771da1-cd33-4adb-9cd3-f1f380f293eb" class="outline-5">
<h5 id="h:51771da1-cd33-4adb-9cd3-f1f380f293eb">利用 osinfo-query命令查看支持的OS版本</h5>
<div class="outline-text-5" id="text-h:51771da1-cd33-4adb-9cd3-f1f380f293eb">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25903;&#25345;&#30340;OS</span>
[root@centos8 ~]#osinfo-query os| grep centos
centos-stream8             | CentOS Stream 8                                                                     | 8 
        | http://centos.org/centos-stream/8         
centos5.0                     | CentOS 5.0                                                                                 | 5.0
        | http://centos.org/centos/5.0                     
centos5.1                     | CentOS 5.1                                                                                 | 5.1
        | http://centos.org/centos/5.1                     
centos5.10                     | CentOS 5.10                                                                             |
5.10         | http://centos.org/centos/5.10                 
centos5.11                     | CentOS 5.11                                                                             |
5.11         | http://centos.org/centos/5.11                 
centos5.2                     | CentOS 5.2                                                                                 | 5.2
        | http://centos.org/centos/5.2                     
centos5.3                     | CentOS 5.3                                                                                 | 5.3
        | http://centos.org/centos/5.3                     
centos5.4                     | CentOS 5.4                                                                                 | 5.4
        | http://centos.org/centos/5.4                     
centos5.5                     | CentOS 5.5                                                                                 | 5.5
        | http://centos.org/centos/5.5                     
centos5.6                     | CentOS 5.6                                                                                 | 5.6
        | http://centos.org/centos/5.6                     


centos5.7                     | CentOS 5.7                                                                                 | 5.7
        | http://centos.org/centos/5.7                     
centos5.8                     | CentOS 5.8                                                                                 | 5.8
        | http://centos.org/centos/5.8                     
centos5.9                     | CentOS 5.9                                                                                 | 5.9
        | http://centos.org/centos/5.9                     
centos6.0                     | CentOS 6.0                                                                                 | 6.0
        | http://centos.org/centos/6.0                     
centos6.1                     | CentOS 6.1                                                                                 | 6.1
        | http://centos.org/centos/6.1                     
centos6.10                     | CentOS 6.10                                                                             |
6.10         | http://centos.org/centos/6.10                 
centos6.2                     | CentOS 6.2                                                                                 | 6.2
        | http://centos.org/centos/6.2                     
centos6.3                     | CentOS 6.3                                                                                 | 6.3
        | http://centos.org/centos/6.3                     
centos6.4                     | CentOS 6.4                                                                                 | 6.4
        | http://centos.org/centos/6.4                     
centos6.5                     | CentOS 6.5                                                                                 | 6.5
        | http://centos.org/centos/6.5                     
centos6.6                     | CentOS 6.6                                                                                 | 6.6
        | http://centos.org/centos/6.6                     
centos6.7                     | CentOS 6.7                                                                                 | 6.7
        | http://centos.org/centos/6.7                     
centos6.8                     | CentOS 6.8                                                                                 | 6.8
        | http://centos.org/centos/6.8                     
centos6.9                     | CentOS 6.9                                                                                 | 6.9
        | http://centos.org/centos/6.9                     
centos7.0                     | CentOS 7                                                                                     | 7 
        | http://centos.org/centos/7.0                     
centos8                         | CentOS 8                                                                                     | 8 
        | http://centos.org/centos/8  
</pre>
</div>
</div>
</div>
<div id="outline-container-h:413905b1-475c-41be-bdd2-8981f529f8f3" class="outline-5">
<h5 id="h:413905b1-475c-41be-bdd2-8981f529f8f3">创建虚拟机光盘启动并手动安装</h5>
<div class="outline-text-5" id="text-h:413905b1-475c-41be-bdd2-8981f529f8f3">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#40664;&#35748;NAT&#27169;&#24335;&#30340;&#34394;&#25311;&#26426;,&#24182;&#19981;&#33258;&#21160;&#25171;&#24320;virt-viewer&#36830;&#25509;console,&#38656;&#35201;&#25163;&#21160;&#25171;&#24320;virt-manager &#36830;&#25509;,&#24182;&#25163;&#21160;&#23433;&#35013;&#31995;&#32479;</span>
[root@centos8 ~]#virt-install --virt-type kvm --name centos7 --ram 1024 --vcpus 2 --cdrom=/data/isos/CentOS-7-x86_64-Minimal-2003.iso <span style="color: #8b2252;">\</span>
--disk <span style="color: #a0522d;">path</span>=/var/lib/libvirt/images/centos7.qcow2 <span style="color: #8b2252;">\</span>
--network <span style="color: #a0522d;">network</span>=default <span style="color: #8b2252;">\</span>
--graphics vnc,<span style="color: #a0522d;">listen</span>=0.0.0.0 <span style="color: #8b2252;">\</span>
--noautoconsole --os-variant=centos7.0

Starting install...
Domain installation still<span style="color: #a020f0;"> in</span> progress. You can reconnect to
the console to complete the installation process

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25171;&#24320;virt-manager&#23433;&#35013;&#31995;&#32479;</span>
[root@centos8 ~]#export <span style="color: #a0522d;">DISPLAY</span>=10.0.0.1:0.0
[root@centos8 ~]#virt-manager

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#34394;&#25311;&#30828;&#30424;&#22823;&#23567;,&#27880;&#24847;&#21040;&#21482;&#35201;&#27491;&#22312;&#36816;&#34892;&#30340;&#34394;&#25311;&#23545;&#24212;&#30340;&#30828;&#30424;&#25991;&#20214;&#25152;&#26377;&#32773;&#21644;&#32452;&#20026;qemu,&#32780;&#34394;&#25311;&#26426;&#20851;&#26426;&#30340;&#20026;root</span>
[root@centos8 ~]#ll /var/lib/libvirt/images/ -h
total 22G
-rw-r--r-- 1 qemu qemu 1.6G Sep 13 22:05 centos7.qcow2
-rw------- 1 root root 21G Sep 13 22:05 centos8.qcow2
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#36807;&#31243;&#30053;</span>
</pre>
</div>


<figure id="orgb72dc4a">
<img src="images/image-20210223112325076.png" alt="image-20210223112325076.png">

</figure>
</div>
</div>
<div id="outline-container-h:bbb77910-196d-4544-b897-c2f2a39ea4d3" class="outline-5">
<h5 id="h:bbb77910-196d-4544-b897-c2f2a39ea4d3">创建虚拟机从光盘启动并利用kickstart自动安装系统</h5>
<div class="outline-text-5" id="text-h:bbb77910-196d-4544-b897-c2f2a39ea4d3">
</div>
<ul class="org-ul">
<li><a id="h:8bede760-27f9-4483-a547-6b4de123dd4a"></a>准备 yum 仓库 和 kickstart 环境<br>
<div class="outline-text-6" id="text-h:8bede760-27f9-4483-a547-6b4de123dd4a">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum -y install httpd
[root@centos8 ~]#systemctl enable --now httpd
[root@centos8 ~]#mkdir -pv /var/www/html/centos/{6,7,8}/os/x86_64/
[root@centos8 ~]#mount /dev/sr0 /var/www/html/centos/8/os/x86_64/
[root@centos8 ~]#mkdir /var/www/html/ks/
[root@centos8 ~]#cat /var/www/html/ks/centos8.cfg  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#24212;&#31572;&#25991;&#20214;</span>
ignoredisk --only-use=sda
zerombr
text
reboot
clearpart --all --initlabel
selinux --disabled
firewall --disabled
url --url=http://10.0.0.8/centos/8/os/x86_64/
keyboard --vckeymap=us --xlayouts=<span style="color: #8b2252;">'us'</span>
lang en_US.UTF-8
bootloader --append=<span style="color: #8b2252;">"net.ifnames=0"</span> --location=mbr --boot-drive=sda
network     --bootproto=dhcp --device=eth0 --ipv6=auto --activate
network     --hostname=centos8.me.org
rootpw --iscrypted $<span style="color: #a0522d;">6</span>$<span style="color: #a0522d;">j9YhzDUnQVnxaAk8</span>$<span style="color: #a0522d;">qv7rkMcPAEbV5yvwsP666DXWYadd3jYjkA9fpxAo9qYotjGGBUclCGoP1TRvgHBpqgc5n0RypMsPTQnVDcpO01</span>
firstboot --enable
skipx
services --disabled=<span style="color: #8b2252;">"chronyd"</span>
timezone Asia/Shanghai --isUtc --nontp
user --name=wang --password=6oUfb/02CWfLb5l8f$<span style="color: #a0522d;">sgEZeR7c7DpqfpmFDH6huSmDbW1XQNR4qKl2EPns</span>.gOXqlnAIgv9pTogtFVaDtEpMOC.SWXKYqxfVtd9MCwxb1 --iscrypted --gecos=<span style="color: #8b2252;">"wang"</span>


autopart --type=lvm
%packages
@^minimal-environment
kexec-tools
%end
%addon com_redhat_kdump --enable --reserve-mb=<span style="color: #8b2252;">'auto'</span>
%end
%anaconda
pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty
pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok
pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty
%end
%post
useradd tester
<span style="color: #483d8b;">echo</span> me | passwd --stdin tester &amp;&gt; /dev/null
%end
</pre>
</div>
</div>
</li>
<li><a id="h:bffa8b5d-f492-413e-89ba-e624cd2f2793"></a>创建虚拟机利用kickstart实现自动安装方法1<br>
<div class="outline-text-6" id="text-h:bffa8b5d-f492-413e-89ba-e624cd2f2793">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#34394;&#25311;&#26426;&#30913;&#30424;&#25991;&#20214;</span>
[root@centos8 ~]#qemu-img create -f qcow2 /var/lib/libvirt/images/centos8-vm2.qcow2 20G

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#34394;&#25311;&#26426;</span>
[root@centos8 ~]#virt-install --virt-type kvm --name centos8-vm2 --ram 2048 --vcpus 2 --cdrom=/data/isos/CentOS-8.2.2004-x86_64-minimal.iso     --disk <span style="color: #a0522d;">path</span>=/var/lib/libvirt/images/centos8-vm2.qcow2 --network <span style="color: #a0522d;">network</span>=default --graphics vnc,<span style="color: #a0522d;">listen</span>=0.0.0.0
</pre>
</div>

<p>
安装操作系统时，用tab键输入应答文件路径 <code>ks=http://10.0.0.8/ks/centos8.cfg</code>
</p>


<figure id="orga48369a">
<img src="images/image-20210223112353681.png" alt="image-20210223112353681.png">

</figure>


<figure id="orgd2133d3">
<img src="images/image-20210223112405944.png" alt="image-20210223112405944.png">

</figure>


<figure id="orgc6fc361">
<img src="images/image-20210223112417402.png" alt="image-20210223112417402.png">

</figure>
</div>
</li>
<li><a id="h:76ff0661-32f5-467e-a1a4-c55d5f764263"></a>创建虚拟机利用kickstart实现自动安装方法2<br>
<div class="outline-text-6" id="text-h:76ff0661-32f5-467e-a1a4-c55d5f764263">
<p>
利用virt-install的两项选项实现kickstart安装
</p>

<div class="org-src-container">
<pre class="src src-sh">virt-install
--location=/data/isos/CentOS-8.2.2004-x86_64-minimal.iso
--extra-args=<span style="color: #8b2252;">"ks=http://10.0.0.8/ks/centos8.cfg"</span>
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#qemu-img create -f qcow2 /var/lib/libvirt/images/centos8-vm3.qcow2 20G

[root@centos8 ~]#virt-install --virt-type kvm --name centos8-vm3 --ram 2048 --vcpus 2 <span style="color: #8b2252;">\</span>
                --disk <span style="color: #a0522d;">path</span>=/var/lib/libvirt/images/centos8-vm3.qcow2 <span style="color: #8b2252;">\</span>
                --network <span style="color: #a0522d;">network</span>=default --graphics vnc,<span style="color: #a0522d;">listen</span>=0.0.0.0 <span style="color: #8b2252;">\</span>
                --location=/data/isos/CentOS-8.2.2004-x86_64-minimal.iso --extra-args=<span style="color: #8b2252;">"ks=http://10.0.0.8/ks/centos8.cfg"</span>
</pre>
</div>


<figure id="org83c0291">
<img src="images/image-20210223112434344.png" alt="image-20210223112434344.png">

</figure>


<figure id="org1f66a2d">
<img src="images/image-20210223112446677.png" alt="image-20210223112446677.png">

</figure>


<figure id="org0fd9058">
<img src="images/image-20210223112455330.png" alt="image-20210223112455330.png">

</figure>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:289a7825-14eb-4277-b92d-1436b1ee9488" class="outline-5">
<h5 id="h:289a7825-14eb-4277-b92d-1436b1ee9488">验证宿主机进程</h5>
<div class="outline-text-5" id="text-h:289a7825-14eb-4277-b92d-1436b1ee9488">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#20010;&#36816;&#34892;&#30340;&#34394;&#25311;&#26426;&#23545;&#24212;&#19968;&#20010;qemu-kvm&#36827;&#31243;</span>
[root@centos8 ~]#ps aux|grep qemu-kvm
qemu                 6696     1.4     8.5 4021940 698296 ?         Sl     Sep21     0:45 /usr/libexec/qemu-kvm -name <span style="color: #a0522d;">guest</span>=centos8-2
qemu                 7591     5.2     7.3 4116424 600736 ?         Sl     00:21     0:26 /usr/libexec/qemu-kvm -name <span style="color: #a0522d;">guest</span>=centos8,

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36827;&#31243;&#26641;&#20851;&#31995;</span>
[root@centos8 ~]#pstree -p |grep kvm
                    |-qemu-kvm(6696)-+-{qemu-kvm}(6709)
                    |                             |-{qemu-kvm}(6717)
                    |                             |-{qemu-kvm}(6718)
                    |                             |-{qemu-kvm}(6719)
                    |                             |-{qemu-kvm}(6721)
                    |                                 <span style="color: #ff00ff;">`-{qemu-kvm}(6722)</span>
<span style="color: #ff00ff;">                    |-qemu-kvm(7591)-+-{qemu-kvm}(7605)</span>
<span style="color: #ff00ff;">                    |                             |-{qemu-kvm}(7611)</span>
<span style="color: #ff00ff;">                    |                             |-{qemu-kvm}(7612)</span>
<span style="color: #ff00ff;">                    |                             |-{qemu-kvm}(7613)</span>
<span style="color: #ff00ff;">                    |                             |-{qemu-kvm}(7615)</span>
<span style="color: #ff00ff;">                    |                                 `</span>-{qemu-kvm}(7616)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5bcfac68-b29b-4c16-8f30-4ef84f3b3cb5" class="outline-5">
<h5 id="h:5bcfac68-b29b-4c16-8f30-4ef84f3b3cb5">vnc 连接虚拟机</h5>
<div class="outline-text-5" id="text-h:5bcfac68-b29b-4c16-8f30-4ef84f3b3cb5">
<p>
虚拟机安装过程中,宿主机可以看到打开了5900端口,如果有多个虚拟机会打开5901,5902等端口
</p>

<p>
虚拟机安装完成后,虚拟机启动状态时,也会宿主机自动打开5900以上的端口
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ss -ntl
State                     Recv-Q                     Send-Q         Local Address:Port         Peer    Address:Port
LISTEN                     0                                 1                                 0.0.0.0:5900                 0.0.0.0:*
LISTEN                     0                                 1                                 0.0.0.0:5901                 0.0.0.0:*
LISTEN                     0                                 32                 192.168.122.1:53                     
</pre>
</div>

<p>
可以修改VNC端口的范围,默认5900-65535
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#grep remote_display_port /etc/libvirt/qemu.conf
<span style="color: #b22222;">#</span><span style="color: #b22222;">remote_display_port_min = 5900</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">remote_display_port_max = 65535</span>
</pre>
</div>


<figure id="org9791363">
<img src="images/image-20210223112536545.png" alt="image-20210223112536545.png">

</figure>


<figure id="org3edde53">
<img src="images/image-20210223112546575.png" alt="image-20210223112546575.png">

</figure>

<p>
<b>注意:</b>
</p>

<ul class="org-ul">
<li>同时只能有一个VNC客户端连接虚拟机</li>
<li>virt-viewer 连接虚拟机,会自动断开VNC客户端的连接</li>
</ul>

<p>
否则会下面提示错误
</p>


<figure id="orga7afa5b">
<img src="images/image-20210223112559201.png" alt="image-20210223112559201.png">

</figure>
</div>
</div>
</div>
</div>
<div id="outline-container-h:095e8ce7-d3d3-4514-8c3f-c71b15bf804e" class="outline-3">
<h3 id="h:095e8ce7-d3d3-4514-8c3f-c71b15bf804e">基于现有虚拟机磁盘为模版创建新的虚拟机</h3>
<div class="outline-text-3" id="text-h:095e8ce7-d3d3-4514-8c3f-c71b15bf804e">
</div>
<div id="outline-container-h:240126ea-a307-4103-89a4-302a02fb4511" class="outline-4">
<h4 id="h:240126ea-a307-4103-89a4-302a02fb4511">利用virt-manager实现</h4>
<div class="outline-text-4" id="text-h:240126ea-a307-4103-89a4-302a02fb4511">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110;&#24050;&#32463;&#23433;&#35013;&#22909;&#34394;&#25311;&#26426;&#30913;&#30424;&#25991;&#20214;,&#21019;&#24314;&#26032;&#30340;&#30913;&#30424;&#25991;&#20214;</span>
[root@centos8 ~]#cp -a /var/lib/libvirt/images/centos7.qcow2  /var/lib/libvirt/images/centos7-2.qcow2
</pre>
</div>

<p>
使用virt-manager创建虚拟机，导入现有的磁盘文件启动
</p>


<figure id="orgf5c00c9">
<img src="images/image-20210223112612325.png" alt="image-20210223112612325.png">

</figure>


<figure id="org6f9cd36">
<img src="images/image-20210223112625783.png" alt="image-20210223112625783.png">

</figure>

<p>
可以看到 <code>/etc/libvirt/qemu</code> 目录下多了一个虚拟机配置 文件
</p>
</div>
</div>
<div id="outline-container-h:110ddafd-6afe-482a-b402-e0c11488000f" class="outline-4">
<h4 id="h:110ddafd-6afe-482a-b402-e0c11488000f">利用virt-install实现</h4>
<div class="outline-text-4" id="text-h:110ddafd-6afe-482a-b402-e0c11488000f">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 images]#pwd
/var/lib/libvirt/images
[root@centos8 images]#cp centos8.qcow2 centos8-2.qcow2

[root@centos8 images]#virt-install --virt-type kvm --name centos8-2 --ram 2048 --vcpus 2 --disk <span style="color: #a0522d;">bus</span>=virtio,<span style="color: #a0522d;">path</span>=/var/lib/libvirt/images/centos8-2.qcow2 --network --network <span style="color: #a0522d;">network</span>=default,<span style="color: #a0522d;">model</span>=virtio --graphics vnc,<span style="color: #a0522d;">listen</span>=0.0.0.0 --noautoconsole --autostart --boot hd

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36816;&#34892;&#24037;&#20855;,&#21487;&#20197;&#30475;&#21040;&#19979;&#38754;&#20986;&#29616;&#26032;&#30340;&#34394;&#25311;&#26426;</span>
[root@centos8 images]#virt-manager
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:662ebb1c-c864-45cc-9c05-80f5a79e6493" class="outline-2">
<h2 id="h:662ebb1c-c864-45cc-9c05-80f5a79e6493">管理虚拟机</h2>
<div class="outline-text-2" id="text-h:662ebb1c-c864-45cc-9c05-80f5a79e6493">
</div>
<div id="outline-container-h:95e75989-1d52-4e97-9b95-c222a3989af5" class="outline-3">
<h3 id="h:95e75989-1d52-4e97-9b95-c222a3989af5">使用半虚拟化驱动 virtio</h3>
<div class="outline-text-3" id="text-h:95e75989-1d52-4e97-9b95-c222a3989af5">
</div>
<div id="outline-container-h:a6a84222-7e29-498b-acc3-8b907da6a0cf" class="outline-4">
<h4 id="h:a6a84222-7e29-498b-acc3-8b907da6a0cf">半虚拟化驱动virtio的工作原理</h4>
<div class="outline-text-4" id="text-h:a6a84222-7e29-498b-acc3-8b907da6a0cf">
<p>
为了提高内存、硬盘、网络的性能，需要支持半虚拟化
</p>


<figure id="orgb488167">
<img src="images/image-20210223112649663.png" alt="image-20210223112649663.png">

</figure>

<p>
virtio 是一种 I/O 半虚拟化解决方案，是一套通用 I/O设备虚拟化的程序，是
对半虚拟化 Hypervisor中的一组通用 I/O设备的抽象，提供了一套上层应用与
各 Hypervisor虚拟化设备（KVM，Xen，VMware等）之间的通信框架和编程接口，
减少跨平台所带来的兼容性问题，大大提高驱动程序开发效率，windows 系统需
要单独安装virtio驱 动，linux系统自带virtio驱动。
</p>


<figure id="org8532851">
<img src="images/image-20210223140052798.png" alt="image-20210223140052798.png">

</figure>

<pre class="example" id="org0f6404b">
Virtio 使用 virtqueue 来实现 I/O 机制，每个 virtqueue 就是一个承载大量数据的队列，具体使用多少个队列取决于需求，例如，virtio网络驱动程序（virtio-net）使用两个队列（一个用于接受，另一个用于发送），而virtio块驱动程序（virtio-blk）仅使用一个队列
</pre>


<figure id="org7c22975">
<img src="images/image-20210223140108733.png" alt="image-20210223140108733.png">

</figure>

<p>
实现IO虚拟化主要有三种方式：全虚拟化、半虚拟化和透传，全虚拟化Guest OS
不会感知到自己是虚拟机，也无需修改Guest OS，但是它的效率比较低，半虚拟
化Guest OS知道自己是虚拟机，通过Frontend/Backend驱动模拟实现IO虚拟化，
透传就是直接分配物理设备给VM用，但是需要解决单个硬件在多个虚拟机共享使
用的问题。
</p>

<p>
<b>性能比较</b>
</p>

<p>
<a href="http://www.ilsistemista.net/index.php/virtualization/42-kvm-virtio-paravirtualized-drivers-why-they-matter.html">http://www.ilsistemista.net/index.php/virtualization/42-kvm-virtio-paravirtualized-drivers-why-they-matter.html</a>
</p>


<figure id="orge1bf31b">
<img src="images/image-20210223140138682.png" alt="image-20210223140138682.png">

</figure>
</div>
</div>
<div id="outline-container-h:f12d5d85-ce39-4ba1-a889-b47534daab63" class="outline-4">
<h4 id="h:f12d5d85-ce39-4ba1-a889-b47534daab63">半虚拟化设备统一接口virtio</h4>
<div class="outline-text-4" id="text-h:f12d5d85-ce39-4ba1-a889-b47534daab63">

<figure id="org7d96fa7">
<img src="images/image-20210223140150030.png" alt="image-20210223140150030.png">

</figure>

<p>
通过统一的接口virtio以支持的多种硬件设备
</p>

<ul class="org-ul">
<li>不同的虚拟设备和不同的虚拟机可以有不同的前端驱动</li>
<li>不同的硬件设备可以有不同的后端驱动</li>
<li>两者之间的交互遵循virtio的标准</li>
</ul>
</div>
</div>
<div id="outline-container-h:a0c91521-a9ab-46cb-ab4b-eefd0dc5eb1a" class="outline-4">
<h4 id="h:a0c91521-a9ab-46cb-ab4b-eefd0dc5eb1a">驱动获取</h4>
<div class="outline-text-4" id="text-h:a0c91521-a9ab-46cb-ab4b-eefd0dc5eb1a">
</div>
<div id="outline-container-h:d1a63b54-9563-4399-8ca7-08e3cd9dac89" class="outline-5">
<h5 id="h:d1a63b54-9563-4399-8ca7-08e3cd9dac89">Linux 的 VirtIO 驱动</h5>
<div class="outline-text-5" id="text-h:d1a63b54-9563-4399-8ca7-08e3cd9dac89">
<p>
红帽RHEL 4.8之后自动加载和安装virtio驱动
</p>

<div class="org-src-container">
<pre class="src src-sh">lsmod |grep virtio
</pre>
</div>


<figure id="orge53bb8a">
<img src="images/image-20210223140204654.png" alt="image-20210223140204654.png">

</figure>
</div>
</div>
<div id="outline-container-h:d763c6a7-c4f3-45bc-a285-5aadfa4ee4c0" class="outline-5">
<h5 id="h:d763c6a7-c4f3-45bc-a285-5aadfa4ee4c0">Windows 操作系统需要额外安装 virtio 的驱动</h5>
<div class="outline-text-5" id="text-h:d763c6a7-c4f3-45bc-a285-5aadfa4ee4c0">
<p>
方法1∶如果有红帽的RHN订阅，可以从以下位置下载virtio-win包:
</p>

<p>
<a href="https://rhn.redhat.com/rhn/software/packages/details/Overview.do?pid=868414">https://rhn.redhat.com/rhn/software/packages/details/Overview.do?pid=868414</a>
</p>

<p>
方法2∶从社区获得 <a href="http://www.linux-kvm.org/page/Downloads">http://www.linux-kvm.org/page/Downloads</a>
</p>

<p>
<a href="https://docs.fedoraproject.org/en-US/quick-docs/creating-windows-virtual-machines-using-virtio-drivers/index.html">https://docs.fedoraproject.org/en-US/quick-docs/creating-windows-virtual-machines-using-virtio-drivers/index.html</a>
</p>


<figure id="org3ac1006">
<img src="images/image-20210223140222315.png" alt="image-20210223140222315.png">

</figure>


<figure id="org225f025">
<img src="images/image-20210223140229915.png" alt="image-20210223140229915.png">

</figure>


<figure id="org816dc14">
<img src="images/image-20210223140242658.png" alt="image-20210223140242658.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:2fd0011b-0668-4a2f-b637-79167e4d49f3" class="outline-4">
<h4 id="h:2fd0011b-0668-4a2f-b637-79167e4d49f3">Linux 测试安装virtio驱动前后的虚拟机性能变化</h4>
<div class="outline-text-4" id="text-h:2fd0011b-0668-4a2f-b637-79167e4d49f3">
<p>
默认虚拟机使用的是全虚拟化IDE磁盘,以下测试性能
</p>

<div class="org-src-container">
<pre class="src src-sh">dd <span style="color: #a0522d;">if</span>=/dev/zero of =/f1.img <span style="color: #a0522d;">bs</span>=1M <span style="color: #a0522d;">count</span>=1024
</pre>
</div>


<figure id="orgcbf6f4a">
<img src="images/image-20210223140257434.png" alt="image-20210223140257434.png">

</figure>

<p>
将硬盘默认的总线IDE修改为VirtIO
</p>


<figure id="org854988c">
<img src="images/image-20210223140308139.png" alt="image-20210223140308139.png">

</figure>

<p>
<b>重新启动后,执行相同的操作,比较性能</b>
</p>


<figure id="org7b951e8">
<img src="images/image-20210223140318325.png" alt="image-20210223140318325.png">

</figure>

<p>
默认网卡为e1000,将之修改网卡驱动为virtIO
</p>


<figure id="org80e6df6">
<img src="images/image-20210223140339874.png" alt="image-20210223140339874.png">

</figure>
</div>
</div>
<div id="outline-container-h:7a051568-943d-44b9-8383-99109a99fed4" class="outline-4">
<h4 id="h:7a051568-943d-44b9-8383-99109a99fed4">安装 Windows Server 虚拟机</h4>
<div class="outline-text-4" id="text-h:7a051568-943d-44b9-8383-99109a99fed4">
</div>
<div id="outline-container-h:fcb847ab-c36f-44df-91cd-2db18521b4a0" class="outline-5">
<h5 id="h:fcb847ab-c36f-44df-91cd-2db18521b4a0">下载并准备相关文件</h5>
<div class="outline-text-5" id="text-h:fcb847ab-c36f-44df-91cd-2db18521b4a0">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">virtio&#19979;&#36733;&#22320;&#22336;&#65306;</span>
https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/

<span style="color: #b22222;"># </span><span style="color: #b22222;">virtio &#21382;&#21490;&#29256;&#26412;&#19979;&#36733;&#22320;&#22336;&#65306;</span>
https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#37324;&#19979;&#36733;&#20860;&#23481;&#27604;&#36739;&#22810;&#30340;&#36719;&#30424;&#25991;&#20214;  virtio-win-0.1.141_amd64.vfd</span>
</pre>
</div>


<figure id="org0618231">
<img src="images/image-20210223140414830.png" alt="image-20210223140414830.png">

<figcaption><span class="figure-number">Figure 1: </span>image-20210223140414830</figcaption>
</figure>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ll /data/isos/
- CentOS-7-x86_64-Minimal-2003.iso
- CentOS-8.2.2004-x86_64-minimal.iso
- cn_windows_server_2008_r2_standard_enterprise_datacenter_and_web_with_sp1_vl_build_x64_dvd_617396.iso
- virtio-win-0.1.141_amd64.vfd
</pre>
</div>
</div>
</div>
<div id="outline-container-h:71674e6f-a83b-4c2e-8d20-05839b739f4e" class="outline-5">
<h5 id="h:71674e6f-a83b-4c2e-8d20-05839b739f4e">创建 Windows Server 2008 虚拟机</h5>
<div class="outline-text-5" id="text-h:71674e6f-a83b-4c2e-8d20-05839b739f4e">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#30913;&#30424;&#25991;&#20214;</span>
[root@centos8 ~]#qemu-img create -f qcow2 /var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2 200G

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25903;&#25345;&#30340;windows&#29256;&#26412;</span>
[root@centos8 ~]#osinfo-query os| grep win
win1.0                             | Microsoft Windows 1.0                                                         | 1.0      | http://microsoft.com/win/1.0                     
win10                             | Microsoft Windows 10                                                             |10.0         | http://microsoft.com/win/10                     
win2.0                             | Microsoft Windows 2.0                                                         | 2.0        | http://microsoft.com/win/2.0                     
win2.1                             | Microsoft Windows 2.1                                                         | 2.1        | http://microsoft.com/win/2.1                     
win2k                             | Microsoft Windows 2000                                                         | 5.0        | http://microsoft.com/win/2k                     
win2k12                         | Microsoft Windows Server 2012                                         | 6.3        | http://microsoft.com/win/2k12                 
win2k12r2                     | Microsoft Windows Server 2012 R2                                     | 6.3        | http://microsoft.com/win/2k12r2             
win2k16                         | Microsoft Windows Server 2016                                         |10.0         | http://microsoft.com/win/2k16                 
win2k19                         | Microsoft Windows Server 2019                                         |10.0         | http://microsoft.com/win/2k19                 
win2k3                             | Microsoft Windows Server 2003                                         | 5.2        | http://microsoft.com/win/2k3                     
win2k3r2                         | Microsoft Windows Server 2003 R2                                     | 5.2        | http://microsoft.com/win/2k3r2                 
win2k8                             | Microsoft Windows Server 2008                                         | 6.0        | http://microsoft.com/win/2k8                     
win2k8r2                         | Microsoft Windows Server 2008 R2                                     | 6.1        | http://microsoft.com/win/2k8r2                 
win3.1                             | Microsoft Windows 3.1                                                         | 3.1        | http://microsoft.com/win/3.1                     
win7                                 | Microsoft Windows 7                                                             | 6.1        | http://microsoft.com/win/7                         
win8                                 | Microsoft Windows 8                                                             | 6.2        | http://microsoft.com/win/8                         
win8.1                             | Microsoft Windows 8.1                                                         | 6.3        | http://microsoft.com/win/8.1                     
win95                             | Microsoft Windows 95                                                             | 4.0        | http://microsoft.com/win/95                     

win98                             | Microsoft Windows 98                                                             | 4.1        | http://microsoft.com/win/98                     
winme                             | Microsoft Windows Millennium Edition                             | 4.9        | http://microsoft.com/win/me                     
winnt3.1                         | Microsoft Windows NT Server 3.1                                     | 3.1        | http://microsoft.com/winnt/3.1                 
winnt3.5                         | Microsoft Windows NT Server 3.5                                     | 3.5        | http://microsoft.com/winnt/3.5                 
winnt3.51                     | Microsoft Windows NT Server 3.51                                     |3.51         | http://microsoft.com/winnt/3.51             
winnt4.0                         | Microsoft Windows NT Server 4.0                                     | 4.0        | http://microsoft.com/winnt/4.0                 
winvista                         | Microsoft Windows Vista                                                     | 6.0        | http://microsoft.com/win/vista                 
winxp                             | Microsoft Windows XP                                                             | 5.1        | http://microsoft.com/win/xp

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314; Windows &#34394;&#25311;&#26426;</span>
[root@centos8 ~]#virt-install --virt-type kvm --name Win_2008_r2-x86_64 --memory 3072 --vcpus=2 --os-variant=win2k8r2 --cdrom=/data/isos/cn_windows_server_2008_r2_standard_enterprise_datacenter_and_web_with_sp1_vl_build_x64_dvd_617396.iso --diskpath=/var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2,<span style="color: #a0522d;">format</span>=qcow2,<span style="color: #a0522d;">bus</span>=virtio --disk <span style="color: #a0522d;">path</span>=/data/isos/virtio-win-0.1.141_amd64.vfd,<span style="color: #a0522d;">device</span>=floppy --network <span style="color: #a0522d;">bridge</span>=virbr0,<span style="color: #a0522d;">model</span>=virtio --graphics vnc,<span style="color: #a0522d;">listen</span>=0.0.0.0 --noautoconsole --autostart

Starting install...
Domain installation still<span style="color: #a020f0;"> in</span> progress. You can reconnect to
the console to complete the installation process.

[root@centos8 ~]#virt-manager
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e0e6b349-fd5a-4131-a2b4-ca9fe3ff2cec" class="outline-5">
<h5 id="h:e0e6b349-fd5a-4131-a2b4-ca9fe3ff2cec">安装 Windows Server 2008</h5>
<div class="outline-text-5" id="text-h:e0e6b349-fd5a-4131-a2b4-ca9fe3ff2cec">

<figure id="org6f48c04">
<img src="images/image-20210223140439028.png" alt="image-20210223140439028.png">

</figure>


<figure id="org783c174">
<img src="images/image-20210223140447476.png" alt="image-20210223140447476.png">

</figure>


<figure id="orga79efae">
<img src="images/image-20210223140457936.png" alt="image-20210223140457936.png">

</figure>


<figure id="orgd1d1f5d">
<img src="images/image-20210223140505603.png" alt="image-20210223140505603.png">

</figure>


<figure id="orga169f0e">
<img src="images/image-20210223140514809.png" alt="image-20210223140514809.png">

</figure>


<figure id="orgf38309a">
<img src="images/image-20210223140522169.png" alt="image-20210223140522169.png">

</figure>

<p>
选择加载驱动，点浏览从软盘中加载
</p>


<figure id="org24f2002">
<img src="images/image-20210223140530586.png" alt="image-20210223140530586.png">

</figure>


<figure id="org25efc4c">
<img src="images/image-20210223140539002.png" alt="image-20210223140539002.png">

</figure>


<figure id="orgb3a9d7d">
<img src="images/image-20210223140547641.png" alt="image-20210223140547641.png">

</figure>

<p>
注意: 不要选中 GPU, 按住Ctrl键多选，选择其他2个
</p>


<figure id="org3517704">
<img src="images/image-20210223140554717.png" alt="image-20210223140554717.png">

</figure>


<figure id="org0ce7079">
<img src="images/image-20210223140602146.png" alt="image-20210223140602146.png">

</figure>


<figure id="org04d2ec4">
<img src="images/image-20210223140609563.png" alt="image-20210223140609563.png">

</figure>


<figure id="org9e37c9d">
<img src="images/image-20210223140617053.png" alt="image-20210223140617053.png">

</figure>


<figure id="org62c763c">
<img src="images/image-20210223140624433.png" alt="image-20210223140624433.png">

</figure>


<figure id="org41349a2">
<img src="images/image-20210223140632338.png" alt="image-20210223140632338.png">

</figure>


<figure id="orge5d5e2a">
<img src="images/image-20210223140640552.png" alt="image-20210223140640552.png">

</figure>
</div>
</div>
<div id="outline-container-h:7b0ecf9a-229c-492b-9dd2-da104360a099" class="outline-5">
<h5 id="h:7b0ecf9a-229c-492b-9dd2-da104360a099">验证 Windows virtio 驱动</h5>
<div class="outline-text-5" id="text-h:7b0ecf9a-229c-492b-9dd2-da104360a099">
<p>
我的电脑右键属性&#x2013;管理&#x2013;诊断&#x2013;打开设备管理器
</p>


<figure id="orgcc7f120">
<img src="images/image-20210223140651615.png" alt="image-20210223140651615.png">

</figure>

<p>
其中有个叹号的PCI设备，不被识别。需要安装pci驱动。
</p>
</div>
</div>
<div id="outline-container-h:54393c48-720a-4be6-8efe-94d2f9d4572b" class="outline-5">
<h5 id="h:54393c48-720a-4be6-8efe-94d2f9d4572b">安装PCI 内存管理驱动</h5>
<div class="outline-text-5" id="text-h:54393c48-720a-4be6-8efe-94d2f9d4572b">
<p>
挂载virtio-win的光盘,进行安装驱动
</p>

<p>
这里下载virtio-win-0.1.185.iso驱动，并挂载到win2008的d盘
</p>

<p>
<a href="https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.185-1/">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.185-1/</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ll /data/isos/
... ...
virtio-win-0.1.185.iso

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25171;&#24320;virt-manager&#30913;&#30424;&#25346;&#36733;&#20013;&#36873;&#25321;&#25346;&#36733;&#36825;&#20010;&#39537;&#21160;&#25991;&#20214;</span>
</pre>
</div>


<figure id="org4997c5d">
<img src="images/image-20210223140711325.png" alt="image-20210223140711325.png">

</figure>


<figure id="org910feac">
<img src="images/image-20210223140720466.png" alt="image-20210223140720466.png">

</figure>


<figure id="orgb15e838">
<img src="images/image-20210223140736027.png" alt="image-20210223140736027.png">

</figure>


<figure id="orgbc13ad0">
<img src="images/image-20210223140743343.png" alt="image-20210223140743343.png">

</figure>


<figure id="orgf2436a1">
<img src="images/image-20210223140751722.png" alt="image-20210223140751722.png">

</figure>


<figure id="orgc9708cc">
<img src="images/image-20210223140830556.png" alt="image-20210223140830556.png">

</figure>
</div>
</div>
<div id="outline-container-h:aadfd777-d051-451c-aa28-66090a5fddf3" class="outline-5">
<h5 id="h:aadfd777-d051-451c-aa28-66090a5fddf3">生成Windows Server 2008 镜像模版</h5>
<div class="outline-text-5" id="text-h:aadfd777-d051-451c-aa28-66090a5fddf3">
<p>
利用sysprep工具,清除个性信息,下次Windows开机时, 会自动生成初始化个性信息
</p>

<p>
<code>C:\Windows\System32\Sysprep\sysprep.exe</code> 文件，双击可消除个性信息。
</p>


<figure id="org45994fc">
<img src="images/image-20210223140906146.png" alt="image-20210223140906146.png">

</figure>

<p>
<b>下次开机需要重新初始化</b>
</p>


<figure id="orgd22a423">
<img src="images/image-20210223140916015.png" alt="image-20210223140916015.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:fca7b042-d3ff-4c85-9eda-9181a5ad8e6b" class="outline-4">
<h4 id="h:fca7b042-d3ff-4c85-9eda-9181a5ad8e6b">安装 Windows 10 虚拟机</h4>
<div class="outline-text-4" id="text-h:fca7b042-d3ff-4c85-9eda-9181a5ad8e6b">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ll /data/isos/
total 11221160
-rw-r--r-- 1 qemu qemu 1085276160 Aug     9 16:38 CentOS-7-x86_64-Minimal-2003.iso
-rw-r--r-- 1 qemu qemu 1718616064 Aug     9 16:31 CentOS-8.2.2004-x86_64-minimal.iso
-rw-r--r-- 1 root root 5311711232 Aug 11 12:40 cn_windows_10_business_editions_version_1909_updated_jan_2020_x64_dvd_b3e1f3a6.iso
-rw-r--r-- 1 qemu qemu 3368962048 Aug 11 12:00  cn_windows_server_2008_r2_standard_enterprise_datacenter_and_web_with_sp1_vl_build_x64_dvd_617396.iso
-rw-r--r-- 1 qemu qemu         2949120 Aug 11 12:21 virtio-win-0.1.141_amd64.vfd
-rw-r--r-- 1 root root         2949120 Aug 11 12:34 virtio-win-0.1.185_amd64.vfd

[root@centos8 ~]#qemu-img create -f qcow2 /var/lib/libvirt/images/Windows10.qcow2 200G

[root@centos8 ~]#virt-install --virt-type kvm --name Windows10 --ram 3072 --vcpus=2 --os-variant=win10 --cdrom=/data/isos/cn_windows_10_business_editions_version_1909_updated_jan_2020_x64_dvd_b3e1f3a6.iso --diskpath=/var/lib/libvirt/images/Windows10.qcow2,<span style="color: #a0522d;">format</span>=qcow2,<span style="color: #a0522d;">bus</span>=virtio --diskpath=/data/isos/virtio-win-0.1.185_amd64.vfd,<span style="color: #a0522d;">device</span>=floppy --network <span style="color: #a0522d;">bridge</span>=virbr0,<span style="color: #a0522d;">model</span>=virtio --graphics vnc,<span style="color: #a0522d;">listen</span>=0.0.0.0 --noautoconsole --autostart

Starting install...
Domain installation still<span style="color: #a020f0;"> in</span> progress. You can reconnect to
the console to complete the installation process.
</pre>
</div>


<figure id="org0fed209">
<img src="images/image-20210223140928554.png" alt="image-20210223140928554.png">

</figure>


<figure id="org8612096">
<img src="images/image-20210223140938853.png" alt="image-20210223140938853.png">

</figure>


<figure id="org6b1e0fe">
<img src="images/image-20210223140947277.png" alt="image-20210223140947277.png">

</figure>


<figure id="org942e6a0">
<img src="images/image-20210223140955187.png" alt="image-20210223140955187.png">

</figure>


<figure id="orgedf8f37">
<img src="images/image-20210223141001931.png" alt="image-20210223141001931.png">

</figure>


<figure id="org4071ae6">
<img src="images/image-20210223141009506.png" alt="image-20210223141009506.png">

</figure>

<p>
选择加载驱动来识别磁盘
</p>


<figure id="orge048076">
<img src="images/image-20210223141019771.png" alt="image-20210223141019771.png">

</figure>


<figure id="org6055129">
<img src="images/image-20210223141142884.png" alt="image-20210223141142884.png">

</figure>


<figure id="org2ae2fb8">
<img src="images/image-20210223141150018.png" alt="image-20210223141150018.png">

</figure>


<figure id="org0d8cbb7">
<img src="images/image-20210223141202274.png" alt="image-20210223141202274.png">

</figure>


<figure id="org4625bbb">
<img src="images/image-20210223141209489.png" alt="image-20210223141209489.png">

</figure>


<figure id="org410de0d">
<img src="images/image-20210223141217593.png" alt="image-20210223141217593.png">

</figure>

<p>
第一次启动,初始化会比较长时间
</p>


<figure id="orgdc7f50b">
<img src="images/image-20210223141230476.png" alt="image-20210223141230476.png">

</figure>


<figure id="org2f7b2d3">
<img src="images/image-20210223141237722.png" alt="image-20210223141237722.png">

</figure>


<figure id="org35992f4">
<img src="images/image-20210223141251243.png" alt="image-20210223141251243.png">

</figure>

<p>
<b>选择”改为域加入”</b>
</p>


<figure id="org3b23c15">
<img src="images/image-20210223141305662.png" alt="image-20210223141305662.png">

</figure>


<figure id="org454604f">
<img src="images/image-20210223141312010.png" alt="image-20210223141312010.png">

</figure>


<figure id="org1189b71">
<img src="images/image-20210223141323161.png" alt="image-20210223141323161.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:52988609-dd56-40bd-99b3-cd946de4659b" class="outline-3">
<h3 id="h:52988609-dd56-40bd-99b3-cd946de4659b">安装与配置 QEMU guest agent</h3>
<div class="outline-text-3" id="text-h:52988609-dd56-40bd-99b3-cd946de4659b">
</div>
<div id="outline-container-h:35839c50-395b-4e69-8fe9-6ea98d9cdb2b" class="outline-5">
<h5 id="h:35839c50-395b-4e69-8fe9-6ea98d9cdb2b">QEMU guest agent 功能</h5>
<div class="outline-text-5" id="text-h:35839c50-395b-4e69-8fe9-6ea98d9cdb2b">
<p>
如果VM中安装QEMU guest agent，Host就可以使用libivrt向VM发送命令，例如”冻结”、"释放"文件系统，虚拟CPU的热添加及移除等。
</p>

<p>
在安装QEMU guest agent后，通过libvirt来使用QEMU guest agent,可以对libvirt命令有如下的增强
</p>

<div class="org-src-container">
<pre class="src src-sh">virsh shutdown --mode=agent     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27604;--mode=acpi&#26356;&#21152;&#23433;&#20840;&#22320;&#20851;&#38381;&#25805;&#20316;&#31995;&#32479;</span>
virsh snapshot-create -quiesce     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#21019;&#24314;&#24555;&#29031;&#20043;&#21069;&#38754;&#65292;&#23558;&#32531;&#23384;&#30340;&#20869;&#23481;&#21047;&#20837;&#21040;&#30913;&#30424;</span>
virsh domfsfreeze     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38745;&#40664;&#25991;&#20214;&#31995;&#32479;</span>
virsh domfsthaw     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24674;&#22797;&#38745;&#40664;&#30340;&#25991;&#20214;&#31995;&#32479;</span>
virsh domfstrim         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35753;&#34394;&#25311;&#26426;trim&#25991;&#20214;&#31995;&#32479;</span>
virsh domtime             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#24471;&#34394;&#25311;&#26426;&#30340;&#26102;&#38388;</span>
virsh setvcpus             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37197;&#32622;&#34394;&#25311;&#26426;&#30340;vCPU</span>
virsh domifaddr --source agent     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#34394;&#25311;&#26426;&#30340;IP&#22320;&#22336;</span>
virsh domfsinfo         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#34394;&#25311;&#26426;&#30340;&#25991;&#20214;&#31995;&#32479;&#21015;&#34920;</span>
virsh set-user-password <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#34394;&#25311;&#26426;&#29992;&#25143;&#30340;&#23494;&#30721;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4a942fdc-fd05-4c21-8ae4-b52377ecb3d3" class="outline-4">
<h4 id="h:4a942fdc-fd05-4c21-8ae4-b52377ecb3d3">安装 QEMU guest agent 安装方法</h4>
<div class="outline-text-4" id="text-h:4a942fdc-fd05-4c21-8ae4-b52377ecb3d3">
<ul class="org-ul">
<li>RHEL/CentOS 中有相应的安装包。qemu-guest-agent-xxx.rpm</li>
<li>Windows 需要手工安装</li>
</ul>
</div>
<div id="outline-container-h:730ba572-1985-463b-9d83-48f8b51e2fe8" class="outline-5">
<h5 id="h:730ba572-1985-463b-9d83-48f8b51e2fe8">在 Linux 安装</h5>
<div class="outline-text-5" id="text-h:730ba572-1985-463b-9d83-48f8b51e2fe8">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum info qemu-guest-agent
Last metadata expiration check: 2:46:09 ago on Thu 17 Sep 2020 09:08:54 AM CST.
Available Packages
Name                 : qemu-guest-agent
Epoch             : 15
Version         : 2.12.0
Release         : 99.module_el8.2.0+320+13f867d7
Architecture : x86_64
Size                 : 216 k
Source             : qemu-kvm-2.12.0-99.module_el8.2.0+320+13f867d7.src.rpm
Repository     : AppStream
Summary         : QEMU guest agent
URL                 : http://www.qemu.org/
License         : GPLv2 and GPLv2+ and CC-BY
Description : qemu-kvm is an open source virtualizer that provides hardware
emulation for
                        : the KVM hypervisor.
                        :
                        : This package provides an agent to run inside guests, which
communicates
                        : with the host over a virtio-serial channel named
<span style="color: #8b2252;">"org.qemu.guest_agent.0"</span>
                        :
                        : This package does not need to be installed on the host OS.

[root@centos8 ~]#yum -y install qemu-guest-agent
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1c786e50-5a5a-4bd6-8f20-d88388c14a0e" class="outline-5">
<h5 id="h:1c786e50-5a5a-4bd6-8f20-d88388c14a0e">在 Windows 安装 QEMU guest agent</h5>
<div class="outline-text-5" id="text-h:1c786e50-5a5a-4bd6-8f20-d88388c14a0e">
<p>
这里下载virtio-win-0.1.185.iso驱动
</p>

<p>
<a href="https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.185-1/">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.185-1/</a>
</p>


<figure id="org31d22f4">
<img src="images/image-20210223141348892.png" alt="image-20210223141348892.png">

</figure>


<figure id="orga921ba9">
<img src="images/image-20210223141406202.png" alt="image-20210223141406202.png">

</figure>

<p>
安装完毕后,可以服务管理中看到两个相关的服务
</p>

<div class="org-src-container">
<pre class="src src-sh">QEMU Guest Agent
QEMU Guest Agent VSS provider <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23454;&#29616;&#21367;&#24433;&#21103;&#26412;</span>
</pre>
</div>


<figure id="org249588f">
<img src="images/image-20210223141516310.png" alt="image-20210223141516310.png">

</figure>
</div>
</div>
</div>
</div>
<div id="outline-container-h:7983997d-f6a3-4dac-af8f-2d274bf1a60b" class="outline-3">
<h3 id="h:7983997d-f6a3-4dac-af8f-2d274bf1a60b">安装和配置 SPICE agent</h3>
<div class="outline-text-3" id="text-h:7983997d-f6a3-4dac-af8f-2d274bf1a60b">
<p>
通过在VM操作系统中安装SPICE client，SPICE
agent使virt-manager等图形应用程序更加流畅。例如:
</p>

<ul class="org-ul">
<li>在virt-manager中调整窗口尺寸，SPICE agent 自动调整X会话的分辨率</li>
<li>在Host与Guest之间复制与粘贴</li>
<li>防止鼠标拖尾等</li>
</ul>


<figure id="org57a77dd">
<img src="images/image-20210223141535065.png" alt="image-20210223141535065.png">

</figure>

<p>
官方下载链接: <a href="http://www.spice-space.org/download/">http://www.spice-space.org/download/</a>
</p>


<figure id="org140da9f">
<img src="images/image-20210223141544673.png" alt="image-20210223141544673.png">

</figure>
</div>
</div>
</section>
<section id="outline-container-h:3366e32f-8f1b-4833-bf23-ba652053a291" class="outline-2">
<h2 id="h:3366e32f-8f1b-4833-bf23-ba652053a291">libvirt 管理虚拟机</h2>
<div class="outline-text-2" id="text-h:3366e32f-8f1b-4833-bf23-ba652053a291">
</div>
<div id="outline-container-h:ca81dad1-c445-430f-af32-3f50b8afd910" class="outline-3">
<h3 id="h:ca81dad1-c445-430f-af32-3f50b8afd910">libvirt 架构</h3>
<div class="outline-text-3" id="text-h:ca81dad1-c445-430f-af32-3f50b8afd910">

<figure id="org0c88c98">
<img src="images/image-20210223141557881.png" alt="image-20210223141557881.png">

</figure>

<p>
<b>注意:
如果libvirtd服务意外关闭,将导致相关工具,如:virt-manager等无法和虚拟机连接,但虚拟机仍会正常运行</b>
</p>

<p>
范例: libvirtd 服务功能
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
2         centos8                                             running
3         Win_2008_r2-x86_64                         running
[root@centos8 ~]#systemctl stop libvirtd
[root@centos8 ~]#virsh list
error: failed to connect to the hypervisor
error: Failed to connect socket to <span style="color: #8b2252;">'/var/run/libvirt/libvirt-sock'</span>: No such file
or directory

<span style="color: #b22222;">#</span><span style="color: #b22222;">virt-manager&#24037;&#20855;&#20063;&#26080;&#27861;&#36830;&#25509;&#34394;&#25311;&#26426;</span>
</pre>
</div>


<figure id="orge50b96f">
<img src="images/image-20210223141613440.png" alt="image-20210223141613440.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#systemctl start libvirtd
[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
2         centos8                                             running
3         Win_2008_r2-x86_64                         running
<span style="color: #b22222;">#</span><span style="color: #b22222;">virt-manager&#24037;&#20855;&#20063;&#24674;&#22797;&#36830;&#25509;&#34394;&#25311;&#26426;</span>
</pre>
</div>


<figure id="org464062d">
<img src="images/image-20210223141625328.png" alt="image-20210223141625328.png">

</figure>
</div>
</div>
<div id="outline-container-h:80d0a578-20cf-4a75-819d-c2b38427d7d5" class="outline-3">
<h3 id="h:80d0a578-20cf-4a75-819d-c2b38427d7d5">virt-manager 管理虚拟机</h3>
<div class="outline-text-3" id="text-h:80d0a578-20cf-4a75-819d-c2b38427d7d5">
<p>
virt-manager是一个图形化工具,主要功能:
</p>

<ul class="org-ul">
<li>定义和创建虚拟机</li>
<li>硬件管理</li>
<li>性能监视</li>
<li>控制台</li>
<li>在线和离线迁移</li>
<li>虚拟机的保存和恢复、暂停和继续、关闭和启动</li>
</ul>
</div>
<div id="outline-container-h:931b57fd-2918-487b-84a4-e5e636680a29" class="outline-4">
<h4 id="h:931b57fd-2918-487b-84a4-e5e636680a29">启动菜单</h4>
<div class="outline-text-4" id="text-h:931b57fd-2918-487b-84a4-e5e636680a29">

<figure id="org1f659c1">
<img src="images/image-20210223141638060.png" alt="image-20210223141638060.png">

</figure>

<p>
开机后,按提示按ESC键,会出下面启动菜单
</p>


<figure id="org12ad4b2">
<img src="images/image-20210223141648281.png" alt="image-20210223141648281.png">

</figure>

<p>
设置跟随libvirtld服务开机启动
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">virt-install </span>
--autostart &#24341;&#23548;&#20027;&#26426;&#26102;&#33258;&#21160;&#21551;&#21160;&#22495;&#12290;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;virt-manager&#35774;&#32622;&#20013;Boot Options&#20013;&#30340;Autostart</span>
</pre>
</div>

<p>
设置完开机启动后，可以看到文件关联
</p>

<div class="org-src-container">
<pre class="src src-sh">ls /etc/libvirt/qemu/autostart/

centos7-vm3.xml -&gt; /etc/libvirt/qemu/centos7-vm3.xml
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8c34d563-cf03-4eaa-b451-77d5bc5119b5" class="outline-4">
<h4 id="h:8c34d563-cf03-4eaa-b451-77d5bc5119b5">使用USB设备</h4>
<div class="outline-text-4" id="text-h:8c34d563-cf03-4eaa-b451-77d5bc5119b5">
</div>
<div id="outline-container-h:6740b4b5-3564-43c0-9ce1-9827eb384fa3" class="outline-5">
<h5 id="h:6740b4b5-3564-43c0-9ce1-9827eb384fa3">添加USB设备</h5>
<div class="outline-text-5" id="text-h:6740b4b5-3564-43c0-9ce1-9827eb384fa3">
<p>
先在宿主机配置USB兼容性
</p>


<figure id="org23788a0">
<img src="images/image-20210223141659169.png" alt="image-20210223141659169.png">

</figure>

<p>
在宿主机接入U盘
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dmesg
[23687.183727] usb-storage 4-1:1.0: USB Mass Storage device detected
[23687.184183] scsi host3: usb-storage 4-1:1.0
[23687.184720] usbcore: registered new interface driver usb-storage
[23687.188873] usbcore: registered new interface driver uas
[23688.211730] scsi 3:0:0:0: Direct-Access         Kingston DataTraveler 3.0 PMAP
PQ: 0 ANSI: 6
[23688.214257] sd 3:0:0:0: Attached scsi generic sg2 type 0
[23688.216842] sd 3:0:0:0: [sdb] 60555264 512-byte logical blocks: (31.0 GB/28.9
GiB)
[23688.218094] sd 3:0:0:0: [sdb] Write Protect is off
[23688.218097] sd 3:0:0:0: [sdb] Mode Sense: 45 00 00 00
[23688.220335] sd 3:0:0:0: [sdb] Write cache: disabled, read cache: enabled,
doesn<span style="color: #8b2252;">'t support DPO or FUA</span>
<span style="color: #8b2252;">[23688.248203] sdb: sdb1</span>
<span style="color: #8b2252;">[23688.257440] sd 3:0:0:0: [sdb] Attached SCSI removable disk</span>
</pre>
</div>

<p>
打开virt-manager, 选择某个虚拟机的配置，加添硬件
</p>


<figure id="orgfbb15b0">
<img src="images/image-20210223141720475.png" alt="image-20210223141720475.png">

</figure>


<figure id="org6acd696">
<img src="images/image-20210223141733129.png" alt="image-20210223141733129.png">

</figure>


<figure id="org4c36190">
<img src="images/image-20210223141743849.png" alt="image-20210223141743849.png">

</figure>


<figure id="org42c961a">
<img src="images/image-20210223141750569.png" alt="image-20210223141750569.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">[root@localhost ~]#yum -y install usbutils
[root@localhost ~]# lsusb
Bus 002 Device 002: ID 0951:1666 Kingston Technology DataTraveler 100 G3/G4/SE9
G2
Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 001 Device 002: ID 0627:0001 Adomax Technology Co., Ltd
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
[root@localhost ~]# lsblk
NAME             MAJ:MIN RM     SIZE RO TYPE MOUNTPOINT
sda                     8:0         1     28.9G     0 disk
&#9492;&#9472;sda1                 8:1         1     28.9G     0 part
sr0                     11:0         1 393.4M     0 rom 
vda                 252:0         0     20G     0 disk
&#9500;&#9472;vda1             252:1         0         1G     0 part /boot
&#9492;&#9472;vda2             252:2         0     19G     0 part
&#9500;&#9472;cl-root 253:0         0     17G     0 lvm /
&#9492;&#9472;cl-swap 253:1         0         2G     0 lvm [SWAP]
</pre>
</div>
</div>
</div>
<div id="outline-container-h:721f57b0-dcee-4a75-b929-fee53f6c45a1" class="outline-5">
<h5 id="h:721f57b0-dcee-4a75-b929-fee53f6c45a1">重定向USB设备</h5>
<div class="outline-text-5" id="text-h:721f57b0-dcee-4a75-b929-fee53f6c45a1">
<p>
重定向指将客户端的物理设备重定向到虚拟机中
</p>

<p>
virt-manager&#x2013;"Virtual Machine"&#x2013;"Redirect USB device"
</p>


<figure id="org7b3b3c3">
<img src="images/image-20210223141806157.png" alt="image-20210223141806157.png">

</figure>


<figure id="org9424444">
<img src="images/image-20210223141813834.png" alt="image-20210223141813834.png">

</figure>

<p>
查看到新加的USB设备
</p>


<figure id="org9127cbe">
<img src="images/image-20210223141821178.png" alt="image-20210223141821178.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:e8533738-a11e-48df-ad51-c55f6d0da90a" class="outline-4">
<h4 id="h:e8533738-a11e-48df-ad51-c55f6d0da90a">远程管理KVM宿主机</h4>
<div class="outline-text-4" id="text-h:e8533738-a11e-48df-ad51-c55f6d0da90a">
<p>
可以连接到远程的宿主机进行虚拟机的管理
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #483d8b;">export</span> <span style="color: #a0522d;">DISPLAY</span>=10.0.0.1:0.0
virt-manager
</pre>
</div>

<p>
File&#x2013;Add Connection
</p>


<figure id="org1bbc147">
<img src="images/image-20210223141832848.png" alt="image-20210223141832848.png">

</figure>


<figure id="org5179710">
<img src="images/image-20210223141838857.png" alt="image-20210223141838857.png">

</figure>


<figure id="org3905690">
<img src="images/image-20210223141846547.png" alt="image-20210223141846547.png">

</figure>

<p>
解决上面问题的方法
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;1:&#22312;&#26412;&#26426;&#23433;&#35013;openssh-askpass&#21253;</span>
[root@centos8 ~]#yum -y install openssh-askpass

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#27861;2:&#23454;&#29616;&#22522;&#20110;&#26412;&#26426;&#21040;&#36828;&#31243;&#20027;&#26426;&#30340;key&#39564;&#35777;</span>
[root@centos8 ~]#ssh-copy-id 10.0.0.18
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed:
<span style="color: #8b2252;">"/root/.ssh/id_rsa.pub"</span>
The authenticity of host <span style="color: #8b2252;">'10.0.0.18 (10.0.0.18)'</span> can<span style="color: #8b2252;">'t be established.</span>
<span style="color: #8b2252;">ECDSA key fingerprint is SHA256:divKS+okAaeOzwWk/rHnrmZXWo3DUBPkkAnbofk+rbA.</span>
<span style="color: #8b2252;">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span>
<span style="color: #8b2252;">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter</span>
<span style="color: #8b2252;">out any that are already installed</span>
<span style="color: #8b2252;">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are</span>
<span style="color: #8b2252;">prompted now it is to install the new keys</span>
<span style="color: #8b2252;">root@10.0.0.18'</span>s password:
Number of key(s) added: 1
Now try logging into the machine, with:     <span style="color: #8b2252;">"ssh '10.0.0.18'"</span>

and check to make sure that only the key(s) you wanted were added.
</pre>
</div>

<p>
再次连接成功
</p>


<figure id="org7110aa8">
<img src="images/image-20210223141900456.png" alt="image-20210223141900456.png">

</figure>


<figure id="org8da4803">
<img src="images/image-20210223141908241.png" alt="image-20210223141908241.png">

</figure>


<figure id="org46c31c7">
<img src="images/image-20210223141914897.png" alt="image-20210223141914897.png">

</figure>
</div>
</div>
<div id="outline-container-h:1e2ae9c7-7d81-4c5a-994e-a776c0a70a8e" class="outline-4">
<h4 id="h:1e2ae9c7-7d81-4c5a-994e-a776c0a70a8e">虚拟机的性能监控</h4>
<div class="outline-text-4" id="text-h:1e2ae9c7-7d81-4c5a-994e-a776c0a70a8e">
<p>
先选择需要监控的项目
</p>

<p>
Edit &#x2013;Preferences&#x2013;Polling
</p>


<figure id="orgd4dfa2d">
<img src="images/image-20210223141924186.png" alt="image-20210223141924186.png">

</figure>

<p>
根据上面的项目,选择对应显示的项目(可选项由前一页的项目决定)
</p>

<div class="org-src-container">
<pre class="src src-sh">dd <span style="color: #a0522d;">if</span>=/dev/vda <span style="color: #a0522d;">of</span>=/dev/null
</pre>
</div>


<figure id="org5b41b2a">
<img src="images/image-20210223141933151.png" alt="image-20210223141933151.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:8dca3264-759e-4d8e-9e0e-4a1aa50c0199" class="outline-3">
<h3 id="h:8dca3264-759e-4d8e-9e0e-4a1aa50c0199">virsh 命令行工具</h3>
<div class="outline-text-3" id="text-h:8dca3264-759e-4d8e-9e0e-4a1aa50c0199">
</div>
<div id="outline-container-h:ea40cd39-ea90-44c5-b0e9-c69e8354d131" class="outline-4">
<h4 id="h:ea40cd39-ea90-44c5-b0e9-c69e8354d131">virsh 命令说明</h4>
<div class="outline-text-4" id="text-h:ea40cd39-ea90-44c5-b0e9-c69e8354d131">
<p>
virsh是使用libvirt
managementAPI构建的管理工具,相比virt-manager可以提高效率
virsh的名称的含义是virtualization shell
</p>
</div>
<div id="outline-container-h:7d707e42-8aef-4dd0-9e10-49644f83eed8" class="outline-5">
<h5 id="h:7d707e42-8aef-4dd0-9e10-49644f83eed8">两种工作模式</h5>
<div class="outline-text-5" id="text-h:7d707e42-8aef-4dd0-9e10-49644f83eed8">
<ul class="org-ul">
<li>交互模式</li>
<li>非交互模式</li>
</ul>


<figure id="org4bf1913">
<img src="images/image-20210223141945386.png" alt="image-20210223141945386.png">

</figure>
</div>
</div>
<div id="outline-container-h:99a1ee5f-e688-4170-a299-e9d4af6da05c" class="outline-5">
<h5 id="h:99a1ee5f-e688-4170-a299-e9d4af6da05c">virsh 主要功能</h5>
<div class="outline-text-5" id="text-h:99a1ee5f-e688-4170-a299-e9d4af6da05c">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh help
Domain Management (<span style="color: #483d8b;">help</span> keyword <span style="color: #8b2252;">'domain'</span>):
Domain Monitoring (<span style="color: #483d8b;">help</span> keyword <span style="color: #8b2252;">'monitor'</span>):
Host and Hypervisor (<span style="color: #483d8b;">help</span> keyword <span style="color: #8b2252;">'host'</span>):
<span style="color: #0000ff;">Interface</span> (<span style="color: #483d8b;">help</span> keyword <span style="color: #8b2252;">'interface'</span>):
Network Filter (<span style="color: #483d8b;">help</span> keyword <span style="color: #8b2252;">'filter'</span>):
<span style="color: #0000ff;">Networking</span> (<span style="color: #483d8b;">help</span> keyword <span style="color: #8b2252;">'network'</span>):
Node Device (<span style="color: #483d8b;">help</span> keyword <span style="color: #8b2252;">'nodedev'</span>):
<span style="color: #0000ff;">Secret</span> (<span style="color: #483d8b;">help</span> keyword <span style="color: #8b2252;">'secret'</span>):
<span style="color: #0000ff;">Snapshot</span> (<span style="color: #483d8b;">help</span> keyword <span style="color: #8b2252;">'snapshot'</span>):
Storage Pool (<span style="color: #483d8b;">help</span> keyword <span style="color: #8b2252;">'pool'</span>):
Storage Volume (<span style="color: #483d8b;">help</span> keyword <span style="color: #8b2252;">'volume'</span>):
Virsh itself (<span style="color: #483d8b;">help</span> keyword <span style="color: #8b2252;">'virsh'</span>):
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9e7eb122-bfe6-45dd-a366-f2cd1c1408b7" class="outline-5">
<h5 id="h:9e7eb122-bfe6-45dd-a366-f2cd1c1408b7">virsh 命令格式</h5>
<div class="outline-text-5" id="text-h:9e7eb122-bfe6-45dd-a366-f2cd1c1408b7">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh --help
virsh [options]... [&lt;command_string&gt;]
virsh [options]... &lt;command&gt; [args...]
options:
        -c | --connect=URI         hypervisor connection URI
        -d | --debug=NUM             debug level [0-4]
        -e | --escape &lt;char&gt;         set escape sequence for console
        -h | --help                         this help
        -k | --keepalive-interval=NUM
                                                    keepalive interval<span style="color: #a020f0;"> in</span> seconds, 0 for disable
        -K | --keepalive-count=NUM
                                                    number of possible missed keepalive messages
        -l | --log=FILE                 output logging to file
        -q | --quiet                     quiet mode
        -r | --readonly                 connect readonly
        -t | --timing                     print timing information
        -v                                         short version
        -V                                         long version
                --version[=TYPE]     version, TYPE is short or long (default short)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b215852b-d1cc-4d4d-b9de-2a795304c7d1" class="outline-5">
<h5 id="h:b215852b-d1cc-4d4d-b9de-2a795304c7d1">virsh 子命令说明</h5>
<div class="outline-text-5" id="text-h:b215852b-d1cc-4d4d-b9de-2a795304c7d1">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #483d8b;">help</span>                                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25171;&#21360;&#22522;&#26412;&#24110;&#21161;&#20449;&#24687;</span>
attach-device                      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20351;&#29992;XML&#25991;&#20214;&#20013;&#30340;&#35774;&#22791;&#23450;&#20041;&#22312;&#34394;&#25311;&#26426;&#20013;&#28155;&#21152;&#35774;&#22791;</span>
attach-disk                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#34394;&#25311;&#26426;&#20013;&#38468;&#21152;&#26032;&#30913;&#30424;&#35774;&#22791;</span>
attach-interface                  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#34394;&#25311;&#26426;&#20013;&#38468;&#21152;&#26032;&#32593;&#32476;&#25509;&#21475;</span>
create                                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174; XML &#37197;&#32622;&#25991;&#20214;&#29983;&#25104;&#34394;&#25311;&#26426;&#24182;&#21551;&#21160;&#26032;&#34394;&#25311;&#26426;</span>
define                                   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#34394;&#25311;&#26426;&#36755;&#20986;XML&#37197;&#32622;&#25991;&#20214;</span>
destroy                                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24378;&#21046;&#34394;&#25311;&#26426;&#20572;&#27490;</span>
detach-device                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#34394;&#25311;&#26426;&#20013;&#20998;&#31163;&#35774;&#22791;&#65292;&#20351;&#29992;&#21516;&#26679;&#30340;XML &#25551;&#36848;&#20316;&#20026;&#21629;&#20196;attach-device</span>
detach-disk                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#34394;&#25311;&#26426;&#20013;&#20998;&#31163;&#30913;&#30424;&#35774;&#22791;</span>
detach-interface                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#34394;&#25311;&#26426;&#20013;&#20998;&#31163;&#32593;&#32476;&#25509;&#21475;</span>
domblkstat                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#27491;&#22312;&#36816;&#34892;&#30340;&#34394;&#25311;&#26426;&#30340;&#22359;&#35774;&#22791;&#32479;&#35745;</span>
domid                                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#34394;&#25311;&#26426;ID</span>
domifstat                           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#27491;&#22312;&#36816;&#34892;&#30340;&#34394;&#25311;&#26426;&#30340;&#32593;&#32476;&#25509;&#21475;&#32479;&#35745;</span>
dominfo                             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#34394;&#25311;&#26426;&#20449;&#24687;</span>
domname                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#34394;&#25311;&#26426;&#21517;&#31216;</span>
domstate                           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#34394;&#20197;&#26426;&#29366;&#24577;</span>
domuuid                            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#34394;&#25311;&#26426;UUID</span>
dumpxml                            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#34394;&#25311;&#26426; XML&#37197;&#32622;&#25991;&#20214;</span>
list                                       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25152;&#26377;&#34394;&#25311;&#26426;</span>
migrate                               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#34394;&#25311;&#26426;&#36801;&#31227;&#21040;&#21478;&#19968;&#21488;&#20027;&#26426;&#20013;</span>
nodeinfo                              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26377;&#20851;&#31649;&#29702;&#31243;&#24207;&#30340;&#36755;&#20986;&#20449;&#24687;</span>
quit                                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36864;&#20986;&#36825;&#20010;&#20114;&#21160;&#32456;&#31471;</span>
reboot                                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#26032;&#21551;&#21160;&#34394;&#25311;&#26426;</span>
restore                               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24674;&#22797;&#20197;&#21069;&#20445;&#23384;&#22312;&#25991;&#20214;&#20013;&#30340;&#34394;&#25311;&#26426;</span>
resume                                <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24674;&#22797;&#26242;&#20572;&#30340;&#34394;&#25311;&#26426;</span>
save                                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#34394;&#25311;&#26426;&#24403;&#21069;&#29366;&#24577;&#20445;&#23384;&#21040;&#26576;&#20010;&#25991;&#20214;&#20013;</span>
setmaxmem                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#31649;&#29702;&#31243;&#24207;&#35774;&#23450;&#20869;&#23384;&#19978;&#38480;</span>
setmem                               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#34394;&#25311;&#26426;&#35774;&#23450;&#20998;&#37197;&#30340;&#20869;&#23384;</span>
setvcpus                             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#20026;&#34394;&#25311;&#26426;&#20998;&#37197;&#30340;&#34394;&#25311;CPU&#25968;&#30446;</span>
shutdown                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#38381;&#26576;&#20010;&#34394;&#25311;&#26426;</span>
start                                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#26410;&#28608;&#27963;&#30340;&#34394;&#25311;&#26426;</span>
<span style="color: #483d8b;">suspend</span>                             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26242;&#20572;&#34394;&#25311;&#26426;</span>
undefine                            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#19982;&#34394;&#25311;&#26426;&#20851;&#32852;&#30340;&#25152;&#26377;&#25991;&#20214;</span>
vepuinfo                            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#34394;&#20197;&#26426;&#30340;&#34394;&#25311;CPU&#20449;&#24687;</span>
vcpupin                             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25511;&#21046;&#34394;&#25311;&#26426;&#30340;&#34394;&#25311;CPU&#20146;&#21644;&#24615;</span>
version                              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29256;&#26412;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3469bb04-53d0-43cb-93c2-4b4b1dd10fc6" class="outline-5">
<h5 id="h:3469bb04-53d0-43cb-93c2-4b4b1dd10fc6">查看子命令帮助</h5>
<div class="outline-text-5" id="text-h:3469bb04-53d0-43cb-93c2-4b4b1dd10fc6">
<div class="org-src-container">
<pre class="src src-sh">virsh help COMMAND
</pre>
</div>

<p>
范例: 查看子命令 list 命令用法
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh help list
NAME
    list - list domains
SYNOPSIS
    list [--inactive] [--all] [--transient] [--persistent] [--with-snapshot] [--
without-snapshot] [--state-running] [--state-paused] [--state-shutoff] [--state-
other] [--autostart] [--no-autostart] [--with-managed-save] [--without-managed-
save] [--uuid] [--name] [--table] [--managed-save] [--title]
DESCRIPTION
    Returns list of domains.
OPTIONS
        --inactive             list inactive domains   &#21015;&#20986;&#19981;&#27963;&#21160;&#30340;&#34394;&#25311;&#26426;
        --all                     list inactive &amp; active domains  &#21015;&#20986;&#25152;&#26377;
        --transient         list transient domains
        --persistent         list persistent domains
        --with-snapshot list domains with existing snapshot
        --without-snapshot list domains without a snapshot
        --state-running list domains<span style="color: #a020f0;"> in</span> running state
        --state-paused     list domains<span style="color: #a020f0;"> in</span> paused state
        --state-shutoff list domains<span style="color: #a020f0;"> in</span> shutoff state
        --state-other     list domains<span style="color: #a020f0;"> in</span> other states
        --autostart         list domains with autostart enabled   &#26597;&#30475;&#24320;&#26426;&#33258;&#21551;&#21160;&#30340;&#34394;&#25311;&#26426;
        --no-autostart     list domains with autostart disabled
        --with-managed-save list domains with managed save state
        --without-managed-save list domains without managed save
        --uuid                     list uuid<span style="color: #8b2252;">'s only</span>
<span style="color: #8b2252;">        --name                     list domain names only</span>
<span style="color: #8b2252;">        --table                 list table (default)</span>
<span style="color: #8b2252;">        --managed-save     mark inactive domains with managed save state</span>
<span style="color: #8b2252;">        --title                 show domain title</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:f223016a-1e7a-4f68-84c1-785dd44261b4" class="outline-4">
<h4 id="h:f223016a-1e7a-4f68-84c1-785dd44261b4">启动和关闭虚拟机</h4>
<div class="outline-text-4" id="text-h:f223016a-1e7a-4f68-84c1-785dd44261b4">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#21551;&#21160;&#30340;&#34394;&#25311;&#26426;</span>
[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
1         Win_2008_r2-x86_64                         running

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25152;&#26377;&#34394;&#25311;&#26426;</span>
[root@centos8 ~]#virsh list --all
Id     Name                                                     State
----------------------------------------------------
1         Win_2008_r2-x86_64                         running
-         centos7                                             shut off
-         centos8                                             shut off
-         centos8-vm2                                     shut off
-         centos8-vm3                                     shut off
-         centos8-vm4                                     shut off

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;</span>
[root@centos8 ~]#virsh start centos8
Domain centos8 started
[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
1         Win_2008_r2-x86_64                         running
2         centos8                                             running

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27491;&#24120;&#20851;&#26426;</span>
[root@centos8 ~]#virsh shutdown 1
Domain 1 is being shutdown
[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
1         Win_2008_r2-x86_64                         running
2         centos8                                             running

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24378;&#21046;&#20851;&#26426;</span>
[root@centos8 ~]#virsh destroy 1
Domain 1 destroyed
[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
2         centos8                                             running

[root@centos8 ~]#virsh shutdown 2
Domain 2 is being shutdown
[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
</pre>
</div>

<p>
在virt-manager 中可以看到关机状态
</p>


<figure id="org7169758">
<img src="images/image-20210223142017736.png" alt="image-20210223142017736.png">

</figure>

<p>
<b>查看虚拟机UUID,通过UUID启动关闭虚拟机</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
1         centos8                                             running
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#34394;&#25311;&#26426;&#30340;UUID</span>
[root@centos8 ~]#virsh domuuid 1
99765478-cfb1-4164-b038-f62004ccab9e
[root@centos8 ~]#virsh destroy 99765478-cfb1-4164-b038-f62004ccab9e
Domain 99765478-cfb1-4164-b038-f62004ccab9e destroyed
[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
[root@centos8 ~]#virsh list --all
Id     Name                                                     State
----------------------------------------------------
-         centos7                                             shut off
-         centos8                                             shut off
-         centos8-vm2                                     shut off
-         centos8-vm3                                     shut off
-         centos8-vm4                                     shut off
-         Win_2008_r2-x86_64                         shut off

[root@centos8 ~]#virsh domuuid centos8
99765478-cfb1-4164-b038-f62004ccab9e

[root@centos8 ~]#virsh start 99765478-cfb1-4164-b038-f62004ccab9e
Domain centos8 started
[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
2         centos8                                             running
[root@centos8 ~]#virsh domuuid centos8
99765478-cfb1-4164-b038-f62004ccab9e
</pre>
</div>
</div>
</div>
<div id="outline-container-h:024c32aa-0a15-42b3-9a57-a745e6a2335c" class="outline-4">
<h4 id="h:024c32aa-0a15-42b3-9a57-a745e6a2335c">暂停和恢复虚拟机</h4>
<div class="outline-text-4" id="text-h:024c32aa-0a15-42b3-9a57-a745e6a2335c">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
1         centos8                                             running
[root@centos8 ~]#virsh suspend centos8
Domain centos8 suspended
[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
1         centos8                                             paused

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#34394;&#25311;&#26426;&#26242;&#20572;&#21518;,&#23487;&#20027;&#26426;&#20013;&#36824;&#23384;&#26377;&#30456;&#20851;&#30340;&#36827;&#31243;</span>
[root@centos8 ~]#ps aux|grep kvm
qemu                 1699 36.9 16.0 4439296 1309300 ?         Sl     10:10     5:28
/usr/libexec/qemu-kvm -name <span style="color: #a0522d;">guest</span>=centos8,debug-threads=on -S -object
secret,<span style="color: #a0522d;">id</span>=masterKey0,<span style="color: #a0522d;">format</span>=raw,<span style="color: #a0522d;">file</span>=/var/lib/libvirt/qemu/domain-
......
[root@centos8 ~]#virsh resume 1
Domain 1 resumed
[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
1         centos8                                             running
</pre>
</div>
</div>
</div>
<div id="outline-container-h:da5677b5-63f7-4fbf-85b7-43014878e1c8" class="outline-4">
<h4 id="h:da5677b5-63f7-4fbf-85b7-43014878e1c8">配置虚拟机开机自动启动</h4>
<div class="outline-text-4" id="text-h:da5677b5-63f7-4fbf-85b7-43014878e1c8">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh list --all
Id     Name                                                     State
----------------------------------------------------
1         Win_2008_r2-x86_64                         running
-         centos7                                             shut off
-         centos8                                             shut off
-         centos8-vm2                                     shut off
-         centos8-vm3                                     shut off
-         centos8-vm4                                     shut off

[root@centos8 ~]#virsh autostart centos8
Domain centos8 marked as autostarted

[root@centos8 ~]#ll /etc/libvirt/qemu/autostart/
total 0
lrwxrwxrwx 1 root root 29 Sep 17 18:53 centos8.xml -&gt;
/etc/libvirt/qemu/centos8.xml
lrwxrwxrwx 1 root root 40 Sep 17 09:18 Win_2008_r2-x86_64.xml -&gt;
/etc/libvirt/qemu/Win_2008_r2-x86_64.xml
[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
1         Win_2008_r2-x86_64                         running

[root@centos8 ~]#virsh autostart 1 --disable
Domain 1 unmarked as autostarted
[root@centos8 ~]#ll /etc/libvirt/qemu/autostart/
total 0
lrwxrwxrwx 1 root root 29 Sep 17 18:53 centos8.xml -&gt;
/etc/libvirt/qemu/centos8.xml
[root@centos8 ~]#reboot
[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
1         centos8                                             running
</pre>
</div>

<p>
在virt-manager工具中也可以配置开机自启动
</p>


<figure id="org4aa8d33">
<img src="images/image-20210223142041234.png" alt="image-20210223142041234.png">

</figure>
</div>
</div>
<div id="outline-container-h:bf32584e-870c-4e2c-aa1a-f489d6a21bef" class="outline-4">
<h4 id="h:bf32584e-870c-4e2c-aa1a-f489d6a21bef">查看虚拟机配置</h4>
<div class="outline-text-4" id="text-h:bf32584e-870c-4e2c-aa1a-f489d6a21bef">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh list --all
Id     Name                                                     State
----------------------------------------------------
2         centos8                                             running
-         centos7                                             shut off
-         centos8-vm2                                     shut off
-         centos8-vm3                                     shut off
-         centos8-vm4                                     shut off
-         Win_2008_r2-x86_64                         shut off

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#20010;&#34394;&#25311;&#26426;&#37197;&#32622;&#37117;&#23384;&#25918;&#22312;/etc/libvirt/qemu&#30446;&#24405;&#19979;&#30340;xml&#25991;&#20214;&#20013;</span>
[root@centos8 ~]#ls /etc/libvirt/qemu/ -l
total 32
drwxr-xr-x 2 root root     25 Sep 17 18:54 autostart
-rw------- 1 root root 3618 Sep 17 15:14 centos7.xml
-rw------- 1 root root 3673 Sep 13 22:43 centos8-vm2.xml
-rw------- 1 root root 3601 Sep 13 22:42 centos8-vm3.xml
-rw------- 1 root root 3379 Sep 14 00:15 centos8-vm4.xml
-rw------- 1 root root 6024 Sep 17 15:47 centos8.xml
drwx------ 3 root root     42 Sep 13 19:03 networks
-rw------- 1 root root 5369 Sep 17 11:31 Win_2008_r2-x86_64.xml

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25351;&#23450;&#34394;&#25311;&#26426;&#30340;&#37197;&#32622;,&#20197;&#19979;&#21629;&#20196;&#30456;&#24403;&#20110;&#26597;&#30475; /etc/libvirt/qemu/centos8.xml</span>
[root@centos8 ~]#virsh dumpxml centos8
&lt;domain <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'qemu'</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">'2'</span>&gt;
&lt;name&gt;centos8&lt;/name&gt;
&lt;uuid&gt;99765478-cfb1-4164-b038-f62004ccab9e&lt;/uuid&gt;
&lt;metadata&gt;
    &lt;libosinfo:libosinfo
xmlns:<span style="color: #a0522d;">libosinfo</span>=<span style="color: #8b2252;">"http://libosinfo.org/xmlns/libvirt/domain/1.0"</span>&gt;
        &lt;libosinfo:os <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"http://centos.org/centos/8"</span>/&gt;
    &lt;/libosinfo:libosinfo&gt;
&lt;/metadata&gt;
&lt;memory <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'KiB'</span>&gt;2097152&lt;/memory&gt;
&lt;currentMemory <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'KiB'</span>&gt;2097152&lt;/currentMemory&gt;
&lt;vcpu <span style="color: #a0522d;">placement</span>=<span style="color: #8b2252;">'static'</span>&gt;2&lt;/vcpu&gt;
&lt;resource&gt;
    &lt;partition&gt;/machine&lt;/partition&gt;
&lt;/resource&gt;
&lt;os&gt;
    &lt;type <span style="color: #a0522d;">arch</span>=<span style="color: #8b2252;">'x86_64'</span> <span style="color: #a0522d;">machine</span>=<span style="color: #8b2252;">'pc-q35-rhel7.6.0'</span>&gt;hvm&lt;/type&gt;
     &lt;boot <span style="color: #a0522d;">dev</span>=<span style="color: #8b2252;">'hd'</span>/&gt;
    &lt;bootmenu <span style="color: #a0522d;">enable</span>=<span style="color: #8b2252;">'yes'</span>/&gt;
&lt;/os&gt;
&lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
    &lt;vmport <span style="color: #a0522d;">state</span>=<span style="color: #8b2252;">'off'</span>/&gt;
&lt;/features&gt;
&lt;clock <span style="color: #a0522d;">offset</span>=<span style="color: #8b2252;">'utc'</span>&gt;
    &lt;timer <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'rtc'</span> <span style="color: #a0522d;">tickpolicy</span>=<span style="color: #8b2252;">'catchup'</span>/&gt;
    &lt;timer <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'pit'</span> <span style="color: #a0522d;">tickpolicy</span>=<span style="color: #8b2252;">'delay'</span>/&gt;
    &lt;timer <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'hpet'</span> <span style="color: #a0522d;">present</span>=<span style="color: #8b2252;">'no'</span>/&gt;
&lt;/clock&gt;
&lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
&lt;on_reboot&gt;restart&lt;/on_reboot&gt;
&lt;on_crash&gt;destroy&lt;/on_crash&gt;
&lt;pm&gt;
    &lt;suspend-to-mem <span style="color: #a0522d;">enabled</span>=<span style="color: #8b2252;">'no'</span>/&gt;
    &lt;suspend-to-disk <span style="color: #a0522d;">enabled</span>=<span style="color: #8b2252;">'no'</span>/&gt;
&lt;/pm&gt;
&lt;devices&gt;
    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
    &lt;disk <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'file'</span> <span style="color: #a0522d;">device</span>=<span style="color: #8b2252;">'disk'</span>&gt;
        &lt;driver <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'qemu'</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'qcow2'</span>/&gt;
        &lt;source <span style="color: #a0522d;">file</span>=<span style="color: #8b2252;">'/var/lib/libvirt/images/centos8.qcow2'</span>/&gt;
        &lt;backingStore/&gt;
        &lt;target <span style="color: #a0522d;">dev</span>=<span style="color: #8b2252;">'vda'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'virtio'</span>/&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'virtio-disk0'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x04'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x00'</span>
<span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x0'</span>/&gt;
    &lt;/disk&gt;
    &lt;disk <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'file'</span> <span style="color: #a0522d;">device</span>=<span style="color: #8b2252;">'cdrom'</span>&gt;
        &lt;driver <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'qemu'</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'raw'</span>/&gt;
        &lt;source <span style="color: #a0522d;">file</span>=<span style="color: #8b2252;">'/data/isos/virtio-win-0.1.185.iso'</span>/&gt;
        &lt;backingStore/&gt;
        &lt;target <span style="color: #a0522d;">dev</span>=<span style="color: #8b2252;">'sda'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'sata'</span>/&gt;
        &lt;readonly/&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'sata0-0-0'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'drive'</span> <span style="color: #a0522d;">controller</span>=<span style="color: #8b2252;">'0'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0'</span> <span style="color: #a0522d;">target</span>=<span style="color: #8b2252;">'0'</span> <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'0'</span>/&gt;
    &lt;/disk&gt;
    &lt;controller <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'usb'</span> <span style="color: #a0522d;">index</span>=<span style="color: #8b2252;">'0'</span> <span style="color: #a0522d;">model</span>=<span style="color: #8b2252;">'qemu-xhci'</span> <span style="color: #a0522d;">ports</span>=<span style="color: #8b2252;">'15'</span>&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'usb'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x02'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x00'</span>
<span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x0'</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'sata'</span> <span style="color: #a0522d;">index</span>=<span style="color: #8b2252;">'0'</span>&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'ide'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x00'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x1f'</span>
<span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x2'</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">index</span>=<span style="color: #8b2252;">'0'</span> <span style="color: #a0522d;">model</span>=<span style="color: #8b2252;">'pcie-root'</span>&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'pcie.0'</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">index</span>=<span style="color: #8b2252;">'1'</span> <span style="color: #a0522d;">model</span>=<span style="color: #8b2252;">'pcie-root-port'</span>&gt;
        &lt;model <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'pcie-root-port'</span>/&gt;
        &lt;target <span style="color: #a0522d;">chassis</span>=<span style="color: #8b2252;">'1'</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">'0x10'</span>/&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'pci.1'</span>/&gt;
         &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x00'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x02'</span> <span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x0'</span>
<span style="color: #a0522d;">multifunction</span>=<span style="color: #8b2252;">'on'</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">index</span>=<span style="color: #8b2252;">'2'</span> <span style="color: #a0522d;">model</span>=<span style="color: #8b2252;">'pcie-root-port'</span>&gt;
        &lt;model <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'pcie-root-port'</span>/&gt;
        &lt;target <span style="color: #a0522d;">chassis</span>=<span style="color: #8b2252;">'2'</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">'0x11'</span>/&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'pci.2'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x00'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x02'</span>
<span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x1'</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">index</span>=<span style="color: #8b2252;">'3'</span> <span style="color: #a0522d;">model</span>=<span style="color: #8b2252;">'pcie-root-port'</span>&gt;
        &lt;model <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'pcie-root-port'</span>/&gt;
        &lt;target <span style="color: #a0522d;">chassis</span>=<span style="color: #8b2252;">'3'</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">'0x12'</span>/&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'pci.3'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x00'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x02'</span>
<span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x2'</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">index</span>=<span style="color: #8b2252;">'4'</span> <span style="color: #a0522d;">model</span>=<span style="color: #8b2252;">'pcie-root-port'</span>&gt;
        &lt;model <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'pcie-root-port'</span>/&gt;
        &lt;target <span style="color: #a0522d;">chassis</span>=<span style="color: #8b2252;">'4'</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">'0x13'</span>/&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'pci.4'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x00'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x02'</span>
<span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x3'</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">index</span>=<span style="color: #8b2252;">'5'</span> <span style="color: #a0522d;">model</span>=<span style="color: #8b2252;">'pcie-root-port'</span>&gt;
        &lt;model <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'pcie-root-port'</span>/&gt;
        &lt;target <span style="color: #a0522d;">chassis</span>=<span style="color: #8b2252;">'5'</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">'0x14'</span>/&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'pci.5'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x00'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x02'</span>
<span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x4'</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">index</span>=<span style="color: #8b2252;">'6'</span> <span style="color: #a0522d;">model</span>=<span style="color: #8b2252;">'pcie-root-port'</span>&gt;
        &lt;model <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'pcie-root-port'</span>/&gt;
        &lt;target <span style="color: #a0522d;">chassis</span>=<span style="color: #8b2252;">'6'</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">'0x15'</span>/&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'pci.6'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x00'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x02'</span>
<span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x5'</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">index</span>=<span style="color: #8b2252;">'7'</span> <span style="color: #a0522d;">model</span>=<span style="color: #8b2252;">'pcie-root-port'</span>&gt;
        &lt;model <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'pcie-root-port'</span>/&gt;
        &lt;target <span style="color: #a0522d;">chassis</span>=<span style="color: #8b2252;">'7'</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">'0x16'</span>/&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'pci.7'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x00'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x02'</span>
<span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x6'</span>/&gt;
    &lt;/controller&gt;
    &lt;controller <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'virtio-serial'</span> <span style="color: #a0522d;">index</span>=<span style="color: #8b2252;">'0'</span>&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'virtio-serial0'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x03'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x00'</span>
<span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x0'</span>/&gt;
    &lt;/controller&gt;
    &lt;interface <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'network'</span>&gt;
        &lt;mac <span style="color: #a0522d;">address</span>=<span style="color: #8b2252;">'52:54:00:83:9d:51'</span>/&gt;
        &lt;source <span style="color: #a0522d;">network</span>=<span style="color: #8b2252;">'default'</span> <span style="color: #a0522d;">bridge</span>=<span style="color: #8b2252;">'virbr0'</span>/&gt;
        &lt;target <span style="color: #a0522d;">dev</span>=<span style="color: #8b2252;">'vnet0'</span>/&gt;
        &lt;model <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'virtio'</span>/&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'net0'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x01'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x00'</span>
<span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x0'</span>/&gt;
     &lt;/interface&gt;
    &lt;serial <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pty'</span>&gt;
        &lt;source <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">'/dev/pts/0'</span>/&gt;
        &lt;target <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'isa-serial'</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">'0'</span>&gt;
            &lt;model <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'isa-serial'</span>/&gt;
        &lt;/target&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'serial0'</span>/&gt;
    &lt;/serial&gt;
    &lt;console <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pty'</span> <span style="color: #a0522d;">tty</span>=<span style="color: #8b2252;">'/dev/pts/0'</span>&gt;
        &lt;source <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">'/dev/pts/0'</span>/&gt;
        &lt;target <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'serial'</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">'0'</span>/&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'serial0'</span>/&gt;
    &lt;/console&gt;
    &lt;channel <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'unix'</span>&gt;
        &lt;source <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">'bind'</span> <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">'/var/lib/libvirt/qemu/channel/target/domain-2-</span>
<span style="color: #8b2252;">centos8/org.qemu.guest_agent.0'</span>/&gt;
        &lt;target <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'virtio'</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'org.qemu.guest_agent.0'</span> <span style="color: #a0522d;">state</span>=<span style="color: #8b2252;">'disconnected'</span>/&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'channel0'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'virtio-serial'</span> <span style="color: #a0522d;">controller</span>=<span style="color: #8b2252;">'0'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0'</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">'1'</span>/&gt;
    &lt;/channel&gt;
    &lt;channel <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'spicevmc'</span>&gt;
        &lt;target <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'virtio'</span> <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'com.redhat.spice.0'</span> <span style="color: #a0522d;">state</span>=<span style="color: #8b2252;">'disconnected'</span>/&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'channel1'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'virtio-serial'</span> <span style="color: #a0522d;">controller</span>=<span style="color: #8b2252;">'0'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0'</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">'2'</span>/&gt;
    &lt;/channel&gt;
    &lt;input <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'tablet'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'usb'</span>&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'input0'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'usb'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0'</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">'1'</span>/&gt;
    &lt;/input&gt;
    &lt;input <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'mouse'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'ps2'</span>&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'input1'</span>/&gt;
    &lt;/input&gt;
    &lt;input <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'keyboard'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'ps2'</span>&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'input2'</span>/&gt;
    &lt;/input&gt;
    &lt;graphics <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'spice'</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">'5900'</span> <span style="color: #a0522d;">autoport</span>=<span style="color: #8b2252;">'yes'</span> <span style="color: #a0522d;">listen</span>=<span style="color: #8b2252;">'127.0.0.1'</span>&gt;
        &lt;listen <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'address'</span> <span style="color: #a0522d;">address</span>=<span style="color: #8b2252;">'127.0.0.1'</span>/&gt;
        &lt;image <span style="color: #a0522d;">compression</span>=<span style="color: #8b2252;">'off'</span>/&gt;
    &lt;/graphics&gt;
    &lt;sound <span style="color: #a0522d;">model</span>=<span style="color: #8b2252;">'ich9'</span>&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'sound0'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x00'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x1b'</span>
<span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x0'</span>/&gt;
    &lt;/sound&gt;
    &lt;video&gt;
        &lt;model <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'qxl'</span> <span style="color: #a0522d;">ram</span>=<span style="color: #8b2252;">'65536'</span> <span style="color: #a0522d;">vram</span>=<span style="color: #8b2252;">'65536'</span> <span style="color: #a0522d;">vgamem</span>=<span style="color: #8b2252;">'16384'</span> <span style="color: #a0522d;">heads</span>=<span style="color: #8b2252;">'1'</span>
<span style="color: #a0522d;">primary</span>=<span style="color: #8b2252;">'yes'</span>/&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'video0'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x00'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x01'</span>
<span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x0'</span>/&gt;
    &lt;/video&gt;
    &lt;redirdev <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'usb'</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'spicevmc'</span>&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'redir0'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'usb'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0'</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">'2'</span>/&gt;
    &lt;/redirdev&gt;
    &lt;redirdev <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'usb'</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'spicevmc'</span>&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'redir1'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'usb'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0'</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">'3'</span>/&gt;
    &lt;/redirdev&gt;
    &lt;redirdev <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'usb'</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'spicevmc'</span>&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'redir2'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'usb'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0'</span> <span style="color: #a0522d;">port</span>=<span style="color: #8b2252;">'4'</span>/&gt;
    &lt;/redirdev&gt;
    &lt;memballoon <span style="color: #a0522d;">model</span>=<span style="color: #8b2252;">'virtio'</span>&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'balloon0'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x05'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x00'</span>
<span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x0'</span>/&gt;
    &lt;/memballoon&gt;
    &lt;rng <span style="color: #a0522d;">model</span>=<span style="color: #8b2252;">'virtio'</span>&gt;
        &lt;backend <span style="color: #a0522d;">model</span>=<span style="color: #8b2252;">'random'</span>&gt;/dev/urandom&lt;/backend&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'rng0'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x06'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x00'</span>
<span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x0'</span>/&gt;
    &lt;/rng&gt;
&lt;/devices&gt;
&lt;seclabel <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'dynamic'</span> <span style="color: #a0522d;">model</span>=<span style="color: #8b2252;">'dac'</span> <span style="color: #a0522d;">relabel</span>=<span style="color: #8b2252;">'yes'</span>&gt;
    &lt;label&gt;+107:+107&lt;/label&gt;
    &lt;imagelabel&gt;+107:+107&lt;/imagelabel&gt;
&lt;/seclabel&gt;
&lt;/domain&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:59f69fc5-9426-4365-a334-01219cd6fa6b" class="outline-4">
<h4 id="h:59f69fc5-9426-4365-a334-01219cd6fa6b">删除虚拟机配置</h4>
<div class="outline-text-4" id="text-h:59f69fc5-9426-4365-a334-01219cd6fa6b">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh list --all
Id     Name                                                     State
----------------------------------------------------
2         centos8                                             running
-         centos7                                             shut off
-         centos8-vm2                                     shut off
-         centos8-vm3                                     shut off
-         centos8-vm4                                     shut off
-         Win_2008_r2-x86_64                         shut off

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#34394;&#25311;&#26426;&#37197;&#32622;,&#20294;&#19981;&#21024;&#38500;&#30913;&#30424;&#25991;&#20214;</span>
[root@centos8 ~]#virsh undefine centos8-vm4
Domain centos8-vm4 has been undefined
[root@centos8 ~]#virsh list --all
Id     Name                                                     State
----------------------------------------------------
2         centos8                                             running
-         centos7                                             shut off
-         centos8-vm2                                     shut off
-         centos8-vm3                                     shut off
-         Win_2008_r2-x86_64                         shut off

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#24212;&#34394;&#25311;&#26426;xml&#30340;&#37197;&#32622;&#25991;&#20214;&#34987;&#21024;&#38500;</span>
[root@centos8 ~]#ll /etc/libvirt/qemu/
total 28
drwxr-xr-x 2 root root     25 Sep 17 18:54 autostart
-rw------- 1 root root 3618 Sep 17 15:14 centos7.xml
-rw------- 1 root root 3673 Sep 13 22:43 centos8-vm2.xml
-rw------- 1 root root 3601 Sep 13 22:42 centos8-vm3.xml
-rw------- 1 root root 6024 Sep 17 15:47 centos8.xml
drwx------ 3 root root     42 Sep 13 19:03 networks
-rw------- 1 root root 5369 Sep 17 11:31 Win_2008_r2-x86_64.xml
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23545;&#24212;&#30340;&#30913;&#30424;&#25991;&#20214;&#24182;&#27809;&#26377;&#21024;&#38500;</span>
[root@centos8 ~]#ls /var/lib/libvirt/images/
centos7.qcow2 centos8.qcow2 centos8-vm2.qcow2 centos8-vm3.qcow2 centos8-
vm4.qcow2 Windows-2008_r2-x86_64.qcow2
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:94ea0620-9987-4aed-ae41-f32e4e8503da" class="outline-2">
<h2 id="h:94ea0620-9987-4aed-ae41-f32e4e8503da">存储管理</h2>
<div class="outline-text-2" id="text-h:94ea0620-9987-4aed-ae41-f32e4e8503da">
</div>
<div id="outline-container-h:efcd2e8f-3b8e-469b-aa1a-eb26dddc6d73" class="outline-3">
<h3 id="h:efcd2e8f-3b8e-469b-aa1a-eb26dddc6d73">KVM存储模式</h3>
<div class="outline-text-3" id="text-h:efcd2e8f-3b8e-469b-aa1a-eb26dddc6d73">
<p>
通过存储池来简介存储的管理
</p>

<p>
<b>基于文件系统的存储</b>
</p>

<ul class="org-ul">
<li>dir: Filesystem Directory 需要有挂载点的文件系统</li>
<li><p>
fs: Pre-Formatted Block Device
</p>

<p>
无需挂载的文件系统,如:位于SAN存储的文件系统,可支持多个主机同时访问,而本地文件系统不支持
</p></li>

<li>netfs: Network Exported Directory 网络文件系统,比如:NFS,SAMBA等</li>
</ul>

<p>
<b>基于设备的存储</b> 无需文件系统,性能更好,但可管理性差,无法实现快照
</p>

<ul class="org-ul">
<li>Disk: Physical Disk Device</li>
<li>Iscsi: isCSI Target</li>
<li>logical:LVM Volume Group</li>
</ul>
</div>
</div>
<div id="outline-container-h:40850f61-e207-4964-b80e-6851063fe8be" class="outline-3">
<h3 id="h:40850f61-e207-4964-b80e-6851063fe8be">虚拟磁盘类型</h3>
<div class="outline-text-3" id="text-h:40850f61-e207-4964-b80e-6851063fe8be">
<ul class="org-ul">
<li><p>
固定Fixed
</p>

<p>
在配置时，指定磁盘大小
</p>

<p>
不管在虚拟磁盘上实际存储多少数据，都将占用相同大小宿主机的磁盘空间
</p></li>

<li><p>
动态Dynamic
</p>

<p>
初始空间占用小
</p>

<p>
随着空间的使用逐渐增长到最大容量，但是只根据需求使用更多的空间
</p></li>

<li><p>
差异Differencing
</p>

<p>
因为创建是差异磁盘，所以只保存变更的数据
</p>

<p>
例如，将操作系统安装在父盘，然后创建差异化磁盘来执行进一步配置
</p></li>
</ul>
</div>
</div>
<div id="outline-container-h:3fb57b9f-7fc0-4e82-9cdd-90bc7100492c" class="outline-3">
<h3 id="h:3fb57b9f-7fc0-4e82-9cdd-90bc7100492c">虚拟镜像文件格式</h3>
<div class="outline-text-3" id="text-h:3fb57b9f-7fc0-4e82-9cdd-90bc7100492c">
<p>
镜像文件储存在主机文件系统中。它可以储存在本地文件系统中，如 ext4 或
xfs；或网络文件系统中，如 NFS 。例如 libguestfs
这样的工具，能管理、备份及监控文件。KVM 上的磁盘镜像格式包括：
</p>

<ul class="org-ul">
<li>raw</li>
</ul>

<p>
此为默认磁盘格式,但并是一种真正的磁盘格式，而是代表虚拟机所使用的原始
镜像,它并不存储元数据，因此可作为保证虚拟机兼容性的候选方案。然而，也
正因为它不存储元数据，因此不支持某些高级特往，比如快照和压缩等格式简单，
容易转换为其他的格式。
</p>

<p>
如果主机文件系统允许，raw 文件可以是预分配（pre-allocated）或稀疏
（sparse）。稀疏文件根据需求分配主机磁盘空间，因此它是一种精简配置形式
（thin provisioning）。预分配文件的所有空间需要被预先分配，但它比稀疏
文件性能好。当对磁盘I/O 性能要求非常高，而且通常不需要通过网络传输镜像
文件时，可以使用raw文件
</p>

<p>
优点 : 性能好
</p>

<p>
缺点 : 空间占用大,功能较少,生产不推荐使用
</p>

<ul class="org-ul">
<li>cow : copy-on-write格式，昙花一现</li>

<li>qcow : QEMU早期的copy-on-write格式，过渡性方案</li>

<li><p>
qcow2 qcow2
</p>

<p>
镜像文件提供许多高级磁盘镜像特征，如快照、压缩及加密。它们可以用来代表通过模板镜像创建的虚拟机。因为只有虚拟机写入的扇区部分才会分配在镜像中，所以
qcow2 文件的网络传输效率较高。RHEL 7.0 及更新版本支持 qcow2 v3
镜像文件格式
</p>

<p>
按需进行分配磁盘空间，不管文件系统是否支持
</p>

<p>
支持快照
</p>

<p>
支持zlib的磁盘压缩
</p>

<p>
支持AES的加密
</p>

<p>
优点 : 空间节约,功能丰富
</p>

<p>
缺点 :性能较差,生产推荐使用
</p></li>

<li>vmdk( Virtual Machine Disk ): VMware环境当中默认使用的磁盘格式</li>

<li>vhd \vhdx ( Virtual Hard Disk ):微软默认采用的文件格式</li>

<li>vdi : VirtualBox 采用的文件格式</li>
</ul>

<p>
<b>查看支持格式</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">&#26597;&#30475;&#24110;&#21161;:
qemu-img --help
</pre>
</div>

<p>
范例: 查看KVM支持的磁盘格式
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#qemu-img --help|grep Support
Supported formats: blkdebug blkreplay blkverify copy-on-read file ftp ftps
gluster host_cdrom host_device http https iscsi iser luks nbd null-aio null-co
nvme qcow2 quorum raw rbd ssh throttle vhdx vmdk vpc
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2b765b23-a127-49ec-8ab4-a88d3f8c6ef0" class="outline-3">
<h3 id="h:2b765b23-a127-49ec-8ab4-a88d3f8c6ef0">使用qemu-img管理虚拟磁盘文件</h3>
<div class="outline-text-3" id="text-h:2b765b23-a127-49ec-8ab4-a88d3f8c6ef0">
</div>
<div id="outline-container-h:0f57c7a6-7701-48ec-97f6-2ad12eb34b18" class="outline-4">
<h4 id="h:0f57c7a6-7701-48ec-97f6-2ad12eb34b18">qemu-img 概述</h4>
<div class="outline-text-4" id="text-h:0f57c7a6-7701-48ec-97f6-2ad12eb34b18">
<p>
qemu-img 是一个功能强大的磁盘镜像管理工具
</p>

<p>
qemu-img 包括以下子命令
</p>

<div class="org-src-container">
<pre class="src src-sh">check       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26816;&#26597;&#23436;&#25972;&#24615;</span>
create      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#38236;&#20687;</span>
commit   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#20132;&#26356;&#25913;</span>
compare  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27604;&#36739;</span>
convert    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36716;&#25442;</span>
info          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33719;&#24471;&#20449;&#24687;</span>
map         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26144;&#23556;</span>
snapshot <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24555;&#29031;&#31649;&#29702;</span>
rebase     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#24050;&#26377;&#30340;&#38236;&#20687;&#30340;&#22522;&#30784;&#19978;&#21019;&#24314;&#26032;&#30340;&#38236;&#20687;</span>
resize      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35843;&#25972;&#22823;&#23567;</span>
amend    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#35746;&#38236;&#20687;&#26684;&#24335;&#36873;&#39033;</span>
</pre>
</div>

<p>
qemu-img &#x2013;help
</p>
</div>
</div>
<div id="outline-container-h:21653ec0-5afa-4b9d-8b7f-fec903f1e7a6" class="outline-4">
<h4 id="h:21653ec0-5afa-4b9d-8b7f-fec903f1e7a6">创建虚拟磁盘文件</h4>
<div class="outline-text-4" id="text-h:21653ec0-5afa-4b9d-8b7f-fec903f1e7a6">
<div class="org-src-container">
<pre class="src src-sh">create [-q] [--object objectdef] [-f fmt] [-b backing_file] [-F backing_fmt] [-u] [-o options] filename [size]
</pre>
</div>
</div>
<div id="outline-container-h:9273245b-ccf6-4a43-ad11-bf7af548f345" class="outline-5">
<h5 id="h:9273245b-ccf6-4a43-ad11-bf7af548f345">创建默认配置的磁盘</h5>
<div class="outline-text-5" id="text-h:9273245b-ccf6-4a43-ad11-bf7af548f345">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#20026;raw&#26684;&#24335;&#31232;&#30095;&#25991;&#20214;</span>
[root@centos8 ~]#qemu-img create vm1.img 1g
Formatting <span style="color: #8b2252;">'vm1.img'</span>, <span style="color: #a0522d;">fmt</span>=raw <span style="color: #a0522d;">size</span>=1073741824
[root@centos8 ~]#file vm1.img
vm1.img: data

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#25991;&#20214;&#22823;&#23567;</span>
[root@centos8 ~]#ll -h vm1.img
-rw-r--r-- 1 root root 1.0G Sep 20 12:17 vm1.img

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23454;&#38469;&#25991;&#20214;&#21482;&#21344;4k&#31354;&#38388;</span>
[root@centos8 ~]#du -h vm1.img
4.0K vm1.img

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26174;&#31034;&#25991;&#20214;&#20449;&#24687;</span>
[root@centos8 ~]#qemu-img info vm1.img
image: vm1.img
file format: raw
virtual size: 1.0G (1073741824 bytes)
disk size: 4.0K
</pre>
</div>
</div>
</div>
<div id="outline-container-h:770109ae-4f84-48ec-834e-719b93bc4c1d" class="outline-5">
<h5 id="h:770109ae-4f84-48ec-834e-719b93bc4c1d">查看不同磁盘文件格式支持选项</h5>
<div class="outline-text-5" id="text-h:770109ae-4f84-48ec-834e-719b93bc4c1d">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#qemu-img create -f raw -o ?
Supported options:
size                         Virtual disk size

[root@centos8 ~]#qemu-img create -f qcow2 -o ?
Supported options:
size                         Virtual disk size
compat                     Compatibility level (0.10 or 1.1)
backing_file         File name of a base image
backing_fmt         Image format of the base image
encryption             Encrypt the image with format <span style="color: #8b2252;">'aes'</span>. (Deprecated<span style="color: #a020f0;"> in</span> favor of
encrypt.format=aes)
encrypt.format     Encrypt the image, format choices: <span style="color: #8b2252;">'aes'</span>, <span style="color: #8b2252;">'luks'</span>
encrypt.key-secret ID of secret providing qcow AES key or LUKS passphrase
encrypt.cipher-alg Name of encryption cipher algorithm
encrypt.cipher-mode Name of encryption cipher mode
encrypt.ivgen-alg Name of IV generator algorithm
encrypt.ivgen-hash-alg Name of IV generator hash algorithm
encrypt.hash-alg Name of encryption hash algorithm
encrypt.iter-time Time to spend<span style="color: #a020f0;"> in</span> PBKDF<span style="color: #a020f0;"> in</span> milliseconds
cluster_size         qcow2 cluster size
preallocation     Preallocation mode (allowed values: off, metadata, falloc,
full)
lazy_refcounts     Postpone refcount updates
refcount_bits     Width of a reference count entry<span style="color: #a020f0;"> in</span> bits
</pre>
</div>
</div>
</div>
<div id="outline-container-h:58e190c3-6658-4055-8d6a-a55594319f3d" class="outline-5">
<h5 id="h:58e190c3-6658-4055-8d6a-a55594319f3d">qcow2 格式选项</h5>
<div class="outline-text-5" id="text-h:58e190c3-6658-4055-8d6a-a55594319f3d">
<div class="org-src-container">
<pre class="src src-sh">backing_file <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#21518;&#31471;&#38236;&#20687;&#25991;&#20214;&#12290;</span>
backing_fmt <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#21518;&#31471;&#38236;&#20687;&#30340;&#38236;&#20687;&#26684;&#24335;&#12290;</span>
cluster_size <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#38236;&#20687;&#20013;&#30340;&#31751;&#22823;&#23567;&#65292;&#21462;&#20540;&#22312;512&#21040;2M&#20043;&#38388;&#65292;&#40664;&#35748;&#20540;&#20026;64K&#12290;</span>
preallocation <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#38236;&#20687;&#25991;&#20214;&#31354;&#38388;&#30340;&#39044;&#20998;&#37197;&#27169;&#24335;</span>
encryption <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#20110;&#35774;&#32622;&#21152;&#23494;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:59cd6391-3ae9-46ae-b2ae-6f5141a1ca6d" class="outline-5">
<h5 id="h:59cd6391-3ae9-46ae-b2ae-6f5141a1ca6d">创建raw格式非稀疏文件</h5>
<div class="outline-text-5" id="text-h:59cd6391-3ae9-46ae-b2ae-6f5141a1ca6d">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=vm2.img <span style="color: #a0522d;">bs</span>=1M <span style="color: #a0522d;">count</span>=1024
1024+0 records<span style="color: #a020f0;"> in</span>
1024+0 records out
1073741824 bytes (1.1 GB, 1.0 GiB) copied, 3.20332 s, 335 MB/s

[root@centos8 ~]#qemu-img info vm2.img
image: vm2.img
file format: raw
virtual size: 1.0G (1073741824 bytes)
disk size: 1.0G
[root@centos8 ~]#ls -hl vm2.img
-rw-r--r-- 1 root root 1.0G Sep 20 12:31 vm2.img
[root@centos8 ~]#du -h vm2.img
1.0G vm2.img
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f3acf851-83fc-4605-b0ea-572e2c484996" class="outline-5">
<h5 id="h:f3acf851-83fc-4605-b0ea-572e2c484996">创建raw格式稀疏文件</h5>
<div class="outline-text-5" id="text-h:f3acf851-83fc-4605-b0ea-572e2c484996">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dd <span style="color: #a0522d;">if</span>=/dev/zero <span style="color: #a0522d;">of</span>=vm3.img <span style="color: #a0522d;">bs</span>=1M <span style="color: #a0522d;">count</span>=0 <span style="color: #a0522d;">seek</span>=1024
0+0 records<span style="color: #a020f0;"> in</span>
0+0 records out
0 bytes copied, 9.2173e-05 s, 0.0 kB/s
[root@centos8 ~]#qemu-img info vm3.img
image: vm3.img
file format: raw
virtual size: 1.0G (1073741824 bytes)
disk size: 0

[root@centos8 ~]#ll -h vm3.img
-rw-r--r-- 1 root root 1.0G Sep 20 12:34 vm3.img
[root@centos8 ~]#du -h vm3.img
0 vm3.img
</pre>
</div>
</div>
</div>
<div id="outline-container-h:07ac06bd-eeee-4955-b8d9-6f51cf1dab64" class="outline-5">
<h5 id="h:07ac06bd-eeee-4955-b8d9-6f51cf1dab64">raw文件复制的格式控制</h5>
<div class="outline-text-5" id="text-h:07ac06bd-eeee-4955-b8d9-6f51cf1dab64">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;&#38750;&#31232;&#30095;&#25991;&#20214;,&#40664;&#35748;&#20063;&#20026;&#38750;&#31232;&#30095;&#25991;&#20214;</span>
[root@centos8 ~]#cp vm2.img vm2.img.bak
[root@centos8 ~]#du -h vm2.img.bak
1.0G vm2.img.bak
[root@centos8 ~]#ll -h vm2.img.bak
-rw-r--r-- 1 root root 1.0G Sep 20 12:38 vm2.img.bak
[root@centos8 ~]#qemu-img info vm2.img.bak
image: vm2.img.bak
file format: raw
virtual size: 1.0G (1073741824 bytes)
disk size: 1.0G

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22797;&#21046;&#31232;&#30095;&#25991;&#20214;,&#40664;&#35748;&#20173;&#20026;&#31232;&#30095;&#25991;&#20214;</span>
[root@centos8 ~]#cp vm3.img vm3.img.bak
[root@centos8 ~]#ll -h vm3.img.bak
-rw-r--r-- 1 root root 1.0G Sep 20 12:36 vm3.img.bak
[root@centos8 ~]#du -h vm3.img.bak
0 vm3.img.bak
[root@centos8 ~]#qemu-img info vm3.img.bak
image: vm3.img.bak
file format: raw
virtual size: 1.0G (1073741824 bytes)
disk size: 0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#23558;&#38750;&#31232;&#30095;&#25991;&#20214;&#22797;&#21046;&#20026;&#31232;&#30095;&#26684;&#24335;&#26684;&#24335;</span>
[root@centos8 ~]#cp --sparse=always vm2.img vm2.img.bak2
[root@centos8 ~]#qemu-img info vm2.img
image: vm2.img
file format: raw
virtual size: 1.0G (1073741824 bytes)
disk size: 1.0G
[root@centos8 ~]#qemu-img info vm2.img.bak2
image: vm2.img.bak2
file format: raw
virtual size: 1.0G (1073741824 bytes)
disk size: 0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#23558;&#31232;&#30095;&#25991;&#20214;&#22797;&#21046;&#20026;&#38750;&#31232;&#30095;&#26684;&#24335;&#26684;&#24335;</span>
[root@centos8 ~]#cp --sparse=never vm3.img vm3.img.bak2
[root@centos8 ~]#qemu-img info vm3.img
image: vm3.img
file format: raw
virtual size: 1.0G (1073741824 bytes)
disk size: 0
[root@centos8 ~]#qemu-img info vm3.img.bak2
image: vm3.img.bak2
file format: raw
virtual size: 1.0G (1073741824 bytes)
disk size: 1.0G
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:36441d5d-0558-491d-851e-b3ab6ab7cc5a" class="outline-4">
<h4 id="h:36441d5d-0558-491d-851e-b3ab6ab7cc5a">检查虚拟磁盘</h4>
<div class="outline-text-4" id="text-h:36441d5d-0558-491d-851e-b3ab6ab7cc5a">
<p>
对于关机状态的虚拟机磁盘,可以检查文件错误
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
2         centos8                                             running
[root@centos8 ~]#qemu-img check /var/lib/libvirt/images/centos8.qcow2
qemu-img: Could not open <span style="color: #8b2252;">'/var/lib/libvirt/images/centos8.qcow2'</span>: Failed to get
shared <span style="color: #8b2252;">"write"</span> lock
Is another process using the image [/var/lib/libvirt/images/centos8.qcow2]?

[root@centos8 ~]#virsh suspend centos8
Domain centos8 suspended
[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
2         centos8                                             paused

[root@centos8 ~]#qemu-img check /var/lib/libvirt/images/centos8.qcow2
qemu-img: Could not open <span style="color: #8b2252;">'/var/lib/libvirt/images/centos8.qcow2'</span>: Failed to get
shared <span style="color: #8b2252;">"write"</span> lock
Is another process using the image [/var/lib/libvirt/images/centos8.qcow2]?

[root@centos8 ~]#qemu-img check /var/lib/libvirt/images/centos7.qcow2
No errors were found on the image.
25572/327680 = 7.80% allocated, 1.44% fragmented, 0.00% compressed clusters
Image end offset: 1676869632
</pre>
</div>
</div>
</div>
<div id="outline-container-h:5342b435-789f-4d24-8281-66864cf493c5" class="outline-4">
<h4 id="h:5342b435-789f-4d24-8281-66864cf493c5">磁盘预分配策略</h4>
<div class="outline-text-4" id="text-h:5342b435-789f-4d24-8281-66864cf493c5">
<p>
raw 文件的预分配策略和文件系统是否支持有关,而qcow2则无关
</p>

<p>
预分配策略
</p>

<ul class="org-ul">
<li><p>
off
</p>

<p>
此为缺省策略，即不使用预分配策略,预分配后的虚拟磁盘占用空间很小,不属于稀疏映像类型,生成的磁盘文件很小
</p></li>

<li><p>
metadata
</p>

<p>
只预分配元数据(metadata)，预分配后的磁盘文件属于稀疏映像类型,相当于vmware中的磁盘置备选项:
Thin Provision(精简配置)
</p></li>

<li><p>
falloc
</p>

<p>
分配文件的块并标识它们的状态为未初始化，即只分配空间,但不置零.
预分配后的虚拟磁盘属于非稀疏映像类型,相对full模式来说，创建虚拟磁盘的速度要快很多,相当于vmware中的磁盘置备选项:厚置备延迟置零
</p></li>

<li><p>
full
</p>

<p>
分配所有磁盘空间并置零，预分配后的虚拟磁盘属于非稀疏映像类型,创建最慢,相当于vmware中的磁盘置备选项:
厚置备置零
</p></li>
</ul>

<p>
范例: 创建预分配置策略
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#qemu-img create -f qcow2 test1.qcow2 1g
Formatting <span style="color: #8b2252;">'test1.qcow2'</span>, <span style="color: #a0522d;">fmt</span>=qcow2 <span style="color: #a0522d;">size</span>=1073741824 <span style="color: #a0522d;">cluster_size</span>=65536
<span style="color: #a0522d;">lazy_refcounts</span>=off <span style="color: #a0522d;">refcount_bits</span>=16

[root@centos8 ~]#qemu-img info test1.qcow2
image: test1.qcow2
file format: qcow2
virtual size: 1.0G (1073741824 bytes)
disk size: 196K
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: false
    refcount bits: 16
    corrupt: false

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#20851;&#38381;&#39044;&#20998;&#37197;</span>
[root@centos8 ~]#qemu-img create -f qcow2 test2.qcow2 1g -o <span style="color: #a0522d;">preallocation</span>=off
Formatting <span style="color: #8b2252;">'test2.qcow2'</span>, <span style="color: #a0522d;">fmt</span>=qcow2 <span style="color: #a0522d;">size</span>=1073741824 <span style="color: #a0522d;">cluster_size</span>=65536
<span style="color: #a0522d;">preallocation</span>=off <span style="color: #a0522d;">lazy_refcounts</span>=off <span style="color: #a0522d;">refcount_bits</span>=16
[root@centos8 ~]#qemu-img info test2.qcow2
image: test2.qcow2
file format: qcow2
virtual size: 1.0G (1073741824 bytes)
disk size: 196K
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: false
    refcount bits: 16
    corrupt: false


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#39044;&#20998;&#37197;metadata</span>
[root@centos8 ~]#qemu-img create -f qcow2 test3.qcow2 1g -o <span style="color: #a0522d;">preallocation</span>=metadata
Formatting <span style="color: #8b2252;">'test3.qcow2'</span>, <span style="color: #a0522d;">fmt</span>=qcow2 <span style="color: #a0522d;">size</span>=1073741824 <span style="color: #a0522d;">cluster_size</span>=65536
<span style="color: #a0522d;">preallocation</span>=metadata <span style="color: #a0522d;">lazy_refcounts</span>=off <span style="color: #a0522d;">refcount_bits</span>=16

[root@centos8 ~]#qemu-img info test3.qcow2
image: test3.qcow2
file format: qcow2
virtual size: 1.0G (1073741824 bytes)
disk size: 836K
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: false
    refcount bits: 16
    corrupt: false

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#39044;&#20998;&#37197;falloc</span>
[root@centos8 ~]#qemu-img create -f qcow2 test4.qcow2 1g -o <span style="color: #a0522d;">preallocation</span>=falloc
Formatting <span style="color: #8b2252;">'test4.qcow2'</span>, <span style="color: #a0522d;">fmt</span>=qcow2 <span style="color: #a0522d;">size</span>=1073741824 <span style="color: #a0522d;">cluster_size</span>=65536
<span style="color: #a0522d;">preallocation</span>=falloc <span style="color: #a0522d;">lazy_refcounts</span>=off <span style="color: #a0522d;">refcount_bits</span>=16
[root@centos8 ~]#qemu-img info test4.qcow2
image: test4.qcow2
file format: qcow2
virtual size: 1.0G (1073741824 bytes)
disk size: 1.0G  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21344;&#29992;1g</span>
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: false
    refcount bits: 16
    corrupt: false

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#39044;&#20998;&#37197;full</span>
[root@centos8 ~]#qemu-img create -f qcow2 test5.qcow2 1g -o <span style="color: #a0522d;">preallocation</span>=full
Formatting <span style="color: #8b2252;">'test5.qcow2'</span>, <span style="color: #a0522d;">fmt</span>=qcow2 <span style="color: #a0522d;">size</span>=1073741824 <span style="color: #a0522d;">cluster_size</span>=65536
<span style="color: #a0522d;">preallocation</span>=full <span style="color: #a0522d;">lazy_refcounts</span>=off <span style="color: #a0522d;">refcount_bits</span>=16
[root@centos8 ~]#qemu-img info test5.qcow2
image: test5.qcow2
file format: qcow2
virtual size: 1.0G (1073741824 bytes)
disk size: 1.0G
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: false
    refcount bits: 16
    corrupt: false

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25991;&#20214;&#31995;&#32479;&#26174;&#31034;&#22823;&#23567;</span>
[root@centos8 ~]#ll -h test*.qcow2
-rw-r--r-- 1 root root 193K Sep 20 13:31 test1.qcow2
-rw-r--r-- 1 root root 193K Sep 20 13:32 test2.qcow2
-rw-r--r-- 1 root root 1.1G Sep 20 13:35 test3.qcow2
-rw-r--r-- 1 root root 1.1G Sep 20 13:36 test4.qcow2
-rw-r--r-- 1 root root 1.1G Sep 20 13:37 test5.qcow2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#30495;&#23454;&#22823;&#23567;</span>
[root@centos8 ~]#du -h test*.qcow2
196K test1.qcow2
196K test2.qcow2
836K test3.qcow2
1.1G test4.qcow2
1.1G test5.qcow2
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d085fcf6-5c34-46ca-a4ef-89a9b91131bc" class="outline-4">
<h4 id="h:d085fcf6-5c34-46ca-a4ef-89a9b91131bc">后备差异虚拟磁盘</h4>
<div class="outline-text-4" id="text-h:d085fcf6-5c34-46ca-a4ef-89a9b91131bc">
</div>
<div id="outline-container-h:6fc20f16-cf29-4202-92a5-8b148e1d5b03" class="outline-5">
<h5 id="h:6fc20f16-cf29-4202-92a5-8b148e1d5b03">后备差异虚拟磁盘介绍</h5>
<div class="outline-text-5" id="text-h:6fc20f16-cf29-4202-92a5-8b148e1d5b03">

<figure id="org4e2c007">
<img src="images/image-20210223142433674.png" alt="image-20210223142433674.png">

</figure>

<p>
有很多虚拟机中磁盘的内容有很多相同的部分,可以使用后备差异虚拟磁盘节约磁盘的占用
</p>

<p>
先创建一个镜像磁盘,并在磁盘中安装相同的应用配置,用此磁盘文件做为为模版,在此基础上建立多个后备差异虚拟磁盘文件,再分别分配给需求不同的虚拟机使用,后备差异虚拟磁盘相当于Vmware中的链接克隆
</p>

<p>
<b>后备差异虚拟磁盘特点</b>
</p>

<ul class="org-ul">
<li>存储与基础镜像（父）磁盘的变化</li>
<li>基础镜像（父）磁盘不会改变</li>
<li>差异磁盘隔离变化</li>
<li>多个差异磁盘可以使用相同的基础镜像（父）磁盘</li>
</ul>

<p>
优点: 标准化基础镜像，节省空间
</p>

<p>
缺点: 增加了开销，较差的性能
</p>
</div>
</div>
<div id="outline-container-h:a622a71a-4ce9-4465-aa18-5859853871c6" class="outline-5">
<h5 id="h:a622a71a-4ce9-4465-aa18-5859853871c6">创建后备差异虚拟磁盘并用virt-install启动虚拟机</h5>
<div class="outline-text-5" id="text-h:a622a71a-4ce9-4465-aa18-5859853871c6">
<p>
创建后备差异虚拟磁盘命令
</p>

<div class="org-src-container">
<pre class="src src-sh">qemu-img create -f qcow2     -o <span style="color: #a0522d;">backing_file</span>=base.qcow2(&#25110;&#32773;raw)     diff.qcow2
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;:&#27169;&#29256;&#38236;&#20687;&#25991;&#20214;&#21487;&#20197;&#26159;raw&#25110;qcow2,&#20294;&#26159;&#21518;&#22791;&#24046;&#24322;&#30913;&#30424;&#25991;&#20214;&#24517;&#39035;&#26159;qcow2&#26684;&#24335;</span>
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#21518;&#22791;&#24046;&#24322;&#34394;&#25311;&#30913;&#30424;</span>
[root@centos8 images]#pwd
/var/lib/libvirt/images
[root@centos8 images]# qemu-img create -f qcow2 -o <span style="color: #a0522d;">backing_file</span>=centos8.qcow2 centos8-test1.qcow2
Formatting <span style="color: #8b2252;">'centos8-test1.qcow2'</span>, <span style="color: #a0522d;">fmt</span>=qcow2 <span style="color: #a0522d;">size</span>=21474836480
<span style="color: #a0522d;">backing_file</span>=centos8.qcow2 <span style="color: #a0522d;">cluster_size</span>=65536 <span style="color: #a0522d;">lazy_refcounts</span>=off
<span style="color: #a0522d;">refcount_bits</span>=16

[root@centos8 images]#qemu-img info centos8-test1.qcow2
image: centos8-test1.qcow2
file format: qcow2
virtual size: 20G (21474836480 bytes)
disk size: 196K
cluster_size: 65536
backing file: centos8.qcow2
Format specific information:
    compat: 1.1
    lazy refcounts: false
    refcount bits: 16
    corrupt: false

[root@centos8 images]#qemu-img info centos8.qcow2
image: centos8.qcow2
file format: qcow2
virtual size: 20G (21474836480 bytes)
disk size: 20G
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: true
    refcount bits: 16
    corrupt: false

[root@centos8 images]#ll -h centos8*
-rw------- 1 qemu qemu 21G Sep 20 13:10 centos8.qcow2
-rw-r--r-- 1 qemu qemu 193K Sep 20 14:08 centos8-test1.qcow2
[root@centos8 ~]#virsh list --all
Id     Name                                                     State
----------------------------------------------------
-         centos7                                             shut off
-         centos8                                             shut off

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110;&#24050;&#23433;&#35013;&#31995;&#32479;&#30340;&#30913;&#30424;&#25991;&#20214;&#30452;&#25509;&#21551;&#21160;&#34394;&#25311;&#26426;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#27169;&#29256;&#38236;&#20687;&#30913;&#30424;&#23545;&#24212;&#30340;&#34394;&#25311;&#26426;&#38656;&#35201;&#26159;&#20851;&#26426;&#29366;&#24577;&#25165;&#21487;&#20197;&#21019;&#24314;&#26032;&#30340;&#34394;&#25311;&#26426;</span>
[root@centos8 images]#virt-install --import --name=centos8-test1 --vcpus=1 --ram=2048 --disk <span style="color: #a0522d;">path</span>=/var/lib/libvirt/images/centos8-test1.qcow2 --network <span style="color: #a0522d;">network</span>=default --graphics vnc,<span style="color: #a0522d;">listen</span>=0.0.0.0 --os-type=linux --os-variant=centos8
WARNING Graphics requested but DISPLAY is not set. Not running virt-viewer.
WARNING No console to launch for the guest, defaulting to --wait -1
Starting install...
Domain installation still<span style="color: #a020f0;"> in</span> progress.
Waiting for installation to complete.

[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
5         centos8-test1                                 running
[root@centos8 images]#ll -h centos8*
-rw------- 1 qemu qemu 21G Sep 20 13:10 centos8.qcow2
-rw-r--r-- 1 qemu qemu 32M Sep 20 14:06 centos8-test1.qcow2
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f0f62e28-fc2a-4def-9e8a-833a22c1e51d" class="outline-5">
<h5 id="h:f0f62e28-fc2a-4def-9e8a-833a22c1e51d">创建后备差异虚拟磁盘并用virt-manager启动虚拟机</h5>
<div class="outline-text-5" id="text-h:f0f62e28-fc2a-4def-9e8a-833a22c1e51d">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 images]#pwd
/var/lib/libvirt/images
[root@centos8 images]# qemu-img create -f qcow2 -o <span style="color: #a0522d;">backing_file</span>=centos8.qcow2 centos8-test2.qcow2
Formatting <span style="color: #8b2252;">'centos8-test2.qcow2'</span>, <span style="color: #a0522d;">fmt</span>=qcow2 <span style="color: #a0522d;">size</span>=21474836480
<span style="color: #a0522d;">backing_file</span>=centos8.qcow2 <span style="color: #a0522d;">cluster_size</span>=65536 <span style="color: #a0522d;">lazy_refcounts</span>=off
<span style="color: #a0522d;">refcount_bits</span>=16
[root@centos8 images]#qemu-img info centos8-test2.qcow2
image: centos8-test2.qcow2
file format: qcow2
virtual size: 20G (21474836480 bytes)
disk size: 196K
cluster_size: 65536
backing file: centos8.qcow2
Format specific information:
    compat: 1.1
    lazy refcounts: false
    refcount bits: 16
    corrupt: false

[root@centos8 images]#ll centos8-test2.qcow2 -h
-rw-r--r-- 1 root root 193K Sep 20 15:33 centos8-test2.qcow2
[root@centos8 images]#virt-manager
</pre>
</div>


<figure id="orgdcb0da4">
<img src="images/image-20210223142454784.png" alt="image-20210223142454784.png">

</figure>


<figure id="orgefaa29e">
<img src="images/image-20210223142506733.png" alt="image-20210223142506733.png">

</figure>


<figure id="org1660d7c">
<img src="images/image-20210223142516151.png" alt="image-20210223142516151.png">

</figure>


<figure id="orgaf1d610">
<img src="images/image-20210223142523992.png" alt="image-20210223142523992.png">

</figure>


<figure id="org995c523">
<img src="images/image-20210223142532322.png" alt="image-20210223142532322.png">

</figure>


<figure id="org2a64370">
<img src="images/image-20210223142540356.png" alt="image-20210223142540356.png">

</figure>


<figure id="org7a98093">
<img src="images/image-20210223142547505.png" alt="image-20210223142547505.png">

</figure>
</div>
</div>
<div id="outline-container-h:e1e724fd-04f3-4dc7-8621-57d008963fd6" class="outline-5">
<h5 id="h:e1e724fd-04f3-4dc7-8621-57d008963fd6">后备差异虚拟磁盘依赖关系</h5>
<div class="outline-text-5" id="text-h:e1e724fd-04f3-4dc7-8621-57d008963fd6">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 images]#virsh list
Id     Name                                                     State
----------------------------------------------------
[root@centos8 images]#mv centos8.qcow2 centos8.qcow2.bak

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#27809;&#26377;&#22522;&#30784;&#38236;&#20687;&#25991;&#20214;,&#23558;&#26080;&#27861;&#21551;&#21160;&#20351;&#29992;&#21518;&#22791;&#24046;&#24322;&#34394;&#25311;&#30913;&#30424;&#30340;&#34394;&#25311;&#26426;</span>
[root@centos8 images]#virsh start centos8-test1
error: Failed to start domain centos8-test1
error: Cannot access backing file <span style="color: #8b2252;">'/var/lib/libvirt/images/centos8.qcow2'</span> of
storage file <span style="color: #8b2252;">'/var/lib/libvirt/images/centos8-test1.qcow2'</span> (as uid:107,
gid:107): No such file or directory

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24674;&#22797;&#22522;&#30784;&#38236;&#20687;&#25991;&#20214;,&#20877;&#27425;&#21551;&#21160;&#34394;&#25311;&#26426;&#25104;&#21151;</span>
[root@centos8 images]#mv centos8.qcow2.bak centos8.qcow2
[root@centos8 images]#virsh start centos8-test1
Domain centos8-test1 started
[root@centos8 images]#virsh list
Id     Name                                                     State
----------------------------------------------------
10     centos8-test1                                 running
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:a3049c6b-f5eb-48bb-bfa2-19950364289a" class="outline-4">
<h4 id="h:a3049c6b-f5eb-48bb-bfa2-19950364289a">虚拟磁盘格式转换</h4>
<div class="outline-text-4" id="text-h:a3049c6b-f5eb-48bb-bfa2-19950364289a">
<p>
qemu-img 可以将不同格式的虚拟磁盘文件进行格式转化
</p>

<p>
<b>语法格式</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">qemu-img convert [--object objectdef] [--image-opts] [--target-image-opts] [-U] [-C] [-c] [-p] [-q] [-n] [-f fmt] [-t cache] [-T src_cache] [-O output_fmt] [-B backing_file] [-o options] [-s snapshot_id_or_name] [-l snapshot_param] [-S sparse_size] [-m num_coroutines] [-W] filename [filename2 [...]] output_filename
</pre>
</div>

<p>
<b>范例: 将vmdk转化为raw 和qcow2格式</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#qemu-img info CentOS8.2.vmdk
image: CentOS8.2.vmdk
file format: vmdk
virtual size: 200G (214748364800 bytes)
disk size: 1.6G
cluster_size: 65536
Format specific information:
    cid: 2898578192
    parent cid: 4294967295
    create type: monolithicSparse
    extents:
            [0]:
                    virtual size: 214748364800
                    filename: CentOS8.2.vmdk
                    cluster size: 65536
                    format:

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#36716;&#21270;&#20026;raw&#26684;&#24335;</span>
[root@centos8 ~]#qemu-img convert CentOS8.2.vmdk CentOS8.2.img

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27604;&#36739;&#22823;&#23567;</span>
[root@centos8 ~]#ll -h CentOS8.2.vmdk CentOS8.2.img
-rw-r--r-- 1 root root 1.6G Sep 20 16:00 CentOS8.2.vmdk
-rw-r--r-- 1 root root 200G Sep 20 16:10 CentOS8.2.img

[root@centos8 ~]#du -h CentOS8.2.vmdk CentOS8.2.img
1.6G CentOS8.2.vmdk
1.5G CentOS8.2.img
[root@centos8 ~]#qemu-img info CentOS8.2.img
image: CentOS8.2.img
file format: raw
virtual size: 200G (214748364800 bytes)
disk size: 1.4G

[root@centos8 ~]#mv CentOS8.2.img /var/lib/libvirt/images/

[root@centos8 ~]#virt-install --import --name=centos8-test2 --vcpus=1 --ram=2048 --disk <span style="color: #a0522d;">bus</span>=scsi,<span style="color: #a0522d;">path</span>=/var/lib/libvirt/images/CentOS8.2.img --network <span style="color: #a0522d;">network</span>=default --graphics vnc,<span style="color: #a0522d;">listen</span>=0.0.0.0 --os-type=linux --os-variant=centos8 --noautoconsole --boot hd

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36716;&#21270;&#20026;qcow2&#26684;&#24335;</span>
[root@centos8 ~]#qemu-img convert -f vmdk -O qcow2 CentOS8.2.vmdk CentOS8.2.qcow2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27604;&#36739;&#22823;&#23567;</span>
[root@centos8 ~]#ll -h CentOS8.2.vmdk CentOS8.2.qcow2
-rw-r--r-- 1 root root 1.6G Sep 20 16:00 CentOS8.2.vmdk
-rw-r--r-- 1 root root 1.6G Sep 20 16:12 CentOS8.2.qcow2
[root@centos8 ~]#du -h CentOS8.2.vmdk CentOS8.2.qcow2
1.6G CentOS8.2.vmdk
1.6G CentOS8.2.qcow2

[root@centos8 ~]#qemu-img info CentOS8.2.qcow2
image: CentOS8.2.qcow2
file format: qcow2
virtual size: 200G (214748364800 bytes)
disk size: 1.5G
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: false
    refcount bits: 16
    corrupt: false

[root@centos8 ~]#mv CentOS8.2.qcow2 /var/lib/libvirt/images/
[root@centos8 ~]#virt-install --import --name=centos8-test3 --vcpus=1 --ram=2048 --disk <span style="color: #a0522d;">bus</span>=scsi,<span style="color: #a0522d;">path</span>=/var/lib/libvirt/images/CentOS8.2.qcow2 --network <span style="color: #a0522d;">network</span>=default --graphics vnc,<span style="color: #a0522d;">listen</span>=0.0.0.0 --os-type=linux --os-variant=centos8 --noautoconsole --boot hd
</pre>
</div>
</div>
</div>
<div id="outline-container-h:83cf5dc9-2e4a-4b37-8472-012fa4ce02c1" class="outline-4">
<h4 id="h:83cf5dc9-2e4a-4b37-8472-012fa4ce02c1">调整虚拟磁盘大小</h4>
<div class="outline-text-4" id="text-h:83cf5dc9-2e4a-4b37-8472-012fa4ce02c1">
<p>
虚拟磁盘文件创建后,还可以调整虚拟磁盘大小 语法格式
</p>

<div class="org-src-container">
<pre class="src src-sh">qemu-img resize [--shrink] filename [+l -]size
</pre>
</div>

<ul class="org-ul">
<li>操作之前，一定要做好数据备份</li>
<li>增加文件大小后，需要在客户机中使用fdisk、parted等分区工具进行相应的操作才能真正让客户机使用到增加后的镜像空间。</li>
<li>缩小镜像之前，要在客户机中保证里面的文件系统有空余空间，否则会数据丢失。另外xfs文件系统不支持缩减</li>
<li>qcow2不支持缩小镜像的操作</li>
</ul>

<p>
范例: 扩展虚拟磁盘
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#qemu-img info /var/lib/libvirt/images/centos8.qcow2
image: /var/lib/libvirt/images/centos8.qcow2
file format: qcow2
virtual size: 20G (21474836480 bytes)
disk size: 20G
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: true
    refcount bits: 16
    corrupt: false

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22686;&#21152;10G&#31354;&#38388;</span>
[root@centos8 ~]#qemu-img resize /var/lib/libvirt/images/centos8.qcow2 +10G
Image resized.

[root@centos8 ~]#qemu-img info /var/lib/libvirt/images/centos8.qcow2
image: /var/lib/libvirt/images/centos8.qcow2
file format: qcow2
virtual size: 30G (32212254720 bytes)
disk size: 20G
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: true
    refcount bits: 16
    corrupt: false
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#34394;&#25311;&#26426;&#21518;,&#36824;&#38656;&#35201;&#20351;&#29992;fdisk&#31561;&#24037;&#20855;&#36827;&#34892;&#31354;&#38388;&#30340;&#32487;&#32493;&#31649;&#29702;&#25165;&#33021;&#20351;&#29992;</span>
</pre>
</div>


<figure id="orged88e71">
<img src="images/image-20210223142611561.png" alt="image-20210223142611561.png">

</figure>

<p>
范例: 缩减虚拟磁盘
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 images]#qemu-img info centos7.qcow2
image: centos7.qcow2
file format: qcow2
virtual size: 20G (21474836480 bytes)
disk size: 1.6G
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: false
    refcount bits: 16
    corrupt: false

[root@centos8 images]#qemu-img resize --shrink /var/lib/libvirt/images/centos7.qcow2 -2G
Image resized.
[root@centos8 images]#qemu-img info centos7.qcow2
image: centos7.qcow2
file format: qcow2
virtual size: 18G (19327352832 bytes)
disk size: 1.6G
cluster_size: 65536
Format specific information:
    compat: 1.1
    lazy refcounts: false
    refcount bits: 16
    corrupt: false   
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:a6d5bcf0-622d-411e-b969-d36c7f857151" class="outline-3">
<h3 id="h:a6d5bcf0-622d-411e-b969-d36c7f857151">磁盘快照管理</h3>
<div class="outline-text-3" id="text-h:a6d5bcf0-622d-411e-b969-d36c7f857151">
</div>
<div id="outline-container-h:088b2715-f200-4aa9-9beb-b795cc4f93d3" class="outline-4">
<h4 id="h:088b2715-f200-4aa9-9beb-b795cc4f93d3">快照Snapshot介绍</h4>
<div class="outline-text-4" id="text-h:088b2715-f200-4aa9-9beb-b795cc4f93d3">
</div>
<div id="outline-container-h:17d430d8-8cfa-49c7-84bb-036a974ff3d1" class="outline-5">
<h5 id="h:17d430d8-8cfa-49c7-84bb-036a974ff3d1">快照分类</h5>
<div class="outline-text-5" id="text-h:17d430d8-8cfa-49c7-84bb-036a974ff3d1">
<ul class="org-ul">
<li><p>
磁盘快照
</p>

<p>
对磁盘数据进行快照
</p>

<p>
主要用于虚拟机备份等场合
</p></li>

<li><p>
内存快照
</p>

<p>
对虚拟机的内存/设备信息进行保存
</p>

<p>
该机制同时用于休眠恢复，迁移等场景
</p>

<p>
主要使用virsh save ( qemu migrate to file）实现，只能对运行的虚拟机进行
</p></li>

<li><p>
检查点Checkpoint快照
</p>

<p>
同时保存虚拟机的磁盘快照和内存快照
</p>

<p>
用于将虚拟机恢复到某个时间点
</p>

<p>
可以保证数据的一致性
</p></li>
</ul>
</div>
</div>
<div id="outline-container-h:0bf55b4d-e16b-4ffc-9a98-8c51983dba99" class="outline-5">
<h5 id="h:0bf55b4d-e16b-4ffc-9a98-8c51983dba99">磁盘快照分类</h5>
<div class="outline-text-5" id="text-h:0bf55b4d-e16b-4ffc-9a98-8c51983dba99">
<ul class="org-ul">
<li><p>
按快照信息保存分为:
</p>

<p>
内置快照∶快照数据和base磁盘数据放在同一个qcow2文件中
</p>

<p>
外置快照︰快照数据单独的另一个qcow2文件存放
</p></li>

<li><p>
按虚拟机状态可以分为:
</p>

<p>
关机态快照︰数据可以保证一致性
</p>

<p>
运行态快照∶数据无法保证一致性，类似与系统crash后的磁盘数据。使用是可能需要fsck等操作。
</p></li>

<li><p>
按磁盘数量可以分为:
</p>

<p>
单盘:单盘快照不涉及原子性
</p>

<p>
多盘:涉及原子性。主要分两个方面:1.是所有盘快照点相同2.所有盘要么都快照成功，要么都快照
失败。主要依赖于qemu的transaction实现
</p></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:db4556d4-62ce-4467-959e-5480b63a39d7" class="outline-4">
<h4 id="h:db4556d4-62ce-4467-959e-5480b63a39d7">qemu-img 管理磁盘快照</h4>
<div class="outline-text-4" id="text-h:db4556d4-62ce-4467-959e-5480b63a39d7">
<p>
命令格式
</p>

<div class="org-src-container">
<pre class="src src-sh">qemu-img snapshot [--object objectdef] [--image-opts] [-U] [-q] [-l | -a snapshot | -c snapshot | -d snapshot] filename

Parameters to snapshot subcommand:
  <span style="color: #8b2252;">'snapshot'</span> is the name of the snapshot to create, apply or delete
  <span style="color: #8b2252;">'-a'</span> applies a snapshot (revert disk to saved state)
  <span style="color: #8b2252;">'-c'</span> creates a snapshot
  <span style="color: #8b2252;">'-d'</span> deletes a snapshot
  <span style="color: #8b2252;">'-l'</span> lists all snapshots<span style="color: #a020f0;"> in</span> the given image
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#22359;&#35774;&#22791;</span>
[root@centos8 ~]#virsh domblklist centos7
Target         Source
------------------------------------------------
hda             /var/lib/libvirt/images/centos7.qcow2
hdb                 -

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24555;&#29031;,&#22914;&#26524;&#27809;&#26377;&#24555;&#29031;,&#21017;&#26080;&#26174;&#31034;&#20449;&#24687;</span>
[root@centos8 ~]#qemu-img snapshot -l /var/lib/libvirt/images/centos7.qcow2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#24555;&#29031;</span>
[root@centos8 ~]#qemu-img snapshot -c centos7-s1 /var/lib/libvirt/images/centos7.qcow2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24555;&#29031;</span>
[root@centos8 ~]#qemu-img snapshot -l /var/lib/libvirt/images/centos7.qcow2
Snapshot list:
ID             TAG                                 VM SIZE                             DATE             VM CLOCK
1                 centos7-s1                                 0 2020-09-20 17:39:59     00:00:00.000

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24555;&#29031;&#20449;&#24687;</span>
[root@centos8 ~]#qemu-img info /var/lib/libvirt/images/centos7.qcow2
image: /var/lib/libvirt/images/centos7.qcow2
file format: qcow2
virtual size: 20G (21474836480 bytes)
disk size: 1.6G
cluster_size: 65536
Snapshot list:
ID             TAG                                 VM SIZE                             DATE             VM CLOCK
1                 centos7-s1                                 0 2020-09-20 17:39:59     00:00:00.000
Format specific information:
    compat: 1.1
    lazy refcounts: false
    refcount bits: 16
    corrupt: false

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#25991;&#20214;,&#27169;&#25311;&#30772;&#22351;</span>
</pre>
</div>


<figure id="org3eb4604">
<img src="images/image-20210223142648377.png" alt="image-20210223142648377.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#26426;&#21518;&#25165;&#33021;&#36824;&#21407;&#24555;&#29031;&#20462;&#22797;&#25925;&#38556;</span>
[root@centos8 ~]#qemu-img snapshot -a centos7-s1 /var/lib/libvirt/images/centos7.qcow2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#34394;&#25311;&#26426;</span>
virsh start centos8
</pre>
</div>

<p>
查看文件恢复
</p>


<figure id="orgb9f4304">
<img src="images/image-20210223142702966.png" alt="image-20210223142702966.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#26426;&#21518;&#25165;&#33021;&#21024;&#38500;&#24555;&#29031;</span>
[root@centos8 ~]#qemu-img snapshot -d centos7-s1
/var/lib/libvirt/images/centos7.qcow2
[root@centos8 ~]#qemu-img snapshot -l /var/lib/libvirt/images/centos7.qcow2
</pre>
</div>
</div>
</div>
<div id="outline-container-h:77fa070a-4364-415e-83c0-25b6514edbd5" class="outline-4">
<h4 id="h:77fa070a-4364-415e-83c0-25b6514edbd5">管理虚拟机快照</h4>
<div class="outline-text-4" id="text-h:77fa070a-4364-415e-83c0-25b6514edbd5">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh snapshot-list centos8
Name                                 Creation Time                         State
------------------------------------------------------------

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#34394;&#25311;&#26426;&#24555;&#29031;</span>
[root@centos8 ~]#virsh snapshot-create centos8
Domain snapshot 1600593611 created

[root@centos8 ~]#virsh snapshot-list centos8
Name                                 Creation Time                         State
------------------------------------------------------------
1600593611                     2020-09-20 17:20:11 +0800 shutoff
</pre>
</div>


<figure id="orgefbb0b8">
<img src="images/image-20210223142720332.png" alt="image-20210223142720332.png">

</figure>

<p>
<b>使用virsh 命令还原快照</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20808;&#20851;&#26426;&#21518;&#20877;&#36824;&#21407;&#24555;&#29031;</span>
[root@centos8 ~]#virsh snapshot-revert centos8 --snapshotname 1600593611 --running
[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
23     centos7                                             running
</pre>
</div>


<figure id="org65c22f1">
<img src="images/image-20210223142736850.png" alt="image-20210223142736850.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#24555;&#29031;</span>
[root@centos8 ~]#virsh snapshot-delete centos8 --snapshotname 1600593611
Domain snapshot 1600593611 deleted
[root@centos8 ~]#virsh snapshot-list centos8
Name                                 Creation Time                         State
------------------------------------------------------------
[root@centos8 ~]#
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f17bc8eb-43c4-494a-984e-bbe755e762ad" class="outline-4">
<h4 id="h:f17bc8eb-43c4-494a-984e-bbe755e762ad">virt-manager 管理快照</h4>
<div class="outline-text-4" id="text-h:f17bc8eb-43c4-494a-984e-bbe755e762ad">
<p>
虚拟机配置&#x2013;View&#x2013;Snapshot
</p>


<figure id="orgafdb707">
<img src="images/image-20210223142756026.png" alt="image-20210223142756026.png">

</figure>


<figure id="orga0827be">
<img src="images/image-20210223142807242.png" alt="image-20210223142807242.png">

</figure>


<figure id="org85f0206">
<img src="images/image-20210223142815996.png" alt="image-20210223142815996.png">

</figure>


<figure id="org5d64134">
<img src="images/image-20210223142826945.png" alt="image-20210223142826945.png">

</figure>


<figure id="org2d0c885">
<img src="images/image-20210223143211226.png" alt="image-20210223143211226.png">

</figure>


<figure id="orgb3201e7">
<img src="images/image-20210223143231778.png" alt="image-20210223143231778.png">

</figure>

<p>
还原快照
</p>


<figure id="org808332b">
<img src="images/image-20210223143247088.png" alt="image-20210223143247088.png">

</figure>


<figure id="org02d7960">
<img src="images/image-20210223143300104.png" alt="image-20210223143300104.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ll /var/lib/libvirt/qemu/snapshot/centos8/
total 8
-rw------- 1 root root 5802 Aug 11 13:28 snapshot1.xml
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:68708900-2cd3-4c45-81b2-df80eceaaa98" class="outline-3">
<h3 id="h:68708900-2cd3-4c45-81b2-df80eceaaa98">存储池管理</h3>
<div class="outline-text-3" id="text-h:68708900-2cd3-4c45-81b2-df80eceaaa98">
</div>
<div id="outline-container-h:6ab50a9e-ec15-4e9a-9962-d7e5361bda00" class="outline-4">
<h4 id="h:6ab50a9e-ec15-4e9a-9962-d7e5361bda00">存储池介绍</h4>
<div class="outline-text-4" id="text-h:6ab50a9e-ec15-4e9a-9962-d7e5361bda00">
</div>
<div id="outline-container-h:a0fed8b8-1769-46f0-adc9-55c71f7a38bd" class="outline-5">
<h5 id="h:a0fed8b8-1769-46f0-adc9-55c71f7a38bd">存储池基本概念</h5>
<div class="outline-text-5" id="text-h:a0fed8b8-1769-46f0-adc9-55c71f7a38bd">
<p>
Libvirt可以以存储池的形式对存储进行统一管理、简化操作
</p>

<p>
对于虚拟机操作，存储池和卷并不是必需的,一个存储池中可以有多个存储卷
</p>

<p>
支持以下存储池
</p>

<div class="org-src-container">
<pre class="src src-sh">dir: Filesystem Directory
disk: Physical Disk Device
fs: Pre-Formatted Block Device
gluster: Gluster FileSystem
iscsi: iSCSI Target
logical: LVM Volume Group
mpath: Multipath Device Enumerator
netfs: Network Export Directory
rbd:RADOS Block Device/Ceph
scsi: SCSI Host Adapter
sheepdog: Sheepdog Filesystem <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#24067;&#24335;&#25991;&#20214;&#31995;&#32479;</span>
</pre>
</div>

<p>
<b>virt-manager 可以创建和管理存储池</b>
</p>

<p>
菜单栏&#x2013;Edit&#x2013;Connection Details
</p>


<figure id="org4a18554">
<img src="images/image-20210223143317889.png" alt="image-20210223143317889.png">

</figure>


<figure id="org236b62e">
<img src="images/image-20210223143329922.png" alt="image-20210223143329922.png">

</figure>
</div>
</div>
<div id="outline-container-h:7ef8490a-4c6b-49df-8d78-b98c6a47247d" class="outline-5">
<h5 id="h:7ef8490a-4c6b-49df-8d78-b98c6a47247d">virsh中的存储池相关命令</h5>
<div class="outline-text-5" id="text-h:7ef8490a-4c6b-49df-8d78-b98c6a47247d">
<div class="org-src-container">
<pre class="src src-sh">find-storage-pool-sources-as       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;&#21442;&#25968;&#26597;&#25214;&#23384;&#20648;&#27744;&#28304;find potential storage poolsources</span>
find-storage-pool-sources          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;XML&#25991;&#26723;&#26597;&#25214;&#23384;&#20648;&#27744;&#28304;&#25214;&#21040;&#28508;&#22312;&#23384;&#20648;&#27744;&#28304;</span>
pool-autostart                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#21160;&#21551;&#21160;&#26576;&#20010;&#27744;</span>
pool-build                         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24314;&#31435;&#27744;</span>
pool-create-as                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#19968;&#32452;&#21464;&#37327;&#20013;&#23450;&#20041;&#27744;</span>
pool-create                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#19968;&#20010;XML&#25991;&#20214;&#20013;&#21019;&#24314;&#19968;&#20010;&#27744;</span>
pool-define-as                     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20174;&#19968;&#32452;&#21464;&#37327;&#20013;&#21019;&#24314;&#19968;&#20010;&#27744;</span>
pool-define                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#19968;&#20010;XML&#25991;&#20214;&#20013;&#23450;&#20041;&#65288;&#20294;&#19981;&#21551;&#21160;&#65289;&#19968;&#20010;&#27744;&#25110;&#20462;&#25913;&#24050;&#32463;&#26377;&#27744;</span>
pool-delete                        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#27744;</span>
pool-destroy                       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38144;&#27585;&#65288;&#20572;&#27490;&#65289;&#27744;</span>
pool-dumpxml                       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#27744;&#20449;&#24687;&#20445;&#23384;&#21040;XML&#25991;&#20214;&#20013;&#30340;</span>
pool-edit                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#23384;&#20648;&#27744;&#32534;&#36753;XML&#37197;&#32622;</span>
pool-info                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23384;&#20648;&#27744;&#20449;&#24687;</span>
pool-list                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#27744;</span>
pool-name                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25226;&#19968;&#20010;&#27744;&#21517;&#31216;&#36716;&#25442;&#20026;&#27744;UUID</span>
pool-refresh                       <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21047;&#26032;&#27744;</span>
pool-start                         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#19968;&#20010;&#65288;&#20197;&#21069;&#23450;&#20041;&#30340;&#65289;&#38750;&#27963;&#36291;&#30340;&#27744;</span>
pool-undefine                      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#28040;&#23450;&#20041;&#19968;&#20010;&#19981;&#27963;&#36291;&#30340;&#27744;</span>
pool-uuid                          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#27744;UUID&#36716;&#25442;&#20026;&#27744;&#21517;&#31216;</span>
</pre>
</div>

<p>
命令帮助
</p>

<div class="org-src-container">
<pre class="src src-sh">virsh COMMAND --help
</pre>
</div>

<p>
范例:
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh pool-list --help
NAME
    pool-list - list pools
SYNOPSIS
    pool-list [--inactive] [--all] [--transient] [--persistent] [--autostart] [-
-no-autostart] [--type &lt;string&gt;] [--details] [--uuid] [--name]
DESCRIPTION
    Returns list of pools.
OPTIONS
        --inactive             list inactive pools
        --all                     list inactive &amp; active pools
        --transient         list transient pools
        --persistent         list persistent pools
        --autostart         list pools with autostart enabled
        --no-autostart     list pools with autostart disabled
        --type &lt;string&gt; only list pool of specified type(s) (<span style="color: #a020f0;">if</span> supported)
        --details             display extended details for pools
        --uuid                     list UUID of active pools only
        --name                     list name of active pools only
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:8ae34dc9-c931-48ae-a312-fc20a5757bec" class="outline-4">
<h4 id="h:8ae34dc9-c931-48ae-a312-fc20a5757bec">显示存储池信息</h4>
<div class="outline-text-4" id="text-h:8ae34dc9-c931-48ae-a312-fc20a5757bec">
<p>
存储池相关配置文件都在下面目录存放
</p>

<div class="org-src-container">
<pre class="src src-sh">/etc/libvirt/storage/
</pre>
</div>

<p>
范例: 显示存储池
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh pool-list
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
[root@centos8 ~]#virsh pool-list --uuid
b164fec8-1861-4f07-86ae-5023ea17f925
a707038c-c21b-4570-bdef-d94c00554daa

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;&#23384;&#20648;&#27744;&#30340;&#21517;&#31216;&#26597;&#25214;UUID</span>
[root@centos8 ~]#virsh pool-uuid default
b164fec8-1861-4f07-86ae-5023ea17f925

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;UUID&#26597;&#25214;&#23384;&#20648;&#27744;&#30340;&#21517;&#31216;</span>
[root@centos8 ~]#virsh pool-name b164fec8-1861-4f07-86ae-5023ea17f925
default

[root@centos8 ~]#virsh pool-info default
Name:                     default
UUID:                     b164fec8-1861-4f07-86ae-5023ea17f925
State:                 running
Persistent:         yes
Autostart:             yes
Capacity:             99.95 GiB
Allocation:         34.58 GiB
Available:             65.37 GiB

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#20010;&#23384;&#20648;&#27744;&#23545;&#24212;&#30340;&#37197;&#32622;&#25991;&#20214;</span>
[root@centos8 ~]#ll /etc/libvirt/storage/
total 8
drwxr-xr-x 2 root root     41 Sep 13 19:28 autostart
-rw------- 1 root root 538 Sep 13 19:05 default.xml
-rw------- 1 root root 519 Sep 13 19:28 isos.xml

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#26426;&#21152;&#36733;&#23384;&#20648;&#27744;</span>
[root@centos8 ~]#ll /etc/libvirt/storage/autostart/
total 0
lrwxrwxrwx 1 root root 32 Sep 13 19:05 default.xml -&gt;/etc/libvirt/storage/default.xml
lrwxrwxrwx 1 root root 29 Sep 13 19:28 isos.xml -&gt; /etc/libvirt/storage/isos.xml

[root@centos8 ~]#cat /etc/libvirt/storage/default.xml
&lt;!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
virsh pool-edit default
or other application using the libvirt API.
--&gt;
&lt;pool <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'dir'</span>&gt;
&lt;name&gt;default&lt;/name&gt;
&lt;uuid&gt;b164fec8-1861-4f07-86ae-5023ea17f925&lt;/uuid&gt;
&lt;capacity <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'bytes'</span>&gt;0&lt;/capacity&gt;
&lt;allocation <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'bytes'</span>&gt;0&lt;/allocation&gt;
&lt;available <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'bytes'</span>&gt;0&lt;/available&gt;
&lt;source&gt;
&lt;/source&gt;
&lt;target&gt;
    &lt;path&gt;/var/lib/libvirt/images&lt;/path&gt;
&lt;/target&gt;
&lt;/pool&gt;

[root@centos8 ~]#cat /etc/libvirt/storage/isos.xml
&lt;!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
virsh pool-edit isos
or other application using the libvirt API.
--&gt;
&lt;pool <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'dir'</span>&gt;
&lt;name&gt;isos&lt;/name&gt;
&lt;uuid&gt;a707038c-c21b-4570-bdef-d94c00554daa&lt;/uuid&gt;
&lt;capacity <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'bytes'</span>&gt;0&lt;/capacity&gt;
&lt;allocation <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'bytes'</span>&gt;0&lt;/allocation&gt;
&lt;available <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'bytes'</span>&gt;0&lt;/available&gt;
&lt;source&gt;
&lt;/source&gt;
&lt;target&gt;
    &lt;path&gt;/data/isos&lt;/path&gt;
&lt;/target&gt;
&lt;/pool&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:914513ef-5754-41d4-be63-ada77e407074" class="outline-4">
<h4 id="h:914513ef-5754-41d4-be63-ada77e407074">基于目录的存储池</h4>
<div class="outline-text-4" id="text-h:914513ef-5754-41d4-be63-ada77e407074">
</div>
<div id="outline-container-h:8399f77b-95aa-4bf9-9b57-fefadddeb11a" class="outline-5">
<h5 id="h:8399f77b-95aa-4bf9-9b57-fefadddeb11a">创建存储池</h5>
<div class="outline-text-5" id="text-h:8399f77b-95aa-4bf9-9b57-fefadddeb11a">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#30446;&#24405;&#38656;&#35201;&#20107;&#20808;&#21019;&#24314;,&#21542;&#21017;&#34429;&#28982;&#21487;&#20197;&#21019;&#24314;&#23384;&#20648;&#27744;,&#20294;&#26080;&#27861;&#30452;&#25509;&#21551;&#21160;,&#21518;&#26399;&#20063;&#21487;&#20197;&#20808;&#21019;&#24314;&#23384;&#20648;&#27744;,&#20877;&#20351;&#29992; pool-build &#33258;&#21160;&#21019;&#24314;&#30446;&#24405;</span>
[root@centos8 ~]#mkdir /data/vm_images

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110;&#23433;&#35013;&#32771;&#34394;&#21487;&#20197;&#35774;&#32622;&#26435;&#38480;</span>
[root@centos8 ~]#chmod 700 /data/vm_images

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24110;&#21161;</span>
[root@centos8 ~]#virsh pool-define-as --help

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#23384;&#20648;&#27744;</span>
[root@centos8 ~]#virsh pool-define-as vm_images dir --target /data/vm_images
Pool vm_images defined

[root@centos8 ~]#virsh pool-list
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
[root@centos8 ~]#virsh pool-list --all
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
vm_images                     inactive     no 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28608;&#27963;&#23384;&#20648;&#27744;</span>
[root@centos8 ~]#virsh pool-start vm_images
Pool vm_images started
[root@centos8 ~]#virsh pool-list 
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
vm_images                     active         no

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28608;&#27963;&#23384;&#20648;&#27744;,&#24182;&#24320;&#26426;&#21551;&#21160;</span>
[root@centos8 ~]#virsh pool-autostart vm_images
Pool vm_images marked as autostarted

[root@centos8 ~]#virsh pool-list
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
vm_images                     active         yes 
[root@centos8 ~]#ll /etc/libvirt/storage/
total 12
drwxr-xr-x 2 root root     62 Sep 20 18:44 autostart
-rw------- 1 root root 538 Sep 13 19:05 default.xml
-rw------- 1 root root 519 Sep 13 19:28 isos.xml
-rw------- 1 root root 534 Sep 20 18:42 vm_images.xml

[root@centos8 ~]#cat /etc/libvirt/storage/vm_images.xml
&lt;!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
virsh pool-edit vm_images
or other application using the libvirt API.
--&gt;
&lt;pool <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'dir'</span>&gt;
&lt;name&gt;vm_images&lt;/name&gt;
&lt;uuid&gt;cc851d99-1726-4cf9-8853-820441585bfa&lt;/uuid&gt;
&lt;capacity <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'bytes'</span>&gt;0&lt;/capacity&gt;
&lt;allocation <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'bytes'</span>&gt;0&lt;/allocation&gt;
&lt;available <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'bytes'</span>&gt;0&lt;/available&gt;
&lt;source&gt;
&lt;/source&gt;
&lt;target&gt;
    &lt;path&gt;/data/vm_images&lt;/path&gt;
&lt;/target&gt;
&lt;/pool&gt;
</pre>
</div>

<p>
<b>在virt-manager 工具可以管理和查看存储池</b>
</p>


<figure id="orge815066">
<img src="images/image-20210223143357353.png" alt="image-20210223143357353.png">

</figure>
</div>
</div>
<div id="outline-container-h:66261193-dd68-482e-be2d-68f701dbeb0b" class="outline-5">
<h5 id="h:66261193-dd68-482e-be2d-68f701dbeb0b">删除存储池</h5>
<div class="outline-text-5" id="text-h:66261193-dd68-482e-be2d-68f701dbeb0b">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20808;&#20572;&#27490;&#23384;&#20648;&#27744;&#21518;&#25165;&#33021;&#21024;&#38500;</span>
[root@centos8 ~]#virsh pool-destroy --pool vm_images
Pool vm_images destroyed

[root@centos8 ~]#virsh pool-list --all
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
vm_images                     inactive     yes

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#23384;&#20648;&#27744;&#30340;&#30456;&#20851;&#25968;&#25454;&#30446;&#24405;</span>
[root@centos8 ~]#virsh pool-delete --pool vm_images
Pool vm_images deleted
[root@centos8 ~]#ls /data
isos

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20294;&#23384;&#20648;&#27744;&#30340;&#37197;&#32622;&#36824;&#22312;</span>
[root@centos8 ~]#virsh pool-list --all
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
vm_images                     inactive     yes 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#23384;&#20648;&#27744;&#37197;&#32622;&#25991;&#20214;</span>
[root@centos8 ~]#virsh pool-undefine --pool vm_images
Pool vm_images has been undefined
[root@centos8 ~]#virsh pool-list --all
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes       

[root@centos8 ~]#ll /etc/libvirt/storage/
total 8
drwxr-xr-x 2 root root     41 Sep 20 18:54 autostart
-rw------- 1 root root 538 Sep 13 19:05 default.xml
-rw------- 1 root root 519 Sep 13 19:28 isos.xml
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:89f175a7-a59e-4007-8fc8-933d1429c2a0" class="outline-4">
<h4 id="h:89f175a7-a59e-4007-8fc8-933d1429c2a0">基于文件系统的存储池</h4>
<div class="outline-text-4" id="text-h:89f175a7-a59e-4007-8fc8-933d1429c2a0">
</div>
<div id="outline-container-h:2df018c4-755d-4b2b-bb64-d851395ecf14" class="outline-5">
<h5 id="h:2df018c4-755d-4b2b-bb64-d851395ecf14">实现基于文件系统的存储池过程</h5>
<div class="outline-text-5" id="text-h:2df018c4-755d-4b2b-bb64-d851395ecf14">
<ul class="org-ul">
<li><p>
准备分区并创建文件系统
</p>

<p>
fdisk /dev/sda
</p>

<p>
mkfs.ext4 /dev/sda6
</p></li>

<li>准备存储池的挂载点目录 mkdir /vm_images</li>

<li><p>
创建分区的存储池
</p>

<div class="org-src-container">
<pre class="src src-sh">virsh pool-define-as vm_images_fs fs --source-dev <span style="color: #8b2252;">"/dev/sda6"</span> --target <span style="color: #8b2252;">"/vm_images"</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">Source Path:&#22359;&#35774;&#22791;&#21517;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">Target Path : mount&#21040;&#30340;&#30446;&#24405;&#21517;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">libvirtd &#20250;&#33258;&#21160; mount &#20998;&#21306;</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-h:046e07c8-0c69-4a7e-8499-ffba4b686050" class="outline-5">
<h5 id="h:046e07c8-0c69-4a7e-8499-ffba4b686050">管理基于分区的存储池</h5>
<div class="outline-text-5" id="text-h:046e07c8-0c69-4a7e-8499-ffba4b686050">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#lsblk
NAME     MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
sda             8:0         0 200G     0 disk
&#9500;&#9472;sda1     8:1         0     1G     0 part /boot
&#9500;&#9472;sda2     8:2         0 100G     0 part /
&#9500;&#9472;sda3     8:3         0     50G     0 part /data
&#9500;&#9472;sda4     8:4         0     1K     0 part
&#9492;&#9472;sda5     8:5         0     2G     0 part [SWAP]
sr0         11:0         1     7.7G     0 rom

[root@centos8 ~]#fdisk /dev/sda

<span style="color: #0000ff;">Command</span> (m for help): n
All primary partitions are<span style="color: #a020f0;"> in</span> use.
Adding logical partition 6
First sector (320870400-419430399, default 320870400):
Last sector, +sectors or +size{K,M,G,T,P} (320870400-419430399, default
419430399): +10G
Created a new partition 6 of type <span style="color: #8b2252;">'Linux'</span> and of size 10 GiB.
<span style="color: #0000ff;">Command</span> (m for help): w
The partition table has been altered.
Syncing disks.

[root@centos8 ~]#mkfs.ext4 /dev/sda6

[root@centos8 ~]#lsblk
NAME     MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
sda             8:0         0 200G     0 disk
&#9500;&#9472;sda1     8:1         0     1G     0 part /boot
&#9500;&#9472;sda2     8:2         0 100G     0 part /
&#9500;&#9472;sda3     8:3         0     50G     0 part /data
&#9500;&#9472;sda4     8:4         0     1K     0 part
&#9500;&#9472;sda5     8:5         0     2G     0 part [SWAP]
&#9492;&#9472;sda6     8:6         0     10G     0 part
sr0         11:0         1     7.7G     0 rom 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#23384;&#20648;&#27744;&#23450;&#20041;</span>
[root@centos8 ~]#virsh pool-define-as vm_images_fs fs --source-dev <span style="color: #8b2252;">"/dev/sda6"</span> --target <span style="color: #8b2252;">"/vm_images"</span>
Pool vm_images_fs defined

[root@centos8 ~]#virsh pool-list --all
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
vm_images_fs                 inactive     no             
[root@centos8 ~]#df
Filesystem         1K-blocks         Used Available Use% Mounted on
devtmpfs                 4050832                 0     4050832     0% /dev
tmpfs                         4067612                 0     4067612     0% /dev/shm
tmpfs                         4067612         9380     4058232     1% /run
tmpfs                         4067612                 0     4067612     0% /sys/fs/cgroup
/dev/sda2             104806400 36337664     68468736     35% /
/dev/sda3             52403200 12331584     40071616     24% /data
/dev/sda1                 999320     120528         809980     13% /boot
tmpfs                         813520                 8         813512     1% /run/user/0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22240;&#20026;&#27809;&#26377;&#25346;&#36733;&#28857;&#26080;&#27861;&#21551;&#21160;</span>
[root@centos8 ~]#virsh pool-start vm_images_fs
error: Failed to start pool vm_images_fs
error: internal error: Child process (/usr/bin/mount -t auto /dev/sda6
/vm_images) unexpected exit status 32: mount: /vm_images: mount point does not
exist.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26500;&#24314;&#23384;&#20648;&#27744;&#20250;&#33258;&#21160;&#21019;&#24314;&#25346;&#25130;&#28857;</span>
[root@centos8 ~]#virsh pool-build vm_images_fs
Pool vm_images_fs built
[root@centos8 ~]#ll -d /vm_images/
drwx--x--x 2 root root 6 Sep 20 19:18 /vm_images/

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#23384;&#20648;&#27744;,&#33258;&#21160;&#25346;&#36733;</span>
[root@centos8 ~]#virsh pool-start vm_images_fs
Pool vm_images_fs started
[root@centos8 ~]#df
Filesystem         1K-blocks         Used Available Use% Mounted on
devtmpfs                 4050832                 0     4050832     0% /dev
tmpfs                         4067612                 0     4067612     0% /dev/shm
tmpfs                         4067612         9384     4058228     1% /run
tmpfs                         4067612                 0     4067612     0% /sys/fs/cgroup
/dev/sda2             104806400 36337648     68468752     35% /
/dev/sda3             52403200 12331584     40071616     24% /data
/dev/sda1                 999320     120528         809980     13% /boot
tmpfs                         813520                 8         813512     1% /run/user/0
/dev/sda6             10255636         36888     9678076     1% /vm_images

[root@centos8 ~]#virsh pool-info vm_images_fs
Name:                     vm_images_fs
UUID:                     157759a3-46ce-49ed-ba9d-eaf71c6dde30
State:                 running
Persistent:         yes
Autostart:         no
Capacity:             9.78 GiB
Allocation:         36.02 MiB
Available:             9.75 GiB
[root@centos8 ~]#virsh pool-list --all
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
vm_images_fs                 active         no     

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30001;&#20110;&#27809;&#26377;&#35774;&#20026;&#33258;&#21160;&#21551;&#21160;,&#37325;&#21551;&#21518;&#19981;&#20250;&#25346;&#36733;</span>
[root@centos8 ~]#reboot
[root@centos8 ~]#df
Filesystem         1K-blocks         Used Available Use% Mounted on
devtmpfs                 4050832                 0     4050832     0% /dev
tmpfs                         4067612                 0     4067612     0% /dev/shm
tmpfs                         4067612         9372     4058240     1% /run
tmpfs                         4067612                 0     4067612     0% /sys/fs/cgroup
/dev/sda2             104806400 36339572     68466828     35% /
/dev/sda3             52403200 12331584     40071616     24% /data
/dev/sda1                 999320     120528         809980     13% /boot
tmpfs                         813520                 0         813520     0% /run/user/0
[root@centos8 ~]#virsh pool-list --all
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
vm_images_fs                 inactive     no      

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#20026;&#33258;&#21160;&#21551;&#21160;</span>
[root@centos8 ~]#virsh pool-autostart vm_images_fs
Pool vm_images_fs marked as autostarted
[root@centos8 ~]#virsh pool-list --all
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
vm_images_fs                 inactive     yes         

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#26032;&#21551;&#21160;&#33258;&#21160;&#21551;&#21160;&#23384;&#20648;&#27744;&#24182;&#25346;&#36733;</span>
[root@centos8 ~]#reboot
[root@centos8 ~]#virsh pool-list
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
vm_images_fs                 active         yes         
[root@centos8 ~]#df
Filesystem         1K-blocks         Used Available Use% Mounted on
devtmpfs                 4050824                 0     4050824     0% /dev
tmpfs                         4067604                 0     4067604     0% /dev/shm
tmpfs                         4067604         9364     4058240     1% /run
tmpfs                         4067604                 0     4067604     0% /sys/fs/cgroup
/dev/sda2             104806400 36340572     68465828     35% /
/dev/sda3             52403200 12331584     40071616     24% /data
/dev/sda1                 999320     120528         809980     13% /boot
/dev/sda6             10255636         36888     9678076     1% /vm_images
tmpfs                         813520                 0         813520     0% /run/user/0
</pre>
</div>


<figure id="orge0d0ce3">
<img src="images/image-20210223143440541.png" alt="image-20210223143440541.png">

</figure>


<figure id="orgd0c2bee">
<img src="images/image-20210223143451056.png" alt="image-20210223143451056.png">

</figure>
</div>
</div>
<div id="outline-container-h:18f90cc9-c7fa-462b-9885-718f08a404f1" class="outline-5">
<h5 id="h:18f90cc9-c7fa-462b-9885-718f08a404f1">删除基于分区的存储池</h5>
<div class="outline-text-5" id="text-h:18f90cc9-c7fa-462b-9885-718f08a404f1">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh pool-destroy vm_images_fs
Pool vm_images_fs destroyed

[root@centos8 ~]#virsh pool-delete vm_images_fs
Pool vm_images_fs deleted

[root@centos8 ~]#virsh pool-undefine vm_images_fs
Pool vm_images_fs has been undefined

[root@centos8 ~]#df
Filesystem         1K-blocks         Used Available Use% Mounted on
devtmpfs                 4050824                 0     4050824     0% /dev
tmpfs                         4067604                 0     4067604     0% /dev/shm
tmpfs                         4067604         9360     4058244     1% /run
tmpfs                         4067604                 0     4067604     0% /sys/fs/cgroup
/dev/sda2             104806400 36340696     68465704     35% /
/dev/sda3             52403200 12331584     40071616     24% /data
/dev/sda1                 999320     120528         809980     13% /boot
tmpfs                         813520                 0         813520     0% /run/user/0
[root@centos8 ~]#ll /vm_images/
total 0
[root@centos8 ~]#virsh pool-list --all
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
[root@centos8 ~]#ll /etc/libvirt/storage/
total 8
drwxr-xr-x 2 root root     41 Sep 20 19:30 autostart
-rw------- 1 root root 538 Sep 13 19:05 default.xml
-rw------- 1 root root 519 Sep 13 19:28 isos.xml
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:2c49737e-483b-41b7-aba4-cf00dc67ae9f" class="outline-4">
<h4 id="h:2c49737e-483b-41b7-aba4-cf00dc67ae9f">基于磁盘的存储池</h4>
<div class="outline-text-4" id="text-h:2c49737e-483b-41b7-aba4-cf00dc67ae9f">
<p>
创建前需要添加新的磁盘
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#lsblk
NAME     MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
sda             8:0         0 200G     0 disk
&#9500;&#9472;sda1     8:1         0     1G     0 part /boot
&#9500;&#9472;sda2     8:2         0 100G     0 part /
&#9500;&#9472;sda3     8:3         0     50G     0 part /data
&#9500;&#9472;sda4     8:4         0     1K     0 part
&#9500;&#9472;sda5     8:5         0     2G     0 part [SWAP]
&#9492;&#9472;sda6     8:6         0     10G     0 part
sdb             8:16     0     20G     0 disk <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26032;&#28155;&#21152;&#30340;&#30913;&#30424;</span>
sr0         11:0         1     7.7G     0 rom

[root@centos8 ~]#parted /dev/sdb mklabel gpt
Information: You may need to update /etc/fstab.

[root@centos8 ~]#parted /dev/sdb print
Model: VMware, VMware Virtual S (scsi)
Disk /dev/sdb: 21.5GB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags:
Number Start End Size File system Name Flags

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20934;&#22791;&#30913;&#30424;&#23384;&#20648;&#27744;&#23545;&#24212;&#30340;xml&#25991;&#20214;</span>
[root@centos8 ~]#vim vm_images_disk.xml
[root@centos8 ~]#cat vm_images_disk.xml
&lt;pool <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'disk'</span>&gt;
&lt;name&gt;vm_images_disk&lt;/name&gt;
&lt;source&gt;
    &lt;device <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">'/dev/sdb'</span>/&gt;
    &lt;format <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'gpt'</span>/&gt;
&lt;/source&gt;
&lt;target&gt;
    &lt;path&gt;/dev&lt;/path&gt;
&lt;/target&gt;
&lt;/pool&gt;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#20110;XML&#21019;&#24314;&#23384;&#20648;&#27744;</span>
[root@centos8 ~]#virsh pool-define vm_images_disk.xml
Pool vm_images_disk defined from vm_images_disk.xml
[root@centos8 ~]#virsh pool-start vm_images_disk
Pool vm_images_disk started
[root@centos8 ~]#virsh pool-list
Name                                 State         Autostart
default                         active         yes         
isos                                 active         yes         
vm_images_disk             active         no
</pre>
</div>


<figure id="orge1e7b5d">
<img src="images/image-20210223143520425.png" alt="image-20210223143520425.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20572;&#27490;&#23384;&#20648;&#27744;</span>
[root@centos8 ~]#virsh pool-destroy vm_images_disk
Pool vm_images_disk destroyed
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20877;&#21024;&#38500;,&#27880;&#24847;&#22522;&#20110;&#30913;&#30424;&#30340;&#23384;&#20648;&#27744;&#19981;&#25903;&#25345;pool-delete</span>
[root@centos8 ~]#virsh pool-undefine vm_images_disk
Pool vm_images_disk has been undefined
[root@centos8 ~]#virsh pool-list
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0d3e7027-6d78-4c08-a90f-c5e6de084845" class="outline-4">
<h4 id="h:0d3e7027-6d78-4c08-a90f-c5e6de084845">基于LVM的存储池</h4>
<div class="outline-text-4" id="text-h:0d3e7027-6d78-4c08-a90f-c5e6de084845">
<p>
基于LVM的存储池要求使用VG中的全部磁盘空间
</p>

<p>
创建存储池，有两种方法
</p>

<ul class="org-ul">
<li>创建新的 VG 创建存储池</li>
<li>使用现有的 VG 创建存储池</li>
</ul>
</div>
<div id="outline-container-h:5deec363-64f8-4d05-a899-1211f222cc8e" class="outline-5">
<h5 id="h:5deec363-64f8-4d05-a899-1211f222cc8e">无存在的卷组直接创建存储池</h5>
<div class="outline-text-5" id="text-h:5deec363-64f8-4d05-a899-1211f222cc8e">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">source-dev &#25351;&#23450;&#30828;&#30424;&#35774;&#22791;,&#20107;&#20808;&#26080;&#21367;&#32452;&#26102;&#27492;&#39033;&#25165;&#38656;&#35201;&#25351;&#23450;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">source-name &#25351;&#23450;&#24050;&#26377;&#21367;&#32452;&#21517;,&#27492;&#39033;&#21033;&#29992;&#24050;&#26377;&#21367;&#32452;&#21019;&#24314;&#23384;&#20648;&#27744;&#25165;&#38656;&#25351;&#23450;,&#20107;&#20808;&#26080;&#21367;&#32452;&#26080;&#38656;&#25351;&#23450;</span>

[root@centos8 ~]#pvs
[root@centos8 ~]#virsh pool-define-as vm_images_lvm logical --source-dev=/dev/sdb 
Pool vm_images_lvm defined

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26080;&#21367;&#32452;&#26080;&#27861;&#21551;&#23384;&#20648;&#27744;</span>
[root@centos8 ~]#virsh pool-start vm_images_lvm
error: Failed to start pool vm_images_lvm
error: unsupported configuration: cannot find logical volume group name <span style="color: #8b2252;">'vm_images_lvm'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26500;&#24314;&#23384;&#20648;&#27744;&#21516;&#26102;&#21019;&#24314;&#21367;&#32452;</span>
[root@centos8 ~]#virsh pool-build vm_images_lvm
Pool vm_images_lvm built

[root@centos8 ~]#virsh pool-start vm_images_lvm
Pool vm_images_lvm started

[root@centos8 ~]#virsh pool-list
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
vm_images_lvm             active         no             

[root@centos8 ~]#pvs
PV                 VG                     Fmt Attr PSize     PFree 
/dev/sdb     vm_images_lvm lvm2 a-- &lt;20.00g &lt;20.00g
[root@centos8 ~]#vgs
VG                         <span style="color: #b22222;">#</span><span style="color: #b22222;">PV #LV #SN Attr     VSize     VFree </span>
vm_images_lvm     1     0     0 wz--n- &lt;20.00g &lt;20.00g
[root@centos8 ~]#pvs
PV                 VG                     Fmt Attr PSize     PFree 
/dev/sdb     vm_images_lvm lvm2 a-- &lt;20.00g &lt;20.00g
[root@centos8 ~]#vgs
VG                         <span style="color: #b22222;">#</span><span style="color: #b22222;">PV #LV #SN Attr     VSize     VFree </span>
vm_images_lvm     1     0     0 wz--n- &lt;20.00g &lt;20.00g
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4a483419-b885-4b50-bc9f-1741098b7361" class="outline-5">
<h5 id="h:4a483419-b885-4b50-bc9f-1741098b7361">利用已有的卷组创建存储池</h5>
<div class="outline-text-5" id="text-h:4a483419-b885-4b50-bc9f-1741098b7361">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh pool-define-as vm_images_lvm logical --source-name=vm_images_lvm
Pool vm_images_lvm defined

[root@centos8 ~]#virsh pool-start vm_images_lvm
Pool vm_images_lvm started
[root@centos8 ~]#virsh pool-list
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
vm_images_lvm             active         no 
</pre>
</div>


<figure id="org6122e8f">
<img src="images/image-20210223143544489.png" alt="image-20210223143544489.png">

</figure>


<figure id="org347f8ca">
<img src="images/image-20210223143552867.png" alt="image-20210223143552867.png">

</figure>
</div>
</div>
<div id="outline-container-h:f10c4370-a93c-49a6-b504-5e7596a953b2" class="outline-5">
<h5 id="h:f10c4370-a93c-49a6-b504-5e7596a953b2">virt-manager 利用已有的卷组创建存储池</h5>
<div class="outline-text-5" id="text-h:f10c4370-a93c-49a6-b504-5e7596a953b2">

<figure id="org8b34a07">
<img src="images/image-20210223143604466.png" alt="image-20210223143604466.png">

</figure>


<figure id="org9ffc773">
<img src="images/image-20210223143613466.png" alt="image-20210223143613466.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:3bfb4c2b-a523-43c8-816d-f931ed8541f6" class="outline-4">
<h4 id="h:3bfb4c2b-a523-43c8-816d-f931ed8541f6">基于NFS的存储池</h4>
<div class="outline-text-4" id="text-h:3bfb4c2b-a523-43c8-816d-f931ed8541f6">

<figure id="orgf249fff">
<img src="images/image-20210223143620710.png" alt="image-20210223143620710.png">

</figure>
</div>
<div id="outline-container-h:b4645252-9962-48b8-ad95-b73c1d0d3184" class="outline-5">
<h5 id="h:b4645252-9962-48b8-ad95-b73c1d0d3184">创建NFS共享</h5>
<div class="outline-text-5" id="text-h:b4645252-9962-48b8-ad95-b73c1d0d3184">
<p>
先在另一台主机10.0.0.18 创建NFS服务及共享NFS目录
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dnf -y install nfs-utils

[root@centos8 ~]#mkdir /data/kvmdata

[root@centos8 ~]#cat /etc/exports
/data/kvmdata *(rw,no_root_squash)

[root@centos8 ~]#systemctl enable --now nfs-server.service
[root@centos8 ~]#exportfs -v
/data/kvmdata &lt;world&gt; (sync,wdelay,hide,no_subtree_check,<span style="color: #a0522d;">sec</span>=sys,rw,secure,no_root_squash,no_all_squash)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:4054f836-1998-43d0-af94-c6fc9153365c" class="outline-5">
<h5 id="h:4054f836-1998-43d0-af94-c6fc9153365c">创建基于NFS服务的存储池</h5>
<div class="outline-text-5" id="text-h:4054f836-1998-43d0-af94-c6fc9153365c">
<p>
在宿主机创建存储池
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh pool-define-as vm_images_nfs netfs --source-host 10.0.0.18 --source-path /data/kvmdata --target /data/vm_images_nfs
Pool vm_images_nfs defined

<span style="color: #b22222;">#</span><span style="color: #b22222;">pool-build&#33258;&#21160;&#29983;&#25104;&#25346;&#36733;&#28857;</span>
[root@centos8 ~]#virsh pool-build vm_images_nfs
Pool vm_images_nfs built
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25110;&#32773;&#25163;&#21160;&#21019;&#24314;&#25346;&#36733;&#28857;</span>
[root@centos8 ~]#mkdir /data/vm_images_nfs

[root@centos8 ~]#virsh pool-start vm_images_nfs
Pool vm_images_nfs started

[root@centos8 ~]#virsh pool-list
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
vm_images_nfs             active         no 

[root@centos8 ~]#virsh pool-info vm_images_nfs
Name:                     vm_images_nfs
UUID:                     215ed00d-5462-48af-bdf6-d3caf6f58b04
State:                 running
Persistent:         yes
Autostart:         no
Capacity:             49.98 GiB
Allocation:         389.00 MiB
Available:             49.60 GiB
[root@centos8 ~]#cat /etc/libvirt/storage/vm_images_nfs.xml
&lt;!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
virsh pool-edit vm_images_nfs
or other application using the libvirt API.
--&gt;
&lt;pool <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'netfs'</span>&gt;
&lt;name&gt;vm_images_nfs&lt;/name&gt;
&lt;uuid&gt;215ed00d-5462-48af-bdf6-d3caf6f58b04&lt;/uuid&gt;
&lt;capacity <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'bytes'</span>&gt;0&lt;/capacity&gt;
&lt;allocation <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'bytes'</span>&gt;0&lt;/allocation&gt;
&lt;available <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'bytes'</span>&gt;0&lt;/available&gt;
&lt;source&gt;
    &lt;host <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'10.0.0.18'</span>/&gt;
    &lt;dir <span style="color: #a0522d;">path</span>=<span style="color: #8b2252;">'/data/kvmdata'</span>/&gt;
    &lt;format <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'auto'</span>/&gt;
&lt;/source&gt;
&lt;target&gt;
    &lt;path&gt;/data/vm_images_nfs&lt;/path&gt;
&lt;/target&gt;
&lt;/pool&gt;

[root@centos8 ~]#df
Filesystem                         1K-blocks         Used Available Use% Mounted on
devtmpfs                                     4050832                 0     4050832     0% /dev
tmpfs                                         4067612                 0     4067612     0% /dev/shm
tmpfs                                         4067612         9396     4058216     1% /run
tmpfs                                         4067612                 0     4067612     0% /sys/fs/cgroup
/dev/sda2                             104806400 36338748     68467652     35% /
/dev/sda3                                 52403200 12331584     40071616     24% /data
/dev/sda1                                     999320     120528         809980     13% /boot
tmpfs                                             813520                 8         813512     1% /run/user/0
10.0.0.18:/data/kvmdata     52403200     398336     52004864     1% /data/vm_images_nfs
</pre>
</div>


<figure id="orgea06521">
<img src="images/image-20210223143644631.png" alt="image-20210223143644631.png">

</figure>
</div>
</div>
<div id="outline-container-h:74731716-1366-417b-97b9-bc1fff8ba6a6" class="outline-5">
<h5 id="h:74731716-1366-417b-97b9-bc1fff8ba6a6">删除存储池</h5>
<div class="outline-text-5" id="text-h:74731716-1366-417b-97b9-bc1fff8ba6a6">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh pool-destroy vm_images_nfs
Pool vm_images_nfs destroyed
[root@centos8 ~]#df
Filesystem         1K-blocks         Used Available Use% Mounted on
devtmpfs                 4050832                 0     4050832     0% /dev
tmpfs                         4067612                 0     4067612     0% /dev/shm
tmpfs                         4067612         9388     4058224     1% /run
tmpfs                         4067612                 0     4067612     0% /sys/fs/cgroup
/dev/sda2             104806400 36339252     68467148     35% /
/dev/sda3             52403200 12331584     40071616     24% /data
/dev/sda1                 999320     120528         809980     13% /boot
[root@centos8 ~]#virsh pool-undefine vm_images_nfs
Pool vm_images_nfs has been undefined
[root@centos8 ~]#ls /data/
isos/                 vm_images_nfs/
[root@centos8 ~]#virsh pool-list --all
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:6599b96f-49cf-4ccb-87f0-733d3b973d2f" class="outline-3">
<h3 id="h:6599b96f-49cf-4ccb-87f0-733d3b973d2f">存储卷管理</h3>
<div class="outline-text-3" id="text-h:6599b96f-49cf-4ccb-87f0-733d3b973d2f">
</div>
<div id="outline-container-h:c6df8ac5-4943-46e3-8351-2f43aedfc8be" class="outline-4">
<h4 id="h:c6df8ac5-4943-46e3-8351-2f43aedfc8be">存储卷概述</h4>
<div class="outline-text-4" id="text-h:c6df8ac5-4943-46e3-8351-2f43aedfc8be">
</div>
<div id="outline-container-h:d5556989-d31c-434f-9e06-c06c06a60538" class="outline-5">
<h5 id="h:d5556989-d31c-434f-9e06-c06c06a60538">存储卷介绍</h5>
<div class="outline-text-5" id="text-h:d5556989-d31c-434f-9e06-c06c06a60538">
<p>
一个存储池被分割为多个存储卷（Storage Volume)
</p>

<p>
存储卷可以为以下多种形式
</p>

<ul class="org-ul">
<li>文件</li>
<li>块设备（如物理分区、LVM逻辑卷等）</li>
<li>libvirt管理的其他类型存储的抽象</li>
</ul>
</div>
</div>
<div id="outline-container-h:c975c5c8-0619-4066-8481-22dfbcf898c3" class="outline-5">
<h5 id="h:c975c5c8-0619-4066-8481-22dfbcf898c3">存储卷管理相关命令</h5>
<div class="outline-text-5" id="text-h:c975c5c8-0619-4066-8481-22dfbcf898c3">
<div class="org-src-container">
<pre class="src src-sh">vol-clone             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20811;&#38534;&#21367;</span>
vol-create-as      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;&#19968;&#32452;&#21442;&#25968;&#21019;&#24314;&#21367;</span>
vol-create           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;XML&#25991;&#20214;&#21019;&#24314;&#21367;</span>
vol-create-from <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;&#36755;&#20837;&#30340;&#20854;&#20182;&#21367;&#21019;&#24314;&#8212;&#20010;&#26032;&#30340;&#21367;</span>
vol-delete           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;&#19968;&#20010;&#21367;</span>
vol-download    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19979;&#36733;&#21367;&#30340;&#20869;&#23481;&#21040;&#19968;&#20010;&#25991;&#20214;</span>
vol-dumpxml     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20445;&#23384;&#21367;&#20449;&#24687;&#30340;&#20449;&#24687;&#21040;xML&#25991;&#20214;&#20013;</span>
vol-info              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23384;&#20648;&#21367;&#30340;&#20449;&#24687;</span>
vol-key              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26681;&#25454;&#21367;&#21517;&#25110;&#36335;&#24452;&#36820;&#22238;&#21367;&#30340;key</span>
vol-list              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#21367;</span>
vol-name          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26681;&#25454;&#21367;&#30340;key&#25110;&#36335;&#24452;&#36820;&#22238;&#21367;&#21517;</span>
vol-path           <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26681;&#25454;&#21367;&#21517;&#25110;key&#36820;&#22238;&#21367;&#30340;&#36335;&#24452;</span>
vol-pool            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26681;&#25454;&#21367;&#30340;key&#25110;&#36335;&#24452;&#36820;&#22238;&#23384;&#20648;&#27744;</span>
vol-resize        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35843;&#25972;&#21367;&#22823;&#23567;</span>
vol-upload     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#20256;&#25991;&#20214;&#20869;&#23481;&#21040;&#19968;&#20010;&#21367;</span>
vol-wipe       <span style="color: #b22222;">#</span><span style="color: #b22222;">wipe &#9472;&#20010;&#21367;</span>
</pre>
</div>

<p>
范例: 查看帮助
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh help volume
Storage Volume (<span style="color: #483d8b;">help</span> keyword <span style="color: #8b2252;">'volume'</span>):
    vol-clone                                         clone a volume.
    vol-create-as                                 create a volume from a set of args
    vol-create                                         create a vol from an XML file
    vol-create-from                             create a vol, using another volume as input
    vol-delete                                         delete a vol
    vol-download                                     download volume contents to a file
    vol-dumpxml                                     vol information<span style="color: #a020f0;"> in</span> XML
    vol-info                                             storage vol information
    vol-key                                             returns the volume key for a given volume
name or path
    vol-list                                             list vols
    vol-name                                             returns the volume name for a given volume
key or path
    vol-path                                             returns the volume path for a given volume
name or key
    vol-pool                                             returns the storage pool for a given volume
key or path
    vol-resize                                         resize a vol
    vol-upload                                         upload file contents to a volume
    vol-wipe                                             wipe a vol

[root@centos8 ~]#virsh vol-create-as --help
NAME
    vol-create-as - create a volume from a set of args
SYNOPSIS
    vol-create-as &lt;pool&gt; &lt;name&gt; &lt;capacity&gt; [--allocation &lt;string&gt;] [--format
&lt;string&gt;] [--backing-vol &lt;string&gt;] [--backing-vol-format &lt;string&gt;] [--prealloc-
metadata] [--print-xml]
DESCRIPTION
    Create a vol.
OPTIONS
    [--pool] &lt;string&gt; pool name
    [--name] &lt;string&gt; name of the volume
    [--capacity] &lt;string&gt; size of the vol, as scaled integer (default bytes)
        --allocation &lt;string&gt; initial allocation size, as scaled integer (default
bytes)
        --format &lt;string&gt; file format type raw,bochs,qcow,qcow2,qed,vmdk
        --backing-vol &lt;string&gt; the backing volume if taking a snapshot
        --backing-vol-format &lt;string&gt; format of backing volume if taking a snapshot
        --prealloc-metadata preallocate metadata (<span style="color: #a020f0;">for</span> qcow2 instead of full
allocation)
        --print-xml         print XML document, but don<span style="color: #8b2252;">'t define/create</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:62d7ee3a-9520-4d25-945d-48ba394070b1" class="outline-4">
<h4 id="h:62d7ee3a-9520-4d25-945d-48ba394070b1">基于目录的存储池的存储卷管理</h4>
<div class="outline-text-4" id="text-h:62d7ee3a-9520-4d25-945d-48ba394070b1">
</div>
<div id="outline-container-h:07607382-9121-4f17-a0e6-761e48f55e6b" class="outline-5">
<h5 id="h:07607382-9121-4f17-a0e6-761e48f55e6b">创建基于目录的存储池</h5>
<div class="outline-text-5" id="text-h:07607382-9121-4f17-a0e6-761e48f55e6b">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mkdir /data/vm_images_dir
[root@centos8 ~]#virsh pool-define-as vm_images_dir dir --target /data/vm_images_dir
Pool vm_images_dir defined

[root@centos8 ~]#virsh pool-start vm_images_dir
Pool vm_images_dir started
[root@centos8 ~]#virsh pool-list
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
vm_images_dir             active         no

[root@centos8 ~]#virsh pool-dumpxml vm_images_dir
&lt;pool <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'dir'</span>&gt;
&lt;name&gt;vm_images_dir&lt;/name&gt;
&lt;uuid&gt;7d7fdbf5-d098-4a79-ba93-9d31c22d8fc8&lt;/uuid&gt;
&lt;capacity <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'bytes'</span>&gt;53660876800&lt;/capacity&gt;
&lt;allocation <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'bytes'</span>&gt;12627574784&lt;/allocation&gt;
&lt;available <span style="color: #a0522d;">unit</span>=<span style="color: #8b2252;">'bytes'</span>&gt;41033302016&lt;/available&gt;
&lt;source&gt;
&lt;/source&gt;
&lt;target&gt;
    &lt;path&gt;/data/vm_images_dir&lt;/path&gt;
    &lt;permissions&gt;
        &lt;mode&gt;0755&lt;/mode&gt;
        &lt;owner&gt;0&lt;/owner&gt;
        &lt;group&gt;0&lt;/group&gt;
    &lt;/permissions&gt;
&lt;/target&gt;
&lt;/pool&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:ca4c4740-577a-4cb6-a97f-d7efadbaf02f" class="outline-5">
<h5 id="h:ca4c4740-577a-4cb6-a97f-d7efadbaf02f">创建基于目录的存储池的存储卷</h5>
<div class="outline-text-5" id="text-h:ca4c4740-577a-4cb6-a97f-d7efadbaf02f">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh vol-create-as vm_images_dir test1.qcow2 1g --format qcow2
Vol test1.qcow2 created

[root@centos8 ~]#ls /data/vm_images_dir/ -lh
total 196K
-rw------- 1 root root 193K Sep 20 21:47 test1.qcow2

[root@centos8 ~]#virsh vol-list vm_images_dir
Name                                 Path                                                                     
------------------------------------------------------------------------------
test1.qcow2                 /data/vm_images_dir/test1.qcow2 
[root@centos8 ~]#virsh vol-info test1.qcow2 --pool vm_images_dir
Name:                     test1.qcow2
Type:                     file
Capacity:             1.00 GiB
Allocation:         196.00 KiB

[root@centos8 ~]#virsh vol-info /data/vm_images_dir/test1.qcow2
Name:                     test1.qcow2
Type:                     file
Capacity:             1.00 GiB
Allocation:         196.00 KiB

[root@centos8 ~]#qemu-img info /data/vm_images_dir/test1.qcow2
image: /data/vm_images_dir/test1.qcow2
file format: qcow2
virtual size: 1.0G (1073741824 bytes)
disk size: 196K
cluster_size: 65536
Format specific information:
    compat: 0.10
    refcount bits: 16
</pre>
</div>


<figure id="org7528359">
<img src="images/image-20210223143710050.png" alt="image-20210223143710050.png">

</figure>
</div>
</div>
<div id="outline-container-h:d9732f78-0a42-4da6-923e-bc74ea026eaf" class="outline-5">
<h5 id="h:d9732f78-0a42-4da6-923e-bc74ea026eaf">删除基于目录的存储池的存储卷</h5>
<div class="outline-text-5" id="text-h:d9732f78-0a42-4da6-923e-bc74ea026eaf">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh vol-delete     test1.qcow2 vm_images_dir
Vol test1.qcow2 deleted

[root@centos8 ~]#ls /data/
isos/                 vm_images_dir/ vm_images_nfs/
[root@centos8 ~]#ls /data/vm_images_dir/
[root@centos8 ~]#
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:3ba6d77a-a9e8-4478-a070-22ac0b068ec0" class="outline-4">
<h4 id="h:3ba6d77a-a9e8-4478-a070-22ac0b068ec0">基于LVM的存储池的存储卷管理</h4>
<div class="outline-text-4" id="text-h:3ba6d77a-a9e8-4478-a070-22ac0b068ec0">
</div>
<div id="outline-container-h:171d7241-d944-4323-bcc0-e44d7d1c33a7" class="outline-5">
<h5 id="h:171d7241-d944-4323-bcc0-e44d7d1c33a7">创建基于LVM的存储池</h5>
<div class="outline-text-5" id="text-h:171d7241-d944-4323-bcc0-e44d7d1c33a7">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#pvs
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#26032;&#30828;&#30424;</span>
[root@centos8 ~]#lsblk
NAME     MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
sda             8:0         0 200G     0 disk
&#9500;&#9472;sda1     8:1         0     1G     0 part /boot
&#9500;&#9472;sda2     8:2         0 100G     0 part /
&#9500;&#9472;sda3     8:3         0     50G     0 part /data
&#9500;&#9472;sda4     8:4         0     1K     0 part
&#9500;&#9472;sda5     8:5         0     2G     0 part [SWAP]
&#9492;&#9472;sda6     8:6         0     10G     0 part
sdb             8:16     0     20G     0 disk
sr0         11:0         1     7.7G     0 rom 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#26032;&#30828;&#30424;&#30452;&#25509;&#21019;&#24314;&#22522;&#20110;LVM&#30340;&#23384;&#20648;&#27744;</span>
[root@centos8 ~]#virsh pool-define-as vm_images_lvm logical --source-dev=/dev/sdb
Pool vm_images_lvm defined

[root@centos8 ~]#virsh pool-build vm_images_lvm
Pool vm_images_lvm built

[root@centos8 ~]#pvs
PV                 VG                     Fmt Attr PSize     PFree 
/dev/sdb     vm_images_lvm lvm2 a-- &lt;20.00g &lt;20.00g

[root@centos8 ~]#vgs
VG                         <span style="color: #b22222;">#</span><span style="color: #b22222;">PV #LV #SN Attr     VSize     VFree </span>
vm_images_lvm     1     0     0 wz--n- &lt;20.00g &lt;20.00g

[root@centos8 ~]#virsh pool-start vm_images_lvm
Pool vm_images_lvm started

[root@centos8 ~]#virsh pool-list
Name                                 State         Autostart
-------------------------------------------
default                         active         yes         
isos                                 active         yes         
vm_images_dir             active         no             
vm_images_lvm             active         no 
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27809;&#26377;&#36923;&#36753;&#21367;</span>
[root@centos8 ~]#lvs
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7b07c854-9567-43c2-a0c9-b969719b5ea7" class="outline-5">
<h5 id="h:7b07c854-9567-43c2-a0c9-b969719b5ea7">创建基于LVM的存储池的存储卷</h5>
<div class="outline-text-5" id="text-h:7b07c854-9567-43c2-a0c9-b969719b5ea7">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh vol-create-as vm_images_lvm lvvol1 10g
Vol lvvol1 created

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#33258;&#21160;&#21019;&#24314;&#36923;&#36753;&#21367;</span>
[root@centos8 ~]#lvs
LV         VG                     Attr             LSize Pool Origin Data% Meta% Move Log
Cpy%Sync Convert
lvvol1 vm_images_lvm -wi-a----- 10.00g                                                                             

[root@centos8 ~]#virsh vol-list vm_images_lvm
Name                                 Path                                                                     
------------------------------------------------------------------------------
lvvol1                             /dev/vm_images_lvm/lvvol1
</pre>
</div>


<figure id="org36ebb67">
<img src="images/image-20210223143729632.png" alt="image-20210223143729632.png">

</figure>
</div>
</div>
<div id="outline-container-h:5dcb00e8-adc8-4722-b67e-3deb94fc3c2a" class="outline-5">
<h5 id="h:5dcb00e8-adc8-4722-b67e-3deb94fc3c2a">利用存储卷创建虚拟机</h5>
<div class="outline-text-5" id="text-h:5dcb00e8-adc8-4722-b67e-3deb94fc3c2a">
<p>
virt-manager 创建新虚拟机
</p>

<p>
选择&#x2013;Local install media(ISO image or CDROM)
</p>


<figure id="orgd3ebed7">
<img src="images/image-20210223143740909.png" alt="image-20210223143740909.png">

</figure>

<p>
选择iso镜像文件
</p>


<figure id="org88f1591">
<img src="images/image-20210223143749023.png" alt="image-20210223143749023.png">

</figure>


<figure id="org0282d53">
<img src="images/image-20210223143756980.png" alt="image-20210223143756980.png">

</figure>

<p>
选择自定义存储，找到vm_images_lvm 中卷 lvv0l1
</p>


<figure id="orge0acf34">
<img src="images/image-20210223143805182.png" alt="image-20210223143805182.png">

</figure>



<figure id="org8e804bd">
<img src="images/image-20210223143813294.png" alt="image-20210223143813294.png">

</figure>


<figure id="org778a087">
<img src="images/image-20210223143822238.png" alt="image-20210223143822238.png">

</figure>


<figure id="org37fa9d8">
<img src="images/image-20210223143830736.png" alt="image-20210223143830736.png">

</figure>


<figure id="orgc1ef291">
<img src="images/image-20210223143839385.png" alt="image-20210223143839385.png">

</figure>
</div>
</div>
<div id="outline-container-h:98718fd0-0393-4ad6-9ec4-b1507c754082" class="outline-5">
<h5 id="h:98718fd0-0393-4ad6-9ec4-b1507c754082">删除基于LVM的存储池的存储卷</h5>
<div class="outline-text-5" id="text-h:98718fd0-0393-4ad6-9ec4-b1507c754082">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh vol-delete     lvvol1 vm_images_lvm
Vol lvvol1 deleted
[root@centos8 ~]#lvs
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:9aa76f77-bef6-41cc-bfbe-8b68179566f7" class="outline-4">
<h4 id="h:9aa76f77-bef6-41cc-bfbe-8b68179566f7">克隆存储卷</h4>
<div class="outline-text-4" id="text-h:9aa76f77-bef6-41cc-bfbe-8b68179566f7">
</div>
<div id="outline-container-h:dc4eca6f-e239-459c-8d25-eafa5dd2cd3f" class="outline-5">
<h5 id="h:dc4eca6f-e239-459c-8d25-eafa5dd2cd3f">克隆基于文件的存储卷</h5>
<div class="outline-text-5" id="text-h:dc4eca6f-e239-459c-8d25-eafa5dd2cd3f">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh vol-list default
Name                                 Path                                                                     
------------------------------------------------------------------------------
centos7-vm1.qcow2     /var/lib/libvirt/images/centos7-vm1.qcow2
centos7-vm2.qcow2     /var/lib/libvirt/images/centos7-vm2.qcow2
centos7.qcow2             /var/lib/libvirt/images/centos7.qcow2 
centos8-test1.qcow2 /var/lib/libvirt/images/centos8-test1.qcow2
centos8.qcow2             /var/lib/libvirt/images/centos8.qcow2 
Windows-2008_r2-x86_64.qcow2 /var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2

[root@centos8 ~]#virsh vol-info     centos7.qcow2 default
Name:                     centos7.qcow2
Type:                     file
Capacity:             20.00 GiB
Allocation:         1.56 GiB

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20811;&#38534;&#65292;&#23454;&#38469;&#23601;&#26159;&#25335;&#36125;</span>
[root@centos8 ~]#virsh vol-clone centos7.qcow2 centos7_clone.qcow2 default
Vol centos7_clone.qcow2 cloned from centos7.qcow2

[root@centos8 ~]#virsh vol-info     centos7_clone.qcow2 default
Name:                     centos7_clone.qcow2
Type:                     file
Capacity:             20.00 GiB
Allocation:         1.52 GiB

[root@centos8 ~]#virsh vol-list default
Name                                 Path                                                                     
------------------------------------------------------------------------------
centos7-vm1.qcow2     /var/lib/libvirt/images/centos7-vm1.qcow2
centos7-vm2.qcow2     /var/lib/libvirt/images/centos7-vm2.qcow2
centos7.qcow2             /var/lib/libvirt/images/centos7.qcow2 
centos7_clone.qcow2 /var/lib/libvirt/images/centos7_clone.qcow2
centos8-test1.qcow2 /var/lib/libvirt/images/centos8-test1.qcow2
centos8.qcow2             /var/lib/libvirt/images/centos8.qcow2 
Windows-2008_r2-x86_64.qcow2 /var/lib/libvirt/images/Windows-2008_r2-x86_64.qcow2

root@centos8 ~]#ll -h /var/lib/libvirt/images/centos7.qcow2 /var/lib/libvirt/images/centos7_clone.qcow2
-rw-r--r-- 1 root root 1.6G Sep 20 22:22 /var/lib/libvirt/images/centos7_clone.qcow2
-rw-r--r-- 1 root root 1.6G Sep 20 18:09 /var/lib/libvirt/images/centos7.qcow2
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e2a6b09e-fb78-43b2-8408-12e3bac6c9fb" class="outline-5">
<h5 id="h:e2a6b09e-fb78-43b2-8408-12e3bac6c9fb">克隆基于LVM的存储卷</h5>
<div class="outline-text-5" id="text-h:e2a6b09e-fb78-43b2-8408-12e3bac6c9fb">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh vol-list vm_images_lvm
Name                                 Path                                                                     
------------------------------------------------------------------------------
lvvol1                             /dev/vm_images_lvm/lvvol1

[root@centos8 ~]#virsh vol-clone     lvvol1 lvvol1_clone vm_images_lvm
Vol lvvol1_clone cloned from lvvol1

[root@centos8 ~]#virsh vol-list vm_images_lvm
Name                                 Path                                                                     
------------------------------------------------------------------------------
lvvol1                             /dev/vm_images_lvm/lvvol1                         
lvvol1_clone                 /dev/vm_images_lvm/lvvol1_clone 
[root@centos8 ~]#lvs
LV                     VG                     Attr             LSize Pool Origin Data% Meta% Move Log
Cpy%Sync Convert
lvvol1             vm_images_lvm -wi-a----- 1.00g                                                                 

lvvol1_clone vm_images_lvm -wi-a----- 1.00g 
</pre>
</div>


<figure id="org3c0c3af">
<img src="images/image-20210223143903030.png" alt="image-20210223143903030.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:d066392f-4586-4989-aa40-b5621c2791d8" class="outline-4">
<h4 id="h:d066392f-4586-4989-aa40-b5621c2791d8">向虚拟机添加存储卷</h4>
<div class="outline-text-4" id="text-h:d066392f-4586-4989-aa40-b5621c2791d8">
<p>
可以通过attach-device和attach-disk给现有虚拟机添加存储卷,从而实现给虚拟机新添加虚拟磁盘
</p>
</div>
<div id="outline-container-h:faf2c601-997b-4abd-9c9c-04606bbb1550" class="outline-5">
<h5 id="h:faf2c601-997b-4abd-9c9c-04606bbb1550">attach-device 通过XML文件给已有虚拟机添加存储卷</h5>
<div class="outline-text-5" id="text-h:faf2c601-997b-4abd-9c9c-04606bbb1550">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh vol-list vm_images_dir
Name                                 Path                                                                     
------------------------------------------------------------------------------
test1.qcow2                 /data/vm_images_dir/test1.qcow2

[root@centos8 ~]#cat disk.xml
&lt;disk <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'file'</span> <span style="color: #a0522d;">device</span>=<span style="color: #8b2252;">'disk'</span>&gt;
&lt;driver <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'qemu'</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'qcow2'</span> <span style="color: #a0522d;">cache</span>=<span style="color: #8b2252;">'none'</span>/&gt;
&lt;source <span style="color: #a0522d;">file</span>=<span style="color: #8b2252;">'/data/vm_images_dir/test1.qcow2'</span>/&gt;
&lt;target <span style="color: #a0522d;">dev</span>=<span style="color: #8b2252;">'vdb'</span>/&gt;
&lt;/disk&gt;

[root@centos8 ~]#virsh start centos7
Domain centos7 started

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#21482;&#26159;&#20020;&#26102;&#28155;&#21152;&#35774;&#22791;,&#20351;&#29992;&#36873;&#39033;--persistent&#23454;&#29616;&#25345;&#20037;&#20445;&#23384;</span>
[root@centos8 ~]#virsh attach-device centos7 disk.xml --persistent
Device attached successfully
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#34394;&#25311;&#26426;&#24403;&#21069;&#30340;&#22359;&#35774;&#22791;&#20449;&#24687;</span>
[root@centos8 ~]#virsh domblklist centos7
Target         Source
------------------------------------------------
vdb             /data/vm_images_dir/test1.qcow2
vdc             /var/lib/libvirt/images/centos7.qcow2
hdb                 -
</pre>
</div>


<figure id="org1d7040f">
<img src="images/image-20210223143918839.png" alt="image-20210223143918839.png">

</figure>


<figure id="org2079f40">
<img src="images/image-20210223143926655.png" alt="image-20210223143926655.png">

</figure>
</div>
</div>
<div id="outline-container-h:d6d632ad-88f2-4175-a7a1-9e5d8a80b699" class="outline-5">
<h5 id="h:d6d632ad-88f2-4175-a7a1-9e5d8a80b699">attach-disk 给已有虚拟机添加存储卷</h5>
<div class="outline-text-5" id="text-h:d6d632ad-88f2-4175-a7a1-9e5d8a80b699">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh start centos7
Domain centos7 started

[root@centos8 ~]#virsh attach-disk --domain centos7 --sourcetype block --source /dev/vm_images_lvm/lvvol1 --target vdb
Disk attached successfully
</pre>
</div>


<figure id="org0572f11">
<img src="images/image-20210223143938878.png" alt="image-20210223143938878.png">

</figure>


<figure id="org161d33c">
<img src="images/image-20210223143946288.png" alt="image-20210223143946288.png">

</figure>
</div>
</div>
</div>
</div>
<div id="outline-container-h:5a1e12f7-d0b9-4fa3-ae26-e4d257713ae9" class="outline-3">
<h3 id="h:5a1e12f7-d0b9-4fa3-ae26-e4d257713ae9">离线工具</h3>
<div class="outline-text-3" id="text-h:5a1e12f7-d0b9-4fa3-ae26-e4d257713ae9">
<p>
不启动虚拟机的情况下,直接访问管理虚拟机对应的磁盘,即离线访问
</p>
</div>
<div id="outline-container-h:a6a1d1af-9d7c-455f-ab81-6cbb81f86cbb" class="outline-4">
<h4 id="h:a6a1d1af-9d7c-455f-ab81-6cbb81f86cbb">离线工具应用</h4>
<div class="outline-text-4" id="text-h:a6a1d1af-9d7c-455f-ab81-6cbb81f86cbb">
<ul class="org-ul">
<li>观看或下载位于虚拟机磁盘中的文件</li>
<li>编辑或上传文件到虚拟机磁盘</li>
<li>读取或写入的虚拟机配置</li>
<li>准备新的磁盘映像，其中包含文件、目录、文件系统、分区、逻辑卷和其他选项</li>
<li>拯救和修复客户无法启动或需要更改启动配置的虚拟机</li>
<li>监控虚拟机的磁盘使用情况</li>
<li>根据组织安全标准审计虚拟机的合规性</li>
<li>通过克隆和修改模板来部署虚拟机</li>
<li>读取CD和DVD ISO和软盘映像</li>
</ul>
</div>
</div>
<div id="outline-container-h:74a80aaf-855d-4f33-a10c-72170a445070" class="outline-4">
<h4 id="h:74a80aaf-855d-4f33-a10c-72170a445070">guestfs 工具</h4>
<div class="outline-text-4" id="text-h:74a80aaf-855d-4f33-a10c-72170a445070">
<p>
Libguestfs 提供了一个简单地访问虚机磁盘镜像文件的方法，即使是在虚拟机无法启动的情况下
</p>

<p>
Libguestfs 是由一组丰富的工具集组成，可以让管理员访问虚机文件，甚至调整和挽救文件。
</p>

<p>
guestfish 是一个基于libguestfs API的交互shell
</p>
</div>
<div id="outline-container-h:5c435168-1ef4-4f34-ac4b-59d2f22c03a0" class="outline-5">
<h5 id="h:5c435168-1ef4-4f34-ac4b-59d2f22c03a0">安装和使用guestfs</h5>
<div class="outline-text-5" id="text-h:5c435168-1ef4-4f34-ac4b-59d2f22c03a0">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dnf -y install libguestfs-tools

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#34394;&#25311;&#26426;&#30340;&#30913;&#30424;&#25991;&#20214;</span>
[root@centos8 ~]#virsh domblklist centos7
Target         Source
------------------------------------------------
vdc             /var/lib/libvirt/images/centos7.qcow2
hdb                 -

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#35835;&#26041;&#24335;&#25171;&#24320;&#34394;&#25311;&#30913;&#30424;</span>
[root@centos8 ~]#guestfish --ro -a /var/lib/libvirt/images/centos7.qcow2
Welcome to guestfish, the guest filesystem shell for
editing virtual machine filesystems and disk images.
Type: &#8216;help&#8217; for help on commands
        &#8216;man&#8217; to read the manual
        &#8216;quit&#8217; to quit the shell
&gt;&lt;fs&gt; help
Add disk images to examine using the &#8216;-a&#8217; or &#8216;-d&#8217; options, or the &#8216;add&#8217;
command.
Or create a new disk image using &#8216;-N&#8217;, or the &#8216;alloc&#8217; or &#8216;sparse&#8217; commands.
Once you have done this, use the &#8216;run&#8217; command.
For more information about a command, use &#8216;help cmd&#8217;.
To read the manual, type &#8216;man&#8217;.
&gt;&lt;fs&gt; run                             <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25195;&#25551;&#30913;&#30424;</span>
&#9683; 75% &#10214;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618; 100%
&#10214;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;
&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#9618;&#10215; 00:00
&gt;&lt;fs&gt; list-filesystems     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21015;&#20986;&#25991;&#20214;&#31995;&#32479;</span>
/dev/sda1: xfs
/dev/centos/root: xfs
/dev/centos/swap: swap
&gt;&lt;fs&gt;
&gt;&lt;fs&gt; mount /dev/sda1 /         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25346;&#36733;</span>
&gt;&lt;fs&gt; ls / <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;</span>
.vmlinuz-3.10.0-1127.el7.x86_64.hmac
System.map-3.10.0-1127.el7.x86_64
config-3.10.0-1127.el7.x86_64
efi
grub
grub2
initramfs-0-rescue-1d660cbcc84f4a399d9f991578c3c6f8.img
initramfs-3.10.0-1127.el7.x86_64.img
initramfs-3.10.0-1127.el7.x86_64kdump.img
symvers-3.10.0-1127.el7.x86_64.gz
vmlinuz-0-rescue-1d660cbcc84f4a399d9f991578c3c6f8
vmlinuz-3.10.0-1127.el7.x86_64
</pre>
</div>
</div>
</div>
<div id="outline-container-h:465478e3-eb5d-4e12-8600-cb91431fad52" class="outline-5">
<h5 id="h:465478e3-eb5d-4e12-8600-cb91431fad52">guestfs 自动挂载文件系统</h5>
<div class="outline-text-5" id="text-h:465478e3-eb5d-4e12-8600-cb91431fad52">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#34394;&#25311;&#26426;&#24320;&#26426;&#26080;&#27861;&#35775;&#38382;&#34394;&#25311;&#30913;&#30424;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36873;&#39033;-d&#25351;&#23450;&#34394;&#25311;&#26426;domain&#25171;&#24320;&#34394;&#25311;&#30913;&#30424;</span>
[root@centos8 ~]#guestfish -d centos7
libguestfs: error: error: domain is a live virtual machine.
Writing to the disks of a running virtual machine can cause disk corruption.
Either use read-only access, or if the guest is running the guestfsd daemon
specify live access. In most libguestfs tools these options are --ro or
--live respectively. Consult the documentation for further information.

[root@centos8 ~]#virsh destroy centos7
Domain centos7 destroyed

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36873;&#39033;-i &#21487;&#20197;&#23454;&#29616;&#33258;&#21160;&#25506;&#26597;&#21518;&#36827;&#34892;&#33258;&#21160;&#25346;&#36733;</span>
[root@centos8 ~]#guestfish --ro -a /var/lib/libvirt/images/centos7.qcow2 -i
Welcome to guestfish, the guest filesystem shell for
editing virtual machine filesystems and disk images.
Type: &#8216;help&#8217; for help on commands
        &#8216;man&#8217; to read the manual
        &#8216;quit&#8217; to quit the shell
Operating system: CentOS Linux release 7.8.2003 (Core)
/dev/centos/root mounted on /
/dev/sda1 mounted on /boot
&gt;&lt;fs&gt; ls /
bin
boot
dev
etc
home
lib
lib64
media
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a29dd0a8-c610-4850-b733-d37c7938c030" class="outline-5">
<h5 id="h:a29dd0a8-c610-4850-b733-d37c7938c030">guestfs 离线修改虚拟磁盘内的文件</h5>
<div class="outline-text-5" id="text-h:a29dd0a8-c610-4850-b733-d37c7938c030">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#35835;&#20889;&#26041;&#24335;&#25171;&#24320;&#34394;&#25311;&#30913;&#30424;</span>
[root@centos8 ~]#guestfish -d centos7 -i
Welcome to guestfish, the guest filesystem shell for
editing virtual machine filesystems and disk images.
Type: &#8216;help&#8217; for help on commands
        &#8216;man&#8217; to read the manual
        &#8216;quit&#8217; to quit the shell
Operating system: CentOS Linux release 7.8.2003 (Core)
/dev/centos/root mounted on /
/dev/sda1 mounted on /boot
&gt;&lt;fs&gt; edit /etc/issue     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35843;&#29992;vi&#25171;&#24320;&#20462;&#25913;&#25991;&#20214;</span>
welcomt to me
\S                                                                                                                                                         

Kernel \r on an \m
&gt;&lt;fs&gt; exit
[root@centos8 ~]#virsh start centos7
Domain centos7 started
</pre>
</div>


<figure id="orge01ae2d">
<img src="images/image-20210223144007403.png" alt="image-20210223144007403.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:b717cebe-87b2-4cef-aa81-069c899cbc6d" class="outline-4">
<h4 id="h:b717cebe-87b2-4cef-aa81-069c899cbc6d">其它离线工具</h4>
<div class="outline-text-4" id="text-h:b717cebe-87b2-4cef-aa81-069c899cbc6d">
<div class="org-src-container">
<pre class="src src-sh">virt-df              <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30417;&#35270;&#30913;&#30424;&#20351;&#29992;</span>
virt-resize      <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31163;&#32447;&#35843;&#25972;&#34394;&#25311;&#30913;&#30424;&#22823;&#23567;</span>
virt-inspector <span style="color: #b22222;">#</span><span style="color: #b22222;">&#34394;&#25311;&#26426;&#26816;&#35270;</span>
virt-win-reg   <span style="color: #b22222;">#</span><span style="color: #b22222;">Windows&#27880;&#20876;&#34920;&#35835;&#21462;&#21644;&#20462;&#25913;</span>
virt-sysprep   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#34394;&#25311;&#26426;&#35774;&#32622;&#37325;&#32622;</span>
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:4e0ca775-b0fe-41a8-8657-47b2ba66ad95" class="outline-2">
<h2 id="h:4e0ca775-b0fe-41a8-8657-47b2ba66ad95">网络管理(重要)</h2>
<div class="outline-text-2" id="text-h:4e0ca775-b0fe-41a8-8657-47b2ba66ad95">
<p>
官方文档: <a href="https://wiki.libvirt.org/page/VirtualNetworking">https://wiki.libvirt.org/page/VirtualNetworking</a>
</p>

<ul class="org-ul">
<li>虚拟机间互相通信、跨缩主机虚拟机之间的通信</li>
</ul>
</div>
<div id="outline-container-h:ccbf294c-eb94-42ed-a4dc-dfa50aa667ed" class="outline-3">
<h3 id="h:ccbf294c-eb94-42ed-a4dc-dfa50aa667ed">Linux 网桥实现</h3>
<div class="outline-text-3" id="text-h:ccbf294c-eb94-42ed-a4dc-dfa50aa667ed">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#32593;&#26725;</span>
nmcli con add type bridge con-name br0 ifname br0
nmcli connection modify br0 ipv4.addresses 10.0.0.100/24 ipv4.method manual
nmcli con up br0

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#20837;&#29289;&#29702;&#32593;&#21345;</span>
nmcli con add type bridge-slave con-name br0-port0 ifname eth0 master br0
nmcli con add type bridge-slave con-name br0-port1 ifname eth1 master br0
nmcli con up br0-port0
nmcli con up br0-port1

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#32593;&#26725;&#37197;&#32622;&#25991;&#20214;</span>
cat /etc/sysconfig/network-scripts/ifcfg-br0
<span style="color: #a0522d;">DEVICE</span>=br0
<span style="color: #a0522d;">NAME</span>=br0
<span style="color: #a0522d;">STP</span>=yes
<span style="color: #a0522d;">TYPE</span>=Bridge
<span style="color: #a0522d;">BOOTPROTO</span>=static
<span style="color: #a0522d;">IPADDR</span>=10.0.0.100
<span style="color: #a0522d;">PREFIX</span>=24

cat /etc/sysconfig/network-scripts/ifcfg-br0-port0
<span style="color: #a0522d;">TYPE</span>=Ethernet
<span style="color: #a0522d;">NAME</span>=br0-port0
<span style="color: #a0522d;">DEVICE</span>=eth0
<span style="color: #a0522d;">ONBOOT</span>=yes
<span style="color: #a0522d;">BRIDGE</span>=br0
<span style="color: #a0522d;">UUID</span>=23f41d3b-b57c-4e26-9b17-d5f02dafd12d

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;&#31649;&#29702;&#36719;&#20214;&#21253;,&#27880;&#24847;:CentOS8&#21462;&#28040;&#20102;&#27492;&#21253;</span>
yum install bridge-utils

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#32593;&#26725;</span>
brctl show
ip link show master br0
bridge link show

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21024;&#38500;br0</span>
nmcli con down br0
rm /etc/sysconfig/network-scripts/ifcfg-br0*
nmcli con reload
</pre>
</div>
</div>
</div>
<div id="outline-container-h:29937bc9-a882-41ce-a51d-36987c94782c" class="outline-3">
<h3 id="h:29937bc9-a882-41ce-a51d-36987c94782c">qemu-kvm支持的网络</h3>
<div class="outline-text-3" id="text-h:29937bc9-a882-41ce-a51d-36987c94782c">
<p>
虚拟机的网络模式:
</p>

<ul class="org-ul">
<li>基于NAT ( Network Addresss Translation)的虚拟网络,此为virt-install的默认模式</li>
<li>基于自定义网桥（Bridge ）的虚拟网络</li>
<li>用户自定义的隔离的虚拟网络</li>
<li>直接分配物理网络设备（包括VT-d和SR-IOV),性能最好</li>
</ul>

<p>
虚拟机的网卡设备:
</p>

<ul class="org-ul">
<li>RTL8139、e1000、&#x2026;.</li>
<li>virtio 生产建议使用</li>
</ul>

<p>
范例: 查看qemu-kvm支持的网卡型号
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#/usr/libexec/qemu-kvm -net nic,<span style="color: #a0522d;">model</span>=?
qemu: Supported NIC models: e1000,e1000-82540em,e1000e,rtl8139,virtio-net-pci
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7493232c-2a3c-4666-b24e-82cc02980d14" class="outline-3">
<h3 id="h:7493232c-2a3c-4666-b24e-82cc02980d14">默认的网络配置NAT模式</h3>
<div class="outline-text-3" id="text-h:7493232c-2a3c-4666-b24e-82cc02980d14">
</div>
<div id="outline-container-h:02043572-2c5f-404a-8621-9c208fdd4287" class="outline-4">
<h4 id="h:02043572-2c5f-404a-8621-9c208fdd4287">默认网络连接的架构图</h4>
<div class="outline-text-4" id="text-h:02043572-2c5f-404a-8621-9c208fdd4287">
<p>
默认虚拟机网络配置为NAT模式,相当于vmware的NAT模式的Vmnet8
</p>
</div>
</div>
<div id="outline-container-h:9096afd4-f6df-4bf6-9313-ca619ae09fd9" class="outline-4">
<h4 id="h:9096afd4-f6df-4bf6-9313-ca619ae09fd9">宿主机默认网络相关服务和信息</h4>
<div class="outline-text-4" id="text-h:9096afd4-f6df-4bf6-9313-ca619ae09fd9">
<p>
默认宿主机安装dnsmasq包指供DHCP服务
</p>


<figure id="org47a85cb">
<img src="images/image-20210223144024843.png" alt="image-20210223144024843.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#32553;&#20027;&#26426;&#26159;&#21542;&#26159;dhcp&#33719;&#21462;ip</span>
~]# nmcli con show
NAME      UUID
enp1s0    xxxxx

~]# nmcli con show enp1s0
.....
ipv4.method    auto
ipv6.method    auto

~]# ss -tnul |grep 67
  0.0.0.0%virbr0:67

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#32553;&#20027;&#26426;&#26159;&#21542;&#23433;&#35013;&#20102;dhcp&#26381;&#21153;</span>
~]# rpm -q dhcp
package dhcp is not installed   

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#30417;&#25511;67&#31471;&#21475;&#30340;&#31243;&#24207;&#26159;dnsmasq, &#23427;&#26159;&#31616;&#21270;&#29256;&#26412;&#30340;dhcp&#21644;dns&#32508;&#21512;&#20307;</span>
~]# ss -tnulp |grep 67
<span style="color: #8b2252;">"dnsmasq"</span>   0.0.0.0%virbr0:67
</pre>
</div>

<p>
查看虚拟机的ip地址范围
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#rpm -q dnsmasq
dnsmasq-2.79-11.el8.x86_64
[root@centos8 ~]#cat /var/lib/libvirt/dnsmasq/default.conf
<span style="color: #b22222;">##</span><span style="color: #b22222;">WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE</span>
<span style="color: #b22222;">##</span><span style="color: #b22222;">OVERWRITTEN AND LOST. Changes to this configuration should be made using:</span>
<span style="color: #b22222;">##     </span><span style="color: #b22222;">virsh net-edit default</span>
<span style="color: #b22222;">## </span><span style="color: #b22222;">or other application using the libvirt API.</span>
<span style="color: #b22222;">##</span>
<span style="color: #b22222;">## </span><span style="color: #b22222;">dnsmasq conf file created by libvirt</span>
strict-order
pid-file=/var/run/libvirt/network/default.pid
except-interface=lo
bind-dynamic
<span style="color: #a0522d;">interface</span>=virbr0
dhcp-range=192.168.122.2,192.168.122.254
dhcp-no-override
dhcp-authoritative
dhcp-lease-max=253
dhcp-hostsfile=/var/lib/libvirt/dnsmasq/default.hostsfile
addn-hosts=/var/lib/libvirt/dnsmasq/default.addnhosts
</pre>
</div>

<p>
范例: 查看宿主机的网桥信息
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh list --all
Id     Name                                                     State
----------------------------------------------------
-         centos7                                             shut off
-         centos7-2                                         shut off
-         centos8                                             shut off
-         Win_2008_r2-x86_64                         shut off
[root@centos8 ~]#ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group
default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
            valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
            valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP
group default qlen 1000
    link/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0
            valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe44:c3fe/64 scope link
            valid_lft forever preferred_lft forever
3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN
group default qlen 1000
    link/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
            valid_lft forever preferred_lft forever
4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state
DOWN group default qlen 1000
    link/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff
[root@centos8 ~]#virsh list
Id     Name                                                     State
----------------------------------------------------
2         centos7                                             running
3         centos8                                             running
[root@centos8 ~]#virsh start centos7
Domain centos7 started
[root@centos8 ~]#virsh start centos8
Domain centos8 started
[root@centos8 ~]#ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group
default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
            valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
            valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP
group default qlen 1000
    link/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0
            valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe44:c3fe/64 scope link
            valid_lft forever preferred_lft forever
3: virbr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP
group default qlen 1000
    link/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
            valid_lft forever preferred_lft forever
4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state
DOWN group default qlen 1000
    link/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff
6: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master
virbr0 state UNKNOWN group default qlen 1000
    link/ether fe:54:00:95:25:fb brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe95:25fb/64 scope link
            valid_lft forever preferred_lft forever
7: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master
virbr0 state UNKNOWN group default qlen 1000
    link/ether fe:54:00:83:9d:51 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe83:9d51/64 scope link
            valid_lft forever preferred_lft forever


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;virbr0&#32593;&#32476;&#30340;&#24773;&#20917;&#65292; virbr0&#20013;&#30340;&#25104;&#21592;</span>
[root@centos8 ~]#ip link show master virbr0
4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state
DOWN mode DEFAULT group default qlen 1000
    link/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff
8: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master
virbr0 state UNKNOWN mode DEFAULT group default qlen 1000
    link/ether fe:54:00:95:25:fb brd ff:ff:ff:ff:ff:ff
9: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master
virbr0 state UNKNOWN mode DEFAULT group default qlen 1000
    link/ether fe:54:00:83:9d:51 brd ff:ff:ff:ff:ff:ff

<span style="color: #b22222;">#</span><span style="color: #b22222;">centos7 &#26597;&#30475;virbr0&#32593;&#32476;&#30340;&#24773;&#20917;&#65292; virbr0&#20013;&#30340;&#25104;&#21592;   brctl show</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#25152;&#26377;&#26725;&#25509;&#32593;&#21345;&#20449;&#24687;&#21450;&#23545;&#24212;&#32593;&#26725;</span>
[root@centos8 ~]#bridge link show
4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master virbr0 state disabled priority 32 cost 100
8: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr0 state forwarding priority 32 cost 100
9: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr0 state forwarding priority 32 cost 100

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23383;&#31526;&#30028;&#38754;&#26597;&#30475;&#32593;&#26725;&#25104;&#21592;&#20449;&#24687;</span>
[root@centos8 ~]#nmtui
</pre>
</div>



<figure id="org5f88b13">
<img src="images/image-20210223144055914.png" alt="image-20210223144055914.png">

</figure>


<figure id="org69359bb">
<img src="images/image-20210223144107687.png" alt="image-20210223144107687.png">

</figure>


<figure id="org2b4f58c">
<img src="images/image-20210223144117530.png" alt="image-20210223144117530.png">

</figure>


<figure id="orgaaa20a2">
<img src="images/image-20210223144128647.png" alt="image-20210223144128647.png">

</figure>


<figure id="org0f1a902">
<img src="images/image-20210223144134440.png" alt="image-20210223144134440.png">

</figure>


<figure id="org6fc2c53">
<img src="images/image-20210223144143168.png" alt="image-20210223144143168.png">

</figure>

<p>
默认创建的虚拟机的网络连接是基于NAT模式的，NAT模式并不适合于生产环境使用。
</p>

<p>
NAT模式虚拟机能访问外网，但外部访问不了虚拟机。无法跨缩主机通信
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh net-list
Name                                 State         Autostart         Persistent
----------------------------------------------------------
default                         active         yes                     yes

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;NAT&#27169;&#24335;</span>
[root@centos8 ~]#cat /etc/libvirt/qemu/networks/default.xml
&lt;!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
virsh net-edit default
or other application using the libvirt API.
--&gt;
&lt;network&gt;
&lt;name&gt;default&lt;/name&gt;
&lt;uuid&gt;5962db15-2851-4825-b516-9bc2eb4d9ee0&lt;/uuid&gt;
&lt;forward <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">'nat'</span>/&gt;
&lt;bridge <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'virbr0'</span> <span style="color: #a0522d;">stp</span>=<span style="color: #8b2252;">'on'</span> <span style="color: #a0522d;">delay</span>=<span style="color: #8b2252;">'0'</span>/&gt;
&lt;mac <span style="color: #a0522d;">address</span>=<span style="color: #8b2252;">'52:54:00:52:f2:5c'</span>/&gt;
&lt;ip <span style="color: #a0522d;">address</span>=<span style="color: #8b2252;">'192.168.122.1'</span> <span style="color: #a0522d;">netmask</span>=<span style="color: #8b2252;">'255.255.255.0'</span>&gt;
    &lt;dhcp&gt;
        &lt;range <span style="color: #a0522d;">start</span>=<span style="color: #8b2252;">'192.168.122.2'</span> <span style="color: #a0522d;">end</span>=<span style="color: #8b2252;">'192.168.122.254'</span>/&gt;
    &lt;/dhcp&gt;
&lt;/ip&gt;
&lt;/network&gt;

[root@centos8 ~]#virsh net-dumpxml default
&lt;network <span style="color: #a0522d;">connections</span>=<span style="color: #8b2252;">'1'</span>&gt;
&lt;name&gt;default&lt;/name&gt;
&lt;uuid&gt;5962db15-2851-4825-b516-9bc2eb4d9ee0&lt;/uuid&gt;
&lt;forward <span style="color: #a0522d;">mode</span>=<span style="color: #8b2252;">'nat'</span>&gt;
    &lt;nat&gt;
        &lt;port <span style="color: #a0522d;">start</span>=<span style="color: #8b2252;">'1024'</span> <span style="color: #a0522d;">end</span>=<span style="color: #8b2252;">'65535'</span>/&gt;
    &lt;/nat&gt;
&lt;/forward&gt;
&lt;bridge <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'virbr0'</span> <span style="color: #a0522d;">stp</span>=<span style="color: #8b2252;">'on'</span> <span style="color: #a0522d;">delay</span>=<span style="color: #8b2252;">'0'</span>/&gt;
&lt;mac <span style="color: #a0522d;">address</span>=<span style="color: #8b2252;">'52:54:00:52:f2:5c'</span>/&gt;
&lt;ip <span style="color: #a0522d;">address</span>=<span style="color: #8b2252;">'192.168.122.1'</span> <span style="color: #a0522d;">netmask</span>=<span style="color: #8b2252;">'255.255.255.0'</span>&gt;
    &lt;dhcp&gt;
        &lt;range <span style="color: #a0522d;">start</span>=<span style="color: #8b2252;">'192.168.122.2'</span> <span style="color: #a0522d;">end</span>=<span style="color: #8b2252;">'192.168.122.254'</span>/&gt;
    &lt;/dhcp&gt;
&lt;/ip&gt;
&lt;/network&gt;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;NAT&#31574;&#30053;&#23454;&#29616;&#20174;&#34394;&#25311;&#26426;&#21487;&#20197;&#35775;&#38382;&#22806;&#37096;&#32593;&#32476;,&#21453;&#20043;&#19981;&#36890;,&#27492;&#31574;&#30053;&#30001;libvirtd&#26381;&#21153;&#21551;&#21160;&#26102;&#33258;&#21160;&#21152;&#36733;&#21040;NAT&#34920;</span>
[root@centos8 ~]#iptables -vnL -t nat
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target         prot opt<span style="color: #a020f0;"> in</span>         out         source                             destination

Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target         prot opt<span style="color: #a020f0;"> in</span>         out         source                             destination

Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target         prot opt<span style="color: #a020f0;"> in</span>         out         source                             destination

        0         0 RETURN         all     -- *         *             192.168.122.0/24         224.0.0.0/24

        0         0 RETURN         all     -- *         *             192.168.122.0/24     255.255.255.255     
        0         0 MASQUERADE tcp     -- *         *             192.168.122.0/24  !192.168.122.0/24         masq ports: 1024-65535
        8     608 MASQUERADE udp     -- *         *             192.168.122.0/24  !192.168.122.0/24         masq ports: 1024-65535
        1         84 MASQUERADE all     -- *         *             192.168.122.0/24  !192.168.122.0/24     
Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
pkts bytes target         prot opt<span style="color: #a020f0;"> in</span>         out         source                             destination
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cb2a2078-d85c-4f01-9bbf-12e385905a2e" class="outline-4">
<h4 id="h:cb2a2078-d85c-4f01-9bbf-12e385905a2e">虚拟机网卡默认设置</h4>
<div class="outline-text-4" id="text-h:cb2a2078-d85c-4f01-9bbf-12e385905a2e">

<figure id="orgf1415ab">
<img src="images/image-20210223144200054.png" alt="image-20210223144200054.png">

</figure>


<figure id="org02c19d4">
<img src="images/image-20210223144207279.png" alt="image-20210223144207279.png">

</figure>


<figure id="org07a93e3">
<img src="images/image-20210223144214612.png" alt="image-20210223144214612.png">

</figure>


<figure id="org9d4a412">
<img src="images/image-20210223144221359.png" alt="image-20210223144221359.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh dumpxml centos7 |sed -n <span style="color: #8b2252;">'/interface/,/interface/p'</span>
    &lt;interface <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'network'</span>&gt;
        &lt;mac <span style="color: #a0522d;">address</span>=<span style="color: #8b2252;">'52:54:00:95:25:fb'</span>/&gt;
        &lt;source <span style="color: #a0522d;">network</span>=<span style="color: #8b2252;">'default'</span> <span style="color: #a0522d;">bridge</span>=<span style="color: #8b2252;">'virbr0'</span>/&gt;
        &lt;target <span style="color: #a0522d;">dev</span>=<span style="color: #8b2252;">'vnet0'</span>/&gt;
        &lt;model <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'virtio'</span>/&gt;
        &lt;alias <span style="color: #a0522d;">name</span>=<span style="color: #8b2252;">'net0'</span>/&gt;
        &lt;address <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">'pci'</span> <span style="color: #a0522d;">domain</span>=<span style="color: #8b2252;">'0x0000'</span> <span style="color: #a0522d;">bus</span>=<span style="color: #8b2252;">'0x00'</span> <span style="color: #a0522d;">slot</span>=<span style="color: #8b2252;">'0x03'</span>
<span style="color: #a0522d;">function</span>=<span style="color: #8b2252;">'0x0'</span>/&gt;
    &lt;/interface&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:24b3f7a1-6d31-4f10-9cb5-fce61298f67e" class="outline-4">
<h4 id="h:24b3f7a1-6d31-4f10-9cb5-fce61298f67e">virsh 查看虚拟机网络配置</h4>
<div class="outline-text-4" id="text-h:24b3f7a1-6d31-4f10-9cb5-fce61298f67e">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#34394;&#25311;&#26426;&#30340;&#32593;&#21345;&#37197;&#32622;</span>
[root@centos8 ~]#virsh domiflist centos8
Interface Type             Source         Model             MAC
-------------------------------------------------------
vnet0         network     default     virtio             52:54:00:83:9d:51

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#34394;&#25311;&#26426;&#30340;&#32593;&#21345;&#22320;&#22336;&#20449;&#24687;</span>
[root@centos8 ~]#virsh domifaddr centos8
Name             MAC address                 Protocol         Address
-------------------------------------------------------------------------------
vnet0             52:54:00:83:9d:51     ipv4                 192.168.122.94/24

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#34394;&#25311;&#26426;&#30340;&#25351;&#23450;&#32593;&#21345;&#30340;&#29366;&#24577;</span>
[root@centos8 ~]#virsh domifstat centos8 vnet0
vnet0 rx_bytes 39672
vnet0 rx_packets 739
vnet0 rx_errs 0
vnet0 rx_drop 0
vnet0 tx_bytes 1742
vnet0 tx_packets 19
vnet0 tx_errs 0
vnet0 tx_drop 0
</pre>
</div>
</div>
</div>
<div id="outline-container-h:78866714-be05-4882-96f9-486ef36cf613" class="outline-4">
<h4 id="h:78866714-be05-4882-96f9-486ef36cf613">向虚拟机添加虚拟网络连接</h4>
<div class="outline-text-4" id="text-h:78866714-be05-4882-96f9-486ef36cf613">
<p>
打开virt-manager添加网卡
</p>

<p>
模式有：
</p>
<ul class="org-ul">
<li>NAT</li>
<li>Routed</li>
<li>Open</li>
<li>Isolated</li>
<li>SR-IOV pool</li>
</ul>


<figure id="orga4a5f46">
<img src="images/image-20210223144237239.png" alt="image-20210223144237239.png">

</figure>


<figure id="org7e6eaaa">
<img src="images/image-20210223144244887.png" alt="image-20210223144244887.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:564d25d8-1444-4f09-8cf2-fff05fc08f61" class="outline-3">
<h3 id="h:564d25d8-1444-4f09-8cf2-fff05fc08f61">配置虚拟机网卡桥接到宿主机的物理网卡</h3>
<div class="outline-text-3" id="text-h:564d25d8-1444-4f09-8cf2-fff05fc08f61">
<p>
相当于vmware的桥接模式的Vmnet0
</p>

<p>
在虚拟机配置中找到网卡 NIC:xxx , 修改Network source 主 Host device eth0: mactap，
选择Bridge桥接。重启虚拟机生效。
</p>

<p>
进入到虚拟机可以看到获取缩主机桥接的地址
</p>

<div class="org-src-container">
<pre class="src src-sh">ip a
10.0.0.150

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23601;&#21487;&#20197;&#21644;&#20854;&#20182;&#32553;&#20027;&#26426;&#36890;&#20449;&#20102;</span>
ping 10.0.0.7
</pre>
</div>



<figure id="org8a03ad3">
<img src="images/image-20210223144254279.png" alt="image-20210223144254279.png">

</figure>


<figure id="org2adf5d1">
<img src="images/image-20210223144301936.png" alt="image-20210223144301936.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#virsh domiflist centos7
Interface Type             Source         Model             MAC
-------------------------------------------------------
macvtap0     direct         eth0             virtio             52:54:00:95:25:fb

[root@centos8 ~]#virsh domifaddr centos7
Name             MAC address                 Protocol         Address
</pre>
</div>


<figure id="org036adff">
<img src="images/image-20210223144311766.png" alt="image-20210223144311766.png">

</figure>

<p>
在宿主机上自动生成虚拟网卡macvtap0@eth0
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP
group default qlen 1000
    link/ether 00:0c:29:e1:0e:53 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute eth0
            valid_lft forever preferred_lft forever
3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN
group default qlen 1000
    link/ether 52:54:00:8b:be:ee brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
            valid_lft forever preferred_lft forever
4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state
DOWN group default qlen 1000
    link/ether 52:54:00:8b:be:ee brd ff:ff:ff:ff:ff:ff
6: macvtap0@eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel
state UP group default qlen 500
    link/ether 52:54:00:0d:8a:0e brd ff:ff:ff:ff:ff:ff
    inet6 fe80::5054:ff:fe0d:8a0e/64 scope link
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e14a4be5-540c-4825-96eb-6d52a6cdc55d" class="outline-3">
<h3 id="h:e14a4be5-540c-4825-96eb-6d52a6cdc55d">基于自定义网桥的虚拟网络</h3>
<div class="outline-text-3" id="text-h:e14a4be5-540c-4825-96eb-6d52a6cdc55d">
</div>
<div id="outline-container-h:ffa56881-a5f9-4a97-8cc5-21169a306cea" class="outline-4">
<h4 id="h:ffa56881-a5f9-4a97-8cc5-21169a306cea">自定义网桥架构</h4>
<div class="outline-text-4" id="text-h:ffa56881-a5f9-4a97-8cc5-21169a306cea">
<p>
桥接网络可以让运行在宿主机上的虚拟机使用和宿主机相同网段的IP，并且可以从外部直接访问到虚拟机，目前企业中大部分场景都使用桥接网络。
</p>


<figure id="org52c03de">
<img src="images/image-20210223144326569.png" alt="image-20210223144326569.png">

</figure>
</div>
</div>
<div id="outline-container-h:a26f882c-e9f5-439e-987e-b175ce92cea1" class="outline-4">
<h4 id="h:a26f882c-e9f5-439e-987e-b175ce92cea1">创建虚拟机PXE启动并利用kickstart自动安装系统</h4>
<div class="outline-text-4" id="text-h:a26f882c-e9f5-439e-987e-b175ce92cea1">
</div>
<div id="outline-container-h:728f5ad7-abfa-40da-846d-82a9761fc030" class="outline-5">
<h5 id="h:728f5ad7-abfa-40da-846d-82a9761fc030">在宿主机准备PXE环境</h5>
<div class="outline-text-5" id="text-h:728f5ad7-abfa-40da-846d-82a9761fc030">

<figure id="org850952b">
<img src="images/image-20210223144334678.png" alt="image-20210223144334678.png">

</figure>

<p>
<b>注意: 取消vmnet8的DHCP功能</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dnf -y install dhcp-server tftp-server httpd syslinux-nonlinux
[root@centos8 ~]#systemctl enable --now httpd tftp dhcpd

[root@centos8 ~]#cat /etc/dhcp/dhcpd.conf
option domain-name <span style="color: #8b2252;">"me.org"</span>;
option domain-name-servers 180.76.76.76,223.6.6.6;
default-lease-time 600;
max-lease-time 7200;
log-facility local7;
subnet 10.0.0.0 netmask 255.255.255.0 {
range 10.0.0.100 10.0.0.200;
option routers 10.0.0.2;
next-server 10.0.0.8;
filename <span style="color: #8b2252;">"pxelinux.0"</span>;
}

[root@centos8 ~]#systemctl start dhcpd

[root@centos8 ~]#mkdir /var/lib/tftpboot/centos{6,7,8}
[root@centos8 ~]#cp /usr/share/syslinux/{pxelinux.0,menu.c32}  /var/lib/tftpboot/
[root@centos8 ~]#cp /var/www/html/centos/8/os/x86_64/isolinux/{vmlinuz,initrd.img}  /var/lib/tftpboot/centos8
[root@centos8 ~]#cp /var/www/html/centos/8/os/x86_64/isolinux/{ldlinux.c32,libcom32.c32,libutil.c32}  /var/lib/tftpboot/
[root@centos8 ~]#mkdir /var/lib/tftpboot/pxelinux.cfg/
[root@centos8 ~]#cp /var/www/html/centos/8/os/x86_64/isolinux/isolinux.cfg /var/lib/tftpboot/pxelinux.cfg/default

[root@centos8 ~]#cat /var/lib/tftpboot/pxelinux.cfg/default
default menu.c32
timeout 600
menu title Install CentOS Linux

label linux8
  menu default
  menu label Auto Install CentOS Linux ^8
  kernel centos8/vmlinuz
  append <span style="color: #a0522d;">initrd</span>=centos8/initrd.img <span style="color: #a0522d;">ks</span>=http://10.0.0.8/ks/centos8.cfg

label manual
  menu label ^Manual Install CentOS Linux 8.0
  kernel centos8/vmlinuz
  append <span style="color: #a0522d;">initrd</span>=centos8/initrd.img inst.repo=http://10.0.0.8/centos/8/os/x86_64/

label rescue
  menu label ^Rescue a CentOS Linux system 8
  kernel centos8/vmlinuz
  append <span style="color: #a0522d;">initrd</span>=centos8/initrd.img inst.repo=http://10.0.0.8/centos/8/os/x86_64/ rescue

label local
  menu label Boot from ^local drive
  localboot 0xffff

[root@centos8 ~]#tree /var/lib/tftpboot/
/var/lib/tftpboot/
&#9500;&#9472;&#9472; centos6
&#9500;&#9472;&#9472; centos7
&#9500;&#9472;&#9472; centos8
&#9474;        &#9500;&#9472;&#9472; initrd.img
&#9474;        &#9492;&#9472;&#9472; vmlinuz
&#9500;&#9472;&#9472; ldlinux.c32
&#9500;&#9472;&#9472; libcom32.c32
&#9500;&#9472;&#9472; libutil.c32
&#9500;&#9472;&#9472; menu.c32
&#9500;&#9472;&#9472; pxelinux.0
&#9492;&#9472;&#9472; pxelinux.cfg
    &#9492;&#9472;&#9472; default
4 directories, 8 files

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24212;&#31572;&#25991;&#20214;</span>
[root@centos8 ~]#cat /var/www/html/ks/centos8.cfg
ignoredisk --only-use=vda     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22240;&#20026;&#20351;&#29992;virtIO&#30913;&#30424;,&#27880;&#24847;&#30913;&#30424;&#21517;&#31216;&#20026;vda</span>
zerombr
text
reboot
clearpart --all --initlabel
selinux --disabled
firewall --disabled
url --url=http://10.0.0.8/centos/8/os/x86_64/
keyboard --vckeymap=us --xlayouts=<span style="color: #8b2252;">'us'</span>
lang en_US.UTF-8

bootloader --append=<span style="color: #8b2252;">"net.ifnames=0"</span> --location=mbr --boot-drive=vda     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22240;&#20026;&#20351;&#29992;virtIO&#30913;&#30424;,&#27880;&#24847;&#30913;&#30424;&#21517;&#31216;&#20026;vda</span>
network     --bootproto=dhcp --device=eth0 --ipv6=auto --activate

network     --hostname=centos8.me.org
rootpw --iscrypted
$<span style="color: #a0522d;">6</span>$<span style="color: #a0522d;">j9YhzDUnQVnxaAk8</span>$<span style="color: #a0522d;">qv7rkMcPAEbV5yvwsP666DXWYadd3jYjkA9fpxAo9qYotjGGBUclCGoP1TRvgHBpqgc5n0RypMsPTQnVDcpO01</span>
firstboot --enable
skipx
services --disabled=<span style="color: #8b2252;">"chronyd"</span>
timezone Asia/Shanghai --isUtc --nontp
user --name=wang --password=6oUfb/02CWfLb5l8f$<span style="color: #a0522d;">sgEZeR7c7DpqfpmFDH6huSmDbW1XQNR4qKl2EPns</span>.gOXqlnAIgv9pTogtFVaDtEpMOC.SWXKYqxfVtd9MCwxb1 --iscrypted --gecos=<span style="color: #8b2252;">"wang"</span>

autopart --type=lvm
%packages
@^minimal-environment
kexec-tools
%end
%addon com_redhat_kdump --enable --reserve-mb=<span style="color: #8b2252;">'auto'</span>
%end
%anaconda
pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty
pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok
pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty
%end

%post
useradd tester
<span style="color: #483d8b;">echo</span> me | passwd --stdin tester &amp;&gt; /dev/null
%end
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9a6118d0-2072-4fa3-a1cc-c32da20e926e" class="outline-5">
<h5 id="h:9a6118d0-2072-4fa3-a1cc-c32da20e926e">在宿主机创建网桥</h5>
<div class="outline-text-5" id="text-h:9a6118d0-2072-4fa3-a1cc-c32da20e926e">
</div>
<ul class="org-ul">
<li><a id="h:04500013-2dff-4f06-bc69-344daba473ec"></a>CentOS 创建桥接网卡<br>
<div class="outline-text-6" id="text-h:04500013-2dff-4f06-bc69-344daba473ec">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 network-scripts]#pwd
/etc/sysconfig/network-scripts

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#32593;&#26725;&#37197;&#32622;&#25991;&#20214;</span>
[root@centos8 network-scripts]#cat ifcfg-virbr1
<span style="color: #a0522d;">TYPE</span>=Bridge
<span style="color: #a0522d;">NAME</span>=virbr1
<span style="color: #a0522d;">DEVICE</span>=virbr1
<span style="color: #a0522d;">ONBOOT</span>=yes
<span style="color: #a0522d;">BOOTPROTO</span>=static
<span style="color: #a0522d;">IPADDR</span>=10.0.0.8
<span style="color: #a0522d;">NETMASK</span>=255.255.255.0
<span style="color: #a0522d;">GATEWAY</span>=10.0.0.2
<span style="color: #a0522d;">DNS1</span>=180.76.76.76
<span style="color: #a0522d;">DNS2</span>=223.6.6.6

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#29289;&#29702;&#32593;&#21345;eth0&#21152;&#20837;&#32593;&#26725;</span>
[root@centos8 network-scripts]#cat ifcfg-eth0
<span style="color: #a0522d;">TYPE</span>=Ethernet
<span style="color: #a0522d;">NAME</span>=eth0
<span style="color: #a0522d;">DEVICE</span>=eth0
<span style="color: #a0522d;">ONBOOT</span>=yes
<span style="color: #a0522d;">BRIDGE</span>=virbr1

[root@centos8 network-scripts]#nmcli connection reload
[root@centos8 network-scripts]#nmcli connection up eth0 virbr1

[root@centos8 ~]#ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group
default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
            valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
            valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr1
state UP group default qlen 1000
    link/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff
4: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN
group default qlen 1000
    link/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
            valid_lft forever preferred_lft forever
5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state
DOWN group default qlen 1000
    link/ether 52:54:00:52:f2:5c brd ff:ff:ff:ff:ff:ff
18: virbr1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP
group default qlen 1000
    link/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute virbr1
            valid_lft forever preferred_lft forever
    inet6 fe80::8055:c0ff:fe4e:411e/64 scope link
            valid_lft forever preferred_lft forever
[root@centos8 ~]#bridge link show
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr1 state
forwarding priority 32 cost 100
5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master virbr0 state disabled
priority 32 cost 100
[root@centos8 ~]#ip link show master virbr1
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr1
state UP mode DEFAULT group default qlen 1000
    link/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff
</pre>
</div>
</div>
</li>
<li><a id="h:eac4e22f-0339-450b-b7ad-0cc9732d0937"></a>Ubuntu 创建桥接网卡<br>
<div class="outline-text-6" id="text-h:eac4e22f-0339-450b-b7ad-0cc9732d0937">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">cat /etc/netplan/01-netcfg.yaml</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">This file describes the network interfaces available on your system</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">For more information, see netplan(5).</span>
network:
version: 2
renderer: networkd
ethernets:
    eth0:
        dhcp4: no
        dhcp6: no
    bridges:
            br0:
        dhcp4: no
        dhcp6: no
        addresses: [10.0.0.100/16]
        gateway4: 10.0.0.2
        nameservers:
            addresses: [223.6.6.6]
        interfaces:
            - eth0
</pre>
</div>
</div>
</li>
<li><a id="h:44d0691b-5228-4243-b37d-28e5969e32d9"></a>使用virt-manager创建网桥<br>
<div class="outline-text-6" id="text-h:44d0691b-5228-4243-b37d-28e5969e32d9">

<figure id="org507b3b0">
<img src="images/image-20210223144402138.png" alt="image-20210223144402138.png">

</figure>

<p>
注意:CentOS8 取消了此功能,以下图示为CentOS8 的virt-manager界面
</p>


<figure id="org5792f3f">
<img src="images/image-20210223144412464.png" alt="image-20210223144412464.png">

</figure>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:d308aa30-e122-4a95-9476-cc0ed57bfb53" class="outline-5">
<h5 id="h:d308aa30-e122-4a95-9476-cc0ed57bfb53">创建桥接自定网桥的虚拟机基于PXE启动并利用kickstart自动安装系统</h5>
<div class="outline-text-5" id="text-h:d308aa30-e122-4a95-9476-cc0ed57bfb53">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#30913;&#30424;</span>
[root@centos8 ~]#qemu-img create -f qcow2 /var/lib/libvirt/images/centos8-pxe.qcow2 10G

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#25509;&#33258;&#23450;&#32593;&#26725;&#30340;&#34394;&#25311;&#26426;</span>
[root@centos8 ~]#virt-install --virt-type kvm --name centos8-pxe --ram 2048 --vcpus 2 --disk <span style="color: #a0522d;">bus</span>=virtio,<span style="color: #a0522d;">path</span>=/var/lib/libvirt/images/centos8-pxe.qcow2     --graphics vnc,<span style="color: #a0522d;">listen</span>=0.0.0.0 --network=bridge:virbr1,<span style="color: #a0522d;">model</span>=virtio --pxe
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f172a457-7ed0-41a1-a613-d866bd46066d" class="outline-5">
<h5 id="h:f172a457-7ed0-41a1-a613-d866bd46066d">虚拟机安装过程</h5>
<div class="outline-text-5" id="text-h:f172a457-7ed0-41a1-a613-d866bd46066d">

<figure id="org63e7770">
<img src="images/image-20210223144423265.png" alt="image-20210223144423265.png">

</figure>


<figure id="orge2d3a67">
<img src="images/image-20210223144432257.png" alt="image-20210223144432257.png">

</figure>


<figure id="org0d482cb">
<img src="images/image-20210223144439016.png" alt="image-20210223144439016.png">

</figure>


<figure id="org0a8222c">
<img src="images/image-20210223144450506.png" alt="image-20210223144450506.png">

</figure>
</div>
</div>
<div id="outline-container-h:10eed35d-332f-4d02-b24a-a5b8d744b9c4" class="outline-5">
<h5 id="h:10eed35d-332f-4d02-b24a-a5b8d744b9c4">验证虚拟机设置</h5>
<div class="outline-text-5" id="text-h:10eed35d-332f-4d02-b24a-a5b8d744b9c4">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ip link show master virbr1
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr1
state UP mode DEFAULT group default qlen 1000
    link/ether 00:0c:29:44:c3:fe brd ff:ff:ff:ff:ff:ff
27: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master
virbr1 state UNKNOWN mode DEFAULT group default qlen 1000
    link/ether fe:54:00:c5:0a:9d brd ff:ff:ff:ff:ff:ff
</pre>
</div>


<figure id="orgd48903b">
<img src="images/image-20210223144505047.png" alt="image-20210223144505047.png">

</figure>

<p>
<b>在virt-manager 查看网桥</b>
</p>


<figure id="orged23680">
<img src="images/image-20210223144519152.png" alt="image-20210223144519152.png">

</figure>


<figure id="org7d28cf4">
<img src="images/image-20210223144525770.png" alt="image-20210223144525770.png">

</figure>
</div>
</div>
<div id="outline-container-h:3eab527e-8a21-41a7-ac82-4bca1b894573" class="outline-5">
<h5 id="h:3eab527e-8a21-41a7-ac82-4bca1b894573">从外部主机连接虚拟机</h5>
<div class="outline-text-5" id="text-h:3eab527e-8a21-41a7-ac82-4bca1b894573">
<div class="org-src-container">
<pre class="src src-sh">C:\Users\Wang&gt;ssh root@10.0.0.185
The authenticity of host <span style="color: #8b2252;">'10.0.0.185 (10.0.0.185)'</span> can<span style="color: #8b2252;">'t be established.</span>
<span style="color: #8b2252;">ECDSA key fingerprint is SHA256:0yIg7Pvfpp5C0w5CT/AmJsGfBdVnQm9wQXqn9gSirno.</span>
<span style="color: #8b2252;">Are you sure you want to continue connecting (yes/no)? yes</span>
<span style="color: #8b2252;">Warning: Permanently added '</span>10.0.0.185<span style="color: #8b2252;">' (ECDSA) to the list of known hosts.</span>
<span style="color: #8b2252;">root@10.0.0.185'</span>s password:
Last login: Mon Sep 21 23:25:42 2020 from 10.0.0.1
Last login: Mon Sep 21 23:25:42 2020 from 10.0.0.1

[root@centos8 ~]# hostname -I
10.0.0.185

[root@centos8 ~]# dnf -yq install pciutils
warning: /var/cache/dnf/BaseOS-929b586ef1f72f69/packages/pciutils-3.5.6-
4.el8.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID 8483c65d: NOKEY
Importing GPG key 0x8483C65D:
Userid         : <span style="color: #8b2252;">"CentOS (CentOS Official Signing Key) <a href="mailto:security%40centos.org">&lt;security@centos.org&gt;</a>"</span>
Fingerprint: 99DB 70FA E1D7 CE22 7FB6 4882 05B5 55B3 8483 C65D
From             : /etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial

[root@centos8 ~]# lspci
00:00.0 Host bridge: Intel Corporation 440FX - 82441FX PMC [Natoma] (rev 02)
00:01.0 ISA bridge: Intel Corporation 82371SB PIIX3 ISA [Natoma/Triton II]
00:01.1 IDE interface: Intel Corporation 82371SB PIIX3 IDE [Natoma/Triton II]
00:01.3 Bridge: Intel Corporation 82371AB/EB/MB PIIX4 ACPI (rev 03)
00:02.0 VGA compatible controller: Red Hat, Inc. QXL paravirtual graphic card
(rev 04)
00:03.0 Ethernet controller: Red Hat, Inc. Virtio network device
00:04.0 USB controller: Intel Corporation 82801I (ICH9 Family) USB UHCI
Controller <span style="color: #b22222;">#</span><span style="color: #b22222;">1 (rev 03)</span>
00:04.1 USB controller: Intel Corporation 82801I (ICH9 Family) USB UHCI
Controller <span style="color: #b22222;">#</span><span style="color: #b22222;">2 (rev 03)</span>
00:04.2 USB controller: Intel Corporation 82801I (ICH9 Family) USB UHCI
Controller <span style="color: #b22222;">#</span><span style="color: #b22222;">3 (rev 03)</span>
00:04.7 USB controller: Intel Corporation 82801I (ICH9 Family) USB2 EHCI
Controller <span style="color: #b22222;">#</span><span style="color: #b22222;">1 (rev 03)</span>
00:05.0 SCSI storage controller: Red Hat, Inc. Virtio block device
00:06.0 Unclassified device [00ff]: Red Hat, Inc. Virtio memory balloon
</pre>
</div>


<figure id="orgd6f8c84">
<img src="images/image-20210223144538791.png" alt="image-20210223144538791.png">

</figure>
</div>
</div>
<div id="outline-container-h:0ebd4bf3-6a08-497c-a49a-441f9ec53c75" class="outline-5">
<h5 id="h:0ebd4bf3-6a08-497c-a49a-441f9ec53c75">虚拟机手动克隆</h5>
<div class="outline-text-5" id="text-h:0ebd4bf3-6a08-497c-a49a-441f9ec53c75">
<p>
先关机后再克隆
</p>


<figure id="org9fc662f">
<img src="images/image-20210223144554549.png" alt="image-20210223144554549.png">

</figure>


<figure id="org344cb0e">
<img src="images/image-20210223144645064.png" alt="image-20210223144645064.png">

</figure>


<figure id="org42b831a">
<img src="images/image-20210223144654486.png" alt="image-20210223144654486.png">

</figure>


<figure id="org67a2663">
<img src="images/image-20210223144714774.png" alt="image-20210223144714774.png">

</figure>


<figure id="orgafffb17">
<img src="images/image-20210223144725120.png" alt="image-20210223144725120.png">

</figure>


<figure id="org438f5f6">
<img src="images/image-20210223144731471.png" alt="image-20210223144731471.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ll -h /var/lib/libvirt/images/
total 5.7G
-rw------- 1 root root 1.8G Sep 21 23:33 centos8-clone.qcow2
-rw-r--r-- 1 root root 1.9G Sep 21 23:32 centos8.qcow2
</pre>
</div>
</div>
</div>
<div id="outline-container-h:51500a6b-4c1e-4afd-bb67-b138078b3398" class="outline-5">
<h5 id="h:51500a6b-4c1e-4afd-bb67-b138078b3398">基于现有虚拟机镜像批量创建新虚拟机</h5>
<div class="outline-text-5" id="text-h:51500a6b-4c1e-4afd-bb67-b138078b3398">
<p>
将前面生成的虚拟机做为模版,生成新的虚拟机
</p>

<p>
<b>注意:先在前面的模块虚拟机修改配置,如:关闭firewalld和SELinux,禁用NetworkManager(CentOS7)等,安装常用包等</b>
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 images]#pwd
/var/lib/libvirt/images
[root@centos8 images]#cp centos8.qcow2 centos8-2.qcow2
[root@centos8 images]#virt-install --virt-type kvm --name centos8-2 --ram 2048 --vcpus 2 --disk <span style="color: #a0522d;">bus</span>=virtio,<span style="color: #a0522d;">path</span>=/var/lib/libvirt/images/centos8-2.qcow2 --network <span style="color: #a0522d;">bridge</span>=virbr1,<span style="color: #a0522d;">model</span>=virtio --graphics vnc,<span style="color: #a0522d;">listen</span>=0.0.0.0 --noautoconsole --autostart --boot hd
WARNING No operating system detected, VM performance may suffer. Specify an OS
with --os-variant for optimal results.
Starting install...
Domain creation completed.

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36816;&#34892;&#24037;&#20855;,&#21487;&#20197;&#30475;&#21040;&#19979;&#38754;&#20986;&#29616;&#26032;&#30340;&#34394;&#25311;&#26426;</span>
[root@centos8 images]#virt-manager

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#21551;&#30340;&#34394;&#25311;&#26426;&#30913;&#30424;&#25991;&#20214;&#25152;&#26377;&#32773;&#20026;qemu,&#20851;&#38381;&#21518;&#20026;root</span>
[root@centos8 ~]#ll /var/lib/libvirt/images
total 9977352
-rw-r--r-- 1 qemu qemu 2029518848 Sep 21 23:37 centos8-2.qcow2
-rw------- 1 root root 1929183232 Sep 21 23:33 centos8-clone.qcow2
-rw-r--r-- 1 root root 2004221952 Sep 21 23:32 centos8.qcow2
</pre>
</div>


<figure id="org2b92f72">
<img src="images/image-20210223144751894.png" alt="image-20210223144751894.png">

</figure>
</div>
</div>
<div id="outline-container-h:f1251437-b13e-4ff8-b801-22745f5ff951" class="outline-5">
<h5 id="h:f1251437-b13e-4ff8-b801-22745f5ff951">查看新虚拟机设置</h5>
<div class="outline-text-5" id="text-h:f1251437-b13e-4ff8-b801-22745f5ff951">

<figure id="orgbc18595">
<img src="images/image-20210223144805699.png" alt="image-20210223144805699.png">

</figure>


<figure id="org49c5128">
<img src="images/image-20210223144814848.png" alt="image-20210223144814848.png">

</figure>


<figure id="orgb78f331">
<img src="images/image-20210223144821832.png" alt="image-20210223144821832.png">

</figure>


<figure id="org1f4452f">
<img src="images/image-20210223144830217.png" alt="image-20210223144830217.png">

</figure>
</div>
</div>
</div>
</div>
<div id="outline-container-h:563fa87e-ce35-44a6-a9d5-7454e3199fe3" class="outline-3">
<h3 id="h:563fa87e-ce35-44a6-a9d5-7454e3199fe3">用户自定义的隔离的虚拟网络</h3>
<div class="outline-text-3" id="text-h:563fa87e-ce35-44a6-a9d5-7454e3199fe3">
<p>
此模式类似于Vmware中的仅主机的网卡模式,但无法和物理主机相通,只能在虚拟机之间互通
</p>
</div>
<div id="outline-container-h:028486b2-0dff-4e6d-88cc-2023a57b080d" class="outline-4">
<h4 id="h:028486b2-0dff-4e6d-88cc-2023a57b080d">用户自定义的隔离的虚拟网络架构</h4>
<div class="outline-text-4" id="text-h:028486b2-0dff-4e6d-88cc-2023a57b080d">

<figure id="org42fa155">
<img src="images/image-20210223144845024.png" alt="image-20210223144845024.png">

</figure>
</div>
</div>
<div id="outline-container-h:88f17274-062d-4e9e-89b3-b86f0c7cb0ed" class="outline-4">
<h4 id="h:88f17274-062d-4e9e-89b3-b86f0c7cb0ed">创建用户自定义的隔离的虚拟网络</h4>
<div class="outline-text-4" id="text-h:88f17274-062d-4e9e-89b3-b86f0c7cb0ed">
<p>
使用virt-manager创建网桥
</p>

<p>
菜单栏&#x2014;Edit&#x2013;Connect&#x2013;Virtual Networks &#x2013; 添加&#x2014;模式选择Isolated
</p>


<figure id="orgc72f8a9">
<img src="images/image-20210223144856016.png" alt="image-20210223144856016.png">

</figure>


<figure id="org7e641e6">
<img src="images/image-20210223144906416.png" alt="image-20210223144906416.png">

</figure>


<figure id="orga783eb9">
<img src="images/image-20210223144916421.png" alt="image-20210223144916421.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#ip a
......
29: virbr2: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state
DOWN group default qlen 1000
    link/ether 52:54:00:66:cd:2c brd ff:ff:ff:ff:ff:ff
    inet 192.168.100.1/24 brd 192.168.100.255 scope global virbr2
            valid_lft forever preferred_lft forever
30: virbr2-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr2
state DOWN group default qlen 1000
    link/ether 52:54:00:66:cd:2c brd ff:ff:ff:ff:ff:ff


[root@centos8 ~]#ip link show master virbr2
30: virbr2-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr2
state DOWN mode DEFAULT group default qlen 1000
    link/ether 52:54:00:66:cd:2c brd ff:ff:ff:ff:ff:ff
[root@centos8 ~]#bridge     link show
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr1 state
forwarding priority 32 cost 100
5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master virbr0 state disabled
priority 32 cost 100
30: virbr2-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master virbr2 state disabled
priority 32 cost 100

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#32593;&#32476;</span>
[root@centos8 ~]#virsh net-list
Name                                 State         Autostart         Persistent
----------------------------------------------------------
default                         active         yes            yes
me-net                     active         yes                     yes         
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2ffb0e63-e58c-41f5-9ea5-ce3c78a0efa8" class="outline-4">
<h4 id="h:2ffb0e63-e58c-41f5-9ea5-ce3c78a0efa8">修改虚拟机的网卡使用创建的隔离网络</h4>
<div class="outline-text-4" id="text-h:2ffb0e63-e58c-41f5-9ea5-ce3c78a0efa8">

<figure id="orgfa117af">
<img src="images/image-20210223144930395.png" alt="image-20210223144930395.png">

</figure>

<p>
修改第二个虚拟机也使用一样的网络
</p>


<figure id="org73d1d55">
<img src="images/image-20210223144939913.png" alt="image-20210223144939913.png">

</figure>
</div>
</div>
<div id="outline-container-h:b3a90096-a6bf-4dc8-a66e-8d1f28ee36a9" class="outline-4">
<h4 id="h:b3a90096-a6bf-4dc8-a66e-8d1f28ee36a9">验证自定义的隔离网络主机之间通信</h4>
<div class="outline-text-4" id="text-h:b3a90096-a6bf-4dc8-a66e-8d1f28ee36a9">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;2&#20010;&#34394;&#25311;&#30340;ip</span>
virsh domifaddr  centos8
virsh domifaddr  centos8-2

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30456;&#20114;ping&#65292;&#36890;&#36807;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#20114;&#32852;&#32593;&#65292;&#19981;&#36890;</span>
</pre>
</div>


<figure id="orgd9c78e2">
<img src="images/image-20210223144949999.png" alt="image-20210223144949999.png">

</figure>
</div>
</div>
<div id="outline-container-h:f78c3316-1fa9-4bd4-8ef9-e3ef2b447cdf" class="outline-4">
<h4 id="h:f78c3316-1fa9-4bd4-8ef9-e3ef2b447cdf">宿主机查看桥接关系</h4>
<div class="outline-text-4" id="text-h:f78c3316-1fa9-4bd4-8ef9-e3ef2b447cdf">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#bridge     link show
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr1 state
forwarding priority 32 cost 100
5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master virbr0 state disabled
priority 32 cost 100
30: virbr2-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 master virbr2 state disabled
priority 32 cost 100
31: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr2 state
forwarding priority 32 cost 100
32: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master virbr2 state
forwarding priority 32 cost 100
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:77178b2b-0fe6-4b17-8d13-0e18dbb45408" class="outline-2">
<h2 id="h:77178b2b-0fe6-4b17-8d13-0e18dbb45408">实战案例</h2>
<div class="outline-text-2" id="text-h:77178b2b-0fe6-4b17-8d13-0e18dbb45408">
</div>
<div id="outline-container-h:631a18aa-8bff-426e-b286-edba79fa3ed5" class="outline-3">
<h3 id="h:631a18aa-8bff-426e-b286-edba79fa3ed5">连接NAS共享存储实现虚拟机实时迁移</h3>
<div class="outline-text-3" id="text-h:631a18aa-8bff-426e-b286-edba79fa3ed5">

<figure id="orgc942862">
<img src="images/image-20210223145000503.png" alt="image-20210223145000503.png">

</figure>

<p>
用户访问不停顿的情况下，实时迁移
</p>

<pre class="example" id="orge056b90">
环境: 三台主机

两台KVM宿主机
一台CentOS8 10.0.0.8
一台CentOS7 10.0.0.7
一台NFS服务器: CentOS8 10.0.0.18

#注意:
两台宿主机的虚拟机都要一样的网卡配置,都事先实现virbr1的桥接
要迁移的虚拟机必须是运行状态才可以迁移
建议从低版本向高版本的宿主机迁移,如:将CentOS7宿主机虚拟机迁移到CentOS8的宿主机上,反之可能失败
</pre>

<p>
第一台KVM宿主机虚拟机
</p>


<figure id="org1b2b283">
<img src="images/image-20210223145025894.png" alt="image-20210223145025894.png">

</figure>

<p>
第二台KVM宿主机虚拟机
</p>


<figure id="orge6bbea9">
<img src="images/image-20210223145223871.png" alt="image-20210223145223871.png">

</figure>

<p>
第一台宿主机的虚拟机网络
</p>


<figure id="orgc4ab8b0">
<img src="images/image-20210223145235470.png" alt="image-20210223145235470.png">

</figure>

<p>
第二台宿主机的虚拟机网络
</p>


<figure id="org7f73b18">
<img src="images/image-20210223145243030.png" alt="image-20210223145243030.png">

</figure>

<p>
将第二台宿主机的虚拟机迁移动到第一台宿主机上
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#19968;&#21488;&#23487;&#20027;&#26426;&#30340;&#32593;&#32476;&#37197;&#32622;</span>
[root@centos8 ~]#ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group
default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
            valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
            valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master virbr1
state UP group default qlen 1000
    link/ether 00:0c:29:8a:51:21 brd ff:ff:ff:ff:ff:ff
3: virbr1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP
group default qlen 1000
    link/ether 00:0c:29:8a:51:21 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.8/24 brd 10.0.0.255 scope global noprefixroute virbr1
            valid_lft forever preferred_lft forever
    inet6 fe80::b441:41ff:fed6:f6f3/64 scope link
            valid_lft forever preferred_lft forever
4: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN
group default qlen 1000
    link/ether 52:54:00:23:8b:86 brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
            valid_lft forever preferred_lft forever
5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc fq_codel master virbr0 state
DOWN group default qlen 1000
    link/ether 52:54:00:23:8b:86 brd ff:ff:ff:ff:ff:ff
8: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master
virbr1 state UNKNOWN group default qlen 1000
    link/ether fe:54:00:9c:9a:88 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe9c:9a88/64 scope link
            valid_lft forever preferred_lft forever
10: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel master
virbr1 state UNKNOWN group default qlen 1000
    link/ether fe:54:00:5b:ab:6e brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe5b:ab6e/64 scope link
            valid_lft forever preferred_lft forever

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31532;&#20108;&#21488;&#23487;&#20027;&#26426;&#30340;&#32593;&#32476;&#37197;&#32622;</span>
[root@centos7 ~]#ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group
default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
            valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
            valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master
virbr1 state UP group default qlen 1000
    link/ether 00:0c:29:01:f9:48 brd ff:ff:ff:ff:ff:ff
3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN
group default qlen 1000
    link/ether 52:54:00:83:1f:cb brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
            valid_lft forever preferred_lft forever
4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast master virbr0
state DOWN group default qlen 1000
    link/ether 52:54:00:83:1f:cb brd ff:ff:ff:ff:ff:ff
8: virbr1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP
group default qlen 1000
    link/ether 00:0c:29:01:f9:48 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.7/24 brd 10.0.0.255 scope global noprefixroute virbr1
            valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe01:f948/64 scope link
            valid_lft forever preferred_lft forever
</pre>
</div>
</div>
<div id="outline-container-h:cae5450a-663e-4b71-acf8-a82ba04445fc" class="outline-4">
<h4 id="h:cae5450a-663e-4b71-acf8-a82ba04445fc">先实现NFS服务</h4>
<div class="outline-text-4" id="text-h:cae5450a-663e-4b71-acf8-a82ba04445fc">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#dnf -y install nfs-utils
[root@centos8 ~]#mkdir /data/kvmdata
[root@centos8 ~]#cat /etc/exports
/data/kvmdata *(rw,no_root_squash)

[root@centos8 ~]#systemctl enable --now nfs-server.service
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b2f10ae9-9b9b-4c8d-ab66-1c37793e1ba4" class="outline-4">
<h4 id="h:b2f10ae9-9b9b-4c8d-ab66-1c37793e1ba4">在宿主机的磁盘文件从目录中移到临时目录</h4>
<div class="outline-text-4" id="text-h:b2f10ae9-9b9b-4c8d-ab66-1c37793e1ba4">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mv /var/lib/libvirt/images/* /opt
[root@centos7 ~]#mv /var/lib/libvirt/images/* /opt
</pre>
</div>
</div>
</div>
<div id="outline-container-h:aedf63b9-7799-49a5-885d-2d4db93decab" class="outline-4">
<h4 id="h:aedf63b9-7799-49a5-885d-2d4db93decab">在两台宿主机都实现存储</h4>
<div class="outline-text-4" id="text-h:aedf63b9-7799-49a5-885d-2d4db93decab">
</div>
<div id="outline-container-h:8efb8a6c-3fd1-47cf-bea9-0783f8fc837a" class="outline-5">
<h5 id="h:8efb8a6c-3fd1-47cf-bea9-0783f8fc837a">在第一台宿主机实现</h5>
<div class="outline-text-5" id="text-h:8efb8a6c-3fd1-47cf-bea9-0783f8fc837a">
<p>
virt-manager菜单栏
</p>

<p>
Edit&#x2014;Connection Details&#x2014;Storage点+加号，添加存储池。Type类型选择netfs
</p>

<pre class="example" id="org1f7747c">
Name: kvmdata
Type: netfs
Target Path: /var/lib/libvirt/images
Format: auto
Host Name: 10.0.0.18
Source Path: /data/kvmdata
</pre>


<figure id="orgc47d984">
<img src="images/image-20210223150422583.png" alt="image-20210223150422583.png">

</figure>


<figure id="org65b3d86">
<img src="images/image-20210223150434092.png" alt="image-20210223150434092.png">

</figure>


<figure id="org4bb66ce">
<img src="images/image-20210223150441673.png" alt="image-20210223150441673.png">

</figure>


<figure id="org9afad10">
<img src="images/image-20210223150451126.png" alt="image-20210223150451126.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#df
Filesystem                         1K-blocks     Used Available Use% Mounted on
devtmpfs                                     4050832             0     4050832     0% /dev
tmpfs                                         4067612             0     4067612     0% /dev/shm
tmpfs                                         4067612         9316     4058296     1% /run
tmpfs                                         4067612             0     4067612     0% /sys/fs/cgroup
/dev/sda2                             104806400 6816776     97989624     7% /
/dev/sda3                                 52403200 3136576     49266624     6% /data
/dev/sda1                                     999320     120528         809980     13% /boot
tmpfs                                             813520             8         813512     1% /run/user/0
10.0.0.18:/data/kvmdata     52403200     398336     52004864     1% /var/lib/libvirt/images
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c40d3881-afa8-4f5d-9c5e-3dc232eec33d" class="outline-5">
<h5 id="h:c40d3881-afa8-4f5d-9c5e-3dc232eec33d">在第二台宿主机实现</h5>
<div class="outline-text-5" id="text-h:c40d3881-afa8-4f5d-9c5e-3dc232eec33d">
<p>
同样方法做nfs存储池
</p>

<p>
virt-manager菜单栏
</p>

<p>
Edit&#x2014;Connection Details&#x2014;Storage点+加号，添加存储池。Type类型选择netfs
</p>

<pre class="example" id="org2e72348">
Name: kvmdata
Type: netfs
Target Path: /var/lib/libvirt/images
Format: auto
Host Name: 10.0.0.18
Source Path: /data/kvmdata
</pre>


<figure id="orgb0e3166">
<img src="images/image-20210223150504773.png" alt="image-20210223150504773.png">

</figure>


<figure id="orgdab3eb8">
<img src="images/image-20210223150514086.png" alt="image-20210223150514086.png">

</figure>


<figure id="org12a78c2">
<img src="images/image-20210223150524201.png" alt="image-20210223150524201.png">

</figure>


<figure id="org96b4016">
<img src="images/image-20210223150535638.png" alt="image-20210223150535638.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:ca291b7b-9a51-4f62-ab2a-340b692365ab" class="outline-4">
<h4 id="h:ca291b7b-9a51-4f62-ab2a-340b692365ab">将原有磁盘文件从临时目录移回原目录</h4>
<div class="outline-text-4" id="text-h:ca291b7b-9a51-4f62-ab2a-340b692365ab">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#mv /opt/centos8* /var/lib/libvirt/images/
[root@centos7 ~]#mv /opt/centos7.qcow2 /var/lib/libvirt/images/
[root@centos8 ~]#ll /var/lib/libvirt/images/
total 5724996
-rw-r--r-- 1 root root 1688731648 Aug 11 10:03 centos7.qcow2
-rw-r--r-- 1 root root 2081947648 Aug 11 09:38 centos8-2.qcow2
-rw-r--r-- 1 root root 2091712512 Aug 11 09:26 centos8.qcow2
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e5b81db0-1c80-4c2b-8c8e-e13155731b37" class="outline-4">
<h4 id="h:e5b81db0-1c80-4c2b-8c8e-e13155731b37">在第一台宿主机连接到第二台宿主机</h4>
<div class="outline-text-4" id="text-h:e5b81db0-1c80-4c2b-8c8e-e13155731b37">
<p>
打开 virt-manager， File&#x2014;Add Connection
</p>


<figure id="org2f3e59a">
<img src="images/image-20210223150545585.png" alt="image-20210223150545585.png">

</figure>


<figure id="org71ed52f">
<img src="images/image-20210223150554214.png" alt="image-20210223150554214.png">

</figure>


<figure id="org4be50e1">
<img src="images/image-20210223150606007.png" alt="image-20210223150606007.png">

</figure>

<p>
在第一台宿主机安装相关软件包或配置基于Key验证
</p>

<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#yum -y install openssh-askpass
</pre>
</div>

<p>
再次连接,可以看到提示
</p>


<figure id="orgb30cac2">
<img src="images/image-20210223150624447.png" alt="image-20210223150624447.png">

</figure>


<figure id="org9a7585b">
<img src="images/image-20210223150634086.png" alt="image-20210223150634086.png">

</figure>
</div>
</div>
<div id="outline-container-h:5acbfd2a-d3d4-48c2-9b70-fa4e48a7fc6c" class="outline-4">
<h4 id="h:5acbfd2a-d3d4-48c2-9b70-fa4e48a7fc6c">进行迁移</h4>
<div class="outline-text-4" id="text-h:5acbfd2a-d3d4-48c2-9b70-fa4e48a7fc6c">
<p>
virt-manager中右键10.0.0.7缩主机中的虚拟机，Migrate迁移
</p>

<pre class="example" id="org78f013c">
Mode: Direct 直连
Address: 写对应目标缩主机IP
Advanced options:
- Allow unsafe 允许非安全，勾选
</pre>

<p>
点击Migrate. 迁移过程可能会丢失几个数据包。
</p>


<figure id="org1a79fc7">
<img src="images/image-20210223150653510.png" alt="image-20210223150653510.png">

</figure>


<figure id="org5d6ba4d">
<img src="images/image-20210223150724281.png" alt="image-20210223150724281.png">

</figure>


<figure id="orgabad974">
<img src="images/image-20210223150733094.png" alt="image-20210223150733094.png">

</figure>


<figure id="org62bdd89">
<img src="images/image-20210223150742383.png" alt="image-20210223150742383.png">

</figure>


<figure id="orgbca00c7">
<img src="images/image-20210223150753381.png" alt="image-20210223150753381.png">

</figure>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#30475;&#21040;&#36801;&#31227;&#36807;&#26469;&#30340;&#34394;&#25311;&#26426;&#25991;&#20214;&#24050;&#32463;&#34987;&#31227;&#21160;&#21040;&#30446;&#26631;&#23487;&#20027;&#26426;</span>
[root@centos8 ~]#tree /etc/libvirt/qemu
/etc/libvirt/qemu
&#9500;&#9472;&#9472; autostart
&#9474;        &#9500;&#9472;&#9472; centos8-2.xml -&gt; /etc/libvirt/qemu/centos8-2.xml
&#9474;        &#9492;&#9472;&#9472; centos8.xml -&gt; /etc/libvirt/qemu/centos8.xml
&#9500;&#9472;&#9472; centos7.xml
&#9500;&#9472;&#9472; centos8-2.xml
&#9500;&#9472;&#9472; centos8.xml
&#9492;&#9472;&#9472; networks
    &#9500;&#9472;&#9472; autostart
    &#9474;        &#9492;&#9472;&#9472; default.xml -&gt; ../default.xml
    &#9492;&#9472;&#9472; default.xml
3 directories, 7 files

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;&#28304;&#23487;&#20027;&#26426;&#34394;&#25311;&#26426;&#25991;&#20214;&#34987;&#21024;&#38500;</span>
[root@centos7 ~]#tree /etc/libvirt/qemu
/etc/libvirt/qemu
&#9500;&#9472;&#9472; autostart
&#9492;&#9472;&#9472; networks
    &#9500;&#9472;&#9472; autostart
    &#9474;        &#9492;&#9472;&#9472; default.xml -&gt; ../default.xml
    &#9492;&#9472;&#9472; default.xml
3 directories, 2 files
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7029a20b-4691-4872-adaa-8f60d98f282e" class="outline-4">
<h4 id="h:7029a20b-4691-4872-adaa-8f60d98f282e">再迁移回来</h4>
<div class="outline-text-4" id="text-h:7029a20b-4691-4872-adaa-8f60d98f282e">
<div class="org-src-container">
<pre class="src src-sh">[root@centos8 ~]#cat /etc/hosts
127.0.0.1     localhost localhost.localdomain localhost4 localhost4.localdomain4
centos8.cicin.com
::1                 localhost localhost.localdomain localhost6 localhost6.localdomain6
10.0.0.7 centos7.cicin.com
</pre>
</div>



<figure id="org135df70">
<img src="images/image-20210223150853876.png" alt="image-20210223150853876.png">

</figure>


<figure id="org658e6f5">
<img src="images/image-20210223150903025.png" alt="image-20210223150903025.png">

</figure>

<p>
将CentOS8 的虚拟移到CentOS7 是会报错
</p>


<figure id="org2cd3aef">
<img src="images/image-20210223150915805.png" alt="image-20210223150915805.png">

</figure>


<figure id="orgb8e8be7">
<img src="images/image-20210223150922739.png" alt="image-20210223150922739.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:f0c6c6c8-0fbc-4c05-af33-fb845b90caae" class="outline-3">
<h3 id="h:f0c6c6c8-0fbc-4c05-af33-fb845b90caae">内外网络隔离综合案例</h3>
<div class="outline-text-3" id="text-h:f0c6c6c8-0fbc-4c05-af33-fb845b90caae">
<p>
实现一个外网的web服务和内网的数据库相互隔离的环境 两台宿主机host1和host2
每个宿主机上面各有两个虚拟机,分别连接外网和内网交换机
</p>

<pre class="example" id="org51f0181">
一个缩主机一般会有多块网卡。多网卡绑定是可以容错的，同时宽带相加。
</pre>


<figure id="org6aafc90">
<img src="images/image-20210223150939139.png" alt="image-20210223150939139.png">

</figure>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
