<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Python: 数据结构-算法-设计模式</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Python: 数据结构-算法-设计模式</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:05c2793c-b6c9-4d27-b9bb-b34e754d4330">Python 数据结构与算法</a>
<ul>
<li><a href="#h:fb4098cb-7665-4e7e-8599-a4e1fdf551ae">数据结构-非线性数据结构-图</a>
<ul>
<li><a href="#h:883b3ec3-4109-4a2c-b671-93cd9e13bebf">图 Graph</a>
<ul>
<li><a href="#h:fd933a4d-00e7-49a4-afe4-14460d387110">图重要概念</a></li>
<li><a href="#h:2af58ef4-9f19-4cd7-ae82-16345dabd438">如何设计一个有向无环图</a></li>
</ul>
</li>
<li><a href="#h:e45fe2fa-7cce-4706-bbb6-a98c755370b6">构建模型</a>
<ul>
<li><a href="#h:99ff17e3-20c9-4af2-98a0-b16f875ff94f">工具</a></li>
<li><a href="#h:264cbcfb-f7f1-4728-8f23-47369736ff59">DAG 定义</a></li>
</ul>
</li>
<li><a href="#h:48ed16eb-30a8-4df9-ac84-64d72efa2d74">业务设计</a>
<ul>
<li><a href="#h:a14aea39-ff2c-40b1-8234-acc76de57d24">任务设计</a></li>
<li><a href="#h:a08002e0-32e6-434a-85fc-95db551ab861">执行条件</a></li>
<li><a href="#h:829bd9d9-4006-40ab-b014-0bb706efbec8">任务执行</a></li>
<li><a href="#h:65ae7343-ce82-445c-a341-02d774816d86">任务流转设计</a></li>
<li><a href="#h:cf8c1f91-f961-4fc9-b6f6-5e4d89fcbe3b">流程结束</a></li>
</ul>
</li>
<li><a href="#h:845d838a-6ce4-4192-b547-4ad47cb7d00b">执行引擎设计</a>
<ul>
<li><a href="#h:18582ac4-5466-4695-83a6-681f1aca88cb">pipeline 设计</a></li>
<li><a href="#h:7b78b46a-da5e-4c9e-b656-48872808045d">历史轨迹设计</a></li>
<li><a href="#h:48b8f7f3-f837-4f6c-b5cf-36618ce283fa">状态设计</a></li>
</ul>
</li>
<li><a href="#h:a2371f04-c6c5-4588-be5a-b753eedbd10f">DAG 检测</a></li>
<li><a href="#h:c425be9d-d51d-4eb7-898a-1c379769fd8d">代码实现</a>
<ul>
<li><a href="#h:52da9839-fc9b-4cb6-8e88-3a6225f65688">项目构建</a></li>
<li><a href="#h:934c5229-c25d-469c-90fe-cbc6720d8220">配置文件</a></li>
<li><a href="#h:df80ca72-1459-47bd-accb-9381f1a65a9a">单例模式</a></li>
<li><a href="#h:607e5e27-9c37-421f-9666-ef74cbb5b3db">Model 层</a></li>
<li><a href="#h:76a53fdd-9675-43b8-bc13-9d10d6c149da">service 层</a></li>
</ul>
</li>
<li><a href="#h:04ec2f79-e221-47f9-a375-86e831fb5551">流程系统</a>
<ul>
<li><a href="#h:280b1701-b147-4127-abda-bc5fa8df3c77">执行引擎</a></li>
<li><a href="#h:2aa4b994-b0c3-4476-95a0-0e7dc5b6fe5e">流转</a></li>
</ul>
</li>
<li><a href="#h:9f91ec6f-afce-4d65-a763-2d73f2a44ee7">完整代码</a>
<ul>
<li><a href="#h:95344ba1-187b-408a-8a90-5fde37fc967a">config.py</a></li>
<li><a href="#h:fac66904-228a-4636-ba3a-f5e047917e3b">model.py</a></li>
<li><a href="#h:3106f785-dea1-413c-ab36-0b44b753cc71">service.py</a></li>
<li><a href="#h:8a92c1d5-964d-4400-bf95-7e35028dbff7">executor.py</a></li>
<li><a href="#h:e628461b-fa3e-4462-b0a0-a90e055883a4">app.py</a></li>
</ul>
</li>
<li><a href="#h:98194a90-3116-4724-b601-767dbc39c72f">可视化</a>
<ul>
<li><a href="#h:1349c0be-dbfc-41aa-afae-caa120c51b27">Flask 框架代码实现</a></li>
<li><a href="#h:abb99138-5bc5-4e9c-9477-ea6c7e89c50d">uWSGI + Flask 部署</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:e937462d-3d3e-4f85-aa7b-4d3d63f3719c">Python 常见设计模式</a>
<ul>
<li><a href="#h:de12d5f3-84c0-4188-896a-b4b6ddedb7b2">singleton单例模式</a>
<ul>
<li><a href="#h:a7a99664-0bd5-40cd-ab12-a19969be23fb">实例化方法实现</a></li>
<li><a href="#h:e27dd5cb-295f-4be5-85a6-38efd89a0d65">装饰器实现</a></li>
<li><a href="#h:0202b479-ca93-4d02-845b-34d04235368d">元编程</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="./index.html">Python</a></li>
</ul>
<section id="outline-container-h:05c2793c-b6c9-4d27-b9bb-b34e754d4330" class="outline-2">
<h2 id="h:05c2793c-b6c9-4d27-b9bb-b34e754d4330">Python 数据结构与算法</h2>
<div class="outline-text-2" id="text-h:05c2793c-b6c9-4d27-b9bb-b34e754d4330">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>数据结构与算法的应用场景介绍</li>
<li>算法分析</li>
<li>数据结构性能</li>
<li>链表</li>
<li>列表数据结构</li>
<li>栈数据结构</li>
<li>队列数据结构</li>
<li>排序算法</li>
<li>搜索算法</li>
<li>树数据结构</li>
<li>树的遍历方法</li>
<li>树性质及应用</li>
<li>图数据结构</li>
<li>动态规划</li>
</ul>
</div>
<div id="outline-container-h:fb4098cb-7665-4e7e-8599-a4e1fdf551ae" class="outline-3">
<h3 id="h:fb4098cb-7665-4e7e-8599-a4e1fdf551ae">数据结构-非线性数据结构-图</h3>
<div class="outline-text-3" id="text-h:fb4098cb-7665-4e7e-8599-a4e1fdf551ae">
<p>
某一个节点上有一批任务需要执行，如何执行？
</p>

<p>
一个接一个排好队开始执行，但是这样的执行流程可能很没有效率，而且没有必要。举例，获取主机名和获取
IP
地址不需要严格的顺序，谁先执行都可以，同时执行也没有问题，这样的任务能并行就并行，不需要串行。
</p>


<figure id="org1584bc5">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_1.png" alt="dag_1.png">

</figure>

<p>
如何实现多个任务的流程执行呢？如何描述这样的任务呢？
</p>

<p>
看上面的任务并行图，不能使用“树”来描述任务的关系。这里需要使用“图”来描述。
</p>
</div>
<div id="outline-container-h:883b3ec3-4109-4a2c-b671-93cd9e13bebf" class="outline-4">
<h4 id="h:883b3ec3-4109-4a2c-b671-93cd9e13bebf">图 Graph</h4>
<div class="outline-text-4" id="text-h:883b3ec3-4109-4a2c-b671-93cd9e13bebf">

<figure id="org7e24dee">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_2.png" alt="dag_2.png">

</figure>

<p>
经典定义：图 Graph 由 <b>顶点</b> 和 <b>边</b> 组成，顶点的有穷非空集合为 V，边的集合为E，记作 <code>G(V, E)</code> 。
</p>

<p>
顶点 Vertex，数据元素的集合，顶点的集合，有穷非空；
</p>

<p>
边 Edge，数据元素关系的集合，顶点关系的集合，可以为空。
</p>


<p>
边可以有方向。
</p>

<p>
无向边记作 <code>(A, B)</code> 或者 <code>(B, A)</code> ，使用小括号。
</p>

<p>
有向边记作 <code>&lt;A, B&gt;</code> ，即从顶点 A 指向顶点 B。 <code>&lt;B, A&gt;</code> 表示顶点 B 指向顶点A。使用尖括号。
</p>

<p>
有向边也叫做 <b>弧</b> ，边表示为 <b>弧尾指向弧头</b> 。
</p>
</div>
<div id="outline-container-h:fd933a4d-00e7-49a4-afe4-14460d387110" class="outline-5">
<h5 id="h:fd933a4d-00e7-49a4-afe4-14460d387110">图重要概念</h5>
<div class="outline-text-5" id="text-h:fd933a4d-00e7-49a4-afe4-14460d387110">
<p>
<b>无向图 Undirected Graph</b>
</p>

<p>
无方向的边构成的图。
<code>G=(V,E) V={A,B,C,D} E={(A,B),(A,C),(B,C),(B,D),(C,D)}</code>
</p>


<figure id="org59f86c8">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_3.png" alt="dag_3.png">

</figure>

<p>
<b>有向图 Directed Graph</b>
</p>

<p>
有方向的边构成的图。 <code>G=(V,E) V={A,B,C,D} E={&lt;A,B&gt;,&lt;A,C&gt;,&lt;C,B&gt;,&lt;B,D&gt;}</code>
</p>


<figure id="org5824a4b">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_4.png" alt="dag_4.png">

</figure>

<p>
<b>稀疏图 Sparse Graph</b>
</p>

<p>
图中边很少。最稀疏的情况，只有顶点没有边，这就是数据结构 Set。
</p>

<p>
<b>稠密图 Dense Graph</b>
</p>

<p>
图中边很多。最稠密的情况，任意 2 个顶点之间都有关系。
</p>

<p>
<b>完全图 Complete Graph</b>
</p>

<p>
包括了所有可能的边，达到了稠密图最稠密的情况，任意 2 个顶点之间都有边相连。
</p>

<p>
有向的边的完全图，叫做有向完全图。边数为 <code>n(n-1)</code> 。
</p>

<p>
无向的边的完全图，叫做无向完全图。边数为 <code>n(n-1)/2</code> 。
</p>

<table>


<colgroup>
<col  class="org-right">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">顶点数</th>
<th scope="col" class="org-right">无向</th>
<th scope="col" class="org-right">有向</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">6</td>
<td class="org-right">12</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-right">10</td>
<td class="org-right">20</td>
</tr>
</tbody>
</table>


<figure id="orgcd41346">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_5.png" alt="dag_5.png">

</figure>

<p>
5边形，1+2+3+4，这就是1+2+&#x2026;+(n-1)=n(n-1)/2
</p>

<p>
<b>子图</b>
</p>

<p>
如果图G(V, E)和G'(V', E') 满足V'≤ V且 E'≤E，则G'是 G的子图。
</p>

<p>
换句话说，就是一个图的部分顶点和部分边组成的图为子图，有向图要注意边的方向。
</p>


<figure id="org838026e">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_6.png" alt="dag_6.png">

</figure>


<figure id="org149f319">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_7.png" alt="dag_7.png">

</figure>

<p>
<b>边的权 Weight</b>
</p>

<p>
给边赋予的值称为权。权可以表示距离、所需时间、耗费的时间等。
</p>

<p>
约定，后面默认说的图，都是不带权的。
</p>

<p>
<b>网 network</b>
</p>

<p>
图中的边有权，图称为网。
</p>


<figure id="org00af70a">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_8.png" alt="dag_8.png">

</figure>

<p>
<b>自环 Loop</b>
</p>

<p>
若一条边的两个顶点为同一个顶点，则此边称作自环。
</p>

<p>
边中存在这样一个边(u,v) 或者&lt;u,v&gt;，u=v。
</p>

<p>
<b>简单图</b>
</p>

<p>
无重复的边或者顶点到自身的边（自环）的图。
</p>

<p>
我们以后讨论的是简单图的性质。
</p>

<p>
下面 2 个图都不是简单图。
</p>


<figure id="orged956e6">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_9.png" alt="dag_9.png">

</figure>

<p>
<b>邻接</b>
</p>

<p>
图的边集为 E。
</p>

<p>
无向图，若 <code>(u,v) ∈ E</code> ，则称 u 和 v 相互邻接，互为邻接顶点。
</p>

<p>
有向图，若 <code>&lt;u,v&gt; ∈ E</code> ，则称 u 邻接到 v，或 v 邻接于 u。
</p>

<p>
简单说，就是 2 点之间有条边，2 点邻接。
</p>

<p>
<b>关联（依附）</b>
</p>

<p>
若 <code>(u,v) ∈ E</code> 或者若 <code>&lt;u,v&gt; ∈ E</code> ，  则称边依附于顶点 u、v 或顶点 u、v与边相关联。
</p>

<p>
这说的是点和边的关系。
</p>

<p>
<b>度 Degree</b>
</p>

<p>
一个顶点的度是指与该顶点相关联的边的条数，顶点 v 的度记作 TD(v)。
</p>

<p>
无向图顶点的边数叫做度。
</p>

<p>
有向图的顶点有入度和出度，顶点的度数为入度和出度之和 TD(v)=ID(v)+OD(v)。
</p>

<ul class="org-ul">
<li>入度（In-degree）：一个顶点的入度是指与其关联的各边之中，以其为终点的边数。</li>

<li>出度（Out-degree）：出度则是相对的概念，指以该顶点为起点的边数。</li>
</ul>

<p>
<b>路径 Path</b>
</p>

<p>
图 <code>G(V,E)</code> ，其任意一个顶点序列，相邻 2个顶点都能找到边或弧依次连接，就说明有路径存在。有向图的弧注意方向。所有顶点都属于V，所有边都必须属于 E。
</p>

<p>
路径长度：等于顶点数-1，等于此路径上的边数。
</p>

<p>
简单路径：路径上的顶点不重复出现，这样的路径就是简单路径。
</p>


<figure id="orgf28dda9">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_10.png" alt="dag_10.png">

</figure>

<p>
无向图中 A 到 D 的路径有 ABD、ABCD、ACD、ACBD 等。
</p>


<figure id="orgbd58b1d">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_11.png" alt="dag_11.png">

</figure>

<p>
有向图中 A 到 D 的路径有 ABD、ACBD 等。
</p>

<p>
<b>回路</b>
</p>

<p>
路径的起点和终点相同，这条路径就是回路。
</p>

<p>
简单回路：除了路径的起点和终点相同外，其它顶点都不同。
</p>


<figure id="org457dc6f">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_12.png" alt="dag_12.png">

</figure>

<p>
ABCD 就是简单路径。
</p>

<p>
ACDBA 就是简单回路。
</p>

<p>
ABCDBA 是回路，但是不是简单回路。
</p>

<p>
<b>连通</b>
</p>

<p>
无向图中，顶点间存在 <b>路径</b> ，则两顶点是连通的。
</p>

<p>
注意：连通指的是顶点 A、D 间有路径，而不是说，这两个顶点要邻接。
</p>


<figure id="org27e432e">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_13.png" alt="dag_13.png">

</figure>

<p>
例如 A 到 D 存在路径，则 A、D 顶点是连通的。
</p>

<p>
连通图
</p>
<ul class="org-ul">
<li>无向图中，如果图中任意两个顶点之间都连通，就是连通图。</li>
</ul>

<p>
连通分量
</p>
<ul class="org-ul">
<li>无向图中，指的是“极大连通子图”。</li>
<li>无向图未必是连通图，但是它可以包含连通子图。</li>
</ul>

<p>
<b>强连通</b>
</p>

<p>
有向图中，顶点间存在 2 条相反的路径，即从 A 到 B 有路径，也存在从 B 到 A的路径，两顶点是强连通的。
</p>

<p>
下图就没有 2 个顶点是强连通的。
</p>


<figure id="orge55fc3a">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_14.png" alt="dag_14.png">

</figure>

<p>
强连通图
</p>
<ul class="org-ul">
<li>有向图中，如果图中任意 2 个顶点都是强连通的图。</li>
</ul>


<figure id="org2de21de">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_15.png" alt="dag_15.png">

</figure>

<p>
强连通分量
</p>
<ul class="org-ul">
<li>有向图中，指的是“极大强连通子图”。</li>
<li>有向图未必是强连通图，但是可以包含强连通的分量。</li>
</ul>

<p>
<b>生成树Spanning Tree</b>
</p>

<p>
对连通图进行遍历，所有经过的顶点和边的组合就可以看做是一个树，就是生成树。
</p>

<p>
它是一个 <b>极小连通子图</b> ，它要包含图的 <b>所有</b> n 个顶点，但只有足以构成一棵树的 n-1 条边。
</p>
<ul class="org-ul">
<li>如果一个图有n个顶点，且少于n-1条边，那么一定是非连通图。因为至少要n-1条边才行啊</li>
<li>如果一个图有n个顶点，且多于n-1条边，那么一定有环存在，一定有2个顶点间存在第二条路径。但是不一定是连通图，但是一定有环。</li>
<li>如果一个图有n个顶点，且有n-1条边，但不一定是生成树。要正好等于n-1条边，且这些边足以构成一棵树</li>
</ul>

<p>
特点
</p>
<ul class="org-ul">
<li>连通图的生成树不唯一</li>
<li>这些生成树顶点个数和边数相同，都是包含n个顶点和n-1条边</li>
<li>生成树不可能有环，添一条边就有环，少一条边就不连通。</li>
</ul>

<p>
最小生成树Minimum Spanning Tree
</p>
<ul class="org-ul">
<li>生成树中，图的边有权，那么边的权值之和最小的生成树，就是小生成树。</li>
</ul>

<p>
<b>有向树</b>
</p>

<p>
一个有向图恰好有一个入度为 0 的顶点，其他顶点的入度都为1。注意，这里不关心出度。
</p>

<p>
生成树森林：若干有向树构成有向树森林。
</p>


<p>
<b>DAG</b>
</p>

<p>
一个无环的有向图称做有向无环图(Directed Acyclic Graph)，称为DAG
</p>

<p>
一个有向图中，任意一个顶点，都找不到一条能回到该顶点的路径。
</p>

<p>
有向无环图不一定能转化为树(因为可能有交叉)，但是树一定是有向无环图
</p>


<p>
<b>邻接矩阵</b>
</p>

<p>
图是由 vertex 和 edge 组成，所以可以分成 2 个数组表示。
</p>

<p>
顶点用一维数组表示，例如 v0、v1、v2、v3。
</p>

<p>
边使用二维数组表示，由顶点构成的二维数组。
</p>


<p>
<i>无向图表示示例，有 4 个顶点的无向图：</i>
</p>


<figure id="org56f49d4">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_16.png" alt="dag_16.png">

</figure>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-right">v0</th>
<th scope="col" class="org-right">v1</th>
<th scope="col" class="org-right">v2</th>
<th scope="col" class="org-right">v3</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">v0</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">v1</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-left">v1度数为2，2条边使用了这个顶点</td>
</tr>

<tr>
<td class="org-left">v2</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">v3</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
如果对角线上数字为 1，说明出现了自环。
</p>

<p>
如果除了对角线全是 1，说明没有自环，且是一个无向完全图。
</p>

<p>
上面的矩阵，称为 <b>图的邻接矩阵</b> 。
</p>

<p>
顶点的度数，等于对应的行或者列求和。
</p>

<p>
邻接点，矩阵中为 1 的值对应的行与列对应的顶点就是邻接点。
</p>

<p>
无向图的邻接矩阵是一个对称矩阵。
</p>


<p>
<i>有向图表示示例，有 4 个顶点的有向图：</i>
</p>


<figure id="org48d32ab">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_17.png" alt="dag_17.png">

</figure>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-right">v0</th>
<th scope="col" class="org-right">v1</th>
<th scope="col" class="org-right">v2</th>
<th scope="col" class="org-right">v3</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">v0</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">v1</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-left">v1出度为2，边有 <code>&lt;v1,v0&gt;、&lt;v1,v2&gt;</code></td>
</tr>

<tr>
<td class="org-left">v2</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-left">v2出度为2，边有 <code>&lt;v2,v0&gt;、&lt;v2,v1&gt;</code></td>
</tr>

<tr>
<td class="org-left">v3</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-right">v0入度为2</td>
<td class="org-right">v1入度为1</td>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
有向图的邻接矩阵不一定对称。对称的说明 2 个顶点间有环，例如 <code>&lt;v1,v2&gt;</code> 和 <code>&lt;v2,v1&gt;</code> 。
</p>
</div>
</div>
<div id="outline-container-h:2af58ef4-9f19-4cd7-ae82-16345dabd438" class="outline-5">
<h5 id="h:2af58ef4-9f19-4cd7-ae82-16345dabd438">如何设计一个有向无环图</h5>
<div class="outline-text-5" id="text-h:2af58ef4-9f19-4cd7-ae82-16345dabd438">
<p>
有向无环图 Directed Acyclic Graph，无环路的有向图。
</p>

<p>
思考：假设有下面的几种情况？
</p>


<figure id="org8ca148c">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_18.png" alt="dag_18.png">

</figure>

<p>
两个任务，任务本身就是顶点，任务先后执行。
</p>


<figure id="org3ce0114">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_19.png" alt="dag_19.png">

</figure>

<p>
三个任务，任务 1 执行完后，才能分别执行任务 2 或者任务 3。
</p>


<figure id="org0edd6f0">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_20.png" alt="dag_20.png">

</figure>

<p>
四个任务，任务 1 执行完后，才能分别执行任务 2 或者任务 3，最后执行任务4。
</p>

<p>
要思考任务 4 执行的前提是 “任务 2 or 任务 3 做完” 还是 “任务 2 and 任务3 做完” ？
</p>

<p>
可以看到任务的执行过程就是流程的设定（Pipeline），所以要设计一个流程系统来跑任务。
</p>

<p>
通过上面几个例子，思考：
</p>

<ol class="org-ol">
<li>如何选择执行的起点。</li>
<li>如何知道哪个任务是终点。</li>
</ol>

<p>
<b>起点的选择</b>
</p>

<p>
入度为 0 的顶点就是起始的点。
</p>

<p>
DAG 可以有多个起始点。
</p>

<p>
我们的系统约定有且只能有一个起始点。
</p>

<p>
<b>终点的判断</b>
</p>

<p>
出度为 0 的顶点，pipeline 执行结束。
</p>

<p>
Pipeline 可能有多个终点。
</p>

<p>
<b>环路检查</b>
</p>

<p>
Pipeline 设计的过程中应当注意避免出现环路，因为出现环路就不是 DAG 了。
</p>

<p>
自环检测，弧头指向顶点自身。
</p>

<p>
多顶点构成环路的检测。
</p>

<p>
环路检测必须实现，否则当定义好的流程执行起来，有可能进入环路后，永远执行不能终止。
</p>
</div>
</div>
</div>
<div id="outline-container-h:e45fe2fa-7cce-4706-bbb6-a98c755370b6" class="outline-4">
<h4 id="h:e45fe2fa-7cce-4706-bbb6-a98c755370b6">构建模型</h4>
<div class="outline-text-4" id="text-h:e45fe2fa-7cce-4706-bbb6-a98c755370b6">
</div>
<div id="outline-container-h:99ff17e3-20c9-4af2-98a0-b16f875ff94f" class="outline-5">
<h5 id="h:99ff17e3-20c9-4af2-98a0-b16f875ff94f">工具</h5>
<div class="outline-text-5" id="text-h:99ff17e3-20c9-4af2-98a0-b16f875ff94f">
<p>
模型构建的工具有很多，IBM Rational Rose（现在是 Rational Software Architect）、Sybase Power Designer等企业级建模工具。Oracle 也提供了一个MySQLWorkbench，使用它的社区版就可以开始模型设计了。
</p>


<figure id="orgb0dac27">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_21.png" alt="dag_21.png">

</figure>
</div>
</div>
<div id="outline-container-h:264cbcfb-f7f1-4728-8f23-47369736ff59" class="outline-5">
<h5 id="h:264cbcfb-f7f1-4728-8f23-47369736ff59">DAG 定义</h5>
<div class="outline-text-5" id="text-h:264cbcfb-f7f1-4728-8f23-47369736ff59">
<p>
使用数据库表的存储方式定义 DAG。
</p>

<p>
问题是如何使用数据库的表描述一个 DAG？
</p>

<p>
DAG 也是图，是图就有顶点、边，所以可以设计 2 个表，顶点表、边表来描述一个图。为了存储多个图，定义一个图的表。
</p>

<p>
一个图的定义包含了图的信息、顶点信息、边信息，一张图就是一个流程模板，顶点表示任务，边表示流向。
</p>

<p>
图 graph
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">字段名</th>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">id</td>
<td class="org-left">int</td>
<td class="org-left">主键</td>
</tr>

<tr>
<td class="org-left">name</td>
<td class="org-left">varchar</td>
<td class="org-left">非空，唯一，图的名称</td>
</tr>

<tr>
<td class="org-left">desc</td>
<td class="org-left">varchar</td>
<td class="org-left">可为空，描述</td>
</tr>
</tbody>
</table>

<p>
顶点表 vertex
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">字段名</th>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">id</td>
<td class="org-left">int</td>
<td class="org-left">主键</td>
</tr>

<tr>
<td class="org-left">name</td>
<td class="org-left">varchar</td>
<td class="org-left">非空，顶点的名称</td>
</tr>

<tr>
<td class="org-left">g_id</td>
<td class="org-left">int</td>
<td class="org-left">外键，描述顶点属于哪一个图</td>
</tr>
</tbody>
</table>

<p>
边表 edge
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">字段名</th>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">id</td>
<td class="org-left">int</td>
<td class="org-left">主键</td>
</tr>

<tr>
<td class="org-left">tail</td>
<td class="org-left">int</td>
<td class="org-left">外键，弧尾顶点，顶点在 vertex 表中必须存在</td>
</tr>

<tr>
<td class="org-left">head</td>
<td class="org-left">int</td>
<td class="org-left">外键，弧头顶点，顶点在 vertex 表中必须存在</td>
</tr>

<tr>
<td class="org-left">g_id</td>
<td class="org-left">int</td>
<td class="org-left">外键，描述边属于哪一个图</td>
</tr>
</tbody>
</table>

<p>
通过弧尾、弧头顶点来描述有向边。
</p>


<figure id="org31a290a">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_22.png" alt="dag_22.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:48ed16eb-30a8-4df9-ac84-64d72efa2d74" class="outline-4">
<h4 id="h:48ed16eb-30a8-4df9-ac84-64d72efa2d74">业务设计</h4>
<div class="outline-text-4" id="text-h:48ed16eb-30a8-4df9-ac84-64d72efa2d74">
</div>
<div id="outline-container-h:a14aea39-ff2c-40b1-8234-acc76de57d24" class="outline-5">
<h5 id="h:a14aea39-ff2c-40b1-8234-acc76de57d24">任务设计</h5>
<div class="outline-text-5" id="text-h:a14aea39-ff2c-40b1-8234-acc76de57d24">
<p>
流程定义在表中，"任务"如何描述呢？
</p>

<p>
方法一：subprocess 执行 bash 脚本 script。
</p>
<ul class="org-ul">
<li>优点：简单，易行。</li>
<li>缺点：要启动外部进程。bash 脚本表达能力较弱，难调试。</li>
</ul>

<p>
方法二：嵌入其它语言的脚本，例如 lua 语言。
</p>
<ul class="org-ul">
<li>优点：不启动子进程，功能强大。</li>
<li>缺点：技术要求高，需要学习其它脚本语言。</li>
</ul>

<p>
python 中执行 lua 脚本，<a href="https://pypi.python.org/pypi/lupa/">https://pypi.python.org/pypi/lupa/</a>
</p>

<p>
安装：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ pip install lupa
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">from lupa import LuaRuntime
import logging

<span style="color: #0000ff;">logging.basicConfig</span>(<span style="color: #a0522d;">format</span>=<span style="color: #8b2252;">"%(process)d %(thread)d %(message)s"</span>, <span style="color: #a0522d;">level</span>=logging.INFO)

<span style="color: #a0522d;">lua</span> = LuaRuntime()
<span style="color: #483d8b;">print</span>(lua.eval(<span style="color: #8b2252;">"1+3"</span>))

def pyfunc(n):
    import socket
    logging.info(<span style="color: #8b2252;">'hello'</span>)
    <span style="color: #a020f0;">return</span> socket.gethostname()

<span style="color: #a0522d;">luafunc</span> = lua.eval(<span style="color: #8b2252;">'''
function(f,n)
    return f(n)
end
'''</span>)
<span style="color: #0000ff;">logging.info</span>(<span style="color: #8b2252;">'main'</span>)
<span style="color: #483d8b;">print</span>(luafunc(pyfunc, 1))

<span style="color: #a0522d;">add</span> = lua.eval(<span style="color: #8b2252;">'''
function (x, y)
    return x+y
end
'''</span>)

<span style="color: #483d8b;">print</span>(add(4, 5))
</pre>
</div>

<p>
其实，还可以运行 JS 脚本。
</p>

<p>
选择方法一，任务脚本样例如下，存储 shell 脚本文本就行了。
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #8b2252;">"echo www.brinnatt.com"</span>
</pre>
</div>

<p>
在表 vertex 中增加一个字段，存储脚本。
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">字段名</th>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">id</td>
<td class="org-left">int</td>
<td class="org-left">主键</td>
</tr>

<tr>
<td class="org-left">name</td>
<td class="org-left">varchar</td>
<td class="org-left">非空，顶点的名称</td>
</tr>

<tr>
<td class="org-left">g_id</td>
<td class="org-left">int</td>
<td class="org-left">外键，描述顶点属于哪一个图</td>
</tr>

<tr>
<td class="org-left">script</td>
<td class="org-left">text</td>
<td class="org-left">可以为空，存储任务脚本</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:a08002e0-32e6-434a-85fc-95db551ab861" class="outline-5">
<h5 id="h:a08002e0-32e6-434a-85fc-95db551ab861">执行条件</h5>
<div class="outline-text-5" id="text-h:a08002e0-32e6-434a-85fc-95db551ab861">
<p>
脚本执行之前，可能需要提供一些参数，才能开始执行脚本。
</p>

<p>
依然在 vertex 表中增加 input 字段，定义输入参数的描述。
</p>

<p>
vertex 表
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">字段名</th>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">id</td>
<td class="org-left">int</td>
<td class="org-left">主键</td>
</tr>

<tr>
<td class="org-left">name</td>
<td class="org-left">varchar</td>
<td class="org-left">非空，顶点的名称</td>
</tr>

<tr>
<td class="org-left">g_id</td>
<td class="org-left">int</td>
<td class="org-left">外键，描述顶点属于哪一个图</td>
</tr>

<tr>
<td class="org-left">script</td>
<td class="org-left">text</td>
<td class="org-left">可以为空，存储任务脚本</td>
</tr>

<tr>
<td class="org-left">input</td>
<td class="org-left">text</td>
<td class="org-left">可以为空，存储json格式的输入参数定义</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-sh">//json&#23450;&#20041;
{
    <span style="color: #8b2252;">"name1"</span>:{
        <span style="color: #8b2252;">"type"</span>:<span style="color: #8b2252;">""</span>,
        <span style="color: #8b2252;">"required"</span>:true
    },
    <span style="color: #8b2252;">"name2"</span>:{
        <span style="color: #8b2252;">"type"</span>:<span style="color: #8b2252;">""</span>,
        <span style="color: #8b2252;">"required"</span>:true,
        <span style="color: #8b2252;">"default"</span>: 1
    }
}
</pre>
</div>

<p>
name就是参数的名称，后面定义该参数的类型、是否必须提供等属性。可以定义多个参数。
</p>

<p>
作用：进入某个节点的时候，就必须满足条件，提供足够的参数。
</p>

<p>
如果提供的参数满足要求，就进入节点，否则一直等待，直到参数满足要求。
</p>

<p>
如果满足了，才能去执行 script。
</p>

<p>
input 就是一个约束的定义。
</p>
</div>
</div>
<div id="outline-container-h:829bd9d9-4006-40ab-b014-0bb706efbec8" class="outline-5">
<h5 id="h:829bd9d9-4006-40ab-b014-0bb706efbec8">任务执行</h5>
<div class="outline-text-5" id="text-h:829bd9d9-4006-40ab-b014-0bb706efbec8">
<p>
当流程走到某一个顶点的时候，读取任务即脚本，执行这个脚本。
</p>

<p>
如何执行？
</p>

<p>
手动执行或自动执行。
</p>

<p>
1、手动执行
</p>

<p>
流程走到这个顶点，等待用户操作，需要用户手动干预。例如输入该顶点任务需要的一些配置参数，等待用户输入后才能进行下一步；例如该顶点任务完成后由用户选择下一个执行顶点。
</p>

<p>
2、自动执行
</p>

<p>
自动填写
input，例如使用缺省值，来满足用户为交互式填写的时候自动补全数据。脚本执行后，自动跳转到下一个顶点。当然这个所谓自动，程序不会智能的选择路径，需要提前指定好，执行完脚本，就可以跳转到下一个顶点了。
</p>
</div>
</div>
<div id="outline-container-h:65ae7343-ce82-445c-a341-02d774816d86" class="outline-5">
<h5 id="h:65ae7343-ce82-445c-a341-02d774816d86">任务流转设计</h5>
<div class="outline-text-5" id="text-h:65ae7343-ce82-445c-a341-02d774816d86">
<p>
当流程走到某一个顶点的时候，读取任务即脚本，或手动流转，或自动流转。
</p>

<p>
手动流转，需要人工选择下一个顶点，可以提供可视化界面供用户方便的选择。
</p>

<p>
自动流转，就需要在信息中提供下一个节点的信息，供程序自动完成。
</p>

<p>
那么，如何区分一个顶点是否自动执行呢？
</p>

<p>
把 vertex 表中的 script 字段改为 json。
</p>

<p>
如果 next 不存在，则不能自动执行，需要手动操作。
</p>

<p>
如果 next 存在，则程序自动跳转。
</p>

<div class="org-src-container">
<pre class="src src-sh">{
    <span style="color: #8b2252;">"script"</span>:<span style="color: #8b2252;">"echo brinnatt"</span>
}

{
    <span style="color: #8b2252;">"script"</span>:<span style="color: #8b2252;">"echo brinnatt"</span>,
    <span style="color: #8b2252;">'next'</span>:<span style="color: #8b2252;">'B'</span>
}

{
    <span style="color: #8b2252;">"script"</span>:<span style="color: #8b2252;">"echo brinnatt"</span>,
    <span style="color: #8b2252;">'next'</span>:2
}
</pre>
</div>

<p>
为了方便用户，next 可以提供 2 种类型参数：
</p>

<p>
int 表示使用 vertex 的 id；
</p>

<p>
str 表示使用 vertex 的 name，但是必须是同一个 graph id。同一个 DAG的定义中，要求顶点的名字不能冲突，所以可以用。
</p>
</div>
</div>
<div id="outline-container-h:cf8c1f91-f961-4fc9-b6f6-5e4d89fcbe3b" class="outline-5">
<h5 id="h:cf8c1f91-f961-4fc9-b6f6-5e4d89fcbe3b">流程结束</h5>
<div class="outline-text-5" id="text-h:cf8c1f91-f961-4fc9-b6f6-5e4d89fcbe3b">
<p>
如果进入一个节点，执行完脚本，先检测其出度为 0，执行完流程就结束了。
</p>

<p>
如何判断出度为 0 呢？
</p>

<p>
在 edge 表中，使用当前节点的顶点 ID 作为弧尾 t，找不到弧头 h的任何记录。
</p>
</div>
</div>
</div>
<div id="outline-container-h:845d838a-6ce4-4192-b547-4ad47cb7d00b" class="outline-4">
<h4 id="h:845d838a-6ce4-4192-b547-4ad47cb7d00b">执行引擎设计</h4>
<div class="outline-text-4" id="text-h:845d838a-6ce4-4192-b547-4ad47cb7d00b">
</div>
<div id="outline-container-h:18582ac4-5466-4695-83a6-681f1aca88cb" class="outline-5">
<h5 id="h:18582ac4-5466-4695-83a6-681f1aca88cb">pipeline 设计</h5>
<div class="outline-text-5" id="text-h:18582ac4-5466-4695-83a6-681f1aca88cb">
<p>
前面设计的仅仅是流程 DAG定义，可以认为这是一个模板定义，流程真正执行的时候需要记录执行这个流程的任务流的数据。DAG相当于类定义，pipeline 相当于实例，处理数据。
</p>

<p>
创建表 pipeline
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">字段名</th>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">id</td>
<td class="org-left">int</td>
<td class="org-left">主键</td>
</tr>

<tr>
<td class="org-left">g_id</td>
<td class="org-left">int</td>
<td class="org-left">外键，指明使用的是哪一个流程DAG定义</td>
</tr>

<tr>
<td class="org-left">current</td>
<td class="org-left">int</td>
<td class="org-left">外键，顶点id，表示当前走到哪一个节点</td>
</tr>
</tbody>
</table>

<p>
这个表以后还要添加其它字段，存储一些附加信息，例如谁加入的流程、执行时间等。
</p>

<p>
一个 pipeline 应该指定哪一个 DAG，并选择 DAG 的起点。因为 DAG可能有多个起点，即入度为 0 的顶点，需要指定。然后把这些信息记录在pipeline 表中，current 为起点顶点的 id。
</p>

<p>
提取 current 顶点的 input 信息，input为空，直接执行脚本，否则要等用户输入满足了，才能执行 script。
</p>

<p>
不管是手动流转还是自动流转，如果到了下一个节点，需要修改 current字段的值。
</p>

<p>
任务流执行完毕，修改最后一个节点的状态为完成。
</p>

<p>
举例：当前节点任务是打包，调用 maven 命令执行打包，先要提取input，要求用户输入 ip 地址、输出目录等信息，然后才能执行打包脚本。
</p>
</div>
</div>
<div id="outline-container-h:7b78b46a-da5e-4c9e-b656-48872808045d" class="outline-5">
<h5 id="h:7b78b46a-da5e-4c9e-b656-48872808045d">历史轨迹设计</h5>
<div class="outline-text-5" id="text-h:7b78b46a-da5e-4c9e-b656-48872808045d">
<p>
pipeline 表只能看到有哪些流程正在运行，但是究竟走了 DAG中的哪些节点，不清楚，执行节点前有输入了哪些参数也不清楚。
</p>

<p>
如何查看、回溯当前 pipeline 的执行轨迹？
</p>

<p>
track 表：
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">字段名</th>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">id</td>
<td class="org-left">int</td>
<td class="org-left">主键</td>
</tr>

<tr>
<td class="org-left">p_id</td>
<td class="org-left">int</td>
<td class="org-left">外键，哪一个流程的历史</td>
</tr>

<tr>
<td class="org-left">v_id</td>
<td class="org-left">int</td>
<td class="org-left">外键，顶点的ID，经过的历史节点</td>
</tr>

<tr>
<td class="org-left">input</td>
<td class="org-left">text</td>
<td class="org-left">可以为空，输入的参数值</td>
</tr>

<tr>
<td class="org-left">output</td>
<td class="org-left">text</td>
<td class="org-left">可以为空，任务的输出</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:48b8f7f3-f837-4f6c-b5cf-36618ce283fa" class="outline-5">
<h5 id="h:48b8f7f3-f837-4f6c-b5cf-36618ce283fa">状态设计</h5>
<div class="outline-text-5" id="text-h:48b8f7f3-f837-4f6c-b5cf-36618ce283fa">
<p>
在 pipeline 表、track 表中增加 state字段，来描述在某个节点上执行的状态，是等待中，还是正在运行，还是成功或失败，还是执行完毕。
</p>

<p>
STATE_WAITING = 0
</p>

<p>
STATE_RUNNING = 1
</p>

<p>
STATE_SUCCEED = 2
</p>

<p>
STATE_FAILED = 3
</p>

<p>
STATE_FINISH = 4
</p>

<p>
DAG 定义，需要 graph 表、vertex 表、edge 表。
</p>

<p>
Pipeline 执行，需要 pipeline 表、track 表。
</p>

<p>
模型：
</p>


<figure id="orgf61745a">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_23.png" alt="dag_23.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-h:a2371f04-c6c5-4588-be5a-b753eedbd10f" class="outline-4">
<h4 id="h:a2371f04-c6c5-4588-be5a-b753eedbd10f">DAG 检测</h4>
<div class="outline-text-4" id="text-h:a2371f04-c6c5-4588-be5a-b753eedbd10f">
<p>
这需要用到图论的知识。
</p>

<p>
1、DFS 算法
</p>

<p>
DFS（Depth First Search）深度优先遍历，递归算法。
</p>

<p>
需要改进算法以适用于有向图。不能直接检测有向图是否有环。
</p>

<p>
2、拓扑排序算法
</p>

<p>
拓扑排序就是把有向图中的顶点以线性方式排序，如果有弧 <code>&lt;u,b&gt;</code> 则最后线性排序的结果，顶点 u 总是在顶点 v 的前面。
</p>

<p>
一个有向图能被拓扑排序的充要条件是：它必须是 DAG。
</p>

<p>
kahn 算法：
</p>

<p>
（1）选择一个入度为 0 的顶点并输出它
</p>

<p>
（2）删除以此顶点为弧尾的弧
</p>

<p>
重复上面 2 步，直到输出全部顶点为止，或者图中不存在入度为 0 的顶点为止。
</p>

<p>
如果输出了全部顶点，就是 DAG。
</p>

<p>
举例：
</p>


<figure id="orgfef2998">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_24.png" alt="dag_24.png">

</figure>

<p>
上图可以找到一个入度为 0 的顶点 A，从它开始，可以得到序列ACBD。最后输出了全部顶点。所以这个图是 DAG。
</p>


<figure id="org5735d23">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_25.png" alt="dag_25.png">

</figure>

<p>
上面 2 个图都不是 DAG。左图一个环，右图 2 个环。
</p>

<p>
这 2 个图都找不到入度为 0 的起始顶点，都不是 DAG。
</p>


<figure id="org828e322">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_26.png" alt="dag_26.png">

</figure>

<p>
上图虽然可以找到入度为 0的顶点，但是移除它和关联的边，剩下顶点找不到入度为 0 的顶点，它不是DAG。
</p>


<figure id="orgdb4b521">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_27.png" alt="dag_27.png">

</figure>

<p>
上图依然不是 DAG，B、D 之间有环。
</p>
</div>
</div>
<div id="outline-container-h:c425be9d-d51d-4eb7-898a-1c379769fd8d" class="outline-4">
<h4 id="h:c425be9d-d51d-4eb7-898a-1c379769fd8d">代码实现</h4>
<div class="outline-text-4" id="text-h:c425be9d-d51d-4eb7-898a-1c379769fd8d">
<p>
数据库模型入库：
</p>


<figure id="org224be8e">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_28.png" alt="dag_28.png">

</figure>

<p>
修改 Schema 即数据库的名称为 pipeline，然后使用模型生成数据库的表。
</p>

<p>
Database &#x2013;&gt; Forward Engineer 打开操作界面，按提示连接数据库，导入数据。
</p>
</div>
<div id="outline-container-h:52da9839-fc9b-4cb6-8e88-3a6225f65688" class="outline-5">
<h5 id="h:52da9839-fc9b-4cb6-8e88-3a6225f65688">项目构建</h5>
<div class="outline-text-5" id="text-h:52da9839-fc9b-4cb6-8e88-3a6225f65688">
<p>
新建一个项目，构建一个包 pipeline。
</p>

<p>
包下有：
</p>

<p>
config.py 公共配置
</p>

<p>
model.py ORM 映射
</p>
</div>
</div>
<div id="outline-container-h:934c5229-c25d-469c-90fe-cbc6720d8220" class="outline-5">
<h5 id="h:934c5229-c25d-469c-90fe-cbc6720d8220">配置文件</h5>
<div class="outline-text-5" id="text-h:934c5229-c25d-469c-90fe-cbc6720d8220">
<p>
config.py
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a0522d;">USERNAME</span> = <span style="color: #8b2252;">'brinnatt'</span>
<span style="color: #a0522d;">PASSWD</span> = <span style="color: #8b2252;">'brinnatt'</span>
<span style="color: #a0522d;">DBIP</span> = <span style="color: #8b2252;">'192.168.136.131'</span>
<span style="color: #a0522d;">DBPORT</span> = 3306
<span style="color: #a0522d;">DBNAME</span> = <span style="color: #8b2252;">'pipeline'</span>

<span style="color: #a0522d;">URL</span> = f<span style="color: #8b2252;">'mysql+pymysql://{USERNAME}:{PASSWD}@{DBIP}:{DBPORT}/{DBNAME}'</span>

<span style="color: #a0522d;">DATABASE_DEBUG</span> = True
</pre>
</div>
</div>
</div>
<div id="outline-container-h:df80ca72-1459-47bd-accb-9381f1a65a9a" class="outline-5">
<h5 id="h:df80ca72-1459-47bd-accb-9381f1a65a9a">单例模式</h5>
<div class="outline-text-5" id="text-h:df80ca72-1459-47bd-accb-9381f1a65a9a">
<p>
一个类只能实例化一次，只能拥有一个实例。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#23454;&#29616; 1
</span><span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">A</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__new__</span>(cls, *args, **kwargs):
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'~~~~~~~~~~~~'</span>)
        <span style="color: #483d8b;">print</span>(cls)
        <span style="color: #483d8b;">print</span>(args)
        <span style="color: #483d8b;">print</span>(kwargs)
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> <span style="color: #483d8b;">hasattr</span>(cls, <span style="color: #8b2252;">'_instance'</span>):
            <span style="color: #483d8b;">setattr</span>(cls, <span style="color: #8b2252;">'_instance'</span>, <span style="color: #483d8b;">super</span>().__new__(cls))
            <span style="color: #483d8b;">setattr</span>(cls, <span style="color: #8b2252;">'_count'</span>, 0)
        <span style="color: #a020f0;">return</span> cls._instance

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, url, debug):
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'============'</span>)
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">self</span>._count == 0:
            <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">url</span> = url
            <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">debug</span> = debug
            <span style="color: #a020f0;">self</span>.__class__.<span style="color: #a0522d;">_count</span> = 1
        <span style="color: #a020f0;">else</span>:
            <span style="color: #a020f0;">raise</span> <span style="color: #228b22;">Exception</span>(<span style="color: #8b2252;">'Just One Instance'</span>)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;B {} {}&gt;"</span>.<span style="color: #483d8b;">format</span>(<span style="color: #a020f0;">self</span>.url, <span style="color: #a020f0;">self</span>.debug)

<span style="color: #a0522d;">b</span> = A(1, debug=2)
<span style="color: #483d8b;">print</span>(b.<span style="color: #483d8b;">__dict__</span>)

time.sleep(2)
<span style="color: #a0522d;">b1</span> = A(10, 20)
<span style="color: #483d8b;">print</span>(b1.<span style="color: #483d8b;">__dict__</span>)
</pre>
</div>

<p>
装饰器实现：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21333;&#20363;&#35013;&#39280;&#22120;
</span><span style="color: #a020f0;">import</span> functools

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">singleton</span>(cls):
    <span style="color: #a0522d;">instance</span> = <span style="color: #008b8b;">None</span>

    <span style="color: #228b22;">@functools.wraps</span>(cls)
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">getinstance</span>(*args, **kwargs):
        <span style="color: #a020f0;">nonlocal</span> instance
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> instance:
            <span style="color: #483d8b;">print</span>(args)
            <span style="color: #483d8b;">print</span>(kwargs)
            <span style="color: #a0522d;">instance</span> = cls(*args, **kwargs)
        <span style="color: #a020f0;">return</span> instance

    <span style="color: #a020f0;">return</span> getinstance

<span style="color: #228b22;">@singleton</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">B</span>:
    <span style="color: #8b2252;">'''class B'''</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, url, debug):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">url</span> = url
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">debug</span> = debug

<span style="color: #a0522d;">b</span> = B(1, 2)
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">id</span>(b), b.<span style="color: #483d8b;">__dict__</span>, b.<span style="color: #483d8b;">__doc__</span>)

<span style="color: #a0522d;">b1</span> = B(10, 20)
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">id</span>(b1), b1.<span style="color: #483d8b;">__dict__</span>, b.<span style="color: #483d8b;">__doc__</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:607e5e27-9c37-421f-9666-ef74cbb5b3db" class="outline-5">
<h5 id="h:607e5e27-9c37-421f-9666-ef74cbb5b3db">Model 层</h5>
<div class="outline-text-5" id="text-h:607e5e27-9c37-421f-9666-ef74cbb5b3db">
<p>
创建 ORM，封装数据操作类。
</p>

<p>
<code>$ pip install sqlalchemy pymysql</code>
</p>

<p>
model.py
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> Column, Integer, String, Text, ForeignKey, create_engine
<span style="color: #a020f0;">from</span> sqlalchemy.orm <span style="color: #a020f0;">import</span> relationship, sessionmaker
<span style="color: #a020f0;">from</span> sqlalchemy.ext.declarative <span style="color: #a020f0;">import</span> declarative_base
<span style="color: #a020f0;">import</span> functools
<span style="color: #a020f0;">from</span> . <span style="color: #a020f0;">import</span> config

<span style="color: #a0522d;">STATE_WAITING</span> = 0
<span style="color: #a0522d;">STATE_RUNNING</span> = 1
<span style="color: #a0522d;">STATE_SUCCEED</span> = 2
<span style="color: #a0522d;">STATE_FAILED</span> = 3
<span style="color: #a0522d;">STATE_FINISH</span> = 4

<span style="color: #a0522d;">Base</span> = declarative_base()

<span style="color: #b22222;"># </span><span style="color: #b22222;">schema&#23450;&#20041;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#22270;
</span><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Graph</span>(Base):
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">"graph"</span>

    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">name</span> = Column(String(48), nullable=<span style="color: #008b8b;">False</span>, unique=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">desc</span> = Column(String(500), nullable=<span style="color: #008b8b;">True</span>)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32463;&#24120;&#20174;&#22270;&#26597;&#30475;&#25152;&#26377;&#39030;&#28857;&#12289;&#36793;&#30340;&#20449;&#24687;
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#37324;&#24517;&#39035;&#20351;&#29992;foreign_keys&#65292;&#36825;&#26159;&#22240;&#20026;&#20174;&#19968;&#31471;&#26597;&#22810;&#31471;&#65292;&#20854;&#20540;&#24517;&#39035;&#20351;&#29992;&#24341;&#21495;
</span>    <span style="color: #a0522d;">vertexes</span> = relationship(<span style="color: #8b2252;">'Vertex'</span>, foreign_keys=<span style="color: #8b2252;">'Vertex.g_id'</span>)
    <span style="color: #a0522d;">edges</span> = relationship(<span style="color: #8b2252;">'Edge'</span>, foreign_keys=<span style="color: #8b2252;">'[Edge.g_id]'</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#39030;&#28857;&#34920;
</span><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Vertex</span>(Base):
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">"vertex"</span>

    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">name</span> = Column(String(48), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #483d8b;">input</span> = Column(Text, nullable=<span style="color: #008b8b;">True</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20837;&#21442;&#25968;
</span>    <span style="color: #a0522d;">script</span> = Column(Text, nullable=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">g_id</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'graph.id'</span>), nullable=<span style="color: #008b8b;">False</span>)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">graph = relationship('Graph') &#19968;&#31471;&#25110;&#22810;&#31471;&#21482;&#38656;&#35201;&#19968;&#26041;&#23450;&#20041;&#21363;&#21487;&#65292;&#37117;&#23450;&#20041;&#20250;&#25351;&#31034;&#20914;&#31361;
</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20174;&#39030;&#28857;&#26597;&#23427;&#30340;&#36793;&#65292;&#36825;&#37324;&#24517;&#39035;&#20351;&#29992;foreign_keys&#65292;&#36825;&#26159;&#22240;&#20026;&#20174;&#19968;&#31471;&#26597;&#22810;&#31471;&#65292;&#20854;&#20540;&#24517;&#39035;&#20351;&#29992;&#24341;&#21495;
</span>    <span style="color: #a0522d;">tails</span> = relationship(<span style="color: #8b2252;">'Edge'</span>, foreign_keys=<span style="color: #8b2252;">'[Edge.tail]'</span>)
    <span style="color: #a0522d;">heads</span> = relationship(<span style="color: #8b2252;">'Edge'</span>, foreign_keys=<span style="color: #8b2252;">'Edge.head'</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36793;&#34920;
</span><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Edge</span>(Base):
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">'edge'</span>

    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">tail</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'vertex.id'</span>), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">head</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'vertex.id'</span>), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">g_id</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'graph.id'</span>), nullable=<span style="color: #008b8b;">False</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">Engine
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">pipeline &#34920;
</span><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Pipeline</span>(Base):
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">'pipeline'</span>

    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">g_id</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'graph.id'</span>), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">current</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'vertex.id'</span>), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">state</span> = Column(Integer, nullable=<span style="color: #008b8b;">False</span>, default=STATE_WAITING)

    <span style="color: #a0522d;">vertex</span> = relationship(<span style="color: #8b2252;">'Vertex'</span>)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Track</span>(Base):
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">'track'</span>

    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">p_id</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'pipeline.id'</span>), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">v_id</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'vertex.id'</span>), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">state</span> = Column(Integer, nullable=<span style="color: #008b8b;">False</span>, default=STATE_WAITING)
    <span style="color: #483d8b;">input</span> = Column(Text, nullable=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">output</span> = Column(Text, nullable=<span style="color: #008b8b;">True</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20219;&#21153;&#36755;&#20986;
</span>
    <span style="color: #a0522d;">vertex</span> = relationship(<span style="color: #8b2252;">'Vertex'</span>)
    <span style="color: #a0522d;">pipeline</span> = relationship(<span style="color: #8b2252;">'Pipeline'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21518;&#38754;&#20351;&#29992;&#26041;&#20415;
</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23553;&#35013;&#25968;&#25454;&#24211;&#30340;&#24341;&#25806;&#12289;&#20250;&#35805;&#21040;&#31867;&#20013;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21333;&#20363;&#27169;&#24335;
</span><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">singleton</span>(cls):
    <span style="color: #a0522d;">instance</span> = <span style="color: #008b8b;">None</span>

    <span style="color: #228b22;">@functools.wraps</span>(cls)
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">getinstance</span>(*args, **kwargs):
        <span style="color: #a020f0;">nonlocal</span> instance
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> instance:
            <span style="color: #483d8b;">print</span>(args)
            <span style="color: #483d8b;">print</span>(kwargs)
            <span style="color: #a0522d;">instance</span> = cls(*args, **kwargs)
        <span style="color: #a020f0;">return</span> instance

    <span style="color: #a020f0;">return</span> getinstance

<span style="color: #228b22;">@singleton</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Database</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, url, **kwargs):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">_engine</span> = create_engine(url, **kwargs)
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">_session</span> = sessionmaker(bind=<span style="color: #a020f0;">self</span>._engine)()

    @<span style="color: #483d8b;">property</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">session</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>._session

    @<span style="color: #483d8b;">property</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">engine</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>._engine

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#34920;
</span>    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">create_all</span>(<span style="color: #a020f0;">self</span>):
        Base.metadata.create_all(<span style="color: #a020f0;">self</span>._engine)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#34920;
</span>    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">drop_all</span>(<span style="color: #a020f0;">self</span>):
        Base.metadata.drop_all(<span style="color: #a020f0;">self</span>._engine)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27169;&#22359;&#21152;&#36733;&#19968;&#27425;&#65292;db&#20063;&#26159;&#21333;&#20363;&#30340;
</span><span style="color: #a0522d;">db</span> = Database(config.URL, echo=config.DATABASE_DEBUG)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:76a53fdd-9675-43b8-bc13-9d10d6c149da" class="outline-5">
<h5 id="h:76a53fdd-9675-43b8-bc13-9d10d6c149da">service 层</h5>
<div class="outline-text-5" id="text-h:76a53fdd-9675-43b8-bc13-9d10d6c149da">
<p>
需求：
</p>

<p>
1、定义流程 DAG，即 Schema 定义。
</p>

<p>
2、执行某一个 DAG 的流程。
</p>

<p>
问题：
</p>

<p>
DAG 是否允许修改？
</p>

<p>
可以这样考虑，如果 DAG定义好还未使用，可以修改，一旦被使用过，不许修改。
</p>

<p>
所谓使用过，就是 pipeline 表中使用到了 graph 的主键 id，或者在 graph表中增加一个字段表示是否被使用过。
</p>
</div>
<ul class="org-ul">
<li><a id="h:08a1529e-d34d-4ec6-8bbd-cc611df3d6f0"></a>DAG 定义<br>
<div class="outline-text-6" id="text-h:08a1529e-d34d-4ec6-8bbd-cc611df3d6f0">
<p>
service.py
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> .model <span style="color: #a020f0;">import</span> db
<span style="color: #a020f0;">from</span> .model <span style="color: #a020f0;">import</span> Graph, Vertex, Edge
<span style="color: #a020f0;">from</span> .model <span style="color: #a020f0;">import</span> Pipeline, Track

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;DAG
</span><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">create_graph</span>(name, desc=<span style="color: #008b8b;">None</span>):
    <span style="color: #a0522d;">g</span> = Graph()
    g.<span style="color: #a0522d;">name</span> = name
    g.<span style="color: #a0522d;">desc</span> = desc

    db.session.add(g)

    <span style="color: #a020f0;">try</span>:
        db.session.commit()
        <span style="color: #a020f0;">return</span> g
    <span style="color: #a020f0;">except</span>:
        db.session.rollback()

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20026;DAG&#22686;&#21152;&#39030;&#28857;
</span><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">add_vertex</span>(graph: Graph, name: <span style="color: #483d8b;">str</span>, <span style="color: #483d8b;">input</span>=<span style="color: #008b8b;">None</span>, script=<span style="color: #008b8b;">None</span>):
    <span style="color: #a0522d;">v</span> = Vertex()
    v.<span style="color: #a0522d;">g_id</span> = graph.<span style="color: #483d8b;">id</span>
    v.<span style="color: #a0522d;">name</span> = name
    v.<span style="color: #483d8b;">input</span> = <span style="color: #483d8b;">input</span>
    v.<span style="color: #a0522d;">script</span> = script

    db.session.add(v)
    <span style="color: #a020f0;">try</span>:
        db.session.commit()
        <span style="color: #a020f0;">return</span> v
    <span style="color: #a020f0;">except</span>:
        db.session.rollback()

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20026;DAG&#22686;&#21152;&#36793;
</span><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">add_edge</span>(graph: Graph, tail: Vertex, head: Vertex):
    <span style="color: #a0522d;">e</span> = Edge()
    e.<span style="color: #a0522d;">g_id</span> = graph.<span style="color: #483d8b;">id</span>
    e.<span style="color: #a0522d;">tail</span> = tail.<span style="color: #483d8b;">id</span>
    e.<span style="color: #a0522d;">head</span> = head.<span style="color: #483d8b;">id</span>

    db.session.add(e)
    <span style="color: #a020f0;">try</span>:
        db.session.commit()
        <span style="color: #a020f0;">return</span> e
    <span style="color: #a020f0;">except</span>:
        db.session.rollback()

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#39030;&#28857;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#39030;&#28857;&#23601;&#35201;&#21024;&#38500;&#25152;&#26377;&#39030;&#28857;&#20851;&#32852;&#30340;&#36793;
</span><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">del_vertex</span>(<span style="color: #483d8b;">id</span>):
    <span style="color: #a0522d;">query</span> = db.session.query(Vertex).<span style="color: #483d8b;">filter</span>(Vertex.<span style="color: #483d8b;">id</span> == <span style="color: #483d8b;">id</span>)
    <span style="color: #a0522d;">v</span> = query.first()
    <span style="color: #a020f0;">if</span> v:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25214;&#21040;&#39030;&#28857;&#21518;&#65292;&#21024;&#38500;&#20851;&#32852;&#30340;&#36793;&#65292;&#28982;&#21518;&#21024;&#38500;&#39030;&#28857;
</span>        <span style="color: #a020f0;">try</span>:
            db.session.query(Edge).<span style="color: #483d8b;">filter</span>((Edge.tail == v.<span style="color: #483d8b;">id</span>) | (Edge.head == v.<span style="color: #483d8b;">id</span>)).delete()
            query.delete()
            db.session.commit()
        <span style="color: #a020f0;">except</span>:
            db.session.rollback()

    <span style="color: #a020f0;">return</span> v
</pre>
</div>

<p>
通过上面的代码，可以发现事务的处理代码都差不多，提出来使用装饰器。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> .model <span style="color: #a020f0;">import</span> db
<span style="color: #a020f0;">from</span> .model <span style="color: #a020f0;">import</span> Graph, Vertex, Edge
<span style="color: #a020f0;">from</span> .model <span style="color: #a020f0;">import</span> Pipeline, Track
<span style="color: #a020f0;">from</span> functools <span style="color: #a020f0;">import</span> wraps

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">transactional</span>(fn):
    <span style="color: #228b22;">@wraps</span>(fn)
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">wrapper</span>(*args, **kwargs):
        <span style="color: #a0522d;">ret</span> = fn(*args, **kwargs)
        <span style="color: #a020f0;">try</span>:
            db.session.commit()
            <span style="color: #a020f0;">return</span> ret
        <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
            <span style="color: #483d8b;">print</span>(e)
            db.session.rollback()

    <span style="color: #a020f0;">return</span> wrapper

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;DAG
</span><span style="color: #228b22;">@transactional</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">create_graph</span>(name, desc=<span style="color: #008b8b;">None</span>):
    <span style="color: #a0522d;">g</span> = Graph()
    g.<span style="color: #a0522d;">name</span> = name
    g.<span style="color: #a0522d;">desc</span> = desc

    db.session.add(g)
    <span style="color: #a020f0;">return</span> g

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20026;DAG&#22686;&#21152;&#39030;&#28857;
</span><span style="color: #228b22;">@transactional</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">add_vertex</span>(graph: Graph, name: <span style="color: #483d8b;">str</span>, <span style="color: #483d8b;">input</span>=<span style="color: #008b8b;">None</span>, script=<span style="color: #008b8b;">None</span>):
    <span style="color: #a0522d;">v</span> = Vertex()
    v.<span style="color: #a0522d;">g_id</span> = graph.<span style="color: #483d8b;">id</span>
    v.<span style="color: #a0522d;">name</span> = name
    v.<span style="color: #483d8b;">input</span> = <span style="color: #483d8b;">input</span>
    v.<span style="color: #a0522d;">script</span> = script

    db.session.add(v)
    <span style="color: #a020f0;">return</span> v

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20026;DAG&#22686;&#21152;&#36793;
</span><span style="color: #228b22;">@transactional</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">add_edge</span>(graph: Graph, tail: Vertex, head: Vertex):
    <span style="color: #a0522d;">e</span> = Edge()
    e.<span style="color: #a0522d;">g_id</span> = graph.<span style="color: #483d8b;">id</span>
    e.<span style="color: #a0522d;">tail</span> = tail.<span style="color: #483d8b;">id</span>
    e.<span style="color: #a0522d;">head</span> = head.<span style="color: #483d8b;">id</span>

    db.session.add(e)
    <span style="color: #a020f0;">return</span> e

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#39030;&#28857;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#39030;&#28857;&#23601;&#35201;&#21024;&#38500;&#25152;&#26377;&#39030;&#28857;&#20851;&#32852;&#30340;&#36793;
</span><span style="color: #228b22;">@transactional</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">del_vertex</span>(<span style="color: #483d8b;">id</span>):
    <span style="color: #a0522d;">query</span> = db.session.query(Vertex).<span style="color: #483d8b;">filter</span>(Vertex.<span style="color: #483d8b;">id</span> == <span style="color: #483d8b;">id</span>)
    <span style="color: #a0522d;">v</span> = query.first()
    <span style="color: #a020f0;">if</span> v:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25214;&#21040;&#39030;&#28857;&#21518;&#65292;&#21024;&#38500;&#20851;&#32852;&#30340;&#36793;&#65292;&#28982;&#21518;&#21024;&#38500;&#39030;&#28857;
</span>        db.session.query(Edge).<span style="color: #483d8b;">filter</span>((Edge.tail == v.<span style="color: #483d8b;">id</span>) | (Edge.head == v.<span style="color: #483d8b;">id</span>)).delete()
        query.delete()
    <span style="color: #a020f0;">return</span> v
</pre>
</div>
</div>
</li>
<li><a id="h:26dbf57c-7f77-4301-a795-ffec2a80fab7"></a>测试数据<br>
<div class="outline-text-6" id="text-h:26dbf57c-7f77-4301-a795-ffec2a80fab7">
<p>
编写 test.py，测试函数：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> json
<span style="color: #a020f0;">from</span> pipeline.service <span style="color: #a020f0;">import</span> Graph, Vertex, db
<span style="color: #a020f0;">from</span> pipeline.service <span style="color: #a020f0;">import</span> create_graph, add_vertex, add_edge

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27979;&#35797;&#25968;&#25454;
</span><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">test_create_dag</span>():
    <span style="color: #a020f0;">try</span>:
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;DAG
</span>        <span style="color: #a0522d;">g</span> = create_graph(<span style="color: #8b2252;">'test1'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25104;&#21151;&#21017;&#36820;&#22238;&#19968;&#20010;Graph&#23545;&#35937;
</span>        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#39030;&#28857;
</span>        <span style="color: #483d8b;">input</span> = {
            <span style="color: #8b2252;">"ip"</span>: {
                <span style="color: #8b2252;">"type"</span>: <span style="color: #8b2252;">"str"</span>,
                <span style="color: #8b2252;">"required"</span>: <span style="color: #008b8b;">True</span>,
                <span style="color: #8b2252;">"default"</span>: <span style="color: #8b2252;">"192.168.0.100"</span>
            }
        }

        <span style="color: #a0522d;">script</span> = {
            <span style="color: #8b2252;">"script"</span>: <span style="color: #8b2252;">"echo 'test1.A'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">ping {ip}"</span>,
            <span style="color: #8b2252;">"next"</span>: <span style="color: #8b2252;">"B"</span>
        }
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#37324;&#20026;&#20102;&#35753;&#29992;&#25143;&#26041;&#20415;&#65292;next&#21487;&#20197;&#25509;&#25910;2&#31181;&#31867;&#22411;&#65292;&#25968;&#23383;&#34920;&#31034;&#39030;&#28857;&#30340;id&#65292;&#23383;&#31526;&#20018;&#34920;&#31034;&#21516;&#19968;&#20010;DAG&#20013;&#35813;&#21517;&#31216;&#30340;&#33410;&#28857;&#65292;&#19981;&#33021;&#37325;&#22797;
</span>        <span style="color: #a0522d;">a</span> = add_vertex(g, <span style="color: #8b2252;">'A'</span>, json.dumps(<span style="color: #483d8b;">input</span>), json.dumps(script))  <span style="color: #b22222;"># </span><span style="color: #b22222;">next&#39030;&#28857;&#39564;&#35777;&#21487;&#20197;&#22312;&#23450;&#20041;&#26102;&#65292;&#20063;&#21487;&#20197;&#22312;&#20351;&#29992;&#26102;
</span>        <span style="color: #a0522d;">b</span> = add_vertex(g, <span style="color: #8b2252;">'B'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'echo B'</span>)
        <span style="color: #a0522d;">c</span> = add_vertex(g, <span style="color: #8b2252;">'C'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'echo C'</span>)
        <span style="color: #a0522d;">d</span> = add_vertex(g, <span style="color: #8b2252;">'D'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'echo D'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#36793;
</span>        <span style="color: #a0522d;">ab</span> = add_edge(g, a, b)
        <span style="color: #a0522d;">ac</span> = add_edge(g, a, c)
        <span style="color: #a0522d;">cb</span> = add_edge(g, c, b)
        <span style="color: #a0522d;">bd</span> = add_edge(g, b, d)

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#29615;&#36335;
</span>        <span style="color: #a0522d;">g</span> = create_graph(<span style="color: #8b2252;">'test2'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29615;&#36335;
</span>        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#39030;&#28857;
</span>        <span style="color: #a0522d;">a</span> = add_vertex(g, <span style="color: #8b2252;">'A'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'echo A'</span>)
        <span style="color: #a0522d;">b</span> = add_vertex(g, <span style="color: #8b2252;">'B'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'echo B'</span>)
        <span style="color: #a0522d;">c</span> = add_vertex(g, <span style="color: #8b2252;">'C'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'echo C'</span>)
        <span style="color: #a0522d;">d</span> = add_vertex(g, <span style="color: #8b2252;">'D'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'echo D'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#36793;, abc&#20043;&#38388;&#30340;&#29615;
</span>        <span style="color: #a0522d;">ba</span> = add_edge(g, b, a)
        <span style="color: #a0522d;">ac</span> = add_edge(g, a, c)
        <span style="color: #a0522d;">cb</span> = add_edge(g, c, b)
        <span style="color: #a0522d;">bd</span> = add_edge(g, b, d)

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;DAG
</span>        <span style="color: #a0522d;">g</span> = create_graph(<span style="color: #8b2252;">'test3'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22810;&#20010;&#32456;&#28857;
</span>        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#39030;&#28857;
</span>        <span style="color: #a0522d;">a</span> = add_vertex(g, <span style="color: #8b2252;">'A'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'echo A'</span>)
        <span style="color: #a0522d;">b</span> = add_vertex(g, <span style="color: #8b2252;">'B'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'echo B'</span>)
        <span style="color: #a0522d;">c</span> = add_vertex(g, <span style="color: #8b2252;">'C'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'echo C'</span>)
        <span style="color: #a0522d;">d</span> = add_vertex(g, <span style="color: #8b2252;">'D'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'echo D'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#36793;
</span>        <span style="color: #a0522d;">ba</span> = add_edge(g, b, a)
        <span style="color: #a0522d;">ac</span> = add_edge(g, a, c)
        <span style="color: #a0522d;">bc</span> = add_edge(g, b, c)
        <span style="color: #a0522d;">bd</span> = add_edge(g, b, d)

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;DAG
</span>        <span style="color: #a0522d;">g</span> = create_graph(<span style="color: #8b2252;">'test4'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22810;&#20837;&#21475;
</span>        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#39030;&#28857;
</span>        <span style="color: #a0522d;">a</span> = add_vertex(g, <span style="color: #8b2252;">'A'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'echo A'</span>)
        <span style="color: #a0522d;">b</span> = add_vertex(g, <span style="color: #8b2252;">'B'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'echo B'</span>)
        <span style="color: #a0522d;">c</span> = add_vertex(g, <span style="color: #8b2252;">'C'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'echo C'</span>)
        <span style="color: #a0522d;">d</span> = add_vertex(g, <span style="color: #8b2252;">'D'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'echo D'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#36793;
</span>        <span style="color: #a0522d;">ab</span> = add_edge(g, a, b)
        <span style="color: #a0522d;">ac</span> = add_edge(g, a, c)
        <span style="color: #a0522d;">cb</span> = add_edge(g, c, b)
        <span style="color: #a0522d;">db</span> = add_edge(g, d, b)
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        <span style="color: #483d8b;">print</span>(e)

test_create_dag()
</pre>
</div>
</div>
</li>
<li><a id="h:159cbab7-4395-4f31-be69-e1219b12654c"></a>DAG 验证<br>
<div class="outline-text-6" id="text-h:159cbab7-4395-4f31-be69-e1219b12654c">
<p>
当增加一个 DAG 定义后，或修改了 DAG 定义，就需要对 DAG进行验证，判断是否是一个 DAG 图。如何知道一个写入数据库的 DAG是有效的呢？
</p>

<p>
在 graph 表增加一个字段 checked，为 1就是检测通过，以后可以创建一个流程执行，为 0 检测不通过。
</p>

<p>
注意，如果有一个流程使用了这个 DAG，它就不允许被修改和删除。
</p>

<p>
为了实现这个功能，且不要每一次都查询一下这个 DAG 被使用，可以在 graph表提供一个字段 sealed，一旦设置就不能修改和删除，表示有人用了。
</p>

<p>
在 DAG 定义后、修改后，就立即进行 DAG检验，这样使用的时候就不用每次都检验。
</p>

<p>
图 graph
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">字段名</th>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">id</td>
<td class="org-left">int</td>
<td class="org-left">主键</td>
</tr>

<tr>
<td class="org-left">name</td>
<td class="org-left">varchar</td>
<td class="org-left">非空，唯一，图的名称</td>
</tr>

<tr>
<td class="org-left">desc</td>
<td class="org-left">varchar</td>
<td class="org-left">可为空，描述</td>
</tr>

<tr>
<td class="org-left">checked</td>
<td class="org-left">int</td>
<td class="org-left">不可为空，默认 0。0 表示经验证不能使用，1 表示可以创建执行流程</td>
</tr>

<tr>
<td class="org-left">sealed</td>
<td class="org-left">int</td>
<td class="org-left">不可为空，默认 0。0 表示未使用，1 表示已经有执行流程使用了，被封闭不可修改</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#22270;
</span><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Graph</span>(Base):
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">"graph"</span>

    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">name</span> = Column(String(48), nullable=<span style="color: #008b8b;">False</span>, unique=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">desc</span> = Column(String(500), nullable=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">checked</span> = Column(Integer, nullable=<span style="color: #008b8b;">False</span>, default=0)
    <span style="color: #a0522d;">sealed</span> = Column(Integer, nullable=<span style="color: #008b8b;">False</span>, default=0)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32463;&#24120;&#20174;&#22270;&#26597;&#30475;&#25152;&#26377;&#39030;&#28857;&#12289;&#36793;&#30340;&#20449;&#24687;
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#37324;&#24517;&#39035;&#20351;&#29992;foreign_keys&#65292;&#36825;&#26159;&#22240;&#20026;&#20174;&#19968;&#31471;&#26597;&#22810;&#31471;&#65292;&#20854;&#20540;&#24517;&#39035;&#20351;&#29992;&#24341;&#21495;
</span>    <span style="color: #a0522d;">vertexes</span> = relationship(<span style="color: #8b2252;">'Vertex'</span>, foreign_keys=<span style="color: #8b2252;">'Vertex.g_id'</span>)
    <span style="color: #a0522d;">edges</span> = relationship(<span style="color: #8b2252;">'Edge'</span>, foreign_keys=<span style="color: #8b2252;">'[Edge.g_id]'</span>)
</pre>
</div>

<p>
查找所有入度为 0 的顶点：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#25214;&#20986;graph id&#20026;1&#30340;&#25152;&#26377;&#39030;&#28857;&#21644;&#36793;
</span><span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> vertex v <span style="color: #a020f0;">INNER</span> <span style="color: #a020f0;">JOIN</span> edge e <span style="color: #a020f0;">on</span> v.g_id = e.g_id <span style="color: #a020f0;">AND</span> v.g_id = 1

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#25214;&#20986;graph id&#20026;1&#30340;&#39030;&#28857;&#21644;&#36793;&#65292;&#19988;&#24359;&#23614;&#26159;&#39030;&#28857;&#30340;&#65292;&#22240;&#20026;&#24038;&#32852;&#65292;&#26377;head&#20026;null
</span><span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> vertex v <span style="color: #a020f0;">LEFT</span> <span style="color: #a020f0;">JOIN</span> edge e <span style="color: #a020f0;">on</span> v.g_id = e.g_id <span style="color: #a020f0;">AND</span> e.head = v.id <span style="color: #a020f0;">WHERE</span> v.g_id = 1

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#22686;&#21152;&#19968;&#20010;&#26465;&#20214;edge head&#20026;null&#23601;&#21487;&#20197;&#25552;&#21462;&#20986;&#25351;&#23450;graph&#20013;&#20837;&#24230;&#20026;0&#30340;&#39030;&#28857;
</span><span style="color: #a020f0;">SELECT</span> v.* <span style="color: #a020f0;">FROM</span> vertex v <span style="color: #a020f0;">LEFT</span> <span style="color: #a020f0;">JOIN</span> edge e <span style="color: #a020f0;">ON</span> v.g_id = e.g_id <span style="color: #a020f0;">AND</span> e.head = v.id <span style="color: #a020f0;">WHERE</span> v.g_id = 1 <span style="color: #a020f0;">AND</span> e.head <span style="color: #a020f0;">IS</span> <span style="color: #a020f0;">NULL</span>
</pre>
</div>

<p>
采用左联在 edge 里面找 null 的方式，找入度为 0 的顶点。
</p>

<p>
但是这种找法不适合验证 DAG，因为第一批入度 0的顶点找到后，还需要再次查询，找第二批顶点。
</p>

<p>
能否换个思路呢？
</p>

<p>
把所有的顶点、边都先查一遍，然后在客户端数据结构中想办法处理，而不是多次来查询数据库。
</p>

<p>
<b>kahn 算法实现</b>
</p>

<p>
<i>算法 1：</i>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">check_graph</span>(graph: Graph) -&gt; <span style="color: #483d8b;">bool</span>:
    <span style="color: #8b2252;">"""&#39564;&#35777;&#26159;&#21542;&#26159;&#19968;&#20010;&#21512;&#27861;&#30340;DAG"""</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21453;&#27491;&#35201;&#36941;&#21382;&#25152;&#26377;&#39030;&#28857;&#21644;&#36793;&#65292;&#19981;&#22914;&#19968;&#27425;&#24615;&#25226;&#25152;&#26377;&#39030;&#28857;&#21644;&#36793;&#37117;&#26597;&#22238;&#26469;&#65292;&#22312;&#20869;&#23384;&#20013;&#21453;&#22797;&#36941;&#21382;
</span>    <span style="color: #a0522d;">query</span> = db.session.query(Vertex).<span style="color: #483d8b;">filter</span>(Vertex.g_id == graph.<span style="color: #483d8b;">id</span>)
    <span style="color: #a0522d;">vertexes</span> = [vertex.<span style="color: #483d8b;">id</span> <span style="color: #a020f0;">for</span> vertex <span style="color: #a020f0;">in</span> query]  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#39030;&#28857;&#21015;&#34920;
</span>    <span style="color: #a0522d;">query</span> = db.session.query(Edge).<span style="color: #483d8b;">filter</span>(Edge.g_id == graph.<span style="color: #483d8b;">id</span>)
    <span style="color: #a0522d;">edges</span> = [(edge.tail, edge.head) <span style="color: #a020f0;">for</span> edge <span style="color: #a020f0;">in</span> query]

    <span style="color: #b22222;"># </span><span style="color: #b22222;">([1, 2, 3, 4], [(1, 2), (1, 3), (3, 2), (2, 4)])
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36941;&#21382;&#39030;&#28857;&#65292;&#21435;&#25214;
</span>    <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
        <span style="color: #a0522d;">vis</span> = []  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23601;&#25918;&#19968;&#20010;&#32034;&#24341;&#65292;&#29992;&#21015;&#34920;&#26159;&#20026;&#20102;&#29992;&#30340;&#26041;&#20415;
</span>        <span style="color: #a020f0;">for</span> i, v <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">enumerate</span>(vertexes):
            <span style="color: #a020f0;">for</span> _, h <span style="color: #a020f0;">in</span> edges:
                <span style="color: #a020f0;">if</span> h == v:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24403;&#21069;&#39030;&#28857;&#26377;&#20837;&#24230;
</span>                    <span style="color: #a020f0;">break</span>
            <span style="color: #a020f0;">else</span>:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27809;&#26377;break&#65292;&#35828;&#26126;&#36941;&#21382;&#25152;&#26377;&#36793;&#65292;&#27809;&#26377;&#25214;&#21040;&#35813;&#39030;&#28857;&#20316;&#20026;&#24359;&#22836;&#65292;&#23601;&#26159;&#20837;&#24230;&#20026;0
</span>                <span style="color: #a0522d;">ejs</span> = []
                <span style="color: #a020f0;">for</span> j, (t, _) <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">enumerate</span>(edges):
                    <span style="color: #a020f0;">if</span> t == v:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25214;&#36825;&#20010;&#39030;&#28857;&#30340;&#20986;&#24230;&#30340;&#36793;
</span>                        ejs.append(j)
                vis.append(i)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24453;&#31227;&#38500;&#30340;&#20837;&#24230;&#20026;0&#30340;&#39030;&#28857;&#30340;&#32034;&#24341;
</span>                <span style="color: #a020f0;">for</span> j <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">reversed</span>(ejs):  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36870;&#21521;
</span>                    edges.pop(j)
                <span style="color: #a020f0;">break</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19968;&#26086;&#25214;&#21040;&#20837;&#24230;&#20026;0&#30340;&#39030;&#28857;&#65292;&#23601;&#38656;&#35201;&#20174;&#21015;&#34920;&#20013;&#21024;&#38500;&#65292;&#21015;&#34920;&#37325;&#26032;&#36941;&#21382;
</span>        <span style="color: #a020f0;">else</span>:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36941;&#21382;&#19968;&#36941;&#21097;&#20313;&#39030;&#28857;&#65292;&#37117;&#27809;&#26377;break&#65292;&#35828;&#26126;&#27809;&#26377;&#25214;&#21040;&#20837;&#24230;0&#30340;&#39030;&#28857;
</span>            <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">False</span>

        <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> vis:
            vertexes.pop(i)

        <span style="color: #483d8b;">print</span>(vertexes, edges)

        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(vertexes) + <span style="color: #483d8b;">len</span>(edges) == 0:
            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#39564;&#36890;&#36807;&#65292;&#20462;&#25913;checked&#23383;&#27573;&#20026;1
</span>            <span style="color: #a020f0;">try</span>:
                <span style="color: #a0522d;">graph</span> = db.session.query(Graph).<span style="color: #483d8b;">filter</span>(Graph.<span style="color: #483d8b;">id</span> == graph.<span style="color: #483d8b;">id</span>).first()
                <span style="color: #a020f0;">if</span> graph:
                    graph.<span style="color: #a0522d;">checked</span> = 1
                db.session.add(graph)
                db.session.commit()
                <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">True</span>
            <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
                db.session.rollback()
                <span style="color: #a020f0;">raise</span> e
</pre>
</div>

<p>
算法思路：
</p>

<p>
一次把一个 DAG 的所有顶点、所有边都拿回来。
</p>

<p>
遍历顶点，拿出一个顶点，就去边列表中找它是否作为弧头，如果它是弧头，立即判断下一个顶点。如果这个顶点在边列表中都没有找到它作为弧头，就是入度为0 的顶点，就可以移除它作为弧尾的边和它本身了。
</p>

<p>
注意，因为移除会导致列表索引的变化，所以采用了先记录索引，后倒序删除索引的方式。
</p>

<p>
如果入度为 0的顶点和它作为弧尾的有向边都移除，最后剩下一个空图，就说明此图是DAG。空图的判断，使用非负整数相加为 0，则一定都是 0。
</p>

<p>
如果一轮遍历，没有找到入度为 0 的顶点，说明它不是 DAG。
</p>

<p>
算法 1 迭代次数太多了。
</p>

<p>
<i>算法 2：</i>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> collections <span style="color: #a020f0;">import</span> defaultdict

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">check_graph</span>(graph: Graph) -&gt; <span style="color: #483d8b;">bool</span>:
    <span style="color: #a0522d;">query</span> = db.session.query(Vertex).<span style="color: #483d8b;">filter</span>(Vertex.g_id == graph.<span style="color: #483d8b;">id</span>)
    <span style="color: #a0522d;">vertexes</span> = {vertex.<span style="color: #483d8b;">id</span> <span style="color: #a020f0;">for</span> vertex <span style="color: #a020f0;">in</span> query}

    <span style="color: #a0522d;">query</span> = db.session.query(Edge).<span style="color: #483d8b;">filter</span>(Edge.g_id == graph.<span style="color: #483d8b;">id</span>)
    <span style="color: #a0522d;">edges</span> = defaultdict(<span style="color: #483d8b;">list</span>)
    <span style="color: #a0522d;">ids</span> = <span style="color: #483d8b;">set</span>()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26377;&#20837;&#24230;&#30340;&#39030;&#28857;
</span>    <span style="color: #a020f0;">for</span> edge <span style="color: #a020f0;">in</span> query:
        <span style="color: #b22222;"># </span><span style="color: #b22222;">defaultdict(&lt;class 'list'&gt;, {1: [(1, 2), (1, 3)], 2: [(2, 4)], 3: [(3, 2)]})
</span>        edges[edge.tail].append((edge.tail, edge.head))
        ids.add(edge.head)

    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-='</span> * 30)
    <span style="color: #483d8b;">print</span>(vertexes, edges)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">===============&#27979;&#35797;&#25968;&#25454;===============
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">{1, 2, 3, 4}
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">defaultdict(&lt;class 'list'&gt;, {1: [(1, 2), (1, 3)], 2: [(2, 4)], 3: [(3, 2)]})
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">vertexes = {1, 2, 3, 4}
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">edges = {1: [(1, 2), (1, 3)], 2: [(2, 4)], 3: [(3, 2)]}
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">ids = set() # &#26377;&#20837;&#24230;&#30340;&#39030;&#28857;
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">=====================================
</span>
    <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(edges) == 0:
        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">False</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19968;&#26465;&#36793;&#37117;&#27809;&#26377;&#65292;&#36825;&#26679;&#30340;DAG&#19994;&#21153;&#19978;&#19981;&#29992;
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;edges&#19981;&#20026;&#31354;&#65292;&#19968;&#23450;&#26377;ids&#65292;&#20063;&#23601;&#26159;&#26377;&#20837;&#24230;&#30340;&#39030;&#28857;
</span>    <span style="color: #a0522d;">zds</span> = vertexes - ids <span style="color: #b22222;"># </span><span style="color: #b22222;">zds&#20837;&#24230;&#20026;0&#30340;&#39030;&#28857;
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">zds&#20026;0&#35828;&#26126;&#27809;&#26377;&#25214;&#21040;&#20837;&#24230;&#20026;0&#30340;&#39030;&#28857;&#65292;&#31639;&#27861;&#32456;&#27490;
</span>    <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(zds):
        <span style="color: #a020f0;">for</span> zd <span style="color: #a020f0;">in</span> zds:
            <span style="color: #a020f0;">if</span> zd <span style="color: #a020f0;">in</span> edges:
                <span style="color: #a020f0;">del</span> edges[zd]

        <span style="color: #a020f0;">while</span> edges:
            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;&#39030;&#28857;&#38598;&#25913;&#20026;&#24403;&#21069;&#20837;&#24230;&#39030;&#28857;&#38598;ids
</span>            <span style="color: #a0522d;">vertexes</span> = ids
            <span style="color: #a0522d;">ids</span> = <span style="color: #483d8b;">set</span>() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#37325;&#26032;&#23547;&#25214;&#26377;&#20837;&#24230;&#30340;&#39030;&#28857;
</span>
            <span style="color: #a020f0;">for</span> lst <span style="color: #a020f0;">in</span> edges.values():
                <span style="color: #a020f0;">for</span> edge <span style="color: #a020f0;">in</span> lst:
                    ids.add(edge[1])
            <span style="color: #a0522d;">zds</span> = vertexes - ids
            <span style="color: #483d8b;">print</span>(vertexes, ids, zds)
            <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(zds) == 0: <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26377;&#29615;&#36335;
</span>                <span style="color: #a020f0;">break</span>
            <span style="color: #a020f0;">for</span> zd <span style="color: #a020f0;">in</span> zds:
                <span style="color: #a020f0;">if</span> zd <span style="color: #a020f0;">in</span> edges: <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26377;&#21487;&#33021;&#39030;&#28857;&#27809;&#26377;&#20986;&#24230;
</span>                    <span style="color: #a020f0;">del</span> edges[zd]
            <span style="color: #483d8b;">print</span>(edges)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36793;&#38598;&#20026;&#31354;&#65292;&#21097;&#19979;&#25152;&#26377;&#39030;&#28857;&#37117;&#26159;&#20837;&#24230;&#20026;0&#30340;&#65292;&#37117;&#21487;&#20197;&#22810;&#27425;&#36845;&#20195;&#21024;&#38500;&#25481;
</span>    <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(edges) == 0:
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#39564;&#36890;&#36807;&#65292;&#20462;&#25913;checked&#23383;&#27573;&#20026;1
</span>        <span style="color: #a020f0;">try</span>:
            <span style="color: #a0522d;">graph</span> = db.session.query(Graph).<span style="color: #483d8b;">filter</span>(Graph.<span style="color: #483d8b;">id</span> == graph.<span style="color: #483d8b;">id</span>).first()
            <span style="color: #a020f0;">if</span> graph:
                graph.<span style="color: #a0522d;">checked</span> = 1
            db.session.add(graph)
            db.session.commit()
            <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">True</span>
        <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
            db.session.rollback()
            <span style="color: #a020f0;">raise</span> e

    <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">False</span>
</pre>
</div>

<p>
算法思路：
</p>

<p>
还是一次把顶点、边都从数据库拿出来，减少和数据库的交互。
</p>

<p>
顶点 id 不可能重复，所以采用 set。
</p>

<p>
边从库中拿出的时候，就把弧尾作为字典 key 便于删除入度为 0 的顶点的边。
</p>

<p>
注意一点，只要边字典有值，就说明一定有入度不为 0 的顶点。
</p>

<p>
如果用当前的顶点集减去所有入度不为 0 的顶点集，结果有 2 种可能：
</p>

<p>
1、不为空集，说明这是入度为 0 的顶点集
</p>

<p>
2、空集，说明有环
</p>

<p>
判断依据：
</p>

<ul class="org-ul">
<li>如果边字典为空退出循环，说明已经没有边了，但是顶点集可能还有顶点。
<ul class="org-ul">
<li>如果顶点集还有顶点，都是入度为 0 的顶点，都可以移除的。</li>
<li>说明就是 DAG。</li>
</ul></li>
<li>如果入度为 0 的顶点没有找到就退出。
<ul class="org-ul">
<li>如果边字典不为空，说明有环。</li>
</ul></li>
</ul>

<p>
两种算法效率测试：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">check_graph1</span>(graph=<span style="color: #008b8b;">None</span>) -&gt; <span style="color: #483d8b;">bool</span>:
    <span style="color: #8b2252;">"""&#39564;&#35777;&#26159;&#21542;&#26159;&#19968;&#20010;&#21512;&#27861;&#30340;DAG"""</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">===============&#27979;&#35797;&#25968;&#25454;===============
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">([1, 2, 3, 4], [(1, 2), (1, 3), (3, 2), (2, 4)])
</span>    <span style="color: #a0522d;">vertexes</span> = [1, 2, 3, 4]
    <span style="color: #a0522d;">edges</span> = [(1, 2), (1, 3), (3, 2), (2, 4)]
    <span style="color: #b22222;"># </span><span style="color: #b22222;">=====================================
</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36941;&#21382;&#39030;&#28857;&#65292;&#21435;&#25214;
</span>    <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
        <span style="color: #a0522d;">vis</span> = []  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23601;&#25918;&#19968;&#20010;&#32034;&#24341;&#65292;&#29992;&#21015;&#34920;&#26159;&#20026;&#20102;&#29992;&#30340;&#26041;&#20415;
</span>        <span style="color: #a020f0;">for</span> i, v <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">enumerate</span>(vertexes):
            <span style="color: #a020f0;">for</span> _, h <span style="color: #a020f0;">in</span> edges:
                <span style="color: #a020f0;">if</span> h == v:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24403;&#21069;&#39030;&#28857;&#26377;&#20837;&#24230;
</span>                    <span style="color: #a020f0;">break</span>
            <span style="color: #a020f0;">else</span>:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27809;&#26377;break&#65292;&#35828;&#26126;&#36941;&#21382;&#25152;&#26377;&#36793;&#65292;&#27809;&#26377;&#25214;&#21040;&#35813;&#39030;&#28857;&#20316;&#20026;&#24359;&#22836;&#65292;&#23601;&#26159;&#20837;&#24230;&#20026;0
</span>                <span style="color: #a0522d;">ejs</span> = []
                <span style="color: #a020f0;">for</span> j, (t, _) <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">enumerate</span>(edges):
                    <span style="color: #a020f0;">if</span> t == v:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25214;&#36825;&#20010;&#39030;&#28857;&#30340;&#20986;&#24230;&#30340;&#36793;
</span>                        ejs.append(j)
                vis.append(i)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24453;&#31227;&#38500;&#30340;&#20837;&#24230;&#20026;0&#30340;&#39030;&#28857;&#30340;&#32034;&#24341;
</span>                <span style="color: #a020f0;">for</span> j <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">reversed</span>(ejs):  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36870;&#21521;
</span>                    edges.pop(j)
                <span style="color: #a020f0;">break</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19968;&#26086;&#25214;&#21040;&#20837;&#24230;&#20026;0&#30340;&#39030;&#28857;&#65292;&#23601;&#38656;&#35201;&#20174;&#21015;&#34920;&#20013;&#21024;&#38500;&#65292;&#21015;&#34920;&#37325;&#26032;&#36941;&#21382;
</span>        <span style="color: #a020f0;">else</span>:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36941;&#21382;&#19968;&#36941;&#21097;&#20313;&#39030;&#28857;&#65292;&#37117;&#27809;&#26377;break&#65292;&#35828;&#26126;&#27809;&#26377;&#25214;&#21040;&#20837;&#24230;0&#30340;&#39030;&#28857;
</span>            <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">False</span>

        <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> vis:
            vertexes.pop(i)

        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(vertexes) + <span style="color: #483d8b;">len</span>(edges) == 0:
            <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">True</span>
        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">False</span>

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">check_graph2</span>(graph=<span style="color: #008b8b;">None</span>) -&gt; <span style="color: #483d8b;">bool</span>:
    <span style="color: #8b2252;">"""&#39564;&#35777;&#26159;&#21542;&#26159;&#19968;&#20010;&#21512;&#27861;&#30340;DAG"""</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">===============&#27979;&#35797;&#25968;&#25454;===============
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">{1, 2, 3, 4} defaultdict(&lt;class 'list'&gt;, {1: [(1, 2), (1, 3)], 2: [(2, 4)], 3: [(3, 2)]})
</span>    <span style="color: #a0522d;">vertexes</span> = {1, 2, 3, 4}
    <span style="color: #a0522d;">edges</span> = {1: [(1, 2), (1, 3)], 2: [(2, 4)], 3: [(3, 2)]}
    <span style="color: #a0522d;">ids</span> = <span style="color: #483d8b;">set</span>()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26377;&#20837;&#24230;&#30340;&#39030;&#28857;
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">=====================================
</span>
    <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(edges) == 0:
        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">False</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19968;&#26465;&#36793;&#37117;&#27809;&#26377;&#65292;&#36825;&#26679;&#30340;DAG&#19994;&#21153;&#19978;&#19981;&#29992;
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;edges&#19981;&#20026;&#31354;&#65292;&#19968;&#23450;&#26377;ids&#65292;&#20063;&#23601;&#26159;&#26377;&#20837;&#24230;&#30340;&#39030;&#28857;
</span>    <span style="color: #a0522d;">zds</span> = vertexes - ids  <span style="color: #b22222;"># </span><span style="color: #b22222;">zds&#20837;&#24230;&#20026;0&#30340;&#39030;&#28857;
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">zds&#20026;0&#35828;&#26126;&#27809;&#26377;&#25214;&#21040;&#20837;&#24230;&#20026;0&#30340;&#39030;&#28857;&#65292;&#31639;&#27861;&#32456;&#27490;
</span>    <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(zds):
        <span style="color: #a020f0;">for</span> zd <span style="color: #a020f0;">in</span> zds:
            <span style="color: #a020f0;">if</span> zd <span style="color: #a020f0;">in</span> edges:
                <span style="color: #a020f0;">del</span> edges[zd]

        <span style="color: #a020f0;">while</span> edges:
            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;&#39030;&#28857;&#38598;&#25913;&#20026;&#24403;&#21069;&#20837;&#24230;&#39030;&#28857;&#38598;ids
</span>            <span style="color: #a0522d;">vertexes</span> = ids
            <span style="color: #a0522d;">ids</span> = <span style="color: #483d8b;">set</span>()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#37325;&#26032;&#23547;&#25214;&#26377;&#20837;&#24230;&#30340;&#39030;&#28857;
</span>
            <span style="color: #a020f0;">for</span> lst <span style="color: #a020f0;">in</span> edges.values():
                <span style="color: #a020f0;">for</span> edge <span style="color: #a020f0;">in</span> lst:
                    ids.add(edge[1])
            <span style="color: #a0522d;">zds</span> = vertexes - ids
            <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(zds) == 0:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26377;&#29615;&#36335;
</span>                <span style="color: #a020f0;">break</span>
            <span style="color: #a020f0;">for</span> zd <span style="color: #a020f0;">in</span> zds:
                <span style="color: #a020f0;">if</span> zd <span style="color: #a020f0;">in</span> edges:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26377;&#21487;&#33021;&#39030;&#28857;&#27809;&#26377;&#20986;&#24230;
</span>                    <span style="color: #a020f0;">del</span> edges[zd]

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36793;&#38598;&#20026;&#31354;&#65292;&#21097;&#19979;&#25152;&#26377;&#39030;&#28857;&#37117;&#26159;&#20837;&#24230;&#20026;0&#30340;&#65292;&#37117;&#21487;&#20197;&#22810;&#27425;&#36845;&#20195;&#21024;&#38500;&#25481;
</span>    <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(edges) == 0:
        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">True</span>

    <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">False</span>

<span style="color: #a020f0;">import</span> datetime

<span style="color: #a0522d;">start</span> = datetime.datetime.now()

<span style="color: #a020f0;">for</span> _ <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(100000):
    check_graph1()
<span style="color: #483d8b;">print</span>((datetime.datetime.now() - start).total_seconds())

<span style="color: #a0522d;">start</span> = datetime.datetime.now()
<span style="color: #a020f0;">for</span> _ <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(100000):
    check_graph2()
<span style="color: #483d8b;">print</span>((datetime.datetime.now() - start).total_seconds())

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27979;&#35797;&#32467;&#26524;
</span>0.211792
0.171121
</pre>
</div>

<p>
算法 2 有明显优势，使用算法 2
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pipeline.service <span style="color: #a020f0;">import</span> Graph, db
<span style="color: #a020f0;">from</span> pipeline.service <span style="color: #a020f0;">import</span> check_graph

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">test_check_all_graph</span>():
    <span style="color: #a0522d;">query</span> = db.session.query(Graph).<span style="color: #483d8b;">filter</span>(Graph.checked == 0).<span style="color: #483d8b;">all</span>()
    <span style="color: #a020f0;">for</span> g <span style="color: #a020f0;">in</span> query:
        <span style="color: #a020f0;">if</span> check_graph(g):
            g.<span style="color: #a0522d;">checked</span> = 1
            db.session.add(g)
    <span style="color: #a020f0;">try</span>:
        db.session.commit()
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'done'</span>)
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        db.session.rollback()
        <span style="color: #a020f0;">raise</span> e

test_check_all_graph()
</pre>
</div>

<p>
验证成功，就会设置 DAG 图的 checked 字段为 1。
</p>

<p>
业务上应该在创建一个新的 DAG 的时候立即验证，或在修改一个 DAG后立即验证。
</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:04ec2f79-e221-47f9-a375-86e831fb5551" class="outline-4">
<h4 id="h:04ec2f79-e221-47f9-a375-86e831fb5551">流程系统</h4>
<div class="outline-text-4" id="text-h:04ec2f79-e221-47f9-a375-86e831fb5551">
<p>
目前已经完成了流程定义的实现，下面要使用它来实现任务流程的流转。
</p>

<p>
目前设计存在如下问题：
</p>

<ul class="org-ul">
<li>用户是否需要频繁查取正在运行任务状态？需要的，使用 pipeline 表以减少对
track 的查询，提高效率。</li>

<li>pipeline
表不能很好的描述多节点，如果描述当前运行的流程有分支，且正在执行的超过一个顶点，就不好描述了，因为每一个顶点都有自己的状态，这张表就要描述一对多关系，目前不适合。</li>

<li>如果一个流程有多起点，pipeline 如何描述？目前不适合。</li>

<li>如果一个流程任务对应的顶点大于 1

<ul class="org-ul">
<li>如何在 pipeline 表中表示，目前不适合。</li>

<li>运行条件是什么？要求前面所有任务都必须是成功状态。</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-language-mermaid">graph LR
A --&gt; C --&gt; D
B --&gt; C --&gt; E
</pre>
</div>

<p>
为了解决上面的问题：
</p>

<ul class="org-ul">
<li>目前 pipeline 表的设计不能很好地满足业务需求，直接废弃原有设计。将
pipeline 表改成用来记录任务流信息，字段有 g_id、name、desc、state 等。
<ul class="org-ul">
<li>g_id 表示使用哪一个 DAG。</li>
<li>name 任务流名称，例如 WEB 服务器检查。</li>
<li>desc 任务流详细描述。</li>
<li>state 记录整个任务流的状态，有 3 种。</li>
<li>有节点运行就是 STATE_RUNNING。</li>
<li>有节点失败就是 STATE_FAILED。</li>
<li>全部节点都成功就是 STATE_FINISH。</li>
</ul></li>
<li>用 track 表来记录流程信息，一个任务流产生，在它这里记录数据，使用
pipeline 任务流 ID 即 p_id，并记录状态。</li>
<li>任务节点执行状态，有 5 种。没有 FINISH，它是描述整个任务流的。
<ul class="org-ul">
<li>STATE_WAITING = 0</li>
<li>STATE_PENDING = 1</li>
<li>STATE_RUNNING = 2</li>
<li>STATE_SUCCEED = 3</li>
<li>STATE_FAILED = 4</li>
</ul></li>
<li>如何解决频繁查询全部节点信息的状态？创建任务流时，从 vertex 表中复制到
track 表，所有顶点状态为 STATE_WAITING。起点要被设置为 STATE_PENDING。</li>
<li>如何解决反复查询当前正在执行的任务？在 state
字段上建立索引，提高查询效率。</li>
<li>什么是正在执行的任务节点？STATE_WAITING 表示等待执行，STATE_PENDING
表示入调度器准备执行，STATE_RUNNING 表示该此节点正在执行。</li>
<li>如何描述一个任务流执行完成了？
<ul class="org-ul">
<li>有一个任务顶点执行失败，则整个任务执行失败，所有节点不再继续执行。pipeline
中表示为 STATE_FAILED。</li>
<li>所有节点都成功 STATE_SUCCEED ，则将 pipeline 中的状态置为
STATE_FINISH。</li>
</ul></li>
<li>如果一个流程有多起点，在所有节点信息复制到 track
表中的时候就将这些节点的状态置为 STATE_PENDING。</li>
<li>如果一个流程节点的入度大于 1，需要它的前驱节点都要是成功状态
STATE_SUCCEED，它才能被置为 STATE_PENDING。</li>
<li>如果流程节点执行完成，就是成功、失败这两种状态之一，这些状态都要写入
track 表，如果 track 表中该 p_id 的所有节点都成功，pipeline
中该任务状态 STATE_FINISH。</li>
<li>如果一个流程有多终点，同上，所有节点都必须成功，否则就是失败。</li>
<li>如果一个 DAG 定义中有孤立的顶点，如 A -&gt; B C，C
是一个孤立的顶点，如何解决？
<ul class="org-ul">
<li>可以认为不合法，使用
=所有顶点集 - 所有边关联的顶点集 = 孤立顶点集=。</li>
<li>可以认为合法，就是一个入度为 0
的顶点，可以执行。可以认为是多起点，同时又是多终点。</li>
<li>本项目认为*合法*。</li>
</ul></li>
<li>节点流转，要求其所有前驱节点必须是成功状态 STATE_SUCCEED。</li>
<li>track 表增加记录用户操作的脚本 script 字段，减少使用 input
替换的时间。</li>
</ul>

<p>
模型设计修改如下：
</p>


<figure id="org0adaac6">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_29.png" alt="dag_29.png">

</figure>

<p>
model.py 修改：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Pipeline</span>(Base):
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">'pipeline'</span>

    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">g_id</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'graph.id'</span>), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">current = Column(Integer, ForeignKey('vertex.id'), nullable=False)
</span>    <span style="color: #a0522d;">name</span> = Column(String(48), nullable=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">state</span> = Column(Integer, nullable=<span style="color: #008b8b;">False</span>, default=STATE_WAITING)
    <span style="color: #a0522d;">desc</span> = Column(String(100))

    <span style="color: #b22222;"># </span><span style="color: #b22222;">vertex = relationship('Vertex')
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20174;pipeline&#21435;&#26597;&#25152;&#26377;&#33410;&#28857;&#20449;&#24687;
</span>    <span style="color: #a0522d;">tracks</span> = relationship(<span style="color: #8b2252;">'Track'</span>, foreign_keys=<span style="color: #8b2252;">'Track.p_id'</span>)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Track</span>(Base):
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">'track'</span>

    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">p_id</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'pipeline.id'</span>), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">v_id</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'vertex.id'</span>), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">state</span> = Column(Integer,index=<span style="color: #008b8b;">True</span>, nullable=<span style="color: #008b8b;">False</span>, default=STATE_WAITING) <span style="color: #b22222;"># </span><span style="color: #b22222;">+&#32034;&#24341;
</span>    <span style="color: #483d8b;">input</span> = Column(Text, nullable=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">output</span> = Column(Text, nullable=<span style="color: #008b8b;">True</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20219;&#21153;&#36755;&#20986;
</span>    <span style="color: #a0522d;">script</span> = Column(Text, nullable=<span style="color: #008b8b;">True</span>)

    <span style="color: #a0522d;">vertex</span> = relationship(<span style="color: #8b2252;">'Vertex'</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">pipeline = relationship('Pipeline')  # &#19968;&#31471;&#22810;&#31471;&#38543;&#20415;&#20889;&#19968;&#20010;&#21363;&#21487;&#65292;&#19981;&#35201;&#37325;&#22797;
</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> f<span style="color: #8b2252;">"&lt;</span>{<span style="color: #a020f0;">self</span>.__class__.<span style="color: #483d8b;">__name__</span>}<span style="color: #8b2252;"> </span>{<span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">id</span>}<span style="color: #8b2252;"> </span>{<span style="color: #a020f0;">self</span>.p_id}<span style="color: #8b2252;"> </span>{<span style="color: #a020f0;">self</span>.v_id}<span style="color: #8b2252;">"</span>

    <span style="color: #a0522d;">__str__</span> = __repr__
</pre>
</div>
</div>
<div id="outline-container-h:280b1701-b147-4127-abda-bc5fa8df3c77" class="outline-5">
<h5 id="h:280b1701-b147-4127-abda-bc5fa8df3c77">执行引擎</h5>
<div class="outline-text-5" id="text-h:280b1701-b147-4127-abda-bc5fa8df3c77">
</div>
<ul class="org-ul">
<li><a id="h:88b870d1-a811-436c-b3b8-6859b4dcf0db"></a>开启一个流程<br>
<div class="outline-text-6" id="text-h:88b870d1-a811-436c-b3b8-6859b4dcf0db">
<p>
开启一个流程的时候，需要在界面中选取一个 checked 为 1 的即验证过的
DAG。为流程起名、填写描述，提交。
</p>

<p>
创建一个流程后，得到流程 ID 即 p_id，将流程所有顶点加入到 track 表。
</p>

<p>
读取所有边，找出入度为 0 的顶点，这些顶点在 track 表中的状态置为RUNNING，其它非起点节点置为 WAITING。
</p>

<p>
如何用 SQL 找到入度为 0 的顶点？子查询实现：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span>
    id 
<span style="color: #a020f0;">FROM</span>
    vertex 
<span style="color: #a020f0;">WHERE</span>
    vertex.g_id = 1 
    <span style="color: #a020f0;">AND</span> id <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">IN</span> (
    <span style="color: #a020f0;">SELECT</span>
        head 
    <span style="color: #a020f0;">FROM</span>
        edge 
<span style="color: #a020f0;">WHERE</span>
    edge.g_id = 1)
</pre>
</div>

<p>
如何 sqlalchemy 实现这个子查询呢？
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#35810;&#36825;&#20010;graph&#30340;&#25152;&#26377;&#39030;&#28857;
</span><span style="color: #a0522d;">vertexes</span> = db.session.query(Vertex.<span style="color: #483d8b;">id</span>).<span style="color: #483d8b;">filter</span>(Vertex.g_id == graph.<span style="color: #483d8b;">id</span>)
<span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> vertexes:
    <span style="color: #a020f0;">return</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#20986;&#25152;&#26377;&#36215;&#28857;&#65292;&#20837;&#24230;&#20026;0&#65292;&#23376;&#26597;&#35810;&#23454;&#29616;
</span><span style="color: #a0522d;">query</span> = vertexes.<span style="color: #483d8b;">filter</span>(Vertex.<span style="color: #483d8b;">id</span>.notin_(db.session.query(Edge.head).<span style="color: #483d8b;">filter</span>(Edge.g_id == graph.<span style="color: #483d8b;">id</span>)))
<span style="color: #a0522d;">zds</span> = {x[0] <span style="color: #a020f0;">for</span> x <span style="color: #a020f0;">in</span> query} <span style="color: #b22222;"># </span><span style="color: #b22222;">query&#27599;&#19968;&#20010;&#20803;&#32032;&#26159;&#19968;&#20010;&#20803;&#32452;
</span><span style="color: #483d8b;">print</span>(zds)
</pre>
</div>

<p>
在 pipeline 包中新建一个 executor.py：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">executor.py
</span><span style="color: #a020f0;">from</span> .model <span style="color: #a020f0;">import</span> Graph, Vertex, Edge, Pipeline, Track
<span style="color: #a020f0;">from</span> .model <span style="color: #a020f0;">import</span> STATE_WAITING, STATE_PENDING, STATE_RUNNING
<span style="color: #a020f0;">from</span> .service <span style="color: #a020f0;">import</span> transactional, db

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24320;&#21551;&#19968;&#20010;&#27969;&#31243;&#65292;&#29992;&#25143;&#25351;&#23450;&#19968;&#20010;&#21517;&#31216;&#12289;&#25551;&#36848;
</span><span style="color: #228b22;">@transactional</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">start</span>(graph: Graph, name: <span style="color: #483d8b;">str</span>, desc=<span style="color: #008b8b;">None</span>):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21028;&#26029;&#27969;&#31243;&#26159;&#21542;&#23384;&#22312;&#65292;&#19988;checked&#20026;1&#21363;&#26816;&#39564;&#36807;&#30340;
</span>    <span style="color: #a0522d;">g</span> = db.session.query(Graph).<span style="color: #483d8b;">filter</span>(Graph.<span style="color: #483d8b;">id</span> == graph.<span style="color: #483d8b;">id</span>).<span style="color: #483d8b;">filter</span>(Graph.checked == 1).first()
    <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> g:
        <span style="color: #a020f0;">return</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20889;&#20837;pipeline&#34920;
</span>    <span style="color: #a0522d;">p</span> = Pipeline()
    p.<span style="color: #a0522d;">name</span> = name
    p.<span style="color: #a0522d;">desc</span> = desc
    p.<span style="color: #a0522d;">g_id</span> = g.<span style="color: #483d8b;">id</span>
    p.<span style="color: #a0522d;">state</span> = STATE_RUNNING  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24320;&#21551;&#19968;&#20010;&#27969;&#31243;&#36816;&#34892;
</span>    db.session.add(p)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#35810;&#36825;&#20010;graph&#30340;&#25152;&#26377;&#39030;&#28857;&#20840;&#37096;
</span>    <span style="color: #a0522d;">vertexes</span> = db.session.query(Vertex.<span style="color: #483d8b;">id</span>).<span style="color: #483d8b;">filter</span>(Vertex.g_id == graph.<span style="color: #483d8b;">id</span>)
    <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> vertexes:
        <span style="color: #a020f0;">return</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#20986;&#25152;&#26377;&#36215;&#28857;&#65292;&#20837;&#24230;&#20026;0&#65292;&#23376;&#26597;&#35810;&#23454;&#29616;
</span>    <span style="color: #a0522d;">query</span> = vertexes.<span style="color: #483d8b;">filter</span>(Vertex.<span style="color: #483d8b;">id</span>.notin_(
        db.session.query(Edge.head).<span style="color: #483d8b;">filter</span>(Edge.g_id == graph.<span style="color: #483d8b;">id</span>)
    ))
    <span style="color: #a0522d;">zds</span> = {x[0] <span style="color: #a020f0;">for</span> x <span style="color: #a020f0;">in</span> query}  <span style="color: #b22222;"># </span><span style="color: #b22222;">query&#26159;&#22810;&#26465;&#35760;&#24405;&#23545;&#35937;&#65292;&#27599;&#19968;&#26465;&#35760;&#24405;&#26159;&#19968;&#20010;&#20803;&#32452;&#65292;&#20803;&#32452;&#30340;&#20803;&#32032;&#21462;&#20915;&#20110;&#26597;&#20102;&#21738;&#20123;&#23383;&#27573;
</span>    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"--&gt;"</span>, zds)

    <span style="color: #a020f0;">for</span> v <span style="color: #a020f0;">in</span> vertexes:
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20889;&#20837;track&#34920;
</span>        <span style="color: #a0522d;">t</span> = Track()
        t.<span style="color: #a0522d;">p_id</span> = p.<span style="color: #483d8b;">id</span>
        t.<span style="color: #a0522d;">v_id</span> = v.<span style="color: #483d8b;">id</span>
        t.<span style="color: #a0522d;">state</span> = STATE_WAITING <span style="color: #a020f0;">if</span> v.<span style="color: #483d8b;">id</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> zds <span style="color: #a020f0;">else</span> STATE_PENDING
        db.session.add(t)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"--&gt;"</span>, v, t.state, v.<span style="color: #483d8b;">id</span>)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26631;&#35760;&#26377;&#20154;&#20351;&#29992;&#36807;&#20102;&#65292;sealed&#23553;&#38381;
</span>    <span style="color: #a020f0;">if</span> g.sealed == 0:
        g.<span style="color: #a0522d;">sealed</span> = 1
        db.session.add(g)

    <span style="color: #a020f0;">return</span> p
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">test.py&#20013;
</span><span style="color: #a020f0;">from</span> pipeline.service <span style="color: #a020f0;">import</span> Graph
<span style="color: #a020f0;">from</span> pipeline.executor <span style="color: #a020f0;">import</span> start

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27979;&#35797;start
</span><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">test_start</span>():
    <span style="color: #a0522d;">g</span> = Graph()
    g.<span style="color: #483d8b;">id</span> = 1

    <span style="color: #a0522d;">p</span> = start(g, <span style="color: #8b2252;">'&#27969;&#31243;1'</span>)

test_start()
</pre>
</div>
</div>
</li>
<li><a id="h:0ad9c9c9-d9b5-4084-ad32-3769c1b78c7c"></a>input 验证<br>
<div class="outline-text-6" id="text-h:0ad9c9c9-d9b5-4084-ad32-3769c1b78c7c">
<p>
开启一个流程后，顶点可能设置了input，这时候就要有一个界面，让用户填写参数。这是一个交互过程，也可以实现为自动填写参数。
</p>

<p>
获取参数后需要验证，验证失败要抛出异常，验证成功就用来替换执行脚本，生成可以运行的脚本。
</p>

<p>
然后将参数、脚本存入数据库的 track 表。
</p>

<p>
在 track 表添加 script 字段，存储执行的脚本。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #483d8b;">input</span> = {
    <span style="color: #8b2252;">"ip"</span>:{
        <span style="color: #8b2252;">"type"</span>:<span style="color: #8b2252;">"str"</span>,
        <span style="color: #8b2252;">"required"</span>:<span style="color: #008b8b;">True</span>,
        <span style="color: #8b2252;">"default"</span>:<span style="color: #8b2252;">'127.0.0.1'</span>
    }
}
required &#26159;&#21542;&#24517;&#39035;&#65292;True&#21017;&#29992;&#25143;&#24517;&#39035;&#36755;&#20837;&#20540;&#65292;default&#32570;&#30465;&#20540;&#24573;&#30053;
default &#32570;&#30465;&#20540;&#65292;&#22914;&#26524;&#38750;&#24517;&#39035;&#20540;&#65292;&#29992;&#25143;&#27809;&#26377;&#22635;&#20889;&#20102;&#65292;&#20351;&#29992;&#32570;&#30465;&#20540;

<span style="color: #a0522d;">script</span> = {
    <span style="color: #8b2252;">'script'</span>:<span style="color: #8b2252;">'echo "test1.A"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">ping {ip}'</span>,
    <span style="color: #8b2252;">'next'</span>: [<span style="color: #8b2252;">'B'</span>]
}
{ip} &#21344;&#20301;&#31526;&#65292;&#29992;&#25143;&#25552;&#20379;&#21442;&#25968;&#21518;&#65292;&#20351;&#29992;&#21517;&#31216;ip&#36827;&#34892;&#26367;&#25442;
</pre>
</div>

<p>
特别注意，如果使用 ping 命令测试，windows 默认 ping 4 下，Linux 下会一直ping 下去，所以如果使用 Linux 测试项目脚本，一定要注意使用 <code>ping {ip} -c 4</code> ，此命令发送 4 个包就会停止命令。
</p>

<p>
以下是 Linux ping 命令使用，注意命令的返回值。0 为正确执行。-w 指定秒数必须完成 ping 命令，如果没有完成都算失败。
</p>

<div class="org-src-container">
<pre class="src src-python">[root@rocky ~]<span style="color: #b22222;"># </span><span style="color: #b22222;">ping www.baidu.com -w 8 -c 2; echo $?
</span>PING www.a.shifen.com (39.156.66.14) 56(84) <span style="color: #483d8b;">bytes</span> of data.
64 <span style="color: #483d8b;">bytes</span> <span style="color: #a020f0;">from</span> 39.156.66.14 (39.156.66.14): <span style="color: #a0522d;">icmp_seq</span>=1 <span style="color: #a0522d;">ttl</span>=128 <span style="color: #a0522d;">time</span>=43.7 ms
64 <span style="color: #483d8b;">bytes</span> <span style="color: #a020f0;">from</span> 39.156.66.14 (39.156.66.14): <span style="color: #a0522d;">icmp_seq</span>=2 <span style="color: #a0522d;">ttl</span>=128 <span style="color: #a0522d;">time</span>=44.5 ms

--- www.a.shifen.com ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 999ms
rtt <span style="color: #483d8b;">min</span>/avg/<span style="color: #483d8b;">max</span>/<span style="color: #a0522d;">mdev</span> = 43.656/44.096/44.536/0.440 ms
0
[root@rocky ~]<span style="color: #b22222;"># </span><span style="color: #b22222;">
</span>[root@rocky ~]<span style="color: #b22222;"># </span><span style="color: #b22222;">ping www.baidu.com -w 1 -c 2; echo $?
</span>PING www.a.shifen.com (39.156.66.18) 56(84) <span style="color: #483d8b;">bytes</span> of data.
64 <span style="color: #483d8b;">bytes</span> <span style="color: #a020f0;">from</span> 39.156.66.18 (39.156.66.18): <span style="color: #a0522d;">icmp_seq</span>=1 <span style="color: #a0522d;">ttl</span>=128 <span style="color: #a0522d;">time</span>=44.8 ms

--- www.a.shifen.com ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt <span style="color: #483d8b;">min</span>/avg/<span style="color: #483d8b;">max</span>/<span style="color: #a0522d;">mdev</span> = 44.785/44.785/44.785/0.000 ms
1
</pre>
</div>

<p>
返回指定流程的信息，比如说在浏览器中，获取当前流程的信息：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">executor.py&#20013;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#35810;&#27969;&#31243;&#30340;&#26576;&#31181;&#29366;&#24577;&#33410;&#28857;
</span><span style="color: #228b22;">@transactional</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">show_pipeline</span>(<span style="color: #483d8b;">id</span>, state=STATE_PENDING):
    <span style="color: #8b2252;">"""&#26174;&#31034;&#25351;&#23450;&#30340;&#27969;&#31243;&#30340;&#20449;&#24687;"""</span>
    <span style="color: #a0522d;">p</span> = db.session.query(
        Pipeline.<span style="color: #483d8b;">id</span>, Pipeline.name, Pipeline.state,
        Track.<span style="color: #483d8b;">id</span>, Track.v_id, Track.state, Vertex.<span style="color: #483d8b;">input</span>, Vertex.script). \
        join(Track, (Track.p_id == <span style="color: #483d8b;">id</span>) &amp; (Pipeline.<span style="color: #483d8b;">id</span> == Track.p_id)). \
        join(Vertex, Track.v_id == Vertex.<span style="color: #483d8b;">id</span>). \
        <span style="color: #483d8b;">filter</span>(Pipeline.state != STATE_FAILED). \
        <span style="color: #483d8b;">filter</span>(Track.state == state)
    <span style="color: #a020f0;">return</span> p.<span style="color: #483d8b;">all</span>()
</pre>
</div>

<p>
下面要模拟在浏览器中，看到了当前浏览器显示的信息，如果需要提供参数，就显示交互界面，让用户输入。
</p>

<p>
然后，数据提交，验证后，替换 script 脚本中的占位符，生成可以执行的脚本。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">test.py&#20013;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#37096;&#20998;&#20195;&#30721;&#27169;&#25311;&#29992;&#25143;&#25552;&#20379;&#21442;&#25968;&#65292;&#24418;&#25104;&#19968;&#20010;&#23383;&#20856;
</span><span style="color: #a020f0;">from</span> pipeline.executor <span style="color: #a020f0;">import</span> show_pipeline
<span style="color: #a020f0;">import</span> simplejson

<span style="color: #a0522d;">ps</span> = show_pipeline(1)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#36816;&#34892;&#33410;&#28857;&#21015;&#34920;
</span><span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
<span style="color: #483d8b;">print</span>(ps)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)

<span style="color: #a020f0;">for</span> p_id, p_name, p_state, t_id, v_id, t_state, inp, script <span style="color: #a020f0;">in</span> ps:
    <span style="color: #483d8b;">print</span>(p_id, p_name, p_state, t_id, v_id, t_state, inp, script)

    <span style="color: #a0522d;">d</span> = {}  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#21442;&#25968;&#26159;&#24517;&#39035;&#65292;&#21017;&#20132;&#20114;&#65292;&#35753;&#29992;&#25143;&#25552;&#20132;
</span>    <span style="color: #a020f0;">if</span> inp:
        <span style="color: #a0522d;">inp</span> = simplejson.loads(inp)
        <span style="color: #a020f0;">for</span> k <span style="color: #a020f0;">in</span> inp.keys():
            <span style="color: #a020f0;">if</span> inp[k].get(<span style="color: #8b2252;">'required1'</span>, <span style="color: #008b8b;">False</span>):
                <span style="color: #a0522d;">d</span>[k] = <span style="color: #483d8b;">input</span>(f<span style="color: #8b2252;">'</span>{k}<span style="color: #8b2252;">='</span>)
        <span style="color: #483d8b;">print</span>(d)
</pre>
</div>

<p>
然后填充脚本 script：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">service.py&#20013;
</span><span style="color: #a020f0;">import</span> simplejson

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31867;&#22411;&#36716;&#25442;&#29992;
</span><span style="color: #a0522d;">TYPES</span> = {
    <span style="color: #8b2252;">'str'</span>: <span style="color: #483d8b;">str</span>,
    <span style="color: #8b2252;">'string'</span>: <span style="color: #483d8b;">str</span>,
    <span style="color: #8b2252;">'int'</span>: <span style="color: #483d8b;">int</span>,
    <span style="color: #8b2252;">'integer'</span>: <span style="color: #483d8b;">int</span>
}

<span style="color: #228b22;">@transactional</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">finish_params</span>(t_id, d: <span style="color: #483d8b;">dict</span>, inp):
    <span style="color: #8b2252;">"""&#23436;&#25104;&#25152;&#26377;&#21442;&#25968;&#20540;"""</span>
    <span style="color: #a0522d;">params</span> = {}  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26368;&#32456;&#30340;&#21442;&#25968;
</span>    <span style="color: #a020f0;">if</span> inp:
        <span style="color: #483d8b;">print</span>(inp)
        <span style="color: #483d8b;">print</span>(d)
        <span style="color: #a020f0;">for</span> k, v <span style="color: #a020f0;">in</span> inp.items():
            <span style="color: #483d8b;">print</span>(k, v)
            <span style="color: #a0522d;">val</span> = d.get(k)
            <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">isinstance</span>(val, TYPES.get(v[<span style="color: #8b2252;">'type'</span>], <span style="color: #483d8b;">str</span>)):
                <span style="color: #a0522d;">params</span>[k] = val
            <span style="color: #a020f0;">elif</span> v.get(<span style="color: #8b2252;">'default'</span>):  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31867;&#22411;&#19981;&#23545;&#65292;&#20294;&#26159;&#26377;&#32570;&#30465;&#20540;
</span>                <span style="color: #a0522d;">params</span>[k] = v.get(<span style="color: #8b2252;">'default'</span>)
            <span style="color: #a020f0;">else</span>:
                <span style="color: #a020f0;">raise</span> <span style="color: #228b22;">TypeError</span>(<span style="color: #8b2252;">'&#21442;&#25968;&#31867;&#22411;&#38169;&#35823;'</span>)

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;input&#23384;&#20837;&#25968;&#25454;&#24211;
</span>        <span style="color: #a0522d;">track</span> = db.session.query(Track).<span style="color: #483d8b;">filter</span>(Track.<span style="color: #483d8b;">id</span> == t_id).first()
        <span style="color: #a020f0;">if</span> track:
            track.<span style="color: #483d8b;">input</span> = simplejson.dumps(params)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36716;&#25104;&#23383;&#31526;&#20018;
</span>            db.session.add(track)
    <span style="color: #a020f0;">return</span> params

<span style="color: #228b22;">@transactional</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">finish_script</span>(t_id, script: <span style="color: #483d8b;">str</span>, params: <span style="color: #483d8b;">dict</span>):
    <span style="color: #8b2252;">'''&#20351;&#29992;&#21442;&#25968;&#26367;&#25442;&#33050;&#26412;'''</span>
    <span style="color: #a0522d;">newline</span> = <span style="color: #8b2252;">''</span>
    <span style="color: #a020f0;">if</span> script:
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">isinstance</span>(script, <span style="color: #483d8b;">str</span>):
            <span style="color: #a0522d;">script</span> = simplejson.loads(script).get(<span style="color: #8b2252;">'script'</span>)
        <span style="color: #a020f0;">import</span> re
        <span style="color: #a0522d;">regex</span> = re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">'{([^{}]+)}'</span>)

        <span style="color: #a0522d;">start</span> = 0

        <span style="color: #a020f0;">for</span> matcher <span style="color: #a020f0;">in</span> regex.finditer(script):
            <span style="color: #a0522d;">newline</span> += script[start:matcher.start()]
            <span style="color: #483d8b;">print</span>(matcher, matcher.group(1))
            <span style="color: #a0522d;">key</span> = matcher.group(1)
            <span style="color: #a0522d;">tmp</span> = params.get(key, <span style="color: #8b2252;">''</span>)
            <span style="color: #a0522d;">newline</span> += <span style="color: #483d8b;">str</span>(tmp)
            <span style="color: #a0522d;">start</span> = matcher.end()
        <span style="color: #a020f0;">else</span>:
            <span style="color: #a0522d;">newline</span> += script[start:]

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25226;&#29983;&#25104;&#30340;script&#23384;&#20837;&#24211;
</span>        <span style="color: #a0522d;">track</span> = db.session.query(Track).<span style="color: #483d8b;">filter</span>(Track.<span style="color: #483d8b;">id</span> == t_id).first()
        <span style="color: #a020f0;">if</span> track:
            track.<span style="color: #a0522d;">script</span> = newline  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36716;&#25104;&#23383;&#31526;&#20018;
</span>            db.session.add(track)

    <span style="color: #a020f0;">return</span> newline
</pre>
</div>

<p>
测试代码：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">test.py&#20013;
</span><span style="color: #a020f0;">from</span> pipeline.executor <span style="color: #a020f0;">import</span> show_pipeline
<span style="color: #a020f0;">from</span> pipeline.executor <span style="color: #a020f0;">import</span> finish_params, finish_script
<span style="color: #a020f0;">import</span> simplejson
<span style="color: #a0522d;">ps</span> = show_pipeline(1)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#36816;&#34892;&#33410;&#28857;&#21015;&#34920;
</span><span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
<span style="color: #483d8b;">print</span>(ps)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)

<span style="color: #a020f0;">for</span> p_id, p_name, p_state, t_id, v_id, t_state, inp, script <span style="color: #a020f0;">in</span> ps:
    <span style="color: #483d8b;">print</span>(p_id, p_name, p_state, t_id, v_id, t_state, inp, script)

    <span style="color: #a0522d;">d</span> = {}  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#21442;&#25968;&#26159;&#24517;&#39035;&#65292;&#21017;&#20132;&#20114;&#65292;&#35753;&#29992;&#25143;&#25552;&#20132;
</span>    <span style="color: #a020f0;">if</span> inp:
        <span style="color: #a0522d;">inp</span> = simplejson.loads(inp)
        <span style="color: #a020f0;">for</span> k <span style="color: #a020f0;">in</span> inp.keys():
            <span style="color: #a020f0;">if</span> inp[k].get(<span style="color: #8b2252;">'required'</span>, <span style="color: #008b8b;">False</span>):
                <span style="color: #a0522d;">d</span>[k] = <span style="color: #483d8b;">input</span>(<span style="color: #8b2252;">'{}= '</span>.<span style="color: #483d8b;">format</span>(k))
        <span style="color: #483d8b;">print</span>(d)

    <span style="color: #a0522d;">params</span> = finish_params(t_id, d, inp)
    <span style="color: #483d8b;">print</span>(params)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20934;&#22791;&#22909;&#21442;&#25968;
</span>    <span style="color: #483d8b;">print</span>(script, <span style="color: #8b2252;">'+++++++++'</span>)
    <span style="color: #a0522d;">script</span> = finish_script(t_id, script, params)
    <span style="color: #483d8b;">print</span>(script)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25343;&#21040;&#26367;&#25442;&#22909;&#30340;&#33050;&#26412;&#65292;&#20934;&#22791;&#25191;&#34892;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#25968;&#25454;&#24211;Track&#34920;&#22914;&#19979;
</span>mysql&gt; select * from track;
+----+------+------+-------+-----------------------+--------+---------------------------------+
| id | p_id | v_id | state | input                 | output | script                          |
+----+------+------+-------+-----------------------+--------+---------------------------------+
|  1 |    1 |    1 |     1 | {<span style="color: #8b2252;">"ip"</span>: <span style="color: #8b2252;">"172.16.10.8"</span>} | NULL   | <span style="color: #483d8b;">echo</span> <span style="color: #8b2252;">'test1.A'</span>
ping 172.16.10.8 |
|  2 |    1 |    2 |     0 | NULL                  | NULL   | NULL                            |
|  3 |    1 |    3 |     0 | NULL                  | NULL   | NULL                            |
|  4 |    1 |    4 |     0 | NULL                  | NULL   | NULL                            |
+----+------+------+-------+-----------------------+--------+---------------------------------+
4 rows<span style="color: #a020f0;"> in</span> set (0.00 sec)
</pre>
</div>
</div>
</li>
<li><a id="h:fcb2135f-36ac-4a5d-a5bc-71b952b9f588"></a>执行<br>
<div class="outline-text-6" id="text-h:fcb2135f-36ac-4a5d-a5bc-71b952b9f588">
<p>
执行脚本，脚本执行的是命令，而命令就是写好的程序，这些程序执行就是一个个进程。
</p>

<p>
python 有很多运行进程的方式，不过都过时了。建议使用标准库 subprocess模块，启动一个子进程。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Popen</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, args, bufsize=-1, executable=<span style="color: #008b8b;">None</span>,
                 stdin=<span style="color: #008b8b;">None</span>, stdout=<span style="color: #008b8b;">None</span>, stderr=<span style="color: #008b8b;">None</span>,
                 preexec_fn=<span style="color: #008b8b;">None</span>, close_fds=<span style="color: #008b8b;">True</span>,
                 shell=<span style="color: #008b8b;">False</span>, cwd=<span style="color: #008b8b;">None</span>, env=<span style="color: #008b8b;">None</span>, universal_newlines=<span style="color: #008b8b;">None</span>,
                 startupinfo=<span style="color: #008b8b;">None</span>, creationflags=0,
                 restore_signals=<span style="color: #008b8b;">True</span>, start_new_session=<span style="color: #008b8b;">False</span>,
                 pass_fds=(), *, user=<span style="color: #008b8b;">None</span>, group=<span style="color: #008b8b;">None</span>, extra_groups=<span style="color: #008b8b;">None</span>,
                 encoding=<span style="color: #008b8b;">None</span>, errors=<span style="color: #008b8b;">None</span>, text=<span style="color: #008b8b;">None</span>, umask=-1, pipesize=-1):
</pre>
</div>

<p>
shell 为 True，则使用 shell 来执行 args，建议 args 是一个字符串。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> subprocess <span style="color: #a020f0;">import</span> Popen, PIPE

<span style="color: #a0522d;">p</span> = Popen(<span style="color: #8b2252;">'echo hello'</span>, shell=<span style="color: #008b8b;">True</span>, stdout=PIPE)
<span style="color: #a0522d;">code</span> = p.wait()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;&#31561;&#65292;code&#20026;0&#26159;&#27491;&#30830;&#25191;&#34892;
</span><span style="color: #a0522d;">text</span> = p.stdout.read()  <span style="color: #b22222;"># </span><span style="color: #b22222;">bytes
</span><span style="color: #483d8b;">print</span>(code, text)
</pre>
</div>

<p>
脚本执行的输出可能非常大，使用 PIPE 不太合适，使用临时文件模块：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> subprocess <span style="color: #a020f0;">import</span> Popen, PIPE
<span style="color: #a020f0;">from</span> tempfile <span style="color: #a020f0;">import</span> TemporaryFile

<span style="color: #a020f0;">with</span> TemporaryFile(<span style="color: #8b2252;">'w+'</span>) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">p</span> = Popen(<span style="color: #8b2252;">'echo hello brinnatt'</span>, shell=<span style="color: #008b8b;">True</span>, stdout=f)
    <span style="color: #a0522d;">code</span> = p.wait()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;&#31561;&#65292;code&#20026;0&#26159;&#27491;&#30830;&#25191;&#34892;
</span>    f.seek(0)
    <span style="color: #a0522d;">text</span> = f.read()
    <span style="color: #483d8b;">print</span>(code, text)
</pre>
</div>

<p>
由于 wait 会阻塞，所以使用多线程，使用 subprocess 的 Popen开启子进程执行。但是开启线程后返回的结果就不能直接拿到了。使用concurrent.futures 来异步并发执行，并获取返回的结果。
</p>

<p>
先学习一个例子：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> concurrent.futures <span style="color: #a020f0;">import</span> ThreadPoolExecutor, as_completed
<span style="color: #a020f0;">import</span> random
<span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">test_func</span>(sec, key):
    <span style="color: #483d8b;">print</span>(f<span style="color: #8b2252;">'Enter --&gt; </span>{threading.current_thread()}<span style="color: #8b2252;"> </span>{sec}<span style="color: #8b2252;">s key=</span>{key}<span style="color: #8b2252;">'</span>)
    threading.Event().wait(sec)
    <span style="color: #a020f0;">if</span> key == 3:
        <span style="color: #a020f0;">raise</span> <span style="color: #228b22;">Exception</span>(f<span style="color: #8b2252;">'</span>{key}<span style="color: #8b2252;"> failed !!!!!!!!!!!'</span>)
    <span style="color: #a020f0;">return</span> f<span style="color: #8b2252;">'ok </span>{threading.current_thread()}<span style="color: #8b2252;">'</span>

<span style="color: #a0522d;">futures</span> = {}

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">run</span>(fs):
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
    time.sleep(1)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
    <span style="color: #483d8b;">print</span>(fs)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21482;&#35201;&#26377;&#19968;&#20010;&#20219;&#21153;&#27809;&#26377;&#23436;&#25104;&#23601;&#38459;&#22622;&#65292;&#23436;&#25104;&#19968;&#20010;&#65292;&#25191;&#34892;&#19968;&#27425;
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#20869;&#37096;&#26377;&#24322;&#24120;result()&#20250;&#23558;&#36825;&#20010;&#24322;&#24120;&#25243;&#20986;
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26377;&#24322;&#24120;&#20063;&#31639;&#25191;&#34892;&#23436;&#20102;complete
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">fs&#20026;&#31354;&#20063;&#19981;&#38459;&#22622;
</span>    <span style="color: #a020f0;">for</span> future <span style="color: #a020f0;">in</span> as_completed(fs):
        <span style="color: #483d8b;">id</span> = fs[future]
        <span style="color: #a020f0;">try</span>:
            <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"Result"</span>, <span style="color: #8b2252;">'--&gt;'</span>, <span style="color: #483d8b;">id</span>, future.result())
        <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
            <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'Error'</span>, <span style="color: #8b2252;">'--&gt;'</span>, e)
            <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'Who'</span>, <span style="color: #8b2252;">'--&gt;'</span>, <span style="color: #483d8b;">id</span>, <span style="color: #8b2252;">'failed'</span>)

threading.Thread(target=run, args=(futures,)).start()

<span style="color: #a020f0;">with</span> ThreadPoolExecutor(max_workers=3) <span style="color: #a020f0;">as</span> executor:
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(7):
        <span style="color: #a0522d;">futures</span>[executor.submit(test_func, random.randint(1, 8), i)] = i

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36816;&#34892;&#32467;&#26524;
</span>------------------------------
Enter --&gt; &lt;Thread(ThreadPoolExecutor-0_0, started 14060)&gt; 5s <span style="color: #a0522d;">key</span>=0
Enter --&gt; &lt;Thread(ThreadPoolExecutor-0_1, started 5524)&gt; 1s <span style="color: #a0522d;">key</span>=1
Enter --&gt; &lt;Thread(ThreadPoolExecutor-0_2, started 16016)&gt; 4s <span style="color: #a0522d;">key</span>=2
------------------------------
{&lt;Future at 0x1acb30257e0 state=running&gt;: 0, &lt;Future at 0x1acb3025ba0 state=running&gt;: 1, &lt;Future at 0x1acb3025ed0 state=running&gt;: 2, &lt;Future at 0x1acb30261a0 state=pending&gt;: 3, &lt;Future at 0x1acb3026260 state=pending&gt;: 4, &lt;Future at 0x1acb3026320 state=pending&gt;: 5, &lt;Future at 0x1acb30263e0 state=pending&gt;: 6}
Enter --&gt; &lt;Thread(ThreadPoolExecutor-0_1, started 5524)&gt; 4s <span style="color: #a0522d;">key</span>=3
Result --&gt; 1 ok &lt;Thread(ThreadPoolExecutor-0_1, started 5524)&gt;
Enter --&gt; &lt;Thread(ThreadPoolExecutor-0_2, started 16016)&gt; 1s <span style="color: #a0522d;">key</span>=4
Result --&gt; 2 ok &lt;Thread(ThreadPoolExecutor-0_2, started 16016)&gt;
Enter --&gt; &lt;Thread(ThreadPoolExecutor-0_0, started 14060)&gt; 5s <span style="color: #a0522d;">key</span>=5
ResultEnter --&gt; &lt;Thread(ThreadPoolExecutor-0_1, started 5524)&gt; 8s <span style="color: #a0522d;">key</span>=6
 --&gt; 0 ok &lt;Thread(ThreadPoolExecutor-0_0, started 14060)&gt;
Error --&gt; 3 failed !!!!!!!!!!!
Who --&gt; 3 failed
Result --&gt; 4 ok &lt;Thread(ThreadPoolExecutor-0_2, started 16016)&gt;
Result --&gt; 5 ok &lt;Thread(ThreadPoolExecutor-0_0, started 14060)&gt;
Result --&gt; 6 ok &lt;Thread(ThreadPoolExecutor-0_1, started 5524)&gt;
</pre>
</div>

<p>
可以看出 as_completed 会盯着所有的future，完成一个，执行一个，直到所有的 future 完成。
</p>

<p>
执行器类实现：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#35843;&#29992;&#25191;&#34892;&#22120;&#30340;execute&#26041;&#27861;&#65292;&#27492;&#26041;&#27861;&#20250;&#33258;&#21160;&#23558;&#20219;&#21153;&#25552;&#20132;&#65292;&#24182;&#24322;&#27493;&#25191;&#34892;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">executor.py&#20013;
</span><span style="color: #a020f0;">from</span> subprocess <span style="color: #a020f0;">import</span> Popen, PIPE
<span style="color: #a020f0;">from</span> tempfile <span style="color: #a020f0;">import</span> TemporaryFile
<span style="color: #a020f0;">from</span> concurrent.futures <span style="color: #a020f0;">import</span> ThreadPoolExecutor, as_completed
<span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> uuid
<span style="color: #a020f0;">from</span> queue <span style="color: #a020f0;">import</span> Queue

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Executor</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, workers=5):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__pool</span> = ThreadPoolExecutor(max_workers=workers)
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__event</span> = threading.Event()
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__tasks</span> = {}
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__queue</span> = Queue()
        threading.Thread(target=<span style="color: #a020f0;">self</span>._run).start()
        threading.Thread(target=<span style="color: #a020f0;">self</span>._save_track).start()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_execute</span>(<span style="color: #a020f0;">self</span>, script: <span style="color: #483d8b;">str</span>):
        <span style="color: #a020f0;">with</span> TemporaryFile(<span style="color: #8b2252;">'w+'</span>) <span style="color: #a020f0;">as</span> f:
            <span style="color: #a0522d;">output</span> = []
            <span style="color: #a0522d;">code</span> = 0
            <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> script.splitlines():
                <span style="color: #a0522d;">p</span> = Popen(line, shell=<span style="color: #008b8b;">True</span>, stdout=f)
                <span style="color: #a0522d;">code</span> = p.wait()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;&#31561;&#65292;code&#20026;0&#26159;&#27491;&#30830;&#25191;&#34892;
</span>                f.seek(0)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22238;&#21040;&#24320;&#22836;
</span>                <span style="color: #a0522d;">text</span> = f.read()
                output.append(text)
                <span style="color: #a0522d;">code</span> += code
            <span style="color: #a020f0;">return</span> code, <span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>.join(output)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">execute</span>(<span style="color: #a020f0;">self</span>, p_id, t_id, script: <span style="color: #483d8b;">str</span>):
        <span style="color: #8b2252;">"""&#24322;&#27493;&#25191;&#34892;&#26041;&#27861;&#65292;&#25552;&#20132;&#25968;&#25454;&#23601;&#34892;&#20102;&#65292;&#36816;&#34892;&#21518;&#65292;&#20250;&#25552;&#20379;&#36816;&#34892;&#32467;&#26524;&#65292;&#25110;&#36820;&#22238;&#22833;&#36133;"""</span>
        <span style="color: #a0522d;">key</span> = uuid.uuid4().<span style="color: #483d8b;">hex</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">uuid&#27809;&#26377;&#29992;&#19978;&#65292;&#21482;&#26159;&#35828;&#20197;&#21518;&#19981;&#37325;&#22797;key&#25110;id&#21487;&#20197;&#29992;uuid
</span>        <span style="color: #a020f0;">try</span>:
            <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__tasks</span>[<span style="color: #a020f0;">self</span>.__pool.submit(<span style="color: #a020f0;">self</span>._execute, script)] = (key, p_id, t_id)  <span style="color: #b22222;"># </span><span style="color: #b22222;">future &#23545;&#35937;
</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;&#29366;&#24577;&#20026;&#20934;&#22791;&#25191;&#34892;RUNNING
</span>            <span style="color: #a0522d;">track</span> = db.session.query(Track).<span style="color: #483d8b;">filter</span>(Track.<span style="color: #483d8b;">id</span> == t_id).one()
            track.<span style="color: #a0522d;">state</span> = STATE_RUNNING
            db.session.add(track)
            db.session.commit()
        <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
            db.session.rollback()
            <span style="color: #483d8b;">print</span>(e)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_run</span>(<span style="color: #a020f0;">self</span>):  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32447;&#31243;&#31561;&#24453;&#20219;&#21153;
</span>        <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">self</span>.__event.wait(1):
            <span style="color: #a020f0;">for</span> future <span style="color: #a020f0;">in</span> as_completed(<span style="color: #a020f0;">self</span>.__tasks):
                <span style="color: #a0522d;">key</span>, <span style="color: #a0522d;">p_id</span>, <span style="color: #a0522d;">t_id</span> = <span style="color: #a020f0;">self</span>.__tasks[future]
                <span style="color: #a020f0;">try</span>:
                    <span style="color: #a0522d;">code</span>, <span style="color: #a0522d;">text</span> = future.result()
                    <span style="color: #a020f0;">del</span> <span style="color: #a020f0;">self</span>.__tasks[future]
                    <span style="color: #a020f0;">self</span>.__queue.put(p_id, t_id, code, text)
                <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
                    <span style="color: #483d8b;">print</span>(key, e)
                    <span style="color: #a020f0;">del</span> <span style="color: #a020f0;">self</span>.__tasks[future]  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22833;&#36133;&#20219;&#21153;&#20197;&#21518;&#22788;&#29702; TODO
</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_save_track</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">self</span>.__event.is_set():
            <span style="color: #a0522d;">p_id</span>, <span style="color: #a0522d;">t_id</span>, <span style="color: #a0522d;">code</span>, <span style="color: #a0522d;">text</span> = <span style="color: #a020f0;">self</span>.__queue.get()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;&#21462;
</span>
            <span style="color: #a0522d;">track</span> = db.session.query(Track).<span style="color: #483d8b;">filter</span>(Track.v_id == t_id).first()
            track.<span style="color: #a0522d;">state</span> = STATE_SUCCEED <span style="color: #a020f0;">if</span> code == 0 <span style="color: #a020f0;">else</span> STATE_FAILED  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;&#29366;&#24577;
</span>            track.<span style="color: #a0522d;">output</span> = text

            <span style="color: #a020f0;">if</span> code != 0:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22833;&#36133;&#65292;&#24517;&#39035;&#31435;&#21363;&#23558;&#20219;&#21153;&#27969;&#29366;&#24577;&#35774;&#32622;&#20026;&#22833;&#36133;
</span>                track.pipeline.<span style="color: #a0522d;">state</span> = STATE_FAILED
            db.session.add(track)

            <span style="color: #a020f0;">try</span>:
                db.session.commit()
            <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
                <span style="color: #483d8b;">print</span>(e)
                db.session.rollback()

<span style="color: #a0522d;">EXECUTOR</span> = Executor()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20840;&#23616;&#20219;&#21153;&#25191;&#34892;&#22120;&#23545;&#35937;</span>
</pre>
</div>

<p>
注意，有可能出现下面的错误：
</p>

<p>
<code>'latin-1' codec can't encode characters in position 55-56: ordinal not in range(256)</code>
</p>

<p>
运行的没有问题，字符串也没有错误，甚至数据库客户端执行都没有问题，但是自己写的程序显示latin-1 长度超了。原因在于数据库连接没有设定字符集。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">config.py&#20013;&#23545;&#25968;&#25454;&#24211;&#36830;&#25509;&#25351;&#23450;&#23383;&#31526;&#38598;
</span><span style="color: #a0522d;">USERNAME</span> = <span style="color: #8b2252;">'brinnatt'</span>
<span style="color: #a0522d;">PASSWD</span> = <span style="color: #8b2252;">'WelC0me168!'</span>
<span style="color: #a0522d;">DBIP</span> = <span style="color: #8b2252;">'192.168.136.131'</span>
<span style="color: #a0522d;">DBPORT</span> = 3306
<span style="color: #a0522d;">DBNAME</span> = <span style="color: #8b2252;">'pipeline'</span>
<span style="color: #a0522d;">PARAMS</span> = <span style="color: #8b2252;">"charset=utf8mb4"</span>

<span style="color: #a0522d;">URL</span> = f<span style="color: #8b2252;">'mysql+pymysql://</span>{USERNAME}<span style="color: #8b2252;">:</span>{PASSWD}<span style="color: #8b2252;">@</span>{DBIP}<span style="color: #8b2252;">:</span>{DBPORT}<span style="color: #8b2252;">/</span>{DBNAME}<span style="color: #8b2252;">?</span>{PARAMS}<span style="color: #8b2252;">'</span>
<span style="color: #a0522d;">DATABASE_DEBUG</span> = <span style="color: #008b8b;">True</span>
</pre>
</div>

<p>
测试代码：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> pipeline.executor <span style="color: #a020f0;">import</span> show_pipeline, EXECUTOR
<span style="color: #a020f0;">from</span> pipeline.service <span style="color: #a020f0;">import</span> finish_script, finish_params
<span style="color: #a020f0;">import</span> simplejson

<span style="color: #a0522d;">ps</span> = show_pipeline(1)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#36816;&#34892;&#33410;&#28857;&#21015;&#34920;
</span><span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
<span style="color: #483d8b;">print</span>(ps)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)

<span style="color: #a020f0;">for</span> p_id, p_name, p_state, t_id, v_id, t_state, inp, script <span style="color: #a020f0;">in</span> ps:
    <span style="color: #483d8b;">print</span>(p_id, p_name, p_state, t_id, v_id, t_state, inp, script)

    <span style="color: #a0522d;">d</span> = {}  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#21442;&#25968;&#26159;&#24517;&#39035;&#65292;&#21017;&#20132;&#20114;&#65292;&#35753;&#29992;&#25143;&#25552;&#20132;
</span>    <span style="color: #a020f0;">if</span> inp:
        <span style="color: #a0522d;">inp</span> = simplejson.loads(inp)
        <span style="color: #a020f0;">for</span> k <span style="color: #a020f0;">in</span> inp.keys():
            <span style="color: #a020f0;">if</span> inp[k].get(<span style="color: #8b2252;">'required'</span>, <span style="color: #008b8b;">False</span>):
                <span style="color: #a0522d;">d</span>[k] = <span style="color: #483d8b;">input</span>(<span style="color: #8b2252;">'{}= '</span>.<span style="color: #483d8b;">format</span>(k))
        <span style="color: #483d8b;">print</span>(d)

    <span style="color: #a0522d;">params</span> = finish_params(t_id, d, inp)
    <span style="color: #483d8b;">print</span>(params)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20934;&#22791;&#22909;&#21442;&#25968;
</span>    <span style="color: #483d8b;">print</span>(script, <span style="color: #8b2252;">'+++++++++'</span>)
    <span style="color: #a0522d;">script</span> = finish_script(t_id, script, params)
    <span style="color: #483d8b;">print</span>(script)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25343;&#21040;&#26367;&#25442;&#22909;&#30340;&#33050;&#26412;&#65292;&#20934;&#22791;&#25191;&#34892;
</span>
    EXECUTOR.execute(p_id, t_id, script)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24322;&#27493;&#25191;&#34892;</span>
</pre>
</div>

<p>
测试通过。
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:2aa4b994-b0c3-4476-95a0-0e7dc5b6fe5e" class="outline-5">
<h5 id="h:2aa4b994-b0c3-4476-95a0-0e7dc5b6fe5e">流转</h5>
<div class="outline-text-5" id="text-h:2aa4b994-b0c3-4476-95a0-0e7dc5b6fe5e">
<p>
手动流转以后实现。这里实现自动流转。
</p>

<p>
如何知道轮到哪个节点执行了？保持一定频率反复到 track表查询什么节点可以执行了吗？
</p>

<p>
为了减少对数据库的查询，最好的方式应该是由前一个节点成功完成后触发一次查询。
</p>

<p>
查询完成的节点的下一个节点是否存在、是否具备执行的条件等：
</p>

<ul class="org-ul">
<li>首先，需要在 pipeline
中查看当前任务状态是否已经失败，如果失败，则不再继续找下一个节点。否则成功执行，继续下面操作。</li>

<li>本节点成功执行，置为成功，在 track 表查询一下本任务流除自己之外还有没有其它节点在运行中，遍历所有其它节点。

<ul class="org-ul">
<li>首先判断如果有一个失败，就立即置 pipeline 的 state 为 STATE_FAILED。</li>

<li>如果其它节点都是成功，则置 pipeline 的 state 为 STATE_FINISH。</li>

<li>如果碰到一个 STATE_WAITING、STATE_RUNNING，就搜索下一级节点。</li>
</ul></li>

<li>下一个节点

<ul class="org-ul">
<li>没有下一级节点，说明该节点是终点。是终点，不代表没有其它终点。本节点没有下一级它就不用管其它节点了，只需要把自己的状态置为成功就行了。</li>

<li>如果节点没有执行失败，一定会成功执行，其它节点继续执行，如果最后一个终点执行完，会发现其他节点全是成功状态，所以它将
pipeline 的 state 置为 STATE_FINISH 就可以了。</li>
</ul></li>
</ul>

<p>
测试数据准备：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#30001;&#20110;&#23558;script&#26684;&#24335;&#26356;&#25913;&#20102;&#65292;&#25152;&#20197;&#37325;&#26032;&#25552;&#20379;&#35813;&#20989;&#25968;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#27979;&#35797;&#25968;&#25454;
</span><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">test_create_dag</span>():
    <span style="color: #a020f0;">try</span>:
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22270;1 &#21019;&#24314;DAG
</span>        <span style="color: #a0522d;">g</span> = create_graph(<span style="color: #8b2252;">'test1'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25104;&#21151;&#21017;&#36820;&#22238;&#19968;&#20010;Graph&#23545;&#35937;
</span>        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#39030;&#28857;
</span>        <span style="color: #483d8b;">input</span> = {
            <span style="color: #8b2252;">"ip"</span>: {
                <span style="color: #8b2252;">"type"</span>: <span style="color: #8b2252;">"str"</span>,
                <span style="color: #8b2252;">"required"</span>: <span style="color: #008b8b;">True</span>,
                <span style="color: #8b2252;">"default"</span>: <span style="color: #8b2252;">"127.0.0.1"</span>
            }
        }
        <span style="color: #a0522d;">script</span> = {
            <span style="color: #8b2252;">'script'</span>: <span style="color: #8b2252;">'echo "test1.A"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">ping {ip}'</span>,
            <span style="color: #8b2252;">'next'</span>: <span style="color: #8b2252;">'B'</span>
        }
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#37324;&#20026;&#20102;&#35753;&#29992;&#25143;&#26041;&#20415;&#65292;next&#21487;&#20197;&#25509;&#25910;2&#31181;&#31867;&#22411;&#65292;&#25968;&#23383;&#34920;&#31034;&#39030;&#28857;&#30340;id&#65292;&#23383;&#31526;&#20018;&#34920;&#31034;&#21516;&#19968;&#20010;DAG&#20013;&#35813;&#21517;&#31216;&#30340;&#33410;&#28857;&#65292;&#19981;&#33021;&#37325;&#22797;
</span>        <span style="color: #a0522d;">a</span> = add_vertex(g, <span style="color: #8b2252;">'A'</span>, json.dumps(<span style="color: #483d8b;">input</span>), json.dumps(script))  <span style="color: #b22222;"># </span><span style="color: #b22222;">next&#39030;&#28857;&#39564;&#35777;&#21487;&#20197;&#22312;&#23450;&#20041;&#26102;&#65292;&#20063;&#21487;&#20197;&#22312;&#20351;&#29992;&#26102;
</span>        <span style="color: #a0522d;">b</span> = add_vertex(g, <span style="color: #8b2252;">'B'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo B"}'</span>)
        <span style="color: #a0522d;">c</span> = add_vertex(g, <span style="color: #8b2252;">'C'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo C"}'</span>)
        <span style="color: #a0522d;">d</span> = add_vertex(g, <span style="color: #8b2252;">'D'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo D"}'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#36793;
</span>        <span style="color: #a0522d;">ab</span> = add_edge(g, a, b)
        <span style="color: #a0522d;">ac</span> = add_edge(g, a, c)
        <span style="color: #a0522d;">cb</span> = add_edge(g, c, b)
        <span style="color: #a0522d;">bd</span> = add_edge(g, b, d)

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22270;2 &#21019;&#24314;&#29615;&#36335;
</span>        <span style="color: #a0522d;">g</span> = create_graph(<span style="color: #8b2252;">'test2'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29615;&#36335;
</span>        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#39030;&#28857;
</span>        <span style="color: #a0522d;">a</span> = add_vertex(g, <span style="color: #8b2252;">'A'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo A"}'</span>)
        <span style="color: #a0522d;">b</span> = add_vertex(g, <span style="color: #8b2252;">'B'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo B"}'</span>)
        <span style="color: #a0522d;">c</span> = add_vertex(g, <span style="color: #8b2252;">'C'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo C"}'</span>)
        <span style="color: #a0522d;">d</span> = add_vertex(g, <span style="color: #8b2252;">'D'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo D"}'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#36793;, abc&#20043;&#38388;&#30340;&#29615;
</span>        <span style="color: #a0522d;">ba</span> = add_edge(g, b, a)
        <span style="color: #a0522d;">ac</span> = add_edge(g, a, c)
        <span style="color: #a0522d;">cb</span> = add_edge(g, c, b)
        <span style="color: #a0522d;">bd</span> = add_edge(g, b, d)

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22270;3 &#21019;&#24314;DAG
</span>        <span style="color: #a0522d;">g</span> = create_graph(<span style="color: #8b2252;">'test3'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22810;&#20010;&#32456;&#28857;
</span>        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#39030;&#28857;
</span>        <span style="color: #a0522d;">a</span> = add_vertex(g, <span style="color: #8b2252;">'A'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo A"}'</span>)
        <span style="color: #a0522d;">b</span> = add_vertex(g, <span style="color: #8b2252;">'B'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo B"}'</span>)
        <span style="color: #a0522d;">c</span> = add_vertex(g, <span style="color: #8b2252;">'C'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo C"}'</span>)
        <span style="color: #a0522d;">d</span> = add_vertex(g, <span style="color: #8b2252;">'D'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo D"}'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#36793;
</span>        <span style="color: #a0522d;">ba</span> = add_edge(g, b, a)
        <span style="color: #a0522d;">ac</span> = add_edge(g, a, c)
        <span style="color: #a0522d;">bc</span> = add_edge(g, b, c)
        <span style="color: #a0522d;">bd</span> = add_edge(g, b, d)

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22270;4 &#21019;&#24314;DAG
</span>        <span style="color: #a0522d;">g</span> = create_graph(<span style="color: #8b2252;">'test4'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22810;&#20837;&#21475;
</span>        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#39030;&#28857;
</span>        <span style="color: #a0522d;">a</span> = add_vertex(g, <span style="color: #8b2252;">'A'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo A"}'</span>)
        <span style="color: #a0522d;">b</span> = add_vertex(g, <span style="color: #8b2252;">'B'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo B"}'</span>)
        <span style="color: #a0522d;">c</span> = add_vertex(g, <span style="color: #8b2252;">'C'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo C"}'</span>)
        <span style="color: #a0522d;">d</span> = add_vertex(g, <span style="color: #8b2252;">'D'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo D"}'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#36793;
</span>        <span style="color: #a0522d;">ab</span> = add_edge(g, a, b)
        <span style="color: #a0522d;">ac</span> = add_edge(g, a, c)
        <span style="color: #a0522d;">cb</span> = add_edge(g, c, b)
        <span style="color: #a0522d;">db</span> = add_edge(g, d, b)
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        <span style="color: #a020f0;">raise</span> e
</pre>
</div>

<p>
流转代码实现：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Executor</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, workers=5):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__pool</span> = ThreadPoolExecutor(max_workers=workers)
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__event</span> = threading.Event()
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__tasks</span> = {}
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__queue</span> = Queue()
        threading.Thread(target=<span style="color: #a020f0;">self</span>._run).start()
        threading.Thread(target=<span style="color: #a020f0;">self</span>._save_track).start()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_execute</span>(<span style="color: #a020f0;">self</span>, script: <span style="color: #483d8b;">str</span>):
        <span style="color: #a020f0;">with</span> TemporaryFile(<span style="color: #8b2252;">'w+'</span>) <span style="color: #a020f0;">as</span> f:
            <span style="color: #a0522d;">output</span> = []
            <span style="color: #a0522d;">code</span> = 0
            <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> script.splitlines():
                <span style="color: #a0522d;">p</span> = Popen(line, shell=<span style="color: #008b8b;">True</span>, stdout=f)
                <span style="color: #a0522d;">code</span> = p.wait()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;&#31561;&#65292;code&#20026;0&#26159;&#27491;&#30830;&#25191;&#34892;
</span>                f.seek(0)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22238;&#21040;&#24320;&#22836;
</span>                <span style="color: #a0522d;">text</span> = f.read()
                output.append(text)
                <span style="color: #a0522d;">code</span> += code
            <span style="color: #a020f0;">return</span> code, <span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>.join(output)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">execute</span>(<span style="color: #a020f0;">self</span>, p_id, t_id, script: <span style="color: #483d8b;">str</span>):
        <span style="color: #8b2252;">"""&#24322;&#27493;&#25191;&#34892;&#26041;&#27861;&#65292;&#25552;&#20132;&#25968;&#25454;&#23601;&#34892;&#20102;&#65292;&#36816;&#34892;&#21518;&#65292;&#20250;&#25552;&#20379;&#36816;&#34892;&#32467;&#26524;&#65292;&#25110;&#36820;&#22238;&#22833;&#36133;"""</span>
        <span style="color: #a0522d;">key</span> = uuid.uuid4().<span style="color: #483d8b;">hex</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">uuid&#27809;&#26377;&#29992;&#19978;&#65292;&#21482;&#26159;&#35828;&#20197;&#21518;&#19981;&#37325;&#22797;key&#25110;id&#21487;&#20197;&#29992;uuid
</span>        <span style="color: #a020f0;">try</span>:
            <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__tasks</span>[<span style="color: #a020f0;">self</span>.__pool.submit(<span style="color: #a020f0;">self</span>._execute, script)] = (key, p_id, t_id)  <span style="color: #b22222;"># </span><span style="color: #b22222;">future &#23545;&#35937;
</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;&#29366;&#24577;&#20026;&#20934;&#22791;&#25191;&#34892;RUNNING
</span>            <span style="color: #a0522d;">track</span> = db.session.query(Track).<span style="color: #483d8b;">filter</span>(Track.<span style="color: #483d8b;">id</span> == t_id).one()
            track.<span style="color: #a0522d;">state</span> = STATE_RUNNING
            db.session.add(track)
            db.session.commit()
        <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
            db.session.rollback()
            <span style="color: #a020f0;">raise</span> e

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_run</span>(<span style="color: #a020f0;">self</span>):  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32447;&#31243;&#31561;&#24453;&#20219;&#21153;
</span>        <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">self</span>.__event.wait(1):
            <span style="color: #a020f0;">for</span> future <span style="color: #a020f0;">in</span> as_completed(<span style="color: #a020f0;">self</span>.__tasks):
                <span style="color: #a0522d;">key</span>, <span style="color: #a0522d;">p_id</span>, <span style="color: #a0522d;">t_id</span> = <span style="color: #a020f0;">self</span>.__tasks[future]
                <span style="color: #a020f0;">try</span>:
                    <span style="color: #a0522d;">code</span>, <span style="color: #a0522d;">text</span> = future.result()
                    <span style="color: #a020f0;">del</span> <span style="color: #a020f0;">self</span>.__tasks[future]
                    <span style="color: #a020f0;">self</span>.__queue.put((p_id, t_id, code, text))
                <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
                    <span style="color: #483d8b;">print</span>(key, e)
                    <span style="color: #a020f0;">del</span> <span style="color: #a020f0;">self</span>.__tasks[future]  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22833;&#36133;&#20219;&#21153;&#20197;&#21518;&#22788;&#29702; TODO
</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_save_track</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">self</span>.__event.is_set():
            <span style="color: #a0522d;">p_id</span>, <span style="color: #a0522d;">t_id</span>, <span style="color: #a0522d;">code</span>, <span style="color: #a0522d;">text</span> = <span style="color: #a020f0;">self</span>.__queue.get()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;&#21462;
</span>
            <span style="color: #a0522d;">track</span> = db.session.query(Track).<span style="color: #483d8b;">filter</span>(Track.v_id == t_id).first()
            track.<span style="color: #a0522d;">state</span> = STATE_SUCCEED <span style="color: #a020f0;">if</span> code == 0 <span style="color: #a020f0;">else</span> STATE_FAILED  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;&#29366;&#24577;
</span>            track.<span style="color: #a0522d;">output</span> = text

            <span style="color: #a020f0;">if</span> code != 0:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22833;&#36133;&#65292;&#24517;&#39035;&#31435;&#21363;&#23558;&#20219;&#21153;&#27969;&#29366;&#24577;&#35774;&#32622;&#20026;&#22833;&#36133;
</span>                track.pipeline.<span style="color: #a0522d;">state</span> = STATE_FAILED

            <span style="color: #a020f0;">else</span>:
                <span style="color: #b22222;"># </span><span style="color: #b22222;">+++++++++++ &#27969;&#36716;&#20195;&#30721; +++++++++++
</span>                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25152;&#26377;&#20854;&#20182;&#33410;&#28857;
</span>                <span style="color: #a0522d;">others</span> = db.session.query(Track).<span style="color: #483d8b;">filter</span>((Track.p_id == p_id) &amp; (Track.v_id != t_id)).<span style="color: #483d8b;">all</span>()
                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31561;&#24453;&#65292;&#24453;&#36816;&#34892;&#65292; &#36816;&#34892;&#65292;&#25104;&#21151;&#65292;&#22833;&#36133;
</span>                <span style="color: #a0522d;">states</span> = {STATE_WAITING: 0, STATE_PENDING: 0, STATE_RUNNING: 0, STATE_SUCCEED: 0, STATE_FAILED: 0}

                <span style="color: #a020f0;">for</span> other <span style="color: #a020f0;">in</span> others:
                    <span style="color: #a0522d;">states</span>[other.state] += 1

                <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'+'</span> * 30)
                <span style="color: #483d8b;">print</span>(states, <span style="color: #483d8b;">len</span>(others))
                <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'+'</span> * 30)
                <span style="color: #a020f0;">if</span> states[STATE_FAILED] &gt; 0:
                    track.pipeline.<span style="color: #a0522d;">state</span> = STATE_FAILED
                <span style="color: #a020f0;">elif</span> states[STATE_SUCCEED] == <span style="color: #483d8b;">len</span>(others):  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38500;&#20102;&#23427;&#20043;&#22806;&#20840;&#26159;&#25104;&#21151;&#35828;&#26126;&#20840;&#37096;&#25104;&#21151;
</span>                    track.pipeline.<span style="color: #a0522d;">state</span> = STATE_FINISHED
                <span style="color: #a020f0;">else</span>:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35828;&#26126;&#36824;&#26377;&#27809;&#36816;&#34892;&#23436;&#30340;&#33410;&#28857;&#65292;&#24320;&#22987;&#25214;&#19979;&#19968;&#32423;&#33410;&#28857;&#20204;
</span>                    <span style="color: #a0522d;">nexts</span> = db.session.query(Edge).<span style="color: #483d8b;">filter</span>(Edge.tail == track.v_id).<span style="color: #483d8b;">all</span>()
                    <span style="color: #a020f0;">if</span> nexts:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26377;&#19979;&#19968;&#32423;&#65292;&#23558;&#36825;&#20123;&#33410;&#28857;&#30340;state&#25913;&#20026;STATE_PENDING
</span>                        <span style="color: #a020f0;">for</span> <span style="color: #483d8b;">next</span> <span style="color: #a020f0;">in</span> nexts:
                            <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">next</span>.head)
                            <span style="color: #a0522d;">t</span> = db.session.query(Track).<span style="color: #483d8b;">filter</span>(Track.v_id == <span style="color: #483d8b;">next</span>.head).one()
                            t.<span style="color: #a0522d;">state</span> = STATE_PENDING
                            db.session.add(t)
                    <span style="color: #a020f0;">else</span>:
                        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27809;&#26377;&#19979;&#19968;&#32423;&#65292;&#26159;&#32456;&#28857;
</span>                        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#33258;&#24049;&#26159;&#22810;&#32456;&#28857;&#30340;&#26368;&#21518;&#30340;&#19968;&#20010;&#32456;&#28857;&#65292;&#37027;&#20040;&#20854;&#20182;&#33410;&#28857;&#37117;&#26159;&#25104;&#21151;&#30340;
</span>                        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22312;&#19978;&#38754;&#30340;&#21028;&#26029;states[STATE_SUCCEED] == len(others)&#23601;&#25104;&#31435;&#20102;
</span>                        <span style="color: #a020f0;">pass</span>
                <span style="color: #b22222;"># </span><span style="color: #b22222;">+++++++++++ &#27969;&#36716;&#20195;&#30721; +++++++++++
</span>            db.session.add(track)
            <span style="color: #a020f0;">try</span>:
                db.session.commit()
            <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
                db.session.rollback()
                <span style="color: #483d8b;">print</span>(e)

<span style="color: #a0522d;">EXECUTOR</span> = Executor()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20840;&#23616;&#20219;&#21153;&#25191;&#34892;&#22120;&#23545;&#35937;</span>
</pre>
</div>

<p>
循环测试代码如下：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
    <span style="color: #a0522d;">ps</span> = show_pipeline(1)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#36816;&#34892;&#33410;&#28857;&#21015;&#34920;
</span>    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
    <span style="color: #483d8b;">print</span>(ps)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
    time.sleep(1)

    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'~~~~~~~~~~~~~ sleeping ~~~~~~~~~~~~'</span>)
    <span style="color: #a020f0;">for</span> p_id, p_name, p_state, t_id, v_id, t_state, inp, script <span style="color: #a020f0;">in</span> ps:
        <span style="color: #483d8b;">print</span>(p_id, p_name, p_state, t_id, v_id, t_state, inp, script)

        <span style="color: #a0522d;">d</span> = {}  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#21442;&#25968;&#26159;&#24517;&#39035;&#65292;&#21017;&#20132;&#20114;&#65292;&#35753;&#29992;&#25143;&#25552;&#20132;
</span>        <span style="color: #a020f0;">if</span> inp:
            <span style="color: #a0522d;">inp</span> = simplejson.loads(inp)
            <span style="color: #a020f0;">for</span> k <span style="color: #a020f0;">in</span> inp.keys():
                <span style="color: #a020f0;">if</span> inp[k].get(<span style="color: #8b2252;">'required'</span>, <span style="color: #008b8b;">False</span>):
                    <span style="color: #a0522d;">d</span>[k] = <span style="color: #483d8b;">input</span>(<span style="color: #8b2252;">'{}= '</span>.<span style="color: #483d8b;">format</span>(k))
            <span style="color: #483d8b;">print</span>(d)

        <span style="color: #a0522d;">params</span> = finish_params(t_id, d, inp)
        <span style="color: #483d8b;">print</span>(params)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20934;&#22791;&#22909;&#21442;&#25968;
</span>        <span style="color: #483d8b;">print</span>(script, <span style="color: #8b2252;">'+++++++++'</span>)
        <span style="color: #a0522d;">script</span> = finish_script(t_id, script, params)
        <span style="color: #483d8b;">print</span>(script)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25343;&#21040;&#26367;&#25442;&#22909;&#30340;&#33050;&#26412;&#65292;&#20934;&#22791;&#25191;&#34892;
</span>
        EXECUTOR.execute(p_id, t_id, script)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24322;&#27493;&#25191;&#34892;</span>
</pre>
</div>

<p>
至此主流程已经完成，可以继续扩展功能和 bug 调试。
</p>
</div>
</div>
</div>
<div id="outline-container-h:9f91ec6f-afce-4d65-a763-2d73f2a44ee7" class="outline-4">
<h4 id="h:9f91ec6f-afce-4d65-a763-2d73f2a44ee7">完整代码</h4>
<div class="outline-text-4" id="text-h:9f91ec6f-afce-4d65-a763-2d73f2a44ee7">
</div>
<div id="outline-container-h:95344ba1-187b-408a-8a90-5fde37fc967a" class="outline-5">
<h5 id="h:95344ba1-187b-408a-8a90-5fde37fc967a">config.py</h5>
<div class="outline-text-5" id="text-h:95344ba1-187b-408a-8a90-5fde37fc967a">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">USERNAME</span> = <span style="color: #8b2252;">'brinnatt'</span>
<span style="color: #a0522d;">PASSWD</span> = <span style="color: #8b2252;">'WelC0me168!'</span>
<span style="color: #a0522d;">DBIP</span> = <span style="color: #8b2252;">'192.168.136.131'</span>
<span style="color: #a0522d;">DBPORT</span> = 3306
<span style="color: #a0522d;">DBNAME</span> = <span style="color: #8b2252;">'pipeline'</span>
<span style="color: #a0522d;">CHARSET</span> = <span style="color: #8b2252;">'utf8mb4'</span>

<span style="color: #a0522d;">URL</span> = f<span style="color: #8b2252;">'mysql+pymysql://</span>{USERNAME}<span style="color: #8b2252;">:</span>{PASSWD}<span style="color: #8b2252;">@</span>{DBIP}<span style="color: #8b2252;">:</span>{DBPORT}<span style="color: #8b2252;">/</span>{DBNAME}<span style="color: #8b2252;">?charset=</span>{CHARSET}<span style="color: #8b2252;">'</span>
<span style="color: #a0522d;">DATABASE_DEBUG</span> = <span style="color: #008b8b;">True</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fac66904-228a-4636-ba3a-f5e047917e3b" class="outline-5">
<h5 id="h:fac66904-228a-4636-ba3a-f5e047917e3b">model.py</h5>
<div class="outline-text-5" id="text-h:fac66904-228a-4636-ba3a-f5e047917e3b">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> Column, Integer, String, Text, ForeignKey, create_engine
<span style="color: #a020f0;">from</span> sqlalchemy.orm <span style="color: #a020f0;">import</span> relationship, sessionmaker
<span style="color: #a020f0;">from</span> sqlalchemy.ext.declarative <span style="color: #a020f0;">import</span> declarative_base
<span style="color: #a020f0;">import</span> functools
<span style="color: #a020f0;">from</span> . <span style="color: #a020f0;">import</span> config

<span style="color: #a0522d;">STATE_WAITING</span> = 0
<span style="color: #a0522d;">STATE_PENDING</span> = 1
<span style="color: #a0522d;">STATE_RUNNING</span> = 2
<span style="color: #a0522d;">STATE_SUCCEED</span> = 3
<span style="color: #a0522d;">STATE_FAILED</span> = 4
<span style="color: #a0522d;">STATE_FINISHED</span> = 5

<span style="color: #a0522d;">Base</span> = declarative_base()

<span style="color: #b22222;"># </span><span style="color: #b22222;">schema&#23450;&#20041;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#22270;
</span><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Graph</span>(Base):
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">"graph"</span>

    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">name</span> = Column(String(48), nullable=<span style="color: #008b8b;">False</span>, unique=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">desc</span> = Column(String(500), nullable=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">checked</span> = Column(Integer, nullable=<span style="color: #008b8b;">False</span>, default=0)
    <span style="color: #a0522d;">sealed</span> = Column(Integer, nullable=<span style="color: #008b8b;">False</span>, default=0)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32463;&#24120;&#20174;&#22270;&#26597;&#30475;&#25152;&#26377;&#39030;&#28857;&#12289;&#36793;&#30340;&#20449;&#24687;
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#37324;&#24517;&#39035;&#20351;&#29992;foreign_keys&#65292;&#36825;&#26159;&#22240;&#20026;&#20174;&#19968;&#31471;&#26597;&#22810;&#31471;&#65292;&#20854;&#20540;&#24517;&#39035;&#20351;&#29992;&#24341;&#21495;
</span>    <span style="color: #a0522d;">vertexes</span> = relationship(<span style="color: #8b2252;">'Vertex'</span>, foreign_keys=<span style="color: #8b2252;">'Vertex.g_id'</span>)
    <span style="color: #a0522d;">edges</span> = relationship(<span style="color: #8b2252;">'Edge'</span>, foreign_keys=<span style="color: #8b2252;">'[Edge.g_id]'</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#39030;&#28857;&#34920;
</span><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Vertex</span>(Base):
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">"vertex"</span>

    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">name</span> = Column(String(48), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #483d8b;">input</span> = Column(Text, nullable=<span style="color: #008b8b;">True</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36755;&#20837;&#21442;&#25968;
</span>    <span style="color: #a0522d;">script</span> = Column(Text, nullable=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">g_id</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'graph.id'</span>), nullable=<span style="color: #008b8b;">False</span>)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20174;&#39030;&#28857;&#26597;&#23427;&#30340;&#36793;&#65292;&#36825;&#37324;&#24517;&#39035;&#20351;&#29992;foreign_keys&#65292;&#36825;&#26159;&#22240;&#20026;&#20174;&#19968;&#31471;&#26597;&#22810;&#31471;&#65292;&#20854;&#20540;&#24517;&#39035;&#20351;&#29992;&#24341;&#21495;
</span>    <span style="color: #a0522d;">tails</span> = relationship(<span style="color: #8b2252;">'Edge'</span>, foreign_keys=<span style="color: #8b2252;">'[Edge.tail]'</span>)
    <span style="color: #a0522d;">heads</span> = relationship(<span style="color: #8b2252;">'Edge'</span>, foreign_keys=<span style="color: #8b2252;">'Edge.head'</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#36793;&#34920;
</span><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Edge</span>(Base):
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">'edge'</span>

    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">tail</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'vertex.id'</span>), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">head</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'vertex.id'</span>), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">g_id</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'graph.id'</span>), nullable=<span style="color: #008b8b;">False</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">Engine
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">pipeline &#34920;
</span><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Pipeline</span>(Base):
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">'pipeline'</span>

    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">g_id</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'graph.id'</span>), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">current = Column(Integer, ForeignKey('vertex.id'), nullable=False)
</span>    <span style="color: #a0522d;">name</span> = Column(String(48), nullable=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">state</span> = Column(Integer, nullable=<span style="color: #008b8b;">False</span>, default=STATE_WAITING)
    <span style="color: #a0522d;">desc</span> = Column(String(100))

    <span style="color: #b22222;"># </span><span style="color: #b22222;">vertex = relationship('Vertex')
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20174;pipeline&#21435;&#26597;&#25152;&#26377;&#33410;&#28857;&#20449;&#24687;
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">tracks = relationship('Track', foreign_keys='Track.p_id')
</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Track</span>(Base):
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">'track'</span>

    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">p_id</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'pipeline.id'</span>), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">v_id</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'vertex.id'</span>), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">state</span> = Column(Integer, index=<span style="color: #008b8b;">True</span>, nullable=<span style="color: #008b8b;">False</span>, default=STATE_WAITING)  <span style="color: #b22222;"># </span><span style="color: #b22222;">+&#32034;&#24341;
</span>    <span style="color: #483d8b;">input</span> = Column(Text, nullable=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">output</span> = Column(Text, nullable=<span style="color: #008b8b;">True</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20219;&#21153;&#36755;&#20986;
</span>    <span style="color: #a0522d;">script</span> = Column(Text, nullable=<span style="color: #008b8b;">True</span>)

    <span style="color: #a0522d;">vertex</span> = relationship(<span style="color: #8b2252;">'Vertex'</span>)
    <span style="color: #a0522d;">pipeline</span> = relationship(<span style="color: #8b2252;">'Pipeline'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19968;&#31471;&#22810;&#31471;&#38543;&#20415;&#20889;&#19968;&#20010;&#21363;&#21487;&#65292;&#19981;&#35201;&#37325;&#22797;
</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> f<span style="color: #8b2252;">"&lt;</span>{<span style="color: #a020f0;">self</span>.__class__.<span style="color: #483d8b;">__name__</span>}<span style="color: #8b2252;"> </span>{<span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">id</span>}<span style="color: #8b2252;"> </span>{<span style="color: #a020f0;">self</span>.p_id}<span style="color: #8b2252;"> </span>{<span style="color: #a020f0;">self</span>.v_id}<span style="color: #8b2252;">"</span>

    <span style="color: #a0522d;">__str__</span> = __repr__

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23553;&#35013;&#25968;&#25454;&#24211;&#30340;&#24341;&#25806;&#12289;&#20250;&#35805;&#21040;&#31867;&#20013;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21333;&#20363;&#27169;&#24335;
</span><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">singleton</span>(cls):
    <span style="color: #a0522d;">instance</span> = <span style="color: #008b8b;">None</span>

    <span style="color: #228b22;">@functools.wraps</span>(cls)
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">getinstance</span>(*args, **kwargs):
        <span style="color: #a020f0;">nonlocal</span> instance
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> instance:
            <span style="color: #483d8b;">print</span>(args)
            <span style="color: #483d8b;">print</span>(kwargs)
            <span style="color: #a0522d;">instance</span> = cls(*args, **kwargs)
        <span style="color: #a020f0;">return</span> instance

    <span style="color: #a020f0;">return</span> getinstance

<span style="color: #228b22;">@singleton</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Database</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, url, **kwargs):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">_engine</span> = create_engine(url, **kwargs)
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">_session</span> = sessionmaker(bind=<span style="color: #a020f0;">self</span>._engine)()

    @<span style="color: #483d8b;">property</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">session</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>._session

    @<span style="color: #483d8b;">property</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">engine</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>._engine

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#34920;
</span>    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">create_all</span>(<span style="color: #a020f0;">self</span>):
        Base.metadata.create_all(<span style="color: #a020f0;">self</span>._engine)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#34920;
</span>    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">drop_all</span>(<span style="color: #a020f0;">self</span>):
        Base.metadata.drop_all(<span style="color: #a020f0;">self</span>._engine)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27169;&#22359;&#21152;&#36733;&#19968;&#27425;&#65292;db&#20063;&#26159;&#21333;&#20363;&#30340;
</span><span style="color: #a0522d;">db</span> = Database(config.URL, echo=config.DATABASE_DEBUG)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3106f785-dea1-413c-ab36-0b44b753cc71" class="outline-5">
<h5 id="h:3106f785-dea1-413c-ab36-0b44b753cc71">service.py</h5>
<div class="outline-text-5" id="text-h:3106f785-dea1-413c-ab36-0b44b753cc71">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> .model <span style="color: #a020f0;">import</span> db
<span style="color: #a020f0;">from</span> .model <span style="color: #a020f0;">import</span> Graph, Vertex, Edge, Track, Pipeline
<span style="color: #a020f0;">from</span> .model <span style="color: #a020f0;">import</span> STATE_WAITING, STATE_PENDING, STATE_RUNNING, STATE_FAILED
<span style="color: #a020f0;">from</span> functools <span style="color: #a020f0;">import</span> wraps
<span style="color: #a020f0;">from</span> collections <span style="color: #a020f0;">import</span> defaultdict
<span style="color: #a020f0;">import</span> simplejson

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31867;&#22411;&#36716;&#25442;&#29992;
</span><span style="color: #a0522d;">TYPES</span> = {
    <span style="color: #8b2252;">'str'</span>: <span style="color: #483d8b;">str</span>,
    <span style="color: #8b2252;">'string'</span>: <span style="color: #483d8b;">str</span>,
    <span style="color: #8b2252;">'int'</span>: <span style="color: #483d8b;">int</span>,
    <span style="color: #8b2252;">'integer'</span>: <span style="color: #483d8b;">int</span>
}

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">transactional</span>(fn):
    <span style="color: #228b22;">@wraps</span>(fn)
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">wrapper</span>(*args, **kwargs):
        <span style="color: #a0522d;">ret</span> = fn(*args, **kwargs)
        <span style="color: #a020f0;">try</span>:
            db.session.commit()
            <span style="color: #a020f0;">return</span> ret
        <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
            <span style="color: #483d8b;">print</span>(e)
            db.session.rollback()

    <span style="color: #a020f0;">return</span> wrapper

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;DAG
</span><span style="color: #228b22;">@transactional</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">create_graph</span>(name, desc=<span style="color: #008b8b;">None</span>):
    <span style="color: #a0522d;">g</span> = Graph()
    g.<span style="color: #a0522d;">name</span> = name
    g.<span style="color: #a0522d;">desc</span> = desc

    db.session.add(g)
    <span style="color: #a020f0;">return</span> g

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20026;DAG&#22686;&#21152;&#39030;&#28857;
</span><span style="color: #228b22;">@transactional</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">add_vertex</span>(graph: Graph, name: <span style="color: #483d8b;">str</span>, <span style="color: #483d8b;">input</span>=<span style="color: #008b8b;">None</span>, script=<span style="color: #008b8b;">None</span>):
    <span style="color: #a0522d;">v</span> = Vertex()
    v.<span style="color: #a0522d;">g_id</span> = graph.<span style="color: #483d8b;">id</span>
    v.<span style="color: #a0522d;">name</span> = name
    v.<span style="color: #483d8b;">input</span> = <span style="color: #483d8b;">input</span>
    v.<span style="color: #a0522d;">script</span> = script

    db.session.add(v)
    <span style="color: #a020f0;">return</span> v

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20026;DAG&#22686;&#21152;&#36793;
</span><span style="color: #228b22;">@transactional</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">add_edge</span>(graph: Graph, tail: Vertex, head: Vertex):
    <span style="color: #a0522d;">e</span> = Edge()
    e.<span style="color: #a0522d;">g_id</span> = graph.<span style="color: #483d8b;">id</span>
    e.<span style="color: #a0522d;">tail</span> = tail.<span style="color: #483d8b;">id</span>
    e.<span style="color: #a0522d;">head</span> = head.<span style="color: #483d8b;">id</span>

    db.session.add(e)
    <span style="color: #a020f0;">return</span> e

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#39030;&#28857;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#39030;&#28857;&#23601;&#35201;&#21024;&#38500;&#25152;&#26377;&#39030;&#28857;&#20851;&#32852;&#30340;&#36793;
</span><span style="color: #228b22;">@transactional</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">del_vertex</span>(<span style="color: #483d8b;">id</span>):
    <span style="color: #a0522d;">query</span> = db.session.query(Vertex).<span style="color: #483d8b;">filter</span>(Vertex.<span style="color: #483d8b;">id</span> == <span style="color: #483d8b;">id</span>)
    <span style="color: #a0522d;">v</span> = query.first()
    <span style="color: #a020f0;">if</span> v:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25214;&#21040;&#39030;&#28857;&#21518;&#65292;&#21024;&#38500;&#20851;&#32852;&#30340;&#36793;&#65292;&#28982;&#21518;&#21024;&#38500;&#39030;&#28857;
</span>        db.session.query(Edge).<span style="color: #483d8b;">filter</span>((Edge.tail == v.<span style="color: #483d8b;">id</span>) | (Edge.head == v.<span style="color: #483d8b;">id</span>)).delete()
        query.delete()
    <span style="color: #a020f0;">return</span> v

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">check_graph</span>(graph: Graph) -&gt; <span style="color: #483d8b;">bool</span>:
    <span style="color: #a0522d;">query</span> = db.session.query(Vertex).<span style="color: #483d8b;">filter</span>(Vertex.g_id == graph.<span style="color: #483d8b;">id</span>)
    <span style="color: #a0522d;">vertexes</span> = {vertex.<span style="color: #483d8b;">id</span> <span style="color: #a020f0;">for</span> vertex <span style="color: #a020f0;">in</span> query}

    <span style="color: #a0522d;">query</span> = db.session.query(Edge).<span style="color: #483d8b;">filter</span>(Edge.g_id == graph.<span style="color: #483d8b;">id</span>)
    <span style="color: #a0522d;">edges</span> = defaultdict(<span style="color: #483d8b;">list</span>)
    <span style="color: #a0522d;">ids</span> = <span style="color: #483d8b;">set</span>()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26377;&#20837;&#24230;&#30340;&#39030;&#28857;
</span>    <span style="color: #a020f0;">for</span> edge <span style="color: #a020f0;">in</span> query:
        <span style="color: #b22222;"># </span><span style="color: #b22222;">defaultdict(&lt;class 'list'&gt;, {1: [(1, 2), (1, 3)], 2: [(2, 4)], 3: [(3, 2)]})
</span>        edges[edge.tail].append((edge.tail, edge.head))
        ids.add(edge.head)

    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-='</span> * 30)
    <span style="color: #483d8b;">print</span>(vertexes, edges)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">===============&#27979;&#35797;&#25968;&#25454;===============
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">{1, 2, 3, 4}
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">defaultdict(&lt;class 'list'&gt;, {1: [(1, 2), (1, 3)], 2: [(2, 4)], 3: [(3, 2)]})
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">vertexes = {1, 2, 3, 4}
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">edges = {1: [(1, 2), (1, 3)], 2: [(2, 4)], 3: [(3, 2)]}
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">ids = set() # &#26377;&#20837;&#24230;&#30340;&#39030;&#28857;
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">=====================================
</span>
    <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(edges) == 0:
        <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">False</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19968;&#26465;&#36793;&#37117;&#27809;&#26377;&#65292;&#36825;&#26679;&#30340;DAG&#19994;&#21153;&#19978;&#19981;&#29992;
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;edges&#19981;&#20026;&#31354;&#65292;&#19968;&#23450;&#26377;ids&#65292;&#20063;&#23601;&#26159;&#26377;&#20837;&#24230;&#30340;&#39030;&#28857;
</span>    <span style="color: #a0522d;">zds</span> = vertexes - ids  <span style="color: #b22222;"># </span><span style="color: #b22222;">zds&#20837;&#24230;&#20026;0&#30340;&#39030;&#28857;
</span>    <span style="color: #b22222;"># </span><span style="color: #b22222;">zds&#20026;0&#35828;&#26126;&#27809;&#26377;&#25214;&#21040;&#20837;&#24230;&#20026;0&#30340;&#39030;&#28857;&#65292;&#31639;&#27861;&#32456;&#27490;
</span>    <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(zds):
        <span style="color: #a020f0;">for</span> zd <span style="color: #a020f0;">in</span> zds:
            <span style="color: #a020f0;">if</span> zd <span style="color: #a020f0;">in</span> edges:
                <span style="color: #a020f0;">del</span> edges[zd]

        <span style="color: #a020f0;">while</span> edges:
            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;&#39030;&#28857;&#38598;&#25913;&#20026;&#24403;&#21069;&#20837;&#24230;&#39030;&#28857;&#38598;ids
</span>            <span style="color: #a0522d;">vertexes</span> = ids
            <span style="color: #a0522d;">ids</span> = <span style="color: #483d8b;">set</span>()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#37325;&#26032;&#23547;&#25214;&#26377;&#20837;&#24230;&#30340;&#39030;&#28857;
</span>
            <span style="color: #a020f0;">for</span> lst <span style="color: #a020f0;">in</span> edges.values():
                <span style="color: #a020f0;">for</span> edge <span style="color: #a020f0;">in</span> lst:
                    ids.add(edge[1])
            <span style="color: #a0522d;">zds</span> = vertexes - ids
            <span style="color: #483d8b;">print</span>(vertexes, ids, zds)
            <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(zds) == 0:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26377;&#29615;&#36335;
</span>                <span style="color: #a020f0;">break</span>
            <span style="color: #a020f0;">for</span> zd <span style="color: #a020f0;">in</span> zds:
                <span style="color: #a020f0;">if</span> zd <span style="color: #a020f0;">in</span> edges:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26377;&#21487;&#33021;&#39030;&#28857;&#27809;&#26377;&#20986;&#24230;
</span>                    <span style="color: #a020f0;">del</span> edges[zd]
            <span style="color: #483d8b;">print</span>(edges)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36793;&#38598;&#20026;&#31354;&#65292;&#21097;&#19979;&#25152;&#26377;&#39030;&#28857;&#37117;&#26159;&#20837;&#24230;&#20026;0&#30340;&#65292;&#37117;&#21487;&#20197;&#22810;&#27425;&#36845;&#20195;&#21024;&#38500;&#25481;
</span>    <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(edges) == 0:
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26816;&#39564;&#36890;&#36807;&#65292;&#20462;&#25913;checked&#23383;&#27573;&#20026;1
</span>        <span style="color: #a020f0;">try</span>:
            <span style="color: #a0522d;">graph</span> = db.session.query(Graph).<span style="color: #483d8b;">filter</span>(Graph.<span style="color: #483d8b;">id</span> == graph.<span style="color: #483d8b;">id</span>).first()
            <span style="color: #a020f0;">if</span> graph:
                graph.<span style="color: #a0522d;">checked</span> = 1
            db.session.add(graph)
            db.session.commit()
            <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">True</span>
        <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
            db.session.rollback()
            <span style="color: #a020f0;">raise</span> e
    <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">False</span>

<span style="color: #228b22;">@transactional</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">finish_params</span>(t_id, d: <span style="color: #483d8b;">dict</span>, inp):
    <span style="color: #8b2252;">"""&#23436;&#25104;&#25152;&#26377;&#21442;&#25968;&#20540;"""</span>
    <span style="color: #a0522d;">params</span> = {}  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26368;&#32456;&#30340;&#21442;&#25968;
</span>    <span style="color: #a020f0;">if</span> inp:
        <span style="color: #483d8b;">print</span>(inp)
        <span style="color: #483d8b;">print</span>(d)
        <span style="color: #a020f0;">for</span> k, v <span style="color: #a020f0;">in</span> inp.items():
            <span style="color: #483d8b;">print</span>(k, v)
            <span style="color: #a0522d;">val</span> = d.get(k)
            <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">isinstance</span>(val, TYPES.get(v[<span style="color: #8b2252;">'type'</span>], <span style="color: #483d8b;">str</span>)):
                <span style="color: #a0522d;">params</span>[k] = val
            <span style="color: #a020f0;">elif</span> v.get(<span style="color: #8b2252;">'default'</span>):  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31867;&#22411;&#19981;&#23545;&#65292;&#20294;&#26159;&#26377;&#32570;&#30465;&#20540;
</span>                <span style="color: #a0522d;">params</span>[k] = v.get(<span style="color: #8b2252;">'default'</span>)
            <span style="color: #a020f0;">else</span>:
                <span style="color: #a020f0;">raise</span> <span style="color: #228b22;">TypeError</span>(<span style="color: #8b2252;">'&#21442;&#25968;&#31867;&#22411;&#38169;&#35823;'</span>)

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23558;input&#23384;&#20837;&#25968;&#25454;&#24211;
</span>        <span style="color: #a0522d;">track</span> = db.session.query(Track).<span style="color: #483d8b;">filter</span>(Track.<span style="color: #483d8b;">id</span> == t_id).first()
        <span style="color: #a020f0;">if</span> track:
            track.<span style="color: #483d8b;">input</span> = simplejson.dumps(params)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36716;&#25104;&#23383;&#31526;&#20018;
</span>            db.session.add(track)
    <span style="color: #a020f0;">return</span> params

<span style="color: #228b22;">@transactional</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">finish_script</span>(t_id, script: <span style="color: #483d8b;">str</span>, params: <span style="color: #483d8b;">dict</span>):
    <span style="color: #8b2252;">'''&#20351;&#29992;&#21442;&#25968;&#26367;&#25442;&#33050;&#26412;'''</span>
    <span style="color: #a0522d;">newline</span> = <span style="color: #8b2252;">''</span>
    <span style="color: #a020f0;">if</span> script:
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">isinstance</span>(script, <span style="color: #483d8b;">str</span>):
            <span style="color: #a0522d;">script</span> = simplejson.loads(script).get(<span style="color: #8b2252;">'script'</span>)
        <span style="color: #a020f0;">import</span> re
        <span style="color: #a0522d;">regex</span> = re.<span style="color: #483d8b;">compile</span>(r<span style="color: #8b2252;">'{([^{}]+)}'</span>)

        <span style="color: #a0522d;">start</span> = 0

        <span style="color: #a020f0;">for</span> matcher <span style="color: #a020f0;">in</span> regex.finditer(script):
            <span style="color: #a0522d;">newline</span> += script[start:matcher.start()]
            <span style="color: #483d8b;">print</span>(matcher, matcher.group(1))
            <span style="color: #a0522d;">key</span> = matcher.group(1)
            <span style="color: #a0522d;">tmp</span> = params.get(key, <span style="color: #8b2252;">''</span>)
            <span style="color: #a0522d;">newline</span> += <span style="color: #483d8b;">str</span>(tmp)
            <span style="color: #a0522d;">start</span> = matcher.end()
        <span style="color: #a020f0;">else</span>:
            <span style="color: #a0522d;">newline</span> += script[start:]

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25226;&#29983;&#25104;&#30340;script&#23384;&#20837;&#24211;
</span>        <span style="color: #a0522d;">track</span> = db.session.query(Track).<span style="color: #483d8b;">filter</span>(Track.<span style="color: #483d8b;">id</span> == t_id).first()
        <span style="color: #a020f0;">if</span> track:
            track.<span style="color: #a0522d;">script</span> = newline  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36716;&#25104;&#23383;&#31526;&#20018;
</span>            db.session.add(track)

    <span style="color: #a020f0;">return</span> newline

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#24320;&#21551;&#19968;&#20010;&#27969;&#31243;&#65292;&#29992;&#25143;&#25351;&#23450;&#19968;&#20010;&#21517;&#31216;&#12289;&#25551;&#36848;
</span><span style="color: #228b22;">@transactional</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">start</span>(graph: Graph, name: <span style="color: #483d8b;">str</span>, desc=<span style="color: #008b8b;">None</span>):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21028;&#26029;&#27969;&#31243;&#26159;&#21542;&#23384;&#22312;&#65292;&#19988;checked&#20026;1&#21363;&#26816;&#39564;&#36807;&#30340;
</span>    <span style="color: #a0522d;">g</span> = db.session.query(Graph).<span style="color: #483d8b;">filter</span>(Graph.<span style="color: #483d8b;">id</span> == graph.<span style="color: #483d8b;">id</span>).<span style="color: #483d8b;">filter</span>(Graph.checked == 1).first()
    <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> g:
        <span style="color: #a020f0;">return</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20889;&#20837;pipeline&#34920;
</span>    <span style="color: #a0522d;">p</span> = Pipeline()
    p.<span style="color: #a0522d;">name</span> = name
    p.<span style="color: #a0522d;">desc</span> = desc
    p.<span style="color: #a0522d;">g_id</span> = g.<span style="color: #483d8b;">id</span>
    p.<span style="color: #a0522d;">state</span> = STATE_RUNNING  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24320;&#21551;&#19968;&#20010;&#27969;&#31243;&#36816;&#34892;
</span>    db.session.add(p)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#35810;&#36825;&#20010;graph&#30340;&#25152;&#26377;&#39030;&#28857;&#20840;&#37096;
</span>    <span style="color: #a0522d;">vertexes</span> = db.session.query(Vertex.<span style="color: #483d8b;">id</span>).<span style="color: #483d8b;">filter</span>(Vertex.g_id == graph.<span style="color: #483d8b;">id</span>)
    <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> vertexes:
        <span style="color: #a020f0;">return</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#20986;&#25152;&#26377;&#36215;&#28857;&#65292;&#20837;&#24230;&#20026;0&#65292;&#23376;&#26597;&#35810;&#23454;&#29616;
</span>    <span style="color: #a0522d;">query</span> = vertexes.<span style="color: #483d8b;">filter</span>(Vertex.<span style="color: #483d8b;">id</span>.notin_(
        db.session.query(Edge.head).<span style="color: #483d8b;">filter</span>(Edge.g_id == graph.<span style="color: #483d8b;">id</span>)
    ))
    <span style="color: #a0522d;">zds</span> = {x[0] <span style="color: #a020f0;">for</span> x <span style="color: #a020f0;">in</span> query}  <span style="color: #b22222;"># </span><span style="color: #b22222;">query&#26159;&#22810;&#26465;&#35760;&#24405;&#23545;&#35937;&#65292;&#27599;&#19968;&#26465;&#35760;&#24405;&#26159;&#19968;&#20010;&#20803;&#32452;&#65292;&#20803;&#32452;&#30340;&#20803;&#32032;&#21462;&#20915;&#20110;&#26597;&#20102;&#21738;&#20123;&#23383;&#27573;
</span>    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"--&gt;"</span>, zds)

    <span style="color: #a020f0;">for</span> v <span style="color: #a020f0;">in</span> vertexes:
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20889;&#20837;track&#34920;
</span>        <span style="color: #a0522d;">t</span> = Track()
        t.<span style="color: #a0522d;">p_id</span> = p.<span style="color: #483d8b;">id</span>
        t.<span style="color: #a0522d;">v_id</span> = v.<span style="color: #483d8b;">id</span>
        t.<span style="color: #a0522d;">state</span> = STATE_WAITING <span style="color: #a020f0;">if</span> v.<span style="color: #483d8b;">id</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> zds <span style="color: #a020f0;">else</span> STATE_PENDING
        db.session.add(t)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"--&gt;"</span>, v, t.state, v.<span style="color: #483d8b;">id</span>)

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26631;&#35760;&#26377;&#20154;&#20351;&#29992;&#36807;&#20102;&#65292;sealed&#23553;&#38381;
</span>    <span style="color: #a020f0;">if</span> g.sealed == 0:
        g.<span style="color: #a0522d;">sealed</span> = 1
        db.session.add(g)

    <span style="color: #a020f0;">return</span> p

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#35810;&#27969;&#31243;&#30340;&#26576;&#31181;&#29366;&#24577;&#33410;&#28857;
</span><span style="color: #228b22;">@transactional</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">show_pipeline</span>(<span style="color: #483d8b;">id</span>, state=STATE_PENDING):
    <span style="color: #8b2252;">"""&#26174;&#31034;&#25351;&#23450;&#30340;&#27969;&#31243;&#30340;&#20449;&#24687;"""</span>
    <span style="color: #a0522d;">p</span> = db.session.query(
        Pipeline.<span style="color: #483d8b;">id</span>, Pipeline.name, Pipeline.state,
        Track.<span style="color: #483d8b;">id</span>, Track.v_id, Track.state, Vertex.<span style="color: #483d8b;">input</span>, Vertex.script). \
        join(Track, (Track.p_id == <span style="color: #483d8b;">id</span>) &amp; (Pipeline.<span style="color: #483d8b;">id</span> == Track.p_id)). \
        join(Vertex, Track.v_id == Vertex.<span style="color: #483d8b;">id</span>). \
        <span style="color: #483d8b;">filter</span>(Pipeline.state != STATE_FAILED). \
        <span style="color: #483d8b;">filter</span>(Track.state == state)
    <span style="color: #a020f0;">return</span> p.<span style="color: #483d8b;">all</span>()
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8a92c1d5-964d-4400-bf95-7e35028dbff7" class="outline-5">
<h5 id="h:8a92c1d5-964d-4400-bf95-7e35028dbff7">executor.py</h5>
<div class="outline-text-5" id="text-h:8a92c1d5-964d-4400-bf95-7e35028dbff7">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">executor.py
</span><span style="color: #a020f0;">from</span> .model <span style="color: #a020f0;">import</span> Edge, Track
<span style="color: #a020f0;">from</span> .model <span style="color: #a020f0;">import</span> STATE_WAITING, STATE_PENDING, STATE_RUNNING, STATE_SUCCEED, STATE_FAILED, STATE_FINISHED
<span style="color: #a020f0;">from</span> .service <span style="color: #a020f0;">import</span> db
<span style="color: #a020f0;">from</span> subprocess <span style="color: #a020f0;">import</span> Popen
<span style="color: #a020f0;">from</span> tempfile <span style="color: #a020f0;">import</span> TemporaryFile
<span style="color: #a020f0;">from</span> concurrent.futures <span style="color: #a020f0;">import</span> ThreadPoolExecutor, as_completed
<span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> uuid
<span style="color: #a020f0;">from</span> collections <span style="color: #a020f0;">import</span> defaultdict
<span style="color: #a020f0;">from</span> queue <span style="color: #a020f0;">import</span> Queue

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Executor</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, workers=5):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__pool</span> = ThreadPoolExecutor(max_workers=workers)
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__event</span> = threading.Event()
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__tasks</span> = {}
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__queue</span> = Queue()
        threading.Thread(target=<span style="color: #a020f0;">self</span>._run).start()
        threading.Thread(target=<span style="color: #a020f0;">self</span>._save_track).start()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_execute</span>(<span style="color: #a020f0;">self</span>, script: <span style="color: #483d8b;">str</span>):
        <span style="color: #a020f0;">with</span> TemporaryFile(<span style="color: #8b2252;">'w+'</span>) <span style="color: #a020f0;">as</span> f:
            <span style="color: #a0522d;">output</span> = []
            <span style="color: #a0522d;">code</span> = 0
            <span style="color: #a020f0;">for</span> line <span style="color: #a020f0;">in</span> script.splitlines():
                <span style="color: #a0522d;">p</span> = Popen(line, shell=<span style="color: #008b8b;">True</span>, stdout=f)
                <span style="color: #a0522d;">code</span> = p.wait()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;&#31561;&#65292;code&#20026;0&#26159;&#27491;&#30830;&#25191;&#34892;
</span>                f.seek(0)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22238;&#21040;&#24320;&#22836;
</span>                <span style="color: #a0522d;">text</span> = f.read()
                output.append(text)
                <span style="color: #a0522d;">code</span> += code
            <span style="color: #a020f0;">return</span> code, <span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>.join(output)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">execute</span>(<span style="color: #a020f0;">self</span>, p_id, t_id, script: <span style="color: #483d8b;">str</span>):
        <span style="color: #8b2252;">"""&#24322;&#27493;&#25191;&#34892;&#26041;&#27861;&#65292;&#25552;&#20132;&#25968;&#25454;&#23601;&#34892;&#20102;&#65292;&#36816;&#34892;&#21518;&#65292;&#20250;&#25552;&#20379;&#36816;&#34892;&#32467;&#26524;&#65292;&#25110;&#36820;&#22238;&#22833;&#36133;"""</span>
        <span style="color: #a0522d;">key</span> = uuid.uuid4().<span style="color: #483d8b;">hex</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">uuid&#27809;&#26377;&#29992;&#19978;&#65292;&#21482;&#26159;&#35828;&#20197;&#21518;&#19981;&#37325;&#22797;key&#25110;id&#21487;&#20197;&#29992;uuid
</span>        <span style="color: #a020f0;">try</span>:
            <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__tasks</span>[<span style="color: #a020f0;">self</span>.__pool.submit(<span style="color: #a020f0;">self</span>._execute, script)] = (key, p_id, t_id)  <span style="color: #b22222;"># </span><span style="color: #b22222;">future &#23545;&#35937;
</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;&#29366;&#24577;&#20026;&#20934;&#22791;&#25191;&#34892;RUNNING
</span>            <span style="color: #a0522d;">track</span> = db.session.query(Track).<span style="color: #483d8b;">filter</span>(Track.<span style="color: #483d8b;">id</span> == t_id).one()
            track.<span style="color: #a0522d;">state</span> = STATE_RUNNING
            db.session.add(track)
            db.session.commit()
        <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
            db.session.rollback()
            <span style="color: #a020f0;">raise</span> e

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_run</span>(<span style="color: #a020f0;">self</span>):  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32447;&#31243;&#31561;&#24453;&#20219;&#21153;
</span>        <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">self</span>.__event.wait(1):
            <span style="color: #a020f0;">for</span> future <span style="color: #a020f0;">in</span> as_completed(<span style="color: #a020f0;">self</span>.__tasks):
                <span style="color: #a0522d;">key</span>, <span style="color: #a0522d;">p_id</span>, <span style="color: #a0522d;">t_id</span> = <span style="color: #a020f0;">self</span>.__tasks[future]
                <span style="color: #a020f0;">try</span>:
                    <span style="color: #a0522d;">code</span>, <span style="color: #a0522d;">text</span> = future.result()
                    <span style="color: #a020f0;">del</span> <span style="color: #a020f0;">self</span>.__tasks[future]
                    <span style="color: #a020f0;">self</span>.__queue.put((p_id, t_id, code, text))
                <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
                    <span style="color: #483d8b;">print</span>(key, e)
                    <span style="color: #a020f0;">del</span> <span style="color: #a020f0;">self</span>.__tasks[future]  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22833;&#36133;&#20219;&#21153;&#20197;&#21518;&#22788;&#29702; TODO
</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_save_track</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
            <span style="color: #a0522d;">p_id</span>, <span style="color: #a0522d;">t_id</span>, <span style="color: #a0522d;">code</span>, <span style="color: #a0522d;">text</span> = <span style="color: #a020f0;">self</span>.__queue.get()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38459;&#22622;&#21462;
</span>
            <span style="color: #a0522d;">track</span> = db.session.query(Track).<span style="color: #483d8b;">filter</span>(Track.v_id == t_id).first()
            track.<span style="color: #a0522d;">state</span> = STATE_SUCCEED <span style="color: #a020f0;">if</span> code == 0 <span style="color: #a020f0;">else</span> STATE_FAILED  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;&#29366;&#24577;
</span>            track.<span style="color: #a0522d;">output</span> = text

            <span style="color: #a020f0;">if</span> code != 0:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22833;&#36133;&#65292;&#24517;&#39035;&#31435;&#21363;&#23558;&#20219;&#21153;&#27969;&#29366;&#24577;&#35774;&#32622;&#20026;&#22833;&#36133;
</span>                track.pipeline.<span style="color: #a0522d;">state</span> = STATE_FAILED

            <span style="color: #a020f0;">else</span>:
                <span style="color: #b22222;"># </span><span style="color: #b22222;">+++++++++++ &#27969;&#36716;&#20195;&#30721; +++++++++++
</span>                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25152;&#26377;&#20854;&#20182;&#33410;&#28857;
</span>                <span style="color: #a0522d;">others</span> = db.session.query(Track).<span style="color: #483d8b;">filter</span>((Track.p_id == p_id) &amp; (Track.v_id != t_id)).<span style="color: #483d8b;">all</span>()
                <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31561;&#24453;&#65292;&#24453;&#36816;&#34892;&#65292; &#36816;&#34892;&#65292;&#25104;&#21151;&#65292;&#22833;&#36133;
</span>                <span style="color: #a0522d;">states</span> = {STATE_WAITING: 0, STATE_PENDING: 0, STATE_RUNNING: 0, STATE_SUCCEED: 0, STATE_FAILED: 0}

                <span style="color: #a020f0;">for</span> other <span style="color: #a020f0;">in</span> others:
                    <span style="color: #a0522d;">states</span>[other.state] += 1

                <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'+'</span> * 30)
                <span style="color: #483d8b;">print</span>(states, <span style="color: #483d8b;">len</span>(others))
                <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'+'</span> * 30)
                <span style="color: #a020f0;">if</span> states[STATE_FAILED] &gt; 0:
                    track.pipeline.<span style="color: #a0522d;">state</span> = STATE_FAILED
                <span style="color: #a020f0;">elif</span> states[STATE_SUCCEED] == <span style="color: #483d8b;">len</span>(others):  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38500;&#20102;&#23427;&#20043;&#22806;&#20840;&#26159;&#25104;&#21151;&#35828;&#26126;&#20840;&#37096;&#25104;&#21151;
</span>                    track.pipeline.<span style="color: #a0522d;">state</span> = STATE_FINISHED

                <span style="color: #a020f0;">else</span>:  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36824;&#26377;&#33410;&#28857;&#27809;&#26377;&#20570;&#23436;&#65292;&#21028;&#26029;&#33258;&#24049;&#26377;&#27809;&#26377;&#19979;&#19968;&#32423;
</span>                    <span style="color: #b22222;"># </span><span style="color: #b22222;">heads = db.session.query(Edge.head).filter(Edge.tail == track.v_id).all()
</span>                    <span style="color: #b22222;"># </span><span style="color: #b22222;">if len(heads) == 0:
</span>                    <span style="color: #b22222;">#     </span><span style="color: #b22222;">pass # &#20160;&#20040;&#37117;&#19981;&#20570;&#65292;&#22240;&#20026;&#20320;&#27809;&#19979;&#19968;&#32423;&#65292;&#23601;&#26159;&#20854;&#20013;&#19968;&#20010;&#20808;&#20570;&#23436;&#30340;&#32456;&#28857;
</span>                    <span style="color: #b22222;"># </span><span style="color: #b22222;">else:
</span>                    <span style="color: #a0522d;">query</span> = db.session.query(Edge).<span style="color: #483d8b;">filter</span>(Edge.g_id == track.pipeline.g_id)

                    <span style="color: #a0522d;">t2h</span> = defaultdict(<span style="color: #483d8b;">list</span>)
                    <span style="color: #a0522d;">h2t</span> = defaultdict(<span style="color: #483d8b;">list</span>)

                    <span style="color: #a020f0;">for</span> e <span style="color: #a020f0;">in</span> query:
                        t2h[e.tail].append(e.head)
                        h2t[e.head].append(e.tail)

                    <span style="color: #a020f0;">if</span> track.v_id <span style="color: #a020f0;">in</span> t2h.keys():
                        <span style="color: #a0522d;">nexts</span> = t2h[track.v_id]
                        <span style="color: #a020f0;">for</span> n <span style="color: #a020f0;">in</span> nexts:
                            <span style="color: #a0522d;">tails</span> = h2t[n]  <span style="color: #b22222;"># </span><span style="color: #b22222;">n pending &#26465;&#20214;&#26159;tails&#25152;&#26377;&#29366;&#24577;&#37117;&#24517;&#39035;&#26159;&#25104;&#21151;
</span>                            <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32479;&#35745;tails&#26159;&#21542;&#37117;&#26159;&#25104;&#21151;&#30340;&#65292;&#21487;&#20197;pending,
</span>                            <span style="color: #b22222;"># </span><span style="color: #b22222;">select count(state) from track where track.v_id in (1,2,4)
</span>                            <span style="color: #b22222;"># </span><span style="color: #b22222;">and track.state = STATE_SUCCEED  and pid
</span>                            <span style="color: #a0522d;">s_count</span> = db.session.query(Track).<span style="color: #483d8b;">filter</span>(Track.p_id == track.p_id) \
                                .<span style="color: #483d8b;">filter</span>(Track.v_id.in_(tails)) \
                                .<span style="color: #483d8b;">filter</span>(Track.state == STATE_SUCCEED).count()
                            <span style="color: #a020f0;">if</span> s_count == <span style="color: #483d8b;">len</span>(tails):
                                <span style="color: #b22222;"># </span><span style="color: #b22222;">pending
</span>                                <span style="color: #a0522d;">nx</span> = db.session.query(Track).<span style="color: #483d8b;">filter</span>(Track.v_id == n).one()
                                nx.<span style="color: #a0522d;">state</span> = STATE_PENDING
                                db.session.add(nx)
                            <span style="color: #a020f0;">else</span>:
                                <span style="color: #a020f0;">pass</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20160;&#20040;&#37117;&#19981;&#20570;
</span>
                    <span style="color: #a020f0;">else</span>:
                        <span style="color: #a020f0;">pass</span>  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20160;&#20040;&#37117;&#19981;&#20570;&#65292;&#22240;&#20026;&#20320;&#27809;&#19979;&#19968;&#32423;&#65292;&#23601;&#26159;&#20854;&#20013;&#19968;&#20010;&#20808;&#20570;&#23436;&#30340;&#32456;&#28857;
</span>
            db.session.add(track)
            <span style="color: #a020f0;">try</span>:
                db.session.commit()
            <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
                db.session.rollback()
                <span style="color: #a020f0;">raise</span> e

<span style="color: #a0522d;">EXECUTOR</span> = Executor()  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20840;&#23616;&#20219;&#21153;&#25191;&#34892;&#22120;&#23545;&#35937;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e628461b-fa3e-4462-b0a0-a90e055883a4" class="outline-5">
<h5 id="h:e628461b-fa3e-4462-b0a0-a90e055883a4">app.py</h5>
<div class="outline-text-5" id="text-h:e628461b-fa3e-4462-b0a0-a90e055883a4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> json
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">import</span> simplejson
<span style="color: #a020f0;">from</span> pipeline.service <span style="color: #a020f0;">import</span> Graph, db, finish_script, finish_params
<span style="color: #a020f0;">from</span> pipeline.service <span style="color: #a020f0;">import</span> create_graph, add_vertex, add_edge, check_graph
<span style="color: #a020f0;">from</span> pipeline.service <span style="color: #a020f0;">import</span> start, show_pipeline
<span style="color: #a020f0;">from</span> pipeline.executor <span style="color: #a020f0;">import</span> EXECUTOR

db.drop_all()
db.create_all()

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#30001;&#20110;&#23558;script&#26684;&#24335;&#26356;&#25913;&#20102;&#65292;&#25152;&#20197;&#37325;&#26032;&#25552;&#20379;&#35813;&#20989;&#25968;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#27979;&#35797;&#25968;&#25454;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#30001;&#20110;&#23558;script&#26684;&#24335;&#26356;&#25913;&#20102;&#65292;&#25152;&#20197;&#37325;&#26032;&#25552;&#20379;&#35813;&#20989;&#25968;
</span><span style="color: #b22222;"># </span><span style="color: #b22222;">&#27979;&#35797;&#25968;&#25454;
</span><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">test_create_dag</span>():
    <span style="color: #a020f0;">try</span>:
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22270;1 &#21019;&#24314;DAG
</span>        <span style="color: #a0522d;">g</span> = create_graph(<span style="color: #8b2252;">'test1'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25104;&#21151;&#21017;&#36820;&#22238;&#19968;&#20010;Graph&#23545;&#35937;
</span>        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#39030;&#28857;
</span>        <span style="color: #483d8b;">input</span> = {
            <span style="color: #8b2252;">"ip"</span>: {
                <span style="color: #8b2252;">"type"</span>: <span style="color: #8b2252;">"str"</span>,
                <span style="color: #8b2252;">"required"</span>: <span style="color: #008b8b;">True</span>,
                <span style="color: #8b2252;">"default"</span>: <span style="color: #8b2252;">"127.0.0.1"</span>
            }
        }
        <span style="color: #a0522d;">script</span> = {
            <span style="color: #8b2252;">'script'</span>: <span style="color: #8b2252;">'echo "test1.A"</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">ping {ip}'</span>,
            <span style="color: #8b2252;">'next'</span>: <span style="color: #8b2252;">'B'</span>
        }
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36825;&#37324;&#20026;&#20102;&#35753;&#29992;&#25143;&#26041;&#20415;&#65292;next&#21487;&#20197;&#25509;&#25910;2&#31181;&#31867;&#22411;&#65292;&#25968;&#23383;&#34920;&#31034;&#39030;&#28857;&#30340;id&#65292;&#23383;&#31526;&#20018;&#34920;&#31034;&#21516;&#19968;&#20010;DAG&#20013;&#35813;&#21517;&#31216;&#30340;&#33410;&#28857;&#65292;&#19981;&#33021;&#37325;&#22797;
</span>        <span style="color: #a0522d;">a</span> = add_vertex(g, <span style="color: #8b2252;">'A'</span>, json.dumps(<span style="color: #483d8b;">input</span>), json.dumps(script))  <span style="color: #b22222;"># </span><span style="color: #b22222;">next&#39030;&#28857;&#39564;&#35777;&#21487;&#20197;&#22312;&#23450;&#20041;&#26102;&#65292;&#20063;&#21487;&#20197;&#22312;&#20351;&#29992;&#26102;
</span>        <span style="color: #a0522d;">b</span> = add_vertex(g, <span style="color: #8b2252;">'B'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo B"}'</span>)
        <span style="color: #a0522d;">c</span> = add_vertex(g, <span style="color: #8b2252;">'C'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo C"}'</span>)
        <span style="color: #a0522d;">d</span> = add_vertex(g, <span style="color: #8b2252;">'D'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo D"}'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#36793;
</span>        <span style="color: #a0522d;">ab</span> = add_edge(g, a, b)
        <span style="color: #a0522d;">ac</span> = add_edge(g, a, c)
        <span style="color: #a0522d;">cb</span> = add_edge(g, c, b)
        <span style="color: #a0522d;">bd</span> = add_edge(g, b, d)

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22270;2 &#21019;&#24314;&#29615;&#36335;
</span>        <span style="color: #a0522d;">g</span> = create_graph(<span style="color: #8b2252;">'test2'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29615;&#36335;
</span>        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#39030;&#28857;
</span>        <span style="color: #a0522d;">a</span> = add_vertex(g, <span style="color: #8b2252;">'A'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo A"}'</span>)
        <span style="color: #a0522d;">b</span> = add_vertex(g, <span style="color: #8b2252;">'B'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo B"}'</span>)
        <span style="color: #a0522d;">c</span> = add_vertex(g, <span style="color: #8b2252;">'C'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo C"}'</span>)
        <span style="color: #a0522d;">d</span> = add_vertex(g, <span style="color: #8b2252;">'D'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo D"}'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#36793;, abc&#20043;&#38388;&#30340;&#29615;
</span>        <span style="color: #a0522d;">ba</span> = add_edge(g, b, a)
        <span style="color: #a0522d;">ac</span> = add_edge(g, a, c)
        <span style="color: #a0522d;">cb</span> = add_edge(g, c, b)
        <span style="color: #a0522d;">bd</span> = add_edge(g, b, d)

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22270;3 &#21019;&#24314;DAG
</span>        <span style="color: #a0522d;">g</span> = create_graph(<span style="color: #8b2252;">'test3'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22810;&#20010;&#32456;&#28857;
</span>        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#39030;&#28857;
</span>        <span style="color: #a0522d;">a</span> = add_vertex(g, <span style="color: #8b2252;">'A'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo A"}'</span>)
        <span style="color: #a0522d;">b</span> = add_vertex(g, <span style="color: #8b2252;">'B'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo B"}'</span>)
        <span style="color: #a0522d;">c</span> = add_vertex(g, <span style="color: #8b2252;">'C'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo C"}'</span>)
        <span style="color: #a0522d;">d</span> = add_vertex(g, <span style="color: #8b2252;">'D'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo D"}'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#36793;
</span>        <span style="color: #a0522d;">ba</span> = add_edge(g, b, a)
        <span style="color: #a0522d;">ac</span> = add_edge(g, a, c)
        <span style="color: #a0522d;">bc</span> = add_edge(g, b, c)
        <span style="color: #a0522d;">bd</span> = add_edge(g, b, d)

        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22270;4 &#21019;&#24314;DAG
</span>        <span style="color: #a0522d;">g</span> = create_graph(<span style="color: #8b2252;">'test4'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22810;&#20837;&#21475;
</span>        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#39030;&#28857;
</span>        <span style="color: #a0522d;">a</span> = add_vertex(g, <span style="color: #8b2252;">'A'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo A"}'</span>)
        <span style="color: #a0522d;">b</span> = add_vertex(g, <span style="color: #8b2252;">'B'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo B"}'</span>)
        <span style="color: #a0522d;">c</span> = add_vertex(g, <span style="color: #8b2252;">'C'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo C"}'</span>)
        <span style="color: #a0522d;">d</span> = add_vertex(g, <span style="color: #8b2252;">'D'</span>, <span style="color: #008b8b;">None</span>, <span style="color: #8b2252;">'{"script":"echo D"}'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#36793;
</span>        <span style="color: #a0522d;">ab</span> = add_edge(g, a, b)
        <span style="color: #a0522d;">ac</span> = add_edge(g, a, c)
        <span style="color: #a0522d;">cb</span> = add_edge(g, c, b)
        <span style="color: #a0522d;">db</span> = add_edge(g, d, b)
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        <span style="color: #a020f0;">raise</span> e

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">test_check_all_graph</span>():
    <span style="color: #a0522d;">query</span> = db.session.query(Graph).<span style="color: #483d8b;">filter</span>(Graph.checked == 0).<span style="color: #483d8b;">all</span>()
    <span style="color: #a020f0;">for</span> g <span style="color: #a020f0;">in</span> query:
        <span style="color: #a020f0;">if</span> check_graph(g):
            g.<span style="color: #a0522d;">checked</span> = 1
            db.session.add(g)
    <span style="color: #a020f0;">try</span>:
        db.session.commit()
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'done'</span>)
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
        db.session.rollback()
        <span style="color: #a020f0;">raise</span> e

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27979;&#35797;start
</span><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">test_start</span>():
    <span style="color: #a0522d;">g</span> = Graph()
    g.<span style="color: #483d8b;">id</span> = 1

    <span style="color: #a0522d;">p</span> = start(g, <span style="color: #8b2252;">'&#27969;&#31243;1'</span>)

<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">'__main__'</span>:

    test_create_dag()
    test_check_all_graph()
    test_start()

    <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
        <span style="color: #a0522d;">ps</span> = show_pipeline(1)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#36816;&#34892;&#33410;&#28857;&#21015;&#34920;
</span>        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-&gt;--&gt;----&gt;'</span>, ps)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
        time.sleep(3)

        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'~~~~~~~~~~~~~ sleeping ~~~~~~~~~~~~'</span>)
        <span style="color: #a020f0;">for</span> p_id, p_name, p_state, t_id, v_id, t_state, inp, script <span style="color: #a020f0;">in</span> ps:
            <span style="color: #483d8b;">print</span>(p_id, p_name, p_state, t_id, v_id, t_state, inp, script)

            <span style="color: #a0522d;">d</span> = {}  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22914;&#26524;&#21442;&#25968;&#26159;&#24517;&#39035;&#65292;&#21017;&#20132;&#20114;&#65292;&#35753;&#29992;&#25143;&#25552;&#20132;
</span>            <span style="color: #a020f0;">if</span> inp:
                <span style="color: #a0522d;">inp</span> = simplejson.loads(inp)
                <span style="color: #a020f0;">for</span> k <span style="color: #a020f0;">in</span> inp.keys():
                    <span style="color: #a020f0;">if</span> inp[k].get(<span style="color: #8b2252;">'required1'</span>, <span style="color: #008b8b;">False</span>):
                        <span style="color: #a0522d;">d</span>[k] = <span style="color: #483d8b;">input</span>(<span style="color: #8b2252;">'{}= '</span>.<span style="color: #483d8b;">format</span>(k))
                <span style="color: #483d8b;">print</span>(d)

            <span style="color: #a0522d;">params</span> = finish_params(t_id, d, inp)
            <span style="color: #483d8b;">print</span>(params)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20934;&#22791;&#22909;&#21442;&#25968;
</span>            <span style="color: #483d8b;">print</span>(script, <span style="color: #8b2252;">'+++++++++'</span>)
            <span style="color: #a0522d;">script</span> = finish_script(t_id, script, params)
            <span style="color: #483d8b;">print</span>(script)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25343;&#21040;&#26367;&#25442;&#22909;&#30340;&#33050;&#26412;&#65292;&#20934;&#22791;&#25191;&#34892;
</span>
            EXECUTOR.execute(p_id, t_id, script)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24322;&#27493;&#25191;&#34892;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:98194a90-3116-4724-b601-767dbc39c72f" class="outline-4">
<h4 id="h:98194a90-3116-4724-b601-767dbc39c72f">可视化</h4>
<div class="outline-text-4" id="text-h:98194a90-3116-4724-b601-767dbc39c72f">
<p>
为了给用户提供友好的界面显示效果，在网页往往需要显示出 DAG 的图形。
</p>

<p>
使用 echarts 可以很好的完成这个功能。
</p>

<p>
<a href="https://echarts.apache.org/examples/zh/editor.html?c=graph-simple">https://echarts.apache.org/examples/zh/editor.html?c=graph-simple</a>
</p>

<p>
在线修改例子如下：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">option</span> = {
  title: {
    text: <span style="color: #8b2252;">"DAG &#31616;&#21333;&#31034;&#20363; Echarts"</span>
  },
  tooltip: {},
  animationDurationUpdate: 1500,
  animationEasingUpdate: <span style="color: #8b2252;">"quinticInOut"</span>,
  series: [
    {
      <span style="color: #483d8b;">type</span>: <span style="color: #8b2252;">"graph"</span>,
      layout: <span style="color: #8b2252;">"none"</span>,
      symbolSize: 50,
      roam: true,
      label: {
        normal: {
          show: true
        }
      },
      edgeSymbol: [<span style="color: #8b2252;">"circle"</span>, <span style="color: #8b2252;">"arrow"</span>],
      edgeSymbolSize: [4, 10],
      edgeLabel: {
        normal: {
          textStyle: {
            fontSize: 20
          }
        }
      },
      data: [
        {
          name: <span style="color: #8b2252;">"A"</span>,
          x: 300,
          y: 300
        },
        {
          name: <span style="color: #8b2252;">"B"</span>,
          x: 400,
          y: 300
        },
        {
          name: <span style="color: #8b2252;">"C"</span>,
          x: 330,
          y: 360
        },
        {
          name: <span style="color: #8b2252;">"D"</span>,
          x: 380,
          y: 330
        }
      ],
      // links: [],
      links: [
        {
          source: 0,
          target: 1
        },
        {
          source: 0,
          target: 2
        },
        {
          source: 2,
          target: 1
        },
        {
          source: 1,
          target: 3
        }
      ],
      lineStyle: {
        normal: {
          opacity: 0.9,
          width: 2,
          curveness: 0
        }
      }
    }
  ]
};
</pre>
</div>

<p>
获得效果如下：
</p>


<figure id="org034972a">
<img src="https://www.brinnatt.com/wp-content/uploads/2023/images/dag_30.png" alt="dag_30.png">

</figure>
</div>
<div id="outline-container-h:1349c0be-dbfc-41aa-afae-caa120c51b27" class="outline-5">
<h5 id="h:1349c0be-dbfc-41aa-afae-caa120c51b27">Flask 框架代码实现</h5>
<div class="outline-text-5" id="text-h:1349c0be-dbfc-41aa-afae-caa120c51b27">
<p>
前面写好的项目可以嵌入到 flask 框架中，flask 框架主要负责后端的数据计算，前端可视化可以借用 jQuery 库发起 ajax 调用获取后端数据，然后操作浏览器的 DOM 树。
</p>

<p>
jQuery 相对 Vuejs、Reactjs 来说，要轻量级很多。使用 jQuery 的方法很简单，直接在 <code>html</code> 中引入 jQuery 库，就可以使用 jQuery 语法。
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #a020f0;">!DOCTYPE</span> html&gt;
&lt;<span style="color: #0000ff;">html</span>&gt;
&lt;<span style="color: #0000ff;">head</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">charset</span>=<span style="color: #8b2252;">"utf-8"</span>&gt;
    &lt;<span style="color: #0000ff;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">jQuery Usage</span>&lt;/<span style="color: #0000ff;">title</span>&gt;
    <span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">&#24341;&#20837; jquery</span><span style="color: #b22222;"> --&gt;</span>
    &lt;<span style="color: #0000ff;">script</span> src={{url_for(<span style="color: #8b2252;">'static'</span>, <span style="color: #a0522d;">filename</span>=<span style="color: #8b2252;">"js/jquery-2.1.1.min.js"</span>)}}&gt;&lt;/<span style="color: #0000ff;">script</span>&gt;
&lt;/<span style="color: #0000ff;">head</span>&gt;
</pre>
</div>

<p>
<i>注意：模板中调用 url_for 生成路径，这点很重要，否则访问静态路径会出错（404）。</i>
</p>

<ul class="org-ul">
<li>使用 Flask 微框架</li>

<li>使用 Jinja2 模板技术</li>

<li>使用 JQuery 发起 AJAX 异步调用</li>

<li>使用 ECharts 图表组件</li>

<li>使用 uWSGI 部署</li>
</ul>
</div>
<ul class="org-ul">
<li><a id="h:06b8b879-3e5e-46f0-a199-d447e2d90039"></a>Flask 安装<br>
<div class="outline-text-6" id="text-h:06b8b879-3e5e-46f0-a199-d447e2d90039">
<p>
官网：<a href="https://flask.palletsprojects.com/en/3.0.x/quickstart/">https://flask.palletsprojects.com/en/3.0.x/quickstart/</a>
</p>

<div class="org-src-container">
<pre class="src src-sh">$ pip install flask
</pre>
</div>

<p>
在项目根目录下构建 3 个目录：
</p>

<ul class="org-ul">
<li>web 目录，存放后端代码。</li>

<li>templates 目录，存放模板文件。</li>

<li>static 目录存放 js、css 等静态文件。其下建立 js 目录，放入
jquery、echarts 的 js 文件。</li>
</ul>
</div>
</li>
<li><a id="h:cbd538f9-9b95-4fd4-802f-baec89d70ea3"></a>模板定义<br>
<div class="outline-text-6" id="text-h:cbd538f9-9b95-4fd4-802f-baec89d70ea3">
<p>
准备 4 个模板文件，如下：
</p>

<p>
index.html 首页
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #a020f0;">!DOCTYPE</span> HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd"&gt;
&lt;<span style="color: #0000ff;">html</span> <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
&lt;<span style="color: #0000ff;">head</span>&gt;
    &lt;<span style="color: #0000ff;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#20142;&#22825;&#29983;&#23398;&#38498;</span>&lt;/<span style="color: #0000ff;">title</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">http-equiv</span>=<span style="color: #8b2252;">"Content-Type"</span> <span style="color: #a0522d;">content</span>=<span style="color: #8b2252;">"text/html;charset=utf-8"</span>&gt;
&lt;/<span style="color: #0000ff;">head</span>&gt;
&lt;<span style="color: #0000ff;">body</span>&gt;
&lt;<span style="color: #0000ff;">h2</span>&gt;<span style="font-weight: bold; font-style: italic; text-decoration: underline;">DAG-Flask-JQuery-Ajax-ECharts</span>&lt;/<span style="color: #0000ff;">h2</span>&gt;
&lt;<span style="color: #0000ff;">ul</span>&gt;
    &lt;<span style="color: #0000ff;">li</span>&gt;&lt;<span style="color: #0000ff;">a</span> <span style="color: #a0522d;">href</span>=<span style="color: #8b2252;">"1"</span>&gt;&#22270;&#34920;1&lt;/<span style="color: #0000ff;">a</span>&gt;&lt;/<span style="color: #0000ff;">li</span>&gt;
    &lt;<span style="color: #0000ff;">li</span>&gt;&lt;<span style="color: #0000ff;">a</span> <span style="color: #a0522d;">href</span>=<span style="color: #8b2252;">"2"</span>&gt;&#22270;&#34920;2&lt;/<span style="color: #0000ff;">a</span>&gt;&lt;/<span style="color: #0000ff;">li</span>&gt;
    &lt;<span style="color: #0000ff;">li</span>&gt;&lt;<span style="color: #0000ff;">a</span> <span style="color: #a0522d;">href</span>=<span style="color: #8b2252;">"3"</span>&gt;&#22270;&#34920;3&lt;/<span style="color: #0000ff;">a</span>&gt;&lt;/<span style="color: #0000ff;">li</span>&gt;
&lt;/<span style="color: #0000ff;">ul</span>&gt;
&lt;/<span style="color: #0000ff;">body</span>&gt;
&lt;/<span style="color: #0000ff;">html</span>&gt;
</pre>
</div>

<p>
chart1.html 简单图表：
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #a020f0;">!DOCTYPE</span> html&gt;
&lt;<span style="color: #0000ff;">html</span> <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
&lt;<span style="color: #0000ff;">head</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">charset</span>=<span style="color: #8b2252;">"utf-8"</span>&gt;
    &lt;<span style="color: #0000ff;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">ECharts</span>&lt;/<span style="color: #0000ff;">title</span>&gt;
    <span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">&#24341;&#20837; jquery</span><span style="color: #b22222;"> --&gt;</span>
    &lt;<span style="color: #0000ff;">script</span> src={{url_for(<span style="color: #8b2252;">'static'</span>, <span style="color: #a0522d;">filename</span>=<span style="color: #8b2252;">"js/jquery-2.1.1.min.js"</span> )}}&gt;&lt;/<span style="color: #0000ff;">script</span>&gt;
    <span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">&#24341;&#20837; echarts.js</span><span style="color: #b22222;"> --&gt;</span>
    &lt;<span style="color: #0000ff;">script</span> src={{url_for(<span style="color: #8b2252;">'static'</span>, <span style="color: #a0522d;">filename</span>=<span style="color: #8b2252;">"js/echarts.min.js"</span> )}}&gt;&lt;/<span style="color: #0000ff;">script</span>&gt;
&lt;/<span style="color: #0000ff;">head</span>&gt;
&lt;<span style="color: #0000ff;">body</span>&gt;
<span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">&#20026;ECharts&#20934;&#22791;&#19968;&#20010;&#20855;&#22791;&#22823;&#23567;&#65288;&#23485;&#39640;&#65289;&#30340;Dom</span><span style="color: #b22222;"> --&gt;</span>
&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"main"</span> <span style="color: #a0522d;">style</span>=<span style="color: #8b2252;">"width: 600px;height:400px;"</span>&gt;&lt;/<span style="color: #0000ff;">div</span>&gt;
&lt;<span style="color: #0000ff;">script</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text/javascript"</span>&gt;
    // &#22522;&#20110;&#20934;&#22791;&#22909;&#30340;dom&#65292;&#21021;&#22987;&#21270;echarts&#23454;&#20363;
    var myChart = echarts.init(document.getElementById('main'));
    // JQuery Ajax&#35843;&#29992;
    $.get('/dag/1', function (data) {
        console.log(data);
        // &#25351;&#23450;&#22270;&#34920;&#30340;&#37197;&#32622;&#39033;&#21644;&#25968;&#25454;
        var option = {
            title: {
                text: 'ECharts &#20837;&#38376;&#31034;&#20363;'
            },
            tooltip: {},
            legend: { // &#22270;&#20363;
                data: ['&#38144;&#37327;', '&#20135;&#37327;']
            },
            xAxis: { // x&#36724;
                data: data.xs
            },
            yAxis: {type: 'value'}, // Y&#36724;
            series: [{ // &#25968;&#25454;&#25968;&#25454;
                name: '&#20135;&#37327;',
                type: 'bar',
                data: data.data
            },
                {
                    name: '&#38144;&#37327;',
                    type: 'bar',
                    data: data.data.map(x =&gt; x + parseInt(Math.random() * 10 - 5))
                }]
        };
        // &#20351;&#29992;&#21018;&#25351;&#23450;&#30340;&#37197;&#32622;&#39033;&#21644;&#25968;&#25454;&#26174;&#31034;&#22270;&#34920;
        myChart.setOption(option);
    })
&lt;/<span style="color: #0000ff;">script</span>&gt;
&lt;/<span style="color: #0000ff;">body</span>&gt;
&lt;/<span style="color: #0000ff;">html</span>&gt;
</pre>
</div>

<p>
注意：模板中调用 url_for 生成路径，这点很重要，否则访问静态路径会出错（404）。
</p>

<p>
chart2.html DAG 图表（ JQuery AJAX ）：
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #a020f0;">!DOCTYPE</span> html&gt;
&lt;<span style="color: #0000ff;">html</span> <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
&lt;<span style="color: #0000ff;">head</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">charset</span>=<span style="color: #8b2252;">"utf-8"</span>&gt;
    &lt;<span style="color: #0000ff;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">ECharts</span>&lt;/<span style="color: #0000ff;">title</span>&gt;
    <span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">&#24341;&#20837; jquery</span><span style="color: #b22222;"> --&gt;</span>
    &lt;<span style="color: #0000ff;">script</span> src={{url_for(<span style="color: #8b2252;">'static'</span>, <span style="color: #a0522d;">filename</span>=<span style="color: #8b2252;">"js/jquery-2.1.1.min.js"</span> )}}&gt;&lt;/<span style="color: #0000ff;">script</span>&gt;
    <span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">&#24341;&#20837; echarts.js</span><span style="color: #b22222;"> --&gt;</span>
    &lt;<span style="color: #0000ff;">script</span> src={{url_for(<span style="color: #8b2252;">'static'</span>, <span style="color: #a0522d;">filename</span>=<span style="color: #8b2252;">"js/echarts.min.js"</span> )}}&gt;&lt;/<span style="color: #0000ff;">script</span>&gt;
&lt;/<span style="color: #0000ff;">head</span>&gt;
&lt;<span style="color: #0000ff;">body</span>&gt;
<span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">&#20026;ECharts&#20934;&#22791;&#19968;&#20010;&#20855;&#22791;&#22823;&#23567;&#65288;&#23485;&#39640;&#65289;&#30340;Dom</span><span style="color: #b22222;"> --&gt;</span>
&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"main"</span> <span style="color: #a0522d;">style</span>=<span style="color: #8b2252;">"width: 600px;height:400px;"</span>&gt;&lt;/<span style="color: #0000ff;">div</span>&gt;
&lt;<span style="color: #0000ff;">script</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text/javascript"</span>&gt;
    // &#22522;&#20110;&#20934;&#22791;&#22909;&#30340;dom&#65292;&#21021;&#22987;&#21270;echarts&#23454;&#20363;
    var myChart = echarts.init(document.getElementById('main'));
    $.get('/dag/2', function (data) {
        console.log(data);
        // &#25351;&#23450;&#22270;&#34920;&#30340;&#37197;&#32622;&#39033;&#21644;&#25968;&#25454;
        option = {
            title: {
                text: 'DAG &#31616;&#21333;&#31034;&#20363; Echarts'
            },
            tooltip: {},
            animationDurationUpdate: 1500,
            animationEasingUpdate: 'quinticInOut',
            series: [
                {
                    type: 'graph',
                    layout: 'none',
                    symbolSize: 50,
                    roam: true,
                    label: {
                        normal: {
                            show: true
                        }
                    },
                    edgeSymbol: ['circle', 'arrow'],
                    edgeSymbolSize: [4, 10],
                    edgeLabel: {
                        normal: {
                            textStyle: {
                                fontSize: 20
                            }
                        }
                    },
                    data: data.data,
                    // links: [],
                    links: data.links,
                    lineStyle: {
                        normal: {
                            opacity: 0.9,
                            width: 2,
                            curveness: 0
                        }
                    },
                    tooltip: { // &#25552;&#31034;&#26694;&#65292;&#40736;&#26631;&#25918;&#22312;&#33410;&#28857;&#25110;&#36793;&#19978;&#35797;&#19968;&#35797;
                        formatter: "{b}&lt;<span style="color: #0000ff;">br</span> /&gt;{c}", // {b}&#34920;&#31034;&#31867;&#30446;&#65292;{c}&#34920;&#31034;&#25968;&#20540;
                        backgroundColor: "#000000" //&#32972;&#26223;&#33394;
                    }
                }
            ]
        };
        // &#20351;&#29992;&#21018;&#25351;&#23450;&#30340;&#37197;&#32622;&#39033;&#21644;&#25968;&#25454;&#26174;&#31034;&#22270;&#34920;
        myChart.setOption(option);
    })
&lt;/<span style="color: #0000ff;">script</span>&gt;
&lt;/<span style="color: #0000ff;">body</span>&gt;
&lt;/<span style="color: #0000ff;">html</span>&gt;
</pre>
</div>

<p>
chart3.html DAG 图表（ JQuery AJAX ）：
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #a020f0;">!DOCTYPE</span> html&gt;
&lt;<span style="color: #0000ff;">html</span> <span style="color: #a0522d;">lang</span>=<span style="color: #8b2252;">"en"</span>&gt;
&lt;<span style="color: #0000ff;">head</span>&gt;
    &lt;<span style="color: #0000ff;">meta</span> <span style="color: #a0522d;">charset</span>=<span style="color: #8b2252;">"utf-8"</span>&gt;
    &lt;<span style="color: #0000ff;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">ECharts</span>&lt;/<span style="color: #0000ff;">title</span>&gt;
    <span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">&#24341;&#20837; jquery</span><span style="color: #b22222;"> --&gt;</span>
    &lt;<span style="color: #0000ff;">script</span> src={{url_for(<span style="color: #8b2252;">'static'</span>, <span style="color: #a0522d;">filename</span>=<span style="color: #8b2252;">"js/jquery-2.1.1.min.js"</span> )}}&gt;&lt;/<span style="color: #0000ff;">script</span>&gt;
    <span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">&#24341;&#20837; echarts.js</span><span style="color: #b22222;"> --&gt;</span>
    &lt;<span style="color: #0000ff;">script</span> src={{url_for(<span style="color: #8b2252;">'static'</span>, <span style="color: #a0522d;">filename</span>=<span style="color: #8b2252;">"js/echarts.min.js"</span> )}}&gt;&lt;/<span style="color: #0000ff;">script</span>&gt;
&lt;/<span style="color: #0000ff;">head</span>&gt;
&lt;<span style="color: #0000ff;">body</span>&gt;
<span style="color: #b22222;">&lt;!-- </span><span style="color: #b22222;">&#20026;ECharts&#20934;&#22791;&#19968;&#20010;&#20855;&#22791;&#22823;&#23567;&#65288;&#23485;&#39640;&#65289;&#30340;Dom</span><span style="color: #b22222;"> --&gt;</span>
&lt;<span style="color: #0000ff;">div</span> <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">"main"</span> <span style="color: #a0522d;">style</span>=<span style="color: #8b2252;">"width: 600px;height:400px;"</span>&gt;&lt;/<span style="color: #0000ff;">div</span>&gt;
&lt;<span style="color: #0000ff;">script</span> <span style="color: #a0522d;">type</span>=<span style="color: #8b2252;">"text/javascript"</span>&gt;
    // &#22522;&#20110;&#20934;&#22791;&#22909;&#30340;dom&#65292;&#21021;&#22987;&#21270;echarts&#23454;&#20363;
    var myChart = echarts.init(document.getElementById('main'));
    $.get('/dag/3', function (data) {
        console.log(data);
        myChart.hideLoading();
        // &#25351;&#23450;&#22270;&#34920;&#30340;&#37197;&#32622;&#39033;&#21644;&#25968;&#25454;
        option = {
            title: {
                text: data.title
            },
            tooltip: {trigger: 'item'},
            animationDurationUpdate: 1500,
            animationEasingUpdate: 'quinticInOut',
            series: [
                {
                    type: 'graph',
                    layout: 'none',
                    symbolSize: 50,
                    roam: true,
                    label: {
                        normal: {
                            show: true
                        }
                    },
                    edgeSymbol: ['circle', 'arrow'],
                    edgeSymbolSize: [4, 10],
                    edgeLabel: {
                        normal: {
                            textStyle: {
                                fontSize: 20
                            }
                        }
                    },
                    data: data.data,
                    // links: [],
                    links: data.links,
                    lineStyle: {
                        show: false,
                        normal: {
                            opacity: 0.9,
                            width: 2,
                            curveness: 0
                        }
                    },
                    tooltip: { // &#25552;&#31034;&#26694;&#65292;&#40736;&#26631;&#25918;&#22312;&#33410;&#28857;&#25110;&#36793;&#19978;&#35797;&#19968;&#35797;
                        // &#20351;&#29992;&#20989;&#25968;&#37325;&#26032;&#23450;&#20041;&#26174;&#31034;&#25991;&#23383;&#30340;&#26684;&#24335;&#65292;&#22238;&#35843;&#36865;&#20837;3&#20010;&#21442;&#25968;
                        formatter: function (params, ticket, callback) {
                            if (params.dataType === 'edge') // &#36830;&#32447;&#27809;&#26377;&#20540;&#36820;&#22238;&#31354;&#20018;
                                return '';
                            if (params.value)
                                return params.name + '&lt;<span style="color: #0000ff;">br</span> /&gt;' + params.value
                            return params.name
                        }
                        //, backgroundColor: "#000000"
                    }
                }
            ]
        };
        // &#20351;&#29992;&#21018;&#25351;&#23450;&#30340;&#37197;&#32622;&#39033;&#21644;&#25968;&#25454;&#26174;&#31034;&#22270;&#34920;
        myChart.setOption(option);
        // &#36941;&#21382;&#25968;&#25454;
        echarts.util.map(data.data, function (item, dataIndex) {
            console.log(item);
            console.log(dataIndex);
        });
        // &#40736;&#26631;&#20107;&#20214;&#65292;click&#28857;&#20987;
        myChart.on('mouseover', function (item) {
            console.log(item);
            if (item.value) {
                console.log(item.value)
            }
        });
    });
&lt;/<span style="color: #0000ff;">script</span>&gt;
&lt;/<span style="color: #0000ff;">body</span>&gt;
&lt;/<span style="color: #0000ff;">html</span>&gt;
</pre>
</div>

<p>
服务端代码实现，创建应用 app：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">web/__init__.py&#20013;
</span><span style="color: #a020f0;">from</span> flask <span style="color: #a020f0;">import</span> Flask, make_response, render_template, jsonify
<span style="color: #a020f0;">from</span> web.service <span style="color: #a020f0;">import</span> getdag

<span style="color: #a0522d;">app</span> = Flask(<span style="color: #8b2252;">'pipeline_web'</span>)

<span style="color: #228b22;">@app.route</span>(<span style="color: #8b2252;">'/'</span>, methods=[<span style="color: #8b2252;">'GET'</span>])  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36335;&#30001;&#65292;&#21487;&#20197;&#25351;&#23450;&#26041;&#27861;&#21015;&#34920;&#65292;&#32570;&#30465;GET
</span><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">index</span>():  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35270;&#22270;&#20989;&#25968;
</span>    <span style="color: #a020f0;">return</span> render_template(<span style="color: #8b2252;">'index.html'</span>)

<span style="color: #228b22;">@app.route</span>(<span style="color: #8b2252;">'/&lt;int:graphid&gt;'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">index.html&#20013;&#35775;&#38382;&#19981;&#21516;&#30340;&#27169;&#26495;&#39029;
</span><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">showdag</span>(graphid):
    <span style="color: #a020f0;">return</span> render_template(<span style="color: #8b2252;">'chart{}.html'</span>.<span style="color: #483d8b;">format</span>(graphid))

<span style="color: #228b22;">@app.route</span>(<span style="color: #8b2252;">'/dag/&lt;int:graphid&gt;'</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">(rule, **options)
</span><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">showajaxdag</span>(graphid):
    <span style="color: #a020f0;">if</span> graphid == 1:
        <span style="color: #a020f0;">return</span> simplegraph()
    <span style="color: #a020f0;">elif</span> graphid == 2:
        <span style="color: #a020f0;">return</span> jsonify(getdag(1))
    <span style="color: #a020f0;">elif</span> graphid == 3:
        <span style="color: #a020f0;">return</span> jsonify(getdag(1))

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">simplegraph</span>():
    <span style="color: #a0522d;">xs</span> = [<span style="color: #8b2252;">"&#34924;&#34923;"</span>, <span style="color: #8b2252;">"&#32650;&#27611;&#34923;"</span>, <span style="color: #8b2252;">"&#38634;&#32442;&#34923;"</span>, <span style="color: #8b2252;">"&#35044;&#23376;"</span>, <span style="color: #8b2252;">"&#39640;&#36319;&#38795;"</span>, <span style="color: #8b2252;">"&#34972;&#23376;"</span>]
    <span style="color: #a0522d;">data</span> = [5, 20, 36, 10, 10, 20]
    <span style="color: #a020f0;">return</span> jsonify({<span style="color: #8b2252;">'xs'</span>: xs, <span style="color: #8b2252;">'data'</span>: data})
</pre>
</div>

<p>
在项目根目录创建测试文件：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160;&#27979;&#35797;&#24212;&#29992;
</span><span style="color: #a020f0;">from</span> web <span style="color: #a020f0;">import</span> app

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160;&#27979;&#35797;&#24212;&#29992;
</span><span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">'__main__'</span>:
    app.run(host=<span style="color: #8b2252;">'0.0.0.0'</span>, port=5000)
</pre>
</div>

<p>
模板一旦被调用，返回的 HTML 页面会立即发起 AJAX 调用，请求 DAG 数据，视图函数会向 Service 层请求数据。
</p>

<p>
从 pipeline 中复制 config.py、model.py 到 web 目录下。
</p>

<p>
在 web 包下创建 service.py 文件。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> .model <span style="color: #a020f0;">import</span> db, Pipeline, Track, Vertex, Edge
<span style="color: #a020f0;">import</span> random

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">randomxy</span>():
    <span style="color: #a020f0;">return</span> random.randint(300, 500)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38543;&#26426;&#27169;&#20223; x y&#22352;&#26631;
</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">getdag</span>(p_id):  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26681;&#25454;pipeline&#30340;id&#36820;&#22238;&#27969;&#31243;&#25968;&#25454;&#65292;&#35753;&#21069;&#31471;&#39029;&#38754;&#32472;&#21046;DAG&#22270;
</span>    <span style="color: #a0522d;">ps</span> = db.session.query(
        Pipeline.<span style="color: #483d8b;">id</span>, Pipeline.name, Pipeline.state,
        Vertex.<span style="color: #483d8b;">id</span>, Vertex.name, Vertex.script,
        Track.script
    ).join(
        Track, (Pipeline.<span style="color: #483d8b;">id</span> == Track.p_id) &amp; (Pipeline.<span style="color: #483d8b;">id</span> == 1)
    ).join(
        Vertex, Vertex.<span style="color: #483d8b;">id</span> == Track.v_id
    )

    <span style="color: #a0522d;">edges</span> = db.session.query(Edge.tail, Edge.head) \
        .join(Pipeline, (Pipeline.g_id == Edge.g_id) &amp; (Pipeline.<span style="color: #483d8b;">id</span> == 1))

    <span style="color: #a0522d;">data</span> = []  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#39030;&#28857;&#25968;&#25454;
</span>    <span style="color: #a0522d;">vertexes</span> = {}  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35753;edges&#26597;&#35810;&#23569;join
</span>    <span style="color: #a0522d;">title</span> = <span style="color: #8b2252;">''</span>
    <span style="color: #a020f0;">for</span> p_id, p_name, p_state, v_id, v_name, v_script, t_script <span style="color: #a020f0;">in</span> ps:
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> title:
            <span style="color: #a0522d;">title</span> = p_name
        data.append(
            {
                <span style="color: #8b2252;">'name'</span>: v_name,
                <span style="color: #8b2252;">'x'</span>: randomxy(),
                <span style="color: #8b2252;">'y'</span>: randomxy(),
                <span style="color: #8b2252;">'value'</span>: t_script <span style="color: #a020f0;">if</span> t_script <span style="color: #a020f0;">else</span> v_script
            }
        )
        <span style="color: #a0522d;">vertexes</span>[v_id] = v_name
    <span style="color: #483d8b;">print</span>(data)

    <span style="color: #a0522d;">links</span> = []  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36793;
</span>    <span style="color: #a020f0;">for</span> tail, head <span style="color: #a020f0;">in</span> edges:
        links.append(
            {
                <span style="color: #8b2252;">'source'</span>: vertexes[tail],
                <span style="color: #8b2252;">'target'</span>: vertexes[head]
            }
        )
    <span style="color: #a020f0;">return</span> {<span style="color: #8b2252;">'title'</span>: title, <span style="color: #8b2252;">'data'</span>: data, <span style="color: #8b2252;">'links'</span>: links}
</pre>
</div>

<p>
启动服务，看看效果。
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:abb99138-5bc5-4e9c-9477-ea6c7e89c50d" class="outline-5">
<h5 id="h:abb99138-5bc5-4e9c-9477-ea6c7e89c50d">uWSGI + Flask 部署</h5>
<div class="outline-text-5" id="text-h:abb99138-5bc5-4e9c-9477-ea6c7e89c50d">
<p>
uwsgi 安装在 Linux 服务器上：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">yum install python-devel
</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#23433;&#35013;pyenv&#34394;&#25311;&#29615;&#22659;&#65292;&#28982;&#21518;&#23433;&#35013;&#20197;&#19979;&#20381;&#36182;&#21253;
</span>$ pip isntall uwsgi flask
$ pip install pymysql sqlalchemy cryptography
</pre>
</div>

<p>
在服务器构建 Python 运行虚拟环境，建立目录，将 templates、static、web 三个目录及文件复制到服务器上该目录下。
</p>

<p>
在 Flask 项目根目录下运行 <code>$ uwsgi --http :8000 -w web:app</code>
</p>

<p>
uwsgi 的配置文件：
</p>

<div class="org-src-container">
<pre class="src src-sh">[uwsgi]
<span style="color: #a0522d;">http</span> = 0.0.0.0:5000
<span style="color: #a0522d;">module</span> = web:app
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">$ uwsgi flask.ini
</pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:e937462d-3d3e-4f85-aa7b-4d3d63f3719c" class="outline-2">
<h2 id="h:e937462d-3d3e-4f85-aa7b-4d3d63f3719c">Python 常见设计模式</h2>
<div class="outline-text-2" id="text-h:e937462d-3d3e-4f85-aa7b-4d3d63f3719c">
<p>
主要内容：
</p>
<ul class="org-ul">
<li>构建模式-单例模式</li>
<li>构建模式-工厂模式</li>
<li>结构模式-Composite(组合)</li>
<li>行为模型-Observer(观察者)</li>
<li>其他编程模式介绍</li>
</ul>
</div>
<div id="outline-container-h:de12d5f3-84c0-4188-896a-b4b6ddedb7b2" class="outline-3">
<h3 id="h:de12d5f3-84c0-4188-896a-b4b6ddedb7b2">singleton单例模式</h3>
<div class="outline-text-3" id="text-h:de12d5f3-84c0-4188-896a-b4b6ddedb7b2">
<p>
一个模块只加载一次，如果在模块设定全局变量为一个实例，看似这个实例是全局唯一，但是不能阻止别人在使用同一个类再次实例化一个实例出来。这不是单例模式。例如logging.root实例，它虽然只有一个，但是不能别人再创建一个RootLogger的实例。
</p>

<p>
<b>单例模式</b>: 一个类只能实例化一次，只能拥有一个实例
</p>
</div>
<div id="outline-container-h:a7a99664-0bd5-40cd-ab12-a19969be23fb" class="outline-4">
<h4 id="h:a7a99664-0bd5-40cd-ab12-a19969be23fb">实例化方法实现</h4>
<div class="outline-text-4" id="text-h:a7a99664-0bd5-40cd-ab12-a19969be23fb">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;1 &#20351;&#29992;__new__
</span><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Singleton</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__new__</span>(cls, *args, **kwargs):
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">hasattr</span>(cls, <span style="color: #8b2252;">'__instance'</span>))
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> <span style="color: #483d8b;">hasattr</span>(cls, <span style="color: #8b2252;">'__instance'</span>):
            <span style="color: #483d8b;">setattr</span>(cls, <span style="color: #8b2252;">'__instance'</span>, <span style="color: #483d8b;">super</span>().__new__(cls))
        <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">getattr</span>(cls, <span style="color: #8b2252;">'__instance'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">A&#23454;&#20363;
</span>
<span style="color: #a0522d;">a</span> = Singleton()
<span style="color: #483d8b;">print</span>(a)
<span style="color: #483d8b;">print</span>(Singleton())
<span style="color: #483d8b;">print</span>(Singleton())
</pre>
</div>

<p>
执行结果
</p>
<div class="org-src-container">
<pre class="src src-sh">D:\project\pyproj\pycharm<span style="color: #8b2252;">\.</span>venv1\Scripts\python.exe D:\project\pyproj\pycharm\t7.py 
False
&lt;__main__.A object at 0x000001DA68581010&gt;
True
&lt;__main__.A object at 0x000001DA68581010&gt;
True
&lt;__main__.A object at 0x000001DA68581010&gt;
</pre>
</div>

<p>
完善展示
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Singleton</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__new__</span>(cls, *args, **kwargs):
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> <span style="color: #483d8b;">hasattr</span>(cls, <span style="color: #8b2252;">'__instance'</span>): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21028;&#26029;&#31867;&#23646;&#24615;&#20013;&#26377;&#27809;&#26377;&#23454;&#20363;
</span>            <span style="color: #483d8b;">setattr</span>(cls, <span style="color: #8b2252;">'__instance'</span>, <span style="color: #483d8b;">super</span>().__new__(cls))
        <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">getattr</span>(cls, <span style="color: #8b2252;">'__instance'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">A&#23454;&#20363;
</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, x):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">x</span> = x

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;{} {}&gt;, id={}"</span>.<span style="color: #483d8b;">format</span>(__class__.<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>.x, <span style="color: #483d8b;">id</span>(<span style="color: #a020f0;">self</span>))

<span style="color: #a0522d;">a</span> = Singleton(1)
<span style="color: #483d8b;">print</span>(a)
<span style="color: #483d8b;">print</span>(Singleton(2))
<span style="color: #483d8b;">print</span>(Singleton(3))
</pre>
</div>

<p>
执行结果
</p>
<div class="org-src-container">
<pre class="src src-sh">D:\project\pyproj\pycharm<span style="color: #8b2252;">\.</span>venv1\Scripts\python.exe D:\project\pyproj\pycharm\t7.py 
&lt;Singleton 1&gt;, <span style="color: #a0522d;">id</span>=1577203470352
&lt;Singleton 2&gt;, <span style="color: #a0522d;">id</span>=1577203470352
&lt;Singleton 3&gt;, <span style="color: #a0522d;">id</span>=1577203470352
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e27dd5cb-295f-4be5-85a6-38efd89a0d65" class="outline-4">
<h4 id="h:e27dd5cb-295f-4be5-85a6-38efd89a0d65">装饰器实现</h4>
<div class="outline-text-4" id="text-h:e27dd5cb-295f-4be5-85a6-38efd89a0d65">
<p>
logger版本改造
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;2 &#20989;&#25968;&#20570;&#35013;&#39280;&#22120;
</span><span style="color: #a020f0;">from</span> functools <span style="color: #a020f0;">import</span> wraps
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">singleton</span>(cls):
    <span style="color: #a0522d;">__instance</span> = <span style="color: #008b8b;">None</span>
    wraps(cls)
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">wrapper</span>(*args, **kwargs):
        <span style="color: #a020f0;">nonlocal</span> __instance
        <span style="color: #a020f0;">if</span> __instance <span style="color: #a020f0;">is</span> <span style="color: #008b8b;">None</span>:
            <span style="color: #a0522d;">__instance</span> = cls(*args, **kwargs)
        <span style="color: #a020f0;">return</span> __instance
    <span style="color: #a020f0;">return</span> wrapper

<span style="color: #228b22;">@singleton</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">A</span>: <span style="color: #b22222;"># </span><span style="color: #b22222;">A = singleton(A) A = wrapper
</span>    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, x):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">x</span> = x

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;{} {}&gt;, id={}"</span>.<span style="color: #483d8b;">format</span>(__class__.<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>.x, <span style="color: #483d8b;">id</span>(<span style="color: #a020f0;">self</span>))

<span style="color: #a0522d;">a</span> = A(1)
<span style="color: #483d8b;">print</span>(a)
<span style="color: #483d8b;">print</span>(A(2))
<span style="color: #483d8b;">print</span>(A(3))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">D:\project\pyproj\pycharm<span style="color: #8b2252;">\.</span>venv1\Scripts\python.exe D:\project\pyproj\pycharm\t7.py 
&lt;A 1&gt;, <span style="color: #a0522d;">id</span>=2452181159952
&lt;A 1&gt;, <span style="color: #a0522d;">id</span>=2452181159952
&lt;A 1&gt;, <span style="color: #a0522d;">id</span>=2452181159952
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0202b479-ca93-4d02-845b-34d04235368d" class="outline-4">
<h4 id="h:0202b479-ca93-4d02-845b-34d04235368d">元编程</h4>
<div class="outline-text-4" id="text-h:0202b479-ca93-4d02-845b-34d04235368d">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;3 &#20803;&#32534;&#31243;
</span><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Singleton</span>(<span style="color: #483d8b;">type</span>):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__new__</span>(cls, name, bases, attrs):
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'new~~~'</span>)
        <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">super</span>().__new__(cls, name, bases, attrs)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__call__</span>(<span style="color: #a020f0;">self</span>, *args, **kwargs):
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'call~~~'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23454;&#20363;&#21270;&#22312;&#36825;&#37324;&#25511;&#21046;
</span>        <span style="color: #483d8b;">print</span>(<span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>)
        <span style="color: #483d8b;">print</span>(args, kwargs)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">A</span>(metaclass=Singleton):
    <span style="color: #a020f0;">pass</span>

<span style="color: #483d8b;">print</span>(A)
A(123)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">D:\project\pyproj\pycharm<span style="color: #8b2252;">\.</span>venv1\Scripts\python.exe D:\project\pyproj\pycharm\t7.py 
new~~~
&lt;class <span style="color: #8b2252;">'__main__.A'</span>&gt;
call~~~
A &lt;class <span style="color: #8b2252;">'__main__.A'</span>&gt;
(123,) {}
</pre>
</div>

<p>
主要用call方法
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26041;&#27861;3 &#20803;&#32534;&#31243;
</span><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Singleton</span>(<span style="color: #483d8b;">type</span>):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__call__</span>(<span style="color: #a020f0;">self</span>, *args, **kwargs):
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'call~~~'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23454;&#20363;&#21270;&#22312;&#36825;&#37324;&#25511;&#21046;
</span>        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(self.__name__, self)
</span>        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(args, kwargs)
</span>        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> <span style="color: #483d8b;">hasattr</span>(<span style="color: #a020f0;">self</span>, <span style="color: #8b2252;">'__instance'</span>):
            <span style="color: #483d8b;">setattr</span>(<span style="color: #a020f0;">self</span>, <span style="color: #8b2252;">'__instance'</span>, <span style="color: #483d8b;">super</span>().__call__(*args, **kwargs))
        <span style="color: #483d8b;">getattr</span>(<span style="color: #a020f0;">self</span>, <span style="color: #8b2252;">'__instance'</span>).__init__(*args, **kwargs)
        <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">getattr</span>(<span style="color: #a020f0;">self</span>, <span style="color: #8b2252;">'__instance'</span>)


<span style="color: #a020f0;">class</span> <span style="color: #228b22;">A</span>(metaclass=Singleton):

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, x):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">x</span> = x

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;{} {}&gt;, id={}"</span>.<span style="color: #483d8b;">format</span>(__class__.<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>.x, <span style="color: #483d8b;">id</span>(<span style="color: #a020f0;">self</span>))

<span style="color: #483d8b;">print</span>(A)
<span style="color: #483d8b;">print</span>(A(123))
<span style="color: #483d8b;">print</span>(A(456))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">D:\project\pyproj\pycharm<span style="color: #8b2252;">\.</span>venv1\Scripts\python.exe D:\project\pyproj\pycharm\t7.py 
&lt;class <span style="color: #8b2252;">'__main__.A'</span>&gt;
call~~~
&lt;A 123&gt;, <span style="color: #a0522d;">id</span>=1993739472912
call~~~
&lt;A 456&gt;, <span style="color: #a0522d;">id</span>=1993739472912
</pre>
</div>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
