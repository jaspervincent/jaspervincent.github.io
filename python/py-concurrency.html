<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Python: Python高并发编程</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Python: Python高并发编程</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:4b7cff18-1ffe-4d0e-8916-2048cea719b9">并发</a>
<ul>
<li><a href="#h:3f5a0c6f-ada5-419f-8a5c-b88b0589dd5c">并发和并行区别</a></li>
<li><a href="#h:d4d26198-5d21-4de1-a346-76be0951c2f1">并发的解决</a></li>
<li><a href="#h:e6ff6761-9525-48c7-8be7-36105a92efa4">1、队列、缓冲区</a></li>
<li><a href="#h:53a4f241-3feb-4720-b4f6-5b83147c6ff6">2、争抢</a></li>
<li><a href="#h:c86d06a7-1014-4bb0-be6f-09e470e3c180">3、预处理</a></li>
<li><a href="#h:8784c5a6-6e22-46d3-8243-f432cff3b9f2">4、并行</a></li>
<li><a href="#h:a3a8cc66-6686-42cc-af85-0c4c016f36cf">5、提速</a></li>
<li><a href="#h:5f7fb109-95eb-4e05-8f29-7df559eef9ef">6、消息中间件</a></li>
</ul>
</li>
<li><a href="#h:b1f85b48-cfde-4f2f-a587-3e03270d747d">queue模块&#x2013;队列</a>
<ul>
<li><a href="#h:3ca3c81b-793f-4246-8ddc-f68b41e13775">Queue</a></li>
<li><a href="#h:6deda1e1-7062-4cc3-93de-655062e54483">LifoQueue</a></li>
<li><a href="#h:7b1be691-775f-4341-b9a3-53730cb8f3cd">PriorityQueue</a></li>
</ul>
</li>
<li><a href="#h:54394495-56ac-49b0-8c9b-9091b8c3f907">线程</a>
<ul>
<li><a href="#h:da5b7806-7a9d-4232-9154-c00fa6dddf77">进程和线程</a>
<ul>
<li><a href="#h:b1200606-8276-4937-b0e2-26aa2af21f70">进程、线程的理解</a></li>
<li><a href="#h:70734629-45fc-4d81-b1f3-b06d9ea3e08d">线程的状态</a></li>
<li><a href="#h:03d53f0a-fbd9-4182-8758-3cd5af8d7d23">Python中的进程和线程</a></li>
</ul>
</li>
<li><a href="#h:d96cf474-80f1-46b2-a0f2-7b293dabf1a7">Python的线程开发</a>
<ul>
<li><a href="#h:0280394c-3e47-46db-a401-e5fa67803d48">Thread类</a>
<ul>
<li><a href="#h:484ab488-8416-48ee-970e-0efa85f0472a">线程启动</a></li>
<li><a href="#h:47d76164-0f32-44e9-9836-0c88eee3b25c">线程退出</a></li>
<li><a href="#h:0815293a-7ab2-4d56-a260-de2fe52a9c57">线程传参</a></li>
<li><a href="#h:a937c085-ab52-4083-a56d-3d8207a56f86">threading的属性和方法</a></li>
<li><a href="#h:fd554e60-2251-46ce-af33-42f12cb87336">Thread实例的属性和方法</a></li>
</ul>
</li>
<li><a href="#h:fe6e5200-c810-4ebc-8944-8f64f954bfb9">多线程</a></li>
<li><a href="#h:17f041eb-2065-4f5a-80c3-e839c2a4564e">daemon线程和non-daemon线程</a></li>
<li><a href="#h:d5d7c611-941c-4e80-83cd-b015c799198f">join方法</a></li>
<li><a href="#h:7470c0eb-377d-4bfb-a9f1-394440264462">daemon线程应用场景</a></li>
</ul>
</li>
<li><a href="#h:1c3888c8-3158-446f-b826-ad6b17d80dc5">threading.local类</a></li>
</ul>
</li>
<li><a href="#h:7858a7f9-54f8-4340-9971-7960bc7b7cbe">线程同步</a>
<ul>
<li><a href="#h:0fc3d129-cb2d-4552-a23f-bc84812e6bb2">概念</a></li>
<li><a href="#h:7559fa45-c9ab-4dcd-86c5-c10f97a87c14">Event***</a>
<ul>
<li><a href="#h:020e5e30-c1e3-4a48-9c2f-b38b5333a142">练习</a></li>
<li><a href="#h:b47efafe-b4bb-436c-a571-aaf31e002259">总结</a></li>
<li><a href="#h:110966fe-7b86-45be-95fb-130b940e0fc3">wait的使用</a></li>
<li><a href="#h:fbd12a9a-6881-4faa-ba4c-10b5e484d399">定时器 Timer/延迟执行</a></li>
</ul>
</li>
<li><a href="#h:3623e19d-a7e2-4cce-b425-aa5f3992cfdc">Lock***</a>
<ul>
<li><a href="#h:6436f3b0-82ed-46c6-97f3-4f14699f8816">练习</a></li>
<li><a href="#h:2a04bc2f-514b-4b3b-8860-23fe5eb650fe">加锁、解锁</a></li>
<li><a href="#h:afacce3f-4f6d-4260-a5b1-1c0bdadbe0a9">锁的应用场景</a></li>
<li><a href="#h:49d04d89-0692-4a32-a23f-be635c989c10">非阻塞锁使用</a></li>
</ul>
</li>
<li><a href="#h:5a518f40-3c35-416e-b452-0a95f2f294ab">可重入锁RLock</a></li>
<li><a href="#h:e8ad5263-5245-49ba-b9e6-2ae97f4dd478">Condition</a></li>
<li><a href="#h:1372e12c-5419-4dad-af6c-a9c7ed2e749d">semaphore信号量</a>
<ul>
<li><a href="#h:d9bff5d6-b452-4bf2-9ec5-9d3aca8c0850">release方法超界问题</a></li>
</ul>
</li>
<li><a href="#h:a29d1497-9ab7-4367-8eda-8473e71c53fe">BoundedSemaphore类</a></li>
<li><a href="#h:55bd30b1-c864-40ac-b076-754adce345b7">应用举例</a></li>
<li><a href="#h:fce456b1-0bca-4620-b27d-04d79f16118f">问题</a>
<ul>
<li><a href="#h:8dbf3134-ac8b-4581-8b66-1dfd6c7017cf">1、边界问题分析</a></li>
<li><a href="#h:4bc251f2-7f15-4404-a5cc-4858c4484545">2、正常使用分析</a></li>
</ul>
</li>
<li><a href="#h:73137cd7-fd42-408e-a4ec-e8fbaaabcf88">信号量和锁</a></li>
<li><a href="#h:bbcab601-a08c-447f-9b11-c44c891cced1">Queue的线程安全</a></li>
</ul>
</li>
<li><a href="#h:eb43234c-dbde-405c-a13c-f0310203a8da">GIL全局解释器锁</a></li>
<li><a href="#h:f4b8b789-b110-477c-bf1e-9abdc639b837">多进程</a>
<ul>
<li><a href="#h:1bd07f42-95dd-4826-bb5f-31e417dbfb1d">多进程</a>
<ul>
<li><a href="#h:46ca9d23-b3ec-4023-aa68-b051d11b7d5d">multiprocessing</a>
<ul>
<li><a href="#h:07b702c2-8bd1-4d00-8584-26e3d8ce39af">Process类</a></li>
</ul>
</li>
<li><a href="#h:3585d1d7-7143-4159-95ab-4a82e32db1d9">进程间同步</a></li>
<li><a href="#h:f49a5ff1-4b19-4fd7-b083-96f58234d4d0">进程池举例</a></li>
<li><a href="#h:990dc2ac-90d9-410c-8c60-d3c3205f0886">多进程、多线程的选择</a>
<ul>
<li><a href="#h:4a230ff1-36bf-42ee-ac3d-1d76e3633b19">应用</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:b21f750f-34a4-409d-8b78-c2ef1591ba41">Linux的特殊进程</a>
<ul>
<li><a href="#h:5be0308a-8e9a-4292-87bc-37dd75458fe6">僵尸进程</a></li>
<li><a href="#h:405524b1-b8da-4cc0-acae-757594a86989">孤儿进程</a></li>
<li><a href="#h:ee05aa27-3ee5-4519-8e42-1ddfc669cf1a">守护进程</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:a205ae9f-e7aa-4e6e-be24-23a387b35140">concurrent包（异步并行任务编程模块）</a>
<ul>
<li><a href="#h:66c691a6-1da9-47c6-8e13-3712e734b9c2">concurrent.futures包</a>
<ul>
<li><a href="#h:5c637564-d745-498f-87ab-74079d5cb582">ThreadPoolExecutor对象</a></li>
<li><a href="#h:33a732a2-b3c8-44d9-9fbd-27f669ffc8f6">ProcessPoolExecutor对象</a></li>
<li><a href="#h:7d9a2214-9d22-4c7e-a28e-2a5882065f7c">支持上下文管理</a></li>
<li><a href="#h:c035ffe3-5512-4681-830a-54af10231f88">总结</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="./index.html">Python</a></li>
</ul>


<p>
Python 多进程与线程高并发编程
</p>

<p>
主要内容：
</p>
<ul class="org-ul">
<li>理解进程与线程</li>
<li>创建多线程</li>
<li>线程的属性</li>
<li>后台线程</li>
<li>事件 Event</li>
<li>线程锁、加锁、解锁策略</li>
<li>可重入锁</li>
<li>Condition 和 生产者消费者模型</li>
<li>信号量通信 Semaphore</li>
<li>创建进程和池</li>
<li>僵尸进程、孤儿进程和守护进程</li>
<li>高级线程池、进程池异步库</li>
<li>GIL全局解释器锁原理</li>
<li>多进程、多线程应用场景</li>
</ul>
<section id="outline-container-h:4b7cff18-1ffe-4d0e-8916-2048cea719b9" class="outline-2">
<h2 id="h:4b7cff18-1ffe-4d0e-8916-2048cea719b9">并发</h2>
<div class="outline-text-2" id="text-h:4b7cff18-1ffe-4d0e-8916-2048cea719b9">
</div>
<div id="outline-container-h:3f5a0c6f-ada5-419f-8a5c-b88b0589dd5c" class="outline-3">
<h3 id="h:3f5a0c6f-ada5-419f-8a5c-b88b0589dd5c">并发和并行区别</h3>
<div class="outline-text-3" id="text-h:3f5a0c6f-ada5-419f-8a5c-b88b0589dd5c">
<p>
并行，parallel
</p>
<ul class="org-ul">
<li>同时做某些事，可以互不干扰的同一个时刻做几件事</li>
</ul>

<p>
并发，concurrency
</p>
<ul class="org-ul">
<li>也是同时做某些事，但是强调，一个时段内有事情要处理。</li>
</ul>

<p>
举例
</p>
<ul class="org-ul">
<li>高速公路的车道，双向4车道，所有车辆（数据）可以互不干扰的在自己的车道上奔跑（传输）</li>
<li>在同一个时刻，每条车道上可能同时有车辆在跑，是同时发生的概念，这是并行</li>
<li>在一段时间内，有这么多车要通过，这是并发</li>
</ul>
</div>
</div>
<div id="outline-container-h:d4d26198-5d21-4de1-a346-76be0951c2f1" class="outline-3">
<h3 id="h:d4d26198-5d21-4de1-a346-76be0951c2f1">并发的解决</h3>
<div class="outline-text-3" id="text-h:d4d26198-5d21-4de1-a346-76be0951c2f1">
<p>
<b>"食堂打饭模型"</b>
</p>

<p>
中午12点，开饭啦，大家都涌向食堂，这就是并发。如果人很多，就是高并发
</p>

<p>
某个时间段内，数据涌来，这就是并发。如果数据量很大，就是 <b>高并发</b>
</p>
</div>
</div>
<div id="outline-container-h:e6ff6761-9525-48c7-8be7-36105a92efa4" class="outline-3">
<h3 id="h:e6ff6761-9525-48c7-8be7-36105a92efa4">1、队列、缓冲区</h3>
<div class="outline-text-3" id="text-h:e6ff6761-9525-48c7-8be7-36105a92efa4">
<p>
假设只有一个窗口，陆续涌入食堂的人，排队打菜是比较好的方式。所以，排队（队列）是一种天然解决并发的办法。
</p>

<p>
排队就是把人排成 队列，先进先出，解决了资源使用的问题。排成的队列，其实就是一个缓冲地带，就是 <b>缓冲区</b>
</p>

<p>
假设女生优先，每次都从这个队伍中优先选出女生出来先打饭，这就是 优先队列
</p>

<p>
例如queue模块的类Queue、LifoQueue、PriorityQueue（小顶堆实现）
</p>
</div>
</div>
<div id="outline-container-h:53a4f241-3feb-4720-b4f6-5b83147c6ff6" class="outline-3">
<h3 id="h:53a4f241-3feb-4720-b4f6-5b83147c6ff6">2、争抢</h3>
<div class="outline-text-3" id="text-h:53a4f241-3feb-4720-b4f6-5b83147c6ff6">
<p>
只开一个窗口，有可能没有秩序，也就是谁挤进去就给谁打饭。
</p>

<p>
挤到窗口的人占据窗口，直到打到饭菜离开。
</p>

<p>
其他人继续争抢，会有一个人占据着窗口，可以视为锁定窗口，窗口就不能为其他人提供服务了。这是一种 <b>锁机制</b> 。
</p>

<p>
谁抢到资源就上锁，排他性的锁，其他人只能等候。
</p>

<p>
争抢也是一种高并发解决方案，但是，这样可能不好，因为有可能有人很长时间抢不到。
</p>
</div>
</div>
<div id="outline-container-h:c86d06a7-1014-4bb0-be6f-09e470e3c180" class="outline-3">
<h3 id="h:c86d06a7-1014-4bb0-be6f-09e470e3c180">3、预处理</h3>
<div class="outline-text-3" id="text-h:c86d06a7-1014-4bb0-be6f-09e470e3c180">
<p>
其实排队长不是问题，就算2万人排成一队等吃饭，如果能10分钟搞定也行。问题就是在处理并发的速度太慢了。
</p>

<p>
经过分析发现，本食堂主要是打菜等候时间矿长，因为每个人都是现场点菜现做。
</p>

<p>
食堂可以提前统计大多数人最爱吃的菜品，将最爱吃的80%的热门菜，提前做好，保证供应，20%的冷门菜，现做。
</p>

<p>
这样大多数人，就算锁定窗口，也很快打到饭菜走了，快速释放窗口。
</p>

<p>
一种提前加载用户需要的数据的思路， <b>预处理</b> 思想，缓存常用。
</p>
</div>
</div>
<div id="outline-container-h:8784c5a6-6e22-46d3-8243-f432cff3b9f2" class="outline-3">
<h3 id="h:8784c5a6-6e22-46d3-8243-f432cff3b9f2">4、并行</h3>
<div class="outline-text-3" id="text-h:8784c5a6-6e22-46d3-8243-f432cff3b9f2">
<p>
成百上千人同时来吃饭，一个队伍搞不定的，多开打饭窗口形成多个队列，如同开多个车道一样，并行打菜。
</p>

<p>
开窗口就得扩大食堂，得多雇人在每一个窗口提供服务，造成 <b>成本上升</b> 。就高速公路一样，多车道是并行
方案，多车道提高了通行效率，但是也意味着建造维护成本也高了。
</p>

<p>
日常可以通过购买更多服务器，或多开进程、线程实现并行处理，来解决并发问题。
</p>

<p>
注意这些都是 <b>水平扩展</b> 思想。
</p>

<p>
并行是解决并发的手段之一。
</p>

<p>
注：
</p>
<ul class="org-ul">
<li>如果线程在单CPU上处理，就不是真并行了</li>
<li>但是多数服务器都是多CPU的，服务的部署往往是多机的、分布式的，这都是并行处理</li>
</ul>
</div>
</div>
<div id="outline-container-h:a3a8cc66-6686-42cc-af85-0c4c016f36cf" class="outline-3">
<h3 id="h:a3a8cc66-6686-42cc-af85-0c4c016f36cf">5、提速</h3>
<div class="outline-text-3" id="text-h:a3a8cc66-6686-42cc-af85-0c4c016f36cf">
<p>
提高单个窗口的打饭速度，也是解决并发的方式。
</p>

<p>
打饭人员提高工作技能，或为单个窗口配备更多的服务人员，都是提速的办法。
</p>

<p>
提高单个CPU性能，或单个服务器安装更多的CPU。
</p>

<p>
这是一种 <b>垂直扩展</b> 思想
</p>
</div>
</div>
<div id="outline-container-h:5f7fb109-95eb-4e05-8f29-7df559eef9ef" class="outline-3">
<h3 id="h:5f7fb109-95eb-4e05-8f29-7df559eef9ef">6、消息中间件</h3>
<div class="outline-text-3" id="text-h:5f7fb109-95eb-4e05-8f29-7df559eef9ef">
<p>
常见的消息中间件有RabbitMQ、ActiveMQ（Apache）、RocketMQ（阿里Apache）、kafka（Apache）等。
</p>

<p>
当然还有其他手段解决并发问题，但是已经列举除了最常用的解决方案，一般来说不同的并发场景用不同的策略，而策略可能是多种方式的优化组合
</p>

<p>
例如多开食堂（多地），也可以把食堂建设到宿舍生活区（就近），所以说，技术来源于生活。
</p>
</div>
</div>
</section>
<section id="outline-container-h:b1f85b48-cfde-4f2f-a587-3e03270d747d" class="outline-2">
<h2 id="h:b1f85b48-cfde-4f2f-a587-3e03270d747d">queue模块&#x2013;队列</h2>
<div class="outline-text-2" id="text-h:b1f85b48-cfde-4f2f-a587-3e03270d747d">
<p>
queue模块的类Queue、LifoQueue、PriorityQueue三个类。
</p>
</div>
<div id="outline-container-h:3ca3c81b-793f-4246-8ddc-f68b41e13775" class="outline-3">
<h3 id="h:3ca3c81b-793f-4246-8ddc-f68b41e13775">Queue</h3>
<div class="outline-text-3" id="text-h:3ca3c81b-793f-4246-8ddc-f68b41e13775">
<p>
Queue是先进先出(first-in first-out)队列。
</p>

<p>
queue.Queue(maxsize=0)
</p>
<ul class="org-ul">
<li>创建FIFO队列，返回Queue对象</li>
<li>maxsize小于等于0，队列长度没有限制</li>
</ul>

<p>
Queue.get(block=True, timeout=None)
</p>
<ul class="org-ul">
<li>从队列中移除元素并返回这个元素</li>
<li>block为阻塞，timeout为超时</li>
<li>如果block为True，就阻塞，timeout为None就是一直阻塞。</li>
<li>如果block为True，但是timeout有值，就阻塞到一定秒数抛出Empty异常</li>
<li>block为False，是非阻塞，timeout将被忽略，要么成功返回一个元素，要么抛出empty异常。</li>
</ul>

<p>
Queue.get_nowait()
</p>
<ul class="org-ul">
<li>等价于get(False)，也就是说要么成功返回一个元素，要么抛出empty异常</li>
<li>但是queue的这种阻塞效果，需要多线程来演示</li>
</ul>

<p>
Queue.put(item, block=True, timeout=None)
</p>
<ul class="org-ul">
<li>把一个元素加入到队列中去</li>
<li>block=True, timeout=None，一直阻塞到有空位放元素</li>
<li>block=True, timeout=5，阻塞5秒就抛出Full异常</li>
<li>block=False, timeout失效，立即返回，能塞进去就塞，不能则返回抛出Full异常。</li>
</ul>

<p>
Queue.put_nowait(item)
</p>
<ul class="org-ul">
<li>等价于put(item, False)，也就是能塞进去就塞，不能则返回抛出Full异常。</li>
</ul>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> queue <span style="color: #a020f0;">import</span> Queue
<span style="color: #a020f0;">import</span> time  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#28155;&#21152;&#23548;&#20837;time&#27169;&#22359;</span>

<span style="color: #a0522d;">q</span> = Queue()
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23614;&#37096;&#21152;&#20837;&#65292;&#22836;&#37096;&#25343;&#36208;</span>
q.put(1)
q.put(2)
q.put(3)

<span style="color: #483d8b;">print</span>(q.get())
<span style="color: #483d8b;">print</span>(q.get())
<span style="color: #b22222;">#</span><span style="color: #b22222;">print(q.empty()) #&#21028;&#26029;&#38431;&#21015;&#26159;&#21542;&#20026;&#31354;&#65292;&#31354;&#36820;&#22238;False, &#38750;&#31354;&#36820;&#22238;True</span>
<span style="color: #483d8b;">print</span>()
time.sleep(1)   
<span style="color: #483d8b;">print</span>(q.get())

<span style="color: #b22222;"># </span><span style="color: #b22222;">print(q.get()) #&#38431;&#21015;&#26377;&#25968;&#25454;&#65292;&#31435;&#21363;&#33719;&#21462;&#65307;&#27809;&#26377;&#25968;&#25454;&#65292;&#40664;&#35748;&#38459;&#22622;&#31561;&#24453;&#12290;&#20351;&#29992;&#22810;&#32447;&#31243;&#35299;&#20915;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(q.get(timeout=5)) #&#31561;&#20102;5s&#65292;&#31354;&#25163;&#32780;&#24402;&#65292;&#25243;&#20986;Empty&#24322;&#24120;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(q.get(False)) #&#25105;&#19981;&#31561;&#65292;&#26377;&#25343;&#36208;&#65292;&#27809;&#26377;&#25968;&#25454;&#25105;&#20063;&#19981;&#31561;&#65292;&#31354;&#25163;&#32780;&#24402;&#65292;&#25243;&#20986;&#24322;&#24120;Empty</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">1</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">3</span>
</pre>
</div>

<p>
队列有数据，立即获取；没有数据，默认阻塞等待。使用多线程解决
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> queue <span style="color: #a020f0;">import</span> Queue
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> threading

<span style="color: #a0522d;">q</span> = Queue()
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23614;&#37096;&#21152;&#20837;&#65292;&#22836;&#37096;&#25343;&#36208;</span>
q.put(1)
q.put(2)
q.put(3)

<span style="color: #483d8b;">print</span>(q.get())
<span style="color: #483d8b;">print</span>(q.get()) 
<span style="color: #483d8b;">print</span>(q.get())

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">put_data</span>():
    time.sleep(5)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'~'</span> * 30)
    q.put(<span style="color: #8b2252;">'test'</span>)

<span style="color: #a0522d;">t</span> = threading.Thread(target=put_data)
t.start() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#32447;&#31243;</span>

<span style="color: #483d8b;">print</span>(q.get()) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38431;&#21015;&#26377;&#25968;&#25454;&#65292;&#31435;&#21363;&#33719;&#21462;&#65307;&#27809;&#26377;&#25968;&#25454;&#65292;&#40664;&#35748;&#38459;&#22622;&#31561;&#24453;&#12290;&#20351;&#29992;&#22810;&#32447;&#31243;&#35299;&#20915;</span>
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">1</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">3</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">test</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">------------------------------</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> queue <span style="color: #a020f0;">import</span> Queue

<span style="color: #a0522d;">q</span> = Queue(5)
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23614;&#37096;&#21152;&#20837;&#65292;&#22836;&#37096;&#25343;&#36208;</span>
q.put(1)
q.put(2)
q.put(3)
q.put(4)
<span style="color: #483d8b;">print</span>(q.full())
q.put(5)
<span style="color: #483d8b;">print</span>(q.full(), q.qsize())
<span style="color: #b22222;"># </span><span style="color: #b22222;">q.put(6) #&#38431;&#21015;&#28385;&#20102;&#65292;&#40664;&#35748;&#27704;&#20037;&#38459;&#22622;&#65292;&#30452;&#21040;&#26377;&#31354;&#38388;&#20026;&#27490;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">q.put(6, True, timeout=3) #&#22914;&#26524;&#26377;&#31354;&#38388;&#65292;&#21152;&#20837;&#65307;&#21542;&#21017;&#31561;3&#31186;&#65292;3&#31186;&#21518;&#21152;&#20837;&#19981;&#25104;&#21151;&#25243;&#24322;&#24120; queue.Full</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">q.put(6, False) #&#33021;&#21152;&#20837;&#23601;&#31435;&#21363;&#21152;&#20837;&#21040;&#38431;&#21015;&#65307;&#22914;&#26524;&#28385;&#20102;&#65292;&#19981;&#31561;&#24453;&#65292;&#25243;Full&#24322;&#24120;</span>
q.put_nowait(6) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31561;&#20215;&#20110;q.put(6, False)</span>

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:6deda1e1-7062-4cc3-93de-655062e54483" class="outline-3">
<h3 id="h:6deda1e1-7062-4cc3-93de-655062e54483">LifoQueue</h3>
<div class="outline-text-3" id="text-h:6deda1e1-7062-4cc3-93de-655062e54483">
<p>
后进先出队列，这个类继承自Queue，使用方式同Queue。
</p>


<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> queue <span style="color: #a020f0;">import</span> Queue, LifoQueue

<span style="color: #a0522d;">q</span> = LifoQueue(5) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37319;&#29992;&#20160;&#20040;&#25968;&#25454;&#32467;&#26500;&#65311; list &#26412;&#36523;&#23601;&#26159;&#26632;&#65292;&#20063;&#21487;&#20197;&#38142;&#34920;&#23454;&#29616;</span>
q.put(1)
q.put(2)
q.put(3)

<span style="color: #483d8b;">print</span>(q.get())
<span style="color: #483d8b;">print</span>(q.get())
<span style="color: #483d8b;">print</span>(q.get())

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">3</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">1</span>
</pre>
</div>

<p>
源码
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">LifoQueue</span>(Queue):
    <span style="color: #8b2252;">'''Variant of Queue that retrieves most recently added entries first.'''</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_init</span>(<span style="color: #a020f0;">self</span>, maxsize):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">queue</span> = []

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_qsize</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">len</span>(<span style="color: #a020f0;">self</span>.queue)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_put</span>(<span style="color: #a020f0;">self</span>, item):
        <span style="color: #a020f0;">self</span>.queue.append(item)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_get</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>.queue.pop()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35206;&#30422;&#20102;Queue&#31867;&#20013;&#30340;&#26041;&#27861;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Queue</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">put</span>(<span style="color: #a020f0;">self</span>, item, block=<span style="color: #008b8b;">True</span>, timeout=<span style="color: #008b8b;">None</span>):
        <span style="color: #a020f0;">with</span> <span style="color: #a020f0;">self</span>.not_full:
            ... ...
            <span style="color: #a020f0;">self</span>._put(item)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_init</span>(<span style="color: #a020f0;">self</span>, maxsize):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">queue</span> = deque() <span style="color: #b22222;">#</span><span style="color: #b22222;">Queue&#20351;&#29992;&#30340;&#26159;&#21452;&#31471;&#38431;&#21015;</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_put</span>(<span style="color: #a020f0;">self</span>, item):
        <span style="color: #a020f0;">self</span>.queue.append(item)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7b1be691-775f-4341-b9a3-53730cb8f3cd" class="outline-3">
<h3 id="h:7b1be691-775f-4341-b9a3-53730cb8f3cd">PriorityQueue</h3>
<div class="outline-text-3" id="text-h:7b1be691-775f-4341-b9a3-53730cb8f3cd">
<p>
优先队列，这个类也继承自Queue类，并重写入队、出队的方法。
</p>
<ul class="org-ul">
<li>它里面是堆，用列表实现的堆，构建的是小顶堆。</li>
<li>元素可以存储任意值，但是优先队列内部是直接进行元素大小比较的，不同类型比较可能抛异常</li>
<li>入队时，将元素加入到列表末尾。然后进行小顶堆调整。</li>
<li>出队时，将索引0即堆顶处最小值弹出，然后将最后一个元素放到堆顶，重新堆调整。</li>
</ul>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> queue <span style="color: #a020f0;">import</span> Queue, LifoQueue, PriorityQueue

<span style="color: #a0522d;">q</span> = PriorityQueue() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23567;&#39030;&#22534;&#65292;&#20803;&#32032;&#24517;&#39035;&#21487;&#20197;&#27604;&#36739;</span>
q.put(1)
q.put(2)
<span style="color: #b22222;"># </span><span style="color: #b22222;">q.put('tom') # &#25253;&#38169;&#65292;TypeError: '&lt;' not supported between instances of 'str' and 'int'</span>

<span style="color: #483d8b;">print</span>(q.get())
<span style="color: #483d8b;">print</span>(q.get())


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">1</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2</span>
</pre>
</div>

<p>
自定义类
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> queue <span style="color: #a020f0;">import</span> Queue, LifoQueue, PriorityQueue

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Student</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, name, gender=<span style="color: #8b2252;">'M'</span>):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">name</span> = name
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">gender</span> = gender

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__eq__</span>(<span style="color: #a020f0;">self</span>, other):
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'__eq__'</span>, <span style="color: #a020f0;">self</span>.name, other.name)
        <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>.name == other.name <span style="color: #a020f0;">and</span> <span style="color: #a020f0;">self</span>.gender == other.gender

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__lt__</span>(<span style="color: #a020f0;">self</span>, other):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print('__lt__', self.name, other.name)</span>
        <span style="color: #a0522d;">s1</span> = <span style="color: #8b2252;">"{}:{}"</span>.<span style="color: #483d8b;">format</span>(<span style="color: #a020f0;">self</span>.gender, <span style="color: #a020f0;">self</span>.name) <span style="color: #b22222;">#</span><span style="color: #b22222;">F:Alice</span>
        <span style="color: #a0522d;">s2</span> = <span style="color: #8b2252;">"{}:{}"</span>.<span style="color: #483d8b;">format</span>(other.gender, other.name)
        <span style="color: #a020f0;">return</span> s1 &lt; s2

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>) -&gt; <span style="color: #483d8b;">str</span>:
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'&lt;{} {}&gt;'</span>.<span style="color: #483d8b;">format</span>(<span style="color: #a020f0;">self</span>.name, <span style="color: #a020f0;">self</span>.gender)

<span style="color: #a0522d;">q</span> = PriorityQueue() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23567;&#39030;&#22534;&#65292;&#20803;&#32032;&#24517;&#39035;&#21487;&#20197;&#27604;&#36739;</span>

<span style="color: #a020f0;">for</span> name <span style="color: #a020f0;">in</span> (<span style="color: #8b2252;">'tom'</span>, <span style="color: #8b2252;">'jerry'</span>, <span style="color: #8b2252;">'kite'</span>, <span style="color: #8b2252;">'sam'</span>, <span style="color: #8b2252;">'ben'</span>):
    q.put(Student(name))

q.put(Student(<span style="color: #8b2252;">'Alice'</span>, <span style="color: #8b2252;">'F'</span>))
<span style="color: #483d8b;">print</span>(q.qsize())

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
    <span style="color: #483d8b;">print</span>(q.get())


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">6</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&lt;Alice F&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&lt;ben M&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&lt;jerry M&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&lt;kite M&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&lt;sam M&gt;</span>
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:54394495-56ac-49b0-8c9b-9091b8c3f907" class="outline-2">
<h2 id="h:54394495-56ac-49b0-8c9b-9091b8c3f907">线程</h2>
<div class="outline-text-2" id="text-h:54394495-56ac-49b0-8c9b-9091b8c3f907">
</div>
<div id="outline-container-h:da5b7806-7a9d-4232-9154-c00fa6dddf77" class="outline-3">
<h3 id="h:da5b7806-7a9d-4232-9154-c00fa6dddf77">进程和线程</h3>
<div class="outline-text-3" id="text-h:da5b7806-7a9d-4232-9154-c00fa6dddf77">
<p>
线程
</p>
<ul class="org-ul">
<li>在实现了线程的操作系统中，线程是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一个程序的执行实例就是一个进程。</li>
</ul>

<p>
进程
</p>
<ul class="org-ul">
<li>进程（Process）是计算机中的程序关于某数据集合上的一次运行活动，是 <b>系统进行资源分配和调度的基本单位</b> ，是操作系统结构的基础。</li>
</ul>

<p>
进程和程序的关系
</p>
<ul class="org-ul">
<li>程序是源代码编译后的文件，而这些文件存放在磁盘上。当程序被操作系统加载到内存中，就是进程，进程中存放着指令和数据（资源）， <b>它也是线程的容器</b> 。</li>
</ul>

<p>
Linux进程有父进程、子进程，Windows的进程是平等关系。
</p>

<p>
线程，有时被称为轻量级进程(Lightweight Process，LWP），是程序执行流的最小单元。
</p>

<p>
一个标准的线程由线程ID，当前指令指针(PC）、寄存器集合和堆栈组成。
</p>

<p>
在许多系统中，创建一个线程比创建一个进程快10-100倍。
</p>
</div>
<div id="outline-container-h:b1200606-8276-4937-b0e2-26aa2af21f70" class="outline-4">
<h4 id="h:b1200606-8276-4937-b0e2-26aa2af21f70">进程、线程的理解</h4>
<div class="outline-text-4" id="text-h:b1200606-8276-4937-b0e2-26aa2af21f70">
<p>
现代操作系统提出进程的概念，每一个进程都认为自己独占所有的计算机硬件资源。
</p>

<p>
进程就是独立的王国，进程间不可以随便的共享数据。
</p>

<p>
线程就是省份，同一个进程内的线程可以共享进程的资源，每一个线程拥有自己独立的堆栈。
</p>
</div>
</div>
<div id="outline-container-h:70734629-45fc-4d81-b1f3-b06d9ea3e08d" class="outline-4">
<h4 id="h:70734629-45fc-4d81-b1f3-b06d9ea3e08d">线程的状态</h4>
<div class="outline-text-4" id="text-h:70734629-45fc-4d81-b1f3-b06d9ea3e08d">
<ul class="org-ul">
<li><p>
就绪(Ready)
</p>

<p>
线程能够运行，但在等待被调度。可能线程刚刚创建启动，或刚刚从阻塞中恢复，或者被其他线程抢占
</p></li>

<li><p>
运行(Running)
</p>

<p>
线程正在运行
</p></li>

<li><p>
阻塞(Blocked)
</p>

<p>
线程等待外部事件发生而无法运行，如I/O操作
</p></li>

<li><p>
终止(Terminated)
</p>

<p>
线程完成，或退出，或被取消
</p></li>
</ul>



<figure id="orgf785e15">
<img src="./images/img_20250303_221344.png" alt="img_20250303_221344.png" width="50%">

</figure>
</div>
</div>
<div id="outline-container-h:03d53f0a-fbd9-4182-8758-3cd5af8d7d23" class="outline-4">
<h4 id="h:03d53f0a-fbd9-4182-8758-3cd5af8d7d23">Python中的进程和线程</h4>
<div class="outline-text-4" id="text-h:03d53f0a-fbd9-4182-8758-3cd5af8d7d23">
<p>
进程会启动一个解释器进程，线程共享一个解释器进程
</p>
</div>
</div>
</div>
<div id="outline-container-h:d96cf474-80f1-46b2-a0f2-7b293dabf1a7" class="outline-3">
<h3 id="h:d96cf474-80f1-46b2-a0f2-7b293dabf1a7">Python的线程开发</h3>
<div class="outline-text-3" id="text-h:d96cf474-80f1-46b2-a0f2-7b293dabf1a7">
<p>
Python的线程开发使用标准库threading。
</p>

<p>
进程靠线程执行代码，至少有一个 <b>主线程</b> ，其它线程是工作线程
</p>

<p>
主线程是第一个启动的线程
</p>

<p>
父线程：如果线程A中启动了一个线程B，A就是B的父线程
</p>

<p>
子线程：B就是A的子线程
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>():
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"I'm a working"</span>)
    <span style="color: #a020f0;">pass</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"Finished"</span>)

<span style="color: #a0522d;">t</span> = threading.Thread(target=worker, ) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#19968;&#20010;&#32447;&#31243;&#23545;&#35937;&#65292;&#27492;&#32447;&#31243;&#26410;&#36816;&#34892;&#12290;&#20027;&#32447;&#31243;</span>
t.start() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#19968;&#20010;&#32447;&#31243;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">I'm a working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Finished</span>
</pre>
</div>
</div>
<div id="outline-container-h:0280394c-3e47-46db-a401-e5fa67803d48" class="outline-4">
<h4 id="h:0280394c-3e47-46db-a401-e5fa67803d48">Thread类</h4>
<div class="outline-text-4" id="text-h:0280394c-3e47-46db-a401-e5fa67803d48">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, group=<span style="color: #008b8b;">None</span>, target=<span style="color: #008b8b;">None</span>,
       name=<span style="color: #008b8b;">None</span>,args=(), kwargs=<span style="color: #008b8b;">None</span>, *, daemon=<span style="color: #008b8b;">None</span>)


<span style="color: #b22222;">#</span><span style="color: #b22222;">target  &#32447;&#31243;&#35843;&#29992;&#30340;&#23545;&#35937;&#65292;&#23601;&#26159;&#30446;&#26631;&#20989;&#25968;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">name  &#20026;&#32447;&#31243;&#36215;&#20010;&#21517;&#23383;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">args  &#20026;&#30446;&#26631;&#20989;&#25968;&#20256;&#36882;&#23454;&#21442;&#65292;&#20803;&#32452;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">kwargs  &#20026;&#30446;&#26631;&#20989;&#25968;&#20851;&#38190;&#23383;&#20256;&#21442;&#65292;&#23383;&#20856;</span>
</pre>
</div>
</div>
<div id="outline-container-h:484ab488-8416-48ee-970e-0efa85f0472a" class="outline-5">
<h5 id="h:484ab488-8416-48ee-970e-0efa85f0472a">线程启动</h5>
<div class="outline-text-5" id="text-h:484ab488-8416-48ee-970e-0efa85f0472a">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26368;&#31616;&#21333;&#30340;&#32447;&#31243;&#31243;&#24207;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>():
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"I'm working"</span>)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"Fineshed"</span>)


<span style="color: #a0522d;">t</span> = threading.Thread(target=worker, name=<span style="color: #8b2252;">'worker'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32447;&#31243;&#23545;&#35937;</span>
t.start() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160;</span>
</pre>
</div>

<p>
通过threading.Thread创建一个线程对象，target是目标函数，可以使用name为线程指定名称
但是线程没有启动，需要调用start方法
线程之所以执行函数，是因为线程中就是要执行代码的，而最简单的封装就是函数，所以还是函数调用
函数执行完，线程也就退出了
无线循环，不让线程退出
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>():
  <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
    time.sleep(1)
      <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"I'm working"</span>)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"Fineshed"</span>)

<span style="color: #a0522d;">t</span> = threading.Thread(target=worker, name=<span style="color: #8b2252;">'worker'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32447;&#31243;&#23545;&#35937;</span>
t.start() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160; </span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:47d76164-0f32-44e9-9836-0c88eee3b25c" class="outline-5">
<h5 id="h:47d76164-0f32-44e9-9836-0c88eee3b25c">线程退出</h5>
<div class="outline-text-5" id="text-h:47d76164-0f32-44e9-9836-0c88eee3b25c">
<p>
Python没有提供线程退出的方法，线程在下面情况时退出
</p>
<ol class="org-ol">
<li>线程函数内语句执行完毕</li>
<li>线程函数中抛出未处理的异常</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>():
    <span style="color: #a0522d;">count</span> = 0
    <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
        <span style="color: #a020f0;">if</span> count &gt; 5:
            <span style="color: #b22222;"># </span><span style="color: #b22222;">raise RuntimeError(count) # &#25243;&#24322;&#24120;</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">return #&#20989;&#25968;&#36820;&#22238;</span>
            <span style="color: #a020f0;">break</span>
        time.sleep(1)
        <span style="color: #a0522d;">count</span> += 1
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"I'm working"</span>)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"Fineshed"</span>)


<span style="color: #a0522d;">t</span> = threading.Thread(target=worker, name=<span style="color: #8b2252;">'worker'</span>)
t.start()

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"===end==="</span>)
</pre>
</div>

<p>
Python的线程没有优先级、没有线程组的概念，也不能被销毁、停止、挂起，那也就没有恢复、中断了。
</p>
</div>
</div>
<div id="outline-container-h:0815293a-7ab2-4d56-a260-de2fe52a9c57" class="outline-5">
<h5 id="h:0815293a-7ab2-4d56-a260-de2fe52a9c57">线程传参</h5>
<div class="outline-text-5" id="text-h:0815293a-7ab2-4d56-a260-de2fe52a9c57">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">add</span>(x, y):
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'{} + {} = {}'</span>.<span style="color: #483d8b;">format</span>(x, y, x + y), threading.current_thread().ident)


<span style="color: #a0522d;">t1</span> = threading.Thread(target=add, name=<span style="color: #8b2252;">'add1'</span>, args=(4, 5))
t1.start()
time.sleep(2)

<span style="color: #a0522d;">t2</span> = threading.Thread(target=add, name=<span style="color: #8b2252;">'add2'</span>, args=(6,), kwargs={<span style="color: #8b2252;">'y'</span>:7})
t2.start()
time.sleep(2)

<span style="color: #a0522d;">t3</span> = threading.Thread(target=add, name=<span style="color: #8b2252;">'add3'</span>, kwargs={<span style="color: #8b2252;">'x'</span>:8, <span style="color: #8b2252;">'y'</span>:9})
t3.start()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">4 + 5 = 9 11048</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">6 + 7 = 13 15672</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">8 + 9 = 17 21196</span>
</pre>
</div>

<p>
线程传参和函数传参没什么区别，本质上就是函数传参
</p>
</div>
</div>
<div id="outline-container-h:a937c085-ab52-4083-a56d-3d8207a56f86" class="outline-5">
<h5 id="h:a937c085-ab52-4083-a56d-3d8207a56f86">threading的属性和方法</h5>
<div class="outline-text-5" id="text-h:a937c085-ab52-4083-a56d-3d8207a56f86">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">current_thread</span>()  &#36820;&#22238;&#24403;&#21069;&#32447;&#31243;&#23545;&#35937;
<span style="color: #0000ff;">main_thread</span>() &#36820;&#22238;&#20027;&#32447;&#31243;&#23545;&#35937;
<span style="color: #0000ff;">active_count</span>(&#65289;  &#24403;&#21069;&#22788;&#20110;alive&#29366;&#24577;&#30340;&#32447;&#31243;&#20010;&#25968;
<span style="color: #0000ff;">enumerate</span>() &#36820;&#22238;&#25152;&#26377;&#27963;&#30528;&#30340;&#32447;&#31243;&#30340;&#21015;&#34920;&#65292;&#19981;&#21253;&#25324;&#24050;&#32463;&#32456;&#27490;&#30340;&#32447;&#31243;&#21644;&#26410;&#24320;&#22987;&#30340;&#32447;&#31243;
<span style="color: #0000ff;">get_ident</span>() &#36820;&#22238;&#24403;&#21069;&#32447;&#31243;&#30340;ID&#65292;&#38750;0&#25972;&#25968;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">showtreainfo</span>():
    <span style="color: #483d8b;">print</span>(threading.main_thread(), threading.current_thread(),
        threading.active_count(), threading.<span style="color: #483d8b;">enumerate</span>())

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>():
    showtreainfo() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26174;&#31034;&#32447;&#31243;&#20449;&#24687;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">while True:</span>
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
        time.sleep(1)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'i am working'</span>)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'finished'</span>)

<span style="color: #a0522d;">t</span> = threading.Thread(target=worker, name=<span style="color: #8b2252;">'worker'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32447;&#31243;&#23545;&#35937;</span>
showtreainfo() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26174;&#31034;&#32447;&#31243;&#20449;&#24687;</span>
time.sleep(1)
t.start() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21551;&#21160;&#36816;&#34892;&#19968;&#20010;&#32447;&#31243;</span>

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'===enb==='</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&lt;_MainThread(MainThread, started 24000)&gt; &lt;_MainThread(MainThread, started 24000)&gt; 1 [&lt;_MainThread(MainThread, started 24000)&gt;]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&lt;_MainThread(MainThread, started 24000)&gt; &lt;Thread(worker, started 16948)&gt; 2 [&lt;_MainThread(MainThread, started 24000)&gt;, &lt;Thread(worker, started 16948)&gt;]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">===enb===</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i am working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i am working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i am working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i am working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i am working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">finished</span>
</pre>
</div>

<p>
active_count、enumerate方法返回的值还包括主线程
</p>
</div>
</div>
<div id="outline-container-h:fd554e60-2251-46ce-af33-42f12cb87336" class="outline-5">
<h5 id="h:fd554e60-2251-46ce-af33-42f12cb87336">Thread实例的属性和方法</h5>
<div class="outline-text-5" id="text-h:fd554e60-2251-46ce-af33-42f12cb87336">
<pre class="example" id="orga574c9e">
name  只是一个名字，只是个标识，名称可以重名。getName()、setName()获取、设置这个名词
ident 线程ID，它是非0整数。线程启动后才会有ID，否则为None。线程退出，此ID依旧可以访问。此ID可以重复使用
is_alive()  返回线程是否活着
</pre>

<p>
注意：线程的name这是一个名称，可以重复；ID必须唯一，但可以在线程退出后再利用
</p>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(count, name):
    <span style="color: #a0522d;">c</span> = threading.current_thread()
    <span style="color: #483d8b;">print</span>(c.name, c.ident, <span style="color: #8b2252;">'~~~~'</span>, t1, t1 <span style="color: #a020f0;">is</span> c) <span style="color: #b22222;">#</span><span style="color: #b22222;">t1, c&#26159;&#19968;&#20010;&#32447;&#31243;&#23545;&#35937;</span>
    <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">for i in range(count):</span>
        time.sleep(1)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'{} working'</span>.<span style="color: #483d8b;">format</span>(name))
        <span style="color: #a0522d;">count</span> += 1
        <span style="color: #a020f0;">if</span> count &gt; 3:
            <span style="color: #a020f0;">break</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'Finished'</span>)

<span style="color: #a0522d;">t1</span> = threading.Thread(target=worker, name=<span style="color: #8b2252;">'worker1'</span>, args=(0, <span style="color: #8b2252;">'w1'</span>))
<span style="color: #483d8b;">print</span>(t1.name, t1.ident, t1.is_alive(), <span style="color: #8b2252;">'++++'</span>)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32447;&#31243;&#27809;&#26377;&#34987;&#21019;&#24314;&#26159;&#27809;&#26377;&#32447;&#31243;id&#30340;</span>
time.sleep(1)
t1.start() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#19968;&#20010;&#32447;&#31243;</span>
time.sleep(1)
<span style="color: #483d8b;">print</span>(t1.name, t1.ident, t1.is_alive(), <span style="color: #8b2252;">'----'</span>)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32447;&#31243;&#34987;&#21019;&#24314;&#21518;&#26377;&#32447;&#31243;id</span>
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'==end=='</span>)
time.sleep(8) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#32447;&#31243;&#31561;&#24453;8&#31186;&#65292; </span>
<span style="color: #483d8b;">print</span>(t1.name, t1.ident, t1.is_alive(), <span style="color: #8b2252;">'****'</span>)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32447;&#31243;&#34987;&#21019;&#24314;&#21518;&#26377;&#32447;&#31243;id</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">worker1 None False ++++</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">worker1 25968 ~~~~ &lt;Thread(worker1, started 25968)&gt; True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">worker1 25968 True ----</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">w1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">==end==</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">w1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">w1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">w1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">worker1 25968 False ****</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(count, name):
    <span style="color: #a0522d;">c</span> = threading.current_thread()
    <span style="color: #483d8b;">print</span>(c.name, c.ident, <span style="color: #8b2252;">'~~~~'</span>, t1, t1 <span style="color: #a020f0;">is</span> c) <span style="color: #b22222;">#</span><span style="color: #b22222;">t1, c&#26159;&#19968;&#20010;&#32447;&#31243;&#23545;&#35937;</span>
    <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">for i in range(count):</span>
        time.sleep(1)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'{} working'</span>.<span style="color: #483d8b;">format</span>(name))
        <span style="color: #a0522d;">count</span> += 1
        <span style="color: #a020f0;">if</span> count &gt; 3:
            <span style="color: #a020f0;">break</span>
            <span style="color: #b22222;">#</span><span style="color: #b22222;">1/0</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'Finished'</span>)

<span style="color: #a0522d;">t1</span> = threading.Thread(target=worker, name=<span style="color: #8b2252;">'worker1'</span>, args=(0, <span style="color: #8b2252;">'w1'</span>))
time.sleep(1)
t1.start() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#19968;&#20010;&#32447;&#31243;</span>
time.sleep(1)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'==end=='</span>)

<span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>: <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#32447;&#31243;</span>
    time.sleep(1)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'{} {} {}'</span>.<span style="color: #483d8b;">format</span>(
        t1.name, t1.ident,<span style="color: #8b2252;">'alive'</span> <span style="color: #a020f0;">if</span> t1.is_alive() <span style="color: #a020f0;">else</span> <span style="color: #8b2252;">'dead'</span>))

    <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> t1.is_alive():
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'{} restart'</span>.<span style="color: #483d8b;">format</span>(t1.name))
        t1.start() <span style="color: #b22222;"># </span><span style="color: #b22222;">RuntimeError: threads can only be started once</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">start&#26041;&#27861;&#23545;&#21516;&#19968;&#20010;&#32447;&#31243;&#23545;&#35937;&#21482;&#33021;&#29992;&#19968;&#27425;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">worker1 22548 ~~~~ &lt;Thread(worker1, started 22548)&gt; True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">w1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">==end==</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">w1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">worker1 22548 alive</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">w1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">worker1 22548 alive</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">w1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">worker1 22548 dead</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">worker1 restart</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Traceback (most recent call last):</span>
<span style="color: #b22222;">#   </span><span style="color: #b22222;">File "d:\project\pyproj\cursor\t2.py", line 30, in &lt;module&gt;</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">t1.start() # RuntimeError: threads can only be started once</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">~~~~~~~~^^</span>
<span style="color: #b22222;">#   </span><span style="color: #b22222;">File "D:\py\py313\Lib\threading.py", line 967, in start</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">raise RuntimeError("threads can only be started once")</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">RuntimeError: threads can only be started once</span>
</pre>
</div>

<ul class="org-ul">
<li>start() 启动线程。每一个线程必须且只能执行该方法一次</li>
<li>run() 运行线程函数</li>
</ul>

<p>
start()方法会调用run()方法，而run()方法可以运行函数。
</p>
</div>
<ul class="org-ul">
<li><a id="h:83c931d0-bfb3-4c1a-acaa-94743407a261"></a>start和run的区别<br>
<div class="outline-text-6" id="text-h:83c931d0-bfb3-4c1a-acaa-94743407a261">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">MyThread</span>(threading.Thread):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">start</span>(<span style="color: #a020f0;">self</span>) -&gt; <span style="color: #008b8b;">None</span>: <span style="color: #b22222;">#</span><span style="color: #b22222;">override &#22312;&#36825;&#37324;&#38500;&#20102;&#35206;&#30422;&#65292;&#36824;&#35201;&#35843;&#29992;&#29238;&#31867;&#30340;&#21516;&#21517;&#26041;&#27861;</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'start~~~~'</span>)
        <span style="color: #483d8b;">super</span>().start()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">run</span>(<span style="color: #a020f0;">self</span>) -&gt; <span style="color: #008b8b;">None</span>:
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'run~~~~'</span>)
        <span style="color: #483d8b;">super</span>().run()

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(count, name):
    <span style="color: #483d8b;">print</span>(threading.<span style="color: #483d8b;">enumerate</span>())
    <span style="color: #b22222;"># </span><span style="color: #b22222;">while True:</span>
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(3):
        time.sleep(1)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'{} working'</span>.<span style="color: #483d8b;">format</span>(name))
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'Finished'</span>)

<span style="color: #a0522d;">t1</span> = MyThread(target=worker, name=<span style="color: #8b2252;">'worker1'</span>, args=(0, <span style="color: #8b2252;">'w1'</span>))
time.sleep(1)
<span style="color: #b22222;"># </span><span style="color: #b22222;">t1.start() #&#21551;&#21160;&#19968;&#20010;&#32447;&#31243; -&gt; &#20250;&#35843;&#29992;run&#26041;&#27861;&#65292;&#24182;&#34892;&#12290;start&#24517;&#39035;&#20135;&#29983;&#19968;&#20010;&#25805;&#20316;&#31995;&#32479;&#30340;&#30495;&#27491;&#30340;&#26032;&#32447;&#31243;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">start&#20250;&#38459;&#22622;&#21527;&#65311;&#27809;&#26377;&#65292;&#22240;&#20026;&#23427;&#20250;&#31435;&#21363;&#36820;&#22238;&#12290;</span>
t1.run() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#35843;&#29992;run&#26041;&#27861;. &#21644;start&#26041;&#27861;&#19968;&#26679;&#21482;&#33021;&#29992;&#19968;&#27425;&#12290;&#20018;&#34892;&#25191;&#34892;. &#21482;&#26377;&#19968;&#20010;&#32447;&#31243;&#65292;&#20027;&#12290;&#26680;&#24515;&#35843;&#29992;&#20102;target&#26041;&#27861;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">run &#19981;&#20250;&#20135;&#29983;&#32447;&#31243;&#12290;&#22312;&#19968;&#20010;&#32447;&#31243;&#20869;&#65292;&#31243;&#24207;&#19968;&#23450;&#26159;&#25353;&#39034;&#24207;&#25191;&#34892;&#30340;&#65292;&#19981;&#21487;&#20197;&#24182;&#34892;&#12290;</span>
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'==end=='</span>)


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#30452;&#25509;&#35843;&#29992;run&#26041;&#27861;&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">run~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">[&lt;_MainThread(MainThread, started 29348)&gt;]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">w1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">w1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">w1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">==end==</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">start&#26041;&#27861;&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">run~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">==end==</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">[&lt;_MainThread(MainThread, started 9192)&gt;, &lt;MyThread(worker1, started 14192)&gt;]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">w1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">w1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">w1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Finished</span>
</pre>
</div>


<ul class="org-ul">
<li>使用start方法启动线程，启动了一个新的线程，名字叫做worker运行。</li>
<li>但是使用run方法的，并没有启动新的线程，就是在主线程中调用了一个普通的函数而已。</li>
</ul>

<p>
因此，启动线程请使用start方法，且对于这个线程来说，start方法只能调用一次。（设置_started属性实现）
</p>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-h:fe6e5200-c810-4ebc-8944-8f64f954bfb9" class="outline-4">
<h4 id="h:fe6e5200-c810-4ebc-8944-8f64f954bfb9">多线程</h4>
<div class="outline-text-4" id="text-h:fe6e5200-c810-4ebc-8944-8f64f954bfb9">
<p>
顾名思义，多个线程，一个进程中如果有多个线程运行，就是多线程，实现一种并发。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>():
    <span style="color: #a0522d;">t</span> = threading.current_thread()
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
        time.sleep(1)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'i an working'</span>, t.name, t.ident)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'finished'</span>)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">MyTread</span>(threading.Thread):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">start</span>(<span style="color: #a020f0;">self</span>) -&gt; <span style="color: #008b8b;">None</span>:
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'start~~~~~'</span>)
        <span style="color: #483d8b;">super</span>().start()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">run</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'run~~~~~'</span>)
        <span style="color: #483d8b;">super</span>().run()

<span style="color: #a0522d;">t1</span> = MyTread(target=worker, name=<span style="color: #8b2252;">'worker1'</span>)
<span style="color: #a0522d;">t2</span> = MyTread(target=worker, name=<span style="color: #8b2252;">'worker2'</span>)
t1.start()
t2.start()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">start~~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">run~~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">start~~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">run~~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working worker1 28736</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working worker2 27012</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working worker1 28736</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working worker2 27012</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working worker2 27012</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working worker1 28736</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working worker1 28736</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working worker2 27012</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working worker1 28736</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working worker2 27012</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">finished</span>
</pre>
</div>

<p>
可以看到worker1和work2交替执行，改成run方法试试看
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>():
    <span style="color: #a0522d;">t</span> = threading.current_thread()
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
        time.sleep(1)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'i an working'</span>, t.name, t.ident)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'finished'</span>)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">MyTread</span>(threading.Thread):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">start</span>(<span style="color: #a020f0;">self</span>) -&gt; <span style="color: #008b8b;">None</span>:
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'start~~~~~'</span>)
        <span style="color: #483d8b;">super</span>().start()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">run</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'run~~~~~'</span>)
        <span style="color: #483d8b;">super</span>().run()

<span style="color: #a0522d;">t1</span> = MyTread(target=worker, name=<span style="color: #8b2252;">'worker1'</span>)
<span style="color: #a0522d;">t2</span> = MyTread(target=worker, name=<span style="color: #8b2252;">'worker2'</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">t1.start()</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t2.start()</span>
t1.run()
t2.run()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">run~~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working MainThread 5904</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working MainThread 5904</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working MainThread 5904</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working MainThread 5904</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working MainThread 5904</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">run~~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working MainThread 5904</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working MainThread 5904</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working MainThread 5904</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working MainThread 5904</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">i an working MainThread 5904</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">finished</span>
</pre>
</div>

<p>
没有开新的线程，这就是普通函数调用，所以执行完t1.run()，然后执行t2.run()，这里就不是多线程。
</p>

<p>
当使用start方法启动线程后，进程内有多个活动的线程并行的工作，就是多线程。
</p>

<p>
一个进程中至少有一个线程，并作为程序的入口，这个线程就是 <b>主线程</b> 。
</p>

<p>
一个进程至少有一个主线程。
</p>

<p>
其他线程称为 <b>工作线程</b>
</p>
</div>
</div>
<div id="outline-container-h:17f041eb-2065-4f5a-80c3-e839c2a4564e" class="outline-4">
<h4 id="h:17f041eb-2065-4f5a-80c3-e839c2a4564e">daemon线程和non-daemon线程</h4>
<div class="outline-text-4" id="text-h:17f041eb-2065-4f5a-80c3-e839c2a4564e">
<p>
注意：有人翻译成后台线程，也有人翻译成守护进程。
</p>

<p>
Python中，构造线程的时候，可以设置daemon属性，这个属性必须在start方法前设置好。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#28304;&#30721;Thread&#30340;__init__&#26041;&#27861;&#20013;</span>
<span style="color: #a020f0;">if</span> daemon <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">_daemonic</span> = daemon <span style="color: #b22222;"># </span><span style="color: #b22222;">&#29992;&#25143;&#35774;&#23450;bool&#20540;</span>
<span style="color: #a020f0;">else</span>:
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">_daemonic</span> = current_thread().daemon        
</pre>
</div>

<p>
线程daemon属性，如果设定就是用户的设置，否则就取当前线程的daemon值。
</p>

<p>
主线程是non-daemon线程，即daemon = False。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">_MainThread</span>(Thread):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>):
        Thread.__init__(<span style="color: #a020f0;">self</span>, name=<span style="color: #8b2252;">"MainThread"</span>, daemon=<span style="color: #008b8b;">False</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(name, interval=1):
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
        time.sleep(interval)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'{} working'</span>.<span style="color: #483d8b;">format</span>(name))

<span style="color: #a0522d;">t</span> = threading.Thread(target=worker, args=(<span style="color: #8b2252;">'t1'</span>, 1))
t.start()

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'==end=='</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">==end==</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t1 working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t1 working</span>
</pre>
</div>

<p>
发现线程t依然执行，主线程已经执行完，但是一直等着线程t。
</p>

<p>
修改为 t = threading.Thread(target=foo, daemon=True)
</p>

<p>
程序立即结束了，主线程根本没有等线程t。
</p>

<div class="org-src-container">
<pre class="src src-sh">daemon&#23646;&#24615;        &#34920;&#31034;&#32447;&#31243;&#26159;&#21542;&#26159;daemon&#32447;&#31243;&#65292;&#36825;&#20010;&#20540;&#24517;&#39035;&#22312;start()&#20043;&#21069;&#35774;&#32622;&#65292;&#21542;&#21017;&#24341;&#21457;RuntimeError&#24322;&#24120;
<span style="color: #0000ff;">isDaemon</span>()      &#26159;&#21542;&#26159;daemon&#32447;&#31243;
setDaemon       &#35774;&#32622;&#20026;daemon&#32447;&#31243;&#65292;&#24517;&#39035;&#22312;start&#26041;&#27861;&#20043;&#21069;&#35774;&#32622;
</pre>
</div>


<p>
观察下面代码主线程何时结束daemon线程
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(name, interval=1):
    <span style="color: #483d8b;">print</span>(name, <span style="color: #8b2252;">'enter~~~~'</span>)
    time.sleep(interval)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'{} working ++++'</span>.<span style="color: #483d8b;">format</span>(name))

<span style="color: #a0522d;">t1</span> = threading.Thread(target=worker, name=<span style="color: #8b2252;">'t1'</span>, args=(<span style="color: #8b2252;">'t1'</span>, 1), daemon=<span style="color: #008b8b;">True</span>)
<span style="color: #b22222;">#</span><span style="color: #b22222;">False non-daemon &#32447;&#31243;&#65292;&#31561;&#21040;&#35813;&#32447;&#31243;&#32467;&#26463;&#36827;&#31243;&#32467;&#26463;&#65307;True daemon</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(t1.daemon, t1.isDaemon())</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t1.daemon = False</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t1.setDaemon(False) #&#21644;t1.daemon = False &#25928;&#26524;&#19968;&#26679;</span>
t1.start()
<span style="color: #b22222;"># </span><span style="color: #b22222;">t1.setDaemon(True) #&#38169;&#65292;&#24517;&#39035;&#25918;&#22312;start&#20043;&#21069;</span>

<span style="color: #a0522d;">t2</span> = threading.Thread(target=worker, name=<span style="color: #8b2252;">'t2'</span>, args=(<span style="color: #8b2252;">'t2'</span>, 5), daemon=<span style="color: #008b8b;">False</span>)
t2.start()
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'==end=='</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#32447;&#31243;&#32467;&#26463;&#20102;&#65292;&#26080;&#20107;&#21487;&#20570;</span>
<span style="color: #483d8b;">print</span>(*threading.<span style="color: #483d8b;">enumerate</span>(), sep=<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21807;&#19968;non-daemon&#32447;&#31243;&#20027;&#32447;&#31243;&#26080;&#20107;&#21487;&#20570;&#65292;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t1 enter~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t2 enter~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">==end==</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&lt;_MainThread(MainThread, started 25192)&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&lt;Thread(t1, started daemon 19144)&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&lt;Thread(t2, started 11740)&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t1 working ++++</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t2 working ++++</span>
</pre>
</div>

<p>
上例说明，如果除主线程之外还有non-daemon线程的时候，主线程退出时，也不
会杀掉所有daemon线程，直到所有non-daemon线程全部结束，如果还有daemon线
程，主线程需要退出（主线程退出也可以理解为最后一个non-daemon线程也要退
出了），会结束所有daemon线程，程序退出。
</p>

<p>
总结
</p>
<ul class="org-ul">
<li>线程具有一个daemon属性，可以手动设置为True或False，也可以不设置，则取默认值None。</li>
<li>如果不设置daemon，就取当前线程的daemon来设置它。</li>
<li>主线程是non-daemon线程，即daemon = False。</li>
<li>从主线程创建的所有线程的不设置daemon属性，则默认都是daemon = False，也就是non-daemon线程。</li>
<li>Python程序在没有活着的non-daemon线程运行时，程序退出，也就是除主线程
之外剩下的只能都是daemon线程，主线程才能退出，否则主线程就只能等待。</li>
</ul>
</div>
</div>
<div id="outline-container-h:d5d7c611-941c-4e80-83cd-b015c799198f" class="outline-4">
<h4 id="h:d5d7c611-941c-4e80-83cd-b015c799198f">join方法</h4>
<div class="outline-text-4" id="text-h:d5d7c611-941c-4e80-83cd-b015c799198f">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">foo</span>(name, timeout):
    time.sleep(timeout)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'{} working'</span>.<span style="color: #483d8b;">format</span>(name))

<span style="color: #a0522d;">t1</span> = threading.Thread(target=foo, args=(<span style="color: #8b2252;">'t1'</span>, 5), daemon=<span style="color: #008b8b;">True</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35843;&#25442;5&#21644;10&#30475;&#30475;&#25928;&#26524;</span>
t1.start()
t1.join()<span style="color: #b22222;"># </span><span style="color: #b22222;">&#27704;&#20037;&#38459;&#22622;&#65292;&#21040;t1&#32447;&#31243;&#32447;&#26463;&#36816;&#34892;</span>

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'Main Thread Exits'</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25191;&#34892;&#32467;&#26524;</span>
t1 working
Main Thread Exits
</pre>
</div>

<ul class="org-ul">
<li>使用了join方法后，daemon线程执行完了，主线程才退出了</li>
<li>如果取消join方法，主线程执行完直接退出</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">foo</span>(name, timeout):
    time.sleep(timeout)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'{} working'</span>.<span style="color: #483d8b;">format</span>(name))

<span style="color: #a0522d;">t1</span> = threading.Thread(target=foo, args=(<span style="color: #8b2252;">'t1'</span>, 5), daemon=<span style="color: #008b8b;">True</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#35843;&#25442;5&#21644;10&#30475;&#30475;&#25928;&#26524;</span>
t1.start()
t1.join(2) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#32447;&#31243;&#31561;&#20102;2&#31186;&#65292;&#38459;&#22622;</span>
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'~~~~~~~~~~~'</span>)
t1.join(2)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'~~~~~~~~~~~'</span>)

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'Main Thread Exits'</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25191;&#34892;&#32467;&#26524;</span>
~~~~~~~~~~~
~~~~~~~~~~~
Main Thread Exits
</pre>
</div>

<p>
join(timeout=None)，是线程的标准方法之一
</p>
<ul class="org-ul">
<li>一个线程中调用另一个线程的join方法，调用者将被阻塞，直到被调用线程终止，或阻塞超时。</li>
<li>一个线程可以被join多次。</li>
<li>timeout参数指定调用者等待多久，没有设置超时，就一直等到被调用线程结束。</li>
<li>调用谁的join方法，就是join谁，就要等谁。</li>
</ul>
</div>
</div>
<div id="outline-container-h:7470c0eb-377d-4bfb-a9f1-394440264462" class="outline-4">
<h4 id="h:7470c0eb-377d-4bfb-a9f1-394440264462">daemon线程应用场景</h4>
<div class="outline-text-4" id="text-h:7470c0eb-377d-4bfb-a9f1-394440264462">
<p>
简单来说就是，本来并没有 daemon thread，为了简化程序员的工作，让他们不
用去记录和管理那些后台线程，创造了一个 daemon thread 的概念。这个概念
唯一的作用就是，当你把一个线程设置为 daemon，它可以会随主线程的退出而
退出
</p>

<p>
主要应用场景有：
</p>
<ul class="org-ul">
<li>后台任务。如发送心跳包、监控，这种场景最多。</li>
<li>主线程工作才有用的线程。如主线程中维护这公共的资源，主线程已经清理了，准备退出，而工作线程使用这些资源工作也没有意义了，一起退出最合适</li>
<li>随时可以被终止的线程</li>
</ul>

<p>
如果主线程退出，想所有其它工作线程一起退出，就使用daemon=True来创建工作线程。
</p>

<p>
比如，开启一个线程定时判断WEB服务是否正常工作，主线程退出，工作线程也
没有必须存在了，应该随着主线程退出一起退出。这种daemon线程一旦创建，就
可以忘记它了，只用关心主线程什么时候退出就行了。
</p>

<p>
daemon线程，简化了程序员手动关闭线程的工作
</p>

<p>
如果在non-daemon线程A中，对另一个daemon线程B使用了join方法，这个线程B
设置成daemon就没有什么意义了，因为non-daemon线程A总是要等待B。
</p>

<p>
如果在一个daemon线程C中，对另一个daemon线程D使用了join方法，只能说明C
要等待D，主线程退出，C和D不管是否结束，也不管它们谁等谁，都要被杀掉。
</p>

<p>
范例：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker2</span>(name):
    <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
        time.sleep(1)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'{} working'</span>.<span style="color: #483d8b;">format</span>(name), threading.current_thread().isDaemon())

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker1</span>(name):
    <span style="color: #a0522d;">current</span> = threading.current_thread()
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"{}'s daemon = {}"</span>.<span style="color: #483d8b;">format</span>(name, current.isDaemon()))
    <span style="color: #a0522d;">t2</span> = threading.Thread(target=worker2, args=(<span style="color: #8b2252;">'t2'</span>,), name=<span style="color: #8b2252;">'t2'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38544;&#24335; daemon=True&#65292;&#32487;&#25215;&#33258;t1</span>
    t2.start()

<span style="color: #a0522d;">t1</span> = threading.Thread(target=worker1, args=(<span style="color: #8b2252;">'t1'</span>,), daemon=<span style="color: #008b8b;">True</span>, name=<span style="color: #8b2252;">'t1'</span>)
t1.start()

time.sleep(4)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'Main Thread Exits'</span>)
<span style="color: #483d8b;">print</span>(threading.active_count(), threading.<span style="color: #483d8b;">enumerate</span>())

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25191;&#34892;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t1 s daemon = True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t2 working True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t2 working True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t2 working True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Main Thread Exits</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2 [&lt;_MainThread(MainThread, started 29620)&gt;, &lt;Thread(t2, started daemon 28036)&gt;]</span>
</pre>
</div>

<p>
上例，只要主线程要退出，2个工作线程都结束
</p>

<p>
使用join，让线程不结束
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker2</span>(name):
    <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
        time.sleep(1)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'{} working'</span>.<span style="color: #483d8b;">format</span>(name), threading.current_thread().isDaemon())

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker1</span>(name):
    <span style="color: #a0522d;">current</span> = threading.current_thread()
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"{}'s daemon = {}"</span>.<span style="color: #483d8b;">format</span>(name, current.isDaemon()))
    <span style="color: #a0522d;">t2</span> = threading.Thread(target=worker2, args=(<span style="color: #8b2252;">'t2'</span>,), name=<span style="color: #8b2252;">'t2'</span>, daemon=<span style="color: #008b8b;">True</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38544;&#24335; daemon=True&#65292;&#32487;&#25215;&#33258;t1</span>
    t2.start()
    t2.join() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38459;&#22622;&#65292;&#31561;&#24453;t2&#32467;&#26463;</span>

<span style="color: #a0522d;">t1</span> = threading.Thread(target=worker1, args=(<span style="color: #8b2252;">'t1'</span>,), daemon=<span style="color: #008b8b;">True</span>, name=<span style="color: #8b2252;">'t1'</span>)
t1.start()
t1.join() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38459;&#22622;&#65292;&#31561;&#24453;t1&#32467;&#26463;</span>

time.sleep(4)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'Main Thread Exits'</span>)
<span style="color: #483d8b;">print</span>(threading.active_count(), threading.<span style="color: #483d8b;">enumerate</span>())
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:1c3888c8-3158-446f-b826-ad6b17d80dc5" class="outline-3">
<h3 id="h:1c3888c8-3158-446f-b826-ad6b17d80dc5">threading.local类</h3>
<div class="outline-text-3" id="text-h:1c3888c8-3158-446f-b826-ad6b17d80dc5">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> time 
<span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> logging

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">"%(asctime)s %(threadName)s %(thread)d %(message)s"</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO, datefmt=<span style="color: #8b2252;">"%Y-%m-%d %H:%M:%S"</span>)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>():
    <span style="color: #a0522d;">x</span> = 0 <span style="color: #b22222;">#</span><span style="color: #b22222;">x &#38750;&#24120;&#23433;&#20840;</span>
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(1000):
        time.sleep(0.00001)
        <span style="color: #a0522d;">x</span> += 1
    logging.info(<span style="color: #8b2252;">"x = {}"</span>.<span style="color: #483d8b;">format</span>(x))

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(10):
    threading.Thread(target=worker, name=<span style="color: #8b2252;">'w{}'</span>.<span style="color: #483d8b;">format</span>(i)).start()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:51:11 w3 14560 x = 1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:51:11 w0 2604 x = 1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:51:11 w6 11708 x = 1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:51:11 w2 5260 x = 1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:51:11 w9 4248 x = 1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:51:11 w4 12032 x = 1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:51:11 w5 8992 x = 1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:51:11 w8 13044 x = 1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:51:11 w1 15524 x = 1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:51:11 w7 12520 x = 1000</span>
</pre>
</div>

<p>
上例使用多线程，每个线程完成不同的计算任务。
</p>

<p>
x是局部变量，可以看出每一个线程的x是独立的，互不干扰的
</p>

<ul class="org-ul">
<li>改造成全局变量</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> time 
<span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> logging

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">"%(asctime)s %(threadName)s %(thread)d %(message)s"</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO, datefmt=<span style="color: #8b2252;">"%Y-%m-%d %H:%M:%S"</span>)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">A</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">x</span> = 0

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20840;&#23616;&#23545;&#35937;</span>
<span style="color: #a0522d;">global_data</span> = A()
<span style="color: #b22222;"># </span><span style="color: #b22222;">x = 0</span>

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>():
    <span style="color: #b22222;"># </span><span style="color: #b22222;">global x</span>
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(1000):
        time.sleep(0.00001)
        global_data.<span style="color: #a0522d;">x</span> += 1
        <span style="color: #b22222;"># </span><span style="color: #b22222;">x += 1</span>
    logging.info(<span style="color: #8b2252;">"x = {}"</span>.<span style="color: #483d8b;">format</span>(global_data.x))

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(10):
    threading.Thread(target=worker, name=<span style="color: #8b2252;">'w{}'</span>.<span style="color: #483d8b;">format</span>(i)).start()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:46:45 w0 12256 x = 9916</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:46:45 w3 13540 x = 9943</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:46:45 w2 12872 x = 9962</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:46:45 w5 3256 x = 9966</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:46:45 w1 5032 x = 9969</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:46:45 w4 4720 x = 9985</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:46:45 w6 4188 x = 9991</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:46:45 w7 5152 x = 9995</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:46:45 w9 16268 x = 9999</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-05 23:46:45 w8 17668 x = 10000</span>
</pre>
</div>

<p>
上例虽然使用了全局对象，但是线程之间互相干扰，导致了不期望的结果。 <b>线程不安全</b> 。
</p>

<p>
能不能既使用全局对象，还能保持每个线程使用不同的数据呢？
</p>

<p>
通过这个例子可以看到，使用了多线程导致结果完全不确定，原因在A类上，我们称这个 <b>线程不安全</b> 。
</p>

<blockquote>
<p>
线程安全
</p>
<ul class="org-ul">
<li>多线程执行一段代码，不产生不确定的结果，那这段代码就是线程安全的。</li>
</ul>
</blockquote>

<p>
python提供threading.local 类，将这个类实例化得到一个全局对象，但是不同的线程使用这个对象存储的数据。其他线程看不见。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> time 
<span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> logging

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">"%(asctime)s %(threadName)s %(thread)d %(message)s"</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO, datefmt=<span style="color: #8b2252;">"%Y-%m-%d %H:%M:%S"</span>)


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20840;&#23616;&#23545;&#35937;</span>
<span style="color: #a0522d;">global_data</span> = threading.local()

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>():
    global_data.<span style="color: #a0522d;">x</span> = 0
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(1000):
        time.sleep(0.00001)
        global_data.<span style="color: #a0522d;">x</span> += 1
    logging.info(<span style="color: #8b2252;">"x = {}"</span>.<span style="color: #483d8b;">format</span>(global_data.x))

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(10):
    threading.Thread(target=worker, name=<span style="color: #8b2252;">'w{}'</span>.<span style="color: #483d8b;">format</span>(i)).start()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-06 00:01:48 w2 14064 x = 100</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-06 00:01:48 w4 7008 x = 1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-06 00:01:48 w8 3540 x = 1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-06 00:01:48 w1 19008 x = 100</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-06 00:01:48 w7 14404 x = 100</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-06 00:01:48 w6 1564 x = 1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-06 00:01:48 w0 14412 x = 100</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-06 00:01:48 w3 18144 x = 100</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-06 00:01:48 w5 872 x = 1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-06 00:01:48 w9 3496 x = 1000</span>
</pre>
</div>

<p>
结果显示和使用局部变量的效果一样。
</p>

<ul class="org-ul">
<li>再看threading.local的例子</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a0522d;">X</span> = <span style="color: #8b2252;">'abc'</span>
<span style="color: #a0522d;">global_data</span> = threading.local() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#24847;&#36825;&#20010;&#23545;&#35937;&#25152;&#22788;&#30340;&#32447;&#31243;</span>
global_data.<span style="color: #a0522d;">x</span> = 100 <span style="color: #b22222;">#</span><span style="color: #b22222;">threading.local &#23545;&#35937;, &#23646;&#24615;&#21019;&#24314;&#22312;&#20160;&#20040;&#32447;&#31243;&#65292;&#20160;&#20040;&#32447;&#31243;&#21487;&#29992;</span>

<span style="color: #483d8b;">print</span>(global_data, <span style="color: #483d8b;">type</span>(global_data), global_data.x)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>():
    <span style="color: #483d8b;">print</span>(X)
    <span style="color: #483d8b;">print</span>(global_data)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(global_data.x) # AttributeError: '_thread._local' object has no attribute 'x'</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'in worker'</span>)

worker()
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
threading.Thread(target=worker).start()

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25191;&#34892;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&lt;_thread._local object at 0x0000022C6D77E938&gt; &lt;class '_thread._local'&gt; 100</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">abc</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&lt;_thread._local object at 0x0000022C6D77E938&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">in worker</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">------------------------------</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">abc</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&lt;_thread._local object at 0x0000022C6D77E938&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">in worker</span>
</pre>
</div>

<ul class="org-ul">
<li>再另外一个线程中执行print(global_data.x)会抛AttributeError: '_thread._local' object has no attribute 'x'错误，但是global_data打印没有出错，说明看到global_data，而global_data中的x看不到，所以这个x不能跨线程。</li>
<li>threading.local类构建了一个大字典，存放所有线程相关的字典，定义如下：
<ul class="org-ul">
<li><code>{ id(Thread) -&gt; (ref(Thread), thread-local dict) }</code></li>
<li>每一线程实例的id为key，元组为value, value中2部分为，线程对象引用，每个线程自己的字典</li>
</ul></li>
</ul>

<p>
本质
</p>
<ul class="org-ul">
<li>运行时，threading.local实例处在不同的线程中，就从大字典中找到当前线程相关键值对中的字典，覆盖threading.local实例的 <code>__dict__</code></li>
<li>这样就可以在不同的线程中，安全地使用线程独有的数据，做到了线程间数据隔离，如同本地变量一样安全</li>
</ul>


<p>
threading.local()源码解读
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">local&#28304;&#30721;</span>

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">_localimpl</span>:
    <span style="color: #8b2252;">"""A class managing thread-local dicts"""</span>
    <span style="color: #a0522d;">__slots__</span> = <span style="color: #8b2252;">'key'</span>, <span style="color: #8b2252;">'dicts'</span>, <span style="color: #8b2252;">'localargs'</span>, <span style="color: #8b2252;">'locallock'</span>, <span style="color: #8b2252;">'__weakref__'</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">key</span> = <span style="color: #8b2252;">'_threading_local._localimpl.'</span> + <span style="color: #483d8b;">str</span>(<span style="color: #483d8b;">id</span>(<span style="color: #a020f0;">self</span>))
        <span style="color: #b22222;"># </span><span style="color: #b22222;">{ id(Thread) -&gt; (ref(Thread), thread-local dict) }</span>
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">dicts</span> = {}

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_dict</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #8b2252;">"""Return the dict for the current thread. Raises KeyError if none</span>
<span style="color: #8b2252;">        defined."""</span>
        <span style="color: #a0522d;">thread</span> = current_thread()
        <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>.dicts[<span style="color: #483d8b;">id</span>(thread)][1]

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">create_dict</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #8b2252;">"""Create a new dict for the current thread, and return it."""</span>
        <span style="color: #a0522d;">localdict</span> = {}
        <span style="color: #a0522d;">key</span> = <span style="color: #a020f0;">self</span>.key
        <span style="color: #a0522d;">thread</span> = current_thread()
        <span style="color: #a0522d;">idt</span> = <span style="color: #483d8b;">id</span>(thread)
        <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">local_deleted</span>(_, key=key):
            <span style="color: #a0522d;">thread</span> = wrthread()
            <span style="color: #a020f0;">if</span> thread <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> <span style="color: #008b8b;">None</span>:
                <span style="color: #a020f0;">del</span> thread.<span style="color: #483d8b;">__dict__</span>[key]
        <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">thread_deleted</span>(_, idt=idt):
            <span style="color: #a0522d;">local</span> = wrlocal()
            <span style="color: #a020f0;">if</span> local <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> <span style="color: #008b8b;">None</span>:
                <span style="color: #a0522d;">dct</span> = local.dicts.pop(idt)
        <span style="color: #a0522d;">wrlocal</span> = ref(<span style="color: #a020f0;">self</span>, local_deleted)
        <span style="color: #a0522d;">wrthread</span> = ref(thread, thread_deleted)
        thread.<span style="color: #483d8b;">__dict__</span>[key] = wrlocal
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">dicts</span>[idt] = wrthread, localdict
        <span style="color: #a020f0;">return</span> localdict

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">local</span>:
    <span style="color: #a0522d;">__slots__</span> = <span style="color: #8b2252;">'_local__impl'</span>, <span style="color: #8b2252;">'__dict__'</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__new__</span>(cls, /, *args, **kw):
        <span style="color: #a020f0;">if</span> (args <span style="color: #a020f0;">or</span> kw) <span style="color: #a020f0;">and</span> (cls.__init__ <span style="color: #a020f0;">is</span> <span style="color: #483d8b;">object</span>.__init__):
            <span style="color: #a020f0;">raise</span> <span style="color: #228b22;">TypeError</span>(<span style="color: #8b2252;">"Initialization arguments are not supported"</span>)
        <span style="color: #a020f0;">self</span> = <span style="color: #483d8b;">object</span>.__new__(cls)
        <span style="color: #a0522d;">impl</span> = _localimpl()
        impl.<span style="color: #a0522d;">localargs</span> = (args, kw)
        impl.<span style="color: #a0522d;">locallock</span> = RLock()
        <span style="color: #483d8b;">object</span>.__setattr__(<span style="color: #a020f0;">self</span>, <span style="color: #8b2252;">'_local__impl'</span>, impl)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">We need to create the thread dict in anticipation of</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">__init__ being called, to make sure we don't call it</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">again ourselves.</span>
        impl.create_dict()
        <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__getattribute__</span>(<span style="color: #a020f0;">self</span>, name):
        <span style="color: #a020f0;">with</span> _patch(<span style="color: #a020f0;">self</span>):
            <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">object</span>.__getattribute__(<span style="color: #a020f0;">self</span>, name)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__setattr__</span>(<span style="color: #a020f0;">self</span>, name, value):
        <span style="color: #a020f0;">if</span> name == <span style="color: #8b2252;">'__dict__'</span>:
            <span style="color: #a020f0;">raise</span> <span style="color: #228b22;">AttributeError</span>(
                <span style="color: #8b2252;">"%r object attribute '__dict__' is read-only"</span>
                % <span style="color: #a020f0;">self</span>.__class__.<span style="color: #483d8b;">__name__</span>)
        <span style="color: #a020f0;">with</span> _patch(<span style="color: #a020f0;">self</span>):
            <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">object</span>.__setattr__(<span style="color: #a020f0;">self</span>, name, value)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__delattr__</span>(<span style="color: #a020f0;">self</span>, name):
        <span style="color: #a020f0;">if</span> name == <span style="color: #8b2252;">'__dict__'</span>:
            <span style="color: #a020f0;">raise</span> <span style="color: #228b22;">AttributeError</span>(
                <span style="color: #8b2252;">"%r object attribute '__dict__' is read-only"</span>
                % <span style="color: #a020f0;">self</span>.__class__.<span style="color: #483d8b;">__name__</span>)
        <span style="color: #a020f0;">with</span> _patch(<span style="color: #a020f0;">self</span>):
            <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">object</span>.__delattr__(<span style="color: #a020f0;">self</span>, name)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">local</span>:
    <span style="color: #a0522d;">__slots__</span> = <span style="color: #8b2252;">'_local__impl'</span>, <span style="color: #8b2252;">'__dict__'</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__new__</span>(cls, /, *args, **kw):
        &#21019;&#24314;local&#30340;&#23454;&#20363;&#24182;&#36820;&#22238;
        local&#23454;&#20363;&#21019;&#24314;&#20102;&#19968;&#20010;&#23646;&#24615;
        <span style="color: #483d8b;">setattr</span>(<span style="color: #a020f0;">self</span>, <span style="color: #8b2252;">'xxx'</span>, value) &#31561;&#20215;self.<span style="color: #a0522d;">xxx</span> =value &#37117;&#26159;&#35201;&#20351;&#29992;&#35813;&#31867;&#22411;&#23450;&#20041;&#30340;
        __setattr__&#26041;&#27861;&#65292;&#26412;&#36136;&#35843;&#29992;&#22522;&#31867;&#30340;&#35813;&#26041;&#27861;&#65292;&#35753;&#20182;&#24110;&#20320;&#23436;&#25104;&#23646;&#24615;&#30340;&#35774;&#32622;&#12290;
        local&#23454;&#20363;&#21019;&#24314;&#20102;_local__impl&#23646;&#24615;&#65292;&#26159;_localimpl&#23454;&#20363;(key, dicts{})
        impl.create_dict()
        <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__getattribute__</span>(<span style="color: #a020f0;">self</span>, name):
        <span style="color: #a020f0;">with</span> _patch(<span style="color: #a020f0;">self</span>):
            <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">object</span>.__getattribute__(<span style="color: #a020f0;">self</span>, name)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__setattr__</span>(<span style="color: #a020f0;">self</span>, name, value):
        <span style="color: #a020f0;">if</span> name == <span style="color: #8b2252;">'__dict__'</span>:
            <span style="color: #a020f0;">raise</span> <span style="color: #228b22;">AttributeError</span>(
                <span style="color: #8b2252;">"%r object attribute '__dict__' is read-only"</span>
                % <span style="color: #a020f0;">self</span>.__class__.<span style="color: #483d8b;">__name__</span>)
        <span style="color: #a020f0;">with</span> _patch(<span style="color: #a020f0;">self</span>):
            <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">object</span>.__setattr__(<span style="color: #a020f0;">self</span>, name, value)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">_localimpl</span>:
    <span style="color: #8b2252;">"""A class managing thread-local dicts"""</span>
    <span style="color: #a0522d;">__slots__</span> = <span style="color: #8b2252;">'key'</span>, <span style="color: #8b2252;">'dicts'</span>, <span style="color: #8b2252;">'localargs'</span>, <span style="color: #8b2252;">'locallock'</span>, <span style="color: #8b2252;">'__weakref__'</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">key</span> = <span style="color: #8b2252;">'_threading_local._localimpl.'</span> + <span style="color: #483d8b;">str</span>(<span style="color: #483d8b;">id</span>(<span style="color: #a020f0;">self</span>))
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">dicts</span> = {}

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_dict</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #8b2252;">"""Return the dict for the current thread. Raises KeyError if none</span>
<span style="color: #8b2252;">        defined."""</span>
        <span style="color: #a0522d;">thread</span> = current_thread()
        <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>.dicts[<span style="color: #483d8b;">id</span>(thread)][1]

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">create_dict</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #8b2252;">"""Create a new dict for the current thread, and return it."""</span>
        <span style="color: #a0522d;">localdict</span> = {} <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26412;&#22320;&#23383;&#20856;</span>
        <span style="color: #a0522d;">key</span> = <span style="color: #a020f0;">self</span>.key            <span style="color: #b22222;">#</span><span style="color: #b22222;">str(id(self))</span>
        <span style="color: #a0522d;">thread</span> = current_thread() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#32447;&#31243;&#23545;&#35937;</span>
        <span style="color: #a0522d;">idt</span> = <span style="color: #483d8b;">id</span>(thread)          <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32447;&#31243;&#23545;&#35937;&#30340;&#22320;&#22336;</span>
        <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">local_deleted</span>(_, key=key):
            <span style="color: #a0522d;">thread</span> = wrthread()
            <span style="color: #a020f0;">if</span> thread <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> <span style="color: #008b8b;">None</span>:
                <span style="color: #a020f0;">del</span> thread.<span style="color: #483d8b;">__dict__</span>[key]
        <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">thread_deleted</span>(_, idt=idt):
            <span style="color: #a0522d;">local</span> = wrlocal()
            <span style="color: #a020f0;">if</span> local <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> <span style="color: #008b8b;">None</span>:
                <span style="color: #a0522d;">dct</span> = local.dicts.pop(idt)
        <span style="color: #a0522d;">wrlocal</span> = ref(<span style="color: #a020f0;">self</span>, local_deleted)     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#32852;&#24341;&#26469;</span>
        <span style="color: #a0522d;">wrthread</span> = ref(thread, thread_deleted) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20851;&#32852;&#24341;&#26469;</span>
        thread.<span style="color: #483d8b;">__dict__</span>[key] = wrlocal         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#32447;&#31243;&#23545;&#35937;&#23383;&#20856;&#20013;&#22686;&#21152; self.key</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24403;&#21069;&#32447;&#31243;.[str(id(impl))] = </span>
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">dicts</span>[idt] = wrthread, localdict  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22823;&#23383;&#20856;</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">{id(currentthread): (, {})}</span>
        <span style="color: #a020f0;">return</span> localdict

<span style="color: #228b22;">@contextmanager</span>  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#19979;&#25991;&#20351;&#29992;&#20989;&#25968;&#65292;yeild&#20043;&#21069;&#30456;&#24403;&#20110;enter&#65292;yeild&#36820;&#22238;as</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_patch</span>(<span style="color: #a020f0;">self</span>):  <span style="color: #b22222;">#</span><span style="color: #b22222;">self&#26159;local&#23454;&#20363;</span>
    <span style="color: #a0522d;">impl</span> = <span style="color: #483d8b;">object</span>.__getattribute__(<span style="color: #a020f0;">self</span>, <span style="color: #8b2252;">'_local__impl'</span>)
    <span style="color: #a020f0;">try</span>:
        <span style="color: #a0522d;">dct</span> = impl.get_dict()  <span style="color: #b22222;">#</span><span style="color: #b22222;">self.dicts[id(currentthread)][1]</span>
    <span style="color: #a020f0;">except</span> <span style="color: #228b22;">KeyError</span>:
        <span style="color: #a0522d;">dct</span> = impl.create_dict()  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#24403;&#21069;&#32447;&#31243;&#21019;&#24314;&#23567;&#23383;&#20856;</span>
        <span style="color: #a0522d;">args</span>, <span style="color: #a0522d;">kw</span> = impl.localargs
        <span style="color: #a020f0;">self</span>.__init__(*args, **kw)
    <span style="color: #a020f0;">with</span> impl.locallock:
        <span style="color: #483d8b;">object</span>.__setattr__(<span style="color: #a020f0;">self</span>, <span style="color: #8b2252;">'__dict__'</span>, dct) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22312;local&#23545;&#35937;&#19978;&#20570;&#23567;&#23383;&#20856;&#30340;&#20999;&#25442;</span>
        <span style="color: #a020f0;">yield</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">--------</span>
<span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> logging
<span style="color: #a020f0;">import</span> time

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">"%(asctime)s %(threadName)s %(thread)d %(message)s"</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO, datefmt=<span style="color: #8b2252;">"%Y-%m-%d %H:%M:%S"</span>)

<span style="color: #a0522d;">g_data</span> = threading.loacl() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23646;&#24615;_local__impl -&gt; imple() key, dicts{} #&#22823;&#23383;&#20856;&#20013;&#26377;&#19968;&#20010;&#23567;&#23383;&#20856;&#21644;&#20027;&#32447;&#31243;&#30456;&#20851;</span>

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>():
    g_data.<span style="color: #a0522d;">x</span> = 0 <span style="color: #b22222;"># </span><span style="color: #b22222;">x &#23646;&#24615;&#21644;&#32447;&#31243;&#30456;&#20851;&#65292;&#29992;&#24037;&#20316;&#32447;&#31243;&#30340;&#22320;&#22336;</span>

    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(1000):
        time.sleep(0.0001)
        g_data.<span style="color: #a0522d;">x</span> += 1

    logging.info(<span style="color: #8b2252;">"x = {}"</span>.<span style="color: #483d8b;">format</span>(g_data.x))

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(10):
    threading.Thread(target=worker, name=<span style="color: #8b2252;">'w{}'</span>.<span style="color: #483d8b;">format</span>(i), ).start()
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:7858a7f9-54f8-4340-9971-7960bc7b7cbe" class="outline-2">
<h2 id="h:7858a7f9-54f8-4340-9971-7960bc7b7cbe">线程同步</h2>
<div class="outline-text-2" id="text-h:7858a7f9-54f8-4340-9971-7960bc7b7cbe">
</div>
<div id="outline-container-h:0fc3d129-cb2d-4552-a23f-bc84812e6bb2" class="outline-3">
<h3 id="h:0fc3d129-cb2d-4552-a23f-bc84812e6bb2">概念</h3>
<div class="outline-text-3" id="text-h:0fc3d129-cb2d-4552-a23f-bc84812e6bb2">
<p>
线程同步，线程间协同，通过某种技术，让一个线程访问某些数据时，其他线程不能访问这些数据，直到该线程完成对数据的操作。
</p>
</div>
</div>
<div id="outline-container-h:7559fa45-c9ab-4dcd-86c5-c10f97a87c14" class="outline-3">
<h3 id="h:7559fa45-c9ab-4dcd-86c5-c10f97a87c14">Event***</h3>
<div class="outline-text-3" id="text-h:7559fa45-c9ab-4dcd-86c5-c10f97a87c14">
<p>
Event事件，是线程间通信机制中最简单的实现，使用一个内部的标记flag，通过flag的True或False的变化来进行操作。
</p>

<pre class="example" id="org2a4ec37">
set()                 标记设置为True
clear()               标记设置为False
is_set()              标记是否为True
wait(timeout=None)    设置等待标记为True的时长，None为无限等待。等到返回True，未等到超时了返回False
</pre>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Event
<span style="color: #a020f0;">import</span> time

<span style="color: #a0522d;">e</span> = Event()

<span style="color: #483d8b;">print</span>(e)
<span style="color: #483d8b;">print</span>(e.is_set()) <span style="color: #b22222;">#</span><span style="color: #b22222;">False</span>
<span style="color: #483d8b;">print</span>(e.wait(1)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38459;&#22622;1&#31186;&#65292;&#22914;&#26524;&#19981;&#20889;&#20250;&#19968;&#30452;&#31561;&#24453;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Event
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">fn</span>(e:Event):
    time.sleep(2)
    e.<span style="color: #483d8b;">set</span>() <span style="color: #b22222;">#</span><span style="color: #b22222;">1</span>


<span style="color: #a0522d;">e</span> = Event()

<span style="color: #483d8b;">print</span>(e)
<span style="color: #483d8b;">print</span>(e.is_set())

threading.Thread(target=fn,args=(e,)).start()

<span style="color: #483d8b;">print</span>(e.wait(5)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38459;&#22622;5&#31186;, &#36825;&#37324;&#31561;&#20102;2&#31186;</span>

e.clear() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28165;&#31354;&#20107;&#20214;</span>
</pre>
</div>
</div>
<div id="outline-container-h:020e5e30-c1e3-4a48-9c2f-b38b5333a142" class="outline-4">
<h4 id="h:020e5e30-c1e3-4a48-9c2f-b38b5333a142">练习</h4>
<div class="outline-text-4" id="text-h:020e5e30-c1e3-4a48-9c2f-b38b5333a142">
<p>
老板雇佣了一个工人，让他生产杯子，老板一直等着这个工人，直到生产了10个杯子
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Event
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">"%(asctime)s %(threadName)s %(thread)d %(message)s"</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT,level=logging.INFO)

<span style="color: #a0522d;">cups</span> = []
<span style="color: #a0522d;">flag</span> = <span style="color: #008b8b;">False</span>

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">boss</span>():
    logging.info(<span style="color: #8b2252;">"I'm boss, waiting for you"</span>)
    <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> flag:  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36718;&#35810;</span>
        time.sleep(0.5)
    logging.info(<span style="color: #8b2252;">"Good job."</span>)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(count=10):
    logging.info(<span style="color: #8b2252;">'I</span><span style="color: #008b8b;">\'</span><span style="color: #8b2252;">m worker for you'</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">cups = []</span>
    <span style="color: #a020f0;">global</span> flag
    <span style="color: #a020f0;">while</span> <span style="color: #483d8b;">len</span>(cups) &lt; count:
        time.sleep(0.5)
        cups.append(1)
        logging.info(<span style="color: #8b2252;">'made one cup'</span>)
    <span style="color: #a0522d;">flag</span> = <span style="color: #008b8b;">True</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#24847;&#36825;&#37324;</span>
    logging.info(<span style="color: #8b2252;">'Finished my job'</span>)

<span style="color: #a0522d;">b</span> = threading.Thread(target=boss, name=<span style="color: #8b2252;">'boss'</span>)
<span style="color: #a0522d;">w</span> = threading.Thread(target=worker, name=<span style="color: #8b2252;">'worker'</span>)

b.start()
w.start()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:06:30,864 boss 29476 I'm boss, waiting for you</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:06:30,865 worker 11820 I'm worker for you</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:06:31,366 worker 11820 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:06:31,866 worker 11820 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:06:32,367 worker 11820 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:06:32,869 worker 11820 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:06:33,369 worker 11820 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:06:33,871 worker 11820 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:06:34,372 worker 11820 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:06:34,873 worker 11820 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:06:35,374 worker 11820 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:06:35,875 worker 11820 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:06:35,876 worker 11820 Finished my job</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:06:36,370 boss 29476 Good job.</span>
</pre>
</div>

<p>
使用Event
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Event
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">"%(asctime)s %(threadName)s %(thread)d %(message)s"</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT,level=logging.INFO)


<span style="color: #a0522d;">cups</span> = []
<span style="color: #a0522d;">event</span> = Event()

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">boss</span>(e:Event):
    logging.info(<span style="color: #8b2252;">"I'm boss, waiting for you"</span>)
    e.wait() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#30452;&#31561;&#65292;&#31561;&#21040;0-&gt;1</span>
    logging.info(<span style="color: #8b2252;">"Good job."</span>)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(e:Event, count=10):
    logging.info(<span style="color: #8b2252;">'I</span><span style="color: #008b8b;">\'</span><span style="color: #8b2252;">m worker for you'</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">cups = []</span>
    <span style="color: #a020f0;">global</span> flag
    <span style="color: #a020f0;">while</span> <span style="color: #483d8b;">len</span>(cups) &lt; count:
        time.sleep(0.5)
        cups.append(1)
        logging.info(<span style="color: #8b2252;">'made one cup'</span>)
    e.<span style="color: #483d8b;">set</span>() <span style="color: #b22222;">#</span><span style="color: #b22222;">0 -&gt; 1</span>
    logging.info(<span style="color: #8b2252;">'Finished my job'</span>)

<span style="color: #a0522d;">b</span> = threading.Thread(target=boss, name=<span style="color: #8b2252;">'boss1'</span>, args=(event,))
<span style="color: #a0522d;">w</span> = threading.Thread(target=worker, name=<span style="color: #8b2252;">'worker'</span>, args=(event,))

b.start()
threading.Thread(target=boss, name=<span style="color: #8b2252;">'boss2'</span>, args=(event,)).start()
w.start()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:23:11,029 boss1 25008 I'm boss, waiting for you</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:23:11,029 boss2 14672 I'm boss, waiting for you</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:23:11,029 worker 29412 I'm worker for you</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:23:11,530 worker 29412 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:23:12,031 worker 29412 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:23:12,532 worker 29412 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:23:13,033 worker 29412 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:23:13,533 worker 29412 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:23:14,035 worker 29412 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:23:14,536 worker 29412 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:23:15,038 worker 29412 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:23:15,538 worker 29412 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:23:16,039 worker 29412 made one cup</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:23:16,040 worker 29412 Finished my job</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:23:16,040 boss2 14672 Good job.</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-07 14:23:16,040 boss1 25008 Good job.</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b47efafe-b4bb-436c-a571-aaf31e002259" class="outline-4">
<h4 id="h:b47efafe-b4bb-436c-a571-aaf31e002259">总结</h4>
<div class="outline-text-4" id="text-h:b47efafe-b4bb-436c-a571-aaf31e002259">
<ul class="org-ul">
<li>需要使用同一个Event对象的标记flag</li>
<li>谁wait就是等到flag变为True，或等到超时返回False</li>
<li>不限制等待的个数，通知所有等待者</li>
</ul>
</div>
</div>
<div id="outline-container-h:110966fe-7b86-45be-95fb-130b940e0fc3" class="outline-4">
<h4 id="h:110966fe-7b86-45be-95fb-130b940e0fc3">wait的使用</h4>
<div class="outline-text-4" id="text-h:110966fe-7b86-45be-95fb-130b940e0fc3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Event
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">"%(asctime)s %(threadName)s %(thread)d %(message)s"</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT,level=logging.INFO)


<span style="color: #a0522d;">cups</span> = []
<span style="color: #a0522d;">event</span> = threading.Event()

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(e:Event, count=10):
    logging.info(<span style="color: #8b2252;">'I</span><span style="color: #008b8b;">\'</span><span style="color: #8b2252;">m worker for you'</span>)
    <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> event.wait(0.5): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#27425;&#31561;0.5&#31186;&#25191;&#34892;</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">time.sleep(0.5)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">event.wait(0.5)</span>
        cups.append(1)
        logging.info(<span style="color: #8b2252;">'made one cup'</span>)
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(cups) &gt;= count:
            event.<span style="color: #483d8b;">set</span>()
            <span style="color: #b22222;"># </span><span style="color: #b22222;">break</span>
    logging.info(<span style="color: #8b2252;">'Finished my job'</span>)

<span style="color: #a0522d;">w</span> = threading.Thread(target=worker, name=<span style="color: #8b2252;">'worker'</span>, args=(event,))
w.start()
</pre>
</div>

<p>
或者
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(e:Event, count=10):
    logging.info(<span style="color: #8b2252;">'I</span><span style="color: #008b8b;">\'</span><span style="color: #8b2252;">m worker for you'</span>)
    <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> event.is_set(): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27599;&#27425;&#31561;0.5&#31186;&#25191;&#34892;</span>
        time.sleep(0.5)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">event.wait(0.5)</span>
        cups.append(1)
        logging.info(<span style="color: #8b2252;">'made one cup'</span>)
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(cups) &gt;= count:
            event.<span style="color: #483d8b;">set</span>()
            <span style="color: #b22222;"># </span><span style="color: #b22222;">break</span>
    logging.info(<span style="color: #8b2252;">'Finished my job'</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fbd12a9a-6881-4faa-ba4c-10b5e484d399" class="outline-4">
<h4 id="h:fbd12a9a-6881-4faa-ba4c-10b5e484d399">定时器 Timer/延迟执行</h4>
<div class="outline-text-4" id="text-h:fbd12a9a-6881-4faa-ba4c-10b5e484d399">
<p>
threading.Timer继承自Thread，这个类用来定义延迟多久后执行一个函数
</p>

<pre class="example" id="org00dbd93">
class threading.Timer(interval, function, args=None, kwargs=None)
</pre>

<p>
start方法执行之后，Timer对象会处于等待状态，等待了interval秒之后，开始执行function函数的
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Timer <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#26102;&#22120;</span>
<span style="color: #a020f0;">import</span> time

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(name):
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'{} is working'</span>.<span style="color: #483d8b;">format</span>(name))
    time.sleep(1)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'finished'</span>)

<span style="color: #a0522d;">t</span> = Timer(3, worker, args=(<span style="color: #8b2252;">'tom'</span>,))  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#26102;&#22120;&#65292;&#24310;&#36831;3&#31186;&#25191;&#34892;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">t.cancel() #&#21462;&#28040;&#23450;&#26102;&#22120;, &#22312;start&#21069;&#65292;&#21518;&#38754;start&#26080;&#25928;&#12290;</span>
t.start()
<span style="color: #b22222;"># </span><span style="color: #b22222;">t.cancel() #&#21462;&#28040;&#23450;&#26102;&#22120;</span>

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'==main exit=='</span>)
</pre>
</div>

<p>
上例代码工作线程早就启动了，只不过是在工作线程中延时了3秒才执行了worker函数
</p>

<p>
Timer是线程Thread的子类，Timer实例内部提供了一个finished属性，该属性是
Event对象。cancel方法，本质上是在worker函数执行前对finished属性set方法
操作，从而跳过了worker函数执行，达到了取消的效果
</p>

<p>
总结：
</p>
<ul class="org-ul">
<li>Timer是线程Thread的子类，就是线程类，具有线程的能力和特征</li>
<li>它的实例是能够延时执行目标函数的线程，在真正执行目标函数之前，都可以cancel它</li>
<li>cancel方法本质使用Event类实现。这并不是说，线程提供了取消的方法</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:3623e19d-a7e2-4cce-b425-aa5f3992cfdc" class="outline-3">
<h3 id="h:3623e19d-a7e2-4cce-b425-aa5f3992cfdc">Lock***</h3>
<div class="outline-text-3" id="text-h:3623e19d-a7e2-4cce-b425-aa5f3992cfdc">
<p>
锁，一旦线程获得锁，其它试图获取锁的线程将被阻塞。
</p>

<p>
锁：凡是存在共享资源争抢的地方都可以使用锁，从而保证只有一个使用者可以完全使用这个资源
</p>

<pre class="example" id="orgf4553d8">
acquire(blocking=True, timeout=-1)
默认阻塞，阻塞可以设置超时时间。非阻塞时，timeout禁止设置
成功获取锁，返回True，否则返回False

release()
释放锁。可以从任何线程调用释放
已上锁的锁，会被重置为unlocked未上锁的锁上调用，抛RuntimeError异常
</pre>

<p>
锁的基本使用
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading 
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Timer

<span style="color: #a0522d;">lock</span> = threading.Lock()

<span style="color: #a0522d;">x</span> = lock.acquire() <span style="color: #b22222;">#</span><span style="color: #b22222;">True &#25343;&#21040;&#20102;</span>
<span style="color: #483d8b;">print</span>(x)
<span style="color: #a0522d;">y</span> = lock.acquire(timeout=2) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25343;&#21040;&#38145;&#21518;&#65292;&#20877;&#25343;&#65292;&#22914;&#26524;&#27809;&#26377;timeout&#65292;&#20250;&#19968;&#30452;&#31561;&#24453;</span>
<span style="color: #483d8b;">print</span>(y)
<span style="color: #a0522d;">z</span> = lock.acquire(<span style="color: #008b8b;">False</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38750;&#38459;&#22622;</span>
<span style="color: #483d8b;">print</span>(z)
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(lock.acquire(False, timeout=2)) #&#25253;&#38169;ValueError&#12290;&#38750;&#38459;&#22622;&#19981;&#21487;&#20197;&#35774;&#32622;&#36229;&#26102;</span>

lock.release() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37322;&#25918;&#38145;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">False</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">False</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading

<span style="color: #a0522d;">l</span> = threading.Lock()

<span style="color: #483d8b;">print</span>(l.acquire(<span style="color: #008b8b;">False</span>))
<span style="color: #483d8b;">print</span>(l.acquire(<span style="color: #008b8b;">False</span>))

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">True</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">False</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading 
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Timer
<span style="color: #a020f0;">import</span> logging

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">"%(asctime)s %(threadName)s %(thread)d %(message)s"</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #a0522d;">lock</span> = threading.Lock()
<span style="color: #a0522d;">x</span> = lock.acquire() <span style="color: #b22222;">#</span><span style="color: #b22222;">True &#25343;&#21040;&#20102;</span>
<span style="color: #483d8b;">print</span>(x)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(l:threading.Lock):
    <span style="color: #a0522d;">name</span> = threading.current_thread().name
    <span style="color: #483d8b;">print</span>(name, <span style="color: #8b2252;">'want to get locker'</span>)
    logging.info(l.acquire())
    <span style="color: #483d8b;">print</span>(name, <span style="color: #8b2252;">'finished'</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">lock.release() #&#37322;&#25918;</span>

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
    threading.Thread(target=worker, name=<span style="color: #8b2252;">'w{}'</span>.<span style="color: #483d8b;">format</span>(i), args=(lock,)).start()

<span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
    time.sleep(1)
    <span style="color: #a0522d;">cmd</span> = <span style="color: #483d8b;">input</span>(<span style="color: #8b2252;">'&gt;&gt;&gt;'</span>).strip()
    <span style="color: #a020f0;">if</span> cmd == <span style="color: #8b2252;">'r'</span>:
        lock.release()
    <span style="color: #a020f0;">elif</span> cmd == <span style="color: #8b2252;">'quit'</span>:
        <span style="color: #a020f0;">break</span>
    <span style="color: #a020f0;">else</span>:
        <span style="color: #483d8b;">print</span>(threading.<span style="color: #483d8b;">enumerate</span>())
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">True
w0 want to get locker
w1 want to get locker
w2 want to get locker
w3 want to get locker
w4 want to get locker
&gt;&gt;&gt;
[&lt;_MainThread(MainThread, started 19956)&gt;, &lt;Thread(w0, started 13524)&gt;, &lt;Thread(w1, started 18416)&gt;, &lt;Thread(w2, started 16556)&gt;, &lt;Thread(w3, started 12748)&gt;, &lt;Thread(w4, started 2396)&gt;]
&gt;&gt;&gt;r
2025-03-09 11:49:13,210 w0 13524 True
w0 finished
&gt;&gt;&gt;r
2025-03-09 11:49:44,730 w1 18416 True
w1 finished
&gt;&gt;&gt;r
2025-03-09 11:49:59,880 w2 16556 True
w2 finished
&gt;&gt;&gt;r
2025-03-09 11:50:01,878 w3 12748 True
w3 finished
&gt;&gt;&gt;r
2025-03-09 11:50:04,629 w4 2396 True
w4 finished
&gt;&gt;&gt;
[&lt;_MainThread(MainThread, started 19956)&gt;]
&gt;&gt;&gt;r
&gt;&gt;&gt;r
<span style="color: #0000ff;">Traceback</span> (most recent call last):
  File <span style="color: #8b2252;">"d:\project\pyprojs\cursor\t.py"</span>, line 28,<span style="color: #a020f0;"> in</span> &lt;module&gt;
    lock.release()
    ~~~~~~~~~~~~^^
RuntimeError: release unlocked lock
</pre>
</div>

<p>
上例可以看出不管在哪一个线程中，只要对一个已经上锁的锁阻塞请求，该线程就会阻塞。
</p>
</div>
<div id="outline-container-h:6436f3b0-82ed-46c6-97f3-4f14699f8816" class="outline-4">
<h4 id="h:6436f3b0-82ed-46c6-97f3-4f14699f8816">练习</h4>
<div class="outline-text-4" id="text-h:6436f3b0-82ed-46c6-97f3-4f14699f8816">
<p>
订单要求生产1000个杯子，组织10个工人生产。请忽略老板，关注工人生成杯子
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading 
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Timer
<span style="color: #a020f0;">import</span> logging

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">"%(asctime)s %(threadName)s %(thread)d %(message)s"</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #a0522d;">lock</span> = threading.Lock()
<span style="color: #a0522d;">cups</span> = []

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(l:threading.Lock, count=1000):
    logging.info(<span style="color: #8b2252;">'{} is working'</span>.<span style="color: #483d8b;">format</span>(threading.current_thread().name))
    <span style="color: #a020f0;">while</span> <span style="color: #483d8b;">len</span>(cups) &lt; count:
        time.sleep(0.0001)
        cups.append(1)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">logging.info('made one')</span>
    logging.info(<span style="color: #8b2252;">'{} finishe. cups={}'</span>.<span style="color: #483d8b;">format</span>(threading.current_thread().name, <span style="color: #483d8b;">len</span>(cups)))


<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
    threading.Thread(target=worker, name=<span style="color: #8b2252;">'w{}'</span>.<span style="color: #483d8b;">format</span>(i), args=(lock, 1000)).start()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:24:33,671 w0 3844 w0 is working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:24:33,672 w1 21328 w1 is working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:24:33,673 w2 21200 w2 is working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:24:33,673 w3 20700 w3 is working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:24:33,674 w4 20072 w4 is working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:24:33,787 w0 3844 w0 finishe. cups=1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:24:33,788 w4 20072 w4 finishe. cups=1001</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:24:33,788 w3 20700 w3 finishe. cups=1002</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:24:33,788 w1 21328 w1 finishe. cups=1003</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:24:33,788 w2 21200 w2 finishe. cups=1004</span>
</pre>
</div>

<p>
为什么多生产了？ 多线程调度，导致了判断失效，多生产了杯子。如何修改？加锁。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading 
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Timer
<span style="color: #a020f0;">import</span> logging

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">"%(asctime)s %(threadName)s %(thread)d %(message)s"</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #a0522d;">lock</span> = threading.Lock()
<span style="color: #a0522d;">cups</span> = []

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(l:threading.Lock, count=1000):
    logging.info(<span style="color: #8b2252;">'{} is working'</span>.<span style="color: #483d8b;">format</span>(threading.current_thread().name))
    <span style="color: #a0522d;">flag</span> = <span style="color: #008b8b;">False</span>
    <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
        l.acquire()         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#38145;</span>
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(cups) &gt;= count:
            <span style="color: #a0522d;">flag</span> = <span style="color: #008b8b;">True</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">l.release()       #1&#37322;&#25918;&#38145;? &#32447;&#31243;&#19981;&#23433;&#20840;&#65292;</span>
        time.sleep(0.001)   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20026;&#20102;&#30475;&#20986;&#32447;&#31243;&#20999;&#25442;&#25928;&#26524;</span>
        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> flag:
            cups.append(1)
        l.release()         <span style="color: #b22222;">#</span><span style="color: #b22222;">2&#37322;&#25918;&#38145;?</span>
        <span style="color: #a020f0;">if</span> flag:
            <span style="color: #a020f0;">break</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">l.release()         #3&#37322;&#25918;&#38145;? &#20250;&#27515;&#38145;&#12290; flag=True &#26102;&#65292;&#20250;&#27515;&#38145;&#12290;</span>

    logging.info(<span style="color: #8b2252;">'{} finishe. cups={}'</span>.<span style="color: #483d8b;">format</span>(threading.current_thread().name, <span style="color: #483d8b;">len</span>(cups)))


<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
    threading.Thread(target=worker, name=<span style="color: #8b2252;">'w{}'</span>.<span style="color: #483d8b;">format</span>(i), args=(lock, )).start()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:54:13,637 w0 6896 w0 is working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:54:13,638 w1 5812 w1 is working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:54:13,639 w2 21308 w2 is working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:54:13,640 w3 11152 w3 is working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:54:13,640 w4 1556 w4 is working</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:54:15,417 w4 1556 w4 finishe. cups=1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:54:15,419 w0 6896 w0 finishe. cups=1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:54:15,421 w2 21308 w2 finishe. cups=1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:54:15,423 w3 11152 w3 finishe. cups=1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 16:54:15,424 w1 5812 w1 finishe. cups=1000</span>
</pre>
</div>

<p>
上例中共有三处可以释放锁。只有第二出释放锁的位置正确
</p>

<p>
假设位置1的lock.release()合适，分析如下：
</p>

<p>
有一个时刻，在某一个线程中len(cups)正好是999，flag=True，释放锁，正好
线程被打断。另一个线程判断发现也是999，flag=True，可能线程被打断。可能
另外一个线程也判断是999，flag也设置为True。这三个线程只要继续执行到
cups.append(1)，一定会导致cups的长度超过1000的。
</p>

<p>
假设位置2的lock.release()合适，分析如下：
</p>

<p>
在某一个时刻len(cups)，正好是999，flag=True，其它线程试图访问这段代码
的线程都阻塞获取不到锁，直到当前线程安全的增加了一个数据，然后释放锁。
其它线程有一个抢到锁，但发现已经1000了，只好break打印退出。再其它线程
都一样，发现已经1000了，都退出了。
</p>

<p>
所以位置2 释放锁 是正确的。
</p>

<p>
但是我们发现锁保证了数据完整性，但是性能下降很多。
</p>

<p>
上例中位置3，if flag:break是为了保证位置2的release方法被执行，否则，就出现了死锁，得到锁的永远没有释放锁。
</p>


<p>
计数器类，可以加，可以减。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">t.py&#25991;&#20214;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Balancer</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">_value</span> = 0

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">inc</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">_value</span> += 1

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">dec</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">_value</span> -= 1

    @<span style="color: #483d8b;">property</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">value</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>._value

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">run</span>(c:Balancer, count=100):
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(count):
        <span style="color: #a020f0;">for</span> j <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(-50, 50):
            <span style="color: #a020f0;">if</span> j &lt; 0:
                c.dec()
            <span style="color: #a020f0;">else</span>:
                c.inc()

<span style="color: #b22222;">#</span><span style="color: #b22222;">t2.py</span>
<span style="color: #a020f0;">from</span> t <span style="color: #a020f0;">import</span> Balancer, run
<span style="color: #a020f0;">import</span> threading

<span style="color: #a0522d;">c</span> = Balancer()
<span style="color: #a0522d;">threads</span> = 10
<span style="color: #a0522d;">count</span> = 1000 <span style="color: #b22222;">#</span><span style="color: #b22222;">10 &#32467;&#26524;&#26159;0&#65292;100&#32467;&#26524;&#26159;0&#65292; 1000&#32467;&#26524;&#26159;&#65311; &#21487;&#33021;&#26102;&#38388;&#29255;&#29992;&#23436;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#20010;&#32447;&#31243;&#20013;&#29992;&#21040;&#21516;&#19968;&#20010;&#23545;&#35937;&#65292;&#21487;&#33021;&#20250;&#23548;&#33268;&#25968;&#25454;&#19981;&#19968;&#33268;</span>

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(threads):
    threading.Thread(
        target=run, 
        args=(c, count), 
        name=<span style="color: #8b2252;">'balancer-{}'</span>.<span style="color: #483d8b;">format</span>(i)
    ).start()

<span style="color: #483d8b;">print</span>(c.value)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524; &#21487;&#33021;&#26159;0 &#21487;&#33021;&#26159;&#20854;&#20182;</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">t.py&#25991;&#20214;</span>
<span style="color: #a020f0;">import</span> threading

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Balancer</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">_value</span> = 0
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__lock</span> = threading.Lock()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">inc</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">self</span>.__lock.acquire()
        <span style="color: #a020f0;">try</span>:
            <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">_value</span> += 1
        <span style="color: #a020f0;">finally</span>:
            <span style="color: #a020f0;">self</span>.__lock.release()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">dec</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">with</span> <span style="color: #a020f0;">self</span>.__lock:
            <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">_value</span> -= 1

    @<span style="color: #483d8b;">property</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">value</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">with</span> <span style="color: #a020f0;">self</span>.__lock:
            <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>._value <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38656;&#35201;&#21152;&#38145;&#21527;&#65311;</span>

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">run</span>(c:Balancer, count=100):
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(count):
        <span style="color: #a020f0;">for</span> j <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(-50, 50):
            <span style="color: #a020f0;">if</span> j &lt; 0:
                c.dec()
            <span style="color: #a020f0;">else</span>:
                c.inc()

<span style="color: #b22222;">#</span><span style="color: #b22222;">t2.py&#25991;&#20214;</span>
<span style="color: #a020f0;">from</span> t <span style="color: #a020f0;">import</span> Balancer, run
<span style="color: #a020f0;">import</span> threading

<span style="color: #a0522d;">c</span> = Balancer()
<span style="color: #a0522d;">threads</span> = 10
<span style="color: #a0522d;">count</span> = 1000 <span style="color: #b22222;">#</span><span style="color: #b22222;">10 &#32467;&#26524;&#26159;0&#65292;100&#32467;&#26524;&#26159;0&#65292; 1000&#32467;&#26524;&#26159;&#65311; &#21487;&#33021;&#26102;&#38388;&#29255;&#29992;&#23436;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#20010;&#32447;&#31243;&#20013;&#29992;&#21040;&#21516;&#19968;&#20010;&#23545;&#35937;&#65292;&#21487;&#33021;&#20250;&#23548;&#33268;&#25968;&#25454;&#19981;&#19968;&#33268;</span>

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(threads):
    threading.Thread(
        target=run, 
        args=(c, count), 
        name=<span style="color: #8b2252;">'balancer-{}'</span>.<span style="color: #483d8b;">format</span>(i)
    ).start()

<span style="color: #483d8b;">print</span>(c.value)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32467;&#26524;&#26159; -128 -139 .. &#20026;&#20160;&#20040;&#65311;  &#20027;&#32447;&#31243;&#25552;&#21069;&#35835;&#20102;</span>
</pre>
</div>

<p>
之所以读属性的时候也要加锁，原因在于，如果不加锁，那么就可以读取到脏数据。例如写法
in, 它修改了一次数据，这是临时的修改，如果出现了异常，这个数据一定不算数。
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">t.py&#25991;&#20214;</span>
<span style="color: #a020f0;">import</span> threading

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Balancer</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">_value</span> = 0
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">__lock</span> = threading.Lock()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">inc</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">self</span>.__lock.acquire()
        <span style="color: #a020f0;">try</span>:
            <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">_value</span> += 1
        <span style="color: #a020f0;">finally</span>:
            <span style="color: #a020f0;">self</span>.__lock.release()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">dec</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">with</span> <span style="color: #a020f0;">self</span>.__lock:
            <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">_value</span> -= 1

    @<span style="color: #483d8b;">property</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">value</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">with</span> <span style="color: #a020f0;">self</span>.__lock:
            <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>._value <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38656;&#35201;&#21152;&#38145;&#21527;&#65311;</span>

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">run</span>(c:Balancer, count=100):
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(count):
        <span style="color: #a020f0;">for</span> j <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(-50, 50):
            <span style="color: #a020f0;">if</span> j &lt; 0:
                c.dec()
            <span style="color: #a020f0;">else</span>:
                c.inc()

<span style="color: #b22222;">#</span><span style="color: #b22222;">t2.py&#25991;&#20214;</span>
<span style="color: #a020f0;">from</span> t <span style="color: #a020f0;">import</span> Balancer, run
<span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time

<span style="color: #a0522d;">c</span> = Balancer()
<span style="color: #a0522d;">threads</span> = 10
<span style="color: #a0522d;">count</span> = 1000 <span style="color: #b22222;">#</span><span style="color: #b22222;">10 &#32467;&#26524;&#26159;0&#65292;100&#32467;&#26524;&#26159;0&#65292; 1000&#32467;&#26524;&#26159;&#65311; &#21487;&#33021;&#26102;&#38388;&#29255;&#29992;&#23436;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#20010;&#32447;&#31243;&#20013;&#29992;&#21040;&#21516;&#19968;&#20010;&#23545;&#35937;&#65292;&#21487;&#33021;&#20250;&#23548;&#33268;&#25968;&#25454;&#19981;&#19968;&#33268;</span>

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(threads):
    threading.Thread(
        target=run, 
        args=(c, count), 
        name=<span style="color: #8b2252;">'balancer-{}'</span>.<span style="color: #483d8b;">format</span>(i)
    ).start()

<span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
    time.sleep(2)
    <span style="color: #a020f0;">if</span> threading.active_count() == 1:
        <span style="color: #483d8b;">print</span>(c.value)
        <span style="color: #a020f0;">break</span>
    <span style="color: #a020f0;">else</span>: 
        <span style="color: #483d8b;">print</span>(threading.<span style="color: #483d8b;">enumerate</span>())
</pre>
</div>

<p>
返回结果
</p>
<pre class="example" id="orge986f9a">
[&lt;_MainThread(MainThread, started 19780)&gt;, &lt;Thread(balancer-1, started 22952)&gt;, &lt;Thread(balancer-2, started 2412)&gt;, &lt;Thread(balancer-3, started 22220)&gt;, &lt;Thread(balancer-4, started 24804)&gt;, &lt;Thread(balancer-5, started 6336)&gt;, &lt;Thread(balancer-6, started 24836)&gt;, &lt;Thread(balancer-7, started 20036)&gt;, &lt;Thread(balancer-8, started 24124)&gt;, &lt;Thread(balancer-9, started 23072)&gt;]
[&lt;_MainThread(MainThread, started 19780)&gt;, &lt;Thread(balancer-1, started 22952)&gt;, &lt;Thread(balancer-2, started 2412)&gt;, &lt;Thread(balancer-3, started 22220)&gt;, &lt;Thread(balancer-4, started 24804)&gt;, &lt;Thread(balancer-5, started 6336)&gt;, &lt;Thread(balancer-6, started 24836)&gt;, &lt;Thread(balancer-7, started 20036)&gt;, &lt;Thread(balancer-8, started 24124)&gt;, &lt;Thread(balancer-9, started 23072)&gt;]
0
</pre>

<p>
对于同一个数据，多个线程争着写入，一般来说都需要加锁，保证只有一个线程能够写入，直到
成功写入，释放锁。
</p>
</div>
</div>
<div id="outline-container-h:2a04bc2f-514b-4b3b-8860-23fe5eb650fe" class="outline-4">
<h4 id="h:2a04bc2f-514b-4b3b-8860-23fe5eb650fe">加锁、解锁</h4>
<div class="outline-text-4" id="text-h:2a04bc2f-514b-4b3b-8860-23fe5eb650fe">
<p>
一般来说，加锁就需要解锁，但是加锁后解锁前，还要有一些代码执行，就有可
能抛异常，一旦出现异常，锁是无法释放，但是当前线程可能因为这个异常被终
止了，这也产生了死锁。
</p>

<p>
加锁、解锁常用语句：
</p>
<ul class="org-ul">
<li>使用try&#x2026;finally语句保证锁的释放</li>
<li>with上下文管理，锁对象支持上下文管理</li>
</ul>
</div>
</div>
<div id="outline-container-h:afacce3f-4f6d-4260-a5b1-1c0bdadbe0a9" class="outline-4">
<h4 id="h:afacce3f-4f6d-4260-a5b1-1c0bdadbe0a9">锁的应用场景</h4>
<div class="outline-text-4" id="text-h:afacce3f-4f6d-4260-a5b1-1c0bdadbe0a9">
<p>
锁适用于访问和修改同一个共享资源的时候，即读写同一个资源的时候。
</p>

<p>
如果全部都是读取同一个共享资源不需要加锁，因为这时可以认为共享资源是不可变的，每一次读取它都是一样的值，所以不用加锁。
</p>

<p>
使用锁的注意事项：
</p>
<ul class="org-ul">
<li>少用锁，必要时用锁。使用了锁，多线程访问被锁的资源时，就成了串行，要么排队执行，要么争抢执行
<ul class="org-ul">
<li>举例，高速公路上车并行跑，可是到了省界只开放了一个收费口，过了这个
口，车辆依然可以在多车道上一起跑。过收费口的时候，如果排队一辆辆过，
加不加锁一样效率相当，但是一旦出现争抢，就必须加锁一辆辆过。注意，
不管加不加锁，只要是一辆辆过，效率就下降了</li>
</ul></li>
<li>加锁时间越短越好，不需要就立即释放锁</li>
<li>一定要避免死锁</li>
</ul>

<p>
不使用锁，有了效率，但是结果是错的。
</p>

<p>
使用了锁，效率低下，但是结果是对的。
</p>

<p>
但是为了保证数据的正确性，必要时还是得需要使用锁。
</p>
</div>
</div>
<div id="outline-container-h:49d04d89-0692-4a32-a23f-be635c989c10" class="outline-4">
<h4 id="h:49d04d89-0692-4a32-a23f-be635c989c10">非阻塞锁使用</h4>
<div class="outline-text-4" id="text-h:49d04d89-0692-4a32-a23f-be635c989c10">
</div>
</div>
</div>
<div id="outline-container-h:5a518f40-3c35-416e-b452-0a95f2f294ab" class="outline-3">
<h3 id="h:5a518f40-3c35-416e-b452-0a95f2f294ab">可重入锁RLock</h3>
<div class="outline-text-3" id="text-h:5a518f40-3c35-416e-b452-0a95f2f294ab">
<p>
可重入锁，是线程相关的锁。
</p>

<p>
线程A获得可重复锁，并可以多次成功获取，不会阻塞。最后要在线程A中做和acquire次数相同的release。
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="color: #a020f0;">import</span> threading

<span style="color: #a0522d;">l</span> = threading.RLock()

<span style="color: #483d8b;">print</span>(l.acquire())
<span style="color: #483d8b;">print</span>(l.acquire())
<span style="color: #483d8b;">print</span>(l.release())
<span style="color: #483d8b;">print</span>(l.release())
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(l.release()) #&#25253;&#38169;&#12290;&#25343;&#20960;&#27425;&#38145;&#65292;&#23601;&#35201;&#37322;&#25918;&#20960;&#27425;&#38145;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">None</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">None</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Traceback (most recent call last):</span>
<span style="color: #b22222;">#   </span><span style="color: #b22222;">File "d:\project\pyprojs\cursor\t2.py", line 10, in &lt;module&gt;</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">print(l.release())</span>
<span style="color: #b22222;">#           </span><span style="color: #b22222;">~~~~~~~~~^^</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">RuntimeError: cannot release un-acquired lock</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading 
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Timer
<span style="color: #a020f0;">import</span> logging

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">"%(asctime)s %(threadName)s %(thread)d %(message)s"</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #483d8b;">print</span>(threading.get_ident(), <span style="color: #8b2252;">'++++'</span>)
<span style="color: #a0522d;">lock</span> = threading.RLock()
logging.info(<span style="color: #8b2252;">'{} {}'</span>.<span style="color: #483d8b;">format</span>(lock.acquire(), lock)) <span style="color: #b22222;">#</span><span style="color: #b22222;">True</span>
logging.info(<span style="color: #8b2252;">'-'</span> * 30)
logging.info(<span style="color: #8b2252;">'{} {}'</span>.<span style="color: #483d8b;">format</span>(lock.acquire(), lock)) <span style="color: #b22222;">#</span><span style="color: #b22222;">True</span>


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(l):
    logging.info(<span style="color: #8b2252;">'in worker~~~~'</span>)
    logging.info(threading.get_ident())
    logging.info(l)
    logging.info(l.acquire())
    logging.info(l)
    logging.info(l.acquire())
    logging.info(l)
    logging.info(<span style="color: #8b2252;">'get one lock'</span>)

<span style="color: #a0522d;">t</span> = threading.Thread(target=worker, name=<span style="color: #8b2252;">'woker'</span>, args=(lock,))
t.start()

time.sleep(3)
logging.info(<span style="color: #8b2252;">'1 {} {}'</span>.<span style="color: #483d8b;">format</span>(lock.release(), lock))
time.sleep(2)
logging.info(<span style="color: #8b2252;">'2 {} {}'</span>.<span style="color: #483d8b;">format</span>(lock.release(), lock))
time.sleep(5)
logging.info(lock)
logging.info(lock.acquire()) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29616;&#22312;&#38145;&#23646;&#24615;woker&#20013;&#65292;&#20869;&#37096;&#27809;&#26377;&#37322;&#25918;&#65292;&#36825;&#37324;&#23601;&#20250;&#19968;&#30452;&#31561;&#24453;</span>

logging.info(<span style="color: #8b2252;">'='</span> * 30) 

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">24540 ++++</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 22:56:50,943 MainThread 24540 True &lt;locked _thread.RLock object owner=24540 count=1 at 0x000001E9ECC3A080&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 22:56:50,944 MainThread 24540 ------------------------------</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 22:56:50,944 MainThread 24540 True &lt;locked _thread.RLock object owner=24540 count=2 at 0x000001E9ECC3A080&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 22:56:50,945 woker 5720 in worker~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 22:56:50,946 woker 5720 5720</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 22:56:50,946 woker 5720 &lt;locked _thread.RLock object owner=24540 count=2 at 0x000001E9ECC3A080&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 22:56:53,946 MainThread 24540 1 None &lt;locked _thread.RLock object owner=24540 count=1 at 0x000001E9ECC3A080&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 22:56:55,947 MainThread 24540 2 None &lt;unlocked _thread.RLock object owner=0 count=0 at 0x000001E9ECC3A080&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 22:56:55,947 woker 5720 True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 22:56:55,948 woker 5720 &lt;locked _thread.RLock object owner=5720 count=1 at 0x000001E9ECC3A080&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 22:56:55,949 woker 5720 True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 22:56:55,949 woker 5720 &lt;locked _thread.RLock object owner=5720 count=2 at 0x000001E9ECC3A080&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 22:56:55,950 woker 5720 get one lock</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-09 22:57:00,949 MainThread 24540 &lt;locked _thread.RLock object owner=5720 count=2 at 0x000001E9ECC3A080&gt;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21345;&#36825;&#37324;&#20102;</span>
</pre>
</div>

<p>
可重入锁总结
</p>
<ul class="org-ul">
<li>与线程相关，可在一个线程中获取锁，并可继续在同一线程中不阻塞多次获取锁</li>
<li>当锁未释放完，其它线程获取锁就会阻塞，直到当前持有锁的线程释放完锁</li>
<li>锁都应该使用完后释放。可重入锁也是锁，应该acquire多少次，就release多少次</li>
</ul>
</div>
</div>
<div id="outline-container-h:e8ad5263-5245-49ba-b9e6-2ae97f4dd478" class="outline-3">
<h3 id="h:e8ad5263-5245-49ba-b9e6-2ae97f4dd478">Condition</h3>
<div class="outline-text-3" id="text-h:e8ad5263-5245-49ba-b9e6-2ae97f4dd478">
<p>
构造方法 Condition(lock=None)，可以传入一个Lock或RLock对象，默认是RLock。
</p>

<pre class="example" id="org5f839c4">
acquire(*args)            获取锁
wait(self, timeout=None)  等待或超时
notify(n=1)               唤醒至多指定数目个数的等待的线程，没有等待的线程就没有任何操作
notify_all()              唤醒所有等待的线程
</pre>

<p>
Condition基本使用
</p>

<p>
范例：一个工人生产1000个杯子，有2个老板等到他生产完为止。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s %(threadName)s %(thread)d %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #b22222;"># </span><span style="color: #b22222;">event = threading.Event()</span>
<span style="color: #a0522d;">cond</span> = threading.Condition()

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">boss</span>():
    logging.info(<span style="color: #8b2252;">'I am watching u'</span>)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">event.wait()</span>
    <span style="color: #a020f0;">with</span> cond:
        logging.info(<span style="color: #8b2252;">'&#25105;&#31561;'</span>)
        cond.wait()
    logging.info(<span style="color: #8b2252;">'Good job'</span>)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(count=1000):
    logging.info(<span style="color: #8b2252;">'Starting......'</span>)
    <span style="color: #a0522d;">cups</span> = []
    <span style="color: #a020f0;">while</span> <span style="color: #483d8b;">len</span>(cups) &lt; count:
        time.sleep(0.0001)
        cups.append(1)
    <span style="color: #a020f0;">with</span> cond:
        <span style="color: #b22222;">#</span><span style="color: #b22222;">cond.notify_all() # &#36890;&#30693;&#25152;&#26377;&#31561;&#24453;&#30340;&#32447;&#31243;</span>
        cond.notify(2) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36890;&#30693;2&#20010;&#32447;&#31243;. 1&#23545;1 &#21333;&#25773;&#65307; 1&#23545;&#22810;&#65292; &#22810;&#25773;&#65292;&#24191;&#25773;&#65292;1&#23545;&#20840;&#20307;</span>

    logging.info(<span style="color: #8b2252;">'finished. cups={}'</span>.<span style="color: #483d8b;">format</span>(<span style="color: #483d8b;">len</span>(cups)))
    <span style="color: #b22222;"># </span><span style="color: #b22222;">event.set()</span>

<span style="color: #a0522d;">b1</span> = threading.Thread(target=boss, name=<span style="color: #8b2252;">'b1'</span>)
<span style="color: #a0522d;">b2</span> = threading.Thread(target=boss, name=<span style="color: #8b2252;">'b2'</span>)
b1.start()
b2.start()

<span style="color: #a0522d;">w</span> = threading.Thread(target=worker, name=<span style="color: #8b2252;">'worker'</span>)
w.start()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:24:25,399 b1 21400 I am watching u</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:24:25,399 b1 21400 &#25105;&#31561;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:24:25,399 b2 25884 I am watching u</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:24:25,399 b2 25884 &#25105;&#31561;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:24:25,399 worker 27616 Starting......</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:24:25,954 worker 27616 finished. cups=1000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:24:25,954 b2 25884 Good job</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:24:25,954 b1 21400 Good job</span>
</pre>
</div>

<p>
Condition用于生产者、消费者模型，为了解决生产者消费者速度匹配问题
</p>

<p>
下例只是为了演示，不考虑线程安全问题
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Thread, Event, Condition
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging
<span style="color: #a020f0;">import</span> random

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s %(threadName)s %(thread)d %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#20135;&#32773;&#28040;&#36153;&#32773;&#27169;&#22411;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Dispatcher</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">data</span> = <span style="color: #008b8b;">None</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">produce</span>(<span style="color: #a020f0;">self</span>):
        logging.info(<span style="color: #8b2252;">'starting...'</span>)
        <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
            time.sleep(1) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27169;&#25311;&#29983;&#20135;&#36895;&#24230;</span>
            <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">data</span> = random.randint(1, 50)
            logging.info( <span style="color: #a020f0;">self</span>.data)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">consume</span>(<span style="color: #a020f0;">self</span>):
        logging.info(<span style="color: #8b2252;">'consume...'</span>)
        <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
            time.sleep(0.5) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27169;&#25311;&#28040;&#36153;&#36895;&#24230;&#12290; &#26368;&#22823;&#30340;&#38382;&#39064;&#22312;&#20110;&#65292;&#28040;&#36153;&#32773;&#20027;&#21160;&#36718;&#35810;&#33719;&#21462;&#25968;&#25454;</span>
            <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">self</span>.data:
                <span style="color: #a0522d;">data</span> = <span style="color: #a020f0;">self</span>.data         
                logging.info(<span style="color: #a020f0;">self</span>.data)
                <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">data</span> = <span style="color: #008b8b;">None</span>

<span style="color: #a0522d;">d</span> = Dispatcher()
<span style="color: #a0522d;">p</span> = threading.Thread(target=d.produce, name=<span style="color: #8b2252;">'producer'</span>)
<span style="color: #a0522d;">c</span> = threading.Thread(target=d.consume, name=<span style="color: #8b2252;">'consumer'</span>)
c.start()
p.start()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:42:25,185 consumer 24904 consume...</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:42:25,185 producer 11784 starting...</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:42:26,186 producer 11784 6</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:42:26,687 consumer 24904 6</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:42:27,187 producer 11784 30</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:42:27,187 consumer 24904 30</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:42:28,188 producer 11784 48</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:42:28,188 consumer 24904 48</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:42:29,188 producer 11784 39</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 10:42:29,189 consumer 24904 39</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Thread, Event, Condition
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging
<span style="color: #a020f0;">import</span> random

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s %(threadName)s %(thread)d %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#20135;&#32773;&#28040;&#36153;&#32773;&#27169;&#22411;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Dispatcher</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">data</span> = <span style="color: #008b8b;">None</span>
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">event</span> = threading.Event()
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">cond</span> = threading.Condition()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">produce</span>(<span style="color: #a020f0;">self</span>):
        logging.info(<span style="color: #8b2252;">'starting...'</span>)
        <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">self</span>.event.wait(1): <span style="color: #b22222;">#</span><span style="color: #b22222;">self.event.wait(1)&#19981;&#33021;&#25918;&#22312;with&#20013;</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">time.sleep(1) # &#27169;&#25311;&#29983;&#20135;&#36895;&#24230;</span>
            <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">data</span> = random.randint(1, 50)
            logging.info( <span style="color: #a020f0;">self</span>.data)
            <span style="color: #a020f0;">with</span> <span style="color: #a020f0;">self</span>.cond:
                <span style="color: #b22222;"># </span><span style="color: #b22222;">self.cond.notify_all()</span>
                <span style="color: #a020f0;">self</span>.cond.notify(2)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">consume</span>(<span style="color: #a020f0;">self</span>):
        logging.info(<span style="color: #8b2252;">'consume...'</span>)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">while not self.event.wait(0.3):</span>
            <span style="color: #b22222;"># </span><span style="color: #b22222;">time.sleep(0.5) # &#27169;&#25311;&#28040;&#36153;&#36895;&#24230;&#12290; &#26368;&#22823;&#30340;&#38382;&#39064;&#22312;&#20110;&#65292;&#28040;&#36153;&#32773;&#20027;&#21160;&#36718;&#35810;&#33719;&#21462;&#25968;&#25454;</span>
        <span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
            <span style="color: #a020f0;">with</span> <span style="color: #a020f0;">self</span>.cond:
                <span style="color: #a020f0;">self</span>.cond.wait()
            <span style="color: #a0522d;">data</span> = <span style="color: #a020f0;">self</span>.data         
            logging.info(<span style="color: #a020f0;">self</span>.data)
            <span style="color: #b22222;"># </span><span style="color: #b22222;">self.data = None</span>

<span style="color: #a0522d;">d</span> = Dispatcher()
<span style="color: #a0522d;">p</span> = threading.Thread(target=d.produce, name=<span style="color: #8b2252;">'producer'</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22686;&#21152;&#28040;&#36153;&#32773;</span>
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5):
    <span style="color: #a0522d;">c</span> = threading.Thread(target=d.consume, name=<span style="color: #8b2252;">'consumer{}'</span>.<span style="color: #483d8b;">format</span>(i))
    c.start()
p.start()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:16,733 consumer0 14844 consume...</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:16,733 consumer1 11276 consume...</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:16,734 consumer2 16232 consume...</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:16,734 consumer3 21172 consume...</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:16,734 consumer4 27172 consume...</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:16,734 producer 26236 starting...</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:17,740 producer 26236 17</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:17,741 consumer0 14844 17</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:17,741 consumer1 11276 17</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:18,751 producer 26236 1</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:18,752 consumer3 21172 1</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:18,752 consumer2 16232 1</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:19,761 producer 26236 30</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:19,762 consumer4 27172 30</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:19,762 consumer0 14844 30</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:20,767 producer 26236 49</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:20,768 consumer1 11276 49</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 11:19:20,768 consumer3 21172 49</span>
</pre>
</div>

<p>
这个例子，可以看到实现了消息的一对多 ，这其实就是广播模式。
</p>

<p>
注：上例中，程序本身不是线程安全的，程序逻辑有很多瑕疵，但是可以很好的帮助理解Condition的使用和生产者消费者模型。
</p>


<p>
Condition总结
</p>
<ul class="org-ul">
<li>Condition用于生产者消费者模型中，解决生产者消费者速度匹配的问题</li>
<li>采用了通知机制，非常有效率</li>
</ul>

<p>
使用方式
</p>
<ul class="org-ul">
<li>使用Condition，必须先acquire，用完了要release，因为内部使用了锁，默认使用RLock锁，最好的方式是使用with上下文</li>
<li>消费者wait，等待通知</li>
<li>生产者生产好消息，对消费者发通知，可以使用notify或者notify_all方法</li>
</ul>
</div>
</div>
<div id="outline-container-h:1372e12c-5419-4dad-af6c-a9c7ed2e749d" class="outline-3">
<h3 id="h:1372e12c-5419-4dad-af6c-a9c7ed2e749d">semaphore信号量</h3>
<div class="outline-text-3" id="text-h:1372e12c-5419-4dad-af6c-a9c7ed2e749d">
<p>
和Lock很像，信号量对象内部维护一个倒计数器，每一次acquire都会减1，当
acquire方法发现计数为0就阻塞请求的线程，直到其它线程对信号量release后，
计数大于0，恢复阻塞的线程。
</p>

<pre class="example" id="org5775ec1">
Semaphore(value=1)     构造方法。value小于0，抛ValueError异常
acquire(blocking=True, timeout=None)    获取信号量，计数器减1，获取成功返回True
release()              释放信号量，计数器加1
</pre>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Thread, Semaphore
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging
<span style="color: #a020f0;">import</span> random

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s %(threadName)s %(thread)d %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20449;&#21495;&#37327;</span>
<span style="color: #a0522d;">s</span> = threading.Semaphore(3)
logging.info(s.acquire())
logging.info(s._value)
logging.info(s.acquire())
logging.info(s._value)
logging.info(s.acquire())
logging.info(s._value)
logging.info(<span style="color: #8b2252;">'----'</span>)
s.release() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37322;&#25918;&#19968;&#20010;&#20449;&#21495;&#37327;</span>
s.release()
s.release()
logging.info(s.<span style="color: #483d8b;">__dict__</span>)
s.release()
logging.info(s.<span style="color: #483d8b;">__dict__</span>)
s.release()
logging.info(s.<span style="color: #483d8b;">__dict__</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:25:31,454 MainThread 27692 True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:25:31,455 MainThread 27692 2</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:25:31,455 MainThread 27692 True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:25:31,455 MainThread 27692 1</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:25:31,455 MainThread 27692 True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:25:31,455 MainThread 27692 0</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:25:31,456 MainThread 27692 ----</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:25:31,456 MainThread 27692 {'_cond': &lt;Condition(&lt;unlocked _thread.lock object at 0x000001ADBA3FE590&gt;, 0)&gt;, '_value': 3}    </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:25:31,456 MainThread 27692 {'_cond': &lt;Condition(&lt;unlocked _thread.lock object at 0x000001ADBA3FE590&gt;, 0)&gt;, '_value': 4}    </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:25:31,456 MainThread 27692 {'_cond': &lt;Condition(&lt;unlocked _thread.lock object at 0x000001ADBA3FE590&gt;, 0)&gt;, '_value': 5}</span>
</pre>
</div>

<p>
计数器永远不会低于0，因为acquire的时候，发现是0，都会被阻塞。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Thread, Semaphore
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging
<span style="color: #a020f0;">import</span> random

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s %(threadName)s %(thread)d %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20449;&#21495;&#37327;</span>
<span style="color: #a0522d;">s</span> = threading.Semaphore(3)
logging.info(s.acquire())
logging.info(s._value)
logging.info(s.acquire())
logging.info(s._value)
logging.info(s.acquire())
logging.info(s._value)
logging.info(<span style="color: #8b2252;">'----'</span>)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>():
    logging.info(s)
    logging.info(s.<span style="color: #483d8b;">__dict__</span>)
    logging.info(s.acquire())
    <span style="color: #b22222;"># </span><span style="color: #b22222;">s.release() #&#37322;&#25918;&#19968;&#20010;&#20449;&#21495;&#37327;</span>
    logging.info(<span style="color: #8b2252;">'release s one time'</span>)
    logging.info(s.<span style="color: #483d8b;">__dict__</span>)

threading.Timer(2, worker).start()

time.sleep(3)
<span style="color: #b22222;"># </span><span style="color: #b22222;">logging.info(s.acquire())</span>
s.release() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37322;&#25918;&#19968;&#20010;&#20449;&#21495;&#37327;</span>
logging.info(s.<span style="color: #483d8b;">__dict__</span>)
logging.info(<span style="color: #8b2252;">'got it'</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:21:31,906 MainThread 28616 True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:21:31,907 MainThread 28616 2</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:21:31,907 MainThread 28616 True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:21:31,907 MainThread 28616 1</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:21:31,907 MainThread 28616 True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:21:31,907 MainThread 28616 0</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:21:31,908 MainThread 28616 ----</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:21:33,923 Thread-1 22360 &lt;threading.Semaphore at 0x1aeb5550590: value=0&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:21:33,924 Thread-1 22360 {'_cond': &lt;Condition(&lt;unlocked _thread.lock object at 0x000001AEB551E390&gt;, 0)&gt;, '_value': 0}      </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:21:34,908 MainThread 28616 {'_cond': &lt;Condition(&lt;unlocked _thread.lock object at 0x000001AEB551E390&gt;, 0)&gt;, '_value': 1}</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:21:34,909 MainThread 28616 got it</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:21:34,909 Thread-1 22360 True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:21:34,910 Thread-1 22360 release s one time</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:21:34,910 Thread-1 22360 {'_cond': &lt;Condition(&lt;unlocked _thread.lock object at 0x000001AEB551E390&gt;, 0)&gt;, '_value': 0} </span>
</pre>
</div>
</div>
<div id="outline-container-h:d9bff5d6-b452-4bf2-9ec5-9d3aca8c0850" class="outline-4">
<h4 id="h:d9bff5d6-b452-4bf2-9ec5-9d3aca8c0850">release方法超界问题</h4>
<div class="outline-text-4" id="text-h:d9bff5d6-b452-4bf2-9ec5-9d3aca8c0850">
<p>
假设如果还没有acquire信号量，就release，会怎么样？
</p>

<p>
从上例输出结果可以看出，竟然内置计数器达到了5，这样实际上超出我们的最大值，需要解决这个问题
</p>
</div>
</div>
</div>
<div id="outline-container-h:a29d1497-9ab7-4367-8eda-8473e71c53fe" class="outline-3">
<h3 id="h:a29d1497-9ab7-4367-8eda-8473e71c53fe">BoundedSemaphore类</h3>
<div class="outline-text-3" id="text-h:a29d1497-9ab7-4367-8eda-8473e71c53fe">
<p>
有界的信号量，不允许使用release超出初始值的范围，否则，抛出ValueError异常
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Thread, Semaphore
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging
<span style="color: #a020f0;">import</span> random

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s %(threadName)s %(thread)d %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20449;&#21495;&#37327;</span>
<span style="color: #a0522d;">s</span> = threading.BoundedSemaphore(3) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26377;&#30028;&#30340;&#20449;&#21495;&#37327;</span>
logging.info(s.acquire())
logging.info(s._value)
logging.info(s.acquire())
logging.info(s._value)
logging.info(s.acquire())
logging.info(s._value)
logging.info(<span style="color: #8b2252;">'----'</span>)
s.release() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37322;&#25918;&#19968;&#20010;&#20449;&#21495;&#37327;</span>
s.release()
s.release()
logging.info(s.<span style="color: #483d8b;">__dict__</span>)
s.release() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36229;&#30028;&#20102;&#65292;&#25253;&#38169;</span>
logging.info(s.<span style="color: #483d8b;">__dict__</span>)
s.release()
logging.info(s.<span style="color: #483d8b;">__dict__</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:35:55,695 MainThread 12376 True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:35:55,695 MainThread 12376 2</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:35:55,695 MainThread 12376 True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:35:55,695 MainThread 12376 1</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:35:55,695 MainThread 12376 True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:35:55,695 MainThread 12376 0</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:35:55,696 MainThread 12376 ----</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 15:35:55,696 MainThread 12376 {'_cond': &lt;Condition(&lt;unlocked _thread.lock object at 0x0000021BFA58FC90&gt;, 0)&gt;, '_value': 3, '_initial_value': 3}</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Traceback (most recent call last):</span>
<span style="color: #b22222;">#   </span><span style="color: #b22222;">File "d:\project\pyproj\cursor\t.py", line 23, in &lt;module&gt;</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">s.release()</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">~~~~~~~~~^^</span>
<span style="color: #b22222;">#   </span><span style="color: #b22222;">File "D:\py\py313\Lib\threading.py", line 576, in release</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">raise ValueError("Semaphore released too many times")</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">ValueError: Semaphore released too many times</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:55bd30b1-c864-40ac-b076-754adce345b7" class="outline-3">
<h3 id="h:55bd30b1-c864-40ac-b076-754adce345b7">应用举例</h3>
<div class="outline-text-3" id="text-h:55bd30b1-c864-40ac-b076-754adce345b7">
<ul class="org-ul">
<li><p>
连接池
</p>

<p>
因为资源有限，且开启一个连接成本高，所以，使用连接池
</p></li>

<li><p>
一个简单的连接池
</p>

<p>
连接池应该有容量（总数），有一个工厂方法可以获取连接，能够把不用的连接返回，供其他调用者使用
</p></li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Conn</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, name):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">name</span> = name

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Pool</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, count:<span style="color: #483d8b;">int</span>):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">count</span> = count
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27744;&#20013;&#25552;&#21069;&#25918;&#30528;&#36830;&#25509;&#22791;&#29992;</span>
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">pool</span> = [<span style="color: #a020f0;">self</span>._connect(<span style="color: #8b2252;">'conn-{}'</span>.<span style="color: #483d8b;">format</span>(i)) <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(<span style="color: #a020f0;">self</span>.count)]

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_connect</span>(<span style="color: #a020f0;">self</span>, conn_name):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#36830;&#25509;&#30340;&#26041;&#27861;&#65292;&#36820;&#22238;&#19968;&#20010;&#36830;&#25509;&#23545;&#35937;</span>
        <span style="color: #a020f0;">return</span> Conn(conn_name)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_conn</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20174;&#27744;&#20013;&#25343;&#36208;&#19968;&#20010;&#36830;&#25509;</span>
        <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(<span style="color: #a020f0;">self</span>.pool) &gt; 0:
            <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>.pool.pop()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">return_conn</span>(<span style="color: #a020f0;">self</span>, conn:Conn):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21521;&#27744;&#20013;&#36820;&#22238;&#19968;&#20010;&#36830;&#25509;&#23545;&#35937;</span>
        <span style="color: #a020f0;">self</span>.pool.append(conn)
</pre>
</div>

<p>
真正的连接池的实现比上面的例子要复杂的多，这里只是简单的一个功能的实现
</p>

<ul class="org-ul">
<li><p>
本例中，get_conn()方法在多线程的时候有线程安全问题
</p>

<p>
假设池中正好有一个连接，有可能多个线程判断池的长度是大于0的，当一个线程拿走了连接对象，其他线程再来pop就会抛异常的。如何解决？
</p>

<p>
1、加锁，在读写的地方加锁
</p>

<p>
2、使用信号量Semaphore
</p></li>
</ul>

<p>
范例：加锁方式，连接池
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Thread, Semaphore
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging
<span style="color: #a020f0;">import</span> random

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s %(threadName)s %(thread)d %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #b22222;">#</span><span style="color: #b22222;">Pool &#27744;&#65292;&#27744;&#20013;&#36164;&#28304;&#33719;&#24471;&#24456;&#19981;&#23481;&#26131;&#65292;&#20294;&#26159;&#25105;&#20204;&#29992;&#30340;&#24456;&#39057;&#32321;&#65292;&#32780;&#19988;&#36824;&#35201;&#22797;&#29992;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#27744;, &#21019;&#24314;&#36830;&#25509;&#12289;&#32500;&#25252;&#36830;&#25509;&#38750;&#24120;&#28040;&#32791;&#36164;&#28304;&#12290;&#32447;&#31243;&#27744;&#12289;&#36827;&#31243;&#27744;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Conn</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, name):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">name</span> = name

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Pool</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, count:<span style="color: #483d8b;">int</span>=5):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">count</span> = count
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27744;&#20013;&#25552;&#21069;&#25918;&#30528;&#36830;&#25509;&#22791;&#29992;</span>
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">pool</span> = [<span style="color: #a020f0;">self</span>._connect(<span style="color: #8b2252;">'conn-{}'</span>.<span style="color: #483d8b;">format</span>(i)) <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(<span style="color: #a020f0;">self</span>.count)]
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">_lock</span> = threading.Lock()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_connect</span>(<span style="color: #a020f0;">self</span>, conn_name):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#36830;&#25509;&#30340;&#26041;&#27861;&#65292;&#36820;&#22238;&#19968;&#20010;&#36830;&#25509;&#23545;&#35937;</span>
        <span style="color: #a020f0;">return</span> Conn(conn_name)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_conn</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20174;&#27744;&#20013;&#25343;&#36208;&#19968;&#20010;&#36830;&#25509;</span>
        <span style="color: #a020f0;">with</span> <span style="color: #a020f0;">self</span>._lock:
            <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">len</span>(<span style="color: #a020f0;">self</span>.pool) &gt; 0:
                <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>.pool.pop()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">return_conn</span>(<span style="color: #a020f0;">self</span>, conn:Conn):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21521;&#27744;&#20013;&#36820;&#22238;&#19968;&#20010;&#36830;&#25509;&#23545;&#35937;</span>
        <span style="color: #a020f0;">with</span> <span style="color: #a020f0;">self</span>._lock:
            <span style="color: #a020f0;">self</span>.pool.append(conn)


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#36830;&#25509;&#27744;</span>
<span style="color: #a0522d;">pool</span> = Pool(3)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(pool:Pool):
    <span style="color: #a0522d;">conn</span> = pool.get_conn()
    logging.info(conn)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27169;&#25311;&#20351;&#29992;&#20102;&#19968;&#27573;&#26102;&#38388;</span>
    time.sleep(random.randint(1, 5))
    pool.return_conn(conn)

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(6):
    threading.Thread(target=worker, name=<span style="color: #8b2252;">'worker-{}'</span>.<span style="color: #483d8b;">format</span>(i), args=(pool,)).start()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 17:29:55,987 worker-0 18212 &lt;__main__.Conn object at 0x00000238B7D2EFD0&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 17:29:55,988 worker-1 27588 &lt;__main__.Conn object at 0x00000238B7D2EE90&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 17:29:55,988 worker-2 23464 &lt;__main__.Conn object at 0x00000238B7D36510&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 17:29:55,988 worker-3 28380 None</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 17:29:55,989 worker-4 24136 None</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 17:29:55,989 worker-5 26188 None</span>
</pre>
</div>

<p>
范例：使用信号量对上例进行修改
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">from</span> threading <span style="color: #a020f0;">import</span> Thread, Semaphore
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging
<span style="color: #a020f0;">import</span> random

<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s %(threadName)s %(thread)d %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #b22222;">#</span><span style="color: #b22222;">Pool &#27744;&#65292;&#27744;&#20013;&#36164;&#28304;&#33719;&#24471;&#24456;&#19981;&#23481;&#26131;&#65292;&#20294;&#26159;&#25105;&#20204;&#29992;&#30340;&#24456;&#39057;&#32321;&#65292;&#32780;&#19988;&#36824;&#35201;&#22797;&#29992;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36830;&#25509;&#27744;, &#21019;&#24314;&#36830;&#25509;&#12289;&#32500;&#25252;&#36830;&#25509;&#38750;&#24120;&#28040;&#32791;&#36164;&#28304;&#12290;&#32447;&#31243;&#27744;&#12289;&#36827;&#31243;&#27744;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Conn</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, name):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">name</span> = name

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Pool</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, count:<span style="color: #483d8b;">int</span>=5):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">count</span> = count
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27744;&#20013;&#25552;&#21069;&#25918;&#30528;&#36830;&#25509;&#22791;&#29992;</span>
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">pool</span> = [<span style="color: #a020f0;">self</span>._connect(<span style="color: #8b2252;">'conn-{}'</span>.<span style="color: #483d8b;">format</span>(i)) <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(<span style="color: #a020f0;">self</span>.count)]
        <span style="color: #b22222;"># </span><span style="color: #b22222;">self._lock = threading.Lock()</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">self.sema = threading.Semaphore(self.count)</span>
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">sema</span> = threading.BoundedSemaphore(<span style="color: #a020f0;">self</span>.count)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_connect</span>(<span style="color: #a020f0;">self</span>, conn_name):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#36830;&#25509;&#30340;&#26041;&#27861;&#65292;&#36820;&#22238;&#19968;&#20010;&#36830;&#25509;&#23545;&#35937;</span>
        <span style="color: #a020f0;">return</span> Conn(conn_name)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">get_conn</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20174;&#27744;&#20013;&#25343;&#36208;&#19968;&#20010;&#36830;&#25509;</span>
        <span style="color: #a020f0;">self</span>.sema.acquire()
        <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>.pool.pop()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">return_conn</span>(<span style="color: #a020f0;">self</span>, conn:Conn):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21521;&#27744;&#20013;&#36820;&#22238;&#19968;&#20010;&#36830;&#25509;&#23545;&#35937;</span>
        <span style="color: #a020f0;">self</span>.pool.append(conn)
        <span style="color: #a020f0;">self</span>.sema.release()


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21021;&#22987;&#21270;&#36830;&#25509;&#27744;</span>
<span style="color: #a0522d;">pool</span> = Pool(3)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(pool:Pool):
    <span style="color: #a0522d;">conn</span> = pool.get_conn()
    logging.info(conn)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27169;&#25311;&#20351;&#29992;&#20102;&#19968;&#27573;&#26102;&#38388;</span>
    time.sleep(random.randint(1, 5))
    pool.return_conn(conn)

<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(6):
    threading.Thread(target=worker, name=<span style="color: #8b2252;">'worker-{}'</span>.<span style="color: #483d8b;">format</span>(i), args=(pool,)).start()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 17:50:03,637 worker-0 28432 &lt;__main__.Conn object at 0x000002C0718F7250&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 17:50:03,637 worker-1 22796 &lt;__main__.Conn object at 0x000002C0718F7110&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 17:50:03,637 worker-2 26252 &lt;__main__.Conn object at 0x000002C0719163C0&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 17:50:06,638 worker-3 14912 &lt;__main__.Conn object at 0x000002C0718F7110&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 17:50:06,638 worker-4 25476 &lt;__main__.Conn object at 0x000002C0719163C0&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 17:50:07,638 worker-5 22960 &lt;__main__.Conn object at 0x000002C0718F7250&gt;</span>
</pre>
</div>

<p>
上例中，使用信号量解决资源有限的问题
</p>

<p>
如果池中有资源，请求者获取资源时信号量减1，拿走资源。当请求超过资源数，
请求者只能等待。当使用者用完归还资源后信号量加1，等待线程就可以被唤醒
拿走资源
</p>

<p>
注意：这个连接池的例子不能用到生成环境，只是为了说明信号量使用的例子，连接池还有很多未完成功能
</p>
</div>
</div>
<div id="outline-container-h:fce456b1-0bca-4620-b27d-04d79f16118f" class="outline-3">
<h3 id="h:fce456b1-0bca-4620-b27d-04d79f16118f">问题</h3>
<div class="outline-text-3" id="text-h:fce456b1-0bca-4620-b27d-04d79f16118f">
<p>
self.conns.append(conn) 这一句有哪些问题考虑？
</p>
</div>
<div id="outline-container-h:8dbf3134-ac8b-4581-8b66-1dfd6c7017cf" class="outline-4">
<h4 id="h:8dbf3134-ac8b-4581-8b66-1dfd6c7017cf">1、边界问题分析</h4>
<div class="outline-text-4" id="text-h:8dbf3134-ac8b-4581-8b66-1dfd6c7017cf">
<p>
return_conn方法可以单独执行，有可能多归还连接，也就是会多release，所以，要用有界信号量
</p>

<p>
BoundedSemaphore类
</p>

<p>
这样用有界信号量修改源代码，保证如果多return_conn就会抛异常
</p>

<pre class="example" id="org7ac91e3">
self.pool.append(conn)
self.semaphore.release()
</pre>

<p>
假设一种极端情况，计数器还差1就归还满了，有三个线程A、B、C都执行了第一句，都没有来得及release，这时候轮到线程A release，正常的release，然后轮到线程C先release，一定出问题，超界了，直接抛异常
</p>

<p>
因此信号量，可以保证，一定不能多归还
</p>

<p>
如果归还了同一个连接多次怎么办，重复很容易判断
</p>

<p>
这个程序还不能判断这些连接是不是原来自己创建的，这不是生成环境用的代码，只是简单演示
</p>
</div>
</div>
<div id="outline-container-h:4bc251f2-7f15-4404-a5cc-4858c4484545" class="outline-4">
<h4 id="h:4bc251f2-7f15-4404-a5cc-4858c4484545">2、正常使用分析</h4>
<div class="outline-text-4" id="text-h:4bc251f2-7f15-4404-a5cc-4858c4484545">
<p>
正常使用信号量，都会先获取信号量，然后用完归还
</p>

<p>
创建很多线程，都去获取信号量，没有获得信号量的线程都阻塞。能归还的线程都是前面获取到信号量的线程，其他没有获得线程都阻塞着。非阻塞的线程append后才release，这时候等待的线程被唤醒，才能pop，也就是没有获取信号量就不能pop，这是安全的
</p>

<p>
经过上面的分析，信号量比计算列表长度好，线程安全
</p>
</div>
</div>
</div>
<div id="outline-container-h:73137cd7-fd42-408e-a4ec-e8fbaaabcf88" class="outline-3">
<h3 id="h:73137cd7-fd42-408e-a4ec-e8fbaaabcf88">信号量和锁</h3>
<div class="outline-text-3" id="text-h:73137cd7-fd42-408e-a4ec-e8fbaaabcf88">
<p>
信号量，可以多个线程访问共享资源，但这个共享资源数量有限。
</p>

<p>
锁，可以看做特殊的信号量，即信号量计数器初值为1。只允许同一个时间一个线程独占资源。
</p>
</div>
</div>
<div id="outline-container-h:bbcab601-a08c-447f-9b11-c44c891cced1" class="outline-3">
<h3 id="h:bbcab601-a08c-447f-9b11-c44c891cced1">Queue的线程安全</h3>
<div class="outline-text-3" id="text-h:bbcab601-a08c-447f-9b11-c44c891cced1">
<p>
标准库queue模块，提供FIFO的Queue、LIFO的队列、优先队列。
</p>

<p>
Queue类是线程安全的，适用于多线程间安全的交换数据。内部使用了Lock和Condition。
</p>

<p>
为什么讲魔术方法时，说实现容器的大小，不准确？
</p>

<p>
如果不加锁，是不可能获得准确的大小的，因为你刚读取到了一个大小，还没有取走数据，就有可能
被其他线程改了。
</p>

<p>
Queue类的size虽然加了锁，但是，依然不能保证立即get、put就能成功，因为读取大小和get、put方法是分开的。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> queue

<span style="color: #a0522d;">q</span> = queue.Queue(8)

<span style="color: #a020f0;">if</span> q.qsize == 7:
    q.put() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19978;&#19979;&#20004;&#21477;&#21487;&#33021;&#34987;&#25171;&#26029;</span>

<span style="color: #a020f0;">if</span> q.qsize == 1:
    q.get() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26410;&#24517;&#20250;&#25104;&#21151;</span>
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:eb43234c-dbde-405c-a13c-f0310203a8da" class="outline-2">
<h2 id="h:eb43234c-dbde-405c-a13c-f0310203a8da">GIL全局解释器锁</h2>
<div class="outline-text-2" id="text-h:eb43234c-dbde-405c-a13c-f0310203a8da">
<p>
参考文档：<a href="https://docs.python.org/3/glossary.html#term-GIL">https://docs.python.org/3/glossary.html#term-GIL</a>
</p>

<blockquote>
<p>
CPython 解释器所采用的一种机制，它确保同一时刻只有一个线程在执行
Python bytecode。此机制通过设置对象模型（包括 dict 等重要内置类型）针
对并发访问的隐式安全简化了 CPython 实现。给整个解释器加锁使得解释器多
线程运行更方便，其代价则是牺牲了在多处理器上的并行性。
</p>

<p>
不过，某些标准库或第三方库的扩展模块被设计为在执行计算密集型任务如压缩或哈希时释放 GIL。 此外，在执行 I/O 操作时也总是会释放 GIL。
</p>

<p>
在 Python 3.13 中，GIL 可以使用 &#x2013;disable-gil 构建配置选项来禁用。 在
使用此选项构建 Python 之后，代码必须附带 -X gil=0 或在设置
PYTHON_GIL=0 环境变量后运行。 此特性将为多线程应用程序启用性能提升并让
高效率地使用多核 CPU 更加容易。 要了解详情，请参阅 PEP 703。
</p>
</blockquote>

<p>
CPython 在解释器进程级别有一把锁，叫做GIL，即全局解释器锁。
</p>

<p>
GIL 保证CPython进程中，只有一个线程执行字节码。甚至是在多核CPU的情况下，也只允许同时只能有一个CPU上运行该进程的一个线程。
</p>

<p>
CPython中
</p>
<ul class="org-ul">
<li>IO密集型，某个线程阻塞，就会调度其他就绪线程</li>
<li>CPU密集型，当前线程可能会连续的获得GIL，导致其它线程几乎无法使用CPU</li>
<li>在CPython中由于有GIL存在，IO密集型，使用多线程较为合算；CPU密集型，使用多进程，要绕开GIL</li>
</ul>

<p>
新版CPython正在努力优化GIL的问题，但不是移除。
</p>

<p>
如果在意多线程的效率问题，请绕行，选择其它语言erlang、Go等。
</p>

<blockquote>
<p>
Python中绝大多数内置数据结构的读、写操作都是原子操作
</p>

<p>
由于GIL的存在，Python的内置数据类型在多线程编程的时候就变成了安全的了，但是实际上它们本身不是线程安全类型
</p>
</blockquote>

<p>
保留GIL的原因
</p>

<p>
Guido坚持的简单哲学，对于初学者门槛低，不需要高深的系统知识也能安全、简单的使用Python。
</p>

<p>
而且移除GIL，会降低CPython单线程的执行效率。
</p>

<p>
测试下面2个程序，请问下面的程序是计算密集型还是IO密集型？
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> logging


<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s %(threadName)s %(thread)d %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">calc</span>():
    <span style="color: #483d8b;">sum</span> = 0
    <span style="color: #a020f0;">for</span> _ <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(100000000): <span style="color: #b22222;">#</span><span style="color: #b22222;">1&#20159;</span>
        <span style="color: #483d8b;">sum</span> += 1
    logging.info(<span style="color: #483d8b;">sum</span>)

<span style="color: #a0522d;">start</span> = datetime.datetime.now()

calc()
calc()
calc()
calc() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32431;&#20018;&#34892;</span>

<span style="color: #a0522d;">delta</span> = (datetime.datetime.now() - start).total_seconds()
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'&#20018;&#34892; &#32791;&#26102;={}s'</span>.<span style="color: #483d8b;">format</span>(delta))

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 23:24:49,646 MainThread 15556 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 23:24:55,259 MainThread 15556 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 23:25:00,528 MainThread 15556 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 23:25:06,034 MainThread 15556 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20018;&#34892; &#32791;&#26102;=22.13501s</span>
</pre>
</div>


<p>
下例为cpu密集型
</p>

<p>
不适合用多线程来使用。可以使用多进程
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> threading
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> logging


<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s %(threadName)s %(thread)d %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">calc</span>():
    <span style="color: #483d8b;">sum</span> = 0
    <span style="color: #a020f0;">for</span> _ <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(100000000): <span style="color: #b22222;">#</span><span style="color: #b22222;">1&#20159;</span>
        <span style="color: #483d8b;">sum</span> += 1
    logging.info(<span style="color: #483d8b;">sum</span>)

<span style="color: #a0522d;">start</span> = datetime.datetime.now()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24182;&#34892;&#65292;&#20551;&#24182;&#34892;&#65292;&#22240;&#20026;&#26377;GIL</span>
<span style="color: #a0522d;">c1</span> = threading.Thread(target=calc, name=<span style="color: #8b2252;">'c1'</span>)
<span style="color: #a0522d;">c2</span> = threading.Thread(target=calc, name=<span style="color: #8b2252;">'c2'</span>)
<span style="color: #a0522d;">c3</span> = threading.Thread(target=calc, name=<span style="color: #8b2252;">'c3'</span>)
<span style="color: #a0522d;">c4</span> = threading.Thread(target=calc, name=<span style="color: #8b2252;">'c4'</span>)
c1.start()
c2.start()
c3.start()
c4.start()
c1.join()
c2.join()
c3.join()
c4.join()

<span style="color: #a0522d;">delta</span> = (datetime.datetime.now() - start).total_seconds()
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'&#22810;&#32447;&#31243; &#32791;&#26102;={}s'</span>.<span style="color: #483d8b;">format</span>(delta))

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 23:34:19,970 c2 5884 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 23:34:20,961 c3 18784 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 23:34:21,008 c4 13032 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 23:34:21,025 c1 3396 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22810;&#32447;&#31243; &#32791;&#26102;=19.013177s</span>
</pre>
</div>

<p>
注意，不要在代码中出现print等访问IO的语句。访问IO，线程阻塞，会释放GIL锁，其他线程被调度
</p>

<p>
程序1是单线程程序，所有calc()依次执行，根本就不是并发。在主线程内，函数串行执行。
</p>

<p>
程序2是多线程程序，calc()执行在不同的线程中，但是由于GIL的存在，线程的
执行变成了假并发。但是这些线程可以被调度到不同的CPU核心上执行，只不过
GIL让同一时间该进程只有一个线程被执行。
</p>

<p>
从两段程序测试的结果来看，CPython中多线程根本没有任何优势，和一个线程
执行时间相当。因为GIL的存在，尤其是像上面的计算密集型程序，和单线程串
行效果相当。这样，实际上就没有用上CPU多核心的优势。
</p>
</div>
</section>
<section id="outline-container-h:f4b8b789-b110-477c-bf1e-9abdc639b837" class="outline-2">
<h2 id="h:f4b8b789-b110-477c-bf1e-9abdc639b837">多进程</h2>
<div class="outline-text-2" id="text-h:f4b8b789-b110-477c-bf1e-9abdc639b837">
</div>
<div id="outline-container-h:1bd07f42-95dd-4826-bb5f-31e417dbfb1d" class="outline-3">
<h3 id="h:1bd07f42-95dd-4826-bb5f-31e417dbfb1d">多进程</h3>
<div class="outline-text-3" id="text-h:1bd07f42-95dd-4826-bb5f-31e417dbfb1d">
<p>
由于Python的GIL全局解释器锁存在，多线程未必是CPU密集型程序的好的选择
多进程可以完全独立的进程环境中运行程序，可以较充分地利用多处理器
但是进程本身的隔离带来的数据不共享也是一个问题。而且线程比进程轻量级
</p>
</div>
<div id="outline-container-h:46ca9d23-b3ec-4023-aa68-b051d11b7d5d" class="outline-4">
<h4 id="h:46ca9d23-b3ec-4023-aa68-b051d11b7d5d">multiprocessing</h4>
<div class="outline-text-4" id="text-h:46ca9d23-b3ec-4023-aa68-b051d11b7d5d">
</div>
<div id="outline-container-h:07b702c2-8bd1-4d00-8584-26e3d8ce39af" class="outline-5">
<h5 id="h:07b702c2-8bd1-4d00-8584-26e3d8ce39af">Process类</h5>
<div class="outline-text-5" id="text-h:07b702c2-8bd1-4d00-8584-26e3d8ce39af">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> multiprocessing
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> logging


<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s %(processName)s %(threadName)s %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">calc</span>():
    <span style="color: #483d8b;">sum</span> = 0
    <span style="color: #a020f0;">for</span> _ <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(1000000000): <span style="color: #b22222;">#</span><span style="color: #b22222;">10&#20159;</span>
        <span style="color: #483d8b;">sum</span> += 1
    logging.info(<span style="color: #483d8b;">sum</span>)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36827;&#31243;&#26377;&#27809;&#26377;&#36820;&#22238;&#20540;&#65311;</span>
    <span style="color: #a020f0;">return</span> multiprocessing.current_process().name, <span style="color: #483d8b;">sum</span>

<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">'__main__'</span>:
    <span style="color: #a0522d;">start</span> = datetime.datetime.now()

    <span style="color: #a0522d;">workers</span> = []
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30495;&#24182;&#34892;&#65292;GIL&#26377;&#24433;&#21709;&#21527;&#65311;</span>
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(4): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;&#20102;4&#20010;&#24037;&#20316;&#36827;&#31243;&#65292;&#29992;&#20182;&#20204;&#30340;&#20027;&#32447;&#31243;&#24037;&#20316;</span>
        <span style="color: #a0522d;">p</span> = multiprocessing.Process(target=calc, name=<span style="color: #8b2252;">'p-{}'</span>.<span style="color: #483d8b;">format</span>(i))
        workers.append(p)
        p.start()

    <span style="color: #a020f0;">for</span> p <span style="color: #a020f0;">in</span> workers:
        p.join()
        <span style="color: #483d8b;">print</span>(p.name, p.exitcode)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26159;&#36820;&#22238;&#20540;&#21527;&#65311;</span>

    <span style="color: #a0522d;">delta</span> = (datetime.datetime.now() - start).total_seconds()
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'&#22810;&#36827;&#31243; &#32791;&#26102;={}s'</span>.<span style="color: #483d8b;">format</span>(delta))

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 23:50:08,891 p-1 MainThread 1000000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 23:50:10,386 p-3 MainThread 1000000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 23:50:12,125 p-2 MainThread 1000000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-10 23:50:15,080 p-0 MainThread 1000000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">p-0 0</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">p-1 0</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">p-2 0</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">p-3 0</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22810;&#36827;&#31243; &#32791;&#26102;=72.92779s</span>
</pre>
</div>

<p>
对于上面这个程序，在同一主机上运行时长的对比
</p>
<ul class="org-ul">
<li>使用单线程、多线程跑了4分钟多</li>
<li>多进程用了1分半</li>
</ul>

<p>
看到了多个进程都在使用CPU，这是真并行，而且进程库几乎没有学习难度。
</p>

<p>
注意：多进程代码一定要放在 <code>__name__ =</code> "<span class="underline"><span class="underline">main</span></span>"= 下面执行。
</p>


<p>
名称	说明
</p>
<pre class="example" id="orgab279b9">
pid          进程id
exitcode     进程的退出状态码
terminate()  终止指定的进程
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3585d1d7-7143-4159-95ab-4a82e32db1d9" class="outline-4">
<h4 id="h:3585d1d7-7143-4159-95ab-4a82e32db1d9">进程间同步</h4>
<div class="outline-text-4" id="text-h:3585d1d7-7143-4159-95ab-4a82e32db1d9">
<p>
Python在进程间同步提供了和线程同步一样的类，使用的方法一样，使用的效果也类似。
</p>

<p>
不过，进程间代价要高于线程间，而且系统底层实现是不同的，只不过Python屏蔽了这些不同之处，让用户简单使用多进程。
</p>

<p>
multiprocessing还提供共享内存、服务器进程来共享数据，还提供了用于进程间通讯的Queue队列、Pipe管道。
</p>

<p>
通信方式不同
</p>
<ul class="org-ul">
<li>多进程就是启动多个解释器进程，进程间通信必须序列化、反序列化</li>
<li><p>
数据的线程安全性问题
</p>

<p>
如果每个进程中没有实现多线程，GIL可以说没什么用了
</p></li>
</ul>
</div>
</div>
<div id="outline-container-h:f49a5ff1-4b19-4fd7-b083-96f58234d4d0" class="outline-4">
<h4 id="h:f49a5ff1-4b19-4fd7-b083-96f58234d4d0">进程池举例</h4>
<div class="outline-text-4" id="text-h:f49a5ff1-4b19-4fd7-b083-96f58234d4d0">
<p>
multiprocessing.Pool 是进程池类
</p>

<pre class="example" id="org325c70a">
apply(self, func, args=(), kwds={})      阻塞执行，导致主进程执行其他子进程就像一个个执行
apply_async(self, func, args=(), kwds={}, callback=None, error_callback=None) 与apply方法用法一致，非阻塞异步执行，得到结果后会执行回调
close()      关闭池，池不能再接受新的任务，所有任务完成后退出进程
terminate()  立即结束工作进程，不再处理未处理的任务
join()       主进程阻塞等待子进程的退出， join方法要在close或terminate之后使用
</pre>

<p>
同步调用
</p>
<ul class="org-ul">
<li>pool.apply 同步阻塞的方法，多进程串行</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> multiprocessing
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> logging


<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s %(processName)s %(threadName)s %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">calc</span>():
    <span style="color: #483d8b;">sum</span> = 0
    <span style="color: #a020f0;">for</span> _ <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(100000000): <span style="color: #b22222;">#</span><span style="color: #b22222;">1&#20159;</span>
        <span style="color: #483d8b;">sum</span> += 1
    logging.info(<span style="color: #483d8b;">sum</span>)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36827;&#31243;&#26377;&#27809;&#26377;&#36820;&#22238;&#20540;&#65311;</span>
    <span style="color: #a020f0;">return</span> multiprocessing.current_process().name, <span style="color: #483d8b;">sum</span>

<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">'__main__'</span>:
    <span style="color: #a0522d;">start</span> = datetime.datetime.now()
    <span style="color: #a0522d;">pool</span> = multiprocessing.Pool(4)

    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(4):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#20540;&#65292;&#21516;&#27493;&#35843;&#29992;&#65292;&#27880;&#24847;&#35266;&#23519;CPU&#20351;&#29992;</span>
        <span style="color: #a0522d;">ret</span> = pool.<span style="color: #483d8b;">apply</span>(calc, ) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#27493;&#26041;&#27861;&#65292;&#38459;&#22622;&#30340;</span>
        logging.info(<span style="color: #8b2252;">'{1} --- {0}'</span>.<span style="color: #483d8b;">format</span>(ret, <span style="color: #483d8b;">type</span>(ret)))
    pool.close() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#20877;&#25509;&#25910;&#26032;&#30340;&#36827;&#31243;</span>
    pool.join()

    <span style="color: #a0522d;">delta</span> = (datetime.datetime.now() - start).total_seconds()
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'&#22810;&#36827;&#31243;&#27744; &#21516;&#27493; &#32791;&#26102;={}s'</span>.<span style="color: #483d8b;">format</span>(delta))

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:35:09,261 SpawnPoolWorker-1 MainThread 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:35:09,262 MainProcess MainThread &lt;class 'tuple'&gt; --- ('SpawnPoolWorker-1', 100000000)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:35:14,554 SpawnPoolWorker-2 MainThread 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:35:14,554 MainProcess MainThread &lt;class 'tuple'&gt; --- ('SpawnPoolWorker-2', 100000000)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:35:19,411 SpawnPoolWorker-3 MainThread 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:35:19,412 MainProcess MainThread &lt;class 'tuple'&gt; --- ('SpawnPoolWorker-3', 100000000)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:35:24,256 SpawnPoolWorker-4 MainThread 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:35:24,256 MainProcess MainThread &lt;class 'tuple'&gt; --- ('SpawnPoolWorker-4', 100000000)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22810;&#36827;&#31243;&#27744; &#21516;&#27493; &#32791;&#26102;=20.704703s</span>
</pre>
</div>

<p>
异步调用
</p>
<ul class="org-ul">
<li>pool.aaply_async 异步非阻塞，真并行</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> multiprocessing
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> logging


<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s %(processName)s %(threadName)s %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">calc</span>():
    <span style="color: #483d8b;">sum</span> = 0
    <span style="color: #a020f0;">for</span> _ <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(100000000): <span style="color: #b22222;">#</span><span style="color: #b22222;">1&#20159;</span>
        <span style="color: #483d8b;">sum</span> += 1
    logging.info(<span style="color: #483d8b;">sum</span>)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36827;&#31243;&#26377;&#27809;&#26377;&#36820;&#22238;&#20540;&#65311;</span>
    <span style="color: #a020f0;">return</span> multiprocessing.current_process().name, <span style="color: #483d8b;">sum</span>

<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">'__main__'</span>:
    <span style="color: #a0522d;">start</span> = datetime.datetime.now()
    <span style="color: #a0522d;">pool</span> = multiprocessing.Pool(4)

    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(4):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">ret = pool.apply(calc, ) #&#21516;&#27493;&#26041;&#27861;&#65292;&#38459;&#22622;&#30340;</span>
        <span style="color: #a0522d;">ret</span> = pool.apply_async(calc)  <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24322;&#27493;&#26041;&#27861;&#65292;&#27809;&#26377;&#38459;&#22622;</span>
        logging.info(<span style="color: #8b2252;">'{1} --- {0}'</span>.<span style="color: #483d8b;">format</span>(ret, <span style="color: #483d8b;">type</span>(ret)))
    pool.close() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#20877;&#25509;&#25910;&#26032;&#30340;&#36827;&#31243;</span>
    pool.join()

    <span style="color: #a0522d;">delta</span> = (datetime.datetime.now() - start).total_seconds()
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'&#22810;&#36827;&#31243;&#27744; &#24322;&#27493; &#32791;&#26102;={}s'</span>.<span style="color: #483d8b;">format</span>(delta))

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:37:45,966 MainProcess MainThread &lt;class 'multiprocessing.pool.ApplyResult'&gt; --- &lt;multiprocessing.pool.ApplyResult object at 0x000001F2E3C73770&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:37:45,966 MainProcess MainThread &lt;class 'multiprocessing.pool.ApplyResult'&gt; --- &lt;multiprocessing.pool.ApplyResult object at 0x000001F2E3D856D0&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:37:45,966 MainProcess MainThread &lt;class 'multiprocessing.pool.ApplyResult'&gt; --- &lt;multiprocessing.pool.ApplyResult object at 0x000001F2E3D85810&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:37:45,966 MainProcess MainThread &lt;class 'multiprocessing.pool.ApplyResult'&gt; --- &lt;multiprocessing.pool.ApplyResult object at 0x000001F2E3D949D0&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:37:53,632 SpawnPoolWorker-1 MainThread 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:37:53,739 SpawnPoolWorker-3 MainThread 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:37:53,768 SpawnPoolWorker-4 MainThread 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:37:54,047 SpawnPoolWorker-2 MainThread 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22810;&#36827;&#31243;&#27744; &#24322;&#27493; &#32791;&#26102;=8.231741s</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> multiprocessing
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">import</span> logging


<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s %(processName)s %(threadName)s %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">calc</span>():
    <span style="color: #483d8b;">sum</span> = 0
    <span style="color: #a020f0;">for</span> _ <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(100000000): <span style="color: #b22222;">#</span><span style="color: #b22222;">1&#20159;</span>
        <span style="color: #483d8b;">sum</span> += 1
    logging.info(<span style="color: #483d8b;">sum</span>)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36827;&#31243;&#26377;&#27809;&#26377;&#36820;&#22238;&#20540;&#65311;</span>
    <span style="color: #a020f0;">return</span> multiprocessing.current_process().name, <span style="color: #483d8b;">sum</span>

<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">'__main__'</span>:
    <span style="color: #a0522d;">start</span> = datetime.datetime.now()
    <span style="color: #a0522d;">pool</span> = multiprocessing.Pool(4)

    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(4):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">ret = pool.apply(calc, ) #&#21516;&#27493;&#26041;&#27861;&#65292;&#38459;&#22622;&#30340;</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24322;&#27493;&#25343;&#21040;&#30340;&#36820;&#22238;&#20540;&#26159;&#20160;&#20040;&#65292;&#22238;&#35843;&#36215;&#20102;&#20160;&#20040;&#20316;&#29992;</span>
        <span style="color: #a0522d;">ret</span> = pool.apply_async(
            calc, callback=<span style="color: #a020f0;">lambda</span> value: logging.info(<span style="color: #8b2252;">'**{}**'</span>.<span style="color: #483d8b;">format</span>(value))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24322;&#27493;&#26041;&#27861;&#65292;&#27809;&#26377;&#38459;&#22622;</span>
        logging.info(<span style="color: #8b2252;">'{1} --- {0}'</span>.<span style="color: #483d8b;">format</span>(ret, <span style="color: #483d8b;">type</span>(ret)))
    pool.close() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19981;&#20877;&#25509;&#25910;&#26032;&#30340;&#36827;&#31243;</span>
    pool.join()

    <span style="color: #a0522d;">delta</span> = (datetime.datetime.now() - start).total_seconds()
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'&#22810;&#36827;&#31243;&#27744; &#24322;&#27493; &#32791;&#26102;={}s'</span>.<span style="color: #483d8b;">format</span>(delta))

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:46:50,627 MainProcess MainThread &lt;class 'multiprocessing.pool.ApplyResult'&gt; --- &lt;multiprocessing.pool.ApplyResult object at 0x0000020A9F203770&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:46:50,627 MainProcess MainThread &lt;class 'multiprocessing.pool.ApplyResult'&gt; --- &lt;multiprocessing.pool.ApplyResult object at 0x0000020A9F2F56D0&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:46:50,627 MainProcess MainThread &lt;class 'multiprocessing.pool.ApplyResult'&gt; --- &lt;multiprocessing.pool.ApplyResult object at 0x0000020A9F2F5810&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:46:50,627 MainProcess MainThread &lt;class 'multiprocessing.pool.ApplyResult'&gt; --- &lt;multiprocessing.pool.ApplyResult object at 0x0000020A9F3048A0&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:47:01,368 SpawnPoolWorker-1 MainThread 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:47:01,369 MainProcess Thread-3 (_handle_results) **('SpawnPoolWorker-1', 100000000)**</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:47:02,295 SpawnPoolWorker-2 MainThread 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:47:02,296 MainProcess Thread-3 (_handle_results) **('SpawnPoolWorker-2', 100000000)**</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:47:02,412 SpawnPoolWorker-4 MainThread 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:47:02,413 MainProcess Thread-3 (_handle_results) **('SpawnPoolWorker-4', 100000000)**</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:47:02,915 SpawnPoolWorker-3 MainThread 100000000</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 00:47:02,918 MainProcess Thread-3 (_handle_results) **('SpawnPoolWorker-3', 100000000)**</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#22810;&#36827;&#31243;&#27744; &#24322;&#27493; &#32791;&#26102;=12.441383s</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:990dc2ac-90d9-410c-8c60-d3c3205f0886" class="outline-4">
<h4 id="h:990dc2ac-90d9-410c-8c60-d3c3205f0886">多进程、多线程的选择</h4>
<div class="outline-text-4" id="text-h:990dc2ac-90d9-410c-8c60-d3c3205f0886">
<p>
CPU密集型
</p>
<ul class="org-ul">
<li>CPython中使用到了GIL，多线程的时候锁相互竞争，且多核优势不能发挥，选用Python多进程效率更高</li>
</ul>

<p>
IO密集型
</p>
<ul class="org-ul">
<li>在Python中适合是用多线程，可以减少多进程间IO的序列化开销。且在IO等待的时候，切换到其他线程继续执行，效率不错。</li>
</ul>
</div>
<div id="outline-container-h:4a230ff1-36bf-42ee-ac3d-1d76e3633b19" class="outline-5">
<h5 id="h:4a230ff1-36bf-42ee-ac3d-1d76e3633b19">应用</h5>
<div class="outline-text-5" id="text-h:4a230ff1-36bf-42ee-ac3d-1d76e3633b19">
<p>
请求/应答模型：WEB应用中常见的处理模型
</p>

<p>
master启动多个worker工作进程，一般和CPU数目相同。发挥多核优势。
</p>

<p>
worker工作进程中，往往需要操作网络IO和磁盘IO，启动多线程，提高并发处理能力。worker处理用户的请求，往往需要等待数据，处理完请求还要通过网络IO返回响应。
</p>

<p>
这就是nginx工作模式
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-h:b21f750f-34a4-409d-8b78-c2ef1591ba41" class="outline-3">
<h3 id="h:b21f750f-34a4-409d-8b78-c2ef1591ba41">Linux的特殊进程</h3>
<div class="outline-text-3" id="text-h:b21f750f-34a4-409d-8b78-c2ef1591ba41">
<p>
在Linux/Unix中，通过父进程创建子进程
</p>
</div>
<div id="outline-container-h:5be0308a-8e9a-4292-87bc-37dd75458fe6" class="outline-4">
<h4 id="h:5be0308a-8e9a-4292-87bc-37dd75458fe6">僵尸进程</h4>
<div class="outline-text-4" id="text-h:5be0308a-8e9a-4292-87bc-37dd75458fe6">
<p>
一个进程使用了fork创建了子进程，如果子进程终止进入僵死状态，而父进程并
没有调用wait或者waitpid获取子进程的状态信息，那么子进程仍留下一个数据
结构保存在系统中，这种进程称为僵尸进程。
</p>

<p>
僵尸进程会占用一定的内存空间，还占用了进程号，所以一定要避免大量的僵尸进程产生。有很多方法可以避免僵尸进程。
</p>
</div>
</div>
<div id="outline-container-h:405524b1-b8da-4cc0-acae-757594a86989" class="outline-4">
<h4 id="h:405524b1-b8da-4cc0-acae-757594a86989">孤儿进程</h4>
<div class="outline-text-4" id="text-h:405524b1-b8da-4cc0-acae-757594a86989">
<p>
父进程退出，而它的子进程仍在运行，那么这些子进程就会成为孤儿进程。孤儿进程会被init进程（进程号为1）收养，并由init进程对它们完成状态收集工作。
</p>

<p>
init进程会循环调用wait这些孤儿进程，所以，孤儿进程没有什么危害。
</p>
</div>
</div>
<div id="outline-container-h:ee05aa27-3ee5-4519-8e42-1ddfc669cf1a" class="outline-4">
<h4 id="h:ee05aa27-3ee5-4519-8e42-1ddfc669cf1a">守护进程</h4>
<div class="outline-text-4" id="text-h:ee05aa27-3ee5-4519-8e42-1ddfc669cf1a">
<p>
它是运行在后台的一种特殊进程。它独立于控制终端并周期性执行某种任务或等待处理某些事件。
</p>

<p>
守护进程的父进程是init进程，因为其父进程已经故意被终止掉了。
</p>

<p>
守护进程相对于普通的孤儿进程需要做一些特殊处理。
</p>
</div>
</div>
</div>
</section>
<section id="outline-container-h:a205ae9f-e7aa-4e6e-be24-23a387b35140" class="outline-2">
<h2 id="h:a205ae9f-e7aa-4e6e-be24-23a387b35140">concurrent包（异步并行任务编程模块）</h2>
<div class="outline-text-2" id="text-h:a205ae9f-e7aa-4e6e-be24-23a387b35140">
</div>
<div id="outline-container-h:66c691a6-1da9-47c6-8e13-3712e734b9c2" class="outline-3">
<h3 id="h:66c691a6-1da9-47c6-8e13-3712e734b9c2">concurrent.futures包</h3>
<div class="outline-text-3" id="text-h:66c691a6-1da9-47c6-8e13-3712e734b9c2">
<p>
3.2版本引入的模块
</p>

<p>
异步并行任务编程模块，提供一个高级的异步可执行的便利接口。
</p>

<p>
提供了2个池执行器
</p>
<ul class="org-ul">
<li>ThreadPoolExecutor 异步调用的线程池的Executor</li>
<li>ProcessPoolExecutor 异步调用的进程池的Executor</li>
</ul>
</div>
<div id="outline-container-h:5c637564-d745-498f-87ab-74079d5cb582" class="outline-4">
<h4 id="h:5c637564-d745-498f-87ab-74079d5cb582">ThreadPoolExecutor对象</h4>
<div class="outline-text-4" id="text-h:5c637564-d745-498f-87ab-74079d5cb582">
<p>
首先需要定义一个池的执行器对象，Executor类子类对象
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #0000ff;">ThreadPoolExecutor</span>(<span style="color: #a0522d;">max_workers</span>=1)   &#27744;&#20013;&#33267;&#22810;&#21019;&#24314;max_workers&#20010;&#32447;&#31243;&#30340;&#27744;&#26469;&#21516;&#26102;&#24322;&#27493;&#25191;&#34892;&#65292;&#36820;&#22238; Executor&#23454;&#20363;
<span style="color: #0000ff;">submit</span>(fn, *args, **kwargs)         &#25552;&#20132;&#25191;&#34892;&#30340;&#20989;&#25968;&#21450;&#20854;&#21442;&#25968;&#65292;&#36820;&#22238;Future&#31867;&#30340;&#23454;&#20363;
<span style="color: #0000ff;">shutdown</span>(<span style="color: #a0522d;">wait</span>=True                  &#28165;&#29702;&#27744;
</pre>
</div>

<p>
Future类
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #a020f0;">done</span>()      &#22914;&#26524;&#35843;&#29992;&#34987;&#25104;&#21151;&#30340;&#21462;&#28040;&#25110;&#32773;&#25191;&#34892;&#23436;&#25104;&#65292;&#36820;&#22238;True, &#21542;&#21017;False. &#19981;&#38459;&#22622;&#12290;
<span style="color: #0000ff;">cancelled</span>() &#22914;&#26524;&#35843;&#29992;&#34987;&#25104;&#21151;&#30340;&#21462;&#28040;&#65292;&#36820;&#22238;True
<span style="color: #0000ff;">running</span>()   &#22914;&#26524;&#27491;&#22312;&#36816;&#34892;&#19988;&#19981;&#33021;&#34987;&#21462;&#28040;&#65292;&#36820;&#22238;True
<span style="color: #0000ff;">cancel</span>()
&#23581;&#35797;&#21462;&#28040;&#35843;&#29992;&#12290;&#22914;&#26524;&#24050;&#32463;&#25191;&#34892;&#19988;&#19981;&#33021;&#21462;&#28040;&#36820;&#22238;False&#65292;&#21542;&#21017;&#36820;&#22238;True&#12290;&#20063;&#23601;&#26159;PENDING&#29366;&#24577;&#30340;&#21487;&#20197;&#21462;&#28040;&#65292;&#23601;&#26159;&#25552;&#20132;&#20102;
&#30340;&#20219;&#21153;&#22788;&#20110;&#39044;&#22791;&#29366;&#24577;&#12290;

<span style="color: #0000ff;">result</span>(<span style="color: #a0522d;">timeout</span>=None) 
&#21462;&#36820;&#22238;&#30340;&#32467;&#26524;&#65292;timeout&#20026;None&#65292;&#19968;&#30452;&#31561;&#24453;&#36820;&#22238;&#65307;timeout&#35774;&#32622;&#21040;&#26399;&#65292;&#25243;&#20986;concurrent.futures.TimeoutError &#24322;&#24120;

<span style="color: #0000ff;">exception</span>(<span style="color: #a0522d;">timeout</span>=None) &#21462;&#36820;&#22238;&#30340;&#24322;&#24120;&#65292;timeout&#20026;None&#65292;&#19968;&#30452;&#31561;&#24453;&#36820;&#22238;&#65307;timeout&#35774;&#32622;&#21040;&#26399;&#65292;&#25243;&#20986;concurrent.futures.TimeoutError &#24322;&#24120;
</pre>
</div>

<p>
ThreadPoolExecutor例子
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> concurrent.futures <span style="color: #a020f0;">import</span> ThreadPoolExecutor
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging


<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s [%(processName)s %(process)d] [%(threadName)s %(thread)d]** %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#26412;&#20351;&#29992;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>():
    logging.info(<span style="color: #8b2252;">'start~~~~'</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27491;&#24120;&#25191;&#34892;&#30340;&#20195;&#30721;</span>
    time.sleep(5)
    logging.info(<span style="color: #8b2252;">'finished'</span>)

<span style="color: #a0522d;">executor</span> = ThreadPoolExecutor(1)
<span style="color: #a0522d;">future</span> = executor.submit(worker) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20219;&#21153;&#25552;&#20132;&#21518;&#31435;&#21363;&#21551;&#21160;</span>
<span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> future.done(): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20219;&#21153;&#20570;&#23436;&#20102;&#21527;</span>
    logging.info(<span style="color: #8b2252;">'Not done. {}'</span>.<span style="color: #483d8b;">format</span>(future)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;future&#29366;&#24577;</span>
    time.sleep(1)

executor.shutdown()
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'='</span> * 30)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 11:32:59,859 [MainProcess 26644] [ThreadPoolExecutor-0_0 5764]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 11:32:59,859 [MainProcess 26644] [MainThread 26988]** Not done. &lt;Future at 0x1fe24476f90 state=running&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 11:33:00,860 [MainProcess 26644] [MainThread 26988]** Not done. &lt;Future at 0x1fe24476f90 state=running&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 11:33:01,861 [MainProcess 26644] [MainThread 26988]** Not done. &lt;Future at 0x1fe24476f90 state=running&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 11:33:02,861 [MainProcess 26644] [MainThread 26988]** Not done. &lt;Future at 0x1fe24476f90 state=running&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 11:33:03,862 [MainProcess 26644] [MainThread 26988]** Not done. &lt;Future at 0x1fe24476f90 state=running&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 11:33:04,859 [MainProcess 26644] [ThreadPoolExecutor-0_0 5764]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">==============================</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> concurrent.futures <span style="color: #a020f0;">import</span> ThreadPoolExecutor
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging


<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s [%(processName)s %(process)d] [%(threadName)s %(thread)d]** %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#26412;&#20351;&#29992;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">Future&#23454;&#20363;&#30340;&#29366;&#24577;state: pending&#20934;&#22791;&#34987;&#25191;&#34892;; running&#27491;&#22312;&#34987;&#25191;&#34892;&#65307;finished&#25191;&#34892;&#23436;&#25104;&#65307;canncelled &#25104;&#21151;&#21462;&#28040;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">done() &#25104;&#21151;&#25191;&#34892;&#20102;&#25110;&#25104;&#21151;&#21462;&#28040;&#20102;finished, canncelled</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29366;&#24577;running&#65292;&#19981;&#20801;&#35768;cancel</span>


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>():
    logging.info(<span style="color: #8b2252;">'start~~~~'</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27491;&#24120;&#25191;&#34892;&#30340;&#20195;&#30721;</span>
    time.sleep(5)
    logging.info(<span style="color: #8b2252;">'finished'</span>)

<span style="color: #a0522d;">executor</span> = ThreadPoolExecutor(1)
<span style="color: #a0522d;">future</span> = executor.submit(worker) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20219;&#21153;&#25552;&#20132;&#21518;&#31435;&#21363;&#21551;&#21160;</span>
<span style="color: #a0522d;">f1</span> = executor.submit(worker)
<span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> future.done(): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20219;&#21153;&#20570;&#23436;&#20102;&#21527;</span>
    logging.info(<span style="color: #8b2252;">'Not done. {} | {}'</span>.<span style="color: #483d8b;">format</span>(future, f1)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;future&#29366;&#24577;</span>
    time.sleep(1)
    f1.cancel() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21462;&#28040;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">future.cancel()#&#19968;&#26086;running&#65292;&#19981;&#20801;&#35768;cancel</span>

<span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> f1.done(): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20219;&#21153;&#20570;&#23436;&#20102;&#21527;</span>
    logging.info(<span style="color: #8b2252;">'Not done. {} | {}'</span>.<span style="color: #483d8b;">format</span>(future, f1)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;future&#29366;&#24577;</span>
    time.sleep(1)

<span style="color: #483d8b;">print</span>(future.done(), f1.done())

executor.shutdown()
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'='</span> * 30)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 14:21:56,842 [MainProcess 27540] [ThreadPoolExecutor-0_0 20428]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 14:21:56,842 [MainProcess 27540] [MainThread 24160]** Not done. &lt;Future at 0x298c818af90 state=running&gt; | &lt;Future at 0x298c811f250 state=pending&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 14:21:57,842 [MainProcess 27540] [MainThread 24160]** Not done. &lt;Future at 0x298c818af90 state=running&gt; | &lt;Future at 0x298c811f250 state=cancelled&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 14:21:58,843 [MainProcess 27540] [MainThread 24160]** Not done. &lt;Future at 0x298c818af90 state=running&gt; | &lt;Future at 0x298c811f250 state=cancelled&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 14:21:59,844 [MainProcess 27540] [MainThread 24160]** Not done. &lt;Future at 0x298c818af90 state=running&gt; | &lt;Future at 0x298c811f250 state=cancelled&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 14:22:00,845 [MainProcess 27540] [MainThread 24160]** Not done. &lt;Future at 0x298c818af90 state=running&gt; | &lt;Future at 0x298c811f250 state=cancelled&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 14:22:01,842 [MainProcess 27540] [ThreadPoolExecutor-0_0 20428]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">==============================</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> concurrent.futures <span style="color: #a020f0;">import</span> ThreadPoolExecutor
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging


<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s [%(processName)s %(process)d] [%(threadName)s %(thread)d]** %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#26412;&#20351;&#29992;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">Future&#23454;&#20363;&#30340;&#29366;&#24577;state: pending&#20934;&#22791;&#34987;&#25191;&#34892;; running&#27491;&#22312;&#34987;&#25191;&#34892;&#65307;finished&#25191;&#34892;&#23436;&#25104;&#65307;canncelled &#25104;&#21151;&#21462;&#28040;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">done() &#25104;&#21151;&#25191;&#34892;&#20102;&#25110;&#25104;&#21151;&#21462;&#28040;&#20102;finished, canncelled&#65292;&#20219;&#21153;&#25191;&#34892;&#26102;&#26377;&#24322;&#24120;&#32456;&#27490;&#20102;&#20063;&#31639;finished</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29366;&#24577;running&#65292;&#19981;&#20801;&#35768;cancel</span>


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>():
    logging.info(<span style="color: #8b2252;">'start~~~~'</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27491;&#24120;&#25191;&#34892;&#30340;&#20195;&#30721;</span>
    time.sleep(2)
    logging.info(<span style="color: #8b2252;">'finished'</span>)

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker1</span>():
    logging.info(<span style="color: #8b2252;">'start~~~~'</span>)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27491;&#24120;&#25191;&#34892;&#30340;&#20195;&#30721;</span>
    time.sleep(5)
    1/0
    logging.info(<span style="color: #8b2252;">'finished'</span>)
    <span style="color: #a020f0;">return</span> 1234

<span style="color: #a0522d;">executor</span> = ThreadPoolExecutor(1)
<span style="color: #a0522d;">future</span> = executor.submit(worker) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20219;&#21153;&#25552;&#20132;&#21518;&#31435;&#21363;&#21551;&#21160;</span>
<span style="color: #a0522d;">f1</span> = executor.submit(worker1)

<span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> future.done(): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20219;&#21153;&#20570;&#23436;&#20102;&#21527;</span>
    logging.info(<span style="color: #8b2252;">'Not done. {} | {}'</span>.<span style="color: #483d8b;">format</span>(future, f1)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;future&#29366;&#24577;</span>
    time.sleep(1)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">logging.info(f1.result(2)) #&#40664;&#35748;&#19968;&#30452;&#38459;&#22622;&#21040;done. &#21462;&#36820;&#22238;&#30340;&#32467;&#26524;,&#31561;&#24453;2&#31186;&#65292;&#36229;&#26102;&#20102;&#25243;&#24322;&#24120;TimeoutError</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">result() &#22914;&#26524;&#20219;&#21153;&#20989;&#25968;&#25191;&#34892;&#26102;&#32447;&#31243;&#20869;&#37096;&#26377;&#24322;&#24120;&#65292;&#27809;&#31649;&#12290;&#25343;&#32467;&#26524;&#23601;&#20250;&#25243;&#24322;&#24120;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#20351;&#29992;try&#25429;&#33719;&#65307;&#20808;&#21028;&#26029;</span>

    <span style="color: #a0522d;">e</span> = f1.exception()
    logging.info(<span style="color: #8b2252;">"{} {}"</span>.<span style="color: #483d8b;">format</span>(<span style="color: #483d8b;">type</span>(e), e)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;&#19968;&#30452;&#38459;&#22622;&#21040;done. &#21462;&#36820;&#22238;&#30340;&#24322;&#24120;,&#31561;&#24453;x&#31186;&#65292;&#36229;&#26102;&#20102;&#25243;&#24322;&#24120;TimeoutError</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#20219;&#21153;&#20869;&#37096;&#26377;&#24322;&#24120;&#65292;exception()&#21487;&#20197;&#27491;&#24120;&#21462;&#36208;&#35813;&#24322;&#24120;&#65292;&#25343;&#21040;&#30340;&#26159;&#24322;&#24120;&#23454;&#20363;&#12290;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#20219;&#21153;&#27491;&#24120;&#25191;&#34892;&#32467;&#26463;&#65292;&#24322;&#24120;&#23545;&#35937;&#25343;&#19981;&#21040;&#33719;&#21462;&#21040;&#19968;&#20010;None</span>

<span style="color: #a020f0;">while</span> <span style="color: #a020f0;">not</span> f1.done(): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20219;&#21153;&#20570;&#23436;&#20102;&#21527;</span>
    logging.info(<span style="color: #8b2252;">'Not done. {} | {}'</span>.<span style="color: #483d8b;">format</span>(future, f1)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;future&#29366;&#24577;</span>
    time.sleep(1)

<span style="color: #483d8b;">print</span>(future.done(), f1.done())

executor.shutdown()
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'='</span> * 30)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 15:34:59,118 [MainProcess 6060] [ThreadPoolExecutor-0_0 32376]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 15:34:59,118 [MainProcess 6060] [MainThread 23788]** Not done. &lt;Future at 0x1e3f7feef90 state=running&gt; | &lt;Future at 0x1e3f7f7f250 state=pending&gt;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 15:35:01,118 [MainProcess 6060] [ThreadPoolExecutor-0_0 32376]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 15:35:01,119 [MainProcess 6060] [ThreadPoolExecutor-0_0 32376]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 15:35:06,120 [MainProcess 6060] [MainThread 23788]** &lt;class 'ZeroDivisionError'&gt; division by zero</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">==============================</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">all</span>([]))        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#20010;False&#37117;&#27809;&#26377;&#65292;True</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">all</span>([0, 0, 0])) <span style="color: #b22222;">#</span><span style="color: #b22222;">False</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">all</span>([1]))       <span style="color: #b22222;">#</span><span style="color: #b22222;">True</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">all</span>([1, 1, 1, 0])) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#35201;&#26377;&#19968;&#20010;False&#65292;&#23601;&#26159;False</span>
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">any</span>([]))        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#20010;&#37117;&#27809;&#26377;, False</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">any</span>([0, 0, 0, 1])) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21482;&#35201;&#26377;&#19968;&#20010;True&#65292;True</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> concurrent.futures <span style="color: #a020f0;">import</span> ThreadPoolExecutor
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging
<span style="color: #a020f0;">import</span> threading


<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s [%(processName)s %(process)d] [%(threadName)s %(thread)d]** %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22522;&#26412;&#20351;&#29992;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">Future&#23454;&#20363;&#30340;&#29366;&#24577;state: pending&#20934;&#22791;&#34987;&#25191;&#34892;; running&#27491;&#22312;&#34987;&#25191;&#34892;&#65307;finished&#25191;&#34892;&#23436;&#25104;&#65307;canncelled &#25104;&#21151;&#21462;&#28040;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">done() &#25104;&#21151;&#25191;&#34892;&#20102;&#25110;&#25104;&#21151;&#21462;&#28040;&#20102;finished, canncelled&#65292;&#20219;&#21153;&#25191;&#34892;&#26102;&#26377;&#24322;&#24120;&#32456;&#27490;&#20102;&#20063;&#31639;finished</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29366;&#24577;running&#65292;&#19981;&#20801;&#35768;cancel</span>


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(n):
    logging.info(<span style="color: #8b2252;">'start~~~~'</span>)
    time.sleep(5)
    logging.info(<span style="color: #8b2252;">'finished'</span>)
    <span style="color: #a020f0;">return</span> n, n, n

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#32447;&#31243;&#27744;&#65292;&#27744;&#23481;&#37327;&#20026;3</span>
<span style="color: #a0522d;">executor</span> = ThreadPoolExecutor(3)
time.sleep(1)
<span style="color: #483d8b;">print</span>(threading.<span style="color: #483d8b;">enumerate</span>())

<span style="color: #a0522d;">fs</span> = []
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(6):
    <span style="color: #a0522d;">f</span> = executor.submit(worker, i) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20219;&#21153;&#25552;&#20132;&#21518;&#31435;&#21363;&#21551;&#21160;</span>
    fs.append(f)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'*'</span> * 30)

<span style="color: #a020f0;">while</span> <span style="color: #008b8b;">True</span>:
    time.sleep(2)

    <span style="color: #a0522d;">states</span> = [f.done() <span style="color: #a020f0;">for</span> f <span style="color: #a020f0;">in</span> fs]
    <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">all</span>(states):
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'all done'</span>)
        <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> fs:
            <span style="color: #483d8b;">print</span>(i.done(), i.result())
        <span style="color: #a020f0;">break</span>
    <span style="color: #483d8b;">print</span>(states)
    <span style="color: #483d8b;">print</span>(threading.<span style="color: #483d8b;">enumerate</span>())

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">[&lt;_MainThread(MainThread, started 10956)&gt;]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:10:01,236 [MainProcess 16524] [ThreadPoolExecutor-0_0 10592]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:10:01,237 [MainProcess 16524] [ThreadPoolExecutor-0_1 32156]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:10:01,237 [MainProcess 16524] [ThreadPoolExecutor-0_2 31680]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">******************************</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">[False, False, False, False, False, False]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">[&lt;_MainThread(MainThread, started 10956)&gt;, &lt;Thread(ThreadPoolExecutor-0_0, started 10592)&gt;, &lt;Thread(ThreadPoolExecutor-0_1, started 32156)&gt;, &lt;Thread(ThreadPoolExecutor-0_2, started 31680)&gt;]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">[False, False, False, False, False, False]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">[&lt;_MainThread(MainThread, started 10956)&gt;, &lt;Thread(ThreadPoolExecutor-0_0, started 10592)&gt;, &lt;Thread(ThreadPoolExecutor-0_1, started 32156)&gt;, &lt;Thread(ThreadPoolExecutor-0_2, started 31680)&gt;]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:10:06,237 [MainProcess 16524] [ThreadPoolExecutor-0_0 10592]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:10:06,238 [MainProcess 16524] [ThreadPoolExecutor-0_0 10592]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:10:06,239 [MainProcess 16524] [ThreadPoolExecutor-0_1 32156]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:10:06,240 [MainProcess 16524] [ThreadPoolExecutor-0_1 32156]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:10:06,239 [MainProcess 16524] [ThreadPoolExecutor-0_2 31680]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:10:06,240 [MainProcess 16524] [ThreadPoolExecutor-0_2 31680]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">[True, True, True, False, False, False]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">[&lt;_MainThread(MainThread, started 10956)&gt;, &lt;Thread(ThreadPoolExecutor-0_0, started 10592)&gt;, &lt;Thread(ThreadPoolExecutor-0_1, started 32156)&gt;, &lt;Thread(ThreadPoolExecutor-0_2, started 31680)&gt;]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">[True, True, True, False, False, False]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">[&lt;_MainThread(MainThread, started 10956)&gt;, &lt;Thread(ThreadPoolExecutor-0_0, started 10592)&gt;, &lt;Thread(ThreadPoolExecutor-0_1, started 32156)&gt;, &lt;Thread(ThreadPoolExecutor-0_2, started 31680)&gt;]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:10:11,239 [MainProcess 16524] [ThreadPoolExecutor-0_0 10592]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:10:11,240 [MainProcess 16524] [ThreadPoolExecutor-0_1 32156]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:10:11,241 [MainProcess 16524] [ThreadPoolExecutor-0_2 31680]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">all done</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True (0, 0, 0)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True (1, 1, 1)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True (2, 2, 2)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True (3, 3, 3)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True (4, 4, 4)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True (5, 5, 5)</span>
</pre>
</div>

<p>
wait() 方法
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> concurrent.futures <span style="color: #a020f0;">import</span> ThreadPoolExecutor, wait, Future
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging
<span style="color: #a020f0;">import</span> threading


<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s [%(processName)s %(process)d] [%(threadName)s %(thread)d]** %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(n):
    logging.info(<span style="color: #8b2252;">'start~~~~'</span>)
    time.sleep(3 + i )
    logging.info(<span style="color: #8b2252;">'finished'</span>)
    <span style="color: #a020f0;">if</span> n == 4:
        1/0
    <span style="color: #a020f0;">return</span> n, n, n

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#32447;&#31243;&#27744;&#65292;&#27744;&#23481;&#37327;&#20026;3</span>
<span style="color: #a0522d;">executor</span> = ThreadPoolExecutor(3)
time.sleep(1)
<span style="color: #483d8b;">print</span>(threading.<span style="color: #483d8b;">enumerate</span>())

<span style="color: #a0522d;">fs</span> = []
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(6):
    <span style="color: #a0522d;">f</span> = executor.submit(worker, i) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20219;&#21153;&#25552;&#20132;&#21518;&#31435;&#21363;&#21551;&#21160;</span>
    fs.append(f)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'*'</span> * 30)

<span style="color: #b22222;">#</span><span style="color: #b22222;">wait</span>
<span style="color: #a0522d;">ret</span> = wait(fs)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#25209;futures</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(ret), ret)
<span style="color: #483d8b;">print</span>(ret.done)
<span style="color: #483d8b;">print</span>(ret.not_done)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'='</span> * 30)

<span style="color: #a020f0;">for</span> x <span style="color: #a020f0;">in</span> ret.done:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">x:Future = x</span>
    <span style="color: #483d8b;">print</span>(x.done())
    <span style="color: #a020f0;">if</span> x.exception():
        <span style="color: #483d8b;">print</span>(x.exception())
    <span style="color: #a020f0;">else</span>:
        <span style="color: #483d8b;">print</span>(x.result())

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">[&lt;_MainThread(MainThread, started 29256)&gt;]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:42:34,242 [MainProcess 6280] [ThreadPoolExecutor-0_0 11956]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:42:34,243 [MainProcess 6280] [ThreadPoolExecutor-0_1 13216]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:42:34,243 [MainProcess 6280] [ThreadPoolExecutor-0_2 31820]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">******************************</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:42:38,243 [MainProcess 6280] [ThreadPoolExecutor-0_0 11956]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:42:38,244 [MainProcess 6280] [ThreadPoolExecutor-0_0 11956]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:42:39,243 [MainProcess 6280] [ThreadPoolExecutor-0_1 13216]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:42:39,244 [MainProcess 6280] [ThreadPoolExecutor-0_1 13216]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:42:42,244 [MainProcess 6280] [ThreadPoolExecutor-0_2 31820]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:42:42,245 [MainProcess 6280] [ThreadPoolExecutor-0_2 31820]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:42:46,245 [MainProcess 6280] [ThreadPoolExecutor-0_0 11956]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:42:47,244 [MainProcess 6280] [ThreadPoolExecutor-0_1 13216]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 16:42:50,246 [MainProcess 6280] [ThreadPoolExecutor-0_2 31820]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&lt;class 'concurrent.futures._base.DoneAndNotDoneFutures'&gt; DoneAndNotDoneFutures(done={&lt;Future at 0x2616c5d4830 state=finished returned tuple&gt;, &lt;Future at 0x2616c7fee40 state=finished returned tuple&gt;, &lt;Future at 0x2616c78f250 state=finished returned tuple&gt;, &lt;Future at 0x2616c811480 state=finished returned tuple&gt;, &lt;Future at 0x2616c78f890 state=finished returned tuple&gt;, &lt;Future at 0x2616c811940 state=finished raised ZeroDivisionError&gt;}, not_done=set())</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">{&lt;Future at 0x2616c5d4830 state=finished returned tuple&gt;, &lt;Future at 0x2616c7fee40 state=finished returned tuple&gt;, &lt;Future at 0x2616c78f250 state=finished returned tuple&gt;, &lt;Future at 0x2616c811480 state=finished returned tuple&gt;, &lt;Future at 0x2616c78f890 state=finished returned tuple&gt;, &lt;Future at 0x2616c811940 state=finished raised ZeroDivisionError&gt;}</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">set()</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">==============================</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">(5, 5, 5)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">(0, 0, 0)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">(1, 1, 1)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">(3, 3, 3)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">(2, 2, 2)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">True</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">division by zero</span>
</pre>
</div>

<p>
as_completed方法
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> concurrent.futures <span style="color: #a020f0;">import</span> ThreadPoolExecutor, wait, Future, as_completed
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging
<span style="color: #a020f0;">import</span> threading


<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s [%(processName)s %(process)d] [%(threadName)s %(thread)d]** %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(n):
    logging.info(<span style="color: #8b2252;">'start~~~~'</span>)
    time.sleep(n)
    logging.info(<span style="color: #8b2252;">'finished'</span>)
    <span style="color: #a020f0;">return</span> n, n, n

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#32447;&#31243;&#27744;&#65292;&#27744;&#23481;&#37327;&#20026;3</span>
<span style="color: #a0522d;">executor</span> = ThreadPoolExecutor(3)
time.sleep(1)
<span style="color: #483d8b;">print</span>(threading.<span style="color: #483d8b;">enumerate</span>())

<span style="color: #a0522d;">fs</span> = []
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> (3, 6, 9, 15, 20, 25):
    <span style="color: #a0522d;">f</span> = executor.submit(worker, i) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20219;&#21153;&#25552;&#20132;&#21518;&#31435;&#21363;&#21551;&#21160;</span>
    fs.append(f)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'*'</span> * 30)

<span style="color: #b22222;">#</span><span style="color: #b22222;">as_completed</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(as_completed(fs), '+++') #&#29983;&#25104;&#22120;</span>
<span style="color: #a020f0;">for</span> x <span style="color: #a020f0;">in</span> as_completed(fs): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38459;&#22622;&#21040;</span>
    logging.info(<span style="color: #8b2252;">'{} {} {}'</span>.<span style="color: #483d8b;">format</span>(<span style="color: #483d8b;">type</span>(x), x, x.result()))

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">[&lt;_MainThread(MainThread, started 3836)&gt;]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:04:33,893 [MainProcess 30716] [ThreadPoolExecutor-0_0 28676]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:04:33,894 [MainProcess 30716] [ThreadPoolExecutor-0_1 30972]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:04:33,894 [MainProcess 30716] [ThreadPoolExecutor-0_2 26244]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">******************************</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:04:36,894 [MainProcess 30716] [ThreadPoolExecutor-0_0 28676]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:04:36,894 [MainProcess 30716] [ThreadPoolExecutor-0_0 28676]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:04:36,895 [MainProcess 30716] [MainThread 3836]** &lt;class 'concurrent.futures._base.Future'&gt; &lt;Future at 0x1dae708ee40 state=finished returned tuple&gt; (3, 3, 3)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:04:39,894 [MainProcess 30716] [ThreadPoolExecutor-0_1 30972]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:04:39,895 [MainProcess 30716] [ThreadPoolExecutor-0_1 30972]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:04:39,895 [MainProcess 30716] [MainThread 3836]** &lt;class 'concurrent.futures._base.Future'&gt; &lt;Future at 0x1dae701f250 state=finished returned tuple&gt; (6, 6, 6)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:04:42,894 [MainProcess 30716] [ThreadPoolExecutor-0_2 26244]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:04:42,895 [MainProcess 30716] [ThreadPoolExecutor-0_2 26244]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:04:42,896 [MainProcess 30716] [MainThread 3836]** &lt;class 'concurrent.futures._base.Future'&gt; &lt;Future at 0x1dae701f890 state=finished returned tuple&gt; (9, 9, 9)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:04:51,896 [MainProcess 30716] [ThreadPoolExecutor-0_0 28676]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:04:51,896 [MainProcess 30716] [MainThread 3836]** &lt;class 'concurrent.futures._base.Future'&gt; &lt;Future at 0x1dae70a15b0 state=finished returned tuple&gt; (15, 15, 15)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:04:59,895 [MainProcess 30716] [ThreadPoolExecutor-0_1 30972]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:04:59,896 [MainProcess 30716] [MainThread 3836]** &lt;class 'concurrent.futures._base.Future'&gt; &lt;Future at 0x1dae70a1a70 state=finished returned tuple&gt; (20, 20, 20)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:05:07,896 [MainProcess 30716] [ThreadPoolExecutor-0_2 26244]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:05:07,897 [MainProcess 30716] [MainThread 3836]** &lt;class 'concurrent.futures._base.Future'&gt; &lt;Future at 0x1dae6e64830 state=finished returned tuple&gt; (25, 25, 25)</span>
</pre>
</div>

<p>
用as_completed多些。
</p>

<p>
线程池一旦创建了线程，就不需要频繁清除
</p>
</div>
</div>
<div id="outline-container-h:33a732a2-b3c8-44d9-9fbd-27f669ffc8f6" class="outline-4">
<h4 id="h:33a732a2-b3c8-44d9-9fbd-27f669ffc8f6">ProcessPoolExecutor对象</h4>
<div class="outline-text-4" id="text-h:33a732a2-b3c8-44d9-9fbd-27f669ffc8f6">
<p>
方法一样，就是使用多进程完成
</p>

<p>
ProcessPoolExecutor例子
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> concurrent.futures <span style="color: #a020f0;">import</span> wait, Future, as_completed, ProcessPoolExecutor
<span style="color: #a020f0;">import</span> time
<span style="color: #a020f0;">import</span> logging
<span style="color: #a020f0;">import</span> threading


<span style="color: #a0522d;">FORMAT</span> = <span style="color: #8b2252;">'%(asctime)s [%(processName)s %(process)d] [%(threadName)s %(thread)d]** %(message)s'</span>
logging.basicConfig(<span style="color: #483d8b;">format</span>=FORMAT, level=logging.INFO)


<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">worker</span>(n):
    logging.info(<span style="color: #8b2252;">'start~~~~'</span>)
    time.sleep(n)
    logging.info(<span style="color: #8b2252;">'finished'</span>)
    <span style="color: #a020f0;">return</span> n, n, n

<span style="color: #a020f0;">if</span> <span style="color: #483d8b;">__name__</span> == <span style="color: #8b2252;">'__main__'</span>:

    <span style="color: #a0522d;">executor</span> = ProcessPoolExecutor(3)
    <span style="color: #a020f0;">with</span> executor:
        time.sleep(1)
        <span style="color: #483d8b;">print</span>(threading.<span style="color: #483d8b;">enumerate</span>())

        <span style="color: #a0522d;">fs</span> = []
        <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> (3, 6, 9, 15, 20, 25):
            <span style="color: #a0522d;">f</span> = executor.submit(worker, i) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20219;&#21153;&#25552;&#20132;&#21518;&#31435;&#21363;&#21551;&#21160;</span>
            fs.append(f)
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'*'</span> * 30)

        <span style="color: #b22222;">#</span><span style="color: #b22222;">as_completed</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(as_completed(fs), '+++') #&#29983;&#25104;&#22120;</span>
        <span style="color: #a020f0;">for</span> x <span style="color: #a020f0;">in</span> as_completed(fs): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#38459;&#22622;&#21040;</span>
            logging.info(<span style="color: #8b2252;">'{} {} {}'</span>.<span style="color: #483d8b;">format</span>(<span style="color: #483d8b;">type</span>(x), x, x.result()))

        <span style="color: #b22222;"># </span><span style="color: #b22222;">executor.shutdown()</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">[&lt;_MainThread(MainThread, started 4196)&gt;]</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">******************************</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:06:49,258 [SpawnProcess-1 25644] [MainThread 30572]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:06:49,270 [SpawnProcess-2 9548] [MainThread 31708]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:06:49,285 [SpawnProcess-3 29000] [MainThread 22776]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:06:52,259 [SpawnProcess-1 25644] [MainThread 30572]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:06:52,260 [SpawnProcess-1 25644] [MainThread 30572]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:06:52,260 [MainProcess 2824] [MainThread 4196]** &lt;class 'concurrent.futures._base.Future'&gt; &lt;Future at 0x130612078c0 state=finished returned tuple&gt; (3, 3, 3)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:06:55,271 [SpawnProcess-2 9548] [MainThread 31708]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:06:55,271 [SpawnProcess-2 9548] [MainThread 31708]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:06:55,271 [MainProcess 2824] [MainThread 4196]** &lt;class 'concurrent.futures._base.Future'&gt; &lt;Future at 0x1306120bed0 state=finished returned tuple&gt; (6, 6, 6)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:06:58,286 [SpawnProcess-3 29000] [MainThread 22776]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:06:58,287 [SpawnProcess-3 29000] [MainThread 22776]** start~~~~</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:06:58,287 [MainProcess 2824] [MainThread 4196]** &lt;class 'concurrent.futures._base.Future'&gt; &lt;Future at 0x13061370690 state=finished returned tuple&gt; (9, 9, 9)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:07:07,260 [SpawnProcess-1 25644] [MainThread 30572]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:07:07,261 [MainProcess 2824] [MainThread 4196]** &lt;class 'concurrent.futures._base.Future'&gt; &lt;Future at 0x13061263820 state=finished returned tuple&gt; (15, 15, 15)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:07:15,271 [SpawnProcess-2 9548] [MainThread 31708]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:07:15,273 [MainProcess 2824] [MainThread 4196]** &lt;class 'concurrent.futures._base.Future'&gt; &lt;Future at 0x13061263a80 state=finished returned tuple&gt; (20, 20, 20)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:07:23,288 [SpawnProcess-3 29000] [MainThread 22776]** finished</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">2025-03-11 17:07:23,289 [MainProcess 2824] [MainThread 4196]** &lt;class 'concurrent.futures._base.Future'&gt; &lt;Future at 0x13061344170 state=finished returned tuple&gt; (25, 25, 25)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:7d9a2214-9d22-4c7e-a28e-2a5882065f7c" class="outline-4">
<h4 id="h:7d9a2214-9d22-4c7e-a28e-2a5882065f7c">支持上下文管理</h4>
<div class="outline-text-4" id="text-h:7d9a2214-9d22-4c7e-a28e-2a5882065f7c">
<ul class="org-ul">
<li>concurrent.futures.ProcessPoolExecutor继承自concurrent.futures._base.Executor，而父类有__enter__ 、__exit__方法，支持上下文管理。可以使用with语句</li>
<li>__exit__方法本质还是调用的shutdown(wait=True)，就是一直阻塞到所有运行的任务完成</li>
</ul>


<p>
使用上下文改造上面的例子，增加返回计算的结果
</p>
</div>
</div>
<div id="outline-container-h:c035ffe3-5512-4681-830a-54af10231f88" class="outline-4">
<h4 id="h:c035ffe3-5512-4681-830a-54af10231f88">总结</h4>
<div class="outline-text-4" id="text-h:c035ffe3-5512-4681-830a-54af10231f88">
<ul class="org-ul">
<li>该库统一了线程池、进程池调用，简化了编程。</li>
<li>是Python简单的思想哲学的体现。</li>
<li>唯一的缺点：无法设置线程名称。但这都不值一提。</li>
</ul>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
