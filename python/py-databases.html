<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Python: 数据库</title>
<meta name="generator" content="Org Mode" />
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@jasperhsu">
<meta name="google-adsense-account" content="ca-pub-1741779893655624">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1741779893655624" crossorigin="anonymous"></script>
<!-- from -->
<!--
<style>#back-to-top{background:#000;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;bottom:20px;-webkit-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);-moz-box-shadow:0 2px 5px 0 rgba(0,0,0,.26);box-shadow:0 2px 5px 0 rgba(0,0,0,.26);color:#fff;cursor:pointer;display:block;height:56px;opacity:1;outline:0;position:fixed;right:20px;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-transition:bottom .2s,opacity .2s;-o-transition:bottom .2s,opacity .2s;-moz-transition:bottom .2s,opacity .2s;transition:bottom .2s,opacity .2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:56px;z-index:1}#back-to-top svg{display:block;fill:currentColor;height:24px;margin:16px auto 0;width:24px}#back-to-top.hidden{bottom:-56px;opacity:0}</style>
-->
<link rel="stylesheet" href="/static/aandds.com/css/main.css">
<link rel="stylesheet" href="/static/aandds.com/css/drollery.min.css">
<script type="text/javascript" src="/static/aandds.com/js/main.js"></script>
<!--
<script id="MathJax-script" async="" src="/static/aandds.com/js/mathjax.js"></script>

<script type="text/javascript" src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
-->
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Python: 数据库</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#h:956d1c30-abb3-4635-a69f-eaa7856aabd0">数据库</a>
<ul>
<li><a href="#h:4af6e28e-d90a-4f45-9560-58d9323988b2">诞生</a></li>
<li><a href="#h:d99b8bd5-dc04-4d7e-a47a-8b98cc048704">数据库DBMS发展</a>
<ul>
<li><a href="#h:106222ee-a4e8-422a-80d4-d1a50bea289e">文件系统管理</a></li>
<li><a href="#h:5823fdf9-c05d-486e-bcfd-fb2f5752f2e6">层次数据库</a></li>
<li><a href="#h:6199b08f-7ea1-49a6-95c3-cc23e6eff10c">网状数据库</a></li>
<li><a href="#h:11743167-a728-4df3-809a-f4c9ae87f340">关系数据库</a>
<ul>
<li><a href="#h:6dc94ea9-8175-4278-9327-e687e3ae52d5">Oracle的发展</a></li>
<li><a href="#h:adac4e44-b01a-4bdc-9a65-dce7bf7724e1">Mysql发展</a></li>
<li><a href="#h:36660fc7-6b4f-4431-a25e-06aa9576eb0f">去IOE</a></li>
</ul>
</li>
<li><a href="#h:c4b26fb7-e0d0-4115-9d0c-1cb3ca1733de">NoSQL</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:f05ca21a-5952-4ca2-ae8a-cab248fa4ce7">关系模型和SQL</a>
<ul>
<li><a href="#h:f145a8d9-8717-4b73-aee6-fb88452c3d2e">安装</a></li>
<li><a href="#h:79545937-39f4-4c3a-894a-1c3af1b3c501">SQL语句</a></li>
<li><a href="#h:d3d88f3a-d342-4770-8c0c-44f62fd7188e">DCL</a></li>
<li><a href="#h:d2b6ec9d-742b-40e6-9306-9a54a130bdf9">DDL</a></li>
<li><a href="#h:11b75161-9da6-4f50-9851-1a4acef74098">关系</a>
<ul>
<li><a href="#h:3484deef-01d6-4e6f-a4e9-b77f47f552d5">候选键</a></li>
<li><a href="#h:1456f413-5ed7-4435-a91c-7c5dc8e9baae">PRIMARY KEY主键</a></li>
<li><a href="#h:84d43bee-b4e3-4abc-8df1-2a3d3f292498">Foreign KEY外键</a></li>
<li><a href="#h:2e308697-d849-46b0-ab04-dcf63c8dbd9a">索引Index</a></li>
<li><a href="#h:70f84de4-1c93-4fa2-8cef-bec2642be175">B+树</a></li>
</ul>
</li>
<li><a href="#h:f2a0c1d8-41f1-43fa-821e-a40580fec10b">约束Constraint</a>
<ul>
<li><a href="#h:6a8ee6a1-35c9-4505-804c-f71dc1812616">域约束Domain Constraint</a></li>
<li><a href="#h:59a824af-29c1-4dd6-b504-54a991d23841">实体完整性Entity Integrity</a></li>
<li><a href="#h:b4cbc242-abfd-489b-a78f-d880a9afeca2">引用完整性Referential Integrity <b>*</b></a></li>
</ul>
</li>
<li><a href="#h:c16c14bb-c2d3-4de8-9118-160f974aca92">实体-联系E-R</a>
<ul>
<li><a href="#h:3e02fdfa-c2e4-4de0-9309-c6fbbf997a1e">实体间联系类型-一对多-多对多</a></li>
</ul>
</li>
<li><a href="#h:7a1a2244-52f8-46fe-b892-0bcbbcaee5f9">视图</a></li>
</ul>
</li>
<li><a href="#h:c4edf2df-dea6-41b3-aab5-144c6b7c2779">必学必会SQL</a>
<ul>
<li><a href="#h:336c6703-fa13-49cb-be0e-66822a4fc5c1">数据类型</a></li>
<li><a href="#h:78303ee8-553e-4313-8074-bd9de3be8c06">关系操作</a></li>
<li><a href="#h:fe5f5214-00d0-41cc-b38f-2c54d52fb18a">CRUD增删改查</a>
<ul>
<li><a href="#h:92f50555-cb5f-4bc7-bd02-958f9c7f6273">Insert语句</a>
<ul>
<li><a href="#h:f63e6484-bdb8-41b6-b174-26dd487c5c19">test.sql完整语句</a></li>
</ul>
</li>
<li><a href="#h:0d2f562c-9479-430d-9a39-b0fbf0583a12">Update语句</a></li>
<li><a href="#h:994be50c-728f-4dfa-b57a-12a1fa077e9d">Delete语句</a></li>
<li><a href="#h:e80b5024-5b3e-48e9-94dc-d1155d8f92f6">Select语句</a>
<ul>
<li><a href="#h:dfb76287-2923-40f9-8422-58fb21b950e2">Limit子句</a></li>
<li><a href="#h:bc5b6652-deee-46d0-805a-7f5d91043121">Where子句</a></li>
<li><a href="#h:f9f99610-6d3d-4a67-9389-7be2a4142bb1">Order by 子句</a></li>
<li><a href="#h:44ff964c-7b09-4c6c-b9e2-8b2c73e381b2">DISTINCT</a></li>
<li><a href="#h:bf1eec57-c4a7-48aa-9679-fc7666f643b7">聚合函数</a></li>
<li><a href="#h:9911e0a4-78ec-44b9-9b1b-35eeef3eecc2">分组查询</a></li>
<li><a href="#h:e6c0aed0-f56d-4295-a261-4e09b853c91d">子查询</a></li>
<li><a href="#h:1c8cf6c9-c118-464d-a2c8-302008aebfca">连接jon和联合查询UNION</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:f44ddcac-94b1-4453-a83b-dac338b639a6">事务和锁</a>
<ul>
<li><a href="#h:0b197878-5979-4826-ae31-5cd06be2c072">事务Transaction</a>
<ul>
<li><a href="#h:6baee312-cf70-4939-a4bb-0e1d8e1becf8">MySQL隔离级别</a></li>
<li><a href="#h:0ad2dd2b-493b-408f-98c1-a3121d45fc11">事务语法</a></li>
</ul>
</li>
<li><a href="#h:2e0609df-eb00-4965-8014-74f8694d5241">FOR UPDATE 和锁</a></li>
<li><a href="#h:096673f8-f781-466c-a360-2fd86dcf4723">数据仓库和数据库的区别</a></li>
<li><a href="#h:4870a7cd-f32d-4eca-9ed6-52e1362f7180">存储过程、触发器</a></li>
<li><a href="#h:8c3dce11-cb54-40ca-8f65-7ed2d7e5fe46">游标Cursor</a></li>
</ul>
</li>
<li><a href="#h:2cd48672-deb3-494d-85d0-2305ce56c832">数据库开发</a>
<ul>
<li><a href="#h:3bc9c77c-bbe8-4c1b-9fed-99f754822a43">驱动</a></li>
<li><a href="#h:0e01b15f-84ab-43bb-b89b-a0724bdaaa1b">pymysql使用</a>
<ul>
<li><a href="#h:b8257dee-e871-4da4-b663-28a87f9b1277">安装</a></li>
<li><a href="#h:7da9487d-9906-4b15-b61f-1cbcb99b11af">创建数据库和表</a></li>
<li><a href="#h:f7b6ea0e-8c6f-4c05-a6e7-c9b47fa46459">连接Connect</a></li>
<li><a href="#h:b086239c-886b-42b2-88df-9e9a8103c4ad">游标Cursor</a></li>
<li><a href="#h:ca053344-96f4-46d6-9cbd-df2d6a635a9a">新增记录</a></li>
<li><a href="#h:b00067e0-164c-478d-ac95-8a4e8a4ce5d3">事务管理</a></li>
<li><a href="#h:d4a956e4-dd2e-4269-8fc8-53e73114ab80">一般流程</a></li>
<li><a href="#h:466d7d19-54e4-4297-beda-63362f8c982b">查询</a></li>
<li><a href="#h:7f15bce7-4117-4fc6-9bf9-3b29e07e4517">带列名查询</a></li>
<li><a href="#h:bcf58552-b3a2-467a-a02f-e2f4ffab9c63">SQL注入攻击</a>
<ul>
<li><a href="#h:2261b59c-2263-43b4-a58b-c2070d42ef2f">SQL注入攻击</a></li>
<li><a href="#h:5e1101a6-aa60-436a-952c-4a214e7657d3">如何解决注入攻击</a></li>
<li><a href="#h:8ddab840-8f61-49e3-bc28-310a471dcb1f">参数化查询为什么提高效率？</a></li>
</ul>
</li>
<li><a href="#h:f150e829-5d65-46f0-9a6e-04ebcb8820fd">上下文支持</a></li>
</ul>
</li>
<li><a href="#h:54a4fd02-599c-4668-8bb0-6c7c9bda0999">mysqlclient</a>
<ul>
<li><a href="#h:c4c2fe69-ec81-4464-9da5-3653d4aae7ec">安装</a></li>
<li><a href="#h:696ac92a-ca8b-4d37-a6bd-b5d2904da5b4">使用</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:0f8bd935-db9f-4836-bf99-6c7ded1863d2">元编程</a>
<ul>
<li><a href="#h:6d918d47-0dce-4927-a06b-18e102230032">type类</a>
<ul>
<li><a href="#h:362bd835-22df-4d68-8544-6b667f83fe82">type构建类</a></li>
<li><a href="#h:5da65e63-b548-4f48-99d4-643dcaff368b">构建元类</a></li>
</ul>
</li>
<li><a href="#h:48085958-550a-4fb7-893d-5a56ad58ae7f">元类的应用</a></li>
<li><a href="#h:3e3a5a4a-958c-4323-8c87-be78811b53e0">元编程总结</a></li>
<li><a href="#h:3bcddd86-6382-4f0d-a4d2-86c0b0065e4f">ORM</a></li>
</ul>
</li>
<li><a href="#h:b69a49ca-c308-4c69-9c2a-51237f7de2c8">SQLALchemy ORM</a>
<ul>
<li><a href="#h:0b4bd905-23b8-4a78-96cd-9316a3eae2f0">安装</a></li>
<li><a href="#h:d7cc2d1c-97e8-417d-9558-df1128bfed2b">文档</a></li>
<li><a href="#h:c51fed33-68f8-44c1-805c-52e528538b9e">开发</a>
<ul>
<li><a href="#h:6b69c4a0-3591-4f50-b41f-caa18de60e29">创建连接</a></li>
<li><a href="#h:f62ca0dd-b111-498d-8c47-869d5ddda2e8">Declare a Mapping创建映射</a></li>
<li><a href="#h:504333ea-3825-4c4d-b448-bd90e74a9198">创建基类</a></li>
<li><a href="#h:eb01c210-12db-453e-880c-cdb0f96b62ff">创建实体类</a></li>
<li><a href="#h:4e2dab86-6da5-4f2e-8582-90a834e4e4af">实例化</a></li>
<li><a href="#h:d9ecc79d-102c-4f5f-8d86-12d18a77a02c">创建表</a></li>
<li><a href="#h:225d88c6-ea54-4657-af39-bf5747a4837b">创建回话session</a></li>
<li><a href="#h:1ba51d42-7e34-4f56-82db-d6e3eb756bb7">CRUD操作</a>
<ul>
<li><a href="#h:00115658-c631-4a2f-9d0a-5fa1147e7623">增</a></li>
<li><a href="#h:cd739646-24b1-4ebf-8e50-8df824ce4675">简单查询 query()</a></li>
<li><a href="#h:95fbacbc-1822-404d-b5be-4230de2111e6">修改</a></li>
<li><a href="#h:a3359fff-f151-4656-9e4f-05a6d3b5b580">删除</a></li>
<li><a href="#h:ef1619ba-85b8-4965-beba-b2b32a84249f">状态**</a></li>
<li><a href="#h:57e8f2a5-3199-4173-b101-4ad09ef6ad3b">复杂查询 filter</a></li>
<li><a href="#h:dd0f8713-1082-4af6-899d-55f695270602">排序 order_by</a></li>
<li><a href="#h:fde785a6-2dca-4858-a1cb-3e88a36cd70d">分页 limit</a></li>
<li><a href="#h:cdf0dfb8-b652-443d-b665-6cbe1f9a61dd">消费者方法</a></li>
<li><a href="#h:c36e4c9c-b8e6-42d6-964a-d57dfcd7640a">聚合、分组</a></li>
<li><a href="#h:704ba74e-20c4-4a9c-a534-53501469b6fa">关联查询</a></li>
</ul>
</li>
<li><a href="#h:3ca000e3-a10d-4793-a885-74f0466c633a">总结</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:2965f98f-474e-4dc3-86ab-20d9658624ef">Django ORM</a>
<ul>
<li><a href="#h:3759b116-a26c-44c6-bd3d-d041ca3d6023">安装Django</a></li>
<li><a href="#h:a604b154-92cb-441a-a869-a65a2012eddc">项目准备</a></li>
<li><a href="#h:2a5adeba-8a25-48e5-908f-773af9ff887c">Django日志</a></li>
<li><a href="#h:d5acbe98-f8d7-435d-96b4-72c25c45e341">模型Model</a>
<ul>
<li><a href="#h:f547c637-6b13-4738-8c5e-03e7ea831c82">字段类型</a></li>
<li><a href="#h:5c3e9f8f-69ce-4fde-b51e-8e88bd330574">缺省主键</a></li>
<li><a href="#h:aed09529-8bc0-4c87-8f72-a509bb8fe8b1">字段选项</a></li>
<li><a href="#h:561d82ff-db2f-4a24-b064-dd02f010269e">Model类</a></li>
<li><a href="#h:d461204e-f33b-4d7a-bca6-f66e82dfe199">管理器对象</a></li>
</ul>
</li>
<li><a href="#h:25bf302c-5ff1-480d-9d95-822eec195b40">查询</a>
<ul>
<li><a href="#h:1d056f89-2f5d-4dc7-9329-aa29c28be264">查询集</a></li>
<li><a href="#h:5226b3d0-3494-439e-bca0-353187141dab">限制查询集（切片）</a></li>
<li><a href="#h:40e89c21-b858-4060-971c-da7b1162ac1e">结果集方法</a></li>
<li><a href="#h:881e5f00-955e-4a95-80b7-cf3268d6a209">返回单个值的方法</a></li>
<li><a href="#h:812c84cb-99fb-4c4d-a547-c5faabf486aa">字段查询（Field Lookup）表达式</a></li>
<li><a href="#h:e00d84c9-c999-4add-82fc-d9138cb38ff5">Q对象</a></li>
<li><a href="#h:5ac947d8-d34e-4adb-8348-0adeec59bfb2">聚合、分组</a>
<ul>
<li><a href="#h:305cb7fe-a75b-49a9-a262-05ef5647e5fc">aggregate()</a></li>
<li><a href="#h:6a627feb-b964-4f5c-8972-fdbbc93b7b96">annotate()</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h:b0378db2-550d-4470-aa5d-ba7b5507a202">一对多</a>
<ul>
<li><a href="#h:48a1cb59-84dc-4008-85ba-d2d7dc71160e">构建一对多表</a></li>
<li><a href="#h:57d765a1-0e69-4eb4-93f1-404b518c8b76">联合主键问题</a></li>
<li><a href="#h:0eaa2726-d0f8-4fb2-8b85-242cf15b0dc4">新建模型</a></li>
<li><a href="#h:64c751b2-0231-464a-8cc9-02d06a38e82f">外键</a>
<ul>
<li><a href="#h:a5e79579-3e85-4dd7-93e4-83b857042a2d">db_column</a></li>
<li><a href="#h:0d8a6fca-4165-4625-8848-754d6460e9b2">related_name</a></li>
<li><a href="#h:a94b1998-bdb4-4f1e-97ea-88f2f2587698">on_delete</a></li>
</ul>
</li>
<li><a href="#h:ea8af9e0-6e13-44ef-83fb-dec2ddb6b2c8">特殊属性</a></li>
<li><a href="#h:bba5b6b6-4283-4f9c-bb5c-41c0680f7859">查询</a></li>
<li><a href="#h:3d1bb668-5853-4072-aac9-8f98bf185e17">distinct&#x2013;&#x2014;》去重</a></li>
<li><a href="#h:c31066f7-bc74-44e7-b8cb-217615bcaab5">raw的使用&#x2014;&gt;执行原生SQL语句</a></li>
</ul>
</li>
<li><a href="#h:d4bd12ba-b3a1-4b73-9be7-b55add780104">多对多</a>
<ul>
<li><a href="#h:b6ab0381-6df4-431d-9d91-1229d2c44fb7">多对多表</a></li>
<li><a href="#h:87e5b259-8e5a-4565-8556-99a975e321f4">创建模型</a></li>
<li><a href="#h:1b9a7871-9e87-42f2-80c9-8e999363b05d">使用查询</a></li>
</ul>
</li>
<li><a href="#h:be19a5cf-c03f-49cd-85c3-b42d9525c929">迁移</a></li>
<li><a href="#h:b4222858-7034-4982-8fa1-574bbcabd3c9">显示事务处理</a></li>
<li><a href="#h:3513aecb-448b-43aa-9896-ea112885e679">对数据库的增删改查</a>
<ul>
<li><a href="#h:8208700d-d2b3-40fd-99da-95dcf7ad8d69">增加</a></li>
<li><a href="#h:e6ec9689-ef69-4f54-9684-90bafc231e7a">修改</a>
<ul>
<li><a href="#h:38f7926d-b4d5-4b45-9643-6a2ce683c753">多表修改</a></li>
<li><a href="#h:b320eea6-a18f-4f90-8f59-e203459290cb">单表本表修改</a></li>
</ul>
</li>
<li><a href="#h:a20881d9-4305-49be-b6c2-cb0f640a5190">删除</a></li>
</ul>
</li>
<li><a href="#h:47802753-a311-476e-91c7-f592f9f9580e">Django后台管理</a>
<ul>
<li><a href="#h:4de49515-b12c-4b5e-8873-f725df32c077">创建管理员</a></li>
<li><a href="#h:dfc71521-97ed-4098-aabe-f037f101eca1">本地化</a></li>
<li><a href="#h:db7150d6-59e3-4373-a26e-2b78f041dd0b">启动WEB Server</a></li>
<li><a href="#h:db74a786-e863-4bb8-9e2a-4c8f21944b05">登录后台管理</a></li>
</ul>
</li>
<li><a href="#h:699a2bc3-4d6d-463d-b32e-0c46f85ac718">总结</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<ul class="org-ul">
<li>TAGS: <a href="./index.html">Python</a></li>
</ul>

<p>
配置 python 开发环境和编程思想入门
</p>

<p>
主要内容：
</p>
<ul class="org-ul">
<li>MySQL安装</li>
<li>MySQL服务器配置与客户端配置</li>
<li>MySQL编码的设置</li>
<li>MySQL环境变更查看与修改</li>
<li>MySQL启动与修改</li>
<li>MySQL客户端远程登录与使用</li>
<li>MySQL库切换，查看库，查看表等常见指令</li>
<li>MySQL脚本执行</li>
<li>MySQL用户管理与权限</li>
<li>MySQL日志查看与分析</li>
</ul>

<p>
关系模型和SQL语句
</p>

<p>
主要内容：
</p>
<ul class="org-ul">
<li>关系数据库基础</li>
<li>SQL脚本编程基础</li>
<li>MySQL 数据内置数据类型与用户数据类型</li>
<li>DDL数据库与表定义语句</li>
<li>字段表级约束与字段级约束</li>
<li>DML 数据表操作语句</li>
<li>DQL 数据查询基本语句</li>
<li>DTL 数据事务管理语句</li>
<li>多表关联 SELECT 查询</li>
<li>条件 where 查询</li>
<li>groupby 分组查询</li>
<li>排序 orderby 查询</li>
<li>having 条件查询与 where 区别</li>
<li>数据库单行、聚合、字符串、日期、统计等常见函数使用</li>
<li>索引</li>
<li>视图</li>
<li>存储过程和触发器</li>
<li>数据库 ACID 和 隔离机制</li>
</ul>

<p>
Python 关系数据访问编程
</p>

<p>
主要内容：
</p>
<ul class="org-ul">
<li>PyMySQL 模块</li>
<li>SQLAlchemy 模块详解</li>
<li>ORM 对象关系映射</li>
<li>模型映射</li>
<li>数据库连接</li>
<li>会话对象</li>
<li>数据记录访问与遍历</li>
<li>复杂查询操作</li>
<li>排序、分页、聚合、分组操作</li>
<li>关联查询操作</li>
<li>事务提交与回滚操作</li>
<li>事务 ACID 和隔离机制</li>
<li>二进制与大对象数据存储与利弊</li>
</ul>
<section id="outline-container-h:956d1c30-abb3-4635-a69f-eaa7856aabd0" class="outline-2">
<h2 id="h:956d1c30-abb3-4635-a69f-eaa7856aabd0">数据库</h2>
<div class="outline-text-2" id="text-h:956d1c30-abb3-4635-a69f-eaa7856aabd0">
<p>
数据库: 按照数据结构来组织、存储、管理数据的仓库
</p>
</div>
<div id="outline-container-h:4af6e28e-d90a-4f45-9560-58d9323988b2" class="outline-3">
<h3 id="h:4af6e28e-d90a-4f45-9560-58d9323988b2">诞生</h3>
<div class="outline-text-3" id="text-h:4af6e28e-d90a-4f45-9560-58d9323988b2">
<p>
计算机的发明是为了做科学计算的，而科学计算需要大量的数据输入和输出。
</p>

<p>
早期，可以使用打孔卡片的孔、灯泡的亮灭来表示数据输入、输出数据。
</p>

<p>
1940年，数据可以存储在磁带上，顺序的读取、写入磁带。
</p>

<p>
1956年IBM发明了磁盘驱动器这个革命性产品，支持随机访问。
</p>

<p>
随着信息化时代的到来，有了硬件存储技术的发展，有大量的数据需要存储和管理。
</p>
</div>
</div>
<div id="outline-container-h:d99b8bd5-dc04-4d7e-a47a-8b98cc048704" class="outline-3">
<h3 id="h:d99b8bd5-dc04-4d7e-a47a-8b98cc048704">数据库DBMS发展</h3>
<div class="outline-text-3" id="text-h:d99b8bd5-dc04-4d7e-a47a-8b98cc048704">
<ul class="org-ul">
<li>萌芽期：文件管理</li>
<li>第一代：层次数据库、网状数据库</li>
<li>第二代：SQL、关系型数据库</li>
<li>第三代：面向对象的DBMS（OODBMS）、对象关系的DBMS（ORDBMS）</li>
</ul>
</div>
<div id="outline-container-h:106222ee-a4e8-422a-80d4-d1a50bea289e" class="outline-4">
<h4 id="h:106222ee-a4e8-422a-80d4-d1a50bea289e">文件系统管理</h4>
<div class="outline-text-4" id="text-h:106222ee-a4e8-422a-80d4-d1a50bea289e">
<ul class="org-ul">
<li>磁盘上一个个文件，数据孤立，数据冗余</li>
<li>格式不统一，很难统一管理</li>
<li>无法高效查询，无法灵活查询</li>
</ul>
</div>
</div>
<div id="outline-container-h:5823fdf9-c05d-486e-bcfd-fb2f5752f2e6" class="outline-4">
<h4 id="h:5823fdf9-c05d-486e-bcfd-fb2f5752f2e6">层次数据库</h4>
<div class="outline-text-4" id="text-h:5823fdf9-c05d-486e-bcfd-fb2f5752f2e6">
<ul class="org-ul">
<li>以树型结构表示实体及其之间的联系。关系只支持一对多</li>
<li>代表数据库IBM IMS</li>
</ul>
</div>
</div>
<div id="outline-container-h:6199b08f-7ea1-49a6-95c3-cc23e6eff10c" class="outline-4">
<h4 id="h:6199b08f-7ea1-49a6-95c3-cc23e6eff10c">网状数据库</h4>
<div class="outline-text-4" id="text-h:6199b08f-7ea1-49a6-95c3-cc23e6eff10c">
<p>
通用电气最早在1964年开发出网状数据库IDS，只能运行在GE自家的主机上。
</p>

<p>
结点描述数据，结点的联系就是数据的关系。
</p>

<p>
能够直接描述客观世界，可以表示实体间多种复杂关系，而这是层次数据模型无法做到的。比如，一个结点可以有多个父结点，结点之间支持可以多对多关联
</p>
</div>
</div>
<div id="outline-container-h:11743167-a728-4df3-809a-f4c9ae87f340" class="outline-4">
<h4 id="h:11743167-a728-4df3-809a-f4c9ae87f340">关系数据库</h4>
<div class="outline-text-4" id="text-h:11743167-a728-4df3-809a-f4c9ae87f340">
<p>
使用行、列组成的二维表来组织数据和关系，表中行（记录）即可以描述数据实体，也可以描述实体间关系。
</p>

<p>
关系模型比网状模型、层次模型更简单，不需要关系数存储的物理细节，专心于数据的逻辑构建，而且关系模型有论文的严格的数学理论基础支撑。
</p>


<p>
1970年6月，IBM的研究员E.F.Codd发表了名为“A Relational Model of Data for Large Shared Data Banks”的论文，提出了关系模型的概念，奠定了关系模型的理论基础。
</p>

<p>
1976年，IBM实验室System R项目，通过实现数据结构和操作来证明关系模型实用性，并直接产生了结构化查询语言SQL。1987年，SQL被ISO组织标准化。
</p>

<p>
关系模型，有严格的数学基础，抽象级别较高，简单清晰，便于理解和使用。
</p>
<ul class="org-ul">
<li>经过几十年的发展，关系数据库百花齐放，技术日臻成熟和完善。</li>
<li>基于关系模型构建的数据库系统称为RDBMS(Relational DataBase System)。</li>
<li>BM DB2、Oracle的Oracle和Mysql、微软的MS SQL。以前的Infomix、Sybase等。</li>
</ul>
</div>
<div id="outline-container-h:6dc94ea9-8175-4278-9327-e687e3ae52d5" class="outline-5">
<h5 id="h:6dc94ea9-8175-4278-9327-e687e3ae52d5">Oracle的发展</h5>
<div class="outline-text-5" id="text-h:6dc94ea9-8175-4278-9327-e687e3ae52d5">
<p>
拉里·埃里森(Larry Ellison)仔细阅读了IBM的关系数据库的论文，敏锐意识到
在这个研究基础上可以开发商用软件系统。他们几个创始人决定开发通用商用数
据库系统Oracle，这个名字来源于他们曾给中央情报局做过的项目名。
</p>

<p>
1979年发布了ORACLE 2.0版本（实际上是1.0）。1983年，Oracle v3。1984年，
Oracle v4。1985年，Oraclev5。1988年，Oracle v6引入了行级锁等新技术，然
而这是个不稳定的版本。直到1992年的时候，Oracle7才逐渐稳定下来，并取得
巨大成功。2001年的9i版本被广泛应用。
</p>

<p>
2009年4月20日，甲骨文公司宣布将以每股9.50美元，总计74亿美金收购SUN（计算机系统）公司。2010年1月成功收购。
</p>

<p>
2013年，甲骨文超过IBM，成为继微软之后的全球第二大软件公司。
</p>
</div>
</div>
<div id="outline-container-h:adac4e44-b01a-4bdc-9a65-dce7bf7724e1" class="outline-5">
<h5 id="h:adac4e44-b01a-4bdc-9a65-dce7bf7724e1">Mysql发展</h5>
<div class="outline-text-5" id="text-h:adac4e44-b01a-4bdc-9a65-dce7bf7724e1">
<p>
1985年几个瑞典人为大型零售商的项目设计了一种利用索引顺序存取数据的软件，
这就是MyISAM的前身。1996年，MySQL 1.0发布，随后发布了3.11.1版本，并开
始往其它平台移植。2000年MySQL采用GPL协议开源。
</p>

<p>
MySQL 4.0开始支持MyISAM、InnoDB引擎。2005年10月，MySQL 5.0成为里程碑版本。
</p>

<p>
2008年1月被Sun公司收购。
</p>

<p>
2009年1月，在Oracle收购MySQL之前，Monty Widenius担心收购，就从MySQL Server 5.5开始一条新的GPL分支，起名MariaDB。
</p>

<p>
MySQL的引擎是插件化的，可以支持很多种引擎：
</p>
<ul class="org-ul">
<li>MyISASM，不支持事务，插入、查询速度快。</li>
<li>InnoDB，支持事务，行级锁，MySQL 5.5起的默认引擎。</li>
</ul>
</div>
</div>
<div id="outline-container-h:36660fc7-6b4f-4431-a25e-06aa9576eb0f" class="outline-5">
<h5 id="h:36660fc7-6b4f-4431-a25e-06aa9576eb0f">去IOE</h5>
<div class="outline-text-5" id="text-h:36660fc7-6b4f-4431-a25e-06aa9576eb0f">
<p>
它是阿里巴巴造出的概念。其本意是，在阿里巴巴的IT架构中，去掉IBM的小型
机、Oracle数据库、EMC存储设备，取而代之使用自己在开源软件基础上开发的
系统。传统上，一个高端大气的数据中心，IBM小型机、Oracle数据库、EMC存储
设备，可以说缺一不可。而使用这些架构的企业，不但采购、维护成本极高，核
心架构还掌握在他人手中。
</p>

<p>
对于阿里巴巴这样大规模的互联网应用，应该采用开源、开放的系统架构。这种
思路并不是阿里巴巴的新发明，国外的谷歌、Facebook、亚马逊等早已为之。只
不过它们几乎一开始就有没有采用IT商业公司的架构，所以他们也不用“去IOE”。
</p>

<p>
去IOE，转而使用廉价的架构，稳定性一定下降，需要较高的运维水平解决。
</p>
</div>
</div>
</div>
<div id="outline-container-h:c4b26fb7-e0d0-4115-9d0c-1cb3ca1733de" class="outline-4">
<h4 id="h:c4b26fb7-e0d0-4115-9d0c-1cb3ca1733de">NoSQL</h4>
<div class="outline-text-4" id="text-h:c4b26fb7-e0d0-4115-9d0c-1cb3ca1733de">
<p>
NoSQL是对非SQL、非传统关系型数据库的统称。
</p>

<p>
NoSQL一词诞生于1998年，2009年这个词汇被再次提出指非关系型、分布式、不提供ACID的数据库设计模式
</p>

<p>
随着互联网时代的到来，数据爆发式增长，数据库技术发展日新月异，要适应新的业务需求。
</p>

<p>
随着移动互联网、物联网的到来，大数据的技术中NoSQL也同样重要。
</p>

<p>
数据库流行度排名: <a href="https://db-engines.com/en/ranking">https://db-engines.com/en/ranking</a>
</p>
</div>
</div>
</div>
</section>
<section id="outline-container-h:f05ca21a-5952-4ca2-ae8a-cab248fa4ce7" class="outline-2">
<h2 id="h:f05ca21a-5952-4ca2-ae8a-cab248fa4ce7">关系模型和SQL</h2>
<div class="outline-text-2" id="text-h:f05ca21a-5952-4ca2-ae8a-cab248fa4ce7">
<p>
为了介绍关系模型，以MySQL数据库为例
</p>
</div>
<div id="outline-container-h:f145a8d9-8717-4b73-aee6-fb88452c3d2e" class="outline-3">
<h3 id="h:f145a8d9-8717-4b73-aee6-fb88452c3d2e">安装</h3>
<div class="outline-text-3" id="text-h:f145a8d9-8717-4b73-aee6-fb88452c3d2e">
<p>
MariaDB 安装
</p>

<div class="org-src-container">
<pre class="src src-sh">yum list | grep mariadb

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23433;&#35013;mariadb &#26381;&#21153;&#65292;&#20250;&#33258;&#21160;&#23433;&#35013;mairadb</span>
yum install mariadb-server
systemctl start mariadb.service

ss -tanl

State       Recv-Q  Send-Q Local Address:Port    Peer Address:Port
LISTEN      0       50              *:3306              *:*

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;&#26426;&#21551;&#21160;</span>
systemctl enable mariadb.service
</pre>
</div>


<p>
初始化脚本提高安全性
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">mysql_secure_installation</span>
&#35774;&#32622;&#25968;&#25454;&#31649;&#29702;&#21592;root&#21475;&#20196;
&#31105;&#27490;root&#36828;&#31243;&#30331;&#24405;
&#21024;&#38500;anonymous&#29992;&#25143;&#24080;&#21495;
&#21024;&#38500;test&#25968;&#25454;&#24211;
</pre>
</div>

<p>
Docker 安装 MySQL
</p>
<div class="org-src-container">
<pre class="src src-sh">docker pull mysql
docker run -p 3306:3306 --name mysql -e <span style="color: #a0522d;">MYSQL_ROOT_PASSWORD</span>=123456 -d mysql:latest
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sh">&#25968;&#25454;&#24211;&#23494;&#30721;&#30331;&#24405;
mysql -u root -p

mysql&gt; show databases;
+--------------------+
| Database |
+--------------------+
| information_schema |
| mysql |
| performance_schema |
+--------------------+
3 rows<span style="color: #a020f0;"> in</span> set (0.00 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#24182;&#25480;&#26435;&#29992;&#25143;</span>
mysql&gt; grant all on *.* to <span style="color: #8b2252;">'tom'</span>@<span style="color: #8b2252;">'%'</span> identified by <span style="color: #8b2252;">'tom'</span>;
mysql&gt; flush privileges;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20837;&#27979;&#35797;&#33050;&#26412; testsql&#25991;&#20214;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">mysql -u root -p &lt; test.sql</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:79545937-39f4-4c3a-894a-1c3af1b3c501" class="outline-3">
<h3 id="h:79545937-39f4-4c3a-894a-1c3af1b3c501">SQL语句</h3>
<div class="outline-text-3" id="text-h:79545937-39f4-4c3a-894a-1c3af1b3c501">
<p>
SQL是结构化查询语言Structured Query Language。1987年被ISO组织标准化。
</p>

<p>
所有主流的关系型数据库都支持SQL，NoSQL也有很大一部分支持SQL。
</p>

<p>
SQL语句分为
</p>
<ul class="org-ul">
<li>DDL: Data Defination Language 数据定义语言，定义或修改数据库对象（如表、索引、视图等）的结构。关键字：
<ul class="org-ul">
<li>CREATE（创建数据库或表）</li>
<li>ALTER（修改表结构）</li>
<li>DROP（删除数据库或表）</li>
<li>TRUNCATE（快速清空表数据并重置结构）</li>
</ul></li>

<li>DML: Data Manipulation Language 数据操纵语言，对表中的数据进行增、删、改操作。关键字：
<ul class="org-ul">
<li>INSERT（插入数据）</li>
<li>UPDATE（更新数据）</li>
<li>DELETE（删除数据）</li>
</ul></li>

<li>DQL：Data Query Language 数据查询语言，从数据库中检索数据，是SQL的核心部分。关键字：
<ul class="org-ul">
<li>SELECT（查询数据）。特点：支持单表查询、多表连接（如内连接、外连接）、聚合函数（SUM、COUNT等）、分组（GROUP BY）和条件筛选（HAVING）</li>
</ul></li>

<li>DCL：Data Control Language 数据控制语言，管理数据库权限和事务控制。关键字：
<ul class="org-ul">
<li>GRANT（授予权限）</li>
<li>REVOKE（撤销权限）</li>
<li>COMMIT（提交事务）</li>
<li>ROLLBACK（回滚事务）</li>
</ul></li>

<li>TCL: Transaction Control Language 事务控制语言，负责处理ACID事务,确保数据库操作的原子性和一致性。关键字：
<ul class="org-ul">
<li>BEGIN TRANSACTION（开始事务）</li>
<li>SAVEPOINT（设置保存点）</li>
<li>COMMIT（提交事务）</li>
<li>ROLLBACK（回滚到保存点或事务起点）</li>
</ul></li>
</ul>

<p>
SQL的CRUD(Create-Read-Update-Delete)，即 Insert,update,delete,select 四条语句
</p>

<p>
语言规范
</p>
<ul class="org-ul">
<li>SQL语句大小写不敏感
<ul class="org-ul">
<li>一般建议，SQL的关键字、函数等大写</li>
</ul></li>
<li>SQL语句末尾应该使用分号结束</li>
<li>注释
<ul class="org-ul">
<li>多行注释 <code>/*注释内容*/</code></li>
<li>单行注释 <code>-- 注释内容</code></li>
<li>MySQL 注释可以使用 #</li>
</ul></li>
<li>使用空格或缩进来提高可读性</li>

<li>命名规范
<ul class="org-ul">
<li>必须以字母开头</li>
<li>可以使用数字、#、$和_</li>
<li>不可使用关键字</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:d3d88f3a-d342-4770-8c0c-44f62fd7188e" class="outline-3">
<h3 id="h:d3d88f3a-d342-4770-8c0c-44f62fd7188e">DCL</h3>
<div class="outline-text-3" id="text-h:d3d88f3a-d342-4770-8c0c-44f62fd7188e">
<p>
GRANT授权、REVOKE撤销
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">GRANT</span> <span style="color: #a020f0;">ALL</span> <span style="color: #a020f0;">ON</span> employees.* <span style="color: #a020f0;">TO</span> <span style="color: #8b2252;">'tom'</span>@<span style="color: #8b2252;">'%'</span> IDENTIFIED <span style="color: #a020f0;">by</span> <span style="color: #8b2252;">'tom'</span>;
<span style="color: #a020f0;">REVOKE</span> <span style="color: #a020f0;">ALL</span> <span style="color: #a020f0;">ON</span> *.* <span style="color: #a020f0;">FROM</span> tom;
</pre>
</div>

<pre class="example" id="org2511a7d">
*为通配符，指代任意库或者任意表。
*.* 所有库的所有表； employees.* 表示employees库下所有的表
% 为通配符，它是SQL语句的通配符，匹配任意长度字符串
</pre>
</div>
</div>
<div id="outline-container-h:d2b6ec9d-742b-40e6-9306-9a54a130bdf9" class="outline-3">
<h3 id="h:d2b6ec9d-742b-40e6-9306-9a54a130bdf9">DDL</h3>
<div class="outline-text-3" id="text-h:d2b6ec9d-742b-40e6-9306-9a54a130bdf9">
<p>
<b>删除用户（慎用）</b>
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DROP</span> <span style="color: #483d8b;">USER</span> tom;
</pre>
</div>

<p>
<b>创建数据库</b>
</p>

<p>
库是数据的集合，所有数据按照数据模型组织在数据库中
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> DATABASE IF <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">EXISTS</span> test <span style="color: #228b22;">CHARACTER</span> <span style="color: #a020f0;">SET</span> utf8mb4 <span style="color: #a020f0;">COLLATE</span> utf8mb4_general_ci;
<span style="color: #a020f0;">CREATE</span> DATABASE IF <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">EXISTS</span> test <span style="color: #228b22;">CHARACTER</span> <span style="color: #a020f0;">SET</span> utf8;
</pre>
</div>

<pre class="example" id="org5cb175d">
CHARACTER SET指定字符集
utf8mb4是utf8的扩展，支持4字节utf8mb4，需要MySQL5.5.3+
COLLATE指定字符集的校对规则，用来做字符串的比较的。例如a、A谁大？
</pre>

<p>
<b>删除数据库</b>
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DROP</span> DATABASE IF <span style="color: #a020f0;">EXISTS</span> test;
</pre>
</div>

<p>
<b>创建表</b>
</p>
<ul class="org-ul">
<li>表分为行和列，MySQL是行存数据库。数据是一行行存的，列必须固定多少列。</li>
<li>行Row，也称为记录Record，元组</li>
<li>列Column，也称为字段Field、属性</li>
<li>字段的取值范围叫做 域Domain。例如gender字段的取值就是M或者F两个值</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `employees` (
  `emp_no` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `birth_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `first_name` <span style="color: #228b22;">varchar</span>(14) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `last_name` <span style="color: #228b22;">varchar</span>(16) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `gender` enum(<span style="color: #8b2252;">'M'</span>,<span style="color: #8b2252;">'F'</span>) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `hire_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`emp_no`)
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8;
</pre>
</div>

<p>
反引号标注的名称，会被认为是非关键字，使用反引号避免冲突
</p>

<p>
<b>DESC</b>
</p>

<p>
查看列信息 {DESCRIBE | DESC} tbl_name [col_name | wild]
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DESC</span> employees;
<span style="color: #a020f0;">DESC</span> employees <span style="color: #8b2252;">''</span>;
</pre>
</div>

<p>
练习
设计一张表，记录登录账户的注册信息，应该存储用户的姓名、登录名、密码
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DROP</span> DATABASE IF <span style="color: #a020f0;">EXISTS</span> test;
<span style="color: #a020f0;">CREATE</span> DATABASE IF <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">EXISTS</span> test <span style="color: #228b22;">CHARACTER</span> <span style="color: #a020f0;">SET</span> utf8mb4 <span style="color: #a020f0;">COLLATE</span> utf8mb4_general_ci;

<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `reg` (
  `id` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `loginname` <span style="color: #228b22;">varchar</span>(50) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `<span style="color: #a020f0;">name</span>` <span style="color: #228b22;">varchar</span>(64) <span style="color: #a020f0;">DEFAULT</span> <span style="color: #a020f0;">NULL</span>,
  `password` <span style="color: #228b22;">varchar</span>(128) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`id`),
  <span style="color: #a020f0;">UNIQUE</span> <span style="color: #a020f0;">KEY</span> `loginname` (`loginname`)
) ENGINE=InnoDB;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:11b75161-9da6-4f50-9851-1a4acef74098" class="outline-3">
<h3 id="h:11b75161-9da6-4f50-9851-1a4acef74098">关系</h3>
<div class="outline-text-3" id="text-h:11b75161-9da6-4f50-9851-1a4acef74098">
<p>
在关系数据库中，关系就是二维表，由行和列组成。
</p>

<p>
行Row，也称为记录Record，元组。
</p>

<p>
列Column，也称为字段Field、属性。
</p>

<p>
字段的取值范围叫做 域Domain。例如gender字段的取值就是M或者F两个值
</p>

<p>
维数：关系的维数指关系中属性的个数。
</p>

<p>
基数：元组的个数。
</p>

<p>
注意在关系中，属性的顺序并不重要。理论上，元组顺序也不重要，但是由于元组顺序与存储相关，会影响查询效率。
</p>
</div>
<div id="outline-container-h:3484deef-01d6-4e6f-a4e9-b77f47f552d5" class="outline-4">
<h4 id="h:3484deef-01d6-4e6f-a4e9-b77f47f552d5">候选键</h4>
<div class="outline-text-4" id="text-h:3484deef-01d6-4e6f-a4e9-b77f47f552d5">
<p>
关系中，能唯一标识一条元组的属性或属性集合，称为候选键。
</p>

<p>
候选键，表中一列或者多列组成的唯一key，通过这一个或者多个列能唯一的标识一条记录。
</p>

<p>
表中可能有多个候选键。
</p>

<pre class="example" id="org81cb92b">
id name  loginname age
1  tom   tom       20
2  jerry jerry     30
3  tom   tom1      20

loginname 不能为null，唯一键

id可以是候选键，loginname可以是候选键
</pre>
</div>
</div>
<div id="outline-container-h:1456f413-5ed7-4435-a91c-7c5dc8e9baae" class="outline-4">
<h4 id="h:1456f413-5ed7-4435-a91c-7c5dc8e9baae">PRIMARY KEY主键</h4>
<div class="outline-text-4" id="text-h:1456f413-5ed7-4435-a91c-7c5dc8e9baae">
<p>
从候选键中选择出主键。
</p>

<p>
主键的列不能包含空值null。主键往往设置为整型、长整型，可以为自增AUTO_INCREMENT字段。
</p>

<p>
表中可以没有主键，但是，一般表设计中，往往都会有主键，以避免记录重复。
</p>

<p>
InnoDB的表要求使用主键。
</p>
</div>
</div>
<div id="outline-container-h:84d43bee-b4e3-4abc-8df1-2a3d3f292498" class="outline-4">
<h4 id="h:84d43bee-b4e3-4abc-8df1-2a3d3f292498">Foreign KEY外键</h4>
<div class="outline-text-4" id="text-h:84d43bee-b4e3-4abc-8df1-2a3d3f292498">
<p>
严格来说，当一个关系中的某个属性或属性集合与另一个关系（也可以是自身）的候选键匹配时，就称作这个属性或属性集合是外键。
</p>

<div class="org-src-container">
<pre class="src src-sh">id name  loginname age  dept_id
1  tom   tom       20   1
2  jerry jerry     30   
3  tom   tom1      20


dept &#34920;
id name
1  it

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#24352;&#34920;&#29992;&#20102;&#21035;&#30340;&#34920;&#30340;&#20027;&#38190;&#65292;&#37027;&#20010;&#38190;&#23601;&#22806;&#38190;&#12290; dept_id</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2e308697-d849-46b0-ab04-dcf63c8dbd9a" class="outline-4">
<h4 id="h:2e308697-d849-46b0-ab04-dcf63c8dbd9a">索引Index</h4>
<div class="outline-text-4" id="text-h:2e308697-d849-46b0-ab04-dcf63c8dbd9a">
<p>
可以看做是一本字典的目录，为了快速检索用的。空间换时间，显著提高查询效率。
</p>

<p>
可以对一列或者多列字段设定索引。
</p>

<ul class="org-ul">
<li>主键索引，主键会自动建立主键索引，主键本身就是为了快速定位唯一记录的。</li>
<li>唯一索引，表中的索引列组成的索引必须唯一，但可以为空，非空值必须唯一。</li>
<li>普通索引，没有唯一性的要求，就是建了一个字典的目录而已。</li>
<li>联合索引，多个字段组合创建索引，使用条件查询时，先匹配左边字段。</li>
<li>全文索引，MyISAM使用，对char, varchar, text类型使用</li>
<li>空间索引，SPATIAL，基本不用。</li>
</ul>

<p>
在MySQL中，InnoDB和MyISAM的索引数据结构可以使用hash和BTree， innoDB默认是BTree。
</p>

<p>
Hash的时间复杂度是O(1)，但是只能进行精确匹配，也就是Hash值的匹配，比如范围匹配就没办法了，
hash值无序所以无法知道原有记录的顺序。Hash问题较多。
</p>

<p>
BTree索引，以B+树为存储结构。
</p>

<p>
虽然，索引可以提高查询，但却影响增删改的效率，因为需要索引更新或重构。频繁出现在where子句中的列可以考虑
使用索引。要避免把性别这种字段设索引。
</p>
</div>
</div>
<div id="outline-container-h:70f84de4-1c93-4fa2-8cef-bec2642be175" class="outline-4">
<h4 id="h:70f84de4-1c93-4fa2-8cef-bec2642be175">B+树</h4>
<div class="outline-text-4" id="text-h:70f84de4-1c93-4fa2-8cef-bec2642be175">
<pre class="example" id="orgd966237">
           |15         |        | 56   |           |  77 |  | 
           
    |15   |     |  20   |      | 49   |    |   | 

|15   | 18  | -&gt; |20   | 30   | -&gt; |49   | 50  | -&gt;
|data | data|    |data | data |    |data | data|
</pre>

<p>
B+树节点组织成一颗树。节点分为内部节点和叶子节点。
</p>

<p>
内部节点不存储数据，叶子节点不存储指针。
</p>

<p>
每个left node保存数据，所有的left node组织成链表。假设读取16到22的数据，找到18后，顺着链表往后遍历读取即可。
</p>

<p>
InnoDB中，数据文件本身就是按主键索引存储的，叶子节点中保存的就是数据记录。
</p>

<p>
如果在其他字段上定义B+Tree索引，叶子节点的数据记录的是主键，这种称为辅助索引。
</p>
</div>
</div>
</div>
<div id="outline-container-h:f2a0c1d8-41f1-43fa-821e-a40580fec10b" class="outline-3">
<h3 id="h:f2a0c1d8-41f1-43fa-821e-a40580fec10b">约束Constraint</h3>
<div class="outline-text-3" id="text-h:f2a0c1d8-41f1-43fa-821e-a40580fec10b">
<p>
为了保证数据的完整正确，数据模型还必须支持完整性约束
</p>

<ul class="org-ul">
<li>“必须有值”约束</li>
<li>某些列的值必须有值，不许为空NULL</li>
</ul>
</div>
<div id="outline-container-h:6a8ee6a1-35c9-4505-804c-f71dc1812616" class="outline-4">
<h4 id="h:6a8ee6a1-35c9-4505-804c-f71dc1812616">域约束Domain Constraint</h4>
<div class="outline-text-4" id="text-h:6a8ee6a1-35c9-4505-804c-f71dc1812616">
<p>
限定了表中字段的取值范围
</p>
</div>
</div>
<div id="outline-container-h:59a824af-29c1-4dd6-b504-54a991d23841" class="outline-4">
<h4 id="h:59a824af-29c1-4dd6-b504-54a991d23841">实体完整性Entity Integrity</h4>
<div class="outline-text-4" id="text-h:59a824af-29c1-4dd6-b504-54a991d23841">
<p>
PRIMARY KEY约束定义了主键，就定义了主键约束。主键不重复且唯一，不能为空
</p>
</div>
</div>
<div id="outline-container-h:b4cbc242-abfd-489b-a78f-d880a9afeca2" class="outline-4">
<h4 id="h:b4cbc242-abfd-489b-a78f-d880a9afeca2">引用完整性Referential Integrity <b>*</b></h4>
<div class="outline-text-4" id="text-h:b4cbc242-abfd-489b-a78f-d880a9afeca2">
<p>
外键定义中，可以不是引用另一张表的主键，但是，往往实际只会关注引用主键
</p>

<p>
外键：在表B中的列，引用了表A中的主键，表B中的列就是外键
</p>

<p>
A表称为主表，B表称为从表
</p>

<p>
插入规则
</p>
<ul class="org-ul">
<li>不需要指定</li>
<li>如果在表B插入一条记录，B的外键列插入了一个值，这个值必须是表A中存在的主键值</li>
</ul>

<p>
更新规则
</p>
<ul class="org-ul">
<li>定义外键约束时指定该规则</li>
</ul>

<p>
删除规则
</p>
<ul class="org-ul">
<li>定义外键约束时指定该规则</li>
</ul>

<p>
外键约束的操作
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">设定值</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">CASCADE</td>
<td class="org-left">级联，从父表删除或更新会自动删除或更新子表中匹配的行</td>
</tr>

<tr>
<td class="org-left">SET NULL</td>
<td class="org-left">从父表删除或更新行，会设置子表中的外键列为NULL，但必须保证子表列没有指定NOT NULL，也就是说子表的字段可以为NULL才行</td>
</tr>

<tr>
<td class="org-left">RESTRICT</td>
<td class="org-left">如果从父表删除主键，如果子表引用了，则拒绝对父表的删除或更新操作</td>
</tr>

<tr>
<td class="org-left">NO ACTION</td>
<td class="org-left">标准SQL的关键字，在MySQL中与RESTRICT相同。拒绝对父表的删除或更新操作</td>
</tr>
</tbody>
</table>

<p>
外键约束，是为了保证数据完整性、一致性，杜绝数冗余、数据错误。
</p>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh">emp &#20174;&#34920;
id name  loginname age  dept_id deleted &#22806;&#38190;&#24341;&#29992;&#65292;&#21442;&#32771;&#12289;&#21442;&#29031;
1  tom   tom       20   1       1
2  jerry jerry     30   1       0
3  tom   tom1      20   null       
15 ben   ben            3
18 sam   sam            4        &#22806;&#38190;&#32422;&#26463;&#65292;&#21024;&#38500;&#36825;&#26465;&#35760;&#24405;
20 adam  adam      18   6        &#36825;&#26465;&#19981;&#21487;&#33021;&#25104;&#21151;&#12290;&#20174;&#34920;&#26032;&#22686;&#25968;&#25454;&#32422;&#26463;&#65292;&#22825;&#29983;&#23601;&#26377;&#65292;&#35201;&#27714;&#24517;&#39035;&#21442;&#29031;&#20027;&#34920;&#30340;&#20027;&#38190;&#30340;&#20540;


dept &#20027;&#34920;
id name
1  &#20154;&#20107;&#37096;
2  &#24066;&#22330;&#37096;
3  IT&#37096;    set null&#35774;&#32622;&#20174;&#34920;&#24341;&#29992;&#30340;&#23383;&#27573;&#20026;null
4  &#21806;&#21518;&#37096;
5  &#36816;&#32500;&#37096;

&#32423;&#32852;&#21024;&#38500;&#65306;&#30495;&#21024;&#38500;
dept &#20027;&#34920;
id name    deleted
1  &#20154;&#20107;&#37096;   0
2  &#24066;&#22330;&#37096;   0 
3  IT&#37096;     1
4  &#21806;&#21518;&#37096;   0
5  &#36816;&#32500;&#37096;   0

3  IT&#37096;     1   &#21024;&#38500;&#36825;&#19968;&#34892;&#65292;&#20027;&#34920;&#19981;&#20801;&#35768;&#38543;&#20415;&#21024;&#38500;&#12290;&#20027;&#38190;&#20540;&#34987;&#24341;&#29992;&#65292;&#26356;&#19981;&#33021;&#38543;&#20415;&#21024;&#38500;&#12290;


&#37319;&#29992;&#32852;&#21512;&#26597;&#35810;&#12290;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:c16c14bb-c2d3-4de8-9118-160f974aca92" class="outline-3">
<h3 id="h:c16c14bb-c2d3-4de8-9118-160f974aca92">实体-联系E-R</h3>
<div class="outline-text-3" id="text-h:c16c14bb-c2d3-4de8-9118-160f974aca92">
<p>
数据库建立，需要收集用户需求，设计符合企业要求的数据模型。而构建这种模
型需要方法，这种方法需要成为E-R实体-联系建模。也出现了一种建模语
言——UML（Unified Modeling Language）统一建模语言。
</p>

<p>
实体Entity：现实世界中具有相同属性的一组对象，可以是物理存在的事物或抽象的事物。
</p>

<p>
联系Relationship：实体之间的关联集合。
</p>
</div>
<div id="outline-container-h:3e02fdfa-c2e4-4de0-9309-c6fbbf997a1e" class="outline-4">
<h4 id="h:3e02fdfa-c2e4-4de0-9309-c6fbbf997a1e">实体间联系类型-一对多-多对多</h4>
<div class="outline-text-4" id="text-h:3e02fdfa-c2e4-4de0-9309-c6fbbf997a1e">
<p>
假设有实体部门，实体员工
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">描述</th>
<th scope="col" class="org-left">解决方案</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">一对多联系 1:n</td>
<td class="org-left">一个员工属于一个部门，一个部门有多个员工</td>
<td class="org-left">员工外键；部门主键</td>
</tr>

<tr>
<td class="org-left">多对多联系 m:n</td>
<td class="org-left">一个员工属于多个部门，一个部门有多个员工</td>
<td class="org-left">建立第三表</td>
</tr>

<tr>
<td class="org-left">一对一联系 1:1</td>
<td class="org-left">假设有实体管理者，一个管理者管理一个部门，一个部门只有一个管理者</td>
<td class="org-left">字段建在哪张表都行</td>
</tr>
</tbody>
</table>

<p>
一对一关系用的较少，往往表示表A的一条记录唯一关联表B的一条记录，反之亦然。
</p>

<p>
它往往是为了将一张表多列分割并产生成了多张表，合起来是完整的信息，或为了方便查询，或为了数据安全隔离一部分字段的数据等等。
</p>

<p>
范例：多对多
</p>

<div class="org-src-container">
<pre class="src src-sh">n:n &#19968;&#20010;&#21592;&#24037;&#23646;&#20110;n&#20010;&#37096;&#38376;&#65292;&#19968;&#20010;&#37096;&#38376;&#26377;n&#20010;&#21592;&#24037;&#12290;
&#24314;&#31435;&#31532;&#19977;&#24352;&#34920;&#65292;&#24517;&#39035;&#20351;&#29992;&#20004;&#20010;&#34920;&#30340;&#20027;&#38190;&#32852;&#21512;&#37117;&#24471;&#25918;&#21040;&#31532;&#19977;&#34920;&#20013;&#12290;

emp &#20174;&#34920;
id name  loginname age 
1  tom   tom       20
2  jerry jerry     30
3  tom   tom1      20    
15 ben   ben       
18 sam   sam       
20 adam  adam      18   6 

dept &#20027;&#34920;
id name
1  &#20154;&#20107;&#37096;
2  &#24066;&#22330;&#37096;
3  IT&#37096;
4  &#21806;&#21518;&#37096;
5  &#36816;&#32500;&#37096;

dept_emp &#37096;&#38376;&#21592;&#24037;
dept_id   emp_id  &#32852;&#21512;&#36215;&#26469;&#23601;&#26159;&#20505;&#36873;&#38190;
1 fk      2 fk
3         3
4         3
2         15
&#20064;&#24815;&#19978;&#65292;&#21487;&#20197;&#25226;&#31532;3&#24352;&#34920;&#20013;&#27599;&#19968;&#20010;&#23383;&#27573;&#37117;&#26159;&#21407;&#26469;&#19994;&#21153;&#30340;&#22806;&#38190;&#65292;&#24314;&#35758;&#24320;&#22987;&#26102;&#35831;&#20351;&#29992;&#22806;&#38190;&#32422;&#26463;&#12290;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:7a1a2244-52f8-46fe-b892-0bcbbcaee5f9" class="outline-3">
<h3 id="h:7a1a2244-52f8-46fe-b892-0bcbbcaee5f9">视图</h3>
<div class="outline-text-3" id="text-h:7a1a2244-52f8-46fe-b892-0bcbbcaee5f9">
<p>
视图，也称虚表，看起来像表。它是由查询语句生成的。可以通过视图进行CRUD操作。
</p>

<p>
视图的作用
</p>
<ul class="org-ul">
<li>简化操作，将复杂查询SQL语句定义为视图，可以简化查询</li>
<li>数据安全，视图可以只显示真实表的部分列，或计算后的结果，从而隐藏真实表的数据</li>
</ul>
</div>
</div>
</section>
<section id="outline-container-h:c4edf2df-dea6-41b3-aab5-144c6b7c2779" class="outline-2">
<h2 id="h:c4edf2df-dea6-41b3-aab5-144c6b7c2779">必学必会SQL</h2>
<div class="outline-text-2" id="text-h:c4edf2df-dea6-41b3-aab5-144c6b7c2779">
</div>
<div id="outline-container-h:336c6703-fa13-49cb-be0e-66822a4fc5c1" class="outline-3">
<h3 id="h:336c6703-fa13-49cb-be0e-66822a4fc5c1">数据类型</h3>
<div class="outline-text-3" id="text-h:336c6703-fa13-49cb-be0e-66822a4fc5c1">
<p>
MySQL中的数据类型
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">tinyint</td>
<td class="org-left">1字节，带符号的范围是-128到127。无符号的范围是0到255。bool或boolean，就是tinyint，0表示假，非0表示真</td>
</tr>

<tr>
<td class="org-left">smallint</td>
<td class="org-left">2字节，带符号的范围是-32768到32767。无符号的范围是0到65535</td>
</tr>

<tr>
<td class="org-left">int</td>
<td class="org-left">整型，4字节，同Integer，带符号的范围是-2147483648到2147483647。无符号的范围是0到4294967295</td>
</tr>

<tr>
<td class="org-left">bigint</td>
<td class="org-left">长整型，8字节，带符号的范围是-9223372036854775808到9223372036854775807。无符号的范围是0到18446744073709551615</td>
</tr>

<tr>
<td class="org-left">float</td>
<td class="org-left">单精度浮点数精确到大约7位小数位</td>
</tr>

<tr>
<td class="org-left">double</td>
<td class="org-left">双精度浮点数精确到大约15位小数位</td>
</tr>

<tr>
<td class="org-left">DATE</td>
<td class="org-left">日期。支持的范围为’1000-01-01’到’9999-12-31’</td>
</tr>

<tr>
<td class="org-left">DATETIME</td>
<td class="org-left">支持的范围是’1000-01-01 00:00:00’到’9999-12-31 23:59:59’</td>
</tr>

<tr>
<td class="org-left">TIMESTAMP</td>
<td class="org-left">时间戳。范围是’1970-01-01 00:00:00’到2037年</td>
</tr>

<tr>
<td class="org-left">char(M)</td>
<td class="org-left">固定长度，右边填充空格以达到长度要求。M为长度，范围为0~255。M指的是字符个数</td>
</tr>

<tr>
<td class="org-left">varchar(M)</td>
<td class="org-left">变长字符串。M 表示最大列长度。M的范围是0到65,535。但不能突破行最大字节数65535</td>
</tr>

<tr>
<td class="org-left">text</td>
<td class="org-left">大文本。最大长度为65535(2^16-1)个字符</td>
</tr>

<tr>
<td class="org-left">BLOB</td>
<td class="org-left">大字节。最大长度为65535(2^16–1)字节的BLOB列</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>LENGTH函数返回字节数。而char和varchar定义的M是字符数限制</li>
<li>char可以将字符串定义为固定长度，空间换时间，效率略高；varchar为变长，省了空间</li>
</ul>
</div>
</div>
<div id="outline-container-h:78303ee8-553e-4313-8074-bd9de3be8c06" class="outline-3">
<h3 id="h:78303ee8-553e-4313-8074-bd9de3be8c06">关系操作</h3>
<div class="outline-text-3" id="text-h:78303ee8-553e-4313-8074-bd9de3be8c06">
<p>
关系：在关系数据库中，关系就是二维表。
</p>

<p>
关系操作就是对表的操作。
</p>

<ul class="org-ul">
<li>选择（selection）：又称为限制，是从关系中选择出满足给定条件的元组</li>
<li>投影（projection）：在关系上投影就是从选择出若干属性列组成新的关系</li>
<li>连接（join）：将不同的两个关系连接成一个关系</li>
</ul>
</div>
</div>
<div id="outline-container-h:fe5f5214-00d0-41cc-b38f-2c54d52fb18a" class="outline-3">
<h3 id="h:fe5f5214-00d0-41cc-b38f-2c54d52fb18a">CRUD增删改查</h3>
<div class="outline-text-3" id="text-h:fe5f5214-00d0-41cc-b38f-2c54d52fb18a">
<p>
所有操作一定要加条件
</p>
</div>
<div id="outline-container-h:92f50555-cb5f-4bc7-bd02-958f9c7f6273" class="outline-4">
<h4 id="h:92f50555-cb5f-4bc7-bd02-958f9c7f6273">Insert语句</h4>
<div class="outline-text-4" id="text-h:92f50555-cb5f-4bc7-bd02-958f9c7f6273">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> <span style="color: #a020f0;">table_name</span>(col_name,...) <span style="color: #a020f0;">VALUES</span> (value1,...);
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#21521;&#34920;&#20013;&#25554;&#20837;&#19968;&#34892;&#25968;&#25454;&#65292;&#33258;&#22686;&#23383;&#27573;&#12289;&#32570;&#30465;&#20540;&#23383;&#27573;&#12289;&#21487;&#20026;&#31354;&#23383;&#27573;&#21487;&#20197;&#19981;&#20889;</span>

<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> <span style="color: #a020f0;">table_name</span> <span style="color: #a020f0;">SELECT</span> ... ;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#23558;select&#26597;&#35810;&#30340;&#32467;&#26524;&#25554;&#20837;&#21040;&#34920;&#20013;</span>

<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> <span style="color: #a020f0;">table_name</span> (col_name1,...) <span style="color: #a020f0;">VALUES</span> (value1,...) <span style="color: #a020f0;">ON</span> DUPLICATE <span style="color: #a020f0;">KEY</span>
<span style="color: #a020f0;">UPDATE</span> col_name1=value1,...;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#22914;&#26524;&#20027;&#38190;&#20914;&#31361;&#12289;&#21807;&#19968;&#38190;&#20914;&#31361;&#23601;&#25191;&#34892;update&#21518;&#30340;&#35774;&#32622;&#12290;&#36825;&#26465;&#35821;&#21477;&#30340;&#24847;&#24605;&#65292;</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#23601;&#26159;&#20027;&#38190;&#19981;&#22312;&#26032;&#22686;&#35760;&#24405;&#65292;&#20027;&#38190;&#22312;&#23601;&#26356;&#26032;&#37096;&#20998;&#23383;&#27573;</span>

<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">IGNORE</span> <span style="color: #a020f0;">INTO</span> <span style="color: #a020f0;">table_name</span> (col_name,...) <span style="color: #a020f0;">VALUES</span> (value1,...);
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#22914;&#26524;&#20027;&#38190;&#20914;&#31361;&#12289;&#21807;&#19968;&#38190;&#20914;&#31361;&#23601;&#24573;&#30053;&#38169;&#35823;&#65292;&#36820;&#22238;&#19968;&#20010;&#35686;&#21578;</span>
</pre>
</div>

<p>
例：
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> reg(loginname, `<span style="color: #a020f0;">name</span>`, `password`) 
<span style="color: #a020f0;">VALUES</span>(<span style="color: #8b2252;">'tom'</span>, <span style="color: #8b2252;">'tom'</span>, <span style="color: #8b2252;">'tom'</span>);

<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> reg(if, loginname, `<span style="color: #a020f0;">name</span>`, `password`) 
<span style="color: #a020f0;">VALUES</span> (5, <span style="color: #8b2252;">'tom'</span>, <span style="color: #8b2252;">'tom'</span>, <span style="color: #8b2252;">'tom'</span>);

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#20027;&#38190;&#20914;&#31361;&#26032;&#22686;&#21464;&#26356;&#26032;</span>
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> reg(id, loginname, `<span style="color: #a020f0;">name</span>`, `password`) 
VALUED (1, <span style="color: #8b2252;">'tom'</span>, <span style="color: #8b2252;">'tom'</span>, <span style="color: #8b2252;">'tom'</span>) 
<span style="color: #a020f0;">ON</span> DUPLICATE <span style="color: #a020f0;">KEY</span> <span style="color: #a020f0;">UPDATE</span> <span style="color: #a020f0;">name</span> = <span style="color: #8b2252;">'jerry'</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DROP</span> DATABASE IF <span style="color: #a020f0;">EXISTS</span> test;
<span style="color: #a020f0;">CREATE</span> DATABASE IF <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">EXISTS</span> test <span style="color: #228b22;">CHARACTER</span> <span style="color: #a020f0;">SET</span> utf8mb4 <span style="color: #a020f0;">COLLATE</span> utf8mb4_general_ci;

use test

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#26377;&#20914;&#31361;&#29992;&#21453;&#24341;&#21495;&#12289;&#27809;&#20914;&#31361;&#20063;&#21487;&#20197;&#29992;&#21453;&#24341;&#21495;</span>
<span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">IF</span> <span style="color: #a020f0;">EXISTS</span> `reg`;
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `reg` (
  `id` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> AUTO_INCREMENT,
  `<span style="color: #a020f0;">name</span>` <span style="color: #228b22;">varchar</span>(48) <span style="color: #a020f0;">DEFAULT</span> <span style="color: #a020f0;">NULL</span>,
  `loginname` <span style="color: #228b22;">varchar</span>(48) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> COMMENT <span style="color: #8b2252;">'&#27880;&#20876;&#21517;&#24517;&#39035;&#22823;&#20110;4&#20010;&#23567;&#20110;24&#20010;&#23383;&#31526;'</span>,
  `password` <span style="color: #228b22;">varchar</span>(128) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> COMMENT <span style="color: #8b2252;">'&#23494;&#30721;&#23383;&#27573;'</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`id`),
  <span style="color: #a020f0;">UNIQUE</span> <span style="color: #a020f0;">KEY</span> `loginname` (`loginname`)
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8mb4;


<span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> reg(loginname, <span style="color: #a020f0;">name</span>, password) <span style="color: #a020f0;">VALUES</span>(<span style="color: #8b2252;">'tom'</span>,<span style="color: #8b2252;">'tom'</span>,<span style="color: #8b2252;">'tom'</span>),(<span style="color: #8b2252;">'jerry'</span>,<span style="color: #8b2252;">'jerry'</span>,<span style="color: #8b2252;">'jerry'</span>);

mysql&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> reg;
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------+-----------+----------+</span>
| id | <span style="color: #a020f0;">name</span>  | loginname | password |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------+-----------+----------+</span>
|  1 | tom   | tom       | tom      |
|  2 | jerry | jerry     | jerry    |
+<span style="color: #b22222;">----</span><span style="color: #b22222;">+-------+-----------+----------+</span>

<span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> reg(loginname, <span style="color: #a020f0;">name</span>, password, id) <span style="color: #a020f0;">values</span>(<span style="color: #8b2252;">'ben'</span>, <span style="color: #8b2252;">'ben'</span>, <span style="color: #8b2252;">'benpwd'</span>, 100);
<span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> reg(loginname, <span style="color: #a020f0;">name</span>, password) <span style="color: #a020f0;">values</span>(<span style="color: #8b2252;">'sam'</span>, <span style="color: #8b2252;">'sam'</span>, <span style="color: #8b2252;">'sampwd'</span>);

mysql&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> reg;
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+-------+-----------+----------+</span>
| id  | <span style="color: #a020f0;">name</span>  | loginname | password |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+-------+-----------+----------+</span>
|   1 | tom   | tom       | tom      |
|   2 | jerry | jerry     | jerry    |
| 100 | ben   | ben       | benpwd   |
| 101 | sam   | sam       | sampwd   |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+-------+-----------+----------+</span>

mysql&gt; <span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> reg(loginname, <span style="color: #a020f0;">name</span>, password) <span style="color: #a020f0;">VALUES</span>(<span style="color: #8b2252;">'tom'</span>,<span style="color: #8b2252;">'tom'</span>,<span style="color: #8b2252;">'tom'</span>);
ERROR 1062 (23000): Duplicate entry <span style="color: #8b2252;">'tom'</span> <span style="color: #a020f0;">for</span> <span style="color: #a020f0;">key</span> <span style="color: #8b2252;">'reg.loginname'</span>
mysql&gt; <span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> reg(loginname, <span style="color: #a020f0;">name</span>, password, id) <span style="color: #a020f0;">VALUES</span>(<span style="color: #8b2252;">'tom'</span>,<span style="color: #8b2252;">'tom'</span>,<span style="color: #8b2252;">'tom'</span>, 100);
ERROR 1062 (23000): Duplicate entry <span style="color: #8b2252;">'100'</span> <span style="color: #a020f0;">for</span> <span style="color: #a020f0;">key</span> <span style="color: #8b2252;">'reg.PRIMARY'</span>

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#20027;&#38190;&#20914;&#31361;&#20102;&#65292;&#26356;&#26032;&#36825;&#19968;&#34892;&#20869;&#23481;</span>
<span style="color: #a020f0;">insert</span> <span style="color: #a020f0;">into</span> reg(loginname, <span style="color: #a020f0;">name</span>, password, id) <span style="color: #a020f0;">VALUES</span>(<span style="color: #8b2252;">'tom'</span>,<span style="color: #8b2252;">'tom'</span>,<span style="color: #8b2252;">'tom'</span>, 100) <span style="color: #a020f0;">on</span> duplicate <span style="color: #a020f0;">key</span> <span style="color: #a020f0;">update</span> loginname=<span style="color: #8b2252;">'benny'</span>, <span style="color: #a020f0;">name</span>=<span style="color: #8b2252;">'benny'</span>;

mysql&gt; <span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> reg;
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+-------+-----------+----------+</span>
| id  | <span style="color: #a020f0;">name</span>  | loginname | password |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+-------+-----------+----------+</span>
|   1 | tom   | tom       | tom      |
|   2 | jerry | jerry     | jerry    |
| 100 | benny | benny     | benpwd   |
| 101 | sam   | sam       | sampwd   |
+<span style="color: #b22222;">-----</span><span style="color: #b22222;">+-------+-----------+----------+</span>
</pre>
</div>
</div>
<div id="outline-container-h:f63e6484-bdb8-41b6-b174-26dd487c5c19" class="outline-5">
<h5 id="h:f63e6484-bdb8-41b6-b174-26dd487c5c19">test.sql完整语句</h5>
<div class="outline-text-5" id="text-h:f63e6484-bdb8-41b6-b174-26dd487c5c19">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DROP</span> DATABASE IF <span style="color: #a020f0;">EXISTS</span> test;
<span style="color: #a020f0;">CREATE</span> DATABASE IF <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">EXISTS</span> test <span style="color: #228b22;">CHARACTER</span> <span style="color: #a020f0;">SET</span> utf8mb4 <span style="color: #a020f0;">COLLATE</span> utf8mb4_general_ci;
USE test;

<span style="color: #a020f0;">SET</span> FOREIGN_KEY_CHECKS=0;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">Table structure for departments</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">IF</span> <span style="color: #a020f0;">EXISTS</span> `departments`;
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `departments` (
  `dept_no` <span style="color: #228b22;">char</span>(4) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `dept_name` <span style="color: #228b22;">varchar</span>(40) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`dept_no`),
  <span style="color: #a020f0;">UNIQUE</span> <span style="color: #a020f0;">KEY</span> `dept_name` (`dept_name`)
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">Records of departments</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `departments` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'d009'</span>, <span style="color: #8b2252;">'Customer Service'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `departments` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'d005'</span>, <span style="color: #8b2252;">'Development'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `departments` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'d002'</span>, <span style="color: #8b2252;">'Finance'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `departments` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'d003'</span>, <span style="color: #8b2252;">'Human Resources'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `departments` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'d001'</span>, <span style="color: #8b2252;">'Marketing'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `departments` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'d004'</span>, <span style="color: #8b2252;">'Production'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `departments` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'d006'</span>, <span style="color: #8b2252;">'Quality Management'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `departments` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'d008'</span>, <span style="color: #8b2252;">'Research'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `departments` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'d007'</span>, <span style="color: #8b2252;">'Sales'</span>);

<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">Table structure for dept_emp</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">IF</span> <span style="color: #a020f0;">EXISTS</span> `dept_emp`;
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `dept_emp` (
  `emp_no` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `dept_no` <span style="color: #228b22;">char</span>(4) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `from_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `to_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`emp_no`,`dept_no`),
  <span style="color: #a020f0;">KEY</span> `dept_no` (`dept_no`),
  <span style="color: #a020f0;">CONSTRAINT</span> `dept_emp_ibfk_1` <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`emp_no`) <span style="color: #a020f0;">REFERENCES</span> `employees` (`emp_no`) <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">CASCADE</span>,
  <span style="color: #a020f0;">CONSTRAINT</span> `dept_emp_ibfk_2` <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`dept_no`) <span style="color: #a020f0;">REFERENCES</span> `departments` (`dept_no`) <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">CASCADE</span>
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">Records of dept_emp</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'d005'</span>, <span style="color: #8b2252;">'1986-06-26'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10002'</span>, <span style="color: #8b2252;">'d007'</span>, <span style="color: #8b2252;">'1996-08-03'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'d004'</span>, <span style="color: #8b2252;">'1995-12-03'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'d004'</span>, <span style="color: #8b2252;">'1986-12-01'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10005'</span>, <span style="color: #8b2252;">'d003'</span>, <span style="color: #8b2252;">'1989-09-12'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10006'</span>, <span style="color: #8b2252;">'d005'</span>, <span style="color: #8b2252;">'1990-08-05'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10007'</span>, <span style="color: #8b2252;">'d008'</span>, <span style="color: #8b2252;">'1989-02-10'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10008'</span>, <span style="color: #8b2252;">'d005'</span>, <span style="color: #8b2252;">'1998-03-11'</span>, <span style="color: #8b2252;">'2000-07-31'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10009'</span>, <span style="color: #8b2252;">'d006'</span>, <span style="color: #8b2252;">'1985-02-18'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10010'</span>, <span style="color: #8b2252;">'d004'</span>, <span style="color: #8b2252;">'1996-11-24'</span>, <span style="color: #8b2252;">'2000-06-26'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10010'</span>, <span style="color: #8b2252;">'d006'</span>, <span style="color: #8b2252;">'2000-06-26'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10011'</span>, <span style="color: #8b2252;">'d009'</span>, <span style="color: #8b2252;">'1990-01-22'</span>, <span style="color: #8b2252;">'1996-11-09'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10012'</span>, <span style="color: #8b2252;">'d005'</span>, <span style="color: #8b2252;">'1992-12-18'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10013'</span>, <span style="color: #8b2252;">'d003'</span>, <span style="color: #8b2252;">'1985-10-20'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10014'</span>, <span style="color: #8b2252;">'d005'</span>, <span style="color: #8b2252;">'1993-12-29'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10015'</span>, <span style="color: #8b2252;">'d008'</span>, <span style="color: #8b2252;">'1992-09-19'</span>, <span style="color: #8b2252;">'1993-08-22'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10016'</span>, <span style="color: #8b2252;">'d007'</span>, <span style="color: #8b2252;">'1998-02-11'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10017'</span>, <span style="color: #8b2252;">'d001'</span>, <span style="color: #8b2252;">'1993-08-03'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10018'</span>, <span style="color: #8b2252;">'d004'</span>, <span style="color: #8b2252;">'1992-07-29'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10018'</span>, <span style="color: #8b2252;">'d005'</span>, <span style="color: #8b2252;">'1987-04-03'</span>, <span style="color: #8b2252;">'1992-07-29'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10019'</span>, <span style="color: #8b2252;">'d008'</span>, <span style="color: #8b2252;">'1999-04-30'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `dept_emp` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10020'</span>, <span style="color: #8b2252;">'d004'</span>, <span style="color: #8b2252;">'1997-12-30'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);

<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">Table structure for employees</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">IF</span> <span style="color: #a020f0;">EXISTS</span> `employees`;
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `employees` (
  `emp_no` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `birth_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `first_name` <span style="color: #228b22;">varchar</span>(14) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `last_name` <span style="color: #228b22;">varchar</span>(16) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `gender` <span style="color: #228b22;">smallint</span>(6) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> <span style="color: #a020f0;">DEFAULT</span> 1 COMMENT <span style="color: #8b2252;">'M=1, F=2'</span>,
  `hire_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`emp_no`)
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8; 

<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">Records of employees</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'1953-09-02'</span>, <span style="color: #8b2252;">'Georgi'</span>, <span style="color: #8b2252;">'Facello'</span>, <span style="color: #8b2252;">'1'</span>, <span style="color: #8b2252;">'1986-06-26'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10002'</span>, <span style="color: #8b2252;">'1964-06-02'</span>, <span style="color: #8b2252;">'Bezalel'</span>, <span style="color: #8b2252;">'Simmel'</span>, <span style="color: #8b2252;">'2'</span>, <span style="color: #8b2252;">'1985-11-21'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'1959-12-03'</span>, <span style="color: #8b2252;">'Parto'</span>, <span style="color: #8b2252;">'Bamford'</span>, <span style="color: #8b2252;">'1'</span>, <span style="color: #8b2252;">'1986-08-28'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'1954-05-01'</span>, <span style="color: #8b2252;">'Chirstian'</span>, <span style="color: #8b2252;">'Koblick'</span>, <span style="color: #8b2252;">'1'</span>, <span style="color: #8b2252;">'1986-12-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10005'</span>, <span style="color: #8b2252;">'1955-01-21'</span>, <span style="color: #8b2252;">'Kyoichi'</span>, <span style="color: #8b2252;">'Maliniak'</span>, <span style="color: #8b2252;">'1'</span>, <span style="color: #8b2252;">'1989-09-12'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10006'</span>, <span style="color: #8b2252;">'1953-04-20'</span>, <span style="color: #8b2252;">'Anneke'</span>, <span style="color: #8b2252;">'Preusig'</span>, <span style="color: #8b2252;">'2'</span>, <span style="color: #8b2252;">'1989-06-02'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10007'</span>, <span style="color: #8b2252;">'1957-05-23'</span>, <span style="color: #8b2252;">'Tzvetan'</span>, <span style="color: #8b2252;">'Zielinski'</span>, <span style="color: #8b2252;">'2'</span>, <span style="color: #8b2252;">'1989-02-10'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10008'</span>, <span style="color: #8b2252;">'1958-02-19'</span>, <span style="color: #8b2252;">'Saniya'</span>, <span style="color: #8b2252;">'Kalloufi'</span>, <span style="color: #8b2252;">'1'</span>, <span style="color: #8b2252;">'1994-09-15'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10009'</span>, <span style="color: #8b2252;">'1952-04-19'</span>, <span style="color: #8b2252;">'Sumant'</span>, <span style="color: #8b2252;">'Peac'</span>, <span style="color: #8b2252;">'2'</span>, <span style="color: #8b2252;">'1985-02-18'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10010'</span>, <span style="color: #8b2252;">'1963-06-01'</span>, <span style="color: #8b2252;">'Duangkaew'</span>, <span style="color: #8b2252;">'Piveteau'</span>, <span style="color: #8b2252;">'2'</span>, <span style="color: #8b2252;">'1989-08-24'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10011'</span>, <span style="color: #8b2252;">'1953-11-07'</span>, <span style="color: #8b2252;">'Mary'</span>, <span style="color: #8b2252;">'Sluis'</span>, <span style="color: #8b2252;">'2'</span>, <span style="color: #8b2252;">'1990-01-22'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10012'</span>, <span style="color: #8b2252;">'1960-10-04'</span>, <span style="color: #8b2252;">'Patricio'</span>, <span style="color: #8b2252;">'Bridgland'</span>, <span style="color: #8b2252;">'1'</span>, <span style="color: #8b2252;">'1992-12-18'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10013'</span>, <span style="color: #8b2252;">'1963-06-07'</span>, <span style="color: #8b2252;">'Eberhardt'</span>, <span style="color: #8b2252;">'Terkki'</span>, <span style="color: #8b2252;">'1'</span>, <span style="color: #8b2252;">'1985-10-20'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10014'</span>, <span style="color: #8b2252;">'1956-02-12'</span>, <span style="color: #8b2252;">'Berni'</span>, <span style="color: #8b2252;">'Genin'</span>, <span style="color: #8b2252;">'1'</span>, <span style="color: #8b2252;">'1987-03-11'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10015'</span>, <span style="color: #8b2252;">'1959-08-19'</span>, <span style="color: #8b2252;">'Guoxiang'</span>, <span style="color: #8b2252;">'Nooteboom'</span>, <span style="color: #8b2252;">'1'</span>, <span style="color: #8b2252;">'1987-07-02'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10016'</span>, <span style="color: #8b2252;">'1961-05-02'</span>, <span style="color: #8b2252;">'Kazuhito'</span>, <span style="color: #8b2252;">'Cappelletti'</span>, <span style="color: #8b2252;">'1'</span>, <span style="color: #8b2252;">'1995-01-27'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10017'</span>, <span style="color: #8b2252;">'1958-07-06'</span>, <span style="color: #8b2252;">'Cristinel'</span>, <span style="color: #8b2252;">'Bouloucos'</span>, <span style="color: #8b2252;">'2'</span>, <span style="color: #8b2252;">'1993-08-03'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10018'</span>, <span style="color: #8b2252;">'1954-06-19'</span>, <span style="color: #8b2252;">'Kazuhide'</span>, <span style="color: #8b2252;">'Peha'</span>, <span style="color: #8b2252;">'2'</span>, <span style="color: #8b2252;">'1987-04-03'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10019'</span>, <span style="color: #8b2252;">'1953-01-23'</span>, <span style="color: #8b2252;">'Lillian'</span>, <span style="color: #8b2252;">'Haddadi'</span>, <span style="color: #8b2252;">'1'</span>, <span style="color: #8b2252;">'1999-04-30'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `employees` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10020'</span>, <span style="color: #8b2252;">'1952-12-24'</span>, <span style="color: #8b2252;">'Mayuko'</span>, <span style="color: #8b2252;">'Warwick'</span>, <span style="color: #8b2252;">'1'</span>, <span style="color: #8b2252;">'1991-01-26'</span>);

<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">Table structure for salaries</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">IF</span> <span style="color: #a020f0;">EXISTS</span> `salaries`;
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `salaries` (
  `emp_no` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `salary` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `from_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `to_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`emp_no`,`from_date`),
  <span style="color: #a020f0;">CONSTRAINT</span> `salaries_ibfk_1` <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`emp_no`) <span style="color: #a020f0;">REFERENCES</span> `employees` (`emp_no`) <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">CASCADE</span>
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">Records of salaries</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'60117'</span>, <span style="color: #8b2252;">'1986-06-26'</span>, <span style="color: #8b2252;">'1987-06-26'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'62102'</span>, <span style="color: #8b2252;">'1987-06-26'</span>, <span style="color: #8b2252;">'1988-06-25'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'66074'</span>, <span style="color: #8b2252;">'1988-06-25'</span>, <span style="color: #8b2252;">'1989-06-25'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'66596'</span>, <span style="color: #8b2252;">'1989-06-25'</span>, <span style="color: #8b2252;">'1990-06-25'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'66961'</span>, <span style="color: #8b2252;">'1990-06-25'</span>, <span style="color: #8b2252;">'1991-06-25'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'71046'</span>, <span style="color: #8b2252;">'1991-06-25'</span>, <span style="color: #8b2252;">'1992-06-24'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'74333'</span>, <span style="color: #8b2252;">'1992-06-24'</span>, <span style="color: #8b2252;">'1993-06-24'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'75286'</span>, <span style="color: #8b2252;">'1993-06-24'</span>, <span style="color: #8b2252;">'1994-06-24'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'75994'</span>, <span style="color: #8b2252;">'1994-06-24'</span>, <span style="color: #8b2252;">'1995-06-24'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'76884'</span>, <span style="color: #8b2252;">'1995-06-24'</span>, <span style="color: #8b2252;">'1996-06-23'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'80013'</span>, <span style="color: #8b2252;">'1996-06-23'</span>, <span style="color: #8b2252;">'1997-06-23'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'81025'</span>, <span style="color: #8b2252;">'1997-06-23'</span>, <span style="color: #8b2252;">'1998-06-23'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'81097'</span>, <span style="color: #8b2252;">'1998-06-23'</span>, <span style="color: #8b2252;">'1999-06-23'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'84917'</span>, <span style="color: #8b2252;">'1999-06-23'</span>, <span style="color: #8b2252;">'2000-06-22'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'85112'</span>, <span style="color: #8b2252;">'2000-06-22'</span>, <span style="color: #8b2252;">'2001-06-22'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'85097'</span>, <span style="color: #8b2252;">'2001-06-22'</span>, <span style="color: #8b2252;">'2002-06-22'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'88958'</span>, <span style="color: #8b2252;">'2002-06-22'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10002'</span>, <span style="color: #8b2252;">'65828'</span>, <span style="color: #8b2252;">'1996-08-03'</span>, <span style="color: #8b2252;">'1997-08-03'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10002'</span>, <span style="color: #8b2252;">'65909'</span>, <span style="color: #8b2252;">'1997-08-03'</span>, <span style="color: #8b2252;">'1998-08-03'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10002'</span>, <span style="color: #8b2252;">'67534'</span>, <span style="color: #8b2252;">'1998-08-03'</span>, <span style="color: #8b2252;">'1999-08-03'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10002'</span>, <span style="color: #8b2252;">'69366'</span>, <span style="color: #8b2252;">'1999-08-03'</span>, <span style="color: #8b2252;">'2000-08-02'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10002'</span>, <span style="color: #8b2252;">'71963'</span>, <span style="color: #8b2252;">'2000-08-02'</span>, <span style="color: #8b2252;">'2001-08-02'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10002'</span>, <span style="color: #8b2252;">'72527'</span>, <span style="color: #8b2252;">'2001-08-02'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'40006'</span>, <span style="color: #8b2252;">'1995-12-03'</span>, <span style="color: #8b2252;">'1996-12-02'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'43616'</span>, <span style="color: #8b2252;">'1996-12-02'</span>, <span style="color: #8b2252;">'1997-12-02'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'43466'</span>, <span style="color: #8b2252;">'1997-12-02'</span>, <span style="color: #8b2252;">'1998-12-02'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'43636'</span>, <span style="color: #8b2252;">'1998-12-02'</span>, <span style="color: #8b2252;">'1999-12-02'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'43478'</span>, <span style="color: #8b2252;">'1999-12-02'</span>, <span style="color: #8b2252;">'2000-12-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'43699'</span>, <span style="color: #8b2252;">'2000-12-01'</span>, <span style="color: #8b2252;">'2001-12-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'43311'</span>, <span style="color: #8b2252;">'2001-12-01'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'40054'</span>, <span style="color: #8b2252;">'1986-12-01'</span>, <span style="color: #8b2252;">'1987-12-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'42283'</span>, <span style="color: #8b2252;">'1987-12-01'</span>, <span style="color: #8b2252;">'1988-11-30'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'42542'</span>, <span style="color: #8b2252;">'1988-11-30'</span>, <span style="color: #8b2252;">'1989-11-30'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'46065'</span>, <span style="color: #8b2252;">'1989-11-30'</span>, <span style="color: #8b2252;">'1990-11-30'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'48271'</span>, <span style="color: #8b2252;">'1990-11-30'</span>, <span style="color: #8b2252;">'1991-11-30'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'50594'</span>, <span style="color: #8b2252;">'1991-11-30'</span>, <span style="color: #8b2252;">'1992-11-29'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'52119'</span>, <span style="color: #8b2252;">'1992-11-29'</span>, <span style="color: #8b2252;">'1993-11-29'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'54693'</span>, <span style="color: #8b2252;">'1993-11-29'</span>, <span style="color: #8b2252;">'1994-11-29'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'58326'</span>, <span style="color: #8b2252;">'1994-11-29'</span>, <span style="color: #8b2252;">'1995-11-29'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'60770'</span>, <span style="color: #8b2252;">'1995-11-29'</span>, <span style="color: #8b2252;">'1996-11-28'</span>);

<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">Table structure for titles</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">IF</span> <span style="color: #a020f0;">EXISTS</span> `titles`;
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `titles` (
  `emp_no` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `title` <span style="color: #228b22;">varchar</span>(50) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `from_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `to_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">DEFAULT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`emp_no`,`title`,`from_date`),
  <span style="color: #a020f0;">CONSTRAINT</span> `titles_ibfk_1` <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`emp_no`) <span style="color: #a020f0;">REFERENCES</span> `employees` (`emp_no`) <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">CASCADE</span>
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">Records of titles</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'Senior Engineer'</span>, <span style="color: #8b2252;">'1986-06-26'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10002'</span>, <span style="color: #8b2252;">'Staff'</span>, <span style="color: #8b2252;">'1996-08-03'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'Senior Engineer'</span>, <span style="color: #8b2252;">'1995-12-03'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'Engineer'</span>, <span style="color: #8b2252;">'1986-12-01'</span>, <span style="color: #8b2252;">'1995-12-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'Senior Engineer'</span>, <span style="color: #8b2252;">'1995-12-01'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10005'</span>, <span style="color: #8b2252;">'Senior Staff'</span>, <span style="color: #8b2252;">'1996-09-12'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10005'</span>, <span style="color: #8b2252;">'Staff'</span>, <span style="color: #8b2252;">'1989-09-12'</span>, <span style="color: #8b2252;">'1996-09-12'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10006'</span>, <span style="color: #8b2252;">'Senior Engineer'</span>, <span style="color: #8b2252;">'1990-08-05'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10007'</span>, <span style="color: #8b2252;">'Senior Staff'</span>, <span style="color: #8b2252;">'1996-02-11'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10007'</span>, <span style="color: #8b2252;">'Staff'</span>, <span style="color: #8b2252;">'1989-02-10'</span>, <span style="color: #8b2252;">'1996-02-11'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10008'</span>, <span style="color: #8b2252;">'Assistant Engineer'</span>, <span style="color: #8b2252;">'1998-03-11'</span>, <span style="color: #8b2252;">'2000-07-31'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10009'</span>, <span style="color: #8b2252;">'Assistant Engineer'</span>, <span style="color: #8b2252;">'1985-02-18'</span>, <span style="color: #8b2252;">'1990-02-18'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10009'</span>, <span style="color: #8b2252;">'Engineer'</span>, <span style="color: #8b2252;">'1990-02-18'</span>, <span style="color: #8b2252;">'1995-02-18'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10009'</span>, <span style="color: #8b2252;">'Senior Engineer'</span>, <span style="color: #8b2252;">'1995-02-18'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10010'</span>, <span style="color: #8b2252;">'Engineer'</span>, <span style="color: #8b2252;">'1996-11-24'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10011'</span>, <span style="color: #8b2252;">'Staff'</span>, <span style="color: #8b2252;">'1990-01-22'</span>, <span style="color: #8b2252;">'1996-11-09'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10012'</span>, <span style="color: #8b2252;">'Engineer'</span>, <span style="color: #8b2252;">'1992-12-18'</span>, <span style="color: #8b2252;">'2000-12-18'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10012'</span>, <span style="color: #8b2252;">'Senior Engineer'</span>, <span style="color: #8b2252;">'2000-12-18'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10013'</span>, <span style="color: #8b2252;">'Senior Staff'</span>, <span style="color: #8b2252;">'1985-10-20'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10014'</span>, <span style="color: #8b2252;">'Engineer'</span>, <span style="color: #8b2252;">'1993-12-29'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `titles` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10015'</span>, <span style="color: #8b2252;">'Senior Staff'</span>, <span style="color: #8b2252;">'1992-09-19'</span>, <span style="color: #8b2252;">'1993-08-22'</span>);
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:0d2f562c-9479-430d-9a39-b0fbf0583a12" class="outline-4">
<h4 id="h:0d2f562c-9479-430d-9a39-b0fbf0583a12">Update语句</h4>
<div class="outline-text-4" id="text-h:0d2f562c-9479-430d-9a39-b0fbf0583a12">
<div class="org-src-container">
<pre class="src src-sql">UPDATA [<span style="color: #a020f0;">IGNORE</span>] tal_name <span style="color: #a020f0;">SET</span> col_name1=expr1 [, col_name2=expr2 ...] [<span style="color: #a020f0;">WHERE</span> where_definition]
<span style="color: #b22222;">-- </span><span style="color: #b22222;">IFNORE &#24847;&#20041;&#21516;Insert&#35821;&#21477;</span>

<span style="color: #a020f0;">UPDATE</span> reg <span style="color: #a020f0;">SET</span> <span style="color: #a020f0;">name</span>=<span style="color: #8b2252;">'tom&#183; WHERE id=5;</span>
</pre>
</div>

<p>
更新一定要加条件
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#27880;&#24847;&#36825;&#19968;&#21477;&#38750;&#24120;&#21361;&#38505;&#65292;&#20250;&#26356;&#26032;&#25152;&#26377;&#25968;&#25454;</span>
<span style="color: #a020f0;">UPDATE</span> reg <span style="color: #a020f0;">SET</span> <span style="color: #a020f0;">name</span> =<span style="color: #8b2252;">'ben'</span>;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#25351;&#23450;&#33539;&#22260;</span>
<span style="color: #a020f0;">UPDATE</span> reg <span style="color: #a020f0;">SET</span> <span style="color: #a020f0;">name</span> = <span style="color: #8b2252;">'ben'</span>, password = <span style="color: #8b2252;">'benpwd'</span> WHRER id = 1;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:994be50c-728f-4dfa-b57a-12a1fa077e9d" class="outline-4">
<h4 id="h:994be50c-728f-4dfa-b57a-12a1fa077e9d">Delete语句</h4>
<div class="outline-text-4" id="text-h:994be50c-728f-4dfa-b57a-12a1fa077e9d">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">FROM</span> tal_name [<span style="color: #a020f0;">WHERE</span> where_defintion]
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#21024;&#38500;&#31526;&#21512;&#26465;&#20214;&#30340;&#35760;&#24405;</span>

<span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">FROM</span> reg <span style="color: #a020f0;">WHERE</span> id =1;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#21024;&#38500;&#19968;&#23450;&#35201;&#26377;&#26465;&#20214;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e80b5024-5b3e-48e9-94dc-d1155d8f92f6" class="outline-4">
<h4 id="h:e80b5024-5b3e-48e9-94dc-d1155d8f92f6">Select语句</h4>
<div class="outline-text-4" id="text-h:e80b5024-5b3e-48e9-94dc-d1155d8f92f6">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span>
    [<span style="color: #a020f0;">DISTINCT</span>]
    select_expr, ...
    [<span style="color: #a020f0;">FROM</span> table_references
    [<span style="color: #a020f0;">WHERE</span> where_definition]
    [FROUP <span style="color: #a020f0;">BY</span> {col_name | expr | <span style="color: #a020f0;">position</span>}
      [<span style="color: #a020f0;">ASC</span> | <span style="color: #a020f0;">DESC</span>], ... [<span style="color: #a020f0;">WITH</span> <span style="color: #a020f0;">ROLLUP</span>]]
    [<span style="color: #a020f0;">HAVING</span> whrer_definition]
    [<span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span> {col_name | expr | <span style="color: #a020f0;">position</span>}
      [<span style="color: #a020f0;">ASC</span> | <span style="color: #a020f0;">DESC</span>], ...]
    [<span style="color: #a020f0;">LIMIT</span> {[offset,} roe_count | <span style="color: #a020f0;">row_count</span> OFFSET offset}]
    [<span style="color: #a020f0;">FOR</span> <span style="color: #a020f0;">UPDATE</span> | LOCK <span style="color: #a020f0;">IN</span> SHARE MODE]]
</pre>
</div>

<p>
FOR UPDATE会把行进行写锁定，这是排它锁
</p>

<p>
查询
</p>

<p>
查询的结果成为结果集recordset
</p>

<p>
最简单的查询
</p>
<div class="org-src-container">
<pre class="src src-sh">mysql&gt; select 1;
+---+
| 1 |
+---+
| 1 |
+---+

mysql&gt; select 1, <span style="color: #8b2252;">'ab'</span>;
+---+----+
| 1 | ab |
+---+----+
| 1 | ab |
+---+----+

mysql&gt; select * from reg;
+-----+-------+-----------+----------+
| id  | name  | loginname | password |
+-----+-------+-----------+----------+
|   1 | tom   | tom       | tom      |
|   2 | jerry | jerry     | jerry    |
| 100 | benny | benny     | benpwd   |
| 101 | sam   | sam       | sampwd   |
+-----+-------+-----------+----------+
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> emp_no, first_name + last_name <span style="color: #a020f0;">FROM</span> employees;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#23383;&#31526;&#20018;&#21512;&#24182;</span>

<span style="color: #a020f0;">SELECT</span> emp_no, CONCAT(first_name,<span style="color: #8b2252;">' '</span>,last_name) <span style="color: #a020f0;">FROM</span> employees;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#20351;&#29992;&#23383;&#31526;&#20018;&#30456;&#21152;&#20989;&#25968; CONCAT</span>

<span style="color: #a020f0;">SELECT</span> emp_no <span style="color: #a020f0;">as</span> en, CONCAT(first_name,<span style="color: #8b2252;">' '</span>,last_name) <span style="color: #a020f0;">as</span> <span style="color: #a020f0;">name</span> <span style="color: #a020f0;">FROM</span> employees;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">AS&#23450;&#20041;&#21035;&#21517;&#65292;&#21487;&#36873;&#12290;&#20889;AS&#26159;&#19968;&#20010;&#22909;&#20064;&#24815;</span>
</pre>
</div>
</div>
<div id="outline-container-h:dfb76287-2923-40f9-8422-58fb21b950e2" class="outline-5">
<h5 id="h:dfb76287-2923-40f9-8422-58fb21b950e2">Limit子句</h5>
<div class="outline-text-5" id="text-h:dfb76287-2923-40f9-8422-58fb21b950e2">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#36820;&#22238;5&#26465;&#35760;&#24405;&#65292; [1,5]&#24038;&#38381;&#21491;&#38381;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">as</span> emp <span style="color: #a020f0;">LIMIT</span> 5;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#36820;&#22238;5&#26465;&#35760;&#24405;&#65292;&#20559;&#31227;3&#26465;&#65292;limit3, 5 ---  (3,3+5]&#24038;&#24320;&#21491;&#38381; start:end start:len &#20998;&#39029;&#29992;&#21040;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">as</span> emp <span style="color: #a020f0;">LIMIT</span> 3, 5;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31561;&#20215;&#20110;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">as</span> emp <span style="color: #a020f0;">LIMIT</span> 5 offset 3; 
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bc5b6652-deee-46d0-805a-7f5d91043121" class="outline-5">
<h5 id="h:bc5b6652-deee-46d0-805a-7f5d91043121">Where子句</h5>
<div class="outline-text-5" id="text-h:bc5b6652-deee-46d0-805a-7f5d91043121">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">运算符</th>
<th scope="col" class="org-left">描述符</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">=</td>
<td class="org-left">等于</td>
</tr>

<tr>
<td class="org-left">&lt;&gt;  或 !=</td>
<td class="org-left">不等于</td>
</tr>

<tr>
<td class="org-left">&gt;、 &lt;、 &gt;=、 &lt;=</td>
<td class="org-left">大于、小于、大于等于、小于等于</td>
</tr>

<tr>
<td class="org-left">BETWEEN</td>
<td class="org-left">在某个范围之内，between a and b等价于[a, b]</td>
</tr>

<tr>
<td class="org-left">LIKE</td>
<td class="org-left">字符串模式匹配，%表示任意多个字符，_表示一个字符</td>
</tr>

<tr>
<td class="org-left">IN</td>
<td class="org-left">指定针对某个列的多个可能值</td>
</tr>

<tr>
<td class="org-left">AND</td>
<td class="org-left">与</td>
</tr>

<tr>
<td class="org-left">OR</td>
<td class="org-left">或</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>能用键匹配用键</li>
<li>LIKE 只能使用左前缀，尽量不使用，性能差</li>
</ul>

<p>
注意：如果很多表达式需要使用AND、OR计算逻辑表达式的值的时候，由于有结合律的问题，建议使用小括号来避免产生错误
</p>

<p>
查询条件
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">--  </span><span style="color: #b22222;">&#26465;&#20214;</span>
<span style="color: #a020f0;">SELECT</span> emps.emp_no <span style="color: #a020f0;">as</span> id, last_name <span style="color: #a020f0;">FROM</span> employees emps <span style="color: #a020f0;">WHERE</span> <span style="color: #a020f0;">not</span> (emps.emp_no = 10008 <span style="color: #a020f0;">or</span> emps.emp_no = 10010);
<span style="color: #a020f0;">SELECT</span> emps.emp_no <span style="color: #a020f0;">as</span> id, last_name <span style="color: #a020f0;">FROM</span> employees emps <span style="color: #a020f0;">WHERE</span> <span style="color: #a020f0;">not</span> emp_no &lt;&gt; 10008 <span style="color: #a020f0;">and</span> emp_no &lt;&gt; 10010;
<span style="color: #a020f0;">SELECT</span> emps.emp_no <span style="color: #a020f0;">as</span> id, last_name <span style="color: #a020f0;">FROM</span> employees emps <span style="color: #a020f0;">WHERE</span> <span style="color: #a020f0;">not</span> emp_no <span style="color: #a020f0;">in</span> (10008, 10010);
<span style="color: #a020f0;">SELECT</span> emps.emp_no <span style="color: #a020f0;">as</span> id, last_name <span style="color: #a020f0;">FROM</span> employees emps <span style="color: #a020f0;">WHERE</span> <span style="color: #a020f0;">not</span> emp_no <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> (10008, 10010);
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#33539;&#22260;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">WHERE</span> emp_no &lt; 10015 <span style="color: #a020f0;">and</span> last_name <span style="color: #a020f0;">LIKE</span> <span style="color: #8b2252;">'P%'</span>;  <span style="color: #b22222;">-- </span><span style="color: #b22222;">mysql&#20013;str&#40664;&#35748;&#24573;&#30053;&#22823;&#23567;&#20889;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">WHERE</span> emp_no &lt; 10015 <span style="color: #a020f0;">and</span> last_name <span style="color: #a020f0;">LIKE</span> <span style="color: #8b2252;">'P__%'</span>;  <span style="color: #b22222;">-- </span><span style="color: #b22222;">&#19979;&#21010;&#32447; _ &#20195;&#34920;&#21333;&#20010;&#21305;&#37197;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">WHERE</span> emp_no <span style="color: #a020f0;">BETWEEN</span> 10010 <span style="color: #a020f0;">AND</span> 10015 <span style="color: #a020f0;">AND</span> last_name <span style="color: #a020f0;">LIKE</span> <span style="color: #8b2252;">'P%'</span>;
</pre>
</div>

<p>
EXPLAIN 可判断查询条件性能如何
</p>
<div class="org-src-container">
<pre class="src src-sql">EXPLAIN <span style="color: #a020f0;">SELECT</span> emp_no <span style="color: #a020f0;">AS</span> id, birth_date, concat(FIRST_name, <span style="color: #8b2252;">' '</span>, last_name) <span style="color: #a020f0;">as</span> <span style="color: #a020f0;">name</span>
  <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">as</span> emp <span style="color: #a020f0;">WHERE</span> last_name=<span style="color: #8b2252;">'Sluis'</span>;


EXPLAIN <span style="color: #a020f0;">SELECT</span> emp_no <span style="color: #a020f0;">AS</span> id, birth_date, concat(FIRST_name, <span style="color: #8b2252;">' '</span>, last_name) <span style="color: #a020f0;">as</span> <span style="color: #a020f0;">name</span>
  <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">as</span> emp <span style="color: #a020f0;">WHERE</span> emp_no <span style="color: #a020f0;">BETWEEN</span> 10010 <span style="color: #a020f0;">and</span> 10015 <span style="color: #a020f0;">and</span> last_name=<span style="color: #8b2252;">'Sluis'</span>;
</pre>
</div>


<p>
type显示的是访问类型，是较为重要的一个指标，结果值从好到坏依次是：NULL
&gt;system &gt; const &gt;eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge
&gt;unique_subquery &gt; index_subquery &gt; range &gt;index &gt; ALL，一般来说，得保
证查询至少达到range级别，最好能达到ref
</p>

<div class="org-src-container">
<pre class="src src-sh">NULL &gt;system &gt; const &gt;eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt;unique_subquery &gt; index_subquery &gt; range &gt;index &gt; ALL //&#26368;&#22909;&#21040;&#26368;&#24046;
&#22791;&#27880;&#65306;&#25484;&#25569;&#20197;&#19979;10&#31181;&#24120;&#35265;&#30340;&#21363;&#21487;
NULL &gt;system &gt; const &gt;eq_ref &gt;ref &gt; ref_or_null &gt; index_merge &gt;range &gt;index &gt; ALL
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">All</td>
<td class="org-left">最坏的情况,全表扫描</td>
</tr>

<tr>
<td class="org-left">index</td>
<td class="org-left">和全表扫描一样。只是扫描表的时候按照索引次序进行而不是行。主要优点就是避免了排序, 但是开销仍然非常大。如在Extra列看到Using index，说明正在使用覆盖索引，只扫描索引的数据，它比按索引次序全表扫描的开销要小很多</td>
</tr>

<tr>
<td class="org-left">range</td>
<td class="org-left">范围扫描，一个有限制的索引扫描。key 列显示使用了哪个索引。当使用=、 &lt;&gt;、&gt;、&gt;=、&lt;、&lt;=、IS NULL、&lt;=&gt;、BETWEEN 或者 IN 操作符,用常量比较关键字列时,可以使用 range</td>
</tr>

<tr>
<td class="org-left">ref</td>
<td class="org-left">一种索引访问，它返回所有匹配某个单个值的行。此类索引访问只有当使用非唯一性索引或唯一性索引非唯一性前缀时才会发生。这个类型跟eq_ref不同的是，它用在关联操作只使用了索引的最左前缀，或者索引不是UNIQUE和PRIMARY KEY。ref可以用于使用=或&lt;=&gt;操作符的带索引的列。</td>
</tr>

<tr>
<td class="org-left">eq_ref</td>
<td class="org-left">最多只返回一条符合条件的记录。使用唯一性索引或主键查找时会发生 （高效）</td>
</tr>

<tr>
<td class="org-left">const</td>
<td class="org-left">当确定最多只会有一行匹配的时候，MySQL优化器会在查询前读取它而且只读取一次，因此非常快。当主键放入where子句时，mysql把这个查询转为一个常量（高效）</td>
</tr>

<tr>
<td class="org-left">system</td>
<td class="org-left">这是const连接类型的一种特例，表仅有一行满足条件。</td>
</tr>

<tr>
<td class="org-left">Null</td>
<td class="org-left">意味着mysql能在优化阶段分解查询语句，在执行阶段甚至用不到访问表或索引（高效）</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:f9f99610-6d3d-4a67-9389-7be2a4142bb1" class="outline-5">
<h5 id="h:f9f99610-6d3d-4a67-9389-7be2a4142bb1">Order by 子句</h5>
<div class="outline-text-5" id="text-h:f9f99610-6d3d-4a67-9389-7be2a4142bb1">
<p>
对查询结果进行排序，可以升序ASC、降序DESC。默认不填为升序。
</p>

<p>
先以按照第一字段排序，第一字段相同再以第二字段排序。
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#21319;&#24207;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">WHERE</span> emp_no <span style="color: #a020f0;">in</span> (10001, 10002, 10010) <span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span> emp_no;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#38477;&#24207;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">WHERE</span> emp_no <span style="color: #a020f0;">in</span> (10001, 10002, 10010) <span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span> emp_no <span style="color: #a020f0;">DESC</span>

<span style="color: #b22222;">-- </span><span style="color: #b22222;">OROER BY &#20808;&#25191;&#34892;&#65292;&#22312;&#25191;&#34892; LIMIT</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">WHERE</span> emp_no <span style="color: #a020f0;">in</span> (10001, 10002, 10010) 
 <span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span> birth_date, emp_no <span style="color: #a020f0;">DESC</span> <span style="color: #a020f0;">LIMIT</span> 1, 2;  <span style="color: #b22222;">-- </span><span style="color: #b22222;">&#20197;&#36825;2&#20010;&#23383;&#27573;&#25490;&#24207;&#65292;&#20854;&#20013;&#20197;birth_date&#21319;&#24207;&#65292;emp_no &#38477;&#24207;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:44ff964c-7b09-4c6c-b9e2-8b2c73e381b2" class="outline-5">
<h5 id="h:44ff964c-7b09-4c6c-b9e2-8b2c73e381b2">DISTINCT</h5>
<div class="outline-text-5" id="text-h:44ff964c-7b09-4c6c-b9e2-8b2c73e381b2">
<p>
不返回重复记录，去重。
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> <span style="color: #a020f0;">DISTINCT</span> dept_no <span style="color: #a020f0;">FROM</span> dept_emp;

<span style="color: #a020f0;">SELECT</span> <span style="color: #a020f0;">DISTINCT</span> emp_no <span style="color: #a020f0;">FROM</span> dept_emp;

<span style="color: #a020f0;">SELECT</span> dept_no,emp_no <span style="color: #a020f0;">FROM</span> dept_emp;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#20250;&#23558;dept_no&#19982;emp_no&#30475;&#25104;&#20108;&#20803;&#31062;&#26469;&#31579;&#36873;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:bf1eec57-c4a7-48aa-9679-fc7666f643b7" class="outline-5">
<h5 id="h:bf1eec57-c4a7-48aa-9679-fc7666f643b7">聚合函数</h5>
<div class="outline-text-5" id="text-h:bf1eec57-c4a7-48aa-9679-fc7666f643b7">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">函数</th>
<th scope="col" class="org-left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">COUNT(expr)</td>
<td class="org-left">返回记录中记录的数目，如果指定列，则返回非NULL值的行数</td>
</tr>

<tr>
<td class="org-left">COUNT(DISTINCT expr,[expr…])</td>
<td class="org-left">返回不重复的非NULL值的行数</td>
</tr>

<tr>
<td class="org-left">AVG([DISTINCT] expr)</td>
<td class="org-left">返回平均值，返回不同值的平均值</td>
</tr>

<tr>
<td class="org-left">MIN(expr), MAX(expr)</td>
<td class="org-left">最小值，最大值</td>
</tr>

<tr>
<td class="org-left">SUM([DISTINCT] expr)</td>
<td class="org-left">求和，Distinct返回不同值求和</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#32858;&#21512;&#20026;&#19968;&#34892;</span>
<span style="color: #a020f0;">SELECT</span> <span style="color: #483d8b;">COUNT</span>(*), <span style="color: #483d8b;">AVG</span>(emp_no), <span style="color: #483d8b;">sum</span>(emp_no), <span style="color: #483d8b;">min</span>(emp_no), <span style="color: #483d8b;">max</span>(emp_no) <span style="color: #a020f0;">FROM</span> employees;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">mysql&gt; SELECT COUNT(*), AVG(emp_no), sum(emp_no), min(emp_no), max(emp_no) FROM employees;
+----------+-------------+-------------+-------------+-------------+
| COUNT(*) | AVG(emp_no) | sum(emp_no) | min(emp_no) | max(emp_no) |
+----------+-------------+-------------+-------------+-------------+
|       20 |  10010.5000 |      200210 |       10001 |       10020 |
+----------+-------------+-------------+-------------+-------------+
</pre>
</div>
</div>
</div>
<div id="outline-container-h:9911e0a4-78ec-44b9-9b1b-35eeef3eecc2" class="outline-5">
<h5 id="h:9911e0a4-78ec-44b9-9b1b-35eeef3eecc2">分组查询</h5>
<div class="outline-text-5" id="text-h:9911e0a4-78ec-44b9-9b1b-35eeef3eecc2">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> emp_no, <span style="color: #483d8b;">COUNT</span>( emp_no ), <span style="color: #483d8b;">sum</span>( emp_no ), <span style="color: #483d8b;">avg</span>( emp_no ) <span style="color: #a020f0;">AS</span> sal_avg 
  <span style="color: #a020f0;">FROM</span> employees  <span style="color: #a020f0;">WHERE</span> emp_no &gt; 10001 
  <span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span> emp_no <span style="color: #a020f0;">HAVING</span> sal_avg &gt; 10005
  <span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span> sal_avg <span style="color: #a020f0;">DESC</span> <span style="color: #a020f0;">LIMIT</span> 1;
</pre>
</div>

<p>
执行顺序 ：where &gt; HAVING &gt; select &gt; GROUP BY &gt; HAVING &gt; ORDER BY
</p>



<p>
原表
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">Table structure for salaries</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">IF</span> <span style="color: #a020f0;">EXISTS</span> `salaries`;
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `salaries` (
  `emp_no` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `salary` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `from_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `to_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`emp_no`,`from_date`),
  <span style="color: #a020f0;">CONSTRAINT</span> `salaries_ibfk_1` <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`emp_no`) <span style="color: #a020f0;">REFERENCES</span> `employees` (`emp_no`) <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">CASCADE</span>
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">Records of salaries</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">----------------------------</span>
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'60117'</span>, <span style="color: #8b2252;">'1986-06-26'</span>, <span style="color: #8b2252;">'1987-06-26'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'62102'</span>, <span style="color: #8b2252;">'1987-06-26'</span>, <span style="color: #8b2252;">'1988-06-25'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'66074'</span>, <span style="color: #8b2252;">'1988-06-25'</span>, <span style="color: #8b2252;">'1989-06-25'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'66596'</span>, <span style="color: #8b2252;">'1989-06-25'</span>, <span style="color: #8b2252;">'1990-06-25'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'66961'</span>, <span style="color: #8b2252;">'1990-06-25'</span>, <span style="color: #8b2252;">'1991-06-25'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'71046'</span>, <span style="color: #8b2252;">'1991-06-25'</span>, <span style="color: #8b2252;">'1992-06-24'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'74333'</span>, <span style="color: #8b2252;">'1992-06-24'</span>, <span style="color: #8b2252;">'1993-06-24'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'75286'</span>, <span style="color: #8b2252;">'1993-06-24'</span>, <span style="color: #8b2252;">'1994-06-24'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'75994'</span>, <span style="color: #8b2252;">'1994-06-24'</span>, <span style="color: #8b2252;">'1995-06-24'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'76884'</span>, <span style="color: #8b2252;">'1995-06-24'</span>, <span style="color: #8b2252;">'1996-06-23'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'80013'</span>, <span style="color: #8b2252;">'1996-06-23'</span>, <span style="color: #8b2252;">'1997-06-23'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'81025'</span>, <span style="color: #8b2252;">'1997-06-23'</span>, <span style="color: #8b2252;">'1998-06-23'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'81097'</span>, <span style="color: #8b2252;">'1998-06-23'</span>, <span style="color: #8b2252;">'1999-06-23'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'84917'</span>, <span style="color: #8b2252;">'1999-06-23'</span>, <span style="color: #8b2252;">'2000-06-22'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'85112'</span>, <span style="color: #8b2252;">'2000-06-22'</span>, <span style="color: #8b2252;">'2001-06-22'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'85097'</span>, <span style="color: #8b2252;">'2001-06-22'</span>, <span style="color: #8b2252;">'2002-06-22'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10001'</span>, <span style="color: #8b2252;">'88958'</span>, <span style="color: #8b2252;">'2002-06-22'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10002'</span>, <span style="color: #8b2252;">'65828'</span>, <span style="color: #8b2252;">'1996-08-03'</span>, <span style="color: #8b2252;">'1997-08-03'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10002'</span>, <span style="color: #8b2252;">'65909'</span>, <span style="color: #8b2252;">'1997-08-03'</span>, <span style="color: #8b2252;">'1998-08-03'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10002'</span>, <span style="color: #8b2252;">'67534'</span>, <span style="color: #8b2252;">'1998-08-03'</span>, <span style="color: #8b2252;">'1999-08-03'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10002'</span>, <span style="color: #8b2252;">'69366'</span>, <span style="color: #8b2252;">'1999-08-03'</span>, <span style="color: #8b2252;">'2000-08-02'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10002'</span>, <span style="color: #8b2252;">'71963'</span>, <span style="color: #8b2252;">'2000-08-02'</span>, <span style="color: #8b2252;">'2001-08-02'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10002'</span>, <span style="color: #8b2252;">'72527'</span>, <span style="color: #8b2252;">'2001-08-02'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'40006'</span>, <span style="color: #8b2252;">'1995-12-03'</span>, <span style="color: #8b2252;">'1996-12-02'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'43616'</span>, <span style="color: #8b2252;">'1996-12-02'</span>, <span style="color: #8b2252;">'1997-12-02'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'43466'</span>, <span style="color: #8b2252;">'1997-12-02'</span>, <span style="color: #8b2252;">'1998-12-02'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'43636'</span>, <span style="color: #8b2252;">'1998-12-02'</span>, <span style="color: #8b2252;">'1999-12-02'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'43478'</span>, <span style="color: #8b2252;">'1999-12-02'</span>, <span style="color: #8b2252;">'2000-12-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'43699'</span>, <span style="color: #8b2252;">'2000-12-01'</span>, <span style="color: #8b2252;">'2001-12-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10003'</span>, <span style="color: #8b2252;">'43311'</span>, <span style="color: #8b2252;">'2001-12-01'</span>, <span style="color: #8b2252;">'9999-01-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'40054'</span>, <span style="color: #8b2252;">'1986-12-01'</span>, <span style="color: #8b2252;">'1987-12-01'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'42283'</span>, <span style="color: #8b2252;">'1987-12-01'</span>, <span style="color: #8b2252;">'1988-11-30'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'42542'</span>, <span style="color: #8b2252;">'1988-11-30'</span>, <span style="color: #8b2252;">'1989-11-30'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'46065'</span>, <span style="color: #8b2252;">'1989-11-30'</span>, <span style="color: #8b2252;">'1990-11-30'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'48271'</span>, <span style="color: #8b2252;">'1990-11-30'</span>, <span style="color: #8b2252;">'1991-11-30'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'50594'</span>, <span style="color: #8b2252;">'1991-11-30'</span>, <span style="color: #8b2252;">'1992-11-29'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'52119'</span>, <span style="color: #8b2252;">'1992-11-29'</span>, <span style="color: #8b2252;">'1993-11-29'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'54693'</span>, <span style="color: #8b2252;">'1993-11-29'</span>, <span style="color: #8b2252;">'1994-11-29'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'58326'</span>, <span style="color: #8b2252;">'1994-11-29'</span>, <span style="color: #8b2252;">'1995-11-29'</span>);
<span style="color: #a020f0;">INSERT</span> <span style="color: #a020f0;">INTO</span> `salaries` <span style="color: #a020f0;">VALUES</span> (<span style="color: #8b2252;">'10004'</span>, <span style="color: #8b2252;">'60770'</span>, <span style="color: #8b2252;">'1995-11-29'</span>, <span style="color: #8b2252;">'1996-11-28'</span>);
</pre>
</div>

<p>
使用Group by子句，如果有条件，使用Having子句过滤分组、聚合过的结果
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#32858;&#21512;&#25152;&#26377;</span>
<span style="color: #a020f0;">SELECT</span> <span style="color: #483d8b;">SUM</span>(salary), <span style="color: #483d8b;">avg</span>(salary), <span style="color: #483d8b;">count</span>(emp_no) <span style="color: #a020f0;">from</span> salaries;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#32858;&#21512;&#34987;&#36873;&#25321;&#30340;&#35760;&#24405;</span>
<span style="color: #a020f0;">SELECT</span> <span style="color: #483d8b;">SUM</span>(salary), <span style="color: #483d8b;">avg</span>(salary), <span style="color: #483d8b;">count</span>(emp_no) <span style="color: #a020f0;">from</span> salaries <span style="color: #a020f0;">WHERE</span> emp_no &lt; 10003;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#20998;&#32452;</span>
<span style="color: #a020f0;">SELECT</span> emp_no <span style="color: #a020f0;">FROM</span> salaries <span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span> emp_no;
<span style="color: #a020f0;">SELECT</span> emp_no <span style="color: #a020f0;">FROM</span> salaries <span style="color: #a020f0;">WHERE</span> emp_no &lt; 10003 <span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span> emp_no;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#25353;&#29031;&#19981;&#21516;emp_no&#20998;&#32452;&#65292;&#27599;&#32452;&#20998;&#21035;&#32858;&#21512;</span>
<span style="color: #a020f0;">SELECT</span> emp_no, <span style="color: #483d8b;">SUM</span>(salary), <span style="color: #483d8b;">AVG</span>(salary), <span style="color: #483d8b;">count</span>(emp_no) 
  <span style="color: #a020f0;">from</span> salaries <span style="color: #a020f0;">WHERE</span> emp_no &lt; 10003 <span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span> emp_no;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">HAVING&#23376;&#21477;&#23545;&#20998;&#32452;&#32467;&#26524;&#36807;&#28388;</span>
<span style="color: #a020f0;">SELECT</span> emp_no, <span style="color: #483d8b;">SUM</span>(salary), <span style="color: #483d8b;">AVG</span>(salary), <span style="color: #483d8b;">count</span>(emp_no) 
  <span style="color: #a020f0;">from</span> salaries <span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span> emp_no <span style="color: #a020f0;">HAVING</span> <span style="color: #483d8b;">AVG</span>(salary) &gt; 45000 <span style="color: #b22222;">-- </span><span style="color: #b22222;">&#21592;&#24037;&#24179;&#22343;&#24037;&#36164;&#22823;&#20110;45000&#30340;&#26377;&#35841;</span>
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#20351;&#29992;&#21035;&#21517;</span>
<span style="color: #a020f0;">SELECT</span> emp_no, <span style="color: #483d8b;">SUM</span>(salary), <span style="color: #483d8b;">AVG</span>(salary) <span style="color: #a020f0;">as</span> sal_avg, <span style="color: #483d8b;">count</span>(emp_no) 
  <span style="color: #a020f0;">from</span> salaries <span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span> emp_no <span style="color: #a020f0;">HAVING</span> sal_avg &gt; 45000

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#26368;&#21518;&#23545;&#20998;&#32452;&#36807;&#28388;&#21518;&#30340;&#32467;&#26524;&#25490;&#24207;</span>
<span style="color: #a020f0;">SELECT</span> emp_no, <span style="color: #483d8b;">SUM</span>(salary), <span style="color: #483d8b;">AVG</span>(salary) <span style="color: #a020f0;">AS</span> sal_avg, <span style="color: #483d8b;">COUNT</span>(emp_no) 
  <span style="color: #a020f0;">from</span> salaries <span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span> emp_no <span style="color: #a020f0;">HAVING</span> sal_avg &gt; 60000 <span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span> sal_avg; 
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#32858;&#21512;&#25152;&#26377;</span>
mysql&gt; SELECT SUM(salary), avg(salary), count(emp_no) from salaries;
+-------------+-------------+---------------+
| SUM(salary) | avg(salary) | count(emp_no) |
+-------------+-------------+---------------+
|     2491668 |  62291.7000 |            40 |
+-------------+-------------+---------------+

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32858;&#21512;&#34987;&#36873;&#25321;&#30340;&#35760;&#24405;</span>
mysql&gt; SELECT SUM(salary), avg(salary), count(emp_no) from salaries WHERE emp_no &lt; 10003;
+-------------+-------------+---------------+
| SUM(salary) | avg(salary) | count(emp_no) |
+-------------+-------------+---------------+
|     1694739 |  73684.3043 |            23 |
+-------------+-------------+---------------+

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#32452;&#26597;&#35810;</span>
mysql&gt; select emp_no from salaries group by emp_no;
+--------+
| emp_no |
+--------+
|  10001 |
|  10002 |
|  10003 |
|  10004 |
+--------+
mysql&gt; SELECT emp_no FROM salaries WHERE emp_no &lt; 10003 GROUP BY emp_no;
+--------+
| emp_no |
+--------+
|  10001 |
|  10002 |
+--------+

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#25353;&#29031;&#19981;&#21516;emp_no&#20998;&#32452;&#65292;&#27599;&#32452;&#20998;&#21035;&#32858;&#21512;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20998;&#32452;&#19981;&#31649;&#26159;&#21542;&#32858;&#21512;&#65292;&#26368;&#21518;&#27599;&#32452;&#20986;&#19968;&#34892;</span>
mysql&gt; SELECT emp_no,sum(salary) FROM salaries WHERE emp_no<span style="color: #a020f0;"> in</span> (10002,10004) GROUP BY emp_no;
+--------+-------------+
| emp_no | sum(salary) |
+--------+-------------+
|  10002 |      413127 |
|  10004 |      495717 |
+--------+-------------+
mysql&gt; SELECT emp_no, SUM(salary) sum, AVG(salary) avg, count(emp_no) cnt from salaries WHERE emp_no &lt; 10003 GROUP BY emp_no;
+--------+---------+------------+-----+
| emp_no | sum     | avg        | cnt |
+--------+---------+------------+-----+
|  10001 | 1281612 | 75388.9412 |  17 |
|  10002 |  413127 | 68854.5000 |   6 |
+--------+---------+------------+-----+
</pre>
</div>

<p>
分组是将数据按照指定的字段分组，最终每组只能出来一条记录。这就带来了问题，每一组谁做代表，其实谁做代表都不合适。
</p>

<p>
如果只投影分组字段、聚合数据，不会有问题，如果投影非分组字段，显示的时候不能确定是组内谁的数据。
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#20998;&#32452;</span>
<span style="color: #a020f0;">SELECT</span> emp_no, <span style="color: #483d8b;">MAX</span>(salary) <span style="color: #a020f0;">FROM</span> salaries; <span style="color: #b22222;">-- </span><span style="color: #b22222;">10001 88958</span>
<span style="color: #a020f0;">SELECT</span> emp_no, <span style="color: #483d8b;">MIN</span>(salary) <span style="color: #a020f0;">FROM</span> salaries; <span style="color: #b22222;">-- </span><span style="color: #b22222;">10001 40006</span>
</pre>
</div>

<p>
上例很好的说明了使用了聚合函数，虽然没有显式使用Group By语句，但是其实就是把所有记录当做一组，每组只能出一条，那么一组也只能出一条，所以结果就一条。
</p>

<p>
但是emp_no就是非分组字段，那么它就要开始覆盖，所以，显示为10001。当求
最大值的时候，正好工资表中10001的工资最高，感觉是对的。但是，求最小工
资的时候，明明最小工资是10003的40006，由于emp_no不是分组字段，导致最后
被覆盖为10001
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> emp_no, <span style="color: #483d8b;">MIN</span>(salary) <span style="color: #a020f0;">FROM</span> salaries <span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span> emp_no;
</pre>
</div>

<p>
上句才是正确的语义，按照不同员工emp_no工号分组，每一个人一组，每一个人有多个工资记录，按时每组只能按照人头出一条记录。
</p>

<p>
单标较为复杂的语句
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span>
  emp_no,
  <span style="color: #483d8b;">AVG</span>( salary ) <span style="color: #a020f0;">AS</span> avg_sal 
<span style="color: #a020f0;">FROM</span>
  salaries 
<span style="color: #a020f0;">WHERE</span>
  salary &gt; 70000 
<span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span>
  emp_no 
<span style="color: #a020f0;">HAVING</span>
  <span style="color: #483d8b;">avg</span>( salary ) &gt; 50000 
<span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span>
  avg_sal <span style="color: #a020f0;">DESC</span> 
  <span style="color: #a020f0;">LIMIT</span> 1;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e6c0aed0-f56d-4295-a261-4e09b853c91d" class="outline-5">
<h5 id="h:e6c0aed0-f56d-4295-a261-4e09b853c91d">子查询</h5>
<div class="outline-text-5" id="text-h:e6c0aed0-f56d-4295-a261-4e09b853c91d">
<ul class="org-ul">
<li>查询语句可以嵌套，内部查询就是子查询</li>
<li>子查询必须在一组小括号中</li>
<li>子查询中不能使用Order by</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span>
  * 
<span style="color: #a020f0;">FROM</span>
  employees 
<span style="color: #a020f0;">WHERE</span>
  emp_no <span style="color: #a020f0;">IN</span> ( <span style="color: #a020f0;">SELECT</span> emp_no <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">WHERE</span> emp_no &gt; 10015 ) 
<span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span>
  emp_no <span style="color: #a020f0;">DESC</span>;


<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#24403;&#34920;&#29992;</span>
<span style="color: #a020f0;">SELECT</span>
  emp.emp_no,
  emp.first_name,
  gender 
<span style="color: #a020f0;">FROM</span>
  ( <span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">WHERE</span> emp_no &gt; 10015 ) <span style="color: #a020f0;">AS</span> emp 
<span style="color: #a020f0;">WHERE</span>
  emp.emp_no &lt; 10019 
<span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span>
  emp_no <span style="color: #a020f0;">DESC</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1c8cf6c9-c118-464d-a2c8-302008aebfca" class="outline-5">
<h5 id="h:1c8cf6c9-c118-464d-a2c8-302008aebfca">连接jon和联合查询UNION</h5>
<div class="outline-text-5" id="text-h:1c8cf6c9-c118-464d-a2c8-302008aebfca">
<p>
多表查询，即查询结果来自于多张表
</p>

<ul class="org-ul">
<li>子查询：在SQL语句嵌套着查询语句，性能较差，基于某语句的查询结果再次进行的查询</li>
<li>联合查询：UNION</li>
<li>交叉连接：笛卡尔乘积</li>
<li>内连接：
<ul class="org-ul">
<li>等值连接：让表之间的字段以“等值”建立连接关系</li>
<li>不等值连接</li>
<li>自然连接：去掉重复列的等值连接，语法：FROM table NATURAL JOIN table2;</li>
</ul></li>
<li>外连接：
<ul class="org-ul">
<li>左外连接：FROM tb1 LEFT JOIN tb2 ON tb1.col=tb2.col</li>
<li>右外连接：FROM tb1 RIGHT JOIN tb2 ON tb1.col=tb2.col</li>
<li>完全外连接：FROM tb1 FULL OUTER JOIN tb2 ON tb1.col=tb2.col 注意：MySQL不支持此SQL语法</li>
</ul></li>
<li>自连接：本表和本表进行连接查询</li>
</ul>

<p>
交叉连接 cross join
</p>
<ul class="org-ul">
<li>笛卡尔乘积，全部交叉</li>
<li>在MySQL中，CROSS JOIN从语法上说与INNER JOIN等同</li>
</ul>

<p>
Join会构建一张临时表
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#24037;&#36164;40&#34892;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> salaries;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">20&#34892;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">800&#34892;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">CROSS</span> <span style="color: #a020f0;">JOIN</span> salaries;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#38544;&#24335;&#36830;&#25509;&#65292;800&#34892;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees, salaries;
</pre>
</div>

<p>
注意：salaries和employees并没有直接的关系，做笛卡尔乘积只是为了看的清楚。
</p>

<p>
内连接 inner join
</p>
<ul class="org-ul">
<li>可省略为join</li>
<li>等值连接，只选某些field相等的元组（行），使用On限定关联的结果</li>
</ul>
<p>
自然连接，特殊的等值连接，会去掉重复的列。用的少
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#20869;&#36830;&#25509;&#65292;&#31515;&#21345;&#23572;&#20056;&#31215; 800 &#34892;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">JOIN</span> salaries;
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">INNER</span> <span style="color: #a020f0;">JOIN</span> salaries;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">on&#31561;&#20540;&#36830;&#25509; 40&#34892;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">JOIN</span> salaries <span style="color: #a020f0;">ON</span> employees.emp_no = salaries.emp_no;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#33258;&#28982;&#36830;&#25509;&#65292;&#21435;&#25481;&#20102;&#37325;&#22797;&#21015;&#65292;&#19988;&#33258;&#34892;&#20351;&#29992; employees.emp_no = salaries.emp_no&#30340;&#26465;&#20214;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">NATURAL</span> <span style="color: #a020f0;">JOIN</span> salaries;
</pre>
</div>


<p>
外连接 outer join
</p>
<ul class="org-ul">
<li>可以省略为join</li>
<li>分为左外连接，即左连接；右外连接，即右连接；全外连接
<ul class="org-ul">
<li>左连接，左表全部出来向右对应，不对应的右表值为null</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#24038;&#36830;&#25509; &#65288;56&#26465;&#35760;&#24405;&#65289;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">LEFT</span> <span style="color: #a020f0;">JOIN</span> salaries <span style="color: #a020f0;">ON</span> employees.emp_no = salaries.emp_no;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#21491;&#36830;&#25509; &#65288;40 &#26465;&#35760;&#24405;&#65289;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> employees <span style="color: #a020f0;">RIGHT</span> <span style="color: #a020f0;">JOIN</span> salaries <span style="color: #a020f0;">ON</span> employees.emp_no = salaries.emp_no;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#36825;&#20010;&#21491;&#36830;&#25509;&#31561;&#20215;&#20110;&#19978;&#38754;&#30340;&#24038;&#36830;&#25509;&#65288;56&#26465;&#35760;&#24405;&#65289;</span>
<span style="color: #a020f0;">SELECT</span> * <span style="color: #a020f0;">FROM</span> salaries <span style="color: #a020f0;">RIGHT</span> <span style="color: #a020f0;">JOIN</span> employees <span style="color: #a020f0;">ON</span> employees.emp_no = salaries.emp_no;

<span style="color: #a020f0;">SELECT</span>
  employees.*
<span style="color: #a020f0;">FROM</span>
  salaries
  <span style="color: #a020f0;">RIGHT</span> <span style="color: #a020f0;">JOIN</span> employees <span style="color: #a020f0;">ON</span> employees.emp_no = salaries.emp_no 
<span style="color: #a020f0;">WHERE</span>
  salaries.emp_no <span style="color: #a020f0;">IS</span> <span style="color: #a020f0;">NULL</span>
</pre>
</div>

<p>
自连接
</p>
<ul class="org-ul">
<li>表，自己和自己连接</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">select</span> manager.* <span style="color: #a020f0;">from</span> emp manager,emp worker <span style="color: #a020f0;">where</span> 
manaer.empno=worker.mgr <span style="color: #a020f0;">and</span> worker.empno=1;

<span style="color: #a020f0;">select</span> manager.* <span style="color: #a020f0;">from</span> emp manager <span style="color: #a020f0;">inner</span> <span style="color: #a020f0;">join</span> emp 
worker <span style="color: #a020f0;">on</span> manaer.empno=worker.mgr <span style="color: #a020f0;">where</span> worker.empno=1;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">/*</span>
<span style="color: #b22222;">&#20551;&#35774;&#26377;&#34920;manager&#65292;&#23383;&#27573;&#21644;&#35760;&#24405;&#22914;&#19979;</span>
<span style="color: #b22222;">empno  name  mgr</span>
<span style="color: #b22222;">1      tom  </span>
<span style="color: #b22222;">2      jerry 1</span>
<span style="color: #b22222;">3      ben   2</span>
<span style="color: #b22222;">*/</span>

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#26377;&#39046;&#23548;&#30340;&#21592;&#24037;</span>
<span style="color: #a020f0;">select</span> * <span style="color: #a020f0;">from</span> manager <span style="color: #a020f0;">where</span> mgr <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">null</span>

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#25152;&#26377;&#26377;&#39046;&#23548;&#30340;&#21592;&#24037;&#21450;&#39046;&#23548;&#21517;&#23383;</span>
<span style="color: #a020f0;">select</span> worker.*, mgr.<span style="color: #a020f0;">name</span> <span style="color: #a020f0;">from</span> manager worker <span style="color: #a020f0;">INNER</span> <span style="color: #a020f0;">JOIN</span> manager mgr <span style="color: #a020f0;">ON</span> mgr.id = worker.mgr
</pre>
</div>

<p>
联合查询：UNION
</p>
<ul class="org-ul">
<li>联合查询 Union 实现的条件，多个表的字段数量相同，字段名和数据类型可以 不同，但一般数据类型是相同的。</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> <span style="color: #a020f0;">Name</span>,Age <span style="color: #a020f0;">FROM</span> students <span style="color: #a020f0;">UNION</span> <span style="color: #a020f0;">SELECT</span> <span style="color: #a020f0;">Name</span>,Age <span style="color: #a020f0;">FROM</span> teachers;
</pre>
</div>
<p>
union 去重 union all 重复字段也会显示
</p>
</div>
</div>
</div>
</div>
</section>
<section id="outline-container-h:f44ddcac-94b1-4453-a83b-dac338b639a6" class="outline-2">
<h2 id="h:f44ddcac-94b1-4453-a83b-dac338b639a6">事务和锁</h2>
<div class="outline-text-2" id="text-h:f44ddcac-94b1-4453-a83b-dac338b639a6">
</div>
<div id="outline-container-h:0b197878-5979-4826-ae31-5cd06be2c072" class="outline-3">
<h3 id="h:0b197878-5979-4826-ae31-5cd06be2c072">事务Transaction</h3>
<div class="outline-text-3" id="text-h:0b197878-5979-4826-ae31-5cd06be2c072">
<p>
InnoDB引擎，支持事务。
</p>

<p>
事务: 由若干条语句组成的，指的是要做的一系列操作。
</p>

<p>
关系型数据库中支持事务，必须支持其四个属性（ACID）：
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">特性</th>
<th scope="col" class="org-left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">原子性（atomicity）</td>
<td class="org-left">一个事务是一个不可分割的工作单位，事务中包括的所有操作要么全部做完，要么什么都不做</td>
</tr>

<tr>
<td class="org-left">一致性（consistency）</td>
<td class="org-left">事务必须是使数据库从一个一致性状态变到另一个一致性状态。一致性与原子性是密切相关的</td>
</tr>

<tr>
<td class="org-left">隔离性（isolation）</td>
<td class="org-left">一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰</td>
</tr>

<tr>
<td class="org-left">持久性（durability）</td>
<td class="org-left">持久性也称永久性（permanence），指一个事务一旦提交，它对数据库中数据的改变就应该是永久性的。接下来的其他操作或故障不应该对其有任何影响</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>原子性，要求事务中的所有操作，不可分割，不能做了一部分操作，还剩一部分操作</li>
<li>一致性，多个事务并行执行的结果，应该和事务排队执行的结果一致。如果事务的并行执行和多线程读写共享资源一样不可预期，就不能保证一致性</li>
<li>隔离性，就是指多个事务访问共同的数据了，应该互不干扰。隔离性，指的是究竟在一个事务处理期间，其他事务能不能访问的问题</li>
<li>持久性，比较好理解，就是事务提交后，数据不能丢失</li>
</ul>
</div>
<div id="outline-container-h:6baee312-cf70-4939-a4bb-0e1d8e1becf8" class="outline-4">
<h4 id="h:6baee312-cf70-4939-a4bb-0e1d8e1becf8">MySQL隔离级别</h4>
<div class="outline-text-4" id="text-h:6baee312-cf70-4939-a4bb-0e1d8e1becf8">
<p>
隔离性不好，事务的操作就会互相影响，带来不同严重程度的后果。
</p>

<p>
首先看看隔离性不好，带来哪些问题：
</p>
<ol class="org-ol">
<li><p>
更新丢失Lost Update
</p>

<p>
事务A和B，更新同一个数据，它们都读取了初始值100，A要减10，B要加100，A减去10后更新为90，B加100更新为200，A的更新丢失了，就像从来没有减过10一样。
</p></li>

<li><p>
脏读
</p>

<p>
事务A和B，事务B读取到了事务A未提交的数据（这个数据可能是一个中间值，也可能事务A后来回滚事务）。事务A是否最后提交并不关心。只要读取到了这个被修改的数据就是脏读。
</p></li>

<li><p>
不可重复读Unrepeatable read
</p>

<p>
事务A在事务执行中相同查询语句，得到了不同的结果，不能保证同一条查询语句重复读相同的结果就是不可以重复读。
</p>

<p>
例如，事务A查询了一次后，事务B修改了数据，事务A又查询了一次，发现数据不一致了。
</p>

<p>
注意，脏读讲的是可以读到相同的数据的，但是读取的是一个未提交的数据，而不是提交的最终结果。
</p></li>

<li><p>
幻读Phantom read
</p>

<p>
事务A中同一个查询要进行多次，事务B插入数据，导致A返回不同的结果集，如同幻觉，就是幻读。
</p>

<p>
数据集有记录增加了，可以看做是增加了记录的不可重复读。
</p></li>
</ol>

<p>
有了上述问题，数据库就必须要解决，提出了隔离级别。
</p>

<p>
隔离级别由低到高，如下表
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">隔离级别</th>
<th scope="col" class="org-left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">READ UNCOMMITTED</td>
<td class="org-left">读取到未提交的数据</td>
</tr>

<tr>
<td class="org-left">READ COMMITTED</td>
<td class="org-left">读已经提交的数据，ORACLE默认隔离级别</td>
</tr>

<tr>
<td class="org-left">REPEATABLE READ</td>
<td class="org-left">可以重复读，MySQL的 默认隔离级别</td>
</tr>

<tr>
<td class="org-left">SERIALIZABLE</td>
<td class="org-left">可串行化。事务间完全隔离，事务不能并发，只能串行执行</td>
</tr>
</tbody>
</table>

<p>
隔离级别越高，串行化越高，数据库执行效率低；隔离级别越低，并行度越高，性能越高。
</p>

<p>
隔离级别越高，当前事务处理的中间结果对其它事务不可见程度越高。
</p>

<ul class="org-ul">
<li>SERIALIZABLE,串行了,解决所有问题</li>
<li><p>
REPEATABLE READ,事务A中同一条查询语句返回同样的结果,就是可以重复读数据了。例如语句为(select * from user)。解决的办法有:
</p>

<p>
1、对select的数据加锁,不允许其它事务删除、修改的操作
</p>

<p>
2、第一次select的时候,对最后一次确切提交的事务的结果做快照
</p>

<p>
解决了不可以重复读,但是仍有可能出现幻读。例如,事务A事务B开启,事务A中增加了一条数
据并提交,事务B反复查询看不到新的数据,但是可以使用updaate语句更新成功,再查询就看到
了。这也是幻读，如同出现了幻觉。
</p></li>
<li>READ COMMITTED,在事务中,每次select可以读到别的事务刚提交成功的新的数
据。因为读到的是提交后的数据,解决了脏读,但是不能解决不可重复读和幻读
的问题。因为其他事务前后修改了数据或增删了数据。</li>
<li>READ UNCOMMITTED,能读取到别的事务还没有提交的数据,完全没有隔离性可言,出现了脏读,当前其他问题都可能出现。</li>
</ul>
</div>
</div>
<div id="outline-container-h:0ad2dd2b-493b-408f-98c1-a3121d45fc11" class="outline-4">
<h4 id="h:0ad2dd2b-493b-408f-98c1-a3121d45fc11">事务语法</h4>
<div class="outline-text-4" id="text-h:0ad2dd2b-493b-408f-98c1-a3121d45fc11">
<p>
START TRANSACTION或BEGIN开始一个事务，START TRANSACTION是标准SQL的语法。
</p>

<p>
使用COMMIT提交事务后，变更成为永久变更。
</p>

<p>
ROLLBACK可以在提交事务之前，回滚变更，事务中的操作就如同没有发生过一样（原子性）。
</p>

<p>
SET AUTOCOMMIT语句可以禁用或启用默认的autocommit模式，用于当前连接。
SET AUTOCOMMIT = 0禁用自动提交事务。如果开启自动提交，如果有一个修改表
的语句执行后，会立即把更新存储到磁盘。
</p>


<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#35774;&#32622;&#20250;&#35805;&#32423;&#25110;&#32773;&#20840;&#23616;&#38548;&#31163;&#32423;&#21035;</span>
<span style="color: #a020f0;">SET</span> [<span style="color: #a020f0;">SESSION</span> | <span style="color: #a020f0;">GLOBAL</span>] <span style="color: #a020f0;">TRANSACTION</span> <span style="color: #a020f0;">ISOLATION</span> <span style="color: #a020f0;">LEVEL</span>
{<span style="color: #a020f0;">READ</span> <span style="color: #a020f0;">UNCOMMITTED</span> | <span style="color: #a020f0;">READ</span> <span style="color: #a020f0;">COMMITTED</span> | <span style="color: #a020f0;">REPEATABLE</span> <span style="color: #a020f0;">READ</span> | <span style="color: #a020f0;">SERIALIZABLE</span>}

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#26597;&#35810;&#38548;&#31163;&#32423;&#21035;</span>
<span style="color: #a020f0;">SELECT</span> @@<span style="color: #a020f0;">global</span>.tx_isolation;
<span style="color: #a020f0;">SELECT</span> @@tx_isolation;

<span style="color: #a020f0;">SET</span> <span style="color: #a020f0;">SESSION</span> <span style="color: #a020f0;">TRANSACTION</span> <span style="color: #a020f0;">ISOLATION</span> <span style="color: #a020f0;">LEVEL</span> <span style="color: #a020f0;">READ</span> <span style="color: #a020f0;">COMMITTED</span>;
<span style="color: #a020f0;">SET</span> <span style="color: #a020f0;">SESSION</span> <span style="color: #a020f0;">TRANSACTION</span> <span style="color: #a020f0;">ISOLATION</span> <span style="color: #a020f0;">LEVEL</span> <span style="color: #a020f0;">REPEATABLE</span> <span style="color: #a020f0;">READ</span>;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31105;&#29992;&#33258;&#21160;&#25552;&#20132;</span>
<span style="color: #a020f0;">SET</span> AUTOCOMMIT = 0
</pre>
</div>

<p>
范例：测试默认隔离级别 REPEATABLE-READ
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;2&#20010;&#31383;&#21475;, &#20851;&#38381;&#33258;&#21160;&#25552;&#20132;</span>
<span style="color: #483d8b;">set</span> <span style="color: #a0522d;">autocommit</span>=0;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#20250;&#35805;&#30340;&#38548;&#31163;&#32423;&#21035;</span>
mysql&gt; select @@transaction_isolation;  <span style="color: #b22222;">#</span><span style="color: #b22222;">8.0</span>
+-------------------------+
| @@transaction_isolation |
+-------------------------+
| REPEATABLE-READ         |
+-------------------------+
1 row<span style="color: #a020f0;"> in</span> set (0.00 sec)


<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31383;&#21475;1 &#20462;&#25913;</span>
mysql&gt; update reg set <span style="color: #a0522d;">password</span>=<span style="color: #8b2252;">'123'</span> where id = 101;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql&gt; select * from reg;
+-----+-------+-----------+----------+
| id  | name  | loginname | password |
+-----+-------+-----------+----------+
|   1 | tom   | tom       | tom      |
|   2 | jerry | jerry     | jerry    |
| 100 | benny | benny     | benpwd   |
| 101 | sam   | sam       | 123      |
+-----+-------+-----------+----------+
4 rows<span style="color: #a020f0;"> in</span> set (0.00 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31383;&#21475;2, &#30475;&#21040;&#36824;&#26159;&#20043;&#21069;&#30340;&#20107;&#21153;</span>
mysql&gt; select * from reg;
+-----+-------+-----------+----------+
| id  | name  | loginname | password |
+-----+-------+-----------+----------+
|   1 | tom   | tom       | tom      |
|   2 | jerry | jerry     | jerry    |
| 100 | benny | benny     | benpwd   |
| 101 | sam   | sam       | sampwd   |
+-----+-------+-----------+----------+

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31383;&#21475;1&#65292;&#25552;&#20132;&#20107;&#21153;</span>
mysql&gt; commit;
Query OK, 0 rows affected (0.01 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31383;&#21475;2&#65292;&#26597;&#30475;&#34920;&#65292;&#20294;&#20173;&#28982;&#30475;&#19981;&#21040;&#12290;&#22240;&#20026;&#38548;&#31163;&#32423;&#21035;REPEATABLE READ&#65292;&#21487;&#20197;&#37325;&#22797;&#35835;</span>
mysql&gt; select * from reg;
+-----+-------+-----------+----------+
| id  | name  | loginname | password |
+-----+-------+-----------+----------+
|   1 | tom   | tom       | tom      |
|   2 | jerry | jerry     | jerry    |
| 100 | benny | benny     | benpwd   |
| 101 | sam   | sam       | sampwd   |
+-----+-------+-----------+----------+

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20107;&#21153;&#23436;&#25104;&#65292;&#24320;&#21551;&#21478;&#19968;&#20010;&#20107;&#29289;&#12290;&#23601;&#33021;&#30475;&#21040;&#20102;&#12290;</span>
mysql&gt; commit;
Query OK, 0 rows affected (0.01 sec)

mysql&gt; select * from reg;
+-----+-------+-----------+----------+
| id  | name  | loginname | password |
+-----+-------+-----------+----------+
|   1 | tom   | tom       | tom      |
|   2 | jerry | jerry     | jerry    |
| 100 | benny | benny     | benpwd   |
| 101 | sam   | sam       | 123      |
+-----+-------+-----------+----------+
</pre>
</div>


<p>
范例：测试默认隔离级别 READ COMMITTED
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24320;2&#20010;&#31383;&#21475;, &#20851;&#38381;&#33258;&#21160;&#25552;&#20132;</span>
<span style="color: #483d8b;">set</span> <span style="color: #a0522d;">autocommit</span>=0;

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35774;&#32622;&#38548;&#31163;&#32423;&#21035;</span>
<span style="color: #483d8b;">set</span> session transaction isolation level read committed;
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#30475;&#24403;&#21069;&#20250;&#35805;&#30340;&#38548;&#31163;&#32423;&#21035;</span>
mysql&gt; select @@transaction_isolation;  <span style="color: #b22222;">#</span><span style="color: #b22222;">8.0</span>
+-------------------------+
| @@transaction_isolation |
+-------------------------+
| READ-COMMITTED          |
+-------------------------+

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31383;&#21475;1 &#25913;&#21160;</span>
mysql&gt; select * from reg;
+-----+-------+-----------+----------+
| id  | name  | loginname | password |
+-----+-------+-----------+----------+
|   1 | tom   | tom       | tom      |
|   2 | jerry | jerry     | jerry    |
| 100 | benny | benny     | benpwd   |
| 101 | sam   | sam       | 123      |
+-----+-------+-----------+----------+
4 rows<span style="color: #a020f0;"> in</span> set (0.00 sec)

mysql&gt; update reg set <span style="color: #a0522d;">password</span>=<span style="color: #8b2252;">'tompwd'</span> where <span style="color: #a0522d;">id</span>=1;
Query OK, 1 row affected (0.01 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql&gt; select * from reg;
+-----+-------+-----------+----------+
| id  | name  | loginname | password |
+-----+-------+-----------+----------+
|   1 | tom   | tom       | tompwd   |
|   2 | jerry | jerry     | jerry    |
| 100 | benny | benny     | benpwd   |
| 101 | sam   | sam       | 123      |
+-----+-------+-----------+----------+

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31383;&#21475;2&#26597;&#30475;&#65292; &#26080;&#21464;&#21270; </span>
mysql&gt;  select * from reg;
+-----+-------+-----------+----------+
| id  | name  | loginname | password |
+-----+-------+-----------+----------+
|   1 | tom   | tom       | tom      |
|   2 | jerry | jerry     | jerry    |
| 100 | benny | benny     | benpwd   |
| 101 | sam   | sam       | 123      |
+-----+-------+-----------+----------+

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31383;&#21475;1 &#25552;&#20132;&#20107;&#21153;</span>
mysql&gt; commit;
Query OK, 0 rows affected (0.01 sec)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31383;&#21475;2 &#26597;&#35810;&#33021;&#30475;&#21040;&#12290;&#22240;&#20026;&#38548;&#31163;&#32423;&#21035;&#20026;READ COMMITTED &#19981;&#21487;&#20197;&#37325;&#22797;&#35835;&#21040;&#24403;&#21069;&#20107;&#21153;&#25968;&#25454;&#12290;</span>
mysql&gt;  select * from reg;
+-----+-------+-----------+----------+
| id  | name  | loginname | password |
+-----+-------+-----------+----------+
|   1 | tom   | tom       | tompwd   |
|   2 | jerry | jerry     | jerry    |
| 100 | benny | benny     | benpwd   |
| 101 | sam   | sam       | 123      |
+-----+-------+-----------+----------+


</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:2e0609df-eb00-4965-8014-74f8694d5241" class="outline-3">
<h3 id="h:2e0609df-eb00-4965-8014-74f8694d5241">FOR UPDATE 和锁</h3>
<div class="outline-text-3" id="text-h:2e0609df-eb00-4965-8014-74f8694d5241">
<p>
数据库不可避免会发生并发,有人读取,就有人写入,如果读写同一张表、同一条记录,就会有冲突。
</p>
<ul class="org-ul">
<li>读锁,共享锁,多用户同一时刻读取同一个资源,互不干扰</li>
<li>写锁,排他锁,有更高优先级,它会阻塞其它用户对该资源读写操作而使用的读锁或写锁</li>
</ul>

<p>
SELECT&#x2026;For Update会把行进行写锁定,这是排它锁。
</p>

<p>
使用主键明确记录行,那么就对存在的主键的记录使用行级锁。例如id=100
</p>

<p>
使用主键,但不能确定记录,使用表级锁,例如id&lt;&gt;3。
</p>

<p>
条件中不使用主键,会使用表级锁。例如,name='tom'
</p>

<p>
悲观锁,我怕别人在我用的时候抢资源,先锁上,独占。悲观锁往往用在数据库的锁机制中,因为
独占,所以会影响并发。所以,For Update非要使用,请一定要保证时间短,且一定利用行级锁。
</p>

<p>
乐观锁,就是心宽,认为极少冲突,只有写入才加锁。但需要检测数据冲突。
</p>
</div>
</div>
<div id="outline-container-h:096673f8-f781-466c-a360-2fd86dcf4723" class="outline-3">
<h3 id="h:096673f8-f781-466c-a360-2fd86dcf4723">数据仓库和数据库的区别</h3>
<div class="outline-text-3" id="text-h:096673f8-f781-466c-a360-2fd86dcf4723">
<p>
本质上来说没有区别，都是存放数据的地方。
</p>

<ul class="org-ul">
<li>但是数据库关注数据的持久化、数据的关系，为业务系统提供支持，事务支持；</li>
<li>数据仓库存储数据的是为了分析或者发掘而设计的表结构，可以存储海量数据。</li>
</ul>

<p>
数据库存储在线交易数据OLTP（联机事务处理OLTP，On-line Transaction Processing）；数据仓库存储历史数据用于分析OLAP（联机分析处理OLAP，On-Line Analytical Processing）。
</p>

<p>
数据库支持在线业务，需要频繁增删改查；数据仓库一般囤积历史数据支持用于分析的SQL，一般不建议删改。
</p>
</div>
</div>
<div id="outline-container-h:4870a7cd-f32d-4eca-9ed6-52e1362f7180" class="outline-3">
<h3 id="h:4870a7cd-f32d-4eca-9ed6-52e1362f7180">存储过程、触发器</h3>
<div class="outline-text-3" id="text-h:4870a7cd-f32d-4eca-9ed6-52e1362f7180">
<p>
存储过程（Stored Procedure），数据库系统中，一段完成特定功能的SQL语句。编写成类似函数的方式，可以传参并调用。支持流程控制语句。
</p>

<p>
触发器（Trigger），由事件触发的特殊的存储过程，例如insert数据时触发。
</p>

<p>
这两种技术，虽然是数据库高级内容，性能不错，但基本很少用了。
</p>

<p>
它们移植性差，使用时占用的服务器资源，排错、维护不方便。
</p>

<p>
最大的原因，不太建议把逻辑放在数据库中。
</p>
</div>
</div>
<div id="outline-container-h:8c3dce11-cb54-40ca-8f65-7ed2d7e5fe46" class="outline-3">
<h3 id="h:8c3dce11-cb54-40ca-8f65-7ed2d7e5fe46">游标Cursor</h3>
<div class="outline-text-3" id="text-h:8c3dce11-cb54-40ca-8f65-7ed2d7e5fe46">
<p>
操作查询的结果集的一种方法。
</p>

<p>
可以将游标当做一个指针，指向结果集中的某一行。
</p>
</div>
</div>
</section>
<section id="outline-container-h:2cd48672-deb3-494d-85d0-2305ce56c832" class="outline-2">
<h2 id="h:2cd48672-deb3-494d-85d0-2305ce56c832">数据库开发</h2>
<div class="outline-text-2" id="text-h:2cd48672-deb3-494d-85d0-2305ce56c832">
</div>
<div id="outline-container-h:3bc9c77c-bbe8-4c1b-9fed-99f754822a43" class="outline-3">
<h3 id="h:3bc9c77c-bbe8-4c1b-9fed-99f754822a43">驱动</h3>
<div class="outline-text-3" id="text-h:3bc9c77c-bbe8-4c1b-9fed-99f754822a43">
<p>
与MySQL通信就是典型的CS模式。Server就是服务端，使用客户端先建立连接，数据库编程时，
这个客户端变成了程序。
</p>

<p>
MySQL基于TCP协议之上开发，传输的数据必须遵循MySQL的协议。封装好MySQL协议的包，就是驱动程序。
</p>

<p>
MySQL的驱动
</p>
<ul class="org-ul">
<li>MySQLdb: 最有名的库。对MySQL的C Client封装实现，支持Python 2，不更新了，不支持Python3</li>
<li>mysqlclient: 在MySQLdb的基础上，增加了Python 3 的支。<a href="https://github.com/PyMySQL/mysqlclient">https://github.com/PyMySQL/mysqlclient</a></li>
<li>MySQL官方Connector: Mysql官网 <a href="https://dev.mysql.com/downloads/connector/">https://dev.mysql.com/downloads/connector/</a></li>
<li>pymysql: 语法兼容MySQLdb，使用Python写的库，支持Python 3. <a href="https://github.com/PyMySQL/PyMySQL">https://github.com/PyMySQL/PyMySQL</a></li>
</ul>
</div>
</div>
<div id="outline-container-h:0e01b15f-84ab-43bb-b89b-a0724bdaaa1b" class="outline-3">
<h3 id="h:0e01b15f-84ab-43bb-b89b-a0724bdaaa1b">pymysql使用</h3>
<div class="outline-text-3" id="text-h:0e01b15f-84ab-43bb-b89b-a0724bdaaa1b">
</div>
<div id="outline-container-h:b8257dee-e871-4da4-b663-28a87f9b1277" class="outline-4">
<h4 id="h:b8257dee-e871-4da4-b663-28a87f9b1277">安装</h4>
<div class="outline-text-4" id="text-h:b8257dee-e871-4da4-b663-28a87f9b1277">
<div class="org-src-container">
<pre class="src src-sh">pip install pymysql
pip install simplejson

<span style="color: #b22222;">#</span><span style="color: #b22222;">MySQL 8.0+ &#40664;&#35748;&#20351;&#29992; caching_sha2_password &#35748;&#35777;&#25554;&#20214;&#65292;&#35813;&#25554;&#20214;&#38656;&#35201; cryptography &#22788;&#29702;&#21152;&#23494;&#12290;</span>
pip install cryptography
</pre>
</div>

<p>
simplejson库处理json文件方便。
</p>
</div>
</div>
<div id="outline-container-h:7da9487d-9906-4b15-b61f-1cbcb99b11af" class="outline-4">
<h4 id="h:7da9487d-9906-4b15-b61f-1cbcb99b11af">创建数据库和表</h4>
<div class="outline-text-4" id="text-h:7da9487d-9906-4b15-b61f-1cbcb99b11af">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> DATABASE IF <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">EXISTS</span> school;
SHOW DATABASES;
USE school;

<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `student` (
  `id` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> AUTO_INCREMENT,
  `<span style="color: #a020f0;">name</span>` <span style="color: #228b22;">varchar</span>(30) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `age` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">DEFAULT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`id`)
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8;
</pre>
</div>

<p>
import pymysql
</p>

<p>
IP = '192.168.1.6'
USERNAME = 'lqx'
PASSWORD = 'lqx'
DBNAME ='test'
PORT = 3306
</p>

<p>
conn = None
currsor = None # 对结果集的操作
try:
    conn = pymysql.connect(IP, USERNAME, PASSWORD, DBNAME, PORT)
    currsor = conn.cursor()
</p>

<p>
sql = "CREATE TABLE `student` (" \
      "`id` int(11) NOT NULL AUTO_INCREMENT," \
      "`name` varchar(30) NOT NULL," \
      "`age` int(11) DEFAULT NULL," \
      "PRIMARY KEY (`id`)" \
      ") ENGINE=InnoDB DEFAULT CHARSET=utf8;"
</p>

<p>
r = currsor.execute(sql)
print(r)
</p>

<p>
    conn.commit()
except:
    conn.rollback()
    print('roll back')
finally:
    if currsor:
        currsor.close()
    if conn:
        conn.close()
</p>
</div>
</div>
<div id="outline-container-h:f7b6ea0e-8c6f-4c05-a6e7-c9b47fa46459" class="outline-4">
<h4 id="h:f7b6ea0e-8c6f-4c05-a6e7-c9b47fa46459">连接Connect</h4>
<div class="outline-text-4" id="text-h:f7b6ea0e-8c6f-4c05-a6e7-c9b47fa46459">
<p>
首先，必须建立一个传输数据通加粗样式道——连接。
</p>
<ul class="org-ul">
<li>pymysql.connect()方法返回的是Connections模块下的Connection类实例</li>
<li>connect方法传参就是给Connection类的 <span class="underline"><span class="underline">init</span></span> 提供参数</li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Connection初始化常用参数</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">host</td>
<td class="org-left">主机</td>
</tr>

<tr>
<td class="org-left">user</td>
<td class="org-left">用户名</td>
</tr>

<tr>
<td class="org-left">password</td>
<td class="org-left">密码</td>
</tr>

<tr>
<td class="org-left">database</td>
<td class="org-left">数据库</td>
</tr>

<tr>
<td class="org-left">port</td>
<td class="org-left">端口</td>
</tr>
</tbody>
</table>

<p>
Connection.ping()方法，测试数据库服务器是否活着。有一个参数reconnect表示断开与服务器连接是否重连。连接关闭抛出异常
</p>

<p>
范例：
</p>

<p>
创建配置文件 config.json
</p>
<div class="org-src-container">
<pre class="src src-sh">{
  <span style="color: #8b2252;">"host"</span>: <span style="color: #8b2252;">"192.168.226.128"</span>,
  <span style="color: #8b2252;">"password"</span>: <span style="color: #8b2252;">"123456"</span>,
  <span style="color: #8b2252;">"database"</span>: <span style="color: #8b2252;">"test"</span>,
  <span style="color: #8b2252;">"user"</span>: <span style="color: #8b2252;">"root"</span>,
  <span style="color: #8b2252;">"port"</span>: 3306
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pymysql
<span style="color: #a020f0;">import</span> simplejson <span style="color: #b22222;">#</span><span style="color: #b22222;">pip install simplejson</span>
<span style="color: #a020f0;">import</span> os

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(os.path.join(os.path.dirname(__file__), <span style="color: #8b2252;">'config.json'</span>)) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">conf</span> = simplejson.load(f)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21453;&#24207;&#21015;&#21270;&#65292;&#23383;&#20856;</span>
<span style="color: #483d8b;">print</span>(conf)

<span style="color: #b22222;">#</span><span style="color: #b22222;">connection #&#20174;&#37197;&#32622;&#25991;&#20214;&#26469;. ini, json</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">user = None, password = "",host = None,database = None,port = 0,</span>
<span style="color: #a0522d;">conn</span> = <span style="color: #008b8b;">None</span>
<span style="color: #a020f0;">try</span>:
    <span style="color: #a0522d;">conn</span> = pymysql.connect(**conf)
    conn.ping(<span style="color: #008b8b;">False</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">ping&#19981;&#36890;&#21017;&#25243;&#24322;&#24120;</span>
    <span style="color: #483d8b;">print</span>(conn)
<span style="color: #a020f0;">finally</span>:
    <span style="color: #a020f0;">if</span> conn:
        conn.close()
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">{<span style="color: #8b2252;">'host'</span>: <span style="color: #8b2252;">'192.168.226.128'</span>, <span style="color: #8b2252;">'password'</span>: <span style="color: #8b2252;">'123456'</span>, <span style="color: #8b2252;">'database'</span>: <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'user'</span>: <span style="color: #8b2252;">'root'</span>, <span style="color: #8b2252;">'port'</span>: 3306}
&lt;pymysql.connections.Connection object at 0x0000015C3DE72270&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b086239c-886b-42b2-88df-9e9a8103c4ad" class="outline-4">
<h4 id="h:b086239c-886b-42b2-88df-9e9a8103c4ad">游标Cursor</h4>
<div class="outline-text-4" id="text-h:b086239c-886b-42b2-88df-9e9a8103c4ad">
<p>
操作数据库，必须使用游标，需要先获取一个游标对象。
</p>

<p>
Connection.cursor(cursor=None) 方法返回一个新的游标对。
</p>

<p>
连接没有关闭前，游标对象可以反复使用。
</p>

<p>
cursor参数，可以指定一个Cursor类。如果为None，则使用默认Cursor类。
</p>

<p>
Cursor类的实例，提供execute() 方法，执行SQL语句，成功返回影响的行数。
</p>
</div>
</div>
<div id="outline-container-h:ca053344-96f4-46d6-9cbd-df2d6a635a9a" class="outline-4">
<h4 id="h:ca053344-96f4-46d6-9cbd-df2d6a635a9a">新增记录</h4>
<div class="outline-text-4" id="text-h:ca053344-96f4-46d6-9cbd-df2d6a635a9a">
<p>
使用insert into语句插入数据
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pymysql
<span style="color: #a020f0;">import</span> simplejson <span style="color: #b22222;">#</span><span style="color: #b22222;">pip install simplejson</span>
<span style="color: #a020f0;">import</span> os

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(os.path.join(os.path.dirname(__file__), <span style="color: #8b2252;">'config.json'</span>)) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">conf</span> = simplejson.load(f)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21453;&#24207;&#21015;&#21270;&#65292;&#23383;&#20856;</span>
<span style="color: #483d8b;">print</span>(conf)

<span style="color: #b22222;">#</span><span style="color: #b22222;">connection #&#20174;&#37197;&#32622;&#25991;&#20214;&#26469;. ini, json</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">user = None, password = "",host = None,database = None,port = 0,</span>
<span style="color: #a0522d;">conn</span> = <span style="color: #008b8b;">None</span>
<span style="color: #a0522d;">cursor</span> = <span style="color: #008b8b;">None</span>
<span style="color: #a020f0;">try</span>:
    <span style="color: #a0522d;">conn</span> = pymysql.connect(**conf)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">cursor &#28216;&#26631;</span>
    <span style="color: #a0522d;">cursor</span> = conn.cursor()
    <span style="color: #a0522d;">sql</span> = <span style="color: #8b2252;">"""insert into student (name, age) values ('tom', 18)"""</span>
    <span style="color: #a0522d;">rows</span> = cursor.execute(sql) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#30495;&#30340;&#25191;&#34892;&#20102;&#65292;&#21482;&#26159;&#27809;&#26377;&#25552;&#20132;&#12290; &#33258;&#22686;id&#21463;&#24433;&#21709;&#12290;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(rows), rows) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21463;&#24433;&#21709;1&#34892;</span>

    conn.commit() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#20132;&#20107;&#29289;&#12290;&#22240;&#20026;&#40664;&#35748;autocommit&#20026;False,&#20851;&#38381;&#30340;&#12290;</span>
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    conn.rollback()
    <span style="color: #483d8b;">print</span>(e)
<span style="color: #a020f0;">finally</span>:
    <span style="color: #a020f0;">if</span> cursor:
        cursor.close()
    <span style="color: #a020f0;">if</span> conn:
        conn.close()
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">{<span style="color: #8b2252;">'host'</span>: <span style="color: #8b2252;">'192.168.226.128'</span>, <span style="color: #8b2252;">'password'</span>: <span style="color: #8b2252;">'123456'</span>, <span style="color: #8b2252;">'database'</span>: <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'user'</span>: <span style="color: #8b2252;">'root'</span>, <span style="color: #8b2252;">'port'</span>: 3306}
&lt;class <span style="color: #8b2252;">'int'</span>&gt; 1
</pre>
</div>

<pre class="example" id="orge1bbfe5">
提交时需提供commit()方法，原因在于，在Connection类的 __init__方法的注释中有这么一句话

autocommit: Autocommit mode. None means use server default. (default: False)

一般不用开启自动提交功能，使用手动管理事务。
</pre>
</div>
</div>
<div id="outline-container-h:b00067e0-164c-478d-ac95-8a4e8a4ce5d3" class="outline-4">
<h4 id="h:b00067e0-164c-478d-ac95-8a4e8a4ce5d3">事务管理</h4>
<div class="outline-text-4" id="text-h:b00067e0-164c-478d-ac95-8a4e8a4ce5d3">
<p>
Connection类有三个方法：
</p>
<ul class="org-ul">
<li>begin 开始事务</li>
<li>commit 将变更提交</li>
<li>rollback 回滚事务</li>
</ul>

<p>
批量增加数据
</p>

<p>
可以小规则执行几百条sql，统一提交
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(19, 29):
    <span style="color: #a0522d;">sql</span> = <span style="color: #8b2252;">"""insert into student (name, age) values ('tom{0}', 18{0})"""</span>.<span style="color: #483d8b;">format</span>(i)
    <span style="color: #a0522d;">x</span> = cursor.execute(sql)
conn.commit() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25552;&#20132;&#20107;&#29289;&#12290;&#22240;&#20026;&#40664;&#35748;autocommit&#20026;False,&#20851;&#38381;&#30340;&#12290;</span>
</pre>
</div>

<p>
查询数据库
</p>
<div class="org-src-container">
<pre class="src src-sh">mysql&gt; select * from student;
+----+-------+------+
| id | name  | age  |
+----+-------+------+
|  2 | tom   |   18 |
|  3 | tom19 | 1819 |
|  4 | tom20 | 1820 |
|  5 | tom21 | 1821 |
|  6 | tom22 | 1822 |
|  7 | tom23 | 1823 |
|  8 | tom24 | 1824 |
|  9 | tom25 | 1825 |
| 10 | tom26 | 1826 |
| 11 | tom27 | 1827 |
| 12 | tom28 | 1828 |
+----+-------+------+
</pre>
</div>

<p>
使用cursor.executemany() 方法，后面说。不常用。
</p>
</div>
</div>
<div id="outline-container-h:d4a956e4-dd2e-4269-8fc8-53e73114ab80" class="outline-4">
<h4 id="h:d4a956e4-dd2e-4269-8fc8-53e73114ab80">一般流程</h4>
<div class="outline-text-4" id="text-h:d4a956e4-dd2e-4269-8fc8-53e73114ab80">
<ul class="org-ul">
<li>建立连接</li>
<li>获取游标</li>
<li>执行SQL</li>
<li>提交事务</li>
<li>释放资源</li>
</ul>
</div>
</div>
<div id="outline-container-h:466d7d19-54e4-4297-beda-63362f8c982b" class="outline-4">
<h4 id="h:466d7d19-54e4-4297-beda-63362f8c982b">查询</h4>
<div class="outline-text-4" id="text-h:466d7d19-54e4-4297-beda-63362f8c982b">
<p>
Cursor类的获取查询结果集的方法有fetchone()、fetchmany(size=None)、fetchall()
</p>

<p>
查询会根据Cursor游标移动
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> ctypes <span style="color: #a020f0;">import</span> c_ushort

<span style="color: #a020f0;">import</span> pymysql
<span style="color: #a020f0;">import</span> simplejson <span style="color: #b22222;">#</span><span style="color: #b22222;">pip install simplejson</span>
<span style="color: #a020f0;">import</span> os

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(os.path.join(os.path.dirname(__file__), <span style="color: #8b2252;">'config.json'</span>)) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">conf</span> = simplejson.load(f)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21453;&#24207;&#21015;&#21270;&#65292;&#23383;&#20856;</span>
<span style="color: #483d8b;">print</span>(conf)

<span style="color: #b22222;">#</span><span style="color: #b22222;">connection #&#20174;&#37197;&#32622;&#25991;&#20214;&#26469;. ini, json</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">user = None, password = "",host = None,database = None,port = 0,</span>
<span style="color: #a0522d;">conn</span> = <span style="color: #008b8b;">None</span>
<span style="color: #a0522d;">cursor</span> = <span style="color: #008b8b;">None</span>
<span style="color: #a020f0;">try</span>:
    <span style="color: #a0522d;">conn</span> = pymysql.connect(**conf)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">cursor &#28216;&#26631;</span>
    <span style="color: #a0522d;">cursor</span> = conn.cursor()
    <span style="color: #a0522d;">sql</span> = <span style="color: #8b2252;">"select * from student"</span>
    <span style="color: #a0522d;">x</span> = cursor.execute(sql) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#24433;&#21709;&#30340;&#34892;&#25968;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(x), x)

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28216;&#26631;&#40664;&#35748;&#21521;&#21069;&#36208;&#30340;</span>
    <span style="color: #483d8b;">print</span>(cursor.rownumber, cursor.rowcount)
    <span style="color: #483d8b;">print</span>(cursor.fetchone()) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25343;&#19968;&#20010;</span>
    <span style="color: #483d8b;">print</span>(cursor.rownumber, cursor.rowcount)
    <span style="color: #483d8b;">print</span>(cursor.fetchone())
    <span style="color: #483d8b;">print</span>(cursor.rownumber, cursor.rowcount)
    <span style="color: #483d8b;">print</span>(cursor.fetchmany(2)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20108;&#20803;&#32452;&#65292;&#27599;&#19968;&#20010;&#20803;&#32032;&#19968;&#34892;&#20063;&#26159;&#20803;&#32452;</span>
    <span style="color: #483d8b;">print</span>(cursor.rownumber, cursor.rowcount)
    <span style="color: #483d8b;">print</span>(cursor.fetchall())
    <span style="color: #483d8b;">print</span>(cursor.rownumber, cursor.rowcount)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
    cursor.<span style="color: #a0522d;">rownumber</span> = 0 <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28216;&#26631;&#20174;0&#24320;&#22987;</span>
    <span style="color: #483d8b;">print</span>(cursor.fetchall())

<span style="color: #a020f0;">finally</span>:
    <span style="color: #a020f0;">if</span> cursor:
        cursor.close()
    <span style="color: #a020f0;">if</span> conn:
        conn.close()
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">{<span style="color: #8b2252;">'host'</span>: <span style="color: #8b2252;">'192.168.226.128'</span>, <span style="color: #8b2252;">'password'</span>: <span style="color: #8b2252;">'123456'</span>, <span style="color: #8b2252;">'database'</span>: <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'user'</span>: <span style="color: #8b2252;">'root'</span>, <span style="color: #8b2252;">'port'</span>: 3306}
&lt;class <span style="color: #8b2252;">'int'</span>&gt; 11
0 11
(2, <span style="color: #8b2252;">'tom'</span>, 18)
1 11
(3, <span style="color: #8b2252;">'tom19'</span>, 1819)
2 11
((4, <span style="color: #8b2252;">'tom20'</span>, 1820), (5, <span style="color: #8b2252;">'tom21'</span>, 1821))
4 11
((6, <span style="color: #8b2252;">'tom22'</span>, 1822), (7, <span style="color: #8b2252;">'tom23'</span>, 1823), (8, <span style="color: #8b2252;">'tom24'</span>, 1824), (9, <span style="color: #8b2252;">'tom25'</span>, 1825), (10, <span style="color: #8b2252;">'tom26'</span>, 1826), (11, <span style="color: #8b2252;">'tom27'</span>, 1827), (12, <span style="color: #8b2252;">'tom28'</span>, 1828))
11 11
------------------------------
((2, <span style="color: #8b2252;">'tom'</span>, 18), (3, <span style="color: #8b2252;">'tom19'</span>, 1819), (4, <span style="color: #8b2252;">'tom20'</span>, 1820), (5, <span style="color: #8b2252;">'tom21'</span>, 1821), (6, <span style="color: #8b2252;">'tom22'</span>, 1822), (7, <span style="color: #8b2252;">'tom23'</span>, 1823), (8, <span style="color: #8b2252;">'tom24'</span>, 1824), (9, <span style="color: #8b2252;">'tom25'</span>, 1825), (10, <span style="color: #8b2252;">'tom26'</span>, 1826), (11, <span style="color: #8b2252;">'tom27'</span>, 1827), (12, <span style="color: #8b2252;">'tom28'</span>, 1828))
</pre>
</div>

<p>
import pymysql
</p>

<p>
IP = '192.168.1.6'
USERNAME = 'lqx'
PASSWORD = 'lqx'
DBNAME ='test'
PORT = 3306
</p>

<p>
conn = None
currsor = None # 对结果集的操作
try:
    conn = pymysql.connect(IP, USERNAME, PASSWORD, DBNAME, PORT)
    currsor = conn.cursor()
</p>

<p>
sql = 'select * from student'
rows = currsor.execute(sql) # 返回影响的行数
</p>

<p>
print(currsor.fetchone())
print(currsor.fetchone())
print(currsor.rownumber, currsor.rowcount)
print('1 <code>~~~~~~~~~~</code>')
</p>

<p>
print(currsor.fetchmany(2))
print(currsor.rownumber, currsor.rowcount)
print('2 <code>~~~~~~~~~~~</code>')
</p>

<p>
print(currsor.fetchall())
print(currsor.rownumber, currsor.rowcount)
</p>

<p>
for x in currsor.fetchall():
    print(x, '<code>~</code>')
currsor.rownumber = 0
for x in currsor.fetchall():
    print(x, '<code>=</code>')
</p>

<p>
finally:
    if currsor:
        currsor.close()
    if conn:
        conn.close()
</p>

<p>
执行结果
(1, 'tom', 20)
(2, 'ben0', 20)
2 6
1 <code>~~~~~~~~~~</code>
((3, 'ben1', 21), (4, 'ben2', 22))
4 6
2 <code>~~~~~~~~~~~</code>
((5, 'ben3', 23), (6, 'ben4', 24))
6 6
(1, 'tom', 20) <code>=</code>
(2, 'ben0', 20) <code>=</code>
(3, 'ben1', 21) <code>=</code>
(4, 'ben2', 22) <code>=</code>
(5, 'ben3', 23) <code>=</code>
(6, 'ben4', 24) <code>=</code>
</p>

<p>
Process finished with exit code 0
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">名称</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">fetchone()</td>
<td class="org-left">获取结果集的下一行</td>
</tr>

<tr>
<td class="org-left">fetchmany(size=None)</td>
<td class="org-left">size指定返回的行数的行，None则返回空元组</td>
</tr>

<tr>
<td class="org-left">fetchall()</td>
<td class="org-left">返回剩余所有行，如果走到末尾，就返回空元组，否则返回一个元组，其元素是每一行的记录封装的一个元组</td>
</tr>

<tr>
<td class="org-left">cursor.rownumber</td>
<td class="org-left">返回当前行号。可以修改，支持负数。负向超界，拉到起始位置；正向超界，拉到末位位置</td>
</tr>

<tr>
<td class="org-left">cursor.rowcount</td>
<td class="org-left">返回的总行数</td>
</tr>
</tbody>
</table>

<p>
注意：fetch操作的是结果集，结果集是保存在客户端的，也就是说fetch的时候，查询已经结束了
</p>

<p>
范例：游标是在客户端操作的
</p>
<div class="org-src-container">
<pre class="src src-sh">from ctypes import c_ushort

import pymysql
import simplejson <span style="color: #b22222;">#</span><span style="color: #b22222;">pip install simplejson</span>
import os

with open(os.path.join(os.path.dirname(__file__), <span style="color: #8b2252;">'config.json'</span>)) as f:
    conf = simplejson.load(f)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21453;&#24207;&#21015;&#21270;&#65292;&#23383;&#20856;</span>
<span style="color: #0000ff;">print</span>(conf)

<span style="color: #b22222;">#</span><span style="color: #b22222;">connection #&#20174;&#37197;&#32622;&#25991;&#20214;&#26469;. ini, json</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">user = None, password = "",host = None,database = None,port = 0,</span>
conn = None
cursor = None
try:
    conn = pymysql.connect(**conf)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">cursor &#28216;&#26631;</span>
    cursor = conn.cursor()
    sql = <span style="color: #8b2252;">"select * from student"</span>
    x = cursor.execute(sql) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#24433;&#21709;&#30340;&#34892;&#25968;</span>
    print(<span style="color: #8b2252;">'='</span> * 30)
    conn.close()
    print(<span style="color: #8b2252;">'='</span> * 30)
    print(cursor.fetchall())

finally:
    <span style="color: #a020f0;">if</span> cursor:
        cursor.close()
    <span style="color: #b22222;"># </span><span style="color: #b22222;">if conn:</span>
    <span style="color: #b22222;">#     </span><span style="color: #b22222;">conn.close()</span>
</pre>
</div>
<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">{<span style="color: #8b2252;">'host'</span>: <span style="color: #8b2252;">'192.168.226.128'</span>, <span style="color: #8b2252;">'password'</span>: <span style="color: #8b2252;">'123456'</span>, <span style="color: #8b2252;">'database'</span>: <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'user'</span>: <span style="color: #8b2252;">'root'</span>, <span style="color: #8b2252;">'port'</span>: 3306}
==============================
==============================
((2, <span style="color: #8b2252;">'tom'</span>, 18), (3, <span style="color: #8b2252;">'tom19'</span>, 1819), (4, <span style="color: #8b2252;">'tom20'</span>, 1820), (5, <span style="color: #8b2252;">'tom21'</span>, 1821), (6, <span style="color: #8b2252;">'tom22'</span>, 1822), (7, <span style="color: #8b2252;">'tom23'</span>, 1823), (8, <span style="color: #8b2252;">'tom24'</span>, 1824), (9, <span style="color: #8b2252;">'tom25'</span>, 1825), (10, <span style="color: #8b2252;">'tom26'</span>, 1826), (11, <span style="color: #8b2252;">'tom27'</span>, 1827), (12, <span style="color: #8b2252;">'tom28'</span>, 1828))
</pre>
</div>

<p>
先查后改
import pymysql
</p>

<p>
IP = '192.168.1.6'
USERNAME = 'lqx'
PASSWORD = 'lqx'
DBNAME ='test'
PORT = 3306
</p>

<p>
conn = None
currsor = None # 对结果集的操作
try:
    conn = pymysql.connect(IP, USERNAME, PASSWORD, DBNAME, PORT)
    currsor = conn.cursor()
</p>

<p>
sql = 'select * from student'
rows = currsor.execute(sql) # 返回影响的行数
userid = currsor.fetchone()[0]
print(userid)
sql = "update student set name='jerry' where id='{}'".format(userid)
currsor.execute(sql)
</p>

<p>
conn.commit()
</p>

<p>
except:
    conn.rollback()
finally:
    if currsor:
        currsor.close()
    if conn:
        conn.close()
</p>
</div>
</div>
<div id="outline-container-h:7f15bce7-4117-4fc6-9bf9-3b29e07e4517" class="outline-4">
<h4 id="h:7f15bce7-4117-4fc6-9bf9-3b29e07e4517">带列名查询</h4>
<div class="outline-text-4" id="text-h:7f15bce7-4117-4fc6-9bf9-3b29e07e4517">
<p>
Cursor类有一个Mixin的子类DictCursor
</p>

<p>
只需要
</p>
<ul class="org-ul">
<li>导入from pymysql.cursors import DictCursor库</li>
<li>cursor = conn.cursor(DictCursor) 就可以了</li>
</ul>

<p>
具体实现
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pymysql
<span style="color: #a020f0;">import</span> simplejson <span style="color: #b22222;">#</span><span style="color: #b22222;">pip install simplejson</span>
<span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">from</span> pymysql.cursors <span style="color: #a020f0;">import</span> DictCursor

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(os.path.join(os.path.dirname(__file__), <span style="color: #8b2252;">'config.json'</span>)) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">conf</span> = simplejson.load(f)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21453;&#24207;&#21015;&#21270;&#65292;&#23383;&#20856;</span>
<span style="color: #483d8b;">print</span>(conf)

<span style="color: #b22222;">#</span><span style="color: #b22222;">connection #&#20174;&#37197;&#32622;&#25991;&#20214;&#26469;. ini, json</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">user = None, password = "",host = None,database = None,port = 0,</span>
<span style="color: #a0522d;">conn</span> = <span style="color: #008b8b;">None</span>
<span style="color: #a0522d;">cursor</span> = <span style="color: #008b8b;">None</span>
<span style="color: #a020f0;">try</span>:
    <span style="color: #a0522d;">conn</span> = pymysql.connect(**conf)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">cursor &#28216;&#26631;</span>
    <span style="color: #a0522d;">cursor</span> = conn.cursor(DictCursor)
    <span style="color: #a0522d;">sql</span> = <span style="color: #8b2252;">"select * from student"</span>
    <span style="color: #a0522d;">x</span> = cursor.execute(sql) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#24433;&#21709;&#30340;&#34892;&#25968;</span>

    <span style="color: #483d8b;">print</span>(cursor.fetchmany(2))

<span style="color: #a020f0;">finally</span>:
    <span style="color: #a020f0;">if</span> cursor:
        cursor.close()
    <span style="color: #a020f0;">if</span> conn:
        conn.close()
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">{<span style="color: #8b2252;">'host'</span>: <span style="color: #8b2252;">'192.168.226.128'</span>, <span style="color: #8b2252;">'password'</span>: <span style="color: #8b2252;">'123456'</span>, <span style="color: #8b2252;">'database'</span>: <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'user'</span>: <span style="color: #8b2252;">'root'</span>, <span style="color: #8b2252;">'port'</span>: 3306}
[{<span style="color: #8b2252;">'id'</span>: 2, <span style="color: #8b2252;">'name'</span>: <span style="color: #8b2252;">'tom'</span>, <span style="color: #8b2252;">'age'</span>: 18}, {<span style="color: #8b2252;">'id'</span>: 3, <span style="color: #8b2252;">'name'</span>: <span style="color: #8b2252;">'tom19'</span>, <span style="color: #8b2252;">'age'</span>: 1819}]
</pre>
</div>

<p>
返回一行，是一个字典。
</p>

<p>
返回多行，放在列表中，元素是字典，代表一行。
</p>
</div>
</div>
<div id="outline-container-h:bcf58552-b3a2-467a-a02f-e2f4ffab9c63" class="outline-4">
<h4 id="h:bcf58552-b3a2-467a-a02f-e2f4ffab9c63">SQL注入攻击</h4>
<div class="outline-text-4" id="text-h:bcf58552-b3a2-467a-a02f-e2f4ffab9c63">
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#25214;&#20986;&#29992;&#25143;id&#20026;3&#30340;&#29992;&#25143;&#20449;&#24687;&#30340;SQL&#35821;&#21477;&#22914;&#19979;</span>
SELECT * from student WHERE id = 3

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#29616;&#22312;&#65292;&#35201;&#27714;&#21487;&#20197;&#25214;&#20986;&#26576;&#20010;id&#23545;&#24212;&#29992;&#25143;&#30340;&#20449;&#24687;&#65292;&#20195;&#30721;&#22914;&#19979;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">userid = 5 # &#29992;&#25143;id&#21487;&#20197;&#21464;</span>
sql = <span style="color: #8b2252;">'SELECT * from student WHERE id = {}'</span>.format(userid)

<span style="color: #b22222;">#</span><span style="color: #b22222;">userid&#21487;&#20197;&#21464;&#65292;&#20363;&#22914;&#20174;&#23458;&#25143;&#31471;request&#35831;&#27714;&#20013;&#33719;&#21462;&#65292;&#30452;&#25509;&#25340;&#25509;&#21040;&#26597;&#35810;&#23383;&#31526;&#20018;&#20013;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;userid = '5 or 1=1'</span>
sql = <span style="color: #8b2252;">'SELECT * from student WHERE id = {}'</span>.format(<span style="color: #8b2252;">'5 or 1=1'</span>)
</pre>
</div>
<p>
运行的结果竟然是返回了全部数据
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pymysql
<span style="color: #a020f0;">import</span> simplejson <span style="color: #b22222;">#</span><span style="color: #b22222;">pip install simplejson</span>
<span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">from</span> pymysql.cursors <span style="color: #a020f0;">import</span> DictCursor

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(os.path.join(os.path.dirname(__file__), <span style="color: #8b2252;">'config.json'</span>)) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">conf</span> = simplejson.load(f)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21453;&#24207;&#21015;&#21270;&#65292;&#23383;&#20856;</span>
<span style="color: #483d8b;">print</span>(conf)

<span style="color: #b22222;">#</span><span style="color: #b22222;">connection #&#20174;&#37197;&#32622;&#25991;&#20214;&#26469;. ini, json</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">user = None, password = "",host = None,database = None,port = 0,</span>
<span style="color: #a0522d;">conn</span> = <span style="color: #008b8b;">None</span>
<span style="color: #a0522d;">cursor</span> = <span style="color: #008b8b;">None</span>
<span style="color: #a020f0;">try</span>:
    <span style="color: #a0522d;">conn</span> = pymysql.connect(**conf)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">cursor &#28216;&#26631;</span>
    <span style="color: #a0522d;">cursor</span> = conn.cursor(DictCursor)

    <span style="color: #a0522d;">userid</span> = <span style="color: #483d8b;">input</span>(<span style="color: #8b2252;">'&gt;&gt;&gt;'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">tom' or '1'='1</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(userid), userid)
    <span style="color: #a0522d;">sql</span> = <span style="color: #8b2252;">"select * from student where name = '{}'"</span>.<span style="color: #483d8b;">format</span>(userid)
    <span style="color: #483d8b;">print</span>(sql)
    <span style="color: #a0522d;">x</span> = cursor.execute(sql) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#24433;&#21709;&#30340;&#34892;&#25968;</span>

    <span style="color: #483d8b;">print</span>(cursor.fetchall())

<span style="color: #a020f0;">finally</span>:
    <span style="color: #a020f0;">if</span> cursor:
        cursor.close()
    <span style="color: #a020f0;">if</span> conn:
        conn.close()
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">{<span style="color: #8b2252;">'host'</span>: <span style="color: #8b2252;">'192.168.226.128'</span>, <span style="color: #8b2252;">'password'</span>: <span style="color: #8b2252;">'123456'</span>, <span style="color: #8b2252;">'database'</span>: <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'user'</span>: <span style="color: #8b2252;">'root'</span>, <span style="color: #8b2252;">'port'</span>: 3306}
&gt;&gt;&gt;tom<span style="color: #8b2252;">' or '</span>1<span style="color: #8b2252;">'='</span>1
&lt;class <span style="color: #8b2252;">'str'</span>&gt; tom<span style="color: #8b2252;">' or '</span>1<span style="color: #8b2252;">'='</span>1
<span style="color: #a020f0;">select</span> * from student where name = <span style="color: #8b2252;">'tom'</span> or <span style="color: #8b2252;">'1'</span>=<span style="color: #8b2252;">'1'</span>
[{<span style="color: #8b2252;">'id'</span>: 2, <span style="color: #8b2252;">'name'</span>: <span style="color: #8b2252;">'tom'</span>, <span style="color: #8b2252;">'age'</span>: 18}, {<span style="color: #8b2252;">'id'</span>: 3, <span style="color: #8b2252;">'name'</span>: <span style="color: #8b2252;">'tom19'</span>, <span style="color: #8b2252;">'age'</span>: 1819}, {<span style="color: #8b2252;">'id'</span>: 4, <span style="color: #8b2252;">'name'</span>: <span style="color: #8b2252;">'tom20'</span>, <span style="color: #8b2252;">'age'</span>: 1820}, {<span style="color: #8b2252;">'id'</span>: 5, <span style="color: #8b2252;">'name'</span>: <span style="color: #8b2252;">'tom21'</span>, <span style="color: #8b2252;">'age'</span>: 1821}, {<span style="color: #8b2252;">'id'</span>: 6, <span style="color: #8b2252;">'name'</span>: <span style="color: #8b2252;">'tom22'</span>, <span style="color: #8b2252;">'age'</span>: 1822}, {<span style="color: #8b2252;">'id'</span>: 7, <span style="color: #8b2252;">'name'</span>: <span style="color: #8b2252;">'tom23'</span>, <span style="color: #8b2252;">'age'</span>: 1823}, {<span style="color: #8b2252;">'id'</span>: 8, <span style="color: #8b2252;">'name'</span>: <span style="color: #8b2252;">'tom24'</span>, <span style="color: #8b2252;">'age'</span>: 1824}, {<span style="color: #8b2252;">'id'</span>: 9, <span style="color: #8b2252;">'name'</span>: <span style="color: #8b2252;">'tom25'</span>, <span style="color: #8b2252;">'age'</span>: 1825}, {<span style="color: #8b2252;">'id'</span>: 10, <span style="color: #8b2252;">'name'</span>: <span style="color: #8b2252;">'tom26'</span>, <span style="color: #8b2252;">'age'</span>: 1826}, {<span style="color: #8b2252;">'id'</span>: 11, <span style="color: #8b2252;">'name'</span>: <span style="color: #8b2252;">'tom27'</span>, <span style="color: #8b2252;">'age'</span>: 1827}, {<span style="color: #8b2252;">'id'</span>: 12, <span style="color: #8b2252;">'name'</span>: <span style="color: #8b2252;">'tom28'</span>, <span style="color: #8b2252;">'age'</span>: 1828}]
</pre>
</div>
</div>
<div id="outline-container-h:2261b59c-2263-43b4-a58b-c2070d42ef2f" class="outline-5">
<h5 id="h:2261b59c-2263-43b4-a58b-c2070d42ef2f">SQL注入攻击</h5>
<div class="outline-text-5" id="text-h:2261b59c-2263-43b4-a58b-c2070d42ef2f">
<p>
猜测后台数据库的查询语句使用拼接字符串等方式，从而经过设计为服务端传参，令其拼接出特殊字符串的SQL语句，返回攻击者想要的结果。
</p>

<p>
永远不要相信客户端传来的数据是规范及安全的！！！
</p>
</div>
</div>
<div id="outline-container-h:5e1101a6-aa60-436a-952c-4a214e7657d3" class="outline-5">
<h5 id="h:5e1101a6-aa60-436a-952c-4a214e7657d3">如何解决注入攻击</h5>
<div class="outline-text-5" id="text-h:5e1101a6-aa60-436a-952c-4a214e7657d3">
<p>
参数化查询
</p>
<ul class="org-ul">
<li>可以有效防止注入攻击，并提高查询的效率</li>
</ul>

<div class="org-src-container">
<pre class="src src-python">Cursor.execute(query, args=<span style="color: #008b8b;">None</span>)
</pre>
</div>

<ul class="org-ul">
<li>args，必须是元组、列表或字典。</li>
<li>如果查询字符串使用%(name)s，就必须使用字典</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pymysql
<span style="color: #a020f0;">import</span> simplejson <span style="color: #b22222;">#</span><span style="color: #b22222;">pip install simplejson</span>
<span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">from</span> pymysql.cursors <span style="color: #a020f0;">import</span> DictCursor

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(os.path.join(os.path.dirname(__file__), <span style="color: #8b2252;">'config.json'</span>)) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">conf</span> = simplejson.load(f)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21453;&#24207;&#21015;&#21270;&#65292;&#23383;&#20856;</span>
<span style="color: #483d8b;">print</span>(conf)

<span style="color: #b22222;">#</span><span style="color: #b22222;">connection #&#20174;&#37197;&#32622;&#25991;&#20214;&#26469;. ini, json</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">user = None, password = "",host = None,database = None,port = 0,</span>
<span style="color: #a0522d;">conn</span> = <span style="color: #008b8b;">None</span>
<span style="color: #a0522d;">cursor</span> = <span style="color: #008b8b;">None</span>
<span style="color: #a020f0;">try</span>:
    <span style="color: #a0522d;">conn</span> = pymysql.connect(**conf)
    <span style="color: #b22222;">#</span><span style="color: #b22222;">cursor &#28216;&#26631;</span>
    <span style="color: #a0522d;">cursor</span> = conn.cursor(DictCursor)

    <span style="color: #a0522d;">userid</span> = <span style="color: #483d8b;">input</span>(<span style="color: #8b2252;">'&gt;&gt;&gt;'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">2 or 1=1</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(userid), userid)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">sql = "select * from student where name = '{}'".format(userid)</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(sql)</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#25968;&#21270;&#26597;&#35810;&#65292;sql&#23383;&#31526;&#20018;&#24517;&#39035;&#20351;&#29992;c printf&#39118;&#26684;</span>
    <span style="color: #a0522d;">sql</span> = <span style="color: #8b2252;">"select * from student where id=%s"</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20250;&#36716;&#25442;&#25104; select * from student where id='2 or 1=1'</span>
    <span style="color: #a0522d;">x</span> = cursor.execute(sql, userid) <span style="color: #b22222;">#</span><span style="color: #b22222;">args &#21487;&#20197;&#26159;&#20803;&#32452;&#12289;&#21015;&#34920;&#12289;&#23383;&#20856;</span>

    <span style="color: #483d8b;">print</span>(cursor.fetchall())

<span style="color: #a020f0;">finally</span>:
    <span style="color: #a020f0;">if</span> cursor:
        cursor.close()
    <span style="color: #a020f0;">if</span> conn:
        conn.close()
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;</span>
{<span style="color: #8b2252;">'host'</span>: <span style="color: #8b2252;">'192.168.226.128'</span>, <span style="color: #8b2252;">'password'</span>: <span style="color: #8b2252;">'123456'</span>, <span style="color: #8b2252;">'database'</span>: <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'user'</span>: <span style="color: #8b2252;">'root'</span>, <span style="color: #8b2252;">'port'</span>: 3306}
&gt;&gt;&gt;2 or <span style="color: #a0522d;">1</span>=1
&lt;class <span style="color: #8b2252;">'str'</span>&gt; 2 or <span style="color: #a0522d;">1</span>=1
[{<span style="color: #8b2252;">'id'</span>: 2, <span style="color: #8b2252;">'name'</span>: <span style="color: #8b2252;">'tom'</span>, <span style="color: #8b2252;">'age'</span>: 18}]


<span style="color: #b22222;">#</span><span style="color: #b22222;">sql&#25191;&#34892;</span>
mysql&gt; select * from student where <span style="color: #a0522d;">id</span>=<span style="color: #8b2252;">'2 or 1=1'</span>
    -&gt; ;
+----+------+------+
| id | name | age  |
+----+------+------+
|  2 | tom  |   18 |
+----+------+------+
</pre>
</div>
</div>
</div>
<div id="outline-container-h:8ddab840-8f61-49e3-bc28-310a471dcb1f" class="outline-5">
<h5 id="h:8ddab840-8f61-49e3-bc28-310a471dcb1f">参数化查询为什么提高效率？</h5>
<div class="outline-text-5" id="text-h:8ddab840-8f61-49e3-bc28-310a471dcb1f">
<p>
原因就是——SQL语句缓存
</p>
<ul class="org-ul">
<li>数据库服务器一般会对SQL语句编译和缓存，编译只对SQL语句部分，所以参数中就算有SQL指令也不会被当做指令执行。</li>
<li>编译过程，需要词法分析、语法分析、生成AST、优化、生成执行计划等过程，比较耗费资源。</li>
<li>服务端会先查找是否对同一条查询语句进行了缓存，如果缓存未失效，则不需要再次编译，从而降低了编译的成本，降低了内存消耗。</li>
<li>可以认为SQL语句字符串就是一个key，如果使用拼接方案，每次发过去的SQL语句都不一样，都需要编译并缓存。</li>
</ul>

<p>
大量查询的时候，首选使用参数化查询，以节省资源。
</p>

<p>
开发时，应该使用参数化查询。主要目的不是为了语句缓存，而是为了有效消除注入攻击。
</p>

<p>
注意：这里说的是查询字符串的缓存，不是查询结果的缓存。
</p>

<p>
批量执行executemany()
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pymysql
<span style="color: #a020f0;">from</span> pymysql.cursors <span style="color: #a020f0;">import</span> DictCursor

<span style="color: #a0522d;">IP</span> = <span style="color: #8b2252;">'192.168.1.6'</span>
<span style="color: #a0522d;">USERNAME</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">PASSWORD</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">DBNAME</span> =<span style="color: #8b2252;">'test'</span>
<span style="color: #a0522d;">PORT</span> = 3306

<span style="color: #a0522d;">conn</span> = <span style="color: #008b8b;">None</span>
<span style="color: #a0522d;">currsor</span> = <span style="color: #008b8b;">None</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23545;&#32467;&#26524;&#38598;&#30340;&#25805;&#20316;</span>
<span style="color: #a020f0;">try</span>:
    <span style="color: #a0522d;">conn</span> = pymysql.connect(IP, USERNAME, PASSWORD, DBNAME, PORT)
    <span style="color: #a0522d;">currsor</span> = conn.cursor()

    <span style="color: #a0522d;">sql</span> = <span style="color: #8b2252;">"insert into student (name,age) values(%s, %s)"</span>
    currsor.executemany(sql, (
        (<span style="color: #8b2252;">'ben{}'</span>.<span style="color: #483d8b;">format</span>(i), 20+i) <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(5)
    ))

    conn.commit()
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    <span style="color: #483d8b;">print</span>(e)
    conn.rollback()
<span style="color: #a020f0;">finally</span>:
    <span style="color: #a020f0;">if</span> currsor:
        currsor.close()
    <span style="color: #a020f0;">if</span> conn:
        conn.close()
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:f150e829-5d65-46f0-9a6e-04ebcb8820fd" class="outline-4">
<h4 id="h:f150e829-5d65-46f0-9a6e-04ebcb8820fd">上下文支持</h4>
<div class="outline-text-4" id="text-h:f150e829-5d65-46f0-9a6e-04ebcb8820fd">
<p>
查看连接类和游标类的源码
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#36830;&#25509;&#31867;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Connection</span>(<span style="color: #483d8b;">object</span>): 
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__enter__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__exit__</span>(<span style="color: #a020f0;">self</span>, *exc_info):
        <span style="color: #a020f0;">del</span> exc_info
        <span style="color: #a020f0;">self</span>.close()

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#28216;&#26631;&#31867;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Cursor</span>(<span style="color: #483d8b;">object</span>): 
  <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__enter__</span>(<span style="color: #a020f0;">self</span>): 
    <span style="color: #a020f0;">return</span> <span style="color: #a020f0;">self</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__exit__</span>(<span style="color: #a020f0;">self</span>, *exc_info): 
      <span style="color: #a020f0;">del</span> exc_info 
      <span style="color: #a020f0;">self</span>.close()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">close</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a0522d;">conn</span> = <span style="color: #a020f0;">self</span>.connection
        <span style="color: #a020f0;">if</span> conn <span style="color: #a020f0;">is</span> <span style="color: #008b8b;">None</span>:
            <span style="color: #a020f0;">return</span>
        <span style="color: #a020f0;">try</span>:
            <span style="color: #a020f0;">while</span> <span style="color: #a020f0;">self</span>.nextset():
                <span style="color: #a020f0;">pass</span>
        <span style="color: #a020f0;">finally</span>:
            <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">connection</span> = <span style="color: #008b8b;">None</span>
</pre>
</div>

<p>
连接类进入上下文的时候会返回一个游标对象，退出时如果没有异常会提交更改
游标类也使用上下文，在退出时关闭游标对象
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pymysql
<span style="color: #a020f0;">import</span> simplejson <span style="color: #b22222;">#</span><span style="color: #b22222;">pip install simplejson</span>
<span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">from</span> pymysql.cursors <span style="color: #a020f0;">import</span> DictCursor

<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(os.path.join(os.path.dirname(__file__), <span style="color: #8b2252;">'config.json'</span>)) <span style="color: #a020f0;">as</span> f:
    <span style="color: #a0522d;">conf</span> = simplejson.load(f)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21453;&#24207;&#21015;&#21270;&#65292;&#23383;&#20856;</span>
<span style="color: #483d8b;">print</span>(conf)

<span style="color: #b22222;">#</span><span style="color: #b22222;">connection #&#20174;&#37197;&#32622;&#25991;&#20214;&#26469;. ini, json</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">user = None, password = "",host = None,database = None,port = 0,</span>

<span style="color: #a0522d;">conn</span> = pymysql.connect(**conf)

<span style="color: #a020f0;">with</span> conn:
    <span style="color: #b22222;">#</span><span style="color: #b22222;">cursor &#28216;&#26631;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">cursor = conn.cursor(DictCursor)</span>
    <span style="color: #a020f0;">with</span> conn.cursor() <span style="color: #a020f0;">as</span> cursor:
        <span style="color: #a0522d;">userid</span> = 2
        <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(userid), userid)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">sql = "select * from student where name = '{}'".format(userid)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(sql)</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#25968;&#21270;&#26597;&#35810;&#65292;sql&#23383;&#31526;&#20018;&#24517;&#39035;&#20351;&#29992;c printf&#39118;&#26684;</span>
        <span style="color: #a0522d;">sql</span> = <span style="color: #8b2252;">"select * from student where id=%s"</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20250;&#36716;&#25442;&#25104; select * from student where id='2 or 1=1'</span>
        <span style="color: #a0522d;">x</span> = cursor.execute(sql, userid) <span style="color: #b22222;">#</span><span style="color: #b22222;">args &#21487;&#20197;&#26159;&#20803;&#32452;&#12289;&#21015;&#34920;&#12289;&#23383;&#20856;</span>
        <span style="color: #483d8b;">print</span>(cursor.fetchall())
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">{<span style="color: #8b2252;">'host'</span>: <span style="color: #8b2252;">'192.168.226.128'</span>, <span style="color: #8b2252;">'password'</span>: <span style="color: #8b2252;">'123456'</span>, <span style="color: #8b2252;">'database'</span>: <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'user'</span>: <span style="color: #8b2252;">'root'</span>, <span style="color: #8b2252;">'port'</span>: 3306}
&lt;class <span style="color: #8b2252;">'int'</span>&gt; 2
((2, <span style="color: #8b2252;">'tom'</span>, 18),)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:54a4fd02-599c-4668-8bb0-6c7c9bda0999" class="outline-3">
<h3 id="h:54a4fd02-599c-4668-8bb0-6c7c9bda0999">mysqlclient</h3>
<div class="outline-text-3" id="text-h:54a4fd02-599c-4668-8bb0-6c7c9bda0999">
</div>
<div id="outline-container-h:c4c2fe69-ec81-4464-9da5-3653d4aae7ec" class="outline-4">
<h4 id="h:c4c2fe69-ec81-4464-9da5-3653d4aae7ec">安装</h4>
<div class="outline-text-4" id="text-h:c4c2fe69-ec81-4464-9da5-3653d4aae7ec">
<div class="org-src-container">
<pre class="src src-sh">pip install mysqlclient
</pre>
</div>
</div>
</div>
<div id="outline-container-h:696ac92a-ca8b-4d37-a6bd-b5d2904da5b4" class="outline-4">
<h4 id="h:696ac92a-ca8b-4d37-a6bd-b5d2904da5b4">使用</h4>
<div class="outline-text-4" id="text-h:696ac92a-ca8b-4d37-a6bd-b5d2904da5b4">
<div class="org-src-container">
<pre class="src src-sh">import MySQLdb <span style="color: #b22222;">#</span><span style="color: #b22222;">mysqlclient&#26159;MySQLdb&#19978;&#19968;&#20010;&#20998;&#25903;&#39033;&#30446;</span>
import simplejson <span style="color: #b22222;">#</span><span style="color: #b22222;">pip install simplejson</span>
import os


with open(os.path.join(os.path.dirname(__file__), <span style="color: #8b2252;">'config.json'</span>)) as f:
    conf = simplejson.load(f)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21453;&#24207;&#21015;&#21270;&#65292;&#23383;&#20856;</span>
<span style="color: #0000ff;">print</span>(conf)

<span style="color: #b22222;">#</span><span style="color: #b22222;">connection #&#20174;&#37197;&#32622;&#25991;&#20214;&#26469;. ini, json</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">user = None, password = "",host = None,database = None,port = 0,</span>
conn = MySQLdb.connect(**conf)
<span style="color: #b22222;"># </span><span style="color: #b22222;">conn = pymysql.connect(**conf)</span>

with conn:
    <span style="color: #b22222;">#</span><span style="color: #b22222;">cursor &#28216;&#26631;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">cursor = conn.cursor(DictCursor)</span>
    with conn.cursor() as cursor:
        userid = 2
        print(<span style="color: #483d8b;">type</span>(userid), userid)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">sql = "select * from student where name = '{}'".format(userid)</span>
        <span style="color: #b22222;"># </span><span style="color: #b22222;">print(sql)</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#25968;&#21270;&#26597;&#35810;&#65292;sql&#23383;&#31526;&#20018;&#24517;&#39035;&#20351;&#29992;c printf&#39118;&#26684;</span>
        sql = <span style="color: #8b2252;">"select * from student where id=%s"</span>
        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20250;&#36716;&#25442;&#25104; select * from student where id='2 or 1=1'</span>
        x = cursor.execute(sql, (userid, )) <span style="color: #b22222;">#</span><span style="color: #b22222;">args &#21487;&#20197;&#26159;bytes</span>
        print(cursor.fetchall())
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">{<span style="color: #8b2252;">'host'</span>: <span style="color: #8b2252;">'192.168.226.128'</span>, <span style="color: #8b2252;">'password'</span>: <span style="color: #8b2252;">'123456'</span>, <span style="color: #8b2252;">'database'</span>: <span style="color: #8b2252;">'test'</span>, <span style="color: #8b2252;">'user'</span>: <span style="color: #8b2252;">'root'</span>, <span style="color: #8b2252;">'port'</span>: 3306}
&lt;class <span style="color: #8b2252;">'int'</span>&gt; 2
((2, <span style="color: #8b2252;">'tom'</span>, 18),)
</pre>
</div>

<p>
你这样直接使用sql是最快的，但要面向对象地使用mysql，就得用ORM。
</p>
</div>
</div>
</div>
</section>
<section id="outline-container-h:0f8bd935-db9f-4836-bf99-6c7ded1863d2" class="outline-2">
<h2 id="h:0f8bd935-db9f-4836-bf99-6c7ded1863d2">元编程</h2>
<div class="outline-text-2" id="text-h:0f8bd935-db9f-4836-bf99-6c7ded1863d2">
<p>
元编程概念来自LISP和smalltalk。
</p>

<p>
我们写程序是直接写代码，是否能够用代码来生成未来我们需要的代码吗？这就是元编程。
</p>

<p>
例如，我们写一个类class A，能否用代码生成一个类出来？
</p>

<p>
用来生成代码的程序称为元程序metaprogram，编写这种程序就称为元编程metaprogramming。
</p>

<p>
Python语言能够通过反射实现元编程。
</p>

<p>
Python中
</p>
<ul class="org-ul">
<li>所有非object类都继承自object类</li>
<li>所有类的类型包括type类都是type</li>
<li>type类继承自object类</li>
<li>object类的类型也是type类</li>
</ul>
</div>
<div id="outline-container-h:6d918d47-0dce-4927-a06b-18e102230032" class="outline-3">
<h3 id="h:6d918d47-0dce-4927-a06b-18e102230032">type类</h3>
<div class="outline-text-3" id="text-h:6d918d47-0dce-4927-a06b-18e102230032">
</div>
<div id="outline-container-h:362bd835-22df-4d68-8544-6b667f83fe82" class="outline-4">
<h4 id="h:362bd835-22df-4d68-8544-6b667f83fe82">type构建类</h4>
<div class="outline-text-4" id="text-h:362bd835-22df-4d68-8544-6b667f83fe82">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">type</span>(<span style="color: #483d8b;">object</span>):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(cls, what, bases=<span style="color: #008b8b;">None</span>, <span style="color: #483d8b;">dict</span>=<span style="color: #008b8b;">None</span>): <span style="color: #b22222;"># </span><span style="color: #b22222;">known special case of type.__init__</span>
        <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">        type(object_or_name, bases, dict)</span>
<span style="color: #8b2252;">        type(object) -&gt; the object's type</span>
<span style="color: #8b2252;">        type(name, bases, dict) -&gt; a new type</span>
<span style="color: #8b2252;">        # (copied from class doc)</span>
<span style="color: #8b2252;">        """</span>
        <span style="color: #a020f0;">pass</span>   
</pre>
</div>

<ul class="org-ul">
<li>type(object) -&gt; the object's type，返回对象的类型，例如type(10)</li>
<li>type(name, bases, dict) -&gt; a new type， 返回一个新的类型</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">XClass</span> = <span style="color: #483d8b;">type</span>(<span style="color: #8b2252;">'myclass'</span>, (<span style="color: #483d8b;">object</span>,), {<span style="color: #8b2252;">'a'</span>:100, <span style="color: #8b2252;">"b"</span>:<span style="color: #8b2252;">'string'</span>}) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31867;&#21517;myclass&#65307;&#29238;&#31867;&#26159;(objcect,)&#65292; &#21487;&#30452;&#25509;&#20026;&#31354;&#20803;&#32452;()&#12290;{}&#20013;&#26159;&#23646;&#24615;&#12290;</span>
<span style="color: #483d8b;">print</span>(XClass)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
<span style="color: #483d8b;">print</span>(XClass.<span style="color: #483d8b;">__dict__</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
<span style="color: #483d8b;">print</span>(XClass.<span style="color: #483d8b;">__name__</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
<span style="color: #483d8b;">print</span>(XClass.__bases__)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
<span style="color: #483d8b;">print</span>(XClass.mro())

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25191;&#34892;&#32467;&#26524;</span>
&lt;<span style="color: #a020f0;">class</span> <span style="color: #8b2252;">'__main__.myclass'</span>&gt;
------------------------------
{<span style="color: #8b2252;">'a'</span>: 100, <span style="color: #8b2252;">'b'</span>: <span style="color: #8b2252;">'string'</span>, <span style="color: #8b2252;">'__module__'</span>: <span style="color: #8b2252;">'__main__'</span>,\
 <span style="color: #8b2252;">'__dict__'</span>: &lt;attribute <span style="color: #8b2252;">'__dict__'</span> of <span style="color: #8b2252;">'myclass'</span> objects&gt;, \
 <span style="color: #8b2252;">'__weakref__'</span>: &lt;attribute <span style="color: #8b2252;">'__weakref__'</span> of <span style="color: #8b2252;">'myclass'</span> objects&gt;, <span style="color: #8b2252;">'__doc__'</span>: <span style="color: #008b8b;">None</span>}
------------------------------
myclass
------------------------------
(&lt;<span style="color: #a020f0;">class</span> <span style="color: #8b2252;">'object'</span>&gt;,)
------------------------------
[&lt;<span style="color: #a020f0;">class</span> <span style="color: #8b2252;">'__main__.myclass'</span>&gt;, &lt;<span style="color: #a020f0;">class</span> <span style="color: #8b2252;">'object'</span>&gt;]
</pre>
</div>

<p>
创建更加复杂的类
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>):
    <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">x</span> = 1000

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">show</span>(<span style="color: #a020f0;">self</span>):
    <span style="color: #483d8b;">print</span>(<span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">__dict__</span>)

<span style="color: #a0522d;">XClass</span> = <span style="color: #483d8b;">type</span>(<span style="color: #8b2252;">'myclass'</span>, (<span style="color: #483d8b;">object</span>,), {<span style="color: #8b2252;">'a'</span>:100, <span style="color: #8b2252;">'show'</span>:show, <span style="color: #8b2252;">'__init__'</span>:__init__})
<span style="color: #483d8b;">print</span>(XClass)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
<span style="color: #483d8b;">print</span>(XClass.<span style="color: #483d8b;">__dict__</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
<span style="color: #483d8b;">print</span>(XClass.<span style="color: #483d8b;">__name__</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
<span style="color: #483d8b;">print</span>(XClass.mro())
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
XClass().show()

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25191;&#34892;&#32467;&#26524;</span>
&lt;<span style="color: #a020f0;">class</span> <span style="color: #8b2252;">'__main__.myclass'</span>&gt;
------------------------------
{<span style="color: #8b2252;">'a'</span>: 100, <span style="color: #8b2252;">'show'</span>: &lt;function show at 0x0000024D0C7B5158&gt;,\
 <span style="color: #8b2252;">'__init__'</span>: &lt;function __init__ at 0x0000024D0C7B51E0&gt;, \
 <span style="color: #8b2252;">'__module__'</span>: <span style="color: #8b2252;">'__main__'</span>, <span style="color: #8b2252;">'__dict__'</span>: &lt;attribute <span style="color: #8b2252;">'__dict__'</span> of <span style="color: #8b2252;">'myclass'</span> objects&gt;,\
  <span style="color: #8b2252;">'__weakref__'</span>: &lt;attribute <span style="color: #8b2252;">'__weakref__'</span> of <span style="color: #8b2252;">'myclass'</span> objects&gt;, <span style="color: #8b2252;">'__doc__'</span>: <span style="color: #008b8b;">None</span>}
------------------------------
myclass
------------------------------
[&lt;<span style="color: #a020f0;">class</span> <span style="color: #8b2252;">'__main__.myclass'</span>&gt;, &lt;<span style="color: #a020f0;">class</span> <span style="color: #8b2252;">'object'</span>&gt;]
------------------------------
{<span style="color: #8b2252;">'x'</span>: 1000}
</pre>
</div>

<p>
总结：可以借助type构造任何类，用代码来生成代码，这就是元编程。
</p>
</div>
</div>
<div id="outline-container-h:5da65e63-b548-4f48-99d4-643dcaff368b" class="outline-4">
<h4 id="h:5da65e63-b548-4f48-99d4-643dcaff368b">构建元类</h4>
<div class="outline-text-4" id="text-h:5da65e63-b548-4f48-99d4-643dcaff368b">
<p>
一个类可以继承自type类
</p>

<p>
注意不是继承自object类
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">type&#26159;&#20803;&#31867;, &#26159;&#26500;&#24314;&#20854;&#20182;&#31867;&#30340;&#31867;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26500;&#24314;&#20803;&#31867;&#65292;&#24517;&#39035;&#32487;&#25215;type&#65292;&#19988;&#24517;&#39035;&#37325;&#20889;__new__&#26041;&#27861;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">ModelMeta</span>(<span style="color: #483d8b;">type</span>):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__new__</span>(cls, *args, **kwargs):
        <span style="color: #483d8b;">print</span>(cls)
        <span style="color: #483d8b;">print</span>(args)
        <span style="color: #483d8b;">print</span>(kwargs)
        <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">super</span>().__new__(cls, *args, **kwargs)
</pre>
</div>

<ul class="org-ul">
<li>1.继承自type，ModelMeta就是元类，它可以创建出其它类</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">type&#26159;&#20803;&#31867;, &#26159;&#26500;&#24314;&#20854;&#20182;&#31867;&#30340;&#31867;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26500;&#24314;&#20803;&#31867;&#65292;&#24517;&#39035;&#32487;&#25215;type&#65292;&#19988;&#24517;&#39035;&#37325;&#20889;__new__&#26041;&#27861;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">ModelMeta</span>(<span style="color: #483d8b;">type</span>):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__new__</span>(cls, *args, **kwargs):
        <span style="color: #483d8b;">print</span>(cls) <span style="color: #b22222;">#</span><span style="color: #b22222;">ModeMeta</span>
        <span style="color: #483d8b;">print</span>(args) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#26377;name, bases, dict</span>
        <span style="color: #483d8b;">print</span>(kwargs) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36755;&#20986;&#20026;&#31354;&#65292;&#27809;&#29992;</span>
        <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">super</span>().__new__(cls, *args, **kwargs)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">A</span>: <span style="color: #a020f0;">pass</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32487;&#25215;&#33258;object&#65292;&#20351;&#29992;&#20803;&#31867;type&#26500;&#36896;A&#31867;&#30340;&#23545;&#35937;</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(A), A.__bases__) <span style="color: #b22222;">#</span><span style="color: #b22222;">print(type(A), A.__bases__)</span>
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">A</span>(metaclass=ModelMeta):  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32487;&#25215;&#33258;object&#65292;&#20294;&#20803;&#31867;&#21464;&#20102;&#65292;&#20351;&#29992;ModelMeta&#26500;&#36896;A&#31867;&#30340;&#23545;&#35937;</span>
    <span style="color: #a020f0;">pass</span>

<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(A), A.__bases__) <span style="color: #b22222;">#</span><span style="color: #b22222;">&lt;class '__main__.ModelMeta'&gt; (&lt;class 'object'&gt;,)</span>
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;class <span style="color: #8b2252;">'type'</span>&gt; (&lt;class <span style="color: #8b2252;">'object'</span>&gt;,)
------------------------------
&lt;class <span style="color: #8b2252;">'__main__.ModelMeta'</span>&gt;
(<span style="color: #8b2252;">'A'</span>, (), {<span style="color: #8b2252;">'__module__'</span>: <span style="color: #8b2252;">'__main__'</span>, <span style="color: #8b2252;">'__qualname__'</span>: <span style="color: #8b2252;">'A'</span>, <span style="color: #8b2252;">'__firstlineno__'</span>: 14, <span style="color: #8b2252;">'__static_attributes__'</span>: ()})
{}
&lt;class <span style="color: #8b2252;">'__main__.ModelMeta'</span>&gt; (&lt;class <span style="color: #8b2252;">'object'</span>&gt;,)
</pre>
</div>

<p>
从运行结果还可以分析出·__new__(cls, *args, **kwargs)的参数结构：
</p>

<ul class="org-ul">
<li><p>
中间是一个元组
</p>

<p>
('A', (), {'<span class="underline"><span class="underline">module</span></span>': '<span class="underline"><span class="underline">main</span></span>', '<span class="underline"><span class="underline">qualname</span></span>': 'A', '<span class="underline"><span class="underline">firstlineno</span></span>': 14, '<span class="underline"><span class="underline">static_attributes</span></span>': ()})
</p></li>

<li>对应 (name, bases, dict)</li>
</ul>

<p>
修改代码如下
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">type&#26159;&#20803;&#31867;, &#26159;&#26500;&#24314;&#20854;&#20182;&#31867;&#30340;&#31867;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26500;&#24314;&#20803;&#31867;&#65292;&#24517;&#39035;&#32487;&#25215;type&#65292;&#19988;&#24517;&#39035;&#37325;&#20889;__new__&#26041;&#27861;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">ModelMeta</span>(<span style="color: #483d8b;">type</span>):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__new__</span>(cls, name, bases, attrs):
        <span style="color: #483d8b;">print</span>(cls) <span style="color: #b22222;">#</span><span style="color: #b22222;">ModelMeta</span>
        <span style="color: #483d8b;">print</span>(name, bases, attrs)
        <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">super</span>().__new__(cls, name, bases, attrs)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">A</span>(metaclass=ModelMeta):  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32487;&#25215;&#33258;object&#65292;&#20294;&#20803;&#31867;&#21464;&#20102;&#65292;&#20351;&#29992;ModelMeta&#26500;&#36896;A&#31867;&#30340;&#23545;&#35937;</span>
    <span style="color: #a020f0;">pass</span>

<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(A), A.__bases__)  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#20803;&#31867;&#21644;&#22522;&#31867;ModelMeta (object, ) </span>
<span style="color: #483d8b;">print</span>(A.<span style="color: #483d8b;">__dict__</span>)
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;class <span style="color: #8b2252;">'__main__.ModelMeta'</span>&gt;
<span style="color: #0000ff;">A</span> () {<span style="color: #8b2252;">'__module__'</span>: <span style="color: #8b2252;">'__main__'</span>, <span style="color: #8b2252;">'__qualname__'</span>: <span style="color: #8b2252;">'A'</span>, <span style="color: #8b2252;">'__firstlineno__'</span>: 9, <span style="color: #8b2252;">'__static_attributes__'</span>: ()}
&lt;class <span style="color: #8b2252;">'__main__.ModelMeta'</span>&gt; (&lt;class <span style="color: #8b2252;">'object'</span>&gt;,)
{<span style="color: #8b2252;">'__module__'</span>: <span style="color: #8b2252;">'__main__'</span>, <span style="color: #8b2252;">'__firstlineno__'</span>: 9, <span style="color: #8b2252;">'__static_attributes__'</span>: (), <span style="color: #8b2252;">'__dict__'</span>: &lt;attribute <span style="color: #8b2252;">'__dict__'</span> of <span style="color: #8b2252;">'A'</span> objects&gt;, <span style="color: #8b2252;">'__weakref__'</span>: &lt;attribute <span style="color: #8b2252;">'__weakref__'</span> of <span style="color: #8b2252;">'A'</span> objects&gt;, <span style="color: #8b2252;">'__doc__'</span>: None}
</pre>
</div>

<ul class="org-ul">
<li>第二种 B继承自A后，依然是从ModelMeta的类型</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">type&#26159;&#20803;&#31867;, &#26159;&#26500;&#24314;&#20854;&#20182;&#31867;&#30340;&#31867;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26500;&#24314;&#20803;&#31867;&#65292;&#24517;&#39035;&#32487;&#25215;type&#65292;&#19988;&#24517;&#39035;&#37325;&#20889;__new__&#26041;&#27861;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">ModelMeta</span>(<span style="color: #483d8b;">type</span>):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__new__</span>(cls, name, bases, attrs):
        <span style="color: #483d8b;">print</span>(cls) <span style="color: #b22222;">#</span><span style="color: #b22222;">ModelMeta</span>
        <span style="color: #483d8b;">print</span>(name, bases, attrs)
        <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">super</span>().__new__(cls, name, bases, attrs)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">A</span>(metaclass=ModelMeta):  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#32487;&#25215;&#33258;object&#65292;&#20294;&#20803;&#31867;&#21464;&#20102;&#65292;&#20351;&#29992;ModelMeta&#26500;&#36896;A&#31867;&#30340;&#23545;&#35937;</span>
    <span style="color: #a020f0;">pass</span>

<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(A), A.__bases__) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#20803;&#31867;&#21644;&#22522;&#31867; ModelMeta (object, ) </span>
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#20108;&#31181; B&#32487;&#25215;&#33258;A&#21518;&#65292;&#20381;&#28982;&#26159;&#20174;ModelMeta&#30340;&#31867;&#22411;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">B</span>(A): <span style="color: #a020f0;">pass</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(B), B.__bases__) <span style="color: #b22222;">#</span><span style="color: #b22222;">ModelMeta &#29238;&#31867;&#20803;&#31867;&#25913;&#20102;&#65292;&#23376;&#23385;&#37117;&#25913;&#65307; (A, )</span>
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;class <span style="color: #8b2252;">'__main__.ModelMeta'</span>&gt;
<span style="color: #0000ff;">A</span> () {<span style="color: #8b2252;">'__module__'</span>: <span style="color: #8b2252;">'__main__'</span>, <span style="color: #8b2252;">'__qualname__'</span>: <span style="color: #8b2252;">'A'</span>, <span style="color: #8b2252;">'__firstlineno__'</span>: 9, <span style="color: #8b2252;">'__static_attributes__'</span>: ()}
&lt;class <span style="color: #8b2252;">'__main__.ModelMeta'</span>&gt; (&lt;class <span style="color: #8b2252;">'object'</span>&gt;,)
------------------------------
&lt;class <span style="color: #8b2252;">'__main__.ModelMeta'</span>&gt;
<span style="color: #0000ff;">B</span> (&lt;class <span style="color: #8b2252;">'__main__.A'</span>&gt;,) {<span style="color: #8b2252;">'__module__'</span>: <span style="color: #8b2252;">'__main__'</span>, <span style="color: #8b2252;">'__qualname__'</span>: <span style="color: #8b2252;">'B'</span>, <span style="color: #8b2252;">'__firstlineno__'</span>: 16, <span style="color: #8b2252;">'__static_attributes__'</span>: ()}
&lt;class <span style="color: #8b2252;">'__main__.ModelMeta'</span>&gt; (&lt;class <span style="color: #8b2252;">'__main__.A'</span>&gt;,)
</pre>
</div>

<ul class="org-ul">
<li>第三种 元类就可以使用下面的方式创建新的类</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">type&#26159;&#20803;&#31867;, &#26159;&#26500;&#24314;&#20854;&#20182;&#31867;&#30340;&#31867;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">ModelMeta</span>(<span style="color: #483d8b;">type</span>):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__new__</span>(cls, name, bases, attrs):
        <span style="color: #483d8b;">print</span>(cls) <span style="color: #b22222;">#</span><span style="color: #b22222;">ModelMeta</span>
        <span style="color: #483d8b;">print</span>(name, bases, attrs)
        <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">super</span>().__new__(cls, name, bases, attrs)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#19977;&#31181; &#20803;&#31867;&#23601;&#21487;&#20197;&#20351;&#29992;&#19979;&#38754;&#30340;&#26041;&#24335;&#21019;&#24314;&#26032;&#30340;&#31867;</span>
<span style="color: #a0522d;">C</span> = ModelMeta(<span style="color: #8b2252;">'CCC'</span>, (), {})
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(C), C.__bases__) <span style="color: #b22222;">#</span><span style="color: #b22222;">ModelMeta, (object, ) #&#21644;class CCC(metaclass=ModelMeta): pass &#26159;&#19968;&#26679;&#30340;&#25928;&#26524;</span>
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;class <span style="color: #8b2252;">'__main__.ModelMeta'</span>&gt;
<span style="color: #0000ff;">CCC</span> () {}
&lt;class <span style="color: #8b2252;">'__main__.ModelMeta'</span>&gt; (&lt;class <span style="color: #8b2252;">'object'</span>&gt;,)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">D&#12289;E&#26159;type&#30340;&#23454;&#20363;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">D</span>:<span style="color: #a020f0;">pass</span> <span style="color: #b22222;">#</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(D), D.__bases__) <span style="color: #b22222;">#</span><span style="color: #b22222;">type, (object,)</span>
<span style="color: #a0522d;">E</span> = <span style="color: #483d8b;">type</span>(<span style="color: #8b2252;">'E'</span>, (), {})
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(E), E.__bases__) <span style="color: #b22222;">#</span><span style="color: #b22222;">type, (object,)</span>
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;class <span style="color: #8b2252;">'type'</span>&gt; (&lt;class <span style="color: #8b2252;">'object'</span>&gt;,)
&lt;class <span style="color: #8b2252;">'type'</span>&gt; (&lt;class <span style="color: #8b2252;">'object'</span>&gt;,)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">type&#26159;&#20803;&#31867;, &#26159;&#26500;&#24314;&#20854;&#20182;&#31867;&#30340;&#31867;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">ModelMeta</span>(<span style="color: #483d8b;">type</span>):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__new__</span>(cls, name, bases, attrs):
        <span style="color: #483d8b;">print</span>(cls) <span style="color: #b22222;">#</span><span style="color: #b22222;">ModelMeta</span>
        <span style="color: #483d8b;">print</span>(name, bases, attrs)
        <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">super</span>().__new__(cls, name, bases, attrs)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">F</span>(ModelMeta): <span style="color: #a020f0;">pass</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(F), F.__bases__) <span style="color: #b22222;">#</span><span style="color: #b22222;">type, (ModelMeta,)</span>
<span style="color: #483d8b;">print</span>(F.mro(F))
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">&lt;class <span style="color: #8b2252;">'type'</span>&gt; (&lt;class <span style="color: #8b2252;">'__main__.ModelMeta'</span>&gt;,)
[&lt;class <span style="color: #8b2252;">'__main__.F'</span>&gt;, &lt;class <span style="color: #8b2252;">'__main__.ModelMeta'</span>&gt;, &lt;class <span style="color: #8b2252;">'type'</span>&gt;, &lt;class <span style="color: #8b2252;">'object'</span>&gt;]
</pre>
</div>

<ul class="org-ul">
<li>从运行结果可以看出，只要元类是ModelMeta，创建类对象时，就会调用ModelMeta的__new__方法</li>
<li>上例中，F也是元类， F &#x2013;继承自&#x2013;&gt; ModelMeta &#x2013;继承自&#x2013;&gt; type</li>
<li>type(元类) 返回type。但是type被metaclass修改了的元类的类返回其元类</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:48085958-550a-4fb7-893d-5a56ad58ae7f" class="outline-3">
<h3 id="h:48085958-550a-4fb7-893d-5a56ad58ae7f">元类的应用</h3>
<div class="outline-text-3" id="text-h:48085958-550a-4fb7-893d-5a56ad58ae7f">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">ModelMeta</span>(<span style="color: #483d8b;">type</span>):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__new__</span>(cls, name, bases, attrs): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26500;&#36896;&#31867;&#23545;&#35937;Student&#26102;&#36827;&#26469;&#20102;</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"ModelMeta ~~~~"</span>)
        <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">super</span>().__new__(cls, name, bases, attrs)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Model</span>(metaclass=ModelMeta):
    <span style="color: #a020f0;">pass</span>

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Student</span>(Model):  <span style="color: #b22222;">#</span><span style="color: #b22222;">Model&#23376;&#31867;&#65292;Model&#20803;&#31867;&#25913;&#19968;&#19979;&#12290;&#25105;&#24819;&#23545;&#31867;&#23545;&#35937;Student&#20462;&#25913; ORM&#21021;&#27493;</span>
    <span style="color: #a020f0;">pass</span>
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">ModelMeta ~~~~
ModelMeta ~~~~
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Field</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, fieldname=<span style="color: #008b8b;">None</span>, pk=<span style="color: #008b8b;">False</span>, nullable=<span style="color: #008b8b;">False</span>):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">fieldname</span> = fieldname
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">pk</span> = pk
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">nullable</span> = nullable
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;Field ({}, {}, {})&gt;"</span>.<span style="color: #483d8b;">format</span>(
            <span style="color: #a020f0;">self</span>.fieldname, <span style="color: #a020f0;">self</span>.pk, <span style="color: #a020f0;">self</span>.nullable
        )

    <span style="color: #a0522d;">__str__</span> = __repr__

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">ModelMeta</span>(<span style="color: #483d8b;">type</span>):
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__new__</span>(cls, name, bases, attrs): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26500;&#36896;&#31867;&#23545;&#35937;Student&#26102;&#36827;&#26469;&#20102;</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"ModelMeta ~~~~"</span>)
        <span style="color: #a020f0;">if</span> name != <span style="color: #8b2252;">'Model'</span>:
            <span style="color: #483d8b;">print</span>(name)
            <span style="color: #483d8b;">print</span>(bases)
            <span style="color: #483d8b;">print</span>(attrs)
        <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">super</span>().__new__(cls, name, bases, attrs)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Model</span>(metaclass=ModelMeta):
    <span style="color: #a020f0;">pass</span>

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Student</span>(Model):  <span style="color: #b22222;">#</span><span style="color: #b22222;">Model&#23376;&#31867;&#65292;Model&#20803;&#31867;&#25913;&#19968;&#19979;&#12290;&#25105;&#24819;&#23545;&#31867;&#23545;&#35937;Student&#20462;&#25913; ORM&#21021;&#27493;</span>
    <span style="color: #483d8b;">id</span> = Field(pk=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">name</span> = Field(fieldname=<span style="color: #8b2252;">'username'</span>, nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">age</span> = Field(nullable=<span style="color: #008b8b;">True</span>)
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">ModelMeta ~~~~
ModelMeta ~~~~
Student
(&lt;class <span style="color: #8b2252;">'__main__.Model'</span>&gt;,)
{<span style="color: #8b2252;">'__module__'</span>: <span style="color: #8b2252;">'__main__'</span>, <span style="color: #8b2252;">'__qualname__'</span>: <span style="color: #8b2252;">'Student'</span>, <span style="color: #8b2252;">'__firstlineno__'</span>: 25, <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'id'</span>: &lt;Field (None, True, False)&gt;, <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'name'</span>: &lt;Field (username, False, False)&gt;,<span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'age'</span>: &lt;Field (None, False, True)&gt;, <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'__static_attributes__'</span>: ()}
</pre>
</div>

<p>
解决字段问题
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Field</span>:
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>, fieldname=<span style="color: #008b8b;">None</span>, pk=<span style="color: #008b8b;">False</span>, nullable=<span style="color: #008b8b;">False</span>):
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">fieldname</span> = fieldname
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">pk</span> = pk
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">nullable</span> = nullable
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;Field ({}, {}, {})&gt;"</span>.<span style="color: #483d8b;">format</span>(
            <span style="color: #a020f0;">self</span>.fieldname, <span style="color: #a020f0;">self</span>.pk, <span style="color: #a020f0;">self</span>.nullable
        )

    <span style="color: #a0522d;">__str__</span> = __repr__

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">ModelMeta</span>(<span style="color: #483d8b;">type</span>): 
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__new__</span>(cls, name, bases, attrs): <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26500;&#36896;&#31867;&#23545;&#35937;Student&#26102;&#36827;&#26469;&#20102;</span>
        <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">"ModelMeta ~~~~"</span>)
        <span style="color: #a020f0;">if</span> name != <span style="color: #8b2252;">'Model'</span>:
            <span style="color: #483d8b;">print</span>(attrs)
            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#34920;&#21517;</span>
            <span style="color: #a020f0;">if</span> <span style="color: #8b2252;">'db_table'</span> <span style="color: #a020f0;">not</span> <span style="color: #a020f0;">in</span> attrs:
                <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'db_table'</span>] = name.lower()
            <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21028;&#26029;&#20027;&#38190;&#12289;&#21015;&#21517;</span>
            <span style="color: #a0522d;">primarykey</span> = []
            <span style="color: #a020f0;">for</span> k, v <span style="color: #a020f0;">in</span> attrs.items():
                <span style="color: #a020f0;">if</span> <span style="color: #483d8b;">isinstance</span>(v, Field):
                    <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> v.fieldname <span style="color: #a020f0;">or</span> v.fieldname.strip() == <span style="color: #8b2252;">''</span>:
                        v.<span style="color: #a0522d;">fieldname</span> = k
                    <span style="color: #a020f0;">if</span> v.pk:
                        primarykey.append(k)
            <span style="color: #a0522d;">attrs</span>[<span style="color: #8b2252;">'__primarykey__'</span>] = primarykey
            <span style="color: #483d8b;">print</span>(attrs)

        <span style="color: #a020f0;">return</span> <span style="color: #483d8b;">super</span>().__new__(cls, name, bases, attrs)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Model</span>(metaclass=ModelMeta):
    <span style="color: #a020f0;">pass</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36890;&#36807;&#20803;&#32534;&#31243;&#65292;Student&#20889;&#30340;&#24456;&#23569;&#12290;&#36825;&#26679;&#29992;&#25143;&#22312;&#20351;&#29992;&#20013;&#20889;&#24456;&#23569;&#20195;&#30721;&#65292;&#22312;&#20803;&#31867;&#20013;&#20570;&#20102;&#24456;&#22810;&#24037;&#20316;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Student</span>(Model):  <span style="color: #b22222;">#</span><span style="color: #b22222;">Model&#23376;&#31867;&#65292;Model&#20803;&#31867;&#25913;&#19968;&#19979;&#12290;&#25105;&#24819;&#23545;&#31867;&#23545;&#35937;Student&#20462;&#25913; ORM&#21021;&#27493;</span>
    <span style="color: #483d8b;">id</span> = Field(pk=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">name</span> = Field(fieldname=<span style="color: #8b2252;">'username'</span>, nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">age</span> = Field(nullable=<span style="color: #008b8b;">True</span>)

<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'='</span> * 30)
<span style="color: #483d8b;">print</span>(Student.<span style="color: #483d8b;">__dict__</span>)

<span style="color: #a0522d;">s1</span> = Student()
<span style="color: #483d8b;">print</span>(s1.db_table, s1.__primarykey__)
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">ModelMeta ~~~~
ModelMeta ~~~~
{<span style="color: #8b2252;">'__module__'</span>: <span style="color: #8b2252;">'__main__'</span>, <span style="color: #8b2252;">'__qualname__'</span>: <span style="color: #8b2252;">'Student'</span>, <span style="color: #8b2252;">'__firstlineno__'</span>: 37, <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'id'</span>: &lt;Field (None, True, False)&gt;, <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'name'</span>: &lt;Field (username, False, False)&gt;, <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'age'</span>: &lt;Field (None, False, True)&gt;,<span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'__static_attributes__'</span>: ()}
{<span style="color: #8b2252;">'__module__'</span>: <span style="color: #8b2252;">'__main__'</span>, <span style="color: #8b2252;">'__qualname__'</span>: <span style="color: #8b2252;">'Student'</span>, <span style="color: #8b2252;">'__firstlineno__'</span>: 37, <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'id'</span>: &lt;Field (id, True, False)&gt;, <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'name'</span>: &lt;Field (username, False, False)&gt;, <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'age'</span>: &lt;Field (age, False, True)&gt;, <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'__static_attributes__'</span>: (), <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'db_table'</span>: <span style="color: #8b2252;">'student'</span>, <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'__primarykey__'</span>: [<span style="color: #8b2252;">'id'</span>]}
==============================
{<span style="color: #8b2252;">'__module__'</span>: <span style="color: #8b2252;">'__main__'</span>, <span style="color: #8b2252;">'__firstlineno__'</span>: 37, <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'id'</span>: &lt;Field (id, True, False)&gt;, <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'name'</span>: &lt;Field (username, False, False)&gt;, <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'age'</span>: &lt;Field (age, False, True)&gt;, <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'__static_attributes__'</span>: (), <span style="color: #8b2252;">\</span>
             <span style="color: #8b2252;">'db_table'</span>: <span style="color: #8b2252;">'student'</span>, <span style="color: #8b2252;">'__primarykey__'</span>: [<span style="color: #8b2252;">'id'</span>], <span style="color: #8b2252;">'__doc__'</span>: None}
student [<span style="color: #8b2252;">'id'</span>]
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3e3a5a4a-958c-4323-8c87-be78811b53e0" class="outline-3">
<h3 id="h:3e3a5a4a-958c-4323-8c87-be78811b53e0">元编程总结</h3>
<div class="outline-text-3" id="text-h:3e3a5a4a-958c-4323-8c87-be78811b53e0">
<p>
元类是制造类的工厂，是用来构造类的类。
</p>

<p>
构造好元类，就可以在类定义时，使用关键字参数·metaclass·指定元类，可以使用最原始的·metatype(name, bases, dict)·的方式构造一个类。
</p>

<p>
元类的 __new__()方法中，可以获取元类信息、当前类、基类、类属性字典。
</p>

<p>
元编程一般用于框架开发中。
</p>
<ul class="org-ul">
<li>开发中除非你明确的知道自己在干什么，否则不要随便使用元编程</li>
<li>99%的情况下用不到元类，可能有些程序员一辈子都不会使用元类</li>
</ul>

<p>
Django、SQLAlchemy使用了元类，让我们使用起来很方便
</p>
</div>
</div>
<div id="outline-container-h:3bcddd86-6382-4f0d-a4d2-86c0b0065e4f" class="outline-3">
<h3 id="h:3bcddd86-6382-4f0d-a4d2-86c0b0065e4f">ORM</h3>
<div class="outline-text-3" id="text-h:3bcddd86-6382-4f0d-a4d2-86c0b0065e4f">
<p>
ORM，对象关系映射，对象和关系之间的映射，使用面向对象的方式来操作数据库。
</p>

<pre class="example" id="org74cde37">
关系模型和Python对象之间的映射
table =&gt; class     ，表映射为类
row =&gt; object      ，行映射为实例
column =&gt; property ，字段映射为属性
</pre>

<p>
举例, 有表student，字段为id int，name varchar，age int
</p>

<p>
映射到Python为
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Student</span>: 
    <span style="color: #483d8b;">id</span> = ?&#26576;&#31867;&#22411;&#23383;&#27573; 
    <span style="color: #a0522d;">name</span> = ?&#26576;&#31867;&#22411;&#23383;&#27573; 
    <span style="color: #a0522d;">age</span> = ?&#26576;&#31867;&#22411;&#23383;&#27573;

&#26368;&#32456;&#24471;&#21040;&#23454;&#20363;
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Student</span>: 
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__init__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">id</span> = ?
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">name</span> = ?
        <span style="color: #a020f0;">self</span>.<span style="color: #a0522d;">age</span> = ?
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-h:b69a49ca-c308-4c69-9c2a-51237f7de2c8" class="outline-2">
<h2 id="h:b69a49ca-c308-4c69-9c2a-51237f7de2c8">SQLALchemy ORM</h2>
<div class="outline-text-2" id="text-h:b69a49ca-c308-4c69-9c2a-51237f7de2c8">
<p>
SQLAlchemy是一个ORM框架
</p>
</div>
<div id="outline-container-h:0b4bd905-23b8-4a78-96cd-9316a3eae2f0" class="outline-3">
<h3 id="h:0b4bd905-23b8-4a78-96cd-9316a3eae2f0">安装</h3>
<div class="outline-text-3" id="text-h:0b4bd905-23b8-4a78-96cd-9316a3eae2f0">
<div class="org-src-container">
<pre class="src src-sh">pip install sqlalchemy
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d7cc2d1c-97e8-417d-9558-df1128bfed2b" class="outline-3">
<h3 id="h:d7cc2d1c-97e8-417d-9558-df1128bfed2b">文档</h3>
<div class="outline-text-3" id="text-h:d7cc2d1c-97e8-417d-9558-df1128bfed2b">
<p>
官方文档 <a href="http://docs.sqlalchemy.org/en/latest/">http://docs.sqlalchemy.org/en/latest/</a>
</p>

<p>
查看版本
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> sqlalchemy
<span style="color: #483d8b;">print</span>(sqlalchemy.__version__)<span style="color: #b22222;"># </span><span style="color: #b22222;">1.3.5</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c51fed33-68f8-44c1-805c-52e528538b9e" class="outline-3">
<h3 id="h:c51fed33-68f8-44c1-805c-52e528538b9e">开发</h3>
<div class="outline-text-3" id="text-h:c51fed33-68f8-44c1-805c-52e528538b9e">
<p>
SQLAlchemy内部使用了连接池
</p>
</div>
<div id="outline-container-h:6b69c4a0-3591-4f50-b41f-caa18de60e29" class="outline-4">
<h4 id="h:6b69c4a0-3591-4f50-b41f-caa18de60e29">创建连接</h4>
<div class="outline-text-4" id="text-h:6b69c4a0-3591-4f50-b41f-caa18de60e29">
<p>
数据库连接的事情，交给引擎
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> create_engine
dialect+driver://username:password@host:port/database

<span style="color: #b22222;">#</span><span style="color: #b22222;">mysqldb&#30340;&#36830;&#25509;</span>
mysql+mysqldb://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;[:&lt;port&gt;]/&lt;dbname&gt;
<span style="color: #a0522d;">engine</span> = sqlalchemy.create_engine(<span style="color: #8b2252;">"mysql+mysqldb://lqx:lqx@127.0.0.1:3306/hello"</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">pymysql&#30340;&#36830;&#25509;</span>
mysql+pymysql://&lt;username&gt;:&lt;password&gt;@&lt;host&gt;/&lt;dbname&gt;[?&lt;options&gt;]
<span style="color: #a0522d;">engine</span> = sqlalchemy.create_engine(<span style="color: #8b2252;">"mysql+pymysql://lqx:lqx@127.0.0.1:3306/hello"</span>)
<span style="color: #a0522d;">engine</span> = sqlalchemy.create_engine(<span style="color: #8b2252;">"mysql+pymysql://lqx:lqx@127.0.0.1:3306/hello"</span>, echo=<span style="color: #008b8b;">True</span>)
</pre>
</div>

<ul class="org-ul">
<li><p>
echo=True
</p>

<p>
所有的操作都输入到日志。引擎是否打印执行的语句，调试的时候打开很方便
</p></li>

<li><p>
lazy connecting
</p>

<p>
懒连接。创建引擎并不会马上连接数据库，直到让数据库执行任务时才连接
</p></li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> sqlalchemy
<span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> create_engine

<span style="color: #b22222;"># </span><span style="color: #b22222;">mysql+mysqldb://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;[:&lt;port&gt;]/&lt;dbname&gt;</span>

<span style="color: #a0522d;">IP</span> = <span style="color: #8b2252;">'192.168.1.6'</span>
<span style="color: #a0522d;">USERNAME</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">PASSWORD</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">DBNAME</span> =<span style="color: #8b2252;">'test'</span>
<span style="color: #a0522d;">PORT</span> = 3306

<span style="color: #a0522d;">engine</span> = create_engine(<span style="color: #8b2252;">"mysql+pymysql://{}:{}@{}:{}/{}"</span>.<span style="color: #483d8b;">format</span>(
    USERNAME, PASSWORD, IP, PORT, DBNAME
), echo=<span style="color: #008b8b;">True</span>)

<span style="color: #483d8b;">print</span>(engine)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25191;&#34892;&#32467;&#26524;</span>
Engine(mysql+pymysql://lqx:***@192.168.1.6:3306/test)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:f62ca0dd-b111-498d-8c47-869d5ddda2e8" class="outline-4">
<h4 id="h:f62ca0dd-b111-498d-8c47-869d5ddda2e8">Declare a Mapping创建映射</h4>
<div class="outline-text-4" id="text-h:f62ca0dd-b111-498d-8c47-869d5ddda2e8">
</div>
</div>
<div id="outline-container-h:504333ea-3825-4c4d-b448-bd90e74a9198" class="outline-4">
<h4 id="h:504333ea-3825-4c4d-b448-bd90e74a9198">创建基类</h4>
<div class="outline-text-4" id="text-h:504333ea-3825-4c4d-b448-bd90e74a9198">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> sqlalchemy.ext.declarative <span style="color: #a020f0;">import</span> declarative_base
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#22522;&#31867;&#65292;&#20415;&#20110;&#23454;&#20307;&#31867;&#32487;&#25215;&#12290;SQLAlchemy&#22823;&#37327;&#20351;&#29992;&#20102;&#20803;&#32534;&#31243;</span>
<span style="color: #a0522d;">Base</span> = declarative_base()
</pre>
</div>
</div>
</div>
<div id="outline-container-h:eb01c210-12db-453e-880c-cdb0f96b62ff" class="outline-4">
<h4 id="h:eb01c210-12db-453e-880c-cdb0f96b62ff">创建实体类</h4>
<div class="outline-text-4" id="text-h:eb01c210-12db-453e-880c-cdb0f96b62ff">
<p>
student表
</p>
<div class="org-src-container">
<pre class="src src-python">CREATE TABLE student (
    <span style="color: #483d8b;">id</span> INTEGER NOT NULL AUTO_INCREMENT,
    name VARCHAR(64) NOT NULL,
    age INTEGER,
    PRIMARY KEY (<span style="color: #483d8b;">id</span>)
)
</pre>
</div>

<p>
做关系映射
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> sqlalchemy
<span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> create_engine, Column, String, Integer
<span style="color: #a020f0;">from</span> sqlalchemy.ext.declarative <span style="color: #a020f0;">import</span> declarative_base

<span style="color: #b22222;"># </span><span style="color: #b22222;">ORM Mapping</span>
<span style="color: #a0522d;">Base</span> = declarative_base() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22522;&#31867;</span>

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Student</span>(Base):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#34920;&#21517;</span>
    <span style="color: #a0522d;">__tablename__</span>= <span style="color: #8b2252;">'student'</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#31867;&#23646;&#24615;&#23545;&#24212;&#23383;&#27573;</span>
    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">name</span> = Column(String(64), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">age</span> = Column(Integer)
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#19968;&#20010;&#21442;&#25968;&#26159;&#23383;&#27573;&#21517;&#65292;&#22914;&#26524;&#21644;&#23646;&#24615;&#21517;&#19981;&#19968;&#33268;&#65292;&#19968;&#23450;&#35201;&#25351;&#23450;</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">age = Column('age', Integer)</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;{} id={}, name={}, age={}&gt;"</span>.<span style="color: #483d8b;">format</span>(
            __class__.<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">id</span>, <span style="color: #a020f0;">self</span>.name, <span style="color: #a020f0;">self</span>.age
        )

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#30475;&#34920;&#32467;&#26500;</span>
<span style="color: #483d8b;">print</span>(Student)
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">repr</span>(Student.__table__))

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26174;&#31034;&#32467;&#26524;</span>
&lt;<span style="color: #a020f0;">class</span> <span style="color: #8b2252;">'__main__.Student'</span>&gt;
Table(<span style="color: #8b2252;">'student'</span>, MetaData(bind=<span style="color: #008b8b;">None</span>), 
  Column(<span style="color: #8b2252;">'id'</span>, Integer(), table=&lt;student&gt;, primary_key=<span style="color: #008b8b;">True</span>, nullable=<span style="color: #008b8b;">False</span>),  
  Column(<span style="color: #8b2252;">'name'</span>, String(length=64), table=&lt;student&gt;, nullable=<span style="color: #008b8b;">False</span>), 
  Column(<span style="color: #8b2252;">'age'</span>, Integer(), table=&lt;student&gt;), 
  schema=<span style="color: #008b8b;">None</span>)
</pre>
</div>

<p>
__tablename__指定表名
</p>

<p>
Column类指定对应的字段，必须指定
</p>
</div>
</div>
<div id="outline-container-h:4e2dab86-6da5-4f2e-8582-90a834e4e4af" class="outline-4">
<h4 id="h:4e2dab86-6da5-4f2e-8582-90a834e4e4af">实例化</h4>
<div class="outline-text-4" id="text-h:4e2dab86-6da5-4f2e-8582-90a834e4e4af">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">s</span> = Student(name=<span style="color: #8b2252;">'tom'</span>)
<span style="color: #483d8b;">print</span>(s.name) <span style="color: #b22222;"># </span><span style="color: #b22222;">tom</span>
s.<span style="color: #a0522d;">age</span>= 20
<span style="color: #483d8b;">print</span>(s.age) <span style="color: #b22222;"># </span><span style="color: #b22222;">20 </span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:d9ecc79d-102c-4f5f-8d86-12d18a77a02c" class="outline-4">
<h4 id="h:d9ecc79d-102c-4f5f-8d86-12d18a77a02c">创建表</h4>
<div class="outline-text-4" id="text-h:d9ecc79d-102c-4f5f-8d86-12d18a77a02c">
<p>
可以使用SQLAlchemy来创建、删除表
</p>
<ol class="org-ol">
<li><p>
删除继承自Base的所有表
</p>

<p>
Base.metadata.drop_all(engine)
</p></li>

<li><p>
创建继承自Base的所有表
</p>

<p>
Base.metadata.create_all(engine)
</p></li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> sqlalchemy
<span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> create_engine, Column, String, Integer
<span style="color: #a020f0;">from</span> sqlalchemy.ext.declarative <span style="color: #a020f0;">import</span> declarative_base

<span style="color: #a0522d;">IP</span> = <span style="color: #8b2252;">'192.168.1.6'</span>
<span style="color: #a0522d;">USERNAME</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">PASSWORD</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">DBNAME</span> =<span style="color: #8b2252;">'test'</span>
<span style="color: #a0522d;">PORT</span> = 3306
<span style="color: #a0522d;">engine</span> = create_engine(<span style="color: #8b2252;">"mysql+pymysql://{}:{}@{}/{}"</span>.<span style="color: #483d8b;">format</span>(
    USERNAME, PASSWORD, IP, PORT, DBNAME
), echo=<span style="color: #008b8b;">True</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">lazy &#25042;</span>

<span style="color: #483d8b;">print</span>(engine)


<span style="color: #b22222;"># </span><span style="color: #b22222;">ORM Mapping</span>
<span style="color: #a0522d;">Base</span> = declarative_base() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22522;&#31867;</span>

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Student</span>(Base):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#34920;&#21517;</span>
    <span style="color: #a0522d;">__tablename__</span>= <span style="color: #8b2252;">'student'</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#31867;&#23646;&#24615;&#23545;&#24212;&#23383;&#27573;</span>
    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">name</span> = Column(String(64), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">age</span> = Column(Integer)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;{} id={}, name={}, age={}&gt;"</span>.<span style="color: #483d8b;">format</span>(
            __class__.<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">id</span>, <span style="color: #a020f0;">self</span>.name, <span style="color: #a020f0;">self</span>.age
        )

<span style="color: #a0522d;">student</span> = Student(<span style="color: #483d8b;">id</span>=1, name=<span style="color: #8b2252;">'jerry'</span>)
student.<span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">'tom'</span>
student.<span style="color: #a0522d;">age</span>= 20

<span style="color: #483d8b;">print</span>(student)
</pre>
</div>

<p>
生产环境很少这样创建表，都是系统上线的时候由脚本生成
</p>

<p>
生成环境很少删除表，宁可废弃都不能删除
</p>
</div>
</div>
<div id="outline-container-h:225d88c6-ea54-4657-af39-bf5747a4837b" class="outline-4">
<h4 id="h:225d88c6-ea54-4657-af39-bf5747a4837b">创建回话session</h4>
<div class="outline-text-4" id="text-h:225d88c6-ea54-4657-af39-bf5747a4837b">
<p>
在一个会话中操作数据库，会话建立在连接上，连接被引擎管理。
</p>

<p>
当第一次使用数据库时，从引擎维护的连接池中获取一个连接使用。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> sqlalchemy.orm <span style="color: #a020f0;">import</span> sessionmaker

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;session</span>
<span style="color: #a0522d;">Session</span> = sessionmaker(bind=engine) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#24037;&#21378;&#26041;&#27861;&#36820;&#22238;&#31867;</span>
<span style="color: #a0522d;">session</span> = Session() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23454;&#20363;&#21270;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#20381;&#28982;&#22312;&#31532;&#19968;&#27425;&#20351;&#29992;&#26102;&#36830;&#25509;&#25968;&#25454;&#24211;</span>
</pre>
</div>

<p>
session对象线程不安全。所以不同线程应该使用不用的session对象。
</p>

<p>
Session类和engine有一个就行了
</p>
</div>
</div>
<div id="outline-container-h:1ba51d42-7e34-4f56-82db-d6e3eb756bb7" class="outline-4">
<h4 id="h:1ba51d42-7e34-4f56-82db-d6e3eb756bb7">CRUD操作</h4>
<div class="outline-text-4" id="text-h:1ba51d42-7e34-4f56-82db-d6e3eb756bb7">
</div>
<div id="outline-container-h:00115658-c631-4a2f-9d0a-5fa1147e7623" class="outline-5">
<h5 id="h:00115658-c631-4a2f-9d0a-5fa1147e7623">增</h5>
<div class="outline-text-5" id="text-h:00115658-c631-4a2f-9d0a-5fa1147e7623">
<ul class="org-ul">
<li>add()：增加一个对象</li>
<li>add_all()：可迭代对象，元素是对象</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> sqlalchemy
<span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> create_engine, Column, String, Integer
<span style="color: #a020f0;">from</span> sqlalchemy.orm <span style="color: #a020f0;">import</span> sessionmaker
<span style="color: #a020f0;">from</span> sqlalchemy.ext.declarative <span style="color: #a020f0;">import</span> declarative_base

<span style="color: #a0522d;">IP</span> = <span style="color: #8b2252;">'192.168.1.6'</span>
<span style="color: #a0522d;">USERNAME</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">PASSWORD</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">DBNAME</span> =<span style="color: #8b2252;">'test'</span>
<span style="color: #a0522d;">PORT</span> = 3306
<span style="color: #a0522d;">engine</span> = create_engine(<span style="color: #8b2252;">"mysql+pymysql://{}:{}@{}:{}/{}"</span>.<span style="color: #483d8b;">format</span>(
    USERNAME, PASSWORD, IP, PORT, DBNAME
), echo=<span style="color: #008b8b;">True</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">lazy &#25042;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">ORM Mapping</span>
<span style="color: #a0522d;">Base</span> = declarative_base() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22522;&#31867;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#23454;&#20307;&#31867;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Student</span>(Base):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#34920;&#21517;</span>
    <span style="color: #a0522d;">__tablename__</span>= <span style="color: #8b2252;">'student'</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#31867;&#23646;&#24615;&#23545;&#24212;&#23383;&#27573;</span>
    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">name</span> = Column(String(64), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">age</span> = Column(Integer)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;{} id={}, name={}, age={}&gt;"</span>.<span style="color: #483d8b;">format</span>(
            __class__.<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">id</span>, <span style="color: #a020f0;">self</span>.name, <span style="color: #a020f0;">self</span>.age
        )

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#34920;</span>
Base.metadata.drop_all(engine)
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#34920;</span>
Base.metadata.create_all(engine)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;seesion</span>
<span style="color: #a0522d;">Session</span> = sessionmaker(bind=engine)
<span style="color: #a0522d;">session</span> = Session()

<span style="color: #a0522d;">s</span> = Student(name=<span style="color: #8b2252;">'tom'</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#26500;&#36896;&#26102;&#20256;&#20837;</span>
s.<span style="color: #a0522d;">age</span> = 20 <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23646;&#24615;&#36171;&#20540;</span>
<span style="color: #483d8b;">print</span>(s)

session.add(s)
<span style="color: #483d8b;">print</span>(s)
session.commit()
<span style="color: #483d8b;">print</span>(s)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'~~~~~~'</span>)

<span style="color: #a020f0;">try</span>:
    session.add_all([s])
    <span style="color: #483d8b;">print</span>(s)
    session.commit() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#33021;&#25552;&#20132;&#25104;&#21151;&#21527;&#65311;</span>
    <span style="color: #483d8b;">print</span>(s)
<span style="color: #a020f0;">except</span>:
    session.rollbake()
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'roll back'</span>)
    <span style="color: #a020f0;">raise</span>
</pre>
</div>

<p>
add_all()方法不会提交成功的，不是因为它不对，而是s，s成功提交后，s的主键就有了值，所以，只要s没有修改过，就认为没有改动。如下，s变化了，就可以提交修改了
</p>

<div class="org-src-container">
<pre class="src src-python">s.<span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">'jerry'</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">&#20462;&#25913;</span>
session.add_all([s])
</pre>
</div>

<p>
s主键没有值，就是新增；主键有值，就是找到主键对应的记录修改
</p>
</div>
</div>
<div id="outline-container-h:cd739646-24b1-4ebf-8e50-8df824ce4675" class="outline-5">
<h5 id="h:cd739646-24b1-4ebf-8e50-8df824ce4675">简单查询 query()</h5>
<div class="outline-text-5" id="text-h:cd739646-24b1-4ebf-8e50-8df824ce4675">
<p>
使用query()方法，返回一个Query对象
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> sqlalchemy
<span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> create_engine, Column, String, Integer
<span style="color: #a020f0;">from</span> sqlalchemy.orm <span style="color: #a020f0;">import</span> sessionmaker
<span style="color: #a020f0;">from</span> sqlalchemy.ext.declarative <span style="color: #a020f0;">import</span> declarative_base

<span style="color: #a0522d;">IP</span> = <span style="color: #8b2252;">'192.168.1.6'</span>
<span style="color: #a0522d;">USERNAME</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">PASSWORD</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">DBNAME</span> =<span style="color: #8b2252;">'test'</span>
<span style="color: #a0522d;">PORT</span> = 3306
<span style="color: #a0522d;">engine</span> = create_engine(<span style="color: #8b2252;">"mysql+pymysql://{}:{}@{}:{}/{}"</span>.<span style="color: #483d8b;">format</span>(
    USERNAME, PASSWORD, IP, PORT, DBNAME
), echo=<span style="color: #008b8b;">True</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">lazy &#25042;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">ORM Mapping</span>
<span style="color: #a0522d;">Base</span> = declarative_base() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22522;&#31867;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#23454;&#20307;&#31867;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Student</span>(Base):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#34920;&#21517;</span>
    <span style="color: #a0522d;">__tablename__</span>= <span style="color: #8b2252;">'student'</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#31867;&#23646;&#24615;&#23545;&#24212;&#23383;&#27573;</span>
    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">name</span> = Column(String(64), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">age</span> = Column(Integer)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;{} id={}, name={}, age={}&gt;"</span>.<span style="color: #483d8b;">format</span>(
            __class__.<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">id</span>, <span style="color: #a020f0;">self</span>.name, <span style="color: #a020f0;">self</span>.age
        )

<span style="color: #b22222;"># </span><span style="color: #b22222;"># &#21024;&#38500;&#34920;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Base.metadata.drop_all(engine)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#34920;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Base.metadata.create_all(engine)</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;seesion</span>
<span style="color: #a0522d;">Session</span> = sessionmaker(bind=engine)
<span style="color: #a0522d;">session</span> = Session()

<span style="color: #a0522d;">students</span> = session.query(Student)
<span style="color: #483d8b;">print</span>(students.count())
<span style="color: #a020f0;">for</span> student <span style="color: #a020f0;">in</span> students:
    <span style="color: #483d8b;">print</span>(student)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'~~~~~~~~~~~'</span>)

<span style="color: #a0522d;">student</span> = session.query(Student).get(1) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36890;&#36807;&#20027;&#38190;&#26597;&#35810;</span>
<span style="color: #483d8b;">print</span>(student)
</pre>
</div>

<p>
query方法将实体类传入，返回类的对象可迭代对象，这时候并不查询。迭代它就执行SQL来查询数据库，封装数据到指定类的实例
</p>

<p>
get方法使用主键查询，返回一条传入类的一个实例
</p>
</div>
</div>
<div id="outline-container-h:95fbacbc-1822-404d-b5be-4230de2111e6" class="outline-5">
<h5 id="h:95fbacbc-1822-404d-b5be-4230de2111e6">修改</h5>
<div class="outline-text-5" id="text-h:95fbacbc-1822-404d-b5be-4230de2111e6">
<ul class="org-ul">
<li>修改需先查询，在修改，不然会调用插入方法</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> sqlalchemy
<span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> create_engine, Column, String, Integer
<span style="color: #a020f0;">from</span> sqlalchemy.orm <span style="color: #a020f0;">import</span> sessionmaker
<span style="color: #a020f0;">from</span> sqlalchemy.ext.declarative <span style="color: #a020f0;">import</span> declarative_base

<span style="color: #a0522d;">IP</span> = <span style="color: #8b2252;">'192.168.1.6'</span>
<span style="color: #a0522d;">USERNAME</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">PASSWORD</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">DBNAME</span> =<span style="color: #8b2252;">'test'</span>
<span style="color: #a0522d;">PORT</span> = 3306
<span style="color: #a0522d;">engine</span> = create_engine(<span style="color: #8b2252;">"mysql+pymysql://{}:{}@{}:{}/{}"</span>.<span style="color: #483d8b;">format</span>(
    USERNAME, PASSWORD, IP, PORT, DBNAME
), echo=<span style="color: #008b8b;">True</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">lazy &#25042;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">ORM Mapping</span>
<span style="color: #a0522d;">Base</span> = declarative_base() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22522;&#31867;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#23454;&#20307;&#31867;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Student</span>(Base):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#34920;&#21517;</span>
    <span style="color: #a0522d;">__tablename__</span>= <span style="color: #8b2252;">'student'</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#31867;&#23646;&#24615;&#23545;&#24212;&#23383;&#27573;</span>
    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">name</span> = Column(String(64), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">age</span> = Column(Integer)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;{} id={}, name={}, age={}&gt;"</span>.<span style="color: #483d8b;">format</span>(
            __class__.<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">id</span>, <span style="color: #a020f0;">self</span>.name, <span style="color: #a020f0;">self</span>.age
        )

<span style="color: #b22222;"># </span><span style="color: #b22222;"># &#21024;&#38500;&#34920;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Base.metadata.drop_all(engine)</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#34920;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Base.metadata.create_all(engine)</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;seesion</span>
<span style="color: #a0522d;">Session</span> = sessionmaker(bind=engine)
<span style="color: #a0522d;">session</span> = Session()

<span style="color: #a0522d;">student</span> = session.query(Student).get(1) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36890;&#36807;&#20027;&#38190;&#26597;&#35810;</span>
<span style="color: #483d8b;">print</span>(student)
student.<span style="color: #a0522d;">name</span> = <span style="color: #8b2252;">'ben'</span>
student.<span style="color: #a0522d;">age</span> = 30
<span style="color: #483d8b;">print</span>(student)
session.add(student)
session.commit()
</pre>
</div>
</div>
</div>
<div id="outline-container-h:a3359fff-f151-4656-9e4f-05a6d3b5b580" class="outline-5">
<h5 id="h:a3359fff-f151-4656-9e4f-05a6d3b5b580">删除</h5>
<div class="outline-text-5" id="text-h:a3359fff-f151-4656-9e4f-05a6d3b5b580">
<p>
先看下数据库，表中有
</p>
<div class="org-src-container">
<pre class="src src-sh">1 ben 30
</pre>
</div>

<p>
编写如下程序来删除，会发生什么？
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> sqlalchemy
<span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> create_engine, Column, String, Integer
<span style="color: #a020f0;">from</span> sqlalchemy.orm <span style="color: #a020f0;">import</span> sessionmaker
<span style="color: #a020f0;">from</span> sqlalchemy.ext.declarative <span style="color: #a020f0;">import</span> declarative_base

<span style="color: #a0522d;">IP</span> = <span style="color: #8b2252;">'192.168.1.6'</span>
<span style="color: #a0522d;">USERNAME</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">PASSWORD</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">DBNAME</span> =<span style="color: #8b2252;">'test'</span>
<span style="color: #a0522d;">PORT</span> = 3306
<span style="color: #a0522d;">engine</span> = create_engine(<span style="color: #8b2252;">"mysql+pymysql://{}:{}@{}:{}/{}"</span>.<span style="color: #483d8b;">format</span>(
    USERNAME, PASSWORD, IP, PORT, DBNAME
), echo=<span style="color: #008b8b;">True</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">lazy &#25042;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">ORM Mapping</span>
<span style="color: #a0522d;">Base</span> = declarative_base() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22522;&#31867;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#23454;&#20307;&#31867;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Student</span>(Base):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#34920;&#21517;</span>
    <span style="color: #a0522d;">__tablename__</span>= <span style="color: #8b2252;">'student'</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#31867;&#23646;&#24615;&#23545;&#24212;&#23383;&#27573;</span>
    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">name</span> = Column(String(64), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">age</span> = Column(Integer)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;{} id={}, name={}, age={}&gt;"</span>.<span style="color: #483d8b;">format</span>(
            __class__.<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">id</span>, <span style="color: #a020f0;">self</span>.name, <span style="color: #a020f0;">self</span>.age
        )


<span style="color: #a0522d;">Session</span> = sessionmaker(bind=engine)
<span style="color: #a0522d;">session</span> = Session()

<span style="color: #a020f0;">try</span>:
    <span style="color: #a0522d;">student</span> = Student(<span style="color: #483d8b;">id</span>=1, name=<span style="color: #8b2252;">'ben'</span>, age=30)

    session.delete(student)
    session.commit()
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    session.rollback()
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'roll back'</span>)
    <span style="color: #483d8b;">print</span>(e)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25191;&#34892;&#32467;&#26524;</span>
roll back
Instance <span style="color: #8b2252;">'&lt;Student at 0x1779fea9b70&gt;'</span> <span style="color: #a020f0;">is</span> <span style="color: #a020f0;">not</span> persisted
</pre>
</div>

<p>
会产生一个异常
</p>

<p>
Instance '&lt;Student at 0x3e654e0&gt;' is not persisted 未持久的异常！
</p>
</div>
</div>
<div id="outline-container-h:ef1619ba-85b8-4965-beba-b2b32a84249f" class="outline-5">
<h5 id="h:ef1619ba-85b8-4965-beba-b2b32a84249f">状态**</h5>
<div class="outline-text-5" id="text-h:ef1619ba-85b8-4965-beba-b2b32a84249f">
<p>
需导入from sqlalchemy.orm.state import InstanceState库
</p>

<ul class="org-ul">
<li>每一个实体，都有一个状态属性_sa_instance_state，其类型是sqlalchemy.orm.state.InstanceState</li>
<li><p>
使用sqlalchemy.inspect(entity)函数查看状态
</p>

<p>
常见的状态值有transient、pending、persistent、deleted、detached
</p></li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">状态</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">transient</td>
<td class="org-left">实体类尚未加入到session中，同时并没有保存到数据库中</td>
</tr>

<tr>
<td class="org-left">pending</td>
<td class="org-left">transient的实体被add()到session中，状态切换到pending，但它还没有flush到数据库中</td>
</tr>

<tr>
<td class="org-left">persistent</td>
<td class="org-left">session中的实体对象对应着数据库中的真实记录。pending状态在提交成功后可以变成persistent状态，或者查询成功返回的实体也是persistent状态</td>
</tr>

<tr>
<td class="org-left">deleted</td>
<td class="org-left">实体被删除且已经flush但未commit完成。事务提交成功了，实体变成detached，事务失败，返回persistent状态</td>
</tr>

<tr>
<td class="org-left">detached</td>
<td class="org-left">删除成功的实体进入这个状态</td>
</tr>
</tbody>
</table>

<pre class="example" id="org66bbf81">
新建一个实体，状态是transient临时的
一旦add()后从transient变成pending状态
成功commit()后从pending变成persistent状态
成功查询返回的实体对象，也是persistent状态

persistent状态的实体，修改依然是persistent状态
persistent状态的实体，删除后，flush但没有commit，就变成deteled状态
成功提交，变为detached状态提交失败，还原到persistent状态。flush方法，主动把改变应用到数据库中去
</pre>

<p>
删除、修改操作，需要对应一个真实的记录，所以要求实体对象是persistent状态
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> sqlalchemy
<span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> create_engine, Column, String, Integer
<span style="color: #a020f0;">from</span> sqlalchemy.orm <span style="color: #a020f0;">import</span> sessionmaker
<span style="color: #a020f0;">from</span> sqlalchemy.ext.declarative <span style="color: #a020f0;">import</span> declarative_base
<span style="color: #a020f0;">from</span> sqlalchemy.orm.state <span style="color: #a020f0;">import</span> InstanceState

<span style="color: #a0522d;">IP</span> = <span style="color: #8b2252;">'192.168.1.6'</span>
<span style="color: #a0522d;">USERNAME</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">PASSWORD</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">DBNAME</span> =<span style="color: #8b2252;">'test'</span>
<span style="color: #a0522d;">PORT</span> = 3306
<span style="color: #a0522d;">engine</span> = create_engine(<span style="color: #8b2252;">"mysql+pymysql://{}:{}@{}:{}/{}"</span>.<span style="color: #483d8b;">format</span>(
    USERNAME, PASSWORD, IP, PORT, DBNAME
), echo=<span style="color: #008b8b;">True</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">lazy &#25042;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">ORM Mapping</span>
<span style="color: #a0522d;">Base</span> = declarative_base() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22522;&#31867;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#23454;&#20307;&#31867;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Student</span>(Base):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#34920;&#21517;</span>
    <span style="color: #a0522d;">__tablename__</span>= <span style="color: #8b2252;">'student'</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#31867;&#23646;&#24615;&#23545;&#24212;&#23383;&#27573;</span>
    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">name</span> = Column(String(64), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">age</span> = Column(Integer)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;{} id={}, name={}, age={}&gt;"</span>.<span style="color: #483d8b;">format</span>(
            __class__.<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">id</span>, <span style="color: #a020f0;">self</span>.name, <span style="color: #a020f0;">self</span>.age
        )


<span style="color: #a0522d;">Session</span> = sessionmaker(bind=engine)
<span style="color: #a0522d;">session</span> = Session()

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">getstate</span>(instance, i):
    <span style="color: #a0522d;">inp</span>:<span style="color: #228b22;">InstanceState</span> = sqlalchemy.inspect(student)
    <span style="color: #a0522d;">states</span> = <span style="color: #8b2252;">"{}: key={}</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">id={}, attached={}, transient={},"</span> \
             <span style="color: #8b2252;">"pending={}, </span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">persistant={}, deleted={}, detached={}"</span>.<span style="color: #483d8b;">format</span>(
        i ,inp.key,
        inp.session_id, inp._attached, inp.transient,
        inp.pending, inp.persistent, inp.deleted, inp.detached
    )
    <span style="color: #483d8b;">print</span>(states, end=<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">~~~~~~~~~</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

<span style="color: #a0522d;">student</span> = session.query(Student).get(1)
getstate(student, 1) <span style="color: #b22222;"># </span><span style="color: #b22222;">persistent</span>

<span style="color: #a020f0;">try</span>:
    <span style="color: #a0522d;">student</span> = Student(<span style="color: #483d8b;">id</span>=1, name=<span style="color: #8b2252;">'ben'</span>, age=30)
    getstate(student, 2) <span style="color: #b22222;"># </span><span style="color: #b22222;">transit</span>

    <span style="color: #a0522d;">student</span> = Student(name=<span style="color: #8b2252;">'tom'</span>, age=20)
    getstate(student, 3) <span style="color: #b22222;"># </span><span style="color: #b22222;">transit</span>
    session.add(student) <span style="color: #b22222;"># </span><span style="color: #b22222;">add&#21518;&#21464;&#25104;pending</span>
    getstate(student,4) <span style="color: #b22222;"># </span><span style="color: #b22222;">pending</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">session.delete(student) # &#24322;&#24120;&#65292;&#21024;&#38500;&#30340;&#21069;&#25552;&#24517;&#39035;&#26159;persistent&#65292;&#20063;&#23601;&#26159;&#35828;&#20808;&#26597;&#21518;&#21024;</span>
    session.commit() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25552;&#20132;&#21518;&#65292;&#21464;&#25104;persistent</span>
    getstate(student, 6) <span style="color: #b22222;"># </span><span style="color: #b22222;">persistent</span>
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    session.rollback()
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'roll back'</span>)
</pre>
</div>

<p>
运行结果
</p>

<pre class="example" id="orgd3a3de1">
1: key=(&lt;class '__main__.Student'&gt;, (1,), None)
id=1, attached=True, transient=False,pending=False, 
persistant=True, deleted=False, detached=False
persistent就是key不为None，附加的，且不是删除的，有sessionid
~~~~~~~~~
2: key=None
id=None, attached=False, transient=True,pending=False, 
persistant=False, deleted=False, detached=False
transient的key为None，且无附加
~~~~~~~~~
3: key=None
id=None, attached=False, transient=True,pending=False, 
persistant=False, deleted=False, detached=False
同上
~~~~~~~~~
4: key=None
id=1, attached=True, transient=False,pending=True, 
persistant=False, deleted=False, detached=False
add后变成pending，已附加，但是没有key，有了sessionid
~~~~~~~~~
6: key=(&lt;class '__main__.Student'&gt;, (2,), None)
id=1, attached=True, transient=False,pending=False, 
persistant=True, deleted=False, detached=False
提交成功后，变成persistent，有了key
~~~~~~~~~
Process finished with exit code 0
</pre>

<p>
删除状态的变化
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> sqlalchemy
<span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> create_engine, Column, String, Integer
<span style="color: #a020f0;">from</span> sqlalchemy.orm <span style="color: #a020f0;">import</span> sessionmaker
<span style="color: #a020f0;">from</span> sqlalchemy.ext.declarative <span style="color: #a020f0;">import</span> declarative_base
<span style="color: #a020f0;">from</span> sqlalchemy.orm.state <span style="color: #a020f0;">import</span> InstanceState

<span style="color: #a0522d;">IP</span> = <span style="color: #8b2252;">'192.168.1.6'</span>
<span style="color: #a0522d;">USERNAME</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">PASSWORD</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">DBNAME</span> =<span style="color: #8b2252;">'test'</span>
<span style="color: #a0522d;">PORT</span> = 3306
<span style="color: #a0522d;">engine</span> = create_engine(<span style="color: #8b2252;">"mysql+pymysql://{}:{}@{}:{}/{}"</span>.<span style="color: #483d8b;">format</span>(
    USERNAME, PASSWORD, IP, PORT, DBNAME
), echo=<span style="color: #008b8b;">True</span>) <span style="color: #b22222;"># </span><span style="color: #b22222;">lazy &#25042;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">ORM Mapping</span>
<span style="color: #a0522d;">Base</span> = declarative_base() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22522;&#31867;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21019;&#24314;&#23454;&#20307;&#31867;</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Student</span>(Base):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#34920;&#21517;</span>
    <span style="color: #a0522d;">__tablename__</span>= <span style="color: #8b2252;">'student'</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#31867;&#23646;&#24615;&#23545;&#24212;&#23383;&#27573;</span>
    <span style="color: #483d8b;">id</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>, autoincrement=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">name</span> = Column(String(64), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">age</span> = Column(Integer)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;{} id={}, name={}, age={}&gt;"</span>.<span style="color: #483d8b;">format</span>(
            __class__.<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">id</span>, <span style="color: #a020f0;">self</span>.name, <span style="color: #a020f0;">self</span>.age
        )


<span style="color: #a0522d;">Session</span> = sessionmaker(bind=engine)
<span style="color: #a0522d;">session</span> = Session()

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">getstate</span>(instance, i):
    <span style="color: #a0522d;">inp</span>:<span style="color: #228b22;">InstanceState</span> = sqlalchemy.inspect(student)
    <span style="color: #a0522d;">states</span> = <span style="color: #8b2252;">"{}: key={}</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">id={}, attached={}, transient={},"</span> \
             <span style="color: #8b2252;">"pending={}, </span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">persistant={}, deleted={}, detached={}"</span>.<span style="color: #483d8b;">format</span>(
        i ,inp.key,
        inp.session_id, inp._attached, inp.transient,
        inp.pending, inp.persistent, inp.deleted, inp.detached
    )
    <span style="color: #483d8b;">print</span>(states, end=<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">~~~~~~~~~</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

<span style="color: #a0522d;">student</span> = session.query(Student).get(1)
getstate(student, 7) <span style="color: #b22222;"># </span><span style="color: #b22222;">persistent</span>

<span style="color: #a020f0;">try</span>:
    session.delete(student) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500;&#30340;&#21069;&#25552;&#26159;persistent</span>

    getstate(student, 8) <span style="color: #b22222;"># </span><span style="color: #b22222;">persistent</span>
    session.flush()
    getstate(student, 9) <span style="color: #b22222;"># </span><span style="color: #b22222;">deleted</span>
    session.commit()
    getstate(student, 13) <span style="color: #b22222;"># </span><span style="color: #b22222;">detached</span>
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    session.rollback()
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'roll back'</span>)
</pre>
</div>

<p>
执行结果
</p>

<div class="org-src-container">
<pre class="src src-sh">7: <span style="color: #a0522d;">key</span>=(&lt;class <span style="color: #8b2252;">'__main__.Student'</span>&gt;, (1,), None)
<span style="color: #a0522d;">id</span>=1, <span style="color: #a0522d;">attached</span>=True, <span style="color: #a0522d;">transient</span>=False,<span style="color: #a0522d;">pending</span>=False, 
<span style="color: #a0522d;">persistant</span>=True, <span style="color: #a0522d;">deleted</span>=False, <span style="color: #a0522d;">detached</span>=False
~~~~~~~~~
8: <span style="color: #a0522d;">key</span>=(&lt;class <span style="color: #8b2252;">'__main__.Student'</span>&gt;, (1,), None)
<span style="color: #a0522d;">id</span>=1, <span style="color: #a0522d;">attached</span>=True, <span style="color: #a0522d;">transient</span>=False,<span style="color: #a0522d;">pending</span>=False, 
<span style="color: #a0522d;">persistant</span>=True, <span style="color: #a0522d;">deleted</span>=False, <span style="color: #a0522d;">detached</span>=False
~~~~~~~~~
2019-06-27 16:49:04,554 INFO sqlalchemy.engine.base.Engine DELETE FROM student WHERE student.id = %(id)s
2019-06-27 16:49:04,554 INFO sqlalchemy.engine.base.Engine {<span style="color: #8b2252;">'id'</span>: 1}
9: <span style="color: #a0522d;">key</span>=(&lt;class <span style="color: #8b2252;">'__main__.Student'</span>&gt;, (1,), None)
<span style="color: #a0522d;">id</span>=1, <span style="color: #a0522d;">attached</span>=True, <span style="color: #a0522d;">transient</span>=False,<span style="color: #a0522d;">pending</span>=False, 
<span style="color: #a0522d;">persistant</span>=False, <span style="color: #a0522d;">deleted</span>=True, <span style="color: #a0522d;">detached</span>=False
delete&#21518;flush&#65292;&#29366;&#24577;&#21464;&#25104;deleted&#65292;&#19981;&#36807;&#26159;&#38468;&#21152;&#30340;
~~~~~~~~~

2019-06-27 16:49:04,556 INFO sqlalchemy.engine.base.Engine COMMIT
&#19968;&#26086;&#25552;&#20132;&#21518;
13: <span style="color: #a0522d;">key</span>=(&lt;class <span style="color: #8b2252;">'__main__.Student'</span>&gt;, (1,), None)
<span style="color: #a0522d;">id</span>=None, <span style="color: #a0522d;">attached</span>=False, <span style="color: #a0522d;">transient</span>=False,<span style="color: #a0522d;">pending</span>=False, 
<span style="color: #a0522d;">persistant</span>=False, <span style="color: #a0522d;">deleted</span>=False, <span style="color: #a0522d;">detached</span>=True
&#29366;&#24577;&#36716;&#20026;detached
~~~~~~~~~
</pre>
</div>
</div>
</div>
<div id="outline-container-h:57e8f2a5-3199-4173-b101-4ad09ef6ad3b" class="outline-5">
<h5 id="h:57e8f2a5-3199-4173-b101-4ad09ef6ad3b">复杂查询 filter</h5>
<div class="outline-text-5" id="text-h:57e8f2a5-3199-4173-b101-4ad09ef6ad3b">
<p>
实体类
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> sqlalchemy
<span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> create_engine, Column, String, Integer, Date, Enum, ForeignKey
<span style="color: #a020f0;">from</span> sqlalchemy.orm <span style="color: #a020f0;">import</span> sessionmaker
<span style="color: #a020f0;">from</span> sqlalchemy.ext.declarative <span style="color: #a020f0;">import</span> declarative_base
<span style="color: #a020f0;">from</span> sqlalchemy.orm.state <span style="color: #a020f0;">import</span> InstanceState
<span style="color: #a020f0;">import</span> enum

<span style="color: #a0522d;">Base</span> = declarative_base() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22522;&#31867;</span>

<span style="color: #a0522d;">IP</span> = <span style="color: #8b2252;">'192.168.1.6'</span>
<span style="color: #a0522d;">USERNAME</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">PASSWORD</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">DBNAME</span> =<span style="color: #8b2252;">'test'</span>
<span style="color: #a0522d;">PORT</span> = 3306
<span style="color: #a0522d;">engine</span> = create_engine(<span style="color: #8b2252;">"mysql+pymysql://{}:{}@{}:{}/{}"</span>.<span style="color: #483d8b;">format</span>(
    USERNAME, PASSWORD, IP, PORT, DBNAME
), echo=<span style="color: #008b8b;">True</span>)

<span style="color: #a0522d;">Session</span> = sessionmaker(bind=engine)
<span style="color: #a0522d;">session</span> = Session()

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">MyEnum</span>(enum.Enum):
    <span style="color: #a0522d;">M</span> = <span style="color: #8b2252;">'M'</span>
    <span style="color: #a0522d;">F</span> = <span style="color: #8b2252;">'F'</span>


<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Employee</span>(Base):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#34920;&#21517;</span>
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">'employees'</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#31867;&#23646;&#24615;&#23545;&#24212;&#23383;&#27573;</span>
    <span style="color: #a0522d;">emp_no</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">birth_date</span> = Column(Date, nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">first_name</span> = Column(String(14), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">last_name</span> = Column(String(16), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">gender</span> = Column(Enum(MyEnum), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">hire_date</span> = Column(Date, nullable=<span style="color: #008b8b;">False</span>)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;{} no={}, name={}, gender={}&gt;"</span>.<span style="color: #483d8b;">format</span>(
            __class__.<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>.emp_no, <span style="color: #8b2252;">"{} {}"</span>.<span style="color: #483d8b;">format</span>(
                <span style="color: #a020f0;">self</span>.first_name, <span style="color: #a020f0;">self</span>.last_name), <span style="color: #a020f0;">self</span>.gender.value
        )

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#21360;&#20989;&#25968;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">show</span>(emps):
    <span style="color: #a020f0;">for</span> x <span style="color: #a020f0;">in</span> emps:
        <span style="color: #483d8b;">print</span>(x)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'~~~~~~~~~~~~</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31616;&#21333;&#26465;&#20214;&#26597;&#35810;</span>
<span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>(Employee.emp_no &gt; 10015)
show(emps)
</pre>
</div>
</div>
<ul class="org-ul">
<li><a id="h:5745a5a9-40d2-4abe-9d4f-f143d168c37e"></a>与或非<br>
<div class="outline-text-6" id="text-h:5745a5a9-40d2-4abe-9d4f-f143d168c37e">
<p>
需导入from sqlalchemy import or_, and_, not_
</p>

<p>
查询 与 and 四种方式
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>(Employee.emp_no &gt; 10015, Employee.emp_no &lt; 10018)
show(emps)

<span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>(emps.emp_no &gt; 10015).<span style="color: #483d8b;">filter</span>(Employee.emp_no &lt; 10018)
show(emps)

<span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>(and_(Employee.emp_no &gt; 10015, Employee.emp_no &lt;10018))
show(emps)

<span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>((Employee.emp_no &gt; 10015) &amp; (Employee.emp_no &lt; 10018))
show(emps)
</pre>
</div>

<p>
查询 或 or 两种方法
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>(or_(Employee.emp_no &gt; 10015, Employee.emp_no &lt; 10018))
show(emps)

<span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>((Employee.emp_no &gt; 10015) | (Employee.emp_no &lt; 10018))
show(emps)
</pre>
</div>

<p>
查询 非 两种方法
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>(not_(Employee.emp_no &lt; 10018))
show(emps)

<span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>(~(Employee.emp_no &gt; 10018))
show(emps)
</pre>
</div>

<p>
in 操作
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>(Employee.emp_no.in_([10015, 10018, 10020]))
show(emps)
</pre>
</div>

<p>
not in 操作
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>(~Employee.emp_no.in_([10015, 10018, 10020]))
show(emps)

<span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>(~Employee.emp_no.notin_([10015, 10018, 10020]))
show(emps)
</pre>
</div>

<p>
like 字符串匹配操作
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>(Employee.last_name.like(<span style="color: #8b2252;">'p%'</span>))
show(emps)
</pre>
</div>

<p>
not like
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>(Employee.last_name.notlike(<span style="color: #8b2252;">'p%'</span>))
show(emps)
</pre>
</div>

<p>
ilike可以忽略带小写匹配
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-h:dd0f8713-1082-4af6-899d-55f695270602" class="outline-5">
<h5 id="h:dd0f8713-1082-4af6-899d-55f695270602">排序 order_by</h5>
<div class="outline-text-5" id="text-h:dd0f8713-1082-4af6-899d-55f695270602">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21319;&#24207;</span>
<span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>(Employee.emp_no &gt; 10010).order_by(Employee.emp_no)
<span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>(Employee.emp_no &gt; 10010).order_by(Employee.emp_no.asc())
show(emps)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38477;&#24207;</span>
<span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>(Employee.emp_no &gt; 10010).order_by(Employee.emp_no.desc())
show(emps)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#21015;&#25490;&#24207;</span>
<span style="color: #a0522d;">emps</span> = session.query(Employee).<span style="color: #483d8b;">filter</span>(Employee.emp_no &gt;
    10010).order_by(Employee.last_name).order_by(Employee.emp_no.desc())
show(emps)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:fde785a6-2dca-4858-a1cb-3e88a36cd70d" class="outline-5">
<h5 id="h:fde785a6-2dca-4858-a1cb-3e88a36cd70d">分页 limit</h5>
<div class="outline-text-5" id="text-h:fde785a6-2dca-4858-a1cb-3e88a36cd70d">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">emps</span> = session.query(Employee).limit(4)
show(emps)

<span style="color: #a0522d;">emps</span> = session.query(Employee).limit(4).offset(18)
show(emps)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:cdf0dfb8-b652-443d-b665-6cbe1f9a61dd" class="outline-5">
<h5 id="h:cdf0dfb8-b652-443d-b665-6cbe1f9a61dd">消费者方法</h5>
<div class="outline-text-5" id="text-h:cdf0dfb8-b652-443d-b665-6cbe1f9a61dd">
<p>
消费者方法调用后，Query对象（可迭代）就转换成了一个容器
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#24635;&#34892;&#25968;</span>
<span style="color: #a0522d;">emps</span> = session.query(Employee)
<span style="color: #483d8b;">print</span>(emps.count()) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#32858;&#21512;&#20989;&#25968;count(*)&#30340;&#26597;&#35810;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21462;&#25152;&#26377;&#25968;&#25454;</span>
<span style="color: #483d8b;">print</span>(emps.<span style="color: #483d8b;">all</span>()) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#21015;&#34920;&#65292;&#26597;&#19981;&#21040;&#36820;&#22238;&#31354;&#21015;&#34920;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21462;&#39318;&#34892;</span>
<span style="color: #483d8b;">print</span>(emps.first()) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#36820;&#22238;&#39318;&#34892;&#65292;&#26597;&#19981;&#21040;&#36820;&#22238;None&#65292;&#31561;&#20215;limit</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26377;&#19988;&#21482;&#33021;&#26377;&#19968;&#34892;</span>
<span style="color: #483d8b;">print</span>(emps.one()) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22914;&#26524;&#26597;&#35810;&#32467;&#26524;&#26159;&#22810;&#34892;&#25243;&#24322;&#24120;</span>
<span style="color: #483d8b;">print</span>(emps.limit(1).one())

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#21024;&#38500; delete by query</span>
session.query(Employee).<span style="color: #483d8b;">filter</span>(Employee.emp_no &gt; 10018).delete()
session.commmit <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25552;&#20132;&#21017;&#21024;&#38500;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c36e4c9c-b8e6-42d6-964a-d57dfcd7640a" class="outline-5">
<h5 id="h:c36e4c9c-b8e6-42d6-964a-d57dfcd7640a">聚合、分组</h5>
<div class="outline-text-5" id="text-h:c36e4c9c-b8e6-42d6-964a-d57dfcd7640a">
<p>
需导入 from sqlalchemy import func
</p>

<p>
聚合函数
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">count</span>
<span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> func

<span style="color: #a0522d;">query</span> = session.query(func.count(Employee.emp_no)) 
<span style="color: #483d8b;">print</span>(query.<span style="color: #483d8b;">all</span>()) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21015;&#34920;&#20013;&#19968;&#20010;&#20803;&#32032;</span>
<span style="color: #483d8b;">print</span>(query.first) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19968;&#20010;&#21482;&#26377;&#19968;&#20010;&#20803;&#32452;&#30340;&#20803;&#32452;</span>
<span style="color: #483d8b;">print</span>(query.one()) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21482;&#33021;&#26377;&#19968;&#34892;&#36820;&#22238;&#65292;&#19968;&#20010;&#20803;&#32452;</span>
<span style="color: #483d8b;">print</span>(query.scalar()) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21462;one()&#30340;&#31532;&#19968;&#20010;&#20803;&#32032;</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">max/min/avg</span>
<span style="color: #483d8b;">print</span>(session.query(func.<span style="color: #483d8b;">max</span>(Employee.emp_no)).scalar())
<span style="color: #483d8b;">print</span>(session.query(func.<span style="color: #483d8b;">min</span>(Employee.emp_no)).scalar())
<span style="color: #483d8b;">print</span>(session.query(func.avg(Employee.emp_no)).scalar())
</pre>
</div>

<p>
分组
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">query</span> = session.query(Employee.gender,
    func.count(Employee.emp_no)).group_by(Employee.gender).<span style="color: #483d8b;">all</span>()
<span style="color: #a020f0;">for</span> g,y <span style="color: #a020f0;">in</span> query:
    <span style="color: #483d8b;">print</span>(g.value, y)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:704ba74e-20c4-4a9c-a534-53501469b6fa" class="outline-5">
<h5 id="h:704ba74e-20c4-4a9c-a534-53501469b6fa">关联查询</h5>
<div class="outline-text-5" id="text-h:704ba74e-20c4-4a9c-a534-53501469b6fa">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#21592;&#24037;&#34920;</span>
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `employees` (
  `emp_no` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `birth_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `first_name` <span style="color: #228b22;">varchar</span>(14) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `last_name` <span style="color: #228b22;">varchar</span>(16) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `gender` <span style="color: #228b22;">smallint</span>(6) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> <span style="color: #a020f0;">DEFAULT</span> 1 COMMENT <span style="color: #8b2252;">'M=1, F=2'</span>,
  `hire_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`emp_no`)
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8mb3;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#37096;&#38376;&#34920;</span>
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `departments` (
  `dept_no` <span style="color: #228b22;">char</span>(4) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `dept_name` <span style="color: #228b22;">varchar</span>(40) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`dept_no`),
  <span style="color: #a020f0;">UNIQUE</span> <span style="color: #a020f0;">KEY</span> `dept_name` (`dept_name`)
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8mb3;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31532;&#19977;&#24352;&#34920;</span>
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `dept_emp` (
  `emp_no` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `dept_no` <span style="color: #228b22;">char</span>(4) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `from_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `to_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`emp_no`,`dept_no`),
  <span style="color: #a020f0;">KEY</span> `dept_no` (`dept_no`),
  <span style="color: #a020f0;">CONSTRAINT</span> `dept_emp_ibfk_1` <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`emp_no`) <span style="color: #a020f0;">REFERENCES</span> `employees` (`emp_no`) <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">CASCADE</span>,
  <span style="color: #a020f0;">CONSTRAINT</span> `dept_emp_ibfk_2` <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`dept_no`) <span style="color: #a020f0;">REFERENCES</span> `departments` (`dept_no`) <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">CASCADE</span>
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8;
</pre>
</div>


<p>
从语句看出员工、部门之间的关系是多对多关系。
</p>

<p>
先把这些表的Model类和字段属性建立起来。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> sqlalchemy
<span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> create_engine, Column, String, Integer, Date, Enum, ForeignKey
<span style="color: #a020f0;">from</span> sqlalchemy.orm <span style="color: #a020f0;">import</span> sessionmaker
<span style="color: #a020f0;">from</span> sqlalchemy.ext.declarative <span style="color: #a020f0;">import</span> declarative_base
<span style="color: #a020f0;">from</span> sqlalchemy.orm.state <span style="color: #a020f0;">import</span> InstanceState
<span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> or_, and_, not_
<span style="color: #a020f0;">import</span> enum
<span style="color: #a020f0;">from</span> sqlalchemy <span style="color: #a020f0;">import</span> func

<span style="color: #a0522d;">Base</span> = declarative_base() <span style="color: #b22222;"># </span><span style="color: #b22222;">&#22522;&#31867;</span>

<span style="color: #a0522d;">IP</span> = <span style="color: #8b2252;">'192.168.1.6'</span>
<span style="color: #a0522d;">USERNAME</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">PASSWORD</span> = <span style="color: #8b2252;">'lqx'</span>
<span style="color: #a0522d;">DBNAME</span> =<span style="color: #8b2252;">'test'</span>
<span style="color: #a0522d;">PORT</span> = 3306
<span style="color: #a0522d;">engine</span> = create_engine(<span style="color: #8b2252;">"mysql+pymysql://{}:{}@{}:{}/{}"</span>.<span style="color: #483d8b;">format</span>(
    USERNAME, PASSWORD, IP, PORT, DBNAME
), echo=<span style="color: #008b8b;">True</span>)

<span style="color: #a0522d;">Session</span> = sessionmaker(bind=engine)
<span style="color: #a0522d;">session</span> = Session()

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">MyEnum</span>(enum.Enum):
    <span style="color: #a0522d;">M</span> = <span style="color: #8b2252;">'M'</span>
    <span style="color: #a0522d;">F</span> = <span style="color: #8b2252;">'F'</span>

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#21360;&#20989;&#25968;</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">show</span>(emps):
    <span style="color: #a020f0;">for</span> x <span style="color: #a020f0;">in</span> emps:
        <span style="color: #483d8b;">print</span>(x)
    <span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'~~~~~~~~~~~~</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Employee</span>(Base):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#34920;&#21517;</span>
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">'employees'</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#31867;&#23646;&#24615;&#23545;&#24212;&#23383;&#27573;</span>
    <span style="color: #a0522d;">emp_no</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">birth_date</span> = Column(Date, nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">first_name</span> = Column(String(14), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">last_name</span> = Column(String(16), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">gender</span> = Column(Enum(MyEnum), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">hire_date</span> = Column(Date, nullable=<span style="color: #008b8b;">False</span>)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;{} no={}, name={}, gender={}&gt;"</span>.<span style="color: #483d8b;">format</span>(
            __class__.<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>.emp_no, <span style="color: #8b2252;">"{} {}"</span>.<span style="color: #483d8b;">format</span>(
                <span style="color: #a020f0;">self</span>.first_name, <span style="color: #a020f0;">self</span>.last_name), <span style="color: #a020f0;">self</span>.gender.value
        )

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Department</span>(Base):
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">'departments'</span>

    <span style="color: #a0522d;">dept_no</span> = Column(String(4), primary_key=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">dept_name</span> = Column(String(40), nullable=<span style="color: #008b8b;">False</span>, unique=<span style="color: #008b8b;">True</span>)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"{} no={} name={}"</span>.<span style="color: #483d8b;">format</span>(
            <span style="color: #483d8b;">type</span>(<span style="color: #a020f0;">self</span>).<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>.dept_no, <span style="color: #a020f0;">self</span>.dept_name)

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Dept_emp</span>(Base):
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">'dept_emp'</span>

    <span style="color: #a0522d;">emp_no</span> = Column(Integer, ForeignKey(<span style="color: #8b2252;">'employees.emp_no'</span>,
                    ondelete=<span style="color: #8b2252;">'CASCADE'</span>), primary_key=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">dept_no</span> = Column(String(4), ForeignKey(<span style="color: #8b2252;">'depatments.dept_no'</span>, ondelete=<span style="color: #8b2252;">'CASCADE'</span>),
                     primary_key=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">from_date</span> = Column(Date, nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">to_date</span> = Column(Date, nullable=<span style="color: #008b8b;">False</span>)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"{} empno={} deptno={}"</span>.<span style="color: #483d8b;">format</span>(
            <span style="color: #483d8b;">type</span>(<span style="color: #a020f0;">self</span>).<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>.emp_no, <span style="color: #a020f0;">self</span>.dept_no)
</pre>
</div>

<p>
ForeignKey('employees.emp_no', ondelete='CASCADE')定义外键约束
</p>

<p>
需求：查询10010员工的所在的部门编号及员工信息
</p>

<ul class="org-ul">
<li>1、使用隐式内连接</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#35810;10010&#21592;&#24037;&#30340;&#25152;&#22312;&#30340;&#37096;&#38376;&#32534;&#21495;&#21450;&#21592;&#24037;&#20449;&#24687;</span>
<span style="color: #a0522d;">results</span> = session.query(Employee, Dept_emp).<span style="color: #483d8b;">filter</span>(
    Employee.emp_no == Dept_emp.emp_no).<span style="color: #483d8b;">filter</span>(Employee.emp_no == 10010).<span style="color: #483d8b;">all</span>()

show(results)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#35810;&#32467;&#26524;2&#34892;</span>
(&lt;Employee no=10010, name=Duangkaew Piveteau, gender=F&gt;, Dept_emp empno=10010 deptno=d004)
(&lt;Employee no=10010, name=Duangkaew Piveteau, gender=F&gt;, Dept_emp empno=10010 deptno=d006)
</pre>
</div>

<p>
这种方式会产生隐式连接的语句
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">SELECT</span> * 
<span style="color: #a020f0;">FROM</span> employees, dept_emp 
<span style="color: #a020f0;">WHERE</span> employees.emp_no = dept_emp.emp_no <span style="color: #a020f0;">AND</span> employees.emp_no = 10010
</pre>
</div>

<ul class="org-ul">
<li>2、使用join</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#35810;10010&#21592;&#24037;&#30340;&#25152;&#22312;&#30340;&#37096;&#38376;&#32534;&#21495;&#21450;&#21592;&#24037;&#20449;&#24687;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#19968;&#31181;&#20889;&#27861;</span>
<span style="color: #a0522d;">results</span> = session.query(Employee).join(Dept_emp).<span style="color: #483d8b;">filter</span>(Employee.emp_no == 10010).<span style="color: #483d8b;">all</span>()

&#31532;&#20108;&#31181;&#20889;&#27861;
<span style="color: #a0522d;">results</span> = session.query(Employee).join(Dept_emp,
            Employee.emp_no == Dept_emp.emp_no).<span style="color: #483d8b;">filter</span>(Employee.emp_no == 10010).<span style="color: #483d8b;">all</span>()

show(results)
</pre>
</div>

<p>
这两种写法，返回都只有一行数据，为什么？
</p>

<ul class="org-ul">
<li>它们生成的SQL语句是一样的，执行该SQL语句返回确实是2行记录，可是Python中的返回值列表中只有一个元素？</li>
<li>原因在于 query(Employee) 这个只能返回一个实体对象中去，为了解决这个问题，需要修改实体类Employee，增加属性用来存放部门信息</li>
</ul>

<p>
sqlalchemy.orm.relationship(实体类名字符串), 需导入from sqlalchemy.orm import sessionmaker,relationship
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> sqlalchemy.orm <span style="color: #a020f0;">import</span> sessionmaker,relationship

<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Employee</span>(Base):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25351;&#23450;&#34920;&#21517;</span>
    <span style="color: #a0522d;">__tablename__</span> = <span style="color: #8b2252;">'employees'</span>

    <span style="color: #b22222;"># </span><span style="color: #b22222;">&#23450;&#20041;&#31867;&#23646;&#24615;&#23545;&#24212;&#23383;&#27573;</span>
    <span style="color: #a0522d;">emp_no</span> = Column(Integer, primary_key=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">birth_date</span> = Column(Date, nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">first_name</span> = Column(String(14), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">last_name</span> = Column(String(16), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">gender</span> = Column(Enum(MyEnum), nullable=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">hire_date</span> = Column(Date, nullable=<span style="color: #008b8b;">False</span>)

    <span style="color: #a0522d;">departmens</span> = relationship(<span style="color: #8b2252;">'Dept_emp'</span>) <span style="color: #b22222;">#</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>): <span style="color: #b22222;"># </span><span style="color: #b22222;">&#27880;&#24847;&#22686;&#21152;self.dept_emps</span>
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"&lt;{} no={}, name={}, gender={} depts={}&gt;"</span>.<span style="color: #483d8b;">format</span>(
            __class__.<span style="color: #483d8b;">__name__</span>, <span style="color: #a020f0;">self</span>.emp_no, <span style="color: #8b2252;">"{} {}"</span>.<span style="color: #483d8b;">format</span>(
            <span style="color: #a020f0;">self</span>.first_name, <span style="color: #a020f0;">self</span>.last_name), <span style="color: #a020f0;">self</span>.gender.value,
            <span style="color: #a020f0;">self</span>.departmens
        )
</pre>
</div>

<p>
查询信息
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">&#26597;&#35810;10010&#21592;&#24037;&#30340;&#25152;&#22312;&#30340;&#37096;&#38376;&#32534;&#21495;&#21450;&#21592;&#24037;&#20449;&#24687;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#19968;&#31181;</span>
<span style="color: #a0522d;">results</span> = session.query(Employee).join(Dept_emp).<span style="color: #483d8b;">filter</span>(
            Employee.emp_no == Dept_emp.emp_no).<span style="color: #483d8b;">filter</span>(Employee.emp_no == 10010)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#20108;&#31181;</span>
<span style="color: #a0522d;">results</span> = session.query(Employee).join(Dept_emp,
            Employee.emp_no == Dept_emp.emp_no).fiter(Employee.emp_no == 10010)

<span style="color: #b22222;"># </span><span style="color: #b22222;">&#31532;&#19977;&#31181;</span>
<span style="color: #a0522d;">results</span> = session.query(Employee).join(Dept_emp, 
            (Employee.emp_no == Dept_emp.emp_no) &amp; (Employee.emp_no == 10010))
show(results.<span style="color: #483d8b;">all</span>()) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25171;&#21360;&#32467;&#26524;</span>
</pre>
</div>

<ul class="org-ul">
<li>第一种方法join(Dept_emp)中没有等值条件，会自动生成一个等值条件，如果后面有filter，哪怕是filter(Employee.emp_no == Dept_emp.emp_no)，这个条件会在where中出现。第一种这种自动增加join的等值条件的方式不好，不要这么写</li>
<li>第二种方法在join中增加等值条件，阻止了自动的等值条件的生成。这种方式推荐</li>
<li>第三种方法就是第二种，这种方式也可以</li>
</ul>

<p>
再看一个现象
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">results</span> = session.query(Employee).join(Dept_emp).<span style="color: #483d8b;">filter</span>(
            Employee.emp_no == Dept_emp.emp_no).<span style="color: #483d8b;">filter</span>(Employee.emp_no == 10010)

<span style="color: #a020f0;">for</span> x <span style="color: #a020f0;">in</span> results:
    <span style="color: #483d8b;">print</span>(x.emp_no)
</pre>
</div>

<p>
可以看出只要不访问departments属性，就不会查dept_emp这张表
</p>
</div>
</div>
</div>
<div id="outline-container-h:3ca000e3-a10d-4793-a885-74f0466c633a" class="outline-4">
<h4 id="h:3ca000e3-a10d-4793-a885-74f0466c633a">总结</h4>
<div class="outline-text-4" id="text-h:3ca000e3-a10d-4793-a885-74f0466c633a">
<p>
在开发中，一般都会采用ORM框架，这样就可以使用对象操作表了。
</p>

<p>
定义表映射的类，使用Column的描述器定义类属性，使用ForeignKey来定义外键约束。
</p>

<p>
如果在一个对象中，想查看其它表对应的对象的内容，就要使用relationship来定义关系。
</p>

<p>
是否使用外键约束？
</p>
<ul class="org-ul">
<li>力挺派，能使数据保持完整性一致性。</li>
<li>弃用派，开发难度增加，大量数据的时候影响插入、修改、删除的效率。在业务层保证数据的一致性。</li>
</ul>
</div>
</div>
</div>
</section>
<section id="outline-container-h:2965f98f-474e-4dc3-86ab-20d9658624ef" class="outline-2">
<h2 id="h:2965f98f-474e-4dc3-86ab-20d9658624ef">Django ORM</h2>
<div class="outline-text-2" id="text-h:2965f98f-474e-4dc3-86ab-20d9658624ef">
<p>
django官网<a href="https://www.djangoproject.com/download/">https://www.djangoproject.com/download/</a>
</p>

<p>
文档<a href="https://docs.djangoproject.com/">https://docs.djangoproject.com/</a>
</p>

<p>
对模型对象的CRUD，被Django ORM转换成相应的SQL语句以操作不同的数据源。
</p>
</div>
<div id="outline-container-h:3759b116-a26c-44c6-bd3d-d041ca3d6023" class="outline-3">
<h3 id="h:3759b116-a26c-44c6-bd3d-d041ca3d6023">安装Django</h3>
<div class="outline-text-3" id="text-h:3759b116-a26c-44c6-bd3d-d041ca3d6023">
<p>
安装官网LTS版本
</p>

<div class="org-src-container">
<pre class="src src-sh">python -m pip install <span style="color: #a0522d;">Django</span>==5.1.7
</pre>
</div>

<p>
Django命令
</p>
<div class="org-src-container">
<pre class="src src-sh">(.venv) PS D:\project\pyproj\pycharm&gt; django-admin    

Type <span style="color: #8b2252;">'django-admin help &lt;subcommand&gt;'</span> for help on a specific subcommand.

Available subcommands:

[django]
    check
    compilemessages
    createcachetable
    dbshell
    diffsettings
    dumpdata
    flush
    inspectdb
    loaddata
    makemessages
    makemigrations <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36801;&#31227;</span>
    migrate
    optimizemigration
    runserver <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21551;&#21160;</span>
    sendtestemail
    shell
    showmigrations
    sqlflush
    sqlmigrate
    sqlsequencereset
    squashmigrations
    startapp
    startproject <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#39033;&#30446;</span>
    <span style="color: #483d8b;">test</span>
    testserver
Note that only Django core commands are listed as settings are not properly configured (error: Requested setting INSTALLED_APPS, but settings a
re not configured. You must either define the environment variable DJANGO_SETTINGS_MODULE or call settings.configure() before accessing settings.)<span style="color: #483d8b;">.</span>
</pre>
</div>

<p>
startproject
</p>
<ul class="org-ul">
<li>创建Django项目</li>
<li>语法：django-admin startproject name [directory]</li>
<li>命令默认在当前目录创建一个文件夹，文件夹下包含manage.py文件以及工程文件夹，在工程文件夹下包含settings.py文件和其他必要文件。</li>
<li>django-admin startproject stduTest与django-admin startproject stduTest .的区别
<ul class="org-ul">
<li>不带点，会多新建一个文件夹</li>
<li>带点，当前目录创建</li>
</ul></li>
</ul>

<p>
startapp
</p>
<ul class="org-ul">
<li>python manage.py startapp &lt;app name&gt;</li>
<li>在manage管理的这个项目下创建一个app</li>
</ul>

<p>
makemigrations
</p>
<ul class="org-ul">
<li>python manage.py makemigrations</li>
<li>在manage管理的这个项目下创建迁移文件</li>
</ul>

<p>
migrate
</p>
<ul class="org-ul">
<li>执行迁移</li>
<li>python manage.py migrate</li>
<li>当需要迁移的时候，执行迁移，第一次建议完全迁移</li>
<li>migrate后接app名，便是迁移某个app
<ul class="org-ul">
<li>python manage.py migrate &lt;app name&gt;</li>
</ul></li>
</ul>

<p>
createsuperuser
</p>
<ul class="org-ul">
<li>创建管理员用户和密码</li>
<li>python manage.py createsuperuser</li>
</ul>

<p>
runserver
</p>
<ul class="org-ul">
<li>启动一个测试用的server</li>
<li>python manage.py runserver 0.0.0.0:8080
<ul class="org-ul">
<li>直接就可以访问本机的8080端口</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-h:a604b154-92cb-441a-a869-a65a2012eddc" class="outline-3">
<h3 id="h:a604b154-92cb-441a-a869-a65a2012eddc">项目准备</h3>
<div class="outline-text-3" id="text-h:a604b154-92cb-441a-a869-a65a2012eddc">
<div class="org-src-container">
<pre class="src src-sh">django-admin startproject salary .

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#24212;&#29992;</span>
python manage.py startapp employee
</pre>
</div>

<p>
范例：
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#21019;&#24314;&#39033;&#30446;</span>
django-admin startproject salary .

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20250;&#29983;&#25104;&#39033;&#30446;&#30446;&#24405;&#21644;manage.py&#25991;&#20214;</span>
./
- salary/
- manage.py

python manage.py <span style="color: #b22222;">#</span><span style="color: #b22222;">django-admin&#33021;&#20570;&#30340;&#20107;&#65292;manage.py&#22522;&#26412;&#19978;&#37117;&#33021;&#20570;</span>
Type <span style="color: #8b2252;">'manage.py help &lt;subcommand&gt;'</span> for help on a specific subcommand.

Available subcommands:

[auth]
    changepassword
    createsuperuser

[contenttypes]
    remove_stale_contenttypes

[django]
    check
    compilemessages
    createcachetable
    dbshell
    diffsettings
    dumpdata
    flush
    inspectdb
    loaddata
    makemessages
    makemigrations
    migrate
    optimizemigration
    sendtestemail
    shell
    showmigrations
    sqlflush
    sqlmigrate
    sqlsequencereset
    squashmigrations
    startapp
    startproject
    <span style="color: #483d8b;">test</span>
    testserver

[sessions]
    clearsessions

[staticfiles]
    collectstatic
    findstatic
    runserver


python manage.py startapp --help
usage: manage.py startapp [-h] [--template TEMPLATE] [--extension EXTENSIONS] [--name FILES] [--exclude [EXCLUDE]] [--version] [-v {0,1,2,3}]
                          [--settings SETTINGS] [--pythonpath PYTHONPATH] [--traceback] [--no-color] [--force-color]
                          name [directory]

Creates a Django app directory structure for the given app name<span style="color: #a020f0;"> in</span> the current directory or optionally<span style="color: #a020f0;"> in</span> the given directory.

positional arguments:
  name                  Name of the application or project.
  directory             Optional destination directory

options:
  -h, --help            show this help message and exit
  --template TEMPLATE   The path or URL to load the template from.
  --extension, -e EXTENSIONS
                        The file extension(s) to render (default: <span style="color: #8b2252;">"py"</span>)<span style="color: #483d8b;">.</span> Separate multiple extensions with commas, or use -e multiple times.   
  --name, -n FILES      The file name(s) to render. Separate multiple file names with commas, or use -n multiple times.
  --exclude, -x [EXCLUDE]
                        The directory name(s) to exclude,<span style="color: #a020f0;"> in</span> addition to .git and __pycache__. Can be used multiple times.
  --version             Show program<span style="color: #8b2252;">'s version number and exit.</span>
<span style="color: #8b2252;">  -v, --verbosity {0,1,2,3}</span>
<span style="color: #8b2252;">                        Verbosity level; 0=minimal output, 1=normal output, 2=verbose output, 3=very verbose output</span>
<span style="color: #8b2252;">  --settings SETTINGS   The Python path to a settings module, e.g. "myproject.settings.main". If this isn'</span>t provided, the
                        DJANGO_SETTINGS_MODULE environment variable will be used.
  --pythonpath PYTHONPATH
                        A directory to add to the Python path, e.g. <span style="color: #8b2252;">"/home/djangoprojects/myproject"</span>.
  --traceback           Raise on CommandError exceptions.
  --no-color            Don<span style="color: #8b2252;">'t colorize the command output.</span>
<span style="color: #8b2252;">  --force-color         Force colorization of the command output.</span>

<span style="color: #8b2252;">#&#21019;&#24314;&#24212;&#29992;</span>
<span style="color: #8b2252;">python manage.py startapp employee</span>

<span style="color: #8b2252;">./</span>
<span style="color: #8b2252;">- employee/</span>
<span style="color: #8b2252;">- salary/</span>
<span style="color: #8b2252;">- manage.py</span>
</pre>
</div>

<p>
会生成一个应用名命名的文件夹
</p>

<p>
配置: 打开salary/settings.py主配置文件
-​ 修改数据库
-​ 配置修改时区
-​ 注册应用
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#20135;&#29615;&#22659;&#19979;&#19968;&#23450;&#35201;&#25226;DEBUG&#35774;&#32622;&#20026;False</span>
DEBUG = True

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#27880;&#20876;&#24212;&#29992;&#65292;&#28155;&#21152;&#19978;&#33258;&#24049;&#30340;&#24212;&#29992;</span>
INSTALLED_APPS = [
    <span style="color: #8b2252;">'django.contrib.admin'</span>,
    <span style="color: #8b2252;">'django.contrib.auth'</span>,
    <span style="color: #8b2252;">'django.contrib.contenttypes'</span>,
    <span style="color: #8b2252;">'django.contrib.sessions'</span>,
    <span style="color: #8b2252;">'django.contrib.messages'</span>,
    <span style="color: #8b2252;">'django.contrib.staticfiles'</span>,
    <span style="color: #8b2252;">'employee'</span>,         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#19978;&#33258;&#24049;&#30340;&#21018;&#21018;&#21019;&#24314;&#30340;&#24212;&#29992;</span>
]

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#25968;&#25454;&#24211;&#37197;&#32622;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">https://docs.djangoproject.com/en/5.1/ref/settings/#databases</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">ENGINE &#35201;&#20351;&#29992;&#30340;&#25968;&#25454;&#24211;&#21518;&#31471;&#12290;&#20869;&#32622;&#30340;&#25968;&#25454;&#24211;&#21518;&#31471;&#26377;&#65306;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">- 'django.db.backends.postgresql'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">- 'django.db.backends.mysql'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">- 'django.db.backends.sqlite3'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">- 'django.db.backends.oracle'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21152;&#19978;&#33258;&#24049;&#25968;&#25454;&#24211;&#30340;&#37197;&#32622;&#27573;</span>
DATABASES = {
    <span style="color: #8b2252;">'default'</span>: {
        <span style="color: #8b2252;">'ENGINE'</span>: <span style="color: #8b2252;">'django.db.backends.mysql'</span>,
        <span style="color: #8b2252;">'NAME'</span>: <span style="color: #8b2252;">'test'</span>,   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25968;&#25454;&#24211;&#21517;</span>
        <span style="color: #8b2252;">'USER'</span>: <span style="color: #8b2252;">'root'</span>,     <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29992;&#25143;&#21517;</span>
        <span style="color: #8b2252;">'PASSWORD'</span>: <span style="color: #8b2252;">'123456'</span>,   <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23494;&#30721;</span>
        <span style="color: #8b2252;">'HOST'</span>: <span style="color: #8b2252;">'10.0.0.12'</span>,        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#26426;</span>
        <span style="color: #8b2252;">'PORT'</span>: <span style="color: #8b2252;">'3306'</span>,         <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31471;&#21475;</span>
    }
}
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#26102;&#21306;</span>
TIME_ZONE = <span style="color: #8b2252;">'Asia/Shanghai'</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#35821;&#35328;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">LANGUAGE_CODE = 'en-us'</span>
LANGUAGE_CODE = <span style="color: #8b2252;">'zh-Hans'</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20462;&#25913;&#20840;&#23616;&#30340;&#32534;&#30721;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#38656;&#35201;&#28155;&#21152;DEFAULT_CHARSET&#20851;&#38190;&#23383;</span>
<span style="color: #a0522d;">DEFAULT_CHARSET</span>=<span style="color: #8b2252;">'utf-8'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#40664;&#35748;utf-8</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:2a5adeba-8a25-48e5-908f-773af9ff887c" class="outline-3">
<h3 id="h:2a5adeba-8a25-48e5-908f-773af9ff887c">Django日志</h3>
<div class="outline-text-3" id="text-h:2a5adeba-8a25-48e5-908f-773af9ff887c">
<p>
<a href="https://docs.djangoproject.com/en/5.1/topics/logging/#configuring-logging">https://docs.djangoproject.com/en/5.1/topics/logging/#configuring-logging</a>
</p>

<p>
logger： <a href="https://docs.djangoproject.com/zh-hans/5.1/ref/logging/#loggers">https://docs.djangoproject.com/zh-hans/5.1/ref/logging/#loggers</a>
</p>

<p>
Django的日志配置在setting.py中
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;"># </span><span style="color: #b22222;">logging DEBUG=True</span>
<span style="color: #a0522d;">LOGGING</span> = {
    <span style="color: #8b2252;">"version"</span>: 1,
    <span style="color: #8b2252;">"disable_existing_loggers"</span>: <span style="color: #008b8b;">False</span>,
    <span style="color: #8b2252;">"handlers"</span>: {
        <span style="color: #8b2252;">"console"</span>: {
            <span style="color: #8b2252;">"class"</span>: <span style="color: #8b2252;">"logging.StreamHandler"</span>,
        },
    },
    <span style="color: #8b2252;">"loggers"</span>: {
        <span style="color: #8b2252;">"django.db.backends"</span>: {
            <span style="color: #8b2252;">"handlers"</span>: [<span style="color: #8b2252;">"console"</span>],
            <span style="color: #8b2252;">"level"</span>: <span style="color: #8b2252;">"DEBUG"</span>,
        },
    },
}
</pre>
</div>

<p>
配置后，就可以在控制台看到执行的SQL语句。
</p>

<p>
注意，settings.py中必须DEBUG=True，同时loggers的level是DEBUG，否则从控制台看不到SQL语句。
</p>
</div>
</div>
<div id="outline-container-h:d5acbe98-f8d7-435d-96b4-72c25c45e341" class="outline-3">
<h3 id="h:d5acbe98-f8d7-435d-96b4-72c25c45e341">模型Model</h3>
<div class="outline-text-3" id="text-h:d5acbe98-f8d7-435d-96b4-72c25c45e341">
</div>
<div id="outline-container-h:f547c637-6b13-4738-8c5e-03e7ea831c82" class="outline-4">
<h4 id="h:f547c637-6b13-4738-8c5e-03e7ea831c82">字段类型</h4>
<div class="outline-text-4" id="text-h:f547c637-6b13-4738-8c5e-03e7ea831c82">
<p>
<a href="https://docs.djangoproject.com/zh-hans/5.1/ref/models/fields/#field-options">官方文档</a>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">字段类</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">AutoField</td>
<td class="org-left">自增的整数字段。如果不指定，django会为模型类自动增加主键字段</td>
</tr>

<tr>
<td class="org-left">BooleanField</td>
<td class="org-left">布尔值字段，True和False。对应表单控件CheckboxInput</td>
</tr>

<tr>
<td class="org-left">NullBooleanField</td>
<td class="org-left">比BooleanField多一个null值</td>
</tr>

<tr>
<td class="org-left">CharField</td>
<td class="org-left">字符串，max_length设定字符长度。对应表单控件TextInput</td>
</tr>

<tr>
<td class="org-left">TextField</td>
<td class="org-left">大文本字段，一般超过4000个字符使用。对应表单控件Textarea</td>
</tr>

<tr>
<td class="org-left">IntegerField</td>
<td class="org-left">整数字段, 一般4字节</td>
</tr>

<tr>
<td class="org-left">BigIntegerField</td>
<td class="org-left">更大整数字段，8字节</td>
</tr>

<tr>
<td class="org-left">DecimalField</td>
<td class="org-left">使用Python的Decimal实例表示十进制浮点数。max_digits总位数，decimal_places小数点后的位数</td>
</tr>

<tr>
<td class="org-left">FloatField</td>
<td class="org-left">Python的Float实例表示的浮点数</td>
</tr>

<tr>
<td class="org-left">DateField</td>
<td class="org-left">使用Python的datetime.date实例表示的日期</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">auto_now=False每次修改对象自动设置为当前时间。</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">auto_now_add=False对象第一次创建时自动设置为当前时间。</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">auto_now_add、auto_now、default互斥。</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">对应控件为TextInput，关联了一个Js编写的日历控件</td>
</tr>

<tr>
<td class="org-left">TimeField</td>
<td class="org-left">使用Python的datetime.time实例表示的时间，参数同上</td>
</tr>

<tr>
<td class="org-left">DateTimeField</td>
<td class="org-left">使用Python的datetime.datetime实例表示的时间，参数同上</td>
</tr>

<tr>
<td class="org-left">FileField</td>
<td class="org-left">一个上传文件的字段</td>
</tr>

<tr>
<td class="org-left">ImageField</td>
<td class="org-left">继承了FileField的所有属性和方法，但是对上传的文件进行校验，确保是一个有效的图片</td>
</tr>

<tr>
<td class="org-left">EmailField</td>
<td class="org-left">能做Email检验，基于CharField，默认max_length=254</td>
</tr>

<tr>
<td class="org-left">GenericIPAddressField</td>
<td class="org-left">支持IPv4、IPv6检验，缺省对应文本框输入</td>
</tr>

<tr>
<td class="org-left">URLField</td>
<td class="org-left">能做URL检验，基于基于CharField，默认max_length=200</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-h:5c3e9f8f-69ce-4fde-b51e-8e88bd330574" class="outline-4">
<h4 id="h:5c3e9f8f-69ce-4fde-b51e-8e88bd330574">缺省主键</h4>
<div class="outline-text-4" id="text-h:5c3e9f8f-69ce-4fde-b51e-8e88bd330574">
<p>
缺省情况下，Django的每一个Model都有一个名为id的AutoField字段，如下
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #483d8b;">id</span> = models.AutoField(primary_key=<span style="color: #008b8b;">True</span>)
</pre>
</div>

<p>
如果显式定义了主键，这种缺省主键就不会被创建了。Python之禅中说“显示优于隐式”，所以，尽量使用自己定义的主键，
哪怕该字段就是id，也是一种不错的选择。
</p>
</div>
</div>
<div id="outline-container-h:aed09529-8bc0-4c87-8f72-a509bb8fe8b1" class="outline-4">
<h4 id="h:aed09529-8bc0-4c87-8f72-a509bb8fe8b1">字段选项</h4>
<div class="outline-text-4" id="text-h:aed09529-8bc0-4c87-8f72-a509bb8fe8b1">
<p>
<a href="https://docs.djangoproject.com/zh-hans/5.1/ref/models/fields/#field-options">官方文档</a>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">值</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">db_column</td>
<td class="org-left">表中字段的名称。如果未指定，则使用属性名</td>
</tr>

<tr>
<td class="org-left">primary_key</td>
<td class="org-left">是否主键</td>
</tr>

<tr>
<td class="org-left">unique</td>
<td class="org-left">是否是唯一键</td>
</tr>

<tr>
<td class="org-left">default</td>
<td class="org-left">缺省值。这个缺省值不是数据库字段的缺省值，而是新对象产生的时候被填入的缺省值</td>
</tr>

<tr>
<td class="org-left">null</td>
<td class="org-left">表的字段是否可为null，默认为False</td>
</tr>

<tr>
<td class="org-left">blank</td>
<td class="org-left">Django表单验证中，如果True，则允许该字段为空。默认为False</td>
</tr>

<tr>
<td class="org-left">db_index</td>
<td class="org-left">字段是否有索引</td>
</tr>

<tr>
<td class="org-left">to_field</td>
<td class="org-left">关联对象的字段。默认情况下，Django 使用相关对象的主键。如果你引用了一个不同的字段，这个字段必须有 unique=True</td>
</tr>
</tbody>
</table>

<p>
关系类型字段类
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">类</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">ForeignKey</td>
<td class="org-left">外键，表示一对多</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">ForeignKey('production.Manufacturer')</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">自关联ForeignKey('self')</td>
</tr>

<tr>
<td class="org-left">ManyToManyField</td>
<td class="org-left">表示多对多</td>
</tr>

<tr>
<td class="org-left">OneToOneField</td>
<td class="org-left">表示一对一</td>
</tr>
</tbody>
</table>

<p>
一对多时，自动创建会增加_id后缀。
</p>
<ul class="org-ul">
<li>从一访问多，使用 <code>对象.小写模型类_set</code></li>
<li>从一访问一，使用 <code>对象.小写模型类</code></li>
</ul>

<p>
访问id <code>对象.属性_id</code>
</p>
</div>
</div>
<div id="outline-container-h:561d82ff-db2f-4a24-b064-dd02f010269e" class="outline-4">
<h4 id="h:561d82ff-db2f-4a24-b064-dd02f010269e">Model类</h4>
<div class="outline-text-4" id="text-h:561d82ff-db2f-4a24-b064-dd02f010269e">
<ul class="org-ul">
<li>基类 django.db.models.Model</li>
<li>表名不指定默认使用 <code>&lt;appname&gt;_&lt;model_name&gt;</code> 。使用Meta类修改表名</li>
</ul>

<p>
由于Django不支持枚举类型字段，为了不引入额外的第三库，将gender字段改为整型。
</p>

<p>
<a href="https://docs.djangoproject.com/zh-hans/5.2/ref/models/options/">模型 Meta 选项</a>
</p>

<p>
编辑应用下的models.py文件（这里是employee/models.py）
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> django.db <span style="color: #a020f0;">import</span> models
<span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">`gender` enum('M','F') NOT NULL,</span>

<span style="color: #8b2252;">CREATE TABLE `employees` (</span>
<span style="color: #8b2252;">  `emp_no` int(11) NOT NULL,</span>
<span style="color: #8b2252;">  `birth_date` date NOT NULL,</span>
<span style="color: #8b2252;">  `first_name` varchar(14) NOT NULL,</span>
<span style="color: #8b2252;">  `last_name` varchar(16) NOT NULL,</span>
<span style="color: #8b2252;">  `gender` smallint(6) NOT NULL DEFAULT 1 COMMENT 'M=1, F=2',</span>
<span style="color: #8b2252;">  `hire_date` date NOT NULL,</span>
<span style="color: #8b2252;">  PRIMARY KEY (`emp_no`)</span>
<span style="color: #8b2252;">) ENGINE=InnoDB DEFAULT CHARSET=utf8; </span>
<span style="color: #8b2252;">"""</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Create your models here.</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Employee</span>(models.Model): <span style="color: #b22222;">#</span><span style="color: #b22222;">metaclass=ModelBase</span>
    <span style="color: #a020f0;">class</span> <span style="color: #228b22;">Meta</span>:
        <span style="color: #a0522d;">db_table</span> = <span style="color: #8b2252;">'employees'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#34920;&#21517;</span>

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#21015;&#21517;&#19968;&#19968;&#26144;&#23556;&#20986;&#26469;</span>
    <span style="color: #a0522d;">emp_no</span> = models.IntegerField(primary_key=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">birth_date</span> = models.DateField(null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">first_name</span> = models.CharField(null=<span style="color: #008b8b;">False</span>, max_length=14) <span style="color: #b22222;">#</span><span style="color: #b22222;">varchar(14) NOT NULL,</span>
    <span style="color: #a0522d;">last_name</span> = models.CharField(null=<span style="color: #008b8b;">False</span>, max_length=16)
    <span style="color: #a0522d;">gender</span> = models.SmallIntegerField(null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">hire_date</span> = models.DateField(null=<span style="color: #008b8b;">False</span>)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#20889;&#21487;&#35270;&#21270;&#25928;&#26524;</span>
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'&lt;Employee {}, {} {}&gt;'</span>.<span style="color: #483d8b;">format</span>(<span style="color: #a020f0;">self</span>.emp_no, <span style="color: #a020f0;">self</span>.first_name, <span style="color: #a020f0;">self</span>.last_name)

    <span style="color: #a0522d;">__str__</span> = __repr__
</pre>
</div>

<p>
在项目根目录编写一段测试代码test.py
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">import</span> django

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#32771;wsgi.py &#21152;&#36733;&#21021;&#22987;&#29615;&#22659;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#31616;&#21333;&#30340;&#36830;&#25509;&#21069;&#65292;&#38656;&#35201;&#23433;&#35013;mysqlclient&#65292;&#20351;&#29992;pip install mysqlclient</span>
os.environ.setdefault(<span style="color: #8b2252;">'DJANGO_SETTINGS_MODULE'</span>, <span style="color: #8b2252;">'salary.settings'</span>)
django.setup()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#25968;&#25454;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#23548;&#20837;&#24517;&#39035;&#22312;&#36830;&#25509;setup&#20043;&#21518;&#65292;&#19981;&#28982;&#20250;&#25253;&#24212;&#29992;&#26410;&#27880;&#20876;</span>
<span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee
<span style="color: #a0522d;">emps</span> = Employee.objects.<span style="color: #483d8b;">all</span>() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#26159;&#25042;&#26597;&#35810;. &#32467;&#26524;&#38598;&#65292;&#26412;&#21477;&#19981;&#21457;&#36215;&#26597;&#35810;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(emps)#&#26597;&#35810;&#38598;</span>
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> emps: <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36941;&#21382;</span>
    <span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(i), i)
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">(0.002) 
                SELECT VERSION(),
                       @@sql_mode,
                       @@default_storage_engine,
                       @@sql_auto_is_null,
                       @@lower_case_table_names,
                       CONVERT_TZ(<span style="color: #8b2252;">'2001-01-01 01:00:00'</span>, <span style="color: #8b2252;">'UTC'</span>, <span style="color: #8b2252;">'UTC'</span>) IS NOT NULL
            ; <span style="color: #a0522d;">args</span>=None; <span style="color: #a0522d;">alias</span>=default
(0.001) SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED; <span style="color: #a0522d;">args</span>=None; <span style="color: #a0522d;">alias</span>=default       
(0.001) SELECT <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`birth_date`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`first_name`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`last_name`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`gender`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`hire_date`</span> FROM <span style="color: #ff00ff;">`employees`</span>; <span style="color: #a0522d;">args</span>=(); <span style="color: #a0522d;">alias</span>=default
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10001, Georgi Facello&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10002, Bezalel Simmel&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10003, Parto Bamford&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10004, Chirstian Koblick&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10005, Kyoichi Maliniak&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10006, Anneke Preusig&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10007, Tzvetan Zielinski&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10008, Saniya Kalloufi&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10009, Sumant Peac&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10010, Duangkaew Piveteau&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10011, Mary Sluis&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10012, Patricio Bridgland&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10013, Eberhardt Terkki&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10014, Berni Genin&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10015, Guoxiang Nooteboom&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10016, Kazuhito Cappelletti&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10017, Cristinel Bouloucos&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10018, Kazuhide Peha&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10019, Lillian Haddadi&gt;
&lt;class <span style="color: #8b2252;">'employee.models.Employee'</span>&gt; &lt;Employee 10020, Mayuko Warwick&gt;
</pre>
</div>
<p>
查出了所有记录
</p>
</div>
</div>
<div id="outline-container-h:d461204e-f33b-4d7a-bca6-f66e82dfe199" class="outline-4">
<h4 id="h:d461204e-f33b-4d7a-bca6-f66e82dfe199">管理器对象</h4>
<div class="outline-text-4" id="text-h:d461204e-f33b-4d7a-bca6-f66e82dfe199">
<p>
Django会为模型类提供一个objects对象，它是
django.db.models.manager.Manager类型，用于与数据库交互。当定义模型类的
时候没有指定管理器，则Django会为模型类提供一个objects的管理器。如果在
模型类中手动指定管理器后，Django不再提供默认的objects的管理器了。
</p>

<p>
管理器是Django的模型进行数据库查询操作的接口，Django应用的每个模型都至少拥有一个管理器。
</p>

<p>
用户也可以自定义管理器类，继承自django.db.models.manager.Manager，实现表级别控制。
</p>

<p>
源码
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">ModelBase</span>(<span style="color: #483d8b;">type</span>):
    <span style="color: #8b2252;">"""Metaclass for all models."""</span>

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__new__</span>(cls, name, bases, attrs, **kwargs):
        <span style="color: #a0522d;">super_new</span> = <span style="color: #483d8b;">super</span>().__new__
        ... ...
        new_class._prepare()

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">_prepare</span>(cls):
        <span style="color: #8b2252;">"""Create some methods once self._meta has been populated."""</span>
        ... ...

        <span style="color: #a020f0;">if</span> <span style="color: #a020f0;">not</span> opts.managers:
            ... ...
            cls.add_to_class(<span style="color: #8b2252;">"objects"</span>, manager)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:25bf302c-5ff1-480d-9d95-822eec195b40" class="outline-3">
<h3 id="h:25bf302c-5ff1-480d-9d95-822eec195b40">查询</h3>
<div class="outline-text-3" id="text-h:25bf302c-5ff1-480d-9d95-822eec195b40">
<p>
<a href="https://docs.djangoproject.com/en/5.2/ref/models/querysets/">QuerySet API 参考</a>
</p>
</div>
<div id="outline-container-h:1d056f89-2f5d-4dc7-9329-aa29c28be264" class="outline-4">
<h4 id="h:1d056f89-2f5d-4dc7-9329-aa29c28be264">查询集</h4>
<div class="outline-text-4" id="text-h:1d056f89-2f5d-4dc7-9329-aa29c28be264">
<p>
查询会返回结果的集，它是django.db.models.query.QuerySet类型。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">import</span> django

os.environ.setdefault(<span style="color: #8b2252;">'DJANGO_SETTINGS_MODULE'</span>, <span style="color: #8b2252;">'salay.settings'</span>)
django.setup()

<span style="color: #b22222;">#</span>
<span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee
<span style="color: #a0522d;">emps</span>=Employee.objects.<span style="color: #483d8b;">all</span>()
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(emps))

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#32467;&#26524;</span>
&lt;<span style="color: #a020f0;">class</span> <span style="color: #8b2252;">'django.db.models.query.QuerySet'</span>&gt;
</pre>
</div>
<p>
它是惰性求值，和sqlalchemy一样。结果就是查询的集。
</p>

<p>
它是可迭代对象。
</p>

<ol class="org-ol">
<li><p>
惰性求值：
</p>

<p>
创建查询集不会带来任何数据库的访问，直到调用方法使用数据时，才会访问数据库。在迭代、序列
化、if语句中都会立即求值。
</p></li>

<li><p>
缓存：
</p>

<p>
每一个查询集都包含一个缓存，来最小化数据库的访问。
</p>

<p>
新建查询集，缓存为空。首次查询集求值时，会发生数据库的查询，Django会把查询的结果存在这个缓存中，并返回请求的结果，接下来对查询集求值将使用缓存的结果。
</p>

<p>
观察下面2个例子是要看真正生成的语句了。
</p>

<ol class="org-ol">
<li>没有使用缓存，每次都要去查库，查了2次库</li>
</ol>

<div class="org-src-container">
<pre class="src src-python">[user.name <span style="color: #a020f0;">for</span> user <span style="color: #a020f0;">in</span> User.objects.<span style="color: #483d8b;">all</span>()]
[user.name <span style="color: #a020f0;">for</span> user <span style="color: #a020f0;">in</span> User.objects.<span style="color: #483d8b;">all</span>()]
</pre>
</div>

<ol class="org-ol">
<li>下面的语句使用缓存，因为使用同一个结果集</li>
</ol>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">qs</span> = User.objects.<span style="color: #483d8b;">all</span>()
[user.name <span style="color: #a020f0;">for</span> user <span style="color: #a020f0;">in</span> qs]
[user.name <span style="color: #a020f0;">for</span> user <span style="color: #a020f0;">in</span> qs]
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-h:5226b3d0-3494-439e-bca0-353187141dab" class="outline-4">
<h4 id="h:5226b3d0-3494-439e-bca0-353187141dab">限制查询集（切片）</h4>
<div class="outline-text-4" id="text-h:5226b3d0-3494-439e-bca0-353187141dab">
<p>
分页功能实现，使用限制查询集。
</p>

<p>
查询集对象可以直接使用索引下标的方式（不支持负索引），相当于SQL语句中的limit和offset子句。注意使用索引返回的新的结果集，依然是惰性求值，不会立即查询。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">import</span> django

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#32771;wsgi.py &#21152;&#36733;&#21021;&#22987;&#29615;&#22659;</span>
os.environ.setdefault(<span style="color: #8b2252;">'DJANGO_SETTINGS_MODULE'</span>, <span style="color: #8b2252;">'salary.settings'</span>)
django.setup()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#25968;&#25454;</span>
<span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee
<span style="color: #a0522d;">mgr</span> = Employee.objects 
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">all</span>()[1:3]) <span style="color: #b22222;">#</span><span style="color: #b22222;">1: 3-1 #LIMIT 2 OFFSET 1</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(mgr.all()[10:30]) #10: 30-10 #LIMIT 20 OFFSET 10</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(mgr.all()[:5])  #0: 5-0  #LIMIT 5</span>
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">(0.005) 
                SELECT VERSION(),
                       @@sql_mode,
                       @@default_storage_engine,
                       @@sql_auto_is_null,
                       @@lower_case_table_names,
                       CONVERT_TZ(<span style="color: #8b2252;">'2001-01-01 01:00:00'</span>, <span style="color: #8b2252;">'UTC'</span>, <span style="color: #8b2252;">'UTC'</span>) IS NOT NULL
            ; <span style="color: #a0522d;">args</span>=None; <span style="color: #a0522d;">alias</span>=default
(0.001) SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED; <span style="color: #a0522d;">args</span>=None; <span style="color: #a0522d;">alias</span>=default
(0.003) SELECT <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`birth_date`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`first_name`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`last_name`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`gender`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`hire_date`</span> FROM <span style="color: #ff00ff;">`employees`</span> LIMIT 2 OFFSET 1; <span style="color: #a0522d;">args</span>=(); <span style="color: #a0522d;">alias</span>=default
&lt;QuerySet [&lt;Employee 10002, Bezalel Simmel&gt;, &lt;Employee 10003, Parto Bamford&gt;]&gt;  
</pre>
</div>
</div>
</div>
<div id="outline-container-h:40e89c21-b858-4060-971c-da7b1162ac1e" class="outline-4">
<h4 id="h:40e89c21-b858-4060-971c-da7b1162ac1e">结果集方法</h4>
<div class="outline-text-4" id="text-h:40e89c21-b858-4060-971c-da7b1162ac1e">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">名称</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">all()</td>
<td class="org-left">所有的</td>
</tr>

<tr>
<td class="org-left">filter()</td>
<td class="org-left">过滤，返回满足条件的数据，如：mgr.filter(emp_no=10010) 如果未查询到，返回空</td>
</tr>

<tr>
<td class="org-left">exlude()</td>
<td class="org-left">排除，排除满足条件的数据，多条排除条件则为and关系</td>
</tr>

<tr>
<td class="org-left">order_by()</td>
<td class="org-left">排序，注意参数是字符串，倒序需要在字符串前面加 - 号，如：mgr.order_by('-emp_no')</td>
</tr>

<tr>
<td class="org-left">values()</td>
<td class="org-left">返回一个对象字典的列表，列表的元素是字典，字典内的字段和值的键值对,将字段以参数的形式带入，可以控制投影的字段</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">mgr</span> =Employee.objects
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">all</span>())
<span style="color: #483d8b;">print</span>(mgr.values())
<span style="color: #483d8b;">print</span>(mgr.values(<span style="color: #8b2252;">'pk'</span>,<span style="color: #8b2252;">'first_name'</span>))
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk=10010).values())
<span style="color: #483d8b;">print</span>(mgr.exclude(emp_no=10001))
<span style="color: #483d8b;">print</span>(mgr.exclude(emp_no=10002).order_by(<span style="color: #8b2252;">'emp_no'</span>))
<span style="color: #483d8b;">print</span>(mgr.exclude(emp_no=10002).order_by(<span style="color: #8b2252;">'-pk'</span>))
<span style="color: #483d8b;">print</span>(mgr.exclude(emp_no=10002).order_by(<span style="color: #8b2252;">'-pk'</span>).values())
<span style="color: #b22222;">#</span><span style="color: #b22222;">pk&#23601;&#26159;&#20027;&#38190;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">all\filter\exclude &#36820;&#22238;&#21487;&#36845;&#20195;&#30340;&#26597;&#35810;&#38598;,&#20854;&#20013;&#37117;&#26159;&#23454;&#20363;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">values &#36820;&#22238;&#21487;&#36845;&#20195;&#30340;&#23383;&#20856;&#12290;values&#20013;&#20889;&#20837;&#23383;&#27573;&#21517;&#23601;&#26159;&#25237;&#24433;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">order_by &#36820;&#22238;&#32467;&#26524;&#38598;&#65292;&#25490;&#24207;&#12290; &#23383;&#31526;&#20018;&#21069;&#38754;&#21152;-&#21495;, &#38477;&#24207;</span>
</pre>
</div>

<p>
filter(k1=v1).filter(k2=v2) 等价于 filter(k1=v1, k2=v2)
</p>

<p>
filter(pk=10)这里pk指的就是主键，不用关心主键字段名，当然也可以使用使用主键名filter(emp_no=10)
</p>
</div>
</div>
<div id="outline-container-h:881e5f00-955e-4a95-80b7-cf3268d6a209" class="outline-4">
<h4 id="h:881e5f00-955e-4a95-80b7-cf3268d6a209">返回单个值的方法</h4>
<div class="outline-text-4" id="text-h:881e5f00-955e-4a95-80b7-cf3268d6a209">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">名称</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">get()</td>
<td class="org-left">仅返回单个满足条件的对象</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">如果未能返回对象则抛出DoesNotExist异常；</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">如果能返回多条，抛出MultipleObjectsReturned异常</td>
</tr>

<tr>
<td class="org-left">count()</td>
<td class="org-left">返回当前查询的总条数</td>
</tr>

<tr>
<td class="org-left">first()</td>
<td class="org-left">返回第一个对象，找不到返回None</td>
</tr>

<tr>
<td class="org-left">last()</td>
<td class="org-left">返回最后一个对象，返回最后一个对象，找不到返回None</td>
</tr>

<tr>
<td class="org-left">exists()</td>
<td class="org-left">判断查询集中是否有数据，如果有则返回True</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#25968;&#25454;</span>
<span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee
<span style="color: #a0522d;">mgr</span> = Employee.objects
<span style="color: #a0522d;">x</span> = mgr.<span style="color: #483d8b;">filter</span>(emp_no=10002)
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">bool</span>(x), <span style="color: #483d8b;">len</span>(x)) <span style="color: #b22222;">#</span><span style="color: #b22222;">True 1</span>

<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(emp_no=10002).get()) <span style="color: #b22222;">#</span><span style="color: #b22222;">get&#20005;&#26684;&#19968;&#20010;</span>
<span style="color: #483d8b;">print</span>(mgr.get(emp_no=10002)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#19978;&#31561;&#25928;</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">print(mgr.exclude(emp_no=10002).get()) #&#36820;&#22238;&#22810;&#20010;&#65292;&#25253;&#38169;&#65292;MultipleObjectsReturned</span>
<span style="color: #483d8b;">print</span>(mgr.exclude(emp_no=10002).first()) <span style="color: #b22222;">#</span><span style="color: #b22222;">limit 1</span>
<span style="color: #483d8b;">print</span>(mgr.exclude(emp_no=10002).values(<span style="color: #8b2252;">'pk'</span>).first())
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk=10002, gender=1).first()) <span style="color: #b22222;">#</span><span style="color: #b22222;">AND, &#25214;&#19981;&#21040;&#36820;&#22238;None</span>
<span style="color: #483d8b;">print</span>(mgr.exclude(emp_no=10002).last()) <span style="color: #b22222;">#</span><span style="color: #b22222;">desc, limit 1</span>
<span style="color: #483d8b;">print</span>(mgr.exclude(emp_no=10002).count())
<span style="color: #483d8b;">print</span>(mgr.count())

<span style="color: #b22222;">#</span><span style="color: #b22222;">get&#20005;&#26684;&#35201;&#27714;&#20165;&#36820;&#22238;&#19968;&#20010;&#30340;&#23545;&#35937;,&#22810;&#20110;1&#20010;&#23569;&#20110;1&#20010;&#37117;&#25253;&#38169;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">first &#19968;&#26465;&#25968;&#25454;,limt 1,&#25214;&#19981;&#21040;&#36820;&#22238;None&#12290; last &#20498;&#25490;&#21462;&#31532;&#19968;&#26465;limit 1,&#25214;&#19981;&#21040;&#36820;&#22238;None</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">count &#35745;&#25968;&#65292;&#36820;&#22238;&#19968;&#20010;&#20540;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:812c84cb-99fb-4c4d-a547-c5faabf486aa" class="outline-4">
<h4 id="h:812c84cb-99fb-4c4d-a547-c5faabf486aa">字段查询（Field Lookup）表达式</h4>
<div class="outline-text-4" id="text-h:812c84cb-99fb-4c4d-a547-c5faabf486aa">
<p>
字段查询表达式可以作为filter()、exclude()、get()的参数，实现where子句。
</p>

<p>
语法： <code>属性名称__比较运算符=值</code>
</p>

<p>
注意：属性名和运算符之间使用 <b>双下划线</b>
</p>

<p>
<b>比较运算符如下</b>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">名称</th>
<th scope="col" class="org-left">例子</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">exact</td>
<td class="org-left">filter(emp_no=10002) 等价于SQL语句SELECT &#x2026; WHERE emp_no = 10002;</td>
<td class="org-left">严格等于，可省略不写</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">filter(emp_no__exact=10002) 等价于SQL语句SELECT &#x2026; WHERE emp_no = 10002;</td>
<td class="org-left">严格等于，可省略不写</td>
</tr>

<tr>
<td class="org-left">contains</td>
<td class="org-left">exclude(title__contains='天')等价于SQL语句 SELECT &#x2026; WHERE title LIKE '%天%';</td>
<td class="org-left">是否包含，大小写敏感，等价于like '%天%' 性能低</td>
</tr>

<tr>
<td class="org-left">startswith</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">endswith</td>
<td class="org-left">filter(title__startswith='天')等价于SQL语句SELECT &#x2026; WHERE headline LIKE '天%';</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">filter(headline__endswith='天')等价于SQL语句SELECT &#x2026; WHERE headline LIKE '%天';</td>
<td class="org-left">以什么开头或结尾，大小写敏感</td>
</tr>

<tr>
<td class="org-left">isnull</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">isnotnull</td>
<td class="org-left">filter(pub_date__isnull=True)等价于SQL语句SELECT &#x2026; WHERE pub_date IS NULL;</td>
<td class="org-left">是否为null</td>
</tr>

<tr>
<td class="org-left">iexact</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">icontains</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">istartswith</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">iendswith</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">i的意思是忽略大小写</td>
</tr>

<tr>
<td class="org-left">in</td>
<td class="org-left">filter(emp_no__in=[1,2,3,100])等价于SQL语句SELECT &#x2026; WHERE emp_no IN (1,2,3 100);</td>
<td class="org-left">是否在指定范围数据中</td>
</tr>

<tr>
<td class="org-left">gt、gte</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">lt、lte</td>
<td class="org-left">filter(id__gt=3)等价于SQL语句SELECT &#x2026; WHERE id&gt;3;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">filter(id__lte=6)等价于SQL语句SELECT &#x2026; WHERE id&lt;=6;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">filter(pub_date__gt=datetime.date(2000,1,1))等价于SQL语句SELECT &#x2026; WHERE pub_date &gt; 2000-1-1;</td>
<td class="org-left">大于，大于等于</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">小于，小于等于</td>
</tr>

<tr>
<td class="org-left">year、month、dayweek_dayhour、minute、second</td>
<td class="org-left">filter(pub_date__year=2000)等价于SELECT &#x2026; WHERE pub_date between '2000-01-01' and '2000-12-31'</td>
<td class="org-left">对日期类型属性处理</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#25968;&#25454;</span>
<span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee
<span style="color: #a0522d;">mgr</span> = Employee.objects
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(emp_no__exact=10002)) <span style="color: #b22222;">#</span><span style="color: #b22222;">WHERE emp_no = 10002</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10002)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22823;&#20110;WHERE emp_no &gt; 10002</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gte=10002)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#22823;&#20110;&#31561;&#20110;WHERE emp_no &gt;= 10002</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__lt=10002)) <span style="color: #b22222;">#</span><span style="color: #b22222;">WHERE emp_no &lt; 10002</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__lte=10002)) <span style="color: #b22222;">#</span><span style="color: #b22222;">WHERE emp_no &lt;= 10002</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10002, gender=1)) <span style="color: #b22222;">#</span><span style="color: #b22222;">WHERE emp_no &gt; 10002 AND gender = 1</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10002, last_name__startswith=<span style="color: #8b2252;">'P'</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;P&#24320;&#22836; WHERE emp_no &gt; 10002 AND last_name LIKE  BINARY 'P%'</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10002, last_name__istartswith=<span style="color: #8b2252;">'P'</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24573;&#30053;&#22823;&#23567;&#20889;WHERE emp_no &gt; 10002 AND last_name LIKE 'P%'</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10002).<span style="color: #483d8b;">filter</span>(last_name__istartswith=<span style="color: #8b2252;">'P'</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21516;&#19978;&#31561;&#20215;</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(last_name__icontains=<span style="color: #8b2252;">'ea'</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#21253;&#21547;&#65292;&#24573;&#30053;&#22823;&#23567;&#20889;&#12290;&#24615;&#33021;&#22826;&#20302;&#65292;&#33021;&#19981;&#29992;&#23601;&#19981;&#29992;&#12290;WHERE last_name LIKE '%ea%'</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__in=[10002,10003])) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#33539;&#22260;tuple,list,&#38598;&#21512;&#37117;&#21487; WHERE emp_no IN (10002,10003)</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__in=(10000+i <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(1, 5)))) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;&#33539;&#22260;tuple,list,&#38598;&#21512;&#37117;&#21487; HERE emp_no IN (10001, 10002, 10003, 10004)</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(birth_date__year=2020)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26085;&#26399;WHERE birth_date BETWEEN '2020-01-01' AND '2020-12-31'</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#25968;&#25454;</span>
<span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee
<span style="color: #a0522d;">mgr</span> = Employee.objects
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10002, pk__lt=10010))
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10002).<span style="color: #483d8b;">filter</span>(pk__lt=10010))
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10002) &amp; mgr.<span style="color: #483d8b;">filter</span>(pk__lt=10010)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#38598; &#36816;&#31639;&#31526;&#37325;&#36733;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20197;&#19978;&#19977;&#31181;&#26041;&#24335;&#31561;&#20215;&#20110;&#65306;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">WHERE (`employees`.`emp_no` &gt; 10002 AND `employees`.`emp_no` &lt; 10010)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e00d84c9-c999-4add-82fc-d9138cb38ff5" class="outline-4">
<h4 id="h:e00d84c9-c999-4add-82fc-d9138cb38ff5">Q对象</h4>
<div class="outline-text-4" id="text-h:e00d84c9-c999-4add-82fc-d9138cb38ff5">
<p>
虽然Django提供传入条件的方式，但是不方便，它还提供了Q对象来解决。
</p>

<p>
Q对象是django.db.models.Q
</p>

<p>
可以使用&amp;、|操作符来组成逻辑表达式。
</p>

<p>
~表示not。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee
<span style="color: #a020f0;">from</span> django.db.models <span style="color: #a020f0;">import</span> Q
<span style="color: #a0522d;">mgr</span> = Employee.objects
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(Q(pk__lt=10006))) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19981;&#22914;&#30452;&#25509;&#20889;filter(pk__lt=10006)</span>


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#19979;&#38754;&#20960;&#21477;&#19968;&#26679;</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10003).<span style="color: #483d8b;">filter</span>(pk__lt=10006)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19982;</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10003, pk__lt=10006)) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19982;</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(Q(pk__gt=10003), Q(pk__lt=10006)))
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(Q(pk__gt=10003) &amp; Q(pk__lt=10006))) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#19982;</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10003) &amp; mgr.<span style="color: #483d8b;">filter</span>(pk__lt=10006))


<span style="color: #b22222;"># </span><span style="color: #b22222;">&#19979;&#38754;&#20960;&#21477;&#31561;&#20215;</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__in=[10003, 10006])) <span style="color: #b22222;"># </span><span style="color: #b22222;">in</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(Q(pk=10003) | Q(pk=10006))) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#25110;</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk=10003) | mgr.<span style="color: #483d8b;">filter</span>(pk=10006))
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(~Q(pk__gt=10003))) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#38750;</span>
</pre>
</div>
<p>
可使用 <code>&amp;，|和Q</code> 对象来构造复杂的逻辑表达式，可以使用一个或多个Q对象。
</p>

<p>
如果混用关键字参数和Q对象，那么Q对象必须位于关键字参数的前面。
</p>
</div>
</div>
<div id="outline-container-h:5ac947d8-d34e-4adb-8348-0adeec59bfb2" class="outline-4">
<h4 id="h:5ac947d8-d34e-4adb-8348-0adeec59bfb2">聚合、分组</h4>
<div class="outline-text-4" id="text-h:5ac947d8-d34e-4adb-8348-0adeec59bfb2">
</div>
<div id="outline-container-h:305cb7fe-a75b-49a9-a262-05ef5647e5fc" class="outline-5">
<h5 id="h:305cb7fe-a75b-49a9-a262-05ef5647e5fc">aggregate()</h5>
<div class="outline-text-5" id="text-h:305cb7fe-a75b-49a9-a262-05ef5647e5fc">
<p>
aggregate() 返回字典，方便使用,只能返回一条记录
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">import</span> django

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#32771;wsgi.py &#21152;&#36733;&#21021;&#22987;&#29615;&#22659;</span>
os.environ.setdefault(<span style="color: #8b2252;">'DJANGO_SETTINGS_MODULE'</span>, <span style="color: #8b2252;">'salary.settings'</span>)
django.setup()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#25968;&#25454;</span>
<span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee
<span style="color: #a020f0;">from</span> django.db.models <span style="color: #a020f0;">import</span> Q, Max, Min, Avg, Count, Sum

<span style="color: #a0522d;">mgr</span> = Employee.objects
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10010).count()) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21333;&#20540;&#12290;&#23558;&#25152;&#26377;&#25968;&#25454;&#30475;&#20570;&#19968;&#34892;&#20986;&#32467;&#26524;</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10010).aggregate(Count(<span style="color: #8b2252;">'pk'</span>), Max(<span style="color: #8b2252;">'pk'</span>), Min(<span style="color: #8b2252;">'pk'</span>), Sum(<span style="color: #8b2252;">'pk'</span>), Avg(<span style="color: #8b2252;">'pk'</span>))) <span style="color: #b22222;"># </span><span style="color: #b22222;">aggregate &#32858;&#21512;&#20989;&#25968;,&#20986;&#32467;&#26524;&#65292;&#23383;&#20856;&#12290;</span>
<span style="color: #483d8b;">print</span>(mgr.aggregate(Max(<span style="color: #8b2252;">'pk'</span>), <span style="color: #483d8b;">min</span>=Min(<span style="color: #8b2252;">'pk'</span>), <span style="color: #483d8b;">sum</span>=Sum(<span style="color: #8b2252;">'pk'</span>))) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21035;&#21517;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">aggregate &#32858;&#21512;&#20989;&#25968;&#65292;&#36820;&#22238;&#23383;&#20856;&#12290;&#40664;&#35748;key&#21629;&#21517;&#20026; '&#23383;&#27573;&#21517;__&#32858;&#21512;&#20989;&#25968;&#21517;'</span>
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">(0.001) 
                SELECT VERSION(),
                       @@sql_mode,
                       @@default_storage_engine,
                       @@sql_auto_is_null,
                       @@lower_case_table_names,
                       CONVERT_TZ(<span style="color: #8b2252;">'2001-01-01 01:00:00'</span>, <span style="color: #8b2252;">'UTC'</span>, <span style="color: #8b2252;">'UTC'</span>) IS NOT NULL
            ; <span style="color: #a0522d;">args</span>=None; <span style="color: #a0522d;">alias</span>=default
(0.001) SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED; <span style="color: #a0522d;">args</span>=None; <span style="color: #a0522d;">alias</span>=default
(0.001) SELECT COUNT(*) AS <span style="color: #ff00ff;">`__count`</span> FROM <span style="color: #ff00ff;">`employees`</span> WHERE <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span> &gt; 10010; <span style="color: #a0522d;">args</span>=(10010,); <span style="color: #a0522d;">alias</span>=default
10
(0.004) SELECT COUNT(<span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span>) AS <span style="color: #ff00ff;">`pk__count`</span>, MAX(<span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span>) AS <span style="color: #ff00ff;">`pk__max`</span>, MIN(<span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span>) AS <span style="color: #ff00ff;">`pk__min`</span>, SUM(<span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span>) AS <span style="color: #ff00ff;">`pk__sum`</span>, AVG(<span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span>) AS <span style="color: #ff00ff;">`pk__avg`</span> FROM <span style="color: #ff00ff;">`employees`</span> WHERE <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span> &gt; 10010; <span style="color: #a0522d;">args</span>=(10010,); <span style="color: #a0522d;">alias</span>=default
{<span style="color: #8b2252;">'pk__count'</span>: 10, <span style="color: #8b2252;">'pk__max'</span>: 10020, <span style="color: #8b2252;">'pk__min'</span>: 10011, <span style="color: #8b2252;">'pk__sum'</span>: 100155, <span style="color: #8b2252;">'pk__avg'</span>: 10015.5}
(0.001) SELECT MIN(<span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span>) AS <span style="color: #ff00ff;">`min`</span>, SUM(<span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span>) AS <span style="color: #ff00ff;">`sum`</span>, MAX(<span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span>) AS <span style="color: #ff00ff;">`pk__max`</span> FROM <span style="color: #ff00ff;">`employees`</span>; <span style="color: #a0522d;">args</span>=(); <span style="color: #a0522d;">alias</span>=default
{<span style="color: #8b2252;">'min'</span>: 10001, <span style="color: #8b2252;">'sum'</span>: 200210, <span style="color: #8b2252;">'pk__max'</span>: 10020}
</pre>
</div>

<p>
annotate()方法用来分组聚合，返回查询集。
</p>
</div>
</div>
<div id="outline-container-h:6a627feb-b964-4f5c-8972-fdbbc93b7b96" class="outline-5">
<h5 id="h:6a627feb-b964-4f5c-8972-fdbbc93b7b96">annotate()</h5>
<div class="outline-text-5" id="text-h:6a627feb-b964-4f5c-8972-fdbbc93b7b96">
<p>
annotate()中结合统计方法Avg, Sum, Max, Min, Count等等做聚合，返回聚合后的查询集
</p>

<ul class="org-ul">
<li>只有annotate()时，就是以annotate()中的字段为聚合对象，以主键为分组基准，就是先以主键来分组，再对每个分组中annotate()中的字段进行聚合，并且投影所有字段</li>
</ul>

<p>
所得到的结果，以一个个的对象组成的列表，数据并没有显示出来，需要手动去取
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">import</span> django

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#32771;wsgi.py &#21152;&#36733;&#21021;&#22987;&#29615;&#22659;</span>
os.environ.setdefault(<span style="color: #8b2252;">'DJANGO_SETTINGS_MODULE'</span>, <span style="color: #8b2252;">'salary.settings'</span>)
django.setup()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#25968;&#25454;</span>
<span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee
<span style="color: #a020f0;">from</span> django.db.models <span style="color: #a020f0;">import</span> Q, Max, Min, Avg, Count, Sum

<span style="color: #a0522d;">mgr</span> = Employee.objects
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10010).count()) <span style="color: #b22222;"># </span><span style="color: #b22222;">&#21333;&#20540;&#12290;&#23558;&#25152;&#26377;&#25968;&#25454;&#30475;&#20570;&#19968;&#34892;&#20986;&#32467;&#26524;</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10010).aggregate(Count(<span style="color: #8b2252;">'pk'</span>), Max(<span style="color: #8b2252;">'pk'</span>), Min(<span style="color: #8b2252;">'pk'</span>), <span style="color: #483d8b;">sum</span>=Sum(<span style="color: #8b2252;">'pk'</span>), avg=Avg(<span style="color: #8b2252;">'pk'</span>))) <span style="color: #b22222;"># </span><span style="color: #b22222;">aggregate &#32858;&#21512;&#20989;&#25968;,&#20986;&#32467;&#26524;&#65292;&#23383;&#20856;&#12290;</span>
<span style="color: #483d8b;">print</span>(mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10010).annotate(Count(<span style="color: #8b2252;">'pk'</span>)))
<span style="color: #b22222;">#</span><span style="color: #b22222;">aggregate &#32858;&#21512;&#20989;&#25968;&#65292;&#20986;&#32479;&#35745;&#20989;&#25968;&#30340;&#32467;&#26524;&#12290;&#36820;&#22238;&#23383;&#20856;&#12290;&#40664;&#35748;key&#21629;&#21517;&#20026; '&#23383;&#27573;&#21517;__&#32858;&#21512;&#20989;&#25968;&#21517;'</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">annotate &#36820;&#22238;&#26597;&#35810;&#38598;&#65292;&#20803;&#32032;&#26159;&#23545;&#35937;&#12290;&#29992;&#32858;&#21512;&#20989;&#25968;&#65292;&#32858;&#21512;&#20989;&#25968;&#20250;&#20998;&#32452;&#65292;&#27809;&#26377;&#25351;&#23450;&#20998;&#32452;&#20351;&#29992;pk&#20998;&#32452;&#65292;&#34892;&#34892;&#20998;&#32452;&#12290;</span>

<span style="color: #a0522d;">s</span> = mgr.<span style="color: #483d8b;">filter</span>(pk__gt=10010).annotate(Count(<span style="color: #8b2252;">'pk'</span>))
<span style="color: #a020f0;">for</span> x <span style="color: #a020f0;">in</span> s:
    <span style="color: #483d8b;">print</span>(x)
    <span style="color: #483d8b;">print</span>(x.<span style="color: #483d8b;">__dict__</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#37324;&#38754;&#22810;&#20102;&#19968;&#20010;&#23646;&#24615;pk_count</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31561;&#20215;SQL&#35821;&#21477;</span>
<span style="color: #a020f0;">SELECT</span>
  `employees`.`emp_no`,
  `employees`.`birth_date`,
  `employees`.`first_name`,
  `employees`.`last_name`,
  `employees`.`gender`,
  `employees`.`hire_date`,
  <span style="color: #483d8b;">COUNT</span>(`employees`.`emp_no`) <span style="color: #a020f0;">AS</span> `pk__count`
<span style="color: #a020f0;">FROM</span>
  `employees`
<span style="color: #a020f0;">WHERE</span>
  `employees`.`emp_no` &gt; 10010
<span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span>
  `employees`.`emp_no`;
</pre>
</div>

<ul class="org-ul">
<li>有annotate()和values()的情况</li>
</ul>

<p>
1、如果values()在annotate()前面，则是以values()中的字段为分组基准，也就是先以values()中的字段来分组，在对各组中的annotate()中的字段进行聚合
</p>

<p>
​ 如果values()中没有字段，则跟上面那种情况是一样的，只是返回的不再是对象，而是字典组成的查询集，数据都已经显示出来了
</p>

<div class="org-src-container">
<pre class="src src-python">mgr.<span style="color: #483d8b;">filter</span>(pk__lt=10005).values(<span style="color: #8b2252;">'gender'</span>).annotate(c=Count(<span style="color: #8b2252;">'gender'</span>),a=Sum(<span style="color: #8b2252;">'pk'</span>))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31561;&#20215;SQL&#35821;&#21477;</span>
<span style="color: #a020f0;">SELECT</span>
    `gender`,
    <span style="color: #483d8b;">COUNT</span>(`gender`) <span style="color: #a020f0;">AS</span> `c`,
    <span style="color: #483d8b;">SUM</span>(`emp_no`) <span style="color: #a020f0;">AS</span> `a`
<span style="color: #a020f0;">FROM</span>
    `employees`
<span style="color: #a020f0;">WHERE</span>
    `emp_no` &lt; 10005
<span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span>
    `gender`
</pre>
</div>

<p>
2、如果values()在annotate()后面，则values()中的字段就表名了投影的字段，都是以主键来分组的，当values()中为空，则投影所有字段
</p>

<p>
返回的结果是字典组成的查询集，数据已经出来了
</p>

<div class="org-src-container">
<pre class="src src-python">mgr.<span style="color: #483d8b;">filter</span>(pk__lt=10005).annotate(c=Count(<span style="color: #8b2252;">'gender'</span>),a=Sum(<span style="color: #8b2252;">'pk'</span>)).values(<span style="color: #8b2252;">'gender'</span>,<span style="color: #8b2252;">'c'</span>,<span style="color: #8b2252;">'a'</span>,<span style="color: #8b2252;">'first_name'</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31561;&#20215;SQL&#35821;&#21477;</span>
<span style="color: #a020f0;">SELECT</span>
    `gender`,
    `first_name`,
    <span style="color: #483d8b;">COUNT</span>(`gender`) <span style="color: #a020f0;">AS</span> `c`,
    <span style="color: #483d8b;">SUM</span>(`emp_no`) <span style="color: #a020f0;">AS</span> `a`
<span style="color: #a020f0;">FROM</span>
    `employees`
<span style="color: #a020f0;">WHERE</span>
    `emp_no` &lt; 10005
<span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span>
    `emp_no`
</pre>
</div>

<p>
3、如果annotate()前后都有values()，
</p>

<p>
前面的values()为空，无论后面的values()是否为空，都是以主键来分组，
</p>
<div class="org-src-container">
<pre class="src src-python">mgr.<span style="color: #483d8b;">filter</span>(pk__lt=10005).values().annotate(c=Count(<span style="color: #8b2252;">'gender'</span>),a=Sum(<span style="color: #8b2252;">'pk'</span>)).values(<span style="color: #8b2252;">'c'</span>,<span style="color: #8b2252;">'a'</span>,<span style="color: #8b2252;">'first_name'</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31561;&#20215;SQL&#35821;&#21477;</span>
<span style="color: #a020f0;">SELECT</span>
    `first_name`,
    <span style="color: #483d8b;">COUNT</span>(`gender`) <span style="color: #a020f0;">AS</span> `c`,
    <span style="color: #483d8b;">SUM</span>(`emp_no`) <span style="color: #a020f0;">AS</span> `a`
<span style="color: #a020f0;">FROM</span>
    `employees`
<span style="color: #a020f0;">WHERE</span>
    `emp_no` &lt; 10005
<span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span>
    `emp_no`;
</pre>
</div>

<p>
后面的values()为空，无论前面的values()是否为空，都以主键来分组，并且投影所有字段
</p>
<div class="org-src-container">
<pre class="src src-python">mgr.<span style="color: #483d8b;">filter</span>(pk__lt=10005).values(<span style="color: #8b2252;">'gender'</span>).annotate(c=Count(<span style="color: #8b2252;">'gender'</span>),a=Sum(<span style="color: #8b2252;">'pk'</span>)).values()
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31561;&#20215;SQL&#35821;&#21477;</span>
<span style="color: #a020f0;">SELECT</span>
    `emp_no`,
    `birth_date`,
    `first_name`,
    `last_name`,
    `gender`,
    `hire_date`,
    <span style="color: #483d8b;">COUNT</span>(`gender`) <span style="color: #a020f0;">AS</span> `c`,
    <span style="color: #483d8b;">SUM</span>(`emp_no`) <span style="color: #a020f0;">AS</span> `a`
<span style="color: #a020f0;">FROM</span>
    `employees`
<span style="color: #a020f0;">WHERE</span>
    `emp_no` &lt; 10005
<span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span>
    `emp_no`;
</pre>
</div>

<p>
后面的values()有主键存在，则无论前面的values()有什么，都是以主键来分组。
</p>
<div class="org-src-container">
<pre class="src src-python">mgr.<span style="color: #483d8b;">filter</span>(pk__lt=10005).values(<span style="color: #8b2252;">'gender'</span>).annotate(c=Count(<span style="color: #8b2252;">'gender'</span>),a=Sum(<span style="color: #8b2252;">'pk'</span>)).values(<span style="color: #8b2252;">'c'</span>,<span style="color: #8b2252;">'a'</span>,<span style="color: #8b2252;">'first_name'</span>,<span style="color: #8b2252;">'emp_no'</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31561;&#20215;SQL&#35821;&#21477;</span>
<span style="color: #a020f0;">SELECT</span>
    `first_name`,
    `emp_no`,
    <span style="color: #483d8b;">COUNT</span>(`gender`) <span style="color: #a020f0;">AS</span> `c`,
    <span style="color: #483d8b;">SUM</span>(`emp_no`) <span style="color: #a020f0;">AS</span> `a`
<span style="color: #a020f0;">FROM</span>
    `employees`
<span style="color: #a020f0;">WHERE</span>
    `emp_no` &lt; 10005
<span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span>
    `emp_no`;
</pre>
</div>

<p>
后面的values()没有主键存在，也没有除了聚合后结果的字段，哪怕后面的也没有前面values()的字段，都有以 前面values()的字段来分组
</p>

<div class="org-src-container">
<pre class="src src-python">mgr.<span style="color: #483d8b;">filter</span>(pk__lt=10005).values(<span style="color: #8b2252;">'gender'</span>).annotate(c=Count(<span style="color: #8b2252;">'gender'</span>),a=Sum(<span style="color: #8b2252;">'pk'</span>)).values(<span style="color: #8b2252;">'c'</span>,<span style="color: #8b2252;">'a'</span>)
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21069;&#38754;&#30340;value&#25511;&#21046;&#20998;&#32452;&#65292;&#21518;&#38754;&#30340;values&#25511;&#21046;&#25237;&#24433;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31561;&#20215;SQL&#35821;&#21477;</span>
<span style="color: #a020f0;">SELECT</span>
    <span style="color: #483d8b;">COUNT</span>(`gender`) <span style="color: #a020f0;">AS</span> `c`,
    <span style="color: #483d8b;">SUM</span>(`emp_no`) <span style="color: #a020f0;">AS</span> `a`
<span style="color: #a020f0;">FROM</span>
    `employees`
<span style="color: #a020f0;">WHERE</span>
    `emp_no` &lt; 10005
<span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span>
    `gender`;
</pre>
</div>

<p>
后面的values()没有主键存在，但是有其他字段存在，则是以前面values()字段和后面values()中存在的其他字段联合起来分组，也就是联合起来的字段必须完全相同才能被分到同一组
</p>

<div class="org-src-container">
<pre class="src src-python">mgr.<span style="color: #483d8b;">filter</span>(pk__lt=10005).values(<span style="color: #8b2252;">'gender'</span>).annotate(c=Count(<span style="color: #8b2252;">'gender'</span>),a=Sum(<span style="color: #8b2252;">'pk'</span>)).values(<span style="color: #8b2252;">'c'</span>,<span style="color: #8b2252;">'a'</span>,<span style="color: #8b2252;">'first_name'</span>,<span style="color: #8b2252;">'last_name'</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31561;&#20215;SQL&#35821;&#21477;</span>
<span style="color: #a020f0;">SELECT</span>
    `first_name`,
    `last_name`,
    <span style="color: #483d8b;">COUNT</span>(`gender`) <span style="color: #a020f0;">AS</span> `c`,
    <span style="color: #483d8b;">SUM</span>(`emp_no`) <span style="color: #a020f0;">AS</span> `a`
<span style="color: #a020f0;">FROM</span>
    `employees`
<span style="color: #a020f0;">WHERE</span>
    `emp_no` &lt; 10005
<span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span>
    `gender`,
    `first_name`,
    `last_name`;
</pre>
</div>

<p>
order_by()&#x2014;》排序，一般在最后使用
</p>

<p>
升序就是原字段，例如order_by('c')
</p>

<p>
降序就是在原字段前面加个-，例如order_by('-c')
</p>

<p>
注意，如果order_by()中出现了主键，则annotate()前面的values()将无效，
</p>

<div class="org-src-container">
<pre class="src src-python">mgr.<span style="color: #483d8b;">filter</span>(pk__lt=10005).values(<span style="color: #8b2252;">'gender'</span>).annotate(c=Count(<span style="color: #8b2252;">'gender'</span>),a=Sum(<span style="color: #8b2252;">'pk'</span>)).values(<span style="color: #8b2252;">'c'</span>,<span style="color: #8b2252;">'a'</span>,<span style="color: #8b2252;">'first_name'</span>).order_by(<span style="color: #8b2252;">'emp_no'</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31561;&#20215;SQL&#35821;&#21477;</span>
<span style="color: #a020f0;">SELECT</span>
    `first_name`,
    <span style="color: #483d8b;">COUNT</span>(`gender`) <span style="color: #a020f0;">AS</span> `c`,
    <span style="color: #483d8b;">SUM</span>(`emp_no`) <span style="color: #a020f0;">AS</span> `a`
<span style="color: #a020f0;">FROM</span>
    `employees`
<span style="color: #a020f0;">WHERE</span>
    `emp_no` &lt; 10005
<span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span>
    `emp_no`
<span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span>
    `emp_no` <span style="color: #a020f0;">ASC</span>;
</pre>
</div>

<p>
如果order_by()中出现了annotate()后面的values()中没有的字段，则联合起来分组的字段中会添加上这个字段，投影也会添加这个字段
</p>

<div class="org-src-container">
<pre class="src src-python">mgr.<span style="color: #483d8b;">filter</span>(pk__lt=10005).values(<span style="color: #8b2252;">'gender'</span>).annotate(c=Count(<span style="color: #8b2252;">'gender'</span>),a=Sum(<span style="color: #8b2252;">'pk'</span>)).values(<span style="color: #8b2252;">'c'</span>,<span style="color: #8b2252;">'a'</span>,<span style="color: #8b2252;">'first_name'</span>).order_by(<span style="color: #8b2252;">'last_name'</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31561;&#20215;SQL&#35821;&#21477;</span>
<span style="color: #a020f0;">SELECT</span>
    `first_name`,
    <span style="color: #483d8b;">COUNT</span>(`gender`) <span style="color: #a020f0;">AS</span> `c`,
    <span style="color: #483d8b;">SUM</span>(`emp_no`) <span style="color: #a020f0;">AS</span> `a`
<span style="color: #a020f0;">FROM</span>
    `employees`
<span style="color: #a020f0;">WHERE</span>
    `emp_no` &lt; 10005
<span style="color: #a020f0;">GROUP</span> <span style="color: #a020f0;">BY</span>
    `gender`,
    `first_name`,
    `last_name`
<span style="color: #a020f0;">ORDER</span> <span style="color: #a020f0;">BY</span>
    `last_name` <span style="color: #a020f0;">ASC</span>;
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-h:b0378db2-550d-4470-aa5d-ba7b5507a202" class="outline-3">
<h3 id="h:b0378db2-550d-4470-aa5d-ba7b5507a202">一对多</h3>
<div class="outline-text-3" id="text-h:b0378db2-550d-4470-aa5d-ba7b5507a202">
</div>
<div id="outline-container-h:48a1cb59-84dc-4008-85ba-d2d7dc71160e" class="outline-4">
<h4 id="h:48a1cb59-84dc-4008-85ba-d2d7dc71160e">构建一对多表</h4>
<div class="outline-text-4" id="text-h:48a1cb59-84dc-4008-85ba-d2d7dc71160e">
<p>
员工表和员工工资表
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#21592;&#24037;&#34920;</span>
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `employees` (
  `emp_no` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `birth_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `first_name` <span style="color: #228b22;">varchar</span>(14) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `last_name` <span style="color: #228b22;">varchar</span>(16) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `gender` <span style="color: #228b22;">smallint</span>(6) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> <span style="color: #a020f0;">DEFAULT</span> 1 COMMENT <span style="color: #8b2252;">'M=1, F=2'</span>,
  `hire_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`emp_no`)
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8mb3;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#21592;&#24037;&#24037;&#36164;&#34920;</span>
<span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">IF</span> <span style="color: #a020f0;">EXISTS</span> `salaries`;
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `salaries` (
  `emp_no` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `salary` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `from_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `to_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`emp_no`,`from_date`),
  <span style="color: #a020f0;">CONSTRAINT</span> `salaries_ibfk_1` <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`emp_no`) <span style="color: #a020f0;">REFERENCES</span> `employees` (`emp_no`) <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">CASCADE</span>
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:57d765a1-0e69-4eb4-93f1-404b518c8b76" class="outline-4">
<h4 id="h:57d765a1-0e69-4eb4-93f1-404b518c8b76">联合主键问题</h4>
<div class="outline-text-4" id="text-h:57d765a1-0e69-4eb4-93f1-404b518c8b76">
<p>
SQLAlchemy提供了联合主键支持，Django至今没有支持。
</p>
<ul class="org-ul">
<li>直接支持？ 原生不支持。</li>
<li>替代方案：优先使用 unique_together 或第三方库。</li>
<li>推荐做法：使用代理主键（如 id）配合唯一约束，既符合 Django 习惯，又能保证数据完整性。</li>
</ul>

<p>
Djang不能直接添加自己的2个字段的联合主键，我们手动为表创建一个自增id主键。操作顺序如下：
</p>
<ul class="org-ul">
<li>取消表所有联合主键，并删除所有外键约束后保存</li>
<li>为表增加一个id字段，自增、主键。保存后，它会自动填充数据。</li>
<li>重建原来的外键约束</li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#21024;&#38500;&#22806;&#38190;</span>
<span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">salaries</span> <span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> salaries_ibfk_1;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#21024;&#38500;&#21407;&#26377;&#30340;&#32852;&#21512;&#20027;&#38190;</span>
<span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">salaries</span> <span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span>;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#28155;&#21152;&#26032;&#30340;&#33258;&#22686;&#20027;&#38190;&#21015; id&#12290; FIRS&#23558; id &#21015;&#25918;&#22312;&#34920;&#30340;&#31532;&#19968;&#21015;&#65288;&#40664;&#35748;&#28155;&#21152;&#21040;&#26411;&#23614;&#65289;</span>
<span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">salaries</span> 
<span style="color: #a020f0;">ADD</span> <span style="color: #a020f0;">COLUMN</span> id <span style="color: #228b22;">INT</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> AUTO_INCREMENT <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> <span style="color: #a020f0;">FIRST</span>;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#28155;&#21152;&#26032;&#22806;&#38190;&#65288;&#21517;&#31216;&#25913;&#20026; salaries_ibfk_1&#65289;</span>
<span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">salaries</span> 
<span style="color: #a020f0;">ADD</span> <span style="color: #a020f0;">CONSTRAINT</span> `salaries_ibfk_1` 
<span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`emp_no`) 
<span style="color: #a020f0;">REFERENCES</span> `test`.`employees` (`emp_no`) 
<span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">CASCADE</span> 
<span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">UPDATE</span> <span style="color: #a020f0;">RESTRICT</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">mysql&gt; select * from salaries;
+----+--------+--------+------------+------------+
| id | emp_no | salary | from_date  | to_date    |
+----+--------+--------+------------+------------+
|  1 |  10001 |  60117 | 1986-06-26 | 1987-06-26 |
|  2 |  10001 |  62102 | 1987-06-26 | 1988-06-25 |
|  3 |  10001 |  66074 | 1988-06-25 | 1989-06-25 |
|  4 |  10001 |  66596 | 1989-06-25 | 1990-06-25 |
|  5 |  10001 |  66961 | 1990-06-25 | 1991-06-25 |
|  6 |  10001 |  71046 | 1991-06-25 | 1992-06-24 |
|  7 |  10001 |  74333 | 1992-06-24 | 1993-06-24 |
|  8 |  10001 |  75286 | 1993-06-24 | 1994-06-24 |
|  9 |  10001 |  75994 | 1994-06-24 | 1995-06-24 |
</pre>
</div>

<p>
新表结构
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#21592;&#24037;&#24037;&#36164;&#34920;</span>
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `salaries` (
  `id` <span style="color: #228b22;">int</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> AUTO_INCREMENT,
  `emp_no` <span style="color: #228b22;">int</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `salary` <span style="color: #228b22;">int</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `from_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `to_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`id`) <span style="color: #a020f0;">USING</span> BTREE,
  INDEX `emp_no` (`emp_no` <span style="color: #a020f0;">ASC</span>) <span style="color: #a020f0;">USING</span> BTREE,
  <span style="color: #a020f0;">CONSTRAINT</span> `salaries_ibfk_1` <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`emp_no`) 
  <span style="color: #a020f0;">REFERENCES</span> `test`.`employees` (`emp_no`) 
  <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">CASCADE</span> 
  <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">UPDATE</span> <span style="color: #a020f0;">RESTRICT</span>
) ENGINE=InnoDB  <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8mb3;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:0eaa2726-d0f8-4fb2-8b85-242cf15b0dc4" class="outline-4">
<h4 id="h:0eaa2726-d0f8-4fb2-8b85-242cf15b0dc4">新建模型</h4>
<div class="outline-text-4" id="text-h:0eaa2726-d0f8-4fb2-8b85-242cf15b0dc4">
<p>
在employee/models.py文件下创建工资表的模型
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> django.db <span style="color: #a020f0;">import</span> models
<span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">CREATE TABLE `employees` (</span>
<span style="color: #8b2252;">  `emp_no` int(11) NOT NULL,</span>
<span style="color: #8b2252;">  `birth_date` date NOT NULL,</span>
<span style="color: #8b2252;">  `first_name` varchar(14) NOT NULL,</span>
<span style="color: #8b2252;">  `last_name` varchar(16) NOT NULL,</span>
<span style="color: #8b2252;">  `gender` smallint(6) NOT NULL DEFAULT 1 COMMENT 'M=1, F=2',</span>
<span style="color: #8b2252;">  `hire_date` date NOT NULL,</span>
<span style="color: #8b2252;">  PRIMARY KEY (`emp_no`)</span>
<span style="color: #8b2252;">) ENGINE=InnoDB DEFAULT CHARSET=utf8; </span>
<span style="color: #8b2252;">"""</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Create your models here.</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Employee</span>(models.Model): <span style="color: #b22222;">#</span><span style="color: #b22222;">metaclass=ModelBase</span>
    <span style="color: #a020f0;">class</span> <span style="color: #228b22;">Meta</span>:
        <span style="color: #a0522d;">db_table</span> = <span style="color: #8b2252;">'employees'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#34920;&#21517;</span>

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#21015;&#21517;&#19968;&#19968;&#26144;&#23556;&#20986;&#26469;</span>
    <span style="color: #a0522d;">emp_no</span> = models.IntegerField(primary_key=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">birth_date</span> = models.DateField(null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">first_name</span> = models.CharField(null=<span style="color: #008b8b;">False</span>, max_length=14) <span style="color: #b22222;">#</span><span style="color: #b22222;">varchar(14) NOT NULL,</span>
    <span style="color: #a0522d;">last_name</span> = models.CharField(null=<span style="color: #008b8b;">False</span>, max_length=16)
    <span style="color: #a0522d;">gender</span> = models.SmallIntegerField(null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">hire_date</span> = models.DateField(null=<span style="color: #008b8b;">False</span>)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#20889;&#21487;&#35270;&#21270;&#25928;&#26524;</span>
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'&lt;Employee {}, {} {}&gt;'</span>.<span style="color: #483d8b;">format</span>(<span style="color: #a020f0;">self</span>.emp_no, <span style="color: #a020f0;">self</span>.first_name, <span style="color: #a020f0;">self</span>.last_name)

    <span style="color: #a0522d;">__str__</span> = __repr__

<span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">CREATE TABLE `salaries` (</span>
<span style="color: #8b2252;">  `id` int NOT NULL AUTO_INCREMENT,</span>
<span style="color: #8b2252;">  `emp_no` int NOT NULL,</span>
<span style="color: #8b2252;">  `salary` int NOT NULL,</span>
<span style="color: #8b2252;">  `from_date` date NOT NULL,</span>
<span style="color: #8b2252;">  `to_date` date NOT NULL,</span>
<span style="color: #8b2252;">  PRIMARY KEY (`id`) USING BTREE,</span>
<span style="color: #8b2252;">  INDEX `emp_no` (`emp_no` ASC) USING BTREE,</span>
<span style="color: #8b2252;">  CONSTRAINT `salaries_ibfk_1` FOREIGN KEY (`emp_no`) </span>
<span style="color: #8b2252;">  REFERENCES `test`.`employees` (`emp_no`) </span>
<span style="color: #8b2252;">  ON DELETE CASCADE </span>
<span style="color: #8b2252;">  ON UPDATE RESTRICT</span>
<span style="color: #8b2252;">) ENGINE=InnoDB  DEFAULT CHARSET=utf8mb3;</span>
<span style="color: #8b2252;">"""</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Salary</span>(models.Model):
    <span style="color: #a020f0;">class</span> <span style="color: #228b22;">Meta</span>:
        <span style="color: #a0522d;">db_table</span> = <span style="color: #8b2252;">'salaries'</span>

    <span style="color: #483d8b;">id</span> = models.AutoField(primary_key=<span style="color: #008b8b;">True</span>, null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">emp_no</span> = models.ForeignKey(<span style="color: #8b2252;">'Employee'</span>, on_delete=models.CASCADE,db_column=<span style="color: #8b2252;">'emp_no'</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31867;&#21517;&#31216;&#65292;&#30452;&#25509;&#23558;emp_no&#26032;&#24314;&#25104;&#22806;&#38190;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#34920;&#30340;&#23383;&#27573;&#21517;emp_no&#65292;&#20174;&#34920;&#20013;&#30340;&#22806;&#38190;&#23383;&#27573;&#21517;&#40664;&#35748;&#20026;emp_no_id &#65292;&#21487;&#20197;&#36890;&#36807;db_column='emp_no'&#20462;&#25913;&#22806;&#38190;&#23383;&#27573;&#21517;</span>
    <span style="color: #a0522d;">salary</span> = models.IntegerField(null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">from_date</span> = models.DateField(null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">to_date</span> = models.DateField(null=<span style="color: #008b8b;">False</span>)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#20889;&#21487;&#35270;&#21270;&#25928;&#26524;</span>
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'&lt;Salary {}, {} {}&gt;'</span>.<span style="color: #483d8b;">format</span>(
            <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">id</span>, 
            <span style="color: #b22222;"># </span><span style="color: #b22222;">self.emp_no, #&#36820;&#22238;&lt;Employee 10001, Georgi Facello&gt; &#26159;Employee&#31867;&#30340;&#23545;&#35937;</span>
            <span style="color: #a020f0;">self</span>.emp_no_id,  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#26679;&#19981;&#20250;&#24341;&#36215;&#31532;2&#24352;&#34920;&#30340;&#26597;&#35810;</span>
            <span style="color: #a020f0;">self</span>.salary)
        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&lt;Salary 1, &lt;Employee 10001, Georgi Facello&gt; 60117&gt;</span>
    <span style="color: #a0522d;">__str__</span> = __repr__
</pre>
</div>

<p>
emp_no = models.ForeignKey('Employee', on_delete=models.CASCADE,db_column='emp_no')
</p>

<p>
直接将emp_no设置成外键，查询时，如果不设置db_column,则以emp_no_id来搜索，在主表中是搜索不到的，所以需要写上真实的名字，所以写上db_column='emp_no'
</p>

<p>
测试代码
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">import</span> django

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#32771;wsgi.py &#21152;&#36733;&#21021;&#22987;&#29615;&#22659;</span>
os.environ.setdefault(<span style="color: #8b2252;">'DJANGO_SETTINGS_MODULE'</span>, <span style="color: #8b2252;">'salary.settings'</span>)
django.setup()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#25968;&#25454;</span>
<span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee, Salary
<span style="color: #a020f0;">from</span> django.db.models <span style="color: #a020f0;">import</span> Q, Max, Min, Avg, Count, Sum

<span style="color: #a0522d;">emgr</span> = Employee.objects
<span style="color: #a0522d;">smgr</span> = Salary.objects
<span style="color: #483d8b;">print</span>(smgr.<span style="color: #483d8b;">all</span>())
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">(0.002) 
                SELECT VERSION(),
                       @@sql_mode,
                       @@default_storage_engine,
                       @@sql_auto_is_null,
                       @@lower_case_table_names,
                       CONVERT_TZ(<span style="color: #8b2252;">'2001-01-01 01:00:00'</span>, <span style="color: #8b2252;">'UTC'</span>, <span style="color: #8b2252;">'UTC'</span>) IS NOT NULL
            ; <span style="color: #a0522d;">args</span>=None; <span style="color: #a0522d;">alias</span>=default
(0.001) SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED; <span style="color: #a0522d;">args</span>=None; <span style="color: #a0522d;">alias</span>=default
(0.001) SELECT <span style="color: #ff00ff;">`salaries`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`id`</span>, <span style="color: #ff00ff;">`salaries`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span>, <span style="color: #ff00ff;">`salaries`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`salary`</span>, <span style="color: #ff00ff;">`salaries`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`from_date`</span>, <span style="color: #ff00ff;">`salaries`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`to_date`</span> FROM <span style="color: #ff00ff;">`salaries`</span> LIMIT 21; <span style="color: #a0522d;">args</span>=(); <span style="color: #a0522d;">alias</span>=default
&lt;QuerySet [&lt;Salary 1, 10001 60117&gt;, &lt;Salary 2, 10001 62102&gt;, &lt;Salary 3, 10001 66074&gt;, &lt;Salary 4, 10001 66596&gt;, &lt;Salary 5, 10001 66961&gt;, &lt;Salary 6, 10001 71046&gt;, &lt;Salary 7, 10001 74333&gt;, &lt;Salary 8, 10001 75286&gt;, &lt;Salary 9, 10001 75994&gt;, &lt;Salary 10, 10001 76884&gt;, &lt;Salary 11, 10001 80013&gt;, &lt;Salary 12, 10001 81025&gt;, &lt;Salary 13, 10001 81097&gt;, &lt;Salary 14, 10001 84917&gt;, &lt;Salary 15, 10001 85112&gt;, &lt;Salary 16, 10001 85097&gt;, &lt;Salary 17, 10001 88958&gt;, &lt;Salary 18, 10002 65828&gt;, &lt;Salary 19, 10002 65909&gt;, &lt;Salary 20, 10002 67534&gt;, <span style="color: #8b2252;">'...(remaining elements truncated)...'</span>]&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee, Salary
<span style="color: #a020f0;">from</span> django.db.models <span style="color: #a020f0;">import</span> Q, Max, Min, Avg, Count, Sum

<span style="color: #a0522d;">emgr</span> = Employee.objects
<span style="color: #a0522d;">smgr</span> = Salary.objects
<span style="color: #a020f0;">for</span> x <span style="color: #a020f0;">in</span> smgr.<span style="color: #483d8b;">all</span>()[2:4]:
    <span style="color: #483d8b;">print</span>(x) <span style="color: #b22222;">#</span><span style="color: #b22222;">Salary&#23545;&#35937;</span>
    <span style="color: #483d8b;">print</span>(x.emp_no) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20250;&#23545;employees&#34920;&#26597;&#35810;</span>
</pre>
</div>

<p>
返回结果
</p>

<div class="org-src-container">
<pre class="src src-sh">(0.002) SELECT <span style="color: #ff00ff;">`salaries`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`id`</span>, <span style="color: #ff00ff;">`salaries`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span>, <span style="color: #ff00ff;">`salaries`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`salary`</span>, <span style="color: #ff00ff;">`salaries`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`from_date`</span>, <span style="color: #ff00ff;">`salaries`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`to_date`</span> FROM <span style="color: #ff00ff;">`salaries`</span> LIMIT 2 OFFSET 2; <span style="color: #a0522d;">args</span>=(); <span style="color: #a0522d;">alias</span>=default
&lt;Salary 3, 10001 66074&gt;
(0.002) SELECT <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`birth_date`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`first_name`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`last_name`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`gender`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`hire_date`</span> FROM <span style="color: #ff00ff;">`employees`</span> WHERE <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span> = 10001 LIMIT 21; <span style="color: #a0522d;">args</span>=(10001,); <span style="color: #a0522d;">alias</span>=default
&lt;Employee 10001, Georgi Facello&gt;
&lt;Salary 4, 10001 66596&gt;
(0.002) SELECT <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`birth_date`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`first_name`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`last_name`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`gender`</span>, <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`hire_date`</span> FROM <span style="color: #ff00ff;">`employees`</span> WHERE <span style="color: #ff00ff;">`employees`</span><span style="color: #483d8b;">.</span><span style="color: #ff00ff;">`emp_no`</span> = 10001 LIMIT 21; <span style="color: #a0522d;">args</span>=(10001,); <span style="color: #a0522d;">alias</span>=default
&lt;Employee 10001, Georgi Facello&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:64c751b2-0231-464a-8cc9-02d06a38e82f" class="outline-4">
<h4 id="h:64c751b2-0231-464a-8cc9-02d06a38e82f">外键</h4>
<div class="outline-text-4" id="text-h:64c751b2-0231-464a-8cc9-02d06a38e82f">
<p>
Employee是一个模型，也可以看作一个表，就是一对多的那个一，外键也会取这个模型的主键
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">emp_no</span> = models.ForeignKey(Employee, on_delete=models.CASCADE,db_column=<span style="color: #8b2252;">'emp_no'</span>)
</pre>
</div>
</div>
<div id="outline-container-h:a5e79579-3e85-4dd7-93e4-83b857042a2d" class="outline-5">
<h5 id="h:a5e79579-3e85-4dd7-93e4-83b857042a2d">db_column</h5>
<div class="outline-text-5" id="text-h:a5e79579-3e85-4dd7-93e4-83b857042a2d">
<p>
用来设置外键的被搜索的字段，因为被设置为外键，当联合搜索时，会被自动
默认为字段_id的字段。比如，emp_no被设置为外键，那么联合搜索时的主表
中的字段就是emp_no_id,如果不设置db_column，就会报错，无法搜索到字段，
设置db_column相当与设置成真实字段的名字
</p>

<p>
这个是设置本表的字段名
</p>
</div>
</div>
<div id="outline-container-h:0d8a6fca-4165-4625-8848-754d6460e9b2" class="outline-5">
<h5 id="h:0d8a6fca-4165-4625-8848-754d6460e9b2">related_name</h5>
<div class="outline-text-5" id="text-h:0d8a6fca-4165-4625-8848-754d6460e9b2">
<p>
用来给主表搜索从表使用的，如果不设置，主表中就会多一个表名_set的属性，
用来方便主表对从表进行操作，比如，主表的对象为Employee，那么在主表中
就会产生一个employee_set的属性。如果手动设置一下，会方便自己查询。
</p>
</div>
</div>
<div id="outline-container-h:a94b1998-bdb4-4f1e-97ea-88f2f2587698" class="outline-5">
<h5 id="h:a94b1998-bdb4-4f1e-97ea-88f2f2587698">on_delete</h5>
<div class="outline-text-5" id="text-h:a94b1998-bdb4-4f1e-97ea-88f2f2587698">
<p>
位于 django.db.models
</p>

<ul class="org-ul">
<li><p>
CASCADE
</p>

<p>
级联删除。Django 模拟 SQL 约束 ON DELETE CASCADE 的行为，并删除包
含 ForeignKey 的对象。Model.delete()不会在相关模型上调用，但 会为
所有已删除的对象发送pre_delete和 post_delete信号。
</p></li>

<li><p>
PROTECT
</p>

<p>
通过提高ProtectedError的子类来 防止删除引用的对象 django.db.IntegrityError。
</p></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-h:ea8af9e0-6e13-44ef-83fb-dec2ddb6b2c8" class="outline-4">
<h4 id="h:ea8af9e0-6e13-44ef-83fb-dec2ddb6b2c8">特殊属性</h4>
<div class="outline-text-4" id="text-h:ea8af9e0-6e13-44ef-83fb-dec2ddb6b2c8">
<p>
如果增加了外键后，Django会对一端和多端增加一些新类属性。
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee, Salary
<span style="color: #a020f0;">from</span> django.db.models <span style="color: #a020f0;">import</span> Q, Max, Min, Avg, Count, Sum

<span style="color: #a0522d;">emgr</span> = Employee.objects
<span style="color: #a0522d;">smgr</span> = Salary.objects
<span style="color: #483d8b;">print</span>(*Employee.<span style="color: #483d8b;">__dict__</span>.items(), sep=<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)
<span style="color: #483d8b;">print</span>(<span style="color: #8b2252;">'-'</span> * 30)
<span style="color: #483d8b;">print</span>(*Salary.<span style="color: #483d8b;">__dict__</span>.items(), sep=<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)
<span style="color: #b22222;"># </span><span style="color: #b22222;">for x in smgr.all()[2:4]:</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">print(x) #Salary&#23545;&#35937;</span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">print(x.emp_no) </span>
<span style="color: #b22222;">#     </span><span style="color: #b22222;">print(x.__dict__)</span>
</pre>
</div>

<p>
返回结果
</p>
<div class="org-src-container">
<pre class="src src-sh">......
<span style="color: #b22222;">#</span><span style="color: #b22222;">'salary_set' &#19968;&#31471;&#65292;Employee&#31867;&#20013;&#22810;&#20102;&#19968;&#20010;&#31867;&#23646;&#24615;</span>
(<span style="color: #8b2252;">'salary_set'</span>, &lt;django.db.models.fields.related_descriptors.ReverseManyToOneDescriptor object at 0x000001F099C85F30&gt;)
------------------------------
.....
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#22810;&#31471;&#65292;Salary&#31867;&#20013;&#20063;&#22810;&#20102;&#19968;&#20010;&#31867;&#23646;&#24615;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">emp_no_id&#36825;&#25165;&#26159;salary&#33258;&#24049;&#30340;&#31867;&#23646;&#24615;&#65292;&#23545;&#24212;&#25968;&#25454;&#24211;&#20013;&#30340;emp_no&#23383;&#27573;</span>
(<span style="color: #8b2252;">'emp_no_id'</span>, &lt;django.db.models.fields.related_descriptors.ForeignKeyDeferredAttribute object at 0x000001F0998CBB50&gt;)
<span style="color: #b22222;">#</span><span style="color: #b22222;">emp_no &#31867;&#21517;&#31216;,&#25351;&#21521;Emploee&#31867;&#30340;&#19968;&#20010;&#23454;&#20363;&#12290;&#20851;&#32852;&#21592;&#24037;&#23454;&#20363; </span>
(<span style="color: #8b2252;">'emp_no'</span>, &lt;django.db.models.fields.related_descriptors.ForwardManyToOneDescriptor object at 0x000001F0998CBC50&gt;)
</pre>
</div>

<p>
从一端往多端查&lt;Emmployee_instance&gt;.salary_set
</p>

<p>
从多端往一端查&lt;Salary_instance&gt;.emp_no
</p>
</div>
</div>
<div id="outline-container-h:bba5b6b6-4283-4f9c-bb5c-41c0680f7859" class="outline-4">
<h4 id="h:bba5b6b6-4283-4f9c-bb5c-41c0680f7859">查询</h4>
<div class="outline-text-4" id="text-h:bba5b6b6-4283-4f9c-bb5c-41c0680f7859">
<p>
例子：查询员工10004的所有工资
</p>

<p>
准备，修改employee/models.py文件, 为Employee类加个name属性，方便打印
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Employee</span>(models.Model): <span style="color: #b22222;">#</span><span style="color: #b22222;">metaclass=ModelBase</span>
    <span style="color: #a020f0;">class</span> <span style="color: #228b22;">Meta</span>:
        <span style="color: #a0522d;">db_table</span> = <span style="color: #8b2252;">'employees'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#34920;&#21517;</span>

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#21015;&#21517;&#19968;&#19968;&#26144;&#23556;&#20986;&#26469;</span>
    <span style="color: #a0522d;">emp_no</span> = models.IntegerField(primary_key=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">birth_date</span> = models.DateField(null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">first_name</span> = models.CharField(null=<span style="color: #008b8b;">False</span>, max_length=14) <span style="color: #b22222;">#</span><span style="color: #b22222;">varchar(14) NOT NULL,</span>
    <span style="color: #a0522d;">last_name</span> = models.CharField(null=<span style="color: #008b8b;">False</span>, max_length=16)
    <span style="color: #a0522d;">gender</span> = models.SmallIntegerField(null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">hire_date</span> = models.DateField(null=<span style="color: #008b8b;">False</span>)

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#23646;&#24615;</span>
    @<span style="color: #483d8b;">property</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">name</span>(<span style="color: #a020f0;">self</span>): <span style="color: #b22222;">#</span><span style="color: #b22222;">fullname()</span>
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"% {}-{} %"</span>.<span style="color: #483d8b;">format</span>(<span style="color: #a020f0;">self</span>.first_name,<span style="color: #a020f0;">self</span>.last_name)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#20889;&#21487;&#35270;&#21270;&#25928;&#26524;</span>
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'&lt;Employee {}, {} {}&gt;'</span>.<span style="color: #483d8b;">format</span>(<span style="color: #a020f0;">self</span>.emp_no, <span style="color: #a020f0;">self</span>.first_name, <span style="color: #a020f0;">self</span>.last_name)

    <span style="color: #a0522d;">__str__</span> = __repr__
</pre>
</div>

<p>
查询
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">import</span> django

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#32771;wsgi.py &#21152;&#36733;&#21021;&#22987;&#29615;&#22659;</span>
os.environ.setdefault(<span style="color: #8b2252;">'DJANGO_SETTINGS_MODULE'</span>, <span style="color: #8b2252;">'salary.settings'</span>)
django.setup()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#25968;&#25454;</span>
<span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee, Salary
<span style="color: #a020f0;">from</span> django.db.models <span style="color: #a020f0;">import</span> Q, Max, Min, Avg, Count, Sum

<span style="color: #a0522d;">emgr</span> = Employee.objects <span style="color: #b22222;">#</span><span style="color: #b22222;">salary_set &#22312;Employee&#31867;&#20013;&#23450;&#20041;&#30340;</span>
<span style="color: #a0522d;">smgr</span> = Salary.objects

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#21592;&#24037;10004&#30340;&#25152;&#26377;&#24037;&#36164;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#26696;1 &#20174;&#19968;&#31471;&#24448;&#22810;&#31471;&#19978;&#26597;(&#20174;&#21592;&#24037;&#24448;&#24037;&#36164;&#34920;&#26597;) &#22909;</span>
<span style="color: #a0522d;">emp</span> = emgr.get(emp_no=10004) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#20010;Employee&#31867;&#30340;&#23545;&#35937;&#12290;&#21482;&#29992;&#20027;&#38190;&#23450;&#20301;&#20102;&#19968;&#26465;&#25968;&#25454;&#12290;&#22909;&#12290;</span>
<span style="color: #483d8b;">print</span>(emp) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27809;&#26377;&#26597;&#35810;&#24037;&#36164;&#34920;</span>
<span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">SELECT</span>
<span style="color: #8b2252;">  `employees`.`emp_no`,</span>
<span style="color: #8b2252;">  `employees`.`birth_date`,</span>
<span style="color: #8b2252;">  `employees`.`first_name`,</span>
<span style="color: #8b2252;">  `employees`.`last_name`,</span>
<span style="color: #8b2252;">  `employees`.`gender`,</span>
<span style="color: #8b2252;">  `employees`.`hire_date`</span>
<span style="color: #8b2252;">FROM</span>
<span style="color: #8b2252;">  `employees`</span>
<span style="color: #8b2252;">WHERE</span>
<span style="color: #8b2252;">  `employees`.`emp_no` = 10004</span>
<span style="color: #8b2252;">"""</span>
<span style="color: #483d8b;">print</span>(emp.salary_set.<span style="color: #483d8b;">all</span>()) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#19968;&#20010;&#26597;&#35810;&#38598;&#65292;&#35302;&#21457;salary&#34920;&#30340;&#26597;&#35810;&#12290;</span>
<span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">SELECT</span>
<span style="color: #8b2252;">  `salaries`.`id`,</span>
<span style="color: #8b2252;">  `salaries`.`emp_no`,</span>
<span style="color: #8b2252;">  `salaries`.`salary`,</span>
<span style="color: #8b2252;">  `salaries`.`from_date`,</span>
<span style="color: #8b2252;">  `salaries`.`to_date`</span>
<span style="color: #8b2252;">FROM</span>
<span style="color: #8b2252;">  `salaries`</span>
<span style="color: #8b2252;">WHERE</span>
<span style="color: #8b2252;">  `salaries`.`emp_no` = 10004</span>
<span style="color: #8b2252;">"""</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#26696;2 &#20174;&#22810;&#31471;&#24448;&#19968;&#31471;&#19978;&#26597;(&#20174;&#24037;&#36164;&#34920;&#24448;&#21592;&#24037;&#34920;&#26597;) &#19981;&#22909; &#22240;&#20026;&#19981;&#30693;&#36947;&#21592;&#24037;&#30340;id</span>
<span style="color: #a0522d;">salaries</span> = smgr.<span style="color: #483d8b;">filter</span>(emp_no=10004).<span style="color: #483d8b;">all</span>()
<span style="color: #a020f0;">for</span> x <span style="color: #a020f0;">in</span> salaries:

    <span style="color: #483d8b;">print</span>(x)
    <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">    SELECT</span>
<span style="color: #8b2252;">    `salaries`.`id`,</span>
<span style="color: #8b2252;">    `salaries`.`emp_no`,</span>
<span style="color: #8b2252;">    `salaries`.`salary`,</span>
<span style="color: #8b2252;">    `salaries`.`from_date`,</span>
<span style="color: #8b2252;">    `salaries`.`to_date`</span>
<span style="color: #8b2252;">    FROM</span>
<span style="color: #8b2252;">    `salaries`</span>
<span style="color: #8b2252;">    WHERE</span>
<span style="color: #8b2252;">    `salaries`.`emp_no` = 10004;</span>
<span style="color: #8b2252;">    """</span>
    <span style="color: #a0522d;">e</span> = x.emp_no <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20250;&#24341;&#21457;&#22635;&#20805;Employee&#31867;&#30340;&#23545;&#35937;</span>
    <span style="color: #483d8b;">print</span>(e.name) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#35302;&#21457;&#20102;&#21592;&#24037;&#34920;&#30340;&#26597;&#35810;&#12290; &#19981;&#22909;&#12290;&#22810;&#27425;&#21516;&#19968;SQL&#26597;&#35810;&#12290;</span>
    <span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">    SELECT</span>
<span style="color: #8b2252;">    `employees`.`emp_no`,</span>
<span style="color: #8b2252;">    `employees`.`birth_date`,</span>
<span style="color: #8b2252;">    `employees`.`first_name`,</span>
<span style="color: #8b2252;">    `employees`.`last_name`,</span>
<span style="color: #8b2252;">    `employees`.`gender`,</span>
<span style="color: #8b2252;">    `employees`.`hire_date`</span>
<span style="color: #8b2252;">    FROM</span>
<span style="color: #8b2252;">    `employees`</span>
<span style="color: #8b2252;">    WHERE</span>
<span style="color: #8b2252;">    `employees`.`emp_no` = 10004;</span>
<span style="color: #8b2252;">    """</span>
</pre>
</div>

<p>
如果觉得salary_set不好用，可以使用related_name修改该属性名
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">class</span> <span style="color: #228b22;">Salary</span>(models.Model):
    ... ...
    <span style="color: #a0522d;">emp_no</span> = models.ForeignKey(<span style="color: #8b2252;">'Employee'</span>, on_delete=models.CASCADE, db_column=<span style="color: #8b2252;">'emp_no'</span>, related_name=<span style="color: #8b2252;">'salaries'</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31867;&#21517;&#31216;&#65292;&#30452;&#25509;&#23558;emp_no&#26032;&#24314;&#25104;&#22806;&#38190;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">emgr</span> = Employee.objects <span style="color: #b22222;">#</span><span style="color: #b22222;">salary_set &#22312;Employee&#31867;&#20013;&#23450;&#20041;&#30340;</span>
<span style="color: #a0522d;">smgr</span> = Salary.objects
<span style="color: #483d8b;">print</span>(*Employee.<span style="color: #483d8b;">__dict__</span>.items(), sep=<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#32467;&#26524;&#12290;salary_set&#23646;&#24615;&#21517;&#26367;&#25442;&#20026;salaries</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">('salaries', &lt;django.db.models.fields.related_descriptors.ReverseManyToOneDescriptor object at 0x000001EABFF55F30&gt;)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#25968;&#25454;</span>
<span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee, Salary
<span style="color: #a020f0;">from</span> django.db.models <span style="color: #a020f0;">import</span> Q, Max, Min, Avg, Count, Sum

<span style="color: #a0522d;">emgr</span> = Employee.objects <span style="color: #b22222;">#</span><span style="color: #b22222;">salary_set &#22312;Employee&#31867;&#20013;&#23450;&#20041;&#30340;</span>
<span style="color: #a0522d;">smgr</span> = Salary.objects

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#21592;&#24037;10004&#30340;&#25152;&#26377;&#24037;&#36164;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26041;&#26696;1 &#20174;&#19968;&#31471;&#24448;&#22810;&#31471;&#19978;&#26597;(&#20174;&#21592;&#24037;&#24448;&#24037;&#36164;&#34920;&#26597;) &#22909;</span>
<span style="color: #a0522d;">emp</span> = emgr.get(emp_no=10004) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#19968;&#20010;Employee&#31867;&#30340;&#23545;&#35937;&#12290;&#21482;&#29992;&#20027;&#38190;&#23450;&#20301;&#20102;&#19968;&#26465;&#25968;&#25454;&#12290;&#22909;&#12290;</span>
<span style="color: #483d8b;">print</span>(emp) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#27809;&#26377;&#26597;&#35810;&#24037;&#36164;&#34920;</span>
<span style="color: #483d8b;">print</span>(emp.salaries.<span style="color: #483d8b;">all</span>()) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&#19968;&#20010;&#26597;&#35810;&#38598;&#65292;&#35302;&#21457;salary&#34920;&#30340;&#26597;&#35810;&#12290;</span>
<span style="color: #483d8b;">print</span>(emp.salaries.values(<span style="color: #8b2252;">'emp_no'</span>, <span style="color: #8b2252;">'from_date'</span>, <span style="color: #8b2252;">'salary'</span>)) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25237;&#24433;</span>
<span style="color: #483d8b;">print</span>(emp.salaries.<span style="color: #483d8b;">filter</span>(salary__gt=55000).<span style="color: #483d8b;">all</span>()) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#24037;&#36164;&#22823;&#20110;55000</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:3d1bb668-5853-4072-aac9-8f98bf185e17" class="outline-4">
<h4 id="h:3d1bb668-5853-4072-aac9-8f98bf185e17">distinct&#x2013;&#x2014;》去重</h4>
<div class="outline-text-4" id="text-h:3d1bb668-5853-4072-aac9-8f98bf185e17">
<p>
目标，查询工资salary&gt;60000的所有员工信息
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">import</span> django

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#32771;wsgi.py &#21152;&#36733;&#21021;&#22987;&#29615;&#22659;</span>
os.environ.setdefault(<span style="color: #8b2252;">'DJANGO_SETTINGS_MODULE'</span>, <span style="color: #8b2252;">'salary.settings'</span>)
django.setup()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#25968;&#25454;</span>
<span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee, Salary
<span style="color: #a020f0;">from</span> django.db.models <span style="color: #a020f0;">import</span> Q, Max, Min, Avg, Count, Sum

<span style="color: #a0522d;">emgr</span> = Employee.objects <span style="color: #b22222;">#</span><span style="color: #b22222;">salary_set &#22312;Employee&#31867;&#20013;&#23450;&#20041;&#30340;</span>
<span style="color: #a0522d;">smgr</span> = Salary.objects

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#25152;&#26377;&#21457;&#20102;&#24037;&#36164;&#30340;&#21592;&#24037;</span>
<span style="color: #483d8b;">print</span>(smgr.values(<span style="color: #8b2252;">'emp_no'</span>).distinct())
<span style="color: #b22222;">#</span><span style="color: #b22222;">SELECT DISTINCT `salaries`.`emp_no` FROM `salaries` LIMIT 21;</span>

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24037;&#36164;&#22823;&#20110;55000&#30340;&#25152;&#26377;&#21592;&#24037;&#30340;&#22995;&#21517;</span>
<span style="color: #a0522d;">emps</span> = smgr.<span style="color: #483d8b;">filter</span>(salary__gt=55000).values(<span style="color: #8b2252;">'emp_no'</span>).distinct() <span style="color: #b22222;">#</span><span style="color: #b22222;">&#26597;&#35810;&#38598; queryset</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(emps))
<span style="color: #483d8b;">print</span>(emps.<span style="color: #483d8b;">filter</span>(emp_no__in=[d.get(<span style="color: #8b2252;">'emp_no'</span>) <span style="color: #a020f0;">for</span> d <span style="color: #a020f0;">in</span> emps])) <span style="color: #b22222;">#</span><span style="color: #b22222;">in&#21015;&#34920;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">SELECT DISTINCT `salaries`.`emp_no` FROM `salaries` WHERE `salaries`.`salary` &gt; 55000; </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">| emp_no |</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">+--------+</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">|  10001 |</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">|  10002 |</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">|  10004 |</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">SELECT DISTINCT `salaries`.`emp_no` FROM `salaries` </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">WHERE (`salaries`.`salary` &gt; 55000 AND `salaries`.`emp_no` IN (10001, 10002, 10004));</span>

<span style="color: #483d8b;">print</span>(emps.<span style="color: #483d8b;">filter</span>(emp_no__in=emps)) <span style="color: #b22222;">#</span><span style="color: #b22222;">in&#23376;&#26597;&#35810;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">SELECT DISTINCT `salaries`.`emp_no` FROM `salaries` </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">WHERE (`salaries`.`salary` &gt; 55000 AND `salaries`.`emp_no` IN </span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">(SELECT DISTINCT U0.`emp_no` FROM `salaries` U0 WHERE U0.`salary` &gt; 55000)) LIMIT 21;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:c31066f7-bc74-44e7-b8cb-217615bcaab5" class="outline-4">
<h4 id="h:c31066f7-bc74-44e7-b8cb-217615bcaab5">raw的使用&#x2014;&gt;执行原生SQL语句</h4>
<div class="outline-text-4" id="text-h:c31066f7-bc74-44e7-b8cb-217615bcaab5">
<div class="org-src-container">
<pre class="src src-sh">-- &#23558;salaries&#34920;&#21644;employees&#34920;&#21512;&#24182;&#65292;&#28982;&#21518;&#26597;&#35810;salary&#22823;&#20110;55000&#30340;&#21592;&#24037;&#21517;
MariaDB [test]&gt; select distinct e.first_name,e.last_name from salaries as s  join employees as e on s.emp_no=e.emp_no where s.salary&gt;55000;
+------------+-----------+
| first_name | last_name |
+------------+-----------+
| Georgi     | Facello   |
| Bezalel    | Simmel    |
| Chirstian  | Koblick   |
+------------+-----------+

mysql&gt; select DISTINCT e.* from employees e JOIN salaries s on e.emp_no = s.emp_no WHERE salary &gt; 55000;
+--------+------------+------------+-----------+--------+------------+
| emp_no | birth_date | first_name | last_name | gender | hire_date  |
+--------+------------+------------+-----------+--------+------------+
|  10001 | 1953-09-02 | Georgi     | Facello   |      1 | 1986-06-26 |
|  10002 | 1964-06-02 | Bezalel    | Simmel    |      2 | 1985-11-21 |
|  10004 | 1954-05-01 | Chirstian  | Koblick   |      1 | 1986-12-01 |
+--------+------------+------------+-----------+--------+------------+
</pre>
</div>

<p>
使用raw，在django中执行
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">import</span> django

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#32771;wsgi.py &#21152;&#36733;&#21021;&#22987;&#29615;&#22659;</span>
os.environ.setdefault(<span style="color: #8b2252;">'DJANGO_SETTINGS_MODULE'</span>, <span style="color: #8b2252;">'salary.settings'</span>)
django.setup()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#25968;&#25454;</span>
<span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee, Salary
<span style="color: #a020f0;">from</span> django.db.models <span style="color: #a020f0;">import</span> Q, Max, Min, Avg, Count, Sum

<span style="color: #a0522d;">emgr</span> = Employee.objects <span style="color: #b22222;">#</span><span style="color: #b22222;">salary_set &#22312;Employee&#31867;&#20013;&#23450;&#20041;&#30340;</span>
<span style="color: #a0522d;">smgr</span> = Salary.objects

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#24037;&#36164;&#22823;&#20110;55000&#30340;&#25152;&#26377;&#21592;&#24037;&#30340;&#22995;&#21517;</span>
<span style="color: #a0522d;">sql</span> = <span style="color: #8b2252;">"""\</span>
<span style="color: #8b2252;">select</span>
<span style="color: #8b2252;">  DISTINCT e.*</span>
<span style="color: #8b2252;">from</span>
<span style="color: #8b2252;">  employees e</span>
<span style="color: #8b2252;">  JOIN salaries s ON e.emp_no = s.emp_no</span>
<span style="color: #8b2252;">WHERE</span>
<span style="color: #8b2252;">  salary &gt; 55000;</span>
<span style="color: #8b2252;">"""</span>

<span style="color: #a0522d;">emps</span> = emgr.raw(sql)
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">type</span>(emps)) <span style="color: #b22222;">#</span><span style="color: #b22222;">RawQuerySet</span>
<span style="color: #483d8b;">print</span>(<span style="color: #483d8b;">list</span>(emps))
<span style="color: #b22222;"># </span><span style="color: #b22222;">[&lt;Employee 10001, Georgi Facello&gt;, &lt;Employee 10002, Bezalel Simmel&gt;, &lt;Employee 10004, Chirstian Koblick&gt;]</span>

<span style="color: #a020f0;">for</span> e <span style="color: #a020f0;">in</span> emps:
    <span style="color: #483d8b;">print</span>(e.emp_no, e.first_name)
<span style="color: #b22222;"># </span><span style="color: #b22222;">10001 Georgi</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">10002 Bezalel</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">10004 Chirstian</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">&#24037;&#36164;&#22823;&#20110;70000&#30340;&#25152;&#26377;&#21592;&#24037;&#30340;&#22995;&#21517;</span>
<span style="color: #a0522d;">sql</span> = <span style="color: #8b2252;">"""\</span>
<span style="color: #8b2252;">select</span>
<span style="color: #8b2252;">  DISTINCT </span>
<span style="color: #8b2252;">  e.emp_no,</span>
<span style="color: #8b2252;">  e.first_name,</span>
<span style="color: #8b2252;">  e.last_name,</span>
<span style="color: #8b2252;">  s.salary</span>
<span style="color: #8b2252;">from</span>
<span style="color: #8b2252;">  employees e</span>
<span style="color: #8b2252;">  JOIN salaries s ON e.emp_no = s.emp_no</span>
<span style="color: #8b2252;">WHERE</span>
<span style="color: #8b2252;">  salary &gt; 70000;</span>
<span style="color: #8b2252;">"""</span>

<span style="color: #a0522d;">emps</span> = emgr.raw(sql)
<span style="color: #a020f0;">for</span> e <span style="color: #a020f0;">in</span> emps:
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(e.__dict__)</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(e.salaries.all())</span>
    <span style="color: #b22222;"># </span><span style="color: #b22222;">print(e.gender) #e.gender &#22312;sql&#20013;&#27809;&#26377;&#25237;&#24433;&#65292;&#20250;&#35302;&#21457;&#26597;&#24211;&#65292;&#25928;&#29575;&#20302;</span>
    <span style="color: #483d8b;">print</span>(e.emp_no, e.name, e.salary)
<span style="color: #b22222;"># </span><span style="color: #b22222;">10001 % Georgi-Facello % 71046</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">10001 % Georgi-Facello % 74333</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">... ...</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#37324;&#26597;&#35810;&#20102;&#21069;&#38754;&#25237;&#24433;&#30340;&#23383;&#27573;&#65292;&#20063;&#26377;&#27809;&#26377;&#25237;&#24433;&#30340;&#23383;&#27573;.</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:d4bd12ba-b3a1-4b73-9be7-b55add780104" class="outline-3">
<h3 id="h:d4bd12ba-b3a1-4b73-9be7-b55add780104">多对多</h3>
<div class="outline-text-3" id="text-h:d4bd12ba-b3a1-4b73-9be7-b55add780104">
</div>
<div id="outline-container-h:b6ab0381-6df4-431d-9d91-1229d2c44fb7" class="outline-4">
<h4 id="h:b6ab0381-6df4-431d-9d91-1229d2c44fb7">多对多表</h4>
<div class="outline-text-4" id="text-h:b6ab0381-6df4-431d-9d91-1229d2c44fb7">
<p>
三个表
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#21592;&#24037;&#34920;</span>
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `employees` (
  `emp_no` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `birth_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `first_name` <span style="color: #228b22;">varchar</span>(14) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `last_name` <span style="color: #228b22;">varchar</span>(16) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `gender` <span style="color: #228b22;">smallint</span>(6) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> <span style="color: #a020f0;">DEFAULT</span> 1 COMMENT <span style="color: #8b2252;">'M=1, F=2'</span>,
  `hire_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`emp_no`)
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8mb3;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#37096;&#38376;&#34920;</span>
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `departments` (
  `dept_no` <span style="color: #228b22;">char</span>(4) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `dept_name` <span style="color: #228b22;">varchar</span>(40) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`dept_no`),
  <span style="color: #a020f0;">UNIQUE</span> <span style="color: #a020f0;">KEY</span> `dept_name` (`dept_name`)
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8mb3;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31532;&#19977;&#24352;&#34920;</span>
<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `dept_emp` (
  `emp_no` <span style="color: #228b22;">int</span>(11) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `dept_no` <span style="color: #228b22;">char</span>(4) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `from_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `to_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`emp_no`,`dept_no`),
  <span style="color: #a020f0;">KEY</span> `dept_no` (`dept_no`),
  <span style="color: #a020f0;">CONSTRAINT</span> `dept_emp_ibfk_1` <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`emp_no`) <span style="color: #a020f0;">REFERENCES</span> `employees` (`emp_no`) <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">CASCADE</span>,
  <span style="color: #a020f0;">CONSTRAINT</span> `dept_emp_ibfk_2` <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`dept_no`) <span style="color: #a020f0;">REFERENCES</span> `departments` (`dept_no`) <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">CASCADE</span>
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8;
</pre>
</div>

<p>
联合主键问题依然存在。需要修改dept_emp表，增加id自增主键
</p>

<div class="org-src-container">
<pre class="src src-sql"><span style="color: #b22222;">-- </span><span style="color: #b22222;">&#21024;&#38500;&#22806;&#38190;</span>
<span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">dept_emp</span> <span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> dept_emp_ibfk_1;
<span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">dept_emp</span> <span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> dept_emp_ibfk_2;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#21024;&#38500;&#21407;&#26377;&#30340;&#32852;&#21512;&#20027;&#38190;</span>
<span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">dept_emp</span> <span style="color: #a020f0;">DROP</span> <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span>;
<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#28155;&#21152;&#26032;&#30340;&#33258;&#22686;&#20027;&#38190;&#21015; id&#12290; FIRS&#23558; id &#21015;&#25918;&#22312;&#34920;&#30340;&#31532;&#19968;&#21015;&#65288;&#40664;&#35748;&#28155;&#21152;&#21040;&#26411;&#23614;&#65289;</span>
<span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">dept_emp</span> <span style="color: #a020f0;">ADD</span> <span style="color: #a020f0;">COLUMN</span> id <span style="color: #228b22;">INT</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> AUTO_INCREment <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> <span style="color: #a020f0;">FIRST</span>;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#28155;&#21152;&#26032;&#22806;&#38190;&#65288;&#21517;&#31216;&#25913;&#20026; salaries_ibfk_1&#65289;</span>
<span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">dept_emp</span> <span style="color: #a020f0;">ADD</span> <span style="color: #a020f0;">CONSTRAINT</span> `dept_emp_ibfk_1` 
<span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`emp_no`) 
<span style="color: #a020f0;">REFERENCES</span> `employees` (`emp_no`) 
<span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">CASCADE</span> 
<span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">UPDATE</span> <span style="color: #a020f0;">RESTRICT</span>;

<span style="color: #a020f0;">ALTER</span> <span style="color: #a020f0;">TABLE</span> <span style="color: #0000ff;">dept_emp</span> <span style="color: #a020f0;">ADD</span> <span style="color: #a020f0;">CONSTRAINT</span> `dept_emp_ibfk_2` 
<span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`dept_no`) 
<span style="color: #a020f0;">REFERENCES</span> `departments` (`dept_no`) 
<span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">CASCADE</span> 
<span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">UPDATE</span> <span style="color: #a020f0;">RESTRICT</span>;

<span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31579;&#36873;&#20986;&#22806;&#38190;&#32422;&#26463;</span>
<span style="color: #a020f0;">SELECT</span> 
    <span style="color: #a020f0;">TABLE_NAME</span>, <span style="color: #b22222;">-- </span><span style="color: #b22222;">&#23376;&#34920;&#21517;</span>
    <span style="color: #a020f0;">COLUMN_NAME</span>, <span style="color: #b22222;">-- </span><span style="color: #b22222;">&#23376;&#34920;&#22806;&#38190;&#21015;&#21517;</span>
    <span style="color: #a020f0;">CONSTRAINT_NAME</span>, <span style="color: #b22222;">-- </span><span style="color: #b22222;">&#22806;&#38190;&#32422;&#26463;&#21517;</span>
    REFERENCED_TABLE_NAME, <span style="color: #b22222;">-- </span><span style="color: #b22222;">&#29238;&#34920;&#21517;</span>
    REFERENCED_COLUMN_NAME <span style="color: #b22222;">-- </span><span style="color: #b22222;">&#29238;&#34920;&#20851;&#32852;&#21015;&#21517;</span>
<span style="color: #a020f0;">FROM</span> 
    INFORMATION_SCHEMA.KEY_COLUMN_USAGE
<span style="color: #a020f0;">WHERE</span> 
    TABLE_SCHEMA = <span style="color: #8b2252;">'test'</span> <span style="color: #b22222;">-- </span><span style="color: #b22222;">&#25351;&#23450;&#25968;&#25454;&#24211;&#21517;&#65288;&#27169;&#24335;&#21517;&#65289;</span>
    <span style="color: #a020f0;">AND</span> REFERENCED_TABLE_NAME <span style="color: #a020f0;">IS</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>; <span style="color: #b22222;">-- </span><span style="color: #b22222;">&#31579;&#36873;&#20986;&#22806;&#38190;&#32422;&#26463;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">mysql&gt; SELECT 
    -&gt;     TABLE_NAME, -- 
    -&gt;     COLUMN_NAME, -- 
    -&gt;     CONSTRAINT_NAME, -- 
    -&gt;     REFERENCED_TABLE_NAME, -- 
    -&gt;     REFERENCED_COLUMN_NAME -- 
    -&gt; FROM 
    -&gt;     INFORMATION_SCHEMA.KEY_COLUMN_USAGE
    -&gt; WHERE 
    -&gt;     TABLE_SCHEMA = <span style="color: #8b2252;">'test'</span> -- 
    -&gt;     AND REFERENCED_TABLE_NAME IS NOT NULL; -- 
+------------+-------------+-----------------+-----------------------+------------------------+
| TABLE_NAME | COLUMN_NAME | CONSTRAINT_NAME | REFERENCED_TABLE_NAME | REFERENCED_COLUMN_NAME |
+------------+-------------+-----------------+-----------------------+------------------------+
| dept_emp   | emp_no      | dept_emp_ibfk_1 | employees             | emp_no                 |
| dept_emp   | dept_no     | dept_emp_ibfk_2 | departments           | dept_no                |
| salaries   | emp_no      | salaries_ibfk_1 | employees             | emp_no                 |
| titles     | emp_no      | titles_ibfk_1   | employees             | emp_no                 |
+------------+-------------+-----------------+-----------------------+------------------------+
</pre>
</div>

<p>
新表结构
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> `dept_emp` (
  `id` <span style="color: #228b22;">int</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> AUTO_INCREMENT,
  `emp_no` <span style="color: #228b22;">int</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `dept_no` <span style="color: #228b22;">char</span>(4) <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `from_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  `to_date` <span style="color: #228b22;">date</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
  <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (`id`),
  <span style="color: #a020f0;">KEY</span> `dept_no` (`dept_no`),
  <span style="color: #a020f0;">KEY</span> `dept_emp_ibfk_1` (`emp_no`),
  <span style="color: #a020f0;">CONSTRAINT</span> `dept_emp_ibfk_1` <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`emp_no`) <span style="color: #a020f0;">REFERENCES</span> `employees` (`emp_no`) <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">CASCADE</span> <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">UPDATE</span> <span style="color: #a020f0;">RESTRICT</span>,
  <span style="color: #a020f0;">CONSTRAINT</span> `dept_emp_ibfk_2` <span style="color: #a020f0;">FOREIGN</span> <span style="color: #a020f0;">KEY</span> (`dept_no`) <span style="color: #a020f0;">REFERENCES</span> `departments` (`dept_no`) <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">CASCADE</span> <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">UPDATE</span> <span style="color: #a020f0;">RESTRICT</span>
) ENGINE=InnoDB <span style="color: #a020f0;">DEFAULT</span> CHARSET=utf8mb3;
</pre>
</div>
</div>
</div>
<div id="outline-container-h:87e5b259-8e5a-4565-8556-99a975e321f4" class="outline-4">
<h4 id="h:87e5b259-8e5a-4565-8556-99a975e321f4">创建模型</h4>
<div class="outline-text-4" id="text-h:87e5b259-8e5a-4565-8556-99a975e321f4">
<p>
在employee/models.py文件下
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> django.db <span style="color: #a020f0;">import</span> models
<span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">CREATE TABLE `employees` (</span>
<span style="color: #8b2252;">  `emp_no` int(11) NOT NULL,</span>
<span style="color: #8b2252;">  `birth_date` date NOT NULL,</span>
<span style="color: #8b2252;">  `first_name` varchar(14) NOT NULL,</span>
<span style="color: #8b2252;">  `last_name` varchar(16) NOT NULL,</span>
<span style="color: #8b2252;">  `gender` smallint(6) NOT NULL DEFAULT 1 COMMENT 'M=1, F=2',</span>
<span style="color: #8b2252;">  `hire_date` date NOT NULL,</span>
<span style="color: #8b2252;">  PRIMARY KEY (`emp_no`)</span>
<span style="color: #8b2252;">) ENGINE=InnoDB DEFAULT CHARSET=utf8; </span>
<span style="color: #8b2252;">"""</span>
<span style="color: #b22222;"># </span><span style="color: #b22222;">Create your models here.</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Employee</span>(models.Model): <span style="color: #b22222;">#</span><span style="color: #b22222;">metaclass=ModelBase</span>
    <span style="color: #a020f0;">class</span> <span style="color: #228b22;">Meta</span>:
        <span style="color: #a0522d;">db_table</span> = <span style="color: #8b2252;">'employees'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23450;&#20041;&#34920;&#21517;</span>

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#23558;&#21015;&#21517;&#19968;&#19968;&#26144;&#23556;&#20986;&#26469;</span>
    <span style="color: #a0522d;">emp_no</span> = models.IntegerField(primary_key=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">birth_date</span> = models.DateField(null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">first_name</span> = models.CharField(null=<span style="color: #008b8b;">False</span>, max_length=14) <span style="color: #b22222;">#</span><span style="color: #b22222;">varchar(14) NOT NULL,</span>
    <span style="color: #a0522d;">last_name</span> = models.CharField(null=<span style="color: #008b8b;">False</span>, max_length=16)
    <span style="color: #a0522d;">gender</span> = models.SmallIntegerField(null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">hire_date</span> = models.DateField(null=<span style="color: #008b8b;">False</span>)

    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#28155;&#21152;&#23646;&#24615;</span>
    @<span style="color: #483d8b;">property</span>
    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">name</span>(<span style="color: #a020f0;">self</span>): <span style="color: #b22222;">#</span><span style="color: #b22222;">fullname()</span>
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">"% {}-{} %"</span>.<span style="color: #483d8b;">format</span>(<span style="color: #a020f0;">self</span>.first_name,<span style="color: #a020f0;">self</span>.last_name)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#20889;&#21487;&#35270;&#21270;&#25928;&#26524;</span>
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'&lt;Employee {}, {} {}&gt;'</span>.<span style="color: #483d8b;">format</span>(<span style="color: #a020f0;">self</span>.emp_no, <span style="color: #a020f0;">self</span>.first_name, <span style="color: #a020f0;">self</span>.last_name)

    <span style="color: #a0522d;">__str__</span> = __repr__

<span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">CREATE TABLE `salaries` (</span>
<span style="color: #8b2252;">  `id` int NOT NULL AUTO_INCREMENT,</span>
<span style="color: #8b2252;">  `emp_no` int NOT NULL,</span>
<span style="color: #8b2252;">  `salary` int NOT NULL,</span>
<span style="color: #8b2252;">  `from_date` date NOT NULL,</span>
<span style="color: #8b2252;">  `to_date` date NOT NULL,</span>
<span style="color: #8b2252;">  PRIMARY KEY (`id`) USING BTREE,</span>
<span style="color: #8b2252;">  INDEX `emp_no` (`emp_no` ASC) USING BTREE,</span>
<span style="color: #8b2252;">  CONSTRAINT `salaries_ibfk_1` FOREIGN KEY (`emp_no`) </span>
<span style="color: #8b2252;">  REFERENCES `test`.`employees` (`emp_no`) </span>
<span style="color: #8b2252;">  ON DELETE CASCADE </span>
<span style="color: #8b2252;">  ON UPDATE RESTRICT</span>
<span style="color: #8b2252;">) ENGINE=InnoDB  DEFAULT CHARSET=utf8mb3;</span>
<span style="color: #8b2252;">"""</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Salary</span>(models.Model):
    <span style="color: #a020f0;">class</span> <span style="color: #228b22;">Meta</span>:
        <span style="color: #a0522d;">db_table</span> = <span style="color: #8b2252;">'salaries'</span>

    <span style="color: #483d8b;">id</span> = models.AutoField(primary_key=<span style="color: #008b8b;">True</span>, null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">emp_no</span> = models.ForeignKey(<span style="color: #8b2252;">'Employee'</span>, on_delete=models.CASCADE, db_column=<span style="color: #8b2252;">'emp_no'</span>, related_name=<span style="color: #8b2252;">'salaries'</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31867;&#21517;&#31216;&#65292;&#30452;&#25509;&#23558;emp_no&#26032;&#24314;&#25104;&#22806;&#38190;</span>
    <span style="color: #b22222;">#</span><span style="color: #b22222;">&#20027;&#34920;&#30340;&#23383;&#27573;&#21517;emp_no&#65292;&#20174;&#34920;&#20013;&#30340;&#22806;&#38190;&#23383;&#27573;&#21517;&#40664;&#35748;&#20026;emp_no_id &#65292;&#21487;&#20197;&#36890;&#36807;db_column='emp_no'&#20462;&#25913;&#22806;&#38190;&#23383;&#27573;&#21517;</span>
    <span style="color: #a0522d;">salary</span> = models.IntegerField(null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">from_date</span> = models.DateField(null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">to_date</span> = models.DateField(null=<span style="color: #008b8b;">False</span>)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):<span style="color: #b22222;">#</span><span style="color: #b22222;">&#37325;&#20889;&#21487;&#35270;&#21270;&#25928;&#26524;</span>
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'&lt;Salary {}, {} {}&gt;'</span>.<span style="color: #483d8b;">format</span>(
            <span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">id</span>, 
            <span style="color: #b22222;"># </span><span style="color: #b22222;">self.emp_no, #&#36820;&#22238;&lt;Employee 10001, Georgi Facello&gt; &#26159;Employee&#31867;&#30340;&#23545;&#35937;</span>
            <span style="color: #a020f0;">self</span>.emp_no_id,  <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#26679;&#19981;&#20250;&#24341;&#36215;&#31532;2&#24352;&#34920;&#30340;&#26597;&#35810;</span>
            <span style="color: #a020f0;">self</span>.salary)
        <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36820;&#22238;&lt;Salary 1, &lt;Employee 10001, Georgi Facello&gt; 60117&gt;</span>
    <span style="color: #a0522d;">__str__</span> = __repr__

<span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">CREATE TABLE `departments` (</span>
<span style="color: #8b2252;">  `dept_no` char(4) NOT NULL,</span>
<span style="color: #8b2252;">  `dept_name` varchar(40) NOT NULL,</span>
<span style="color: #8b2252;">  PRIMARY KEY (`dept_no`),</span>
<span style="color: #8b2252;">  UNIQUE KEY `dept_name` (`dept_name`)</span>
<span style="color: #8b2252;">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3;</span>
<span style="color: #8b2252;">"""</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Department</span>(models.Model):
    <span style="color: #a020f0;">class</span> <span style="color: #228b22;">Meta</span>:
        <span style="color: #a0522d;">db_table</span> = <span style="color: #8b2252;">'departments'</span>
    <span style="color: #a0522d;">dept_no</span> = models.CharField(primary_key=<span style="color: #008b8b;">True</span>, null=<span style="color: #008b8b;">False</span>, max_length=4)
    <span style="color: #a0522d;">dept_name</span> = models.CharField(unique=<span style="color: #008b8b;">True</span>, null=<span style="color: #008b8b;">False</span>, max_length=40)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'&lt;Dept: {}, {} &gt;'</span>.<span style="color: #483d8b;">format</span>(<span style="color: #a020f0;">self</span>.dept_no, <span style="color: #a020f0;">self</span>.dept_name)

    <span style="color: #a0522d;">__str__</span> = __repr__

<span style="color: #8b2252;">"""</span>
<span style="color: #8b2252;">CREATE TABLE `dept_emp` (</span>
<span style="color: #8b2252;">  `id` int NOT NULL AUTO_INCREMENT,</span>
<span style="color: #8b2252;">  `emp_no` int NOT NULL,</span>
<span style="color: #8b2252;">  `dept_no` char(4) NOT NULL,</span>
<span style="color: #8b2252;">  `from_date` date NOT NULL,</span>
<span style="color: #8b2252;">  `to_date` date NOT NULL,</span>
<span style="color: #8b2252;">  PRIMARY KEY (`id`),</span>
<span style="color: #8b2252;">  KEY `dept_no` (`dept_no`),</span>
<span style="color: #8b2252;">  KEY `dept_emp_ibfk_1` (`emp_no`),</span>
<span style="color: #8b2252;">  CONSTRAINT `dept_emp_ibfk_1` FOREIGN KEY (`emp_no`) REFERENCES `employees` (`emp_no`) ON DELETE CASCADE ON UPDATE RESTRICT,</span>
<span style="color: #8b2252;">  CONSTRAINT `dept_emp_ibfk_2` FOREIGN KEY (`dept_no`) REFERENCES `departments` (`dept_no`) ON DELETE CASCADE ON UPDATE RESTRICT</span>
<span style="color: #8b2252;">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3;</span>
<span style="color: #8b2252;">"""</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Dept_emp</span>(models.Model):
    <span style="color: #a020f0;">class</span> <span style="color: #228b22;">Meta</span>:
        <span style="color: #a0522d;">db_table</span> = <span style="color: #8b2252;">'dept_emp'</span>
    <span style="color: #483d8b;">id</span> = models.IntegerField(primary_key=<span style="color: #008b8b;">True</span>)
    <span style="color: #a0522d;">emp_no</span> = models.ForeignKey(<span style="color: #8b2252;">'Employee'</span>, on_delete=models.CASCADE, db_column=<span style="color: #8b2252;">'emp_no'</span>, related_name=<span style="color: #8b2252;">'dept_emp'</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31867;&#21517;&#31216;</span>
    <span style="color: #a0522d;">dept_no</span> = models.ForeignKey(<span style="color: #8b2252;">'Department'</span>, on_delete=models.CASCADE, db_column=<span style="color: #8b2252;">'dept_no'</span>, related_name=<span style="color: #8b2252;">'dept_emp'</span>) <span style="color: #b22222;">#</span><span style="color: #b22222;">&#31867;&#21517;&#31216;</span>
    <span style="color: #a0522d;">from_date</span> = models.DateField(null=<span style="color: #008b8b;">False</span>)
    <span style="color: #a0522d;">to_date</span> = models.DateField(null=<span style="color: #008b8b;">False</span>)

    <span style="color: #a020f0;">def</span> <span style="color: #0000ff;">__repr__</span>(<span style="color: #a020f0;">self</span>):
        <span style="color: #a020f0;">return</span> <span style="color: #8b2252;">'&lt;D-E: {}: {}, {}&gt;'</span>.<span style="color: #483d8b;">format</span>(<span style="color: #a020f0;">self</span>.<span style="color: #483d8b;">id</span>, <span style="color: #a020f0;">self</span>.emp_no_id, <span style="color: #a020f0;">self</span>.dept_no_id)
               <span style="color: #b22222;">#</span><span style="color: #b22222;">&#36825;&#37324;&#25913;&#25104;emp_no_id &#26159;&#20026;&#20102;&#38450;&#27490;&#20108;&#27425;&#26597;&#35810;&#36896;&#25104;&#36164;&#28304;&#28010;&#36153;</span>
    <span style="color: #a0522d;">__str__</span> = __repr__
</pre>
</div>
</div>
</div>
<div id="outline-container-h:1b9a7871-9e87-42f2-80c9-8e999363b05d" class="outline-4">
<h4 id="h:1b9a7871-9e87-42f2-80c9-8e999363b05d">使用查询</h4>
<div class="outline-text-4" id="text-h:1b9a7871-9e87-42f2-80c9-8e999363b05d">
<p>
查询emp_no=10010的部门编号以及部门名称和员工信息
</p>
<div class="org-src-container">
<pre class="src src-sh">mysql&gt; select * from employees e join dept_emp de on e.emp_no = de.emp_no AND e.emp_no=10010;
+--------+------------+------------+-----------+--------+------------+----+--------+---------+------------+------------+
| emp_no | birth_date | first_name | last_name | gender | hire_date  | id | emp_no | dept_no | from_date  | to_date    |
+--------+------------+------------+-----------+--------+------------+----+--------+---------+------------+------------+
|  10010 | 1963-06-01 | Duangkaew  | Piveteau  |      2 | 1989-08-24 | 10 |  10010 | d004    | 1996-11-24 | 2000-06-26 |
|  10010 | 1963-06-01 | Duangkaew  | Piveteau  |      2 | 1989-08-24 | 11 |  10010 | d006    | 2000-06-26 | 9999-01-01 |
+--------+------------+------------+-----------+--------+------------+----+--------+---------+------------+------------+
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">import</span> django

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21442;&#32771;wsgi.py &#21152;&#36733;&#21021;&#22987;&#29615;&#22659;</span>
os.environ.setdefault(<span style="color: #8b2252;">'DJANGO_SETTINGS_MODULE'</span>, <span style="color: #8b2252;">'salary.settings'</span>)
django.setup()

<span style="color: #b22222;">#</span><span style="color: #b22222;">&#35775;&#38382;&#25968;&#25454;</span>
<span style="color: #a020f0;">from</span> employee.models <span style="color: #a020f0;">import</span> Employee, Salary
<span style="color: #a020f0;">from</span> django.db.models <span style="color: #a020f0;">import</span> Q, Max, Min, Avg, Count, Sum

<span style="color: #a0522d;">emgr</span> = Employee.objects <span style="color: #b22222;">#</span><span style="color: #b22222;">salary_set &#22312;Employee&#31867;&#20013;&#23450;&#20041;&#30340;</span>
<span style="color: #a0522d;">smgr</span> = Salary.objects

<span style="color: #483d8b;">print</span>(*Employee.<span style="color: #483d8b;">__dict__</span>.items(), sep=<span style="color: #8b2252;">'</span><span style="color: #008b8b;">\n</span><span style="color: #8b2252;">'</span>)

<span style="color: #b22222;">#</span><span style="color: #b22222;">10010 &#21592;&#24037;&#30340;&#20449;&#24687;&#21644;&#37096;&#38376;&#32534;&#21495;</span>
<span style="color: #a0522d;">e</span> = emgr.<span style="color: #483d8b;">filter</span>(pk=10010).first()
<span style="color: #a020f0;">if</span> e:
    <span style="color: #483d8b;">print</span>(e) <span style="color: #b22222;">#</span><span style="color: #b22222;">&lt;Employee 10010, Duangkaew Piveteau&gt;</span>
    <span style="color: #483d8b;">print</span>(e.dept_emp.<span style="color: #483d8b;">all</span>()) <span style="color: #b22222;">#</span><span style="color: #b22222;">&lt;QuerySet [&lt;D-E: 10: 10010, d004&gt;, &lt;D-E: 11: 10010, d006&gt;]&gt;</span>
    <span style="color: #483d8b;">print</span>([d.dept_no_id <span style="color: #a020f0;">for</span> d <span style="color: #a020f0;">in</span> e.dept_emp.<span style="color: #483d8b;">all</span>()]) <span style="color: #b22222;">#</span><span style="color: #b22222;">['d004', 'd006']</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:be19a5cf-c03f-49cd-85c3-b42d9525c929" class="outline-3">
<h3 id="h:be19a5cf-c03f-49cd-85c3-b42d9525c929">迁移</h3>
<div class="outline-text-3" id="text-h:be19a5cf-c03f-49cd-85c3-b42d9525c929">
<p>
如果建立好模型类，想从这些类来生成数据库的表，使用下面语句。
</p>

<div class="org-src-container">
<pre class="src src-sh">python manage.py makemigrations <span style="color: #b22222;">#</span><span style="color: #b22222;">&#29983;&#25104;&#36801;&#31227;&#25991;&#20214;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#20250;&#22312;app&#21517;&#19979;&#30340;migrations&#25991;&#20214;&#22841;&#19979;&#29983;&#25104;&#19968;&#20010;&#36801;&#31227;&#25991;&#20214;&#12290; &#22914;0001_initial.py&#25991;&#20214;&#12290;</span>
<span style="color: #b22222;">#</span><span style="color: #b22222;">&#21487;&#20197;&#20462;&#25913;DATABASES&#20013;&#30340;&#24211;&#21517;&#26469;&#23454;&#29616;&#25351;&#23450;&#24211;&#21517;&#12290;</span>

python manage.py migrate employee <span style="color: #b22222;">#</span><span style="color: #b22222;">&#25351;&#23450;app&#36827;&#34892;&#36801;&#31227;</span>
</pre>
</div>

<p>
第一次迁移，最好全部迁移. python manage.py migrate 是Django中所有为迁移的模型都生成表。
</p>
</div>
</div>
<div id="outline-container-h:b4222858-7034-4982-8fa1-574bbcabd3c9" class="outline-3">
<h3 id="h:b4222858-7034-4982-8fa1-574bbcabd3c9">显示事务处理</h3>
<div class="outline-text-3" id="text-h:b4222858-7034-4982-8fa1-574bbcabd3c9">
<p>
因为需要数据的完整性，所以需要显式控制事务
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> django.db.transaction <span style="color: #a020f0;">import</span> atomic
</pre>
</div>

<p>
两种方法
</p>

<ul class="org-ul">
<li>作为装饰器，为整个视图函数</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> django.db <span style="color: #a020f0;">import</span> transaction

<span style="color: #228b22;">@transaction.atomic</span>
<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">viewfunc</span>(request):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">This code executes inside a transaction.</span>
    do_stuff()
</pre>
</div>

<ul class="org-ul">
<li>作为上下文，对部分代码执行显示事务</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> django.db <span style="color: #a020f0;">import</span> transaction

<span style="color: #a020f0;">def</span> <span style="color: #0000ff;">viewfunc</span>(request):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">This code executes in autocommit mode (Django's default).</span>
    do_stuff()

    <span style="color: #a020f0;">with</span> transaction.atomic():
        <span style="color: #b22222;"># </span><span style="color: #b22222;">This code executes inside a transaction.</span>
        do_more_stuff()
</pre>
</div>

<p>
测试代码
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> os
<span style="color: #a020f0;">import</span> django

os.environ.setdefault(<span style="color: #8b2252;">'DJANGO_SETTINGS_MODULE'</span>, <span style="color: #8b2252;">'blog.settings'</span>)
django.setup()

<span style="color: #a020f0;">from</span> post.models <span style="color: #a020f0;">import</span> *
<span style="color: #a020f0;">from</span> django.contrib.auth.models <span style="color: #a020f0;">import</span> User
<span style="color: #a020f0;">from</span> django.db.transaction <span style="color: #a020f0;">import</span> atomic
<span style="color: #a0522d;">post</span>=Post()
<span style="color: #a0522d;">content</span>=Content()
<span style="color: #a020f0;">try</span>:
    post.<span style="color: #a0522d;">title</span>=<span style="color: #8b2252;">'sadasd'</span>
    post.<span style="color: #a0522d;">author_id</span>=User.objects.get(<span style="color: #483d8b;">id</span>=2)
    <span style="color: #a020f0;">with</span> atomic():
        post.save()
        content.<span style="color: #483d8b;">id</span>=post
        <span style="color: #a020f0;">raise</span> <span style="color: #228b22;">BufferError</span>
        content.<span style="color: #a0522d;">content</span>=<span style="color: #8b2252;">'qwer'</span>
        content.save()
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    <span style="color: #483d8b;">print</span>(e)
</pre>
</div>

<p>
当第一个表数据插入完成，抛出异常，事务会回滚
</p>
</div>
</div>
<div id="outline-container-h:3513aecb-448b-43aa-9896-ea112885e679" class="outline-3">
<h3 id="h:3513aecb-448b-43aa-9896-ea112885e679">对数据库的增删改查</h3>
<div class="outline-text-3" id="text-h:3513aecb-448b-43aa-9896-ea112885e679">
</div>
<div id="outline-container-h:8208700d-d2b3-40fd-99da-95dcf7ad8d69" class="outline-4">
<h4 id="h:8208700d-d2b3-40fd-99da-95dcf7ad8d69">增加</h4>
<div class="outline-text-4" id="text-h:8208700d-d2b3-40fd-99da-95dcf7ad8d69">
<p>
不指定主键，就默认为插入数据
</p>

<p>
例如，插入一条，作者为admin，标题为abcd 的数据
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> post.models <span style="color: #a020f0;">import</span> *
<span style="color: #a020f0;">from</span> django.contrib.auth.models <span style="color: #a020f0;">import</span> User
<span style="color: #a020f0;">from</span> django.db.transaction <span style="color: #a020f0;">import</span> atomic

<span style="color: #a0522d;">post</span> = Post()
<span style="color: #a0522d;">content</span> = Content()
<span style="color: #a020f0;">try</span>:
    post.<span style="color: #a0522d;">title</span> = <span style="color: #8b2252;">'abcd'</span>
    post.<span style="color: #a0522d;">author_id</span> = User.objects.get(username=<span style="color: #8b2252;">'admin'</span>)
    <span style="color: #a020f0;">with</span> atomic():
        post.save()
        content.<span style="color: #483d8b;">id</span> = post
        content.<span style="color: #a0522d;">content</span> = <span style="color: #8b2252;">'qwer'</span>
        content.save()
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    <span style="color: #483d8b;">print</span>(e)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:e6ec9689-ef69-4f54-9684-90bafc231e7a" class="outline-4">
<h4 id="h:e6ec9689-ef69-4f54-9684-90bafc231e7a">修改</h4>
<div class="outline-text-4" id="text-h:e6ec9689-ef69-4f54-9684-90bafc231e7a">
<p>
先查出title='aaaaa'的post表中的数据，再把数据组成的对象与content表对应，然后修改content字段
</p>

<p>
先查再修改
</p>
</div>
<div id="outline-container-h:38f7926d-b4d5-4b45-9643-6a2ce683c753" class="outline-5">
<h5 id="h:38f7926d-b4d5-4b45-9643-6a2ce683c753">多表修改</h5>
<div class="outline-text-5" id="text-h:38f7926d-b4d5-4b45-9643-6a2ce683c753">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> post.models <span style="color: #a020f0;">import</span> *
<span style="color: #a020f0;">from</span> django.contrib.auth.models <span style="color: #a020f0;">import</span> User
<span style="color: #a020f0;">from</span> django.db.transaction <span style="color: #a020f0;">import</span> atomic

<span style="color: #a0522d;">content</span> = Content()
<span style="color: #a020f0;">try</span>:
    <span style="color: #a0522d;">post</span> = Post.objects.<span style="color: #483d8b;">filter</span>(title=<span style="color: #8b2252;">'aaaaa'</span>).first()
    <span style="color: #a020f0;">with</span> atomic():
        content.<span style="color: #483d8b;">id</span> = post
        content.<span style="color: #a0522d;">content</span> = <span style="color: #8b2252;">'1111111'</span>
        content.save()
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    <span style="color: #483d8b;">print</span>(e)
</pre>
</div>
</div>
</div>
<div id="outline-container-h:b320eea6-a18f-4f90-8f59-e203459290cb" class="outline-5">
<h5 id="h:b320eea6-a18f-4f90-8f59-e203459290cb">单表本表修改</h5>
<div class="outline-text-5" id="text-h:b320eea6-a18f-4f90-8f59-e203459290cb">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> post.models <span style="color: #a020f0;">import</span> *
<span style="color: #a020f0;">from</span> django.contrib.auth.models <span style="color: #a020f0;">import</span> User
<span style="color: #a020f0;">from</span> django.db.transaction <span style="color: #a020f0;">import</span> atomic
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a020f0;">try</span>:
    <span style="color: #a0522d;">post</span> = Post.objects.<span style="color: #483d8b;">filter</span>(title=<span style="color: #8b2252;">'aaaaa'</span>).first()
    <span style="color: #a020f0;">with</span> atomic():
        post.<span style="color: #a0522d;">postdate</span>=datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=8)))
        post.save()
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    <span style="color: #483d8b;">print</span>(e)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:a20881d9-4305-49be-b6c2-cb0f640a5190" class="outline-4">
<h4 id="h:a20881d9-4305-49be-b6c2-cb0f640a5190">删除</h4>
<div class="outline-text-4" id="text-h:a20881d9-4305-49be-b6c2-cb0f640a5190">
<p>
当有外键，且从表有数据
</p>

<ul class="org-ul">
<li><p>
借助模板中从表中定义的related_name='content'，用来删除从表中的数据，再删除主表的数据
</p>

<p>
通过related_name='content'返回的数据是一个关联管理器对象，需要转换成数据对象，再进行删除
</p></li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> post.models <span style="color: #a020f0;">import</span> *
<span style="color: #a020f0;">from</span> django.contrib.auth.models <span style="color: #a020f0;">import</span> User
<span style="color: #a020f0;">from</span> django.db.transaction <span style="color: #a020f0;">import</span> atomic
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a0522d;">content</span>=Content()
<span style="color: #a020f0;">try</span>:
    <span style="color: #a0522d;">post</span> = Post.objects.<span style="color: #483d8b;">filter</span>(title=<span style="color: #8b2252;">'aaaaa'</span>).first()
    <span style="color: #a020f0;">with</span> atomic():
        post.content.first().delete()
        post.delete()
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    <span style="color: #483d8b;">print</span>(e)
</pre>
</div>

<p>
手动找到从表中的数据，然后删除
</p>

<ul class="org-ul">
<li>删除单个</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> post.models <span style="color: #a020f0;">import</span> *
<span style="color: #a020f0;">from</span> django.contrib.auth.models <span style="color: #a020f0;">import</span> User
<span style="color: #a020f0;">from</span> django.db.transaction <span style="color: #a020f0;">import</span> atomic
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a0522d;">content</span>=Content()
<span style="color: #a020f0;">try</span>:
    <span style="color: #a0522d;">post</span> = Post.objects.<span style="color: #483d8b;">filter</span>(title=<span style="color: #8b2252;">'aaaaa'</span>).first()
    <span style="color: #a020f0;">with</span> atomic():
        content.<span style="color: #483d8b;">id</span>=post
        content.delete()
        post.delete()
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    <span style="color: #483d8b;">print</span>(e)
</pre>
</div>

<ul class="org-ul">
<li>删除多个</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> post.models <span style="color: #a020f0;">import</span> *
<span style="color: #a020f0;">from</span> django.contrib.auth.models <span style="color: #a020f0;">import</span> User
<span style="color: #a020f0;">from</span> django.db.transaction <span style="color: #a020f0;">import</span> atomic
<span style="color: #a020f0;">import</span> datetime
<span style="color: #a0522d;">content</span>=Content()
<span style="color: #a020f0;">try</span>:
    <span style="color: #a0522d;">post</span> = Post.objects.<span style="color: #483d8b;">filter</span>(title=<span style="color: #8b2252;">'sadasd'</span>).<span style="color: #483d8b;">all</span>()
    <span style="color: #a020f0;">with</span> atomic():
        <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> post:
            content.<span style="color: #483d8b;">id</span>=i
            content.delete()
        post.delete()
<span style="color: #a020f0;">except</span> <span style="color: #228b22;">Exception</span> <span style="color: #a020f0;">as</span> e:
    <span style="color: #483d8b;">print</span>(e)
</pre>
</div>

<p>
以上都是查从表，然后删主表
</p>

<p>
现在的需求时知道从表内容，要连主表一起删
</p>

<p>
由从表删主表
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> datetime, os, django

<span style="color: #483d8b;">print</span>(datetime.date.fromtimestamp(datetime.datetime.now().timestamp()))
os.environ.setdefault(<span style="color: #8b2252;">'DJANGO_SETTINGS_MODULE'</span>, <span style="color: #8b2252;">'blog.settings'</span>)
django.setup(set_prefix=<span style="color: #008b8b;">False</span>)

<span style="color: #a020f0;">from</span> post.models <span style="color: #a020f0;">import</span> Post, Content
<span style="color: #a020f0;">from</span> django.db.transaction <span style="color: #a020f0;">import</span> atomic

<span style="color: #a0522d;">cont</span> = Content()

<span style="color: #a020f0;">with</span> atomic():
    <span style="color: #a0522d;">content</span> = Content.objects.<span style="color: #483d8b;">filter</span>(content=<span style="color: #8b2252;">"&#20869;&#23481;"</span>)
    <span style="color: #a0522d;">post</span> = Post()
    <span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> content:
        <span style="color: #a0522d;">post</span> = Post.objects.<span style="color: #483d8b;">filter</span>(<span style="color: #483d8b;">id</span>=i.id_id).first()
        i.delete()
        post.delete()
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-h:47802753-a311-476e-91c7-f592f9f9580e" class="outline-3">
<h3 id="h:47802753-a311-476e-91c7-f592f9f9580e">Django后台管理</h3>
<div class="outline-text-3" id="text-h:47802753-a311-476e-91c7-f592f9f9580e">
</div>
<div id="outline-container-h:4de49515-b12c-4b5e-8873-f725df32c077" class="outline-4">
<h4 id="h:4de49515-b12c-4b5e-8873-f725df32c077">创建管理员</h4>
<div class="outline-text-4" id="text-h:4de49515-b12c-4b5e-8873-f725df32c077">
<div class="org-src-container">
<pre class="src src-sh">&gt; python manage.py createsuperuser

Username : admin
Email address: admin@123.com
Password:
<span style="color: #0000ff;">Password</span> (again):
Superuser created successfully.
</pre>
</div>

<p>
创建管理员，实际上是在auth_user表中增加一个特殊用户
</p>

<div class="org-src-container">
<pre class="src src-sh">mysql&gt; select username,password from auth_user;
| admin    | pbkdf2_sha256$<span style="color: #a0522d;">1000000</span>$<span style="color: #a0522d;">Jxxxxx</span>$<span style="color: #a0522d;">xxxxxxxxxxxxxxxxxx</span>= |
</pre>
</div>
</div>
</div>
<div id="outline-container-h:dfc71521-97ed-4098-aabe-f037f101eca1" class="outline-4">
<h4 id="h:dfc71521-97ed-4098-aabe-f037f101eca1">本地化</h4>
<div class="outline-text-4" id="text-h:dfc71521-97ed-4098-aabe-f037f101eca1">
<p>
settings.py中设置语言、时区
</p>

<p>
语言名称可以查看 django\contrib\admin\locale 目录
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">LANGUAGE_CODE</span> = <span style="color: #8b2252;">'zh-Hans'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">'en-us' &#20013;&#25991;&#31616;&#20307;</span>
<span style="color: #a0522d;">USE_TZ</span> = <span style="color: #008b8b;">True</span>
<span style="color: #a0522d;">TIME_ZONE</span> = <span style="color: #8b2252;">'Asia/Shanghai'</span> <span style="color: #b22222;">#</span><span style="color: #b22222;">'UTC'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-h:db7150d6-59e3-4373-a26e-2b78f041dd0b" class="outline-4">
<h4 id="h:db7150d6-59e3-4373-a26e-2b78f041dd0b">启动WEB Server</h4>
<div class="outline-text-4" id="text-h:db7150d6-59e3-4373-a26e-2b78f041dd0b">
<div class="org-src-container">
<pre class="src src-sh">$ python manage.py runserver

Starting development server at http://127.0.0.1:8000/
</pre>
</div>

<p>
默认启动8000端口
</p>
</div>
</div>
<div id="outline-container-h:db74a786-e863-4bb8-9e2a-4c8f21944b05" class="outline-4">
<h4 id="h:db74a786-e863-4bb8-9e2a-4c8f21944b05">登录后台管理</h4>
<div class="outline-text-4" id="text-h:db74a786-e863-4bb8-9e2a-4c8f21944b05">
<p>
因为在urls.py文件中默认配置了一条，当访问根目录下的admin自动跳准的路由，所以后台登录地址<a href="http://127.0.0.1:8000/admin">http://127.0.0.1:8000/admin</a>
</p>

<p>
登录后如果希望后来能够管理这些表，就需要在admin文件中注册对应的models
</p>

<p>
举例
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #b22222;">#</span><span style="color: #b22222;">models.py</span>
<span style="color: #a020f0;">from</span> django.db <span style="color: #a020f0;">import</span> models

<span style="color: #b22222;"># </span><span style="color: #b22222;">Create your models here.</span>
<span style="color: #a020f0;">class</span> <span style="color: #228b22;">Us</span>(models.Model):
    <span style="color: #a020f0;">class</span> <span style="color: #228b22;">meta</span>:
        <span style="color: #a0522d;">db_table</span>=<span style="color: #8b2252;">"a"</span>
    <span style="color: #a020f0;">pass</span>
</pre>
</div>

<p>
在admin.py文件中注册
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">from</span> .models <span style="color: #a020f0;">import</span> Us
admin.site.register(Us)
</pre>
</div>

<p>
在后台web端查看
</p>
</div>
</div>
</div>
<div id="outline-container-h:699a2bc3-4d6d-463d-b32e-0c46f85ac718" class="outline-3">
<h3 id="h:699a2bc3-4d6d-463d-b32e-0c46f85ac718">总结</h3>
<div class="outline-text-3" id="text-h:699a2bc3-4d6d-463d-b32e-0c46f85ac718">
<p>
在开发中，一般会采用ORM框架，这样可以使用对象来操作表了。
</p>

<p>
Django中，定义表映射的类，继承自Model类。Model类使用了元编程，改变了元类。
</p>

<p>
使用Field实例作为类属性来描述字段。
</p>

<p>
使用ForeignKey来定义外键约束。
</p>

<p>
是否使用外键约束？
</p>
<ul class="org-ul">
<li>力挺派，能使数据保持完整性一致性。</li>
<li>弃用派，开发难度增加，大量数据的时候影响插入、修改、删除的效率。在业务层保证数据的一致性。</li>
</ul>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
    <div class=bar data-astro-cid-p3givckg>
        <div class=list data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:gnuemacs height=1em viewBox="0 0 24 24" width=1em>
                    <title>emacs</title>
                    <symbol id=ai:simple-icons:gnuemacs>
                        <path d="M12 24C5.448 24 .118 18.617.118 12S5.448 0 12 0s11.882 5.383 11.882 12S18.552 24 12 24zM12 .661C5.813.661.779 5.748.779 12S5.813 23.339 12 23.339S23.221 18.253 23.221 12S18.187.661 12 .661zM8.03 20.197s.978.069 2.236-.042c.51-.045 2.444-.235 3.891-.552c0 0 1.764-.377 2.707-.725c.987-.364 1.524-.673 1.766-1.11c-.011-.09.074-.408-.381-.599c-1.164-.488-2.514-.4-5.185-.457c-2.962-.102-3.948-.598-4.472-.997c-.503-.405-.25-1.526 1.907-2.513c1.086-.526 5.345-1.496 5.345-1.496c-1.434-.709-4.109-1.955-4.659-2.224c-.482-.236-1.254-.591-1.421-1.021c-.19-.413.448-.768.804-.87c1.147-.331 2.766-.536 4.24-.56c.741-.012.861-.059.861-.059c1.022-.17 1.695-.869 1.414-1.976c-.252-1.13-1.579-1.795-2.84-1.565c-1.188.217-4.05 1.048-4.05 1.048c3.539-.031 4.131.028 4.395.398c.156.218-.071.518-1.015.672c-1.027.168-3.163.37-3.163.37c-2.049.122-3.492.13-3.925 1.046c-.283.599.302 1.129.558 1.46c1.082 1.204 2.646 1.853 3.652 2.331c.379.18 1.49.52 1.49.52c-3.265-.18-5.619.823-7.001 1.977c-1.562 1.445-.871 3.168 2.33 4.228c1.891.626 2.828.921 5.648.667c1.661-.09 1.923-.036 1.939.1c.023.192-1.845.669-2.355.816c-1.298.374-4.699 1.129-4.716 1.133z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:gnuemacs></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Emacs</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:org height=1em viewBox="0 0 24 24" width=1em>
                    <title>org-mode</title>
                    <symbol id=ai:simple-icons:org>
                        <path d="M17.169 0c-.566.004-2.16 3.312-3.376 5.94a2.19 2.19 0 0 1-.408-1.267c-.03-.582-1.089.237-.936 1.275c-.068-.035-1.26.227-1.26.23c-.23-.93-.802-1.618-1.15-.563c-.701 1.663-.88 2.984.115 4.585c-.908 4.058-6.948 6.053-6.32 9.33c.175.004 1.634 3.48 6.337 2.057c5.557-1.577 8.624 2.116 8.978 2.375c.52.526-1.348-4.573-5.302-6.865c-2.339-1.276-.87-3.474-.703-4.25c0 0 1.874 1.312 3.232-.692c1.227.316 2.05-.224 3.105.158c.64.28 3.336.11 2.334-1.396c-.148.129.07.27-.075.46c-.043.056-.128.232-.408.315c-.314.149-.83.27-1.43-.37c-.434-.32-.748-.04-.992-.063c.152-.098.577-.315 1.264-.315c.388 0 .594.336.854.338c.174 0 .685-.262.787-.365c.63-.41.697-.278 1.012-.905c.17-.759-.215-.92-.332-1.129c-.032-.483-.436-.67-.919-.326c-1.106-.198-2.192-.105-2.728-.15c-1.175-.164-2.153-.786-2.153-.786c.143-.19.075-.6-.842-.628c-.315-.104-.45-.2-.745-.307c.61-1.37.674-2.007 1.418-4.004c.261-1.053 1.039-2.685.643-2.682zm-4.297 8.093c.03-.086.443.138.952.176c.395.03.805.048 1.296-.025c.03-.005.172.095-.15.194c-.02.01-.062-.01-.065.196c0 .022-.01.04-.02.046c-.15.152-.708.223-1.065.1c-.436-.17-.482-.316-.517-.443c-.305-.147-.47-.123-.43-.244zM9.685 10.2C8.86 9 8.929 8.36 8.96 7.256C7.961 8.288 6.855 8.3 5.18 8.58c-1.299.234-3.657 2.447-4.025 4.742c-.043.608-.08 2.183.424 3.498c.492 1.13.828 1.727 1.844 2.335c-.882-3.169 5.296-5.33 6.263-8.955z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:org></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Orgmode</p>
                </div>
            </span>
            <a href=/donations.html class=entry data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=simple-icons:astro height=1em viewBox="0 0 24 24" width=1em>
                    <title>Donations</title>
                    <symbol id=ai:simple-icons:astro>
                        <path d="M8.358 20.162c-1.186-1.07-1.532-3.316-1.038-4.944c.856 1.026 2.043 1.352 3.272 1.535c1.897.283 3.76.177 5.522-.678c.202-.098.388-.229.608-.36c.166.473.209.95.151 1.437c-.14 1.185-.738 2.1-1.688 2.794c-.38.277-.782.525-1.175.787c-1.205.804-1.531 1.747-1.078 3.119l.044.148a3.158 3.158 0 0 1-1.407-1.188a3.31 3.31 0 0 1-.544-1.815c-.004-.32-.004-.642-.048-.958c-.106-.769-.472-1.113-1.161-1.133c-.707-.02-1.267.411-1.415 1.09c-.012.053-.028.104-.045.165h.002zm-5.961-4.445s3.24-1.575 6.49-1.575l2.451-7.565c.092-.366.36-.614.662-.614c.302 0 .57.248.662.614l2.45 7.565c3.85 0 6.491 1.575 6.491 1.575L16.088.727C15.93.285 15.663 0 15.303 0H8.697c-.36 0-.615.285-.784.727l-5.516 14.99z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:simple-icons:astro></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>打赏</p>
                </div>
            </span>
            </a>
            <span class=entry data-astro-cid-p3givckg>
                <svg xmlns="http://www.w3.org/2000/svg" class=heading data-astro-cid-p3givckg data-icon=simple-icons:copyright width="1em" height="1em" viewBox="0 0 24 24">
                    <title>Copyright</title>
                    <path fill="currentColor" d="M19 2a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3zm-5 5h-4a1 1 0 0 0-1 1l.007.117A1 1 0 0 0 10 9h3v5a1 1 0 0 1-1.993.117L11 14a1 1 0 0 0-2 0a3 3 0 0 0 6 0V8a1 1 0 0 0-1-1" />
                    <use xlink:href=#ai:simple-icons:copyright></use>
                </svg>
                <div class="content left" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>© 2025 Jasper Hsu</p>
                </div>
            </span>
        </div>
        <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="list license" data-astro-cid-p3givckg>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Creative Commons</title>
                    <symbol id=ai:fa6-brands:creative-commons>
                        <path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Creative Commons</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-by height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Attribute</title>
                    <symbol id=ai:fa6-brands:creative-commons-by>
                        <path d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3c3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7c3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-by></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Attribute</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-nc height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Noncommercial</title>
                    <symbol id=ai:fa6-brands:creative-commons-nc>
                        <path d="M247.6 8C387.4 8 496 115.9 496 256c0 147.2-118.5 248-248.4 248C113.1 504 0 393.2 0 256C0 123.1 104.7 8 247.6 8zM55.8 189.1c-7.4 20.4-11.1 42.7-11.1 66.9c0 110.9 92.1 202.4 203.7 202.4c122.4 0 177.2-101.8 178.5-104.1l-93.4-41.6c-7.7 37.1-41.2 53-68.2 55.4v38.1h-28.8V368c-27.5-.3-52.6-10.2-75.3-29.7l34.1-34.5c31.7 29.4 86.4 31.8 86.4-2.2c0-6.2-2.2-11.2-6.6-15.1c-14.2-6-1.8-.1-219.3-97.4zM248.4 52.3c-38.4 0-112.4 8.7-170.5 93l94.8 42.5c10-31.3 40.4-42.9 63.8-44.3v-38.1h28.8v38.1c22.7 1.2 43.4 8.9 62 23L295 199.7c-42.7-29.9-83.5-8-70 11.1c53.4 24.1 43.8 19.8 93 41.6l127.1 56.7c4.1-17.4 6.2-35.1 6.2-53.1c0-57-19.8-105-59.3-143.9c-39.3-39.9-87.2-59.8-143.6-59.8z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-nc></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Noncommercial</p>
                </div>
            </span>
            <span class=entry data-astro-cid-p3givckg>
                <svg class=heading data-astro-cid-p3givckg data-icon=fa6-brands:creative-commons-sa height=1em viewBox="0 0 496 512" width=0.97em>
                    <title>Share Alike</title>
                    <symbol id=ai:fa6-brands:creative-commons-sa>
                        <path d="M247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256C0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8c103.2 0 202.8-81.1 202.8-202.8c.1-113.8-90.2-203.3-202.8-203.3zM137.7 221c13-83.9 80.5-95.7 108.9-95.7c99.8 0 127.5 82.5 127.5 134.2c0 63.6-41 132.9-128.9 132.9c-38.9 0-99.1-20-109.4-97h62.5c1.5 30.1 19.6 45.2 54.5 45.2c23.3 0 58-18.2 58-82.8c0-82.5-49.1-80.6-56.7-80.6c-33.1 0-51.7 14.6-55.8 43.8h18.2l-49.2 49.2l-49-49.2h19.4z" fill=currentColor/>
                    </symbol>
                    <use xlink:href=#ai:fa6-brands:creative-commons-sa></use>
                </svg>
                <div class="content right" data-astro-cid-p3givckg>
                    <p data-astro-cid-p3givckg>Share Alike</p>
                </div>
            </span>
        </a>
    </div>
<!--
<script type="text/javascript" src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>
<div id="back-to-top" class=""><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></div>
-->
</div>
</body>
</html>
